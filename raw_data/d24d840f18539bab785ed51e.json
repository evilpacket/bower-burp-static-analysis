{
    "url": "http://localhost:9999/jcbrand/converse.js/builds/converse-no-locales-no-otr.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statements:<ul><li>var href = location.href.replace(/(javascript:|#).*$/, '');</li><li>location.replace(href + '#' + fragment);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/jcbrand/converse.js/builds/converse-no-locales-no-otr.js",
                "path": "/jcbrand/converse.js/builds/converse-no-locales-no-otr.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9qY2JyYW5kL2NvbnZlcnNlLmpzL2J1aWxkcy9jb252ZXJzZS1uby1sb2NhbGVzLW5vLW90ci5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTA4ODExMg0KQWNjZXB0LVJhbmdlczogYnl0ZXMNCkNvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vamF2YXNjcmlwdA0KRGF0ZTogVGh1LCAwNiBOb3YgMjAxNCAxNjoyNToxNiBHTVQNCkxhc3QtTW9kaWZpZWQ6IFRodSwgMDYgTm92IDIwMTQgMTY6MjU6MTAgR01UDQoNCi8qKgogKiBAbGljZW5zZSBhbG1vbmQgMC4yLjkgQ29weXJpZ2h0IChjKSAyMDExLTIwMTQsIFRoZSBEb2pvIEZvdW5kYXRpb24gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICogQXZhaWxhYmxlIHZpYSB0aGUgTUlUIG9yIG5ldyBCU0QgbGljZW5zZS4KICogc2VlOiBodHRwOi8vZ2l0aHViLmNvbS9qcmJ1cmtlL2FsbW9uZCBmb3IgZGV0YWlscwogKi8KLy9Hb2luZyBzbG9wcHkgdG8gYXZvaWQgJ3VzZSBzdHJpY3QnIHN0cmluZyBjb3N0LCBidXQgc3RyaWN0IHByYWN0aWNlcyBzaG91bGQKLy9iZSBmb2xsb3dlZC4KLypqc2xpbnQgc2xvcHB5OiB0cnVlICovCi8qZ2xvYmFsIHNldFRpbWVvdXQ6IGZhbHNlICovCgp2YXIgcmVxdWlyZWpzLCByZXF1aXJlLCBkZWZpbmU7CihmdW5jdGlvbiAodW5kZWYpIHsKICAgIHZhciBtYWluLCByZXEsIG1ha2VNYXAsIGhhbmRsZXJzLAogICAgICAgIGRlZmluZWQgPSB7fSwKICAgICAgICB3YWl0aW5nID0ge30sCiAgICAgICAgY29uZmlnID0ge30sCiAgICAgICAgZGVmaW5pbmcgPSB7fSwKICAgICAgICBoYXNPd24gPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LAogICAgICAgIGFwcyA9IFtdLnNsaWNlLAogICAgICAgIGpzU3VmZml4UmVnRXhwID0gL1wuanMkLzsKCiAgICBmdW5jdGlvbiBoYXNQcm9wKG9iaiwgcHJvcCkgewogICAgICAgIHJldHVybiBoYXNPd24uY2FsbChvYmosIHByb3ApOwogICAgfQoKICAgIC8qKgogICAgICogR2l2ZW4gYSByZWxhdGl2ZSBtb2R1bGUgbmFtZSwgbGlrZSAuL3NvbWV0aGluZywgbm9ybWFsaXplIGl0IHRvCiAgICAgKiBhIHJlYWwgbmFtZSB0aGF0IGNhbiBiZSBtYXBwZWQgdG8gYSBwYXRoLgogICAgICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgdGhlIHJlbGF0aXZlIG5hbWUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBiYXNlTmFtZSBhIHJlYWwgbmFtZSB0aGF0IHRoZSBuYW1lIGFyZyBpcyByZWxhdGl2ZQogICAgICogdG8uCiAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBub3JtYWxpemVkIG5hbWUKICAgICAqLwogICAgZnVuY3Rpb24gbm9ybWFsaXplKG5hbWUsIGJhc2VOYW1lKSB7CiAgICAgICAgdmFyIG5hbWVQYXJ0cywgbmFtZVNlZ21lbnQsIG1hcFZhbHVlLCBmb3VuZE1hcCwgbGFzdEluZGV4LAogICAgICAgICAgICBmb3VuZEksIGZvdW5kU3Rhck1hcCwgc3RhckksIGksIGosIHBhcnQsCiAgICAgICAgICAgIGJhc2VQYXJ0cyA9IGJhc2VOYW1lICYmIGJhc2VOYW1lLnNwbGl0KCIvIiksCiAgICAgICAgICAgIG1hcCA9IGNvbmZpZy5tYXAsCiAgICAgICAgICAgIHN0YXJNYXAgPSAobWFwICYmIG1hcFsnKiddKSB8fCB7fTsKCiAgICAgICAgLy9BZGp1c3QgYW55IHJlbGF0aXZlIHBhdGhzLgogICAgICAgIGlmIChuYW1lICYmIG5hbWUuY2hhckF0KDApID09PSAiLiIpIHsKICAgICAgICAgICAgLy9JZiBoYXZlIGEgYmFzZSBuYW1lLCB0cnkgdG8gbm9ybWFsaXplIGFnYWluc3QgaXQsCiAgICAgICAgICAgIC8vb3RoZXJ3aXNlLCBhc3N1bWUgaXQgaXMgYSB0b3AtbGV2ZWwgcmVxdWlyZSB0aGF0IHdpbGwKICAgICAgICAgICAgLy9iZSByZWxhdGl2ZSB0byBiYXNlVXJsIGluIHRoZSBlbmQuCiAgICAgICAgICAgIGlmIChiYXNlTmFtZSkgewogICAgICAgICAgICAgICAgLy9Db252ZXJ0IGJhc2VOYW1lIHRvIGFycmF5LCBhbmQgbG9wIG9mZiB0aGUgbGFzdCBwYXJ0LAogICAgICAgICAgICAgICAgLy9zbyB0aGF0IC4gbWF0Y2hlcyB0aGF0ICJkaXJlY3RvcnkiIGFuZCBub3QgbmFtZSBvZiB0aGUgYmFzZU5hbWUncwogICAgICAgICAgICAgICAgLy9tb2R1bGUuIEZvciBpbnN0YW5jZSwgYmFzZU5hbWUgb2YgIm9uZS90d28vdGhyZWUiLCBtYXBzIHRvCiAgICAgICAgICAgICAgICAvLyJvbmUvdHdvL3RocmVlLmpzIiwgYnV0IHdlIHdhbnQgdGhlIGRpcmVjdG9yeSwgIm9uZS90d28iIGZvcgogICAgICAgICAgICAgICAgLy90aGlzIG5vcm1hbGl6YXRpb24uCiAgICAgICAgICAgICAgICBiYXNlUGFydHMgPSBiYXNlUGFydHMuc2xpY2UoMCwgYmFzZVBhcnRzLmxlbmd0aCAtIDEpOwogICAgICAgICAgICAgICAgbmFtZSA9IG5hbWUuc3BsaXQoJy8nKTsKICAgICAgICAgICAgICAgIGxhc3RJbmRleCA9IG5hbWUubGVuZ3RoIC0gMTsKCiAgICAgICAgICAgICAgICAvLyBOb2RlIC5qcyBhbGxvd2FuY2U6CiAgICAgICAgICAgICAgICBpZiAoY29uZmlnLm5vZGVJZENvbXBhdCAmJiBqc1N1ZmZpeFJlZ0V4cC50ZXN0KG5hbWVbbGFzdEluZGV4XSkpIHsKICAgICAgICAgICAgICAgICAgICBuYW1lW2xhc3RJbmRleF0gPSBuYW1lW2xhc3RJbmRleF0ucmVwbGFjZShqc1N1ZmZpeFJlZ0V4cCwgJycpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG5hbWUgPSBiYXNlUGFydHMuY29uY2F0KG5hbWUpOwoKICAgICAgICAgICAgICAgIC8vc3RhcnQgdHJpbURvdHMKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBuYW1lLmxlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgICAgICAgICAgICAgcGFydCA9IG5hbWVbaV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnQgPT09ICIuIikgewogICAgICAgICAgICAgICAgICAgICAgICBuYW1lLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgaSAtPSAxOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocGFydCA9PT0gIi4uIikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaSA9PT0gMSAmJiAobmFtZVsyXSA9PT0gJy4uJyB8fCBuYW1lWzBdID09PSAnLi4nKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9FbmQgb2YgdGhlIGxpbmUuIEtlZXAgYXQgbGVhc3Qgb25lIG5vbi1kb3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vcGF0aCBzZWdtZW50IGF0IHRoZSBmcm9udCBzbyBpdCBjYW4gYmUgbWFwcGVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL2NvcnJlY3RseSB0byBkaXNrLiBPdGhlcndpc2UsIHRoZXJlIGlzIGxpa2VseQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9ubyBwYXRoIG1hcHBpbmcgZm9yIGEgcGF0aCBzdGFydGluZyB3aXRoICcuLicuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL1RoaXMgY2FuIHN0aWxsIGZhaWwsIGJ1dCBjYXRjaGVzIHRoZSBtb3N0IHJlYXNvbmFibGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vdXNlcyBvZiAuLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUuc3BsaWNlKGkgLSAxLCAyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkgLT0gMjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vZW5kIHRyaW1Eb3RzCgogICAgICAgICAgICAgICAgbmFtZSA9IG5hbWUuam9pbigiLyIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5hbWUuaW5kZXhPZignLi8nKSA9PT0gMCkgewogICAgICAgICAgICAgICAgLy8gTm8gYmFzZU5hbWUsIHNvIHRoaXMgaXMgSUQgaXMgcmVzb2x2ZWQgcmVsYXRpdmUKICAgICAgICAgICAgICAgIC8vIHRvIGJhc2VVcmwsIHB1bGwgb2ZmIHRoZSBsZWFkaW5nIGRvdC4KICAgICAgICAgICAgICAgIG5hbWUgPSBuYW1lLnN1YnN0cmluZygyKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy9BcHBseSBtYXAgY29uZmlnIGlmIGF2YWlsYWJsZS4KICAgICAgICBpZiAoKGJhc2VQYXJ0cyB8fCBzdGFyTWFwKSAmJiBtYXApIHsKICAgICAgICAgICAgbmFtZVBhcnRzID0gbmFtZS5zcGxpdCgnLycpOwoKICAgICAgICAgICAgZm9yIChpID0gbmFtZVBhcnRzLmxlbmd0aDsgaSA+IDA7IGkgLT0gMSkgewogICAgICAgICAgICAgICAgbmFtZVNlZ21lbnQgPSBuYW1lUGFydHMuc2xpY2UoMCwgaSkuam9pbigiLyIpOwoKICAgICAgICAgICAgICAgIGlmIChiYXNlUGFydHMpIHsKICAgICAgICAgICAgICAgICAgICAvL0ZpbmQgdGhlIGxvbmdlc3QgYmFzZU5hbWUgc2VnbWVudCBtYXRjaCBpbiB0aGUgY29uZmlnLgogICAgICAgICAgICAgICAgICAgIC8vU28sIGRvIGpvaW5zIG9uIHRoZSBiaWdnZXN0IHRvIHNtYWxsZXN0IGxlbmd0aHMgb2YgYmFzZVBhcnRzLgogICAgICAgICAgICAgICAgICAgIGZvciAoaiA9IGJhc2VQYXJ0cy5sZW5ndGg7IGogPiAwOyBqIC09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWFwVmFsdWUgPSBtYXBbYmFzZVBhcnRzLnNsaWNlKDAsIGopLmpvaW4oJy8nKV07CgogICAgICAgICAgICAgICAgICAgICAgICAvL2Jhc2VOYW1lIHNlZ21lbnQgaGFzICBjb25maWcsIGZpbmQgaWYgaXQgaGFzIG9uZSBmb3IKICAgICAgICAgICAgICAgICAgICAgICAgLy90aGlzIG5hbWUuCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXBWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwVmFsdWUgPSBtYXBWYWx1ZVtuYW1lU2VnbWVudF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWFwVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL01hdGNoLCB1cGRhdGUgbmFtZSB0byB0aGUgbmV3IHZhbHVlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kTWFwID0gbWFwVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm91bmRJID0gaTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoZm91bmRNYXApIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvL0NoZWNrIGZvciBhIHN0YXIgbWFwIG1hdGNoLCBidXQganVzdCBob2xkIG9uIHRvIGl0LAogICAgICAgICAgICAgICAgLy9pZiB0aGVyZSBpcyBhIHNob3J0ZXIgc2VnbWVudCBtYXRjaCBsYXRlciBpbiBhIG1hdGNoaW5nCiAgICAgICAgICAgICAgICAvL2NvbmZpZywgdGhlbiBmYXZvciBvdmVyIHRoaXMgc3RhciBtYXAuCiAgICAgICAgICAgICAgICBpZiAoIWZvdW5kU3Rhck1hcCAmJiBzdGFyTWFwICYmIHN0YXJNYXBbbmFtZVNlZ21lbnRdKSB7CiAgICAgICAgICAgICAgICAgICAgZm91bmRTdGFyTWFwID0gc3Rhck1hcFtuYW1lU2VnbWVudF07CiAgICAgICAgICAgICAgICAgICAgc3RhckkgPSBpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWZvdW5kTWFwICYmIGZvdW5kU3Rhck1hcCkgewogICAgICAgICAgICAgICAgZm91bmRNYXAgPSBmb3VuZFN0YXJNYXA7CiAgICAgICAgICAgICAgICBmb3VuZEkgPSBzdGFySTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGZvdW5kTWFwKSB7CiAgICAgICAgICAgICAgICBuYW1lUGFydHMuc3BsaWNlKDAsIGZvdW5kSSwgZm91bmRNYXApOwogICAgICAgICAgICAgICAgbmFtZSA9IG5hbWVQYXJ0cy5qb2luKCcvJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBuYW1lOwogICAgfQoKICAgIGZ1bmN0aW9uIG1ha2VSZXF1aXJlKHJlbE5hbWUsIGZvcmNlU3luYykgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIC8vQSB2ZXJzaW9uIG9mIGEgcmVxdWlyZSBmdW5jdGlvbiB0aGF0IHBhc3NlcyBhIG1vZHVsZU5hbWUKICAgICAgICAgICAgLy92YWx1ZSBmb3IgaXRlbXMgdGhhdCBtYXkgbmVlZCB0bwogICAgICAgICAgICAvL2xvb2sgdXAgcGF0aHMgcmVsYXRpdmUgdG8gdGhlIG1vZHVsZU5hbWUKICAgICAgICAgICAgcmV0dXJuIHJlcS5hcHBseSh1bmRlZiwgYXBzLmNhbGwoYXJndW1lbnRzLCAwKS5jb25jYXQoW3JlbE5hbWUsIGZvcmNlU3luY10pKTsKICAgICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIG1ha2VOb3JtYWxpemUocmVsTmFtZSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICByZXR1cm4gbm9ybWFsaXplKG5hbWUsIHJlbE5hbWUpOwogICAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gbWFrZUxvYWQoZGVwTmFtZSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgZGVmaW5lZFtkZXBOYW1lXSA9IHZhbHVlOwogICAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gY2FsbERlcChuYW1lKSB7CiAgICAgICAgaWYgKGhhc1Byb3Aod2FpdGluZywgbmFtZSkpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSB3YWl0aW5nW25hbWVdOwogICAgICAgICAgICBkZWxldGUgd2FpdGluZ1tuYW1lXTsKICAgICAgICAgICAgZGVmaW5pbmdbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICBtYWluLmFwcGx5KHVuZGVmLCBhcmdzKTsKICAgICAgICB9CgogICAgICAgIGlmICghaGFzUHJvcChkZWZpbmVkLCBuYW1lKSAmJiAhaGFzUHJvcChkZWZpbmluZywgbmFtZSkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyAnICsgbmFtZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBkZWZpbmVkW25hbWVdOwogICAgfQoKICAgIC8vVHVybnMgYSBwbHVnaW4hcmVzb3VyY2UgdG8gW3BsdWdpbiwgcmVzb3VyY2VdCiAgICAvL3dpdGggdGhlIHBsdWdpbiBiZWluZyB1bmRlZmluZWQgaWYgdGhlIG5hbWUKICAgIC8vZGlkIG5vdCBoYXZlIGEgcGx1Z2luIHByZWZpeC4KICAgIGZ1bmN0aW9uIHNwbGl0UHJlZml4KG5hbWUpIHsKICAgICAgICB2YXIgcHJlZml4LAogICAgICAgICAgICBpbmRleCA9IG5hbWUgPyBuYW1lLmluZGV4T2YoJyEnKSA6IC0xOwogICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICAgIHByZWZpeCA9IG5hbWUuc3Vic3RyaW5nKDAsIGluZGV4KTsKICAgICAgICAgICAgbmFtZSA9IG5hbWUuc3Vic3RyaW5nKGluZGV4ICsgMSwgbmFtZS5sZW5ndGgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gW3ByZWZpeCwgbmFtZV07CiAgICB9CgogICAgLyoqCiAgICAgKiBNYWtlcyBhIG5hbWUgbWFwLCBub3JtYWxpemluZyB0aGUgbmFtZSwgYW5kIHVzaW5nIGEgcGx1Z2luCiAgICAgKiBmb3Igbm9ybWFsaXphdGlvbiBpZiBuZWNlc3NhcnkuIEdyYWJzIGEgcmVmIHRvIHBsdWdpbgogICAgICogdG9vLCBhcyBhbiBvcHRpbWl6YXRpb24uCiAgICAgKi8KICAgIG1ha2VNYXAgPSBmdW5jdGlvbiAobmFtZSwgcmVsTmFtZSkgewogICAgICAgIHZhciBwbHVnaW4sCiAgICAgICAgICAgIHBhcnRzID0gc3BsaXRQcmVmaXgobmFtZSksCiAgICAgICAgICAgIHByZWZpeCA9IHBhcnRzWzBdOwoKICAgICAgICBuYW1lID0gcGFydHNbMV07CgogICAgICAgIGlmIChwcmVmaXgpIHsKICAgICAgICAgICAgcHJlZml4ID0gbm9ybWFsaXplKHByZWZpeCwgcmVsTmFtZSk7CiAgICAgICAgICAgIHBsdWdpbiA9IGNhbGxEZXAocHJlZml4KTsKICAgICAgICB9CgogICAgICAgIC8vTm9ybWFsaXplIGFjY29yZGluZwogICAgICAgIGlmIChwcmVmaXgpIHsKICAgICAgICAgICAgaWYgKHBsdWdpbiAmJiBwbHVnaW4ubm9ybWFsaXplKSB7CiAgICAgICAgICAgICAgICBuYW1lID0gcGx1Z2luLm5vcm1hbGl6ZShuYW1lLCBtYWtlTm9ybWFsaXplKHJlbE5hbWUpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5hbWUgPSBub3JtYWxpemUobmFtZSwgcmVsTmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuYW1lID0gbm9ybWFsaXplKG5hbWUsIHJlbE5hbWUpOwogICAgICAgICAgICBwYXJ0cyA9IHNwbGl0UHJlZml4KG5hbWUpOwogICAgICAgICAgICBwcmVmaXggPSBwYXJ0c1swXTsKICAgICAgICAgICAgbmFtZSA9IHBhcnRzWzFdOwogICAgICAgICAgICBpZiAocHJlZml4KSB7CiAgICAgICAgICAgICAgICBwbHVnaW4gPSBjYWxsRGVwKHByZWZpeCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vVXNpbmcgcmlkaWN1bG91cyBwcm9wZXJ0eSBuYW1lcyBmb3Igc3BhY2UgcmVhc29ucwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGY6IHByZWZpeCA/IHByZWZpeCArICchJyArIG5hbWUgOiBuYW1lLCAvL2Z1bGxOYW1lCiAgICAgICAgICAgIG46IG5hbWUsCiAgICAgICAgICAgIHByOiBwcmVmaXgsCiAgICAgICAgICAgIHA6IHBsdWdpbgogICAgICAgIH07CiAgICB9OwoKICAgIGZ1bmN0aW9uIG1ha2VDb25maWcobmFtZSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiAoY29uZmlnICYmIGNvbmZpZy5jb25maWcgJiYgY29uZmlnLmNvbmZpZ1tuYW1lXSkgfHwge307CiAgICAgICAgfTsKICAgIH0KCiAgICBoYW5kbGVycyA9IHsKICAgICAgICByZXF1aXJlOiBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICByZXR1cm4gbWFrZVJlcXVpcmUobmFtZSk7CiAgICAgICAgfSwKICAgICAgICBleHBvcnRzOiBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgZSA9IGRlZmluZWRbbmFtZV07CiAgICAgICAgICAgIGlmICh0eXBlb2YgZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIChkZWZpbmVkW25hbWVdID0ge30pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBtb2R1bGU6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBpZDogbmFtZSwKICAgICAgICAgICAgICAgIHVyaTogJycsCiAgICAgICAgICAgICAgICBleHBvcnRzOiBkZWZpbmVkW25hbWVdLAogICAgICAgICAgICAgICAgY29uZmlnOiBtYWtlQ29uZmlnKG5hbWUpCiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfTsKCiAgICBtYWluID0gZnVuY3Rpb24gKG5hbWUsIGRlcHMsIGNhbGxiYWNrLCByZWxOYW1lKSB7CiAgICAgICAgdmFyIGNqc01vZHVsZSwgZGVwTmFtZSwgcmV0LCBtYXAsIGksCiAgICAgICAgICAgIGFyZ3MgPSBbXSwKICAgICAgICAgICAgY2FsbGJhY2tUeXBlID0gdHlwZW9mIGNhbGxiYWNrLAogICAgICAgICAgICB1c2luZ0V4cG9ydHM7CgogICAgICAgIC8vVXNlIG5hbWUgaWYgbm8gcmVsTmFtZQogICAgICAgIHJlbE5hbWUgPSByZWxOYW1lIHx8IG5hbWU7CgogICAgICAgIC8vQ2FsbCB0aGUgY2FsbGJhY2sgdG8gZGVmaW5lIHRoZSBtb2R1bGUsIGlmIG5lY2Vzc2FyeS4KICAgICAgICBpZiAoY2FsbGJhY2tUeXBlID09PSAndW5kZWZpbmVkJyB8fCBjYWxsYmFja1R5cGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgLy9QdWxsIG91dCB0aGUgZGVmaW5lZCBkZXBlbmRlbmNpZXMgYW5kIHBhc3MgdGhlIG9yZGVyZWQKICAgICAgICAgICAgLy92YWx1ZXMgdG8gdGhlIGNhbGxiYWNrLgogICAgICAgICAgICAvL0RlZmF1bHQgdG8gW3JlcXVpcmUsIGV4cG9ydHMsIG1vZHVsZV0gaWYgbm8gZGVwcwogICAgICAgICAgICBkZXBzID0gIWRlcHMubGVuZ3RoICYmIGNhbGxiYWNrLmxlbmd0aCA/IFsncmVxdWlyZScsICdleHBvcnRzJywgJ21vZHVsZSddIDogZGVwczsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGRlcHMubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgICAgICAgIG1hcCA9IG1ha2VNYXAoZGVwc1tpXSwgcmVsTmFtZSk7CiAgICAgICAgICAgICAgICBkZXBOYW1lID0gbWFwLmY7CgogICAgICAgICAgICAgICAgLy9GYXN0IHBhdGggQ29tbW9uSlMgc3RhbmRhcmQgZGVwZW5kZW5jaWVzLgogICAgICAgICAgICAgICAgaWYgKGRlcE5hbWUgPT09ICJyZXF1aXJlIikgewogICAgICAgICAgICAgICAgICAgIGFyZ3NbaV0gPSBoYW5kbGVycy5yZXF1aXJlKG5hbWUpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChkZXBOYW1lID09PSAiZXhwb3J0cyIpIHsKICAgICAgICAgICAgICAgICAgICAvL0NvbW1vbkpTIG1vZHVsZSBzcGVjIDEuMQogICAgICAgICAgICAgICAgICAgIGFyZ3NbaV0gPSBoYW5kbGVycy5leHBvcnRzKG5hbWUpOwogICAgICAgICAgICAgICAgICAgIHVzaW5nRXhwb3J0cyA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRlcE5hbWUgPT09ICJtb2R1bGUiKSB7CiAgICAgICAgICAgICAgICAgICAgLy9Db21tb25KUyBtb2R1bGUgc3BlYyAxLjEKICAgICAgICAgICAgICAgICAgICBjanNNb2R1bGUgPSBhcmdzW2ldID0gaGFuZGxlcnMubW9kdWxlKG5hbWUpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXNQcm9wKGRlZmluZWQsIGRlcE5hbWUpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc1Byb3Aod2FpdGluZywgZGVwTmFtZSkgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzUHJvcChkZWZpbmluZywgZGVwTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBhcmdzW2ldID0gY2FsbERlcChkZXBOYW1lKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobWFwLnApIHsKICAgICAgICAgICAgICAgICAgICBtYXAucC5sb2FkKG1hcC5uLCBtYWtlUmVxdWlyZShyZWxOYW1lLCB0cnVlKSwgbWFrZUxvYWQoZGVwTmFtZSksIHt9KTsKICAgICAgICAgICAgICAgICAgICBhcmdzW2ldID0gZGVmaW5lZFtkZXBOYW1lXTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKG5hbWUgKyAnIG1pc3NpbmcgJyArIGRlcE5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXQgPSBjYWxsYmFjayA/IGNhbGxiYWNrLmFwcGx5KGRlZmluZWRbbmFtZV0sIGFyZ3MpIDogdW5kZWZpbmVkOwoKICAgICAgICAgICAgaWYgKG5hbWUpIHsKICAgICAgICAgICAgICAgIC8vSWYgc2V0dGluZyBleHBvcnRzIHZpYSAibW9kdWxlIiBpcyBpbiBwbGF5LAogICAgICAgICAgICAgICAgLy9mYXZvciB0aGF0IG92ZXIgcmV0dXJuIHZhbHVlIGFuZCBleHBvcnRzLiBBZnRlciB0aGF0LAogICAgICAgICAgICAgICAgLy9mYXZvciBhIG5vbi11bmRlZmluZWQgcmV0dXJuIHZhbHVlIG92ZXIgZXhwb3J0cyB1c2UuCiAgICAgICAgICAgICAgICBpZiAoY2pzTW9kdWxlICYmIGNqc01vZHVsZS5leHBvcnRzICE9PSB1bmRlZiAmJgogICAgICAgICAgICAgICAgICAgICAgICBjanNNb2R1bGUuZXhwb3J0cyAhPT0gZGVmaW5lZFtuYW1lXSkgewogICAgICAgICAgICAgICAgICAgIGRlZmluZWRbbmFtZV0gPSBjanNNb2R1bGUuZXhwb3J0czsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmV0ICE9PSB1bmRlZiB8fCAhdXNpbmdFeHBvcnRzKSB7CiAgICAgICAgICAgICAgICAgICAgLy9Vc2UgdGhlIHJldHVybiB2YWx1ZSBmcm9tIHRoZSBmdW5jdGlvbi4KICAgICAgICAgICAgICAgICAgICBkZWZpbmVkW25hbWVdID0gcmV0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChuYW1lKSB7CiAgICAgICAgICAgIC8vTWF5IGp1c3QgYmUgYW4gb2JqZWN0IGRlZmluaXRpb24gZm9yIHRoZSBtb2R1bGUuIE9ubHkKICAgICAgICAgICAgLy93b3JyeSBhYm91dCBkZWZpbmluZyBpZiBoYXZlIGEgbW9kdWxlIG5hbWUuCiAgICAgICAgICAgIGRlZmluZWRbbmFtZV0gPSBjYWxsYmFjazsKICAgICAgICB9CiAgICB9OwoKICAgIHJlcXVpcmVqcyA9IHJlcXVpcmUgPSByZXEgPSBmdW5jdGlvbiAoZGVwcywgY2FsbGJhY2ssIHJlbE5hbWUsIGZvcmNlU3luYywgYWx0KSB7CiAgICAgICAgaWYgKHR5cGVvZiBkZXBzID09PSAic3RyaW5nIikgewogICAgICAgICAgICBpZiAoaGFuZGxlcnNbZGVwc10pIHsKICAgICAgICAgICAgICAgIC8vY2FsbGJhY2sgaW4gdGhpcyBjYXNlIGlzIHJlYWxseSByZWxOYW1lCiAgICAgICAgICAgICAgICByZXR1cm4gaGFuZGxlcnNbZGVwc10oY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vSnVzdCByZXR1cm4gdGhlIG1vZHVsZSB3YW50ZWQuIEluIHRoaXMgc2NlbmFyaW8sIHRoZQogICAgICAgICAgICAvL2RlcHMgYXJnIGlzIHRoZSBtb2R1bGUgbmFtZSwgYW5kIHNlY29uZCBhcmcgKGlmIHBhc3NlZCkKICAgICAgICAgICAgLy9pcyBqdXN0IHRoZSByZWxOYW1lLgogICAgICAgICAgICAvL05vcm1hbGl6ZSBtb2R1bGUgbmFtZSwgaWYgaXQgY29udGFpbnMgLiBvciAuLgogICAgICAgICAgICByZXR1cm4gY2FsbERlcChtYWtlTWFwKGRlcHMsIGNhbGxiYWNrKS5mKTsKICAgICAgICB9IGVsc2UgaWYgKCFkZXBzLnNwbGljZSkgewogICAgICAgICAgICAvL2RlcHMgaXMgYSBjb25maWcgb2JqZWN0LCBub3QgYW4gYXJyYXkuCiAgICAgICAgICAgIGNvbmZpZyA9IGRlcHM7CiAgICAgICAgICAgIGlmIChjb25maWcuZGVwcykgewogICAgICAgICAgICAgICAgcmVxKGNvbmZpZy5kZXBzLCBjb25maWcuY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNhbGxiYWNrLnNwbGljZSkgewogICAgICAgICAgICAgICAgLy9jYWxsYmFjayBpcyBhbiBhcnJheSwgd2hpY2ggbWVhbnMgaXQgaXMgYSBkZXBlbmRlbmN5IGxpc3QuCiAgICAgICAgICAgICAgICAvL0FkanVzdCBhcmdzIGlmIHRoZXJlIGFyZSBkZXBlbmRlbmNpZXMKICAgICAgICAgICAgICAgIGRlcHMgPSBjYWxsYmFjazsKICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gcmVsTmFtZTsKICAgICAgICAgICAgICAgIHJlbE5hbWUgPSBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVwcyA9IHVuZGVmOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvL1N1cHBvcnQgcmVxdWlyZShbJ2EnXSkKICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrIHx8IGZ1bmN0aW9uICgpIHt9OwoKICAgICAgICAvL0lmIHJlbE5hbWUgaXMgYSBmdW5jdGlvbiwgaXQgaXMgYW4gZXJyYmFjayBoYW5kbGVyLAogICAgICAgIC8vc28gcmVtb3ZlIGl0LgogICAgICAgIGlmICh0eXBlb2YgcmVsTmFtZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICByZWxOYW1lID0gZm9yY2VTeW5jOwogICAgICAgICAgICBmb3JjZVN5bmMgPSBhbHQ7CiAgICAgICAgfQoKICAgICAgICAvL1NpbXVsYXRlIGFzeW5jIGNhbGxiYWNrOwogICAgICAgIGlmIChmb3JjZVN5bmMpIHsKICAgICAgICAgICAgbWFpbih1bmRlZiwgZGVwcywgY2FsbGJhY2ssIHJlbE5hbWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vVXNpbmcgYSBub24temVybyB2YWx1ZSBiZWNhdXNlIG9mIGNvbmNlcm4gZm9yIHdoYXQgb2xkIGJyb3dzZXJzCiAgICAgICAgICAgIC8vZG8sIGFuZCBsYXRlc3QgYnJvd3NlcnMgInVwZ3JhZGUiIHRvIDQgaWYgbG93ZXIgdmFsdWUgaXMgdXNlZDoKICAgICAgICAgICAgLy9odHRwOi8vd3d3LndoYXR3Zy5vcmcvc3BlY3Mvd2ViLWFwcHMvY3VycmVudC13b3JrL211bHRpcGFnZS90aW1lcnMuaHRtbCNkb20td2luZG93dGltZXJzLXNldHRpbWVvdXQ6CiAgICAgICAgICAgIC8vSWYgd2FudCBhIHZhbHVlIGltbWVkaWF0ZWx5LCB1c2UgcmVxdWlyZSgnaWQnKSBpbnN0ZWFkIC0tIHNvbWV0aGluZwogICAgICAgICAgICAvL3RoYXQgd29ya3MgaW4gYWxtb25kIG9uIHRoZSBnbG9iYWwgbGV2ZWwsIGJ1dCBub3QgZ3VhcmFudGVlZCBhbmQKICAgICAgICAgICAgLy91bmxpa2VseSB0byB3b3JrIGluIG90aGVyIEFNRCBpbXBsZW1lbnRhdGlvbnMuCiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgbWFpbih1bmRlZiwgZGVwcywgY2FsbGJhY2ssIHJlbE5hbWUpOwogICAgICAgICAgICB9LCA0KTsKICAgICAgICB9CgogICAgICAgIHJldHVybiByZXE7CiAgICB9OwoKICAgIC8qKgogICAgICogSnVzdCBkcm9wcyB0aGUgY29uZmlnIG9uIHRoZSBmbG9vciwgYnV0IHJldHVybnMgcmVxIGluIGNhc2UKICAgICAqIHRoZSBjb25maWcgcmV0dXJuIHZhbHVlIGlzIHVzZWQuCiAgICAgKi8KICAgIHJlcS5jb25maWcgPSBmdW5jdGlvbiAoY2ZnKSB7CiAgICAgICAgcmV0dXJuIHJlcShjZmcpOwogICAgfTsKCiAgICAvKioKICAgICAqIEV4cG9zZSBtb2R1bGUgcmVnaXN0cnkgZm9yIGRlYnVnZ2luZyBhbmQgdG9vbGluZwogICAgICovCiAgICByZXF1aXJlanMuX2RlZmluZWQgPSBkZWZpbmVkOwoKICAgIGRlZmluZSA9IGZ1bmN0aW9uIChuYW1lLCBkZXBzLCBjYWxsYmFjaykgewoKICAgICAgICAvL1RoaXMgbW9kdWxlIG1heSBub3QgaGF2ZSBkZXBlbmRlbmNpZXMKICAgICAgICBpZiAoIWRlcHMuc3BsaWNlKSB7CiAgICAgICAgICAgIC8vZGVwcyBpcyBub3QgYW4gYXJyYXksIHNvIHByb2JhYmx5IG1lYW5zCiAgICAgICAgICAgIC8vYW4gb2JqZWN0IGxpdGVyYWwgb3IgZmFjdG9yeSBmdW5jdGlvbiBmb3IKICAgICAgICAgICAgLy90aGUgdmFsdWUuIEFkanVzdCBhcmdzLgogICAgICAgICAgICBjYWxsYmFjayA9IGRlcHM7CiAgICAgICAgICAgIGRlcHMgPSBbXTsKICAgICAgICB9CgogICAgICAgIGlmICghaGFzUHJvcChkZWZpbmVkLCBuYW1lKSAmJiAhaGFzUHJvcCh3YWl0aW5nLCBuYW1lKSkgewogICAgICAgICAgICB3YWl0aW5nW25hbWVdID0gW25hbWUsIGRlcHMsIGNhbGxiYWNrXTsKICAgICAgICB9CiAgICB9OwoKICAgIGRlZmluZS5hbWQgPSB7CiAgICAgICAgalF1ZXJ5OiB0cnVlCiAgICB9Owp9KCkpOwoKZGVmaW5lKCJjb21wb25lbnRzL2FsbW9uZC9hbG1vbmQuanMiLCBmdW5jdGlvbigpe30pOwoKLyohCiAqIGpRdWVyeSBKYXZhU2NyaXB0IExpYnJhcnkgdjEuMTEuMAogKiBodHRwOi8vanF1ZXJ5LmNvbS8KICoKICogSW5jbHVkZXMgU2l6emxlLmpzCiAqIGh0dHA6Ly9zaXp6bGVqcy5jb20vCiAqCiAqIENvcHlyaWdodCAyMDA1LCAyMDE0IGpRdWVyeSBGb3VuZGF0aW9uLCBJbmMuIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogRGF0ZTogMjAxNC0wMS0yM1QyMTowMloKICovCgooZnVuY3Rpb24oIGdsb2JhbCwgZmFjdG9yeSApIHsKCglpZiAoIHR5cGVvZiBtb2R1bGUgPT09ICJvYmplY3QiICYmIHR5cGVvZiBtb2R1bGUuZXhwb3J0cyA9PT0gIm9iamVjdCIgKSB7CgkJLy8gRm9yIENvbW1vbkpTIGFuZCBDb21tb25KUy1saWtlIGVudmlyb25tZW50cyB3aGVyZSBhIHByb3BlciB3aW5kb3cgaXMgcHJlc2VudCwKCQkvLyBleGVjdXRlIHRoZSBmYWN0b3J5IGFuZCBnZXQgalF1ZXJ5CgkJLy8gRm9yIGVudmlyb25tZW50cyB0aGF0IGRvIG5vdCBpbmhlcmVudGx5IHBvc3NlcyBhIHdpbmRvdyB3aXRoIGEgZG9jdW1lbnQKCQkvLyAoc3VjaCBhcyBOb2RlLmpzKSwgZXhwb3NlIGEgalF1ZXJ5LW1ha2luZyBmYWN0b3J5IGFzIG1vZHVsZS5leHBvcnRzCgkJLy8gVGhpcyBhY2NlbnR1YXRlcyB0aGUgbmVlZCBmb3IgdGhlIGNyZWF0aW9uIG9mIGEgcmVhbCB3aW5kb3cKCQkvLyBlLmcuIHZhciBqUXVlcnkgPSByZXF1aXJlKCJqcXVlcnkiKSh3aW5kb3cpOwoJCS8vIFNlZSB0aWNrZXQgIzE0NTQ5IGZvciBtb3JlIGluZm8KCQltb2R1bGUuZXhwb3J0cyA9IGdsb2JhbC5kb2N1bWVudCA/CgkJCWZhY3RvcnkoIGdsb2JhbCwgdHJ1ZSApIDoKCQkJZnVuY3Rpb24oIHcgKSB7CgkJCQlpZiAoICF3LmRvY3VtZW50ICkgewoJCQkJCXRocm93IG5ldyBFcnJvciggImpRdWVyeSByZXF1aXJlcyBhIHdpbmRvdyB3aXRoIGEgZG9jdW1lbnQiICk7CgkJCQl9CgkJCQlyZXR1cm4gZmFjdG9yeSggdyApOwoJCQl9OwoJfSBlbHNlIHsKCQlmYWN0b3J5KCBnbG9iYWwgKTsKCX0KCi8vIFBhc3MgdGhpcyBpZiB3aW5kb3cgaXMgbm90IGRlZmluZWQgeWV0Cn0odHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB0aGlzLCBmdW5jdGlvbiggd2luZG93LCBub0dsb2JhbCApIHsKCi8vIENhbid0IGRvIHRoaXMgYmVjYXVzZSBzZXZlcmFsIGFwcHMgaW5jbHVkaW5nIEFTUC5ORVQgdHJhY2UKLy8gdGhlIHN0YWNrIHZpYSBhcmd1bWVudHMuY2FsbGVyLmNhbGxlZSBhbmQgRmlyZWZveCBkaWVzIGlmCi8vIHlvdSB0cnkgdG8gdHJhY2UgdGhyb3VnaCAidXNlIHN0cmljdCIgY2FsbCBjaGFpbnMuICgjMTMzMzUpCi8vIFN1cHBvcnQ6IEZpcmVmb3ggMTgrCi8vCgp2YXIgZGVsZXRlZElkcyA9IFtdOwoKdmFyIHNsaWNlID0gZGVsZXRlZElkcy5zbGljZTsKCnZhciBjb25jYXQgPSBkZWxldGVkSWRzLmNvbmNhdDsKCnZhciBwdXNoID0gZGVsZXRlZElkcy5wdXNoOwoKdmFyIGluZGV4T2YgPSBkZWxldGVkSWRzLmluZGV4T2Y7Cgp2YXIgY2xhc3MydHlwZSA9IHt9OwoKdmFyIHRvU3RyaW5nID0gY2xhc3MydHlwZS50b1N0cmluZzsKCnZhciBoYXNPd24gPSBjbGFzczJ0eXBlLmhhc093blByb3BlcnR5OwoKdmFyIHRyaW0gPSAiIi50cmltOwoKdmFyIHN1cHBvcnQgPSB7fTsKCgoKdmFyCgl2ZXJzaW9uID0gIjEuMTEuMCIsCgoJLy8gRGVmaW5lIGEgbG9jYWwgY29weSBvZiBqUXVlcnkKCWpRdWVyeSA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCApIHsKCQkvLyBUaGUgalF1ZXJ5IG9iamVjdCBpcyBhY3R1YWxseSBqdXN0IHRoZSBpbml0IGNvbnN0cnVjdG9yICdlbmhhbmNlZCcKCQkvLyBOZWVkIGluaXQgaWYgalF1ZXJ5IGlzIGNhbGxlZCAoanVzdCBhbGxvdyBlcnJvciB0byBiZSB0aHJvd24gaWYgbm90IGluY2x1ZGVkKQoJCXJldHVybiBuZXcgalF1ZXJ5LmZuLmluaXQoIHNlbGVjdG9yLCBjb250ZXh0ICk7Cgl9LAoKCS8vIE1ha2Ugc3VyZSB3ZSB0cmltIEJPTSBhbmQgTkJTUCAoaGVyZSdzIGxvb2tpbmcgYXQgeW91LCBTYWZhcmkgNS4wIGFuZCBJRSkKCXJ0cmltID0gL15bXHNcdUZFRkZceEEwXSt8W1xzXHVGRUZGXHhBMF0rJC9nLAoKCS8vIE1hdGNoZXMgZGFzaGVkIHN0cmluZyBmb3IgY2FtZWxpemluZwoJcm1zUHJlZml4ID0gL14tbXMtLywKCXJkYXNoQWxwaGEgPSAvLShbXGRhLXpdKS9naSwKCgkvLyBVc2VkIGJ5IGpRdWVyeS5jYW1lbENhc2UgYXMgY2FsbGJhY2sgdG8gcmVwbGFjZSgpCglmY2FtZWxDYXNlID0gZnVuY3Rpb24oIGFsbCwgbGV0dGVyICkgewoJCXJldHVybiBsZXR0ZXIudG9VcHBlckNhc2UoKTsKCX07CgpqUXVlcnkuZm4gPSBqUXVlcnkucHJvdG90eXBlID0gewoJLy8gVGhlIGN1cnJlbnQgdmVyc2lvbiBvZiBqUXVlcnkgYmVpbmcgdXNlZAoJanF1ZXJ5OiB2ZXJzaW9uLAoKCWNvbnN0cnVjdG9yOiBqUXVlcnksCgoJLy8gU3RhcnQgd2l0aCBhbiBlbXB0eSBzZWxlY3RvcgoJc2VsZWN0b3I6ICIiLAoKCS8vIFRoZSBkZWZhdWx0IGxlbmd0aCBvZiBhIGpRdWVyeSBvYmplY3QgaXMgMAoJbGVuZ3RoOiAwLAoKCXRvQXJyYXk6IGZ1bmN0aW9uKCkgewoJCXJldHVybiBzbGljZS5jYWxsKCB0aGlzICk7Cgl9LAoKCS8vIEdldCB0aGUgTnRoIGVsZW1lbnQgaW4gdGhlIG1hdGNoZWQgZWxlbWVudCBzZXQgT1IKCS8vIEdldCB0aGUgd2hvbGUgbWF0Y2hlZCBlbGVtZW50IHNldCBhcyBhIGNsZWFuIGFycmF5CglnZXQ6IGZ1bmN0aW9uKCBudW0gKSB7CgkJcmV0dXJuIG51bSAhPSBudWxsID8KCgkJCS8vIFJldHVybiBhICdjbGVhbicgYXJyYXkKCQkJKCBudW0gPCAwID8gdGhpc1sgbnVtICsgdGhpcy5sZW5ndGggXSA6IHRoaXNbIG51bSBdICkgOgoKCQkJLy8gUmV0dXJuIGp1c3QgdGhlIG9iamVjdAoJCQlzbGljZS5jYWxsKCB0aGlzICk7Cgl9LAoKCS8vIFRha2UgYW4gYXJyYXkgb2YgZWxlbWVudHMgYW5kIHB1c2ggaXQgb250byB0aGUgc3RhY2sKCS8vIChyZXR1cm5pbmcgdGhlIG5ldyBtYXRjaGVkIGVsZW1lbnQgc2V0KQoJcHVzaFN0YWNrOiBmdW5jdGlvbiggZWxlbXMgKSB7CgoJCS8vIEJ1aWxkIGEgbmV3IGpRdWVyeSBtYXRjaGVkIGVsZW1lbnQgc2V0CgkJdmFyIHJldCA9IGpRdWVyeS5tZXJnZSggdGhpcy5jb25zdHJ1Y3RvcigpLCBlbGVtcyApOwoKCQkvLyBBZGQgdGhlIG9sZCBvYmplY3Qgb250byB0aGUgc3RhY2sgKGFzIGEgcmVmZXJlbmNlKQoJCXJldC5wcmV2T2JqZWN0ID0gdGhpczsKCQlyZXQuY29udGV4dCA9IHRoaXMuY29udGV4dDsKCgkJLy8gUmV0dXJuIHRoZSBuZXdseS1mb3JtZWQgZWxlbWVudCBzZXQKCQlyZXR1cm4gcmV0OwoJfSwKCgkvLyBFeGVjdXRlIGEgY2FsbGJhY2sgZm9yIGV2ZXJ5IGVsZW1lbnQgaW4gdGhlIG1hdGNoZWQgc2V0LgoJLy8gKFlvdSBjYW4gc2VlZCB0aGUgYXJndW1lbnRzIHdpdGggYW4gYXJyYXkgb2YgYXJncywgYnV0IHRoaXMgaXMKCS8vIG9ubHkgdXNlZCBpbnRlcm5hbGx5LikKCWVhY2g6IGZ1bmN0aW9uKCBjYWxsYmFjaywgYXJncyApIHsKCQlyZXR1cm4galF1ZXJ5LmVhY2goIHRoaXMsIGNhbGxiYWNrLCBhcmdzICk7Cgl9LAoKCW1hcDogZnVuY3Rpb24oIGNhbGxiYWNrICkgewoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggalF1ZXJ5Lm1hcCh0aGlzLCBmdW5jdGlvbiggZWxlbSwgaSApIHsKCQkJcmV0dXJuIGNhbGxiYWNrLmNhbGwoIGVsZW0sIGksIGVsZW0gKTsKCQl9KSk7Cgl9LAoKCXNsaWNlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHNsaWNlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSApOwoJfSwKCglmaXJzdDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZXEoIDAgKTsKCX0sCgoJbGFzdDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZXEoIC0xICk7Cgl9LAoKCWVxOiBmdW5jdGlvbiggaSApIHsKCQl2YXIgbGVuID0gdGhpcy5sZW5ndGgsCgkJCWogPSAraSArICggaSA8IDAgPyBsZW4gOiAwICk7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqID49IDAgJiYgaiA8IGxlbiA/IFsgdGhpc1tqXSBdIDogW10gKTsKCX0sCgoJZW5kOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5wcmV2T2JqZWN0IHx8IHRoaXMuY29uc3RydWN0b3IobnVsbCk7Cgl9LAoKCS8vIEZvciBpbnRlcm5hbCB1c2Ugb25seS4KCS8vIEJlaGF2ZXMgbGlrZSBhbiBBcnJheSdzIG1ldGhvZCwgbm90IGxpa2UgYSBqUXVlcnkgbWV0aG9kLgoJcHVzaDogcHVzaCwKCXNvcnQ6IGRlbGV0ZWRJZHMuc29ydCwKCXNwbGljZTogZGVsZXRlZElkcy5zcGxpY2UKfTsKCmpRdWVyeS5leHRlbmQgPSBqUXVlcnkuZm4uZXh0ZW5kID0gZnVuY3Rpb24oKSB7Cgl2YXIgc3JjLCBjb3B5SXNBcnJheSwgY29weSwgbmFtZSwgb3B0aW9ucywgY2xvbmUsCgkJdGFyZ2V0ID0gYXJndW1lbnRzWzBdIHx8IHt9LAoJCWkgPSAxLAoJCWxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGgsCgkJZGVlcCA9IGZhbHNlOwoKCS8vIEhhbmRsZSBhIGRlZXAgY29weSBzaXR1YXRpb24KCWlmICggdHlwZW9mIHRhcmdldCA9PT0gImJvb2xlYW4iICkgewoJCWRlZXAgPSB0YXJnZXQ7CgoJCS8vIHNraXAgdGhlIGJvb2xlYW4gYW5kIHRoZSB0YXJnZXQKCQl0YXJnZXQgPSBhcmd1bWVudHNbIGkgXSB8fCB7fTsKCQlpKys7Cgl9CgoJLy8gSGFuZGxlIGNhc2Ugd2hlbiB0YXJnZXQgaXMgYSBzdHJpbmcgb3Igc29tZXRoaW5nIChwb3NzaWJsZSBpbiBkZWVwIGNvcHkpCglpZiAoIHR5cGVvZiB0YXJnZXQgIT09ICJvYmplY3QiICYmICFqUXVlcnkuaXNGdW5jdGlvbih0YXJnZXQpICkgewoJCXRhcmdldCA9IHt9OwoJfQoKCS8vIGV4dGVuZCBqUXVlcnkgaXRzZWxmIGlmIG9ubHkgb25lIGFyZ3VtZW50IGlzIHBhc3NlZAoJaWYgKCBpID09PSBsZW5ndGggKSB7CgkJdGFyZ2V0ID0gdGhpczsKCQlpLS07Cgl9CgoJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJLy8gT25seSBkZWFsIHdpdGggbm9uLW51bGwvdW5kZWZpbmVkIHZhbHVlcwoJCWlmICggKG9wdGlvbnMgPSBhcmd1bWVudHNbIGkgXSkgIT0gbnVsbCApIHsKCQkJLy8gRXh0ZW5kIHRoZSBiYXNlIG9iamVjdAoJCQlmb3IgKCBuYW1lIGluIG9wdGlvbnMgKSB7CgkJCQlzcmMgPSB0YXJnZXRbIG5hbWUgXTsKCQkJCWNvcHkgPSBvcHRpb25zWyBuYW1lIF07CgoJCQkJLy8gUHJldmVudCBuZXZlci1lbmRpbmcgbG9vcAoJCQkJaWYgKCB0YXJnZXQgPT09IGNvcHkgKSB7CgkJCQkJY29udGludWU7CgkJCQl9CgoJCQkJLy8gUmVjdXJzZSBpZiB3ZSdyZSBtZXJnaW5nIHBsYWluIG9iamVjdHMgb3IgYXJyYXlzCgkJCQlpZiAoIGRlZXAgJiYgY29weSAmJiAoIGpRdWVyeS5pc1BsYWluT2JqZWN0KGNvcHkpIHx8IChjb3B5SXNBcnJheSA9IGpRdWVyeS5pc0FycmF5KGNvcHkpKSApICkgewoJCQkJCWlmICggY29weUlzQXJyYXkgKSB7CgkJCQkJCWNvcHlJc0FycmF5ID0gZmFsc2U7CgkJCQkJCWNsb25lID0gc3JjICYmIGpRdWVyeS5pc0FycmF5KHNyYykgPyBzcmMgOiBbXTsKCgkJCQkJfSBlbHNlIHsKCQkJCQkJY2xvbmUgPSBzcmMgJiYgalF1ZXJ5LmlzUGxhaW5PYmplY3Qoc3JjKSA/IHNyYyA6IHt9OwoJCQkJCX0KCgkJCQkJLy8gTmV2ZXIgbW92ZSBvcmlnaW5hbCBvYmplY3RzLCBjbG9uZSB0aGVtCgkJCQkJdGFyZ2V0WyBuYW1lIF0gPSBqUXVlcnkuZXh0ZW5kKCBkZWVwLCBjbG9uZSwgY29weSApOwoKCQkJCS8vIERvbid0IGJyaW5nIGluIHVuZGVmaW5lZCB2YWx1ZXMKCQkJCX0gZWxzZSBpZiAoIGNvcHkgIT09IHVuZGVmaW5lZCApIHsKCQkJCQl0YXJnZXRbIG5hbWUgXSA9IGNvcHk7CgkJCQl9CgkJCX0KCQl9Cgl9CgoJLy8gUmV0dXJuIHRoZSBtb2RpZmllZCBvYmplY3QKCXJldHVybiB0YXJnZXQ7Cn07CgpqUXVlcnkuZXh0ZW5kKHsKCS8vIFVuaXF1ZSBmb3IgZWFjaCBjb3B5IG9mIGpRdWVyeSBvbiB0aGUgcGFnZQoJZXhwYW5kbzogImpRdWVyeSIgKyAoIHZlcnNpb24gKyBNYXRoLnJhbmRvbSgpICkucmVwbGFjZSggL1xEL2csICIiICksCgoJLy8gQXNzdW1lIGpRdWVyeSBpcyByZWFkeSB3aXRob3V0IHRoZSByZWFkeSBtb2R1bGUKCWlzUmVhZHk6IHRydWUsCgoJZXJyb3I6IGZ1bmN0aW9uKCBtc2cgKSB7CgkJdGhyb3cgbmV3IEVycm9yKCBtc2cgKTsKCX0sCgoJbm9vcDogZnVuY3Rpb24oKSB7fSwKCgkvLyBTZWUgdGVzdC91bml0L2NvcmUuanMgZm9yIGRldGFpbHMgY29uY2VybmluZyBpc0Z1bmN0aW9uLgoJLy8gU2luY2UgdmVyc2lvbiAxLjMsIERPTSBtZXRob2RzIGFuZCBmdW5jdGlvbnMgbGlrZSBhbGVydAoJLy8gYXJlbid0IHN1cHBvcnRlZC4gVGhleSByZXR1cm4gZmFsc2Ugb24gSUUgKCMyOTY4KS4KCWlzRnVuY3Rpb246IGZ1bmN0aW9uKCBvYmogKSB7CgkJcmV0dXJuIGpRdWVyeS50eXBlKG9iaikgPT09ICJmdW5jdGlvbiI7Cgl9LAoKCWlzQXJyYXk6IEFycmF5LmlzQXJyYXkgfHwgZnVuY3Rpb24oIG9iaiApIHsKCQlyZXR1cm4galF1ZXJ5LnR5cGUob2JqKSA9PT0gImFycmF5IjsKCX0sCgoJaXNXaW5kb3c6IGZ1bmN0aW9uKCBvYmogKSB7CgkJLyoganNoaW50IGVxZXFlcTogZmFsc2UgKi8KCQlyZXR1cm4gb2JqICE9IG51bGwgJiYgb2JqID09IG9iai53aW5kb3c7Cgl9LAoKCWlzTnVtZXJpYzogZnVuY3Rpb24oIG9iaiApIHsKCQkvLyBwYXJzZUZsb2F0IE5hTnMgbnVtZXJpYy1jYXN0IGZhbHNlIHBvc2l0aXZlcyAobnVsbHx0cnVlfGZhbHNlfCIiKQoJCS8vIC4uLmJ1dCBtaXNpbnRlcnByZXRzIGxlYWRpbmctbnVtYmVyIHN0cmluZ3MsIHBhcnRpY3VsYXJseSBoZXggbGl0ZXJhbHMgKCIweC4uLiIpCgkJLy8gc3VidHJhY3Rpb24gZm9yY2VzIGluZmluaXRpZXMgdG8gTmFOCgkJcmV0dXJuIG9iaiAtIHBhcnNlRmxvYXQoIG9iaiApID49IDA7Cgl9LAoKCWlzRW1wdHlPYmplY3Q6IGZ1bmN0aW9uKCBvYmogKSB7CgkJdmFyIG5hbWU7CgkJZm9yICggbmFtZSBpbiBvYmogKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9LAoKCWlzUGxhaW5PYmplY3Q6IGZ1bmN0aW9uKCBvYmogKSB7CgkJdmFyIGtleTsKCgkJLy8gTXVzdCBiZSBhbiBPYmplY3QuCgkJLy8gQmVjYXVzZSBvZiBJRSwgd2UgYWxzbyBoYXZlIHRvIGNoZWNrIHRoZSBwcmVzZW5jZSBvZiB0aGUgY29uc3RydWN0b3IgcHJvcGVydHkuCgkJLy8gTWFrZSBzdXJlIHRoYXQgRE9NIG5vZGVzIGFuZCB3aW5kb3cgb2JqZWN0cyBkb24ndCBwYXNzIHRocm91Z2gsIGFzIHdlbGwKCQlpZiAoICFvYmogfHwgalF1ZXJ5LnR5cGUob2JqKSAhPT0gIm9iamVjdCIgfHwgb2JqLm5vZGVUeXBlIHx8IGpRdWVyeS5pc1dpbmRvdyggb2JqICkgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXRyeSB7CgkJCS8vIE5vdCBvd24gY29uc3RydWN0b3IgcHJvcGVydHkgbXVzdCBiZSBPYmplY3QKCQkJaWYgKCBvYmouY29uc3RydWN0b3IgJiYKCQkJCSFoYXNPd24uY2FsbChvYmosICJjb25zdHJ1Y3RvciIpICYmCgkJCQkhaGFzT3duLmNhbGwob2JqLmNvbnN0cnVjdG9yLnByb3RvdHlwZSwgImlzUHJvdG90eXBlT2YiKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0gY2F0Y2ggKCBlICkgewoJCQkvLyBJRTgsOSBXaWxsIHRocm93IGV4Y2VwdGlvbnMgb24gY2VydGFpbiBob3N0IG9iamVjdHMgIzk4OTcKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJLy8gU3VwcG9ydDogSUU8OQoJCS8vIEhhbmRsZSBpdGVyYXRpb24gb3ZlciBpbmhlcml0ZWQgcHJvcGVydGllcyBiZWZvcmUgb3duIHByb3BlcnRpZXMuCgkJaWYgKCBzdXBwb3J0Lm93bkxhc3QgKSB7CgkJCWZvciAoIGtleSBpbiBvYmogKSB7CgkJCQlyZXR1cm4gaGFzT3duLmNhbGwoIG9iaiwga2V5ICk7CgkJCX0KCQl9CgoJCS8vIE93biBwcm9wZXJ0aWVzIGFyZSBlbnVtZXJhdGVkIGZpcnN0bHksIHNvIHRvIHNwZWVkIHVwLAoJCS8vIGlmIGxhc3Qgb25lIGlzIG93biwgdGhlbiBhbGwgcHJvcGVydGllcyBhcmUgb3duLgoJCWZvciAoIGtleSBpbiBvYmogKSB7fQoKCQlyZXR1cm4ga2V5ID09PSB1bmRlZmluZWQgfHwgaGFzT3duLmNhbGwoIG9iaiwga2V5ICk7Cgl9LAoKCXR5cGU6IGZ1bmN0aW9uKCBvYmogKSB7CgkJaWYgKCBvYmogPT0gbnVsbCApIHsKCQkJcmV0dXJuIG9iaiArICIiOwoJCX0KCQlyZXR1cm4gdHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIG9iaiA9PT0gImZ1bmN0aW9uIiA/CgkJCWNsYXNzMnR5cGVbIHRvU3RyaW5nLmNhbGwob2JqKSBdIHx8ICJvYmplY3QiIDoKCQkJdHlwZW9mIG9iajsKCX0sCgoJLy8gRXZhbHVhdGVzIGEgc2NyaXB0IGluIGEgZ2xvYmFsIGNvbnRleHQKCS8vIFdvcmthcm91bmRzIGJhc2VkIG9uIGZpbmRpbmdzIGJ5IEppbSBEcmlzY29sbAoJLy8gaHR0cDovL3dlYmxvZ3MuamF2YS5uZXQvYmxvZy9kcmlzY29sbC9hcmNoaXZlLzIwMDkvMDkvMDgvZXZhbC1qYXZhc2NyaXB0LWdsb2JhbC1jb250ZXh0CglnbG9iYWxFdmFsOiBmdW5jdGlvbiggZGF0YSApIHsKCQlpZiAoIGRhdGEgJiYgalF1ZXJ5LnRyaW0oIGRhdGEgKSApIHsKCQkJLy8gV2UgdXNlIGV4ZWNTY3JpcHQgb24gSW50ZXJuZXQgRXhwbG9yZXIKCQkJLy8gV2UgdXNlIGFuIGFub255bW91cyBmdW5jdGlvbiBzbyB0aGF0IGNvbnRleHQgaXMgd2luZG93CgkJCS8vIHJhdGhlciB0aGFuIGpRdWVyeSBpbiBGaXJlZm94CgkJCSggd2luZG93LmV4ZWNTY3JpcHQgfHwgZnVuY3Rpb24oIGRhdGEgKSB7CgkJCQl3aW5kb3dbICJldmFsIiBdLmNhbGwoIHdpbmRvdywgZGF0YSApOwoJCQl9ICkoIGRhdGEgKTsKCQl9Cgl9LAoKCS8vIENvbnZlcnQgZGFzaGVkIHRvIGNhbWVsQ2FzZTsgdXNlZCBieSB0aGUgY3NzIGFuZCBkYXRhIG1vZHVsZXMKCS8vIE1pY3Jvc29mdCBmb3Jnb3QgdG8gaHVtcCB0aGVpciB2ZW5kb3IgcHJlZml4ICgjOTU3MikKCWNhbWVsQ2FzZTogZnVuY3Rpb24oIHN0cmluZyApIHsKCQlyZXR1cm4gc3RyaW5nLnJlcGxhY2UoIHJtc1ByZWZpeCwgIm1zLSIgKS5yZXBsYWNlKCByZGFzaEFscGhhLCBmY2FtZWxDYXNlICk7Cgl9LAoKCW5vZGVOYW1lOiBmdW5jdGlvbiggZWxlbSwgbmFtZSApIHsKCQlyZXR1cm4gZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUudG9Mb3dlckNhc2UoKTsKCX0sCgoJLy8gYXJncyBpcyBmb3IgaW50ZXJuYWwgdXNhZ2Ugb25seQoJZWFjaDogZnVuY3Rpb24oIG9iaiwgY2FsbGJhY2ssIGFyZ3MgKSB7CgkJdmFyIHZhbHVlLAoJCQlpID0gMCwKCQkJbGVuZ3RoID0gb2JqLmxlbmd0aCwKCQkJaXNBcnJheSA9IGlzQXJyYXlsaWtlKCBvYmogKTsKCgkJaWYgKCBhcmdzICkgewoJCQlpZiAoIGlzQXJyYXkgKSB7CgkJCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJCQl2YWx1ZSA9IGNhbGxiYWNrLmFwcGx5KCBvYmpbIGkgXSwgYXJncyApOwoKCQkJCQlpZiAoIHZhbHVlID09PSBmYWxzZSApIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9IGVsc2UgewoJCQkJZm9yICggaSBpbiBvYmogKSB7CgkJCQkJdmFsdWUgPSBjYWxsYmFjay5hcHBseSggb2JqWyBpIF0sIGFyZ3MgKTsKCgkJCQkJaWYgKCB2YWx1ZSA9PT0gZmFsc2UgKSB7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkvLyBBIHNwZWNpYWwsIGZhc3QsIGNhc2UgZm9yIHRoZSBtb3N0IGNvbW1vbiB1c2Ugb2YgZWFjaAoJCX0gZWxzZSB7CgkJCWlmICggaXNBcnJheSApIHsKCQkJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQkJCXZhbHVlID0gY2FsbGJhY2suY2FsbCggb2JqWyBpIF0sIGksIG9ialsgaSBdICk7CgoJCQkJCWlmICggdmFsdWUgPT09IGZhbHNlICkgewoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlmb3IgKCBpIGluIG9iaiApIHsKCQkJCQl2YWx1ZSA9IGNhbGxiYWNrLmNhbGwoIG9ialsgaSBdLCBpLCBvYmpbIGkgXSApOwoKCQkJCQlpZiAoIHZhbHVlID09PSBmYWxzZSApIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvLyBVc2UgbmF0aXZlIFN0cmluZy50cmltIGZ1bmN0aW9uIHdoZXJldmVyIHBvc3NpYmxlCgl0cmltOiB0cmltICYmICF0cmltLmNhbGwoIlx1RkVGRlx4QTAiKSA/CgkJZnVuY3Rpb24oIHRleHQgKSB7CgkJCXJldHVybiB0ZXh0ID09IG51bGwgPwoJCQkJIiIgOgoJCQkJdHJpbS5jYWxsKCB0ZXh0ICk7CgkJfSA6CgoJCS8vIE90aGVyd2lzZSB1c2Ugb3VyIG93biB0cmltbWluZyBmdW5jdGlvbmFsaXR5CgkJZnVuY3Rpb24oIHRleHQgKSB7CgkJCXJldHVybiB0ZXh0ID09IG51bGwgPwoJCQkJIiIgOgoJCQkJKCB0ZXh0ICsgIiIgKS5yZXBsYWNlKCBydHJpbSwgIiIgKTsKCQl9LAoKCS8vIHJlc3VsdHMgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKCW1ha2VBcnJheTogZnVuY3Rpb24oIGFyciwgcmVzdWx0cyApIHsKCQl2YXIgcmV0ID0gcmVzdWx0cyB8fCBbXTsKCgkJaWYgKCBhcnIgIT0gbnVsbCApIHsKCQkJaWYgKCBpc0FycmF5bGlrZSggT2JqZWN0KGFycikgKSApIHsKCQkJCWpRdWVyeS5tZXJnZSggcmV0LAoJCQkJCXR5cGVvZiBhcnIgPT09ICJzdHJpbmciID8KCQkJCQlbIGFyciBdIDogYXJyCgkJCQkpOwoJCQl9IGVsc2UgewoJCQkJcHVzaC5jYWxsKCByZXQsIGFyciApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglpbkFycmF5OiBmdW5jdGlvbiggZWxlbSwgYXJyLCBpICkgewoJCXZhciBsZW47CgoJCWlmICggYXJyICkgewoJCQlpZiAoIGluZGV4T2YgKSB7CgkJCQlyZXR1cm4gaW5kZXhPZi5jYWxsKCBhcnIsIGVsZW0sIGkgKTsKCQkJfQoKCQkJbGVuID0gYXJyLmxlbmd0aDsKCQkJaSA9IGkgPyBpIDwgMCA/IE1hdGgubWF4KCAwLCBsZW4gKyBpICkgOiBpIDogMDsKCgkJCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgewoJCQkJLy8gU2tpcCBhY2Nlc3NpbmcgaW4gc3BhcnNlIGFycmF5cwoJCQkJaWYgKCBpIGluIGFyciAmJiBhcnJbIGkgXSA9PT0gZWxlbSApIHsKCQkJCQlyZXR1cm4gaTsKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIC0xOwoJfSwKCgltZXJnZTogZnVuY3Rpb24oIGZpcnN0LCBzZWNvbmQgKSB7CgkJdmFyIGxlbiA9ICtzZWNvbmQubGVuZ3RoLAoJCQlqID0gMCwKCQkJaSA9IGZpcnN0Lmxlbmd0aDsKCgkJd2hpbGUgKCBqIDwgbGVuICkgewoJCQlmaXJzdFsgaSsrIF0gPSBzZWNvbmRbIGorKyBdOwoJCX0KCgkJLy8gU3VwcG9ydDogSUU8OQoJCS8vIFdvcmthcm91bmQgY2FzdGluZyBvZiAubGVuZ3RoIHRvIE5hTiBvbiBvdGhlcndpc2UgYXJyYXlsaWtlIG9iamVjdHMgKGUuZy4sIE5vZGVMaXN0cykKCQlpZiAoIGxlbiAhPT0gbGVuICkgewoJCQl3aGlsZSAoIHNlY29uZFtqXSAhPT0gdW5kZWZpbmVkICkgewoJCQkJZmlyc3RbIGkrKyBdID0gc2Vjb25kWyBqKysgXTsKCQkJfQoJCX0KCgkJZmlyc3QubGVuZ3RoID0gaTsKCgkJcmV0dXJuIGZpcnN0OwoJfSwKCglncmVwOiBmdW5jdGlvbiggZWxlbXMsIGNhbGxiYWNrLCBpbnZlcnQgKSB7CgkJdmFyIGNhbGxiYWNrSW52ZXJzZSwKCQkJbWF0Y2hlcyA9IFtdLAoJCQlpID0gMCwKCQkJbGVuZ3RoID0gZWxlbXMubGVuZ3RoLAoJCQljYWxsYmFja0V4cGVjdCA9ICFpbnZlcnQ7CgoJCS8vIEdvIHRocm91Z2ggdGhlIGFycmF5LCBvbmx5IHNhdmluZyB0aGUgaXRlbXMKCQkvLyB0aGF0IHBhc3MgdGhlIHZhbGlkYXRvciBmdW5jdGlvbgoJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQljYWxsYmFja0ludmVyc2UgPSAhY2FsbGJhY2soIGVsZW1zWyBpIF0sIGkgKTsKCQkJaWYgKCBjYWxsYmFja0ludmVyc2UgIT09IGNhbGxiYWNrRXhwZWN0ICkgewoJCQkJbWF0Y2hlcy5wdXNoKCBlbGVtc1sgaSBdICk7CgkJCX0KCQl9CgoJCXJldHVybiBtYXRjaGVzOwoJfSwKCgkvLyBhcmcgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKCW1hcDogZnVuY3Rpb24oIGVsZW1zLCBjYWxsYmFjaywgYXJnICkgewoJCXZhciB2YWx1ZSwKCQkJaSA9IDAsCgkJCWxlbmd0aCA9IGVsZW1zLmxlbmd0aCwKCQkJaXNBcnJheSA9IGlzQXJyYXlsaWtlKCBlbGVtcyApLAoJCQlyZXQgPSBbXTsKCgkJLy8gR28gdGhyb3VnaCB0aGUgYXJyYXksIHRyYW5zbGF0aW5nIGVhY2ggb2YgdGhlIGl0ZW1zIHRvIHRoZWlyIG5ldyB2YWx1ZXMKCQlpZiAoIGlzQXJyYXkgKSB7CgkJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQkJdmFsdWUgPSBjYWxsYmFjayggZWxlbXNbIGkgXSwgaSwgYXJnICk7CgoJCQkJaWYgKCB2YWx1ZSAhPSBudWxsICkgewoJCQkJCXJldC5wdXNoKCB2YWx1ZSApOwoJCQkJfQoJCQl9CgoJCS8vIEdvIHRocm91Z2ggZXZlcnkga2V5IG9uIHRoZSBvYmplY3QsCgkJfSBlbHNlIHsKCQkJZm9yICggaSBpbiBlbGVtcyApIHsKCQkJCXZhbHVlID0gY2FsbGJhY2soIGVsZW1zWyBpIF0sIGksIGFyZyApOwoKCQkJCWlmICggdmFsdWUgIT0gbnVsbCApIHsKCQkJCQlyZXQucHVzaCggdmFsdWUgKTsKCQkJCX0KCQkJfQoJCX0KCgkJLy8gRmxhdHRlbiBhbnkgbmVzdGVkIGFycmF5cwoJCXJldHVybiBjb25jYXQuYXBwbHkoIFtdLCByZXQgKTsKCX0sCgoJLy8gQSBnbG9iYWwgR1VJRCBjb3VudGVyIGZvciBvYmplY3RzCglndWlkOiAxLAoKCS8vIEJpbmQgYSBmdW5jdGlvbiB0byBhIGNvbnRleHQsIG9wdGlvbmFsbHkgcGFydGlhbGx5IGFwcGx5aW5nIGFueQoJLy8gYXJndW1lbnRzLgoJcHJveHk6IGZ1bmN0aW9uKCBmbiwgY29udGV4dCApIHsKCQl2YXIgYXJncywgcHJveHksIHRtcDsKCgkJaWYgKCB0eXBlb2YgY29udGV4dCA9PT0gInN0cmluZyIgKSB7CgkJCXRtcCA9IGZuWyBjb250ZXh0IF07CgkJCWNvbnRleHQgPSBmbjsKCQkJZm4gPSB0bXA7CgkJfQoKCQkvLyBRdWljayBjaGVjayB0byBkZXRlcm1pbmUgaWYgdGFyZ2V0IGlzIGNhbGxhYmxlLCBpbiB0aGUgc3BlYwoJCS8vIHRoaXMgdGhyb3dzIGEgVHlwZUVycm9yLCBidXQgd2Ugd2lsbCBqdXN0IHJldHVybiB1bmRlZmluZWQuCgkJaWYgKCAhalF1ZXJ5LmlzRnVuY3Rpb24oIGZuICkgKSB7CgkJCXJldHVybiB1bmRlZmluZWQ7CgkJfQoKCQkvLyBTaW11bGF0ZWQgYmluZAoJCWFyZ3MgPSBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDIgKTsKCQlwcm94eSA9IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gZm4uYXBwbHkoIGNvbnRleHQgfHwgdGhpcywgYXJncy5jb25jYXQoIHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApICkgKTsKCQl9OwoKCQkvLyBTZXQgdGhlIGd1aWQgb2YgdW5pcXVlIGhhbmRsZXIgdG8gdGhlIHNhbWUgb2Ygb3JpZ2luYWwgaGFuZGxlciwgc28gaXQgY2FuIGJlIHJlbW92ZWQKCQlwcm94eS5ndWlkID0gZm4uZ3VpZCA9IGZuLmd1aWQgfHwgalF1ZXJ5Lmd1aWQrKzsKCgkJcmV0dXJuIHByb3h5OwoJfSwKCglub3c6IGZ1bmN0aW9uKCkgewoJCXJldHVybiArKCBuZXcgRGF0ZSgpICk7Cgl9LAoKCS8vIGpRdWVyeS5zdXBwb3J0IGlzIG5vdCB1c2VkIGluIENvcmUgYnV0IG90aGVyIHByb2plY3RzIGF0dGFjaCB0aGVpcgoJLy8gcHJvcGVydGllcyB0byBpdCBzbyBpdCBuZWVkcyB0byBleGlzdC4KCXN1cHBvcnQ6IHN1cHBvcnQKfSk7CgovLyBQb3B1bGF0ZSB0aGUgY2xhc3MydHlwZSBtYXAKalF1ZXJ5LmVhY2goIkJvb2xlYW4gTnVtYmVyIFN0cmluZyBGdW5jdGlvbiBBcnJheSBEYXRlIFJlZ0V4cCBPYmplY3QgRXJyb3IiLnNwbGl0KCIgIiksIGZ1bmN0aW9uKGksIG5hbWUpIHsKCWNsYXNzMnR5cGVbICJbb2JqZWN0ICIgKyBuYW1lICsgIl0iIF0gPSBuYW1lLnRvTG93ZXJDYXNlKCk7Cn0pOwoKZnVuY3Rpb24gaXNBcnJheWxpa2UoIG9iaiApIHsKCXZhciBsZW5ndGggPSBvYmoubGVuZ3RoLAoJCXR5cGUgPSBqUXVlcnkudHlwZSggb2JqICk7CgoJaWYgKCB0eXBlID09PSAiZnVuY3Rpb24iIHx8IGpRdWVyeS5pc1dpbmRvdyggb2JqICkgKSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWlmICggb2JqLm5vZGVUeXBlID09PSAxICYmIGxlbmd0aCApIHsKCQlyZXR1cm4gdHJ1ZTsKCX0KCglyZXR1cm4gdHlwZSA9PT0gImFycmF5IiB8fCBsZW5ndGggPT09IDAgfHwKCQl0eXBlb2YgbGVuZ3RoID09PSAibnVtYmVyIiAmJiBsZW5ndGggPiAwICYmICggbGVuZ3RoIC0gMSApIGluIG9iajsKfQp2YXIgU2l6emxlID0KLyohCiAqIFNpenpsZSBDU1MgU2VsZWN0b3IgRW5naW5lIHYxLjEwLjE2CiAqIGh0dHA6Ly9zaXp6bGVqcy5jb20vCiAqCiAqIENvcHlyaWdodCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uLCBJbmMuIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogRGF0ZTogMjAxNC0wMS0xMwogKi8KKGZ1bmN0aW9uKCB3aW5kb3cgKSB7Cgp2YXIgaSwKCXN1cHBvcnQsCglFeHByLAoJZ2V0VGV4dCwKCWlzWE1MLAoJY29tcGlsZSwKCW91dGVybW9zdENvbnRleHQsCglzb3J0SW5wdXQsCgloYXNEdXBsaWNhdGUsCgoJLy8gTG9jYWwgZG9jdW1lbnQgdmFycwoJc2V0RG9jdW1lbnQsCglkb2N1bWVudCwKCWRvY0VsZW0sCglkb2N1bWVudElzSFRNTCwKCXJidWdneVFTQSwKCXJidWdneU1hdGNoZXMsCgltYXRjaGVzLAoJY29udGFpbnMsCgoJLy8gSW5zdGFuY2Utc3BlY2lmaWMgZGF0YQoJZXhwYW5kbyA9ICJzaXp6bGUiICsgLShuZXcgRGF0ZSgpKSwKCXByZWZlcnJlZERvYyA9IHdpbmRvdy5kb2N1bWVudCwKCWRpcnJ1bnMgPSAwLAoJZG9uZSA9IDAsCgljbGFzc0NhY2hlID0gY3JlYXRlQ2FjaGUoKSwKCXRva2VuQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLAoJY29tcGlsZXJDYWNoZSA9IGNyZWF0ZUNhY2hlKCksCglzb3J0T3JkZXIgPSBmdW5jdGlvbiggYSwgYiApIHsKCQlpZiAoIGEgPT09IGIgKSB7CgkJCWhhc0R1cGxpY2F0ZSA9IHRydWU7CgkJfQoJCXJldHVybiAwOwoJfSwKCgkvLyBHZW5lcmFsLXB1cnBvc2UgY29uc3RhbnRzCglzdHJ1bmRlZmluZWQgPSB0eXBlb2YgdW5kZWZpbmVkLAoJTUFYX05FR0FUSVZFID0gMSA8PCAzMSwKCgkvLyBJbnN0YW5jZSBtZXRob2RzCgloYXNPd24gPSAoe30pLmhhc093blByb3BlcnR5LAoJYXJyID0gW10sCglwb3AgPSBhcnIucG9wLAoJcHVzaF9uYXRpdmUgPSBhcnIucHVzaCwKCXB1c2ggPSBhcnIucHVzaCwKCXNsaWNlID0gYXJyLnNsaWNlLAoJLy8gVXNlIGEgc3RyaXBwZWQtZG93biBpbmRleE9mIGlmIHdlIGNhbid0IHVzZSBhIG5hdGl2ZSBvbmUKCWluZGV4T2YgPSBhcnIuaW5kZXhPZiB8fCBmdW5jdGlvbiggZWxlbSApIHsKCQl2YXIgaSA9IDAsCgkJCWxlbiA9IHRoaXMubGVuZ3RoOwoJCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgewoJCQlpZiAoIHRoaXNbaV0gPT09IGVsZW0gKSB7CgkJCQlyZXR1cm4gaTsKCQkJfQoJCX0KCQlyZXR1cm4gLTE7Cgl9LAoKCWJvb2xlYW5zID0gImNoZWNrZWR8c2VsZWN0ZWR8YXN5bmN8YXV0b2ZvY3VzfGF1dG9wbGF5fGNvbnRyb2xzfGRlZmVyfGRpc2FibGVkfGhpZGRlbnxpc21hcHxsb29wfG11bHRpcGxlfG9wZW58cmVhZG9ubHl8cmVxdWlyZWR8c2NvcGVkIiwKCgkvLyBSZWd1bGFyIGV4cHJlc3Npb25zCgoJLy8gV2hpdGVzcGFjZSBjaGFyYWN0ZXJzIGh0dHA6Ly93d3cudzMub3JnL1RSL2NzczMtc2VsZWN0b3JzLyN3aGl0ZXNwYWNlCgl3aGl0ZXNwYWNlID0gIltcXHgyMFxcdFxcclxcblxcZl0iLAoJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1zeW50YXgvI2NoYXJhY3RlcnMKCWNoYXJhY3RlckVuY29kaW5nID0gIig/OlxcXFwufFtcXHctXXxbXlxceDAwLVxceGEwXSkrIiwKCgkvLyBMb29zZWx5IG1vZGVsZWQgb24gQ1NTIGlkZW50aWZpZXIgY2hhcmFjdGVycwoJLy8gQW4gdW5xdW90ZWQgdmFsdWUgc2hvdWxkIGJlIGEgQ1NTIGlkZW50aWZpZXIgaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1zZWxlY3RvcnMvI2F0dHJpYnV0ZS1zZWxlY3RvcnMKCS8vIFByb3BlciBzeW50YXg6IGh0dHA6Ly93d3cudzMub3JnL1RSL0NTUzIxL3N5bmRhdGEuaHRtbCN2YWx1ZS1kZWYtaWRlbnRpZmllcgoJaWRlbnRpZmllciA9IGNoYXJhY3RlckVuY29kaW5nLnJlcGxhY2UoICJ3IiwgIncjIiApLAoKCS8vIEFjY2VwdGFibGUgb3BlcmF0b3JzIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jYXR0cmlidXRlLXNlbGVjdG9ycwoJYXR0cmlidXRlcyA9ICJcXFsiICsgd2hpdGVzcGFjZSArICIqKCIgKyBjaGFyYWN0ZXJFbmNvZGluZyArICIpIiArIHdoaXRlc3BhY2UgKwoJCSIqKD86KFsqXiR8IX5dPz0pIiArIHdoaXRlc3BhY2UgKyAiKig/OihbJ1wiXSkoKD86XFxcXC58W15cXFxcXSkqPylcXDN8KCIgKyBpZGVudGlmaWVyICsgIil8KXwpIiArIHdoaXRlc3BhY2UgKyAiKlxcXSIsCgoJLy8gUHJlZmVyIGFyZ3VtZW50cyBxdW90ZWQsCgkvLyAgIHRoZW4gbm90IGNvbnRhaW5pbmcgcHNldWRvcy9icmFja2V0cywKCS8vICAgdGhlbiBhdHRyaWJ1dGUgc2VsZWN0b3JzL25vbi1wYXJlbnRoZXRpY2FsIGV4cHJlc3Npb25zLAoJLy8gICB0aGVuIGFueXRoaW5nIGVsc2UKCS8vIFRoZXNlIHByZWZlcmVuY2VzIGFyZSBoZXJlIHRvIHJlZHVjZSB0aGUgbnVtYmVyIG9mIHNlbGVjdG9ycwoJLy8gICBuZWVkaW5nIHRva2VuaXplIGluIHRoZSBQU0VVRE8gcHJlRmlsdGVyCglwc2V1ZG9zID0gIjooIiArIGNoYXJhY3RlckVuY29kaW5nICsgIikoPzpcXCgoKFsnXCJdKSgoPzpcXFxcLnxbXlxcXFxdKSo/KVxcM3woKD86XFxcXC58W15cXFxcKClbXFxdXXwiICsgYXR0cmlidXRlcy5yZXBsYWNlKCAzLCA4ICkgKyAiKSopfC4qKVxcKXwpIiwKCgkvLyBMZWFkaW5nIGFuZCBub24tZXNjYXBlZCB0cmFpbGluZyB3aGl0ZXNwYWNlLCBjYXB0dXJpbmcgc29tZSBub24td2hpdGVzcGFjZSBjaGFyYWN0ZXJzIHByZWNlZGluZyB0aGUgbGF0dGVyCglydHJpbSA9IG5ldyBSZWdFeHAoICJeIiArIHdoaXRlc3BhY2UgKyAiK3woKD86XnxbXlxcXFxdKSg/OlxcXFwuKSopIiArIHdoaXRlc3BhY2UgKyAiKyQiLCAiZyIgKSwKCglyY29tbWEgPSBuZXcgUmVnRXhwKCAiXiIgKyB3aGl0ZXNwYWNlICsgIiosIiArIHdoaXRlc3BhY2UgKyAiKiIgKSwKCXJjb21iaW5hdG9ycyA9IG5ldyBSZWdFeHAoICJeIiArIHdoaXRlc3BhY2UgKyAiKihbPit+XXwiICsgd2hpdGVzcGFjZSArICIpIiArIHdoaXRlc3BhY2UgKyAiKiIgKSwKCglyYXR0cmlidXRlUXVvdGVzID0gbmV3IFJlZ0V4cCggIj0iICsgd2hpdGVzcGFjZSArICIqKFteXFxdJ1wiXSo/KSIgKyB3aGl0ZXNwYWNlICsgIipcXF0iLCAiZyIgKSwKCglycHNldWRvID0gbmV3IFJlZ0V4cCggcHNldWRvcyApLAoJcmlkZW50aWZpZXIgPSBuZXcgUmVnRXhwKCAiXiIgKyBpZGVudGlmaWVyICsgIiQiICksCgoJbWF0Y2hFeHByID0gewoJCSJJRCI6IG5ldyBSZWdFeHAoICJeIygiICsgY2hhcmFjdGVyRW5jb2RpbmcgKyAiKSIgKSwKCQkiQ0xBU1MiOiBuZXcgUmVnRXhwKCAiXlxcLigiICsgY2hhcmFjdGVyRW5jb2RpbmcgKyAiKSIgKSwKCQkiVEFHIjogbmV3IFJlZ0V4cCggIl4oIiArIGNoYXJhY3RlckVuY29kaW5nLnJlcGxhY2UoICJ3IiwgIncqIiApICsgIikiICksCgkJIkFUVFIiOiBuZXcgUmVnRXhwKCAiXiIgKyBhdHRyaWJ1dGVzICksCgkJIlBTRVVETyI6IG5ldyBSZWdFeHAoICJeIiArIHBzZXVkb3MgKSwKCQkiQ0hJTEQiOiBuZXcgUmVnRXhwKCAiXjoob25seXxmaXJzdHxsYXN0fG50aHxudGgtbGFzdCktKGNoaWxkfG9mLXR5cGUpKD86XFwoIiArIHdoaXRlc3BhY2UgKwoJCQkiKihldmVufG9kZHwoKFsrLV18KShcXGQqKW58KSIgKyB3aGl0ZXNwYWNlICsgIiooPzooWystXXwpIiArIHdoaXRlc3BhY2UgKwoJCQkiKihcXGQrKXwpKSIgKyB3aGl0ZXNwYWNlICsgIipcXCl8KSIsICJpIiApLAoJCSJib29sIjogbmV3IFJlZ0V4cCggIl4oPzoiICsgYm9vbGVhbnMgKyAiKSQiLCAiaSIgKSwKCQkvLyBGb3IgdXNlIGluIGxpYnJhcmllcyBpbXBsZW1lbnRpbmcgLmlzKCkKCQkvLyBXZSB1c2UgdGhpcyBmb3IgUE9TIG1hdGNoaW5nIGluIGBzZWxlY3RgCgkJIm5lZWRzQ29udGV4dCI6IG5ldyBSZWdFeHAoICJeIiArIHdoaXRlc3BhY2UgKyAiKls+K35dfDooZXZlbnxvZGR8ZXF8Z3R8bHR8bnRofGZpcnN0fGxhc3QpKD86XFwoIiArCgkJCXdoaXRlc3BhY2UgKyAiKigoPzotXFxkKT9cXGQqKSIgKyB3aGl0ZXNwYWNlICsgIipcXCl8KSg/PVteLV18JCkiLCAiaSIgKQoJfSwKCglyaW5wdXRzID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9uKSQvaSwKCXJoZWFkZXIgPSAvXmhcZCQvaSwKCglybmF0aXZlID0gL15bXntdK1x7XHMqXFtuYXRpdmUgXHcvLAoKCS8vIEVhc2lseS1wYXJzZWFibGUvcmV0cmlldmFibGUgSUQgb3IgVEFHIG9yIENMQVNTIHNlbGVjdG9ycwoJcnF1aWNrRXhwciA9IC9eKD86IyhbXHctXSspfChcdyspfFwuKFtcdy1dKykpJC8sCgoJcnNpYmxpbmcgPSAvWyt+XS8sCglyZXNjYXBlID0gLyd8XFwvZywKCgkvLyBDU1MgZXNjYXBlcyBodHRwOi8vd3d3LnczLm9yZy9UUi9DU1MyMS9zeW5kYXRhLmh0bWwjZXNjYXBlZC1jaGFyYWN0ZXJzCglydW5lc2NhcGUgPSBuZXcgUmVnRXhwKCAiXFxcXChbXFxkYS1mXXsxLDZ9IiArIHdoaXRlc3BhY2UgKyAiP3woIiArIHdoaXRlc3BhY2UgKyAiKXwuKSIsICJpZyIgKSwKCWZ1bmVzY2FwZSA9IGZ1bmN0aW9uKCBfLCBlc2NhcGVkLCBlc2NhcGVkV2hpdGVzcGFjZSApIHsKCQl2YXIgaGlnaCA9ICIweCIgKyBlc2NhcGVkIC0gMHgxMDAwMDsKCQkvLyBOYU4gbWVhbnMgbm9uLWNvZGVwb2ludAoJCS8vIFN1cHBvcnQ6IEZpcmVmb3gKCQkvLyBXb3JrYXJvdW5kIGVycm9uZW91cyBudW1lcmljIGludGVycHJldGF0aW9uIG9mICsiMHgiCgkJcmV0dXJuIGhpZ2ggIT09IGhpZ2ggfHwgZXNjYXBlZFdoaXRlc3BhY2UgPwoJCQllc2NhcGVkIDoKCQkJaGlnaCA8IDAgPwoJCQkJLy8gQk1QIGNvZGVwb2ludAoJCQkJU3RyaW5nLmZyb21DaGFyQ29kZSggaGlnaCArIDB4MTAwMDAgKSA6CgkJCQkvLyBTdXBwbGVtZW50YWwgUGxhbmUgY29kZXBvaW50IChzdXJyb2dhdGUgcGFpcikKCQkJCVN0cmluZy5mcm9tQ2hhckNvZGUoIGhpZ2ggPj4gMTAgfCAweEQ4MDAsIGhpZ2ggJiAweDNGRiB8IDB4REMwMCApOwoJfTsKCi8vIE9wdGltaXplIGZvciBwdXNoLmFwcGx5KCBfLCBOb2RlTGlzdCApCnRyeSB7CglwdXNoLmFwcGx5KAoJCShhcnIgPSBzbGljZS5jYWxsKCBwcmVmZXJyZWREb2MuY2hpbGROb2RlcyApKSwKCQlwcmVmZXJyZWREb2MuY2hpbGROb2RlcwoJKTsKCS8vIFN1cHBvcnQ6IEFuZHJvaWQ8NC4wCgkvLyBEZXRlY3Qgc2lsZW50bHkgZmFpbGluZyBwdXNoLmFwcGx5CglhcnJbIHByZWZlcnJlZERvYy5jaGlsZE5vZGVzLmxlbmd0aCBdLm5vZGVUeXBlOwp9IGNhdGNoICggZSApIHsKCXB1c2ggPSB7IGFwcGx5OiBhcnIubGVuZ3RoID8KCgkJLy8gTGV2ZXJhZ2Ugc2xpY2UgaWYgcG9zc2libGUKCQlmdW5jdGlvbiggdGFyZ2V0LCBlbHMgKSB7CgkJCXB1c2hfbmF0aXZlLmFwcGx5KCB0YXJnZXQsIHNsaWNlLmNhbGwoZWxzKSApOwoJCX0gOgoKCQkvLyBTdXBwb3J0OiBJRTw5CgkJLy8gT3RoZXJ3aXNlIGFwcGVuZCBkaXJlY3RseQoJCWZ1bmN0aW9uKCB0YXJnZXQsIGVscyApIHsKCQkJdmFyIGogPSB0YXJnZXQubGVuZ3RoLAoJCQkJaSA9IDA7CgkJCS8vIENhbid0IHRydXN0IE5vZGVMaXN0Lmxlbmd0aAoJCQl3aGlsZSAoICh0YXJnZXRbaisrXSA9IGVsc1tpKytdKSApIHt9CgkJCXRhcmdldC5sZW5ndGggPSBqIC0gMTsKCQl9Cgl9Owp9CgpmdW5jdGlvbiBTaXp6bGUoIHNlbGVjdG9yLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkICkgewoJdmFyIG1hdGNoLCBlbGVtLCBtLCBub2RlVHlwZSwKCQkvLyBRU0EgdmFycwoJCWksIGdyb3Vwcywgb2xkLCBuaWQsIG5ld0NvbnRleHQsIG5ld1NlbGVjdG9yOwoKCWlmICggKCBjb250ZXh0ID8gY29udGV4dC5vd25lckRvY3VtZW50IHx8IGNvbnRleHQgOiBwcmVmZXJyZWREb2MgKSAhPT0gZG9jdW1lbnQgKSB7CgkJc2V0RG9jdW1lbnQoIGNvbnRleHQgKTsKCX0KCgljb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKCXJlc3VsdHMgPSByZXN1bHRzIHx8IFtdOwoKCWlmICggIXNlbGVjdG9yIHx8IHR5cGVvZiBzZWxlY3RvciAhPT0gInN0cmluZyIgKSB7CgkJcmV0dXJuIHJlc3VsdHM7Cgl9CgoJaWYgKCAobm9kZVR5cGUgPSBjb250ZXh0Lm5vZGVUeXBlKSAhPT0gMSAmJiBub2RlVHlwZSAhPT0gOSApIHsKCQlyZXR1cm4gW107Cgl9CgoJaWYgKCBkb2N1bWVudElzSFRNTCAmJiAhc2VlZCApIHsKCgkJLy8gU2hvcnRjdXRzCgkJaWYgKCAobWF0Y2ggPSBycXVpY2tFeHByLmV4ZWMoIHNlbGVjdG9yICkpICkgewoJCQkvLyBTcGVlZC11cDogU2l6emxlKCIjSUQiKQoJCQlpZiAoIChtID0gbWF0Y2hbMV0pICkgewoJCQkJaWYgKCBub2RlVHlwZSA9PT0gOSApIHsKCQkJCQllbGVtID0gY29udGV4dC5nZXRFbGVtZW50QnlJZCggbSApOwoJCQkJCS8vIENoZWNrIHBhcmVudE5vZGUgdG8gY2F0Y2ggd2hlbiBCbGFja2JlcnJ5IDQuNiByZXR1cm5zCgkJCQkJLy8gbm9kZXMgdGhhdCBhcmUgbm8gbG9uZ2VyIGluIHRoZSBkb2N1bWVudCAoalF1ZXJ5ICM2OTYzKQoJCQkJCWlmICggZWxlbSAmJiBlbGVtLnBhcmVudE5vZGUgKSB7CgkJCQkJCS8vIEhhbmRsZSB0aGUgY2FzZSB3aGVyZSBJRSwgT3BlcmEsIGFuZCBXZWJraXQgcmV0dXJuIGl0ZW1zCgkJCQkJCS8vIGJ5IG5hbWUgaW5zdGVhZCBvZiBJRAoJCQkJCQlpZiAoIGVsZW0uaWQgPT09IG0gKSB7CgkJCQkJCQlyZXN1bHRzLnB1c2goIGVsZW0gKTsKCQkJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJCQl9CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmV0dXJuIHJlc3VsdHM7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQkvLyBDb250ZXh0IGlzIG5vdCBhIGRvY3VtZW50CgkJCQkJaWYgKCBjb250ZXh0Lm93bmVyRG9jdW1lbnQgJiYgKGVsZW0gPSBjb250ZXh0Lm93bmVyRG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIG0gKSkgJiYKCQkJCQkJY29udGFpbnMoIGNvbnRleHQsIGVsZW0gKSAmJiBlbGVtLmlkID09PSBtICkgewoJCQkJCQlyZXN1bHRzLnB1c2goIGVsZW0gKTsKCQkJCQkJcmV0dXJuIHJlc3VsdHM7CgkJCQkJfQoJCQkJfQoKCQkJLy8gU3BlZWQtdXA6IFNpenpsZSgiVEFHIikKCQkJfSBlbHNlIGlmICggbWF0Y2hbMl0gKSB7CgkJCQlwdXNoLmFwcGx5KCByZXN1bHRzLCBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCBzZWxlY3RvciApICk7CgkJCQlyZXR1cm4gcmVzdWx0czsKCgkJCS8vIFNwZWVkLXVwOiBTaXp6bGUoIi5DTEFTUyIpCgkJCX0gZWxzZSBpZiAoIChtID0gbWF0Y2hbM10pICYmIHN1cHBvcnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgKSB7CgkJCQlwdXNoLmFwcGx5KCByZXN1bHRzLCBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoIG0gKSApOwoJCQkJcmV0dXJuIHJlc3VsdHM7CgkJCX0KCQl9CgoJCS8vIFFTQSBwYXRoCgkJaWYgKCBzdXBwb3J0LnFzYSAmJiAoIXJidWdneVFTQSB8fCAhcmJ1Z2d5UVNBLnRlc3QoIHNlbGVjdG9yICkpICkgewoJCQluaWQgPSBvbGQgPSBleHBhbmRvOwoJCQluZXdDb250ZXh0ID0gY29udGV4dDsKCQkJbmV3U2VsZWN0b3IgPSBub2RlVHlwZSA9PT0gOSAmJiBzZWxlY3RvcjsKCgkJCS8vIHFTQSB3b3JrcyBzdHJhbmdlbHkgb24gRWxlbWVudC1yb290ZWQgcXVlcmllcwoJCQkvLyBXZSBjYW4gd29yayBhcm91bmQgdGhpcyBieSBzcGVjaWZ5aW5nIGFuIGV4dHJhIElEIG9uIHRoZSByb290CgkJCS8vIGFuZCB3b3JraW5nIHVwIGZyb20gdGhlcmUgKFRoYW5rcyB0byBBbmRyZXcgRHVwb250IGZvciB0aGUgdGVjaG5pcXVlKQoJCQkvLyBJRSA4IGRvZXNuJ3Qgd29yayBvbiBvYmplY3QgZWxlbWVudHMKCQkJaWYgKCBub2RlVHlwZSA9PT0gMSAmJiBjb250ZXh0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICJvYmplY3QiICkgewoJCQkJZ3JvdXBzID0gdG9rZW5pemUoIHNlbGVjdG9yICk7CgoJCQkJaWYgKCAob2xkID0gY29udGV4dC5nZXRBdHRyaWJ1dGUoImlkIikpICkgewoJCQkJCW5pZCA9IG9sZC5yZXBsYWNlKCByZXNjYXBlLCAiXFwkJiIgKTsKCQkJCX0gZWxzZSB7CgkJCQkJY29udGV4dC5zZXRBdHRyaWJ1dGUoICJpZCIsIG5pZCApOwoJCQkJfQoJCQkJbmlkID0gIltpZD0nIiArIG5pZCArICInXSAiOwoKCQkJCWkgPSBncm91cHMubGVuZ3RoOwoJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJZ3JvdXBzW2ldID0gbmlkICsgdG9TZWxlY3RvciggZ3JvdXBzW2ldICk7CgkJCQl9CgkJCQluZXdDb250ZXh0ID0gcnNpYmxpbmcudGVzdCggc2VsZWN0b3IgKSAmJiB0ZXN0Q29udGV4dCggY29udGV4dC5wYXJlbnROb2RlICkgfHwgY29udGV4dDsKCQkJCW5ld1NlbGVjdG9yID0gZ3JvdXBzLmpvaW4oIiwiKTsKCQkJfQoKCQkJaWYgKCBuZXdTZWxlY3RvciApIHsKCQkJCXRyeSB7CgkJCQkJcHVzaC5hcHBseSggcmVzdWx0cywKCQkJCQkJbmV3Q29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKCBuZXdTZWxlY3RvciApCgkJCQkJKTsKCQkJCQlyZXR1cm4gcmVzdWx0czsKCQkJCX0gY2F0Y2gocXNhRXJyb3IpIHsKCQkJCX0gZmluYWxseSB7CgkJCQkJaWYgKCAhb2xkICkgewoJCQkJCQljb250ZXh0LnJlbW92ZUF0dHJpYnV0ZSgiaWQiKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9Cgl9CgoJLy8gQWxsIG90aGVycwoJcmV0dXJuIHNlbGVjdCggc2VsZWN0b3IucmVwbGFjZSggcnRyaW0sICIkMSIgKSwgY29udGV4dCwgcmVzdWx0cywgc2VlZCApOwp9CgovKioKICogQ3JlYXRlIGtleS12YWx1ZSBjYWNoZXMgb2YgbGltaXRlZCBzaXplCiAqIEByZXR1cm5zIHtGdW5jdGlvbihzdHJpbmcsIE9iamVjdCl9IFJldHVybnMgdGhlIE9iamVjdCBkYXRhIGFmdGVyIHN0b3JpbmcgaXQgb24gaXRzZWxmIHdpdGgKICoJcHJvcGVydHkgbmFtZSB0aGUgKHNwYWNlLXN1ZmZpeGVkKSBzdHJpbmcgYW5kIChpZiB0aGUgY2FjaGUgaXMgbGFyZ2VyIHRoYW4gRXhwci5jYWNoZUxlbmd0aCkKICoJZGVsZXRpbmcgdGhlIG9sZGVzdCBlbnRyeQogKi8KZnVuY3Rpb24gY3JlYXRlQ2FjaGUoKSB7Cgl2YXIga2V5cyA9IFtdOwoKCWZ1bmN0aW9uIGNhY2hlKCBrZXksIHZhbHVlICkgewoJCS8vIFVzZSAoa2V5ICsgIiAiKSB0byBhdm9pZCBjb2xsaXNpb24gd2l0aCBuYXRpdmUgcHJvdG90eXBlIHByb3BlcnRpZXMgKHNlZSBJc3N1ZSAjMTU3KQoJCWlmICgga2V5cy5wdXNoKCBrZXkgKyAiICIgKSA+IEV4cHIuY2FjaGVMZW5ndGggKSB7CgkJCS8vIE9ubHkga2VlcCB0aGUgbW9zdCByZWNlbnQgZW50cmllcwoJCQlkZWxldGUgY2FjaGVbIGtleXMuc2hpZnQoKSBdOwoJCX0KCQlyZXR1cm4gKGNhY2hlWyBrZXkgKyAiICIgXSA9IHZhbHVlKTsKCX0KCXJldHVybiBjYWNoZTsKfQoKLyoqCiAqIE1hcmsgYSBmdW5jdGlvbiBmb3Igc3BlY2lhbCB1c2UgYnkgU2l6emxlCiAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFRoZSBmdW5jdGlvbiB0byBtYXJrCiAqLwpmdW5jdGlvbiBtYXJrRnVuY3Rpb24oIGZuICkgewoJZm5bIGV4cGFuZG8gXSA9IHRydWU7CglyZXR1cm4gZm47Cn0KCi8qKgogKiBTdXBwb3J0IHRlc3RpbmcgdXNpbmcgYW4gZWxlbWVudAogKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBQYXNzZWQgdGhlIGNyZWF0ZWQgZGl2IGFuZCBleHBlY3RzIGEgYm9vbGVhbiByZXN1bHQKICovCmZ1bmN0aW9uIGFzc2VydCggZm4gKSB7Cgl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CgoJdHJ5IHsKCQlyZXR1cm4gISFmbiggZGl2ICk7Cgl9IGNhdGNoIChlKSB7CgkJcmV0dXJuIGZhbHNlOwoJfSBmaW5hbGx5IHsKCQkvLyBSZW1vdmUgZnJvbSBpdHMgcGFyZW50IGJ5IGRlZmF1bHQKCQlpZiAoIGRpdi5wYXJlbnROb2RlICkgewoJCQlkaXYucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggZGl2ICk7CgkJfQoJCS8vIHJlbGVhc2UgbWVtb3J5IGluIElFCgkJZGl2ID0gbnVsbDsKCX0KfQoKLyoqCiAqIEFkZHMgdGhlIHNhbWUgaGFuZGxlciBmb3IgYWxsIG9mIHRoZSBzcGVjaWZpZWQgYXR0cnMKICogQHBhcmFtIHtTdHJpbmd9IGF0dHJzIFBpcGUtc2VwYXJhdGVkIGxpc3Qgb2YgYXR0cmlidXRlcwogKiBAcGFyYW0ge0Z1bmN0aW9ufSBoYW5kbGVyIFRoZSBtZXRob2QgdGhhdCB3aWxsIGJlIGFwcGxpZWQKICovCmZ1bmN0aW9uIGFkZEhhbmRsZSggYXR0cnMsIGhhbmRsZXIgKSB7Cgl2YXIgYXJyID0gYXR0cnMuc3BsaXQoInwiKSwKCQlpID0gYXR0cnMubGVuZ3RoOwoKCXdoaWxlICggaS0tICkgewoJCUV4cHIuYXR0ckhhbmRsZVsgYXJyW2ldIF0gPSBoYW5kbGVyOwoJfQp9CgovKioKICogQ2hlY2tzIGRvY3VtZW50IG9yZGVyIG9mIHR3byBzaWJsaW5ncwogKiBAcGFyYW0ge0VsZW1lbnR9IGEKICogQHBhcmFtIHtFbGVtZW50fSBiCiAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgbGVzcyB0aGFuIDAgaWYgYSBwcmVjZWRlcyBiLCBncmVhdGVyIHRoYW4gMCBpZiBhIGZvbGxvd3MgYgogKi8KZnVuY3Rpb24gc2libGluZ0NoZWNrKCBhLCBiICkgewoJdmFyIGN1ciA9IGIgJiYgYSwKCQlkaWZmID0gY3VyICYmIGEubm9kZVR5cGUgPT09IDEgJiYgYi5ub2RlVHlwZSA9PT0gMSAmJgoJCQkoIH5iLnNvdXJjZUluZGV4IHx8IE1BWF9ORUdBVElWRSApIC0KCQkJKCB+YS5zb3VyY2VJbmRleCB8fCBNQVhfTkVHQVRJVkUgKTsKCgkvLyBVc2UgSUUgc291cmNlSW5kZXggaWYgYXZhaWxhYmxlIG9uIGJvdGggbm9kZXMKCWlmICggZGlmZiApIHsKCQlyZXR1cm4gZGlmZjsKCX0KCgkvLyBDaGVjayBpZiBiIGZvbGxvd3MgYQoJaWYgKCBjdXIgKSB7CgkJd2hpbGUgKCAoY3VyID0gY3VyLm5leHRTaWJsaW5nKSApIHsKCQkJaWYgKCBjdXIgPT09IGIgKSB7CgkJCQlyZXR1cm4gLTE7CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIGEgPyAxIDogLTE7Cn0KCi8qKgogKiBSZXR1cm5zIGEgZnVuY3Rpb24gdG8gdXNlIGluIHBzZXVkb3MgZm9yIGlucHV0IHR5cGVzCiAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlCiAqLwpmdW5jdGlvbiBjcmVhdGVJbnB1dFBzZXVkbyggdHlwZSApIHsKCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQl2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCQlyZXR1cm4gbmFtZSA9PT0gImlucHV0IiAmJiBlbGVtLnR5cGUgPT09IHR5cGU7Cgl9Owp9CgovKioKICogUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBidXR0b25zCiAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlCiAqLwpmdW5jdGlvbiBjcmVhdGVCdXR0b25Qc2V1ZG8oIHR5cGUgKSB7CglyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyIG5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgkJcmV0dXJuIChuYW1lID09PSAiaW5wdXQiIHx8IG5hbWUgPT09ICJidXR0b24iKSAmJiBlbGVtLnR5cGUgPT09IHR5cGU7Cgl9Owp9CgovKioKICogUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBwb3NpdGlvbmFscwogKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbgogKi8KZnVuY3Rpb24gY3JlYXRlUG9zaXRpb25hbFBzZXVkbyggZm4gKSB7CglyZXR1cm4gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uKCBhcmd1bWVudCApIHsKCQlhcmd1bWVudCA9ICthcmd1bWVudDsKCQlyZXR1cm4gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uKCBzZWVkLCBtYXRjaGVzICkgewoJCQl2YXIgaiwKCQkJCW1hdGNoSW5kZXhlcyA9IGZuKCBbXSwgc2VlZC5sZW5ndGgsIGFyZ3VtZW50ICksCgkJCQlpID0gbWF0Y2hJbmRleGVzLmxlbmd0aDsKCgkJCS8vIE1hdGNoIGVsZW1lbnRzIGZvdW5kIGF0IHRoZSBzcGVjaWZpZWQgaW5kZXhlcwoJCQl3aGlsZSAoIGktLSApIHsKCQkJCWlmICggc2VlZFsgKGogPSBtYXRjaEluZGV4ZXNbaV0pIF0gKSB7CgkJCQkJc2VlZFtqXSA9ICEobWF0Y2hlc1tqXSA9IHNlZWRbal0pOwoJCQkJfQoJCQl9CgkJfSk7Cgl9KTsKfQoKLyoqCiAqIENoZWNrcyBhIG5vZGUgZm9yIHZhbGlkaXR5IGFzIGEgU2l6emxlIGNvbnRleHQKICogQHBhcmFtIHtFbGVtZW50fE9iamVjdD19IGNvbnRleHQKICogQHJldHVybnMge0VsZW1lbnR8T2JqZWN0fEJvb2xlYW59IFRoZSBpbnB1dCBub2RlIGlmIGFjY2VwdGFibGUsIG90aGVyd2lzZSBhIGZhbHN5IHZhbHVlCiAqLwpmdW5jdGlvbiB0ZXN0Q29udGV4dCggY29udGV4dCApIHsKCXJldHVybiBjb250ZXh0ICYmIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lICE9PSBzdHJ1bmRlZmluZWQgJiYgY29udGV4dDsKfQoKLy8gRXhwb3NlIHN1cHBvcnQgdmFycyBmb3IgY29udmVuaWVuY2UKc3VwcG9ydCA9IFNpenpsZS5zdXBwb3J0ID0ge307CgovKioKICogRGV0ZWN0cyBYTUwgbm9kZXMKICogQHBhcmFtIHtFbGVtZW50fE9iamVjdH0gZWxlbSBBbiBlbGVtZW50IG9yIGEgZG9jdW1lbnQKICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWZmIGVsZW0gaXMgYSBub24tSFRNTCBYTUwgbm9kZQogKi8KaXNYTUwgPSBTaXp6bGUuaXNYTUwgPSBmdW5jdGlvbiggZWxlbSApIHsKCS8vIGRvY3VtZW50RWxlbWVudCBpcyB2ZXJpZmllZCBmb3IgY2FzZXMgd2hlcmUgaXQgZG9lc24ndCB5ZXQgZXhpc3QKCS8vIChzdWNoIGFzIGxvYWRpbmcgaWZyYW1lcyBpbiBJRSAtICM0ODMzKQoJdmFyIGRvY3VtZW50RWxlbWVudCA9IGVsZW0gJiYgKGVsZW0ub3duZXJEb2N1bWVudCB8fCBlbGVtKS5kb2N1bWVudEVsZW1lbnQ7CglyZXR1cm4gZG9jdW1lbnRFbGVtZW50ID8gZG9jdW1lbnRFbGVtZW50Lm5vZGVOYW1lICE9PSAiSFRNTCIgOiBmYWxzZTsKfTsKCi8qKgogKiBTZXRzIGRvY3VtZW50LXJlbGF0ZWQgdmFyaWFibGVzIG9uY2UgYmFzZWQgb24gdGhlIGN1cnJlbnQgZG9jdW1lbnQKICogQHBhcmFtIHtFbGVtZW50fE9iamVjdH0gW2RvY10gQW4gZWxlbWVudCBvciBkb2N1bWVudCBvYmplY3QgdG8gdXNlIHRvIHNldCB0aGUgZG9jdW1lbnQKICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgY3VycmVudCBkb2N1bWVudAogKi8Kc2V0RG9jdW1lbnQgPSBTaXp6bGUuc2V0RG9jdW1lbnQgPSBmdW5jdGlvbiggbm9kZSApIHsKCXZhciBoYXNDb21wYXJlLAoJCWRvYyA9IG5vZGUgPyBub2RlLm93bmVyRG9jdW1lbnQgfHwgbm9kZSA6IHByZWZlcnJlZERvYywKCQlwYXJlbnQgPSBkb2MuZGVmYXVsdFZpZXc7CgoJLy8gSWYgbm8gZG9jdW1lbnQgYW5kIGRvY3VtZW50RWxlbWVudCBpcyBhdmFpbGFibGUsIHJldHVybgoJaWYgKCBkb2MgPT09IGRvY3VtZW50IHx8IGRvYy5ub2RlVHlwZSAhPT0gOSB8fCAhZG9jLmRvY3VtZW50RWxlbWVudCApIHsKCQlyZXR1cm4gZG9jdW1lbnQ7Cgl9CgoJLy8gU2V0IG91ciBkb2N1bWVudAoJZG9jdW1lbnQgPSBkb2M7Cglkb2NFbGVtID0gZG9jLmRvY3VtZW50RWxlbWVudDsKCgkvLyBTdXBwb3J0IHRlc3RzCglkb2N1bWVudElzSFRNTCA9ICFpc1hNTCggZG9jICk7CgoJLy8gU3VwcG9ydDogSUU+OAoJLy8gSWYgaWZyYW1lIGRvY3VtZW50IGlzIGFzc2lnbmVkIHRvICJkb2N1bWVudCIgdmFyaWFibGUgYW5kIGlmIGlmcmFtZSBoYXMgYmVlbiByZWxvYWRlZCwKCS8vIElFIHdpbGwgdGhyb3cgInBlcm1pc3Npb24gZGVuaWVkIiBlcnJvciB3aGVuIGFjY2Vzc2luZyAiZG9jdW1lbnQiIHZhcmlhYmxlLCBzZWUgalF1ZXJ5ICMxMzkzNgoJLy8gSUU2LTggZG8gbm90IHN1cHBvcnQgdGhlIGRlZmF1bHRWaWV3IHByb3BlcnR5IHNvIHBhcmVudCB3aWxsIGJlIHVuZGVmaW5lZAoJaWYgKCBwYXJlbnQgJiYgcGFyZW50ICE9PSBwYXJlbnQudG9wICkgewoJCS8vIElFMTEgZG9lcyBub3QgaGF2ZSBhdHRhY2hFdmVudCwgc28gYWxsIG11c3Qgc3VmZmVyCgkJaWYgKCBwYXJlbnQuYWRkRXZlbnRMaXN0ZW5lciApIHsKCQkJcGFyZW50LmFkZEV2ZW50TGlzdGVuZXIoICJ1bmxvYWQiLCBmdW5jdGlvbigpIHsKCQkJCXNldERvY3VtZW50KCk7CgkJCX0sIGZhbHNlICk7CgkJfSBlbHNlIGlmICggcGFyZW50LmF0dGFjaEV2ZW50ICkgewoJCQlwYXJlbnQuYXR0YWNoRXZlbnQoICJvbnVubG9hZCIsIGZ1bmN0aW9uKCkgewoJCQkJc2V0RG9jdW1lbnQoKTsKCQkJfSk7CgkJfQoJfQoKCS8qIEF0dHJpYnV0ZXMKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KCgkvLyBTdXBwb3J0OiBJRTw4CgkvLyBWZXJpZnkgdGhhdCBnZXRBdHRyaWJ1dGUgcmVhbGx5IHJldHVybnMgYXR0cmlidXRlcyBhbmQgbm90IHByb3BlcnRpZXMgKGV4Y2VwdGluZyBJRTggYm9vbGVhbnMpCglzdXBwb3J0LmF0dHJpYnV0ZXMgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQlkaXYuY2xhc3NOYW1lID0gImkiOwoJCXJldHVybiAhZGl2LmdldEF0dHJpYnV0ZSgiY2xhc3NOYW1lIik7Cgl9KTsKCgkvKiBnZXRFbGVtZW50KHMpQnkqCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCgoJLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSByZXR1cm5zIG9ubHkgZWxlbWVudHMKCXN1cHBvcnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQlkaXYuYXBwZW5kQ2hpbGQoIGRvYy5jcmVhdGVDb21tZW50KCIiKSApOwoJCXJldHVybiAhZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikubGVuZ3RoOwoJfSk7CgoJLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBjYW4gYmUgdHJ1c3RlZAoJc3VwcG9ydC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lID0gcm5hdGl2ZS50ZXN0KCBkb2MuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSApICYmIGFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJCWRpdi5pbm5lckhUTUwgPSAiPGRpdiBjbGFzcz0nYSc+PC9kaXY+PGRpdiBjbGFzcz0nYSBpJz48L2Rpdj4iOwoKCQkvLyBTdXBwb3J0OiBTYWZhcmk8NAoJCS8vIENhdGNoIGNsYXNzIG92ZXItY2FjaGluZwoJCWRpdi5maXJzdENoaWxkLmNsYXNzTmFtZSA9ICJpIjsKCQkvLyBTdXBwb3J0OiBPcGVyYTwxMAoJCS8vIENhdGNoIGdFQkNOIGZhaWx1cmUgdG8gZmluZCBub24tbGVhZGluZyBjbGFzc2VzCgkJcmV0dXJuIGRpdi5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCJpIikubGVuZ3RoID09PSAyOwoJfSk7CgoJLy8gU3VwcG9ydDogSUU8MTAKCS8vIENoZWNrIGlmIGdldEVsZW1lbnRCeUlkIHJldHVybnMgZWxlbWVudHMgYnkgbmFtZQoJLy8gVGhlIGJyb2tlbiBnZXRFbGVtZW50QnlJZCBtZXRob2RzIGRvbid0IHBpY2sgdXAgcHJvZ3JhbWF0aWNhbGx5LXNldCBuYW1lcywKCS8vIHNvIHVzZSBhIHJvdW5kYWJvdXQgZ2V0RWxlbWVudHNCeU5hbWUgdGVzdAoJc3VwcG9ydC5nZXRCeUlkID0gYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CgkJZG9jRWxlbS5hcHBlbmRDaGlsZCggZGl2ICkuaWQgPSBleHBhbmRvOwoJCXJldHVybiAhZG9jLmdldEVsZW1lbnRzQnlOYW1lIHx8ICFkb2MuZ2V0RWxlbWVudHNCeU5hbWUoIGV4cGFuZG8gKS5sZW5ndGg7Cgl9KTsKCgkvLyBJRCBmaW5kIGFuZCBmaWx0ZXIKCWlmICggc3VwcG9ydC5nZXRCeUlkICkgewoJCUV4cHIuZmluZFsiSUQiXSA9IGZ1bmN0aW9uKCBpZCwgY29udGV4dCApIHsKCQkJaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50QnlJZCAhPT0gc3RydW5kZWZpbmVkICYmIGRvY3VtZW50SXNIVE1MICkgewoJCQkJdmFyIG0gPSBjb250ZXh0LmdldEVsZW1lbnRCeUlkKCBpZCApOwoJCQkJLy8gQ2hlY2sgcGFyZW50Tm9kZSB0byBjYXRjaCB3aGVuIEJsYWNrYmVycnkgNC42IHJldHVybnMKCQkJCS8vIG5vZGVzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgZG9jdW1lbnQgIzY5NjMKCQkJCXJldHVybiBtICYmIG0ucGFyZW50Tm9kZSA/IFttXSA6IFtdOwoJCQl9CgkJfTsKCQlFeHByLmZpbHRlclsiSUQiXSA9IGZ1bmN0aW9uKCBpZCApIHsKCQkJdmFyIGF0dHJJZCA9IGlkLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICk7CgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSgiaWQiKSA9PT0gYXR0cklkOwoJCQl9OwoJCX07Cgl9IGVsc2UgewoJCS8vIFN1cHBvcnQ6IElFNi83CgkJLy8gZ2V0RWxlbWVudEJ5SWQgaXMgbm90IHJlbGlhYmxlIGFzIGEgZmluZCBzaG9ydGN1dAoJCWRlbGV0ZSBFeHByLmZpbmRbIklEIl07CgoJCUV4cHIuZmlsdGVyWyJJRCJdID0gIGZ1bmN0aW9uKCBpZCApIHsKCQkJdmFyIGF0dHJJZCA9IGlkLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICk7CgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXZhciBub2RlID0gdHlwZW9mIGVsZW0uZ2V0QXR0cmlidXRlTm9kZSAhPT0gc3RydW5kZWZpbmVkICYmIGVsZW0uZ2V0QXR0cmlidXRlTm9kZSgiaWQiKTsKCQkJCXJldHVybiBub2RlICYmIG5vZGUudmFsdWUgPT09IGF0dHJJZDsKCQkJfTsKCQl9OwoJfQoKCS8vIFRhZwoJRXhwci5maW5kWyJUQUciXSA9IHN1cHBvcnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgPwoJCWZ1bmN0aW9uKCB0YWcsIGNvbnRleHQgKSB7CgkJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09IHN0cnVuZGVmaW5lZCApIHsKCQkJCXJldHVybiBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCB0YWcgKTsKCQkJfQoJCX0gOgoJCWZ1bmN0aW9uKCB0YWcsIGNvbnRleHQgKSB7CgkJCXZhciBlbGVtLAoJCQkJdG1wID0gW10sCgkJCQlpID0gMCwKCQkJCXJlc3VsdHMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCB0YWcgKTsKCgkJCS8vIEZpbHRlciBvdXQgcG9zc2libGUgY29tbWVudHMKCQkJaWYgKCB0YWcgPT09ICIqIiApIHsKCQkJCXdoaWxlICggKGVsZW0gPSByZXN1bHRzW2krK10pICkgewoJCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCQkJdG1wLnB1c2goIGVsZW0gKTsKCQkJCQl9CgkJCQl9CgoJCQkJcmV0dXJuIHRtcDsKCQkJfQoJCQlyZXR1cm4gcmVzdWx0czsKCQl9OwoKCS8vIENsYXNzCglFeHByLmZpbmRbIkNMQVNTIl0gPSBzdXBwb3J0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgJiYgZnVuY3Rpb24oIGNsYXNzTmFtZSwgY29udGV4dCApIHsKCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgIT09IHN0cnVuZGVmaW5lZCAmJiBkb2N1bWVudElzSFRNTCApIHsKCQkJcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSggY2xhc3NOYW1lICk7CgkJfQoJfTsKCgkvKiBRU0EvbWF0Y2hlc1NlbGVjdG9yCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCgoJLy8gUVNBIGFuZCBtYXRjaGVzU2VsZWN0b3Igc3VwcG9ydAoKCS8vIG1hdGNoZXNTZWxlY3Rvcig6YWN0aXZlKSByZXBvcnRzIGZhbHNlIHdoZW4gdHJ1ZSAoSUU5L09wZXJhIDExLjUpCglyYnVnZ3lNYXRjaGVzID0gW107CgoJLy8gcVNhKDpmb2N1cykgcmVwb3J0cyBmYWxzZSB3aGVuIHRydWUgKENocm9tZSAyMSkKCS8vIFdlIGFsbG93IHRoaXMgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBJRTgvOSB0aGF0IHRocm93cyBhbiBlcnJvcgoJLy8gd2hlbmV2ZXIgYGRvY3VtZW50LmFjdGl2ZUVsZW1lbnRgIGlzIGFjY2Vzc2VkIG9uIGFuIGlmcmFtZQoJLy8gU28sIHdlIGFsbG93IDpmb2N1cyB0byBwYXNzIHRocm91Z2ggUVNBIGFsbCB0aGUgdGltZSB0byBhdm9pZCB0aGUgSUUgZXJyb3IKCS8vIFNlZSBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMzM3OAoJcmJ1Z2d5UVNBID0gW107CgoJaWYgKCAoc3VwcG9ydC5xc2EgPSBybmF0aXZlLnRlc3QoIGRvYy5xdWVyeVNlbGVjdG9yQWxsICkpICkgewoJCS8vIEJ1aWxkIFFTQSByZWdleAoJCS8vIFJlZ2V4IHN0cmF0ZWd5IGFkb3B0ZWQgZnJvbSBEaWVnbyBQZXJpbmkKCQlhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQkJLy8gU2VsZWN0IGlzIHNldCB0byBlbXB0eSBzdHJpbmcgb24gcHVycG9zZQoJCQkvLyBUaGlzIGlzIHRvIHRlc3QgSUUncyB0cmVhdG1lbnQgb2Ygbm90IGV4cGxpY2l0bHkKCQkJLy8gc2V0dGluZyBhIGJvb2xlYW4gY29udGVudCBhdHRyaWJ1dGUsCgkJCS8vIHNpbmNlIGl0cyBwcmVzZW5jZSBzaG91bGQgYmUgZW5vdWdoCgkJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzEyMzU5CgkJCWRpdi5pbm5lckhUTUwgPSAiPHNlbGVjdCB0PScnPjxvcHRpb24gc2VsZWN0ZWQ9Jyc+PC9vcHRpb24+PC9zZWxlY3Q+IjsKCgkJCS8vIFN1cHBvcnQ6IElFOCwgT3BlcmEgMTAtMTIKCQkJLy8gTm90aGluZyBzaG91bGQgYmUgc2VsZWN0ZWQgd2hlbiBlbXB0eSBzdHJpbmdzIGZvbGxvdyBePSBvciAkPSBvciAqPQoJCQlpZiAoIGRpdi5xdWVyeVNlbGVjdG9yQWxsKCJbdF49JyddIikubGVuZ3RoICkgewoJCQkJcmJ1Z2d5UVNBLnB1c2goICJbKl4kXT0iICsgd2hpdGVzcGFjZSArICIqKD86Jyd8XCJcIikiICk7CgkJCX0KCgkJCS8vIFN1cHBvcnQ6IElFOAoJCQkvLyBCb29sZWFuIGF0dHJpYnV0ZXMgYW5kICJ2YWx1ZSIgYXJlIG5vdCB0cmVhdGVkIGNvcnJlY3RseQoJCQlpZiAoICFkaXYucXVlcnlTZWxlY3RvckFsbCgiW3NlbGVjdGVkXSIpLmxlbmd0aCApIHsKCQkJCXJidWdneVFTQS5wdXNoKCAiXFxbIiArIHdoaXRlc3BhY2UgKyAiKig/OnZhbHVlfCIgKyBib29sZWFucyArICIpIiApOwoJCQl9CgoJCQkvLyBXZWJraXQvT3BlcmEgLSA6Y2hlY2tlZCBzaG91bGQgcmV0dXJuIHNlbGVjdGVkIG9wdGlvbiBlbGVtZW50cwoJCQkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi8yMDExL1JFQy1jc3MzLXNlbGVjdG9ycy0yMDExMDkyOS8jY2hlY2tlZAoJCQkvLyBJRTggdGhyb3dzIGVycm9yIGhlcmUgYW5kIHdpbGwgbm90IHNlZSBsYXRlciB0ZXN0cwoJCQlpZiAoICFkaXYucXVlcnlTZWxlY3RvckFsbCgiOmNoZWNrZWQiKS5sZW5ndGggKSB7CgkJCQlyYnVnZ3lRU0EucHVzaCgiOmNoZWNrZWQiKTsKCQkJfQoJCX0pOwoKCQlhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQkJLy8gU3VwcG9ydDogV2luZG93cyA4IE5hdGl2ZSBBcHBzCgkJCS8vIFRoZSB0eXBlIGFuZCBuYW1lIGF0dHJpYnV0ZXMgYXJlIHJlc3RyaWN0ZWQgZHVyaW5nIC5pbm5lckhUTUwgYXNzaWdubWVudAoJCQl2YXIgaW5wdXQgPSBkb2MuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKCQkJaW5wdXQuc2V0QXR0cmlidXRlKCAidHlwZSIsICJoaWRkZW4iICk7CgkJCWRpdi5hcHBlbmRDaGlsZCggaW5wdXQgKS5zZXRBdHRyaWJ1dGUoICJuYW1lIiwgIkQiICk7CgoJCQkvLyBTdXBwb3J0OiBJRTgKCQkJLy8gRW5mb3JjZSBjYXNlLXNlbnNpdGl2aXR5IG9mIG5hbWUgYXR0cmlidXRlCgkJCWlmICggZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoIltuYW1lPWRdIikubGVuZ3RoICkgewoJCQkJcmJ1Z2d5UVNBLnB1c2goICJuYW1lIiArIHdoaXRlc3BhY2UgKyAiKlsqXiR8IX5dPz0iICk7CgkJCX0KCgkJCS8vIEZGIDMuNSAtIDplbmFibGVkLzpkaXNhYmxlZCBhbmQgaGlkZGVuIGVsZW1lbnRzIChoaWRkZW4gZWxlbWVudHMgYXJlIHN0aWxsIGVuYWJsZWQpCgkJCS8vIElFOCB0aHJvd3MgZXJyb3IgaGVyZSBhbmQgd2lsbCBub3Qgc2VlIGxhdGVyIHRlc3RzCgkJCWlmICggIWRpdi5xdWVyeVNlbGVjdG9yQWxsKCI6ZW5hYmxlZCIpLmxlbmd0aCApIHsKCQkJCXJidWdneVFTQS5wdXNoKCAiOmVuYWJsZWQiLCAiOmRpc2FibGVkIiApOwoJCQl9CgoJCQkvLyBPcGVyYSAxMC0xMSBkb2VzIG5vdCB0aHJvdyBvbiBwb3N0LWNvbW1hIGludmFsaWQgcHNldWRvcwoJCQlkaXYucXVlcnlTZWxlY3RvckFsbCgiKiw6eCIpOwoJCQlyYnVnZ3lRU0EucHVzaCgiLC4qOiIpOwoJCX0pOwoJfQoKCWlmICggKHN1cHBvcnQubWF0Y2hlc1NlbGVjdG9yID0gcm5hdGl2ZS50ZXN0KCAobWF0Y2hlcyA9IGRvY0VsZW0ud2Via2l0TWF0Y2hlc1NlbGVjdG9yIHx8CgkJZG9jRWxlbS5tb3pNYXRjaGVzU2VsZWN0b3IgfHwKCQlkb2NFbGVtLm9NYXRjaGVzU2VsZWN0b3IgfHwKCQlkb2NFbGVtLm1zTWF0Y2hlc1NlbGVjdG9yKSApKSApIHsKCgkJYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CgkJCS8vIENoZWNrIHRvIHNlZSBpZiBpdCdzIHBvc3NpYmxlIHRvIGRvIG1hdGNoZXNTZWxlY3RvcgoJCQkvLyBvbiBhIGRpc2Nvbm5lY3RlZCBub2RlIChJRSA5KQoJCQlzdXBwb3J0LmRpc2Nvbm5lY3RlZE1hdGNoID0gbWF0Y2hlcy5jYWxsKCBkaXYsICJkaXYiICk7CgoJCQkvLyBUaGlzIHNob3VsZCBmYWlsIHdpdGggYW4gZXhjZXB0aW9uCgkJCS8vIEdlY2tvIGRvZXMgbm90IGVycm9yLCByZXR1cm5zIGZhbHNlIGluc3RlYWQKCQkJbWF0Y2hlcy5jYWxsKCBkaXYsICJbcyE9JyddOngiICk7CgkJCXJidWdneU1hdGNoZXMucHVzaCggIiE9IiwgcHNldWRvcyApOwoJCX0pOwoJfQoKCXJidWdneVFTQSA9IHJidWdneVFTQS5sZW5ndGggJiYgbmV3IFJlZ0V4cCggcmJ1Z2d5UVNBLmpvaW4oInwiKSApOwoJcmJ1Z2d5TWF0Y2hlcyA9IHJidWdneU1hdGNoZXMubGVuZ3RoICYmIG5ldyBSZWdFeHAoIHJidWdneU1hdGNoZXMuam9pbigifCIpICk7CgoJLyogQ29udGFpbnMKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KCWhhc0NvbXBhcmUgPSBybmF0aXZlLnRlc3QoIGRvY0VsZW0uY29tcGFyZURvY3VtZW50UG9zaXRpb24gKTsKCgkvLyBFbGVtZW50IGNvbnRhaW5zIGFub3RoZXIKCS8vIFB1cnBvc2VmdWxseSBkb2VzIG5vdCBpbXBsZW1lbnQgaW5jbHVzaXZlIGRlc2NlbmRlbnQKCS8vIEFzIGluLCBhbiBlbGVtZW50IGRvZXMgbm90IGNvbnRhaW4gaXRzZWxmCgljb250YWlucyA9IGhhc0NvbXBhcmUgfHwgcm5hdGl2ZS50ZXN0KCBkb2NFbGVtLmNvbnRhaW5zICkgPwoJCWZ1bmN0aW9uKCBhLCBiICkgewoJCQl2YXIgYWRvd24gPSBhLm5vZGVUeXBlID09PSA5ID8gYS5kb2N1bWVudEVsZW1lbnQgOiBhLAoJCQkJYnVwID0gYiAmJiBiLnBhcmVudE5vZGU7CgkJCXJldHVybiBhID09PSBidXAgfHwgISEoIGJ1cCAmJiBidXAubm9kZVR5cGUgPT09IDEgJiYgKAoJCQkJYWRvd24uY29udGFpbnMgPwoJCQkJCWFkb3duLmNvbnRhaW5zKCBidXAgKSA6CgkJCQkJYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiAmJiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKCBidXAgKSAmIDE2CgkJCSkpOwoJCX0gOgoJCWZ1bmN0aW9uKCBhLCBiICkgewoJCQlpZiAoIGIgKSB7CgkJCQl3aGlsZSAoIChiID0gYi5wYXJlbnROb2RlKSApIHsKCQkJCQlpZiAoIGIgPT09IGEgKSB7CgkJCQkJCXJldHVybiB0cnVlOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQlyZXR1cm4gZmFsc2U7CgkJfTsKCgkvKiBTb3J0aW5nCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCgoJLy8gRG9jdW1lbnQgb3JkZXIgc29ydGluZwoJc29ydE9yZGVyID0gaGFzQ29tcGFyZSA/CglmdW5jdGlvbiggYSwgYiApIHsKCgkJLy8gRmxhZyBmb3IgZHVwbGljYXRlIHJlbW92YWwKCQlpZiAoIGEgPT09IGIgKSB7CgkJCWhhc0R1cGxpY2F0ZSA9IHRydWU7CgkJCXJldHVybiAwOwoJCX0KCgkJLy8gU29ydCBvbiBtZXRob2QgZXhpc3RlbmNlIGlmIG9ubHkgb25lIGlucHV0IGhhcyBjb21wYXJlRG9jdW1lbnRQb3NpdGlvbgoJCXZhciBjb21wYXJlID0gIWEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gLSAhYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbjsKCQlpZiAoIGNvbXBhcmUgKSB7CgkJCXJldHVybiBjb21wYXJlOwoJCX0KCgkJLy8gQ2FsY3VsYXRlIHBvc2l0aW9uIGlmIGJvdGggaW5wdXRzIGJlbG9uZyB0byB0aGUgc2FtZSBkb2N1bWVudAoJCWNvbXBhcmUgPSAoIGEub3duZXJEb2N1bWVudCB8fCBhICkgPT09ICggYi5vd25lckRvY3VtZW50IHx8IGIgKSA/CgkJCWEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oIGIgKSA6CgoJCQkvLyBPdGhlcndpc2Ugd2Uga25vdyB0aGV5IGFyZSBkaXNjb25uZWN0ZWQKCQkJMTsKCgkJLy8gRGlzY29ubmVjdGVkIG5vZGVzCgkJaWYgKCBjb21wYXJlICYgMSB8fAoJCQkoIXN1cHBvcnQuc29ydERldGFjaGVkICYmIGIuY29tcGFyZURvY3VtZW50UG9zaXRpb24oIGEgKSA9PT0gY29tcGFyZSkgKSB7CgoJCQkvLyBDaG9vc2UgdGhlIGZpcnN0IGVsZW1lbnQgdGhhdCBpcyByZWxhdGVkIHRvIG91ciBwcmVmZXJyZWQgZG9jdW1lbnQKCQkJaWYgKCBhID09PSBkb2MgfHwgYS5vd25lckRvY3VtZW50ID09PSBwcmVmZXJyZWREb2MgJiYgY29udGFpbnMocHJlZmVycmVkRG9jLCBhKSApIHsKCQkJCXJldHVybiAtMTsKCQkJfQoJCQlpZiAoIGIgPT09IGRvYyB8fCBiLm93bmVyRG9jdW1lbnQgPT09IHByZWZlcnJlZERvYyAmJiBjb250YWlucyhwcmVmZXJyZWREb2MsIGIpICkgewoJCQkJcmV0dXJuIDE7CgkJCX0KCgkJCS8vIE1haW50YWluIG9yaWdpbmFsIG9yZGVyCgkJCXJldHVybiBzb3J0SW5wdXQgPwoJCQkJKCBpbmRleE9mLmNhbGwoIHNvcnRJbnB1dCwgYSApIC0gaW5kZXhPZi5jYWxsKCBzb3J0SW5wdXQsIGIgKSApIDoKCQkJCTA7CgkJfQoKCQlyZXR1cm4gY29tcGFyZSAmIDQgPyAtMSA6IDE7Cgl9IDoKCWZ1bmN0aW9uKCBhLCBiICkgewoJCS8vIEV4aXQgZWFybHkgaWYgdGhlIG5vZGVzIGFyZSBpZGVudGljYWwKCQlpZiAoIGEgPT09IGIgKSB7CgkJCWhhc0R1cGxpY2F0ZSA9IHRydWU7CgkJCXJldHVybiAwOwoJCX0KCgkJdmFyIGN1ciwKCQkJaSA9IDAsCgkJCWF1cCA9IGEucGFyZW50Tm9kZSwKCQkJYnVwID0gYi5wYXJlbnROb2RlLAoJCQlhcCA9IFsgYSBdLAoJCQlicCA9IFsgYiBdOwoKCQkvLyBQYXJlbnRsZXNzIG5vZGVzIGFyZSBlaXRoZXIgZG9jdW1lbnRzIG9yIGRpc2Nvbm5lY3RlZAoJCWlmICggIWF1cCB8fCAhYnVwICkgewoJCQlyZXR1cm4gYSA9PT0gZG9jID8gLTEgOgoJCQkJYiA9PT0gZG9jID8gMSA6CgkJCQlhdXAgPyAtMSA6CgkJCQlidXAgPyAxIDoKCQkJCXNvcnRJbnB1dCA/CgkJCQkoIGluZGV4T2YuY2FsbCggc29ydElucHV0LCBhICkgLSBpbmRleE9mLmNhbGwoIHNvcnRJbnB1dCwgYiApICkgOgoJCQkJMDsKCgkJLy8gSWYgdGhlIG5vZGVzIGFyZSBzaWJsaW5ncywgd2UgY2FuIGRvIGEgcXVpY2sgY2hlY2sKCQl9IGVsc2UgaWYgKCBhdXAgPT09IGJ1cCApIHsKCQkJcmV0dXJuIHNpYmxpbmdDaGVjayggYSwgYiApOwoJCX0KCgkJLy8gT3RoZXJ3aXNlIHdlIG5lZWQgZnVsbCBsaXN0cyBvZiB0aGVpciBhbmNlc3RvcnMgZm9yIGNvbXBhcmlzb24KCQljdXIgPSBhOwoJCXdoaWxlICggKGN1ciA9IGN1ci5wYXJlbnROb2RlKSApIHsKCQkJYXAudW5zaGlmdCggY3VyICk7CgkJfQoJCWN1ciA9IGI7CgkJd2hpbGUgKCAoY3VyID0gY3VyLnBhcmVudE5vZGUpICkgewoJCQlicC51bnNoaWZ0KCBjdXIgKTsKCQl9CgoJCS8vIFdhbGsgZG93biB0aGUgdHJlZSBsb29raW5nIGZvciBhIGRpc2NyZXBhbmN5CgkJd2hpbGUgKCBhcFtpXSA9PT0gYnBbaV0gKSB7CgkJCWkrKzsKCQl9CgoJCXJldHVybiBpID8KCQkJLy8gRG8gYSBzaWJsaW5nIGNoZWNrIGlmIHRoZSBub2RlcyBoYXZlIGEgY29tbW9uIGFuY2VzdG9yCgkJCXNpYmxpbmdDaGVjayggYXBbaV0sIGJwW2ldICkgOgoKCQkJLy8gT3RoZXJ3aXNlIG5vZGVzIGluIG91ciBkb2N1bWVudCBzb3J0IGZpcnN0CgkJCWFwW2ldID09PSBwcmVmZXJyZWREb2MgPyAtMSA6CgkJCWJwW2ldID09PSBwcmVmZXJyZWREb2MgPyAxIDoKCQkJMDsKCX07CgoJcmV0dXJuIGRvYzsKfTsKClNpenpsZS5tYXRjaGVzID0gZnVuY3Rpb24oIGV4cHIsIGVsZW1lbnRzICkgewoJcmV0dXJuIFNpenpsZSggZXhwciwgbnVsbCwgbnVsbCwgZWxlbWVudHMgKTsKfTsKClNpenpsZS5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbiggZWxlbSwgZXhwciApIHsKCS8vIFNldCBkb2N1bWVudCB2YXJzIGlmIG5lZWRlZAoJaWYgKCAoIGVsZW0ub3duZXJEb2N1bWVudCB8fCBlbGVtICkgIT09IGRvY3VtZW50ICkgewoJCXNldERvY3VtZW50KCBlbGVtICk7Cgl9CgoJLy8gTWFrZSBzdXJlIHRoYXQgYXR0cmlidXRlIHNlbGVjdG9ycyBhcmUgcXVvdGVkCglleHByID0gZXhwci5yZXBsYWNlKCByYXR0cmlidXRlUXVvdGVzLCAiPSckMSddIiApOwoKCWlmICggc3VwcG9ydC5tYXRjaGVzU2VsZWN0b3IgJiYgZG9jdW1lbnRJc0hUTUwgJiYKCQkoICFyYnVnZ3lNYXRjaGVzIHx8ICFyYnVnZ3lNYXRjaGVzLnRlc3QoIGV4cHIgKSApICYmCgkJKCAhcmJ1Z2d5UVNBICAgICB8fCAhcmJ1Z2d5UVNBLnRlc3QoIGV4cHIgKSApICkgewoKCQl0cnkgewoJCQl2YXIgcmV0ID0gbWF0Y2hlcy5jYWxsKCBlbGVtLCBleHByICk7CgoJCQkvLyBJRSA5J3MgbWF0Y2hlc1NlbGVjdG9yIHJldHVybnMgZmFsc2Ugb24gZGlzY29ubmVjdGVkIG5vZGVzCgkJCWlmICggcmV0IHx8IHN1cHBvcnQuZGlzY29ubmVjdGVkTWF0Y2ggfHwKCQkJCQkvLyBBcyB3ZWxsLCBkaXNjb25uZWN0ZWQgbm9kZXMgYXJlIHNhaWQgdG8gYmUgaW4gYSBkb2N1bWVudAoJCQkJCS8vIGZyYWdtZW50IGluIElFIDkKCQkJCQllbGVtLmRvY3VtZW50ICYmIGVsZW0uZG9jdW1lbnQubm9kZVR5cGUgIT09IDExICkgewoJCQkJcmV0dXJuIHJldDsKCQkJfQoJCX0gY2F0Y2goZSkge30KCX0KCglyZXR1cm4gU2l6emxlKCBleHByLCBkb2N1bWVudCwgbnVsbCwgW2VsZW1dICkubGVuZ3RoID4gMDsKfTsKClNpenpsZS5jb250YWlucyA9IGZ1bmN0aW9uKCBjb250ZXh0LCBlbGVtICkgewoJLy8gU2V0IGRvY3VtZW50IHZhcnMgaWYgbmVlZGVkCglpZiAoICggY29udGV4dC5vd25lckRvY3VtZW50IHx8IGNvbnRleHQgKSAhPT0gZG9jdW1lbnQgKSB7CgkJc2V0RG9jdW1lbnQoIGNvbnRleHQgKTsKCX0KCXJldHVybiBjb250YWlucyggY29udGV4dCwgZWxlbSApOwp9OwoKU2l6emxlLmF0dHIgPSBmdW5jdGlvbiggZWxlbSwgbmFtZSApIHsKCS8vIFNldCBkb2N1bWVudCB2YXJzIGlmIG5lZWRlZAoJaWYgKCAoIGVsZW0ub3duZXJEb2N1bWVudCB8fCBlbGVtICkgIT09IGRvY3VtZW50ICkgewoJCXNldERvY3VtZW50KCBlbGVtICk7Cgl9CgoJdmFyIGZuID0gRXhwci5hdHRySGFuZGxlWyBuYW1lLnRvTG93ZXJDYXNlKCkgXSwKCQkvLyBEb24ndCBnZXQgZm9vbGVkIGJ5IE9iamVjdC5wcm90b3R5cGUgcHJvcGVydGllcyAoalF1ZXJ5ICMxMzgwNykKCQl2YWwgPSBmbiAmJiBoYXNPd24uY2FsbCggRXhwci5hdHRySGFuZGxlLCBuYW1lLnRvTG93ZXJDYXNlKCkgKSA/CgkJCWZuKCBlbGVtLCBuYW1lLCAhZG9jdW1lbnRJc0hUTUwgKSA6CgkJCXVuZGVmaW5lZDsKCglyZXR1cm4gdmFsICE9PSB1bmRlZmluZWQgPwoJCXZhbCA6CgkJc3VwcG9ydC5hdHRyaWJ1dGVzIHx8ICFkb2N1bWVudElzSFRNTCA/CgkJCWVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lICkgOgoJCQkodmFsID0gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKG5hbWUpKSAmJiB2YWwuc3BlY2lmaWVkID8KCQkJCXZhbC52YWx1ZSA6CgkJCQludWxsOwp9OwoKU2l6emxlLmVycm9yID0gZnVuY3Rpb24oIG1zZyApIHsKCXRocm93IG5ldyBFcnJvciggIlN5bnRheCBlcnJvciwgdW5yZWNvZ25pemVkIGV4cHJlc3Npb246ICIgKyBtc2cgKTsKfTsKCi8qKgogKiBEb2N1bWVudCBzb3J0aW5nIGFuZCByZW1vdmluZyBkdXBsaWNhdGVzCiAqIEBwYXJhbSB7QXJyYXlMaWtlfSByZXN1bHRzCiAqLwpTaXp6bGUudW5pcXVlU29ydCA9IGZ1bmN0aW9uKCByZXN1bHRzICkgewoJdmFyIGVsZW0sCgkJZHVwbGljYXRlcyA9IFtdLAoJCWogPSAwLAoJCWkgPSAwOwoKCS8vIFVubGVzcyB3ZSAqa25vdyogd2UgY2FuIGRldGVjdCBkdXBsaWNhdGVzLCBhc3N1bWUgdGhlaXIgcHJlc2VuY2UKCWhhc0R1cGxpY2F0ZSA9ICFzdXBwb3J0LmRldGVjdER1cGxpY2F0ZXM7Cglzb3J0SW5wdXQgPSAhc3VwcG9ydC5zb3J0U3RhYmxlICYmIHJlc3VsdHMuc2xpY2UoIDAgKTsKCXJlc3VsdHMuc29ydCggc29ydE9yZGVyICk7CgoJaWYgKCBoYXNEdXBsaWNhdGUgKSB7CgkJd2hpbGUgKCAoZWxlbSA9IHJlc3VsdHNbaSsrXSkgKSB7CgkJCWlmICggZWxlbSA9PT0gcmVzdWx0c1sgaSBdICkgewoJCQkJaiA9IGR1cGxpY2F0ZXMucHVzaCggaSApOwoJCQl9CgkJfQoJCXdoaWxlICggai0tICkgewoJCQlyZXN1bHRzLnNwbGljZSggZHVwbGljYXRlc1sgaiBdLCAxICk7CgkJfQoJfQoKCS8vIENsZWFyIGlucHV0IGFmdGVyIHNvcnRpbmcgdG8gcmVsZWFzZSBvYmplY3RzCgkvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9zaXp6bGUvcHVsbC8yMjUKCXNvcnRJbnB1dCA9IG51bGw7CgoJcmV0dXJuIHJlc3VsdHM7Cn07CgovKioKICogVXRpbGl0eSBmdW5jdGlvbiBmb3IgcmV0cmlldmluZyB0aGUgdGV4dCB2YWx1ZSBvZiBhbiBhcnJheSBvZiBET00gbm9kZXMKICogQHBhcmFtIHtBcnJheXxFbGVtZW50fSBlbGVtCiAqLwpnZXRUZXh0ID0gU2l6emxlLmdldFRleHQgPSBmdW5jdGlvbiggZWxlbSApIHsKCXZhciBub2RlLAoJCXJldCA9ICIiLAoJCWkgPSAwLAoJCW5vZGVUeXBlID0gZWxlbS5ub2RlVHlwZTsKCglpZiAoICFub2RlVHlwZSApIHsKCQkvLyBJZiBubyBub2RlVHlwZSwgdGhpcyBpcyBleHBlY3RlZCB0byBiZSBhbiBhcnJheQoJCXdoaWxlICggKG5vZGUgPSBlbGVtW2krK10pICkgewoJCQkvLyBEbyBub3QgdHJhdmVyc2UgY29tbWVudCBub2RlcwoJCQlyZXQgKz0gZ2V0VGV4dCggbm9kZSApOwoJCX0KCX0gZWxzZSBpZiAoIG5vZGVUeXBlID09PSAxIHx8IG5vZGVUeXBlID09PSA5IHx8IG5vZGVUeXBlID09PSAxMSApIHsKCQkvLyBVc2UgdGV4dENvbnRlbnQgZm9yIGVsZW1lbnRzCgkJLy8gaW5uZXJUZXh0IHVzYWdlIHJlbW92ZWQgZm9yIGNvbnNpc3RlbmN5IG9mIG5ldyBsaW5lcyAoalF1ZXJ5ICMxMTE1MykKCQlpZiAoIHR5cGVvZiBlbGVtLnRleHRDb250ZW50ID09PSAic3RyaW5nIiApIHsKCQkJcmV0dXJuIGVsZW0udGV4dENvbnRlbnQ7CgkJfSBlbHNlIHsKCQkJLy8gVHJhdmVyc2UgaXRzIGNoaWxkcmVuCgkJCWZvciAoIGVsZW0gPSBlbGVtLmZpcnN0Q2hpbGQ7IGVsZW07IGVsZW0gPSBlbGVtLm5leHRTaWJsaW5nICkgewoJCQkJcmV0ICs9IGdldFRleHQoIGVsZW0gKTsKCQkJfQoJCX0KCX0gZWxzZSBpZiAoIG5vZGVUeXBlID09PSAzIHx8IG5vZGVUeXBlID09PSA0ICkgewoJCXJldHVybiBlbGVtLm5vZGVWYWx1ZTsKCX0KCS8vIERvIG5vdCBpbmNsdWRlIGNvbW1lbnQgb3IgcHJvY2Vzc2luZyBpbnN0cnVjdGlvbiBub2RlcwoKCXJldHVybiByZXQ7Cn07CgpFeHByID0gU2l6emxlLnNlbGVjdG9ycyA9IHsKCgkvLyBDYW4gYmUgYWRqdXN0ZWQgYnkgdGhlIHVzZXIKCWNhY2hlTGVuZ3RoOiA1MCwKCgljcmVhdGVQc2V1ZG86IG1hcmtGdW5jdGlvbiwKCgltYXRjaDogbWF0Y2hFeHByLAoKCWF0dHJIYW5kbGU6IHt9LAoKCWZpbmQ6IHt9LAoKCXJlbGF0aXZlOiB7CgkJIj4iOiB7IGRpcjogInBhcmVudE5vZGUiLCBmaXJzdDogdHJ1ZSB9LAoJCSIgIjogeyBkaXI6ICJwYXJlbnROb2RlIiB9LAoJCSIrIjogeyBkaXI6ICJwcmV2aW91c1NpYmxpbmciLCBmaXJzdDogdHJ1ZSB9LAoJCSJ+IjogeyBkaXI6ICJwcmV2aW91c1NpYmxpbmciIH0KCX0sCgoJcHJlRmlsdGVyOiB7CgkJIkFUVFIiOiBmdW5jdGlvbiggbWF0Y2ggKSB7CgkJCW1hdGNoWzFdID0gbWF0Y2hbMV0ucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKTsKCgkJCS8vIE1vdmUgdGhlIGdpdmVuIHZhbHVlIHRvIG1hdGNoWzNdIHdoZXRoZXIgcXVvdGVkIG9yIHVucXVvdGVkCgkJCW1hdGNoWzNdID0gKCBtYXRjaFs0XSB8fCBtYXRjaFs1XSB8fCAiIiApLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICk7CgoJCQlpZiAoIG1hdGNoWzJdID09PSAifj0iICkgewoJCQkJbWF0Y2hbM10gPSAiICIgKyBtYXRjaFszXSArICIgIjsKCQkJfQoKCQkJcmV0dXJuIG1hdGNoLnNsaWNlKCAwLCA0ICk7CgkJfSwKCgkJIkNISUxEIjogZnVuY3Rpb24oIG1hdGNoICkgewoJCQkvKiBtYXRjaGVzIGZyb20gbWF0Y2hFeHByWyJDSElMRCJdCgkJCQkxIHR5cGUgKG9ubHl8bnRofC4uLikKCQkJCTIgd2hhdCAoY2hpbGR8b2YtdHlwZSkKCQkJCTMgYXJndW1lbnQgKGV2ZW58b2RkfFxkKnxcZCpuKFsrLV1cZCspP3wuLi4pCgkJCQk0IHhuLWNvbXBvbmVudCBvZiB4bit5IGFyZ3VtZW50IChbKy1dP1xkKm58KQoJCQkJNSBzaWduIG9mIHhuLWNvbXBvbmVudAoJCQkJNiB4IG9mIHhuLWNvbXBvbmVudAoJCQkJNyBzaWduIG9mIHktY29tcG9uZW50CgkJCQk4IHkgb2YgeS1jb21wb25lbnQKCQkJKi8KCQkJbWF0Y2hbMV0gPSBtYXRjaFsxXS50b0xvd2VyQ2FzZSgpOwoKCQkJaWYgKCBtYXRjaFsxXS5zbGljZSggMCwgMyApID09PSAibnRoIiApIHsKCQkJCS8vIG50aC0qIHJlcXVpcmVzIGFyZ3VtZW50CgkJCQlpZiAoICFtYXRjaFszXSApIHsKCQkJCQlTaXp6bGUuZXJyb3IoIG1hdGNoWzBdICk7CgkJCQl9CgoJCQkJLy8gbnVtZXJpYyB4IGFuZCB5IHBhcmFtZXRlcnMgZm9yIEV4cHIuZmlsdGVyLkNISUxECgkJCQkvLyByZW1lbWJlciB0aGF0IGZhbHNlL3RydWUgY2FzdCByZXNwZWN0aXZlbHkgdG8gMC8xCgkJCQltYXRjaFs0XSA9ICsoIG1hdGNoWzRdID8gbWF0Y2hbNV0gKyAobWF0Y2hbNl0gfHwgMSkgOiAyICogKCBtYXRjaFszXSA9PT0gImV2ZW4iIHx8IG1hdGNoWzNdID09PSAib2RkIiApICk7CgkJCQltYXRjaFs1XSA9ICsoICggbWF0Y2hbN10gKyBtYXRjaFs4XSApIHx8IG1hdGNoWzNdID09PSAib2RkIiApOwoKCQkJLy8gb3RoZXIgdHlwZXMgcHJvaGliaXQgYXJndW1lbnRzCgkJCX0gZWxzZSBpZiAoIG1hdGNoWzNdICkgewoJCQkJU2l6emxlLmVycm9yKCBtYXRjaFswXSApOwoJCQl9CgoJCQlyZXR1cm4gbWF0Y2g7CgkJfSwKCgkJIlBTRVVETyI6IGZ1bmN0aW9uKCBtYXRjaCApIHsKCQkJdmFyIGV4Y2VzcywKCQkJCXVucXVvdGVkID0gIW1hdGNoWzVdICYmIG1hdGNoWzJdOwoKCQkJaWYgKCBtYXRjaEV4cHJbIkNISUxEIl0udGVzdCggbWF0Y2hbMF0gKSApIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgoJCQkvLyBBY2NlcHQgcXVvdGVkIGFyZ3VtZW50cyBhcy1pcwoJCQlpZiAoIG1hdGNoWzNdICYmIG1hdGNoWzRdICE9PSB1bmRlZmluZWQgKSB7CgkJCQltYXRjaFsyXSA9IG1hdGNoWzRdOwoKCQkJLy8gU3RyaXAgZXhjZXNzIGNoYXJhY3RlcnMgZnJvbSB1bnF1b3RlZCBhcmd1bWVudHMKCQkJfSBlbHNlIGlmICggdW5xdW90ZWQgJiYgcnBzZXVkby50ZXN0KCB1bnF1b3RlZCApICYmCgkJCQkvLyBHZXQgZXhjZXNzIGZyb20gdG9rZW5pemUgKHJlY3Vyc2l2ZWx5KQoJCQkJKGV4Y2VzcyA9IHRva2VuaXplKCB1bnF1b3RlZCwgdHJ1ZSApKSAmJgoJCQkJLy8gYWR2YW5jZSB0byB0aGUgbmV4dCBjbG9zaW5nIHBhcmVudGhlc2lzCgkJCQkoZXhjZXNzID0gdW5xdW90ZWQuaW5kZXhPZiggIikiLCB1bnF1b3RlZC5sZW5ndGggLSBleGNlc3MgKSAtIHVucXVvdGVkLmxlbmd0aCkgKSB7CgoJCQkJLy8gZXhjZXNzIGlzIGEgbmVnYXRpdmUgaW5kZXgKCQkJCW1hdGNoWzBdID0gbWF0Y2hbMF0uc2xpY2UoIDAsIGV4Y2VzcyApOwoJCQkJbWF0Y2hbMl0gPSB1bnF1b3RlZC5zbGljZSggMCwgZXhjZXNzICk7CgkJCX0KCgkJCS8vIFJldHVybiBvbmx5IGNhcHR1cmVzIG5lZWRlZCBieSB0aGUgcHNldWRvIGZpbHRlciBtZXRob2QgKHR5cGUgYW5kIGFyZ3VtZW50KQoJCQlyZXR1cm4gbWF0Y2guc2xpY2UoIDAsIDMgKTsKCQl9Cgl9LAoKCWZpbHRlcjogewoKCQkiVEFHIjogZnVuY3Rpb24oIG5vZGVOYW1lU2VsZWN0b3IgKSB7CgkJCXZhciBub2RlTmFtZSA9IG5vZGVOYW1lU2VsZWN0b3IucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKS50b0xvd2VyQ2FzZSgpOwoJCQlyZXR1cm4gbm9kZU5hbWVTZWxlY3RvciA9PT0gIioiID8KCQkJCWZ1bmN0aW9uKCkgeyByZXR1cm4gdHJ1ZTsgfSA6CgkJCQlmdW5jdGlvbiggZWxlbSApIHsKCQkJCQlyZXR1cm4gZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5vZGVOYW1lOwoJCQkJfTsKCQl9LAoKCQkiQ0xBU1MiOiBmdW5jdGlvbiggY2xhc3NOYW1lICkgewoJCQl2YXIgcGF0dGVybiA9IGNsYXNzQ2FjaGVbIGNsYXNzTmFtZSArICIgIiBdOwoKCQkJcmV0dXJuIHBhdHRlcm4gfHwKCQkJCShwYXR0ZXJuID0gbmV3IFJlZ0V4cCggIihefCIgKyB3aGl0ZXNwYWNlICsgIikiICsgY2xhc3NOYW1lICsgIigiICsgd2hpdGVzcGFjZSArICJ8JCkiICkpICYmCgkJCQljbGFzc0NhY2hlKCBjbGFzc05hbWUsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJCXJldHVybiBwYXR0ZXJuLnRlc3QoIHR5cGVvZiBlbGVtLmNsYXNzTmFtZSA9PT0gInN0cmluZyIgJiYgZWxlbS5jbGFzc05hbWUgfHwgdHlwZW9mIGVsZW0uZ2V0QXR0cmlidXRlICE9PSBzdHJ1bmRlZmluZWQgJiYgZWxlbS5nZXRBdHRyaWJ1dGUoImNsYXNzIikgfHwgIiIgKTsKCQkJCX0pOwoJCX0sCgoJCSJBVFRSIjogZnVuY3Rpb24oIG5hbWUsIG9wZXJhdG9yLCBjaGVjayApIHsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJdmFyIHJlc3VsdCA9IFNpenpsZS5hdHRyKCBlbGVtLCBuYW1lICk7CgoJCQkJaWYgKCByZXN1bHQgPT0gbnVsbCApIHsKCQkJCQlyZXR1cm4gb3BlcmF0b3IgPT09ICIhPSI7CgkJCQl9CgkJCQlpZiAoICFvcGVyYXRvciApIHsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0KCgkJCQlyZXN1bHQgKz0gIiI7CgoJCQkJcmV0dXJuIG9wZXJhdG9yID09PSAiPSIgPyByZXN1bHQgPT09IGNoZWNrIDoKCQkJCQlvcGVyYXRvciA9PT0gIiE9IiA/IHJlc3VsdCAhPT0gY2hlY2sgOgoJCQkJCW9wZXJhdG9yID09PSAiXj0iID8gY2hlY2sgJiYgcmVzdWx0LmluZGV4T2YoIGNoZWNrICkgPT09IDAgOgoJCQkJCW9wZXJhdG9yID09PSAiKj0iID8gY2hlY2sgJiYgcmVzdWx0LmluZGV4T2YoIGNoZWNrICkgPiAtMSA6CgkJCQkJb3BlcmF0b3IgPT09ICIkPSIgPyBjaGVjayAmJiByZXN1bHQuc2xpY2UoIC1jaGVjay5sZW5ndGggKSA9PT0gY2hlY2sgOgoJCQkJCW9wZXJhdG9yID09PSAifj0iID8gKCAiICIgKyByZXN1bHQgKyAiICIgKS5pbmRleE9mKCBjaGVjayApID4gLTEgOgoJCQkJCW9wZXJhdG9yID09PSAifD0iID8gcmVzdWx0ID09PSBjaGVjayB8fCByZXN1bHQuc2xpY2UoIDAsIGNoZWNrLmxlbmd0aCArIDEgKSA9PT0gY2hlY2sgKyAiLSIgOgoJCQkJCWZhbHNlOwoJCQl9OwoJCX0sCgoJCSJDSElMRCI6IGZ1bmN0aW9uKCB0eXBlLCB3aGF0LCBhcmd1bWVudCwgZmlyc3QsIGxhc3QgKSB7CgkJCXZhciBzaW1wbGUgPSB0eXBlLnNsaWNlKCAwLCAzICkgIT09ICJudGgiLAoJCQkJZm9yd2FyZCA9IHR5cGUuc2xpY2UoIC00ICkgIT09ICJsYXN0IiwKCQkJCW9mVHlwZSA9IHdoYXQgPT09ICJvZi10eXBlIjsKCgkJCXJldHVybiBmaXJzdCA9PT0gMSAmJiBsYXN0ID09PSAwID8KCgkJCQkvLyBTaG9ydGN1dCBmb3IgOm50aC0qKG4pCgkJCQlmdW5jdGlvbiggZWxlbSApIHsKCQkJCQlyZXR1cm4gISFlbGVtLnBhcmVudE5vZGU7CgkJCQl9IDoKCgkJCQlmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgewoJCQkJCXZhciBjYWNoZSwgb3V0ZXJDYWNoZSwgbm9kZSwgZGlmZiwgbm9kZUluZGV4LCBzdGFydCwKCQkJCQkJZGlyID0gc2ltcGxlICE9PSBmb3J3YXJkID8gIm5leHRTaWJsaW5nIiA6ICJwcmV2aW91c1NpYmxpbmciLAoJCQkJCQlwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGUsCgkJCQkJCW5hbWUgPSBvZlR5cGUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAoJCQkJCQl1c2VDYWNoZSA9ICF4bWwgJiYgIW9mVHlwZTsKCgkJCQkJaWYgKCBwYXJlbnQgKSB7CgoJCQkJCQkvLyA6KGZpcnN0fGxhc3R8b25seSktKGNoaWxkfG9mLXR5cGUpCgkJCQkJCWlmICggc2ltcGxlICkgewoJCQkJCQkJd2hpbGUgKCBkaXIgKSB7CgkJCQkJCQkJbm9kZSA9IGVsZW07CgkJCQkJCQkJd2hpbGUgKCAobm9kZSA9IG5vZGVbIGRpciBdKSApIHsKCQkJCQkJCQkJaWYgKCBvZlR5cGUgPyBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUgOiBub2RlLm5vZGVUeXBlID09PSAxICkgewoJCQkJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJCQl9CgkJCQkJCQkJfQoJCQkJCQkJCS8vIFJldmVyc2UgZGlyZWN0aW9uIGZvciA6b25seS0qIChpZiB3ZSBoYXZlbid0IHlldCBkb25lIHNvKQoJCQkJCQkJCXN0YXJ0ID0gZGlyID0gdHlwZSA9PT0gIm9ubHkiICYmICFzdGFydCAmJiAibmV4dFNpYmxpbmciOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJCX0KCgkJCQkJCXN0YXJ0ID0gWyBmb3J3YXJkID8gcGFyZW50LmZpcnN0Q2hpbGQgOiBwYXJlbnQubGFzdENoaWxkIF07CgoJCQkJCQkvLyBub24teG1sIDpudGgtY2hpbGQoLi4uKSBzdG9yZXMgY2FjaGUgZGF0YSBvbiBgcGFyZW50YAoJCQkJCQlpZiAoIGZvcndhcmQgJiYgdXNlQ2FjaGUgKSB7CgkJCQkJCQkvLyBTZWVrIGBlbGVtYCBmcm9tIGEgcHJldmlvdXNseS1jYWNoZWQgaW5kZXgKCQkJCQkJCW91dGVyQ2FjaGUgPSBwYXJlbnRbIGV4cGFuZG8gXSB8fCAocGFyZW50WyBleHBhbmRvIF0gPSB7fSk7CgkJCQkJCQljYWNoZSA9IG91dGVyQ2FjaGVbIHR5cGUgXSB8fCBbXTsKCQkJCQkJCW5vZGVJbmRleCA9IGNhY2hlWzBdID09PSBkaXJydW5zICYmIGNhY2hlWzFdOwoJCQkJCQkJZGlmZiA9IGNhY2hlWzBdID09PSBkaXJydW5zICYmIGNhY2hlWzJdOwoJCQkJCQkJbm9kZSA9IG5vZGVJbmRleCAmJiBwYXJlbnQuY2hpbGROb2Rlc1sgbm9kZUluZGV4IF07CgoJCQkJCQkJd2hpbGUgKCAobm9kZSA9ICsrbm9kZUluZGV4ICYmIG5vZGUgJiYgbm9kZVsgZGlyIF0gfHwKCgkJCQkJCQkJLy8gRmFsbGJhY2sgdG8gc2Vla2luZyBgZWxlbWAgZnJvbSB0aGUgc3RhcnQKCQkJCQkJCQkoZGlmZiA9IG5vZGVJbmRleCA9IDApIHx8IHN0YXJ0LnBvcCgpKSApIHsKCgkJCQkJCQkJLy8gV2hlbiBmb3VuZCwgY2FjaGUgaW5kZXhlcyBvbiBgcGFyZW50YCBhbmQgYnJlYWsKCQkJCQkJCQlpZiAoIG5vZGUubm9kZVR5cGUgPT09IDEgJiYgKytkaWZmICYmIG5vZGUgPT09IGVsZW0gKSB7CgkJCQkJCQkJCW91dGVyQ2FjaGVbIHR5cGUgXSA9IFsgZGlycnVucywgbm9kZUluZGV4LCBkaWZmIF07CgkJCQkJCQkJCWJyZWFrOwoJCQkJCQkJCX0KCQkJCQkJCX0KCgkJCQkJCS8vIFVzZSBwcmV2aW91c2x5LWNhY2hlZCBlbGVtZW50IGluZGV4IGlmIGF2YWlsYWJsZQoJCQkJCQl9IGVsc2UgaWYgKCB1c2VDYWNoZSAmJiAoY2FjaGUgPSAoZWxlbVsgZXhwYW5kbyBdIHx8IChlbGVtWyBleHBhbmRvIF0gPSB7fSkpWyB0eXBlIF0pICYmIGNhY2hlWzBdID09PSBkaXJydW5zICkgewoJCQkJCQkJZGlmZiA9IGNhY2hlWzFdOwoKCQkJCQkJLy8geG1sIDpudGgtY2hpbGQoLi4uKSBvciA6bnRoLWxhc3QtY2hpbGQoLi4uKSBvciA6bnRoKC1sYXN0KT8tb2YtdHlwZSguLi4pCgkJCQkJCX0gZWxzZSB7CgkJCQkJCQkvLyBVc2UgdGhlIHNhbWUgbG9vcCBhcyBhYm92ZSB0byBzZWVrIGBlbGVtYCBmcm9tIHRoZSBzdGFydAoJCQkJCQkJd2hpbGUgKCAobm9kZSA9ICsrbm9kZUluZGV4ICYmIG5vZGUgJiYgbm9kZVsgZGlyIF0gfHwKCQkJCQkJCQkoZGlmZiA9IG5vZGVJbmRleCA9IDApIHx8IHN0YXJ0LnBvcCgpKSApIHsKCgkJCQkJCQkJaWYgKCAoIG9mVHlwZSA/IG5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbmFtZSA6IG5vZGUubm9kZVR5cGUgPT09IDEgKSAmJiArK2RpZmYgKSB7CgkJCQkJCQkJCS8vIENhY2hlIHRoZSBpbmRleCBvZiBlYWNoIGVuY291bnRlcmVkIGVsZW1lbnQKCQkJCQkJCQkJaWYgKCB1c2VDYWNoZSApIHsKCQkJCQkJCQkJCShub2RlWyBleHBhbmRvIF0gfHwgKG5vZGVbIGV4cGFuZG8gXSA9IHt9KSlbIHR5cGUgXSA9IFsgZGlycnVucywgZGlmZiBdOwoJCQkJCQkJCQl9CgoJCQkJCQkJCQlpZiAoIG5vZGUgPT09IGVsZW0gKSB7CgkJCQkJCQkJCQlicmVhazsKCQkJCQkJCQkJfQoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfQoKCQkJCQkJLy8gSW5jb3Jwb3JhdGUgdGhlIG9mZnNldCwgdGhlbiBjaGVjayBhZ2FpbnN0IGN5Y2xlIHNpemUKCQkJCQkJZGlmZiAtPSBsYXN0OwoJCQkJCQlyZXR1cm4gZGlmZiA9PT0gZmlyc3QgfHwgKCBkaWZmICUgZmlyc3QgPT09IDAgJiYgZGlmZiAvIGZpcnN0ID49IDAgKTsKCQkJCQl9CgkJCQl9OwoJCX0sCgoJCSJQU0VVRE8iOiBmdW5jdGlvbiggcHNldWRvLCBhcmd1bWVudCApIHsKCQkJLy8gcHNldWRvLWNsYXNzIG5hbWVzIGFyZSBjYXNlLWluc2Vuc2l0aXZlCgkJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jcHNldWRvLWNsYXNzZXMKCQkJLy8gUHJpb3JpdGl6ZSBieSBjYXNlIHNlbnNpdGl2aXR5IGluIGNhc2UgY3VzdG9tIHBzZXVkb3MgYXJlIGFkZGVkIHdpdGggdXBwZXJjYXNlIGxldHRlcnMKCQkJLy8gUmVtZW1iZXIgdGhhdCBzZXRGaWx0ZXJzIGluaGVyaXRzIGZyb20gcHNldWRvcwoJCQl2YXIgYXJncywKCQkJCWZuID0gRXhwci5wc2V1ZG9zWyBwc2V1ZG8gXSB8fCBFeHByLnNldEZpbHRlcnNbIHBzZXVkby50b0xvd2VyQ2FzZSgpIF0gfHwKCQkJCQlTaXp6bGUuZXJyb3IoICJ1bnN1cHBvcnRlZCBwc2V1ZG86ICIgKyBwc2V1ZG8gKTsKCgkJCS8vIFRoZSB1c2VyIG1heSB1c2UgY3JlYXRlUHNldWRvIHRvIGluZGljYXRlIHRoYXQKCQkJLy8gYXJndW1lbnRzIGFyZSBuZWVkZWQgdG8gY3JlYXRlIHRoZSBmaWx0ZXIgZnVuY3Rpb24KCQkJLy8ganVzdCBhcyBTaXp6bGUgZG9lcwoJCQlpZiAoIGZuWyBleHBhbmRvIF0gKSB7CgkJCQlyZXR1cm4gZm4oIGFyZ3VtZW50ICk7CgkJCX0KCgkJCS8vIEJ1dCBtYWludGFpbiBzdXBwb3J0IGZvciBvbGQgc2lnbmF0dXJlcwoJCQlpZiAoIGZuLmxlbmd0aCA+IDEgKSB7CgkJCQlhcmdzID0gWyBwc2V1ZG8sIHBzZXVkbywgIiIsIGFyZ3VtZW50IF07CgkJCQlyZXR1cm4gRXhwci5zZXRGaWx0ZXJzLmhhc093blByb3BlcnR5KCBwc2V1ZG8udG9Mb3dlckNhc2UoKSApID8KCQkJCQltYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlZWQsIG1hdGNoZXMgKSB7CgkJCQkJCXZhciBpZHgsCgkJCQkJCQltYXRjaGVkID0gZm4oIHNlZWQsIGFyZ3VtZW50ICksCgkJCQkJCQlpID0gbWF0Y2hlZC5sZW5ndGg7CgkJCQkJCXdoaWxlICggaS0tICkgewoJCQkJCQkJaWR4ID0gaW5kZXhPZi5jYWxsKCBzZWVkLCBtYXRjaGVkW2ldICk7CgkJCQkJCQlzZWVkWyBpZHggXSA9ICEoIG1hdGNoZXNbIGlkeCBdID0gbWF0Y2hlZFtpXSApOwoJCQkJCQl9CgkJCQkJfSkgOgoJCQkJCWZ1bmN0aW9uKCBlbGVtICkgewoJCQkJCQlyZXR1cm4gZm4oIGVsZW0sIDAsIGFyZ3MgKTsKCQkJCQl9OwoJCQl9CgoJCQlyZXR1cm4gZm47CgkJfQoJfSwKCglwc2V1ZG9zOiB7CgkJLy8gUG90ZW50aWFsbHkgY29tcGxleCBwc2V1ZG9zCgkJIm5vdCI6IG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJCS8vIFRyaW0gdGhlIHNlbGVjdG9yIHBhc3NlZCB0byBjb21waWxlCgkJCS8vIHRvIGF2b2lkIHRyZWF0aW5nIGxlYWRpbmcgYW5kIHRyYWlsaW5nCgkJCS8vIHNwYWNlcyBhcyBjb21iaW5hdG9ycwoJCQl2YXIgaW5wdXQgPSBbXSwKCQkJCXJlc3VsdHMgPSBbXSwKCQkJCW1hdGNoZXIgPSBjb21waWxlKCBzZWxlY3Rvci5yZXBsYWNlKCBydHJpbSwgIiQxIiApICk7CgoJCQlyZXR1cm4gbWF0Y2hlclsgZXhwYW5kbyBdID8KCQkJCW1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VlZCwgbWF0Y2hlcywgY29udGV4dCwgeG1sICkgewoJCQkJCXZhciBlbGVtLAoJCQkJCQl1bm1hdGNoZWQgPSBtYXRjaGVyKCBzZWVkLCBudWxsLCB4bWwsIFtdICksCgkJCQkJCWkgPSBzZWVkLmxlbmd0aDsKCgkJCQkJLy8gTWF0Y2ggZWxlbWVudHMgdW5tYXRjaGVkIGJ5IGBtYXRjaGVyYAoJCQkJCXdoaWxlICggaS0tICkgewoJCQkJCQlpZiAoIChlbGVtID0gdW5tYXRjaGVkW2ldKSApIHsKCQkJCQkJCXNlZWRbaV0gPSAhKG1hdGNoZXNbaV0gPSBlbGVtKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0pIDoKCQkJCWZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB7CgkJCQkJaW5wdXRbMF0gPSBlbGVtOwoJCQkJCW1hdGNoZXIoIGlucHV0LCBudWxsLCB4bWwsIHJlc3VsdHMgKTsKCQkJCQlyZXR1cm4gIXJlc3VsdHMucG9wKCk7CgkJCQl9OwoJCX0pLAoKCQkiaGFzIjogbWFya0Z1bmN0aW9uKGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJcmV0dXJuIFNpenpsZSggc2VsZWN0b3IsIGVsZW0gKS5sZW5ndGggPiAwOwoJCQl9OwoJCX0pLAoKCQkiY29udGFpbnMiOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHRleHQgKSB7CgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXJldHVybiAoIGVsZW0udGV4dENvbnRlbnQgfHwgZWxlbS5pbm5lclRleHQgfHwgZ2V0VGV4dCggZWxlbSApICkuaW5kZXhPZiggdGV4dCApID4gLTE7CgkJCX07CgkJfSksCgoJCS8vICJXaGV0aGVyIGFuIGVsZW1lbnQgaXMgcmVwcmVzZW50ZWQgYnkgYSA6bGFuZygpIHNlbGVjdG9yCgkJLy8gaXMgYmFzZWQgc29sZWx5IG9uIHRoZSBlbGVtZW50J3MgbGFuZ3VhZ2UgdmFsdWUKCQkvLyBiZWluZyBlcXVhbCB0byB0aGUgaWRlbnRpZmllciBDLAoJCS8vIG9yIGJlZ2lubmluZyB3aXRoIHRoZSBpZGVudGlmaWVyIEMgaW1tZWRpYXRlbHkgZm9sbG93ZWQgYnkgIi0iLgoJCS8vIFRoZSBtYXRjaGluZyBvZiBDIGFnYWluc3QgdGhlIGVsZW1lbnQncyBsYW5ndWFnZSB2YWx1ZSBpcyBwZXJmb3JtZWQgY2FzZS1pbnNlbnNpdGl2ZWx5LgoJCS8vIFRoZSBpZGVudGlmaWVyIEMgZG9lcyBub3QgaGF2ZSB0byBiZSBhIHZhbGlkIGxhbmd1YWdlIG5hbWUuIgoJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jbGFuZy1wc2V1ZG8KCQkibGFuZyI6IG1hcmtGdW5jdGlvbiggZnVuY3Rpb24oIGxhbmcgKSB7CgkJCS8vIGxhbmcgdmFsdWUgbXVzdCBiZSBhIHZhbGlkIGlkZW50aWZpZXIKCQkJaWYgKCAhcmlkZW50aWZpZXIudGVzdChsYW5nIHx8ICIiKSApIHsKCQkJCVNpenpsZS5lcnJvciggInVuc3VwcG9ydGVkIGxhbmc6ICIgKyBsYW5nICk7CgkJCX0KCQkJbGFuZyA9IGxhbmcucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKS50b0xvd2VyQ2FzZSgpOwoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQl2YXIgZWxlbUxhbmc7CgkJCQlkbyB7CgkJCQkJaWYgKCAoZWxlbUxhbmcgPSBkb2N1bWVudElzSFRNTCA/CgkJCQkJCWVsZW0ubGFuZyA6CgkJCQkJCWVsZW0uZ2V0QXR0cmlidXRlKCJ4bWw6bGFuZyIpIHx8IGVsZW0uZ2V0QXR0cmlidXRlKCJsYW5nIikpICkgewoKCQkJCQkJZWxlbUxhbmcgPSBlbGVtTGFuZy50b0xvd2VyQ2FzZSgpOwoJCQkJCQlyZXR1cm4gZWxlbUxhbmcgPT09IGxhbmcgfHwgZWxlbUxhbmcuaW5kZXhPZiggbGFuZyArICItIiApID09PSAwOwoJCQkJCX0KCQkJCX0gd2hpbGUgKCAoZWxlbSA9IGVsZW0ucGFyZW50Tm9kZSkgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSApOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9OwoJCX0pLAoKCQkvLyBNaXNjZWxsYW5lb3VzCgkJInRhcmdldCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQl2YXIgaGFzaCA9IHdpbmRvdy5sb2NhdGlvbiAmJiB3aW5kb3cubG9jYXRpb24uaGFzaDsKCQkJcmV0dXJuIGhhc2ggJiYgaGFzaC5zbGljZSggMSApID09PSBlbGVtLmlkOwoJCX0sCgoJCSJyb290IjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtID09PSBkb2NFbGVtOwoJCX0sCgoJCSJmb2N1cyI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbSA9PT0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJiAoIWRvY3VtZW50Lmhhc0ZvY3VzIHx8IGRvY3VtZW50Lmhhc0ZvY3VzKCkpICYmICEhKGVsZW0udHlwZSB8fCBlbGVtLmhyZWYgfHwgfmVsZW0udGFiSW5kZXgpOwoJCX0sCgoJCS8vIEJvb2xlYW4gcHJvcGVydGllcwoJCSJlbmFibGVkIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtLmRpc2FibGVkID09PSBmYWxzZTsKCQl9LAoKCQkiZGlzYWJsZWQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0uZGlzYWJsZWQgPT09IHRydWU7CgkJfSwKCgkJImNoZWNrZWQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJLy8gSW4gQ1NTMywgOmNoZWNrZWQgc2hvdWxkIHJldHVybiBib3RoIGNoZWNrZWQgYW5kIHNlbGVjdGVkIGVsZW1lbnRzCgkJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSLzIwMTEvUkVDLWNzczMtc2VsZWN0b3JzLTIwMTEwOTI5LyNjaGVja2VkCgkJCXZhciBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCQkJcmV0dXJuIChub2RlTmFtZSA9PT0gImlucHV0IiAmJiAhIWVsZW0uY2hlY2tlZCkgfHwgKG5vZGVOYW1lID09PSAib3B0aW9uIiAmJiAhIWVsZW0uc2VsZWN0ZWQpOwoJCX0sCgoJCSJzZWxlY3RlZCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkvLyBBY2Nlc3NpbmcgdGhpcyBwcm9wZXJ0eSBtYWtlcyBzZWxlY3RlZC1ieS1kZWZhdWx0CgkJCS8vIG9wdGlvbnMgaW4gU2FmYXJpIHdvcmsgcHJvcGVybHkKCQkJaWYgKCBlbGVtLnBhcmVudE5vZGUgKSB7CgkJCQllbGVtLnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleDsKCQkJfQoKCQkJcmV0dXJuIGVsZW0uc2VsZWN0ZWQgPT09IHRydWU7CgkJfSwKCgkJLy8gQ29udGVudHMKCQkiZW1wdHkiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNlbXB0eS1wc2V1ZG8KCQkJLy8gOmVtcHR5IGlzIG5lZ2F0ZWQgYnkgZWxlbWVudCAoMSkgb3IgY29udGVudCBub2RlcyAodGV4dDogMzsgY2RhdGE6IDQ7IGVudGl0eSByZWY6IDUpLAoJCQkvLyAgIGJ1dCBub3QgYnkgb3RoZXJzIChjb21tZW50OiA4OyBwcm9jZXNzaW5nIGluc3RydWN0aW9uOiA3OyBldGMuKQoJCQkvLyBub2RlVHlwZSA8IDYgd29ya3MgYmVjYXVzZSBhdHRyaWJ1dGVzICgyKSBkbyBub3QgYXBwZWFyIGFzIGNoaWxkcmVuCgkJCWZvciAoIGVsZW0gPSBlbGVtLmZpcnN0Q2hpbGQ7IGVsZW07IGVsZW0gPSBlbGVtLm5leHRTaWJsaW5nICkgewoJCQkJaWYgKCBlbGVtLm5vZGVUeXBlIDwgNiApIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHRydWU7CgkJfSwKCgkJInBhcmVudCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gIUV4cHIucHNldWRvc1siZW1wdHkiXSggZWxlbSApOwoJCX0sCgoJCS8vIEVsZW1lbnQvaW5wdXQgdHlwZXMKCQkiaGVhZGVyIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiByaGVhZGVyLnRlc3QoIGVsZW0ubm9kZU5hbWUgKTsKCQl9LAoKCQkiaW5wdXQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIHJpbnB1dHMudGVzdCggZWxlbS5ub2RlTmFtZSApOwoJCX0sCgoJCSJidXR0b24iOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJdmFyIG5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgkJCXJldHVybiBuYW1lID09PSAiaW5wdXQiICYmIGVsZW0udHlwZSA9PT0gImJ1dHRvbiIgfHwgbmFtZSA9PT0gImJ1dHRvbiI7CgkJfSwKCgkJInRleHQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJdmFyIGF0dHI7CgkJCXJldHVybiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJpbnB1dCIgJiYKCQkJCWVsZW0udHlwZSA9PT0gInRleHQiICYmCgoJCQkJLy8gU3VwcG9ydDogSUU8OAoJCQkJLy8gTmV3IEhUTUw1IGF0dHJpYnV0ZSB2YWx1ZXMgKGUuZy4sICJzZWFyY2giKSBhcHBlYXIgd2l0aCBlbGVtLnR5cGUgPT09ICJ0ZXh0IgoJCQkJKCAoYXR0ciA9IGVsZW0uZ2V0QXR0cmlidXRlKCJ0eXBlIikpID09IG51bGwgfHwgYXR0ci50b0xvd2VyQ2FzZSgpID09PSAidGV4dCIgKTsKCQl9LAoKCQkvLyBQb3NpdGlvbi1pbi1jb2xsZWN0aW9uCgkJImZpcnN0IjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbigpIHsKCQkJcmV0dXJuIFsgMCBdOwoJCX0pLAoKCQkibGFzdCI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoICkgewoJCQlyZXR1cm4gWyBsZW5ndGggLSAxIF07CgkJfSksCgoJCSJlcSI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoLCBhcmd1bWVudCApIHsKCQkJcmV0dXJuIFsgYXJndW1lbnQgPCAwID8gYXJndW1lbnQgKyBsZW5ndGggOiBhcmd1bWVudCBdOwoJCX0pLAoKCQkiZXZlbiI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoICkgewoJCQl2YXIgaSA9IDA7CgkJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSArPSAyICkgewoJCQkJbWF0Y2hJbmRleGVzLnB1c2goIGkgKTsKCQkJfQoJCQlyZXR1cm4gbWF0Y2hJbmRleGVzOwoJCX0pLAoKCQkib2RkIjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiggbWF0Y2hJbmRleGVzLCBsZW5ndGggKSB7CgkJCXZhciBpID0gMTsKCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpICs9IDIgKSB7CgkJCQltYXRjaEluZGV4ZXMucHVzaCggaSApOwoJCQl9CgkJCXJldHVybiBtYXRjaEluZGV4ZXM7CgkJfSksCgoJCSJsdCI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoLCBhcmd1bWVudCApIHsKCQkJdmFyIGkgPSBhcmd1bWVudCA8IDAgPyBhcmd1bWVudCArIGxlbmd0aCA6IGFyZ3VtZW50OwoJCQlmb3IgKCA7IC0taSA+PSAwOyApIHsKCQkJCW1hdGNoSW5kZXhlcy5wdXNoKCBpICk7CgkJCX0KCQkJcmV0dXJuIG1hdGNoSW5kZXhlczsKCQl9KSwKCgkJImd0IjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiggbWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50ICkgewoJCQl2YXIgaSA9IGFyZ3VtZW50IDwgMCA/IGFyZ3VtZW50ICsgbGVuZ3RoIDogYXJndW1lbnQ7CgkJCWZvciAoIDsgKytpIDwgbGVuZ3RoOyApIHsKCQkJCW1hdGNoSW5kZXhlcy5wdXNoKCBpICk7CgkJCX0KCQkJcmV0dXJuIG1hdGNoSW5kZXhlczsKCQl9KQoJfQp9OwoKRXhwci5wc2V1ZG9zWyJudGgiXSA9IEV4cHIucHNldWRvc1siZXEiXTsKCi8vIEFkZCBidXR0b24vaW5wdXQgdHlwZSBwc2V1ZG9zCmZvciAoIGkgaW4geyByYWRpbzogdHJ1ZSwgY2hlY2tib3g6IHRydWUsIGZpbGU6IHRydWUsIHBhc3N3b3JkOiB0cnVlLCBpbWFnZTogdHJ1ZSB9ICkgewoJRXhwci5wc2V1ZG9zWyBpIF0gPSBjcmVhdGVJbnB1dFBzZXVkbyggaSApOwp9CmZvciAoIGkgaW4geyBzdWJtaXQ6IHRydWUsIHJlc2V0OiB0cnVlIH0gKSB7CglFeHByLnBzZXVkb3NbIGkgXSA9IGNyZWF0ZUJ1dHRvblBzZXVkbyggaSApOwp9CgovLyBFYXN5IEFQSSBmb3IgY3JlYXRpbmcgbmV3IHNldEZpbHRlcnMKZnVuY3Rpb24gc2V0RmlsdGVycygpIHt9CnNldEZpbHRlcnMucHJvdG90eXBlID0gRXhwci5maWx0ZXJzID0gRXhwci5wc2V1ZG9zOwpFeHByLnNldEZpbHRlcnMgPSBuZXcgc2V0RmlsdGVycygpOwoKZnVuY3Rpb24gdG9rZW5pemUoIHNlbGVjdG9yLCBwYXJzZU9ubHkgKSB7Cgl2YXIgbWF0Y2hlZCwgbWF0Y2gsIHRva2VucywgdHlwZSwKCQlzb0ZhciwgZ3JvdXBzLCBwcmVGaWx0ZXJzLAoJCWNhY2hlZCA9IHRva2VuQ2FjaGVbIHNlbGVjdG9yICsgIiAiIF07CgoJaWYgKCBjYWNoZWQgKSB7CgkJcmV0dXJuIHBhcnNlT25seSA/IDAgOiBjYWNoZWQuc2xpY2UoIDAgKTsKCX0KCglzb0ZhciA9IHNlbGVjdG9yOwoJZ3JvdXBzID0gW107CglwcmVGaWx0ZXJzID0gRXhwci5wcmVGaWx0ZXI7CgoJd2hpbGUgKCBzb0ZhciApIHsKCgkJLy8gQ29tbWEgYW5kIGZpcnN0IHJ1bgoJCWlmICggIW1hdGNoZWQgfHwgKG1hdGNoID0gcmNvbW1hLmV4ZWMoIHNvRmFyICkpICkgewoJCQlpZiAoIG1hdGNoICkgewoJCQkJLy8gRG9uJ3QgY29uc3VtZSB0cmFpbGluZyBjb21tYXMgYXMgdmFsaWQKCQkJCXNvRmFyID0gc29GYXIuc2xpY2UoIG1hdGNoWzBdLmxlbmd0aCApIHx8IHNvRmFyOwoJCQl9CgkJCWdyb3Vwcy5wdXNoKCAodG9rZW5zID0gW10pICk7CgkJfQoKCQltYXRjaGVkID0gZmFsc2U7CgoJCS8vIENvbWJpbmF0b3JzCgkJaWYgKCAobWF0Y2ggPSByY29tYmluYXRvcnMuZXhlYyggc29GYXIgKSkgKSB7CgkJCW1hdGNoZWQgPSBtYXRjaC5zaGlmdCgpOwoJCQl0b2tlbnMucHVzaCh7CgkJCQl2YWx1ZTogbWF0Y2hlZCwKCQkJCS8vIENhc3QgZGVzY2VuZGFudCBjb21iaW5hdG9ycyB0byBzcGFjZQoJCQkJdHlwZTogbWF0Y2hbMF0ucmVwbGFjZSggcnRyaW0sICIgIiApCgkJCX0pOwoJCQlzb0ZhciA9IHNvRmFyLnNsaWNlKCBtYXRjaGVkLmxlbmd0aCApOwoJCX0KCgkJLy8gRmlsdGVycwoJCWZvciAoIHR5cGUgaW4gRXhwci5maWx0ZXIgKSB7CgkJCWlmICggKG1hdGNoID0gbWF0Y2hFeHByWyB0eXBlIF0uZXhlYyggc29GYXIgKSkgJiYgKCFwcmVGaWx0ZXJzWyB0eXBlIF0gfHwKCQkJCShtYXRjaCA9IHByZUZpbHRlcnNbIHR5cGUgXSggbWF0Y2ggKSkpICkgewoJCQkJbWF0Y2hlZCA9IG1hdGNoLnNoaWZ0KCk7CgkJCQl0b2tlbnMucHVzaCh7CgkJCQkJdmFsdWU6IG1hdGNoZWQsCgkJCQkJdHlwZTogdHlwZSwKCQkJCQltYXRjaGVzOiBtYXRjaAoJCQkJfSk7CgkJCQlzb0ZhciA9IHNvRmFyLnNsaWNlKCBtYXRjaGVkLmxlbmd0aCApOwoJCQl9CgkJfQoKCQlpZiAoICFtYXRjaGVkICkgewoJCQlicmVhazsKCQl9Cgl9CgoJLy8gUmV0dXJuIHRoZSBsZW5ndGggb2YgdGhlIGludmFsaWQgZXhjZXNzCgkvLyBpZiB3ZSdyZSBqdXN0IHBhcnNpbmcKCS8vIE90aGVyd2lzZSwgdGhyb3cgYW4gZXJyb3Igb3IgcmV0dXJuIHRva2VucwoJcmV0dXJuIHBhcnNlT25seSA/CgkJc29GYXIubGVuZ3RoIDoKCQlzb0ZhciA/CgkJCVNpenpsZS5lcnJvciggc2VsZWN0b3IgKSA6CgkJCS8vIENhY2hlIHRoZSB0b2tlbnMKCQkJdG9rZW5DYWNoZSggc2VsZWN0b3IsIGdyb3VwcyApLnNsaWNlKCAwICk7Cn0KCmZ1bmN0aW9uIHRvU2VsZWN0b3IoIHRva2VucyApIHsKCXZhciBpID0gMCwKCQlsZW4gPSB0b2tlbnMubGVuZ3RoLAoJCXNlbGVjdG9yID0gIiI7Cglmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQlzZWxlY3RvciArPSB0b2tlbnNbaV0udmFsdWU7Cgl9CglyZXR1cm4gc2VsZWN0b3I7Cn0KCmZ1bmN0aW9uIGFkZENvbWJpbmF0b3IoIG1hdGNoZXIsIGNvbWJpbmF0b3IsIGJhc2UgKSB7Cgl2YXIgZGlyID0gY29tYmluYXRvci5kaXIsCgkJY2hlY2tOb25FbGVtZW50cyA9IGJhc2UgJiYgZGlyID09PSAicGFyZW50Tm9kZSIsCgkJZG9uZU5hbWUgPSBkb25lKys7CgoJcmV0dXJuIGNvbWJpbmF0b3IuZmlyc3QgPwoJCS8vIENoZWNrIGFnYWluc3QgY2xvc2VzdCBhbmNlc3Rvci9wcmVjZWRpbmcgZWxlbWVudAoJCWZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB7CgkJCXdoaWxlICggKGVsZW0gPSBlbGVtWyBkaXIgXSkgKSB7CgkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgfHwgY2hlY2tOb25FbGVtZW50cyApIHsKCQkJCQlyZXR1cm4gbWF0Y2hlciggZWxlbSwgY29udGV4dCwgeG1sICk7CgkJCQl9CgkJCX0KCQl9IDoKCgkJLy8gQ2hlY2sgYWdhaW5zdCBhbGwgYW5jZXN0b3IvcHJlY2VkaW5nIGVsZW1lbnRzCgkJZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQsIHhtbCApIHsKCQkJdmFyIG9sZENhY2hlLCBvdXRlckNhY2hlLAoJCQkJbmV3Q2FjaGUgPSBbIGRpcnJ1bnMsIGRvbmVOYW1lIF07CgoJCQkvLyBXZSBjYW4ndCBzZXQgYXJiaXRyYXJ5IGRhdGEgb24gWE1MIG5vZGVzLCBzbyB0aGV5IGRvbid0IGJlbmVmaXQgZnJvbSBkaXIgY2FjaGluZwoJCQlpZiAoIHhtbCApIHsKCQkJCXdoaWxlICggKGVsZW0gPSBlbGVtWyBkaXIgXSkgKSB7CgkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMgKSB7CgkJCQkJCWlmICggbWF0Y2hlciggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7CgkJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXdoaWxlICggKGVsZW0gPSBlbGVtWyBkaXIgXSkgKSB7CgkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMgKSB7CgkJCQkJCW91dGVyQ2FjaGUgPSBlbGVtWyBleHBhbmRvIF0gfHwgKGVsZW1bIGV4cGFuZG8gXSA9IHt9KTsKCQkJCQkJaWYgKCAob2xkQ2FjaGUgPSBvdXRlckNhY2hlWyBkaXIgXSkgJiYKCQkJCQkJCW9sZENhY2hlWyAwIF0gPT09IGRpcnJ1bnMgJiYgb2xkQ2FjaGVbIDEgXSA9PT0gZG9uZU5hbWUgKSB7CgoJCQkJCQkJLy8gQXNzaWduIHRvIG5ld0NhY2hlIHNvIHJlc3VsdHMgYmFjay1wcm9wYWdhdGUgdG8gcHJldmlvdXMgZWxlbWVudHMKCQkJCQkJCXJldHVybiAobmV3Q2FjaGVbIDIgXSA9IG9sZENhY2hlWyAyIF0pOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJLy8gUmV1c2UgbmV3Y2FjaGUgc28gcmVzdWx0cyBiYWNrLXByb3BhZ2F0ZSB0byBwcmV2aW91cyBlbGVtZW50cwoJCQkJCQkJb3V0ZXJDYWNoZVsgZGlyIF0gPSBuZXdDYWNoZTsKCgkJCQkJCQkvLyBBIG1hdGNoIG1lYW5zIHdlJ3JlIGRvbmU7IGEgZmFpbCBtZWFucyB3ZSBoYXZlIHRvIGtlZXAgY2hlY2tpbmcKCQkJCQkJCWlmICggKG5ld0NhY2hlWyAyIF0gPSBtYXRjaGVyKCBlbGVtLCBjb250ZXh0LCB4bWwgKSkgKSB7CgkJCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCQl9Owp9CgpmdW5jdGlvbiBlbGVtZW50TWF0Y2hlciggbWF0Y2hlcnMgKSB7CglyZXR1cm4gbWF0Y2hlcnMubGVuZ3RoID4gMSA/CgkJZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQsIHhtbCApIHsKCQkJdmFyIGkgPSBtYXRjaGVycy5sZW5ndGg7CgkJCXdoaWxlICggaS0tICkgewoJCQkJaWYgKCAhbWF0Y2hlcnNbaV0oIGVsZW0sIGNvbnRleHQsIHhtbCApICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gdHJ1ZTsKCQl9IDoKCQltYXRjaGVyc1swXTsKfQoKZnVuY3Rpb24gY29uZGVuc2UoIHVubWF0Y2hlZCwgbWFwLCBmaWx0ZXIsIGNvbnRleHQsIHhtbCApIHsKCXZhciBlbGVtLAoJCW5ld1VubWF0Y2hlZCA9IFtdLAoJCWkgPSAwLAoJCWxlbiA9IHVubWF0Y2hlZC5sZW5ndGgsCgkJbWFwcGVkID0gbWFwICE9IG51bGw7CgoJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CgkJaWYgKCAoZWxlbSA9IHVubWF0Y2hlZFtpXSkgKSB7CgkJCWlmICggIWZpbHRlciB8fCBmaWx0ZXIoIGVsZW0sIGNvbnRleHQsIHhtbCApICkgewoJCQkJbmV3VW5tYXRjaGVkLnB1c2goIGVsZW0gKTsKCQkJCWlmICggbWFwcGVkICkgewoJCQkJCW1hcC5wdXNoKCBpICk7CgkJCQl9CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIG5ld1VubWF0Y2hlZDsKfQoKZnVuY3Rpb24gc2V0TWF0Y2hlciggcHJlRmlsdGVyLCBzZWxlY3RvciwgbWF0Y2hlciwgcG9zdEZpbHRlciwgcG9zdEZpbmRlciwgcG9zdFNlbGVjdG9yICkgewoJaWYgKCBwb3N0RmlsdGVyICYmICFwb3N0RmlsdGVyWyBleHBhbmRvIF0gKSB7CgkJcG9zdEZpbHRlciA9IHNldE1hdGNoZXIoIHBvc3RGaWx0ZXIgKTsKCX0KCWlmICggcG9zdEZpbmRlciAmJiAhcG9zdEZpbmRlclsgZXhwYW5kbyBdICkgewoJCXBvc3RGaW5kZXIgPSBzZXRNYXRjaGVyKCBwb3N0RmluZGVyLCBwb3N0U2VsZWN0b3IgKTsKCX0KCXJldHVybiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlZWQsIHJlc3VsdHMsIGNvbnRleHQsIHhtbCApIHsKCQl2YXIgdGVtcCwgaSwgZWxlbSwKCQkJcHJlTWFwID0gW10sCgkJCXBvc3RNYXAgPSBbXSwKCQkJcHJlZXhpc3RpbmcgPSByZXN1bHRzLmxlbmd0aCwKCgkJCS8vIEdldCBpbml0aWFsIGVsZW1lbnRzIGZyb20gc2VlZCBvciBjb250ZXh0CgkJCWVsZW1zID0gc2VlZCB8fCBtdWx0aXBsZUNvbnRleHRzKCBzZWxlY3RvciB8fCAiKiIsIGNvbnRleHQubm9kZVR5cGUgPyBbIGNvbnRleHQgXSA6IGNvbnRleHQsIFtdICksCgoJCQkvLyBQcmVmaWx0ZXIgdG8gZ2V0IG1hdGNoZXIgaW5wdXQsIHByZXNlcnZpbmcgYSBtYXAgZm9yIHNlZWQtcmVzdWx0cyBzeW5jaHJvbml6YXRpb24KCQkJbWF0Y2hlckluID0gcHJlRmlsdGVyICYmICggc2VlZCB8fCAhc2VsZWN0b3IgKSA/CgkJCQljb25kZW5zZSggZWxlbXMsIHByZU1hcCwgcHJlRmlsdGVyLCBjb250ZXh0LCB4bWwgKSA6CgkJCQllbGVtcywKCgkJCW1hdGNoZXJPdXQgPSBtYXRjaGVyID8KCQkJCS8vIElmIHdlIGhhdmUgYSBwb3N0RmluZGVyLCBvciBmaWx0ZXJlZCBzZWVkLCBvciBub24tc2VlZCBwb3N0RmlsdGVyIG9yIHByZWV4aXN0aW5nIHJlc3VsdHMsCgkJCQlwb3N0RmluZGVyIHx8ICggc2VlZCA/IHByZUZpbHRlciA6IHByZWV4aXN0aW5nIHx8IHBvc3RGaWx0ZXIgKSA/CgoJCQkJCS8vIC4uLmludGVybWVkaWF0ZSBwcm9jZXNzaW5nIGlzIG5lY2Vzc2FyeQoJCQkJCVtdIDoKCgkJCQkJLy8gLi4ub3RoZXJ3aXNlIHVzZSByZXN1bHRzIGRpcmVjdGx5CgkJCQkJcmVzdWx0cyA6CgkJCQltYXRjaGVySW47CgoJCS8vIEZpbmQgcHJpbWFyeSBtYXRjaGVzCgkJaWYgKCBtYXRjaGVyICkgewoJCQltYXRjaGVyKCBtYXRjaGVySW4sIG1hdGNoZXJPdXQsIGNvbnRleHQsIHhtbCApOwoJCX0KCgkJLy8gQXBwbHkgcG9zdEZpbHRlcgoJCWlmICggcG9zdEZpbHRlciApIHsKCQkJdGVtcCA9IGNvbmRlbnNlKCBtYXRjaGVyT3V0LCBwb3N0TWFwICk7CgkJCXBvc3RGaWx0ZXIoIHRlbXAsIFtdLCBjb250ZXh0LCB4bWwgKTsKCgkJCS8vIFVuLW1hdGNoIGZhaWxpbmcgZWxlbWVudHMgYnkgbW92aW5nIHRoZW0gYmFjayB0byBtYXRjaGVySW4KCQkJaSA9IHRlbXAubGVuZ3RoOwoJCQl3aGlsZSAoIGktLSApIHsKCQkJCWlmICggKGVsZW0gPSB0ZW1wW2ldKSApIHsKCQkJCQltYXRjaGVyT3V0WyBwb3N0TWFwW2ldIF0gPSAhKG1hdGNoZXJJblsgcG9zdE1hcFtpXSBdID0gZWxlbSk7CgkJCQl9CgkJCX0KCQl9CgoJCWlmICggc2VlZCApIHsKCQkJaWYgKCBwb3N0RmluZGVyIHx8IHByZUZpbHRlciApIHsKCQkJCWlmICggcG9zdEZpbmRlciApIHsKCQkJCQkvLyBHZXQgdGhlIGZpbmFsIG1hdGNoZXJPdXQgYnkgY29uZGVuc2luZyB0aGlzIGludGVybWVkaWF0ZSBpbnRvIHBvc3RGaW5kZXIgY29udGV4dHMKCQkJCQl0ZW1wID0gW107CgkJCQkJaSA9IG1hdGNoZXJPdXQubGVuZ3RoOwoJCQkJCXdoaWxlICggaS0tICkgewoJCQkJCQlpZiAoIChlbGVtID0gbWF0Y2hlck91dFtpXSkgKSB7CgkJCQkJCQkvLyBSZXN0b3JlIG1hdGNoZXJJbiBzaW5jZSBlbGVtIGlzIG5vdCB5ZXQgYSBmaW5hbCBtYXRjaAoJCQkJCQkJdGVtcC5wdXNoKCAobWF0Y2hlckluW2ldID0gZWxlbSkgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQlwb3N0RmluZGVyKCBudWxsLCAobWF0Y2hlck91dCA9IFtdKSwgdGVtcCwgeG1sICk7CgkJCQl9CgoJCQkJLy8gTW92ZSBtYXRjaGVkIGVsZW1lbnRzIGZyb20gc2VlZCB0byByZXN1bHRzIHRvIGtlZXAgdGhlbSBzeW5jaHJvbml6ZWQKCQkJCWkgPSBtYXRjaGVyT3V0Lmxlbmd0aDsKCQkJCXdoaWxlICggaS0tICkgewoJCQkJCWlmICggKGVsZW0gPSBtYXRjaGVyT3V0W2ldKSAmJgoJCQkJCQkodGVtcCA9IHBvc3RGaW5kZXIgPyBpbmRleE9mLmNhbGwoIHNlZWQsIGVsZW0gKSA6IHByZU1hcFtpXSkgPiAtMSApIHsKCgkJCQkJCXNlZWRbdGVtcF0gPSAhKHJlc3VsdHNbdGVtcF0gPSBlbGVtKTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJLy8gQWRkIGVsZW1lbnRzIHRvIHJlc3VsdHMsIHRocm91Z2ggcG9zdEZpbmRlciBpZiBkZWZpbmVkCgkJfSBlbHNlIHsKCQkJbWF0Y2hlck91dCA9IGNvbmRlbnNlKAoJCQkJbWF0Y2hlck91dCA9PT0gcmVzdWx0cyA/CgkJCQkJbWF0Y2hlck91dC5zcGxpY2UoIHByZWV4aXN0aW5nLCBtYXRjaGVyT3V0Lmxlbmd0aCApIDoKCQkJCQltYXRjaGVyT3V0CgkJCSk7CgkJCWlmICggcG9zdEZpbmRlciApIHsKCQkJCXBvc3RGaW5kZXIoIG51bGwsIHJlc3VsdHMsIG1hdGNoZXJPdXQsIHhtbCApOwoJCQl9IGVsc2UgewoJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgbWF0Y2hlck91dCApOwoJCQl9CgkJfQoJfSk7Cn0KCmZ1bmN0aW9uIG1hdGNoZXJGcm9tVG9rZW5zKCB0b2tlbnMgKSB7Cgl2YXIgY2hlY2tDb250ZXh0LCBtYXRjaGVyLCBqLAoJCWxlbiA9IHRva2Vucy5sZW5ndGgsCgkJbGVhZGluZ1JlbGF0aXZlID0gRXhwci5yZWxhdGl2ZVsgdG9rZW5zWzBdLnR5cGUgXSwKCQlpbXBsaWNpdFJlbGF0aXZlID0gbGVhZGluZ1JlbGF0aXZlIHx8IEV4cHIucmVsYXRpdmVbIiAiXSwKCQlpID0gbGVhZGluZ1JlbGF0aXZlID8gMSA6IDAsCgoJCS8vIFRoZSBmb3VuZGF0aW9uYWwgbWF0Y2hlciBlbnN1cmVzIHRoYXQgZWxlbWVudHMgYXJlIHJlYWNoYWJsZSBmcm9tIHRvcC1sZXZlbCBjb250ZXh0KHMpCgkJbWF0Y2hDb250ZXh0ID0gYWRkQ29tYmluYXRvciggZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtID09PSBjaGVja0NvbnRleHQ7CgkJfSwgaW1wbGljaXRSZWxhdGl2ZSwgdHJ1ZSApLAoJCW1hdGNoQW55Q29udGV4dCA9IGFkZENvbWJpbmF0b3IoIGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gaW5kZXhPZi5jYWxsKCBjaGVja0NvbnRleHQsIGVsZW0gKSA+IC0xOwoJCX0sIGltcGxpY2l0UmVsYXRpdmUsIHRydWUgKSwKCQltYXRjaGVycyA9IFsgZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQsIHhtbCApIHsKCQkJcmV0dXJuICggIWxlYWRpbmdSZWxhdGl2ZSAmJiAoIHhtbCB8fCBjb250ZXh0ICE9PSBvdXRlcm1vc3RDb250ZXh0ICkgKSB8fCAoCgkJCQkoY2hlY2tDb250ZXh0ID0gY29udGV4dCkubm9kZVR5cGUgPwoJCQkJCW1hdGNoQ29udGV4dCggZWxlbSwgY29udGV4dCwgeG1sICkgOgoJCQkJCW1hdGNoQW55Q29udGV4dCggZWxlbSwgY29udGV4dCwgeG1sICkgKTsKCQl9IF07CgoJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CgkJaWYgKCAobWF0Y2hlciA9IEV4cHIucmVsYXRpdmVbIHRva2Vuc1tpXS50eXBlIF0pICkgewoJCQltYXRjaGVycyA9IFsgYWRkQ29tYmluYXRvcihlbGVtZW50TWF0Y2hlciggbWF0Y2hlcnMgKSwgbWF0Y2hlcikgXTsKCQl9IGVsc2UgewoJCQltYXRjaGVyID0gRXhwci5maWx0ZXJbIHRva2Vuc1tpXS50eXBlIF0uYXBwbHkoIG51bGwsIHRva2Vuc1tpXS5tYXRjaGVzICk7CgoJCQkvLyBSZXR1cm4gc3BlY2lhbCB1cG9uIHNlZWluZyBhIHBvc2l0aW9uYWwgbWF0Y2hlcgoJCQlpZiAoIG1hdGNoZXJbIGV4cGFuZG8gXSApIHsKCQkJCS8vIEZpbmQgdGhlIG5leHQgcmVsYXRpdmUgb3BlcmF0b3IgKGlmIGFueSkgZm9yIHByb3BlciBoYW5kbGluZwoJCQkJaiA9ICsraTsKCQkJCWZvciAoIDsgaiA8IGxlbjsgaisrICkgewoJCQkJCWlmICggRXhwci5yZWxhdGl2ZVsgdG9rZW5zW2pdLnR5cGUgXSApIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuIHNldE1hdGNoZXIoCgkJCQkJaSA+IDEgJiYgZWxlbWVudE1hdGNoZXIoIG1hdGNoZXJzICksCgkJCQkJaSA+IDEgJiYgdG9TZWxlY3RvcigKCQkJCQkJLy8gSWYgdGhlIHByZWNlZGluZyB0b2tlbiB3YXMgYSBkZXNjZW5kYW50IGNvbWJpbmF0b3IsIGluc2VydCBhbiBpbXBsaWNpdCBhbnktZWxlbWVudCBgKmAKCQkJCQkJdG9rZW5zLnNsaWNlKCAwLCBpIC0gMSApLmNvbmNhdCh7IHZhbHVlOiB0b2tlbnNbIGkgLSAyIF0udHlwZSA9PT0gIiAiID8gIioiIDogIiIgfSkKCQkJCQkpLnJlcGxhY2UoIHJ0cmltLCAiJDEiICksCgkJCQkJbWF0Y2hlciwKCQkJCQlpIDwgaiAmJiBtYXRjaGVyRnJvbVRva2VucyggdG9rZW5zLnNsaWNlKCBpLCBqICkgKSwKCQkJCQlqIDwgbGVuICYmIG1hdGNoZXJGcm9tVG9rZW5zKCAodG9rZW5zID0gdG9rZW5zLnNsaWNlKCBqICkpICksCgkJCQkJaiA8IGxlbiAmJiB0b1NlbGVjdG9yKCB0b2tlbnMgKQoJCQkJKTsKCQkJfQoJCQltYXRjaGVycy5wdXNoKCBtYXRjaGVyICk7CgkJfQoJfQoKCXJldHVybiBlbGVtZW50TWF0Y2hlciggbWF0Y2hlcnMgKTsKfQoKZnVuY3Rpb24gbWF0Y2hlckZyb21Hcm91cE1hdGNoZXJzKCBlbGVtZW50TWF0Y2hlcnMsIHNldE1hdGNoZXJzICkgewoJdmFyIGJ5U2V0ID0gc2V0TWF0Y2hlcnMubGVuZ3RoID4gMCwKCQlieUVsZW1lbnQgPSBlbGVtZW50TWF0Y2hlcnMubGVuZ3RoID4gMCwKCQlzdXBlck1hdGNoZXIgPSBmdW5jdGlvbiggc2VlZCwgY29udGV4dCwgeG1sLCByZXN1bHRzLCBvdXRlcm1vc3QgKSB7CgkJCXZhciBlbGVtLCBqLCBtYXRjaGVyLAoJCQkJbWF0Y2hlZENvdW50ID0gMCwKCQkJCWkgPSAiMCIsCgkJCQl1bm1hdGNoZWQgPSBzZWVkICYmIFtdLAoJCQkJc2V0TWF0Y2hlZCA9IFtdLAoJCQkJY29udGV4dEJhY2t1cCA9IG91dGVybW9zdENvbnRleHQsCgkJCQkvLyBXZSBtdXN0IGFsd2F5cyBoYXZlIGVpdGhlciBzZWVkIGVsZW1lbnRzIG9yIG91dGVybW9zdCBjb250ZXh0CgkJCQllbGVtcyA9IHNlZWQgfHwgYnlFbGVtZW50ICYmIEV4cHIuZmluZFsiVEFHIl0oICIqIiwgb3V0ZXJtb3N0ICksCgkJCQkvLyBVc2UgaW50ZWdlciBkaXJydW5zIGlmZiB0aGlzIGlzIHRoZSBvdXRlcm1vc3QgbWF0Y2hlcgoJCQkJZGlycnVuc1VuaXF1ZSA9IChkaXJydW5zICs9IGNvbnRleHRCYWNrdXAgPT0gbnVsbCA/IDEgOiBNYXRoLnJhbmRvbSgpIHx8IDAuMSksCgkJCQlsZW4gPSBlbGVtcy5sZW5ndGg7CgoJCQlpZiAoIG91dGVybW9zdCApIHsKCQkJCW91dGVybW9zdENvbnRleHQgPSBjb250ZXh0ICE9PSBkb2N1bWVudCAmJiBjb250ZXh0OwoJCQl9CgoJCQkvLyBBZGQgZWxlbWVudHMgcGFzc2luZyBlbGVtZW50TWF0Y2hlcnMgZGlyZWN0bHkgdG8gcmVzdWx0cwoJCQkvLyBLZWVwIGBpYCBhIHN0cmluZyBpZiB0aGVyZSBhcmUgbm8gZWxlbWVudHMgc28gYG1hdGNoZWRDb3VudGAgd2lsbCBiZSAiMDAiIGJlbG93CgkJCS8vIFN1cHBvcnQ6IElFPDksIFNhZmFyaQoJCQkvLyBUb2xlcmF0ZSBOb2RlTGlzdCBwcm9wZXJ0aWVzIChJRTogImxlbmd0aCI7IFNhZmFyaTogPG51bWJlcj4pIG1hdGNoaW5nIGVsZW1lbnRzIGJ5IGlkCgkJCWZvciAoIDsgaSAhPT0gbGVuICYmIChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQkJCWlmICggYnlFbGVtZW50ICYmIGVsZW0gKSB7CgkJCQkJaiA9IDA7CgkJCQkJd2hpbGUgKCAobWF0Y2hlciA9IGVsZW1lbnRNYXRjaGVyc1tqKytdKSApIHsKCQkJCQkJaWYgKCBtYXRjaGVyKCBlbGVtLCBjb250ZXh0LCB4bWwgKSApIHsKCQkJCQkJCXJlc3VsdHMucHVzaCggZWxlbSApOwoJCQkJCQkJYnJlYWs7CgkJCQkJCX0KCQkJCQl9CgkJCQkJaWYgKCBvdXRlcm1vc3QgKSB7CgkJCQkJCWRpcnJ1bnMgPSBkaXJydW5zVW5pcXVlOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBUcmFjayB1bm1hdGNoZWQgZWxlbWVudHMgZm9yIHNldCBmaWx0ZXJzCgkJCQlpZiAoIGJ5U2V0ICkgewoJCQkJCS8vIFRoZXkgd2lsbCBoYXZlIGdvbmUgdGhyb3VnaCBhbGwgcG9zc2libGUgbWF0Y2hlcnMKCQkJCQlpZiAoIChlbGVtID0gIW1hdGNoZXIgJiYgZWxlbSkgKSB7CgkJCQkJCW1hdGNoZWRDb3VudC0tOwoJCQkJCX0KCgkJCQkJLy8gTGVuZ3RoZW4gdGhlIGFycmF5IGZvciBldmVyeSBlbGVtZW50LCBtYXRjaGVkIG9yIG5vdAoJCQkJCWlmICggc2VlZCApIHsKCQkJCQkJdW5tYXRjaGVkLnB1c2goIGVsZW0gKTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCS8vIEFwcGx5IHNldCBmaWx0ZXJzIHRvIHVubWF0Y2hlZCBlbGVtZW50cwoJCQltYXRjaGVkQ291bnQgKz0gaTsKCQkJaWYgKCBieVNldCAmJiBpICE9PSBtYXRjaGVkQ291bnQgKSB7CgkJCQlqID0gMDsKCQkJCXdoaWxlICggKG1hdGNoZXIgPSBzZXRNYXRjaGVyc1tqKytdKSApIHsKCQkJCQltYXRjaGVyKCB1bm1hdGNoZWQsIHNldE1hdGNoZWQsIGNvbnRleHQsIHhtbCApOwoJCQkJfQoKCQkJCWlmICggc2VlZCApIHsKCQkJCQkvLyBSZWludGVncmF0ZSBlbGVtZW50IG1hdGNoZXMgdG8gZWxpbWluYXRlIHRoZSBuZWVkIGZvciBzb3J0aW5nCgkJCQkJaWYgKCBtYXRjaGVkQ291bnQgPiAwICkgewoJCQkJCQl3aGlsZSAoIGktLSApIHsKCQkJCQkJCWlmICggISh1bm1hdGNoZWRbaV0gfHwgc2V0TWF0Y2hlZFtpXSkgKSB7CgkJCQkJCQkJc2V0TWF0Y2hlZFtpXSA9IHBvcC5jYWxsKCByZXN1bHRzICk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgoJCQkJCS8vIERpc2NhcmQgaW5kZXggcGxhY2Vob2xkZXIgdmFsdWVzIHRvIGdldCBvbmx5IGFjdHVhbCBtYXRjaGVzCgkJCQkJc2V0TWF0Y2hlZCA9IGNvbmRlbnNlKCBzZXRNYXRjaGVkICk7CgkJCQl9CgoJCQkJLy8gQWRkIG1hdGNoZXMgdG8gcmVzdWx0cwoJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgc2V0TWF0Y2hlZCApOwoKCQkJCS8vIFNlZWRsZXNzIHNldCBtYXRjaGVzIHN1Y2NlZWRpbmcgbXVsdGlwbGUgc3VjY2Vzc2Z1bCBtYXRjaGVycyBzdGlwdWxhdGUgc29ydGluZwoJCQkJaWYgKCBvdXRlcm1vc3QgJiYgIXNlZWQgJiYgc2V0TWF0Y2hlZC5sZW5ndGggPiAwICYmCgkJCQkJKCBtYXRjaGVkQ291bnQgKyBzZXRNYXRjaGVycy5sZW5ndGggKSA+IDEgKSB7CgoJCQkJCVNpenpsZS51bmlxdWVTb3J0KCByZXN1bHRzICk7CgkJCQl9CgkJCX0KCgkJCS8vIE92ZXJyaWRlIG1hbmlwdWxhdGlvbiBvZiBnbG9iYWxzIGJ5IG5lc3RlZCBtYXRjaGVycwoJCQlpZiAoIG91dGVybW9zdCApIHsKCQkJCWRpcnJ1bnMgPSBkaXJydW5zVW5pcXVlOwoJCQkJb3V0ZXJtb3N0Q29udGV4dCA9IGNvbnRleHRCYWNrdXA7CgkJCX0KCgkJCXJldHVybiB1bm1hdGNoZWQ7CgkJfTsKCglyZXR1cm4gYnlTZXQgPwoJCW1hcmtGdW5jdGlvbiggc3VwZXJNYXRjaGVyICkgOgoJCXN1cGVyTWF0Y2hlcjsKfQoKY29tcGlsZSA9IFNpenpsZS5jb21waWxlID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBncm91cCAvKiBJbnRlcm5hbCBVc2UgT25seSAqLyApIHsKCXZhciBpLAoJCXNldE1hdGNoZXJzID0gW10sCgkJZWxlbWVudE1hdGNoZXJzID0gW10sCgkJY2FjaGVkID0gY29tcGlsZXJDYWNoZVsgc2VsZWN0b3IgKyAiICIgXTsKCglpZiAoICFjYWNoZWQgKSB7CgkJLy8gR2VuZXJhdGUgYSBmdW5jdGlvbiBvZiByZWN1cnNpdmUgZnVuY3Rpb25zIHRoYXQgY2FuIGJlIHVzZWQgdG8gY2hlY2sgZWFjaCBlbGVtZW50CgkJaWYgKCAhZ3JvdXAgKSB7CgkJCWdyb3VwID0gdG9rZW5pemUoIHNlbGVjdG9yICk7CgkJfQoJCWkgPSBncm91cC5sZW5ndGg7CgkJd2hpbGUgKCBpLS0gKSB7CgkJCWNhY2hlZCA9IG1hdGNoZXJGcm9tVG9rZW5zKCBncm91cFtpXSApOwoJCQlpZiAoIGNhY2hlZFsgZXhwYW5kbyBdICkgewoJCQkJc2V0TWF0Y2hlcnMucHVzaCggY2FjaGVkICk7CgkJCX0gZWxzZSB7CgkJCQllbGVtZW50TWF0Y2hlcnMucHVzaCggY2FjaGVkICk7CgkJCX0KCQl9CgoJCS8vIENhY2hlIHRoZSBjb21waWxlZCBmdW5jdGlvbgoJCWNhY2hlZCA9IGNvbXBpbGVyQ2FjaGUoIHNlbGVjdG9yLCBtYXRjaGVyRnJvbUdyb3VwTWF0Y2hlcnMoIGVsZW1lbnRNYXRjaGVycywgc2V0TWF0Y2hlcnMgKSApOwoJfQoJcmV0dXJuIGNhY2hlZDsKfTsKCmZ1bmN0aW9uIG11bHRpcGxlQ29udGV4dHMoIHNlbGVjdG9yLCBjb250ZXh0cywgcmVzdWx0cyApIHsKCXZhciBpID0gMCwKCQlsZW4gPSBjb250ZXh0cy5sZW5ndGg7Cglmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQlTaXp6bGUoIHNlbGVjdG9yLCBjb250ZXh0c1tpXSwgcmVzdWx0cyApOwoJfQoJcmV0dXJuIHJlc3VsdHM7Cn0KCmZ1bmN0aW9uIHNlbGVjdCggc2VsZWN0b3IsIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQgKSB7Cgl2YXIgaSwgdG9rZW5zLCB0b2tlbiwgdHlwZSwgZmluZCwKCQltYXRjaCA9IHRva2VuaXplKCBzZWxlY3RvciApOwoKCWlmICggIXNlZWQgKSB7CgkJLy8gVHJ5IHRvIG1pbmltaXplIG9wZXJhdGlvbnMgaWYgdGhlcmUgaXMgb25seSBvbmUgZ3JvdXAKCQlpZiAoIG1hdGNoLmxlbmd0aCA9PT0gMSApIHsKCgkJCS8vIFRha2UgYSBzaG9ydGN1dCBhbmQgc2V0IHRoZSBjb250ZXh0IGlmIHRoZSByb290IHNlbGVjdG9yIGlzIGFuIElECgkJCXRva2VucyA9IG1hdGNoWzBdID0gbWF0Y2hbMF0uc2xpY2UoIDAgKTsKCQkJaWYgKCB0b2tlbnMubGVuZ3RoID4gMiAmJiAodG9rZW4gPSB0b2tlbnNbMF0pLnR5cGUgPT09ICJJRCIgJiYKCQkJCQlzdXBwb3J0LmdldEJ5SWQgJiYgY29udGV4dC5ub2RlVHlwZSA9PT0gOSAmJiBkb2N1bWVudElzSFRNTCAmJgoJCQkJCUV4cHIucmVsYXRpdmVbIHRva2Vuc1sxXS50eXBlIF0gKSB7CgoJCQkJY29udGV4dCA9ICggRXhwci5maW5kWyJJRCJdKCB0b2tlbi5tYXRjaGVzWzBdLnJlcGxhY2UocnVuZXNjYXBlLCBmdW5lc2NhcGUpLCBjb250ZXh0ICkgfHwgW10gKVswXTsKCQkJCWlmICggIWNvbnRleHQgKSB7CgkJCQkJcmV0dXJuIHJlc3VsdHM7CgkJCQl9CgkJCQlzZWxlY3RvciA9IHNlbGVjdG9yLnNsaWNlKCB0b2tlbnMuc2hpZnQoKS52YWx1ZS5sZW5ndGggKTsKCQkJfQoKCQkJLy8gRmV0Y2ggYSBzZWVkIHNldCBmb3IgcmlnaHQtdG8tbGVmdCBtYXRjaGluZwoJCQlpID0gbWF0Y2hFeHByWyJuZWVkc0NvbnRleHQiXS50ZXN0KCBzZWxlY3RvciApID8gMCA6IHRva2Vucy5sZW5ndGg7CgkJCXdoaWxlICggaS0tICkgewoJCQkJdG9rZW4gPSB0b2tlbnNbaV07CgoJCQkJLy8gQWJvcnQgaWYgd2UgaGl0IGEgY29tYmluYXRvcgoJCQkJaWYgKCBFeHByLnJlbGF0aXZlWyAodHlwZSA9IHRva2VuLnR5cGUpIF0gKSB7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCQlpZiAoIChmaW5kID0gRXhwci5maW5kWyB0eXBlIF0pICkgewoJCQkJCS8vIFNlYXJjaCwgZXhwYW5kaW5nIGNvbnRleHQgZm9yIGxlYWRpbmcgc2libGluZyBjb21iaW5hdG9ycwoJCQkJCWlmICggKHNlZWQgPSBmaW5kKAoJCQkJCQl0b2tlbi5tYXRjaGVzWzBdLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICksCgkJCQkJCXJzaWJsaW5nLnRlc3QoIHRva2Vuc1swXS50eXBlICkgJiYgdGVzdENvbnRleHQoIGNvbnRleHQucGFyZW50Tm9kZSApIHx8IGNvbnRleHQKCQkJCQkpKSApIHsKCgkJCQkJCS8vIElmIHNlZWQgaXMgZW1wdHkgb3Igbm8gdG9rZW5zIHJlbWFpbiwgd2UgY2FuIHJldHVybiBlYXJseQoJCQkJCQl0b2tlbnMuc3BsaWNlKCBpLCAxICk7CgkJCQkJCXNlbGVjdG9yID0gc2VlZC5sZW5ndGggJiYgdG9TZWxlY3RvciggdG9rZW5zICk7CgkJCQkJCWlmICggIXNlbGVjdG9yICkgewoJCQkJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgc2VlZCApOwoJCQkJCQkJcmV0dXJuIHJlc3VsdHM7CgkJCQkJCX0KCgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCX0KCgkvLyBDb21waWxlIGFuZCBleGVjdXRlIGEgZmlsdGVyaW5nIGZ1bmN0aW9uCgkvLyBQcm92aWRlIGBtYXRjaGAgdG8gYXZvaWQgcmV0b2tlbml6YXRpb24gaWYgd2UgbW9kaWZpZWQgdGhlIHNlbGVjdG9yIGFib3ZlCgljb21waWxlKCBzZWxlY3RvciwgbWF0Y2ggKSgKCQlzZWVkLAoJCWNvbnRleHQsCgkJIWRvY3VtZW50SXNIVE1MLAoJCXJlc3VsdHMsCgkJcnNpYmxpbmcudGVzdCggc2VsZWN0b3IgKSAmJiB0ZXN0Q29udGV4dCggY29udGV4dC5wYXJlbnROb2RlICkgfHwgY29udGV4dAoJKTsKCXJldHVybiByZXN1bHRzOwp9CgovLyBPbmUtdGltZSBhc3NpZ25tZW50cwoKLy8gU29ydCBzdGFiaWxpdHkKc3VwcG9ydC5zb3J0U3RhYmxlID0gZXhwYW5kby5zcGxpdCgiIikuc29ydCggc29ydE9yZGVyICkuam9pbigiIikgPT09IGV4cGFuZG87CgovLyBTdXBwb3J0OiBDaHJvbWU8MTQKLy8gQWx3YXlzIGFzc3VtZSBkdXBsaWNhdGVzIGlmIHRoZXkgYXJlbid0IHBhc3NlZCB0byB0aGUgY29tcGFyaXNvbiBmdW5jdGlvbgpzdXBwb3J0LmRldGVjdER1cGxpY2F0ZXMgPSAhIWhhc0R1cGxpY2F0ZTsKCi8vIEluaXRpYWxpemUgYWdhaW5zdCB0aGUgZGVmYXVsdCBkb2N1bWVudApzZXREb2N1bWVudCgpOwoKLy8gU3VwcG9ydDogV2Via2l0PDUzNy4zMiAtIFNhZmFyaSA2LjAuMy9DaHJvbWUgMjUgKGZpeGVkIGluIENocm9tZSAyNykKLy8gRGV0YWNoZWQgbm9kZXMgY29uZm91bmRpbmdseSBmb2xsb3cgKmVhY2ggb3RoZXIqCnN1cHBvcnQuc29ydERldGFjaGVkID0gYXNzZXJ0KGZ1bmN0aW9uKCBkaXYxICkgewoJLy8gU2hvdWxkIHJldHVybiAxLCBidXQgcmV0dXJucyA0IChmb2xsb3dpbmcpCglyZXR1cm4gZGl2MS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikgKSAmIDE7Cn0pOwoKLy8gU3VwcG9ydDogSUU8OAovLyBQcmV2ZW50IGF0dHJpYnV0ZS9wcm9wZXJ0eSAiaW50ZXJwb2xhdGlvbiIKLy8gaHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L21zNTM2NDI5JTI4VlMuODUlMjkuYXNweAppZiAoICFhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCWRpdi5pbm5lckhUTUwgPSAiPGEgaHJlZj0nIyc+PC9hPiI7CglyZXR1cm4gZGl2LmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlKCJocmVmIikgPT09ICIjIiA7Cn0pICkgewoJYWRkSGFuZGxlKCAidHlwZXxocmVmfGhlaWdodHx3aWR0aCIsIGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBpc1hNTCApIHsKCQlpZiAoICFpc1hNTCApIHsKCQkJcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lLCBuYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJ0eXBlIiA/IDEgOiAyICk7CgkJfQoJfSk7Cn0KCi8vIFN1cHBvcnQ6IElFPDkKLy8gVXNlIGRlZmF1bHRWYWx1ZSBpbiBwbGFjZSBvZiBnZXRBdHRyaWJ1dGUoInZhbHVlIikKaWYgKCAhc3VwcG9ydC5hdHRyaWJ1dGVzIHx8ICFhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCWRpdi5pbm5lckhUTUwgPSAiPGlucHV0Lz4iOwoJZGl2LmZpcnN0Q2hpbGQuc2V0QXR0cmlidXRlKCAidmFsdWUiLCAiIiApOwoJcmV0dXJuIGRpdi5maXJzdENoaWxkLmdldEF0dHJpYnV0ZSggInZhbHVlIiApID09PSAiIjsKfSkgKSB7CglhZGRIYW5kbGUoICJ2YWx1ZSIsIGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBpc1hNTCApIHsKCQlpZiAoICFpc1hNTCAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJpbnB1dCIgKSB7CgkJCXJldHVybiBlbGVtLmRlZmF1bHRWYWx1ZTsKCQl9Cgl9KTsKfQoKLy8gU3VwcG9ydDogSUU8OQovLyBVc2UgZ2V0QXR0cmlidXRlTm9kZSB0byBmZXRjaCBib29sZWFucyB3aGVuIGdldEF0dHJpYnV0ZSBsaWVzCmlmICggIWFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJcmV0dXJuIGRpdi5nZXRBdHRyaWJ1dGUoImRpc2FibGVkIikgPT0gbnVsbDsKfSkgKSB7CglhZGRIYW5kbGUoIGJvb2xlYW5zLCBmdW5jdGlvbiggZWxlbSwgbmFtZSwgaXNYTUwgKSB7CgkJdmFyIHZhbDsKCQlpZiAoICFpc1hNTCApIHsKCQkJcmV0dXJuIGVsZW1bIG5hbWUgXSA9PT0gdHJ1ZSA/IG5hbWUudG9Mb3dlckNhc2UoKSA6CgkJCQkJKHZhbCA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZSggbmFtZSApKSAmJiB2YWwuc3BlY2lmaWVkID8KCQkJCQl2YWwudmFsdWUgOgoJCQkJbnVsbDsKCQl9Cgl9KTsKfQoKcmV0dXJuIFNpenpsZTsKCn0pKCB3aW5kb3cgKTsKCgoKalF1ZXJ5LmZpbmQgPSBTaXp6bGU7CmpRdWVyeS5leHByID0gU2l6emxlLnNlbGVjdG9yczsKalF1ZXJ5LmV4cHJbIjoiXSA9IGpRdWVyeS5leHByLnBzZXVkb3M7CmpRdWVyeS51bmlxdWUgPSBTaXp6bGUudW5pcXVlU29ydDsKalF1ZXJ5LnRleHQgPSBTaXp6bGUuZ2V0VGV4dDsKalF1ZXJ5LmlzWE1MRG9jID0gU2l6emxlLmlzWE1MOwpqUXVlcnkuY29udGFpbnMgPSBTaXp6bGUuY29udGFpbnM7CgoKCnZhciBybmVlZHNDb250ZXh0ID0galF1ZXJ5LmV4cHIubWF0Y2gubmVlZHNDb250ZXh0OwoKdmFyIHJzaW5nbGVUYWcgPSAoL148KFx3KylccypcLz8+KD86PFwvXDE+fCkkLyk7CgoKCnZhciByaXNTaW1wbGUgPSAvXi5bXjojXFtcLixdKiQvOwoKLy8gSW1wbGVtZW50IHRoZSBpZGVudGljYWwgZnVuY3Rpb25hbGl0eSBmb3IgZmlsdGVyIGFuZCBub3QKZnVuY3Rpb24gd2lubm93KCBlbGVtZW50cywgcXVhbGlmaWVyLCBub3QgKSB7CglpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBxdWFsaWZpZXIgKSApIHsKCQlyZXR1cm4galF1ZXJ5LmdyZXAoIGVsZW1lbnRzLCBmdW5jdGlvbiggZWxlbSwgaSApIHsKCQkJLyoganNoaW50IC1XMDE4ICovCgkJCXJldHVybiAhIXF1YWxpZmllci5jYWxsKCBlbGVtLCBpLCBlbGVtICkgIT09IG5vdDsKCQl9KTsKCgl9CgoJaWYgKCBxdWFsaWZpZXIubm9kZVR5cGUgKSB7CgkJcmV0dXJuIGpRdWVyeS5ncmVwKCBlbGVtZW50cywgZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiAoIGVsZW0gPT09IHF1YWxpZmllciApICE9PSBub3Q7CgkJfSk7CgoJfQoKCWlmICggdHlwZW9mIHF1YWxpZmllciA9PT0gInN0cmluZyIgKSB7CgkJaWYgKCByaXNTaW1wbGUudGVzdCggcXVhbGlmaWVyICkgKSB7CgkJCXJldHVybiBqUXVlcnkuZmlsdGVyKCBxdWFsaWZpZXIsIGVsZW1lbnRzLCBub3QgKTsKCQl9CgoJCXF1YWxpZmllciA9IGpRdWVyeS5maWx0ZXIoIHF1YWxpZmllciwgZWxlbWVudHMgKTsKCX0KCglyZXR1cm4galF1ZXJ5LmdyZXAoIGVsZW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gKCBqUXVlcnkuaW5BcnJheSggZWxlbSwgcXVhbGlmaWVyICkgPj0gMCApICE9PSBub3Q7Cgl9KTsKfQoKalF1ZXJ5LmZpbHRlciA9IGZ1bmN0aW9uKCBleHByLCBlbGVtcywgbm90ICkgewoJdmFyIGVsZW0gPSBlbGVtc1sgMCBdOwoKCWlmICggbm90ICkgewoJCWV4cHIgPSAiOm5vdCgiICsgZXhwciArICIpIjsKCX0KCglyZXR1cm4gZWxlbXMubGVuZ3RoID09PSAxICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgPwoJCWpRdWVyeS5maW5kLm1hdGNoZXNTZWxlY3RvciggZWxlbSwgZXhwciApID8gWyBlbGVtIF0gOiBbXSA6CgkJalF1ZXJ5LmZpbmQubWF0Y2hlcyggZXhwciwgalF1ZXJ5LmdyZXAoIGVsZW1zLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0ubm9kZVR5cGUgPT09IDE7CgkJfSkpOwp9OwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglmaW5kOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJdmFyIGksCgkJCXJldCA9IFtdLAoJCQlzZWxmID0gdGhpcywKCQkJbGVuID0gc2VsZi5sZW5ndGg7CgoJCWlmICggdHlwZW9mIHNlbGVjdG9yICE9PSAic3RyaW5nIiApIHsKCQkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqUXVlcnkoIHNlbGVjdG9yICkuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQkJZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsKCQkJCQlpZiAoIGpRdWVyeS5jb250YWlucyggc2VsZlsgaSBdLCB0aGlzICkgKSB7CgkJCQkJCXJldHVybiB0cnVlOwoJCQkJCX0KCQkJCX0KCQkJfSkgKTsKCQl9CgoJCWZvciAoIGkgPSAwOyBpIDwgbGVuOyBpKysgKSB7CgkJCWpRdWVyeS5maW5kKCBzZWxlY3Rvciwgc2VsZlsgaSBdLCByZXQgKTsKCQl9CgoJCS8vIE5lZWRlZCBiZWNhdXNlICQoIHNlbGVjdG9yLCBjb250ZXh0ICkgYmVjb21lcyAkKCBjb250ZXh0ICkuZmluZCggc2VsZWN0b3IgKQoJCXJldCA9IHRoaXMucHVzaFN0YWNrKCBsZW4gPiAxID8galF1ZXJ5LnVuaXF1ZSggcmV0ICkgOiByZXQgKTsKCQlyZXQuc2VsZWN0b3IgPSB0aGlzLnNlbGVjdG9yID8gdGhpcy5zZWxlY3RvciArICIgIiArIHNlbGVjdG9yIDogc2VsZWN0b3I7CgkJcmV0dXJuIHJldDsKCX0sCglmaWx0ZXI6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHdpbm5vdyh0aGlzLCBzZWxlY3RvciB8fCBbXSwgZmFsc2UpICk7Cgl9LAoJbm90OiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCB3aW5ub3codGhpcywgc2VsZWN0b3IgfHwgW10sIHRydWUpICk7Cgl9LAoJaXM6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gISF3aW5ub3coCgkJCXRoaXMsCgoJCQkvLyBJZiB0aGlzIGlzIGEgcG9zaXRpb25hbC9yZWxhdGl2ZSBzZWxlY3RvciwgY2hlY2sgbWVtYmVyc2hpcCBpbiB0aGUgcmV0dXJuZWQgc2V0CgkJCS8vIHNvICQoInA6Zmlyc3QiKS5pcygicDpsYXN0Iikgd29uJ3QgcmV0dXJuIHRydWUgZm9yIGEgZG9jIHdpdGggdHdvICJwIi4KCQkJdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiAmJiBybmVlZHNDb250ZXh0LnRlc3QoIHNlbGVjdG9yICkgPwoJCQkJalF1ZXJ5KCBzZWxlY3RvciApIDoKCQkJCXNlbGVjdG9yIHx8IFtdLAoJCQlmYWxzZQoJCSkubGVuZ3RoOwoJfQp9KTsKCgovLyBJbml0aWFsaXplIGEgalF1ZXJ5IG9iamVjdAoKCi8vIEEgY2VudHJhbCByZWZlcmVuY2UgdG8gdGhlIHJvb3QgalF1ZXJ5KGRvY3VtZW50KQp2YXIgcm9vdGpRdWVyeSwKCgkvLyBVc2UgdGhlIGNvcnJlY3QgZG9jdW1lbnQgYWNjb3JkaW5nbHkgd2l0aCB3aW5kb3cgYXJndW1lbnQgKHNhbmRib3gpCglkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudCwKCgkvLyBBIHNpbXBsZSB3YXkgdG8gY2hlY2sgZm9yIEhUTUwgc3RyaW5ncwoJLy8gUHJpb3JpdGl6ZSAjaWQgb3ZlciA8dGFnPiB0byBhdm9pZCBYU1MgdmlhIGxvY2F0aW9uLmhhc2ggKCM5NTIxKQoJLy8gU3RyaWN0IEhUTUwgcmVjb2duaXRpb24gKCMxMTI5MDogbXVzdCBzdGFydCB3aXRoIDwpCglycXVpY2tFeHByID0gL14oPzpccyooPFtcd1xXXSs+KVtePl0qfCMoW1x3LV0qKSkkLywKCglpbml0ID0galF1ZXJ5LmZuLmluaXQgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQgKSB7CgkJdmFyIG1hdGNoLCBlbGVtOwoKCQkvLyBIQU5ETEU6ICQoIiIpLCAkKG51bGwpLCAkKHVuZGVmaW5lZCksICQoZmFsc2UpCgkJaWYgKCAhc2VsZWN0b3IgKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gSGFuZGxlIEhUTUwgc3RyaW5ncwoJCWlmICggdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiApIHsKCQkJaWYgKCBzZWxlY3Rvci5jaGFyQXQoMCkgPT09ICI8IiAmJiBzZWxlY3Rvci5jaGFyQXQoIHNlbGVjdG9yLmxlbmd0aCAtIDEgKSA9PT0gIj4iICYmIHNlbGVjdG9yLmxlbmd0aCA+PSAzICkgewoJCQkJLy8gQXNzdW1lIHRoYXQgc3RyaW5ncyB0aGF0IHN0YXJ0IGFuZCBlbmQgd2l0aCA8PiBhcmUgSFRNTCBhbmQgc2tpcCB0aGUgcmVnZXggY2hlY2sKCQkJCW1hdGNoID0gWyBudWxsLCBzZWxlY3RvciwgbnVsbCBdOwoKCQkJfSBlbHNlIHsKCQkJCW1hdGNoID0gcnF1aWNrRXhwci5leGVjKCBzZWxlY3RvciApOwoJCQl9CgoJCQkvLyBNYXRjaCBodG1sIG9yIG1ha2Ugc3VyZSBubyBjb250ZXh0IGlzIHNwZWNpZmllZCBmb3IgI2lkCgkJCWlmICggbWF0Y2ggJiYgKG1hdGNoWzFdIHx8ICFjb250ZXh0KSApIHsKCgkJCQkvLyBIQU5ETEU6ICQoaHRtbCkgLT4gJChhcnJheSkKCQkJCWlmICggbWF0Y2hbMV0gKSB7CgkJCQkJY29udGV4dCA9IGNvbnRleHQgaW5zdGFuY2VvZiBqUXVlcnkgPyBjb250ZXh0WzBdIDogY29udGV4dDsKCgkJCQkJLy8gc2NyaXB0cyBpcyB0cnVlIGZvciBiYWNrLWNvbXBhdAoJCQkJCS8vIEludGVudGlvbmFsbHkgbGV0IHRoZSBlcnJvciBiZSB0aHJvd24gaWYgcGFyc2VIVE1MIGlzIG5vdCBwcmVzZW50CgkJCQkJalF1ZXJ5Lm1lcmdlKCB0aGlzLCBqUXVlcnkucGFyc2VIVE1MKAoJCQkJCQltYXRjaFsxXSwKCQkJCQkJY29udGV4dCAmJiBjb250ZXh0Lm5vZGVUeXBlID8gY29udGV4dC5vd25lckRvY3VtZW50IHx8IGNvbnRleHQgOiBkb2N1bWVudCwKCQkJCQkJdHJ1ZQoJCQkJCSkgKTsKCgkJCQkJLy8gSEFORExFOiAkKGh0bWwsIHByb3BzKQoJCQkJCWlmICggcnNpbmdsZVRhZy50ZXN0KCBtYXRjaFsxXSApICYmIGpRdWVyeS5pc1BsYWluT2JqZWN0KCBjb250ZXh0ICkgKSB7CgkJCQkJCWZvciAoIG1hdGNoIGluIGNvbnRleHQgKSB7CgkJCQkJCQkvLyBQcm9wZXJ0aWVzIG9mIGNvbnRleHQgYXJlIGNhbGxlZCBhcyBtZXRob2RzIGlmIHBvc3NpYmxlCgkJCQkJCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCB0aGlzWyBtYXRjaCBdICkgKSB7CgkJCQkJCQkJdGhpc1sgbWF0Y2ggXSggY29udGV4dFsgbWF0Y2ggXSApOwoKCQkJCQkJCS8vIC4uLmFuZCBvdGhlcndpc2Ugc2V0IGFzIGF0dHJpYnV0ZXMKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJdGhpcy5hdHRyKCBtYXRjaCwgY29udGV4dFsgbWF0Y2ggXSApOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoKCQkJCQlyZXR1cm4gdGhpczsKCgkJCQkvLyBIQU5ETEU6ICQoI2lkKQoJCQkJfSBlbHNlIHsKCQkJCQllbGVtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIG1hdGNoWzJdICk7CgoJCQkJCS8vIENoZWNrIHBhcmVudE5vZGUgdG8gY2F0Y2ggd2hlbiBCbGFja2JlcnJ5IDQuNiByZXR1cm5zCgkJCQkJLy8gbm9kZXMgdGhhdCBhcmUgbm8gbG9uZ2VyIGluIHRoZSBkb2N1bWVudCAjNjk2MwoJCQkJCWlmICggZWxlbSAmJiBlbGVtLnBhcmVudE5vZGUgKSB7CgkJCQkJCS8vIEhhbmRsZSB0aGUgY2FzZSB3aGVyZSBJRSBhbmQgT3BlcmEgcmV0dXJuIGl0ZW1zCgkJCQkJCS8vIGJ5IG5hbWUgaW5zdGVhZCBvZiBJRAoJCQkJCQlpZiAoIGVsZW0uaWQgIT09IG1hdGNoWzJdICkgewoJCQkJCQkJcmV0dXJuIHJvb3RqUXVlcnkuZmluZCggc2VsZWN0b3IgKTsKCQkJCQkJfQoKCQkJCQkJLy8gT3RoZXJ3aXNlLCB3ZSBpbmplY3QgdGhlIGVsZW1lbnQgZGlyZWN0bHkgaW50byB0aGUgalF1ZXJ5IG9iamVjdAoJCQkJCQl0aGlzLmxlbmd0aCA9IDE7CgkJCQkJCXRoaXNbMF0gPSBlbGVtOwoJCQkJCX0KCgkJCQkJdGhpcy5jb250ZXh0ID0gZG9jdW1lbnQ7CgkJCQkJdGhpcy5zZWxlY3RvciA9IHNlbGVjdG9yOwoJCQkJCXJldHVybiB0aGlzOwoJCQkJfQoKCQkJLy8gSEFORExFOiAkKGV4cHIsICQoLi4uKSkKCQkJfSBlbHNlIGlmICggIWNvbnRleHQgfHwgY29udGV4dC5qcXVlcnkgKSB7CgkJCQlyZXR1cm4gKCBjb250ZXh0IHx8IHJvb3RqUXVlcnkgKS5maW5kKCBzZWxlY3RvciApOwoKCQkJLy8gSEFORExFOiAkKGV4cHIsIGNvbnRleHQpCgkJCS8vICh3aGljaCBpcyBqdXN0IGVxdWl2YWxlbnQgdG86ICQoY29udGV4dCkuZmluZChleHByKQoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIHRoaXMuY29uc3RydWN0b3IoIGNvbnRleHQgKS5maW5kKCBzZWxlY3RvciApOwoJCQl9CgoJCS8vIEhBTkRMRTogJChET01FbGVtZW50KQoJCX0gZWxzZSBpZiAoIHNlbGVjdG9yLm5vZGVUeXBlICkgewoJCQl0aGlzLmNvbnRleHQgPSB0aGlzWzBdID0gc2VsZWN0b3I7CgkJCXRoaXMubGVuZ3RoID0gMTsKCQkJcmV0dXJuIHRoaXM7CgoJCS8vIEhBTkRMRTogJChmdW5jdGlvbikKCQkvLyBTaG9ydGN1dCBmb3IgZG9jdW1lbnQgcmVhZHkKCQl9IGVsc2UgaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggc2VsZWN0b3IgKSApIHsKCQkJcmV0dXJuIHR5cGVvZiByb290alF1ZXJ5LnJlYWR5ICE9PSAidW5kZWZpbmVkIiA/CgkJCQlyb290alF1ZXJ5LnJlYWR5KCBzZWxlY3RvciApIDoKCQkJCS8vIEV4ZWN1dGUgaW1tZWRpYXRlbHkgaWYgcmVhZHkgaXMgbm90IHByZXNlbnQKCQkJCXNlbGVjdG9yKCBqUXVlcnkgKTsKCQl9CgoJCWlmICggc2VsZWN0b3Iuc2VsZWN0b3IgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5zZWxlY3RvciA9IHNlbGVjdG9yLnNlbGVjdG9yOwoJCQl0aGlzLmNvbnRleHQgPSBzZWxlY3Rvci5jb250ZXh0OwoJCX0KCgkJcmV0dXJuIGpRdWVyeS5tYWtlQXJyYXkoIHNlbGVjdG9yLCB0aGlzICk7Cgl9OwoKLy8gR2l2ZSB0aGUgaW5pdCBmdW5jdGlvbiB0aGUgalF1ZXJ5IHByb3RvdHlwZSBmb3IgbGF0ZXIgaW5zdGFudGlhdGlvbgppbml0LnByb3RvdHlwZSA9IGpRdWVyeS5mbjsKCi8vIEluaXRpYWxpemUgY2VudHJhbCByZWZlcmVuY2UKcm9vdGpRdWVyeSA9IGpRdWVyeSggZG9jdW1lbnQgKTsKCgp2YXIgcnBhcmVudHNwcmV2ID0gL14oPzpwYXJlbnRzfHByZXYoPzpVbnRpbHxBbGwpKS8sCgkvLyBtZXRob2RzIGd1YXJhbnRlZWQgdG8gcHJvZHVjZSBhIHVuaXF1ZSBzZXQgd2hlbiBzdGFydGluZyBmcm9tIGEgdW5pcXVlIHNldAoJZ3VhcmFudGVlZFVuaXF1ZSA9IHsKCQljaGlsZHJlbjogdHJ1ZSwKCQljb250ZW50czogdHJ1ZSwKCQluZXh0OiB0cnVlLAoJCXByZXY6IHRydWUKCX07CgpqUXVlcnkuZXh0ZW5kKHsKCWRpcjogZnVuY3Rpb24oIGVsZW0sIGRpciwgdW50aWwgKSB7CgkJdmFyIG1hdGNoZWQgPSBbXSwKCQkJY3VyID0gZWxlbVsgZGlyIF07CgoJCXdoaWxlICggY3VyICYmIGN1ci5ub2RlVHlwZSAhPT0gOSAmJiAodW50aWwgPT09IHVuZGVmaW5lZCB8fCBjdXIubm9kZVR5cGUgIT09IDEgfHwgIWpRdWVyeSggY3VyICkuaXMoIHVudGlsICkpICkgewoJCQlpZiAoIGN1ci5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCW1hdGNoZWQucHVzaCggY3VyICk7CgkJCX0KCQkJY3VyID0gY3VyW2Rpcl07CgkJfQoJCXJldHVybiBtYXRjaGVkOwoJfSwKCglzaWJsaW5nOiBmdW5jdGlvbiggbiwgZWxlbSApIHsKCQl2YXIgciA9IFtdOwoKCQlmb3IgKCA7IG47IG4gPSBuLm5leHRTaWJsaW5nICkgewoJCQlpZiAoIG4ubm9kZVR5cGUgPT09IDEgJiYgbiAhPT0gZWxlbSApIHsKCQkJCXIucHVzaCggbiApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcjsKCX0KfSk7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCWhhczogZnVuY3Rpb24oIHRhcmdldCApIHsKCQl2YXIgaSwKCQkJdGFyZ2V0cyA9IGpRdWVyeSggdGFyZ2V0LCB0aGlzICksCgkJCWxlbiA9IHRhcmdldHMubGVuZ3RoOwoKCQlyZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCWZvciAoIGkgPSAwOyBpIDwgbGVuOyBpKysgKSB7CgkJCQlpZiAoIGpRdWVyeS5jb250YWlucyggdGhpcywgdGFyZ2V0c1tpXSApICkgewoJCQkJCXJldHVybiB0cnVlOwoJCQkJfQoJCQl9CgkJfSk7Cgl9LAoKCWNsb3Nlc3Q6IGZ1bmN0aW9uKCBzZWxlY3RvcnMsIGNvbnRleHQgKSB7CgkJdmFyIGN1ciwKCQkJaSA9IDAsCgkJCWwgPSB0aGlzLmxlbmd0aCwKCQkJbWF0Y2hlZCA9IFtdLAoJCQlwb3MgPSBybmVlZHNDb250ZXh0LnRlc3QoIHNlbGVjdG9ycyApIHx8IHR5cGVvZiBzZWxlY3RvcnMgIT09ICJzdHJpbmciID8KCQkJCWpRdWVyeSggc2VsZWN0b3JzLCBjb250ZXh0IHx8IHRoaXMuY29udGV4dCApIDoKCQkJCTA7CgoJCWZvciAoIDsgaSA8IGw7IGkrKyApIHsKCQkJZm9yICggY3VyID0gdGhpc1tpXTsgY3VyICYmIGN1ciAhPT0gY29udGV4dDsgY3VyID0gY3VyLnBhcmVudE5vZGUgKSB7CgkJCQkvLyBBbHdheXMgc2tpcCBkb2N1bWVudCBmcmFnbWVudHMKCQkJCWlmICggY3VyLm5vZGVUeXBlIDwgMTEgJiYgKHBvcyA/CgkJCQkJcG9zLmluZGV4KGN1cikgPiAtMSA6CgoJCQkJCS8vIERvbid0IHBhc3Mgbm9uLWVsZW1lbnRzIHRvIFNpenpsZQoJCQkJCWN1ci5ub2RlVHlwZSA9PT0gMSAmJgoJCQkJCQlqUXVlcnkuZmluZC5tYXRjaGVzU2VsZWN0b3IoY3VyLCBzZWxlY3RvcnMpKSApIHsKCgkJCQkJbWF0Y2hlZC5wdXNoKCBjdXIgKTsKCQkJCQlicmVhazsKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBtYXRjaGVkLmxlbmd0aCA+IDEgPyBqUXVlcnkudW5pcXVlKCBtYXRjaGVkICkgOiBtYXRjaGVkICk7Cgl9LAoKCS8vIERldGVybWluZSB0aGUgcG9zaXRpb24gb2YgYW4gZWxlbWVudCB3aXRoaW4KCS8vIHRoZSBtYXRjaGVkIHNldCBvZiBlbGVtZW50cwoJaW5kZXg6IGZ1bmN0aW9uKCBlbGVtICkgewoKCQkvLyBObyBhcmd1bWVudCwgcmV0dXJuIGluZGV4IGluIHBhcmVudAoJCWlmICggIWVsZW0gKSB7CgkJCXJldHVybiAoIHRoaXNbMF0gJiYgdGhpc1swXS5wYXJlbnROb2RlICkgPyB0aGlzLmZpcnN0KCkucHJldkFsbCgpLmxlbmd0aCA6IC0xOwoJCX0KCgkJLy8gaW5kZXggaW4gc2VsZWN0b3IKCQlpZiAoIHR5cGVvZiBlbGVtID09PSAic3RyaW5nIiApIHsKCQkJcmV0dXJuIGpRdWVyeS5pbkFycmF5KCB0aGlzWzBdLCBqUXVlcnkoIGVsZW0gKSApOwoJCX0KCgkJLy8gTG9jYXRlIHRoZSBwb3NpdGlvbiBvZiB0aGUgZGVzaXJlZCBlbGVtZW50CgkJcmV0dXJuIGpRdWVyeS5pbkFycmF5KAoJCQkvLyBJZiBpdCByZWNlaXZlcyBhIGpRdWVyeSBvYmplY3QsIHRoZSBmaXJzdCBlbGVtZW50IGlzIHVzZWQKCQkJZWxlbS5qcXVlcnkgPyBlbGVtWzBdIDogZWxlbSwgdGhpcyApOwoJfSwKCglhZGQ6IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCApIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soCgkJCWpRdWVyeS51bmlxdWUoCgkJCQlqUXVlcnkubWVyZ2UoIHRoaXMuZ2V0KCksIGpRdWVyeSggc2VsZWN0b3IsIGNvbnRleHQgKSApCgkJCSkKCQkpOwoJfSwKCglhZGRCYWNrOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMuYWRkKCBzZWxlY3RvciA9PSBudWxsID8KCQkJdGhpcy5wcmV2T2JqZWN0IDogdGhpcy5wcmV2T2JqZWN0LmZpbHRlcihzZWxlY3RvcikKCQkpOwoJfQp9KTsKCmZ1bmN0aW9uIHNpYmxpbmcoIGN1ciwgZGlyICkgewoJZG8gewoJCWN1ciA9IGN1clsgZGlyIF07Cgl9IHdoaWxlICggY3VyICYmIGN1ci5ub2RlVHlwZSAhPT0gMSApOwoKCXJldHVybiBjdXI7Cn0KCmpRdWVyeS5lYWNoKHsKCXBhcmVudDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsKCQlyZXR1cm4gcGFyZW50ICYmIHBhcmVudC5ub2RlVHlwZSAhPT0gMTEgPyBwYXJlbnQgOiBudWxsOwoJfSwKCXBhcmVudHM6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAicGFyZW50Tm9kZSIgKTsKCX0sCglwYXJlbnRzVW50aWw6IGZ1bmN0aW9uKCBlbGVtLCBpLCB1bnRpbCApIHsKCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgInBhcmVudE5vZGUiLCB1bnRpbCApOwoJfSwKCW5leHQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBzaWJsaW5nKCBlbGVtLCAibmV4dFNpYmxpbmciICk7Cgl9LAoJcHJldjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIHNpYmxpbmcoIGVsZW0sICJwcmV2aW91c1NpYmxpbmciICk7Cgl9LAoJbmV4dEFsbDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJuZXh0U2libGluZyIgKTsKCX0sCglwcmV2QWxsOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgInByZXZpb3VzU2libGluZyIgKTsKCX0sCgluZXh0VW50aWw6IGZ1bmN0aW9uKCBlbGVtLCBpLCB1bnRpbCApIHsKCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgIm5leHRTaWJsaW5nIiwgdW50aWwgKTsKCX0sCglwcmV2VW50aWw6IGZ1bmN0aW9uKCBlbGVtLCBpLCB1bnRpbCApIHsKCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgInByZXZpb3VzU2libGluZyIsIHVudGlsICk7Cgl9LAoJc2libGluZ3M6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkuc2libGluZyggKCBlbGVtLnBhcmVudE5vZGUgfHwge30gKS5maXJzdENoaWxkLCBlbGVtICk7Cgl9LAoJY2hpbGRyZW46IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkuc2libGluZyggZWxlbS5maXJzdENoaWxkICk7Cgl9LAoJY29udGVudHM6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJpZnJhbWUiICkgPwoJCQllbGVtLmNvbnRlbnREb2N1bWVudCB8fCBlbGVtLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQgOgoJCQlqUXVlcnkubWVyZ2UoIFtdLCBlbGVtLmNoaWxkTm9kZXMgKTsKCX0KfSwgZnVuY3Rpb24oIG5hbWUsIGZuICkgewoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggdW50aWwsIHNlbGVjdG9yICkgewoJCXZhciByZXQgPSBqUXVlcnkubWFwKCB0aGlzLCBmbiwgdW50aWwgKTsKCgkJaWYgKCBuYW1lLnNsaWNlKCAtNSApICE9PSAiVW50aWwiICkgewoJCQlzZWxlY3RvciA9IHVudGlsOwoJCX0KCgkJaWYgKCBzZWxlY3RvciAmJiB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciICkgewoJCQlyZXQgPSBqUXVlcnkuZmlsdGVyKCBzZWxlY3RvciwgcmV0ICk7CgkJfQoKCQlpZiAoIHRoaXMubGVuZ3RoID4gMSApIHsKCQkJLy8gUmVtb3ZlIGR1cGxpY2F0ZXMKCQkJaWYgKCAhZ3VhcmFudGVlZFVuaXF1ZVsgbmFtZSBdICkgewoJCQkJcmV0ID0galF1ZXJ5LnVuaXF1ZSggcmV0ICk7CgkJCX0KCgkJCS8vIFJldmVyc2Ugb3JkZXIgZm9yIHBhcmVudHMqIGFuZCBwcmV2LWRlcml2YXRpdmVzCgkJCWlmICggcnBhcmVudHNwcmV2LnRlc3QoIG5hbWUgKSApIHsKCQkJCXJldCA9IHJldC5yZXZlcnNlKCk7CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggcmV0ICk7Cgl9Owp9KTsKdmFyIHJub3R3aGl0ZSA9ICgvXFMrL2cpOwoKCgovLyBTdHJpbmcgdG8gT2JqZWN0IG9wdGlvbnMgZm9ybWF0IGNhY2hlCnZhciBvcHRpb25zQ2FjaGUgPSB7fTsKCi8vIENvbnZlcnQgU3RyaW5nLWZvcm1hdHRlZCBvcHRpb25zIGludG8gT2JqZWN0LWZvcm1hdHRlZCBvbmVzIGFuZCBzdG9yZSBpbiBjYWNoZQpmdW5jdGlvbiBjcmVhdGVPcHRpb25zKCBvcHRpb25zICkgewoJdmFyIG9iamVjdCA9IG9wdGlvbnNDYWNoZVsgb3B0aW9ucyBdID0ge307CglqUXVlcnkuZWFjaCggb3B0aW9ucy5tYXRjaCggcm5vdHdoaXRlICkgfHwgW10sIGZ1bmN0aW9uKCBfLCBmbGFnICkgewoJCW9iamVjdFsgZmxhZyBdID0gdHJ1ZTsKCX0pOwoJcmV0dXJuIG9iamVjdDsKfQoKLyoKICogQ3JlYXRlIGEgY2FsbGJhY2sgbGlzdCB1c2luZyB0aGUgZm9sbG93aW5nIHBhcmFtZXRlcnM6CiAqCiAqCW9wdGlvbnM6IGFuIG9wdGlvbmFsIGxpc3Qgb2Ygc3BhY2Utc2VwYXJhdGVkIG9wdGlvbnMgdGhhdCB3aWxsIGNoYW5nZSBob3cKICoJCQl0aGUgY2FsbGJhY2sgbGlzdCBiZWhhdmVzIG9yIGEgbW9yZSB0cmFkaXRpb25hbCBvcHRpb24gb2JqZWN0CiAqCiAqIEJ5IGRlZmF1bHQgYSBjYWxsYmFjayBsaXN0IHdpbGwgYWN0IGxpa2UgYW4gZXZlbnQgY2FsbGJhY2sgbGlzdCBhbmQgY2FuIGJlCiAqICJmaXJlZCIgbXVsdGlwbGUgdGltZXMuCiAqCiAqIFBvc3NpYmxlIG9wdGlvbnM6CiAqCiAqCW9uY2U6CQkJd2lsbCBlbnN1cmUgdGhlIGNhbGxiYWNrIGxpc3QgY2FuIG9ubHkgYmUgZmlyZWQgb25jZSAobGlrZSBhIERlZmVycmVkKQogKgogKgltZW1vcnk6CQkJd2lsbCBrZWVwIHRyYWNrIG9mIHByZXZpb3VzIHZhbHVlcyBhbmQgd2lsbCBjYWxsIGFueSBjYWxsYmFjayBhZGRlZAogKgkJCQkJYWZ0ZXIgdGhlIGxpc3QgaGFzIGJlZW4gZmlyZWQgcmlnaHQgYXdheSB3aXRoIHRoZSBsYXRlc3QgIm1lbW9yaXplZCIKICoJCQkJCXZhbHVlcyAobGlrZSBhIERlZmVycmVkKQogKgogKgl1bmlxdWU6CQkJd2lsbCBlbnN1cmUgYSBjYWxsYmFjayBjYW4gb25seSBiZSBhZGRlZCBvbmNlIChubyBkdXBsaWNhdGUgaW4gdGhlIGxpc3QpCiAqCiAqCXN0b3BPbkZhbHNlOglpbnRlcnJ1cHQgY2FsbGluZ3Mgd2hlbiBhIGNhbGxiYWNrIHJldHVybnMgZmFsc2UKICoKICovCmpRdWVyeS5DYWxsYmFja3MgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCgkvLyBDb252ZXJ0IG9wdGlvbnMgZnJvbSBTdHJpbmctZm9ybWF0dGVkIHRvIE9iamVjdC1mb3JtYXR0ZWQgaWYgbmVlZGVkCgkvLyAod2UgY2hlY2sgaW4gY2FjaGUgZmlyc3QpCglvcHRpb25zID0gdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciID8KCQkoIG9wdGlvbnNDYWNoZVsgb3B0aW9ucyBdIHx8IGNyZWF0ZU9wdGlvbnMoIG9wdGlvbnMgKSApIDoKCQlqUXVlcnkuZXh0ZW5kKCB7fSwgb3B0aW9ucyApOwoKCXZhciAvLyBGbGFnIHRvIGtub3cgaWYgbGlzdCBpcyBjdXJyZW50bHkgZmlyaW5nCgkJZmlyaW5nLAoJCS8vIExhc3QgZmlyZSB2YWx1ZSAoZm9yIG5vbi1mb3JnZXR0YWJsZSBsaXN0cykKCQltZW1vcnksCgkJLy8gRmxhZyB0byBrbm93IGlmIGxpc3Qgd2FzIGFscmVhZHkgZmlyZWQKCQlmaXJlZCwKCQkvLyBFbmQgb2YgdGhlIGxvb3Agd2hlbiBmaXJpbmcKCQlmaXJpbmdMZW5ndGgsCgkJLy8gSW5kZXggb2YgY3VycmVudGx5IGZpcmluZyBjYWxsYmFjayAobW9kaWZpZWQgYnkgcmVtb3ZlIGlmIG5lZWRlZCkKCQlmaXJpbmdJbmRleCwKCQkvLyBGaXJzdCBjYWxsYmFjayB0byBmaXJlICh1c2VkIGludGVybmFsbHkgYnkgYWRkIGFuZCBmaXJlV2l0aCkKCQlmaXJpbmdTdGFydCwKCQkvLyBBY3R1YWwgY2FsbGJhY2sgbGlzdAoJCWxpc3QgPSBbXSwKCQkvLyBTdGFjayBvZiBmaXJlIGNhbGxzIGZvciByZXBlYXRhYmxlIGxpc3RzCgkJc3RhY2sgPSAhb3B0aW9ucy5vbmNlICYmIFtdLAoJCS8vIEZpcmUgY2FsbGJhY2tzCgkJZmlyZSA9IGZ1bmN0aW9uKCBkYXRhICkgewoJCQltZW1vcnkgPSBvcHRpb25zLm1lbW9yeSAmJiBkYXRhOwoJCQlmaXJlZCA9IHRydWU7CgkJCWZpcmluZ0luZGV4ID0gZmlyaW5nU3RhcnQgfHwgMDsKCQkJZmlyaW5nU3RhcnQgPSAwOwoJCQlmaXJpbmdMZW5ndGggPSBsaXN0Lmxlbmd0aDsKCQkJZmlyaW5nID0gdHJ1ZTsKCQkJZm9yICggOyBsaXN0ICYmIGZpcmluZ0luZGV4IDwgZmlyaW5nTGVuZ3RoOyBmaXJpbmdJbmRleCsrICkgewoJCQkJaWYgKCBsaXN0WyBmaXJpbmdJbmRleCBdLmFwcGx5KCBkYXRhWyAwIF0sIGRhdGFbIDEgXSApID09PSBmYWxzZSAmJiBvcHRpb25zLnN0b3BPbkZhbHNlICkgewoJCQkJCW1lbW9yeSA9IGZhbHNlOyAvLyBUbyBwcmV2ZW50IGZ1cnRoZXIgY2FsbHMgdXNpbmcgYWRkCgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCQkJZmlyaW5nID0gZmFsc2U7CgkJCWlmICggbGlzdCApIHsKCQkJCWlmICggc3RhY2sgKSB7CgkJCQkJaWYgKCBzdGFjay5sZW5ndGggKSB7CgkJCQkJCWZpcmUoIHN0YWNrLnNoaWZ0KCkgKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBtZW1vcnkgKSB7CgkJCQkJbGlzdCA9IFtdOwoJCQkJfSBlbHNlIHsKCQkJCQlzZWxmLmRpc2FibGUoKTsKCQkJCX0KCQkJfQoJCX0sCgkJLy8gQWN0dWFsIENhbGxiYWNrcyBvYmplY3QKCQlzZWxmID0gewoJCQkvLyBBZGQgYSBjYWxsYmFjayBvciBhIGNvbGxlY3Rpb24gb2YgY2FsbGJhY2tzIHRvIHRoZSBsaXN0CgkJCWFkZDogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIGxpc3QgKSB7CgkJCQkJLy8gRmlyc3QsIHdlIHNhdmUgdGhlIGN1cnJlbnQgbGVuZ3RoCgkJCQkJdmFyIHN0YXJ0ID0gbGlzdC5sZW5ndGg7CgkJCQkJKGZ1bmN0aW9uIGFkZCggYXJncyApIHsKCQkJCQkJalF1ZXJ5LmVhY2goIGFyZ3MsIGZ1bmN0aW9uKCBfLCBhcmcgKSB7CgkJCQkJCQl2YXIgdHlwZSA9IGpRdWVyeS50eXBlKCBhcmcgKTsKCQkJCQkJCWlmICggdHlwZSA9PT0gImZ1bmN0aW9uIiApIHsKCQkJCQkJCQlpZiAoICFvcHRpb25zLnVuaXF1ZSB8fCAhc2VsZi5oYXMoIGFyZyApICkgewoJCQkJCQkJCQlsaXN0LnB1c2goIGFyZyApOwoJCQkJCQkJCX0KCQkJCQkJCX0gZWxzZSBpZiAoIGFyZyAmJiBhcmcubGVuZ3RoICYmIHR5cGUgIT09ICJzdHJpbmciICkgewoJCQkJCQkJCS8vIEluc3BlY3QgcmVjdXJzaXZlbHkKCQkJCQkJCQlhZGQoIGFyZyApOwoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQl9KSggYXJndW1lbnRzICk7CgkJCQkJLy8gRG8gd2UgbmVlZCB0byBhZGQgdGhlIGNhbGxiYWNrcyB0byB0aGUKCQkJCQkvLyBjdXJyZW50IGZpcmluZyBiYXRjaD8KCQkJCQlpZiAoIGZpcmluZyApIHsKCQkJCQkJZmlyaW5nTGVuZ3RoID0gbGlzdC5sZW5ndGg7CgkJCQkJLy8gV2l0aCBtZW1vcnksIGlmIHdlJ3JlIG5vdCBmaXJpbmcgdGhlbgoJCQkJCS8vIHdlIHNob3VsZCBjYWxsIHJpZ2h0IGF3YXkKCQkJCQl9IGVsc2UgaWYgKCBtZW1vcnkgKSB7CgkJCQkJCWZpcmluZ1N0YXJ0ID0gc3RhcnQ7CgkJCQkJCWZpcmUoIG1lbW9yeSApOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQkvLyBSZW1vdmUgYSBjYWxsYmFjayBmcm9tIHRoZSBsaXN0CgkJCXJlbW92ZTogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIGxpc3QgKSB7CgkJCQkJalF1ZXJ5LmVhY2goIGFyZ3VtZW50cywgZnVuY3Rpb24oIF8sIGFyZyApIHsKCQkJCQkJdmFyIGluZGV4OwoJCQkJCQl3aGlsZSAoICggaW5kZXggPSBqUXVlcnkuaW5BcnJheSggYXJnLCBsaXN0LCBpbmRleCApICkgPiAtMSApIHsKCQkJCQkJCWxpc3Quc3BsaWNlKCBpbmRleCwgMSApOwoJCQkJCQkJLy8gSGFuZGxlIGZpcmluZyBpbmRleGVzCgkJCQkJCQlpZiAoIGZpcmluZyApIHsKCQkJCQkJCQlpZiAoIGluZGV4IDw9IGZpcmluZ0xlbmd0aCApIHsKCQkJCQkJCQkJZmlyaW5nTGVuZ3RoLS07CgkJCQkJCQkJfQoJCQkJCQkJCWlmICggaW5kZXggPD0gZmlyaW5nSW5kZXggKSB7CgkJCQkJCQkJCWZpcmluZ0luZGV4LS07CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfSk7CgkJCQl9CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJLy8gQ2hlY2sgaWYgYSBnaXZlbiBjYWxsYmFjayBpcyBpbiB0aGUgbGlzdC4KCQkJLy8gSWYgbm8gYXJndW1lbnQgaXMgZ2l2ZW4sIHJldHVybiB3aGV0aGVyIG9yIG5vdCBsaXN0IGhhcyBjYWxsYmFja3MgYXR0YWNoZWQuCgkJCWhhczogZnVuY3Rpb24oIGZuICkgewoJCQkJcmV0dXJuIGZuID8galF1ZXJ5LmluQXJyYXkoIGZuLCBsaXN0ICkgPiAtMSA6ICEhKCBsaXN0ICYmIGxpc3QubGVuZ3RoICk7CgkJCX0sCgkJCS8vIFJlbW92ZSBhbGwgY2FsbGJhY2tzIGZyb20gdGhlIGxpc3QKCQkJZW1wdHk6IGZ1bmN0aW9uKCkgewoJCQkJbGlzdCA9IFtdOwoJCQkJZmlyaW5nTGVuZ3RoID0gMDsKCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQkvLyBIYXZlIHRoZSBsaXN0IGRvIG5vdGhpbmcgYW55bW9yZQoJCQlkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQkJCWxpc3QgPSBzdGFjayA9IG1lbW9yeSA9IHVuZGVmaW5lZDsKCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQkvLyBJcyBpdCBkaXNhYmxlZD8KCQkJZGlzYWJsZWQ6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICFsaXN0OwoJCQl9LAoJCQkvLyBMb2NrIHRoZSBsaXN0IGluIGl0cyBjdXJyZW50IHN0YXRlCgkJCWxvY2s6IGZ1bmN0aW9uKCkgewoJCQkJc3RhY2sgPSB1bmRlZmluZWQ7CgkJCQlpZiAoICFtZW1vcnkgKSB7CgkJCQkJc2VsZi5kaXNhYmxlKCk7CgkJCQl9CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJLy8gSXMgaXQgbG9ja2VkPwoJCQlsb2NrZWQ6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICFzdGFjazsKCQkJfSwKCQkJLy8gQ2FsbCBhbGwgY2FsbGJhY2tzIHdpdGggdGhlIGdpdmVuIGNvbnRleHQgYW5kIGFyZ3VtZW50cwoJCQlmaXJlV2l0aDogZnVuY3Rpb24oIGNvbnRleHQsIGFyZ3MgKSB7CgkJCQlpZiAoIGxpc3QgJiYgKCAhZmlyZWQgfHwgc3RhY2sgKSApIHsKCQkJCQlhcmdzID0gYXJncyB8fCBbXTsKCQkJCQlhcmdzID0gWyBjb250ZXh0LCBhcmdzLnNsaWNlID8gYXJncy5zbGljZSgpIDogYXJncyBdOwoJCQkJCWlmICggZmlyaW5nICkgewoJCQkJCQlzdGFjay5wdXNoKCBhcmdzICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJZmlyZSggYXJncyApOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQkvLyBDYWxsIGFsbCB0aGUgY2FsbGJhY2tzIHdpdGggdGhlIGdpdmVuIGFyZ3VtZW50cwoJCQlmaXJlOiBmdW5jdGlvbigpIHsKCQkJCXNlbGYuZmlyZVdpdGgoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCS8vIFRvIGtub3cgaWYgdGhlIGNhbGxiYWNrcyBoYXZlIGFscmVhZHkgYmVlbiBjYWxsZWQgYXQgbGVhc3Qgb25jZQoJCQlmaXJlZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gISFmaXJlZDsKCQkJfQoJCX07CgoJcmV0dXJuIHNlbGY7Cn07CgoKalF1ZXJ5LmV4dGVuZCh7CgoJRGVmZXJyZWQ6IGZ1bmN0aW9uKCBmdW5jICkgewoJCXZhciB0dXBsZXMgPSBbCgkJCQkvLyBhY3Rpb24sIGFkZCBsaXN0ZW5lciwgbGlzdGVuZXIgbGlzdCwgZmluYWwgc3RhdGUKCQkJCVsgInJlc29sdmUiLCAiZG9uZSIsIGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IiksICJyZXNvbHZlZCIgXSwKCQkJCVsgInJlamVjdCIsICJmYWlsIiwgalF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwgInJlamVjdGVkIiBdLAoJCQkJWyAibm90aWZ5IiwgInByb2dyZXNzIiwgalF1ZXJ5LkNhbGxiYWNrcygibWVtb3J5IikgXQoJCQldLAoJCQlzdGF0ZSA9ICJwZW5kaW5nIiwKCQkJcHJvbWlzZSA9IHsKCQkJCXN0YXRlOiBmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gc3RhdGU7CgkJCQl9LAoJCQkJYWx3YXlzOiBmdW5jdGlvbigpIHsKCQkJCQlkZWZlcnJlZC5kb25lKCBhcmd1bWVudHMgKS5mYWlsKCBhcmd1bWVudHMgKTsKCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0sCgkJCQl0aGVuOiBmdW5jdGlvbiggLyogZm5Eb25lLCBmbkZhaWwsIGZuUHJvZ3Jlc3MgKi8gKSB7CgkJCQkJdmFyIGZucyA9IGFyZ3VtZW50czsKCQkJCQlyZXR1cm4galF1ZXJ5LkRlZmVycmVkKGZ1bmN0aW9uKCBuZXdEZWZlciApIHsKCQkJCQkJalF1ZXJ5LmVhY2goIHR1cGxlcywgZnVuY3Rpb24oIGksIHR1cGxlICkgewoJCQkJCQkJdmFyIGZuID0galF1ZXJ5LmlzRnVuY3Rpb24oIGZuc1sgaSBdICkgJiYgZm5zWyBpIF07CgkJCQkJCQkvLyBkZWZlcnJlZFsgZG9uZSB8IGZhaWwgfCBwcm9ncmVzcyBdIGZvciBmb3J3YXJkaW5nIGFjdGlvbnMgdG8gbmV3RGVmZXIKCQkJCQkJCWRlZmVycmVkWyB0dXBsZVsxXSBdKGZ1bmN0aW9uKCkgewoJCQkJCQkJCXZhciByZXR1cm5lZCA9IGZuICYmIGZuLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCQkJCQlpZiAoIHJldHVybmVkICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCByZXR1cm5lZC5wcm9taXNlICkgKSB7CgkJCQkJCQkJCXJldHVybmVkLnByb21pc2UoKQoJCQkJCQkJCQkJLmRvbmUoIG5ld0RlZmVyLnJlc29sdmUgKQoJCQkJCQkJCQkJLmZhaWwoIG5ld0RlZmVyLnJlamVjdCApCgkJCQkJCQkJCQkucHJvZ3Jlc3MoIG5ld0RlZmVyLm5vdGlmeSApOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCW5ld0RlZmVyWyB0dXBsZVsgMCBdICsgIldpdGgiIF0oIHRoaXMgPT09IHByb21pc2UgPyBuZXdEZWZlci5wcm9taXNlKCkgOiB0aGlzLCBmbiA/IFsgcmV0dXJuZWQgXSA6IGFyZ3VtZW50cyApOwoJCQkJCQkJCX0KCQkJCQkJCX0pOwoJCQkJCQl9KTsKCQkJCQkJZm5zID0gbnVsbDsKCQkJCQl9KS5wcm9taXNlKCk7CgkJCQl9LAoJCQkJLy8gR2V0IGEgcHJvbWlzZSBmb3IgdGhpcyBkZWZlcnJlZAoJCQkJLy8gSWYgb2JqIGlzIHByb3ZpZGVkLCB0aGUgcHJvbWlzZSBhc3BlY3QgaXMgYWRkZWQgdG8gdGhlIG9iamVjdAoJCQkJcHJvbWlzZTogZnVuY3Rpb24oIG9iaiApIHsKCQkJCQlyZXR1cm4gb2JqICE9IG51bGwgPyBqUXVlcnkuZXh0ZW5kKCBvYmosIHByb21pc2UgKSA6IHByb21pc2U7CgkJCQl9CgkJCX0sCgkJCWRlZmVycmVkID0ge307CgoJCS8vIEtlZXAgcGlwZSBmb3IgYmFjay1jb21wYXQKCQlwcm9taXNlLnBpcGUgPSBwcm9taXNlLnRoZW47CgoJCS8vIEFkZCBsaXN0LXNwZWNpZmljIG1ldGhvZHMKCQlqUXVlcnkuZWFjaCggdHVwbGVzLCBmdW5jdGlvbiggaSwgdHVwbGUgKSB7CgkJCXZhciBsaXN0ID0gdHVwbGVbIDIgXSwKCQkJCXN0YXRlU3RyaW5nID0gdHVwbGVbIDMgXTsKCgkJCS8vIHByb21pc2VbIGRvbmUgfCBmYWlsIHwgcHJvZ3Jlc3MgXSA9IGxpc3QuYWRkCgkJCXByb21pc2VbIHR1cGxlWzFdIF0gPSBsaXN0LmFkZDsKCgkJCS8vIEhhbmRsZSBzdGF0ZQoJCQlpZiAoIHN0YXRlU3RyaW5nICkgewoJCQkJbGlzdC5hZGQoZnVuY3Rpb24oKSB7CgkJCQkJLy8gc3RhdGUgPSBbIHJlc29sdmVkIHwgcmVqZWN0ZWQgXQoJCQkJCXN0YXRlID0gc3RhdGVTdHJpbmc7CgoJCQkJLy8gWyByZWplY3RfbGlzdCB8IHJlc29sdmVfbGlzdCBdLmRpc2FibGU7IHByb2dyZXNzX2xpc3QubG9jawoJCQkJfSwgdHVwbGVzWyBpIF4gMSBdWyAyIF0uZGlzYWJsZSwgdHVwbGVzWyAyIF1bIDIgXS5sb2NrICk7CgkJCX0KCgkJCS8vIGRlZmVycmVkWyByZXNvbHZlIHwgcmVqZWN0IHwgbm90aWZ5IF0KCQkJZGVmZXJyZWRbIHR1cGxlWzBdIF0gPSBmdW5jdGlvbigpIHsKCQkJCWRlZmVycmVkWyB0dXBsZVswXSArICJXaXRoIiBdKCB0aGlzID09PSBkZWZlcnJlZCA/IHByb21pc2UgOiB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9OwoJCQlkZWZlcnJlZFsgdHVwbGVbMF0gKyAiV2l0aCIgXSA9IGxpc3QuZmlyZVdpdGg7CgkJfSk7CgoJCS8vIE1ha2UgdGhlIGRlZmVycmVkIGEgcHJvbWlzZQoJCXByb21pc2UucHJvbWlzZSggZGVmZXJyZWQgKTsKCgkJLy8gQ2FsbCBnaXZlbiBmdW5jIGlmIGFueQoJCWlmICggZnVuYyApIHsKCQkJZnVuYy5jYWxsKCBkZWZlcnJlZCwgZGVmZXJyZWQgKTsKCQl9CgoJCS8vIEFsbCBkb25lIQoJCXJldHVybiBkZWZlcnJlZDsKCX0sCgoJLy8gRGVmZXJyZWQgaGVscGVyCgl3aGVuOiBmdW5jdGlvbiggc3Vib3JkaW5hdGUgLyogLCAuLi4sIHN1Ym9yZGluYXRlTiAqLyApIHsKCQl2YXIgaSA9IDAsCgkJCXJlc29sdmVWYWx1ZXMgPSBzbGljZS5jYWxsKCBhcmd1bWVudHMgKSwKCQkJbGVuZ3RoID0gcmVzb2x2ZVZhbHVlcy5sZW5ndGgsCgoJCQkvLyB0aGUgY291bnQgb2YgdW5jb21wbGV0ZWQgc3Vib3JkaW5hdGVzCgkJCXJlbWFpbmluZyA9IGxlbmd0aCAhPT0gMSB8fCAoIHN1Ym9yZGluYXRlICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCBzdWJvcmRpbmF0ZS5wcm9taXNlICkgKSA/IGxlbmd0aCA6IDAsCgoJCQkvLyB0aGUgbWFzdGVyIERlZmVycmVkLiBJZiByZXNvbHZlVmFsdWVzIGNvbnNpc3Qgb2Ygb25seSBhIHNpbmdsZSBEZWZlcnJlZCwganVzdCB1c2UgdGhhdC4KCQkJZGVmZXJyZWQgPSByZW1haW5pbmcgPT09IDEgPyBzdWJvcmRpbmF0ZSA6IGpRdWVyeS5EZWZlcnJlZCgpLAoKCQkJLy8gVXBkYXRlIGZ1bmN0aW9uIGZvciBib3RoIHJlc29sdmUgYW5kIHByb2dyZXNzIHZhbHVlcwoJCQl1cGRhdGVGdW5jID0gZnVuY3Rpb24oIGksIGNvbnRleHRzLCB2YWx1ZXMgKSB7CgkJCQlyZXR1cm4gZnVuY3Rpb24oIHZhbHVlICkgewoJCQkJCWNvbnRleHRzWyBpIF0gPSB0aGlzOwoJCQkJCXZhbHVlc1sgaSBdID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBzbGljZS5jYWxsKCBhcmd1bWVudHMgKSA6IHZhbHVlOwoJCQkJCWlmICggdmFsdWVzID09PSBwcm9ncmVzc1ZhbHVlcyApIHsKCQkJCQkJZGVmZXJyZWQubm90aWZ5V2l0aCggY29udGV4dHMsIHZhbHVlcyApOwoKCQkJCQl9IGVsc2UgaWYgKCAhKC0tcmVtYWluaW5nKSApIHsKCQkJCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGNvbnRleHRzLCB2YWx1ZXMgKTsKCQkJCQl9CgkJCQl9OwoJCQl9LAoKCQkJcHJvZ3Jlc3NWYWx1ZXMsIHByb2dyZXNzQ29udGV4dHMsIHJlc29sdmVDb250ZXh0czsKCgkJLy8gYWRkIGxpc3RlbmVycyB0byBEZWZlcnJlZCBzdWJvcmRpbmF0ZXM7IHRyZWF0IG90aGVycyBhcyByZXNvbHZlZAoJCWlmICggbGVuZ3RoID4gMSApIHsKCQkJcHJvZ3Jlc3NWYWx1ZXMgPSBuZXcgQXJyYXkoIGxlbmd0aCApOwoJCQlwcm9ncmVzc0NvbnRleHRzID0gbmV3IEFycmF5KCBsZW5ndGggKTsKCQkJcmVzb2x2ZUNvbnRleHRzID0gbmV3IEFycmF5KCBsZW5ndGggKTsKCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQlpZiAoIHJlc29sdmVWYWx1ZXNbIGkgXSAmJiBqUXVlcnkuaXNGdW5jdGlvbiggcmVzb2x2ZVZhbHVlc1sgaSBdLnByb21pc2UgKSApIHsKCQkJCQlyZXNvbHZlVmFsdWVzWyBpIF0ucHJvbWlzZSgpCgkJCQkJCS5kb25lKCB1cGRhdGVGdW5jKCBpLCByZXNvbHZlQ29udGV4dHMsIHJlc29sdmVWYWx1ZXMgKSApCgkJCQkJCS5mYWlsKCBkZWZlcnJlZC5yZWplY3QgKQoJCQkJCQkucHJvZ3Jlc3MoIHVwZGF0ZUZ1bmMoIGksIHByb2dyZXNzQ29udGV4dHMsIHByb2dyZXNzVmFsdWVzICkgKTsKCQkJCX0gZWxzZSB7CgkJCQkJLS1yZW1haW5pbmc7CgkJCQl9CgkJCX0KCQl9CgoJCS8vIGlmIHdlJ3JlIG5vdCB3YWl0aW5nIG9uIGFueXRoaW5nLCByZXNvbHZlIHRoZSBtYXN0ZXIKCQlpZiAoICFyZW1haW5pbmcgKSB7CgkJCWRlZmVycmVkLnJlc29sdmVXaXRoKCByZXNvbHZlQ29udGV4dHMsIHJlc29sdmVWYWx1ZXMgKTsKCQl9CgoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7Cgl9Cn0pOwoKCi8vIFRoZSBkZWZlcnJlZCB1c2VkIG9uIERPTSByZWFkeQp2YXIgcmVhZHlMaXN0OwoKalF1ZXJ5LmZuLnJlYWR5ID0gZnVuY3Rpb24oIGZuICkgewoJLy8gQWRkIHRoZSBjYWxsYmFjawoJalF1ZXJ5LnJlYWR5LnByb21pc2UoKS5kb25lKCBmbiApOwoKCXJldHVybiB0aGlzOwp9OwoKalF1ZXJ5LmV4dGVuZCh7CgkvLyBJcyB0aGUgRE9NIHJlYWR5IHRvIGJlIHVzZWQ/IFNldCB0byB0cnVlIG9uY2UgaXQgb2NjdXJzLgoJaXNSZWFkeTogZmFsc2UsCgoJLy8gQSBjb3VudGVyIHRvIHRyYWNrIGhvdyBtYW55IGl0ZW1zIHRvIHdhaXQgZm9yIGJlZm9yZQoJLy8gdGhlIHJlYWR5IGV2ZW50IGZpcmVzLiBTZWUgIzY3ODEKCXJlYWR5V2FpdDogMSwKCgkvLyBIb2xkIChvciByZWxlYXNlKSB0aGUgcmVhZHkgZXZlbnQKCWhvbGRSZWFkeTogZnVuY3Rpb24oIGhvbGQgKSB7CgkJaWYgKCBob2xkICkgewoJCQlqUXVlcnkucmVhZHlXYWl0Kys7CgkJfSBlbHNlIHsKCQkJalF1ZXJ5LnJlYWR5KCB0cnVlICk7CgkJfQoJfSwKCgkvLyBIYW5kbGUgd2hlbiB0aGUgRE9NIGlzIHJlYWR5CglyZWFkeTogZnVuY3Rpb24oIHdhaXQgKSB7CgoJCS8vIEFib3J0IGlmIHRoZXJlIGFyZSBwZW5kaW5nIGhvbGRzIG9yIHdlJ3JlIGFscmVhZHkgcmVhZHkKCQlpZiAoIHdhaXQgPT09IHRydWUgPyAtLWpRdWVyeS5yZWFkeVdhaXQgOiBqUXVlcnkuaXNSZWFkeSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gTWFrZSBzdXJlIGJvZHkgZXhpc3RzLCBhdCBsZWFzdCwgaW4gY2FzZSBJRSBnZXRzIGEgbGl0dGxlIG92ZXJ6ZWFsb3VzICh0aWNrZXQgIzU0NDMpLgoJCWlmICggIWRvY3VtZW50LmJvZHkgKSB7CgkJCXJldHVybiBzZXRUaW1lb3V0KCBqUXVlcnkucmVhZHkgKTsKCQl9CgoJCS8vIFJlbWVtYmVyIHRoYXQgdGhlIERPTSBpcyByZWFkeQoJCWpRdWVyeS5pc1JlYWR5ID0gdHJ1ZTsKCgkJLy8gSWYgYSBub3JtYWwgRE9NIFJlYWR5IGV2ZW50IGZpcmVkLCBkZWNyZW1lbnQsIGFuZCB3YWl0IGlmIG5lZWQgYmUKCQlpZiAoIHdhaXQgIT09IHRydWUgJiYgLS1qUXVlcnkucmVhZHlXYWl0ID4gMCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gSWYgdGhlcmUgYXJlIGZ1bmN0aW9ucyBib3VuZCwgdG8gZXhlY3V0ZQoJCXJlYWR5TGlzdC5yZXNvbHZlV2l0aCggZG9jdW1lbnQsIFsgalF1ZXJ5IF0gKTsKCgkJLy8gVHJpZ2dlciBhbnkgYm91bmQgcmVhZHkgZXZlbnRzCgkJaWYgKCBqUXVlcnkuZm4udHJpZ2dlciApIHsKCQkJalF1ZXJ5KCBkb2N1bWVudCApLnRyaWdnZXIoInJlYWR5Iikub2ZmKCJyZWFkeSIpOwoJCX0KCX0KfSk7CgovKioKICogQ2xlYW4tdXAgbWV0aG9kIGZvciBkb20gcmVhZHkgZXZlbnRzCiAqLwpmdW5jdGlvbiBkZXRhY2goKSB7CglpZiAoIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIgKSB7CgkJZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciggIkRPTUNvbnRlbnRMb2FkZWQiLCBjb21wbGV0ZWQsIGZhbHNlICk7CgkJd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoICJsb2FkIiwgY29tcGxldGVkLCBmYWxzZSApOwoKCX0gZWxzZSB7CgkJZG9jdW1lbnQuZGV0YWNoRXZlbnQoICJvbnJlYWR5c3RhdGVjaGFuZ2UiLCBjb21wbGV0ZWQgKTsKCQl3aW5kb3cuZGV0YWNoRXZlbnQoICJvbmxvYWQiLCBjb21wbGV0ZWQgKTsKCX0KfQoKLyoqCiAqIFRoZSByZWFkeSBldmVudCBoYW5kbGVyIGFuZCBzZWxmIGNsZWFudXAgbWV0aG9kCiAqLwpmdW5jdGlvbiBjb21wbGV0ZWQoKSB7CgkvLyByZWFkeVN0YXRlID09PSAiY29tcGxldGUiIGlzIGdvb2QgZW5vdWdoIGZvciB1cyB0byBjYWxsIHRoZSBkb20gcmVhZHkgaW4gb2xkSUUKCWlmICggZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciB8fCBldmVudC50eXBlID09PSAibG9hZCIgfHwgZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiApIHsKCQlkZXRhY2goKTsKCQlqUXVlcnkucmVhZHkoKTsKCX0KfQoKalF1ZXJ5LnJlYWR5LnByb21pc2UgPSBmdW5jdGlvbiggb2JqICkgewoJaWYgKCAhcmVhZHlMaXN0ICkgewoKCQlyZWFkeUxpc3QgPSBqUXVlcnkuRGVmZXJyZWQoKTsKCgkJLy8gQ2F0Y2ggY2FzZXMgd2hlcmUgJChkb2N1bWVudCkucmVhZHkoKSBpcyBjYWxsZWQgYWZ0ZXIgdGhlIGJyb3dzZXIgZXZlbnQgaGFzIGFscmVhZHkgb2NjdXJyZWQuCgkJLy8gd2Ugb25jZSB0cmllZCB0byB1c2UgcmVhZHlTdGF0ZSAiaW50ZXJhY3RpdmUiIGhlcmUsIGJ1dCBpdCBjYXVzZWQgaXNzdWVzIGxpa2UgdGhlIG9uZQoJCS8vIGRpc2NvdmVyZWQgYnkgQ2hyaXNTIGhlcmU6IGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzEyMjgyI2NvbW1lbnQ6MTUKCQlpZiAoIGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIgKSB7CgkJCS8vIEhhbmRsZSBpdCBhc3luY2hyb25vdXNseSB0byBhbGxvdyBzY3JpcHRzIHRoZSBvcHBvcnR1bml0eSB0byBkZWxheSByZWFkeQoJCQlzZXRUaW1lb3V0KCBqUXVlcnkucmVhZHkgKTsKCgkJLy8gU3RhbmRhcmRzLWJhc2VkIGJyb3dzZXJzIHN1cHBvcnQgRE9NQ29udGVudExvYWRlZAoJCX0gZWxzZSBpZiAoIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIgKSB7CgkJCS8vIFVzZSB0aGUgaGFuZHkgZXZlbnQgY2FsbGJhY2sKCQkJZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciggIkRPTUNvbnRlbnRMb2FkZWQiLCBjb21wbGV0ZWQsIGZhbHNlICk7CgoJCQkvLyBBIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQsIHRoYXQgd2lsbCBhbHdheXMgd29yawoJCQl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lciggImxvYWQiLCBjb21wbGV0ZWQsIGZhbHNlICk7CgoJCS8vIElmIElFIGV2ZW50IG1vZGVsIGlzIHVzZWQKCQl9IGVsc2UgewoJCQkvLyBFbnN1cmUgZmlyaW5nIGJlZm9yZSBvbmxvYWQsIG1heWJlIGxhdGUgYnV0IHNhZmUgYWxzbyBmb3IgaWZyYW1lcwoJCQlkb2N1bWVudC5hdHRhY2hFdmVudCggIm9ucmVhZHlzdGF0ZWNoYW5nZSIsIGNvbXBsZXRlZCApOwoKCQkJLy8gQSBmYWxsYmFjayB0byB3aW5kb3cub25sb2FkLCB0aGF0IHdpbGwgYWx3YXlzIHdvcmsKCQkJd2luZG93LmF0dGFjaEV2ZW50KCAib25sb2FkIiwgY29tcGxldGVkICk7CgoJCQkvLyBJZiBJRSBhbmQgbm90IGEgZnJhbWUKCQkJLy8gY29udGludWFsbHkgY2hlY2sgdG8gc2VlIGlmIHRoZSBkb2N1bWVudCBpcyByZWFkeQoJCQl2YXIgdG9wID0gZmFsc2U7CgoJCQl0cnkgewoJCQkJdG9wID0gd2luZG93LmZyYW1lRWxlbWVudCA9PSBudWxsICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCQkJfSBjYXRjaChlKSB7fQoKCQkJaWYgKCB0b3AgJiYgdG9wLmRvU2Nyb2xsICkgewoJCQkJKGZ1bmN0aW9uIGRvU2Nyb2xsQ2hlY2soKSB7CgkJCQkJaWYgKCAhalF1ZXJ5LmlzUmVhZHkgKSB7CgoJCQkJCQl0cnkgewoJCQkJCQkJLy8gVXNlIHRoZSB0cmljayBieSBEaWVnbyBQZXJpbmkKCQkJCQkJCS8vIGh0dHA6Ly9qYXZhc2NyaXB0Lm53Ym94LmNvbS9JRUNvbnRlbnRMb2FkZWQvCgkJCQkJCQl0b3AuZG9TY3JvbGwoImxlZnQiKTsKCQkJCQkJfSBjYXRjaChlKSB7CgkJCQkJCQlyZXR1cm4gc2V0VGltZW91dCggZG9TY3JvbGxDaGVjaywgNTAgKTsKCQkJCQkJfQoKCQkJCQkJLy8gZGV0YWNoIGFsbCBkb20gcmVhZHkgZXZlbnRzCgkJCQkJCWRldGFjaCgpOwoKCQkJCQkJLy8gYW5kIGV4ZWN1dGUgYW55IHdhaXRpbmcgZnVuY3Rpb25zCgkJCQkJCWpRdWVyeS5yZWFkeSgpOwoJCQkJCX0KCQkJCX0pKCk7CgkJCX0KCQl9Cgl9CglyZXR1cm4gcmVhZHlMaXN0LnByb21pc2UoIG9iaiApOwp9OwoKCnZhciBzdHJ1bmRlZmluZWQgPSB0eXBlb2YgdW5kZWZpbmVkOwoKCgovLyBTdXBwb3J0OiBJRTw5Ci8vIEl0ZXJhdGlvbiBvdmVyIG9iamVjdCdzIGluaGVyaXRlZCBwcm9wZXJ0aWVzIGJlZm9yZSBpdHMgb3duCnZhciBpOwpmb3IgKCBpIGluIGpRdWVyeSggc3VwcG9ydCApICkgewoJYnJlYWs7Cn0Kc3VwcG9ydC5vd25MYXN0ID0gaSAhPT0gIjAiOwoKLy8gTm90ZTogbW9zdCBzdXBwb3J0IHRlc3RzIGFyZSBkZWZpbmVkIGluIHRoZWlyIHJlc3BlY3RpdmUgbW9kdWxlcy4KLy8gZmFsc2UgdW50aWwgdGhlIHRlc3QgaXMgcnVuCnN1cHBvcnQuaW5saW5lQmxvY2tOZWVkc0xheW91dCA9IGZhbHNlOwoKalF1ZXJ5KGZ1bmN0aW9uKCkgewoJLy8gV2UgbmVlZCB0byBleGVjdXRlIHRoaXMgb25lIHN1cHBvcnQgdGVzdCBBU0FQIGJlY2F1c2Ugd2UgbmVlZCB0byBrbm93CgkvLyBpZiBib2R5LnN0eWxlLnpvb20gbmVlZHMgdG8gYmUgc2V0LgoKCXZhciBjb250YWluZXIsIGRpdiwKCQlib2R5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImJvZHkiKVswXTsKCglpZiAoICFib2R5ICkgewoJCS8vIFJldHVybiBmb3IgZnJhbWVzZXQgZG9jcyB0aGF0IGRvbid0IGhhdmUgYSBib2R5CgkJcmV0dXJuOwoJfQoKCS8vIFNldHVwCgljb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJY29udGFpbmVyLnN0eWxlLmNzc1RleHQgPSAiYm9yZGVyOjA7d2lkdGg6MDtoZWlnaHQ6MDtwb3NpdGlvbjphYnNvbHV0ZTt0b3A6MDtsZWZ0Oi05OTk5cHg7bWFyZ2luLXRvcDoxcHgiOwoKCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7Cglib2R5LmFwcGVuZENoaWxkKCBjb250YWluZXIgKS5hcHBlbmRDaGlsZCggZGl2ICk7CgoJaWYgKCB0eXBlb2YgZGl2LnN0eWxlLnpvb20gIT09IHN0cnVuZGVmaW5lZCApIHsKCQkvLyBTdXBwb3J0OiBJRTw4CgkJLy8gQ2hlY2sgaWYgbmF0aXZlbHkgYmxvY2stbGV2ZWwgZWxlbWVudHMgYWN0IGxpa2UgaW5saW5lLWJsb2NrCgkJLy8gZWxlbWVudHMgd2hlbiBzZXR0aW5nIHRoZWlyIGRpc3BsYXkgdG8gJ2lubGluZScgYW5kIGdpdmluZwoJCS8vIHRoZW0gbGF5b3V0CgkJZGl2LnN0eWxlLmNzc1RleHQgPSAiYm9yZGVyOjA7bWFyZ2luOjA7d2lkdGg6MXB4O3BhZGRpbmc6MXB4O2Rpc3BsYXk6aW5saW5lO3pvb206MSI7CgoJCWlmICggKHN1cHBvcnQuaW5saW5lQmxvY2tOZWVkc0xheW91dCA9ICggZGl2Lm9mZnNldFdpZHRoID09PSAzICkpICkgewoJCQkvLyBQcmV2ZW50IElFIDYgZnJvbSBhZmZlY3RpbmcgbGF5b3V0IGZvciBwb3NpdGlvbmVkIGVsZW1lbnRzICMxMTA0OAoJCQkvLyBQcmV2ZW50IElFIGZyb20gc2hyaW5raW5nIHRoZSBib2R5IGluIElFIDcgbW9kZSAjMTI4NjkKCQkJLy8gU3VwcG9ydDogSUU8OAoJCQlib2R5LnN0eWxlLnpvb20gPSAxOwoJCX0KCX0KCglib2R5LnJlbW92ZUNoaWxkKCBjb250YWluZXIgKTsKCgkvLyBOdWxsIGVsZW1lbnRzIHRvIGF2b2lkIGxlYWtzIGluIElFCgljb250YWluZXIgPSBkaXYgPSBudWxsOwp9KTsKCgoKCihmdW5jdGlvbigpIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoKCS8vIEV4ZWN1dGUgdGhlIHRlc3Qgb25seSBpZiBub3QgYWxyZWFkeSBleGVjdXRlZCBpbiBhbm90aGVyIG1vZHVsZS4KCWlmIChzdXBwb3J0LmRlbGV0ZUV4cGFuZG8gPT0gbnVsbCkgewoJCS8vIFN1cHBvcnQ6IElFPDkKCQlzdXBwb3J0LmRlbGV0ZUV4cGFuZG8gPSB0cnVlOwoJCXRyeSB7CgkJCWRlbGV0ZSBkaXYudGVzdDsKCQl9IGNhdGNoKCBlICkgewoJCQlzdXBwb3J0LmRlbGV0ZUV4cGFuZG8gPSBmYWxzZTsKCQl9Cgl9CgoJLy8gTnVsbCBlbGVtZW50cyB0byBhdm9pZCBsZWFrcyBpbiBJRS4KCWRpdiA9IG51bGw7Cn0pKCk7CgoKLyoqCiAqIERldGVybWluZXMgd2hldGhlciBhbiBvYmplY3QgY2FuIGhhdmUgZGF0YQogKi8KalF1ZXJ5LmFjY2VwdERhdGEgPSBmdW5jdGlvbiggZWxlbSApIHsKCXZhciBub0RhdGEgPSBqUXVlcnkubm9EYXRhWyAoZWxlbS5ub2RlTmFtZSArICIgIikudG9Mb3dlckNhc2UoKSBdLAoJCW5vZGVUeXBlID0gK2VsZW0ubm9kZVR5cGUgfHwgMTsKCgkvLyBEbyBub3Qgc2V0IGRhdGEgb24gbm9uLWVsZW1lbnQgRE9NIG5vZGVzIGJlY2F1c2UgaXQgd2lsbCBub3QgYmUgY2xlYXJlZCAoIzgzMzUpLgoJcmV0dXJuIG5vZGVUeXBlICE9PSAxICYmIG5vZGVUeXBlICE9PSA5ID8KCQlmYWxzZSA6CgoJCS8vIE5vZGVzIGFjY2VwdCBkYXRhIHVubGVzcyBvdGhlcndpc2Ugc3BlY2lmaWVkOyByZWplY3Rpb24gY2FuIGJlIGNvbmRpdGlvbmFsCgkJIW5vRGF0YSB8fCBub0RhdGEgIT09IHRydWUgJiYgZWxlbS5nZXRBdHRyaWJ1dGUoImNsYXNzaWQiKSA9PT0gbm9EYXRhOwp9OwoKCnZhciByYnJhY2UgPSAvXig/Olx7W1x3XFddKlx9fFxbW1x3XFddKlxdKSQvLAoJcm11bHRpRGFzaCA9IC8oW0EtWl0pL2c7CgpmdW5jdGlvbiBkYXRhQXR0ciggZWxlbSwga2V5LCBkYXRhICkgewoJLy8gSWYgbm90aGluZyB3YXMgZm91bmQgaW50ZXJuYWxseSwgdHJ5IHRvIGZldGNoIGFueQoJLy8gZGF0YSBmcm9tIHRoZSBIVE1MNSBkYXRhLSogYXR0cmlidXRlCglpZiAoIGRhdGEgPT09IHVuZGVmaW5lZCAmJiBlbGVtLm5vZGVUeXBlID09PSAxICkgewoKCQl2YXIgbmFtZSA9ICJkYXRhLSIgKyBrZXkucmVwbGFjZSggcm11bHRpRGFzaCwgIi0kMSIgKS50b0xvd2VyQ2FzZSgpOwoKCQlkYXRhID0gZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUgKTsKCgkJaWYgKCB0eXBlb2YgZGF0YSA9PT0gInN0cmluZyIgKSB7CgkJCXRyeSB7CgkJCQlkYXRhID0gZGF0YSA9PT0gInRydWUiID8gdHJ1ZSA6CgkJCQkJZGF0YSA9PT0gImZhbHNlIiA/IGZhbHNlIDoKCQkJCQlkYXRhID09PSAibnVsbCIgPyBudWxsIDoKCQkJCQkvLyBPbmx5IGNvbnZlcnQgdG8gYSBudW1iZXIgaWYgaXQgZG9lc24ndCBjaGFuZ2UgdGhlIHN0cmluZwoJCQkJCStkYXRhICsgIiIgPT09IGRhdGEgPyArZGF0YSA6CgkJCQkJcmJyYWNlLnRlc3QoIGRhdGEgKSA/IGpRdWVyeS5wYXJzZUpTT04oIGRhdGEgKSA6CgkJCQkJZGF0YTsKCQkJfSBjYXRjaCggZSApIHt9CgoJCQkvLyBNYWtlIHN1cmUgd2Ugc2V0IHRoZSBkYXRhIHNvIGl0IGlzbid0IGNoYW5nZWQgbGF0ZXIKCQkJalF1ZXJ5LmRhdGEoIGVsZW0sIGtleSwgZGF0YSApOwoKCQl9IGVsc2UgewoJCQlkYXRhID0gdW5kZWZpbmVkOwoJCX0KCX0KCglyZXR1cm4gZGF0YTsKfQoKLy8gY2hlY2tzIGEgY2FjaGUgb2JqZWN0IGZvciBlbXB0aW5lc3MKZnVuY3Rpb24gaXNFbXB0eURhdGFPYmplY3QoIG9iaiApIHsKCXZhciBuYW1lOwoJZm9yICggbmFtZSBpbiBvYmogKSB7CgoJCS8vIGlmIHRoZSBwdWJsaWMgZGF0YSBvYmplY3QgaXMgZW1wdHksIHRoZSBwcml2YXRlIGlzIHN0aWxsIGVtcHR5CgkJaWYgKCBuYW1lID09PSAiZGF0YSIgJiYgalF1ZXJ5LmlzRW1wdHlPYmplY3QoIG9ialtuYW1lXSApICkgewoJCQljb250aW51ZTsKCQl9CgkJaWYgKCBuYW1lICE9PSAidG9KU09OIiApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX0KCglyZXR1cm4gdHJ1ZTsKfQoKZnVuY3Rpb24gaW50ZXJuYWxEYXRhKCBlbGVtLCBuYW1lLCBkYXRhLCBwdnQgLyogSW50ZXJuYWwgVXNlIE9ubHkgKi8gKSB7CglpZiAoICFqUXVlcnkuYWNjZXB0RGF0YSggZWxlbSApICkgewoJCXJldHVybjsKCX0KCgl2YXIgcmV0LCB0aGlzQ2FjaGUsCgkJaW50ZXJuYWxLZXkgPSBqUXVlcnkuZXhwYW5kbywKCgkJLy8gV2UgaGF2ZSB0byBoYW5kbGUgRE9NIG5vZGVzIGFuZCBKUyBvYmplY3RzIGRpZmZlcmVudGx5IGJlY2F1c2UgSUU2LTcKCQkvLyBjYW4ndCBHQyBvYmplY3QgcmVmZXJlbmNlcyBwcm9wZXJseSBhY3Jvc3MgdGhlIERPTS1KUyBib3VuZGFyeQoJCWlzTm9kZSA9IGVsZW0ubm9kZVR5cGUsCgoJCS8vIE9ubHkgRE9NIG5vZGVzIG5lZWQgdGhlIGdsb2JhbCBqUXVlcnkgY2FjaGU7IEpTIG9iamVjdCBkYXRhIGlzCgkJLy8gYXR0YWNoZWQgZGlyZWN0bHkgdG8gdGhlIG9iamVjdCBzbyBHQyBjYW4gb2NjdXIgYXV0b21hdGljYWxseQoJCWNhY2hlID0gaXNOb2RlID8galF1ZXJ5LmNhY2hlIDogZWxlbSwKCgkJLy8gT25seSBkZWZpbmluZyBhbiBJRCBmb3IgSlMgb2JqZWN0cyBpZiBpdHMgY2FjaGUgYWxyZWFkeSBleGlzdHMgYWxsb3dzCgkJLy8gdGhlIGNvZGUgdG8gc2hvcnRjdXQgb24gdGhlIHNhbWUgcGF0aCBhcyBhIERPTSBub2RlIHdpdGggbm8gY2FjaGUKCQlpZCA9IGlzTm9kZSA/IGVsZW1bIGludGVybmFsS2V5IF0gOiBlbGVtWyBpbnRlcm5hbEtleSBdICYmIGludGVybmFsS2V5OwoKCS8vIEF2b2lkIGRvaW5nIGFueSBtb3JlIHdvcmsgdGhhbiB3ZSBuZWVkIHRvIHdoZW4gdHJ5aW5nIHRvIGdldCBkYXRhIG9uIGFuCgkvLyBvYmplY3QgdGhhdCBoYXMgbm8gZGF0YSBhdCBhbGwKCWlmICggKCFpZCB8fCAhY2FjaGVbaWRdIHx8ICghcHZ0ICYmICFjYWNoZVtpZF0uZGF0YSkpICYmIGRhdGEgPT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIgKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggIWlkICkgewoJCS8vIE9ubHkgRE9NIG5vZGVzIG5lZWQgYSBuZXcgdW5pcXVlIElEIGZvciBlYWNoIGVsZW1lbnQgc2luY2UgdGhlaXIgZGF0YQoJCS8vIGVuZHMgdXAgaW4gdGhlIGdsb2JhbCBjYWNoZQoJCWlmICggaXNOb2RlICkgewoJCQlpZCA9IGVsZW1bIGludGVybmFsS2V5IF0gPSBkZWxldGVkSWRzLnBvcCgpIHx8IGpRdWVyeS5ndWlkKys7CgkJfSBlbHNlIHsKCQkJaWQgPSBpbnRlcm5hbEtleTsKCQl9Cgl9CgoJaWYgKCAhY2FjaGVbIGlkIF0gKSB7CgkJLy8gQXZvaWQgZXhwb3NpbmcgalF1ZXJ5IG1ldGFkYXRhIG9uIHBsYWluIEpTIG9iamVjdHMgd2hlbiB0aGUgb2JqZWN0CgkJLy8gaXMgc2VyaWFsaXplZCB1c2luZyBKU09OLnN0cmluZ2lmeQoJCWNhY2hlWyBpZCBdID0gaXNOb2RlID8ge30gOiB7IHRvSlNPTjogalF1ZXJ5Lm5vb3AgfTsKCX0KCgkvLyBBbiBvYmplY3QgY2FuIGJlIHBhc3NlZCB0byBqUXVlcnkuZGF0YSBpbnN0ZWFkIG9mIGEga2V5L3ZhbHVlIHBhaXI7IHRoaXMgZ2V0cwoJLy8gc2hhbGxvdyBjb3BpZWQgb3ZlciBvbnRvIHRoZSBleGlzdGluZyBjYWNoZQoJaWYgKCB0eXBlb2YgbmFtZSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIG5hbWUgPT09ICJmdW5jdGlvbiIgKSB7CgkJaWYgKCBwdnQgKSB7CgkJCWNhY2hlWyBpZCBdID0galF1ZXJ5LmV4dGVuZCggY2FjaGVbIGlkIF0sIG5hbWUgKTsKCQl9IGVsc2UgewoJCQljYWNoZVsgaWQgXS5kYXRhID0galF1ZXJ5LmV4dGVuZCggY2FjaGVbIGlkIF0uZGF0YSwgbmFtZSApOwoJCX0KCX0KCgl0aGlzQ2FjaGUgPSBjYWNoZVsgaWQgXTsKCgkvLyBqUXVlcnkgZGF0YSgpIGlzIHN0b3JlZCBpbiBhIHNlcGFyYXRlIG9iamVjdCBpbnNpZGUgdGhlIG9iamVjdCdzIGludGVybmFsIGRhdGEKCS8vIGNhY2hlIGluIG9yZGVyIHRvIGF2b2lkIGtleSBjb2xsaXNpb25zIGJldHdlZW4gaW50ZXJuYWwgZGF0YSBhbmQgdXNlci1kZWZpbmVkCgkvLyBkYXRhLgoJaWYgKCAhcHZ0ICkgewoJCWlmICggIXRoaXNDYWNoZS5kYXRhICkgewoJCQl0aGlzQ2FjaGUuZGF0YSA9IHt9OwoJCX0KCgkJdGhpc0NhY2hlID0gdGhpc0NhY2hlLmRhdGE7Cgl9CgoJaWYgKCBkYXRhICE9PSB1bmRlZmluZWQgKSB7CgkJdGhpc0NhY2hlWyBqUXVlcnkuY2FtZWxDYXNlKCBuYW1lICkgXSA9IGRhdGE7Cgl9CgoJLy8gQ2hlY2sgZm9yIGJvdGggY29udmVydGVkLXRvLWNhbWVsIGFuZCBub24tY29udmVydGVkIGRhdGEgcHJvcGVydHkgbmFtZXMKCS8vIElmIGEgZGF0YSBwcm9wZXJ0eSB3YXMgc3BlY2lmaWVkCglpZiAoIHR5cGVvZiBuYW1lID09PSAic3RyaW5nIiApIHsKCgkJLy8gRmlyc3QgVHJ5IHRvIGZpbmQgYXMtaXMgcHJvcGVydHkgZGF0YQoJCXJldCA9IHRoaXNDYWNoZVsgbmFtZSBdOwoKCQkvLyBUZXN0IGZvciBudWxsfHVuZGVmaW5lZCBwcm9wZXJ0eSBkYXRhCgkJaWYgKCByZXQgPT0gbnVsbCApIHsKCgkJCS8vIFRyeSB0byBmaW5kIHRoZSBjYW1lbENhc2VkIHByb3BlcnR5CgkJCXJldCA9IHRoaXNDYWNoZVsgalF1ZXJ5LmNhbWVsQ2FzZSggbmFtZSApIF07CgkJfQoJfSBlbHNlIHsKCQlyZXQgPSB0aGlzQ2FjaGU7Cgl9CgoJcmV0dXJuIHJldDsKfQoKZnVuY3Rpb24gaW50ZXJuYWxSZW1vdmVEYXRhKCBlbGVtLCBuYW1lLCBwdnQgKSB7CglpZiAoICFqUXVlcnkuYWNjZXB0RGF0YSggZWxlbSApICkgewoJCXJldHVybjsKCX0KCgl2YXIgdGhpc0NhY2hlLCBpLAoJCWlzTm9kZSA9IGVsZW0ubm9kZVR5cGUsCgoJCS8vIFNlZSBqUXVlcnkuZGF0YSBmb3IgbW9yZSBpbmZvcm1hdGlvbgoJCWNhY2hlID0gaXNOb2RlID8galF1ZXJ5LmNhY2hlIDogZWxlbSwKCQlpZCA9IGlzTm9kZSA/IGVsZW1bIGpRdWVyeS5leHBhbmRvIF0gOiBqUXVlcnkuZXhwYW5kbzsKCgkvLyBJZiB0aGVyZSBpcyBhbHJlYWR5IG5vIGNhY2hlIGVudHJ5IGZvciB0aGlzIG9iamVjdCwgdGhlcmUgaXMgbm8KCS8vIHB1cnBvc2UgaW4gY29udGludWluZwoJaWYgKCAhY2FjaGVbIGlkIF0gKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggbmFtZSApIHsKCgkJdGhpc0NhY2hlID0gcHZ0ID8gY2FjaGVbIGlkIF0gOiBjYWNoZVsgaWQgXS5kYXRhOwoKCQlpZiAoIHRoaXNDYWNoZSApIHsKCgkJCS8vIFN1cHBvcnQgYXJyYXkgb3Igc3BhY2Ugc2VwYXJhdGVkIHN0cmluZyBuYW1lcyBmb3IgZGF0YSBrZXlzCgkJCWlmICggIWpRdWVyeS5pc0FycmF5KCBuYW1lICkgKSB7CgoJCQkJLy8gdHJ5IHRoZSBzdHJpbmcgYXMgYSBrZXkgYmVmb3JlIGFueSBtYW5pcHVsYXRpb24KCQkJCWlmICggbmFtZSBpbiB0aGlzQ2FjaGUgKSB7CgkJCQkJbmFtZSA9IFsgbmFtZSBdOwoJCQkJfSBlbHNlIHsKCgkJCQkJLy8gc3BsaXQgdGhlIGNhbWVsIGNhc2VkIHZlcnNpb24gYnkgc3BhY2VzIHVubGVzcyBhIGtleSB3aXRoIHRoZSBzcGFjZXMgZXhpc3RzCgkJCQkJbmFtZSA9IGpRdWVyeS5jYW1lbENhc2UoIG5hbWUgKTsKCQkJCQlpZiAoIG5hbWUgaW4gdGhpc0NhY2hlICkgewoJCQkJCQluYW1lID0gWyBuYW1lIF07CgkJCQkJfSBlbHNlIHsKCQkJCQkJbmFtZSA9IG5hbWUuc3BsaXQoIiAiKTsKCQkJCQl9CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQkvLyBJZiAibmFtZSIgaXMgYW4gYXJyYXkgb2Yga2V5cy4uLgoJCQkJLy8gV2hlbiBkYXRhIGlzIGluaXRpYWxseSBjcmVhdGVkLCB2aWEgKCJrZXkiLCAidmFsIikgc2lnbmF0dXJlLAoJCQkJLy8ga2V5cyB3aWxsIGJlIGNvbnZlcnRlZCB0byBjYW1lbENhc2UuCgkJCQkvLyBTaW5jZSB0aGVyZSBpcyBubyB3YXkgdG8gdGVsbCBfaG93XyBhIGtleSB3YXMgYWRkZWQsIHJlbW92ZQoJCQkJLy8gYm90aCBwbGFpbiBrZXkgYW5kIGNhbWVsQ2FzZSBrZXkuICMxMjc4NgoJCQkJLy8gVGhpcyB3aWxsIG9ubHkgcGVuYWxpemUgdGhlIGFycmF5IGFyZ3VtZW50IHBhdGguCgkJCQluYW1lID0gbmFtZS5jb25jYXQoIGpRdWVyeS5tYXAoIG5hbWUsIGpRdWVyeS5jYW1lbENhc2UgKSApOwoJCQl9CgoJCQlpID0gbmFtZS5sZW5ndGg7CgkJCXdoaWxlICggaS0tICkgewoJCQkJZGVsZXRlIHRoaXNDYWNoZVsgbmFtZVtpXSBdOwoJCQl9CgoJCQkvLyBJZiB0aGVyZSBpcyBubyBkYXRhIGxlZnQgaW4gdGhlIGNhY2hlLCB3ZSB3YW50IHRvIGNvbnRpbnVlCgkJCS8vIGFuZCBsZXQgdGhlIGNhY2hlIG9iamVjdCBpdHNlbGYgZ2V0IGRlc3Ryb3llZAoJCQlpZiAoIHB2dCA/ICFpc0VtcHR5RGF0YU9iamVjdCh0aGlzQ2FjaGUpIDogIWpRdWVyeS5pc0VtcHR5T2JqZWN0KHRoaXNDYWNoZSkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQl9Cgl9CgoJLy8gU2VlIGpRdWVyeS5kYXRhIGZvciBtb3JlIGluZm9ybWF0aW9uCglpZiAoICFwdnQgKSB7CgkJZGVsZXRlIGNhY2hlWyBpZCBdLmRhdGE7CgoJCS8vIERvbid0IGRlc3Ryb3kgdGhlIHBhcmVudCBjYWNoZSB1bmxlc3MgdGhlIGludGVybmFsIGRhdGEgb2JqZWN0CgkJLy8gaGFkIGJlZW4gdGhlIG9ubHkgdGhpbmcgbGVmdCBpbiBpdAoJCWlmICggIWlzRW1wdHlEYXRhT2JqZWN0KCBjYWNoZVsgaWQgXSApICkgewoJCQlyZXR1cm47CgkJfQoJfQoKCS8vIERlc3Ryb3kgdGhlIGNhY2hlCglpZiAoIGlzTm9kZSApIHsKCQlqUXVlcnkuY2xlYW5EYXRhKCBbIGVsZW0gXSwgdHJ1ZSApOwoKCS8vIFVzZSBkZWxldGUgd2hlbiBzdXBwb3J0ZWQgZm9yIGV4cGFuZG9zIG9yIGBjYWNoZWAgaXMgbm90IGEgd2luZG93IHBlciBpc1dpbmRvdyAoIzEwMDgwKQoJLyoganNoaW50IGVxZXFlcTogZmFsc2UgKi8KCX0gZWxzZSBpZiAoIHN1cHBvcnQuZGVsZXRlRXhwYW5kbyB8fCBjYWNoZSAhPSBjYWNoZS53aW5kb3cgKSB7CgkJLyoganNoaW50IGVxZXFlcTogdHJ1ZSAqLwoJCWRlbGV0ZSBjYWNoZVsgaWQgXTsKCgkvLyBXaGVuIGFsbCBlbHNlIGZhaWxzLCBudWxsCgl9IGVsc2UgewoJCWNhY2hlWyBpZCBdID0gbnVsbDsKCX0KfQoKalF1ZXJ5LmV4dGVuZCh7CgljYWNoZToge30sCgoJLy8gVGhlIGZvbGxvd2luZyBlbGVtZW50cyAoc3BhY2Utc3VmZml4ZWQgdG8gYXZvaWQgT2JqZWN0LnByb3RvdHlwZSBjb2xsaXNpb25zKQoJLy8gdGhyb3cgdW5jYXRjaGFibGUgZXhjZXB0aW9ucyBpZiB5b3UgYXR0ZW1wdCB0byBzZXQgZXhwYW5kbyBwcm9wZXJ0aWVzCglub0RhdGE6IHsKCQkiYXBwbGV0ICI6IHRydWUsCgkJImVtYmVkICI6IHRydWUsCgkJLy8gLi4uYnV0IEZsYXNoIG9iamVjdHMgKHdoaWNoIGhhdmUgdGhpcyBjbGFzc2lkKSAqY2FuKiBoYW5kbGUgZXhwYW5kb3MKCQkib2JqZWN0ICI6ICJjbHNpZDpEMjdDREI2RS1BRTZELTExY2YtOTZCOC00NDQ1NTM1NDAwMDAiCgl9LAoKCWhhc0RhdGE6IGZ1bmN0aW9uKCBlbGVtICkgewoJCWVsZW0gPSBlbGVtLm5vZGVUeXBlID8galF1ZXJ5LmNhY2hlWyBlbGVtW2pRdWVyeS5leHBhbmRvXSBdIDogZWxlbVsgalF1ZXJ5LmV4cGFuZG8gXTsKCQlyZXR1cm4gISFlbGVtICYmICFpc0VtcHR5RGF0YU9iamVjdCggZWxlbSApOwoJfSwKCglkYXRhOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgZGF0YSApIHsKCQlyZXR1cm4gaW50ZXJuYWxEYXRhKCBlbGVtLCBuYW1lLCBkYXRhICk7Cgl9LAoKCXJlbW92ZURhdGE6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCXJldHVybiBpbnRlcm5hbFJlbW92ZURhdGEoIGVsZW0sIG5hbWUgKTsKCX0sCgoJLy8gRm9yIGludGVybmFsIHVzZSBvbmx5LgoJX2RhdGE6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBkYXRhICkgewoJCXJldHVybiBpbnRlcm5hbERhdGEoIGVsZW0sIG5hbWUsIGRhdGEsIHRydWUgKTsKCX0sCgoJX3JlbW92ZURhdGE6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCXJldHVybiBpbnRlcm5hbFJlbW92ZURhdGEoIGVsZW0sIG5hbWUsIHRydWUgKTsKCX0KfSk7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCWRhdGE6IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXZhciBpLCBuYW1lLCBkYXRhLAoJCQllbGVtID0gdGhpc1swXSwKCQkJYXR0cnMgPSBlbGVtICYmIGVsZW0uYXR0cmlidXRlczsKCgkJLy8gU3BlY2lhbCBleHBlY3Rpb25zIG9mIC5kYXRhIGJhc2ljYWxseSB0aHdhcnQgalF1ZXJ5LmFjY2VzcywKCQkvLyBzbyBpbXBsZW1lbnQgdGhlIHJlbGV2YW50IGJlaGF2aW9yIG91cnNlbHZlcwoKCQkvLyBHZXRzIGFsbCB2YWx1ZXMKCQlpZiAoIGtleSA9PT0gdW5kZWZpbmVkICkgewoJCQlpZiAoIHRoaXMubGVuZ3RoICkgewoJCQkJZGF0YSA9IGpRdWVyeS5kYXRhKCBlbGVtICk7CgoJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICYmICFqUXVlcnkuX2RhdGEoIGVsZW0sICJwYXJzZWRBdHRycyIgKSApIHsKCQkJCQlpID0gYXR0cnMubGVuZ3RoOwoJCQkJCXdoaWxlICggaS0tICkgewoJCQkJCQluYW1lID0gYXR0cnNbaV0ubmFtZTsKCgkJCQkJCWlmICggbmFtZS5pbmRleE9mKCJkYXRhLSIpID09PSAwICkgewoJCQkJCQkJbmFtZSA9IGpRdWVyeS5jYW1lbENhc2UoIG5hbWUuc2xpY2UoNSkgKTsKCgkJCQkJCQlkYXRhQXR0ciggZWxlbSwgbmFtZSwgZGF0YVsgbmFtZSBdICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJalF1ZXJ5Ll9kYXRhKCBlbGVtLCAicGFyc2VkQXR0cnMiLCB0cnVlICk7CgkJCQl9CgkJCX0KCgkJCXJldHVybiBkYXRhOwoJCX0KCgkJLy8gU2V0cyBtdWx0aXBsZSB2YWx1ZXMKCQlpZiAoIHR5cGVvZiBrZXkgPT09ICJvYmplY3QiICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJalF1ZXJ5LmRhdGEoIHRoaXMsIGtleSApOwoJCQl9KTsKCQl9CgoJCXJldHVybiBhcmd1bWVudHMubGVuZ3RoID4gMSA/CgoJCQkvLyBTZXRzIG9uZSB2YWx1ZQoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQlqUXVlcnkuZGF0YSggdGhpcywga2V5LCB2YWx1ZSApOwoJCQl9KSA6CgoJCQkvLyBHZXRzIG9uZSB2YWx1ZQoJCQkvLyBUcnkgdG8gZmV0Y2ggYW55IGludGVybmFsbHkgc3RvcmVkIGRhdGEgZmlyc3QKCQkJZWxlbSA/IGRhdGFBdHRyKCBlbGVtLCBrZXksIGpRdWVyeS5kYXRhKCBlbGVtLCBrZXkgKSApIDogdW5kZWZpbmVkOwoJfSwKCglyZW1vdmVEYXRhOiBmdW5jdGlvbigga2V5ICkgewoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWpRdWVyeS5yZW1vdmVEYXRhKCB0aGlzLCBrZXkgKTsKCQl9KTsKCX0KfSk7CgoKalF1ZXJ5LmV4dGVuZCh7CglxdWV1ZTogZnVuY3Rpb24oIGVsZW0sIHR5cGUsIGRhdGEgKSB7CgkJdmFyIHF1ZXVlOwoKCQlpZiAoIGVsZW0gKSB7CgkJCXR5cGUgPSAoIHR5cGUgfHwgImZ4IiApICsgInF1ZXVlIjsKCQkJcXVldWUgPSBqUXVlcnkuX2RhdGEoIGVsZW0sIHR5cGUgKTsKCgkJCS8vIFNwZWVkIHVwIGRlcXVldWUgYnkgZ2V0dGluZyBvdXQgcXVpY2tseSBpZiB0aGlzIGlzIGp1c3QgYSBsb29rdXAKCQkJaWYgKCBkYXRhICkgewoJCQkJaWYgKCAhcXVldWUgfHwgalF1ZXJ5LmlzQXJyYXkoZGF0YSkgKSB7CgkJCQkJcXVldWUgPSBqUXVlcnkuX2RhdGEoIGVsZW0sIHR5cGUsIGpRdWVyeS5tYWtlQXJyYXkoZGF0YSkgKTsKCQkJCX0gZWxzZSB7CgkJCQkJcXVldWUucHVzaCggZGF0YSApOwoJCQkJfQoJCQl9CgkJCXJldHVybiBxdWV1ZSB8fCBbXTsKCQl9Cgl9LAoKCWRlcXVldWU6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlICkgewoJCXR5cGUgPSB0eXBlIHx8ICJmeCI7CgoJCXZhciBxdWV1ZSA9IGpRdWVyeS5xdWV1ZSggZWxlbSwgdHlwZSApLAoJCQlzdGFydExlbmd0aCA9IHF1ZXVlLmxlbmd0aCwKCQkJZm4gPSBxdWV1ZS5zaGlmdCgpLAoJCQlob29rcyA9IGpRdWVyeS5fcXVldWVIb29rcyggZWxlbSwgdHlwZSApLAoJCQluZXh0ID0gZnVuY3Rpb24oKSB7CgkJCQlqUXVlcnkuZGVxdWV1ZSggZWxlbSwgdHlwZSApOwoJCQl9OwoKCQkvLyBJZiB0aGUgZnggcXVldWUgaXMgZGVxdWV1ZWQsIGFsd2F5cyByZW1vdmUgdGhlIHByb2dyZXNzIHNlbnRpbmVsCgkJaWYgKCBmbiA9PT0gImlucHJvZ3Jlc3MiICkgewoJCQlmbiA9IHF1ZXVlLnNoaWZ0KCk7CgkJCXN0YXJ0TGVuZ3RoLS07CgkJfQoKCQlpZiAoIGZuICkgewoKCQkJLy8gQWRkIGEgcHJvZ3Jlc3Mgc2VudGluZWwgdG8gcHJldmVudCB0aGUgZnggcXVldWUgZnJvbSBiZWluZwoJCQkvLyBhdXRvbWF0aWNhbGx5IGRlcXVldWVkCgkJCWlmICggdHlwZSA9PT0gImZ4IiApIHsKCQkJCXF1ZXVlLnVuc2hpZnQoICJpbnByb2dyZXNzIiApOwoJCQl9CgoJCQkvLyBjbGVhciB1cCB0aGUgbGFzdCBxdWV1ZSBzdG9wIGZ1bmN0aW9uCgkJCWRlbGV0ZSBob29rcy5zdG9wOwoJCQlmbi5jYWxsKCBlbGVtLCBuZXh0LCBob29rcyApOwoJCX0KCgkJaWYgKCAhc3RhcnRMZW5ndGggJiYgaG9va3MgKSB7CgkJCWhvb2tzLmVtcHR5LmZpcmUoKTsKCQl9Cgl9LAoKCS8vIG5vdCBpbnRlbmRlZCBmb3IgcHVibGljIGNvbnN1bXB0aW9uIC0gZ2VuZXJhdGVzIGEgcXVldWVIb29rcyBvYmplY3QsIG9yIHJldHVybnMgdGhlIGN1cnJlbnQgb25lCglfcXVldWVIb29rczogZnVuY3Rpb24oIGVsZW0sIHR5cGUgKSB7CgkJdmFyIGtleSA9IHR5cGUgKyAicXVldWVIb29rcyI7CgkJcmV0dXJuIGpRdWVyeS5fZGF0YSggZWxlbSwga2V5ICkgfHwgalF1ZXJ5Ll9kYXRhKCBlbGVtLCBrZXksIHsKCQkJZW1wdHk6IGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IikuYWRkKGZ1bmN0aW9uKCkgewoJCQkJalF1ZXJ5Ll9yZW1vdmVEYXRhKCBlbGVtLCB0eXBlICsgInF1ZXVlIiApOwoJCQkJalF1ZXJ5Ll9yZW1vdmVEYXRhKCBlbGVtLCBrZXkgKTsKCQkJfSkKCQl9KTsKCX0KfSk7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCXF1ZXVlOiBmdW5jdGlvbiggdHlwZSwgZGF0YSApIHsKCQl2YXIgc2V0dGVyID0gMjsKCgkJaWYgKCB0eXBlb2YgdHlwZSAhPT0gInN0cmluZyIgKSB7CgkJCWRhdGEgPSB0eXBlOwoJCQl0eXBlID0gImZ4IjsKCQkJc2V0dGVyLS07CgkJfQoKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPCBzZXR0ZXIgKSB7CgkJCXJldHVybiBqUXVlcnkucXVldWUoIHRoaXNbMF0sIHR5cGUgKTsKCQl9CgoJCXJldHVybiBkYXRhID09PSB1bmRlZmluZWQgPwoJCQl0aGlzIDoKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIHF1ZXVlID0galF1ZXJ5LnF1ZXVlKCB0aGlzLCB0eXBlLCBkYXRhICk7CgoJCQkJLy8gZW5zdXJlIGEgaG9va3MgZm9yIHRoaXMgcXVldWUKCQkJCWpRdWVyeS5fcXVldWVIb29rcyggdGhpcywgdHlwZSApOwoKCQkJCWlmICggdHlwZSA9PT0gImZ4IiAmJiBxdWV1ZVswXSAhPT0gImlucHJvZ3Jlc3MiICkgewoJCQkJCWpRdWVyeS5kZXF1ZXVlKCB0aGlzLCB0eXBlICk7CgkJCQl9CgkJCX0pOwoJfSwKCWRlcXVldWU6IGZ1bmN0aW9uKCB0eXBlICkgewoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWpRdWVyeS5kZXF1ZXVlKCB0aGlzLCB0eXBlICk7CgkJfSk7Cgl9LAoJY2xlYXJRdWV1ZTogZnVuY3Rpb24oIHR5cGUgKSB7CgkJcmV0dXJuIHRoaXMucXVldWUoIHR5cGUgfHwgImZ4IiwgW10gKTsKCX0sCgkvLyBHZXQgYSBwcm9taXNlIHJlc29sdmVkIHdoZW4gcXVldWVzIG9mIGEgY2VydGFpbiB0eXBlCgkvLyBhcmUgZW1wdGllZCAoZnggaXMgdGhlIHR5cGUgYnkgZGVmYXVsdCkKCXByb21pc2U6IGZ1bmN0aW9uKCB0eXBlLCBvYmogKSB7CgkJdmFyIHRtcCwKCQkJY291bnQgPSAxLAoJCQlkZWZlciA9IGpRdWVyeS5EZWZlcnJlZCgpLAoJCQllbGVtZW50cyA9IHRoaXMsCgkJCWkgPSB0aGlzLmxlbmd0aCwKCQkJcmVzb2x2ZSA9IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCAhKCAtLWNvdW50ICkgKSB7CgkJCQkJZGVmZXIucmVzb2x2ZVdpdGgoIGVsZW1lbnRzLCBbIGVsZW1lbnRzIF0gKTsKCQkJCX0KCQkJfTsKCgkJaWYgKCB0eXBlb2YgdHlwZSAhPT0gInN0cmluZyIgKSB7CgkJCW9iaiA9IHR5cGU7CgkJCXR5cGUgPSB1bmRlZmluZWQ7CgkJfQoJCXR5cGUgPSB0eXBlIHx8ICJmeCI7CgoJCXdoaWxlICggaS0tICkgewoJCQl0bXAgPSBqUXVlcnkuX2RhdGEoIGVsZW1lbnRzWyBpIF0sIHR5cGUgKyAicXVldWVIb29rcyIgKTsKCQkJaWYgKCB0bXAgJiYgdG1wLmVtcHR5ICkgewoJCQkJY291bnQrKzsKCQkJCXRtcC5lbXB0eS5hZGQoIHJlc29sdmUgKTsKCQkJfQoJCX0KCQlyZXNvbHZlKCk7CgkJcmV0dXJuIGRlZmVyLnByb21pc2UoIG9iaiApOwoJfQp9KTsKdmFyIHBudW0gPSAoL1srLV0/KD86XGQqXC58KVxkKyg/OltlRV1bKy1dP1xkK3wpLykuc291cmNlOwoKdmFyIGNzc0V4cGFuZCA9IFsgIlRvcCIsICJSaWdodCIsICJCb3R0b20iLCAiTGVmdCIgXTsKCnZhciBpc0hpZGRlbiA9IGZ1bmN0aW9uKCBlbGVtLCBlbCApIHsKCQkvLyBpc0hpZGRlbiBtaWdodCBiZSBjYWxsZWQgZnJvbSBqUXVlcnkjZmlsdGVyIGZ1bmN0aW9uOwoJCS8vIGluIHRoYXQgY2FzZSwgZWxlbWVudCB3aWxsIGJlIHNlY29uZCBhcmd1bWVudAoJCWVsZW0gPSBlbCB8fCBlbGVtOwoJCXJldHVybiBqUXVlcnkuY3NzKCBlbGVtLCAiZGlzcGxheSIgKSA9PT0gIm5vbmUiIHx8ICFqUXVlcnkuY29udGFpbnMoIGVsZW0ub3duZXJEb2N1bWVudCwgZWxlbSApOwoJfTsKCgoKLy8gTXVsdGlmdW5jdGlvbmFsIG1ldGhvZCB0byBnZXQgYW5kIHNldCB2YWx1ZXMgb2YgYSBjb2xsZWN0aW9uCi8vIFRoZSB2YWx1ZS9zIGNhbiBvcHRpb25hbGx5IGJlIGV4ZWN1dGVkIGlmIGl0J3MgYSBmdW5jdGlvbgp2YXIgYWNjZXNzID0galF1ZXJ5LmFjY2VzcyA9IGZ1bmN0aW9uKCBlbGVtcywgZm4sIGtleSwgdmFsdWUsIGNoYWluYWJsZSwgZW1wdHlHZXQsIHJhdyApIHsKCXZhciBpID0gMCwKCQlsZW5ndGggPSBlbGVtcy5sZW5ndGgsCgkJYnVsayA9IGtleSA9PSBudWxsOwoKCS8vIFNldHMgbWFueSB2YWx1ZXMKCWlmICggalF1ZXJ5LnR5cGUoIGtleSApID09PSAib2JqZWN0IiApIHsKCQljaGFpbmFibGUgPSB0cnVlOwoJCWZvciAoIGkgaW4ga2V5ICkgewoJCQlqUXVlcnkuYWNjZXNzKCBlbGVtcywgZm4sIGksIGtleVtpXSwgdHJ1ZSwgZW1wdHlHZXQsIHJhdyApOwoJCX0KCgkvLyBTZXRzIG9uZSB2YWx1ZQoJfSBlbHNlIGlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQljaGFpbmFibGUgPSB0cnVlOwoKCQlpZiAoICFqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcmF3ID0gdHJ1ZTsKCQl9CgoJCWlmICggYnVsayApIHsKCQkJLy8gQnVsayBvcGVyYXRpb25zIHJ1biBhZ2FpbnN0IHRoZSBlbnRpcmUgc2V0CgkJCWlmICggcmF3ICkgewoJCQkJZm4uY2FsbCggZWxlbXMsIHZhbHVlICk7CgkJCQlmbiA9IG51bGw7CgoJCQkvLyAuLi5leGNlcHQgd2hlbiBleGVjdXRpbmcgZnVuY3Rpb24gdmFsdWVzCgkJCX0gZWxzZSB7CgkJCQlidWxrID0gZm47CgkJCQlmbiA9IGZ1bmN0aW9uKCBlbGVtLCBrZXksIHZhbHVlICkgewoJCQkJCXJldHVybiBidWxrLmNhbGwoIGpRdWVyeSggZWxlbSApLCB2YWx1ZSApOwoJCQkJfTsKCQkJfQoJCX0KCgkJaWYgKCBmbiApIHsKCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQlmbiggZWxlbXNbaV0sIGtleSwgcmF3ID8gdmFsdWUgOiB2YWx1ZS5jYWxsKCBlbGVtc1tpXSwgaSwgZm4oIGVsZW1zW2ldLCBrZXkgKSApICk7CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIGNoYWluYWJsZSA/CgkJZWxlbXMgOgoKCQkvLyBHZXRzCgkJYnVsayA/CgkJCWZuLmNhbGwoIGVsZW1zICkgOgoJCQlsZW5ndGggPyBmbiggZWxlbXNbMF0sIGtleSApIDogZW1wdHlHZXQ7Cn07CnZhciByY2hlY2thYmxlVHlwZSA9ICgvXig/OmNoZWNrYm94fHJhZGlvKSQvaSk7CgoKCihmdW5jdGlvbigpIHsKCXZhciBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwKCQlkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSwKCQlpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CgoJLy8gU2V0dXAKCWRpdi5zZXRBdHRyaWJ1dGUoICJjbGFzc05hbWUiLCAidCIgKTsKCWRpdi5pbm5lckhUTUwgPSAiICA8bGluay8+PHRhYmxlPjwvdGFibGU+PGEgaHJlZj0nL2EnPmE8L2E+IjsKCgkvLyBJRSBzdHJpcHMgbGVhZGluZyB3aGl0ZXNwYWNlIHdoZW4gLmlubmVySFRNTCBpcyB1c2VkCglzdXBwb3J0LmxlYWRpbmdXaGl0ZXNwYWNlID0gZGl2LmZpcnN0Q2hpbGQubm9kZVR5cGUgPT09IDM7CgoJLy8gTWFrZSBzdXJlIHRoYXQgdGJvZHkgZWxlbWVudHMgYXJlbid0IGF1dG9tYXRpY2FsbHkgaW5zZXJ0ZWQKCS8vIElFIHdpbGwgaW5zZXJ0IHRoZW0gaW50byBlbXB0eSB0YWJsZXMKCXN1cHBvcnQudGJvZHkgPSAhZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCAidGJvZHkiICkubGVuZ3RoOwoKCS8vIE1ha2Ugc3VyZSB0aGF0IGxpbmsgZWxlbWVudHMgZ2V0IHNlcmlhbGl6ZWQgY29ycmVjdGx5IGJ5IGlubmVySFRNTAoJLy8gVGhpcyByZXF1aXJlcyBhIHdyYXBwZXIgZWxlbWVudCBpbiBJRQoJc3VwcG9ydC5odG1sU2VyaWFsaXplID0gISFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoICJsaW5rIiApLmxlbmd0aDsKCgkvLyBNYWtlcyBzdXJlIGNsb25pbmcgYW4gaHRtbDUgZWxlbWVudCBkb2VzIG5vdCBjYXVzZSBwcm9ibGVtcwoJLy8gV2hlcmUgb3V0ZXJIVE1MIGlzIHVuZGVmaW5lZCwgdGhpcyBzdGlsbCB3b3JrcwoJc3VwcG9ydC5odG1sNUNsb25lID0KCQlkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAibmF2IiApLmNsb25lTm9kZSggdHJ1ZSApLm91dGVySFRNTCAhPT0gIjw6bmF2PjwvOm5hdj4iOwoKCS8vIENoZWNrIGlmIGEgZGlzY29ubmVjdGVkIGNoZWNrYm94IHdpbGwgcmV0YWluIGl0cyBjaGVja2VkCgkvLyB2YWx1ZSBvZiB0cnVlIGFmdGVyIGFwcGVuZGVkIHRvIHRoZSBET00gKElFNi83KQoJaW5wdXQudHlwZSA9ICJjaGVja2JveCI7CglpbnB1dC5jaGVja2VkID0gdHJ1ZTsKCWZyYWdtZW50LmFwcGVuZENoaWxkKCBpbnB1dCApOwoJc3VwcG9ydC5hcHBlbmRDaGVja2VkID0gaW5wdXQuY2hlY2tlZDsKCgkvLyBNYWtlIHN1cmUgdGV4dGFyZWEgKGFuZCBjaGVja2JveCkgZGVmYXVsdFZhbHVlIGlzIHByb3Blcmx5IGNsb25lZAoJLy8gU3VwcG9ydDogSUU2LUlFMTErCglkaXYuaW5uZXJIVE1MID0gIjx0ZXh0YXJlYT54PC90ZXh0YXJlYT4iOwoJc3VwcG9ydC5ub0Nsb25lQ2hlY2tlZCA9ICEhZGl2LmNsb25lTm9kZSggdHJ1ZSApLmxhc3RDaGlsZC5kZWZhdWx0VmFsdWU7CgoJLy8gIzExMjE3IC0gV2ViS2l0IGxvc2VzIGNoZWNrIHdoZW4gdGhlIG5hbWUgaXMgYWZ0ZXIgdGhlIGNoZWNrZWQgYXR0cmlidXRlCglmcmFnbWVudC5hcHBlbmRDaGlsZCggZGl2ICk7CglkaXYuaW5uZXJIVE1MID0gIjxpbnB1dCB0eXBlPSdyYWRpbycgY2hlY2tlZD0nY2hlY2tlZCcgbmFtZT0ndCcvPiI7CgoJLy8gU3VwcG9ydDogU2FmYXJpIDUuMSwgaU9TIDUuMSwgQW5kcm9pZCA0LngsIEFuZHJvaWQgMi4zCgkvLyBvbGQgV2ViS2l0IGRvZXNuJ3QgY2xvbmUgY2hlY2tlZCBzdGF0ZSBjb3JyZWN0bHkgaW4gZnJhZ21lbnRzCglzdXBwb3J0LmNoZWNrQ2xvbmUgPSBkaXYuY2xvbmVOb2RlKCB0cnVlICkuY2xvbmVOb2RlKCB0cnVlICkubGFzdENoaWxkLmNoZWNrZWQ7CgoJLy8gU3VwcG9ydDogSUU8OQoJLy8gT3BlcmEgZG9lcyBub3QgY2xvbmUgZXZlbnRzIChhbmQgdHlwZW9mIGRpdi5hdHRhY2hFdmVudCA9PT0gdW5kZWZpbmVkKS4KCS8vIElFOS0xMCBjbG9uZXMgZXZlbnRzIGJvdW5kIHZpYSBhdHRhY2hFdmVudCwgYnV0IHRoZXkgZG9uJ3QgdHJpZ2dlciB3aXRoIC5jbGljaygpCglzdXBwb3J0Lm5vQ2xvbmVFdmVudCA9IHRydWU7CglpZiAoIGRpdi5hdHRhY2hFdmVudCApIHsKCQlkaXYuYXR0YWNoRXZlbnQoICJvbmNsaWNrIiwgZnVuY3Rpb24oKSB7CgkJCXN1cHBvcnQubm9DbG9uZUV2ZW50ID0gZmFsc2U7CgkJfSk7CgoJCWRpdi5jbG9uZU5vZGUoIHRydWUgKS5jbGljaygpOwoJfQoKCS8vIEV4ZWN1dGUgdGhlIHRlc3Qgb25seSBpZiBub3QgYWxyZWFkeSBleGVjdXRlZCBpbiBhbm90aGVyIG1vZHVsZS4KCWlmIChzdXBwb3J0LmRlbGV0ZUV4cGFuZG8gPT0gbnVsbCkgewoJCS8vIFN1cHBvcnQ6IElFPDkKCQlzdXBwb3J0LmRlbGV0ZUV4cGFuZG8gPSB0cnVlOwoJCXRyeSB7CgkJCWRlbGV0ZSBkaXYudGVzdDsKCQl9IGNhdGNoKCBlICkgewoJCQlzdXBwb3J0LmRlbGV0ZUV4cGFuZG8gPSBmYWxzZTsKCQl9Cgl9CgoJLy8gTnVsbCBlbGVtZW50cyB0byBhdm9pZCBsZWFrcyBpbiBJRS4KCWZyYWdtZW50ID0gZGl2ID0gaW5wdXQgPSBudWxsOwp9KSgpOwoKCihmdW5jdGlvbigpIHsKCXZhciBpLCBldmVudE5hbWUsCgkJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCgkvLyBTdXBwb3J0OiBJRTw5IChsYWNrIHN1Ym1pdC9jaGFuZ2UgYnViYmxlKSwgRmlyZWZveCAyMysgKGxhY2sgZm9jdXNpbiBldmVudCkKCWZvciAoIGkgaW4geyBzdWJtaXQ6IHRydWUsIGNoYW5nZTogdHJ1ZSwgZm9jdXNpbjogdHJ1ZSB9KSB7CgkJZXZlbnROYW1lID0gIm9uIiArIGk7CgoJCWlmICggIShzdXBwb3J0WyBpICsgIkJ1YmJsZXMiIF0gPSBldmVudE5hbWUgaW4gd2luZG93KSApIHsKCQkJLy8gQmV3YXJlIG9mIENTUCByZXN0cmljdGlvbnMgKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL1NlY3VyaXR5L0NTUCkKCQkJZGl2LnNldEF0dHJpYnV0ZSggZXZlbnROYW1lLCAidCIgKTsKCQkJc3VwcG9ydFsgaSArICJCdWJibGVzIiBdID0gZGl2LmF0dHJpYnV0ZXNbIGV2ZW50TmFtZSBdLmV4cGFuZG8gPT09IGZhbHNlOwoJCX0KCX0KCgkvLyBOdWxsIGVsZW1lbnRzIHRvIGF2b2lkIGxlYWtzIGluIElFLgoJZGl2ID0gbnVsbDsKfSkoKTsKCgp2YXIgcmZvcm1FbGVtcyA9IC9eKD86aW5wdXR8c2VsZWN0fHRleHRhcmVhKSQvaSwKCXJrZXlFdmVudCA9IC9ea2V5LywKCXJtb3VzZUV2ZW50ID0gL14oPzptb3VzZXxjb250ZXh0bWVudSl8Y2xpY2svLAoJcmZvY3VzTW9ycGggPSAvXig/OmZvY3VzaW5mb2N1c3xmb2N1c291dGJsdXIpJC8sCglydHlwZW5hbWVzcGFjZSA9IC9eKFteLl0qKSg/OlwuKC4rKXwpJC87CgpmdW5jdGlvbiByZXR1cm5UcnVlKCkgewoJcmV0dXJuIHRydWU7Cn0KCmZ1bmN0aW9uIHJldHVybkZhbHNlKCkgewoJcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBzYWZlQWN0aXZlRWxlbWVudCgpIHsKCXRyeSB7CgkJcmV0dXJuIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7Cgl9IGNhdGNoICggZXJyICkgeyB9Cn0KCi8qCiAqIEhlbHBlciBmdW5jdGlvbnMgZm9yIG1hbmFnaW5nIGV2ZW50cyAtLSBub3QgcGFydCBvZiB0aGUgcHVibGljIGludGVyZmFjZS4KICogUHJvcHMgdG8gRGVhbiBFZHdhcmRzJyBhZGRFdmVudCBsaWJyYXJ5IGZvciBtYW55IG9mIHRoZSBpZGVhcy4KICovCmpRdWVyeS5ldmVudCA9IHsKCglnbG9iYWw6IHt9LAoKCWFkZDogZnVuY3Rpb24oIGVsZW0sIHR5cGVzLCBoYW5kbGVyLCBkYXRhLCBzZWxlY3RvciApIHsKCQl2YXIgdG1wLCBldmVudHMsIHQsIGhhbmRsZU9iakluLAoJCQlzcGVjaWFsLCBldmVudEhhbmRsZSwgaGFuZGxlT2JqLAoJCQloYW5kbGVycywgdHlwZSwgbmFtZXNwYWNlcywgb3JpZ1R5cGUsCgkJCWVsZW1EYXRhID0galF1ZXJ5Ll9kYXRhKCBlbGVtICk7CgoJCS8vIERvbid0IGF0dGFjaCBldmVudHMgdG8gbm9EYXRhIG9yIHRleHQvY29tbWVudCBub2RlcyAoYnV0IGFsbG93IHBsYWluIG9iamVjdHMpCgkJaWYgKCAhZWxlbURhdGEgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIENhbGxlciBjYW4gcGFzcyBpbiBhbiBvYmplY3Qgb2YgY3VzdG9tIGRhdGEgaW4gbGlldSBvZiB0aGUgaGFuZGxlcgoJCWlmICggaGFuZGxlci5oYW5kbGVyICkgewoJCQloYW5kbGVPYmpJbiA9IGhhbmRsZXI7CgkJCWhhbmRsZXIgPSBoYW5kbGVPYmpJbi5oYW5kbGVyOwoJCQlzZWxlY3RvciA9IGhhbmRsZU9iakluLnNlbGVjdG9yOwoJCX0KCgkJLy8gTWFrZSBzdXJlIHRoYXQgdGhlIGhhbmRsZXIgaGFzIGEgdW5pcXVlIElELCB1c2VkIHRvIGZpbmQvcmVtb3ZlIGl0IGxhdGVyCgkJaWYgKCAhaGFuZGxlci5ndWlkICkgewoJCQloYW5kbGVyLmd1aWQgPSBqUXVlcnkuZ3VpZCsrOwoJCX0KCgkJLy8gSW5pdCB0aGUgZWxlbWVudCdzIGV2ZW50IHN0cnVjdHVyZSBhbmQgbWFpbiBoYW5kbGVyLCBpZiB0aGlzIGlzIHRoZSBmaXJzdAoJCWlmICggIShldmVudHMgPSBlbGVtRGF0YS5ldmVudHMpICkgewoJCQlldmVudHMgPSBlbGVtRGF0YS5ldmVudHMgPSB7fTsKCQl9CgkJaWYgKCAhKGV2ZW50SGFuZGxlID0gZWxlbURhdGEuaGFuZGxlKSApIHsKCQkJZXZlbnRIYW5kbGUgPSBlbGVtRGF0YS5oYW5kbGUgPSBmdW5jdGlvbiggZSApIHsKCQkJCS8vIERpc2NhcmQgdGhlIHNlY29uZCBldmVudCBvZiBhIGpRdWVyeS5ldmVudC50cmlnZ2VyKCkgYW5kCgkJCQkvLyB3aGVuIGFuIGV2ZW50IGlzIGNhbGxlZCBhZnRlciBhIHBhZ2UgaGFzIHVubG9hZGVkCgkJCQlyZXR1cm4gdHlwZW9mIGpRdWVyeSAhPT0gc3RydW5kZWZpbmVkICYmICghZSB8fCBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkICE9PSBlLnR5cGUpID8KCQkJCQlqUXVlcnkuZXZlbnQuZGlzcGF0Y2guYXBwbHkoIGV2ZW50SGFuZGxlLmVsZW0sIGFyZ3VtZW50cyApIDoKCQkJCQl1bmRlZmluZWQ7CgkJCX07CgkJCS8vIEFkZCBlbGVtIGFzIGEgcHJvcGVydHkgb2YgdGhlIGhhbmRsZSBmbiB0byBwcmV2ZW50IGEgbWVtb3J5IGxlYWsgd2l0aCBJRSBub24tbmF0aXZlIGV2ZW50cwoJCQlldmVudEhhbmRsZS5lbGVtID0gZWxlbTsKCQl9CgoJCS8vIEhhbmRsZSBtdWx0aXBsZSBldmVudHMgc2VwYXJhdGVkIGJ5IGEgc3BhY2UKCQl0eXBlcyA9ICggdHlwZXMgfHwgIiIgKS5tYXRjaCggcm5vdHdoaXRlICkgfHwgWyAiIiBdOwoJCXQgPSB0eXBlcy5sZW5ndGg7CgkJd2hpbGUgKCB0LS0gKSB7CgkJCXRtcCA9IHJ0eXBlbmFtZXNwYWNlLmV4ZWMoIHR5cGVzW3RdICkgfHwgW107CgkJCXR5cGUgPSBvcmlnVHlwZSA9IHRtcFsxXTsKCQkJbmFtZXNwYWNlcyA9ICggdG1wWzJdIHx8ICIiICkuc3BsaXQoICIuIiApLnNvcnQoKTsKCgkJCS8vIFRoZXJlICptdXN0KiBiZSBhIHR5cGUsIG5vIGF0dGFjaGluZyBuYW1lc3BhY2Utb25seSBoYW5kbGVycwoJCQlpZiAoICF0eXBlICkgewoJCQkJY29udGludWU7CgkJCX0KCgkJCS8vIElmIGV2ZW50IGNoYW5nZXMgaXRzIHR5cGUsIHVzZSB0aGUgc3BlY2lhbCBldmVudCBoYW5kbGVycyBmb3IgdGhlIGNoYW5nZWQgdHlwZQoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKCgkJCS8vIElmIHNlbGVjdG9yIGRlZmluZWQsIGRldGVybWluZSBzcGVjaWFsIGV2ZW50IGFwaSB0eXBlLCBvdGhlcndpc2UgZ2l2ZW4gdHlwZQoJCQl0eXBlID0gKCBzZWxlY3RvciA/IHNwZWNpYWwuZGVsZWdhdGVUeXBlIDogc3BlY2lhbC5iaW5kVHlwZSApIHx8IHR5cGU7CgoJCQkvLyBVcGRhdGUgc3BlY2lhbCBiYXNlZCBvbiBuZXdseSByZXNldCB0eXBlCgkJCXNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9OwoKCQkJLy8gaGFuZGxlT2JqIGlzIHBhc3NlZCB0byBhbGwgZXZlbnQgaGFuZGxlcnMKCQkJaGFuZGxlT2JqID0galF1ZXJ5LmV4dGVuZCh7CgkJCQl0eXBlOiB0eXBlLAoJCQkJb3JpZ1R5cGU6IG9yaWdUeXBlLAoJCQkJZGF0YTogZGF0YSwKCQkJCWhhbmRsZXI6IGhhbmRsZXIsCgkJCQlndWlkOiBoYW5kbGVyLmd1aWQsCgkJCQlzZWxlY3Rvcjogc2VsZWN0b3IsCgkJCQluZWVkc0NvbnRleHQ6IHNlbGVjdG9yICYmIGpRdWVyeS5leHByLm1hdGNoLm5lZWRzQ29udGV4dC50ZXN0KCBzZWxlY3RvciApLAoJCQkJbmFtZXNwYWNlOiBuYW1lc3BhY2VzLmpvaW4oIi4iKQoJCQl9LCBoYW5kbGVPYmpJbiApOwoKCQkJLy8gSW5pdCB0aGUgZXZlbnQgaGFuZGxlciBxdWV1ZSBpZiB3ZSdyZSB0aGUgZmlyc3QKCQkJaWYgKCAhKGhhbmRsZXJzID0gZXZlbnRzWyB0eXBlIF0pICkgewoJCQkJaGFuZGxlcnMgPSBldmVudHNbIHR5cGUgXSA9IFtdOwoJCQkJaGFuZGxlcnMuZGVsZWdhdGVDb3VudCA9IDA7CgoJCQkJLy8gT25seSB1c2UgYWRkRXZlbnRMaXN0ZW5lci9hdHRhY2hFdmVudCBpZiB0aGUgc3BlY2lhbCBldmVudHMgaGFuZGxlciByZXR1cm5zIGZhbHNlCgkJCQlpZiAoICFzcGVjaWFsLnNldHVwIHx8IHNwZWNpYWwuc2V0dXAuY2FsbCggZWxlbSwgZGF0YSwgbmFtZXNwYWNlcywgZXZlbnRIYW5kbGUgKSA9PT0gZmFsc2UgKSB7CgkJCQkJLy8gQmluZCB0aGUgZ2xvYmFsIGV2ZW50IGhhbmRsZXIgdG8gdGhlIGVsZW1lbnQKCQkJCQlpZiAoIGVsZW0uYWRkRXZlbnRMaXN0ZW5lciApIHsKCQkJCQkJZWxlbS5hZGRFdmVudExpc3RlbmVyKCB0eXBlLCBldmVudEhhbmRsZSwgZmFsc2UgKTsKCgkJCQkJfSBlbHNlIGlmICggZWxlbS5hdHRhY2hFdmVudCApIHsKCQkJCQkJZWxlbS5hdHRhY2hFdmVudCggIm9uIiArIHR5cGUsIGV2ZW50SGFuZGxlICk7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlpZiAoIHNwZWNpYWwuYWRkICkgewoJCQkJc3BlY2lhbC5hZGQuY2FsbCggZWxlbSwgaGFuZGxlT2JqICk7CgoJCQkJaWYgKCAhaGFuZGxlT2JqLmhhbmRsZXIuZ3VpZCApIHsKCQkJCQloYW5kbGVPYmouaGFuZGxlci5ndWlkID0gaGFuZGxlci5ndWlkOwoJCQkJfQoJCQl9CgoJCQkvLyBBZGQgdG8gdGhlIGVsZW1lbnQncyBoYW5kbGVyIGxpc3QsIGRlbGVnYXRlcyBpbiBmcm9udAoJCQlpZiAoIHNlbGVjdG9yICkgewoJCQkJaGFuZGxlcnMuc3BsaWNlKCBoYW5kbGVycy5kZWxlZ2F0ZUNvdW50KyssIDAsIGhhbmRsZU9iaiApOwoJCQl9IGVsc2UgewoJCQkJaGFuZGxlcnMucHVzaCggaGFuZGxlT2JqICk7CgkJCX0KCgkJCS8vIEtlZXAgdHJhY2sgb2Ygd2hpY2ggZXZlbnRzIGhhdmUgZXZlciBiZWVuIHVzZWQsIGZvciBldmVudCBvcHRpbWl6YXRpb24KCQkJalF1ZXJ5LmV2ZW50Lmdsb2JhbFsgdHlwZSBdID0gdHJ1ZTsKCQl9CgoJCS8vIE51bGxpZnkgZWxlbSB0byBwcmV2ZW50IG1lbW9yeSBsZWFrcyBpbiBJRQoJCWVsZW0gPSBudWxsOwoJfSwKCgkvLyBEZXRhY2ggYW4gZXZlbnQgb3Igc2V0IG9mIGV2ZW50cyBmcm9tIGFuIGVsZW1lbnQKCXJlbW92ZTogZnVuY3Rpb24oIGVsZW0sIHR5cGVzLCBoYW5kbGVyLCBzZWxlY3RvciwgbWFwcGVkVHlwZXMgKSB7CgkJdmFyIGosIGhhbmRsZU9iaiwgdG1wLAoJCQlvcmlnQ291bnQsIHQsIGV2ZW50cywKCQkJc3BlY2lhbCwgaGFuZGxlcnMsIHR5cGUsCgkJCW5hbWVzcGFjZXMsIG9yaWdUeXBlLAoJCQllbGVtRGF0YSA9IGpRdWVyeS5oYXNEYXRhKCBlbGVtICkgJiYgalF1ZXJ5Ll9kYXRhKCBlbGVtICk7CgoJCWlmICggIWVsZW1EYXRhIHx8ICEoZXZlbnRzID0gZWxlbURhdGEuZXZlbnRzKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gT25jZSBmb3IgZWFjaCB0eXBlLm5hbWVzcGFjZSBpbiB0eXBlczsgdHlwZSBtYXkgYmUgb21pdHRlZAoJCXR5cGVzID0gKCB0eXBlcyB8fCAiIiApLm1hdGNoKCBybm90d2hpdGUgKSB8fCBbICIiIF07CgkJdCA9IHR5cGVzLmxlbmd0aDsKCQl3aGlsZSAoIHQtLSApIHsKCQkJdG1wID0gcnR5cGVuYW1lc3BhY2UuZXhlYyggdHlwZXNbdF0gKSB8fCBbXTsKCQkJdHlwZSA9IG9yaWdUeXBlID0gdG1wWzFdOwoJCQluYW1lc3BhY2VzID0gKCB0bXBbMl0gfHwgIiIgKS5zcGxpdCggIi4iICkuc29ydCgpOwoKCQkJLy8gVW5iaW5kIGFsbCBldmVudHMgKG9uIHRoaXMgbmFtZXNwYWNlLCBpZiBwcm92aWRlZCkgZm9yIHRoZSBlbGVtZW50CgkJCWlmICggIXR5cGUgKSB7CgkJCQlmb3IgKCB0eXBlIGluIGV2ZW50cyApIHsKCQkJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCBlbGVtLCB0eXBlICsgdHlwZXNbIHQgXSwgaGFuZGxlciwgc2VsZWN0b3IsIHRydWUgKTsKCQkJCX0KCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKCQkJdHlwZSA9ICggc2VsZWN0b3IgPyBzcGVjaWFsLmRlbGVnYXRlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUgKSB8fCB0eXBlOwoJCQloYW5kbGVycyA9IGV2ZW50c1sgdHlwZSBdIHx8IFtdOwoJCQl0bXAgPSB0bXBbMl0gJiYgbmV3IFJlZ0V4cCggIihefFxcLikiICsgbmFtZXNwYWNlcy5qb2luKCJcXC4oPzouKlxcLnwpIikgKyAiKFxcLnwkKSIgKTsKCgkJCS8vIFJlbW92ZSBtYXRjaGluZyBldmVudHMKCQkJb3JpZ0NvdW50ID0gaiA9IGhhbmRsZXJzLmxlbmd0aDsKCQkJd2hpbGUgKCBqLS0gKSB7CgkJCQloYW5kbGVPYmogPSBoYW5kbGVyc1sgaiBdOwoKCQkJCWlmICggKCBtYXBwZWRUeXBlcyB8fCBvcmlnVHlwZSA9PT0gaGFuZGxlT2JqLm9yaWdUeXBlICkgJiYKCQkJCQkoICFoYW5kbGVyIHx8IGhhbmRsZXIuZ3VpZCA9PT0gaGFuZGxlT2JqLmd1aWQgKSAmJgoJCQkJCSggIXRtcCB8fCB0bXAudGVzdCggaGFuZGxlT2JqLm5hbWVzcGFjZSApICkgJiYKCQkJCQkoICFzZWxlY3RvciB8fCBzZWxlY3RvciA9PT0gaGFuZGxlT2JqLnNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSAiKioiICYmIGhhbmRsZU9iai5zZWxlY3RvciApICkgewoJCQkJCWhhbmRsZXJzLnNwbGljZSggaiwgMSApOwoKCQkJCQlpZiAoIGhhbmRsZU9iai5zZWxlY3RvciApIHsKCQkJCQkJaGFuZGxlcnMuZGVsZWdhdGVDb3VudC0tOwoJCQkJCX0KCQkJCQlpZiAoIHNwZWNpYWwucmVtb3ZlICkgewoJCQkJCQlzcGVjaWFsLnJlbW92ZS5jYWxsKCBlbGVtLCBoYW5kbGVPYmogKTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCS8vIFJlbW92ZSBnZW5lcmljIGV2ZW50IGhhbmRsZXIgaWYgd2UgcmVtb3ZlZCBzb21ldGhpbmcgYW5kIG5vIG1vcmUgaGFuZGxlcnMgZXhpc3QKCQkJLy8gKGF2b2lkcyBwb3RlbnRpYWwgZm9yIGVuZGxlc3MgcmVjdXJzaW9uIGR1cmluZyByZW1vdmFsIG9mIHNwZWNpYWwgZXZlbnQgaGFuZGxlcnMpCgkJCWlmICggb3JpZ0NvdW50ICYmICFoYW5kbGVycy5sZW5ndGggKSB7CgkJCQlpZiAoICFzcGVjaWFsLnRlYXJkb3duIHx8IHNwZWNpYWwudGVhcmRvd24uY2FsbCggZWxlbSwgbmFtZXNwYWNlcywgZWxlbURhdGEuaGFuZGxlICkgPT09IGZhbHNlICkgewoJCQkJCWpRdWVyeS5yZW1vdmVFdmVudCggZWxlbSwgdHlwZSwgZWxlbURhdGEuaGFuZGxlICk7CgkJCQl9CgoJCQkJZGVsZXRlIGV2ZW50c1sgdHlwZSBdOwoJCQl9CgkJfQoKCQkvLyBSZW1vdmUgdGhlIGV4cGFuZG8gaWYgaXQncyBubyBsb25nZXIgdXNlZAoJCWlmICggalF1ZXJ5LmlzRW1wdHlPYmplY3QoIGV2ZW50cyApICkgewoJCQlkZWxldGUgZWxlbURhdGEuaGFuZGxlOwoKCQkJLy8gcmVtb3ZlRGF0YSBhbHNvIGNoZWNrcyBmb3IgZW1wdGluZXNzIGFuZCBjbGVhcnMgdGhlIGV4cGFuZG8gaWYgZW1wdHkKCQkJLy8gc28gdXNlIGl0IGluc3RlYWQgb2YgZGVsZXRlCgkJCWpRdWVyeS5fcmVtb3ZlRGF0YSggZWxlbSwgImV2ZW50cyIgKTsKCQl9Cgl9LAoKCXRyaWdnZXI6IGZ1bmN0aW9uKCBldmVudCwgZGF0YSwgZWxlbSwgb25seUhhbmRsZXJzICkgewoJCXZhciBoYW5kbGUsIG9udHlwZSwgY3VyLAoJCQlidWJibGVUeXBlLCBzcGVjaWFsLCB0bXAsIGksCgkJCWV2ZW50UGF0aCA9IFsgZWxlbSB8fCBkb2N1bWVudCBdLAoJCQl0eXBlID0gaGFzT3duLmNhbGwoIGV2ZW50LCAidHlwZSIgKSA/IGV2ZW50LnR5cGUgOiBldmVudCwKCQkJbmFtZXNwYWNlcyA9IGhhc093bi5jYWxsKCBldmVudCwgIm5hbWVzcGFjZSIgKSA/IGV2ZW50Lm5hbWVzcGFjZS5zcGxpdCgiLiIpIDogW107CgoJCWN1ciA9IHRtcCA9IGVsZW0gPSBlbGVtIHx8IGRvY3VtZW50OwoKCQkvLyBEb24ndCBkbyBldmVudHMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwoJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4ICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBmb2N1cy9ibHVyIG1vcnBocyB0byBmb2N1c2luL291dDsgZW5zdXJlIHdlJ3JlIG5vdCBmaXJpbmcgdGhlbSByaWdodCBub3cKCQlpZiAoIHJmb2N1c01vcnBoLnRlc3QoIHR5cGUgKyBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggdHlwZS5pbmRleE9mKCIuIikgPj0gMCApIHsKCQkJLy8gTmFtZXNwYWNlZCB0cmlnZ2VyOyBjcmVhdGUgYSByZWdleHAgdG8gbWF0Y2ggZXZlbnQgdHlwZSBpbiBoYW5kbGUoKQoJCQluYW1lc3BhY2VzID0gdHlwZS5zcGxpdCgiLiIpOwoJCQl0eXBlID0gbmFtZXNwYWNlcy5zaGlmdCgpOwoJCQluYW1lc3BhY2VzLnNvcnQoKTsKCQl9CgkJb250eXBlID0gdHlwZS5pbmRleE9mKCI6IikgPCAwICYmICJvbiIgKyB0eXBlOwoKCQkvLyBDYWxsZXIgY2FuIHBhc3MgaW4gYSBqUXVlcnkuRXZlbnQgb2JqZWN0LCBPYmplY3QsIG9yIGp1c3QgYW4gZXZlbnQgdHlwZSBzdHJpbmcKCQlldmVudCA9IGV2ZW50WyBqUXVlcnkuZXhwYW5kbyBdID8KCQkJZXZlbnQgOgoJCQluZXcgalF1ZXJ5LkV2ZW50KCB0eXBlLCB0eXBlb2YgZXZlbnQgPT09ICJvYmplY3QiICYmIGV2ZW50ICk7CgoJCS8vIFRyaWdnZXIgYml0bWFzazogJiAxIGZvciBuYXRpdmUgaGFuZGxlcnM7ICYgMiBmb3IgalF1ZXJ5IChhbHdheXMgdHJ1ZSkKCQlldmVudC5pc1RyaWdnZXIgPSBvbmx5SGFuZGxlcnMgPyAyIDogMzsKCQlldmVudC5uYW1lc3BhY2UgPSBuYW1lc3BhY2VzLmpvaW4oIi4iKTsKCQlldmVudC5uYW1lc3BhY2VfcmUgPSBldmVudC5uYW1lc3BhY2UgPwoJCQluZXcgUmVnRXhwKCAiKF58XFwuKSIgKyBuYW1lc3BhY2VzLmpvaW4oIlxcLig/Oi4qXFwufCkiKSArICIoXFwufCQpIiApIDoKCQkJbnVsbDsKCgkJLy8gQ2xlYW4gdXAgdGhlIGV2ZW50IGluIGNhc2UgaXQgaXMgYmVpbmcgcmV1c2VkCgkJZXZlbnQucmVzdWx0ID0gdW5kZWZpbmVkOwoJCWlmICggIWV2ZW50LnRhcmdldCApIHsKCQkJZXZlbnQudGFyZ2V0ID0gZWxlbTsKCQl9CgoJCS8vIENsb25lIGFueSBpbmNvbWluZyBkYXRhIGFuZCBwcmVwZW5kIHRoZSBldmVudCwgY3JlYXRpbmcgdGhlIGhhbmRsZXIgYXJnIGxpc3QKCQlkYXRhID0gZGF0YSA9PSBudWxsID8KCQkJWyBldmVudCBdIDoKCQkJalF1ZXJ5Lm1ha2VBcnJheSggZGF0YSwgWyBldmVudCBdICk7CgoJCS8vIEFsbG93IHNwZWNpYWwgZXZlbnRzIHRvIGRyYXcgb3V0c2lkZSB0aGUgbGluZXMKCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKCQlpZiAoICFvbmx5SGFuZGxlcnMgJiYgc3BlY2lhbC50cmlnZ2VyICYmIHNwZWNpYWwudHJpZ2dlci5hcHBseSggZWxlbSwgZGF0YSApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gRGV0ZXJtaW5lIGV2ZW50IHByb3BhZ2F0aW9uIHBhdGggaW4gYWR2YW5jZSwgcGVyIFczQyBldmVudHMgc3BlYyAoIzk5NTEpCgkJLy8gQnViYmxlIHVwIHRvIGRvY3VtZW50LCB0aGVuIHRvIHdpbmRvdzsgd2F0Y2ggZm9yIGEgZ2xvYmFsIG93bmVyRG9jdW1lbnQgdmFyICgjOTcyNCkKCQlpZiAoICFvbmx5SGFuZGxlcnMgJiYgIXNwZWNpYWwubm9CdWJibGUgJiYgIWpRdWVyeS5pc1dpbmRvdyggZWxlbSApICkgewoKCQkJYnViYmxlVHlwZSA9IHNwZWNpYWwuZGVsZWdhdGVUeXBlIHx8IHR5cGU7CgkJCWlmICggIXJmb2N1c01vcnBoLnRlc3QoIGJ1YmJsZVR5cGUgKyB0eXBlICkgKSB7CgkJCQljdXIgPSBjdXIucGFyZW50Tm9kZTsKCQkJfQoJCQlmb3IgKCA7IGN1cjsgY3VyID0gY3VyLnBhcmVudE5vZGUgKSB7CgkJCQlldmVudFBhdGgucHVzaCggY3VyICk7CgkJCQl0bXAgPSBjdXI7CgkJCX0KCgkJCS8vIE9ubHkgYWRkIHdpbmRvdyBpZiB3ZSBnb3QgdG8gZG9jdW1lbnQgKGUuZy4sIG5vdCBwbGFpbiBvYmogb3IgZGV0YWNoZWQgRE9NKQoJCQlpZiAoIHRtcCA9PT0gKGVsZW0ub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudCkgKSB7CgkJCQlldmVudFBhdGgucHVzaCggdG1wLmRlZmF1bHRWaWV3IHx8IHRtcC5wYXJlbnRXaW5kb3cgfHwgd2luZG93ICk7CgkJCX0KCQl9CgoJCS8vIEZpcmUgaGFuZGxlcnMgb24gdGhlIGV2ZW50IHBhdGgKCQlpID0gMDsKCQl3aGlsZSAoIChjdXIgPSBldmVudFBhdGhbaSsrXSkgJiYgIWV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgoJCQlldmVudC50eXBlID0gaSA+IDEgPwoJCQkJYnViYmxlVHlwZSA6CgkJCQlzcGVjaWFsLmJpbmRUeXBlIHx8IHR5cGU7CgoJCQkvLyBqUXVlcnkgaGFuZGxlcgoJCQloYW5kbGUgPSAoIGpRdWVyeS5fZGF0YSggY3VyLCAiZXZlbnRzIiApIHx8IHt9IClbIGV2ZW50LnR5cGUgXSAmJiBqUXVlcnkuX2RhdGEoIGN1ciwgImhhbmRsZSIgKTsKCQkJaWYgKCBoYW5kbGUgKSB7CgkJCQloYW5kbGUuYXBwbHkoIGN1ciwgZGF0YSApOwoJCQl9CgoJCQkvLyBOYXRpdmUgaGFuZGxlcgoJCQloYW5kbGUgPSBvbnR5cGUgJiYgY3VyWyBvbnR5cGUgXTsKCQkJaWYgKCBoYW5kbGUgJiYgaGFuZGxlLmFwcGx5ICYmIGpRdWVyeS5hY2NlcHREYXRhKCBjdXIgKSApIHsKCQkJCWV2ZW50LnJlc3VsdCA9IGhhbmRsZS5hcHBseSggY3VyLCBkYXRhICk7CgkJCQlpZiAoIGV2ZW50LnJlc3VsdCA9PT0gZmFsc2UgKSB7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCX0KCQkJfQoJCX0KCQlldmVudC50eXBlID0gdHlwZTsKCgkJLy8gSWYgbm9ib2R5IHByZXZlbnRlZCB0aGUgZGVmYXVsdCBhY3Rpb24sIGRvIGl0IG5vdwoJCWlmICggIW9ubHlIYW5kbGVycyAmJiAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgoJCQlpZiAoICghc3BlY2lhbC5fZGVmYXVsdCB8fCBzcGVjaWFsLl9kZWZhdWx0LmFwcGx5KCBldmVudFBhdGgucG9wKCksIGRhdGEgKSA9PT0gZmFsc2UpICYmCgkJCQlqUXVlcnkuYWNjZXB0RGF0YSggZWxlbSApICkgewoKCQkJCS8vIENhbGwgYSBuYXRpdmUgRE9NIG1ldGhvZCBvbiB0aGUgdGFyZ2V0IHdpdGggdGhlIHNhbWUgbmFtZSBuYW1lIGFzIHRoZSBldmVudC4KCQkJCS8vIENhbid0IHVzZSBhbiAuaXNGdW5jdGlvbigpIGNoZWNrIGhlcmUgYmVjYXVzZSBJRTYvNyBmYWlscyB0aGF0IHRlc3QuCgkJCQkvLyBEb24ndCBkbyBkZWZhdWx0IGFjdGlvbnMgb24gd2luZG93LCB0aGF0J3Mgd2hlcmUgZ2xvYmFsIHZhcmlhYmxlcyBiZSAoIzYxNzApCgkJCQlpZiAoIG9udHlwZSAmJiBlbGVtWyB0eXBlIF0gJiYgIWpRdWVyeS5pc1dpbmRvdyggZWxlbSApICkgewoKCQkJCQkvLyBEb24ndCByZS10cmlnZ2VyIGFuIG9uRk9PIGV2ZW50IHdoZW4gd2UgY2FsbCBpdHMgRk9PKCkgbWV0aG9kCgkJCQkJdG1wID0gZWxlbVsgb250eXBlIF07CgoJCQkJCWlmICggdG1wICkgewoJCQkJCQllbGVtWyBvbnR5cGUgXSA9IG51bGw7CgkJCQkJfQoKCQkJCQkvLyBQcmV2ZW50IHJlLXRyaWdnZXJpbmcgb2YgdGhlIHNhbWUgZXZlbnQsIHNpbmNlIHdlIGFscmVhZHkgYnViYmxlZCBpdCBhYm92ZQoJCQkJCWpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB0eXBlOwoJCQkJCXRyeSB7CgkJCQkJCWVsZW1bIHR5cGUgXSgpOwoJCQkJCX0gY2F0Y2ggKCBlICkgewoJCQkJCQkvLyBJRTw5IGRpZXMgb24gZm9jdXMvYmx1ciB0byBoaWRkZW4gZWxlbWVudCAoIzE0ODYsIzEyNTE4KQoJCQkJCQkvLyBvbmx5IHJlcHJvZHVjaWJsZSBvbiB3aW5YUCBJRTggbmF0aXZlLCBub3QgSUU5IGluIElFOCBtb2RlCgkJCQkJfQoJCQkJCWpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB1bmRlZmluZWQ7CgoJCQkJCWlmICggdG1wICkgewoJCQkJCQllbGVtWyBvbnR5cGUgXSA9IHRtcDsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiBldmVudC5yZXN1bHQ7Cgl9LAoKCWRpc3BhdGNoOiBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCS8vIE1ha2UgYSB3cml0YWJsZSBqUXVlcnkuRXZlbnQgZnJvbSB0aGUgbmF0aXZlIGV2ZW50IG9iamVjdAoJCWV2ZW50ID0galF1ZXJ5LmV2ZW50LmZpeCggZXZlbnQgKTsKCgkJdmFyIGksIHJldCwgaGFuZGxlT2JqLCBtYXRjaGVkLCBqLAoJCQloYW5kbGVyUXVldWUgPSBbXSwKCQkJYXJncyA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApLAoJCQloYW5kbGVycyA9ICggalF1ZXJ5Ll9kYXRhKCB0aGlzLCAiZXZlbnRzIiApIHx8IHt9IClbIGV2ZW50LnR5cGUgXSB8fCBbXSwKCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyBldmVudC50eXBlIF0gfHwge307CgoJCS8vIFVzZSB0aGUgZml4LWVkIGpRdWVyeS5FdmVudCByYXRoZXIgdGhhbiB0aGUgKHJlYWQtb25seSkgbmF0aXZlIGV2ZW50CgkJYXJnc1swXSA9IGV2ZW50OwoJCWV2ZW50LmRlbGVnYXRlVGFyZ2V0ID0gdGhpczsKCgkJLy8gQ2FsbCB0aGUgcHJlRGlzcGF0Y2ggaG9vayBmb3IgdGhlIG1hcHBlZCB0eXBlLCBhbmQgbGV0IGl0IGJhaWwgaWYgZGVzaXJlZAoJCWlmICggc3BlY2lhbC5wcmVEaXNwYXRjaCAmJiBzcGVjaWFsLnByZURpc3BhdGNoLmNhbGwoIHRoaXMsIGV2ZW50ICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBEZXRlcm1pbmUgaGFuZGxlcnMKCQloYW5kbGVyUXVldWUgPSBqUXVlcnkuZXZlbnQuaGFuZGxlcnMuY2FsbCggdGhpcywgZXZlbnQsIGhhbmRsZXJzICk7CgoJCS8vIFJ1biBkZWxlZ2F0ZXMgZmlyc3Q7IHRoZXkgbWF5IHdhbnQgdG8gc3RvcCBwcm9wYWdhdGlvbiBiZW5lYXRoIHVzCgkJaSA9IDA7CgkJd2hpbGUgKCAobWF0Y2hlZCA9IGhhbmRsZXJRdWV1ZVsgaSsrIF0pICYmICFldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQlldmVudC5jdXJyZW50VGFyZ2V0ID0gbWF0Y2hlZC5lbGVtOwoKCQkJaiA9IDA7CgkJCXdoaWxlICggKGhhbmRsZU9iaiA9IG1hdGNoZWQuaGFuZGxlcnNbIGorKyBdKSAmJiAhZXZlbnQuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCgkJCQkvLyBUcmlnZ2VyZWQgZXZlbnQgbXVzdCBlaXRoZXIgMSkgaGF2ZSBubyBuYW1lc3BhY2UsIG9yCgkJCQkvLyAyKSBoYXZlIG5hbWVzcGFjZShzKSBhIHN1YnNldCBvciBlcXVhbCB0byB0aG9zZSBpbiB0aGUgYm91bmQgZXZlbnQgKGJvdGggY2FuIGhhdmUgbm8gbmFtZXNwYWNlKS4KCQkJCWlmICggIWV2ZW50Lm5hbWVzcGFjZV9yZSB8fCBldmVudC5uYW1lc3BhY2VfcmUudGVzdCggaGFuZGxlT2JqLm5hbWVzcGFjZSApICkgewoKCQkJCQlldmVudC5oYW5kbGVPYmogPSBoYW5kbGVPYmo7CgkJCQkJZXZlbnQuZGF0YSA9IGhhbmRsZU9iai5kYXRhOwoKCQkJCQlyZXQgPSAoIChqUXVlcnkuZXZlbnQuc3BlY2lhbFsgaGFuZGxlT2JqLm9yaWdUeXBlIF0gfHwge30pLmhhbmRsZSB8fCBoYW5kbGVPYmouaGFuZGxlciApCgkJCQkJCQkuYXBwbHkoIG1hdGNoZWQuZWxlbSwgYXJncyApOwoKCQkJCQlpZiAoIHJldCAhPT0gdW5kZWZpbmVkICkgewoJCQkJCQlpZiAoIChldmVudC5yZXN1bHQgPSByZXQpID09PSBmYWxzZSApIHsKCQkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJLy8gQ2FsbCB0aGUgcG9zdERpc3BhdGNoIGhvb2sgZm9yIHRoZSBtYXBwZWQgdHlwZQoJCWlmICggc3BlY2lhbC5wb3N0RGlzcGF0Y2ggKSB7CgkJCXNwZWNpYWwucG9zdERpc3BhdGNoLmNhbGwoIHRoaXMsIGV2ZW50ICk7CgkJfQoKCQlyZXR1cm4gZXZlbnQucmVzdWx0OwoJfSwKCgloYW5kbGVyczogZnVuY3Rpb24oIGV2ZW50LCBoYW5kbGVycyApIHsKCQl2YXIgc2VsLCBoYW5kbGVPYmosIG1hdGNoZXMsIGksCgkJCWhhbmRsZXJRdWV1ZSA9IFtdLAoJCQlkZWxlZ2F0ZUNvdW50ID0gaGFuZGxlcnMuZGVsZWdhdGVDb3VudCwKCQkJY3VyID0gZXZlbnQudGFyZ2V0OwoKCQkvLyBGaW5kIGRlbGVnYXRlIGhhbmRsZXJzCgkJLy8gQmxhY2staG9sZSBTVkcgPHVzZT4gaW5zdGFuY2UgdHJlZXMgKCMxMzE4MCkKCQkvLyBBdm9pZCBub24tbGVmdC1jbGljayBidWJibGluZyBpbiBGaXJlZm94ICgjMzg2MSkKCQlpZiAoIGRlbGVnYXRlQ291bnQgJiYgY3VyLm5vZGVUeXBlICYmICghZXZlbnQuYnV0dG9uIHx8IGV2ZW50LnR5cGUgIT09ICJjbGljayIpICkgewoKCQkJLyoganNoaW50IGVxZXFlcTogZmFsc2UgKi8KCQkJZm9yICggOyBjdXIgIT0gdGhpczsgY3VyID0gY3VyLnBhcmVudE5vZGUgfHwgdGhpcyApIHsKCQkJCS8qIGpzaGludCBlcWVxZXE6IHRydWUgKi8KCgkJCQkvLyBEb24ndCBjaGVjayBub24tZWxlbWVudHMgKCMxMzIwOCkKCQkJCS8vIERvbid0IHByb2Nlc3MgY2xpY2tzIG9uIGRpc2FibGVkIGVsZW1lbnRzICgjNjkxMSwgIzgxNjUsICMxMTM4MiwgIzExNzY0KQoJCQkJaWYgKCBjdXIubm9kZVR5cGUgPT09IDEgJiYgKGN1ci5kaXNhYmxlZCAhPT0gdHJ1ZSB8fCBldmVudC50eXBlICE9PSAiY2xpY2siKSApIHsKCQkJCQltYXRjaGVzID0gW107CgkJCQkJZm9yICggaSA9IDA7IGkgPCBkZWxlZ2F0ZUNvdW50OyBpKysgKSB7CgkJCQkJCWhhbmRsZU9iaiA9IGhhbmRsZXJzWyBpIF07CgoJCQkJCQkvLyBEb24ndCBjb25mbGljdCB3aXRoIE9iamVjdC5wcm90b3R5cGUgcHJvcGVydGllcyAoIzEzMjAzKQoJCQkJCQlzZWwgPSBoYW5kbGVPYmouc2VsZWN0b3IgKyAiICI7CgoJCQkJCQlpZiAoIG1hdGNoZXNbIHNlbCBdID09PSB1bmRlZmluZWQgKSB7CgkJCQkJCQltYXRjaGVzWyBzZWwgXSA9IGhhbmRsZU9iai5uZWVkc0NvbnRleHQgPwoJCQkJCQkJCWpRdWVyeSggc2VsLCB0aGlzICkuaW5kZXgoIGN1ciApID49IDAgOgoJCQkJCQkJCWpRdWVyeS5maW5kKCBzZWwsIHRoaXMsIG51bGwsIFsgY3VyIF0gKS5sZW5ndGg7CgkJCQkJCX0KCQkJCQkJaWYgKCBtYXRjaGVzWyBzZWwgXSApIHsKCQkJCQkJCW1hdGNoZXMucHVzaCggaGFuZGxlT2JqICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJaWYgKCBtYXRjaGVzLmxlbmd0aCApIHsKCQkJCQkJaGFuZGxlclF1ZXVlLnB1c2goeyBlbGVtOiBjdXIsIGhhbmRsZXJzOiBtYXRjaGVzIH0pOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJLy8gQWRkIHRoZSByZW1haW5pbmcgKGRpcmVjdGx5LWJvdW5kKSBoYW5kbGVycwoJCWlmICggZGVsZWdhdGVDb3VudCA8IGhhbmRsZXJzLmxlbmd0aCApIHsKCQkJaGFuZGxlclF1ZXVlLnB1c2goeyBlbGVtOiB0aGlzLCBoYW5kbGVyczogaGFuZGxlcnMuc2xpY2UoIGRlbGVnYXRlQ291bnQgKSB9KTsKCQl9CgoJCXJldHVybiBoYW5kbGVyUXVldWU7Cgl9LAoKCWZpeDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggZXZlbnRbIGpRdWVyeS5leHBhbmRvIF0gKSB7CgkJCXJldHVybiBldmVudDsKCQl9CgoJCS8vIENyZWF0ZSBhIHdyaXRhYmxlIGNvcHkgb2YgdGhlIGV2ZW50IG9iamVjdCBhbmQgbm9ybWFsaXplIHNvbWUgcHJvcGVydGllcwoJCXZhciBpLCBwcm9wLCBjb3B5LAoJCQl0eXBlID0gZXZlbnQudHlwZSwKCQkJb3JpZ2luYWxFdmVudCA9IGV2ZW50LAoJCQlmaXhIb29rID0gdGhpcy5maXhIb29rc1sgdHlwZSBdOwoKCQlpZiAoICFmaXhIb29rICkgewoJCQl0aGlzLmZpeEhvb2tzWyB0eXBlIF0gPSBmaXhIb29rID0KCQkJCXJtb3VzZUV2ZW50LnRlc3QoIHR5cGUgKSA/IHRoaXMubW91c2VIb29rcyA6CgkJCQlya2V5RXZlbnQudGVzdCggdHlwZSApID8gdGhpcy5rZXlIb29rcyA6CgkJCQl7fTsKCQl9CgkJY29weSA9IGZpeEhvb2sucHJvcHMgPyB0aGlzLnByb3BzLmNvbmNhdCggZml4SG9vay5wcm9wcyApIDogdGhpcy5wcm9wczsKCgkJZXZlbnQgPSBuZXcgalF1ZXJ5LkV2ZW50KCBvcmlnaW5hbEV2ZW50ICk7CgoJCWkgPSBjb3B5Lmxlbmd0aDsKCQl3aGlsZSAoIGktLSApIHsKCQkJcHJvcCA9IGNvcHlbIGkgXTsKCQkJZXZlbnRbIHByb3AgXSA9IG9yaWdpbmFsRXZlbnRbIHByb3AgXTsKCQl9CgoJCS8vIFN1cHBvcnQ6IElFPDkKCQkvLyBGaXggdGFyZ2V0IHByb3BlcnR5ICgjMTkyNSkKCQlpZiAoICFldmVudC50YXJnZXQgKSB7CgkJCWV2ZW50LnRhcmdldCA9IG9yaWdpbmFsRXZlbnQuc3JjRWxlbWVudCB8fCBkb2N1bWVudDsKCQl9CgoJCS8vIFN1cHBvcnQ6IENocm9tZSAyMyssIFNhZmFyaT8KCQkvLyBUYXJnZXQgc2hvdWxkIG5vdCBiZSBhIHRleHQgbm9kZSAoIzUwNCwgIzEzMTQzKQoJCWlmICggZXZlbnQudGFyZ2V0Lm5vZGVUeXBlID09PSAzICkgewoJCQlldmVudC50YXJnZXQgPSBldmVudC50YXJnZXQucGFyZW50Tm9kZTsKCQl9CgoJCS8vIFN1cHBvcnQ6IElFPDkKCQkvLyBGb3IgbW91c2Uva2V5IGV2ZW50cywgbWV0YUtleT09ZmFsc2UgaWYgaXQncyB1bmRlZmluZWQgKCMzMzY4LCAjMTEzMjgpCgkJZXZlbnQubWV0YUtleSA9ICEhZXZlbnQubWV0YUtleTsKCgkJcmV0dXJuIGZpeEhvb2suZmlsdGVyID8gZml4SG9vay5maWx0ZXIoIGV2ZW50LCBvcmlnaW5hbEV2ZW50ICkgOiBldmVudDsKCX0sCgoJLy8gSW5jbHVkZXMgc29tZSBldmVudCBwcm9wcyBzaGFyZWQgYnkgS2V5RXZlbnQgYW5kIE1vdXNlRXZlbnQKCXByb3BzOiAiYWx0S2V5IGJ1YmJsZXMgY2FuY2VsYWJsZSBjdHJsS2V5IGN1cnJlbnRUYXJnZXQgZXZlbnRQaGFzZSBtZXRhS2V5IHJlbGF0ZWRUYXJnZXQgc2hpZnRLZXkgdGFyZ2V0IHRpbWVTdGFtcCB2aWV3IHdoaWNoIi5zcGxpdCgiICIpLAoKCWZpeEhvb2tzOiB7fSwKCglrZXlIb29rczogewoJCXByb3BzOiAiY2hhciBjaGFyQ29kZSBrZXkga2V5Q29kZSIuc3BsaXQoIiAiKSwKCQlmaWx0ZXI6IGZ1bmN0aW9uKCBldmVudCwgb3JpZ2luYWwgKSB7CgoJCQkvLyBBZGQgd2hpY2ggZm9yIGtleSBldmVudHMKCQkJaWYgKCBldmVudC53aGljaCA9PSBudWxsICkgewoJCQkJZXZlbnQud2hpY2ggPSBvcmlnaW5hbC5jaGFyQ29kZSAhPSBudWxsID8gb3JpZ2luYWwuY2hhckNvZGUgOiBvcmlnaW5hbC5rZXlDb2RlOwoJCQl9CgoJCQlyZXR1cm4gZXZlbnQ7CgkJfQoJfSwKCgltb3VzZUhvb2tzOiB7CgkJcHJvcHM6ICJidXR0b24gYnV0dG9ucyBjbGllbnRYIGNsaWVudFkgZnJvbUVsZW1lbnQgb2Zmc2V0WCBvZmZzZXRZIHBhZ2VYIHBhZ2VZIHNjcmVlblggc2NyZWVuWSB0b0VsZW1lbnQiLnNwbGl0KCIgIiksCgkJZmlsdGVyOiBmdW5jdGlvbiggZXZlbnQsIG9yaWdpbmFsICkgewoJCQl2YXIgYm9keSwgZXZlbnREb2MsIGRvYywKCQkJCWJ1dHRvbiA9IG9yaWdpbmFsLmJ1dHRvbiwKCQkJCWZyb21FbGVtZW50ID0gb3JpZ2luYWwuZnJvbUVsZW1lbnQ7CgoJCQkvLyBDYWxjdWxhdGUgcGFnZVgvWSBpZiBtaXNzaW5nIGFuZCBjbGllbnRYL1kgYXZhaWxhYmxlCgkJCWlmICggZXZlbnQucGFnZVggPT0gbnVsbCAmJiBvcmlnaW5hbC5jbGllbnRYICE9IG51bGwgKSB7CgkJCQlldmVudERvYyA9IGV2ZW50LnRhcmdldC5vd25lckRvY3VtZW50IHx8IGRvY3VtZW50OwoJCQkJZG9jID0gZXZlbnREb2MuZG9jdW1lbnRFbGVtZW50OwoJCQkJYm9keSA9IGV2ZW50RG9jLmJvZHk7CgoJCQkJZXZlbnQucGFnZVggPSBvcmlnaW5hbC5jbGllbnRYICsgKCBkb2MgJiYgZG9jLnNjcm9sbExlZnQgfHwgYm9keSAmJiBib2R5LnNjcm9sbExlZnQgfHwgMCApIC0gKCBkb2MgJiYgZG9jLmNsaWVudExlZnQgfHwgYm9keSAmJiBib2R5LmNsaWVudExlZnQgfHwgMCApOwoJCQkJZXZlbnQucGFnZVkgPSBvcmlnaW5hbC5jbGllbnRZICsgKCBkb2MgJiYgZG9jLnNjcm9sbFRvcCAgfHwgYm9keSAmJiBib2R5LnNjcm9sbFRvcCAgfHwgMCApIC0gKCBkb2MgJiYgZG9jLmNsaWVudFRvcCAgfHwgYm9keSAmJiBib2R5LmNsaWVudFRvcCAgfHwgMCApOwoJCQl9CgoJCQkvLyBBZGQgcmVsYXRlZFRhcmdldCwgaWYgbmVjZXNzYXJ5CgkJCWlmICggIWV2ZW50LnJlbGF0ZWRUYXJnZXQgJiYgZnJvbUVsZW1lbnQgKSB7CgkJCQlldmVudC5yZWxhdGVkVGFyZ2V0ID0gZnJvbUVsZW1lbnQgPT09IGV2ZW50LnRhcmdldCA/IG9yaWdpbmFsLnRvRWxlbWVudCA6IGZyb21FbGVtZW50OwoJCQl9CgoJCQkvLyBBZGQgd2hpY2ggZm9yIGNsaWNrOiAxID09PSBsZWZ0OyAyID09PSBtaWRkbGU7IDMgPT09IHJpZ2h0CgkJCS8vIE5vdGU6IGJ1dHRvbiBpcyBub3Qgbm9ybWFsaXplZCwgc28gZG9uJ3QgdXNlIGl0CgkJCWlmICggIWV2ZW50LndoaWNoICYmIGJ1dHRvbiAhPT0gdW5kZWZpbmVkICkgewoJCQkJZXZlbnQud2hpY2ggPSAoIGJ1dHRvbiAmIDEgPyAxIDogKCBidXR0b24gJiAyID8gMyA6ICggYnV0dG9uICYgNCA/IDIgOiAwICkgKSApOwoJCQl9CgoJCQlyZXR1cm4gZXZlbnQ7CgkJfQoJfSwKCglzcGVjaWFsOiB7CgkJbG9hZDogewoJCQkvLyBQcmV2ZW50IHRyaWdnZXJlZCBpbWFnZS5sb2FkIGV2ZW50cyBmcm9tIGJ1YmJsaW5nIHRvIHdpbmRvdy5sb2FkCgkJCW5vQnViYmxlOiB0cnVlCgkJfSwKCQlmb2N1czogewoJCQkvLyBGaXJlIG5hdGl2ZSBldmVudCBpZiBwb3NzaWJsZSBzbyBibHVyL2ZvY3VzIHNlcXVlbmNlIGlzIGNvcnJlY3QKCQkJdHJpZ2dlcjogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHRoaXMgIT09IHNhZmVBY3RpdmVFbGVtZW50KCkgJiYgdGhpcy5mb2N1cyApIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLmZvY3VzKCk7CgkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQl9IGNhdGNoICggZSApIHsKCQkJCQkJLy8gU3VwcG9ydDogSUU8OQoJCQkJCQkvLyBJZiB3ZSBlcnJvciBvbiBmb2N1cyB0byBoaWRkZW4gZWxlbWVudCAoIzE0ODYsICMxMjUxOCksCgkJCQkJCS8vIGxldCAudHJpZ2dlcigpIHJ1biB0aGUgaGFuZGxlcnMKCQkJCQl9CgkJCQl9CgkJCX0sCgkJCWRlbGVnYXRlVHlwZTogImZvY3VzaW4iCgkJfSwKCQlibHVyOiB7CgkJCXRyaWdnZXI6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzID09PSBzYWZlQWN0aXZlRWxlbWVudCgpICYmIHRoaXMuYmx1ciApIHsKCQkJCQl0aGlzLmJsdXIoKTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0sCgkJCWRlbGVnYXRlVHlwZTogImZvY3Vzb3V0IgoJCX0sCgkJY2xpY2s6IHsKCQkJLy8gRm9yIGNoZWNrYm94LCBmaXJlIG5hdGl2ZSBldmVudCBzbyBjaGVja2VkIHN0YXRlIHdpbGwgYmUgcmlnaHQKCQkJdHJpZ2dlcjogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIGpRdWVyeS5ub2RlTmFtZSggdGhpcywgImlucHV0IiApICYmIHRoaXMudHlwZSA9PT0gImNoZWNrYm94IiAmJiB0aGlzLmNsaWNrICkgewoJCQkJCXRoaXMuY2xpY2soKTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0sCgoJCQkvLyBGb3IgY3Jvc3MtYnJvd3NlciBjb25zaXN0ZW5jeSwgZG9uJ3QgZmlyZSBuYXRpdmUgLmNsaWNrKCkgb24gbGlua3MKCQkJX2RlZmF1bHQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCXJldHVybiBqUXVlcnkubm9kZU5hbWUoIGV2ZW50LnRhcmdldCwgImEiICk7CgkJCX0KCQl9LAoKCQliZWZvcmV1bmxvYWQ6IHsKCQkJcG9zdERpc3BhdGNoOiBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJLy8gRXZlbiB3aGVuIHJldHVyblZhbHVlIGVxdWFscyB0byB1bmRlZmluZWQgRmlyZWZveCB3aWxsIHN0aWxsIHNob3cgYWxlcnQKCQkJCWlmICggZXZlbnQucmVzdWx0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJZXZlbnQub3JpZ2luYWxFdmVudC5yZXR1cm5WYWx1ZSA9IGV2ZW50LnJlc3VsdDsKCQkJCX0KCQkJfQoJCX0KCX0sCgoJc2ltdWxhdGU6IGZ1bmN0aW9uKCB0eXBlLCBlbGVtLCBldmVudCwgYnViYmxlICkgewoJCS8vIFBpZ2d5YmFjayBvbiBhIGRvbm9yIGV2ZW50IHRvIHNpbXVsYXRlIGEgZGlmZmVyZW50IG9uZS4KCQkvLyBGYWtlIG9yaWdpbmFsRXZlbnQgdG8gYXZvaWQgZG9ub3IncyBzdG9wUHJvcGFnYXRpb24sIGJ1dCBpZiB0aGUKCQkvLyBzaW11bGF0ZWQgZXZlbnQgcHJldmVudHMgZGVmYXVsdCB0aGVuIHdlIGRvIHRoZSBzYW1lIG9uIHRoZSBkb25vci4KCQl2YXIgZSA9IGpRdWVyeS5leHRlbmQoCgkJCW5ldyBqUXVlcnkuRXZlbnQoKSwKCQkJZXZlbnQsCgkJCXsKCQkJCXR5cGU6IHR5cGUsCgkJCQlpc1NpbXVsYXRlZDogdHJ1ZSwKCQkJCW9yaWdpbmFsRXZlbnQ6IHt9CgkJCX0KCQkpOwoJCWlmICggYnViYmxlICkgewoJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggZSwgbnVsbCwgZWxlbSApOwoJCX0gZWxzZSB7CgkJCWpRdWVyeS5ldmVudC5kaXNwYXRjaC5jYWxsKCBlbGVtLCBlICk7CgkJfQoJCWlmICggZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9Cgl9Cn07CgpqUXVlcnkucmVtb3ZlRXZlbnQgPSBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyID8KCWZ1bmN0aW9uKCBlbGVtLCB0eXBlLCBoYW5kbGUgKSB7CgkJaWYgKCBlbGVtLnJlbW92ZUV2ZW50TGlzdGVuZXIgKSB7CgkJCWVsZW0ucmVtb3ZlRXZlbnRMaXN0ZW5lciggdHlwZSwgaGFuZGxlLCBmYWxzZSApOwoJCX0KCX0gOgoJZnVuY3Rpb24oIGVsZW0sIHR5cGUsIGhhbmRsZSApIHsKCQl2YXIgbmFtZSA9ICJvbiIgKyB0eXBlOwoKCQlpZiAoIGVsZW0uZGV0YWNoRXZlbnQgKSB7CgoJCQkvLyAjODU0NSwgIzcwNTQsIHByZXZlbnRpbmcgbWVtb3J5IGxlYWtzIGZvciBjdXN0b20gZXZlbnRzIGluIElFNi04CgkJCS8vIGRldGFjaEV2ZW50IG5lZWRlZCBwcm9wZXJ0eSBvbiBlbGVtZW50LCBieSBuYW1lIG9mIHRoYXQgZXZlbnQsIHRvIHByb3Blcmx5IGV4cG9zZSBpdCB0byBHQwoJCQlpZiAoIHR5cGVvZiBlbGVtWyBuYW1lIF0gPT09IHN0cnVuZGVmaW5lZCApIHsKCQkJCWVsZW1bIG5hbWUgXSA9IG51bGw7CgkJCX0KCgkJCWVsZW0uZGV0YWNoRXZlbnQoIG5hbWUsIGhhbmRsZSApOwoJCX0KCX07CgpqUXVlcnkuRXZlbnQgPSBmdW5jdGlvbiggc3JjLCBwcm9wcyApIHsKCS8vIEFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCB0aGUgJ25ldycga2V5d29yZAoJaWYgKCAhKHRoaXMgaW5zdGFuY2VvZiBqUXVlcnkuRXZlbnQpICkgewoJCXJldHVybiBuZXcgalF1ZXJ5LkV2ZW50KCBzcmMsIHByb3BzICk7Cgl9CgoJLy8gRXZlbnQgb2JqZWN0CglpZiAoIHNyYyAmJiBzcmMudHlwZSApIHsKCQl0aGlzLm9yaWdpbmFsRXZlbnQgPSBzcmM7CgkJdGhpcy50eXBlID0gc3JjLnR5cGU7CgoJCS8vIEV2ZW50cyBidWJibGluZyB1cCB0aGUgZG9jdW1lbnQgbWF5IGhhdmUgYmVlbiBtYXJrZWQgYXMgcHJldmVudGVkCgkJLy8gYnkgYSBoYW5kbGVyIGxvd2VyIGRvd24gdGhlIHRyZWU7IHJlZmxlY3QgdGhlIGNvcnJlY3QgdmFsdWUuCgkJdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBzcmMuZGVmYXVsdFByZXZlbnRlZCB8fAoJCQkJc3JjLmRlZmF1bHRQcmV2ZW50ZWQgPT09IHVuZGVmaW5lZCAmJiAoCgkJCQkvLyBTdXBwb3J0OiBJRSA8IDkKCQkJCXNyYy5yZXR1cm5WYWx1ZSA9PT0gZmFsc2UgfHwKCQkJCS8vIFN1cHBvcnQ6IEFuZHJvaWQgPCA0LjAKCQkJCXNyYy5nZXRQcmV2ZW50RGVmYXVsdCAmJiBzcmMuZ2V0UHJldmVudERlZmF1bHQoKSApID8KCQkJcmV0dXJuVHJ1ZSA6CgkJCXJldHVybkZhbHNlOwoKCS8vIEV2ZW50IHR5cGUKCX0gZWxzZSB7CgkJdGhpcy50eXBlID0gc3JjOwoJfQoKCS8vIFB1dCBleHBsaWNpdGx5IHByb3ZpZGVkIHByb3BlcnRpZXMgb250byB0aGUgZXZlbnQgb2JqZWN0CglpZiAoIHByb3BzICkgewoJCWpRdWVyeS5leHRlbmQoIHRoaXMsIHByb3BzICk7Cgl9CgoJLy8gQ3JlYXRlIGEgdGltZXN0YW1wIGlmIGluY29taW5nIGV2ZW50IGRvZXNuJ3QgaGF2ZSBvbmUKCXRoaXMudGltZVN0YW1wID0gc3JjICYmIHNyYy50aW1lU3RhbXAgfHwgalF1ZXJ5Lm5vdygpOwoKCS8vIE1hcmsgaXQgYXMgZml4ZWQKCXRoaXNbIGpRdWVyeS5leHBhbmRvIF0gPSB0cnVlOwp9OwoKLy8galF1ZXJ5LkV2ZW50IGlzIGJhc2VkIG9uIERPTTMgRXZlbnRzIGFzIHNwZWNpZmllZCBieSB0aGUgRUNNQVNjcmlwdCBMYW5ndWFnZSBCaW5kaW5nCi8vIGh0dHA6Ly93d3cudzMub3JnL1RSLzIwMDMvV0QtRE9NLUxldmVsLTMtRXZlbnRzLTIwMDMwMzMxL2VjbWEtc2NyaXB0LWJpbmRpbmcuaHRtbApqUXVlcnkuRXZlbnQucHJvdG90eXBlID0gewoJaXNEZWZhdWx0UHJldmVudGVkOiByZXR1cm5GYWxzZSwKCWlzUHJvcGFnYXRpb25TdG9wcGVkOiByZXR1cm5GYWxzZSwKCWlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkOiByZXR1cm5GYWxzZSwKCglwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7CgkJdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CgoJCXRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gcmV0dXJuVHJ1ZTsKCQlpZiAoICFlICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBJZiBwcmV2ZW50RGVmYXVsdCBleGlzdHMsIHJ1biBpdCBvbiB0aGUgb3JpZ2luYWwgZXZlbnQKCQlpZiAoIGUucHJldmVudERlZmF1bHQgKSB7CgkJCWUucHJldmVudERlZmF1bHQoKTsKCgkJLy8gU3VwcG9ydDogSUUKCQkvLyBPdGhlcndpc2Ugc2V0IHRoZSByZXR1cm5WYWx1ZSBwcm9wZXJ0eSBvZiB0aGUgb3JpZ2luYWwgZXZlbnQgdG8gZmFsc2UKCQl9IGVsc2UgewoJCQllLnJldHVyblZhbHVlID0gZmFsc2U7CgkJfQoJfSwKCXN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CgkJdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CgoJCXRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwoJCWlmICggIWUgKSB7CgkJCXJldHVybjsKCQl9CgkJLy8gSWYgc3RvcFByb3BhZ2F0aW9uIGV4aXN0cywgcnVuIGl0IG9uIHRoZSBvcmlnaW5hbCBldmVudAoJCWlmICggZS5zdG9wUHJvcGFnYXRpb24gKSB7CgkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJfQoKCQkvLyBTdXBwb3J0OiBJRQoJCS8vIFNldCB0aGUgY2FuY2VsQnViYmxlIHByb3BlcnR5IG9mIHRoZSBvcmlnaW5hbCBldmVudCB0byB0cnVlCgkJZS5jYW5jZWxCdWJibGUgPSB0cnVlOwoJfSwKCXN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCA9IHJldHVyblRydWU7CgkJdGhpcy5zdG9wUHJvcGFnYXRpb24oKTsKCX0KfTsKCi8vIENyZWF0ZSBtb3VzZWVudGVyL2xlYXZlIGV2ZW50cyB1c2luZyBtb3VzZW92ZXIvb3V0IGFuZCBldmVudC10aW1lIGNoZWNrcwpqUXVlcnkuZWFjaCh7Cgltb3VzZWVudGVyOiAibW91c2VvdmVyIiwKCW1vdXNlbGVhdmU6ICJtb3VzZW91dCIKfSwgZnVuY3Rpb24oIG9yaWcsIGZpeCApIHsKCWpRdWVyeS5ldmVudC5zcGVjaWFsWyBvcmlnIF0gPSB7CgkJZGVsZWdhdGVUeXBlOiBmaXgsCgkJYmluZFR5cGU6IGZpeCwKCgkJaGFuZGxlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciByZXQsCgkJCQl0YXJnZXQgPSB0aGlzLAoJCQkJcmVsYXRlZCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQsCgkJCQloYW5kbGVPYmogPSBldmVudC5oYW5kbGVPYmo7CgoJCQkvLyBGb3IgbW91c2VudGVyL2xlYXZlIGNhbGwgdGhlIGhhbmRsZXIgaWYgcmVsYXRlZCBpcyBvdXRzaWRlIHRoZSB0YXJnZXQuCgkJCS8vIE5COiBObyByZWxhdGVkVGFyZ2V0IGlmIHRoZSBtb3VzZSBsZWZ0L2VudGVyZWQgdGhlIGJyb3dzZXIgd2luZG93CgkJCWlmICggIXJlbGF0ZWQgfHwgKHJlbGF0ZWQgIT09IHRhcmdldCAmJiAhalF1ZXJ5LmNvbnRhaW5zKCB0YXJnZXQsIHJlbGF0ZWQgKSkgKSB7CgkJCQlldmVudC50eXBlID0gaGFuZGxlT2JqLm9yaWdUeXBlOwoJCQkJcmV0ID0gaGFuZGxlT2JqLmhhbmRsZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJZXZlbnQudHlwZSA9IGZpeDsKCQkJfQoJCQlyZXR1cm4gcmV0OwoJCX0KCX07Cn0pOwoKLy8gSUUgc3VibWl0IGRlbGVnYXRpb24KaWYgKCAhc3VwcG9ydC5zdWJtaXRCdWJibGVzICkgewoKCWpRdWVyeS5ldmVudC5zcGVjaWFsLnN1Ym1pdCA9IHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCS8vIE9ubHkgbmVlZCB0aGlzIGZvciBkZWxlZ2F0ZWQgZm9ybSBzdWJtaXQgZXZlbnRzCgkJCWlmICggalF1ZXJ5Lm5vZGVOYW1lKCB0aGlzLCAiZm9ybSIgKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gTGF6eS1hZGQgYSBzdWJtaXQgaGFuZGxlciB3aGVuIGEgZGVzY2VuZGFudCBmb3JtIG1heSBwb3RlbnRpYWxseSBiZSBzdWJtaXR0ZWQKCQkJalF1ZXJ5LmV2ZW50LmFkZCggdGhpcywgImNsaWNrLl9zdWJtaXQga2V5cHJlc3MuX3N1Ym1pdCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJLy8gTm9kZSBuYW1lIGNoZWNrIGF2b2lkcyBhIFZNTC1yZWxhdGVkIGNyYXNoIGluIElFICgjOTgwNykKCQkJCXZhciBlbGVtID0gZS50YXJnZXQsCgkJCQkJZm9ybSA9IGpRdWVyeS5ub2RlTmFtZSggZWxlbSwgImlucHV0IiApIHx8IGpRdWVyeS5ub2RlTmFtZSggZWxlbSwgImJ1dHRvbiIgKSA/IGVsZW0uZm9ybSA6IHVuZGVmaW5lZDsKCQkJCWlmICggZm9ybSAmJiAhalF1ZXJ5Ll9kYXRhKCBmb3JtLCAic3VibWl0QnViYmxlcyIgKSApIHsKCQkJCQlqUXVlcnkuZXZlbnQuYWRkKCBmb3JtLCAic3VibWl0Ll9zdWJtaXQiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJCWV2ZW50Ll9zdWJtaXRfYnViYmxlID0gdHJ1ZTsKCQkJCQl9KTsKCQkJCQlqUXVlcnkuX2RhdGEoIGZvcm0sICJzdWJtaXRCdWJibGVzIiwgdHJ1ZSApOwoJCQkJfQoJCQl9KTsKCQkJLy8gcmV0dXJuIHVuZGVmaW5lZCBzaW5jZSB3ZSBkb24ndCBuZWVkIGFuIGV2ZW50IGxpc3RlbmVyCgkJfSwKCgkJcG9zdERpc3BhdGNoOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vIElmIGZvcm0gd2FzIHN1Ym1pdHRlZCBieSB0aGUgdXNlciwgYnViYmxlIHRoZSBldmVudCB1cCB0aGUgdHJlZQoJCQlpZiAoIGV2ZW50Ll9zdWJtaXRfYnViYmxlICkgewoJCQkJZGVsZXRlIGV2ZW50Ll9zdWJtaXRfYnViYmxlOwoJCQkJaWYgKCB0aGlzLnBhcmVudE5vZGUgJiYgIWV2ZW50LmlzVHJpZ2dlciApIHsKCQkJCQlqUXVlcnkuZXZlbnQuc2ltdWxhdGUoICJzdWJtaXQiLCB0aGlzLnBhcmVudE5vZGUsIGV2ZW50LCB0cnVlICk7CgkJCQl9CgkJCX0KCQl9LAoKCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCS8vIE9ubHkgbmVlZCB0aGlzIGZvciBkZWxlZ2F0ZWQgZm9ybSBzdWJtaXQgZXZlbnRzCgkJCWlmICggalF1ZXJ5Lm5vZGVOYW1lKCB0aGlzLCAiZm9ybSIgKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gUmVtb3ZlIGRlbGVnYXRlZCBoYW5kbGVyczsgY2xlYW5EYXRhIGV2ZW50dWFsbHkgcmVhcHMgc3VibWl0IGhhbmRsZXJzIGF0dGFjaGVkIGFib3ZlCgkJCWpRdWVyeS5ldmVudC5yZW1vdmUoIHRoaXMsICIuX3N1Ym1pdCIgKTsKCQl9Cgl9Owp9CgovLyBJRSBjaGFuZ2UgZGVsZWdhdGlvbiBhbmQgY2hlY2tib3gvcmFkaW8gZml4CmlmICggIXN1cHBvcnQuY2hhbmdlQnViYmxlcyApIHsKCglqUXVlcnkuZXZlbnQuc3BlY2lhbC5jaGFuZ2UgPSB7CgoJCXNldHVwOiBmdW5jdGlvbigpIHsKCgkJCWlmICggcmZvcm1FbGVtcy50ZXN0KCB0aGlzLm5vZGVOYW1lICkgKSB7CgkJCQkvLyBJRSBkb2Vzbid0IGZpcmUgY2hhbmdlIG9uIGEgY2hlY2svcmFkaW8gdW50aWwgYmx1cjsgdHJpZ2dlciBpdCBvbiBjbGljawoJCQkJLy8gYWZ0ZXIgYSBwcm9wZXJ0eWNoYW5nZS4gRWF0IHRoZSBibHVyLWNoYW5nZSBpbiBzcGVjaWFsLmNoYW5nZS5oYW5kbGUuCgkJCQkvLyBUaGlzIHN0aWxsIGZpcmVzIG9uY2hhbmdlIGEgc2Vjb25kIHRpbWUgZm9yIGNoZWNrL3JhZGlvIGFmdGVyIGJsdXIuCgkJCQlpZiAoIHRoaXMudHlwZSA9PT0gImNoZWNrYm94IiB8fCB0aGlzLnR5cGUgPT09ICJyYWRpbyIgKSB7CgkJCQkJalF1ZXJ5LmV2ZW50LmFkZCggdGhpcywgInByb3BlcnR5Y2hhbmdlLl9jaGFuZ2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJCWlmICggZXZlbnQub3JpZ2luYWxFdmVudC5wcm9wZXJ0eU5hbWUgPT09ICJjaGVja2VkIiApIHsKCQkJCQkJCXRoaXMuX2p1c3RfY2hhbmdlZCA9IHRydWU7CgkJCQkJCX0KCQkJCQl9KTsKCQkJCQlqUXVlcnkuZXZlbnQuYWRkKCB0aGlzLCAiY2xpY2suX2NoYW5nZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQkJaWYgKCB0aGlzLl9qdXN0X2NoYW5nZWQgJiYgIWV2ZW50LmlzVHJpZ2dlciApIHsKCQkJCQkJCXRoaXMuX2p1c3RfY2hhbmdlZCA9IGZhbHNlOwoJCQkJCQl9CgkJCQkJCS8vIEFsbG93IHRyaWdnZXJlZCwgc2ltdWxhdGVkIGNoYW5nZSBldmVudHMgKCMxMTUwMCkKCQkJCQkJalF1ZXJ5LmV2ZW50LnNpbXVsYXRlKCAiY2hhbmdlIiwgdGhpcywgZXZlbnQsIHRydWUgKTsKCQkJCQl9KTsKCQkJCX0KCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCQkvLyBEZWxlZ2F0ZWQgZXZlbnQ7IGxhenktYWRkIGEgY2hhbmdlIGhhbmRsZXIgb24gZGVzY2VuZGFudCBpbnB1dHMKCQkJalF1ZXJ5LmV2ZW50LmFkZCggdGhpcywgImJlZm9yZWFjdGl2YXRlLl9jaGFuZ2UiLCBmdW5jdGlvbiggZSApIHsKCQkJCXZhciBlbGVtID0gZS50YXJnZXQ7CgoJCQkJaWYgKCByZm9ybUVsZW1zLnRlc3QoIGVsZW0ubm9kZU5hbWUgKSAmJiAhalF1ZXJ5Ll9kYXRhKCBlbGVtLCAiY2hhbmdlQnViYmxlcyIgKSApIHsKCQkJCQlqUXVlcnkuZXZlbnQuYWRkKCBlbGVtLCAiY2hhbmdlLl9jaGFuZ2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJCWlmICggdGhpcy5wYXJlbnROb2RlICYmICFldmVudC5pc1NpbXVsYXRlZCAmJiAhZXZlbnQuaXNUcmlnZ2VyICkgewoJCQkJCQkJalF1ZXJ5LmV2ZW50LnNpbXVsYXRlKCAiY2hhbmdlIiwgdGhpcy5wYXJlbnROb2RlLCBldmVudCwgdHJ1ZSApOwoJCQkJCQl9CgkJCQkJfSk7CgkJCQkJalF1ZXJ5Ll9kYXRhKCBlbGVtLCAiY2hhbmdlQnViYmxlcyIsIHRydWUgKTsKCQkJCX0KCQkJfSk7CgkJfSwKCgkJaGFuZGxlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBlbGVtID0gZXZlbnQudGFyZ2V0OwoKCQkJLy8gU3dhbGxvdyBuYXRpdmUgY2hhbmdlIGV2ZW50cyBmcm9tIGNoZWNrYm94L3JhZGlvLCB3ZSBhbHJlYWR5IHRyaWdnZXJlZCB0aGVtIGFib3ZlCgkJCWlmICggdGhpcyAhPT0gZWxlbSB8fCBldmVudC5pc1NpbXVsYXRlZCB8fCBldmVudC5pc1RyaWdnZXIgfHwgKGVsZW0udHlwZSAhPT0gInJhZGlvIiAmJiBlbGVtLnR5cGUgIT09ICJjaGVja2JveCIpICkgewoJCQkJcmV0dXJuIGV2ZW50LmhhbmRsZU9iai5oYW5kbGVyLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJfQoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LmV2ZW50LnJlbW92ZSggdGhpcywgIi5fY2hhbmdlIiApOwoKCQkJcmV0dXJuICFyZm9ybUVsZW1zLnRlc3QoIHRoaXMubm9kZU5hbWUgKTsKCQl9Cgl9Owp9CgovLyBDcmVhdGUgImJ1YmJsaW5nIiBmb2N1cyBhbmQgYmx1ciBldmVudHMKaWYgKCAhc3VwcG9ydC5mb2N1c2luQnViYmxlcyApIHsKCWpRdWVyeS5lYWNoKHsgZm9jdXM6ICJmb2N1c2luIiwgYmx1cjogImZvY3Vzb3V0IiB9LCBmdW5jdGlvbiggb3JpZywgZml4ICkgewoKCQkvLyBBdHRhY2ggYSBzaW5nbGUgY2FwdHVyaW5nIGhhbmRsZXIgb24gdGhlIGRvY3VtZW50IHdoaWxlIHNvbWVvbmUgd2FudHMgZm9jdXNpbi9mb2N1c291dAoJCXZhciBoYW5kbGVyID0gZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJalF1ZXJ5LmV2ZW50LnNpbXVsYXRlKCBmaXgsIGV2ZW50LnRhcmdldCwgalF1ZXJ5LmV2ZW50LmZpeCggZXZlbnQgKSwgdHJ1ZSApOwoJCQl9OwoKCQlqUXVlcnkuZXZlbnQuc3BlY2lhbFsgZml4IF0gPSB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCXZhciBkb2MgPSB0aGlzLm93bmVyRG9jdW1lbnQgfHwgdGhpcywKCQkJCQlhdHRhY2hlcyA9IGpRdWVyeS5fZGF0YSggZG9jLCBmaXggKTsKCgkJCQlpZiAoICFhdHRhY2hlcyApIHsKCQkJCQlkb2MuYWRkRXZlbnRMaXN0ZW5lciggb3JpZywgaGFuZGxlciwgdHJ1ZSApOwoJCQkJfQoJCQkJalF1ZXJ5Ll9kYXRhKCBkb2MsIGZpeCwgKCBhdHRhY2hlcyB8fCAwICkgKyAxICk7CgkJCX0sCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJCXZhciBkb2MgPSB0aGlzLm93bmVyRG9jdW1lbnQgfHwgdGhpcywKCQkJCQlhdHRhY2hlcyA9IGpRdWVyeS5fZGF0YSggZG9jLCBmaXggKSAtIDE7CgoJCQkJaWYgKCAhYXR0YWNoZXMgKSB7CgkJCQkJZG9jLnJlbW92ZUV2ZW50TGlzdGVuZXIoIG9yaWcsIGhhbmRsZXIsIHRydWUgKTsKCQkJCQlqUXVlcnkuX3JlbW92ZURhdGEoIGRvYywgZml4ICk7CgkJCQl9IGVsc2UgewoJCQkJCWpRdWVyeS5fZGF0YSggZG9jLCBmaXgsIGF0dGFjaGVzICk7CgkJCQl9CgkJCX0KCQl9OwoJfSk7Cn0KCmpRdWVyeS5mbi5leHRlbmQoewoKCW9uOiBmdW5jdGlvbiggdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiwgLypJTlRFUk5BTCovIG9uZSApIHsKCQl2YXIgdHlwZSwgb3JpZ0ZuOwoKCQkvLyBUeXBlcyBjYW4gYmUgYSBtYXAgb2YgdHlwZXMvaGFuZGxlcnMKCQlpZiAoIHR5cGVvZiB0eXBlcyA9PT0gIm9iamVjdCIgKSB7CgkJCS8vICggdHlwZXMtT2JqZWN0LCBzZWxlY3RvciwgZGF0YSApCgkJCWlmICggdHlwZW9mIHNlbGVjdG9yICE9PSAic3RyaW5nIiApIHsKCQkJCS8vICggdHlwZXMtT2JqZWN0LCBkYXRhICkKCQkJCWRhdGEgPSBkYXRhIHx8IHNlbGVjdG9yOwoJCQkJc2VsZWN0b3IgPSB1bmRlZmluZWQ7CgkJCX0KCQkJZm9yICggdHlwZSBpbiB0eXBlcyApIHsKCQkJCXRoaXMub24oIHR5cGUsIHNlbGVjdG9yLCBkYXRhLCB0eXBlc1sgdHlwZSBdLCBvbmUgKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmICggZGF0YSA9PSBudWxsICYmIGZuID09IG51bGwgKSB7CgkJCS8vICggdHlwZXMsIGZuICkKCQkJZm4gPSBzZWxlY3RvcjsKCQkJZGF0YSA9IHNlbGVjdG9yID0gdW5kZWZpbmVkOwoJCX0gZWxzZSBpZiAoIGZuID09IG51bGwgKSB7CgkJCWlmICggdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiApIHsKCQkJCS8vICggdHlwZXMsIHNlbGVjdG9yLCBmbiApCgkJCQlmbiA9IGRhdGE7CgkJCQlkYXRhID0gdW5kZWZpbmVkOwoJCQl9IGVsc2UgewoJCQkJLy8gKCB0eXBlcywgZGF0YSwgZm4gKQoJCQkJZm4gPSBkYXRhOwoJCQkJZGF0YSA9IHNlbGVjdG9yOwoJCQkJc2VsZWN0b3IgPSB1bmRlZmluZWQ7CgkJCX0KCQl9CgkJaWYgKCBmbiA9PT0gZmFsc2UgKSB7CgkJCWZuID0gcmV0dXJuRmFsc2U7CgkJfSBlbHNlIGlmICggIWZuICkgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmICggb25lID09PSAxICkgewoJCQlvcmlnRm4gPSBmbjsKCQkJZm4gPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBDYW4gdXNlIGFuIGVtcHR5IHNldCwgc2luY2UgZXZlbnQgY29udGFpbnMgdGhlIGluZm8KCQkJCWpRdWVyeSgpLm9mZiggZXZlbnQgKTsKCQkJCXJldHVybiBvcmlnRm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQl9OwoJCQkvLyBVc2Ugc2FtZSBndWlkIHNvIGNhbGxlciBjYW4gcmVtb3ZlIHVzaW5nIG9yaWdGbgoJCQlmbi5ndWlkID0gb3JpZ0ZuLmd1aWQgfHwgKCBvcmlnRm4uZ3VpZCA9IGpRdWVyeS5ndWlkKysgKTsKCQl9CgkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCWpRdWVyeS5ldmVudC5hZGQoIHRoaXMsIHR5cGVzLCBmbiwgZGF0YSwgc2VsZWN0b3IgKTsKCQl9KTsKCX0sCglvbmU6IGZ1bmN0aW9uKCB0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuICkgewoJCXJldHVybiB0aGlzLm9uKCB0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuLCAxICk7Cgl9LAoJb2ZmOiBmdW5jdGlvbiggdHlwZXMsIHNlbGVjdG9yLCBmbiApIHsKCQl2YXIgaGFuZGxlT2JqLCB0eXBlOwoJCWlmICggdHlwZXMgJiYgdHlwZXMucHJldmVudERlZmF1bHQgJiYgdHlwZXMuaGFuZGxlT2JqICkgewoJCQkvLyAoIGV2ZW50ICkgIGRpc3BhdGNoZWQgalF1ZXJ5LkV2ZW50CgkJCWhhbmRsZU9iaiA9IHR5cGVzLmhhbmRsZU9iajsKCQkJalF1ZXJ5KCB0eXBlcy5kZWxlZ2F0ZVRhcmdldCApLm9mZigKCQkJCWhhbmRsZU9iai5uYW1lc3BhY2UgPyBoYW5kbGVPYmoub3JpZ1R5cGUgKyAiLiIgKyBoYW5kbGVPYmoubmFtZXNwYWNlIDogaGFuZGxlT2JqLm9yaWdUeXBlLAoJCQkJaGFuZGxlT2JqLnNlbGVjdG9yLAoJCQkJaGFuZGxlT2JqLmhhbmRsZXIKCQkJKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoJCWlmICggdHlwZW9mIHR5cGVzID09PSAib2JqZWN0IiApIHsKCQkJLy8gKCB0eXBlcy1vYmplY3QgWywgc2VsZWN0b3JdICkKCQkJZm9yICggdHlwZSBpbiB0eXBlcyApIHsKCQkJCXRoaXMub2ZmKCB0eXBlLCBzZWxlY3RvciwgdHlwZXNbIHR5cGUgXSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0KCQlpZiAoIHNlbGVjdG9yID09PSBmYWxzZSB8fCB0eXBlb2Ygc2VsZWN0b3IgPT09ICJmdW5jdGlvbiIgKSB7CgkJCS8vICggdHlwZXMgWywgZm5dICkKCQkJZm4gPSBzZWxlY3RvcjsKCQkJc2VsZWN0b3IgPSB1bmRlZmluZWQ7CgkJfQoJCWlmICggZm4gPT09IGZhbHNlICkgewoJCQlmbiA9IHJldHVybkZhbHNlOwoJCX0KCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCB0aGlzLCB0eXBlcywgZm4sIHNlbGVjdG9yICk7CgkJfSk7Cgl9LAoKCXRyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBkYXRhICkgewoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCB0eXBlLCBkYXRhLCB0aGlzICk7CgkJfSk7Cgl9LAoJdHJpZ2dlckhhbmRsZXI6IGZ1bmN0aW9uKCB0eXBlLCBkYXRhICkgewoJCXZhciBlbGVtID0gdGhpc1swXTsKCQlpZiAoIGVsZW0gKSB7CgkJCXJldHVybiBqUXVlcnkuZXZlbnQudHJpZ2dlciggdHlwZSwgZGF0YSwgZWxlbSwgdHJ1ZSApOwoJCX0KCX0KfSk7CgoKZnVuY3Rpb24gY3JlYXRlU2FmZUZyYWdtZW50KCBkb2N1bWVudCApIHsKCXZhciBsaXN0ID0gbm9kZU5hbWVzLnNwbGl0KCAifCIgKSwKCQlzYWZlRnJhZyA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKCglpZiAoIHNhZmVGcmFnLmNyZWF0ZUVsZW1lbnQgKSB7CgkJd2hpbGUgKCBsaXN0Lmxlbmd0aCApIHsKCQkJc2FmZUZyYWcuY3JlYXRlRWxlbWVudCgKCQkJCWxpc3QucG9wKCkKCQkJKTsKCQl9Cgl9CglyZXR1cm4gc2FmZUZyYWc7Cn0KCnZhciBub2RlTmFtZXMgPSAiYWJicnxhcnRpY2xlfGFzaWRlfGF1ZGlvfGJkaXxjYW52YXN8ZGF0YXxkYXRhbGlzdHxkZXRhaWxzfGZpZ2NhcHRpb258ZmlndXJlfGZvb3RlcnwiICsKCQkiaGVhZGVyfGhncm91cHxtYXJrfG1ldGVyfG5hdnxvdXRwdXR8cHJvZ3Jlc3N8c2VjdGlvbnxzdW1tYXJ5fHRpbWV8dmlkZW8iLAoJcmlubGluZWpRdWVyeSA9IC8galF1ZXJ5XGQrPSIoPzpudWxsfFxkKykiL2csCglybm9zaGltY2FjaGUgPSBuZXcgUmVnRXhwKCI8KD86IiArIG5vZGVOYW1lcyArICIpW1xccy8+XSIsICJpIiksCglybGVhZGluZ1doaXRlc3BhY2UgPSAvXlxzKy8sCglyeGh0bWxUYWcgPSAvPCg/IWFyZWF8YnJ8Y29sfGVtYmVkfGhyfGltZ3xpbnB1dHxsaW5rfG1ldGF8cGFyYW0pKChbXHc6XSspW14+XSopXC8+L2dpLAoJcnRhZ05hbWUgPSAvPChbXHc6XSspLywKCXJ0Ym9keSA9IC88dGJvZHkvaSwKCXJodG1sID0gLzx8JiM/XHcrOy8sCglybm9Jbm5lcmh0bWwgPSAvPCg/OnNjcmlwdHxzdHlsZXxsaW5rKS9pLAoJLy8gY2hlY2tlZD0iY2hlY2tlZCIgb3IgY2hlY2tlZAoJcmNoZWNrZWQgPSAvY2hlY2tlZFxzKig/OltePV18PVxzKi5jaGVja2VkLikvaSwKCXJzY3JpcHRUeXBlID0gL14kfFwvKD86amF2YXxlY21hKXNjcmlwdC9pLAoJcnNjcmlwdFR5cGVNYXNrZWQgPSAvXnRydWVcLyguKikvLAoJcmNsZWFuU2NyaXB0ID0gL15ccyo8ISg/OlxbQ0RBVEFcW3wtLSl8KD86XF1cXXwtLSk+XHMqJC9nLAoKCS8vIFdlIGhhdmUgdG8gY2xvc2UgdGhlc2UgdGFncyB0byBzdXBwb3J0IFhIVE1MICgjMTMyMDApCgl3cmFwTWFwID0gewoJCW9wdGlvbjogWyAxLCAiPHNlbGVjdCBtdWx0aXBsZT0nbXVsdGlwbGUnPiIsICI8L3NlbGVjdD4iIF0sCgkJbGVnZW5kOiBbIDEsICI8ZmllbGRzZXQ+IiwgIjwvZmllbGRzZXQ+IiBdLAoJCWFyZWE6IFsgMSwgIjxtYXA+IiwgIjwvbWFwPiIgXSwKCQlwYXJhbTogWyAxLCAiPG9iamVjdD4iLCAiPC9vYmplY3Q+IiBdLAoJCXRoZWFkOiBbIDEsICI8dGFibGU+IiwgIjwvdGFibGU+IiBdLAoJCXRyOiBbIDIsICI8dGFibGU+PHRib2R5PiIsICI8L3Rib2R5PjwvdGFibGU+IiBdLAoJCWNvbDogWyAyLCAiPHRhYmxlPjx0Ym9keT48L3Rib2R5Pjxjb2xncm91cD4iLCAiPC9jb2xncm91cD48L3RhYmxlPiIgXSwKCQl0ZDogWyAzLCAiPHRhYmxlPjx0Ym9keT48dHI+IiwgIjwvdHI+PC90Ym9keT48L3RhYmxlPiIgXSwKCgkJLy8gSUU2LTggY2FuJ3Qgc2VyaWFsaXplIGxpbmssIHNjcmlwdCwgc3R5bGUsIG9yIGFueSBodG1sNSAoTm9TY29wZSkgdGFncywKCQkvLyB1bmxlc3Mgd3JhcHBlZCBpbiBhIGRpdiB3aXRoIG5vbi1icmVha2luZyBjaGFyYWN0ZXJzIGluIGZyb250IG9mIGl0LgoJCV9kZWZhdWx0OiBzdXBwb3J0Lmh0bWxTZXJpYWxpemUgPyBbIDAsICIiLCAiIiBdIDogWyAxLCAiWDxkaXY+IiwgIjwvZGl2PiIgIF0KCX0sCglzYWZlRnJhZ21lbnQgPSBjcmVhdGVTYWZlRnJhZ21lbnQoIGRvY3VtZW50ICksCglmcmFnbWVudERpdiA9IHNhZmVGcmFnbWVudC5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikgKTsKCndyYXBNYXAub3B0Z3JvdXAgPSB3cmFwTWFwLm9wdGlvbjsKd3JhcE1hcC50Ym9keSA9IHdyYXBNYXAudGZvb3QgPSB3cmFwTWFwLmNvbGdyb3VwID0gd3JhcE1hcC5jYXB0aW9uID0gd3JhcE1hcC50aGVhZDsKd3JhcE1hcC50aCA9IHdyYXBNYXAudGQ7CgpmdW5jdGlvbiBnZXRBbGwoIGNvbnRleHQsIHRhZyApIHsKCXZhciBlbGVtcywgZWxlbSwKCQlpID0gMCwKCQlmb3VuZCA9IHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lICE9PSBzdHJ1bmRlZmluZWQgPyBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCB0YWcgfHwgIioiICkgOgoJCQl0eXBlb2YgY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsICE9PSBzdHJ1bmRlZmluZWQgPyBjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwoIHRhZyB8fCAiKiIgKSA6CgkJCXVuZGVmaW5lZDsKCglpZiAoICFmb3VuZCApIHsKCQlmb3IgKCBmb3VuZCA9IFtdLCBlbGVtcyA9IGNvbnRleHQuY2hpbGROb2RlcyB8fCBjb250ZXh0OyAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJCWlmICggIXRhZyB8fCBqUXVlcnkubm9kZU5hbWUoIGVsZW0sIHRhZyApICkgewoJCQkJZm91bmQucHVzaCggZWxlbSApOwoJCQl9IGVsc2UgewoJCQkJalF1ZXJ5Lm1lcmdlKCBmb3VuZCwgZ2V0QWxsKCBlbGVtLCB0YWcgKSApOwoJCQl9CgkJfQoJfQoKCXJldHVybiB0YWcgPT09IHVuZGVmaW5lZCB8fCB0YWcgJiYgalF1ZXJ5Lm5vZGVOYW1lKCBjb250ZXh0LCB0YWcgKSA/CgkJalF1ZXJ5Lm1lcmdlKCBbIGNvbnRleHQgXSwgZm91bmQgKSA6CgkJZm91bmQ7Cn0KCi8vIFVzZWQgaW4gYnVpbGRGcmFnbWVudCwgZml4ZXMgdGhlIGRlZmF1bHRDaGVja2VkIHByb3BlcnR5CmZ1bmN0aW9uIGZpeERlZmF1bHRDaGVja2VkKCBlbGVtICkgewoJaWYgKCByY2hlY2thYmxlVHlwZS50ZXN0KCBlbGVtLnR5cGUgKSApIHsKCQllbGVtLmRlZmF1bHRDaGVja2VkID0gZWxlbS5jaGVja2VkOwoJfQp9CgovLyBTdXBwb3J0OiBJRTw4Ci8vIE1hbmlwdWxhdGluZyB0YWJsZXMgcmVxdWlyZXMgYSB0Ym9keQpmdW5jdGlvbiBtYW5pcHVsYXRpb25UYXJnZXQoIGVsZW0sIGNvbnRlbnQgKSB7CglyZXR1cm4galF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAidGFibGUiICkgJiYKCQlqUXVlcnkubm9kZU5hbWUoIGNvbnRlbnQubm9kZVR5cGUgIT09IDExID8gY29udGVudCA6IGNvbnRlbnQuZmlyc3RDaGlsZCwgInRyIiApID8KCgkJZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgidGJvZHkiKVswXSB8fAoJCQllbGVtLmFwcGVuZENoaWxkKCBlbGVtLm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGJvZHkiKSApIDoKCQllbGVtOwp9CgovLyBSZXBsYWNlL3Jlc3RvcmUgdGhlIHR5cGUgYXR0cmlidXRlIG9mIHNjcmlwdCBlbGVtZW50cyBmb3Igc2FmZSBET00gbWFuaXB1bGF0aW9uCmZ1bmN0aW9uIGRpc2FibGVTY3JpcHQoIGVsZW0gKSB7CgllbGVtLnR5cGUgPSAoalF1ZXJ5LmZpbmQuYXR0ciggZWxlbSwgInR5cGUiICkgIT09IG51bGwpICsgIi8iICsgZWxlbS50eXBlOwoJcmV0dXJuIGVsZW07Cn0KZnVuY3Rpb24gcmVzdG9yZVNjcmlwdCggZWxlbSApIHsKCXZhciBtYXRjaCA9IHJzY3JpcHRUeXBlTWFza2VkLmV4ZWMoIGVsZW0udHlwZSApOwoJaWYgKCBtYXRjaCApIHsKCQllbGVtLnR5cGUgPSBtYXRjaFsxXTsKCX0gZWxzZSB7CgkJZWxlbS5yZW1vdmVBdHRyaWJ1dGUoInR5cGUiKTsKCX0KCXJldHVybiBlbGVtOwp9CgovLyBNYXJrIHNjcmlwdHMgYXMgaGF2aW5nIGFscmVhZHkgYmVlbiBldmFsdWF0ZWQKZnVuY3Rpb24gc2V0R2xvYmFsRXZhbCggZWxlbXMsIHJlZkVsZW1lbnRzICkgewoJdmFyIGVsZW0sCgkJaSA9IDA7Cglmb3IgKCA7IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQlqUXVlcnkuX2RhdGEoIGVsZW0sICJnbG9iYWxFdmFsIiwgIXJlZkVsZW1lbnRzIHx8IGpRdWVyeS5fZGF0YSggcmVmRWxlbWVudHNbaV0sICJnbG9iYWxFdmFsIiApICk7Cgl9Cn0KCmZ1bmN0aW9uIGNsb25lQ29weUV2ZW50KCBzcmMsIGRlc3QgKSB7CgoJaWYgKCBkZXN0Lm5vZGVUeXBlICE9PSAxIHx8ICFqUXVlcnkuaGFzRGF0YSggc3JjICkgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciB0eXBlLCBpLCBsLAoJCW9sZERhdGEgPSBqUXVlcnkuX2RhdGEoIHNyYyApLAoJCWN1ckRhdGEgPSBqUXVlcnkuX2RhdGEoIGRlc3QsIG9sZERhdGEgKSwKCQlldmVudHMgPSBvbGREYXRhLmV2ZW50czsKCglpZiAoIGV2ZW50cyApIHsKCQlkZWxldGUgY3VyRGF0YS5oYW5kbGU7CgkJY3VyRGF0YS5ldmVudHMgPSB7fTsKCgkJZm9yICggdHlwZSBpbiBldmVudHMgKSB7CgkJCWZvciAoIGkgPSAwLCBsID0gZXZlbnRzWyB0eXBlIF0ubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJalF1ZXJ5LmV2ZW50LmFkZCggZGVzdCwgdHlwZSwgZXZlbnRzWyB0eXBlIF1bIGkgXSApOwoJCQl9CgkJfQoJfQoKCS8vIG1ha2UgdGhlIGNsb25lZCBwdWJsaWMgZGF0YSBvYmplY3QgYSBjb3B5IGZyb20gdGhlIG9yaWdpbmFsCglpZiAoIGN1ckRhdGEuZGF0YSApIHsKCQljdXJEYXRhLmRhdGEgPSBqUXVlcnkuZXh0ZW5kKCB7fSwgY3VyRGF0YS5kYXRhICk7Cgl9Cn0KCmZ1bmN0aW9uIGZpeENsb25lTm9kZUlzc3Vlcyggc3JjLCBkZXN0ICkgewoJdmFyIG5vZGVOYW1lLCBlLCBkYXRhOwoKCS8vIFdlIGRvIG5vdCBuZWVkIHRvIGRvIGFueXRoaW5nIGZvciBub24tRWxlbWVudHMKCWlmICggZGVzdC5ub2RlVHlwZSAhPT0gMSApIHsKCQlyZXR1cm47Cgl9CgoJbm9kZU5hbWUgPSBkZXN0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgoJLy8gSUU2LTggY29waWVzIGV2ZW50cyBib3VuZCB2aWEgYXR0YWNoRXZlbnQgd2hlbiB1c2luZyBjbG9uZU5vZGUuCglpZiAoICFzdXBwb3J0Lm5vQ2xvbmVFdmVudCAmJiBkZXN0WyBqUXVlcnkuZXhwYW5kbyBdICkgewoJCWRhdGEgPSBqUXVlcnkuX2RhdGEoIGRlc3QgKTsKCgkJZm9yICggZSBpbiBkYXRhLmV2ZW50cyApIHsKCQkJalF1ZXJ5LnJlbW92ZUV2ZW50KCBkZXN0LCBlLCBkYXRhLmhhbmRsZSApOwoJCX0KCgkJLy8gRXZlbnQgZGF0YSBnZXRzIHJlZmVyZW5jZWQgaW5zdGVhZCBvZiBjb3BpZWQgaWYgdGhlIGV4cGFuZG8gZ2V0cyBjb3BpZWQgdG9vCgkJZGVzdC5yZW1vdmVBdHRyaWJ1dGUoIGpRdWVyeS5leHBhbmRvICk7Cgl9CgoJLy8gSUUgYmxhbmtzIGNvbnRlbnRzIHdoZW4gY2xvbmluZyBzY3JpcHRzLCBhbmQgdHJpZXMgdG8gZXZhbHVhdGUgbmV3bHktc2V0IHRleHQKCWlmICggbm9kZU5hbWUgPT09ICJzY3JpcHQiICYmIGRlc3QudGV4dCAhPT0gc3JjLnRleHQgKSB7CgkJZGlzYWJsZVNjcmlwdCggZGVzdCApLnRleHQgPSBzcmMudGV4dDsKCQlyZXN0b3JlU2NyaXB0KCBkZXN0ICk7CgoJLy8gSUU2LTEwIGltcHJvcGVybHkgY2xvbmVzIGNoaWxkcmVuIG9mIG9iamVjdCBlbGVtZW50cyB1c2luZyBjbGFzc2lkLgoJLy8gSUUxMCB0aHJvd3MgTm9Nb2RpZmljYXRpb25BbGxvd2VkRXJyb3IgaWYgcGFyZW50IGlzIG51bGwsICMxMjEzMi4KCX0gZWxzZSBpZiAoIG5vZGVOYW1lID09PSAib2JqZWN0IiApIHsKCQlpZiAoIGRlc3QucGFyZW50Tm9kZSApIHsKCQkJZGVzdC5vdXRlckhUTUwgPSBzcmMub3V0ZXJIVE1MOwoJCX0KCgkJLy8gVGhpcyBwYXRoIGFwcGVhcnMgdW5hdm9pZGFibGUgZm9yIElFOS4gV2hlbiBjbG9uaW5nIGFuIG9iamVjdAoJCS8vIGVsZW1lbnQgaW4gSUU5LCB0aGUgb3V0ZXJIVE1MIHN0cmF0ZWd5IGFib3ZlIGlzIG5vdCBzdWZmaWNpZW50LgoJCS8vIElmIHRoZSBzcmMgaGFzIGlubmVySFRNTCBhbmQgdGhlIGRlc3RpbmF0aW9uIGRvZXMgbm90LAoJCS8vIGNvcHkgdGhlIHNyYy5pbm5lckhUTUwgaW50byB0aGUgZGVzdC5pbm5lckhUTUwuICMxMDMyNAoJCWlmICggc3VwcG9ydC5odG1sNUNsb25lICYmICggc3JjLmlubmVySFRNTCAmJiAhalF1ZXJ5LnRyaW0oZGVzdC5pbm5lckhUTUwpICkgKSB7CgkJCWRlc3QuaW5uZXJIVE1MID0gc3JjLmlubmVySFRNTDsKCQl9CgoJfSBlbHNlIGlmICggbm9kZU5hbWUgPT09ICJpbnB1dCIgJiYgcmNoZWNrYWJsZVR5cGUudGVzdCggc3JjLnR5cGUgKSApIHsKCQkvLyBJRTYtOCBmYWlscyB0byBwZXJzaXN0IHRoZSBjaGVja2VkIHN0YXRlIG9mIGEgY2xvbmVkIGNoZWNrYm94CgkJLy8gb3IgcmFkaW8gYnV0dG9uLiBXb3JzZSwgSUU2LTcgZmFpbCB0byBnaXZlIHRoZSBjbG9uZWQgZWxlbWVudAoJCS8vIGEgY2hlY2tlZCBhcHBlYXJhbmNlIGlmIHRoZSBkZWZhdWx0Q2hlY2tlZCB2YWx1ZSBpc24ndCBhbHNvIHNldAoKCQlkZXN0LmRlZmF1bHRDaGVja2VkID0gZGVzdC5jaGVja2VkID0gc3JjLmNoZWNrZWQ7CgoJCS8vIElFNi03IGdldCBjb25mdXNlZCBhbmQgZW5kIHVwIHNldHRpbmcgdGhlIHZhbHVlIG9mIGEgY2xvbmVkCgkJLy8gY2hlY2tib3gvcmFkaW8gYnV0dG9uIHRvIGFuIGVtcHR5IHN0cmluZyBpbnN0ZWFkIG9mICJvbiIKCQlpZiAoIGRlc3QudmFsdWUgIT09IHNyYy52YWx1ZSApIHsKCQkJZGVzdC52YWx1ZSA9IHNyYy52YWx1ZTsKCQl9CgoJLy8gSUU2LTggZmFpbHMgdG8gcmV0dXJuIHRoZSBzZWxlY3RlZCBvcHRpb24gdG8gdGhlIGRlZmF1bHQgc2VsZWN0ZWQKCS8vIHN0YXRlIHdoZW4gY2xvbmluZyBvcHRpb25zCgl9IGVsc2UgaWYgKCBub2RlTmFtZSA9PT0gIm9wdGlvbiIgKSB7CgkJZGVzdC5kZWZhdWx0U2VsZWN0ZWQgPSBkZXN0LnNlbGVjdGVkID0gc3JjLmRlZmF1bHRTZWxlY3RlZDsKCgkvLyBJRTYtOCBmYWlscyB0byBzZXQgdGhlIGRlZmF1bHRWYWx1ZSB0byB0aGUgY29ycmVjdCB2YWx1ZSB3aGVuCgkvLyBjbG9uaW5nIG90aGVyIHR5cGVzIG9mIGlucHV0IGZpZWxkcwoJfSBlbHNlIGlmICggbm9kZU5hbWUgPT09ICJpbnB1dCIgfHwgbm9kZU5hbWUgPT09ICJ0ZXh0YXJlYSIgKSB7CgkJZGVzdC5kZWZhdWx0VmFsdWUgPSBzcmMuZGVmYXVsdFZhbHVlOwoJfQp9CgpqUXVlcnkuZXh0ZW5kKHsKCWNsb25lOiBmdW5jdGlvbiggZWxlbSwgZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMgKSB7CgkJdmFyIGRlc3RFbGVtZW50cywgbm9kZSwgY2xvbmUsIGksIHNyY0VsZW1lbnRzLAoJCQlpblBhZ2UgPSBqUXVlcnkuY29udGFpbnMoIGVsZW0ub3duZXJEb2N1bWVudCwgZWxlbSApOwoKCQlpZiAoIHN1cHBvcnQuaHRtbDVDbG9uZSB8fCBqUXVlcnkuaXNYTUxEb2MoZWxlbSkgfHwgIXJub3NoaW1jYWNoZS50ZXN0KCAiPCIgKyBlbGVtLm5vZGVOYW1lICsgIj4iICkgKSB7CgkJCWNsb25lID0gZWxlbS5jbG9uZU5vZGUoIHRydWUgKTsKCgkJLy8gSUU8PTggZG9lcyBub3QgcHJvcGVybHkgY2xvbmUgZGV0YWNoZWQsIHVua25vd24gZWxlbWVudCBub2RlcwoJCX0gZWxzZSB7CgkJCWZyYWdtZW50RGl2LmlubmVySFRNTCA9IGVsZW0ub3V0ZXJIVE1MOwoJCQlmcmFnbWVudERpdi5yZW1vdmVDaGlsZCggY2xvbmUgPSBmcmFnbWVudERpdi5maXJzdENoaWxkICk7CgkJfQoKCQlpZiAoICghc3VwcG9ydC5ub0Nsb25lRXZlbnQgfHwgIXN1cHBvcnQubm9DbG9uZUNoZWNrZWQpICYmCgkJCQkoZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBlbGVtLm5vZGVUeXBlID09PSAxMSkgJiYgIWpRdWVyeS5pc1hNTERvYyhlbGVtKSApIHsKCgkJCS8vIFdlIGVzY2hldyBTaXp6bGUgaGVyZSBmb3IgcGVyZm9ybWFuY2UgcmVhc29uczogaHR0cDovL2pzcGVyZi5jb20vZ2V0YWxsLXZzLXNpenpsZS8yCgkJCWRlc3RFbGVtZW50cyA9IGdldEFsbCggY2xvbmUgKTsKCQkJc3JjRWxlbWVudHMgPSBnZXRBbGwoIGVsZW0gKTsKCgkJCS8vIEZpeCBhbGwgSUUgY2xvbmluZyBpc3N1ZXMKCQkJZm9yICggaSA9IDA7IChub2RlID0gc3JjRWxlbWVudHNbaV0pICE9IG51bGw7ICsraSApIHsKCQkJCS8vIEVuc3VyZSB0aGF0IHRoZSBkZXN0aW5hdGlvbiBub2RlIGlzIG5vdCBudWxsOyBGaXhlcyAjOTU4NwoJCQkJaWYgKCBkZXN0RWxlbWVudHNbaV0gKSB7CgkJCQkJZml4Q2xvbmVOb2RlSXNzdWVzKCBub2RlLCBkZXN0RWxlbWVudHNbaV0gKTsKCQkJCX0KCQkJfQoJCX0KCgkJLy8gQ29weSB0aGUgZXZlbnRzIGZyb20gdGhlIG9yaWdpbmFsIHRvIHRoZSBjbG9uZQoJCWlmICggZGF0YUFuZEV2ZW50cyApIHsKCQkJaWYgKCBkZWVwRGF0YUFuZEV2ZW50cyApIHsKCQkJCXNyY0VsZW1lbnRzID0gc3JjRWxlbWVudHMgfHwgZ2V0QWxsKCBlbGVtICk7CgkJCQlkZXN0RWxlbWVudHMgPSBkZXN0RWxlbWVudHMgfHwgZ2V0QWxsKCBjbG9uZSApOwoKCQkJCWZvciAoIGkgPSAwOyAobm9kZSA9IHNyY0VsZW1lbnRzW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJCQkJY2xvbmVDb3B5RXZlbnQoIG5vZGUsIGRlc3RFbGVtZW50c1tpXSApOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJY2xvbmVDb3B5RXZlbnQoIGVsZW0sIGNsb25lICk7CgkJCX0KCQl9CgoJCS8vIFByZXNlcnZlIHNjcmlwdCBldmFsdWF0aW9uIGhpc3RvcnkKCQlkZXN0RWxlbWVudHMgPSBnZXRBbGwoIGNsb25lLCAic2NyaXB0IiApOwoJCWlmICggZGVzdEVsZW1lbnRzLmxlbmd0aCA+IDAgKSB7CgkJCXNldEdsb2JhbEV2YWwoIGRlc3RFbGVtZW50cywgIWluUGFnZSAmJiBnZXRBbGwoIGVsZW0sICJzY3JpcHQiICkgKTsKCQl9CgoJCWRlc3RFbGVtZW50cyA9IHNyY0VsZW1lbnRzID0gbm9kZSA9IG51bGw7CgoJCS8vIFJldHVybiB0aGUgY2xvbmVkIHNldAoJCXJldHVybiBjbG9uZTsKCX0sCgoJYnVpbGRGcmFnbWVudDogZnVuY3Rpb24oIGVsZW1zLCBjb250ZXh0LCBzY3JpcHRzLCBzZWxlY3Rpb24gKSB7CgkJdmFyIGosIGVsZW0sIGNvbnRhaW5zLAoJCQl0bXAsIHRhZywgdGJvZHksIHdyYXAsCgkJCWwgPSBlbGVtcy5sZW5ndGgsCgoJCQkvLyBFbnN1cmUgYSBzYWZlIGZyYWdtZW50CgkJCXNhZmUgPSBjcmVhdGVTYWZlRnJhZ21lbnQoIGNvbnRleHQgKSwKCgkJCW5vZGVzID0gW10sCgkJCWkgPSAwOwoKCQlmb3IgKCA7IGkgPCBsOyBpKysgKSB7CgkJCWVsZW0gPSBlbGVtc1sgaSBdOwoKCQkJaWYgKCBlbGVtIHx8IGVsZW0gPT09IDAgKSB7CgoJCQkJLy8gQWRkIG5vZGVzIGRpcmVjdGx5CgkJCQlpZiAoIGpRdWVyeS50eXBlKCBlbGVtICkgPT09ICJvYmplY3QiICkgewoJCQkJCWpRdWVyeS5tZXJnZSggbm9kZXMsIGVsZW0ubm9kZVR5cGUgPyBbIGVsZW0gXSA6IGVsZW0gKTsKCgkJCQkvLyBDb252ZXJ0IG5vbi1odG1sIGludG8gYSB0ZXh0IG5vZGUKCQkJCX0gZWxzZSBpZiAoICFyaHRtbC50ZXN0KCBlbGVtICkgKSB7CgkJCQkJbm9kZXMucHVzaCggY29udGV4dC5jcmVhdGVUZXh0Tm9kZSggZWxlbSApICk7CgoJCQkJLy8gQ29udmVydCBodG1sIGludG8gRE9NIG5vZGVzCgkJCQl9IGVsc2UgewoJCQkJCXRtcCA9IHRtcCB8fCBzYWZlLmFwcGVuZENoaWxkKCBjb250ZXh0LmNyZWF0ZUVsZW1lbnQoImRpdiIpICk7CgoJCQkJCS8vIERlc2VyaWFsaXplIGEgc3RhbmRhcmQgcmVwcmVzZW50YXRpb24KCQkJCQl0YWcgPSAocnRhZ05hbWUuZXhlYyggZWxlbSApIHx8IFsgIiIsICIiIF0pWyAxIF0udG9Mb3dlckNhc2UoKTsKCQkJCQl3cmFwID0gd3JhcE1hcFsgdGFnIF0gfHwgd3JhcE1hcC5fZGVmYXVsdDsKCgkJCQkJdG1wLmlubmVySFRNTCA9IHdyYXBbMV0gKyBlbGVtLnJlcGxhY2UoIHJ4aHRtbFRhZywgIjwkMT48LyQyPiIgKSArIHdyYXBbMl07CgoJCQkJCS8vIERlc2NlbmQgdGhyb3VnaCB3cmFwcGVycyB0byB0aGUgcmlnaHQgY29udGVudAoJCQkJCWogPSB3cmFwWzBdOwoJCQkJCXdoaWxlICggai0tICkgewoJCQkJCQl0bXAgPSB0bXAubGFzdENoaWxkOwoJCQkJCX0KCgkJCQkJLy8gTWFudWFsbHkgYWRkIGxlYWRpbmcgd2hpdGVzcGFjZSByZW1vdmVkIGJ5IElFCgkJCQkJaWYgKCAhc3VwcG9ydC5sZWFkaW5nV2hpdGVzcGFjZSAmJiBybGVhZGluZ1doaXRlc3BhY2UudGVzdCggZWxlbSApICkgewoJCQkJCQlub2Rlcy5wdXNoKCBjb250ZXh0LmNyZWF0ZVRleHROb2RlKCBybGVhZGluZ1doaXRlc3BhY2UuZXhlYyggZWxlbSApWzBdICkgKTsKCQkJCQl9CgoJCQkJCS8vIFJlbW92ZSBJRSdzIGF1dG9pbnNlcnRlZCA8dGJvZHk+IGZyb20gdGFibGUgZnJhZ21lbnRzCgkJCQkJaWYgKCAhc3VwcG9ydC50Ym9keSApIHsKCgkJCQkJCS8vIFN0cmluZyB3YXMgYSA8dGFibGU+LCAqbWF5KiBoYXZlIHNwdXJpb3VzIDx0Ym9keT4KCQkJCQkJZWxlbSA9IHRhZyA9PT0gInRhYmxlIiAmJiAhcnRib2R5LnRlc3QoIGVsZW0gKSA/CgkJCQkJCQl0bXAuZmlyc3RDaGlsZCA6CgoJCQkJCQkJLy8gU3RyaW5nIHdhcyBhIGJhcmUgPHRoZWFkPiBvciA8dGZvb3Q+CgkJCQkJCQl3cmFwWzFdID09PSAiPHRhYmxlPiIgJiYgIXJ0Ym9keS50ZXN0KCBlbGVtICkgPwoJCQkJCQkJCXRtcCA6CgkJCQkJCQkJMDsKCgkJCQkJCWogPSBlbGVtICYmIGVsZW0uY2hpbGROb2Rlcy5sZW5ndGg7CgkJCQkJCXdoaWxlICggai0tICkgewoJCQkJCQkJaWYgKCBqUXVlcnkubm9kZU5hbWUoICh0Ym9keSA9IGVsZW0uY2hpbGROb2Rlc1tqXSksICJ0Ym9keSIgKSAmJiAhdGJvZHkuY2hpbGROb2Rlcy5sZW5ndGggKSB7CgkJCQkJCQkJZWxlbS5yZW1vdmVDaGlsZCggdGJvZHkgKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCgkJCQkJalF1ZXJ5Lm1lcmdlKCBub2RlcywgdG1wLmNoaWxkTm9kZXMgKTsKCgkJCQkJLy8gRml4ICMxMjM5MiBmb3IgV2ViS2l0IGFuZCBJRSA+IDkKCQkJCQl0bXAudGV4dENvbnRlbnQgPSAiIjsKCgkJCQkJLy8gRml4ICMxMjM5MiBmb3Igb2xkSUUKCQkJCQl3aGlsZSAoIHRtcC5maXJzdENoaWxkICkgewoJCQkJCQl0bXAucmVtb3ZlQ2hpbGQoIHRtcC5maXJzdENoaWxkICk7CgkJCQkJfQoKCQkJCQkvLyBSZW1lbWJlciB0aGUgdG9wLWxldmVsIGNvbnRhaW5lciBmb3IgcHJvcGVyIGNsZWFudXAKCQkJCQl0bXAgPSBzYWZlLmxhc3RDaGlsZDsKCQkJCX0KCQkJfQoJCX0KCgkJLy8gRml4ICMxMTM1NjogQ2xlYXIgZWxlbWVudHMgZnJvbSBmcmFnbWVudAoJCWlmICggdG1wICkgewoJCQlzYWZlLnJlbW92ZUNoaWxkKCB0bXAgKTsKCQl9CgoJCS8vIFJlc2V0IGRlZmF1bHRDaGVja2VkIGZvciBhbnkgcmFkaW9zIGFuZCBjaGVja2JveGVzCgkJLy8gYWJvdXQgdG8gYmUgYXBwZW5kZWQgdG8gdGhlIERPTSBpbiBJRSA2LzcgKCM4MDYwKQoJCWlmICggIXN1cHBvcnQuYXBwZW5kQ2hlY2tlZCApIHsKCQkJalF1ZXJ5LmdyZXAoIGdldEFsbCggbm9kZXMsICJpbnB1dCIgKSwgZml4RGVmYXVsdENoZWNrZWQgKTsKCQl9CgoJCWkgPSAwOwoJCXdoaWxlICggKGVsZW0gPSBub2Rlc1sgaSsrIF0pICkgewoKCQkJLy8gIzQwODcgLSBJZiBvcmlnaW4gYW5kIGRlc3RpbmF0aW9uIGVsZW1lbnRzIGFyZSB0aGUgc2FtZSwgYW5kIHRoaXMgaXMKCQkJLy8gdGhhdCBlbGVtZW50LCBkbyBub3QgZG8gYW55dGhpbmcKCQkJaWYgKCBzZWxlY3Rpb24gJiYgalF1ZXJ5LmluQXJyYXkoIGVsZW0sIHNlbGVjdGlvbiApICE9PSAtMSApIHsKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQljb250YWlucyA9IGpRdWVyeS5jb250YWlucyggZWxlbS5vd25lckRvY3VtZW50LCBlbGVtICk7CgoJCQkvLyBBcHBlbmQgdG8gZnJhZ21lbnQKCQkJdG1wID0gZ2V0QWxsKCBzYWZlLmFwcGVuZENoaWxkKCBlbGVtICksICJzY3JpcHQiICk7CgoJCQkvLyBQcmVzZXJ2ZSBzY3JpcHQgZXZhbHVhdGlvbiBoaXN0b3J5CgkJCWlmICggY29udGFpbnMgKSB7CgkJCQlzZXRHbG9iYWxFdmFsKCB0bXAgKTsKCQkJfQoKCQkJLy8gQ2FwdHVyZSBleGVjdXRhYmxlcwoJCQlpZiAoIHNjcmlwdHMgKSB7CgkJCQlqID0gMDsKCQkJCXdoaWxlICggKGVsZW0gPSB0bXBbIGorKyBdKSApIHsKCQkJCQlpZiAoIHJzY3JpcHRUeXBlLnRlc3QoIGVsZW0udHlwZSB8fCAiIiApICkgewoJCQkJCQlzY3JpcHRzLnB1c2goIGVsZW0gKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXRtcCA9IG51bGw7CgoJCXJldHVybiBzYWZlOwoJfSwKCgljbGVhbkRhdGE6IGZ1bmN0aW9uKCBlbGVtcywgLyogaW50ZXJuYWwgKi8gYWNjZXB0RGF0YSApIHsKCQl2YXIgZWxlbSwgdHlwZSwgaWQsIGRhdGEsCgkJCWkgPSAwLAoJCQlpbnRlcm5hbEtleSA9IGpRdWVyeS5leHBhbmRvLAoJCQljYWNoZSA9IGpRdWVyeS5jYWNoZSwKCQkJZGVsZXRlRXhwYW5kbyA9IHN1cHBvcnQuZGVsZXRlRXhwYW5kbywKCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsOwoKCQlmb3IgKCA7IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQkJaWYgKCBhY2NlcHREYXRhIHx8IGpRdWVyeS5hY2NlcHREYXRhKCBlbGVtICkgKSB7CgoJCQkJaWQgPSBlbGVtWyBpbnRlcm5hbEtleSBdOwoJCQkJZGF0YSA9IGlkICYmIGNhY2hlWyBpZCBdOwoKCQkJCWlmICggZGF0YSApIHsKCQkJCQlpZiAoIGRhdGEuZXZlbnRzICkgewoJCQkJCQlmb3IgKCB0eXBlIGluIGRhdGEuZXZlbnRzICkgewoJCQkJCQkJaWYgKCBzcGVjaWFsWyB0eXBlIF0gKSB7CgkJCQkJCQkJalF1ZXJ5LmV2ZW50LnJlbW92ZSggZWxlbSwgdHlwZSApOwoKCQkJCQkJCS8vIFRoaXMgaXMgYSBzaG9ydGN1dCB0byBhdm9pZCBqUXVlcnkuZXZlbnQucmVtb3ZlJ3Mgb3ZlcmhlYWQKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJalF1ZXJ5LnJlbW92ZUV2ZW50KCBlbGVtLCB0eXBlLCBkYXRhLmhhbmRsZSApOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoKCQkJCQkvLyBSZW1vdmUgY2FjaGUgb25seSBpZiBpdCB3YXMgbm90IGFscmVhZHkgcmVtb3ZlZCBieSBqUXVlcnkuZXZlbnQucmVtb3ZlCgkJCQkJaWYgKCBjYWNoZVsgaWQgXSApIHsKCgkJCQkJCWRlbGV0ZSBjYWNoZVsgaWQgXTsKCgkJCQkJCS8vIElFIGRvZXMgbm90IGFsbG93IHVzIHRvIGRlbGV0ZSBleHBhbmRvIHByb3BlcnRpZXMgZnJvbSBub2RlcywKCQkJCQkJLy8gbm9yIGRvZXMgaXQgaGF2ZSBhIHJlbW92ZUF0dHJpYnV0ZSBmdW5jdGlvbiBvbiBEb2N1bWVudCBub2RlczsKCQkJCQkJLy8gd2UgbXVzdCBoYW5kbGUgYWxsIG9mIHRoZXNlIGNhc2VzCgkJCQkJCWlmICggZGVsZXRlRXhwYW5kbyApIHsKCQkJCQkJCWRlbGV0ZSBlbGVtWyBpbnRlcm5hbEtleSBdOwoKCQkJCQkJfSBlbHNlIGlmICggdHlwZW9mIGVsZW0ucmVtb3ZlQXR0cmlidXRlICE9PSBzdHJ1bmRlZmluZWQgKSB7CgkJCQkJCQllbGVtLnJlbW92ZUF0dHJpYnV0ZSggaW50ZXJuYWxLZXkgKTsKCgkJCQkJCX0gZWxzZSB7CgkJCQkJCQllbGVtWyBpbnRlcm5hbEtleSBdID0gbnVsbDsKCQkJCQkJfQoKCQkJCQkJZGVsZXRlZElkcy5wdXNoKCBpZCApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCX0KfSk7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCXRleHQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlyZXR1cm4gYWNjZXNzKCB0aGlzLCBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXJldHVybiB2YWx1ZSA9PT0gdW5kZWZpbmVkID8KCQkJCWpRdWVyeS50ZXh0KCB0aGlzICkgOgoJCQkJdGhpcy5lbXB0eSgpLmFwcGVuZCggKCB0aGlzWzBdICYmIHRoaXNbMF0ub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudCApLmNyZWF0ZVRleHROb2RlKCB2YWx1ZSApICk7CgkJfSwgbnVsbCwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggKTsKCX0sCgoJYXBwZW5kOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5kb21NYW5pcCggYXJndW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJaWYgKCB0aGlzLm5vZGVUeXBlID09PSAxIHx8IHRoaXMubm9kZVR5cGUgPT09IDExIHx8IHRoaXMubm9kZVR5cGUgPT09IDkgKSB7CgkJCQl2YXIgdGFyZ2V0ID0gbWFuaXB1bGF0aW9uVGFyZ2V0KCB0aGlzLCBlbGVtICk7CgkJCQl0YXJnZXQuYXBwZW5kQ2hpbGQoIGVsZW0gKTsKCQkJfQoJCX0pOwoJfSwKCglwcmVwZW5kOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5kb21NYW5pcCggYXJndW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJaWYgKCB0aGlzLm5vZGVUeXBlID09PSAxIHx8IHRoaXMubm9kZVR5cGUgPT09IDExIHx8IHRoaXMubm9kZVR5cGUgPT09IDkgKSB7CgkJCQl2YXIgdGFyZ2V0ID0gbWFuaXB1bGF0aW9uVGFyZ2V0KCB0aGlzLCBlbGVtICk7CgkJCQl0YXJnZXQuaW5zZXJ0QmVmb3JlKCBlbGVtLCB0YXJnZXQuZmlyc3RDaGlsZCApOwoJCQl9CgkJfSk7Cgl9LAoKCWJlZm9yZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZG9tTWFuaXAoIGFyZ3VtZW50cywgZnVuY3Rpb24oIGVsZW0gKSB7CgkJCWlmICggdGhpcy5wYXJlbnROb2RlICkgewoJCQkJdGhpcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZWxlbSwgdGhpcyApOwoJCQl9CgkJfSk7Cgl9LAoKCWFmdGVyOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5kb21NYW5pcCggYXJndW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJaWYgKCB0aGlzLnBhcmVudE5vZGUgKSB7CgkJCQl0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBlbGVtLCB0aGlzLm5leHRTaWJsaW5nICk7CgkJCX0KCQl9KTsKCX0sCgoJcmVtb3ZlOiBmdW5jdGlvbiggc2VsZWN0b3IsIGtlZXBEYXRhIC8qIEludGVybmFsIFVzZSBPbmx5ICovICkgewoJCXZhciBlbGVtLAoJCQllbGVtcyA9IHNlbGVjdG9yID8galF1ZXJ5LmZpbHRlciggc2VsZWN0b3IsIHRoaXMgKSA6IHRoaXMsCgkJCWkgPSAwOwoKCQlmb3IgKCA7IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKCgkJCWlmICggIWtlZXBEYXRhICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQlqUXVlcnkuY2xlYW5EYXRhKCBnZXRBbGwoIGVsZW0gKSApOwoJCQl9CgoJCQlpZiAoIGVsZW0ucGFyZW50Tm9kZSApIHsKCQkJCWlmICgga2VlcERhdGEgJiYgalF1ZXJ5LmNvbnRhaW5zKCBlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0gKSApIHsKCQkJCQlzZXRHbG9iYWxFdmFsKCBnZXRBbGwoIGVsZW0sICJzY3JpcHQiICkgKTsKCQkJCX0KCQkJCWVsZW0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggZWxlbSApOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJZW1wdHk6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtLAoJCQlpID0gMDsKCgkJZm9yICggOyAoZWxlbSA9IHRoaXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQkJLy8gUmVtb3ZlIGVsZW1lbnQgbm9kZXMgYW5kIHByZXZlbnQgbWVtb3J5IGxlYWtzCgkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCWpRdWVyeS5jbGVhbkRhdGEoIGdldEFsbCggZWxlbSwgZmFsc2UgKSApOwoJCQl9CgoJCQkvLyBSZW1vdmUgYW55IHJlbWFpbmluZyBub2RlcwoJCQl3aGlsZSAoIGVsZW0uZmlyc3RDaGlsZCApIHsKCQkJCWVsZW0ucmVtb3ZlQ2hpbGQoIGVsZW0uZmlyc3RDaGlsZCApOwoJCQl9CgoJCQkvLyBJZiB0aGlzIGlzIGEgc2VsZWN0LCBlbnN1cmUgdGhhdCBpdCBkaXNwbGF5cyBlbXB0eSAoIzEyMzM2KQoJCQkvLyBTdXBwb3J0OiBJRTw5CgkJCWlmICggZWxlbS5vcHRpb25zICYmIGpRdWVyeS5ub2RlTmFtZSggZWxlbSwgInNlbGVjdCIgKSApIHsKCQkJCWVsZW0ub3B0aW9ucy5sZW5ndGggPSAwOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJY2xvbmU6IGZ1bmN0aW9uKCBkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cyApIHsKCQlkYXRhQW5kRXZlbnRzID0gZGF0YUFuZEV2ZW50cyA9PSBudWxsID8gZmFsc2UgOiBkYXRhQW5kRXZlbnRzOwoJCWRlZXBEYXRhQW5kRXZlbnRzID0gZGVlcERhdGFBbmRFdmVudHMgPT0gbnVsbCA/IGRhdGFBbmRFdmVudHMgOiBkZWVwRGF0YUFuZEV2ZW50czsKCgkJcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4galF1ZXJ5LmNsb25lKCB0aGlzLCBkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cyApOwoJCX0pOwoJfSwKCglodG1sOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJcmV0dXJuIGFjY2VzcyggdGhpcywgZnVuY3Rpb24oIHZhbHVlICkgewoJCQl2YXIgZWxlbSA9IHRoaXNbIDAgXSB8fCB7fSwKCQkJCWkgPSAwLAoJCQkJbCA9IHRoaXMubGVuZ3RoOwoKCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJcmV0dXJuIGVsZW0ubm9kZVR5cGUgPT09IDEgPwoJCQkJCWVsZW0uaW5uZXJIVE1MLnJlcGxhY2UoIHJpbmxpbmVqUXVlcnksICIiICkgOgoJCQkJCXVuZGVmaW5lZDsKCQkJfQoKCQkJLy8gU2VlIGlmIHdlIGNhbiB0YWtlIGEgc2hvcnRjdXQgYW5kIGp1c3QgdXNlIGlubmVySFRNTAoJCQlpZiAoIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYgIXJub0lubmVyaHRtbC50ZXN0KCB2YWx1ZSApICYmCgkJCQkoIHN1cHBvcnQuaHRtbFNlcmlhbGl6ZSB8fCAhcm5vc2hpbWNhY2hlLnRlc3QoIHZhbHVlICkgICkgJiYKCQkJCSggc3VwcG9ydC5sZWFkaW5nV2hpdGVzcGFjZSB8fCAhcmxlYWRpbmdXaGl0ZXNwYWNlLnRlc3QoIHZhbHVlICkgKSAmJgoJCQkJIXdyYXBNYXBbIChydGFnTmFtZS5leGVjKCB2YWx1ZSApIHx8IFsgIiIsICIiIF0pWyAxIF0udG9Mb3dlckNhc2UoKSBdICkgewoKCQkJCXZhbHVlID0gdmFsdWUucmVwbGFjZSggcnhodG1sVGFnLCAiPCQxPjwvJDI+IiApOwoKCQkJCXRyeSB7CgkJCQkJZm9yICg7IGkgPCBsOyBpKysgKSB7CgkJCQkJCS8vIFJlbW92ZSBlbGVtZW50IG5vZGVzIGFuZCBwcmV2ZW50IG1lbW9yeSBsZWFrcwoJCQkJCQllbGVtID0gdGhpc1tpXSB8fCB7fTsKCQkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJCQkJalF1ZXJ5LmNsZWFuRGF0YSggZ2V0QWxsKCBlbGVtLCBmYWxzZSApICk7CgkJCQkJCQllbGVtLmlubmVySFRNTCA9IHZhbHVlOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQllbGVtID0gMDsKCgkJCQkvLyBJZiB1c2luZyBpbm5lckhUTUwgdGhyb3dzIGFuIGV4Y2VwdGlvbiwgdXNlIHRoZSBmYWxsYmFjayBtZXRob2QKCQkJCX0gY2F0Y2goZSkge30KCQkJfQoKCQkJaWYgKCBlbGVtICkgewoJCQkJdGhpcy5lbXB0eSgpLmFwcGVuZCggdmFsdWUgKTsKCQkJfQoJCX0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoICk7Cgl9LAoKCXJlcGxhY2VXaXRoOiBmdW5jdGlvbigpIHsKCQl2YXIgYXJnID0gYXJndW1lbnRzWyAwIF07CgoJCS8vIE1ha2UgdGhlIGNoYW5nZXMsIHJlcGxhY2luZyBlYWNoIGNvbnRleHQgZWxlbWVudCB3aXRoIHRoZSBuZXcgY29udGVudAoJCXRoaXMuZG9tTWFuaXAoIGFyZ3VtZW50cywgZnVuY3Rpb24oIGVsZW0gKSB7CgkJCWFyZyA9IHRoaXMucGFyZW50Tm9kZTsKCgkJCWpRdWVyeS5jbGVhbkRhdGEoIGdldEFsbCggdGhpcyApICk7CgoJCQlpZiAoIGFyZyApIHsKCQkJCWFyZy5yZXBsYWNlQ2hpbGQoIGVsZW0sIHRoaXMgKTsKCQkJfQoJCX0pOwoKCQkvLyBGb3JjZSByZW1vdmFsIGlmIHRoZXJlIHdhcyBubyBuZXcgY29udGVudCAoZS5nLiwgZnJvbSBlbXB0eSBhcmd1bWVudHMpCgkJcmV0dXJuIGFyZyAmJiAoYXJnLmxlbmd0aCB8fCBhcmcubm9kZVR5cGUpID8gdGhpcyA6IHRoaXMucmVtb3ZlKCk7Cgl9LAoKCWRldGFjaDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiB0aGlzLnJlbW92ZSggc2VsZWN0b3IsIHRydWUgKTsKCX0sCgoJZG9tTWFuaXA6IGZ1bmN0aW9uKCBhcmdzLCBjYWxsYmFjayApIHsKCgkJLy8gRmxhdHRlbiBhbnkgbmVzdGVkIGFycmF5cwoJCWFyZ3MgPSBjb25jYXQuYXBwbHkoIFtdLCBhcmdzICk7CgoJCXZhciBmaXJzdCwgbm9kZSwgaGFzU2NyaXB0cywKCQkJc2NyaXB0cywgZG9jLCBmcmFnbWVudCwKCQkJaSA9IDAsCgkJCWwgPSB0aGlzLmxlbmd0aCwKCQkJc2V0ID0gdGhpcywKCQkJaU5vQ2xvbmUgPSBsIC0gMSwKCQkJdmFsdWUgPSBhcmdzWzBdLAoJCQlpc0Z1bmN0aW9uID0galF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICk7CgoJCS8vIFdlIGNhbid0IGNsb25lTm9kZSBmcmFnbWVudHMgdGhhdCBjb250YWluIGNoZWNrZWQsIGluIFdlYktpdAoJCWlmICggaXNGdW5jdGlvbiB8fAoJCQkJKCBsID4gMSAmJiB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICYmCgkJCQkJIXN1cHBvcnQuY2hlY2tDbG9uZSAmJiByY2hlY2tlZC50ZXN0KCB2YWx1ZSApICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oIGluZGV4ICkgewoJCQkJdmFyIHNlbGYgPSBzZXQuZXEoIGluZGV4ICk7CgkJCQlpZiAoIGlzRnVuY3Rpb24gKSB7CgkJCQkJYXJnc1swXSA9IHZhbHVlLmNhbGwoIHRoaXMsIGluZGV4LCBzZWxmLmh0bWwoKSApOwoJCQkJfQoJCQkJc2VsZi5kb21NYW5pcCggYXJncywgY2FsbGJhY2sgKTsKCQkJfSk7CgkJfQoKCQlpZiAoIGwgKSB7CgkJCWZyYWdtZW50ID0galF1ZXJ5LmJ1aWxkRnJhZ21lbnQoIGFyZ3MsIHRoaXNbIDAgXS5vd25lckRvY3VtZW50LCBmYWxzZSwgdGhpcyApOwoJCQlmaXJzdCA9IGZyYWdtZW50LmZpcnN0Q2hpbGQ7CgoJCQlpZiAoIGZyYWdtZW50LmNoaWxkTm9kZXMubGVuZ3RoID09PSAxICkgewoJCQkJZnJhZ21lbnQgPSBmaXJzdDsKCQkJfQoKCQkJaWYgKCBmaXJzdCApIHsKCQkJCXNjcmlwdHMgPSBqUXVlcnkubWFwKCBnZXRBbGwoIGZyYWdtZW50LCAic2NyaXB0IiApLCBkaXNhYmxlU2NyaXB0ICk7CgkJCQloYXNTY3JpcHRzID0gc2NyaXB0cy5sZW5ndGg7CgoJCQkJLy8gVXNlIHRoZSBvcmlnaW5hbCBmcmFnbWVudCBmb3IgdGhlIGxhc3QgaXRlbSBpbnN0ZWFkIG9mIHRoZSBmaXJzdCBiZWNhdXNlIGl0IGNhbiBlbmQgdXAKCQkJCS8vIGJlaW5nIGVtcHRpZWQgaW5jb3JyZWN0bHkgaW4gY2VydGFpbiBzaXR1YXRpb25zICgjODA3MCkuCgkJCQlmb3IgKCA7IGkgPCBsOyBpKysgKSB7CgkJCQkJbm9kZSA9IGZyYWdtZW50OwoKCQkJCQlpZiAoIGkgIT09IGlOb0Nsb25lICkgewoJCQkJCQlub2RlID0galF1ZXJ5LmNsb25lKCBub2RlLCB0cnVlLCB0cnVlICk7CgoJCQkJCQkvLyBLZWVwIHJlZmVyZW5jZXMgdG8gY2xvbmVkIHNjcmlwdHMgZm9yIGxhdGVyIHJlc3RvcmF0aW9uCgkJCQkJCWlmICggaGFzU2NyaXB0cyApIHsKCQkJCQkJCWpRdWVyeS5tZXJnZSggc2NyaXB0cywgZ2V0QWxsKCBub2RlLCAic2NyaXB0IiApICk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWNhbGxiYWNrLmNhbGwoIHRoaXNbaV0sIG5vZGUsIGkgKTsKCQkJCX0KCgkJCQlpZiAoIGhhc1NjcmlwdHMgKSB7CgkJCQkJZG9jID0gc2NyaXB0c1sgc2NyaXB0cy5sZW5ndGggLSAxIF0ub3duZXJEb2N1bWVudDsKCgkJCQkJLy8gUmVlbmFibGUgc2NyaXB0cwoJCQkJCWpRdWVyeS5tYXAoIHNjcmlwdHMsIHJlc3RvcmVTY3JpcHQgKTsKCgkJCQkJLy8gRXZhbHVhdGUgZXhlY3V0YWJsZSBzY3JpcHRzIG9uIGZpcnN0IGRvY3VtZW50IGluc2VydGlvbgoJCQkJCWZvciAoIGkgPSAwOyBpIDwgaGFzU2NyaXB0czsgaSsrICkgewoJCQkJCQlub2RlID0gc2NyaXB0c1sgaSBdOwoJCQkJCQlpZiAoIHJzY3JpcHRUeXBlLnRlc3QoIG5vZGUudHlwZSB8fCAiIiApICYmCgkJCQkJCQkhalF1ZXJ5Ll9kYXRhKCBub2RlLCAiZ2xvYmFsRXZhbCIgKSAmJiBqUXVlcnkuY29udGFpbnMoIGRvYywgbm9kZSApICkgewoKCQkJCQkJCWlmICggbm9kZS5zcmMgKSB7CgkJCQkJCQkJLy8gT3B0aW9uYWwgQUpBWCBkZXBlbmRlbmN5LCBidXQgd29uJ3QgcnVuIHNjcmlwdHMgaWYgbm90IHByZXNlbnQKCQkJCQkJCQlpZiAoIGpRdWVyeS5fZXZhbFVybCApIHsKCQkJCQkJCQkJalF1ZXJ5Ll9ldmFsVXJsKCBub2RlLnNyYyApOwoJCQkJCQkJCX0KCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJalF1ZXJ5Lmdsb2JhbEV2YWwoICggbm9kZS50ZXh0IHx8IG5vZGUudGV4dENvbnRlbnQgfHwgbm9kZS5pbm5lckhUTUwgfHwgIiIgKS5yZXBsYWNlKCByY2xlYW5TY3JpcHQsICIiICkgKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0KCgkJCQkvLyBGaXggIzExODA5OiBBdm9pZCBsZWFraW5nIG1lbW9yeQoJCQkJZnJhZ21lbnQgPSBmaXJzdCA9IG51bGw7CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoJfQp9KTsKCmpRdWVyeS5lYWNoKHsKCWFwcGVuZFRvOiAiYXBwZW5kIiwKCXByZXBlbmRUbzogInByZXBlbmQiLAoJaW5zZXJ0QmVmb3JlOiAiYmVmb3JlIiwKCWluc2VydEFmdGVyOiAiYWZ0ZXIiLAoJcmVwbGFjZUFsbDogInJlcGxhY2VXaXRoIgp9LCBmdW5jdGlvbiggbmFtZSwgb3JpZ2luYWwgKSB7CglqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQl2YXIgZWxlbXMsCgkJCWkgPSAwLAoJCQlyZXQgPSBbXSwKCQkJaW5zZXJ0ID0galF1ZXJ5KCBzZWxlY3RvciApLAoJCQlsYXN0ID0gaW5zZXJ0Lmxlbmd0aCAtIDE7CgoJCWZvciAoIDsgaSA8PSBsYXN0OyBpKysgKSB7CgkJCWVsZW1zID0gaSA9PT0gbGFzdCA/IHRoaXMgOiB0aGlzLmNsb25lKHRydWUpOwoJCQlqUXVlcnkoIGluc2VydFtpXSApWyBvcmlnaW5hbCBdKCBlbGVtcyApOwoKCQkJLy8gTW9kZXJuIGJyb3dzZXJzIGNhbiBhcHBseSBqUXVlcnkgY29sbGVjdGlvbnMgYXMgYXJyYXlzLCBidXQgb2xkSUUgbmVlZHMgYSAuZ2V0KCkKCQkJcHVzaC5hcHBseSggcmV0LCBlbGVtcy5nZXQoKSApOwoJCX0KCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCByZXQgKTsKCX07Cn0pOwoKCnZhciBpZnJhbWUsCgllbGVtZGlzcGxheSA9IHt9OwoKLyoqCiAqIFJldHJpZXZlIHRoZSBhY3R1YWwgZGlzcGxheSBvZiBhIGVsZW1lbnQKICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgbm9kZU5hbWUgb2YgdGhlIGVsZW1lbnQKICogQHBhcmFtIHtPYmplY3R9IGRvYyBEb2N1bWVudCBvYmplY3QKICovCi8vIENhbGxlZCBvbmx5IGZyb20gd2l0aGluIGRlZmF1bHREaXNwbGF5CmZ1bmN0aW9uIGFjdHVhbERpc3BsYXkoIG5hbWUsIGRvYyApIHsKCXZhciBlbGVtID0galF1ZXJ5KCBkb2MuY3JlYXRlRWxlbWVudCggbmFtZSApICkuYXBwZW5kVG8oIGRvYy5ib2R5ICksCgoJCS8vIGdldERlZmF1bHRDb21wdXRlZFN0eWxlIG1pZ2h0IGJlIHJlbGlhYmx5IHVzZWQgb25seSBvbiBhdHRhY2hlZCBlbGVtZW50CgkJZGlzcGxheSA9IHdpbmRvdy5nZXREZWZhdWx0Q29tcHV0ZWRTdHlsZSA/CgoJCQkvLyBVc2Ugb2YgdGhpcyBtZXRob2QgaXMgYSB0ZW1wb3JhcnkgZml4IChtb3JlIGxpa2Ugb3B0bWl6YXRpb24pIHVudGlsIHNvbWV0aGluZyBiZXR0ZXIgY29tZXMgYWxvbmcsCgkJCS8vIHNpbmNlIGl0IHdhcyByZW1vdmVkIGZyb20gc3BlY2lmaWNhdGlvbiBhbmQgc3VwcG9ydGVkIG9ubHkgaW4gRkYKCQkJd2luZG93LmdldERlZmF1bHRDb21wdXRlZFN0eWxlKCBlbGVtWyAwIF0gKS5kaXNwbGF5IDogalF1ZXJ5LmNzcyggZWxlbVsgMCBdLCAiZGlzcGxheSIgKTsKCgkvLyBXZSBkb24ndCBoYXZlIGFueSBkYXRhIHN0b3JlZCBvbiB0aGUgZWxlbWVudCwKCS8vIHNvIHVzZSAiZGV0YWNoIiBtZXRob2QgYXMgZmFzdCB3YXkgdG8gZ2V0IHJpZCBvZiB0aGUgZWxlbWVudAoJZWxlbS5kZXRhY2goKTsKCglyZXR1cm4gZGlzcGxheTsKfQoKLyoqCiAqIFRyeSB0byBkZXRlcm1pbmUgdGhlIGRlZmF1bHQgZGlzcGxheSB2YWx1ZSBvZiBhbiBlbGVtZW50CiAqIEBwYXJhbSB7U3RyaW5nfSBub2RlTmFtZQogKi8KZnVuY3Rpb24gZGVmYXVsdERpc3BsYXkoIG5vZGVOYW1lICkgewoJdmFyIGRvYyA9IGRvY3VtZW50LAoJCWRpc3BsYXkgPSBlbGVtZGlzcGxheVsgbm9kZU5hbWUgXTsKCglpZiAoICFkaXNwbGF5ICkgewoJCWRpc3BsYXkgPSBhY3R1YWxEaXNwbGF5KCBub2RlTmFtZSwgZG9jICk7CgoJCS8vIElmIHRoZSBzaW1wbGUgd2F5IGZhaWxzLCByZWFkIGZyb20gaW5zaWRlIGFuIGlmcmFtZQoJCWlmICggZGlzcGxheSA9PT0gIm5vbmUiIHx8ICFkaXNwbGF5ICkgewoKCQkJLy8gVXNlIHRoZSBhbHJlYWR5LWNyZWF0ZWQgaWZyYW1lIGlmIHBvc3NpYmxlCgkJCWlmcmFtZSA9IChpZnJhbWUgfHwgalF1ZXJ5KCAiPGlmcmFtZSBmcmFtZWJvcmRlcj0nMCcgd2lkdGg9JzAnIGhlaWdodD0nMCcvPiIgKSkuYXBwZW5kVG8oIGRvYy5kb2N1bWVudEVsZW1lbnQgKTsKCgkJCS8vIEFsd2F5cyB3cml0ZSBhIG5ldyBIVE1MIHNrZWxldG9uIHNvIFdlYmtpdCBhbmQgRmlyZWZveCBkb24ndCBjaG9rZSBvbiByZXVzZQoJCQlkb2MgPSAoIGlmcmFtZVsgMCBdLmNvbnRlbnRXaW5kb3cgfHwgaWZyYW1lWyAwIF0uY29udGVudERvY3VtZW50ICkuZG9jdW1lbnQ7CgoJCQkvLyBTdXBwb3J0OiBJRQoJCQlkb2Mud3JpdGUoKTsKCQkJZG9jLmNsb3NlKCk7CgoJCQlkaXNwbGF5ID0gYWN0dWFsRGlzcGxheSggbm9kZU5hbWUsIGRvYyApOwoJCQlpZnJhbWUuZGV0YWNoKCk7CgkJfQoKCQkvLyBTdG9yZSB0aGUgY29ycmVjdCBkZWZhdWx0IGRpc3BsYXkKCQllbGVtZGlzcGxheVsgbm9kZU5hbWUgXSA9IGRpc3BsYXk7Cgl9CgoJcmV0dXJuIGRpc3BsYXk7Cn0KCgooZnVuY3Rpb24oKSB7Cgl2YXIgYSwgc2hyaW5rV3JhcEJsb2Nrc1ZhbCwKCQlkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCWRpdlJlc2V0ID0KCQkJIi13ZWJraXQtYm94LXNpemluZzpjb250ZW50LWJveDstbW96LWJveC1zaXppbmc6Y29udGVudC1ib3g7Ym94LXNpemluZzpjb250ZW50LWJveDsiICsKCQkJImRpc3BsYXk6YmxvY2s7cGFkZGluZzowO21hcmdpbjowO2JvcmRlcjowIjsKCgkvLyBTZXR1cAoJZGl2LmlubmVySFRNTCA9ICIgIDxsaW5rLz48dGFibGU+PC90YWJsZT48YSBocmVmPScvYSc+YTwvYT48aW5wdXQgdHlwZT0nY2hlY2tib3gnLz4iOwoJYSA9IGRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSggImEiIClbIDAgXTsKCglhLnN0eWxlLmNzc1RleHQgPSAiZmxvYXQ6bGVmdDtvcGFjaXR5Oi41IjsKCgkvLyBNYWtlIHN1cmUgdGhhdCBlbGVtZW50IG9wYWNpdHkgZXhpc3RzCgkvLyAoSUUgdXNlcyBmaWx0ZXIgaW5zdGVhZCkKCS8vIFVzZSBhIHJlZ2V4IHRvIHdvcmsgYXJvdW5kIGEgV2ViS2l0IGlzc3VlLiBTZWUgIzUxNDUKCXN1cHBvcnQub3BhY2l0eSA9IC9eMC41Ly50ZXN0KCBhLnN0eWxlLm9wYWNpdHkgKTsKCgkvLyBWZXJpZnkgc3R5bGUgZmxvYXQgZXhpc3RlbmNlCgkvLyAoSUUgdXNlcyBzdHlsZUZsb2F0IGluc3RlYWQgb2YgY3NzRmxvYXQpCglzdXBwb3J0LmNzc0Zsb2F0ID0gISFhLnN0eWxlLmNzc0Zsb2F0OwoKCWRpdi5zdHlsZS5iYWNrZ3JvdW5kQ2xpcCA9ICJjb250ZW50LWJveCI7CglkaXYuY2xvbmVOb2RlKCB0cnVlICkuc3R5bGUuYmFja2dyb3VuZENsaXAgPSAiIjsKCXN1cHBvcnQuY2xlYXJDbG9uZVN0eWxlID0gZGl2LnN0eWxlLmJhY2tncm91bmRDbGlwID09PSAiY29udGVudC1ib3giOwoKCS8vIE51bGwgZWxlbWVudHMgdG8gYXZvaWQgbGVha3MgaW4gSUUuCglhID0gZGl2ID0gbnVsbDsKCglzdXBwb3J0LnNocmlua1dyYXBCbG9ja3MgPSBmdW5jdGlvbigpIHsKCQl2YXIgYm9keSwgY29udGFpbmVyLCBkaXYsIGNvbnRhaW5lclN0eWxlczsKCgkJaWYgKCBzaHJpbmtXcmFwQmxvY2tzVmFsID09IG51bGwgKSB7CgkJCWJvZHkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSggImJvZHkiIClbIDAgXTsKCQkJaWYgKCAhYm9keSApIHsKCQkJCS8vIFRlc3QgZmlyZWQgdG9vIGVhcmx5IG9yIGluIGFuIHVuc3VwcG9ydGVkIGVudmlyb25tZW50LCBleGl0LgoJCQkJcmV0dXJuOwoJCQl9CgoJCQljb250YWluZXJTdHlsZXMgPSAiYm9yZGVyOjA7d2lkdGg6MDtoZWlnaHQ6MDtwb3NpdGlvbjphYnNvbHV0ZTt0b3A6MDtsZWZ0Oi05OTk5cHgiOwoJCQljb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJCQlkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoKCQkJYm9keS5hcHBlbmRDaGlsZCggY29udGFpbmVyICkuYXBwZW5kQ2hpbGQoIGRpdiApOwoKCQkJLy8gV2lsbCBiZSBjaGFuZ2VkIGxhdGVyIGlmIG5lZWRlZC4KCQkJc2hyaW5rV3JhcEJsb2Nrc1ZhbCA9IGZhbHNlOwoKCQkJaWYgKCB0eXBlb2YgZGl2LnN0eWxlLnpvb20gIT09IHN0cnVuZGVmaW5lZCApIHsKCQkJCS8vIFN1cHBvcnQ6IElFNgoJCQkJLy8gQ2hlY2sgaWYgZWxlbWVudHMgd2l0aCBsYXlvdXQgc2hyaW5rLXdyYXAgdGhlaXIgY2hpbGRyZW4KCQkJCWRpdi5zdHlsZS5jc3NUZXh0ID0gZGl2UmVzZXQgKyAiO3dpZHRoOjFweDtwYWRkaW5nOjFweDt6b29tOjEiOwoJCQkJZGl2LmlubmVySFRNTCA9ICI8ZGl2PjwvZGl2PiI7CgkJCQlkaXYuZmlyc3RDaGlsZC5zdHlsZS53aWR0aCA9ICI1cHgiOwoJCQkJc2hyaW5rV3JhcEJsb2Nrc1ZhbCA9IGRpdi5vZmZzZXRXaWR0aCAhPT0gMzsKCQkJfQoKCQkJYm9keS5yZW1vdmVDaGlsZCggY29udGFpbmVyICk7CgoJCQkvLyBOdWxsIGVsZW1lbnRzIHRvIGF2b2lkIGxlYWtzIGluIElFLgoJCQlib2R5ID0gY29udGFpbmVyID0gZGl2ID0gbnVsbDsKCQl9CgoJCXJldHVybiBzaHJpbmtXcmFwQmxvY2tzVmFsOwoJfTsKCn0pKCk7CnZhciBybWFyZ2luID0gKC9ebWFyZ2luLyk7Cgp2YXIgcm51bW5vbnB4ID0gbmV3IFJlZ0V4cCggIl4oIiArIHBudW0gKyAiKSg/IXB4KVthLXolXSskIiwgImkiICk7CgoKCnZhciBnZXRTdHlsZXMsIGN1ckNTUywKCXJwb3NpdGlvbiA9IC9eKHRvcHxyaWdodHxib3R0b218bGVmdCkkLzsKCmlmICggd2luZG93LmdldENvbXB1dGVkU3R5bGUgKSB7CglnZXRTdHlsZXMgPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gZWxlbS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUoIGVsZW0sIG51bGwgKTsKCX07CgoJY3VyQ1NTID0gZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGNvbXB1dGVkICkgewoJCXZhciB3aWR0aCwgbWluV2lkdGgsIG1heFdpZHRoLCByZXQsCgkJCXN0eWxlID0gZWxlbS5zdHlsZTsKCgkJY29tcHV0ZWQgPSBjb21wdXRlZCB8fCBnZXRTdHlsZXMoIGVsZW0gKTsKCgkJLy8gZ2V0UHJvcGVydHlWYWx1ZSBpcyBvbmx5IG5lZWRlZCBmb3IgLmNzcygnZmlsdGVyJykgaW4gSUU5LCBzZWUgIzEyNTM3CgkJcmV0ID0gY29tcHV0ZWQgPyBjb21wdXRlZC5nZXRQcm9wZXJ0eVZhbHVlKCBuYW1lICkgfHwgY29tcHV0ZWRbIG5hbWUgXSA6IHVuZGVmaW5lZDsKCgkJaWYgKCBjb21wdXRlZCApIHsKCgkJCWlmICggcmV0ID09PSAiIiAmJiAhalF1ZXJ5LmNvbnRhaW5zKCBlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0gKSApIHsKCQkJCXJldCA9IGpRdWVyeS5zdHlsZSggZWxlbSwgbmFtZSApOwoJCQl9CgoJCQkvLyBBIHRyaWJ1dGUgdG8gdGhlICJhd2Vzb21lIGhhY2sgYnkgRGVhbiBFZHdhcmRzIgoJCQkvLyBDaHJvbWUgPCAxNyBhbmQgU2FmYXJpIDUuMCB1c2VzICJjb21wdXRlZCB2YWx1ZSIgaW5zdGVhZCBvZiAidXNlZCB2YWx1ZSIgZm9yIG1hcmdpbi1yaWdodAoJCQkvLyBTYWZhcmkgNS4xLjcgKGF0IGxlYXN0KSByZXR1cm5zIHBlcmNlbnRhZ2UgZm9yIGEgbGFyZ2VyIHNldCBvZiB2YWx1ZXMsIGJ1dCB3aWR0aCBzZWVtcyB0byBiZSByZWxpYWJseSBwaXhlbHMKCQkJLy8gdGhpcyBpcyBhZ2FpbnN0IHRoZSBDU1NPTSBkcmFmdCBzcGVjOiBodHRwOi8vZGV2LnczLm9yZy9jc3N3Zy9jc3NvbS8jcmVzb2x2ZWQtdmFsdWVzCgkJCWlmICggcm51bW5vbnB4LnRlc3QoIHJldCApICYmIHJtYXJnaW4udGVzdCggbmFtZSApICkgewoKCQkJCS8vIFJlbWVtYmVyIHRoZSBvcmlnaW5hbCB2YWx1ZXMKCQkJCXdpZHRoID0gc3R5bGUud2lkdGg7CgkJCQltaW5XaWR0aCA9IHN0eWxlLm1pbldpZHRoOwoJCQkJbWF4V2lkdGggPSBzdHlsZS5tYXhXaWR0aDsKCgkJCQkvLyBQdXQgaW4gdGhlIG5ldyB2YWx1ZXMgdG8gZ2V0IGEgY29tcHV0ZWQgdmFsdWUgb3V0CgkJCQlzdHlsZS5taW5XaWR0aCA9IHN0eWxlLm1heFdpZHRoID0gc3R5bGUud2lkdGggPSByZXQ7CgkJCQlyZXQgPSBjb21wdXRlZC53aWR0aDsKCgkJCQkvLyBSZXZlcnQgdGhlIGNoYW5nZWQgdmFsdWVzCgkJCQlzdHlsZS53aWR0aCA9IHdpZHRoOwoJCQkJc3R5bGUubWluV2lkdGggPSBtaW5XaWR0aDsKCQkJCXN0eWxlLm1heFdpZHRoID0gbWF4V2lkdGg7CgkJCX0KCQl9CgoJCS8vIFN1cHBvcnQ6IElFCgkJLy8gSUUgcmV0dXJucyB6SW5kZXggdmFsdWUgYXMgYW4gaW50ZWdlci4KCQlyZXR1cm4gcmV0ID09PSB1bmRlZmluZWQgPwoJCQlyZXQgOgoJCQlyZXQgKyAiIjsKCX07Cn0gZWxzZSBpZiAoIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jdXJyZW50U3R5bGUgKSB7CglnZXRTdHlsZXMgPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gZWxlbS5jdXJyZW50U3R5bGU7Cgl9OwoKCWN1ckNTUyA9IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBjb21wdXRlZCApIHsKCQl2YXIgbGVmdCwgcnMsIHJzTGVmdCwgcmV0LAoJCQlzdHlsZSA9IGVsZW0uc3R5bGU7CgoJCWNvbXB1dGVkID0gY29tcHV0ZWQgfHwgZ2V0U3R5bGVzKCBlbGVtICk7CgkJcmV0ID0gY29tcHV0ZWQgPyBjb21wdXRlZFsgbmFtZSBdIDogdW5kZWZpbmVkOwoKCQkvLyBBdm9pZCBzZXR0aW5nIHJldCB0byBlbXB0eSBzdHJpbmcgaGVyZQoJCS8vIHNvIHdlIGRvbid0IGRlZmF1bHQgdG8gYXV0bwoJCWlmICggcmV0ID09IG51bGwgJiYgc3R5bGUgJiYgc3R5bGVbIG5hbWUgXSApIHsKCQkJcmV0ID0gc3R5bGVbIG5hbWUgXTsKCQl9CgoJCS8vIEZyb20gdGhlIGF3ZXNvbWUgaGFjayBieSBEZWFuIEVkd2FyZHMKCQkvLyBodHRwOi8vZXJpay5lYWUubmV0L2FyY2hpdmVzLzIwMDcvMDcvMjcvMTguNTQuMTUvI2NvbW1lbnQtMTAyMjkxCgoJCS8vIElmIHdlJ3JlIG5vdCBkZWFsaW5nIHdpdGggYSByZWd1bGFyIHBpeGVsIG51bWJlcgoJCS8vIGJ1dCBhIG51bWJlciB0aGF0IGhhcyBhIHdlaXJkIGVuZGluZywgd2UgbmVlZCB0byBjb252ZXJ0IGl0IHRvIHBpeGVscwoJCS8vIGJ1dCBub3QgcG9zaXRpb24gY3NzIGF0dHJpYnV0ZXMsIGFzIHRob3NlIGFyZSBwcm9wb3J0aW9uYWwgdG8gdGhlIHBhcmVudCBlbGVtZW50IGluc3RlYWQKCQkvLyBhbmQgd2UgY2FuJ3QgbWVhc3VyZSB0aGUgcGFyZW50IGluc3RlYWQgYmVjYXVzZSBpdCBtaWdodCB0cmlnZ2VyIGEgInN0YWNraW5nIGRvbGxzIiBwcm9ibGVtCgkJaWYgKCBybnVtbm9ucHgudGVzdCggcmV0ICkgJiYgIXJwb3NpdGlvbi50ZXN0KCBuYW1lICkgKSB7CgoJCQkvLyBSZW1lbWJlciB0aGUgb3JpZ2luYWwgdmFsdWVzCgkJCWxlZnQgPSBzdHlsZS5sZWZ0OwoJCQlycyA9IGVsZW0ucnVudGltZVN0eWxlOwoJCQlyc0xlZnQgPSBycyAmJiBycy5sZWZ0OwoKCQkJLy8gUHV0IGluIHRoZSBuZXcgdmFsdWVzIHRvIGdldCBhIGNvbXB1dGVkIHZhbHVlIG91dAoJCQlpZiAoIHJzTGVmdCApIHsKCQkJCXJzLmxlZnQgPSBlbGVtLmN1cnJlbnRTdHlsZS5sZWZ0OwoJCQl9CgkJCXN0eWxlLmxlZnQgPSBuYW1lID09PSAiZm9udFNpemUiID8gIjFlbSIgOiByZXQ7CgkJCXJldCA9IHN0eWxlLnBpeGVsTGVmdCArICJweCI7CgoJCQkvLyBSZXZlcnQgdGhlIGNoYW5nZWQgdmFsdWVzCgkJCXN0eWxlLmxlZnQgPSBsZWZ0OwoJCQlpZiAoIHJzTGVmdCApIHsKCQkJCXJzLmxlZnQgPSByc0xlZnQ7CgkJCX0KCQl9CgoJCS8vIFN1cHBvcnQ6IElFCgkJLy8gSUUgcmV0dXJucyB6SW5kZXggdmFsdWUgYXMgYW4gaW50ZWdlci4KCQlyZXR1cm4gcmV0ID09PSB1bmRlZmluZWQgPwoJCQlyZXQgOgoJCQlyZXQgKyAiIiB8fCAiYXV0byI7Cgl9Owp9CgoKCgpmdW5jdGlvbiBhZGRHZXRIb29rSWYoIGNvbmRpdGlvbkZuLCBob29rRm4gKSB7CgkvLyBEZWZpbmUgdGhlIGhvb2ssIHdlJ2xsIGNoZWNrIG9uIHRoZSBmaXJzdCBydW4gaWYgaXQncyByZWFsbHkgbmVlZGVkLgoJcmV0dXJuIHsKCQlnZXQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgY29uZGl0aW9uID0gY29uZGl0aW9uRm4oKTsKCgkJCWlmICggY29uZGl0aW9uID09IG51bGwgKSB7CgkJCQkvLyBUaGUgdGVzdCB3YXMgbm90IHJlYWR5IGF0IHRoaXMgcG9pbnQ7IHNjcmV3IHRoZSBob29rIHRoaXMgdGltZQoJCQkJLy8gYnV0IGNoZWNrIGFnYWluIHdoZW4gbmVlZGVkIG5leHQgdGltZS4KCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCBjb25kaXRpb24gKSB7CgkJCQkvLyBIb29rIG5vdCBuZWVkZWQgKG9yIGl0J3Mgbm90IHBvc3NpYmxlIHRvIHVzZSBpdCBkdWUgdG8gbWlzc2luZyBkZXBlbmRlbmN5KSwKCQkJCS8vIHJlbW92ZSBpdC4KCQkJCS8vIFNpbmNlIHRoZXJlIGFyZSBubyBvdGhlciBob29rcyBmb3IgbWFyZ2luUmlnaHQsIHJlbW92ZSB0aGUgd2hvbGUgb2JqZWN0LgoJCQkJZGVsZXRlIHRoaXMuZ2V0OwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBIb29rIG5lZWRlZDsgcmVkZWZpbmUgaXQgc28gdGhhdCB0aGUgc3VwcG9ydCB0ZXN0IGlzIG5vdCBleGVjdXRlZCBhZ2Fpbi4KCgkJCXJldHVybiAodGhpcy5nZXQgPSBob29rRm4pLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl9Cgl9Owp9CgoKKGZ1bmN0aW9uKCkgewoJdmFyIGEsIHJlbGlhYmxlSGlkZGVuT2Zmc2V0c1ZhbCwgYm94U2l6aW5nVmFsLCBib3hTaXppbmdSZWxpYWJsZVZhbCwKCQlwaXhlbFBvc2l0aW9uVmFsLCByZWxpYWJsZU1hcmdpblJpZ2h0VmFsLAoJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCgkJY29udGFpbmVyU3R5bGVzID0gImJvcmRlcjowO3dpZHRoOjA7aGVpZ2h0OjA7cG9zaXRpb246YWJzb2x1dGU7dG9wOjA7bGVmdDotOTk5OXB4IiwKCQlkaXZSZXNldCA9CgkJCSItd2Via2l0LWJveC1zaXppbmc6Y29udGVudC1ib3g7LW1vei1ib3gtc2l6aW5nOmNvbnRlbnQtYm94O2JveC1zaXppbmc6Y29udGVudC1ib3g7IiArCgkJCSJkaXNwbGF5OmJsb2NrO3BhZGRpbmc6MDttYXJnaW46MDtib3JkZXI6MCI7CgoJLy8gU2V0dXAKCWRpdi5pbm5lckhUTUwgPSAiICA8bGluay8+PHRhYmxlPjwvdGFibGU+PGEgaHJlZj0nL2EnPmE8L2E+PGlucHV0IHR5cGU9J2NoZWNrYm94Jy8+IjsKCWEgPSBkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoICJhIiApWyAwIF07CgoJYS5zdHlsZS5jc3NUZXh0ID0gImZsb2F0OmxlZnQ7b3BhY2l0eTouNSI7CgoJLy8gTWFrZSBzdXJlIHRoYXQgZWxlbWVudCBvcGFjaXR5IGV4aXN0cwoJLy8gKElFIHVzZXMgZmlsdGVyIGluc3RlYWQpCgkvLyBVc2UgYSByZWdleCB0byB3b3JrIGFyb3VuZCBhIFdlYktpdCBpc3N1ZS4gU2VlICM1MTQ1CglzdXBwb3J0Lm9wYWNpdHkgPSAvXjAuNS8udGVzdCggYS5zdHlsZS5vcGFjaXR5ICk7CgoJLy8gVmVyaWZ5IHN0eWxlIGZsb2F0IGV4aXN0ZW5jZQoJLy8gKElFIHVzZXMgc3R5bGVGbG9hdCBpbnN0ZWFkIG9mIGNzc0Zsb2F0KQoJc3VwcG9ydC5jc3NGbG9hdCA9ICEhYS5zdHlsZS5jc3NGbG9hdDsKCglkaXYuc3R5bGUuYmFja2dyb3VuZENsaXAgPSAiY29udGVudC1ib3giOwoJZGl2LmNsb25lTm9kZSggdHJ1ZSApLnN0eWxlLmJhY2tncm91bmRDbGlwID0gIiI7CglzdXBwb3J0LmNsZWFyQ2xvbmVTdHlsZSA9IGRpdi5zdHlsZS5iYWNrZ3JvdW5kQ2xpcCA9PT0gImNvbnRlbnQtYm94IjsKCgkvLyBOdWxsIGVsZW1lbnRzIHRvIGF2b2lkIGxlYWtzIGluIElFLgoJYSA9IGRpdiA9IG51bGw7CgoJalF1ZXJ5LmV4dGVuZChzdXBwb3J0LCB7CgkJcmVsaWFibGVIaWRkZW5PZmZzZXRzOiBmdW5jdGlvbigpIHsKCQkJaWYgKCByZWxpYWJsZUhpZGRlbk9mZnNldHNWYWwgIT0gbnVsbCApIHsKCQkJCXJldHVybiByZWxpYWJsZUhpZGRlbk9mZnNldHNWYWw7CgkJCX0KCgkJCXZhciBjb250YWluZXIsIHRkcywgaXNTdXBwb3J0ZWQsCgkJCQlkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCQkJYm9keSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCAiYm9keSIgKVsgMCBdOwoKCQkJaWYgKCAhYm9keSApIHsKCQkJCS8vIFJldHVybiBmb3IgZnJhbWVzZXQgZG9jcyB0aGF0IGRvbid0IGhhdmUgYSBib2R5CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFNldHVwCgkJCWRpdi5zZXRBdHRyaWJ1dGUoICJjbGFzc05hbWUiLCAidCIgKTsKCQkJZGl2LmlubmVySFRNTCA9ICIgIDxsaW5rLz48dGFibGU+PC90YWJsZT48YSBocmVmPScvYSc+YTwvYT48aW5wdXQgdHlwZT0nY2hlY2tib3gnLz4iOwoKCQkJY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJY29udGFpbmVyLnN0eWxlLmNzc1RleHQgPSBjb250YWluZXJTdHlsZXM7CgoJCQlib2R5LmFwcGVuZENoaWxkKCBjb250YWluZXIgKS5hcHBlbmRDaGlsZCggZGl2ICk7CgoJCQkvLyBTdXBwb3J0OiBJRTgKCQkJLy8gQ2hlY2sgaWYgdGFibGUgY2VsbHMgc3RpbGwgaGF2ZSBvZmZzZXRXaWR0aC9IZWlnaHQgd2hlbiB0aGV5IGFyZSBzZXQKCQkJLy8gdG8gZGlzcGxheTpub25lIGFuZCB0aGVyZSBhcmUgc3RpbGwgb3RoZXIgdmlzaWJsZSB0YWJsZSBjZWxscyBpbiBhCgkJCS8vIHRhYmxlIHJvdzsgaWYgc28sIG9mZnNldFdpZHRoL0hlaWdodCBhcmUgbm90IHJlbGlhYmxlIGZvciB1c2Ugd2hlbgoJCQkvLyBkZXRlcm1pbmluZyBpZiBhbiBlbGVtZW50IGhhcyBiZWVuIGhpZGRlbiBkaXJlY3RseSB1c2luZwoJCQkvLyBkaXNwbGF5Om5vbmUgKGl0IGlzIHN0aWxsIHNhZmUgdG8gdXNlIG9mZnNldHMgaWYgYSBwYXJlbnQgZWxlbWVudCBpcwoJCQkvLyBoaWRkZW47IGRvbiBzYWZldHkgZ29nZ2xlcyBhbmQgc2VlIGJ1ZyAjNDUxMiBmb3IgbW9yZSBpbmZvcm1hdGlvbikuCgkJCWRpdi5pbm5lckhUTUwgPSAiPHRhYmxlPjx0cj48dGQ+PC90ZD48dGQ+dDwvdGQ+PC90cj48L3RhYmxlPiI7CgkJCXRkcyA9IGRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSggInRkIiApOwoJCQl0ZHNbIDAgXS5zdHlsZS5jc3NUZXh0ID0gInBhZGRpbmc6MDttYXJnaW46MDtib3JkZXI6MDtkaXNwbGF5Om5vbmUiOwoJCQlpc1N1cHBvcnRlZCA9ICggdGRzWyAwIF0ub2Zmc2V0SGVpZ2h0ID09PSAwICk7CgoJCQl0ZHNbIDAgXS5zdHlsZS5kaXNwbGF5ID0gIiI7CgkJCXRkc1sgMSBdLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CgoJCQkvLyBTdXBwb3J0OiBJRTgKCQkJLy8gQ2hlY2sgaWYgZW1wdHkgdGFibGUgY2VsbHMgc3RpbGwgaGF2ZSBvZmZzZXRXaWR0aC9IZWlnaHQKCQkJcmVsaWFibGVIaWRkZW5PZmZzZXRzVmFsID0gaXNTdXBwb3J0ZWQgJiYgKCB0ZHNbIDAgXS5vZmZzZXRIZWlnaHQgPT09IDAgKTsKCgkJCWJvZHkucmVtb3ZlQ2hpbGQoIGNvbnRhaW5lciApOwoKCQkJLy8gTnVsbCBlbGVtZW50cyB0byBhdm9pZCBsZWFrcyBpbiBJRS4KCQkJZGl2ID0gYm9keSA9IG51bGw7CgoJCQlyZXR1cm4gcmVsaWFibGVIaWRkZW5PZmZzZXRzVmFsOwoJCX0sCgoJCWJveFNpemluZzogZnVuY3Rpb24oKSB7CgkJCWlmICggYm94U2l6aW5nVmFsID09IG51bGwgKSB7CgkJCQljb21wdXRlU3R5bGVUZXN0cygpOwoJCQl9CgkJCXJldHVybiBib3hTaXppbmdWYWw7CgkJfSwKCgkJYm94U2l6aW5nUmVsaWFibGU6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIGJveFNpemluZ1JlbGlhYmxlVmFsID09IG51bGwgKSB7CgkJCQljb21wdXRlU3R5bGVUZXN0cygpOwoJCQl9CgkJCXJldHVybiBib3hTaXppbmdSZWxpYWJsZVZhbDsKCQl9LAoKCQlwaXhlbFBvc2l0aW9uOiBmdW5jdGlvbigpIHsKCQkJaWYgKCBwaXhlbFBvc2l0aW9uVmFsID09IG51bGwgKSB7CgkJCQljb21wdXRlU3R5bGVUZXN0cygpOwoJCQl9CgkJCXJldHVybiBwaXhlbFBvc2l0aW9uVmFsOwoJCX0sCgoJCXJlbGlhYmxlTWFyZ2luUmlnaHQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgYm9keSwgY29udGFpbmVyLCBkaXYsIG1hcmdpbkRpdjsKCgkJCS8vIFVzZSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSBiZWNhdXNlIGpzZG9tIG9uIG5vZGUuanMgd2lsbCBicmVhayB3aXRob3V0IGl0LgoJCQlpZiAoIHJlbGlhYmxlTWFyZ2luUmlnaHRWYWwgPT0gbnVsbCAmJiB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSApIHsKCQkJCWJvZHkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSggImJvZHkiIClbIDAgXTsKCQkJCWlmICggIWJvZHkgKSB7CgkJCQkJLy8gVGVzdCBmaXJlZCB0b28gZWFybHkgb3IgaW4gYW4gdW5zdXBwb3J0ZWQgZW52aXJvbm1lbnQsIGV4aXQuCgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgkJCQlkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJCQkJY29udGFpbmVyLnN0eWxlLmNzc1RleHQgPSBjb250YWluZXJTdHlsZXM7CgoJCQkJYm9keS5hcHBlbmRDaGlsZCggY29udGFpbmVyICkuYXBwZW5kQ2hpbGQoIGRpdiApOwoKCQkJCS8vIENoZWNrIGlmIGRpdiB3aXRoIGV4cGxpY2l0IHdpZHRoIGFuZCBubyBtYXJnaW4tcmlnaHQgaW5jb3JyZWN0bHkKCQkJCS8vIGdldHMgY29tcHV0ZWQgbWFyZ2luLXJpZ2h0IGJhc2VkIG9uIHdpZHRoIG9mIGNvbnRhaW5lci4gKCMzMzMzKQoJCQkJLy8gRmFpbHMgaW4gV2ViS2l0IGJlZm9yZSBGZWIgMjAxMSBuaWdodGxpZXMKCQkJCS8vIFdlYktpdCBCdWcgMTMzNDMgLSBnZXRDb21wdXRlZFN0eWxlIHJldHVybnMgd3JvbmcgdmFsdWUgZm9yIG1hcmdpbi1yaWdodAoJCQkJbWFyZ2luRGl2ID0gZGl2LmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApICk7CgkJCQltYXJnaW5EaXYuc3R5bGUuY3NzVGV4dCA9IGRpdi5zdHlsZS5jc3NUZXh0ID0gZGl2UmVzZXQ7CgkJCQltYXJnaW5EaXYuc3R5bGUubWFyZ2luUmlnaHQgPSBtYXJnaW5EaXYuc3R5bGUud2lkdGggPSAiMCI7CgkJCQlkaXYuc3R5bGUud2lkdGggPSAiMXB4IjsKCgkJCQlyZWxpYWJsZU1hcmdpblJpZ2h0VmFsID0KCQkJCQkhcGFyc2VGbG9hdCggKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSggbWFyZ2luRGl2LCBudWxsICkgfHwge30gKS5tYXJnaW5SaWdodCApOwoKCQkJCWJvZHkucmVtb3ZlQ2hpbGQoIGNvbnRhaW5lciApOwoJCQl9CgoJCQlyZXR1cm4gcmVsaWFibGVNYXJnaW5SaWdodFZhbDsKCQl9Cgl9KTsKCglmdW5jdGlvbiBjb21wdXRlU3R5bGVUZXN0cygpIHsKCQl2YXIgY29udGFpbmVyLCBkaXYsCgkJCWJvZHkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSggImJvZHkiIClbIDAgXTsKCgkJaWYgKCAhYm9keSApIHsKCQkJLy8gVGVzdCBmaXJlZCB0b28gZWFybHkgb3IgaW4gYW4gdW5zdXBwb3J0ZWQgZW52aXJvbm1lbnQsIGV4aXQuCgkJCXJldHVybjsKCQl9CgoJCWNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgkJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQljb250YWluZXIuc3R5bGUuY3NzVGV4dCA9IGNvbnRhaW5lclN0eWxlczsKCgkJYm9keS5hcHBlbmRDaGlsZCggY29udGFpbmVyICkuYXBwZW5kQ2hpbGQoIGRpdiApOwoKCQlkaXYuc3R5bGUuY3NzVGV4dCA9CgkJCSItd2Via2l0LWJveC1zaXppbmc6Ym9yZGVyLWJveDstbW96LWJveC1zaXppbmc6Ym9yZGVyLWJveDtib3gtc2l6aW5nOmJvcmRlci1ib3g7IiArCgkJCQkicG9zaXRpb246YWJzb2x1dGU7ZGlzcGxheTpibG9jaztwYWRkaW5nOjFweDtib3JkZXI6MXB4O3dpZHRoOjRweDsiICsKCQkJCSJtYXJnaW4tdG9wOjElO3RvcDoxJSI7CgoJCS8vIFdvcmthcm91bmQgZmFpbGluZyBib3hTaXppbmcgdGVzdCBkdWUgdG8gb2Zmc2V0V2lkdGggcmV0dXJuaW5nIHdyb25nIHZhbHVlCgkJLy8gd2l0aCBzb21lIG5vbi0xIHZhbHVlcyBvZiBib2R5IHpvb20sIHRpY2tldCAjMTM1NDMKCQlqUXVlcnkuc3dhcCggYm9keSwgYm9keS5zdHlsZS56b29tICE9IG51bGwgPyB7IHpvb206IDEgfSA6IHt9LCBmdW5jdGlvbigpIHsKCQkJYm94U2l6aW5nVmFsID0gZGl2Lm9mZnNldFdpZHRoID09PSA0OwoJCX0pOwoKCQkvLyBXaWxsIGJlIGNoYW5nZWQgbGF0ZXIgaWYgbmVlZGVkLgoJCWJveFNpemluZ1JlbGlhYmxlVmFsID0gdHJ1ZTsKCQlwaXhlbFBvc2l0aW9uVmFsID0gZmFsc2U7CgkJcmVsaWFibGVNYXJnaW5SaWdodFZhbCA9IHRydWU7CgoJCS8vIFVzZSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSBiZWNhdXNlIGpzZG9tIG9uIG5vZGUuanMgd2lsbCBicmVhayB3aXRob3V0IGl0LgoJCWlmICggd2luZG93LmdldENvbXB1dGVkU3R5bGUgKSB7CgkJCXBpeGVsUG9zaXRpb25WYWwgPSAoIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBkaXYsIG51bGwgKSB8fCB7fSApLnRvcCAhPT0gIjElIjsKCQkJYm94U2l6aW5nUmVsaWFibGVWYWwgPQoJCQkJKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSggZGl2LCBudWxsICkgfHwgeyB3aWR0aDogIjRweCIgfSApLndpZHRoID09PSAiNHB4IjsKCQl9CgoJCWJvZHkucmVtb3ZlQ2hpbGQoIGNvbnRhaW5lciApOwoKCQkvLyBOdWxsIGVsZW1lbnRzIHRvIGF2b2lkIGxlYWtzIGluIElFLgoJCWRpdiA9IGJvZHkgPSBudWxsOwoJfQoKfSkoKTsKCgovLyBBIG1ldGhvZCBmb3IgcXVpY2tseSBzd2FwcGluZyBpbi9vdXQgQ1NTIHByb3BlcnRpZXMgdG8gZ2V0IGNvcnJlY3QgY2FsY3VsYXRpb25zLgpqUXVlcnkuc3dhcCA9IGZ1bmN0aW9uKCBlbGVtLCBvcHRpb25zLCBjYWxsYmFjaywgYXJncyApIHsKCXZhciByZXQsIG5hbWUsCgkJb2xkID0ge307CgoJLy8gUmVtZW1iZXIgdGhlIG9sZCB2YWx1ZXMsIGFuZCBpbnNlcnQgdGhlIG5ldyBvbmVzCglmb3IgKCBuYW1lIGluIG9wdGlvbnMgKSB7CgkJb2xkWyBuYW1lIF0gPSBlbGVtLnN0eWxlWyBuYW1lIF07CgkJZWxlbS5zdHlsZVsgbmFtZSBdID0gb3B0aW9uc1sgbmFtZSBdOwoJfQoKCXJldCA9IGNhbGxiYWNrLmFwcGx5KCBlbGVtLCBhcmdzIHx8IFtdICk7CgoJLy8gUmV2ZXJ0IHRoZSBvbGQgdmFsdWVzCglmb3IgKCBuYW1lIGluIG9wdGlvbnMgKSB7CgkJZWxlbS5zdHlsZVsgbmFtZSBdID0gb2xkWyBuYW1lIF07Cgl9CgoJcmV0dXJuIHJldDsKfTsKCgp2YXIKCQlyYWxwaGEgPSAvYWxwaGFcKFteKV0qXCkvaSwKCXJvcGFjaXR5ID0gL29wYWNpdHlccyo9XHMqKFteKV0qKS8sCgoJLy8gc3dhcHBhYmxlIGlmIGRpc3BsYXkgaXMgbm9uZSBvciBzdGFydHMgd2l0aCB0YWJsZSBleGNlcHQgInRhYmxlIiwgInRhYmxlLWNlbGwiLCBvciAidGFibGUtY2FwdGlvbiIKCS8vIHNlZSBoZXJlIGZvciBkaXNwbGF5IHZhbHVlczogaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9DU1MvZGlzcGxheQoJcmRpc3BsYXlzd2FwID0gL14obm9uZXx0YWJsZSg/IS1jW2VhXSkuKykvLAoJcm51bXNwbGl0ID0gbmV3IFJlZ0V4cCggIl4oIiArIHBudW0gKyAiKSguKikkIiwgImkiICksCglycmVsTnVtID0gbmV3IFJlZ0V4cCggIl4oWystXSk9KCIgKyBwbnVtICsgIikiLCAiaSIgKSwKCgljc3NTaG93ID0geyBwb3NpdGlvbjogImFic29sdXRlIiwgdmlzaWJpbGl0eTogImhpZGRlbiIsIGRpc3BsYXk6ICJibG9jayIgfSwKCWNzc05vcm1hbFRyYW5zZm9ybSA9IHsKCQlsZXR0ZXJTcGFjaW5nOiAwLAoJCWZvbnRXZWlnaHQ6IDQwMAoJfSwKCgljc3NQcmVmaXhlcyA9IFsgIldlYmtpdCIsICJPIiwgIk1veiIsICJtcyIgXTsKCgovLyByZXR1cm4gYSBjc3MgcHJvcGVydHkgbWFwcGVkIHRvIGEgcG90ZW50aWFsbHkgdmVuZG9yIHByZWZpeGVkIHByb3BlcnR5CmZ1bmN0aW9uIHZlbmRvclByb3BOYW1lKCBzdHlsZSwgbmFtZSApIHsKCgkvLyBzaG9ydGN1dCBmb3IgbmFtZXMgdGhhdCBhcmUgbm90IHZlbmRvciBwcmVmaXhlZAoJaWYgKCBuYW1lIGluIHN0eWxlICkgewoJCXJldHVybiBuYW1lOwoJfQoKCS8vIGNoZWNrIGZvciB2ZW5kb3IgcHJlZml4ZWQgbmFtZXMKCXZhciBjYXBOYW1lID0gbmFtZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoMSksCgkJb3JpZ05hbWUgPSBuYW1lLAoJCWkgPSBjc3NQcmVmaXhlcy5sZW5ndGg7CgoJd2hpbGUgKCBpLS0gKSB7CgkJbmFtZSA9IGNzc1ByZWZpeGVzWyBpIF0gKyBjYXBOYW1lOwoJCWlmICggbmFtZSBpbiBzdHlsZSApIHsKCQkJcmV0dXJuIG5hbWU7CgkJfQoJfQoKCXJldHVybiBvcmlnTmFtZTsKfQoKZnVuY3Rpb24gc2hvd0hpZGUoIGVsZW1lbnRzLCBzaG93ICkgewoJdmFyIGRpc3BsYXksIGVsZW0sIGhpZGRlbiwKCQl2YWx1ZXMgPSBbXSwKCQlpbmRleCA9IDAsCgkJbGVuZ3RoID0gZWxlbWVudHMubGVuZ3RoOwoKCWZvciAoIDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7CgkJZWxlbSA9IGVsZW1lbnRzWyBpbmRleCBdOwoJCWlmICggIWVsZW0uc3R5bGUgKSB7CgkJCWNvbnRpbnVlOwoJCX0KCgkJdmFsdWVzWyBpbmRleCBdID0galF1ZXJ5Ll9kYXRhKCBlbGVtLCAib2xkZGlzcGxheSIgKTsKCQlkaXNwbGF5ID0gZWxlbS5zdHlsZS5kaXNwbGF5OwoJCWlmICggc2hvdyApIHsKCQkJLy8gUmVzZXQgdGhlIGlubGluZSBkaXNwbGF5IG9mIHRoaXMgZWxlbWVudCB0byBsZWFybiBpZiBpdCBpcwoJCQkvLyBiZWluZyBoaWRkZW4gYnkgY2FzY2FkZWQgcnVsZXMgb3Igbm90CgkJCWlmICggIXZhbHVlc1sgaW5kZXggXSAmJiBkaXNwbGF5ID09PSAibm9uZSIgKSB7CgkJCQllbGVtLnN0eWxlLmRpc3BsYXkgPSAiIjsKCQkJfQoKCQkJLy8gU2V0IGVsZW1lbnRzIHdoaWNoIGhhdmUgYmVlbiBvdmVycmlkZGVuIHdpdGggZGlzcGxheTogbm9uZQoJCQkvLyBpbiBhIHN0eWxlc2hlZXQgdG8gd2hhdGV2ZXIgdGhlIGRlZmF1bHQgYnJvd3NlciBzdHlsZSBpcwoJCQkvLyBmb3Igc3VjaCBhbiBlbGVtZW50CgkJCWlmICggZWxlbS5zdHlsZS5kaXNwbGF5ID09PSAiIiAmJiBpc0hpZGRlbiggZWxlbSApICkgewoJCQkJdmFsdWVzWyBpbmRleCBdID0galF1ZXJ5Ll9kYXRhKCBlbGVtLCAib2xkZGlzcGxheSIsIGRlZmF1bHREaXNwbGF5KGVsZW0ubm9kZU5hbWUpICk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKCAhdmFsdWVzWyBpbmRleCBdICkgewoJCQkJaGlkZGVuID0gaXNIaWRkZW4oIGVsZW0gKTsKCgkJCQlpZiAoIGRpc3BsYXkgJiYgZGlzcGxheSAhPT0gIm5vbmUiIHx8ICFoaWRkZW4gKSB7CgkJCQkJalF1ZXJ5Ll9kYXRhKCBlbGVtLCAib2xkZGlzcGxheSIsIGhpZGRlbiA/IGRpc3BsYXkgOiBqUXVlcnkuY3NzKCBlbGVtLCAiZGlzcGxheSIgKSApOwoJCQkJfQoJCQl9CgkJfQoJfQoKCS8vIFNldCB0aGUgZGlzcGxheSBvZiBtb3N0IG9mIHRoZSBlbGVtZW50cyBpbiBhIHNlY29uZCBsb29wCgkvLyB0byBhdm9pZCB0aGUgY29uc3RhbnQgcmVmbG93Cglmb3IgKCBpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrICkgewoJCWVsZW0gPSBlbGVtZW50c1sgaW5kZXggXTsKCQlpZiAoICFlbGVtLnN0eWxlICkgewoJCQljb250aW51ZTsKCQl9CgkJaWYgKCAhc2hvdyB8fCBlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICJub25lIiB8fCBlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICIiICkgewoJCQllbGVtLnN0eWxlLmRpc3BsYXkgPSBzaG93ID8gdmFsdWVzWyBpbmRleCBdIHx8ICIiIDogIm5vbmUiOwoJCX0KCX0KCglyZXR1cm4gZWxlbWVudHM7Cn0KCmZ1bmN0aW9uIHNldFBvc2l0aXZlTnVtYmVyKCBlbGVtLCB2YWx1ZSwgc3VidHJhY3QgKSB7Cgl2YXIgbWF0Y2hlcyA9IHJudW1zcGxpdC5leGVjKCB2YWx1ZSApOwoJcmV0dXJuIG1hdGNoZXMgPwoJCS8vIEd1YXJkIGFnYWluc3QgdW5kZWZpbmVkICJzdWJ0cmFjdCIsIGUuZy4sIHdoZW4gdXNlZCBhcyBpbiBjc3NIb29rcwoJCU1hdGgubWF4KCAwLCBtYXRjaGVzWyAxIF0gLSAoIHN1YnRyYWN0IHx8IDAgKSApICsgKCBtYXRjaGVzWyAyIF0gfHwgInB4IiApIDoKCQl2YWx1ZTsKfQoKZnVuY3Rpb24gYXVnbWVudFdpZHRoT3JIZWlnaHQoIGVsZW0sIG5hbWUsIGV4dHJhLCBpc0JvcmRlckJveCwgc3R5bGVzICkgewoJdmFyIGkgPSBleHRyYSA9PT0gKCBpc0JvcmRlckJveCA/ICJib3JkZXIiIDogImNvbnRlbnQiICkgPwoJCS8vIElmIHdlIGFscmVhZHkgaGF2ZSB0aGUgcmlnaHQgbWVhc3VyZW1lbnQsIGF2b2lkIGF1Z21lbnRhdGlvbgoJCTQgOgoJCS8vIE90aGVyd2lzZSBpbml0aWFsaXplIGZvciBob3Jpem9udGFsIG9yIHZlcnRpY2FsIHByb3BlcnRpZXMKCQluYW1lID09PSAid2lkdGgiID8gMSA6IDAsCgoJCXZhbCA9IDA7CgoJZm9yICggOyBpIDwgNDsgaSArPSAyICkgewoJCS8vIGJvdGggYm94IG1vZGVscyBleGNsdWRlIG1hcmdpbiwgc28gYWRkIGl0IGlmIHdlIHdhbnQgaXQKCQlpZiAoIGV4dHJhID09PSAibWFyZ2luIiApIHsKCQkJdmFsICs9IGpRdWVyeS5jc3MoIGVsZW0sIGV4dHJhICsgY3NzRXhwYW5kWyBpIF0sIHRydWUsIHN0eWxlcyApOwoJCX0KCgkJaWYgKCBpc0JvcmRlckJveCApIHsKCQkJLy8gYm9yZGVyLWJveCBpbmNsdWRlcyBwYWRkaW5nLCBzbyByZW1vdmUgaXQgaWYgd2Ugd2FudCBjb250ZW50CgkJCWlmICggZXh0cmEgPT09ICJjb250ZW50IiApIHsKCQkJCXZhbCAtPSBqUXVlcnkuY3NzKCBlbGVtLCAicGFkZGluZyIgKyBjc3NFeHBhbmRbIGkgXSwgdHJ1ZSwgc3R5bGVzICk7CgkJCX0KCgkJCS8vIGF0IHRoaXMgcG9pbnQsIGV4dHJhIGlzbid0IGJvcmRlciBub3IgbWFyZ2luLCBzbyByZW1vdmUgYm9yZGVyCgkJCWlmICggZXh0cmEgIT09ICJtYXJnaW4iICkgewoJCQkJdmFsIC09IGpRdWVyeS5jc3MoIGVsZW0sICJib3JkZXIiICsgY3NzRXhwYW5kWyBpIF0gKyAiV2lkdGgiLCB0cnVlLCBzdHlsZXMgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCS8vIGF0IHRoaXMgcG9pbnQsIGV4dHJhIGlzbid0IGNvbnRlbnQsIHNvIGFkZCBwYWRkaW5nCgkJCXZhbCArPSBqUXVlcnkuY3NzKCBlbGVtLCAicGFkZGluZyIgKyBjc3NFeHBhbmRbIGkgXSwgdHJ1ZSwgc3R5bGVzICk7CgoJCQkvLyBhdCB0aGlzIHBvaW50LCBleHRyYSBpc24ndCBjb250ZW50IG5vciBwYWRkaW5nLCBzbyBhZGQgYm9yZGVyCgkJCWlmICggZXh0cmEgIT09ICJwYWRkaW5nIiApIHsKCQkJCXZhbCArPSBqUXVlcnkuY3NzKCBlbGVtLCAiYm9yZGVyIiArIGNzc0V4cGFuZFsgaSBdICsgIldpZHRoIiwgdHJ1ZSwgc3R5bGVzICk7CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIHZhbDsKfQoKZnVuY3Rpb24gZ2V0V2lkdGhPckhlaWdodCggZWxlbSwgbmFtZSwgZXh0cmEgKSB7CgoJLy8gU3RhcnQgd2l0aCBvZmZzZXQgcHJvcGVydHksIHdoaWNoIGlzIGVxdWl2YWxlbnQgdG8gdGhlIGJvcmRlci1ib3ggdmFsdWUKCXZhciB2YWx1ZUlzQm9yZGVyQm94ID0gdHJ1ZSwKCQl2YWwgPSBuYW1lID09PSAid2lkdGgiID8gZWxlbS5vZmZzZXRXaWR0aCA6IGVsZW0ub2Zmc2V0SGVpZ2h0LAoJCXN0eWxlcyA9IGdldFN0eWxlcyggZWxlbSApLAoJCWlzQm9yZGVyQm94ID0gc3VwcG9ydC5ib3hTaXppbmcoKSAmJiBqUXVlcnkuY3NzKCBlbGVtLCAiYm94U2l6aW5nIiwgZmFsc2UsIHN0eWxlcyApID09PSAiYm9yZGVyLWJveCI7CgoJLy8gc29tZSBub24taHRtbCBlbGVtZW50cyByZXR1cm4gdW5kZWZpbmVkIGZvciBvZmZzZXRXaWR0aCwgc28gY2hlY2sgZm9yIG51bGwvdW5kZWZpbmVkCgkvLyBzdmcgLSBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD02NDkyODUKCS8vIE1hdGhNTCAtIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTQ5MTY2OAoJaWYgKCB2YWwgPD0gMCB8fCB2YWwgPT0gbnVsbCApIHsKCQkvLyBGYWxsIGJhY2sgdG8gY29tcHV0ZWQgdGhlbiB1bmNvbXB1dGVkIGNzcyBpZiBuZWNlc3NhcnkKCQl2YWwgPSBjdXJDU1MoIGVsZW0sIG5hbWUsIHN0eWxlcyApOwoJCWlmICggdmFsIDwgMCB8fCB2YWwgPT0gbnVsbCApIHsKCQkJdmFsID0gZWxlbS5zdHlsZVsgbmFtZSBdOwoJCX0KCgkJLy8gQ29tcHV0ZWQgdW5pdCBpcyBub3QgcGl4ZWxzLiBTdG9wIGhlcmUgYW5kIHJldHVybi4KCQlpZiAoIHJudW1ub25weC50ZXN0KHZhbCkgKSB7CgkJCXJldHVybiB2YWw7CgkJfQoKCQkvLyB3ZSBuZWVkIHRoZSBjaGVjayBmb3Igc3R5bGUgaW4gY2FzZSBhIGJyb3dzZXIgd2hpY2ggcmV0dXJucyB1bnJlbGlhYmxlIHZhbHVlcwoJCS8vIGZvciBnZXRDb21wdXRlZFN0eWxlIHNpbGVudGx5IGZhbGxzIGJhY2sgdG8gdGhlIHJlbGlhYmxlIGVsZW0uc3R5bGUKCQl2YWx1ZUlzQm9yZGVyQm94ID0gaXNCb3JkZXJCb3ggJiYgKCBzdXBwb3J0LmJveFNpemluZ1JlbGlhYmxlKCkgfHwgdmFsID09PSBlbGVtLnN0eWxlWyBuYW1lIF0gKTsKCgkJLy8gTm9ybWFsaXplICIiLCBhdXRvLCBhbmQgcHJlcGFyZSBmb3IgZXh0cmEKCQl2YWwgPSBwYXJzZUZsb2F0KCB2YWwgKSB8fCAwOwoJfQoKCS8vIHVzZSB0aGUgYWN0aXZlIGJveC1zaXppbmcgbW9kZWwgdG8gYWRkL3N1YnRyYWN0IGlycmVsZXZhbnQgc3R5bGVzCglyZXR1cm4gKCB2YWwgKwoJCWF1Z21lbnRXaWR0aE9ySGVpZ2h0KAoJCQllbGVtLAoJCQluYW1lLAoJCQlleHRyYSB8fCAoIGlzQm9yZGVyQm94ID8gImJvcmRlciIgOiAiY29udGVudCIgKSwKCQkJdmFsdWVJc0JvcmRlckJveCwKCQkJc3R5bGVzCgkJKQoJKSArICJweCI7Cn0KCmpRdWVyeS5leHRlbmQoewoJLy8gQWRkIGluIHN0eWxlIHByb3BlcnR5IGhvb2tzIGZvciBvdmVycmlkaW5nIHRoZSBkZWZhdWx0CgkvLyBiZWhhdmlvciBvZiBnZXR0aW5nIGFuZCBzZXR0aW5nIGEgc3R5bGUgcHJvcGVydHkKCWNzc0hvb2tzOiB7CgkJb3BhY2l0eTogewoJCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtLCBjb21wdXRlZCApIHsKCQkJCWlmICggY29tcHV0ZWQgKSB7CgkJCQkJLy8gV2Ugc2hvdWxkIGFsd2F5cyBnZXQgYSBudW1iZXIgYmFjayBmcm9tIG9wYWNpdHkKCQkJCQl2YXIgcmV0ID0gY3VyQ1NTKCBlbGVtLCAib3BhY2l0eSIgKTsKCQkJCQlyZXR1cm4gcmV0ID09PSAiIiA/ICIxIiA6IHJldDsKCQkJCX0KCQkJfQoJCX0KCX0sCgoJLy8gRG9uJ3QgYXV0b21hdGljYWxseSBhZGQgInB4IiB0byB0aGVzZSBwb3NzaWJseS11bml0bGVzcyBwcm9wZXJ0aWVzCgljc3NOdW1iZXI6IHsKCQkiY29sdW1uQ291bnQiOiB0cnVlLAoJCSJmaWxsT3BhY2l0eSI6IHRydWUsCgkJImZvbnRXZWlnaHQiOiB0cnVlLAoJCSJsaW5lSGVpZ2h0IjogdHJ1ZSwKCQkib3BhY2l0eSI6IHRydWUsCgkJIm9yZGVyIjogdHJ1ZSwKCQkib3JwaGFucyI6IHRydWUsCgkJIndpZG93cyI6IHRydWUsCgkJInpJbmRleCI6IHRydWUsCgkJInpvb20iOiB0cnVlCgl9LAoKCS8vIEFkZCBpbiBwcm9wZXJ0aWVzIHdob3NlIG5hbWVzIHlvdSB3aXNoIHRvIGZpeCBiZWZvcmUKCS8vIHNldHRpbmcgb3IgZ2V0dGluZyB0aGUgdmFsdWUKCWNzc1Byb3BzOiB7CgkJLy8gbm9ybWFsaXplIGZsb2F0IGNzcyBwcm9wZXJ0eQoJCSJmbG9hdCI6IHN1cHBvcnQuY3NzRmxvYXQgPyAiY3NzRmxvYXQiIDogInN0eWxlRmxvYXQiCgl9LAoKCS8vIEdldCBhbmQgc2V0IHRoZSBzdHlsZSBwcm9wZXJ0eSBvbiBhIERPTSBOb2RlCglzdHlsZTogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIHZhbHVlLCBleHRyYSApIHsKCQkvLyBEb24ndCBzZXQgc3R5bGVzIG9uIHRleHQgYW5kIGNvbW1lbnQgbm9kZXMKCQlpZiAoICFlbGVtIHx8IGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gOCB8fCAhZWxlbS5zdHlsZSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gTWFrZSBzdXJlIHRoYXQgd2UncmUgd29ya2luZyB3aXRoIHRoZSByaWdodCBuYW1lCgkJdmFyIHJldCwgdHlwZSwgaG9va3MsCgkJCW9yaWdOYW1lID0galF1ZXJ5LmNhbWVsQ2FzZSggbmFtZSApLAoJCQlzdHlsZSA9IGVsZW0uc3R5bGU7CgoJCW5hbWUgPSBqUXVlcnkuY3NzUHJvcHNbIG9yaWdOYW1lIF0gfHwgKCBqUXVlcnkuY3NzUHJvcHNbIG9yaWdOYW1lIF0gPSB2ZW5kb3JQcm9wTmFtZSggc3R5bGUsIG9yaWdOYW1lICkgKTsKCgkJLy8gZ2V0cyBob29rIGZvciB0aGUgcHJlZml4ZWQgdmVyc2lvbgoJCS8vIGZvbGxvd2VkIGJ5IHRoZSB1bnByZWZpeGVkIHZlcnNpb24KCQlob29rcyA9IGpRdWVyeS5jc3NIb29rc1sgbmFtZSBdIHx8IGpRdWVyeS5jc3NIb29rc1sgb3JpZ05hbWUgXTsKCgkJLy8gQ2hlY2sgaWYgd2UncmUgc2V0dGluZyBhIHZhbHVlCgkJaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0eXBlID0gdHlwZW9mIHZhbHVlOwoKCQkJLy8gY29udmVydCByZWxhdGl2ZSBudW1iZXIgc3RyaW5ncyAoKz0gb3IgLT0pIHRvIHJlbGF0aXZlIG51bWJlcnMuICM3MzQ1CgkJCWlmICggdHlwZSA9PT0gInN0cmluZyIgJiYgKHJldCA9IHJyZWxOdW0uZXhlYyggdmFsdWUgKSkgKSB7CgkJCQl2YWx1ZSA9ICggcmV0WzFdICsgMSApICogcmV0WzJdICsgcGFyc2VGbG9hdCggalF1ZXJ5LmNzcyggZWxlbSwgbmFtZSApICk7CgkJCQkvLyBGaXhlcyBidWcgIzkyMzcKCQkJCXR5cGUgPSAibnVtYmVyIjsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHRoYXQgbnVsbCBhbmQgTmFOIHZhbHVlcyBhcmVuJ3Qgc2V0LiBTZWU6ICM3MTE2CgkJCWlmICggdmFsdWUgPT0gbnVsbCB8fCB2YWx1ZSAhPT0gdmFsdWUgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIGEgbnVtYmVyIHdhcyBwYXNzZWQgaW4sIGFkZCAncHgnIHRvIHRoZSAoZXhjZXB0IGZvciBjZXJ0YWluIENTUyBwcm9wZXJ0aWVzKQoJCQlpZiAoIHR5cGUgPT09ICJudW1iZXIiICYmICFqUXVlcnkuY3NzTnVtYmVyWyBvcmlnTmFtZSBdICkgewoJCQkJdmFsdWUgKz0gInB4IjsKCQkJfQoKCQkJLy8gRml4ZXMgIzg5MDgsIGl0IGNhbiBiZSBkb25lIG1vcmUgY29ycmVjdGx5IGJ5IHNwZWNpZmluZyBzZXR0ZXJzIGluIGNzc0hvb2tzLAoJCQkvLyBidXQgaXQgd291bGQgbWVhbiB0byBkZWZpbmUgZWlnaHQgKGZvciBldmVyeSBwcm9ibGVtYXRpYyBwcm9wZXJ0eSkgaWRlbnRpY2FsIGZ1bmN0aW9ucwoJCQlpZiAoICFzdXBwb3J0LmNsZWFyQ2xvbmVTdHlsZSAmJiB2YWx1ZSA9PT0gIiIgJiYgbmFtZS5pbmRleE9mKCJiYWNrZ3JvdW5kIikgPT09IDAgKSB7CgkJCQlzdHlsZVsgbmFtZSBdID0gImluaGVyaXQiOwoJCQl9CgoJCQkvLyBJZiBhIGhvb2sgd2FzIHByb3ZpZGVkLCB1c2UgdGhhdCB2YWx1ZSwgb3RoZXJ3aXNlIGp1c3Qgc2V0IHRoZSBzcGVjaWZpZWQgdmFsdWUKCQkJaWYgKCAhaG9va3MgfHwgISgic2V0IiBpbiBob29rcykgfHwgKHZhbHVlID0gaG9va3Muc2V0KCBlbGVtLCB2YWx1ZSwgZXh0cmEgKSkgIT09IHVuZGVmaW5lZCApIHsKCgkJCQkvLyBTdXBwb3J0OiBJRQoJCQkJLy8gU3dhbGxvdyBlcnJvcnMgZnJvbSAnaW52YWxpZCcgQ1NTIHZhbHVlcyAoIzU1MDkpCgkJCQl0cnkgewoJCQkJCS8vIFN1cHBvcnQ6IENocm9tZSwgU2FmYXJpCgkJCQkJLy8gU2V0dGluZyBzdHlsZSB0byBibGFuayBzdHJpbmcgcmVxdWlyZWQgdG8gZGVsZXRlICJzdHlsZTogeCAhaW1wb3J0YW50OyIKCQkJCQlzdHlsZVsgbmFtZSBdID0gIiI7CgkJCQkJc3R5bGVbIG5hbWUgXSA9IHZhbHVlOwoJCQkJfSBjYXRjaChlKSB7fQoJCQl9CgoJCX0gZWxzZSB7CgkJCS8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQgZ2V0IHRoZSBub24tY29tcHV0ZWQgdmFsdWUgZnJvbSB0aGVyZQoJCQlpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoIGVsZW0sIGZhbHNlLCBleHRyYSApKSAhPT0gdW5kZWZpbmVkICkgewoJCQkJcmV0dXJuIHJldDsKCQkJfQoKCQkJLy8gT3RoZXJ3aXNlIGp1c3QgZ2V0IHRoZSB2YWx1ZSBmcm9tIHRoZSBzdHlsZSBvYmplY3QKCQkJcmV0dXJuIHN0eWxlWyBuYW1lIF07CgkJfQoJfSwKCgljc3M6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBleHRyYSwgc3R5bGVzICkgewoJCXZhciBudW0sIHZhbCwgaG9va3MsCgkJCW9yaWdOYW1lID0galF1ZXJ5LmNhbWVsQ2FzZSggbmFtZSApOwoKCQkvLyBNYWtlIHN1cmUgdGhhdCB3ZSdyZSB3b3JraW5nIHdpdGggdGhlIHJpZ2h0IG5hbWUKCQluYW1lID0galF1ZXJ5LmNzc1Byb3BzWyBvcmlnTmFtZSBdIHx8ICggalF1ZXJ5LmNzc1Byb3BzWyBvcmlnTmFtZSBdID0gdmVuZG9yUHJvcE5hbWUoIGVsZW0uc3R5bGUsIG9yaWdOYW1lICkgKTsKCgkJLy8gZ2V0cyBob29rIGZvciB0aGUgcHJlZml4ZWQgdmVyc2lvbgoJCS8vIGZvbGxvd2VkIGJ5IHRoZSB1bnByZWZpeGVkIHZlcnNpb24KCQlob29rcyA9IGpRdWVyeS5jc3NIb29rc1sgbmFtZSBdIHx8IGpRdWVyeS5jc3NIb29rc1sgb3JpZ05hbWUgXTsKCgkJLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCBnZXQgdGhlIGNvbXB1dGVkIHZhbHVlIGZyb20gdGhlcmUKCQlpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICkgewoJCQl2YWwgPSBob29rcy5nZXQoIGVsZW0sIHRydWUsIGV4dHJhICk7CgkJfQoKCQkvLyBPdGhlcndpc2UsIGlmIGEgd2F5IHRvIGdldCB0aGUgY29tcHV0ZWQgdmFsdWUgZXhpc3RzLCB1c2UgdGhhdAoJCWlmICggdmFsID09PSB1bmRlZmluZWQgKSB7CgkJCXZhbCA9IGN1ckNTUyggZWxlbSwgbmFtZSwgc3R5bGVzICk7CgkJfQoKCQkvL2NvbnZlcnQgIm5vcm1hbCIgdG8gY29tcHV0ZWQgdmFsdWUKCQlpZiAoIHZhbCA9PT0gIm5vcm1hbCIgJiYgbmFtZSBpbiBjc3NOb3JtYWxUcmFuc2Zvcm0gKSB7CgkJCXZhbCA9IGNzc05vcm1hbFRyYW5zZm9ybVsgbmFtZSBdOwoJCX0KCgkJLy8gUmV0dXJuLCBjb252ZXJ0aW5nIHRvIG51bWJlciBpZiBmb3JjZWQgb3IgYSBxdWFsaWZpZXIgd2FzIHByb3ZpZGVkIGFuZCB2YWwgbG9va3MgbnVtZXJpYwoJCWlmICggZXh0cmEgPT09ICIiIHx8IGV4dHJhICkgewoJCQludW0gPSBwYXJzZUZsb2F0KCB2YWwgKTsKCQkJcmV0dXJuIGV4dHJhID09PSB0cnVlIHx8IGpRdWVyeS5pc051bWVyaWMoIG51bSApID8gbnVtIHx8IDAgOiB2YWw7CgkJfQoJCXJldHVybiB2YWw7Cgl9Cn0pOwoKalF1ZXJ5LmVhY2goWyAiaGVpZ2h0IiwgIndpZHRoIiBdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCWpRdWVyeS5jc3NIb29rc1sgbmFtZSBdID0gewoJCWdldDogZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkLCBleHRyYSApIHsKCQkJaWYgKCBjb21wdXRlZCApIHsKCQkJCS8vIGNlcnRhaW4gZWxlbWVudHMgY2FuIGhhdmUgZGltZW5zaW9uIGluZm8gaWYgd2UgaW52aXNpYmx5IHNob3cgdGhlbQoJCQkJLy8gaG93ZXZlciwgaXQgbXVzdCBoYXZlIGEgY3VycmVudCBkaXNwbGF5IHN0eWxlIHRoYXQgd291bGQgYmVuZWZpdCBmcm9tIHRoaXMKCQkJCXJldHVybiBlbGVtLm9mZnNldFdpZHRoID09PSAwICYmIHJkaXNwbGF5c3dhcC50ZXN0KCBqUXVlcnkuY3NzKCBlbGVtLCAiZGlzcGxheSIgKSApID8KCQkJCQlqUXVlcnkuc3dhcCggZWxlbSwgY3NzU2hvdywgZnVuY3Rpb24oKSB7CgkJCQkJCXJldHVybiBnZXRXaWR0aE9ySGVpZ2h0KCBlbGVtLCBuYW1lLCBleHRyYSApOwoJCQkJCX0pIDoKCQkJCQlnZXRXaWR0aE9ySGVpZ2h0KCBlbGVtLCBuYW1lLCBleHRyYSApOwoJCQl9CgkJfSwKCgkJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUsIGV4dHJhICkgewoJCQl2YXIgc3R5bGVzID0gZXh0cmEgJiYgZ2V0U3R5bGVzKCBlbGVtICk7CgkJCXJldHVybiBzZXRQb3NpdGl2ZU51bWJlciggZWxlbSwgdmFsdWUsIGV4dHJhID8KCQkJCWF1Z21lbnRXaWR0aE9ySGVpZ2h0KAoJCQkJCWVsZW0sCgkJCQkJbmFtZSwKCQkJCQlleHRyYSwKCQkJCQlzdXBwb3J0LmJveFNpemluZygpICYmIGpRdWVyeS5jc3MoIGVsZW0sICJib3hTaXppbmciLCBmYWxzZSwgc3R5bGVzICkgPT09ICJib3JkZXItYm94IiwKCQkJCQlzdHlsZXMKCQkJCSkgOiAwCgkJCSk7CgkJfQoJfTsKfSk7CgppZiAoICFzdXBwb3J0Lm9wYWNpdHkgKSB7CglqUXVlcnkuY3NzSG9va3Mub3BhY2l0eSA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtLCBjb21wdXRlZCApIHsKCQkJLy8gSUUgdXNlcyBmaWx0ZXJzIGZvciBvcGFjaXR5CgkJCXJldHVybiByb3BhY2l0eS50ZXN0KCAoY29tcHV0ZWQgJiYgZWxlbS5jdXJyZW50U3R5bGUgPyBlbGVtLmN1cnJlbnRTdHlsZS5maWx0ZXIgOiBlbGVtLnN0eWxlLmZpbHRlcikgfHwgIiIgKSA/CgkJCQkoIDAuMDEgKiBwYXJzZUZsb2F0KCBSZWdFeHAuJDEgKSApICsgIiIgOgoJCQkJY29tcHV0ZWQgPyAiMSIgOiAiIjsKCQl9LAoKCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQkJdmFyIHN0eWxlID0gZWxlbS5zdHlsZSwKCQkJCWN1cnJlbnRTdHlsZSA9IGVsZW0uY3VycmVudFN0eWxlLAoJCQkJb3BhY2l0eSA9IGpRdWVyeS5pc051bWVyaWMoIHZhbHVlICkgPyAiYWxwaGEob3BhY2l0eT0iICsgdmFsdWUgKiAxMDAgKyAiKSIgOiAiIiwKCQkJCWZpbHRlciA9IGN1cnJlbnRTdHlsZSAmJiBjdXJyZW50U3R5bGUuZmlsdGVyIHx8IHN0eWxlLmZpbHRlciB8fCAiIjsKCgkJCS8vIElFIGhhcyB0cm91YmxlIHdpdGggb3BhY2l0eSBpZiBpdCBkb2VzIG5vdCBoYXZlIGxheW91dAoJCQkvLyBGb3JjZSBpdCBieSBzZXR0aW5nIHRoZSB6b29tIGxldmVsCgkJCXN0eWxlLnpvb20gPSAxOwoKCQkJLy8gaWYgc2V0dGluZyBvcGFjaXR5IHRvIDEsIGFuZCBubyBvdGhlciBmaWx0ZXJzIGV4aXN0IC0gYXR0ZW1wdCB0byByZW1vdmUgZmlsdGVyIGF0dHJpYnV0ZSAjNjY1MgoJCQkvLyBpZiB2YWx1ZSA9PT0gIiIsIHRoZW4gcmVtb3ZlIGlubGluZSBvcGFjaXR5ICMxMjY4NQoJCQlpZiAoICggdmFsdWUgPj0gMSB8fCB2YWx1ZSA9PT0gIiIgKSAmJgoJCQkJCWpRdWVyeS50cmltKCBmaWx0ZXIucmVwbGFjZSggcmFscGhhLCAiIiApICkgPT09ICIiICYmCgkJCQkJc3R5bGUucmVtb3ZlQXR0cmlidXRlICkgewoKCQkJCS8vIFNldHRpbmcgc3R5bGUuZmlsdGVyIHRvIG51bGwsICIiICYgIiAiIHN0aWxsIGxlYXZlICJmaWx0ZXI6IiBpbiB0aGUgY3NzVGV4dAoJCQkJLy8gaWYgImZpbHRlcjoiIGlzIHByZXNlbnQgYXQgYWxsLCBjbGVhclR5cGUgaXMgZGlzYWJsZWQsIHdlIHdhbnQgdG8gYXZvaWQgdGhpcwoJCQkJLy8gc3R5bGUucmVtb3ZlQXR0cmlidXRlIGlzIElFIE9ubHksIGJ1dCBzbyBhcHBhcmVudGx5IGlzIHRoaXMgY29kZSBwYXRoLi4uCgkJCQlzdHlsZS5yZW1vdmVBdHRyaWJ1dGUoICJmaWx0ZXIiICk7CgoJCQkJLy8gaWYgdGhlcmUgaXMgbm8gZmlsdGVyIHN0eWxlIGFwcGxpZWQgaW4gYSBjc3MgcnVsZSBvciB1bnNldCBpbmxpbmUgb3BhY2l0eSwgd2UgYXJlIGRvbmUKCQkJCWlmICggdmFsdWUgPT09ICIiIHx8IGN1cnJlbnRTdHlsZSAmJiAhY3VycmVudFN0eWxlLmZpbHRlciApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCgkJCS8vIG90aGVyd2lzZSwgc2V0IG5ldyBmaWx0ZXIgdmFsdWVzCgkJCXN0eWxlLmZpbHRlciA9IHJhbHBoYS50ZXN0KCBmaWx0ZXIgKSA/CgkJCQlmaWx0ZXIucmVwbGFjZSggcmFscGhhLCBvcGFjaXR5ICkgOgoJCQkJZmlsdGVyICsgIiAiICsgb3BhY2l0eTsKCQl9Cgl9Owp9CgpqUXVlcnkuY3NzSG9va3MubWFyZ2luUmlnaHQgPSBhZGRHZXRIb29rSWYoIHN1cHBvcnQucmVsaWFibGVNYXJnaW5SaWdodCwKCWZ1bmN0aW9uKCBlbGVtLCBjb21wdXRlZCApIHsKCQlpZiAoIGNvbXB1dGVkICkgewoJCQkvLyBXZWJLaXQgQnVnIDEzMzQzIC0gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHdyb25nIHZhbHVlIGZvciBtYXJnaW4tcmlnaHQKCQkJLy8gV29yayBhcm91bmQgYnkgdGVtcG9yYXJpbHkgc2V0dGluZyBlbGVtZW50IGRpc3BsYXkgdG8gaW5saW5lLWJsb2NrCgkJCXJldHVybiBqUXVlcnkuc3dhcCggZWxlbSwgeyAiZGlzcGxheSI6ICJpbmxpbmUtYmxvY2siIH0sCgkJCQljdXJDU1MsIFsgZWxlbSwgIm1hcmdpblJpZ2h0IiBdICk7CgkJfQoJfQopOwoKLy8gVGhlc2UgaG9va3MgYXJlIHVzZWQgYnkgYW5pbWF0ZSB0byBleHBhbmQgcHJvcGVydGllcwpqUXVlcnkuZWFjaCh7CgltYXJnaW46ICIiLAoJcGFkZGluZzogIiIsCglib3JkZXI6ICJXaWR0aCIKfSwgZnVuY3Rpb24oIHByZWZpeCwgc3VmZml4ICkgewoJalF1ZXJ5LmNzc0hvb2tzWyBwcmVmaXggKyBzdWZmaXggXSA9IHsKCQlleHBhbmQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdmFyIGkgPSAwLAoJCQkJZXhwYW5kZWQgPSB7fSwKCgkJCQkvLyBhc3N1bWVzIGEgc2luZ2xlIG51bWJlciBpZiBub3QgYSBzdHJpbmcKCQkJCXBhcnRzID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlLnNwbGl0KCIgIikgOiBbIHZhbHVlIF07CgoJCQlmb3IgKCA7IGkgPCA0OyBpKysgKSB7CgkJCQlleHBhbmRlZFsgcHJlZml4ICsgY3NzRXhwYW5kWyBpIF0gKyBzdWZmaXggXSA9CgkJCQkJcGFydHNbIGkgXSB8fCBwYXJ0c1sgaSAtIDIgXSB8fCBwYXJ0c1sgMCBdOwoJCQl9CgoJCQlyZXR1cm4gZXhwYW5kZWQ7CgkJfQoJfTsKCglpZiAoICFybWFyZ2luLnRlc3QoIHByZWZpeCApICkgewoJCWpRdWVyeS5jc3NIb29rc1sgcHJlZml4ICsgc3VmZml4IF0uc2V0ID0gc2V0UG9zaXRpdmVOdW1iZXI7Cgl9Cn0pOwoKalF1ZXJ5LmZuLmV4dGVuZCh7Cgljc3M6IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsKCQlyZXR1cm4gYWNjZXNzKCB0aGlzLCBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUgKSB7CgkJCXZhciBzdHlsZXMsIGxlbiwKCQkJCW1hcCA9IHt9LAoJCQkJaSA9IDA7CgoJCQlpZiAoIGpRdWVyeS5pc0FycmF5KCBuYW1lICkgKSB7CgkJCQlzdHlsZXMgPSBnZXRTdHlsZXMoIGVsZW0gKTsKCQkJCWxlbiA9IG5hbWUubGVuZ3RoOwoKCQkJCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgewoJCQkJCW1hcFsgbmFtZVsgaSBdIF0gPSBqUXVlcnkuY3NzKCBlbGVtLCBuYW1lWyBpIF0sIGZhbHNlLCBzdHlsZXMgKTsKCQkJCX0KCgkJCQlyZXR1cm4gbWFwOwoJCQl9CgoJCQlyZXR1cm4gdmFsdWUgIT09IHVuZGVmaW5lZCA/CgkJCQlqUXVlcnkuc3R5bGUoIGVsZW0sIG5hbWUsIHZhbHVlICkgOgoJCQkJalF1ZXJ5LmNzcyggZWxlbSwgbmFtZSApOwoJCX0sIG5hbWUsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSApOwoJfSwKCXNob3c6IGZ1bmN0aW9uKCkgewoJCXJldHVybiBzaG93SGlkZSggdGhpcywgdHJ1ZSApOwoJfSwKCWhpZGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiBzaG93SGlkZSggdGhpcyApOwoJfSwKCXRvZ2dsZTogZnVuY3Rpb24oIHN0YXRlICkgewoJCWlmICggdHlwZW9mIHN0YXRlID09PSAiYm9vbGVhbiIgKSB7CgkJCXJldHVybiBzdGF0ZSA/IHRoaXMuc2hvdygpIDogdGhpcy5oaWRlKCk7CgkJfQoKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoIGlzSGlkZGVuKCB0aGlzICkgKSB7CgkJCQlqUXVlcnkoIHRoaXMgKS5zaG93KCk7CgkJCX0gZWxzZSB7CgkJCQlqUXVlcnkoIHRoaXMgKS5oaWRlKCk7CgkJCX0KCQl9KTsKCX0KfSk7CgoKZnVuY3Rpb24gVHdlZW4oIGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nICkgewoJcmV0dXJuIG5ldyBUd2Vlbi5wcm90b3R5cGUuaW5pdCggZWxlbSwgb3B0aW9ucywgcHJvcCwgZW5kLCBlYXNpbmcgKTsKfQpqUXVlcnkuVHdlZW4gPSBUd2VlbjsKClR3ZWVuLnByb3RvdHlwZSA9IHsKCWNvbnN0cnVjdG9yOiBUd2VlbiwKCWluaXQ6IGZ1bmN0aW9uKCBlbGVtLCBvcHRpb25zLCBwcm9wLCBlbmQsIGVhc2luZywgdW5pdCApIHsKCQl0aGlzLmVsZW0gPSBlbGVtOwoJCXRoaXMucHJvcCA9IHByb3A7CgkJdGhpcy5lYXNpbmcgPSBlYXNpbmcgfHwgInN3aW5nIjsKCQl0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwoJCXRoaXMuc3RhcnQgPSB0aGlzLm5vdyA9IHRoaXMuY3VyKCk7CgkJdGhpcy5lbmQgPSBlbmQ7CgkJdGhpcy51bml0ID0gdW5pdCB8fCAoIGpRdWVyeS5jc3NOdW1iZXJbIHByb3AgXSA/ICIiIDogInB4IiApOwoJfSwKCWN1cjogZnVuY3Rpb24oKSB7CgkJdmFyIGhvb2tzID0gVHdlZW4ucHJvcEhvb2tzWyB0aGlzLnByb3AgXTsKCgkJcmV0dXJuIGhvb2tzICYmIGhvb2tzLmdldCA/CgkJCWhvb2tzLmdldCggdGhpcyApIDoKCQkJVHdlZW4ucHJvcEhvb2tzLl9kZWZhdWx0LmdldCggdGhpcyApOwoJfSwKCXJ1bjogZnVuY3Rpb24oIHBlcmNlbnQgKSB7CgkJdmFyIGVhc2VkLAoJCQlob29rcyA9IFR3ZWVuLnByb3BIb29rc1sgdGhpcy5wcm9wIF07CgoJCWlmICggdGhpcy5vcHRpb25zLmR1cmF0aW9uICkgewoJCQl0aGlzLnBvcyA9IGVhc2VkID0galF1ZXJ5LmVhc2luZ1sgdGhpcy5lYXNpbmcgXSgKCQkJCXBlcmNlbnQsIHRoaXMub3B0aW9ucy5kdXJhdGlvbiAqIHBlcmNlbnQsIDAsIDEsIHRoaXMub3B0aW9ucy5kdXJhdGlvbgoJCQkpOwoJCX0gZWxzZSB7CgkJCXRoaXMucG9zID0gZWFzZWQgPSBwZXJjZW50OwoJCX0KCQl0aGlzLm5vdyA9ICggdGhpcy5lbmQgLSB0aGlzLnN0YXJ0ICkgKiBlYXNlZCArIHRoaXMuc3RhcnQ7CgoJCWlmICggdGhpcy5vcHRpb25zLnN0ZXAgKSB7CgkJCXRoaXMub3B0aW9ucy5zdGVwLmNhbGwoIHRoaXMuZWxlbSwgdGhpcy5ub3csIHRoaXMgKTsKCQl9CgoJCWlmICggaG9va3MgJiYgaG9va3Muc2V0ICkgewoJCQlob29rcy5zZXQoIHRoaXMgKTsKCQl9IGVsc2UgewoJCQlUd2Vlbi5wcm9wSG9va3MuX2RlZmF1bHQuc2V0KCB0aGlzICk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQp9OwoKVHdlZW4ucHJvdG90eXBlLmluaXQucHJvdG90eXBlID0gVHdlZW4ucHJvdG90eXBlOwoKVHdlZW4ucHJvcEhvb2tzID0gewoJX2RlZmF1bHQ6IHsKCQlnZXQ6IGZ1bmN0aW9uKCB0d2VlbiApIHsKCQkJdmFyIHJlc3VsdDsKCgkJCWlmICggdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdICE9IG51bGwgJiYKCQkJCSghdHdlZW4uZWxlbS5zdHlsZSB8fCB0d2Vlbi5lbGVtLnN0eWxlWyB0d2Vlbi5wcm9wIF0gPT0gbnVsbCkgKSB7CgkJCQlyZXR1cm4gdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdOwoJCQl9CgoJCQkvLyBwYXNzaW5nIGFuIGVtcHR5IHN0cmluZyBhcyBhIDNyZCBwYXJhbWV0ZXIgdG8gLmNzcyB3aWxsIGF1dG9tYXRpY2FsbHkKCQkJLy8gYXR0ZW1wdCBhIHBhcnNlRmxvYXQgYW5kIGZhbGxiYWNrIHRvIGEgc3RyaW5nIGlmIHRoZSBwYXJzZSBmYWlscwoJCQkvLyBzbywgc2ltcGxlIHZhbHVlcyBzdWNoIGFzICIxMHB4IiBhcmUgcGFyc2VkIHRvIEZsb2F0LgoJCQkvLyBjb21wbGV4IHZhbHVlcyBzdWNoIGFzICJyb3RhdGUoMXJhZCkiIGFyZSByZXR1cm5lZCBhcyBpcy4KCQkJcmVzdWx0ID0galF1ZXJ5LmNzcyggdHdlZW4uZWxlbSwgdHdlZW4ucHJvcCwgIiIgKTsKCQkJLy8gRW1wdHkgc3RyaW5ncywgbnVsbCwgdW5kZWZpbmVkIGFuZCAiYXV0byIgYXJlIGNvbnZlcnRlZCB0byAwLgoJCQlyZXR1cm4gIXJlc3VsdCB8fCByZXN1bHQgPT09ICJhdXRvIiA/IDAgOiByZXN1bHQ7CgkJfSwKCQlzZXQ6IGZ1bmN0aW9uKCB0d2VlbiApIHsKCQkJLy8gdXNlIHN0ZXAgaG9vayBmb3IgYmFjayBjb21wYXQgLSB1c2UgY3NzSG9vayBpZiBpdHMgdGhlcmUgLSB1c2UgLnN0eWxlIGlmIGl0cwoJCQkvLyBhdmFpbGFibGUgYW5kIHVzZSBwbGFpbiBwcm9wZXJ0aWVzIHdoZXJlIGF2YWlsYWJsZQoJCQlpZiAoIGpRdWVyeS5meC5zdGVwWyB0d2Vlbi5wcm9wIF0gKSB7CgkJCQlqUXVlcnkuZnguc3RlcFsgdHdlZW4ucHJvcCBdKCB0d2VlbiApOwoJCQl9IGVsc2UgaWYgKCB0d2Vlbi5lbGVtLnN0eWxlICYmICggdHdlZW4uZWxlbS5zdHlsZVsgalF1ZXJ5LmNzc1Byb3BzWyB0d2Vlbi5wcm9wIF0gXSAhPSBudWxsIHx8IGpRdWVyeS5jc3NIb29rc1sgdHdlZW4ucHJvcCBdICkgKSB7CgkJCQlqUXVlcnkuc3R5bGUoIHR3ZWVuLmVsZW0sIHR3ZWVuLnByb3AsIHR3ZWVuLm5vdyArIHR3ZWVuLnVuaXQgKTsKCQkJfSBlbHNlIHsKCQkJCXR3ZWVuLmVsZW1bIHR3ZWVuLnByb3AgXSA9IHR3ZWVuLm5vdzsKCQkJfQoJCX0KCX0KfTsKCi8vIFN1cHBvcnQ6IElFIDw9OQovLyBQYW5pYyBiYXNlZCBhcHByb2FjaCB0byBzZXR0aW5nIHRoaW5ncyBvbiBkaXNjb25uZWN0ZWQgbm9kZXMKClR3ZWVuLnByb3BIb29rcy5zY3JvbGxUb3AgPSBUd2Vlbi5wcm9wSG9va3Muc2Nyb2xsTGVmdCA9IHsKCXNldDogZnVuY3Rpb24oIHR3ZWVuICkgewoJCWlmICggdHdlZW4uZWxlbS5ub2RlVHlwZSAmJiB0d2Vlbi5lbGVtLnBhcmVudE5vZGUgKSB7CgkJCXR3ZWVuLmVsZW1bIHR3ZWVuLnByb3AgXSA9IHR3ZWVuLm5vdzsKCQl9Cgl9Cn07CgpqUXVlcnkuZWFzaW5nID0gewoJbGluZWFyOiBmdW5jdGlvbiggcCApIHsKCQlyZXR1cm4gcDsKCX0sCglzd2luZzogZnVuY3Rpb24oIHAgKSB7CgkJcmV0dXJuIDAuNSAtIE1hdGguY29zKCBwICogTWF0aC5QSSApIC8gMjsKCX0KfTsKCmpRdWVyeS5meCA9IFR3ZWVuLnByb3RvdHlwZS5pbml0OwoKLy8gQmFjayBDb21wYXQgPDEuOCBleHRlbnNpb24gcG9pbnQKalF1ZXJ5LmZ4LnN0ZXAgPSB7fTsKCgoKCnZhcgoJZnhOb3csIHRpbWVySWQsCglyZnh0eXBlcyA9IC9eKD86dG9nZ2xlfHNob3d8aGlkZSkkLywKCXJmeG51bSA9IG5ldyBSZWdFeHAoICJeKD86KFsrLV0pPXwpKCIgKyBwbnVtICsgIikoW2EteiVdKikkIiwgImkiICksCglycnVuID0gL3F1ZXVlSG9va3MkLywKCWFuaW1hdGlvblByZWZpbHRlcnMgPSBbIGRlZmF1bHRQcmVmaWx0ZXIgXSwKCXR3ZWVuZXJzID0gewoJCSIqIjogWyBmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7CgkJCXZhciB0d2VlbiA9IHRoaXMuY3JlYXRlVHdlZW4oIHByb3AsIHZhbHVlICksCgkJCQl0YXJnZXQgPSB0d2Vlbi5jdXIoKSwKCQkJCXBhcnRzID0gcmZ4bnVtLmV4ZWMoIHZhbHVlICksCgkJCQl1bml0ID0gcGFydHMgJiYgcGFydHNbIDMgXSB8fCAoIGpRdWVyeS5jc3NOdW1iZXJbIHByb3AgXSA/ICIiIDogInB4IiApLAoKCQkJCS8vIFN0YXJ0aW5nIHZhbHVlIGNvbXB1dGF0aW9uIGlzIHJlcXVpcmVkIGZvciBwb3RlbnRpYWwgdW5pdCBtaXNtYXRjaGVzCgkJCQlzdGFydCA9ICggalF1ZXJ5LmNzc051bWJlclsgcHJvcCBdIHx8IHVuaXQgIT09ICJweCIgJiYgK3RhcmdldCApICYmCgkJCQkJcmZ4bnVtLmV4ZWMoIGpRdWVyeS5jc3MoIHR3ZWVuLmVsZW0sIHByb3AgKSApLAoJCQkJc2NhbGUgPSAxLAoJCQkJbWF4SXRlcmF0aW9ucyA9IDIwOwoKCQkJaWYgKCBzdGFydCAmJiBzdGFydFsgMyBdICE9PSB1bml0ICkgewoJCQkJLy8gVHJ1c3QgdW5pdHMgcmVwb3J0ZWQgYnkgalF1ZXJ5LmNzcwoJCQkJdW5pdCA9IHVuaXQgfHwgc3RhcnRbIDMgXTsKCgkJCQkvLyBNYWtlIHN1cmUgd2UgdXBkYXRlIHRoZSB0d2VlbiBwcm9wZXJ0aWVzIGxhdGVyIG9uCgkJCQlwYXJ0cyA9IHBhcnRzIHx8IFtdOwoKCQkJCS8vIEl0ZXJhdGl2ZWx5IGFwcHJveGltYXRlIGZyb20gYSBub256ZXJvIHN0YXJ0aW5nIHBvaW50CgkJCQlzdGFydCA9ICt0YXJnZXQgfHwgMTsKCgkJCQlkbyB7CgkJCQkJLy8gSWYgcHJldmlvdXMgaXRlcmF0aW9uIHplcm9lZCBvdXQsIGRvdWJsZSB1bnRpbCB3ZSBnZXQgKnNvbWV0aGluZyoKCQkJCQkvLyBVc2UgYSBzdHJpbmcgZm9yIGRvdWJsaW5nIGZhY3RvciBzbyB3ZSBkb24ndCBhY2NpZGVudGFsbHkgc2VlIHNjYWxlIGFzIHVuY2hhbmdlZCBiZWxvdwoJCQkJCXNjYWxlID0gc2NhbGUgfHwgIi41IjsKCgkJCQkJLy8gQWRqdXN0IGFuZCBhcHBseQoJCQkJCXN0YXJ0ID0gc3RhcnQgLyBzY2FsZTsKCQkJCQlqUXVlcnkuc3R5bGUoIHR3ZWVuLmVsZW0sIHByb3AsIHN0YXJ0ICsgdW5pdCApOwoKCQkJCS8vIFVwZGF0ZSBzY2FsZSwgdG9sZXJhdGluZyB6ZXJvIG9yIE5hTiBmcm9tIHR3ZWVuLmN1cigpCgkJCQkvLyBBbmQgYnJlYWtpbmcgdGhlIGxvb3AgaWYgc2NhbGUgaXMgdW5jaGFuZ2VkIG9yIHBlcmZlY3QsIG9yIGlmIHdlJ3ZlIGp1c3QgaGFkIGVub3VnaAoJCQkJfSB3aGlsZSAoIHNjYWxlICE9PSAoc2NhbGUgPSB0d2Vlbi5jdXIoKSAvIHRhcmdldCkgJiYgc2NhbGUgIT09IDEgJiYgLS1tYXhJdGVyYXRpb25zICk7CgkJCX0KCgkJCS8vIFVwZGF0ZSB0d2VlbiBwcm9wZXJ0aWVzCgkJCWlmICggcGFydHMgKSB7CgkJCQlzdGFydCA9IHR3ZWVuLnN0YXJ0ID0gK3N0YXJ0IHx8ICt0YXJnZXQgfHwgMDsKCQkJCXR3ZWVuLnVuaXQgPSB1bml0OwoJCQkJLy8gSWYgYSArPS8tPSB0b2tlbiB3YXMgcHJvdmlkZWQsIHdlJ3JlIGRvaW5nIGEgcmVsYXRpdmUgYW5pbWF0aW9uCgkJCQl0d2Vlbi5lbmQgPSBwYXJ0c1sgMSBdID8KCQkJCQlzdGFydCArICggcGFydHNbIDEgXSArIDEgKSAqIHBhcnRzWyAyIF0gOgoJCQkJCStwYXJ0c1sgMiBdOwoJCQl9CgoJCQlyZXR1cm4gdHdlZW47CgkJfSBdCgl9OwoKLy8gQW5pbWF0aW9ucyBjcmVhdGVkIHN5bmNocm9ub3VzbHkgd2lsbCBydW4gc3luY2hyb25vdXNseQpmdW5jdGlvbiBjcmVhdGVGeE5vdygpIHsKCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJZnhOb3cgPSB1bmRlZmluZWQ7Cgl9KTsKCXJldHVybiAoIGZ4Tm93ID0galF1ZXJ5Lm5vdygpICk7Cn0KCi8vIEdlbmVyYXRlIHBhcmFtZXRlcnMgdG8gY3JlYXRlIGEgc3RhbmRhcmQgYW5pbWF0aW9uCmZ1bmN0aW9uIGdlbkZ4KCB0eXBlLCBpbmNsdWRlV2lkdGggKSB7Cgl2YXIgd2hpY2gsCgkJYXR0cnMgPSB7IGhlaWdodDogdHlwZSB9LAoJCWkgPSAwOwoKCS8vIGlmIHdlIGluY2x1ZGUgd2lkdGgsIHN0ZXAgdmFsdWUgaXMgMSB0byBkbyBhbGwgY3NzRXhwYW5kIHZhbHVlcywKCS8vIGlmIHdlIGRvbid0IGluY2x1ZGUgd2lkdGgsIHN0ZXAgdmFsdWUgaXMgMiB0byBza2lwIG92ZXIgTGVmdCBhbmQgUmlnaHQKCWluY2x1ZGVXaWR0aCA9IGluY2x1ZGVXaWR0aCA/IDEgOiAwOwoJZm9yICggOyBpIDwgNCA7IGkgKz0gMiAtIGluY2x1ZGVXaWR0aCApIHsKCQl3aGljaCA9IGNzc0V4cGFuZFsgaSBdOwoJCWF0dHJzWyAibWFyZ2luIiArIHdoaWNoIF0gPSBhdHRyc1sgInBhZGRpbmciICsgd2hpY2ggXSA9IHR5cGU7Cgl9CgoJaWYgKCBpbmNsdWRlV2lkdGggKSB7CgkJYXR0cnMub3BhY2l0eSA9IGF0dHJzLndpZHRoID0gdHlwZTsKCX0KCglyZXR1cm4gYXR0cnM7Cn0KCmZ1bmN0aW9uIGNyZWF0ZVR3ZWVuKCB2YWx1ZSwgcHJvcCwgYW5pbWF0aW9uICkgewoJdmFyIHR3ZWVuLAoJCWNvbGxlY3Rpb24gPSAoIHR3ZWVuZXJzWyBwcm9wIF0gfHwgW10gKS5jb25jYXQoIHR3ZWVuZXJzWyAiKiIgXSApLAoJCWluZGV4ID0gMCwKCQlsZW5ndGggPSBjb2xsZWN0aW9uLmxlbmd0aDsKCWZvciAoIDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7CgkJaWYgKCAodHdlZW4gPSBjb2xsZWN0aW9uWyBpbmRleCBdLmNhbGwoIGFuaW1hdGlvbiwgcHJvcCwgdmFsdWUgKSkgKSB7CgoJCQkvLyB3ZSdyZSBkb25lIHdpdGggdGhpcyBwcm9wZXJ0eQoJCQlyZXR1cm4gdHdlZW47CgkJfQoJfQp9CgpmdW5jdGlvbiBkZWZhdWx0UHJlZmlsdGVyKCBlbGVtLCBwcm9wcywgb3B0cyApIHsKCS8qIGpzaGludCB2YWxpZHRoaXM6IHRydWUgKi8KCXZhciBwcm9wLCB2YWx1ZSwgdG9nZ2xlLCB0d2VlbiwgaG9va3MsIG9sZGZpcmUsIGRpc3BsYXksIGREaXNwbGF5LAoJCWFuaW0gPSB0aGlzLAoJCW9yaWcgPSB7fSwKCQlzdHlsZSA9IGVsZW0uc3R5bGUsCgkJaGlkZGVuID0gZWxlbS5ub2RlVHlwZSAmJiBpc0hpZGRlbiggZWxlbSApLAoJCWRhdGFTaG93ID0galF1ZXJ5Ll9kYXRhKCBlbGVtLCAiZnhzaG93IiApOwoKCS8vIGhhbmRsZSBxdWV1ZTogZmFsc2UgcHJvbWlzZXMKCWlmICggIW9wdHMucXVldWUgKSB7CgkJaG9va3MgPSBqUXVlcnkuX3F1ZXVlSG9va3MoIGVsZW0sICJmeCIgKTsKCQlpZiAoIGhvb2tzLnVucXVldWVkID09IG51bGwgKSB7CgkJCWhvb2tzLnVucXVldWVkID0gMDsKCQkJb2xkZmlyZSA9IGhvb2tzLmVtcHR5LmZpcmU7CgkJCWhvb2tzLmVtcHR5LmZpcmUgPSBmdW5jdGlvbigpIHsKCQkJCWlmICggIWhvb2tzLnVucXVldWVkICkgewoJCQkJCW9sZGZpcmUoKTsKCQkJCX0KCQkJfTsKCQl9CgkJaG9va3MudW5xdWV1ZWQrKzsKCgkJYW5pbS5hbHdheXMoZnVuY3Rpb24oKSB7CgkJCS8vIGRvaW5nIHRoaXMgbWFrZXMgc3VyZSB0aGF0IHRoZSBjb21wbGV0ZSBoYW5kbGVyIHdpbGwgYmUgY2FsbGVkCgkJCS8vIGJlZm9yZSB0aGlzIGNvbXBsZXRlcwoJCQlhbmltLmFsd2F5cyhmdW5jdGlvbigpIHsKCQkJCWhvb2tzLnVucXVldWVkLS07CgkJCQlpZiAoICFqUXVlcnkucXVldWUoIGVsZW0sICJmeCIgKS5sZW5ndGggKSB7CgkJCQkJaG9va3MuZW1wdHkuZmlyZSgpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCX0KCgkvLyBoZWlnaHQvd2lkdGggb3ZlcmZsb3cgcGFzcwoJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICYmICggImhlaWdodCIgaW4gcHJvcHMgfHwgIndpZHRoIiBpbiBwcm9wcyApICkgewoJCS8vIE1ha2Ugc3VyZSB0aGF0IG5vdGhpbmcgc25lYWtzIG91dAoJCS8vIFJlY29yZCBhbGwgMyBvdmVyZmxvdyBhdHRyaWJ1dGVzIGJlY2F1c2UgSUUgZG9lcyBub3QKCQkvLyBjaGFuZ2UgdGhlIG92ZXJmbG93IGF0dHJpYnV0ZSB3aGVuIG92ZXJmbG93WCBhbmQKCQkvLyBvdmVyZmxvd1kgYXJlIHNldCB0byB0aGUgc2FtZSB2YWx1ZQoJCW9wdHMub3ZlcmZsb3cgPSBbIHN0eWxlLm92ZXJmbG93LCBzdHlsZS5vdmVyZmxvd1gsIHN0eWxlLm92ZXJmbG93WSBdOwoKCQkvLyBTZXQgZGlzcGxheSBwcm9wZXJ0eSB0byBpbmxpbmUtYmxvY2sgZm9yIGhlaWdodC93aWR0aAoJCS8vIGFuaW1hdGlvbnMgb24gaW5saW5lIGVsZW1lbnRzIHRoYXQgYXJlIGhhdmluZyB3aWR0aC9oZWlnaHQgYW5pbWF0ZWQKCQlkaXNwbGF5ID0galF1ZXJ5LmNzcyggZWxlbSwgImRpc3BsYXkiICk7CgkJZERpc3BsYXkgPSBkZWZhdWx0RGlzcGxheSggZWxlbS5ub2RlTmFtZSApOwoJCWlmICggZGlzcGxheSA9PT0gIm5vbmUiICkgewoJCQlkaXNwbGF5ID0gZERpc3BsYXk7CgkJfQoJCWlmICggZGlzcGxheSA9PT0gImlubGluZSIgJiYKCQkJCWpRdWVyeS5jc3MoIGVsZW0sICJmbG9hdCIgKSA9PT0gIm5vbmUiICkgewoKCQkJLy8gaW5saW5lLWxldmVsIGVsZW1lbnRzIGFjY2VwdCBpbmxpbmUtYmxvY2s7CgkJCS8vIGJsb2NrLWxldmVsIGVsZW1lbnRzIG5lZWQgdG8gYmUgaW5saW5lIHdpdGggbGF5b3V0CgkJCWlmICggIXN1cHBvcnQuaW5saW5lQmxvY2tOZWVkc0xheW91dCB8fCBkRGlzcGxheSA9PT0gImlubGluZSIgKSB7CgkJCQlzdHlsZS5kaXNwbGF5ID0gImlubGluZS1ibG9jayI7CgkJCX0gZWxzZSB7CgkJCQlzdHlsZS56b29tID0gMTsKCQkJfQoJCX0KCX0KCglpZiAoIG9wdHMub3ZlcmZsb3cgKSB7CgkJc3R5bGUub3ZlcmZsb3cgPSAiaGlkZGVuIjsKCQlpZiAoICFzdXBwb3J0LnNocmlua1dyYXBCbG9ja3MoKSApIHsKCQkJYW5pbS5hbHdheXMoZnVuY3Rpb24oKSB7CgkJCQlzdHlsZS5vdmVyZmxvdyA9IG9wdHMub3ZlcmZsb3dbIDAgXTsKCQkJCXN0eWxlLm92ZXJmbG93WCA9IG9wdHMub3ZlcmZsb3dbIDEgXTsKCQkJCXN0eWxlLm92ZXJmbG93WSA9IG9wdHMub3ZlcmZsb3dbIDIgXTsKCQkJfSk7CgkJfQoJfQoKCS8vIHNob3cvaGlkZSBwYXNzCglmb3IgKCBwcm9wIGluIHByb3BzICkgewoJCXZhbHVlID0gcHJvcHNbIHByb3AgXTsKCQlpZiAoIHJmeHR5cGVzLmV4ZWMoIHZhbHVlICkgKSB7CgkJCWRlbGV0ZSBwcm9wc1sgcHJvcCBdOwoJCQl0b2dnbGUgPSB0b2dnbGUgfHwgdmFsdWUgPT09ICJ0b2dnbGUiOwoJCQlpZiAoIHZhbHVlID09PSAoIGhpZGRlbiA/ICJoaWRlIiA6ICJzaG93IiApICkgewoKCQkJCS8vIElmIHRoZXJlIGlzIGRhdGFTaG93IGxlZnQgb3ZlciBmcm9tIGEgc3RvcHBlZCBoaWRlIG9yIHNob3cgYW5kIHdlIGFyZSBnb2luZyB0byBwcm9jZWVkIHdpdGggc2hvdywgd2Ugc2hvdWxkIHByZXRlbmQgdG8gYmUgaGlkZGVuCgkJCQlpZiAoIHZhbHVlID09PSAic2hvdyIgJiYgZGF0YVNob3cgJiYgZGF0YVNob3dbIHByb3AgXSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCWhpZGRlbiA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCWNvbnRpbnVlOwoJCQkJfQoJCQl9CgkJCW9yaWdbIHByb3AgXSA9IGRhdGFTaG93ICYmIGRhdGFTaG93WyBwcm9wIF0gfHwgalF1ZXJ5LnN0eWxlKCBlbGVtLCBwcm9wICk7CgkJfQoJfQoKCWlmICggIWpRdWVyeS5pc0VtcHR5T2JqZWN0KCBvcmlnICkgKSB7CgkJaWYgKCBkYXRhU2hvdyApIHsKCQkJaWYgKCAiaGlkZGVuIiBpbiBkYXRhU2hvdyApIHsKCQkJCWhpZGRlbiA9IGRhdGFTaG93LmhpZGRlbjsKCQkJfQoJCX0gZWxzZSB7CgkJCWRhdGFTaG93ID0galF1ZXJ5Ll9kYXRhKCBlbGVtLCAiZnhzaG93Iiwge30gKTsKCQl9CgoJCS8vIHN0b3JlIHN0YXRlIGlmIGl0cyB0b2dnbGUgLSBlbmFibGVzIC5zdG9wKCkudG9nZ2xlKCkgdG8gInJldmVyc2UiCgkJaWYgKCB0b2dnbGUgKSB7CgkJCWRhdGFTaG93LmhpZGRlbiA9ICFoaWRkZW47CgkJfQoJCWlmICggaGlkZGVuICkgewoJCQlqUXVlcnkoIGVsZW0gKS5zaG93KCk7CgkJfSBlbHNlIHsKCQkJYW5pbS5kb25lKGZ1bmN0aW9uKCkgewoJCQkJalF1ZXJ5KCBlbGVtICkuaGlkZSgpOwoJCQl9KTsKCQl9CgkJYW5pbS5kb25lKGZ1bmN0aW9uKCkgewoJCQl2YXIgcHJvcDsKCQkJalF1ZXJ5Ll9yZW1vdmVEYXRhKCBlbGVtLCAiZnhzaG93IiApOwoJCQlmb3IgKCBwcm9wIGluIG9yaWcgKSB7CgkJCQlqUXVlcnkuc3R5bGUoIGVsZW0sIHByb3AsIG9yaWdbIHByb3AgXSApOwoJCQl9CgkJfSk7CgkJZm9yICggcHJvcCBpbiBvcmlnICkgewoJCQl0d2VlbiA9IGNyZWF0ZVR3ZWVuKCBoaWRkZW4gPyBkYXRhU2hvd1sgcHJvcCBdIDogMCwgcHJvcCwgYW5pbSApOwoKCQkJaWYgKCAhKCBwcm9wIGluIGRhdGFTaG93ICkgKSB7CgkJCQlkYXRhU2hvd1sgcHJvcCBdID0gdHdlZW4uc3RhcnQ7CgkJCQlpZiAoIGhpZGRlbiApIHsKCQkJCQl0d2Vlbi5lbmQgPSB0d2Vlbi5zdGFydDsKCQkJCQl0d2Vlbi5zdGFydCA9IHByb3AgPT09ICJ3aWR0aCIgfHwgcHJvcCA9PT0gImhlaWdodCIgPyAxIDogMDsKCQkJCX0KCQkJfQoJCX0KCX0KfQoKZnVuY3Rpb24gcHJvcEZpbHRlciggcHJvcHMsIHNwZWNpYWxFYXNpbmcgKSB7Cgl2YXIgaW5kZXgsIG5hbWUsIGVhc2luZywgdmFsdWUsIGhvb2tzOwoKCS8vIGNhbWVsQ2FzZSwgc3BlY2lhbEVhc2luZyBhbmQgZXhwYW5kIGNzc0hvb2sgcGFzcwoJZm9yICggaW5kZXggaW4gcHJvcHMgKSB7CgkJbmFtZSA9IGpRdWVyeS5jYW1lbENhc2UoIGluZGV4ICk7CgkJZWFzaW5nID0gc3BlY2lhbEVhc2luZ1sgbmFtZSBdOwoJCXZhbHVlID0gcHJvcHNbIGluZGV4IF07CgkJaWYgKCBqUXVlcnkuaXNBcnJheSggdmFsdWUgKSApIHsKCQkJZWFzaW5nID0gdmFsdWVbIDEgXTsKCQkJdmFsdWUgPSBwcm9wc1sgaW5kZXggXSA9IHZhbHVlWyAwIF07CgkJfQoKCQlpZiAoIGluZGV4ICE9PSBuYW1lICkgewoJCQlwcm9wc1sgbmFtZSBdID0gdmFsdWU7CgkJCWRlbGV0ZSBwcm9wc1sgaW5kZXggXTsKCQl9CgoJCWhvb2tzID0galF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF07CgkJaWYgKCBob29rcyAmJiAiZXhwYW5kIiBpbiBob29rcyApIHsKCQkJdmFsdWUgPSBob29rcy5leHBhbmQoIHZhbHVlICk7CgkJCWRlbGV0ZSBwcm9wc1sgbmFtZSBdOwoKCQkJLy8gbm90IHF1aXRlICQuZXh0ZW5kLCB0aGlzIHdvbnQgb3ZlcndyaXRlIGtleXMgYWxyZWFkeSBwcmVzZW50LgoJCQkvLyBhbHNvIC0gcmV1c2luZyAnaW5kZXgnIGZyb20gYWJvdmUgYmVjYXVzZSB3ZSBoYXZlIHRoZSBjb3JyZWN0ICJuYW1lIgoJCQlmb3IgKCBpbmRleCBpbiB2YWx1ZSApIHsKCQkJCWlmICggISggaW5kZXggaW4gcHJvcHMgKSApIHsKCQkJCQlwcm9wc1sgaW5kZXggXSA9IHZhbHVlWyBpbmRleCBdOwoJCQkJCXNwZWNpYWxFYXNpbmdbIGluZGV4IF0gPSBlYXNpbmc7CgkJCQl9CgkJCX0KCQl9IGVsc2UgewoJCQlzcGVjaWFsRWFzaW5nWyBuYW1lIF0gPSBlYXNpbmc7CgkJfQoJfQp9CgpmdW5jdGlvbiBBbmltYXRpb24oIGVsZW0sIHByb3BlcnRpZXMsIG9wdGlvbnMgKSB7Cgl2YXIgcmVzdWx0LAoJCXN0b3BwZWQsCgkJaW5kZXggPSAwLAoJCWxlbmd0aCA9IGFuaW1hdGlvblByZWZpbHRlcnMubGVuZ3RoLAoJCWRlZmVycmVkID0galF1ZXJ5LkRlZmVycmVkKCkuYWx3YXlzKCBmdW5jdGlvbigpIHsKCQkJLy8gZG9uJ3QgbWF0Y2ggZWxlbSBpbiB0aGUgOmFuaW1hdGVkIHNlbGVjdG9yCgkJCWRlbGV0ZSB0aWNrLmVsZW07CgkJfSksCgkJdGljayA9IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHN0b3BwZWQgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQkJdmFyIGN1cnJlbnRUaW1lID0gZnhOb3cgfHwgY3JlYXRlRnhOb3coKSwKCQkJCXJlbWFpbmluZyA9IE1hdGgubWF4KCAwLCBhbmltYXRpb24uc3RhcnRUaW1lICsgYW5pbWF0aW9uLmR1cmF0aW9uIC0gY3VycmVudFRpbWUgKSwKCQkJCS8vIGFyY2hhaWMgY3Jhc2ggYnVnIHdvbid0IGFsbG93IHVzIHRvIHVzZSAxIC0gKCAwLjUgfHwgMCApICgjMTI0OTcpCgkJCQl0ZW1wID0gcmVtYWluaW5nIC8gYW5pbWF0aW9uLmR1cmF0aW9uIHx8IDAsCgkJCQlwZXJjZW50ID0gMSAtIHRlbXAsCgkJCQlpbmRleCA9IDAsCgkJCQlsZW5ndGggPSBhbmltYXRpb24udHdlZW5zLmxlbmd0aDsKCgkJCWZvciAoIDsgaW5kZXggPCBsZW5ndGggOyBpbmRleCsrICkgewoJCQkJYW5pbWF0aW9uLnR3ZWVuc1sgaW5kZXggXS5ydW4oIHBlcmNlbnQgKTsKCQkJfQoKCQkJZGVmZXJyZWQubm90aWZ5V2l0aCggZWxlbSwgWyBhbmltYXRpb24sIHBlcmNlbnQsIHJlbWFpbmluZyBdKTsKCgkJCWlmICggcGVyY2VudCA8IDEgJiYgbGVuZ3RoICkgewoJCQkJcmV0dXJuIHJlbWFpbmluZzsKCQkJfSBlbHNlIHsKCQkJCWRlZmVycmVkLnJlc29sdmVXaXRoKCBlbGVtLCBbIGFuaW1hdGlvbiBdICk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9LAoJCWFuaW1hdGlvbiA9IGRlZmVycmVkLnByb21pc2UoewoJCQllbGVtOiBlbGVtLAoJCQlwcm9wczogalF1ZXJ5LmV4dGVuZCgge30sIHByb3BlcnRpZXMgKSwKCQkJb3B0czogalF1ZXJ5LmV4dGVuZCggdHJ1ZSwgeyBzcGVjaWFsRWFzaW5nOiB7fSB9LCBvcHRpb25zICksCgkJCW9yaWdpbmFsUHJvcGVydGllczogcHJvcGVydGllcywKCQkJb3JpZ2luYWxPcHRpb25zOiBvcHRpb25zLAoJCQlzdGFydFRpbWU6IGZ4Tm93IHx8IGNyZWF0ZUZ4Tm93KCksCgkJCWR1cmF0aW9uOiBvcHRpb25zLmR1cmF0aW9uLAoJCQl0d2VlbnM6IFtdLAoJCQljcmVhdGVUd2VlbjogZnVuY3Rpb24oIHByb3AsIGVuZCApIHsKCQkJCXZhciB0d2VlbiA9IGpRdWVyeS5Ud2VlbiggZWxlbSwgYW5pbWF0aW9uLm9wdHMsIHByb3AsIGVuZCwKCQkJCQkJYW5pbWF0aW9uLm9wdHMuc3BlY2lhbEVhc2luZ1sgcHJvcCBdIHx8IGFuaW1hdGlvbi5vcHRzLmVhc2luZyApOwoJCQkJYW5pbWF0aW9uLnR3ZWVucy5wdXNoKCB0d2VlbiApOwoJCQkJcmV0dXJuIHR3ZWVuOwoJCQl9LAoJCQlzdG9wOiBmdW5jdGlvbiggZ290b0VuZCApIHsKCQkJCXZhciBpbmRleCA9IDAsCgkJCQkJLy8gaWYgd2UgYXJlIGdvaW5nIHRvIHRoZSBlbmQsIHdlIHdhbnQgdG8gcnVuIGFsbCB0aGUgdHdlZW5zCgkJCQkJLy8gb3RoZXJ3aXNlIHdlIHNraXAgdGhpcyBwYXJ0CgkJCQkJbGVuZ3RoID0gZ290b0VuZCA/IGFuaW1hdGlvbi50d2VlbnMubGVuZ3RoIDogMDsKCQkJCWlmICggc3RvcHBlZCApIHsKCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0KCQkJCXN0b3BwZWQgPSB0cnVlOwoJCQkJZm9yICggOyBpbmRleCA8IGxlbmd0aCA7IGluZGV4KysgKSB7CgkJCQkJYW5pbWF0aW9uLnR3ZWVuc1sgaW5kZXggXS5ydW4oIDEgKTsKCQkJCX0KCgkJCQkvLyByZXNvbHZlIHdoZW4gd2UgcGxheWVkIHRoZSBsYXN0IGZyYW1lCgkJCQkvLyBvdGhlcndpc2UsIHJlamVjdAoJCQkJaWYgKCBnb3RvRW5kICkgewoJCQkJCWRlZmVycmVkLnJlc29sdmVXaXRoKCBlbGVtLCBbIGFuaW1hdGlvbiwgZ290b0VuZCBdICk7CgkJCQl9IGVsc2UgewoJCQkJCWRlZmVycmVkLnJlamVjdFdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uLCBnb3RvRW5kIF0gKTsKCQkJCX0KCQkJCXJldHVybiB0aGlzOwoJCQl9CgkJfSksCgkJcHJvcHMgPSBhbmltYXRpb24ucHJvcHM7CgoJcHJvcEZpbHRlciggcHJvcHMsIGFuaW1hdGlvbi5vcHRzLnNwZWNpYWxFYXNpbmcgKTsKCglmb3IgKCA7IGluZGV4IDwgbGVuZ3RoIDsgaW5kZXgrKyApIHsKCQlyZXN1bHQgPSBhbmltYXRpb25QcmVmaWx0ZXJzWyBpbmRleCBdLmNhbGwoIGFuaW1hdGlvbiwgZWxlbSwgcHJvcHMsIGFuaW1hdGlvbi5vcHRzICk7CgkJaWYgKCByZXN1bHQgKSB7CgkJCXJldHVybiByZXN1bHQ7CgkJfQoJfQoKCWpRdWVyeS5tYXAoIHByb3BzLCBjcmVhdGVUd2VlbiwgYW5pbWF0aW9uICk7CgoJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggYW5pbWF0aW9uLm9wdHMuc3RhcnQgKSApIHsKCQlhbmltYXRpb24ub3B0cy5zdGFydC5jYWxsKCBlbGVtLCBhbmltYXRpb24gKTsKCX0KCglqUXVlcnkuZngudGltZXIoCgkJalF1ZXJ5LmV4dGVuZCggdGljaywgewoJCQllbGVtOiBlbGVtLAoJCQlhbmltOiBhbmltYXRpb24sCgkJCXF1ZXVlOiBhbmltYXRpb24ub3B0cy5xdWV1ZQoJCX0pCgkpOwoKCS8vIGF0dGFjaCBjYWxsYmFja3MgZnJvbSBvcHRpb25zCglyZXR1cm4gYW5pbWF0aW9uLnByb2dyZXNzKCBhbmltYXRpb24ub3B0cy5wcm9ncmVzcyApCgkJLmRvbmUoIGFuaW1hdGlvbi5vcHRzLmRvbmUsIGFuaW1hdGlvbi5vcHRzLmNvbXBsZXRlICkKCQkuZmFpbCggYW5pbWF0aW9uLm9wdHMuZmFpbCApCgkJLmFsd2F5cyggYW5pbWF0aW9uLm9wdHMuYWx3YXlzICk7Cn0KCmpRdWVyeS5BbmltYXRpb24gPSBqUXVlcnkuZXh0ZW5kKCBBbmltYXRpb24sIHsKCXR3ZWVuZXI6IGZ1bmN0aW9uKCBwcm9wcywgY2FsbGJhY2sgKSB7CgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggcHJvcHMgKSApIHsKCQkJY2FsbGJhY2sgPSBwcm9wczsKCQkJcHJvcHMgPSBbICIqIiBdOwoJCX0gZWxzZSB7CgkJCXByb3BzID0gcHJvcHMuc3BsaXQoIiAiKTsKCQl9CgoJCXZhciBwcm9wLAoJCQlpbmRleCA9IDAsCgkJCWxlbmd0aCA9IHByb3BzLmxlbmd0aDsKCgkJZm9yICggOyBpbmRleCA8IGxlbmd0aCA7IGluZGV4KysgKSB7CgkJCXByb3AgPSBwcm9wc1sgaW5kZXggXTsKCQkJdHdlZW5lcnNbIHByb3AgXSA9IHR3ZWVuZXJzWyBwcm9wIF0gfHwgW107CgkJCXR3ZWVuZXJzWyBwcm9wIF0udW5zaGlmdCggY2FsbGJhY2sgKTsKCQl9Cgl9LAoKCXByZWZpbHRlcjogZnVuY3Rpb24oIGNhbGxiYWNrLCBwcmVwZW5kICkgewoJCWlmICggcHJlcGVuZCApIHsKCQkJYW5pbWF0aW9uUHJlZmlsdGVycy51bnNoaWZ0KCBjYWxsYmFjayApOwoJCX0gZWxzZSB7CgkJCWFuaW1hdGlvblByZWZpbHRlcnMucHVzaCggY2FsbGJhY2sgKTsKCQl9Cgl9Cn0pOwoKalF1ZXJ5LnNwZWVkID0gZnVuY3Rpb24oIHNwZWVkLCBlYXNpbmcsIGZuICkgewoJdmFyIG9wdCA9IHNwZWVkICYmIHR5cGVvZiBzcGVlZCA9PT0gIm9iamVjdCIgPyBqUXVlcnkuZXh0ZW5kKCB7fSwgc3BlZWQgKSA6IHsKCQljb21wbGV0ZTogZm4gfHwgIWZuICYmIGVhc2luZyB8fAoJCQlqUXVlcnkuaXNGdW5jdGlvbiggc3BlZWQgKSAmJiBzcGVlZCwKCQlkdXJhdGlvbjogc3BlZWQsCgkJZWFzaW5nOiBmbiAmJiBlYXNpbmcgfHwgZWFzaW5nICYmICFqUXVlcnkuaXNGdW5jdGlvbiggZWFzaW5nICkgJiYgZWFzaW5nCgl9OwoKCW9wdC5kdXJhdGlvbiA9IGpRdWVyeS5meC5vZmYgPyAwIDogdHlwZW9mIG9wdC5kdXJhdGlvbiA9PT0gIm51bWJlciIgPyBvcHQuZHVyYXRpb24gOgoJCW9wdC5kdXJhdGlvbiBpbiBqUXVlcnkuZnguc3BlZWRzID8galF1ZXJ5LmZ4LnNwZWVkc1sgb3B0LmR1cmF0aW9uIF0gOiBqUXVlcnkuZnguc3BlZWRzLl9kZWZhdWx0OwoKCS8vIG5vcm1hbGl6ZSBvcHQucXVldWUgLSB0cnVlL3VuZGVmaW5lZC9udWxsIC0+ICJmeCIKCWlmICggb3B0LnF1ZXVlID09IG51bGwgfHwgb3B0LnF1ZXVlID09PSB0cnVlICkgewoJCW9wdC5xdWV1ZSA9ICJmeCI7Cgl9CgoJLy8gUXVldWVpbmcKCW9wdC5vbGQgPSBvcHQuY29tcGxldGU7CgoJb3B0LmNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggb3B0Lm9sZCApICkgewoJCQlvcHQub2xkLmNhbGwoIHRoaXMgKTsKCQl9CgoJCWlmICggb3B0LnF1ZXVlICkgewoJCQlqUXVlcnkuZGVxdWV1ZSggdGhpcywgb3B0LnF1ZXVlICk7CgkJfQoJfTsKCglyZXR1cm4gb3B0Owp9OwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglmYWRlVG86IGZ1bmN0aW9uKCBzcGVlZCwgdG8sIGVhc2luZywgY2FsbGJhY2sgKSB7CgoJCS8vIHNob3cgYW55IGhpZGRlbiBlbGVtZW50cyBhZnRlciBzZXR0aW5nIG9wYWNpdHkgdG8gMAoJCXJldHVybiB0aGlzLmZpbHRlciggaXNIaWRkZW4gKS5jc3MoICJvcGFjaXR5IiwgMCApLnNob3coKQoKCQkJLy8gYW5pbWF0ZSB0byB0aGUgdmFsdWUgc3BlY2lmaWVkCgkJCS5lbmQoKS5hbmltYXRlKHsgb3BhY2l0eTogdG8gfSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKCX0sCglhbmltYXRlOiBmdW5jdGlvbiggcHJvcCwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSB7CgkJdmFyIGVtcHR5ID0galF1ZXJ5LmlzRW1wdHlPYmplY3QoIHByb3AgKSwKCQkJb3B0YWxsID0galF1ZXJ5LnNwZWVkKCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApLAoJCQlkb0FuaW1hdGlvbiA9IGZ1bmN0aW9uKCkgewoJCQkJLy8gT3BlcmF0ZSBvbiBhIGNvcHkgb2YgcHJvcCBzbyBwZXItcHJvcGVydHkgZWFzaW5nIHdvbid0IGJlIGxvc3QKCQkJCXZhciBhbmltID0gQW5pbWF0aW9uKCB0aGlzLCBqUXVlcnkuZXh0ZW5kKCB7fSwgcHJvcCApLCBvcHRhbGwgKTsKCgkJCQkvLyBFbXB0eSBhbmltYXRpb25zLCBvciBmaW5pc2hpbmcgcmVzb2x2ZXMgaW1tZWRpYXRlbHkKCQkJCWlmICggZW1wdHkgfHwgalF1ZXJ5Ll9kYXRhKCB0aGlzLCAiZmluaXNoIiApICkgewoJCQkJCWFuaW0uc3RvcCggdHJ1ZSApOwoJCQkJfQoJCQl9OwoJCQlkb0FuaW1hdGlvbi5maW5pc2ggPSBkb0FuaW1hdGlvbjsKCgkJcmV0dXJuIGVtcHR5IHx8IG9wdGFsbC5xdWV1ZSA9PT0gZmFsc2UgPwoJCQl0aGlzLmVhY2goIGRvQW5pbWF0aW9uICkgOgoJCQl0aGlzLnF1ZXVlKCBvcHRhbGwucXVldWUsIGRvQW5pbWF0aW9uICk7Cgl9LAoJc3RvcDogZnVuY3Rpb24oIHR5cGUsIGNsZWFyUXVldWUsIGdvdG9FbmQgKSB7CgkJdmFyIHN0b3BRdWV1ZSA9IGZ1bmN0aW9uKCBob29rcyApIHsKCQkJdmFyIHN0b3AgPSBob29rcy5zdG9wOwoJCQlkZWxldGUgaG9va3Muc3RvcDsKCQkJc3RvcCggZ290b0VuZCApOwoJCX07CgoJCWlmICggdHlwZW9mIHR5cGUgIT09ICJzdHJpbmciICkgewoJCQlnb3RvRW5kID0gY2xlYXJRdWV1ZTsKCQkJY2xlYXJRdWV1ZSA9IHR5cGU7CgkJCXR5cGUgPSB1bmRlZmluZWQ7CgkJfQoJCWlmICggY2xlYXJRdWV1ZSAmJiB0eXBlICE9PSBmYWxzZSApIHsKCQkJdGhpcy5xdWV1ZSggdHlwZSB8fCAiZngiLCBbXSApOwoJCX0KCgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJdmFyIGRlcXVldWUgPSB0cnVlLAoJCQkJaW5kZXggPSB0eXBlICE9IG51bGwgJiYgdHlwZSArICJxdWV1ZUhvb2tzIiwKCQkJCXRpbWVycyA9IGpRdWVyeS50aW1lcnMsCgkJCQlkYXRhID0galF1ZXJ5Ll9kYXRhKCB0aGlzICk7CgoJCQlpZiAoIGluZGV4ICkgewoJCQkJaWYgKCBkYXRhWyBpbmRleCBdICYmIGRhdGFbIGluZGV4IF0uc3RvcCApIHsKCQkJCQlzdG9wUXVldWUoIGRhdGFbIGluZGV4IF0gKTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWZvciAoIGluZGV4IGluIGRhdGEgKSB7CgkJCQkJaWYgKCBkYXRhWyBpbmRleCBdICYmIGRhdGFbIGluZGV4IF0uc3RvcCAmJiBycnVuLnRlc3QoIGluZGV4ICkgKSB7CgkJCQkJCXN0b3BRdWV1ZSggZGF0YVsgaW5kZXggXSApOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJZm9yICggaW5kZXggPSB0aW1lcnMubGVuZ3RoOyBpbmRleC0tOyApIHsKCQkJCWlmICggdGltZXJzWyBpbmRleCBdLmVsZW0gPT09IHRoaXMgJiYgKHR5cGUgPT0gbnVsbCB8fCB0aW1lcnNbIGluZGV4IF0ucXVldWUgPT09IHR5cGUpICkgewoJCQkJCXRpbWVyc1sgaW5kZXggXS5hbmltLnN0b3AoIGdvdG9FbmQgKTsKCQkJCQlkZXF1ZXVlID0gZmFsc2U7CgkJCQkJdGltZXJzLnNwbGljZSggaW5kZXgsIDEgKTsKCQkJCX0KCQkJfQoKCQkJLy8gc3RhcnQgdGhlIG5leHQgaW4gdGhlIHF1ZXVlIGlmIHRoZSBsYXN0IHN0ZXAgd2Fzbid0IGZvcmNlZAoJCQkvLyB0aW1lcnMgY3VycmVudGx5IHdpbGwgY2FsbCB0aGVpciBjb21wbGV0ZSBjYWxsYmFja3MsIHdoaWNoIHdpbGwgZGVxdWV1ZQoJCQkvLyBidXQgb25seSBpZiB0aGV5IHdlcmUgZ290b0VuZAoJCQlpZiAoIGRlcXVldWUgfHwgIWdvdG9FbmQgKSB7CgkJCQlqUXVlcnkuZGVxdWV1ZSggdGhpcywgdHlwZSApOwoJCQl9CgkJfSk7Cgl9LAoJZmluaXNoOiBmdW5jdGlvbiggdHlwZSApIHsKCQlpZiAoIHR5cGUgIT09IGZhbHNlICkgewoJCQl0eXBlID0gdHlwZSB8fCAiZngiOwoJCX0KCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgaW5kZXgsCgkJCQlkYXRhID0galF1ZXJ5Ll9kYXRhKCB0aGlzICksCgkJCQlxdWV1ZSA9IGRhdGFbIHR5cGUgKyAicXVldWUiIF0sCgkJCQlob29rcyA9IGRhdGFbIHR5cGUgKyAicXVldWVIb29rcyIgXSwKCQkJCXRpbWVycyA9IGpRdWVyeS50aW1lcnMsCgkJCQlsZW5ndGggPSBxdWV1ZSA/IHF1ZXVlLmxlbmd0aCA6IDA7CgoJCQkvLyBlbmFibGUgZmluaXNoaW5nIGZsYWcgb24gcHJpdmF0ZSBkYXRhCgkJCWRhdGEuZmluaXNoID0gdHJ1ZTsKCgkJCS8vIGVtcHR5IHRoZSBxdWV1ZSBmaXJzdAoJCQlqUXVlcnkucXVldWUoIHRoaXMsIHR5cGUsIFtdICk7CgoJCQlpZiAoIGhvb2tzICYmIGhvb2tzLnN0b3AgKSB7CgkJCQlob29rcy5zdG9wLmNhbGwoIHRoaXMsIHRydWUgKTsKCQkJfQoKCQkJLy8gbG9vayBmb3IgYW55IGFjdGl2ZSBhbmltYXRpb25zLCBhbmQgZmluaXNoIHRoZW0KCQkJZm9yICggaW5kZXggPSB0aW1lcnMubGVuZ3RoOyBpbmRleC0tOyApIHsKCQkJCWlmICggdGltZXJzWyBpbmRleCBdLmVsZW0gPT09IHRoaXMgJiYgdGltZXJzWyBpbmRleCBdLnF1ZXVlID09PSB0eXBlICkgewoJCQkJCXRpbWVyc1sgaW5kZXggXS5hbmltLnN0b3AoIHRydWUgKTsKCQkJCQl0aW1lcnMuc3BsaWNlKCBpbmRleCwgMSApOwoJCQkJfQoJCQl9CgoJCQkvLyBsb29rIGZvciBhbnkgYW5pbWF0aW9ucyBpbiB0aGUgb2xkIHF1ZXVlIGFuZCBmaW5pc2ggdGhlbQoJCQlmb3IgKCBpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrICkgewoJCQkJaWYgKCBxdWV1ZVsgaW5kZXggXSAmJiBxdWV1ZVsgaW5kZXggXS5maW5pc2ggKSB7CgkJCQkJcXVldWVbIGluZGV4IF0uZmluaXNoLmNhbGwoIHRoaXMgKTsKCQkJCX0KCQkJfQoKCQkJLy8gdHVybiBvZmYgZmluaXNoaW5nIGZsYWcKCQkJZGVsZXRlIGRhdGEuZmluaXNoOwoJCX0pOwoJfQp9KTsKCmpRdWVyeS5lYWNoKFsgInRvZ2dsZSIsICJzaG93IiwgImhpZGUiIF0sIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoJdmFyIGNzc0ZuID0galF1ZXJ5LmZuWyBuYW1lIF07CglqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsKCQlyZXR1cm4gc3BlZWQgPT0gbnVsbCB8fCB0eXBlb2Ygc3BlZWQgPT09ICJib29sZWFuIiA/CgkJCWNzc0ZuLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSA6CgkJCXRoaXMuYW5pbWF0ZSggZ2VuRngoIG5hbWUsIHRydWUgKSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKCX07Cn0pOwoKLy8gR2VuZXJhdGUgc2hvcnRjdXRzIGZvciBjdXN0b20gYW5pbWF0aW9ucwpqUXVlcnkuZWFjaCh7CglzbGlkZURvd246IGdlbkZ4KCJzaG93IiksCglzbGlkZVVwOiBnZW5GeCgiaGlkZSIpLAoJc2xpZGVUb2dnbGU6IGdlbkZ4KCJ0b2dnbGUiKSwKCWZhZGVJbjogeyBvcGFjaXR5OiAic2hvdyIgfSwKCWZhZGVPdXQ6IHsgb3BhY2l0eTogImhpZGUiIH0sCglmYWRlVG9nZ2xlOiB7IG9wYWNpdHk6ICJ0b2dnbGUiIH0KfSwgZnVuY3Rpb24oIG5hbWUsIHByb3BzICkgewoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSB7CgkJcmV0dXJuIHRoaXMuYW5pbWF0ZSggcHJvcHMsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICk7Cgl9Owp9KTsKCmpRdWVyeS50aW1lcnMgPSBbXTsKalF1ZXJ5LmZ4LnRpY2sgPSBmdW5jdGlvbigpIHsKCXZhciB0aW1lciwKCQl0aW1lcnMgPSBqUXVlcnkudGltZXJzLAoJCWkgPSAwOwoKCWZ4Tm93ID0galF1ZXJ5Lm5vdygpOwoKCWZvciAoIDsgaSA8IHRpbWVycy5sZW5ndGg7IGkrKyApIHsKCQl0aW1lciA9IHRpbWVyc1sgaSBdOwoJCS8vIENoZWNrcyB0aGUgdGltZXIgaGFzIG5vdCBhbHJlYWR5IGJlZW4gcmVtb3ZlZAoJCWlmICggIXRpbWVyKCkgJiYgdGltZXJzWyBpIF0gPT09IHRpbWVyICkgewoJCQl0aW1lcnMuc3BsaWNlKCBpLS0sIDEgKTsKCQl9Cgl9CgoJaWYgKCAhdGltZXJzLmxlbmd0aCApIHsKCQlqUXVlcnkuZnguc3RvcCgpOwoJfQoJZnhOb3cgPSB1bmRlZmluZWQ7Cn07CgpqUXVlcnkuZngudGltZXIgPSBmdW5jdGlvbiggdGltZXIgKSB7CglqUXVlcnkudGltZXJzLnB1c2goIHRpbWVyICk7CglpZiAoIHRpbWVyKCkgKSB7CgkJalF1ZXJ5LmZ4LnN0YXJ0KCk7Cgl9IGVsc2UgewoJCWpRdWVyeS50aW1lcnMucG9wKCk7Cgl9Cn07CgpqUXVlcnkuZnguaW50ZXJ2YWwgPSAxMzsKCmpRdWVyeS5meC5zdGFydCA9IGZ1bmN0aW9uKCkgewoJaWYgKCAhdGltZXJJZCApIHsKCQl0aW1lcklkID0gc2V0SW50ZXJ2YWwoIGpRdWVyeS5meC50aWNrLCBqUXVlcnkuZnguaW50ZXJ2YWwgKTsKCX0KfTsKCmpRdWVyeS5meC5zdG9wID0gZnVuY3Rpb24oKSB7CgljbGVhckludGVydmFsKCB0aW1lcklkICk7Cgl0aW1lcklkID0gbnVsbDsKfTsKCmpRdWVyeS5meC5zcGVlZHMgPSB7CglzbG93OiA2MDAsCglmYXN0OiAyMDAsCgkvLyBEZWZhdWx0IHNwZWVkCglfZGVmYXVsdDogNDAwCn07CgoKLy8gQmFzZWQgb2ZmIG9mIHRoZSBwbHVnaW4gYnkgQ2xpbnQgSGVsZmVycywgd2l0aCBwZXJtaXNzaW9uLgovLyBodHRwOi8vYmxpbmRzaWduYWxzLmNvbS9pbmRleC5waHAvMjAwOS8wNy9qcXVlcnktZGVsYXkvCmpRdWVyeS5mbi5kZWxheSA9IGZ1bmN0aW9uKCB0aW1lLCB0eXBlICkgewoJdGltZSA9IGpRdWVyeS5meCA/IGpRdWVyeS5meC5zcGVlZHNbIHRpbWUgXSB8fCB0aW1lIDogdGltZTsKCXR5cGUgPSB0eXBlIHx8ICJmeCI7CgoJcmV0dXJuIHRoaXMucXVldWUoIHR5cGUsIGZ1bmN0aW9uKCBuZXh0LCBob29rcyApIHsKCQl2YXIgdGltZW91dCA9IHNldFRpbWVvdXQoIG5leHQsIHRpbWUgKTsKCQlob29rcy5zdG9wID0gZnVuY3Rpb24oKSB7CgkJCWNsZWFyVGltZW91dCggdGltZW91dCApOwoJCX07Cgl9KTsKfTsKCgooZnVuY3Rpb24oKSB7Cgl2YXIgYSwgaW5wdXQsIHNlbGVjdCwgb3B0LAoJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIgKTsKCgkvLyBTZXR1cAoJZGl2LnNldEF0dHJpYnV0ZSggImNsYXNzTmFtZSIsICJ0IiApOwoJZGl2LmlubmVySFRNTCA9ICIgIDxsaW5rLz48dGFibGU+PC90YWJsZT48YSBocmVmPScvYSc+YTwvYT48aW5wdXQgdHlwZT0nY2hlY2tib3gnLz4iOwoJYSA9IGRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYSIpWyAwIF07CgoJLy8gRmlyc3QgYmF0Y2ggb2YgdGVzdHMuCglzZWxlY3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzZWxlY3QiKTsKCW9wdCA9IHNlbGVjdC5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib3B0aW9uIikgKTsKCWlucHV0ID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJpbnB1dCIpWyAwIF07CgoJYS5zdHlsZS5jc3NUZXh0ID0gInRvcDoxcHgiOwoKCS8vIFRlc3Qgc2V0QXR0cmlidXRlIG9uIGNhbWVsQ2FzZSBjbGFzcy4gSWYgaXQgd29ya3MsIHdlIG5lZWQgYXR0ckZpeGVzIHdoZW4gZG9pbmcgZ2V0L3NldEF0dHJpYnV0ZSAoaWU2LzcpCglzdXBwb3J0LmdldFNldEF0dHJpYnV0ZSA9IGRpdi5jbGFzc05hbWUgIT09ICJ0IjsKCgkvLyBHZXQgdGhlIHN0eWxlIGluZm9ybWF0aW9uIGZyb20gZ2V0QXR0cmlidXRlCgkvLyAoSUUgdXNlcyAuY3NzVGV4dCBpbnN0ZWFkKQoJc3VwcG9ydC5zdHlsZSA9IC90b3AvLnRlc3QoIGEuZ2V0QXR0cmlidXRlKCJzdHlsZSIpICk7CgoJLy8gTWFrZSBzdXJlIHRoYXQgVVJMcyBhcmVuJ3QgbWFuaXB1bGF0ZWQKCS8vIChJRSBub3JtYWxpemVzIGl0IGJ5IGRlZmF1bHQpCglzdXBwb3J0LmhyZWZOb3JtYWxpemVkID0gYS5nZXRBdHRyaWJ1dGUoImhyZWYiKSA9PT0gIi9hIjsKCgkvLyBDaGVjayB0aGUgZGVmYXVsdCBjaGVja2JveC9yYWRpbyB2YWx1ZSAoIiIgb24gV2ViS2l0OyAib24iIGVsc2V3aGVyZSkKCXN1cHBvcnQuY2hlY2tPbiA9ICEhaW5wdXQudmFsdWU7CgoJLy8gTWFrZSBzdXJlIHRoYXQgYSBzZWxlY3RlZC1ieS1kZWZhdWx0IG9wdGlvbiBoYXMgYSB3b3JraW5nIHNlbGVjdGVkIHByb3BlcnR5LgoJLy8gKFdlYktpdCBkZWZhdWx0cyB0byBmYWxzZSBpbnN0ZWFkIG9mIHRydWUsIElFIHRvbywgaWYgaXQncyBpbiBhbiBvcHRncm91cCkKCXN1cHBvcnQub3B0U2VsZWN0ZWQgPSBvcHQuc2VsZWN0ZWQ7CgoJLy8gVGVzdHMgZm9yIGVuY3R5cGUgc3VwcG9ydCBvbiBhIGZvcm0gKCM2NzQzKQoJc3VwcG9ydC5lbmN0eXBlID0gISFkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJmb3JtIikuZW5jdHlwZTsKCgkvLyBNYWtlIHN1cmUgdGhhdCB0aGUgb3B0aW9ucyBpbnNpZGUgZGlzYWJsZWQgc2VsZWN0cyBhcmVuJ3QgbWFya2VkIGFzIGRpc2FibGVkCgkvLyAoV2ViS2l0IG1hcmtzIHRoZW0gYXMgZGlzYWJsZWQpCglzZWxlY3QuZGlzYWJsZWQgPSB0cnVlOwoJc3VwcG9ydC5vcHREaXNhYmxlZCA9ICFvcHQuZGlzYWJsZWQ7CgoJLy8gU3VwcG9ydDogSUU4IG9ubHkKCS8vIENoZWNrIGlmIHdlIGNhbiB0cnVzdCBnZXRBdHRyaWJ1dGUoInZhbHVlIikKCWlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImlucHV0IiApOwoJaW5wdXQuc2V0QXR0cmlidXRlKCAidmFsdWUiLCAiIiApOwoJc3VwcG9ydC5pbnB1dCA9IGlucHV0LmdldEF0dHJpYnV0ZSggInZhbHVlIiApID09PSAiIjsKCgkvLyBDaGVjayBpZiBhbiBpbnB1dCBtYWludGFpbnMgaXRzIHZhbHVlIGFmdGVyIGJlY29taW5nIGEgcmFkaW8KCWlucHV0LnZhbHVlID0gInQiOwoJaW5wdXQuc2V0QXR0cmlidXRlKCAidHlwZSIsICJyYWRpbyIgKTsKCXN1cHBvcnQucmFkaW9WYWx1ZSA9IGlucHV0LnZhbHVlID09PSAidCI7CgoJLy8gTnVsbCBlbGVtZW50cyB0byBhdm9pZCBsZWFrcyBpbiBJRS4KCWEgPSBpbnB1dCA9IHNlbGVjdCA9IG9wdCA9IGRpdiA9IG51bGw7Cn0pKCk7CgoKdmFyIHJyZXR1cm4gPSAvXHIvZzsKCmpRdWVyeS5mbi5leHRlbmQoewoJdmFsOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIGhvb2tzLCByZXQsIGlzRnVuY3Rpb24sCgkJCWVsZW0gPSB0aGlzWzBdOwoKCQlpZiAoICFhcmd1bWVudHMubGVuZ3RoICkgewoJCQlpZiAoIGVsZW0gKSB7CgkJCQlob29rcyA9IGpRdWVyeS52YWxIb29rc1sgZWxlbS50eXBlIF0gfHwgalF1ZXJ5LnZhbEhvb2tzWyBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgXTsKCgkJCQlpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoIGVsZW0sICJ2YWx1ZSIgKSkgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gcmV0OwoJCQkJfQoKCQkJCXJldCA9IGVsZW0udmFsdWU7CgoJCQkJcmV0dXJuIHR5cGVvZiByZXQgPT09ICJzdHJpbmciID8KCQkJCQkvLyBoYW5kbGUgbW9zdCBjb21tb24gc3RyaW5nIGNhc2VzCgkJCQkJcmV0LnJlcGxhY2UocnJldHVybiwgIiIpIDoKCQkJCQkvLyBoYW5kbGUgY2FzZXMgd2hlcmUgdmFsdWUgaXMgbnVsbC91bmRlZiBvciBudW1iZXIKCQkJCQlyZXQgPT0gbnVsbCA/ICIiIDogcmV0OwoJCQl9CgoJCQlyZXR1cm47CgkJfQoKCQlpc0Z1bmN0aW9uID0galF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICk7CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oIGkgKSB7CgkJCXZhciB2YWw7CgoJCQlpZiAoIHRoaXMubm9kZVR5cGUgIT09IDEgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggaXNGdW5jdGlvbiApIHsKCQkJCXZhbCA9IHZhbHVlLmNhbGwoIHRoaXMsIGksIGpRdWVyeSggdGhpcyApLnZhbCgpICk7CgkJCX0gZWxzZSB7CgkJCQl2YWwgPSB2YWx1ZTsKCQkJfQoKCQkJLy8gVHJlYXQgbnVsbC91bmRlZmluZWQgYXMgIiI7IGNvbnZlcnQgbnVtYmVycyB0byBzdHJpbmcKCQkJaWYgKCB2YWwgPT0gbnVsbCApIHsKCQkJCXZhbCA9ICIiOwoJCQl9IGVsc2UgaWYgKCB0eXBlb2YgdmFsID09PSAibnVtYmVyIiApIHsKCQkJCXZhbCArPSAiIjsKCQkJfSBlbHNlIGlmICggalF1ZXJ5LmlzQXJyYXkoIHZhbCApICkgewoJCQkJdmFsID0galF1ZXJ5Lm1hcCggdmFsLCBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCQkJcmV0dXJuIHZhbHVlID09IG51bGwgPyAiIiA6IHZhbHVlICsgIiI7CgkJCQl9KTsKCQkJfQoKCQkJaG9va3MgPSBqUXVlcnkudmFsSG9va3NbIHRoaXMudHlwZSBdIHx8IGpRdWVyeS52YWxIb29rc1sgdGhpcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpIF07CgoJCQkvLyBJZiBzZXQgcmV0dXJucyB1bmRlZmluZWQsIGZhbGwgYmFjayB0byBub3JtYWwgc2V0dGluZwoJCQlpZiAoICFob29rcyB8fCAhKCJzZXQiIGluIGhvb2tzKSB8fCBob29rcy5zZXQoIHRoaXMsIHZhbCwgInZhbHVlIiApID09PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLnZhbHVlID0gdmFsOwoJCQl9CgkJfSk7Cgl9Cn0pOwoKalF1ZXJ5LmV4dGVuZCh7Cgl2YWxIb29rczogewoJCW9wdGlvbjogewoJCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJdmFyIHZhbCA9IGpRdWVyeS5maW5kLmF0dHIoIGVsZW0sICJ2YWx1ZSIgKTsKCQkJCXJldHVybiB2YWwgIT0gbnVsbCA/CgkJCQkJdmFsIDoKCQkJCQlqUXVlcnkudGV4dCggZWxlbSApOwoJCQl9CgkJfSwKCQlzZWxlY3Q6IHsKCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXZhciB2YWx1ZSwgb3B0aW9uLAoJCQkJCW9wdGlvbnMgPSBlbGVtLm9wdGlvbnMsCgkJCQkJaW5kZXggPSBlbGVtLnNlbGVjdGVkSW5kZXgsCgkJCQkJb25lID0gZWxlbS50eXBlID09PSAic2VsZWN0LW9uZSIgfHwgaW5kZXggPCAwLAoJCQkJCXZhbHVlcyA9IG9uZSA/IG51bGwgOiBbXSwKCQkJCQltYXggPSBvbmUgPyBpbmRleCArIDEgOiBvcHRpb25zLmxlbmd0aCwKCQkJCQlpID0gaW5kZXggPCAwID8KCQkJCQkJbWF4IDoKCQkJCQkJb25lID8gaW5kZXggOiAwOwoKCQkJCS8vIExvb3AgdGhyb3VnaCBhbGwgdGhlIHNlbGVjdGVkIG9wdGlvbnMKCQkJCWZvciAoIDsgaSA8IG1heDsgaSsrICkgewoJCQkJCW9wdGlvbiA9IG9wdGlvbnNbIGkgXTsKCgkJCQkJLy8gb2xkSUUgZG9lc24ndCB1cGRhdGUgc2VsZWN0ZWQgYWZ0ZXIgZm9ybSByZXNldCAoIzI1NTEpCgkJCQkJaWYgKCAoIG9wdGlvbi5zZWxlY3RlZCB8fCBpID09PSBpbmRleCApICYmCgkJCQkJCQkvLyBEb24ndCByZXR1cm4gb3B0aW9ucyB0aGF0IGFyZSBkaXNhYmxlZCBvciBpbiBhIGRpc2FibGVkIG9wdGdyb3VwCgkJCQkJCQkoIHN1cHBvcnQub3B0RGlzYWJsZWQgPyAhb3B0aW9uLmRpc2FibGVkIDogb3B0aW9uLmdldEF0dHJpYnV0ZSgiZGlzYWJsZWQiKSA9PT0gbnVsbCApICYmCgkJCQkJCQkoICFvcHRpb24ucGFyZW50Tm9kZS5kaXNhYmxlZCB8fCAhalF1ZXJ5Lm5vZGVOYW1lKCBvcHRpb24ucGFyZW50Tm9kZSwgIm9wdGdyb3VwIiApICkgKSB7CgoJCQkJCQkvLyBHZXQgdGhlIHNwZWNpZmljIHZhbHVlIGZvciB0aGUgb3B0aW9uCgkJCQkJCXZhbHVlID0galF1ZXJ5KCBvcHRpb24gKS52YWwoKTsKCgkJCQkJCS8vIFdlIGRvbid0IG5lZWQgYW4gYXJyYXkgZm9yIG9uZSBzZWxlY3RzCgkJCQkJCWlmICggb25lICkgewoJCQkJCQkJcmV0dXJuIHZhbHVlOwoJCQkJCQl9CgoJCQkJCQkvLyBNdWx0aS1TZWxlY3RzIHJldHVybiBhbiBhcnJheQoJCQkJCQl2YWx1ZXMucHVzaCggdmFsdWUgKTsKCQkJCQl9CgkJCQl9CgoJCQkJcmV0dXJuIHZhbHVlczsKCQkJfSwKCgkJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgewoJCQkJdmFyIG9wdGlvblNldCwgb3B0aW9uLAoJCQkJCW9wdGlvbnMgPSBlbGVtLm9wdGlvbnMsCgkJCQkJdmFsdWVzID0galF1ZXJ5Lm1ha2VBcnJheSggdmFsdWUgKSwKCQkJCQlpID0gb3B0aW9ucy5sZW5ndGg7CgoJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJb3B0aW9uID0gb3B0aW9uc1sgaSBdOwoKCQkJCQlpZiAoIGpRdWVyeS5pbkFycmF5KCBqUXVlcnkudmFsSG9va3Mub3B0aW9uLmdldCggb3B0aW9uICksIHZhbHVlcyApID49IDAgKSB7CgoJCQkJCQkvLyBTdXBwb3J0OiBJRTYKCQkJCQkJLy8gV2hlbiBuZXcgb3B0aW9uIGVsZW1lbnQgaXMgYWRkZWQgdG8gc2VsZWN0IGJveCB3ZSBuZWVkIHRvCgkJCQkJCS8vIGZvcmNlIHJlZmxvdyBvZiBuZXdseSBhZGRlZCBub2RlIGluIG9yZGVyIHRvIHdvcmthcm91bmQgZGVsYXkKCQkJCQkJLy8gb2YgaW5pdGlhbGl6YXRpb24gcHJvcGVydGllcwoJCQkJCQl0cnkgewoJCQkJCQkJb3B0aW9uLnNlbGVjdGVkID0gb3B0aW9uU2V0ID0gdHJ1ZTsKCgkJCQkJCX0gY2F0Y2ggKCBfICkgewoKCQkJCQkJCS8vIFdpbGwgYmUgZXhlY3V0ZWQgb25seSBpbiBJRTYKCQkJCQkJCW9wdGlvbi5zY3JvbGxIZWlnaHQ7CgkJCQkJCX0KCgkJCQkJfSBlbHNlIHsKCQkJCQkJb3B0aW9uLnNlbGVjdGVkID0gZmFsc2U7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIEZvcmNlIGJyb3dzZXJzIHRvIGJlaGF2ZSBjb25zaXN0ZW50bHkgd2hlbiBub24tbWF0Y2hpbmcgdmFsdWUgaXMgc2V0CgkJCQlpZiAoICFvcHRpb25TZXQgKSB7CgkJCQkJZWxlbS5zZWxlY3RlZEluZGV4ID0gLTE7CgkJCQl9CgoJCQkJcmV0dXJuIG9wdGlvbnM7CgkJCX0KCQl9Cgl9Cn0pOwoKLy8gUmFkaW9zIGFuZCBjaGVja2JveGVzIGdldHRlci9zZXR0ZXIKalF1ZXJ5LmVhY2goWyAicmFkaW8iLCAiY2hlY2tib3giIF0sIGZ1bmN0aW9uKCkgewoJalF1ZXJ5LnZhbEhvb2tzWyB0aGlzIF0gPSB7CgkJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7CgkJCWlmICggalF1ZXJ5LmlzQXJyYXkoIHZhbHVlICkgKSB7CgkJCQlyZXR1cm4gKCBlbGVtLmNoZWNrZWQgPSBqUXVlcnkuaW5BcnJheSggalF1ZXJ5KGVsZW0pLnZhbCgpLCB2YWx1ZSApID49IDAgKTsKCQkJfQoJCX0KCX07CglpZiAoICFzdXBwb3J0LmNoZWNrT24gKSB7CgkJalF1ZXJ5LnZhbEhvb2tzWyB0aGlzIF0uZ2V0ID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCS8vIFN1cHBvcnQ6IFdlYmtpdAoJCQkvLyAiIiBpcyByZXR1cm5lZCBpbnN0ZWFkIG9mICJvbiIgaWYgYSB2YWx1ZSBpc24ndCBzcGVjaWZpZWQKCQkJcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCJ2YWx1ZSIpID09PSBudWxsID8gIm9uIiA6IGVsZW0udmFsdWU7CgkJfTsKCX0KfSk7CgoKCgp2YXIgbm9kZUhvb2ssIGJvb2xIb29rLAoJYXR0ckhhbmRsZSA9IGpRdWVyeS5leHByLmF0dHJIYW5kbGUsCglydXNlRGVmYXVsdCA9IC9eKD86Y2hlY2tlZHxzZWxlY3RlZCkkL2ksCglnZXRTZXRBdHRyaWJ1dGUgPSBzdXBwb3J0LmdldFNldEF0dHJpYnV0ZSwKCWdldFNldElucHV0ID0gc3VwcG9ydC5pbnB1dDsKCmpRdWVyeS5mbi5leHRlbmQoewoJYXR0cjogZnVuY3Rpb24oIG5hbWUsIHZhbHVlICkgewoJCXJldHVybiBhY2Nlc3MoIHRoaXMsIGpRdWVyeS5hdHRyLCBuYW1lLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEgKTsKCX0sCgoJcmVtb3ZlQXR0cjogZnVuY3Rpb24oIG5hbWUgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LnJlbW92ZUF0dHIoIHRoaXMsIG5hbWUgKTsKCQl9KTsKCX0KfSk7CgpqUXVlcnkuZXh0ZW5kKHsKCWF0dHI6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCB2YWx1ZSApIHsKCQl2YXIgaG9va3MsIHJldCwKCQkJblR5cGUgPSBlbGVtLm5vZGVUeXBlOwoKCQkvLyBkb24ndCBnZXQvc2V0IGF0dHJpYnV0ZXMgb24gdGV4dCwgY29tbWVudCBhbmQgYXR0cmlidXRlIG5vZGVzCgkJaWYgKCAhZWxlbSB8fCBuVHlwZSA9PT0gMyB8fCBuVHlwZSA9PT0gOCB8fCBuVHlwZSA9PT0gMiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gRmFsbGJhY2sgdG8gcHJvcCB3aGVuIGF0dHJpYnV0ZXMgYXJlIG5vdCBzdXBwb3J0ZWQKCQlpZiAoIHR5cGVvZiBlbGVtLmdldEF0dHJpYnV0ZSA9PT0gc3RydW5kZWZpbmVkICkgewoJCQlyZXR1cm4galF1ZXJ5LnByb3AoIGVsZW0sIG5hbWUsIHZhbHVlICk7CgkJfQoKCQkvLyBBbGwgYXR0cmlidXRlcyBhcmUgbG93ZXJjYXNlCgkJLy8gR3JhYiBuZWNlc3NhcnkgaG9vayBpZiBvbmUgaXMgZGVmaW5lZAoJCWlmICggblR5cGUgIT09IDEgfHwgIWpRdWVyeS5pc1hNTERvYyggZWxlbSApICkgewoJCQluYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwoJCQlob29rcyA9IGpRdWVyeS5hdHRySG9va3NbIG5hbWUgXSB8fAoJCQkJKCBqUXVlcnkuZXhwci5tYXRjaC5ib29sLnRlc3QoIG5hbWUgKSA/IGJvb2xIb29rIDogbm9kZUhvb2sgKTsKCQl9CgoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCgkJCWlmICggdmFsdWUgPT09IG51bGwgKSB7CgkJCQlqUXVlcnkucmVtb3ZlQXR0ciggZWxlbSwgbmFtZSApOwoKCQkJfSBlbHNlIGlmICggaG9va3MgJiYgInNldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLnNldCggZWxlbSwgdmFsdWUsIG5hbWUgKSkgIT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiByZXQ7CgoJCQl9IGVsc2UgewoJCQkJZWxlbS5zZXRBdHRyaWJ1dGUoIG5hbWUsIHZhbHVlICsgIiIgKTsKCQkJCXJldHVybiB2YWx1ZTsKCQkJfQoKCQl9IGVsc2UgaWYgKCBob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KCBlbGVtLCBuYW1lICkpICE9PSBudWxsICkgewoJCQlyZXR1cm4gcmV0OwoKCQl9IGVsc2UgewoJCQlyZXQgPSBqUXVlcnkuZmluZC5hdHRyKCBlbGVtLCBuYW1lICk7CgoJCQkvLyBOb24tZXhpc3RlbnQgYXR0cmlidXRlcyByZXR1cm4gbnVsbCwgd2Ugbm9ybWFsaXplIHRvIHVuZGVmaW5lZAoJCQlyZXR1cm4gcmV0ID09IG51bGwgPwoJCQkJdW5kZWZpbmVkIDoKCQkJCXJldDsKCQl9Cgl9LAoKCXJlbW92ZUF0dHI6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQl2YXIgbmFtZSwgcHJvcE5hbWUsCgkJCWkgPSAwLAoJCQlhdHRyTmFtZXMgPSB2YWx1ZSAmJiB2YWx1ZS5tYXRjaCggcm5vdHdoaXRlICk7CgoJCWlmICggYXR0ck5hbWVzICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCXdoaWxlICggKG5hbWUgPSBhdHRyTmFtZXNbaSsrXSkgKSB7CgkJCQlwcm9wTmFtZSA9IGpRdWVyeS5wcm9wRml4WyBuYW1lIF0gfHwgbmFtZTsKCgkJCQkvLyBCb29sZWFuIGF0dHJpYnV0ZXMgZ2V0IHNwZWNpYWwgdHJlYXRtZW50ICgjMTA4NzApCgkJCQlpZiAoIGpRdWVyeS5leHByLm1hdGNoLmJvb2wudGVzdCggbmFtZSApICkgewoJCQkJCS8vIFNldCBjb3JyZXNwb25kaW5nIHByb3BlcnR5IHRvIGZhbHNlCgkJCQkJaWYgKCBnZXRTZXRJbnB1dCAmJiBnZXRTZXRBdHRyaWJ1dGUgfHwgIXJ1c2VEZWZhdWx0LnRlc3QoIG5hbWUgKSApIHsKCQkJCQkJZWxlbVsgcHJvcE5hbWUgXSA9IGZhbHNlOwoJCQkJCS8vIFN1cHBvcnQ6IElFPDkKCQkJCQkvLyBBbHNvIGNsZWFyIGRlZmF1bHRDaGVja2VkL2RlZmF1bHRTZWxlY3RlZCAoaWYgYXBwcm9wcmlhdGUpCgkJCQkJfSBlbHNlIHsKCQkJCQkJZWxlbVsgalF1ZXJ5LmNhbWVsQ2FzZSggImRlZmF1bHQtIiArIG5hbWUgKSBdID0KCQkJCQkJCWVsZW1bIHByb3BOYW1lIF0gPSBmYWxzZTsKCQkJCQl9CgoJCQkJLy8gU2VlICM5Njk5IGZvciBleHBsYW5hdGlvbiBvZiB0aGlzIGFwcHJvYWNoIChzZXR0aW5nIGZpcnN0LCB0aGVuIHJlbW92YWwpCgkJCQl9IGVsc2UgewoJCQkJCWpRdWVyeS5hdHRyKCBlbGVtLCBuYW1lLCAiIiApOwoJCQkJfQoKCQkJCWVsZW0ucmVtb3ZlQXR0cmlidXRlKCBnZXRTZXRBdHRyaWJ1dGUgPyBuYW1lIDogcHJvcE5hbWUgKTsKCQkJfQoJCX0KCX0sCgoJYXR0ckhvb2tzOiB7CgkJdHlwZTogewoJCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQkJCWlmICggIXN1cHBvcnQucmFkaW9WYWx1ZSAmJiB2YWx1ZSA9PT0gInJhZGlvIiAmJiBqUXVlcnkubm9kZU5hbWUoZWxlbSwgImlucHV0IikgKSB7CgkJCQkJLy8gU2V0dGluZyB0aGUgdHlwZSBvbiBhIHJhZGlvIGJ1dHRvbiBhZnRlciB0aGUgdmFsdWUgcmVzZXRzIHRoZSB2YWx1ZSBpbiBJRTYtOQoJCQkJCS8vIFJlc2V0IHZhbHVlIHRvIGRlZmF1bHQgaW4gY2FzZSB0eXBlIGlzIHNldCBhZnRlciB2YWx1ZSBkdXJpbmcgY3JlYXRpb24KCQkJCQl2YXIgdmFsID0gZWxlbS52YWx1ZTsKCQkJCQllbGVtLnNldEF0dHJpYnV0ZSggInR5cGUiLCB2YWx1ZSApOwoJCQkJCWlmICggdmFsICkgewoJCQkJCQllbGVtLnZhbHVlID0gdmFsOwoJCQkJCX0KCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQl9CgkJCX0KCQl9Cgl9Cn0pOwoKLy8gSG9vayBmb3IgYm9vbGVhbiBhdHRyaWJ1dGVzCmJvb2xIb29rID0gewoJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUsIG5hbWUgKSB7CgkJaWYgKCB2YWx1ZSA9PT0gZmFsc2UgKSB7CgkJCS8vIFJlbW92ZSBib29sZWFuIGF0dHJpYnV0ZXMgd2hlbiBzZXQgdG8gZmFsc2UKCQkJalF1ZXJ5LnJlbW92ZUF0dHIoIGVsZW0sIG5hbWUgKTsKCQl9IGVsc2UgaWYgKCBnZXRTZXRJbnB1dCAmJiBnZXRTZXRBdHRyaWJ1dGUgfHwgIXJ1c2VEZWZhdWx0LnRlc3QoIG5hbWUgKSApIHsKCQkJLy8gSUU8OCBuZWVkcyB0aGUgKnByb3BlcnR5KiBuYW1lCgkJCWVsZW0uc2V0QXR0cmlidXRlKCAhZ2V0U2V0QXR0cmlidXRlICYmIGpRdWVyeS5wcm9wRml4WyBuYW1lIF0gfHwgbmFtZSwgbmFtZSApOwoKCQkvLyBVc2UgZGVmYXVsdENoZWNrZWQgYW5kIGRlZmF1bHRTZWxlY3RlZCBmb3Igb2xkSUUKCQl9IGVsc2UgewoJCQllbGVtWyBqUXVlcnkuY2FtZWxDYXNlKCAiZGVmYXVsdC0iICsgbmFtZSApIF0gPSBlbGVtWyBuYW1lIF0gPSB0cnVlOwoJCX0KCgkJcmV0dXJuIG5hbWU7Cgl9Cn07CgovLyBSZXRyaWV2ZSBib29sZWFucyBzcGVjaWFsbHkKalF1ZXJ5LmVhY2goIGpRdWVyeS5leHByLm1hdGNoLmJvb2wuc291cmNlLm1hdGNoKCAvXHcrL2cgKSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgoJdmFyIGdldHRlciA9IGF0dHJIYW5kbGVbIG5hbWUgXSB8fCBqUXVlcnkuZmluZC5hdHRyOwoKCWF0dHJIYW5kbGVbIG5hbWUgXSA9IGdldFNldElucHV0ICYmIGdldFNldEF0dHJpYnV0ZSB8fCAhcnVzZURlZmF1bHQudGVzdCggbmFtZSApID8KCQlmdW5jdGlvbiggZWxlbSwgbmFtZSwgaXNYTUwgKSB7CgkJCXZhciByZXQsIGhhbmRsZTsKCQkJaWYgKCAhaXNYTUwgKSB7CgkJCQkvLyBBdm9pZCBhbiBpbmZpbml0ZSBsb29wIGJ5IHRlbXBvcmFyaWx5IHJlbW92aW5nIHRoaXMgZnVuY3Rpb24gZnJvbSB0aGUgZ2V0dGVyCgkJCQloYW5kbGUgPSBhdHRySGFuZGxlWyBuYW1lIF07CgkJCQlhdHRySGFuZGxlWyBuYW1lIF0gPSByZXQ7CgkJCQlyZXQgPSBnZXR0ZXIoIGVsZW0sIG5hbWUsIGlzWE1MICkgIT0gbnVsbCA/CgkJCQkJbmFtZS50b0xvd2VyQ2FzZSgpIDoKCQkJCQludWxsOwoJCQkJYXR0ckhhbmRsZVsgbmFtZSBdID0gaGFuZGxlOwoJCQl9CgkJCXJldHVybiByZXQ7CgkJfSA6CgkJZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGlzWE1MICkgewoJCQlpZiAoICFpc1hNTCApIHsKCQkJCXJldHVybiBlbGVtWyBqUXVlcnkuY2FtZWxDYXNlKCAiZGVmYXVsdC0iICsgbmFtZSApIF0gPwoJCQkJCW5hbWUudG9Mb3dlckNhc2UoKSA6CgkJCQkJbnVsbDsKCQkJfQoJCX07Cn0pOwoKLy8gZml4IG9sZElFIGF0dHJvcGVydGllcwppZiAoICFnZXRTZXRJbnB1dCB8fCAhZ2V0U2V0QXR0cmlidXRlICkgewoJalF1ZXJ5LmF0dHJIb29rcy52YWx1ZSA9IHsKCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSwgbmFtZSApIHsKCQkJaWYgKCBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJpbnB1dCIgKSApIHsKCQkJCS8vIERvZXMgbm90IHJldHVybiBzbyB0aGF0IHNldEF0dHJpYnV0ZSBpcyBhbHNvIHVzZWQKCQkJCWVsZW0uZGVmYXVsdFZhbHVlID0gdmFsdWU7CgkJCX0gZWxzZSB7CgkJCQkvLyBVc2Ugbm9kZUhvb2sgaWYgZGVmaW5lZCAoIzE5NTQpOyBvdGhlcndpc2Ugc2V0QXR0cmlidXRlIGlzIGZpbmUKCQkJCXJldHVybiBub2RlSG9vayAmJiBub2RlSG9vay5zZXQoIGVsZW0sIHZhbHVlLCBuYW1lICk7CgkJCX0KCQl9Cgl9Owp9CgovLyBJRTYvNyBkbyBub3Qgc3VwcG9ydCBnZXR0aW5nL3NldHRpbmcgc29tZSBhdHRyaWJ1dGVzIHdpdGggZ2V0L3NldEF0dHJpYnV0ZQppZiAoICFnZXRTZXRBdHRyaWJ1dGUgKSB7CgoJLy8gVXNlIHRoaXMgZm9yIGFueSBhdHRyaWJ1dGUgaW4gSUU2LzcKCS8vIFRoaXMgZml4ZXMgYWxtb3N0IGV2ZXJ5IElFNi83IGlzc3VlCglub2RlSG9vayA9IHsKCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSwgbmFtZSApIHsKCQkJLy8gU2V0IHRoZSBleGlzdGluZyBvciBjcmVhdGUgYSBuZXcgYXR0cmlidXRlIG5vZGUKCQkJdmFyIHJldCA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZSggbmFtZSApOwoJCQlpZiAoICFyZXQgKSB7CgkJCQllbGVtLnNldEF0dHJpYnV0ZU5vZGUoCgkJCQkJKHJldCA9IGVsZW0ub3duZXJEb2N1bWVudC5jcmVhdGVBdHRyaWJ1dGUoIG5hbWUgKSkKCQkJCSk7CgkJCX0KCgkJCXJldC52YWx1ZSA9IHZhbHVlICs9ICIiOwoKCQkJLy8gQnJlYWsgYXNzb2NpYXRpb24gd2l0aCBjbG9uZWQgZWxlbWVudHMgYnkgYWxzbyB1c2luZyBzZXRBdHRyaWJ1dGUgKCM5NjQ2KQoJCQlpZiAoIG5hbWUgPT09ICJ2YWx1ZSIgfHwgdmFsdWUgPT09IGVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lICkgKSB7CgkJCQlyZXR1cm4gdmFsdWU7CgkJCX0KCQl9Cgl9OwoKCS8vIFNvbWUgYXR0cmlidXRlcyBhcmUgY29uc3RydWN0ZWQgd2l0aCBlbXB0eS1zdHJpbmcgdmFsdWVzIHdoZW4gbm90IGRlZmluZWQKCWF0dHJIYW5kbGUuaWQgPSBhdHRySGFuZGxlLm5hbWUgPSBhdHRySGFuZGxlLmNvb3JkcyA9CgkJZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGlzWE1MICkgewoJCQl2YXIgcmV0OwoJCQlpZiAoICFpc1hNTCApIHsKCQkJCXJldHVybiAocmV0ID0gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCBuYW1lICkpICYmIHJldC52YWx1ZSAhPT0gIiIgPwoJCQkJCXJldC52YWx1ZSA6CgkJCQkJbnVsbDsKCQkJfQoJCX07CgoJLy8gRml4aW5nIHZhbHVlIHJldHJpZXZhbCBvbiBhIGJ1dHRvbiByZXF1aXJlcyB0aGlzIG1vZHVsZQoJalF1ZXJ5LnZhbEhvb2tzLmJ1dHRvbiA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCQl2YXIgcmV0ID0gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCBuYW1lICk7CgkJCWlmICggcmV0ICYmIHJldC5zcGVjaWZpZWQgKSB7CgkJCQlyZXR1cm4gcmV0LnZhbHVlOwoJCQl9CgkJfSwKCQlzZXQ6IG5vZGVIb29rLnNldAoJfTsKCgkvLyBTZXQgY29udGVudGVkaXRhYmxlIHRvIGZhbHNlIG9uIHJlbW92YWxzKCMxMDQyOSkKCS8vIFNldHRpbmcgdG8gZW1wdHkgc3RyaW5nIHRocm93cyBhbiBlcnJvciBhcyBhbiBpbnZhbGlkIHZhbHVlCglqUXVlcnkuYXR0ckhvb2tzLmNvbnRlbnRlZGl0YWJsZSA9IHsKCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSwgbmFtZSApIHsKCQkJbm9kZUhvb2suc2V0KCBlbGVtLCB2YWx1ZSA9PT0gIiIgPyBmYWxzZSA6IHZhbHVlLCBuYW1lICk7CgkJfQoJfTsKCgkvLyBTZXQgd2lkdGggYW5kIGhlaWdodCB0byBhdXRvIGluc3RlYWQgb2YgMCBvbiBlbXB0eSBzdHJpbmcoIEJ1ZyAjODE1MCApCgkvLyBUaGlzIGlzIGZvciByZW1vdmFscwoJalF1ZXJ5LmVhY2goWyAid2lkdGgiLCAiaGVpZ2h0IiBdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCQlqUXVlcnkuYXR0ckhvb2tzWyBuYW1lIF0gPSB7CgkJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgewoJCQkJaWYgKCB2YWx1ZSA9PT0gIiIgKSB7CgkJCQkJZWxlbS5zZXRBdHRyaWJ1dGUoIG5hbWUsICJhdXRvIiApOwoJCQkJCXJldHVybiB2YWx1ZTsKCQkJCX0KCQkJfQoJCX07Cgl9KTsKfQoKaWYgKCAhc3VwcG9ydC5zdHlsZSApIHsKCWpRdWVyeS5hdHRySG9va3Muc3R5bGUgPSB7CgkJZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsKCQkJLy8gUmV0dXJuIHVuZGVmaW5lZCBpbiB0aGUgY2FzZSBvZiBlbXB0eSBzdHJpbmcKCQkJLy8gTm90ZTogSUUgdXBwZXJjYXNlcyBjc3MgcHJvcGVydHkgbmFtZXMsIGJ1dCBpZiB3ZSB3ZXJlIHRvIC50b0xvd2VyQ2FzZSgpCgkJCS8vIC5jc3NUZXh0LCB0aGF0IHdvdWxkIGRlc3Ryb3kgY2FzZSBzZW5zdGl0aXZpdHkgaW4gVVJMJ3MsIGxpa2UgaW4gImJhY2tncm91bmQiCgkJCXJldHVybiBlbGVtLnN0eWxlLmNzc1RleHQgfHwgdW5kZWZpbmVkOwoJCX0sCgkJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7CgkJCXJldHVybiAoIGVsZW0uc3R5bGUuY3NzVGV4dCA9IHZhbHVlICsgIiIgKTsKCQl9Cgl9Owp9CgoKCgp2YXIgcmZvY3VzYWJsZSA9IC9eKD86aW5wdXR8c2VsZWN0fHRleHRhcmVhfGJ1dHRvbnxvYmplY3QpJC9pLAoJcmNsaWNrYWJsZSA9IC9eKD86YXxhcmVhKSQvaTsKCmpRdWVyeS5mbi5leHRlbmQoewoJcHJvcDogZnVuY3Rpb24oIG5hbWUsIHZhbHVlICkgewoJCXJldHVybiBhY2Nlc3MoIHRoaXMsIGpRdWVyeS5wcm9wLCBuYW1lLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEgKTsKCX0sCgoJcmVtb3ZlUHJvcDogZnVuY3Rpb24oIG5hbWUgKSB7CgkJbmFtZSA9IGpRdWVyeS5wcm9wRml4WyBuYW1lIF0gfHwgbmFtZTsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkvLyB0cnkvY2F0Y2ggaGFuZGxlcyBjYXNlcyB3aGVyZSBJRSBiYWxrcyAoc3VjaCBhcyByZW1vdmluZyBhIHByb3BlcnR5IG9uIHdpbmRvdykKCQkJdHJ5IHsKCQkJCXRoaXNbIG5hbWUgXSA9IHVuZGVmaW5lZDsKCQkJCWRlbGV0ZSB0aGlzWyBuYW1lIF07CgkJCX0gY2F0Y2goIGUgKSB7fQoJCX0pOwoJfQp9KTsKCmpRdWVyeS5leHRlbmQoewoJcHJvcEZpeDogewoJCSJmb3IiOiAiaHRtbEZvciIsCgkJImNsYXNzIjogImNsYXNzTmFtZSIKCX0sCgoJcHJvcDogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIHZhbHVlICkgewoJCXZhciByZXQsIGhvb2tzLCBub3R4bWwsCgkJCW5UeXBlID0gZWxlbS5ub2RlVHlwZTsKCgkJLy8gZG9uJ3QgZ2V0L3NldCBwcm9wZXJ0aWVzIG9uIHRleHQsIGNvbW1lbnQgYW5kIGF0dHJpYnV0ZSBub2RlcwoJCWlmICggIWVsZW0gfHwgblR5cGUgPT09IDMgfHwgblR5cGUgPT09IDggfHwgblR5cGUgPT09IDIgKSB7CgkJCXJldHVybjsKCQl9CgoJCW5vdHhtbCA9IG5UeXBlICE9PSAxIHx8ICFqUXVlcnkuaXNYTUxEb2MoIGVsZW0gKTsKCgkJaWYgKCBub3R4bWwgKSB7CgkJCS8vIEZpeCBuYW1lIGFuZCBhdHRhY2ggaG9va3MKCQkJbmFtZSA9IGpRdWVyeS5wcm9wRml4WyBuYW1lIF0gfHwgbmFtZTsKCQkJaG9va3MgPSBqUXVlcnkucHJvcEhvb2tzWyBuYW1lIF07CgkJfQoKCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiBob29rcyAmJiAic2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3Muc2V0KCBlbGVtLCB2YWx1ZSwgbmFtZSApKSAhPT0gdW5kZWZpbmVkID8KCQkJCXJldCA6CgkJCQkoIGVsZW1bIG5hbWUgXSA9IHZhbHVlICk7CgoJCX0gZWxzZSB7CgkJCXJldHVybiBob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KCBlbGVtLCBuYW1lICkpICE9PSBudWxsID8KCQkJCXJldCA6CgkJCQllbGVtWyBuYW1lIF07CgkJfQoJfSwKCglwcm9wSG9va3M6IHsKCQl0YWJJbmRleDogewoJCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJLy8gZWxlbS50YWJJbmRleCBkb2Vzbid0IGFsd2F5cyByZXR1cm4gdGhlIGNvcnJlY3QgdmFsdWUgd2hlbiBpdCBoYXNuJ3QgYmVlbiBleHBsaWNpdGx5IHNldAoJCQkJLy8gaHR0cDovL2ZsdWlkcHJvamVjdC5vcmcvYmxvZy8yMDA4LzAxLzA5L2dldHRpbmctc2V0dGluZy1hbmQtcmVtb3ZpbmctdGFiaW5kZXgtdmFsdWVzLXdpdGgtamF2YXNjcmlwdC8KCQkJCS8vIFVzZSBwcm9wZXIgYXR0cmlidXRlIHJldHJpZXZhbCgjMTIwNzIpCgkJCQl2YXIgdGFiaW5kZXggPSBqUXVlcnkuZmluZC5hdHRyKCBlbGVtLCAidGFiaW5kZXgiICk7CgoJCQkJcmV0dXJuIHRhYmluZGV4ID8KCQkJCQlwYXJzZUludCggdGFiaW5kZXgsIDEwICkgOgoJCQkJCXJmb2N1c2FibGUudGVzdCggZWxlbS5ub2RlTmFtZSApIHx8IHJjbGlja2FibGUudGVzdCggZWxlbS5ub2RlTmFtZSApICYmIGVsZW0uaHJlZiA/CgkJCQkJCTAgOgoJCQkJCQktMTsKCQkJfQoJCX0KCX0KfSk7CgovLyBTb21lIGF0dHJpYnV0ZXMgcmVxdWlyZSBhIHNwZWNpYWwgY2FsbCBvbiBJRQovLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM1MzY0MjklMjhWUy44NSUyOS5hc3B4CmlmICggIXN1cHBvcnQuaHJlZk5vcm1hbGl6ZWQgKSB7CgkvLyBocmVmL3NyYyBwcm9wZXJ0eSBzaG91bGQgZ2V0IHRoZSBmdWxsIG5vcm1hbGl6ZWQgVVJMICgjMTAyOTkvIzEyOTE1KQoJalF1ZXJ5LmVhY2goWyAiaHJlZiIsICJzcmMiIF0sIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoJCWpRdWVyeS5wcm9wSG9va3NbIG5hbWUgXSA9IHsKCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSggbmFtZSwgNCApOwoJCQl9CgkJfTsKCX0pOwp9CgovLyBTdXBwb3J0OiBTYWZhcmksIElFOSsKLy8gbWlzLXJlcG9ydHMgdGhlIGRlZmF1bHQgc2VsZWN0ZWQgcHJvcGVydHkgb2YgYW4gb3B0aW9uCi8vIEFjY2Vzc2luZyB0aGUgcGFyZW50J3Mgc2VsZWN0ZWRJbmRleCBwcm9wZXJ0eSBmaXhlcyBpdAppZiAoICFzdXBwb3J0Lm9wdFNlbGVjdGVkICkgewoJalF1ZXJ5LnByb3BIb29rcy5zZWxlY3RlZCA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQl2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwoKCQkJaWYgKCBwYXJlbnQgKSB7CgkJCQlwYXJlbnQuc2VsZWN0ZWRJbmRleDsKCgkJCQkvLyBNYWtlIHN1cmUgdGhhdCBpdCBhbHNvIHdvcmtzIHdpdGggb3B0Z3JvdXBzLCBzZWUgIzU3MDEKCQkJCWlmICggcGFyZW50LnBhcmVudE5vZGUgKSB7CgkJCQkJcGFyZW50LnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleDsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9Owp9CgpqUXVlcnkuZWFjaChbCgkidGFiSW5kZXgiLAoJInJlYWRPbmx5IiwKCSJtYXhMZW5ndGgiLAoJImNlbGxTcGFjaW5nIiwKCSJjZWxsUGFkZGluZyIsCgkicm93U3BhbiIsCgkiY29sU3BhbiIsCgkidXNlTWFwIiwKCSJmcmFtZUJvcmRlciIsCgkiY29udGVudEVkaXRhYmxlIgpdLCBmdW5jdGlvbigpIHsKCWpRdWVyeS5wcm9wRml4WyB0aGlzLnRvTG93ZXJDYXNlKCkgXSA9IHRoaXM7Cn0pOwoKLy8gSUU2LzcgY2FsbCBlbmN0eXBlIGVuY29kaW5nCmlmICggIXN1cHBvcnQuZW5jdHlwZSApIHsKCWpRdWVyeS5wcm9wRml4LmVuY3R5cGUgPSAiZW5jb2RpbmciOwp9CgoKCgp2YXIgcmNsYXNzID0gL1tcdFxyXG5cZl0vZzsKCmpRdWVyeS5mbi5leHRlbmQoewoJYWRkQ2xhc3M6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YXIgY2xhc3NlcywgZWxlbSwgY3VyLCBjbGF6eiwgaiwgZmluYWxWYWx1ZSwKCQkJaSA9IDAsCgkJCWxlbiA9IHRoaXMubGVuZ3RoLAoJCQlwcm9jZWVkID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiAmJiB2YWx1ZTsKCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaiApIHsKCQkJCWpRdWVyeSggdGhpcyApLmFkZENsYXNzKCB2YWx1ZS5jYWxsKCB0aGlzLCBqLCB0aGlzLmNsYXNzTmFtZSApICk7CgkJCX0pOwoJCX0KCgkJaWYgKCBwcm9jZWVkICkgewoJCQkvLyBUaGUgZGlzanVuY3Rpb24gaGVyZSBpcyBmb3IgYmV0dGVyIGNvbXByZXNzaWJpbGl0eSAoc2VlIHJlbW92ZUNsYXNzKQoJCQljbGFzc2VzID0gKCB2YWx1ZSB8fCAiIiApLm1hdGNoKCBybm90d2hpdGUgKSB8fCBbXTsKCgkJCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgewoJCQkJZWxlbSA9IHRoaXNbIGkgXTsKCQkJCWN1ciA9IGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgKCBlbGVtLmNsYXNzTmFtZSA/CgkJCQkJKCAiICIgKyBlbGVtLmNsYXNzTmFtZSArICIgIiApLnJlcGxhY2UoIHJjbGFzcywgIiAiICkgOgoJCQkJCSIgIgoJCQkJKTsKCgkJCQlpZiAoIGN1ciApIHsKCQkJCQlqID0gMDsKCQkJCQl3aGlsZSAoIChjbGF6eiA9IGNsYXNzZXNbaisrXSkgKSB7CgkJCQkJCWlmICggY3VyLmluZGV4T2YoICIgIiArIGNsYXp6ICsgIiAiICkgPCAwICkgewoJCQkJCQkJY3VyICs9IGNsYXp6ICsgIiAiOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQkvLyBvbmx5IGFzc2lnbiBpZiBkaWZmZXJlbnQgdG8gYXZvaWQgdW5uZWVkZWQgcmVuZGVyaW5nLgoJCQkJCWZpbmFsVmFsdWUgPSBqUXVlcnkudHJpbSggY3VyICk7CgkJCQkJaWYgKCBlbGVtLmNsYXNzTmFtZSAhPT0gZmluYWxWYWx1ZSApIHsKCQkJCQkJZWxlbS5jbGFzc05hbWUgPSBmaW5hbFZhbHVlOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUNsYXNzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIGNsYXNzZXMsIGVsZW0sIGN1ciwgY2xhenosIGosIGZpbmFsVmFsdWUsCgkJCWkgPSAwLAoJCQlsZW4gPSB0aGlzLmxlbmd0aCwKCQkJcHJvY2VlZCA9IGFyZ3VtZW50cy5sZW5ndGggPT09IDAgfHwgdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiAmJiB2YWx1ZTsKCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaiApIHsKCQkJCWpRdWVyeSggdGhpcyApLnJlbW92ZUNsYXNzKCB2YWx1ZS5jYWxsKCB0aGlzLCBqLCB0aGlzLmNsYXNzTmFtZSApICk7CgkJCX0pOwoJCX0KCQlpZiAoIHByb2NlZWQgKSB7CgkJCWNsYXNzZXMgPSAoIHZhbHVlIHx8ICIiICkubWF0Y2goIHJub3R3aGl0ZSApIHx8IFtdOwoKCQkJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CgkJCQllbGVtID0gdGhpc1sgaSBdOwoJCQkJLy8gVGhpcyBleHByZXNzaW9uIGlzIGhlcmUgZm9yIGJldHRlciBjb21wcmVzc2liaWxpdHkgKHNlZSBhZGRDbGFzcykKCQkJCWN1ciA9IGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgKCBlbGVtLmNsYXNzTmFtZSA/CgkJCQkJKCAiICIgKyBlbGVtLmNsYXNzTmFtZSArICIgIiApLnJlcGxhY2UoIHJjbGFzcywgIiAiICkgOgoJCQkJCSIiCgkJCQkpOwoKCQkJCWlmICggY3VyICkgewoJCQkJCWogPSAwOwoJCQkJCXdoaWxlICggKGNsYXp6ID0gY2xhc3Nlc1tqKytdKSApIHsKCQkJCQkJLy8gUmVtb3ZlICphbGwqIGluc3RhbmNlcwoJCQkJCQl3aGlsZSAoIGN1ci5pbmRleE9mKCAiICIgKyBjbGF6eiArICIgIiApID49IDAgKSB7CgkJCQkJCQljdXIgPSBjdXIucmVwbGFjZSggIiAiICsgY2xhenogKyAiICIsICIgIiApOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQkvLyBvbmx5IGFzc2lnbiBpZiBkaWZmZXJlbnQgdG8gYXZvaWQgdW5uZWVkZWQgcmVuZGVyaW5nLgoJCQkJCWZpbmFsVmFsdWUgPSB2YWx1ZSA/IGpRdWVyeS50cmltKCBjdXIgKSA6ICIiOwoJCQkJCWlmICggZWxlbS5jbGFzc05hbWUgIT09IGZpbmFsVmFsdWUgKSB7CgkJCQkJCWVsZW0uY2xhc3NOYW1lID0gZmluYWxWYWx1ZTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgl0b2dnbGVDbGFzczogZnVuY3Rpb24oIHZhbHVlLCBzdGF0ZVZhbCApIHsKCQl2YXIgdHlwZSA9IHR5cGVvZiB2YWx1ZTsKCgkJaWYgKCB0eXBlb2Ygc3RhdGVWYWwgPT09ICJib29sZWFuIiAmJiB0eXBlID09PSAic3RyaW5nIiApIHsKCQkJcmV0dXJuIHN0YXRlVmFsID8gdGhpcy5hZGRDbGFzcyggdmFsdWUgKSA6IHRoaXMucmVtb3ZlQ2xhc3MoIHZhbHVlICk7CgkJfQoKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQkJalF1ZXJ5KCB0aGlzICkudG9nZ2xlQ2xhc3MoIHZhbHVlLmNhbGwodGhpcywgaSwgdGhpcy5jbGFzc05hbWUsIHN0YXRlVmFsKSwgc3RhdGVWYWwgKTsKCQkJfSk7CgkJfQoKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoIHR5cGUgPT09ICJzdHJpbmciICkgewoJCQkJLy8gdG9nZ2xlIGluZGl2aWR1YWwgY2xhc3MgbmFtZXMKCQkJCXZhciBjbGFzc05hbWUsCgkJCQkJaSA9IDAsCgkJCQkJc2VsZiA9IGpRdWVyeSggdGhpcyApLAoJCQkJCWNsYXNzTmFtZXMgPSB2YWx1ZS5tYXRjaCggcm5vdHdoaXRlICkgfHwgW107CgoJCQkJd2hpbGUgKCAoY2xhc3NOYW1lID0gY2xhc3NOYW1lc1sgaSsrIF0pICkgewoJCQkJCS8vIGNoZWNrIGVhY2ggY2xhc3NOYW1lIGdpdmVuLCBzcGFjZSBzZXBhcmF0ZWQgbGlzdAoJCQkJCWlmICggc2VsZi5oYXNDbGFzcyggY2xhc3NOYW1lICkgKSB7CgkJCQkJCXNlbGYucmVtb3ZlQ2xhc3MoIGNsYXNzTmFtZSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXNlbGYuYWRkQ2xhc3MoIGNsYXNzTmFtZSApOwoJCQkJCX0KCQkJCX0KCgkJCS8vIFRvZ2dsZSB3aG9sZSBjbGFzcyBuYW1lCgkJCX0gZWxzZSBpZiAoIHR5cGUgPT09IHN0cnVuZGVmaW5lZCB8fCB0eXBlID09PSAiYm9vbGVhbiIgKSB7CgkJCQlpZiAoIHRoaXMuY2xhc3NOYW1lICkgewoJCQkJCS8vIHN0b3JlIGNsYXNzTmFtZSBpZiBzZXQKCQkJCQlqUXVlcnkuX2RhdGEoIHRoaXMsICJfX2NsYXNzTmFtZV9fIiwgdGhpcy5jbGFzc05hbWUgKTsKCQkJCX0KCgkJCQkvLyBJZiB0aGUgZWxlbWVudCBoYXMgYSBjbGFzcyBuYW1lIG9yIGlmIHdlJ3JlIHBhc3NlZCAiZmFsc2UiLAoJCQkJLy8gdGhlbiByZW1vdmUgdGhlIHdob2xlIGNsYXNzbmFtZSAoaWYgdGhlcmUgd2FzIG9uZSwgdGhlIGFib3ZlIHNhdmVkIGl0KS4KCQkJCS8vIE90aGVyd2lzZSBicmluZyBiYWNrIHdoYXRldmVyIHdhcyBwcmV2aW91c2x5IHNhdmVkIChpZiBhbnl0aGluZyksCgkJCQkvLyBmYWxsaW5nIGJhY2sgdG8gdGhlIGVtcHR5IHN0cmluZyBpZiBub3RoaW5nIHdhcyBzdG9yZWQuCgkJCQl0aGlzLmNsYXNzTmFtZSA9IHRoaXMuY2xhc3NOYW1lIHx8IHZhbHVlID09PSBmYWxzZSA/ICIiIDogalF1ZXJ5Ll9kYXRhKCB0aGlzLCAiX19jbGFzc05hbWVfXyIgKSB8fCAiIjsKCQkJfQoJCX0pOwoJfSwKCgloYXNDbGFzczogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXZhciBjbGFzc05hbWUgPSAiICIgKyBzZWxlY3RvciArICIgIiwKCQkJaSA9IDAsCgkJCWwgPSB0aGlzLmxlbmd0aDsKCQlmb3IgKCA7IGkgPCBsOyBpKysgKSB7CgkJCWlmICggdGhpc1tpXS5ub2RlVHlwZSA9PT0gMSAmJiAoIiAiICsgdGhpc1tpXS5jbGFzc05hbWUgKyAiICIpLnJlcGxhY2UocmNsYXNzLCAiICIpLmluZGV4T2YoIGNsYXNzTmFtZSApID49IDAgKSB7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCgkJcmV0dXJuIGZhbHNlOwoJfQp9KTsKCgoKCi8vIFJldHVybiBqUXVlcnkgZm9yIGF0dHJpYnV0ZXMtb25seSBpbmNsdXNpb24KCgpqUXVlcnkuZWFjaCggKCJibHVyIGZvY3VzIGZvY3VzaW4gZm9jdXNvdXQgbG9hZCByZXNpemUgc2Nyb2xsIHVubG9hZCBjbGljayBkYmxjbGljayAiICsKCSJtb3VzZWRvd24gbW91c2V1cCBtb3VzZW1vdmUgbW91c2VvdmVyIG1vdXNlb3V0IG1vdXNlZW50ZXIgbW91c2VsZWF2ZSAiICsKCSJjaGFuZ2Ugc2VsZWN0IHN1Ym1pdCBrZXlkb3duIGtleXByZXNzIGtleXVwIGVycm9yIGNvbnRleHRtZW51Iikuc3BsaXQoIiAiKSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgoJLy8gSGFuZGxlIGV2ZW50IGJpbmRpbmcKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIGRhdGEsIGZuICkgewoJCXJldHVybiBhcmd1bWVudHMubGVuZ3RoID4gMCA/CgkJCXRoaXMub24oIG5hbWUsIG51bGwsIGRhdGEsIGZuICkgOgoJCQl0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCX07Cn0pOwoKalF1ZXJ5LmZuLmV4dGVuZCh7Cglob3ZlcjogZnVuY3Rpb24oIGZuT3ZlciwgZm5PdXQgKSB7CgkJcmV0dXJuIHRoaXMubW91c2VlbnRlciggZm5PdmVyICkubW91c2VsZWF2ZSggZm5PdXQgfHwgZm5PdmVyICk7Cgl9LAoKCWJpbmQ6IGZ1bmN0aW9uKCB0eXBlcywgZGF0YSwgZm4gKSB7CgkJcmV0dXJuIHRoaXMub24oIHR5cGVzLCBudWxsLCBkYXRhLCBmbiApOwoJfSwKCXVuYmluZDogZnVuY3Rpb24oIHR5cGVzLCBmbiApIHsKCQlyZXR1cm4gdGhpcy5vZmYoIHR5cGVzLCBudWxsLCBmbiApOwoJfSwKCglkZWxlZ2F0ZTogZnVuY3Rpb24oIHNlbGVjdG9yLCB0eXBlcywgZGF0YSwgZm4gKSB7CgkJcmV0dXJuIHRoaXMub24oIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4gKTsKCX0sCgl1bmRlbGVnYXRlOiBmdW5jdGlvbiggc2VsZWN0b3IsIHR5cGVzLCBmbiApIHsKCQkvLyAoIG5hbWVzcGFjZSApIG9yICggc2VsZWN0b3IsIHR5cGVzIFssIGZuXSApCgkJcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPyB0aGlzLm9mZiggc2VsZWN0b3IsICIqKiIgKSA6IHRoaXMub2ZmKCB0eXBlcywgc2VsZWN0b3IgfHwgIioqIiwgZm4gKTsKCX0KfSk7CgoKdmFyIG5vbmNlID0galF1ZXJ5Lm5vdygpOwoKdmFyIHJxdWVyeSA9ICgvXD8vKTsKCgoKdmFyIHJ2YWxpZHRva2VucyA9IC8oLCl8KFxbfHspfCh9fF0pfCIoPzpbXiJcXFxyXG5dfFxcWyJcXFwvYmZucnRdfFxcdVtcZGEtZkEtRl17NH0pKiJccyo6P3x0cnVlfGZhbHNlfG51bGx8LT8oPyEwXGQpXGQrKD86XC5cZCt8KSg/OltlRV1bKy1dP1xkK3wpL2c7CgpqUXVlcnkucGFyc2VKU09OID0gZnVuY3Rpb24oIGRhdGEgKSB7CgkvLyBBdHRlbXB0IHRvIHBhcnNlIHVzaW5nIHRoZSBuYXRpdmUgSlNPTiBwYXJzZXIgZmlyc3QKCWlmICggd2luZG93LkpTT04gJiYgd2luZG93LkpTT04ucGFyc2UgKSB7CgkJLy8gU3VwcG9ydDogQW5kcm9pZCAyLjMKCQkvLyBXb3JrYXJvdW5kIGZhaWx1cmUgdG8gc3RyaW5nLWNhc3QgbnVsbCBpbnB1dAoJCXJldHVybiB3aW5kb3cuSlNPTi5wYXJzZSggZGF0YSArICIiICk7Cgl9CgoJdmFyIHJlcXVpcmVOb25Db21tYSwKCQlkZXB0aCA9IG51bGwsCgkJc3RyID0galF1ZXJ5LnRyaW0oIGRhdGEgKyAiIiApOwoKCS8vIEd1YXJkIGFnYWluc3QgaW52YWxpZCAoYW5kIHBvc3NpYmx5IGRhbmdlcm91cykgaW5wdXQgYnkgZW5zdXJpbmcgdGhhdCBub3RoaW5nIHJlbWFpbnMKCS8vIGFmdGVyIHJlbW92aW5nIHZhbGlkIHRva2VucwoJcmV0dXJuIHN0ciAmJiAhalF1ZXJ5LnRyaW0oIHN0ci5yZXBsYWNlKCBydmFsaWR0b2tlbnMsIGZ1bmN0aW9uKCB0b2tlbiwgY29tbWEsIG9wZW4sIGNsb3NlICkgewoKCQkvLyBGb3JjZSB0ZXJtaW5hdGlvbiBpZiB3ZSBzZWUgYSBtaXNwbGFjZWQgY29tbWEKCQlpZiAoIHJlcXVpcmVOb25Db21tYSAmJiBjb21tYSApIHsKCQkJZGVwdGggPSAwOwoJCX0KCgkJLy8gUGVyZm9ybSBubyBtb3JlIHJlcGxhY2VtZW50cyBhZnRlciByZXR1cm5pbmcgdG8gb3V0ZXJtb3N0IGRlcHRoCgkJaWYgKCBkZXB0aCA9PT0gMCApIHsKCQkJcmV0dXJuIHRva2VuOwoJCX0KCgkJLy8gQ29tbWFzIG11c3Qgbm90IGZvbGxvdyAiWyIsICJ7Iiwgb3IgIiwiCgkJcmVxdWlyZU5vbkNvbW1hID0gb3BlbiB8fCBjb21tYTsKCgkJLy8gRGV0ZXJtaW5lIG5ldyBkZXB0aAoJCS8vIGFycmF5L29iamVjdCBvcGVuICgiWyIgb3IgInsiKTogZGVwdGggKz0gdHJ1ZSAtIGZhbHNlIChpbmNyZW1lbnQpCgkJLy8gYXJyYXkvb2JqZWN0IGNsb3NlICgiXSIgb3IgIn0iKTogZGVwdGggKz0gZmFsc2UgLSB0cnVlIChkZWNyZW1lbnQpCgkJLy8gb3RoZXIgY2FzZXMgKCIsIiBvciBwcmltaXRpdmUpOiBkZXB0aCArPSB0cnVlIC0gdHJ1ZSAobnVtZXJpYyBjYXN0KQoJCWRlcHRoICs9ICFjbG9zZSAtICFvcGVuOwoKCQkvLyBSZW1vdmUgdGhpcyB0b2tlbgoJCXJldHVybiAiIjsKCX0pICkgPwoJCSggRnVuY3Rpb24oICJyZXR1cm4gIiArIHN0ciApICkoKSA6CgkJalF1ZXJ5LmVycm9yKCAiSW52YWxpZCBKU09OOiAiICsgZGF0YSApOwp9OwoKCi8vIENyb3NzLWJyb3dzZXIgeG1sIHBhcnNpbmcKalF1ZXJ5LnBhcnNlWE1MID0gZnVuY3Rpb24oIGRhdGEgKSB7Cgl2YXIgeG1sLCB0bXA7CglpZiAoICFkYXRhIHx8IHR5cGVvZiBkYXRhICE9PSAic3RyaW5nIiApIHsKCQlyZXR1cm4gbnVsbDsKCX0KCXRyeSB7CgkJaWYgKCB3aW5kb3cuRE9NUGFyc2VyICkgeyAvLyBTdGFuZGFyZAoJCQl0bXAgPSBuZXcgRE9NUGFyc2VyKCk7CgkJCXhtbCA9IHRtcC5wYXJzZUZyb21TdHJpbmcoIGRhdGEsICJ0ZXh0L3htbCIgKTsKCQl9IGVsc2UgeyAvLyBJRQoJCQl4bWwgPSBuZXcgQWN0aXZlWE9iamVjdCggIk1pY3Jvc29mdC5YTUxET00iICk7CgkJCXhtbC5hc3luYyA9ICJmYWxzZSI7CgkJCXhtbC5sb2FkWE1MKCBkYXRhICk7CgkJfQoJfSBjYXRjaCggZSApIHsKCQl4bWwgPSB1bmRlZmluZWQ7Cgl9CglpZiAoICF4bWwgfHwgIXhtbC5kb2N1bWVudEVsZW1lbnQgfHwgeG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKCAicGFyc2VyZXJyb3IiICkubGVuZ3RoICkgewoJCWpRdWVyeS5lcnJvciggIkludmFsaWQgWE1MOiAiICsgZGF0YSApOwoJfQoJcmV0dXJuIHhtbDsKfTsKCgp2YXIKCS8vIERvY3VtZW50IGxvY2F0aW9uCglhamF4TG9jUGFydHMsCglhamF4TG9jYXRpb24sCgoJcmhhc2ggPSAvIy4qJC8sCglydHMgPSAvKFs/Jl0pXz1bXiZdKi8sCglyaGVhZGVycyA9IC9eKC4qPyk6WyBcdF0qKFteXHJcbl0qKVxyPyQvbWcsIC8vIElFIGxlYXZlcyBhbiBcciBjaGFyYWN0ZXIgYXQgRU9MCgkvLyAjNzY1MywgIzgxMjUsICM4MTUyOiBsb2NhbCBwcm90b2NvbCBkZXRlY3Rpb24KCXJsb2NhbFByb3RvY29sID0gL14oPzphYm91dHxhcHB8YXBwLXN0b3JhZ2V8ListZXh0ZW5zaW9ufGZpbGV8cmVzfHdpZGdldCk6JC8sCglybm9Db250ZW50ID0gL14oPzpHRVR8SEVBRCkkLywKCXJwcm90b2NvbCA9IC9eXC9cLy8sCglydXJsID0gL14oW1x3ListXSs6KSg/OlwvXC8oPzpbXlwvPyNdKkB8KShbXlwvPyM6XSopKD86OihcZCspfCl8KS8sCgoJLyogUHJlZmlsdGVycwoJICogMSkgVGhleSBhcmUgdXNlZnVsIHRvIGludHJvZHVjZSBjdXN0b20gZGF0YVR5cGVzIChzZWUgYWpheC9qc29ucC5qcyBmb3IgYW4gZXhhbXBsZSkKCSAqIDIpIFRoZXNlIGFyZSBjYWxsZWQ6CgkgKiAgICAtIEJFRk9SRSBhc2tpbmcgZm9yIGEgdHJhbnNwb3J0CgkgKiAgICAtIEFGVEVSIHBhcmFtIHNlcmlhbGl6YXRpb24gKHMuZGF0YSBpcyBhIHN0cmluZyBpZiBzLnByb2Nlc3NEYXRhIGlzIHRydWUpCgkgKiAzKSBrZXkgaXMgdGhlIGRhdGFUeXBlCgkgKiA0KSB0aGUgY2F0Y2hhbGwgc3ltYm9sICIqIiBjYW4gYmUgdXNlZAoJICogNSkgZXhlY3V0aW9uIHdpbGwgc3RhcnQgd2l0aCB0cmFuc3BvcnQgZGF0YVR5cGUgYW5kIFRIRU4gY29udGludWUgZG93biB0byAiKiIgaWYgbmVlZGVkCgkgKi8KCXByZWZpbHRlcnMgPSB7fSwKCgkvKiBUcmFuc3BvcnRzIGJpbmRpbmdzCgkgKiAxKSBrZXkgaXMgdGhlIGRhdGFUeXBlCgkgKiAyKSB0aGUgY2F0Y2hhbGwgc3ltYm9sICIqIiBjYW4gYmUgdXNlZAoJICogMykgc2VsZWN0aW9uIHdpbGwgc3RhcnQgd2l0aCB0cmFuc3BvcnQgZGF0YVR5cGUgYW5kIFRIRU4gZ28gdG8gIioiIGlmIG5lZWRlZAoJICovCgl0cmFuc3BvcnRzID0ge30sCgoJLy8gQXZvaWQgY29tbWVudC1wcm9sb2cgY2hhciBzZXF1ZW5jZSAoIzEwMDk4KTsgbXVzdCBhcHBlYXNlIGxpbnQgYW5kIGV2YWRlIGNvbXByZXNzaW9uCglhbGxUeXBlcyA9ICIqLyIuY29uY2F0KCIqIik7CgovLyAjODEzOCwgSUUgbWF5IHRocm93IGFuIGV4Y2VwdGlvbiB3aGVuIGFjY2Vzc2luZwovLyBhIGZpZWxkIGZyb20gd2luZG93LmxvY2F0aW9uIGlmIGRvY3VtZW50LmRvbWFpbiBoYXMgYmVlbiBzZXQKdHJ5IHsKCWFqYXhMb2NhdGlvbiA9IGxvY2F0aW9uLmhyZWY7Cn0gY2F0Y2goIGUgKSB7CgkvLyBVc2UgdGhlIGhyZWYgYXR0cmlidXRlIG9mIGFuIEEgZWxlbWVudAoJLy8gc2luY2UgSUUgd2lsbCBtb2RpZnkgaXQgZ2l2ZW4gZG9jdW1lbnQubG9jYXRpb24KCWFqYXhMb2NhdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJhIiApOwoJYWpheExvY2F0aW9uLmhyZWYgPSAiIjsKCWFqYXhMb2NhdGlvbiA9IGFqYXhMb2NhdGlvbi5ocmVmOwp9CgovLyBTZWdtZW50IGxvY2F0aW9uIGludG8gcGFydHMKYWpheExvY1BhcnRzID0gcnVybC5leGVjKCBhamF4TG9jYXRpb24udG9Mb3dlckNhc2UoKSApIHx8IFtdOwoKLy8gQmFzZSAiY29uc3RydWN0b3IiIGZvciBqUXVlcnkuYWpheFByZWZpbHRlciBhbmQgalF1ZXJ5LmFqYXhUcmFuc3BvcnQKZnVuY3Rpb24gYWRkVG9QcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKCBzdHJ1Y3R1cmUgKSB7CgoJLy8gZGF0YVR5cGVFeHByZXNzaW9uIGlzIG9wdGlvbmFsIGFuZCBkZWZhdWx0cyB0byAiKiIKCXJldHVybiBmdW5jdGlvbiggZGF0YVR5cGVFeHByZXNzaW9uLCBmdW5jICkgewoKCQlpZiAoIHR5cGVvZiBkYXRhVHlwZUV4cHJlc3Npb24gIT09ICJzdHJpbmciICkgewoJCQlmdW5jID0gZGF0YVR5cGVFeHByZXNzaW9uOwoJCQlkYXRhVHlwZUV4cHJlc3Npb24gPSAiKiI7CgkJfQoKCQl2YXIgZGF0YVR5cGUsCgkJCWkgPSAwLAoJCQlkYXRhVHlwZXMgPSBkYXRhVHlwZUV4cHJlc3Npb24udG9Mb3dlckNhc2UoKS5tYXRjaCggcm5vdHdoaXRlICkgfHwgW107CgoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIGZ1bmMgKSApIHsKCQkJLy8gRm9yIGVhY2ggZGF0YVR5cGUgaW4gdGhlIGRhdGFUeXBlRXhwcmVzc2lvbgoJCQl3aGlsZSAoIChkYXRhVHlwZSA9IGRhdGFUeXBlc1tpKytdKSApIHsKCQkJCS8vIFByZXBlbmQgaWYgcmVxdWVzdGVkCgkJCQlpZiAoIGRhdGFUeXBlLmNoYXJBdCggMCApID09PSAiKyIgKSB7CgkJCQkJZGF0YVR5cGUgPSBkYXRhVHlwZS5zbGljZSggMSApIHx8ICIqIjsKCQkJCQkoc3RydWN0dXJlWyBkYXRhVHlwZSBdID0gc3RydWN0dXJlWyBkYXRhVHlwZSBdIHx8IFtdKS51bnNoaWZ0KCBmdW5jICk7CgoJCQkJLy8gT3RoZXJ3aXNlIGFwcGVuZAoJCQkJfSBlbHNlIHsKCQkJCQkoc3RydWN0dXJlWyBkYXRhVHlwZSBdID0gc3RydWN0dXJlWyBkYXRhVHlwZSBdIHx8IFtdKS5wdXNoKCBmdW5jICk7CgkJCQl9CgkJCX0KCQl9Cgl9Owp9CgovLyBCYXNlIGluc3BlY3Rpb24gZnVuY3Rpb24gZm9yIHByZWZpbHRlcnMgYW5kIHRyYW5zcG9ydHMKZnVuY3Rpb24gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHN0cnVjdHVyZSwgb3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUiApIHsKCgl2YXIgaW5zcGVjdGVkID0ge30sCgkJc2Vla2luZ1RyYW5zcG9ydCA9ICggc3RydWN0dXJlID09PSB0cmFuc3BvcnRzICk7CgoJZnVuY3Rpb24gaW5zcGVjdCggZGF0YVR5cGUgKSB7CgkJdmFyIHNlbGVjdGVkOwoJCWluc3BlY3RlZFsgZGF0YVR5cGUgXSA9IHRydWU7CgkJalF1ZXJ5LmVhY2goIHN0cnVjdHVyZVsgZGF0YVR5cGUgXSB8fCBbXSwgZnVuY3Rpb24oIF8sIHByZWZpbHRlck9yRmFjdG9yeSApIHsKCQkJdmFyIGRhdGFUeXBlT3JUcmFuc3BvcnQgPSBwcmVmaWx0ZXJPckZhY3RvcnkoIG9wdGlvbnMsIG9yaWdpbmFsT3B0aW9ucywganFYSFIgKTsKCQkJaWYgKCB0eXBlb2YgZGF0YVR5cGVPclRyYW5zcG9ydCA9PT0gInN0cmluZyIgJiYgIXNlZWtpbmdUcmFuc3BvcnQgJiYgIWluc3BlY3RlZFsgZGF0YVR5cGVPclRyYW5zcG9ydCBdICkgewoJCQkJb3B0aW9ucy5kYXRhVHlwZXMudW5zaGlmdCggZGF0YVR5cGVPclRyYW5zcG9ydCApOwoJCQkJaW5zcGVjdCggZGF0YVR5cGVPclRyYW5zcG9ydCApOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9IGVsc2UgaWYgKCBzZWVraW5nVHJhbnNwb3J0ICkgewoJCQkJcmV0dXJuICEoIHNlbGVjdGVkID0gZGF0YVR5cGVPclRyYW5zcG9ydCApOwoJCQl9CgkJfSk7CgkJcmV0dXJuIHNlbGVjdGVkOwoJfQoKCXJldHVybiBpbnNwZWN0KCBvcHRpb25zLmRhdGFUeXBlc1sgMCBdICkgfHwgIWluc3BlY3RlZFsgIioiIF0gJiYgaW5zcGVjdCggIioiICk7Cn0KCi8vIEEgc3BlY2lhbCBleHRlbmQgZm9yIGFqYXggb3B0aW9ucwovLyB0aGF0IHRha2VzICJmbGF0IiBvcHRpb25zIChub3QgdG8gYmUgZGVlcCBleHRlbmRlZCkKLy8gRml4ZXMgIzk4ODcKZnVuY3Rpb24gYWpheEV4dGVuZCggdGFyZ2V0LCBzcmMgKSB7Cgl2YXIgZGVlcCwga2V5LAoJCWZsYXRPcHRpb25zID0galF1ZXJ5LmFqYXhTZXR0aW5ncy5mbGF0T3B0aW9ucyB8fCB7fTsKCglmb3IgKCBrZXkgaW4gc3JjICkgewoJCWlmICggc3JjWyBrZXkgXSAhPT0gdW5kZWZpbmVkICkgewoJCQkoIGZsYXRPcHRpb25zWyBrZXkgXSA/IHRhcmdldCA6ICggZGVlcCB8fCAoZGVlcCA9IHt9KSApIClbIGtleSBdID0gc3JjWyBrZXkgXTsKCQl9Cgl9CglpZiAoIGRlZXAgKSB7CgkJalF1ZXJ5LmV4dGVuZCggdHJ1ZSwgdGFyZ2V0LCBkZWVwICk7Cgl9CgoJcmV0dXJuIHRhcmdldDsKfQoKLyogSGFuZGxlcyByZXNwb25zZXMgdG8gYW4gYWpheCByZXF1ZXN0OgogKiAtIGZpbmRzIHRoZSByaWdodCBkYXRhVHlwZSAobWVkaWF0ZXMgYmV0d2VlbiBjb250ZW50LXR5cGUgYW5kIGV4cGVjdGVkIGRhdGFUeXBlKQogKiAtIHJldHVybnMgdGhlIGNvcnJlc3BvbmRpbmcgcmVzcG9uc2UKICovCmZ1bmN0aW9uIGFqYXhIYW5kbGVSZXNwb25zZXMoIHMsIGpxWEhSLCByZXNwb25zZXMgKSB7Cgl2YXIgZmlyc3REYXRhVHlwZSwgY3QsIGZpbmFsRGF0YVR5cGUsIHR5cGUsCgkJY29udGVudHMgPSBzLmNvbnRlbnRzLAoJCWRhdGFUeXBlcyA9IHMuZGF0YVR5cGVzOwoKCS8vIFJlbW92ZSBhdXRvIGRhdGFUeXBlIGFuZCBnZXQgY29udGVudC10eXBlIGluIHRoZSBwcm9jZXNzCgl3aGlsZSAoIGRhdGFUeXBlc1sgMCBdID09PSAiKiIgKSB7CgkJZGF0YVR5cGVzLnNoaWZ0KCk7CgkJaWYgKCBjdCA9PT0gdW5kZWZpbmVkICkgewoJCQljdCA9IHMubWltZVR5cGUgfHwganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoIkNvbnRlbnQtVHlwZSIpOwoJCX0KCX0KCgkvLyBDaGVjayBpZiB3ZSdyZSBkZWFsaW5nIHdpdGggYSBrbm93biBjb250ZW50LXR5cGUKCWlmICggY3QgKSB7CgkJZm9yICggdHlwZSBpbiBjb250ZW50cyApIHsKCQkJaWYgKCBjb250ZW50c1sgdHlwZSBdICYmIGNvbnRlbnRzWyB0eXBlIF0udGVzdCggY3QgKSApIHsKCQkJCWRhdGFUeXBlcy51bnNoaWZ0KCB0eXBlICk7CgkJCQlicmVhazsKCQkJfQoJCX0KCX0KCgkvLyBDaGVjayB0byBzZWUgaWYgd2UgaGF2ZSBhIHJlc3BvbnNlIGZvciB0aGUgZXhwZWN0ZWQgZGF0YVR5cGUKCWlmICggZGF0YVR5cGVzWyAwIF0gaW4gcmVzcG9uc2VzICkgewoJCWZpbmFsRGF0YVR5cGUgPSBkYXRhVHlwZXNbIDAgXTsKCX0gZWxzZSB7CgkJLy8gVHJ5IGNvbnZlcnRpYmxlIGRhdGFUeXBlcwoJCWZvciAoIHR5cGUgaW4gcmVzcG9uc2VzICkgewoJCQlpZiAoICFkYXRhVHlwZXNbIDAgXSB8fCBzLmNvbnZlcnRlcnNbIHR5cGUgKyAiICIgKyBkYXRhVHlwZXNbMF0gXSApIHsKCQkJCWZpbmFsRGF0YVR5cGUgPSB0eXBlOwoJCQkJYnJlYWs7CgkJCX0KCQkJaWYgKCAhZmlyc3REYXRhVHlwZSApIHsKCQkJCWZpcnN0RGF0YVR5cGUgPSB0eXBlOwoJCQl9CgkJfQoJCS8vIE9yIGp1c3QgdXNlIGZpcnN0IG9uZQoJCWZpbmFsRGF0YVR5cGUgPSBmaW5hbERhdGFUeXBlIHx8IGZpcnN0RGF0YVR5cGU7Cgl9CgoJLy8gSWYgd2UgZm91bmQgYSBkYXRhVHlwZQoJLy8gV2UgYWRkIHRoZSBkYXRhVHlwZSB0byB0aGUgbGlzdCBpZiBuZWVkZWQKCS8vIGFuZCByZXR1cm4gdGhlIGNvcnJlc3BvbmRpbmcgcmVzcG9uc2UKCWlmICggZmluYWxEYXRhVHlwZSApIHsKCQlpZiAoIGZpbmFsRGF0YVR5cGUgIT09IGRhdGFUeXBlc1sgMCBdICkgewoJCQlkYXRhVHlwZXMudW5zaGlmdCggZmluYWxEYXRhVHlwZSApOwoJCX0KCQlyZXR1cm4gcmVzcG9uc2VzWyBmaW5hbERhdGFUeXBlIF07Cgl9Cn0KCi8qIENoYWluIGNvbnZlcnNpb25zIGdpdmVuIHRoZSByZXF1ZXN0IGFuZCB0aGUgb3JpZ2luYWwgcmVzcG9uc2UKICogQWxzbyBzZXRzIHRoZSByZXNwb25zZVhYWCBmaWVsZHMgb24gdGhlIGpxWEhSIGluc3RhbmNlCiAqLwpmdW5jdGlvbiBhamF4Q29udmVydCggcywgcmVzcG9uc2UsIGpxWEhSLCBpc1N1Y2Nlc3MgKSB7Cgl2YXIgY29udjIsIGN1cnJlbnQsIGNvbnYsIHRtcCwgcHJldiwKCQljb252ZXJ0ZXJzID0ge30sCgkJLy8gV29yayB3aXRoIGEgY29weSBvZiBkYXRhVHlwZXMgaW4gY2FzZSB3ZSBuZWVkIHRvIG1vZGlmeSBpdCBmb3IgY29udmVyc2lvbgoJCWRhdGFUeXBlcyA9IHMuZGF0YVR5cGVzLnNsaWNlKCk7CgoJLy8gQ3JlYXRlIGNvbnZlcnRlcnMgbWFwIHdpdGggbG93ZXJjYXNlZCBrZXlzCglpZiAoIGRhdGFUeXBlc1sgMSBdICkgewoJCWZvciAoIGNvbnYgaW4gcy5jb252ZXJ0ZXJzICkgewoJCQljb252ZXJ0ZXJzWyBjb252LnRvTG93ZXJDYXNlKCkgXSA9IHMuY29udmVydGVyc1sgY29udiBdOwoJCX0KCX0KCgljdXJyZW50ID0gZGF0YVR5cGVzLnNoaWZ0KCk7CgoJLy8gQ29udmVydCB0byBlYWNoIHNlcXVlbnRpYWwgZGF0YVR5cGUKCXdoaWxlICggY3VycmVudCApIHsKCgkJaWYgKCBzLnJlc3BvbnNlRmllbGRzWyBjdXJyZW50IF0gKSB7CgkJCWpxWEhSWyBzLnJlc3BvbnNlRmllbGRzWyBjdXJyZW50IF0gXSA9IHJlc3BvbnNlOwoJCX0KCgkJLy8gQXBwbHkgdGhlIGRhdGFGaWx0ZXIgaWYgcHJvdmlkZWQKCQlpZiAoICFwcmV2ICYmIGlzU3VjY2VzcyAmJiBzLmRhdGFGaWx0ZXIgKSB7CgkJCXJlc3BvbnNlID0gcy5kYXRhRmlsdGVyKCByZXNwb25zZSwgcy5kYXRhVHlwZSApOwoJCX0KCgkJcHJldiA9IGN1cnJlbnQ7CgkJY3VycmVudCA9IGRhdGFUeXBlcy5zaGlmdCgpOwoKCQlpZiAoIGN1cnJlbnQgKSB7CgoJCQkvLyBUaGVyZSdzIG9ubHkgd29yayB0byBkbyBpZiBjdXJyZW50IGRhdGFUeXBlIGlzIG5vbi1hdXRvCgkJCWlmICggY3VycmVudCA9PT0gIioiICkgewoKCQkJCWN1cnJlbnQgPSBwcmV2OwoKCQkJLy8gQ29udmVydCByZXNwb25zZSBpZiBwcmV2IGRhdGFUeXBlIGlzIG5vbi1hdXRvIGFuZCBkaWZmZXJzIGZyb20gY3VycmVudAoJCQl9IGVsc2UgaWYgKCBwcmV2ICE9PSAiKiIgJiYgcHJldiAhPT0gY3VycmVudCApIHsKCgkJCQkvLyBTZWVrIGEgZGlyZWN0IGNvbnZlcnRlcgoJCQkJY29udiA9IGNvbnZlcnRlcnNbIHByZXYgKyAiICIgKyBjdXJyZW50IF0gfHwgY29udmVydGVyc1sgIiogIiArIGN1cnJlbnQgXTsKCgkJCQkvLyBJZiBub25lIGZvdW5kLCBzZWVrIGEgcGFpcgoJCQkJaWYgKCAhY29udiApIHsKCQkJCQlmb3IgKCBjb252MiBpbiBjb252ZXJ0ZXJzICkgewoKCQkJCQkJLy8gSWYgY29udjIgb3V0cHV0cyBjdXJyZW50CgkJCQkJCXRtcCA9IGNvbnYyLnNwbGl0KCAiICIgKTsKCQkJCQkJaWYgKCB0bXBbIDEgXSA9PT0gY3VycmVudCApIHsKCgkJCQkJCQkvLyBJZiBwcmV2IGNhbiBiZSBjb252ZXJ0ZWQgdG8gYWNjZXB0ZWQgaW5wdXQKCQkJCQkJCWNvbnYgPSBjb252ZXJ0ZXJzWyBwcmV2ICsgIiAiICsgdG1wWyAwIF0gXSB8fAoJCQkJCQkJCWNvbnZlcnRlcnNbICIqICIgKyB0bXBbIDAgXSBdOwoJCQkJCQkJaWYgKCBjb252ICkgewoJCQkJCQkJCS8vIENvbmRlbnNlIGVxdWl2YWxlbmNlIGNvbnZlcnRlcnMKCQkJCQkJCQlpZiAoIGNvbnYgPT09IHRydWUgKSB7CgkJCQkJCQkJCWNvbnYgPSBjb252ZXJ0ZXJzWyBjb252MiBdOwoKCQkJCQkJCQkvLyBPdGhlcndpc2UsIGluc2VydCB0aGUgaW50ZXJtZWRpYXRlIGRhdGFUeXBlCgkJCQkJCQkJfSBlbHNlIGlmICggY29udmVydGVyc1sgY29udjIgXSAhPT0gdHJ1ZSApIHsKCQkJCQkJCQkJY3VycmVudCA9IHRtcFsgMCBdOwoJCQkJCQkJCQlkYXRhVHlwZXMudW5zaGlmdCggdG1wWyAxIF0gKTsKCQkJCQkJCQl9CgkJCQkJCQkJYnJlYWs7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgoJCQkJLy8gQXBwbHkgY29udmVydGVyIChpZiBub3QgYW4gZXF1aXZhbGVuY2UpCgkJCQlpZiAoIGNvbnYgIT09IHRydWUgKSB7CgoJCQkJCS8vIFVubGVzcyBlcnJvcnMgYXJlIGFsbG93ZWQgdG8gYnViYmxlLCBjYXRjaCBhbmQgcmV0dXJuIHRoZW0KCQkJCQlpZiAoIGNvbnYgJiYgc1sgInRocm93cyIgXSApIHsKCQkJCQkJcmVzcG9uc2UgPSBjb252KCByZXNwb25zZSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRyeSB7CgkJCQkJCQlyZXNwb25zZSA9IGNvbnYoIHJlc3BvbnNlICk7CgkJCQkJCX0gY2F0Y2ggKCBlICkgewoJCQkJCQkJcmV0dXJuIHsgc3RhdGU6ICJwYXJzZXJlcnJvciIsIGVycm9yOiBjb252ID8gZSA6ICJObyBjb252ZXJzaW9uIGZyb20gIiArIHByZXYgKyAiIHRvICIgKyBjdXJyZW50IH07CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIHsgc3RhdGU6ICJzdWNjZXNzIiwgZGF0YTogcmVzcG9uc2UgfTsKfQoKalF1ZXJ5LmV4dGVuZCh7CgoJLy8gQ291bnRlciBmb3IgaG9sZGluZyB0aGUgbnVtYmVyIG9mIGFjdGl2ZSBxdWVyaWVzCglhY3RpdmU6IDAsCgoJLy8gTGFzdC1Nb2RpZmllZCBoZWFkZXIgY2FjaGUgZm9yIG5leHQgcmVxdWVzdAoJbGFzdE1vZGlmaWVkOiB7fSwKCWV0YWc6IHt9LAoKCWFqYXhTZXR0aW5nczogewoJCXVybDogYWpheExvY2F0aW9uLAoJCXR5cGU6ICJHRVQiLAoJCWlzTG9jYWw6IHJsb2NhbFByb3RvY29sLnRlc3QoIGFqYXhMb2NQYXJ0c1sgMSBdICksCgkJZ2xvYmFsOiB0cnVlLAoJCXByb2Nlc3NEYXRhOiB0cnVlLAoJCWFzeW5jOiB0cnVlLAoJCWNvbnRlbnRUeXBlOiAiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkOyBjaGFyc2V0PVVURi04IiwKCQkvKgoJCXRpbWVvdXQ6IDAsCgkJZGF0YTogbnVsbCwKCQlkYXRhVHlwZTogbnVsbCwKCQl1c2VybmFtZTogbnVsbCwKCQlwYXNzd29yZDogbnVsbCwKCQljYWNoZTogbnVsbCwKCQl0aHJvd3M6IGZhbHNlLAoJCXRyYWRpdGlvbmFsOiBmYWxzZSwKCQloZWFkZXJzOiB7fSwKCQkqLwoKCQlhY2NlcHRzOiB7CgkJCSIqIjogYWxsVHlwZXMsCgkJCXRleHQ6ICJ0ZXh0L3BsYWluIiwKCQkJaHRtbDogInRleHQvaHRtbCIsCgkJCXhtbDogImFwcGxpY2F0aW9uL3htbCwgdGV4dC94bWwiLAoJCQlqc29uOiAiYXBwbGljYXRpb24vanNvbiwgdGV4dC9qYXZhc2NyaXB0IgoJCX0sCgoJCWNvbnRlbnRzOiB7CgkJCXhtbDogL3htbC8sCgkJCWh0bWw6IC9odG1sLywKCQkJanNvbjogL2pzb24vCgkJfSwKCgkJcmVzcG9uc2VGaWVsZHM6IHsKCQkJeG1sOiAicmVzcG9uc2VYTUwiLAoJCQl0ZXh0OiAicmVzcG9uc2VUZXh0IiwKCQkJanNvbjogInJlc3BvbnNlSlNPTiIKCQl9LAoKCQkvLyBEYXRhIGNvbnZlcnRlcnMKCQkvLyBLZXlzIHNlcGFyYXRlIHNvdXJjZSAob3IgY2F0Y2hhbGwgIioiKSBhbmQgZGVzdGluYXRpb24gdHlwZXMgd2l0aCBhIHNpbmdsZSBzcGFjZQoJCWNvbnZlcnRlcnM6IHsKCgkJCS8vIENvbnZlcnQgYW55dGhpbmcgdG8gdGV4dAoJCQkiKiB0ZXh0IjogU3RyaW5nLAoKCQkJLy8gVGV4dCB0byBodG1sICh0cnVlID0gbm8gdHJhbnNmb3JtYXRpb24pCgkJCSJ0ZXh0IGh0bWwiOiB0cnVlLAoKCQkJLy8gRXZhbHVhdGUgdGV4dCBhcyBhIGpzb24gZXhwcmVzc2lvbgoJCQkidGV4dCBqc29uIjogalF1ZXJ5LnBhcnNlSlNPTiwKCgkJCS8vIFBhcnNlIHRleHQgYXMgeG1sCgkJCSJ0ZXh0IHhtbCI6IGpRdWVyeS5wYXJzZVhNTAoJCX0sCgoJCS8vIEZvciBvcHRpb25zIHRoYXQgc2hvdWxkbid0IGJlIGRlZXAgZXh0ZW5kZWQ6CgkJLy8geW91IGNhbiBhZGQgeW91ciBvd24gY3VzdG9tIG9wdGlvbnMgaGVyZSBpZgoJCS8vIGFuZCB3aGVuIHlvdSBjcmVhdGUgb25lIHRoYXQgc2hvdWxkbid0IGJlCgkJLy8gZGVlcCBleHRlbmRlZCAoc2VlIGFqYXhFeHRlbmQpCgkJZmxhdE9wdGlvbnM6IHsKCQkJdXJsOiB0cnVlLAoJCQljb250ZXh0OiB0cnVlCgkJfQoJfSwKCgkvLyBDcmVhdGVzIGEgZnVsbCBmbGVkZ2VkIHNldHRpbmdzIG9iamVjdCBpbnRvIHRhcmdldAoJLy8gd2l0aCBib3RoIGFqYXhTZXR0aW5ncyBhbmQgc2V0dGluZ3MgZmllbGRzLgoJLy8gSWYgdGFyZ2V0IGlzIG9taXR0ZWQsIHdyaXRlcyBpbnRvIGFqYXhTZXR0aW5ncy4KCWFqYXhTZXR1cDogZnVuY3Rpb24oIHRhcmdldCwgc2V0dGluZ3MgKSB7CgkJcmV0dXJuIHNldHRpbmdzID8KCgkJCS8vIEJ1aWxkaW5nIGEgc2V0dGluZ3Mgb2JqZWN0CgkJCWFqYXhFeHRlbmQoIGFqYXhFeHRlbmQoIHRhcmdldCwgalF1ZXJ5LmFqYXhTZXR0aW5ncyApLCBzZXR0aW5ncyApIDoKCgkJCS8vIEV4dGVuZGluZyBhamF4U2V0dGluZ3MKCQkJYWpheEV4dGVuZCggalF1ZXJ5LmFqYXhTZXR0aW5ncywgdGFyZ2V0ICk7Cgl9LAoKCWFqYXhQcmVmaWx0ZXI6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyggcHJlZmlsdGVycyApLAoJYWpheFRyYW5zcG9ydDogYWRkVG9QcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKCB0cmFuc3BvcnRzICksCgoJLy8gTWFpbiBtZXRob2QKCWFqYXg6IGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMgKSB7CgoJCS8vIElmIHVybCBpcyBhbiBvYmplY3QsIHNpbXVsYXRlIHByZS0xLjUgc2lnbmF0dXJlCgkJaWYgKCB0eXBlb2YgdXJsID09PSAib2JqZWN0IiApIHsKCQkJb3B0aW9ucyA9IHVybDsKCQkJdXJsID0gdW5kZWZpbmVkOwoJCX0KCgkJLy8gRm9yY2Ugb3B0aW9ucyB0byBiZSBhbiBvYmplY3QKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCgkJdmFyIC8vIENyb3NzLWRvbWFpbiBkZXRlY3Rpb24gdmFycwoJCQlwYXJ0cywKCQkJLy8gTG9vcCB2YXJpYWJsZQoJCQlpLAoJCQkvLyBVUkwgd2l0aG91dCBhbnRpLWNhY2hlIHBhcmFtCgkJCWNhY2hlVVJMLAoJCQkvLyBSZXNwb25zZSBoZWFkZXJzIGFzIHN0cmluZwoJCQlyZXNwb25zZUhlYWRlcnNTdHJpbmcsCgkJCS8vIHRpbWVvdXQgaGFuZGxlCgkJCXRpbWVvdXRUaW1lciwKCgkJCS8vIFRvIGtub3cgaWYgZ2xvYmFsIGV2ZW50cyBhcmUgdG8gYmUgZGlzcGF0Y2hlZAoJCQlmaXJlR2xvYmFscywKCgkJCXRyYW5zcG9ydCwKCQkJLy8gUmVzcG9uc2UgaGVhZGVycwoJCQlyZXNwb25zZUhlYWRlcnMsCgkJCS8vIENyZWF0ZSB0aGUgZmluYWwgb3B0aW9ucyBvYmplY3QKCQkJcyA9IGpRdWVyeS5hamF4U2V0dXAoIHt9LCBvcHRpb25zICksCgkJCS8vIENhbGxiYWNrcyBjb250ZXh0CgkJCWNhbGxiYWNrQ29udGV4dCA9IHMuY29udGV4dCB8fCBzLAoJCQkvLyBDb250ZXh0IGZvciBnbG9iYWwgZXZlbnRzIGlzIGNhbGxiYWNrQ29udGV4dCBpZiBpdCBpcyBhIERPTSBub2RlIG9yIGpRdWVyeSBjb2xsZWN0aW9uCgkJCWdsb2JhbEV2ZW50Q29udGV4dCA9IHMuY29udGV4dCAmJiAoIGNhbGxiYWNrQ29udGV4dC5ub2RlVHlwZSB8fCBjYWxsYmFja0NvbnRleHQuanF1ZXJ5ICkgPwoJCQkJalF1ZXJ5KCBjYWxsYmFja0NvbnRleHQgKSA6CgkJCQlqUXVlcnkuZXZlbnQsCgkJCS8vIERlZmVycmVkcwoJCQlkZWZlcnJlZCA9IGpRdWVyeS5EZWZlcnJlZCgpLAoJCQljb21wbGV0ZURlZmVycmVkID0galF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwKCQkJLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKCQkJc3RhdHVzQ29kZSA9IHMuc3RhdHVzQ29kZSB8fCB7fSwKCQkJLy8gSGVhZGVycyAodGhleSBhcmUgc2VudCBhbGwgYXQgb25jZSkKCQkJcmVxdWVzdEhlYWRlcnMgPSB7fSwKCQkJcmVxdWVzdEhlYWRlcnNOYW1lcyA9IHt9LAoJCQkvLyBUaGUganFYSFIgc3RhdGUKCQkJc3RhdGUgPSAwLAoJCQkvLyBEZWZhdWx0IGFib3J0IG1lc3NhZ2UKCQkJc3RyQWJvcnQgPSAiY2FuY2VsZWQiLAoJCQkvLyBGYWtlIHhocgoJCQlqcVhIUiA9IHsKCQkJCXJlYWR5U3RhdGU6IDAsCgoJCQkJLy8gQnVpbGRzIGhlYWRlcnMgaGFzaHRhYmxlIGlmIG5lZWRlZAoJCQkJZ2V0UmVzcG9uc2VIZWFkZXI6IGZ1bmN0aW9uKCBrZXkgKSB7CgkJCQkJdmFyIG1hdGNoOwoJCQkJCWlmICggc3RhdGUgPT09IDIgKSB7CgkJCQkJCWlmICggIXJlc3BvbnNlSGVhZGVycyApIHsKCQkJCQkJCXJlc3BvbnNlSGVhZGVycyA9IHt9OwoJCQkJCQkJd2hpbGUgKCAobWF0Y2ggPSByaGVhZGVycy5leGVjKCByZXNwb25zZUhlYWRlcnNTdHJpbmcgKSkgKSB7CgkJCQkJCQkJcmVzcG9uc2VIZWFkZXJzWyBtYXRjaFsxXS50b0xvd2VyQ2FzZSgpIF0gPSBtYXRjaFsgMiBdOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJCW1hdGNoID0gcmVzcG9uc2VIZWFkZXJzWyBrZXkudG9Mb3dlckNhc2UoKSBdOwoJCQkJCX0KCQkJCQlyZXR1cm4gbWF0Y2ggPT0gbnVsbCA/IG51bGwgOiBtYXRjaDsKCQkJCX0sCgoJCQkJLy8gUmF3IHN0cmluZwoJCQkJZ2V0QWxsUmVzcG9uc2VIZWFkZXJzOiBmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gc3RhdGUgPT09IDIgPyByZXNwb25zZUhlYWRlcnNTdHJpbmcgOiBudWxsOwoJCQkJfSwKCgkJCQkvLyBDYWNoZXMgdGhlIGhlYWRlcgoJCQkJc2V0UmVxdWVzdEhlYWRlcjogZnVuY3Rpb24oIG5hbWUsIHZhbHVlICkgewoJCQkJCXZhciBsbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKCQkJCQlpZiAoICFzdGF0ZSApIHsKCQkJCQkJbmFtZSA9IHJlcXVlc3RIZWFkZXJzTmFtZXNbIGxuYW1lIF0gPSByZXF1ZXN0SGVhZGVyc05hbWVzWyBsbmFtZSBdIHx8IG5hbWU7CgkJCQkJCXJlcXVlc3RIZWFkZXJzWyBuYW1lIF0gPSB2YWx1ZTsKCQkJCQl9CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9LAoKCQkJCS8vIE92ZXJyaWRlcyByZXNwb25zZSBjb250ZW50LXR5cGUgaGVhZGVyCgkJCQlvdmVycmlkZU1pbWVUeXBlOiBmdW5jdGlvbiggdHlwZSApIHsKCQkJCQlpZiAoICFzdGF0ZSApIHsKCQkJCQkJcy5taW1lVHlwZSA9IHR5cGU7CgkJCQkJfQoJCQkJCXJldHVybiB0aGlzOwoJCQkJfSwKCgkJCQkvLyBTdGF0dXMtZGVwZW5kZW50IGNhbGxiYWNrcwoJCQkJc3RhdHVzQ29kZTogZnVuY3Rpb24oIG1hcCApIHsKCQkJCQl2YXIgY29kZTsKCQkJCQlpZiAoIG1hcCApIHsKCQkJCQkJaWYgKCBzdGF0ZSA8IDIgKSB7CgkJCQkJCQlmb3IgKCBjb2RlIGluIG1hcCApIHsKCQkJCQkJCQkvLyBMYXp5LWFkZCB0aGUgbmV3IGNhbGxiYWNrIGluIGEgd2F5IHRoYXQgcHJlc2VydmVzIG9sZCBvbmVzCgkJCQkJCQkJc3RhdHVzQ29kZVsgY29kZSBdID0gWyBzdGF0dXNDb2RlWyBjb2RlIF0sIG1hcFsgY29kZSBdIF07CgkJCQkJCQl9CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQkvLyBFeGVjdXRlIHRoZSBhcHByb3ByaWF0ZSBjYWxsYmFja3MKCQkJCQkJCWpxWEhSLmFsd2F5cyggbWFwWyBqcVhIUi5zdGF0dXMgXSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXJldHVybiB0aGlzOwoJCQkJfSwKCgkJCQkvLyBDYW5jZWwgdGhlIHJlcXVlc3QKCQkJCWFib3J0OiBmdW5jdGlvbiggc3RhdHVzVGV4dCApIHsKCQkJCQl2YXIgZmluYWxUZXh0ID0gc3RhdHVzVGV4dCB8fCBzdHJBYm9ydDsKCQkJCQlpZiAoIHRyYW5zcG9ydCApIHsKCQkJCQkJdHJhbnNwb3J0LmFib3J0KCBmaW5hbFRleHQgKTsKCQkJCQl9CgkJCQkJZG9uZSggMCwgZmluYWxUZXh0ICk7CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9CgkJCX07CgoJCS8vIEF0dGFjaCBkZWZlcnJlZHMKCQlkZWZlcnJlZC5wcm9taXNlKCBqcVhIUiApLmNvbXBsZXRlID0gY29tcGxldGVEZWZlcnJlZC5hZGQ7CgkJanFYSFIuc3VjY2VzcyA9IGpxWEhSLmRvbmU7CgkJanFYSFIuZXJyb3IgPSBqcVhIUi5mYWlsOwoKCQkvLyBSZW1vdmUgaGFzaCBjaGFyYWN0ZXIgKCM3NTMxOiBhbmQgc3RyaW5nIHByb21vdGlvbikKCQkvLyBBZGQgcHJvdG9jb2wgaWYgbm90IHByb3ZpZGVkICgjNTg2NjogSUU3IGlzc3VlIHdpdGggcHJvdG9jb2wtbGVzcyB1cmxzKQoJCS8vIEhhbmRsZSBmYWxzeSB1cmwgaW4gdGhlIHNldHRpbmdzIG9iamVjdCAoIzEwMDkzOiBjb25zaXN0ZW5jeSB3aXRoIG9sZCBzaWduYXR1cmUpCgkJLy8gV2UgYWxzbyB1c2UgdGhlIHVybCBwYXJhbWV0ZXIgaWYgYXZhaWxhYmxlCgkJcy51cmwgPSAoICggdXJsIHx8IHMudXJsIHx8IGFqYXhMb2NhdGlvbiApICsgIiIgKS5yZXBsYWNlKCByaGFzaCwgIiIgKS5yZXBsYWNlKCBycHJvdG9jb2wsIGFqYXhMb2NQYXJ0c1sgMSBdICsgIi8vIiApOwoKCQkvLyBBbGlhcyBtZXRob2Qgb3B0aW9uIHRvIHR5cGUgYXMgcGVyIHRpY2tldCAjMTIwMDQKCQlzLnR5cGUgPSBvcHRpb25zLm1ldGhvZCB8fCBvcHRpb25zLnR5cGUgfHwgcy5tZXRob2QgfHwgcy50eXBlOwoKCQkvLyBFeHRyYWN0IGRhdGFUeXBlcyBsaXN0CgkJcy5kYXRhVHlwZXMgPSBqUXVlcnkudHJpbSggcy5kYXRhVHlwZSB8fCAiKiIgKS50b0xvd2VyQ2FzZSgpLm1hdGNoKCBybm90d2hpdGUgKSB8fCBbICIiIF07CgoJCS8vIEEgY3Jvc3MtZG9tYWluIHJlcXVlc3QgaXMgaW4gb3JkZXIgd2hlbiB3ZSBoYXZlIGEgcHJvdG9jb2w6aG9zdDpwb3J0IG1pc21hdGNoCgkJaWYgKCBzLmNyb3NzRG9tYWluID09IG51bGwgKSB7CgkJCXBhcnRzID0gcnVybC5leGVjKCBzLnVybC50b0xvd2VyQ2FzZSgpICk7CgkJCXMuY3Jvc3NEb21haW4gPSAhISggcGFydHMgJiYKCQkJCSggcGFydHNbIDEgXSAhPT0gYWpheExvY1BhcnRzWyAxIF0gfHwgcGFydHNbIDIgXSAhPT0gYWpheExvY1BhcnRzWyAyIF0gfHwKCQkJCQkoIHBhcnRzWyAzIF0gfHwgKCBwYXJ0c1sgMSBdID09PSAiaHR0cDoiID8gIjgwIiA6ICI0NDMiICkgKSAhPT0KCQkJCQkJKCBhamF4TG9jUGFydHNbIDMgXSB8fCAoIGFqYXhMb2NQYXJ0c1sgMSBdID09PSAiaHR0cDoiID8gIjgwIiA6ICI0NDMiICkgKSApCgkJCSk7CgkJfQoKCQkvLyBDb252ZXJ0IGRhdGEgaWYgbm90IGFscmVhZHkgYSBzdHJpbmcKCQlpZiAoIHMuZGF0YSAmJiBzLnByb2Nlc3NEYXRhICYmIHR5cGVvZiBzLmRhdGEgIT09ICJzdHJpbmciICkgewoJCQlzLmRhdGEgPSBqUXVlcnkucGFyYW0oIHMuZGF0YSwgcy50cmFkaXRpb25hbCApOwoJCX0KCgkJLy8gQXBwbHkgcHJlZmlsdGVycwoJCWluc3BlY3RQcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKCBwcmVmaWx0ZXJzLCBzLCBvcHRpb25zLCBqcVhIUiApOwoKCQkvLyBJZiByZXF1ZXN0IHdhcyBhYm9ydGVkIGluc2lkZSBhIHByZWZpbHRlciwgc3RvcCB0aGVyZQoJCWlmICggc3RhdGUgPT09IDIgKSB7CgkJCXJldHVybiBqcVhIUjsKCQl9CgoJCS8vIFdlIGNhbiBmaXJlIGdsb2JhbCBldmVudHMgYXMgb2Ygbm93IGlmIGFza2VkIHRvCgkJZmlyZUdsb2JhbHMgPSBzLmdsb2JhbDsKCgkJLy8gV2F0Y2ggZm9yIGEgbmV3IHNldCBvZiByZXF1ZXN0cwoJCWlmICggZmlyZUdsb2JhbHMgJiYgalF1ZXJ5LmFjdGl2ZSsrID09PSAwICkgewoJCQlqUXVlcnkuZXZlbnQudHJpZ2dlcigiYWpheFN0YXJ0Iik7CgkJfQoKCQkvLyBVcHBlcmNhc2UgdGhlIHR5cGUKCQlzLnR5cGUgPSBzLnR5cGUudG9VcHBlckNhc2UoKTsKCgkJLy8gRGV0ZXJtaW5lIGlmIHJlcXVlc3QgaGFzIGNvbnRlbnQKCQlzLmhhc0NvbnRlbnQgPSAhcm5vQ29udGVudC50ZXN0KCBzLnR5cGUgKTsKCgkJLy8gU2F2ZSB0aGUgVVJMIGluIGNhc2Ugd2UncmUgdG95aW5nIHdpdGggdGhlIElmLU1vZGlmaWVkLVNpbmNlCgkJLy8gYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyIGxhdGVyIG9uCgkJY2FjaGVVUkwgPSBzLnVybDsKCgkJLy8gTW9yZSBvcHRpb25zIGhhbmRsaW5nIGZvciByZXF1ZXN0cyB3aXRoIG5vIGNvbnRlbnQKCQlpZiAoICFzLmhhc0NvbnRlbnQgKSB7CgoJCQkvLyBJZiBkYXRhIGlzIGF2YWlsYWJsZSwgYXBwZW5kIGRhdGEgdG8gdXJsCgkJCWlmICggcy5kYXRhICkgewoJCQkJY2FjaGVVUkwgPSAoIHMudXJsICs9ICggcnF1ZXJ5LnRlc3QoIGNhY2hlVVJMICkgPyAiJiIgOiAiPyIgKSArIHMuZGF0YSApOwoJCQkJLy8gIzk2ODI6IHJlbW92ZSBkYXRhIHNvIHRoYXQgaXQncyBub3QgdXNlZCBpbiBhbiBldmVudHVhbCByZXRyeQoJCQkJZGVsZXRlIHMuZGF0YTsKCQkJfQoKCQkJLy8gQWRkIGFudGktY2FjaGUgaW4gdXJsIGlmIG5lZWRlZAoJCQlpZiAoIHMuY2FjaGUgPT09IGZhbHNlICkgewoJCQkJcy51cmwgPSBydHMudGVzdCggY2FjaGVVUkwgKSA/CgoJCQkJCS8vIElmIHRoZXJlIGlzIGFscmVhZHkgYSAnXycgcGFyYW1ldGVyLCBzZXQgaXRzIHZhbHVlCgkJCQkJY2FjaGVVUkwucmVwbGFjZSggcnRzLCAiJDFfPSIgKyBub25jZSsrICkgOgoKCQkJCQkvLyBPdGhlcndpc2UgYWRkIG9uZSB0byB0aGUgZW5kCgkJCQkJY2FjaGVVUkwgKyAoIHJxdWVyeS50ZXN0KCBjYWNoZVVSTCApID8gIiYiIDogIj8iICkgKyAiXz0iICsgbm9uY2UrKzsKCQkJfQoJCX0KCgkJLy8gU2V0IHRoZSBJZi1Nb2RpZmllZC1TaW5jZSBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIsIGlmIGluIGlmTW9kaWZpZWQgbW9kZS4KCQlpZiAoIHMuaWZNb2RpZmllZCApIHsKCQkJaWYgKCBqUXVlcnkubGFzdE1vZGlmaWVkWyBjYWNoZVVSTCBdICkgewoJCQkJanFYSFIuc2V0UmVxdWVzdEhlYWRlciggIklmLU1vZGlmaWVkLVNpbmNlIiwgalF1ZXJ5Lmxhc3RNb2RpZmllZFsgY2FjaGVVUkwgXSApOwoJCQl9CgkJCWlmICggalF1ZXJ5LmV0YWdbIGNhY2hlVVJMIF0gKSB7CgkJCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCAiSWYtTm9uZS1NYXRjaCIsIGpRdWVyeS5ldGFnWyBjYWNoZVVSTCBdICk7CgkJCX0KCQl9CgoJCS8vIFNldCB0aGUgY29ycmVjdCBoZWFkZXIsIGlmIGRhdGEgaXMgYmVpbmcgc2VudAoJCWlmICggcy5kYXRhICYmIHMuaGFzQ29udGVudCAmJiBzLmNvbnRlbnRUeXBlICE9PSBmYWxzZSB8fCBvcHRpb25zLmNvbnRlbnRUeXBlICkgewoJCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCAiQ29udGVudC1UeXBlIiwgcy5jb250ZW50VHlwZSApOwoJCX0KCgkJLy8gU2V0IHRoZSBBY2NlcHRzIGhlYWRlciBmb3IgdGhlIHNlcnZlciwgZGVwZW5kaW5nIG9uIHRoZSBkYXRhVHlwZQoJCWpxWEhSLnNldFJlcXVlc3RIZWFkZXIoCgkJCSJBY2NlcHQiLAoJCQlzLmRhdGFUeXBlc1sgMCBdICYmIHMuYWNjZXB0c1sgcy5kYXRhVHlwZXNbMF0gXSA/CgkJCQlzLmFjY2VwdHNbIHMuZGF0YVR5cGVzWzBdIF0gKyAoIHMuZGF0YVR5cGVzWyAwIF0gIT09ICIqIiA/ICIsICIgKyBhbGxUeXBlcyArICI7IHE9MC4wMSIgOiAiIiApIDoKCQkJCXMuYWNjZXB0c1sgIioiIF0KCQkpOwoKCQkvLyBDaGVjayBmb3IgaGVhZGVycyBvcHRpb24KCQlmb3IgKCBpIGluIHMuaGVhZGVycyApIHsKCQkJanFYSFIuc2V0UmVxdWVzdEhlYWRlciggaSwgcy5oZWFkZXJzWyBpIF0gKTsKCQl9CgoJCS8vIEFsbG93IGN1c3RvbSBoZWFkZXJzL21pbWV0eXBlcyBhbmQgZWFybHkgYWJvcnQKCQlpZiAoIHMuYmVmb3JlU2VuZCAmJiAoIHMuYmVmb3JlU2VuZC5jYWxsKCBjYWxsYmFja0NvbnRleHQsIGpxWEhSLCBzICkgPT09IGZhbHNlIHx8IHN0YXRlID09PSAyICkgKSB7CgkJCS8vIEFib3J0IGlmIG5vdCBkb25lIGFscmVhZHkgYW5kIHJldHVybgoJCQlyZXR1cm4ganFYSFIuYWJvcnQoKTsKCQl9CgoJCS8vIGFib3J0aW5nIGlzIG5vIGxvbmdlciBhIGNhbmNlbGxhdGlvbgoJCXN0ckFib3J0ID0gImFib3J0IjsKCgkJLy8gSW5zdGFsbCBjYWxsYmFja3Mgb24gZGVmZXJyZWRzCgkJZm9yICggaSBpbiB7IHN1Y2Nlc3M6IDEsIGVycm9yOiAxLCBjb21wbGV0ZTogMSB9ICkgewoJCQlqcVhIUlsgaSBdKCBzWyBpIF0gKTsKCQl9CgoJCS8vIEdldCB0cmFuc3BvcnQKCQl0cmFuc3BvcnQgPSBpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cyggdHJhbnNwb3J0cywgcywgb3B0aW9ucywganFYSFIgKTsKCgkJLy8gSWYgbm8gdHJhbnNwb3J0LCB3ZSBhdXRvLWFib3J0CgkJaWYgKCAhdHJhbnNwb3J0ICkgewoJCQlkb25lKCAtMSwgIk5vIFRyYW5zcG9ydCIgKTsKCQl9IGVsc2UgewoJCQlqcVhIUi5yZWFkeVN0YXRlID0gMTsKCgkJCS8vIFNlbmQgZ2xvYmFsIGV2ZW50CgkJCWlmICggZmlyZUdsb2JhbHMgKSB7CgkJCQlnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlciggImFqYXhTZW5kIiwgWyBqcVhIUiwgcyBdICk7CgkJCX0KCQkJLy8gVGltZW91dAoJCQlpZiAoIHMuYXN5bmMgJiYgcy50aW1lb3V0ID4gMCApIHsKCQkJCXRpbWVvdXRUaW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJanFYSFIuYWJvcnQoInRpbWVvdXQiKTsKCQkJCX0sIHMudGltZW91dCApOwoJCQl9CgoJCQl0cnkgewoJCQkJc3RhdGUgPSAxOwoJCQkJdHJhbnNwb3J0LnNlbmQoIHJlcXVlc3RIZWFkZXJzLCBkb25lICk7CgkJCX0gY2F0Y2ggKCBlICkgewoJCQkJLy8gUHJvcGFnYXRlIGV4Y2VwdGlvbiBhcyBlcnJvciBpZiBub3QgZG9uZQoJCQkJaWYgKCBzdGF0ZSA8IDIgKSB7CgkJCQkJZG9uZSggLTEsIGUgKTsKCQkJCS8vIFNpbXBseSByZXRocm93IG90aGVyd2lzZQoJCQkJfSBlbHNlIHsKCQkJCQl0aHJvdyBlOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBDYWxsYmFjayBmb3Igd2hlbiBldmVyeXRoaW5nIGlzIGRvbmUKCQlmdW5jdGlvbiBkb25lKCBzdGF0dXMsIG5hdGl2ZVN0YXR1c1RleHQsIHJlc3BvbnNlcywgaGVhZGVycyApIHsKCQkJdmFyIGlzU3VjY2Vzcywgc3VjY2VzcywgZXJyb3IsIHJlc3BvbnNlLCBtb2RpZmllZCwKCQkJCXN0YXR1c1RleHQgPSBuYXRpdmVTdGF0dXNUZXh0OwoKCQkJLy8gQ2FsbGVkIG9uY2UKCQkJaWYgKCBzdGF0ZSA9PT0gMiApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gU3RhdGUgaXMgImRvbmUiIG5vdwoJCQlzdGF0ZSA9IDI7CgoJCQkvLyBDbGVhciB0aW1lb3V0IGlmIGl0IGV4aXN0cwoJCQlpZiAoIHRpbWVvdXRUaW1lciApIHsKCQkJCWNsZWFyVGltZW91dCggdGltZW91dFRpbWVyICk7CgkJCX0KCgkJCS8vIERlcmVmZXJlbmNlIHRyYW5zcG9ydCBmb3IgZWFybHkgZ2FyYmFnZSBjb2xsZWN0aW9uCgkJCS8vIChubyBtYXR0ZXIgaG93IGxvbmcgdGhlIGpxWEhSIG9iamVjdCB3aWxsIGJlIHVzZWQpCgkJCXRyYW5zcG9ydCA9IHVuZGVmaW5lZDsKCgkJCS8vIENhY2hlIHJlc3BvbnNlIGhlYWRlcnMKCQkJcmVzcG9uc2VIZWFkZXJzU3RyaW5nID0gaGVhZGVycyB8fCAiIjsKCgkJCS8vIFNldCByZWFkeVN0YXRlCgkJCWpxWEhSLnJlYWR5U3RhdGUgPSBzdGF0dXMgPiAwID8gNCA6IDA7CgoJCQkvLyBEZXRlcm1pbmUgaWYgc3VjY2Vzc2Z1bAoJCQlpc1N1Y2Nlc3MgPSBzdGF0dXMgPj0gMjAwICYmIHN0YXR1cyA8IDMwMCB8fCBzdGF0dXMgPT09IDMwNDsKCgkJCS8vIEdldCByZXNwb25zZSBkYXRhCgkJCWlmICggcmVzcG9uc2VzICkgewoJCQkJcmVzcG9uc2UgPSBhamF4SGFuZGxlUmVzcG9uc2VzKCBzLCBqcVhIUiwgcmVzcG9uc2VzICk7CgkJCX0KCgkJCS8vIENvbnZlcnQgbm8gbWF0dGVyIHdoYXQgKHRoYXQgd2F5IHJlc3BvbnNlWFhYIGZpZWxkcyBhcmUgYWx3YXlzIHNldCkKCQkJcmVzcG9uc2UgPSBhamF4Q29udmVydCggcywgcmVzcG9uc2UsIGpxWEhSLCBpc1N1Y2Nlc3MgKTsKCgkJCS8vIElmIHN1Y2Nlc3NmdWwsIGhhbmRsZSB0eXBlIGNoYWluaW5nCgkJCWlmICggaXNTdWNjZXNzICkgewoKCQkJCS8vIFNldCB0aGUgSWYtTW9kaWZpZWQtU2luY2UgYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyLCBpZiBpbiBpZk1vZGlmaWVkIG1vZGUuCgkJCQlpZiAoIHMuaWZNb2RpZmllZCApIHsKCQkJCQltb2RpZmllZCA9IGpxWEhSLmdldFJlc3BvbnNlSGVhZGVyKCJMYXN0LU1vZGlmaWVkIik7CgkJCQkJaWYgKCBtb2RpZmllZCApIHsKCQkJCQkJalF1ZXJ5Lmxhc3RNb2RpZmllZFsgY2FjaGVVUkwgXSA9IG1vZGlmaWVkOwoJCQkJCX0KCQkJCQltb2RpZmllZCA9IGpxWEhSLmdldFJlc3BvbnNlSGVhZGVyKCJldGFnIik7CgkJCQkJaWYgKCBtb2RpZmllZCApIHsKCQkJCQkJalF1ZXJ5LmV0YWdbIGNhY2hlVVJMIF0gPSBtb2RpZmllZDsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gaWYgbm8gY29udGVudAoJCQkJaWYgKCBzdGF0dXMgPT09IDIwNCB8fCBzLnR5cGUgPT09ICJIRUFEIiApIHsKCQkJCQlzdGF0dXNUZXh0ID0gIm5vY29udGVudCI7CgoJCQkJLy8gaWYgbm90IG1vZGlmaWVkCgkJCQl9IGVsc2UgaWYgKCBzdGF0dXMgPT09IDMwNCApIHsKCQkJCQlzdGF0dXNUZXh0ID0gIm5vdG1vZGlmaWVkIjsKCgkJCQkvLyBJZiB3ZSBoYXZlIGRhdGEsIGxldCdzIGNvbnZlcnQgaXQKCQkJCX0gZWxzZSB7CgkJCQkJc3RhdHVzVGV4dCA9IHJlc3BvbnNlLnN0YXRlOwoJCQkJCXN1Y2Nlc3MgPSByZXNwb25zZS5kYXRhOwoJCQkJCWVycm9yID0gcmVzcG9uc2UuZXJyb3I7CgkJCQkJaXNTdWNjZXNzID0gIWVycm9yOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJLy8gV2UgZXh0cmFjdCBlcnJvciBmcm9tIHN0YXR1c1RleHQKCQkJCS8vIHRoZW4gbm9ybWFsaXplIHN0YXR1c1RleHQgYW5kIHN0YXR1cyBmb3Igbm9uLWFib3J0cwoJCQkJZXJyb3IgPSBzdGF0dXNUZXh0OwoJCQkJaWYgKCBzdGF0dXMgfHwgIXN0YXR1c1RleHQgKSB7CgkJCQkJc3RhdHVzVGV4dCA9ICJlcnJvciI7CgkJCQkJaWYgKCBzdGF0dXMgPCAwICkgewoJCQkJCQlzdGF0dXMgPSAwOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJLy8gU2V0IGRhdGEgZm9yIHRoZSBmYWtlIHhociBvYmplY3QKCQkJanFYSFIuc3RhdHVzID0gc3RhdHVzOwoJCQlqcVhIUi5zdGF0dXNUZXh0ID0gKCBuYXRpdmVTdGF0dXNUZXh0IHx8IHN0YXR1c1RleHQgKSArICIiOwoKCQkJLy8gU3VjY2Vzcy9FcnJvcgoJCQlpZiAoIGlzU3VjY2VzcyApIHsKCQkJCWRlZmVycmVkLnJlc29sdmVXaXRoKCBjYWxsYmFja0NvbnRleHQsIFsgc3VjY2Vzcywgc3RhdHVzVGV4dCwganFYSFIgXSApOwoJCQl9IGVsc2UgewoJCQkJZGVmZXJyZWQucmVqZWN0V2l0aCggY2FsbGJhY2tDb250ZXh0LCBbIGpxWEhSLCBzdGF0dXNUZXh0LCBlcnJvciBdICk7CgkJCX0KCgkJCS8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzCgkJCWpxWEhSLnN0YXR1c0NvZGUoIHN0YXR1c0NvZGUgKTsKCQkJc3RhdHVzQ29kZSA9IHVuZGVmaW5lZDsKCgkJCWlmICggZmlyZUdsb2JhbHMgKSB7CgkJCQlnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlciggaXNTdWNjZXNzID8gImFqYXhTdWNjZXNzIiA6ICJhamF4RXJyb3IiLAoJCQkJCVsganFYSFIsIHMsIGlzU3VjY2VzcyA/IHN1Y2Nlc3MgOiBlcnJvciBdICk7CgkJCX0KCgkJCS8vIENvbXBsZXRlCgkJCWNvbXBsZXRlRGVmZXJyZWQuZmlyZVdpdGgoIGNhbGxiYWNrQ29udGV4dCwgWyBqcVhIUiwgc3RhdHVzVGV4dCBdICk7CgoJCQlpZiAoIGZpcmVHbG9iYWxzICkgewoJCQkJZ2xvYmFsRXZlbnRDb250ZXh0LnRyaWdnZXIoICJhamF4Q29tcGxldGUiLCBbIGpxWEhSLCBzIF0gKTsKCQkJCS8vIEhhbmRsZSB0aGUgZ2xvYmFsIEFKQVggY291bnRlcgoJCQkJaWYgKCAhKCAtLWpRdWVyeS5hY3RpdmUgKSApIHsKCQkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlcigiYWpheFN0b3AiKTsKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIGpxWEhSOwoJfSwKCglnZXRKU09OOiBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjayApIHsKCQlyZXR1cm4galF1ZXJ5LmdldCggdXJsLCBkYXRhLCBjYWxsYmFjaywgImpzb24iICk7Cgl9LAoKCWdldFNjcmlwdDogZnVuY3Rpb24oIHVybCwgY2FsbGJhY2sgKSB7CgkJcmV0dXJuIGpRdWVyeS5nZXQoIHVybCwgdW5kZWZpbmVkLCBjYWxsYmFjaywgInNjcmlwdCIgKTsKCX0KfSk7CgpqUXVlcnkuZWFjaCggWyAiZ2V0IiwgInBvc3QiIF0sIGZ1bmN0aW9uKCBpLCBtZXRob2QgKSB7CglqUXVlcnlbIG1ldGhvZCBdID0gZnVuY3Rpb24oIHVybCwgZGF0YSwgY2FsbGJhY2ssIHR5cGUgKSB7CgkJLy8gc2hpZnQgYXJndW1lbnRzIGlmIGRhdGEgYXJndW1lbnQgd2FzIG9taXR0ZWQKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBkYXRhICkgKSB7CgkJCXR5cGUgPSB0eXBlIHx8IGNhbGxiYWNrOwoJCQljYWxsYmFjayA9IGRhdGE7CgkJCWRhdGEgPSB1bmRlZmluZWQ7CgkJfQoKCQlyZXR1cm4galF1ZXJ5LmFqYXgoewoJCQl1cmw6IHVybCwKCQkJdHlwZTogbWV0aG9kLAoJCQlkYXRhVHlwZTogdHlwZSwKCQkJZGF0YTogZGF0YSwKCQkJc3VjY2VzczogY2FsbGJhY2sKCQl9KTsKCX07Cn0pOwoKLy8gQXR0YWNoIGEgYnVuY2ggb2YgZnVuY3Rpb25zIGZvciBoYW5kbGluZyBjb21tb24gQUpBWCBldmVudHMKalF1ZXJ5LmVhY2goIFsgImFqYXhTdGFydCIsICJhamF4U3RvcCIsICJhamF4Q29tcGxldGUiLCAiYWpheEVycm9yIiwgImFqYXhTdWNjZXNzIiwgImFqYXhTZW5kIiBdLCBmdW5jdGlvbiggaSwgdHlwZSApIHsKCWpRdWVyeS5mblsgdHlwZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCXJldHVybiB0aGlzLm9uKCB0eXBlLCBmbiApOwoJfTsKfSk7CgoKalF1ZXJ5Ll9ldmFsVXJsID0gZnVuY3Rpb24oIHVybCApIHsKCXJldHVybiBqUXVlcnkuYWpheCh7CgkJdXJsOiB1cmwsCgkJdHlwZTogIkdFVCIsCgkJZGF0YVR5cGU6ICJzY3JpcHQiLAoJCWFzeW5jOiBmYWxzZSwKCQlnbG9iYWw6IGZhbHNlLAoJCSJ0aHJvd3MiOiB0cnVlCgl9KTsKfTsKCgpqUXVlcnkuZm4uZXh0ZW5kKHsKCXdyYXBBbGw6IGZ1bmN0aW9uKCBodG1sICkgewoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIGh0bWwgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpKSB7CgkJCQlqUXVlcnkodGhpcykud3JhcEFsbCggaHRtbC5jYWxsKHRoaXMsIGkpICk7CgkJCX0pOwoJCX0KCgkJaWYgKCB0aGlzWzBdICkgewoJCQkvLyBUaGUgZWxlbWVudHMgdG8gd3JhcCB0aGUgdGFyZ2V0IGFyb3VuZAoJCQl2YXIgd3JhcCA9IGpRdWVyeSggaHRtbCwgdGhpc1swXS5vd25lckRvY3VtZW50ICkuZXEoMCkuY2xvbmUodHJ1ZSk7CgoJCQlpZiAoIHRoaXNbMF0ucGFyZW50Tm9kZSApIHsKCQkJCXdyYXAuaW5zZXJ0QmVmb3JlKCB0aGlzWzBdICk7CgkJCX0KCgkJCXdyYXAubWFwKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGVsZW0gPSB0aGlzOwoKCQkJCXdoaWxlICggZWxlbS5maXJzdENoaWxkICYmIGVsZW0uZmlyc3RDaGlsZC5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCQllbGVtID0gZWxlbS5maXJzdENoaWxkOwoJCQkJfQoKCQkJCXJldHVybiBlbGVtOwoJCQl9KS5hcHBlbmQoIHRoaXMgKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgl3cmFwSW5uZXI6IGZ1bmN0aW9uKCBodG1sICkgewoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIGh0bWwgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpKSB7CgkJCQlqUXVlcnkodGhpcykud3JhcElubmVyKCBodG1sLmNhbGwodGhpcywgaSkgKTsKCQkJfSk7CgkJfQoKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IGpRdWVyeSggdGhpcyApLAoJCQkJY29udGVudHMgPSBzZWxmLmNvbnRlbnRzKCk7CgoJCQlpZiAoIGNvbnRlbnRzLmxlbmd0aCApIHsKCQkJCWNvbnRlbnRzLndyYXBBbGwoIGh0bWwgKTsKCgkJCX0gZWxzZSB7CgkJCQlzZWxmLmFwcGVuZCggaHRtbCApOwoJCQl9CgkJfSk7Cgl9LAoKCXdyYXA6IGZ1bmN0aW9uKCBodG1sICkgewoJCXZhciBpc0Z1bmN0aW9uID0galF1ZXJ5LmlzRnVuY3Rpb24oIGh0bWwgKTsKCgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpKSB7CgkJCWpRdWVyeSggdGhpcyApLndyYXBBbGwoIGlzRnVuY3Rpb24gPyBodG1sLmNhbGwodGhpcywgaSkgOiBodG1sICk7CgkJfSk7Cgl9LAoKCXVud3JhcDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMucGFyZW50KCkuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAhalF1ZXJ5Lm5vZGVOYW1lKCB0aGlzLCAiYm9keSIgKSApIHsKCQkJCWpRdWVyeSggdGhpcyApLnJlcGxhY2VXaXRoKCB0aGlzLmNoaWxkTm9kZXMgKTsKCQkJfQoJCX0pLmVuZCgpOwoJfQp9KTsKCgpqUXVlcnkuZXhwci5maWx0ZXJzLmhpZGRlbiA9IGZ1bmN0aW9uKCBlbGVtICkgewoJLy8gU3VwcG9ydDogT3BlcmEgPD0gMTIuMTIKCS8vIE9wZXJhIHJlcG9ydHMgb2Zmc2V0V2lkdGhzIGFuZCBvZmZzZXRIZWlnaHRzIGxlc3MgdGhhbiB6ZXJvIG9uIHNvbWUgZWxlbWVudHMKCXJldHVybiBlbGVtLm9mZnNldFdpZHRoIDw9IDAgJiYgZWxlbS5vZmZzZXRIZWlnaHQgPD0gMCB8fAoJCSghc3VwcG9ydC5yZWxpYWJsZUhpZGRlbk9mZnNldHMoKSAmJgoJCQkoKGVsZW0uc3R5bGUgJiYgZWxlbS5zdHlsZS5kaXNwbGF5KSB8fCBqUXVlcnkuY3NzKCBlbGVtLCAiZGlzcGxheSIgKSkgPT09ICJub25lIik7Cn07CgpqUXVlcnkuZXhwci5maWx0ZXJzLnZpc2libGUgPSBmdW5jdGlvbiggZWxlbSApIHsKCXJldHVybiAhalF1ZXJ5LmV4cHIuZmlsdGVycy5oaWRkZW4oIGVsZW0gKTsKfTsKCgoKCnZhciByMjAgPSAvJTIwL2csCglyYnJhY2tldCA9IC9cW1xdJC8sCglyQ1JMRiA9IC9ccj9cbi9nLAoJcnN1Ym1pdHRlclR5cGVzID0gL14oPzpzdWJtaXR8YnV0dG9ufGltYWdlfHJlc2V0fGZpbGUpJC9pLAoJcnN1Ym1pdHRhYmxlID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8a2V5Z2VuKS9pOwoKZnVuY3Rpb24gYnVpbGRQYXJhbXMoIHByZWZpeCwgb2JqLCB0cmFkaXRpb25hbCwgYWRkICkgewoJdmFyIG5hbWU7CgoJaWYgKCBqUXVlcnkuaXNBcnJheSggb2JqICkgKSB7CgkJLy8gU2VyaWFsaXplIGFycmF5IGl0ZW0uCgkJalF1ZXJ5LmVhY2goIG9iaiwgZnVuY3Rpb24oIGksIHYgKSB7CgkJCWlmICggdHJhZGl0aW9uYWwgfHwgcmJyYWNrZXQudGVzdCggcHJlZml4ICkgKSB7CgkJCQkvLyBUcmVhdCBlYWNoIGFycmF5IGl0ZW0gYXMgYSBzY2FsYXIuCgkJCQlhZGQoIHByZWZpeCwgdiApOwoKCQkJfSBlbHNlIHsKCQkJCS8vIEl0ZW0gaXMgbm9uLXNjYWxhciAoYXJyYXkgb3Igb2JqZWN0KSwgZW5jb2RlIGl0cyBudW1lcmljIGluZGV4LgoJCQkJYnVpbGRQYXJhbXMoIHByZWZpeCArICJbIiArICggdHlwZW9mIHYgPT09ICJvYmplY3QiID8gaSA6ICIiICkgKyAiXSIsIHYsIHRyYWRpdGlvbmFsLCBhZGQgKTsKCQkJfQoJCX0pOwoKCX0gZWxzZSBpZiAoICF0cmFkaXRpb25hbCAmJiBqUXVlcnkudHlwZSggb2JqICkgPT09ICJvYmplY3QiICkgewoJCS8vIFNlcmlhbGl6ZSBvYmplY3QgaXRlbS4KCQlmb3IgKCBuYW1lIGluIG9iaiApIHsKCQkJYnVpbGRQYXJhbXMoIHByZWZpeCArICJbIiArIG5hbWUgKyAiXSIsIG9ialsgbmFtZSBdLCB0cmFkaXRpb25hbCwgYWRkICk7CgkJfQoKCX0gZWxzZSB7CgkJLy8gU2VyaWFsaXplIHNjYWxhciBpdGVtLgoJCWFkZCggcHJlZml4LCBvYmogKTsKCX0KfQoKLy8gU2VyaWFsaXplIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMgb3IgYSBzZXQgb2YKLy8ga2V5L3ZhbHVlcyBpbnRvIGEgcXVlcnkgc3RyaW5nCmpRdWVyeS5wYXJhbSA9IGZ1bmN0aW9uKCBhLCB0cmFkaXRpb25hbCApIHsKCXZhciBwcmVmaXgsCgkJcyA9IFtdLAoJCWFkZCA9IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQkvLyBJZiB2YWx1ZSBpcyBhIGZ1bmN0aW9uLCBpbnZva2UgaXQgYW5kIHJldHVybiBpdHMgdmFsdWUKCQkJdmFsdWUgPSBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSA/IHZhbHVlKCkgOiAoIHZhbHVlID09IG51bGwgPyAiIiA6IHZhbHVlICk7CgkJCXNbIHMubGVuZ3RoIF0gPSBlbmNvZGVVUklDb21wb25lbnQoIGtleSApICsgIj0iICsgZW5jb2RlVVJJQ29tcG9uZW50KCB2YWx1ZSApOwoJCX07CgoJLy8gU2V0IHRyYWRpdGlvbmFsIHRvIHRydWUgZm9yIGpRdWVyeSA8PSAxLjMuMiBiZWhhdmlvci4KCWlmICggdHJhZGl0aW9uYWwgPT09IHVuZGVmaW5lZCApIHsKCQl0cmFkaXRpb25hbCA9IGpRdWVyeS5hamF4U2V0dGluZ3MgJiYgalF1ZXJ5LmFqYXhTZXR0aW5ncy50cmFkaXRpb25hbDsKCX0KCgkvLyBJZiBhbiBhcnJheSB3YXMgcGFzc2VkIGluLCBhc3N1bWUgdGhhdCBpdCBpcyBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzLgoJaWYgKCBqUXVlcnkuaXNBcnJheSggYSApIHx8ICggYS5qcXVlcnkgJiYgIWpRdWVyeS5pc1BsYWluT2JqZWN0KCBhICkgKSApIHsKCQkvLyBTZXJpYWxpemUgdGhlIGZvcm0gZWxlbWVudHMKCQlqUXVlcnkuZWFjaCggYSwgZnVuY3Rpb24oKSB7CgkJCWFkZCggdGhpcy5uYW1lLCB0aGlzLnZhbHVlICk7CgkJfSk7CgoJfSBlbHNlIHsKCQkvLyBJZiB0cmFkaXRpb25hbCwgZW5jb2RlIHRoZSAib2xkIiB3YXkgKHRoZSB3YXkgMS4zLjIgb3Igb2xkZXIKCQkvLyBkaWQgaXQpLCBvdGhlcndpc2UgZW5jb2RlIHBhcmFtcyByZWN1cnNpdmVseS4KCQlmb3IgKCBwcmVmaXggaW4gYSApIHsKCQkJYnVpbGRQYXJhbXMoIHByZWZpeCwgYVsgcHJlZml4IF0sIHRyYWRpdGlvbmFsLCBhZGQgKTsKCQl9Cgl9CgoJLy8gUmV0dXJuIHRoZSByZXN1bHRpbmcgc2VyaWFsaXphdGlvbgoJcmV0dXJuIHMuam9pbiggIiYiICkucmVwbGFjZSggcjIwLCAiKyIgKTsKfTsKCmpRdWVyeS5mbi5leHRlbmQoewoJc2VyaWFsaXplOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4galF1ZXJ5LnBhcmFtKCB0aGlzLnNlcmlhbGl6ZUFycmF5KCkgKTsKCX0sCglzZXJpYWxpemVBcnJheTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKCkgewoJCQkvLyBDYW4gYWRkIHByb3BIb29rIGZvciAiZWxlbWVudHMiIHRvIGZpbHRlciBvciBhZGQgZm9ybSBlbGVtZW50cwoJCQl2YXIgZWxlbWVudHMgPSBqUXVlcnkucHJvcCggdGhpcywgImVsZW1lbnRzIiApOwoJCQlyZXR1cm4gZWxlbWVudHMgPyBqUXVlcnkubWFrZUFycmF5KCBlbGVtZW50cyApIDogdGhpczsKCQl9KQoJCS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCXZhciB0eXBlID0gdGhpcy50eXBlOwoJCQkvLyBVc2UgLmlzKCI6ZGlzYWJsZWQiKSBzbyB0aGF0IGZpZWxkc2V0W2Rpc2FibGVkXSB3b3JrcwoJCQlyZXR1cm4gdGhpcy5uYW1lICYmICFqUXVlcnkoIHRoaXMgKS5pcyggIjpkaXNhYmxlZCIgKSAmJgoJCQkJcnN1Ym1pdHRhYmxlLnRlc3QoIHRoaXMubm9kZU5hbWUgKSAmJiAhcnN1Ym1pdHRlclR5cGVzLnRlc3QoIHR5cGUgKSAmJgoJCQkJKCB0aGlzLmNoZWNrZWQgfHwgIXJjaGVja2FibGVUeXBlLnRlc3QoIHR5cGUgKSApOwoJCX0pCgkJLm1hcChmdW5jdGlvbiggaSwgZWxlbSApIHsKCQkJdmFyIHZhbCA9IGpRdWVyeSggdGhpcyApLnZhbCgpOwoKCQkJcmV0dXJuIHZhbCA9PSBudWxsID8KCQkJCW51bGwgOgoJCQkJalF1ZXJ5LmlzQXJyYXkoIHZhbCApID8KCQkJCQlqUXVlcnkubWFwKCB2YWwsIGZ1bmN0aW9uKCB2YWwgKSB7CgkJCQkJCXJldHVybiB7IG5hbWU6IGVsZW0ubmFtZSwgdmFsdWU6IHZhbC5yZXBsYWNlKCByQ1JMRiwgIlxyXG4iICkgfTsKCQkJCQl9KSA6CgkJCQkJeyBuYW1lOiBlbGVtLm5hbWUsIHZhbHVlOiB2YWwucmVwbGFjZSggckNSTEYsICJcclxuIiApIH07CgkJfSkuZ2V0KCk7Cgl9Cn0pOwoKCi8vIENyZWF0ZSB0aGUgcmVxdWVzdCBvYmplY3QKLy8gKFRoaXMgaXMgc3RpbGwgYXR0YWNoZWQgdG8gYWpheFNldHRpbmdzIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5KQpqUXVlcnkuYWpheFNldHRpbmdzLnhociA9IHdpbmRvdy5BY3RpdmVYT2JqZWN0ICE9PSB1bmRlZmluZWQgPwoJLy8gU3VwcG9ydDogSUU2KwoJZnVuY3Rpb24oKSB7CgoJCS8vIFhIUiBjYW5ub3QgYWNjZXNzIGxvY2FsIGZpbGVzLCBhbHdheXMgdXNlIEFjdGl2ZVggZm9yIHRoYXQgY2FzZQoJCXJldHVybiAhdGhpcy5pc0xvY2FsICYmCgoJCQkvLyBTdXBwb3J0OiBJRTctOAoJCQkvLyBvbGRJRSBYSFIgZG9lcyBub3Qgc3VwcG9ydCBub24tUkZDMjYxNiBtZXRob2RzICgjMTMyNDApCgkJCS8vIFNlZSBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvaWUvbXM1MzY2NDgodj12cy44NSkuYXNweAoJCQkvLyBhbmQgaHR0cDovL3d3dy53My5vcmcvUHJvdG9jb2xzL3JmYzI2MTYvcmZjMjYxNi1zZWM5Lmh0bWwjc2VjOQoJCQkvLyBBbHRob3VnaCB0aGlzIGNoZWNrIGZvciBzaXggbWV0aG9kcyBpbnN0ZWFkIG9mIGVpZ2h0CgkJCS8vIHNpbmNlIElFIGFsc28gZG9lcyBub3Qgc3VwcG9ydCAidHJhY2UiIGFuZCAiY29ubmVjdCIKCQkJL14oZ2V0fHBvc3R8aGVhZHxwdXR8ZGVsZXRlfG9wdGlvbnMpJC9pLnRlc3QoIHRoaXMudHlwZSApICYmCgoJCQljcmVhdGVTdGFuZGFyZFhIUigpIHx8IGNyZWF0ZUFjdGl2ZVhIUigpOwoJfSA6CgkvLyBGb3IgYWxsIG90aGVyIGJyb3dzZXJzLCB1c2UgdGhlIHN0YW5kYXJkIFhNTEh0dHBSZXF1ZXN0IG9iamVjdAoJY3JlYXRlU3RhbmRhcmRYSFI7Cgp2YXIgeGhySWQgPSAwLAoJeGhyQ2FsbGJhY2tzID0ge30sCgl4aHJTdXBwb3J0ZWQgPSBqUXVlcnkuYWpheFNldHRpbmdzLnhocigpOwoKLy8gU3VwcG9ydDogSUU8MTAKLy8gT3BlbiByZXF1ZXN0cyBtdXN0IGJlIG1hbnVhbGx5IGFib3J0ZWQgb24gdW5sb2FkICgjNTI4MCkKaWYgKCB3aW5kb3cuQWN0aXZlWE9iamVjdCApIHsKCWpRdWVyeSggd2luZG93ICkub24oICJ1bmxvYWQiLCBmdW5jdGlvbigpIHsKCQlmb3IgKCB2YXIga2V5IGluIHhockNhbGxiYWNrcyApIHsKCQkJeGhyQ2FsbGJhY2tzWyBrZXkgXSggdW5kZWZpbmVkLCB0cnVlICk7CgkJfQoJfSk7Cn0KCi8vIERldGVybWluZSBzdXBwb3J0IHByb3BlcnRpZXMKc3VwcG9ydC5jb3JzID0gISF4aHJTdXBwb3J0ZWQgJiYgKCAid2l0aENyZWRlbnRpYWxzIiBpbiB4aHJTdXBwb3J0ZWQgKTsKeGhyU3VwcG9ydGVkID0gc3VwcG9ydC5hamF4ID0gISF4aHJTdXBwb3J0ZWQ7CgovLyBDcmVhdGUgdHJhbnNwb3J0IGlmIHRoZSBicm93c2VyIGNhbiBwcm92aWRlIGFuIHhocgppZiAoIHhoclN1cHBvcnRlZCApIHsKCglqUXVlcnkuYWpheFRyYW5zcG9ydChmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkvLyBDcm9zcyBkb21haW4gb25seSBhbGxvd2VkIGlmIHN1cHBvcnRlZCB0aHJvdWdoIFhNTEh0dHBSZXF1ZXN0CgkJaWYgKCAhb3B0aW9ucy5jcm9zc0RvbWFpbiB8fCBzdXBwb3J0LmNvcnMgKSB7CgoJCQl2YXIgY2FsbGJhY2s7CgoJCQlyZXR1cm4gewoJCQkJc2VuZDogZnVuY3Rpb24oIGhlYWRlcnMsIGNvbXBsZXRlICkgewoJCQkJCXZhciBpLAoJCQkJCQl4aHIgPSBvcHRpb25zLnhocigpLAoJCQkJCQlpZCA9ICsreGhySWQ7CgoJCQkJCS8vIE9wZW4gdGhlIHNvY2tldAoJCQkJCXhoci5vcGVuKCBvcHRpb25zLnR5cGUsIG9wdGlvbnMudXJsLCBvcHRpb25zLmFzeW5jLCBvcHRpb25zLnVzZXJuYW1lLCBvcHRpb25zLnBhc3N3b3JkICk7CgoJCQkJCS8vIEFwcGx5IGN1c3RvbSBmaWVsZHMgaWYgcHJvdmlkZWQKCQkJCQlpZiAoIG9wdGlvbnMueGhyRmllbGRzICkgewoJCQkJCQlmb3IgKCBpIGluIG9wdGlvbnMueGhyRmllbGRzICkgewoJCQkJCQkJeGhyWyBpIF0gPSBvcHRpb25zLnhockZpZWxkc1sgaSBdOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQkvLyBPdmVycmlkZSBtaW1lIHR5cGUgaWYgbmVlZGVkCgkJCQkJaWYgKCBvcHRpb25zLm1pbWVUeXBlICYmIHhoci5vdmVycmlkZU1pbWVUeXBlICkgewoJCQkJCQl4aHIub3ZlcnJpZGVNaW1lVHlwZSggb3B0aW9ucy5taW1lVHlwZSApOwoJCQkJCX0KCgkJCQkJLy8gWC1SZXF1ZXN0ZWQtV2l0aCBoZWFkZXIKCQkJCQkvLyBGb3IgY3Jvc3MtZG9tYWluIHJlcXVlc3RzLCBzZWVpbmcgYXMgY29uZGl0aW9ucyBmb3IgYSBwcmVmbGlnaHQgYXJlCgkJCQkJLy8gYWtpbiB0byBhIGppZ3NhdyBwdXp6bGUsIHdlIHNpbXBseSBuZXZlciBzZXQgaXQgdG8gYmUgc3VyZS4KCQkJCQkvLyAoaXQgY2FuIGFsd2F5cyBiZSBzZXQgb24gYSBwZXItcmVxdWVzdCBiYXNpcyBvciBldmVuIHVzaW5nIGFqYXhTZXR1cCkKCQkJCQkvLyBGb3Igc2FtZS1kb21haW4gcmVxdWVzdHMsIHdvbid0IGNoYW5nZSBoZWFkZXIgaWYgYWxyZWFkeSBwcm92aWRlZC4KCQkJCQlpZiAoICFvcHRpb25zLmNyb3NzRG9tYWluICYmICFoZWFkZXJzWyJYLVJlcXVlc3RlZC1XaXRoIl0gKSB7CgkJCQkJCWhlYWRlcnNbIlgtUmVxdWVzdGVkLVdpdGgiXSA9ICJYTUxIdHRwUmVxdWVzdCI7CgkJCQkJfQoKCQkJCQkvLyBTZXQgaGVhZGVycwoJCQkJCWZvciAoIGkgaW4gaGVhZGVycyApIHsKCQkJCQkJLy8gU3VwcG9ydDogSUU8OQoJCQkJCQkvLyBJRSdzIEFjdGl2ZVhPYmplY3QgdGhyb3dzIGEgJ1R5cGUgTWlzbWF0Y2gnIGV4Y2VwdGlvbiB3aGVuIHNldHRpbmcKCQkJCQkJLy8gcmVxdWVzdCBoZWFkZXIgdG8gYSBudWxsLXZhbHVlLgoJCQkJCQkvLwoJCQkJCQkvLyBUbyBrZWVwIGNvbnNpc3RlbnQgd2l0aCBvdGhlciBYSFIgaW1wbGVtZW50YXRpb25zLCBjYXN0IHRoZSB2YWx1ZQoJCQkJCQkvLyB0byBzdHJpbmcgYW5kIGlnbm9yZSBgdW5kZWZpbmVkYC4KCQkJCQkJaWYgKCBoZWFkZXJzWyBpIF0gIT09IHVuZGVmaW5lZCApIHsKCQkJCQkJCXhoci5zZXRSZXF1ZXN0SGVhZGVyKCBpLCBoZWFkZXJzWyBpIF0gKyAiIiApOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQkvLyBEbyBzZW5kIHRoZSByZXF1ZXN0CgkJCQkJLy8gVGhpcyBtYXkgcmFpc2UgYW4gZXhjZXB0aW9uIHdoaWNoIGlzIGFjdHVhbGx5CgkJCQkJLy8gaGFuZGxlZCBpbiBqUXVlcnkuYWpheCAoc28gbm8gdHJ5L2NhdGNoIGhlcmUpCgkJCQkJeGhyLnNlbmQoICggb3B0aW9ucy5oYXNDb250ZW50ICYmIG9wdGlvbnMuZGF0YSApIHx8IG51bGwgKTsKCgkJCQkJLy8gTGlzdGVuZXIKCQkJCQljYWxsYmFjayA9IGZ1bmN0aW9uKCBfLCBpc0Fib3J0ICkgewoJCQkJCQl2YXIgc3RhdHVzLCBzdGF0dXNUZXh0LCByZXNwb25zZXM7CgoJCQkJCQkvLyBXYXMgbmV2ZXIgY2FsbGVkIGFuZCBpcyBhYm9ydGVkIG9yIGNvbXBsZXRlCgkJCQkJCWlmICggY2FsbGJhY2sgJiYgKCBpc0Fib3J0IHx8IHhoci5yZWFkeVN0YXRlID09PSA0ICkgKSB7CgkJCQkJCQkvLyBDbGVhbiB1cAoJCQkJCQkJZGVsZXRlIHhockNhbGxiYWNrc1sgaWQgXTsKCQkJCQkJCWNhbGxiYWNrID0gdW5kZWZpbmVkOwoJCQkJCQkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGpRdWVyeS5ub29wOwoKCQkJCQkJCS8vIEFib3J0IG1hbnVhbGx5IGlmIG5lZWRlZAoJCQkJCQkJaWYgKCBpc0Fib3J0ICkgewoJCQkJCQkJCWlmICggeGhyLnJlYWR5U3RhdGUgIT09IDQgKSB7CgkJCQkJCQkJCXhoci5hYm9ydCgpOwoJCQkJCQkJCX0KCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJcmVzcG9uc2VzID0ge307CgkJCQkJCQkJc3RhdHVzID0geGhyLnN0YXR1czsKCgkJCQkJCQkJLy8gU3VwcG9ydDogSUU8MTAKCQkJCQkJCQkvLyBBY2Nlc3NpbmcgYmluYXJ5LWRhdGEgcmVzcG9uc2VUZXh0IHRocm93cyBhbiBleGNlcHRpb24KCQkJCQkJCQkvLyAoIzExNDI2KQoJCQkJCQkJCWlmICggdHlwZW9mIHhoci5yZXNwb25zZVRleHQgPT09ICJzdHJpbmciICkgewoJCQkJCQkJCQlyZXNwb25zZXMudGV4dCA9IHhoci5yZXNwb25zZVRleHQ7CgkJCQkJCQkJfQoKCQkJCQkJCQkvLyBGaXJlZm94IHRocm93cyBhbiBleGNlcHRpb24gd2hlbiBhY2Nlc3NpbmcKCQkJCQkJCQkvLyBzdGF0dXNUZXh0IGZvciBmYXVsdHkgY3Jvc3MtZG9tYWluIHJlcXVlc3RzCgkJCQkJCQkJdHJ5IHsKCQkJCQkJCQkJc3RhdHVzVGV4dCA9IHhoci5zdGF0dXNUZXh0OwoJCQkJCQkJCX0gY2F0Y2goIGUgKSB7CgkJCQkJCQkJCS8vIFdlIG5vcm1hbGl6ZSB3aXRoIFdlYmtpdCBnaXZpbmcgYW4gZW1wdHkgc3RhdHVzVGV4dAoJCQkJCQkJCQlzdGF0dXNUZXh0ID0gIiI7CgkJCQkJCQkJfQoKCQkJCQkJCQkvLyBGaWx0ZXIgc3RhdHVzIGZvciBub24gc3RhbmRhcmQgYmVoYXZpb3JzCgoJCQkJCQkJCS8vIElmIHRoZSByZXF1ZXN0IGlzIGxvY2FsIGFuZCB3ZSBoYXZlIGRhdGE6IGFzc3VtZSBhIHN1Y2Nlc3MKCQkJCQkJCQkvLyAoc3VjY2VzcyB3aXRoIG5vIGRhdGEgd29uJ3QgZ2V0IG5vdGlmaWVkLCB0aGF0J3MgdGhlIGJlc3Qgd2UKCQkJCQkJCQkvLyBjYW4gZG8gZ2l2ZW4gY3VycmVudCBpbXBsZW1lbnRhdGlvbnMpCgkJCQkJCQkJaWYgKCAhc3RhdHVzICYmIG9wdGlvbnMuaXNMb2NhbCAmJiAhb3B0aW9ucy5jcm9zc0RvbWFpbiApIHsKCQkJCQkJCQkJc3RhdHVzID0gcmVzcG9uc2VzLnRleHQgPyAyMDAgOiA0MDQ7CgkJCQkJCQkJLy8gSUUgLSAjMTQ1MDogc29tZXRpbWVzIHJldHVybnMgMTIyMyB3aGVuIGl0IHNob3VsZCBiZSAyMDQKCQkJCQkJCQl9IGVsc2UgaWYgKCBzdGF0dXMgPT09IDEyMjMgKSB7CgkJCQkJCQkJCXN0YXR1cyA9IDIwNDsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0KCgkJCQkJCS8vIENhbGwgY29tcGxldGUgaWYgbmVlZGVkCgkJCQkJCWlmICggcmVzcG9uc2VzICkgewoJCQkJCQkJY29tcGxldGUoIHN0YXR1cywgc3RhdHVzVGV4dCwgcmVzcG9uc2VzLCB4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCkgKTsKCQkJCQkJfQoJCQkJCX07CgoJCQkJCWlmICggIW9wdGlvbnMuYXN5bmMgKSB7CgkJCQkJCS8vIGlmIHdlJ3JlIGluIHN5bmMgbW9kZSB3ZSBmaXJlIHRoZSBjYWxsYmFjawoJCQkJCQljYWxsYmFjaygpOwoJCQkJCX0gZWxzZSBpZiAoIHhoci5yZWFkeVN0YXRlID09PSA0ICkgewoJCQkJCQkvLyAoSUU2ICYgSUU3KSBpZiBpdCdzIGluIGNhY2hlIGFuZCBoYXMgYmVlbgoJCQkJCQkvLyByZXRyaWV2ZWQgZGlyZWN0bHkgd2UgbmVlZCB0byBmaXJlIHRoZSBjYWxsYmFjawoJCQkJCQlzZXRUaW1lb3V0KCBjYWxsYmFjayApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCS8vIEFkZCB0byB0aGUgbGlzdCBvZiBhY3RpdmUgeGhyIGNhbGxiYWNrcwoJCQkJCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0geGhyQ2FsbGJhY2tzWyBpZCBdID0gY2FsbGJhY2s7CgkJCQkJfQoJCQkJfSwKCgkJCQlhYm9ydDogZnVuY3Rpb24oKSB7CgkJCQkJaWYgKCBjYWxsYmFjayApIHsKCQkJCQkJY2FsbGJhY2soIHVuZGVmaW5lZCwgdHJ1ZSApOwoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9Cgl9KTsKfQoKLy8gRnVuY3Rpb25zIHRvIGNyZWF0ZSB4aHJzCmZ1bmN0aW9uIGNyZWF0ZVN0YW5kYXJkWEhSKCkgewoJdHJ5IHsKCQlyZXR1cm4gbmV3IHdpbmRvdy5YTUxIdHRwUmVxdWVzdCgpOwoJfSBjYXRjaCggZSApIHt9Cn0KCmZ1bmN0aW9uIGNyZWF0ZUFjdGl2ZVhIUigpIHsKCXRyeSB7CgkJcmV0dXJuIG5ldyB3aW5kb3cuQWN0aXZlWE9iamVjdCggIk1pY3Jvc29mdC5YTUxIVFRQIiApOwoJfSBjYXRjaCggZSApIHt9Cn0KCgoKCi8vIEluc3RhbGwgc2NyaXB0IGRhdGFUeXBlCmpRdWVyeS5hamF4U2V0dXAoewoJYWNjZXB0czogewoJCXNjcmlwdDogInRleHQvamF2YXNjcmlwdCwgYXBwbGljYXRpb24vamF2YXNjcmlwdCwgYXBwbGljYXRpb24vZWNtYXNjcmlwdCwgYXBwbGljYXRpb24veC1lY21hc2NyaXB0IgoJfSwKCWNvbnRlbnRzOiB7CgkJc2NyaXB0OiAvKD86amF2YXxlY21hKXNjcmlwdC8KCX0sCgljb252ZXJ0ZXJzOiB7CgkJInRleHQgc2NyaXB0IjogZnVuY3Rpb24oIHRleHQgKSB7CgkJCWpRdWVyeS5nbG9iYWxFdmFsKCB0ZXh0ICk7CgkJCXJldHVybiB0ZXh0OwoJCX0KCX0KfSk7CgovLyBIYW5kbGUgY2FjaGUncyBzcGVjaWFsIGNhc2UgYW5kIGdsb2JhbApqUXVlcnkuYWpheFByZWZpbHRlciggInNjcmlwdCIsIGZ1bmN0aW9uKCBzICkgewoJaWYgKCBzLmNhY2hlID09PSB1bmRlZmluZWQgKSB7CgkJcy5jYWNoZSA9IGZhbHNlOwoJfQoJaWYgKCBzLmNyb3NzRG9tYWluICkgewoJCXMudHlwZSA9ICJHRVQiOwoJCXMuZ2xvYmFsID0gZmFsc2U7Cgl9Cn0pOwoKLy8gQmluZCBzY3JpcHQgdGFnIGhhY2sgdHJhbnNwb3J0CmpRdWVyeS5hamF4VHJhbnNwb3J0KCAic2NyaXB0IiwgZnVuY3Rpb24ocykgewoKCS8vIFRoaXMgdHJhbnNwb3J0IG9ubHkgZGVhbHMgd2l0aCBjcm9zcyBkb21haW4gcmVxdWVzdHMKCWlmICggcy5jcm9zc0RvbWFpbiApIHsKCgkJdmFyIHNjcmlwdCwKCQkJaGVhZCA9IGRvY3VtZW50LmhlYWQgfHwgalF1ZXJ5KCJoZWFkIilbMF0gfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKCQlyZXR1cm4gewoKCQkJc2VuZDogZnVuY3Rpb24oIF8sIGNhbGxiYWNrICkgewoKCQkJCXNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwoKCQkJCXNjcmlwdC5hc3luYyA9IHRydWU7CgoJCQkJaWYgKCBzLnNjcmlwdENoYXJzZXQgKSB7CgkJCQkJc2NyaXB0LmNoYXJzZXQgPSBzLnNjcmlwdENoYXJzZXQ7CgkJCQl9CgoJCQkJc2NyaXB0LnNyYyA9IHMudXJsOwoKCQkJCS8vIEF0dGFjaCBoYW5kbGVycyBmb3IgYWxsIGJyb3dzZXJzCgkJCQlzY3JpcHQub25sb2FkID0gc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCBfLCBpc0Fib3J0ICkgewoKCQkJCQlpZiAoIGlzQWJvcnQgfHwgIXNjcmlwdC5yZWFkeVN0YXRlIHx8IC9sb2FkZWR8Y29tcGxldGUvLnRlc3QoIHNjcmlwdC5yZWFkeVN0YXRlICkgKSB7CgoJCQkJCQkvLyBIYW5kbGUgbWVtb3J5IGxlYWsgaW4gSUUKCQkJCQkJc2NyaXB0Lm9ubG9hZCA9IHNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBudWxsOwoKCQkJCQkJLy8gUmVtb3ZlIHRoZSBzY3JpcHQKCQkJCQkJaWYgKCBzY3JpcHQucGFyZW50Tm9kZSApIHsKCQkJCQkJCXNjcmlwdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCBzY3JpcHQgKTsKCQkJCQkJfQoKCQkJCQkJLy8gRGVyZWZlcmVuY2UgdGhlIHNjcmlwdAoJCQkJCQlzY3JpcHQgPSBudWxsOwoKCQkJCQkJLy8gQ2FsbGJhY2sgaWYgbm90IGFib3J0CgkJCQkJCWlmICggIWlzQWJvcnQgKSB7CgkJCQkJCQljYWxsYmFjayggMjAwLCAic3VjY2VzcyIgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX07CgoJCQkJLy8gQ2lyY3VtdmVudCBJRTYgYnVncyB3aXRoIGJhc2UgZWxlbWVudHMgKCMyNzA5IGFuZCAjNDM3OCkgYnkgcHJlcGVuZGluZwoJCQkJLy8gVXNlIG5hdGl2ZSBET00gbWFuaXB1bGF0aW9uIHRvIGF2b2lkIG91ciBkb21NYW5pcCBBSkFYIHRyaWNrZXJ5CgkJCQloZWFkLmluc2VydEJlZm9yZSggc2NyaXB0LCBoZWFkLmZpcnN0Q2hpbGQgKTsKCQkJfSwKCgkJCWFib3J0OiBmdW5jdGlvbigpIHsKCQkJCWlmICggc2NyaXB0ICkgewoJCQkJCXNjcmlwdC5vbmxvYWQoIHVuZGVmaW5lZCwgdHJ1ZSApOwoJCQkJfQoJCQl9CgkJfTsKCX0KfSk7CgoKCgp2YXIgb2xkQ2FsbGJhY2tzID0gW10sCglyanNvbnAgPSAvKD0pXD8oPz0mfCQpfFw/XD8vOwoKLy8gRGVmYXVsdCBqc29ucCBzZXR0aW5ncwpqUXVlcnkuYWpheFNldHVwKHsKCWpzb25wOiAiY2FsbGJhY2siLAoJanNvbnBDYWxsYmFjazogZnVuY3Rpb24oKSB7CgkJdmFyIGNhbGxiYWNrID0gb2xkQ2FsbGJhY2tzLnBvcCgpIHx8ICggalF1ZXJ5LmV4cGFuZG8gKyAiXyIgKyAoIG5vbmNlKysgKSApOwoJCXRoaXNbIGNhbGxiYWNrIF0gPSB0cnVlOwoJCXJldHVybiBjYWxsYmFjazsKCX0KfSk7CgovLyBEZXRlY3QsIG5vcm1hbGl6ZSBvcHRpb25zIGFuZCBpbnN0YWxsIGNhbGxiYWNrcyBmb3IganNvbnAgcmVxdWVzdHMKalF1ZXJ5LmFqYXhQcmVmaWx0ZXIoICJqc29uIGpzb25wIiwgZnVuY3Rpb24oIHMsIG9yaWdpbmFsU2V0dGluZ3MsIGpxWEhSICkgewoKCXZhciBjYWxsYmFja05hbWUsIG92ZXJ3cml0dGVuLCByZXNwb25zZUNvbnRhaW5lciwKCQlqc29uUHJvcCA9IHMuanNvbnAgIT09IGZhbHNlICYmICggcmpzb25wLnRlc3QoIHMudXJsICkgPwoJCQkidXJsIiA6CgkJCXR5cGVvZiBzLmRhdGEgPT09ICJzdHJpbmciICYmICEoIHMuY29udGVudFR5cGUgfHwgIiIgKS5pbmRleE9mKCJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQiKSAmJiByanNvbnAudGVzdCggcy5kYXRhICkgJiYgImRhdGEiCgkJKTsKCgkvLyBIYW5kbGUgaWZmIHRoZSBleHBlY3RlZCBkYXRhIHR5cGUgaXMgImpzb25wIiBvciB3ZSBoYXZlIGEgcGFyYW1ldGVyIHRvIHNldAoJaWYgKCBqc29uUHJvcCB8fCBzLmRhdGFUeXBlc1sgMCBdID09PSAianNvbnAiICkgewoKCQkvLyBHZXQgY2FsbGJhY2sgbmFtZSwgcmVtZW1iZXJpbmcgcHJlZXhpc3RpbmcgdmFsdWUgYXNzb2NpYXRlZCB3aXRoIGl0CgkJY2FsbGJhY2tOYW1lID0gcy5qc29ucENhbGxiYWNrID0galF1ZXJ5LmlzRnVuY3Rpb24oIHMuanNvbnBDYWxsYmFjayApID8KCQkJcy5qc29ucENhbGxiYWNrKCkgOgoJCQlzLmpzb25wQ2FsbGJhY2s7CgoJCS8vIEluc2VydCBjYWxsYmFjayBpbnRvIHVybCBvciBmb3JtIGRhdGEKCQlpZiAoIGpzb25Qcm9wICkgewoJCQlzWyBqc29uUHJvcCBdID0gc1sganNvblByb3AgXS5yZXBsYWNlKCByanNvbnAsICIkMSIgKyBjYWxsYmFja05hbWUgKTsKCQl9IGVsc2UgaWYgKCBzLmpzb25wICE9PSBmYWxzZSApIHsKCQkJcy51cmwgKz0gKCBycXVlcnkudGVzdCggcy51cmwgKSA/ICImIiA6ICI/IiApICsgcy5qc29ucCArICI9IiArIGNhbGxiYWNrTmFtZTsKCQl9CgoJCS8vIFVzZSBkYXRhIGNvbnZlcnRlciB0byByZXRyaWV2ZSBqc29uIGFmdGVyIHNjcmlwdCBleGVjdXRpb24KCQlzLmNvbnZlcnRlcnNbInNjcmlwdCBqc29uIl0gPSBmdW5jdGlvbigpIHsKCQkJaWYgKCAhcmVzcG9uc2VDb250YWluZXIgKSB7CgkJCQlqUXVlcnkuZXJyb3IoIGNhbGxiYWNrTmFtZSArICIgd2FzIG5vdCBjYWxsZWQiICk7CgkJCX0KCQkJcmV0dXJuIHJlc3BvbnNlQ29udGFpbmVyWyAwIF07CgkJfTsKCgkJLy8gZm9yY2UganNvbiBkYXRhVHlwZQoJCXMuZGF0YVR5cGVzWyAwIF0gPSAianNvbiI7CgoJCS8vIEluc3RhbGwgY2FsbGJhY2sKCQlvdmVyd3JpdHRlbiA9IHdpbmRvd1sgY2FsbGJhY2tOYW1lIF07CgkJd2luZG93WyBjYWxsYmFja05hbWUgXSA9IGZ1bmN0aW9uKCkgewoJCQlyZXNwb25zZUNvbnRhaW5lciA9IGFyZ3VtZW50czsKCQl9OwoKCQkvLyBDbGVhbi11cCBmdW5jdGlvbiAoZmlyZXMgYWZ0ZXIgY29udmVydGVycykKCQlqcVhIUi5hbHdheXMoZnVuY3Rpb24oKSB7CgkJCS8vIFJlc3RvcmUgcHJlZXhpc3RpbmcgdmFsdWUKCQkJd2luZG93WyBjYWxsYmFja05hbWUgXSA9IG92ZXJ3cml0dGVuOwoKCQkJLy8gU2F2ZSBiYWNrIGFzIGZyZWUKCQkJaWYgKCBzWyBjYWxsYmFja05hbWUgXSApIHsKCQkJCS8vIG1ha2Ugc3VyZSB0aGF0IHJlLXVzaW5nIHRoZSBvcHRpb25zIGRvZXNuJ3Qgc2NyZXcgdGhpbmdzIGFyb3VuZAoJCQkJcy5qc29ucENhbGxiYWNrID0gb3JpZ2luYWxTZXR0aW5ncy5qc29ucENhbGxiYWNrOwoKCQkJCS8vIHNhdmUgdGhlIGNhbGxiYWNrIG5hbWUgZm9yIGZ1dHVyZSB1c2UKCQkJCW9sZENhbGxiYWNrcy5wdXNoKCBjYWxsYmFja05hbWUgKTsKCQkJfQoKCQkJLy8gQ2FsbCBpZiBpdCB3YXMgYSBmdW5jdGlvbiBhbmQgd2UgaGF2ZSBhIHJlc3BvbnNlCgkJCWlmICggcmVzcG9uc2VDb250YWluZXIgJiYgalF1ZXJ5LmlzRnVuY3Rpb24oIG92ZXJ3cml0dGVuICkgKSB7CgkJCQlvdmVyd3JpdHRlbiggcmVzcG9uc2VDb250YWluZXJbIDAgXSApOwoJCQl9CgoJCQlyZXNwb25zZUNvbnRhaW5lciA9IG92ZXJ3cml0dGVuID0gdW5kZWZpbmVkOwoJCX0pOwoKCQkvLyBEZWxlZ2F0ZSB0byBzY3JpcHQKCQlyZXR1cm4gInNjcmlwdCI7Cgl9Cn0pOwoKCgoKLy8gZGF0YTogc3RyaW5nIG9mIGh0bWwKLy8gY29udGV4dCAob3B0aW9uYWwpOiBJZiBzcGVjaWZpZWQsIHRoZSBmcmFnbWVudCB3aWxsIGJlIGNyZWF0ZWQgaW4gdGhpcyBjb250ZXh0LCBkZWZhdWx0cyB0byBkb2N1bWVudAovLyBrZWVwU2NyaXB0cyAob3B0aW9uYWwpOiBJZiB0cnVlLCB3aWxsIGluY2x1ZGUgc2NyaXB0cyBwYXNzZWQgaW4gdGhlIGh0bWwgc3RyaW5nCmpRdWVyeS5wYXJzZUhUTUwgPSBmdW5jdGlvbiggZGF0YSwgY29udGV4dCwga2VlcFNjcmlwdHMgKSB7CglpZiAoICFkYXRhIHx8IHR5cGVvZiBkYXRhICE9PSAic3RyaW5nIiApIHsKCQlyZXR1cm4gbnVsbDsKCX0KCWlmICggdHlwZW9mIGNvbnRleHQgPT09ICJib29sZWFuIiApIHsKCQlrZWVwU2NyaXB0cyA9IGNvbnRleHQ7CgkJY29udGV4dCA9IGZhbHNlOwoJfQoJY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CgoJdmFyIHBhcnNlZCA9IHJzaW5nbGVUYWcuZXhlYyggZGF0YSApLAoJCXNjcmlwdHMgPSAha2VlcFNjcmlwdHMgJiYgW107CgoJLy8gU2luZ2xlIHRhZwoJaWYgKCBwYXJzZWQgKSB7CgkJcmV0dXJuIFsgY29udGV4dC5jcmVhdGVFbGVtZW50KCBwYXJzZWRbMV0gKSBdOwoJfQoKCXBhcnNlZCA9IGpRdWVyeS5idWlsZEZyYWdtZW50KCBbIGRhdGEgXSwgY29udGV4dCwgc2NyaXB0cyApOwoKCWlmICggc2NyaXB0cyAmJiBzY3JpcHRzLmxlbmd0aCApIHsKCQlqUXVlcnkoIHNjcmlwdHMgKS5yZW1vdmUoKTsKCX0KCglyZXR1cm4galF1ZXJ5Lm1lcmdlKCBbXSwgcGFyc2VkLmNoaWxkTm9kZXMgKTsKfTsKCgovLyBLZWVwIGEgY29weSBvZiB0aGUgb2xkIGxvYWQgbWV0aG9kCnZhciBfbG9hZCA9IGpRdWVyeS5mbi5sb2FkOwoKLyoqCiAqIExvYWQgYSB1cmwgaW50byBhIHBhZ2UKICovCmpRdWVyeS5mbi5sb2FkID0gZnVuY3Rpb24oIHVybCwgcGFyYW1zLCBjYWxsYmFjayApIHsKCWlmICggdHlwZW9mIHVybCAhPT0gInN0cmluZyIgJiYgX2xvYWQgKSB7CgkJcmV0dXJuIF9sb2FkLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCX0KCgl2YXIgc2VsZWN0b3IsIHJlc3BvbnNlLCB0eXBlLAoJCXNlbGYgPSB0aGlzLAoJCW9mZiA9IHVybC5pbmRleE9mKCIgIik7CgoJaWYgKCBvZmYgPj0gMCApIHsKCQlzZWxlY3RvciA9IHVybC5zbGljZSggb2ZmLCB1cmwubGVuZ3RoICk7CgkJdXJsID0gdXJsLnNsaWNlKCAwLCBvZmYgKTsKCX0KCgkvLyBJZiBpdCdzIGEgZnVuY3Rpb24KCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHBhcmFtcyApICkgewoKCQkvLyBXZSBhc3N1bWUgdGhhdCBpdCdzIHRoZSBjYWxsYmFjawoJCWNhbGxiYWNrID0gcGFyYW1zOwoJCXBhcmFtcyA9IHVuZGVmaW5lZDsKCgkvLyBPdGhlcndpc2UsIGJ1aWxkIGEgcGFyYW0gc3RyaW5nCgl9IGVsc2UgaWYgKCBwYXJhbXMgJiYgdHlwZW9mIHBhcmFtcyA9PT0gIm9iamVjdCIgKSB7CgkJdHlwZSA9ICJQT1NUIjsKCX0KCgkvLyBJZiB3ZSBoYXZlIGVsZW1lbnRzIHRvIG1vZGlmeSwgbWFrZSB0aGUgcmVxdWVzdAoJaWYgKCBzZWxmLmxlbmd0aCA+IDAgKSB7CgkJalF1ZXJ5LmFqYXgoewoJCQl1cmw6IHVybCwKCgkJCS8vIGlmICJ0eXBlIiB2YXJpYWJsZSBpcyB1bmRlZmluZWQsIHRoZW4gIkdFVCIgbWV0aG9kIHdpbGwgYmUgdXNlZAoJCQl0eXBlOiB0eXBlLAoJCQlkYXRhVHlwZTogImh0bWwiLAoJCQlkYXRhOiBwYXJhbXMKCQl9KS5kb25lKGZ1bmN0aW9uKCByZXNwb25zZVRleHQgKSB7CgoJCQkvLyBTYXZlIHJlc3BvbnNlIGZvciB1c2UgaW4gY29tcGxldGUgY2FsbGJhY2sKCQkJcmVzcG9uc2UgPSBhcmd1bWVudHM7CgoJCQlzZWxmLmh0bWwoIHNlbGVjdG9yID8KCgkJCQkvLyBJZiBhIHNlbGVjdG9yIHdhcyBzcGVjaWZpZWQsIGxvY2F0ZSB0aGUgcmlnaHQgZWxlbWVudHMgaW4gYSBkdW1teSBkaXYKCQkJCS8vIEV4Y2x1ZGUgc2NyaXB0cyB0byBhdm9pZCBJRSAnUGVybWlzc2lvbiBEZW5pZWQnIGVycm9ycwoJCQkJalF1ZXJ5KCI8ZGl2PiIpLmFwcGVuZCggalF1ZXJ5LnBhcnNlSFRNTCggcmVzcG9uc2VUZXh0ICkgKS5maW5kKCBzZWxlY3RvciApIDoKCgkJCQkvLyBPdGhlcndpc2UgdXNlIHRoZSBmdWxsIHJlc3VsdAoJCQkJcmVzcG9uc2VUZXh0ICk7CgoJCX0pLmNvbXBsZXRlKCBjYWxsYmFjayAmJiBmdW5jdGlvbigganFYSFIsIHN0YXR1cyApIHsKCQkJc2VsZi5lYWNoKCBjYWxsYmFjaywgcmVzcG9uc2UgfHwgWyBqcVhIUi5yZXNwb25zZVRleHQsIHN0YXR1cywganFYSFIgXSApOwoJCX0pOwoJfQoKCXJldHVybiB0aGlzOwp9OwoKCgoKalF1ZXJ5LmV4cHIuZmlsdGVycy5hbmltYXRlZCA9IGZ1bmN0aW9uKCBlbGVtICkgewoJcmV0dXJuIGpRdWVyeS5ncmVwKGpRdWVyeS50aW1lcnMsIGZ1bmN0aW9uKCBmbiApIHsKCQlyZXR1cm4gZWxlbSA9PT0gZm4uZWxlbTsKCX0pLmxlbmd0aDsKfTsKCgoKCgp2YXIgZG9jRWxlbSA9IHdpbmRvdy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CgovKioKICogR2V0cyBhIHdpbmRvdyBmcm9tIGFuIGVsZW1lbnQKICovCmZ1bmN0aW9uIGdldFdpbmRvdyggZWxlbSApIHsKCXJldHVybiBqUXVlcnkuaXNXaW5kb3coIGVsZW0gKSA/CgkJZWxlbSA6CgkJZWxlbS5ub2RlVHlwZSA9PT0gOSA/CgkJCWVsZW0uZGVmYXVsdFZpZXcgfHwgZWxlbS5wYXJlbnRXaW5kb3cgOgoJCQlmYWxzZTsKfQoKalF1ZXJ5Lm9mZnNldCA9IHsKCXNldE9mZnNldDogZnVuY3Rpb24oIGVsZW0sIG9wdGlvbnMsIGkgKSB7CgkJdmFyIGN1clBvc2l0aW9uLCBjdXJMZWZ0LCBjdXJDU1NUb3AsIGN1clRvcCwgY3VyT2Zmc2V0LCBjdXJDU1NMZWZ0LCBjYWxjdWxhdGVQb3NpdGlvbiwKCQkJcG9zaXRpb24gPSBqUXVlcnkuY3NzKCBlbGVtLCAicG9zaXRpb24iICksCgkJCWN1ckVsZW0gPSBqUXVlcnkoIGVsZW0gKSwKCQkJcHJvcHMgPSB7fTsKCgkJLy8gc2V0IHBvc2l0aW9uIGZpcnN0LCBpbi1jYXNlIHRvcC9sZWZ0IGFyZSBzZXQgZXZlbiBvbiBzdGF0aWMgZWxlbQoJCWlmICggcG9zaXRpb24gPT09ICJzdGF0aWMiICkgewoJCQllbGVtLnN0eWxlLnBvc2l0aW9uID0gInJlbGF0aXZlIjsKCQl9CgoJCWN1ck9mZnNldCA9IGN1ckVsZW0ub2Zmc2V0KCk7CgkJY3VyQ1NTVG9wID0galF1ZXJ5LmNzcyggZWxlbSwgInRvcCIgKTsKCQljdXJDU1NMZWZ0ID0galF1ZXJ5LmNzcyggZWxlbSwgImxlZnQiICk7CgkJY2FsY3VsYXRlUG9zaXRpb24gPSAoIHBvc2l0aW9uID09PSAiYWJzb2x1dGUiIHx8IHBvc2l0aW9uID09PSAiZml4ZWQiICkgJiYKCQkJalF1ZXJ5LmluQXJyYXkoImF1dG8iLCBbIGN1ckNTU1RvcCwgY3VyQ1NTTGVmdCBdICkgPiAtMTsKCgkJLy8gbmVlZCB0byBiZSBhYmxlIHRvIGNhbGN1bGF0ZSBwb3NpdGlvbiBpZiBlaXRoZXIgdG9wIG9yIGxlZnQgaXMgYXV0byBhbmQgcG9zaXRpb24gaXMgZWl0aGVyIGFic29sdXRlIG9yIGZpeGVkCgkJaWYgKCBjYWxjdWxhdGVQb3NpdGlvbiApIHsKCQkJY3VyUG9zaXRpb24gPSBjdXJFbGVtLnBvc2l0aW9uKCk7CgkJCWN1clRvcCA9IGN1clBvc2l0aW9uLnRvcDsKCQkJY3VyTGVmdCA9IGN1clBvc2l0aW9uLmxlZnQ7CgkJfSBlbHNlIHsKCQkJY3VyVG9wID0gcGFyc2VGbG9hdCggY3VyQ1NTVG9wICkgfHwgMDsKCQkJY3VyTGVmdCA9IHBhcnNlRmxvYXQoIGN1ckNTU0xlZnQgKSB8fCAwOwoJCX0KCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggb3B0aW9ucyApICkgewoJCQlvcHRpb25zID0gb3B0aW9ucy5jYWxsKCBlbGVtLCBpLCBjdXJPZmZzZXQgKTsKCQl9CgoJCWlmICggb3B0aW9ucy50b3AgIT0gbnVsbCApIHsKCQkJcHJvcHMudG9wID0gKCBvcHRpb25zLnRvcCAtIGN1ck9mZnNldC50b3AgKSArIGN1clRvcDsKCQl9CgkJaWYgKCBvcHRpb25zLmxlZnQgIT0gbnVsbCApIHsKCQkJcHJvcHMubGVmdCA9ICggb3B0aW9ucy5sZWZ0IC0gY3VyT2Zmc2V0LmxlZnQgKSArIGN1ckxlZnQ7CgkJfQoKCQlpZiAoICJ1c2luZyIgaW4gb3B0aW9ucyApIHsKCQkJb3B0aW9ucy51c2luZy5jYWxsKCBlbGVtLCBwcm9wcyApOwoJCX0gZWxzZSB7CgkJCWN1ckVsZW0uY3NzKCBwcm9wcyApOwoJCX0KCX0KfTsKCmpRdWVyeS5mbi5leHRlbmQoewoJb2Zmc2V0OiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggKSB7CgkJCXJldHVybiBvcHRpb25zID09PSB1bmRlZmluZWQgPwoJCQkJdGhpcyA6CgkJCQl0aGlzLmVhY2goZnVuY3Rpb24oIGkgKSB7CgkJCQkJalF1ZXJ5Lm9mZnNldC5zZXRPZmZzZXQoIHRoaXMsIG9wdGlvbnMsIGkgKTsKCQkJCX0pOwoJCX0KCgkJdmFyIGRvY0VsZW0sIHdpbiwKCQkJYm94ID0geyB0b3A6IDAsIGxlZnQ6IDAgfSwKCQkJZWxlbSA9IHRoaXNbIDAgXSwKCQkJZG9jID0gZWxlbSAmJiBlbGVtLm93bmVyRG9jdW1lbnQ7CgoJCWlmICggIWRvYyApIHsKCQkJcmV0dXJuOwoJCX0KCgkJZG9jRWxlbSA9IGRvYy5kb2N1bWVudEVsZW1lbnQ7CgoJCS8vIE1ha2Ugc3VyZSBpdCdzIG5vdCBhIGRpc2Nvbm5lY3RlZCBET00gbm9kZQoJCWlmICggIWpRdWVyeS5jb250YWlucyggZG9jRWxlbSwgZWxlbSApICkgewoJCQlyZXR1cm4gYm94OwoJCX0KCgkJLy8gSWYgd2UgZG9uJ3QgaGF2ZSBnQkNSLCBqdXN0IHVzZSAwLDAgcmF0aGVyIHRoYW4gZXJyb3IKCQkvLyBCbGFja0JlcnJ5IDUsIGlPUyAzIChvcmlnaW5hbCBpUGhvbmUpCgkJaWYgKCB0eXBlb2YgZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QgIT09IHN0cnVuZGVmaW5lZCApIHsKCQkJYm94ID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKCQl9CgkJd2luID0gZ2V0V2luZG93KCBkb2MgKTsKCQlyZXR1cm4gewoJCQl0b3A6IGJveC50b3AgICsgKCB3aW4ucGFnZVlPZmZzZXQgfHwgZG9jRWxlbS5zY3JvbGxUb3AgKSAgLSAoIGRvY0VsZW0uY2xpZW50VG9wICB8fCAwICksCgkJCWxlZnQ6IGJveC5sZWZ0ICsgKCB3aW4ucGFnZVhPZmZzZXQgfHwgZG9jRWxlbS5zY3JvbGxMZWZ0ICkgLSAoIGRvY0VsZW0uY2xpZW50TGVmdCB8fCAwICkKCQl9OwoJfSwKCglwb3NpdGlvbjogZnVuY3Rpb24oKSB7CgkJaWYgKCAhdGhpc1sgMCBdICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgb2Zmc2V0UGFyZW50LCBvZmZzZXQsCgkJCXBhcmVudE9mZnNldCA9IHsgdG9wOiAwLCBsZWZ0OiAwIH0sCgkJCWVsZW0gPSB0aGlzWyAwIF07CgoJCS8vIGZpeGVkIGVsZW1lbnRzIGFyZSBvZmZzZXQgZnJvbSB3aW5kb3cgKHBhcmVudE9mZnNldCA9IHt0b3A6MCwgbGVmdDogMH0sIGJlY2F1c2UgaXQgaXMgaXRzIG9ubHkgb2Zmc2V0IHBhcmVudAoJCWlmICggalF1ZXJ5LmNzcyggZWxlbSwgInBvc2l0aW9uIiApID09PSAiZml4ZWQiICkgewoJCQkvLyB3ZSBhc3N1bWUgdGhhdCBnZXRCb3VuZGluZ0NsaWVudFJlY3QgaXMgYXZhaWxhYmxlIHdoZW4gY29tcHV0ZWQgcG9zaXRpb24gaXMgZml4ZWQKCQkJb2Zmc2V0ID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKCQl9IGVsc2UgewoJCQkvLyBHZXQgKnJlYWwqIG9mZnNldFBhcmVudAoJCQlvZmZzZXRQYXJlbnQgPSB0aGlzLm9mZnNldFBhcmVudCgpOwoKCQkJLy8gR2V0IGNvcnJlY3Qgb2Zmc2V0cwoJCQlvZmZzZXQgPSB0aGlzLm9mZnNldCgpOwoJCQlpZiAoICFqUXVlcnkubm9kZU5hbWUoIG9mZnNldFBhcmVudFsgMCBdLCAiaHRtbCIgKSApIHsKCQkJCXBhcmVudE9mZnNldCA9IG9mZnNldFBhcmVudC5vZmZzZXQoKTsKCQkJfQoKCQkJLy8gQWRkIG9mZnNldFBhcmVudCBib3JkZXJzCgkJCXBhcmVudE9mZnNldC50b3AgICs9IGpRdWVyeS5jc3MoIG9mZnNldFBhcmVudFsgMCBdLCAiYm9yZGVyVG9wV2lkdGgiLCB0cnVlICk7CgkJCXBhcmVudE9mZnNldC5sZWZ0ICs9IGpRdWVyeS5jc3MoIG9mZnNldFBhcmVudFsgMCBdLCAiYm9yZGVyTGVmdFdpZHRoIiwgdHJ1ZSApOwoJCX0KCgkJLy8gU3VidHJhY3QgcGFyZW50IG9mZnNldHMgYW5kIGVsZW1lbnQgbWFyZ2lucwoJCS8vIG5vdGU6IHdoZW4gYW4gZWxlbWVudCBoYXMgbWFyZ2luOiBhdXRvIHRoZSBvZmZzZXRMZWZ0IGFuZCBtYXJnaW5MZWZ0CgkJLy8gYXJlIHRoZSBzYW1lIGluIFNhZmFyaSBjYXVzaW5nIG9mZnNldC5sZWZ0IHRvIGluY29ycmVjdGx5IGJlIDAKCQlyZXR1cm4gewoJCQl0b3A6ICBvZmZzZXQudG9wICAtIHBhcmVudE9mZnNldC50b3AgLSBqUXVlcnkuY3NzKCBlbGVtLCAibWFyZ2luVG9wIiwgdHJ1ZSApLAoJCQlsZWZ0OiBvZmZzZXQubGVmdCAtIHBhcmVudE9mZnNldC5sZWZ0IC0galF1ZXJ5LmNzcyggZWxlbSwgIm1hcmdpbkxlZnQiLCB0cnVlKQoJCX07Cgl9LAoKCW9mZnNldFBhcmVudDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKCkgewoJCQl2YXIgb2Zmc2V0UGFyZW50ID0gdGhpcy5vZmZzZXRQYXJlbnQgfHwgZG9jRWxlbTsKCgkJCXdoaWxlICggb2Zmc2V0UGFyZW50ICYmICggIWpRdWVyeS5ub2RlTmFtZSggb2Zmc2V0UGFyZW50LCAiaHRtbCIgKSAmJiBqUXVlcnkuY3NzKCBvZmZzZXRQYXJlbnQsICJwb3NpdGlvbiIgKSA9PT0gInN0YXRpYyIgKSApIHsKCQkJCW9mZnNldFBhcmVudCA9IG9mZnNldFBhcmVudC5vZmZzZXRQYXJlbnQ7CgkJCX0KCQkJcmV0dXJuIG9mZnNldFBhcmVudCB8fCBkb2NFbGVtOwoJCX0pOwoJfQp9KTsKCi8vIENyZWF0ZSBzY3JvbGxMZWZ0IGFuZCBzY3JvbGxUb3AgbWV0aG9kcwpqUXVlcnkuZWFjaCggeyBzY3JvbGxMZWZ0OiAicGFnZVhPZmZzZXQiLCBzY3JvbGxUb3A6ICJwYWdlWU9mZnNldCIgfSwgZnVuY3Rpb24oIG1ldGhvZCwgcHJvcCApIHsKCXZhciB0b3AgPSAvWS8udGVzdCggcHJvcCApOwoKCWpRdWVyeS5mblsgbWV0aG9kIF0gPSBmdW5jdGlvbiggdmFsICkgewoJCXJldHVybiBhY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCBtZXRob2QsIHZhbCApIHsKCQkJdmFyIHdpbiA9IGdldFdpbmRvdyggZWxlbSApOwoKCQkJaWYgKCB2YWwgPT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiB3aW4gPyAocHJvcCBpbiB3aW4pID8gd2luWyBwcm9wIF0gOgoJCQkJCXdpbi5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnRbIG1ldGhvZCBdIDoKCQkJCQllbGVtWyBtZXRob2QgXTsKCQkJfQoKCQkJaWYgKCB3aW4gKSB7CgkJCQl3aW4uc2Nyb2xsVG8oCgkJCQkJIXRvcCA/IHZhbCA6IGpRdWVyeSggd2luICkuc2Nyb2xsTGVmdCgpLAoJCQkJCXRvcCA/IHZhbCA6IGpRdWVyeSggd2luICkuc2Nyb2xsVG9wKCkKCQkJCSk7CgoJCQl9IGVsc2UgewoJCQkJZWxlbVsgbWV0aG9kIF0gPSB2YWw7CgkJCX0KCQl9LCBtZXRob2QsIHZhbCwgYXJndW1lbnRzLmxlbmd0aCwgbnVsbCApOwoJfTsKfSk7CgovLyBBZGQgdGhlIHRvcC9sZWZ0IGNzc0hvb2tzIHVzaW5nIGpRdWVyeS5mbi5wb3NpdGlvbgovLyBXZWJraXQgYnVnOiBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9MjkwODQKLy8gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHBlcmNlbnQgd2hlbiBzcGVjaWZpZWQgZm9yIHRvcC9sZWZ0L2JvdHRvbS9yaWdodAovLyByYXRoZXIgdGhhbiBtYWtlIHRoZSBjc3MgbW9kdWxlIGRlcGVuZCBvbiB0aGUgb2Zmc2V0IG1vZHVsZSwgd2UganVzdCBjaGVjayBmb3IgaXQgaGVyZQpqUXVlcnkuZWFjaCggWyAidG9wIiwgImxlZnQiIF0sIGZ1bmN0aW9uKCBpLCBwcm9wICkgewoJalF1ZXJ5LmNzc0hvb2tzWyBwcm9wIF0gPSBhZGRHZXRIb29rSWYoIHN1cHBvcnQucGl4ZWxQb3NpdGlvbiwKCQlmdW5jdGlvbiggZWxlbSwgY29tcHV0ZWQgKSB7CgkJCWlmICggY29tcHV0ZWQgKSB7CgkJCQljb21wdXRlZCA9IGN1ckNTUyggZWxlbSwgcHJvcCApOwoJCQkJLy8gaWYgY3VyQ1NTIHJldHVybnMgcGVyY2VudGFnZSwgZmFsbGJhY2sgdG8gb2Zmc2V0CgkJCQlyZXR1cm4gcm51bW5vbnB4LnRlc3QoIGNvbXB1dGVkICkgPwoJCQkJCWpRdWVyeSggZWxlbSApLnBvc2l0aW9uKClbIHByb3AgXSArICJweCIgOgoJCQkJCWNvbXB1dGVkOwoJCQl9CgkJfQoJKTsKfSk7CgoKLy8gQ3JlYXRlIGlubmVySGVpZ2h0LCBpbm5lcldpZHRoLCBoZWlnaHQsIHdpZHRoLCBvdXRlckhlaWdodCBhbmQgb3V0ZXJXaWR0aCBtZXRob2RzCmpRdWVyeS5lYWNoKCB7IEhlaWdodDogImhlaWdodCIsIFdpZHRoOiAid2lkdGgiIH0sIGZ1bmN0aW9uKCBuYW1lLCB0eXBlICkgewoJalF1ZXJ5LmVhY2goIHsgcGFkZGluZzogImlubmVyIiArIG5hbWUsIGNvbnRlbnQ6IHR5cGUsICIiOiAib3V0ZXIiICsgbmFtZSB9LCBmdW5jdGlvbiggZGVmYXVsdEV4dHJhLCBmdW5jTmFtZSApIHsKCQkvLyBtYXJnaW4gaXMgb25seSBmb3Igb3V0ZXJIZWlnaHQsIG91dGVyV2lkdGgKCQlqUXVlcnkuZm5bIGZ1bmNOYW1lIF0gPSBmdW5jdGlvbiggbWFyZ2luLCB2YWx1ZSApIHsKCQkJdmFyIGNoYWluYWJsZSA9IGFyZ3VtZW50cy5sZW5ndGggJiYgKCBkZWZhdWx0RXh0cmEgfHwgdHlwZW9mIG1hcmdpbiAhPT0gImJvb2xlYW4iICksCgkJCQlleHRyYSA9IGRlZmF1bHRFeHRyYSB8fCAoIG1hcmdpbiA9PT0gdHJ1ZSB8fCB2YWx1ZSA9PT0gdHJ1ZSA/ICJtYXJnaW4iIDogImJvcmRlciIgKTsKCgkJCXJldHVybiBhY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCB2YWx1ZSApIHsKCQkJCXZhciBkb2M7CgoJCQkJaWYgKCBqUXVlcnkuaXNXaW5kb3coIGVsZW0gKSApIHsKCQkJCQkvLyBBcyBvZiA1LzgvMjAxMiB0aGlzIHdpbGwgeWllbGQgaW5jb3JyZWN0IHJlc3VsdHMgZm9yIE1vYmlsZSBTYWZhcmksIGJ1dCB0aGVyZQoJCQkJCS8vIGlzbid0IGEgd2hvbGUgbG90IHdlIGNhbiBkby4gU2VlIHB1bGwgcmVxdWVzdCBhdCB0aGlzIFVSTCBmb3IgZGlzY3Vzc2lvbjoKCQkJCQkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS9wdWxsLzc2NAoJCQkJCXJldHVybiBlbGVtLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudFsgImNsaWVudCIgKyBuYW1lIF07CgkJCQl9CgoJCQkJLy8gR2V0IGRvY3VtZW50IHdpZHRoIG9yIGhlaWdodAoJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSA5ICkgewoJCQkJCWRvYyA9IGVsZW0uZG9jdW1lbnRFbGVtZW50OwoKCQkJCQkvLyBFaXRoZXIgc2Nyb2xsW1dpZHRoL0hlaWdodF0gb3Igb2Zmc2V0W1dpZHRoL0hlaWdodF0gb3IgY2xpZW50W1dpZHRoL0hlaWdodF0sIHdoaWNoZXZlciBpcyBncmVhdGVzdAoJCQkJCS8vIHVuZm9ydHVuYXRlbHksIHRoaXMgY2F1c2VzIGJ1ZyAjMzgzOCBpbiBJRTYvOCBvbmx5LCBidXQgdGhlcmUgaXMgY3VycmVudGx5IG5vIGdvb2QsIHNtYWxsIHdheSB0byBmaXggaXQuCgkJCQkJcmV0dXJuIE1hdGgubWF4KAoJCQkJCQllbGVtLmJvZHlbICJzY3JvbGwiICsgbmFtZSBdLCBkb2NbICJzY3JvbGwiICsgbmFtZSBdLAoJCQkJCQllbGVtLmJvZHlbICJvZmZzZXQiICsgbmFtZSBdLCBkb2NbICJvZmZzZXQiICsgbmFtZSBdLAoJCQkJCQlkb2NbICJjbGllbnQiICsgbmFtZSBdCgkJCQkJKTsKCQkJCX0KCgkJCQlyZXR1cm4gdmFsdWUgPT09IHVuZGVmaW5lZCA/CgkJCQkJLy8gR2V0IHdpZHRoIG9yIGhlaWdodCBvbiB0aGUgZWxlbWVudCwgcmVxdWVzdGluZyBidXQgbm90IGZvcmNpbmcgcGFyc2VGbG9hdAoJCQkJCWpRdWVyeS5jc3MoIGVsZW0sIHR5cGUsIGV4dHJhICkgOgoKCQkJCQkvLyBTZXQgd2lkdGggb3IgaGVpZ2h0IG9uIHRoZSBlbGVtZW50CgkJCQkJalF1ZXJ5LnN0eWxlKCBlbGVtLCB0eXBlLCB2YWx1ZSwgZXh0cmEgKTsKCQkJfSwgdHlwZSwgY2hhaW5hYmxlID8gbWFyZ2luIDogdW5kZWZpbmVkLCBjaGFpbmFibGUsIG51bGwgKTsKCQl9OwoJfSk7Cn0pOwoKCi8vIFRoZSBudW1iZXIgb2YgZWxlbWVudHMgY29udGFpbmVkIGluIHRoZSBtYXRjaGVkIGVsZW1lbnQgc2V0CmpRdWVyeS5mbi5zaXplID0gZnVuY3Rpb24oKSB7CglyZXR1cm4gdGhpcy5sZW5ndGg7Cn07CgpqUXVlcnkuZm4uYW5kU2VsZiA9IGpRdWVyeS5mbi5hZGRCYWNrOwoKCgoKLy8gUmVnaXN0ZXIgYXMgYSBuYW1lZCBBTUQgbW9kdWxlLCBzaW5jZSBqUXVlcnkgY2FuIGJlIGNvbmNhdGVuYXRlZCB3aXRoIG90aGVyCi8vIGZpbGVzIHRoYXQgbWF5IHVzZSBkZWZpbmUsIGJ1dCBub3QgdmlhIGEgcHJvcGVyIGNvbmNhdGVuYXRpb24gc2NyaXB0IHRoYXQKLy8gdW5kZXJzdGFuZHMgYW5vbnltb3VzIEFNRCBtb2R1bGVzLiBBIG5hbWVkIEFNRCBpcyBzYWZlc3QgYW5kIG1vc3Qgcm9idXN0Ci8vIHdheSB0byByZWdpc3Rlci4gTG93ZXJjYXNlIGpxdWVyeSBpcyB1c2VkIGJlY2F1c2UgQU1EIG1vZHVsZSBuYW1lcyBhcmUKLy8gZGVyaXZlZCBmcm9tIGZpbGUgbmFtZXMsIGFuZCBqUXVlcnkgaXMgbm9ybWFsbHkgZGVsaXZlcmVkIGluIGEgbG93ZXJjYXNlCi8vIGZpbGUgbmFtZS4gRG8gdGhpcyBhZnRlciBjcmVhdGluZyB0aGUgZ2xvYmFsIHNvIHRoYXQgaWYgYW4gQU1EIG1vZHVsZSB3YW50cwovLyB0byBjYWxsIG5vQ29uZmxpY3QgdG8gaGlkZSB0aGlzIHZlcnNpb24gb2YgalF1ZXJ5LCBpdCB3aWxsIHdvcmsuCmlmICggdHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kICkgewoJZGVmaW5lKCAianF1ZXJ5IiwgW10sIGZ1bmN0aW9uKCkgewoJCXJldHVybiBqUXVlcnk7Cgl9KTsKfQoKCgoKdmFyCgkvLyBNYXAgb3ZlciBqUXVlcnkgaW4gY2FzZSBvZiBvdmVyd3JpdGUKCV9qUXVlcnkgPSB3aW5kb3cualF1ZXJ5LAoKCS8vIE1hcCBvdmVyIHRoZSAkIGluIGNhc2Ugb2Ygb3ZlcndyaXRlCglfJCA9IHdpbmRvdy4kOwoKalF1ZXJ5Lm5vQ29uZmxpY3QgPSBmdW5jdGlvbiggZGVlcCApIHsKCWlmICggd2luZG93LiQgPT09IGpRdWVyeSApIHsKCQl3aW5kb3cuJCA9IF8kOwoJfQoKCWlmICggZGVlcCAmJiB3aW5kb3cualF1ZXJ5ID09PSBqUXVlcnkgKSB7CgkJd2luZG93LmpRdWVyeSA9IF9qUXVlcnk7Cgl9CgoJcmV0dXJuIGpRdWVyeTsKfTsKCi8vIEV4cG9zZSBqUXVlcnkgYW5kICQgaWRlbnRpZmllcnMsIGV2ZW4gaW4KLy8gQU1EICgjNzEwMiNjb21tZW50OjEwLCBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS9wdWxsLzU1NykKLy8gYW5kIENvbW1vbkpTIGZvciBicm93c2VyIGVtdWxhdG9ycyAoIzEzNTY2KQppZiAoIHR5cGVvZiBub0dsb2JhbCA9PT0gc3RydW5kZWZpbmVkICkgewoJd2luZG93LmpRdWVyeSA9IHdpbmRvdy4kID0galF1ZXJ5Owp9CgoKCgpyZXR1cm4galF1ZXJ5OwoKfSkpOwoKZGVmaW5lKCdqcXVlcnktcHJpdmF0ZScsWydqcXVlcnknXSwgZnVuY3Rpb24gKGpxKSB7CiAgICByZXR1cm4ganEubm9Db25mbGljdCggdHJ1ZSApOwp9KTsKCmRlZmluZSgndXRpbHMnLFsianF1ZXJ5Il0sIGZ1bmN0aW9uICgkKSB7CiAgICAkLmZuLmhhc1Njcm9sbEJhciA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghJC5jb250YWlucyhkb2N1bWVudCwgdGhpcy5nZXQoMCkpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5wYXJlbnQoKS5oZWlnaHQoKSA8IHRoaXMuZ2V0KDApLnNjcm9sbEhlaWdodCkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgICAkLmZuLmFkZEh5cGVybGlua3MgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHRoaXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24gKGksIG9iaikgewogICAgICAgICAgICAgICAgdmFyIHggPSAkKG9iaikuaHRtbCgpOwogICAgICAgICAgICAgICAgdmFyIGxpc3QgPSB4Lm1hdGNoKC9cYihodHRwcz86XC9cL3x3d3dcLnxodHRwcz86XC9cL3d3d1wuKVteXHM8XXsyLDIwMH1cYi9nICk7CiAgICAgICAgICAgICAgICBpZiAobGlzdCkgewogICAgICAgICAgICAgICAgICAgIGZvciAoaT0wOyBpPGxpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByb3QgPSBsaXN0W2ldLmluZGV4T2YoJ2h0dHA6Ly8nKSA9PT0gMCB8fCBsaXN0W2ldLmluZGV4T2YoJ2h0dHBzOi8vJykgPT09IDAgPyAnJyA6ICdodHRwOi8vJzsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVzY2FwZWRfdXJsID0gZW5jb2RlVVJJKGRlY29kZVVSSShsaXN0W2ldKSkucmVwbGFjZSgvWyEnKCldL2csIGVzY2FwZSkucmVwbGFjZSgvXCovZywgIiUyQSIpOwogICAgICAgICAgICAgICAgICAgICAgICB4ID0geC5yZXBsYWNlKGxpc3RbaV0sICI8YSB0YXJnZXQ9J19ibGFuaycgaHJlZj0nIiArIHByb3QgKyBlc2NhcGVkX3VybCArICInPiIrIGxpc3RbaV0gKyAiPC9hPiIgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkKG9iaikuaHRtbCh4KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICB2YXIgdXRpbHMgPSB7CiAgICAgICAgLy8gVHJhbnNsYXRpb24gbWFjaGluZXJ5CiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgX186IGZ1bmN0aW9uIChzdHIpIHsKICAgICAgICAgICAgLy8gVHJhbnNsYXRpb24gZmFjdG9yeQogICAgICAgICAgICBpZiAodGhpcy5pMThuID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuaTE4biA9IGxvY2FsZXMuZW47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHQgPSB0aGlzLmkxOG4udHJhbnNsYXRlKHN0cik7CiAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoPjEpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0LmZldGNoLmFwcGx5KHQsIFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLDEpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0LmZldGNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBfX186IGZ1bmN0aW9uIChzdHIpIHsKICAgICAgICAgICAgLyogWFhYOiBUaGlzIGlzIHBhcnQgb2YgYSBoYWNrIHRvIGdldCBnZXR0ZXh0IHRvIHNjYW4gc3RyaW5ncyB0byBiZQogICAgICAgICAgICAgICAgKiB0cmFuc2xhdGVkLiBTdHJpbmdzIHdlIGNhbm5vdCBzZW5kIHRvIHRoZSBmdW5jdGlvbiBhYm92ZSBiZWNhdXNlCiAgICAgICAgICAgICAgICAqIHRoZXkgcmVxdWlyZSB2YXJpYWJsZSBpbnRlcnBvbGF0aW9uIGFuZCB3ZSBkb24ndCB5ZXQgaGF2ZSB0aGUKICAgICAgICAgICAgICAgICogdmFyaWFibGVzIGF0IHNjYW4gdGltZS4KICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICogU2VlIGFjdGlvbkluZm9NZXNzYWdlcwogICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgICB9CiAgICB9OwogICAgcmV0dXJuIHV0aWxzOwp9KTsKCi8vISBtb21lbnQuanMKLy8hIHZlcnNpb24gOiAyLjYuMAovLyEgYXV0aG9ycyA6IFRpbSBXb29kLCBJc2tyZW4gQ2hlcm5ldiwgTW9tZW50LmpzIGNvbnRyaWJ1dG9ycwovLyEgbGljZW5zZSA6IE1JVAovLyEgbW9tZW50anMuY29tCgooZnVuY3Rpb24gKHVuZGVmaW5lZCkgewoKICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgICAgICBDb25zdGFudHMKICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCiAgICB2YXIgbW9tZW50LAogICAgICAgIFZFUlNJT04gPSAiMi42LjAiLAogICAgICAgIC8vIHRoZSBnbG9iYWwtc2NvcGUgdGhpcyBpcyBOT1QgdGhlIGdsb2JhbCBvYmplY3QgaW4gTm9kZS5qcwogICAgICAgIGdsb2JhbFNjb3BlID0gdHlwZW9mIGdsb2JhbCAhPT0gJ3VuZGVmaW5lZCcgPyBnbG9iYWwgOiB0aGlzLAogICAgICAgIG9sZEdsb2JhbE1vbWVudCwKICAgICAgICByb3VuZCA9IE1hdGgucm91bmQsCiAgICAgICAgaSwKCiAgICAgICAgWUVBUiA9IDAsCiAgICAgICAgTU9OVEggPSAxLAogICAgICAgIERBVEUgPSAyLAogICAgICAgIEhPVVIgPSAzLAogICAgICAgIE1JTlVURSA9IDQsCiAgICAgICAgU0VDT05EID0gNSwKICAgICAgICBNSUxMSVNFQ09ORCA9IDYsCgogICAgICAgIC8vIGludGVybmFsIHN0b3JhZ2UgZm9yIGxhbmd1YWdlIGNvbmZpZyBmaWxlcwogICAgICAgIGxhbmd1YWdlcyA9IHt9LAoKICAgICAgICAvLyBtb21lbnQgaW50ZXJuYWwgcHJvcGVydGllcwogICAgICAgIG1vbWVudFByb3BlcnRpZXMgPSB7CiAgICAgICAgICAgIF9pc0FNb21lbnRPYmplY3Q6IG51bGwsCiAgICAgICAgICAgIF9pIDogbnVsbCwKICAgICAgICAgICAgX2YgOiBudWxsLAogICAgICAgICAgICBfbCA6IG51bGwsCiAgICAgICAgICAgIF9zdHJpY3QgOiBudWxsLAogICAgICAgICAgICBfaXNVVEMgOiBudWxsLAogICAgICAgICAgICBfb2Zmc2V0IDogbnVsbCwgIC8vIG9wdGlvbmFsLiBDb21iaW5lIHdpdGggX2lzVVRDCiAgICAgICAgICAgIF9wZiA6IG51bGwsCiAgICAgICAgICAgIF9sYW5nIDogbnVsbCAgLy8gb3B0aW9uYWwKICAgICAgICB9LAoKICAgICAgICAvLyBjaGVjayBmb3Igbm9kZUpTCiAgICAgICAgaGFzTW9kdWxlID0gKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKSwKCiAgICAgICAgLy8gQVNQLk5FVCBqc29uIGRhdGUgZm9ybWF0IHJlZ2V4CiAgICAgICAgYXNwTmV0SnNvblJlZ2V4ID0gL15cLz9EYXRlXCgoXC0/XGQrKS9pLAogICAgICAgIGFzcE5ldFRpbWVTcGFuSnNvblJlZ2V4ID0gLyhcLSk/KD86KFxkKilcLik/KFxkKylcOihcZCspKD86XDooXGQrKVwuPyhcZHszfSk/KT8vLAoKICAgICAgICAvLyBmcm9tIGh0dHA6Ly9kb2NzLmNsb3N1cmUtbGlicmFyeS5nb29nbGVjb2RlLmNvbS9naXQvY2xvc3VyZV9nb29nX2RhdGVfZGF0ZS5qcy5zb3VyY2UuaHRtbAogICAgICAgIC8vIHNvbWV3aGF0IG1vcmUgaW4gbGluZSB3aXRoIDQuNC4zLjIgMjAwNCBzcGVjLCBidXQgYWxsb3dzIGRlY2ltYWwgYW55d2hlcmUKICAgICAgICBpc29EdXJhdGlvblJlZ2V4ID0gL14oLSk/UCg/Oig/OihbMC05LC5dKilZKT8oPzooWzAtOSwuXSopTSk/KD86KFswLTksLl0qKUQpPyg/OlQoPzooWzAtOSwuXSopSCk/KD86KFswLTksLl0qKU0pPyg/OihbMC05LC5dKilTKT8pP3woWzAtOSwuXSopVykkLywKCiAgICAgICAgLy8gZm9ybWF0IHRva2VucwogICAgICAgIGZvcm1hdHRpbmdUb2tlbnMgPSAvKFxbW15cW10qXF0pfChcXCk/KE1vfE1NP00/TT98RG98REREb3xERD9EP0Q/fGRkZD9kP3xkbz98d1tvfHddP3xXW298V10/fFF8WVlZWVlZfFlZWVlZfFlZWVl8WVl8Z2coZ2dnPyk/fEdHKEdHRz8pP3xlfEV8YXxBfGhoP3xISD98bW0/fHNzP3xTezEsNH18WHx6ej98Wlo/fC4pL2csCiAgICAgICAgbG9jYWxGb3JtYXR0aW5nVG9rZW5zID0gLyhcW1teXFtdKlxdKXwoXFwpPyhMVHxMTD9MP0w/fGx7MSw0fSkvZywKCiAgICAgICAgLy8gcGFyc2luZyB0b2tlbiByZWdleGVzCiAgICAgICAgcGFyc2VUb2tlbk9uZU9yVHdvRGlnaXRzID0gL1xkXGQ/LywgLy8gMCAtIDk5CiAgICAgICAgcGFyc2VUb2tlbk9uZVRvVGhyZWVEaWdpdHMgPSAvXGR7MSwzfS8sIC8vIDAgLSA5OTkKICAgICAgICBwYXJzZVRva2VuT25lVG9Gb3VyRGlnaXRzID0gL1xkezEsNH0vLCAvLyAwIC0gOTk5OQogICAgICAgIHBhcnNlVG9rZW5PbmVUb1NpeERpZ2l0cyA9IC9bK1wtXT9cZHsxLDZ9LywgLy8gLTk5OSw5OTkgLSA5OTksOTk5CiAgICAgICAgcGFyc2VUb2tlbkRpZ2l0cyA9IC9cZCsvLCAvLyBub256ZXJvIG51bWJlciBvZiBkaWdpdHMKICAgICAgICBwYXJzZVRva2VuV29yZCA9IC9bMC05XSpbJ2Etelx1MDBBMC1cdTA1RkZcdTA3MDAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdK3xbXHUwNjAwLVx1MDZGRlwvXSsoXHMqP1tcdTA2MDAtXHUwNkZGXSspezEsMn0vaSwgLy8gYW55IHdvcmQgKG9yIHR3bykgY2hhcmFjdGVycyBvciBudW1iZXJzIGluY2x1ZGluZyB0d28vdGhyZWUgd29yZCBtb250aCBpbiBhcmFiaWMuCiAgICAgICAgcGFyc2VUb2tlblRpbWV6b25lID0gL1p8W1wrXC1dXGRcZDo/XGRcZC9naSwgLy8gKzAwOjAwIC0wMDowMCArMDAwMCAtMDAwMCBvciBaCiAgICAgICAgcGFyc2VUb2tlblQgPSAvVC9pLCAvLyBUIChJU08gc2VwYXJhdG9yKQogICAgICAgIHBhcnNlVG9rZW5UaW1lc3RhbXBNcyA9IC9bXCtcLV0/XGQrKFwuXGR7MSwzfSk/LywgLy8gMTIzNDU2Nzg5IDEyMzQ1Njc4OS4xMjMKICAgICAgICBwYXJzZVRva2VuT3JkaW5hbCA9IC9cZHsxLDJ9LywKCiAgICAgICAgLy9zdHJpY3QgcGFyc2luZyByZWdleGVzCiAgICAgICAgcGFyc2VUb2tlbk9uZURpZ2l0ID0gL1xkLywgLy8gMCAtIDkKICAgICAgICBwYXJzZVRva2VuVHdvRGlnaXRzID0gL1xkXGQvLCAvLyAwMCAtIDk5CiAgICAgICAgcGFyc2VUb2tlblRocmVlRGlnaXRzID0gL1xkezN9LywgLy8gMDAwIC0gOTk5CiAgICAgICAgcGFyc2VUb2tlbkZvdXJEaWdpdHMgPSAvXGR7NH0vLCAvLyAwMDAwIC0gOTk5OQogICAgICAgIHBhcnNlVG9rZW5TaXhEaWdpdHMgPSAvWystXT9cZHs2fS8sIC8vIC05OTksOTk5IC0gOTk5LDk5OQogICAgICAgIHBhcnNlVG9rZW5TaWduZWROdW1iZXIgPSAvWystXT9cZCsvLCAvLyAtaW5mIC0gaW5mCgogICAgICAgIC8vIGlzbyA4NjAxIHJlZ2V4CiAgICAgICAgLy8gMDAwMC0wMC0wMCAwMDAwLVcwMCBvciAwMDAwLVcwMC0wICsgVCArIDAwIG9yIDAwOjAwIG9yIDAwOjAwOjAwIG9yIDAwOjAwOjAwLjAwMCArICswMDowMCBvciArMDAwMCBvciArMDApCiAgICAgICAgaXNvUmVnZXggPSAvXlxzKig/OlsrLV1cZHs2fXxcZHs0fSktKD86KFxkXGQtXGRcZCl8KFdcZFxkJCl8KFdcZFxkLVxkKXwoXGRcZFxkKSkoKFR8ICkoXGRcZCg6XGRcZCg6XGRcZChcLlxkKyk/KT8pPyk/KFtcK1wtXVxkXGQoPzo6P1xkXGQpP3xccypaKT8pPyQvLAoKICAgICAgICBpc29Gb3JtYXQgPSAnWVlZWS1NTS1ERFRISDptbTpzc1onLAoKICAgICAgICBpc29EYXRlcyA9IFsKICAgICAgICAgICAgWydZWVlZWVktTU0tREQnLCAvWystXVxkezZ9LVxkezJ9LVxkezJ9L10sCiAgICAgICAgICAgIFsnWVlZWS1NTS1ERCcsIC9cZHs0fS1cZHsyfS1cZHsyfS9dLAogICAgICAgICAgICBbJ0dHR0ctW1ddV1ctRScsIC9cZHs0fS1XXGR7Mn0tXGQvXSwKICAgICAgICAgICAgWydHR0dHLVtXXVdXJywgL1xkezR9LVdcZHsyfS9dLAogICAgICAgICAgICBbJ1lZWVktREREJywgL1xkezR9LVxkezN9L10KICAgICAgICBdLAoKICAgICAgICAvLyBpc28gdGltZSBmb3JtYXRzIGFuZCByZWdleGVzCiAgICAgICAgaXNvVGltZXMgPSBbCiAgICAgICAgICAgIFsnSEg6bW06c3MuU1NTUycsIC8oVHwgKVxkXGQ6XGRcZDpcZFxkXC5cZCsvXSwKICAgICAgICAgICAgWydISDptbTpzcycsIC8oVHwgKVxkXGQ6XGRcZDpcZFxkL10sCiAgICAgICAgICAgIFsnSEg6bW0nLCAvKFR8IClcZFxkOlxkXGQvXSwKICAgICAgICAgICAgWydISCcsIC8oVHwgKVxkXGQvXQogICAgICAgIF0sCgogICAgICAgIC8vIHRpbWV6b25lIGNodW5rZXIgIisxMDowMCIgPiBbIjEwIiwgIjAwIl0gb3IgIi0xNTMwIiA+IFsiLTE1IiwgIjMwIl0KICAgICAgICBwYXJzZVRpbWV6b25lQ2h1bmtlciA9IC8oW1wrXC1dfFxkXGQpL2dpLAoKICAgICAgICAvLyBnZXR0ZXIgYW5kIHNldHRlciBuYW1lcwogICAgICAgIHByb3h5R2V0dGVyc0FuZFNldHRlcnMgPSAnRGF0ZXxIb3Vyc3xNaW51dGVzfFNlY29uZHN8TWlsbGlzZWNvbmRzJy5zcGxpdCgnfCcpLAogICAgICAgIHVuaXRNaWxsaXNlY29uZEZhY3RvcnMgPSB7CiAgICAgICAgICAgICdNaWxsaXNlY29uZHMnIDogMSwKICAgICAgICAgICAgJ1NlY29uZHMnIDogMWUzLAogICAgICAgICAgICAnTWludXRlcycgOiA2ZTQsCiAgICAgICAgICAgICdIb3VycycgOiAzNmU1LAogICAgICAgICAgICAnRGF5cycgOiA4NjRlNSwKICAgICAgICAgICAgJ01vbnRocycgOiAyNTkyZTYsCiAgICAgICAgICAgICdZZWFycycgOiAzMTUzNmU2CiAgICAgICAgfSwKCiAgICAgICAgdW5pdEFsaWFzZXMgPSB7CiAgICAgICAgICAgIG1zIDogJ21pbGxpc2Vjb25kJywKICAgICAgICAgICAgcyA6ICdzZWNvbmQnLAogICAgICAgICAgICBtIDogJ21pbnV0ZScsCiAgICAgICAgICAgIGggOiAnaG91cicsCiAgICAgICAgICAgIGQgOiAnZGF5JywKICAgICAgICAgICAgRCA6ICdkYXRlJywKICAgICAgICAgICAgdyA6ICd3ZWVrJywKICAgICAgICAgICAgVyA6ICdpc29XZWVrJywKICAgICAgICAgICAgTSA6ICdtb250aCcsCiAgICAgICAgICAgIFEgOiAncXVhcnRlcicsCiAgICAgICAgICAgIHkgOiAneWVhcicsCiAgICAgICAgICAgIERERCA6ICdkYXlPZlllYXInLAogICAgICAgICAgICBlIDogJ3dlZWtkYXknLAogICAgICAgICAgICBFIDogJ2lzb1dlZWtkYXknLAogICAgICAgICAgICBnZzogJ3dlZWtZZWFyJywKICAgICAgICAgICAgR0c6ICdpc29XZWVrWWVhcicKICAgICAgICB9LAoKICAgICAgICBjYW1lbEZ1bmN0aW9ucyA9IHsKICAgICAgICAgICAgZGF5b2Z5ZWFyIDogJ2RheU9mWWVhcicsCiAgICAgICAgICAgIGlzb3dlZWtkYXkgOiAnaXNvV2Vla2RheScsCiAgICAgICAgICAgIGlzb3dlZWsgOiAnaXNvV2VlaycsCiAgICAgICAgICAgIHdlZWt5ZWFyIDogJ3dlZWtZZWFyJywKICAgICAgICAgICAgaXNvd2Vla3llYXIgOiAnaXNvV2Vla1llYXInCiAgICAgICAgfSwKCiAgICAgICAgLy8gZm9ybWF0IGZ1bmN0aW9uIHN0cmluZ3MKICAgICAgICBmb3JtYXRGdW5jdGlvbnMgPSB7fSwKCiAgICAgICAgLy8gdG9rZW5zIHRvIG9yZGluYWxpemUgYW5kIHBhZAogICAgICAgIG9yZGluYWxpemVUb2tlbnMgPSAnREREIHcgVyBNIEQgZCcuc3BsaXQoJyAnKSwKICAgICAgICBwYWRkZWRUb2tlbnMgPSAnTSBEIEggaCBtIHMgdyBXJy5zcGxpdCgnICcpLAoKICAgICAgICBmb3JtYXRUb2tlbkZ1bmN0aW9ucyA9IHsKICAgICAgICAgICAgTSAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm1vbnRoKCkgKyAxOwogICAgICAgICAgICB9LAogICAgICAgICAgICBNTU0gIDogZnVuY3Rpb24gKGZvcm1hdCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubGFuZygpLm1vbnRoc1Nob3J0KHRoaXMsIGZvcm1hdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIE1NTU0gOiBmdW5jdGlvbiAoZm9ybWF0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sYW5nKCkubW9udGhzKHRoaXMsIGZvcm1hdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIEQgICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kYXRlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIERERCAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kYXlPZlllYXIoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZCAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRheSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBkZCAgIDogZnVuY3Rpb24gKGZvcm1hdCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubGFuZygpLndlZWtkYXlzTWluKHRoaXMsIGZvcm1hdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRkZCAgOiBmdW5jdGlvbiAoZm9ybWF0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sYW5nKCkud2Vla2RheXNTaG9ydCh0aGlzLCBmb3JtYXQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBkZGRkIDogZnVuY3Rpb24gKGZvcm1hdCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubGFuZygpLndlZWtkYXlzKHRoaXMsIGZvcm1hdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHcgICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy53ZWVrKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFcgICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pc29XZWVrKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFlZICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFplcm9GaWxsKHRoaXMueWVhcigpICUgMTAwLCAyKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgWVlZWSA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0WmVyb0ZpbGwodGhpcy55ZWFyKCksIDQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBZWVlZWSA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0WmVyb0ZpbGwodGhpcy55ZWFyKCksIDUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBZWVlZWVkgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgeSA9IHRoaXMueWVhcigpLCBzaWduID0geSA+PSAwID8gJysnIDogJy0nOwogICAgICAgICAgICAgICAgcmV0dXJuIHNpZ24gKyBsZWZ0WmVyb0ZpbGwoTWF0aC5hYnMoeSksIDYpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZyAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRaZXJvRmlsbCh0aGlzLndlZWtZZWFyKCkgJSAxMDAsIDIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZ2dnIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRaZXJvRmlsbCh0aGlzLndlZWtZZWFyKCksIDQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZ2dnZyA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0WmVyb0ZpbGwodGhpcy53ZWVrWWVhcigpLCA1KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgR0cgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0WmVyb0ZpbGwodGhpcy5pc29XZWVrWWVhcigpICUgMTAwLCAyKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgR0dHRyA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0WmVyb0ZpbGwodGhpcy5pc29XZWVrWWVhcigpLCA0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgR0dHR0cgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFplcm9GaWxsKHRoaXMuaXNvV2Vla1llYXIoKSwgNSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGUgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy53ZWVrZGF5KCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIEUgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pc29XZWVrZGF5KCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGEgICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sYW5nKCkubWVyaWRpZW0odGhpcy5ob3VycygpLCB0aGlzLm1pbnV0ZXMoKSwgdHJ1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIEEgICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sYW5nKCkubWVyaWRpZW0odGhpcy5ob3VycygpLCB0aGlzLm1pbnV0ZXMoKSwgZmFsc2UpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBIICAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaG91cnMoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaCAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmhvdXJzKCkgJSAxMiB8fCAxMjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbSAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm1pbnV0ZXMoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcyAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNlY29uZHMoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgUyAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0b0ludCh0aGlzLm1pbGxpc2Vjb25kcygpIC8gMTAwKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgU1MgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0WmVyb0ZpbGwodG9JbnQodGhpcy5taWxsaXNlY29uZHMoKSAvIDEwKSwgMik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFNTUyAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFplcm9GaWxsKHRoaXMubWlsbGlzZWNvbmRzKCksIDMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBTU1NTIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRaZXJvRmlsbCh0aGlzLm1pbGxpc2Vjb25kcygpLCAzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgWiAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBhID0gLXRoaXMuem9uZSgpLAogICAgICAgICAgICAgICAgICAgIGIgPSAiKyI7CiAgICAgICAgICAgICAgICBpZiAoYSA8IDApIHsKICAgICAgICAgICAgICAgICAgICBhID0gLWE7CiAgICAgICAgICAgICAgICAgICAgYiA9ICItIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBiICsgbGVmdFplcm9GaWxsKHRvSW50KGEgLyA2MCksIDIpICsgIjoiICsgbGVmdFplcm9GaWxsKHRvSW50KGEpICUgNjAsIDIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBaWiAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGEgPSAtdGhpcy56b25lKCksCiAgICAgICAgICAgICAgICAgICAgYiA9ICIrIjsKICAgICAgICAgICAgICAgIGlmIChhIDwgMCkgewogICAgICAgICAgICAgICAgICAgIGEgPSAtYTsKICAgICAgICAgICAgICAgICAgICBiID0gIi0iOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGIgKyBsZWZ0WmVyb0ZpbGwodG9JbnQoYSAvIDYwKSwgMikgKyBsZWZ0WmVyb0ZpbGwodG9JbnQoYSkgJSA2MCwgMik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHogOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy56b25lQWJicigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB6eiA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnpvbmVOYW1lKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFggICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy51bml4KCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFEgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5xdWFydGVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBsaXN0cyA9IFsnbW9udGhzJywgJ21vbnRoc1Nob3J0JywgJ3dlZWtkYXlzJywgJ3dlZWtkYXlzU2hvcnQnLCAnd2Vla2RheXNNaW4nXTsKCiAgICBmdW5jdGlvbiBkZWZhdWx0UGFyc2luZ0ZsYWdzKCkgewogICAgICAgIC8vIFdlIG5lZWQgdG8gZGVlcCBjbG9uZSB0aGlzIG9iamVjdCwgYW5kIGVzNSBzdGFuZGFyZCBpcyBub3QgdmVyeQogICAgICAgIC8vIGhlbHBmdWwuCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZW1wdHkgOiBmYWxzZSwKICAgICAgICAgICAgdW51c2VkVG9rZW5zIDogW10sCiAgICAgICAgICAgIHVudXNlZElucHV0IDogW10sCiAgICAgICAgICAgIG92ZXJmbG93IDogLTIsCiAgICAgICAgICAgIGNoYXJzTGVmdE92ZXIgOiAwLAogICAgICAgICAgICBudWxsSW5wdXQgOiBmYWxzZSwKICAgICAgICAgICAgaW52YWxpZE1vbnRoIDogbnVsbCwKICAgICAgICAgICAgaW52YWxpZEZvcm1hdCA6IGZhbHNlLAogICAgICAgICAgICB1c2VySW52YWxpZGF0ZWQgOiBmYWxzZSwKICAgICAgICAgICAgaXNvOiBmYWxzZQogICAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gZGVwcmVjYXRlKG1zZywgZm4pIHsKICAgICAgICB2YXIgZmlyc3RUaW1lID0gdHJ1ZTsKICAgICAgICBmdW5jdGlvbiBwcmludE1zZygpIHsKICAgICAgICAgICAgaWYgKG1vbWVudC5zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZ3MgPT09IGZhbHNlICYmCiAgICAgICAgICAgICAgICAgICAgdHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnICYmIGNvbnNvbGUud2FybikgewogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJEZXByZWNhdGlvbiB3YXJuaW5nOiAiICsgbXNnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKGZpcnN0VGltZSkgewogICAgICAgICAgICAgICAgcHJpbnRNc2coKTsKICAgICAgICAgICAgICAgIGZpcnN0VGltZSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0sIGZuKTsKICAgIH0KCiAgICBmdW5jdGlvbiBwYWRUb2tlbihmdW5jLCBjb3VudCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICByZXR1cm4gbGVmdFplcm9GaWxsKGZ1bmMuY2FsbCh0aGlzLCBhKSwgY291bnQpOwogICAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBvcmRpbmFsaXplVG9rZW4oZnVuYywgcGVyaW9kKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxhbmcoKS5vcmRpbmFsKGZ1bmMuY2FsbCh0aGlzLCBhKSwgcGVyaW9kKTsKICAgICAgICB9OwogICAgfQoKICAgIHdoaWxlIChvcmRpbmFsaXplVG9rZW5zLmxlbmd0aCkgewogICAgICAgIGkgPSBvcmRpbmFsaXplVG9rZW5zLnBvcCgpOwogICAgICAgIGZvcm1hdFRva2VuRnVuY3Rpb25zW2kgKyAnbyddID0gb3JkaW5hbGl6ZVRva2VuKGZvcm1hdFRva2VuRnVuY3Rpb25zW2ldLCBpKTsKICAgIH0KICAgIHdoaWxlIChwYWRkZWRUb2tlbnMubGVuZ3RoKSB7CiAgICAgICAgaSA9IHBhZGRlZFRva2Vucy5wb3AoKTsKICAgICAgICBmb3JtYXRUb2tlbkZ1bmN0aW9uc1tpICsgaV0gPSBwYWRUb2tlbihmb3JtYXRUb2tlbkZ1bmN0aW9uc1tpXSwgMik7CiAgICB9CiAgICBmb3JtYXRUb2tlbkZ1bmN0aW9ucy5EREREID0gcGFkVG9rZW4oZm9ybWF0VG9rZW5GdW5jdGlvbnMuRERELCAzKTsKCgogICAgLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgogICAgICAgIENvbnN0cnVjdG9ycwogICAgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwoKICAgIGZ1bmN0aW9uIExhbmd1YWdlKCkgewoKICAgIH0KCiAgICAvLyBNb21lbnQgcHJvdG90eXBlIG9iamVjdAogICAgZnVuY3Rpb24gTW9tZW50KGNvbmZpZykgewogICAgICAgIGNoZWNrT3ZlcmZsb3coY29uZmlnKTsKICAgICAgICBleHRlbmQodGhpcywgY29uZmlnKTsKICAgIH0KCiAgICAvLyBEdXJhdGlvbiBDb25zdHJ1Y3RvcgogICAgZnVuY3Rpb24gRHVyYXRpb24oZHVyYXRpb24pIHsKICAgICAgICB2YXIgbm9ybWFsaXplZElucHV0ID0gbm9ybWFsaXplT2JqZWN0VW5pdHMoZHVyYXRpb24pLAogICAgICAgICAgICB5ZWFycyA9IG5vcm1hbGl6ZWRJbnB1dC55ZWFyIHx8IDAsCiAgICAgICAgICAgIHF1YXJ0ZXJzID0gbm9ybWFsaXplZElucHV0LnF1YXJ0ZXIgfHwgMCwKICAgICAgICAgICAgbW9udGhzID0gbm9ybWFsaXplZElucHV0Lm1vbnRoIHx8IDAsCiAgICAgICAgICAgIHdlZWtzID0gbm9ybWFsaXplZElucHV0LndlZWsgfHwgMCwKICAgICAgICAgICAgZGF5cyA9IG5vcm1hbGl6ZWRJbnB1dC5kYXkgfHwgMCwKICAgICAgICAgICAgaG91cnMgPSBub3JtYWxpemVkSW5wdXQuaG91ciB8fCAwLAogICAgICAgICAgICBtaW51dGVzID0gbm9ybWFsaXplZElucHV0Lm1pbnV0ZSB8fCAwLAogICAgICAgICAgICBzZWNvbmRzID0gbm9ybWFsaXplZElucHV0LnNlY29uZCB8fCAwLAogICAgICAgICAgICBtaWxsaXNlY29uZHMgPSBub3JtYWxpemVkSW5wdXQubWlsbGlzZWNvbmQgfHwgMDsKCiAgICAgICAgLy8gcmVwcmVzZW50YXRpb24gZm9yIGRhdGVBZGRSZW1vdmUKICAgICAgICB0aGlzLl9taWxsaXNlY29uZHMgPSArbWlsbGlzZWNvbmRzICsKICAgICAgICAgICAgc2Vjb25kcyAqIDFlMyArIC8vIDEwMDAKICAgICAgICAgICAgbWludXRlcyAqIDZlNCArIC8vIDEwMDAgKiA2MAogICAgICAgICAgICBob3VycyAqIDM2ZTU7IC8vIDEwMDAgKiA2MCAqIDYwCiAgICAgICAgLy8gQmVjYXVzZSBvZiBkYXRlQWRkUmVtb3ZlIHRyZWF0cyAyNCBob3VycyBhcyBkaWZmZXJlbnQgZnJvbSBhCiAgICAgICAgLy8gZGF5IHdoZW4gd29ya2luZyBhcm91bmQgRFNULCB3ZSBuZWVkIHRvIHN0b3JlIHRoZW0gc2VwYXJhdGVseQogICAgICAgIHRoaXMuX2RheXMgPSArZGF5cyArCiAgICAgICAgICAgIHdlZWtzICogNzsKICAgICAgICAvLyBJdCBpcyBpbXBvc3NpYmxlIHRyYW5zbGF0ZSBtb250aHMgaW50byBkYXlzIHdpdGhvdXQga25vd2luZwogICAgICAgIC8vIHdoaWNoIG1vbnRocyB5b3UgYXJlIGFyZSB0YWxraW5nIGFib3V0LCBzbyB3ZSBoYXZlIHRvIHN0b3JlCiAgICAgICAgLy8gaXQgc2VwYXJhdGVseS4KICAgICAgICB0aGlzLl9tb250aHMgPSArbW9udGhzICsKICAgICAgICAgICAgcXVhcnRlcnMgKiAzICsKICAgICAgICAgICAgeWVhcnMgKiAxMjsKCiAgICAgICAgdGhpcy5fZGF0YSA9IHt9OwoKICAgICAgICB0aGlzLl9idWJibGUoKTsKICAgIH0KCiAgICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICAgICAgSGVscGVycwogICAgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwoKCiAgICBmdW5jdGlvbiBleHRlbmQoYSwgYikgewogICAgICAgIGZvciAodmFyIGkgaW4gYikgewogICAgICAgICAgICBpZiAoYi5oYXNPd25Qcm9wZXJ0eShpKSkgewogICAgICAgICAgICAgICAgYVtpXSA9IGJbaV07CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChiLmhhc093blByb3BlcnR5KCJ0b1N0cmluZyIpKSB7CiAgICAgICAgICAgIGEudG9TdHJpbmcgPSBiLnRvU3RyaW5nOwogICAgICAgIH0KCiAgICAgICAgaWYgKGIuaGFzT3duUHJvcGVydHkoInZhbHVlT2YiKSkgewogICAgICAgICAgICBhLnZhbHVlT2YgPSBiLnZhbHVlT2Y7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gYTsKICAgIH0KCiAgICBmdW5jdGlvbiBjbG9uZU1vbWVudChtKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IHt9LCBpOwogICAgICAgIGZvciAoaSBpbiBtKSB7CiAgICAgICAgICAgIGlmIChtLmhhc093blByb3BlcnR5KGkpICYmIG1vbWVudFByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkoaSkpIHsKICAgICAgICAgICAgICAgIHJlc3VsdFtpXSA9IG1baV07CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgZnVuY3Rpb24gYWJzUm91bmQobnVtYmVyKSB7CiAgICAgICAgaWYgKG51bWJlciA8IDApIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGguY2VpbChudW1iZXIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBNYXRoLmZsb29yKG51bWJlcik7CiAgICAgICAgfQogICAgfQoKICAgIC8vIGxlZnQgemVybyBmaWxsIGEgbnVtYmVyCiAgICAvLyBzZWUgaHR0cDovL2pzcGVyZi5jb20vbGVmdC16ZXJvLWZpbGxpbmcgZm9yIHBlcmZvcm1hbmNlIGNvbXBhcmlzb24KICAgIGZ1bmN0aW9uIGxlZnRaZXJvRmlsbChudW1iZXIsIHRhcmdldExlbmd0aCwgZm9yY2VTaWduKSB7CiAgICAgICAgdmFyIG91dHB1dCA9ICcnICsgTWF0aC5hYnMobnVtYmVyKSwKICAgICAgICAgICAgc2lnbiA9IG51bWJlciA+PSAwOwoKICAgICAgICB3aGlsZSAob3V0cHV0Lmxlbmd0aCA8IHRhcmdldExlbmd0aCkgewogICAgICAgICAgICBvdXRwdXQgPSAnMCcgKyBvdXRwdXQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiAoc2lnbiA/IChmb3JjZVNpZ24gPyAnKycgOiAnJykgOiAnLScpICsgb3V0cHV0OwogICAgfQoKICAgIC8vIGhlbHBlciBmdW5jdGlvbiBmb3IgXy5hZGRUaW1lIGFuZCBfLnN1YnRyYWN0VGltZQogICAgZnVuY3Rpb24gYWRkT3JTdWJ0cmFjdER1cmF0aW9uRnJvbU1vbWVudChtb20sIGR1cmF0aW9uLCBpc0FkZGluZywgdXBkYXRlT2Zmc2V0KSB7CiAgICAgICAgdmFyIG1pbGxpc2Vjb25kcyA9IGR1cmF0aW9uLl9taWxsaXNlY29uZHMsCiAgICAgICAgICAgIGRheXMgPSBkdXJhdGlvbi5fZGF5cywKICAgICAgICAgICAgbW9udGhzID0gZHVyYXRpb24uX21vbnRoczsKICAgICAgICB1cGRhdGVPZmZzZXQgPSB1cGRhdGVPZmZzZXQgPT0gbnVsbCA/IHRydWUgOiB1cGRhdGVPZmZzZXQ7CgogICAgICAgIGlmIChtaWxsaXNlY29uZHMpIHsKICAgICAgICAgICAgbW9tLl9kLnNldFRpbWUoK21vbS5fZCArIG1pbGxpc2Vjb25kcyAqIGlzQWRkaW5nKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRheXMpIHsKICAgICAgICAgICAgcmF3U2V0dGVyKG1vbSwgJ0RhdGUnLCByYXdHZXR0ZXIobW9tLCAnRGF0ZScpICsgZGF5cyAqIGlzQWRkaW5nKTsKICAgICAgICB9CiAgICAgICAgaWYgKG1vbnRocykgewogICAgICAgICAgICByYXdNb250aFNldHRlcihtb20sIHJhd0dldHRlcihtb20sICdNb250aCcpICsgbW9udGhzICogaXNBZGRpbmcpOwogICAgICAgIH0KICAgICAgICBpZiAodXBkYXRlT2Zmc2V0KSB7CiAgICAgICAgICAgIG1vbWVudC51cGRhdGVPZmZzZXQobW9tLCBkYXlzIHx8IG1vbnRocyk7CiAgICAgICAgfQogICAgfQoKICAgIC8vIGNoZWNrIGlmIGlzIGFuIGFycmF5CiAgICBmdW5jdGlvbiBpc0FycmF5KGlucHV0KSB7CiAgICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChpbnB1dCkgPT09ICdbb2JqZWN0IEFycmF5XSc7CiAgICB9CgogICAgZnVuY3Rpb24gaXNEYXRlKGlucHV0KSB7CiAgICAgICAgcmV0dXJuICBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoaW5wdXQpID09PSAnW29iamVjdCBEYXRlXScgfHwKICAgICAgICAgICAgICAgIGlucHV0IGluc3RhbmNlb2YgRGF0ZTsKICAgIH0KCiAgICAvLyBjb21wYXJlIHR3byBhcnJheXMsIHJldHVybiB0aGUgbnVtYmVyIG9mIGRpZmZlcmVuY2VzCiAgICBmdW5jdGlvbiBjb21wYXJlQXJyYXlzKGFycmF5MSwgYXJyYXkyLCBkb250Q29udmVydCkgewogICAgICAgIHZhciBsZW4gPSBNYXRoLm1pbihhcnJheTEubGVuZ3RoLCBhcnJheTIubGVuZ3RoKSwKICAgICAgICAgICAgbGVuZ3RoRGlmZiA9IE1hdGguYWJzKGFycmF5MS5sZW5ndGggLSBhcnJheTIubGVuZ3RoKSwKICAgICAgICAgICAgZGlmZnMgPSAwLAogICAgICAgICAgICBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICBpZiAoKGRvbnRDb252ZXJ0ICYmIGFycmF5MVtpXSAhPT0gYXJyYXkyW2ldKSB8fAogICAgICAgICAgICAgICAgKCFkb250Q29udmVydCAmJiB0b0ludChhcnJheTFbaV0pICE9PSB0b0ludChhcnJheTJbaV0pKSkgewogICAgICAgICAgICAgICAgZGlmZnMrKzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZGlmZnMgKyBsZW5ndGhEaWZmOwogICAgfQoKICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZVVuaXRzKHVuaXRzKSB7CiAgICAgICAgaWYgKHVuaXRzKSB7CiAgICAgICAgICAgIHZhciBsb3dlcmVkID0gdW5pdHMudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC8oLilzJC8sICckMScpOwogICAgICAgICAgICB1bml0cyA9IHVuaXRBbGlhc2VzW3VuaXRzXSB8fCBjYW1lbEZ1bmN0aW9uc1tsb3dlcmVkXSB8fCBsb3dlcmVkOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdW5pdHM7CiAgICB9CgogICAgZnVuY3Rpb24gbm9ybWFsaXplT2JqZWN0VW5pdHMoaW5wdXRPYmplY3QpIHsKICAgICAgICB2YXIgbm9ybWFsaXplZElucHV0ID0ge30sCiAgICAgICAgICAgIG5vcm1hbGl6ZWRQcm9wLAogICAgICAgICAgICBwcm9wOwoKICAgICAgICBmb3IgKHByb3AgaW4gaW5wdXRPYmplY3QpIHsKICAgICAgICAgICAgaWYgKGlucHV0T2JqZWN0Lmhhc093blByb3BlcnR5KHByb3ApKSB7CiAgICAgICAgICAgICAgICBub3JtYWxpemVkUHJvcCA9IG5vcm1hbGl6ZVVuaXRzKHByb3ApOwogICAgICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZWRQcm9wKSB7CiAgICAgICAgICAgICAgICAgICAgbm9ybWFsaXplZElucHV0W25vcm1hbGl6ZWRQcm9wXSA9IGlucHV0T2JqZWN0W3Byb3BdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbm9ybWFsaXplZElucHV0OwogICAgfQoKICAgIGZ1bmN0aW9uIG1ha2VMaXN0KGZpZWxkKSB7CiAgICAgICAgdmFyIGNvdW50LCBzZXR0ZXI7CgogICAgICAgIGlmIChmaWVsZC5pbmRleE9mKCd3ZWVrJykgPT09IDApIHsKICAgICAgICAgICAgY291bnQgPSA3OwogICAgICAgICAgICBzZXR0ZXIgPSAnZGF5JzsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoZmllbGQuaW5kZXhPZignbW9udGgnKSA9PT0gMCkgewogICAgICAgICAgICBjb3VudCA9IDEyOwogICAgICAgICAgICBzZXR0ZXIgPSAnbW9udGgnOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgbW9tZW50W2ZpZWxkXSA9IGZ1bmN0aW9uIChmb3JtYXQsIGluZGV4KSB7CiAgICAgICAgICAgIHZhciBpLCBnZXR0ZXIsCiAgICAgICAgICAgICAgICBtZXRob2QgPSBtb21lbnQuZm4uX2xhbmdbZmllbGRdLAogICAgICAgICAgICAgICAgcmVzdWx0cyA9IFtdOwoKICAgICAgICAgICAgaWYgKHR5cGVvZiBmb3JtYXQgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgICAgICBpbmRleCA9IGZvcm1hdDsKICAgICAgICAgICAgICAgIGZvcm1hdCA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZ2V0dGVyID0gZnVuY3Rpb24gKGkpIHsKICAgICAgICAgICAgICAgIHZhciBtID0gbW9tZW50KCkudXRjKCkuc2V0KHNldHRlciwgaSk7CiAgICAgICAgICAgICAgICByZXR1cm4gbWV0aG9kLmNhbGwobW9tZW50LmZuLl9sYW5nLCBtLCBmb3JtYXQgfHwgJycpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKGluZGV4ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBnZXR0ZXIoaW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2goZ2V0dGVyKGkpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiB0b0ludChhcmd1bWVudEZvckNvZXJjaW9uKSB7CiAgICAgICAgdmFyIGNvZXJjZWROdW1iZXIgPSArYXJndW1lbnRGb3JDb2VyY2lvbiwKICAgICAgICAgICAgdmFsdWUgPSAwOwoKICAgICAgICBpZiAoY29lcmNlZE51bWJlciAhPT0gMCAmJiBpc0Zpbml0ZShjb2VyY2VkTnVtYmVyKSkgewogICAgICAgICAgICBpZiAoY29lcmNlZE51bWJlciA+PSAwKSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IE1hdGguZmxvb3IoY29lcmNlZE51bWJlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IE1hdGguY2VpbChjb2VyY2VkTnVtYmVyKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQoKICAgIGZ1bmN0aW9uIGRheXNJbk1vbnRoKHllYXIsIG1vbnRoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKERhdGUuVVRDKHllYXIsIG1vbnRoICsgMSwgMCkpLmdldFVUQ0RhdGUoKTsKICAgIH0KCiAgICBmdW5jdGlvbiB3ZWVrc0luWWVhcih5ZWFyLCBkb3csIGRveSkgewogICAgICAgIHJldHVybiB3ZWVrT2ZZZWFyKG1vbWVudChbeWVhciwgMTEsIDMxICsgZG93IC0gZG95XSksIGRvdywgZG95KS53ZWVrOwogICAgfQoKICAgIGZ1bmN0aW9uIGRheXNJblllYXIoeWVhcikgewogICAgICAgIHJldHVybiBpc0xlYXBZZWFyKHllYXIpID8gMzY2IDogMzY1OwogICAgfQoKICAgIGZ1bmN0aW9uIGlzTGVhcFllYXIoeWVhcikgewogICAgICAgIHJldHVybiAoeWVhciAlIDQgPT09IDAgJiYgeWVhciAlIDEwMCAhPT0gMCkgfHwgeWVhciAlIDQwMCA9PT0gMDsKICAgIH0KCiAgICBmdW5jdGlvbiBjaGVja092ZXJmbG93KG0pIHsKICAgICAgICB2YXIgb3ZlcmZsb3c7CiAgICAgICAgaWYgKG0uX2EgJiYgbS5fcGYub3ZlcmZsb3cgPT09IC0yKSB7CiAgICAgICAgICAgIG92ZXJmbG93ID0KICAgICAgICAgICAgICAgIG0uX2FbTU9OVEhdIDwgMCB8fCBtLl9hW01PTlRIXSA+IDExID8gTU9OVEggOgogICAgICAgICAgICAgICAgbS5fYVtEQVRFXSA8IDEgfHwgbS5fYVtEQVRFXSA+IGRheXNJbk1vbnRoKG0uX2FbWUVBUl0sIG0uX2FbTU9OVEhdKSA/IERBVEUgOgogICAgICAgICAgICAgICAgbS5fYVtIT1VSXSA8IDAgfHwgbS5fYVtIT1VSXSA+IDIzID8gSE9VUiA6CiAgICAgICAgICAgICAgICBtLl9hW01JTlVURV0gPCAwIHx8IG0uX2FbTUlOVVRFXSA+IDU5ID8gTUlOVVRFIDoKICAgICAgICAgICAgICAgIG0uX2FbU0VDT05EXSA8IDAgfHwgbS5fYVtTRUNPTkRdID4gNTkgPyBTRUNPTkQgOgogICAgICAgICAgICAgICAgbS5fYVtNSUxMSVNFQ09ORF0gPCAwIHx8IG0uX2FbTUlMTElTRUNPTkRdID4gOTk5ID8gTUlMTElTRUNPTkQgOgogICAgICAgICAgICAgICAgLTE7CgogICAgICAgICAgICBpZiAobS5fcGYuX292ZXJmbG93RGF5T2ZZZWFyICYmIChvdmVyZmxvdyA8IFlFQVIgfHwgb3ZlcmZsb3cgPiBEQVRFKSkgewogICAgICAgICAgICAgICAgb3ZlcmZsb3cgPSBEQVRFOwogICAgICAgICAgICB9CgogICAgICAgICAgICBtLl9wZi5vdmVyZmxvdyA9IG92ZXJmbG93OwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpc1ZhbGlkKG0pIHsKICAgICAgICBpZiAobS5faXNWYWxpZCA9PSBudWxsKSB7CiAgICAgICAgICAgIG0uX2lzVmFsaWQgPSAhaXNOYU4obS5fZC5nZXRUaW1lKCkpICYmCiAgICAgICAgICAgICAgICBtLl9wZi5vdmVyZmxvdyA8IDAgJiYKICAgICAgICAgICAgICAgICFtLl9wZi5lbXB0eSAmJgogICAgICAgICAgICAgICAgIW0uX3BmLmludmFsaWRNb250aCAmJgogICAgICAgICAgICAgICAgIW0uX3BmLm51bGxJbnB1dCAmJgogICAgICAgICAgICAgICAgIW0uX3BmLmludmFsaWRGb3JtYXQgJiYKICAgICAgICAgICAgICAgICFtLl9wZi51c2VySW52YWxpZGF0ZWQ7CgogICAgICAgICAgICBpZiAobS5fc3RyaWN0KSB7CiAgICAgICAgICAgICAgICBtLl9pc1ZhbGlkID0gbS5faXNWYWxpZCAmJgogICAgICAgICAgICAgICAgICAgIG0uX3BmLmNoYXJzTGVmdE92ZXIgPT09IDAgJiYKICAgICAgICAgICAgICAgICAgICBtLl9wZi51bnVzZWRUb2tlbnMubGVuZ3RoID09PSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBtLl9pc1ZhbGlkOwogICAgfQoKICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZUxhbmd1YWdlKGtleSkgewogICAgICAgIHJldHVybiBrZXkgPyBrZXkudG9Mb3dlckNhc2UoKS5yZXBsYWNlKCdfJywgJy0nKSA6IGtleTsKICAgIH0KCiAgICAvLyBSZXR1cm4gYSBtb21lbnQgZnJvbSBpbnB1dCwgdGhhdCBpcyBsb2NhbC91dGMvem9uZSBlcXVpdmFsZW50IHRvIG1vZGVsLgogICAgZnVuY3Rpb24gbWFrZUFzKGlucHV0LCBtb2RlbCkgewogICAgICAgIHJldHVybiBtb2RlbC5faXNVVEMgPyBtb21lbnQoaW5wdXQpLnpvbmUobW9kZWwuX29mZnNldCB8fCAwKSA6CiAgICAgICAgICAgIG1vbWVudChpbnB1dCkubG9jYWwoKTsKICAgIH0KCiAgICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICAgICAgTGFuZ3VhZ2VzCiAgICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCgoKICAgIGV4dGVuZChMYW5ndWFnZS5wcm90b3R5cGUsIHsKCiAgICAgICAgc2V0IDogZnVuY3Rpb24gKGNvbmZpZykgewogICAgICAgICAgICB2YXIgcHJvcCwgaTsKICAgICAgICAgICAgZm9yIChpIGluIGNvbmZpZykgewogICAgICAgICAgICAgICAgcHJvcCA9IGNvbmZpZ1tpXTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvcCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgIHRoaXNbaV0gPSBwcm9wOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzWydfJyArIGldID0gcHJvcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIF9tb250aHMgOiAiSmFudWFyeV9GZWJydWFyeV9NYXJjaF9BcHJpbF9NYXlfSnVuZV9KdWx5X0F1Z3VzdF9TZXB0ZW1iZXJfT2N0b2Jlcl9Ob3ZlbWJlcl9EZWNlbWJlciIuc3BsaXQoIl8iKSwKICAgICAgICBtb250aHMgOiBmdW5jdGlvbiAobSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbW9udGhzW20ubW9udGgoKV07CiAgICAgICAgfSwKCiAgICAgICAgX21vbnRoc1Nob3J0IDogIkphbl9GZWJfTWFyX0Fwcl9NYXlfSnVuX0p1bF9BdWdfU2VwX09jdF9Ob3ZfRGVjIi5zcGxpdCgiXyIpLAogICAgICAgIG1vbnRoc1Nob3J0IDogZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21vbnRoc1Nob3J0W20ubW9udGgoKV07CiAgICAgICAgfSwKCiAgICAgICAgbW9udGhzUGFyc2UgOiBmdW5jdGlvbiAobW9udGhOYW1lKSB7CiAgICAgICAgICAgIHZhciBpLCBtb20sIHJlZ2V4OwoKICAgICAgICAgICAgaWYgKCF0aGlzLl9tb250aHNQYXJzZSkgewogICAgICAgICAgICAgICAgdGhpcy5fbW9udGhzUGFyc2UgPSBbXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IDEyOyBpKyspIHsKICAgICAgICAgICAgICAgIC8vIG1ha2UgdGhlIHJlZ2V4IGlmIHdlIGRvbid0IGhhdmUgaXQgYWxyZWFkeQogICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9tb250aHNQYXJzZVtpXSkgewogICAgICAgICAgICAgICAgICAgIG1vbSA9IG1vbWVudC51dGMoWzIwMDAsIGldKTsKICAgICAgICAgICAgICAgICAgICByZWdleCA9ICdeJyArIHRoaXMubW9udGhzKG1vbSwgJycpICsgJ3xeJyArIHRoaXMubW9udGhzU2hvcnQobW9tLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbW9udGhzUGFyc2VbaV0gPSBuZXcgUmVnRXhwKHJlZ2V4LnJlcGxhY2UoJy4nLCAnJyksICdpJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyB0ZXN0IHRoZSByZWdleAogICAgICAgICAgICAgICAgaWYgKHRoaXMuX21vbnRoc1BhcnNlW2ldLnRlc3QobW9udGhOYW1lKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgX3dlZWtkYXlzIDogIlN1bmRheV9Nb25kYXlfVHVlc2RheV9XZWRuZXNkYXlfVGh1cnNkYXlfRnJpZGF5X1NhdHVyZGF5Ii5zcGxpdCgiXyIpLAogICAgICAgIHdlZWtkYXlzIDogZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3dlZWtkYXlzW20uZGF5KCldOwogICAgICAgIH0sCgogICAgICAgIF93ZWVrZGF5c1Nob3J0IDogIlN1bl9Nb25fVHVlX1dlZF9UaHVfRnJpX1NhdCIuc3BsaXQoIl8iKSwKICAgICAgICB3ZWVrZGF5c1Nob3J0IDogZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3dlZWtkYXlzU2hvcnRbbS5kYXkoKV07CiAgICAgICAgfSwKCiAgICAgICAgX3dlZWtkYXlzTWluIDogIlN1X01vX1R1X1dlX1RoX0ZyX1NhIi5zcGxpdCgiXyIpLAogICAgICAgIHdlZWtkYXlzTWluIDogZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3dlZWtkYXlzTWluW20uZGF5KCldOwogICAgICAgIH0sCgogICAgICAgIHdlZWtkYXlzUGFyc2UgOiBmdW5jdGlvbiAod2Vla2RheU5hbWUpIHsKICAgICAgICAgICAgdmFyIGksIG1vbSwgcmVnZXg7CgogICAgICAgICAgICBpZiAoIXRoaXMuX3dlZWtkYXlzUGFyc2UpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3dlZWtkYXlzUGFyc2UgPSBbXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IDc7IGkrKykgewogICAgICAgICAgICAgICAgLy8gbWFrZSB0aGUgcmVnZXggaWYgd2UgZG9uJ3QgaGF2ZSBpdCBhbHJlYWR5CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX3dlZWtkYXlzUGFyc2VbaV0pIHsKICAgICAgICAgICAgICAgICAgICBtb20gPSBtb21lbnQoWzIwMDAsIDFdKS5kYXkoaSk7CiAgICAgICAgICAgICAgICAgICAgcmVnZXggPSAnXicgKyB0aGlzLndlZWtkYXlzKG1vbSwgJycpICsgJ3xeJyArIHRoaXMud2Vla2RheXNTaG9ydChtb20sICcnKSArICd8XicgKyB0aGlzLndlZWtkYXlzTWluKG1vbSwgJycpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3dlZWtkYXlzUGFyc2VbaV0gPSBuZXcgUmVnRXhwKHJlZ2V4LnJlcGxhY2UoJy4nLCAnJyksICdpJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyB0ZXN0IHRoZSByZWdleAogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3dlZWtkYXlzUGFyc2VbaV0udGVzdCh3ZWVrZGF5TmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIF9sb25nRGF0ZUZvcm1hdCA6IHsKICAgICAgICAgICAgTFQgOiAiaDptbSBBIiwKICAgICAgICAgICAgTCA6ICJNTS9ERC9ZWVlZIiwKICAgICAgICAgICAgTEwgOiAiTU1NTSBEIFlZWVkiLAogICAgICAgICAgICBMTEwgOiAiTU1NTSBEIFlZWVkgTFQiLAogICAgICAgICAgICBMTExMIDogImRkZGQsIE1NTU0gRCBZWVlZIExUIgogICAgICAgIH0sCiAgICAgICAgbG9uZ0RhdGVGb3JtYXQgOiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgIHZhciBvdXRwdXQgPSB0aGlzLl9sb25nRGF0ZUZvcm1hdFtrZXldOwogICAgICAgICAgICBpZiAoIW91dHB1dCAmJiB0aGlzLl9sb25nRGF0ZUZvcm1hdFtrZXkudG9VcHBlckNhc2UoKV0pIHsKICAgICAgICAgICAgICAgIG91dHB1dCA9IHRoaXMuX2xvbmdEYXRlRm9ybWF0W2tleS50b1VwcGVyQ2FzZSgpXS5yZXBsYWNlKC9NTU1NfE1NfEREfGRkZGQvZywgZnVuY3Rpb24gKHZhbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWwuc2xpY2UoMSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMuX2xvbmdEYXRlRm9ybWF0W2tleV0gPSBvdXRwdXQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgICAgICB9LAoKICAgICAgICBpc1BNIDogZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgICAgIC8vIElFOCBRdWlya3MgTW9kZSAmIElFNyBTdGFuZGFyZHMgTW9kZSBkbyBub3QgYWxsb3cgYWNjZXNzaW5nIHN0cmluZ3MgbGlrZSBhcnJheXMKICAgICAgICAgICAgLy8gVXNpbmcgY2hhckF0IHNob3VsZCBiZSBtb3JlIGNvbXBhdGlibGUuCiAgICAgICAgICAgIHJldHVybiAoKGlucHV0ICsgJycpLnRvTG93ZXJDYXNlKCkuY2hhckF0KDApID09PSAncCcpOwogICAgICAgIH0sCgogICAgICAgIF9tZXJpZGllbVBhcnNlIDogL1thcF1cLj9tP1wuPy9pLAogICAgICAgIG1lcmlkaWVtIDogZnVuY3Rpb24gKGhvdXJzLCBtaW51dGVzLCBpc0xvd2VyKSB7CiAgICAgICAgICAgIGlmIChob3VycyA+IDExKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaXNMb3dlciA/ICdwbScgOiAnUE0nOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGlzTG93ZXIgPyAnYW0nIDogJ0FNJzsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIF9jYWxlbmRhciA6IHsKICAgICAgICAgICAgc2FtZURheSA6ICdbVG9kYXkgYXRdIExUJywKICAgICAgICAgICAgbmV4dERheSA6ICdbVG9tb3Jyb3cgYXRdIExUJywKICAgICAgICAgICAgbmV4dFdlZWsgOiAnZGRkZCBbYXRdIExUJywKICAgICAgICAgICAgbGFzdERheSA6ICdbWWVzdGVyZGF5IGF0XSBMVCcsCiAgICAgICAgICAgIGxhc3RXZWVrIDogJ1tMYXN0XSBkZGRkIFthdF0gTFQnLAogICAgICAgICAgICBzYW1lRWxzZSA6ICdMJwogICAgICAgIH0sCiAgICAgICAgY2FsZW5kYXIgOiBmdW5jdGlvbiAoa2V5LCBtb20pIHsKICAgICAgICAgICAgdmFyIG91dHB1dCA9IHRoaXMuX2NhbGVuZGFyW2tleV07CiAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb3V0cHV0ID09PSAnZnVuY3Rpb24nID8gb3V0cHV0LmFwcGx5KG1vbSkgOiBvdXRwdXQ7CiAgICAgICAgfSwKCiAgICAgICAgX3JlbGF0aXZlVGltZSA6IHsKICAgICAgICAgICAgZnV0dXJlIDogImluICVzIiwKICAgICAgICAgICAgcGFzdCA6ICIlcyBhZ28iLAogICAgICAgICAgICBzIDogImEgZmV3IHNlY29uZHMiLAogICAgICAgICAgICBtIDogImEgbWludXRlIiwKICAgICAgICAgICAgbW0gOiAiJWQgbWludXRlcyIsCiAgICAgICAgICAgIGggOiAiYW4gaG91ciIsCiAgICAgICAgICAgIGhoIDogIiVkIGhvdXJzIiwKICAgICAgICAgICAgZCA6ICJhIGRheSIsCiAgICAgICAgICAgIGRkIDogIiVkIGRheXMiLAogICAgICAgICAgICBNIDogImEgbW9udGgiLAogICAgICAgICAgICBNTSA6ICIlZCBtb250aHMiLAogICAgICAgICAgICB5IDogImEgeWVhciIsCiAgICAgICAgICAgIHl5IDogIiVkIHllYXJzIgogICAgICAgIH0sCiAgICAgICAgcmVsYXRpdmVUaW1lIDogZnVuY3Rpb24gKG51bWJlciwgd2l0aG91dFN1ZmZpeCwgc3RyaW5nLCBpc0Z1dHVyZSkgewogICAgICAgICAgICB2YXIgb3V0cHV0ID0gdGhpcy5fcmVsYXRpdmVUaW1lW3N0cmluZ107CiAgICAgICAgICAgIHJldHVybiAodHlwZW9mIG91dHB1dCA9PT0gJ2Z1bmN0aW9uJykgPwogICAgICAgICAgICAgICAgb3V0cHV0KG51bWJlciwgd2l0aG91dFN1ZmZpeCwgc3RyaW5nLCBpc0Z1dHVyZSkgOgogICAgICAgICAgICAgICAgb3V0cHV0LnJlcGxhY2UoLyVkL2ksIG51bWJlcik7CiAgICAgICAgfSwKICAgICAgICBwYXN0RnV0dXJlIDogZnVuY3Rpb24gKGRpZmYsIG91dHB1dCkgewogICAgICAgICAgICB2YXIgZm9ybWF0ID0gdGhpcy5fcmVsYXRpdmVUaW1lW2RpZmYgPiAwID8gJ2Z1dHVyZScgOiAncGFzdCddOwogICAgICAgICAgICByZXR1cm4gdHlwZW9mIGZvcm1hdCA9PT0gJ2Z1bmN0aW9uJyA/IGZvcm1hdChvdXRwdXQpIDogZm9ybWF0LnJlcGxhY2UoLyVzL2ksIG91dHB1dCk7CiAgICAgICAgfSwKCiAgICAgICAgb3JkaW5hbCA6IGZ1bmN0aW9uIChudW1iZXIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29yZGluYWwucmVwbGFjZSgiJWQiLCBudW1iZXIpOwogICAgICAgIH0sCiAgICAgICAgX29yZGluYWwgOiAiJWQiLAoKICAgICAgICBwcmVwYXJzZSA6IGZ1bmN0aW9uIChzdHJpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgICB9LAoKICAgICAgICBwb3N0Zm9ybWF0IDogZnVuY3Rpb24gKHN0cmluZykgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICAgIH0sCgogICAgICAgIHdlZWsgOiBmdW5jdGlvbiAobW9tKSB7CiAgICAgICAgICAgIHJldHVybiB3ZWVrT2ZZZWFyKG1vbSwgdGhpcy5fd2Vlay5kb3csIHRoaXMuX3dlZWsuZG95KS53ZWVrOwogICAgICAgIH0sCgogICAgICAgIF93ZWVrIDogewogICAgICAgICAgICBkb3cgOiAwLCAvLyBTdW5kYXkgaXMgdGhlIGZpcnN0IGRheSBvZiB0aGUgd2Vlay4KICAgICAgICAgICAgZG95IDogNiAgLy8gVGhlIHdlZWsgdGhhdCBjb250YWlucyBKYW4gMXN0IGlzIHRoZSBmaXJzdCB3ZWVrIG9mIHRoZSB5ZWFyLgogICAgICAgIH0sCgogICAgICAgIF9pbnZhbGlkRGF0ZTogJ0ludmFsaWQgZGF0ZScsCiAgICAgICAgaW52YWxpZERhdGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ludmFsaWREYXRlOwogICAgICAgIH0KICAgIH0pOwoKICAgIC8vIExvYWRzIGEgbGFuZ3VhZ2UgZGVmaW5pdGlvbiBpbnRvIHRoZSBgbGFuZ3VhZ2VzYCBjYWNoZS4gIFRoZSBmdW5jdGlvbgogICAgLy8gdGFrZXMgYSBrZXkgYW5kIG9wdGlvbmFsbHkgdmFsdWVzLiAgSWYgbm90IGluIHRoZSBicm93c2VyIGFuZCBubyB2YWx1ZXMKICAgIC8vIGFyZSBwcm92aWRlZCwgaXQgd2lsbCBsb2FkIHRoZSBsYW5ndWFnZSBmaWxlIG1vZHVsZS4gIEFzIGEgY29udmVuaWVuY2UsCiAgICAvLyB0aGlzIGZ1bmN0aW9uIGFsc28gcmV0dXJucyB0aGUgbGFuZ3VhZ2UgdmFsdWVzLgogICAgZnVuY3Rpb24gbG9hZExhbmcoa2V5LCB2YWx1ZXMpIHsKICAgICAgICB2YWx1ZXMuYWJiciA9IGtleTsKICAgICAgICBpZiAoIWxhbmd1YWdlc1trZXldKSB7CiAgICAgICAgICAgIGxhbmd1YWdlc1trZXldID0gbmV3IExhbmd1YWdlKCk7CiAgICAgICAgfQogICAgICAgIGxhbmd1YWdlc1trZXldLnNldCh2YWx1ZXMpOwogICAgICAgIHJldHVybiBsYW5ndWFnZXNba2V5XTsKICAgIH0KCiAgICAvLyBSZW1vdmUgYSBsYW5ndWFnZSBmcm9tIHRoZSBgbGFuZ3VhZ2VzYCBjYWNoZS4gTW9zdGx5IHVzZWZ1bCBpbiB0ZXN0cy4KICAgIGZ1bmN0aW9uIHVubG9hZExhbmcoa2V5KSB7CiAgICAgICAgZGVsZXRlIGxhbmd1YWdlc1trZXldOwogICAgfQoKICAgIC8vIERldGVybWluZXMgd2hpY2ggbGFuZ3VhZ2UgZGVmaW5pdGlvbiB0byB1c2UgYW5kIHJldHVybnMgaXQuCiAgICAvLwogICAgLy8gV2l0aCBubyBwYXJhbWV0ZXJzLCBpdCB3aWxsIHJldHVybiB0aGUgZ2xvYmFsIGxhbmd1YWdlLiAgSWYgeW91CiAgICAvLyBwYXNzIGluIGEgbGFuZ3VhZ2Uga2V5LCBzdWNoIGFzICdlbicsIGl0IHdpbGwgcmV0dXJuIHRoZQogICAgLy8gZGVmaW5pdGlvbiBmb3IgJ2VuJywgc28gbG9uZyBhcyAnZW4nIGhhcyBhbHJlYWR5IGJlZW4gbG9hZGVkIHVzaW5nCiAgICAvLyBtb21lbnQubGFuZy4KICAgIGZ1bmN0aW9uIGdldExhbmdEZWZpbml0aW9uKGtleSkgewogICAgICAgIHZhciBpID0gMCwgaiwgbGFuZywgbmV4dCwgc3BsaXQsCiAgICAgICAgICAgIGdldCA9IGZ1bmN0aW9uIChrKSB7CiAgICAgICAgICAgICAgICBpZiAoIWxhbmd1YWdlc1trXSAmJiBoYXNNb2R1bGUpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICByZXF1aXJlKCcuL2xhbmcvJyArIGspOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGxhbmd1YWdlc1trXTsKICAgICAgICAgICAgfTsKCiAgICAgICAgaWYgKCFrZXkpIHsKICAgICAgICAgICAgcmV0dXJuIG1vbWVudC5mbi5fbGFuZzsKICAgICAgICB9CgogICAgICAgIGlmICghaXNBcnJheShrZXkpKSB7CiAgICAgICAgICAgIC8vc2hvcnQtY2lyY3VpdCBldmVyeXRoaW5nIGVsc2UKICAgICAgICAgICAgbGFuZyA9IGdldChrZXkpOwogICAgICAgICAgICBpZiAobGFuZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGxhbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAga2V5ID0gW2tleV07CiAgICAgICAgfQoKICAgICAgICAvL3BpY2sgdGhlIGxhbmd1YWdlIGZyb20gdGhlIGFycmF5CiAgICAgICAgLy90cnkgWydlbi1hdScsICdlbi1nYiddIGFzICdlbi1hdScsICdlbi1nYicsICdlbicsIGFzIGluIG1vdmUgdGhyb3VnaCB0aGUgbGlzdCB0cnlpbmcgZWFjaAogICAgICAgIC8vc3Vic3RyaW5nIGZyb20gbW9zdCBzcGVjaWZpYyB0byBsZWFzdCwgYnV0IG1vdmUgdG8gdGhlIG5leHQgYXJyYXkgaXRlbSBpZiBpdCdzIGEgbW9yZSBzcGVjaWZpYyB2YXJpYW50IHRoYW4gdGhlIGN1cnJlbnQgcm9vdAogICAgICAgIHdoaWxlIChpIDwga2V5Lmxlbmd0aCkgewogICAgICAgICAgICBzcGxpdCA9IG5vcm1hbGl6ZUxhbmd1YWdlKGtleVtpXSkuc3BsaXQoJy0nKTsKICAgICAgICAgICAgaiA9IHNwbGl0Lmxlbmd0aDsKICAgICAgICAgICAgbmV4dCA9IG5vcm1hbGl6ZUxhbmd1YWdlKGtleVtpICsgMV0pOwogICAgICAgICAgICBuZXh0ID0gbmV4dCA/IG5leHQuc3BsaXQoJy0nKSA6IG51bGw7CiAgICAgICAgICAgIHdoaWxlIChqID4gMCkgewogICAgICAgICAgICAgICAgbGFuZyA9IGdldChzcGxpdC5zbGljZSgwLCBqKS5qb2luKCctJykpOwogICAgICAgICAgICAgICAgaWYgKGxhbmcpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGFuZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChuZXh0ICYmIG5leHQubGVuZ3RoID49IGogJiYgY29tcGFyZUFycmF5cyhzcGxpdCwgbmV4dCwgdHJ1ZSkgPj0gaiAtIDEpIHsKICAgICAgICAgICAgICAgICAgICAvL3RoZSBuZXh0IGFycmF5IGl0ZW0gaXMgYmV0dGVyIHRoYW4gYSBzaGFsbG93ZXIgc3Vic3RyaW5nIG9mIHRoaXMgb25lCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBqLS07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaSsrOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbW9tZW50LmZuLl9sYW5nOwogICAgfQoKICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgICAgICBGb3JtYXR0aW5nCiAgICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCgoKICAgIGZ1bmN0aW9uIHJlbW92ZUZvcm1hdHRpbmdUb2tlbnMoaW5wdXQpIHsKICAgICAgICBpZiAoaW5wdXQubWF0Y2goL1xbW1xzXFNdLykpIHsKICAgICAgICAgICAgcmV0dXJuIGlucHV0LnJlcGxhY2UoL15cW3xcXSQvZywgIiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaW5wdXQucmVwbGFjZSgvXFwvZywgIiIpOwogICAgfQoKICAgIGZ1bmN0aW9uIG1ha2VGb3JtYXRGdW5jdGlvbihmb3JtYXQpIHsKICAgICAgICB2YXIgYXJyYXkgPSBmb3JtYXQubWF0Y2goZm9ybWF0dGluZ1Rva2VucyksIGksIGxlbmd0aDsKCiAgICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKGZvcm1hdFRva2VuRnVuY3Rpb25zW2FycmF5W2ldXSkgewogICAgICAgICAgICAgICAgYXJyYXlbaV0gPSBmb3JtYXRUb2tlbkZ1bmN0aW9uc1thcnJheVtpXV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhcnJheVtpXSA9IHJlbW92ZUZvcm1hdHRpbmdUb2tlbnMoYXJyYXlbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG1vbSkgewogICAgICAgICAgICB2YXIgb3V0cHV0ID0gIiI7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgb3V0cHV0ICs9IGFycmF5W2ldIGluc3RhbmNlb2YgRnVuY3Rpb24gPyBhcnJheVtpXS5jYWxsKG1vbSwgZm9ybWF0KSA6IGFycmF5W2ldOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgICAgfTsKICAgIH0KCiAgICAvLyBmb3JtYXQgZGF0ZSB1c2luZyBuYXRpdmUgZGF0ZSBvYmplY3QKICAgIGZ1bmN0aW9uIGZvcm1hdE1vbWVudChtLCBmb3JtYXQpIHsKCiAgICAgICAgaWYgKCFtLmlzVmFsaWQoKSkgewogICAgICAgICAgICByZXR1cm4gbS5sYW5nKCkuaW52YWxpZERhdGUoKTsKICAgICAgICB9CgogICAgICAgIGZvcm1hdCA9IGV4cGFuZEZvcm1hdChmb3JtYXQsIG0ubGFuZygpKTsKCiAgICAgICAgaWYgKCFmb3JtYXRGdW5jdGlvbnNbZm9ybWF0XSkgewogICAgICAgICAgICBmb3JtYXRGdW5jdGlvbnNbZm9ybWF0XSA9IG1ha2VGb3JtYXRGdW5jdGlvbihmb3JtYXQpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZvcm1hdEZ1bmN0aW9uc1tmb3JtYXRdKG0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGV4cGFuZEZvcm1hdChmb3JtYXQsIGxhbmcpIHsKICAgICAgICB2YXIgaSA9IDU7CgogICAgICAgIGZ1bmN0aW9uIHJlcGxhY2VMb25nRGF0ZUZvcm1hdFRva2VucyhpbnB1dCkgewogICAgICAgICAgICByZXR1cm4gbGFuZy5sb25nRGF0ZUZvcm1hdChpbnB1dCkgfHwgaW5wdXQ7CiAgICAgICAgfQoKICAgICAgICBsb2NhbEZvcm1hdHRpbmdUb2tlbnMubGFzdEluZGV4ID0gMDsKICAgICAgICB3aGlsZSAoaSA+PSAwICYmIGxvY2FsRm9ybWF0dGluZ1Rva2Vucy50ZXN0KGZvcm1hdCkpIHsKICAgICAgICAgICAgZm9ybWF0ID0gZm9ybWF0LnJlcGxhY2UobG9jYWxGb3JtYXR0aW5nVG9rZW5zLCByZXBsYWNlTG9uZ0RhdGVGb3JtYXRUb2tlbnMpOwogICAgICAgICAgICBsb2NhbEZvcm1hdHRpbmdUb2tlbnMubGFzdEluZGV4ID0gMDsKICAgICAgICAgICAgaSAtPSAxOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZvcm1hdDsKICAgIH0KCgogICAgLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgogICAgICAgIFBhcnNpbmcKICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCgogICAgLy8gZ2V0IHRoZSByZWdleCB0byBmaW5kIHRoZSBuZXh0IHRva2VuCiAgICBmdW5jdGlvbiBnZXRQYXJzZVJlZ2V4Rm9yVG9rZW4odG9rZW4sIGNvbmZpZykgewogICAgICAgIHZhciBhLCBzdHJpY3QgPSBjb25maWcuX3N0cmljdDsKICAgICAgICBzd2l0Y2ggKHRva2VuKSB7CiAgICAgICAgY2FzZSAnUSc6CiAgICAgICAgICAgIHJldHVybiBwYXJzZVRva2VuT25lRGlnaXQ7CiAgICAgICAgY2FzZSAnRERERCc6CiAgICAgICAgICAgIHJldHVybiBwYXJzZVRva2VuVGhyZWVEaWdpdHM7CiAgICAgICAgY2FzZSAnWVlZWSc6CiAgICAgICAgY2FzZSAnR0dHRyc6CiAgICAgICAgY2FzZSAnZ2dnZyc6CiAgICAgICAgICAgIHJldHVybiBzdHJpY3QgPyBwYXJzZVRva2VuRm91ckRpZ2l0cyA6IHBhcnNlVG9rZW5PbmVUb0ZvdXJEaWdpdHM7CiAgICAgICAgY2FzZSAnWSc6CiAgICAgICAgY2FzZSAnRyc6CiAgICAgICAgY2FzZSAnZyc6CiAgICAgICAgICAgIHJldHVybiBwYXJzZVRva2VuU2lnbmVkTnVtYmVyOwogICAgICAgIGNhc2UgJ1lZWVlZWSc6CiAgICAgICAgY2FzZSAnWVlZWVknOgogICAgICAgIGNhc2UgJ0dHR0dHJzoKICAgICAgICBjYXNlICdnZ2dnZyc6CiAgICAgICAgICAgIHJldHVybiBzdHJpY3QgPyBwYXJzZVRva2VuU2l4RGlnaXRzIDogcGFyc2VUb2tlbk9uZVRvU2l4RGlnaXRzOwogICAgICAgIGNhc2UgJ1MnOgogICAgICAgICAgICBpZiAoc3RyaWN0KSB7IHJldHVybiBwYXJzZVRva2VuT25lRGlnaXQ7IH0KICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgIGNhc2UgJ1NTJzoKICAgICAgICAgICAgaWYgKHN0cmljdCkgeyByZXR1cm4gcGFyc2VUb2tlblR3b0RpZ2l0czsgfQogICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgY2FzZSAnU1NTJzoKICAgICAgICAgICAgaWYgKHN0cmljdCkgeyByZXR1cm4gcGFyc2VUb2tlblRocmVlRGlnaXRzOyB9CiAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi8KICAgICAgICBjYXNlICdEREQnOgogICAgICAgICAgICByZXR1cm4gcGFyc2VUb2tlbk9uZVRvVGhyZWVEaWdpdHM7CiAgICAgICAgY2FzZSAnTU1NJzoKICAgICAgICBjYXNlICdNTU1NJzoKICAgICAgICBjYXNlICdkZCc6CiAgICAgICAgY2FzZSAnZGRkJzoKICAgICAgICBjYXNlICdkZGRkJzoKICAgICAgICAgICAgcmV0dXJuIHBhcnNlVG9rZW5Xb3JkOwogICAgICAgIGNhc2UgJ2EnOgogICAgICAgIGNhc2UgJ0EnOgogICAgICAgICAgICByZXR1cm4gZ2V0TGFuZ0RlZmluaXRpb24oY29uZmlnLl9sKS5fbWVyaWRpZW1QYXJzZTsKICAgICAgICBjYXNlICdYJzoKICAgICAgICAgICAgcmV0dXJuIHBhcnNlVG9rZW5UaW1lc3RhbXBNczsKICAgICAgICBjYXNlICdaJzoKICAgICAgICBjYXNlICdaWic6CiAgICAgICAgICAgIHJldHVybiBwYXJzZVRva2VuVGltZXpvbmU7CiAgICAgICAgY2FzZSAnVCc6CiAgICAgICAgICAgIHJldHVybiBwYXJzZVRva2VuVDsKICAgICAgICBjYXNlICdTU1NTJzoKICAgICAgICAgICAgcmV0dXJuIHBhcnNlVG9rZW5EaWdpdHM7CiAgICAgICAgY2FzZSAnTU0nOgogICAgICAgIGNhc2UgJ0REJzoKICAgICAgICBjYXNlICdZWSc6CiAgICAgICAgY2FzZSAnR0cnOgogICAgICAgIGNhc2UgJ2dnJzoKICAgICAgICBjYXNlICdISCc6CiAgICAgICAgY2FzZSAnaGgnOgogICAgICAgIGNhc2UgJ21tJzoKICAgICAgICBjYXNlICdzcyc6CiAgICAgICAgY2FzZSAnd3cnOgogICAgICAgIGNhc2UgJ1dXJzoKICAgICAgICAgICAgcmV0dXJuIHN0cmljdCA/IHBhcnNlVG9rZW5Ud29EaWdpdHMgOiBwYXJzZVRva2VuT25lT3JUd29EaWdpdHM7CiAgICAgICAgY2FzZSAnTSc6CiAgICAgICAgY2FzZSAnRCc6CiAgICAgICAgY2FzZSAnZCc6CiAgICAgICAgY2FzZSAnSCc6CiAgICAgICAgY2FzZSAnaCc6CiAgICAgICAgY2FzZSAnbSc6CiAgICAgICAgY2FzZSAncyc6CiAgICAgICAgY2FzZSAndyc6CiAgICAgICAgY2FzZSAnVyc6CiAgICAgICAgY2FzZSAnZSc6CiAgICAgICAgY2FzZSAnRSc6CiAgICAgICAgICAgIHJldHVybiBwYXJzZVRva2VuT25lT3JUd29EaWdpdHM7CiAgICAgICAgY2FzZSAnRG8nOgogICAgICAgICAgICByZXR1cm4gcGFyc2VUb2tlbk9yZGluYWw7CiAgICAgICAgZGVmYXVsdCA6CiAgICAgICAgICAgIGEgPSBuZXcgUmVnRXhwKHJlZ2V4cEVzY2FwZSh1bmVzY2FwZUZvcm1hdCh0b2tlbi5yZXBsYWNlKCdcXCcsICcnKSksICJpIikpOwogICAgICAgICAgICByZXR1cm4gYTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gdGltZXpvbmVNaW51dGVzRnJvbVN0cmluZyhzdHJpbmcpIHsKICAgICAgICBzdHJpbmcgPSBzdHJpbmcgfHwgIiI7CiAgICAgICAgdmFyIHBvc3NpYmxlVHpNYXRjaGVzID0gKHN0cmluZy5tYXRjaChwYXJzZVRva2VuVGltZXpvbmUpIHx8IFtdKSwKICAgICAgICAgICAgdHpDaHVuayA9IHBvc3NpYmxlVHpNYXRjaGVzW3Bvc3NpYmxlVHpNYXRjaGVzLmxlbmd0aCAtIDFdIHx8IFtdLAogICAgICAgICAgICBwYXJ0cyA9ICh0ekNodW5rICsgJycpLm1hdGNoKHBhcnNlVGltZXpvbmVDaHVua2VyKSB8fCBbJy0nLCAwLCAwXSwKICAgICAgICAgICAgbWludXRlcyA9ICsocGFydHNbMV0gKiA2MCkgKyB0b0ludChwYXJ0c1syXSk7CgogICAgICAgIHJldHVybiBwYXJ0c1swXSA9PT0gJysnID8gLW1pbnV0ZXMgOiBtaW51dGVzOwogICAgfQoKICAgIC8vIGZ1bmN0aW9uIHRvIGNvbnZlcnQgc3RyaW5nIGlucHV0IHRvIGRhdGUKICAgIGZ1bmN0aW9uIGFkZFRpbWVUb0FycmF5RnJvbVRva2VuKHRva2VuLCBpbnB1dCwgY29uZmlnKSB7CiAgICAgICAgdmFyIGEsIGRhdGVQYXJ0QXJyYXkgPSBjb25maWcuX2E7CgogICAgICAgIHN3aXRjaCAodG9rZW4pIHsKICAgICAgICAvLyBRVUFSVEVSCiAgICAgICAgY2FzZSAnUSc6CiAgICAgICAgICAgIGlmIChpbnB1dCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBkYXRlUGFydEFycmF5W01PTlRIXSA9ICh0b0ludChpbnB1dCkgLSAxKSAqIDM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gTU9OVEgKICAgICAgICBjYXNlICdNJyA6IC8vIGZhbGwgdGhyb3VnaCB0byBNTQogICAgICAgIGNhc2UgJ01NJyA6CiAgICAgICAgICAgIGlmIChpbnB1dCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBkYXRlUGFydEFycmF5W01PTlRIXSA9IHRvSW50KGlucHV0KSAtIDE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAnTU1NJyA6IC8vIGZhbGwgdGhyb3VnaCB0byBNTU1NCiAgICAgICAgY2FzZSAnTU1NTScgOgogICAgICAgICAgICBhID0gZ2V0TGFuZ0RlZmluaXRpb24oY29uZmlnLl9sKS5tb250aHNQYXJzZShpbnB1dCk7CiAgICAgICAgICAgIC8vIGlmIHdlIGRpZG4ndCBmaW5kIGEgbW9udGggbmFtZSwgbWFyayB0aGUgZGF0ZSBhcyBpbnZhbGlkLgogICAgICAgICAgICBpZiAoYSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBkYXRlUGFydEFycmF5W01PTlRIXSA9IGE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25maWcuX3BmLmludmFsaWRNb250aCA9IGlucHV0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIC8vIERBWSBPRiBNT05USAogICAgICAgIGNhc2UgJ0QnIDogLy8gZmFsbCB0aHJvdWdoIHRvIERECiAgICAgICAgY2FzZSAnREQnIDoKICAgICAgICAgICAgaWYgKGlucHV0ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGRhdGVQYXJ0QXJyYXlbREFURV0gPSB0b0ludChpbnB1dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAnRG8nIDoKICAgICAgICAgICAgaWYgKGlucHV0ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGRhdGVQYXJ0QXJyYXlbREFURV0gPSB0b0ludChwYXJzZUludChpbnB1dCwgMTApKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAvLyBEQVkgT0YgWUVBUgogICAgICAgIGNhc2UgJ0RERCcgOiAvLyBmYWxsIHRocm91Z2ggdG8gRERERAogICAgICAgIGNhc2UgJ0REREQnIDoKICAgICAgICAgICAgaWYgKGlucHV0ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5fZGF5T2ZZZWFyID0gdG9JbnQoaW5wdXQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBicmVhazsKICAgICAgICAvLyBZRUFSCiAgICAgICAgY2FzZSAnWVknIDoKICAgICAgICAgICAgZGF0ZVBhcnRBcnJheVtZRUFSXSA9IG1vbWVudC5wYXJzZVR3b0RpZ2l0WWVhcihpbnB1dCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ1lZWVknIDoKICAgICAgICBjYXNlICdZWVlZWScgOgogICAgICAgIGNhc2UgJ1lZWVlZWScgOgogICAgICAgICAgICBkYXRlUGFydEFycmF5W1lFQVJdID0gdG9JbnQoaW5wdXQpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAvLyBBTSAvIFBNCiAgICAgICAgY2FzZSAnYScgOiAvLyBmYWxsIHRocm91Z2ggdG8gQQogICAgICAgIGNhc2UgJ0EnIDoKICAgICAgICAgICAgY29uZmlnLl9pc1BtID0gZ2V0TGFuZ0RlZmluaXRpb24oY29uZmlnLl9sKS5pc1BNKGlucHV0KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gMjQgSE9VUgogICAgICAgIGNhc2UgJ0gnIDogLy8gZmFsbCB0aHJvdWdoIHRvIGhoCiAgICAgICAgY2FzZSAnSEgnIDogLy8gZmFsbCB0aHJvdWdoIHRvIGhoCiAgICAgICAgY2FzZSAnaCcgOiAvLyBmYWxsIHRocm91Z2ggdG8gaGgKICAgICAgICBjYXNlICdoaCcgOgogICAgICAgICAgICBkYXRlUGFydEFycmF5W0hPVVJdID0gdG9JbnQoaW5wdXQpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAvLyBNSU5VVEUKICAgICAgICBjYXNlICdtJyA6IC8vIGZhbGwgdGhyb3VnaCB0byBtbQogICAgICAgIGNhc2UgJ21tJyA6CiAgICAgICAgICAgIGRhdGVQYXJ0QXJyYXlbTUlOVVRFXSA9IHRvSW50KGlucHV0KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gU0VDT05ECiAgICAgICAgY2FzZSAncycgOiAvLyBmYWxsIHRocm91Z2ggdG8gc3MKICAgICAgICBjYXNlICdzcycgOgogICAgICAgICAgICBkYXRlUGFydEFycmF5W1NFQ09ORF0gPSB0b0ludChpbnB1dCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIC8vIE1JTExJU0VDT05ECiAgICAgICAgY2FzZSAnUycgOgogICAgICAgIGNhc2UgJ1NTJyA6CiAgICAgICAgY2FzZSAnU1NTJyA6CiAgICAgICAgY2FzZSAnU1NTUycgOgogICAgICAgICAgICBkYXRlUGFydEFycmF5W01JTExJU0VDT05EXSA9IHRvSW50KCgnMC4nICsgaW5wdXQpICogMTAwMCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIC8vIFVOSVggVElNRVNUQU1QIFdJVEggTVMKICAgICAgICBjYXNlICdYJzoKICAgICAgICAgICAgY29uZmlnLl9kID0gbmV3IERhdGUocGFyc2VGbG9hdChpbnB1dCkgKiAxMDAwKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gVElNRVpPTkUKICAgICAgICBjYXNlICdaJyA6IC8vIGZhbGwgdGhyb3VnaCB0byBaWgogICAgICAgIGNhc2UgJ1paJyA6CiAgICAgICAgICAgIGNvbmZpZy5fdXNlVVRDID0gdHJ1ZTsKICAgICAgICAgICAgY29uZmlnLl90em0gPSB0aW1lem9uZU1pbnV0ZXNGcm9tU3RyaW5nKGlucHV0KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAndyc6CiAgICAgICAgY2FzZSAnd3cnOgogICAgICAgIGNhc2UgJ1cnOgogICAgICAgIGNhc2UgJ1dXJzoKICAgICAgICBjYXNlICdkJzoKICAgICAgICBjYXNlICdkZCc6CiAgICAgICAgY2FzZSAnZGRkJzoKICAgICAgICBjYXNlICdkZGRkJzoKICAgICAgICBjYXNlICdlJzoKICAgICAgICBjYXNlICdFJzoKICAgICAgICAgICAgdG9rZW4gPSB0b2tlbi5zdWJzdHIoMCwgMSk7CiAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi8KICAgICAgICBjYXNlICdnZyc6CiAgICAgICAgY2FzZSAnZ2dnZyc6CiAgICAgICAgY2FzZSAnR0cnOgogICAgICAgIGNhc2UgJ0dHR0cnOgogICAgICAgIGNhc2UgJ0dHR0dHJzoKICAgICAgICAgICAgdG9rZW4gPSB0b2tlbi5zdWJzdHIoMCwgMik7CiAgICAgICAgICAgIGlmIChpbnB1dCkgewogICAgICAgICAgICAgICAgY29uZmlnLl93ID0gY29uZmlnLl93IHx8IHt9OwogICAgICAgICAgICAgICAgY29uZmlnLl93W3Rva2VuXSA9IGlucHV0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBjb252ZXJ0IGFuIGFycmF5IHRvIGEgZGF0ZS4KICAgIC8vIHRoZSBhcnJheSBzaG91bGQgbWlycm9yIHRoZSBwYXJhbWV0ZXJzIGJlbG93CiAgICAvLyBub3RlOiBhbGwgdmFsdWVzIHBhc3QgdGhlIHllYXIgYXJlIG9wdGlvbmFsIGFuZCB3aWxsIGRlZmF1bHQgdG8gdGhlIGxvd2VzdCBwb3NzaWJsZSB2YWx1ZS4KICAgIC8vIFt5ZWFyLCBtb250aCwgZGF5ICwgaG91ciwgbWludXRlLCBzZWNvbmQsIG1pbGxpc2Vjb25kXQogICAgZnVuY3Rpb24gZGF0ZUZyb21Db25maWcoY29uZmlnKSB7CiAgICAgICAgdmFyIGksIGRhdGUsIGlucHV0ID0gW10sIGN1cnJlbnREYXRlLAogICAgICAgICAgICB5ZWFyVG9Vc2UsIGZpeFllYXIsIHcsIHRlbXAsIGxhbmcsIHdlZWtkYXksIHdlZWs7CgogICAgICAgIGlmIChjb25maWcuX2QpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY3VycmVudERhdGUgPSBjdXJyZW50RGF0ZUFycmF5KGNvbmZpZyk7CgogICAgICAgIC8vY29tcHV0ZSBkYXkgb2YgdGhlIHllYXIgZnJvbSB3ZWVrcyBhbmQgd2Vla2RheXMKICAgICAgICBpZiAoY29uZmlnLl93ICYmIGNvbmZpZy5fYVtEQVRFXSA9PSBudWxsICYmIGNvbmZpZy5fYVtNT05USF0gPT0gbnVsbCkgewogICAgICAgICAgICBmaXhZZWFyID0gZnVuY3Rpb24gKHZhbCkgewogICAgICAgICAgICAgICAgdmFyIGludFZhbCA9IHBhcnNlSW50KHZhbCwgMTApOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbCA/CiAgICAgICAgICAgICAgICAgICh2YWwubGVuZ3RoIDwgMyA/IChpbnRWYWwgPiA2OCA/IDE5MDAgKyBpbnRWYWwgOiAyMDAwICsgaW50VmFsKSA6IGludFZhbCkgOgogICAgICAgICAgICAgICAgICAoY29uZmlnLl9hW1lFQVJdID09IG51bGwgPyBtb21lbnQoKS53ZWVrWWVhcigpIDogY29uZmlnLl9hW1lFQVJdKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHcgPSBjb25maWcuX3c7CiAgICAgICAgICAgIGlmICh3LkdHICE9IG51bGwgfHwgdy5XICE9IG51bGwgfHwgdy5FICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHRlbXAgPSBkYXlPZlllYXJGcm9tV2Vla3MoZml4WWVhcih3LkdHKSwgdy5XIHx8IDEsIHcuRSwgNCwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBsYW5nID0gZ2V0TGFuZ0RlZmluaXRpb24oY29uZmlnLl9sKTsKICAgICAgICAgICAgICAgIHdlZWtkYXkgPSB3LmQgIT0gbnVsbCA/ICBwYXJzZVdlZWtkYXkody5kLCBsYW5nKSA6CiAgICAgICAgICAgICAgICAgICh3LmUgIT0gbnVsbCA/ICBwYXJzZUludCh3LmUsIDEwKSArIGxhbmcuX3dlZWsuZG93IDogMCk7CgogICAgICAgICAgICAgICAgd2VlayA9IHBhcnNlSW50KHcudywgMTApIHx8IDE7CgogICAgICAgICAgICAgICAgLy9pZiB3ZSdyZSBwYXJzaW5nICdkJywgdGhlbiB0aGUgbG93IGRheSBudW1iZXJzIG1heSBiZSBuZXh0IHdlZWsKICAgICAgICAgICAgICAgIGlmICh3LmQgIT0gbnVsbCAmJiB3ZWVrZGF5IDwgbGFuZy5fd2Vlay5kb3cpIHsKICAgICAgICAgICAgICAgICAgICB3ZWVrKys7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGVtcCA9IGRheU9mWWVhckZyb21XZWVrcyhmaXhZZWFyKHcuZ2cpLCB3ZWVrLCB3ZWVrZGF5LCBsYW5nLl93ZWVrLmRveSwgbGFuZy5fd2Vlay5kb3cpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25maWcuX2FbWUVBUl0gPSB0ZW1wLnllYXI7CiAgICAgICAgICAgIGNvbmZpZy5fZGF5T2ZZZWFyID0gdGVtcC5kYXlPZlllYXI7CiAgICAgICAgfQoKICAgICAgICAvL2lmIHRoZSBkYXkgb2YgdGhlIHllYXIgaXMgc2V0LCBmaWd1cmUgb3V0IHdoYXQgaXQgaXMKICAgICAgICBpZiAoY29uZmlnLl9kYXlPZlllYXIpIHsKICAgICAgICAgICAgeWVhclRvVXNlID0gY29uZmlnLl9hW1lFQVJdID09IG51bGwgPyBjdXJyZW50RGF0ZVtZRUFSXSA6IGNvbmZpZy5fYVtZRUFSXTsKCiAgICAgICAgICAgIGlmIChjb25maWcuX2RheU9mWWVhciA+IGRheXNJblllYXIoeWVhclRvVXNlKSkgewogICAgICAgICAgICAgICAgY29uZmlnLl9wZi5fb3ZlcmZsb3dEYXlPZlllYXIgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBkYXRlID0gbWFrZVVUQ0RhdGUoeWVhclRvVXNlLCAwLCBjb25maWcuX2RheU9mWWVhcik7CiAgICAgICAgICAgIGNvbmZpZy5fYVtNT05USF0gPSBkYXRlLmdldFVUQ01vbnRoKCk7CiAgICAgICAgICAgIGNvbmZpZy5fYVtEQVRFXSA9IGRhdGUuZ2V0VVRDRGF0ZSgpOwogICAgICAgIH0KCiAgICAgICAgLy8gRGVmYXVsdCB0byBjdXJyZW50IGRhdGUuCiAgICAgICAgLy8gKiBpZiBubyB5ZWFyLCBtb250aCwgZGF5IG9mIG1vbnRoIGFyZSBnaXZlbiwgZGVmYXVsdCB0byB0b2RheQogICAgICAgIC8vICogaWYgZGF5IG9mIG1vbnRoIGlzIGdpdmVuLCBkZWZhdWx0IG1vbnRoIGFuZCB5ZWFyCiAgICAgICAgLy8gKiBpZiBtb250aCBpcyBnaXZlbiwgZGVmYXVsdCBvbmx5IHllYXIKICAgICAgICAvLyAqIGlmIHllYXIgaXMgZ2l2ZW4sIGRvbid0IGRlZmF1bHQgYW55dGhpbmcKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgMyAmJiBjb25maWcuX2FbaV0gPT0gbnVsbDsgKytpKSB7CiAgICAgICAgICAgIGNvbmZpZy5fYVtpXSA9IGlucHV0W2ldID0gY3VycmVudERhdGVbaV07CiAgICAgICAgfQoKICAgICAgICAvLyBaZXJvIG91dCB3aGF0ZXZlciB3YXMgbm90IGRlZmF1bHRlZCwgaW5jbHVkaW5nIHRpbWUKICAgICAgICBmb3IgKDsgaSA8IDc7IGkrKykgewogICAgICAgICAgICBjb25maWcuX2FbaV0gPSBpbnB1dFtpXSA9IChjb25maWcuX2FbaV0gPT0gbnVsbCkgPyAoaSA9PT0gMiA/IDEgOiAwKSA6IGNvbmZpZy5fYVtpXTsKICAgICAgICB9CgogICAgICAgIC8vIGFkZCB0aGUgb2Zmc2V0cyB0byB0aGUgdGltZSB0byBiZSBwYXJzZWQgc28gdGhhdCB3ZSBjYW4gaGF2ZSBhIGNsZWFuIGFycmF5IGZvciBjaGVja2luZyBpc1ZhbGlkCiAgICAgICAgaW5wdXRbSE9VUl0gKz0gdG9JbnQoKGNvbmZpZy5fdHptIHx8IDApIC8gNjApOwogICAgICAgIGlucHV0W01JTlVURV0gKz0gdG9JbnQoKGNvbmZpZy5fdHptIHx8IDApICUgNjApOwoKICAgICAgICBjb25maWcuX2QgPSAoY29uZmlnLl91c2VVVEMgPyBtYWtlVVRDRGF0ZSA6IG1ha2VEYXRlKS5hcHBseShudWxsLCBpbnB1dCk7CiAgICB9CgogICAgZnVuY3Rpb24gZGF0ZUZyb21PYmplY3QoY29uZmlnKSB7CiAgICAgICAgdmFyIG5vcm1hbGl6ZWRJbnB1dDsKCiAgICAgICAgaWYgKGNvbmZpZy5fZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBub3JtYWxpemVkSW5wdXQgPSBub3JtYWxpemVPYmplY3RVbml0cyhjb25maWcuX2kpOwogICAgICAgIGNvbmZpZy5fYSA9IFsKICAgICAgICAgICAgbm9ybWFsaXplZElucHV0LnllYXIsCiAgICAgICAgICAgIG5vcm1hbGl6ZWRJbnB1dC5tb250aCwKICAgICAgICAgICAgbm9ybWFsaXplZElucHV0LmRheSwKICAgICAgICAgICAgbm9ybWFsaXplZElucHV0LmhvdXIsCiAgICAgICAgICAgIG5vcm1hbGl6ZWRJbnB1dC5taW51dGUsCiAgICAgICAgICAgIG5vcm1hbGl6ZWRJbnB1dC5zZWNvbmQsCiAgICAgICAgICAgIG5vcm1hbGl6ZWRJbnB1dC5taWxsaXNlY29uZAogICAgICAgIF07CgogICAgICAgIGRhdGVGcm9tQ29uZmlnKGNvbmZpZyk7CiAgICB9CgogICAgZnVuY3Rpb24gY3VycmVudERhdGVBcnJheShjb25maWcpIHsKICAgICAgICB2YXIgbm93ID0gbmV3IERhdGUoKTsKICAgICAgICBpZiAoY29uZmlnLl91c2VVVEMpIHsKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgIG5vdy5nZXRVVENGdWxsWWVhcigpLAogICAgICAgICAgICAgICAgbm93LmdldFVUQ01vbnRoKCksCiAgICAgICAgICAgICAgICBub3cuZ2V0VVRDRGF0ZSgpCiAgICAgICAgICAgIF07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIFtub3cuZ2V0RnVsbFllYXIoKSwgbm93LmdldE1vbnRoKCksIG5vdy5nZXREYXRlKCldOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBkYXRlIGZyb20gc3RyaW5nIGFuZCBmb3JtYXQgc3RyaW5nCiAgICBmdW5jdGlvbiBtYWtlRGF0ZUZyb21TdHJpbmdBbmRGb3JtYXQoY29uZmlnKSB7CgogICAgICAgIGNvbmZpZy5fYSA9IFtdOwogICAgICAgIGNvbmZpZy5fcGYuZW1wdHkgPSB0cnVlOwoKICAgICAgICAvLyBUaGlzIGFycmF5IGlzIHVzZWQgdG8gbWFrZSBhIERhdGUsIGVpdGhlciB3aXRoIGBuZXcgRGF0ZWAgb3IgYERhdGUuVVRDYAogICAgICAgIHZhciBsYW5nID0gZ2V0TGFuZ0RlZmluaXRpb24oY29uZmlnLl9sKSwKICAgICAgICAgICAgc3RyaW5nID0gJycgKyBjb25maWcuX2ksCiAgICAgICAgICAgIGksIHBhcnNlZElucHV0LCB0b2tlbnMsIHRva2VuLCBza2lwcGVkLAogICAgICAgICAgICBzdHJpbmdMZW5ndGggPSBzdHJpbmcubGVuZ3RoLAogICAgICAgICAgICB0b3RhbFBhcnNlZElucHV0TGVuZ3RoID0gMDsKCiAgICAgICAgdG9rZW5zID0gZXhwYW5kRm9ybWF0KGNvbmZpZy5fZiwgbGFuZykubWF0Y2goZm9ybWF0dGluZ1Rva2VucykgfHwgW107CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCB0b2tlbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdG9rZW4gPSB0b2tlbnNbaV07CiAgICAgICAgICAgIHBhcnNlZElucHV0ID0gKHN0cmluZy5tYXRjaChnZXRQYXJzZVJlZ2V4Rm9yVG9rZW4odG9rZW4sIGNvbmZpZykpIHx8IFtdKVswXTsKICAgICAgICAgICAgaWYgKHBhcnNlZElucHV0KSB7CiAgICAgICAgICAgICAgICBza2lwcGVkID0gc3RyaW5nLnN1YnN0cigwLCBzdHJpbmcuaW5kZXhPZihwYXJzZWRJbnB1dCkpOwogICAgICAgICAgICAgICAgaWYgKHNraXBwZWQubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbmZpZy5fcGYudW51c2VkSW5wdXQucHVzaChza2lwcGVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5zbGljZShzdHJpbmcuaW5kZXhPZihwYXJzZWRJbnB1dCkgKyBwYXJzZWRJbnB1dC5sZW5ndGgpOwogICAgICAgICAgICAgICAgdG90YWxQYXJzZWRJbnB1dExlbmd0aCArPSBwYXJzZWRJbnB1dC5sZW5ndGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gZG9uJ3QgcGFyc2UgaWYgaXQncyBub3QgYSBrbm93biB0b2tlbgogICAgICAgICAgICBpZiAoZm9ybWF0VG9rZW5GdW5jdGlvbnNbdG9rZW5dKSB7CiAgICAgICAgICAgICAgICBpZiAocGFyc2VkSW5wdXQpIHsKICAgICAgICAgICAgICAgICAgICBjb25maWcuX3BmLmVtcHR5ID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25maWcuX3BmLnVudXNlZFRva2Vucy5wdXNoKHRva2VuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGFkZFRpbWVUb0FycmF5RnJvbVRva2VuKHRva2VuLCBwYXJzZWRJbnB1dCwgY29uZmlnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChjb25maWcuX3N0cmljdCAmJiAhcGFyc2VkSW5wdXQpIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5fcGYudW51c2VkVG9rZW5zLnB1c2godG9rZW4pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBhZGQgcmVtYWluaW5nIHVucGFyc2VkIGlucHV0IGxlbmd0aCB0byB0aGUgc3RyaW5nCiAgICAgICAgY29uZmlnLl9wZi5jaGFyc0xlZnRPdmVyID0gc3RyaW5nTGVuZ3RoIC0gdG90YWxQYXJzZWRJbnB1dExlbmd0aDsKICAgICAgICBpZiAoc3RyaW5nLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgY29uZmlnLl9wZi51bnVzZWRJbnB1dC5wdXNoKHN0cmluZyk7CiAgICAgICAgfQoKICAgICAgICAvLyBoYW5kbGUgYW0gcG0KICAgICAgICBpZiAoY29uZmlnLl9pc1BtICYmIGNvbmZpZy5fYVtIT1VSXSA8IDEyKSB7CiAgICAgICAgICAgIGNvbmZpZy5fYVtIT1VSXSArPSAxMjsKICAgICAgICB9CiAgICAgICAgLy8gaWYgaXMgMTIgYW0sIGNoYW5nZSBob3VycyB0byAwCiAgICAgICAgaWYgKGNvbmZpZy5faXNQbSA9PT0gZmFsc2UgJiYgY29uZmlnLl9hW0hPVVJdID09PSAxMikgewogICAgICAgICAgICBjb25maWcuX2FbSE9VUl0gPSAwOwogICAgICAgIH0KCiAgICAgICAgZGF0ZUZyb21Db25maWcoY29uZmlnKTsKICAgICAgICBjaGVja092ZXJmbG93KGNvbmZpZyk7CiAgICB9CgogICAgZnVuY3Rpb24gdW5lc2NhcGVGb3JtYXQocykgewogICAgICAgIHJldHVybiBzLnJlcGxhY2UoL1xcKFxbKXxcXChcXSl8XFsoW15cXVxbXSopXF18XFwoLikvZywgZnVuY3Rpb24gKG1hdGNoZWQsIHAxLCBwMiwgcDMsIHA0KSB7CiAgICAgICAgICAgIHJldHVybiBwMSB8fCBwMiB8fCBwMyB8fCBwNDsKICAgICAgICB9KTsKICAgIH0KCiAgICAvLyBDb2RlIGZyb20gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8zNTYxNDkzL2lzLXRoZXJlLWEtcmVnZXhwLWVzY2FwZS1mdW5jdGlvbi1pbi1qYXZhc2NyaXB0CiAgICBmdW5jdGlvbiByZWdleHBFc2NhcGUocykgewogICAgICAgIHJldHVybiBzLnJlcGxhY2UoL1stXC9cXF4kKis/LigpfFtcXXt9XS9nLCAnXFwkJicpOwogICAgfQoKICAgIC8vIGRhdGUgZnJvbSBzdHJpbmcgYW5kIGFycmF5IG9mIGZvcm1hdCBzdHJpbmdzCiAgICBmdW5jdGlvbiBtYWtlRGF0ZUZyb21TdHJpbmdBbmRBcnJheShjb25maWcpIHsKICAgICAgICB2YXIgdGVtcENvbmZpZywKICAgICAgICAgICAgYmVzdE1vbWVudCwKCiAgICAgICAgICAgIHNjb3JlVG9CZWF0LAogICAgICAgICAgICBpLAogICAgICAgICAgICBjdXJyZW50U2NvcmU7CgogICAgICAgIGlmIChjb25maWcuX2YubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGNvbmZpZy5fcGYuaW52YWxpZEZvcm1hdCA9IHRydWU7CiAgICAgICAgICAgIGNvbmZpZy5fZCA9IG5ldyBEYXRlKE5hTik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCBjb25maWcuX2YubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY3VycmVudFNjb3JlID0gMDsKICAgICAgICAgICAgdGVtcENvbmZpZyA9IGV4dGVuZCh7fSwgY29uZmlnKTsKICAgICAgICAgICAgdGVtcENvbmZpZy5fcGYgPSBkZWZhdWx0UGFyc2luZ0ZsYWdzKCk7CiAgICAgICAgICAgIHRlbXBDb25maWcuX2YgPSBjb25maWcuX2ZbaV07CiAgICAgICAgICAgIG1ha2VEYXRlRnJvbVN0cmluZ0FuZEZvcm1hdCh0ZW1wQ29uZmlnKTsKCiAgICAgICAgICAgIGlmICghaXNWYWxpZCh0ZW1wQ29uZmlnKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGlmIHRoZXJlIGlzIGFueSBpbnB1dCB0aGF0IHdhcyBub3QgcGFyc2VkIGFkZCBhIHBlbmFsdHkgZm9yIHRoYXQgZm9ybWF0CiAgICAgICAgICAgIGN1cnJlbnRTY29yZSArPSB0ZW1wQ29uZmlnLl9wZi5jaGFyc0xlZnRPdmVyOwoKICAgICAgICAgICAgLy9vciB0b2tlbnMKICAgICAgICAgICAgY3VycmVudFNjb3JlICs9IHRlbXBDb25maWcuX3BmLnVudXNlZFRva2Vucy5sZW5ndGggKiAxMDsKCiAgICAgICAgICAgIHRlbXBDb25maWcuX3BmLnNjb3JlID0gY3VycmVudFNjb3JlOwoKICAgICAgICAgICAgaWYgKHNjb3JlVG9CZWF0ID09IG51bGwgfHwgY3VycmVudFNjb3JlIDwgc2NvcmVUb0JlYXQpIHsKICAgICAgICAgICAgICAgIHNjb3JlVG9CZWF0ID0gY3VycmVudFNjb3JlOwogICAgICAgICAgICAgICAgYmVzdE1vbWVudCA9IHRlbXBDb25maWc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGV4dGVuZChjb25maWcsIGJlc3RNb21lbnQgfHwgdGVtcENvbmZpZyk7CiAgICB9CgogICAgLy8gZGF0ZSBmcm9tIGlzbyBmb3JtYXQKICAgIGZ1bmN0aW9uIG1ha2VEYXRlRnJvbVN0cmluZyhjb25maWcpIHsKICAgICAgICB2YXIgaSwgbCwKICAgICAgICAgICAgc3RyaW5nID0gY29uZmlnLl9pLAogICAgICAgICAgICBtYXRjaCA9IGlzb1JlZ2V4LmV4ZWMoc3RyaW5nKTsKCiAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgIGNvbmZpZy5fcGYuaXNvID0gdHJ1ZTsKICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IGlzb0RhdGVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKGlzb0RhdGVzW2ldWzFdLmV4ZWMoc3RyaW5nKSkgewogICAgICAgICAgICAgICAgICAgIC8vIG1hdGNoWzVdIHNob3VsZCBiZSAiVCIgb3IgdW5kZWZpbmVkCiAgICAgICAgICAgICAgICAgICAgY29uZmlnLl9mID0gaXNvRGF0ZXNbaV1bMF0gKyAobWF0Y2hbNl0gfHwgIiAiKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gaXNvVGltZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNvVGltZXNbaV1bMV0uZXhlYyhzdHJpbmcpKSB7CiAgICAgICAgICAgICAgICAgICAgY29uZmlnLl9mICs9IGlzb1RpbWVzW2ldWzBdOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzdHJpbmcubWF0Y2gocGFyc2VUb2tlblRpbWV6b25lKSkgewogICAgICAgICAgICAgICAgY29uZmlnLl9mICs9ICJaIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBtYWtlRGF0ZUZyb21TdHJpbmdBbmRGb3JtYXQoY29uZmlnKTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIG1vbWVudC5jcmVhdGVGcm9tSW5wdXRGYWxsYmFjayhjb25maWcpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBtYWtlRGF0ZUZyb21JbnB1dChjb25maWcpIHsKICAgICAgICB2YXIgaW5wdXQgPSBjb25maWcuX2ksCiAgICAgICAgICAgIG1hdGNoZWQgPSBhc3BOZXRKc29uUmVnZXguZXhlYyhpbnB1dCk7CgogICAgICAgIGlmIChpbnB1dCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGNvbmZpZy5fZCA9IG5ldyBEYXRlKCk7CiAgICAgICAgfSBlbHNlIGlmIChtYXRjaGVkKSB7CiAgICAgICAgICAgIGNvbmZpZy5fZCA9IG5ldyBEYXRlKCttYXRjaGVkWzFdKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBpbnB1dCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgbWFrZURhdGVGcm9tU3RyaW5nKGNvbmZpZyk7CiAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5KGlucHV0KSkgewogICAgICAgICAgICBjb25maWcuX2EgPSBpbnB1dC5zbGljZSgwKTsKICAgICAgICAgICAgZGF0ZUZyb21Db25maWcoY29uZmlnKTsKICAgICAgICB9IGVsc2UgaWYgKGlzRGF0ZShpbnB1dCkpIHsKICAgICAgICAgICAgY29uZmlnLl9kID0gbmV3IERhdGUoK2lucHV0KTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZihpbnB1dCkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgIGRhdGVGcm9tT2JqZWN0KGNvbmZpZyk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YoaW5wdXQpID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAvLyBmcm9tIG1pbGxpc2Vjb25kcwogICAgICAgICAgICBjb25maWcuX2QgPSBuZXcgRGF0ZShpbnB1dCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbW9tZW50LmNyZWF0ZUZyb21JbnB1dEZhbGxiYWNrKGNvbmZpZyk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG1ha2VEYXRlKHksIG0sIGQsIGgsIE0sIHMsIG1zKSB7CiAgICAgICAgLy9jYW4ndCBqdXN0IGFwcGx5KCkgdG8gY3JlYXRlIGEgZGF0ZToKICAgICAgICAvL2h0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTgxMzQ4L2luc3RhbnRpYXRpbmctYS1qYXZhc2NyaXB0LW9iamVjdC1ieS1jYWxsaW5nLXByb3RvdHlwZS1jb25zdHJ1Y3Rvci1hcHBseQogICAgICAgIHZhciBkYXRlID0gbmV3IERhdGUoeSwgbSwgZCwgaCwgTSwgcywgbXMpOwoKICAgICAgICAvL3RoZSBkYXRlIGNvbnN0cnVjdG9yIGRvZXNuJ3QgYWNjZXB0IHllYXJzIDwgMTk3MAogICAgICAgIGlmICh5IDwgMTk3MCkgewogICAgICAgICAgICBkYXRlLnNldEZ1bGxZZWFyKHkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGF0ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBtYWtlVVRDRGF0ZSh5KSB7CiAgICAgICAgdmFyIGRhdGUgPSBuZXcgRGF0ZShEYXRlLlVUQy5hcHBseShudWxsLCBhcmd1bWVudHMpKTsKICAgICAgICBpZiAoeSA8IDE5NzApIHsKICAgICAgICAgICAgZGF0ZS5zZXRVVENGdWxsWWVhcih5KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRhdGU7CiAgICB9CgogICAgZnVuY3Rpb24gcGFyc2VXZWVrZGF5KGlucHV0LCBsYW5ndWFnZSkgewogICAgICAgIGlmICh0eXBlb2YgaW5wdXQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIGlmICghaXNOYU4oaW5wdXQpKSB7CiAgICAgICAgICAgICAgICBpbnB1dCA9IHBhcnNlSW50KGlucHV0LCAxMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBpbnB1dCA9IGxhbmd1YWdlLndlZWtkYXlzUGFyc2UoaW5wdXQpOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnB1dCAhPT0gJ251bWJlcicpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gaW5wdXQ7CiAgICB9CgogICAgLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgogICAgICAgIFJlbGF0aXZlIFRpbWUKICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCgogICAgLy8gaGVscGVyIGZ1bmN0aW9uIGZvciBtb21lbnQuZm4uZnJvbSwgbW9tZW50LmZuLmZyb21Ob3csIGFuZCBtb21lbnQuZHVyYXRpb24uZm4uaHVtYW5pemUKICAgIGZ1bmN0aW9uIHN1YnN0aXR1dGVUaW1lQWdvKHN0cmluZywgbnVtYmVyLCB3aXRob3V0U3VmZml4LCBpc0Z1dHVyZSwgbGFuZykgewogICAgICAgIHJldHVybiBsYW5nLnJlbGF0aXZlVGltZShudW1iZXIgfHwgMSwgISF3aXRob3V0U3VmZml4LCBzdHJpbmcsIGlzRnV0dXJlKTsKICAgIH0KCiAgICBmdW5jdGlvbiByZWxhdGl2ZVRpbWUobWlsbGlzZWNvbmRzLCB3aXRob3V0U3VmZml4LCBsYW5nKSB7CiAgICAgICAgdmFyIHNlY29uZHMgPSByb3VuZChNYXRoLmFicyhtaWxsaXNlY29uZHMpIC8gMTAwMCksCiAgICAgICAgICAgIG1pbnV0ZXMgPSByb3VuZChzZWNvbmRzIC8gNjApLAogICAgICAgICAgICBob3VycyA9IHJvdW5kKG1pbnV0ZXMgLyA2MCksCiAgICAgICAgICAgIGRheXMgPSByb3VuZChob3VycyAvIDI0KSwKICAgICAgICAgICAgeWVhcnMgPSByb3VuZChkYXlzIC8gMzY1KSwKICAgICAgICAgICAgYXJncyA9IHNlY29uZHMgPCA0NSAmJiBbJ3MnLCBzZWNvbmRzXSB8fAogICAgICAgICAgICAgICAgbWludXRlcyA9PT0gMSAmJiBbJ20nXSB8fAogICAgICAgICAgICAgICAgbWludXRlcyA8IDQ1ICYmIFsnbW0nLCBtaW51dGVzXSB8fAogICAgICAgICAgICAgICAgaG91cnMgPT09IDEgJiYgWydoJ10gfHwKICAgICAgICAgICAgICAgIGhvdXJzIDwgMjIgJiYgWydoaCcsIGhvdXJzXSB8fAogICAgICAgICAgICAgICAgZGF5cyA9PT0gMSAmJiBbJ2QnXSB8fAogICAgICAgICAgICAgICAgZGF5cyA8PSAyNSAmJiBbJ2RkJywgZGF5c10gfHwKICAgICAgICAgICAgICAgIGRheXMgPD0gNDUgJiYgWydNJ10gfHwKICAgICAgICAgICAgICAgIGRheXMgPCAzNDUgJiYgWydNTScsIHJvdW5kKGRheXMgLyAzMCldIHx8CiAgICAgICAgICAgICAgICB5ZWFycyA9PT0gMSAmJiBbJ3knXSB8fCBbJ3l5JywgeWVhcnNdOwogICAgICAgIGFyZ3NbMl0gPSB3aXRob3V0U3VmZml4OwogICAgICAgIGFyZ3NbM10gPSBtaWxsaXNlY29uZHMgPiAwOwogICAgICAgIGFyZ3NbNF0gPSBsYW5nOwogICAgICAgIHJldHVybiBzdWJzdGl0dXRlVGltZUFnby5hcHBseSh7fSwgYXJncyk7CiAgICB9CgoKICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgICAgICBXZWVrIG9mIFllYXIKICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCgogICAgLy8gZmlyc3REYXlPZldlZWsgICAgICAgMCA9IHN1biwgNiA9IHNhdAogICAgLy8gICAgICAgICAgICAgICAgICAgICAgdGhlIGRheSBvZiB0aGUgd2VlayB0aGF0IHN0YXJ0cyB0aGUgd2VlawogICAgLy8gICAgICAgICAgICAgICAgICAgICAgKHVzdWFsbHkgc3VuZGF5IG9yIG1vbmRheSkKICAgIC8vIGZpcnN0RGF5T2ZXZWVrT2ZZZWFyIDAgPSBzdW4sIDYgPSBzYXQKICAgIC8vICAgICAgICAgICAgICAgICAgICAgIHRoZSBmaXJzdCB3ZWVrIGlzIHRoZSB3ZWVrIHRoYXQgY29udGFpbnMgdGhlIGZpcnN0CiAgICAvLyAgICAgICAgICAgICAgICAgICAgICBvZiB0aGlzIGRheSBvZiB0aGUgd2VlawogICAgLy8gICAgICAgICAgICAgICAgICAgICAgKGVnLiBJU08gd2Vla3MgdXNlIHRodXJzZGF5ICg0KSkKICAgIGZ1bmN0aW9uIHdlZWtPZlllYXIobW9tLCBmaXJzdERheU9mV2VlaywgZmlyc3REYXlPZldlZWtPZlllYXIpIHsKICAgICAgICB2YXIgZW5kID0gZmlyc3REYXlPZldlZWtPZlllYXIgLSBmaXJzdERheU9mV2VlaywKICAgICAgICAgICAgZGF5c1RvRGF5T2ZXZWVrID0gZmlyc3REYXlPZldlZWtPZlllYXIgLSBtb20uZGF5KCksCiAgICAgICAgICAgIGFkanVzdGVkTW9tZW50OwoKCiAgICAgICAgaWYgKGRheXNUb0RheU9mV2VlayA+IGVuZCkgewogICAgICAgICAgICBkYXlzVG9EYXlPZldlZWsgLT0gNzsKICAgICAgICB9CgogICAgICAgIGlmIChkYXlzVG9EYXlPZldlZWsgPCBlbmQgLSA3KSB7CiAgICAgICAgICAgIGRheXNUb0RheU9mV2VlayArPSA3OwogICAgICAgIH0KCiAgICAgICAgYWRqdXN0ZWRNb21lbnQgPSBtb21lbnQobW9tKS5hZGQoJ2QnLCBkYXlzVG9EYXlPZldlZWspOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHdlZWs6IE1hdGguY2VpbChhZGp1c3RlZE1vbWVudC5kYXlPZlllYXIoKSAvIDcpLAogICAgICAgICAgICB5ZWFyOiBhZGp1c3RlZE1vbWVudC55ZWFyKCkKICAgICAgICB9OwogICAgfQoKICAgIC8vaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9JU09fd2Vla19kYXRlI0NhbGN1bGF0aW5nX2FfZGF0ZV9naXZlbl90aGVfeWVhci4yQ193ZWVrX251bWJlcl9hbmRfd2Vla2RheQogICAgZnVuY3Rpb24gZGF5T2ZZZWFyRnJvbVdlZWtzKHllYXIsIHdlZWssIHdlZWtkYXksIGZpcnN0RGF5T2ZXZWVrT2ZZZWFyLCBmaXJzdERheU9mV2VlaykgewogICAgICAgIHZhciBkID0gbWFrZVVUQ0RhdGUoeWVhciwgMCwgMSkuZ2V0VVRDRGF5KCksIGRheXNUb0FkZCwgZGF5T2ZZZWFyOwoKICAgICAgICB3ZWVrZGF5ID0gd2Vla2RheSAhPSBudWxsID8gd2Vla2RheSA6IGZpcnN0RGF5T2ZXZWVrOwogICAgICAgIGRheXNUb0FkZCA9IGZpcnN0RGF5T2ZXZWVrIC0gZCArIChkID4gZmlyc3REYXlPZldlZWtPZlllYXIgPyA3IDogMCkgLSAoZCA8IGZpcnN0RGF5T2ZXZWVrID8gNyA6IDApOwogICAgICAgIGRheU9mWWVhciA9IDcgKiAod2VlayAtIDEpICsgKHdlZWtkYXkgLSBmaXJzdERheU9mV2VlaykgKyBkYXlzVG9BZGQgKyAxOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB5ZWFyOiBkYXlPZlllYXIgPiAwID8geWVhciA6IHllYXIgLSAxLAogICAgICAgICAgICBkYXlPZlllYXI6IGRheU9mWWVhciA+IDAgPyAgZGF5T2ZZZWFyIDogZGF5c0luWWVhcih5ZWFyIC0gMSkgKyBkYXlPZlllYXIKICAgICAgICB9OwogICAgfQoKICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgICAgICBUb3AgTGV2ZWwgRnVuY3Rpb25zCiAgICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCgogICAgZnVuY3Rpb24gbWFrZU1vbWVudChjb25maWcpIHsKICAgICAgICB2YXIgaW5wdXQgPSBjb25maWcuX2ksCiAgICAgICAgICAgIGZvcm1hdCA9IGNvbmZpZy5fZjsKCiAgICAgICAgaWYgKGlucHV0ID09PSBudWxsIHx8IChmb3JtYXQgPT09IHVuZGVmaW5lZCAmJiBpbnB1dCA9PT0gJycpKSB7CiAgICAgICAgICAgIHJldHVybiBtb21lbnQuaW52YWxpZCh7bnVsbElucHV0OiB0cnVlfSk7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIGlucHV0ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICBjb25maWcuX2kgPSBpbnB1dCA9IGdldExhbmdEZWZpbml0aW9uKCkucHJlcGFyc2UoaW5wdXQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKG1vbWVudC5pc01vbWVudChpbnB1dCkpIHsKICAgICAgICAgICAgY29uZmlnID0gY2xvbmVNb21lbnQoaW5wdXQpOwoKICAgICAgICAgICAgY29uZmlnLl9kID0gbmV3IERhdGUoK2lucHV0Ll9kKTsKICAgICAgICB9IGVsc2UgaWYgKGZvcm1hdCkgewogICAgICAgICAgICBpZiAoaXNBcnJheShmb3JtYXQpKSB7CiAgICAgICAgICAgICAgICBtYWtlRGF0ZUZyb21TdHJpbmdBbmRBcnJheShjb25maWcpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbWFrZURhdGVGcm9tU3RyaW5nQW5kRm9ybWF0KGNvbmZpZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtYWtlRGF0ZUZyb21JbnB1dChjb25maWcpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG5ldyBNb21lbnQoY29uZmlnKTsKICAgIH0KCiAgICBtb21lbnQgPSBmdW5jdGlvbiAoaW5wdXQsIGZvcm1hdCwgbGFuZywgc3RyaWN0KSB7CiAgICAgICAgdmFyIGM7CgogICAgICAgIGlmICh0eXBlb2YobGFuZykgPT09ICJib29sZWFuIikgewogICAgICAgICAgICBzdHJpY3QgPSBsYW5nOwogICAgICAgICAgICBsYW5nID0gdW5kZWZpbmVkOwogICAgICAgIH0KICAgICAgICAvLyBvYmplY3QgY29uc3RydWN0aW9uIG11c3QgYmUgZG9uZSB0aGlzIHdheS4KICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vbW9tZW50L21vbWVudC9pc3N1ZXMvMTQyMwogICAgICAgIGMgPSB7fTsKICAgICAgICBjLl9pc0FNb21lbnRPYmplY3QgPSB0cnVlOwogICAgICAgIGMuX2kgPSBpbnB1dDsKICAgICAgICBjLl9mID0gZm9ybWF0OwogICAgICAgIGMuX2wgPSBsYW5nOwogICAgICAgIGMuX3N0cmljdCA9IHN0cmljdDsKICAgICAgICBjLl9pc1VUQyA9IGZhbHNlOwogICAgICAgIGMuX3BmID0gZGVmYXVsdFBhcnNpbmdGbGFncygpOwoKICAgICAgICByZXR1cm4gbWFrZU1vbWVudChjKTsKICAgIH07CgogICAgbW9tZW50LnN1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5ncyA9IGZhbHNlOwoKICAgIG1vbWVudC5jcmVhdGVGcm9tSW5wdXRGYWxsYmFjayA9IGRlcHJlY2F0ZSgKICAgICAgICAgICAgIm1vbWVudCBjb25zdHJ1Y3Rpb24gZmFsbHMgYmFjayB0byBqcyBEYXRlLiBUaGlzIGlzICIgKwogICAgICAgICAgICAiZGlzY291cmFnZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB1cGNvbWluZyBtYWpvciAiICsKICAgICAgICAgICAgInJlbGVhc2UuIFBsZWFzZSByZWZlciB0byAiICsKICAgICAgICAgICAgImh0dHBzOi8vZ2l0aHViLmNvbS9tb21lbnQvbW9tZW50L2lzc3Vlcy8xNDA3IGZvciBtb3JlIGluZm8uIiwKICAgICAgICAgICAgZnVuY3Rpb24gKGNvbmZpZykgewogICAgICAgIGNvbmZpZy5fZCA9IG5ldyBEYXRlKGNvbmZpZy5faSk7CiAgICB9KTsKCiAgICAvLyBjcmVhdGluZyB3aXRoIHV0YwogICAgbW9tZW50LnV0YyA9IGZ1bmN0aW9uIChpbnB1dCwgZm9ybWF0LCBsYW5nLCBzdHJpY3QpIHsKICAgICAgICB2YXIgYzsKCiAgICAgICAgaWYgKHR5cGVvZihsYW5nKSA9PT0gImJvb2xlYW4iKSB7CiAgICAgICAgICAgIHN0cmljdCA9IGxhbmc7CiAgICAgICAgICAgIGxhbmcgPSB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgICAgIC8vIG9iamVjdCBjb25zdHJ1Y3Rpb24gbXVzdCBiZSBkb25lIHRoaXMgd2F5LgogICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9tb21lbnQvbW9tZW50L2lzc3Vlcy8xNDIzCiAgICAgICAgYyA9IHt9OwogICAgICAgIGMuX2lzQU1vbWVudE9iamVjdCA9IHRydWU7CiAgICAgICAgYy5fdXNlVVRDID0gdHJ1ZTsKICAgICAgICBjLl9pc1VUQyA9IHRydWU7CiAgICAgICAgYy5fbCA9IGxhbmc7CiAgICAgICAgYy5faSA9IGlucHV0OwogICAgICAgIGMuX2YgPSBmb3JtYXQ7CiAgICAgICAgYy5fc3RyaWN0ID0gc3RyaWN0OwogICAgICAgIGMuX3BmID0gZGVmYXVsdFBhcnNpbmdGbGFncygpOwoKICAgICAgICByZXR1cm4gbWFrZU1vbWVudChjKS51dGMoKTsKICAgIH07CgogICAgLy8gY3JlYXRpbmcgd2l0aCB1bml4IHRpbWVzdGFtcCAoaW4gc2Vjb25kcykKICAgIG1vbWVudC51bml4ID0gZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgcmV0dXJuIG1vbWVudChpbnB1dCAqIDEwMDApOwogICAgfTsKCiAgICAvLyBkdXJhdGlvbgogICAgbW9tZW50LmR1cmF0aW9uID0gZnVuY3Rpb24gKGlucHV0LCBrZXkpIHsKICAgICAgICB2YXIgZHVyYXRpb24gPSBpbnB1dCwKICAgICAgICAgICAgLy8gbWF0Y2hpbmcgYWdhaW5zdCByZWdleHAgaXMgZXhwZW5zaXZlLCBkbyBpdCBvbiBkZW1hbmQKICAgICAgICAgICAgbWF0Y2ggPSBudWxsLAogICAgICAgICAgICBzaWduLAogICAgICAgICAgICByZXQsCiAgICAgICAgICAgIHBhcnNlSXNvOwoKICAgICAgICBpZiAobW9tZW50LmlzRHVyYXRpb24oaW5wdXQpKSB7CiAgICAgICAgICAgIGR1cmF0aW9uID0gewogICAgICAgICAgICAgICAgbXM6IGlucHV0Ll9taWxsaXNlY29uZHMsCiAgICAgICAgICAgICAgICBkOiBpbnB1dC5fZGF5cywKICAgICAgICAgICAgICAgIE06IGlucHV0Ll9tb250aHMKICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBpbnB1dCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgZHVyYXRpb24gPSB7fTsKICAgICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICAgICAgZHVyYXRpb25ba2V5XSA9IGlucHV0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZHVyYXRpb24ubWlsbGlzZWNvbmRzID0gaW5wdXQ7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKCEhKG1hdGNoID0gYXNwTmV0VGltZVNwYW5Kc29uUmVnZXguZXhlYyhpbnB1dCkpKSB7CiAgICAgICAgICAgIHNpZ24gPSAobWF0Y2hbMV0gPT09ICItIikgPyAtMSA6IDE7CiAgICAgICAgICAgIGR1cmF0aW9uID0gewogICAgICAgICAgICAgICAgeTogMCwKICAgICAgICAgICAgICAgIGQ6IHRvSW50KG1hdGNoW0RBVEVdKSAqIHNpZ24sCiAgICAgICAgICAgICAgICBoOiB0b0ludChtYXRjaFtIT1VSXSkgKiBzaWduLAogICAgICAgICAgICAgICAgbTogdG9JbnQobWF0Y2hbTUlOVVRFXSkgKiBzaWduLAogICAgICAgICAgICAgICAgczogdG9JbnQobWF0Y2hbU0VDT05EXSkgKiBzaWduLAogICAgICAgICAgICAgICAgbXM6IHRvSW50KG1hdGNoW01JTExJU0VDT05EXSkgKiBzaWduCiAgICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIGlmICghIShtYXRjaCA9IGlzb0R1cmF0aW9uUmVnZXguZXhlYyhpbnB1dCkpKSB7CiAgICAgICAgICAgIHNpZ24gPSAobWF0Y2hbMV0gPT09ICItIikgPyAtMSA6IDE7CiAgICAgICAgICAgIHBhcnNlSXNvID0gZnVuY3Rpb24gKGlucCkgewogICAgICAgICAgICAgICAgLy8gV2UnZCBub3JtYWxseSB1c2Ugfn5pbnAgZm9yIHRoaXMsIGJ1dCB1bmZvcnR1bmF0ZWx5IGl0IGFsc28KICAgICAgICAgICAgICAgIC8vIGNvbnZlcnRzIGZsb2F0cyB0byBpbnRzLgogICAgICAgICAgICAgICAgLy8gaW5wIG1heSBiZSB1bmRlZmluZWQsIHNvIGNhcmVmdWwgY2FsbGluZyByZXBsYWNlIG9uIGl0LgogICAgICAgICAgICAgICAgdmFyIHJlcyA9IGlucCAmJiBwYXJzZUZsb2F0KGlucC5yZXBsYWNlKCcsJywgJy4nKSk7CiAgICAgICAgICAgICAgICAvLyBhcHBseSBzaWduIHdoaWxlIHdlJ3JlIGF0IGl0CiAgICAgICAgICAgICAgICByZXR1cm4gKGlzTmFOKHJlcykgPyAwIDogcmVzKSAqIHNpZ247CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGR1cmF0aW9uID0gewogICAgICAgICAgICAgICAgeTogcGFyc2VJc28obWF0Y2hbMl0pLAogICAgICAgICAgICAgICAgTTogcGFyc2VJc28obWF0Y2hbM10pLAogICAgICAgICAgICAgICAgZDogcGFyc2VJc28obWF0Y2hbNF0pLAogICAgICAgICAgICAgICAgaDogcGFyc2VJc28obWF0Y2hbNV0pLAogICAgICAgICAgICAgICAgbTogcGFyc2VJc28obWF0Y2hbNl0pLAogICAgICAgICAgICAgICAgczogcGFyc2VJc28obWF0Y2hbN10pLAogICAgICAgICAgICAgICAgdzogcGFyc2VJc28obWF0Y2hbOF0pCiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICByZXQgPSBuZXcgRHVyYXRpb24oZHVyYXRpb24pOwoKICAgICAgICBpZiAobW9tZW50LmlzRHVyYXRpb24oaW5wdXQpICYmIGlucHV0Lmhhc093blByb3BlcnR5KCdfbGFuZycpKSB7CiAgICAgICAgICAgIHJldC5fbGFuZyA9IGlucHV0Ll9sYW5nOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJldDsKICAgIH07CgogICAgLy8gdmVyc2lvbiBudW1iZXIKICAgIG1vbWVudC52ZXJzaW9uID0gVkVSU0lPTjsKCiAgICAvLyBkZWZhdWx0IGZvcm1hdAogICAgbW9tZW50LmRlZmF1bHRGb3JtYXQgPSBpc29Gb3JtYXQ7CgogICAgLy8gUGx1Z2lucyB0aGF0IGFkZCBwcm9wZXJ0aWVzIHNob3VsZCBhbHNvIGFkZCB0aGUga2V5IGhlcmUgKG51bGwgdmFsdWUpLAogICAgLy8gc28gd2UgY2FuIHByb3Blcmx5IGNsb25lIG91cnNlbHZlcy4KICAgIG1vbWVudC5tb21lbnRQcm9wZXJ0aWVzID0gbW9tZW50UHJvcGVydGllczsKCiAgICAvLyBUaGlzIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIHdoZW5ldmVyIGEgbW9tZW50IGlzIG11dGF0ZWQuCiAgICAvLyBJdCBpcyBpbnRlbmRlZCB0byBrZWVwIHRoZSBvZmZzZXQgaW4gc3luYyB3aXRoIHRoZSB0aW1lem9uZS4KICAgIG1vbWVudC51cGRhdGVPZmZzZXQgPSBmdW5jdGlvbiAoKSB7fTsKCiAgICAvLyBUaGlzIGZ1bmN0aW9uIHdpbGwgbG9hZCBsYW5ndWFnZXMgYW5kIHRoZW4gc2V0IHRoZSBnbG9iYWwgbGFuZ3VhZ2UuICBJZgogICAgLy8gbm8gYXJndW1lbnRzIGFyZSBwYXNzZWQgaW4sIGl0IHdpbGwgc2ltcGx5IHJldHVybiB0aGUgY3VycmVudCBnbG9iYWwKICAgIC8vIGxhbmd1YWdlIGtleS4KICAgIG1vbWVudC5sYW5nID0gZnVuY3Rpb24gKGtleSwgdmFsdWVzKSB7CiAgICAgICAgdmFyIHI7CiAgICAgICAgaWYgKCFrZXkpIHsKICAgICAgICAgICAgcmV0dXJuIG1vbWVudC5mbi5fbGFuZy5fYWJicjsKICAgICAgICB9CiAgICAgICAgaWYgKHZhbHVlcykgewogICAgICAgICAgICBsb2FkTGFuZyhub3JtYWxpemVMYW5ndWFnZShrZXkpLCB2YWx1ZXMpOwogICAgICAgIH0gZWxzZSBpZiAodmFsdWVzID09PSBudWxsKSB7CiAgICAgICAgICAgIHVubG9hZExhbmcoa2V5KTsKICAgICAgICAgICAga2V5ID0gJ2VuJzsKICAgICAgICB9IGVsc2UgaWYgKCFsYW5ndWFnZXNba2V5XSkgewogICAgICAgICAgICBnZXRMYW5nRGVmaW5pdGlvbihrZXkpOwogICAgICAgIH0KICAgICAgICByID0gbW9tZW50LmR1cmF0aW9uLmZuLl9sYW5nID0gbW9tZW50LmZuLl9sYW5nID0gZ2V0TGFuZ0RlZmluaXRpb24oa2V5KTsKICAgICAgICByZXR1cm4gci5fYWJicjsKICAgIH07CgogICAgLy8gcmV0dXJucyBsYW5ndWFnZSBkYXRhCiAgICBtb21lbnQubGFuZ0RhdGEgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgaWYgKGtleSAmJiBrZXkuX2xhbmcgJiYga2V5Ll9sYW5nLl9hYmJyKSB7CiAgICAgICAgICAgIGtleSA9IGtleS5fbGFuZy5fYWJicjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGdldExhbmdEZWZpbml0aW9uKGtleSk7CiAgICB9OwoKICAgIC8vIGNvbXBhcmUgbW9tZW50IG9iamVjdAogICAgbW9tZW50LmlzTW9tZW50ID0gZnVuY3Rpb24gKG9iaikgewogICAgICAgIHJldHVybiBvYmogaW5zdGFuY2VvZiBNb21lbnQgfHwKICAgICAgICAgICAgKG9iaiAhPSBudWxsICYmICBvYmouaGFzT3duUHJvcGVydHkoJ19pc0FNb21lbnRPYmplY3QnKSk7CiAgICB9OwoKICAgIC8vIGZvciB0eXBlY2hlY2tpbmcgRHVyYXRpb24gb2JqZWN0cwogICAgbW9tZW50LmlzRHVyYXRpb24gPSBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgcmV0dXJuIG9iaiBpbnN0YW5jZW9mIER1cmF0aW9uOwogICAgfTsKCiAgICBmb3IgKGkgPSBsaXN0cy5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgICAgIG1ha2VMaXN0KGxpc3RzW2ldKTsKICAgIH0KCiAgICBtb21lbnQubm9ybWFsaXplVW5pdHMgPSBmdW5jdGlvbiAodW5pdHMpIHsKICAgICAgICByZXR1cm4gbm9ybWFsaXplVW5pdHModW5pdHMpOwogICAgfTsKCiAgICBtb21lbnQuaW52YWxpZCA9IGZ1bmN0aW9uIChmbGFncykgewogICAgICAgIHZhciBtID0gbW9tZW50LnV0YyhOYU4pOwogICAgICAgIGlmIChmbGFncyAhPSBudWxsKSB7CiAgICAgICAgICAgIGV4dGVuZChtLl9wZiwgZmxhZ3MpOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgbS5fcGYudXNlckludmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBtOwogICAgfTsKCiAgICBtb21lbnQucGFyc2Vab25lID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBtb21lbnQuYXBwbHkobnVsbCwgYXJndW1lbnRzKS5wYXJzZVpvbmUoKTsKICAgIH07CgogICAgbW9tZW50LnBhcnNlVHdvRGlnaXRZZWFyID0gZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgcmV0dXJuIHRvSW50KGlucHV0KSArICh0b0ludChpbnB1dCkgPiA2OCA/IDE5MDAgOiAyMDAwKTsKICAgIH07CgogICAgLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgogICAgICAgIE1vbWVudCBQcm90b3R5cGUKICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCgogICAgZXh0ZW5kKG1vbWVudC5mbiA9IE1vbWVudC5wcm90b3R5cGUsIHsKCiAgICAgICAgY2xvbmUgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBtb21lbnQodGhpcyk7CiAgICAgICAgfSwKCiAgICAgICAgdmFsdWVPZiA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuICt0aGlzLl9kICsgKCh0aGlzLl9vZmZzZXQgfHwgMCkgKiA2MDAwMCk7CiAgICAgICAgfSwKCiAgICAgICAgdW5peCA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IoK3RoaXMgLyAxMDAwKTsKICAgICAgICB9LAoKICAgICAgICB0b1N0cmluZyA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2xvbmUoKS5sYW5nKCdlbicpLmZvcm1hdCgiZGRkIE1NTSBERCBZWVlZIEhIOm1tOnNzIFtHTVRdWloiKTsKICAgICAgICB9LAoKICAgICAgICB0b0RhdGUgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9vZmZzZXQgPyBuZXcgRGF0ZSgrdGhpcykgOiB0aGlzLl9kOwogICAgICAgIH0sCgogICAgICAgIHRvSVNPU3RyaW5nIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgbSA9IG1vbWVudCh0aGlzKS51dGMoKTsKICAgICAgICAgICAgaWYgKDAgPCBtLnllYXIoKSAmJiBtLnllYXIoKSA8PSA5OTk5KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZm9ybWF0TW9tZW50KG0sICdZWVlZLU1NLUREW1RdSEg6bW06c3MuU1NTW1pdJyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZm9ybWF0TW9tZW50KG0sICdZWVlZWVktTU0tRERbVF1ISDptbTpzcy5TU1NbWl0nKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHRvQXJyYXkgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBtID0gdGhpczsKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgIG0ueWVhcigpLAogICAgICAgICAgICAgICAgbS5tb250aCgpLAogICAgICAgICAgICAgICAgbS5kYXRlKCksCiAgICAgICAgICAgICAgICBtLmhvdXJzKCksCiAgICAgICAgICAgICAgICBtLm1pbnV0ZXMoKSwKICAgICAgICAgICAgICAgIG0uc2Vjb25kcygpLAogICAgICAgICAgICAgICAgbS5taWxsaXNlY29uZHMoKQogICAgICAgICAgICBdOwogICAgICAgIH0sCgogICAgICAgIGlzVmFsaWQgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBpc1ZhbGlkKHRoaXMpOwogICAgICAgIH0sCgogICAgICAgIGlzRFNUU2hpZnRlZCA6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgIGlmICh0aGlzLl9hKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pc1ZhbGlkKCkgJiYgY29tcGFyZUFycmF5cyh0aGlzLl9hLCAodGhpcy5faXNVVEMgPyBtb21lbnQudXRjKHRoaXMuX2EpIDogbW9tZW50KHRoaXMuX2EpKS50b0FycmF5KCkpID4gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIHBhcnNpbmdGbGFncyA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGV4dGVuZCh7fSwgdGhpcy5fcGYpOwogICAgICAgIH0sCgogICAgICAgIGludmFsaWRBdDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcGYub3ZlcmZsb3c7CiAgICAgICAgfSwKCiAgICAgICAgdXRjIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy56b25lKDApOwogICAgICAgIH0sCgogICAgICAgIGxvY2FsIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLnpvbmUoMCk7CiAgICAgICAgICAgIHRoaXMuX2lzVVRDID0gZmFsc2U7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIGZvcm1hdCA6IGZ1bmN0aW9uIChpbnB1dFN0cmluZykgewogICAgICAgICAgICB2YXIgb3V0cHV0ID0gZm9ybWF0TW9tZW50KHRoaXMsIGlucHV0U3RyaW5nIHx8IG1vbWVudC5kZWZhdWx0Rm9ybWF0KTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGFuZygpLnBvc3Rmb3JtYXQob3V0cHV0KTsKICAgICAgICB9LAoKICAgICAgICBhZGQgOiBmdW5jdGlvbiAoaW5wdXQsIHZhbCkgewogICAgICAgICAgICB2YXIgZHVyOwogICAgICAgICAgICAvLyBzd2l0Y2ggYXJncyB0byBzdXBwb3J0IGFkZCgncycsIDEpIGFuZCBhZGQoMSwgJ3MnKQogICAgICAgICAgICBpZiAodHlwZW9mIGlucHV0ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgZHVyID0gbW9tZW50LmR1cmF0aW9uKCt2YWwsIGlucHV0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGR1ciA9IG1vbWVudC5kdXJhdGlvbihpbnB1dCwgdmFsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhZGRPclN1YnRyYWN0RHVyYXRpb25Gcm9tTW9tZW50KHRoaXMsIGR1ciwgMSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIHN1YnRyYWN0IDogZnVuY3Rpb24gKGlucHV0LCB2YWwpIHsKICAgICAgICAgICAgdmFyIGR1cjsKICAgICAgICAgICAgLy8gc3dpdGNoIGFyZ3MgdG8gc3VwcG9ydCBzdWJ0cmFjdCgncycsIDEpIGFuZCBzdWJ0cmFjdCgxLCAncycpCiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5wdXQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICBkdXIgPSBtb21lbnQuZHVyYXRpb24oK3ZhbCwgaW5wdXQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZHVyID0gbW9tZW50LmR1cmF0aW9uKGlucHV0LCB2YWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFkZE9yU3VidHJhY3REdXJhdGlvbkZyb21Nb21lbnQodGhpcywgZHVyLCAtMSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIGRpZmYgOiBmdW5jdGlvbiAoaW5wdXQsIHVuaXRzLCBhc0Zsb2F0KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gbWFrZUFzKGlucHV0LCB0aGlzKSwKICAgICAgICAgICAgICAgIHpvbmVEaWZmID0gKHRoaXMuem9uZSgpIC0gdGhhdC56b25lKCkpICogNmU0LAogICAgICAgICAgICAgICAgZGlmZiwgb3V0cHV0OwoKICAgICAgICAgICAgdW5pdHMgPSBub3JtYWxpemVVbml0cyh1bml0cyk7CgogICAgICAgICAgICBpZiAodW5pdHMgPT09ICd5ZWFyJyB8fCB1bml0cyA9PT0gJ21vbnRoJykgewogICAgICAgICAgICAgICAgLy8gYXZlcmFnZSBudW1iZXIgb2YgZGF5cyBpbiB0aGUgbW9udGhzIGluIHRoZSBnaXZlbiBkYXRlcwogICAgICAgICAgICAgICAgZGlmZiA9ICh0aGlzLmRheXNJbk1vbnRoKCkgKyB0aGF0LmRheXNJbk1vbnRoKCkpICogNDMyZTU7IC8vIDI0ICogNjAgKiA2MCAqIDEwMDAgLyAyCiAgICAgICAgICAgICAgICAvLyBkaWZmZXJlbmNlIGluIG1vbnRocwogICAgICAgICAgICAgICAgb3V0cHV0ID0gKCh0aGlzLnllYXIoKSAtIHRoYXQueWVhcigpKSAqIDEyKSArICh0aGlzLm1vbnRoKCkgLSB0aGF0Lm1vbnRoKCkpOwogICAgICAgICAgICAgICAgLy8gYWRqdXN0IGJ5IHRha2luZyBkaWZmZXJlbmNlIGluIGRheXMsIGF2ZXJhZ2UgbnVtYmVyIG9mIGRheXMKICAgICAgICAgICAgICAgIC8vIGFuZCBkc3QgaW4gdGhlIGdpdmVuIG1vbnRocy4KICAgICAgICAgICAgICAgIG91dHB1dCArPSAoKHRoaXMgLSBtb21lbnQodGhpcykuc3RhcnRPZignbW9udGgnKSkgLQogICAgICAgICAgICAgICAgICAgICAgICAodGhhdCAtIG1vbWVudCh0aGF0KS5zdGFydE9mKCdtb250aCcpKSkgLyBkaWZmOwogICAgICAgICAgICAgICAgLy8gc2FtZSBhcyBhYm92ZSBidXQgd2l0aCB6b25lcywgdG8gbmVnYXRlIGFsbCBkc3QKICAgICAgICAgICAgICAgIG91dHB1dCAtPSAoKHRoaXMuem9uZSgpIC0gbW9tZW50KHRoaXMpLnN0YXJ0T2YoJ21vbnRoJykuem9uZSgpKSAtCiAgICAgICAgICAgICAgICAgICAgICAgICh0aGF0LnpvbmUoKSAtIG1vbWVudCh0aGF0KS5zdGFydE9mKCdtb250aCcpLnpvbmUoKSkpICogNmU0IC8gZGlmZjsKICAgICAgICAgICAgICAgIGlmICh1bml0cyA9PT0gJ3llYXInKSB7CiAgICAgICAgICAgICAgICAgICAgb3V0cHV0ID0gb3V0cHV0IC8gMTI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkaWZmID0gKHRoaXMgLSB0aGF0KTsKICAgICAgICAgICAgICAgIG91dHB1dCA9IHVuaXRzID09PSAnc2Vjb25kJyA/IGRpZmYgLyAxZTMgOiAvLyAxMDAwCiAgICAgICAgICAgICAgICAgICAgdW5pdHMgPT09ICdtaW51dGUnID8gZGlmZiAvIDZlNCA6IC8vIDEwMDAgKiA2MAogICAgICAgICAgICAgICAgICAgIHVuaXRzID09PSAnaG91cicgPyBkaWZmIC8gMzZlNSA6IC8vIDEwMDAgKiA2MCAqIDYwCiAgICAgICAgICAgICAgICAgICAgdW5pdHMgPT09ICdkYXknID8gKGRpZmYgLSB6b25lRGlmZikgLyA4NjRlNSA6IC8vIDEwMDAgKiA2MCAqIDYwICogMjQsIG5lZ2F0ZSBkc3QKICAgICAgICAgICAgICAgICAgICB1bml0cyA9PT0gJ3dlZWsnID8gKGRpZmYgLSB6b25lRGlmZikgLyA2MDQ4ZTUgOiAvLyAxMDAwICogNjAgKiA2MCAqIDI0ICogNywgbmVnYXRlIGRzdAogICAgICAgICAgICAgICAgICAgIGRpZmY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFzRmxvYXQgPyBvdXRwdXQgOiBhYnNSb3VuZChvdXRwdXQpOwogICAgICAgIH0sCgogICAgICAgIGZyb20gOiBmdW5jdGlvbiAodGltZSwgd2l0aG91dFN1ZmZpeCkgewogICAgICAgICAgICByZXR1cm4gbW9tZW50LmR1cmF0aW9uKHRoaXMuZGlmZih0aW1lKSkubGFuZyh0aGlzLmxhbmcoKS5fYWJicikuaHVtYW5pemUoIXdpdGhvdXRTdWZmaXgpOwogICAgICAgIH0sCgogICAgICAgIGZyb21Ob3cgOiBmdW5jdGlvbiAod2l0aG91dFN1ZmZpeCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5mcm9tKG1vbWVudCgpLCB3aXRob3V0U3VmZml4KTsKICAgICAgICB9LAoKICAgICAgICBjYWxlbmRhciA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgLy8gV2Ugd2FudCB0byBjb21wYXJlIHRoZSBzdGFydCBvZiB0b2RheSwgdnMgdGhpcy4KICAgICAgICAgICAgLy8gR2V0dGluZyBzdGFydC1vZi10b2RheSBkZXBlbmRzIG9uIHdoZXRoZXIgd2UncmUgem9uZSdkIG9yIG5vdC4KICAgICAgICAgICAgdmFyIHNvZCA9IG1ha2VBcyhtb21lbnQoKSwgdGhpcykuc3RhcnRPZignZGF5JyksCiAgICAgICAgICAgICAgICBkaWZmID0gdGhpcy5kaWZmKHNvZCwgJ2RheXMnLCB0cnVlKSwKICAgICAgICAgICAgICAgIGZvcm1hdCA9IGRpZmYgPCAtNiA/ICdzYW1lRWxzZScgOgogICAgICAgICAgICAgICAgICAgIGRpZmYgPCAtMSA/ICdsYXN0V2VlaycgOgogICAgICAgICAgICAgICAgICAgIGRpZmYgPCAwID8gJ2xhc3REYXknIDoKICAgICAgICAgICAgICAgICAgICBkaWZmIDwgMSA/ICdzYW1lRGF5JyA6CiAgICAgICAgICAgICAgICAgICAgZGlmZiA8IDIgPyAnbmV4dERheScgOgogICAgICAgICAgICAgICAgICAgIGRpZmYgPCA3ID8gJ25leHRXZWVrJyA6ICdzYW1lRWxzZSc7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmZvcm1hdCh0aGlzLmxhbmcoKS5jYWxlbmRhcihmb3JtYXQsIHRoaXMpKTsKICAgICAgICB9LAoKICAgICAgICBpc0xlYXBZZWFyIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gaXNMZWFwWWVhcih0aGlzLnllYXIoKSk7CiAgICAgICAgfSwKCiAgICAgICAgaXNEU1QgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiAodGhpcy56b25lKCkgPCB0aGlzLmNsb25lKCkubW9udGgoMCkuem9uZSgpIHx8CiAgICAgICAgICAgICAgICB0aGlzLnpvbmUoKSA8IHRoaXMuY2xvbmUoKS5tb250aCg1KS56b25lKCkpOwogICAgICAgIH0sCgogICAgICAgIGRheSA6IGZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgICAgICB2YXIgZGF5ID0gdGhpcy5faXNVVEMgPyB0aGlzLl9kLmdldFVUQ0RheSgpIDogdGhpcy5fZC5nZXREYXkoKTsKICAgICAgICAgICAgaWYgKGlucHV0ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlucHV0ID0gcGFyc2VXZWVrZGF5KGlucHV0LCB0aGlzLmxhbmcoKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hZGQoeyBkIDogaW5wdXQgLSBkYXkgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGF5OwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgbW9udGggOiBtYWtlQWNjZXNzb3IoJ01vbnRoJywgdHJ1ZSksCgogICAgICAgIHN0YXJ0T2Y6IGZ1bmN0aW9uICh1bml0cykgewogICAgICAgICAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKHVuaXRzKTsKICAgICAgICAgICAgLy8gdGhlIGZvbGxvd2luZyBzd2l0Y2ggaW50ZW50aW9uYWxseSBvbWl0cyBicmVhayBrZXl3b3JkcwogICAgICAgICAgICAvLyB0byB1dGlsaXplIGZhbGxpbmcgdGhyb3VnaCB0aGUgY2FzZXMuCiAgICAgICAgICAgIHN3aXRjaCAodW5pdHMpIHsKICAgICAgICAgICAgY2FzZSAneWVhcic6CiAgICAgICAgICAgICAgICB0aGlzLm1vbnRoKDApOwogICAgICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgICAgICBjYXNlICdxdWFydGVyJzoKICAgICAgICAgICAgY2FzZSAnbW9udGgnOgogICAgICAgICAgICAgICAgdGhpcy5kYXRlKDEpOwogICAgICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgICAgICBjYXNlICd3ZWVrJzoKICAgICAgICAgICAgY2FzZSAnaXNvV2Vlayc6CiAgICAgICAgICAgIGNhc2UgJ2RheSc6CiAgICAgICAgICAgICAgICB0aGlzLmhvdXJzKDApOwogICAgICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgICAgICBjYXNlICdob3VyJzoKICAgICAgICAgICAgICAgIHRoaXMubWludXRlcygwKTsKICAgICAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi8KICAgICAgICAgICAgY2FzZSAnbWludXRlJzoKICAgICAgICAgICAgICAgIHRoaXMuc2Vjb25kcygwKTsKICAgICAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi8KICAgICAgICAgICAgY2FzZSAnc2Vjb25kJzoKICAgICAgICAgICAgICAgIHRoaXMubWlsbGlzZWNvbmRzKDApOwogICAgICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyB3ZWVrcyBhcmUgYSBzcGVjaWFsIGNhc2UKICAgICAgICAgICAgaWYgKHVuaXRzID09PSAnd2VlaycpIHsKICAgICAgICAgICAgICAgIHRoaXMud2Vla2RheSgwKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh1bml0cyA9PT0gJ2lzb1dlZWsnKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzb1dlZWtkYXkoMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHF1YXJ0ZXJzIGFyZSBhbHNvIHNwZWNpYWwKICAgICAgICAgICAgaWYgKHVuaXRzID09PSAncXVhcnRlcicpIHsKICAgICAgICAgICAgICAgIHRoaXMubW9udGgoTWF0aC5mbG9vcih0aGlzLm1vbnRoKCkgLyAzKSAqIDMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICBlbmRPZjogZnVuY3Rpb24gKHVuaXRzKSB7CiAgICAgICAgICAgIHVuaXRzID0gbm9ybWFsaXplVW5pdHModW5pdHMpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5zdGFydE9mKHVuaXRzKS5hZGQoKHVuaXRzID09PSAnaXNvV2VlaycgPyAnd2VlaycgOiB1bml0cyksIDEpLnN1YnRyYWN0KCdtcycsIDEpOwogICAgICAgIH0sCgogICAgICAgIGlzQWZ0ZXI6IGZ1bmN0aW9uIChpbnB1dCwgdW5pdHMpIHsKICAgICAgICAgICAgdW5pdHMgPSB0eXBlb2YgdW5pdHMgIT09ICd1bmRlZmluZWQnID8gdW5pdHMgOiAnbWlsbGlzZWNvbmQnOwogICAgICAgICAgICByZXR1cm4gK3RoaXMuY2xvbmUoKS5zdGFydE9mKHVuaXRzKSA+ICttb21lbnQoaW5wdXQpLnN0YXJ0T2YodW5pdHMpOwogICAgICAgIH0sCgogICAgICAgIGlzQmVmb3JlOiBmdW5jdGlvbiAoaW5wdXQsIHVuaXRzKSB7CiAgICAgICAgICAgIHVuaXRzID0gdHlwZW9mIHVuaXRzICE9PSAndW5kZWZpbmVkJyA/IHVuaXRzIDogJ21pbGxpc2Vjb25kJzsKICAgICAgICAgICAgcmV0dXJuICt0aGlzLmNsb25lKCkuc3RhcnRPZih1bml0cykgPCArbW9tZW50KGlucHV0KS5zdGFydE9mKHVuaXRzKTsKICAgICAgICB9LAoKICAgICAgICBpc1NhbWU6IGZ1bmN0aW9uIChpbnB1dCwgdW5pdHMpIHsKICAgICAgICAgICAgdW5pdHMgPSB1bml0cyB8fCAnbXMnOwogICAgICAgICAgICByZXR1cm4gK3RoaXMuY2xvbmUoKS5zdGFydE9mKHVuaXRzKSA9PT0gK21ha2VBcyhpbnB1dCwgdGhpcykuc3RhcnRPZih1bml0cyk7CiAgICAgICAgfSwKCiAgICAgICAgbWluOiBmdW5jdGlvbiAob3RoZXIpIHsKICAgICAgICAgICAgb3RoZXIgPSBtb21lbnQuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgICAgcmV0dXJuIG90aGVyIDwgdGhpcyA/IHRoaXMgOiBvdGhlcjsKICAgICAgICB9LAoKICAgICAgICBtYXg6IGZ1bmN0aW9uIChvdGhlcikgewogICAgICAgICAgICBvdGhlciA9IG1vbWVudC5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgICByZXR1cm4gb3RoZXIgPiB0aGlzID8gdGhpcyA6IG90aGVyOwogICAgICAgIH0sCgogICAgICAgIC8vIGtlZXBUaW1lID0gdHJ1ZSBtZWFucyBvbmx5IGNoYW5nZSB0aGUgdGltZXpvbmUsIHdpdGhvdXQgYWZmZWN0aW5nCiAgICAgICAgLy8gdGhlIGxvY2FsIGhvdXIuIFNvIDU6MzE6MjYgKzAzMDAgLS1bem9uZSgyLCB0cnVlKV0tLT4gNTozMToyNiArMDIwMAogICAgICAgIC8vIEl0IGlzIHBvc3NpYmxlIHRoYXQgNTozMToyNiBkb2Vzbid0IGV4aXN0IGludCB6b25lICswMjAwLCBzbyB3ZQogICAgICAgIC8vIGFkanVzdCB0aGUgdGltZSBhcyBuZWVkZWQsIHRvIGJlIHZhbGlkLgogICAgICAgIC8vCiAgICAgICAgLy8gS2VlcGluZyB0aGUgdGltZSBhY3R1YWxseSBhZGRzL3N1YnRyYWN0cyAob25lIGhvdXIpCiAgICAgICAgLy8gZnJvbSB0aGUgYWN0dWFsIHJlcHJlc2VudGVkIHRpbWUuIFRoYXQgaXMgd2h5IHdlIGNhbGwgdXBkYXRlT2Zmc2V0CiAgICAgICAgLy8gYSBzZWNvbmQgdGltZS4gSW4gY2FzZSBpdCB3YW50cyB1cyB0byBjaGFuZ2UgdGhlIG9mZnNldCBhZ2FpbgogICAgICAgIC8vIF9jaGFuZ2VJblByb2dyZXNzID09IHRydWUgY2FzZSwgdGhlbiB3ZSBoYXZlIHRvIGFkanVzdCwgYmVjYXVzZQogICAgICAgIC8vIHRoZXJlIGlzIG5vIHN1Y2ggdGltZSBpbiB0aGUgZ2l2ZW4gdGltZXpvbmUuCiAgICAgICAgem9uZSA6IGZ1bmN0aW9uIChpbnB1dCwga2VlcFRpbWUpIHsKICAgICAgICAgICAgdmFyIG9mZnNldCA9IHRoaXMuX29mZnNldCB8fCAwOwogICAgICAgICAgICBpZiAoaW5wdXQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnB1dCA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICBpbnB1dCA9IHRpbWV6b25lTWludXRlc0Zyb21TdHJpbmcoaW5wdXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKGlucHV0KSA8IDE2KSB7CiAgICAgICAgICAgICAgICAgICAgaW5wdXQgPSBpbnB1dCAqIDYwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5fb2Zmc2V0ID0gaW5wdXQ7CiAgICAgICAgICAgICAgICB0aGlzLl9pc1VUQyA9IHRydWU7CiAgICAgICAgICAgICAgICBpZiAob2Zmc2V0ICE9PSBpbnB1dCkgewogICAgICAgICAgICAgICAgICAgIGlmICgha2VlcFRpbWUgfHwgdGhpcy5fY2hhbmdlSW5Qcm9ncmVzcykgewogICAgICAgICAgICAgICAgICAgICAgICBhZGRPclN1YnRyYWN0RHVyYXRpb25Gcm9tTW9tZW50KHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50LmR1cmF0aW9uKG9mZnNldCAtIGlucHV0LCAnbScpLCAxLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdGhpcy5fY2hhbmdlSW5Qcm9ncmVzcykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jaGFuZ2VJblByb2dyZXNzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50LnVwZGF0ZU9mZnNldCh0aGlzLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2hhbmdlSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2lzVVRDID8gb2Zmc2V0IDogdGhpcy5fZC5nZXRUaW1lem9uZU9mZnNldCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIHpvbmVBYmJyIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faXNVVEMgPyAiVVRDIiA6ICIiOwogICAgICAgIH0sCgogICAgICAgIHpvbmVOYW1lIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faXNVVEMgPyAiQ29vcmRpbmF0ZWQgVW5pdmVyc2FsIFRpbWUiIDogIiI7CiAgICAgICAgfSwKCiAgICAgICAgcGFyc2Vab25lIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAodGhpcy5fdHptKSB7CiAgICAgICAgICAgICAgICB0aGlzLnpvbmUodGhpcy5fdHptKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdGhpcy5faSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIHRoaXMuem9uZSh0aGlzLl9pKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICBoYXNBbGlnbmVkSG91ck9mZnNldCA6IGZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgICAgICBpZiAoIWlucHV0KSB7CiAgICAgICAgICAgICAgICBpbnB1dCA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBpbnB1dCA9IG1vbWVudChpbnB1dCkuem9uZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gKHRoaXMuem9uZSgpIC0gaW5wdXQpICUgNjAgPT09IDA7CiAgICAgICAgfSwKCiAgICAgICAgZGF5c0luTW9udGggOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBkYXlzSW5Nb250aCh0aGlzLnllYXIoKSwgdGhpcy5tb250aCgpKTsKICAgICAgICB9LAoKICAgICAgICBkYXlPZlllYXIgOiBmdW5jdGlvbiAoaW5wdXQpIHsKICAgICAgICAgICAgdmFyIGRheU9mWWVhciA9IHJvdW5kKChtb21lbnQodGhpcykuc3RhcnRPZignZGF5JykgLSBtb21lbnQodGhpcykuc3RhcnRPZigneWVhcicpKSAvIDg2NGU1KSArIDE7CiAgICAgICAgICAgIHJldHVybiBpbnB1dCA9PSBudWxsID8gZGF5T2ZZZWFyIDogdGhpcy5hZGQoImQiLCAoaW5wdXQgLSBkYXlPZlllYXIpKTsKICAgICAgICB9LAoKICAgICAgICBxdWFydGVyIDogZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgICAgIHJldHVybiBpbnB1dCA9PSBudWxsID8gTWF0aC5jZWlsKCh0aGlzLm1vbnRoKCkgKyAxKSAvIDMpIDogdGhpcy5tb250aCgoaW5wdXQgLSAxKSAqIDMgKyB0aGlzLm1vbnRoKCkgJSAzKTsKICAgICAgICB9LAoKICAgICAgICB3ZWVrWWVhciA6IGZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgICAgICB2YXIgeWVhciA9IHdlZWtPZlllYXIodGhpcywgdGhpcy5sYW5nKCkuX3dlZWsuZG93LCB0aGlzLmxhbmcoKS5fd2Vlay5kb3kpLnllYXI7CiAgICAgICAgICAgIHJldHVybiBpbnB1dCA9PSBudWxsID8geWVhciA6IHRoaXMuYWRkKCJ5IiwgKGlucHV0IC0geWVhcikpOwogICAgICAgIH0sCgogICAgICAgIGlzb1dlZWtZZWFyIDogZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgICAgIHZhciB5ZWFyID0gd2Vla09mWWVhcih0aGlzLCAxLCA0KS55ZWFyOwogICAgICAgICAgICByZXR1cm4gaW5wdXQgPT0gbnVsbCA/IHllYXIgOiB0aGlzLmFkZCgieSIsIChpbnB1dCAtIHllYXIpKTsKICAgICAgICB9LAoKICAgICAgICB3ZWVrIDogZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgICAgIHZhciB3ZWVrID0gdGhpcy5sYW5nKCkud2Vlayh0aGlzKTsKICAgICAgICAgICAgcmV0dXJuIGlucHV0ID09IG51bGwgPyB3ZWVrIDogdGhpcy5hZGQoImQiLCAoaW5wdXQgLSB3ZWVrKSAqIDcpOwogICAgICAgIH0sCgogICAgICAgIGlzb1dlZWsgOiBmdW5jdGlvbiAoaW5wdXQpIHsKICAgICAgICAgICAgdmFyIHdlZWsgPSB3ZWVrT2ZZZWFyKHRoaXMsIDEsIDQpLndlZWs7CiAgICAgICAgICAgIHJldHVybiBpbnB1dCA9PSBudWxsID8gd2VlayA6IHRoaXMuYWRkKCJkIiwgKGlucHV0IC0gd2VlaykgKiA3KTsKICAgICAgICB9LAoKICAgICAgICB3ZWVrZGF5IDogZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgICAgIHZhciB3ZWVrZGF5ID0gKHRoaXMuZGF5KCkgKyA3IC0gdGhpcy5sYW5nKCkuX3dlZWsuZG93KSAlIDc7CiAgICAgICAgICAgIHJldHVybiBpbnB1dCA9PSBudWxsID8gd2Vla2RheSA6IHRoaXMuYWRkKCJkIiwgaW5wdXQgLSB3ZWVrZGF5KTsKICAgICAgICB9LAoKICAgICAgICBpc29XZWVrZGF5IDogZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgICAgIC8vIGJlaGF2ZXMgdGhlIHNhbWUgYXMgbW9tZW50I2RheSBleGNlcHQKICAgICAgICAgICAgLy8gYXMgYSBnZXR0ZXIsIHJldHVybnMgNyBpbnN0ZWFkIG9mIDAgKDEtNyByYW5nZSBpbnN0ZWFkIG9mIDAtNikKICAgICAgICAgICAgLy8gYXMgYSBzZXR0ZXIsIHN1bmRheSBzaG91bGQgYmVsb25nIHRvIHRoZSBwcmV2aW91cyB3ZWVrLgogICAgICAgICAgICByZXR1cm4gaW5wdXQgPT0gbnVsbCA/IHRoaXMuZGF5KCkgfHwgNyA6IHRoaXMuZGF5KHRoaXMuZGF5KCkgJSA3ID8gaW5wdXQgOiBpbnB1dCAtIDcpOwogICAgICAgIH0sCgogICAgICAgIGlzb1dlZWtzSW5ZZWFyIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gd2Vla3NJblllYXIodGhpcy55ZWFyKCksIDEsIDQpOwogICAgICAgIH0sCgogICAgICAgIHdlZWtzSW5ZZWFyIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgd2Vla0luZm8gPSB0aGlzLl9sYW5nLl93ZWVrOwogICAgICAgICAgICByZXR1cm4gd2Vla3NJblllYXIodGhpcy55ZWFyKCksIHdlZWtJbmZvLmRvdywgd2Vla0luZm8uZG95KTsKICAgICAgICB9LAoKICAgICAgICBnZXQgOiBmdW5jdGlvbiAodW5pdHMpIHsKICAgICAgICAgICAgdW5pdHMgPSBub3JtYWxpemVVbml0cyh1bml0cyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzW3VuaXRzXSgpOwogICAgICAgIH0sCgogICAgICAgIHNldCA6IGZ1bmN0aW9uICh1bml0cywgdmFsdWUpIHsKICAgICAgICAgICAgdW5pdHMgPSBub3JtYWxpemVVbml0cyh1bml0cyk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpc1t1bml0c10gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIHRoaXNbdW5pdHNdKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICAvLyBJZiBwYXNzZWQgYSBsYW5ndWFnZSBrZXksIGl0IHdpbGwgc2V0IHRoZSBsYW5ndWFnZSBmb3IgdGhpcwogICAgICAgIC8vIGluc3RhbmNlLiAgT3RoZXJ3aXNlLCBpdCB3aWxsIHJldHVybiB0aGUgbGFuZ3VhZ2UgY29uZmlndXJhdGlvbgogICAgICAgIC8vIHZhcmlhYmxlcyBmb3IgdGhpcyBpbnN0YW5jZS4KICAgICAgICBsYW5nIDogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICBpZiAoa2V5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9sYW5nOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5fbGFuZyA9IGdldExhbmdEZWZpbml0aW9uKGtleSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pOwoKICAgIGZ1bmN0aW9uIHJhd01vbnRoU2V0dGVyKG1vbSwgdmFsdWUpIHsKICAgICAgICB2YXIgZGF5T2ZNb250aDsKCiAgICAgICAgLy8gVE9ETzogTW92ZSB0aGlzIG91dCBvZiBoZXJlIQogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIHZhbHVlID0gbW9tLmxhbmcoKS5tb250aHNQYXJzZSh2YWx1ZSk7CiAgICAgICAgICAgIC8vIFRPRE86IEFub3RoZXIgc2lsZW50IGZhaWx1cmU/CiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICdudW1iZXInKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW9tOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBkYXlPZk1vbnRoID0gTWF0aC5taW4obW9tLmRhdGUoKSwKICAgICAgICAgICAgICAgIGRheXNJbk1vbnRoKG1vbS55ZWFyKCksIHZhbHVlKSk7CiAgICAgICAgbW9tLl9kWydzZXQnICsgKG1vbS5faXNVVEMgPyAnVVRDJyA6ICcnKSArICdNb250aCddKHZhbHVlLCBkYXlPZk1vbnRoKTsKICAgICAgICByZXR1cm4gbW9tOwogICAgfQoKICAgIGZ1bmN0aW9uIHJhd0dldHRlcihtb20sIHVuaXQpIHsKICAgICAgICByZXR1cm4gbW9tLl9kWydnZXQnICsgKG1vbS5faXNVVEMgPyAnVVRDJyA6ICcnKSArIHVuaXRdKCk7CiAgICB9CgogICAgZnVuY3Rpb24gcmF3U2V0dGVyKG1vbSwgdW5pdCwgdmFsdWUpIHsKICAgICAgICBpZiAodW5pdCA9PT0gJ01vbnRoJykgewogICAgICAgICAgICByZXR1cm4gcmF3TW9udGhTZXR0ZXIobW9tLCB2YWx1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG1vbS5fZFsnc2V0JyArIChtb20uX2lzVVRDID8gJ1VUQycgOiAnJykgKyB1bml0XSh2YWx1ZSk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG1ha2VBY2Nlc3Nvcih1bml0LCBrZWVwVGltZSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHJhd1NldHRlcih0aGlzLCB1bml0LCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBtb21lbnQudXBkYXRlT2Zmc2V0KHRoaXMsIGtlZXBUaW1lKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHJhd0dldHRlcih0aGlzLCB1bml0KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9CgogICAgbW9tZW50LmZuLm1pbGxpc2Vjb25kID0gbW9tZW50LmZuLm1pbGxpc2Vjb25kcyA9IG1ha2VBY2Nlc3NvcignTWlsbGlzZWNvbmRzJywgZmFsc2UpOwogICAgbW9tZW50LmZuLnNlY29uZCA9IG1vbWVudC5mbi5zZWNvbmRzID0gbWFrZUFjY2Vzc29yKCdTZWNvbmRzJywgZmFsc2UpOwogICAgbW9tZW50LmZuLm1pbnV0ZSA9IG1vbWVudC5mbi5taW51dGVzID0gbWFrZUFjY2Vzc29yKCdNaW51dGVzJywgZmFsc2UpOwogICAgLy8gU2V0dGluZyB0aGUgaG91ciBzaG91bGQga2VlcCB0aGUgdGltZSwgYmVjYXVzZSB0aGUgdXNlciBleHBsaWNpdGx5CiAgICAvLyBzcGVjaWZpZWQgd2hpY2ggaG91ciBoZSB3YW50cy4gU28gdHJ5aW5nIHRvIG1haW50YWluIHRoZSBzYW1lIGhvdXIgKGluCiAgICAvLyBhIG5ldyB0aW1lem9uZSkgbWFrZXMgc2Vuc2UuIEFkZGluZy9zdWJ0cmFjdGluZyBob3VycyBkb2VzIG5vdCBmb2xsb3cKICAgIC8vIHRoaXMgcnVsZS4KICAgIG1vbWVudC5mbi5ob3VyID0gbW9tZW50LmZuLmhvdXJzID0gbWFrZUFjY2Vzc29yKCdIb3VycycsIHRydWUpOwogICAgLy8gbW9tZW50LmZuLm1vbnRoIGlzIGRlZmluZWQgc2VwYXJhdGVseQogICAgbW9tZW50LmZuLmRhdGUgPSBtYWtlQWNjZXNzb3IoJ0RhdGUnLCB0cnVlKTsKICAgIG1vbWVudC5mbi5kYXRlcyA9IGRlcHJlY2F0ZSgiZGF0ZXMgYWNjZXNzb3IgaXMgZGVwcmVjYXRlZC4gVXNlIGRhdGUgaW5zdGVhZC4iLCBtYWtlQWNjZXNzb3IoJ0RhdGUnLCB0cnVlKSk7CiAgICBtb21lbnQuZm4ueWVhciA9IG1ha2VBY2Nlc3NvcignRnVsbFllYXInLCB0cnVlKTsKICAgIG1vbWVudC5mbi55ZWFycyA9IGRlcHJlY2F0ZSgieWVhcnMgYWNjZXNzb3IgaXMgZGVwcmVjYXRlZC4gVXNlIHllYXIgaW5zdGVhZC4iLCBtYWtlQWNjZXNzb3IoJ0Z1bGxZZWFyJywgdHJ1ZSkpOwoKICAgIC8vIGFkZCBwbHVyYWwgbWV0aG9kcwogICAgbW9tZW50LmZuLmRheXMgPSBtb21lbnQuZm4uZGF5OwogICAgbW9tZW50LmZuLm1vbnRocyA9IG1vbWVudC5mbi5tb250aDsKICAgIG1vbWVudC5mbi53ZWVrcyA9IG1vbWVudC5mbi53ZWVrOwogICAgbW9tZW50LmZuLmlzb1dlZWtzID0gbW9tZW50LmZuLmlzb1dlZWs7CiAgICBtb21lbnQuZm4ucXVhcnRlcnMgPSBtb21lbnQuZm4ucXVhcnRlcjsKCiAgICAvLyBhZGQgYWxpYXNlZCBmb3JtYXQgbWV0aG9kcwogICAgbW9tZW50LmZuLnRvSlNPTiA9IG1vbWVudC5mbi50b0lTT1N0cmluZzsKCiAgICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICAgICAgRHVyYXRpb24gUHJvdG90eXBlCiAgICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCgoKICAgIGV4dGVuZChtb21lbnQuZHVyYXRpb24uZm4gPSBEdXJhdGlvbi5wcm90b3R5cGUsIHsKCiAgICAgICAgX2J1YmJsZSA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIG1pbGxpc2Vjb25kcyA9IHRoaXMuX21pbGxpc2Vjb25kcywKICAgICAgICAgICAgICAgIGRheXMgPSB0aGlzLl9kYXlzLAogICAgICAgICAgICAgICAgbW9udGhzID0gdGhpcy5fbW9udGhzLAogICAgICAgICAgICAgICAgZGF0YSA9IHRoaXMuX2RhdGEsCiAgICAgICAgICAgICAgICBzZWNvbmRzLCBtaW51dGVzLCBob3VycywgeWVhcnM7CgogICAgICAgICAgICAvLyBUaGUgZm9sbG93aW5nIGNvZGUgYnViYmxlcyB1cCB2YWx1ZXMsIHNlZSB0aGUgdGVzdHMgZm9yCiAgICAgICAgICAgIC8vIGV4YW1wbGVzIG9mIHdoYXQgdGhhdCBtZWFucy4KICAgICAgICAgICAgZGF0YS5taWxsaXNlY29uZHMgPSBtaWxsaXNlY29uZHMgJSAxMDAwOwoKICAgICAgICAgICAgc2Vjb25kcyA9IGFic1JvdW5kKG1pbGxpc2Vjb25kcyAvIDEwMDApOwogICAgICAgICAgICBkYXRhLnNlY29uZHMgPSBzZWNvbmRzICUgNjA7CgogICAgICAgICAgICBtaW51dGVzID0gYWJzUm91bmQoc2Vjb25kcyAvIDYwKTsKICAgICAgICAgICAgZGF0YS5taW51dGVzID0gbWludXRlcyAlIDYwOwoKICAgICAgICAgICAgaG91cnMgPSBhYnNSb3VuZChtaW51dGVzIC8gNjApOwogICAgICAgICAgICBkYXRhLmhvdXJzID0gaG91cnMgJSAyNDsKCiAgICAgICAgICAgIGRheXMgKz0gYWJzUm91bmQoaG91cnMgLyAyNCk7CiAgICAgICAgICAgIGRhdGEuZGF5cyA9IGRheXMgJSAzMDsKCiAgICAgICAgICAgIG1vbnRocyArPSBhYnNSb3VuZChkYXlzIC8gMzApOwogICAgICAgICAgICBkYXRhLm1vbnRocyA9IG1vbnRocyAlIDEyOwoKICAgICAgICAgICAgeWVhcnMgPSBhYnNSb3VuZChtb250aHMgLyAxMik7CiAgICAgICAgICAgIGRhdGEueWVhcnMgPSB5ZWFyczsKICAgICAgICB9LAoKICAgICAgICB3ZWVrcyA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGFic1JvdW5kKHRoaXMuZGF5cygpIC8gNyk7CiAgICAgICAgfSwKCiAgICAgICAgdmFsdWVPZiA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21pbGxpc2Vjb25kcyArCiAgICAgICAgICAgICAgdGhpcy5fZGF5cyAqIDg2NGU1ICsKICAgICAgICAgICAgICAodGhpcy5fbW9udGhzICUgMTIpICogMjU5MmU2ICsKICAgICAgICAgICAgICB0b0ludCh0aGlzLl9tb250aHMgLyAxMikgKiAzMTUzNmU2OwogICAgICAgIH0sCgogICAgICAgIGh1bWFuaXplIDogZnVuY3Rpb24gKHdpdGhTdWZmaXgpIHsKICAgICAgICAgICAgdmFyIGRpZmZlcmVuY2UgPSArdGhpcywKICAgICAgICAgICAgICAgIG91dHB1dCA9IHJlbGF0aXZlVGltZShkaWZmZXJlbmNlLCAhd2l0aFN1ZmZpeCwgdGhpcy5sYW5nKCkpOwoKICAgICAgICAgICAgaWYgKHdpdGhTdWZmaXgpIHsKICAgICAgICAgICAgICAgIG91dHB1dCA9IHRoaXMubGFuZygpLnBhc3RGdXR1cmUoZGlmZmVyZW5jZSwgb3V0cHV0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGFuZygpLnBvc3Rmb3JtYXQob3V0cHV0KTsKICAgICAgICB9LAoKICAgICAgICBhZGQgOiBmdW5jdGlvbiAoaW5wdXQsIHZhbCkgewogICAgICAgICAgICAvLyBzdXBwb3J0cyBvbmx5IDIuMC1zdHlsZSBhZGQoMSwgJ3MnKSBvciBhZGQobW9tZW50KQogICAgICAgICAgICB2YXIgZHVyID0gbW9tZW50LmR1cmF0aW9uKGlucHV0LCB2YWwpOwoKICAgICAgICAgICAgdGhpcy5fbWlsbGlzZWNvbmRzICs9IGR1ci5fbWlsbGlzZWNvbmRzOwogICAgICAgICAgICB0aGlzLl9kYXlzICs9IGR1ci5fZGF5czsKICAgICAgICAgICAgdGhpcy5fbW9udGhzICs9IGR1ci5fbW9udGhzOwoKICAgICAgICAgICAgdGhpcy5fYnViYmxlKCk7CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICBzdWJ0cmFjdCA6IGZ1bmN0aW9uIChpbnB1dCwgdmFsKSB7CiAgICAgICAgICAgIHZhciBkdXIgPSBtb21lbnQuZHVyYXRpb24oaW5wdXQsIHZhbCk7CgogICAgICAgICAgICB0aGlzLl9taWxsaXNlY29uZHMgLT0gZHVyLl9taWxsaXNlY29uZHM7CiAgICAgICAgICAgIHRoaXMuX2RheXMgLT0gZHVyLl9kYXlzOwogICAgICAgICAgICB0aGlzLl9tb250aHMgLT0gZHVyLl9tb250aHM7CgogICAgICAgICAgICB0aGlzLl9idWJibGUoKTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIGdldCA6IGZ1bmN0aW9uICh1bml0cykgewogICAgICAgICAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKHVuaXRzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXNbdW5pdHMudG9Mb3dlckNhc2UoKSArICdzJ10oKTsKICAgICAgICB9LAoKICAgICAgICBhcyA6IGZ1bmN0aW9uICh1bml0cykgewogICAgICAgICAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKHVuaXRzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXNbJ2FzJyArIHVuaXRzLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgdW5pdHMuc2xpY2UoMSkgKyAncyddKCk7CiAgICAgICAgfSwKCiAgICAgICAgbGFuZyA6IG1vbWVudC5mbi5sYW5nLAoKICAgICAgICB0b0lzb1N0cmluZyA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgLy8gaW5zcGlyZWQgYnkgaHR0cHM6Ly9naXRodWIuY29tL2RvcmRpbGxlL21vbWVudC1pc29kdXJhdGlvbi9ibG9iL21hc3Rlci9tb21lbnQuaXNvZHVyYXRpb24uanMKICAgICAgICAgICAgdmFyIHllYXJzID0gTWF0aC5hYnModGhpcy55ZWFycygpKSwKICAgICAgICAgICAgICAgIG1vbnRocyA9IE1hdGguYWJzKHRoaXMubW9udGhzKCkpLAogICAgICAgICAgICAgICAgZGF5cyA9IE1hdGguYWJzKHRoaXMuZGF5cygpKSwKICAgICAgICAgICAgICAgIGhvdXJzID0gTWF0aC5hYnModGhpcy5ob3VycygpKSwKICAgICAgICAgICAgICAgIG1pbnV0ZXMgPSBNYXRoLmFicyh0aGlzLm1pbnV0ZXMoKSksCiAgICAgICAgICAgICAgICBzZWNvbmRzID0gTWF0aC5hYnModGhpcy5zZWNvbmRzKCkgKyB0aGlzLm1pbGxpc2Vjb25kcygpIC8gMTAwMCk7CgogICAgICAgICAgICBpZiAoIXRoaXMuYXNTZWNvbmRzKCkpIHsKICAgICAgICAgICAgICAgIC8vIHRoaXMgaXMgdGhlIHNhbWUgYXMgQyMncyAoTm9kYSkgYW5kIHB5dGhvbiAoaXNvZGF0ZSkuLi4KICAgICAgICAgICAgICAgIC8vIGJ1dCBub3Qgb3RoZXIgSlMgKGdvb2cuZGF0ZSkKICAgICAgICAgICAgICAgIHJldHVybiAnUDBEJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuICh0aGlzLmFzU2Vjb25kcygpIDwgMCA/ICctJyA6ICcnKSArCiAgICAgICAgICAgICAgICAnUCcgKwogICAgICAgICAgICAgICAgKHllYXJzID8geWVhcnMgKyAnWScgOiAnJykgKwogICAgICAgICAgICAgICAgKG1vbnRocyA/IG1vbnRocyArICdNJyA6ICcnKSArCiAgICAgICAgICAgICAgICAoZGF5cyA/IGRheXMgKyAnRCcgOiAnJykgKwogICAgICAgICAgICAgICAgKChob3VycyB8fCBtaW51dGVzIHx8IHNlY29uZHMpID8gJ1QnIDogJycpICsKICAgICAgICAgICAgICAgIChob3VycyA/IGhvdXJzICsgJ0gnIDogJycpICsKICAgICAgICAgICAgICAgIChtaW51dGVzID8gbWludXRlcyArICdNJyA6ICcnKSArCiAgICAgICAgICAgICAgICAoc2Vjb25kcyA/IHNlY29uZHMgKyAnUycgOiAnJyk7CiAgICAgICAgfQogICAgfSk7CgogICAgZnVuY3Rpb24gbWFrZUR1cmF0aW9uR2V0dGVyKG5hbWUpIHsKICAgICAgICBtb21lbnQuZHVyYXRpb24uZm5bbmFtZV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9kYXRhW25hbWVdOwogICAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gbWFrZUR1cmF0aW9uQXNHZXR0ZXIobmFtZSwgZmFjdG9yKSB7CiAgICAgICAgbW9tZW50LmR1cmF0aW9uLmZuWydhcycgKyBuYW1lXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuICt0aGlzIC8gZmFjdG9yOwogICAgICAgIH07CiAgICB9CgogICAgZm9yIChpIGluIHVuaXRNaWxsaXNlY29uZEZhY3RvcnMpIHsKICAgICAgICBpZiAodW5pdE1pbGxpc2Vjb25kRmFjdG9ycy5oYXNPd25Qcm9wZXJ0eShpKSkgewogICAgICAgICAgICBtYWtlRHVyYXRpb25Bc0dldHRlcihpLCB1bml0TWlsbGlzZWNvbmRGYWN0b3JzW2ldKTsKICAgICAgICAgICAgbWFrZUR1cmF0aW9uR2V0dGVyKGkudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIG1ha2VEdXJhdGlvbkFzR2V0dGVyKCdXZWVrcycsIDYwNDhlNSk7CiAgICBtb21lbnQuZHVyYXRpb24uZm4uYXNNb250aHMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICgrdGhpcyAtIHRoaXMueWVhcnMoKSAqIDMxNTM2ZTYpIC8gMjU5MmU2ICsgdGhpcy55ZWFycygpICogMTI7CiAgICB9OwoKCiAgICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICAgICAgRGVmYXVsdCBMYW5nCiAgICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCgoKICAgIC8vIFNldCBkZWZhdWx0IGxhbmd1YWdlLCBvdGhlciBsYW5ndWFnZXMgd2lsbCBpbmhlcml0IGZyb20gRW5nbGlzaC4KICAgIG1vbWVudC5sYW5nKCdlbicsIHsKICAgICAgICBvcmRpbmFsIDogZnVuY3Rpb24gKG51bWJlcikgewogICAgICAgICAgICB2YXIgYiA9IG51bWJlciAlIDEwLAogICAgICAgICAgICAgICAgb3V0cHV0ID0gKHRvSW50KG51bWJlciAlIDEwMCAvIDEwKSA9PT0gMSkgPyAndGgnIDoKICAgICAgICAgICAgICAgIChiID09PSAxKSA/ICdzdCcgOgogICAgICAgICAgICAgICAgKGIgPT09IDIpID8gJ25kJyA6CiAgICAgICAgICAgICAgICAoYiA9PT0gMykgPyAncmQnIDogJ3RoJzsKICAgICAgICAgICAgcmV0dXJuIG51bWJlciArIG91dHB1dDsKICAgICAgICB9CiAgICB9KTsKCiAgICAvKiBFTUJFRF9MQU5HVUFHRVMgKi8KCiAgICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICAgICAgRXhwb3NpbmcgTW9tZW50CiAgICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCgogICAgZnVuY3Rpb24gbWFrZUdsb2JhbChzaG91bGREZXByZWNhdGUpIHsKICAgICAgICAvKmdsb2JhbCBlbmRlcjpmYWxzZSAqLwogICAgICAgIGlmICh0eXBlb2YgZW5kZXIgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgb2xkR2xvYmFsTW9tZW50ID0gZ2xvYmFsU2NvcGUubW9tZW50OwogICAgICAgIGlmIChzaG91bGREZXByZWNhdGUpIHsKICAgICAgICAgICAgZ2xvYmFsU2NvcGUubW9tZW50ID0gZGVwcmVjYXRlKAogICAgICAgICAgICAgICAgICAgICJBY2Nlc3NpbmcgTW9tZW50IHRocm91Z2ggdGhlIGdsb2JhbCBzY29wZSBpcyAiICsKICAgICAgICAgICAgICAgICAgICAiZGVwcmVjYXRlZCwgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhbiB1cGNvbWluZyAiICsKICAgICAgICAgICAgICAgICAgICAicmVsZWFzZS4iLAogICAgICAgICAgICAgICAgICAgIG1vbWVudCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZ2xvYmFsU2NvcGUubW9tZW50ID0gbW9tZW50OwogICAgICAgIH0KICAgIH0KCiAgICAvLyBDb21tb25KUyBtb2R1bGUgaXMgZGVmaW5lZAogICAgaWYgKGhhc01vZHVsZSkgewogICAgICAgIG1vZHVsZS5leHBvcnRzID0gbW9tZW50OwogICAgfSBlbHNlIGlmICh0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQpIHsKICAgICAgICBkZWZpbmUoIm1vbWVudCIsIFsncmVxdWlyZScsJ2V4cG9ydHMnLCdtb2R1bGUnXSxmdW5jdGlvbiAocmVxdWlyZSwgZXhwb3J0cywgbW9kdWxlKSB7CiAgICAgICAgICAgIGlmIChtb2R1bGUuY29uZmlnICYmIG1vZHVsZS5jb25maWcoKSAmJiBtb2R1bGUuY29uZmlnKCkubm9HbG9iYWwgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgIC8vIHJlbGVhc2UgdGhlIGdsb2JhbCB2YXJpYWJsZQogICAgICAgICAgICAgICAgZ2xvYmFsU2NvcGUubW9tZW50ID0gb2xkR2xvYmFsTW9tZW50OwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gbW9tZW50OwogICAgICAgIH0pOwogICAgICAgIG1ha2VHbG9iYWwodHJ1ZSk7CiAgICB9IGVsc2UgewogICAgICAgIG1ha2VHbG9iYWwoKTsKICAgIH0KfSkuY2FsbCh0aGlzKTsKCi8qCmplZC5qcwp2MC41LjBiZXRhCgpodHRwczovL2dpdGh1Yi5jb20vU2xleEF4dG9uL0plZAotLS0tLS0tLS0tLQpBIGdldHRleHQgY29tcGF0aWJsZSBpMThuIGxpYnJhcnkgZm9yIG1vZGVybiBKYXZhU2NyaXB0IEFwcGxpY2F0aW9ucwoKYnkgQWxleCBTZXh0b24gLSBBbGV4U2V4dG9uIFthdF0gZ21haWwgLSBAU2xleEF4dG9uCldURlBMIGxpY2Vuc2UgZm9yIHVzZQpEb2pvIENMQSBmb3IgY29udHJpYnV0aW9ucwoKSmVkIG9mZmVycyB0aGUgZW50aXJlIGFwcGxpY2FibGUgR05VIGdldHRleHQgc3BlYydkIHNldCBvZgpmdW5jdGlvbnMsIGJ1dCBhbHNvIG9mZmVycyBzb21lIG5pY2VyIHdyYXBwZXJzIGFyb3VuZCB0aGVtLgpUaGUgYXBpIGZvciBnZXR0ZXh0IHdhcyB3cml0dGVuIGZvciBhIGxhbmd1YWdlIHdpdGggbm8gZnVuY3Rpb24Kb3ZlcmxvYWRpbmcsIHNvIEplZCBhbGxvd3MgYSBsaXR0bGUgbW9yZSBvZiB0aGF0LgoKTWFueSB0aGFua3MgdG8gSm9zaHVhIEkuIE1pbGxlciAtIHVucnRzdEBjcGFuLm9yZyAtIHdobyB3cm90ZQpnZXR0ZXh0LmpzIGJhY2sgaW4gMjAwOC4gSSB3YXMgYWJsZSB0byB2ZXQgYSBsb3Qgb2YgbXkgaWRlYXMKYWdhaW5zdCBoaXMuIEkgYWxzbyBtYWRlIHN1cmUgSmVkIHBhc3NlZCBhZ2FpbnN0IGhpcyB0ZXN0cwppbiBvcmRlciB0byBvZmZlciBlYXN5IHVwZ3JhZGVzIC0tIGpzZ2V0dGV4dC5iZXJsaW9zLmRlCiovCihmdW5jdGlvbiAocm9vdCwgdW5kZWYpIHsKCiAgLy8gU2V0IHVwIHNvbWUgdW5kZXJzY29yZS1zdHlsZSBmdW5jdGlvbnMsIGlmIHlvdSBhbHJlYWR5IGhhdmUKICAvLyB1bmRlcnNjb3JlLCBmZWVsIGZyZWUgdG8gZGVsZXRlIHRoaXMgc2VjdGlvbiwgYW5kIHVzZSBpdAogIC8vIGRpcmVjdGx5LCBob3dldmVyLCB0aGUgYW1vdW50IG9mIGZ1bmN0aW9ucyB1c2VkIGRvZXNuJ3QKICAvLyB3YXJyYW50IGhhdmluZyB1bmRlcnNjb3JlIGFzIGEgZnVsbCBkZXBlbmRlbmN5LgogIC8vIFVuZGVyc2NvcmUgMS4zLjAgd2FzIHVzZWQgdG8gcG9ydCBhbmQgaXMgbGljZW5zZWQKICAvLyB1bmRlciB0aGUgTUlUIExpY2Vuc2UgYnkgSmVyZW15IEFzaGtlbmFzLgogIHZhciBBcnJheVByb3RvICAgID0gQXJyYXkucHJvdG90eXBlLAogICAgICBPYmpQcm90byAgICAgID0gT2JqZWN0LnByb3RvdHlwZSwKICAgICAgc2xpY2UgICAgICAgICA9IEFycmF5UHJvdG8uc2xpY2UsCiAgICAgIGhhc093blByb3AgICAgPSBPYmpQcm90by5oYXNPd25Qcm9wZXJ0eSwKICAgICAgbmF0aXZlRm9yRWFjaCA9IEFycmF5UHJvdG8uZm9yRWFjaCwKICAgICAgYnJlYWtlciAgICAgICA9IHt9OwoKICAvLyBXZSdyZSBub3QgdXNpbmcgdGhlIE9PUCBzdHlsZSBfIHNvIHdlIGRvbid0IG5lZWQgdGhlCiAgLy8gZXh0cmEgbGV2ZWwgb2YgaW5kaXJlY3Rpb24uIFRoaXMgc3RpbGwgbWVhbnMgdGhhdCB5b3UKICAvLyBzdWIgb3V0IGZvciByZWFsIGBfYCB0aG91Z2guCiAgdmFyIF8gPSB7CiAgICBmb3JFYWNoIDogZnVuY3Rpb24oIG9iaiwgaXRlcmF0b3IsIGNvbnRleHQgKSB7CiAgICAgIHZhciBpLCBsLCBrZXk7CiAgICAgIGlmICggb2JqID09PSBudWxsICkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKCBuYXRpdmVGb3JFYWNoICYmIG9iai5mb3JFYWNoID09PSBuYXRpdmVGb3JFYWNoICkgewogICAgICAgIG9iai5mb3JFYWNoKCBpdGVyYXRvciwgY29udGV4dCApOwogICAgICB9CiAgICAgIGVsc2UgaWYgKCBvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCApIHsKICAgICAgICBmb3IgKCBpID0gMCwgbCA9IG9iai5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CiAgICAgICAgICBpZiAoIGkgaW4gb2JqICYmIGl0ZXJhdG9yLmNhbGwoIGNvbnRleHQsIG9ialtpXSwgaSwgb2JqICkgPT09IGJyZWFrZXIgKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgZm9yICgga2V5IGluIG9iaikgewogICAgICAgICAgaWYgKCBoYXNPd25Qcm9wLmNhbGwoIG9iaiwga2V5ICkgKSB7CiAgICAgICAgICAgIGlmICggaXRlcmF0b3IuY2FsbCAoY29udGV4dCwgb2JqW2tleV0sIGtleSwgb2JqICkgPT09IGJyZWFrZXIgKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgZXh0ZW5kIDogZnVuY3Rpb24oIG9iaiApIHsKICAgICAgdGhpcy5mb3JFYWNoKCBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSwgZnVuY3Rpb24gKCBzb3VyY2UgKSB7CiAgICAgICAgZm9yICggdmFyIHByb3AgaW4gc291cmNlICkgewogICAgICAgICAgb2JqW3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBvYmo7CiAgICB9CiAgfTsKICAvLyBFTkQgTWluaWF0dXJlIHVuZGVyc2NvcmUgaW1wbAoKICAvLyBKZWQgaXMgYSBjb25zdHJ1Y3RvciBmdW5jdGlvbgogIHZhciBKZWQgPSBmdW5jdGlvbiAoIG9wdGlvbnMgKSB7CiAgICAvLyBTb21lIG1pbmltYWwgZGVmYXVsdHMKICAgIHRoaXMuZGVmYXVsdHMgPSB7CiAgICAgICJsb2NhbGVfZGF0YSIgOiB7CiAgICAgICAgIm1lc3NhZ2VzIiA6IHsKICAgICAgICAgICIiIDogewogICAgICAgICAgICAiZG9tYWluIiAgICAgICA6ICJtZXNzYWdlcyIsCiAgICAgICAgICAgICJsYW5nIiAgICAgICAgIDogImVuIiwKICAgICAgICAgICAgInBsdXJhbF9mb3JtcyIgOiAibnBsdXJhbHM9MjsgcGx1cmFsPShuICE9IDEpOyIKICAgICAgICAgIH0KICAgICAgICAgIC8vIFRoZXJlIGFyZSBubyBkZWZhdWx0IGtleXMsIHRob3VnaAogICAgICAgIH0KICAgICAgfSwKICAgICAgLy8gVGhlIGRlZmF1bHQgZG9tYWluIGlmIG9uZSBpcyBtaXNzaW5nCiAgICAgICJkb21haW4iIDogIm1lc3NhZ2VzIgogICAgfTsKCiAgICAvLyBNaXggaW4gdGhlIHNlbnQgb3B0aW9ucyB3aXRoIHRoZSBkZWZhdWx0IG9wdGlvbnMKICAgIHRoaXMub3B0aW9ucyA9IF8uZXh0ZW5kKCB7fSwgdGhpcy5kZWZhdWx0cywgb3B0aW9ucyApOwogICAgdGhpcy50ZXh0ZG9tYWluKCB0aGlzLm9wdGlvbnMuZG9tYWluICk7CgogICAgaWYgKCBvcHRpb25zLmRvbWFpbiAmJiAhIHRoaXMub3B0aW9ucy5sb2NhbGVfZGF0YVsgdGhpcy5vcHRpb25zLmRvbWFpbiBdICkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RleHQgZG9tYWluIHNldCB0byBub24tZXhpc3RlbnQgZG9tYWluOiBgJyArIG9wdGlvbnMuZG9tYWluICsgJ2AnKTsKICAgIH0KICB9OwoKICAvLyBUaGUgZ2V0dGV4dCBzcGVjIHNldHMgdGhpcyBjaGFyYWN0ZXIgYXMgdGhlIGRlZmF1bHQKICAvLyBkZWxpbWl0ZXIgZm9yIGNvbnRleHQgbG9va3Vwcy4KICAvLyBlLmcuOiBjb250ZXh0XHUwMDA0a2V5CiAgLy8gSWYgeW91ciB0cmFuc2xhdGlvbiBjb21wYW55IHVzZXMgc29tZXRoaW5nIGRpZmZlcmVudCwKICAvLyBqdXN0IGNoYW5nZSB0aGlzIGF0IGFueSB0aW1lIGFuZCBpdCB3aWxsIHVzZSB0aGF0IGluc3RlYWQuCiAgSmVkLmNvbnRleHRfZGVsaW1pdGVyID0gU3RyaW5nLmZyb21DaGFyQ29kZSggNCApOwoKICBmdW5jdGlvbiBnZXRQbHVyYWxGb3JtRnVuYyAoIHBsdXJhbF9mb3JtX3N0cmluZyApIHsKICAgIHJldHVybiBKZWQuUEYuY29tcGlsZSggcGx1cmFsX2Zvcm1fc3RyaW5nIHx8ICJucGx1cmFscz0yOyBwbHVyYWw9KG4gIT0gMSk7Iik7CiAgfQoKICBmdW5jdGlvbiBDaGFpbigga2V5LCBpMThuICl7CiAgICB0aGlzLl9rZXkgPSBrZXk7CiAgICB0aGlzLl9pMThuID0gaTE4bjsKICB9CgogIC8vIENyZWF0ZSBhIGNoYWluYWJsZSBhcGkgZm9yIGFkZGluZyBhcmdzIHByZXR0aWx5CiAgXy5leHRlbmQoIENoYWluLnByb3RvdHlwZSwgewogICAgb25Eb21haW4gOiBmdW5jdGlvbiAoIGRvbWFpbiApIHsKICAgICAgdGhpcy5fZG9tYWluID0gZG9tYWluOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICB3aXRoQ29udGV4dCA6IGZ1bmN0aW9uICggY29udGV4dCApIHsKICAgICAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIGlmUGx1cmFsIDogZnVuY3Rpb24gKCBudW0sIHBrZXkgKSB7CiAgICAgIHRoaXMuX3ZhbCA9IG51bTsKICAgICAgdGhpcy5fcGtleSA9IHBrZXk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIGZldGNoIDogZnVuY3Rpb24gKCBzQXJyICkgewogICAgICBpZiAoIHt9LnRvU3RyaW5nLmNhbGwoIHNBcnIgKSAhPSAnW29iamVjdCBBcnJheV0nICkgewogICAgICAgIHNBcnIgPSBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIH0KICAgICAgcmV0dXJuICggc0FyciAmJiBzQXJyLmxlbmd0aCA/IEplZC5zcHJpbnRmIDogZnVuY3Rpb24oeCl7IHJldHVybiB4OyB9ICkoCiAgICAgICAgdGhpcy5faTE4bi5kY25wZ2V0dGV4dCh0aGlzLl9kb21haW4sIHRoaXMuX2NvbnRleHQsIHRoaXMuX2tleSwgdGhpcy5fcGtleSwgdGhpcy5fdmFsKSwKICAgICAgICBzQXJyCiAgICAgICk7CiAgICB9CiAgfSk7CgogIC8vIEFkZCBmdW5jdGlvbnMgdG8gdGhlIEplZCBwcm90b3R5cGUuCiAgLy8gVGhlc2Ugd2lsbCBiZSB0aGUgZnVuY3Rpb25zIG9uIHRoZSBvYmplY3QgdGhhdCdzIHJldHVybmVkCiAgLy8gZnJvbSBjcmVhdGluZyBhIGBuZXcgSmVkKClgCiAgLy8gVGhlc2Ugc2VlbSByZWR1bmRhbnQsIGJ1dCB0aGV5IGd6aXAgcHJldHR5IHdlbGwuCiAgXy5leHRlbmQoIEplZC5wcm90b3R5cGUsIHsKICAgIC8vIFRoZSBzZXhpZXIgYXBpIHN0YXJ0IHBvaW50CiAgICB0cmFuc2xhdGUgOiBmdW5jdGlvbiAoIGtleSApIHsKICAgICAgcmV0dXJuIG5ldyBDaGFpbigga2V5LCB0aGlzICk7CiAgICB9LAoKICAgIHRleHRkb21haW4gOiBmdW5jdGlvbiAoIGRvbWFpbiApIHsKICAgICAgaWYgKCAhIGRvbWFpbiApIHsKICAgICAgICByZXR1cm4gdGhpcy5fdGV4dGRvbWFpbjsKICAgICAgfQogICAgICB0aGlzLl90ZXh0ZG9tYWluID0gZG9tYWluOwogICAgfSwKCiAgICBnZXR0ZXh0IDogZnVuY3Rpb24gKCBrZXkgKSB7CiAgICAgIHJldHVybiB0aGlzLmRjbnBnZXR0ZXh0LmNhbGwoIHRoaXMsIHVuZGVmLCB1bmRlZiwga2V5ICk7CiAgICB9LAoKICAgIGRnZXR0ZXh0IDogZnVuY3Rpb24gKCBkb21haW4sIGtleSApIHsKICAgICByZXR1cm4gdGhpcy5kY25wZ2V0dGV4dC5jYWxsKCB0aGlzLCBkb21haW4sIHVuZGVmLCBrZXkgKTsKICAgIH0sCgogICAgZGNnZXR0ZXh0IDogZnVuY3Rpb24gKCBkb21haW4gLCBrZXkgLyosIGNhdGVnb3J5ICovICkgewogICAgICAvLyBJZ25vcmVzIHRoZSBjYXRlZ29yeSBhbnl3YXlzCiAgICAgIHJldHVybiB0aGlzLmRjbnBnZXR0ZXh0LmNhbGwoIHRoaXMsIGRvbWFpbiwgdW5kZWYsIGtleSApOwogICAgfSwKCiAgICBuZ2V0dGV4dCA6IGZ1bmN0aW9uICggc2tleSwgcGtleSwgdmFsICkgewogICAgICByZXR1cm4gdGhpcy5kY25wZ2V0dGV4dC5jYWxsKCB0aGlzLCB1bmRlZiwgdW5kZWYsIHNrZXksIHBrZXksIHZhbCApOwogICAgfSwKCiAgICBkbmdldHRleHQgOiBmdW5jdGlvbiAoIGRvbWFpbiwgc2tleSwgcGtleSwgdmFsICkgewogICAgICByZXR1cm4gdGhpcy5kY25wZ2V0dGV4dC5jYWxsKCB0aGlzLCBkb21haW4sIHVuZGVmLCBza2V5LCBwa2V5LCB2YWwgKTsKICAgIH0sCgogICAgZGNuZ2V0dGV4dCA6IGZ1bmN0aW9uICggZG9tYWluLCBza2V5LCBwa2V5LCB2YWwvKiwgY2F0ZWdvcnkgKi8pIHsKICAgICAgcmV0dXJuIHRoaXMuZGNucGdldHRleHQuY2FsbCggdGhpcywgZG9tYWluLCB1bmRlZiwgc2tleSwgcGtleSwgdmFsICk7CiAgICB9LAoKICAgIHBnZXR0ZXh0IDogZnVuY3Rpb24gKCBjb250ZXh0LCBrZXkgKSB7CiAgICAgIHJldHVybiB0aGlzLmRjbnBnZXR0ZXh0LmNhbGwoIHRoaXMsIHVuZGVmLCBjb250ZXh0LCBrZXkgKTsKICAgIH0sCgogICAgZHBnZXR0ZXh0IDogZnVuY3Rpb24gKCBkb21haW4sIGNvbnRleHQsIGtleSApIHsKICAgICAgcmV0dXJuIHRoaXMuZGNucGdldHRleHQuY2FsbCggdGhpcywgZG9tYWluLCBjb250ZXh0LCBrZXkgKTsKICAgIH0sCgogICAgZGNwZ2V0dGV4dCA6IGZ1bmN0aW9uICggZG9tYWluLCBjb250ZXh0LCBrZXkvKiwgY2F0ZWdvcnkgKi8pIHsKICAgICAgcmV0dXJuIHRoaXMuZGNucGdldHRleHQuY2FsbCggdGhpcywgZG9tYWluLCBjb250ZXh0LCBrZXkgKTsKICAgIH0sCgogICAgbnBnZXR0ZXh0IDogZnVuY3Rpb24gKCBjb250ZXh0LCBza2V5LCBwa2V5LCB2YWwgKSB7CiAgICAgIHJldHVybiB0aGlzLmRjbnBnZXR0ZXh0LmNhbGwoIHRoaXMsIHVuZGVmLCBjb250ZXh0LCBza2V5LCBwa2V5LCB2YWwgKTsKICAgIH0sCgogICAgZG5wZ2V0dGV4dCA6IGZ1bmN0aW9uICggZG9tYWluLCBjb250ZXh0LCBza2V5LCBwa2V5LCB2YWwgKSB7CiAgICAgIHJldHVybiB0aGlzLmRjbnBnZXR0ZXh0LmNhbGwoIHRoaXMsIGRvbWFpbiwgY29udGV4dCwgc2tleSwgcGtleSwgdmFsICk7CiAgICB9LAoKICAgIC8vIFRoZSBtb3N0IGZ1bGx5IHF1YWxpZmllZCBnZXR0ZXh0IGZ1bmN0aW9uLiBJdCBoYXMgZXZlcnkgb3B0aW9uLgogICAgLy8gU2luY2UgaXQgaGFzIGV2ZXJ5IG9wdGlvbiwgd2UgY2FuIHVzZSBpdCBmcm9tIGV2ZXJ5IG90aGVyIG1ldGhvZC4KICAgIC8vIFRoaXMgaXMgdGhlIGJyZWFkIGFuZCBidXR0ZXIuCiAgICAvLyBUZWNobmljYWxseSB0aGVyZSBzaG91bGQgYmUgb25lIG1vcmUgYXJndW1lbnQgaW4gdGhpcyBmdW5jdGlvbiBmb3IgJ0NhdGVnb3J5JywKICAgIC8vIGJ1dCBzaW5jZSB3ZSBuZXZlciB1c2UgaXQsIHdlIG1pZ2h0IGFzIHdlbGwgbm90IHdhc3RlIHRoZSBieXRlcyB0byBkZWZpbmUgaXQuCiAgICBkY25wZ2V0dGV4dCA6IGZ1bmN0aW9uICggZG9tYWluLCBjb250ZXh0LCBzaW5ndWxhcl9rZXksIHBsdXJhbF9rZXksIHZhbCApIHsKICAgICAgLy8gU2V0IHNvbWUgZGVmYXVsdHMKCiAgICAgIHBsdXJhbF9rZXkgPSBwbHVyYWxfa2V5IHx8IHNpbmd1bGFyX2tleTsKCiAgICAgIC8vIFVzZSB0aGUgZ2xvYmFsIGRvbWFpbiBkZWZhdWx0IGlmIG9uZQogICAgICAvLyBpc24ndCBleHBsaWNpdGx5IHBhc3NlZCBpbgogICAgICBkb21haW4gPSBkb21haW4gfHwgdGhpcy5fdGV4dGRvbWFpbjsKCiAgICAgIC8vIERlZmF1bHQgdGhlIHZhbHVlIHRvIHRoZSBzaW5ndWxhciBjYXNlCiAgICAgIHZhbCA9IHR5cGVvZiB2YWwgPT0gJ3VuZGVmaW5lZCcgPyAxIDogdmFsOwoKICAgICAgdmFyIGZhbGxiYWNrOwoKICAgICAgLy8gSGFuZGxlIHNwZWNpYWwgY2FzZXMKCiAgICAgIC8vIE5vIG9wdGlvbnMgZm91bmQKICAgICAgaWYgKCAhIHRoaXMub3B0aW9ucyApIHsKICAgICAgICAvLyBUaGVyZSdzIGxpa2VseSBzb21ldGhpbmcgd3JvbmcsIGJ1dCB3ZSdsbCByZXR1cm4gdGhlIGNvcnJlY3Qga2V5IGZvciBlbmdsaXNoCiAgICAgICAgLy8gV2UgZG8gdGhpcyBieSBpbnN0YW50aWF0aW5nIGEgYnJhbmQgbmV3IEplZCBpbnN0YW5jZSB3aXRoIHRoZSBkZWZhdWx0IHNldAogICAgICAgIC8vIGZvciBldmVyeXRoaW5nIHRoYXQgY291bGQgYmUgYnJva2VuLgogICAgICAgIGZhbGxiYWNrID0gbmV3IEplZCgpOwogICAgICAgIHJldHVybiBmYWxsYmFjay5kY25wZ2V0dGV4dC5jYWxsKCBmYWxsYmFjaywgdW5kZWZpbmVkLCB1bmRlZmluZWQsIHNpbmd1bGFyX2tleSwgcGx1cmFsX2tleSwgdmFsICk7CiAgICAgIH0KCiAgICAgIC8vIE5vIHRyYW5zbGF0aW9uIGRhdGEgcHJvdmlkZWQKICAgICAgaWYgKCAhIHRoaXMub3B0aW9ucy5sb2NhbGVfZGF0YSApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGxvY2FsZSBkYXRhIHByb3ZpZGVkLicpOwogICAgICB9CgogICAgICBpZiAoICEgdGhpcy5vcHRpb25zLmxvY2FsZV9kYXRhWyBkb21haW4gXSApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RvbWFpbiBgJyArIGRvbWFpbiArICdgIHdhcyBub3QgZm91bmQuJyk7CiAgICAgIH0KCiAgICAgIGlmICggISB0aGlzLm9wdGlvbnMubG9jYWxlX2RhdGFbIGRvbWFpbiBdWyAiIiBdICkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gbG9jYWxlIG1ldGEgaW5mb3JtYXRpb24gcHJvdmlkZWQuJyk7CiAgICAgIH0KCiAgICAgIC8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgdHJ1dGh5IGtleS4gT3RoZXJ3aXNlIHdlIG1pZ2h0IHN0YXJ0IGxvb2tpbmcKICAgICAgLy8gaW50byB0aGUgZW1wdHkgc3RyaW5nIGtleSwgd2hpY2ggaXMgdGhlIG9wdGlvbnMgZm9yIHRoZSBsb2NhbGUKICAgICAgLy8gZGF0YS4KICAgICAgaWYgKCAhIHNpbmd1bGFyX2tleSApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHRyYW5zbGF0aW9uIGtleSBmb3VuZC4nKTsKICAgICAgfQoKICAgICAgLy8gSGFuZGxlIGludmFsaWQgbnVtYmVycywgYnV0IHRyeSBjYXN0aW5nIHN0cmluZ3MgZm9yIGdvb2QgbWVhc3VyZQogICAgICBpZiAoIHR5cGVvZiB2YWwgIT0gJ251bWJlcicgKSB7CiAgICAgICAgdmFsID0gcGFyc2VJbnQoIHZhbCwgMTAgKTsKCiAgICAgICAgaWYgKCBpc05hTiggdmFsICkgKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBudW1iZXIgdGhhdCB3YXMgcGFzc2VkIGluIGlzIG5vdCBhIG51bWJlci4nKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBrZXkgID0gY29udGV4dCA/IGNvbnRleHQgKyBKZWQuY29udGV4dF9kZWxpbWl0ZXIgKyBzaW5ndWxhcl9rZXkgOiBzaW5ndWxhcl9rZXksCiAgICAgICAgICBsb2NhbGVfZGF0YSA9IHRoaXMub3B0aW9ucy5sb2NhbGVfZGF0YSwKICAgICAgICAgIGRpY3QgPSBsb2NhbGVfZGF0YVsgZG9tYWluIF0sCiAgICAgICAgICBwbHVyYWxGb3JtcyA9IGRpY3RbIiJdLnBsdXJhbF9mb3JtcyB8fCAobG9jYWxlX2RhdGEubWVzc2FnZXMgfHwgdGhpcy5kZWZhdWx0cy5sb2NhbGVfZGF0YS5tZXNzYWdlcylbIiJdLnBsdXJhbF9mb3JtcywKICAgICAgICAgIHZhbF9pZHggPSBnZXRQbHVyYWxGb3JtRnVuYyhwbHVyYWxGb3JtcykodmFsKSArIDEsCiAgICAgICAgICB2YWxfbGlzdCwKICAgICAgICAgIHJlczsKCiAgICAgIC8vIFRocm93IGFuIGVycm9yIGlmIGEgZG9tYWluIGlzbid0IGZvdW5kCiAgICAgIGlmICggISBkaWN0ICkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gZG9tYWluIG5hbWVkIGAnICsgZG9tYWluICsgJ2AgY291bGQgYmUgZm91bmQuJyk7CiAgICAgIH0KCiAgICAgIHZhbF9saXN0ID0gZGljdFsga2V5IF07CgogICAgICAvLyBJZiB0aGVyZSBpcyBubyBtYXRjaCwgdGhlbiByZXZlcnQgYmFjayB0bwogICAgICAvLyBlbmdsaXNoIHN0eWxlIHNpbmd1bGFyL3BsdXJhbCB3aXRoIHRoZSBrZXlzIHBhc3NlZCBpbi4KICAgICAgaWYgKCAhIHZhbF9saXN0IHx8IHZhbF9pZHggPj0gdmFsX2xpc3QubGVuZ3RoICkgewogICAgICAgIGlmICh0aGlzLm9wdGlvbnMubWlzc2luZ19rZXlfY2FsbGJhY2spIHsKICAgICAgICAgIHRoaXMub3B0aW9ucy5taXNzaW5nX2tleV9jYWxsYmFjayhrZXkpOwogICAgICAgIH0KICAgICAgICByZXMgPSBbIG51bGwsIHNpbmd1bGFyX2tleSwgcGx1cmFsX2tleSBdOwogICAgICAgIHJldHVybiByZXNbIGdldFBsdXJhbEZvcm1GdW5jKHBsdXJhbEZvcm1zKSggdmFsICkgKyAxIF07CiAgICAgIH0KCiAgICAgIHJlcyA9IHZhbF9saXN0WyB2YWxfaWR4IF07CgogICAgICAvLyBUaGlzIGluY2x1ZGVzIGVtcHR5IHN0cmluZ3Mgb24gcHVycG9zZQogICAgICBpZiAoICEgcmVzICApIHsKICAgICAgICByZXMgPSBbIG51bGwsIHNpbmd1bGFyX2tleSwgcGx1cmFsX2tleSBdOwogICAgICAgIHJldHVybiByZXNbIGdldFBsdXJhbEZvcm1GdW5jKHBsdXJhbEZvcm1zKSggdmFsICkgKyAxIF07CiAgICAgIH0KICAgICAgcmV0dXJuIHJlczsKICAgIH0KICB9KTsKCgogIC8vIFdlIGFkZCBpbiBzcHJpbnRmIGNhcGFiaWxpdGllcyBmb3IgcG9zdCB0cmFuc2xhdGlvbiB2YWx1ZSBpbnRlcm9sYXRpb24KICAvLyBUaGlzIGlzIG5vdCBpbnRlcm5hbGx5IHVzZWQsIHNvIHlvdSBjYW4gcmVtb3ZlIGl0IGlmIHlvdSBoYXZlIHRoaXMKICAvLyBhdmFpbGFibGUgc29tZXdoZXJlIGVsc2UsIG9yIHdhbnQgdG8gdXNlIGEgZGlmZmVyZW50IHN5c3RlbS4KCiAgLy8gV2UgX3NsaWdodGx5XyBtb2RpZnkgdGhlIG5vcm1hbCBzcHJpbnRmIGJlaGF2aW9yIHRvIG1vcmUgZ3JhY2VmdWxseSBoYW5kbGUKICAvLyB1bmRlZmluZWQgdmFsdWVzLgoKICAvKioKICAgc3ByaW50ZigpIGZvciBKYXZhU2NyaXB0IDAuNy1iZXRhMQogICBodHRwOi8vd3d3LmRpdmVpbnRvamF2YXNjcmlwdC5jb20vcHJvamVjdHMvamF2YXNjcmlwdC1zcHJpbnRmCgogICBDb3B5cmlnaHQgKGMpIEFsZXhhbmRydSBNYXJhc3RlYW51IDxhbGV4YWhvbGljIFthdCkgZ21haWwgKGRvdF0gY29tPgogICBBbGwgcmlnaHRzIHJlc2VydmVkLgoKICAgUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0CiAgIG1vZGlmaWNhdGlvbiwgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OgogICAgICAgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodAogICAgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuCiAgICAgICAqIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0CiAgICAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGUKICAgICAgICAgZG9jdW1lbnRhdGlvbiBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi4KICAgICAgICogTmVpdGhlciB0aGUgbmFtZSBvZiBzcHJpbnRmKCkgZm9yIEphdmFTY3JpcHQgbm9yIHRoZQogICAgICAgICBuYW1lcyBvZiBpdHMgY29udHJpYnV0b3JzIG1heSBiZSB1c2VkIHRvIGVuZG9yc2Ugb3IgcHJvbW90ZSBwcm9kdWN0cwogICAgICAgICBkZXJpdmVkIGZyb20gdGhpcyBzb2Z0d2FyZSB3aXRob3V0IHNwZWNpZmljIHByaW9yIHdyaXR0ZW4gcGVybWlzc2lvbi4KCiAgIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgIkFTIElTIiBBTkQKICAgQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFIElNUExJRUQKICAgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFSRQogICBESVNDTEFJTUVELiBJTiBOTyBFVkVOVCBTSEFMTCBBbGV4YW5kcnUgTWFyYXN0ZWFudSBCRSBMSUFCTEUgRk9SIEFOWQogICBESVJFQ1QsIElORElSRUNULCBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFUwogICAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7CiAgIExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORAogICBPTiBBTlkgVEhFT1JZIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUIExJQUJJTElUWSwgT1IgVE9SVAogICAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRSBVU0UgT0YgVEhJUwogICBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS4KICAqLwogIHZhciBzcHJpbnRmID0gKGZ1bmN0aW9uKCkgewogICAgZnVuY3Rpb24gZ2V0X3R5cGUodmFyaWFibGUpIHsKICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YXJpYWJsZSkuc2xpY2UoOCwgLTEpLnRvTG93ZXJDYXNlKCk7CiAgICB9CiAgICBmdW5jdGlvbiBzdHJfcmVwZWF0KGlucHV0LCBtdWx0aXBsaWVyKSB7CiAgICAgIGZvciAodmFyIG91dHB1dCA9IFtdOyBtdWx0aXBsaWVyID4gMDsgb3V0cHV0Wy0tbXVsdGlwbGllcl0gPSBpbnB1dCkgey8qIGRvIG5vdGhpbmcgKi99CiAgICAgIHJldHVybiBvdXRwdXQuam9pbignJyk7CiAgICB9CgogICAgdmFyIHN0cl9mb3JtYXQgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKCFzdHJfZm9ybWF0LmNhY2hlLmhhc093blByb3BlcnR5KGFyZ3VtZW50c1swXSkpIHsKICAgICAgICBzdHJfZm9ybWF0LmNhY2hlW2FyZ3VtZW50c1swXV0gPSBzdHJfZm9ybWF0LnBhcnNlKGFyZ3VtZW50c1swXSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHN0cl9mb3JtYXQuZm9ybWF0LmNhbGwobnVsbCwgc3RyX2Zvcm1hdC5jYWNoZVthcmd1bWVudHNbMF1dLCBhcmd1bWVudHMpOwogICAgfTsKCiAgICBzdHJfZm9ybWF0LmZvcm1hdCA9IGZ1bmN0aW9uKHBhcnNlX3RyZWUsIGFyZ3YpIHsKICAgICAgdmFyIGN1cnNvciA9IDEsIHRyZWVfbGVuZ3RoID0gcGFyc2VfdHJlZS5sZW5ndGgsIG5vZGVfdHlwZSA9ICcnLCBhcmcsIG91dHB1dCA9IFtdLCBpLCBrLCBtYXRjaCwgcGFkLCBwYWRfY2hhcmFjdGVyLCBwYWRfbGVuZ3RoOwogICAgICBmb3IgKGkgPSAwOyBpIDwgdHJlZV9sZW5ndGg7IGkrKykgewogICAgICAgIG5vZGVfdHlwZSA9IGdldF90eXBlKHBhcnNlX3RyZWVbaV0pOwogICAgICAgIGlmIChub2RlX3R5cGUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBvdXRwdXQucHVzaChwYXJzZV90cmVlW2ldKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAobm9kZV90eXBlID09PSAnYXJyYXknKSB7CiAgICAgICAgICBtYXRjaCA9IHBhcnNlX3RyZWVbaV07IC8vIGNvbnZlbmllbmNlIHB1cnBvc2VzIG9ubHkKICAgICAgICAgIGlmIChtYXRjaFsyXSkgeyAvLyBrZXl3b3JkIGFyZ3VtZW50CiAgICAgICAgICAgIGFyZyA9IGFyZ3ZbY3Vyc29yXTsKICAgICAgICAgICAgZm9yIChrID0gMDsgayA8IG1hdGNoWzJdLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICAgICAgaWYgKCFhcmcuaGFzT3duUHJvcGVydHkobWF0Y2hbMl1ba10pKSB7CiAgICAgICAgICAgICAgICB0aHJvdyhzcHJpbnRmKCdbc3ByaW50Zl0gcHJvcGVydHkgIiVzIiBkb2VzIG5vdCBleGlzdCcsIG1hdGNoWzJdW2tdKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFyZyA9IGFyZ1ttYXRjaFsyXVtrXV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYgKG1hdGNoWzFdKSB7IC8vIHBvc2l0aW9uYWwgYXJndW1lbnQgKGV4cGxpY2l0KQogICAgICAgICAgICBhcmcgPSBhcmd2W21hdGNoWzFdXTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgeyAvLyBwb3NpdGlvbmFsIGFyZ3VtZW50IChpbXBsaWNpdCkKICAgICAgICAgICAgYXJnID0gYXJndltjdXJzb3IrK107CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKC9bXnNdLy50ZXN0KG1hdGNoWzhdKSAmJiAoZ2V0X3R5cGUoYXJnKSAhPSAnbnVtYmVyJykpIHsKICAgICAgICAgICAgdGhyb3coc3ByaW50ZignW3NwcmludGZdIGV4cGVjdGluZyBudW1iZXIgYnV0IGZvdW5kICVzJywgZ2V0X3R5cGUoYXJnKSkpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIEplZCBFRElUCiAgICAgICAgICBpZiAoIHR5cGVvZiBhcmcgPT0gJ3VuZGVmaW5lZCcgfHwgYXJnID09PSBudWxsICkgewogICAgICAgICAgICBhcmcgPSAnJzsKICAgICAgICAgIH0KICAgICAgICAgIC8vIEplZCBFRElUCgogICAgICAgICAgc3dpdGNoIChtYXRjaFs4XSkgewogICAgICAgICAgICBjYXNlICdiJzogYXJnID0gYXJnLnRvU3RyaW5nKDIpOyBicmVhazsKICAgICAgICAgICAgY2FzZSAnYyc6IGFyZyA9IFN0cmluZy5mcm9tQ2hhckNvZGUoYXJnKTsgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2QnOiBhcmcgPSBwYXJzZUludChhcmcsIDEwKTsgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2UnOiBhcmcgPSBtYXRjaFs3XSA/IGFyZy50b0V4cG9uZW50aWFsKG1hdGNoWzddKSA6IGFyZy50b0V4cG9uZW50aWFsKCk7IGJyZWFrOwogICAgICAgICAgICBjYXNlICdmJzogYXJnID0gbWF0Y2hbN10gPyBwYXJzZUZsb2F0KGFyZykudG9GaXhlZChtYXRjaFs3XSkgOiBwYXJzZUZsb2F0KGFyZyk7IGJyZWFrOwogICAgICAgICAgICBjYXNlICdvJzogYXJnID0gYXJnLnRvU3RyaW5nKDgpOyBicmVhazsKICAgICAgICAgICAgY2FzZSAncyc6IGFyZyA9ICgoYXJnID0gU3RyaW5nKGFyZykpICYmIG1hdGNoWzddID8gYXJnLnN1YnN0cmluZygwLCBtYXRjaFs3XSkgOiBhcmcpOyBicmVhazsKICAgICAgICAgICAgY2FzZSAndSc6IGFyZyA9IE1hdGguYWJzKGFyZyk7IGJyZWFrOwogICAgICAgICAgICBjYXNlICd4JzogYXJnID0gYXJnLnRvU3RyaW5nKDE2KTsgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ1gnOiBhcmcgPSBhcmcudG9TdHJpbmcoMTYpLnRvVXBwZXJDYXNlKCk7IGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgYXJnID0gKC9bZGVmXS8udGVzdChtYXRjaFs4XSkgJiYgbWF0Y2hbM10gJiYgYXJnID49IDAgPyAnKycrIGFyZyA6IGFyZyk7CiAgICAgICAgICBwYWRfY2hhcmFjdGVyID0gbWF0Y2hbNF0gPyBtYXRjaFs0XSA9PSAnMCcgPyAnMCcgOiBtYXRjaFs0XS5jaGFyQXQoMSkgOiAnICc7CiAgICAgICAgICBwYWRfbGVuZ3RoID0gbWF0Y2hbNl0gLSBTdHJpbmcoYXJnKS5sZW5ndGg7CiAgICAgICAgICBwYWQgPSBtYXRjaFs2XSA/IHN0cl9yZXBlYXQocGFkX2NoYXJhY3RlciwgcGFkX2xlbmd0aCkgOiAnJzsKICAgICAgICAgIG91dHB1dC5wdXNoKG1hdGNoWzVdID8gYXJnICsgcGFkIDogcGFkICsgYXJnKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG91dHB1dC5qb2luKCcnKTsKICAgIH07CgogICAgc3RyX2Zvcm1hdC5jYWNoZSA9IHt9OwoKICAgIHN0cl9mb3JtYXQucGFyc2UgPSBmdW5jdGlvbihmbXQpIHsKICAgICAgdmFyIF9mbXQgPSBmbXQsIG1hdGNoID0gW10sIHBhcnNlX3RyZWUgPSBbXSwgYXJnX25hbWVzID0gMDsKICAgICAgd2hpbGUgKF9mbXQpIHsKICAgICAgICBpZiAoKG1hdGNoID0gL15bXlx4MjVdKy8uZXhlYyhfZm10KSkgIT09IG51bGwpIHsKICAgICAgICAgIHBhcnNlX3RyZWUucHVzaChtYXRjaFswXSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKChtYXRjaCA9IC9eXHgyNXsyfS8uZXhlYyhfZm10KSkgIT09IG51bGwpIHsKICAgICAgICAgIHBhcnNlX3RyZWUucHVzaCgnJScpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICgobWF0Y2ggPSAvXlx4MjUoPzooWzEtOV1cZCopXCR8XCgoW15cKV0rKVwpKT8oXCspPygwfCdbXiRdKT8oLSk/KFxkKyk/KD86XC4oXGQrKSk/KFtiLWZvc3V4WF0pLy5leGVjKF9mbXQpKSAhPT0gbnVsbCkgewogICAgICAgICAgaWYgKG1hdGNoWzJdKSB7CiAgICAgICAgICAgIGFyZ19uYW1lcyB8PSAxOwogICAgICAgICAgICB2YXIgZmllbGRfbGlzdCA9IFtdLCByZXBsYWNlbWVudF9maWVsZCA9IG1hdGNoWzJdLCBmaWVsZF9tYXRjaCA9IFtdOwogICAgICAgICAgICBpZiAoKGZpZWxkX21hdGNoID0gL14oW2Etel9dW2Etel9cZF0qKS9pLmV4ZWMocmVwbGFjZW1lbnRfZmllbGQpKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGZpZWxkX2xpc3QucHVzaChmaWVsZF9tYXRjaFsxXSk7CiAgICAgICAgICAgICAgd2hpbGUgKChyZXBsYWNlbWVudF9maWVsZCA9IHJlcGxhY2VtZW50X2ZpZWxkLnN1YnN0cmluZyhmaWVsZF9tYXRjaFswXS5sZW5ndGgpKSAhPT0gJycpIHsKICAgICAgICAgICAgICAgIGlmICgoZmllbGRfbWF0Y2ggPSAvXlwuKFthLXpfXVthLXpfXGRdKikvaS5leGVjKHJlcGxhY2VtZW50X2ZpZWxkKSkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZmllbGRfbGlzdC5wdXNoKGZpZWxkX21hdGNoWzFdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKChmaWVsZF9tYXRjaCA9IC9eXFsoXGQrKVxdLy5leGVjKHJlcGxhY2VtZW50X2ZpZWxkKSkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZmllbGRfbGlzdC5wdXNoKGZpZWxkX21hdGNoWzFdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICB0aHJvdygnW3NwcmludGZdIGh1aD8nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgdGhyb3coJ1tzcHJpbnRmXSBodWg/Jyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbWF0Y2hbMl0gPSBmaWVsZF9saXN0OwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGFyZ19uYW1lcyB8PSAyOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGFyZ19uYW1lcyA9PT0gMykgewogICAgICAgICAgICB0aHJvdygnW3NwcmludGZdIG1peGluZyBwb3NpdGlvbmFsIGFuZCBuYW1lZCBwbGFjZWhvbGRlcnMgaXMgbm90ICh5ZXQpIHN1cHBvcnRlZCcpOwogICAgICAgICAgfQogICAgICAgICAgcGFyc2VfdHJlZS5wdXNoKG1hdGNoKTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICB0aHJvdygnW3NwcmludGZdIGh1aD8nKTsKICAgICAgICB9CiAgICAgICAgX2ZtdCA9IF9mbXQuc3Vic3RyaW5nKG1hdGNoWzBdLmxlbmd0aCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHBhcnNlX3RyZWU7CiAgICB9OwoKICAgIHJldHVybiBzdHJfZm9ybWF0OwogIH0pKCk7CgogIHZhciB2c3ByaW50ZiA9IGZ1bmN0aW9uKGZtdCwgYXJndikgewogICAgYXJndi51bnNoaWZ0KGZtdCk7CiAgICByZXR1cm4gc3ByaW50Zi5hcHBseShudWxsLCBhcmd2KTsKICB9OwoKICBKZWQucGFyc2VfcGx1cmFsID0gZnVuY3Rpb24gKCBwbHVyYWxfZm9ybXMsIG4gKSB7CiAgICBwbHVyYWxfZm9ybXMgPSBwbHVyYWxfZm9ybXMucmVwbGFjZSgvbi9nLCBuKTsKICAgIHJldHVybiBKZWQucGFyc2VfZXhwcmVzc2lvbihwbHVyYWxfZm9ybXMpOwogIH07CgogIEplZC5zcHJpbnRmID0gZnVuY3Rpb24gKCBmbXQsIGFyZ3MgKSB7CiAgICBpZiAoIHt9LnRvU3RyaW5nLmNhbGwoIGFyZ3MgKSA9PSAnW29iamVjdCBBcnJheV0nICkgewogICAgICByZXR1cm4gdnNwcmludGYoIGZtdCwgW10uc2xpY2UuY2FsbChhcmdzKSApOwogICAgfQogICAgcmV0dXJuIHNwcmludGYuYXBwbHkodGhpcywgW10uc2xpY2UuY2FsbChhcmd1bWVudHMpICk7CiAgfTsKCiAgSmVkLnByb3RvdHlwZS5zcHJpbnRmID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIEplZC5zcHJpbnRmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKICAvLyBFTkQgc3ByaW50ZiBJbXBsZW1lbnRhdGlvbgoKICAvLyBTdGFydCB0aGUgUGx1cmFsIGZvcm1zIHNlY3Rpb24KICAvLyBUaGlzIGlzIGEgZnVsbCBwbHVyYWwgZm9ybSBleHByZXNzaW9uIHBhcnNlci4gSXQgaXMgdXNlZCB0byBhdm9pZAogIC8vIHJ1bm5pbmcgJ2V2YWwnIG9yICduZXcgRnVuY3Rpb24nIGRpcmVjdGx5IGFnYWluc3QgdGhlIHBsdXJhbAogIC8vIGZvcm1zLgogIC8vCiAgLy8gVGhpcyBjYW4gYmUgaW1wb3J0YW50IGlmIHlvdSBnZXQgdHJhbnNsYXRpb25zIGRvbmUgdGhyb3VnaCBhIDNyZAogIC8vIHBhcnR5IHZlbmRvci4gSSBlbmNvdXJhZ2UgeW91IHRvIHVzZSB0aGlzIGluc3RlYWQsIGhvd2V2ZXIsIEkKICAvLyBhbHNvIHdpbGwgcHJvdmlkZSBhICdwcmVjb21waWxlcicgdGhhdCB5b3UgY2FuIHVzZSBhdCBidWlsZCB0aW1lCiAgLy8gdG8gb3V0cHV0IHZhbGlkL3NhZmUgZnVuY3Rpb24gcmVwcmVzZW50YXRpb25zIG9mIHRoZSBwbHVyYWwgZm9ybQogIC8vIGV4cHJlc3Npb25zLiBUaGlzIG1lYW5zIHlvdSBjYW4gYnVpbGQgdGhpcyBjb2RlIG91dCBmb3IgdGhlIG1vc3QKICAvLyBwYXJ0LgogIEplZC5QRiA9IHt9OwoKICBKZWQuUEYucGFyc2UgPSBmdW5jdGlvbiAoIHAgKSB7CiAgICB2YXIgcGx1cmFsX3N0ciA9IEplZC5QRi5leHRyYWN0UGx1cmFsRXhwciggcCApOwogICAgcmV0dXJuIEplZC5QRi5wYXJzZXIucGFyc2UuY2FsbChKZWQuUEYucGFyc2VyLCBwbHVyYWxfc3RyKTsKICB9OwoKICBKZWQuUEYuY29tcGlsZSA9IGZ1bmN0aW9uICggcCApIHsKICAgIC8vIEhhbmRsZSB0cnVlcyBhbmQgZmFsc2VzIGFzIDAgYW5kIDEKICAgIGZ1bmN0aW9uIGltcGx5KCB2YWwgKSB7CiAgICAgIHJldHVybiAodmFsID09PSB0cnVlID8gMSA6IHZhbCA/IHZhbCA6IDApOwogICAgfQoKICAgIHZhciBhc3QgPSBKZWQuUEYucGFyc2UoIHAgKTsKICAgIHJldHVybiBmdW5jdGlvbiAoIG4gKSB7CiAgICAgIHJldHVybiBpbXBseSggSmVkLlBGLmludGVycHJldGVyKCBhc3QgKSggbiApICk7CiAgICB9OwogIH07CgogIEplZC5QRi5pbnRlcnByZXRlciA9IGZ1bmN0aW9uICggYXN0ICkgewogICAgcmV0dXJuIGZ1bmN0aW9uICggbiApIHsKICAgICAgdmFyIHJlczsKICAgICAgc3dpdGNoICggYXN0LnR5cGUgKSB7CiAgICAgICAgY2FzZSAnR1JPVVAnOgogICAgICAgICAgcmV0dXJuIEplZC5QRi5pbnRlcnByZXRlciggYXN0LmV4cHIgKSggbiApOwogICAgICAgIGNhc2UgJ1RFUk5BUlknOgogICAgICAgICAgaWYgKCBKZWQuUEYuaW50ZXJwcmV0ZXIoIGFzdC5leHByICkoIG4gKSApIHsKICAgICAgICAgICAgcmV0dXJuIEplZC5QRi5pbnRlcnByZXRlciggYXN0LnRydXRoeSApKCBuICk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gSmVkLlBGLmludGVycHJldGVyKCBhc3QuZmFsc2V5ICkoIG4gKTsKICAgICAgICBjYXNlICdPUic6CiAgICAgICAgICByZXR1cm4gSmVkLlBGLmludGVycHJldGVyKCBhc3QubGVmdCApKCBuICkgfHwgSmVkLlBGLmludGVycHJldGVyKCBhc3QucmlnaHQgKSggbiApOwogICAgICAgIGNhc2UgJ0FORCc6CiAgICAgICAgICByZXR1cm4gSmVkLlBGLmludGVycHJldGVyKCBhc3QubGVmdCApKCBuICkgJiYgSmVkLlBGLmludGVycHJldGVyKCBhc3QucmlnaHQgKSggbiApOwogICAgICAgIGNhc2UgJ0xUJzoKICAgICAgICAgIHJldHVybiBKZWQuUEYuaW50ZXJwcmV0ZXIoIGFzdC5sZWZ0ICkoIG4gKSA8IEplZC5QRi5pbnRlcnByZXRlciggYXN0LnJpZ2h0ICkoIG4gKTsKICAgICAgICBjYXNlICdHVCc6CiAgICAgICAgICByZXR1cm4gSmVkLlBGLmludGVycHJldGVyKCBhc3QubGVmdCApKCBuICkgPiBKZWQuUEYuaW50ZXJwcmV0ZXIoIGFzdC5yaWdodCApKCBuICk7CiAgICAgICAgY2FzZSAnTFRFJzoKICAgICAgICAgIHJldHVybiBKZWQuUEYuaW50ZXJwcmV0ZXIoIGFzdC5sZWZ0ICkoIG4gKSA8PSBKZWQuUEYuaW50ZXJwcmV0ZXIoIGFzdC5yaWdodCApKCBuICk7CiAgICAgICAgY2FzZSAnR1RFJzoKICAgICAgICAgIHJldHVybiBKZWQuUEYuaW50ZXJwcmV0ZXIoIGFzdC5sZWZ0ICkoIG4gKSA+PSBKZWQuUEYuaW50ZXJwcmV0ZXIoIGFzdC5yaWdodCApKCBuICk7CiAgICAgICAgY2FzZSAnRVEnOgogICAgICAgICAgcmV0dXJuIEplZC5QRi5pbnRlcnByZXRlciggYXN0LmxlZnQgKSggbiApID09IEplZC5QRi5pbnRlcnByZXRlciggYXN0LnJpZ2h0ICkoIG4gKTsKICAgICAgICBjYXNlICdORVEnOgogICAgICAgICAgcmV0dXJuIEplZC5QRi5pbnRlcnByZXRlciggYXN0LmxlZnQgKSggbiApICE9IEplZC5QRi5pbnRlcnByZXRlciggYXN0LnJpZ2h0ICkoIG4gKTsKICAgICAgICBjYXNlICdNT0QnOgogICAgICAgICAgcmV0dXJuIEplZC5QRi5pbnRlcnByZXRlciggYXN0LmxlZnQgKSggbiApICUgSmVkLlBGLmludGVycHJldGVyKCBhc3QucmlnaHQgKSggbiApOwogICAgICAgIGNhc2UgJ1ZBUic6CiAgICAgICAgICByZXR1cm4gbjsKICAgICAgICBjYXNlICdOVU0nOgogICAgICAgICAgcmV0dXJuIGFzdC52YWw7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBUb2tlbiBmb3VuZC4iKTsKICAgICAgfQogICAgfTsKICB9OwoKICBKZWQuUEYuZXh0cmFjdFBsdXJhbEV4cHIgPSBmdW5jdGlvbiAoIHAgKSB7CiAgICAvLyB0cmltIGZpcnN0CiAgICBwID0gcC5yZXBsYWNlKC9eXHNccyovLCAnJykucmVwbGFjZSgvXHNccyokLywgJycpOwoKICAgIGlmICghIC87XHMqJC8udGVzdChwKSkgewogICAgICBwID0gcC5jb25jYXQoJzsnKTsKICAgIH0KCiAgICB2YXIgbnBsdXJhbHNfcmUgPSAvbnBsdXJhbHNcPShcZCspOy8sCiAgICAgICAgcGx1cmFsX3JlID0gL3BsdXJhbFw9KC4qKTsvLAogICAgICAgIG5wbHVyYWxzX21hdGNoZXMgPSBwLm1hdGNoKCBucGx1cmFsc19yZSApLAogICAgICAgIHJlcyA9IHt9LAogICAgICAgIHBsdXJhbF9tYXRjaGVzOwoKICAgIC8vIEZpbmQgdGhlIG5wbHVyYWxzIG51bWJlcgogICAgaWYgKCBucGx1cmFsc19tYXRjaGVzLmxlbmd0aCA+IDEgKSB7CiAgICAgIHJlcy5ucGx1cmFscyA9IG5wbHVyYWxzX21hdGNoZXNbMV07CiAgICB9CiAgICBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCducGx1cmFscyBub3QgZm91bmQgaW4gcGx1cmFsX2Zvcm1zIHN0cmluZzogJyArIHAgKTsKICAgIH0KCiAgICAvLyByZW1vdmUgdGhhdCBkYXRhIHRvIGdldCB0byB0aGUgZm9ybXVsYQogICAgcCA9IHAucmVwbGFjZSggbnBsdXJhbHNfcmUsICIiICk7CiAgICBwbHVyYWxfbWF0Y2hlcyA9IHAubWF0Y2goIHBsdXJhbF9yZSApOwoKICAgIGlmICghKCBwbHVyYWxfbWF0Y2hlcyAmJiBwbHVyYWxfbWF0Y2hlcy5sZW5ndGggPiAxICkgKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignYHBsdXJhbGAgZXhwcmVzc2lvbiBub3QgZm91bmQ6ICcgKyBwKTsKICAgIH0KICAgIHJldHVybiBwbHVyYWxfbWF0Y2hlc1sgMSBdOwogIH07CgogIC8qIEppc29uIGdlbmVyYXRlZCBwYXJzZXIgKi8KICBKZWQuUEYucGFyc2VyID0gKGZ1bmN0aW9uKCl7Cgp2YXIgcGFyc2VyID0ge3RyYWNlOiBmdW5jdGlvbiB0cmFjZSgpIHsgfSwKeXk6IHt9LApzeW1ib2xzXzogeyJlcnJvciI6MiwiZXhwcmVzc2lvbnMiOjMsImUiOjQsIkVPRiI6NSwiPyI6NiwiOiI6NywifHwiOjgsIiYmIjo5LCI8IjoxMCwiPD0iOjExLCI+IjoxMiwiPj0iOjEzLCIhPSI6MTQsIj09IjoxNSwiJSI6MTYsIigiOjE3LCIpIjoxOCwibiI6MTksIk5VTUJFUiI6MjAsIiRhY2NlcHQiOjAsIiRlbmQiOjF9LAp0ZXJtaW5hbHNfOiB7MjoiZXJyb3IiLDU6IkVPRiIsNjoiPyIsNzoiOiIsODoifHwiLDk6IiYmIiwxMDoiPCIsMTE6Ijw9IiwxMjoiPiIsMTM6Ij49IiwxNDoiIT0iLDE1OiI9PSIsMTY6IiUiLDE3OiIoIiwxODoiKSIsMTk6Im4iLDIwOiJOVU1CRVIifSwKcHJvZHVjdGlvbnNfOiBbMCxbMywyXSxbNCw1XSxbNCwzXSxbNCwzXSxbNCwzXSxbNCwzXSxbNCwzXSxbNCwzXSxbNCwzXSxbNCwzXSxbNCwzXSxbNCwzXSxbNCwxXSxbNCwxXV0sCnBlcmZvcm1BY3Rpb246IGZ1bmN0aW9uIGFub255bW91cyh5eXRleHQseXlsZW5nLHl5bGluZW5vLHl5LHl5c3RhdGUsJCQsXyQpIHsKCnZhciAkMCA9ICQkLmxlbmd0aCAtIDE7CnN3aXRjaCAoeXlzdGF0ZSkgewpjYXNlIDE6IHJldHVybiB7IHR5cGUgOiAnR1JPVVAnLCBleHByOiAkJFskMC0xXSB9OyAKYnJlYWs7CmNhc2UgMjp0aGlzLiQgPSB7IHR5cGU6ICdURVJOQVJZJywgZXhwcjogJCRbJDAtNF0sIHRydXRoeSA6ICQkWyQwLTJdLCBmYWxzZXk6ICQkWyQwXSB9OyAKYnJlYWs7CmNhc2UgMzp0aGlzLiQgPSB7IHR5cGU6ICJPUiIsIGxlZnQ6ICQkWyQwLTJdLCByaWdodDogJCRbJDBdIH07CmJyZWFrOwpjYXNlIDQ6dGhpcy4kID0geyB0eXBlOiAiQU5EIiwgbGVmdDogJCRbJDAtMl0sIHJpZ2h0OiAkJFskMF0gfTsKYnJlYWs7CmNhc2UgNTp0aGlzLiQgPSB7IHR5cGU6ICdMVCcsIGxlZnQ6ICQkWyQwLTJdLCByaWdodDogJCRbJDBdIH07IApicmVhazsKY2FzZSA2OnRoaXMuJCA9IHsgdHlwZTogJ0xURScsIGxlZnQ6ICQkWyQwLTJdLCByaWdodDogJCRbJDBdIH07CmJyZWFrOwpjYXNlIDc6dGhpcy4kID0geyB0eXBlOiAnR1QnLCBsZWZ0OiAkJFskMC0yXSwgcmlnaHQ6ICQkWyQwXSB9OwpicmVhazsKY2FzZSA4OnRoaXMuJCA9IHsgdHlwZTogJ0dURScsIGxlZnQ6ICQkWyQwLTJdLCByaWdodDogJCRbJDBdIH07CmJyZWFrOwpjYXNlIDk6dGhpcy4kID0geyB0eXBlOiAnTkVRJywgbGVmdDogJCRbJDAtMl0sIHJpZ2h0OiAkJFskMF0gfTsKYnJlYWs7CmNhc2UgMTA6dGhpcy4kID0geyB0eXBlOiAnRVEnLCBsZWZ0OiAkJFskMC0yXSwgcmlnaHQ6ICQkWyQwXSB9OwpicmVhazsKY2FzZSAxMTp0aGlzLiQgPSB7IHR5cGU6ICdNT0QnLCBsZWZ0OiAkJFskMC0yXSwgcmlnaHQ6ICQkWyQwXSB9OwpicmVhazsKY2FzZSAxMjp0aGlzLiQgPSB7IHR5cGU6ICdHUk9VUCcsIGV4cHI6ICQkWyQwLTFdIH07IApicmVhazsKY2FzZSAxMzp0aGlzLiQgPSB7IHR5cGU6ICdWQVInIH07IApicmVhazsKY2FzZSAxNDp0aGlzLiQgPSB7IHR5cGU6ICdOVU0nLCB2YWw6IE51bWJlcih5eXRleHQpIH07IApicmVhazsKfQp9LAp0YWJsZTogW3szOjEsNDoyLDE3OlsxLDNdLDE5OlsxLDRdLDIwOlsxLDVdfSx7MTpbM119LHs1OlsxLDZdLDY6WzEsN10sODpbMSw4XSw5OlsxLDldLDEwOlsxLDEwXSwxMTpbMSwxMV0sMTI6WzEsMTJdLDEzOlsxLDEzXSwxNDpbMSwxNF0sMTU6WzEsMTVdLDE2OlsxLDE2XX0sezQ6MTcsMTc6WzEsM10sMTk6WzEsNF0sMjA6WzEsNV19LHs1OlsyLDEzXSw2OlsyLDEzXSw3OlsyLDEzXSw4OlsyLDEzXSw5OlsyLDEzXSwxMDpbMiwxM10sMTE6WzIsMTNdLDEyOlsyLDEzXSwxMzpbMiwxM10sMTQ6WzIsMTNdLDE1OlsyLDEzXSwxNjpbMiwxM10sMTg6WzIsMTNdfSx7NTpbMiwxNF0sNjpbMiwxNF0sNzpbMiwxNF0sODpbMiwxNF0sOTpbMiwxNF0sMTA6WzIsMTRdLDExOlsyLDE0XSwxMjpbMiwxNF0sMTM6WzIsMTRdLDE0OlsyLDE0XSwxNTpbMiwxNF0sMTY6WzIsMTRdLDE4OlsyLDE0XX0sezE6WzIsMV19LHs0OjE4LDE3OlsxLDNdLDE5OlsxLDRdLDIwOlsxLDVdfSx7NDoxOSwxNzpbMSwzXSwxOTpbMSw0XSwyMDpbMSw1XX0sezQ6MjAsMTc6WzEsM10sMTk6WzEsNF0sMjA6WzEsNV19LHs0OjIxLDE3OlsxLDNdLDE5OlsxLDRdLDIwOlsxLDVdfSx7NDoyMiwxNzpbMSwzXSwxOTpbMSw0XSwyMDpbMSw1XX0sezQ6MjMsMTc6WzEsM10sMTk6WzEsNF0sMjA6WzEsNV19LHs0OjI0LDE3OlsxLDNdLDE5OlsxLDRdLDIwOlsxLDVdfSx7NDoyNSwxNzpbMSwzXSwxOTpbMSw0XSwyMDpbMSw1XX0sezQ6MjYsMTc6WzEsM10sMTk6WzEsNF0sMjA6WzEsNV19LHs0OjI3LDE3OlsxLDNdLDE5OlsxLDRdLDIwOlsxLDVdfSx7NjpbMSw3XSw4OlsxLDhdLDk6WzEsOV0sMTA6WzEsMTBdLDExOlsxLDExXSwxMjpbMSwxMl0sMTM6WzEsMTNdLDE0OlsxLDE0XSwxNTpbMSwxNV0sMTY6WzEsMTZdLDE4OlsxLDI4XX0sezY6WzEsN10sNzpbMSwyOV0sODpbMSw4XSw5OlsxLDldLDEwOlsxLDEwXSwxMTpbMSwxMV0sMTI6WzEsMTJdLDEzOlsxLDEzXSwxNDpbMSwxNF0sMTU6WzEsMTVdLDE2OlsxLDE2XX0sezU6WzIsM10sNjpbMiwzXSw3OlsyLDNdLDg6WzIsM10sOTpbMSw5XSwxMDpbMSwxMF0sMTE6WzEsMTFdLDEyOlsxLDEyXSwxMzpbMSwxM10sMTQ6WzEsMTRdLDE1OlsxLDE1XSwxNjpbMSwxNl0sMTg6WzIsM119LHs1OlsyLDRdLDY6WzIsNF0sNzpbMiw0XSw4OlsyLDRdLDk6WzIsNF0sMTA6WzEsMTBdLDExOlsxLDExXSwxMjpbMSwxMl0sMTM6WzEsMTNdLDE0OlsxLDE0XSwxNTpbMSwxNV0sMTY6WzEsMTZdLDE4OlsyLDRdfSx7NTpbMiw1XSw2OlsyLDVdLDc6WzIsNV0sODpbMiw1XSw5OlsyLDVdLDEwOlsyLDVdLDExOlsyLDVdLDEyOlsyLDVdLDEzOlsyLDVdLDE0OlsyLDVdLDE1OlsyLDVdLDE2OlsxLDE2XSwxODpbMiw1XX0sezU6WzIsNl0sNjpbMiw2XSw3OlsyLDZdLDg6WzIsNl0sOTpbMiw2XSwxMDpbMiw2XSwxMTpbMiw2XSwxMjpbMiw2XSwxMzpbMiw2XSwxNDpbMiw2XSwxNTpbMiw2XSwxNjpbMSwxNl0sMTg6WzIsNl19LHs1OlsyLDddLDY6WzIsN10sNzpbMiw3XSw4OlsyLDddLDk6WzIsN10sMTA6WzIsN10sMTE6WzIsN10sMTI6WzIsN10sMTM6WzIsN10sMTQ6WzIsN10sMTU6WzIsN10sMTY6WzEsMTZdLDE4OlsyLDddfSx7NTpbMiw4XSw2OlsyLDhdLDc6WzIsOF0sODpbMiw4XSw5OlsyLDhdLDEwOlsyLDhdLDExOlsyLDhdLDEyOlsyLDhdLDEzOlsyLDhdLDE0OlsyLDhdLDE1OlsyLDhdLDE2OlsxLDE2XSwxODpbMiw4XX0sezU6WzIsOV0sNjpbMiw5XSw3OlsyLDldLDg6WzIsOV0sOTpbMiw5XSwxMDpbMiw5XSwxMTpbMiw5XSwxMjpbMiw5XSwxMzpbMiw5XSwxNDpbMiw5XSwxNTpbMiw5XSwxNjpbMSwxNl0sMTg6WzIsOV19LHs1OlsyLDEwXSw2OlsyLDEwXSw3OlsyLDEwXSw4OlsyLDEwXSw5OlsyLDEwXSwxMDpbMiwxMF0sMTE6WzIsMTBdLDEyOlsyLDEwXSwxMzpbMiwxMF0sMTQ6WzIsMTBdLDE1OlsyLDEwXSwxNjpbMSwxNl0sMTg6WzIsMTBdfSx7NTpbMiwxMV0sNjpbMiwxMV0sNzpbMiwxMV0sODpbMiwxMV0sOTpbMiwxMV0sMTA6WzIsMTFdLDExOlsyLDExXSwxMjpbMiwxMV0sMTM6WzIsMTFdLDE0OlsyLDExXSwxNTpbMiwxMV0sMTY6WzIsMTFdLDE4OlsyLDExXX0sezU6WzIsMTJdLDY6WzIsMTJdLDc6WzIsMTJdLDg6WzIsMTJdLDk6WzIsMTJdLDEwOlsyLDEyXSwxMTpbMiwxMl0sMTI6WzIsMTJdLDEzOlsyLDEyXSwxNDpbMiwxMl0sMTU6WzIsMTJdLDE2OlsyLDEyXSwxODpbMiwxMl19LHs0OjMwLDE3OlsxLDNdLDE5OlsxLDRdLDIwOlsxLDVdfSx7NTpbMiwyXSw2OlsxLDddLDc6WzIsMl0sODpbMSw4XSw5OlsxLDldLDEwOlsxLDEwXSwxMTpbMSwxMV0sMTI6WzEsMTJdLDEzOlsxLDEzXSwxNDpbMSwxNF0sMTU6WzEsMTVdLDE2OlsxLDE2XSwxODpbMiwyXX1dLApkZWZhdWx0QWN0aW9uczogezY6WzIsMV19LApwYXJzZUVycm9yOiBmdW5jdGlvbiBwYXJzZUVycm9yKHN0ciwgaGFzaCkgewogICAgdGhyb3cgbmV3IEVycm9yKHN0cik7Cn0sCnBhcnNlOiBmdW5jdGlvbiBwYXJzZShpbnB1dCkgewogICAgdmFyIHNlbGYgPSB0aGlzLAogICAgICAgIHN0YWNrID0gWzBdLAogICAgICAgIHZzdGFjayA9IFtudWxsXSwgLy8gc2VtYW50aWMgdmFsdWUgc3RhY2sKICAgICAgICBsc3RhY2sgPSBbXSwgLy8gbG9jYXRpb24gc3RhY2sKICAgICAgICB0YWJsZSA9IHRoaXMudGFibGUsCiAgICAgICAgeXl0ZXh0ID0gJycsCiAgICAgICAgeXlsaW5lbm8gPSAwLAogICAgICAgIHl5bGVuZyA9IDAsCiAgICAgICAgcmVjb3ZlcmluZyA9IDAsCiAgICAgICAgVEVSUk9SID0gMiwKICAgICAgICBFT0YgPSAxOwoKICAgIC8vdGhpcy5yZWR1Y3Rpb25Db3VudCA9IHRoaXMuc2hpZnRDb3VudCA9IDA7CgogICAgdGhpcy5sZXhlci5zZXRJbnB1dChpbnB1dCk7CiAgICB0aGlzLmxleGVyLnl5ID0gdGhpcy55eTsKICAgIHRoaXMueXkubGV4ZXIgPSB0aGlzLmxleGVyOwogICAgaWYgKHR5cGVvZiB0aGlzLmxleGVyLnl5bGxvYyA9PSAndW5kZWZpbmVkJykKICAgICAgICB0aGlzLmxleGVyLnl5bGxvYyA9IHt9OwogICAgdmFyIHl5bG9jID0gdGhpcy5sZXhlci55eWxsb2M7CiAgICBsc3RhY2sucHVzaCh5eWxvYyk7CgogICAgaWYgKHR5cGVvZiB0aGlzLnl5LnBhcnNlRXJyb3IgPT09ICdmdW5jdGlvbicpCiAgICAgICAgdGhpcy5wYXJzZUVycm9yID0gdGhpcy55eS5wYXJzZUVycm9yOwoKICAgIGZ1bmN0aW9uIHBvcFN0YWNrIChuKSB7CiAgICAgICAgc3RhY2subGVuZ3RoID0gc3RhY2subGVuZ3RoIC0gMipuOwogICAgICAgIHZzdGFjay5sZW5ndGggPSB2c3RhY2subGVuZ3RoIC0gbjsKICAgICAgICBsc3RhY2subGVuZ3RoID0gbHN0YWNrLmxlbmd0aCAtIG47CiAgICB9CgogICAgZnVuY3Rpb24gbGV4KCkgewogICAgICAgIHZhciB0b2tlbjsKICAgICAgICB0b2tlbiA9IHNlbGYubGV4ZXIubGV4KCkgfHwgMTsgLy8gJGVuZCA9IDEKICAgICAgICAvLyBpZiB0b2tlbiBpc24ndCBpdHMgbnVtZXJpYyB2YWx1ZSwgY29udmVydAogICAgICAgIGlmICh0eXBlb2YgdG9rZW4gIT09ICdudW1iZXInKSB7CiAgICAgICAgICAgIHRva2VuID0gc2VsZi5zeW1ib2xzX1t0b2tlbl0gfHwgdG9rZW47CiAgICAgICAgfQogICAgICAgIHJldHVybiB0b2tlbjsKICAgIH0KCiAgICB2YXIgc3ltYm9sLCBwcmVFcnJvclN5bWJvbCwgc3RhdGUsIGFjdGlvbiwgYSwgciwgeXl2YWw9e30scCxsZW4sbmV3U3RhdGUsIGV4cGVjdGVkOwogICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAvLyByZXRyZWl2ZSBzdGF0ZSBudW1iZXIgZnJvbSB0b3Agb2Ygc3RhY2sKICAgICAgICBzdGF0ZSA9IHN0YWNrW3N0YWNrLmxlbmd0aC0xXTsKCiAgICAgICAgLy8gdXNlIGRlZmF1bHQgYWN0aW9ucyBpZiBhdmFpbGFibGUKICAgICAgICBpZiAodGhpcy5kZWZhdWx0QWN0aW9uc1tzdGF0ZV0pIHsKICAgICAgICAgICAgYWN0aW9uID0gdGhpcy5kZWZhdWx0QWN0aW9uc1tzdGF0ZV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHN5bWJvbCA9PSBudWxsKQogICAgICAgICAgICAgICAgc3ltYm9sID0gbGV4KCk7CiAgICAgICAgICAgIC8vIHJlYWQgYWN0aW9uIGZvciBjdXJyZW50IHN0YXRlIGFuZCBmaXJzdCBpbnB1dAogICAgICAgICAgICBhY3Rpb24gPSB0YWJsZVtzdGF0ZV0gJiYgdGFibGVbc3RhdGVdW3N5bWJvbF07CiAgICAgICAgfQoKICAgICAgICAvLyBoYW5kbGUgcGFyc2UgZXJyb3IKICAgICAgICBfaGFuZGxlX2Vycm9yOgogICAgICAgIGlmICh0eXBlb2YgYWN0aW9uID09PSAndW5kZWZpbmVkJyB8fCAhYWN0aW9uLmxlbmd0aCB8fCAhYWN0aW9uWzBdKSB7CgogICAgICAgICAgICBpZiAoIXJlY292ZXJpbmcpIHsKICAgICAgICAgICAgICAgIC8vIFJlcG9ydCBlcnJvcgogICAgICAgICAgICAgICAgZXhwZWN0ZWQgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAocCBpbiB0YWJsZVtzdGF0ZV0pIGlmICh0aGlzLnRlcm1pbmFsc19bcF0gJiYgcCA+IDIpIHsKICAgICAgICAgICAgICAgICAgICBleHBlY3RlZC5wdXNoKCInIit0aGlzLnRlcm1pbmFsc19bcF0rIiciKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBlcnJTdHIgPSAnJzsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmxleGVyLnNob3dQb3NpdGlvbikgewogICAgICAgICAgICAgICAgICAgIGVyclN0ciA9ICdQYXJzZSBlcnJvciBvbiBsaW5lICcrKHl5bGluZW5vKzEpKyI6XG4iK3RoaXMubGV4ZXIuc2hvd1Bvc2l0aW9uKCkrIlxuRXhwZWN0aW5nICIrZXhwZWN0ZWQuam9pbignLCAnKSArICIsIGdvdCAnIiArIHRoaXMudGVybWluYWxzX1tzeW1ib2xdKyAiJyI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVyclN0ciA9ICdQYXJzZSBlcnJvciBvbiBsaW5lICcrKHl5bGluZW5vKzEpKyI6IFVuZXhwZWN0ZWQgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoc3ltYm9sID09IDEgLypFT0YqLyA/ICJlbmQgb2YgaW5wdXQiIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICgiJyIrKHRoaXMudGVybWluYWxzX1tzeW1ib2xdIHx8IHN5bWJvbCkrIiciKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnBhcnNlRXJyb3IoZXJyU3RyLAogICAgICAgICAgICAgICAgICAgIHt0ZXh0OiB0aGlzLmxleGVyLm1hdGNoLCB0b2tlbjogdGhpcy50ZXJtaW5hbHNfW3N5bWJvbF0gfHwgc3ltYm9sLCBsaW5lOiB0aGlzLmxleGVyLnl5bGluZW5vLCBsb2M6IHl5bG9jLCBleHBlY3RlZDogZXhwZWN0ZWR9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8ganVzdCByZWNvdmVyZWQgZnJvbSBhbm90aGVyIGVycm9yCiAgICAgICAgICAgIGlmIChyZWNvdmVyaW5nID09IDMpIHsKICAgICAgICAgICAgICAgIGlmIChzeW1ib2wgPT0gRU9GKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVyclN0ciB8fCAnUGFyc2luZyBoYWx0ZWQuJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gZGlzY2FyZCBjdXJyZW50IGxvb2thaGVhZCBhbmQgZ3JhYiBhbm90aGVyCiAgICAgICAgICAgICAgICB5eWxlbmcgPSB0aGlzLmxleGVyLnl5bGVuZzsKICAgICAgICAgICAgICAgIHl5dGV4dCA9IHRoaXMubGV4ZXIueXl0ZXh0OwogICAgICAgICAgICAgICAgeXlsaW5lbm8gPSB0aGlzLmxleGVyLnl5bGluZW5vOwogICAgICAgICAgICAgICAgeXlsb2MgPSB0aGlzLmxleGVyLnl5bGxvYzsKICAgICAgICAgICAgICAgIHN5bWJvbCA9IGxleCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyB0cnkgdG8gcmVjb3ZlciBmcm9tIGVycm9yCiAgICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgICAgICAvLyBjaGVjayBmb3IgZXJyb3IgcmVjb3ZlcnkgcnVsZSBpbiB0aGlzIHN0YXRlCiAgICAgICAgICAgICAgICBpZiAoKFRFUlJPUi50b1N0cmluZygpKSBpbiB0YWJsZVtzdGF0ZV0pIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChzdGF0ZSA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVyclN0ciB8fCAnUGFyc2luZyBoYWx0ZWQuJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwb3BTdGFjaygxKTsKICAgICAgICAgICAgICAgIHN0YXRlID0gc3RhY2tbc3RhY2subGVuZ3RoLTFdOwogICAgICAgICAgICB9CgogICAgICAgICAgICBwcmVFcnJvclN5bWJvbCA9IHN5bWJvbDsgLy8gc2F2ZSB0aGUgbG9va2FoZWFkIHRva2VuCiAgICAgICAgICAgIHN5bWJvbCA9IFRFUlJPUjsgICAgICAgICAvLyBpbnNlcnQgZ2VuZXJpYyBlcnJvciBzeW1ib2wgYXMgbmV3IGxvb2thaGVhZAogICAgICAgICAgICBzdGF0ZSA9IHN0YWNrW3N0YWNrLmxlbmd0aC0xXTsKICAgICAgICAgICAgYWN0aW9uID0gdGFibGVbc3RhdGVdICYmIHRhYmxlW3N0YXRlXVtURVJST1JdOwogICAgICAgICAgICByZWNvdmVyaW5nID0gMzsgLy8gYWxsb3cgMyByZWFsIHN5bWJvbHMgdG8gYmUgc2hpZnRlZCBiZWZvcmUgcmVwb3J0aW5nIGEgbmV3IGVycm9yCiAgICAgICAgfQoKICAgICAgICAvLyB0aGlzIHNob3VsZG4ndCBoYXBwZW4sIHVubGVzcyByZXNvbHZlIGRlZmF1bHRzIGFyZSBvZmYKICAgICAgICBpZiAoYWN0aW9uWzBdIGluc3RhbmNlb2YgQXJyYXkgJiYgYWN0aW9uLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQYXJzZSBFcnJvcjogbXVsdGlwbGUgYWN0aW9ucyBwb3NzaWJsZSBhdCBzdGF0ZTogJytzdGF0ZSsnLCB0b2tlbjogJytzeW1ib2wpOwogICAgICAgIH0KCiAgICAgICAgc3dpdGNoIChhY3Rpb25bMF0pIHsKCiAgICAgICAgICAgIGNhc2UgMTogLy8gc2hpZnQKICAgICAgICAgICAgICAgIC8vdGhpcy5zaGlmdENvdW50Kys7CgogICAgICAgICAgICAgICAgc3RhY2sucHVzaChzeW1ib2wpOwogICAgICAgICAgICAgICAgdnN0YWNrLnB1c2godGhpcy5sZXhlci55eXRleHQpOwogICAgICAgICAgICAgICAgbHN0YWNrLnB1c2godGhpcy5sZXhlci55eWxsb2MpOwogICAgICAgICAgICAgICAgc3RhY2sucHVzaChhY3Rpb25bMV0pOyAvLyBwdXNoIHN0YXRlCiAgICAgICAgICAgICAgICBzeW1ib2wgPSBudWxsOwogICAgICAgICAgICAgICAgaWYgKCFwcmVFcnJvclN5bWJvbCkgeyAvLyBub3JtYWwgZXhlY3V0aW9uL25vIGVycm9yCiAgICAgICAgICAgICAgICAgICAgeXlsZW5nID0gdGhpcy5sZXhlci55eWxlbmc7CiAgICAgICAgICAgICAgICAgICAgeXl0ZXh0ID0gdGhpcy5sZXhlci55eXRleHQ7CiAgICAgICAgICAgICAgICAgICAgeXlsaW5lbm8gPSB0aGlzLmxleGVyLnl5bGluZW5vOwogICAgICAgICAgICAgICAgICAgIHl5bG9jID0gdGhpcy5sZXhlci55eWxsb2M7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlY292ZXJpbmcgPiAwKQogICAgICAgICAgICAgICAgICAgICAgICByZWNvdmVyaW5nLS07CiAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBlcnJvciBqdXN0IG9jY3VycmVkLCByZXN1bWUgb2xkIGxvb2thaGVhZCBmLyBiZWZvcmUgZXJyb3IKICAgICAgICAgICAgICAgICAgICBzeW1ib2wgPSBwcmVFcnJvclN5bWJvbDsKICAgICAgICAgICAgICAgICAgICBwcmVFcnJvclN5bWJvbCA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgMjogLy8gcmVkdWNlCiAgICAgICAgICAgICAgICAvL3RoaXMucmVkdWN0aW9uQ291bnQrKzsKCiAgICAgICAgICAgICAgICBsZW4gPSB0aGlzLnByb2R1Y3Rpb25zX1thY3Rpb25bMV1dWzFdOwoKICAgICAgICAgICAgICAgIC8vIHBlcmZvcm0gc2VtYW50aWMgYWN0aW9uCiAgICAgICAgICAgICAgICB5eXZhbC4kID0gdnN0YWNrW3ZzdGFjay5sZW5ndGgtbGVuXTsgLy8gZGVmYXVsdCB0byAkJCA9ICQxCiAgICAgICAgICAgICAgICAvLyBkZWZhdWx0IGxvY2F0aW9uLCB1c2VzIGZpcnN0IHRva2VuIGZvciBmaXJzdHMsIGxhc3QgZm9yIGxhc3RzCiAgICAgICAgICAgICAgICB5eXZhbC5fJCA9IHsKICAgICAgICAgICAgICAgICAgICBmaXJzdF9saW5lOiBsc3RhY2tbbHN0YWNrLmxlbmd0aC0obGVufHwxKV0uZmlyc3RfbGluZSwKICAgICAgICAgICAgICAgICAgICBsYXN0X2xpbmU6IGxzdGFja1tsc3RhY2subGVuZ3RoLTFdLmxhc3RfbGluZSwKICAgICAgICAgICAgICAgICAgICBmaXJzdF9jb2x1bW46IGxzdGFja1tsc3RhY2subGVuZ3RoLShsZW58fDEpXS5maXJzdF9jb2x1bW4sCiAgICAgICAgICAgICAgICAgICAgbGFzdF9jb2x1bW46IGxzdGFja1tsc3RhY2subGVuZ3RoLTFdLmxhc3RfY29sdW1uCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgciA9IHRoaXMucGVyZm9ybUFjdGlvbi5jYWxsKHl5dmFsLCB5eXRleHQsIHl5bGVuZywgeXlsaW5lbm8sIHRoaXMueXksIGFjdGlvblsxXSwgdnN0YWNrLCBsc3RhY2spOwoKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgciAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBwb3Agb2ZmIHN0YWNrCiAgICAgICAgICAgICAgICBpZiAobGVuKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhY2sgPSBzdGFjay5zbGljZSgwLC0xKmxlbioyKTsKICAgICAgICAgICAgICAgICAgICB2c3RhY2sgPSB2c3RhY2suc2xpY2UoMCwgLTEqbGVuKTsKICAgICAgICAgICAgICAgICAgICBsc3RhY2sgPSBsc3RhY2suc2xpY2UoMCwgLTEqbGVuKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBzdGFjay5wdXNoKHRoaXMucHJvZHVjdGlvbnNfW2FjdGlvblsxXV1bMF0pOyAgICAvLyBwdXNoIG5vbnRlcm1pbmFsIChyZWR1Y2UpCiAgICAgICAgICAgICAgICB2c3RhY2sucHVzaCh5eXZhbC4kKTsKICAgICAgICAgICAgICAgIGxzdGFjay5wdXNoKHl5dmFsLl8kKTsKICAgICAgICAgICAgICAgIC8vIGdvdG8gbmV3IHN0YXRlID0gdGFibGVbU1RBVEVdW05PTlRFUk1JTkFMXQogICAgICAgICAgICAgICAgbmV3U3RhdGUgPSB0YWJsZVtzdGFja1tzdGFjay5sZW5ndGgtMl1dW3N0YWNrW3N0YWNrLmxlbmd0aC0xXV07CiAgICAgICAgICAgICAgICBzdGFjay5wdXNoKG5ld1N0YXRlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAzOiAvLyBhY2NlcHQKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICB9CgogICAgcmV0dXJuIHRydWU7Cn19Oy8qIEppc29uIGdlbmVyYXRlZCBsZXhlciAqLwp2YXIgbGV4ZXIgPSAoZnVuY3Rpb24oKXsKCnZhciBsZXhlciA9ICh7RU9GOjEsCnBhcnNlRXJyb3I6ZnVuY3Rpb24gcGFyc2VFcnJvcihzdHIsIGhhc2gpIHsKICAgICAgICBpZiAodGhpcy55eS5wYXJzZUVycm9yKSB7CiAgICAgICAgICAgIHRoaXMueXkucGFyc2VFcnJvcihzdHIsIGhhc2gpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihzdHIpOwogICAgICAgIH0KICAgIH0sCnNldElucHV0OmZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgIHRoaXMuX2lucHV0ID0gaW5wdXQ7CiAgICAgICAgdGhpcy5fbW9yZSA9IHRoaXMuX2xlc3MgPSB0aGlzLmRvbmUgPSBmYWxzZTsKICAgICAgICB0aGlzLnl5bGluZW5vID0gdGhpcy55eWxlbmcgPSAwOwogICAgICAgIHRoaXMueXl0ZXh0ID0gdGhpcy5tYXRjaGVkID0gdGhpcy5tYXRjaCA9ICcnOwogICAgICAgIHRoaXMuY29uZGl0aW9uU3RhY2sgPSBbJ0lOSVRJQUwnXTsKICAgICAgICB0aGlzLnl5bGxvYyA9IHtmaXJzdF9saW5lOjEsZmlyc3RfY29sdW1uOjAsbGFzdF9saW5lOjEsbGFzdF9jb2x1bW46MH07CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAppbnB1dDpmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGNoID0gdGhpcy5faW5wdXRbMF07CiAgICAgICAgdGhpcy55eXRleHQrPWNoOwogICAgICAgIHRoaXMueXlsZW5nKys7CiAgICAgICAgdGhpcy5tYXRjaCs9Y2g7CiAgICAgICAgdGhpcy5tYXRjaGVkKz1jaDsKICAgICAgICB2YXIgbGluZXMgPSBjaC5tYXRjaCgvXG4vKTsKICAgICAgICBpZiAobGluZXMpIHRoaXMueXlsaW5lbm8rKzsKICAgICAgICB0aGlzLl9pbnB1dCA9IHRoaXMuX2lucHV0LnNsaWNlKDEpOwogICAgICAgIHJldHVybiBjaDsKICAgIH0sCnVucHV0OmZ1bmN0aW9uIChjaCkgewogICAgICAgIHRoaXMuX2lucHV0ID0gY2ggKyB0aGlzLl9pbnB1dDsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCm1vcmU6ZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMuX21vcmUgPSB0cnVlOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKcGFzdElucHV0OmZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgcGFzdCA9IHRoaXMubWF0Y2hlZC5zdWJzdHIoMCwgdGhpcy5tYXRjaGVkLmxlbmd0aCAtIHRoaXMubWF0Y2gubGVuZ3RoKTsKICAgICAgICByZXR1cm4gKHBhc3QubGVuZ3RoID4gMjAgPyAnLi4uJzonJykgKyBwYXN0LnN1YnN0cigtMjApLnJlcGxhY2UoL1xuL2csICIiKTsKICAgIH0sCnVwY29taW5nSW5wdXQ6ZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBuZXh0ID0gdGhpcy5tYXRjaDsKICAgICAgICBpZiAobmV4dC5sZW5ndGggPCAyMCkgewogICAgICAgICAgICBuZXh0ICs9IHRoaXMuX2lucHV0LnN1YnN0cigwLCAyMC1uZXh0Lmxlbmd0aCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAobmV4dC5zdWJzdHIoMCwyMCkrKG5leHQubGVuZ3RoID4gMjAgPyAnLi4uJzonJykpLnJlcGxhY2UoL1xuL2csICIiKTsKICAgIH0sCnNob3dQb3NpdGlvbjpmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHByZSA9IHRoaXMucGFzdElucHV0KCk7CiAgICAgICAgdmFyIGMgPSBuZXcgQXJyYXkocHJlLmxlbmd0aCArIDEpLmpvaW4oIi0iKTsKICAgICAgICByZXR1cm4gcHJlICsgdGhpcy51cGNvbWluZ0lucHV0KCkgKyAiXG4iICsgYysiXiI7CiAgICB9LApuZXh0OmZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAodGhpcy5kb25lKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLkVPRjsKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLl9pbnB1dCkgdGhpcy5kb25lID0gdHJ1ZTsKCiAgICAgICAgdmFyIHRva2VuLAogICAgICAgICAgICBtYXRjaCwKICAgICAgICAgICAgY29sLAogICAgICAgICAgICBsaW5lczsKICAgICAgICBpZiAoIXRoaXMuX21vcmUpIHsKICAgICAgICAgICAgdGhpcy55eXRleHQgPSAnJzsKICAgICAgICAgICAgdGhpcy5tYXRjaCA9ICcnOwogICAgICAgIH0KICAgICAgICB2YXIgcnVsZXMgPSB0aGlzLl9jdXJyZW50UnVsZXMoKTsKICAgICAgICBmb3IgKHZhciBpPTA7aSA8IHJ1bGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIG1hdGNoID0gdGhpcy5faW5wdXQubWF0Y2godGhpcy5ydWxlc1tydWxlc1tpXV0pOwogICAgICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgICAgIGxpbmVzID0gbWF0Y2hbMF0ubWF0Y2goL1xuLiovZyk7CiAgICAgICAgICAgICAgICBpZiAobGluZXMpIHRoaXMueXlsaW5lbm8gKz0gbGluZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgdGhpcy55eWxsb2MgPSB7Zmlyc3RfbGluZTogdGhpcy55eWxsb2MubGFzdF9saW5lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdF9saW5lOiB0aGlzLnl5bGluZW5vKzEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdF9jb2x1bW46IHRoaXMueXlsbG9jLmxhc3RfY29sdW1uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdF9jb2x1bW46IGxpbmVzID8gbGluZXNbbGluZXMubGVuZ3RoLTFdLmxlbmd0aC0xIDogdGhpcy55eWxsb2MubGFzdF9jb2x1bW4gKyBtYXRjaFswXS5sZW5ndGh9CiAgICAgICAgICAgICAgICB0aGlzLnl5dGV4dCArPSBtYXRjaFswXTsKICAgICAgICAgICAgICAgIHRoaXMubWF0Y2ggKz0gbWF0Y2hbMF07CiAgICAgICAgICAgICAgICB0aGlzLm1hdGNoZXMgPSBtYXRjaDsKICAgICAgICAgICAgICAgIHRoaXMueXlsZW5nID0gdGhpcy55eXRleHQubGVuZ3RoOwogICAgICAgICAgICAgICAgdGhpcy5fbW9yZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5faW5wdXQgPSB0aGlzLl9pbnB1dC5zbGljZShtYXRjaFswXS5sZW5ndGgpOwogICAgICAgICAgICAgICAgdGhpcy5tYXRjaGVkICs9IG1hdGNoWzBdOwogICAgICAgICAgICAgICAgdG9rZW4gPSB0aGlzLnBlcmZvcm1BY3Rpb24uY2FsbCh0aGlzLCB0aGlzLnl5LCB0aGlzLCBydWxlc1tpXSx0aGlzLmNvbmRpdGlvblN0YWNrW3RoaXMuY29uZGl0aW9uU3RhY2subGVuZ3RoLTFdKTsKICAgICAgICAgICAgICAgIGlmICh0b2tlbikgcmV0dXJuIHRva2VuOwogICAgICAgICAgICAgICAgZWxzZSByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX2lucHV0ID09PSAiIikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5FT0Y7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5wYXJzZUVycm9yKCdMZXhpY2FsIGVycm9yIG9uIGxpbmUgJysodGhpcy55eWxpbmVubysxKSsnLiBVbnJlY29nbml6ZWQgdGV4dC5cbicrdGhpcy5zaG93UG9zaXRpb24oKSwgCiAgICAgICAgICAgICAgICAgICAge3RleHQ6ICIiLCB0b2tlbjogbnVsbCwgbGluZTogdGhpcy55eWxpbmVub30pOwogICAgICAgIH0KICAgIH0sCmxleDpmdW5jdGlvbiBsZXgoKSB7CiAgICAgICAgdmFyIHIgPSB0aGlzLm5leHQoKTsKICAgICAgICBpZiAodHlwZW9mIHIgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIHJldHVybiByOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxleCgpOwogICAgICAgIH0KICAgIH0sCmJlZ2luOmZ1bmN0aW9uIGJlZ2luKGNvbmRpdGlvbikgewogICAgICAgIHRoaXMuY29uZGl0aW9uU3RhY2sucHVzaChjb25kaXRpb24pOwogICAgfSwKcG9wU3RhdGU6ZnVuY3Rpb24gcG9wU3RhdGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY29uZGl0aW9uU3RhY2sucG9wKCk7CiAgICB9LApfY3VycmVudFJ1bGVzOmZ1bmN0aW9uIF9jdXJyZW50UnVsZXMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY29uZGl0aW9uc1t0aGlzLmNvbmRpdGlvblN0YWNrW3RoaXMuY29uZGl0aW9uU3RhY2subGVuZ3RoLTFdXS5ydWxlczsKICAgIH0sCnRvcFN0YXRlOmZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25kaXRpb25TdGFja1t0aGlzLmNvbmRpdGlvblN0YWNrLmxlbmd0aC0yXTsKICAgIH0sCnB1c2hTdGF0ZTpmdW5jdGlvbiBiZWdpbihjb25kaXRpb24pIHsKICAgICAgICB0aGlzLmJlZ2luKGNvbmRpdGlvbik7CiAgICB9fSk7CmxleGVyLnBlcmZvcm1BY3Rpb24gPSBmdW5jdGlvbiBhbm9ueW1vdXMoeXkseXlfLCRhdm9pZGluZ19uYW1lX2NvbGxpc2lvbnMsWVlfU1RBUlQpIHsKCnZhciBZWVNUQVRFPVlZX1NUQVJUOwpzd2l0Y2goJGF2b2lkaW5nX25hbWVfY29sbGlzaW9ucykgewpjYXNlIDA6Lyogc2tpcCB3aGl0ZXNwYWNlICovCmJyZWFrOwpjYXNlIDE6cmV0dXJuIDIwCmJyZWFrOwpjYXNlIDI6cmV0dXJuIDE5CmJyZWFrOwpjYXNlIDM6cmV0dXJuIDgKYnJlYWs7CmNhc2UgNDpyZXR1cm4gOQpicmVhazsKY2FzZSA1OnJldHVybiA2CmJyZWFrOwpjYXNlIDY6cmV0dXJuIDcKYnJlYWs7CmNhc2UgNzpyZXR1cm4gMTEKYnJlYWs7CmNhc2UgODpyZXR1cm4gMTMKYnJlYWs7CmNhc2UgOTpyZXR1cm4gMTAKYnJlYWs7CmNhc2UgMTA6cmV0dXJuIDEyCmJyZWFrOwpjYXNlIDExOnJldHVybiAxNApicmVhazsKY2FzZSAxMjpyZXR1cm4gMTUKYnJlYWs7CmNhc2UgMTM6cmV0dXJuIDE2CmJyZWFrOwpjYXNlIDE0OnJldHVybiAxNwpicmVhazsKY2FzZSAxNTpyZXR1cm4gMTgKYnJlYWs7CmNhc2UgMTY6cmV0dXJuIDUKYnJlYWs7CmNhc2UgMTc6cmV0dXJuICdJTlZBTElEJwpicmVhazsKfQp9OwpsZXhlci5ydWxlcyA9IFsvXlxzKy8sL15bMC05XSsoXC5bMC05XSspP1xiLywvXm5cYi8sL15cfFx8LywvXiYmLywvXlw/LywvXjovLC9ePD0vLC9ePj0vLC9ePC8sL14+LywvXiE9LywvXj09LywvXiUvLC9eXCgvLC9eXCkvLC9eJC8sL14uL107CmxleGVyLmNvbmRpdGlvbnMgPSB7IklOSVRJQUwiOnsicnVsZXMiOlswLDEsMiwzLDQsNSw2LDcsOCw5LDEwLDExLDEyLDEzLDE0LDE1LDE2LDE3XSwiaW5jbHVzaXZlIjp0cnVlfX07cmV0dXJuIGxleGVyO30pKCkKcGFyc2VyLmxleGVyID0gbGV4ZXI7CnJldHVybiBwYXJzZXI7Cn0pKCk7Ci8vIEVuZCBwYXJzZXIKCiAgLy8gSGFuZGxlIG5vZGUsIGFtZCwgYW5kIGdsb2JhbCBzeXN0ZW1zCiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgIGV4cG9ydHMgPSBtb2R1bGUuZXhwb3J0cyA9IEplZDsKICAgIH0KICAgIGV4cG9ydHMuSmVkID0gSmVkOwogIH0KICBlbHNlIHsKICAgIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKICAgICAgZGVmaW5lKCdqZWQnLCBbXSxmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gSmVkOwogICAgICB9KTsKICAgIH0KICAgIC8vIExlYWsgYSBnbG9iYWwgcmVnYXJkbGVzcyBvZiBtb2R1bGUgc3lzdGVtCiAgICByb290WydKZWQnXSA9IEplZDsKICB9Cgp9KSh0aGlzKTsKCi8qCiAqIFRoaXMgZmlsZSBjYW4gYmUgdXNlZCBpZiBubyBsb2NhbGUgc3VwcG9ydCBpcyByZXF1aXJlZC4KICovCihmdW5jdGlvbiAocm9vdCwgZmFjdG9yeSkgewogICAgZGVmaW5lKCJsb2NhbGVzIiwgWydqZWQnXSwgZnVuY3Rpb24gKEplZCkgewogICAgICAgIHZhciB0cmFuc2xhdGlvbnMgPSB7CiAgICAgICAgICAgICJkb21haW4iOiAiY29udmVyc2UiLAogICAgICAgICAgICAibG9jYWxlX2RhdGEiOiB7CiAgICAgICAgICAgICAgICAiY29udmVyc2UiOiB7CiAgICAgICAgICAgICAgICAgICAgIiI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgImRvbWFpbiI6ICJjb252ZXJzZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJsYW5nIjogImVuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInBsdXJhbF9mb3JtcyI6ICJucGx1cmFscz0yOyBwbHVyYWw9KG4gIT0gMSk7IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcm9vdC5sb2NhbGVzID0geyAnZW4nOiBuZXcgSmVkKHRyYW5zbGF0aW9ucykgfTsKICAgIH0pOwp9KSh0aGlzKTsKCi8vICAgICBVbmRlcnNjb3JlLmpzIDEuNi4wCi8vICAgICBodHRwOi8vdW5kZXJzY29yZWpzLm9yZwovLyAgICAgKGMpIDIwMDktMjAxNCBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgYW5kIEludmVzdGlnYXRpdmUgUmVwb3J0ZXJzICYgRWRpdG9ycwovLyAgICAgVW5kZXJzY29yZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KCihmdW5jdGlvbigpIHsKCiAgLy8gQmFzZWxpbmUgc2V0dXAKICAvLyAtLS0tLS0tLS0tLS0tLQoKICAvLyBFc3RhYmxpc2ggdGhlIHJvb3Qgb2JqZWN0LCBgd2luZG93YCBpbiB0aGUgYnJvd3Nlciwgb3IgYGV4cG9ydHNgIG9uIHRoZSBzZXJ2ZXIuCiAgdmFyIHJvb3QgPSB0aGlzOwoKICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYF9gIHZhcmlhYmxlLgogIHZhciBwcmV2aW91c1VuZGVyc2NvcmUgPSByb290Ll87CgogIC8vIEVzdGFibGlzaCB0aGUgb2JqZWN0IHRoYXQgZ2V0cyByZXR1cm5lZCB0byBicmVhayBvdXQgb2YgYSBsb29wIGl0ZXJhdGlvbi4KICB2YXIgYnJlYWtlciA9IHt9OwoKICAvLyBTYXZlIGJ5dGVzIGluIHRoZSBtaW5pZmllZCAoYnV0IG5vdCBnemlwcGVkKSB2ZXJzaW9uOgogIHZhciBBcnJheVByb3RvID0gQXJyYXkucHJvdG90eXBlLCBPYmpQcm90byA9IE9iamVjdC5wcm90b3R5cGUsIEZ1bmNQcm90byA9IEZ1bmN0aW9uLnByb3RvdHlwZTsKCiAgLy8gQ3JlYXRlIHF1aWNrIHJlZmVyZW5jZSB2YXJpYWJsZXMgZm9yIHNwZWVkIGFjY2VzcyB0byBjb3JlIHByb3RvdHlwZXMuCiAgdmFyCiAgICBwdXNoICAgICAgICAgICAgID0gQXJyYXlQcm90by5wdXNoLAogICAgc2xpY2UgICAgICAgICAgICA9IEFycmF5UHJvdG8uc2xpY2UsCiAgICBjb25jYXQgICAgICAgICAgID0gQXJyYXlQcm90by5jb25jYXQsCiAgICB0b1N0cmluZyAgICAgICAgID0gT2JqUHJvdG8udG9TdHJpbmcsCiAgICBoYXNPd25Qcm9wZXJ0eSAgID0gT2JqUHJvdG8uaGFzT3duUHJvcGVydHk7CgogIC8vIEFsbCAqKkVDTUFTY3JpcHQgNSoqIG5hdGl2ZSBmdW5jdGlvbiBpbXBsZW1lbnRhdGlvbnMgdGhhdCB3ZSBob3BlIHRvIHVzZQogIC8vIGFyZSBkZWNsYXJlZCBoZXJlLgogIHZhcgogICAgbmF0aXZlRm9yRWFjaCAgICAgID0gQXJyYXlQcm90by5mb3JFYWNoLAogICAgbmF0aXZlTWFwICAgICAgICAgID0gQXJyYXlQcm90by5tYXAsCiAgICBuYXRpdmVSZWR1Y2UgICAgICAgPSBBcnJheVByb3RvLnJlZHVjZSwKICAgIG5hdGl2ZVJlZHVjZVJpZ2h0ICA9IEFycmF5UHJvdG8ucmVkdWNlUmlnaHQsCiAgICBuYXRpdmVGaWx0ZXIgICAgICAgPSBBcnJheVByb3RvLmZpbHRlciwKICAgIG5hdGl2ZUV2ZXJ5ICAgICAgICA9IEFycmF5UHJvdG8uZXZlcnksCiAgICBuYXRpdmVTb21lICAgICAgICAgPSBBcnJheVByb3RvLnNvbWUsCiAgICBuYXRpdmVJbmRleE9mICAgICAgPSBBcnJheVByb3RvLmluZGV4T2YsCiAgICBuYXRpdmVMYXN0SW5kZXhPZiAgPSBBcnJheVByb3RvLmxhc3RJbmRleE9mLAogICAgbmF0aXZlSXNBcnJheSAgICAgID0gQXJyYXkuaXNBcnJheSwKICAgIG5hdGl2ZUtleXMgICAgICAgICA9IE9iamVjdC5rZXlzLAogICAgbmF0aXZlQmluZCAgICAgICAgID0gRnVuY1Byb3RvLmJpbmQ7CgogIC8vIENyZWF0ZSBhIHNhZmUgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdCBmb3IgdXNlIGJlbG93LgogIHZhciBfID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqIGluc3RhbmNlb2YgXykgcmV0dXJuIG9iajsKICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBfKSkgcmV0dXJuIG5ldyBfKG9iaik7CiAgICB0aGlzLl93cmFwcGVkID0gb2JqOwogIH07CgogIC8vIEV4cG9ydCB0aGUgVW5kZXJzY29yZSBvYmplY3QgZm9yICoqTm9kZS5qcyoqLCB3aXRoCiAgLy8gYmFja3dhcmRzLWNvbXBhdGliaWxpdHkgZm9yIHRoZSBvbGQgYHJlcXVpcmUoKWAgQVBJLiBJZiB3ZSdyZSBpbgogIC8vIHRoZSBicm93c2VyLCBhZGQgYF9gIGFzIGEgZ2xvYmFsIG9iamVjdCB2aWEgYSBzdHJpbmcgaWRlbnRpZmllciwKICAvLyBmb3IgQ2xvc3VyZSBDb21waWxlciAiYWR2YW5jZWQiIG1vZGUuCiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgIGV4cG9ydHMgPSBtb2R1bGUuZXhwb3J0cyA9IF87CiAgICB9CiAgICBleHBvcnRzLl8gPSBfOwogIH0gZWxzZSB7CiAgICByb290Ll8gPSBfOwogIH0KCiAgLy8gQ3VycmVudCB2ZXJzaW9uLgogIF8uVkVSU0lPTiA9ICcxLjYuMCc7CgogIC8vIENvbGxlY3Rpb24gRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gVGhlIGNvcm5lcnN0b25lLCBhbiBgZWFjaGAgaW1wbGVtZW50YXRpb24sIGFrYSBgZm9yRWFjaGAuCiAgLy8gSGFuZGxlcyBvYmplY3RzIHdpdGggdGhlIGJ1aWx0LWluIGBmb3JFYWNoYCwgYXJyYXlzLCBhbmQgcmF3IG9iamVjdHMuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGZvckVhY2hgIGlmIGF2YWlsYWJsZS4KICB2YXIgZWFjaCA9IF8uZWFjaCA9IF8uZm9yRWFjaCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIG9iajsKICAgIGlmIChuYXRpdmVGb3JFYWNoICYmIG9iai5mb3JFYWNoID09PSBuYXRpdmVGb3JFYWNoKSB7CiAgICAgIG9iai5mb3JFYWNoKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH0gZWxzZSBpZiAob2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGgpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IG9iai5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGlmIChpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtpXSwgaSwgb2JqKSA9PT0gYnJlYWtlcikgcmV0dXJuOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwogICAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0ga2V5cy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGlmIChpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXlzW2ldXSwga2V5c1tpXSwgb2JqKSA9PT0gYnJlYWtlcikgcmV0dXJuOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIFJldHVybiB0aGUgcmVzdWx0cyBvZiBhcHBseWluZyB0aGUgaXRlcmF0b3IgdG8gZWFjaCBlbGVtZW50LgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBtYXBgIGlmIGF2YWlsYWJsZS4KICBfLm1hcCA9IF8uY29sbGVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHRzID0gW107CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHRzOwogICAgaWYgKG5hdGl2ZU1hcCAmJiBvYmoubWFwID09PSBuYXRpdmVNYXApIHJldHVybiBvYmoubWFwKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgcmVzdWx0cy5wdXNoKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIHZhciByZWR1Y2VFcnJvciA9ICdSZWR1Y2Ugb2YgZW1wdHkgYXJyYXkgd2l0aCBubyBpbml0aWFsIHZhbHVlJzsKCiAgLy8gKipSZWR1Y2UqKiBidWlsZHMgdXAgYSBzaW5nbGUgcmVzdWx0IGZyb20gYSBsaXN0IG9mIHZhbHVlcywgYWthIGBpbmplY3RgLAogIC8vIG9yIGBmb2xkbGAuIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGByZWR1Y2VgIGlmIGF2YWlsYWJsZS4KICBfLnJlZHVjZSA9IF8uZm9sZGwgPSBfLmluamVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIG1lbW8sIGNvbnRleHQpIHsKICAgIHZhciBpbml0aWFsID0gYXJndW1lbnRzLmxlbmd0aCA+IDI7CiAgICBpZiAob2JqID09IG51bGwpIG9iaiA9IFtdOwogICAgaWYgKG5hdGl2ZVJlZHVjZSAmJiBvYmoucmVkdWNlID09PSBuYXRpdmVSZWR1Y2UpIHsKICAgICAgaWYgKGNvbnRleHQpIGl0ZXJhdG9yID0gXy5iaW5kKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgICAgcmV0dXJuIGluaXRpYWwgPyBvYmoucmVkdWNlKGl0ZXJhdG9yLCBtZW1vKSA6IG9iai5yZWR1Y2UoaXRlcmF0b3IpOwogICAgfQogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoIWluaXRpYWwpIHsKICAgICAgICBtZW1vID0gdmFsdWU7CiAgICAgICAgaW5pdGlhbCA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWVtbyA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgbWVtbywgdmFsdWUsIGluZGV4LCBsaXN0KTsKICAgICAgfQogICAgfSk7CiAgICBpZiAoIWluaXRpYWwpIHRocm93IG5ldyBUeXBlRXJyb3IocmVkdWNlRXJyb3IpOwogICAgcmV0dXJuIG1lbW87CiAgfTsKCiAgLy8gVGhlIHJpZ2h0LWFzc29jaWF0aXZlIHZlcnNpb24gb2YgcmVkdWNlLCBhbHNvIGtub3duIGFzIGBmb2xkcmAuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYHJlZHVjZVJpZ2h0YCBpZiBhdmFpbGFibGUuCiAgXy5yZWR1Y2VSaWdodCA9IF8uZm9sZHIgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBtZW1vLCBjb250ZXh0KSB7CiAgICB2YXIgaW5pdGlhbCA9IGFyZ3VtZW50cy5sZW5ndGggPiAyOwogICAgaWYgKG9iaiA9PSBudWxsKSBvYmogPSBbXTsKICAgIGlmIChuYXRpdmVSZWR1Y2VSaWdodCAmJiBvYmoucmVkdWNlUmlnaHQgPT09IG5hdGl2ZVJlZHVjZVJpZ2h0KSB7CiAgICAgIGlmIChjb250ZXh0KSBpdGVyYXRvciA9IF8uYmluZChpdGVyYXRvciwgY29udGV4dCk7CiAgICAgIHJldHVybiBpbml0aWFsID8gb2JqLnJlZHVjZVJpZ2h0KGl0ZXJhdG9yLCBtZW1vKSA6IG9iai5yZWR1Y2VSaWdodChpdGVyYXRvcik7CiAgICB9CiAgICB2YXIgbGVuZ3RoID0gb2JqLmxlbmd0aDsKICAgIGlmIChsZW5ndGggIT09ICtsZW5ndGgpIHsKICAgICAgdmFyIGtleXMgPSBfLmtleXMob2JqKTsKICAgICAgbGVuZ3RoID0ga2V5cy5sZW5ndGg7CiAgICB9CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGluZGV4ID0ga2V5cyA/IGtleXNbLS1sZW5ndGhdIDogLS1sZW5ndGg7CiAgICAgIGlmICghaW5pdGlhbCkgewogICAgICAgIG1lbW8gPSBvYmpbaW5kZXhdOwogICAgICAgIGluaXRpYWwgPSB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIG1lbW8gPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG1lbW8sIG9ialtpbmRleF0sIGluZGV4LCBsaXN0KTsKICAgICAgfQogICAgfSk7CiAgICBpZiAoIWluaXRpYWwpIHRocm93IG5ldyBUeXBlRXJyb3IocmVkdWNlRXJyb3IpOwogICAgcmV0dXJuIG1lbW87CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBmaXJzdCB2YWx1ZSB3aGljaCBwYXNzZXMgYSB0cnV0aCB0ZXN0LiBBbGlhc2VkIGFzIGBkZXRlY3RgLgogIF8uZmluZCA9IF8uZGV0ZWN0ID0gZnVuY3Rpb24ob2JqLCBwcmVkaWNhdGUsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHQ7CiAgICBhbnkob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKHByZWRpY2F0ZS5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpIHsKICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIHRoYXQgcGFzcyBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGZpbHRlcmAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYHNlbGVjdGAuCiAgXy5maWx0ZXIgPSBfLnNlbGVjdCA9IGZ1bmN0aW9uKG9iaiwgcHJlZGljYXRlLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0czsKICAgIGlmIChuYXRpdmVGaWx0ZXIgJiYgb2JqLmZpbHRlciA9PT0gbmF0aXZlRmlsdGVyKSByZXR1cm4gb2JqLmZpbHRlcihwcmVkaWNhdGUsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAocHJlZGljYXRlLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkgcmVzdWx0cy5wdXNoKHZhbHVlKTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKCiAgLy8gUmV0dXJuIGFsbCB0aGUgZWxlbWVudHMgZm9yIHdoaWNoIGEgdHJ1dGggdGVzdCBmYWlscy4KICBfLnJlamVjdCA9IGZ1bmN0aW9uKG9iaiwgcHJlZGljYXRlLCBjb250ZXh0KSB7CiAgICByZXR1cm4gXy5maWx0ZXIob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgcmV0dXJuICFwcmVkaWNhdGUuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpOwogICAgfSwgY29udGV4dCk7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIHdoZXRoZXIgYWxsIG9mIHRoZSBlbGVtZW50cyBtYXRjaCBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGV2ZXJ5YCBpZiBhdmFpbGFibGUuCiAgLy8gQWxpYXNlZCBhcyBgYWxsYC4KICBfLmV2ZXJ5ID0gXy5hbGwgPSBmdW5jdGlvbihvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewogICAgcHJlZGljYXRlIHx8IChwcmVkaWNhdGUgPSBfLmlkZW50aXR5KTsKICAgIHZhciByZXN1bHQgPSB0cnVlOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0OwogICAgaWYgKG5hdGl2ZUV2ZXJ5ICYmIG9iai5ldmVyeSA9PT0gbmF0aXZlRXZlcnkpIHJldHVybiBvYmouZXZlcnkocHJlZGljYXRlLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKCEocmVzdWx0ID0gcmVzdWx0ICYmIHByZWRpY2F0ZS5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpKSByZXR1cm4gYnJlYWtlcjsKICAgIH0pOwogICAgcmV0dXJuICEhcmVzdWx0OwogIH07CgogIC8vIERldGVybWluZSBpZiBhdCBsZWFzdCBvbmUgZWxlbWVudCBpbiB0aGUgb2JqZWN0IG1hdGNoZXMgYSB0cnV0aCB0ZXN0LgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBzb21lYCBpZiBhdmFpbGFibGUuCiAgLy8gQWxpYXNlZCBhcyBgYW55YC4KICB2YXIgYW55ID0gXy5zb21lID0gXy5hbnkgPSBmdW5jdGlvbihvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewogICAgcHJlZGljYXRlIHx8IChwcmVkaWNhdGUgPSBfLmlkZW50aXR5KTsKICAgIHZhciByZXN1bHQgPSBmYWxzZTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHJlc3VsdDsKICAgIGlmIChuYXRpdmVTb21lICYmIG9iai5zb21lID09PSBuYXRpdmVTb21lKSByZXR1cm4gb2JqLnNvbWUocHJlZGljYXRlLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKHJlc3VsdCB8fCAocmVzdWx0ID0gcHJlZGljYXRlLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkpIHJldHVybiBicmVha2VyOwogICAgfSk7CiAgICByZXR1cm4gISFyZXN1bHQ7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBhcnJheSBvciBvYmplY3QgY29udGFpbnMgYSBnaXZlbiB2YWx1ZSAodXNpbmcgYD09PWApLgogIC8vIEFsaWFzZWQgYXMgYGluY2x1ZGVgLgogIF8uY29udGFpbnMgPSBfLmluY2x1ZGUgPSBmdW5jdGlvbihvYmosIHRhcmdldCkgewogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgICBpZiAobmF0aXZlSW5kZXhPZiAmJiBvYmouaW5kZXhPZiA9PT0gbmF0aXZlSW5kZXhPZikgcmV0dXJuIG9iai5pbmRleE9mKHRhcmdldCkgIT0gLTE7CiAgICByZXR1cm4gYW55KG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSB0YXJnZXQ7CiAgICB9KTsKICB9OwoKICAvLyBJbnZva2UgYSBtZXRob2QgKHdpdGggYXJndW1lbnRzKSBvbiBldmVyeSBpdGVtIGluIGEgY29sbGVjdGlvbi4KICBfLmludm9rZSA9IGZ1bmN0aW9uKG9iaiwgbWV0aG9kKSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHZhciBpc0Z1bmMgPSBfLmlzRnVuY3Rpb24obWV0aG9kKTsKICAgIHJldHVybiBfLm1hcChvYmosIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiAoaXNGdW5jID8gbWV0aG9kIDogdmFsdWVbbWV0aG9kXSkuYXBwbHkodmFsdWUsIGFyZ3MpOwogICAgfSk7CiAgfTsKCiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgbWFwYDogZmV0Y2hpbmcgYSBwcm9wZXJ0eS4KICBfLnBsdWNrID0gZnVuY3Rpb24ob2JqLCBrZXkpIHsKICAgIHJldHVybiBfLm1hcChvYmosIF8ucHJvcGVydHkoa2V5KSk7CiAgfTsKCiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgZmlsdGVyYDogc2VsZWN0aW5nIG9ubHkgb2JqZWN0cwogIC8vIGNvbnRhaW5pbmcgc3BlY2lmaWMgYGtleTp2YWx1ZWAgcGFpcnMuCiAgXy53aGVyZSA9IGZ1bmN0aW9uKG9iaiwgYXR0cnMpIHsKICAgIHJldHVybiBfLmZpbHRlcihvYmosIF8ubWF0Y2hlcyhhdHRycykpOwogIH07CgogIC8vIENvbnZlbmllbmNlIHZlcnNpb24gb2YgYSBjb21tb24gdXNlIGNhc2Ugb2YgYGZpbmRgOiBnZXR0aW5nIHRoZSBmaXJzdCBvYmplY3QKICAvLyBjb250YWluaW5nIHNwZWNpZmljIGBrZXk6dmFsdWVgIHBhaXJzLgogIF8uZmluZFdoZXJlID0gZnVuY3Rpb24ob2JqLCBhdHRycykgewogICAgcmV0dXJuIF8uZmluZChvYmosIF8ubWF0Y2hlcyhhdHRycykpOwogIH07CgogIC8vIFJldHVybiB0aGUgbWF4aW11bSBlbGVtZW50IG9yIChlbGVtZW50LWJhc2VkIGNvbXB1dGF0aW9uKS4KICAvLyBDYW4ndCBvcHRpbWl6ZSBhcnJheXMgb2YgaW50ZWdlcnMgbG9uZ2VyIHRoYW4gNjUsNTM1IGVsZW1lbnRzLgogIC8vIFNlZSBbV2ViS2l0IEJ1ZyA4MDc5N10oaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTgwNzk3KQogIF8ubWF4ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzQXJyYXkob2JqKSAmJiBvYmpbMF0gPT09ICtvYmpbMF0gJiYgb2JqLmxlbmd0aCA8IDY1NTM1KSB7CiAgICAgIHJldHVybiBNYXRoLm1heC5hcHBseShNYXRoLCBvYmopOwogICAgfQogICAgdmFyIHJlc3VsdCA9IC1JbmZpbml0eSwgbGFzdENvbXB1dGVkID0gLUluZmluaXR5OwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICB2YXIgY29tcHV0ZWQgPSBpdGVyYXRvciA/IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSA6IHZhbHVlOwogICAgICBpZiAoY29tcHV0ZWQgPiBsYXN0Q29tcHV0ZWQpIHsKICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICBsYXN0Q29tcHV0ZWQgPSBjb21wdXRlZDsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIFJldHVybiB0aGUgbWluaW11bSBlbGVtZW50IChvciBlbGVtZW50LWJhc2VkIGNvbXB1dGF0aW9uKS4KICBfLm1pbiA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0FycmF5KG9iaikgJiYgb2JqWzBdID09PSArb2JqWzBdICYmIG9iai5sZW5ndGggPCA2NTUzNSkgewogICAgICByZXR1cm4gTWF0aC5taW4uYXBwbHkoTWF0aCwgb2JqKTsKICAgIH0KICAgIHZhciByZXN1bHQgPSBJbmZpbml0eSwgbGFzdENvbXB1dGVkID0gSW5maW5pdHk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHZhciBjb21wdXRlZCA9IGl0ZXJhdG9yID8gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpIDogdmFsdWU7CiAgICAgIGlmIChjb21wdXRlZCA8IGxhc3RDb21wdXRlZCkgewogICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgIGxhc3RDb21wdXRlZCA9IGNvbXB1dGVkOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gU2h1ZmZsZSBhbiBhcnJheSwgdXNpbmcgdGhlIG1vZGVybiB2ZXJzaW9uIG9mIHRoZQogIC8vIFtGaXNoZXItWWF0ZXMgc2h1ZmZsZV0oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9GaXNoZXLigJNZYXRlc19zaHVmZmxlKS4KICBfLnNodWZmbGUgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciByYW5kOwogICAgdmFyIGluZGV4ID0gMDsKICAgIHZhciBzaHVmZmxlZCA9IFtdOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJhbmQgPSBfLnJhbmRvbShpbmRleCsrKTsKICAgICAgc2h1ZmZsZWRbaW5kZXggLSAxXSA9IHNodWZmbGVkW3JhbmRdOwogICAgICBzaHVmZmxlZFtyYW5kXSA9IHZhbHVlOwogICAgfSk7CiAgICByZXR1cm4gc2h1ZmZsZWQ7CiAgfTsKCiAgLy8gU2FtcGxlICoqbioqIHJhbmRvbSB2YWx1ZXMgZnJvbSBhIGNvbGxlY3Rpb24uCiAgLy8gSWYgKipuKiogaXMgbm90IHNwZWNpZmllZCwgcmV0dXJucyBhIHNpbmdsZSByYW5kb20gZWxlbWVudC4KICAvLyBUaGUgaW50ZXJuYWwgYGd1YXJkYCBhcmd1bWVudCBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBtYXBgLgogIF8uc2FtcGxlID0gZnVuY3Rpb24ob2JqLCBuLCBndWFyZCkgewogICAgaWYgKG4gPT0gbnVsbCB8fCBndWFyZCkgewogICAgICBpZiAob2JqLmxlbmd0aCAhPT0gK29iai5sZW5ndGgpIG9iaiA9IF8udmFsdWVzKG9iaik7CiAgICAgIHJldHVybiBvYmpbXy5yYW5kb20ob2JqLmxlbmd0aCAtIDEpXTsKICAgIH0KICAgIHJldHVybiBfLnNodWZmbGUob2JqKS5zbGljZSgwLCBNYXRoLm1heCgwLCBuKSk7CiAgfTsKCiAgLy8gQW4gaW50ZXJuYWwgZnVuY3Rpb24gdG8gZ2VuZXJhdGUgbG9va3VwIGl0ZXJhdG9ycy4KICB2YXIgbG9va3VwSXRlcmF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgaWYgKHZhbHVlID09IG51bGwpIHJldHVybiBfLmlkZW50aXR5OwogICAgaWYgKF8uaXNGdW5jdGlvbih2YWx1ZSkpIHJldHVybiB2YWx1ZTsKICAgIHJldHVybiBfLnByb3BlcnR5KHZhbHVlKTsKICB9OwoKICAvLyBTb3J0IHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24gcHJvZHVjZWQgYnkgYW4gaXRlcmF0b3IuCiAgXy5zb3J0QnkgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpdGVyYXRvciA9IGxvb2t1cEl0ZXJhdG9yKGl0ZXJhdG9yKTsKICAgIHJldHVybiBfLnBsdWNrKF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgIGluZGV4OiBpbmRleCwKICAgICAgICBjcml0ZXJpYTogaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpCiAgICAgIH07CiAgICB9KS5zb3J0KGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgIHZhciBhID0gbGVmdC5jcml0ZXJpYTsKICAgICAgdmFyIGIgPSByaWdodC5jcml0ZXJpYTsKICAgICAgaWYgKGEgIT09IGIpIHsKICAgICAgICBpZiAoYSA+IGIgfHwgYSA9PT0gdm9pZCAwKSByZXR1cm4gMTsKICAgICAgICBpZiAoYSA8IGIgfHwgYiA9PT0gdm9pZCAwKSByZXR1cm4gLTE7CiAgICAgIH0KICAgICAgcmV0dXJuIGxlZnQuaW5kZXggLSByaWdodC5pbmRleDsKICAgIH0pLCAndmFsdWUnKTsKICB9OwoKICAvLyBBbiBpbnRlcm5hbCBmdW5jdGlvbiB1c2VkIGZvciBhZ2dyZWdhdGUgImdyb3VwIGJ5IiBvcGVyYXRpb25zLgogIHZhciBncm91cCA9IGZ1bmN0aW9uKGJlaGF2aW9yKSB7CiAgICByZXR1cm4gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgIGl0ZXJhdG9yID0gbG9va3VwSXRlcmF0b3IoaXRlcmF0b3IpOwogICAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CiAgICAgICAgdmFyIGtleSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBvYmopOwogICAgICAgIGJlaGF2aW9yKHJlc3VsdCwga2V5LCB2YWx1ZSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9OwoKICAvLyBHcm91cHMgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbi4gUGFzcyBlaXRoZXIgYSBzdHJpbmcgYXR0cmlidXRlCiAgLy8gdG8gZ3JvdXAgYnksIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZSBjcml0ZXJpb24uCiAgXy5ncm91cEJ5ID0gZ3JvdXAoZnVuY3Rpb24ocmVzdWx0LCBrZXksIHZhbHVlKSB7CiAgICBfLmhhcyhyZXN1bHQsIGtleSkgPyByZXN1bHRba2V5XS5wdXNoKHZhbHVlKSA6IHJlc3VsdFtrZXldID0gW3ZhbHVlXTsKICB9KTsKCiAgLy8gSW5kZXhlcyB0aGUgb2JqZWN0J3MgdmFsdWVzIGJ5IGEgY3JpdGVyaW9uLCBzaW1pbGFyIHRvIGBncm91cEJ5YCwgYnV0IGZvcgogIC8vIHdoZW4geW91IGtub3cgdGhhdCB5b3VyIGluZGV4IHZhbHVlcyB3aWxsIGJlIHVuaXF1ZS4KICBfLmluZGV4QnkgPSBncm91cChmdW5jdGlvbihyZXN1bHQsIGtleSwgdmFsdWUpIHsKICAgIHJlc3VsdFtrZXldID0gdmFsdWU7CiAgfSk7CgogIC8vIENvdW50cyBpbnN0YW5jZXMgb2YgYW4gb2JqZWN0IHRoYXQgZ3JvdXAgYnkgYSBjZXJ0YWluIGNyaXRlcmlvbi4gUGFzcwogIC8vIGVpdGhlciBhIHN0cmluZyBhdHRyaWJ1dGUgdG8gY291bnQgYnksIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZQogIC8vIGNyaXRlcmlvbi4KICBfLmNvdW50QnkgPSBncm91cChmdW5jdGlvbihyZXN1bHQsIGtleSkgewogICAgXy5oYXMocmVzdWx0LCBrZXkpID8gcmVzdWx0W2tleV0rKyA6IHJlc3VsdFtrZXldID0gMTsKICB9KTsKCiAgLy8gVXNlIGEgY29tcGFyYXRvciBmdW5jdGlvbiB0byBmaWd1cmUgb3V0IHRoZSBzbWFsbGVzdCBpbmRleCBhdCB3aGljaAogIC8vIGFuIG9iamVjdCBzaG91bGQgYmUgaW5zZXJ0ZWQgc28gYXMgdG8gbWFpbnRhaW4gb3JkZXIuIFVzZXMgYmluYXJ5IHNlYXJjaC4KICBfLnNvcnRlZEluZGV4ID0gZnVuY3Rpb24oYXJyYXksIG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGl0ZXJhdG9yID0gbG9va3VwSXRlcmF0b3IoaXRlcmF0b3IpOwogICAgdmFyIHZhbHVlID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmopOwogICAgdmFyIGxvdyA9IDAsIGhpZ2ggPSBhcnJheS5sZW5ndGg7CiAgICB3aGlsZSAobG93IDwgaGlnaCkgewogICAgICB2YXIgbWlkID0gKGxvdyArIGhpZ2gpID4+PiAxOwogICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIGFycmF5W21pZF0pIDwgdmFsdWUgPyBsb3cgPSBtaWQgKyAxIDogaGlnaCA9IG1pZDsKICAgIH0KICAgIHJldHVybiBsb3c7CiAgfTsKCiAgLy8gU2FmZWx5IGNyZWF0ZSBhIHJlYWwsIGxpdmUgYXJyYXkgZnJvbSBhbnl0aGluZyBpdGVyYWJsZS4KICBfLnRvQXJyYXkgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmICghb2JqKSByZXR1cm4gW107CiAgICBpZiAoXy5pc0FycmF5KG9iaikpIHJldHVybiBzbGljZS5jYWxsKG9iaik7CiAgICBpZiAob2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGgpIHJldHVybiBfLm1hcChvYmosIF8uaWRlbnRpdHkpOwogICAgcmV0dXJuIF8udmFsdWVzKG9iaik7CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgaW4gYW4gb2JqZWN0LgogIF8uc2l6ZSA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gMDsKICAgIHJldHVybiAob2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGgpID8gb2JqLmxlbmd0aCA6IF8ua2V5cyhvYmopLmxlbmd0aDsKICB9OwoKICAvLyBBcnJheSBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0KCiAgLy8gR2V0IHRoZSBmaXJzdCBlbGVtZW50IG9mIGFuIGFycmF5LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIHRoZSBmaXJzdCBOCiAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gQWxpYXNlZCBhcyBgaGVhZGAgYW5kIGB0YWtlYC4gVGhlICoqZ3VhcmQqKiBjaGVjawogIC8vIGFsbG93cyBpdCB0byB3b3JrIHdpdGggYF8ubWFwYC4KICBfLmZpcnN0ID0gXy5oZWFkID0gXy50YWtlID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKICAgIGlmICgobiA9PSBudWxsKSB8fCBndWFyZCkgcmV0dXJuIGFycmF5WzBdOwogICAgaWYgKG4gPCAwKSByZXR1cm4gW107CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgMCwgbik7CiAgfTsKCiAgLy8gUmV0dXJucyBldmVyeXRoaW5nIGJ1dCB0aGUgbGFzdCBlbnRyeSBvZiB0aGUgYXJyYXkuIEVzcGVjaWFsbHkgdXNlZnVsIG9uCiAgLy8gdGhlIGFyZ3VtZW50cyBvYmplY3QuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gYWxsIHRoZSB2YWx1ZXMgaW4KICAvLyB0aGUgYXJyYXksIGV4Y2x1ZGluZyB0aGUgbGFzdCBOLiBUaGUgKipndWFyZCoqIGNoZWNrIGFsbG93cyBpdCB0byB3b3JrIHdpdGgKICAvLyBgXy5tYXBgLgogIF8uaW5pdGlhbCA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewogICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIDAsIGFycmF5Lmxlbmd0aCAtICgobiA9PSBudWxsKSB8fCBndWFyZCA/IDEgOiBuKSk7CiAgfTsKCiAgLy8gR2V0IHRoZSBsYXN0IGVsZW1lbnQgb2YgYW4gYXJyYXkuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gdGhlIGxhc3QgTgogIC8vIHZhbHVlcyBpbiB0aGUgYXJyYXkuIFRoZSAqKmd1YXJkKiogY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8ubGFzdCA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiB2b2lkIDA7CiAgICBpZiAoKG4gPT0gbnVsbCkgfHwgZ3VhcmQpIHJldHVybiBhcnJheVthcnJheS5sZW5ndGggLSAxXTsKICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCBNYXRoLm1heChhcnJheS5sZW5ndGggLSBuLCAwKSk7CiAgfTsKCiAgLy8gUmV0dXJucyBldmVyeXRoaW5nIGJ1dCB0aGUgZmlyc3QgZW50cnkgb2YgdGhlIGFycmF5LiBBbGlhc2VkIGFzIGB0YWlsYCBhbmQgYGRyb3BgLgogIC8vIEVzcGVjaWFsbHkgdXNlZnVsIG9uIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nIGFuICoqbioqIHdpbGwgcmV0dXJuCiAgLy8gdGhlIHJlc3QgTiB2YWx1ZXMgaW4gdGhlIGFycmF5LiBUaGUgKipndWFyZCoqCiAgLy8gY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8ucmVzdCA9IF8udGFpbCA9IF8uZHJvcCA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewogICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIChuID09IG51bGwpIHx8IGd1YXJkID8gMSA6IG4pOwogIH07CgogIC8vIFRyaW0gb3V0IGFsbCBmYWxzeSB2YWx1ZXMgZnJvbSBhbiBhcnJheS4KICBfLmNvbXBhY3QgPSBmdW5jdGlvbihhcnJheSkgewogICAgcmV0dXJuIF8uZmlsdGVyKGFycmF5LCBfLmlkZW50aXR5KTsKICB9OwoKICAvLyBJbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiBvZiBhIHJlY3Vyc2l2ZSBgZmxhdHRlbmAgZnVuY3Rpb24uCiAgdmFyIGZsYXR0ZW4gPSBmdW5jdGlvbihpbnB1dCwgc2hhbGxvdywgb3V0cHV0KSB7CiAgICBpZiAoc2hhbGxvdyAmJiBfLmV2ZXJ5KGlucHV0LCBfLmlzQXJyYXkpKSB7CiAgICAgIHJldHVybiBjb25jYXQuYXBwbHkob3V0cHV0LCBpbnB1dCk7CiAgICB9CiAgICBlYWNoKGlucHV0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAoXy5pc0FycmF5KHZhbHVlKSB8fCBfLmlzQXJndW1lbnRzKHZhbHVlKSkgewogICAgICAgIHNoYWxsb3cgPyBwdXNoLmFwcGx5KG91dHB1dCwgdmFsdWUpIDogZmxhdHRlbih2YWx1ZSwgc2hhbGxvdywgb3V0cHV0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvdXRwdXQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG91dHB1dDsKICB9OwoKICAvLyBGbGF0dGVuIG91dCBhbiBhcnJheSwgZWl0aGVyIHJlY3Vyc2l2ZWx5IChieSBkZWZhdWx0KSwgb3IganVzdCBvbmUgbGV2ZWwuCiAgXy5mbGF0dGVuID0gZnVuY3Rpb24oYXJyYXksIHNoYWxsb3cpIHsKICAgIHJldHVybiBmbGF0dGVuKGFycmF5LCBzaGFsbG93LCBbXSk7CiAgfTsKCiAgLy8gUmV0dXJuIGEgdmVyc2lvbiBvZiB0aGUgYXJyYXkgdGhhdCBkb2VzIG5vdCBjb250YWluIHRoZSBzcGVjaWZpZWQgdmFsdWUocykuCiAgXy53aXRob3V0ID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgIHJldHVybiBfLmRpZmZlcmVuY2UoYXJyYXksIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgfTsKCiAgLy8gU3BsaXQgYW4gYXJyYXkgaW50byB0d28gYXJyYXlzOiBvbmUgd2hvc2UgZWxlbWVudHMgYWxsIHNhdGlzZnkgdGhlIGdpdmVuCiAgLy8gcHJlZGljYXRlLCBhbmQgb25lIHdob3NlIGVsZW1lbnRzIGFsbCBkbyBub3Qgc2F0aXNmeSB0aGUgcHJlZGljYXRlLgogIF8ucGFydGl0aW9uID0gZnVuY3Rpb24oYXJyYXksIHByZWRpY2F0ZSkgewogICAgdmFyIHBhc3MgPSBbXSwgZmFpbCA9IFtdOwogICAgZWFjaChhcnJheSwgZnVuY3Rpb24oZWxlbSkgewogICAgICAocHJlZGljYXRlKGVsZW0pID8gcGFzcyA6IGZhaWwpLnB1c2goZWxlbSk7CiAgICB9KTsKICAgIHJldHVybiBbcGFzcywgZmFpbF07CiAgfTsKCiAgLy8gUHJvZHVjZSBhIGR1cGxpY2F0ZS1mcmVlIHZlcnNpb24gb2YgdGhlIGFycmF5LiBJZiB0aGUgYXJyYXkgaGFzIGFscmVhZHkKICAvLyBiZWVuIHNvcnRlZCwgeW91IGhhdmUgdGhlIG9wdGlvbiBvZiB1c2luZyBhIGZhc3RlciBhbGdvcml0aG0uCiAgLy8gQWxpYXNlZCBhcyBgdW5pcXVlYC4KICBfLnVuaXEgPSBfLnVuaXF1ZSA9IGZ1bmN0aW9uKGFycmF5LCBpc1NvcnRlZCwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmIChfLmlzRnVuY3Rpb24oaXNTb3J0ZWQpKSB7CiAgICAgIGNvbnRleHQgPSBpdGVyYXRvcjsKICAgICAgaXRlcmF0b3IgPSBpc1NvcnRlZDsKICAgICAgaXNTb3J0ZWQgPSBmYWxzZTsKICAgIH0KICAgIHZhciBpbml0aWFsID0gaXRlcmF0b3IgPyBfLm1hcChhcnJheSwgaXRlcmF0b3IsIGNvbnRleHQpIDogYXJyYXk7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgdmFyIHNlZW4gPSBbXTsKICAgIGVhY2goaW5pdGlhbCwgZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CiAgICAgIGlmIChpc1NvcnRlZCA/ICghaW5kZXggfHwgc2VlbltzZWVuLmxlbmd0aCAtIDFdICE9PSB2YWx1ZSkgOiAhXy5jb250YWlucyhzZWVuLCB2YWx1ZSkpIHsKICAgICAgICBzZWVuLnB1c2godmFsdWUpOwogICAgICAgIHJlc3VsdHMucHVzaChhcnJheVtpbmRleF0pOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIFByb2R1Y2UgYW4gYXJyYXkgdGhhdCBjb250YWlucyB0aGUgdW5pb246IGVhY2ggZGlzdGluY3QgZWxlbWVudCBmcm9tIGFsbCBvZgogIC8vIHRoZSBwYXNzZWQtaW4gYXJyYXlzLgogIF8udW5pb24gPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBfLnVuaXEoXy5mbGF0dGVuKGFyZ3VtZW50cywgdHJ1ZSkpOwogIH07CgogIC8vIFByb2R1Y2UgYW4gYXJyYXkgdGhhdCBjb250YWlucyBldmVyeSBpdGVtIHNoYXJlZCBiZXR3ZWVuIGFsbCB0aGUKICAvLyBwYXNzZWQtaW4gYXJyYXlzLgogIF8uaW50ZXJzZWN0aW9uID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgIHZhciByZXN0ID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgcmV0dXJuIF8uZmlsdGVyKF8udW5pcShhcnJheSksIGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgcmV0dXJuIF8uZXZlcnkocmVzdCwgZnVuY3Rpb24ob3RoZXIpIHsKICAgICAgICByZXR1cm4gXy5jb250YWlucyhvdGhlciwgaXRlbSk7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgLy8gVGFrZSB0aGUgZGlmZmVyZW5jZSBiZXR3ZWVuIG9uZSBhcnJheSBhbmQgYSBudW1iZXIgb2Ygb3RoZXIgYXJyYXlzLgogIC8vIE9ubHkgdGhlIGVsZW1lbnRzIHByZXNlbnQgaW4ganVzdCB0aGUgZmlyc3QgYXJyYXkgd2lsbCByZW1haW4uCiAgXy5kaWZmZXJlbmNlID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgIHZhciByZXN0ID0gY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICByZXR1cm4gXy5maWx0ZXIoYXJyYXksIGZ1bmN0aW9uKHZhbHVlKXsgcmV0dXJuICFfLmNvbnRhaW5zKHJlc3QsIHZhbHVlKTsgfSk7CiAgfTsKCiAgLy8gWmlwIHRvZ2V0aGVyIG11bHRpcGxlIGxpc3RzIGludG8gYSBzaW5nbGUgYXJyYXkgLS0gZWxlbWVudHMgdGhhdCBzaGFyZQogIC8vIGFuIGluZGV4IGdvIHRvZ2V0aGVyLgogIF8uemlwID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgbGVuZ3RoID0gXy5tYXgoXy5wbHVjayhhcmd1bWVudHMsICdsZW5ndGgnKS5jb25jYXQoMCkpOwogICAgdmFyIHJlc3VsdHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgcmVzdWx0c1tpXSA9IF8ucGx1Y2soYXJndW1lbnRzLCAnJyArIGkpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKCiAgLy8gQ29udmVydHMgbGlzdHMgaW50byBvYmplY3RzLiBQYXNzIGVpdGhlciBhIHNpbmdsZSBhcnJheSBvZiBgW2tleSwgdmFsdWVdYAogIC8vIHBhaXJzLCBvciB0d28gcGFyYWxsZWwgYXJyYXlzIG9mIHRoZSBzYW1lIGxlbmd0aCAtLSBvbmUgb2Yga2V5cywgYW5kIG9uZSBvZgogIC8vIHRoZSBjb3JyZXNwb25kaW5nIHZhbHVlcy4KICBfLm9iamVjdCA9IGZ1bmN0aW9uKGxpc3QsIHZhbHVlcykgewogICAgaWYgKGxpc3QgPT0gbnVsbCkgcmV0dXJuIHt9OwogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGxpc3QubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKHZhbHVlcykgewogICAgICAgIHJlc3VsdFtsaXN0W2ldXSA9IHZhbHVlc1tpXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHRbbGlzdFtpXVswXV0gPSBsaXN0W2ldWzFdOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIElmIHRoZSBicm93c2VyIGRvZXNuJ3Qgc3VwcGx5IHVzIHdpdGggaW5kZXhPZiAoSSdtIGxvb2tpbmcgYXQgeW91LCAqKk1TSUUqKiksCiAgLy8gd2UgbmVlZCB0aGlzIGZ1bmN0aW9uLiBSZXR1cm4gdGhlIHBvc2l0aW9uIG9mIHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mIGFuCiAgLy8gaXRlbSBpbiBhbiBhcnJheSwgb3IgLTEgaWYgdGhlIGl0ZW0gaXMgbm90IGluY2x1ZGVkIGluIHRoZSBhcnJheS4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgaW5kZXhPZmAgaWYgYXZhaWxhYmxlLgogIC8vIElmIHRoZSBhcnJheSBpcyBsYXJnZSBhbmQgYWxyZWFkeSBpbiBzb3J0IG9yZGVyLCBwYXNzIGB0cnVlYAogIC8vIGZvciAqKmlzU29ydGVkKiogdG8gdXNlIGJpbmFyeSBzZWFyY2guCiAgXy5pbmRleE9mID0gZnVuY3Rpb24oYXJyYXksIGl0ZW0sIGlzU29ydGVkKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIC0xOwogICAgdmFyIGkgPSAwLCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICBpZiAoaXNTb3J0ZWQpIHsKICAgICAgaWYgKHR5cGVvZiBpc1NvcnRlZCA9PSAnbnVtYmVyJykgewogICAgICAgIGkgPSAoaXNTb3J0ZWQgPCAwID8gTWF0aC5tYXgoMCwgbGVuZ3RoICsgaXNTb3J0ZWQpIDogaXNTb3J0ZWQpOwogICAgICB9IGVsc2UgewogICAgICAgIGkgPSBfLnNvcnRlZEluZGV4KGFycmF5LCBpdGVtKTsKICAgICAgICByZXR1cm4gYXJyYXlbaV0gPT09IGl0ZW0gPyBpIDogLTE7CiAgICAgIH0KICAgIH0KICAgIGlmIChuYXRpdmVJbmRleE9mICYmIGFycmF5LmluZGV4T2YgPT09IG5hdGl2ZUluZGV4T2YpIHJldHVybiBhcnJheS5pbmRleE9mKGl0ZW0sIGlzU29ydGVkKTsKICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIGlmIChhcnJheVtpXSA9PT0gaXRlbSkgcmV0dXJuIGk7CiAgICByZXR1cm4gLTE7CiAgfTsKCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGxhc3RJbmRleE9mYCBpZiBhdmFpbGFibGUuCiAgXy5sYXN0SW5kZXhPZiA9IGZ1bmN0aW9uKGFycmF5LCBpdGVtLCBmcm9tKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIC0xOwogICAgdmFyIGhhc0luZGV4ID0gZnJvbSAhPSBudWxsOwogICAgaWYgKG5hdGl2ZUxhc3RJbmRleE9mICYmIGFycmF5Lmxhc3RJbmRleE9mID09PSBuYXRpdmVMYXN0SW5kZXhPZikgewogICAgICByZXR1cm4gaGFzSW5kZXggPyBhcnJheS5sYXN0SW5kZXhPZihpdGVtLCBmcm9tKSA6IGFycmF5Lmxhc3RJbmRleE9mKGl0ZW0pOwogICAgfQogICAgdmFyIGkgPSAoaGFzSW5kZXggPyBmcm9tIDogYXJyYXkubGVuZ3RoKTsKICAgIHdoaWxlIChpLS0pIGlmIChhcnJheVtpXSA9PT0gaXRlbSkgcmV0dXJuIGk7CiAgICByZXR1cm4gLTE7CiAgfTsKCiAgLy8gR2VuZXJhdGUgYW4gaW50ZWdlciBBcnJheSBjb250YWluaW5nIGFuIGFyaXRobWV0aWMgcHJvZ3Jlc3Npb24uIEEgcG9ydCBvZgogIC8vIHRoZSBuYXRpdmUgUHl0aG9uIGByYW5nZSgpYCBmdW5jdGlvbi4gU2VlCiAgLy8gW3RoZSBQeXRob24gZG9jdW1lbnRhdGlvbl0oaHR0cDovL2RvY3MucHl0aG9uLm9yZy9saWJyYXJ5L2Z1bmN0aW9ucy5odG1sI3JhbmdlKS4KICBfLnJhbmdlID0gZnVuY3Rpb24oc3RhcnQsIHN0b3AsIHN0ZXApIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDw9IDEpIHsKICAgICAgc3RvcCA9IHN0YXJ0IHx8IDA7CiAgICAgIHN0YXJ0ID0gMDsKICAgIH0KICAgIHN0ZXAgPSBhcmd1bWVudHNbMl0gfHwgMTsKCiAgICB2YXIgbGVuZ3RoID0gTWF0aC5tYXgoTWF0aC5jZWlsKChzdG9wIC0gc3RhcnQpIC8gc3RlcCksIDApOwogICAgdmFyIGlkeCA9IDA7CiAgICB2YXIgcmFuZ2UgPSBuZXcgQXJyYXkobGVuZ3RoKTsKCiAgICB3aGlsZShpZHggPCBsZW5ndGgpIHsKICAgICAgcmFuZ2VbaWR4KytdID0gc3RhcnQ7CiAgICAgIHN0YXJ0ICs9IHN0ZXA7CiAgICB9CgogICAgcmV0dXJuIHJhbmdlOwogIH07CgogIC8vIEZ1bmN0aW9uIChhaGVtKSBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gUmV1c2FibGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHByb3RvdHlwZSBzZXR0aW5nLgogIHZhciBjdG9yID0gZnVuY3Rpb24oKXt9OwoKICAvLyBDcmVhdGUgYSBmdW5jdGlvbiBib3VuZCB0byBhIGdpdmVuIG9iamVjdCAoYXNzaWduaW5nIGB0aGlzYCwgYW5kIGFyZ3VtZW50cywKICAvLyBvcHRpb25hbGx5KS4gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYEZ1bmN0aW9uLmJpbmRgIGlmCiAgLy8gYXZhaWxhYmxlLgogIF8uYmluZCA9IGZ1bmN0aW9uKGZ1bmMsIGNvbnRleHQpIHsKICAgIHZhciBhcmdzLCBib3VuZDsKICAgIGlmIChuYXRpdmVCaW5kICYmIGZ1bmMuYmluZCA9PT0gbmF0aXZlQmluZCkgcmV0dXJuIG5hdGl2ZUJpbmQuYXBwbHkoZnVuYywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIGlmICghXy5pc0Z1bmN0aW9uKGZ1bmMpKSB0aHJvdyBuZXcgVHlwZUVycm9yOwogICAgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHJldHVybiBib3VuZCA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgYm91bmQpKSByZXR1cm4gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgICAgY3Rvci5wcm90b3R5cGUgPSBmdW5jLnByb3RvdHlwZTsKICAgICAgdmFyIHNlbGYgPSBuZXcgY3RvcjsKICAgICAgY3Rvci5wcm90b3R5cGUgPSBudWxsOwogICAgICB2YXIgcmVzdWx0ID0gZnVuYy5hcHBseShzZWxmLCBhcmdzLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgICAgaWYgKE9iamVjdChyZXN1bHQpID09PSByZXN1bHQpIHJldHVybiByZXN1bHQ7CiAgICAgIHJldHVybiBzZWxmOwogICAgfTsKICB9OwoKICAvLyBQYXJ0aWFsbHkgYXBwbHkgYSBmdW5jdGlvbiBieSBjcmVhdGluZyBhIHZlcnNpb24gdGhhdCBoYXMgaGFkIHNvbWUgb2YgaXRzCiAgLy8gYXJndW1lbnRzIHByZS1maWxsZWQsIHdpdGhvdXQgY2hhbmdpbmcgaXRzIGR5bmFtaWMgYHRoaXNgIGNvbnRleHQuIF8gYWN0cwogIC8vIGFzIGEgcGxhY2Vob2xkZXIsIGFsbG93aW5nIGFueSBjb21iaW5hdGlvbiBvZiBhcmd1bWVudHMgdG8gYmUgcHJlLWZpbGxlZC4KICBfLnBhcnRpYWwgPSBmdW5jdGlvbihmdW5jKSB7CiAgICB2YXIgYm91bmRBcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgcG9zaXRpb24gPSAwOwogICAgICB2YXIgYXJncyA9IGJvdW5kQXJncy5zbGljZSgpOwogICAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gYXJncy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGlmIChhcmdzW2ldID09PSBfKSBhcmdzW2ldID0gYXJndW1lbnRzW3Bvc2l0aW9uKytdOwogICAgICB9CiAgICAgIHdoaWxlIChwb3NpdGlvbiA8IGFyZ3VtZW50cy5sZW5ndGgpIGFyZ3MucHVzaChhcmd1bWVudHNbcG9zaXRpb24rK10pOwogICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH07CiAgfTsKCiAgLy8gQmluZCBhIG51bWJlciBvZiBhbiBvYmplY3QncyBtZXRob2RzIHRvIHRoYXQgb2JqZWN0LiBSZW1haW5pbmcgYXJndW1lbnRzCiAgLy8gYXJlIHRoZSBtZXRob2QgbmFtZXMgdG8gYmUgYm91bmQuIFVzZWZ1bCBmb3IgZW5zdXJpbmcgdGhhdCBhbGwgY2FsbGJhY2tzCiAgLy8gZGVmaW5lZCBvbiBhbiBvYmplY3QgYmVsb25nIHRvIGl0LgogIF8uYmluZEFsbCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGZ1bmNzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgaWYgKGZ1bmNzLmxlbmd0aCA9PT0gMCkgdGhyb3cgbmV3IEVycm9yKCdiaW5kQWxsIG11c3QgYmUgcGFzc2VkIGZ1bmN0aW9uIG5hbWVzJyk7CiAgICBlYWNoKGZ1bmNzLCBmdW5jdGlvbihmKSB7IG9ialtmXSA9IF8uYmluZChvYmpbZl0sIG9iaik7IH0pOwogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBNZW1vaXplIGFuIGV4cGVuc2l2ZSBmdW5jdGlvbiBieSBzdG9yaW5nIGl0cyByZXN1bHRzLgogIF8ubWVtb2l6ZSA9IGZ1bmN0aW9uKGZ1bmMsIGhhc2hlcikgewogICAgdmFyIG1lbW8gPSB7fTsKICAgIGhhc2hlciB8fCAoaGFzaGVyID0gXy5pZGVudGl0eSk7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBrZXkgPSBoYXNoZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIF8uaGFzKG1lbW8sIGtleSkgPyBtZW1vW2tleV0gOiAobWVtb1trZXldID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfTsKCiAgLy8gRGVsYXlzIGEgZnVuY3Rpb24gZm9yIHRoZSBnaXZlbiBudW1iZXIgb2YgbWlsbGlzZWNvbmRzLCBhbmQgdGhlbiBjYWxscwogIC8vIGl0IHdpdGggdGhlIGFyZ3VtZW50cyBzdXBwbGllZC4KICBfLmRlbGF5ID0gZnVuY3Rpb24oZnVuYywgd2FpdCkgewogICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICByZXR1cm4gc2V0VGltZW91dChmdW5jdGlvbigpeyByZXR1cm4gZnVuYy5hcHBseShudWxsLCBhcmdzKTsgfSwgd2FpdCk7CiAgfTsKCiAgLy8gRGVmZXJzIGEgZnVuY3Rpb24sIHNjaGVkdWxpbmcgaXQgdG8gcnVuIGFmdGVyIHRoZSBjdXJyZW50IGNhbGwgc3RhY2sgaGFzCiAgLy8gY2xlYXJlZC4KICBfLmRlZmVyID0gZnVuY3Rpb24oZnVuYykgewogICAgcmV0dXJuIF8uZGVsYXkuYXBwbHkoXywgW2Z1bmMsIDFdLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpKTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIHdoZW4gaW52b2tlZCwgd2lsbCBvbmx5IGJlIHRyaWdnZXJlZCBhdCBtb3N0IG9uY2UKICAvLyBkdXJpbmcgYSBnaXZlbiB3aW5kb3cgb2YgdGltZS4gTm9ybWFsbHksIHRoZSB0aHJvdHRsZWQgZnVuY3Rpb24gd2lsbCBydW4KICAvLyBhcyBtdWNoIGFzIGl0IGNhbiwgd2l0aG91dCBldmVyIGdvaW5nIG1vcmUgdGhhbiBvbmNlIHBlciBgd2FpdGAgZHVyYXRpb247CiAgLy8gYnV0IGlmIHlvdSdkIGxpa2UgdG8gZGlzYWJsZSB0aGUgZXhlY3V0aW9uIG9uIHRoZSBsZWFkaW5nIGVkZ2UsIHBhc3MKICAvLyBge2xlYWRpbmc6IGZhbHNlfWAuIFRvIGRpc2FibGUgZXhlY3V0aW9uIG9uIHRoZSB0cmFpbGluZyBlZGdlLCBkaXR0by4KICBfLnRocm90dGxlID0gZnVuY3Rpb24oZnVuYywgd2FpdCwgb3B0aW9ucykgewogICAgdmFyIGNvbnRleHQsIGFyZ3MsIHJlc3VsdDsKICAgIHZhciB0aW1lb3V0ID0gbnVsbDsKICAgIHZhciBwcmV2aW91cyA9IDA7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgdmFyIGxhdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgIHByZXZpb3VzID0gb3B0aW9ucy5sZWFkaW5nID09PSBmYWxzZSA/IDAgOiBfLm5vdygpOwogICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgY29udGV4dCA9IGFyZ3MgPSBudWxsOwogICAgfTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIG5vdyA9IF8ubm93KCk7CiAgICAgIGlmICghcHJldmlvdXMgJiYgb3B0aW9ucy5sZWFkaW5nID09PSBmYWxzZSkgcHJldmlvdXMgPSBub3c7CiAgICAgIHZhciByZW1haW5pbmcgPSB3YWl0IC0gKG5vdyAtIHByZXZpb3VzKTsKICAgICAgY29udGV4dCA9IHRoaXM7CiAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIGlmIChyZW1haW5pbmcgPD0gMCkgewogICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICBwcmV2aW91cyA9IG5vdzsKICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgIGNvbnRleHQgPSBhcmdzID0gbnVsbDsKICAgICAgfSBlbHNlIGlmICghdGltZW91dCAmJiBvcHRpb25zLnRyYWlsaW5nICE9PSBmYWxzZSkgewogICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCByZW1haW5pbmcpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiwgdGhhdCwgYXMgbG9uZyBhcyBpdCBjb250aW51ZXMgdG8gYmUgaW52b2tlZCwgd2lsbCBub3QKICAvLyBiZSB0cmlnZ2VyZWQuIFRoZSBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCBhZnRlciBpdCBzdG9wcyBiZWluZyBjYWxsZWQgZm9yCiAgLy8gTiBtaWxsaXNlY29uZHMuIElmIGBpbW1lZGlhdGVgIGlzIHBhc3NlZCwgdHJpZ2dlciB0aGUgZnVuY3Rpb24gb24gdGhlCiAgLy8gbGVhZGluZyBlZGdlLCBpbnN0ZWFkIG9mIHRoZSB0cmFpbGluZy4KICBfLmRlYm91bmNlID0gZnVuY3Rpb24oZnVuYywgd2FpdCwgaW1tZWRpYXRlKSB7CiAgICB2YXIgdGltZW91dCwgYXJncywgY29udGV4dCwgdGltZXN0YW1wLCByZXN1bHQ7CgogICAgdmFyIGxhdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBsYXN0ID0gXy5ub3coKSAtIHRpbWVzdGFtcDsKICAgICAgaWYgKGxhc3QgPCB3YWl0KSB7CiAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQgLSBsYXN0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICBpZiAoIWltbWVkaWF0ZSkgewogICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICAgIGNvbnRleHQgPSBhcmdzID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBjb250ZXh0ID0gdGhpczsKICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgdGltZXN0YW1wID0gXy5ub3coKTsKICAgICAgdmFyIGNhbGxOb3cgPSBpbW1lZGlhdGUgJiYgIXRpbWVvdXQ7CiAgICAgIGlmICghdGltZW91dCkgewogICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCB3YWl0KTsKICAgICAgfQogICAgICBpZiAoY2FsbE5vdykgewogICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgY29udGV4dCA9IGFyZ3MgPSBudWxsOwogICAgICB9CgogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGV4ZWN1dGVkIGF0IG1vc3Qgb25lIHRpbWUsIG5vIG1hdHRlciBob3cKICAvLyBvZnRlbiB5b3UgY2FsbCBpdC4gVXNlZnVsIGZvciBsYXp5IGluaXRpYWxpemF0aW9uLgogIF8ub25jZSA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAgIHZhciByYW4gPSBmYWxzZSwgbWVtbzsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHJhbikgcmV0dXJuIG1lbW87CiAgICAgIHJhbiA9IHRydWU7CiAgICAgIG1lbW8gPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIGZ1bmMgPSBudWxsOwogICAgICByZXR1cm4gbWVtbzsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyB0aGUgZmlyc3QgZnVuY3Rpb24gcGFzc2VkIGFzIGFuIGFyZ3VtZW50IHRvIHRoZSBzZWNvbmQsCiAgLy8gYWxsb3dpbmcgeW91IHRvIGFkanVzdCBhcmd1bWVudHMsIHJ1biBjb2RlIGJlZm9yZSBhbmQgYWZ0ZXIsIGFuZAogIC8vIGNvbmRpdGlvbmFsbHkgZXhlY3V0ZSB0aGUgb3JpZ2luYWwgZnVuY3Rpb24uCiAgXy53cmFwID0gZnVuY3Rpb24oZnVuYywgd3JhcHBlcikgewogICAgcmV0dXJuIF8ucGFydGlhbCh3cmFwcGVyLCBmdW5jKTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCBpcyB0aGUgY29tcG9zaXRpb24gb2YgYSBsaXN0IG9mIGZ1bmN0aW9ucywgZWFjaAogIC8vIGNvbnN1bWluZyB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBmdW5jdGlvbiB0aGF0IGZvbGxvd3MuCiAgXy5jb21wb3NlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgZnVuY3MgPSBhcmd1bWVudHM7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwogICAgICBmb3IgKHZhciBpID0gZnVuY3MubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICBhcmdzID0gW2Z1bmNzW2ldLmFwcGx5KHRoaXMsIGFyZ3MpXTsKICAgICAgfQogICAgICByZXR1cm4gYXJnc1swXTsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBvbmx5IGJlIGV4ZWN1dGVkIGFmdGVyIGJlaW5nIGNhbGxlZCBOIHRpbWVzLgogIF8uYWZ0ZXIgPSBmdW5jdGlvbih0aW1lcywgZnVuYykgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBpZiAoLS10aW1lcyA8IDEpIHsKICAgICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9OwogIH07CgogIC8vIE9iamVjdCBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJldHJpZXZlIHRoZSBuYW1lcyBvZiBhbiBvYmplY3QncyBwcm9wZXJ0aWVzLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBPYmplY3Qua2V5c2AKICBfLmtleXMgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmICghXy5pc09iamVjdChvYmopKSByZXR1cm4gW107CiAgICBpZiAobmF0aXZlS2V5cykgcmV0dXJuIG5hdGl2ZUtleXMob2JqKTsKICAgIHZhciBrZXlzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSBrZXlzLnB1c2goa2V5KTsKICAgIHJldHVybiBrZXlzOwogIH07CgogIC8vIFJldHJpZXZlIHRoZSB2YWx1ZXMgb2YgYW4gb2JqZWN0J3MgcHJvcGVydGllcy4KICBfLnZhbHVlcyA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGtleXMgPSBfLmtleXMob2JqKTsKICAgIHZhciBsZW5ndGggPSBrZXlzLmxlbmd0aDsKICAgIHZhciB2YWx1ZXMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgdmFsdWVzW2ldID0gb2JqW2tleXNbaV1dOwogICAgfQogICAgcmV0dXJuIHZhbHVlczsKICB9OwoKICAvLyBDb252ZXJ0IGFuIG9iamVjdCBpbnRvIGEgbGlzdCBvZiBgW2tleSwgdmFsdWVdYCBwYWlycy4KICBfLnBhaXJzID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwogICAgdmFyIGxlbmd0aCA9IGtleXMubGVuZ3RoOwogICAgdmFyIHBhaXJzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHBhaXJzW2ldID0gW2tleXNbaV0sIG9ialtrZXlzW2ldXV07CiAgICB9CiAgICByZXR1cm4gcGFpcnM7CiAgfTsKCiAgLy8gSW52ZXJ0IHRoZSBrZXlzIGFuZCB2YWx1ZXMgb2YgYW4gb2JqZWN0LiBUaGUgdmFsdWVzIG11c3QgYmUgc2VyaWFsaXphYmxlLgogIF8uaW52ZXJ0ID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwogICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGtleXMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgcmVzdWx0W29ialtrZXlzW2ldXV0gPSBrZXlzW2ldOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBSZXR1cm4gYSBzb3J0ZWQgbGlzdCBvZiB0aGUgZnVuY3Rpb24gbmFtZXMgYXZhaWxhYmxlIG9uIHRoZSBvYmplY3QuCiAgLy8gQWxpYXNlZCBhcyBgbWV0aG9kc2AKICBfLmZ1bmN0aW9ucyA9IF8ubWV0aG9kcyA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIG5hbWVzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24ob2JqW2tleV0pKSBuYW1lcy5wdXNoKGtleSk7CiAgICB9CiAgICByZXR1cm4gbmFtZXMuc29ydCgpOwogIH07CgogIC8vIEV4dGVuZCBhIGdpdmVuIG9iamVjdCB3aXRoIGFsbCB0aGUgcHJvcGVydGllcyBpbiBwYXNzZWQtaW4gb2JqZWN0KHMpLgogIF8uZXh0ZW5kID0gZnVuY3Rpb24ob2JqKSB7CiAgICBlYWNoKHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSwgZnVuY3Rpb24oc291cmNlKSB7CiAgICAgIGlmIChzb3VyY2UpIHsKICAgICAgICBmb3IgKHZhciBwcm9wIGluIHNvdXJjZSkgewogICAgICAgICAgb2JqW3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCBvbmx5IGNvbnRhaW5pbmcgdGhlIHdoaXRlbGlzdGVkIHByb3BlcnRpZXMuCiAgXy5waWNrID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgY29weSA9IHt9OwogICAgdmFyIGtleXMgPSBjb25jYXQuYXBwbHkoQXJyYXlQcm90bywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIGVhY2goa2V5cywgZnVuY3Rpb24oa2V5KSB7CiAgICAgIGlmIChrZXkgaW4gb2JqKSBjb3B5W2tleV0gPSBvYmpba2V5XTsKICAgIH0pOwogICAgcmV0dXJuIGNvcHk7CiAgfTsKCiAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCB3aXRob3V0IHRoZSBibGFja2xpc3RlZCBwcm9wZXJ0aWVzLgogIF8ub21pdCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGNvcHkgPSB7fTsKICAgIHZhciBrZXlzID0gY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgIGlmICghXy5jb250YWlucyhrZXlzLCBrZXkpKSBjb3B5W2tleV0gPSBvYmpba2V5XTsKICAgIH0KICAgIHJldHVybiBjb3B5OwogIH07CgogIC8vIEZpbGwgaW4gYSBnaXZlbiBvYmplY3Qgd2l0aCBkZWZhdWx0IHByb3BlcnRpZXMuCiAgXy5kZWZhdWx0cyA9IGZ1bmN0aW9uKG9iaikgewogICAgZWFjaChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICAgIGlmIChvYmpbcHJvcF0gPT09IHZvaWQgMCkgb2JqW3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIENyZWF0ZSBhIChzaGFsbG93LWNsb25lZCkgZHVwbGljYXRlIG9mIGFuIG9iamVjdC4KICBfLmNsb25lID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIV8uaXNPYmplY3Qob2JqKSkgcmV0dXJuIG9iajsKICAgIHJldHVybiBfLmlzQXJyYXkob2JqKSA/IG9iai5zbGljZSgpIDogXy5leHRlbmQoe30sIG9iaik7CiAgfTsKCiAgLy8gSW52b2tlcyBpbnRlcmNlcHRvciB3aXRoIHRoZSBvYmosIGFuZCB0aGVuIHJldHVybnMgb2JqLgogIC8vIFRoZSBwcmltYXJ5IHB1cnBvc2Ugb2YgdGhpcyBtZXRob2QgaXMgdG8gInRhcCBpbnRvIiBhIG1ldGhvZCBjaGFpbiwgaW4KICAvLyBvcmRlciB0byBwZXJmb3JtIG9wZXJhdGlvbnMgb24gaW50ZXJtZWRpYXRlIHJlc3VsdHMgd2l0aGluIHRoZSBjaGFpbi4KICBfLnRhcCA9IGZ1bmN0aW9uKG9iaiwgaW50ZXJjZXB0b3IpIHsKICAgIGludGVyY2VwdG9yKG9iaik7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIEludGVybmFsIHJlY3Vyc2l2ZSBjb21wYXJpc29uIGZ1bmN0aW9uIGZvciBgaXNFcXVhbGAuCiAgdmFyIGVxID0gZnVuY3Rpb24oYSwgYiwgYVN0YWNrLCBiU3RhY2spIHsKICAgIC8vIElkZW50aWNhbCBvYmplY3RzIGFyZSBlcXVhbC4gYDAgPT09IC0wYCwgYnV0IHRoZXkgYXJlbid0IGlkZW50aWNhbC4KICAgIC8vIFNlZSB0aGUgW0hhcm1vbnkgYGVnYWxgIHByb3Bvc2FsXShodHRwOi8vd2lraS5lY21hc2NyaXB0Lm9yZy9kb2t1LnBocD9pZD1oYXJtb255OmVnYWwpLgogICAgaWYgKGEgPT09IGIpIHJldHVybiBhICE9PSAwIHx8IDEgLyBhID09IDEgLyBiOwogICAgLy8gQSBzdHJpY3QgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkgYmVjYXVzZSBgbnVsbCA9PSB1bmRlZmluZWRgLgogICAgaWYgKGEgPT0gbnVsbCB8fCBiID09IG51bGwpIHJldHVybiBhID09PSBiOwogICAgLy8gVW53cmFwIGFueSB3cmFwcGVkIG9iamVjdHMuCiAgICBpZiAoYSBpbnN0YW5jZW9mIF8pIGEgPSBhLl93cmFwcGVkOwogICAgaWYgKGIgaW5zdGFuY2VvZiBfKSBiID0gYi5fd3JhcHBlZDsKICAgIC8vIENvbXBhcmUgYFtbQ2xhc3NdXWAgbmFtZXMuCiAgICB2YXIgY2xhc3NOYW1lID0gdG9TdHJpbmcuY2FsbChhKTsKICAgIGlmIChjbGFzc05hbWUgIT0gdG9TdHJpbmcuY2FsbChiKSkgcmV0dXJuIGZhbHNlOwogICAgc3dpdGNoIChjbGFzc05hbWUpIHsKICAgICAgLy8gU3RyaW5ncywgbnVtYmVycywgZGF0ZXMsIGFuZCBib29sZWFucyBhcmUgY29tcGFyZWQgYnkgdmFsdWUuCiAgICAgIGNhc2UgJ1tvYmplY3QgU3RyaW5nXSc6CiAgICAgICAgLy8gUHJpbWl0aXZlcyBhbmQgdGhlaXIgY29ycmVzcG9uZGluZyBvYmplY3Qgd3JhcHBlcnMgYXJlIGVxdWl2YWxlbnQ7IHRodXMsIGAiNSJgIGlzCiAgICAgICAgLy8gZXF1aXZhbGVudCB0byBgbmV3IFN0cmluZygiNSIpYC4KICAgICAgICByZXR1cm4gYSA9PSBTdHJpbmcoYik7CiAgICAgIGNhc2UgJ1tvYmplY3QgTnVtYmVyXSc6CiAgICAgICAgLy8gYE5hTmBzIGFyZSBlcXVpdmFsZW50LCBidXQgbm9uLXJlZmxleGl2ZS4gQW4gYGVnYWxgIGNvbXBhcmlzb24gaXMgcGVyZm9ybWVkIGZvcgogICAgICAgIC8vIG90aGVyIG51bWVyaWMgdmFsdWVzLgogICAgICAgIHJldHVybiBhICE9ICthID8gYiAhPSArYiA6IChhID09IDAgPyAxIC8gYSA9PSAxIC8gYiA6IGEgPT0gK2IpOwogICAgICBjYXNlICdbb2JqZWN0IERhdGVdJzoKICAgICAgY2FzZSAnW29iamVjdCBCb29sZWFuXSc6CiAgICAgICAgLy8gQ29lcmNlIGRhdGVzIGFuZCBib29sZWFucyB0byBudW1lcmljIHByaW1pdGl2ZSB2YWx1ZXMuIERhdGVzIGFyZSBjb21wYXJlZCBieSB0aGVpcgogICAgICAgIC8vIG1pbGxpc2Vjb25kIHJlcHJlc2VudGF0aW9ucy4gTm90ZSB0aGF0IGludmFsaWQgZGF0ZXMgd2l0aCBtaWxsaXNlY29uZCByZXByZXNlbnRhdGlvbnMKICAgICAgICAvLyBvZiBgTmFOYCBhcmUgbm90IGVxdWl2YWxlbnQuCiAgICAgICAgcmV0dXJuICthID09ICtiOwogICAgICAvLyBSZWdFeHBzIGFyZSBjb21wYXJlZCBieSB0aGVpciBzb3VyY2UgcGF0dGVybnMgYW5kIGZsYWdzLgogICAgICBjYXNlICdbb2JqZWN0IFJlZ0V4cF0nOgogICAgICAgIHJldHVybiBhLnNvdXJjZSA9PSBiLnNvdXJjZSAmJgogICAgICAgICAgICAgICBhLmdsb2JhbCA9PSBiLmdsb2JhbCAmJgogICAgICAgICAgICAgICBhLm11bHRpbGluZSA9PSBiLm11bHRpbGluZSAmJgogICAgICAgICAgICAgICBhLmlnbm9yZUNhc2UgPT0gYi5pZ25vcmVDYXNlOwogICAgfQogICAgaWYgKHR5cGVvZiBhICE9ICdvYmplY3QnIHx8IHR5cGVvZiBiICE9ICdvYmplY3QnKSByZXR1cm4gZmFsc2U7CiAgICAvLyBBc3N1bWUgZXF1YWxpdHkgZm9yIGN5Y2xpYyBzdHJ1Y3R1cmVzLiBUaGUgYWxnb3JpdGhtIGZvciBkZXRlY3RpbmcgY3ljbGljCiAgICAvLyBzdHJ1Y3R1cmVzIGlzIGFkYXB0ZWQgZnJvbSBFUyA1LjEgc2VjdGlvbiAxNS4xMi4zLCBhYnN0cmFjdCBvcGVyYXRpb24gYEpPYC4KICAgIHZhciBsZW5ndGggPSBhU3RhY2subGVuZ3RoOwogICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgIC8vIExpbmVhciBzZWFyY2guIFBlcmZvcm1hbmNlIGlzIGludmVyc2VseSBwcm9wb3J0aW9uYWwgdG8gdGhlIG51bWJlciBvZgogICAgICAvLyB1bmlxdWUgbmVzdGVkIHN0cnVjdHVyZXMuCiAgICAgIGlmIChhU3RhY2tbbGVuZ3RoXSA9PSBhKSByZXR1cm4gYlN0YWNrW2xlbmd0aF0gPT0gYjsKICAgIH0KICAgIC8vIE9iamVjdHMgd2l0aCBkaWZmZXJlbnQgY29uc3RydWN0b3JzIGFyZSBub3QgZXF1aXZhbGVudCwgYnV0IGBPYmplY3RgcwogICAgLy8gZnJvbSBkaWZmZXJlbnQgZnJhbWVzIGFyZS4KICAgIHZhciBhQ3RvciA9IGEuY29uc3RydWN0b3IsIGJDdG9yID0gYi5jb25zdHJ1Y3RvcjsKICAgIGlmIChhQ3RvciAhPT0gYkN0b3IgJiYgIShfLmlzRnVuY3Rpb24oYUN0b3IpICYmIChhQ3RvciBpbnN0YW5jZW9mIGFDdG9yKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uaXNGdW5jdGlvbihiQ3RvcikgJiYgKGJDdG9yIGluc3RhbmNlb2YgYkN0b3IpKQogICAgICAgICAgICAgICAgICAgICAgICAmJiAoJ2NvbnN0cnVjdG9yJyBpbiBhICYmICdjb25zdHJ1Y3RvcicgaW4gYikpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgLy8gQWRkIHRoZSBmaXJzdCBvYmplY3QgdG8gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgogICAgYVN0YWNrLnB1c2goYSk7CiAgICBiU3RhY2sucHVzaChiKTsKICAgIHZhciBzaXplID0gMCwgcmVzdWx0ID0gdHJ1ZTsKICAgIC8vIFJlY3Vyc2l2ZWx5IGNvbXBhcmUgb2JqZWN0cyBhbmQgYXJyYXlzLgogICAgaWYgKGNsYXNzTmFtZSA9PSAnW29iamVjdCBBcnJheV0nKSB7CiAgICAgIC8vIENvbXBhcmUgYXJyYXkgbGVuZ3RocyB0byBkZXRlcm1pbmUgaWYgYSBkZWVwIGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5LgogICAgICBzaXplID0gYS5sZW5ndGg7CiAgICAgIHJlc3VsdCA9IHNpemUgPT0gYi5sZW5ndGg7CiAgICAgIGlmIChyZXN1bHQpIHsKICAgICAgICAvLyBEZWVwIGNvbXBhcmUgdGhlIGNvbnRlbnRzLCBpZ25vcmluZyBub24tbnVtZXJpYyBwcm9wZXJ0aWVzLgogICAgICAgIHdoaWxlIChzaXplLS0pIHsKICAgICAgICAgIGlmICghKHJlc3VsdCA9IGVxKGFbc2l6ZV0sIGJbc2l6ZV0sIGFTdGFjaywgYlN0YWNrKSkpIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gRGVlcCBjb21wYXJlIG9iamVjdHMuCiAgICAgIGZvciAodmFyIGtleSBpbiBhKSB7CiAgICAgICAgaWYgKF8uaGFzKGEsIGtleSkpIHsKICAgICAgICAgIC8vIENvdW50IHRoZSBleHBlY3RlZCBudW1iZXIgb2YgcHJvcGVydGllcy4KICAgICAgICAgIHNpemUrKzsKICAgICAgICAgIC8vIERlZXAgY29tcGFyZSBlYWNoIG1lbWJlci4KICAgICAgICAgIGlmICghKHJlc3VsdCA9IF8uaGFzKGIsIGtleSkgJiYgZXEoYVtrZXldLCBiW2tleV0sIGFTdGFjaywgYlN0YWNrKSkpIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBFbnN1cmUgdGhhdCBib3RoIG9iamVjdHMgY29udGFpbiB0aGUgc2FtZSBudW1iZXIgb2YgcHJvcGVydGllcy4KICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIGZvciAoa2V5IGluIGIpIHsKICAgICAgICAgIGlmIChfLmhhcyhiLCBrZXkpICYmICEoc2l6ZS0tKSkgYnJlYWs7CiAgICAgICAgfQogICAgICAgIHJlc3VsdCA9ICFzaXplOwogICAgICB9CiAgICB9CiAgICAvLyBSZW1vdmUgdGhlIGZpcnN0IG9iamVjdCBmcm9tIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cy4KICAgIGFTdGFjay5wb3AoKTsKICAgIGJTdGFjay5wb3AoKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gUGVyZm9ybSBhIGRlZXAgY29tcGFyaXNvbiB0byBjaGVjayBpZiB0d28gb2JqZWN0cyBhcmUgZXF1YWwuCiAgXy5pc0VxdWFsID0gZnVuY3Rpb24oYSwgYikgewogICAgcmV0dXJuIGVxKGEsIGIsIFtdLCBbXSk7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiBhcnJheSwgc3RyaW5nLCBvciBvYmplY3QgZW1wdHk/CiAgLy8gQW4gImVtcHR5IiBvYmplY3QgaGFzIG5vIGVudW1lcmFibGUgb3duLXByb3BlcnRpZXMuCiAgXy5pc0VtcHR5ID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiB0cnVlOwogICAgaWYgKF8uaXNBcnJheShvYmopIHx8IF8uaXNTdHJpbmcob2JqKSkgcmV0dXJuIG9iai5sZW5ndGggPT09IDA7CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSByZXR1cm4gZmFsc2U7CiAgICByZXR1cm4gdHJ1ZTsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhbHVlIGEgRE9NIGVsZW1lbnQ/CiAgXy5pc0VsZW1lbnQgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiAhIShvYmogJiYgb2JqLm5vZGVUeXBlID09PSAxKTsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhbHVlIGFuIGFycmF5PwogIC8vIERlbGVnYXRlcyB0byBFQ01BNSdzIG5hdGl2ZSBBcnJheS5pc0FycmF5CiAgXy5pc0FycmF5ID0gbmF0aXZlSXNBcnJheSB8fCBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiB0b1N0cmluZy5jYWxsKG9iaikgPT0gJ1tvYmplY3QgQXJyYXldJzsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhcmlhYmxlIGFuIG9iamVjdD8KICBfLmlzT2JqZWN0ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSBPYmplY3Qob2JqKTsKICB9OwoKICAvLyBBZGQgc29tZSBpc1R5cGUgbWV0aG9kczogaXNBcmd1bWVudHMsIGlzRnVuY3Rpb24sIGlzU3RyaW5nLCBpc051bWJlciwgaXNEYXRlLCBpc1JlZ0V4cC4KICBlYWNoKFsnQXJndW1lbnRzJywgJ0Z1bmN0aW9uJywgJ1N0cmluZycsICdOdW1iZXInLCAnRGF0ZScsICdSZWdFeHAnXSwgZnVuY3Rpb24obmFtZSkgewogICAgX1snaXMnICsgbmFtZV0gPSBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PSAnW29iamVjdCAnICsgbmFtZSArICddJzsKICAgIH07CiAgfSk7CgogIC8vIERlZmluZSBhIGZhbGxiYWNrIHZlcnNpb24gb2YgdGhlIG1ldGhvZCBpbiBicm93c2VycyAoYWhlbSwgSUUpLCB3aGVyZQogIC8vIHRoZXJlIGlzbid0IGFueSBpbnNwZWN0YWJsZSAiQXJndW1lbnRzIiB0eXBlLgogIGlmICghXy5pc0FyZ3VtZW50cyhhcmd1bWVudHMpKSB7CiAgICBfLmlzQXJndW1lbnRzID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgIHJldHVybiAhIShvYmogJiYgXy5oYXMob2JqLCAnY2FsbGVlJykpOwogICAgfTsKICB9CgogIC8vIE9wdGltaXplIGBpc0Z1bmN0aW9uYCBpZiBhcHByb3ByaWF0ZS4KICBpZiAodHlwZW9mICgvLi8pICE9PSAnZnVuY3Rpb24nKSB7CiAgICBfLmlzRnVuY3Rpb24gPSBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbic7CiAgICB9OwogIH0KCiAgLy8gSXMgYSBnaXZlbiBvYmplY3QgYSBmaW5pdGUgbnVtYmVyPwogIF8uaXNGaW5pdGUgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBpc0Zpbml0ZShvYmopICYmICFpc05hTihwYXJzZUZsb2F0KG9iaikpOwogIH07CgogIC8vIElzIHRoZSBnaXZlbiB2YWx1ZSBgTmFOYD8gKE5hTiBpcyB0aGUgb25seSBudW1iZXIgd2hpY2ggZG9lcyBub3QgZXF1YWwgaXRzZWxmKS4KICBfLmlzTmFOID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXy5pc051bWJlcihvYmopICYmIG9iaiAhPSArb2JqOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBib29sZWFuPwogIF8uaXNCb29sZWFuID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSB0cnVlIHx8IG9iaiA9PT0gZmFsc2UgfHwgdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0IEJvb2xlYW5dJzsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhbHVlIGVxdWFsIHRvIG51bGw/CiAgXy5pc051bGwgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IG51bGw7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YXJpYWJsZSB1bmRlZmluZWQ/CiAgXy5pc1VuZGVmaW5lZCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gdm9pZCAwOwogIH07CgogIC8vIFNob3J0Y3V0IGZ1bmN0aW9uIGZvciBjaGVja2luZyBpZiBhbiBvYmplY3QgaGFzIGEgZ2l2ZW4gcHJvcGVydHkgZGlyZWN0bHkKICAvLyBvbiBpdHNlbGYgKGluIG90aGVyIHdvcmRzLCBub3Qgb24gYSBwcm90b3R5cGUpLgogIF8uaGFzID0gZnVuY3Rpb24ob2JqLCBrZXkpIHsKICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KTsKICB9OwoKICAvLyBVdGlsaXR5IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJ1biBVbmRlcnNjb3JlLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBfYCB2YXJpYWJsZSB0byBpdHMKICAvLyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QuCiAgXy5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CiAgICByb290Ll8gPSBwcmV2aW91c1VuZGVyc2NvcmU7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBLZWVwIHRoZSBpZGVudGl0eSBmdW5jdGlvbiBhcm91bmQgZm9yIGRlZmF1bHQgaXRlcmF0b3JzLgogIF8uaWRlbnRpdHkgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlOwogIH07CgogIF8uY29uc3RhbnQgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfTsKICB9OwoKICBfLnByb3BlcnR5ID0gZnVuY3Rpb24oa2V5KSB7CiAgICByZXR1cm4gZnVuY3Rpb24ob2JqKSB7CiAgICAgIHJldHVybiBvYmpba2V5XTsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyBhIHByZWRpY2F0ZSBmb3IgY2hlY2tpbmcgd2hldGhlciBhbiBvYmplY3QgaGFzIGEgZ2l2ZW4gc2V0IG9mIGBrZXk6dmFsdWVgIHBhaXJzLgogIF8ubWF0Y2hlcyA9IGZ1bmN0aW9uKGF0dHJzKSB7CiAgICByZXR1cm4gZnVuY3Rpb24ob2JqKSB7CiAgICAgIGlmIChvYmogPT09IGF0dHJzKSByZXR1cm4gdHJ1ZTsgLy9hdm9pZCBjb21wYXJpbmcgYW4gb2JqZWN0IHRvIGl0c2VsZi4KICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgaWYgKGF0dHJzW2tleV0gIT09IG9ialtrZXldKQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH07CgogIC8vIFJ1biBhIGZ1bmN0aW9uICoqbioqIHRpbWVzLgogIF8udGltZXMgPSBmdW5jdGlvbihuLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIGFjY3VtID0gQXJyYXkoTWF0aC5tYXgoMCwgbikpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuOyBpKyspIGFjY3VtW2ldID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBpKTsKICAgIHJldHVybiBhY2N1bTsKICB9OwoKICAvLyBSZXR1cm4gYSByYW5kb20gaW50ZWdlciBiZXR3ZWVuIG1pbiBhbmQgbWF4IChpbmNsdXNpdmUpLgogIF8ucmFuZG9tID0gZnVuY3Rpb24obWluLCBtYXgpIHsKICAgIGlmIChtYXggPT0gbnVsbCkgewogICAgICBtYXggPSBtaW47CiAgICAgIG1pbiA9IDA7CiAgICB9CiAgICByZXR1cm4gbWluICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKG1heCAtIG1pbiArIDEpKTsKICB9OwoKICAvLyBBIChwb3NzaWJseSBmYXN0ZXIpIHdheSB0byBnZXQgdGhlIGN1cnJlbnQgdGltZXN0YW1wIGFzIGFuIGludGVnZXIuCiAgXy5ub3cgPSBEYXRlLm5vdyB8fCBmdW5jdGlvbigpIHsgcmV0dXJuIG5ldyBEYXRlKCkuZ2V0VGltZSgpOyB9OwoKICAvLyBMaXN0IG9mIEhUTUwgZW50aXRpZXMgZm9yIGVzY2FwaW5nLgogIHZhciBlbnRpdHlNYXAgPSB7CiAgICBlc2NhcGU6IHsKICAgICAgJyYnOiAnJmFtcDsnLAogICAgICAnPCc6ICcmbHQ7JywKICAgICAgJz4nOiAnJmd0OycsCiAgICAgICciJzogJyZxdW90OycsCiAgICAgICInIjogJyYjeDI3OycKICAgIH0KICB9OwogIGVudGl0eU1hcC51bmVzY2FwZSA9IF8uaW52ZXJ0KGVudGl0eU1hcC5lc2NhcGUpOwoKICAvLyBSZWdleGVzIGNvbnRhaW5pbmcgdGhlIGtleXMgYW5kIHZhbHVlcyBsaXN0ZWQgaW1tZWRpYXRlbHkgYWJvdmUuCiAgdmFyIGVudGl0eVJlZ2V4ZXMgPSB7CiAgICBlc2NhcGU6ICAgbmV3IFJlZ0V4cCgnWycgKyBfLmtleXMoZW50aXR5TWFwLmVzY2FwZSkuam9pbignJykgKyAnXScsICdnJyksCiAgICB1bmVzY2FwZTogbmV3IFJlZ0V4cCgnKCcgKyBfLmtleXMoZW50aXR5TWFwLnVuZXNjYXBlKS5qb2luKCd8JykgKyAnKScsICdnJykKICB9OwoKICAvLyBGdW5jdGlvbnMgZm9yIGVzY2FwaW5nIGFuZCB1bmVzY2FwaW5nIHN0cmluZ3MgdG8vZnJvbSBIVE1MIGludGVycG9sYXRpb24uCiAgXy5lYWNoKFsnZXNjYXBlJywgJ3VuZXNjYXBlJ10sIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgX1ttZXRob2RdID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgIGlmIChzdHJpbmcgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICByZXR1cm4gKCcnICsgc3RyaW5nKS5yZXBsYWNlKGVudGl0eVJlZ2V4ZXNbbWV0aG9kXSwgZnVuY3Rpb24obWF0Y2gpIHsKICAgICAgICByZXR1cm4gZW50aXR5TWFwW21ldGhvZF1bbWF0Y2hdOwogICAgICB9KTsKICAgIH07CiAgfSk7CgogIC8vIElmIHRoZSB2YWx1ZSBvZiB0aGUgbmFtZWQgYHByb3BlcnR5YCBpcyBhIGZ1bmN0aW9uIHRoZW4gaW52b2tlIGl0IHdpdGggdGhlCiAgLy8gYG9iamVjdGAgYXMgY29udGV4dDsgb3RoZXJ3aXNlLCByZXR1cm4gaXQuCiAgXy5yZXN1bHQgPSBmdW5jdGlvbihvYmplY3QsIHByb3BlcnR5KSB7CiAgICBpZiAob2JqZWN0ID09IG51bGwpIHJldHVybiB2b2lkIDA7CiAgICB2YXIgdmFsdWUgPSBvYmplY3RbcHJvcGVydHldOwogICAgcmV0dXJuIF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZS5jYWxsKG9iamVjdCkgOiB2YWx1ZTsKICB9OwoKICAvLyBBZGQgeW91ciBvd24gY3VzdG9tIGZ1bmN0aW9ucyB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QuCiAgXy5taXhpbiA9IGZ1bmN0aW9uKG9iaikgewogICAgZWFjaChfLmZ1bmN0aW9ucyhvYmopLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHZhciBmdW5jID0gX1tuYW1lXSA9IG9ialtuYW1lXTsKICAgICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYXJncyA9IFt0aGlzLl93cmFwcGVkXTsKICAgICAgICBwdXNoLmFwcGx5KGFyZ3MsIGFyZ3VtZW50cyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIGZ1bmMuYXBwbHkoXywgYXJncykpOwogICAgICB9OwogICAgfSk7CiAgfTsKCiAgLy8gR2VuZXJhdGUgYSB1bmlxdWUgaW50ZWdlciBpZCAodW5pcXVlIHdpdGhpbiB0aGUgZW50aXJlIGNsaWVudCBzZXNzaW9uKS4KICAvLyBVc2VmdWwgZm9yIHRlbXBvcmFyeSBET00gaWRzLgogIHZhciBpZENvdW50ZXIgPSAwOwogIF8udW5pcXVlSWQgPSBmdW5jdGlvbihwcmVmaXgpIHsKICAgIHZhciBpZCA9ICsraWRDb3VudGVyICsgJyc7CiAgICByZXR1cm4gcHJlZml4ID8gcHJlZml4ICsgaWQgOiBpZDsKICB9OwoKICAvLyBCeSBkZWZhdWx0LCBVbmRlcnNjb3JlIHVzZXMgRVJCLXN0eWxlIHRlbXBsYXRlIGRlbGltaXRlcnMsIGNoYW5nZSB0aGUKICAvLyBmb2xsb3dpbmcgdGVtcGxhdGUgc2V0dGluZ3MgdG8gdXNlIGFsdGVybmF0aXZlIGRlbGltaXRlcnMuCiAgXy50ZW1wbGF0ZVNldHRpbmdzID0gewogICAgZXZhbHVhdGUgICAgOiAvPCUoW1xzXFNdKz8pJT4vZywKICAgIGludGVycG9sYXRlIDogLzwlPShbXHNcU10rPyklPi9nLAogICAgZXNjYXBlICAgICAgOiAvPCUtKFtcc1xTXSs/KSU+L2cKICB9OwoKICAvLyBXaGVuIGN1c3RvbWl6aW5nIGB0ZW1wbGF0ZVNldHRpbmdzYCwgaWYgeW91IGRvbid0IHdhbnQgdG8gZGVmaW5lIGFuCiAgLy8gaW50ZXJwb2xhdGlvbiwgZXZhbHVhdGlvbiBvciBlc2NhcGluZyByZWdleCwgd2UgbmVlZCBvbmUgdGhhdCBpcwogIC8vIGd1YXJhbnRlZWQgbm90IHRvIG1hdGNoLgogIHZhciBub01hdGNoID0gLyguKV4vOwoKICAvLyBDZXJ0YWluIGNoYXJhY3RlcnMgbmVlZCB0byBiZSBlc2NhcGVkIHNvIHRoYXQgdGhleSBjYW4gYmUgcHV0IGludG8gYQogIC8vIHN0cmluZyBsaXRlcmFsLgogIHZhciBlc2NhcGVzID0gewogICAgIiciOiAgICAgICInIiwKICAgICdcXCc6ICAgICAnXFwnLAogICAgJ1xyJzogICAgICdyJywKICAgICdcbic6ICAgICAnbicsCiAgICAnXHQnOiAgICAgJ3QnLAogICAgJ1x1MjAyOCc6ICd1MjAyOCcsCiAgICAnXHUyMDI5JzogJ3UyMDI5JwogIH07CgogIHZhciBlc2NhcGVyID0gL1xcfCd8XHJ8XG58XHR8XHUyMDI4fFx1MjAyOS9nOwoKICAvLyBKYXZhU2NyaXB0IG1pY3JvLXRlbXBsYXRpbmcsIHNpbWlsYXIgdG8gSm9obiBSZXNpZydzIGltcGxlbWVudGF0aW9uLgogIC8vIFVuZGVyc2NvcmUgdGVtcGxhdGluZyBoYW5kbGVzIGFyYml0cmFyeSBkZWxpbWl0ZXJzLCBwcmVzZXJ2ZXMgd2hpdGVzcGFjZSwKICAvLyBhbmQgY29ycmVjdGx5IGVzY2FwZXMgcXVvdGVzIHdpdGhpbiBpbnRlcnBvbGF0ZWQgY29kZS4KICBfLnRlbXBsYXRlID0gZnVuY3Rpb24odGV4dCwgZGF0YSwgc2V0dGluZ3MpIHsKICAgIHZhciByZW5kZXI7CiAgICBzZXR0aW5ncyA9IF8uZGVmYXVsdHMoe30sIHNldHRpbmdzLCBfLnRlbXBsYXRlU2V0dGluZ3MpOwoKICAgIC8vIENvbWJpbmUgZGVsaW1pdGVycyBpbnRvIG9uZSByZWd1bGFyIGV4cHJlc3Npb24gdmlhIGFsdGVybmF0aW9uLgogICAgdmFyIG1hdGNoZXIgPSBuZXcgUmVnRXhwKFsKICAgICAgKHNldHRpbmdzLmVzY2FwZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5pbnRlcnBvbGF0ZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5ldmFsdWF0ZSB8fCBub01hdGNoKS5zb3VyY2UKICAgIF0uam9pbignfCcpICsgJ3wkJywgJ2cnKTsKCiAgICAvLyBDb21waWxlIHRoZSB0ZW1wbGF0ZSBzb3VyY2UsIGVzY2FwaW5nIHN0cmluZyBsaXRlcmFscyBhcHByb3ByaWF0ZWx5LgogICAgdmFyIGluZGV4ID0gMDsKICAgIHZhciBzb3VyY2UgPSAiX19wKz0nIjsKICAgIHRleHQucmVwbGFjZShtYXRjaGVyLCBmdW5jdGlvbihtYXRjaCwgZXNjYXBlLCBpbnRlcnBvbGF0ZSwgZXZhbHVhdGUsIG9mZnNldCkgewogICAgICBzb3VyY2UgKz0gdGV4dC5zbGljZShpbmRleCwgb2Zmc2V0KQogICAgICAgIC5yZXBsYWNlKGVzY2FwZXIsIGZ1bmN0aW9uKG1hdGNoKSB7IHJldHVybiAnXFwnICsgZXNjYXBlc1ttYXRjaF07IH0pOwoKICAgICAgaWYgKGVzY2FwZSkgewogICAgICAgIHNvdXJjZSArPSAiJytcbigoX190PSgiICsgZXNjYXBlICsgIikpPT1udWxsPycnOl8uZXNjYXBlKF9fdCkpK1xuJyI7CiAgICAgIH0KICAgICAgaWYgKGludGVycG9sYXRlKSB7CiAgICAgICAgc291cmNlICs9ICInK1xuKChfX3Q9KCIgKyBpbnRlcnBvbGF0ZSArICIpKT09bnVsbD8nJzpfX3QpK1xuJyI7CiAgICAgIH0KICAgICAgaWYgKGV2YWx1YXRlKSB7CiAgICAgICAgc291cmNlICs9ICInO1xuIiArIGV2YWx1YXRlICsgIlxuX19wKz0nIjsKICAgICAgfQogICAgICBpbmRleCA9IG9mZnNldCArIG1hdGNoLmxlbmd0aDsKICAgICAgcmV0dXJuIG1hdGNoOwogICAgfSk7CiAgICBzb3VyY2UgKz0gIic7XG4iOwoKICAgIC8vIElmIGEgdmFyaWFibGUgaXMgbm90IHNwZWNpZmllZCwgcGxhY2UgZGF0YSB2YWx1ZXMgaW4gbG9jYWwgc2NvcGUuCiAgICBpZiAoIXNldHRpbmdzLnZhcmlhYmxlKSBzb3VyY2UgPSAnd2l0aChvYmp8fHt9KXtcbicgKyBzb3VyY2UgKyAnfVxuJzsKCiAgICBzb3VyY2UgPSAidmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLCIgKwogICAgICAicHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTtcbiIgKwogICAgICBzb3VyY2UgKyAicmV0dXJuIF9fcDtcbiI7CgogICAgdHJ5IHsKICAgICAgcmVuZGVyID0gbmV3IEZ1bmN0aW9uKHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonLCAnXycsIHNvdXJjZSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGUuc291cmNlID0gc291cmNlOwogICAgICB0aHJvdyBlOwogICAgfQoKICAgIGlmIChkYXRhKSByZXR1cm4gcmVuZGVyKGRhdGEsIF8pOwogICAgdmFyIHRlbXBsYXRlID0gZnVuY3Rpb24oZGF0YSkgewogICAgICByZXR1cm4gcmVuZGVyLmNhbGwodGhpcywgZGF0YSwgXyk7CiAgICB9OwoKICAgIC8vIFByb3ZpZGUgdGhlIGNvbXBpbGVkIGZ1bmN0aW9uIHNvdXJjZSBhcyBhIGNvbnZlbmllbmNlIGZvciBwcmVjb21waWxhdGlvbi4KICAgIHRlbXBsYXRlLnNvdXJjZSA9ICdmdW5jdGlvbignICsgKHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonKSArICcpe1xuJyArIHNvdXJjZSArICd9JzsKCiAgICByZXR1cm4gdGVtcGxhdGU7CiAgfTsKCiAgLy8gQWRkIGEgImNoYWluIiBmdW5jdGlvbiwgd2hpY2ggd2lsbCBkZWxlZ2F0ZSB0byB0aGUgd3JhcHBlci4KICBfLmNoYWluID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXyhvYmopLmNoYWluKCk7CiAgfTsKCiAgLy8gT09QCiAgLy8gLS0tLS0tLS0tLS0tLS0tCiAgLy8gSWYgVW5kZXJzY29yZSBpcyBjYWxsZWQgYXMgYSBmdW5jdGlvbiwgaXQgcmV0dXJucyBhIHdyYXBwZWQgb2JqZWN0IHRoYXQKICAvLyBjYW4gYmUgdXNlZCBPTy1zdHlsZS4gVGhpcyB3cmFwcGVyIGhvbGRzIGFsdGVyZWQgdmVyc2lvbnMgb2YgYWxsIHRoZQogIC8vIHVuZGVyc2NvcmUgZnVuY3Rpb25zLiBXcmFwcGVkIG9iamVjdHMgbWF5IGJlIGNoYWluZWQuCgogIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb250aW51ZSBjaGFpbmluZyBpbnRlcm1lZGlhdGUgcmVzdWx0cy4KICB2YXIgcmVzdWx0ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gdGhpcy5fY2hhaW4gPyBfKG9iaikuY2hhaW4oKSA6IG9iajsKICB9OwoKICAvLyBBZGQgYWxsIG9mIHRoZSBVbmRlcnNjb3JlIGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlciBvYmplY3QuCiAgXy5taXhpbihfKTsKCiAgLy8gQWRkIGFsbCBtdXRhdG9yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KICBlYWNoKFsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0J10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIHZhciBtZXRob2QgPSBBcnJheVByb3RvW25hbWVdOwogICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIG9iaiA9IHRoaXMuX3dyYXBwZWQ7CiAgICAgIG1ldGhvZC5hcHBseShvYmosIGFyZ3VtZW50cyk7CiAgICAgIGlmICgobmFtZSA9PSAnc2hpZnQnIHx8IG5hbWUgPT0gJ3NwbGljZScpICYmIG9iai5sZW5ndGggPT09IDApIGRlbGV0ZSBvYmpbMF07CiAgICAgIHJldHVybiByZXN1bHQuY2FsbCh0aGlzLCBvYmopOwogICAgfTsKICB9KTsKCiAgLy8gQWRkIGFsbCBhY2Nlc3NvciBBcnJheSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIuCiAgZWFjaChbJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIHZhciBtZXRob2QgPSBBcnJheVByb3RvW25hbWVdOwogICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIG1ldGhvZC5hcHBseSh0aGlzLl93cmFwcGVkLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfSk7CgogIF8uZXh0ZW5kKF8ucHJvdG90eXBlLCB7CgogICAgLy8gU3RhcnQgY2hhaW5pbmcgYSB3cmFwcGVkIFVuZGVyc2NvcmUgb2JqZWN0LgogICAgY2hhaW46IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLl9jaGFpbiA9IHRydWU7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBFeHRyYWN0cyB0aGUgcmVzdWx0IGZyb20gYSB3cmFwcGVkIGFuZCBjaGFpbmVkIG9iamVjdC4KICAgIHZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuX3dyYXBwZWQ7CiAgICB9CgogIH0pOwoKICAvLyBBTUQgcmVnaXN0cmF0aW9uIGhhcHBlbnMgYXQgdGhlIGVuZCBmb3IgY29tcGF0aWJpbGl0eSB3aXRoIEFNRCBsb2FkZXJzCiAgLy8gdGhhdCBtYXkgbm90IGVuZm9yY2UgbmV4dC10dXJuIHNlbWFudGljcyBvbiBtb2R1bGVzLiBFdmVuIHRob3VnaCBnZW5lcmFsCiAgLy8gcHJhY3RpY2UgZm9yIEFNRCByZWdpc3RyYXRpb24gaXMgdG8gYmUgYW5vbnltb3VzLCB1bmRlcnNjb3JlIHJlZ2lzdGVycwogIC8vIGFzIGEgbmFtZWQgbW9kdWxlIGJlY2F1c2UsIGxpa2UgalF1ZXJ5LCBpdCBpcyBhIGJhc2UgbGlicmFyeSB0aGF0IGlzCiAgLy8gcG9wdWxhciBlbm91Z2ggdG8gYmUgYnVuZGxlZCBpbiBhIHRoaXJkIHBhcnR5IGxpYiwgYnV0IG5vdCBiZSBwYXJ0IG9mCiAgLy8gYW4gQU1EIGxvYWQgcmVxdWVzdC4gVGhvc2UgY2FzZXMgY291bGQgZ2VuZXJhdGUgYW4gZXJyb3Igd2hlbiBhbgogIC8vIGFub255bW91cyBkZWZpbmUoKSBpcyBjYWxsZWQgb3V0c2lkZSBvZiBhIGxvYWRlciByZXF1ZXN0LgogIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKICAgIGRlZmluZSgndW5kZXJzY29yZScsIFtdLCBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIF87CiAgICB9KTsKICB9Cn0pLmNhbGwodGhpcyk7CgovLyAgICAgQmFja2JvbmUuanMgMS4xLjIKCi8vICAgICAoYykgMjAxMC0yMDE0IEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZCBhbmQgSW52ZXN0aWdhdGl2ZSBSZXBvcnRlcnMgJiBFZGl0b3JzCi8vICAgICBCYWNrYm9uZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KLy8gICAgIEZvciBhbGwgZGV0YWlscyBhbmQgZG9jdW1lbnRhdGlvbjoKLy8gICAgIGh0dHA6Ly9iYWNrYm9uZWpzLm9yZwoKKGZ1bmN0aW9uKHJvb3QsIGZhY3RvcnkpIHsKCiAgLy8gU2V0IHVwIEJhY2tib25lIGFwcHJvcHJpYXRlbHkgZm9yIHRoZSBlbnZpcm9ubWVudC4gU3RhcnQgd2l0aCBBTUQuCiAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewogICAgZGVmaW5lKCdiYWNrYm9uZScsWyd1bmRlcnNjb3JlJywgJ2pxdWVyeScsICdleHBvcnRzJ10sIGZ1bmN0aW9uKF8sICQsIGV4cG9ydHMpIHsKICAgICAgLy8gRXhwb3J0IGdsb2JhbCBldmVuIGluIEFNRCBjYXNlIGluIGNhc2UgdGhpcyBzY3JpcHQgaXMgbG9hZGVkIHdpdGgKICAgICAgLy8gb3RoZXJzIHRoYXQgbWF5IHN0aWxsIGV4cGVjdCBhIGdsb2JhbCBCYWNrYm9uZS4KICAgICAgcm9vdC5CYWNrYm9uZSA9IGZhY3Rvcnkocm9vdCwgZXhwb3J0cywgXywgJCk7CiAgICB9KTsKCiAgLy8gTmV4dCBmb3IgTm9kZS5qcyBvciBDb21tb25KUy4galF1ZXJ5IG1heSBub3QgYmUgbmVlZGVkIGFzIGEgbW9kdWxlLgogIH0gZWxzZSBpZiAodHlwZW9mIGV4cG9ydHMgIT09ICd1bmRlZmluZWQnKSB7CiAgICB2YXIgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKTsKICAgIGZhY3Rvcnkocm9vdCwgZXhwb3J0cywgXyk7CgogIC8vIEZpbmFsbHksIGFzIGEgYnJvd3NlciBnbG9iYWwuCiAgfSBlbHNlIHsKICAgIHJvb3QuQmFja2JvbmUgPSBmYWN0b3J5KHJvb3QsIHt9LCByb290Ll8sIChyb290LmpRdWVyeSB8fCByb290LlplcHRvIHx8IHJvb3QuZW5kZXIgfHwgcm9vdC4kKSk7CiAgfQoKfSh0aGlzLCBmdW5jdGlvbihyb290LCBCYWNrYm9uZSwgXywgJCkgewoKICAvLyBJbml0aWFsIFNldHVwCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYEJhY2tib25lYCB2YXJpYWJsZSwgc28gdGhhdCBpdCBjYW4gYmUKICAvLyByZXN0b3JlZCBsYXRlciBvbiwgaWYgYG5vQ29uZmxpY3RgIGlzIHVzZWQuCiAgdmFyIHByZXZpb3VzQmFja2JvbmUgPSByb290LkJhY2tib25lOwoKICAvLyBDcmVhdGUgbG9jYWwgcmVmZXJlbmNlcyB0byBhcnJheSBtZXRob2RzIHdlJ2xsIHdhbnQgdG8gdXNlIGxhdGVyLgogIHZhciBhcnJheSA9IFtdOwogIHZhciBwdXNoID0gYXJyYXkucHVzaDsKICB2YXIgc2xpY2UgPSBhcnJheS5zbGljZTsKICB2YXIgc3BsaWNlID0gYXJyYXkuc3BsaWNlOwoKICAvLyBDdXJyZW50IHZlcnNpb24gb2YgdGhlIGxpYnJhcnkuIEtlZXAgaW4gc3luYyB3aXRoIGBwYWNrYWdlLmpzb25gLgogIEJhY2tib25lLlZFUlNJT04gPSAnMS4xLjInOwoKICAvLyBGb3IgQmFja2JvbmUncyBwdXJwb3NlcywgalF1ZXJ5LCBaZXB0bywgRW5kZXIsIG9yIE15IExpYnJhcnkgKGtpZGRpbmcpIG93bnMKICAvLyB0aGUgYCRgIHZhcmlhYmxlLgogIEJhY2tib25lLiQgPSAkOwoKICAvLyBSdW5zIEJhY2tib25lLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUKICAvLyB0byBpdHMgcHJldmlvdXMgb3duZXIuIFJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhpcyBCYWNrYm9uZSBvYmplY3QuCiAgQmFja2JvbmUubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewogICAgcm9vdC5CYWNrYm9uZSA9IHByZXZpb3VzQmFja2JvbmU7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBUdXJuIG9uIGBlbXVsYXRlSFRUUGAgdG8gc3VwcG9ydCBsZWdhY3kgSFRUUCBzZXJ2ZXJzLiBTZXR0aW5nIHRoaXMgb3B0aW9uCiAgLy8gd2lsbCBmYWtlIGAiUEFUQ0giYCwgYCJQVVQiYCBhbmQgYCJERUxFVEUiYCByZXF1ZXN0cyB2aWEgdGhlIGBfbWV0aG9kYCBwYXJhbWV0ZXIgYW5kCiAgLy8gc2V0IGEgYFgtSHR0cC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICBCYWNrYm9uZS5lbXVsYXRlSFRUUCA9IGZhbHNlOwoKICAvLyBUdXJuIG9uIGBlbXVsYXRlSlNPTmAgdG8gc3VwcG9ydCBsZWdhY3kgc2VydmVycyB0aGF0IGNhbid0IGRlYWwgd2l0aCBkaXJlY3QKICAvLyBgYXBwbGljYXRpb24vanNvbmAgcmVxdWVzdHMgLi4uIHdpbGwgZW5jb2RlIHRoZSBib2R5IGFzCiAgLy8gYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAgaW5zdGVhZCBhbmQgd2lsbCBzZW5kIHRoZSBtb2RlbCBpbiBhCiAgLy8gZm9ybSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIEJhY2tib25lLmVtdWxhdGVKU09OID0gZmFsc2U7CgogIC8vIEJhY2tib25lLkV2ZW50cwogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBBIG1vZHVsZSB0aGF0IGNhbiBiZSBtaXhlZCBpbiB0byAqYW55IG9iamVjdCogaW4gb3JkZXIgdG8gcHJvdmlkZSBpdCB3aXRoCiAgLy8gY3VzdG9tIGV2ZW50cy4gWW91IG1heSBiaW5kIHdpdGggYG9uYCBvciByZW1vdmUgd2l0aCBgb2ZmYCBjYWxsYmFjawogIC8vIGZ1bmN0aW9ucyB0byBhbiBldmVudDsgYHRyaWdnZXJgLWluZyBhbiBldmVudCBmaXJlcyBhbGwgY2FsbGJhY2tzIGluCiAgLy8gc3VjY2Vzc2lvbi4KICAvLwogIC8vICAgICB2YXIgb2JqZWN0ID0ge307CiAgLy8gICAgIF8uZXh0ZW5kKG9iamVjdCwgQmFja2JvbmUuRXZlbnRzKTsKICAvLyAgICAgb2JqZWN0Lm9uKCdleHBhbmQnLCBmdW5jdGlvbigpeyBhbGVydCgnZXhwYW5kZWQnKTsgfSk7CiAgLy8gICAgIG9iamVjdC50cmlnZ2VyKCdleHBhbmQnKTsKICAvLwogIHZhciBFdmVudHMgPSBCYWNrYm9uZS5FdmVudHMgPSB7CgogICAgLy8gQmluZCBhbiBldmVudCB0byBhIGBjYWxsYmFja2AgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQKICAgIC8vIHRoZSBjYWxsYmFjayB0byBhbGwgZXZlbnRzIGZpcmVkLgogICAgb246IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICdvbicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pIHx8ICFjYWxsYmFjaykgcmV0dXJuIHRoaXM7CiAgICAgIHRoaXMuX2V2ZW50cyB8fCAodGhpcy5fZXZlbnRzID0ge30pOwogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdIHx8ICh0aGlzLl9ldmVudHNbbmFtZV0gPSBbXSk7CiAgICAgIGV2ZW50cy5wdXNoKHtjYWxsYmFjazogY2FsbGJhY2ssIGNvbnRleHQ6IGNvbnRleHQsIGN0eDogY29udGV4dCB8fCB0aGlzfSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIG9ubHkgYmUgdHJpZ2dlcmVkIGEgc2luZ2xlIHRpbWUuIEFmdGVyIHRoZSBmaXJzdCB0aW1lCiAgICAvLyB0aGUgY2FsbGJhY2sgaXMgaW52b2tlZCwgaXQgd2lsbCBiZSByZW1vdmVkLgogICAgb25jZTogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ29uY2UnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSB8fCAhY2FsbGJhY2spIHJldHVybiB0aGlzOwogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBvbmNlID0gXy5vbmNlKGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGYub2ZmKG5hbWUsIG9uY2UpOwogICAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0pOwogICAgICBvbmNlLl9jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICByZXR1cm4gdGhpcy5vbihuYW1lLCBvbmNlLCBjb250ZXh0KTsKICAgIH0sCgogICAgLy8gUmVtb3ZlIG9uZSBvciBtYW55IGNhbGxiYWNrcy4gSWYgYGNvbnRleHRgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAvLyBjYWxsYmFja3Mgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAvLyBjYWxsYmFja3MgZm9yIHRoZSBldmVudC4gSWYgYG5hbWVgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kCiAgICAvLyBjYWxsYmFja3MgZm9yIGFsbCBldmVudHMuCiAgICBvZmY6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIHZhciByZXRhaW4sIGV2LCBldmVudHMsIG5hbWVzLCBpLCBsLCBqLCBrOwogICAgICBpZiAoIXRoaXMuX2V2ZW50cyB8fCAhZXZlbnRzQXBpKHRoaXMsICdvZmYnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSkgcmV0dXJuIHRoaXM7CiAgICAgIGlmICghbmFtZSAmJiAhY2FsbGJhY2sgJiYgIWNvbnRleHQpIHsKICAgICAgICB0aGlzLl9ldmVudHMgPSB2b2lkIDA7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgbmFtZXMgPSBuYW1lID8gW25hbWVdIDogXy5rZXlzKHRoaXMuX2V2ZW50cyk7CiAgICAgIGZvciAoaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBuYW1lID0gbmFtZXNbaV07CiAgICAgICAgaWYgKGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXSkgewogICAgICAgICAgdGhpcy5fZXZlbnRzW25hbWVdID0gcmV0YWluID0gW107CiAgICAgICAgICBpZiAoY2FsbGJhY2sgfHwgY29udGV4dCkgewogICAgICAgICAgICBmb3IgKGogPSAwLCBrID0gZXZlbnRzLmxlbmd0aDsgaiA8IGs7IGorKykgewogICAgICAgICAgICAgIGV2ID0gZXZlbnRzW2pdOwogICAgICAgICAgICAgIGlmICgoY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrICYmIGNhbGxiYWNrICE9PSBldi5jYWxsYmFjay5fY2FsbGJhY2spIHx8CiAgICAgICAgICAgICAgICAgIChjb250ZXh0ICYmIGNvbnRleHQgIT09IGV2LmNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICByZXRhaW4ucHVzaChldik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXJldGFpbi5sZW5ndGgpIGRlbGV0ZSB0aGlzLl9ldmVudHNbbmFtZV07CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAvLyBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQogICAgLy8gKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgLy8gcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgdHJpZ2dlcjogZnVuY3Rpb24obmFtZSkgewogICAgICBpZiAoIXRoaXMuX2V2ZW50cykgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAndHJpZ2dlcicsIG5hbWUsIGFyZ3MpKSByZXR1cm4gdGhpczsKICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgdmFyIGFsbEV2ZW50cyA9IHRoaXMuX2V2ZW50cy5hbGw7CiAgICAgIGlmIChldmVudHMpIHRyaWdnZXJFdmVudHMoZXZlbnRzLCBhcmdzKTsKICAgICAgaWYgKGFsbEV2ZW50cykgdHJpZ2dlckV2ZW50cyhhbGxFdmVudHMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBUZWxsIHRoaXMgb2JqZWN0IHRvIHN0b3AgbGlzdGVuaW5nIHRvIGVpdGhlciBzcGVjaWZpYyBldmVudHMgLi4uIG9yCiAgICAvLyB0byBldmVyeSBvYmplY3QgaXQncyBjdXJyZW50bHkgbGlzdGVuaW5nIHRvLgogICAgc3RvcExpc3RlbmluZzogZnVuY3Rpb24ob2JqLCBuYW1lLCBjYWxsYmFjaykgewogICAgICB2YXIgbGlzdGVuaW5nVG8gPSB0aGlzLl9saXN0ZW5pbmdUbzsKICAgICAgaWYgKCFsaXN0ZW5pbmdUbykgcmV0dXJuIHRoaXM7CiAgICAgIHZhciByZW1vdmUgPSAhbmFtZSAmJiAhY2FsbGJhY2s7CiAgICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSBjYWxsYmFjayA9IHRoaXM7CiAgICAgIGlmIChvYmopIChsaXN0ZW5pbmdUbyA9IHt9KVtvYmouX2xpc3RlbklkXSA9IG9iajsKICAgICAgZm9yICh2YXIgaWQgaW4gbGlzdGVuaW5nVG8pIHsKICAgICAgICBvYmogPSBsaXN0ZW5pbmdUb1tpZF07CiAgICAgICAgb2JqLm9mZihuYW1lLCBjYWxsYmFjaywgdGhpcyk7CiAgICAgICAgaWYgKHJlbW92ZSB8fCBfLmlzRW1wdHkob2JqLl9ldmVudHMpKSBkZWxldGUgdGhpcy5fbGlzdGVuaW5nVG9baWRdOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICB9OwoKICAvLyBSZWd1bGFyIGV4cHJlc3Npb24gdXNlZCB0byBzcGxpdCBldmVudCBzdHJpbmdzLgogIHZhciBldmVudFNwbGl0dGVyID0gL1xzKy87CgogIC8vIEltcGxlbWVudCBmYW5jeSBmZWF0dXJlcyBvZiB0aGUgRXZlbnRzIEFQSSBzdWNoIGFzIG11bHRpcGxlIGV2ZW50CiAgLy8gbmFtZXMgYCJjaGFuZ2UgYmx1ciJgIGFuZCBqUXVlcnktc3R5bGUgZXZlbnQgbWFwcyBge2NoYW5nZTogYWN0aW9ufWAKICAvLyBpbiB0ZXJtcyBvZiB0aGUgZXhpc3RpbmcgQVBJLgogIHZhciBldmVudHNBcGkgPSBmdW5jdGlvbihvYmosIGFjdGlvbiwgbmFtZSwgcmVzdCkgewogICAgaWYgKCFuYW1lKSByZXR1cm4gdHJ1ZTsKCiAgICAvLyBIYW5kbGUgZXZlbnQgbWFwcy4KICAgIGlmICh0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIHsKICAgICAgZm9yICh2YXIga2V5IGluIG5hbWUpIHsKICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtrZXksIG5hbWVba2V5XV0uY29uY2F0KHJlc3QpKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gSGFuZGxlIHNwYWNlIHNlcGFyYXRlZCBldmVudCBuYW1lcy4KICAgIGlmIChldmVudFNwbGl0dGVyLnRlc3QobmFtZSkpIHsKICAgICAgdmFyIG5hbWVzID0gbmFtZS5zcGxpdChldmVudFNwbGl0dGVyKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtuYW1lc1tpXV0uY29uY2F0KHJlc3QpKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgcmV0dXJuIHRydWU7CiAgfTsKCiAgLy8gQSBkaWZmaWN1bHQtdG8tYmVsaWV2ZSwgYnV0IG9wdGltaXplZCBpbnRlcm5hbCBkaXNwYXRjaCBmdW5jdGlvbiBmb3IKICAvLyB0cmlnZ2VyaW5nIGV2ZW50cy4gVHJpZXMgdG8ga2VlcCB0aGUgdXN1YWwgY2FzZXMgc3BlZWR5IChtb3N0IGludGVybmFsCiAgLy8gQmFja2JvbmUgZXZlbnRzIGhhdmUgMyBhcmd1bWVudHMpLgogIHZhciB0cmlnZ2VyRXZlbnRzID0gZnVuY3Rpb24oZXZlbnRzLCBhcmdzKSB7CiAgICB2YXIgZXYsIGkgPSAtMSwgbCA9IGV2ZW50cy5sZW5ndGgsIGExID0gYXJnc1swXSwgYTIgPSBhcmdzWzFdLCBhMyA9IGFyZ3NbMl07CiAgICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7CiAgICAgIGNhc2UgMDogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgpOyByZXR1cm47CiAgICAgIGNhc2UgMTogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExKTsgcmV0dXJuOwogICAgICBjYXNlIDI6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIpOyByZXR1cm47CiAgICAgIGNhc2UgMzogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExLCBhMiwgYTMpOyByZXR1cm47CiAgICAgIGRlZmF1bHQ6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmFwcGx5KGV2LmN0eCwgYXJncyk7IHJldHVybjsKICAgIH0KICB9OwoKICB2YXIgbGlzdGVuTWV0aG9kcyA9IHtsaXN0ZW5UbzogJ29uJywgbGlzdGVuVG9PbmNlOiAnb25jZSd9OwoKICAvLyBJbnZlcnNpb24tb2YtY29udHJvbCB2ZXJzaW9ucyBvZiBgb25gIGFuZCBgb25jZWAuIFRlbGwgKnRoaXMqIG9iamVjdCB0bwogIC8vIGxpc3RlbiB0byBhbiBldmVudCBpbiBhbm90aGVyIG9iamVjdCAuLi4ga2VlcGluZyB0cmFjayBvZiB3aGF0IGl0J3MKICAvLyBsaXN0ZW5pbmcgdG8uCiAgXy5lYWNoKGxpc3Rlbk1ldGhvZHMsIGZ1bmN0aW9uKGltcGxlbWVudGF0aW9uLCBtZXRob2QpIHsKICAgIEV2ZW50c1ttZXRob2RdID0gZnVuY3Rpb24ob2JqLCBuYW1lLCBjYWxsYmFjaykgewogICAgICB2YXIgbGlzdGVuaW5nVG8gPSB0aGlzLl9saXN0ZW5pbmdUbyB8fCAodGhpcy5fbGlzdGVuaW5nVG8gPSB7fSk7CiAgICAgIHZhciBpZCA9IG9iai5fbGlzdGVuSWQgfHwgKG9iai5fbGlzdGVuSWQgPSBfLnVuaXF1ZUlkKCdsJykpOwogICAgICBsaXN0ZW5pbmdUb1tpZF0gPSBvYmo7CiAgICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSBjYWxsYmFjayA9IHRoaXM7CiAgICAgIG9ialtpbXBsZW1lbnRhdGlvbl0obmFtZSwgY2FsbGJhY2ssIHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgfSk7CgogIC8vIEFsaWFzZXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgogIEV2ZW50cy5iaW5kICAgPSBFdmVudHMub247CiAgRXZlbnRzLnVuYmluZCA9IEV2ZW50cy5vZmY7CgogIC8vIEFsbG93IHRoZSBgQmFja2JvbmVgIG9iamVjdCB0byBzZXJ2ZSBhcyBhIGdsb2JhbCBldmVudCBidXMsIGZvciBmb2xrcyB3aG8KICAvLyB3YW50IGdsb2JhbCAicHVic3ViIiBpbiBhIGNvbnZlbmllbnQgcGxhY2UuCiAgXy5leHRlbmQoQmFja2JvbmUsIEV2ZW50cyk7CgogIC8vIEJhY2tib25lLk1vZGVsCiAgLy8gLS0tLS0tLS0tLS0tLS0KCiAgLy8gQmFja2JvbmUgKipNb2RlbHMqKiBhcmUgdGhlIGJhc2ljIGRhdGEgb2JqZWN0IGluIHRoZSBmcmFtZXdvcmsgLS0KICAvLyBmcmVxdWVudGx5IHJlcHJlc2VudGluZyBhIHJvdyBpbiBhIHRhYmxlIGluIGEgZGF0YWJhc2Ugb24geW91ciBzZXJ2ZXIuCiAgLy8gQSBkaXNjcmV0ZSBjaHVuayBvZiBkYXRhIGFuZCBhIGJ1bmNoIG9mIHVzZWZ1bCwgcmVsYXRlZCBtZXRob2RzIGZvcgogIC8vIHBlcmZvcm1pbmcgY29tcHV0YXRpb25zIGFuZCB0cmFuc2Zvcm1hdGlvbnMgb24gdGhhdCBkYXRhLgoKICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwgd2l0aCB0aGUgc3BlY2lmaWVkIGF0dHJpYnV0ZXMuIEEgY2xpZW50IGlkIChgY2lkYCkKICAvLyBpcyBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZCBhbmQgYXNzaWduZWQgZm9yIHlvdS4KICB2YXIgTW9kZWwgPSBCYWNrYm9uZS5Nb2RlbCA9IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIG9wdGlvbnMpIHsKICAgIHZhciBhdHRycyA9IGF0dHJpYnV0ZXMgfHwge307CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjJyk7CiAgICB0aGlzLmF0dHJpYnV0ZXMgPSB7fTsKICAgIGlmIChvcHRpb25zLmNvbGxlY3Rpb24pIHRoaXMuY29sbGVjdGlvbiA9IG9wdGlvbnMuY29sbGVjdGlvbjsKICAgIGlmIChvcHRpb25zLnBhcnNlKSBhdHRycyA9IHRoaXMucGFyc2UoYXR0cnMsIG9wdGlvbnMpIHx8IHt9OwogICAgYXR0cnMgPSBfLmRlZmF1bHRzKHt9LCBhdHRycywgXy5yZXN1bHQodGhpcywgJ2RlZmF1bHRzJykpOwogICAgdGhpcy5zZXQoYXR0cnMsIG9wdGlvbnMpOwogICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwoKICAvLyBBdHRhY2ggYWxsIGluaGVyaXRhYmxlIG1ldGhvZHMgdG8gdGhlIE1vZGVsIHByb3RvdHlwZS4KICBfLmV4dGVuZChNb2RlbC5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIEEgaGFzaCBvZiBhdHRyaWJ1dGVzIHdob3NlIGN1cnJlbnQgYW5kIHByZXZpb3VzIHZhbHVlIGRpZmZlci4KICAgIGNoYW5nZWQ6IG51bGwsCgogICAgLy8gVGhlIHZhbHVlIHJldHVybmVkIGR1cmluZyB0aGUgbGFzdCBmYWlsZWQgdmFsaWRhdGlvbi4KICAgIHZhbGlkYXRpb25FcnJvcjogbnVsbCwKCiAgICAvLyBUaGUgZGVmYXVsdCBuYW1lIGZvciB0aGUgSlNPTiBgaWRgIGF0dHJpYnV0ZSBpcyBgImlkImAuIE1vbmdvREIgYW5kCiAgICAvLyBDb3VjaERCIHVzZXJzIG1heSB3YW50IHRvIHNldCB0aGlzIHRvIGAiX2lkImAuCiAgICBpZEF0dHJpYnV0ZTogJ2lkJywKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG1vZGVsJ3MgYGF0dHJpYnV0ZXNgIG9iamVjdC4KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdCAtLSBidXQgb3ZlcnJpZGUgdGhpcyBpZiB5b3UgbmVlZAogICAgLy8gY3VzdG9tIHN5bmNpbmcgc2VtYW50aWNzIGZvciAqdGhpcyogcGFydGljdWxhciBtb2RlbC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGdldDogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIEhUTUwtZXNjYXBlZCB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCiAgICBlc2NhcGU6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uZXNjYXBlKHRoaXMuZ2V0KGF0dHIpKTsKICAgIH0sCgogICAgLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF0dHJpYnV0ZSBjb250YWlucyBhIHZhbHVlIHRoYXQgaXMgbm90IG51bGwKICAgIC8vIG9yIHVuZGVmaW5lZC4KICAgIGhhczogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5nZXQoYXR0cikgIT0gbnVsbDsKICAgIH0sCgogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzIG9uIHRoZSBvYmplY3QsIGZpcmluZyBgImNoYW5nZSJgLiBUaGlzIGlzCiAgICAvLyB0aGUgY29yZSBwcmltaXRpdmUgb3BlcmF0aW9uIG9mIGEgbW9kZWwsIHVwZGF0aW5nIHRoZSBkYXRhIGFuZCBub3RpZnlpbmcKICAgIC8vIGFueW9uZSB3aG8gbmVlZHMgdG8ga25vdyBhYm91dCB0aGUgY2hhbmdlIGluIHN0YXRlLiBUaGUgaGVhcnQgb2YgdGhlIGJlYXN0LgogICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgb3B0aW9ucykgewogICAgICB2YXIgYXR0ciwgYXR0cnMsIHVuc2V0LCBjaGFuZ2VzLCBzaWxlbnQsIGNoYW5naW5nLCBwcmV2LCBjdXJyZW50OwogICAgICBpZiAoa2V5ID09IG51bGwpIHJldHVybiB0aGlzOwoKICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCiAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewogICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgogICAgICAvLyBSdW4gdmFsaWRhdGlvbi4KICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKCiAgICAgIC8vIEV4dHJhY3QgYXR0cmlidXRlcyBhbmQgb3B0aW9ucy4KICAgICAgdW5zZXQgICAgICAgICAgID0gb3B0aW9ucy51bnNldDsKICAgICAgc2lsZW50ICAgICAgICAgID0gb3B0aW9ucy5zaWxlbnQ7CiAgICAgIGNoYW5nZXMgICAgICAgICA9IFtdOwogICAgICBjaGFuZ2luZyAgICAgICAgPSB0aGlzLl9jaGFuZ2luZzsKICAgICAgdGhpcy5fY2hhbmdpbmcgID0gdHJ1ZTsKCiAgICAgIGlmICghY2hhbmdpbmcpIHsKICAgICAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICAgIH0KICAgICAgY3VycmVudCA9IHRoaXMuYXR0cmlidXRlcywgcHJldiA9IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlczsKCiAgICAgIC8vIENoZWNrIGZvciBjaGFuZ2VzIG9mIGBpZGAuCiAgICAgIGlmICh0aGlzLmlkQXR0cmlidXRlIGluIGF0dHJzKSB0aGlzLmlkID0gYXR0cnNbdGhpcy5pZEF0dHJpYnV0ZV07CgogICAgICAvLyBGb3IgZWFjaCBgc2V0YCBhdHRyaWJ1dGUsIHVwZGF0ZSBvciBkZWxldGUgdGhlIGN1cnJlbnQgdmFsdWUuCiAgICAgIGZvciAoYXR0ciBpbiBhdHRycykgewogICAgICAgIHZhbCA9IGF0dHJzW2F0dHJdOwogICAgICAgIGlmICghXy5pc0VxdWFsKGN1cnJlbnRbYXR0cl0sIHZhbCkpIGNoYW5nZXMucHVzaChhdHRyKTsKICAgICAgICBpZiAoIV8uaXNFcXVhbChwcmV2W2F0dHJdLCB2YWwpKSB7CiAgICAgICAgICB0aGlzLmNoYW5nZWRbYXR0cl0gPSB2YWw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmNoYW5nZWRbYXR0cl07CiAgICAgICAgfQogICAgICAgIHVuc2V0ID8gZGVsZXRlIGN1cnJlbnRbYXR0cl0gOiBjdXJyZW50W2F0dHJdID0gdmFsOwogICAgICB9CgogICAgICAvLyBUcmlnZ2VyIGFsbCByZWxldmFudCBhdHRyaWJ1dGUgY2hhbmdlcy4KICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICBpZiAoY2hhbmdlcy5sZW5ndGgpIHRoaXMuX3BlbmRpbmcgPSBvcHRpb25zOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2hhbmdlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyBjaGFuZ2VzW2ldLCB0aGlzLCBjdXJyZW50W2NoYW5nZXNbaV1dLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFlvdSBtaWdodCBiZSB3b25kZXJpbmcgd2h5IHRoZXJlJ3MgYSBgd2hpbGVgIGxvb3AgaGVyZS4gQ2hhbmdlcyBjYW4KICAgICAgLy8gYmUgcmVjdXJzaXZlbHkgbmVzdGVkIHdpdGhpbiBgImNoYW5nZSJgIGV2ZW50cy4KICAgICAgaWYgKGNoYW5naW5nKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICB3aGlsZSAodGhpcy5fcGVuZGluZykgewogICAgICAgICAgb3B0aW9ucyA9IHRoaXMuX3BlbmRpbmc7CiAgICAgICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZScsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CiAgICAgIHRoaXMuX2NoYW5naW5nID0gZmFsc2U7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYW4gYXR0cmlidXRlIGZyb20gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYC4gYHVuc2V0YCBpcyBhIG5vb3AKICAgIC8vIGlmIHRoZSBhdHRyaWJ1dGUgZG9lc24ndCBleGlzdC4KICAgIHVuc2V0OiBmdW5jdGlvbihhdHRyLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLnNldChhdHRyLCB2b2lkIDAsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7CiAgICB9LAoKICAgIC8vIENsZWFyIGFsbCBhdHRyaWJ1dGVzIG9uIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAuCiAgICBjbGVhcjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgYXR0cnMgPSB7fTsKICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuYXR0cmlidXRlcykgYXR0cnNba2V5XSA9IHZvaWQgMDsKICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHJzLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3Vuc2V0OiB0cnVlfSkpOwogICAgfSwKCiAgICAvLyBEZXRlcm1pbmUgaWYgdGhlIG1vZGVsIGhhcyBjaGFuZ2VkIHNpbmNlIHRoZSBsYXN0IGAiY2hhbmdlImAgZXZlbnQuCiAgICAvLyBJZiB5b3Ugc3BlY2lmeSBhbiBhdHRyaWJ1dGUgbmFtZSwgZGV0ZXJtaW5lIGlmIHRoYXQgYXR0cmlidXRlIGhhcyBjaGFuZ2VkLgogICAgaGFzQ2hhbmdlZDogZnVuY3Rpb24oYXR0cikgewogICAgICBpZiAoYXR0ciA9PSBudWxsKSByZXR1cm4gIV8uaXNFbXB0eSh0aGlzLmNoYW5nZWQpOwogICAgICByZXR1cm4gXy5oYXModGhpcy5jaGFuZ2VkLCBhdHRyKTsKICAgIH0sCgogICAgLy8gUmV0dXJuIGFuIG9iamVjdCBjb250YWluaW5nIGFsbCB0aGUgYXR0cmlidXRlcyB0aGF0IGhhdmUgY2hhbmdlZCwgb3IKICAgIC8vIGZhbHNlIGlmIHRoZXJlIGFyZSBubyBjaGFuZ2VkIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3IgZGV0ZXJtaW5pbmcgd2hhdAogICAgLy8gcGFydHMgb2YgYSB2aWV3IG5lZWQgdG8gYmUgdXBkYXRlZCBhbmQvb3Igd2hhdCBhdHRyaWJ1dGVzIG5lZWQgdG8gYmUKICAgIC8vIHBlcnNpc3RlZCB0byB0aGUgc2VydmVyLiBVbnNldCBhdHRyaWJ1dGVzIHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgIC8vIFlvdSBjYW4gYWxzbyBwYXNzIGFuIGF0dHJpYnV0ZXMgb2JqZWN0IHRvIGRpZmYgYWdhaW5zdCB0aGUgbW9kZWwsCiAgICAvLyBkZXRlcm1pbmluZyBpZiB0aGVyZSAqd291bGQgYmUqIGEgY2hhbmdlLgogICAgY2hhbmdlZEF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGRpZmYpIHsKICAgICAgaWYgKCFkaWZmKSByZXR1cm4gdGhpcy5oYXNDaGFuZ2VkKCkgPyBfLmNsb25lKHRoaXMuY2hhbmdlZCkgOiBmYWxzZTsKICAgICAgdmFyIHZhbCwgY2hhbmdlZCA9IGZhbHNlOwogICAgICB2YXIgb2xkID0gdGhpcy5fY2hhbmdpbmcgPyB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgOiB0aGlzLmF0dHJpYnV0ZXM7CiAgICAgIGZvciAodmFyIGF0dHIgaW4gZGlmZikgewogICAgICAgIGlmIChfLmlzRXF1YWwob2xkW2F0dHJdLCAodmFsID0gZGlmZlthdHRyXSkpKSBjb250aW51ZTsKICAgICAgICAoY2hhbmdlZCB8fCAoY2hhbmdlZCA9IHt9KSlbYXR0cl0gPSB2YWw7CiAgICAgIH0KICAgICAgcmV0dXJuIGNoYW5nZWQ7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgcHJldmlvdXMgdmFsdWUgb2YgYW4gYXR0cmlidXRlLCByZWNvcmRlZCBhdCB0aGUgdGltZSB0aGUgbGFzdAogICAgLy8gYCJjaGFuZ2UiYCBldmVudCB3YXMgZmlyZWQuCiAgICBwcmV2aW91czogZnVuY3Rpb24oYXR0cikgewogICAgICBpZiAoYXR0ciA9PSBudWxsIHx8ICF0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpIHJldHVybiBudWxsOwogICAgICByZXR1cm4gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgYWxsIG9mIHRoZSBhdHRyaWJ1dGVzIG9mIHRoZSBtb2RlbCBhdCB0aGUgdGltZSBvZiB0aGUgcHJldmlvdXMKICAgIC8vIGAiY2hhbmdlImAgZXZlbnQuCiAgICBwcmV2aW91c0F0dHJpYnV0ZXM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBGZXRjaCB0aGUgbW9kZWwgZnJvbSB0aGUgc2VydmVyLiBJZiB0aGUgc2VydmVyJ3MgcmVwcmVzZW50YXRpb24gb2YgdGhlCiAgICAvLyBtb2RlbCBkaWZmZXJzIGZyb20gaXRzIGN1cnJlbnQgYXR0cmlidXRlcywgdGhleSB3aWxsIGJlIG92ZXJyaWRkZW4sCiAgICAvLyB0cmlnZ2VyaW5nIGEgYCJjaGFuZ2UiYCBldmVudC4KICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICBpZiAoIW1vZGVsLnNldChtb2RlbC5wYXJzZShyZXNwLCBvcHRpb25zKSwgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8vIFNldCBhIGhhc2ggb2YgbW9kZWwgYXR0cmlidXRlcywgYW5kIHN5bmMgdGhlIG1vZGVsIHRvIHRoZSBzZXJ2ZXIuCiAgICAvLyBJZiB0aGUgc2VydmVyIHJldHVybnMgYW4gYXR0cmlidXRlcyBoYXNoIHRoYXQgZGlmZmVycywgdGhlIG1vZGVsJ3MKICAgIC8vIHN0YXRlIHdpbGwgYmUgYHNldGAgYWdhaW4uCiAgICBzYXZlOiBmdW5jdGlvbihrZXksIHZhbCwgb3B0aW9ucykgewogICAgICB2YXIgYXR0cnMsIG1ldGhvZCwgeGhyLCBhdHRyaWJ1dGVzID0gdGhpcy5hdHRyaWJ1dGVzOwoKICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCiAgICAgIGlmIChrZXkgPT0gbnVsbCB8fCB0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewogICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7dmFsaWRhdGU6IHRydWV9LCBvcHRpb25zKTsKCiAgICAgIC8vIElmIHdlJ3JlIG5vdCB3YWl0aW5nIGFuZCBhdHRyaWJ1dGVzIGV4aXN0LCBzYXZlIGFjdHMgYXMKICAgICAgLy8gYHNldChhdHRyKS5zYXZlKG51bGwsIG9wdHMpYCB3aXRoIHZhbGlkYXRpb24uIE90aGVyd2lzZSwgY2hlY2sgaWYKICAgICAgLy8gdGhlIG1vZGVsIHdpbGwgYmUgdmFsaWQgd2hlbiB0aGUgYXR0cmlidXRlcywgaWYgYW55LCBhcmUgc2V0LgogICAgICBpZiAoYXR0cnMgJiYgIW9wdGlvbnMud2FpdCkgewogICAgICAgIGlmICghdGhpcy5zZXQoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgLy8gU2V0IHRlbXBvcmFyeSBhdHRyaWJ1dGVzIGlmIGB7d2FpdDogdHJ1ZX1gLgogICAgICBpZiAoYXR0cnMgJiYgb3B0aW9ucy53YWl0KSB7CiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzID0gXy5leHRlbmQoe30sIGF0dHJpYnV0ZXMsIGF0dHJzKTsKICAgICAgfQoKICAgICAgLy8gQWZ0ZXIgYSBzdWNjZXNzZnVsIHNlcnZlci1zaWRlIHNhdmUsIHRoZSBjbGllbnQgaXMgKG9wdGlvbmFsbHkpCiAgICAgIC8vIHVwZGF0ZWQgd2l0aCB0aGUgc2VydmVyLXNpZGUgc3RhdGUuCiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIC8vIEVuc3VyZSBhdHRyaWJ1dGVzIGFyZSByZXN0b3JlZCBkdXJpbmcgc3luY2hyb25vdXMgc2F2ZXMuCiAgICAgICAgbW9kZWwuYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXM7CiAgICAgICAgdmFyIHNlcnZlckF0dHJzID0gbW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkgc2VydmVyQXR0cnMgPSBfLmV4dGVuZChhdHRycyB8fCB7fSwgc2VydmVyQXR0cnMpOwogICAgICAgIGlmIChfLmlzT2JqZWN0KHNlcnZlckF0dHJzKSAmJiAhbW9kZWwuc2V0KHNlcnZlckF0dHJzLCBvcHRpb25zKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwoKICAgICAgbWV0aG9kID0gdGhpcy5pc05ldygpID8gJ2NyZWF0ZScgOiAob3B0aW9ucy5wYXRjaCA/ICdwYXRjaCcgOiAndXBkYXRlJyk7CiAgICAgIGlmIChtZXRob2QgPT09ICdwYXRjaCcpIG9wdGlvbnMuYXR0cnMgPSBhdHRyczsKICAgICAgeGhyID0gdGhpcy5zeW5jKG1ldGhvZCwgdGhpcywgb3B0aW9ucyk7CgogICAgICAvLyBSZXN0b3JlIGF0dHJpYnV0ZXMuCiAgICAgIGlmIChhdHRycyAmJiBvcHRpb25zLndhaXQpIHRoaXMuYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXM7CgogICAgICByZXR1cm4geGhyOwogICAgfSwKCiAgICAvLyBEZXN0cm95IHRoaXMgbW9kZWwgb24gdGhlIHNlcnZlciBpZiBpdCB3YXMgYWxyZWFkeSBwZXJzaXN0ZWQuCiAgICAvLyBPcHRpbWlzdGljYWxseSByZW1vdmVzIHRoZSBtb2RlbCBmcm9tIGl0cyBjb2xsZWN0aW9uLCBpZiBpdCBoYXMgb25lLgogICAgLy8gSWYgYHdhaXQ6IHRydWVgIGlzIHBhc3NlZCwgd2FpdHMgZm9yIHRoZSBzZXJ2ZXIgdG8gcmVzcG9uZCBiZWZvcmUgcmVtb3ZhbC4KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwoKICAgICAgdmFyIGRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdkZXN0cm95JywgbW9kZWwsIG1vZGVsLmNvbGxlY3Rpb24sIG9wdGlvbnMpOwogICAgICB9OwoKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIGlmIChvcHRpb25zLndhaXQgfHwgbW9kZWwuaXNOZXcoKSkgZGVzdHJveSgpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAoIW1vZGVsLmlzTmV3KCkpIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CgogICAgICBpZiAodGhpcy5pc05ldygpKSB7CiAgICAgICAgb3B0aW9ucy5zdWNjZXNzKCk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKCiAgICAgIHZhciB4aHIgPSB0aGlzLnN5bmMoJ2RlbGV0ZScsIHRoaXMsIG9wdGlvbnMpOwogICAgICBpZiAoIW9wdGlvbnMud2FpdCkgZGVzdHJveSgpOwogICAgICByZXR1cm4geGhyOwogICAgfSwKCiAgICAvLyBEZWZhdWx0IFVSTCBmb3IgdGhlIG1vZGVsJ3MgcmVwcmVzZW50YXRpb24gb24gdGhlIHNlcnZlciAtLSBpZiB5b3UncmUKICAgIC8vIHVzaW5nIEJhY2tib25lJ3MgcmVzdGZ1bCBtZXRob2RzLCBvdmVycmlkZSB0aGlzIHRvIGNoYW5nZSB0aGUgZW5kcG9pbnQKICAgIC8vIHRoYXQgd2lsbCBiZSBjYWxsZWQuCiAgICB1cmw6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYmFzZSA9CiAgICAgICAgXy5yZXN1bHQodGhpcywgJ3VybFJvb3QnKSB8fAogICAgICAgIF8ucmVzdWx0KHRoaXMuY29sbGVjdGlvbiwgJ3VybCcpIHx8CiAgICAgICAgdXJsRXJyb3IoKTsKICAgICAgaWYgKHRoaXMuaXNOZXcoKSkgcmV0dXJuIGJhc2U7CiAgICAgIHJldHVybiBiYXNlLnJlcGxhY2UoLyhbXlwvXSkkLywgJyQxLycpICsgZW5jb2RlVVJJQ29tcG9uZW50KHRoaXMuaWQpOwogICAgfSwKCiAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIHRoZSBoYXNoIG9mIGF0dHJpYnV0ZXMgdG8gYmUgYHNldGAgb24KICAgIC8vIHRoZSBtb2RlbC4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIHRoZSByZXNwb25zZSBhbG9uZy4KICAgIHBhcnNlOiBmdW5jdGlvbihyZXNwLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiByZXNwOwogICAgfSwKCiAgICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwgd2l0aCBpZGVudGljYWwgYXR0cmlidXRlcyB0byB0aGlzIG9uZS4KICAgIGNsb25lOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMuYXR0cmlidXRlcyk7CiAgICB9LAoKICAgIC8vIEEgbW9kZWwgaXMgbmV3IGlmIGl0IGhhcyBuZXZlciBiZWVuIHNhdmVkIHRvIHRoZSBzZXJ2ZXIsIGFuZCBsYWNrcyBhbiBpZC4KICAgIGlzTmV3OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICF0aGlzLmhhcyh0aGlzLmlkQXR0cmlidXRlKTsKICAgIH0sCgogICAgLy8gQ2hlY2sgaWYgdGhlIG1vZGVsIGlzIGN1cnJlbnRseSBpbiBhIHZhbGlkIHN0YXRlLgogICAgaXNWYWxpZDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5fdmFsaWRhdGUoe30sIF8uZXh0ZW5kKG9wdGlvbnMgfHwge30sIHsgdmFsaWRhdGU6IHRydWUgfSkpOwogICAgfSwKCiAgICAvLyBSdW4gdmFsaWRhdGlvbiBhZ2FpbnN0IHRoZSBuZXh0IGNvbXBsZXRlIHNldCBvZiBtb2RlbCBhdHRyaWJ1dGVzLAogICAgLy8gcmV0dXJuaW5nIGB0cnVlYCBpZiBhbGwgaXMgd2VsbC4gT3RoZXJ3aXNlLCBmaXJlIGFuIGAiaW52YWxpZCJgIGV2ZW50LgogICAgX3ZhbGlkYXRlOiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgewogICAgICBpZiAoIW9wdGlvbnMudmFsaWRhdGUgfHwgIXRoaXMudmFsaWRhdGUpIHJldHVybiB0cnVlOwogICAgICBhdHRycyA9IF8uZXh0ZW5kKHt9LCB0aGlzLmF0dHJpYnV0ZXMsIGF0dHJzKTsKICAgICAgdmFyIGVycm9yID0gdGhpcy52YWxpZGF0aW9uRXJyb3IgPSB0aGlzLnZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSB8fCBudWxsOwogICAgICBpZiAoIWVycm9yKSByZXR1cm4gdHJ1ZTsKICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgZXJyb3IsIF8uZXh0ZW5kKG9wdGlvbnMsIHt2YWxpZGF0aW9uRXJyb3I6IGVycm9yfSkpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogIH0pOwoKICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB3ZSB3YW50IHRvIGltcGxlbWVudCBvbiB0aGUgTW9kZWwuCiAgdmFyIG1vZGVsTWV0aG9kcyA9IFsna2V5cycsICd2YWx1ZXMnLCAncGFpcnMnLCAnaW52ZXJ0JywgJ3BpY2snLCAnb21pdCddOwoKICAvLyBNaXggaW4gZWFjaCBVbmRlcnNjb3JlIG1ldGhvZCBhcyBhIHByb3h5IHRvIGBNb2RlbCNhdHRyaWJ1dGVzYC4KICBfLmVhY2gobW9kZWxNZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIE1vZGVsLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBhcmdzLnVuc2hpZnQodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKICAgIH07CiAgfSk7CgogIC8vIEJhY2tib25lLkNvbGxlY3Rpb24KICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIElmIG1vZGVscyB0ZW5kIHRvIHJlcHJlc2VudCBhIHNpbmdsZSByb3cgb2YgZGF0YSwgYSBCYWNrYm9uZSBDb2xsZWN0aW9uIGlzCiAgLy8gbW9yZSBhbmFsYWdvdXMgdG8gYSB0YWJsZSBmdWxsIG9mIGRhdGEgLi4uIG9yIGEgc21hbGwgc2xpY2Ugb3IgcGFnZSBvZiB0aGF0CiAgLy8gdGFibGUsIG9yIGEgY29sbGVjdGlvbiBvZiByb3dzIHRoYXQgYmVsb25nIHRvZ2V0aGVyIGZvciBhIHBhcnRpY3VsYXIgcmVhc29uCiAgLy8gLS0gYWxsIG9mIHRoZSBtZXNzYWdlcyBpbiB0aGlzIHBhcnRpY3VsYXIgZm9sZGVyLCBhbGwgb2YgdGhlIGRvY3VtZW50cwogIC8vIGJlbG9uZ2luZyB0byB0aGlzIHBhcnRpY3VsYXIgYXV0aG9yLCBhbmQgc28gb24uIENvbGxlY3Rpb25zIG1haW50YWluCiAgLy8gaW5kZXhlcyBvZiB0aGVpciBtb2RlbHMsIGJvdGggaW4gb3JkZXIsIGFuZCBmb3IgbG9va3VwIGJ5IGBpZGAuCgogIC8vIENyZWF0ZSBhIG5ldyAqKkNvbGxlY3Rpb24qKiwgcGVyaGFwcyB0byBjb250YWluIGEgc3BlY2lmaWMgdHlwZSBvZiBgbW9kZWxgLgogIC8vIElmIGEgYGNvbXBhcmF0b3JgIGlzIHNwZWNpZmllZCwgdGhlIENvbGxlY3Rpb24gd2lsbCBtYWludGFpbgogIC8vIGl0cyBtb2RlbHMgaW4gc29ydCBvcmRlciwgYXMgdGhleSdyZSBhZGRlZCBhbmQgcmVtb3ZlZC4KICB2YXIgQ29sbGVjdGlvbiA9IEJhY2tib25lLkNvbGxlY3Rpb24gPSBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBpZiAob3B0aW9ucy5tb2RlbCkgdGhpcy5tb2RlbCA9IG9wdGlvbnMubW9kZWw7CiAgICBpZiAob3B0aW9ucy5jb21wYXJhdG9yICE9PSB2b2lkIDApIHRoaXMuY29tcGFyYXRvciA9IG9wdGlvbnMuY29tcGFyYXRvcjsKICAgIHRoaXMuX3Jlc2V0KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGlmIChtb2RlbHMpIHRoaXMucmVzZXQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwogIH07CgogIC8vIERlZmF1bHQgb3B0aW9ucyBmb3IgYENvbGxlY3Rpb24jc2V0YC4KICB2YXIgc2V0T3B0aW9ucyA9IHthZGQ6IHRydWUsIHJlbW92ZTogdHJ1ZSwgbWVyZ2U6IHRydWV9OwogIHZhciBhZGRPcHRpb25zID0ge2FkZDogdHJ1ZSwgcmVtb3ZlOiBmYWxzZX07CgogIC8vIERlZmluZSB0aGUgQ29sbGVjdGlvbidzIGluaGVyaXRhYmxlIG1ldGhvZHMuCiAgXy5leHRlbmQoQ29sbGVjdGlvbi5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIFRoZSBkZWZhdWx0IG1vZGVsIGZvciBhIGNvbGxlY3Rpb24gaXMganVzdCBhICoqQmFja2JvbmUuTW9kZWwqKi4KICAgIC8vIFRoaXMgc2hvdWxkIGJlIG92ZXJyaWRkZW4gaW4gbW9zdCBjYXNlcy4KICAgIG1vZGVsOiBNb2RlbCwKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIFRoZSBKU09OIHJlcHJlc2VudGF0aW9uIG9mIGEgQ29sbGVjdGlvbiBpcyBhbiBhcnJheSBvZiB0aGUKICAgIC8vIG1vZGVscycgYXR0cmlidXRlcy4KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24obW9kZWwpeyByZXR1cm4gbW9kZWwudG9KU09OKG9wdGlvbnMpOyB9KTsKICAgIH0sCgogICAgLy8gUHJveHkgYEJhY2tib25lLnN5bmNgIGJ5IGRlZmF1bHQuCiAgICBzeW5jOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIEJhY2tib25lLnN5bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwsIG9yIGxpc3Qgb2YgbW9kZWxzIHRvIHRoZSBzZXQuCiAgICBhZGQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5zZXQobW9kZWxzLCBfLmV4dGVuZCh7bWVyZ2U6IGZhbHNlfSwgb3B0aW9ucywgYWRkT3B0aW9ucykpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCwgb3IgYSBsaXN0IG9mIG1vZGVscyBmcm9tIHRoZSBzZXQuCiAgICByZW1vdmU6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICB2YXIgc2luZ3VsYXIgPSAhXy5pc0FycmF5KG1vZGVscyk7CiAgICAgIG1vZGVscyA9IHNpbmd1bGFyID8gW21vZGVsc10gOiBfLmNsb25lKG1vZGVscyk7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIHZhciBpLCBsLCBpbmRleCwgbW9kZWw7CiAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbW9kZWwgPSBtb2RlbHNbaV0gPSB0aGlzLmdldChtb2RlbHNbaV0pOwogICAgICAgIGlmICghbW9kZWwpIGNvbnRpbnVlOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmlkXTsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5jaWRdOwogICAgICAgIGluZGV4ID0gdGhpcy5pbmRleE9mKG1vZGVsKTsKICAgICAgICB0aGlzLm1vZGVscy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIHRoaXMubGVuZ3RoLS07CiAgICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgewogICAgICAgICAgb3B0aW9ucy5pbmRleCA9IGluZGV4OwogICAgICAgICAgbW9kZWwudHJpZ2dlcigncmVtb3ZlJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UobW9kZWwsIG9wdGlvbnMpOwogICAgICB9CiAgICAgIHJldHVybiBzaW5ndWxhciA/IG1vZGVsc1swXSA6IG1vZGVsczsKICAgIH0sCgogICAgLy8gVXBkYXRlIGEgY29sbGVjdGlvbiBieSBgc2V0YC1pbmcgYSBuZXcgbGlzdCBvZiBtb2RlbHMsIGFkZGluZyBuZXcgb25lcywKICAgIC8vIHJlbW92aW5nIG1vZGVscyB0aGF0IGFyZSBubyBsb25nZXIgcHJlc2VudCwgYW5kIG1lcmdpbmcgbW9kZWxzIHRoYXQKICAgIC8vIGFscmVhZHkgZXhpc3QgaW4gdGhlIGNvbGxlY3Rpb24sIGFzIG5lY2Vzc2FyeS4gU2ltaWxhciB0byAqKk1vZGVsI3NldCoqLAogICAgLy8gdGhlIGNvcmUgb3BlcmF0aW9uIGZvciB1cGRhdGluZyB0aGUgZGF0YSBjb250YWluZWQgYnkgdGhlIGNvbGxlY3Rpb24uCiAgICBzZXQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gXy5kZWZhdWx0cyh7fSwgb3B0aW9ucywgc2V0T3B0aW9ucyk7CiAgICAgIGlmIChvcHRpb25zLnBhcnNlKSBtb2RlbHMgPSB0aGlzLnBhcnNlKG1vZGVscywgb3B0aW9ucyk7CiAgICAgIHZhciBzaW5ndWxhciA9ICFfLmlzQXJyYXkobW9kZWxzKTsKICAgICAgbW9kZWxzID0gc2luZ3VsYXIgPyAobW9kZWxzID8gW21vZGVsc10gOiBbXSkgOiBfLmNsb25lKG1vZGVscyk7CiAgICAgIHZhciBpLCBsLCBpZCwgbW9kZWwsIGF0dHJzLCBleGlzdGluZywgc29ydDsKICAgICAgdmFyIGF0ID0gb3B0aW9ucy5hdDsKICAgICAgdmFyIHRhcmdldE1vZGVsID0gdGhpcy5tb2RlbDsKICAgICAgdmFyIHNvcnRhYmxlID0gdGhpcy5jb21wYXJhdG9yICYmIChhdCA9PSBudWxsKSAmJiBvcHRpb25zLnNvcnQgIT09IGZhbHNlOwogICAgICB2YXIgc29ydEF0dHIgPSBfLmlzU3RyaW5nKHRoaXMuY29tcGFyYXRvcikgPyB0aGlzLmNvbXBhcmF0b3IgOiBudWxsOwogICAgICB2YXIgdG9BZGQgPSBbXSwgdG9SZW1vdmUgPSBbXSwgbW9kZWxNYXAgPSB7fTsKICAgICAgdmFyIGFkZCA9IG9wdGlvbnMuYWRkLCBtZXJnZSA9IG9wdGlvbnMubWVyZ2UsIHJlbW92ZSA9IG9wdGlvbnMucmVtb3ZlOwogICAgICB2YXIgb3JkZXIgPSAhc29ydGFibGUgJiYgYWRkICYmIHJlbW92ZSA/IFtdIDogZmFsc2U7CgogICAgICAvLyBUdXJuIGJhcmUgb2JqZWN0cyBpbnRvIG1vZGVsIHJlZmVyZW5jZXMsIGFuZCBwcmV2ZW50IGludmFsaWQgbW9kZWxzCiAgICAgIC8vIGZyb20gYmVpbmcgYWRkZWQuCiAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgYXR0cnMgPSBtb2RlbHNbaV0gfHwge307CiAgICAgICAgaWYgKGF0dHJzIGluc3RhbmNlb2YgTW9kZWwpIHsKICAgICAgICAgIGlkID0gbW9kZWwgPSBhdHRyczsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWQgPSBhdHRyc1t0YXJnZXRNb2RlbC5wcm90b3R5cGUuaWRBdHRyaWJ1dGUgfHwgJ2lkJ107CiAgICAgICAgfQoKICAgICAgICAvLyBJZiBhIGR1cGxpY2F0ZSBpcyBmb3VuZCwgcHJldmVudCBpdCBmcm9tIGJlaW5nIGFkZGVkIGFuZAogICAgICAgIC8vIG9wdGlvbmFsbHkgbWVyZ2UgaXQgaW50byB0aGUgZXhpc3RpbmcgbW9kZWwuCiAgICAgICAgaWYgKGV4aXN0aW5nID0gdGhpcy5nZXQoaWQpKSB7CiAgICAgICAgICBpZiAocmVtb3ZlKSBtb2RlbE1hcFtleGlzdGluZy5jaWRdID0gdHJ1ZTsKICAgICAgICAgIGlmIChtZXJnZSkgewogICAgICAgICAgICBhdHRycyA9IGF0dHJzID09PSBtb2RlbCA/IG1vZGVsLmF0dHJpYnV0ZXMgOiBhdHRyczsKICAgICAgICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIGF0dHJzID0gZXhpc3RpbmcucGFyc2UoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICBleGlzdGluZy5zZXQoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoc29ydGFibGUgJiYgIXNvcnQgJiYgZXhpc3RpbmcuaGFzQ2hhbmdlZChzb3J0QXR0cikpIHNvcnQgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgbW9kZWxzW2ldID0gZXhpc3Rpbmc7CgogICAgICAgIC8vIElmIHRoaXMgaXMgYSBuZXcsIHZhbGlkIG1vZGVsLCBwdXNoIGl0IHRvIHRoZSBgdG9BZGRgIGxpc3QuCiAgICAgICAgfSBlbHNlIGlmIChhZGQpIHsKICAgICAgICAgIG1vZGVsID0gbW9kZWxzW2ldID0gdGhpcy5fcHJlcGFyZU1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgICAgIGlmICghbW9kZWwpIGNvbnRpbnVlOwogICAgICAgICAgdG9BZGQucHVzaChtb2RlbCk7CiAgICAgICAgICB0aGlzLl9hZGRSZWZlcmVuY2UobW9kZWwsIG9wdGlvbnMpOwogICAgICAgIH0KCiAgICAgICAgLy8gRG8gbm90IGFkZCBtdWx0aXBsZSBtb2RlbHMgd2l0aCB0aGUgc2FtZSBgaWRgLgogICAgICAgIG1vZGVsID0gZXhpc3RpbmcgfHwgbW9kZWw7CiAgICAgICAgaWYgKG9yZGVyICYmIChtb2RlbC5pc05ldygpIHx8ICFtb2RlbE1hcFttb2RlbC5pZF0pKSBvcmRlci5wdXNoKG1vZGVsKTsKICAgICAgICBtb2RlbE1hcFttb2RlbC5pZF0gPSB0cnVlOwogICAgICB9CgogICAgICAvLyBSZW1vdmUgbm9uZXhpc3RlbnQgbW9kZWxzIGlmIGFwcHJvcHJpYXRlLgogICAgICBpZiAocmVtb3ZlKSB7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgKytpKSB7CiAgICAgICAgICBpZiAoIW1vZGVsTWFwWyhtb2RlbCA9IHRoaXMubW9kZWxzW2ldKS5jaWRdKSB0b1JlbW92ZS5wdXNoKG1vZGVsKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRvUmVtb3ZlLmxlbmd0aCkgdGhpcy5yZW1vdmUodG9SZW1vdmUsIG9wdGlvbnMpOwogICAgICB9CgogICAgICAvLyBTZWUgaWYgc29ydGluZyBpcyBuZWVkZWQsIHVwZGF0ZSBgbGVuZ3RoYCBhbmQgc3BsaWNlIGluIG5ldyBtb2RlbHMuCiAgICAgIGlmICh0b0FkZC5sZW5ndGggfHwgKG9yZGVyICYmIG9yZGVyLmxlbmd0aCkpIHsKICAgICAgICBpZiAoc29ydGFibGUpIHNvcnQgPSB0cnVlOwogICAgICAgIHRoaXMubGVuZ3RoICs9IHRvQWRkLmxlbmd0aDsKICAgICAgICBpZiAoYXQgIT0gbnVsbCkgewogICAgICAgICAgZm9yIChpID0gMCwgbCA9IHRvQWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICB0aGlzLm1vZGVscy5zcGxpY2UoYXQgKyBpLCAwLCB0b0FkZFtpXSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChvcmRlcikgdGhpcy5tb2RlbHMubGVuZ3RoID0gMDsKICAgICAgICAgIHZhciBvcmRlcmVkTW9kZWxzID0gb3JkZXIgfHwgdG9BZGQ7CiAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gb3JkZXJlZE1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdGhpcy5tb2RlbHMucHVzaChvcmRlcmVkTW9kZWxzW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFNpbGVudGx5IHNvcnQgdGhlIGNvbGxlY3Rpb24gaWYgYXBwcm9wcmlhdGUuCiAgICAgIGlmIChzb3J0KSB0aGlzLnNvcnQoe3NpbGVudDogdHJ1ZX0pOwoKICAgICAgLy8gVW5sZXNzIHNpbGVuY2VkLCBpdCdzIHRpbWUgdG8gZmlyZSBhbGwgYXBwcm9wcmlhdGUgYWRkL3NvcnQgZXZlbnRzLgogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRvQWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgKG1vZGVsID0gdG9BZGRbaV0pLnRyaWdnZXIoJ2FkZCcsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNvcnQgfHwgKG9yZGVyICYmIG9yZGVyLmxlbmd0aCkpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICB9CgogICAgICAvLyBSZXR1cm4gdGhlIGFkZGVkIChvciBtZXJnZWQpIG1vZGVsIChvciBtb2RlbHMpLgogICAgICByZXR1cm4gc2luZ3VsYXIgPyBtb2RlbHNbMF0gOiBtb2RlbHM7CiAgICB9LAoKICAgIC8vIFdoZW4geW91IGhhdmUgbW9yZSBpdGVtcyB0aGFuIHlvdSB3YW50IHRvIGFkZCBvciByZW1vdmUgaW5kaXZpZHVhbGx5LAogICAgLy8geW91IGNhbiByZXNldCB0aGUgZW50aXJlIHNldCB3aXRoIGEgbmV3IGxpc3Qgb2YgbW9kZWxzLCB3aXRob3V0IGZpcmluZwogICAgLy8gYW55IGdyYW51bGFyIGBhZGRgIG9yIGByZW1vdmVgIGV2ZW50cy4gRmlyZXMgYHJlc2V0YCB3aGVuIGZpbmlzaGVkLgogICAgLy8gVXNlZnVsIGZvciBidWxrIG9wZXJhdGlvbnMgYW5kIG9wdGltaXphdGlvbnMuCiAgICByZXNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5tb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKHRoaXMubW9kZWxzW2ldLCBvcHRpb25zKTsKICAgICAgfQogICAgICBvcHRpb25zLnByZXZpb3VzTW9kZWxzID0gdGhpcy5tb2RlbHM7CiAgICAgIHRoaXMuX3Jlc2V0KCk7CiAgICAgIG1vZGVscyA9IHRoaXMuYWRkKG1vZGVscywgXy5leHRlbmQoe3NpbGVudDogdHJ1ZX0sIG9wdGlvbnMpKTsKICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgdGhpcy50cmlnZ2VyKCdyZXNldCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWxzOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgcHVzaDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuYWRkKG1vZGVsLCBfLmV4dGVuZCh7YXQ6IHRoaXMubGVuZ3RofSwgb3B0aW9ucykpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBwb3A6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCh0aGlzLmxlbmd0aCAtIDEpOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHVuc2hpZnQ6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoe2F0OiAwfSwgb3B0aW9ucykpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBzaGlmdDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KDApOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gU2xpY2Ugb3V0IGEgc3ViLWFycmF5IG9mIG1vZGVscyBmcm9tIHRoZSBjb2xsZWN0aW9uLgogICAgc2xpY2U6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gc2xpY2UuYXBwbHkodGhpcy5tb2RlbHMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8vIEdldCBhIG1vZGVsIGZyb20gdGhlIHNldCBieSBpZC4KICAgIGdldDogZnVuY3Rpb24ob2JqKSB7CiAgICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKICAgICAgcmV0dXJuIHRoaXMuX2J5SWRbb2JqXSB8fCB0aGlzLl9ieUlkW29iai5pZF0gfHwgdGhpcy5fYnlJZFtvYmouY2lkXTsKICAgIH0sCgogICAgLy8gR2V0IHRoZSBtb2RlbCBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICBhdDogZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kZWxzW2luZGV4XTsKICAgIH0sCgogICAgLy8gUmV0dXJuIG1vZGVscyB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzIG9mCiAgICAvLyBgZmlsdGVyYC4KICAgIHdoZXJlOiBmdW5jdGlvbihhdHRycywgZmlyc3QpIHsKICAgICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBmaXJzdCA/IHZvaWQgMCA6IFtdOwogICAgICByZXR1cm4gdGhpc1tmaXJzdCA/ICdmaW5kJyA6ICdmaWx0ZXInXShmdW5jdGlvbihtb2RlbCkgewogICAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewogICAgICAgICAgaWYgKGF0dHJzW2tleV0gIT09IG1vZGVsLmdldChrZXkpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9KTsKICAgIH0sCgogICAgLy8gUmV0dXJuIHRoZSBmaXJzdCBtb2RlbCB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzCiAgICAvLyBvZiBgZmluZGAuCiAgICBmaW5kV2hlcmU6IGZ1bmN0aW9uKGF0dHJzKSB7CiAgICAgIHJldHVybiB0aGlzLndoZXJlKGF0dHJzLCB0cnVlKTsKICAgIH0sCgogICAgLy8gRm9yY2UgdGhlIGNvbGxlY3Rpb24gdG8gcmUtc29ydCBpdHNlbGYuIFlvdSBkb24ndCBuZWVkIHRvIGNhbGwgdGhpcyB1bmRlcgogICAgLy8gbm9ybWFsIGNpcmN1bXN0YW5jZXMsIGFzIHRoZSBzZXQgd2lsbCBtYWludGFpbiBzb3J0IG9yZGVyIGFzIGVhY2ggaXRlbQogICAgLy8gaXMgYWRkZWQuCiAgICBzb3J0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmICghdGhpcy5jb21wYXJhdG9yKSB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBzb3J0IGEgc2V0IHdpdGhvdXQgYSBjb21wYXJhdG9yJyk7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgogICAgICAvLyBSdW4gc29ydCBiYXNlZCBvbiB0eXBlIG9mIGBjb21wYXJhdG9yYC4KICAgICAgaWYgKF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSB8fCB0aGlzLmNvbXBhcmF0b3IubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdGhpcy5tb2RlbHMgPSB0aGlzLnNvcnRCeSh0aGlzLmNvbXBhcmF0b3IsIHRoaXMpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMubW9kZWxzLnNvcnQoXy5iaW5kKHRoaXMuY29tcGFyYXRvciwgdGhpcykpOwogICAgICB9CgogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3NvcnQnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFBsdWNrIGFuIGF0dHJpYnV0ZSBmcm9tIGVhY2ggbW9kZWwgaW4gdGhlIGNvbGxlY3Rpb24uCiAgICBwbHVjazogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gXy5pbnZva2UodGhpcy5tb2RlbHMsICdnZXQnLCBhdHRyKTsKICAgIH0sCgogICAgLy8gRmV0Y2ggdGhlIGRlZmF1bHQgc2V0IG9mIG1vZGVscyBmb3IgdGhpcyBjb2xsZWN0aW9uLCByZXNldHRpbmcgdGhlCiAgICAvLyBjb2xsZWN0aW9uIHdoZW4gdGhleSBhcnJpdmUuIElmIGByZXNldDogdHJ1ZWAgaXMgcGFzc2VkLCB0aGUgcmVzcG9uc2UKICAgIC8vIGRhdGEgd2lsbCBiZSBwYXNzZWQgdGhyb3VnaCB0aGUgYHJlc2V0YCBtZXRob2QgaW5zdGVhZCBvZiBgc2V0YC4KICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIHZhciBtZXRob2QgPSBvcHRpb25zLnJlc2V0ID8gJ3Jlc2V0JyA6ICdzZXQnOwogICAgICAgIGNvbGxlY3Rpb25bbWV0aG9kXShyZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBjb2xsZWN0aW9uLnRyaWdnZXIoJ3N5bmMnLCBjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBhIG1vZGVsIGluIHRoaXMgY29sbGVjdGlvbi4gQWRkIHRoZSBtb2RlbCB0byB0aGUKICAgIC8vIGNvbGxlY3Rpb24gaW1tZWRpYXRlbHksIHVubGVzcyBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCBpbiB3aGljaCBjYXNlIHdlCiAgICAvLyB3YWl0IGZvciB0aGUgc2VydmVyIHRvIGFncmVlLgogICAgY3JlYXRlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKCEobW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpKSkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMud2FpdCkgdGhpcy5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihtb2RlbCwgcmVzcCkgewogICAgICAgIGlmIChvcHRpb25zLndhaXQpIGNvbGxlY3Rpb24uYWRkKG1vZGVsLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIG1vZGVsLnNhdmUobnVsbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byBhIGxpc3Qgb2YgbW9kZWxzIHRvIGJlIGFkZGVkIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbi4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIGl0IHRocm91Z2guCiAgICBwYXJzZTogZnVuY3Rpb24ocmVzcCwgb3B0aW9ucykgewogICAgICByZXR1cm4gcmVzcDsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGNvbGxlY3Rpb24gd2l0aCBhbiBpZGVudGljYWwgbGlzdCBvZiBtb2RlbHMgYXMgdGhpcyBvbmUuCiAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLm1vZGVscyk7CiAgICB9LAoKICAgIC8vIFByaXZhdGUgbWV0aG9kIHRvIHJlc2V0IGFsbCBpbnRlcm5hbCBzdGF0ZS4gQ2FsbGVkIHdoZW4gdGhlIGNvbGxlY3Rpb24KICAgIC8vIGlzIGZpcnN0IGluaXRpYWxpemVkIG9yIHJlc2V0LgogICAgX3Jlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5sZW5ndGggPSAwOwogICAgICB0aGlzLm1vZGVscyA9IFtdOwogICAgICB0aGlzLl9ieUlkICA9IHt9OwogICAgfSwKCiAgICAvLyBQcmVwYXJlIGEgaGFzaCBvZiBhdHRyaWJ1dGVzIChvciBvdGhlciBtb2RlbCkgdG8gYmUgYWRkZWQgdG8gdGhpcwogICAgLy8gY29sbGVjdGlvbi4KICAgIF9wcmVwYXJlTW9kZWw6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsKSByZXR1cm4gYXR0cnM7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBvcHRpb25zLmNvbGxlY3Rpb24gPSB0aGlzOwogICAgICB2YXIgbW9kZWwgPSBuZXcgdGhpcy5tb2RlbChhdHRycywgb3B0aW9ucyk7CiAgICAgIGlmICghbW9kZWwudmFsaWRhdGlvbkVycm9yKSByZXR1cm4gbW9kZWw7CiAgICAgIHRoaXMudHJpZ2dlcignaW52YWxpZCcsIHRoaXMsIG1vZGVsLnZhbGlkYXRpb25FcnJvciwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIGNyZWF0ZSBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uCiAgICBfYWRkUmVmZXJlbmNlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICB0aGlzLl9ieUlkW21vZGVsLmNpZF0gPSBtb2RlbDsKICAgICAgaWYgKG1vZGVsLmlkICE9IG51bGwpIHRoaXMuX2J5SWRbbW9kZWwuaWRdID0gbW9kZWw7CiAgICAgIGlmICghbW9kZWwuY29sbGVjdGlvbikgbW9kZWwuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIG1vZGVsLm9uKCdhbGwnLCB0aGlzLl9vbk1vZGVsRXZlbnQsIHRoaXMpOwogICAgfSwKCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2V2ZXIgYSBtb2RlbCdzIHRpZXMgdG8gYSBjb2xsZWN0aW9uLgogICAgX3JlbW92ZVJlZmVyZW5jZTogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgaWYgKHRoaXMgPT09IG1vZGVsLmNvbGxlY3Rpb24pIGRlbGV0ZSBtb2RlbC5jb2xsZWN0aW9uOwogICAgICBtb2RlbC5vZmYoJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCBjYWxsZWQgZXZlcnkgdGltZSBhIG1vZGVsIGluIHRoZSBzZXQgZmlyZXMgYW4gZXZlbnQuCiAgICAvLyBTZXRzIG5lZWQgdG8gdXBkYXRlIHRoZWlyIGluZGV4ZXMgd2hlbiBtb2RlbHMgY2hhbmdlIGlkcy4gQWxsIG90aGVyCiAgICAvLyBldmVudHMgc2ltcGx5IHByb3h5IHRocm91Z2guICJhZGQiIGFuZCAicmVtb3ZlIiBldmVudHMgdGhhdCBvcmlnaW5hdGUKICAgIC8vIGluIG90aGVyIGNvbGxlY3Rpb25zIGFyZSBpZ25vcmVkLgogICAgX29uTW9kZWxFdmVudDogZnVuY3Rpb24oZXZlbnQsIG1vZGVsLCBjb2xsZWN0aW9uLCBvcHRpb25zKSB7CiAgICAgIGlmICgoZXZlbnQgPT09ICdhZGQnIHx8IGV2ZW50ID09PSAncmVtb3ZlJykgJiYgY29sbGVjdGlvbiAhPT0gdGhpcykgcmV0dXJuOwogICAgICBpZiAoZXZlbnQgPT09ICdkZXN0cm95JykgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICBpZiAobW9kZWwgJiYgZXZlbnQgPT09ICdjaGFuZ2U6JyArIG1vZGVsLmlkQXR0cmlidXRlKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwucHJldmlvdXMobW9kZWwuaWRBdHRyaWJ1dGUpXTsKICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KCiAgfSk7CgogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHdlIHdhbnQgdG8gaW1wbGVtZW50IG9uIHRoZSBDb2xsZWN0aW9uLgogIC8vIDkwJSBvZiB0aGUgY29yZSB1c2VmdWxuZXNzIG9mIEJhY2tib25lIENvbGxlY3Rpb25zIGlzIGFjdHVhbGx5IGltcGxlbWVudGVkCiAgLy8gcmlnaHQgaGVyZToKICB2YXIgbWV0aG9kcyA9IFsnZm9yRWFjaCcsICdlYWNoJywgJ21hcCcsICdjb2xsZWN0JywgJ3JlZHVjZScsICdmb2xkbCcsCiAgICAnaW5qZWN0JywgJ3JlZHVjZVJpZ2h0JywgJ2ZvbGRyJywgJ2ZpbmQnLCAnZGV0ZWN0JywgJ2ZpbHRlcicsICdzZWxlY3QnLAogICAgJ3JlamVjdCcsICdldmVyeScsICdhbGwnLCAnc29tZScsICdhbnknLCAnaW5jbHVkZScsICdjb250YWlucycsICdpbnZva2UnLAogICAgJ21heCcsICdtaW4nLCAndG9BcnJheScsICdzaXplJywgJ2ZpcnN0JywgJ2hlYWQnLCAndGFrZScsICdpbml0aWFsJywgJ3Jlc3QnLAogICAgJ3RhaWwnLCAnZHJvcCcsICdsYXN0JywgJ3dpdGhvdXQnLCAnZGlmZmVyZW5jZScsICdpbmRleE9mJywgJ3NodWZmbGUnLAogICAgJ2xhc3RJbmRleE9mJywgJ2lzRW1wdHknLCAnY2hhaW4nLCAnc2FtcGxlJ107CgogIC8vIE1peCBpbiBlYWNoIFVuZGVyc2NvcmUgbWV0aG9kIGFzIGEgcHJveHkgdG8gYENvbGxlY3Rpb24jbW9kZWxzYC4KICBfLmVhY2gobWV0aG9kcywgZnVuY3Rpb24obWV0aG9kKSB7CiAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBhcmdzLnVuc2hpZnQodGhpcy5tb2RlbHMpOwogICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwogICAgfTsKICB9KTsKCiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgdGFrZSBhIHByb3BlcnR5IG5hbWUgYXMgYW4gYXJndW1lbnQuCiAgdmFyIGF0dHJpYnV0ZU1ldGhvZHMgPSBbJ2dyb3VwQnknLCAnY291bnRCeScsICdzb3J0QnknLCAnaW5kZXhCeSddOwoKICAvLyBVc2UgYXR0cmlidXRlcyBpbnN0ZWFkIG9mIHByb3BlcnRpZXMuCiAgXy5lYWNoKGF0dHJpYnV0ZU1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHZhciBpdGVyYXRvciA9IF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIG1vZGVsLmdldCh2YWx1ZSk7CiAgICAgIH07CiAgICAgIHJldHVybiBfW21ldGhvZF0odGhpcy5tb2RlbHMsIGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH07CiAgfSk7CgogIC8vIEJhY2tib25lLlZpZXcKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIEJhY2tib25lIFZpZXdzIGFyZSBhbG1vc3QgbW9yZSBjb252ZW50aW9uIHRoYW4gdGhleSBhcmUgYWN0dWFsIGNvZGUuIEEgVmlldwogIC8vIGlzIHNpbXBseSBhIEphdmFTY3JpcHQgb2JqZWN0IHRoYXQgcmVwcmVzZW50cyBhIGxvZ2ljYWwgY2h1bmsgb2YgVUkgaW4gdGhlCiAgLy8gRE9NLiBUaGlzIG1pZ2h0IGJlIGEgc2luZ2xlIGl0ZW0sIGFuIGVudGlyZSBsaXN0LCBhIHNpZGViYXIgb3IgcGFuZWwsIG9yCiAgLy8gZXZlbiB0aGUgc3Vycm91bmRpbmcgZnJhbWUgd2hpY2ggd3JhcHMgeW91ciB3aG9sZSBhcHAuIERlZmluaW5nIGEgY2h1bmsgb2YKICAvLyBVSSBhcyBhICoqVmlldyoqIGFsbG93cyB5b3UgdG8gZGVmaW5lIHlvdXIgRE9NIGV2ZW50cyBkZWNsYXJhdGl2ZWx5LCB3aXRob3V0CiAgLy8gaGF2aW5nIHRvIHdvcnJ5IGFib3V0IHJlbmRlciBvcmRlciAuLi4gYW5kIG1ha2VzIGl0IGVhc3kgZm9yIHRoZSB2aWV3IHRvCiAgLy8gcmVhY3QgdG8gc3BlY2lmaWMgY2hhbmdlcyBpbiB0aGUgc3RhdGUgb2YgeW91ciBtb2RlbHMuCgogIC8vIENyZWF0aW5nIGEgQmFja2JvbmUuVmlldyBjcmVhdGVzIGl0cyBpbml0aWFsIGVsZW1lbnQgb3V0c2lkZSBvZiB0aGUgRE9NLAogIC8vIGlmIGFuIGV4aXN0aW5nIGVsZW1lbnQgaXMgbm90IHByb3ZpZGVkLi4uCiAgdmFyIFZpZXcgPSBCYWNrYm9uZS5WaWV3ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCd2aWV3Jyk7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgXy5leHRlbmQodGhpcywgXy5waWNrKG9wdGlvbnMsIHZpZXdPcHRpb25zKSk7CiAgICB0aGlzLl9lbnN1cmVFbGVtZW50KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMuZGVsZWdhdGVFdmVudHMoKTsKICB9OwoKICAvLyBDYWNoZWQgcmVnZXggdG8gc3BsaXQga2V5cyBmb3IgYGRlbGVnYXRlYC4KICB2YXIgZGVsZWdhdGVFdmVudFNwbGl0dGVyID0gL14oXFMrKVxzKiguKikkLzsKCiAgLy8gTGlzdCBvZiB2aWV3IG9wdGlvbnMgdG8gYmUgbWVyZ2VkIGFzIHByb3BlcnRpZXMuCiAgdmFyIHZpZXdPcHRpb25zID0gWydtb2RlbCcsICdjb2xsZWN0aW9uJywgJ2VsJywgJ2lkJywgJ2F0dHJpYnV0ZXMnLCAnY2xhc3NOYW1lJywgJ3RhZ05hbWUnLCAnZXZlbnRzJ107CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5WaWV3KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChWaWV3LnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgYHRhZ05hbWVgIG9mIGEgVmlldydzIGVsZW1lbnQgaXMgYCJkaXYiYC4KICAgIHRhZ05hbWU6ICdkaXYnLAoKICAgIC8vIGpRdWVyeSBkZWxlZ2F0ZSBmb3IgZWxlbWVudCBsb29rdXAsIHNjb3BlZCB0byBET00gZWxlbWVudHMgd2l0aGluIHRoZQogICAgLy8gY3VycmVudCB2aWV3LiBUaGlzIHNob3VsZCBiZSBwcmVmZXJyZWQgdG8gZ2xvYmFsIGxvb2t1cHMgd2hlcmUgcG9zc2libGUuCiAgICAkOiBmdW5jdGlvbihzZWxlY3RvcikgewogICAgICByZXR1cm4gdGhpcy4kZWwuZmluZChzZWxlY3Rvcik7CiAgICB9LAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gKipyZW5kZXIqKiBpcyB0aGUgY29yZSBmdW5jdGlvbiB0aGF0IHlvdXIgdmlldyBzaG91bGQgb3ZlcnJpZGUsIGluIG9yZGVyCiAgICAvLyB0byBwb3B1bGF0ZSBpdHMgZWxlbWVudCAoYHRoaXMuZWxgKSwgd2l0aCB0aGUgYXBwcm9wcmlhdGUgSFRNTC4gVGhlCiAgICAvLyBjb252ZW50aW9uIGlzIGZvciAqKnJlbmRlcioqIHRvIGFsd2F5cyByZXR1cm4gYHRoaXNgLgogICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSB0aGlzIHZpZXcgYnkgdGFraW5nIHRoZSBlbGVtZW50IG91dCBvZiB0aGUgRE9NLCBhbmQgcmVtb3ZpbmcgYW55CiAgICAvLyBhcHBsaWNhYmxlIEJhY2tib25lLkV2ZW50cyBsaXN0ZW5lcnMuCiAgICByZW1vdmU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC5yZW1vdmUoKTsKICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBDaGFuZ2UgdGhlIHZpZXcncyBlbGVtZW50IChgdGhpcy5lbGAgcHJvcGVydHkpLCBpbmNsdWRpbmcgZXZlbnQKICAgIC8vIHJlLWRlbGVnYXRpb24uCiAgICBzZXRFbGVtZW50OiBmdW5jdGlvbihlbGVtZW50LCBkZWxlZ2F0ZSkgewogICAgICBpZiAodGhpcy4kZWwpIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICB0aGlzLiRlbCA9IGVsZW1lbnQgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gZWxlbWVudCA6IEJhY2tib25lLiQoZWxlbWVudCk7CiAgICAgIHRoaXMuZWwgPSB0aGlzLiRlbFswXTsKICAgICAgaWYgKGRlbGVnYXRlICE9PSBmYWxzZSkgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gU2V0IGNhbGxiYWNrcywgd2hlcmUgYHRoaXMuZXZlbnRzYCBpcyBhIGhhc2ggb2YKICAgIC8vCiAgICAvLyAqeyJldmVudCBzZWxlY3RvciI6ICJjYWxsYmFjayJ9KgogICAgLy8KICAgIC8vICAgICB7CiAgICAvLyAgICAgICAnbW91c2Vkb3duIC50aXRsZSc6ICAnZWRpdCcsCiAgICAvLyAgICAgICAnY2xpY2sgLmJ1dHRvbic6ICAgICAnc2F2ZScsCiAgICAvLyAgICAgICAnY2xpY2sgLm9wZW4nOiAgICAgICBmdW5jdGlvbihlKSB7IC4uLiB9CiAgICAvLyAgICAgfQogICAgLy8KICAgIC8vIHBhaXJzLiBDYWxsYmFja3Mgd2lsbCBiZSBib3VuZCB0byB0aGUgdmlldywgd2l0aCBgdGhpc2Agc2V0IHByb3Blcmx5LgogICAgLy8gVXNlcyBldmVudCBkZWxlZ2F0aW9uIGZvciBlZmZpY2llbmN5LgogICAgLy8gT21pdHRpbmcgdGhlIHNlbGVjdG9yIGJpbmRzIHRoZSBldmVudCB0byBgdGhpcy5lbGAuCiAgICAvLyBUaGlzIG9ubHkgd29ya3MgZm9yIGRlbGVnYXRlLWFibGUgZXZlbnRzOiBub3QgYGZvY3VzYCwgYGJsdXJgLCBhbmQKICAgIC8vIG5vdCBgY2hhbmdlYCwgYHN1Ym1pdGAsIGFuZCBgcmVzZXRgIGluIEludGVybmV0IEV4cGxvcmVyLgogICAgZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cykgewogICAgICBpZiAoIShldmVudHMgfHwgKGV2ZW50cyA9IF8ucmVzdWx0KHRoaXMsICdldmVudHMnKSkpKSByZXR1cm4gdGhpczsKICAgICAgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIGZvciAodmFyIGtleSBpbiBldmVudHMpIHsKICAgICAgICB2YXIgbWV0aG9kID0gZXZlbnRzW2tleV07CiAgICAgICAgaWYgKCFfLmlzRnVuY3Rpb24obWV0aG9kKSkgbWV0aG9kID0gdGhpc1tldmVudHNba2V5XV07CiAgICAgICAgaWYgKCFtZXRob2QpIGNvbnRpbnVlOwoKICAgICAgICB2YXIgbWF0Y2ggPSBrZXkubWF0Y2goZGVsZWdhdGVFdmVudFNwbGl0dGVyKTsKICAgICAgICB2YXIgZXZlbnROYW1lID0gbWF0Y2hbMV0sIHNlbGVjdG9yID0gbWF0Y2hbMl07CiAgICAgICAgbWV0aG9kID0gXy5iaW5kKG1ldGhvZCwgdGhpcyk7CiAgICAgICAgZXZlbnROYW1lICs9ICcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQ7CiAgICAgICAgaWYgKHNlbGVjdG9yID09PSAnJykgewogICAgICAgICAgdGhpcy4kZWwub24oZXZlbnROYW1lLCBtZXRob2QpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLiRlbC5vbihldmVudE5hbWUsIHNlbGVjdG9yLCBtZXRob2QpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gQ2xlYXJzIGFsbCBjYWxsYmFja3MgcHJldmlvdXNseSBib3VuZCB0byB0aGUgdmlldyB3aXRoIGBkZWxlZ2F0ZUV2ZW50c2AuCiAgICAvLyBZb3UgdXN1YWxseSBkb24ndCBuZWVkIHRvIHVzZSB0aGlzLCBidXQgbWF5IHdpc2ggdG8gaWYgeW91IGhhdmUgbXVsdGlwbGUKICAgIC8vIEJhY2tib25lIHZpZXdzIGF0dGFjaGVkIHRvIHRoZSBzYW1lIERPTSBlbGVtZW50LgogICAgdW5kZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLm9mZignLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEVuc3VyZSB0aGF0IHRoZSBWaWV3IGhhcyBhIERPTSBlbGVtZW50IHRvIHJlbmRlciBpbnRvLgogICAgLy8gSWYgYHRoaXMuZWxgIGlzIGEgc3RyaW5nLCBwYXNzIGl0IHRocm91Z2ggYCQoKWAsIHRha2UgdGhlIGZpcnN0CiAgICAvLyBtYXRjaGluZyBlbGVtZW50LCBhbmQgcmUtYXNzaWduIGl0IHRvIGBlbGAuIE90aGVyd2lzZSwgY3JlYXRlCiAgICAvLyBhbiBlbGVtZW50IGZyb20gdGhlIGBpZGAsIGBjbGFzc05hbWVgIGFuZCBgdGFnTmFtZWAgcHJvcGVydGllcy4KICAgIF9lbnN1cmVFbGVtZW50OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLmVsKSB7CiAgICAgICAgdmFyIGF0dHJzID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdhdHRyaWJ1dGVzJykpOwogICAgICAgIGlmICh0aGlzLmlkKSBhdHRycy5pZCA9IF8ucmVzdWx0KHRoaXMsICdpZCcpOwogICAgICAgIGlmICh0aGlzLmNsYXNzTmFtZSkgYXR0cnNbJ2NsYXNzJ10gPSBfLnJlc3VsdCh0aGlzLCAnY2xhc3NOYW1lJyk7CiAgICAgICAgdmFyICRlbCA9IEJhY2tib25lLiQoJzwnICsgXy5yZXN1bHQodGhpcywgJ3RhZ05hbWUnKSArICc+JykuYXR0cihhdHRycyk7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KCRlbCwgZmFsc2UpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc2V0RWxlbWVudChfLnJlc3VsdCh0aGlzLCAnZWwnKSwgZmFsc2UpOwogICAgICB9CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5zeW5jCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBPdmVycmlkZSB0aGlzIGZ1bmN0aW9uIHRvIGNoYW5nZSB0aGUgbWFubmVyIGluIHdoaWNoIEJhY2tib25lIHBlcnNpc3RzCiAgLy8gbW9kZWxzIHRvIHRoZSBzZXJ2ZXIuIFlvdSB3aWxsIGJlIHBhc3NlZCB0aGUgdHlwZSBvZiByZXF1ZXN0LCBhbmQgdGhlCiAgLy8gbW9kZWwgaW4gcXVlc3Rpb24uIEJ5IGRlZmF1bHQsIG1ha2VzIGEgUkVTVGZ1bCBBamF4IHJlcXVlc3QKICAvLyB0byB0aGUgbW9kZWwncyBgdXJsKClgLiBTb21lIHBvc3NpYmxlIGN1c3RvbWl6YXRpb25zIGNvdWxkIGJlOgogIC8vCiAgLy8gKiBVc2UgYHNldFRpbWVvdXRgIHRvIGJhdGNoIHJhcGlkLWZpcmUgdXBkYXRlcyBpbnRvIGEgc2luZ2xlIHJlcXVlc3QuCiAgLy8gKiBTZW5kIHVwIHRoZSBtb2RlbHMgYXMgWE1MIGluc3RlYWQgb2YgSlNPTi4KICAvLyAqIFBlcnNpc3QgbW9kZWxzIHZpYSBXZWJTb2NrZXRzIGluc3RlYWQgb2YgQWpheC4KICAvLwogIC8vIFR1cm4gb24gYEJhY2tib25lLmVtdWxhdGVIVFRQYCBpbiBvcmRlciB0byBzZW5kIGBQVVRgIGFuZCBgREVMRVRFYCByZXF1ZXN0cwogIC8vIGFzIGBQT1NUYCwgd2l0aCBhIGBfbWV0aG9kYCBwYXJhbWV0ZXIgY29udGFpbmluZyB0aGUgdHJ1ZSBIVFRQIG1ldGhvZCwKICAvLyBhcyB3ZWxsIGFzIGFsbCByZXF1ZXN0cyB3aXRoIHRoZSBib2R5IGFzIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgCiAgLy8gaW5zdGVhZCBvZiBgYXBwbGljYXRpb24vanNvbmAgd2l0aCB0aGUgbW9kZWwgaW4gYSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIC8vIFVzZWZ1bCB3aGVuIGludGVyZmFjaW5nIHdpdGggc2VydmVyLXNpZGUgbGFuZ3VhZ2VzIGxpa2UgKipQSFAqKiB0aGF0IG1ha2UKICAvLyBpdCBkaWZmaWN1bHQgdG8gcmVhZCB0aGUgYm9keSBvZiBgUFVUYCByZXF1ZXN0cy4KICBCYWNrYm9uZS5zeW5jID0gZnVuY3Rpb24obWV0aG9kLCBtb2RlbCwgb3B0aW9ucykgewogICAgdmFyIHR5cGUgPSBtZXRob2RNYXBbbWV0aG9kXTsKCiAgICAvLyBEZWZhdWx0IG9wdGlvbnMsIHVubGVzcyBzcGVjaWZpZWQuCiAgICBfLmRlZmF1bHRzKG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSksIHsKICAgICAgZW11bGF0ZUhUVFA6IEJhY2tib25lLmVtdWxhdGVIVFRQLAogICAgICBlbXVsYXRlSlNPTjogQmFja2JvbmUuZW11bGF0ZUpTT04KICAgIH0pOwoKICAgIC8vIERlZmF1bHQgSlNPTi1yZXF1ZXN0IG9wdGlvbnMuCiAgICB2YXIgcGFyYW1zID0ge3R5cGU6IHR5cGUsIGRhdGFUeXBlOiAnanNvbid9OwoKICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgYSBVUkwuCiAgICBpZiAoIW9wdGlvbnMudXJsKSB7CiAgICAgIHBhcmFtcy51cmwgPSBfLnJlc3VsdChtb2RlbCwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICB9CgogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSB0aGUgYXBwcm9wcmlhdGUgcmVxdWVzdCBkYXRhLgogICAgaWYgKG9wdGlvbnMuZGF0YSA9PSBudWxsICYmIG1vZGVsICYmIChtZXRob2QgPT09ICdjcmVhdGUnIHx8IG1ldGhvZCA9PT0gJ3VwZGF0ZScgfHwgbWV0aG9kID09PSAncGF0Y2gnKSkgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24vanNvbic7CiAgICAgIHBhcmFtcy5kYXRhID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucy5hdHRycyB8fCBtb2RlbC50b0pTT04ob3B0aW9ucykpOwogICAgfQoKICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEpTT04gYnkgZW5jb2RpbmcgdGhlIHJlcXVlc3QgaW50byBhbiBIVE1MLWZvcm0uCiAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJzsKICAgICAgcGFyYW1zLmRhdGEgPSBwYXJhbXMuZGF0YSA/IHttb2RlbDogcGFyYW1zLmRhdGF9IDoge307CiAgICB9CgogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSFRUUCBieSBtaW1pY2tpbmcgdGhlIEhUVFAgbWV0aG9kIHdpdGggYF9tZXRob2RgCiAgICAvLyBBbmQgYW4gYFgtSFRUUC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICAgIGlmIChvcHRpb25zLmVtdWxhdGVIVFRQICYmICh0eXBlID09PSAnUFVUJyB8fCB0eXBlID09PSAnREVMRVRFJyB8fCB0eXBlID09PSAnUEFUQ0gnKSkgewogICAgICBwYXJhbXMudHlwZSA9ICdQT1NUJzsKICAgICAgaWYgKG9wdGlvbnMuZW11bGF0ZUpTT04pIHBhcmFtcy5kYXRhLl9tZXRob2QgPSB0eXBlOwogICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgb3B0aW9ucy5iZWZvcmVTZW5kID0gZnVuY3Rpb24oeGhyKSB7CiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ1gtSFRUUC1NZXRob2QtT3ZlcnJpZGUnLCB0eXBlKTsKICAgICAgICBpZiAoYmVmb3JlU2VuZCkgcmV0dXJuIGJlZm9yZVNlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KCiAgICAvLyBEb24ndCBwcm9jZXNzIGRhdGEgb24gYSBub24tR0VUIHJlcXVlc3QuCiAgICBpZiAocGFyYW1zLnR5cGUgIT09ICdHRVQnICYmICFvcHRpb25zLmVtdWxhdGVKU09OKSB7CiAgICAgIHBhcmFtcy5wcm9jZXNzRGF0YSA9IGZhbHNlOwogICAgfQoKICAgIC8vIElmIHdlJ3JlIHNlbmRpbmcgYSBgUEFUQ0hgIHJlcXVlc3QsIGFuZCB3ZSdyZSBpbiBhbiBvbGQgSW50ZXJuZXQgRXhwbG9yZXIKICAgIC8vIHRoYXQgc3RpbGwgaGFzIEFjdGl2ZVggZW5hYmxlZCBieSBkZWZhdWx0LCBvdmVycmlkZSBqUXVlcnkgdG8gdXNlIHRoYXQKICAgIC8vIGZvciBYSFIgaW5zdGVhZC4gUmVtb3ZlIHRoaXMgbGluZSB3aGVuIGpRdWVyeSBzdXBwb3J0cyBgUEFUQ0hgIG9uIElFOC4KICAgIGlmIChwYXJhbXMudHlwZSA9PT0gJ1BBVENIJyAmJiBub1hoclBhdGNoKSB7CiAgICAgIHBhcmFtcy54aHIgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxIVFRQIik7CiAgICAgIH07CiAgICB9CgogICAgLy8gTWFrZSB0aGUgcmVxdWVzdCwgYWxsb3dpbmcgdGhlIHVzZXIgdG8gb3ZlcnJpZGUgYW55IEFqYXggb3B0aW9ucy4KICAgIHZhciB4aHIgPSBvcHRpb25zLnhociA9IEJhY2tib25lLmFqYXgoXy5leHRlbmQocGFyYW1zLCBvcHRpb25zKSk7CiAgICBtb2RlbC50cmlnZ2VyKCdyZXF1ZXN0JywgbW9kZWwsIHhociwgb3B0aW9ucyk7CiAgICByZXR1cm4geGhyOwogIH07CgogIHZhciBub1hoclBhdGNoID0KICAgIHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmICEhd2luZG93LkFjdGl2ZVhPYmplY3QgJiYKICAgICAgISh3aW5kb3cuWE1MSHR0cFJlcXVlc3QgJiYgKG5ldyBYTUxIdHRwUmVxdWVzdCkuZGlzcGF0Y2hFdmVudCk7CgogIC8vIE1hcCBmcm9tIENSVUQgdG8gSFRUUCBmb3Igb3VyIGRlZmF1bHQgYEJhY2tib25lLnN5bmNgIGltcGxlbWVudGF0aW9uLgogIHZhciBtZXRob2RNYXAgPSB7CiAgICAnY3JlYXRlJzogJ1BPU1QnLAogICAgJ3VwZGF0ZSc6ICdQVVQnLAogICAgJ3BhdGNoJzogICdQQVRDSCcsCiAgICAnZGVsZXRlJzogJ0RFTEVURScsCiAgICAncmVhZCc6ICAgJ0dFVCcKICB9OwoKICAvLyBTZXQgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgYEJhY2tib25lLmFqYXhgIHRvIHByb3h5IHRocm91Z2ggdG8gYCRgLgogIC8vIE92ZXJyaWRlIHRoaXMgaWYgeW91J2QgbGlrZSB0byB1c2UgYSBkaWZmZXJlbnQgbGlicmFyeS4KICBCYWNrYm9uZS5hamF4ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gQmFja2JvbmUuJC5hamF4LmFwcGx5KEJhY2tib25lLiQsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLy8gQmFja2JvbmUuUm91dGVyCiAgLy8gLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJvdXRlcnMgbWFwIGZhdXgtVVJMcyB0byBhY3Rpb25zLCBhbmQgZmlyZSBldmVudHMgd2hlbiByb3V0ZXMgYXJlCiAgLy8gbWF0Y2hlZC4gQ3JlYXRpbmcgYSBuZXcgb25lIHNldHMgaXRzIGByb3V0ZXNgIGhhc2gsIGlmIG5vdCBzZXQgc3RhdGljYWxseS4KICB2YXIgUm91dGVyID0gQmFja2JvbmUuUm91dGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIGlmIChvcHRpb25zLnJvdXRlcykgdGhpcy5yb3V0ZXMgPSBvcHRpb25zLnJvdXRlczsKICAgIHRoaXMuX2JpbmRSb3V0ZXMoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CgogIC8vIENhY2hlZCByZWd1bGFyIGV4cHJlc3Npb25zIGZvciBtYXRjaGluZyBuYW1lZCBwYXJhbSBwYXJ0cyBhbmQgc3BsYXR0ZWQKICAvLyBwYXJ0cyBvZiByb3V0ZSBzdHJpbmdzLgogIHZhciBvcHRpb25hbFBhcmFtID0gL1woKC4qPylcKS9nOwogIHZhciBuYW1lZFBhcmFtICAgID0gLyhcKFw/KT86XHcrL2c7CiAgdmFyIHNwbGF0UGFyYW0gICAgPSAvXCpcdysvZzsKICB2YXIgZXNjYXBlUmVnRXhwICA9IC9bXC17fVxbXF0rPy4sXFxcXiR8I1xzXS9nOwoKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuUm91dGVyKiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChSb3V0ZXIucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIE1hbnVhbGx5IGJpbmQgYSBzaW5nbGUgbmFtZWQgcm91dGUgdG8gYSBjYWxsYmFjay4gRm9yIGV4YW1wbGU6CiAgICAvLwogICAgLy8gICAgIHRoaXMucm91dGUoJ3NlYXJjaC86cXVlcnkvcDpudW0nLCAnc2VhcmNoJywgZnVuY3Rpb24ocXVlcnksIG51bSkgewogICAgLy8gICAgICAgLi4uCiAgICAvLyAgICAgfSk7CiAgICAvLwogICAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBuYW1lLCBjYWxsYmFjaykgewogICAgICBpZiAoIV8uaXNSZWdFeHAocm91dGUpKSByb3V0ZSA9IHRoaXMuX3JvdXRlVG9SZWdFeHAocm91dGUpOwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKG5hbWUpKSB7CiAgICAgICAgY2FsbGJhY2sgPSBuYW1lOwogICAgICAgIG5hbWUgPSAnJzsKICAgICAgfQogICAgICBpZiAoIWNhbGxiYWNrKSBjYWxsYmFjayA9IHRoaXNbbmFtZV07CiAgICAgIHZhciByb3V0ZXIgPSB0aGlzOwogICAgICBCYWNrYm9uZS5oaXN0b3J5LnJvdXRlKHJvdXRlLCBmdW5jdGlvbihmcmFnbWVudCkgewogICAgICAgIHZhciBhcmdzID0gcm91dGVyLl9leHRyYWN0UGFyYW1ldGVycyhyb3V0ZSwgZnJhZ21lbnQpOwogICAgICAgIHJvdXRlci5leGVjdXRlKGNhbGxiYWNrLCBhcmdzKTsKICAgICAgICByb3V0ZXIudHJpZ2dlci5hcHBseShyb3V0ZXIsIFsncm91dGU6JyArIG5hbWVdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgcm91dGVyLnRyaWdnZXIoJ3JvdXRlJywgbmFtZSwgYXJncyk7CiAgICAgICAgQmFja2JvbmUuaGlzdG9yeS50cmlnZ2VyKCdyb3V0ZScsIHJvdXRlciwgbmFtZSwgYXJncyk7CiAgICAgIH0pOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gRXhlY3V0ZSBhIHJvdXRlIGhhbmRsZXIgd2l0aCB0aGUgcHJvdmlkZWQgcGFyYW1ldGVycy4gIFRoaXMgaXMgYW4KICAgIC8vIGV4Y2VsbGVudCBwbGFjZSB0byBkbyBwcmUtcm91dGUgc2V0dXAgb3IgcG9zdC1yb3V0ZSBjbGVhbnVwLgogICAgZXhlY3V0ZTogZnVuY3Rpb24oY2FsbGJhY2ssIGFyZ3MpIHsKICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0sCgogICAgLy8gU2ltcGxlIHByb3h5IHRvIGBCYWNrYm9uZS5oaXN0b3J5YCB0byBzYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGlzdG9yeS4KICAgIG5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBCYWNrYm9uZS5oaXN0b3J5Lm5hdmlnYXRlKGZyYWdtZW50LCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEJpbmQgYWxsIGRlZmluZWQgcm91dGVzIHRvIGBCYWNrYm9uZS5oaXN0b3J5YC4gV2UgaGF2ZSB0byByZXZlcnNlIHRoZQogICAgLy8gb3JkZXIgb2YgdGhlIHJvdXRlcyBoZXJlIHRvIHN1cHBvcnQgYmVoYXZpb3Igd2hlcmUgdGhlIG1vc3QgZ2VuZXJhbAogICAgLy8gcm91dGVzIGNhbiBiZSBkZWZpbmVkIGF0IHRoZSBib3R0b20gb2YgdGhlIHJvdXRlIG1hcC4KICAgIF9iaW5kUm91dGVzOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLnJvdXRlcykgcmV0dXJuOwogICAgICB0aGlzLnJvdXRlcyA9IF8ucmVzdWx0KHRoaXMsICdyb3V0ZXMnKTsKICAgICAgdmFyIHJvdXRlLCByb3V0ZXMgPSBfLmtleXModGhpcy5yb3V0ZXMpOwogICAgICB3aGlsZSAoKHJvdXRlID0gcm91dGVzLnBvcCgpKSAhPSBudWxsKSB7CiAgICAgICAgdGhpcy5yb3V0ZShyb3V0ZSwgdGhpcy5yb3V0ZXNbcm91dGVdKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBDb252ZXJ0IGEgcm91dGUgc3RyaW5nIGludG8gYSByZWd1bGFyIGV4cHJlc3Npb24sIHN1aXRhYmxlIGZvciBtYXRjaGluZwogICAgLy8gYWdhaW5zdCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoLgogICAgX3JvdXRlVG9SZWdFeHA6IGZ1bmN0aW9uKHJvdXRlKSB7CiAgICAgIHJvdXRlID0gcm91dGUucmVwbGFjZShlc2NhcGVSZWdFeHAsICdcXCQmJykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG9wdGlvbmFsUGFyYW0sICcoPzokMSk/JykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG5hbWVkUGFyYW0sIGZ1bmN0aW9uKG1hdGNoLCBvcHRpb25hbCkgewogICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9uYWwgPyBtYXRjaCA6ICcoW14vP10rKSc7CiAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uoc3BsYXRQYXJhbSwgJyhbXj9dKj8pJyk7CiAgICAgIHJldHVybiBuZXcgUmVnRXhwKCdeJyArIHJvdXRlICsgJyg/OlxcPyhbXFxzXFxTXSopKT8kJyk7CiAgICB9LAoKICAgIC8vIEdpdmVuIGEgcm91dGUsIGFuZCBhIFVSTCBmcmFnbWVudCB0aGF0IGl0IG1hdGNoZXMsIHJldHVybiB0aGUgYXJyYXkgb2YKICAgIC8vIGV4dHJhY3RlZCBkZWNvZGVkIHBhcmFtZXRlcnMuIEVtcHR5IG9yIHVubWF0Y2hlZCBwYXJhbWV0ZXJzIHdpbGwgYmUKICAgIC8vIHRyZWF0ZWQgYXMgYG51bGxgIHRvIG5vcm1hbGl6ZSBjcm9zcy1icm93c2VyIGJlaGF2aW9yLgogICAgX2V4dHJhY3RQYXJhbWV0ZXJzOiBmdW5jdGlvbihyb3V0ZSwgZnJhZ21lbnQpIHsKICAgICAgdmFyIHBhcmFtcyA9IHJvdXRlLmV4ZWMoZnJhZ21lbnQpLnNsaWNlKDEpOwogICAgICByZXR1cm4gXy5tYXAocGFyYW1zLCBmdW5jdGlvbihwYXJhbSwgaSkgewogICAgICAgIC8vIERvbid0IGRlY29kZSB0aGUgc2VhcmNoIHBhcmFtcy4KICAgICAgICBpZiAoaSA9PT0gcGFyYW1zLmxlbmd0aCAtIDEpIHJldHVybiBwYXJhbSB8fCBudWxsOwogICAgICAgIHJldHVybiBwYXJhbSA/IGRlY29kZVVSSUNvbXBvbmVudChwYXJhbSkgOiBudWxsOwogICAgICB9KTsKICAgIH0KCiAgfSk7CgogIC8vIEJhY2tib25lLkhpc3RvcnkKICAvLyAtLS0tLS0tLS0tLS0tLS0tCgogIC8vIEhhbmRsZXMgY3Jvc3MtYnJvd3NlciBoaXN0b3J5IG1hbmFnZW1lbnQsIGJhc2VkIG9uIGVpdGhlcgogIC8vIFtwdXNoU3RhdGVdKGh0dHA6Ly9kaXZlaW50b2h0bWw1LmluZm8vaGlzdG9yeS5odG1sKSBhbmQgcmVhbCBVUkxzLCBvcgogIC8vIFtvbmhhc2hjaGFuZ2VdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvRE9NL3dpbmRvdy5vbmhhc2hjaGFuZ2UpCiAgLy8gYW5kIFVSTCBmcmFnbWVudHMuIElmIHRoZSBicm93c2VyIHN1cHBvcnRzIG5laXRoZXIgKG9sZCBJRSwgbmF0Y2gpLAogIC8vIGZhbGxzIGJhY2sgdG8gcG9sbGluZy4KICB2YXIgSGlzdG9yeSA9IEJhY2tib25lLkhpc3RvcnkgPSBmdW5jdGlvbigpIHsKICAgIHRoaXMuaGFuZGxlcnMgPSBbXTsKICAgIF8uYmluZEFsbCh0aGlzLCAnY2hlY2tVcmwnKTsKCiAgICAvLyBFbnN1cmUgdGhhdCBgSGlzdG9yeWAgY2FuIGJlIHVzZWQgb3V0c2lkZSBvZiB0aGUgYnJvd3Nlci4KICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgewogICAgICB0aGlzLmxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uOwogICAgICB0aGlzLmhpc3RvcnkgPSB3aW5kb3cuaGlzdG9yeTsKICAgIH0KICB9OwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBhIGxlYWRpbmcgaGFzaC9zbGFzaCBhbmQgdHJhaWxpbmcgc3BhY2UuCiAgdmFyIHJvdXRlU3RyaXBwZXIgPSAvXlsjXC9dfFxzKyQvZzsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgbGVhZGluZyBhbmQgdHJhaWxpbmcgc2xhc2hlcy4KICB2YXIgcm9vdFN0cmlwcGVyID0gL15cLyt8XC8rJC9nOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIGRldGVjdGluZyBNU0lFLgogIHZhciBpc0V4cGxvcmVyID0gL21zaWUgW1x3Ll0rLzsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciByZW1vdmluZyBhIHRyYWlsaW5nIHNsYXNoLgogIHZhciB0cmFpbGluZ1NsYXNoID0gL1wvJC87CgogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIHVybHMgb2YgaGFzaC4KICB2YXIgcGF0aFN0cmlwcGVyID0gLyMuKiQvOwoKICAvLyBIYXMgdGhlIGhpc3RvcnkgaGFuZGxpbmcgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQ/CiAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5IaXN0b3J5KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChIaXN0b3J5LnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgaW50ZXJ2YWwgdG8gcG9sbCBmb3IgaGFzaCBjaGFuZ2VzLCBpZiBuZWNlc3NhcnksIGlzCiAgICAvLyB0d2VudHkgdGltZXMgYSBzZWNvbmQuCiAgICBpbnRlcnZhbDogNTAsCgogICAgLy8gQXJlIHdlIGF0IHRoZSBhcHAgcm9vdD8KICAgIGF0Um9vdDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLnBhdGhuYW1lLnJlcGxhY2UoL1teXC9dJC8sICckJi8nKSA9PT0gdGhpcy5yb290OwogICAgfSwKCiAgICAvLyBHZXRzIHRoZSB0cnVlIGhhc2ggdmFsdWUuIENhbm5vdCB1c2UgbG9jYXRpb24uaGFzaCBkaXJlY3RseSBkdWUgdG8gYnVnCiAgICAvLyBpbiBGaXJlZm94IHdoZXJlIGxvY2F0aW9uLmhhc2ggd2lsbCBhbHdheXMgYmUgZGVjb2RlZC4KICAgIGdldEhhc2g6IGZ1bmN0aW9uKHdpbmRvdykgewogICAgICB2YXIgbWF0Y2ggPSAod2luZG93IHx8IHRoaXMpLmxvY2F0aW9uLmhyZWYubWF0Y2goLyMoLiopJC8pOwogICAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6ICcnOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIGNyb3NzLWJyb3dzZXIgbm9ybWFsaXplZCBVUkwgZnJhZ21lbnQsIGVpdGhlciBmcm9tIHRoZSBVUkwsCiAgICAvLyB0aGUgaGFzaCwgb3IgdGhlIG92ZXJyaWRlLgogICAgZ2V0RnJhZ21lbnQ6IGZ1bmN0aW9uKGZyYWdtZW50LCBmb3JjZVB1c2hTdGF0ZSkgewogICAgICBpZiAoZnJhZ21lbnQgPT0gbnVsbCkgewogICAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUgfHwgIXRoaXMuX3dhbnRzSGFzaENoYW5nZSB8fCBmb3JjZVB1c2hTdGF0ZSkgewogICAgICAgICAgZnJhZ21lbnQgPSBkZWNvZGVVUkkodGhpcy5sb2NhdGlvbi5wYXRobmFtZSArIHRoaXMubG9jYXRpb24uc2VhcmNoKTsKICAgICAgICAgIHZhciByb290ID0gdGhpcy5yb290LnJlcGxhY2UodHJhaWxpbmdTbGFzaCwgJycpOwogICAgICAgICAgaWYgKCFmcmFnbWVudC5pbmRleE9mKHJvb3QpKSBmcmFnbWVudCA9IGZyYWdtZW50LnNsaWNlKHJvb3QubGVuZ3RoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZyYWdtZW50LnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgfSwKCiAgICAvLyBTdGFydCB0aGUgaGFzaCBjaGFuZ2UgaGFuZGxpbmcsIHJldHVybmluZyBgdHJ1ZWAgaWYgdGhlIGN1cnJlbnQgVVJMIG1hdGNoZXMKICAgIC8vIGFuIGV4aXN0aW5nIHJvdXRlLCBhbmQgYGZhbHNlYCBvdGhlcndpc2UuCiAgICBzdGFydDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBpZiAoSGlzdG9yeS5zdGFydGVkKSB0aHJvdyBuZXcgRXJyb3IoIkJhY2tib25lLmhpc3RvcnkgaGFzIGFscmVhZHkgYmVlbiBzdGFydGVkIik7CiAgICAgIEhpc3Rvcnkuc3RhcnRlZCA9IHRydWU7CgogICAgICAvLyBGaWd1cmUgb3V0IHRoZSBpbml0aWFsIGNvbmZpZ3VyYXRpb24uIERvIHdlIG5lZWQgYW4gaWZyYW1lPwogICAgICAvLyBJcyBwdXNoU3RhdGUgZGVzaXJlZCAuLi4gaXMgaXQgYXZhaWxhYmxlPwogICAgICB0aGlzLm9wdGlvbnMgICAgICAgICAgPSBfLmV4dGVuZCh7cm9vdDogJy8nfSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsKICAgICAgdGhpcy5yb290ICAgICAgICAgICAgID0gdGhpcy5vcHRpb25zLnJvb3Q7CiAgICAgIHRoaXMuX3dhbnRzSGFzaENoYW5nZSA9IHRoaXMub3B0aW9ucy5oYXNoQ2hhbmdlICE9PSBmYWxzZTsKICAgICAgdGhpcy5fd2FudHNQdXNoU3RhdGUgID0gISF0aGlzLm9wdGlvbnMucHVzaFN0YXRlOwogICAgICB0aGlzLl9oYXNQdXNoU3RhdGUgICAgPSAhISh0aGlzLm9wdGlvbnMucHVzaFN0YXRlICYmIHRoaXMuaGlzdG9yeSAmJiB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKTsKICAgICAgdmFyIGZyYWdtZW50ICAgICAgICAgID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICB2YXIgZG9jTW9kZSAgICAgICAgICAgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgIHZhciBvbGRJRSAgICAgICAgICAgICA9IChpc0V4cGxvcmVyLmV4ZWMobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKSAmJiAoIWRvY01vZGUgfHwgZG9jTW9kZSA8PSA3KSk7CgogICAgICAvLyBOb3JtYWxpemUgcm9vdCB0byBhbHdheXMgaW5jbHVkZSBhIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoLgogICAgICB0aGlzLnJvb3QgPSAoJy8nICsgdGhpcy5yb290ICsgJy8nKS5yZXBsYWNlKHJvb3RTdHJpcHBlciwgJy8nKTsKCiAgICAgIGlmIChvbGRJRSAmJiB0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB2YXIgZnJhbWUgPSBCYWNrYm9uZS4kKCc8aWZyYW1lIHNyYz0iamF2YXNjcmlwdDowIiB0YWJpbmRleD0iLTEiPicpOwogICAgICAgIHRoaXMuaWZyYW1lID0gZnJhbWUuaGlkZSgpLmFwcGVuZFRvKCdib2R5JylbMF0uY29udGVudFdpbmRvdzsKICAgICAgICB0aGlzLm5hdmlnYXRlKGZyYWdtZW50KTsKICAgICAgfQoKICAgICAgLy8gRGVwZW5kaW5nIG9uIHdoZXRoZXIgd2UncmUgdXNpbmcgcHVzaFN0YXRlIG9yIGhhc2hlcywgYW5kIHdoZXRoZXIKICAgICAgLy8gJ29uaGFzaGNoYW5nZScgaXMgc3VwcG9ydGVkLCBkZXRlcm1pbmUgaG93IHdlIGNoZWNrIHRoZSBVUkwgc3RhdGUuCiAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKICAgICAgICBCYWNrYm9uZS4kKHdpbmRvdykub24oJ3BvcHN0YXRlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlICYmICgnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3cpICYmICFvbGRJRSkgewogICAgICAgIEJhY2tib25lLiQod2luZG93KS5vbignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLmNoZWNrVXJsLCB0aGlzLmludGVydmFsKTsKICAgICAgfQoKICAgICAgLy8gRGV0ZXJtaW5lIGlmIHdlIG5lZWQgdG8gY2hhbmdlIHRoZSBiYXNlIHVybCwgZm9yIGEgcHVzaFN0YXRlIGxpbmsKICAgICAgLy8gb3BlbmVkIGJ5IGEgbm9uLXB1c2hTdGF0ZSBicm93c2VyLgogICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CiAgICAgIHZhciBsb2MgPSB0aGlzLmxvY2F0aW9uOwoKICAgICAgLy8gVHJhbnNpdGlvbiBmcm9tIGhhc2hDaGFuZ2UgdG8gcHVzaFN0YXRlIG9yIHZpY2UgdmVyc2EgaWYgYm90aCBhcmUKICAgICAgLy8gcmVxdWVzdGVkLgogICAgICBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlICYmIHRoaXMuX3dhbnRzUHVzaFN0YXRlKSB7CgogICAgICAgIC8vIElmIHdlJ3ZlIHN0YXJ0ZWQgb2ZmIHdpdGggYSByb3V0ZSBmcm9tIGEgYHB1c2hTdGF0ZWAtZW5hYmxlZAogICAgICAgIC8vIGJyb3dzZXIsIGJ1dCB3ZSdyZSBjdXJyZW50bHkgaW4gYSBicm93c2VyIHRoYXQgZG9lc24ndCBzdXBwb3J0IGl0Li4uCiAgICAgICAgaWYgKCF0aGlzLl9oYXNQdXNoU3RhdGUgJiYgIXRoaXMuYXRSb290KCkpIHsKICAgICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KG51bGwsIHRydWUpOwogICAgICAgICAgdGhpcy5sb2NhdGlvbi5yZXBsYWNlKHRoaXMucm9vdCArICcjJyArIHRoaXMuZnJhZ21lbnQpOwogICAgICAgICAgLy8gUmV0dXJuIGltbWVkaWF0ZWx5IGFzIGJyb3dzZXIgd2lsbCBkbyByZWRpcmVjdCB0byBuZXcgdXJsCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICAgICAgLy8gT3IgaWYgd2UndmUgc3RhcnRlZCBvdXQgd2l0aCBhIGhhc2gtYmFzZWQgcm91dGUsIGJ1dCB3ZSdyZSBjdXJyZW50bHkKICAgICAgICAvLyBpbiBhIGJyb3dzZXIgd2hlcmUgaXQgY291bGQgYmUgYHB1c2hTdGF0ZWAtYmFzZWQgaW5zdGVhZC4uLgogICAgICAgIH0gZWxzZSBpZiAodGhpcy5faGFzUHVzaFN0YXRlICYmIHRoaXMuYXRSb290KCkgJiYgbG9jLmhhc2gpIHsKICAgICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKS5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsKICAgICAgICAgIHRoaXMuaGlzdG9yeS5yZXBsYWNlU3RhdGUoe30sIGRvY3VtZW50LnRpdGxlLCB0aGlzLnJvb3QgKyB0aGlzLmZyYWdtZW50KTsKICAgICAgICB9CgogICAgICB9CgogICAgICBpZiAoIXRoaXMub3B0aW9ucy5zaWxlbnQpIHJldHVybiB0aGlzLmxvYWRVcmwoKTsKICAgIH0sCgogICAgLy8gRGlzYWJsZSBCYWNrYm9uZS5oaXN0b3J5LCBwZXJoYXBzIHRlbXBvcmFyaWx5LiBOb3QgdXNlZnVsIGluIGEgcmVhbCBhcHAsCiAgICAvLyBidXQgcG9zc2libHkgdXNlZnVsIGZvciB1bml0IHRlc3RpbmcgUm91dGVycy4KICAgIHN0b3A6IGZ1bmN0aW9uKCkgewogICAgICBCYWNrYm9uZS4kKHdpbmRvdykub2ZmKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpLm9mZignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICBpZiAodGhpcy5fY2hlY2tVcmxJbnRlcnZhbCkgY2xlYXJJbnRlcnZhbCh0aGlzLl9jaGVja1VybEludGVydmFsKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CiAgICB9LAoKICAgIC8vIEFkZCBhIHJvdXRlIHRvIGJlIHRlc3RlZCB3aGVuIHRoZSBmcmFnbWVudCBjaGFuZ2VzLiBSb3V0ZXMgYWRkZWQgbGF0ZXIKICAgIC8vIG1heSBvdmVycmlkZSBwcmV2aW91cyByb3V0ZXMuCiAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuaGFuZGxlcnMudW5zaGlmdCh7cm91dGU6IHJvdXRlLCBjYWxsYmFjazogY2FsbGJhY2t9KTsKICAgIH0sCgogICAgLy8gQ2hlY2tzIHRoZSBjdXJyZW50IFVSTCB0byBzZWUgaWYgaXQgaGFzIGNoYW5nZWQsIGFuZCBpZiBpdCBoYXMsCiAgICAvLyBjYWxscyBgbG9hZFVybGAsIG5vcm1hbGl6aW5nIGFjcm9zcyB0aGUgaGlkZGVuIGlmcmFtZS4KICAgIGNoZWNrVXJsOiBmdW5jdGlvbihlKSB7CiAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICBpZiAoY3VycmVudCA9PT0gdGhpcy5mcmFnbWVudCAmJiB0aGlzLmlmcmFtZSkgewogICAgICAgIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpOwogICAgICB9CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50KSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICh0aGlzLmlmcmFtZSkgdGhpcy5uYXZpZ2F0ZShjdXJyZW50KTsKICAgICAgdGhpcy5sb2FkVXJsKCk7CiAgICB9LAoKICAgIC8vIEF0dGVtcHQgdG8gbG9hZCB0aGUgY3VycmVudCBVUkwgZnJhZ21lbnQuIElmIGEgcm91dGUgc3VjY2VlZHMgd2l0aCBhCiAgICAvLyBtYXRjaCwgcmV0dXJucyBgdHJ1ZWAuIElmIG5vIGRlZmluZWQgcm91dGVzIG1hdGNoZXMgdGhlIGZyYWdtZW50LAogICAgLy8gcmV0dXJucyBgZmFsc2VgLgogICAgbG9hZFVybDogZnVuY3Rpb24oZnJhZ21lbnQpIHsKICAgICAgZnJhZ21lbnQgPSB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudCk7CiAgICAgIHJldHVybiBfLmFueSh0aGlzLmhhbmRsZXJzLCBmdW5jdGlvbihoYW5kbGVyKSB7CiAgICAgICAgaWYgKGhhbmRsZXIucm91dGUudGVzdChmcmFnbWVudCkpIHsKICAgICAgICAgIGhhbmRsZXIuY2FsbGJhY2soZnJhZ21lbnQpOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCgogICAgLy8gU2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhhc2ggaGlzdG9yeSwgb3IgcmVwbGFjZSB0aGUgVVJMIHN0YXRlIGlmIHRoZQogICAgLy8gJ3JlcGxhY2UnIG9wdGlvbiBpcyBwYXNzZWQuIFlvdSBhcmUgcmVzcG9uc2libGUgZm9yIHByb3Blcmx5IFVSTC1lbmNvZGluZwogICAgLy8gdGhlIGZyYWdtZW50IGluIGFkdmFuY2UuCiAgICAvLwogICAgLy8gVGhlIG9wdGlvbnMgb2JqZWN0IGNhbiBjb250YWluIGB0cmlnZ2VyOiB0cnVlYCBpZiB5b3Ugd2lzaCB0byBoYXZlIHRoZQogICAgLy8gcm91dGUgY2FsbGJhY2sgYmUgZmlyZWQgKG5vdCB1c3VhbGx5IGRlc2lyYWJsZSksIG9yIGByZXBsYWNlOiB0cnVlYCwgaWYKICAgIC8vIHlvdSB3aXNoIHRvIG1vZGlmeSB0aGUgY3VycmVudCBVUkwgd2l0aG91dCBhZGRpbmcgYW4gZW50cnkgdG8gdGhlIGhpc3RvcnkuCiAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKICAgICAgaWYgKCFIaXN0b3J5LnN0YXJ0ZWQpIHJldHVybiBmYWxzZTsKICAgICAgaWYgKCFvcHRpb25zIHx8IG9wdGlvbnMgPT09IHRydWUpIG9wdGlvbnMgPSB7dHJpZ2dlcjogISFvcHRpb25zfTsKCiAgICAgIHZhciB1cmwgPSB0aGlzLnJvb3QgKyAoZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50IHx8ICcnKSk7CgogICAgICAvLyBTdHJpcCB0aGUgaGFzaCBmb3IgbWF0Y2hpbmcuCiAgICAgIGZyYWdtZW50ID0gZnJhZ21lbnQucmVwbGFjZShwYXRoU3RyaXBwZXIsICcnKTsKCiAgICAgIGlmICh0aGlzLmZyYWdtZW50ID09PSBmcmFnbWVudCkgcmV0dXJuOwogICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CgogICAgICAvLyBEb24ndCBpbmNsdWRlIGEgdHJhaWxpbmcgc2xhc2ggb24gdGhlIHJvb3QuCiAgICAgIGlmIChmcmFnbWVudCA9PT0gJycgJiYgdXJsICE9PSAnLycpIHVybCA9IHVybC5zbGljZSgwLCAtMSk7CgogICAgICAvLyBJZiBwdXNoU3RhdGUgaXMgYXZhaWxhYmxlLCB3ZSB1c2UgaXQgdG8gc2V0IHRoZSBmcmFnbWVudCBhcyBhIHJlYWwgVVJMLgogICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlKSB7CiAgICAgICAgdGhpcy5oaXN0b3J5W29wdGlvbnMucmVwbGFjZSA/ICdyZXBsYWNlU3RhdGUnIDogJ3B1c2hTdGF0ZSddKHt9LCBkb2N1bWVudC50aXRsZSwgdXJsKTsKCiAgICAgIC8vIElmIGhhc2ggY2hhbmdlcyBoYXZlbid0IGJlZW4gZXhwbGljaXRseSBkaXNhYmxlZCwgdXBkYXRlIHRoZSBoYXNoCiAgICAgIC8vIGZyYWdtZW50IHRvIHN0b3JlIGhpc3RvcnkuCiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICBpZiAodGhpcy5pZnJhbWUgJiYgKGZyYWdtZW50ICE9PSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpKSkgewogICAgICAgICAgLy8gT3BlbmluZyBhbmQgY2xvc2luZyB0aGUgaWZyYW1lIHRyaWNrcyBJRTcgYW5kIGVhcmxpZXIgdG8gcHVzaCBhCiAgICAgICAgICAvLyBoaXN0b3J5IGVudHJ5IG9uIGhhc2gtdGFnIGNoYW5nZS4gIFdoZW4gcmVwbGFjZSBpcyB0cnVlLCB3ZSBkb24ndAogICAgICAgICAgLy8gd2FudCB0aGlzLgogICAgICAgICAgaWYoIW9wdGlvbnMucmVwbGFjZSkgdGhpcy5pZnJhbWUuZG9jdW1lbnQub3BlbigpLmNsb3NlKCk7CiAgICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMuaWZyYW1lLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICB9CgogICAgICAvLyBJZiB5b3UndmUgdG9sZCB1cyB0aGF0IHlvdSBleHBsaWNpdGx5IGRvbid0IHdhbnQgZmFsbGJhY2sgaGFzaGNoYW5nZS0KICAgICAgLy8gYmFzZWQgaGlzdG9yeSwgdGhlbiBgbmF2aWdhdGVgIGJlY29tZXMgYSBwYWdlIHJlZnJlc2guCiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMubG9jYXRpb24uYXNzaWduKHVybCk7CiAgICAgIH0KICAgICAgaWYgKG9wdGlvbnMudHJpZ2dlcikgcmV0dXJuIHRoaXMubG9hZFVybChmcmFnbWVudCk7CiAgICB9LAoKICAgIC8vIFVwZGF0ZSB0aGUgaGFzaCBsb2NhdGlvbiwgZWl0aGVyIHJlcGxhY2luZyB0aGUgY3VycmVudCBlbnRyeSwgb3IgYWRkaW5nCiAgICAvLyBhIG5ldyBvbmUgdG8gdGhlIGJyb3dzZXIgaGlzdG9yeS4KICAgIF91cGRhdGVIYXNoOiBmdW5jdGlvbihsb2NhdGlvbiwgZnJhZ21lbnQsIHJlcGxhY2UpIHsKICAgICAgaWYgKHJlcGxhY2UpIHsKICAgICAgICB2YXIgaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvKGphdmFzY3JpcHQ6fCMpLiokLywgJycpOwogICAgICAgIGxvY2F0aW9uLnJlcGxhY2UoaHJlZiArICcjJyArIGZyYWdtZW50KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBTb21lIGJyb3dzZXJzIHJlcXVpcmUgdGhhdCBgaGFzaGAgY29udGFpbnMgYSBsZWFkaW5nICMuCiAgICAgICAgbG9jYXRpb24uaGFzaCA9ICcjJyArIGZyYWdtZW50OwogICAgICB9CiAgICB9CgogIH0pOwoKICAvLyBDcmVhdGUgdGhlIGRlZmF1bHQgQmFja2JvbmUuaGlzdG9yeS4KICBCYWNrYm9uZS5oaXN0b3J5ID0gbmV3IEhpc3Rvcnk7CgogIC8vIEhlbHBlcnMKICAvLyAtLS0tLS0tCgogIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb3JyZWN0bHkgc2V0IHVwIHRoZSBwcm90b3R5cGUgY2hhaW4sIGZvciBzdWJjbGFzc2VzLgogIC8vIFNpbWlsYXIgdG8gYGdvb2cuaW5oZXJpdHNgLCBidXQgdXNlcyBhIGhhc2ggb2YgcHJvdG90eXBlIHByb3BlcnRpZXMgYW5kCiAgLy8gY2xhc3MgcHJvcGVydGllcyB0byBiZSBleHRlbmRlZC4KICB2YXIgZXh0ZW5kID0gZnVuY3Rpb24ocHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKICAgIHZhciBwYXJlbnQgPSB0aGlzOwogICAgdmFyIGNoaWxkOwoKICAgIC8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKICAgIC8vICh0aGUgImNvbnN0cnVjdG9yIiBwcm9wZXJ0eSBpbiB5b3VyIGBleHRlbmRgIGRlZmluaXRpb24pLCBvciBkZWZhdWx0ZWQKICAgIC8vIGJ5IHVzIHRvIHNpbXBseSBjYWxsIHRoZSBwYXJlbnQncyBjb25zdHJ1Y3Rvci4KICAgIGlmIChwcm90b1Byb3BzICYmIF8uaGFzKHByb3RvUHJvcHMsICdjb25zdHJ1Y3RvcicpKSB7CiAgICAgIGNoaWxkID0gcHJvdG9Qcm9wcy5jb25zdHJ1Y3RvcjsKICAgIH0gZWxzZSB7CiAgICAgIGNoaWxkID0gZnVuY3Rpb24oKXsgcmV0dXJuIHBhcmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyB9OwogICAgfQoKICAgIC8vIEFkZCBzdGF0aWMgcHJvcGVydGllcyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24sIGlmIHN1cHBsaWVkLgogICAgXy5leHRlbmQoY2hpbGQsIHBhcmVudCwgc3RhdGljUHJvcHMpOwoKICAgIC8vIFNldCB0aGUgcHJvdG90eXBlIGNoYWluIHRvIGluaGVyaXQgZnJvbSBgcGFyZW50YCwgd2l0aG91dCBjYWxsaW5nCiAgICAvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uKCl7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfTsKICAgIFN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOwogICAgY2hpbGQucHJvdG90eXBlID0gbmV3IFN1cnJvZ2F0ZTsKCiAgICAvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKICAgIC8vIGlmIHN1cHBsaWVkLgogICAgaWYgKHByb3RvUHJvcHMpIF8uZXh0ZW5kKGNoaWxkLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7CgogICAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAogICAgLy8gbGF0ZXIuCiAgICBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOwoKICAgIHJldHVybiBjaGlsZDsKICB9OwoKICAvLyBTZXQgdXAgaW5oZXJpdGFuY2UgZm9yIHRoZSBtb2RlbCwgY29sbGVjdGlvbiwgcm91dGVyLCB2aWV3IGFuZCBoaXN0b3J5LgogIE1vZGVsLmV4dGVuZCA9IENvbGxlY3Rpb24uZXh0ZW5kID0gUm91dGVyLmV4dGVuZCA9IFZpZXcuZXh0ZW5kID0gSGlzdG9yeS5leHRlbmQgPSBleHRlbmQ7CgogIC8vIFRocm93IGFuIGVycm9yIHdoZW4gYSBVUkwgaXMgbmVlZGVkLCBhbmQgbm9uZSBpcyBzdXBwbGllZC4KICB2YXIgdXJsRXJyb3IgPSBmdW5jdGlvbigpIHsKICAgIHRocm93IG5ldyBFcnJvcignQSAidXJsIiBwcm9wZXJ0eSBvciBmdW5jdGlvbiBtdXN0IGJlIHNwZWNpZmllZCcpOwogIH07CgogIC8vIFdyYXAgYW4gb3B0aW9uYWwgZXJyb3IgY2FsbGJhY2sgd2l0aCBhIGZhbGxiYWNrIGVycm9yIGV2ZW50LgogIHZhciB3cmFwRXJyb3IgPSBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgdmFyIGVycm9yID0gb3B0aW9ucy5lcnJvcjsKICAgIG9wdGlvbnMuZXJyb3IgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgIGlmIChlcnJvcikgZXJyb3IobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICBtb2RlbC50cmlnZ2VyKCdlcnJvcicsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgIH07CiAgfTsKCiAgcmV0dXJuIEJhY2tib25lOwoKfSkpOwoKLyoqCiAqIEJhY2tib25lIGxvY2FsU3RvcmFnZSBhbmQgc2Vzc2lvblN0b3JhZ2UgQWRhcHRlcgogKiBWZXJzaW9uIDAuMC4xCiAqCiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9qY2JyYW5kL0JhY2tib25lLmJyb3dzZXJTdG9yYWdlCiAqLwooZnVuY3Rpb24gKHJvb3QsIGZhY3RvcnkpIHsKICBpZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnICYmIHR5cGVvZiByZXF1aXJlID09PSAnZnVuY3Rpb24nKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkocmVxdWlyZSgiYmFja2JvbmUiKSwgcmVxdWlyZSgndW5kZXJzY29yZScpKTsKICB9IGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgewogICAgLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLgogICAgZGVmaW5lKCdiYWNrYm9uZS5icm93c2VyU3RvcmFnZScsWyJiYWNrYm9uZSIsICJ1bmRlcnNjb3JlIl0sIGZ1bmN0aW9uKEJhY2tib25lLCBfKSB7CiAgICAgIC8vIFVzZSBnbG9iYWwgdmFyaWFibGVzIGlmIHRoZSBsb2NhbHMgYXJlIHVuZGVmaW5lZC4KICAgICAgcmV0dXJuIGZhY3RvcnkoQmFja2JvbmUgfHwgcm9vdC5CYWNrYm9uZSwgXyB8fCByb290Ll8pOwogICAgfSk7CiAgfSBlbHNlIHsKICAgIGZhY3RvcnkoQmFja2JvbmUsIF8pOwogIH0KfSh0aGlzLCBmdW5jdGlvbihCYWNrYm9uZSwgXykgewovLyBBIHNpbXBsZSBtb2R1bGUgdG8gcmVwbGFjZSBgQmFja2JvbmUuc3luY2Agd2l0aCAqYnJvd3NlciBzdG9yYWdlKi1iYXNlZAovLyBwZXJzaXN0ZW5jZS4gTW9kZWxzIGFyZSBnaXZlbiBHVUlEUywgYW5kIHNhdmVkIGludG8gYSBKU09OIG9iamVjdC4gU2ltcGxlCi8vIGFzIHRoYXQuCgovLyBIb2xkIHJlZmVyZW5jZSB0byBVbmRlcnNjb3JlLmpzIGFuZCBCYWNrYm9uZS5qcyBpbiB0aGUgY2xvc3VyZSBpbiBvcmRlcgovLyB0byBtYWtlIHRoaW5ncyB3b3JrIGV2ZW4gaWYgdGhleSBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBnbG9iYWwgbmFtZXNwYWNlCgovLyBHZW5lcmF0ZSBmb3VyIHJhbmRvbSBoZXggZGlnaXRzLgpmdW5jdGlvbiBTNCgpIHsKICAgcmV0dXJuICgoKDErTWF0aC5yYW5kb20oKSkqMHgxMDAwMCl8MCkudG9TdHJpbmcoMTYpLnN1YnN0cmluZygxKTsKfQoKLy8gR2VuZXJhdGUgYSBwc2V1ZG8tR1VJRCBieSBjb25jYXRlbmF0aW5nIHJhbmRvbSBoZXhhZGVjaW1hbC4KZnVuY3Rpb24gZ3VpZCgpIHsKICAgcmV0dXJuIChTNCgpK1M0KCkrIi0iK1M0KCkrIi0iK1M0KCkrIi0iK1M0KCkrIi0iK1M0KCkrUzQoKStTNCgpKTsKfQoKZnVuY3Rpb24gY29udGFpbnMoYXJyYXksIGl0ZW0pIHsKICB2YXIgaSA9IGFycmF5Lmxlbmd0aDsKICB3aGlsZSAoaS0tKSBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pIHJldHVybiB0cnVlOwogIHJldHVybiBmYWxzZTsKfQoKZnVuY3Rpb24gZXh0ZW5kKG9iaiwgcHJvcHMpIHsKICBmb3IgKHZhciBrZXkgaW4gcHJvcHMpIHsgb2JqW2tleV0gPSBwcm9wc1trZXldOyB9CiAgcmV0dXJuIG9iajsKfQoKZnVuY3Rpb24gX2Jyb3dzZXJTdG9yYWdlIChuYW1lLCBzZXJpYWxpemVyLCB0eXBlKSB7CiAgICB2YXIgX3N0b3JlOwogICAgaWYgKHR5cGUgPT09ICdsb2NhbCcgJiYgIXdpbmRvdy5sb2NhbFN0b3JhZ2UgKSB7CiAgICAgICAgdGhyb3cgIkJhY2tib25lLmJyb3dzZXJTdG9yYWdlOiBFbnZpcm9ubWVudCBkb2VzIG5vdCBzdXBwb3J0IGxvY2FsU3RvcmFnZS4iOwogICAgfSBlbHNlIGlmICh0eXBlID09PSAnc2Vzc2lvbicgJiYgIXdpbmRvdy5zZXNzaW9uU3RvcmFnZSApIHsKICAgICAgICB0aHJvdyAiQmFja2JvbmUuYnJvd3NlclN0b3JhZ2U6IEVudmlyb25tZW50IGRvZXMgbm90IHN1cHBvcnQgc2Vzc2lvblN0b3JhZ2UuIjsKICAgIH0KICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICB0aGlzLnNlcmlhbGl6ZXIgPSBzZXJpYWxpemVyIHx8IHsKICAgICAgICBzZXJpYWxpemU6IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICByZXR1cm4gXy5pc09iamVjdChpdGVtKSA/IEpTT04uc3RyaW5naWZ5KGl0ZW0pIDogaXRlbTsKICAgICAgICB9LAogICAgICAgIC8vIGZpeCBmb3IgImlsbGVnYWwgYWNjZXNzIiBlcnJvciBvbiBBbmRyb2lkIHdoZW4gSlNPTi5wYXJzZSBpcyBwYXNzZWQgbnVsbAogICAgICAgIGRlc2VyaWFsaXplOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIHJldHVybiBkYXRhICYmIEpTT04ucGFyc2UoZGF0YSk7CiAgICAgICAgfQogICAgfTsKCiAgICBpZiAodHlwZSA9PT0gJ3Nlc3Npb24nKSB7CiAgICAgICAgdGhpcy5zdG9yZSA9IHdpbmRvdy5zZXNzaW9uU3RvcmFnZTsKICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2xvY2FsJykgewogICAgICAgIHRoaXMuc3RvcmUgPSB3aW5kb3cubG9jYWxTdG9yYWdlOwogICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyAiQmFja2JvbmUuYnJvd3NlclN0b3JhZ2U6IE5vIHN0b3JhZ2UgdHlwZSB3YXMgc3BlY2lmaWVkIjsKICAgIH0KICAgIF9zdG9yZSA9IHRoaXMuc3RvcmUuZ2V0SXRlbSh0aGlzLm5hbWUpOwogICAgdGhpcy5yZWNvcmRzID0gKF9zdG9yZSAmJiBfc3RvcmUuc3BsaXQoIiwiKSkgfHwgW107Cn0KCi8vIE91ciBTdG9yZSBpcyByZXByZXNlbnRlZCBieSBhIHNpbmdsZSBKUyBvYmplY3QgaW4gKmxvY2FsU3RvcmFnZSogb3IgKnNlc3Npb25TdG9yYWdlKi4KLy8gQ3JlYXRlIGl0IHdpdGggYSBtZWFuaW5nZnVsIG5hbWUsIGxpa2UgdGhlIG5hbWUgeW91J2QgZ2l2ZSBhIHRhYmxlLgpCYWNrYm9uZS5Ccm93c2VyU3RvcmFnZSA9IHsKICAgIGxvY2FsOiBmdW5jdGlvbiAobmFtZSwgc2VyaWFsaXplcikgewogICAgICAgIHJldHVybiBfYnJvd3NlclN0b3JhZ2UuYmluZCh0aGlzLCBuYW1lLCBzZXJpYWxpemVyLCAnbG9jYWwnKSgpOwogICAgfSwKICAgIHNlc3Npb246IGZ1bmN0aW9uIChuYW1lLCBzZXJpYWxpemVyKSB7CiAgICAgICAgcmV0dXJuIF9icm93c2VyU3RvcmFnZS5iaW5kKHRoaXMsIG5hbWUsIHNlcmlhbGl6ZXIsICdzZXNzaW9uJykoKTsKICAgIH0KfTsKCi8vIFRoZSBicm93c2VyJ3MgbG9jYWwgYW5kIHNlc3Npb24gc3RvcmVzIHdpbGwgYmUgZXh0ZW5kZWQgd2l0aCB0aGlzIG9iai4KdmFyIF9leHRlbnNpb24gPSB7CgogIC8vIFNhdmUgdGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhlICoqU3RvcmUqKgogIHNhdmU6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5zdG9yZS5zZXRJdGVtKHRoaXMubmFtZSwgdGhpcy5yZWNvcmRzLmpvaW4oIiwiKSk7CiAgfSwKCiAgLy8gQWRkIGEgbW9kZWwsIGdpdmluZyBpdCBhIChob3BlZnVsbHkpLXVuaXF1ZSBHVUlELCBpZiBpdCBkb2Vzbid0IGFscmVhZHkKICAvLyBoYXZlIGFuIGlkIG9mIGl0J3Mgb3duLgogIGNyZWF0ZTogZnVuY3Rpb24obW9kZWwpIHsKICAgIGlmICghbW9kZWwuaWQpIHsKICAgICAgbW9kZWwuaWQgPSBndWlkKCk7CiAgICAgIG1vZGVsLnNldChtb2RlbC5pZEF0dHJpYnV0ZSwgbW9kZWwuaWQpOwogICAgfQogICAgdGhpcy5zdG9yZS5zZXRJdGVtKHRoaXMuX2l0ZW1OYW1lKG1vZGVsLmlkKSwgdGhpcy5zZXJpYWxpemVyLnNlcmlhbGl6ZShtb2RlbCkpOwogICAgdGhpcy5yZWNvcmRzLnB1c2gobW9kZWwuaWQudG9TdHJpbmcoKSk7CiAgICB0aGlzLnNhdmUoKTsKICAgIHJldHVybiB0aGlzLmZpbmQobW9kZWwpICE9PSBmYWxzZTsKICB9LAoKICAvLyBVcGRhdGUgYSBtb2RlbCBieSByZXBsYWNpbmcgaXRzIGNvcHkgaW4gYHRoaXMuZGF0YWAuCiAgdXBkYXRlOiBmdW5jdGlvbihtb2RlbCkgewogICAgdGhpcy5zdG9yZS5zZXRJdGVtKHRoaXMuX2l0ZW1OYW1lKG1vZGVsLmlkKSwgdGhpcy5zZXJpYWxpemVyLnNlcmlhbGl6ZShtb2RlbCkpOwogICAgdmFyIG1vZGVsSWQgPSBtb2RlbC5pZC50b1N0cmluZygpOwogICAgaWYgKCFjb250YWlucyh0aGlzLnJlY29yZHMsIG1vZGVsSWQpKSB7CiAgICAgIHRoaXMucmVjb3Jkcy5wdXNoKG1vZGVsSWQpOwogICAgICB0aGlzLnNhdmUoKTsKICAgIH0KICAgIHJldHVybiB0aGlzLmZpbmQobW9kZWwpICE9PSBmYWxzZTsKICB9LAoKICAvLyBSZXRyaWV2ZSBhIG1vZGVsIGZyb20gYHRoaXMuZGF0YWAgYnkgaWQuCiAgZmluZDogZnVuY3Rpb24obW9kZWwpIHsKICAgIHJldHVybiB0aGlzLnNlcmlhbGl6ZXIuZGVzZXJpYWxpemUodGhpcy5zdG9yZS5nZXRJdGVtKHRoaXMuX2l0ZW1OYW1lKG1vZGVsLmlkKSkpOwogIH0sCgogIC8vIFJldHVybiB0aGUgYXJyYXkgb2YgYWxsIG1vZGVscyBjdXJyZW50bHkgaW4gc3RvcmFnZS4KICBmaW5kQWxsOiBmdW5jdGlvbigpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIGZvciAodmFyIGkgPSAwLCBpZCwgZGF0YTsgaSA8IHRoaXMucmVjb3Jkcy5sZW5ndGg7IGkrKykgewogICAgICBpZCA9IHRoaXMucmVjb3Jkc1tpXTsKICAgICAgZGF0YSA9IHRoaXMuc2VyaWFsaXplci5kZXNlcmlhbGl6ZSh0aGlzLnN0b3JlLmdldEl0ZW0odGhpcy5faXRlbU5hbWUoaWQpKSk7CiAgICAgIGlmIChkYXRhICE9PSBudWxsKSByZXN1bHQucHVzaChkYXRhKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfSwKCiAgLy8gRGVsZXRlIGEgbW9kZWwgZnJvbSBgdGhpcy5kYXRhYCwgcmV0dXJuaW5nIGl0LgogIGRlc3Ryb3k6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICB0aGlzLnN0b3JlLnJlbW92ZUl0ZW0odGhpcy5faXRlbU5hbWUobW9kZWwuaWQpKTsKICAgIHZhciBtb2RlbElkID0gbW9kZWwuaWQudG9TdHJpbmcoKTsKICAgIGZvciAodmFyIGkgPSAwLCBpZDsgaSA8IHRoaXMucmVjb3Jkcy5sZW5ndGg7IGkrKykgewogICAgICBpZiAodGhpcy5yZWNvcmRzW2ldID09PSBtb2RlbElkKSB7CiAgICAgICAgdGhpcy5yZWNvcmRzLnNwbGljZShpLCAxKTsKICAgICAgfQogICAgfQogICAgdGhpcy5zYXZlKCk7CiAgICByZXR1cm4gbW9kZWw7CiAgfSwKCiAgYnJvd3NlclN0b3JhZ2U6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHsKICAgICAgICBzZXNzaW9uOiBzZXNzaW9uU3RvcmFnZSwKICAgICAgICBsb2NhbDogbG9jYWxTdG9yYWdlCiAgICB9OwogIH0sCgogIC8vIENsZWFyIGJyb3dzZXJTdG9yYWdlIGZvciBzcGVjaWZpYyBjb2xsZWN0aW9uLgogIF9jbGVhcjogZnVuY3Rpb24oKSB7CiAgICB2YXIgbG9jYWwgPSB0aGlzLnN0b3JlLAogICAgICBpdGVtUmUgPSBuZXcgUmVnRXhwKCJeIiArIHRoaXMubmFtZSArICItIik7CgogICAgLy8gUmVtb3ZlIGlkLXRyYWNraW5nIGl0ZW0gKGUuZy4sICJmb28iKS4KICAgIGxvY2FsLnJlbW92ZUl0ZW0odGhpcy5uYW1lKTsKCiAgICAvLyBNYXRjaCBhbGwgZGF0YSBpdGVtcyAoZS5nLiwgImZvby1JRCIpIGFuZCByZW1vdmUuCiAgICBmb3IgKHZhciBrIGluIGxvY2FsKSB7CiAgICAgIGlmIChpdGVtUmUudGVzdChrKSkgewogICAgICAgIGxvY2FsLnJlbW92ZUl0ZW0oayk7CiAgICAgIH0KICAgIH0KCiAgICB0aGlzLnJlY29yZHMubGVuZ3RoID0gMDsKICB9LAoKICAvLyBTaXplIG9mIGJyb3dzZXJTdG9yYWdlLgogIF9zdG9yYWdlU2l6ZTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5zdG9yZS5sZW5ndGg7CiAgfSwKCiAgX2l0ZW1OYW1lOiBmdW5jdGlvbihpZCkgewogICAgcmV0dXJuIHRoaXMubmFtZSsiLSIraWQ7CiAgfQoKfTsKCmV4dGVuZChCYWNrYm9uZS5Ccm93c2VyU3RvcmFnZS5zZXNzaW9uLnByb3RvdHlwZSwgX2V4dGVuc2lvbik7CmV4dGVuZChCYWNrYm9uZS5Ccm93c2VyU3RvcmFnZS5sb2NhbC5wcm90b3R5cGUsIF9leHRlbnNpb24pOwoKLy8gbG9jYWxTeW5jIGRlbGVnYXRlIHRvIHRoZSBtb2RlbCBvciBjb2xsZWN0aW9uJ3MKLy8gKmJyb3dzZXJTdG9yYWdlKiBwcm9wZXJ0eSwgd2hpY2ggc2hvdWxkIGJlIGFuIGluc3RhbmNlIG9mIGBTdG9yZWAuCi8vIHdpbmRvdy5TdG9yZS5zeW5jIGFuZCBCYWNrYm9uZS5sb2NhbFN5bmMgaXMgZGVwcmVjYXRlZCwgdXNlIEJhY2tib25lLkJyb3dzZXJTdG9yYWdlLnN5bmMgaW5zdGVhZApCYWNrYm9uZS5Ccm93c2VyU3RvcmFnZS5zeW5jID0gQmFja2JvbmUubG9jYWxTeW5jID0gZnVuY3Rpb24obWV0aG9kLCBtb2RlbCwgb3B0aW9ucykgewogIHZhciBzdG9yZSA9IG1vZGVsLmJyb3dzZXJTdG9yYWdlIHx8IG1vZGVsLmNvbGxlY3Rpb24uYnJvd3NlclN0b3JhZ2U7CgogIHZhciByZXNwLCBlcnJvck1lc3NhZ2U7CiAgLy9JZiAkIGlzIGhhdmluZyBEZWZlcnJlZCAtIHVzZSBpdC4KICB2YXIgc3luY0RmZCA9IEJhY2tib25lLiQgPwogICAgKEJhY2tib25lLiQuRGVmZXJyZWQgJiYgQmFja2JvbmUuJC5EZWZlcnJlZCgpKSA6CiAgICAoQmFja2JvbmUuRGVmZXJyZWQgJiYgQmFja2JvbmUuRGVmZXJyZWQoKSk7CgogIHRyeSB7CgogICAgc3dpdGNoIChtZXRob2QpIHsKICAgICAgY2FzZSAicmVhZCI6CiAgICAgICAgcmVzcCA9IG1vZGVsLmlkICE9PSB1bmRlZmluZWQgPyBzdG9yZS5maW5kKG1vZGVsKSA6IHN0b3JlLmZpbmRBbGwoKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiY3JlYXRlIjoKICAgICAgICByZXNwID0gc3RvcmUuY3JlYXRlKG1vZGVsKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAidXBkYXRlIjoKICAgICAgICByZXNwID0gc3RvcmUudXBkYXRlKG1vZGVsKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiZGVsZXRlIjoKICAgICAgICByZXNwID0gc3RvcmUuZGVzdHJveShtb2RlbCk7CiAgICAgICAgYnJlYWs7CiAgICB9CgogIH0gY2F0Y2goZXJyb3IpIHsKICAgIGlmIChlcnJvci5jb2RlID09PSAyMiAmJiBzdG9yZS5fc3RvcmFnZVNpemUoKSA9PT0gMCkKICAgICAgZXJyb3JNZXNzYWdlID0gIlByaXZhdGUgYnJvd3NpbmcgaXMgdW5zdXBwb3J0ZWQiOwogICAgZWxzZQogICAgICBlcnJvck1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlOwogIH0KCiAgaWYgKHJlc3ApIHsKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuc3VjY2VzcykgewogICAgICBpZiAoQmFja2JvbmUuVkVSU0lPTiA9PT0gIjAuOS4xMCIpIHsKICAgICAgICBvcHRpb25zLnN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9IGVsc2UgewogICAgICAgIG9wdGlvbnMuc3VjY2VzcyhyZXNwKTsKICAgICAgfQogICAgfQogICAgaWYgKHN5bmNEZmQpIHsKICAgICAgc3luY0RmZC5yZXNvbHZlKHJlc3ApOwogICAgfQoKICB9IGVsc2UgewogICAgZXJyb3JNZXNzYWdlID0gZXJyb3JNZXNzYWdlID8gZXJyb3JNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAiUmVjb3JkIE5vdCBGb3VuZCI7CgogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5lcnJvcikKICAgICAgaWYgKEJhY2tib25lLlZFUlNJT04gPT09ICIwLjkuMTAiKSB7CiAgICAgICAgb3B0aW9ucy5lcnJvcihtb2RlbCwgZXJyb3JNZXNzYWdlLCBvcHRpb25zKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvcHRpb25zLmVycm9yKGVycm9yTWVzc2FnZSk7CiAgICAgIH0KCiAgICBpZiAoc3luY0RmZCkKICAgICAgc3luY0RmZC5yZWplY3QoZXJyb3JNZXNzYWdlKTsKICB9CgogIC8vIGFkZCBjb21wYXRpYmlsaXR5IHdpdGggJC5hamF4CiAgLy8gYWx3YXlzIGV4ZWN1dGUgY2FsbGJhY2sgZm9yIHN1Y2Nlc3MgYW5kIGVycm9yCiAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5jb21wbGV0ZSkgb3B0aW9ucy5jb21wbGV0ZShyZXNwKTsKCiAgcmV0dXJuIHN5bmNEZmQgJiYgc3luY0RmZC5wcm9taXNlKCk7Cn07CgpCYWNrYm9uZS5hamF4U3luYyA9IEJhY2tib25lLnN5bmM7CgpCYWNrYm9uZS5nZXRTeW5jTWV0aG9kID0gZnVuY3Rpb24obW9kZWwpIHsKICBpZihtb2RlbC5icm93c2VyU3RvcmFnZSB8fCAobW9kZWwuY29sbGVjdGlvbiAmJiBtb2RlbC5jb2xsZWN0aW9uLmJyb3dzZXJTdG9yYWdlKSkgewogICAgcmV0dXJuIEJhY2tib25lLmxvY2FsU3luYzsKICB9CiAgcmV0dXJuIEJhY2tib25lLmFqYXhTeW5jOwp9OwoKLy8gT3ZlcnJpZGUgJ0JhY2tib25lLnN5bmMnIHRvIGRlZmF1bHQgdG8gbG9jYWxTeW5jLAovLyB0aGUgb3JpZ2luYWwgJ0JhY2tib25lLnN5bmMnIGlzIHN0aWxsIGF2YWlsYWJsZSBpbiAnQmFja2JvbmUuYWpheFN5bmMnCkJhY2tib25lLnN5bmMgPSBmdW5jdGlvbihtZXRob2QsIG1vZGVsLCBvcHRpb25zKSB7CiAgcmV0dXJuIEJhY2tib25lLmdldFN5bmNNZXRob2QobW9kZWwpLmFwcGx5KHRoaXMsIFttZXRob2QsIG1vZGVsLCBvcHRpb25zXSk7Cn07CgpyZXR1cm4gQmFja2JvbmUuQnJvd3NlclN0b3JhZ2U7Cn0pKTsKCi8qIQogKiBCYWNrYm9uZS5PdmVydmlldyAKICoKICogQ29weXJpZ2h0IChjKSAyMDE0LCBKQyBCcmFuZCA8amNAb3Brb2RlLmNvbT4KICogTGljZW5zZWQgdW5kZXIgdGhlIE1vemlsbGEgUHVibGljIExpY2Vuc2UgKE1QTCkgCiAqLwoKKGZ1bmN0aW9uIChyb290LCBmYWN0b3J5KSB7CiAgICBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgZGVmaW5lKCdiYWNrYm9uZS5vdmVydmlldycsWyJ1bmRlcnNjb3JlIiwgImJhY2tib25lIl0sCiAgICAgICAgICAgIGZ1bmN0aW9uKF8sIEJhY2tib25lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFjdG9yeShfIHx8IHJvb3QuXywgQmFja2JvbmUgfHwgcm9vdC5CYWNrYm9uZSk7CiAgICAgICAgICAgIH0KICAgICAgICApOwogICB9IGVsc2UgewogICAgICAvLyBSZXF1aXJlSlMgaXNuJ3QgYmVpbmcgdXNlZC4KICAgICAgLy8gQXNzdW1lIHVuZGVyc2NvcmUgYW5kIGJhY2tib25lIGFyZSBsb2FkZWQgaW4gPHNjcmlwdD4gdGFncwogICAgICBmYWN0b3J5KF8sIEJhY2tib25lKTsKICAgfQp9KHRoaXMsIGZ1bmN0aW9uIChfLCBCYWNrYm9uZSkgewogICAgCiAgICB2YXIgT3ZlcnZpZXcgPSBCYWNrYm9uZS5PdmVydmlldyA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgICAgLyogQW4gT3ZlcnZpZXcgaXMgYSBWaWV3IHRoYXQgY29udGFpbnMgYW5kIGtlZXBzIHRyYWNrIG9mIHN1Yi12aWV3cy4KICAgICAgICAgKiBLaW5kIG9mIGxpa2Ugd2hhdCBhIENvbGxlY3Rpb24gaXMgdG8gYSBNb2RlbC4KICAgICAgICAgKi8KICAgICAgICB2YXIgdmlld3MgPSB7fTsKICAgICAgICB0aGlzLmtleXMgPSBmdW5jdGlvbiAoKSB7IHJldHVybiBfLmtleXModmlld3MpIH07CiAgICAgICAgdGhpcy5nZXRBbGwgPSBmdW5jdGlvbiAoKSB7IHJldHVybiB2aWV3czsgfTsKICAgICAgICB0aGlzLmdldCA9IGZ1bmN0aW9uIChpZCkgeyByZXR1cm4gdmlld3NbaWRdOyB9OwogICAgICAgIHRoaXMuYWRkID0gZnVuY3Rpb24gKGlkLCB2aWV3KSB7CiAgICAgICAgICAgIHZpZXdzW2lkXSA9IHZpZXc7CiAgICAgICAgICAgIHJldHVybiB2aWV3OwogICAgICAgIH07CiAgICAgICAgdGhpcy5yZW1vdmUgPSBmdW5jdGlvbiAoaWQpIHsKICAgICAgICAgICAgdmFyIHZpZXcgPSB2aWV3c1tpZF07CiAgICAgICAgICAgIGlmICh2aWV3KSB7CiAgICAgICAgICAgICAgICBkZWxldGUgdmlld3NbaWRdOwogICAgICAgICAgICAgICAgdmlldy5yZW1vdmUoKTsKICAgICAgICAgICAgICAgIHJldHVybiB2aWV3OwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB0aGlzLnJlbW92ZUFsbCA9IGZ1bmN0aW9uIChpZCkgewogICAgICAgICAgICBfLmVhY2goXy5rZXlzKHZpZXdzKSwgdGhpcy5yZW1vdmUpOwogICAgICAgIH07CgogICAgICAgIEJhY2tib25lLlZpZXcuYXBwbHkodGhpcywgQXJyYXkucHJvdG90eXBlLnNsaWNlLmFwcGx5KGFyZ3VtZW50cykpOwogICAgfTsKICAgIF8uZXh0ZW5kKE92ZXJ2aWV3LnByb3RvdHlwZSwgQmFja2JvbmUuVmlldy5wcm90b3R5cGUpOwogICAgT3ZlcnZpZXcuZXh0ZW5kID0gQmFja2JvbmUuVmlldy5leHRlbmQ7CiAgICByZXR1cm4gQmFja2JvbmUuT3ZlcnZpZXc7Cn0pKTsKCi8qIQogKiBqUXVlcnkgQnJvd3NlciBQbHVnaW4gdjAuMC42CiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9nYWJjZWIvanF1ZXJ5LWJyb3dzZXItcGx1Z2luCiAqCiAqIE9yaWdpbmFsIGpxdWVyeS1icm93c2VyIGNvZGUgQ29weXJpZ2h0IDIwMDUsIDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24sIEluYy4gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIE1vZGlmaWNhdGlvbnMgQ29weXJpZ2h0IDIwMTMgR2FicmllbCBDZWJyaWFuCiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9nYWJjZWIKICoKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlCiAqCiAqIERhdGU6IDIwMTMtMDctMjlUMTc6MjM6MjctMDc6MDAKICovCgooZnVuY3Rpb24gKHJvb3QsIGZhY3RvcnkpIHsKICAgIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKICAgICAgICAvLyBBTUQuIFJlZ2lzdGVyIGFzIGFuIGFub255bW91cyBtb2R1bGUuCiAgICAgICAgZGVmaW5lKCdqcXVlcnkuYnJvd3NlcicsWydqcXVlcnknXSwgZnVuY3Rpb24gKCQpIHsKICAgICAgICAgICAgZmFjdG9yeSgkLCByb290KTsKICAgICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gQnJvd3NlciBnbG9iYWxzCiAgICAgICAgZmFjdG9yeShqUXVlcnksIHJvb3QpOwogICAgfQp9KHRoaXMsIGZ1bmN0aW9uKGpRdWVyeSwgd2luZG93KSB7CiAgCgogIHZhciBtYXRjaGVkLCBicm93c2VyOwoKICBqUXVlcnkudWFNYXRjaCA9IGZ1bmN0aW9uKCB1YSApIHsKICAgIHVhID0gdWEudG9Mb3dlckNhc2UoKTsKCiAgCXZhciBtYXRjaCA9IC8ob3ByKVtcL10oW1x3Ll0rKS8uZXhlYyggdWEgKSB8fAogIAkJLyhjaHJvbWUpWyBcL10oW1x3Ll0rKS8uZXhlYyggdWEgKSB8fAogIAkJLyh2ZXJzaW9uKVsgXC9dKFtcdy5dKykuKihzYWZhcmkpWyBcL10oW1x3Ll0rKS8uZXhlYyggdWEgKSB8fAogIAkJLyh3ZWJraXQpWyBcL10oW1x3Ll0rKS8uZXhlYyggdWEgKSB8fAogIAkJLyhvcGVyYSkoPzouKnZlcnNpb258KVsgXC9dKFtcdy5dKykvLmV4ZWMoIHVhICkgfHwKICAJCS8obXNpZSkgKFtcdy5dKykvLmV4ZWMoIHVhICkgfHwKICAJCXVhLmluZGV4T2YoInRyaWRlbnQiKSA+PSAwICYmIC8ocnYpKD86OnwgKShbXHcuXSspLy5leGVjKCB1YSApIHx8CiAgCQl1YS5pbmRleE9mKCJjb21wYXRpYmxlIikgPCAwICYmIC8obW96aWxsYSkoPzouKj8gcnY6KFtcdy5dKyl8KS8uZXhlYyggdWEgKSB8fAogIAkJW107CgogIAl2YXIgcGxhdGZvcm1fbWF0Y2ggPSAvKGlwYWQpLy5leGVjKCB1YSApIHx8CiAgCQkvKGlwaG9uZSkvLmV4ZWMoIHVhICkgfHwKICAJCS8oYW5kcm9pZCkvLmV4ZWMoIHVhICkgfHwKICAJCS8od2luZG93cyBwaG9uZSkvLmV4ZWMoIHVhICkgfHwKICAJCS8od2luKS8uZXhlYyggdWEgKSB8fAogIAkJLyhtYWMpLy5leGVjKCB1YSApIHx8CiAgCQkvKGxpbnV4KS8uZXhlYyggdWEgKSB8fAogIAkJLyhjcm9zKS9pLmV4ZWMoIHVhICkgfHwKICAJCVtdOwoKICAJcmV0dXJuIHsKICAJCWJyb3dzZXI6IG1hdGNoWyAzIF0gfHwgbWF0Y2hbIDEgXSB8fCAiIiwKICAJCXZlcnNpb246IG1hdGNoWyAyIF0gfHwgIjAiLAogIAkJcGxhdGZvcm06IHBsYXRmb3JtX21hdGNoWyAwIF0gfHwgIiIKICAJfTsKICB9OwoKICBtYXRjaGVkID0galF1ZXJ5LnVhTWF0Y2goIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50ICk7CiAgYnJvd3NlciA9IHt9OwoKICBpZiAoIG1hdGNoZWQuYnJvd3NlciApIHsKICAJYnJvd3NlclsgbWF0Y2hlZC5icm93c2VyIF0gPSB0cnVlOwogIAlicm93c2VyLnZlcnNpb24gPSBtYXRjaGVkLnZlcnNpb247CiAgCWJyb3dzZXIudmVyc2lvbk51bWJlciA9IHBhcnNlSW50KG1hdGNoZWQudmVyc2lvbik7CiAgfQoKICBpZiAoIG1hdGNoZWQucGxhdGZvcm0gKSB7CiAgCWJyb3dzZXJbIG1hdGNoZWQucGxhdGZvcm0gXSA9IHRydWU7CiAgfQoKICAvLyBUaGVzZSBhcmUgYWxsIGNvbnNpZGVyZWQgbW9iaWxlIHBsYXRmb3JtcywgbWVhbmluZyB0aGV5IHJ1biBhIG1vYmlsZSBicm93c2VyCiAgaWYgKCBicm93c2VyLmFuZHJvaWQgfHwgYnJvd3Nlci5pcGFkIHx8IGJyb3dzZXIuaXBob25lIHx8IGJyb3dzZXJbICJ3aW5kb3dzIHBob25lIiBdICkgewogIAlicm93c2VyLm1vYmlsZSA9IHRydWU7CiAgfQoKICAvLyBUaGVzZSBhcmUgYWxsIGNvbnNpZGVyZWQgZGVza3RvcCBwbGF0Zm9ybXMsIG1lYW5pbmcgdGhleSBydW4gYSBkZXNrdG9wIGJyb3dzZXIKICBpZiAoIGJyb3dzZXIuY3JvcyB8fCBicm93c2VyLm1hYyB8fCBicm93c2VyLmxpbnV4IHx8IGJyb3dzZXIud2luICkgewogIAlicm93c2VyLmRlc2t0b3AgPSB0cnVlOwogIH0KCiAgLy8gQ2hyb21lLCBPcGVyYSAxNSsgYW5kIFNhZmFyaSBhcmUgd2Via2l0IGJhc2VkIGJyb3dzZXJzCiAgaWYgKCBicm93c2VyLmNocm9tZSB8fCBicm93c2VyLm9wciB8fCBicm93c2VyLnNhZmFyaSApIHsKICAJYnJvd3Nlci53ZWJraXQgPSB0cnVlOwogIH0KCiAgLy8gSUUxMSBoYXMgYSBuZXcgdG9rZW4gc28gd2Ugd2lsbCBhc3NpZ24gaXQgbXNpZSB0byBhdm9pZCBicmVha2luZyBjaGFuZ2VzCiAgaWYgKCBicm93c2VyLnJ2ICkKICB7CiAgCXZhciBpZSA9ICJtc2llIjsKCiAgCW1hdGNoZWQuYnJvd3NlciA9IGllOwogIAlicm93c2VyW2llXSA9IHRydWU7CiAgfQoKICAvLyBPcGVyYSAxNSsgYXJlIGlkZW50aWZpZWQgYXMgb3ByCiAgaWYgKCBicm93c2VyLm9wciApCiAgewogIAl2YXIgb3BlcmEgPSAib3BlcmEiOwoKICAJbWF0Y2hlZC5icm93c2VyID0gb3BlcmE7CiAgCWJyb3dzZXJbb3BlcmFdID0gdHJ1ZTsKICB9CgogIC8vIFN0b2NrIEFuZHJvaWQgYnJvd3NlcnMgYXJlIG1hcmtlZCBhcyBTYWZhcmkgb24gQW5kcm9pZC4KICBpZiAoIGJyb3dzZXIuc2FmYXJpICYmIGJyb3dzZXIuYW5kcm9pZCApCiAgewogIAl2YXIgYW5kcm9pZCA9ICJhbmRyb2lkIjsKCiAgCW1hdGNoZWQuYnJvd3NlciA9IGFuZHJvaWQ7CiAgCWJyb3dzZXJbYW5kcm9pZF0gPSB0cnVlOwogIH0KCiAgLy8gQXNzaWduIHRoZSBuYW1lIGFuZCBwbGF0Zm9ybSB2YXJpYWJsZQogIGJyb3dzZXIubmFtZSA9IG1hdGNoZWQuYnJvd3NlcjsKICBicm93c2VyLnBsYXRmb3JtID0gbWF0Y2hlZC5wbGF0Zm9ybTsKCiAgalF1ZXJ5LmJyb3dzZXIgPSBicm93c2VyOwogIHJldHVybiBicm93c2VyOwp9KSk7CgovKiEKICogdHlwZWFoZWFkLmpzIDAuMTAuNQogKiBodHRwczovL2dpdGh1Yi5jb20vdHdpdHRlci90eXBlYWhlYWQuanMKICogQ29weXJpZ2h0IDIwMTMtMjAxNCBUd2l0dGVyLCBJbmMuIGFuZCBvdGhlciBjb250cmlidXRvcnM7IExpY2Vuc2VkIE1JVAogKi8KCihmdW5jdGlvbiAocm9vdCwgZmFjdG9yeSkgewogICAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewogICAgICAgIC8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS4KICAgICAgICBkZWZpbmUoJ3R5cGVhaGVhZCcsWydqcXVlcnknXSwgZnVuY3Rpb24gKCQpIHsKICAgICAgICAgICAgZmFjdG9yeSgkLCByb290KTsKICAgICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gQnJvd3NlciBnbG9iYWxzCiAgICAgICAgZmFjdG9yeShqUXVlcnksIHJvb3QpOwogICAgfQp9KHRoaXMsIGZ1bmN0aW9uKCQsIHdpbmRvdykgewogICAgdmFyIF8gPSBmdW5jdGlvbigpIHsKICAgICAgICAKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBpc01zaWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIC8obXNpZXx0cmlkZW50KS9pLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudCkgPyBuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC8obXNpZSB8cnY6KShcZCsoLlxkKyk/KS9pKVsyXSA6IGZhbHNlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBpc0JsYW5rU3RyaW5nOiBmdW5jdGlvbihzdHIpIHsKICAgICAgICAgICAgICAgIHJldHVybiAhc3RyIHx8IC9eXHMqJC8udGVzdChzdHIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBlc2NhcGVSZWdFeENoYXJzOiBmdW5jdGlvbihzdHIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzdHIucmVwbGFjZSgvW1wtXFtcXVwvXHtcfVwoXClcKlwrXD9cLlxcXF5cJFx8XS9nLCAiXFwkJiIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBpc1N0cmluZzogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gInN0cmluZyI7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlzTnVtYmVyOiBmdW5jdGlvbihvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAibnVtYmVyIjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNBcnJheTogJC5pc0FycmF5LAogICAgICAgICAgICBpc0Z1bmN0aW9uOiAkLmlzRnVuY3Rpb24sCiAgICAgICAgICAgIGlzT2JqZWN0OiAkLmlzUGxhaW5PYmplY3QsCiAgICAgICAgICAgIGlzVW5kZWZpbmVkOiBmdW5jdGlvbihvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAidW5kZWZpbmVkIjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdG9TdHI6IGZ1bmN0aW9uIHRvU3RyKHMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfLmlzVW5kZWZpbmVkKHMpIHx8IHMgPT09IG51bGwgPyAiIiA6IHMgKyAiIjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgYmluZDogJC5wcm94eSwKICAgICAgICAgICAgZWFjaDogZnVuY3Rpb24oY29sbGVjdGlvbiwgY2IpIHsKICAgICAgICAgICAgICAgICQuZWFjaChjb2xsZWN0aW9uLCByZXZlcnNlQXJncyk7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiByZXZlcnNlQXJncyhpbmRleCwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2IodmFsdWUsIGluZGV4KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgbWFwOiAkLm1hcCwKICAgICAgICAgICAgZmlsdGVyOiAkLmdyZXAsCiAgICAgICAgICAgIGV2ZXJ5OiBmdW5jdGlvbihvYmosIHRlc3QpIHsKICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKCFvYmopIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJC5lYWNoKG9iaiwgZnVuY3Rpb24oa2V5LCB2YWwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIShyZXN1bHQgPSB0ZXN0LmNhbGwobnVsbCwgdmFsLCBrZXksIG9iaikpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiAhIXJlc3VsdDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc29tZTogZnVuY3Rpb24ob2JqLCB0ZXN0KSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAoIW9iaikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkLmVhY2gob2JqLCBmdW5jdGlvbihrZXksIHZhbCkgewogICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgPSB0ZXN0LmNhbGwobnVsbCwgdmFsLCBrZXksIG9iaikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuICEhcmVzdWx0OwogICAgICAgICAgICB9LAogICAgICAgICAgICBtaXhpbjogJC5leHRlbmQsCiAgICAgICAgICAgIGdldFVuaXF1ZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBjb3VudGVyID0gMDsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY291bnRlcisrOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSgpLAogICAgICAgICAgICB0ZW1wbGF0aWZ5OiBmdW5jdGlvbiB0ZW1wbGF0aWZ5KG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuICQuaXNGdW5jdGlvbihvYmopID8gb2JqIDogdGVtcGxhdGU7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiB0ZW1wbGF0ZSgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKG9iaik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlZmVyOiBmdW5jdGlvbihmbikgewogICAgICAgICAgICAgICAgc2V0VGltZW91dChmbiwgMCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlYm91bmNlOiBmdW5jdGlvbihmdW5jLCB3YWl0LCBpbW1lZGlhdGUpIHsKICAgICAgICAgICAgICAgIHZhciB0aW1lb3V0LCByZXN1bHQ7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB0aGlzLCBhcmdzID0gYXJndW1lbnRzLCBsYXRlciwgY2FsbE5vdzsKICAgICAgICAgICAgICAgICAgICBsYXRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpbW1lZGlhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGNhbGxOb3cgPSBpbW1lZGlhdGUgJiYgIXRpbWVvdXQ7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCB3YWl0KTsKICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbE5vdykgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdGhyb3R0bGU6IGZ1bmN0aW9uKGZ1bmMsIHdhaXQpIHsKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0LCBhcmdzLCB0aW1lb3V0LCByZXN1bHQsIHByZXZpb3VzLCBsYXRlcjsKICAgICAgICAgICAgICAgIHByZXZpb3VzID0gMDsKICAgICAgICAgICAgICAgIGxhdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXMgPSBuZXcgRGF0ZSgpOwogICAgICAgICAgICAgICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBub3cgPSBuZXcgRGF0ZSgpLCByZW1haW5pbmcgPSB3YWl0IC0gKG5vdyAtIHByZXZpb3VzKTsKICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gdGhpczsKICAgICAgICAgICAgICAgICAgICBhcmdzID0gYXJndW1lbnRzOwogICAgICAgICAgICAgICAgICAgIGlmIChyZW1haW5pbmcgPD0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91cyA9IG5vdzsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCF0aW1lb3V0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCByZW1haW5pbmcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbm9vcDogZnVuY3Rpb24oKSB7fQogICAgICAgIH07CiAgICB9KCk7CiAgICB2YXIgaHRtbCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHdyYXBwZXI6ICc8c3BhbiBjbGFzcz0idHdpdHRlci10eXBlYWhlYWQiPjwvc3Bhbj4nLAogICAgICAgICAgICBkcm9wZG93bjogJzxzcGFuIGNsYXNzPSJ0dC1kcm9wZG93bi1tZW51Ij48L3NwYW4+JywKICAgICAgICAgICAgZGF0YXNldDogJzxkaXYgY2xhc3M9InR0LWRhdGFzZXQtJUNMQVNTJSI+PC9kaXY+JywKICAgICAgICAgICAgc3VnZ2VzdGlvbnM6ICc8c3BhbiBjbGFzcz0idHQtc3VnZ2VzdGlvbnMiPjwvc3Bhbj4nLAogICAgICAgICAgICBzdWdnZXN0aW9uOiAnPGRpdiBjbGFzcz0idHQtc3VnZ2VzdGlvbiI+PC9kaXY+JwogICAgICAgIH07CiAgICB9KCk7CiAgICB2YXIgY3NzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgCiAgICAgICAgdmFyIGNzcyA9IHsKICAgICAgICAgICAgd3JhcHBlcjogewogICAgICAgICAgICAgICAgcG9zaXRpb246ICJyZWxhdGl2ZSIsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAiaW5saW5lLWJsb2NrIgogICAgICAgICAgICB9LAogICAgICAgICAgICBoaW50OiB7CiAgICAgICAgICAgICAgICBwb3NpdGlvbjogImFic29sdXRlIiwKICAgICAgICAgICAgICAgIHRvcDogIjAiLAogICAgICAgICAgICAgICAgbGVmdDogIjAiLAogICAgICAgICAgICAgICAgYm9yZGVyQ29sb3I6ICJ0cmFuc3BhcmVudCIsCiAgICAgICAgICAgICAgICBib3hTaGFkb3c6ICJub25lIiwKICAgICAgICAgICAgICAgIG9wYWNpdHk6ICIxIgogICAgICAgICAgICB9LAogICAgICAgICAgICBpbnB1dDogewogICAgICAgICAgICAgICAgcG9zaXRpb246ICJyZWxhdGl2ZSIsCiAgICAgICAgICAgICAgICB2ZXJ0aWNhbEFsaWduOiAidG9wIiwKICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogInRyYW5zcGFyZW50IgogICAgICAgICAgICB9LAogICAgICAgICAgICBpbnB1dFdpdGhOb0hpbnQ6IHsKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAicmVsYXRpdmUiLAogICAgICAgICAgICAgICAgdmVydGljYWxBbGlnbjogInRvcCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZHJvcGRvd246IHsKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICAgICAgICAgICAgdG9wOiAiMTAwJSIsCiAgICAgICAgICAgICAgICBsZWZ0OiAiMCIsCiAgICAgICAgICAgICAgICB6SW5kZXg6ICIxMDAiLAogICAgICAgICAgICAgICAgZGlzcGxheTogIm5vbmUiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHN1Z2dlc3Rpb25zOiB7CiAgICAgICAgICAgICAgICBkaXNwbGF5OiAiYmxvY2siCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHN1Z2dlc3Rpb246IHsKICAgICAgICAgICAgICAgIHdoaXRlU3BhY2U6ICJub3dyYXAiLAogICAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc3VnZ2VzdGlvbkNoaWxkOiB7CiAgICAgICAgICAgICAgICB3aGl0ZVNwYWNlOiAibm9ybWFsIgogICAgICAgICAgICB9LAogICAgICAgICAgICBsdHI6IHsKICAgICAgICAgICAgICAgIGxlZnQ6ICIwIiwKICAgICAgICAgICAgICAgIHJpZ2h0OiAiYXV0byIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcnRsOiB7CiAgICAgICAgICAgICAgICBsZWZ0OiAiYXV0byIsCiAgICAgICAgICAgICAgICByaWdodDogIiAwIgogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBpZiAoXy5pc01zaWUoKSkgewogICAgICAgICAgICBfLm1peGluKGNzcy5pbnB1dCwgewogICAgICAgICAgICAgICAgYmFja2dyb3VuZEltYWdlOiAidXJsKGRhdGE6aW1hZ2UvZ2lmO2Jhc2U2NCxSMGxHT0RsaEFRQUJBSUFBQUFBQUFQLy8veUg1QkFFQUFBQUFMQUFBQUFBQkFBRUFBQUlCUkFBNykiCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAoXy5pc01zaWUoKSAmJiBfLmlzTXNpZSgpIDw9IDcpIHsKICAgICAgICAgICAgXy5taXhpbihjc3MuaW5wdXQsIHsKICAgICAgICAgICAgICAgIG1hcmdpblRvcDogIi0xcHgiCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY3NzOwogICAgfSgpOwogICAgdmFyIEV2ZW50QnVzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgCiAgICAgICAgdmFyIG5hbWVzcGFjZSA9ICJ0eXBlYWhlYWQ6IjsKICAgICAgICBmdW5jdGlvbiBFdmVudEJ1cyhvKSB7CiAgICAgICAgICAgIGlmICghbyB8fCAhby5lbCkgewogICAgICAgICAgICAgICAgJC5lcnJvcigiRXZlbnRCdXMgaW5pdGlhbGl6ZWQgd2l0aG91dCBlbCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuJGVsID0gJChvLmVsKTsKICAgICAgICB9CiAgICAgICAgXy5taXhpbihFdmVudEJ1cy5wcm90b3R5cGUsIHsKICAgICAgICAgICAgdHJpZ2dlcjogZnVuY3Rpb24odHlwZSkgewogICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC50cmlnZ2VyKG5hbWVzcGFjZSArIHR5cGUsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIEV2ZW50QnVzOwogICAgfSgpOwogICAgdmFyIEV2ZW50RW1pdHRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIAogICAgICAgIHZhciBzcGxpdHRlciA9IC9ccysvLCBuZXh0VGljayA9IGdldE5leHRUaWNrKCk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgb25TeW5jOiBvblN5bmMsCiAgICAgICAgICAgIG9uQXN5bmM6IG9uQXN5bmMsCiAgICAgICAgICAgIG9mZjogb2ZmLAogICAgICAgICAgICB0cmlnZ2VyOiB0cmlnZ2VyCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBvbihtZXRob2QsIHR5cGVzLCBjYiwgY29udGV4dCkgewogICAgICAgICAgICB2YXIgdHlwZTsKICAgICAgICAgICAgaWYgKCFjYikgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdHlwZXMgPSB0eXBlcy5zcGxpdChzcGxpdHRlcik7CiAgICAgICAgICAgIGNiID0gY29udGV4dCA/IGJpbmRDb250ZXh0KGNiLCBjb250ZXh0KSA6IGNiOwogICAgICAgICAgICB0aGlzLl9jYWxsYmFja3MgPSB0aGlzLl9jYWxsYmFja3MgfHwge307CiAgICAgICAgICAgIHdoaWxlICh0eXBlID0gdHlwZXMuc2hpZnQoKSkgewogICAgICAgICAgICAgICAgdGhpcy5fY2FsbGJhY2tzW3R5cGVdID0gdGhpcy5fY2FsbGJhY2tzW3R5cGVdIHx8IHsKICAgICAgICAgICAgICAgICAgICBzeW5jOiBbXSwKICAgICAgICAgICAgICAgICAgICBhc3luYzogW10KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB0aGlzLl9jYWxsYmFja3NbdHlwZV1bbWV0aG9kXS5wdXNoKGNiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25Bc3luYyh0eXBlcywgY2IsIGNvbnRleHQpIHsKICAgICAgICAgICAgcmV0dXJuIG9uLmNhbGwodGhpcywgImFzeW5jIiwgdHlwZXMsIGNiLCBjb250ZXh0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25TeW5jKHR5cGVzLCBjYiwgY29udGV4dCkgewogICAgICAgICAgICByZXR1cm4gb24uY2FsbCh0aGlzLCAic3luYyIsIHR5cGVzLCBjYiwgY29udGV4dCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9mZih0eXBlcykgewogICAgICAgICAgICB2YXIgdHlwZTsKICAgICAgICAgICAgaWYgKCF0aGlzLl9jYWxsYmFja3MpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHR5cGVzID0gdHlwZXMuc3BsaXQoc3BsaXR0ZXIpOwogICAgICAgICAgICB3aGlsZSAodHlwZSA9IHR5cGVzLnNoaWZ0KCkpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9jYWxsYmFja3NbdHlwZV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyaWdnZXIodHlwZXMpIHsKICAgICAgICAgICAgdmFyIHR5cGUsIGNhbGxiYWNrcywgYXJncywgc3luY0ZsdXNoLCBhc3luY0ZsdXNoOwogICAgICAgICAgICBpZiAoIXRoaXMuX2NhbGxiYWNrcykgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdHlwZXMgPSB0eXBlcy5zcGxpdChzcGxpdHRlcik7CiAgICAgICAgICAgIGFyZ3MgPSBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgIHdoaWxlICgodHlwZSA9IHR5cGVzLnNoaWZ0KCkpICYmIChjYWxsYmFja3MgPSB0aGlzLl9jYWxsYmFja3NbdHlwZV0pKSB7CiAgICAgICAgICAgICAgICBzeW5jRmx1c2ggPSBnZXRGbHVzaChjYWxsYmFja3Muc3luYywgdGhpcywgWyB0eXBlIF0uY29uY2F0KGFyZ3MpKTsKICAgICAgICAgICAgICAgIGFzeW5jRmx1c2ggPSBnZXRGbHVzaChjYWxsYmFja3MuYXN5bmMsIHRoaXMsIFsgdHlwZSBdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgICAgICAgICBzeW5jRmx1c2goKSAmJiBuZXh0VGljayhhc3luY0ZsdXNoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Rmx1c2goY2FsbGJhY2tzLCBjb250ZXh0LCBhcmdzKSB7CiAgICAgICAgICAgIHJldHVybiBmbHVzaDsKICAgICAgICAgICAgZnVuY3Rpb24gZmx1c2goKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FuY2VsbGVkOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGNhbGxiYWNrcy5sZW5ndGg7ICFjYW5jZWxsZWQgJiYgaSA8IGxlbjsgaSArPSAxKSB7CiAgICAgICAgICAgICAgICAgICAgY2FuY2VsbGVkID0gY2FsbGJhY2tzW2ldLmFwcGx5KGNvbnRleHQsIGFyZ3MpID09PSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiAhY2FuY2VsbGVkOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE5leHRUaWNrKCkgewogICAgICAgICAgICB2YXIgbmV4dFRpY2tGbjsKICAgICAgICAgICAgaWYgKHdpbmRvdy5zZXRJbW1lZGlhdGUpIHsKICAgICAgICAgICAgICAgIG5leHRUaWNrRm4gPSBmdW5jdGlvbiBuZXh0VGlja1NldEltbWVkaWF0ZShmbikgewogICAgICAgICAgICAgICAgICAgIHNldEltbWVkaWF0ZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm4oKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXh0VGlja0ZuID0gZnVuY3Rpb24gbmV4dFRpY2tTZXRUaW1lb3V0KGZuKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm4oKTsKICAgICAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5leHRUaWNrRm47CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJpbmRDb250ZXh0KGZuLCBjb250ZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBmbi5iaW5kID8gZm4uYmluZChjb250ZXh0KSA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZm4uYXBwbHkoY29udGV4dCwgW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDApKTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9KCk7CiAgICB2YXIgaGlnaGxpZ2h0ID0gZnVuY3Rpb24oZG9jKSB7CiAgICAgICAgCiAgICAgICAgdmFyIGRlZmF1bHRzID0gewogICAgICAgICAgICBub2RlOiBudWxsLAogICAgICAgICAgICBwYXR0ZXJuOiBudWxsLAogICAgICAgICAgICB0YWdOYW1lOiAic3Ryb25nIiwKICAgICAgICAgICAgY2xhc3NOYW1lOiBudWxsLAogICAgICAgICAgICB3b3Jkc09ubHk6IGZhbHNlLAogICAgICAgICAgICBjYXNlU2Vuc2l0aXZlOiBmYWxzZQogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGhpZ2h0bGlnaHQobykgewogICAgICAgICAgICB2YXIgcmVnZXg7CiAgICAgICAgICAgIG8gPSBfLm1peGluKHt9LCBkZWZhdWx0cywgbyk7CiAgICAgICAgICAgIGlmICghby5ub2RlIHx8ICFvLnBhdHRlcm4pIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBvLnBhdHRlcm4gPSBfLmlzQXJyYXkoby5wYXR0ZXJuKSA/IG8ucGF0dGVybiA6IFsgby5wYXR0ZXJuIF07CiAgICAgICAgICAgIHJlZ2V4ID0gZ2V0UmVnZXgoby5wYXR0ZXJuLCBvLmNhc2VTZW5zaXRpdmUsIG8ud29yZHNPbmx5KTsKICAgICAgICAgICAgdHJhdmVyc2Uoby5ub2RlLCBoaWdodGxpZ2h0VGV4dE5vZGUpOwogICAgICAgICAgICBmdW5jdGlvbiBoaWdodGxpZ2h0VGV4dE5vZGUodGV4dE5vZGUpIHsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCwgcGF0dGVybk5vZGUsIHdyYXBwZXJOb2RlOwogICAgICAgICAgICAgICAgaWYgKG1hdGNoID0gcmVnZXguZXhlYyh0ZXh0Tm9kZS5kYXRhKSkgewogICAgICAgICAgICAgICAgICAgIHdyYXBwZXJOb2RlID0gZG9jLmNyZWF0ZUVsZW1lbnQoby50YWdOYW1lKTsKICAgICAgICAgICAgICAgICAgICBvLmNsYXNzTmFtZSAmJiAod3JhcHBlck5vZGUuY2xhc3NOYW1lID0gby5jbGFzc05hbWUpOwogICAgICAgICAgICAgICAgICAgIHBhdHRlcm5Ob2RlID0gdGV4dE5vZGUuc3BsaXRUZXh0KG1hdGNoLmluZGV4KTsKICAgICAgICAgICAgICAgICAgICBwYXR0ZXJuTm9kZS5zcGxpdFRleHQobWF0Y2hbMF0ubGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICB3cmFwcGVyTm9kZS5hcHBlbmRDaGlsZChwYXR0ZXJuTm9kZS5jbG9uZU5vZGUodHJ1ZSkpOwogICAgICAgICAgICAgICAgICAgIHRleHROb2RlLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKHdyYXBwZXJOb2RlLCBwYXR0ZXJuTm9kZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gISFtYXRjaDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiB0cmF2ZXJzZShlbCwgaGlnaHRsaWdodFRleHROb2RlKSB7CiAgICAgICAgICAgICAgICB2YXIgY2hpbGROb2RlLCBURVhUX05PREVfVFlQRSA9IDM7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGVsLmNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjaGlsZE5vZGUgPSBlbC5jaGlsZE5vZGVzW2ldOwogICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZE5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERV9UWVBFKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGkgKz0gaGlnaHRsaWdodFRleHROb2RlKGNoaWxkTm9kZSkgPyAxIDogMDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0cmF2ZXJzZShjaGlsZE5vZGUsIGhpZ2h0bGlnaHRUZXh0Tm9kZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBnZXRSZWdleChwYXR0ZXJucywgY2FzZVNlbnNpdGl2ZSwgd29yZHNPbmx5KSB7CiAgICAgICAgICAgIHZhciBlc2NhcGVkUGF0dGVybnMgPSBbXSwgcmVnZXhTdHI7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBwYXR0ZXJucy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgZXNjYXBlZFBhdHRlcm5zLnB1c2goXy5lc2NhcGVSZWdFeENoYXJzKHBhdHRlcm5zW2ldKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVnZXhTdHIgPSB3b3Jkc09ubHkgPyAiXFxiKCIgKyBlc2NhcGVkUGF0dGVybnMuam9pbigifCIpICsgIilcXGIiIDogIigiICsgZXNjYXBlZFBhdHRlcm5zLmpvaW4oInwiKSArICIpIjsKICAgICAgICAgICAgcmV0dXJuIGNhc2VTZW5zaXRpdmUgPyBuZXcgUmVnRXhwKHJlZ2V4U3RyKSA6IG5ldyBSZWdFeHAocmVnZXhTdHIsICJpIik7CiAgICAgICAgfQogICAgfSh3aW5kb3cuZG9jdW1lbnQpOwogICAgdmFyIElucHV0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgCiAgICAgICAgdmFyIHNwZWNpYWxLZXlDb2RlTWFwOwogICAgICAgIHNwZWNpYWxLZXlDb2RlTWFwID0gewogICAgICAgICAgICA5OiAidGFiIiwKICAgICAgICAgICAgMjc6ICJlc2MiLAogICAgICAgICAgICAzNzogImxlZnQiLAogICAgICAgICAgICAzOTogInJpZ2h0IiwKICAgICAgICAgICAgMTM6ICJlbnRlciIsCiAgICAgICAgICAgIDM4OiAidXAiLAogICAgICAgICAgICA0MDogImRvd24iCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBJbnB1dChvKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgb25CbHVyLCBvbkZvY3VzLCBvbktleWRvd24sIG9uSW5wdXQ7CiAgICAgICAgICAgIG8gPSBvIHx8IHt9OwogICAgICAgICAgICBpZiAoIW8uaW5wdXQpIHsKICAgICAgICAgICAgICAgICQuZXJyb3IoImlucHV0IGlzIG1pc3NpbmciKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBvbkJsdXIgPSBfLmJpbmQodGhpcy5fb25CbHVyLCB0aGlzKTsKICAgICAgICAgICAgb25Gb2N1cyA9IF8uYmluZCh0aGlzLl9vbkZvY3VzLCB0aGlzKTsKICAgICAgICAgICAgb25LZXlkb3duID0gXy5iaW5kKHRoaXMuX29uS2V5ZG93biwgdGhpcyk7CiAgICAgICAgICAgIG9uSW5wdXQgPSBfLmJpbmQodGhpcy5fb25JbnB1dCwgdGhpcyk7CiAgICAgICAgICAgIHRoaXMuJGhpbnQgPSAkKG8uaGludCk7CiAgICAgICAgICAgIHRoaXMuJGlucHV0ID0gJChvLmlucHV0KS5vbigiYmx1ci50dCIsIG9uQmx1cikub24oImZvY3VzLnR0Iiwgb25Gb2N1cykub24oImtleWRvd24udHQiLCBvbktleWRvd24pOwogICAgICAgICAgICBpZiAodGhpcy4kaGludC5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SGludCA9IHRoaXMuZ2V0SGludCA9IHRoaXMuY2xlYXJIaW50ID0gdGhpcy5jbGVhckhpbnRJZkludmFsaWQgPSBfLm5vb3A7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFfLmlzTXNpZSgpKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRpbnB1dC5vbigiaW5wdXQudHQiLCBvbklucHV0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuJGlucHV0Lm9uKCJrZXlkb3duLnR0IGtleXByZXNzLnR0IGN1dC50dCBwYXN0ZS50dCIsIGZ1bmN0aW9uKCRlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNwZWNpYWxLZXlDb2RlTWFwWyRlLndoaWNoIHx8ICRlLmtleUNvZGVdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgXy5kZWZlcihfLmJpbmQodGhhdC5fb25JbnB1dCwgdGhhdCwgJGUpKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucXVlcnkgPSB0aGlzLiRpbnB1dC52YWwoKTsKICAgICAgICAgICAgdGhpcy4kb3ZlcmZsb3dIZWxwZXIgPSBidWlsZE92ZXJmbG93SGVscGVyKHRoaXMuJGlucHV0KTsKICAgICAgICB9CiAgICAgICAgSW5wdXQubm9ybWFsaXplUXVlcnkgPSBmdW5jdGlvbihzdHIpIHsKICAgICAgICAgICAgcmV0dXJuIChzdHIgfHwgIiIpLnJlcGxhY2UoL15ccyovZywgIiIpLnJlcGxhY2UoL1xzezIsfS9nLCAiICIpOwogICAgICAgIH07CiAgICAgICAgXy5taXhpbihJbnB1dC5wcm90b3R5cGUsIEV2ZW50RW1pdHRlciwgewogICAgICAgICAgICBfb25CbHVyOiBmdW5jdGlvbiBvbkJsdXIoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0SW5wdXRWYWx1ZSgpOwogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCJibHVycmVkIik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9vbkZvY3VzOiBmdW5jdGlvbiBvbkZvY3VzKCkgewogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCJmb2N1c2VkIik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9vbktleWRvd246IGZ1bmN0aW9uIG9uS2V5ZG93bigkZSkgewogICAgICAgICAgICAgICAgdmFyIGtleU5hbWUgPSBzcGVjaWFsS2V5Q29kZU1hcFskZS53aGljaCB8fCAkZS5rZXlDb2RlXTsKICAgICAgICAgICAgICAgIHRoaXMuX21hbmFnZVByZXZlbnREZWZhdWx0KGtleU5hbWUsICRlKTsKICAgICAgICAgICAgICAgIGlmIChrZXlOYW1lICYmIHRoaXMuX3Nob3VsZFRyaWdnZXIoa2V5TmFtZSwgJGUpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKGtleU5hbWUgKyAiS2V5ZWQiLCAkZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9vbklucHV0OiBmdW5jdGlvbiBvbklucHV0KCkgewogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tJbnB1dFZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9tYW5hZ2VQcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24gbWFuYWdlUHJldmVudERlZmF1bHQoa2V5TmFtZSwgJGUpIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2ZW50RGVmYXVsdCwgaGludFZhbHVlLCBpbnB1dFZhbHVlOwogICAgICAgICAgICAgICAgc3dpdGNoIChrZXlOYW1lKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgInRhYiI6CiAgICAgICAgICAgICAgICAgICAgaGludFZhbHVlID0gdGhpcy5nZXRIaW50KCk7CiAgICAgICAgICAgICAgICAgICAgaW5wdXRWYWx1ZSA9IHRoaXMuZ2V0SW5wdXRWYWx1ZSgpOwogICAgICAgICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0ID0gaGludFZhbHVlICYmIGhpbnRWYWx1ZSAhPT0gaW5wdXRWYWx1ZSAmJiAhd2l0aE1vZGlmaWVyKCRlKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgIGNhc2UgInVwIjoKICAgICAgICAgICAgICAgICAgY2FzZSAiZG93biI6CiAgICAgICAgICAgICAgICAgICAgcHJldmVudERlZmF1bHQgPSAhd2l0aE1vZGlmaWVyKCRlKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgcHJldmVudERlZmF1bHQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0ICYmICRlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9zaG91bGRUcmlnZ2VyOiBmdW5jdGlvbiBzaG91bGRUcmlnZ2VyKGtleU5hbWUsICRlKSB7CiAgICAgICAgICAgICAgICB2YXIgdHJpZ2dlcjsKICAgICAgICAgICAgICAgIHN3aXRjaCAoa2V5TmFtZSkgewogICAgICAgICAgICAgICAgICBjYXNlICJ0YWIiOgogICAgICAgICAgICAgICAgICAgIHRyaWdnZXIgPSAhd2l0aE1vZGlmaWVyKCRlKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgdHJpZ2dlciA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdHJpZ2dlcjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX2NoZWNrSW5wdXRWYWx1ZTogZnVuY3Rpb24gY2hlY2tJbnB1dFZhbHVlKCkgewogICAgICAgICAgICAgICAgdmFyIGlucHV0VmFsdWUsIGFyZUVxdWl2YWxlbnQsIGhhc0RpZmZlcmVudFdoaXRlc3BhY2U7CiAgICAgICAgICAgICAgICBpbnB1dFZhbHVlID0gdGhpcy5nZXRJbnB1dFZhbHVlKCk7CiAgICAgICAgICAgICAgICBhcmVFcXVpdmFsZW50ID0gYXJlUXVlcmllc0VxdWl2YWxlbnQoaW5wdXRWYWx1ZSwgdGhpcy5xdWVyeSk7CiAgICAgICAgICAgICAgICBoYXNEaWZmZXJlbnRXaGl0ZXNwYWNlID0gYXJlRXF1aXZhbGVudCA/IHRoaXMucXVlcnkubGVuZ3RoICE9PSBpbnB1dFZhbHVlLmxlbmd0aCA6IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5xdWVyeSA9IGlucHV0VmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoIWFyZUVxdWl2YWxlbnQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoInF1ZXJ5Q2hhbmdlZCIsIHRoaXMucXVlcnkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXNEaWZmZXJlbnRXaGl0ZXNwYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCJ3aGl0ZXNwYWNlQ2hhbmdlZCIsIHRoaXMucXVlcnkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBmb2N1czogZnVuY3Rpb24gZm9jdXMoKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRpbnB1dC5mb2N1cygpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBibHVyOiBmdW5jdGlvbiBibHVyKCkgewogICAgICAgICAgICAgICAgdGhpcy4kaW5wdXQuYmx1cigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXRRdWVyeTogZnVuY3Rpb24gZ2V0UXVlcnkoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5xdWVyeTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0UXVlcnk6IGZ1bmN0aW9uIHNldFF1ZXJ5KHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICB0aGlzLnF1ZXJ5ID0gcXVlcnk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldElucHV0VmFsdWU6IGZ1bmN0aW9uIGdldElucHV0VmFsdWUoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kaW5wdXQudmFsKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldElucHV0VmFsdWU6IGZ1bmN0aW9uIHNldElucHV0VmFsdWUodmFsdWUsIHNpbGVudCkgewogICAgICAgICAgICAgICAgdGhpcy4kaW5wdXQudmFsKHZhbHVlKTsKICAgICAgICAgICAgICAgIHNpbGVudCA/IHRoaXMuY2xlYXJIaW50KCkgOiB0aGlzLl9jaGVja0lucHV0VmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcmVzZXRJbnB1dFZhbHVlOiBmdW5jdGlvbiByZXNldElucHV0VmFsdWUoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0VmFsdWUodGhpcy5xdWVyeSwgdHJ1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldEhpbnQ6IGZ1bmN0aW9uIGdldEhpbnQoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kaGludC52YWwoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0SGludDogZnVuY3Rpb24gc2V0SGludCh2YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy4kaGludC52YWwodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjbGVhckhpbnQ6IGZ1bmN0aW9uIGNsZWFySGludCgpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SGludCgiIik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNsZWFySGludElmSW52YWxpZDogZnVuY3Rpb24gY2xlYXJIaW50SWZJbnZhbGlkKCkgewogICAgICAgICAgICAgICAgdmFyIHZhbCwgaGludCwgdmFsSXNQcmVmaXhPZkhpbnQsIGlzVmFsaWQ7CiAgICAgICAgICAgICAgICB2YWwgPSB0aGlzLmdldElucHV0VmFsdWUoKTsKICAgICAgICAgICAgICAgIGhpbnQgPSB0aGlzLmdldEhpbnQoKTsKICAgICAgICAgICAgICAgIHZhbElzUHJlZml4T2ZIaW50ID0gdmFsICE9PSBoaW50ICYmIGhpbnQuaW5kZXhPZih2YWwpID09PSAwOwogICAgICAgICAgICAgICAgaXNWYWxpZCA9IHZhbCAhPT0gIiIgJiYgdmFsSXNQcmVmaXhPZkhpbnQgJiYgIXRoaXMuaGFzT3ZlcmZsb3coKTsKICAgICAgICAgICAgICAgICFpc1ZhbGlkICYmIHRoaXMuY2xlYXJIaW50KCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldExhbmd1YWdlRGlyZWN0aW9uOiBmdW5jdGlvbiBnZXRMYW5ndWFnZURpcmVjdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiAodGhpcy4kaW5wdXQuY3NzKCJkaXJlY3Rpb24iKSB8fCAibHRyIikudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaGFzT3ZlcmZsb3c6IGZ1bmN0aW9uIGhhc092ZXJmbG93KCkgewogICAgICAgICAgICAgICAgdmFyIGNvbnN0cmFpbnQgPSB0aGlzLiRpbnB1dC53aWR0aCgpIC0gMjsKICAgICAgICAgICAgICAgIHRoaXMuJG92ZXJmbG93SGVscGVyLnRleHQodGhpcy5nZXRJbnB1dFZhbHVlKCkpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJG92ZXJmbG93SGVscGVyLndpZHRoKCkgPj0gY29uc3RyYWludDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNDdXJzb3JBdEVuZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWVMZW5ndGgsIHNlbGVjdGlvblN0YXJ0LCByYW5nZTsKICAgICAgICAgICAgICAgIHZhbHVlTGVuZ3RoID0gdGhpcy4kaW5wdXQudmFsKCkubGVuZ3RoOwogICAgICAgICAgICAgICAgc2VsZWN0aW9uU3RhcnQgPSB0aGlzLiRpbnB1dFswXS5zZWxlY3Rpb25TdGFydDsKICAgICAgICAgICAgICAgIGlmIChfLmlzTnVtYmVyKHNlbGVjdGlvblN0YXJ0KSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBzZWxlY3Rpb25TdGFydCA9PT0gdmFsdWVMZW5ndGg7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRvY3VtZW50LnNlbGVjdGlvbikgewogICAgICAgICAgICAgICAgICAgIHJhbmdlID0gZG9jdW1lbnQuc2VsZWN0aW9uLmNyZWF0ZVJhbmdlKCk7CiAgICAgICAgICAgICAgICAgICAgcmFuZ2UubW92ZVN0YXJ0KCJjaGFyYWN0ZXIiLCAtdmFsdWVMZW5ndGgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZUxlbmd0aCA9PT0gcmFuZ2UudGV4dC5sZW5ndGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgICAgICAgICAgIHRoaXMuJGhpbnQub2ZmKCIudHQiKTsKICAgICAgICAgICAgICAgIHRoaXMuJGlucHV0Lm9mZigiLnR0Iik7CiAgICAgICAgICAgICAgICB0aGlzLiRoaW50ID0gdGhpcy4kaW5wdXQgPSB0aGlzLiRvdmVyZmxvd0hlbHBlciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gSW5wdXQ7CiAgICAgICAgZnVuY3Rpb24gYnVpbGRPdmVyZmxvd0hlbHBlcigkaW5wdXQpIHsKICAgICAgICAgICAgcmV0dXJuICQoJzxwcmUgYXJpYS1oaWRkZW49InRydWUiPjwvcHJlPicpLmNzcyh7CiAgICAgICAgICAgICAgICBwb3NpdGlvbjogImFic29sdXRlIiwKICAgICAgICAgICAgICAgIHZpc2liaWxpdHk6ICJoaWRkZW4iLAogICAgICAgICAgICAgICAgd2hpdGVTcGFjZTogInByZSIsCiAgICAgICAgICAgICAgICBmb250RmFtaWx5OiAkaW5wdXQuY3NzKCJmb250LWZhbWlseSIpLAogICAgICAgICAgICAgICAgZm9udFNpemU6ICRpbnB1dC5jc3MoImZvbnQtc2l6ZSIpLAogICAgICAgICAgICAgICAgZm9udFN0eWxlOiAkaW5wdXQuY3NzKCJmb250LXN0eWxlIiksCiAgICAgICAgICAgICAgICBmb250VmFyaWFudDogJGlucHV0LmNzcygiZm9udC12YXJpYW50IiksCiAgICAgICAgICAgICAgICBmb250V2VpZ2h0OiAkaW5wdXQuY3NzKCJmb250LXdlaWdodCIpLAogICAgICAgICAgICAgICAgd29yZFNwYWNpbmc6ICRpbnB1dC5jc3MoIndvcmQtc3BhY2luZyIpLAogICAgICAgICAgICAgICAgbGV0dGVyU3BhY2luZzogJGlucHV0LmNzcygibGV0dGVyLXNwYWNpbmciKSwKICAgICAgICAgICAgICAgIHRleHRJbmRlbnQ6ICRpbnB1dC5jc3MoInRleHQtaW5kZW50IiksCiAgICAgICAgICAgICAgICB0ZXh0UmVuZGVyaW5nOiAkaW5wdXQuY3NzKCJ0ZXh0LXJlbmRlcmluZyIpLAogICAgICAgICAgICAgICAgdGV4dFRyYW5zZm9ybTogJGlucHV0LmNzcygidGV4dC10cmFuc2Zvcm0iKQogICAgICAgICAgICB9KS5pbnNlcnRBZnRlcigkaW5wdXQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcmVRdWVyaWVzRXF1aXZhbGVudChhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBJbnB1dC5ub3JtYWxpemVRdWVyeShhKSA9PT0gSW5wdXQubm9ybWFsaXplUXVlcnkoYik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdpdGhNb2RpZmllcigkZSkgewogICAgICAgICAgICByZXR1cm4gJGUuYWx0S2V5IHx8ICRlLmN0cmxLZXkgfHwgJGUubWV0YUtleSB8fCAkZS5zaGlmdEtleTsKICAgICAgICB9CiAgICB9KCk7CiAgICB2YXIgRGF0YXNldCA9IGZ1bmN0aW9uKCkgewogICAgICAgIAogICAgICAgIHZhciBkYXRhc2V0S2V5ID0gInR0RGF0YXNldCIsIHZhbHVlS2V5ID0gInR0VmFsdWUiLCBkYXR1bUtleSA9ICJ0dERhdHVtIjsKICAgICAgICBmdW5jdGlvbiBEYXRhc2V0KG8pIHsKICAgICAgICAgICAgbyA9IG8gfHwge307CiAgICAgICAgICAgIG8udGVtcGxhdGVzID0gby50ZW1wbGF0ZXMgfHwge307CiAgICAgICAgICAgIGlmICghby5zb3VyY2UpIHsKICAgICAgICAgICAgICAgICQuZXJyb3IoIm1pc3Npbmcgc291cmNlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG8ubmFtZSAmJiAhaXNWYWxpZE5hbWUoby5uYW1lKSkgewogICAgICAgICAgICAgICAgJC5lcnJvcigiaW52YWxpZCBkYXRhc2V0IG5hbWU6ICIgKyBvLm5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucXVlcnkgPSBudWxsOwogICAgICAgICAgICB0aGlzLmhpZ2hsaWdodCA9ICEhby5oaWdobGlnaHQ7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IG8ubmFtZSB8fCBfLmdldFVuaXF1ZUlkKCk7CiAgICAgICAgICAgIHRoaXMuc291cmNlID0gby5zb3VyY2U7CiAgICAgICAgICAgIHRoaXMuZGlzcGxheUZuID0gZ2V0RGlzcGxheUZuKG8uZGlzcGxheSB8fCBvLmRpc3BsYXlLZXkpOwogICAgICAgICAgICB0aGlzLnRlbXBsYXRlcyA9IGdldFRlbXBsYXRlcyhvLnRlbXBsYXRlcywgdGhpcy5kaXNwbGF5Rm4pOwogICAgICAgICAgICB0aGlzLiRlbCA9ICQoaHRtbC5kYXRhc2V0LnJlcGxhY2UoIiVDTEFTUyUiLCB0aGlzLm5hbWUpKTsKICAgICAgICB9CiAgICAgICAgRGF0YXNldC5leHRyYWN0RGF0YXNldE5hbWUgPSBmdW5jdGlvbiBleHRyYWN0RGF0YXNldE5hbWUoZWwpIHsKICAgICAgICAgICAgcmV0dXJuICQoZWwpLmRhdGEoZGF0YXNldEtleSk7CiAgICAgICAgfTsKICAgICAgICBEYXRhc2V0LmV4dHJhY3RWYWx1ZSA9IGZ1bmN0aW9uIGV4dHJhY3REYXR1bShlbCkgewogICAgICAgICAgICByZXR1cm4gJChlbCkuZGF0YSh2YWx1ZUtleSk7CiAgICAgICAgfTsKICAgICAgICBEYXRhc2V0LmV4dHJhY3REYXR1bSA9IGZ1bmN0aW9uIGV4dHJhY3REYXR1bShlbCkgewogICAgICAgICAgICByZXR1cm4gJChlbCkuZGF0YShkYXR1bUtleSk7CiAgICAgICAgfTsKICAgICAgICBfLm1peGluKERhdGFzZXQucHJvdG90eXBlLCBFdmVudEVtaXR0ZXIsIHsKICAgICAgICAgICAgX3JlbmRlcjogZnVuY3Rpb24gcmVuZGVyKHF1ZXJ5LCBzdWdnZXN0aW9ucykgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLiRlbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgaGFzU3VnZ2VzdGlvbnM7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5lbXB0eSgpOwogICAgICAgICAgICAgICAgaGFzU3VnZ2VzdGlvbnMgPSBzdWdnZXN0aW9ucyAmJiBzdWdnZXN0aW9ucy5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAoIWhhc1N1Z2dlc3Rpb25zICYmIHRoaXMudGVtcGxhdGVzLmVtcHR5KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuaHRtbChnZXRFbXB0eUh0bWwoKSkucHJlcGVuZCh0aGF0LnRlbXBsYXRlcy5oZWFkZXIgPyBnZXRIZWFkZXJIdG1sKCkgOiBudWxsKS5hcHBlbmQodGhhdC50ZW1wbGF0ZXMuZm9vdGVyID8gZ2V0Rm9vdGVySHRtbCgpIDogbnVsbCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhc1N1Z2dlc3Rpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuaHRtbChnZXRTdWdnZXN0aW9uc0h0bWwoKSkucHJlcGVuZCh0aGF0LnRlbXBsYXRlcy5oZWFkZXIgPyBnZXRIZWFkZXJIdG1sKCkgOiBudWxsKS5hcHBlbmQodGhhdC50ZW1wbGF0ZXMuZm9vdGVyID8gZ2V0Rm9vdGVySHRtbCgpIDogbnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoInJlbmRlcmVkIik7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBnZXRFbXB0eUh0bWwoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoYXQudGVtcGxhdGVzLmVtcHR5KHsKICAgICAgICAgICAgICAgICAgICAgICAgcXVlcnk6IHF1ZXJ5LAogICAgICAgICAgICAgICAgICAgICAgICBpc0VtcHR5OiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBnZXRTdWdnZXN0aW9uc0h0bWwoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyICRzdWdnZXN0aW9ucywgbm9kZXM7CiAgICAgICAgICAgICAgICAgICAgJHN1Z2dlc3Rpb25zID0gJChodG1sLnN1Z2dlc3Rpb25zKS5jc3MoY3NzLnN1Z2dlc3Rpb25zKTsKICAgICAgICAgICAgICAgICAgICBub2RlcyA9IF8ubWFwKHN1Z2dlc3Rpb25zLCBnZXRTdWdnZXN0aW9uTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgJHN1Z2dlc3Rpb25zLmFwcGVuZC5hcHBseSgkc3VnZ2VzdGlvbnMsIG5vZGVzKTsKICAgICAgICAgICAgICAgICAgICB0aGF0LmhpZ2hsaWdodCAmJiBoaWdobGlnaHQoewogICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU6ICJ0dC1oaWdobGlnaHQiLAogICAgICAgICAgICAgICAgICAgICAgICBub2RlOiAkc3VnZ2VzdGlvbnNbMF0sCiAgICAgICAgICAgICAgICAgICAgICAgIHBhdHRlcm46IHF1ZXJ5CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRzdWdnZXN0aW9uczsKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBnZXRTdWdnZXN0aW9uTm9kZShzdWdnZXN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciAkZWw7CiAgICAgICAgICAgICAgICAgICAgICAgICRlbCA9ICQoaHRtbC5zdWdnZXN0aW9uKS5hcHBlbmQodGhhdC50ZW1wbGF0ZXMuc3VnZ2VzdGlvbihzdWdnZXN0aW9uKSkuZGF0YShkYXRhc2V0S2V5LCB0aGF0Lm5hbWUpLmRhdGEodmFsdWVLZXksIHRoYXQuZGlzcGxheUZuKHN1Z2dlc3Rpb24pKS5kYXRhKGRhdHVtS2V5LCBzdWdnZXN0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgJGVsLmNoaWxkcmVuKCkuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykuY3NzKGNzcy5zdWdnZXN0aW9uQ2hpbGQpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRlbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBnZXRIZWFkZXJIdG1sKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGF0LnRlbXBsYXRlcy5oZWFkZXIoewogICAgICAgICAgICAgICAgICAgICAgICBxdWVyeTogcXVlcnksCiAgICAgICAgICAgICAgICAgICAgICAgIGlzRW1wdHk6ICFoYXNTdWdnZXN0aW9ucwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0Rm9vdGVySHRtbCgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC50ZW1wbGF0ZXMuZm9vdGVyKHsKICAgICAgICAgICAgICAgICAgICAgICAgcXVlcnk6IHF1ZXJ5LAogICAgICAgICAgICAgICAgICAgICAgICBpc0VtcHR5OiAhaGFzU3VnZ2VzdGlvbnMKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0Um9vdDogZnVuY3Rpb24gZ2V0Um9vdCgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiRlbDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXBkYXRlOiBmdW5jdGlvbiB1cGRhdGUocXVlcnkpIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgIHRoaXMucXVlcnkgPSBxdWVyeTsKICAgICAgICAgICAgICAgIHRoaXMuY2FuY2VsZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuc291cmNlKHF1ZXJ5LCByZW5kZXIpOwogICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVuZGVyKHN1Z2dlc3Rpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGF0LmNhbmNlbGVkICYmIHF1ZXJ5ID09PSB0aGF0LnF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuX3JlbmRlcihxdWVyeSwgc3VnZ2VzdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2FuY2VsOiBmdW5jdGlvbiBjYW5jZWwoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbmNlbGVkID0gdHJ1ZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2xlYXI6IGZ1bmN0aW9uIGNsZWFyKCkgewogICAgICAgICAgICAgICAgdGhpcy5jYW5jZWwoKTsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmVtcHR5KCk7CiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoInJlbmRlcmVkIik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlzRW1wdHk6IGZ1bmN0aW9uIGlzRW1wdHkoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kZWwuaXMoIjplbXB0eSIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICAgICAgICAgICAgdGhpcy4kZWwgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIERhdGFzZXQ7CiAgICAgICAgZnVuY3Rpb24gZ2V0RGlzcGxheUZuKGRpc3BsYXkpIHsKICAgICAgICAgICAgZGlzcGxheSA9IGRpc3BsYXkgfHwgInZhbHVlIjsKICAgICAgICAgICAgcmV0dXJuIF8uaXNGdW5jdGlvbihkaXNwbGF5KSA/IGRpc3BsYXkgOiBkaXNwbGF5Rm47CiAgICAgICAgICAgIGZ1bmN0aW9uIGRpc3BsYXlGbihvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiBvYmpbZGlzcGxheV07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VGVtcGxhdGVzKHRlbXBsYXRlcywgZGlzcGxheUZuKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBlbXB0eTogdGVtcGxhdGVzLmVtcHR5ICYmIF8udGVtcGxhdGlmeSh0ZW1wbGF0ZXMuZW1wdHkpLAogICAgICAgICAgICAgICAgaGVhZGVyOiB0ZW1wbGF0ZXMuaGVhZGVyICYmIF8udGVtcGxhdGlmeSh0ZW1wbGF0ZXMuaGVhZGVyKSwKICAgICAgICAgICAgICAgIGZvb3RlcjogdGVtcGxhdGVzLmZvb3RlciAmJiBfLnRlbXBsYXRpZnkodGVtcGxhdGVzLmZvb3RlciksCiAgICAgICAgICAgICAgICBzdWdnZXN0aW9uOiB0ZW1wbGF0ZXMuc3VnZ2VzdGlvbiB8fCBzdWdnZXN0aW9uVGVtcGxhdGUKICAgICAgICAgICAgfTsKICAgICAgICAgICAgZnVuY3Rpb24gc3VnZ2VzdGlvblRlbXBsYXRlKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiPHA+IiArIGRpc3BsYXlGbihjb250ZXh0KSArICI8L3A+IjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1ZhbGlkTmFtZShzdHIpIHsKICAgICAgICAgICAgcmV0dXJuIC9eW19hLXpBLVowLTktXSskLy50ZXN0KHN0cik7CiAgICAgICAgfQogICAgfSgpOwogICAgdmFyIERyb3Bkb3duID0gZnVuY3Rpb24oKSB7CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gRHJvcGRvd24obykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIG9uU3VnZ2VzdGlvbkNsaWNrLCBvblN1Z2dlc3Rpb25Nb3VzZUVudGVyLCBvblN1Z2dlc3Rpb25Nb3VzZUxlYXZlOwogICAgICAgICAgICBvID0gbyB8fCB7fTsKICAgICAgICAgICAgaWYgKCFvLm1lbnUpIHsKICAgICAgICAgICAgICAgICQuZXJyb3IoIm1lbnUgaXMgcmVxdWlyZWQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlzT3BlbiA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzRW1wdHkgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmRhdGFzZXRzID0gXy5tYXAoby5kYXRhc2V0cywgaW5pdGlhbGl6ZURhdGFzZXQpOwogICAgICAgICAgICBvblN1Z2dlc3Rpb25DbGljayA9IF8uYmluZCh0aGlzLl9vblN1Z2dlc3Rpb25DbGljaywgdGhpcyk7CiAgICAgICAgICAgIG9uU3VnZ2VzdGlvbk1vdXNlRW50ZXIgPSBfLmJpbmQodGhpcy5fb25TdWdnZXN0aW9uTW91c2VFbnRlciwgdGhpcyk7CiAgICAgICAgICAgIG9uU3VnZ2VzdGlvbk1vdXNlTGVhdmUgPSBfLmJpbmQodGhpcy5fb25TdWdnZXN0aW9uTW91c2VMZWF2ZSwgdGhpcyk7CiAgICAgICAgICAgIHRoaXMuJG1lbnUgPSAkKG8ubWVudSkub24oImNsaWNrLnR0IiwgIi50dC1zdWdnZXN0aW9uIiwgb25TdWdnZXN0aW9uQ2xpY2spLm9uKCJtb3VzZWVudGVyLnR0IiwgIi50dC1zdWdnZXN0aW9uIiwgb25TdWdnZXN0aW9uTW91c2VFbnRlcikub24oIm1vdXNlbGVhdmUudHQiLCAiLnR0LXN1Z2dlc3Rpb24iLCBvblN1Z2dlc3Rpb25Nb3VzZUxlYXZlKTsKICAgICAgICAgICAgXy5lYWNoKHRoaXMuZGF0YXNldHMsIGZ1bmN0aW9uKGRhdGFzZXQpIHsKICAgICAgICAgICAgICAgIHRoYXQuJG1lbnUuYXBwZW5kKGRhdGFzZXQuZ2V0Um9vdCgpKTsKICAgICAgICAgICAgICAgIGRhdGFzZXQub25TeW5jKCJyZW5kZXJlZCIsIHRoYXQuX29uUmVuZGVyZWQsIHRoYXQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgXy5taXhpbihEcm9wZG93bi5wcm90b3R5cGUsIEV2ZW50RW1pdHRlciwgewogICAgICAgICAgICBfb25TdWdnZXN0aW9uQ2xpY2s6IGZ1bmN0aW9uIG9uU3VnZ2VzdGlvbkNsaWNrKCRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoInN1Z2dlc3Rpb25DbGlja2VkIiwgJCgkZS5jdXJyZW50VGFyZ2V0KSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9vblN1Z2dlc3Rpb25Nb3VzZUVudGVyOiBmdW5jdGlvbiBvblN1Z2dlc3Rpb25Nb3VzZUVudGVyKCRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9yZW1vdmVDdXJzb3IoKTsKICAgICAgICAgICAgICAgIHRoaXMuX3NldEN1cnNvcigkKCRlLmN1cnJlbnRUYXJnZXQpLCB0cnVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uU3VnZ2VzdGlvbk1vdXNlTGVhdmU6IGZ1bmN0aW9uIG9uU3VnZ2VzdGlvbk1vdXNlTGVhdmUoKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9yZW1vdmVDdXJzb3IoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uUmVuZGVyZWQ6IGZ1bmN0aW9uIG9uUmVuZGVyZWQoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzRW1wdHkgPSBfLmV2ZXJ5KHRoaXMuZGF0YXNldHMsIGlzRGF0YXNldEVtcHR5KTsKICAgICAgICAgICAgICAgIHRoaXMuaXNFbXB0eSA/IHRoaXMuX2hpZGUoKSA6IHRoaXMuaXNPcGVuICYmIHRoaXMuX3Nob3coKTsKICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcigiZGF0YXNldFJlbmRlcmVkIik7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBpc0RhdGFzZXRFbXB0eShkYXRhc2V0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGFzZXQuaXNFbXB0eSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBfaGlkZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRtZW51LmhpZGUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX3Nob3c6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGhpcy4kbWVudS5jc3MoImRpc3BsYXkiLCAiYmxvY2siKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX2dldFN1Z2dlc3Rpb25zOiBmdW5jdGlvbiBnZXRTdWdnZXN0aW9ucygpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiRtZW51LmZpbmQoIi50dC1zdWdnZXN0aW9uIik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9nZXRDdXJzb3I6IGZ1bmN0aW9uIGdldEN1cnNvcigpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiRtZW51LmZpbmQoIi50dC1jdXJzb3IiKS5maXJzdCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfc2V0Q3Vyc29yOiBmdW5jdGlvbiBzZXRDdXJzb3IoJGVsLCBzaWxlbnQpIHsKICAgICAgICAgICAgICAgICRlbC5maXJzdCgpLmFkZENsYXNzKCJ0dC1jdXJzb3IiKTsKICAgICAgICAgICAgICAgICFzaWxlbnQgJiYgdGhpcy50cmlnZ2VyKCJjdXJzb3JNb3ZlZCIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfcmVtb3ZlQ3Vyc29yOiBmdW5jdGlvbiByZW1vdmVDdXJzb3IoKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9nZXRDdXJzb3IoKS5yZW1vdmVDbGFzcygidHQtY3Vyc29yIik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9tb3ZlQ3Vyc29yOiBmdW5jdGlvbiBtb3ZlQ3Vyc29yKGluY3JlbWVudCkgewogICAgICAgICAgICAgICAgdmFyICRzdWdnZXN0aW9ucywgJG9sZEN1cnNvciwgbmV3Q3Vyc29ySW5kZXgsICRuZXdDdXJzb3I7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNPcGVuKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJG9sZEN1cnNvciA9IHRoaXMuX2dldEN1cnNvcigpOwogICAgICAgICAgICAgICAgJHN1Z2dlc3Rpb25zID0gdGhpcy5fZ2V0U3VnZ2VzdGlvbnMoKTsKICAgICAgICAgICAgICAgIHRoaXMuX3JlbW92ZUN1cnNvcigpOwogICAgICAgICAgICAgICAgbmV3Q3Vyc29ySW5kZXggPSAkc3VnZ2VzdGlvbnMuaW5kZXgoJG9sZEN1cnNvcikgKyBpbmNyZW1lbnQ7CiAgICAgICAgICAgICAgICBuZXdDdXJzb3JJbmRleCA9IChuZXdDdXJzb3JJbmRleCArIDEpICUgKCRzdWdnZXN0aW9ucy5sZW5ndGggKyAxKSAtIDE7CiAgICAgICAgICAgICAgICBpZiAobmV3Q3Vyc29ySW5kZXggPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCJjdXJzb3JSZW1vdmVkIik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuZXdDdXJzb3JJbmRleCA8IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgbmV3Q3Vyc29ySW5kZXggPSAkc3VnZ2VzdGlvbnMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX3NldEN1cnNvcigkbmV3Q3Vyc29yID0gJHN1Z2dlc3Rpb25zLmVxKG5ld0N1cnNvckluZGV4KSk7CiAgICAgICAgICAgICAgICB0aGlzLl9lbnN1cmVWaXNpYmxlKCRuZXdDdXJzb3IpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfZW5zdXJlVmlzaWJsZTogZnVuY3Rpb24gZW5zdXJlVmlzaWJsZSgkZWwpIHsKICAgICAgICAgICAgICAgIHZhciBlbFRvcCwgZWxCb3R0b20sIG1lbnVTY3JvbGxUb3AsIG1lbnVIZWlnaHQ7CiAgICAgICAgICAgICAgICBlbFRvcCA9ICRlbC5wb3NpdGlvbigpLnRvcDsKICAgICAgICAgICAgICAgIGVsQm90dG9tID0gZWxUb3AgKyAkZWwub3V0ZXJIZWlnaHQodHJ1ZSk7CiAgICAgICAgICAgICAgICBtZW51U2Nyb2xsVG9wID0gdGhpcy4kbWVudS5zY3JvbGxUb3AoKTsKICAgICAgICAgICAgICAgIG1lbnVIZWlnaHQgPSB0aGlzLiRtZW51LmhlaWdodCgpICsgcGFyc2VJbnQodGhpcy4kbWVudS5jc3MoInBhZGRpbmdUb3AiKSwgMTApICsgcGFyc2VJbnQodGhpcy4kbWVudS5jc3MoInBhZGRpbmdCb3R0b20iKSwgMTApOwogICAgICAgICAgICAgICAgaWYgKGVsVG9wIDwgMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJG1lbnUuc2Nyb2xsVG9wKG1lbnVTY3JvbGxUb3AgKyBlbFRvcCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1lbnVIZWlnaHQgPCBlbEJvdHRvbSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJG1lbnUuc2Nyb2xsVG9wKG1lbnVTY3JvbGxUb3AgKyAoZWxCb3R0b20gLSBtZW51SGVpZ2h0KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNsb3NlOiBmdW5jdGlvbiBjbG9zZSgpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzT3BlbikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaXNPcGVuID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVtb3ZlQ3Vyc29yKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcigiY2xvc2VkIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9wZW46IGZ1bmN0aW9uIG9wZW4oKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNPcGVuKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc09wZW4gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICF0aGlzLmlzRW1wdHkgJiYgdGhpcy5fc2hvdygpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcigib3BlbmVkIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldExhbmd1YWdlRGlyZWN0aW9uOiBmdW5jdGlvbiBzZXRMYW5ndWFnZURpcmVjdGlvbihkaXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuJG1lbnUuY3NzKGRpciA9PT0gImx0ciIgPyBjc3MubHRyIDogY3NzLnJ0bCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG1vdmVDdXJzb3JVcDogZnVuY3Rpb24gbW92ZUN1cnNvclVwKCkgewogICAgICAgICAgICAgICAgdGhpcy5fbW92ZUN1cnNvcigtMSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG1vdmVDdXJzb3JEb3duOiBmdW5jdGlvbiBtb3ZlQ3Vyc29yRG93bigpIHsKICAgICAgICAgICAgICAgIHRoaXMuX21vdmVDdXJzb3IoKzEpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXREYXR1bUZvclN1Z2dlc3Rpb246IGZ1bmN0aW9uIGdldERhdHVtRm9yU3VnZ2VzdGlvbigkZWwpIHsKICAgICAgICAgICAgICAgIHZhciBkYXR1bSA9IG51bGw7CiAgICAgICAgICAgICAgICBpZiAoJGVsLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGRhdHVtID0gewogICAgICAgICAgICAgICAgICAgICAgICByYXc6IERhdGFzZXQuZXh0cmFjdERhdHVtKCRlbCksCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBEYXRhc2V0LmV4dHJhY3RWYWx1ZSgkZWwpLAogICAgICAgICAgICAgICAgICAgICAgICBkYXRhc2V0TmFtZTogRGF0YXNldC5leHRyYWN0RGF0YXNldE5hbWUoJGVsKQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZGF0dW07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldERhdHVtRm9yQ3Vyc29yOiBmdW5jdGlvbiBnZXREYXR1bUZvckN1cnNvcigpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldERhdHVtRm9yU3VnZ2VzdGlvbih0aGlzLl9nZXRDdXJzb3IoKS5maXJzdCgpKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0RGF0dW1Gb3JUb3BTdWdnZXN0aW9uOiBmdW5jdGlvbiBnZXREYXR1bUZvclRvcFN1Z2dlc3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXREYXR1bUZvclN1Z2dlc3Rpb24odGhpcy5fZ2V0U3VnZ2VzdGlvbnMoKS5maXJzdCgpKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXBkYXRlOiBmdW5jdGlvbiB1cGRhdGUocXVlcnkpIHsKICAgICAgICAgICAgICAgIF8uZWFjaCh0aGlzLmRhdGFzZXRzLCB1cGRhdGVEYXRhc2V0KTsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZURhdGFzZXQoZGF0YXNldCkgewogICAgICAgICAgICAgICAgICAgIGRhdGFzZXQudXBkYXRlKHF1ZXJ5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZW1wdHk6IGZ1bmN0aW9uIGVtcHR5KCkgewogICAgICAgICAgICAgICAgXy5lYWNoKHRoaXMuZGF0YXNldHMsIGNsZWFyRGF0YXNldCk7CiAgICAgICAgICAgICAgICB0aGlzLmlzRW1wdHkgPSB0cnVlOwogICAgICAgICAgICAgICAgZnVuY3Rpb24gY2xlYXJEYXRhc2V0KGRhdGFzZXQpIHsKICAgICAgICAgICAgICAgICAgICBkYXRhc2V0LmNsZWFyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlzVmlzaWJsZTogZnVuY3Rpb24gaXNWaXNpYmxlKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaXNPcGVuICYmICF0aGlzLmlzRW1wdHk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRtZW51Lm9mZigiLnR0Iik7CiAgICAgICAgICAgICAgICB0aGlzLiRtZW51ID0gbnVsbDsKICAgICAgICAgICAgICAgIF8uZWFjaCh0aGlzLmRhdGFzZXRzLCBkZXN0cm95RGF0YXNldCk7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBkZXN0cm95RGF0YXNldChkYXRhc2V0KSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YXNldC5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gRHJvcGRvd247CiAgICAgICAgZnVuY3Rpb24gaW5pdGlhbGl6ZURhdGFzZXQob0RhdGFzZXQpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRhc2V0KG9EYXRhc2V0KTsKICAgICAgICB9CiAgICB9KCk7CiAgICB2YXIgVHlwZWFoZWFkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgCiAgICAgICAgdmFyIGF0dHJzS2V5ID0gInR0QXR0cnMiOwogICAgICAgIGZ1bmN0aW9uIFR5cGVhaGVhZChvKSB7CiAgICAgICAgICAgIHZhciAkbWVudSwgJGlucHV0LCAkaGludDsKICAgICAgICAgICAgbyA9IG8gfHwge307CiAgICAgICAgICAgIGlmICghby5pbnB1dCkgewogICAgICAgICAgICAgICAgJC5lcnJvcigibWlzc2luZyBpbnB1dCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaXNBY3RpdmF0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5hdXRvc2VsZWN0ID0gISFvLmF1dG9zZWxlY3Q7CiAgICAgICAgICAgIHRoaXMubWluTGVuZ3RoID0gXy5pc051bWJlcihvLm1pbkxlbmd0aCkgPyBvLm1pbkxlbmd0aCA6IDE7CiAgICAgICAgICAgIHRoaXMuJG5vZGUgPSBidWlsZERvbShvLmlucHV0LCBvLndpdGhIaW50KTsKICAgICAgICAgICAgJG1lbnUgPSB0aGlzLiRub2RlLmZpbmQoIi50dC1kcm9wZG93bi1tZW51Iik7CiAgICAgICAgICAgICRpbnB1dCA9IHRoaXMuJG5vZGUuZmluZCgiLnR0LWlucHV0Iik7CiAgICAgICAgICAgICRoaW50ID0gdGhpcy4kbm9kZS5maW5kKCIudHQtaGludCIpOwogICAgICAgICAgICAkaW5wdXQub24oImJsdXIudHQiLCBmdW5jdGlvbigkZSkgewogICAgICAgICAgICAgICAgdmFyIGFjdGl2ZSwgaXNBY3RpdmUsIGhhc0FjdGl2ZTsKICAgICAgICAgICAgICAgIGFjdGl2ZSA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7CiAgICAgICAgICAgICAgICBpc0FjdGl2ZSA9ICRtZW51LmlzKGFjdGl2ZSk7CiAgICAgICAgICAgICAgICBoYXNBY3RpdmUgPSAkbWVudS5oYXMoYWN0aXZlKS5sZW5ndGggPiAwOwogICAgICAgICAgICAgICAgaWYgKF8uaXNNc2llKCkgJiYgKGlzQWN0aXZlIHx8IGhhc0FjdGl2ZSkpIHsKICAgICAgICAgICAgICAgICAgICAkZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgICRlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIF8uZGVmZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRpbnB1dC5mb2N1cygpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgJG1lbnUub24oIm1vdXNlZG93bi50dCIsIGZ1bmN0aW9uKCRlKSB7CiAgICAgICAgICAgICAgICAkZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5ldmVudEJ1cyA9IG8uZXZlbnRCdXMgfHwgbmV3IEV2ZW50QnVzKHsKICAgICAgICAgICAgICAgIGVsOiAkaW5wdXQKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuZHJvcGRvd24gPSBuZXcgRHJvcGRvd24oewogICAgICAgICAgICAgICAgbWVudTogJG1lbnUsCiAgICAgICAgICAgICAgICBkYXRhc2V0czogby5kYXRhc2V0cwogICAgICAgICAgICB9KS5vblN5bmMoInN1Z2dlc3Rpb25DbGlja2VkIiwgdGhpcy5fb25TdWdnZXN0aW9uQ2xpY2tlZCwgdGhpcykub25TeW5jKCJjdXJzb3JNb3ZlZCIsIHRoaXMuX29uQ3Vyc29yTW92ZWQsIHRoaXMpLm9uU3luYygiY3Vyc29yUmVtb3ZlZCIsIHRoaXMuX29uQ3Vyc29yUmVtb3ZlZCwgdGhpcykub25TeW5jKCJvcGVuZWQiLCB0aGlzLl9vbk9wZW5lZCwgdGhpcykub25TeW5jKCJjbG9zZWQiLCB0aGlzLl9vbkNsb3NlZCwgdGhpcykub25Bc3luYygiZGF0YXNldFJlbmRlcmVkIiwgdGhpcy5fb25EYXRhc2V0UmVuZGVyZWQsIHRoaXMpOwogICAgICAgICAgICB0aGlzLmlucHV0ID0gbmV3IElucHV0KHsKICAgICAgICAgICAgICAgIGlucHV0OiAkaW5wdXQsCiAgICAgICAgICAgICAgICBoaW50OiAkaGludAogICAgICAgICAgICB9KS5vblN5bmMoImZvY3VzZWQiLCB0aGlzLl9vbkZvY3VzZWQsIHRoaXMpLm9uU3luYygiYmx1cnJlZCIsIHRoaXMuX29uQmx1cnJlZCwgdGhpcykub25TeW5jKCJlbnRlcktleWVkIiwgdGhpcy5fb25FbnRlcktleWVkLCB0aGlzKS5vblN5bmMoInRhYktleWVkIiwgdGhpcy5fb25UYWJLZXllZCwgdGhpcykub25TeW5jKCJlc2NLZXllZCIsIHRoaXMuX29uRXNjS2V5ZWQsIHRoaXMpLm9uU3luYygidXBLZXllZCIsIHRoaXMuX29uVXBLZXllZCwgdGhpcykub25TeW5jKCJkb3duS2V5ZWQiLCB0aGlzLl9vbkRvd25LZXllZCwgdGhpcykub25TeW5jKCJsZWZ0S2V5ZWQiLCB0aGlzLl9vbkxlZnRLZXllZCwgdGhpcykub25TeW5jKCJyaWdodEtleWVkIiwgdGhpcy5fb25SaWdodEtleWVkLCB0aGlzKS5vblN5bmMoInF1ZXJ5Q2hhbmdlZCIsIHRoaXMuX29uUXVlcnlDaGFuZ2VkLCB0aGlzKS5vblN5bmMoIndoaXRlc3BhY2VDaGFuZ2VkIiwgdGhpcy5fb25XaGl0ZXNwYWNlQ2hhbmdlZCwgdGhpcyk7CiAgICAgICAgICAgIHRoaXMuX3NldExhbmd1YWdlRGlyZWN0aW9uKCk7CiAgICAgICAgfQogICAgICAgIF8ubWl4aW4oVHlwZWFoZWFkLnByb3RvdHlwZSwgewogICAgICAgICAgICBfb25TdWdnZXN0aW9uQ2xpY2tlZDogZnVuY3Rpb24gb25TdWdnZXN0aW9uQ2xpY2tlZCh0eXBlLCAkZWwpIHsKICAgICAgICAgICAgICAgIHZhciBkYXR1bTsKICAgICAgICAgICAgICAgIGlmIChkYXR1bSA9IHRoaXMuZHJvcGRvd24uZ2V0RGF0dW1Gb3JTdWdnZXN0aW9uKCRlbCkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZWxlY3QoZGF0dW0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBfb25DdXJzb3JNb3ZlZDogZnVuY3Rpb24gb25DdXJzb3JNb3ZlZCgpIHsKICAgICAgICAgICAgICAgIHZhciBkYXR1bSA9IHRoaXMuZHJvcGRvd24uZ2V0RGF0dW1Gb3JDdXJzb3IoKTsKICAgICAgICAgICAgICAgIHRoaXMuaW5wdXQuc2V0SW5wdXRWYWx1ZShkYXR1bS52YWx1ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50QnVzLnRyaWdnZXIoImN1cnNvcmNoYW5nZWQiLCBkYXR1bS5yYXcsIGRhdHVtLmRhdGFzZXROYW1lKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uQ3Vyc29yUmVtb3ZlZDogZnVuY3Rpb24gb25DdXJzb3JSZW1vdmVkKCkgewogICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5yZXNldElucHV0VmFsdWUoKTsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUhpbnQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uRGF0YXNldFJlbmRlcmVkOiBmdW5jdGlvbiBvbkRhdGFzZXRSZW5kZXJlZCgpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUhpbnQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uT3BlbmVkOiBmdW5jdGlvbiBvbk9wZW5lZCgpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUhpbnQoKTsKICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRCdXMudHJpZ2dlcigib3BlbmVkIik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9vbkNsb3NlZDogZnVuY3Rpb24gb25DbG9zZWQoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlucHV0LmNsZWFySGludCgpOwogICAgICAgICAgICAgICAgdGhpcy5ldmVudEJ1cy50cmlnZ2VyKCJjbG9zZWQiKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uRm9jdXNlZDogZnVuY3Rpb24gb25Gb2N1c2VkKCkgewogICAgICAgICAgICAgICAgdGhpcy5pc0FjdGl2YXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3Bkb3duLm9wZW4oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uQmx1cnJlZDogZnVuY3Rpb24gb25CbHVycmVkKCkgewogICAgICAgICAgICAgICAgdGhpcy5pc0FjdGl2YXRlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5lbXB0eSgpOwogICAgICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5jbG9zZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfb25FbnRlcktleWVkOiBmdW5jdGlvbiBvbkVudGVyS2V5ZWQodHlwZSwgJGUpIHsKICAgICAgICAgICAgICAgIHZhciBjdXJzb3JEYXR1bSwgdG9wU3VnZ2VzdGlvbkRhdHVtOwogICAgICAgICAgICAgICAgY3Vyc29yRGF0dW0gPSB0aGlzLmRyb3Bkb3duLmdldERhdHVtRm9yQ3Vyc29yKCk7CiAgICAgICAgICAgICAgICB0b3BTdWdnZXN0aW9uRGF0dW0gPSB0aGlzLmRyb3Bkb3duLmdldERhdHVtRm9yVG9wU3VnZ2VzdGlvbigpOwogICAgICAgICAgICAgICAgaWYgKGN1cnNvckRhdHVtKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2VsZWN0KGN1cnNvckRhdHVtKTsKICAgICAgICAgICAgICAgICAgICAkZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmF1dG9zZWxlY3QgJiYgdG9wU3VnZ2VzdGlvbkRhdHVtKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2VsZWN0KHRvcFN1Z2dlc3Rpb25EYXR1bSk7CiAgICAgICAgICAgICAgICAgICAgJGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uVGFiS2V5ZWQ6IGZ1bmN0aW9uIG9uVGFiS2V5ZWQodHlwZSwgJGUpIHsKICAgICAgICAgICAgICAgIHZhciBkYXR1bTsKICAgICAgICAgICAgICAgIGlmIChkYXR1bSA9IHRoaXMuZHJvcGRvd24uZ2V0RGF0dW1Gb3JDdXJzb3IoKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NlbGVjdChkYXR1bSk7CiAgICAgICAgICAgICAgICAgICAgJGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYXV0b2NvbXBsZXRlKHRydWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBfb25Fc2NLZXllZDogZnVuY3Rpb24gb25Fc2NLZXllZCgpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uY2xvc2UoKTsKICAgICAgICAgICAgICAgIHRoaXMuaW5wdXQucmVzZXRJbnB1dFZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9vblVwS2V5ZWQ6IGZ1bmN0aW9uIG9uVXBLZXllZCgpIHsKICAgICAgICAgICAgICAgIHZhciBxdWVyeSA9IHRoaXMuaW5wdXQuZ2V0UXVlcnkoKTsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uaXNFbXB0eSAmJiBxdWVyeS5sZW5ndGggPj0gdGhpcy5taW5MZW5ndGggPyB0aGlzLmRyb3Bkb3duLnVwZGF0ZShxdWVyeSkgOiB0aGlzLmRyb3Bkb3duLm1vdmVDdXJzb3JVcCgpOwogICAgICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5vcGVuKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9vbkRvd25LZXllZDogZnVuY3Rpb24gb25Eb3duS2V5ZWQoKSB7CiAgICAgICAgICAgICAgICB2YXIgcXVlcnkgPSB0aGlzLmlucHV0LmdldFF1ZXJ5KCk7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3Bkb3duLmlzRW1wdHkgJiYgcXVlcnkubGVuZ3RoID49IHRoaXMubWluTGVuZ3RoID8gdGhpcy5kcm9wZG93bi51cGRhdGUocXVlcnkpIDogdGhpcy5kcm9wZG93bi5tb3ZlQ3Vyc29yRG93bigpOwogICAgICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5vcGVuKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9vbkxlZnRLZXllZDogZnVuY3Rpb24gb25MZWZ0S2V5ZWQoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRpciA9PT0gInJ0bCIgJiYgdGhpcy5fYXV0b2NvbXBsZXRlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9vblJpZ2h0S2V5ZWQ6IGZ1bmN0aW9uIG9uUmlnaHRLZXllZCgpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGlyID09PSAibHRyIiAmJiB0aGlzLl9hdXRvY29tcGxldGUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uUXVlcnlDaGFuZ2VkOiBmdW5jdGlvbiBvblF1ZXJ5Q2hhbmdlZChlLCBxdWVyeSkgewogICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5jbGVhckhpbnRJZkludmFsaWQoKTsKICAgICAgICAgICAgICAgIHF1ZXJ5Lmxlbmd0aCA+PSB0aGlzLm1pbkxlbmd0aCA/IHRoaXMuZHJvcGRvd24udXBkYXRlKHF1ZXJ5KSA6IHRoaXMuZHJvcGRvd24uZW1wdHkoKTsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcGRvd24ub3BlbigpOwogICAgICAgICAgICAgICAgdGhpcy5fc2V0TGFuZ3VhZ2VEaXJlY3Rpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uV2hpdGVzcGFjZUNoYW5nZWQ6IGZ1bmN0aW9uIG9uV2hpdGVzcGFjZUNoYW5nZWQoKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVIaW50KCk7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3Bkb3duLm9wZW4oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX3NldExhbmd1YWdlRGlyZWN0aW9uOiBmdW5jdGlvbiBzZXRMYW5ndWFnZURpcmVjdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBkaXI7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5kaXIgIT09IChkaXIgPSB0aGlzLmlucHV0LmdldExhbmd1YWdlRGlyZWN0aW9uKCkpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kaXIgPSBkaXI7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kbm9kZS5jc3MoImRpcmVjdGlvbiIsIGRpcik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5zZXRMYW5ndWFnZURpcmVjdGlvbihkaXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBfdXBkYXRlSGludDogZnVuY3Rpb24gdXBkYXRlSGludCgpIHsKICAgICAgICAgICAgICAgIHZhciBkYXR1bSwgdmFsLCBxdWVyeSwgZXNjYXBlZFF1ZXJ5LCBmcm9udE1hdGNoUmVnRXgsIG1hdGNoOwogICAgICAgICAgICAgICAgZGF0dW0gPSB0aGlzLmRyb3Bkb3duLmdldERhdHVtRm9yVG9wU3VnZ2VzdGlvbigpOwogICAgICAgICAgICAgICAgaWYgKGRhdHVtICYmIHRoaXMuZHJvcGRvd24uaXNWaXNpYmxlKCkgJiYgIXRoaXMuaW5wdXQuaGFzT3ZlcmZsb3coKSkgewogICAgICAgICAgICAgICAgICAgIHZhbCA9IHRoaXMuaW5wdXQuZ2V0SW5wdXRWYWx1ZSgpOwogICAgICAgICAgICAgICAgICAgIHF1ZXJ5ID0gSW5wdXQubm9ybWFsaXplUXVlcnkodmFsKTsKICAgICAgICAgICAgICAgICAgICBlc2NhcGVkUXVlcnkgPSBfLmVzY2FwZVJlZ0V4Q2hhcnMocXVlcnkpOwogICAgICAgICAgICAgICAgICAgIGZyb250TWF0Y2hSZWdFeCA9IG5ldyBSZWdFeHAoIl4oPzoiICsgZXNjYXBlZFF1ZXJ5ICsgIikoLiskKSIsICJpIik7CiAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBmcm9udE1hdGNoUmVnRXguZXhlYyhkYXR1bS52YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPyB0aGlzLmlucHV0LnNldEhpbnQodmFsICsgbWF0Y2hbMV0pIDogdGhpcy5pbnB1dC5jbGVhckhpbnQoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5jbGVhckhpbnQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgX2F1dG9jb21wbGV0ZTogZnVuY3Rpb24gYXV0b2NvbXBsZXRlKGxheEN1cnNvcikgewogICAgICAgICAgICAgICAgdmFyIGhpbnQsIHF1ZXJ5LCBpc0N1cnNvckF0RW5kLCBkYXR1bTsKICAgICAgICAgICAgICAgIGhpbnQgPSB0aGlzLmlucHV0LmdldEhpbnQoKTsKICAgICAgICAgICAgICAgIHF1ZXJ5ID0gdGhpcy5pbnB1dC5nZXRRdWVyeSgpOwogICAgICAgICAgICAgICAgaXNDdXJzb3JBdEVuZCA9IGxheEN1cnNvciB8fCB0aGlzLmlucHV0LmlzQ3Vyc29yQXRFbmQoKTsKICAgICAgICAgICAgICAgIGlmIChoaW50ICYmIHF1ZXJ5ICE9PSBoaW50ICYmIGlzQ3Vyc29yQXRFbmQpIHsKICAgICAgICAgICAgICAgICAgICBkYXR1bSA9IHRoaXMuZHJvcGRvd24uZ2V0RGF0dW1Gb3JUb3BTdWdnZXN0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgZGF0dW0gJiYgdGhpcy5pbnB1dC5zZXRJbnB1dFZhbHVlKGRhdHVtLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmV2ZW50QnVzLnRyaWdnZXIoImF1dG9jb21wbGV0ZWQiLCBkYXR1bS5yYXcsIGRhdHVtLmRhdGFzZXROYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgX3NlbGVjdDogZnVuY3Rpb24gc2VsZWN0KGRhdHVtKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlucHV0LnNldFF1ZXJ5KGRhdHVtLnZhbHVlKTsKICAgICAgICAgICAgICAgIHRoaXMuaW5wdXQuc2V0SW5wdXRWYWx1ZShkYXR1bS52YWx1ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB0aGlzLl9zZXRMYW5ndWFnZURpcmVjdGlvbigpOwogICAgICAgICAgICAgICAgdGhpcy5ldmVudEJ1cy50cmlnZ2VyKCJzZWxlY3RlZCIsIGRhdHVtLnJhdywgZGF0dW0uZGF0YXNldE5hbWUpOwogICAgICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5jbG9zZSgpOwogICAgICAgICAgICAgICAgXy5kZWZlcihfLmJpbmQodGhpcy5kcm9wZG93bi5lbXB0eSwgdGhpcy5kcm9wZG93bikpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvcGVuOiBmdW5jdGlvbiBvcGVuKCkgewogICAgICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5vcGVuKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNsb3NlOiBmdW5jdGlvbiBjbG9zZSgpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uY2xvc2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0VmFsOiBmdW5jdGlvbiBzZXRWYWwodmFsKSB7CiAgICAgICAgICAgICAgICB2YWwgPSBfLnRvU3RyKHZhbCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc0FjdGl2YXRlZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaW5wdXQuc2V0SW5wdXRWYWx1ZSh2YWwpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlucHV0LnNldFF1ZXJ5KHZhbCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5zZXRJbnB1dFZhbHVlKHZhbCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9zZXRMYW5ndWFnZURpcmVjdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXRWYWw6IGZ1bmN0aW9uIGdldFZhbCgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmlucHV0LmdldFF1ZXJ5KCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlucHV0LmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uZGVzdHJveSgpOwogICAgICAgICAgICAgICAgZGVzdHJveURvbVN0cnVjdHVyZSh0aGlzLiRub2RlKTsKICAgICAgICAgICAgICAgIHRoaXMuJG5vZGUgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIFR5cGVhaGVhZDsKICAgICAgICBmdW5jdGlvbiBidWlsZERvbShpbnB1dCwgd2l0aEhpbnQpIHsKICAgICAgICAgICAgdmFyICRpbnB1dCwgJHdyYXBwZXIsICRkcm9wZG93biwgJGhpbnQ7CiAgICAgICAgICAgICRpbnB1dCA9ICQoaW5wdXQpOwogICAgICAgICAgICAkd3JhcHBlciA9ICQoaHRtbC53cmFwcGVyKS5jc3MoY3NzLndyYXBwZXIpOwogICAgICAgICAgICAkZHJvcGRvd24gPSAkKGh0bWwuZHJvcGRvd24pLmNzcyhjc3MuZHJvcGRvd24pOwogICAgICAgICAgICAkaGludCA9ICRpbnB1dC5jbG9uZSgpLmNzcyhjc3MuaGludCkuY3NzKGdldEJhY2tncm91bmRTdHlsZXMoJGlucHV0KSk7CiAgICAgICAgICAgICRoaW50LnZhbCgiIikucmVtb3ZlRGF0YSgpLmFkZENsYXNzKCJ0dC1oaW50IikucmVtb3ZlQXR0cigiaWQgbmFtZSBwbGFjZWhvbGRlciByZXF1aXJlZCIpLnByb3AoInJlYWRvbmx5IiwgdHJ1ZSkuYXR0cih7CiAgICAgICAgICAgICAgICBhdXRvY29tcGxldGU6ICJvZmYiLAogICAgICAgICAgICAgICAgc3BlbGxjaGVjazogImZhbHNlIiwKICAgICAgICAgICAgICAgIHRhYmluZGV4OiAtMQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgJGlucHV0LmRhdGEoYXR0cnNLZXksIHsKICAgICAgICAgICAgICAgIGRpcjogJGlucHV0LmF0dHIoImRpciIpLAogICAgICAgICAgICAgICAgYXV0b2NvbXBsZXRlOiAkaW5wdXQuYXR0cigiYXV0b2NvbXBsZXRlIiksCiAgICAgICAgICAgICAgICBzcGVsbGNoZWNrOiAkaW5wdXQuYXR0cigic3BlbGxjaGVjayIpLAogICAgICAgICAgICAgICAgc3R5bGU6ICRpbnB1dC5hdHRyKCJzdHlsZSIpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAkaW5wdXQuYWRkQ2xhc3MoInR0LWlucHV0IikuYXR0cih7CiAgICAgICAgICAgICAgICBhdXRvY29tcGxldGU6ICJvZmYiLAogICAgICAgICAgICAgICAgc3BlbGxjaGVjazogZmFsc2UKICAgICAgICAgICAgfSkuY3NzKHdpdGhIaW50ID8gY3NzLmlucHV0IDogY3NzLmlucHV0V2l0aE5vSGludCk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAhJGlucHV0LmF0dHIoImRpciIpICYmICRpbnB1dC5hdHRyKCJkaXIiLCAiYXV0byIpOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgICAgICByZXR1cm4gJGlucHV0LndyYXAoJHdyYXBwZXIpLnBhcmVudCgpLnByZXBlbmQod2l0aEhpbnQgPyAkaGludCA6IG51bGwpLmFwcGVuZCgkZHJvcGRvd24pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRCYWNrZ3JvdW5kU3R5bGVzKCRlbCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgYmFja2dyb3VuZEF0dGFjaG1lbnQ6ICRlbC5jc3MoImJhY2tncm91bmQtYXR0YWNobWVudCIpLAogICAgICAgICAgICAgICAgYmFja2dyb3VuZENsaXA6ICRlbC5jc3MoImJhY2tncm91bmQtY2xpcCIpLAogICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAkZWwuY3NzKCJiYWNrZ3JvdW5kLWNvbG9yIiksCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kSW1hZ2U6ICRlbC5jc3MoImJhY2tncm91bmQtaW1hZ2UiKSwKICAgICAgICAgICAgICAgIGJhY2tncm91bmRPcmlnaW46ICRlbC5jc3MoImJhY2tncm91bmQtb3JpZ2luIiksCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kUG9zaXRpb246ICRlbC5jc3MoImJhY2tncm91bmQtcG9zaXRpb24iKSwKICAgICAgICAgICAgICAgIGJhY2tncm91bmRSZXBlYXQ6ICRlbC5jc3MoImJhY2tncm91bmQtcmVwZWF0IiksCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kU2l6ZTogJGVsLmNzcygiYmFja2dyb3VuZC1zaXplIikKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzdHJveURvbVN0cnVjdHVyZSgkbm9kZSkgewogICAgICAgICAgICB2YXIgJGlucHV0ID0gJG5vZGUuZmluZCgiLnR0LWlucHV0Iik7CiAgICAgICAgICAgIF8uZWFjaCgkaW5wdXQuZGF0YShhdHRyc0tleSksIGZ1bmN0aW9uKHZhbCwga2V5KSB7CiAgICAgICAgICAgICAgICBfLmlzVW5kZWZpbmVkKHZhbCkgPyAkaW5wdXQucmVtb3ZlQXR0cihrZXkpIDogJGlucHV0LmF0dHIoa2V5LCB2YWwpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgJGlucHV0LmRldGFjaCgpLnJlbW92ZURhdGEoYXR0cnNLZXkpLnJlbW92ZUNsYXNzKCJ0dC1pbnB1dCIpLmluc2VydEFmdGVyKCRub2RlKTsKICAgICAgICAgICAgJG5vZGUucmVtb3ZlKCk7CiAgICAgICAgfQogICAgfSgpOwogICAgKGZ1bmN0aW9uKCkgewogICAgICAgIAogICAgICAgIHZhciBvbGQsIHR5cGVhaGVhZEtleSwgbWV0aG9kczsKICAgICAgICBvbGQgPSAkLmZuLnR5cGVhaGVhZDsKICAgICAgICB0eXBlYWhlYWRLZXkgPSAidHRUeXBlYWhlYWQiOwogICAgICAgIG1ldGhvZHMgPSB7CiAgICAgICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uIGluaXRpYWxpemUobywgZGF0YXNldHMpIHsKICAgICAgICAgICAgICAgIGRhdGFzZXRzID0gXy5pc0FycmF5KGRhdGFzZXRzKSA/IGRhdGFzZXRzIDogW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICAgICAgbyA9IG8gfHwge307CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGF0dGFjaCk7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBhdHRhY2goKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyICRpbnB1dCA9ICQodGhpcyksIGV2ZW50QnVzLCB0eXBlYWhlYWQ7CiAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGRhdGFzZXRzLCBmdW5jdGlvbihkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGQuaGlnaGxpZ2h0ID0gISFvLmhpZ2hsaWdodDsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB0eXBlYWhlYWQgPSBuZXcgVHlwZWFoZWFkKHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQ6ICRpbnB1dCwKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRCdXM6IGV2ZW50QnVzID0gbmV3IEV2ZW50QnVzKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsOiAkaW5wdXQKICAgICAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgICAgIHdpdGhIaW50OiBfLmlzVW5kZWZpbmVkKG8uaGludCkgPyB0cnVlIDogISFvLmhpbnQsCiAgICAgICAgICAgICAgICAgICAgICAgIG1pbkxlbmd0aDogby5taW5MZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9zZWxlY3Q6IG8uYXV0b3NlbGVjdCwKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YXNldHM6IGRhdGFzZXRzCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgJGlucHV0LmRhdGEodHlwZWFoZWFkS2V5LCB0eXBlYWhlYWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBvcGVuOiBmdW5jdGlvbiBvcGVuKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChvcGVuVHlwZWFoZWFkKTsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIG9wZW5UeXBlYWhlYWQoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyICRpbnB1dCA9ICQodGhpcyksIHR5cGVhaGVhZDsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZWFoZWFkID0gJGlucHV0LmRhdGEodHlwZWFoZWFkS2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICB0eXBlYWhlYWQub3BlbigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2xvc2U6IGZ1bmN0aW9uIGNsb3NlKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChjbG9zZVR5cGVhaGVhZCk7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjbG9zZVR5cGVhaGVhZCgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgJGlucHV0ID0gJCh0aGlzKSwgdHlwZWFoZWFkOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlYWhlYWQgPSAkaW5wdXQuZGF0YSh0eXBlYWhlYWRLZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVhaGVhZC5jbG9zZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdmFsOiBmdW5jdGlvbiB2YWwobmV3VmFsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIWFyZ3VtZW50cy5sZW5ndGggPyBnZXRWYWwodGhpcy5maXJzdCgpKSA6IHRoaXMuZWFjaChzZXRWYWwpOwogICAgICAgICAgICAgICAgZnVuY3Rpb24gc2V0VmFsKCkgewogICAgICAgICAgICAgICAgICAgIHZhciAkaW5wdXQgPSAkKHRoaXMpLCB0eXBlYWhlYWQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVhaGVhZCA9ICRpbnB1dC5kYXRhKHR5cGVhaGVhZEtleSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZWFoZWFkLnNldFZhbChuZXdWYWwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGdldFZhbCgkaW5wdXQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdHlwZWFoZWFkLCBxdWVyeTsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZWFoZWFkID0gJGlucHV0LmRhdGEodHlwZWFoZWFkS2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICBxdWVyeSA9IHR5cGVhaGVhZC5nZXRWYWwoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHF1ZXJ5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaCh1bmF0dGFjaCk7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiB1bmF0dGFjaCgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgJGlucHV0ID0gJCh0aGlzKSwgdHlwZWFoZWFkOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlYWhlYWQgPSAkaW5wdXQuZGF0YSh0eXBlYWhlYWRLZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVhaGVhZC5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICRpbnB1dC5yZW1vdmVEYXRhKHR5cGVhaGVhZEtleSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICAkLmZuLnR5cGVhaGVhZCA9IGZ1bmN0aW9uKG1ldGhvZCkgewogICAgICAgICAgICB2YXIgdHRzOwogICAgICAgICAgICBpZiAobWV0aG9kc1ttZXRob2RdICYmIG1ldGhvZCAhPT0gImluaXRpYWxpemUiKSB7CiAgICAgICAgICAgICAgICB0dHMgPSB0aGlzLmZpbHRlcihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gISEkKHRoaXMpLmRhdGEodHlwZWFoZWFkS2V5KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIG1ldGhvZHNbbWV0aG9kXS5hcHBseSh0dHMsIFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWV0aG9kcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgICQuZm4udHlwZWFoZWFkLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiBub0NvbmZsaWN0KCkgewogICAgICAgICAgICAkLmZuLnR5cGVhaGVhZCA9IG9sZDsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgIH0pKCk7CiAgICByZXR1cm4ge307Cn0pKTsKCi8vIFRoaXMgY29kZSB3YXMgd3JpdHRlbiBieSBUeWxlciBBa2lucyBhbmQgaGFzIGJlZW4gcGxhY2VkIGluIHRoZQovLyBwdWJsaWMgZG9tYWluLiAgSXQgd291bGQgYmUgbmljZSBpZiB5b3UgbGVmdCB0aGlzIGhlYWRlciBpbnRhY3QuCi8vIEJhc2U2NCBjb2RlIGZyb20gVHlsZXIgQWtpbnMgLS0gaHR0cDovL3J1bWtpbi5jb20KCnZhciBCYXNlNjQgPSAoZnVuY3Rpb24gKCkgewogICAgdmFyIGtleVN0ciA9ICJBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWmFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6MDEyMzQ1Njc4OSsvPSI7CgogICAgdmFyIG9iaiA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBFbmNvZGVzIGEgc3RyaW5nIGluIGJhc2U2NAogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBpbnB1dCBUaGUgc3RyaW5nIHRvIGVuY29kZSBpbiBiYXNlNjQuCiAgICAgICAgICovCiAgICAgICAgZW5jb2RlOiBmdW5jdGlvbiAoaW5wdXQpIHsKICAgICAgICAgICAgdmFyIG91dHB1dCA9ICIiOwogICAgICAgICAgICB2YXIgY2hyMSwgY2hyMiwgY2hyMzsKICAgICAgICAgICAgdmFyIGVuYzEsIGVuYzIsIGVuYzMsIGVuYzQ7CiAgICAgICAgICAgIHZhciBpID0gMDsKCiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgIGNocjEgPSBpbnB1dC5jaGFyQ29kZUF0KGkrKyk7CiAgICAgICAgICAgICAgICBjaHIyID0gaW5wdXQuY2hhckNvZGVBdChpKyspOwogICAgICAgICAgICAgICAgY2hyMyA9IGlucHV0LmNoYXJDb2RlQXQoaSsrKTsKCiAgICAgICAgICAgICAgICBlbmMxID0gY2hyMSA+PiAyOwogICAgICAgICAgICAgICAgZW5jMiA9ICgoY2hyMSAmIDMpIDw8IDQpIHwgKGNocjIgPj4gNCk7CiAgICAgICAgICAgICAgICBlbmMzID0gKChjaHIyICYgMTUpIDw8IDIpIHwgKGNocjMgPj4gNik7CiAgICAgICAgICAgICAgICBlbmM0ID0gY2hyMyAmIDYzOwoKICAgICAgICAgICAgICAgIGlmIChpc05hTihjaHIyKSkgewogICAgICAgICAgICAgICAgICAgIGVuYzMgPSBlbmM0ID0gNjQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzTmFOKGNocjMpKSB7CiAgICAgICAgICAgICAgICAgICAgZW5jNCA9IDY0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG91dHB1dCA9IG91dHB1dCArIGtleVN0ci5jaGFyQXQoZW5jMSkgKyBrZXlTdHIuY2hhckF0KGVuYzIpICsKICAgICAgICAgICAgICAgICAgICBrZXlTdHIuY2hhckF0KGVuYzMpICsga2V5U3RyLmNoYXJBdChlbmM0KTsKICAgICAgICAgICAgfSB3aGlsZSAoaSA8IGlucHV0Lmxlbmd0aCk7CgogICAgICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIERlY29kZXMgYSBiYXNlNjQgc3RyaW5nLgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBpbnB1dCBUaGUgc3RyaW5nIHRvIGRlY29kZS4KICAgICAgICAgKi8KICAgICAgICBkZWNvZGU6IGZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgICAgICB2YXIgb3V0cHV0ID0gIiI7CiAgICAgICAgICAgIHZhciBjaHIxLCBjaHIyLCBjaHIzOwogICAgICAgICAgICB2YXIgZW5jMSwgZW5jMiwgZW5jMywgZW5jNDsKICAgICAgICAgICAgdmFyIGkgPSAwOwoKICAgICAgICAgICAgLy8gcmVtb3ZlIGFsbCBjaGFyYWN0ZXJzIHRoYXQgYXJlIG5vdCBBLVosIGEteiwgMC05LCArLCAvLCBvciA9CiAgICAgICAgICAgIGlucHV0ID0gaW5wdXQucmVwbGFjZSgvW15BLVphLXowLTlcK1wvXD1dL2csICIiKTsKCiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgIGVuYzEgPSBrZXlTdHIuaW5kZXhPZihpbnB1dC5jaGFyQXQoaSsrKSk7CiAgICAgICAgICAgICAgICBlbmMyID0ga2V5U3RyLmluZGV4T2YoaW5wdXQuY2hhckF0KGkrKykpOwogICAgICAgICAgICAgICAgZW5jMyA9IGtleVN0ci5pbmRleE9mKGlucHV0LmNoYXJBdChpKyspKTsKICAgICAgICAgICAgICAgIGVuYzQgPSBrZXlTdHIuaW5kZXhPZihpbnB1dC5jaGFyQXQoaSsrKSk7CgogICAgICAgICAgICAgICAgY2hyMSA9IChlbmMxIDw8IDIpIHwgKGVuYzIgPj4gNCk7CiAgICAgICAgICAgICAgICBjaHIyID0gKChlbmMyICYgMTUpIDw8IDQpIHwgKGVuYzMgPj4gMik7CiAgICAgICAgICAgICAgICBjaHIzID0gKChlbmMzICYgMykgPDwgNikgfCBlbmM0OwoKICAgICAgICAgICAgICAgIG91dHB1dCA9IG91dHB1dCArIFN0cmluZy5mcm9tQ2hhckNvZGUoY2hyMSk7CgogICAgICAgICAgICAgICAgaWYgKGVuYzMgIT0gNjQpIHsKICAgICAgICAgICAgICAgICAgICBvdXRwdXQgPSBvdXRwdXQgKyBTdHJpbmcuZnJvbUNoYXJDb2RlKGNocjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVuYzQgIT0gNjQpIHsKICAgICAgICAgICAgICAgICAgICBvdXRwdXQgPSBvdXRwdXQgKyBTdHJpbmcuZnJvbUNoYXJDb2RlKGNocjMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IHdoaWxlIChpIDwgaW5wdXQubGVuZ3RoKTsKCiAgICAgICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gb2JqOwp9KSgpOwoKLyoKICogQSBKYXZhU2NyaXB0IGltcGxlbWVudGF0aW9uIG9mIHRoZSBTZWN1cmUgSGFzaCBBbGdvcml0aG0sIFNIQS0xLCBhcyBkZWZpbmVkCiAqIGluIEZJUFMgUFVCIDE4MC0xCiAqIFZlcnNpb24gMi4xYSBDb3B5cmlnaHQgUGF1bCBKb2huc3RvbiAyMDAwIC0gMjAwMi4KICogT3RoZXIgY29udHJpYnV0b3JzOiBHcmVnIEhvbHQsIEFuZHJldyBLZXBlcnQsIFlkbmFyLCBMb3N0aW5ldAogKiBEaXN0cmlidXRlZCB1bmRlciB0aGUgQlNEIExpY2Vuc2UKICogU2VlIGh0dHA6Ly9wYWpob21lLm9yZy51ay9jcnlwdC9tZDUgZm9yIGRldGFpbHMuCiAqLwoKLyogU29tZSBmdW5jdGlvbnMgYW5kIHZhcmlhYmxlcyBoYXZlIGJlZW4gc3RyaXBwZWQgZm9yIHVzZSB3aXRoIFN0cm9waGUgKi8KCi8qCiAqIFRoZXNlIGFyZSB0aGUgZnVuY3Rpb25zIHlvdSdsbCB1c3VhbGx5IHdhbnQgdG8gY2FsbAogKiBUaGV5IHRha2Ugc3RyaW5nIGFyZ3VtZW50cyBhbmQgcmV0dXJuIGVpdGhlciBoZXggb3IgYmFzZS02NCBlbmNvZGVkIHN0cmluZ3MKICovCmZ1bmN0aW9uIGI2NF9zaGExKHMpe3JldHVybiBiaW5iMmI2NChjb3JlX3NoYTEoc3RyMmJpbmIocykscy5sZW5ndGggKiA4KSk7fQpmdW5jdGlvbiBzdHJfc2hhMShzKXtyZXR1cm4gYmluYjJzdHIoY29yZV9zaGExKHN0cjJiaW5iKHMpLHMubGVuZ3RoICogOCkpO30KZnVuY3Rpb24gYjY0X2htYWNfc2hhMShrZXksIGRhdGEpeyByZXR1cm4gYmluYjJiNjQoY29yZV9obWFjX3NoYTEoa2V5LCBkYXRhKSk7fQpmdW5jdGlvbiBzdHJfaG1hY19zaGExKGtleSwgZGF0YSl7IHJldHVybiBiaW5iMnN0cihjb3JlX2htYWNfc2hhMShrZXksIGRhdGEpKTt9CgovKgogKiBDYWxjdWxhdGUgdGhlIFNIQS0xIG9mIGFuIGFycmF5IG9mIGJpZy1lbmRpYW4gd29yZHMsIGFuZCBhIGJpdCBsZW5ndGgKICovCmZ1bmN0aW9uIGNvcmVfc2hhMSh4LCBsZW4pCnsKICAvKiBhcHBlbmQgcGFkZGluZyAqLwogIHhbbGVuID4+IDVdIHw9IDB4ODAgPDwgKDI0IC0gbGVuICUgMzIpOwogIHhbKChsZW4gKyA2NCA+PiA5KSA8PCA0KSArIDE1XSA9IGxlbjsKCiAgdmFyIHcgPSBuZXcgQXJyYXkoODApOwogIHZhciBhID0gIDE3MzI1ODQxOTM7CiAgdmFyIGIgPSAtMjcxNzMzODc5OwogIHZhciBjID0gLTE3MzI1ODQxOTQ7CiAgdmFyIGQgPSAgMjcxNzMzODc4OwogIHZhciBlID0gLTEwMDk1ODk3NzY7CgogIHZhciBpLCBqLCB0LCBvbGRhLCBvbGRiLCBvbGRjLCBvbGRkLCBvbGRlOwogIGZvciAoaSA9IDA7IGkgPCB4Lmxlbmd0aDsgaSArPSAxNikKICB7CiAgICBvbGRhID0gYTsKICAgIG9sZGIgPSBiOwogICAgb2xkYyA9IGM7CiAgICBvbGRkID0gZDsKICAgIG9sZGUgPSBlOwoKICAgIGZvciAoaiA9IDA7IGogPCA4MDsgaisrKQogICAgewogICAgICBpZiAoaiA8IDE2KSB7IHdbal0gPSB4W2kgKyBqXTsgfQogICAgICBlbHNlIHsgd1tqXSA9IHJvbCh3W2otM10gXiB3W2otOF0gXiB3W2otMTRdIF4gd1tqLTE2XSwgMSk7IH0KICAgICAgdCA9IHNhZmVfYWRkKHNhZmVfYWRkKHJvbChhLCA1KSwgc2hhMV9mdChqLCBiLCBjLCBkKSksCiAgICAgICAgICAgICAgICAgICAgICAgc2FmZV9hZGQoc2FmZV9hZGQoZSwgd1tqXSksIHNoYTFfa3QoaikpKTsKICAgICAgZSA9IGQ7CiAgICAgIGQgPSBjOwogICAgICBjID0gcm9sKGIsIDMwKTsKICAgICAgYiA9IGE7CiAgICAgIGEgPSB0OwogICAgfQoKICAgIGEgPSBzYWZlX2FkZChhLCBvbGRhKTsKICAgIGIgPSBzYWZlX2FkZChiLCBvbGRiKTsKICAgIGMgPSBzYWZlX2FkZChjLCBvbGRjKTsKICAgIGQgPSBzYWZlX2FkZChkLCBvbGRkKTsKICAgIGUgPSBzYWZlX2FkZChlLCBvbGRlKTsKICB9CiAgcmV0dXJuIFthLCBiLCBjLCBkLCBlXTsKfQoKLyoKICogUGVyZm9ybSB0aGUgYXBwcm9wcmlhdGUgdHJpcGxldCBjb21iaW5hdGlvbiBmdW5jdGlvbiBmb3IgdGhlIGN1cnJlbnQKICogaXRlcmF0aW9uCiAqLwpmdW5jdGlvbiBzaGExX2Z0KHQsIGIsIGMsIGQpCnsKICBpZiAodCA8IDIwKSB7IHJldHVybiAoYiAmIGMpIHwgKCh+YikgJiBkKTsgfQogIGlmICh0IDwgNDApIHsgcmV0dXJuIGIgXiBjIF4gZDsgfQogIGlmICh0IDwgNjApIHsgcmV0dXJuIChiICYgYykgfCAoYiAmIGQpIHwgKGMgJiBkKTsgfQogIHJldHVybiBiIF4gYyBeIGQ7Cn0KCi8qCiAqIERldGVybWluZSB0aGUgYXBwcm9wcmlhdGUgYWRkaXRpdmUgY29uc3RhbnQgZm9yIHRoZSBjdXJyZW50IGl0ZXJhdGlvbgogKi8KZnVuY3Rpb24gc2hhMV9rdCh0KQp7CiAgcmV0dXJuICh0IDwgMjApID8gIDE1MTg1MDAyNDkgOiAodCA8IDQwKSA/ICAxODU5Nzc1MzkzIDoKICAgICAgICAgKHQgPCA2MCkgPyAtMTg5NDAwNzU4OCA6IC04OTk0OTc1MTQ7Cn0KCi8qCiAqIENhbGN1bGF0ZSB0aGUgSE1BQy1TSEExIG9mIGEga2V5IGFuZCBzb21lIGRhdGEKICovCmZ1bmN0aW9uIGNvcmVfaG1hY19zaGExKGtleSwgZGF0YSkKewogIHZhciBia2V5ID0gc3RyMmJpbmIoa2V5KTsKICBpZiAoYmtleS5sZW5ndGggPiAxNikgeyBia2V5ID0gY29yZV9zaGExKGJrZXksIGtleS5sZW5ndGggKiA4KTsgfQoKICB2YXIgaXBhZCA9IG5ldyBBcnJheSgxNiksIG9wYWQgPSBuZXcgQXJyYXkoMTYpOwogIGZvciAodmFyIGkgPSAwOyBpIDwgMTY7IGkrKykKICB7CiAgICBpcGFkW2ldID0gYmtleVtpXSBeIDB4MzYzNjM2MzY7CiAgICBvcGFkW2ldID0gYmtleVtpXSBeIDB4NUM1QzVDNUM7CiAgfQoKICB2YXIgaGFzaCA9IGNvcmVfc2hhMShpcGFkLmNvbmNhdChzdHIyYmluYihkYXRhKSksIDUxMiArIGRhdGEubGVuZ3RoICogOCk7CiAgcmV0dXJuIGNvcmVfc2hhMShvcGFkLmNvbmNhdChoYXNoKSwgNTEyICsgMTYwKTsKfQoKLyoKICogQWRkIGludGVnZXJzLCB3cmFwcGluZyBhdCAyXjMyLiBUaGlzIHVzZXMgMTYtYml0IG9wZXJhdGlvbnMgaW50ZXJuYWxseQogKiB0byB3b3JrIGFyb3VuZCBidWdzIGluIHNvbWUgSlMgaW50ZXJwcmV0ZXJzLgogKi8KZnVuY3Rpb24gc2FmZV9hZGQoeCwgeSkKewogIHZhciBsc3cgPSAoeCAmIDB4RkZGRikgKyAoeSAmIDB4RkZGRik7CiAgdmFyIG1zdyA9ICh4ID4+IDE2KSArICh5ID4+IDE2KSArIChsc3cgPj4gMTYpOwogIHJldHVybiAobXN3IDw8IDE2KSB8IChsc3cgJiAweEZGRkYpOwp9CgovKgogKiBCaXR3aXNlIHJvdGF0ZSBhIDMyLWJpdCBudW1iZXIgdG8gdGhlIGxlZnQuCiAqLwpmdW5jdGlvbiByb2wobnVtLCBjbnQpCnsKICByZXR1cm4gKG51bSA8PCBjbnQpIHwgKG51bSA+Pj4gKDMyIC0gY250KSk7Cn0KCi8qCiAqIENvbnZlcnQgYW4gOC1iaXQgb3IgMTYtYml0IHN0cmluZyB0byBhbiBhcnJheSBvZiBiaWctZW5kaWFuIHdvcmRzCiAqIEluIDgtYml0IGZ1bmN0aW9uLCBjaGFyYWN0ZXJzID4yNTUgaGF2ZSB0aGVpciBoaS1ieXRlIHNpbGVudGx5IGlnbm9yZWQuCiAqLwpmdW5jdGlvbiBzdHIyYmluYihzdHIpCnsKICB2YXIgYmluID0gW107CiAgdmFyIG1hc2sgPSAyNTU7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHIubGVuZ3RoICogODsgaSArPSA4KQogIHsKICAgIGJpbltpPj41XSB8PSAoc3RyLmNoYXJDb2RlQXQoaSAvIDgpICYgbWFzaykgPDwgKDI0IC0gaSUzMik7CiAgfQogIHJldHVybiBiaW47Cn0KCi8qCiAqIENvbnZlcnQgYW4gYXJyYXkgb2YgYmlnLWVuZGlhbiB3b3JkcyB0byBhIHN0cmluZwogKi8KZnVuY3Rpb24gYmluYjJzdHIoYmluKQp7CiAgdmFyIHN0ciA9ICIiOwogIHZhciBtYXNrID0gMjU1OwogIGZvciAodmFyIGkgPSAwOyBpIDwgYmluLmxlbmd0aCAqIDMyOyBpICs9IDgpCiAgewogICAgc3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKGJpbltpPj41XSA+Pj4gKDI0IC0gaSUzMikpICYgbWFzayk7CiAgfQogIHJldHVybiBzdHI7Cn0KCi8qCiAqIENvbnZlcnQgYW4gYXJyYXkgb2YgYmlnLWVuZGlhbiB3b3JkcyB0byBhIGJhc2UtNjQgc3RyaW5nCiAqLwpmdW5jdGlvbiBiaW5iMmI2NChiaW5hcnJheSkKewogIHZhciB0YWIgPSAiQUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVphYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ejAxMjM0NTY3ODkrLyI7CiAgdmFyIHN0ciA9ICIiOwogIHZhciB0cmlwbGV0LCBqOwogIGZvciAodmFyIGkgPSAwOyBpIDwgYmluYXJyYXkubGVuZ3RoICogNDsgaSArPSAzKQogIHsKICAgIHRyaXBsZXQgPSAoKChiaW5hcnJheVtpICAgPj4gMl0gPj4gOCAqICgzIC0gIGkgICAlNCkpICYgMHhGRikgPDwgMTYpIHwKICAgICAgICAgICAgICAoKChiaW5hcnJheVtpKzEgPj4gMl0gPj4gOCAqICgzIC0gKGkrMSklNCkpICYgMHhGRikgPDwgOCApIHwKICAgICAgICAgICAgICAgKChiaW5hcnJheVtpKzIgPj4gMl0gPj4gOCAqICgzIC0gKGkrMiklNCkpICYgMHhGRik7CiAgICBmb3IgKGogPSAwOyBqIDwgNDsgaisrKQogICAgewogICAgICBpZiAoaSAqIDggKyBqICogNiA+IGJpbmFycmF5Lmxlbmd0aCAqIDMyKSB7IHN0ciArPSAiPSI7IH0KICAgICAgZWxzZSB7IHN0ciArPSB0YWIuY2hhckF0KCh0cmlwbGV0ID4+IDYqKDMtaikpICYgMHgzRik7IH0KICAgIH0KICB9CiAgcmV0dXJuIHN0cjsKfQoKLyoKICogQSBKYXZhU2NyaXB0IGltcGxlbWVudGF0aW9uIG9mIHRoZSBSU0EgRGF0YSBTZWN1cml0eSwgSW5jLiBNRDUgTWVzc2FnZQogKiBEaWdlc3QgQWxnb3JpdGhtLCBhcyBkZWZpbmVkIGluIFJGQyAxMzIxLgogKiBWZXJzaW9uIDIuMSBDb3B5cmlnaHQgKEMpIFBhdWwgSm9obnN0b24gMTk5OSAtIDIwMDIuCiAqIE90aGVyIGNvbnRyaWJ1dG9yczogR3JlZyBIb2x0LCBBbmRyZXcgS2VwZXJ0LCBZZG5hciwgTG9zdGluZXQKICogRGlzdHJpYnV0ZWQgdW5kZXIgdGhlIEJTRCBMaWNlbnNlCiAqIFNlZSBodHRwOi8vcGFqaG9tZS5vcmcudWsvY3J5cHQvbWQ1IGZvciBtb3JlIGluZm8uCiAqLwoKLyoKICogRXZlcnl0aGluZyB0aGF0IGlzbid0IHVzZWQgYnkgU3Ryb3BoZSBoYXMgYmVlbiBzdHJpcHBlZCBoZXJlIQogKi8KCnZhciBNRDUgPSAoZnVuY3Rpb24gKCkgewogICAgLyoKICAgICAqIEFkZCBpbnRlZ2Vycywgd3JhcHBpbmcgYXQgMl4zMi4gVGhpcyB1c2VzIDE2LWJpdCBvcGVyYXRpb25zIGludGVybmFsbHkKICAgICAqIHRvIHdvcmsgYXJvdW5kIGJ1Z3MgaW4gc29tZSBKUyBpbnRlcnByZXRlcnMuCiAgICAgKi8KICAgIHZhciBzYWZlX2FkZCA9IGZ1bmN0aW9uICh4LCB5KSB7CiAgICAgICAgdmFyIGxzdyA9ICh4ICYgMHhGRkZGKSArICh5ICYgMHhGRkZGKTsKICAgICAgICB2YXIgbXN3ID0gKHggPj4gMTYpICsgKHkgPj4gMTYpICsgKGxzdyA+PiAxNik7CiAgICAgICAgcmV0dXJuIChtc3cgPDwgMTYpIHwgKGxzdyAmIDB4RkZGRik7CiAgICB9OwoKICAgIC8qCiAgICAgKiBCaXR3aXNlIHJvdGF0ZSBhIDMyLWJpdCBudW1iZXIgdG8gdGhlIGxlZnQuCiAgICAgKi8KICAgIHZhciBiaXRfcm9sID0gZnVuY3Rpb24gKG51bSwgY250KSB7CiAgICAgICAgcmV0dXJuIChudW0gPDwgY250KSB8IChudW0gPj4+ICgzMiAtIGNudCkpOwogICAgfTsKCiAgICAvKgogICAgICogQ29udmVydCBhIHN0cmluZyB0byBhbiBhcnJheSBvZiBsaXR0bGUtZW5kaWFuIHdvcmRzCiAgICAgKi8KICAgIHZhciBzdHIyYmlubCA9IGZ1bmN0aW9uIChzdHIpIHsKICAgICAgICB2YXIgYmluID0gW107CiAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGggKiA4OyBpICs9IDgpCiAgICAgICAgewogICAgICAgICAgICBiaW5baT4+NV0gfD0gKHN0ci5jaGFyQ29kZUF0KGkgLyA4KSAmIDI1NSkgPDwgKGklMzIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYmluOwogICAgfTsKCiAgICAvKgogICAgICogQ29udmVydCBhbiBhcnJheSBvZiBsaXR0bGUtZW5kaWFuIHdvcmRzIHRvIGEgc3RyaW5nCiAgICAgKi8KICAgIHZhciBiaW5sMnN0ciA9IGZ1bmN0aW9uIChiaW4pIHsKICAgICAgICB2YXIgc3RyID0gIiI7CiAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IGJpbi5sZW5ndGggKiAzMjsgaSArPSA4KQogICAgICAgIHsKICAgICAgICAgICAgc3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKGJpbltpPj41XSA+Pj4gKGkgJSAzMikpICYgMjU1KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0cjsKICAgIH07CgogICAgLyoKICAgICAqIENvbnZlcnQgYW4gYXJyYXkgb2YgbGl0dGxlLWVuZGlhbiB3b3JkcyB0byBhIGhleCBzdHJpbmcuCiAgICAgKi8KICAgIHZhciBiaW5sMmhleCA9IGZ1bmN0aW9uIChiaW5hcnJheSkgewogICAgICAgIHZhciBoZXhfdGFiID0gIjAxMjM0NTY3ODlhYmNkZWYiOwogICAgICAgIHZhciBzdHIgPSAiIjsKICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgYmluYXJyYXkubGVuZ3RoICogNDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgc3RyICs9IGhleF90YWIuY2hhckF0KChiaW5hcnJheVtpPj4yXSA+PiAoKGklNCkqOCs0KSkgJiAweEYpICsKICAgICAgICAgICAgICAgIGhleF90YWIuY2hhckF0KChiaW5hcnJheVtpPj4yXSA+PiAoKGklNCkqOCAgKSkgJiAweEYpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyOwogICAgfTsKCiAgICAvKgogICAgICogVGhlc2UgZnVuY3Rpb25zIGltcGxlbWVudCB0aGUgZm91ciBiYXNpYyBvcGVyYXRpb25zIHRoZSBhbGdvcml0aG0gdXNlcy4KICAgICAqLwogICAgdmFyIG1kNV9jbW4gPSBmdW5jdGlvbiAocSwgYSwgYiwgeCwgcywgdCkgewogICAgICAgIHJldHVybiBzYWZlX2FkZChiaXRfcm9sKHNhZmVfYWRkKHNhZmVfYWRkKGEsIHEpLHNhZmVfYWRkKHgsIHQpKSwgcyksYik7CiAgICB9OwoKICAgIHZhciBtZDVfZmYgPSBmdW5jdGlvbiAoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgICAgIHJldHVybiBtZDVfY21uKChiICYgYykgfCAoKH5iKSAmIGQpLCBhLCBiLCB4LCBzLCB0KTsKICAgIH07CgogICAgdmFyIG1kNV9nZyA9IGZ1bmN0aW9uIChhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICAgICAgcmV0dXJuIG1kNV9jbW4oKGIgJiBkKSB8IChjICYgKH5kKSksIGEsIGIsIHgsIHMsIHQpOwogICAgfTsKCiAgICB2YXIgbWQ1X2hoID0gZnVuY3Rpb24gKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICAgICAgICByZXR1cm4gbWQ1X2NtbihiIF4gYyBeIGQsIGEsIGIsIHgsIHMsIHQpOwogICAgfTsKCiAgICB2YXIgbWQ1X2lpID0gZnVuY3Rpb24gKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICAgICAgICByZXR1cm4gbWQ1X2NtbihjIF4gKGIgfCAofmQpKSwgYSwgYiwgeCwgcywgdCk7CiAgICB9OwoKICAgIC8qCiAgICAgKiBDYWxjdWxhdGUgdGhlIE1ENSBvZiBhbiBhcnJheSBvZiBsaXR0bGUtZW5kaWFuIHdvcmRzLCBhbmQgYSBiaXQgbGVuZ3RoCiAgICAgKi8KICAgIHZhciBjb3JlX21kNSA9IGZ1bmN0aW9uICh4LCBsZW4pIHsKICAgICAgICAvKiBhcHBlbmQgcGFkZGluZyAqLwogICAgICAgIHhbbGVuID4+IDVdIHw9IDB4ODAgPDwgKChsZW4pICUgMzIpOwogICAgICAgIHhbKCgobGVuICsgNjQpID4+PiA5KSA8PCA0KSArIDE0XSA9IGxlbjsKCiAgICAgICAgdmFyIGEgPSAgMTczMjU4NDE5MzsKICAgICAgICB2YXIgYiA9IC0yNzE3MzM4Nzk7CiAgICAgICAgdmFyIGMgPSAtMTczMjU4NDE5NDsKICAgICAgICB2YXIgZCA9ICAyNzE3MzM4Nzg7CgogICAgICAgIHZhciBvbGRhLCBvbGRiLCBvbGRjLCBvbGRkOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgeC5sZW5ndGg7IGkgKz0gMTYpCiAgICAgICAgewogICAgICAgICAgICBvbGRhID0gYTsKICAgICAgICAgICAgb2xkYiA9IGI7CiAgICAgICAgICAgIG9sZGMgPSBjOwogICAgICAgICAgICBvbGRkID0gZDsKCiAgICAgICAgICAgIGEgPSBtZDVfZmYoYSwgYiwgYywgZCwgeFtpKyAwXSwgNyAsIC02ODA4NzY5MzYpOwogICAgICAgICAgICBkID0gbWQ1X2ZmKGQsIGEsIGIsIGMsIHhbaSsgMV0sIDEyLCAtMzg5NTY0NTg2KTsKICAgICAgICAgICAgYyA9IG1kNV9mZihjLCBkLCBhLCBiLCB4W2krIDJdLCAxNywgIDYwNjEwNTgxOSk7CiAgICAgICAgICAgIGIgPSBtZDVfZmYoYiwgYywgZCwgYSwgeFtpKyAzXSwgMjIsIC0xMDQ0NTI1MzMwKTsKICAgICAgICAgICAgYSA9IG1kNV9mZihhLCBiLCBjLCBkLCB4W2krIDRdLCA3ICwgLTE3NjQxODg5Nyk7CiAgICAgICAgICAgIGQgPSBtZDVfZmYoZCwgYSwgYiwgYywgeFtpKyA1XSwgMTIsICAxMjAwMDgwNDI2KTsKICAgICAgICAgICAgYyA9IG1kNV9mZihjLCBkLCBhLCBiLCB4W2krIDZdLCAxNywgLTE0NzMyMzEzNDEpOwogICAgICAgICAgICBiID0gbWQ1X2ZmKGIsIGMsIGQsIGEsIHhbaSsgN10sIDIyLCAtNDU3MDU5ODMpOwogICAgICAgICAgICBhID0gbWQ1X2ZmKGEsIGIsIGMsIGQsIHhbaSsgOF0sIDcgLCAgMTc3MDAzNTQxNik7CiAgICAgICAgICAgIGQgPSBtZDVfZmYoZCwgYSwgYiwgYywgeFtpKyA5XSwgMTIsIC0xOTU4NDE0NDE3KTsKICAgICAgICAgICAgYyA9IG1kNV9mZihjLCBkLCBhLCBiLCB4W2krMTBdLCAxNywgLTQyMDYzKTsKICAgICAgICAgICAgYiA9IG1kNV9mZihiLCBjLCBkLCBhLCB4W2krMTFdLCAyMiwgLTE5OTA0MDQxNjIpOwogICAgICAgICAgICBhID0gbWQ1X2ZmKGEsIGIsIGMsIGQsIHhbaSsxMl0sIDcgLCAgMTgwNDYwMzY4Mik7CiAgICAgICAgICAgIGQgPSBtZDVfZmYoZCwgYSwgYiwgYywgeFtpKzEzXSwgMTIsIC00MDM0MTEwMSk7CiAgICAgICAgICAgIGMgPSBtZDVfZmYoYywgZCwgYSwgYiwgeFtpKzE0XSwgMTcsIC0xNTAyMDAyMjkwKTsKICAgICAgICAgICAgYiA9IG1kNV9mZihiLCBjLCBkLCBhLCB4W2krMTVdLCAyMiwgIDEyMzY1MzUzMjkpOwoKICAgICAgICAgICAgYSA9IG1kNV9nZyhhLCBiLCBjLCBkLCB4W2krIDFdLCA1ICwgLTE2NTc5NjUxMCk7CiAgICAgICAgICAgIGQgPSBtZDVfZ2coZCwgYSwgYiwgYywgeFtpKyA2XSwgOSAsIC0xMDY5NTAxNjMyKTsKICAgICAgICAgICAgYyA9IG1kNV9nZyhjLCBkLCBhLCBiLCB4W2krMTFdLCAxNCwgIDY0MzcxNzcxMyk7CiAgICAgICAgICAgIGIgPSBtZDVfZ2coYiwgYywgZCwgYSwgeFtpKyAwXSwgMjAsIC0zNzM4OTczMDIpOwogICAgICAgICAgICBhID0gbWQ1X2dnKGEsIGIsIGMsIGQsIHhbaSsgNV0sIDUgLCAtNzAxNTU4NjkxKTsKICAgICAgICAgICAgZCA9IG1kNV9nZyhkLCBhLCBiLCBjLCB4W2krMTBdLCA5ICwgIDM4MDE2MDgzKTsKICAgICAgICAgICAgYyA9IG1kNV9nZyhjLCBkLCBhLCBiLCB4W2krMTVdLCAxNCwgLTY2MDQ3ODMzNSk7CiAgICAgICAgICAgIGIgPSBtZDVfZ2coYiwgYywgZCwgYSwgeFtpKyA0XSwgMjAsIC00MDU1Mzc4NDgpOwogICAgICAgICAgICBhID0gbWQ1X2dnKGEsIGIsIGMsIGQsIHhbaSsgOV0sIDUgLCAgNTY4NDQ2NDM4KTsKICAgICAgICAgICAgZCA9IG1kNV9nZyhkLCBhLCBiLCBjLCB4W2krMTRdLCA5ICwgLTEwMTk4MDM2OTApOwogICAgICAgICAgICBjID0gbWQ1X2dnKGMsIGQsIGEsIGIsIHhbaSsgM10sIDE0LCAtMTg3MzYzOTYxKTsKICAgICAgICAgICAgYiA9IG1kNV9nZyhiLCBjLCBkLCBhLCB4W2krIDhdLCAyMCwgIDExNjM1MzE1MDEpOwogICAgICAgICAgICBhID0gbWQ1X2dnKGEsIGIsIGMsIGQsIHhbaSsxM10sIDUgLCAtMTQ0NDY4MTQ2Nyk7CiAgICAgICAgICAgIGQgPSBtZDVfZ2coZCwgYSwgYiwgYywgeFtpKyAyXSwgOSAsIC01MTQwMzc4NCk7CiAgICAgICAgICAgIGMgPSBtZDVfZ2coYywgZCwgYSwgYiwgeFtpKyA3XSwgMTQsICAxNzM1MzI4NDczKTsKICAgICAgICAgICAgYiA9IG1kNV9nZyhiLCBjLCBkLCBhLCB4W2krMTJdLCAyMCwgLTE5MjY2MDc3MzQpOwoKICAgICAgICAgICAgYSA9IG1kNV9oaChhLCBiLCBjLCBkLCB4W2krIDVdLCA0ICwgLTM3ODU1OCk7CiAgICAgICAgICAgIGQgPSBtZDVfaGgoZCwgYSwgYiwgYywgeFtpKyA4XSwgMTEsIC0yMDIyNTc0NDYzKTsKICAgICAgICAgICAgYyA9IG1kNV9oaChjLCBkLCBhLCBiLCB4W2krMTFdLCAxNiwgIDE4MzkwMzA1NjIpOwogICAgICAgICAgICBiID0gbWQ1X2hoKGIsIGMsIGQsIGEsIHhbaSsxNF0sIDIzLCAtMzUzMDk1NTYpOwogICAgICAgICAgICBhID0gbWQ1X2hoKGEsIGIsIGMsIGQsIHhbaSsgMV0sIDQgLCAtMTUzMDk5MjA2MCk7CiAgICAgICAgICAgIGQgPSBtZDVfaGgoZCwgYSwgYiwgYywgeFtpKyA0XSwgMTEsICAxMjcyODkzMzUzKTsKICAgICAgICAgICAgYyA9IG1kNV9oaChjLCBkLCBhLCBiLCB4W2krIDddLCAxNiwgLTE1NTQ5NzYzMik7CiAgICAgICAgICAgIGIgPSBtZDVfaGgoYiwgYywgZCwgYSwgeFtpKzEwXSwgMjMsIC0xMDk0NzMwNjQwKTsKICAgICAgICAgICAgYSA9IG1kNV9oaChhLCBiLCBjLCBkLCB4W2krMTNdLCA0ICwgIDY4MTI3OTE3NCk7CiAgICAgICAgICAgIGQgPSBtZDVfaGgoZCwgYSwgYiwgYywgeFtpKyAwXSwgMTEsIC0zNTg1MzcyMjIpOwogICAgICAgICAgICBjID0gbWQ1X2hoKGMsIGQsIGEsIGIsIHhbaSsgM10sIDE2LCAtNzIyNTIxOTc5KTsKICAgICAgICAgICAgYiA9IG1kNV9oaChiLCBjLCBkLCBhLCB4W2krIDZdLCAyMywgIDc2MDI5MTg5KTsKICAgICAgICAgICAgYSA9IG1kNV9oaChhLCBiLCBjLCBkLCB4W2krIDldLCA0ICwgLTY0MDM2NDQ4Nyk7CiAgICAgICAgICAgIGQgPSBtZDVfaGgoZCwgYSwgYiwgYywgeFtpKzEyXSwgMTEsIC00MjE4MTU4MzUpOwogICAgICAgICAgICBjID0gbWQ1X2hoKGMsIGQsIGEsIGIsIHhbaSsxNV0sIDE2LCAgNTMwNzQyNTIwKTsKICAgICAgICAgICAgYiA9IG1kNV9oaChiLCBjLCBkLCBhLCB4W2krIDJdLCAyMywgLTk5NTMzODY1MSk7CgogICAgICAgICAgICBhID0gbWQ1X2lpKGEsIGIsIGMsIGQsIHhbaSsgMF0sIDYgLCAtMTk4NjMwODQ0KTsKICAgICAgICAgICAgZCA9IG1kNV9paShkLCBhLCBiLCBjLCB4W2krIDddLCAxMCwgIDExMjY4OTE0MTUpOwogICAgICAgICAgICBjID0gbWQ1X2lpKGMsIGQsIGEsIGIsIHhbaSsxNF0sIDE1LCAtMTQxNjM1NDkwNSk7CiAgICAgICAgICAgIGIgPSBtZDVfaWkoYiwgYywgZCwgYSwgeFtpKyA1XSwgMjEsIC01NzQzNDA1NSk7CiAgICAgICAgICAgIGEgPSBtZDVfaWkoYSwgYiwgYywgZCwgeFtpKzEyXSwgNiAsICAxNzAwNDg1NTcxKTsKICAgICAgICAgICAgZCA9IG1kNV9paShkLCBhLCBiLCBjLCB4W2krIDNdLCAxMCwgLTE4OTQ5ODY2MDYpOwogICAgICAgICAgICBjID0gbWQ1X2lpKGMsIGQsIGEsIGIsIHhbaSsxMF0sIDE1LCAtMTA1MTUyMyk7CiAgICAgICAgICAgIGIgPSBtZDVfaWkoYiwgYywgZCwgYSwgeFtpKyAxXSwgMjEsIC0yMDU0OTIyNzk5KTsKICAgICAgICAgICAgYSA9IG1kNV9paShhLCBiLCBjLCBkLCB4W2krIDhdLCA2ICwgIDE4NzMzMTMzNTkpOwogICAgICAgICAgICBkID0gbWQ1X2lpKGQsIGEsIGIsIGMsIHhbaSsxNV0sIDEwLCAtMzA2MTE3NDQpOwogICAgICAgICAgICBjID0gbWQ1X2lpKGMsIGQsIGEsIGIsIHhbaSsgNl0sIDE1LCAtMTU2MDE5ODM4MCk7CiAgICAgICAgICAgIGIgPSBtZDVfaWkoYiwgYywgZCwgYSwgeFtpKzEzXSwgMjEsICAxMzA5MTUxNjQ5KTsKICAgICAgICAgICAgYSA9IG1kNV9paShhLCBiLCBjLCBkLCB4W2krIDRdLCA2ICwgLTE0NTUyMzA3MCk7CiAgICAgICAgICAgIGQgPSBtZDVfaWkoZCwgYSwgYiwgYywgeFtpKzExXSwgMTAsIC0xMTIwMjEwMzc5KTsKICAgICAgICAgICAgYyA9IG1kNV9paShjLCBkLCBhLCBiLCB4W2krIDJdLCAxNSwgIDcxODc4NzI1OSk7CiAgICAgICAgICAgIGIgPSBtZDVfaWkoYiwgYywgZCwgYSwgeFtpKyA5XSwgMjEsIC0zNDM0ODU1NTEpOwoKICAgICAgICAgICAgYSA9IHNhZmVfYWRkKGEsIG9sZGEpOwogICAgICAgICAgICBiID0gc2FmZV9hZGQoYiwgb2xkYik7CiAgICAgICAgICAgIGMgPSBzYWZlX2FkZChjLCBvbGRjKTsKICAgICAgICAgICAgZCA9IHNhZmVfYWRkKGQsIG9sZGQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gW2EsIGIsIGMsIGRdOwogICAgfTsKCgogICAgdmFyIG9iaiA9IHsKICAgICAgICAvKgogICAgICAgICAqIFRoZXNlIGFyZSB0aGUgZnVuY3Rpb25zIHlvdSdsbCB1c3VhbGx5IHdhbnQgdG8gY2FsbC4KICAgICAgICAgKiBUaGV5IHRha2Ugc3RyaW5nIGFyZ3VtZW50cyBhbmQgcmV0dXJuIGVpdGhlciBoZXggb3IgYmFzZS02NCBlbmNvZGVkCiAgICAgICAgICogc3RyaW5ncy4KICAgICAgICAgKi8KICAgICAgICBoZXhkaWdlc3Q6IGZ1bmN0aW9uIChzKSB7CiAgICAgICAgICAgIHJldHVybiBiaW5sMmhleChjb3JlX21kNShzdHIyYmlubChzKSwgcy5sZW5ndGggKiA4KSk7CiAgICAgICAgfSwKCiAgICAgICAgaGFzaDogZnVuY3Rpb24gKHMpIHsKICAgICAgICAgICAgcmV0dXJuIGJpbmwyc3RyKGNvcmVfbWQ1KHN0cjJiaW5sKHMpLCBzLmxlbmd0aCAqIDgpKTsKICAgICAgICB9CiAgICB9OwoKICAgIHJldHVybiBvYmo7Cn0pKCk7CgovKgogICAgVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgTUlUIGxpY2Vuc2UuCiAgICBQbGVhc2Ugc2VlIHRoZSBMSUNFTlNFIGZpbGUgZm9yIGRldGFpbHMuCgogICAgQ29weXJpZ2h0IDIwMDYtMjAwOCwgT0dHLCBMTEMKKi8KCi8qIGpzaGludCB1bmRlZjogdHJ1ZSwgdW51c2VkOiB0cnVlOiwgbm9hcmc6IHRydWUsIGxhdGVkZWY6IHRydWUgKi8KLypnbG9iYWwgZG9jdW1lbnQsIHdpbmRvdywgc2V0VGltZW91dCwgY2xlYXJUaW1lb3V0LCBjb25zb2xlLAogICAgQWN0aXZlWE9iamVjdCwgQmFzZTY0LCBNRDUsIERPTVBhcnNlciAqLwovLyBmcm9tIHNoYTEuanMKLypnbG9iYWwgY29yZV9obWFjX3NoYTEsIGJpbmIyc3RyLCBzdHJfaG1hY19zaGExLCBzdHJfc2hhMSwgYjY0X2htYWNfc2hhMSovCgovKiogRmlsZTogc3Ryb3BoZS5qcwogKiAgQSBKYXZhU2NyaXB0IGxpYnJhcnkgZm9yIFhNUFAgQk9TSC9YTVBQIG92ZXIgV2Vic29ja2V0LgogKgogKiAgVGhpcyBpcyB0aGUgSmF2YVNjcmlwdCB2ZXJzaW9uIG9mIHRoZSBTdHJvcGhlIGxpYnJhcnkuICBTaW5jZSBKYXZhU2NyaXB0CiAqICBoYWQgbm8gZmFjaWxpdGllcyBmb3IgcGVyc2lzdGVudCBUQ1AgY29ubmVjdGlvbnMsIHRoaXMgbGlicmFyeSB1c2VzCiAqICBCaWRpcmVjdGlvbmFsLXN0cmVhbXMgT3ZlciBTeW5jaHJvbm91cyBIVFRQIChCT1NIKSB0byBlbXVsYXRlCiAqICBhIHBlcnNpc3RlbnQsIHN0YXRlZnVsLCB0d28td2F5IGNvbm5lY3Rpb24gdG8gYW4gWE1QUCBzZXJ2ZXIuICBNb3JlCiAqICBpbmZvcm1hdGlvbiBvbiBCT1NIIGNhbiBiZSBmb3VuZCBpbiBYRVAgMTI0LgogKgogKiAgVGhpcyB2ZXJzaW9uIG9mIFN0cm9waGUgYWxzbyB3b3JrcyB3aXRoIFdlYlNvY2tldHMuCiAqICBGb3IgbW9yZSBpbmZvcm1hdGlvbiBvbiBYTVBQLW92ZXIgV2ViU29ja2V0IHNlZSB0aGlzIFJGQyBkcmFmdDoKICogIGh0dHA6Ly90b29scy5pZXRmLm9yZy9odG1sL2RyYWZ0LWlldGYteG1wcC13ZWJzb2NrZXQtMDAKICovCgovKiogUHJpdmF0ZUZ1bmN0aW9uOiBGdW5jdGlvbi5wcm90b3R5cGUuYmluZAogKiAgQmluZCBhIGZ1bmN0aW9uIHRvIGFuIGluc3RhbmNlLgogKgogKiAgVGhpcyBGdW5jdGlvbiBvYmplY3QgZXh0ZW5zaW9uIG1ldGhvZCBjcmVhdGVzIGEgYm91bmQgbWV0aG9kIHNpbWlsYXIKICogIHRvIHRob3NlIGluIFB5dGhvbi4gIFRoaXMgbWVhbnMgdGhhdCB0aGUgJ3RoaXMnIG9iamVjdCB3aWxsIHBvaW50CiAqICB0byB0aGUgaW5zdGFuY2UgeW91IHdhbnQuICBTZWUKICogIDxhIGhyZWY9J2h0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL0Z1bmN0aW9uL2JpbmQnPk1EQydzIGJpbmQoKSBkb2N1bWVudGF0aW9uPC9hPiBhbmQKICogIDxhIGhyZWY9J2h0dHA6Ly9iZW5qYW1pbi5zbWVkYmVyZ3MudXMvYmxvZy8yMDA3LTAxLTAzL2JvdW5kLWZ1bmN0aW9ucy1hbmQtZnVuY3Rpb24taW1wb3J0cy1pbi1qYXZhc2NyaXB0Lyc+Qm91bmQgRnVuY3Rpb25zIGFuZCBGdW5jdGlvbiBJbXBvcnRzIGluIEphdmFTY3JpcHQ8L2E+CiAqICBmb3IgYSBjb21wbGV0ZSBleHBsYW5hdGlvbi4KICoKICogIFRoaXMgZXh0ZW5zaW9uIGFscmVhZHkgZXhpc3RzIGluIHNvbWUgYnJvd3NlcnMgKG5hbWVseSwgRmlyZWZveCAzKSwgYnV0CiAqICB3ZSBwcm92aWRlIGl0IHRvIHN1cHBvcnQgdGhvc2UgdGhhdCBkb24ndC4KICoKICogIFBhcmFtZXRlcnM6CiAqICAgIChPYmplY3QpIG9iaiAtIFRoZSBvYmplY3QgdGhhdCB3aWxsIGJlY29tZSAndGhpcycgaW4gdGhlIGJvdW5kIGZ1bmN0aW9uLgogKiAgICAoT2JqZWN0KSBhcmdOIC0gQW4gb3B0aW9uIGFyZ3VtZW50IHRoYXQgd2lsbCBiZSBwcmVwZW5kZWQgdG8gdGhlCiAqICAgICAgYXJndW1lbnRzIGdpdmVuIGZvciB0aGUgZnVuY3Rpb24gY2FsbAogKgogKiAgUmV0dXJuczoKICogICAgVGhlIGJvdW5kIGZ1bmN0aW9uLgogKi8KaWYgKCFGdW5jdGlvbi5wcm90b3R5cGUuYmluZCkgewogICAgRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQgPSBmdW5jdGlvbiAob2JqIC8qLCBhcmcxLCBhcmcyLCAuLi4gKi8pCiAgICB7CiAgICAgICAgdmFyIGZ1bmMgPSB0aGlzOwogICAgICAgIHZhciBfc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CiAgICAgICAgdmFyIF9jb25jYXQgPSBBcnJheS5wcm90b3R5cGUuY29uY2F0OwogICAgICAgIHZhciBfYXJncyA9IF9zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jLmFwcGx5KG9iaiA/IG9iaiA6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb25jYXQuY2FsbChfYXJncywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9zbGljZS5jYWxsKGFyZ3VtZW50cywgMCkpKTsKICAgICAgICB9OwogICAgfTsKfQoKLyoqIFByaXZhdGVGdW5jdGlvbjogQXJyYXkucHJvdG90eXBlLmluZGV4T2YKICogIFJldHVybiB0aGUgaW5kZXggb2YgYW4gb2JqZWN0IGluIGFuIGFycmF5LgogKgogKiAgVGhpcyBmdW5jdGlvbiBpcyBub3Qgc3VwcGxpZWQgYnkgc29tZSBKYXZhU2NyaXB0IGltcGxlbWVudGF0aW9ucywgc28KICogIHdlIHByb3ZpZGUgaXQgaWYgaXQgaXMgbWlzc2luZy4gIFRoaXMgY29kZSBpcyBmcm9tOgogKiAgaHR0cDovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9Fbi9Db3JlX0phdmFTY3JpcHRfMS41X1JlZmVyZW5jZTpPYmplY3RzOkFycmF5OmluZGV4T2YKICoKICogIFBhcmFtZXRlcnM6CiAqICAgIChPYmplY3QpIGVsdCAtIFRoZSBvYmplY3QgdG8gbG9vayBmb3IuCiAqICAgIChJbnRlZ2VyKSBmcm9tIC0gVGhlIGluZGV4IGZyb20gd2hpY2ggdG8gc3RhcnQgbG9va2luZy4gKG9wdGlvbmFsKS4KICoKICogIFJldHVybnM6CiAqICAgIFRoZSBpbmRleCBvZiBlbHQgaW4gdGhlIGFycmF5IG9yIC0xIGlmIG5vdCBmb3VuZC4KICovCmlmICghQXJyYXkucHJvdG90eXBlLmluZGV4T2YpCnsKICAgIEFycmF5LnByb3RvdHlwZS5pbmRleE9mID0gZnVuY3Rpb24oZWx0IC8qLCBmcm9tKi8pCiAgICB7CiAgICAgICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoOwoKICAgICAgICB2YXIgZnJvbSA9IE51bWJlcihhcmd1bWVudHNbMV0pIHx8IDA7CiAgICAgICAgZnJvbSA9IChmcm9tIDwgMCkgPyBNYXRoLmNlaWwoZnJvbSkgOiBNYXRoLmZsb29yKGZyb20pOwogICAgICAgIGlmIChmcm9tIDwgMCkgewogICAgICAgICAgICBmcm9tICs9IGxlbjsKICAgICAgICB9CgogICAgICAgIGZvciAoOyBmcm9tIDwgbGVuOyBmcm9tKyspIHsKICAgICAgICAgICAgaWYgKGZyb20gaW4gdGhpcyAmJiB0aGlzW2Zyb21dID09PSBlbHQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmcm9tOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gLTE7CiAgICB9Owp9CgovKiBBbGwgb2YgdGhlIFN0cm9waGUgZ2xvYmFscyBhcmUgZGVmaW5lZCBpbiB0aGlzIHNwZWNpYWwgZnVuY3Rpb24gYmVsb3cgc28KICogdGhhdCByZWZlcmVuY2VzIHRvIHRoZSBnbG9iYWxzIGJlY29tZSBjbG9zdXJlcy4gIFRoaXMgd2lsbCBlbnN1cmUgdGhhdAogKiBvbiBwYWdlIHJlbG9hZCwgdGhlc2UgcmVmZXJlbmNlcyB3aWxsIHN0aWxsIGJlIGF2YWlsYWJsZSB0byBjYWxsYmFja3MKICogdGhhdCBhcmUgc3RpbGwgZXhlY3V0aW5nLgogKi8KCihmdW5jdGlvbiAoY2FsbGJhY2spIHsKdmFyIFN0cm9waGU7CgovKiogRnVuY3Rpb246ICRidWlsZAogKiAgQ3JlYXRlIGEgU3Ryb3BoZS5CdWlsZGVyLgogKiAgVGhpcyBpcyBhbiBhbGlhcyBmb3IgJ25ldyBTdHJvcGhlLkJ1aWxkZXIobmFtZSwgYXR0cnMpJy4KICoKICogIFBhcmFtZXRlcnM6CiAqICAgIChTdHJpbmcpIG5hbWUgLSBUaGUgcm9vdCBlbGVtZW50IG5hbWUuCiAqICAgIChPYmplY3QpIGF0dHJzIC0gVGhlIGF0dHJpYnV0ZXMgZm9yIHRoZSByb290IGVsZW1lbnQgaW4gb2JqZWN0IG5vdGF0aW9uLgogKgogKiAgUmV0dXJuczoKICogICAgQSBuZXcgU3Ryb3BoZS5CdWlsZGVyIG9iamVjdC4KICovCmZ1bmN0aW9uICRidWlsZChuYW1lLCBhdHRycykgeyByZXR1cm4gbmV3IFN0cm9waGUuQnVpbGRlcihuYW1lLCBhdHRycyk7IH0KLyoqIEZ1bmN0aW9uOiAkbXNnCiAqICBDcmVhdGUgYSBTdHJvcGhlLkJ1aWxkZXIgd2l0aCBhIDxtZXNzYWdlLz4gZWxlbWVudCBhcyB0aGUgcm9vdC4KICoKICogIFBhcm1hZXRlcnM6CiAqICAgIChPYmplY3QpIGF0dHJzIC0gVGhlIDxtZXNzYWdlLz4gZWxlbWVudCBhdHRyaWJ1dGVzIGluIG9iamVjdCBub3RhdGlvbi4KICoKICogIFJldHVybnM6CiAqICAgIEEgbmV3IFN0cm9waGUuQnVpbGRlciBvYmplY3QuCiAqLwpmdW5jdGlvbiAkbXNnKGF0dHJzKSB7IHJldHVybiBuZXcgU3Ryb3BoZS5CdWlsZGVyKCJtZXNzYWdlIiwgYXR0cnMpOyB9Ci8qKiBGdW5jdGlvbjogJGlxCiAqICBDcmVhdGUgYSBTdHJvcGhlLkJ1aWxkZXIgd2l0aCBhbiA8aXEvPiBlbGVtZW50IGFzIHRoZSByb290LgogKgogKiAgUGFyYW1ldGVyczoKICogICAgKE9iamVjdCkgYXR0cnMgLSBUaGUgPGlxLz4gZWxlbWVudCBhdHRyaWJ1dGVzIGluIG9iamVjdCBub3RhdGlvbi4KICoKICogIFJldHVybnM6CiAqICAgIEEgbmV3IFN0cm9waGUuQnVpbGRlciBvYmplY3QuCiAqLwpmdW5jdGlvbiAkaXEoYXR0cnMpIHsgcmV0dXJuIG5ldyBTdHJvcGhlLkJ1aWxkZXIoImlxIiwgYXR0cnMpOyB9Ci8qKiBGdW5jdGlvbjogJHByZXMKICogIENyZWF0ZSBhIFN0cm9waGUuQnVpbGRlciB3aXRoIGEgPHByZXNlbmNlLz4gZWxlbWVudCBhcyB0aGUgcm9vdC4KICoKICogIFBhcmFtZXRlcnM6CiAqICAgIChPYmplY3QpIGF0dHJzIC0gVGhlIDxwcmVzZW5jZS8+IGVsZW1lbnQgYXR0cmlidXRlcyBpbiBvYmplY3Qgbm90YXRpb24uCiAqCiAqICBSZXR1cm5zOgogKiAgICBBIG5ldyBTdHJvcGhlLkJ1aWxkZXIgb2JqZWN0LgogKi8KZnVuY3Rpb24gJHByZXMoYXR0cnMpIHsgcmV0dXJuIG5ldyBTdHJvcGhlLkJ1aWxkZXIoInByZXNlbmNlIiwgYXR0cnMpOyB9CgovKiogQ2xhc3M6IFN0cm9waGUKICogIEFuIG9iamVjdCBjb250YWluZXIgZm9yIGFsbCBTdHJvcGhlIGxpYnJhcnkgZnVuY3Rpb25zLgogKgogKiAgVGhpcyBjbGFzcyBpcyBqdXN0IGEgY29udGFpbmVyIGZvciBhbGwgdGhlIG9iamVjdHMgYW5kIGNvbnN0YW50cwogKiAgdXNlZCBpbiB0aGUgbGlicmFyeS4gIEl0IGlzIG5vdCBtZWFudCB0byBiZSBpbnN0YW50aWF0ZWQsIGJ1dCB0bwogKiAgcHJvdmlkZSBhIG5hbWVzcGFjZSBmb3IgbGlicmFyeSBvYmplY3RzLCBjb25zdGFudHMsIGFuZCBmdW5jdGlvbnMuCiAqLwpTdHJvcGhlID0gewogICAgLyoqIENvbnN0YW50OiBWRVJTSU9OCiAgICAgKiAgVGhlIHZlcnNpb24gb2YgdGhlIFN0cm9waGUgbGlicmFyeS4gVW5yZWxlYXNlZCBidWlsZHMgd2lsbCBoYXZlCiAgICAgKiAgYSB2ZXJzaW9uIG9mIGhlYWQtSEFTSCB3aGVyZSBIQVNIIGlzIGEgcGFydGlhbCByZXZpc2lvbi4KICAgICAqLwogICAgVkVSU0lPTjogIjEuMS4zIiwKCiAgICAvKiogQ29uc3RhbnRzOiBYTVBQIE5hbWVzcGFjZSBDb25zdGFudHMKICAgICAqICBDb21tb24gbmFtZXNwYWNlIGNvbnN0YW50cyBmcm9tIHRoZSBYTVBQIFJGQ3MgYW5kIFhFUHMuCiAgICAgKgogICAgICogIE5TLkhUVFBCSU5EIC0gSFRUUCBCSU5EIG5hbWVzcGFjZSBmcm9tIFhFUCAxMjQuCiAgICAgKiAgTlMuQk9TSCAtIEJPU0ggbmFtZXNwYWNlIGZyb20gWEVQIDIwNi4KICAgICAqICBOUy5DTElFTlQgLSBNYWluIFhNUFAgY2xpZW50IG5hbWVzcGFjZS4KICAgICAqICBOUy5BVVRIIC0gTGVnYWN5IGF1dGhlbnRpY2F0aW9uIG5hbWVzcGFjZS4KICAgICAqICBOUy5ST1NURVIgLSBSb3N0ZXIgb3BlcmF0aW9ucyBuYW1lc3BhY2UuCiAgICAgKiAgTlMuUFJPRklMRSAtIFByb2ZpbGUgbmFtZXNwYWNlLgogICAgICogIE5TLkRJU0NPX0lORk8gLSBTZXJ2aWNlIGRpc2NvdmVyeSBpbmZvIG5hbWVzcGFjZSBmcm9tIFhFUCAzMC4KICAgICAqICBOUy5ESVNDT19JVEVNUyAtIFNlcnZpY2UgZGlzY292ZXJ5IGl0ZW1zIG5hbWVzcGFjZSBmcm9tIFhFUCAzMC4KICAgICAqICBOUy5NVUMgLSBNdWx0aS1Vc2VyIENoYXQgbmFtZXNwYWNlIGZyb20gWEVQIDQ1LgogICAgICogIE5TLlNBU0wgLSBYTVBQIFNBU0wgbmFtZXNwYWNlIGZyb20gUkZDIDM5MjAuCiAgICAgKiAgTlMuU1RSRUFNIC0gWE1QUCBTdHJlYW1zIG5hbWVzcGFjZSBmcm9tIFJGQyAzOTIwLgogICAgICogIE5TLkJJTkQgLSBYTVBQIEJpbmRpbmcgbmFtZXNwYWNlIGZyb20gUkZDIDM5MjAuCiAgICAgKiAgTlMuU0VTU0lPTiAtIFhNUFAgU2Vzc2lvbiBuYW1lc3BhY2UgZnJvbSBSRkMgMzkyMC4KICAgICAqICBOUy5YSFRNTF9JTSAtIFhIVE1MLUlNIG5hbWVzcGFjZSBmcm9tIFhFUCA3MS4KICAgICAqICBOUy5YSFRNTCAtIFhIVE1MIGJvZHkgbmFtZXNwYWNlIGZyb20gWEVQIDcxLgogICAgICovCiAgICBOUzogewogICAgICAgIEhUVFBCSU5EOiAiaHR0cDovL2phYmJlci5vcmcvcHJvdG9jb2wvaHR0cGJpbmQiLAogICAgICAgIEJPU0g6ICJ1cm46eG1wcDp4Ym9zaCIsCiAgICAgICAgQ0xJRU5UOiAiamFiYmVyOmNsaWVudCIsCiAgICAgICAgQVVUSDogImphYmJlcjppcTphdXRoIiwKICAgICAgICBST1NURVI6ICJqYWJiZXI6aXE6cm9zdGVyIiwKICAgICAgICBQUk9GSUxFOiAiamFiYmVyOmlxOnByb2ZpbGUiLAogICAgICAgIERJU0NPX0lORk86ICJodHRwOi8vamFiYmVyLm9yZy9wcm90b2NvbC9kaXNjbyNpbmZvIiwKICAgICAgICBESVNDT19JVEVNUzogImh0dHA6Ly9qYWJiZXIub3JnL3Byb3RvY29sL2Rpc2NvI2l0ZW1zIiwKICAgICAgICBNVUM6ICJodHRwOi8vamFiYmVyLm9yZy9wcm90b2NvbC9tdWMiLAogICAgICAgIFNBU0w6ICJ1cm46aWV0ZjpwYXJhbXM6eG1sOm5zOnhtcHAtc2FzbCIsCiAgICAgICAgU1RSRUFNOiAiaHR0cDovL2V0aGVyeC5qYWJiZXIub3JnL3N0cmVhbXMiLAogICAgICAgIEJJTkQ6ICJ1cm46aWV0ZjpwYXJhbXM6eG1sOm5zOnhtcHAtYmluZCIsCiAgICAgICAgU0VTU0lPTjogInVybjppZXRmOnBhcmFtczp4bWw6bnM6eG1wcC1zZXNzaW9uIiwKICAgICAgICBWRVJTSU9OOiAiamFiYmVyOmlxOnZlcnNpb24iLAogICAgICAgIFNUQU5aQVM6ICJ1cm46aWV0ZjpwYXJhbXM6eG1sOm5zOnhtcHAtc3RhbnphcyIsCiAgICAgICAgWEhUTUxfSU06ICJodHRwOi8vamFiYmVyLm9yZy9wcm90b2NvbC94aHRtbC1pbSIsCiAgICAgICAgWEhUTUw6ICJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIgogICAgfSwKCgogICAgLyoqIENvbnN0YW50czogWEhUTUxfSU0gTmFtZXNwYWNlCiAgICAgKiAgY29udGFpbnMgYWxsb3dlZCB0YWdzLCB0YWcgYXR0cmlidXRlcywgYW5kIGNzcyBwcm9wZXJ0aWVzLgogICAgICogIFVzZWQgaW4gdGhlIGNyZWF0ZUh0bWwgZnVuY3Rpb24gdG8gZmlsdGVyIGluY29taW5nIGh0bWwgaW50byB0aGUgYWxsb3dlZCBYSFRNTC1JTSBzdWJzZXQuCiAgICAgKiAgU2VlIGh0dHA6Ly94bXBwLm9yZy9leHRlbnNpb25zL3hlcC0wMDcxLmh0bWwjcHJvZmlsZS1zdW1tYXJ5IGZvciB0aGUgbGlzdCBvZiByZWNvbW1lbmRlZAogICAgICogIGFsbG93ZWQgdGFncyBhbmQgdGhlaXIgYXR0cmlidXRlcy4KICAgICAqLwogICAgWEhUTUw6IHsKICAgICAgICAgICAgICAgIHRhZ3M6IFsnYScsJ2Jsb2NrcXVvdGUnLCdicicsJ2NpdGUnLCdlbScsJ2ltZycsJ2xpJywnb2wnLCdwJywnc3BhbicsJ3N0cm9uZycsJ3VsJywnYm9keSddLAogICAgICAgICAgICAgICAgYXR0cmlidXRlczogewogICAgICAgICAgICAgICAgICAgICAgICAnYSc6ICAgICAgICAgIFsnaHJlZiddLAogICAgICAgICAgICAgICAgICAgICAgICAnYmxvY2txdW90ZSc6IFsnc3R5bGUnXSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2JyJzogICAgICAgICBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2NpdGUnOiAgICAgICBbJ3N0eWxlJ10sCiAgICAgICAgICAgICAgICAgICAgICAgICdlbSc6ICAgICAgICAgW10sCiAgICAgICAgICAgICAgICAgICAgICAgICdpbWcnOiAgICAgICAgWydzcmMnLCAnYWx0JywgJ3N0eWxlJywgJ2hlaWdodCcsICd3aWR0aCddLAogICAgICAgICAgICAgICAgICAgICAgICAnbGknOiAgICAgICAgIFsnc3R5bGUnXSwKICAgICAgICAgICAgICAgICAgICAgICAgJ29sJzogICAgICAgICBbJ3N0eWxlJ10sCiAgICAgICAgICAgICAgICAgICAgICAgICdwJzogICAgICAgICAgWydzdHlsZSddLAogICAgICAgICAgICAgICAgICAgICAgICAnc3Bhbic6ICAgICAgIFsnc3R5bGUnXSwKICAgICAgICAgICAgICAgICAgICAgICAgJ3N0cm9uZyc6ICAgICBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgJ3VsJzogICAgICAgICBbJ3N0eWxlJ10sCiAgICAgICAgICAgICAgICAgICAgICAgICdib2R5JzogICAgICAgW10KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBjc3M6IFsnYmFja2dyb3VuZC1jb2xvcicsJ2NvbG9yJywnZm9udC1mYW1pbHknLCdmb250LXNpemUnLCdmb250LXN0eWxlJywnZm9udC13ZWlnaHQnLCdtYXJnaW4tbGVmdCcsJ21hcmdpbi1yaWdodCcsJ3RleHQtYWxpZ24nLCd0ZXh0LWRlY29yYXRpb24nXSwKICAgICAgICAgICAgICAgIHZhbGlkVGFnOiBmdW5jdGlvbih0YWcpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBTdHJvcGhlLlhIVE1MLnRhZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih0YWcgPT0gU3Ryb3BoZS5YSFRNTC50YWdzW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHZhbGlkQXR0cmlidXRlOiBmdW5jdGlvbih0YWcsIGF0dHJpYnV0ZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mIFN0cm9waGUuWEhUTUwuYXR0cmlidXRlc1t0YWddICE9PSAndW5kZWZpbmVkJyAmJiBTdHJvcGhlLlhIVE1MLmF0dHJpYnV0ZXNbdGFnXS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IFN0cm9waGUuWEhUTUwuYXR0cmlidXRlc1t0YWddLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihhdHRyaWJ1dGUgPT0gU3Ryb3BoZS5YSFRNTC5hdHRyaWJ1dGVzW3RhZ11baV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB2YWxpZENTUzogZnVuY3Rpb24oc3R5bGUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBTdHJvcGhlLlhIVE1MLmNzcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHN0eWxlID09IFN0cm9waGUuWEhUTUwuY3NzW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgfSwKCiAgICAvKiogQ29uc3RhbnRzOiBDb25uZWN0aW9uIFN0YXR1cyBDb25zdGFudHMKICAgICAqICBDb25uZWN0aW9uIHN0YXR1cyBjb25zdGFudHMgZm9yIHVzZSBieSB0aGUgY29ubmVjdGlvbiBoYW5kbGVyCiAgICAgKiAgY2FsbGJhY2suCiAgICAgKgogICAgICogIFN0YXR1cy5FUlJPUiAtIEFuIGVycm9yIGhhcyBvY2N1cnJlZAogICAgICogIFN0YXR1cy5DT05ORUNUSU5HIC0gVGhlIGNvbm5lY3Rpb24gaXMgY3VycmVudGx5IGJlaW5nIG1hZGUKICAgICAqICBTdGF0dXMuQ09OTkZBSUwgLSBUaGUgY29ubmVjdGlvbiBhdHRlbXB0IGZhaWxlZAogICAgICogIFN0YXR1cy5BVVRIRU5USUNBVElORyAtIFRoZSBjb25uZWN0aW9uIGlzIGF1dGhlbnRpY2F0aW5nCiAgICAgKiAgU3RhdHVzLkFVVEhGQUlMIC0gVGhlIGF1dGhlbnRpY2F0aW9uIGF0dGVtcHQgZmFpbGVkCiAgICAgKiAgU3RhdHVzLkNPTk5FQ1RFRCAtIFRoZSBjb25uZWN0aW9uIGhhcyBzdWNjZWVkZWQKICAgICAqICBTdGF0dXMuRElTQ09OTkVDVEVEIC0gVGhlIGNvbm5lY3Rpb24gaGFzIGJlZW4gdGVybWluYXRlZAogICAgICogIFN0YXR1cy5ESVNDT05ORUNUSU5HIC0gVGhlIGNvbm5lY3Rpb24gaXMgY3VycmVudGx5IGJlaW5nIHRlcm1pbmF0ZWQKICAgICAqICBTdGF0dXMuQVRUQUNIRUQgLSBUaGUgY29ubmVjdGlvbiBoYXMgYmVlbiBhdHRhY2hlZAogICAgICovCiAgICBTdGF0dXM6IHsKICAgICAgICBFUlJPUjogMCwKICAgICAgICBDT05ORUNUSU5HOiAxLAogICAgICAgIENPTk5GQUlMOiAyLAogICAgICAgIEFVVEhFTlRJQ0FUSU5HOiAzLAogICAgICAgIEFVVEhGQUlMOiA0LAogICAgICAgIENPTk5FQ1RFRDogNSwKICAgICAgICBESVNDT05ORUNURUQ6IDYsCiAgICAgICAgRElTQ09OTkVDVElORzogNywKICAgICAgICBBVFRBQ0hFRDogOAogICAgfSwKCiAgICAvKiogQ29uc3RhbnRzOiBMb2cgTGV2ZWwgQ29uc3RhbnRzCiAgICAgKiAgTG9nZ2luZyBsZXZlbCBpbmRpY2F0b3JzLgogICAgICoKICAgICAqICBMb2dMZXZlbC5ERUJVRyAtIERlYnVnIG91dHB1dAogICAgICogIExvZ0xldmVsLklORk8gLSBJbmZvcm1hdGlvbmFsIG91dHB1dAogICAgICogIExvZ0xldmVsLldBUk4gLSBXYXJuaW5ncwogICAgICogIExvZ0xldmVsLkVSUk9SIC0gRXJyb3JzCiAgICAgKiAgTG9nTGV2ZWwuRkFUQUwgLSBGYXRhbCBlcnJvcnMKICAgICAqLwogICAgTG9nTGV2ZWw6IHsKICAgICAgICBERUJVRzogMCwKICAgICAgICBJTkZPOiAxLAogICAgICAgIFdBUk46IDIsCiAgICAgICAgRVJST1I6IDMsCiAgICAgICAgRkFUQUw6IDQKICAgIH0sCgogICAgLyoqIFByaXZhdGVDb25zdGFudHM6IERPTSBFbGVtZW50IFR5cGUgQ29uc3RhbnRzCiAgICAgKiAgRE9NIGVsZW1lbnQgdHlwZXMuCiAgICAgKgogICAgICogIEVsZW1lbnRUeXBlLk5PUk1BTCAtIE5vcm1hbCBlbGVtZW50LgogICAgICogIEVsZW1lbnRUeXBlLlRFWFQgLSBUZXh0IGRhdGEgZWxlbWVudC4KICAgICAqICBFbGVtZW50VHlwZS5GUkFHTUVOVCAtIFhIVE1MIGZyYWdtZW50IGVsZW1lbnQuCiAgICAgKi8KICAgIEVsZW1lbnRUeXBlOiB7CiAgICAgICAgTk9STUFMOiAxLAogICAgICAgIFRFWFQ6IDMsCiAgICAgICAgQ0RBVEE6IDQsCiAgICAgICAgRlJBR01FTlQ6IDExCiAgICB9LAoKICAgIC8qKiBQcml2YXRlQ29uc3RhbnRzOiBUaW1lb3V0IFZhbHVlcwogICAgICogIFRpbWVvdXQgdmFsdWVzIGZvciBlcnJvciBzdGF0ZXMuICBUaGVzZSB2YWx1ZXMgYXJlIGluIHNlY29uZHMuCiAgICAgKiAgVGhlc2Ugc2hvdWxkIG5vdCBiZSBjaGFuZ2VkIHVubGVzcyB5b3Uga25vdyBleGFjdGx5IHdoYXQgeW91IGFyZQogICAgICogIGRvaW5nLgogICAgICoKICAgICAqICBUSU1FT1VUIC0gVGltZW91dCBtdWx0aXBsaWVyLiBBIHdhaXRpbmcgcmVxdWVzdCB3aWxsIGJlIGNvbnNpZGVyZWQKICAgICAqICAgICAgZmFpbGVkIGFmdGVyIE1hdGguZmxvb3IoVElNRU9VVCAqIHdhaXQpIHNlY29uZHMgaGF2ZSBlbGFwc2VkLgogICAgICogICAgICBUaGlzIGRlZmF1bHRzIHRvIDEuMSwgYW5kIHdpdGggZGVmYXVsdCB3YWl0LCA2NiBzZWNvbmRzLgogICAgICogIFNFQ09OREFSWV9USU1FT1VUIC0gU2Vjb25kYXJ5IHRpbWVvdXQgbXVsdGlwbGllci4gSW4gY2FzZXMgd2hlcmUKICAgICAqICAgICAgU3Ryb3BoZSBjYW4gZGV0ZWN0IGVhcmx5IGZhaWx1cmUsIGl0IHdpbGwgY29uc2lkZXIgdGhlIHJlcXVlc3QKICAgICAqICAgICAgZmFpbGVkIGlmIGl0IGRvZXNuJ3QgcmV0dXJuIGFmdGVyCiAgICAgKiAgICAgIE1hdGguZmxvb3IoU0VDT05EQVJZX1RJTUVPVVQgKiB3YWl0KSBzZWNvbmRzIGhhdmUgZWxhcHNlZC4KICAgICAqICAgICAgVGhpcyBkZWZhdWx0cyB0byAwLjEsIGFuZCB3aXRoIGRlZmF1bHQgd2FpdCwgNiBzZWNvbmRzLgogICAgICovCiAgICBUSU1FT1VUOiAxLjEsCiAgICBTRUNPTkRBUllfVElNRU9VVDogMC4xLAoKICAgIC8qKiBGdW5jdGlvbjogYWRkTmFtZXNwYWNlCiAgICAgKiAgVGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGV4dGVuZCB0aGUgY3VycmVudCBuYW1lc3BhY2VzIGluCiAgICAgKiAgU3Ryb3BoZS5OUy4gIEl0IHRha2VzIGEga2V5IGFuZCBhIHZhbHVlIHdpdGggdGhlIGtleSBiZWluZyB0aGUKICAgICAqICBuYW1lIG9mIHRoZSBuZXcgbmFtZXNwYWNlLCB3aXRoIGl0cyBhY3R1YWwgdmFsdWUuCiAgICAgKiAgRm9yIGV4YW1wbGU6CiAgICAgKiAgU3Ryb3BoZS5hZGROYW1lc3BhY2UoJ1BVQlNVQicsICJodHRwOi8vamFiYmVyLm9yZy9wcm90b2NvbC9wdWJzdWIiKTsKICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJpbmcpIG5hbWUgLSBUaGUgbmFtZSB1bmRlciB3aGljaCB0aGUgbmFtZXNwYWNlIHdpbGwgYmUKICAgICAqICAgICAgcmVmZXJlbmNlZCB1bmRlciBTdHJvcGhlLk5TCiAgICAgKiAgICAoU3RyaW5nKSB2YWx1ZSAtIFRoZSBhY3R1YWwgbmFtZXNwYWNlLgogICAgICovCiAgICBhZGROYW1lc3BhY2U6IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkKICAgIHsKICAgICAgU3Ryb3BoZS5OU1tuYW1lXSA9IHZhbHVlOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IGZvckVhY2hDaGlsZAogICAgICogIE1hcCBhIGZ1bmN0aW9uIG92ZXIgc29tZSBvciBhbGwgY2hpbGQgZWxlbWVudHMgb2YgYSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqICBUaGlzIGlzIGEgc21hbGwgY29udmVuaWVuY2UgZnVuY3Rpb24gZm9yIG1hcHBpbmcgYSBmdW5jdGlvbiBvdmVyCiAgICAgKiAgc29tZSBvciBhbGwgb2YgdGhlIGNoaWxkcmVuIG9mIGFuIGVsZW1lbnQuICBJZiBlbGVtTmFtZSBpcyBudWxsLCBhbGwKICAgICAqICBjaGlsZHJlbiB3aWxsIGJlIHBhc3NlZCB0byB0aGUgZnVuY3Rpb24sIG90aGVyd2lzZSBvbmx5IGNoaWxkcmVuCiAgICAgKiAgd2hvc2UgdGFnIG5hbWVzIG1hdGNoIGVsZW1OYW1lIHdpbGwgYmUgcGFzc2VkLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFhNTEVsZW1lbnQpIGVsZW0gLSBUaGUgZWxlbWVudCB0byBvcGVyYXRlIG9uLgogICAgICogICAgKFN0cmluZykgZWxlbU5hbWUgLSBUaGUgY2hpbGQgZWxlbWVudCB0YWcgbmFtZSBmaWx0ZXIuCiAgICAgKiAgICAoRnVuY3Rpb24pIGZ1bmMgLSBUaGUgZnVuY3Rpb24gdG8gYXBwbHkgdG8gZWFjaCBjaGlsZC4gIFRoaXMKICAgICAqICAgICAgZnVuY3Rpb24gc2hvdWxkIHRha2UgYSBzaW5nbGUgYXJndW1lbnQsIGEgRE9NIGVsZW1lbnQuCiAgICAgKi8KICAgIGZvckVhY2hDaGlsZDogZnVuY3Rpb24gKGVsZW0sIGVsZW1OYW1lLCBmdW5jKQogICAgewogICAgICAgIHZhciBpLCBjaGlsZE5vZGU7CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCBlbGVtLmNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY2hpbGROb2RlID0gZWxlbS5jaGlsZE5vZGVzW2ldOwogICAgICAgICAgICBpZiAoY2hpbGROb2RlLm5vZGVUeXBlID09IFN0cm9waGUuRWxlbWVudFR5cGUuTk9STUFMICYmCiAgICAgICAgICAgICAgICAoIWVsZW1OYW1lIHx8IHRoaXMuaXNUYWdFcXVhbChjaGlsZE5vZGUsIGVsZW1OYW1lKSkpIHsKICAgICAgICAgICAgICAgIGZ1bmMoY2hpbGROb2RlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiBpc1RhZ0VxdWFsCiAgICAgKiAgQ29tcGFyZSBhbiBlbGVtZW50J3MgdGFnIG5hbWUgd2l0aCBhIHN0cmluZy4KICAgICAqCiAgICAgKiAgVGhpcyBmdW5jdGlvbiBpcyBjYXNlIGluc2Vuc2l0aXZlLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFhNTEVsZW1lbnQpIGVsIC0gQSBET00gZWxlbWVudC4KICAgICAqICAgIChTdHJpbmcpIG5hbWUgLSBUaGUgZWxlbWVudCBuYW1lLgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgdHJ1ZSBpZiB0aGUgZWxlbWVudCdzIHRhZyBuYW1lIG1hdGNoZXMgX2VsXywgYW5kIGZhbHNlCiAgICAgKiAgICBvdGhlcndpc2UuCiAgICAgKi8KICAgIGlzVGFnRXF1YWw6IGZ1bmN0aW9uIChlbCwgbmFtZSkKICAgIHsKICAgICAgICByZXR1cm4gZWwudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVWYXJpYWJsZTogX3htbEdlbmVyYXRvcgogICAgICogIF9Qcml2YXRlXyB2YXJpYWJsZSB0aGF0IGNhY2hlcyBhIERPTSBkb2N1bWVudCB0bwogICAgICogIGdlbmVyYXRlIGVsZW1lbnRzLgogICAgICovCiAgICBfeG1sR2VuZXJhdG9yOiBudWxsLAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9tYWtlR2VuZXJhdG9yCiAgICAgKiAgX1ByaXZhdGVfIGZ1bmN0aW9uIHRoYXQgY3JlYXRlcyBhIGR1bW15IFhNTCBET00gZG9jdW1lbnQgdG8gc2VydmUgYXMKICAgICAqICBhbiBlbGVtZW50IGFuZCB0ZXh0IG5vZGUgZ2VuZXJhdG9yLgogICAgICovCiAgICBfbWFrZUdlbmVyYXRvcjogZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBkb2M7CgogICAgICAgIC8vIElFOSBkb2VzIGltcGxlbWVudCBjcmVhdGVEb2N1bWVudCgpOyBob3dldmVyLCB1c2luZyBpdCB3aWxsIGNhdXNlIHRoZSBicm93c2VyIHRvIGxlYWsgbWVtb3J5IG9uIHBhZ2UgdW5sb2FkLgogICAgICAgIC8vIEhlcmUsIHdlIHRlc3QgZm9yIHByZXNlbmNlIG9mIGNyZWF0ZURvY3VtZW50KCkgcGx1cyBJRSdzIHByb3ByaWV0YXJ5IGRvY3VtZW50TW9kZSBhdHRyaWJ1dGUsIHdoaWNoIHdvdWxkIGJlCiAgICAgICAgICAgICAgICAvLyBsZXNzIHRoYW4gMTAgaW4gdGhlIGNhc2Ugb2YgSUU5IGFuZCBiZWxvdy4KICAgICAgICBpZiAoZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uY3JlYXRlRG9jdW1lbnQgPT09IHVuZGVmaW5lZCB8fAogICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVEb2N1bWVudCAmJiBkb2N1bWVudC5kb2N1bWVudE1vZGUgJiYgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIDwgMTApIHsKICAgICAgICAgICAgZG9jID0gdGhpcy5fZ2V0SUVYbWxEb20oKTsKICAgICAgICAgICAgZG9jLmFwcGVuZENoaWxkKGRvYy5jcmVhdGVFbGVtZW50KCdzdHJvcGhlJykpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRvYyA9IGRvY3VtZW50LmltcGxlbWVudGF0aW9uCiAgICAgICAgICAgICAgICAuY3JlYXRlRG9jdW1lbnQoJ2phYmJlcjpjbGllbnQnLCAnc3Ryb3BoZScsIG51bGwpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRvYzsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiB4bWxHZW5lcmF0b3IKICAgICAqICBHZXQgdGhlIERPTSBkb2N1bWVudCB0byBnZW5lcmF0ZSBlbGVtZW50cy4KICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgIFRoZSBjdXJyZW50bHkgdXNlZCBET00gZG9jdW1lbnQuCiAgICAgKi8KICAgIHhtbEdlbmVyYXRvcjogZnVuY3Rpb24gKCkgewogICAgICAgIGlmICghU3Ryb3BoZS5feG1sR2VuZXJhdG9yKSB7CiAgICAgICAgICAgIFN0cm9waGUuX3htbEdlbmVyYXRvciA9IFN0cm9waGUuX21ha2VHZW5lcmF0b3IoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFN0cm9waGUuX3htbEdlbmVyYXRvcjsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX2dldElFWG1sRG9tCiAgICAgKiAgR2V0cyBJRSB4bWwgZG9jIG9iamVjdAogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgQSBNaWNyb3NvZnQgWE1MIERPTSBPYmplY3QKICAgICAqICBTZWUgQWxzbzoKICAgICAqICAgIGh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9tczc1NzgzNyUyOFZTLjg1JTI5LmFzcHgKICAgICAqLwogICAgX2dldElFWG1sRG9tIDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGRvYyA9IG51bGw7CiAgICAgICAgdmFyIGRvY1N0cmluZ3MgPSBbCiAgICAgICAgICAgICJNc3htbDIuRE9NRG9jdW1lbnQuNi4wIiwKICAgICAgICAgICAgIk1zeG1sMi5ET01Eb2N1bWVudC41LjAiLAogICAgICAgICAgICAiTXN4bWwyLkRPTURvY3VtZW50LjQuMCIsCiAgICAgICAgICAgICJNU1hNTDIuRE9NRG9jdW1lbnQuMy4wIiwKICAgICAgICAgICAgIk1TWE1MMi5ET01Eb2N1bWVudCIsCiAgICAgICAgICAgICJNU1hNTC5ET01Eb2N1bWVudCIsCiAgICAgICAgICAgICJNaWNyb3NvZnQuWE1MRE9NIgogICAgICAgIF07CgogICAgICAgIGZvciAodmFyIGQgPSAwOyBkIDwgZG9jU3RyaW5ncy5sZW5ndGg7IGQrKykgewogICAgICAgICAgICBpZiAoZG9jID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGRvYyA9IG5ldyBBY3RpdmVYT2JqZWN0KGRvY1N0cmluZ3NbZF0pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIGRvYyA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRvYzsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiB4bWxFbGVtZW50CiAgICAgKiAgQ3JlYXRlIGFuIFhNTCBET00gZWxlbWVudC4KICAgICAqCiAgICAgKiAgVGhpcyBmdW5jdGlvbiBjcmVhdGVzIGFuIFhNTCBET00gZWxlbWVudCBjb3JyZWN0bHkgYWNyb3NzIGFsbAogICAgICogIGltcGxlbWVudGF0aW9ucy4gTm90ZSB0aGF0IHRoZXNlIGFyZSBub3QgSFRNTCBET00gZWxlbWVudHMsIHdoaWNoCiAgICAgKiAgYXJlbid0IGFwcHJvcHJpYXRlIGZvciBYTVBQIHN0YW56YXMuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoU3RyaW5nKSBuYW1lIC0gVGhlIG5hbWUgZm9yIHRoZSBlbGVtZW50LgogICAgICogICAgKEFycmF5fE9iamVjdCkgYXR0cnMgLSBBbiBvcHRpb25hbCBhcnJheSBvciBvYmplY3QgY29udGFpbmluZwogICAgICogICAgICBrZXkvdmFsdWUgcGFpcnMgdG8gdXNlIGFzIGVsZW1lbnQgYXR0cmlidXRlcy4gVGhlIG9iamVjdCBzaG91bGQKICAgICAqICAgICAgYmUgaW4gdGhlIGZvcm1hdCB7J2tleSc6ICd2YWx1ZSd9IG9yIHtrZXk6ICd2YWx1ZSd9LiBUaGUgYXJyYXkKICAgICAqICAgICAgc2hvdWxkIGhhdmUgdGhlIGZvcm1hdCBbWydrZXkxJywgJ3ZhbHVlMSddLCBbJ2tleTInLCAndmFsdWUyJ11dLgogICAgICogICAgKFN0cmluZykgdGV4dCAtIFRoZSB0ZXh0IGNoaWxkIGRhdGEgZm9yIHRoZSBlbGVtZW50LgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgQSBuZXcgWE1MIERPTSBlbGVtZW50LgogICAgICovCiAgICB4bWxFbGVtZW50OiBmdW5jdGlvbiAobmFtZSkKICAgIHsKICAgICAgICBpZiAoIW5hbWUpIHsgcmV0dXJuIG51bGw7IH0KCiAgICAgICAgdmFyIG5vZGUgPSBTdHJvcGhlLnhtbEdlbmVyYXRvcigpLmNyZWF0ZUVsZW1lbnQobmFtZSk7CgogICAgICAgIC8vIEZJWE1FOiB0aGlzIHNob3VsZCB0aHJvdyBlcnJvcnMgaWYgYXJncyBhcmUgdGhlIHdyb25nIHR5cGUgb3IKICAgICAgICAvLyB0aGVyZSBhcmUgbW9yZSB0aGFuIHR3byBvcHRpb25hbCBhcmdzCiAgICAgICAgdmFyIGEsIGksIGs7CiAgICAgICAgZm9yIChhID0gMTsgYSA8IGFyZ3VtZW50cy5sZW5ndGg7IGErKykgewogICAgICAgICAgICBpZiAoIWFyZ3VtZW50c1thXSkgeyBjb250aW51ZTsgfQogICAgICAgICAgICBpZiAodHlwZW9mKGFyZ3VtZW50c1thXSkgPT0gInN0cmluZyIgfHwKICAgICAgICAgICAgICAgIHR5cGVvZihhcmd1bWVudHNbYV0pID09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICBub2RlLmFwcGVuZENoaWxkKFN0cm9waGUueG1sVGV4dE5vZGUoYXJndW1lbnRzW2FdKSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mKGFyZ3VtZW50c1thXSkgPT0gIm9iamVjdCIgJiYKICAgICAgICAgICAgICAgICAgICAgICB0eXBlb2YoYXJndW1lbnRzW2FdLnNvcnQpID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBhcmd1bWVudHNbYV0ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mKGFyZ3VtZW50c1thXVtpXSkgPT0gIm9iamVjdCIgJiYKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZW9mKGFyZ3VtZW50c1thXVtpXS5zb3J0KSA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlKGFyZ3VtZW50c1thXVtpXVswXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJndW1lbnRzW2FdW2ldWzFdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mKGFyZ3VtZW50c1thXSkgPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgIGZvciAoayBpbiBhcmd1bWVudHNbYV0pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYXJndW1lbnRzW2FdLmhhc093blByb3BlcnR5KGspKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlKGssIGFyZ3VtZW50c1thXVtrXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbm9kZTsKICAgIH0sCgogICAgLyogIEZ1bmN0aW9uOiB4bWxlc2NhcGUKICAgICAqICBFeGNhcGVzIGludmFsaWQgeG1sIGNoYXJhY3RlcnMuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAgKFN0cmluZykgdGV4dCAtIHRleHQgdG8gZXNjYXBlLgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgICBFc2NhcGVkIHRleHQuCiAgICAgKi8KICAgIHhtbGVzY2FwZTogZnVuY3Rpb24odGV4dCkKICAgIHsKICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC9cJi9nLCAiJmFtcDsiKTsKICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC88L2csICAiJmx0OyIpOwogICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoLz4vZywgICImZ3Q7Iik7CiAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvJy9nLCAgIiZhcG9zOyIpOwogICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoLyIvZywgICImcXVvdDsiKTsKICAgICAgICByZXR1cm4gdGV4dDsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiB4bWxUZXh0Tm9kZQogICAgICogIENyZWF0ZXMgYW4gWE1MIERPTSB0ZXh0IG5vZGUuCiAgICAgKgogICAgICogIFByb3ZpZGVzIGEgY3Jvc3MgaW1wbGVtZW50YXRpb24gdmVyc2lvbiBvZiBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZS4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJpbmcpIHRleHQgLSBUaGUgY29udGVudCBvZiB0aGUgdGV4dCBub2RlLgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgQSBuZXcgWE1MIERPTSB0ZXh0IG5vZGUuCiAgICAgKi8KICAgIHhtbFRleHROb2RlOiBmdW5jdGlvbiAodGV4dCkKICAgIHsKICAgICAgICByZXR1cm4gU3Ryb3BoZS54bWxHZW5lcmF0b3IoKS5jcmVhdGVUZXh0Tm9kZSh0ZXh0KTsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiB4bWxIdG1sTm9kZQogICAgICogIENyZWF0ZXMgYW4gWE1MIERPTSBodG1sIG5vZGUuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoU3RyaW5nKSBodG1sIC0gVGhlIGNvbnRlbnQgb2YgdGhlIGh0bWwgbm9kZS4KICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgIEEgbmV3IFhNTCBET00gdGV4dCBub2RlLgogICAgICovCiAgICB4bWxIdG1sTm9kZTogZnVuY3Rpb24gKGh0bWwpCiAgICB7CiAgICAgICAgdmFyIG5vZGU7CiAgICAgICAgLy9lbnN1cmUgdGV4dCBpcyBlc2NhcGVkCiAgICAgICAgaWYgKHdpbmRvdy5ET01QYXJzZXIpIHsKICAgICAgICAgICAgdmFyIHBhcnNlciA9IG5ldyBET01QYXJzZXIoKTsKICAgICAgICAgICAgbm9kZSA9IHBhcnNlci5wYXJzZUZyb21TdHJpbmcoaHRtbCwgInRleHQveG1sIik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbm9kZSA9IG5ldyBBY3RpdmVYT2JqZWN0KCJNaWNyb3NvZnQuWE1MRE9NIik7CiAgICAgICAgICAgIG5vZGUuYXN5bmM9ImZhbHNlIjsKICAgICAgICAgICAgbm9kZS5sb2FkWE1MKGh0bWwpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbm9kZTsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiBnZXRUZXh0CiAgICAgKiAgR2V0IHRoZSBjb25jYXRlbmF0aW9uIG9mIGFsbCB0ZXh0IGNoaWxkcmVuIG9mIGFuIGVsZW1lbnQuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoWE1MRWxlbWVudCkgZWxlbSAtIEEgRE9NIGVsZW1lbnQuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBBIFN0cmluZyB3aXRoIHRoZSBjb25jYXRlbmF0ZWQgdGV4dCBvZiBhbGwgdGV4dCBlbGVtZW50IGNoaWxkcmVuLgogICAgICovCiAgICBnZXRUZXh0OiBmdW5jdGlvbiAoZWxlbSkKICAgIHsKICAgICAgICBpZiAoIWVsZW0pIHsgcmV0dXJuIG51bGw7IH0KCiAgICAgICAgdmFyIHN0ciA9ICIiOwogICAgICAgIGlmIChlbGVtLmNoaWxkTm9kZXMubGVuZ3RoID09PSAwICYmIGVsZW0ubm9kZVR5cGUgPT0KICAgICAgICAgICAgU3Ryb3BoZS5FbGVtZW50VHlwZS5URVhUKSB7CiAgICAgICAgICAgIHN0ciArPSBlbGVtLm5vZGVWYWx1ZTsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWxlbS5jaGlsZE5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChlbGVtLmNoaWxkTm9kZXNbaV0ubm9kZVR5cGUgPT0gU3Ryb3BoZS5FbGVtZW50VHlwZS5URVhUKSB7CiAgICAgICAgICAgICAgICBzdHIgKz0gZWxlbS5jaGlsZE5vZGVzW2ldLm5vZGVWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIFN0cm9waGUueG1sZXNjYXBlKHN0cik7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogY29weUVsZW1lbnQKICAgICAqICBDb3B5IGFuIFhNTCBET00gZWxlbWVudC4KICAgICAqCiAgICAgKiAgVGhpcyBmdW5jdGlvbiBjb3BpZXMgYSBET00gZWxlbWVudCBhbmQgYWxsIGl0cyBkZXNjZW5kYW50cyBhbmQgcmV0dXJucwogICAgICogIHRoZSBuZXcgY29weS4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChYTUxFbGVtZW50KSBlbGVtIC0gQSBET00gZWxlbWVudC4KICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgIEEgbmV3LCBjb3BpZWQgRE9NIGVsZW1lbnQgdHJlZS4KICAgICAqLwogICAgY29weUVsZW1lbnQ6IGZ1bmN0aW9uIChlbGVtKQogICAgewogICAgICAgIHZhciBpLCBlbDsKICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PSBTdHJvcGhlLkVsZW1lbnRUeXBlLk5PUk1BTCkgewogICAgICAgICAgICBlbCA9IFN0cm9waGUueG1sRWxlbWVudChlbGVtLnRhZ05hbWUpOwoKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGVsZW0uYXR0cmlidXRlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKGVsZW0uYXR0cmlidXRlc1tpXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0uYXR0cmlidXRlc1tpXS52YWx1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBlbGVtLmNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGVsLmFwcGVuZENoaWxkKFN0cm9waGUuY29weUVsZW1lbnQoZWxlbS5jaGlsZE5vZGVzW2ldKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGVsZW0ubm9kZVR5cGUgPT0gU3Ryb3BoZS5FbGVtZW50VHlwZS5URVhUKSB7CiAgICAgICAgICAgIGVsID0gU3Ryb3BoZS54bWxHZW5lcmF0b3IoKS5jcmVhdGVUZXh0Tm9kZShlbGVtLm5vZGVWYWx1ZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZWw7CiAgICB9LAoKCiAgICAvKiogRnVuY3Rpb246IGNyZWF0ZUh0bWwKICAgICAqICBDb3B5IGFuIEhUTUwgRE9NIGVsZW1lbnQgaW50byBhbiBYTUwgRE9NLgogICAgICoKICAgICAqICBUaGlzIGZ1bmN0aW9uIGNvcGllcyBhIERPTSBlbGVtZW50IGFuZCBhbGwgaXRzIGRlc2NlbmRhbnRzIGFuZCByZXR1cm5zCiAgICAgKiAgdGhlIG5ldyBjb3B5LgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKEhUTUxFbGVtZW50KSBlbGVtIC0gQSBET00gZWxlbWVudC4KICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgIEEgbmV3LCBjb3BpZWQgRE9NIGVsZW1lbnQgdHJlZS4KICAgICAqLwogICAgY3JlYXRlSHRtbDogZnVuY3Rpb24gKGVsZW0pCiAgICB7CiAgICAgICAgdmFyIGksIGVsLCBqLCB0YWcsIGF0dHJpYnV0ZSwgdmFsdWUsIGNzcywgY3NzQXR0cnMsIGF0dHIsIGNzc05hbWUsIGNzc1ZhbHVlOwogICAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09IFN0cm9waGUuRWxlbWVudFR5cGUuTk9STUFMKSB7CiAgICAgICAgICAgIHRhZyA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgaWYoU3Ryb3BoZS5YSFRNTC52YWxpZFRhZyh0YWcpKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGVsID0gU3Ryb3BoZS54bWxFbGVtZW50KHRhZyk7CiAgICAgICAgICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgU3Ryb3BoZS5YSFRNTC5hdHRyaWJ1dGVzW3RhZ10ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlID0gU3Ryb3BoZS5YSFRNTC5hdHRyaWJ1dGVzW3RhZ11baV07CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gZWxlbS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mIHZhbHVlID09ICd1bmRlZmluZWQnIHx8IHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSAnJyB8fCB2YWx1ZSA9PT0gZmFsc2UgfHwgdmFsdWUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGF0dHJpYnV0ZSA9PSAnc3R5bGUnICYmIHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mIHZhbHVlLmNzc1RleHQgIT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLmNzc1RleHQ7IC8vIHdlJ3JlIGRlYWxpbmcgd2l0aCBJRSwgbmVlZCB0byBnZXQgQ1NTIG91dAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZpbHRlciBvdXQgaW52YWxpZCBjc3Mgc3R5bGVzCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGF0dHJpYnV0ZSA9PSAnc3R5bGUnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjc3MgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNzc0F0dHJzID0gdmFsdWUuc3BsaXQoJzsnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcihqID0gMDsgaiA8IGNzc0F0dHJzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ciA9IGNzc0F0dHJzW2pdLnNwbGl0KCc6Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3NzTmFtZSA9IGF0dHJbMF0ucmVwbGFjZSgvXlxzKi8sICIiKS5yZXBsYWNlKC9ccyokLywgIiIpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoU3Ryb3BoZS5YSFRNTC52YWxpZENTUyhjc3NOYW1lKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjc3NWYWx1ZSA9IGF0dHJbMV0ucmVwbGFjZSgvXlxzKi8sICIiKS5yZXBsYWNlKC9ccyokLywgIiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjc3MucHVzaChjc3NOYW1lICsgJzogJyArIGNzc1ZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihjc3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gY3NzLmpvaW4oJzsgJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKGF0dHJpYnV0ZSwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKGF0dHJpYnV0ZSwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZWxlbS5jaGlsZE5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsLmFwcGVuZENoaWxkKFN0cm9waGUuY3JlYXRlSHRtbChlbGVtLmNoaWxkTm9kZXNbaV0pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsgLy8gaW52YWxpZCBlbGVtZW50cwogICAgICAgICAgICAgICAgICBlbCA9IFN0cm9waGUueG1sVGV4dE5vZGUoJycpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZWwgPSBTdHJvcGhlLnhtbEdlbmVyYXRvcigpLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBlbGVtLmNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBlbC5hcHBlbmRDaGlsZChTdHJvcGhlLmNyZWF0ZUh0bWwoZWxlbS5jaGlsZE5vZGVzW2ldKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGVsZW0ubm9kZVR5cGUgPT0gU3Ryb3BoZS5FbGVtZW50VHlwZS5GUkFHTUVOVCkgewogICAgICAgICAgICBlbCA9IFN0cm9waGUueG1sR2VuZXJhdG9yKCkuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZWxlbS5jaGlsZE5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBlbC5hcHBlbmRDaGlsZChTdHJvcGhlLmNyZWF0ZUh0bWwoZWxlbS5jaGlsZE5vZGVzW2ldKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGVsZW0ubm9kZVR5cGUgPT0gU3Ryb3BoZS5FbGVtZW50VHlwZS5URVhUKSB7CiAgICAgICAgICAgIGVsID0gU3Ryb3BoZS54bWxUZXh0Tm9kZShlbGVtLm5vZGVWYWx1ZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZWw7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogZXNjYXBlTm9kZQogICAgICogIEVzY2FwZSB0aGUgbm9kZSBwYXJ0IChhbHNvIGNhbGxlZCBsb2NhbCBwYXJ0KSBvZiBhIEpJRC4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJpbmcpIG5vZGUgLSBBIG5vZGUgKG9yIGxvY2FsIHBhcnQpLgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgQW4gZXNjYXBlZCBub2RlIChvciBsb2NhbCBwYXJ0KS4KICAgICAqLwogICAgZXNjYXBlTm9kZTogZnVuY3Rpb24gKG5vZGUpCiAgICB7CiAgICAgICAgcmV0dXJuIG5vZGUucmVwbGFjZSgvXlxzK3xccyskL2csICcnKQogICAgICAgICAgICAucmVwbGFjZSgvXFwvZywgICJcXDVjIikKICAgICAgICAgICAgLnJlcGxhY2UoLyAvZywgICAiXFwyMCIpCiAgICAgICAgICAgIC5yZXBsYWNlKC9cIi9nLCAgIlxcMjIiKQogICAgICAgICAgICAucmVwbGFjZSgvXCYvZywgICJcXDI2IikKICAgICAgICAgICAgLnJlcGxhY2UoL1wnL2csICAiXFwyNyIpCiAgICAgICAgICAgIC5yZXBsYWNlKC9cLy9nLCAgIlxcMmYiKQogICAgICAgICAgICAucmVwbGFjZSgvOi9nLCAgICJcXDNhIikKICAgICAgICAgICAgLnJlcGxhY2UoLzwvZywgICAiXFwzYyIpCiAgICAgICAgICAgIC5yZXBsYWNlKC8+L2csICAgIlxcM2UiKQogICAgICAgICAgICAucmVwbGFjZSgvQC9nLCAgICJcXDQwIik7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogdW5lc2NhcGVOb2RlCiAgICAgKiAgVW5lc2NhcGUgYSBub2RlIHBhcnQgKGFsc28gY2FsbGVkIGxvY2FsIHBhcnQpIG9mIGEgSklELgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cmluZykgbm9kZSAtIEEgbm9kZSAob3IgbG9jYWwgcGFydCkuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBBbiB1bmVzY2FwZWQgbm9kZSAob3IgbG9jYWwgcGFydCkuCiAgICAgKi8KICAgIHVuZXNjYXBlTm9kZTogZnVuY3Rpb24gKG5vZGUpCiAgICB7CiAgICAgICAgcmV0dXJuIG5vZGUucmVwbGFjZSgvXFwyMC9nLCAiICIpCiAgICAgICAgICAgIC5yZXBsYWNlKC9cXDIyL2csICciJykKICAgICAgICAgICAgLnJlcGxhY2UoL1xcMjYvZywgIiYiKQogICAgICAgICAgICAucmVwbGFjZSgvXFwyNy9nLCAiJyIpCiAgICAgICAgICAgIC5yZXBsYWNlKC9cXDJmL2csICIvIikKICAgICAgICAgICAgLnJlcGxhY2UoL1xcM2EvZywgIjoiKQogICAgICAgICAgICAucmVwbGFjZSgvXFwzYy9nLCAiPCIpCiAgICAgICAgICAgIC5yZXBsYWNlKC9cXDNlL2csICI+IikKICAgICAgICAgICAgLnJlcGxhY2UoL1xcNDAvZywgIkAiKQogICAgICAgICAgICAucmVwbGFjZSgvXFw1Yy9nLCAiXFwiKTsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiBnZXROb2RlRnJvbUppZAogICAgICogIEdldCB0aGUgbm9kZSBwb3J0aW9uIG9mIGEgSklEIFN0cmluZy4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJpbmcpIGppZCAtIEEgSklELgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgQSBTdHJpbmcgY29udGFpbmluZyB0aGUgbm9kZS4KICAgICAqLwogICAgZ2V0Tm9kZUZyb21KaWQ6IGZ1bmN0aW9uIChqaWQpCiAgICB7CiAgICAgICAgaWYgKGppZC5pbmRleE9mKCJAIikgPCAwKSB7IHJldHVybiBudWxsOyB9CiAgICAgICAgcmV0dXJuIGppZC5zcGxpdCgiQCIpWzBdOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IGdldERvbWFpbkZyb21KaWQKICAgICAqICBHZXQgdGhlIGRvbWFpbiBwb3J0aW9uIG9mIGEgSklEIFN0cmluZy4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJpbmcpIGppZCAtIEEgSklELgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgQSBTdHJpbmcgY29udGFpbmluZyB0aGUgZG9tYWluLgogICAgICovCiAgICBnZXREb21haW5Gcm9tSmlkOiBmdW5jdGlvbiAoamlkKQogICAgewogICAgICAgIHZhciBiYXJlID0gU3Ryb3BoZS5nZXRCYXJlSmlkRnJvbUppZChqaWQpOwogICAgICAgIGlmIChiYXJlLmluZGV4T2YoIkAiKSA8IDApIHsKICAgICAgICAgICAgcmV0dXJuIGJhcmU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHBhcnRzID0gYmFyZS5zcGxpdCgiQCIpOwogICAgICAgICAgICBwYXJ0cy5zcGxpY2UoMCwgMSk7CiAgICAgICAgICAgIHJldHVybiBwYXJ0cy5qb2luKCdAJyk7CiAgICAgICAgfQogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IGdldFJlc291cmNlRnJvbUppZAogICAgICogIEdldCB0aGUgcmVzb3VyY2UgcG9ydGlvbiBvZiBhIEpJRCBTdHJpbmcuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoU3RyaW5nKSBqaWQgLSBBIEpJRC4KICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgIEEgU3RyaW5nIGNvbnRhaW5pbmcgdGhlIHJlc291cmNlLgogICAgICovCiAgICBnZXRSZXNvdXJjZUZyb21KaWQ6IGZ1bmN0aW9uIChqaWQpCiAgICB7CiAgICAgICAgdmFyIHMgPSBqaWQuc3BsaXQoIi8iKTsKICAgICAgICBpZiAocy5sZW5ndGggPCAyKSB7IHJldHVybiBudWxsOyB9CiAgICAgICAgcy5zcGxpY2UoMCwgMSk7CiAgICAgICAgcmV0dXJuIHMuam9pbignLycpOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IGdldEJhcmVKaWRGcm9tSmlkCiAgICAgKiAgR2V0IHRoZSBiYXJlIEpJRCBmcm9tIGEgSklEIFN0cmluZy4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJpbmcpIGppZCAtIEEgSklELgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgQSBTdHJpbmcgY29udGFpbmluZyB0aGUgYmFyZSBKSUQuCiAgICAgKi8KICAgIGdldEJhcmVKaWRGcm9tSmlkOiBmdW5jdGlvbiAoamlkKQogICAgewogICAgICAgIHJldHVybiBqaWQgPyBqaWQuc3BsaXQoIi8iKVswXSA6IG51bGw7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogbG9nCiAgICAgKiAgVXNlciBvdmVycmlkZWFibGUgbG9nZ2luZyBmdW5jdGlvbi4KICAgICAqCiAgICAgKiAgVGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQgd2hlbmV2ZXIgdGhlIFN0cm9waGUgbGlicmFyeSBjYWxscyBhbnkKICAgICAqICBvZiB0aGUgbG9nZ2luZyBmdW5jdGlvbnMuICBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiB0aGlzCiAgICAgKiAgZnVuY3Rpb24gZG9lcyBub3RoaW5nLiAgSWYgY2xpZW50IGNvZGUgd2lzaGVzIHRvIGhhbmRsZSB0aGUgbG9nZ2luZwogICAgICogIG1lc3NhZ2VzLCBpdCBzaG91bGQgb3ZlcnJpZGUgdGhpcyB3aXRoCiAgICAgKiAgPiBTdHJvcGhlLmxvZyA9IGZ1bmN0aW9uIChsZXZlbCwgbXNnKSB7CiAgICAgKiAgPiAgICh1c2VyIGNvZGUgaGVyZSkKICAgICAqICA+IH07CiAgICAgKgogICAgICogIFBsZWFzZSBub3RlIHRoYXQgZGF0YSBzZW50IGFuZCByZWNlaXZlZCBvdmVyIHRoZSB3aXJlIGlzIGxvZ2dlZAogICAgICogIHZpYSBTdHJvcGhlLkNvbm5lY3Rpb24ucmF3SW5wdXQoKSBhbmQgU3Ryb3BoZS5Db25uZWN0aW9uLnJhd091dHB1dCgpLgogICAgICoKICAgICAqICBUaGUgZGlmZmVyZW50IGxldmVscyBhbmQgdGhlaXIgbWVhbmluZ3MgYXJlCiAgICAgKgogICAgICogICAgREVCVUcgLSBNZXNzYWdlcyB1c2VmdWwgZm9yIGRlYnVnZ2luZyBwdXJwb3Nlcy4KICAgICAqICAgIElORk8gLSBJbmZvcm1hdGlvbmFsIG1lc3NhZ2VzLiAgVGhpcyBpcyBtb3N0bHkgaW5mb3JtYXRpb24gbGlrZQogICAgICogICAgICAnZGlzY29ubmVjdCB3YXMgY2FsbGVkJyBvciAnU0FTTCBhdXRoIHN1Y2NlZWRlZCcuCiAgICAgKiAgICBXQVJOIC0gV2FybmluZ3MgYWJvdXQgcG90ZW50aWFsIHByb2JsZW1zLiAgVGhpcyBpcyBtb3N0bHkgdXNlZAogICAgICogICAgICB0byByZXBvcnQgdHJhbnNpZW50IGNvbm5lY3Rpb24gZXJyb3JzIGxpa2UgcmVxdWVzdCB0aW1lb3V0cy4KICAgICAqICAgIEVSUk9SIC0gU29tZSBlcnJvciBvY2N1cnJlZC4KICAgICAqICAgIEZBVEFMIC0gQSBub24tcmVjb3ZlcmFibGUgZmF0YWwgZXJyb3Igb2NjdXJyZWQuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoSW50ZWdlcikgbGV2ZWwgLSBUaGUgbG9nIGxldmVsIG9mIHRoZSBsb2cgbWVzc2FnZS4gIFRoaXMgd2lsbAogICAgICogICAgICBiZSBvbmUgb2YgdGhlIHZhbHVlcyBpbiBTdHJvcGhlLkxvZ0xldmVsLgogICAgICogICAgKFN0cmluZykgbXNnIC0gVGhlIGxvZyBtZXNzYWdlLgogICAgICovCiAgICAvKiBqc2hpbnQgaWdub3JlOnN0YXJ0ICovCiAgICBsb2c6IGZ1bmN0aW9uIChsZXZlbCwgbXNnKQogICAgewogICAgICAgIHJldHVybjsKICAgIH0sCiAgICAvKiBqc2hpbnQgaWdub3JlOmVuZCAqLwoKICAgIC8qKiBGdW5jdGlvbjogZGVidWcKICAgICAqICBMb2cgYSBtZXNzYWdlIGF0IHRoZSBTdHJvcGhlLkxvZ0xldmVsLkRFQlVHIGxldmVsLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cmluZykgbXNnIC0gVGhlIGxvZyBtZXNzYWdlLgogICAgICovCiAgICBkZWJ1ZzogZnVuY3Rpb24obXNnKQogICAgewogICAgICAgIHRoaXMubG9nKHRoaXMuTG9nTGV2ZWwuREVCVUcsIG1zZyk7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogaW5mbwogICAgICogIExvZyBhIG1lc3NhZ2UgYXQgdGhlIFN0cm9waGUuTG9nTGV2ZWwuSU5GTyBsZXZlbC4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJpbmcpIG1zZyAtIFRoZSBsb2cgbWVzc2FnZS4KICAgICAqLwogICAgaW5mbzogZnVuY3Rpb24gKG1zZykKICAgIHsKICAgICAgICB0aGlzLmxvZyh0aGlzLkxvZ0xldmVsLklORk8sIG1zZyk7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogd2FybgogICAgICogIExvZyBhIG1lc3NhZ2UgYXQgdGhlIFN0cm9waGUuTG9nTGV2ZWwuV0FSTiBsZXZlbC4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJpbmcpIG1zZyAtIFRoZSBsb2cgbWVzc2FnZS4KICAgICAqLwogICAgd2FybjogZnVuY3Rpb24gKG1zZykKICAgIHsKICAgICAgICB0aGlzLmxvZyh0aGlzLkxvZ0xldmVsLldBUk4sIG1zZyk7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogZXJyb3IKICAgICAqICBMb2cgYSBtZXNzYWdlIGF0IHRoZSBTdHJvcGhlLkxvZ0xldmVsLkVSUk9SIGxldmVsLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cmluZykgbXNnIC0gVGhlIGxvZyBtZXNzYWdlLgogICAgICovCiAgICBlcnJvcjogZnVuY3Rpb24gKG1zZykKICAgIHsKICAgICAgICB0aGlzLmxvZyh0aGlzLkxvZ0xldmVsLkVSUk9SLCBtc2cpOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IGZhdGFsCiAgICAgKiAgTG9nIGEgbWVzc2FnZSBhdCB0aGUgU3Ryb3BoZS5Mb2dMZXZlbC5GQVRBTCBsZXZlbC4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJpbmcpIG1zZyAtIFRoZSBsb2cgbWVzc2FnZS4KICAgICAqLwogICAgZmF0YWw6IGZ1bmN0aW9uIChtc2cpCiAgICB7CiAgICAgICAgdGhpcy5sb2codGhpcy5Mb2dMZXZlbC5GQVRBTCwgbXNnKTsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiBzZXJpYWxpemUKICAgICAqICBSZW5kZXIgYSBET00gZWxlbWVudCBhbmQgYWxsIGRlc2NlbmRhbnRzIHRvIGEgU3RyaW5nLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFhNTEVsZW1lbnQpIGVsZW0gLSBBIERPTSBlbGVtZW50LgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgVGhlIHNlcmlhbGl6ZWQgZWxlbWVudCB0cmVlIGFzIGEgU3RyaW5nLgogICAgICovCiAgICBzZXJpYWxpemU6IGZ1bmN0aW9uIChlbGVtKQogICAgewogICAgICAgIHZhciByZXN1bHQ7CgogICAgICAgIGlmICghZWxlbSkgeyByZXR1cm4gbnVsbDsgfQoKICAgICAgICBpZiAodHlwZW9mKGVsZW0udHJlZSkgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgZWxlbSA9IGVsZW0udHJlZSgpOwogICAgICAgIH0KCiAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbS5ub2RlTmFtZTsKICAgICAgICB2YXIgaSwgY2hpbGQ7CgogICAgICAgIGlmIChlbGVtLmdldEF0dHJpYnV0ZSgiX3JlYWxuYW1lIikpIHsKICAgICAgICAgICAgbm9kZU5hbWUgPSBlbGVtLmdldEF0dHJpYnV0ZSgiX3JlYWxuYW1lIik7CiAgICAgICAgfQoKICAgICAgICByZXN1bHQgPSAiPCIgKyBub2RlTmFtZTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZWxlbS5hdHRyaWJ1dGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgIGlmKGVsZW0uYXR0cmlidXRlc1tpXS5ub2RlTmFtZSAhPSAiX3JlYWxuYW1lIikgewogICAgICAgICAgICAgICAgIHJlc3VsdCArPSAiICIgKyBlbGVtLmF0dHJpYnV0ZXNbaV0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSArCiAgICAgICAgICAgICAgICAiPSciICsgZWxlbS5hdHRyaWJ1dGVzW2ldLnZhbHVlCiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoLyYvZywgIiZhbXA7IikKICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXCcvZywgIiZhcG9zOyIpCiAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoLz4vZywgIiZndDsiKQogICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC88L2csICImbHQ7IikgKyAiJyI7CiAgICAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChlbGVtLmNoaWxkTm9kZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICByZXN1bHQgKz0gIj4iOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZWxlbS5jaGlsZE5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjaGlsZCA9IGVsZW0uY2hpbGROb2Rlc1tpXTsKICAgICAgICAgICAgICAgIHN3aXRjaCggY2hpbGQubm9kZVR5cGUgKXsKICAgICAgICAgICAgICAgICAgY2FzZSBTdHJvcGhlLkVsZW1lbnRUeXBlLk5PUk1BTDoKICAgICAgICAgICAgICAgICAgICAvLyBub3JtYWwgZWxlbWVudCwgc28gcmVjdXJzZQogICAgICAgICAgICAgICAgICAgIHJlc3VsdCArPSBTdHJvcGhlLnNlcmlhbGl6ZShjaGlsZCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgU3Ryb3BoZS5FbGVtZW50VHlwZS5URVhUOgogICAgICAgICAgICAgICAgICAgIC8vIHRleHQgZWxlbWVudCB0byBlc2NhcGUgdmFsdWVzCiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ICs9IFN0cm9waGUueG1sZXNjYXBlKGNoaWxkLm5vZGVWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgU3Ryb3BoZS5FbGVtZW50VHlwZS5DREFUQToKICAgICAgICAgICAgICAgICAgICAvLyBjZGF0YSBzZWN0aW9uIHNvIGRvbid0IGVzY2FwZSB2YWx1ZXMKICAgICAgICAgICAgICAgICAgICByZXN1bHQgKz0gIjwhW0NEQVRBWyIrY2hpbGQubm9kZVZhbHVlKyJdXT4iOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc3VsdCArPSAiPC8iICsgbm9kZU5hbWUgKyAiPiI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzdWx0ICs9ICIvPiI7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwKCiAgICAvKiogUHJpdmF0ZVZhcmlhYmxlOiBfcmVxdWVzdElkCiAgICAgKiAgX1ByaXZhdGVfIHZhcmlhYmxlIHRoYXQga2VlcHMgdHJhY2sgb2YgdGhlIHJlcXVlc3QgaWRzIGZvcgogICAgICogIGNvbm5lY3Rpb25zLgogICAgICovCiAgICBfcmVxdWVzdElkOiAwLAoKICAgIC8qKiBQcml2YXRlVmFyaWFibGU6IFN0cm9waGUuY29ubmVjdGlvblBsdWdpbnMKICAgICAqICBfUHJpdmF0ZV8gdmFyaWFibGUgVXNlZCB0byBzdG9yZSBwbHVnaW4gbmFtZXMgdGhhdCBuZWVkCiAgICAgKiAgaW5pdGlhbGl6YXRpb24gb24gU3Ryb3BoZS5Db25uZWN0aW9uIGNvbnN0cnVjdGlvbi4KICAgICAqLwogICAgX2Nvbm5lY3Rpb25QbHVnaW5zOiB7fSwKCiAgICAvKiogRnVuY3Rpb246IGFkZENvbm5lY3Rpb25QbHVnaW4KICAgICAqICBFeHRlbmRzIHRoZSBTdHJvcGhlLkNvbm5lY3Rpb24gb2JqZWN0IHdpdGggdGhlIGdpdmVuIHBsdWdpbi4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJpbmcpIG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgZXh0ZW5zaW9uLgogICAgICogICAgKE9iamVjdCkgcHR5cGUgLSBUaGUgcGx1Z2luJ3MgcHJvdG90eXBlLgogICAgICovCiAgICBhZGRDb25uZWN0aW9uUGx1Z2luOiBmdW5jdGlvbiAobmFtZSwgcHR5cGUpCiAgICB7CiAgICAgICAgU3Ryb3BoZS5fY29ubmVjdGlvblBsdWdpbnNbbmFtZV0gPSBwdHlwZTsKICAgIH0KfTsKCi8qKiBDbGFzczogU3Ryb3BoZS5CdWlsZGVyCiAqICBYTUwgRE9NIGJ1aWxkZXIuCiAqCiAqICBUaGlzIG9iamVjdCBwcm92aWRlcyBhbiBpbnRlcmZhY2Ugc2ltaWxhciB0byBKUXVlcnkgYnV0IGZvciBidWlsZGluZwogKiAgRE9NIGVsZW1lbnQgZWFzaWx5IGFuZCByYXBpZGx5LiAgQWxsIHRoZSBmdW5jdGlvbnMgZXhjZXB0IGZvciB0b1N0cmluZygpCiAqICBhbmQgdHJlZSgpIHJldHVybiB0aGUgb2JqZWN0LCBzbyBjYWxscyBjYW4gYmUgY2hhaW5lZC4gIEhlcmUncyBhbgogKiAgZXhhbXBsZSB1c2luZyB0aGUgJGlxKCkgYnVpbGRlciBoZWxwZXIuCiAqICA+ICRpcSh7dG86ICd5b3UnLCBmcm9tOiAnbWUnLCB0eXBlOiAnZ2V0JywgaWQ6ICcxJ30pCiAqICA+ICAgICAuYygncXVlcnknLCB7eG1sbnM6ICdzdHJvcGhlOmV4YW1wbGUnfSkKICogID4gICAgIC5jKCdleGFtcGxlJykKICogID4gICAgIC50b1N0cmluZygpCiAqICBUaGUgYWJvdmUgZ2VuZXJhdGVzIHRoaXMgWE1MIGZyYWdtZW50CiAqICA+IDxpcSB0bz0neW91JyBmcm9tPSdtZScgdHlwZT0nZ2V0JyBpZD0nMSc+CiAqICA+ICAgPHF1ZXJ5IHhtbG5zPSdzdHJvcGhlOmV4YW1wbGUnPgogKiAgPiAgICAgPGV4YW1wbGUvPgogKiAgPiAgIDwvcXVlcnk+CiAqICA+IDwvaXE+CiAqICBUaGUgY29ycmVzcG9uZGluZyBET00gbWFuaXB1bGF0aW9ucyB0byBnZXQgYSBzaW1pbGFyIGZyYWdtZW50IHdvdWxkIGJlCiAqICBhIGxvdCBtb3JlIHRlZGlvdXMgYW5kIHByb2JhYmx5IGludm9sdmUgc2V2ZXJhbCBoZWxwZXIgdmFyaWFibGVzLgogKgogKiAgU2luY2UgYWRkaW5nIGNoaWxkcmVuIG1ha2VzIG5ldyBvcGVyYXRpb25zIG9wZXJhdGUgb24gdGhlIGNoaWxkLCB1cCgpCiAqICBpcyBwcm92aWRlZCB0byB0cmF2ZXJzZSB1cCB0aGUgdHJlZS4gIFRvIGFkZCB0d28gY2hpbGRyZW4sIGRvCiAqICA+IGJ1aWxkZXIuYygnY2hpbGQxJywgLi4uKS51cCgpLmMoJ2NoaWxkMicsIC4uLikKICogIFRoZSBuZXh0IG9wZXJhdGlvbiBvbiB0aGUgQnVpbGRlciB3aWxsIGJlIHJlbGF0aXZlIHRvIHRoZSBzZWNvbmQgY2hpbGQuCiAqLwoKLyoqIENvbnN0cnVjdG9yOiBTdHJvcGhlLkJ1aWxkZXIKICogIENyZWF0ZSBhIFN0cm9waGUuQnVpbGRlciBvYmplY3QuCiAqCiAqICBUaGUgYXR0cmlidXRlcyBzaG91bGQgYmUgcGFzc2VkIGluIG9iamVjdCBub3RhdGlvbi4gIEZvciBleGFtcGxlCiAqICA+IHZhciBiID0gbmV3IEJ1aWxkZXIoJ21lc3NhZ2UnLCB7dG86ICd5b3UnLCBmcm9tOiAnbWUnfSk7CiAqICBvcgogKiAgPiB2YXIgYiA9IG5ldyBCdWlsZGVyKCdtZXNzc2FnZScsIHsneG1sOmxhbmcnOiAnZW4nfSk7CiAqCiAqICBQYXJhbWV0ZXJzOgogKiAgICAoU3RyaW5nKSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIHJvb3QgZWxlbWVudC4KICogICAgKE9iamVjdCkgYXR0cnMgLSBUaGUgYXR0cmlidXRlcyBmb3IgdGhlIHJvb3QgZWxlbWVudCBpbiBvYmplY3Qgbm90YXRpb24uCiAqCiAqICBSZXR1cm5zOgogKiAgICBBIG5ldyBTdHJvcGhlLkJ1aWxkZXIuCiAqLwpTdHJvcGhlLkJ1aWxkZXIgPSBmdW5jdGlvbiAobmFtZSwgYXR0cnMpCnsKICAgIC8vIFNldCBjb3JyZWN0IG5hbWVzcGFjZSBmb3IgamFiYmVyOmNsaWVudCBlbGVtZW50cwogICAgaWYgKG5hbWUgPT0gInByZXNlbmNlIiB8fCBuYW1lID09ICJtZXNzYWdlIiB8fCBuYW1lID09ICJpcSIpIHsKICAgICAgICBpZiAoYXR0cnMgJiYgIWF0dHJzLnhtbG5zKSB7CiAgICAgICAgICAgIGF0dHJzLnhtbG5zID0gU3Ryb3BoZS5OUy5DTElFTlQ7CiAgICAgICAgfSBlbHNlIGlmICghYXR0cnMpIHsKICAgICAgICAgICAgYXR0cnMgPSB7eG1sbnM6IFN0cm9waGUuTlMuQ0xJRU5UfTsKICAgICAgICB9CiAgICB9CgogICAgLy8gSG9sZHMgdGhlIHRyZWUgYmVpbmcgYnVpbHQuCiAgICB0aGlzLm5vZGVUcmVlID0gU3Ryb3BoZS54bWxFbGVtZW50KG5hbWUsIGF0dHJzKTsKCiAgICAvLyBQb2ludHMgdG8gdGhlIGN1cnJlbnQgb3BlcmF0aW9uIG5vZGUuCiAgICB0aGlzLm5vZGUgPSB0aGlzLm5vZGVUcmVlOwp9OwoKU3Ryb3BoZS5CdWlsZGVyLnByb3RvdHlwZSA9IHsKICAgIC8qKiBGdW5jdGlvbjogdHJlZQogICAgICogIFJldHVybiB0aGUgRE9NIHRyZWUuCiAgICAgKgogICAgICogIFRoaXMgZnVuY3Rpb24gcmV0dXJucyB0aGUgY3VycmVudCBET00gdHJlZSBhcyBhbiBlbGVtZW50IG9iamVjdC4gIFRoaXMKICAgICAqICBpcyBzdWl0YWJsZSBmb3IgcGFzc2luZyB0byBmdW5jdGlvbnMgbGlrZSBTdHJvcGhlLkNvbm5lY3Rpb24uc2VuZCgpLgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgVGhlIERPTSB0cmVlIGFzIGEgZWxlbWVudCBvYmplY3QuCiAgICAgKi8KICAgIHRyZWU6IGZ1bmN0aW9uICgpCiAgICB7CiAgICAgICAgcmV0dXJuIHRoaXMubm9kZVRyZWU7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogdG9TdHJpbmcKICAgICAqICBTZXJpYWxpemUgdGhlIERPTSB0cmVlIHRvIGEgU3RyaW5nLgogICAgICoKICAgICAqICBUaGlzIGZ1bmN0aW9uIHJldHVybnMgYSBzdHJpbmcgc2VyaWFsaXphdGlvbiBvZiB0aGUgY3VycmVudCBET00KICAgICAqICB0cmVlLiAgSXQgaXMgb2Z0ZW4gdXNlZCBpbnRlcm5hbGx5IHRvIHBhc3MgZGF0YSB0byBhCiAgICAgKiAgU3Ryb3BoZS5SZXF1ZXN0IG9iamVjdC4KICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgIFRoZSBzZXJpYWxpemVkIERPTSB0cmVlIGluIGEgU3RyaW5nLgogICAgICovCiAgICB0b1N0cmluZzogZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICByZXR1cm4gU3Ryb3BoZS5zZXJpYWxpemUodGhpcy5ub2RlVHJlZSk7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogdXAKICAgICAqICBNYWtlIHRoZSBjdXJyZW50IHBhcmVudCBlbGVtZW50IHRoZSBuZXcgY3VycmVudCBlbGVtZW50LgogICAgICoKICAgICAqICBUaGlzIGZ1bmN0aW9uIGlzIG9mdGVuIHVzZWQgYWZ0ZXIgYygpIHRvIHRyYXZlcnNlIGJhY2sgdXAgdGhlIHRyZWUuCiAgICAgKiAgRm9yIGV4YW1wbGUsIHRvIGFkZCB0d28gY2hpbGRyZW4gdG8gdGhlIHNhbWUgZWxlbWVudAogICAgICogID4gYnVpbGRlci5jKCdjaGlsZDEnLCB7fSkudXAoKS5jKCdjaGlsZDInLCB7fSk7CiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBUaGUgU3RvcGhlLkJ1aWxkZXIgb2JqZWN0LgogICAgICovCiAgICB1cDogZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICB0aGlzLm5vZGUgPSB0aGlzLm5vZGUucGFyZW50Tm9kZTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiBhdHRycwogICAgICogIEFkZCBvciBtb2RpZnkgYXR0cmlidXRlcyBvZiB0aGUgY3VycmVudCBlbGVtZW50LgogICAgICoKICAgICAqICBUaGUgYXR0cmlidXRlcyBzaG91bGQgYmUgcGFzc2VkIGluIG9iamVjdCBub3RhdGlvbi4gIFRoaXMgZnVuY3Rpb24KICAgICAqICBkb2VzIG5vdCBtb3ZlIHRoZSBjdXJyZW50IGVsZW1lbnQgcG9pbnRlci4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChPYmplY3QpIG1vcmVhdHRycyAtIFRoZSBhdHRyaWJ1dGVzIHRvIGFkZC9tb2RpZnkgaW4gb2JqZWN0IG5vdGF0aW9uLgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgVGhlIFN0cm9waGUuQnVpbGRlciBvYmplY3QuCiAgICAgKi8KICAgIGF0dHJzOiBmdW5jdGlvbiAobW9yZWF0dHJzKQogICAgewogICAgICAgIGZvciAodmFyIGsgaW4gbW9yZWF0dHJzKSB7CiAgICAgICAgICAgIGlmIChtb3JlYXR0cnMuaGFzT3duUHJvcGVydHkoaykpIHsKICAgICAgICAgICAgICAgIHRoaXMubm9kZS5zZXRBdHRyaWJ1dGUoaywgbW9yZWF0dHJzW2tdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiBjCiAgICAgKiAgQWRkIGEgY2hpbGQgdG8gdGhlIGN1cnJlbnQgZWxlbWVudCBhbmQgbWFrZSBpdCB0aGUgbmV3IGN1cnJlbnQKICAgICAqICBlbGVtZW50LgogICAgICoKICAgICAqICBUaGlzIGZ1bmN0aW9uIG1vdmVzIHRoZSBjdXJyZW50IGVsZW1lbnQgcG9pbnRlciB0byB0aGUgY2hpbGQsCiAgICAgKiAgdW5sZXNzIHRleHQgaXMgcHJvdmlkZWQuICBJZiB5b3UgbmVlZCB0byBhZGQgYW5vdGhlciBjaGlsZCwgaXQKICAgICAqICBpcyBuZWNlc3NhcnkgdG8gdXNlIHVwKCkgdG8gZ28gYmFjayB0byB0aGUgcGFyZW50IGluIHRoZSB0cmVlLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cmluZykgbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBjaGlsZC4KICAgICAqICAgIChPYmplY3QpIGF0dHJzIC0gVGhlIGF0dHJpYnV0ZXMgb2YgdGhlIGNoaWxkIGluIG9iamVjdCBub3RhdGlvbi4KICAgICAqICAgIChTdHJpbmcpIHRleHQgLSBUaGUgdGV4dCB0byBhZGQgdG8gdGhlIGNoaWxkLgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgVGhlIFN0cm9waGUuQnVpbGRlciBvYmplY3QuCiAgICAgKi8KICAgIGM6IGZ1bmN0aW9uIChuYW1lLCBhdHRycywgdGV4dCkKICAgIHsKICAgICAgICB2YXIgY2hpbGQgPSBTdHJvcGhlLnhtbEVsZW1lbnQobmFtZSwgYXR0cnMsIHRleHQpOwogICAgICAgIHRoaXMubm9kZS5hcHBlbmRDaGlsZChjaGlsZCk7CiAgICAgICAgaWYgKCF0ZXh0KSB7CiAgICAgICAgICAgIHRoaXMubm9kZSA9IGNoaWxkOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiBjbm9kZQogICAgICogIEFkZCBhIGNoaWxkIHRvIHRoZSBjdXJyZW50IGVsZW1lbnQgYW5kIG1ha2UgaXQgdGhlIG5ldyBjdXJyZW50CiAgICAgKiAgZWxlbWVudC4KICAgICAqCiAgICAgKiAgVGhpcyBmdW5jdGlvbiBpcyB0aGUgc2FtZSBhcyBjKCkgZXhjZXB0IHRoYXQgaW5zdGVhZCBvZiB1c2luZyBhCiAgICAgKiAgbmFtZSBhbmQgYW4gYXR0cmlidXRlcyBvYmplY3QgdG8gY3JlYXRlIHRoZSBjaGlsZCBpdCB1c2VzIGFuCiAgICAgKiAgZXhpc3RpbmcgRE9NIGVsZW1lbnQgb2JqZWN0LgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFhNTEVsZW1lbnQpIGVsZW0gLSBBIERPTSBlbGVtZW50LgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgVGhlIFN0cm9waGUuQnVpbGRlciBvYmplY3QuCiAgICAgKi8KICAgIGNub2RlOiBmdW5jdGlvbiAoZWxlbSkKICAgIHsKICAgICAgICB2YXIgaW1wTm9kZTsKICAgICAgICB2YXIgeG1sR2VuID0gU3Ryb3BoZS54bWxHZW5lcmF0b3IoKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBpbXBOb2RlID0gKHhtbEdlbi5pbXBvcnROb2RlICE9PSB1bmRlZmluZWQpOwogICAgICAgIH0KICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICBpbXBOb2RlID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHZhciBuZXdFbGVtID0gaW1wTm9kZSA/CiAgICAgICAgICAgICAgICAgICAgICB4bWxHZW4uaW1wb3J0Tm9kZShlbGVtLCB0cnVlKSA6CiAgICAgICAgICAgICAgICAgICAgICBTdHJvcGhlLmNvcHlFbGVtZW50KGVsZW0pOwogICAgICAgIHRoaXMubm9kZS5hcHBlbmRDaGlsZChuZXdFbGVtKTsKICAgICAgICB0aGlzLm5vZGUgPSBuZXdFbGVtOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IHQKICAgICAqICBBZGQgYSBjaGlsZCB0ZXh0IGVsZW1lbnQuCiAgICAgKgogICAgICogIFRoaXMgKmRvZXMgbm90KiBtYWtlIHRoZSBjaGlsZCB0aGUgbmV3IGN1cnJlbnQgZWxlbWVudCBzaW5jZSB0aGVyZQogICAgICogIGFyZSBubyBjaGlsZHJlbiBvZiB0ZXh0IGVsZW1lbnRzLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cmluZykgdGV4dCAtIFRoZSB0ZXh0IGRhdGEgdG8gYXBwZW5kIHRvIHRoZSBjdXJyZW50IGVsZW1lbnQuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBUaGUgU3Ryb3BoZS5CdWlsZGVyIG9iamVjdC4KICAgICAqLwogICAgdDogZnVuY3Rpb24gKHRleHQpCiAgICB7CiAgICAgICAgdmFyIGNoaWxkID0gU3Ryb3BoZS54bWxUZXh0Tm9kZSh0ZXh0KTsKICAgICAgICB0aGlzLm5vZGUuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IGgKICAgICAqICBSZXBsYWNlIGN1cnJlbnQgZWxlbWVudCBjb250ZW50cyB3aXRoIHRoZSBIVE1MIHBhc3NlZCBpbi4KICAgICAqCiAgICAgKiAgVGhpcyAqZG9lcyBub3QqIG1ha2UgdGhlIGNoaWxkIHRoZSBuZXcgY3VycmVudCBlbGVtZW50CiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoU3RyaW5nKSBodG1sIC0gVGhlIGh0bWwgdG8gaW5zZXJ0IGFzIGNvbnRlbnRzIG9mIGN1cnJlbnQgZWxlbWVudC4KICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgIFRoZSBTdHJvcGhlLkJ1aWxkZXIgb2JqZWN0LgogICAgICovCiAgICBoOiBmdW5jdGlvbiAoaHRtbCkKICAgIHsKICAgICAgICB2YXIgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdib2R5Jyk7CgogICAgICAgIC8vIGZvcmNlIHRoZSBicm93c2VyIHRvIHRyeSBhbmQgZml4IGFueSBpbnZhbGlkIEhUTUwgdGFncwogICAgICAgIGZyYWdtZW50LmlubmVySFRNTCA9IGh0bWw7CgogICAgICAgIC8vIGNvcHkgY2xlYW5lZCBodG1sIGludG8gYW4geG1sIGRvbQogICAgICAgIHZhciB4aHRtbCA9IFN0cm9waGUuY3JlYXRlSHRtbChmcmFnbWVudCk7CgogICAgICAgIHdoaWxlKHhodG1sLmNoaWxkTm9kZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB0aGlzLm5vZGUuYXBwZW5kQ2hpbGQoeGh0bWwuY2hpbGROb2Rlc1swXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfQp9OwoKLyoqIFByaXZhdGVDbGFzczogU3Ryb3BoZS5IYW5kbGVyCiAqICBfUHJpdmF0ZV8gaGVscGVyIGNsYXNzIGZvciBtYW5hZ2luZyBzdGFuemEgaGFuZGxlcnMuCiAqCiAqICBBIFN0cm9waGUuSGFuZGxlciBlbmNhcHN1bGF0ZXMgYSB1c2VyIHByb3ZpZGVkIGNhbGxiYWNrIGZ1bmN0aW9uIHRvIGJlCiAqICBleGVjdXRlZCB3aGVuIG1hdGNoaW5nIHN0YW56YXMgYXJlIHJlY2VpdmVkIGJ5IHRoZSBjb25uZWN0aW9uLgogKiAgSGFuZGxlcnMgY2FuIGJlIGVpdGhlciBvbmUtb2ZmIG9yIHBlcnNpc3RhbnQgZGVwZW5kaW5nIG9uIHRoZWlyCiAqICByZXR1cm4gdmFsdWUuIFJldHVybmluZyB0cnVlIHdpbGwgY2F1c2UgYSBIYW5kbGVyIHRvIHJlbWFpbiBhY3RpdmUsIGFuZAogKiAgcmV0dXJuaW5nIGZhbHNlIHdpbGwgcmVtb3ZlIHRoZSBIYW5kbGVyLgogKgogKiAgVXNlcnMgd2lsbCBub3QgdXNlIFN0cm9waGUuSGFuZGxlciBvYmplY3RzIGRpcmVjdGx5LCBidXQgaW5zdGVhZCB0aGV5CiAqICB3aWxsIHVzZSBTdHJvcGhlLkNvbm5lY3Rpb24uYWRkSGFuZGxlcigpIGFuZAogKiAgU3Ryb3BoZS5Db25uZWN0aW9uLmRlbGV0ZUhhbmRsZXIoKS4KICovCgovKiogUHJpdmF0ZUNvbnN0cnVjdG9yOiBTdHJvcGhlLkhhbmRsZXIKICogIENyZWF0ZSBhbmQgaW5pdGlhbGl6ZSBhIG5ldyBTdHJvcGhlLkhhbmRsZXIuCiAqCiAqICBQYXJhbWV0ZXJzOgogKiAgICAoRnVuY3Rpb24pIGhhbmRsZXIgLSBBIGZ1bmN0aW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gdGhlIGhhbmRsZXIgaXMgcnVuLgogKiAgICAoU3RyaW5nKSBucyAtIFRoZSBuYW1lc3BhY2UgdG8gbWF0Y2guCiAqICAgIChTdHJpbmcpIG5hbWUgLSBUaGUgZWxlbWVudCBuYW1lIHRvIG1hdGNoLgogKiAgICAoU3RyaW5nKSB0eXBlIC0gVGhlIGVsZW1lbnQgdHlwZSB0byBtYXRjaC4KICogICAgKFN0cmluZykgaWQgLSBUaGUgZWxlbWVudCBpZCBhdHRyaWJ1dGUgdG8gbWF0Y2guCiAqICAgIChTdHJpbmcpIGZyb20gLSBUaGUgZWxlbWVudCBmcm9tIGF0dHJpYnV0ZSB0byBtYXRjaC4KICogICAgKE9iamVjdCkgb3B0aW9ucyAtIEhhbmRsZXIgb3B0aW9ucwogKgogKiAgUmV0dXJuczoKICogICAgQSBuZXcgU3Ryb3BoZS5IYW5kbGVyIG9iamVjdC4KICovClN0cm9waGUuSGFuZGxlciA9IGZ1bmN0aW9uIChoYW5kbGVyLCBucywgbmFtZSwgdHlwZSwgaWQsIGZyb20sIG9wdGlvbnMpCnsKICAgIHRoaXMuaGFuZGxlciA9IGhhbmRsZXI7CiAgICB0aGlzLm5zID0gbnM7CiAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgdGhpcy50eXBlID0gdHlwZTsKICAgIHRoaXMuaWQgPSBpZDsKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge21hdGNoQmFyZTogZmFsc2V9OwoKICAgIC8vIGRlZmF1bHQgbWF0Y2hCYXJlIHRvIGZhbHNlIGlmIHVuZGVmaW5lZAogICAgaWYgKCF0aGlzLm9wdGlvbnMubWF0Y2hCYXJlKSB7CiAgICAgICAgdGhpcy5vcHRpb25zLm1hdGNoQmFyZSA9IGZhbHNlOwogICAgfQoKICAgIGlmICh0aGlzLm9wdGlvbnMubWF0Y2hCYXJlKSB7CiAgICAgICAgdGhpcy5mcm9tID0gZnJvbSA/IFN0cm9waGUuZ2V0QmFyZUppZEZyb21KaWQoZnJvbSkgOiBudWxsOwogICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmZyb20gPSBmcm9tOwogICAgfQoKICAgIC8vIHdoZXRoZXIgdGhlIGhhbmRsZXIgaXMgYSB1c2VyIGhhbmRsZXIgb3IgYSBzeXN0ZW0gaGFuZGxlcgogICAgdGhpcy51c2VyID0gdHJ1ZTsKfTsKClN0cm9waGUuSGFuZGxlci5wcm90b3R5cGUgPSB7CiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBpc01hdGNoCiAgICAgKiAgVGVzdHMgaWYgYSBzdGFuemEgbWF0Y2hlcyB0aGUgU3Ryb3BoZS5IYW5kbGVyLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFhNTEVsZW1lbnQpIGVsZW0gLSBUaGUgWE1MIGVsZW1lbnQgdG8gdGVzdC4KICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgIHRydWUgaWYgdGhlIHN0YW56YSBtYXRjaGVzIGFuZCBmYWxzZSBvdGhlcndpc2UuCiAgICAgKi8KICAgIGlzTWF0Y2g6IGZ1bmN0aW9uIChlbGVtKQogICAgewogICAgICAgIHZhciBuc01hdGNoOwogICAgICAgIHZhciBmcm9tID0gbnVsbDsKCiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5tYXRjaEJhcmUpIHsKICAgICAgICAgICAgZnJvbSA9IFN0cm9waGUuZ2V0QmFyZUppZEZyb21KaWQoZWxlbS5nZXRBdHRyaWJ1dGUoJ2Zyb20nKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZnJvbSA9IGVsZW0uZ2V0QXR0cmlidXRlKCdmcm9tJyk7CiAgICAgICAgfQoKICAgICAgICBuc01hdGNoID0gZmFsc2U7CiAgICAgICAgaWYgKCF0aGlzLm5zKSB7CiAgICAgICAgICAgIG5zTWF0Y2ggPSB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgU3Ryb3BoZS5mb3JFYWNoQ2hpbGQoZWxlbSwgbnVsbCwgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgICAgIGlmIChlbGVtLmdldEF0dHJpYnV0ZSgieG1sbnMiKSA9PSB0aGF0Lm5zKSB7CiAgICAgICAgICAgICAgICAgICAgbnNNYXRjaCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgbnNNYXRjaCA9IG5zTWF0Y2ggfHwgZWxlbS5nZXRBdHRyaWJ1dGUoInhtbG5zIikgPT0gdGhpcy5uczsKICAgICAgICB9CgogICAgICAgIGlmIChuc01hdGNoICYmCiAgICAgICAgICAgICghdGhpcy5uYW1lIHx8IFN0cm9waGUuaXNUYWdFcXVhbChlbGVtLCB0aGlzLm5hbWUpKSAmJgogICAgICAgICAgICAoIXRoaXMudHlwZSB8fCBlbGVtLmdldEF0dHJpYnV0ZSgidHlwZSIpID09IHRoaXMudHlwZSkgJiYKICAgICAgICAgICAgKCF0aGlzLmlkIHx8IGVsZW0uZ2V0QXR0cmlidXRlKCJpZCIpID09IHRoaXMuaWQpICYmCiAgICAgICAgICAgICghdGhpcy5mcm9tIHx8IGZyb20gPT0gdGhpcy5mcm9tKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IHJ1bgogICAgICogIFJ1biB0aGUgY2FsbGJhY2sgb24gYSBtYXRjaGluZyBzdGFuemEuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoWE1MRWxlbWVudCkgZWxlbSAtIFRoZSBET00gZWxlbWVudCB0aGF0IHRyaWdnZXJlZCB0aGUKICAgICAqICAgICAgU3Ryb3BoZS5IYW5kbGVyLgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgQSBib29sZWFuIGluZGljYXRpbmcgaWYgdGhlIGhhbmRsZXIgc2hvdWxkIHJlbWFpbiBhY3RpdmUuCiAgICAgKi8KICAgIHJ1bjogZnVuY3Rpb24gKGVsZW0pCiAgICB7CiAgICAgICAgdmFyIHJlc3VsdCA9IG51bGw7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmVzdWx0ID0gdGhpcy5oYW5kbGVyKGVsZW0pOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgaWYgKGUuc291cmNlVVJMKSB7CiAgICAgICAgICAgICAgICBTdHJvcGhlLmZhdGFsKCJlcnJvcjogIiArIHRoaXMuaGFuZGxlciArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgIiArIGUuc291cmNlVVJMICsgIjoiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZS5saW5lICsgIiAtICIgKyBlLm5hbWUgKyAiOiAiICsgZS5tZXNzYWdlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChlLmZpbGVOYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mKGNvbnNvbGUpICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS50cmFjZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IodGhpcy5oYW5kbGVyLCAiIC0gZXJyb3IgLSAiLCBlLCBlLm1lc3NhZ2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgU3Ryb3BoZS5mYXRhbCgiZXJyb3I6ICIgKyB0aGlzLmhhbmRsZXIgKyAiICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlLmZpbGVOYW1lICsgIjoiICsgZS5saW5lTnVtYmVyICsgIiAtICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlLm5hbWUgKyAiOiAiICsgZS5tZXNzYWdlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIFN0cm9waGUuZmF0YWwoImVycm9yOiAiICsgZS5tZXNzYWdlICsgIlxuIiArIGUuc3RhY2spOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogdG9TdHJpbmcKICAgICAqICBHZXQgYSBTdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIFN0cm9waGUuSGFuZGxlciBvYmplY3QuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBBIFN0cmluZy4KICAgICAqLwogICAgdG9TdHJpbmc6IGZ1bmN0aW9uICgpCiAgICB7CiAgICAgICAgcmV0dXJuICJ7SGFuZGxlcjogIiArIHRoaXMuaGFuZGxlciArICIoIiArIHRoaXMubmFtZSArICIsIiArCiAgICAgICAgICAgIHRoaXMuaWQgKyAiLCIgKyB0aGlzLm5zICsgIil9IjsKICAgIH0KfTsKCi8qKiBQcml2YXRlQ2xhc3M6IFN0cm9waGUuVGltZWRIYW5kbGVyCiAqICBfUHJpdmF0ZV8gaGVscGVyIGNsYXNzIGZvciBtYW5hZ2luZyB0aW1lZCBoYW5kbGVycy4KICoKICogIEEgU3Ryb3BoZS5UaW1lZEhhbmRsZXIgZW5jYXBzdWxhdGVzIGEgdXNlciBwcm92aWRlZCBjYWxsYmFjayB0aGF0CiAqICBzaG91bGQgYmUgY2FsbGVkIGFmdGVyIGEgY2VydGFpbiBwZXJpb2Qgb2YgdGltZSBvciBhdCByZWd1bGFyCiAqICBpbnRlcnZhbHMuICBUaGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBjYWxsYmFjayBkZXRlcm1pbmVzIHdoZXRoZXIgdGhlCiAqICBTdHJvcGhlLlRpbWVkSGFuZGxlciB3aWxsIGNvbnRpbnVlIHRvIGZpcmUuCiAqCiAqICBVc2VycyB3aWxsIG5vdCB1c2UgU3Ryb3BoZS5UaW1lZEhhbmRsZXIgb2JqZWN0cyBkaXJlY3RseSwgYnV0IGluc3RlYWQKICogIHRoZXkgd2lsbCB1c2UgU3Ryb3BoZS5Db25uZWN0aW9uLmFkZFRpbWVkSGFuZGxlcigpIGFuZAogKiAgU3Ryb3BoZS5Db25uZWN0aW9uLmRlbGV0ZVRpbWVkSGFuZGxlcigpLgogKi8KCi8qKiBQcml2YXRlQ29uc3RydWN0b3I6IFN0cm9waGUuVGltZWRIYW5kbGVyCiAqICBDcmVhdGUgYW5kIGluaXRpYWxpemUgYSBuZXcgU3Ryb3BoZS5UaW1lZEhhbmRsZXIgb2JqZWN0LgogKgogKiAgUGFyYW1ldGVyczoKICogICAgKEludGVnZXIpIHBlcmlvZCAtIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXQgYmVmb3JlIHRoZQogKiAgICAgIGhhbmRsZXIgaXMgY2FsbGVkLgogKiAgICAoRnVuY3Rpb24pIGhhbmRsZXIgLSBUaGUgY2FsbGJhY2sgdG8gcnVuIHdoZW4gdGhlIGhhbmRsZXIgZmlyZXMuICBUaGlzCiAqICAgICAgZnVuY3Rpb24gc2hvdWxkIHRha2Ugbm8gYXJndW1lbnRzLgogKgogKiAgUmV0dXJuczoKICogICAgQSBuZXcgU3Ryb3BoZS5UaW1lZEhhbmRsZXIgb2JqZWN0LgogKi8KU3Ryb3BoZS5UaW1lZEhhbmRsZXIgPSBmdW5jdGlvbiAocGVyaW9kLCBoYW5kbGVyKQp7CiAgICB0aGlzLnBlcmlvZCA9IHBlcmlvZDsKICAgIHRoaXMuaGFuZGxlciA9IGhhbmRsZXI7CgogICAgdGhpcy5sYXN0Q2FsbGVkID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICB0aGlzLnVzZXIgPSB0cnVlOwp9OwoKU3Ryb3BoZS5UaW1lZEhhbmRsZXIucHJvdG90eXBlID0gewogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogcnVuCiAgICAgKiAgUnVuIHRoZSBjYWxsYmFjayBmb3IgdGhlIFN0cm9waGUuVGltZWRIYW5kbGVyLgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgdHJ1ZSBpZiB0aGUgU3Ryb3BoZS5UaW1lZEhhbmRsZXIgc2hvdWxkIGJlIGNhbGxlZCBhZ2FpbiwgYW5kIGZhbHNlCiAgICAgKiAgICAgIG90aGVyd2lzZS4KICAgICAqLwogICAgcnVuOiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIHRoaXMubGFzdENhbGxlZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgICAgIHJldHVybiB0aGlzLmhhbmRsZXIoKTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogcmVzZXQKICAgICAqICBSZXNldCB0aGUgbGFzdCBjYWxsZWQgdGltZSBmb3IgdGhlIFN0cm9waGUuVGltZWRIYW5kbGVyLgogICAgICovCiAgICByZXNldDogZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICB0aGlzLmxhc3RDYWxsZWQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogdG9TdHJpbmcKICAgICAqICBHZXQgYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIFN0cm9waGUuVGltZWRIYW5kbGVyIG9iamVjdC4KICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgIFRoZSBzdHJpbmcgcmVwcmVzZW50YXRpb24uCiAgICAgKi8KICAgIHRvU3RyaW5nOiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIHJldHVybiAie1RpbWVkSGFuZGxlcjogIiArIHRoaXMuaGFuZGxlciArICIoIiArIHRoaXMucGVyaW9kICsiKX0iOwogICAgfQp9OwoKLyoqIENsYXNzOiBTdHJvcGhlLkNvbm5lY3Rpb24KICogIFhNUFAgQ29ubmVjdGlvbiBtYW5hZ2VyLgogKgogKiAgVGhpcyBjbGFzcyBpcyB0aGUgbWFpbiBwYXJ0IG9mIFN0cm9waGUuICBJdCBtYW5hZ2VzIGEgQk9TSCBjb25uZWN0aW9uCiAqICB0byBhbiBYTVBQIHNlcnZlciBhbmQgZGlzcGF0Y2hlcyBldmVudHMgdG8gdGhlIHVzZXIgY2FsbGJhY2tzIGFzCiAqICBkYXRhIGFycml2ZXMuICBJdCBzdXBwb3J0cyBTQVNMIFBMQUlOLCBTQVNMIERJR0VTVC1NRDUsIFNBU0wgU0NSQU0tU0hBMQogKiAgYW5kIGxlZ2FjeSBhdXRoZW50aWNhdGlvbi4KICoKICogIEFmdGVyIGNyZWF0aW5nIGEgU3Ryb3BoZS5Db25uZWN0aW9uIG9iamVjdCwgdGhlIHVzZXIgd2lsbCB0eXBpY2FsbHkKICogIGNhbGwgY29ubmVjdCgpIHdpdGggYSB1c2VyIHN1cHBsaWVkIGNhbGxiYWNrIHRvIGhhbmRsZSBjb25uZWN0aW9uIGxldmVsCiAqICBldmVudHMgbGlrZSBhdXRoZW50aWNhdGlvbiBmYWlsdXJlLCBkaXNjb25uZWN0aW9uLCBvciBjb25uZWN0aW9uCiAqICBjb21wbGV0ZS4KICoKICogIFRoZSB1c2VyIHdpbGwgYWxzbyBoYXZlIHNldmVyYWwgZXZlbnQgaGFuZGxlcnMgZGVmaW5lZCBieSB1c2luZwogKiAgYWRkSGFuZGxlcigpIGFuZCBhZGRUaW1lZEhhbmRsZXIoKS4gIFRoZXNlIHdpbGwgYWxsb3cgdGhlIHVzZXIgY29kZSB0bwogKiAgcmVzcG9uZCB0byBpbnRlcmVzdGluZyBzdGFuemFzIG9yIGRvIHNvbWV0aGluZyBwZXJpb2RpY2FsbHkgd2l0aCB0aGUKICogIGNvbm5lY3Rpb24uICBUaGVzZSBoYW5kbGVycyB3aWxsIGJlIGFjdGl2ZSBvbmNlIGF1dGhlbnRpY2F0aW9uIGlzCiAqICBmaW5pc2hlZC4KICoKICogIFRvIHNlbmQgZGF0YSB0byB0aGUgY29ubmVjdGlvbiwgdXNlIHNlbmQoKS4KICovCgovKiogQ29uc3RydWN0b3I6IFN0cm9waGUuQ29ubmVjdGlvbgogKiAgQ3JlYXRlIGFuZCBpbml0aWFsaXplIGEgU3Ryb3BoZS5Db25uZWN0aW9uIG9iamVjdC4KICoKICogIFRoZSB0cmFuc3BvcnQtcHJvdG9jb2wgZm9yIHRoaXMgY29ubmVjdGlvbiB3aWxsIGJlIGNob3NlbiBhdXRvbWF0aWNhbGx5CiAqICBiYXNlZCBvbiB0aGUgZ2l2ZW4gc2VydmljZSBwYXJhbWV0ZXIuIFVSTHMgc3RhcnRpbmcgd2l0aCAid3M6Ly8iIG9yCiAqICAid3NzOi8vIiB3aWxsIHVzZSBXZWJTb2NrZXRzLCBVUkxzIHN0YXJ0aW5nIHdpdGggImh0dHA6Ly8iLCAiaHR0cHM6Ly8iCiAqICBvciB3aXRob3V0IGEgcHJvdG9jb2wgd2lsbCB1c2UgQk9TSC4KICoKICogIFRvIG1ha2UgU3Ryb3BoZSBjb25uZWN0IHRvIHRoZSBjdXJyZW50IGhvc3QgeW91IGNhbiBsZWF2ZSBvdXQgdGhlIHByb3RvY29sCiAqICBhbmQgaG9zdCBwYXJ0IGFuZCBqdXN0IHBhc3MgdGhlIHBhdGgsIGUuZy4KICoKICogID4gdmFyIGNvbm4gPSBuZXcgU3Ryb3BoZS5Db25uZWN0aW9uKCIvaHR0cC1iaW5kLyIpOwogKgogKiAgV2ViU29ja2V0IG9wdGlvbnM6CiAqCiAqICBJZiB5b3Ugd2FudCB0byBjb25uZWN0IHRvIHRoZSBjdXJyZW50IGhvc3Qgd2l0aCBhIFdlYlNvY2tldCBjb25uZWN0aW9uIHlvdQogKiAgY2FuIHRlbGwgU3Ryb3BoZSB0byB1c2UgV2ViU29ja2V0cyB0aHJvdWdoIGEgInByb3RvY29sIiBhdHRyaWJ1dGUgaW4gdGhlCiAqICBvcHRpb25hbCBvcHRpb25zIHBhcmFtZXRlci4gVmFsaWQgdmFsdWVzIGFyZSAid3MiIGZvciBXZWJTb2NrZXQgYW5kICJ3c3MiCiAqICBmb3IgU2VjdXJlIFdlYlNvY2tldC4KICogIFNvIHRvIGNvbm5lY3QgdG8gIndzczovL0NVUlJFTlRfSE9TVE5BTUUveG1wcC13ZWJzb2NrZXQiIHlvdSB3b3VsZCBjYWxsCiAqCiAqICA+IHZhciBjb25uID0gbmV3IFN0cm9waGUuQ29ubmVjdGlvbigiL3htcHAtd2Vic29ja2V0LyIsIHtwcm90b2NvbDogIndzcyJ9KTsKICoKICogIE5vdGUgdGhhdCByZWxhdGl2ZSBVUkxzIF9OT1RfIHN0YXJ0aW5nIHdpdGggYSAiLyIgd2lsbCBhbHNvIGluY2x1ZGUgdGhlIHBhdGgKICogIG9mIHRoZSBjdXJyZW50IHNpdGUuCiAqCiAqICBBbHNvIGJlY2F1c2UgZG93bmdyYWRpbmcgc2VjdXJpdHkgaXMgbm90IHBlcm1pdHRlZCBieSBicm93c2Vycywgd2hlbiB1c2luZwogKiAgcmVsYXRpdmUgVVJMcyBib3RoIEJPU0ggYW5kIFdlYlNvY2tldCBjb25uZWN0aW9ucyB3aWxsIHVzZSB0aGVpciBzZWN1cmUKICogIHZhcmlhbnRzIGlmIHRoZSBjdXJyZW50IGNvbm5lY3Rpb24gdG8gdGhlIHNpdGUgaXMgYWxzbyBzZWN1cmUgKGh0dHBzKS4KICoKICogIEJPU0ggb3B0aW9uczoKICoKICogIGJ5IGFkZGluZyAic3luYyIgdG8gdGhlIG9wdGlvbnMsIHlvdSBjYW4gY29udHJvbCBpZiByZXF1ZXN0cyB3aWxsCiAqICBiZSBtYWRlIHN5bmNocm9ub3VzbHkgb3Igbm90LiBUaGUgZGVmYXVsdCBiZWhhdmlvdXIgaXMgYXN5bmNocm9ub3VzLgogKiAgSWYgeW91IHdhbnQgdG8gbWFrZSByZXF1ZXN0cyBzeW5jaHJvbm91cywgbWFrZSAic3luYyIgZXZhbHVhdGUgdG8gdHJ1ZToKICogID4gdmFyIGNvbm4gPSBuZXcgU3Ryb3BoZS5Db25uZWN0aW9uKCIvaHR0cC1iaW5kLyIsIHtzeW5jOiB0cnVlfSk7CiAqICBZb3UgY2FuIGFsc28gdG9nZ2xlIHRoaXMgb24gYW4gYWxyZWFkeSBlc3RhYmxpc2hlZCBjb25uZWN0aW9uOgogKiAgPiBjb25uLm9wdGlvbnMuc3luYyA9IHRydWU7CiAqCiAqCiAqICBQYXJhbWV0ZXJzOgogKiAgICAoU3RyaW5nKSBzZXJ2aWNlIC0gVGhlIEJPU0ggb3IgV2ViU29ja2V0IHNlcnZpY2UgVVJMLgogKiAgICAoT2JqZWN0KSBvcHRpb25zIC0gQSBoYXNoIG9mIGNvbmZpZ3VyYXRpb24gb3B0aW9ucwogKgogKiAgUmV0dXJuczoKICogICAgQSBuZXcgU3Ryb3BoZS5Db25uZWN0aW9uIG9iamVjdC4KICovClN0cm9waGUuQ29ubmVjdGlvbiA9IGZ1bmN0aW9uIChzZXJ2aWNlLCBvcHRpb25zKQp7CiAgICAvLyBUaGUgc2VydmljZSBVUkwKICAgIHRoaXMuc2VydmljZSA9IHNlcnZpY2U7CgogICAgLy8gQ29uZmlndXJhdGlvbiBvcHRpb25zCiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgdmFyIHByb3RvID0gdGhpcy5vcHRpb25zLnByb3RvY29sIHx8ICIiOwoKICAgIC8vIFNlbGVjdCBwcm90b2NhbCBiYXNlZCBvbiBzZXJ2aWNlIG9yIG9wdGlvbnMKICAgIGlmIChzZXJ2aWNlLmluZGV4T2YoIndzOiIpID09PSAwIHx8IHNlcnZpY2UuaW5kZXhPZigid3NzOiIpID09PSAwIHx8CiAgICAgICAgICAgIHByb3RvLmluZGV4T2YoIndzIikgPT09IDApIHsKICAgICAgICB0aGlzLl9wcm90byA9IG5ldyBTdHJvcGhlLldlYnNvY2tldCh0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fcHJvdG8gPSBuZXcgU3Ryb3BoZS5Cb3NoKHRoaXMpOwogICAgfQogICAgLyogVGhlIGNvbm5lY3RlZCBKSUQuICovCiAgICB0aGlzLmppZCA9ICIiOwogICAgLyogdGhlIEpJRHMgZG9tYWluICovCiAgICB0aGlzLmRvbWFpbiA9IG51bGw7CiAgICAvKiBzdHJlYW06ZmVhdHVyZXMgKi8KICAgIHRoaXMuZmVhdHVyZXMgPSBudWxsOwoKICAgIC8vIFNBU0wKICAgIHRoaXMuX3Nhc2xfZGF0YSA9IHt9OwogICAgdGhpcy5kb19zZXNzaW9uID0gZmFsc2U7CiAgICB0aGlzLmRvX2JpbmQgPSBmYWxzZTsKCiAgICAvLyBoYW5kbGVyIGxpc3RzCiAgICB0aGlzLnRpbWVkSGFuZGxlcnMgPSBbXTsKICAgIHRoaXMuaGFuZGxlcnMgPSBbXTsKICAgIHRoaXMucmVtb3ZlVGltZWRzID0gW107CiAgICB0aGlzLnJlbW92ZUhhbmRsZXJzID0gW107CiAgICB0aGlzLmFkZFRpbWVkcyA9IFtdOwogICAgdGhpcy5hZGRIYW5kbGVycyA9IFtdOwoKICAgIHRoaXMuX2F1dGhlbnRpY2F0aW9uID0ge307CiAgICB0aGlzLl9pZGxlVGltZW91dCA9IG51bGw7CiAgICB0aGlzLl9kaXNjb25uZWN0VGltZW91dCA9IG51bGw7CgogICAgdGhpcy5kb19hdXRoZW50aWNhdGlvbiA9IHRydWU7CiAgICB0aGlzLmF1dGhlbnRpY2F0ZWQgPSBmYWxzZTsKICAgIHRoaXMuZGlzY29ubmVjdGluZyA9IGZhbHNlOwogICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTsKCiAgICB0aGlzLmVycm9ycyA9IDA7CgogICAgdGhpcy5wYXVzZWQgPSBmYWxzZTsKCiAgICB0aGlzLl9kYXRhID0gW107CiAgICB0aGlzLl91bmlxdWVJZCA9IDA7CgogICAgdGhpcy5fc2FzbF9zdWNjZXNzX2hhbmRsZXIgPSBudWxsOwogICAgdGhpcy5fc2FzbF9mYWlsdXJlX2hhbmRsZXIgPSBudWxsOwogICAgdGhpcy5fc2FzbF9jaGFsbGVuZ2VfaGFuZGxlciA9IG51bGw7CgogICAgLy8gTWF4IHJldHJpZXMgYmVmb3JlIGRpc2Nvbm5lY3RpbmcKICAgIHRoaXMubWF4UmV0cmllcyA9IDU7CgogICAgLy8gc2V0dXAgb25JZGxlIGNhbGxiYWNrIGV2ZXJ5IDEvMTB0aCBvZiBhIHNlY29uZAogICAgdGhpcy5faWRsZVRpbWVvdXQgPSBzZXRUaW1lb3V0KHRoaXMuX29uSWRsZS5iaW5kKHRoaXMpLCAxMDApOwoKICAgIC8vIGluaXRpYWxpemUgcGx1Z2lucwogICAgZm9yICh2YXIgayBpbiBTdHJvcGhlLl9jb25uZWN0aW9uUGx1Z2lucykgewogICAgICAgIGlmIChTdHJvcGhlLl9jb25uZWN0aW9uUGx1Z2lucy5oYXNPd25Qcm9wZXJ0eShrKSkgewogICAgICAgICAgICB2YXIgcHR5cGUgPSBTdHJvcGhlLl9jb25uZWN0aW9uUGx1Z2luc1trXTsKICAgICAgICAgICAgLy8ganNsaW50IGNvbXBsYWludHMgYWJvdXQgdGhlIGJlbG93IGxpbmUsIGJ1dCB0aGlzIGlzIGZpbmUKICAgICAgICAgICAgdmFyIEYgPSBmdW5jdGlvbiAoKSB7fTsgLy8ganNoaW50IGlnbm9yZTpsaW5lCiAgICAgICAgICAgIEYucHJvdG90eXBlID0gcHR5cGU7CiAgICAgICAgICAgIHRoaXNba10gPSBuZXcgRigpOwogICAgICAgICAgICB0aGlzW2tdLmluaXQodGhpcyk7CiAgICAgICAgfQogICAgfQp9OwoKU3Ryb3BoZS5Db25uZWN0aW9uLnByb3RvdHlwZSA9IHsKICAgIC8qKiBGdW5jdGlvbjogcmVzZXQKICAgICAqICBSZXNldCB0aGUgY29ubmVjdGlvbi4KICAgICAqCiAgICAgKiAgVGhpcyBmdW5jdGlvbiBzaG91bGQgYmUgY2FsbGVkIGFmdGVyIGEgY29ubmVjdGlvbiBpcyBkaXNjb25uZWN0ZWQKICAgICAqICBiZWZvcmUgdGhhdCBjb25uZWN0aW9uIGlzIHJldXNlZC4KICAgICAqLwogICAgcmVzZXQ6IGZ1bmN0aW9uICgpCiAgICB7CiAgICAgICAgdGhpcy5fcHJvdG8uX3Jlc2V0KCk7CgogICAgICAgIC8vIFNBU0wKICAgICAgICB0aGlzLmRvX3Nlc3Npb24gPSBmYWxzZTsKICAgICAgICB0aGlzLmRvX2JpbmQgPSBmYWxzZTsKCiAgICAgICAgLy8gaGFuZGxlciBsaXN0cwogICAgICAgIHRoaXMudGltZWRIYW5kbGVycyA9IFtdOwogICAgICAgIHRoaXMuaGFuZGxlcnMgPSBbXTsKICAgICAgICB0aGlzLnJlbW92ZVRpbWVkcyA9IFtdOwogICAgICAgIHRoaXMucmVtb3ZlSGFuZGxlcnMgPSBbXTsKICAgICAgICB0aGlzLmFkZFRpbWVkcyA9IFtdOwogICAgICAgIHRoaXMuYWRkSGFuZGxlcnMgPSBbXTsKICAgICAgICB0aGlzLl9hdXRoZW50aWNhdGlvbiA9IHt9OwoKICAgICAgICB0aGlzLmF1dGhlbnRpY2F0ZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLmRpc2Nvbm5lY3RpbmcgPSBmYWxzZTsKICAgICAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlOwoKICAgICAgICB0aGlzLmVycm9ycyA9IDA7CgogICAgICAgIHRoaXMuX3JlcXVlc3RzID0gW107CiAgICAgICAgdGhpcy5fdW5pcXVlSWQgPSAwOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IHBhdXNlCiAgICAgKiAgUGF1c2UgdGhlIHJlcXVlc3QgbWFuYWdlci4KICAgICAqCiAgICAgKiAgVGhpcyB3aWxsIHByZXZlbnQgU3Ryb3BoZSBmcm9tIHNlbmRpbmcgYW55IG1vcmUgcmVxdWVzdHMgdG8gdGhlCiAgICAgKiAgc2VydmVyLiAgVGhpcyBpcyB2ZXJ5IHVzZWZ1bCBmb3IgdGVtcG9yYXJpbHkgcGF1c2luZwogICAgICogIEJPU0gtQ29ubmVjdGlvbnMgd2hpbGUgYSBsb3Qgb2Ygc2VuZCgpIGNhbGxzIGFyZSBoYXBwZW5pbmcgcXVpY2tseS4KICAgICAqICBUaGlzIGNhdXNlcyBTdHJvcGhlIHRvIHNlbmQgdGhlIGRhdGEgaW4gYSBzaW5nbGUgcmVxdWVzdCwgc2F2aW5nCiAgICAgKiAgbWFueSByZXF1ZXN0IHRyaXBzLgogICAgICovCiAgICBwYXVzZTogZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICB0aGlzLnBhdXNlZCA9IHRydWU7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogcmVzdW1lCiAgICAgKiAgUmVzdW1lIHRoZSByZXF1ZXN0IG1hbmFnZXIuCiAgICAgKgogICAgICogIFRoaXMgcmVzdW1lcyBhZnRlciBwYXVzZSgpIGhhcyBiZWVuIGNhbGxlZC4KICAgICAqLwogICAgcmVzdW1lOiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIHRoaXMucGF1c2VkID0gZmFsc2U7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogZ2V0VW5pcXVlSWQKICAgICAqICBHZW5lcmF0ZSBhIHVuaXF1ZSBJRCBmb3IgdXNlIGluIDxpcS8+IGVsZW1lbnRzLgogICAgICoKICAgICAqICBBbGwgPGlxLz4gc3RhbnphcyBhcmUgcmVxdWlyZWQgdG8gaGF2ZSB1bmlxdWUgaWQgYXR0cmlidXRlcy4gIFRoaXMKICAgICAqICBmdW5jdGlvbiBtYWtlcyBjcmVhdGluZyB0aGVzZSBlYXN5LiAgRWFjaCBjb25uZWN0aW9uIGluc3RhbmNlIGhhcwogICAgICogIGEgY291bnRlciB3aGljaCBzdGFydHMgZnJvbSB6ZXJvLCBhbmQgdGhlIHZhbHVlIG9mIHRoaXMgY291bnRlcgogICAgICogIHBsdXMgYSBjb2xvbiBmb2xsb3dlZCBieSB0aGUgc3VmZml4IGJlY29tZXMgdGhlIHVuaXF1ZSBpZC4gSWYgbm8KICAgICAqICBzdWZmaXggaXMgc3VwcGxpZWQsIHRoZSBjb3VudGVyIGlzIHVzZWQgYXMgdGhlIHVuaXF1ZSBpZC4KICAgICAqCiAgICAgKiAgU3VmZml4ZXMgYXJlIHVzZWQgdG8gbWFrZSBkZWJ1Z2dpbmcgZWFzaWVyIHdoZW4gcmVhZGluZyB0aGUgc3RyZWFtCiAgICAgKiAgZGF0YSwgYW5kIHRoZWlyIHVzZSBpcyByZWNvbW1lbmRlZC4gIFRoZSBjb3VudGVyIHJlc2V0cyB0byAwIGZvcgogICAgICogIGV2ZXJ5IG5ldyBjb25uZWN0aW9uIGZvciB0aGUgc2FtZSByZWFzb24uICBGb3IgY29ubmVjdGlvbnMgdG8gdGhlCiAgICAgKiAgc2FtZSBzZXJ2ZXIgdGhhdCBhdXRoZW50aWNhdGUgdGhlIHNhbWUgd2F5LCBhbGwgdGhlIGlkcyBzaG91bGQgYmUKICAgICAqICB0aGUgc2FtZSwgd2hpY2ggbWFrZXMgaXQgZWFzeSB0byBzZWUgY2hhbmdlcy4gIFRoaXMgaXMgdXNlZnVsIGZvcgogICAgICogIGF1dG9tYXRlZCB0ZXN0aW5nIGFzIHdlbGwuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoU3RyaW5nKSBzdWZmaXggLSBBIG9wdGlvbmFsIHN1ZmZpeCB0byBhcHBlbmQgdG8gdGhlIGlkLgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgQSB1bmlxdWUgc3RyaW5nIHRvIGJlIHVzZWQgZm9yIHRoZSBpZCBhdHRyaWJ1dGUuCiAgICAgKi8KICAgIGdldFVuaXF1ZUlkOiBmdW5jdGlvbiAoc3VmZml4KQogICAgewogICAgICAgIGlmICh0eXBlb2Yoc3VmZml4KSA9PSAic3RyaW5nIiB8fCB0eXBlb2Yoc3VmZml4KSA9PSAibnVtYmVyIikgewogICAgICAgICAgICByZXR1cm4gKyt0aGlzLl91bmlxdWVJZCArICI6IiArIHN1ZmZpeDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gKyt0aGlzLl91bmlxdWVJZCArICIiOwogICAgICAgIH0KICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiBjb25uZWN0CiAgICAgKiAgU3RhcnRzIHRoZSBjb25uZWN0aW9uIHByb2Nlc3MuCiAgICAgKgogICAgICogIEFzIHRoZSBjb25uZWN0aW9uIHByb2Nlc3MgcHJvY2VlZHMsIHRoZSB1c2VyIHN1cHBsaWVkIGNhbGxiYWNrIHdpbGwKICAgICAqICBiZSB0cmlnZ2VyZWQgbXVsdGlwbGUgdGltZXMgd2l0aCBzdGF0dXMgdXBkYXRlcy4gIFRoZSBjYWxsYmFjawogICAgICogIHNob3VsZCB0YWtlIHR3byBhcmd1bWVudHMgLSB0aGUgc3RhdHVzIGNvZGUgYW5kIHRoZSBlcnJvciBjb25kaXRpb24uCiAgICAgKgogICAgICogIFRoZSBzdGF0dXMgY29kZSB3aWxsIGJlIG9uZSBvZiB0aGUgdmFsdWVzIGluIHRoZSBTdHJvcGhlLlN0YXR1cwogICAgICogIGNvbnN0YW50cy4gIFRoZSBlcnJvciBjb25kaXRpb24gd2lsbCBiZSBvbmUgb2YgdGhlIGNvbmRpdGlvbnMKICAgICAqICBkZWZpbmVkIGluIFJGQyAzOTIwIG9yIHRoZSBjb25kaXRpb24gJ3N0cm9waGUtcGFyc2VyZXJyb3InLgogICAgICoKICAgICAqICBUaGUgUGFyYW1ldGVycyBfd2FpdF8sIF9ob2xkXyBhbmQgX3JvdXRlXyBhcmUgb3B0aW9uYWwgYW5kIG9ubHkgcmVsZXZhbnQKICAgICAqICBmb3IgQk9TSCBjb25uZWN0aW9ucy4gUGxlYXNlIHNlZSBYRVAgMTI0IGZvciBhIG1vcmUgZGV0YWlsZWQgZXhwbGFuYXRpb24KICAgICAqICBvZiB0aGUgb3B0aW9uYWwgcGFyYW1ldGVycy4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJpbmcpIGppZCAtIFRoZSB1c2VyJ3MgSklELiAgVGhpcyBtYXkgYmUgYSBiYXJlIEpJRCwKICAgICAqICAgICAgb3IgYSBmdWxsIEpJRC4gIElmIGEgbm9kZSBpcyBub3Qgc3VwcGxpZWQsIFNBU0wgQU5PTllNT1VTCiAgICAgKiAgICAgIGF1dGhlbnRpY2F0aW9uIHdpbGwgYmUgYXR0ZW1wdGVkLgogICAgICogICAgKFN0cmluZykgcGFzcyAtIFRoZSB1c2VyJ3MgcGFzc3dvcmQuCiAgICAgKiAgICAoRnVuY3Rpb24pIGNhbGxiYWNrIC0gVGhlIGNvbm5lY3QgY2FsbGJhY2sgZnVuY3Rpb24uCiAgICAgKiAgICAoSW50ZWdlcikgd2FpdCAtIFRoZSBvcHRpb25hbCBIVFRQQklORCB3YWl0IHZhbHVlLiAgVGhpcyBpcyB0aGUKICAgICAqICAgICAgdGltZSB0aGUgc2VydmVyIHdpbGwgd2FpdCBiZWZvcmUgcmV0dXJuaW5nIGFuIGVtcHR5IHJlc3VsdCBmb3IKICAgICAqICAgICAgYSByZXF1ZXN0LiAgVGhlIGRlZmF1bHQgc2V0dGluZyBvZiA2MCBzZWNvbmRzIGlzIHJlY29tbWVuZGVkLgogICAgICogICAgKEludGVnZXIpIGhvbGQgLSBUaGUgb3B0aW9uYWwgSFRUUEJJTkQgaG9sZCB2YWx1ZS4gIFRoaXMgaXMgdGhlCiAgICAgKiAgICAgIG51bWJlciBvZiBjb25uZWN0aW9ucyB0aGUgc2VydmVyIHdpbGwgaG9sZCBhdCBvbmUgdGltZS4gIFRoaXMKICAgICAqICAgICAgc2hvdWxkIGFsbW9zdCBhbHdheXMgYmUgc2V0IHRvIDEgKHRoZSBkZWZhdWx0KS4KICAgICAqICAgIChTdHJpbmcpIHJvdXRlIC0gVGhlIG9wdGlvbmFsIHJvdXRlIHZhbHVlLgogICAgICovCiAgICBjb25uZWN0OiBmdW5jdGlvbiAoamlkLCBwYXNzLCBjYWxsYmFjaywgd2FpdCwgaG9sZCwgcm91dGUpCiAgICB7CiAgICAgICAgdGhpcy5qaWQgPSBqaWQ7CiAgICAgICAgLyoqIFZhcmlhYmxlOiBhdXRoemlkCiAgICAgICAgICogIEF1dGhvcml6YXRpb24gaWRlbnRpdHkuCiAgICAgICAgICovCiAgICAgICAgdGhpcy5hdXRoemlkID0gU3Ryb3BoZS5nZXRCYXJlSmlkRnJvbUppZCh0aGlzLmppZCk7CiAgICAgICAgLyoqIFZhcmlhYmxlOiBhdXRoY2lkCiAgICAgICAgICogIEF1dGhlbnRpY2F0aW9uIGlkZW50aXR5IChVc2VyIG5hbWUpLgogICAgICAgICAqLwogICAgICAgIHRoaXMuYXV0aGNpZCA9IFN0cm9waGUuZ2V0Tm9kZUZyb21KaWQodGhpcy5qaWQpOwogICAgICAgIC8qKiBWYXJpYWJsZTogcGFzcwogICAgICAgICAqICBBdXRoZW50aWNhdGlvbiBpZGVudGl0eSAoVXNlciBwYXNzd29yZCkuCiAgICAgICAgICovCiAgICAgICAgdGhpcy5wYXNzID0gcGFzczsKICAgICAgICAvKiogVmFyaWFibGU6IHNlcnZ0eXBlCiAgICAgICAgICogIERpZ2VzdCBNRDUgY29tcGF0aWJpbGl0eS4KICAgICAgICAgKi8KICAgICAgICB0aGlzLnNlcnZ0eXBlID0gInhtcHAiOwogICAgICAgIHRoaXMuY29ubmVjdF9jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgIHRoaXMuZGlzY29ubmVjdGluZyA9IGZhbHNlOwogICAgICAgIHRoaXMuY29ubmVjdGVkID0gZmFsc2U7CiAgICAgICAgdGhpcy5hdXRoZW50aWNhdGVkID0gZmFsc2U7CiAgICAgICAgdGhpcy5lcnJvcnMgPSAwOwoKICAgICAgICAvLyBwYXJzZSBqaWQgZm9yIGRvbWFpbgogICAgICAgIHRoaXMuZG9tYWluID0gU3Ryb3BoZS5nZXREb21haW5Gcm9tSmlkKHRoaXMuamlkKTsKCiAgICAgICAgdGhpcy5fY2hhbmdlQ29ubmVjdFN0YXR1cyhTdHJvcGhlLlN0YXR1cy5DT05ORUNUSU5HLCBudWxsKTsKCiAgICAgICAgdGhpcy5fcHJvdG8uX2Nvbm5lY3Qod2FpdCwgaG9sZCwgcm91dGUpOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IGF0dGFjaAogICAgICogIEF0dGFjaCB0byBhbiBhbHJlYWR5IGNyZWF0ZWQgYW5kIGF1dGhlbnRpY2F0ZWQgQk9TSCBzZXNzaW9uLgogICAgICoKICAgICAqICBUaGlzIGZ1bmN0aW9uIGlzIHByb3ZpZGVkIHRvIGFsbG93IFN0cm9waGUgdG8gYXR0YWNoIHRvIEJPU0gKICAgICAqICBzZXNzaW9ucyB3aGljaCBoYXZlIGJlZW4gY3JlYXRlZCBleHRlcm5hbGx5LCBwZXJoYXBzIGJ5IGEgV2ViCiAgICAgKiAgYXBwbGljYXRpb24uICBUaGlzIGlzIG9mdGVuIHVzZWQgdG8gc3VwcG9ydCBhdXRvLWxvZ2luIHR5cGUgZmVhdHVyZXMKICAgICAqICB3aXRob3V0IHB1dHRpbmcgdXNlciBjcmVkZW50aWFscyBpbnRvIHRoZSBwYWdlLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cmluZykgamlkIC0gVGhlIGZ1bGwgSklEIHRoYXQgaXMgYm91bmQgYnkgdGhlIHNlc3Npb24uCiAgICAgKiAgICAoU3RyaW5nKSBzaWQgLSBUaGUgU0lEIG9mIHRoZSBCT1NIIHNlc3Npb24uCiAgICAgKiAgICAoU3RyaW5nKSByaWQgLSBUaGUgY3VycmVudCBSSUQgb2YgdGhlIEJPU0ggc2Vzc2lvbi4gIFRoaXMgUklECiAgICAgKiAgICAgIHdpbGwgYmUgdXNlZCBieSB0aGUgbmV4dCByZXF1ZXN0LgogICAgICogICAgKEZ1bmN0aW9uKSBjYWxsYmFjayBUaGUgY29ubmVjdCBjYWxsYmFjayBmdW5jdGlvbi4KICAgICAqICAgIChJbnRlZ2VyKSB3YWl0IC0gVGhlIG9wdGlvbmFsIEhUVFBCSU5EIHdhaXQgdmFsdWUuICBUaGlzIGlzIHRoZQogICAgICogICAgICB0aW1lIHRoZSBzZXJ2ZXIgd2lsbCB3YWl0IGJlZm9yZSByZXR1cm5pbmcgYW4gZW1wdHkgcmVzdWx0IGZvcgogICAgICogICAgICBhIHJlcXVlc3QuICBUaGUgZGVmYXVsdCBzZXR0aW5nIG9mIDYwIHNlY29uZHMgaXMgcmVjb21tZW5kZWQuCiAgICAgKiAgICAgIE90aGVyIHNldHRpbmdzIHdpbGwgcmVxdWlyZSB0d2Vha3MgdG8gdGhlIFN0cm9waGUuVElNRU9VVCB2YWx1ZS4KICAgICAqICAgIChJbnRlZ2VyKSBob2xkIC0gVGhlIG9wdGlvbmFsIEhUVFBCSU5EIGhvbGQgdmFsdWUuICBUaGlzIGlzIHRoZQogICAgICogICAgICBudW1iZXIgb2YgY29ubmVjdGlvbnMgdGhlIHNlcnZlciB3aWxsIGhvbGQgYXQgb25lIHRpbWUuICBUaGlzCiAgICAgKiAgICAgIHNob3VsZCBhbG1vc3QgYWx3YXlzIGJlIHNldCB0byAxICh0aGUgZGVmYXVsdCkuCiAgICAgKiAgICAoSW50ZWdlcikgd2luZCAtIFRoZSBvcHRpb25hbCBIVFRCSU5EIHdpbmRvdyB2YWx1ZS4gIFRoaXMgaXMgdGhlCiAgICAgKiAgICAgIGFsbG93ZWQgcmFuZ2Ugb2YgcmVxdWVzdCBpZHMgdGhhdCBhcmUgdmFsaWQuICBUaGUgZGVmYXVsdCBpcyA1LgogICAgICovCiAgICBhdHRhY2g6IGZ1bmN0aW9uIChqaWQsIHNpZCwgcmlkLCBjYWxsYmFjaywgd2FpdCwgaG9sZCwgd2luZCkKICAgIHsKICAgICAgICB0aGlzLl9wcm90by5fYXR0YWNoKGppZCwgc2lkLCByaWQsIGNhbGxiYWNrLCB3YWl0LCBob2xkLCB3aW5kKTsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiB4bWxJbnB1dAogICAgICogIFVzZXIgb3ZlcnJpZGVhYmxlIGZ1bmN0aW9uIHRoYXQgcmVjZWl2ZXMgWE1MIGRhdGEgY29taW5nIGludG8gdGhlCiAgICAgKiAgY29ubmVjdGlvbi4KICAgICAqCiAgICAgKiAgVGhlIGRlZmF1bHQgZnVuY3Rpb24gZG9lcyBub3RoaW5nLiAgVXNlciBjb2RlIGNhbiBvdmVycmlkZSB0aGlzIHdpdGgKICAgICAqICA+IFN0cm9waGUuQ29ubmVjdGlvbi54bWxJbnB1dCA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgKiAgPiAgICh1c2VyIGNvZGUpCiAgICAgKiAgPiB9OwogICAgICoKICAgICAqICBEdWUgdG8gbGltaXRhdGlvbnMgb2YgY3VycmVudCBCcm93c2VycycgWE1MLVBhcnNlcnMgdGhlIG9wZW5pbmcgYW5kIGNsb3NpbmcKICAgICAqICA8c3RyZWFtPiB0YWcgZm9yIFdlYlNvY2tldC1Db25ub2N0aW9ucyB3aWxsIGJlIHBhc3NlZCBhcyBzZWxmY2xvc2luZyBoZXJlLgogICAgICoKICAgICAqICBCT1NILUNvbm5lY3Rpb25zIHdpbGwgaGF2ZSBhbGwgc3RhbnphcyB3cmFwcGVkIGluIGEgPGJvZHk+IHRhZy4gU2VlCiAgICAgKiAgPFN0cm9waGUuQm9zaC5zdHJpcD4gaWYgeW91IHdhbnQgdG8gc3RyaXAgdGhpcyB0YWcuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoWE1MRWxlbWVudCkgZWxlbSAtIFRoZSBYTUwgZGF0YSByZWNlaXZlZCBieSB0aGUgY29ubmVjdGlvbi4KICAgICAqLwogICAgLyoganNoaW50IHVudXNlZDpmYWxzZSAqLwogICAgeG1sSW5wdXQ6IGZ1bmN0aW9uIChlbGVtKQogICAgewogICAgICAgIHJldHVybjsKICAgIH0sCiAgICAvKiBqc2hpbnQgdW51c2VkOnRydWUgKi8KCiAgICAvKiogRnVuY3Rpb246IHhtbE91dHB1dAogICAgICogIFVzZXIgb3ZlcnJpZGVhYmxlIGZ1bmN0aW9uIHRoYXQgcmVjZWl2ZXMgWE1MIGRhdGEgc2VudCB0byB0aGUKICAgICAqICBjb25uZWN0aW9uLgogICAgICoKICAgICAqICBUaGUgZGVmYXVsdCBmdW5jdGlvbiBkb2VzIG5vdGhpbmcuICBVc2VyIGNvZGUgY2FuIG92ZXJyaWRlIHRoaXMgd2l0aAogICAgICogID4gU3Ryb3BoZS5Db25uZWN0aW9uLnhtbE91dHB1dCA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgKiAgPiAgICh1c2VyIGNvZGUpCiAgICAgKiAgPiB9OwogICAgICoKICAgICAqICBEdWUgdG8gbGltaXRhdGlvbnMgb2YgY3VycmVudCBCcm93c2VycycgWE1MLVBhcnNlcnMgdGhlIG9wZW5pbmcgYW5kIGNsb3NpbmcKICAgICAqICA8c3RyZWFtPiB0YWcgZm9yIFdlYlNvY2tldC1Db25ub2N0aW9ucyB3aWxsIGJlIHBhc3NlZCBhcyBzZWxmY2xvc2luZyBoZXJlLgogICAgICoKICAgICAqICBCT1NILUNvbm5lY3Rpb25zIHdpbGwgaGF2ZSBhbGwgc3RhbnphcyB3cmFwcGVkIGluIGEgPGJvZHk+IHRhZy4gU2VlCiAgICAgKiAgPFN0cm9waGUuQm9zaC5zdHJpcD4gaWYgeW91IHdhbnQgdG8gc3RyaXAgdGhpcyB0YWcuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoWE1MRWxlbWVudCkgZWxlbSAtIFRoZSBYTUxkYXRhIHNlbnQgYnkgdGhlIGNvbm5lY3Rpb24uCiAgICAgKi8KICAgIC8qIGpzaGludCB1bnVzZWQ6ZmFsc2UgKi8KICAgIHhtbE91dHB1dDogZnVuY3Rpb24gKGVsZW0pCiAgICB7CiAgICAgICAgcmV0dXJuOwogICAgfSwKICAgIC8qIGpzaGludCB1bnVzZWQ6dHJ1ZSAqLwoKICAgIC8qKiBGdW5jdGlvbjogcmF3SW5wdXQKICAgICAqICBVc2VyIG92ZXJyaWRlYWJsZSBmdW5jdGlvbiB0aGF0IHJlY2VpdmVzIHJhdyBkYXRhIGNvbWluZyBpbnRvIHRoZQogICAgICogIGNvbm5lY3Rpb24uCiAgICAgKgogICAgICogIFRoZSBkZWZhdWx0IGZ1bmN0aW9uIGRvZXMgbm90aGluZy4gIFVzZXIgY29kZSBjYW4gb3ZlcnJpZGUgdGhpcyB3aXRoCiAgICAgKiAgPiBTdHJvcGhlLkNvbm5lY3Rpb24ucmF3SW5wdXQgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICogID4gICAodXNlciBjb2RlKQogICAgICogID4gfTsKICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJpbmcpIGRhdGEgLSBUaGUgZGF0YSByZWNlaXZlZCBieSB0aGUgY29ubmVjdGlvbi4KICAgICAqLwogICAgLyoganNoaW50IHVudXNlZDpmYWxzZSAqLwogICAgcmF3SW5wdXQ6IGZ1bmN0aW9uIChkYXRhKQogICAgewogICAgICAgIHJldHVybjsKICAgIH0sCiAgICAvKiBqc2hpbnQgdW51c2VkOnRydWUgKi8KCiAgICAvKiogRnVuY3Rpb246IHJhd091dHB1dAogICAgICogIFVzZXIgb3ZlcnJpZGVhYmxlIGZ1bmN0aW9uIHRoYXQgcmVjZWl2ZXMgcmF3IGRhdGEgc2VudCB0byB0aGUKICAgICAqICBjb25uZWN0aW9uLgogICAgICoKICAgICAqICBUaGUgZGVmYXVsdCBmdW5jdGlvbiBkb2VzIG5vdGhpbmcuICBVc2VyIGNvZGUgY2FuIG92ZXJyaWRlIHRoaXMgd2l0aAogICAgICogID4gU3Ryb3BoZS5Db25uZWN0aW9uLnJhd091dHB1dCA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgKiAgPiAgICh1c2VyIGNvZGUpCiAgICAgKiAgPiB9OwogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cmluZykgZGF0YSAtIFRoZSBkYXRhIHNlbnQgYnkgdGhlIGNvbm5lY3Rpb24uCiAgICAgKi8KICAgIC8qIGpzaGludCB1bnVzZWQ6ZmFsc2UgKi8KICAgIHJhd091dHB1dDogZnVuY3Rpb24gKGRhdGEpCiAgICB7CiAgICAgICAgcmV0dXJuOwogICAgfSwKICAgIC8qIGpzaGludCB1bnVzZWQ6dHJ1ZSAqLwoKICAgIC8qKiBGdW5jdGlvbjogc2VuZAogICAgICogIFNlbmQgYSBzdGFuemEuCiAgICAgKgogICAgICogIFRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIHRvIHB1c2ggZGF0YSBvbnRvIHRoZSBzZW5kIHF1ZXVlIHRvCiAgICAgKiAgZ28gb3V0IG92ZXIgdGhlIHdpcmUuICBXaGVuZXZlciBhIHJlcXVlc3QgaXMgc2VudCB0byB0aGUgQk9TSAogICAgICogIHNlcnZlciwgYWxsIHBlbmRpbmcgZGF0YSBpcyBzZW50IGFuZCB0aGUgcXVldWUgaXMgZmx1c2hlZC4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChYTUxFbGVtZW50IHwKICAgICAqICAgICBbWE1MRWxlbWVudF0gfAogICAgICogICAgIFN0cm9waGUuQnVpbGRlcikgZWxlbSAtIFRoZSBzdGFuemEgdG8gc2VuZC4KICAgICAqLwogICAgc2VuZDogZnVuY3Rpb24gKGVsZW0pCiAgICB7CiAgICAgICAgaWYgKGVsZW0gPT09IG51bGwpIHsgcmV0dXJuIDsgfQogICAgICAgIGlmICh0eXBlb2YoZWxlbS5zb3J0KSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGVsZW0ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHRoaXMuX3F1ZXVlRGF0YShlbGVtW2ldKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mKGVsZW0udHJlZSkgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdGhpcy5fcXVldWVEYXRhKGVsZW0udHJlZSgpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl9xdWV1ZURhdGEoZWxlbSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9wcm90by5fc2VuZCgpOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IGZsdXNoCiAgICAgKiAgSW1tZWRpYXRlbHkgc2VuZCBhbnkgcGVuZGluZyBvdXRnb2luZyBkYXRhLgogICAgICoKICAgICAqICBOb3JtYWxseSBzZW5kKCkgcXVldWVzIG91dGdvaW5nIGRhdGEgdW50aWwgdGhlIG5leHQgaWRsZSBwZXJpb2QKICAgICAqICAoMTAwbXMpLCB3aGljaCBvcHRpbWl6ZXMgbmV0d29yayB1c2UgaW4gdGhlIGNvbW1vbiBjYXNlcyB3aGVuCiAgICAgKiAgc2V2ZXJhbCBzZW5kKClzIGFyZSBjYWxsZWQgaW4gc3VjY2Vzc2lvbi4gZmx1c2goKSBjYW4gYmUgdXNlZCB0bwogICAgICogIGltbWVkaWF0ZWx5IHNlbmQgYWxsIHBlbmRpbmcgZGF0YS4KICAgICAqLwogICAgZmx1c2g6IGZ1bmN0aW9uICgpCiAgICB7CiAgICAgICAgLy8gY2FuY2VsIHRoZSBwZW5kaW5nIGlkbGUgcGVyaW9kIGFuZCBydW4gdGhlIGlkbGUgZnVuY3Rpb24KICAgICAgICAvLyBpbW1lZGlhdGVseQogICAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9pZGxlVGltZW91dCk7CiAgICAgICAgdGhpcy5fb25JZGxlKCk7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogc2VuZElRCiAgICAgKiAgSGVscGVyIGZ1bmN0aW9uIHRvIHNlbmQgSVEgc3Rhbnphcy4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChYTUxFbGVtZW50KSBlbGVtIC0gVGhlIHN0YW56YSB0byBzZW5kLgogICAgICogICAgKEZ1bmN0aW9uKSBjYWxsYmFjayAtIFRoZSBjYWxsYmFjayBmdW5jdGlvbiBmb3IgYSBzdWNjZXNzZnVsIHJlcXVlc3QuCiAgICAgKiAgICAoRnVuY3Rpb24pIGVycmJhY2sgLSBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gZm9yIGEgZmFpbGVkIG9yIHRpbWVkCiAgICAgKiAgICAgIG91dCByZXF1ZXN0LiAgT24gdGltZW91dCwgdGhlIHN0YW56YSB3aWxsIGJlIG51bGwuCiAgICAgKiAgICAoSW50ZWdlcikgdGltZW91dCAtIFRoZSB0aW1lIHNwZWNpZmllZCBpbiBtaWxsaXNlY29uZHMgZm9yIGEKICAgICAqICAgICAgdGltZW91dCB0byBvY2N1ci4KICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgIFRoZSBpZCB1c2VkIHRvIHNlbmQgdGhlIElRLgogICAgKi8KICAgIHNlbmRJUTogZnVuY3Rpb24oZWxlbSwgY2FsbGJhY2ssIGVycmJhY2ssIHRpbWVvdXQpIHsKICAgICAgICB2YXIgdGltZW91dEhhbmRsZXIgPSBudWxsOwogICAgICAgIHZhciB0aGF0ID0gdGhpczsKCiAgICAgICAgaWYgKHR5cGVvZihlbGVtLnRyZWUpID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGVsZW0gPSBlbGVtLnRyZWUoKTsKICAgICAgICB9CiAgICAgICAgdmFyIGlkID0gZWxlbS5nZXRBdHRyaWJ1dGUoJ2lkJyk7CgogICAgICAgIC8vIGluamVjdCBpZCBpZiBub3QgZm91bmQKICAgICAgICBpZiAoIWlkKSB7CiAgICAgICAgICAgIGlkID0gdGhpcy5nZXRVbmlxdWVJZCgic2VuZElRIik7CiAgICAgICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKCJpZCIsIGlkKTsKICAgICAgICB9CgogICAgICAgIHZhciBoYW5kbGVyID0gdGhpcy5hZGRIYW5kbGVyKGZ1bmN0aW9uIChzdGFuemEpIHsKICAgICAgICAgICAgLy8gcmVtb3ZlIHRpbWVvdXQgaGFuZGxlciBpZiB0aGVyZSBpcyBvbmUKICAgICAgICAgICAgaWYgKHRpbWVvdXRIYW5kbGVyKSB7CiAgICAgICAgICAgICAgICB0aGF0LmRlbGV0ZVRpbWVkSGFuZGxlcih0aW1lb3V0SGFuZGxlcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBpcXR5cGUgPSBzdGFuemEuZ2V0QXR0cmlidXRlKCd0eXBlJyk7CiAgICAgICAgICAgIGlmIChpcXR5cGUgPT0gJ3Jlc3VsdCcpIHsKICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHN0YW56YSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXF0eXBlID09ICdlcnJvcicpIHsKICAgICAgICAgICAgICAgIGlmIChlcnJiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyYmFjayhzdGFuemEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgewogICAgICAgICAgICAgICAgICAgIG5hbWU6ICJTdHJvcGhlRXJyb3IiLAogICAgICAgICAgICBtZXNzYWdlOiAiR290IGJhZCBJUSB0eXBlIG9mICIgKyBpcXR5cGUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICB9LCBudWxsLCAnaXEnLCBudWxsLCBpZCk7CgogICAgICAgIC8vIGlmIHRpbWVvdXQgc3BlY2lmaWVkLCBzZXR1cCB0aW1lb3V0IGhhbmRsZXIuCiAgICAgICAgaWYgKHRpbWVvdXQpIHsKICAgICAgICAgICAgdGltZW91dEhhbmRsZXIgPSB0aGlzLmFkZFRpbWVkSGFuZGxlcih0aW1lb3V0LCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAvLyBnZXQgcmlkIG9mIG5vcm1hbCBoYW5kbGVyCiAgICAgICAgICAgICAgICB0aGF0LmRlbGV0ZUhhbmRsZXIoaGFuZGxlcik7CgogICAgICAgICAgICAgICAgLy8gY2FsbCBlcnJiYWNrIG9uIHRpbWVvdXQgd2l0aCBudWxsIHN0YW56YQogICAgICAgICAgICAgICAgaWYgKGVycmJhY2spIHsKICAgICAgICAgICAgICAgICAgICBlcnJiYWNrKG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIHRoaXMuc2VuZChlbGVtKTsKCiAgICAgICAgcmV0dXJuIGlkOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfcXVldWVEYXRhCiAgICAgKiAgUXVldWUgb3V0Z29pbmcgZGF0YSBmb3IgbGF0ZXIgc2VuZGluZy4gIEFsc28gZW5zdXJlcyB0aGF0IHRoZSBkYXRhCiAgICAgKiAgaXMgYSBET01FbGVtZW50LgogICAgICovCiAgICBfcXVldWVEYXRhOiBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgIGlmIChlbGVtZW50ID09PSBudWxsIHx8CiAgICAgICAgICAgICFlbGVtZW50LnRhZ05hbWUgfHwKICAgICAgICAgICAgIWVsZW1lbnQuY2hpbGROb2RlcykgewogICAgICAgICAgICB0aHJvdyB7CiAgICAgICAgICAgICAgICBuYW1lOiAiU3Ryb3BoZUVycm9yIiwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICJDYW5ub3QgcXVldWUgbm9uLURPTUVsZW1lbnQuIgogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fZGF0YS5wdXNoKGVsZW1lbnQpOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfc2VuZFJlc3RhcnQKICAgICAqICBTZW5kIGFuIHhtcHA6cmVzdGFydCBzdGFuemEuCiAgICAgKi8KICAgIF9zZW5kUmVzdGFydDogZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICB0aGlzLl9kYXRhLnB1c2goInJlc3RhcnQiKTsKCiAgICAgICAgdGhpcy5fcHJvdG8uX3NlbmRSZXN0YXJ0KCk7CgogICAgICAgIHRoaXMuX2lkbGVUaW1lb3V0ID0gc2V0VGltZW91dCh0aGlzLl9vbklkbGUuYmluZCh0aGlzKSwgMTAwKTsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiBhZGRUaW1lZEhhbmRsZXIKICAgICAqICBBZGQgYSB0aW1lZCBoYW5kbGVyIHRvIHRoZSBjb25uZWN0aW9uLgogICAgICoKICAgICAqICBUaGlzIGZ1bmN0aW9uIGFkZHMgYSB0aW1lZCBoYW5kbGVyLiAgVGhlIHByb3ZpZGVkIGhhbmRsZXIgd2lsbAogICAgICogIGJlIGNhbGxlZCBldmVyeSBwZXJpb2QgbWlsbGlzZWNvbmRzIHVudGlsIGl0IHJldHVybnMgZmFsc2UsCiAgICAgKiAgdGhlIGNvbm5lY3Rpb24gaXMgdGVybWluYXRlZCwgb3IgdGhlIGhhbmRsZXIgaXMgcmVtb3ZlZC4gIEhhbmRsZXJzCiAgICAgKiAgdGhhdCB3aXNoIHRvIGNvbnRpbnVlIGJlaW5nIGludm9rZWQgc2hvdWxkIHJldHVybiB0cnVlLgogICAgICoKICAgICAqICBCZWNhdXNlIG9mIG1ldGhvZCBiaW5kaW5nIGl0IGlzIG5lY2Vzc2FyeSB0byBzYXZlIHRoZSByZXN1bHQgb2YKICAgICAqICB0aGlzIGZ1bmN0aW9uIGlmIHlvdSB3aXNoIHRvIHJlbW92ZSBhIGhhbmRsZXIgd2l0aAogICAgICogIGRlbGV0ZVRpbWVkSGFuZGxlcigpLgogICAgICoKICAgICAqICBOb3RlIHRoYXQgdXNlciBoYW5kbGVycyBhcmUgbm90IGFjdGl2ZSB1bnRpbCBhdXRoZW50aWNhdGlvbiBpcwogICAgICogIHN1Y2Nlc3NmdWwuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoSW50ZWdlcikgcGVyaW9kIC0gVGhlIHBlcmlvZCBvZiB0aGUgaGFuZGxlci4KICAgICAqICAgIChGdW5jdGlvbikgaGFuZGxlciAtIFRoZSBjYWxsYmFjayBmdW5jdGlvbi4KICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgIEEgcmVmZXJlbmNlIHRvIHRoZSBoYW5kbGVyIHRoYXQgY2FuIGJlIHVzZWQgdG8gcmVtb3ZlIGl0LgogICAgICovCiAgICBhZGRUaW1lZEhhbmRsZXI6IGZ1bmN0aW9uIChwZXJpb2QsIGhhbmRsZXIpCiAgICB7CiAgICAgICAgdmFyIHRoYW5kID0gbmV3IFN0cm9waGUuVGltZWRIYW5kbGVyKHBlcmlvZCwgaGFuZGxlcik7CiAgICAgICAgdGhpcy5hZGRUaW1lZHMucHVzaCh0aGFuZCk7CiAgICAgICAgcmV0dXJuIHRoYW5kOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IGRlbGV0ZVRpbWVkSGFuZGxlcgogICAgICogIERlbGV0ZSBhIHRpbWVkIGhhbmRsZXIgZm9yIGEgY29ubmVjdGlvbi4KICAgICAqCiAgICAgKiAgVGhpcyBmdW5jdGlvbiByZW1vdmVzIGEgdGltZWQgaGFuZGxlciBmcm9tIHRoZSBjb25uZWN0aW9uLiAgVGhlCiAgICAgKiAgaGFuZFJlZiBwYXJhbWV0ZXIgaXMgKm5vdCogdGhlIGZ1bmN0aW9uIHBhc3NlZCB0byBhZGRUaW1lZEhhbmRsZXIoKSwKICAgICAqICBidXQgaXMgdGhlIHJlZmVyZW5jZSByZXR1cm5lZCBmcm9tIGFkZFRpbWVkSGFuZGxlcigpLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cm9waGUuVGltZWRIYW5kbGVyKSBoYW5kUmVmIC0gVGhlIGhhbmRsZXIgcmVmZXJlbmNlLgogICAgICovCiAgICBkZWxldGVUaW1lZEhhbmRsZXI6IGZ1bmN0aW9uIChoYW5kUmVmKQogICAgewogICAgICAgIC8vIHRoaXMgbXVzdCBiZSBkb25lIGluIHRoZSBJZGxlIGxvb3Agc28gdGhhdCB3ZSBkb24ndCBjaGFuZ2UKICAgICAgICAvLyB0aGUgaGFuZGxlcnMgZHVyaW5nIGl0ZXJhdGlvbgogICAgICAgIHRoaXMucmVtb3ZlVGltZWRzLnB1c2goaGFuZFJlZik7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogYWRkSGFuZGxlcgogICAgICogIEFkZCBhIHN0YW56YSBoYW5kbGVyIGZvciB0aGUgY29ubmVjdGlvbi4KICAgICAqCiAgICAgKiAgVGhpcyBmdW5jdGlvbiBhZGRzIGEgc3RhbnphIGhhbmRsZXIgdG8gdGhlIGNvbm5lY3Rpb24uICBUaGUKICAgICAqICBoYW5kbGVyIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGZvciBhbnkgc3RhbnphIHRoYXQgbWF0Y2hlcwogICAgICogIHRoZSBwYXJhbWV0ZXJzLiAgTm90ZSB0aGF0IGlmIG11bHRpcGxlIHBhcmFtZXRlcnMgYXJlIHN1cHBsaWVkLAogICAgICogIHRoZXkgbXVzdCBhbGwgbWF0Y2ggZm9yIHRoZSBoYW5kbGVyIHRvIGJlIGludm9rZWQuCiAgICAgKgogICAgICogIFRoZSBoYW5kbGVyIHdpbGwgcmVjZWl2ZSB0aGUgc3RhbnphIHRoYXQgdHJpZ2dlcmVkIGl0IGFzIGl0cyBhcmd1bWVudC4KICAgICAqICBUaGUgaGFuZGxlciBzaG91bGQgcmV0dXJuIHRydWUgaWYgaXQgaXMgdG8gYmUgaW52b2tlZCBhZ2FpbjsKICAgICAqICByZXR1cm5pbmcgZmFsc2Ugd2lsbCByZW1vdmUgdGhlIGhhbmRsZXIgYWZ0ZXIgaXQgcmV0dXJucy4KICAgICAqCiAgICAgKiAgQXMgYSBjb252ZW5pZW5jZSwgdGhlIG5zIHBhcmFtZXRlcnMgYXBwbGllcyB0byB0aGUgdG9wIGxldmVsIGVsZW1lbnQKICAgICAqICBhbmQgYWxzbyBhbnkgb2YgaXRzIGltbWVkaWF0ZSBjaGlsZHJlbi4gIFRoaXMgaXMgcHJpbWFyaWx5IHRvIG1ha2UKICAgICAqICBtYXRjaGluZyAvaXEvcXVlcnkgZWxlbWVudHMgZWFzeS4KICAgICAqCiAgICAgKiAgVGhlIG9wdGlvbnMgYXJndW1lbnQgY29udGFpbnMgaGFuZGxlciBtYXRjaGluZyBmbGFncyB0aGF0IGFmZmVjdCBob3cKICAgICAqICBtYXRjaGVzIGFyZSBkZXRlcm1pbmVkLiBDdXJyZW50bHkgdGhlIG9ubHkgZmxhZyBpcyBtYXRjaEJhcmUgKGEKICAgICAqICBib29sZWFuKS4gV2hlbiBtYXRjaEJhcmUgaXMgdHJ1ZSwgdGhlIGZyb20gcGFyYW1ldGVyIGFuZCB0aGUgZnJvbQogICAgICogIGF0dHJpYnV0ZSBvbiB0aGUgc3RhbnphIHdpbGwgYmUgbWF0Y2hlZCBhcyBiYXJlIEpJRHMgaW5zdGVhZCBvZgogICAgICogIGZ1bGwgSklEcy4gVG8gdXNlIHRoaXMsIHBhc3Mge21hdGNoQmFyZTogdHJ1ZX0gYXMgdGhlIHZhbHVlIG9mCiAgICAgKiAgb3B0aW9ucy4gVGhlIGRlZmF1bHQgdmFsdWUgZm9yIG1hdGNoQmFyZSBpcyBmYWxzZS4KICAgICAqCiAgICAgKiAgVGhlIHJldHVybiB2YWx1ZSBzaG91bGQgYmUgc2F2ZWQgaWYgeW91IHdpc2ggdG8gcmVtb3ZlIHRoZSBoYW5kbGVyCiAgICAgKiAgd2l0aCBkZWxldGVIYW5kbGVyKCkuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoRnVuY3Rpb24pIGhhbmRsZXIgLSBUaGUgdXNlciBjYWxsYmFjay4KICAgICAqICAgIChTdHJpbmcpIG5zIC0gVGhlIG5hbWVzcGFjZSB0byBtYXRjaC4KICAgICAqICAgIChTdHJpbmcpIG5hbWUgLSBUaGUgc3RhbnphIG5hbWUgdG8gbWF0Y2guCiAgICAgKiAgICAoU3RyaW5nKSB0eXBlIC0gVGhlIHN0YW56YSB0eXBlIGF0dHJpYnV0ZSB0byBtYXRjaC4KICAgICAqICAgIChTdHJpbmcpIGlkIC0gVGhlIHN0YW56YSBpZCBhdHRyaWJ1dGUgdG8gbWF0Y2guCiAgICAgKiAgICAoU3RyaW5nKSBmcm9tIC0gVGhlIHN0YW56YSBmcm9tIGF0dHJpYnV0ZSB0byBtYXRjaC4KICAgICAqICAgIChTdHJpbmcpIG9wdGlvbnMgLSBUaGUgaGFuZGxlciBvcHRpb25zCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBBIHJlZmVyZW5jZSB0byB0aGUgaGFuZGxlciB0aGF0IGNhbiBiZSB1c2VkIHRvIHJlbW92ZSBpdC4KICAgICAqLwogICAgYWRkSGFuZGxlcjogZnVuY3Rpb24gKGhhbmRsZXIsIG5zLCBuYW1lLCB0eXBlLCBpZCwgZnJvbSwgb3B0aW9ucykKICAgIHsKICAgICAgICB2YXIgaGFuZCA9IG5ldyBTdHJvcGhlLkhhbmRsZXIoaGFuZGxlciwgbnMsIG5hbWUsIHR5cGUsIGlkLCBmcm9tLCBvcHRpb25zKTsKICAgICAgICB0aGlzLmFkZEhhbmRsZXJzLnB1c2goaGFuZCk7CiAgICAgICAgcmV0dXJuIGhhbmQ7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogZGVsZXRlSGFuZGxlcgogICAgICogIERlbGV0ZSBhIHN0YW56YSBoYW5kbGVyIGZvciBhIGNvbm5lY3Rpb24uCiAgICAgKgogICAgICogIFRoaXMgZnVuY3Rpb24gcmVtb3ZlcyBhIHN0YW56YSBoYW5kbGVyIGZyb20gdGhlIGNvbm5lY3Rpb24uICBUaGUKICAgICAqICBoYW5kUmVmIHBhcmFtZXRlciBpcyAqbm90KiB0aGUgZnVuY3Rpb24gcGFzc2VkIHRvIGFkZEhhbmRsZXIoKSwKICAgICAqICBidXQgaXMgdGhlIHJlZmVyZW5jZSByZXR1cm5lZCBmcm9tIGFkZEhhbmRsZXIoKS4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJvcGhlLkhhbmRsZXIpIGhhbmRSZWYgLSBUaGUgaGFuZGxlciByZWZlcmVuY2UuCiAgICAgKi8KICAgIGRlbGV0ZUhhbmRsZXI6IGZ1bmN0aW9uIChoYW5kUmVmKQogICAgewogICAgICAgIC8vIHRoaXMgbXVzdCBiZSBkb25lIGluIHRoZSBJZGxlIGxvb3Agc28gdGhhdCB3ZSBkb24ndCBjaGFuZ2UKICAgICAgICAvLyB0aGUgaGFuZGxlcnMgZHVyaW5nIGl0ZXJhdGlvbgogICAgICAgIHRoaXMucmVtb3ZlSGFuZGxlcnMucHVzaChoYW5kUmVmKTsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiBkaXNjb25uZWN0CiAgICAgKiAgU3RhcnQgdGhlIGdyYWNlZnVsIGRpc2Nvbm5lY3Rpb24gcHJvY2Vzcy4KICAgICAqCiAgICAgKiAgVGhpcyBmdW5jdGlvbiBzdGFydHMgdGhlIGRpc2Nvbm5lY3Rpb24gcHJvY2Vzcy4gIFRoaXMgcHJvY2VzcyBzdGFydHMKICAgICAqICBieSBzZW5kaW5nIHVuYXZhaWxhYmxlIHByZXNlbmNlIGFuZCBzZW5kaW5nIEJPU0ggYm9keSBvZiB0eXBlCiAgICAgKiAgdGVybWluYXRlLiAgQSB0aW1lb3V0IGhhbmRsZXIgbWFrZXMgc3VyZSB0aGF0IGRpc2Nvbm5lY3Rpb24gaGFwcGVucwogICAgICogIGV2ZW4gaWYgdGhlIEJPU0ggc2VydmVyIGRvZXMgbm90IHJlc3BvbmQuCiAgICAgKgogICAgICogIFRoZSB1c2VyIHN1cHBsaWVkIGNvbm5lY3Rpb24gY2FsbGJhY2sgd2lsbCBiZSBub3RpZmllZCBvZiB0aGUKICAgICAqICBwcm9ncmVzcyBhcyB0aGlzIHByb2Nlc3MgaGFwcGVucy4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJpbmcpIHJlYXNvbiAtIFRoZSByZWFzb24gdGhlIGRpc2Nvbm5lY3QgaXMgb2NjdXJpbmcuCiAgICAgKi8KICAgIGRpc2Nvbm5lY3Q6IGZ1bmN0aW9uIChyZWFzb24pCiAgICB7CiAgICAgICAgdGhpcy5fY2hhbmdlQ29ubmVjdFN0YXR1cyhTdHJvcGhlLlN0YXR1cy5ESVNDT05ORUNUSU5HLCByZWFzb24pOwoKICAgICAgICBTdHJvcGhlLmluZm8oIkRpc2Nvbm5lY3Qgd2FzIGNhbGxlZCBiZWNhdXNlOiAiICsgcmVhc29uKTsKICAgICAgICBpZiAodGhpcy5jb25uZWN0ZWQpIHsKICAgICAgICAgICAgdmFyIHByZXMgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5kaXNjb25uZWN0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKHRoaXMuYXV0aGVudGljYXRlZCkgewogICAgICAgICAgICAgICAgcHJlcyA9ICRwcmVzKHsKICAgICAgICAgICAgICAgICAgICB4bWxuczogU3Ryb3BoZS5OUy5DTElFTlQsCiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ3VuYXZhaWxhYmxlJwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gc2V0dXAgdGltZW91dCBoYW5kbGVyCiAgICAgICAgICAgIHRoaXMuX2Rpc2Nvbm5lY3RUaW1lb3V0ID0gdGhpcy5fYWRkU3lzVGltZWRIYW5kbGVyKAogICAgICAgICAgICAgICAgMzAwMCwgdGhpcy5fb25EaXNjb25uZWN0VGltZW91dC5iaW5kKHRoaXMpKTsKICAgICAgICAgICAgdGhpcy5fcHJvdG8uX2Rpc2Nvbm5lY3QocHJlcyk7CiAgICAgICAgfQogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfY2hhbmdlQ29ubmVjdFN0YXR1cwogICAgICogIF9Qcml2YXRlXyBoZWxwZXIgZnVuY3Rpb24gdGhhdCBtYWtlcyBzdXJlIHBsdWdpbnMgYW5kIHRoZSB1c2VyJ3MKICAgICAqICBjYWxsYmFjayBhcmUgbm90aWZpZWQgb2YgY29ubmVjdGlvbiBzdGF0dXMgY2hhbmdlcy4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChJbnRlZ2VyKSBzdGF0dXMgLSB0aGUgbmV3IGNvbm5lY3Rpb24gc3RhdHVzLCBvbmUgb2YgdGhlIHZhbHVlcwogICAgICogICAgICBpbiBTdHJvcGhlLlN0YXR1cwogICAgICogICAgKFN0cmluZykgY29uZGl0aW9uIC0gdGhlIGVycm9yIGNvbmRpdGlvbiBvciBudWxsCiAgICAgKi8KICAgIF9jaGFuZ2VDb25uZWN0U3RhdHVzOiBmdW5jdGlvbiAoc3RhdHVzLCBjb25kaXRpb24pCiAgICB7CiAgICAgICAgLy8gbm90aWZ5IGFsbCBwbHVnaW5zIGxpc3RlbmluZyBmb3Igc3RhdHVzIGNoYW5nZXMKICAgICAgICBmb3IgKHZhciBrIGluIFN0cm9waGUuX2Nvbm5lY3Rpb25QbHVnaW5zKSB7CiAgICAgICAgICAgIGlmIChTdHJvcGhlLl9jb25uZWN0aW9uUGx1Z2lucy5oYXNPd25Qcm9wZXJ0eShrKSkgewogICAgICAgICAgICAgICAgdmFyIHBsdWdpbiA9IHRoaXNba107CiAgICAgICAgICAgICAgICBpZiAocGx1Z2luLnN0YXR1c0NoYW5nZWQpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBwbHVnaW4uc3RhdHVzQ2hhbmdlZChzdGF0dXMsIGNvbmRpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIFN0cm9waGUuZXJyb3IoIiIgKyBrICsgIiBwbHVnaW4gY2F1c2VkIGFuIGV4Y2VwdGlvbiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY2hhbmdpbmcgc3RhdHVzOiAiICsgZXJyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIG5vdGlmeSB0aGUgdXNlcidzIGNhbGxiYWNrCiAgICAgICAgaWYgKHRoaXMuY29ubmVjdF9jYWxsYmFjaykgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhpcy5jb25uZWN0X2NhbGxiYWNrKHN0YXR1cywgY29uZGl0aW9uKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgU3Ryb3BoZS5lcnJvcigiVXNlciBjb25uZWN0aW9uIGNhbGxiYWNrIGNhdXNlZCBhbiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImV4Y2VwdGlvbjogIiArIGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfZG9EaXNjb25uZWN0CiAgICAgKiAgX1ByaXZhdGVfIGZ1bmN0aW9uIHRvIGRpc2Nvbm5lY3QuCiAgICAgKgogICAgICogIFRoaXMgaXMgdGhlIGxhc3QgcGllY2Ugb2YgdGhlIGRpc2Nvbm5lY3Rpb24gbG9naWMuICBUaGlzIHJlc2V0cyB0aGUKICAgICAqICBjb25uZWN0aW9uIGFuZCBhbGVydHMgdGhlIHVzZXIncyBjb25uZWN0aW9uIGNhbGxiYWNrLgogICAgICovCiAgICBfZG9EaXNjb25uZWN0OiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIC8vIENhbmNlbCBEaXNjb25uZWN0IFRpbWVvdXQKICAgICAgICBpZiAodGhpcy5fZGlzY29ubmVjdFRpbWVvdXQgIT09IG51bGwpIHsKICAgICAgICAgICAgdGhpcy5kZWxldGVUaW1lZEhhbmRsZXIodGhpcy5fZGlzY29ubmVjdFRpbWVvdXQpOwogICAgICAgICAgICB0aGlzLl9kaXNjb25uZWN0VGltZW91dCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBTdHJvcGhlLmluZm8oIl9kb0Rpc2Nvbm5lY3Qgd2FzIGNhbGxlZCIpOwogICAgICAgIHRoaXMuX3Byb3RvLl9kb0Rpc2Nvbm5lY3QoKTsKCiAgICAgICAgdGhpcy5hdXRoZW50aWNhdGVkID0gZmFsc2U7CiAgICAgICAgdGhpcy5kaXNjb25uZWN0aW5nID0gZmFsc2U7CgogICAgICAgIC8vIGRlbGV0ZSBoYW5kbGVycwogICAgICAgIHRoaXMuaGFuZGxlcnMgPSBbXTsKICAgICAgICB0aGlzLnRpbWVkSGFuZGxlcnMgPSBbXTsKICAgICAgICB0aGlzLnJlbW92ZVRpbWVkcyA9IFtdOwogICAgICAgIHRoaXMucmVtb3ZlSGFuZGxlcnMgPSBbXTsKICAgICAgICB0aGlzLmFkZFRpbWVkcyA9IFtdOwogICAgICAgIHRoaXMuYWRkSGFuZGxlcnMgPSBbXTsKCiAgICAgICAgLy8gdGVsbCB0aGUgcGFyZW50IHdlIGRpc2Nvbm5lY3RlZAogICAgICAgIHRoaXMuX2NoYW5nZUNvbm5lY3RTdGF0dXMoU3Ryb3BoZS5TdGF0dXMuRElTQ09OTkVDVEVELCBudWxsKTsKICAgICAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfZGF0YVJlY3YKICAgICAqICBfUHJpdmF0ZV8gaGFuZGxlciB0byBwcm9jZXNzZXMgaW5jb21pbmcgZGF0YSBmcm9tIHRoZSB0aGUgY29ubmVjdGlvbi4KICAgICAqCiAgICAgKiAgRXhjZXB0IGZvciBfY29ubmVjdF9jYiBoYW5kbGluZyB0aGUgaW5pdGlhbCBjb25uZWN0aW9uIHJlcXVlc3QsCiAgICAgKiAgdGhpcyBmdW5jdGlvbiBoYW5kbGVzIHRoZSBpbmNvbWluZyBkYXRhIGZvciBhbGwgcmVxdWVzdHMuICBUaGlzCiAgICAgKiAgZnVuY3Rpb24gYWxzbyBmaXJlcyBzdGFuemEgaGFuZGxlcnMgdGhhdCBtYXRjaCBlYWNoIGluY29taW5nCiAgICAgKiAgc3RhbnphLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cm9waGUuUmVxdWVzdCkgcmVxIC0gVGhlIHJlcXVlc3QgdGhhdCBoYXMgZGF0YSByZWFkeS4KICAgICAqICAgIChzdHJpbmcpIHJlcSAtIFRoZSBzdGFuemEgYSByYXcgc3RyaW5nIChvcHRpb25hKS4KICAgICAqLwogICAgX2RhdGFSZWN2OiBmdW5jdGlvbiAocmVxLCByYXcpCiAgICB7CiAgICAgICAgU3Ryb3BoZS5pbmZvKCJfZGF0YVJlY3YgY2FsbGVkIik7CiAgICAgICAgdmFyIGVsZW0gPSB0aGlzLl9wcm90by5fcmVxVG9EYXRhKHJlcSk7CiAgICAgICAgaWYgKGVsZW0gPT09IG51bGwpIHsgcmV0dXJuOyB9CgogICAgICAgIGlmICh0aGlzLnhtbElucHV0ICE9PSBTdHJvcGhlLkNvbm5lY3Rpb24ucHJvdG90eXBlLnhtbElucHV0KSB7CiAgICAgICAgICAgIGlmIChlbGVtLm5vZGVOYW1lID09PSB0aGlzLl9wcm90by5zdHJpcCAmJiBlbGVtLmNoaWxkTm9kZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnhtbElucHV0KGVsZW0uY2hpbGROb2Rlc1swXSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnhtbElucHV0KGVsZW0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLnJhd0lucHV0ICE9PSBTdHJvcGhlLkNvbm5lY3Rpb24ucHJvdG90eXBlLnJhd0lucHV0KSB7CiAgICAgICAgICAgIGlmIChyYXcpIHsKICAgICAgICAgICAgICAgIHRoaXMucmF3SW5wdXQocmF3KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMucmF3SW5wdXQoU3Ryb3BoZS5zZXJpYWxpemUoZWxlbSkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyByZW1vdmUgaGFuZGxlcnMgc2NoZWR1bGVkIGZvciBkZWxldGlvbgogICAgICAgIHZhciBpLCBoYW5kOwogICAgICAgIHdoaWxlICh0aGlzLnJlbW92ZUhhbmRsZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgaGFuZCA9IHRoaXMucmVtb3ZlSGFuZGxlcnMucG9wKCk7CiAgICAgICAgICAgIGkgPSB0aGlzLmhhbmRsZXJzLmluZGV4T2YoaGFuZCk7CiAgICAgICAgICAgIGlmIChpID49IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlcnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBhZGQgaGFuZGxlcnMgc2NoZWR1bGVkIGZvciBhZGRpdGlvbgogICAgICAgIHdoaWxlICh0aGlzLmFkZEhhbmRsZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdGhpcy5oYW5kbGVycy5wdXNoKHRoaXMuYWRkSGFuZGxlcnMucG9wKCkpOwogICAgICAgIH0KCiAgICAgICAgLy8gaGFuZGxlIGdyYWNlZnVsIGRpc2Nvbm5lY3QKICAgICAgICBpZiAodGhpcy5kaXNjb25uZWN0aW5nICYmIHRoaXMuX3Byb3RvLl9lbXB0eVF1ZXVlKCkpIHsKICAgICAgICAgICAgdGhpcy5fZG9EaXNjb25uZWN0KCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciB0eXAgPSBlbGVtLmdldEF0dHJpYnV0ZSgidHlwZSIpOwogICAgICAgIHZhciBjb25kLCBjb25mbGljdDsKICAgICAgICBpZiAodHlwICE9PSBudWxsICYmIHR5cCA9PSAidGVybWluYXRlIikgewogICAgICAgICAgICAvLyBEb24ndCBwcm9jZXNzIHN0YW56YXMgdGhhdCBjb21lIGluIGFmdGVyIGRpc2Nvbm5lY3QKICAgICAgICAgICAgaWYgKHRoaXMuZGlzY29ubmVjdGluZykgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBhbiBlcnJvciBvY2N1cnJlZAogICAgICAgICAgICBjb25kID0gZWxlbS5nZXRBdHRyaWJ1dGUoImNvbmRpdGlvbiIpOwogICAgICAgICAgICBjb25mbGljdCA9IGVsZW0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoImNvbmZsaWN0Iik7CiAgICAgICAgICAgIGlmIChjb25kICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoY29uZCA9PSAicmVtb3RlLXN0cmVhbS1lcnJvciIgJiYgY29uZmxpY3QubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbmQgPSAiY29uZmxpY3QiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5fY2hhbmdlQ29ubmVjdFN0YXR1cyhTdHJvcGhlLlN0YXR1cy5DT05ORkFJTCwgY29uZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jaGFuZ2VDb25uZWN0U3RhdHVzKFN0cm9waGUuU3RhdHVzLkNPTk5GQUlMLCAidW5rbm93biIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZGlzY29ubmVjdCgndW5rbm93biBzdHJlYW0tZXJyb3InKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gc2VuZCBlYWNoIGluY29taW5nIHN0YW56YSB0aHJvdWdoIHRoZSBoYW5kbGVyIGNoYWluCiAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgIFN0cm9waGUuZm9yRWFjaENoaWxkKGVsZW0sIG51bGwsIGZ1bmN0aW9uIChjaGlsZCkgewogICAgICAgICAgICB2YXIgaSwgbmV3TGlzdDsKICAgICAgICAgICAgLy8gcHJvY2VzcyBoYW5kbGVycwogICAgICAgICAgICBuZXdMaXN0ID0gdGhhdC5oYW5kbGVyczsKICAgICAgICAgICAgdGhhdC5oYW5kbGVycyA9IFtdOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbmV3TGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGhhbmQgPSBuZXdMaXN0W2ldOwogICAgICAgICAgICAgICAgLy8gZW5jYXBzdWxhdGUgJ2hhbmRsZXIucnVuJyBub3QgdG8gbG9zZSB0aGUgd2hvbGUgaGFuZGxlciBsaXN0IGlmCiAgICAgICAgICAgICAgICAvLyBvbmUgb2YgdGhlIGhhbmRsZXJzIHRocm93cyBhbiBleGNlcHRpb24KICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhbmQuaXNNYXRjaChjaGlsZCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgKHRoYXQuYXV0aGVudGljYXRlZCB8fCAhaGFuZC51c2VyKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFuZC5ydW4oY2hpbGQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmhhbmRsZXJzLnB1c2goaGFuZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmhhbmRsZXJzLnB1c2goaGFuZCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIGhhbmRsZXIgdGhyb3dzIGFuIGV4Y2VwdGlvbiwgd2UgY29uc2lkZXIgaXQgYXMgZmFsc2UKICAgICAgICAgICAgICAgICAgICBTdHJvcGhlLndhcm4oJ1JlbW92aW5nIFN0cm9waGUgaGFuZGxlcnMgZHVlIHRvIHVuY2F1Z2h0IGV4Y2VwdGlvbjogJyArIGUubWVzc2FnZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0sCgoKICAgIC8qKiBBdHRyaWJ1dGU6IG1lY2hhbmlzbXMKICAgICAqICBTQVNMIE1lY2hhbmlzbXMgYXZhaWxhYmxlIGZvciBDb25uY2VjdGlvbi4KICAgICAqLwogICAgbWVjaGFuaXNtczoge30sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX2Nvbm5lY3RfY2IKICAgICAqICBfUHJpdmF0ZV8gaGFuZGxlciBmb3IgaW5pdGlhbCBjb25uZWN0aW9uIHJlcXVlc3QuCiAgICAgKgogICAgICogIFRoaXMgaGFuZGxlciBpcyB1c2VkIHRvIHByb2Nlc3MgdGhlIGluaXRpYWwgY29ubmVjdGlvbiByZXF1ZXN0CiAgICAgKiAgcmVzcG9uc2UgZnJvbSB0aGUgQk9TSCBzZXJ2ZXIuIEl0IGlzIHVzZWQgdG8gc2V0IHVwIGF1dGhlbnRpY2F0aW9uCiAgICAgKiAgaGFuZGxlcnMgYW5kIHN0YXJ0IHRoZSBhdXRoZW50aWNhdGlvbiBwcm9jZXNzLgogICAgICoKICAgICAqICBTQVNMIGF1dGhlbnRpY2F0aW9uIHdpbGwgYmUgYXR0ZW1wdGVkIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlCiAgICAgKiAgdGhlIGNvZGUgd2lsbCBmYWxsIGJhY2sgdG8gbGVnYWN5IGF1dGhlbnRpY2F0aW9uLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cm9waGUuUmVxdWVzdCkgcmVxIC0gVGhlIGN1cnJlbnQgcmVxdWVzdC4KICAgICAqICAgIChGdW5jdGlvbikgX2NhbGxiYWNrIC0gbG93IGxldmVsICh4bXBwKSBjb25uZWN0IGNhbGxiYWNrIGZ1bmN0aW9uLgogICAgICogICAgICBVc2VmdWwgZm9yIHBsdWdpbnMgd2l0aCB0aGVpciBvd24geG1wcCBjb25uZWN0IGNhbGxiYWNrICh3aGVuIHRoZWlyKQogICAgICogICAgICB3YW50IHRvIGRvIHNvbWV0aGluZyBzcGVjaWFsKS4KICAgICAqLwogICAgX2Nvbm5lY3RfY2I6IGZ1bmN0aW9uIChyZXEsIF9jYWxsYmFjaywgcmF3KQogICAgewogICAgICAgIFN0cm9waGUuaW5mbygiX2Nvbm5lY3RfY2Igd2FzIGNhbGxlZCIpOwoKICAgICAgICB0aGlzLmNvbm5lY3RlZCA9IHRydWU7CgogICAgICAgIHZhciBib2R5V3JhcCA9IHRoaXMuX3Byb3RvLl9yZXFUb0RhdGEocmVxKTsKICAgICAgICBpZiAoIWJvZHlXcmFwKSB7IHJldHVybjsgfQoKICAgICAgICBpZiAodGhpcy54bWxJbnB1dCAhPT0gU3Ryb3BoZS5Db25uZWN0aW9uLnByb3RvdHlwZS54bWxJbnB1dCkgewogICAgICAgICAgICBpZiAoYm9keVdyYXAubm9kZU5hbWUgPT09IHRoaXMuX3Byb3RvLnN0cmlwICYmIGJvZHlXcmFwLmNoaWxkTm9kZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnhtbElucHV0KGJvZHlXcmFwLmNoaWxkTm9kZXNbMF0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy54bWxJbnB1dChib2R5V3JhcCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMucmF3SW5wdXQgIT09IFN0cm9waGUuQ29ubmVjdGlvbi5wcm90b3R5cGUucmF3SW5wdXQpIHsKICAgICAgICAgICAgaWYgKHJhdykgewogICAgICAgICAgICAgICAgdGhpcy5yYXdJbnB1dChyYXcpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5yYXdJbnB1dChTdHJvcGhlLnNlcmlhbGl6ZShib2R5V3JhcCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgY29ubmNoZWNrID0gdGhpcy5fcHJvdG8uX2Nvbm5lY3RfY2IoYm9keVdyYXApOwogICAgICAgIGlmIChjb25uY2hlY2sgPT09IFN0cm9waGUuU3RhdHVzLkNPTk5GQUlMKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRoaXMuX2F1dGhlbnRpY2F0aW9uLnNhc2xfc2NyYW1fc2hhMSA9IGZhbHNlOwogICAgICAgIHRoaXMuX2F1dGhlbnRpY2F0aW9uLnNhc2xfcGxhaW4gPSBmYWxzZTsKICAgICAgICB0aGlzLl9hdXRoZW50aWNhdGlvbi5zYXNsX2RpZ2VzdF9tZDUgPSBmYWxzZTsKICAgICAgICB0aGlzLl9hdXRoZW50aWNhdGlvbi5zYXNsX2Fub255bW91cyA9IGZhbHNlOwoKICAgICAgICB0aGlzLl9hdXRoZW50aWNhdGlvbi5sZWdhY3lfYXV0aCA9IGZhbHNlOwoKICAgICAgICAvLyBDaGVjayBmb3IgdGhlIHN0cmVhbTpmZWF0dXJlcyB0YWcKICAgICAgICB2YXIgaGFzRmVhdHVyZXMgPSBib2R5V3JhcC5nZXRFbGVtZW50c0J5VGFnTmFtZSgic3RyZWFtOmZlYXR1cmVzIikubGVuZ3RoID4gMDsKICAgICAgICBpZiAoIWhhc0ZlYXR1cmVzKSB7CiAgICAgICAgICAgIGhhc0ZlYXR1cmVzID0gYm9keVdyYXAuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImZlYXR1cmVzIikubGVuZ3RoID4gMDsKICAgICAgICB9CiAgICAgICAgdmFyIG1lY2hhbmlzbXMgPSBib2R5V3JhcC5nZXRFbGVtZW50c0J5VGFnTmFtZSgibWVjaGFuaXNtIik7CiAgICAgICAgdmFyIG1hdGNoZWQgPSBbXTsKICAgICAgICB2YXIgaSwgbWVjaCwgZm91bmRfYXV0aGVudGljYXRpb24gPSBmYWxzZTsKICAgICAgICBpZiAoIWhhc0ZlYXR1cmVzKSB7CiAgICAgICAgICAgIHRoaXMuX3Byb3RvLl9ub19hdXRoX3JlY2VpdmVkKF9jYWxsYmFjayk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKG1lY2hhbmlzbXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbWVjaGFuaXNtcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgbWVjaCA9IFN0cm9waGUuZ2V0VGV4dChtZWNoYW5pc21zW2ldKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1lY2hhbmlzbXNbbWVjaF0pIG1hdGNoZWQucHVzaCh0aGlzLm1lY2hhbmlzbXNbbWVjaF0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuX2F1dGhlbnRpY2F0aW9uLmxlZ2FjeV9hdXRoID0KICAgICAgICAgICAgYm9keVdyYXAuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImF1dGgiKS5sZW5ndGggPiAwOwogICAgICAgIGZvdW5kX2F1dGhlbnRpY2F0aW9uID0gdGhpcy5fYXV0aGVudGljYXRpb24ubGVnYWN5X2F1dGggfHwKICAgICAgICAgICAgbWF0Y2hlZC5sZW5ndGggPiAwOwogICAgICAgIGlmICghZm91bmRfYXV0aGVudGljYXRpb24pIHsKICAgICAgICAgICAgdGhpcy5fcHJvdG8uX25vX2F1dGhfcmVjZWl2ZWQoX2NhbGxiYWNrKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5kb19hdXRoZW50aWNhdGlvbiAhPT0gZmFsc2UpCiAgICAgICAgICAgIHRoaXMuYXV0aGVudGljYXRlKG1hdGNoZWQpOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IGF1dGhlbnRpY2F0ZQogICAgICogU2V0IHVwIGF1dGhlbnRpY2F0aW9uCiAgICAgKgogICAgICogIENvbnRpdW51ZXMgdGhlIGluaXRpYWwgY29ubmVjdGlvbiByZXF1ZXN0IGJ5IHNldHRpbmcgdXAgYXV0aGVudGljYXRpb24KICAgICAqICBoYW5kbGVycyBhbmQgc3RhcnQgdGhlIGF1dGhlbnRpY2F0aW9uIHByb2Nlc3MuCiAgICAgKgogICAgICogIFNBU0wgYXV0aGVudGljYXRpb24gd2lsbCBiZSBhdHRlbXB0ZWQgaWYgYXZhaWxhYmxlLCBvdGhlcndpc2UKICAgICAqICB0aGUgY29kZSB3aWxsIGZhbGwgYmFjayB0byBsZWdhY3kgYXV0aGVudGljYXRpb24uCiAgICAgKgogICAgICovCiAgICBhdXRoZW50aWNhdGU6IGZ1bmN0aW9uIChtYXRjaGVkKQogICAgewogICAgICB2YXIgaTsKICAgICAgLy8gU29ydGluZyBtYXRjaGVkIG1lY2hhbmlzbXMgYWNjb3JkaW5nIHRvIHByaW9yaXR5LgogICAgICBmb3IgKGkgPSAwOyBpIDwgbWF0Y2hlZC5sZW5ndGggLSAxOyArK2kpIHsKICAgICAgICB2YXIgaGlnaGVyID0gaTsKICAgICAgICBmb3IgKHZhciBqID0gaSArIDE7IGogPCBtYXRjaGVkLmxlbmd0aDsgKytqKSB7CiAgICAgICAgICBpZiAobWF0Y2hlZFtqXS5wcm90b3R5cGUucHJpb3JpdHkgPiBtYXRjaGVkW2hpZ2hlcl0ucHJvdG90eXBlLnByaW9yaXR5KSB7CiAgICAgICAgICAgIGhpZ2hlciA9IGo7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChoaWdoZXIgIT0gaSkgewogICAgICAgICAgdmFyIHN3YXAgPSBtYXRjaGVkW2ldOwogICAgICAgICAgbWF0Y2hlZFtpXSA9IG1hdGNoZWRbaGlnaGVyXTsKICAgICAgICAgIG1hdGNoZWRbaGlnaGVyXSA9IHN3YXA7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBydW4gZWFjaCBtZWNoYW5pc20KICAgICAgdmFyIG1lY2hhbmlzbV9mb3VuZCA9IGZhbHNlOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbWF0Y2hlZC5sZW5ndGg7ICsraSkgewogICAgICAgIGlmICghbWF0Y2hlZFtpXS50ZXN0KHRoaXMpKSBjb250aW51ZTsKCiAgICAgICAgdGhpcy5fc2FzbF9zdWNjZXNzX2hhbmRsZXIgPSB0aGlzLl9hZGRTeXNIYW5kbGVyKAogICAgICAgICAgdGhpcy5fc2FzbF9zdWNjZXNzX2NiLmJpbmQodGhpcyksIG51bGwsCiAgICAgICAgICAic3VjY2VzcyIsIG51bGwsIG51bGwpOwogICAgICAgIHRoaXMuX3Nhc2xfZmFpbHVyZV9oYW5kbGVyID0gdGhpcy5fYWRkU3lzSGFuZGxlcigKICAgICAgICAgIHRoaXMuX3Nhc2xfZmFpbHVyZV9jYi5iaW5kKHRoaXMpLCBudWxsLAogICAgICAgICAgImZhaWx1cmUiLCBudWxsLCBudWxsKTsKICAgICAgICB0aGlzLl9zYXNsX2NoYWxsZW5nZV9oYW5kbGVyID0gdGhpcy5fYWRkU3lzSGFuZGxlcigKICAgICAgICAgIHRoaXMuX3Nhc2xfY2hhbGxlbmdlX2NiLmJpbmQodGhpcyksIG51bGwsCiAgICAgICAgICAiY2hhbGxlbmdlIiwgbnVsbCwgbnVsbCk7CgogICAgICAgIHRoaXMuX3Nhc2xfbWVjaGFuaXNtID0gbmV3IG1hdGNoZWRbaV0oKTsKICAgICAgICB0aGlzLl9zYXNsX21lY2hhbmlzbS5vblN0YXJ0KHRoaXMpOwoKICAgICAgICB2YXIgcmVxdWVzdF9hdXRoX2V4Y2hhbmdlID0gJGJ1aWxkKCJhdXRoIiwgewogICAgICAgICAgeG1sbnM6IFN0cm9waGUuTlMuU0FTTCwKICAgICAgICAgIG1lY2hhbmlzbTogdGhpcy5fc2FzbF9tZWNoYW5pc20ubmFtZQogICAgICAgIH0pOwoKICAgICAgICBpZiAodGhpcy5fc2FzbF9tZWNoYW5pc20uaXNDbGllbnRGaXJzdCkgewogICAgICAgICAgdmFyIHJlc3BvbnNlID0gdGhpcy5fc2FzbF9tZWNoYW5pc20ub25DaGFsbGVuZ2UodGhpcywgbnVsbCk7CiAgICAgICAgICByZXF1ZXN0X2F1dGhfZXhjaGFuZ2UudChCYXNlNjQuZW5jb2RlKHJlc3BvbnNlKSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnNlbmQocmVxdWVzdF9hdXRoX2V4Y2hhbmdlLnRyZWUoKSk7CgogICAgICAgIG1lY2hhbmlzbV9mb3VuZCA9IHRydWU7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KCiAgICAgIGlmICghbWVjaGFuaXNtX2ZvdW5kKSB7CiAgICAgICAgLy8gaWYgbm9uZSBvZiB0aGUgbWVjaGFuaXNtIHdvcmtlZAogICAgICAgIGlmIChTdHJvcGhlLmdldE5vZGVGcm9tSmlkKHRoaXMuamlkKSA9PT0gbnVsbCkgewogICAgICAgICAgICAvLyB3ZSBkb24ndCBoYXZlIGEgbm9kZSwgd2hpY2ggaXMgcmVxdWlyZWQgZm9yIG5vbi1hbm9ueW1vdXMKICAgICAgICAgICAgLy8gY2xpZW50IGNvbm5lY3Rpb25zCiAgICAgICAgICAgIHRoaXMuX2NoYW5nZUNvbm5lY3RTdGF0dXMoU3Ryb3BoZS5TdGF0dXMuQ09OTkZBSUwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3gtc3Ryb3BoZS1iYWQtbm9uLWFub24tamlkJyk7CiAgICAgICAgICAgIHRoaXMuZGlzY29ubmVjdCgneC1zdHJvcGhlLWJhZC1ub24tYW5vbi1qaWQnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gZmFsbCBiYWNrIHRvIGxlZ2FjeSBhdXRoZW50aWNhdGlvbgogICAgICAgICAgdGhpcy5fY2hhbmdlQ29ubmVjdFN0YXR1cyhTdHJvcGhlLlN0YXR1cy5BVVRIRU5USUNBVElORywgbnVsbCk7CiAgICAgICAgICB0aGlzLl9hZGRTeXNIYW5kbGVyKHRoaXMuX2F1dGgxX2NiLmJpbmQodGhpcyksIG51bGwsIG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bGwsICJfYXV0aF8xIik7CgogICAgICAgICAgdGhpcy5zZW5kKCRpcSh7CiAgICAgICAgICAgIHR5cGU6ICJnZXQiLAogICAgICAgICAgICB0bzogdGhpcy5kb21haW4sCiAgICAgICAgICAgIGlkOiAiX2F1dGhfMSIKICAgICAgICAgIH0pLmMoInF1ZXJ5IiwgewogICAgICAgICAgICB4bWxuczogU3Ryb3BoZS5OUy5BVVRICiAgICAgICAgICB9KS5jKCJ1c2VybmFtZSIsIHt9KS50KFN0cm9waGUuZ2V0Tm9kZUZyb21KaWQodGhpcy5qaWQpKS50cmVlKCkpOwogICAgICAgIH0KICAgICAgfQoKICAgIH0sCgogICAgX3Nhc2xfY2hhbGxlbmdlX2NiOiBmdW5jdGlvbihlbGVtKSB7CiAgICAgIHZhciBjaGFsbGVuZ2UgPSBCYXNlNjQuZGVjb2RlKFN0cm9waGUuZ2V0VGV4dChlbGVtKSk7CiAgICAgIHZhciByZXNwb25zZSA9IHRoaXMuX3Nhc2xfbWVjaGFuaXNtLm9uQ2hhbGxlbmdlKHRoaXMsIGNoYWxsZW5nZSk7CgogICAgICB2YXIgc3RhbnphID0gJGJ1aWxkKCdyZXNwb25zZScsIHsKICAgICAgICAgIHhtbG5zOiBTdHJvcGhlLk5TLlNBU0wKICAgICAgfSk7CiAgICAgIGlmIChyZXNwb25zZSAhPT0gIiIpIHsKICAgICAgICBzdGFuemEudChCYXNlNjQuZW5jb2RlKHJlc3BvbnNlKSk7CiAgICAgIH0KICAgICAgdGhpcy5zZW5kKHN0YW56YS50cmVlKCkpOwoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9hdXRoMV9jYgogICAgICogIF9Qcml2YXRlXyBoYW5kbGVyIGZvciBsZWdhY3kgYXV0aGVudGljYXRpb24uCiAgICAgKgogICAgICogIFRoaXMgaGFuZGxlciBpcyBjYWxsZWQgaW4gcmVzcG9uc2UgdG8gdGhlIGluaXRpYWwgPGlxIHR5cGU9J2dldCcvPgogICAgICogIGZvciBsZWdhY3kgYXV0aGVudGljYXRpb24uICBJdCBidWlsZHMgYW4gYXV0aGVudGljYXRpb24gPGlxLz4gYW5kCiAgICAgKiAgc2VuZHMgaXQsIGNyZWF0aW5nIGEgaGFuZGxlciAoY2FsbGluZyBiYWNrIHRvIF9hdXRoMl9jYigpKSB0bwogICAgICogIGhhbmRsZSB0aGUgcmVzdWx0CiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoWE1MRWxlbWVudCkgZWxlbSAtIFRoZSBzdGFuemEgdGhhdCB0cmlnZ2VyZWQgdGhlIGNhbGxiYWNrLgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgZmFsc2UgdG8gcmVtb3ZlIHRoZSBoYW5kbGVyLgogICAgICovCiAgICAvKiBqc2hpbnQgdW51c2VkOmZhbHNlICovCiAgICBfYXV0aDFfY2I6IGZ1bmN0aW9uIChlbGVtKQogICAgewogICAgICAgIC8vIGJ1aWxkIHBsYWludGV4dCBhdXRoIGlxCiAgICAgICAgdmFyIGlxID0gJGlxKHt0eXBlOiAic2V0IiwgaWQ6ICJfYXV0aF8yIn0pCiAgICAgICAgICAgIC5jKCdxdWVyeScsIHt4bWxuczogU3Ryb3BoZS5OUy5BVVRIfSkKICAgICAgICAgICAgLmMoJ3VzZXJuYW1lJywge30pLnQoU3Ryb3BoZS5nZXROb2RlRnJvbUppZCh0aGlzLmppZCkpCiAgICAgICAgICAgIC51cCgpCiAgICAgICAgICAgIC5jKCdwYXNzd29yZCcpLnQodGhpcy5wYXNzKTsKCiAgICAgICAgaWYgKCFTdHJvcGhlLmdldFJlc291cmNlRnJvbUppZCh0aGlzLmppZCkpIHsKICAgICAgICAgICAgLy8gc2luY2UgdGhlIHVzZXIgaGFzIG5vdCBzdXBwbGllZCBhIHJlc291cmNlLCB3ZSBwaWNrCiAgICAgICAgICAgIC8vIGEgZGVmYXVsdCBvbmUgaGVyZS4gIHVubGlrZSBvdGhlciBhdXRoIG1ldGhvZHMsIHRoZSBzZXJ2ZXIKICAgICAgICAgICAgLy8gY2Fubm90IGRvIHRoaXMgZm9yIHVzLgogICAgICAgICAgICB0aGlzLmppZCA9IFN0cm9waGUuZ2V0QmFyZUppZEZyb21KaWQodGhpcy5qaWQpICsgJy9zdHJvcGhlJzsKICAgICAgICB9CiAgICAgICAgaXEudXAoKS5jKCdyZXNvdXJjZScsIHt9KS50KFN0cm9waGUuZ2V0UmVzb3VyY2VGcm9tSmlkKHRoaXMuamlkKSk7CgogICAgICAgIHRoaXMuX2FkZFN5c0hhbmRsZXIodGhpcy5fYXV0aDJfY2IuYmluZCh0aGlzKSwgbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bGwsIG51bGwsICJfYXV0aF8yIik7CgogICAgICAgIHRoaXMuc2VuZChpcS50cmVlKCkpOwoKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAogICAgLyoganNoaW50IHVudXNlZDp0cnVlICovCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX3Nhc2xfc3VjY2Vzc19jYgogICAgICogIF9Qcml2YXRlXyBoYW5kbGVyIGZvciBzdWNjZXNmdWwgU0FTTCBhdXRoZW50aWNhdGlvbi4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChYTUxFbGVtZW50KSBlbGVtIC0gVGhlIG1hdGNoaW5nIHN0YW56YS4KICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgIGZhbHNlIHRvIHJlbW92ZSB0aGUgaGFuZGxlci4KICAgICAqLwogICAgX3Nhc2xfc3VjY2Vzc19jYjogZnVuY3Rpb24gKGVsZW0pCiAgICB7CiAgICAgICAgaWYgKHRoaXMuX3Nhc2xfZGF0YVsic2VydmVyLXNpZ25hdHVyZSJdKSB7CiAgICAgICAgICAgIHZhciBzZXJ2ZXJTaWduYXR1cmU7CiAgICAgICAgICAgIHZhciBzdWNjZXNzID0gQmFzZTY0LmRlY29kZShTdHJvcGhlLmdldFRleHQoZWxlbSkpOwogICAgICAgICAgICB2YXIgYXR0cmliTWF0Y2ggPSAvKFthLXpdKyk9KFteLF0rKSgsfCQpLzsKICAgICAgICAgICAgdmFyIG1hdGNoZXMgPSBzdWNjZXNzLm1hdGNoKGF0dHJpYk1hdGNoKTsKICAgICAgICAgICAgaWYgKG1hdGNoZXNbMV0gPT0gInYiKSB7CiAgICAgICAgICAgICAgICBzZXJ2ZXJTaWduYXR1cmUgPSBtYXRjaGVzWzJdOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoc2VydmVyU2lnbmF0dXJlICE9IHRoaXMuX3Nhc2xfZGF0YVsic2VydmVyLXNpZ25hdHVyZSJdKSB7CiAgICAgICAgICAgICAgLy8gcmVtb3ZlIG9sZCBoYW5kbGVycwogICAgICAgICAgICAgIHRoaXMuZGVsZXRlSGFuZGxlcih0aGlzLl9zYXNsX2ZhaWx1cmVfaGFuZGxlcik7CiAgICAgICAgICAgICAgdGhpcy5fc2FzbF9mYWlsdXJlX2hhbmRsZXIgPSBudWxsOwogICAgICAgICAgICAgIGlmICh0aGlzLl9zYXNsX2NoYWxsZW5nZV9oYW5kbGVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRlbGV0ZUhhbmRsZXIodGhpcy5fc2FzbF9jaGFsbGVuZ2VfaGFuZGxlcik7CiAgICAgICAgICAgICAgICB0aGlzLl9zYXNsX2NoYWxsZW5nZV9oYW5kbGVyID0gbnVsbDsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHRoaXMuX3Nhc2xfZGF0YSA9IHt9OwogICAgICAgICAgICAgIHJldHVybiB0aGlzLl9zYXNsX2ZhaWx1cmVfY2IobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIFN0cm9waGUuaW5mbygiU0FTTCBhdXRoZW50aWNhdGlvbiBzdWNjZWVkZWQuIik7CgogICAgICAgIGlmKHRoaXMuX3Nhc2xfbWVjaGFuaXNtKQogICAgICAgICAgdGhpcy5fc2FzbF9tZWNoYW5pc20ub25TdWNjZXNzKCk7CgogICAgICAgIC8vIHJlbW92ZSBvbGQgaGFuZGxlcnMKICAgICAgICB0aGlzLmRlbGV0ZUhhbmRsZXIodGhpcy5fc2FzbF9mYWlsdXJlX2hhbmRsZXIpOwogICAgICAgIHRoaXMuX3Nhc2xfZmFpbHVyZV9oYW5kbGVyID0gbnVsbDsKICAgICAgICBpZiAodGhpcy5fc2FzbF9jaGFsbGVuZ2VfaGFuZGxlcikgewogICAgICAgICAgICB0aGlzLmRlbGV0ZUhhbmRsZXIodGhpcy5fc2FzbF9jaGFsbGVuZ2VfaGFuZGxlcik7CiAgICAgICAgICAgIHRoaXMuX3Nhc2xfY2hhbGxlbmdlX2hhbmRsZXIgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fYWRkU3lzSGFuZGxlcih0aGlzLl9zYXNsX2F1dGgxX2NiLmJpbmQodGhpcyksIG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3RyZWFtOmZlYXR1cmVzIiwgbnVsbCwgbnVsbCk7CgogICAgICAgIC8vIHdlIG11c3Qgc2VuZCBhbiB4bXBwOnJlc3RhcnQgbm93CiAgICAgICAgdGhpcy5fc2VuZFJlc3RhcnQoKTsKCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfc2FzbF9hdXRoMV9jYgogICAgICogIF9Qcml2YXRlXyBoYW5kbGVyIHRvIHN0YXJ0IHN0cmVhbSBiaW5kaW5nLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFhNTEVsZW1lbnQpIGVsZW0gLSBUaGUgbWF0Y2hpbmcgc3RhbnphLgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgZmFsc2UgdG8gcmVtb3ZlIHRoZSBoYW5kbGVyLgogICAgICovCiAgICBfc2FzbF9hdXRoMV9jYjogZnVuY3Rpb24gKGVsZW0pCiAgICB7CiAgICAgICAgLy8gc2F2ZSBzdHJlYW06ZmVhdHVyZXMgZm9yIGZ1dHVyZSB1c2FnZQogICAgICAgIHRoaXMuZmVhdHVyZXMgPSBlbGVtOwoKICAgICAgICB2YXIgaSwgY2hpbGQ7CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCBlbGVtLmNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY2hpbGQgPSBlbGVtLmNoaWxkTm9kZXNbaV07CiAgICAgICAgICAgIGlmIChjaGlsZC5ub2RlTmFtZSA9PSAnYmluZCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZG9fYmluZCA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjaGlsZC5ub2RlTmFtZSA9PSAnc2Vzc2lvbicpIHsKICAgICAgICAgICAgICAgIHRoaXMuZG9fc2Vzc2lvbiA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICghdGhpcy5kb19iaW5kKSB7CiAgICAgICAgICAgIHRoaXMuX2NoYW5nZUNvbm5lY3RTdGF0dXMoU3Ryb3BoZS5TdGF0dXMuQVVUSEZBSUwsIG51bGwpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fYWRkU3lzSGFuZGxlcih0aGlzLl9zYXNsX2JpbmRfY2IuYmluZCh0aGlzKSwgbnVsbCwgbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBudWxsLCAiX2JpbmRfYXV0aF8yIik7CgogICAgICAgICAgICB2YXIgcmVzb3VyY2UgPSBTdHJvcGhlLmdldFJlc291cmNlRnJvbUppZCh0aGlzLmppZCk7CiAgICAgICAgICAgIGlmIChyZXNvdXJjZSkgewogICAgICAgICAgICAgICAgdGhpcy5zZW5kKCRpcSh7dHlwZTogInNldCIsIGlkOiAiX2JpbmRfYXV0aF8yIn0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgLmMoJ2JpbmQnLCB7eG1sbnM6IFN0cm9waGUuTlMuQklORH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgLmMoJ3Jlc291cmNlJywge30pLnQocmVzb3VyY2UpLnRyZWUoKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNlbmQoJGlxKHt0eXBlOiAic2V0IiwgaWQ6ICJfYmluZF9hdXRoXzIifSkKICAgICAgICAgICAgICAgICAgICAgICAgICAuYygnYmluZCcsIHt4bWxuczogU3Ryb3BoZS5OUy5CSU5EfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAudHJlZSgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfc2FzbF9iaW5kX2NiCiAgICAgKiAgX1ByaXZhdGVfIGhhbmRsZXIgZm9yIGJpbmRpbmcgcmVzdWx0IGFuZCBzZXNzaW9uIHN0YXJ0LgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFhNTEVsZW1lbnQpIGVsZW0gLSBUaGUgbWF0Y2hpbmcgc3RhbnphLgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgZmFsc2UgdG8gcmVtb3ZlIHRoZSBoYW5kbGVyLgogICAgICovCiAgICBfc2FzbF9iaW5kX2NiOiBmdW5jdGlvbiAoZWxlbSkKICAgIHsKICAgICAgICBpZiAoZWxlbS5nZXRBdHRyaWJ1dGUoInR5cGUiKSA9PSAiZXJyb3IiKSB7CiAgICAgICAgICAgIFN0cm9waGUuaW5mbygiU0FTTCBiaW5kaW5nIGZhaWxlZC4iKTsKICAgICAgICAgICAgdmFyIGNvbmZsaWN0ID0gZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiY29uZmxpY3QiKSwgY29uZGl0aW9uOwogICAgICAgICAgICBpZiAoY29uZmxpY3QubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgY29uZGl0aW9uID0gJ2NvbmZsaWN0JzsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9jaGFuZ2VDb25uZWN0U3RhdHVzKFN0cm9waGUuU3RhdHVzLkFVVEhGQUlMLCBjb25kaXRpb24pOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICAvLyBUT0RPIC0gbmVlZCB0byBncmFiIGVycm9ycwogICAgICAgIHZhciBiaW5kID0gZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYmluZCIpOwogICAgICAgIHZhciBqaWROb2RlOwogICAgICAgIGlmIChiaW5kLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgLy8gR3JhYiBqaWQKICAgICAgICAgICAgamlkTm9kZSA9IGJpbmRbMF0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoImppZCIpOwogICAgICAgICAgICBpZiAoamlkTm9kZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmppZCA9IFN0cm9waGUuZ2V0VGV4dChqaWROb2RlWzBdKTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5kb19zZXNzaW9uKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWRkU3lzSGFuZGxlcih0aGlzLl9zYXNsX3Nlc3Npb25fY2IuYmluZCh0aGlzKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bGwsIG51bGwsIG51bGwsICJfc2Vzc2lvbl9hdXRoXzIiKTsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZW5kKCRpcSh7dHlwZTogInNldCIsIGlkOiAiX3Nlc3Npb25fYXV0aF8yIn0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYygnc2Vzc2lvbicsIHt4bWxuczogU3Ryb3BoZS5OUy5TRVNTSU9OfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50cmVlKCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmF1dGhlbnRpY2F0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2NoYW5nZUNvbm5lY3RTdGF0dXMoU3Ryb3BoZS5TdGF0dXMuQ09OTkVDVEVELCBudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIFN0cm9waGUuaW5mbygiU0FTTCBiaW5kaW5nIGZhaWxlZC4iKTsKICAgICAgICAgICAgdGhpcy5fY2hhbmdlQ29ubmVjdFN0YXR1cyhTdHJvcGhlLlN0YXR1cy5BVVRIRkFJTCwgbnVsbCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9zYXNsX3Nlc3Npb25fY2IKICAgICAqICBfUHJpdmF0ZV8gaGFuZGxlciB0byBmaW5pc2ggc3VjY2Vzc2Z1bCBTQVNMIGNvbm5lY3Rpb24uCiAgICAgKgogICAgICogIFRoaXMgc2V0cyBDb25uZWN0aW9uLmF1dGhlbnRpY2F0ZWQgdG8gdHJ1ZSBvbiBzdWNjZXNzLCB3aGljaAogICAgICogIHN0YXJ0cyB0aGUgcHJvY2Vzc2luZyBvZiB1c2VyIGhhbmRsZXJzLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFhNTEVsZW1lbnQpIGVsZW0gLSBUaGUgbWF0Y2hpbmcgc3RhbnphLgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgZmFsc2UgdG8gcmVtb3ZlIHRoZSBoYW5kbGVyLgogICAgICovCiAgICBfc2FzbF9zZXNzaW9uX2NiOiBmdW5jdGlvbiAoZWxlbSkKICAgIHsKICAgICAgICBpZiAoZWxlbS5nZXRBdHRyaWJ1dGUoInR5cGUiKSA9PSAicmVzdWx0IikgewogICAgICAgICAgICB0aGlzLmF1dGhlbnRpY2F0ZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLl9jaGFuZ2VDb25uZWN0U3RhdHVzKFN0cm9waGUuU3RhdHVzLkNPTk5FQ1RFRCwgbnVsbCk7CiAgICAgICAgfSBlbHNlIGlmIChlbGVtLmdldEF0dHJpYnV0ZSgidHlwZSIpID09ICJlcnJvciIpIHsKICAgICAgICAgICAgU3Ryb3BoZS5pbmZvKCJTZXNzaW9uIGNyZWF0aW9uIGZhaWxlZC4iKTsKICAgICAgICAgICAgdGhpcy5fY2hhbmdlQ29ubmVjdFN0YXR1cyhTdHJvcGhlLlN0YXR1cy5BVVRIRkFJTCwgbnVsbCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX3Nhc2xfZmFpbHVyZV9jYgogICAgICogIF9Qcml2YXRlXyBoYW5kbGVyIGZvciBTQVNMIGF1dGhlbnRpY2F0aW9uIGZhaWx1cmUuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoWE1MRWxlbWVudCkgZWxlbSAtIFRoZSBtYXRjaGluZyBzdGFuemEuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBmYWxzZSB0byByZW1vdmUgdGhlIGhhbmRsZXIuCiAgICAgKi8KICAgIC8qIGpzaGludCB1bnVzZWQ6ZmFsc2UgKi8KICAgIF9zYXNsX2ZhaWx1cmVfY2I6IGZ1bmN0aW9uIChlbGVtKQogICAgewogICAgICAgIC8vIGRlbGV0ZSB1bm5lZWRlZCBoYW5kbGVycwogICAgICAgIGlmICh0aGlzLl9zYXNsX3N1Y2Nlc3NfaGFuZGxlcikgewogICAgICAgICAgICB0aGlzLmRlbGV0ZUhhbmRsZXIodGhpcy5fc2FzbF9zdWNjZXNzX2hhbmRsZXIpOwogICAgICAgICAgICB0aGlzLl9zYXNsX3N1Y2Nlc3NfaGFuZGxlciA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9zYXNsX2NoYWxsZW5nZV9oYW5kbGVyKSB7CiAgICAgICAgICAgIHRoaXMuZGVsZXRlSGFuZGxlcih0aGlzLl9zYXNsX2NoYWxsZW5nZV9oYW5kbGVyKTsKICAgICAgICAgICAgdGhpcy5fc2FzbF9jaGFsbGVuZ2VfaGFuZGxlciA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZih0aGlzLl9zYXNsX21lY2hhbmlzbSkKICAgICAgICAgIHRoaXMuX3Nhc2xfbWVjaGFuaXNtLm9uRmFpbHVyZSgpOwogICAgICAgIHRoaXMuX2NoYW5nZUNvbm5lY3RTdGF0dXMoU3Ryb3BoZS5TdGF0dXMuQVVUSEZBSUwsIG51bGwpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCiAgICAvKiBqc2hpbnQgdW51c2VkOnRydWUgKi8KCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfYXV0aDJfY2IKICAgICAqICBfUHJpdmF0ZV8gaGFuZGxlciB0byBmaW5pc2ggbGVnYWN5IGF1dGhlbnRpY2F0aW9uLgogICAgICoKICAgICAqICBUaGlzIGhhbmRsZXIgaXMgY2FsbGVkIHdoZW4gdGhlIHJlc3VsdCBmcm9tIHRoZSBqYWJiZXI6aXE6YXV0aAogICAgICogIDxpcS8+IHN0YW56YSBpcyByZXR1cm5lZC4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChYTUxFbGVtZW50KSBlbGVtIC0gVGhlIHN0YW56YSB0aGF0IHRyaWdnZXJlZCB0aGUgY2FsbGJhY2suCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBmYWxzZSB0byByZW1vdmUgdGhlIGhhbmRsZXIuCiAgICAgKi8KICAgIF9hdXRoMl9jYjogZnVuY3Rpb24gKGVsZW0pCiAgICB7CiAgICAgICAgaWYgKGVsZW0uZ2V0QXR0cmlidXRlKCJ0eXBlIikgPT0gInJlc3VsdCIpIHsKICAgICAgICAgICAgdGhpcy5hdXRoZW50aWNhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5fY2hhbmdlQ29ubmVjdFN0YXR1cyhTdHJvcGhlLlN0YXR1cy5DT05ORUNURUQsIG51bGwpOwogICAgICAgIH0gZWxzZSBpZiAoZWxlbS5nZXRBdHRyaWJ1dGUoInR5cGUiKSA9PSAiZXJyb3IiKSB7CiAgICAgICAgICAgIHRoaXMuX2NoYW5nZUNvbm5lY3RTdGF0dXMoU3Ryb3BoZS5TdGF0dXMuQVVUSEZBSUwsIG51bGwpOwogICAgICAgICAgICB0aGlzLmRpc2Nvbm5lY3QoJ2F1dGhlbnRpY2F0aW9uIGZhaWxlZCcpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfYWRkU3lzVGltZWRIYW5kbGVyCiAgICAgKiAgX1ByaXZhdGVfIGZ1bmN0aW9uIHRvIGFkZCBhIHN5c3RlbSBsZXZlbCB0aW1lZCBoYW5kbGVyLgogICAgICoKICAgICAqICBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gYWRkIGEgU3Ryb3BoZS5UaW1lZEhhbmRsZXIgZm9yIHRoZQogICAgICogIGxpYnJhcnkgY29kZS4gIFN5c3RlbSB0aW1lZCBoYW5kbGVycyBhcmUgYWxsb3dlZCB0byBydW4gYmVmb3JlCiAgICAgKiAgYXV0aGVudGljYXRpb24gaXMgY29tcGxldGUuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoSW50ZWdlcikgcGVyaW9kIC0gVGhlIHBlcmlvZCBvZiB0aGUgaGFuZGxlci4KICAgICAqICAgIChGdW5jdGlvbikgaGFuZGxlciAtIFRoZSBjYWxsYmFjayBmdW5jdGlvbi4KICAgICAqLwogICAgX2FkZFN5c1RpbWVkSGFuZGxlcjogZnVuY3Rpb24gKHBlcmlvZCwgaGFuZGxlcikKICAgIHsKICAgICAgICB2YXIgdGhhbmQgPSBuZXcgU3Ryb3BoZS5UaW1lZEhhbmRsZXIocGVyaW9kLCBoYW5kbGVyKTsKICAgICAgICB0aGFuZC51c2VyID0gZmFsc2U7CiAgICAgICAgdGhpcy5hZGRUaW1lZHMucHVzaCh0aGFuZCk7CiAgICAgICAgcmV0dXJuIHRoYW5kOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfYWRkU3lzSGFuZGxlcgogICAgICogIF9Qcml2YXRlXyBmdW5jdGlvbiB0byBhZGQgYSBzeXN0ZW0gbGV2ZWwgc3RhbnphIGhhbmRsZXIuCiAgICAgKgogICAgICogIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhZGQgYSBTdHJvcGhlLkhhbmRsZXIgZm9yIHRoZQogICAgICogIGxpYnJhcnkgY29kZS4gIFN5c3RlbSBzdGFuemEgaGFuZGxlcnMgYXJlIGFsbG93ZWQgdG8gcnVuIGJlZm9yZQogICAgICogIGF1dGhlbnRpY2F0aW9uIGlzIGNvbXBsZXRlLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKEZ1bmN0aW9uKSBoYW5kbGVyIC0gVGhlIGNhbGxiYWNrIGZ1bmN0aW9uLgogICAgICogICAgKFN0cmluZykgbnMgLSBUaGUgbmFtZXNwYWNlIHRvIG1hdGNoLgogICAgICogICAgKFN0cmluZykgbmFtZSAtIFRoZSBzdGFuemEgbmFtZSB0byBtYXRjaC4KICAgICAqICAgIChTdHJpbmcpIHR5cGUgLSBUaGUgc3RhbnphIHR5cGUgYXR0cmlidXRlIHRvIG1hdGNoLgogICAgICogICAgKFN0cmluZykgaWQgLSBUaGUgc3RhbnphIGlkIGF0dHJpYnV0ZSB0byBtYXRjaC4KICAgICAqLwogICAgX2FkZFN5c0hhbmRsZXI6IGZ1bmN0aW9uIChoYW5kbGVyLCBucywgbmFtZSwgdHlwZSwgaWQpCiAgICB7CiAgICAgICAgdmFyIGhhbmQgPSBuZXcgU3Ryb3BoZS5IYW5kbGVyKGhhbmRsZXIsIG5zLCBuYW1lLCB0eXBlLCBpZCk7CiAgICAgICAgaGFuZC51c2VyID0gZmFsc2U7CiAgICAgICAgdGhpcy5hZGRIYW5kbGVycy5wdXNoKGhhbmQpOwogICAgICAgIHJldHVybiBoYW5kOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfb25EaXNjb25uZWN0VGltZW91dAogICAgICogIF9Qcml2YXRlXyB0aW1lb3V0IGhhbmRsZXIgZm9yIGhhbmRsaW5nIG5vbi1ncmFjZWZ1bCBkaXNjb25uZWN0aW9uLgogICAgICoKICAgICAqICBJZiB0aGUgZ3JhY2VmdWwgZGlzY29ubmVjdCBwcm9jZXNzIGRvZXMgbm90IGNvbXBsZXRlIHdpdGhpbiB0aGUKICAgICAqICB0aW1lIGFsbG90dGVkLCB0aGlzIGhhbmRsZXIgZmluaXNoZXMgdGhlIGRpc2Nvbm5lY3QgYW55d2F5LgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgZmFsc2UgdG8gcmVtb3ZlIHRoZSBoYW5kbGVyLgogICAgICovCiAgICBfb25EaXNjb25uZWN0VGltZW91dDogZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICBTdHJvcGhlLmluZm8oIl9vbkRpc2Nvbm5lY3RUaW1lb3V0IHdhcyBjYWxsZWQiKTsKCiAgICAgICAgdGhpcy5fcHJvdG8uX29uRGlzY29ubmVjdFRpbWVvdXQoKTsKCiAgICAgICAgLy8gYWN0dWFsbHkgZGlzY29ubmVjdAogICAgICAgIHRoaXMuX2RvRGlzY29ubmVjdCgpOwoKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9vbklkbGUKICAgICAqICBfUHJpdmF0ZV8gaGFuZGxlciB0byBwcm9jZXNzIGV2ZW50cyBkdXJpbmcgaWRsZSBjeWNsZS4KICAgICAqCiAgICAgKiAgVGhpcyBoYW5kbGVyIGlzIGNhbGxlZCBldmVyeSAxMDBtcyB0byBmaXJlIHRpbWVkIGhhbmRsZXJzIHRoYXQKICAgICAqICBhcmUgcmVhZHkgYW5kIGtlZXAgcG9sbCByZXF1ZXN0cyBnb2luZy4KICAgICAqLwogICAgX29uSWRsZTogZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICB2YXIgaSwgdGhhbmQsIHNpbmNlLCBuZXdMaXN0OwoKICAgICAgICAvLyBhZGQgdGltZWQgaGFuZGxlcnMgc2NoZWR1bGVkIGZvciBhZGRpdGlvbgogICAgICAgIC8vIE5PVEU6IHdlIGFkZCBiZWZvcmUgcmVtb3ZlIGluIHRoZSBjYXNlIGEgdGltZWQgaGFuZGxlciBpcwogICAgICAgIC8vIGFkZGVkIGFuZCB0aGVuIGRlbGV0ZWQgYmVmb3JlIHRoZSBuZXh0IF9vbklkbGUoKSBjYWxsLgogICAgICAgIHdoaWxlICh0aGlzLmFkZFRpbWVkcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHRoaXMudGltZWRIYW5kbGVycy5wdXNoKHRoaXMuYWRkVGltZWRzLnBvcCgpKTsKICAgICAgICB9CgogICAgICAgIC8vIHJlbW92ZSB0aW1lZCBoYW5kbGVycyB0aGF0IGhhdmUgYmVlbiBzY2hlZHVsZWQgZm9yIGRlbGV0aW9uCiAgICAgICAgd2hpbGUgKHRoaXMucmVtb3ZlVGltZWRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdGhhbmQgPSB0aGlzLnJlbW92ZVRpbWVkcy5wb3AoKTsKICAgICAgICAgICAgaSA9IHRoaXMudGltZWRIYW5kbGVycy5pbmRleE9mKHRoYW5kKTsKICAgICAgICAgICAgaWYgKGkgPj0gMCkgewogICAgICAgICAgICAgICAgdGhpcy50aW1lZEhhbmRsZXJzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gY2FsbCByZWFkeSB0aW1lZCBoYW5kbGVycwogICAgICAgIHZhciBub3cgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgICAgICBuZXdMaXN0ID0gW107CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHRoaXMudGltZWRIYW5kbGVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB0aGFuZCA9IHRoaXMudGltZWRIYW5kbGVyc1tpXTsKICAgICAgICAgICAgaWYgKHRoaXMuYXV0aGVudGljYXRlZCB8fCAhdGhhbmQudXNlcikgewogICAgICAgICAgICAgICAgc2luY2UgPSB0aGFuZC5sYXN0Q2FsbGVkICsgdGhhbmQucGVyaW9kOwogICAgICAgICAgICAgICAgaWYgKHNpbmNlIC0gbm93IDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhhbmQucnVuKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmV3TGlzdC5wdXNoKHRoYW5kKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG5ld0xpc3QucHVzaCh0aGFuZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy50aW1lZEhhbmRsZXJzID0gbmV3TGlzdDsKCiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX2lkbGVUaW1lb3V0KTsKCiAgICAgICAgdGhpcy5fcHJvdG8uX29uSWRsZSgpOwoKICAgICAgICAvLyByZWFjdGl2YXRlIHRoZSB0aW1lciBvbmx5IGlmIGNvbm5lY3RlZAogICAgICAgIGlmICh0aGlzLmNvbm5lY3RlZCkgewogICAgICAgICAgICB0aGlzLl9pZGxlVGltZW91dCA9IHNldFRpbWVvdXQodGhpcy5fb25JZGxlLmJpbmQodGhpcyksIDEwMCk7CiAgICAgICAgfQogICAgfQp9OwoKaWYgKGNhbGxiYWNrKSB7CiAgICBjYWxsYmFjayhTdHJvcGhlLCAkYnVpbGQsICRtc2csICRpcSwgJHByZXMpOwp9CgovKiogQ2xhc3M6IFN0cm9waGUuU0FTTE1lY2hhbmlzbQogKgogKiAgZW5jYXBzdWxhdGVzIFNBU0wgYXV0aGVudGljYXRpb24gbWVjaGFuaXNtcy4KICoKICogIFVzZXIgY29kZSBtYXkgb3ZlcnJpZGUgdGhlIHByaW9yaXR5IGZvciBlYWNoIG1lY2hhbmlzbSBvciBkaXNhYmxlIGl0IGNvbXBsZXRlbHkuCiAqICBTZWUgPHByaW9yaXR5PiBmb3IgaW5mb3JtYXRpb24gYWJvdXQgY2hhbmdpbmcgcHJpb3JpdHkgYW5kIDx0ZXN0PiBmb3IgaW5mb3JtYXRpYW4gb24KICogIGhvdyB0byBkaXNhYmxlIGEgbWVjaGFuaXNtLgogKgogKiAgQnkgZGVmYXVsdCwgYWxsIG1lY2hhbmlzbXMgYXJlIGVuYWJsZWQgYW5kIHRoZSBwcmlvcml0aWVzIGFyZQogKgogKiAgU0NSQU0tU0hBMSAtIDQwCiAqICBESUdFU1QtTUQ1IC0gMzAKICogIFBsYWluIC0gMjAKICovCgovKioKICogUHJpdmF0ZUNvbnN0cnVjdG9yOiBTdHJvcGhlLlNBU0xNZWNoYW5pc20KICogU0FTTCBhdXRoIG1lY2hhbmlzbSBhYnN0cmFjdGlvbi4KICoKICogIFBhcmFtZXRlcnM6CiAqICAgIChTdHJpbmcpIG5hbWUgLSBTQVNMIE1lY2hhbmlzbSBuYW1lLgogKiAgICAoQm9vbGVhbikgaXNDbGllbnRGaXJzdCAtIElmIGNsaWVudCBzaG91bGQgc2VuZCByZXNwb25zZSBmaXJzdCB3aXRob3V0IGNoYWxsZW5nZS4KICogICAgKE51bWJlcikgcHJpb3JpdHkgLSBQcmlvcml0eS4KICoKICogIFJldHVybnM6CiAqICAgIEEgbmV3IFN0cm9waGUuU0FTTE1lY2hhbmlzbSBvYmplY3QuCiAqLwpTdHJvcGhlLlNBU0xNZWNoYW5pc20gPSBmdW5jdGlvbihuYW1lLCBpc0NsaWVudEZpcnN0LCBwcmlvcml0eSkgewogIC8qKiBQcml2YXRlVmFyaWFibGU6IG5hbWUKICAgKiAgTWVjaGFuaXNtIG5hbWUuCiAgICovCiAgdGhpcy5uYW1lID0gbmFtZTsKICAvKiogUHJpdmF0ZVZhcmlhYmxlOiBpc0NsaWVudEZpcnN0CiAgICogIElmIGNsaWVudCBzZW5kcyByZXNwb25zZSB3aXRob3V0IGluaXRpYWwgc2VydmVyIGNoYWxsZW5nZS4KICAgKi8KICB0aGlzLmlzQ2xpZW50Rmlyc3QgPSBpc0NsaWVudEZpcnN0OwogIC8qKiBWYXJpYWJsZTogcHJpb3JpdHkKICAgKiAgRGV0ZXJtaW5lcyB3aGljaCA8U0FTTE1lY2hhbmlzbT4gaXMgY2hvc2VuIGZvciBhdXRoZW50aWNhdGlvbiAoSGlnaGVyIGlzIGJldHRlcikuCiAgICogIFVzZXJzIG1heSBvdmVycmlkZSB0aGlzIHRvIHByaW9yaXRpemUgbWVjaGFuaXNtcyBkaWZmZXJlbnRseS4KICAgKgogICAqICBJbiB0aGUgZGVmYXVsdCBjb25maWd1cmF0aW9uIHRoZSBwcmlvcml0aWVzIGFyZQogICAqCiAgICogIFNDUkFNLVNIQTEgLSA0MAogICAqICBESUdFU1QtTUQ1IC0gMzAKICAgKiAgUGxhaW4gLSAyMAogICAqCiAgICogIEV4YW1wbGU6IChUaGlzIHdpbGwgY2F1c2UgU3Ryb3BoZSB0byBjaG9vc2UgdGhlIG1lY2hhbmlzbSB0aGF0IHRoZSBzZXJ2ZXIgc2VudCBmaXJzdCkKICAgKgogICAqICA+IFN0cm9waGUuU0FTTE1ENS5wcmlvcml0eSA9IFN0cm9waGUuU0FTTFNIQTEucHJpb3JpdHk7CiAgICoKICAgKiAgU2VlIDxTQVNMIG1lY2hhbmlzbXM+IGZvciBhIGxpc3Qgb2YgYXZhaWxhYmxlIG1lY2hhbmlzbXMuCiAgICoKICAgKi8KICB0aGlzLnByaW9yaXR5ID0gcHJpb3JpdHk7Cn07CgpTdHJvcGhlLlNBU0xNZWNoYW5pc20ucHJvdG90eXBlID0gewogIC8qKgogICAqICBGdW5jdGlvbjogdGVzdAogICAqICBDaGVja3MgaWYgbWVjaGFuaXNtIGFibGUgdG8gcnVuLgogICAqICBUbyBkaXNhYmxlIGEgbWVjaGFuaXNtLCBtYWtlIHRoaXMgcmV0dXJuIGZhbHNlOwogICAqCiAgICogIFRvIGRpc2FibGUgcGxhaW4gYXV0aGVudGljYXRpb24gcnVuCiAgICogID4gU3Ryb3BoZS5TQVNMUGxhaW4udGVzdCA9IGZ1bmN0aW9uKCkgewogICAqICA+ICAgcmV0dXJuIGZhbHNlOwogICAqICA+IH0KICAgKgogICAqICBTZWUgPFNBU0wgbWVjaGFuaXNtcz4gZm9yIGEgbGlzdCBvZiBhdmFpbGFibGUgbWVjaGFuaXNtcy4KICAgKgogICAqICBQYXJhbWV0ZXJzOgogICAqICAgIChTdHJvcGhlLkNvbm5lY3Rpb24pIGNvbm5lY3Rpb24gLSBUYXJnZXQgQ29ubmVjdGlvbi4KICAgKgogICAqICBSZXR1cm5zOgogICAqICAgIChCb29sZWFuKSBJZiBtZWNoYW5pc20gd2FzIGFibGUgdG8gcnVuLgogICAqLwogIC8qIGpzaGludCB1bnVzZWQ6ZmFsc2UgKi8KICB0ZXN0OiBmdW5jdGlvbihjb25uZWN0aW9uKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9LAogIC8qIGpzaGludCB1bnVzZWQ6dHJ1ZSAqLwoKICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBvblN0YXJ0CiAgICogIENhbGxlZCBiZWZvcmUgc3RhcnRpbmcgbWVjaGFuaXNtIG9uIHNvbWUgY29ubmVjdGlvbi4KICAgKgogICAqICBQYXJhbWV0ZXJzOgogICAqICAgIChTdHJvcGhlLkNvbm5lY3Rpb24pIGNvbm5lY3Rpb24gLSBUYXJnZXQgQ29ubmVjdGlvbi4KICAgKi8KICBvblN0YXJ0OiBmdW5jdGlvbihjb25uZWN0aW9uKQogIHsKICAgIHRoaXMuX2Nvbm5lY3Rpb24gPSBjb25uZWN0aW9uOwogIH0sCgogIC8qKiBQcml2YXRlRnVuY3Rpb246IG9uQ2hhbGxlbmdlCiAgICogIENhbGxlZCBieSBwcm90b2NvbCBpbXBsZW1lbnRhdGlvbiBvbiBpbmNvbWluZyBjaGFsbGVuZ2UuIElmIGNsaWVudCBpcwogICAqICBmaXJzdCAoaXNDbGllbnRGaXJzdCA9PSB0cnVlKSBjaGFsbGVuZ2Ugd2lsbCBiZSBudWxsIG9uIHRoZSBmaXJzdCBjYWxsLgogICAqCiAgICogIFBhcmFtZXRlcnM6CiAgICogICAgKFN0cm9waGUuQ29ubmVjdGlvbikgY29ubmVjdGlvbiAtIFRhcmdldCBDb25uZWN0aW9uLgogICAqICAgIChTdHJpbmcpIGNoYWxsZW5nZSAtIGN1cnJlbnQgY2hhbGxlbmdlIHRvIGhhbmRsZS4KICAgKgogICAqICBSZXR1cm5zOgogICAqICAgIChTdHJpbmcpIE1lY2hhbmlzbSByZXNwb25zZS4KICAgKi8KICAvKiBqc2hpbnQgdW51c2VkOmZhbHNlICovCiAgb25DaGFsbGVuZ2U6IGZ1bmN0aW9uKGNvbm5lY3Rpb24sIGNoYWxsZW5nZSkgewogICAgdGhyb3cgbmV3IEVycm9yKCJZb3Ugc2hvdWxkIGltcGxlbWVudCBjaGFsbGVuZ2UgaGFuZGxpbmchIik7CiAgfSwKICAvKiBqc2hpbnQgdW51c2VkOnRydWUgKi8KCiAgLyoqIFByaXZhdGVGdW5jdGlvbjogb25GYWlsdXJlCiAgICogIFByb3RvY29sIGluZm9ybXMgbWVjaGFuaXNtIGltcGxlbWVudGF0aW9uIGFib3V0IFNBU0wgZmFpbHVyZS4KICAgKi8KICBvbkZhaWx1cmU6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fY29ubmVjdGlvbiA9IG51bGw7CiAgfSwKCiAgLyoqIFByaXZhdGVGdW5jdGlvbjogb25TdWNjZXNzCiAgICogIFByb3RvY29sIGluZm9ybXMgbWVjaGFuaXNtIGltcGxlbWVudGF0aW9uIGFib3V0IFNBU0wgc3VjY2Vzcy4KICAgKi8KICBvblN1Y2Nlc3M6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fY29ubmVjdGlvbiA9IG51bGw7CiAgfQp9OwoKICAvKiogQ29uc3RhbnRzOiBTQVNMIG1lY2hhbmlzbXMKICAgKiAgQXZhaWxhYmxlIGF1dGhlbnRpY2F0aW9uIG1lY2hhbmlzbXMKICAgKgogICAqICBTdHJvcGhlLlNBU0xBbm9ueW1vdXMgLSBTQVNMIEFub255bW91cyBhdXRoZW50aWNhdGlvbi4KICAgKiAgU3Ryb3BoZS5TQVNMUGxhaW4gLSBTQVNMIFBsYWluIGF1dGhlbnRpY2F0aW9uLgogICAqICBTdHJvcGhlLlNBU0xNRDUgLSBTQVNMIERpZ2VzdC1NRDUgYXV0aGVudGljYXRpb24KICAgKiAgU3Ryb3BoZS5TQVNMU0hBMSAtIFNBU0wgU0NSQU0tU0hBMSBhdXRoZW50aWNhdGlvbgogICAqLwoKLy8gQnVpbGRpbmcgU0FTTCBjYWxsYmFja3MKCi8qKiBQcml2YXRlQ29uc3RydWN0b3I6IFNBU0xBbm9ueW1vdXMKICogIFNBU0wgQW5vbnltb3VzIGF1dGhlbnRpY2F0aW9uLgogKi8KU3Ryb3BoZS5TQVNMQW5vbnltb3VzID0gZnVuY3Rpb24oKSB7fTsKClN0cm9waGUuU0FTTEFub255bW91cy5wcm90b3R5cGUgPSBuZXcgU3Ryb3BoZS5TQVNMTWVjaGFuaXNtKCJBTk9OWU1PVVMiLCBmYWxzZSwgMTApOwoKU3Ryb3BoZS5TQVNMQW5vbnltb3VzLnRlc3QgPSBmdW5jdGlvbihjb25uZWN0aW9uKSB7CiAgcmV0dXJuIGNvbm5lY3Rpb24uYXV0aGNpZCA9PT0gbnVsbDsKfTsKClN0cm9waGUuQ29ubmVjdGlvbi5wcm90b3R5cGUubWVjaGFuaXNtc1tTdHJvcGhlLlNBU0xBbm9ueW1vdXMucHJvdG90eXBlLm5hbWVdID0gU3Ryb3BoZS5TQVNMQW5vbnltb3VzOwoKLyoqIFByaXZhdGVDb25zdHJ1Y3RvcjogU0FTTFBsYWluCiAqICBTQVNMIFBsYWluIGF1dGhlbnRpY2F0aW9uLgogKi8KU3Ryb3BoZS5TQVNMUGxhaW4gPSBmdW5jdGlvbigpIHt9OwoKU3Ryb3BoZS5TQVNMUGxhaW4ucHJvdG90eXBlID0gbmV3IFN0cm9waGUuU0FTTE1lY2hhbmlzbSgiUExBSU4iLCB0cnVlLCAyMCk7CgpTdHJvcGhlLlNBU0xQbGFpbi50ZXN0ID0gZnVuY3Rpb24oY29ubmVjdGlvbikgewogIHJldHVybiBjb25uZWN0aW9uLmF1dGhjaWQgIT09IG51bGw7Cn07CgpTdHJvcGhlLlNBU0xQbGFpbi5wcm90b3R5cGUub25DaGFsbGVuZ2UgPSBmdW5jdGlvbihjb25uZWN0aW9uKSB7CiAgdmFyIGF1dGhfc3RyID0gY29ubmVjdGlvbi5hdXRoemlkOwogIGF1dGhfc3RyID0gYXV0aF9zdHIgKyAiXHUwMDAwIjsKICBhdXRoX3N0ciA9IGF1dGhfc3RyICsgY29ubmVjdGlvbi5hdXRoY2lkOwogIGF1dGhfc3RyID0gYXV0aF9zdHIgKyAiXHUwMDAwIjsKICBhdXRoX3N0ciA9IGF1dGhfc3RyICsgY29ubmVjdGlvbi5wYXNzOwogIHJldHVybiBhdXRoX3N0cjsKfTsKClN0cm9waGUuQ29ubmVjdGlvbi5wcm90b3R5cGUubWVjaGFuaXNtc1tTdHJvcGhlLlNBU0xQbGFpbi5wcm90b3R5cGUubmFtZV0gPSBTdHJvcGhlLlNBU0xQbGFpbjsKCi8qKiBQcml2YXRlQ29uc3RydWN0b3I6IFNBU0xTSEExCiAqICBTQVNMIFNDUkFNIFNIQSAxIGF1dGhlbnRpY2F0aW9uLgogKi8KU3Ryb3BoZS5TQVNMU0hBMSA9IGZ1bmN0aW9uKCkge307CgovKiBURVNUOgogKiBUaGlzIGlzIGEgc2ltcGxlIGV4YW1wbGUgb2YgYSBTQ1JBTS1TSEEtMSBhdXRoZW50aWNhdGlvbiBleGNoYW5nZQogKiB3aGVuIHRoZSBjbGllbnQgZG9lc24ndCBzdXBwb3J0IGNoYW5uZWwgYmluZGluZ3MgKHVzZXJuYW1lICd1c2VyJyBhbmQKICogcGFzc3dvcmQgJ3BlbmNpbCcgYXJlIHVzZWQpOgogKgogKiBDOiBuLCxuPXVzZXIscj1meWtvK2QybGJiRmdPTlJ2OXFreGRhd0wKICogUzogcj1meWtvK2QybGJiRmdPTlJ2OXFreGRhd0wzcmZjTkhZSlkxWlZ2V1ZzN2oscz1RU1hDUitRNnNlazhiZjkyLAogKiBpPTQwOTYKICogQzogYz1iaXdzLHI9ZnlrbytkMmxiYkZnT05Sdjlxa3hkYXdMM3JmY05IWUpZMVpWdldWczdqLAogKiBwPXYwWDh2M0J6MlQwQ0pHYkpReUYwWCtISTRUcz0KICogUzogdj1ybUY5cHFWOFM3c3VBb1pXamE0ZEpSa0ZzS1E9CiAqCiAqLwoKU3Ryb3BoZS5TQVNMU0hBMS5wcm90b3R5cGUgPSBuZXcgU3Ryb3BoZS5TQVNMTWVjaGFuaXNtKCJTQ1JBTS1TSEEtMSIsIHRydWUsIDQwKTsKClN0cm9waGUuU0FTTFNIQTEudGVzdCA9IGZ1bmN0aW9uKGNvbm5lY3Rpb24pIHsKICByZXR1cm4gY29ubmVjdGlvbi5hdXRoY2lkICE9PSBudWxsOwp9OwoKU3Ryb3BoZS5TQVNMU0hBMS5wcm90b3R5cGUub25DaGFsbGVuZ2UgPSBmdW5jdGlvbihjb25uZWN0aW9uLCBjaGFsbGVuZ2UsIHRlc3RfY25vbmNlKSB7CiAgdmFyIGNub25jZSA9IHRlc3RfY25vbmNlIHx8IE1ENS5oZXhkaWdlc3QoTWF0aC5yYW5kb20oKSAqIDEyMzQ1Njc4OTApOwoKICB2YXIgYXV0aF9zdHIgPSAibj0iICsgY29ubmVjdGlvbi5hdXRoY2lkOwogIGF1dGhfc3RyICs9ICIscj0iOwogIGF1dGhfc3RyICs9IGNub25jZTsKCiAgY29ubmVjdGlvbi5fc2FzbF9kYXRhLmNub25jZSA9IGNub25jZTsKICBjb25uZWN0aW9uLl9zYXNsX2RhdGFbImNsaWVudC1maXJzdC1tZXNzYWdlLWJhcmUiXSA9IGF1dGhfc3RyOwoKICBhdXRoX3N0ciA9ICJuLCwiICsgYXV0aF9zdHI7CgogIHRoaXMub25DaGFsbGVuZ2UgPSBmdW5jdGlvbiAoY29ubmVjdGlvbiwgY2hhbGxlbmdlKQogIHsKICAgIHZhciBub25jZSwgc2FsdCwgaXRlciwgSGksIFUsIFVfb2xkLCBpLCBrOwogICAgdmFyIGNsaWVudEtleSwgc2VydmVyS2V5LCBjbGllbnRTaWduYXR1cmU7CiAgICB2YXIgcmVzcG9uc2VUZXh0ID0gImM9Yml3cywiOwogICAgdmFyIGF1dGhNZXNzYWdlID0gY29ubmVjdGlvbi5fc2FzbF9kYXRhWyJjbGllbnQtZmlyc3QtbWVzc2FnZS1iYXJlIl0gKyAiLCIgKwogICAgICBjaGFsbGVuZ2UgKyAiLCI7CiAgICB2YXIgY25vbmNlID0gY29ubmVjdGlvbi5fc2FzbF9kYXRhLmNub25jZTsKICAgIHZhciBhdHRyaWJNYXRjaCA9IC8oW2Etel0rKT0oW14sXSspKCx8JCkvOwoKICAgIHdoaWxlIChjaGFsbGVuZ2UubWF0Y2goYXR0cmliTWF0Y2gpKSB7CiAgICAgIHZhciBtYXRjaGVzID0gY2hhbGxlbmdlLm1hdGNoKGF0dHJpYk1hdGNoKTsKICAgICAgY2hhbGxlbmdlID0gY2hhbGxlbmdlLnJlcGxhY2UobWF0Y2hlc1swXSwgIiIpOwogICAgICBzd2l0Y2ggKG1hdGNoZXNbMV0pIHsKICAgICAgY2FzZSAiciI6CiAgICAgICAgbm9uY2UgPSBtYXRjaGVzWzJdOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJzIjoKICAgICAgICBzYWx0ID0gbWF0Y2hlc1syXTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiaSI6CiAgICAgICAgaXRlciA9IG1hdGNoZXNbMl07CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KCiAgICBpZiAobm9uY2Uuc3Vic3RyKDAsIGNub25jZS5sZW5ndGgpICE9PSBjbm9uY2UpIHsKICAgICAgY29ubmVjdGlvbi5fc2FzbF9kYXRhID0ge307CiAgICAgIHJldHVybiBjb25uZWN0aW9uLl9zYXNsX2ZhaWx1cmVfY2IoKTsKICAgIH0KCiAgICByZXNwb25zZVRleHQgKz0gInI9IiArIG5vbmNlOwogICAgYXV0aE1lc3NhZ2UgKz0gcmVzcG9uc2VUZXh0OwoKICAgIHNhbHQgPSBCYXNlNjQuZGVjb2RlKHNhbHQpOwogICAgc2FsdCArPSAiXHgwMFx4MDBceDAwXHgwMSI7CgogICAgSGkgPSBVX29sZCA9IGNvcmVfaG1hY19zaGExKGNvbm5lY3Rpb24ucGFzcywgc2FsdCk7CiAgICBmb3IgKGkgPSAxOyBpIDwgaXRlcjsgaSsrKSB7CiAgICAgIFUgPSBjb3JlX2htYWNfc2hhMShjb25uZWN0aW9uLnBhc3MsIGJpbmIyc3RyKFVfb2xkKSk7CiAgICAgIGZvciAoayA9IDA7IGsgPCA1OyBrKyspIHsKICAgICAgICBIaVtrXSBePSBVW2tdOwogICAgICB9CiAgICAgIFVfb2xkID0gVTsKICAgIH0KICAgIEhpID0gYmluYjJzdHIoSGkpOwoKICAgIGNsaWVudEtleSA9IGNvcmVfaG1hY19zaGExKEhpLCAiQ2xpZW50IEtleSIpOwogICAgc2VydmVyS2V5ID0gc3RyX2htYWNfc2hhMShIaSwgIlNlcnZlciBLZXkiKTsKICAgIGNsaWVudFNpZ25hdHVyZSA9IGNvcmVfaG1hY19zaGExKHN0cl9zaGExKGJpbmIyc3RyKGNsaWVudEtleSkpLCBhdXRoTWVzc2FnZSk7CiAgICBjb25uZWN0aW9uLl9zYXNsX2RhdGFbInNlcnZlci1zaWduYXR1cmUiXSA9IGI2NF9obWFjX3NoYTEoc2VydmVyS2V5LCBhdXRoTWVzc2FnZSk7CgogICAgZm9yIChrID0gMDsgayA8IDU7IGsrKykgewogICAgICBjbGllbnRLZXlba10gXj0gY2xpZW50U2lnbmF0dXJlW2tdOwogICAgfQoKICAgIHJlc3BvbnNlVGV4dCArPSAiLHA9IiArIEJhc2U2NC5lbmNvZGUoYmluYjJzdHIoY2xpZW50S2V5KSk7CgogICAgcmV0dXJuIHJlc3BvbnNlVGV4dDsKICB9LmJpbmQodGhpcyk7CgogIHJldHVybiBhdXRoX3N0cjsKfTsKClN0cm9waGUuQ29ubmVjdGlvbi5wcm90b3R5cGUubWVjaGFuaXNtc1tTdHJvcGhlLlNBU0xTSEExLnByb3RvdHlwZS5uYW1lXSA9IFN0cm9waGUuU0FTTFNIQTE7CgovKiogUHJpdmF0ZUNvbnN0cnVjdG9yOiBTQVNMTUQ1CiAqICBTQVNMIERJR0VTVCBNRDUgYXV0aGVudGljYXRpb24uCiAqLwpTdHJvcGhlLlNBU0xNRDUgPSBmdW5jdGlvbigpIHt9OwoKU3Ryb3BoZS5TQVNMTUQ1LnByb3RvdHlwZSA9IG5ldyBTdHJvcGhlLlNBU0xNZWNoYW5pc20oIkRJR0VTVC1NRDUiLCBmYWxzZSwgMzApOwoKU3Ryb3BoZS5TQVNMTUQ1LnRlc3QgPSBmdW5jdGlvbihjb25uZWN0aW9uKSB7CiAgcmV0dXJuIGNvbm5lY3Rpb24uYXV0aGNpZCAhPT0gbnVsbDsKfTsKCi8qKiBQcml2YXRlRnVuY3Rpb246IF9xdW90ZQogKiAgX1ByaXZhdGVfIHV0aWxpdHkgZnVuY3Rpb24gdG8gYmFja3NsYXNoIGVzY2FwZSBhbmQgcXVvdGUgc3RyaW5ncy4KICoKICogIFBhcmFtZXRlcnM6CiAqICAgIChTdHJpbmcpIHN0ciAtIFRoZSBzdHJpbmcgdG8gYmUgcXVvdGVkLgogKgogKiAgUmV0dXJuczoKICogICAgcXVvdGVkIHN0cmluZwogKi8KU3Ryb3BoZS5TQVNMTUQ1LnByb3RvdHlwZS5fcXVvdGUgPSBmdW5jdGlvbiAoc3RyKQogIHsKICAgIHJldHVybiAnIicgKyBzdHIucmVwbGFjZSgvXFwvZywgIlxcXFwiKS5yZXBsYWNlKC8iL2csICdcXCInKSArICciJzsKICAgIC8vIiBlbmQgc3RyaW5nIHdvcmthcm91bmQgZm9yIGVtYWNzCiAgfTsKCgpTdHJvcGhlLlNBU0xNRDUucHJvdG90eXBlLm9uQ2hhbGxlbmdlID0gZnVuY3Rpb24oY29ubmVjdGlvbiwgY2hhbGxlbmdlLCB0ZXN0X2Nub25jZSkgewogIHZhciBhdHRyaWJNYXRjaCA9IC8oW2Etel0rKT0oIlteIl0rInxbXiwiXSspKD86LHwkKS87CiAgdmFyIGNub25jZSA9IHRlc3RfY25vbmNlIHx8IE1ENS5oZXhkaWdlc3QoIiIgKyAoTWF0aC5yYW5kb20oKSAqIDEyMzQ1Njc4OTApKTsKICB2YXIgcmVhbG0gPSAiIjsKICB2YXIgaG9zdCA9IG51bGw7CiAgdmFyIG5vbmNlID0gIiI7CiAgdmFyIHFvcCA9ICIiOwogIHZhciBtYXRjaGVzOwoKICB3aGlsZSAoY2hhbGxlbmdlLm1hdGNoKGF0dHJpYk1hdGNoKSkgewogICAgbWF0Y2hlcyA9IGNoYWxsZW5nZS5tYXRjaChhdHRyaWJNYXRjaCk7CiAgICBjaGFsbGVuZ2UgPSBjaGFsbGVuZ2UucmVwbGFjZShtYXRjaGVzWzBdLCAiIik7CiAgICBtYXRjaGVzWzJdID0gbWF0Y2hlc1syXS5yZXBsYWNlKC9eIiguKykiJC8sICIkMSIpOwogICAgc3dpdGNoIChtYXRjaGVzWzFdKSB7CiAgICBjYXNlICJyZWFsbSI6CiAgICAgIHJlYWxtID0gbWF0Y2hlc1syXTsKICAgICAgYnJlYWs7CiAgICBjYXNlICJub25jZSI6CiAgICAgIG5vbmNlID0gbWF0Y2hlc1syXTsKICAgICAgYnJlYWs7CiAgICBjYXNlICJxb3AiOgogICAgICBxb3AgPSBtYXRjaGVzWzJdOwogICAgICBicmVhazsKICAgIGNhc2UgImhvc3QiOgogICAgICBob3N0ID0gbWF0Y2hlc1syXTsKICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICB2YXIgZGlnZXN0X3VyaSA9IGNvbm5lY3Rpb24uc2VydnR5cGUgKyAiLyIgKyBjb25uZWN0aW9uLmRvbWFpbjsKICBpZiAoaG9zdCAhPT0gbnVsbCkgewogICAgZGlnZXN0X3VyaSA9IGRpZ2VzdF91cmkgKyAiLyIgKyBob3N0OwogIH0KCiAgdmFyIEExID0gTUQ1Lmhhc2goY29ubmVjdGlvbi5hdXRoY2lkICsKICAgICAgICAgICAgICAgICAgICAiOiIgKyByZWFsbSArICI6IiArIHRoaXMuX2Nvbm5lY3Rpb24ucGFzcykgKwogICAgIjoiICsgbm9uY2UgKyAiOiIgKyBjbm9uY2U7CiAgdmFyIEEyID0gJ0FVVEhFTlRJQ0FURTonICsgZGlnZXN0X3VyaTsKCiAgdmFyIHJlc3BvbnNlVGV4dCA9ICIiOwogIHJlc3BvbnNlVGV4dCArPSAnY2hhcnNldD11dGYtOCwnOwogIHJlc3BvbnNlVGV4dCArPSAndXNlcm5hbWU9JyArCiAgICB0aGlzLl9xdW90ZShjb25uZWN0aW9uLmF1dGhjaWQpICsgJywnOwogIHJlc3BvbnNlVGV4dCArPSAncmVhbG09JyArIHRoaXMuX3F1b3RlKHJlYWxtKSArICcsJzsKICByZXNwb25zZVRleHQgKz0gJ25vbmNlPScgKyB0aGlzLl9xdW90ZShub25jZSkgKyAnLCc7CiAgcmVzcG9uc2VUZXh0ICs9ICduYz0wMDAwMDAwMSwnOwogIHJlc3BvbnNlVGV4dCArPSAnY25vbmNlPScgKyB0aGlzLl9xdW90ZShjbm9uY2UpICsgJywnOwogIHJlc3BvbnNlVGV4dCArPSAnZGlnZXN0LXVyaT0nICsgdGhpcy5fcXVvdGUoZGlnZXN0X3VyaSkgKyAnLCc7CiAgcmVzcG9uc2VUZXh0ICs9ICdyZXNwb25zZT0nICsgTUQ1LmhleGRpZ2VzdChNRDUuaGV4ZGlnZXN0KEExKSArICI6IiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub25jZSArICI6MDAwMDAwMDE6IiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbm9uY2UgKyAiOmF1dGg6IiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNRDUuaGV4ZGlnZXN0KEEyKSkgKyAiLCI7CiAgcmVzcG9uc2VUZXh0ICs9ICdxb3A9YXV0aCc7CgogIHRoaXMub25DaGFsbGVuZ2UgPSBmdW5jdGlvbiAoKQogIHsKICAgIHJldHVybiAiIjsKICB9LmJpbmQodGhpcyk7CgogIHJldHVybiByZXNwb25zZVRleHQ7Cn07CgpTdHJvcGhlLkNvbm5lY3Rpb24ucHJvdG90eXBlLm1lY2hhbmlzbXNbU3Ryb3BoZS5TQVNMTUQ1LnByb3RvdHlwZS5uYW1lXSA9IFN0cm9waGUuU0FTTE1ENTsKCn0pKGZ1bmN0aW9uICgpIHsKICAgIHdpbmRvdy5TdHJvcGhlID0gYXJndW1lbnRzWzBdOwogICAgd2luZG93LiRidWlsZCA9IGFyZ3VtZW50c1sxXTsKICAgIHdpbmRvdy4kbXNnID0gYXJndW1lbnRzWzJdOwogICAgd2luZG93LiRpcSA9IGFyZ3VtZW50c1szXTsKICAgIHdpbmRvdy4kcHJlcyA9IGFyZ3VtZW50c1s0XTsKfSk7CgovKgogICAgVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgTUlUIGxpY2Vuc2UuCiAgICBQbGVhc2Ugc2VlIHRoZSBMSUNFTlNFIGZpbGUgZm9yIGRldGFpbHMuCgogICAgQ29weXJpZ2h0IDIwMDYtMjAwOCwgT0dHLCBMTEMKKi8KCi8qIGpzaGludCB1bmRlZjogdHJ1ZSwgdW51c2VkOiB0cnVlOiwgbm9hcmc6IHRydWUsIGxhdGVkZWY6IHRydWUgKi8KLypnbG9iYWwgd2luZG93LCBzZXRUaW1lb3V0LCBjbGVhclRpbWVvdXQsCiAgICBYTUxIdHRwUmVxdWVzdCwgQWN0aXZlWE9iamVjdCwKICAgIFN0cm9waGUsICRidWlsZCAqLwoKCi8qKiBQcml2YXRlQ2xhc3M6IFN0cm9waGUuUmVxdWVzdAogKiAgX1ByaXZhdGVfIGhlbHBlciBjbGFzcyB0aGF0IHByb3ZpZGVzIGEgY3Jvc3MgaW1wbGVtZW50YXRpb24gYWJzdHJhY3Rpb24KICogIGZvciBhIEJPU0ggcmVsYXRlZCBYTUxIdHRwUmVxdWVzdC4KICoKICogIFRoZSBTdHJvcGhlLlJlcXVlc3QgY2xhc3MgaXMgdXNlZCBpbnRlcm5hbGx5IHRvIGVuY2Fwc3VsYXRlIEJPU0ggcmVxdWVzdAogKiAgaW5mb3JtYXRpb24uICBJdCBpcyBub3QgbWVhbnQgdG8gYmUgdXNlZCBmcm9tIHVzZXIncyBjb2RlLgogKi8KCi8qKiBQcml2YXRlQ29uc3RydWN0b3I6IFN0cm9waGUuUmVxdWVzdAogKiAgQ3JlYXRlIGFuZCBpbml0aWFsaXplIGEgbmV3IFN0cm9waGUuUmVxdWVzdCBvYmplY3QuCiAqCiAqICBQYXJhbWV0ZXJzOgogKiAgICAoWE1MRWxlbWVudCkgZWxlbSAtIFRoZSBYTUwgZGF0YSB0byBiZSBzZW50IGluIHRoZSByZXF1ZXN0LgogKiAgICAoRnVuY3Rpb24pIGZ1bmMgLSBUaGUgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZQogKiAgICAgIFhNTEh0dHBSZXF1ZXN0IHJlYWR5U3RhdGUgY2hhbmdlcy4KICogICAgKEludGVnZXIpIHJpZCAtIFRoZSBCT1NIIHJpZCBhdHRyaWJ1dGUgYXNzb2NpYXRlZCB3aXRoIHRoaXMgcmVxdWVzdC4KICogICAgKEludGVnZXIpIHNlbmRzIC0gVGhlIG51bWJlciBvZiB0aW1lcyB0aGlzIHNhbWUgcmVxdWVzdCBoYXMgYmVlbgogKiAgICAgIHNlbnQuCiAqLwpTdHJvcGhlLlJlcXVlc3QgPSBmdW5jdGlvbiAoZWxlbSwgZnVuYywgcmlkLCBzZW5kcykKewogICAgdGhpcy5pZCA9ICsrU3Ryb3BoZS5fcmVxdWVzdElkOwogICAgdGhpcy54bWxEYXRhID0gZWxlbTsKICAgIHRoaXMuZGF0YSA9IFN0cm9waGUuc2VyaWFsaXplKGVsZW0pOwogICAgLy8gc2F2ZSBvcmlnaW5hbCBmdW5jdGlvbiBpbiBjYXNlIHdlIG5lZWQgdG8gbWFrZSBhIG5ldyByZXF1ZXN0CiAgICAvLyBmcm9tIHRoaXMgb25lLgogICAgdGhpcy5vcmlnRnVuYyA9IGZ1bmM7CiAgICB0aGlzLmZ1bmMgPSBmdW5jOwogICAgdGhpcy5yaWQgPSByaWQ7CiAgICB0aGlzLmRhdGUgPSBOYU47CiAgICB0aGlzLnNlbmRzID0gc2VuZHMgfHwgMDsKICAgIHRoaXMuYWJvcnQgPSBmYWxzZTsKICAgIHRoaXMuZGVhZCA9IG51bGw7CgogICAgdGhpcy5hZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKCF0aGlzLmRhdGUpIHsgcmV0dXJuIDA7IH0KICAgICAgICB2YXIgbm93ID0gbmV3IERhdGUoKTsKICAgICAgICByZXR1cm4gKG5vdyAtIHRoaXMuZGF0ZSkgLyAxMDAwOwogICAgfTsKICAgIHRoaXMudGltZURlYWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKCF0aGlzLmRlYWQpIHsgcmV0dXJuIDA7IH0KICAgICAgICB2YXIgbm93ID0gbmV3IERhdGUoKTsKICAgICAgICByZXR1cm4gKG5vdyAtIHRoaXMuZGVhZCkgLyAxMDAwOwogICAgfTsKICAgIHRoaXMueGhyID0gdGhpcy5fbmV3WEhSKCk7Cn07CgpTdHJvcGhlLlJlcXVlc3QucHJvdG90eXBlID0gewogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogZ2V0UmVzcG9uc2UKICAgICAqICBHZXQgYSByZXNwb25zZSBmcm9tIHRoZSB1bmRlcmx5aW5nIFhNTEh0dHBSZXF1ZXN0LgogICAgICoKICAgICAqICBUaGlzIGZ1bmN0aW9uIGF0dGVtcHRzIHRvIGdldCBhIHJlc3BvbnNlIGZyb20gdGhlIHJlcXVlc3QgYW5kIGNoZWNrcwogICAgICogIGZvciBlcnJvcnMuCiAgICAgKgogICAgICogIFRocm93czoKICAgICAqICAgICJwYXJzZXJlcnJvciIgLSBBIHBhcnNlciBlcnJvciBvY2N1cmVkLgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgVGhlIERPTSBlbGVtZW50IHRyZWUgb2YgdGhlIHJlc3BvbnNlLgogICAgICovCiAgICBnZXRSZXNwb25zZTogZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICB2YXIgbm9kZSA9IG51bGw7CiAgICAgICAgaWYgKHRoaXMueGhyLnJlc3BvbnNlWE1MICYmIHRoaXMueGhyLnJlc3BvbnNlWE1MLmRvY3VtZW50RWxlbWVudCkgewogICAgICAgICAgICBub2RlID0gdGhpcy54aHIucmVzcG9uc2VYTUwuZG9jdW1lbnRFbGVtZW50OwogICAgICAgICAgICBpZiAobm9kZS50YWdOYW1lID09ICJwYXJzZXJlcnJvciIpIHsKICAgICAgICAgICAgICAgIFN0cm9waGUuZXJyb3IoImludmFsaWQgcmVzcG9uc2UgcmVjZWl2ZWQiKTsKICAgICAgICAgICAgICAgIFN0cm9waGUuZXJyb3IoInJlc3BvbnNlVGV4dDogIiArIHRoaXMueGhyLnJlc3BvbnNlVGV4dCk7CiAgICAgICAgICAgICAgICBTdHJvcGhlLmVycm9yKCJyZXNwb25zZVhNTDogIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFN0cm9waGUuc2VyaWFsaXplKHRoaXMueGhyLnJlc3BvbnNlWE1MKSk7CiAgICAgICAgICAgICAgICB0aHJvdyAicGFyc2VyZXJyb3IiOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnhoci5yZXNwb25zZVRleHQpIHsKICAgICAgICAgICAgU3Ryb3BoZS5lcnJvcigiaW52YWxpZCByZXNwb25zZSByZWNlaXZlZCIpOwogICAgICAgICAgICBTdHJvcGhlLmVycm9yKCJyZXNwb25zZVRleHQ6ICIgKyB0aGlzLnhoci5yZXNwb25zZVRleHQpOwogICAgICAgICAgICBTdHJvcGhlLmVycm9yKCJyZXNwb25zZVhNTDogIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgU3Ryb3BoZS5zZXJpYWxpemUodGhpcy54aHIucmVzcG9uc2VYTUwpKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBub2RlOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfbmV3WEhSCiAgICAgKiAgX1ByaXZhdGVfIGhlbHBlciBmdW5jdGlvbiB0byBjcmVhdGUgWE1MSHR0cFJlcXVlc3RzLgogICAgICoKICAgICAqICBUaGlzIGZ1bmN0aW9uIGNyZWF0ZXMgWE1MSHR0cFJlcXVlc3RzIGFjcm9zcyBhbGwgaW1wbGVtZW50YXRpb25zLgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgQSBuZXcgWE1MSHR0cFJlcXVlc3QuCiAgICAgKi8KICAgIF9uZXdYSFI6IGZ1bmN0aW9uICgpCiAgICB7CiAgICAgICAgdmFyIHhociA9IG51bGw7CiAgICAgICAgaWYgKHdpbmRvdy5YTUxIdHRwUmVxdWVzdCkgewogICAgICAgICAgICB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgICAgICAgICAgaWYgKHhoci5vdmVycmlkZU1pbWVUeXBlKSB7CiAgICAgICAgICAgICAgICB4aHIub3ZlcnJpZGVNaW1lVHlwZSgidGV4dC94bWwiKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAod2luZG93LkFjdGl2ZVhPYmplY3QpIHsKICAgICAgICAgICAgeGhyID0gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxIVFRQIik7CiAgICAgICAgfQoKICAgICAgICAvLyB1c2UgRnVuY3Rpb24uYmluZCgpIHRvIHByZXBlbmQgb3Vyc2VsdmVzIGFzIGFuIGFyZ3VtZW50CiAgICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHRoaXMuZnVuYy5iaW5kKG51bGwsIHRoaXMpOwoKICAgICAgICByZXR1cm4geGhyOwogICAgfQp9OwoKLyoqIENsYXNzOiBTdHJvcGhlLkJvc2gKICogIF9Qcml2YXRlXyBoZWxwZXIgY2xhc3MgdGhhdCBoYW5kbGVzIEJPU0ggQ29ubmVjdGlvbnMKICoKICogIFRoZSBTdHJvcGhlLkJvc2ggY2xhc3MgaXMgdXNlZCBpbnRlcm5hbGx5IGJ5IFN0cm9waGUuQ29ubmVjdGlvbgogKiAgdG8gZW5jYXBzdWxhdGUgQk9TSCBzZXNzaW9ucy4gSXQgaXMgbm90IG1lYW50IHRvIGJlIHVzZWQgZnJvbSB1c2VyJ3MgY29kZS4KICovCgovKiogRmlsZTogYm9zaC5qcwogKiAgQSBKYXZhU2NyaXB0IGxpYnJhcnkgdG8gZW5hYmxlIEJPU0ggaW4gU3Ryb3BoZWpzLgogKgogKiAgdGhpcyBsaWJyYXJ5IHVzZXMgQmlkaXJlY3Rpb25hbC1zdHJlYW1zIE92ZXIgU3luY2hyb25vdXMgSFRUUCAoQk9TSCkKICogIHRvIGVtdWxhdGUgYSBwZXJzaXN0ZW50LCBzdGF0ZWZ1bCwgdHdvLXdheSBjb25uZWN0aW9uIHRvIGFuIFhNUFAgc2VydmVyLgogKiAgTW9yZSBpbmZvcm1hdGlvbiBvbiBCT1NIIGNhbiBiZSBmb3VuZCBpbiBYRVAgMTI0LgogKi8KCi8qKiBQcml2YXRlQ29uc3RydWN0b3I6IFN0cm9waGUuQm9zaAogKiAgQ3JlYXRlIGFuZCBpbml0aWFsaXplIGEgU3Ryb3BoZS5Cb3NoIG9iamVjdC4KICoKICogIFBhcmFtZXRlcnM6CiAqICAgIChTdHJvcGhlLkNvbm5lY3Rpb24pIGNvbm5lY3Rpb24gLSBUaGUgU3Ryb3BoZS5Db25uZWN0aW9uIHRoYXQgd2lsbCB1c2UgQk9TSC4KICoKICogIFJldHVybnM6CiAqICAgIEEgbmV3IFN0cm9waGUuQm9zaCBvYmplY3QuCiAqLwpTdHJvcGhlLkJvc2ggPSBmdW5jdGlvbihjb25uZWN0aW9uKSB7CiAgICB0aGlzLl9jb25uID0gY29ubmVjdGlvbjsKICAgIC8qIHJlcXVlc3QgaWQgZm9yIGJvZHkgdGFncyAqLwogICAgdGhpcy5yaWQgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA0Mjk0OTY3Mjk1KTsKICAgIC8qIFRoZSBjdXJyZW50IHNlc3Npb24gSUQuICovCiAgICB0aGlzLnNpZCA9IG51bGw7CgogICAgLy8gZGVmYXVsdCBCT1NIIHZhbHVlcwogICAgdGhpcy5ob2xkID0gMTsKICAgIHRoaXMud2FpdCA9IDYwOwogICAgdGhpcy53aW5kb3cgPSA1OwoKICAgIHRoaXMuX3JlcXVlc3RzID0gW107Cn07CgpTdHJvcGhlLkJvc2gucHJvdG90eXBlID0gewogICAgLyoqIFZhcmlhYmxlOiBzdHJpcAogICAgICoKICAgICAqICBCT1NILUNvbm5lY3Rpb25zIHdpbGwgaGF2ZSBhbGwgc3RhbnphcyB3cmFwcGVkIGluIGEgPGJvZHk+IHRhZyB3aGVuCiAgICAgKiAgcGFzc2VkIHRvIDxTdHJvcGhlLkNvbm5lY3Rpb24ueG1sSW5wdXQ+IG9yIDxTdHJvcGhlLkNvbm5lY3Rpb24ueG1sT3V0cHV0Pi4KICAgICAqICBUbyBzdHJpcCB0aGlzIHRhZywgVXNlciBjb2RlIGNhbiBzZXQgPFN0cm9waGUuQm9zaC5zdHJpcD4gdG8gImJvZHkiOgogICAgICoKICAgICAqICA+IFN0cm9waGUuQm9zaC5wcm90b3R5cGUuc3RyaXAgPSAiYm9keSI7CiAgICAgKgogICAgICogIFRoaXMgd2lsbCBlbmFibGUgc3RyaXBwaW5nIG9mIHRoZSBib2R5IHRhZyBpbiBib3RoCiAgICAgKiAgPFN0cm9waGUuQ29ubmVjdGlvbi54bWxJbnB1dD4gYW5kIDxTdHJvcGhlLkNvbm5lY3Rpb24ueG1sT3V0cHV0Pi4KICAgICAqLwogICAgc3RyaXA6IG51bGwsCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX2J1aWxkQm9keQogICAgICogIF9Qcml2YXRlXyBoZWxwZXIgZnVuY3Rpb24gdG8gZ2VuZXJhdGUgdGhlIDxib2R5Lz4gd3JhcHBlciBmb3IgQk9TSC4KICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgIEEgU3Ryb3BoZS5CdWlsZGVyIHdpdGggYSA8Ym9keS8+IGVsZW1lbnQuCiAgICAgKi8KICAgIF9idWlsZEJvZHk6IGZ1bmN0aW9uICgpCiAgICB7CiAgICAgICAgdmFyIGJvZHlXcmFwID0gJGJ1aWxkKCdib2R5JywgewogICAgICAgICAgICByaWQ6IHRoaXMucmlkKyssCiAgICAgICAgICAgIHhtbG5zOiBTdHJvcGhlLk5TLkhUVFBCSU5ECiAgICAgICAgfSk7CgogICAgICAgIGlmICh0aGlzLnNpZCAhPT0gbnVsbCkgewogICAgICAgICAgICBib2R5V3JhcC5hdHRycyh7c2lkOiB0aGlzLnNpZH0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGJvZHlXcmFwOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfcmVzZXQKICAgICAqICBSZXNldCB0aGUgY29ubmVjdGlvbi4KICAgICAqCiAgICAgKiAgVGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQgYnkgdGhlIHJlc2V0IGZ1bmN0aW9uIG9mIHRoZSBTdHJvcGhlIENvbm5lY3Rpb24KICAgICAqLwogICAgX3Jlc2V0OiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIHRoaXMucmlkID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogNDI5NDk2NzI5NSk7CiAgICAgICAgdGhpcy5zaWQgPSBudWxsOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfY29ubmVjdAogICAgICogIF9Qcml2YXRlXyBmdW5jdGlvbiB0aGF0IGluaXRpYWxpemVzIHRoZSBCT1NIIGNvbm5lY3Rpb24uCiAgICAgKgogICAgICogIENyZWF0ZXMgYW5kIHNlbmRzIHRoZSBSZXF1ZXN0IHRoYXQgaW5pdGlhbGl6ZXMgdGhlIEJPU0ggY29ubmVjdGlvbi4KICAgICAqLwogICAgX2Nvbm5lY3Q6IGZ1bmN0aW9uICh3YWl0LCBob2xkLCByb3V0ZSkKICAgIHsKICAgICAgICB0aGlzLndhaXQgPSB3YWl0IHx8IHRoaXMud2FpdDsKICAgICAgICB0aGlzLmhvbGQgPSBob2xkIHx8IHRoaXMuaG9sZDsKCiAgICAgICAgLy8gYnVpbGQgdGhlIGJvZHkgdGFnCiAgICAgICAgdmFyIGJvZHkgPSB0aGlzLl9idWlsZEJvZHkoKS5hdHRycyh7CiAgICAgICAgICAgIHRvOiB0aGlzLl9jb25uLmRvbWFpbiwKICAgICAgICAgICAgInhtbDpsYW5nIjogImVuIiwKICAgICAgICAgICAgd2FpdDogdGhpcy53YWl0LAogICAgICAgICAgICBob2xkOiB0aGlzLmhvbGQsCiAgICAgICAgICAgIGNvbnRlbnQ6ICJ0ZXh0L3htbDsgY2hhcnNldD11dGYtOCIsCiAgICAgICAgICAgIHZlcjogIjEuNiIsCiAgICAgICAgICAgICJ4bXBwOnZlcnNpb24iOiAiMS4wIiwKICAgICAgICAgICAgInhtbG5zOnhtcHAiOiBTdHJvcGhlLk5TLkJPU0gKICAgICAgICB9KTsKCiAgICAgICAgaWYocm91dGUpewogICAgICAgICAgICBib2R5LmF0dHJzKHsKICAgICAgICAgICAgICAgIHJvdXRlOiByb3V0ZQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIHZhciBfY29ubmVjdF9jYiA9IHRoaXMuX2Nvbm4uX2Nvbm5lY3RfY2I7CgogICAgICAgIHRoaXMuX3JlcXVlc3RzLnB1c2goCiAgICAgICAgICAgIG5ldyBTdHJvcGhlLlJlcXVlc3QoYm9keS50cmVlKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fb25SZXF1ZXN0U3RhdGVDaGFuZ2UuYmluZCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcywgX2Nvbm5lY3RfY2IuYmluZCh0aGlzLl9jb25uKSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9keS50cmVlKCkuZ2V0QXR0cmlidXRlKCJyaWQiKSkpOwogICAgICAgIHRoaXMuX3Rocm90dGxlZFJlcXVlc3RIYW5kbGVyKCk7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9hdHRhY2gKICAgICAqICBBdHRhY2ggdG8gYW4gYWxyZWFkeSBjcmVhdGVkIGFuZCBhdXRoZW50aWNhdGVkIEJPU0ggc2Vzc2lvbi4KICAgICAqCiAgICAgKiAgVGhpcyBmdW5jdGlvbiBpcyBwcm92aWRlZCB0byBhbGxvdyBTdHJvcGhlIHRvIGF0dGFjaCB0byBCT1NICiAgICAgKiAgc2Vzc2lvbnMgd2hpY2ggaGF2ZSBiZWVuIGNyZWF0ZWQgZXh0ZXJuYWxseSwgcGVyaGFwcyBieSBhIFdlYgogICAgICogIGFwcGxpY2F0aW9uLiAgVGhpcyBpcyBvZnRlbiB1c2VkIHRvIHN1cHBvcnQgYXV0by1sb2dpbiB0eXBlIGZlYXR1cmVzCiAgICAgKiAgd2l0aG91dCBwdXR0aW5nIHVzZXIgY3JlZGVudGlhbHMgaW50byB0aGUgcGFnZS4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJpbmcpIGppZCAtIFRoZSBmdWxsIEpJRCB0aGF0IGlzIGJvdW5kIGJ5IHRoZSBzZXNzaW9uLgogICAgICogICAgKFN0cmluZykgc2lkIC0gVGhlIFNJRCBvZiB0aGUgQk9TSCBzZXNzaW9uLgogICAgICogICAgKFN0cmluZykgcmlkIC0gVGhlIGN1cnJlbnQgUklEIG9mIHRoZSBCT1NIIHNlc3Npb24uICBUaGlzIFJJRAogICAgICogICAgICB3aWxsIGJlIHVzZWQgYnkgdGhlIG5leHQgcmVxdWVzdC4KICAgICAqICAgIChGdW5jdGlvbikgY2FsbGJhY2sgVGhlIGNvbm5lY3QgY2FsbGJhY2sgZnVuY3Rpb24uCiAgICAgKiAgICAoSW50ZWdlcikgd2FpdCAtIFRoZSBvcHRpb25hbCBIVFRQQklORCB3YWl0IHZhbHVlLiAgVGhpcyBpcyB0aGUKICAgICAqICAgICAgdGltZSB0aGUgc2VydmVyIHdpbGwgd2FpdCBiZWZvcmUgcmV0dXJuaW5nIGFuIGVtcHR5IHJlc3VsdCBmb3IKICAgICAqICAgICAgYSByZXF1ZXN0LiAgVGhlIGRlZmF1bHQgc2V0dGluZyBvZiA2MCBzZWNvbmRzIGlzIHJlY29tbWVuZGVkLgogICAgICogICAgICBPdGhlciBzZXR0aW5ncyB3aWxsIHJlcXVpcmUgdHdlYWtzIHRvIHRoZSBTdHJvcGhlLlRJTUVPVVQgdmFsdWUuCiAgICAgKiAgICAoSW50ZWdlcikgaG9sZCAtIFRoZSBvcHRpb25hbCBIVFRQQklORCBob2xkIHZhbHVlLiAgVGhpcyBpcyB0aGUKICAgICAqICAgICAgbnVtYmVyIG9mIGNvbm5lY3Rpb25zIHRoZSBzZXJ2ZXIgd2lsbCBob2xkIGF0IG9uZSB0aW1lLiAgVGhpcwogICAgICogICAgICBzaG91bGQgYWxtb3N0IGFsd2F5cyBiZSBzZXQgdG8gMSAodGhlIGRlZmF1bHQpLgogICAgICogICAgKEludGVnZXIpIHdpbmQgLSBUaGUgb3B0aW9uYWwgSFRUQklORCB3aW5kb3cgdmFsdWUuICBUaGlzIGlzIHRoZQogICAgICogICAgICBhbGxvd2VkIHJhbmdlIG9mIHJlcXVlc3QgaWRzIHRoYXQgYXJlIHZhbGlkLiAgVGhlIGRlZmF1bHQgaXMgNS4KICAgICAqLwogICAgX2F0dGFjaDogZnVuY3Rpb24gKGppZCwgc2lkLCByaWQsIGNhbGxiYWNrLCB3YWl0LCBob2xkLCB3aW5kKQogICAgewogICAgICAgIHRoaXMuX2Nvbm4uamlkID0gamlkOwogICAgICAgIHRoaXMuc2lkID0gc2lkOwogICAgICAgIHRoaXMucmlkID0gcmlkOwoKICAgICAgICB0aGlzLl9jb25uLmNvbm5lY3RfY2FsbGJhY2sgPSBjYWxsYmFjazsKCiAgICAgICAgdGhpcy5fY29ubi5kb21haW4gPSBTdHJvcGhlLmdldERvbWFpbkZyb21KaWQodGhpcy5fY29ubi5qaWQpOwoKICAgICAgICB0aGlzLl9jb25uLmF1dGhlbnRpY2F0ZWQgPSB0cnVlOwogICAgICAgIHRoaXMuX2Nvbm4uY29ubmVjdGVkID0gdHJ1ZTsKCiAgICAgICAgdGhpcy53YWl0ID0gd2FpdCB8fCB0aGlzLndhaXQ7CiAgICAgICAgdGhpcy5ob2xkID0gaG9sZCB8fCB0aGlzLmhvbGQ7CiAgICAgICAgdGhpcy53aW5kb3cgPSB3aW5kIHx8IHRoaXMud2luZG93OwoKICAgICAgICB0aGlzLl9jb25uLl9jaGFuZ2VDb25uZWN0U3RhdHVzKFN0cm9waGUuU3RhdHVzLkFUVEFDSEVELCBudWxsKTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX2Nvbm5lY3RfY2IKICAgICAqICBfUHJpdmF0ZV8gaGFuZGxlciBmb3IgaW5pdGlhbCBjb25uZWN0aW9uIHJlcXVlc3QuCiAgICAgKgogICAgICogIFRoaXMgaGFuZGxlciBpcyB1c2VkIHRvIHByb2Nlc3MgdGhlIEJvc2gtcGFydCBvZiB0aGUgaW5pdGlhbCByZXF1ZXN0LgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoU3Ryb3BoZS5SZXF1ZXN0KSBib2R5V3JhcCAtIFRoZSByZWNlaXZlZCBzdGFuemEuCiAgICAgKi8KICAgIF9jb25uZWN0X2NiOiBmdW5jdGlvbiAoYm9keVdyYXApCiAgICB7CiAgICAgICAgdmFyIHR5cCA9IGJvZHlXcmFwLmdldEF0dHJpYnV0ZSgidHlwZSIpOwogICAgICAgIHZhciBjb25kLCBjb25mbGljdDsKICAgICAgICBpZiAodHlwICE9PSBudWxsICYmIHR5cCA9PSAidGVybWluYXRlIikgewogICAgICAgICAgICAvLyBhbiBlcnJvciBvY2N1cnJlZAogICAgICAgICAgICBTdHJvcGhlLmVycm9yKCJCT1NILUNvbm5lY3Rpb24gZmFpbGVkOiAiICsgY29uZCk7CiAgICAgICAgICAgIGNvbmQgPSBib2R5V3JhcC5nZXRBdHRyaWJ1dGUoImNvbmRpdGlvbiIpOwogICAgICAgICAgICBjb25mbGljdCA9IGJvZHlXcmFwLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJjb25mbGljdCIpOwogICAgICAgICAgICBpZiAoY29uZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKGNvbmQgPT0gInJlbW90ZS1zdHJlYW0tZXJyb3IiICYmIGNvbmZsaWN0Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25kID0gImNvbmZsaWN0IjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2Nvbm4uX2NoYW5nZUNvbm5lY3RTdGF0dXMoU3Ryb3BoZS5TdGF0dXMuQ09OTkZBSUwsIGNvbmQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5fY29ubi5fY2hhbmdlQ29ubmVjdFN0YXR1cyhTdHJvcGhlLlN0YXR1cy5DT05ORkFJTCwgInVua25vd24iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9jb25uLl9kb0Rpc2Nvbm5lY3QoKTsKICAgICAgICAgICAgcmV0dXJuIFN0cm9waGUuU3RhdHVzLkNPTk5GQUlMOwogICAgICAgIH0KCiAgICAgICAgLy8gY2hlY2sgdG8gbWFrZSBzdXJlIHdlIGRvbid0IG92ZXJ3cml0ZSB0aGVzZSBpZiBfY29ubmVjdF9jYiBpcwogICAgICAgIC8vIGNhbGxlZCBtdWx0aXBsZSB0aW1lcyBpbiB0aGUgY2FzZSBvZiBtaXNzaW5nIHN0cmVhbTpmZWF0dXJlcwogICAgICAgIGlmICghdGhpcy5zaWQpIHsKICAgICAgICAgICAgdGhpcy5zaWQgPSBib2R5V3JhcC5nZXRBdHRyaWJ1dGUoInNpZCIpOwogICAgICAgIH0KICAgICAgICB2YXIgd2luZCA9IGJvZHlXcmFwLmdldEF0dHJpYnV0ZSgncmVxdWVzdHMnKTsKICAgICAgICBpZiAod2luZCkgeyB0aGlzLndpbmRvdyA9IHBhcnNlSW50KHdpbmQsIDEwKTsgfQogICAgICAgIHZhciBob2xkID0gYm9keVdyYXAuZ2V0QXR0cmlidXRlKCdob2xkJyk7CiAgICAgICAgaWYgKGhvbGQpIHsgdGhpcy5ob2xkID0gcGFyc2VJbnQoaG9sZCwgMTApOyB9CiAgICAgICAgdmFyIHdhaXQgPSBib2R5V3JhcC5nZXRBdHRyaWJ1dGUoJ3dhaXQnKTsKICAgICAgICBpZiAod2FpdCkgeyB0aGlzLndhaXQgPSBwYXJzZUludCh3YWl0LCAxMCk7IH0KICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX2Rpc2Nvbm5lY3QKICAgICAqICBfUHJpdmF0ZV8gcGFydCBvZiBDb25uZWN0aW9uLmRpc2Nvbm5lY3QgZm9yIEJvc2gKICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChSZXF1ZXN0KSBwcmVzIC0gVGhpcyBzdGFuemEgd2lsbCBiZSBzZW50IGJlZm9yZSBkaXNjb25uZWN0aW5nLgogICAgICovCiAgICBfZGlzY29ubmVjdDogZnVuY3Rpb24gKHByZXMpCiAgICB7CiAgICAgICAgdGhpcy5fc2VuZFRlcm1pbmF0ZShwcmVzKTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX2RvRGlzY29ubmVjdAogICAgICogIF9Qcml2YXRlXyBmdW5jdGlvbiB0byBkaXNjb25uZWN0LgogICAgICoKICAgICAqICBSZXNldHMgdGhlIFNJRCBhbmQgUklELgogICAgICovCiAgICBfZG9EaXNjb25uZWN0OiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIHRoaXMuc2lkID0gbnVsbDsKICAgICAgICB0aGlzLnJpZCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDQyOTQ5NjcyOTUpOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfZW1wdHlRdWV1ZQogICAgICogX1ByaXZhdGVfIGZ1bmN0aW9uIHRvIGNoZWNrIGlmIHRoZSBSZXF1ZXN0IHF1ZXVlIGlzIGVtcHR5LgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgVHJ1ZSwgaWYgdGhlcmUgYXJlIG5vIFJlcXVlc3RzIHF1ZXVlZCwgRmFsc2Ugb3RoZXJ3aXNlLgogICAgICovCiAgICBfZW1wdHlRdWV1ZTogZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmVxdWVzdHMubGVuZ3RoID09PSAwOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfaGl0RXJyb3IKICAgICAqICBfUHJpdmF0ZV8gZnVuY3Rpb24gdG8gaGFuZGxlIHRoZSBlcnJvciBjb3VudC4KICAgICAqCiAgICAgKiAgUmVxdWVzdHMgYXJlIHJlc2VudCBhdXRvbWF0aWNhbGx5IHVudGlsIHRoZWlyIGVycm9yIGNvdW50IHJlYWNoZXMKICAgICAqICA1LiAgRWFjaCB0aW1lIGFuIGVycm9yIGlzIGVuY291bnRlcmVkLCB0aGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCB0bwogICAgICogIGluY3JlbWVudCB0aGUgY291bnQgYW5kIGRpc2Nvbm5lY3QgaWYgdGhlIGNvdW50IGlzIHRvbyBoaWdoLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKEludGVnZXIpIHJlcVN0YXR1cyAtIFRoZSByZXF1ZXN0IHN0YXR1cy4KICAgICAqLwogICAgX2hpdEVycm9yOiBmdW5jdGlvbiAocmVxU3RhdHVzKQogICAgewogICAgICAgIHRoaXMuZXJyb3JzKys7CiAgICAgICAgU3Ryb3BoZS53YXJuKCJyZXF1ZXN0IGVycm9yZWQsIHN0YXR1czogIiArIHJlcVN0YXR1cyArCiAgICAgICAgICAgICAgICAgICAgICIsIG51bWJlciBvZiBlcnJvcnM6ICIgKyB0aGlzLmVycm9ycyk7CiAgICAgICAgaWYgKHRoaXMuZXJyb3JzID4gNCkgewogICAgICAgICAgICB0aGlzLl9vbkRpc2Nvbm5lY3RUaW1lb3V0KCk7CiAgICAgICAgfQogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfbm9fYXV0aF9yZWNlaXZlZAogICAgICoKICAgICAqIENhbGxlZCBvbiBzdHJlYW0gc3RhcnQvcmVzdGFydCB3aGVuIG5vIHN0cmVhbTpmZWF0dXJlcwogICAgICogaGFzIGJlZW4gcmVjZWl2ZWQgYW5kIHNlbmRzIGEgYmxhbmsgcG9sbCByZXF1ZXN0LgogICAgICovCiAgICBfbm9fYXV0aF9yZWNlaXZlZDogZnVuY3Rpb24gKF9jYWxsYmFjaykKICAgIHsKICAgICAgICBpZiAoX2NhbGxiYWNrKSB7CiAgICAgICAgICAgIF9jYWxsYmFjayA9IF9jYWxsYmFjay5iaW5kKHRoaXMuX2Nvbm4pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIF9jYWxsYmFjayA9IHRoaXMuX2Nvbm4uX2Nvbm5lY3RfY2IuYmluZCh0aGlzLl9jb25uKTsKICAgICAgICB9CiAgICAgICAgdmFyIGJvZHkgPSB0aGlzLl9idWlsZEJvZHkoKTsKICAgICAgICB0aGlzLl9yZXF1ZXN0cy5wdXNoKAogICAgICAgICAgICAgICAgbmV3IFN0cm9waGUuUmVxdWVzdChib2R5LnRyZWUoKSwKICAgICAgICAgICAgICAgICAgICB0aGlzLl9vblJlcXVlc3RTdGF0ZUNoYW5nZS5iaW5kKAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLCBfY2FsbGJhY2suYmluZCh0aGlzLl9jb25uKSksCiAgICAgICAgICAgICAgICAgICAgYm9keS50cmVlKCkuZ2V0QXR0cmlidXRlKCJyaWQiKSkpOwogICAgICAgIHRoaXMuX3Rocm90dGxlZFJlcXVlc3RIYW5kbGVyKCk7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9vbkRpc2Nvbm5lY3RUaW1lb3V0CiAgICAgKiAgX1ByaXZhdGVfIHRpbWVvdXQgaGFuZGxlciBmb3IgaGFuZGxpbmcgbm9uLWdyYWNlZnVsIGRpc2Nvbm5lY3Rpb24uCiAgICAgKgogICAgICogIENhbmNlbHMgYWxsIHJlbWFpbmluZyBSZXF1ZXN0cyBhbmQgY2xlYXJzIHRoZSBxdWV1ZS4KICAgICAqLwogICAgX29uRGlzY29ubmVjdFRpbWVvdXQ6IGZ1bmN0aW9uICgpCiAgICB7CiAgICAgICAgdmFyIHJlcTsKICAgICAgICB3aGlsZSAodGhpcy5fcmVxdWVzdHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICByZXEgPSB0aGlzLl9yZXF1ZXN0cy5wb3AoKTsKICAgICAgICAgICAgcmVxLmFib3J0ID0gdHJ1ZTsKICAgICAgICAgICAgcmVxLnhoci5hYm9ydCgpOwogICAgICAgICAgICAvLyBqc2xpbnQgY29tcGxhaW5zLCBidXQgdGhpcyBpcyBmaW5lLiBzZXR0aW5nIHRvIGVtcHR5IGZ1bmMKICAgICAgICAgICAgLy8gaXMgbmVjZXNzYXJ5IGZvciBJRTYKICAgICAgICAgICAgcmVxLnhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbiAoKSB7fTsgLy8ganNoaW50IGlnbm9yZTpsaW5lCiAgICAgICAgfQogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfb25JZGxlCiAgICAgKiAgX1ByaXZhdGVfIGhhbmRsZXIgY2FsbGVkIGJ5IFN0cm9waGUuQ29ubmVjdGlvbi5fb25JZGxlCiAgICAgKgogICAgICogIFNlbmRzIGFsbCBxdWV1ZWQgUmVxdWVzdHMgb3IgcG9sbHMgd2l0aCBlbXB0eSBSZXF1ZXN0IGlmIHRoZXJlIGFyZSBub25lLgogICAgICovCiAgICBfb25JZGxlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGRhdGEgPSB0aGlzLl9jb25uLl9kYXRhOwoKICAgICAgICAvLyBpZiBubyByZXF1ZXN0cyBhcmUgaW4gcHJvZ3Jlc3MsIHBvbGwKICAgICAgICBpZiAodGhpcy5fY29ubi5hdXRoZW50aWNhdGVkICYmIHRoaXMuX3JlcXVlc3RzLmxlbmd0aCA9PT0gMCAmJgogICAgICAgICAgICBkYXRhLmxlbmd0aCA9PT0gMCAmJiAhdGhpcy5fY29ubi5kaXNjb25uZWN0aW5nKSB7CiAgICAgICAgICAgIFN0cm9waGUuaW5mbygibm8gcmVxdWVzdHMgZHVyaW5nIGlkbGUgY3ljbGUsIHNlbmRpbmcgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAiYmxhbmsgcmVxdWVzdCIpOwogICAgICAgICAgICBkYXRhLnB1c2gobnVsbCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fcmVxdWVzdHMubGVuZ3RoIDwgMiAmJiBkYXRhLmxlbmd0aCA+IDAgJiYKICAgICAgICAgICAgIXRoaXMuX2Nvbm4ucGF1c2VkKSB7CiAgICAgICAgICAgIHZhciBib2R5ID0gdGhpcy5fYnVpbGRCb2R5KCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKGRhdGFbaV0gIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YVtpXSA9PT0gInJlc3RhcnQiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJvZHkuYXR0cnMoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG86IHRoaXMuX2Nvbm4uZG9tYWluLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInhtbDpsYW5nIjogImVuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ4bXBwOnJlc3RhcnQiOiAidHJ1ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAieG1sbnM6eG1wcCI6IFN0cm9waGUuTlMuQk9TSAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBib2R5LmNub2RlKGRhdGFbaV0pLnVwKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9jb25uLl9kYXRhOwogICAgICAgICAgICB0aGlzLl9jb25uLl9kYXRhID0gW107CiAgICAgICAgICAgIHRoaXMuX3JlcXVlc3RzLnB1c2goCiAgICAgICAgICAgICAgICBuZXcgU3Ryb3BoZS5SZXF1ZXN0KGJvZHkudHJlZSgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9vblJlcXVlc3RTdGF0ZUNoYW5nZS5iaW5kKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcywgdGhpcy5fY29ubi5fZGF0YVJlY3YuYmluZCh0aGlzLl9jb25uKSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvZHkudHJlZSgpLmdldEF0dHJpYnV0ZSgicmlkIikpKTsKICAgICAgICAgICAgdGhpcy5fcHJvY2Vzc1JlcXVlc3QodGhpcy5fcmVxdWVzdHMubGVuZ3RoIC0gMSk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fcmVxdWVzdHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgdGltZV9lbGFwc2VkID0gdGhpcy5fcmVxdWVzdHNbMF0uYWdlKCk7CiAgICAgICAgICAgIGlmICh0aGlzLl9yZXF1ZXN0c1swXS5kZWFkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcmVxdWVzdHNbMF0udGltZURlYWQoKSA+CiAgICAgICAgICAgICAgICAgICAgTWF0aC5mbG9vcihTdHJvcGhlLlNFQ09OREFSWV9USU1FT1VUICogdGhpcy53YWl0KSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Rocm90dGxlZFJlcXVlc3RIYW5kbGVyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aW1lX2VsYXBzZWQgPiBNYXRoLmZsb29yKFN0cm9waGUuVElNRU9VVCAqIHRoaXMud2FpdCkpIHsKICAgICAgICAgICAgICAgIFN0cm9waGUud2FybigiUmVxdWVzdCAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXF1ZXN0c1swXS5pZCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiB0aW1lZCBvdXQsIG92ZXIgIiArIE1hdGguZmxvb3IoU3Ryb3BoZS5USU1FT1VUICogdGhpcy53YWl0KSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiBzZWNvbmRzIHNpbmNlIGxhc3QgYWN0aXZpdHkiKTsKICAgICAgICAgICAgICAgIHRoaXMuX3Rocm90dGxlZFJlcXVlc3RIYW5kbGVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9vblJlcXVlc3RTdGF0ZUNoYW5nZQogICAgICogIF9Qcml2YXRlXyBoYW5kbGVyIGZvciBTdHJvcGhlLlJlcXVlc3Qgc3RhdGUgY2hhbmdlcy4KICAgICAqCiAgICAgKiAgVGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQgd2hlbiB0aGUgWE1MSHR0cFJlcXVlc3QgcmVhZHlTdGF0ZSBjaGFuZ2VzLgogICAgICogIEl0IGNvbnRhaW5zIGEgbG90IG9mIGVycm9yIGhhbmRsaW5nIGxvZ2ljIGZvciB0aGUgbWFueSB3YXlzIHRoYXQKICAgICAqICByZXF1ZXN0cyBjYW4gZmFpbCwgYW5kIGNhbGxzIHRoZSByZXF1ZXN0IGNhbGxiYWNrIHdoZW4gcmVxdWVzdHMKICAgICAqICBzdWNjZWVkLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKEZ1bmN0aW9uKSBmdW5jIC0gVGhlIGhhbmRsZXIgZm9yIHRoZSByZXF1ZXN0LgogICAgICogICAgKFN0cm9waGUuUmVxdWVzdCkgcmVxIC0gVGhlIHJlcXVlc3QgdGhhdCBpcyBjaGFuZ2luZyByZWFkeVN0YXRlLgogICAgICovCiAgICBfb25SZXF1ZXN0U3RhdGVDaGFuZ2U6IGZ1bmN0aW9uIChmdW5jLCByZXEpCiAgICB7CiAgICAgICAgU3Ryb3BoZS5kZWJ1ZygicmVxdWVzdCBpZCAiICsgcmVxLmlkICsKICAgICAgICAgICAgICAgICAgICAgICIuIiArIHJlcS5zZW5kcyArICIgc3RhdGUgY2hhbmdlZCB0byAiICsKICAgICAgICAgICAgICAgICAgICAgIHJlcS54aHIucmVhZHlTdGF0ZSk7CgogICAgICAgIGlmIChyZXEuYWJvcnQpIHsKICAgICAgICAgICAgcmVxLmFib3J0ID0gZmFsc2U7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIHJlcXVlc3QgY29tcGxldGUKICAgICAgICB2YXIgcmVxU3RhdHVzOwogICAgICAgIGlmIChyZXEueGhyLnJlYWR5U3RhdGUgPT0gNCkgewogICAgICAgICAgICByZXFTdGF0dXMgPSAwOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmVxU3RhdHVzID0gcmVxLnhoci5zdGF0dXM7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIC8vIGlnbm9yZSBlcnJvcnMgZnJvbSB1bmRlZmluZWQgc3RhdHVzIGF0dHJpYnV0ZS4gIHdvcmtzCiAgICAgICAgICAgICAgICAvLyBhcm91bmQgYSBicm93c2VyIGJ1ZwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodHlwZW9mKHJlcVN0YXR1cykgPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIHJlcVN0YXR1cyA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmRpc2Nvbm5lY3RpbmcpIHsKICAgICAgICAgICAgICAgIGlmIChyZXFTdGF0dXMgPj0gNDAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGl0RXJyb3IocmVxU3RhdHVzKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciByZXFJczAgPSAodGhpcy5fcmVxdWVzdHNbMF0gPT0gcmVxKTsKICAgICAgICAgICAgdmFyIHJlcUlzMSA9ICh0aGlzLl9yZXF1ZXN0c1sxXSA9PSByZXEpOwoKICAgICAgICAgICAgaWYgKChyZXFTdGF0dXMgPiAwICYmIHJlcVN0YXR1cyA8IDUwMCkgfHwgcmVxLnNlbmRzID4gNSkgewogICAgICAgICAgICAgICAgLy8gcmVtb3ZlIGZyb20gaW50ZXJuYWwgcXVldWUKICAgICAgICAgICAgICAgIHRoaXMuX3JlbW92ZVJlcXVlc3QocmVxKTsKICAgICAgICAgICAgICAgIFN0cm9waGUuZGVidWcoInJlcXVlc3QgaWQgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcS5pZCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgc2hvdWxkIG5vdyBiZSByZW1vdmVkIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHJlcXVlc3Qgc3VjY2VlZGVkCiAgICAgICAgICAgIGlmIChyZXFTdGF0dXMgPT0gMjAwKSB7CiAgICAgICAgICAgICAgICAvLyBpZiByZXF1ZXN0IDEgZmluaXNoZWQsIG9yIHJlcXVlc3QgMCBmaW5pc2hlZCBhbmQgcmVxdWVzdAogICAgICAgICAgICAgICAgLy8gMSBpcyBvdmVyIFN0cm9waGUuU0VDT05EQVJZX1RJTUVPVVQgc2Vjb25kcyBvbGQsIHdlIG5lZWQgdG8KICAgICAgICAgICAgICAgIC8vIHJlc3RhcnQgdGhlIG90aGVyIC0gYm90aCB3aWxsIGJlIGluIHRoZSBmaXJzdCBzcG90LCBhcyB0aGUKICAgICAgICAgICAgICAgIC8vIGNvbXBsZXRlZCByZXF1ZXN0IGhhcyBiZWVuIHJlbW92ZWQgZnJvbSB0aGUgcXVldWUgYWxyZWFkeQogICAgICAgICAgICAgICAgaWYgKHJlcUlzMSB8fAogICAgICAgICAgICAgICAgICAgIChyZXFJczAgJiYgdGhpcy5fcmVxdWVzdHMubGVuZ3RoID4gMCAmJgogICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXF1ZXN0c1swXS5hZ2UoKSA+IE1hdGguZmxvb3IoU3Ryb3BoZS5TRUNPTkRBUllfVElNRU9VVCAqIHRoaXMud2FpdCkpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzdGFydFJlcXVlc3QoMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBjYWxsIGhhbmRsZXIKICAgICAgICAgICAgICAgIFN0cm9waGUuZGVidWcoInJlcXVlc3QgaWQgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcS5pZCArICIuIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcS5zZW5kcyArICIgZ290IDIwMCIpOwogICAgICAgICAgICAgICAgZnVuYyhyZXEpOwogICAgICAgICAgICAgICAgdGhpcy5lcnJvcnMgPSAwOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgU3Ryb3BoZS5lcnJvcigicmVxdWVzdCBpZCAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxLmlkICsgIi4iICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxLnNlbmRzICsgIiBlcnJvciAiICsgcmVxU3RhdHVzICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiBoYXBwZW5lZCIpOwogICAgICAgICAgICAgICAgaWYgKHJlcVN0YXR1cyA9PT0gMCB8fAogICAgICAgICAgICAgICAgICAgIChyZXFTdGF0dXMgPj0gNDAwICYmIHJlcVN0YXR1cyA8IDYwMCkgfHwKICAgICAgICAgICAgICAgICAgICByZXFTdGF0dXMgPj0gMTIwMDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaXRFcnJvcihyZXFTdGF0dXMpOwogICAgICAgICAgICAgICAgICAgIGlmIChyZXFTdGF0dXMgPj0gNDAwICYmIHJlcVN0YXR1cyA8IDUwMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jb25uLl9jaGFuZ2VDb25uZWN0U3RhdHVzKFN0cm9waGUuU3RhdHVzLkRJU0NPTk5FQ1RJTkcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVsbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2Nvbm4uX2RvRGlzY29ubmVjdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCEoKHJlcVN0YXR1cyA+IDAgJiYgcmVxU3RhdHVzIDwgNTAwKSB8fAogICAgICAgICAgICAgICAgICByZXEuc2VuZHMgPiA1KSkgewogICAgICAgICAgICAgICAgdGhpcy5fdGhyb3R0bGVkUmVxdWVzdEhhbmRsZXIoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX3Byb2Nlc3NSZXF1ZXN0CiAgICAgKiAgX1ByaXZhdGVfIGZ1bmN0aW9uIHRvIHByb2Nlc3MgYSByZXF1ZXN0IGluIHRoZSBxdWV1ZS4KICAgICAqCiAgICAgKiAgVGhpcyBmdW5jdGlvbiB0YWtlcyByZXF1ZXN0cyBvZmYgdGhlIHF1ZXVlIGFuZCBzZW5kcyB0aGVtIGFuZAogICAgICogIHJlc3RhcnRzIGRlYWQgcmVxdWVzdHMuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoSW50ZWdlcikgaSAtIFRoZSBpbmRleCBvZiB0aGUgcmVxdWVzdCBpbiB0aGUgcXVldWUuCiAgICAgKi8KICAgIF9wcm9jZXNzUmVxdWVzdDogZnVuY3Rpb24gKGkpCiAgICB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIHZhciByZXEgPSB0aGlzLl9yZXF1ZXN0c1tpXTsKICAgICAgICB2YXIgcmVxU3RhdHVzID0gLTE7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChyZXEueGhyLnJlYWR5U3RhdGUgPT0gNCkgewogICAgICAgICAgICAgICAgcmVxU3RhdHVzID0gcmVxLnhoci5zdGF0dXM7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIFN0cm9waGUuZXJyb3IoImNhdWdodCBhbiBlcnJvciBpbiBfcmVxdWVzdHNbIiArIGkgKwogICAgICAgICAgICAgICAgICAgICAgICAgICJdLCByZXFTdGF0dXM6ICIgKyByZXFTdGF0dXMpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZihyZXFTdGF0dXMpID09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIHJlcVN0YXR1cyA9IC0xOwogICAgICAgIH0KCiAgICAgICAgLy8gbWFrZSBzdXJlIHdlIGxpbWl0IHRoZSBudW1iZXIgb2YgcmV0cmllcwogICAgICAgIGlmIChyZXEuc2VuZHMgPiB0aGlzLm1heFJldHJpZXMpIHsKICAgICAgICAgICAgdGhpcy5fb25EaXNjb25uZWN0VGltZW91dCgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgdGltZV9lbGFwc2VkID0gcmVxLmFnZSgpOwogICAgICAgIHZhciBwcmltYXJ5VGltZW91dCA9ICghaXNOYU4odGltZV9lbGFwc2VkKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lX2VsYXBzZWQgPiBNYXRoLmZsb29yKFN0cm9waGUuVElNRU9VVCAqIHRoaXMud2FpdCkpOwogICAgICAgIHZhciBzZWNvbmRhcnlUaW1lb3V0ID0gKHJlcS5kZWFkICE9PSBudWxsICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxLnRpbWVEZWFkKCkgPiBNYXRoLmZsb29yKFN0cm9waGUuU0VDT05EQVJZX1RJTUVPVVQgKiB0aGlzLndhaXQpKTsKICAgICAgICB2YXIgcmVxdWVzdENvbXBsZXRlZFdpdGhTZXJ2ZXJFcnJvciA9IChyZXEueGhyLnJlYWR5U3RhdGUgPT0gNCAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChyZXFTdGF0dXMgPCAxIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcVN0YXR1cyA+PSA1MDApKTsKICAgICAgICBpZiAocHJpbWFyeVRpbWVvdXQgfHwgc2Vjb25kYXJ5VGltZW91dCB8fAogICAgICAgICAgICByZXF1ZXN0Q29tcGxldGVkV2l0aFNlcnZlckVycm9yKSB7CiAgICAgICAgICAgIGlmIChzZWNvbmRhcnlUaW1lb3V0KSB7CiAgICAgICAgICAgICAgICBTdHJvcGhlLmVycm9yKCJSZXF1ZXN0ICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXF1ZXN0c1tpXS5pZCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgdGltZWQgb3V0IChzZWNvbmRhcnkpLCByZXN0YXJ0aW5nIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVxLmFib3J0ID0gdHJ1ZTsKICAgICAgICAgICAgcmVxLnhoci5hYm9ydCgpOwogICAgICAgICAgICAvLyBzZXR0aW5nIHRvIG51bGwgZmFpbHMgb24gSUU2LCBzbyBzZXQgdG8gZW1wdHkgZnVuY3Rpb24KICAgICAgICAgICAgcmVxLnhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbiAoKSB7fTsKICAgICAgICAgICAgdGhpcy5fcmVxdWVzdHNbaV0gPSBuZXcgU3Ryb3BoZS5SZXF1ZXN0KHJlcS54bWxEYXRhLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxLm9yaWdGdW5jLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxLnJpZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcS5zZW5kcyk7CiAgICAgICAgICAgIHJlcSA9IHRoaXMuX3JlcXVlc3RzW2ldOwogICAgICAgIH0KCiAgICAgICAgaWYgKHJlcS54aHIucmVhZHlTdGF0ZSA9PT0gMCkgewogICAgICAgICAgICBTdHJvcGhlLmRlYnVnKCJyZXF1ZXN0IGlkICIgKyByZXEuaWQgKwogICAgICAgICAgICAgICAgICAgICAgICAgICIuIiArIHJlcS5zZW5kcyArICIgcG9zdGluZyIpOwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJlcS54aHIub3BlbigiUE9TVCIsIHRoaXMuX2Nvbm4uc2VydmljZSwgdGhpcy5fY29ubi5vcHRpb25zLnN5bmMgPyBmYWxzZSA6IHRydWUpOwogICAgICAgICAgICB9IGNhdGNoIChlMikgewogICAgICAgICAgICAgICAgU3Ryb3BoZS5lcnJvcigiWEhSIG9wZW4gZmFpbGVkLiIpOwogICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9jb25uLmNvbm5lY3RlZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2Nvbm4uX2NoYW5nZUNvbm5lY3RTdGF0dXMoU3Ryb3BoZS5TdGF0dXMuQ09OTkZBSUwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiYmFkLXNlcnZpY2UiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2Nvbm4uZGlzY29ubmVjdCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGaXJlcyB0aGUgWEhSIHJlcXVlc3QgLS0gbWF5IGJlIGludm9rZWQgaW1tZWRpYXRlbHkKICAgICAgICAgICAgLy8gb3Igb24gYSBncmFkdWFsbHkgZXhwYW5kaW5nIHJldHJ5IHdpbmRvdyBmb3IgcmVjb25uZWN0cwogICAgICAgICAgICB2YXIgc2VuZEZ1bmMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXEuZGF0ZSA9IG5ldyBEYXRlKCk7CiAgICAgICAgICAgICAgICBpZiAoc2VsZi5fY29ubi5vcHRpb25zLmN1c3RvbUhlYWRlcnMpewogICAgICAgICAgICAgICAgICAgIHZhciBoZWFkZXJzID0gc2VsZi5fY29ubi5vcHRpb25zLmN1c3RvbUhlYWRlcnM7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaGVhZGVyIGluIGhlYWRlcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhlYWRlcnMuaGFzT3duUHJvcGVydHkoaGVhZGVyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxLnhoci5zZXRSZXF1ZXN0SGVhZGVyKGhlYWRlciwgaGVhZGVyc1toZWFkZXJdKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlcS54aHIuc2VuZChyZXEuZGF0YSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBJbXBsZW1lbnQgcHJvZ3Jlc3NpdmUgYmFja29mZiBmb3IgcmVjb25uZWN0cyAtLQogICAgICAgICAgICAvLyBGaXJzdCByZXRyeSAoc2VuZCA9PSAxKSBzaG91bGQgYWxzbyBiZSBpbnN0YW50YW5lb3VzCiAgICAgICAgICAgIGlmIChyZXEuc2VuZHMgPiAxKSB7CiAgICAgICAgICAgICAgICAvLyBVc2luZyBhIGN1YmUgb2YgdGhlIHJldHJ5IG51bWJlciBjcmVhdGVzIGEgbmljZWx5CiAgICAgICAgICAgICAgICAvLyBleHBhbmRpbmcgcmV0cnkgd2luZG93CiAgICAgICAgICAgICAgICB2YXIgYmFja29mZiA9IE1hdGgubWluKE1hdGguZmxvb3IoU3Ryb3BoZS5USU1FT1VUICogdGhpcy53YWl0KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5wb3cocmVxLnNlbmRzLCAzKSkgKiAxMDAwOwogICAgICAgICAgICAgICAgc2V0VGltZW91dChzZW5kRnVuYywgYmFja29mZik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzZW5kRnVuYygpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXEuc2VuZHMrKzsKCiAgICAgICAgICAgIGlmICh0aGlzLl9jb25uLnhtbE91dHB1dCAhPT0gU3Ryb3BoZS5Db25uZWN0aW9uLnByb3RvdHlwZS54bWxPdXRwdXQpIHsKICAgICAgICAgICAgICAgIGlmIChyZXEueG1sRGF0YS5ub2RlTmFtZSA9PT0gdGhpcy5zdHJpcCAmJiByZXEueG1sRGF0YS5jaGlsZE5vZGVzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2Nvbm4ueG1sT3V0cHV0KHJlcS54bWxEYXRhLmNoaWxkTm9kZXNbMF0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jb25uLnhtbE91dHB1dChyZXEueG1sRGF0YSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuX2Nvbm4ucmF3T3V0cHV0ICE9PSBTdHJvcGhlLkNvbm5lY3Rpb24ucHJvdG90eXBlLnJhd091dHB1dCkgewogICAgICAgICAgICAgICAgdGhpcy5fY29ubi5yYXdPdXRwdXQocmVxLmRhdGEpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgU3Ryb3BoZS5kZWJ1ZygiX3Byb2Nlc3NSZXF1ZXN0OiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAoaSA9PT0gMCA/ICJmaXJzdCIgOiAic2Vjb25kIikgKwogICAgICAgICAgICAgICAgICAgICAgICAgICIgcmVxdWVzdCBoYXMgcmVhZHlTdGF0ZSBvZiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXEueGhyLnJlYWR5U3RhdGUpOwogICAgICAgIH0KICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX3JlbW92ZVJlcXVlc3QKICAgICAqICBfUHJpdmF0ZV8gZnVuY3Rpb24gdG8gcmVtb3ZlIGEgcmVxdWVzdCBmcm9tIHRoZSBxdWV1ZS4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJvcGhlLlJlcXVlc3QpIHJlcSAtIFRoZSByZXF1ZXN0IHRvIHJlbW92ZS4KICAgICAqLwogICAgX3JlbW92ZVJlcXVlc3Q6IGZ1bmN0aW9uIChyZXEpCiAgICB7CiAgICAgICAgU3Ryb3BoZS5kZWJ1ZygicmVtb3ZpbmcgcmVxdWVzdCIpOwoKICAgICAgICB2YXIgaTsKICAgICAgICBmb3IgKGkgPSB0aGlzLl9yZXF1ZXN0cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICBpZiAocmVxID09IHRoaXMuX3JlcXVlc3RzW2ldKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9yZXF1ZXN0cy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIElFNiBmYWlscyBvbiBzZXR0aW5nIHRvIG51bGwsIHNvIHNldCB0byBlbXB0eSBmdW5jdGlvbgogICAgICAgIHJlcS54aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKCkge307CgogICAgICAgIHRoaXMuX3Rocm90dGxlZFJlcXVlc3RIYW5kbGVyKCk7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9yZXN0YXJ0UmVxdWVzdAogICAgICogIF9Qcml2YXRlXyBmdW5jdGlvbiB0byByZXN0YXJ0IGEgcmVxdWVzdCB0aGF0IGlzIHByZXN1bWVkIGRlYWQuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoSW50ZWdlcikgaSAtIFRoZSBpbmRleCBvZiB0aGUgcmVxdWVzdCBpbiB0aGUgcXVldWUuCiAgICAgKi8KICAgIF9yZXN0YXJ0UmVxdWVzdDogZnVuY3Rpb24gKGkpCiAgICB7CiAgICAgICAgdmFyIHJlcSA9IHRoaXMuX3JlcXVlc3RzW2ldOwogICAgICAgIGlmIChyZXEuZGVhZCA9PT0gbnVsbCkgewogICAgICAgICAgICByZXEuZGVhZCA9IG5ldyBEYXRlKCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9wcm9jZXNzUmVxdWVzdChpKTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX3JlcVRvRGF0YQogICAgICogX1ByaXZhdGVfIGZ1bmN0aW9uIHRvIGdldCBhIHN0YW56YSBvdXQgb2YgYSByZXF1ZXN0LgogICAgICoKICAgICAqIFRyaWVzIHRvIGV4dHJhY3QgYSBzdGFuemEgb3V0IG9mIGEgUmVxdWVzdCBPYmplY3QuCiAgICAgKiBXaGVuIHRoaXMgZmFpbHMgdGhlIGN1cnJlbnQgY29ubmVjdGlvbiB3aWxsIGJlIGRpc2Nvbm5lY3RlZC4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChPYmplY3QpIHJlcSAtIFRoZSBSZXF1ZXN0LgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgVGhlIHN0YW56YSB0aGF0IHdhcyBwYXNzZWQuCiAgICAgKi8KICAgIF9yZXFUb0RhdGE6IGZ1bmN0aW9uIChyZXEpCiAgICB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIHJlcS5nZXRSZXNwb25zZSgpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgaWYgKGUgIT0gInBhcnNlcmVycm9yIikgeyB0aHJvdyBlOyB9CiAgICAgICAgICAgIHRoaXMuX2Nvbm4uZGlzY29ubmVjdCgic3Ryb3BoZS1wYXJzZXJlcnJvciIpOwogICAgICAgIH0KICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX3NlbmRUZXJtaW5hdGUKICAgICAqICBfUHJpdmF0ZV8gZnVuY3Rpb24gdG8gc2VuZCBpbml0aWFsIGRpc2Nvbm5lY3Qgc2VxdWVuY2UuCiAgICAgKgogICAgICogIFRoaXMgaXMgdGhlIGZpcnN0IHN0ZXAgaW4gYSBncmFjZWZ1bCBkaXNjb25uZWN0LiAgSXQgc2VuZHMKICAgICAqICB0aGUgQk9TSCBzZXJ2ZXIgYSB0ZXJtaW5hdGUgYm9keSBhbmQgaW5jbHVkZXMgYW4gdW5hdmFpbGFibGUKICAgICAqICBwcmVzZW5jZSBpZiBhdXRoZW50aWNhdGlvbiBoYXMgY29tcGxldGVkLgogICAgICovCiAgICBfc2VuZFRlcm1pbmF0ZTogZnVuY3Rpb24gKHByZXMpCiAgICB7CiAgICAgICAgU3Ryb3BoZS5pbmZvKCJfc2VuZFRlcm1pbmF0ZSB3YXMgY2FsbGVkIik7CiAgICAgICAgdmFyIGJvZHkgPSB0aGlzLl9idWlsZEJvZHkoKS5hdHRycyh7dHlwZTogInRlcm1pbmF0ZSJ9KTsKCiAgICAgICAgaWYgKHByZXMpIHsKICAgICAgICAgICAgYm9keS5jbm9kZShwcmVzLnRyZWUoKSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgcmVxID0gbmV3IFN0cm9waGUuUmVxdWVzdChib2R5LnRyZWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9vblJlcXVlc3RTdGF0ZUNoYW5nZS5iaW5kKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLCB0aGlzLl9jb25uLl9kYXRhUmVjdi5iaW5kKHRoaXMuX2Nvbm4pKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2R5LnRyZWUoKS5nZXRBdHRyaWJ1dGUoInJpZCIpKTsKCiAgICAgICAgdGhpcy5fcmVxdWVzdHMucHVzaChyZXEpOwogICAgICAgIHRoaXMuX3Rocm90dGxlZFJlcXVlc3RIYW5kbGVyKCk7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9zZW5kCiAgICAgKiAgX1ByaXZhdGVfIHBhcnQgb2YgdGhlIENvbm5lY3Rpb24uc2VuZCBmdW5jdGlvbiBmb3IgQk9TSAogICAgICoKICAgICAqIEp1c3QgdHJpZ2dlcnMgdGhlIFJlcXVlc3RIYW5kbGVyIHRvIHNlbmQgdGhlIG1lc3NhZ2VzIHRoYXQgYXJlIGluIHRoZSBxdWV1ZQogICAgICovCiAgICBfc2VuZDogZnVuY3Rpb24gKCkgewogICAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9jb25uLl9pZGxlVGltZW91dCk7CiAgICAgICAgdGhpcy5fdGhyb3R0bGVkUmVxdWVzdEhhbmRsZXIoKTsKICAgICAgICB0aGlzLl9jb25uLl9pZGxlVGltZW91dCA9IHNldFRpbWVvdXQodGhpcy5fY29ubi5fb25JZGxlLmJpbmQodGhpcy5fY29ubiksIDEwMCk7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9zZW5kUmVzdGFydAogICAgICoKICAgICAqICBTZW5kIGFuIHhtcHA6cmVzdGFydCBzdGFuemEuCiAgICAgKi8KICAgIF9zZW5kUmVzdGFydDogZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICB0aGlzLl90aHJvdHRsZWRSZXF1ZXN0SGFuZGxlcigpOwogICAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9jb25uLl9pZGxlVGltZW91dCk7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF90aHJvdHRsZWRSZXF1ZXN0SGFuZGxlcgogICAgICogIF9Qcml2YXRlXyBmdW5jdGlvbiB0byB0aHJvdHRsZSByZXF1ZXN0cyB0byB0aGUgY29ubmVjdGlvbiB3aW5kb3cuCiAgICAgKgogICAgICogIFRoaXMgZnVuY3Rpb24gbWFrZXMgc3VyZSB3ZSBkb24ndCBzZW5kIHJlcXVlc3RzIHNvIGZhc3QgdGhhdCB0aGUKICAgICAqICByZXF1ZXN0IGlkcyBvdmVyZmxvdyB0aGUgY29ubmVjdGlvbiB3aW5kb3cgaW4gdGhlIGNhc2UgdGhhdCBvbmUKICAgICAqICByZXF1ZXN0IGRpZWQuCiAgICAgKi8KICAgIF90aHJvdHRsZWRSZXF1ZXN0SGFuZGxlcjogZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICBpZiAoIXRoaXMuX3JlcXVlc3RzKSB7CiAgICAgICAgICAgIFN0cm9waGUuZGVidWcoIl90aHJvdHRsZWRSZXF1ZXN0SGFuZGxlciBjYWxsZWQgd2l0aCAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAidW5kZWZpbmVkIHJlcXVlc3RzIik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgU3Ryb3BoZS5kZWJ1ZygiX3Rocm90dGxlZFJlcXVlc3RIYW5kbGVyIGNhbGxlZCB3aXRoICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlcXVlc3RzLmxlbmd0aCArICIgcmVxdWVzdHMiKTsKICAgICAgICB9CgogICAgICAgIGlmICghdGhpcy5fcmVxdWVzdHMgfHwgdGhpcy5fcmVxdWVzdHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9yZXF1ZXN0cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHRoaXMuX3Byb2Nlc3NSZXF1ZXN0KDApOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX3JlcXVlc3RzLmxlbmd0aCA+IDEgJiYKICAgICAgICAgICAgTWF0aC5hYnModGhpcy5fcmVxdWVzdHNbMF0ucmlkIC0KICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVxdWVzdHNbMV0ucmlkKSA8IHRoaXMud2luZG93KSB7CiAgICAgICAgICAgIHRoaXMuX3Byb2Nlc3NSZXF1ZXN0KDEpOwogICAgICAgIH0KICAgIH0KfTsKCi8qCiAgICBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBNSVQgbGljZW5zZS4KICAgIFBsZWFzZSBzZWUgdGhlIExJQ0VOU0UgZmlsZSBmb3IgZGV0YWlscy4KCiAgICBDb3B5cmlnaHQgMjAwNi0yMDA4LCBPR0csIExMQwoqLwoKLyoganNoaW50IHVuZGVmOiB0cnVlLCB1bnVzZWQ6IHRydWU6LCBub2FyZzogdHJ1ZSwgbGF0ZWRlZjogdHJ1ZSAqLwovKmdsb2JhbCBkb2N1bWVudCwgd2luZG93LCBjbGVhclRpbWVvdXQsIFdlYlNvY2tldCwKICAgIERPTVBhcnNlciwgU3Ryb3BoZSwgJGJ1aWxkICovCgovKiogQ2xhc3M6IFN0cm9waGUuV2ViU29ja2V0CiAqICBfUHJpdmF0ZV8gaGVscGVyIGNsYXNzIHRoYXQgaGFuZGxlcyBXZWJTb2NrZXQgQ29ubmVjdGlvbnMKICoKICogIFRoZSBTdHJvcGhlLldlYlNvY2tldCBjbGFzcyBpcyB1c2VkIGludGVybmFsbHkgYnkgU3Ryb3BoZS5Db25uZWN0aW9uCiAqICB0byBlbmNhcHN1bGF0ZSBXZWJTb2NrZXQgc2Vzc2lvbnMuIEl0IGlzIG5vdCBtZWFudCB0byBiZSB1c2VkIGZyb20gdXNlcidzIGNvZGUuCiAqLwoKLyoqIEZpbGU6IHdlYnNvY2tldC5qcwogKiAgQSBKYXZhU2NyaXB0IGxpYnJhcnkgdG8gZW5hYmxlIFhNUFAgb3ZlciBXZWJzb2NrZXQgaW4gU3Ryb3BoZWpzLgogKgogKiAgVGhpcyBmaWxlIGltcGxlbWVudHMgWE1QUCBvdmVyIFdlYlNvY2tldHMgZm9yIFN0cm9waGVqcy4KICogIElmIGEgQ29ubmVjdGlvbiBpcyBlc3RhYmxpc2hlZCB3aXRoIGEgV2Vic29ja2V0IHVybCAod3M6Ly8uLi4pCiAqICBTdHJvcGhlIHdpbGwgdXNlIFdlYlNvY2tldHMuCiAqICBGb3IgbW9yZSBpbmZvcm1hdGlvbiBvbiBYTVBQLW92ZXIgV2ViU29ja2V0IHNlZSB0aGlzIFJGQyBkcmFmdDoKICogIGh0dHA6Ly90b29scy5pZXRmLm9yZy9odG1sL2RyYWZ0LWlldGYteG1wcC13ZWJzb2NrZXQtMDAKICoKICogIFdlYlNvY2tldCBzdXBwb3J0IGltcGxlbWVudGVkIGJ5IEFuZHJlYXMgR3V0aCAoYW5kcmVhcy5ndXRoQHJ3dGgtYWFjaGVuLmRlKQogKi8KCi8qKiBQcml2YXRlQ29uc3RydWN0b3I6IFN0cm9waGUuV2Vic29ja2V0CiAqICBDcmVhdGUgYW5kIGluaXRpYWxpemUgYSBTdHJvcGhlLldlYlNvY2tldCBvYmplY3QuCiAqICBDdXJyZW50bHkgb25seSBzZXRzIHRoZSBjb25uZWN0aW9uIE9iamVjdC4KICoKICogIFBhcmFtZXRlcnM6CiAqICAgIChTdHJvcGhlLkNvbm5lY3Rpb24pIGNvbm5lY3Rpb24gLSBUaGUgU3Ryb3BoZS5Db25uZWN0aW9uIHRoYXQgd2lsbCB1c2UgV2ViU29ja2V0cy4KICoKICogIFJldHVybnM6CiAqICAgIEEgbmV3IFN0cm9waGUuV2ViU29ja2V0IG9iamVjdC4KICovClN0cm9waGUuV2Vic29ja2V0ID0gZnVuY3Rpb24oY29ubmVjdGlvbikgewogICAgdGhpcy5fY29ubiA9IGNvbm5lY3Rpb247CiAgICB0aGlzLnN0cmlwID0gInN0cmVhbTpzdHJlYW0iOwoKICAgIHZhciBzZXJ2aWNlID0gY29ubmVjdGlvbi5zZXJ2aWNlOwogICAgaWYgKHNlcnZpY2UuaW5kZXhPZigid3M6IikgIT09IDAgJiYgc2VydmljZS5pbmRleE9mKCJ3c3M6IikgIT09IDApIHsKICAgICAgICAvLyBJZiB0aGUgc2VydmljZSBpcyBub3QgYW4gYWJzb2x1dGUgVVJMLCBhc3N1bWUgaXQgaXMgYSBwYXRoIGFuZCBwdXQgdGhlIGFic29sdXRlCiAgICAgICAgLy8gVVJMIHRvZ2V0aGVyIGZyb20gb3B0aW9ucywgY3VycmVudCBVUkwgYW5kIHRoZSBwYXRoLgogICAgICAgIHZhciBuZXdfc2VydmljZSA9ICIiOwoKICAgICAgICBpZiAoY29ubmVjdGlvbi5vcHRpb25zLnByb3RvY29sID09PSAid3MiICYmIHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbCAhPT0gImh0dHBzOiIpIHsKICAgICAgICAgICAgbmV3X3NlcnZpY2UgKz0gIndzIjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXdfc2VydmljZSArPSAid3NzIjsKICAgICAgICB9CgogICAgICAgIG5ld19zZXJ2aWNlICs9ICI6Ly8iICsgd2luZG93LmxvY2F0aW9uLmhvc3Q7CgogICAgICAgIGlmIChzZXJ2aWNlLmluZGV4T2YoIi8iKSAhPT0gMCkgewogICAgICAgICAgICBuZXdfc2VydmljZSArPSB3aW5kb3cubG9jYXRpb24ucGF0aG5hbWUgKyBzZXJ2aWNlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5ld19zZXJ2aWNlICs9IHNlcnZpY2U7CiAgICAgICAgfQoKICAgICAgICBjb25uZWN0aW9uLnNlcnZpY2UgPSBuZXdfc2VydmljZTsKICAgIH0KfTsKClN0cm9waGUuV2Vic29ja2V0LnByb3RvdHlwZSA9IHsKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9idWlsZFN0cmVhbQogICAgICogIF9Qcml2YXRlXyBoZWxwZXIgZnVuY3Rpb24gdG8gZ2VuZXJhdGUgdGhlIDxzdHJlYW0+IHN0YXJ0IHRhZyBmb3IgV2ViU29ja2V0cwogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgQSBTdHJvcGhlLkJ1aWxkZXIgd2l0aCBhIDxzdHJlYW0+IGVsZW1lbnQuCiAgICAgKi8KICAgIF9idWlsZFN0cmVhbTogZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICByZXR1cm4gJGJ1aWxkKCJzdHJlYW06c3RyZWFtIiwgewogICAgICAgICAgICAidG8iOiB0aGlzLl9jb25uLmRvbWFpbiwKICAgICAgICAgICAgInhtbG5zIjogU3Ryb3BoZS5OUy5DTElFTlQsCiAgICAgICAgICAgICJ4bWxuczpzdHJlYW0iOiBTdHJvcGhlLk5TLlNUUkVBTSwKICAgICAgICAgICAgInZlcnNpb24iOiAnMS4wJwogICAgICAgIH0pOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfY2hlY2tfc3RyZWFtZXJyb3IKICAgICAqIF9Qcml2YXRlXyBjaGVja3MgYSBtZXNzYWdlIGZvciBzdHJlYW06ZXJyb3IKICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJvcGhlLlJlcXVlc3QpIGJvZHlXcmFwIC0gVGhlIHJlY2VpdmVkIHN0YW56YS4KICAgICAqICAgIGNvbm5lY3RzdGF0dXMgLSBUaGUgQ29ubmVjdFN0YXR1cyB0aGF0IHdpbGwgYmUgc2V0IG9uIGVycm9yLgogICAgICogIFJldHVybnM6CiAgICAgKiAgICAgdHJ1ZSBpZiB0aGVyZSB3YXMgYSBzdHJlYW1lcnJvciwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICovCiAgICBfY2hlY2tfc3RyZWFtZXJyb3I6IGZ1bmN0aW9uIChib2R5V3JhcCwgY29ubmVjdHN0YXR1cykgewogICAgICAgIHZhciBlcnJvcnMgPSBib2R5V3JhcC5nZXRFbGVtZW50c0J5VGFnTmFtZSgic3RyZWFtOmVycm9yIik7CiAgICAgICAgaWYgKGVycm9ycy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICB2YXIgZXJyb3IgPSBlcnJvcnNbMF07CgogICAgICAgIHZhciBjb25kaXRpb24gPSAiIjsKICAgICAgICB2YXIgdGV4dCA9ICIiOwoKICAgICAgICB2YXIgbnMgPSAidXJuOmlldGY6cGFyYW1zOnhtbDpuczp4bXBwLXN0cmVhbXMiOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXJyb3IuY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgZSA9IGVycm9yLmNoaWxkTm9kZXNbaV07CiAgICAgICAgICAgIGlmIChlLmdldEF0dHJpYnV0ZSgieG1sbnMiKSAhPT0gbnMpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9IGlmIChlLm5vZGVOYW1lID09PSAidGV4dCIpIHsKICAgICAgICAgICAgICAgIHRleHQgPSBlLnRleHRDb250ZW50OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uZGl0aW9uID0gZS5ub2RlTmFtZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIGVycm9yU3RyaW5nID0gIldlYlNvY2tldCBzdHJlYW0gZXJyb3I6ICI7CgogICAgICAgIGlmIChjb25kaXRpb24pIHsKICAgICAgICAgICAgZXJyb3JTdHJpbmcgKz0gY29uZGl0aW9uOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGVycm9yU3RyaW5nICs9ICJ1bmtub3duIjsKICAgICAgICB9CgogICAgICAgIGlmICh0ZXh0KSB7CiAgICAgICAgICAgIGVycm9yU3RyaW5nICs9ICIgLSAiICsgY29uZGl0aW9uOwogICAgICAgIH0KCiAgICAgICAgU3Ryb3BoZS5lcnJvcihlcnJvclN0cmluZyk7CgogICAgICAgIC8vIGNsb3NlIHRoZSBjb25uZWN0aW9uIG9uIHN0cmVhbV9lcnJvcgogICAgICAgIHRoaXMuX2Nvbm4uX2NoYW5nZUNvbm5lY3RTdGF0dXMoY29ubmVjdHN0YXR1cywgY29uZGl0aW9uKTsKICAgICAgICB0aGlzLl9jb25uLl9kb0Rpc2Nvbm5lY3QoKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX3Jlc2V0CiAgICAgKiAgUmVzZXQgdGhlIGNvbm5lY3Rpb24uCiAgICAgKgogICAgICogIFRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIGJ5IHRoZSByZXNldCBmdW5jdGlvbiBvZiB0aGUgU3Ryb3BoZSBDb25uZWN0aW9uLgogICAgICogIElzIG5vdCBuZWVkZWQgYnkgV2ViU29ja2V0cy4KICAgICAqLwogICAgX3Jlc2V0OiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIHJldHVybjsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX2Nvbm5lY3QKICAgICAqICBfUHJpdmF0ZV8gZnVuY3Rpb24gY2FsbGVkIGJ5IFN0cm9waGUuQ29ubmVjdGlvbi5jb25uZWN0CiAgICAgKgogICAgICogIENyZWF0ZXMgYSBXZWJTb2NrZXQgZm9yIGEgY29ubmVjdGlvbiBhbmQgYXNzaWducyBDYWxsYmFja3MgdG8gaXQuCiAgICAgKiAgRG9lcyBub3RoaW5nIGlmIHRoZXJlIGFscmVhZHkgaXMgYSBXZWJTb2NrZXQuCiAgICAgKi8KICAgIF9jb25uZWN0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gRW5zdXJlIHRoYXQgdGhlcmUgaXMgbm8gb3BlbiBXZWJTb2NrZXQgZnJvbSBhIHByZXZpb3VzIENvbm5lY3Rpb24uCiAgICAgICAgdGhpcy5fY2xvc2VTb2NrZXQoKTsKCiAgICAgICAgLy8gQ3JlYXRlIHRoZSBuZXcgV29iU29ja2V0CiAgICAgICAgdGhpcy5zb2NrZXQgPSBuZXcgV2ViU29ja2V0KHRoaXMuX2Nvbm4uc2VydmljZSwgInhtcHAiKTsKICAgICAgICB0aGlzLnNvY2tldC5vbm9wZW4gPSB0aGlzLl9vbk9wZW4uYmluZCh0aGlzKTsKICAgICAgICB0aGlzLnNvY2tldC5vbmVycm9yID0gdGhpcy5fb25FcnJvci5iaW5kKHRoaXMpOwogICAgICAgIHRoaXMuc29ja2V0Lm9uY2xvc2UgPSB0aGlzLl9vbkNsb3NlLmJpbmQodGhpcyk7CiAgICAgICAgdGhpcy5zb2NrZXQub25tZXNzYWdlID0gdGhpcy5fY29ubmVjdF9jYl93cmFwcGVyLmJpbmQodGhpcyk7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9jb25uZWN0X2NiCiAgICAgKiAgX1ByaXZhdGVfIGZ1bmN0aW9uIGNhbGxlZCBieSBTdHJvcGhlLkNvbm5lY3Rpb24uX2Nvbm5lY3RfY2IKICAgICAqCiAgICAgKiBjaGVja3MgZm9yIHN0cmVhbTplcnJvcgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cm9waGUuUmVxdWVzdCkgYm9keVdyYXAgLSBUaGUgcmVjZWl2ZWQgc3RhbnphLgogICAgICovCiAgICBfY29ubmVjdF9jYjogZnVuY3Rpb24oYm9keVdyYXApIHsKICAgICAgICB2YXIgZXJyb3IgPSB0aGlzLl9jaGVja19zdHJlYW1lcnJvcihib2R5V3JhcCwgU3Ryb3BoZS5TdGF0dXMuQ09OTkZBSUwpOwogICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICByZXR1cm4gU3Ryb3BoZS5TdGF0dXMuQ09OTkZBSUw7CiAgICAgICAgfQogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfaGFuZGxlU3RyZWFtU3RhcnQKICAgICAqIF9Qcml2YXRlXyBmdW5jdGlvbiB0aGF0IGNoZWNrcyB0aGUgb3BlbmluZyBzdHJlYW06c3RyZWFtIHRhZyBmb3IgZXJyb3JzLgogICAgICoKICAgICAqIERpc2Nvbm5lY3RzIGlmIHRoZXJlIGlzIGFuIGVycm9yIGFuZCByZXR1cm5zIGZhbHNlLCB0cnVlIG90aGVyd2lzZS4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChOb2RlKSBtZXNzYWdlIC0gU3RhbnphIGNvbnRhaW5pbmcgdGhlIHN0cmVhbTpzdHJlYW0uCiAgICAgKi8KICAgIF9oYW5kbGVTdHJlYW1TdGFydDogZnVuY3Rpb24obWVzc2FnZSkgewogICAgICAgIHZhciBlcnJvciA9IGZhbHNlOwogICAgICAgIC8vIENoZWNrIGZvciBlcnJvcnMgaW4gdGhlIHN0cmVhbTpzdHJlYW0gdGFnCiAgICAgICAgdmFyIG5zID0gbWVzc2FnZS5nZXRBdHRyaWJ1dGUoInhtbG5zIik7CiAgICAgICAgaWYgKHR5cGVvZiBucyAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgZXJyb3IgPSAiTWlzc2luZyB4bWxucyBpbiBzdHJlYW06c3RyZWFtIjsKICAgICAgICB9IGVsc2UgaWYgKG5zICE9PSBTdHJvcGhlLk5TLkNMSUVOVCkgewogICAgICAgICAgICBlcnJvciA9ICJXcm9uZyB4bWxucyBpbiBzdHJlYW06c3RyZWFtOiAiICsgbnM7CiAgICAgICAgfQoKICAgICAgICB2YXIgbnNfc3RyZWFtID0gbWVzc2FnZS5uYW1lc3BhY2VVUkk7CiAgICAgICAgaWYgKHR5cGVvZiBuc19zdHJlYW0gIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGVycm9yID0gIk1pc3NpbmcgeG1sbnM6c3RyZWFtIGluIHN0cmVhbTpzdHJlYW0iOwogICAgICAgIH0gZWxzZSBpZiAobnNfc3RyZWFtICE9PSBTdHJvcGhlLk5TLlNUUkVBTSkgewogICAgICAgICAgICBlcnJvciA9ICJXcm9uZyB4bWxuczpzdHJlYW0gaW4gc3RyZWFtOnN0cmVhbTogIiArIG5zX3N0cmVhbTsKICAgICAgICB9CgogICAgICAgIHZhciB2ZXIgPSBtZXNzYWdlLmdldEF0dHJpYnV0ZSgidmVyc2lvbiIpOwogICAgICAgIGlmICh0eXBlb2YgdmVyICE9PSAic3RyaW5nIikgewogICAgICAgICAgICBlcnJvciA9ICJNaXNzaW5nIHZlcnNpb24gaW4gc3RyZWFtOnN0cmVhbSI7CiAgICAgICAgfSBlbHNlIGlmICh2ZXIgIT09ICIxLjAiKSB7CiAgICAgICAgICAgIGVycm9yID0gIldyb25nIHZlcnNpb24gaW4gc3RyZWFtOnN0cmVhbTogIiArIHZlcjsKICAgICAgICB9CgogICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICB0aGlzLl9jb25uLl9jaGFuZ2VDb25uZWN0U3RhdHVzKFN0cm9waGUuU3RhdHVzLkNPTk5GQUlMLCBlcnJvcik7CiAgICAgICAgICAgIHRoaXMuX2Nvbm4uX2RvRGlzY29ubmVjdCgpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX2Nvbm5lY3RfY2Jfd3JhcHBlcgogICAgICogX1ByaXZhdGVfIGZ1bmN0aW9uIHRoYXQgaGFuZGxlcyB0aGUgZmlyc3QgY29ubmVjdGlvbiBtZXNzYWdlcy4KICAgICAqCiAgICAgKiBPbiByZWNlaXZpbmcgYW4gb3BlbmluZyBzdHJlYW0gdGFnIHRoaXMgY2FsbGJhY2sgcmVwbGFjZXMgaXRzZWxmIHdpdGggdGhlIHJlYWwKICAgICAqIG1lc3NhZ2UgaGFuZGxlci4gT24gcmVjZWl2aW5nIGEgc3RyZWFtIGVycm9yIHRoZSBjb25uZWN0aW9uIGlzIHRlcm1pbmF0ZWQuCiAgICAgKi8KICAgIF9jb25uZWN0X2NiX3dyYXBwZXI6IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgICBpZiAobWVzc2FnZS5kYXRhLmluZGV4T2YoIjxzdHJlYW06c3RyZWFtICIpID09PSAwIHx8IG1lc3NhZ2UuZGF0YS5pbmRleE9mKCI8P3htbCIpID09PSAwKSB7CiAgICAgICAgICAgIC8vIFN0cmlwIHRoZSBYTUwgRGVjbGFyYXRpb24sIGlmIHRoZXJlIGlzIG9uZQogICAgICAgICAgICB2YXIgZGF0YSA9IG1lc3NhZ2UuZGF0YS5yZXBsYWNlKC9eKDxcPy4qP1w/PlxzKikqLywgIiIpOwogICAgICAgICAgICBpZiAoZGF0YSA9PT0gJycpIHJldHVybjsKCiAgICAgICAgICAgIC8vTWFrZSB0aGUgaW5pdGlhbCBzdHJlYW06c3RyZWFtIHNlbGZjbG9zaW5nIHRvIHBhcnNlIGl0IHdpdGhvdXQgYSBTQVggcGFyc2VyLgogICAgICAgICAgICBkYXRhID0gbWVzc2FnZS5kYXRhLnJlcGxhY2UoLzxzdHJlYW06c3RyZWFtICguKlteXC9dKT4vLCAiPHN0cmVhbTpzdHJlYW0gJDEvPiIpOwoKICAgICAgICAgICAgdmFyIHN0cmVhbVN0YXJ0ID0gbmV3IERPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyhkYXRhLCAidGV4dC94bWwiKS5kb2N1bWVudEVsZW1lbnQ7CiAgICAgICAgICAgIHRoaXMuX2Nvbm4ueG1sSW5wdXQoc3RyZWFtU3RhcnQpOwogICAgICAgICAgICB0aGlzLl9jb25uLnJhd0lucHV0KG1lc3NhZ2UuZGF0YSk7CgogICAgICAgICAgICAvL19oYW5kbGVTdHJlYW1TdGVhcnQgd2lsbCBjaGVjayBmb3IgWE1MIGVycm9ycyBhbmQgZGlzY29ubmVjdCBvbiBlcnJvcgogICAgICAgICAgICBpZiAodGhpcy5faGFuZGxlU3RyZWFtU3RhcnQoc3RyZWFtU3RhcnQpKSB7CgogICAgICAgICAgICAgICAgLy9fY29ubmVjdF9jYiB3aWxsIGNoZWNrIGZvciBzdHJlYW06ZXJyb3IgYW5kIGRpc2Nvbm5lY3Qgb24gZXJyb3IKICAgICAgICAgICAgICAgIHRoaXMuX2Nvbm5lY3RfY2Ioc3RyZWFtU3RhcnQpOwoKICAgICAgICAgICAgICAgIC8vIGVuc3VyZSByZWNlaXZlZCBzdHJlYW06c3RyZWFtIGlzIE5PVCBzZWxmY2xvc2luZyBhbmQgc2F2ZSBpdCBmb3IgZm9sbG93aW5nIG1lc3NhZ2VzCiAgICAgICAgICAgICAgICB0aGlzLnN0cmVhbVN0YXJ0ID0gbWVzc2FnZS5kYXRhLnJlcGxhY2UoL148c3RyZWFtOiguKilcLz4kLywgIjxzdHJlYW06JDE+Iik7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKG1lc3NhZ2UuZGF0YSA9PT0gIjwvc3RyZWFtOnN0cmVhbT4iKSB7CiAgICAgICAgICAgIHRoaXMuX2Nvbm4ucmF3SW5wdXQobWVzc2FnZS5kYXRhKTsKICAgICAgICAgICAgdGhpcy5fY29ubi54bWxJbnB1dChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHJlYW06c3RyZWFtIikpOwogICAgICAgICAgICB0aGlzLl9jb25uLl9jaGFuZ2VDb25uZWN0U3RhdHVzKFN0cm9waGUuU3RhdHVzLkNPTk5GQUlMLCAiUmVjZWl2ZWQgY2xvc2luZyBzdHJlYW0iKTsKICAgICAgICAgICAgdGhpcy5fY29ubi5fZG9EaXNjb25uZWN0KCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgc3RyaW5nID0gdGhpcy5fc3RyZWFtV3JhcChtZXNzYWdlLmRhdGEpOwogICAgICAgICAgICB2YXIgZWxlbSA9IG5ldyBET01QYXJzZXIoKS5wYXJzZUZyb21TdHJpbmcoc3RyaW5nLCAidGV4dC94bWwiKS5kb2N1bWVudEVsZW1lbnQ7CiAgICAgICAgICAgIHRoaXMuc29ja2V0Lm9ubWVzc2FnZSA9IHRoaXMuX29uTWVzc2FnZS5iaW5kKHRoaXMpOwogICAgICAgICAgICB0aGlzLl9jb25uLl9jb25uZWN0X2NiKGVsZW0sIG51bGwsIG1lc3NhZ2UuZGF0YSk7CiAgICAgICAgfQogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfZGlzY29ubmVjdAogICAgICogIF9Qcml2YXRlXyBmdW5jdGlvbiBjYWxsZWQgYnkgU3Ryb3BoZS5Db25uZWN0aW9uLmRpc2Nvbm5lY3QKICAgICAqCiAgICAgKiAgRGlzY29ubmVjdHMgYW5kIHNlbmRzIGEgbGFzdCBzdGFuemEgaWYgb25lIGlzIGdpdmVuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoUmVxdWVzdCkgcHJlcyAtIFRoaXMgc3RhbnphIHdpbGwgYmUgc2VudCBiZWZvcmUgZGlzY29ubmVjdGluZy4KICAgICAqLwogICAgX2Rpc2Nvbm5lY3Q6IGZ1bmN0aW9uIChwcmVzKQogICAgewogICAgICAgIGlmICh0aGlzLnNvY2tldC5yZWFkeVN0YXRlICE9PSBXZWJTb2NrZXQuQ0xPU0VEKSB7CiAgICAgICAgICAgIGlmIChwcmVzKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jb25uLnNlbmQocHJlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNsb3NlID0gJzwvc3RyZWFtOnN0cmVhbT4nOwogICAgICAgICAgICB0aGlzLl9jb25uLnhtbE91dHB1dChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHJlYW06c3RyZWFtIikpOwogICAgICAgICAgICB0aGlzLl9jb25uLnJhd091dHB1dChjbG9zZSk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aGlzLnNvY2tldC5zZW5kKGNsb3NlKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgU3Ryb3BoZS5pbmZvKCJDb3VsZG4ndCBzZW5kIGNsb3Npbmcgc3RyZWFtIHRhZy4iKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5fY29ubi5fZG9EaXNjb25uZWN0KCk7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9kb0Rpc2Nvbm5lY3QKICAgICAqICBfUHJpdmF0ZV8gZnVuY3Rpb24gdG8gZGlzY29ubmVjdC4KICAgICAqCiAgICAgKiAgSnVzdCBjbG9zZXMgdGhlIFNvY2tldCBmb3IgV2ViU29ja2V0cwogICAgICovCiAgICBfZG9EaXNjb25uZWN0OiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIFN0cm9waGUuaW5mbygiV2ViU29ja2V0cyBfZG9EaXNjb25uZWN0IHdhcyBjYWxsZWQiKTsKICAgICAgICB0aGlzLl9jbG9zZVNvY2tldCgpOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uIF9zdHJlYW1XcmFwCiAgICAgKiAgX1ByaXZhdGVfIGhlbHBlciBmdW5jdGlvbiB0byB3cmFwIGEgc3RhbnphIGluIGEgPHN0cmVhbT4gdGFnLgogICAgICogIFRoaXMgaXMgdXNlZCBzbyBTdHJvcGhlIGNhbiBwcm9jZXNzIHN0YW56YXMgZnJvbSBXZWJTb2NrZXRzIGxpa2UgQk9TSAogICAgICovCiAgICBfc3RyZWFtV3JhcDogZnVuY3Rpb24gKHN0YW56YSkKICAgIHsKICAgICAgICByZXR1cm4gdGhpcy5zdHJlYW1TdGFydCArIHN0YW56YSArICc8L3N0cmVhbTpzdHJlYW0+JzsKICAgIH0sCgoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9jbG9zZVNvY2tldAogICAgICogIF9Qcml2YXRlXyBmdW5jdGlvbiB0byBjbG9zZSB0aGUgV2ViU29ja2V0LgogICAgICoKICAgICAqICBDbG9zZXMgdGhlIHNvY2tldCBpZiBpdCBpcyBzdGlsbCBvcGVuIGFuZCBkZWxldGVzIGl0CiAgICAgKi8KICAgIF9jbG9zZVNvY2tldDogZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICBpZiAodGhpcy5zb2NrZXQpIHsgdHJ5IHsKICAgICAgICAgICAgdGhpcy5zb2NrZXQuY2xvc2UoKTsKICAgICAgICB9IGNhdGNoIChlKSB7fSB9CiAgICAgICAgdGhpcy5zb2NrZXQgPSBudWxsOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfZW1wdHlRdWV1ZQogICAgICogX1ByaXZhdGVfIGZ1bmN0aW9uIHRvIGNoZWNrIGlmIHRoZSBtZXNzYWdlIHF1ZXVlIGlzIGVtcHR5LgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgVHJ1ZSwgYmVjYXVzZSBXZWJTb2NrZXQgbWVzc2FnZXMgYXJlIHNlbmQgaW1tZWRpYXRlbHkgYWZ0ZXIgcXVldWVpbmcuCiAgICAgKi8KICAgIF9lbXB0eVF1ZXVlOiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIHJldHVybiB0cnVlOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfb25DbG9zZQogICAgICogX1ByaXZhdGVfIGZ1bmN0aW9uIHRvIGhhbmRsZSB3ZWJzb2NrZXRzIGNsb3NpbmcuCiAgICAgKgogICAgICogTm90aGluZyB0byBkbyBoZXJlIGZvciBXZWJTb2NrZXRzCiAgICAgKi8KICAgIF9vbkNsb3NlOiBmdW5jdGlvbigpIHsKICAgICAgICBpZih0aGlzLl9jb25uLmNvbm5lY3RlZCAmJiAhdGhpcy5fY29ubi5kaXNjb25uZWN0aW5nKSB7CiAgICAgICAgICAgIFN0cm9waGUuZXJyb3IoIldlYnNvY2tldCBjbG9zZWQgdW5leGNlY3RlZGx5Iik7CiAgICAgICAgICAgIHRoaXMuX2Nvbm4uX2RvRGlzY29ubmVjdCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIFN0cm9waGUuaW5mbygiV2Vic29ja2V0IGNsb3NlZCIpOwogICAgICAgIH0KICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX25vX2F1dGhfcmVjZWl2ZWQKICAgICAqCiAgICAgKiBDYWxsZWQgb24gc3RyZWFtIHN0YXJ0L3Jlc3RhcnQgd2hlbiBubyBzdHJlYW06ZmVhdHVyZXMKICAgICAqIGhhcyBiZWVuIHJlY2VpdmVkLgogICAgICovCiAgICBfbm9fYXV0aF9yZWNlaXZlZDogZnVuY3Rpb24gKF9jYWxsYmFjaykKICAgIHsKICAgICAgICBTdHJvcGhlLmVycm9yKCJTZXJ2ZXIgZGlkIG5vdCBzZW5kIGFueSBhdXRoIG1ldGhvZHMiKTsKICAgICAgICB0aGlzLl9jb25uLl9jaGFuZ2VDb25uZWN0U3RhdHVzKFN0cm9waGUuU3RhdHVzLkNPTk5GQUlMLCAiU2VydmVyIGRpZCBub3Qgc2VuZCBhbnkgYXV0aCBtZXRob2RzIik7CiAgICAgICAgaWYgKF9jYWxsYmFjaykgewogICAgICAgICAgICBfY2FsbGJhY2sgPSBfY2FsbGJhY2suYmluZCh0aGlzLl9jb25uKTsKICAgICAgICAgICAgX2NhbGxiYWNrKCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX2Nvbm4uX2RvRGlzY29ubmVjdCgpOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfb25EaXNjb25uZWN0VGltZW91dAogICAgICogIF9Qcml2YXRlXyB0aW1lb3V0IGhhbmRsZXIgZm9yIGhhbmRsaW5nIG5vbi1ncmFjZWZ1bCBkaXNjb25uZWN0aW9uLgogICAgICoKICAgICAqICBUaGlzIGRvZXMgbm90aGluZyBmb3IgV2ViU29ja2V0cwogICAgICovCiAgICBfb25EaXNjb25uZWN0VGltZW91dDogZnVuY3Rpb24gKCkge30sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX29uRXJyb3IKICAgICAqIF9Qcml2YXRlXyBmdW5jdGlvbiB0byBoYW5kbGUgd2Vic29ja2V0cyBlcnJvcnMuCiAgICAgKgogICAgICogUGFyYW1ldGVyczoKICAgICAqIChPYmplY3QpIGVycm9yIC0gVGhlIHdlYnNvY2tldCBlcnJvci4KICAgICAqLwogICAgX29uRXJyb3I6IGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgICAgU3Ryb3BoZS5lcnJvcigiV2Vic29ja2V0IGVycm9yICIgKyBlcnJvcik7CiAgICAgICAgdGhpcy5fY29ubi5fY2hhbmdlQ29ubmVjdFN0YXR1cyhTdHJvcGhlLlN0YXR1cy5DT05ORkFJTCwgIlRoZSBXZWJTb2NrZXQgY29ubmVjdGlvbiBjb3VsZCBub3QgYmUgZXN0YWJsaXNoZWQgd2FzIGRpc2Nvbm5lY3RlZC4iKTsKICAgICAgICB0aGlzLl9kaXNjb25uZWN0KCk7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9vbklkbGUKICAgICAqICBfUHJpdmF0ZV8gZnVuY3Rpb24gY2FsbGVkIGJ5IFN0cm9waGUuQ29ubmVjdGlvbi5fb25JZGxlCiAgICAgKgogICAgICogIHNlbmRzIGFsbCBxdWV1ZWQgc3RhbnphcwogICAgICovCiAgICBfb25JZGxlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGRhdGEgPSB0aGlzLl9jb25uLl9kYXRhOwogICAgICAgIGlmIChkYXRhLmxlbmd0aCA+IDAgJiYgIXRoaXMuX2Nvbm4ucGF1c2VkKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKGRhdGFbaV0gIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc3RhbnphLCByYXdTdGFuemE7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGFbaV0gPT09ICJyZXN0YXJ0IikgewogICAgICAgICAgICAgICAgICAgICAgICBzdGFuemEgPSB0aGlzLl9idWlsZFN0cmVhbSgpOwogICAgICAgICAgICAgICAgICAgICAgICByYXdTdGFuemEgPSB0aGlzLl9yZW1vdmVDbG9zaW5nVGFnKHN0YW56YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YW56YSA9IHN0YW56YS50cmVlKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhbnphID0gZGF0YVtpXTsKICAgICAgICAgICAgICAgICAgICAgICAgcmF3U3RhbnphID0gU3Ryb3BoZS5zZXJpYWxpemUoc3RhbnphKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY29ubi54bWxPdXRwdXQoc3RhbnphKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jb25uLnJhd091dHB1dChyYXdTdGFuemEpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc29ja2V0LnNlbmQocmF3U3RhbnphKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9jb25uLl9kYXRhID0gW107CiAgICAgICAgfQogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfb25NZXNzYWdlCiAgICAgKiBfUHJpdmF0ZV8gZnVuY3Rpb24gdG8gaGFuZGxlIHdlYnNvY2tldHMgbWVzc2FnZXMuCiAgICAgKgogICAgICogVGhpcyBmdW5jdGlvbiBwYXJzZXMgZWFjaCBvZiB0aGUgbWVzc2FnZXMgYXMgaWYgdGhleSBhcmUgZnVsbCBkb2N1bWVudHMuIFtUT0RPIDogV2UgbWF5IGFjdHVhbGx5IHdhbnQgdG8gdXNlIGEgU0FYIFB1c2ggcGFyc2VyXS4KICAgICAqCiAgICAgKiBTaW5jZSBhbGwgWE1QUCB0cmFmZmljIHN0YXJ0cyB3aXRoICI8c3RyZWFtOnN0cmVhbSB2ZXJzaW9uPScxLjAnIHhtbDpsYW5nPSdlbicgeG1sbnM9J2phYmJlcjpjbGllbnQnIHhtbG5zOnN0cmVhbT0naHR0cDovL2V0aGVyeC5qYWJiZXIub3JnL3N0cmVhbXMnIGlkPSczNjk3Mzk1NDYzJyBmcm9tPSdTRVJWRVInPiIKICAgICAqIFRoZSBmaXJzdCBzdGFuemEgd2lsbCBhbHdheXMgZmFpbCB0byBiZSBwYXJzZWQuLi4KICAgICAqIEFkZHRpb25uYWx5LCB0aGUgc2Vjb25kcyBzdGFuemEgd2lsbCBhbHdheXMgYmUgYSA8c3RyZWFtOmZlYXR1cmVzPiB3aXRoIHRoZSBzdHJlYW0gTlMgZGVmaW5lZCBpbiB0aGUgcHJldmlvdXMgc3RhbnphLi4uIHNvIHdlIG5lZWQgdG8gJ2ZvcmNlJyB0aGUgaW5jbHVzaW9uIG9mIHRoZSBOUyBpbiB0aGlzIHN0YW56YSEKICAgICAqCiAgICAgKiBQYXJhbWV0ZXJzOgogICAgICogKHN0cmluZykgbWVzc2FnZSAtIFRoZSB3ZWJzb2NrZXQgbWVzc2FnZS4KICAgICAqLwogICAgX29uTWVzc2FnZTogZnVuY3Rpb24obWVzc2FnZSkgewogICAgICAgIHZhciBlbGVtLCBkYXRhOwogICAgICAgIC8vIGNoZWNrIGZvciBjbG9zaW5nIHN0cmVhbQogICAgICAgIGlmIChtZXNzYWdlLmRhdGEgPT09ICI8L3N0cmVhbTpzdHJlYW0+IikgewogICAgICAgICAgICB2YXIgY2xvc2UgPSAiPC9zdHJlYW06c3RyZWFtPiI7CiAgICAgICAgICAgIHRoaXMuX2Nvbm4ucmF3SW5wdXQoY2xvc2UpOwogICAgICAgICAgICB0aGlzLl9jb25uLnhtbElucHV0KGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInN0cmVhbTpzdHJlYW0iKSk7CiAgICAgICAgICAgIGlmICghdGhpcy5fY29ubi5kaXNjb25uZWN0aW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jb25uLl9kb0Rpc2Nvbm5lY3QoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfSBlbHNlIGlmIChtZXNzYWdlLmRhdGEuc2VhcmNoKCI8c3RyZWFtOnN0cmVhbSAiKSA9PT0gMCkgewogICAgICAgICAgICAvL01ha2UgdGhlIGluaXRpYWwgc3RyZWFtOnN0cmVhbSBzZWxmY2xvc2luZyB0byBwYXJzZSBpdCB3aXRob3V0IGEgU0FYIHBhcnNlci4KICAgICAgICAgICAgZGF0YSA9IG1lc3NhZ2UuZGF0YS5yZXBsYWNlKC88c3RyZWFtOnN0cmVhbSAoLipbXlwvXSk+LywgIjxzdHJlYW06c3RyZWFtICQxLz4iKTsKICAgICAgICAgICAgZWxlbSA9IG5ldyBET01QYXJzZXIoKS5wYXJzZUZyb21TdHJpbmcoZGF0YSwgInRleHQveG1sIikuZG9jdW1lbnRFbGVtZW50OwoKICAgICAgICAgICAgaWYgKCF0aGlzLl9oYW5kbGVTdHJlYW1TdGFydChlbGVtKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGF0YSA9IHRoaXMuX3N0cmVhbVdyYXAobWVzc2FnZS5kYXRhKTsKICAgICAgICAgICAgZWxlbSA9IG5ldyBET01QYXJzZXIoKS5wYXJzZUZyb21TdHJpbmcoZGF0YSwgInRleHQveG1sIikuZG9jdW1lbnRFbGVtZW50OwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX2NoZWNrX3N0cmVhbWVycm9yKGVsZW0sIFN0cm9waGUuU3RhdHVzLkVSUk9SKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvL2hhbmRsZSB1bmF2YWlsYWJsZSBwcmVzZW5jZSBzdGFuemEgYmVmb3JlIGRpc2Nvbm5lY3RpbmcKICAgICAgICBpZiAodGhpcy5fY29ubi5kaXNjb25uZWN0aW5nICYmCiAgICAgICAgICAgICAgICBlbGVtLmZpcnN0Q2hpbGQubm9kZU5hbWUgPT09ICJwcmVzZW5jZSIgJiYKICAgICAgICAgICAgICAgIGVsZW0uZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUoInR5cGUiKSA9PT0gInVuYXZhaWxhYmxlIikgewogICAgICAgICAgICB0aGlzLl9jb25uLnhtbElucHV0KGVsZW0pOwogICAgICAgICAgICB0aGlzLl9jb25uLnJhd0lucHV0KFN0cm9waGUuc2VyaWFsaXplKGVsZW0pKTsKICAgICAgICAgICAgLy8gaWYgd2UgYXJlIGFscmVhZHkgZGlzY29ubmVjdGluZyB3ZSB3aWxsIGlnbm9yZSB0aGUgdW5hdmFpbGFibGUgc3RhbnphIGFuZAogICAgICAgICAgICAvLyB3YWl0IGZvciB0aGUgPC9zdHJlYW06c3RyZWFtPiB0YWcgYmVmb3JlIHdlIGNsb3NlIHRoZSBjb25uZWN0aW9uCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy5fY29ubi5fZGF0YVJlY3YoZWxlbSwgbWVzc2FnZS5kYXRhKTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX29uT3BlbgogICAgICogX1ByaXZhdGVfIGZ1bmN0aW9uIHRvIGhhbmRsZSB3ZWJzb2NrZXRzIGNvbm5lY3Rpb24gc2V0dXAuCiAgICAgKgogICAgICogVGhlIG9wZW5pbmcgc3RyZWFtIHRhZyBpcyBzZW50IGhlcmUuCiAgICAgKi8KICAgIF9vbk9wZW46IGZ1bmN0aW9uKCkgewogICAgICAgIFN0cm9waGUuaW5mbygiV2Vic29ja2V0IG9wZW4iKTsKICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9idWlsZFN0cmVhbSgpOwogICAgICAgIHRoaXMuX2Nvbm4ueG1sT3V0cHV0KHN0YXJ0LnRyZWUoKSk7CgogICAgICAgIHZhciBzdGFydFN0cmluZyA9IHRoaXMuX3JlbW92ZUNsb3NpbmdUYWcoc3RhcnQpOwogICAgICAgIHRoaXMuX2Nvbm4ucmF3T3V0cHV0KHN0YXJ0U3RyaW5nKTsKICAgICAgICB0aGlzLnNvY2tldC5zZW5kKHN0YXJ0U3RyaW5nKTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX3JlbW92ZUNsb3NpbmdUYWcKICAgICAqICBfUHJpdmF0ZV8gZnVuY3Rpb24gdG8gTWFrZSB0aGUgZmlyc3QgPHN0cmVhbTpzdHJlYW0+IG5vbi1zZWxmY2xvc2luZwogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgICAoT2JqZWN0KSBlbGVtIC0gVGhlIDxzdHJlYW06c3RyZWFtPiB0YWcuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICAgIFRoZSBzdHJlYW06c3RyZWFtIHRhZyBhcyBTdHJpbmcKICAgICAqLwogICAgX3JlbW92ZUNsb3NpbmdUYWc6IGZ1bmN0aW9uKGVsZW0pIHsKICAgICAgICB2YXIgc3RyaW5nID0gU3Ryb3BoZS5zZXJpYWxpemUoZWxlbSk7CiAgICAgICAgc3RyaW5nID0gc3RyaW5nLnJlcGxhY2UoLzwoc3RyZWFtOnN0cmVhbSAuKlteXC9dKVwvPiQvLCAiPCQxPiIpOwogICAgICAgIHJldHVybiBzdHJpbmc7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9yZXFUb0RhdGEKICAgICAqIF9Qcml2YXRlXyBmdW5jdGlvbiB0byBnZXQgYSBzdGFuemEgb3V0IG9mIGEgcmVxdWVzdC4KICAgICAqCiAgICAgKiBXZWJTb2NrZXRzIGRvbid0IHVzZSByZXF1ZXN0cywgc28gdGhlIHBhc3NlZCBhcmd1bWVudCBpcyBqdXN0IHJldHVybmVkLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKE9iamVjdCkgc3RhbnphIC0gVGhlIHN0YW56YS4KICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgIFRoZSBzdGFuemEgdGhhdCB3YXMgcGFzc2VkLgogICAgICovCiAgICBfcmVxVG9EYXRhOiBmdW5jdGlvbiAoc3RhbnphKQogICAgewogICAgICAgIHJldHVybiBzdGFuemE7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9zZW5kCiAgICAgKiAgX1ByaXZhdGVfIHBhcnQgb2YgdGhlIENvbm5lY3Rpb24uc2VuZCBmdW5jdGlvbiBmb3IgV2ViU29ja2V0CiAgICAgKgogICAgICogSnVzdCBmbHVzaGVzIHRoZSBtZXNzYWdlcyB0aGF0IGFyZSBpbiB0aGUgcXVldWUKICAgICAqLwogICAgX3NlbmQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICB0aGlzLl9jb25uLmZsdXNoKCk7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9zZW5kUmVzdGFydAogICAgICoKICAgICAqICBTZW5kIGFuIHhtcHA6cmVzdGFydCBzdGFuemEuCiAgICAgKi8KICAgIF9zZW5kUmVzdGFydDogZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fY29ubi5faWRsZVRpbWVvdXQpOwogICAgICAgIHRoaXMuX2Nvbm4uX29uSWRsZS5iaW5kKHRoaXMuX2Nvbm4pKCk7CiAgICB9Cn07CgpkZWZpbmUoInN0cm9waGUiLCAoZnVuY3Rpb24gKGdsb2JhbCkgewogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgcmV0LCBmbjsKICAgICAgICByZXR1cm4gcmV0IHx8IGdsb2JhbC5TdHJvcGhlOwogICAgfTsKfSh0aGlzKSkpOwoKLy8gR2VuZXJhdGVkIGJ5IENvZmZlZVNjcmlwdCAxLjguMAoKLyoKICpQbHVnaW4gdG8gaW1wbGVtZW50IHRoZSBNVUMgZXh0ZW5zaW9uLgogICBodHRwOi8veG1wcC5vcmcvZXh0ZW5zaW9ucy94ZXAtMDA0NS5odG1sCiAqUHJldmlvdXMgQXV0aG9yOgogICAgTmF0aGFuIFpvcm4gPG5hdGhhbi56b3JuQGdtYWlsLmNvbT4KICpDb21wbGV0ZSBDb2ZmZWVTY3JpcHQgcmV3cml0ZToKICAgIEFuZHJlYXMgR3V0aCA8Z3V0aEBkYmlzLnJ3dGgtYWFjaGVuLmRlPgogKi8KCihmdW5jdGlvbigpIHsKICB2YXIgT2NjdXBhbnQsIFJvb21Db25maWcsIFhtcHBSb29tLAogICAgX19oYXNQcm9wID0ge30uaGFzT3duUHJvcGVydHksCiAgICBfX2JpbmQgPSBmdW5jdGlvbihmbiwgbWUpeyByZXR1cm4gZnVuY3Rpb24oKXsgcmV0dXJuIGZuLmFwcGx5KG1lLCBhcmd1bWVudHMpOyB9OyB9OwoKICBTdHJvcGhlLmFkZENvbm5lY3Rpb25QbHVnaW4oJ211YycsIHsKICAgIF9jb25uZWN0aW9uOiBudWxsLAogICAgcm9vbXM6IHt9LAogICAgcm9vbU5hbWVzOiBbXSwKCiAgICAvKkZ1bmN0aW9uCiAgICBJbml0aWFsaXplIHRoZSBNVUMgcGx1Z2luLiBTZXRzIHRoZSBjb3JyZWN0IGNvbm5lY3Rpb24gb2JqZWN0IGFuZAogICAgZXh0ZW5kcyB0aGUgbmFtZXNhY2UuCiAgICAgKi8KICAgIGluaXQ6IGZ1bmN0aW9uKGNvbm4pIHsKICAgICAgdGhpcy5fY29ubmVjdGlvbiA9IGNvbm47CiAgICAgIHRoaXMuX211Y19oYW5kbGVyID0gbnVsbDsKICAgICAgU3Ryb3BoZS5hZGROYW1lc3BhY2UoJ01VQ19PV05FUicsIFN0cm9waGUuTlMuTVVDICsgIiNvd25lciIpOwogICAgICBTdHJvcGhlLmFkZE5hbWVzcGFjZSgnTVVDX0FETUlOJywgU3Ryb3BoZS5OUy5NVUMgKyAiI2FkbWluIik7CiAgICAgIFN0cm9waGUuYWRkTmFtZXNwYWNlKCdNVUNfVVNFUicsIFN0cm9waGUuTlMuTVVDICsgIiN1c2VyIik7CiAgICAgIFN0cm9waGUuYWRkTmFtZXNwYWNlKCdNVUNfUk9PTUNPTkYnLCBTdHJvcGhlLk5TLk1VQyArICIjcm9vbWNvbmZpZyIpOwogICAgICByZXR1cm4gU3Ryb3BoZS5hZGROYW1lc3BhY2UoJ01VQ19SRUdJU1RFUicsICJqYWJiZXI6aXE6cmVnaXN0ZXIiKTsKICAgIH0sCgogICAgLypGdW5jdGlvbgogICAgSm9pbiBhIG11bHRpLXVzZXIgY2hhdCByb29tCiAgICBQYXJhbWV0ZXJzOgogICAgKFN0cmluZykgcm9vbSAtIFRoZSBtdWx0aS11c2VyIGNoYXQgcm9vbSB0byBqb2luLgogICAgKFN0cmluZykgbmljayAtIFRoZSBuaWNrbmFtZSB0byB1c2UgaW4gdGhlIGNoYXQgcm9vbS4gT3B0aW9uYWwKICAgIChGdW5jdGlvbikgbXNnX2hhbmRsZXJfY2IgLSBUaGUgZnVuY3Rpb24gY2FsbCB0byBoYW5kbGUgbWVzc2FnZXMgZnJvbSB0aGUKICAgIHNwZWNpZmllZCBjaGF0IHJvb20uCiAgICAoRnVuY3Rpb24pIHByZXNfaGFuZGxlcl9jYiAtIFRoZSBmdW5jdGlvbiBjYWxsIGJhY2sgdG8gaGFuZGxlIHByZXNlbmNlCiAgICBpbiB0aGUgY2hhdCByb29tLgogICAgKEZ1bmN0aW9uKSByb3N0ZXJfY2IgLSBUaGUgZnVuY3Rpb24gY2FsbCB0byBoYW5kbGUgcm9zdGVyIGluZm8gaW4gdGhlIGNoYXQgcm9vbQogICAgKFN0cmluZykgcGFzc3dvcmQgLSBUaGUgb3B0aW9uYWwgcGFzc3dvcmQgdG8gdXNlLiAocGFzc3dvcmQgcHJvdGVjdGVkCiAgICByb29tcyBvbmx5KQogICAgKE9iamVjdCkgaGlzdG9yeV9hdHRycyAtIE9wdGlvbmFsIGF0dHJpYnV0ZXMgZm9yIHJldHJpZXZpbmcgaGlzdG9yeQogICAgKFhNTCBET00gRWxlbWVudCkgZXh0ZW5kZWRfcHJlc2VuY2UgLSBPcHRpb25hbCBYTUwgZm9yIGV4dGVuZGluZyBwcmVzZW5jZQogICAgICovCiAgICBqb2luOiBmdW5jdGlvbihyb29tLCBuaWNrLCBtc2dfaGFuZGxlcl9jYiwgcHJlc19oYW5kbGVyX2NiLCByb3N0ZXJfY2IsIHBhc3N3b3JkLCBoaXN0b3J5X2F0dHJzKSB7CiAgICAgIHZhciBtc2csIHJvb21fbmljazsKICAgICAgcm9vbV9uaWNrID0gdGhpcy50ZXN0X2FwcGVuZF9uaWNrKHJvb20sIG5pY2spOwogICAgICBtc2cgPSAkcHJlcyh7CiAgICAgICAgZnJvbTogdGhpcy5fY29ubmVjdGlvbi5qaWQsCiAgICAgICAgdG86IHJvb21fbmljawogICAgICB9KS5jKCJ4IiwgewogICAgICAgIHhtbG5zOiBTdHJvcGhlLk5TLk1VQwogICAgICB9KTsKICAgICAgaWYgKGhpc3RvcnlfYXR0cnMgIT0gbnVsbCkgewogICAgICAgIG1zZyA9IG1zZy5jKCJoaXN0b3J5IiwgaGlzdG9yeV9hdHRycykudXAoKTsKICAgICAgfQogICAgICBpZiAocGFzc3dvcmQgIT0gbnVsbCkgewogICAgICAgIG1zZy5jbm9kZShTdHJvcGhlLnhtbEVsZW1lbnQoInBhc3N3b3JkIiwgW10sIHBhc3N3b3JkKSk7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBleHRlbmRlZF9wcmVzZW5jZSAhPT0gInVuZGVmaW5lZCIgJiYgZXh0ZW5kZWRfcHJlc2VuY2UgIT09IG51bGwpIHsKICAgICAgICBtc2cudXAuY25vZGUoZXh0ZW5kZWRfcHJlc2VuY2UpOwogICAgICB9CiAgICAgIGlmICh0aGlzLl9tdWNfaGFuZGxlciA9PSBudWxsKSB7CiAgICAgICAgdGhpcy5fbXVjX2hhbmRsZXIgPSB0aGlzLl9jb25uZWN0aW9uLmFkZEhhbmRsZXIoKGZ1bmN0aW9uKF90aGlzKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc3RhbnphKSB7CiAgICAgICAgICAgIHZhciBmcm9tLCBoYW5kbGVyLCBoYW5kbGVycywgaWQsIHJvb21uYW1lLCB4LCB4bWxucywgeHF1ZXJ5LCBfaSwgX2xlbjsKICAgICAgICAgICAgZnJvbSA9IHN0YW56YS5nZXRBdHRyaWJ1dGUoJ2Zyb20nKTsKICAgICAgICAgICAgaWYgKCFmcm9tKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcm9vbW5hbWUgPSBmcm9tLnNwbGl0KCIvIilbMF07CiAgICAgICAgICAgIGlmICghX3RoaXMucm9vbXNbcm9vbW5hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcm9vbSA9IF90aGlzLnJvb21zW3Jvb21uYW1lXTsKICAgICAgICAgICAgaGFuZGxlcnMgPSB7fTsKICAgICAgICAgICAgaWYgKHN0YW56YS5ub2RlTmFtZSA9PT0gIm1lc3NhZ2UiKSB7CiAgICAgICAgICAgICAgaGFuZGxlcnMgPSByb29tLl9tZXNzYWdlX2hhbmRsZXJzOwogICAgICAgICAgICB9IGVsc2UgaWYgKHN0YW56YS5ub2RlTmFtZSA9PT0gInByZXNlbmNlIikgewogICAgICAgICAgICAgIHhxdWVyeSA9IHN0YW56YS5nZXRFbGVtZW50c0J5VGFnTmFtZSgieCIpOwogICAgICAgICAgICAgIGlmICh4cXVlcnkubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSB4cXVlcnkubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICAgICAgICAgICAgeCA9IHhxdWVyeVtfaV07CiAgICAgICAgICAgICAgICAgIHhtbG5zID0geC5nZXRBdHRyaWJ1dGUoInhtbG5zIik7CiAgICAgICAgICAgICAgICAgIGlmICh4bWxucyAmJiB4bWxucy5tYXRjaChTdHJvcGhlLk5TLk1VQykpIHsKICAgICAgICAgICAgICAgICAgICBoYW5kbGVycyA9IHJvb20uX3ByZXNlbmNlX2hhbmRsZXJzOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAoaWQgaW4gaGFuZGxlcnMpIHsKICAgICAgICAgICAgICBoYW5kbGVyID0gaGFuZGxlcnNbaWRdOwogICAgICAgICAgICAgIGlmICghaGFuZGxlcihzdGFuemEsIHJvb20pKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgaGFuZGxlcnNbaWRdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH07CiAgICAgICAgfSkodGhpcykpOwogICAgICB9CiAgICAgIGlmICghdGhpcy5yb29tcy5oYXNPd25Qcm9wZXJ0eShyb29tKSkgewogICAgICAgIHRoaXMucm9vbXNbcm9vbV0gPSBuZXcgWG1wcFJvb20odGhpcywgcm9vbSwgbmljaywgcGFzc3dvcmQpOwogICAgICAgIHRoaXMucm9vbU5hbWVzLnB1c2gocm9vbSk7CiAgICAgIH0KICAgICAgaWYgKHByZXNfaGFuZGxlcl9jYikgewogICAgICAgIHRoaXMucm9vbXNbcm9vbV0uYWRkSGFuZGxlcigncHJlc2VuY2UnLCBwcmVzX2hhbmRsZXJfY2IpOwogICAgICB9CiAgICAgIGlmIChtc2dfaGFuZGxlcl9jYikgewogICAgICAgIHRoaXMucm9vbXNbcm9vbV0uYWRkSGFuZGxlcignbWVzc2FnZScsIG1zZ19oYW5kbGVyX2NiKTsKICAgICAgfQogICAgICBpZiAocm9zdGVyX2NiKSB7CiAgICAgICAgdGhpcy5yb29tc1tyb29tXS5hZGRIYW5kbGVyKCdyb3N0ZXInLCByb3N0ZXJfY2IpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW9uLnNlbmQobXNnKTsKICAgIH0sCgogICAgLypGdW5jdGlvbgogICAgTGVhdmUgYSBtdWx0aS11c2VyIGNoYXQgcm9vbQogICAgUGFyYW1ldGVyczoKICAgIChTdHJpbmcpIHJvb20gLSBUaGUgbXVsdGktdXNlciBjaGF0IHJvb20gdG8gbGVhdmUuCiAgICAoU3RyaW5nKSBuaWNrIC0gVGhlIG5pY2sgbmFtZSB1c2VkIGluIHRoZSByb29tLgogICAgKEZ1bmN0aW9uKSBoYW5kbGVyX2NiIC0gT3B0aW9uYWwgZnVuY3Rpb24gdG8gaGFuZGxlIHRoZSBzdWNjZXNzZnVsIGxlYXZlLgogICAgKFN0cmluZykgZXhpdF9tc2cgLSBvcHRpb25hbCBleGl0IG1lc3NhZ2UuCiAgICBSZXR1cm5zOgogICAgaXFpZCAtIFRoZSB1bmlxdWUgaWQgZm9yIHRoZSByb29tIGxlYXZlLgogICAgICovCiAgICBsZWF2ZTogZnVuY3Rpb24ocm9vbSwgbmljaywgaGFuZGxlcl9jYiwgZXhpdF9tc2cpIHsKICAgICAgdmFyIGlkLCBwcmVzZW5jZSwgcHJlc2VuY2VpZCwgcm9vbV9uaWNrOwogICAgICBpZCA9IHRoaXMucm9vbU5hbWVzLmluZGV4T2Yocm9vbSk7CiAgICAgIGRlbGV0ZSB0aGlzLnJvb21zW3Jvb21dOwogICAgICBpZiAoaWQgPj0gMCkgewogICAgICAgIHRoaXMucm9vbU5hbWVzLnNwbGljZShpZCwgMSk7CiAgICAgICAgaWYgKHRoaXMucm9vbU5hbWVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgdGhpcy5fY29ubmVjdGlvbi5kZWxldGVIYW5kbGVyKHRoaXMuX211Y19oYW5kbGVyKTsKICAgICAgICAgIHRoaXMuX211Y19oYW5kbGVyID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KICAgICAgcm9vbV9uaWNrID0gdGhpcy50ZXN0X2FwcGVuZF9uaWNrKHJvb20sIG5pY2spOwogICAgICBwcmVzZW5jZWlkID0gdGhpcy5fY29ubmVjdGlvbi5nZXRVbmlxdWVJZCgpOwogICAgICBwcmVzZW5jZSA9ICRwcmVzKHsKICAgICAgICB0eXBlOiAidW5hdmFpbGFibGUiLAogICAgICAgIGlkOiBwcmVzZW5jZWlkLAogICAgICAgIGZyb206IHRoaXMuX2Nvbm5lY3Rpb24uamlkLAogICAgICAgIHRvOiByb29tX25pY2sKICAgICAgfSk7CiAgICAgIGlmIChleGl0X21zZyAhPSBudWxsKSB7CiAgICAgICAgcHJlc2VuY2UuYygic3RhdHVzIiwgZXhpdF9tc2cpOwogICAgICB9CiAgICAgIGlmIChoYW5kbGVyX2NiICE9IG51bGwpIHsKICAgICAgICB0aGlzLl9jb25uZWN0aW9uLmFkZEhhbmRsZXIoaGFuZGxlcl9jYiwgbnVsbCwgInByZXNlbmNlIiwgbnVsbCwgcHJlc2VuY2VpZCk7CiAgICAgIH0KICAgICAgdGhpcy5fY29ubmVjdGlvbi5zZW5kKHByZXNlbmNlKTsKICAgICAgcmV0dXJuIHByZXNlbmNlaWQ7CiAgICB9LAoKICAgIC8qRnVuY3Rpb24KICAgIFBhcmFtZXRlcnM6CiAgICAoU3RyaW5nKSByb29tIC0gVGhlIG11bHRpLXVzZXIgY2hhdCByb29tIG5hbWUuCiAgICAoU3RyaW5nKSBuaWNrIC0gVGhlIG5pY2sgbmFtZSB1c2VkIGluIHRoZSBjaGF0IHJvb20uCiAgICAoU3RyaW5nKSBtZXNzYWdlIC0gVGhlIHBsYWludGV4dCBtZXNzYWdlIHRvIHNlbmQgdG8gdGhlIHJvb20uCiAgICAoU3RyaW5nKSBodG1sX21lc3NhZ2UgLSBUaGUgbWVzc2FnZSB0byBzZW5kIHRvIHRoZSByb29tIHdpdGggaHRtbCBtYXJrdXAuCiAgICAoU3RyaW5nKSB0eXBlIC0gImdyb3VwY2hhdCIgZm9yIGdyb3VwIGNoYXQgbWVzc2FnZXMgbwogICAgICAgICAgICAgICAgICAgICJjaGF0IiBmb3IgcHJpdmF0ZSBjaGF0IG1lc3NhZ2VzCiAgICBSZXR1cm5zOgogICAgbXNnaXEgLSB0aGUgdW5pcXVlIGlkIHVzZWQgdG8gc2VuZCB0aGUgbWVzc2FnZQogICAgICovCiAgICBtZXNzYWdlOiBmdW5jdGlvbihyb29tLCBuaWNrLCBtZXNzYWdlLCBodG1sX21lc3NhZ2UsIHR5cGUsIG1zZ2lkKSB7CiAgICAgIHZhciBtc2csIHBhcmVudCwgcm9vbV9uaWNrOwogICAgICByb29tX25pY2sgPSB0aGlzLnRlc3RfYXBwZW5kX25pY2socm9vbSwgbmljayk7CiAgICAgIHR5cGUgPSB0eXBlIHx8IChuaWNrICE9IG51bGwgPyAiY2hhdCIgOiAiZ3JvdXBjaGF0Iik7CiAgICAgIG1zZ2lkID0gbXNnaWQgfHwgdGhpcy5fY29ubmVjdGlvbi5nZXRVbmlxdWVJZCgpOwogICAgICBtc2cgPSAkbXNnKHsKICAgICAgICB0bzogcm9vbV9uaWNrLAogICAgICAgIGZyb206IHRoaXMuX2Nvbm5lY3Rpb24uamlkLAogICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgaWQ6IG1zZ2lkCiAgICAgIH0pLmMoImJvZHkiLCB7CiAgICAgICAgeG1sbnM6IFN0cm9waGUuTlMuQ0xJRU5UCiAgICAgIH0pLnQobWVzc2FnZSk7CiAgICAgIG1zZy51cCgpOwogICAgICBpZiAoaHRtbF9tZXNzYWdlICE9IG51bGwpIHsKICAgICAgICBtc2cuYygiaHRtbCIsIHsKICAgICAgICAgIHhtbG5zOiBTdHJvcGhlLk5TLlhIVE1MX0lNCiAgICAgICAgfSkuYygiYm9keSIsIHsKICAgICAgICAgIHhtbG5zOiBTdHJvcGhlLk5TLlhIVE1MCiAgICAgICAgfSkuaChodG1sX21lc3NhZ2UpOwogICAgICAgIGlmIChtc2cubm9kZS5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcGFyZW50ID0gbXNnLm5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgIG1zZy51cCgpLnVwKCk7CiAgICAgICAgICBtc2cubm9kZS5yZW1vdmVDaGlsZChwYXJlbnQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBtc2cudXAoKS51cCgpOwogICAgICAgIH0KICAgICAgfQogICAgICBtc2cuYygieCIsIHsKICAgICAgICB4bWxuczogImphYmJlcjp4OmV2ZW50IgogICAgICB9KS5jKCJjb21wb3NpbmciKTsKICAgICAgdGhpcy5fY29ubmVjdGlvbi5zZW5kKG1zZyk7CiAgICAgIHJldHVybiBtc2dpZDsKICAgIH0sCgogICAgLypGdW5jdGlvbgogICAgQ29udmVuaWVuY2UgRnVuY3Rpb24gdG8gc2VuZCBhIE1lc3NhZ2UgdG8gYWxsIE9jY3VwYW50cwogICAgUGFyYW1ldGVyczoKICAgIChTdHJpbmcpIHJvb20gLSBUaGUgbXVsdGktdXNlciBjaGF0IHJvb20gbmFtZS4KICAgIChTdHJpbmcpIG1lc3NhZ2UgLSBUaGUgcGxhaW50ZXh0IG1lc3NhZ2UgdG8gc2VuZCB0byB0aGUgcm9vbS4KICAgIChTdHJpbmcpIGh0bWxfbWVzc2FnZSAtIFRoZSBtZXNzYWdlIHRvIHNlbmQgdG8gdGhlIHJvb20gd2l0aCBodG1sIG1hcmt1cC4KICAgIChTdHJpbmcpIG1zZ2lkIC0gT3B0aW9uYWwgdW5pcXVlIElEIHdoaWNoIHdpbGwgYmUgc2V0IGFzIHRoZSAnaWQnIGF0dHJpYnV0ZSBvZiB0aGUgc3RhbnphCiAgICBSZXR1cm5zOgogICAgbXNnaXEgLSB0aGUgdW5pcXVlIGlkIHVzZWQgdG8gc2VuZCB0aGUgbWVzc2FnZQogICAgICovCiAgICBncm91cGNoYXQ6IGZ1bmN0aW9uKHJvb20sIG1lc3NhZ2UsIGh0bWxfbWVzc2FnZSwgbXNnaWQpIHsKICAgICAgcmV0dXJuIHRoaXMubWVzc2FnZShyb29tLCBudWxsLCBtZXNzYWdlLCBodG1sX21lc3NhZ2UsIHZvaWQgMCwgbXNnaWQpOwogICAgfSwKCiAgICAvKkZ1bmN0aW9uCiAgICBTZW5kIGEgbWVkaWF0ZWQgaW52aXRhdGlvbi4KICAgIFBhcmFtZXRlcnM6CiAgICAoU3RyaW5nKSByb29tIC0gVGhlIG11bHRpLXVzZXIgY2hhdCByb29tIG5hbWUuCiAgICAoU3RyaW5nKSByZWNlaXZlciAtIFRoZSBpbnZpdGF0aW9uJ3MgcmVjZWl2ZXIuCiAgICAoU3RyaW5nKSByZWFzb24gLSBPcHRpb25hbCByZWFzb24gZm9yIGpvaW5pbmcgdGhlIHJvb20uCiAgICBSZXR1cm5zOgogICAgbXNnaXEgLSB0aGUgdW5pcXVlIGlkIHVzZWQgdG8gc2VuZCB0aGUgaW52aXRhdGlvbgogICAgICovCiAgICBpbnZpdGU6IGZ1bmN0aW9uKHJvb20sIHJlY2VpdmVyLCByZWFzb24pIHsKICAgICAgdmFyIGludml0YXRpb24sIG1zZ2lkOwogICAgICBtc2dpZCA9IHRoaXMuX2Nvbm5lY3Rpb24uZ2V0VW5pcXVlSWQoKTsKICAgICAgaW52aXRhdGlvbiA9ICRtc2coewogICAgICAgIGZyb206IHRoaXMuX2Nvbm5lY3Rpb24uamlkLAogICAgICAgIHRvOiByb29tLAogICAgICAgIGlkOiBtc2dpZAogICAgICB9KS5jKCd4JywgewogICAgICAgIHhtbG5zOiBTdHJvcGhlLk5TLk1VQ19VU0VSCiAgICAgIH0pLmMoJ2ludml0ZScsIHsKICAgICAgICB0bzogcmVjZWl2ZXIKICAgICAgfSk7CiAgICAgIGlmIChyZWFzb24gIT0gbnVsbCkgewogICAgICAgIGludml0YXRpb24uYygncmVhc29uJywgcmVhc29uKTsKICAgICAgfQogICAgICB0aGlzLl9jb25uZWN0aW9uLnNlbmQoaW52aXRhdGlvbik7CiAgICAgIHJldHVybiBtc2dpZDsKICAgIH0sCgogICAgLypGdW5jdGlvbgogICAgU2VuZCBhIG1lZGlhdGVkIG11bHRpcGxlIGludml0YXRpb24uCiAgICBQYXJhbWV0ZXJzOgogICAgKFN0cmluZykgcm9vbSAtIFRoZSBtdWx0aS11c2VyIGNoYXQgcm9vbSBuYW1lLgogICAgKEFycmF5KSByZWNlaXZlcnMgLSBUaGUgaW52aXRhdGlvbidzIHJlY2VpdmVycy4KICAgIChTdHJpbmcpIHJlYXNvbiAtIE9wdGlvbmFsIHJlYXNvbiBmb3Igam9pbmluZyB0aGUgcm9vbS4KICAgIFJldHVybnM6CiAgICBtc2dpcSAtIHRoZSB1bmlxdWUgaWQgdXNlZCB0byBzZW5kIHRoZSBpbnZpdGF0aW9uCiAgICAgKi8KICAgIG11bHRpcGxlSW52aXRlczogZnVuY3Rpb24ocm9vbSwgcmVjZWl2ZXJzLCByZWFzb24pIHsKICAgICAgdmFyIGludml0YXRpb24sIG1zZ2lkLCByZWNlaXZlciwgX2ksIF9sZW47CiAgICAgIG1zZ2lkID0gdGhpcy5fY29ubmVjdGlvbi5nZXRVbmlxdWVJZCgpOwogICAgICBpbnZpdGF0aW9uID0gJG1zZyh7CiAgICAgICAgZnJvbTogdGhpcy5fY29ubmVjdGlvbi5qaWQsCiAgICAgICAgdG86IHJvb20sCiAgICAgICAgaWQ6IG1zZ2lkCiAgICAgIH0pLmMoJ3gnLCB7CiAgICAgICAgeG1sbnM6IFN0cm9waGUuTlMuTVVDX1VTRVIKICAgICAgfSk7CiAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gcmVjZWl2ZXJzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgICAgcmVjZWl2ZXIgPSByZWNlaXZlcnNbX2ldOwogICAgICAgIGludml0YXRpb24uYygnaW52aXRlJywgewogICAgICAgICAgdG86IHJlY2VpdmVyCiAgICAgICAgfSk7CiAgICAgICAgaWYgKHJlYXNvbiAhPSBudWxsKSB7CiAgICAgICAgICBpbnZpdGF0aW9uLmMoJ3JlYXNvbicsIHJlYXNvbik7CiAgICAgICAgICBpbnZpdGF0aW9uLnVwKCk7CiAgICAgICAgfQogICAgICAgIGludml0YXRpb24udXAoKTsKICAgICAgfQogICAgICB0aGlzLl9jb25uZWN0aW9uLnNlbmQoaW52aXRhdGlvbik7CiAgICAgIHJldHVybiBtc2dpZDsKICAgIH0sCgogICAgLypGdW5jdGlvbgogICAgU2VuZCBhIGRpcmVjdCBpbnZpdGF0aW9uLgogICAgUGFyYW1ldGVyczoKICAgIChTdHJpbmcpIHJvb20gLSBUaGUgbXVsdGktdXNlciBjaGF0IHJvb20gbmFtZS4KICAgIChTdHJpbmcpIHJlY2VpdmVyIC0gVGhlIGludml0YXRpb24ncyByZWNlaXZlci4KICAgIChTdHJpbmcpIHJlYXNvbiAtIE9wdGlvbmFsIHJlYXNvbiBmb3Igam9pbmluZyB0aGUgcm9vbS4KICAgIChTdHJpbmcpIHBhc3N3b3JkIC0gT3B0aW9uYWwgcGFzc3dvcmQgZm9yIHRoZSByb29tLgogICAgUmV0dXJuczoKICAgIG1zZ2lxIC0gdGhlIHVuaXF1ZSBpZCB1c2VkIHRvIHNlbmQgdGhlIGludml0YXRpb24KICAgICAqLwogICAgZGlyZWN0SW52aXRlOiBmdW5jdGlvbihyb29tLCByZWNlaXZlciwgcmVhc29uLCBwYXNzd29yZCkgewogICAgICB2YXIgYXR0cnMsIGludml0YXRpb24sIG1zZ2lkOwogICAgICBtc2dpZCA9IHRoaXMuX2Nvbm5lY3Rpb24uZ2V0VW5pcXVlSWQoKTsKICAgICAgYXR0cnMgPSB7CiAgICAgICAgeG1sbnM6ICdqYWJiZXI6eDpjb25mZXJlbmNlJywKICAgICAgICBqaWQ6IHJvb20KICAgICAgfTsKICAgICAgaWYgKHJlYXNvbiAhPSBudWxsKSB7CiAgICAgICAgYXR0cnMucmVhc29uID0gcmVhc29uOwogICAgICB9CiAgICAgIGlmIChwYXNzd29yZCAhPSBudWxsKSB7CiAgICAgICAgYXR0cnMucGFzc3dvcmQgPSBwYXNzd29yZDsKICAgICAgfQogICAgICBpbnZpdGF0aW9uID0gJG1zZyh7CiAgICAgICAgZnJvbTogdGhpcy5fY29ubmVjdGlvbi5qaWQsCiAgICAgICAgdG86IHJlY2VpdmVyLAogICAgICAgIGlkOiBtc2dpZAogICAgICB9KS5jKCd4JywgYXR0cnMpOwogICAgICB0aGlzLl9jb25uZWN0aW9uLnNlbmQoaW52aXRhdGlvbik7CiAgICAgIHJldHVybiBtc2dpZDsKICAgIH0sCgogICAgLypGdW5jdGlvbgogICAgUXVlcmllcyBhIHJvb20gZm9yIGEgbGlzdCBvZiBvY2N1cGFudHMKICAgIChTdHJpbmcpIHJvb20gLSBUaGUgbXVsdGktdXNlciBjaGF0IHJvb20gbmFtZS4KICAgIChGdW5jdGlvbikgc3VjY2Vzc19jYiAtIE9wdGlvbmFsIGZ1bmN0aW9uIHRvIGhhbmRsZSB0aGUgaW5mby4KICAgIChGdW5jdGlvbikgZXJyb3JfY2IgLSBPcHRpb25hbCBmdW5jdGlvbiB0byBoYW5kbGUgYW4gZXJyb3IuCiAgICBSZXR1cm5zOgogICAgaWQgLSB0aGUgdW5pcXVlIGlkIHVzZWQgdG8gc2VuZCB0aGUgaW5mbyByZXF1ZXN0CiAgICAgKi8KICAgIHF1ZXJ5T2NjdXBhbnRzOiBmdW5jdGlvbihyb29tLCBzdWNjZXNzX2NiLCBlcnJvcl9jYikgewogICAgICB2YXIgYXR0cnMsIGluZm87CiAgICAgIGF0dHJzID0gewogICAgICAgIHhtbG5zOiBTdHJvcGhlLk5TLkRJU0NPX0lURU1TCiAgICAgIH07CiAgICAgIGluZm8gPSAkaXEoewogICAgICAgIGZyb206IHRoaXMuX2Nvbm5lY3Rpb24uamlkLAogICAgICAgIHRvOiByb29tLAogICAgICAgIHR5cGU6ICdnZXQnCiAgICAgIH0pLmMoJ3F1ZXJ5JywgYXR0cnMpOwogICAgICByZXR1cm4gdGhpcy5fY29ubmVjdGlvbi5zZW5kSVEoaW5mbywgc3VjY2Vzc19jYiwgZXJyb3JfY2IpOwogICAgfSwKCiAgICAvKkZ1bmN0aW9uCiAgICBTdGFydCBhIHJvb20gY29uZmlndXJhdGlvbi4KICAgIFBhcmFtZXRlcnM6CiAgICAoU3RyaW5nKSByb29tIC0gVGhlIG11bHRpLXVzZXIgY2hhdCByb29tIG5hbWUuCiAgICAoRnVuY3Rpb24pIGhhbmRsZXJfY2IgLSBPcHRpb25hbCBmdW5jdGlvbiB0byBoYW5kbGUgdGhlIGNvbmZpZyBmb3JtLgogICAgUmV0dXJuczoKICAgIGlkIC0gdGhlIHVuaXF1ZSBpZCB1c2VkIHRvIHNlbmQgdGhlIGNvbmZpZ3VyYXRpb24gcmVxdWVzdAogICAgICovCiAgICBjb25maWd1cmU6IGZ1bmN0aW9uKHJvb20sIGhhbmRsZXJfY2IsIGVycm9yX2NiKSB7CiAgICAgIHZhciBjb25maWcsIHN0YW56YTsKICAgICAgY29uZmlnID0gJGlxKHsKICAgICAgICB0bzogcm9vbSwKICAgICAgICB0eXBlOiAiZ2V0IgogICAgICB9KS5jKCJxdWVyeSIsIHsKICAgICAgICB4bWxuczogU3Ryb3BoZS5OUy5NVUNfT1dORVIKICAgICAgfSk7CiAgICAgIHN0YW56YSA9IGNvbmZpZy50cmVlKCk7CiAgICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW9uLnNlbmRJUShzdGFuemEsIGhhbmRsZXJfY2IsIGVycm9yX2NiKTsKICAgIH0sCgogICAgLypGdW5jdGlvbgogICAgQ2FuY2VsIHRoZSByb29tIGNvbmZpZ3VyYXRpb24KICAgIFBhcmFtZXRlcnM6CiAgICAoU3RyaW5nKSByb29tIC0gVGhlIG11bHRpLXVzZXIgY2hhdCByb29tIG5hbWUuCiAgICBSZXR1cm5zOgogICAgaWQgLSB0aGUgdW5pcXVlIGlkIHVzZWQgdG8gY2FuY2VsIHRoZSBjb25maWd1cmF0aW9uLgogICAgICovCiAgICBjYW5jZWxDb25maWd1cmU6IGZ1bmN0aW9uKHJvb20pIHsKICAgICAgdmFyIGNvbmZpZywgc3RhbnphOwogICAgICBjb25maWcgPSAkaXEoewogICAgICAgIHRvOiByb29tLAogICAgICAgIHR5cGU6ICJzZXQiCiAgICAgIH0pLmMoInF1ZXJ5IiwgewogICAgICAgIHhtbG5zOiBTdHJvcGhlLk5TLk1VQ19PV05FUgogICAgICB9KS5jKCJ4IiwgewogICAgICAgIHhtbG5zOiAiamFiYmVyOng6ZGF0YSIsCiAgICAgICAgdHlwZTogImNhbmNlbCIKICAgICAgfSk7CiAgICAgIHN0YW56YSA9IGNvbmZpZy50cmVlKCk7CiAgICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW9uLnNlbmRJUShzdGFuemEpOwogICAgfSwKCiAgICAvKkZ1bmN0aW9uCiAgICBTYXZlIGEgcm9vbSBjb25maWd1cmF0aW9uLgogICAgUGFyYW1ldGVyczoKICAgIChTdHJpbmcpIHJvb20gLSBUaGUgbXVsdGktdXNlciBjaGF0IHJvb20gbmFtZS4KICAgIChBcnJheSkgY29uZmlnLSBGb3JtIE9iamVjdCBvciBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzIHVzZWQgdG8gY29uZmlndXJlIHRoZSByb29tLgogICAgUmV0dXJuczoKICAgIGlkIC0gdGhlIHVuaXF1ZSBpZCB1c2VkIHRvIHNhdmUgdGhlIGNvbmZpZ3VyYXRpb24uCiAgICAgKi8KICAgIHNhdmVDb25maWd1cmF0aW9uOiBmdW5jdGlvbihyb29tLCBjb25maWcsIHN1Y2Nlc3NfY2IsIGVycm9yX2NiKSB7CiAgICAgIHZhciBjb25mLCBpcSwgc3RhbnphLCBfaSwgX2xlbjsKICAgICAgaXEgPSAkaXEoewogICAgICAgIHRvOiByb29tLAogICAgICAgIHR5cGU6ICJzZXQiCiAgICAgIH0pLmMoInF1ZXJ5IiwgewogICAgICAgIHhtbG5zOiBTdHJvcGhlLk5TLk1VQ19PV05FUgogICAgICB9KTsKICAgICAgaWYgKHR5cGVvZiBGb3JtICE9PSAidW5kZWZpbmVkIiAmJiBjb25maWcgaW5zdGFuY2VvZiBGb3JtKSB7CiAgICAgICAgY29uZmlnLnR5cGUgPSAic3VibWl0IjsKICAgICAgICBpcS5jbm9kZShjb25maWcudG9YTUwoKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaXEuYygieCIsIHsKICAgICAgICAgIHhtbG5zOiAiamFiYmVyOng6ZGF0YSIsCiAgICAgICAgICB0eXBlOiAic3VibWl0IgogICAgICAgIH0pOwogICAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gY29uZmlnLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgICAgICBjb25mID0gY29uZmlnW19pXTsKICAgICAgICAgIGlxLmNub2RlKGNvbmYpLnVwKCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHN0YW56YSA9IGlxLnRyZWUoKTsKICAgICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZElRKHN0YW56YSwgc3VjY2Vzc19jYiwgZXJyb3JfY2IpOwogICAgfSwKCiAgICAvKkZ1bmN0aW9uCiAgICBQYXJhbWV0ZXJzOgogICAgKFN0cmluZykgcm9vbSAtIFRoZSBtdWx0aS11c2VyIGNoYXQgcm9vbSBuYW1lLgogICAgUmV0dXJuczoKICAgIGlkIC0gdGhlIHVuaXF1ZSBpZCB1c2VkIHRvIGNyZWF0ZSB0aGUgY2hhdCByb29tLgogICAgICovCiAgICBjcmVhdGVJbnN0YW50Um9vbTogZnVuY3Rpb24ocm9vbSwgc3VjY2Vzc19jYiwgZXJyb3JfY2IpIHsKICAgICAgdmFyIHJvb21pcTsKICAgICAgcm9vbWlxID0gJGlxKHsKICAgICAgICB0bzogcm9vbSwKICAgICAgICB0eXBlOiAic2V0IgogICAgICB9KS5jKCJxdWVyeSIsIHsKICAgICAgICB4bWxuczogU3Ryb3BoZS5OUy5NVUNfT1dORVIKICAgICAgfSkuYygieCIsIHsKICAgICAgICB4bWxuczogImphYmJlcjp4OmRhdGEiLAogICAgICAgIHR5cGU6ICJzdWJtaXQiCiAgICAgIH0pOwogICAgICByZXR1cm4gdGhpcy5fY29ubmVjdGlvbi5zZW5kSVEocm9vbWlxLnRyZWUoKSwgc3VjY2Vzc19jYiwgZXJyb3JfY2IpOwogICAgfSwKCiAgICAvKkZ1bmN0aW9uCiAgICBQYXJhbWV0ZXJzOgogICAgKFN0cmluZykgcm9vbSAtIFRoZSBtdWx0aS11c2VyIGNoYXQgcm9vbSBuYW1lLgogICAgKE9iamVjdCkgY29uZmlnIC0gdGhlIGNvbmZpZ3VyYXRpb24uIGV4OiB7Im11YyNyb29tY29uZmlnX3B1YmxpY3Jvb20iOiAiMCIsICJtdWMjcm9vbWNvbmZpZ19wZXJzaXN0ZW50cm9vbSI6ICIxIn0KICAgIFJldHVybnM6CiAgICBpZCAtIHRoZSB1bmlxdWUgaWQgdXNlZCB0byBjcmVhdGUgdGhlIGNoYXQgcm9vbS4KICAgICAqLwogICAgY3JlYXRlQ29uZmlndXJlZFJvb206IGZ1bmN0aW9uKHJvb20sIGNvbmZpZywgc3VjY2Vzc19jYiwgZXJyb3JfY2IpIHsKICAgICAgdmFyIGssIHJvb21pcSwgdjsKICAgICAgcm9vbWlxID0gJGlxKHsKICAgICAgICB0bzogcm9vbSwKICAgICAgICB0eXBlOiAic2V0IgogICAgICB9KS5jKCJxdWVyeSIsIHsKICAgICAgICB4bWxuczogU3Ryb3BoZS5OUy5NVUNfT1dORVIKICAgICAgfSkuYygieCIsIHsKICAgICAgICB4bWxuczogImphYmJlcjp4OmRhdGEiLAogICAgICAgIHR5cGU6ICJzdWJtaXQiCiAgICAgIH0pOwogICAgICByb29taXEuYygnZmllbGQnLCB7CiAgICAgICAgJ3Zhcic6ICdGT1JNX1RZUEUnCiAgICAgIH0pLmMoJ3ZhbHVlJykudCgnaHR0cDovL2phYmJlci5vcmcvcHJvdG9jb2wvbXVjI3Jvb21jb25maWcnKS51cCgpLnVwKCk7CiAgICAgIGZvciAoayBpbiBjb25maWcpIHsKICAgICAgICBpZiAoIV9faGFzUHJvcC5jYWxsKGNvbmZpZywgaykpIGNvbnRpbnVlOwogICAgICAgIHYgPSBjb25maWdba107CiAgICAgICAgcm9vbWlxLmMoJ2ZpZWxkJywgewogICAgICAgICAgJ3Zhcic6IGsKICAgICAgICB9KS5jKCd2YWx1ZScpLnQodikudXAoKS51cCgpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW9uLnNlbmRJUShyb29taXEudHJlZSgpLCBzdWNjZXNzX2NiLCBlcnJvcl9jYik7CiAgICB9LAoKICAgIC8qRnVuY3Rpb24KICAgIFNldCB0aGUgdG9waWMgb2YgdGhlIGNoYXQgcm9vbS4KICAgIFBhcmFtZXRlcnM6CiAgICAoU3RyaW5nKSByb29tIC0gVGhlIG11bHRpLXVzZXIgY2hhdCByb29tIG5hbWUuCiAgICAoU3RyaW5nKSB0b3BpYyAtIFRvcGljIG1lc3NhZ2UuCiAgICAgKi8KICAgIHNldFRvcGljOiBmdW5jdGlvbihyb29tLCB0b3BpYykgewogICAgICB2YXIgbXNnOwogICAgICBtc2cgPSAkbXNnKHsKICAgICAgICB0bzogcm9vbSwKICAgICAgICBmcm9tOiB0aGlzLl9jb25uZWN0aW9uLmppZCwKICAgICAgICB0eXBlOiAiZ3JvdXBjaGF0IgogICAgICB9KS5jKCJzdWJqZWN0IiwgewogICAgICAgIHhtbG5zOiAiamFiYmVyOmNsaWVudCIKICAgICAgfSkudCh0b3BpYyk7CiAgICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW9uLnNlbmQobXNnLnRyZWUoKSk7CiAgICB9LAoKICAgIC8qRnVuY3Rpb24KICAgIEludGVybmFsIEZ1bmN0aW9uIHRoYXQgQ2hhbmdlcyB0aGUgcm9sZSBvciBhZmZpbGlhdGlvbiBvZiBhIG1lbWJlcgogICAgb2YgYSBNVUMgcm9vbS4gVGhpcyBmdW5jdGlvbiBpcyB1c2VkIGJ5IG1vZGlmeVJvbGUgYW5kIG1vZGlmeUFmZmlsaWF0aW9uLgogICAgVGhlIG1vZGlmaWNhdGlvbiBjYW4gb25seSBiZSBkb25lIGJ5IGEgcm9vbSBtb2RlcmF0b3IuIEFuIGVycm9yIHdpbGwgYmUKICAgIHJldHVybmVkIGlmIHRoZSB1c2VyIGRvZXNuJ3QgaGF2ZSBwZXJtaXNzaW9uLgogICAgUGFyYW1ldGVyczoKICAgIChTdHJpbmcpIHJvb20gLSBUaGUgbXVsdGktdXNlciBjaGF0IHJvb20gbmFtZS4KICAgIChPYmplY3QpIGl0ZW0gLSBPYmplY3Qgd2l0aCBuaWNrIGFuZCByb2xlIG9yIGppZCBhbmQgYWZmaWxpYXRpb24gYXR0cmlidXRlCiAgICAoU3RyaW5nKSByZWFzb24gLSBPcHRpb25hbCByZWFzb24gZm9yIHRoZSBjaGFuZ2UuCiAgICAoRnVuY3Rpb24pIGhhbmRsZXJfY2IgLSBPcHRpb25hbCBjYWxsYmFjayBmb3Igc3VjY2VzcwogICAgKEZ1bmN0aW9uKSBlcnJvcl9jYiAtIE9wdGlvbmFsIGNhbGxiYWNrIGZvciBlcnJvcgogICAgUmV0dXJuczoKICAgIGlxIC0gdGhlIGlkIG9mIHRoZSBtb2RlIGNoYW5nZSByZXF1ZXN0LgogICAgICovCiAgICBfbW9kaWZ5UHJpdmlsZWdlOiBmdW5jdGlvbihyb29tLCBpdGVtLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKSB7CiAgICAgIHZhciBpcTsKICAgICAgaXEgPSAkaXEoewogICAgICAgIHRvOiByb29tLAogICAgICAgIHR5cGU6ICJzZXQiCiAgICAgIH0pLmMoInF1ZXJ5IiwgewogICAgICAgIHhtbG5zOiBTdHJvcGhlLk5TLk1VQ19BRE1JTgogICAgICB9KS5jbm9kZShpdGVtLm5vZGUpOwogICAgICBpZiAocmVhc29uICE9IG51bGwpIHsKICAgICAgICBpcS5jKCJyZWFzb24iLCByZWFzb24pOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW9uLnNlbmRJUShpcS50cmVlKCksIGhhbmRsZXJfY2IsIGVycm9yX2NiKTsKICAgIH0sCgogICAgLypGdW5jdGlvbgogICAgQ2hhbmdlcyB0aGUgcm9sZSBvZiBhIG1lbWJlciBvZiBhIE1VQyByb29tLgogICAgVGhlIG1vZGlmaWNhdGlvbiBjYW4gb25seSBiZSBkb25lIGJ5IGEgcm9vbSBtb2RlcmF0b3IuIEFuIGVycm9yIHdpbGwgYmUKICAgIHJldHVybmVkIGlmIHRoZSB1c2VyIGRvZXNuJ3QgaGF2ZSBwZXJtaXNzaW9uLgogICAgUGFyYW1ldGVyczoKICAgIChTdHJpbmcpIHJvb20gLSBUaGUgbXVsdGktdXNlciBjaGF0IHJvb20gbmFtZS4KICAgIChTdHJpbmcpIG5pY2sgLSBUaGUgbmljayBuYW1lIG9mIHRoZSB1c2VyIHRvIG1vZGlmeS4KICAgIChTdHJpbmcpIHJvbGUgLSBUaGUgbmV3IHJvbGUgb2YgdGhlIHVzZXIuCiAgICAoU3RyaW5nKSBhZmZpbGlhdGlvbiAtIFRoZSBuZXcgYWZmaWxpYXRpb24gb2YgdGhlIHVzZXIuCiAgICAoU3RyaW5nKSByZWFzb24gLSBPcHRpb25hbCByZWFzb24gZm9yIHRoZSBjaGFuZ2UuCiAgICAoRnVuY3Rpb24pIGhhbmRsZXJfY2IgLSBPcHRpb25hbCBjYWxsYmFjayBmb3Igc3VjY2VzcwogICAgKEZ1bmN0aW9uKSBlcnJvcl9jYiAtIE9wdGlvbmFsIGNhbGxiYWNrIGZvciBlcnJvcgogICAgUmV0dXJuczoKICAgIGlxIC0gdGhlIGlkIG9mIHRoZSBtb2RlIGNoYW5nZSByZXF1ZXN0LgogICAgICovCiAgICBtb2RpZnlSb2xlOiBmdW5jdGlvbihyb29tLCBuaWNrLCByb2xlLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKSB7CiAgICAgIHZhciBpdGVtOwogICAgICBpdGVtID0gJGJ1aWxkKCJpdGVtIiwgewogICAgICAgIG5pY2s6IG5pY2ssCiAgICAgICAgcm9sZTogcm9sZQogICAgICB9KTsKICAgICAgcmV0dXJuIHRoaXMuX21vZGlmeVByaXZpbGVnZShyb29tLCBpdGVtLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKTsKICAgIH0sCiAgICBraWNrOiBmdW5jdGlvbihyb29tLCBuaWNrLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLm1vZGlmeVJvbGUocm9vbSwgbmljaywgJ25vbmUnLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKTsKICAgIH0sCiAgICB2b2ljZTogZnVuY3Rpb24ocm9vbSwgbmljaywgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYikgewogICAgICByZXR1cm4gdGhpcy5tb2RpZnlSb2xlKHJvb20sIG5pY2ssICdwYXJ0aWNpcGFudCcsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfSwKICAgIG11dGU6IGZ1bmN0aW9uKHJvb20sIG5pY2ssIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kaWZ5Um9sZShyb29tLCBuaWNrLCAndmlzaXRvcicsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfSwKICAgIG9wOiBmdW5jdGlvbihyb29tLCBuaWNrLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLm1vZGlmeVJvbGUocm9vbSwgbmljaywgJ21vZGVyYXRvcicsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfSwKICAgIGRlb3A6IGZ1bmN0aW9uKHJvb20sIG5pY2ssIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kaWZ5Um9sZShyb29tLCBuaWNrLCAncGFydGljaXBhbnQnLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKTsKICAgIH0sCgogICAgLypGdW5jdGlvbgogICAgQ2hhbmdlcyB0aGUgYWZmaWxpYXRpb24gb2YgYSBtZW1iZXIgb2YgYSBNVUMgcm9vbS4KICAgIFRoZSBtb2RpZmljYXRpb24gY2FuIG9ubHkgYmUgZG9uZSBieSBhIHJvb20gbW9kZXJhdG9yLiBBbiBlcnJvciB3aWxsIGJlCiAgICByZXR1cm5lZCBpZiB0aGUgdXNlciBkb2Vzbid0IGhhdmUgcGVybWlzc2lvbi4KICAgIFBhcmFtZXRlcnM6CiAgICAoU3RyaW5nKSByb29tIC0gVGhlIG11bHRpLXVzZXIgY2hhdCByb29tIG5hbWUuCiAgICAoU3RyaW5nKSBqaWQgIC0gVGhlIGppZCBvZiB0aGUgdXNlciB0byBtb2RpZnkuCiAgICAoU3RyaW5nKSBhZmZpbGlhdGlvbiAtIFRoZSBuZXcgYWZmaWxpYXRpb24gb2YgdGhlIHVzZXIuCiAgICAoU3RyaW5nKSByZWFzb24gLSBPcHRpb25hbCByZWFzb24gZm9yIHRoZSBjaGFuZ2UuCiAgICAoRnVuY3Rpb24pIGhhbmRsZXJfY2IgLSBPcHRpb25hbCBjYWxsYmFjayBmb3Igc3VjY2VzcwogICAgKEZ1bmN0aW9uKSBlcnJvcl9jYiAtIE9wdGlvbmFsIGNhbGxiYWNrIGZvciBlcnJvcgogICAgUmV0dXJuczoKICAgIGlxIC0gdGhlIGlkIG9mIHRoZSBtb2RlIGNoYW5nZSByZXF1ZXN0LgogICAgICovCiAgICBtb2RpZnlBZmZpbGlhdGlvbjogZnVuY3Rpb24ocm9vbSwgamlkLCBhZmZpbGlhdGlvbiwgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYikgewogICAgICB2YXIgaXRlbTsKICAgICAgaXRlbSA9ICRidWlsZCgiaXRlbSIsIHsKICAgICAgICBqaWQ6IGppZCwKICAgICAgICBhZmZpbGlhdGlvbjogYWZmaWxpYXRpb24KICAgICAgfSk7CiAgICAgIHJldHVybiB0aGlzLl9tb2RpZnlQcml2aWxlZ2Uocm9vbSwgaXRlbSwgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgICB9LAogICAgYmFuOiBmdW5jdGlvbihyb29tLCBqaWQsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kaWZ5QWZmaWxpYXRpb24ocm9vbSwgamlkLCAnb3V0Y2FzdCcsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfSwKICAgIG1lbWJlcjogZnVuY3Rpb24ocm9vbSwgamlkLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLm1vZGlmeUFmZmlsaWF0aW9uKHJvb20sIGppZCwgJ21lbWJlcicsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfSwKICAgIHJldm9rZTogZnVuY3Rpb24ocm9vbSwgamlkLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLm1vZGlmeUFmZmlsaWF0aW9uKHJvb20sIGppZCwgJ25vbmUnLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKTsKICAgIH0sCiAgICBvd25lcjogZnVuY3Rpb24ocm9vbSwgamlkLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLm1vZGlmeUFmZmlsaWF0aW9uKHJvb20sIGppZCwgJ293bmVyJywgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgICB9LAogICAgYWRtaW46IGZ1bmN0aW9uKHJvb20sIGppZCwgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYikgewogICAgICByZXR1cm4gdGhpcy5tb2RpZnlBZmZpbGlhdGlvbihyb29tLCBqaWQsICdhZG1pbicsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfSwKCiAgICAvKkZ1bmN0aW9uCiAgICBDaGFuZ2UgdGhlIGN1cnJlbnQgdXNlcnMgbmljayBuYW1lLgogICAgUGFyYW1ldGVyczoKICAgIChTdHJpbmcpIHJvb20gLSBUaGUgbXVsdGktdXNlciBjaGF0IHJvb20gbmFtZS4KICAgIChTdHJpbmcpIHVzZXIgLSBUaGUgbmV3IG5pY2sgbmFtZS4KICAgICAqLwogICAgY2hhbmdlTmljazogZnVuY3Rpb24ocm9vbSwgdXNlcikgewogICAgICB2YXIgcHJlc2VuY2UsIHJvb21fbmljazsKICAgICAgcm9vbV9uaWNrID0gdGhpcy50ZXN0X2FwcGVuZF9uaWNrKHJvb20sIHVzZXIpOwogICAgICBwcmVzZW5jZSA9ICRwcmVzKHsKICAgICAgICBmcm9tOiB0aGlzLl9jb25uZWN0aW9uLmppZCwKICAgICAgICB0bzogcm9vbV9uaWNrLAogICAgICAgIGlkOiB0aGlzLl9jb25uZWN0aW9uLmdldFVuaXF1ZUlkKCkKICAgICAgfSk7CiAgICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW9uLnNlbmQocHJlc2VuY2UudHJlZSgpKTsKICAgIH0sCgogICAgLypGdW5jdGlvbgogICAgQ2hhbmdlIHRoZSBjdXJyZW50IHVzZXJzIHN0YXR1cy4KICAgIFBhcmFtZXRlcnM6CiAgICAoU3RyaW5nKSByb29tIC0gVGhlIG11bHRpLXVzZXIgY2hhdCByb29tIG5hbWUuCiAgICAoU3RyaW5nKSB1c2VyIC0gVGhlIGN1cnJlbnQgbmljay4KICAgIChTdHJpbmcpIHNob3cgLSBUaGUgbmV3IHNob3ctdGV4dC4KICAgIChTdHJpbmcpIHN0YXR1cyAtIFRoZSBuZXcgc3RhdHVzLXRleHQuCiAgICAgKi8KICAgIHNldFN0YXR1czogZnVuY3Rpb24ocm9vbSwgdXNlciwgc2hvdywgc3RhdHVzKSB7CiAgICAgIHZhciBwcmVzZW5jZSwgcm9vbV9uaWNrOwogICAgICByb29tX25pY2sgPSB0aGlzLnRlc3RfYXBwZW5kX25pY2socm9vbSwgdXNlcik7CiAgICAgIHByZXNlbmNlID0gJHByZXMoewogICAgICAgIGZyb206IHRoaXMuX2Nvbm5lY3Rpb24uamlkLAogICAgICAgIHRvOiByb29tX25pY2sKICAgICAgfSk7CiAgICAgIGlmIChzaG93ICE9IG51bGwpIHsKICAgICAgICBwcmVzZW5jZS5jKCdzaG93Jywgc2hvdykudXAoKTsKICAgICAgfQogICAgICBpZiAoc3RhdHVzICE9IG51bGwpIHsKICAgICAgICBwcmVzZW5jZS5jKCdzdGF0dXMnLCBzdGF0dXMpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW9uLnNlbmQocHJlc2VuY2UudHJlZSgpKTsKICAgIH0sCgogICAgLypGdW5jdGlvbgogICAgUmVnaXN0ZXJpbmcgd2l0aCBhIHJvb20uCiAgICBAc2VlIGh0dHA6Ly94bXBwLm9yZy9leHRlbnNpb25zL3hlcC0wMDQ1Lmh0bWwjcmVnaXN0ZXIKICAgIFBhcmFtZXRlcnM6CiAgICAoU3RyaW5nKSByb29tIC0gVGhlIG11bHRpLXVzZXIgY2hhdCByb29tIG5hbWUuCiAgICAoRnVuY3Rpb24pIGhhbmRsZV9jYiAtIEZ1bmN0aW9uIHRvIGNhbGwgZm9yIHJvb20gbGlzdCByZXR1cm4uCiAgICAoRnVuY3Rpb24pIGVycm9yX2NiIC0gRnVuY3Rpb24gdG8gY2FsbCBvbiBlcnJvci4KICAgICAqLwogICAgcmVnaXN0cmF0aW9uUmVxdWVzdDogZnVuY3Rpb24ocm9vbSwgaGFuZGxlX2NiLCBlcnJvcl9jYikgewogICAgICB2YXIgaXE7CiAgICAgIGlxID0gJGlxKHsKICAgICAgICB0bzogcm9vbSwKICAgICAgICBmcm9tOiB0aGlzLl9jb25uZWN0aW9uLmppZCwKICAgICAgICB0eXBlOiAiZ2V0IgogICAgICB9KS5jKCJxdWVyeSIsIHsKICAgICAgICB4bWxuczogU3Ryb3BoZS5OUy5NVUNfUkVHSVNURVIKICAgICAgfSk7CiAgICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW9uLnNlbmRJUShpcSwgZnVuY3Rpb24oc3RhbnphKSB7CiAgICAgICAgdmFyICRmaWVsZCwgJGZpZWxkcywgZmllbGQsIGZpZWxkcywgbGVuZ3RoLCBfaSwgX2xlbjsKICAgICAgICAkZmllbGRzID0gc3RhbnphLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdmaWVsZCcpOwogICAgICAgIGxlbmd0aCA9ICRmaWVsZHMubGVuZ3RoOwogICAgICAgIGZpZWxkcyA9IHsKICAgICAgICAgIHJlcXVpcmVkOiBbXSwKICAgICAgICAgIG9wdGlvbmFsOiBbXQogICAgICAgIH07CiAgICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSAkZmllbGRzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgICAgICAkZmllbGQgPSAkZmllbGRzW19pXTsKICAgICAgICAgIGZpZWxkID0gewogICAgICAgICAgICAidmFyIjogJGZpZWxkLmdldEF0dHJpYnV0ZSgndmFyJyksCiAgICAgICAgICAgIGxhYmVsOiAkZmllbGQuZ2V0QXR0cmlidXRlKCdsYWJlbCcpLAogICAgICAgICAgICB0eXBlOiAkZmllbGQuZ2V0QXR0cmlidXRlKCd0eXBlJykKICAgICAgICAgIH07CiAgICAgICAgICBpZiAoJGZpZWxkLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdyZXF1aXJlZCcpLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgZmllbGRzLnJlcXVpcmVkLnB1c2goZmllbGQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmllbGRzLm9wdGlvbmFsLnB1c2goZmllbGQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gaGFuZGxlX2NiKGZpZWxkcyk7CiAgICAgIH0sIGVycm9yX2NiKTsKICAgIH0sCgogICAgLypGdW5jdGlvbgogICAgU3VibWl0cyByZWdpc3RyYXRpb24gZm9ybS4KICAgIFBhcmFtZXRlcnM6CiAgICAoU3RyaW5nKSByb29tIC0gVGhlIG11bHRpLXVzZXIgY2hhdCByb29tIG5hbWUuCiAgICAoRnVuY3Rpb24pIGhhbmRsZV9jYiAtIEZ1bmN0aW9uIHRvIGNhbGwgZm9yIHJvb20gbGlzdCByZXR1cm4uCiAgICAoRnVuY3Rpb24pIGVycm9yX2NiIC0gRnVuY3Rpb24gdG8gY2FsbCBvbiBlcnJvci4KICAgICAqLwogICAgc3VibWl0UmVnaXN0cmF0aW9uRm9ybTogZnVuY3Rpb24ocm9vbSwgZmllbGRzLCBoYW5kbGVfY2IsIGVycm9yX2NiKSB7CiAgICAgIHZhciBpcSwga2V5LCB2YWw7CiAgICAgIGlxID0gJGlxKHsKICAgICAgICB0bzogcm9vbSwKICAgICAgICB0eXBlOiAic2V0IgogICAgICB9KS5jKCJxdWVyeSIsIHsKICAgICAgICB4bWxuczogU3Ryb3BoZS5OUy5NVUNfUkVHSVNURVIKICAgICAgfSk7CiAgICAgIGlxLmMoIngiLCB7CiAgICAgICAgeG1sbnM6ICJqYWJiZXI6eDpkYXRhIiwKICAgICAgICB0eXBlOiAic3VibWl0IgogICAgICB9KTsKICAgICAgaXEuYygnZmllbGQnLCB7CiAgICAgICAgJ3Zhcic6ICdGT1JNX1RZUEUnCiAgICAgIH0pLmMoJ3ZhbHVlJykudCgnaHR0cDovL2phYmJlci5vcmcvcHJvdG9jb2wvbXVjI3JlZ2lzdGVyJykudXAoKS51cCgpOwogICAgICBmb3IgKGtleSBpbiBmaWVsZHMpIHsKICAgICAgICB2YWwgPSBmaWVsZHNba2V5XTsKICAgICAgICBpcS5jKCdmaWVsZCcsIHsKICAgICAgICAgICd2YXInOiBrZXkKICAgICAgICB9KS5jKCd2YWx1ZScpLnQodmFsKS51cCgpLnVwKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZElRKGlxLCBoYW5kbGVfY2IsIGVycm9yX2NiKTsKICAgIH0sCgogICAgLypGdW5jdGlvbgogICAgTGlzdCBhbGwgY2hhdCByb29tIGF2YWlsYWJsZSBvbiBhIHNlcnZlci4KICAgIFBhcmFtZXRlcnM6CiAgICAoU3RyaW5nKSBzZXJ2ZXIgLSBuYW1lIG9mIGNoYXQgc2VydmVyLgogICAgKFN0cmluZykgaGFuZGxlX2NiIC0gRnVuY3Rpb24gdG8gY2FsbCBmb3Igcm9vbSBsaXN0IHJldHVybi4KICAgIChTdHJpbmcpIGVycm9yX2NiIC0gRnVuY3Rpb24gdG8gY2FsbCBvbiBlcnJvci4KICAgICAqLwogICAgbGlzdFJvb21zOiBmdW5jdGlvbihzZXJ2ZXIsIGhhbmRsZV9jYiwgZXJyb3JfY2IpIHsKICAgICAgdmFyIGlxOwogICAgICBpcSA9ICRpcSh7CiAgICAgICAgdG86IHNlcnZlciwKICAgICAgICBmcm9tOiB0aGlzLl9jb25uZWN0aW9uLmppZCwKICAgICAgICB0eXBlOiAiZ2V0IgogICAgICB9KS5jKCJxdWVyeSIsIHsKICAgICAgICB4bWxuczogU3Ryb3BoZS5OUy5ESVNDT19JVEVNUwogICAgICB9KTsKICAgICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZElRKGlxLCBoYW5kbGVfY2IsIGVycm9yX2NiKTsKICAgIH0sCiAgICB0ZXN0X2FwcGVuZF9uaWNrOiBmdW5jdGlvbihyb29tLCBuaWNrKSB7CiAgICAgIHZhciBkb21haW4sIG5vZGU7CiAgICAgIG5vZGUgPSBTdHJvcGhlLmVzY2FwZU5vZGUoU3Ryb3BoZS5nZXROb2RlRnJvbUppZChyb29tKSk7CiAgICAgIGRvbWFpbiA9IFN0cm9waGUuZ2V0RG9tYWluRnJvbUppZChyb29tKTsKICAgICAgcmV0dXJuIG5vZGUgKyAiQCIgKyBkb21haW4gKyAobmljayAhPSBudWxsID8gIi8iICsgbmljayA6ICIiKTsKICAgIH0KICB9KTsKCiAgWG1wcFJvb20gPSAoZnVuY3Rpb24oKSB7CiAgICBmdW5jdGlvbiBYbXBwUm9vbShjbGllbnQsIG5hbWUsIG5pY2ssIHBhc3N3b3JkKSB7CiAgICAgIHRoaXMuY2xpZW50ID0gY2xpZW50OwogICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICB0aGlzLm5pY2sgPSBuaWNrOwogICAgICB0aGlzLnBhc3N3b3JkID0gcGFzc3dvcmQ7CiAgICAgIHRoaXMuX3Jvb21Sb3N0ZXJIYW5kbGVyID0gX19iaW5kKHRoaXMuX3Jvb21Sb3N0ZXJIYW5kbGVyLCB0aGlzKTsKICAgICAgdGhpcy5fYWRkT2NjdXBhbnQgPSBfX2JpbmQodGhpcy5fYWRkT2NjdXBhbnQsIHRoaXMpOwogICAgICB0aGlzLnJvc3RlciA9IHt9OwogICAgICB0aGlzLl9tZXNzYWdlX2hhbmRsZXJzID0ge307CiAgICAgIHRoaXMuX3ByZXNlbmNlX2hhbmRsZXJzID0ge307CiAgICAgIHRoaXMuX3Jvc3Rlcl9oYW5kbGVycyA9IHt9OwogICAgICB0aGlzLl9oYW5kbGVyX2lkcyA9IDA7CiAgICAgIGlmIChjbGllbnQubXVjKSB7CiAgICAgICAgdGhpcy5jbGllbnQgPSBjbGllbnQubXVjOwogICAgICB9CiAgICAgIHRoaXMubmFtZSA9IFN0cm9waGUuZ2V0QmFyZUppZEZyb21KaWQobmFtZSk7CiAgICAgIHRoaXMuYWRkSGFuZGxlcigncHJlc2VuY2UnLCB0aGlzLl9yb29tUm9zdGVySGFuZGxlcik7CiAgICB9CgogICAgWG1wcFJvb20ucHJvdG90eXBlLmpvaW4gPSBmdW5jdGlvbihtc2dfaGFuZGxlcl9jYiwgcHJlc19oYW5kbGVyX2NiLCByb3N0ZXJfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMuY2xpZW50LmpvaW4odGhpcy5uYW1lLCB0aGlzLm5pY2ssIG1zZ19oYW5kbGVyX2NiLCBwcmVzX2hhbmRsZXJfY2IsIHJvc3Rlcl9jYiwgdGhpcy5wYXNzd29yZCk7CiAgICB9OwoKICAgIFhtcHBSb29tLnByb3RvdHlwZS5sZWF2ZSA9IGZ1bmN0aW9uKGhhbmRsZXJfY2IsIG1lc3NhZ2UpIHsKICAgICAgdGhpcy5jbGllbnQubGVhdmUodGhpcy5uYW1lLCB0aGlzLm5pY2ssIGhhbmRsZXJfY2IsIG1lc3NhZ2UpOwogICAgICByZXR1cm4gZGVsZXRlIHRoaXMuY2xpZW50LnJvb21zW3RoaXMubmFtZV07CiAgICB9OwoKICAgIFhtcHBSb29tLnByb3RvdHlwZS5tZXNzYWdlID0gZnVuY3Rpb24obmljaywgbWVzc2FnZSwgaHRtbF9tZXNzYWdlLCB0eXBlKSB7CiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5tZXNzYWdlKHRoaXMubmFtZSwgbmljaywgbWVzc2FnZSwgaHRtbF9tZXNzYWdlLCB0eXBlKTsKICAgIH07CgogICAgWG1wcFJvb20ucHJvdG90eXBlLmdyb3VwY2hhdCA9IGZ1bmN0aW9uKG1lc3NhZ2UsIGh0bWxfbWVzc2FnZSkgewogICAgICByZXR1cm4gdGhpcy5jbGllbnQuZ3JvdXBjaGF0KHRoaXMubmFtZSwgbWVzc2FnZSwgaHRtbF9tZXNzYWdlKTsKICAgIH07CgogICAgWG1wcFJvb20ucHJvdG90eXBlLmludml0ZSA9IGZ1bmN0aW9uKHJlY2VpdmVyLCByZWFzb24pIHsKICAgICAgcmV0dXJuIHRoaXMuY2xpZW50Lmludml0ZSh0aGlzLm5hbWUsIHJlY2VpdmVyLCByZWFzb24pOwogICAgfTsKCiAgICBYbXBwUm9vbS5wcm90b3R5cGUubXVsdGlwbGVJbnZpdGVzID0gZnVuY3Rpb24ocmVjZWl2ZXJzLCByZWFzb24pIHsKICAgICAgcmV0dXJuIHRoaXMuY2xpZW50Lmludml0ZSh0aGlzLm5hbWUsIHJlY2VpdmVycywgcmVhc29uKTsKICAgIH07CgogICAgWG1wcFJvb20ucHJvdG90eXBlLmRpcmVjdEludml0ZSA9IGZ1bmN0aW9uKHJlY2VpdmVyLCByZWFzb24pIHsKICAgICAgcmV0dXJuIHRoaXMuY2xpZW50LmRpcmVjdEludml0ZSh0aGlzLm5hbWUsIHJlY2VpdmVyLCByZWFzb24sIHRoaXMucGFzc3dvcmQpOwogICAgfTsKCiAgICBYbXBwUm9vbS5wcm90b3R5cGUuY29uZmlndXJlID0gZnVuY3Rpb24oaGFuZGxlcl9jYikgewogICAgICByZXR1cm4gdGhpcy5jbGllbnQuY29uZmlndXJlKHRoaXMubmFtZSwgaGFuZGxlcl9jYik7CiAgICB9OwoKICAgIFhtcHBSb29tLnByb3RvdHlwZS5jYW5jZWxDb25maWd1cmUgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuY2xpZW50LmNhbmNlbENvbmZpZ3VyZSh0aGlzLm5hbWUpOwogICAgfTsKCiAgICBYbXBwUm9vbS5wcm90b3R5cGUuc2F2ZUNvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbihjb25maWcpIHsKICAgICAgcmV0dXJuIHRoaXMuY2xpZW50LnNhdmVDb25maWd1cmF0aW9uKHRoaXMubmFtZSwgY29uZmlnKTsKICAgIH07CgogICAgWG1wcFJvb20ucHJvdG90eXBlLnF1ZXJ5T2NjdXBhbnRzID0gZnVuY3Rpb24oc3VjY2Vzc19jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMuY2xpZW50LnF1ZXJ5T2NjdXBhbnRzKHRoaXMubmFtZSwgc3VjY2Vzc19jYiwgZXJyb3JfY2IpOwogICAgfTsKCiAgICBYbXBwUm9vbS5wcm90b3R5cGUuc2V0VG9waWMgPSBmdW5jdGlvbih0b3BpYykgewogICAgICByZXR1cm4gdGhpcy5jbGllbnQuc2V0VG9waWModGhpcy5uYW1lLCB0b3BpYyk7CiAgICB9OwoKICAgIFhtcHBSb29tLnByb3RvdHlwZS5tb2RpZnlSb2xlID0gZnVuY3Rpb24obmljaywgcm9sZSwgcmVhc29uLCBzdWNjZXNzX2NiLCBlcnJvcl9jYikgewogICAgICByZXR1cm4gdGhpcy5jbGllbnQubW9kaWZ5Um9sZSh0aGlzLm5hbWUsIG5pY2ssIHJvbGUsIHJlYXNvbiwgc3VjY2Vzc19jYiwgZXJyb3JfY2IpOwogICAgfTsKCiAgICBYbXBwUm9vbS5wcm90b3R5cGUua2ljayA9IGZ1bmN0aW9uKG5pY2ssIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMuY2xpZW50LmtpY2sodGhpcy5uYW1lLCBuaWNrLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKTsKICAgIH07CgogICAgWG1wcFJvb20ucHJvdG90eXBlLnZvaWNlID0gZnVuY3Rpb24obmljaywgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYikgewogICAgICByZXR1cm4gdGhpcy5jbGllbnQudm9pY2UodGhpcy5uYW1lLCBuaWNrLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKTsKICAgIH07CgogICAgWG1wcFJvb20ucHJvdG90eXBlLm11dGUgPSBmdW5jdGlvbihuaWNrLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5tdXRlKHRoaXMubmFtZSwgbmljaywgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgICB9OwoKICAgIFhtcHBSb29tLnByb3RvdHlwZS5vcCA9IGZ1bmN0aW9uKG5pY2ssIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMuY2xpZW50Lm9wKHRoaXMubmFtZSwgbmljaywgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgICB9OwoKICAgIFhtcHBSb29tLnByb3RvdHlwZS5kZW9wID0gZnVuY3Rpb24obmljaywgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYikgewogICAgICByZXR1cm4gdGhpcy5jbGllbnQuZGVvcCh0aGlzLm5hbWUsIG5pY2ssIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfTsKCiAgICBYbXBwUm9vbS5wcm90b3R5cGUubW9kaWZ5QWZmaWxpYXRpb24gPSBmdW5jdGlvbihqaWQsIGFmZmlsaWF0aW9uLCByZWFzb24sIHN1Y2Nlc3NfY2IsIGVycm9yX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5tb2RpZnlBZmZpbGlhdGlvbih0aGlzLm5hbWUsIGppZCwgYWZmaWxpYXRpb24sIHJlYXNvbiwgc3VjY2Vzc19jYiwgZXJyb3JfY2IpOwogICAgfTsKCiAgICBYbXBwUm9vbS5wcm90b3R5cGUuYmFuID0gZnVuY3Rpb24oamlkLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5iYW4odGhpcy5uYW1lLCBqaWQsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfTsKCiAgICBYbXBwUm9vbS5wcm90b3R5cGUubWVtYmVyID0gZnVuY3Rpb24oamlkLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5tZW1iZXIodGhpcy5uYW1lLCBqaWQsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfTsKCiAgICBYbXBwUm9vbS5wcm90b3R5cGUucmV2b2tlID0gZnVuY3Rpb24oamlkLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5yZXZva2UodGhpcy5uYW1lLCBqaWQsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfTsKCiAgICBYbXBwUm9vbS5wcm90b3R5cGUub3duZXIgPSBmdW5jdGlvbihqaWQsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMuY2xpZW50Lm93bmVyKHRoaXMubmFtZSwgamlkLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKTsKICAgIH07CgogICAgWG1wcFJvb20ucHJvdG90eXBlLmFkbWluID0gZnVuY3Rpb24oamlkLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5hZG1pbih0aGlzLm5hbWUsIGppZCwgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgICB9OwoKICAgIFhtcHBSb29tLnByb3RvdHlwZS5jaGFuZ2VOaWNrID0gZnVuY3Rpb24obmljaykgewogICAgICB0aGlzLm5pY2sgPSBuaWNrOwogICAgICByZXR1cm4gdGhpcy5jbGllbnQuY2hhbmdlTmljayh0aGlzLm5hbWUsIG5pY2spOwogICAgfTsKCiAgICBYbXBwUm9vbS5wcm90b3R5cGUuc2V0U3RhdHVzID0gZnVuY3Rpb24oc2hvdywgc3RhdHVzKSB7CiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5zZXRTdGF0dXModGhpcy5uYW1lLCB0aGlzLm5pY2ssIHNob3csIHN0YXR1cyk7CiAgICB9OwoKCiAgICAvKkZ1bmN0aW9uCiAgICBBZGRzIGEgaGFuZGxlciB0byB0aGUgTVVDIHJvb20uCiAgICAgIFBhcmFtZXRlcnM6CiAgICAoU3RyaW5nKSBoYW5kbGVyX3R5cGUgLSAnbWVzc2FnZScsICdwcmVzZW5jZScgb3IgJ3Jvc3RlcicuCiAgICAoRnVuY3Rpb24pIGhhbmRsZXIgLSBUaGUgaGFuZGxlciBmdW5jdGlvbi4KICAgIFJldHVybnM6CiAgICBpZCAtIHRoZSBpZCBvZiBoYW5kbGVyLgogICAgICovCgogICAgWG1wcFJvb20ucHJvdG90eXBlLmFkZEhhbmRsZXIgPSBmdW5jdGlvbihoYW5kbGVyX3R5cGUsIGhhbmRsZXIpIHsKICAgICAgdmFyIGlkOwogICAgICBpZCA9IHRoaXMuX2hhbmRsZXJfaWRzKys7CiAgICAgIHN3aXRjaCAoaGFuZGxlcl90eXBlKSB7CiAgICAgICAgY2FzZSAncHJlc2VuY2UnOgogICAgICAgICAgdGhpcy5fcHJlc2VuY2VfaGFuZGxlcnNbaWRdID0gaGFuZGxlcjsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ21lc3NhZ2UnOgogICAgICAgICAgdGhpcy5fbWVzc2FnZV9oYW5kbGVyc1tpZF0gPSBoYW5kbGVyOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAncm9zdGVyJzoKICAgICAgICAgIHRoaXMuX3Jvc3Rlcl9oYW5kbGVyc1tpZF0gPSBoYW5kbGVyOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHRoaXMuX2hhbmRsZXJfaWRzLS07CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICByZXR1cm4gaWQ7CiAgICB9OwoKCiAgICAvKkZ1bmN0aW9uCiAgICBSZW1vdmVzIGEgaGFuZGxlciBmcm9tIHRoZSBNVUMgcm9vbS4KICAgIFRoaXMgZnVuY3Rpb24gdGFrZXMgT05MWSBpZHMgcmV0dXJuZWQgYnkgdGhlIGFkZEhhbmRsZXIgZnVuY3Rpb24KICAgIG9mIHRoaXMgcm9vbS4gcGFzc2luZyBoYW5kbGVyIGlkcyByZXR1cm5lZCBieSBjb25uZWN0aW9uLmFkZEhhbmRsZXIKICAgIG1heSBicmFrZSB0aGluZ3MhCiAgICAgIFBhcmFtZXRlcnM6CiAgICAobnVtYmVyKSBpZCAtIHRoZSBpZCBvZiB0aGUgaGFuZGxlcgogICAgICovCgogICAgWG1wcFJvb20ucHJvdG90eXBlLnJlbW92ZUhhbmRsZXIgPSBmdW5jdGlvbihpZCkgewogICAgICBkZWxldGUgdGhpcy5fcHJlc2VuY2VfaGFuZGxlcnNbaWRdOwogICAgICBkZWxldGUgdGhpcy5fbWVzc2FnZV9oYW5kbGVyc1tpZF07CiAgICAgIHJldHVybiBkZWxldGUgdGhpcy5fcm9zdGVyX2hhbmRsZXJzW2lkXTsKICAgIH07CgoKICAgIC8qRnVuY3Rpb24KICAgIENyZWF0ZXMgYW5kIGFkZHMgYW4gT2NjdXBhbnQgdG8gdGhlIFJvb20gUm9zdGVyLgogICAgICBQYXJhbWV0ZXJzOgogICAgKE9iamVjdCkgZGF0YSAtIHRoZSBkYXRhIHRoZSBPY2N1cGFudCBpcyBmaWxsZWQgd2l0aAogICAgUmV0dXJuczoKICAgIG9jYyAtIHRoZSBjcmVhdGVkIE9jY3VwYW50LgogICAgICovCgogICAgWG1wcFJvb20ucHJvdG90eXBlLl9hZGRPY2N1cGFudCA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgdmFyIG9jYzsKICAgICAgb2NjID0gbmV3IE9jY3VwYW50KGRhdGEsIHRoaXMpOwogICAgICB0aGlzLnJvc3RlcltvY2Mubmlja10gPSBvY2M7CiAgICAgIHJldHVybiBvY2M7CiAgICB9OwoKCiAgICAvKkZ1bmN0aW9uCiAgICBUaGUgc3RhbmRhcmQgaGFuZGxlciB0aGF0IG1hbmFnZWQgdGhlIFJvb20gUm9zdGVyLgogICAgICBQYXJhbWV0ZXJzOgogICAgKE9iamVjdCkgcHJlcyAtIHRoZSBwcmVzZW5jZSBzdGFuemEgY29udGFpbmluZyB1c2VyIGluZm9ybWF0aW9uCiAgICAgKi8KCiAgICBYbXBwUm9vbS5wcm90b3R5cGUuX3Jvb21Sb3N0ZXJIYW5kbGVyID0gZnVuY3Rpb24ocHJlcykgewogICAgICB2YXIgZGF0YSwgaGFuZGxlciwgaWQsIG5ld25pY2ssIG5pY2ssIF9yZWY7CiAgICAgIGRhdGEgPSBYbXBwUm9vbS5fcGFyc2VQcmVzZW5jZShwcmVzKTsKICAgICAgbmljayA9IGRhdGEubmljazsKICAgICAgbmV3bmljayA9IGRhdGEubmV3bmljayB8fCBudWxsOwogICAgICBzd2l0Y2ggKGRhdGEudHlwZSkgewogICAgICAgIGNhc2UgJ2Vycm9yJzoKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIGNhc2UgJ3VuYXZhaWxhYmxlJzoKICAgICAgICAgIGlmIChuZXduaWNrKSB7CiAgICAgICAgICAgIGRhdGEubmljayA9IG5ld25pY2s7CiAgICAgICAgICAgIGlmICh0aGlzLnJvc3RlcltuaWNrXSAmJiB0aGlzLnJvc3RlcltuZXduaWNrXSkgewogICAgICAgICAgICAgIHRoaXMucm9zdGVyW25pY2tdLnVwZGF0ZSh0aGlzLnJvc3RlcltuZXduaWNrXSk7CiAgICAgICAgICAgICAgdGhpcy5yb3N0ZXJbbmV3bmlja10gPSB0aGlzLnJvc3RlcltuaWNrXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5yb3N0ZXJbbmlja10gJiYgIXRoaXMucm9zdGVyW25ld25pY2tdKSB7CiAgICAgICAgICAgICAgdGhpcy5yb3N0ZXJbbmV3bmlja10gPSB0aGlzLnJvc3RlcltuaWNrXS51cGRhdGUoZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGRlbGV0ZSB0aGlzLnJvc3RlcltuaWNrXTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBpZiAodGhpcy5yb3N0ZXJbbmlja10pIHsKICAgICAgICAgICAgdGhpcy5yb3N0ZXJbbmlja10udXBkYXRlKGRhdGEpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fYWRkT2NjdXBhbnQoZGF0YSk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgX3JlZiA9IHRoaXMuX3Jvc3Rlcl9oYW5kbGVyczsKICAgICAgZm9yIChpZCBpbiBfcmVmKSB7CiAgICAgICAgaGFuZGxlciA9IF9yZWZbaWRdOwogICAgICAgIGlmICghaGFuZGxlcih0aGlzLnJvc3RlciwgdGhpcykpIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLl9yb3N0ZXJfaGFuZGxlcnNbaWRdOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH07CgoKICAgIC8qRnVuY3Rpb24KICAgIFBhcnNlcyBhIHByZXNlbmNlIHN0YW56YQogICAgICBQYXJhbWV0ZXJzOgogICAgKE9iamVjdCkgZGF0YSAtIHRoZSBkYXRhIGV4dHJhY3RlZCBmcm9tIHRoZSBwcmVzZW5jZSBzdGFuemEKICAgICAqLwoKICAgIFhtcHBSb29tLl9wYXJzZVByZXNlbmNlID0gZnVuY3Rpb24ocHJlcykgewogICAgICB2YXIgYywgYzIsIGRhdGEsIF9pLCBfaiwgX2xlbiwgX2xlbjEsIF9yZWYsIF9yZWYxOwogICAgICBkYXRhID0ge307CiAgICAgIGRhdGEubmljayA9IFN0cm9waGUuZ2V0UmVzb3VyY2VGcm9tSmlkKHByZXMuZ2V0QXR0cmlidXRlKCJmcm9tIikpOwogICAgICBkYXRhLnR5cGUgPSBwcmVzLmdldEF0dHJpYnV0ZSgidHlwZSIpOwogICAgICBkYXRhLnN0YXRlcyA9IFtdOwogICAgICBfcmVmID0gcHJlcy5jaGlsZE5vZGVzOwogICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IF9yZWYubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICBjID0gX3JlZltfaV07CiAgICAgICAgc3dpdGNoIChjLm5vZGVOYW1lKSB7CiAgICAgICAgICBjYXNlICJzdGF0dXMiOgogICAgICAgICAgICBkYXRhLnN0YXR1cyA9IGMudGV4dENvbnRlbnQgfHwgbnVsbDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJzaG93IjoKICAgICAgICAgICAgZGF0YS5zaG93ID0gYy50ZXh0Q29udGVudCB8fCBudWxsOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgIngiOgogICAgICAgICAgICBpZiAoYy5nZXRBdHRyaWJ1dGUoInhtbG5zIikgPT09IFN0cm9waGUuTlMuTVVDX1VTRVIpIHsKICAgICAgICAgICAgICBfcmVmMSA9IGMuY2hpbGROb2RlczsKICAgICAgICAgICAgICBmb3IgKF9qID0gMCwgX2xlbjEgPSBfcmVmMS5sZW5ndGg7IF9qIDwgX2xlbjE7IF9qKyspIHsKICAgICAgICAgICAgICAgIGMyID0gX3JlZjFbX2pdOwogICAgICAgICAgICAgICAgc3dpdGNoIChjMi5ub2RlTmFtZSkgewogICAgICAgICAgICAgICAgICBjYXNlICJpdGVtIjoKICAgICAgICAgICAgICAgICAgICBkYXRhLmFmZmlsaWF0aW9uID0gYzIuZ2V0QXR0cmlidXRlKCJhZmZpbGlhdGlvbiIpOwogICAgICAgICAgICAgICAgICAgIGRhdGEucm9sZSA9IGMyLmdldEF0dHJpYnV0ZSgicm9sZSIpOwogICAgICAgICAgICAgICAgICAgIGRhdGEuamlkID0gYzIuZ2V0QXR0cmlidXRlKCJqaWQiKTsKICAgICAgICAgICAgICAgICAgICBkYXRhLm5ld25pY2sgPSBjMi5nZXRBdHRyaWJ1dGUoIm5pY2siKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAic3RhdHVzIjoKICAgICAgICAgICAgICAgICAgICBpZiAoYzIuZ2V0QXR0cmlidXRlKCJjb2RlIikpIHsKICAgICAgICAgICAgICAgICAgICAgIGRhdGEuc3RhdGVzLnB1c2goYzIuZ2V0QXR0cmlidXRlKCJjb2RlIikpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGRhdGE7CiAgICB9OwoKICAgIHJldHVybiBYbXBwUm9vbTsKCiAgfSkoKTsKCiAgUm9vbUNvbmZpZyA9IChmdW5jdGlvbigpIHsKICAgIGZ1bmN0aW9uIFJvb21Db25maWcoaW5mbykgewogICAgICB0aGlzLnBhcnNlID0gX19iaW5kKHRoaXMucGFyc2UsIHRoaXMpOwogICAgICBpZiAoaW5mbyAhPSBudWxsKSB7CiAgICAgICAgdGhpcy5wYXJzZShpbmZvKTsKICAgICAgfQogICAgfQoKICAgIFJvb21Db25maWcucHJvdG90eXBlLnBhcnNlID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgIHZhciBhdHRyLCBhdHRycywgY2hpbGQsIGZpZWxkLCBpZGVudGl0eSwgcXVlcnksIF9pLCBfaiwgX2ssIF9sZW4sIF9sZW4xLCBfbGVuMiwgX3JlZjsKICAgICAgcXVlcnkgPSByZXN1bHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInF1ZXJ5IilbMF0uY2hpbGROb2RlczsKICAgICAgdGhpcy5pZGVudGl0aWVzID0gW107CiAgICAgIHRoaXMuZmVhdHVyZXMgPSBbXTsKICAgICAgdGhpcy54ID0gW107CiAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gcXVlcnkubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICBjaGlsZCA9IHF1ZXJ5W19pXTsKICAgICAgICBhdHRycyA9IGNoaWxkLmF0dHJpYnV0ZXM7CiAgICAgICAgc3dpdGNoIChjaGlsZC5ub2RlTmFtZSkgewogICAgICAgICAgY2FzZSAiaWRlbnRpdHkiOgogICAgICAgICAgICBpZGVudGl0eSA9IHt9OwogICAgICAgICAgICBmb3IgKF9qID0gMCwgX2xlbjEgPSBhdHRycy5sZW5ndGg7IF9qIDwgX2xlbjE7IF9qKyspIHsKICAgICAgICAgICAgICBhdHRyID0gYXR0cnNbX2pdOwogICAgICAgICAgICAgIGlkZW50aXR5W2F0dHIubmFtZV0gPSBhdHRyLnRleHRDb250ZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaWRlbnRpdGllcy5wdXNoKGlkZW50aXR5KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJmZWF0dXJlIjoKICAgICAgICAgICAgdGhpcy5mZWF0dXJlcy5wdXNoKGNoaWxkLmdldEF0dHJpYnV0ZSgidmFyIikpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgIngiOgogICAgICAgICAgICBpZiAoKCFjaGlsZC5jaGlsZE5vZGVzWzBdLmdldEF0dHJpYnV0ZSgidmFyIikgPT09ICdGT1JNX1RZUEUnKSB8fCAoIWNoaWxkLmNoaWxkTm9kZXNbMF0uZ2V0QXR0cmlidXRlKCJ0eXBlIikgPT09ICdoaWRkZW4nKSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF9yZWYgPSBjaGlsZC5jaGlsZE5vZGVzOwogICAgICAgICAgICBmb3IgKF9rID0gMCwgX2xlbjIgPSBfcmVmLmxlbmd0aDsgX2sgPCBfbGVuMjsgX2srKykgewogICAgICAgICAgICAgIGZpZWxkID0gX3JlZltfa107CiAgICAgICAgICAgICAgaWYgKCFmaWVsZC5hdHRyaWJ1dGVzLnR5cGUpIHsKICAgICAgICAgICAgICAgIHRoaXMueC5wdXNoKHsKICAgICAgICAgICAgICAgICAgInZhciI6IGZpZWxkLmdldEF0dHJpYnV0ZSgidmFyIiksCiAgICAgICAgICAgICAgICAgIGxhYmVsOiBmaWVsZC5nZXRBdHRyaWJ1dGUoImxhYmVsIikgfHwgIiIsCiAgICAgICAgICAgICAgICAgIHZhbHVlOiBmaWVsZC5maXJzdENoaWxkLnRleHRDb250ZW50IHx8ICIiCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICAiaWRlbnRpdGllcyI6IHRoaXMuaWRlbnRpdGllcywKICAgICAgICAiZmVhdHVyZXMiOiB0aGlzLmZlYXR1cmVzLAogICAgICAgICJ4IjogdGhpcy54CiAgICAgIH07CiAgICB9OwoKICAgIHJldHVybiBSb29tQ29uZmlnOwoKICB9KSgpOwoKICBPY2N1cGFudCA9IChmdW5jdGlvbigpIHsKICAgIGZ1bmN0aW9uIE9jY3VwYW50KGRhdGEsIHJvb20pIHsKICAgICAgdGhpcy5yb29tID0gcm9vbTsKICAgICAgdGhpcy51cGRhdGUgPSBfX2JpbmQodGhpcy51cGRhdGUsIHRoaXMpOwogICAgICB0aGlzLmFkbWluID0gX19iaW5kKHRoaXMuYWRtaW4sIHRoaXMpOwogICAgICB0aGlzLm93bmVyID0gX19iaW5kKHRoaXMub3duZXIsIHRoaXMpOwogICAgICB0aGlzLnJldm9rZSA9IF9fYmluZCh0aGlzLnJldm9rZSwgdGhpcyk7CiAgICAgIHRoaXMubWVtYmVyID0gX19iaW5kKHRoaXMubWVtYmVyLCB0aGlzKTsKICAgICAgdGhpcy5iYW4gPSBfX2JpbmQodGhpcy5iYW4sIHRoaXMpOwogICAgICB0aGlzLm1vZGlmeUFmZmlsaWF0aW9uID0gX19iaW5kKHRoaXMubW9kaWZ5QWZmaWxpYXRpb24sIHRoaXMpOwogICAgICB0aGlzLmRlb3AgPSBfX2JpbmQodGhpcy5kZW9wLCB0aGlzKTsKICAgICAgdGhpcy5vcCA9IF9fYmluZCh0aGlzLm9wLCB0aGlzKTsKICAgICAgdGhpcy5tdXRlID0gX19iaW5kKHRoaXMubXV0ZSwgdGhpcyk7CiAgICAgIHRoaXMudm9pY2UgPSBfX2JpbmQodGhpcy52b2ljZSwgdGhpcyk7CiAgICAgIHRoaXMua2ljayA9IF9fYmluZCh0aGlzLmtpY2ssIHRoaXMpOwogICAgICB0aGlzLm1vZGlmeVJvbGUgPSBfX2JpbmQodGhpcy5tb2RpZnlSb2xlLCB0aGlzKTsKICAgICAgdGhpcy51cGRhdGUoZGF0YSk7CiAgICB9CgogICAgT2NjdXBhbnQucHJvdG90eXBlLm1vZGlmeVJvbGUgPSBmdW5jdGlvbihyb2xlLCByZWFzb24sIHN1Y2Nlc3NfY2IsIGVycm9yX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLnJvb20ubW9kaWZ5Um9sZSh0aGlzLm5pY2ssIHJvbGUsIHJlYXNvbiwgc3VjY2Vzc19jYiwgZXJyb3JfY2IpOwogICAgfTsKCiAgICBPY2N1cGFudC5wcm90b3R5cGUua2ljayA9IGZ1bmN0aW9uKHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMucm9vbS5raWNrKHRoaXMubmljaywgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgICB9OwoKICAgIE9jY3VwYW50LnByb3RvdHlwZS52b2ljZSA9IGZ1bmN0aW9uKHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMucm9vbS52b2ljZSh0aGlzLm5pY2ssIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfTsKCiAgICBPY2N1cGFudC5wcm90b3R5cGUubXV0ZSA9IGZ1bmN0aW9uKHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMucm9vbS5tdXRlKHRoaXMubmljaywgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgICB9OwoKICAgIE9jY3VwYW50LnByb3RvdHlwZS5vcCA9IGZ1bmN0aW9uKHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMucm9vbS5vcCh0aGlzLm5pY2ssIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfTsKCiAgICBPY2N1cGFudC5wcm90b3R5cGUuZGVvcCA9IGZ1bmN0aW9uKHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMucm9vbS5kZW9wKHRoaXMubmljaywgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgICB9OwoKICAgIE9jY3VwYW50LnByb3RvdHlwZS5tb2RpZnlBZmZpbGlhdGlvbiA9IGZ1bmN0aW9uKGFmZmlsaWF0aW9uLCByZWFzb24sIHN1Y2Nlc3NfY2IsIGVycm9yX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLnJvb20ubW9kaWZ5QWZmaWxpYXRpb24odGhpcy5qaWQsIGFmZmlsaWF0aW9uLCByZWFzb24sIHN1Y2Nlc3NfY2IsIGVycm9yX2NiKTsKICAgIH07CgogICAgT2NjdXBhbnQucHJvdG90eXBlLmJhbiA9IGZ1bmN0aW9uKHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMucm9vbS5iYW4odGhpcy5qaWQsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfTsKCiAgICBPY2N1cGFudC5wcm90b3R5cGUubWVtYmVyID0gZnVuY3Rpb24ocmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYikgewogICAgICByZXR1cm4gdGhpcy5yb29tLm1lbWJlcih0aGlzLmppZCwgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgICB9OwoKICAgIE9jY3VwYW50LnByb3RvdHlwZS5yZXZva2UgPSBmdW5jdGlvbihyZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLnJvb20ucmV2b2tlKHRoaXMuamlkLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKTsKICAgIH07CgogICAgT2NjdXBhbnQucHJvdG90eXBlLm93bmVyID0gZnVuY3Rpb24ocmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYikgewogICAgICByZXR1cm4gdGhpcy5yb29tLm93bmVyKHRoaXMuamlkLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKTsKICAgIH07CgogICAgT2NjdXBhbnQucHJvdG90eXBlLmFkbWluID0gZnVuY3Rpb24ocmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYikgewogICAgICByZXR1cm4gdGhpcy5yb29tLmFkbWluKHRoaXMuamlkLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKTsKICAgIH07CgogICAgT2NjdXBhbnQucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgdGhpcy5uaWNrID0gZGF0YS5uaWNrIHx8IG51bGw7CiAgICAgIHRoaXMuYWZmaWxpYXRpb24gPSBkYXRhLmFmZmlsaWF0aW9uIHx8IG51bGw7CiAgICAgIHRoaXMucm9sZSA9IGRhdGEucm9sZSB8fCBudWxsOwogICAgICB0aGlzLmppZCA9IGRhdGEuamlkIHx8IG51bGw7CiAgICAgIHRoaXMuc3RhdHVzID0gZGF0YS5zdGF0dXMgfHwgbnVsbDsKICAgICAgdGhpcy5zaG93ID0gZGF0YS5zaG93IHx8IG51bGw7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICByZXR1cm4gT2NjdXBhbnQ7CgogIH0pKCk7Cgp9KS5jYWxsKHRoaXMpOwoKZGVmaW5lKCJzdHJvcGhlLm11YyIsIFsic3Ryb3BoZSJdLCBmdW5jdGlvbigpe30pOwoKLyoKICBDb3B5cmlnaHQgMjAxMCwgRnJhbsOnb2lzIGRlIE1ldHogPGZyYW5jb2lzQDJtZXR6LmZyPgoqLwovKioKICogUm9zdGVyIFBsdWdpbgogKiBBbGxvdyBlYXNpbHkgcm9zdGVyIG1hbmFnZW1lbnQKICoKICogIEZlYXR1cmVzCiAqICAqIEdldCByb3N0ZXIgZnJvbSBzZXJ2ZXIKICogICogaGFuZGxlIHByZXNlbmNlCiAqICAqIGhhbmRsZSByb3N0ZXIgaXEKICogICogc3Vic2NyaWJlL3Vuc3Vic2NyaWJlCiAqICAqIGF1dGhvcml6ZS91bmF1dGhvcml6ZQogKiAgKiByb3N0ZXIgdmVyc2lvbmluZyAoeGVwIDIzNykKICovClN0cm9waGUuYWRkQ29ubmVjdGlvblBsdWdpbigncm9zdGVyJywKewogICAgLyoqIEZ1bmN0aW9uOiBpbml0CiAgICAgKiBQbHVnaW4gaW5pdAogICAgICoKICAgICAqIFBhcmFtZXRlcnM6CiAgICAgKiAgIChTdHJvcGhlLkNvbm5lY3Rpb24pIGNvbm4gLSBTdHJvcGhlIGNvbm5lY3Rpb24KICAgICAqLwogICAgaW5pdDogZnVuY3Rpb24oY29ubikKICAgIHsKICAgICAgICB0aGlzLl9jb25uZWN0aW9uID0gY29ubjsKICAgICAgICB0aGlzLl9jYWxsYmFja3MgPSBbXTsKICAgICAgICAvKiogUHJvcGVydHk6IGl0ZW1zCiAgICAgICAgICogIFJvc3RlciBpdGVtcwogICAgICAgICAqICBbCiAgICAgICAgICogICAgewogICAgICAgICAqICAgICAgICBuYW1lICAgICAgICAgOiAiIiwKICAgICAgICAgKiAgICAgICAgamlkICAgICAgICAgIDogIiIsCiAgICAgICAgICogICAgICAgIHN1YnNjcmlwdGlvbiA6ICIiLAogICAgICAgICAqICAgICAgICBhc2sgICAgICAgICAgOiAiIiwKICAgICAgICAgKiAgICAgICAgZ3JvdXBzICAgICAgIDogWyIiLCAiIl0sCiAgICAgICAgICogICAgICAgIHJlc291cmNlcyAgICA6IHsKICAgICAgICAgKiAgICAgICAgICAgIG15cmVzb3VyY2UgOiB7CiAgICAgICAgICogICAgICAgICAgICAgICAgc2hvdyAgIDogIiIsCiAgICAgICAgICogICAgICAgICAgICAgICAgc3RhdHVzIDogIiIsCiAgICAgICAgICogICAgICAgICAgICAgICAgcHJpb3JpdHkgOiAiIgogICAgICAgICAqICAgICAgICAgICAgfQogICAgICAgICAqICAgICAgICB9CiAgICAgICAgICogICAgfQogICAgICAgICAqIF0KICAgICAgICAgKi8KICAgICAgICB0aGlzLml0ZW1zID0gW107CiAgICAgICAgLyoqIFByb3BlcnR5OiB2ZXIKICAgICAgICAqIGN1cnJlbnQgcm9zdGVyIHJldmlzaW9uCiAgICAgICAgKiBhbHdheXMgbnVsbCBpZiBzZXJ2ZXIgZG9lc24ndCBzdXBwb3J0IHhlcCAyMzcKICAgICAgICAqLwogICAgICAgIHRoaXMudmVyID0gbnVsbDsKICAgICAgICAvLyBPdmVycmlkZSB0aGUgY29ubmVjdCBhbmQgYXR0YWNoIG1ldGhvZHMgdG8gYWx3YXlzIGFkZCBwcmVzZW5jZSBhbmQgcm9zdGVyIGhhbmRsZXJzLgogICAgICAgIC8vIFRoZXkgYXJlIHJlbW92ZWQgd2hlbiB0aGUgY29ubmVjdGlvbiBkaXNjb25uZWN0cywgc28gbXVzdCBiZSBhZGRlZCBvbiBjb25uZWN0aW9uLgogICAgICAgIHZhciBvbGRDYWxsYmFjaywgcm9zdGVyID0gdGhpcywgX2Nvbm5lY3QgPSBjb25uLmNvbm5lY3QsIF9hdHRhY2ggPSBjb25uLmF0dGFjaDsKICAgICAgICB2YXIgbmV3Q2FsbGJhY2sgPSBmdW5jdGlvbihzdGF0dXMpCiAgICAgICAgewogICAgICAgICAgICBpZiAoc3RhdHVzID09IFN0cm9waGUuU3RhdHVzLkFUVEFDSEVEIHx8IHN0YXR1cyA9PSBTdHJvcGhlLlN0YXR1cy5DT05ORUNURUQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRyeQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIFByZXNlbmNlIHN1YnNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgIGNvbm4uYWRkSGFuZGxlcihyb3N0ZXIuX29uUmVjZWl2ZVByZXNlbmNlLmJpbmQocm9zdGVyKSwgbnVsbCwgJ3ByZXNlbmNlJywgbnVsbCwgbnVsbCwgbnVsbCk7CiAgICAgICAgICAgICAgICAgICAgY29ubi5hZGRIYW5kbGVyKHJvc3Rlci5fb25SZWNlaXZlSVEuYmluZChyb3N0ZXIpLCBTdHJvcGhlLk5TLlJPU1RFUiwgJ2lxJywgInNldCIsIG51bGwsIG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2F0Y2ggKGUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgU3Ryb3BoZS5lcnJvcihlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG9sZENhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBvbGRDYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBjb25uLmNvbm5lY3QgPSBmdW5jdGlvbihqaWQsIHBhc3MsIGNhbGxiYWNrLCB3YWl0LCBob2xkKQogICAgICAgIHsKICAgICAgICAgICAgb2xkQ2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgaWYgKHR5cGVvZiBqaWQgID09ICJ1bmRlZmluZWQiKQogICAgICAgICAgICAgICAgamlkICA9IG51bGw7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFzcyA9PSAidW5kZWZpbmVkIikKICAgICAgICAgICAgICAgIHBhc3MgPSBudWxsOwogICAgICAgICAgICBjYWxsYmFjayA9IG5ld0NhbGxiYWNrOwogICAgICAgICAgICBfY29ubmVjdC5hcHBseShjb25uLCBbamlkLCBwYXNzLCBjYWxsYmFjaywgd2FpdCwgaG9sZF0pOwogICAgICAgIH07CiAgICAgICAgY29ubi5hdHRhY2ggPSBmdW5jdGlvbihqaWQsIHNpZCwgcmlkLCBjYWxsYmFjaywgd2FpdCwgaG9sZCwgd2luZCkKICAgICAgICB7CiAgICAgICAgICAgIG9sZENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgIGlmICh0eXBlb2YgamlkID09ICJ1bmRlZmluZWQiKQogICAgICAgICAgICAgICAgamlkID0gbnVsbDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBzaWQgPT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICBzaWQgPSBudWxsOwogICAgICAgICAgICBpZiAodHlwZW9mIHJpZCA9PSAidW5kZWZpbmVkIikKICAgICAgICAgICAgICAgIHJpZCA9IG51bGw7CiAgICAgICAgICAgIGNhbGxiYWNrID0gbmV3Q2FsbGJhY2s7CiAgICAgICAgICAgIF9hdHRhY2guYXBwbHkoY29ubiwgW2ppZCwgc2lkLCByaWQsIGNhbGxiYWNrLCB3YWl0LCBob2xkLCB3aW5kXSk7CiAgICAgICAgfTsKCiAgICAgICAgU3Ryb3BoZS5hZGROYW1lc3BhY2UoJ1JPU1RFUl9WRVInLCAndXJuOnhtcHA6ZmVhdHVyZXM6cm9zdGVydmVyJyk7CiAgICAgICAgU3Ryb3BoZS5hZGROYW1lc3BhY2UoJ05JQ0snLCAnaHR0cDovL2phYmJlci5vcmcvcHJvdG9jb2wvbmljaycpOwogICAgfSwKICAgIC8qKiBGdW5jdGlvbjogc3VwcG9ydFZlcnNpb25pbmcKICAgICAqIHJldHVybiB0cnVlIGlmIHJvc3RlciB2ZXJzaW9uaW5nIGlzIGVuYWJsZWQgb24gc2VydmVyCiAgICAgKi8KICAgIHN1cHBvcnRWZXJzaW9uaW5nOiBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgcmV0dXJuICh0aGlzLl9jb25uZWN0aW9uLmZlYXR1cmVzICYmIHRoaXMuX2Nvbm5lY3Rpb24uZmVhdHVyZXMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3ZlcicpLmxlbmd0aCA+IDApOwogICAgfSwKICAgIC8qKiBGdW5jdGlvbjogZ2V0CiAgICAgKiBHZXQgUm9zdGVyIG9uIHNlcnZlcgogICAgICoKICAgICAqIFBhcmFtZXRlcnM6CiAgICAgKiAgIChGdW5jdGlvbikgdXNlckNhbGxiYWNrIC0gY2FsbGJhY2sgb24gcm9zdGVyIHJlc3VsdAogICAgICogICAoU3RyaW5nKSB2ZXIgLSBjdXJyZW50IHJldiBvZiByb3N0ZXIKICAgICAqICAgICAgKG9ubHkgdXNlZCBpZiByb3N0ZXIgdmVyc2lvbmluZyBpcyBlbmFibGVkKQogICAgICogICAoQXJyYXkpIGl0ZW1zIC0gaW5pdGlhbCBpdGVtcyBvZiB2ZXIKICAgICAqICAgICAgKG9ubHkgdXNlZCBpZiByb3N0ZXIgdmVyc2lvbmluZyBpcyBlbmFibGVkKQogICAgICogICAgIEluIGJyb3dzZXIgY29udGV4dCB5b3UgY2FuIHVzZSBzZXNzaW9uU3RvcmFnZQogICAgICogICAgIHRvIHN0b3JlIHlvdXIgcm9zdGVyIGluIGpzb24gKEpTT04uc3RyaW5naWZ5KCkpCiAgICAgKi8KICAgIGdldDogZnVuY3Rpb24odXNlckNhbGxiYWNrLCB2ZXIsIGl0ZW1zKQogICAgewogICAgICAgIHZhciBhdHRycyA9IHt4bWxuczogU3Ryb3BoZS5OUy5ST1NURVJ9OwogICAgICAgIGlmICh0aGlzLnN1cHBvcnRWZXJzaW9uaW5nKCkpCiAgICAgICAgewogICAgICAgICAgICAvLyBlbXB0eSByZXYgYmVjYXVzZSBpIHdhbnQgYW4gcmV2IGF0dHJpYnV0ZSBpbiB0aGUgcmVzdWx0CiAgICAgICAgICAgIGF0dHJzLnZlciA9IHZlciB8fCAnJzsKICAgICAgICAgICAgdGhpcy5pdGVtcyA9IGl0ZW1zIHx8IFtdOwogICAgICAgIH0KICAgICAgICB2YXIgaXEgPSAkaXEoe3R5cGU6ICdnZXQnLCAgJ2lkJyA6IHRoaXMuX2Nvbm5lY3Rpb24uZ2V0VW5pcXVlSWQoJ3Jvc3RlcicpfSkuYygncXVlcnknLCBhdHRycyk7CiAgICAgICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZElRKGlxLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX29uUmVjZWl2ZVJvc3RlclN1Y2Nlc3MuYmluZCh0aGlzLCB1c2VyQ2FsbGJhY2spLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX29uUmVjZWl2ZVJvc3RlckVycm9yLmJpbmQodGhpcywgdXNlckNhbGxiYWNrKSk7CiAgICB9LAogICAgLyoqIEZ1bmN0aW9uOiByZWdpc3RlckNhbGxiYWNrCiAgICAgKiByZWdpc3RlciBjYWxsYmFjayBvbiByb3N0ZXIgKHByZXNlbmNlIGFuZCBpcSkKICAgICAqCiAgICAgKiBQYXJhbWV0ZXJzOgogICAgICogICAoRnVuY3Rpb24pIGNhbGxfYmFjawogICAgICovCiAgICByZWdpc3RlckNhbGxiYWNrOiBmdW5jdGlvbihjYWxsX2JhY2spCiAgICB7CiAgICAgICAgdGhpcy5fY2FsbGJhY2tzLnB1c2goY2FsbF9iYWNrKTsKICAgIH0sCiAgICAvKiogRnVuY3Rpb246IGZpbmRJdGVtCiAgICAgKiBGaW5kIGl0ZW0gYnkgSklECiAgICAgKgogICAgICogUGFyYW1ldGVyczoKICAgICAqICAgICAoU3RyaW5nKSBqaWQKICAgICAqLwogICAgZmluZEl0ZW0gOiBmdW5jdGlvbihqaWQpCiAgICB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLml0ZW1zLmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5pdGVtc1tpXSAmJiB0aGlzLml0ZW1zW2ldLmppZCA9PSBqaWQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaXRlbXNbaV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKQogICAgICAgIHsKICAgICAgICAgICAgU3Ryb3BoZS5lcnJvcihlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAgIC8qKiBGdW5jdGlvbjogcmVtb3ZlSXRlbQogICAgICogUmVtb3ZlIGl0ZW0gYnkgSklECiAgICAgKgogICAgICogUGFyYW1ldGVyczoKICAgICAqICAgICAoU3RyaW5nKSBqaWQKICAgICAqLwogICAgcmVtb3ZlSXRlbSA6IGZ1bmN0aW9uKGppZCkKICAgIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuaXRlbXMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5pdGVtc1tpXSAmJiB0aGlzLml0ZW1zW2ldLmppZCA9PSBqaWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuaXRlbXMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAgIC8qKiBGdW5jdGlvbjogc3Vic2NyaWJlCiAgICAgKiBTdWJzY3JpYmUgcHJlc2VuY2UKICAgICAqCiAgICAgKiBQYXJhbWV0ZXJzOgogICAgICogICAgIChTdHJpbmcpIGppZAogICAgICogICAgIChTdHJpbmcpIG1lc3NhZ2UgKG9wdGlvbmFsKQogICAgICogICAgIChTdHJpbmcpIG5pY2sgIChvcHRpb25hbCkKICAgICAqLwogICAgc3Vic2NyaWJlOiBmdW5jdGlvbihqaWQsIG1lc3NhZ2UsIG5pY2spIHsKICAgICAgICB2YXIgcHJlcyA9ICRwcmVzKHt0bzogamlkLCB0eXBlOiAic3Vic2NyaWJlIn0pOwogICAgICAgIGlmIChtZXNzYWdlICYmIG1lc3NhZ2UgIT09ICIiKSB7CiAgICAgICAgICAgIHByZXMuYygic3RhdHVzIikudChtZXNzYWdlKS51cCgpOwogICAgICAgIH0KICAgICAgICBpZiAobmljayAmJiBuaWNrICE9PSAiIikgewogICAgICAgICAgICBwcmVzLmMoJ25pY2snLCB7J3htbG5zJzogU3Ryb3BoZS5OUy5OSUNLfSkudChuaWNrKS51cCgpOwogICAgICAgIH0KICAgICAgICB0aGlzLl9jb25uZWN0aW9uLnNlbmQocHJlcyk7CiAgICB9LAogICAgLyoqIEZ1bmN0aW9uOiB1bnN1YnNjcmliZQogICAgICogVW5zdWJzY3JpYmUgcHJlc2VuY2UKICAgICAqCiAgICAgKiBQYXJhbWV0ZXJzOgogICAgICogICAgIChTdHJpbmcpIGppZAogICAgICogICAgIChTdHJpbmcpIG1lc3NhZ2UKICAgICAqLwogICAgdW5zdWJzY3JpYmU6IGZ1bmN0aW9uKGppZCwgbWVzc2FnZSkKICAgIHsKICAgICAgICB2YXIgcHJlcyA9ICRwcmVzKHt0bzogamlkLCB0eXBlOiAidW5zdWJzY3JpYmUifSk7CiAgICAgICAgaWYgKG1lc3NhZ2UgJiYgbWVzc2FnZSAhPT0gIiIpCiAgICAgICAgICAgIHByZXMuYygic3RhdHVzIikudChtZXNzYWdlKTsKICAgICAgICB0aGlzLl9jb25uZWN0aW9uLnNlbmQocHJlcyk7CiAgICB9LAogICAgLyoqIEZ1bmN0aW9uOiBhdXRob3JpemUKICAgICAqIEF1dGhvcml6ZSBwcmVzZW5jZSBzdWJzY3JpcHRpb24KICAgICAqCiAgICAgKiBQYXJhbWV0ZXJzOgogICAgICogICAgIChTdHJpbmcpIGppZAogICAgICogICAgIChTdHJpbmcpIG1lc3NhZ2UKICAgICAqLwogICAgYXV0aG9yaXplOiBmdW5jdGlvbihqaWQsIG1lc3NhZ2UpCiAgICB7CiAgICAgICAgdmFyIHByZXMgPSAkcHJlcyh7dG86IGppZCwgdHlwZTogInN1YnNjcmliZWQifSk7CiAgICAgICAgaWYgKG1lc3NhZ2UgJiYgbWVzc2FnZSAhPT0gIiIpCiAgICAgICAgICAgIHByZXMuYygic3RhdHVzIikudChtZXNzYWdlKTsKICAgICAgICB0aGlzLl9jb25uZWN0aW9uLnNlbmQocHJlcyk7CiAgICB9LAogICAgLyoqIEZ1bmN0aW9uOiB1bmF1dGhvcml6ZQogICAgICogVW5hdXRob3JpemUgcHJlc2VuY2Ugc3Vic2NyaXB0aW9uCiAgICAgKgogICAgICogUGFyYW1ldGVyczoKICAgICAqICAgICAoU3RyaW5nKSBqaWQKICAgICAqICAgICAoU3RyaW5nKSBtZXNzYWdlCiAgICAgKi8KICAgIHVuYXV0aG9yaXplOiBmdW5jdGlvbihqaWQsIG1lc3NhZ2UpCiAgICB7CiAgICAgICAgdmFyIHByZXMgPSAkcHJlcyh7dG86IGppZCwgdHlwZTogInVuc3Vic2NyaWJlZCJ9KTsKICAgICAgICBpZiAobWVzc2FnZSAmJiBtZXNzYWdlICE9PSAiIikKICAgICAgICAgICAgcHJlcy5jKCJzdGF0dXMiKS50KG1lc3NhZ2UpOwogICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZChwcmVzKTsKICAgIH0sCiAgICAvKiogRnVuY3Rpb246IGFkZAogICAgICogQWRkIHJvc3RlciBpdGVtCiAgICAgKgogICAgICogUGFyYW1ldGVyczoKICAgICAqICAgKFN0cmluZykgamlkIC0gaXRlbSBqaWQKICAgICAqICAgKFN0cmluZykgbmFtZSAtIG5hbWUKICAgICAqICAgKEFycmF5KSBncm91cHMKICAgICAqICAgKEZ1bmN0aW9uKSBjYWxsX2JhY2sKICAgICAqLwogICAgYWRkOiBmdW5jdGlvbihqaWQsIG5hbWUsIGdyb3VwcywgY2FsbF9iYWNrKQogICAgewogICAgICAgIHZhciBpcSA9ICRpcSh7dHlwZTogJ3NldCd9KS5jKCdxdWVyeScsIHt4bWxuczogU3Ryb3BoZS5OUy5ST1NURVJ9KS5jKCdpdGVtJywge2ppZDogamlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWV9KTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGdyb3Vwcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlxLmMoJ2dyb3VwJykudChncm91cHNbaV0pLnVwKCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZElRKGlxLCBjYWxsX2JhY2ssIGNhbGxfYmFjayk7CiAgICB9LAogICAgLyoqIEZ1bmN0aW9uOiB1cGRhdGUKICAgICAqIFVwZGF0ZSByb3N0ZXIgaXRlbQogICAgICoKICAgICAqIFBhcmFtZXRlcnM6CiAgICAgKiAgIChTdHJpbmcpIGppZCAtIGl0ZW0gamlkCiAgICAgKiAgIChTdHJpbmcpIG5hbWUgLSBuYW1lCiAgICAgKiAgIChBcnJheSkgZ3JvdXBzCiAgICAgKiAgIChGdW5jdGlvbikgY2FsbF9iYWNrCiAgICAgKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24oamlkLCBuYW1lLCBncm91cHMsIGNhbGxfYmFjaykKICAgIHsKICAgICAgICB2YXIgaXRlbSA9IHRoaXMuZmluZEl0ZW0oamlkKTsKICAgICAgICBpZiAoIWl0ZW0pCiAgICAgICAgewogICAgICAgICAgICB0aHJvdyAiaXRlbSBub3QgZm91bmQiOwogICAgICAgIH0KICAgICAgICB2YXIgbmV3TmFtZSA9IG5hbWUgfHwgaXRlbS5uYW1lOwogICAgICAgIHZhciBuZXdHcm91cHMgPSBncm91cHMgfHwgaXRlbS5ncm91cHM7CiAgICAgICAgdmFyIGlxID0gJGlxKHt0eXBlOiAnc2V0J30pLmMoJ3F1ZXJ5Jywge3htbG5zOiBTdHJvcGhlLk5TLlJPU1RFUn0pLmMoJ2l0ZW0nLCB7amlkOiBpdGVtLmppZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBuZXdOYW1lfSk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuZXdHcm91cHMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpcS5jKCdncm91cCcpLnQobmV3R3JvdXBzW2ldKS51cCgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5fY29ubmVjdGlvbi5zZW5kSVEoaXEsIGNhbGxfYmFjaywgY2FsbF9iYWNrKTsKICAgIH0sCiAgICAvKiogRnVuY3Rpb246IHJlbW92ZQogICAgICogUmVtb3ZlIHJvc3RlciBpdGVtCiAgICAgKgogICAgICogUGFyYW1ldGVyczoKICAgICAqICAgKFN0cmluZykgamlkIC0gaXRlbSBqaWQKICAgICAqICAgKEZ1bmN0aW9uKSBjYWxsX2JhY2sKICAgICAqLwogICAgcmVtb3ZlOiBmdW5jdGlvbihqaWQsIGNhbGxfYmFjaykKICAgIHsKICAgICAgICB2YXIgaXRlbSA9IHRoaXMuZmluZEl0ZW0oamlkKTsKICAgICAgICBpZiAoIWl0ZW0pCiAgICAgICAgewogICAgICAgICAgICB0aHJvdyAiaXRlbSBub3QgZm91bmQiOwogICAgICAgIH0KICAgICAgICB2YXIgaXEgPSAkaXEoe3R5cGU6ICdzZXQnfSkuYygncXVlcnknLCB7eG1sbnM6IFN0cm9waGUuTlMuUk9TVEVSfSkuYygnaXRlbScsIHtqaWQ6IGl0ZW0uamlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbjogInJlbW92ZSJ9KTsKICAgICAgICB0aGlzLl9jb25uZWN0aW9uLnNlbmRJUShpcSwgY2FsbF9iYWNrLCBjYWxsX2JhY2spOwogICAgfSwKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9vblJlY2VpdmVSb3N0ZXJTdWNjZXNzCiAgICAgKgogICAgICovCiAgICBfb25SZWNlaXZlUm9zdGVyU3VjY2VzczogZnVuY3Rpb24odXNlckNhbGxiYWNrLCBzdGFuemEpCiAgICB7CiAgICAgICAgdGhpcy5fdXBkYXRlSXRlbXMoc3RhbnphKTsKICAgICAgICBpZiAodHlwZW9mIHVzZXJDYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB1c2VyQ2FsbGJhY2sodGhpcy5pdGVtcyk7CiAgICAgICAgfQogICAgfSwKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9vblJlY2VpdmVSb3N0ZXJFcnJvcgogICAgICoKICAgICAqLwogICAgX29uUmVjZWl2ZVJvc3RlckVycm9yOiBmdW5jdGlvbih1c2VyQ2FsbGJhY2ssIHN0YW56YSkKICAgIHsKICAgICAgICB1c2VyQ2FsbGJhY2sodGhpcy5pdGVtcyk7CiAgICB9LAogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX29uUmVjZWl2ZVByZXNlbmNlCiAgICAgKiBIYW5kbGUgcHJlc2VuY2UKICAgICAqLwogICAgX29uUmVjZWl2ZVByZXNlbmNlIDogZnVuY3Rpb24ocHJlc2VuY2UpCiAgICB7CiAgICAgICAgLy8gVE9ETzogZnJvbSBpcyBvcHRpb25hbAogICAgICAgIHZhciBqaWQgPSBwcmVzZW5jZS5nZXRBdHRyaWJ1dGUoJ2Zyb20nKTsKICAgICAgICB2YXIgZnJvbSA9IFN0cm9waGUuZ2V0QmFyZUppZEZyb21KaWQoamlkKTsKICAgICAgICB2YXIgaXRlbSA9IHRoaXMuZmluZEl0ZW0oZnJvbSk7CiAgICAgICAgLy8gbm90IGluIHJvc3RlcgogICAgICAgIGlmICghaXRlbSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICB2YXIgdHlwZSA9IHByZXNlbmNlLmdldEF0dHJpYnV0ZSgndHlwZScpOwogICAgICAgIGlmICh0eXBlID09ICd1bmF2YWlsYWJsZScpCiAgICAgICAgewogICAgICAgICAgICBkZWxldGUgaXRlbS5yZXNvdXJjZXNbU3Ryb3BoZS5nZXRSZXNvdXJjZUZyb21KaWQoamlkKV07CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKCF0eXBlKQogICAgICAgIHsKICAgICAgICAgICAgLy8gVE9ETzogYWRkIHRpbWVzdGFtcAogICAgICAgICAgICBpdGVtLnJlc291cmNlc1tTdHJvcGhlLmdldFJlc291cmNlRnJvbUppZChqaWQpXSA9IHsKICAgICAgICAgICAgICAgIHNob3cgICAgIDogKHByZXNlbmNlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzaG93JykubGVuZ3RoICE9PSAwKSA/IFN0cm9waGUuZ2V0VGV4dChwcmVzZW5jZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc2hvdycpWzBdKSA6ICIiLAogICAgICAgICAgICAgICAgc3RhdHVzICAgOiAocHJlc2VuY2UuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3N0YXR1cycpLmxlbmd0aCAhPT0gMCkgPyBTdHJvcGhlLmdldFRleHQocHJlc2VuY2UuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3N0YXR1cycpWzBdKSA6ICIiLAogICAgICAgICAgICAgICAgcHJpb3JpdHkgOiAocHJlc2VuY2UuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3ByaW9yaXR5JykubGVuZ3RoICE9PSAwKSA/IFN0cm9waGUuZ2V0VGV4dChwcmVzZW5jZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgncHJpb3JpdHknKVswXSkgOiAiIgogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyBTdGFuemEgaXMgbm90IGEgcHJlc2VuY2Ugbm90aWZpY2F0aW9uLiAoSXQncyBwcm9iYWJseSBhIHN1YnNjcmlwdGlvbiB0eXBlIHN0YW56YS4pCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICB0aGlzLl9jYWxsX2JhY2tzKHRoaXMuaXRlbXMsIGl0ZW0pOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9jYWxsX2JhY2tzCiAgICAgKgogICAgICovCiAgICBfY2FsbF9iYWNrcyA6IGZ1bmN0aW9uKGl0ZW1zLCBpdGVtKQogICAgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fY2FsbGJhY2tzLmxlbmd0aDsgaSsrKSAvLyBbXS5mb3JFYWNoIG15IGxvdmUgLi4uCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9jYWxsYmFja3NbaV0oaXRlbXMsIGl0ZW0pOwogICAgICAgIH0KICAgIH0sCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfb25SZWNlaXZlSVEKICAgICAqIEhhbmRsZSByb3N0ZXIgcHVzaC4KICAgICAqLwogICAgX29uUmVjZWl2ZUlRIDogZnVuY3Rpb24oaXEpCiAgICB7CiAgICAgICAgdmFyIGlkID0gaXEuZ2V0QXR0cmlidXRlKCdpZCcpOwogICAgICAgIHZhciBmcm9tID0gaXEuZ2V0QXR0cmlidXRlKCdmcm9tJyk7CiAgICAgICAgLy8gUmVjZWl2aW5nIGNsaWVudCBNVVNUIGlnbm9yZSBzdGFuemEgdW5sZXNzIGl0IGhhcyBubyBmcm9tIG9yIGZyb20gPSB1c2VyJ3MgSklELgogICAgICAgIGlmIChmcm9tICYmIGZyb20gIT09ICIiICYmIGZyb20gIT0gdGhpcy5fY29ubmVjdGlvbi5qaWQgJiYgZnJvbSAhPSBTdHJvcGhlLmdldEJhcmVKaWRGcm9tSmlkKHRoaXMuX2Nvbm5lY3Rpb24uamlkKSkKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgdmFyIGlxcmVzdWx0ID0gJGlxKHt0eXBlOiAncmVzdWx0JywgaWQ6IGlkLCBmcm9tOiB0aGlzLl9jb25uZWN0aW9uLmppZH0pOwogICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZChpcXJlc3VsdCk7CiAgICAgICAgdGhpcy5fdXBkYXRlSXRlbXMoaXEpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF91cGRhdGVJdGVtcwogICAgICogVXBkYXRlIGl0ZW1zIGZyb20gaXEKICAgICAqLwogICAgX3VwZGF0ZUl0ZW1zIDogZnVuY3Rpb24oaXEpCiAgICB7CiAgICAgICAgdmFyIHF1ZXJ5ID0gaXEuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3F1ZXJ5Jyk7CiAgICAgICAgaWYgKHF1ZXJ5Lmxlbmd0aCAhPT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudmVyID0gcXVlcnkuaXRlbSgwKS5nZXRBdHRyaWJ1dGUoJ3ZlcicpOwogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgICAgIFN0cm9waGUuZm9yRWFjaENoaWxkKHF1ZXJ5Lml0ZW0oMCksICdpdGVtJywKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChpdGVtKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHNlbGYuX3VwZGF0ZUl0ZW0oaXRlbSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fY2FsbF9iYWNrcyh0aGlzLml0ZW1zKTsKICAgIH0sCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfdXBkYXRlSXRlbQogICAgICogVXBkYXRlIGludGVybmFsIHJlcHJlc2VudGF0aW9uIG9mIHJvc3RlciBpdGVtCiAgICAgKi8KICAgIF91cGRhdGVJdGVtIDogZnVuY3Rpb24oaXRlbSkKICAgIHsKICAgICAgICB2YXIgamlkICAgICAgICAgICA9IGl0ZW0uZ2V0QXR0cmlidXRlKCJqaWQiKTsKICAgICAgICB2YXIgbmFtZSAgICAgICAgICA9IGl0ZW0uZ2V0QXR0cmlidXRlKCJuYW1lIik7CiAgICAgICAgdmFyIHN1YnNjcmlwdGlvbiAgPSBpdGVtLmdldEF0dHJpYnV0ZSgic3Vic2NyaXB0aW9uIik7CiAgICAgICAgdmFyIGFzayAgICAgICAgICAgPSBpdGVtLmdldEF0dHJpYnV0ZSgiYXNrIik7CiAgICAgICAgdmFyIGdyb3VwcyAgICAgICAgPSBbXTsKICAgICAgICBTdHJvcGhlLmZvckVhY2hDaGlsZChpdGVtLCAnZ3JvdXAnLAogICAgICAgICAgICBmdW5jdGlvbihncm91cCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZ3JvdXBzLnB1c2goU3Ryb3BoZS5nZXRUZXh0KGdyb3VwKSk7CiAgICAgICAgICAgIH0KICAgICAgICApOwoKICAgICAgICBpZiAoc3Vic2NyaXB0aW9uID09ICJyZW1vdmUiKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5yZW1vdmVJdGVtKGppZCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGl0ZW0gPSB0aGlzLmZpbmRJdGVtKGppZCk7CiAgICAgICAgaWYgKCFpdGVtKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5pdGVtcy5wdXNoKHsKICAgICAgICAgICAgICAgIG5hbWUgICAgICAgICA6IG5hbWUsCiAgICAgICAgICAgICAgICBqaWQgICAgICAgICAgOiBqaWQsCiAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb24gOiBzdWJzY3JpcHRpb24sCiAgICAgICAgICAgICAgICBhc2sgICAgICAgICAgOiBhc2ssCiAgICAgICAgICAgICAgICBncm91cHMgICAgICAgOiBncm91cHMsCiAgICAgICAgICAgICAgICByZXNvdXJjZXMgICAgOiB7fQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaXRlbS5uYW1lID0gbmFtZTsKICAgICAgICAgICAgaXRlbS5zdWJzY3JpcHRpb24gPSBzdWJzY3JpcHRpb247CiAgICAgICAgICAgIGl0ZW0uYXNrID0gYXNrOwogICAgICAgICAgICBpdGVtLmdyb3VwcyA9IGdyb3VwczsKICAgICAgICB9CiAgICB9Cn0pOwoKZGVmaW5lKCJzdHJvcGhlLnJvc3RlciIsIFsic3Ryb3BoZSJdLCBmdW5jdGlvbigpe30pOwoKLy8gR2VuZXJhdGVkIGJ5IENvZmZlZVNjcmlwdCAxLjMuMwovKgpQbHVnaW4gdG8gaW1wbGVtZW50IHRoZSB2Q2FyZCBleHRlbnNpb24uCmh0dHA6Ly94bXBwLm9yZy9leHRlbnNpb25zL3hlcC0wMDU0Lmh0bWwKCkF1dGhvcjogTmF0aGFuIFpvcm4gKG5hdGhhbi56b3JuQGdtYWlsLmNvbSkKQ29mZmVlU2NyaXB0IHBvcnQ6IEFuZHJlYXMgR3V0aCAoZ3V0aEBkYmlzLnJ3dGgtYWFjaGVuLmRlKQoqLwoKLyoganNsaW50IGNvbmZpZ3VyYXRpb246CiovCgovKiBnbG9iYWwgZG9jdW1lbnQsIHdpbmRvdywgc2V0VGltZW91dCwgY2xlYXJUaW1lb3V0LCBjb25zb2xlLAogICAgWE1MSHR0cFJlcXVlc3QsIEFjdGl2ZVhPYmplY3QsCiAgICBCYXNlNjQsIE1ENSwKICAgIFN0cm9waGUsICRidWlsZCwgJG1zZywgJGlxLCAkcHJlcwoqLwoKdmFyIGJ1aWxkSXE7CgpidWlsZElxID0gZnVuY3Rpb24odHlwZSwgamlkLCB2Q2FyZEVsKSB7CiAgdmFyIGlxOwogIGlxID0gJGlxKGppZCA/IHsKICAgIHR5cGU6IHR5cGUsCiAgICB0bzogamlkCiAgfSA6IHsKICAgIHR5cGU6IHR5cGUKICB9KTsKICBpcS5jKCJ2Q2FyZCIsIHsKICAgIHhtbG5zOiBTdHJvcGhlLk5TLlZDQVJECiAgfSk7CiAgaWYgKHZDYXJkRWwpIHsKICAgIGlxLmNub2RlKHZDYXJkRWwpOwogIH0KICByZXR1cm4gaXE7Cn07CgpTdHJvcGhlLmFkZENvbm5lY3Rpb25QbHVnaW4oJ3ZjYXJkJywgewogIF9jb25uZWN0aW9uOiBudWxsLAogIGluaXQ6IGZ1bmN0aW9uKGNvbm4pIHsKICAgIHRoaXMuX2Nvbm5lY3Rpb24gPSBjb25uOwogICAgcmV0dXJuIFN0cm9waGUuYWRkTmFtZXNwYWNlKCdWQ0FSRCcsICd2Y2FyZC10ZW1wJyk7CiAgfSwKICAvKkZ1bmN0aW9uCiAgICBSZXRyaWV2ZSBhIHZDYXJkIGZvciBhIEpJRC9FbnRpdHkKICAgIFBhcmFtZXRlcnM6CiAgICAoRnVuY3Rpb24pIGhhbmRsZXJfY2IgLSBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gdXNlZCB0byBoYW5kbGUgdGhlIHJlcXVlc3QuCiAgICAoU3RyaW5nKSBqaWQgLSBvcHRpb25hbCAtIFRoZSBuYW1lIG9mIHRoZSBlbnRpdHkgdG8gcmVxdWVzdCB0aGUgdkNhcmQKICAgICAgIElmIG5vIGppZCBpcyBnaXZlbiwgdGhpcyBmdW5jdGlvbiByZXRyaWV2ZXMgdGhlIGN1cnJlbnQgdXNlcidzIHZjYXJkLgogICovCgogIGdldDogZnVuY3Rpb24oaGFuZGxlcl9jYiwgamlkLCBlcnJvcl9jYikgewogICAgdmFyIGlxOwogICAgaXEgPSBidWlsZElxKCJnZXQiLCBqaWQpOwogICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZElRKGlxLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgfSwKICAvKiBGdW5jdGlvbgogICAgICBTZXQgYW4gZW50aXR5J3MgdkNhcmQuCiAgKi8KCiAgc2V0OiBmdW5jdGlvbihoYW5kbGVyX2NiLCB2Q2FyZEVsLCBqaWQsIGVycm9yX2NiKSB7CiAgICB2YXIgaXE7CiAgICBpcSA9IGJ1aWxkSXEoInNldCIsIGppZCwgdkNhcmRFbCk7CiAgICByZXR1cm4gdGhpcy5fY29ubmVjdGlvbi5zZW5kSVEoaXEsIGhhbmRsZXJfY2IsIGVycm9yX3JiKTsKICB9Cn0pOwoKZGVmaW5lKCJzdHJvcGhlLnZjYXJkIiwgWyJzdHJvcGhlIl0sIGZ1bmN0aW9uKCl7fSk7CgovKgogIENvcHlyaWdodCAyMDEwLCBGcmFuw6dvaXMgZGUgTWV0eiA8ZnJhbmNvaXNAMm1ldHouZnI+CiovCgovKioKICogRGlzY28gU3Ryb3BoZSBQbHVnaW4KICogSW1wbGVtZW50IGh0dHA6Ly94bXBwLm9yZy9leHRlbnNpb25zL3hlcC0wMDMwLmh0bWwKICogVE9ETzogbWFuYWdlIG5vZGUgaGllcmFyY2hpZXMsIGFuZCBub2RlIG9uIGluZm8gcmVxdWVzdAogKi8KU3Ryb3BoZS5hZGRDb25uZWN0aW9uUGx1Z2luKCdkaXNjbycsCnsKICAgIF9jb25uZWN0aW9uOiBudWxsLAogICAgX2lkZW50aXRpZXMgOiBbXSwKICAgIF9mZWF0dXJlcyA6IFtdLAogICAgX2l0ZW1zIDogW10sCiAgICAvKiogRnVuY3Rpb246IGluaXQKICAgICAqIFBsdWdpbiBpbml0CiAgICAgKgogICAgICogUGFyYW1ldGVyczoKICAgICAqICAgKFN0cm9waGUuQ29ubmVjdGlvbikgY29ubiAtIFN0cm9waGUgY29ubmVjdGlvbgogICAgICovCiAgICBpbml0OiBmdW5jdGlvbihjb25uKQogICAgewogICAgdGhpcy5fY29ubmVjdGlvbiA9IGNvbm47CiAgICAgICAgdGhpcy5faWRlbnRpdGllcyA9IFtdOwogICAgICAgIHRoaXMuX2ZlYXR1cmVzICAgPSBbXTsKICAgICAgICB0aGlzLl9pdGVtcyAgICAgID0gW107CiAgICAgICAgLy8gZGlzY28gaW5mbwogICAgICAgIGNvbm4uYWRkSGFuZGxlcih0aGlzLl9vbkRpc2NvSW5mby5iaW5kKHRoaXMpLCBTdHJvcGhlLk5TLkRJU0NPX0lORk8sICdpcScsICdnZXQnLCBudWxsLCBudWxsKTsKICAgICAgICAvLyBkaXNjbyBpdGVtcwogICAgICAgIGNvbm4uYWRkSGFuZGxlcih0aGlzLl9vbkRpc2NvSXRlbXMuYmluZCh0aGlzKSwgU3Ryb3BoZS5OUy5ESVNDT19JVEVNUywgJ2lxJywgJ2dldCcsIG51bGwsIG51bGwpOwogICAgfSwKICAgIC8qKiBGdW5jdGlvbjogYWRkSWRlbnRpdHkKICAgICAqIFNlZSBodHRwOi8veG1wcC5vcmcvcmVnaXN0cmFyL2Rpc2NvLWNhdGVnb3JpZXMuaHRtbAogICAgICogUGFyYW1ldGVyczoKICAgICAqICAgKFN0cmluZykgY2F0ZWdvcnkgLSBjYXRlZ29yeSBvZiBpZGVudGl0eSAobGlrZSBjbGllbnQsIGF1dG9tYXRpb24sIGV0YyAuLi4pCiAgICAgKiAgIChTdHJpbmcpIHR5cGUgLSB0eXBlIG9mIGlkZW50aXR5IChsaWtlIHBjLCB3ZWIsIGJvdCAsIGV0YyAuLi4pCiAgICAgKiAgIChTdHJpbmcpIG5hbWUgLSBuYW1lIG9mIGlkZW50aXR5IGluIG5hdHVyYWwgbGFuZ3VhZ2UKICAgICAqICAgKFN0cmluZykgbGFuZyAtIGxhbmcgb2YgbmFtZSBwYXJhbWV0ZXIKICAgICAqCiAgICAgKiBSZXR1cm5zOgogICAgICogICBCb29sZWFuCiAgICAgKi8KICAgIGFkZElkZW50aXR5OiBmdW5jdGlvbihjYXRlZ29yeSwgdHlwZSwgbmFtZSwgbGFuZykKICAgIHsKICAgICAgICBmb3IgKHZhciBpPTA7IGk8dGhpcy5faWRlbnRpdGllcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl9pZGVudGl0aWVzW2ldLmNhdGVnb3J5ID09IGNhdGVnb3J5ICYmCiAgICAgICAgICAgICAgICB0aGlzLl9pZGVudGl0aWVzW2ldLnR5cGUgPT0gdHlwZSAmJgogICAgICAgICAgICAgICAgdGhpcy5faWRlbnRpdGllc1tpXS5uYW1lID09IG5hbWUgJiYKICAgICAgICAgICAgICAgIHRoaXMuX2lkZW50aXRpZXNbaV0ubGFuZyA9PSBsYW5nKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5faWRlbnRpdGllcy5wdXNoKHtjYXRlZ29yeTogY2F0ZWdvcnksIHR5cGU6IHR5cGUsIG5hbWU6IG5hbWUsIGxhbmc6IGxhbmd9KTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCiAgICAvKiogRnVuY3Rpb246IGFkZEZlYXR1cmUKICAgICAqCiAgICAgKiBQYXJhbWV0ZXJzOgogICAgICogICAoU3RyaW5nKSB2YXJfbmFtZSAtIGZlYXR1cmUgbmFtZSAobGlrZSBqYWJiZXI6aXE6dmVyc2lvbikKICAgICAqCiAgICAgKiBSZXR1cm5zOgogICAgICogICBib29sZWFuCiAgICAgKi8KICAgIGFkZEZlYXR1cmU6IGZ1bmN0aW9uKHZhcl9uYW1lKQogICAgewogICAgICAgIGZvciAodmFyIGk9MDsgaTx0aGlzLl9mZWF0dXJlcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgICBpZiAodGhpcy5fZmVhdHVyZXNbaV0gPT0gdmFyX25hbWUpCiAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICB0aGlzLl9mZWF0dXJlcy5wdXNoKHZhcl9uYW1lKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCiAgICAvKiogRnVuY3Rpb246IHJlbW92ZUZlYXR1cmUKICAgICAqCiAgICAgKiBQYXJhbWV0ZXJzOgogICAgICogICAoU3RyaW5nKSB2YXJfbmFtZSAtIGZlYXR1cmUgbmFtZSAobGlrZSBqYWJiZXI6aXE6dmVyc2lvbikKICAgICAqCiAgICAgKiBSZXR1cm5zOgogICAgICogICBib29sZWFuCiAgICAgKi8KICAgIHJlbW92ZUZlYXR1cmU6IGZ1bmN0aW9uKHZhcl9uYW1lKQogICAgewogICAgICAgIGZvciAodmFyIGk9MDsgaTx0aGlzLl9mZWF0dXJlcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgICBpZiAodGhpcy5fZmVhdHVyZXNbaV0gPT09IHZhcl9uYW1lKXsKICAgICAgICAgICAgICAgICB0aGlzLl9mZWF0dXJlcy5zcGxpY2UoaSwxKQogICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAogICAgLyoqIEZ1bmN0aW9uOiBhZGRJdGVtCiAgICAgKgogICAgICogUGFyYW1ldGVyczoKICAgICAqICAgKFN0cmluZykgamlkCiAgICAgKiAgIChTdHJpbmcpIG5hbWUKICAgICAqICAgKFN0cmluZykgbm9kZQogICAgICogICAoRnVuY3Rpb24pIGNhbGxfYmFjawogICAgICoKICAgICAqIFJldHVybnM6CiAgICAgKiAgIGJvb2xlYW4KICAgICAqLwogICAgYWRkSXRlbTogZnVuY3Rpb24oamlkLCBuYW1lLCBub2RlLCBjYWxsX2JhY2spCiAgICB7CiAgICAgICAgaWYgKG5vZGUgJiYgIWNhbGxfYmFjaykKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIHRoaXMuX2l0ZW1zLnB1c2goe2ppZDogamlkLCBuYW1lOiBuYW1lLCBub2RlOiBub2RlLCBjYWxsX2JhY2s6IGNhbGxfYmFja30pOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAgIC8qKiBGdW5jdGlvbjogaW5mbwogICAgICogSW5mbyBxdWVyeQogICAgICoKICAgICAqIFBhcmFtZXRlcnM6CiAgICAgKiAgIChGdW5jdGlvbikgY2FsbF9iYWNrCiAgICAgKiAgIChTdHJpbmcpIGppZAogICAgICogICAoU3RyaW5nKSBub2RlCiAgICAgKi8KICAgIGluZm86IGZ1bmN0aW9uKGppZCwgbm9kZSwgc3VjY2VzcywgZXJyb3IsIHRpbWVvdXQpCiAgICB7CiAgICAgICAgdmFyIGF0dHJzID0ge3htbG5zOiBTdHJvcGhlLk5TLkRJU0NPX0lORk99OwogICAgICAgIGlmIChub2RlKQogICAgICAgICAgICBhdHRycy5ub2RlID0gbm9kZTsKCiAgICAgICAgdmFyIGluZm8gPSAkaXEoe2Zyb206dGhpcy5fY29ubmVjdGlvbi5qaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICB0bzpqaWQsIHR5cGU6J2dldCd9KS5jKCdxdWVyeScsIGF0dHJzKTsKICAgICAgICB0aGlzLl9jb25uZWN0aW9uLnNlbmRJUShpbmZvLCBzdWNjZXNzLCBlcnJvciwgdGltZW91dCk7CiAgICB9LAogICAgLyoqIEZ1bmN0aW9uOiBpdGVtcwogICAgICogSXRlbXMgcXVlcnkKICAgICAqCiAgICAgKiBQYXJhbWV0ZXJzOgogICAgICogICAoRnVuY3Rpb24pIGNhbGxfYmFjawogICAgICogICAoU3RyaW5nKSBqaWQKICAgICAqICAgKFN0cmluZykgbm9kZQogICAgICovCiAgICBpdGVtczogZnVuY3Rpb24oamlkLCBub2RlLCBzdWNjZXNzLCBlcnJvciwgdGltZW91dCkKICAgIHsKICAgICAgICB2YXIgYXR0cnMgPSB7eG1sbnM6IFN0cm9waGUuTlMuRElTQ09fSVRFTVN9OwogICAgICAgIGlmIChub2RlKQogICAgICAgICAgICBhdHRycy5ub2RlID0gbm9kZTsKCiAgICAgICAgdmFyIGl0ZW1zID0gJGlxKHtmcm9tOnRoaXMuX2Nvbm5lY3Rpb24uamlkLAogICAgICAgICAgICAgICAgICAgICAgICAgdG86amlkLCB0eXBlOidnZXQnfSkuYygncXVlcnknLCBhdHRycyk7CiAgICAgICAgdGhpcy5fY29ubmVjdGlvbi5zZW5kSVEoaXRlbXMsIHN1Y2Nlc3MsIGVycm9yLCB0aW1lb3V0KTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX2J1aWxkSVFSZXN1bHQKICAgICAqLwogICAgX2J1aWxkSVFSZXN1bHQ6IGZ1bmN0aW9uKHN0YW56YSwgcXVlcnlfYXR0cnMpCiAgICB7CiAgICAgICAgdmFyIGlkICAgPSAgc3RhbnphLmdldEF0dHJpYnV0ZSgnaWQnKTsKICAgICAgICB2YXIgZnJvbSA9IHN0YW56YS5nZXRBdHRyaWJ1dGUoJ2Zyb20nKTsKICAgICAgICB2YXIgaXFyZXN1bHQgPSAkaXEoe3R5cGU6ICdyZXN1bHQnLCBpZDogaWR9KTsKCiAgICAgICAgaWYgKGZyb20gIT09IG51bGwpIHsKICAgICAgICAgICAgaXFyZXN1bHQuYXR0cnMoe3RvOiBmcm9tfSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gaXFyZXN1bHQuYygncXVlcnknLCBxdWVyeV9hdHRycyk7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9vbkRpc2NvSW5mbwogICAgICogQ2FsbGVkIHdoZW4gcmVjZWl2ZSBpbmZvIHJlcXVlc3QKICAgICAqLwogICAgX29uRGlzY29JbmZvOiBmdW5jdGlvbihzdGFuemEpCiAgICB7CiAgICAgICAgdmFyIG5vZGUgPSBzdGFuemEuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3F1ZXJ5JylbMF0uZ2V0QXR0cmlidXRlKCdub2RlJyk7CiAgICAgICAgdmFyIGF0dHJzID0ge3htbG5zOiBTdHJvcGhlLk5TLkRJU0NPX0lORk99OwogICAgICAgIGlmIChub2RlKQogICAgICAgIHsKICAgICAgICAgICAgYXR0cnMubm9kZSA9IG5vZGU7CiAgICAgICAgfQogICAgICAgIHZhciBpcXJlc3VsdCA9IHRoaXMuX2J1aWxkSVFSZXN1bHQoc3RhbnphLCBhdHRycyk7CiAgICAgICAgZm9yICh2YXIgaT0wOyBpPHRoaXMuX2lkZW50aXRpZXMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB2YXIgYXR0cnMgPSB7Y2F0ZWdvcnk6IHRoaXMuX2lkZW50aXRpZXNbaV0uY2F0ZWdvcnksCiAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlICAgIDogdGhpcy5faWRlbnRpdGllc1tpXS50eXBlfTsKICAgICAgICAgICAgaWYgKHRoaXMuX2lkZW50aXRpZXNbaV0ubmFtZSkKICAgICAgICAgICAgICAgIGF0dHJzLm5hbWUgPSB0aGlzLl9pZGVudGl0aWVzW2ldLm5hbWU7CiAgICAgICAgICAgIGlmICh0aGlzLl9pZGVudGl0aWVzW2ldLmxhbmcpCiAgICAgICAgICAgICAgICBhdHRyc1sneG1sOmxhbmcnXSA9IHRoaXMuX2lkZW50aXRpZXNbaV0ubGFuZzsKICAgICAgICAgICAgaXFyZXN1bHQuYygnaWRlbnRpdHknLCBhdHRycykudXAoKTsKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaT0wOyBpPHRoaXMuX2ZlYXR1cmVzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaXFyZXN1bHQuYygnZmVhdHVyZScsIHsndmFyJzp0aGlzLl9mZWF0dXJlc1tpXX0pLnVwKCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZChpcXJlc3VsdC50cmVlKCkpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9vbkRpc2NvSXRlbXMKICAgICAqIENhbGxlZCB3aGVuIHJlY2VpdmUgaXRlbXMgcmVxdWVzdAogICAgICovCiAgICBfb25EaXNjb0l0ZW1zOiBmdW5jdGlvbihzdGFuemEpCiAgICB7CiAgICAgICAgdmFyIHF1ZXJ5X2F0dHJzID0ge3htbG5zOiBTdHJvcGhlLk5TLkRJU0NPX0lURU1TfTsKICAgICAgICB2YXIgbm9kZSA9IHN0YW56YS5nZXRFbGVtZW50c0J5VGFnTmFtZSgncXVlcnknKVswXS5nZXRBdHRyaWJ1dGUoJ25vZGUnKTsKICAgICAgICBpZiAobm9kZSkKICAgICAgICB7CiAgICAgICAgICAgIHF1ZXJ5X2F0dHJzLm5vZGUgPSBub2RlOwogICAgICAgICAgICB2YXIgaXRlbXMgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9pdGVtcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2l0ZW1zW2ldLm5vZGUgPT0gbm9kZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpdGVtcyA9IHRoaXMuX2l0ZW1zW2ldLmNhbGxfYmFjayhzdGFuemEpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHZhciBpdGVtcyA9IHRoaXMuX2l0ZW1zOwogICAgICAgIH0KICAgICAgICB2YXIgaXFyZXN1bHQgPSB0aGlzLl9idWlsZElRUmVzdWx0KHN0YW56YSwgcXVlcnlfYXR0cnMpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB2YXIgYXR0cnMgPSB7amlkOiAgaXRlbXNbaV0uamlkfTsKICAgICAgICAgICAgaWYgKGl0ZW1zW2ldLm5hbWUpCiAgICAgICAgICAgICAgICBhdHRycy5uYW1lID0gaXRlbXNbaV0ubmFtZTsKICAgICAgICAgICAgaWYgKGl0ZW1zW2ldLm5vZGUpCiAgICAgICAgICAgICAgICBhdHRycy5ub2RlID0gaXRlbXNbaV0ubm9kZTsKICAgICAgICAgICAgaXFyZXN1bHQuYygnaXRlbScsIGF0dHJzKS51cCgpOwogICAgICAgIH0KICAgICAgICB0aGlzLl9jb25uZWN0aW9uLnNlbmQoaXFyZXN1bHQudHJlZSgpKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KfSk7CgpkZWZpbmUoInN0cm9waGUuZGlzY28iLCBbInN0cm9waGUiXSwgZnVuY3Rpb24oKXt9KTsKCmRlZmluZSgiY29udmVyc2UtZGVwZW5kZW5jaWVzIiwgWwogICAgImpxdWVyeSIsCiAgICAidXRpbHMiLAogICAgIm1vbWVudCIsCiAgICAibG9jYWxlcyIsCiAgICAiYmFja2JvbmUuYnJvd3NlclN0b3JhZ2UiLAogICAgImJhY2tib25lLm92ZXJ2aWV3IiwKICAgICJqcXVlcnkuYnJvd3NlciIsCiAgICAidHlwZWFoZWFkIiwKICAgICJzdHJvcGhlIiwKICAgICJzdHJvcGhlLm11YyIsCiAgICAic3Ryb3BoZS5yb3N0ZXIiLAogICAgInN0cm9waGUudmNhcmQiLAogICAgInN0cm9waGUuZGlzY28iCl0sIGZ1bmN0aW9uKCQsIHV0aWxzLCBtb21lbnQpIHsKICAgIHJldHVybiB7CiAgICAgICAgJ2pRdWVyeSc6ICQsCiAgICAgICAgJ290cic6IHVuZGVmaW5lZCwKICAgICAgICAnbW9tZW50JzogbW9tZW50LAogICAgICAgICd1dGlscyc6IHV0aWxzCiAgICB9Owp9KTsKCi8qKgogKiBAbGljZW5zZSBSZXF1aXJlSlMgdGV4dCAyLjAuMTIgQ29weXJpZ2h0IChjKSAyMDEwLTIwMTQsIFRoZSBEb2pvIEZvdW5kYXRpb24gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICogQXZhaWxhYmxlIHZpYSB0aGUgTUlUIG9yIG5ldyBCU0QgbGljZW5zZS4KICogc2VlOiBodHRwOi8vZ2l0aHViLmNvbS9yZXF1aXJlanMvdGV4dCBmb3IgZGV0YWlscwogKi8KLypqc2xpbnQgcmVnZXhwOiB0cnVlICovCi8qZ2xvYmFsIHJlcXVpcmUsIFhNTEh0dHBSZXF1ZXN0LCBBY3RpdmVYT2JqZWN0LAogIGRlZmluZSwgd2luZG93LCBwcm9jZXNzLCBQYWNrYWdlcywKICBqYXZhLCBsb2NhdGlvbiwgQ29tcG9uZW50cywgRmlsZVV0aWxzICovCgpkZWZpbmUoJ3RleHQnLFsnbW9kdWxlJ10sIGZ1bmN0aW9uIChtb2R1bGUpIHsKICAgIAoKICAgIHZhciB0ZXh0LCBmcywgQ2MsIENpLCB4cGNJc1dpbmRvd3MsCiAgICAgICAgcHJvZ0lkcyA9IFsnTXN4bWwyLlhNTEhUVFAnLCAnTWljcm9zb2Z0LlhNTEhUVFAnLCAnTXN4bWwyLlhNTEhUVFAuNC4wJ10sCiAgICAgICAgeG1sUmVnRXhwID0gL15ccyo8XD94bWwoXHMpK3ZlcnNpb249W1wnXCJdKFxkKSouKFxkKSpbXCdcIl0oXHMpKlw/Pi9pbSwKICAgICAgICBib2R5UmVnRXhwID0gLzxib2R5W14+XSo+XHMqKFtcc1xTXSspXHMqPFwvYm9keT4vaW0sCiAgICAgICAgaGFzTG9jYXRpb24gPSB0eXBlb2YgbG9jYXRpb24gIT09ICd1bmRlZmluZWQnICYmIGxvY2F0aW9uLmhyZWYsCiAgICAgICAgZGVmYXVsdFByb3RvY29sID0gaGFzTG9jYXRpb24gJiYgbG9jYXRpb24ucHJvdG9jb2wgJiYgbG9jYXRpb24ucHJvdG9jb2wucmVwbGFjZSgvXDovLCAnJyksCiAgICAgICAgZGVmYXVsdEhvc3ROYW1lID0gaGFzTG9jYXRpb24gJiYgbG9jYXRpb24uaG9zdG5hbWUsCiAgICAgICAgZGVmYXVsdFBvcnQgPSBoYXNMb2NhdGlvbiAmJiAobG9jYXRpb24ucG9ydCB8fCB1bmRlZmluZWQpLAogICAgICAgIGJ1aWxkTWFwID0ge30sCiAgICAgICAgbWFzdGVyQ29uZmlnID0gKG1vZHVsZS5jb25maWcgJiYgbW9kdWxlLmNvbmZpZygpKSB8fCB7fTsKCiAgICB0ZXh0ID0gewogICAgICAgIHZlcnNpb246ICcyLjAuMTInLAoKICAgICAgICBzdHJpcDogZnVuY3Rpb24gKGNvbnRlbnQpIHsKICAgICAgICAgICAgLy9TdHJpcHMgPD94bWwgLi4uPz4gZGVjbGFyYXRpb25zIHNvIHRoYXQgZXh0ZXJuYWwgU1ZHIGFuZCBYTUwKICAgICAgICAgICAgLy9kb2N1bWVudHMgY2FuIGJlIGFkZGVkIHRvIGEgZG9jdW1lbnQgd2l0aG91dCB3b3JyeS4gQWxzbywgaWYgdGhlIHN0cmluZwogICAgICAgICAgICAvL2lzIGFuIEhUTUwgZG9jdW1lbnQsIG9ubHkgdGhlIHBhcnQgaW5zaWRlIHRoZSBib2R5IHRhZyBpcyByZXR1cm5lZC4KICAgICAgICAgICAgaWYgKGNvbnRlbnQpIHsKICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBjb250ZW50LnJlcGxhY2UoeG1sUmVnRXhwLCAiIik7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2hlcyA9IGNvbnRlbnQubWF0Y2goYm9keVJlZ0V4cCk7CiAgICAgICAgICAgICAgICBpZiAobWF0Y2hlcykgewogICAgICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBtYXRjaGVzWzFdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29udGVudCA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb250ZW50OwogICAgICAgIH0sCgogICAgICAgIGpzRXNjYXBlOiBmdW5jdGlvbiAoY29udGVudCkgewogICAgICAgICAgICByZXR1cm4gY29udGVudC5yZXBsYWNlKC8oWydcXF0pL2csICdcXCQxJykKICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9bXGZdL2csICJcXGYiKQogICAgICAgICAgICAgICAgLnJlcGxhY2UoL1tcYl0vZywgIlxcYiIpCiAgICAgICAgICAgICAgICAucmVwbGFjZSgvW1xuXS9nLCAiXFxuIikKICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9bXHRdL2csICJcXHQiKQogICAgICAgICAgICAgICAgLnJlcGxhY2UoL1tccl0vZywgIlxcciIpCiAgICAgICAgICAgICAgICAucmVwbGFjZSgvW1x1MjAyOF0vZywgIlxcdTIwMjgiKQogICAgICAgICAgICAgICAgLnJlcGxhY2UoL1tcdTIwMjldL2csICJcXHUyMDI5Iik7CiAgICAgICAgfSwKCiAgICAgICAgY3JlYXRlWGhyOiBtYXN0ZXJDb25maWcuY3JlYXRlWGhyIHx8IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgLy9Xb3VsZCBsb3ZlIHRvIGR1bXAgdGhlIEFjdGl2ZVggY3JhcCBpbiBoZXJlLiBOZWVkIElFIDYgdG8gZGllIGZpcnN0LgogICAgICAgICAgICB2YXIgeGhyLCBpLCBwcm9nSWQ7CiAgICAgICAgICAgIGlmICh0eXBlb2YgWE1MSHR0cFJlcXVlc3QgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIEFjdGl2ZVhPYmplY3QgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgMzsgaSArPSAxKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvZ0lkID0gcHJvZ0lkc1tpXTsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICB4aHIgPSBuZXcgQWN0aXZlWE9iamVjdChwcm9nSWQpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CgogICAgICAgICAgICAgICAgICAgIGlmICh4aHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvZ0lkcyA9IFtwcm9nSWRdOyAgLy8gc28gZmFzdGVyIG5leHQgdGltZQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB4aHI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUGFyc2VzIGEgcmVzb3VyY2UgbmFtZSBpbnRvIGl0cyBjb21wb25lbnQgcGFydHMuIFJlc291cmNlIG5hbWVzCiAgICAgICAgICogbG9vayBsaWtlOiBtb2R1bGUvbmFtZS5leHQhc3RyaXAsIHdoZXJlIHRoZSAhc3RyaXAgcGFydCBpcwogICAgICAgICAqIG9wdGlvbmFsLgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lIHRoZSByZXNvdXJjZSBuYW1lCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gd2l0aCBwcm9wZXJ0aWVzICJtb2R1bGVOYW1lIiwgImV4dCIgYW5kICJzdHJpcCIKICAgICAgICAgKiB3aGVyZSBzdHJpcCBpcyBhIGJvb2xlYW4uCiAgICAgICAgICovCiAgICAgICAgcGFyc2VOYW1lOiBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgbW9kTmFtZSwgZXh0LCB0ZW1wLAogICAgICAgICAgICAgICAgc3RyaXAgPSBmYWxzZSwKICAgICAgICAgICAgICAgIGluZGV4ID0gbmFtZS5pbmRleE9mKCIuIiksCiAgICAgICAgICAgICAgICBpc1JlbGF0aXZlID0gbmFtZS5pbmRleE9mKCcuLycpID09PSAwIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZS5pbmRleE9mKCcuLi8nKSA9PT0gMDsKCiAgICAgICAgICAgIGlmIChpbmRleCAhPT0gLTEgJiYgKCFpc1JlbGF0aXZlIHx8IGluZGV4ID4gMSkpIHsKICAgICAgICAgICAgICAgIG1vZE5hbWUgPSBuYW1lLnN1YnN0cmluZygwLCBpbmRleCk7CiAgICAgICAgICAgICAgICBleHQgPSBuYW1lLnN1YnN0cmluZyhpbmRleCArIDEsIG5hbWUubGVuZ3RoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG1vZE5hbWUgPSBuYW1lOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0ZW1wID0gZXh0IHx8IG1vZE5hbWU7CiAgICAgICAgICAgIGluZGV4ID0gdGVtcC5pbmRleE9mKCIhIik7CiAgICAgICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHsKICAgICAgICAgICAgICAgIC8vUHVsbCBvZmYgdGhlIHN0cmlwIGFyZy4KICAgICAgICAgICAgICAgIHN0cmlwID0gdGVtcC5zdWJzdHJpbmcoaW5kZXggKyAxKSA9PT0gInN0cmlwIjsKICAgICAgICAgICAgICAgIHRlbXAgPSB0ZW1wLnN1YnN0cmluZygwLCBpbmRleCk7CiAgICAgICAgICAgICAgICBpZiAoZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgZXh0ID0gdGVtcDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbW9kTmFtZSA9IHRlbXA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBtb2R1bGVOYW1lOiBtb2ROYW1lLAogICAgICAgICAgICAgICAgZXh0OiBleHQsCiAgICAgICAgICAgICAgICBzdHJpcDogc3RyaXAKICAgICAgICAgICAgfTsKICAgICAgICB9LAoKICAgICAgICB4ZFJlZ0V4cDogL14oKFx3KylcOik/XC9cLyhbXlwvXFxdKykvLAoKICAgICAgICAvKioKICAgICAgICAgKiBJcyBhbiBVUkwgb24gYW5vdGhlciBkb21haW4uIE9ubHkgd29ya3MgZm9yIGJyb3dzZXIgdXNlLCByZXR1cm5zCiAgICAgICAgICogZmFsc2UgaW4gbm9uLWJyb3dzZXIgZW52aXJvbm1lbnRzLiBPbmx5IHVzZWQgdG8ga25vdyBpZiBhbgogICAgICAgICAqIG9wdGltaXplZCAuanMgdmVyc2lvbiBvZiBhIHRleHQgcmVzb3VyY2Ugc2hvdWxkIGJlIGxvYWRlZAogICAgICAgICAqIGluc3RlYWQuCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHVybAogICAgICAgICAqIEByZXR1cm5zIEJvb2xlYW4KICAgICAgICAgKi8KICAgICAgICB1c2VYaHI6IGZ1bmN0aW9uICh1cmwsIHByb3RvY29sLCBob3N0bmFtZSwgcG9ydCkgewogICAgICAgICAgICB2YXIgdVByb3RvY29sLCB1SG9zdE5hbWUsIHVQb3J0LAogICAgICAgICAgICAgICAgbWF0Y2ggPSB0ZXh0LnhkUmVnRXhwLmV4ZWModXJsKTsKICAgICAgICAgICAgaWYgKCFtYXRjaCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdVByb3RvY29sID0gbWF0Y2hbMl07CiAgICAgICAgICAgIHVIb3N0TmFtZSA9IG1hdGNoWzNdOwoKICAgICAgICAgICAgdUhvc3ROYW1lID0gdUhvc3ROYW1lLnNwbGl0KCc6Jyk7CiAgICAgICAgICAgIHVQb3J0ID0gdUhvc3ROYW1lWzFdOwogICAgICAgICAgICB1SG9zdE5hbWUgPSB1SG9zdE5hbWVbMF07CgogICAgICAgICAgICByZXR1cm4gKCF1UHJvdG9jb2wgfHwgdVByb3RvY29sID09PSBwcm90b2NvbCkgJiYKICAgICAgICAgICAgICAgICAgICghdUhvc3ROYW1lIHx8IHVIb3N0TmFtZS50b0xvd2VyQ2FzZSgpID09PSBob3N0bmFtZS50b0xvd2VyQ2FzZSgpKSAmJgogICAgICAgICAgICAgICAgICAgKCghdVBvcnQgJiYgIXVIb3N0TmFtZSkgfHwgdVBvcnQgPT09IHBvcnQpOwogICAgICAgIH0sCgogICAgICAgIGZpbmlzaExvYWQ6IGZ1bmN0aW9uIChuYW1lLCBzdHJpcCwgY29udGVudCwgb25Mb2FkKSB7CiAgICAgICAgICAgIGNvbnRlbnQgPSBzdHJpcCA/IHRleHQuc3RyaXAoY29udGVudCkgOiBjb250ZW50OwogICAgICAgICAgICBpZiAobWFzdGVyQ29uZmlnLmlzQnVpbGQpIHsKICAgICAgICAgICAgICAgIGJ1aWxkTWFwW25hbWVdID0gY29udGVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICBvbkxvYWQoY29udGVudCk7CiAgICAgICAgfSwKCiAgICAgICAgbG9hZDogZnVuY3Rpb24gKG5hbWUsIHJlcSwgb25Mb2FkLCBjb25maWcpIHsKICAgICAgICAgICAgLy9OYW1lIGhhcyBmb3JtYXQ6IHNvbWUubW9kdWxlLmZpbGV4dCFzdHJpcAogICAgICAgICAgICAvL1RoZSBzdHJpcCBwYXJ0IGlzIG9wdGlvbmFsLgogICAgICAgICAgICAvL2lmIHN0cmlwIGlzIHByZXNlbnQsIHRoZW4gdGhhdCBtZWFucyBvbmx5IGdldCB0aGUgc3RyaW5nIGNvbnRlbnRzCiAgICAgICAgICAgIC8vaW5zaWRlIGEgYm9keSB0YWcgaW4gYW4gSFRNTCBzdHJpbmcuIEZvciBYTUwvU1ZHIGNvbnRlbnQgaXQgbWVhbnMKICAgICAgICAgICAgLy9yZW1vdmluZyB0aGUgPD94bWwgLi4uPz4gZGVjbGFyYXRpb25zIHNvIHRoZSBjb250ZW50IGNhbiBiZSBpbnNlcnRlZAogICAgICAgICAgICAvL2ludG8gdGhlIGN1cnJlbnQgZG9jIHdpdGhvdXQgcHJvYmxlbXMuCgogICAgICAgICAgICAvLyBEbyBub3QgYm90aGVyIHdpdGggdGhlIHdvcmsgaWYgYSBidWlsZCBhbmQgdGV4dCB3aWxsCiAgICAgICAgICAgIC8vIG5vdCBiZSBpbmxpbmVkLgogICAgICAgICAgICBpZiAoY29uZmlnICYmIGNvbmZpZy5pc0J1aWxkICYmICFjb25maWcuaW5saW5lVGV4dCkgewogICAgICAgICAgICAgICAgb25Mb2FkKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG1hc3RlckNvbmZpZy5pc0J1aWxkID0gY29uZmlnICYmIGNvbmZpZy5pc0J1aWxkOwoKICAgICAgICAgICAgdmFyIHBhcnNlZCA9IHRleHQucGFyc2VOYW1lKG5hbWUpLAogICAgICAgICAgICAgICAgbm9uU3RyaXBOYW1lID0gcGFyc2VkLm1vZHVsZU5hbWUgKwogICAgICAgICAgICAgICAgICAgIChwYXJzZWQuZXh0ID8gJy4nICsgcGFyc2VkLmV4dCA6ICcnKSwKICAgICAgICAgICAgICAgIHVybCA9IHJlcS50b1VybChub25TdHJpcE5hbWUpLAogICAgICAgICAgICAgICAgdXNlWGhyID0gKG1hc3RlckNvbmZpZy51c2VYaHIpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0LnVzZVhocjsKCiAgICAgICAgICAgIC8vIERvIG5vdCBsb2FkIGlmIGl0IGlzIGFuIGVtcHR5OiB1cmwKICAgICAgICAgICAgaWYgKHVybC5pbmRleE9mKCdlbXB0eTonKSA9PT0gMCkgewogICAgICAgICAgICAgICAgb25Mb2FkKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vTG9hZCB0aGUgdGV4dC4gVXNlIFhIUiBpZiBwb3NzaWJsZSBhbmQgaW4gYSBicm93c2VyLgogICAgICAgICAgICBpZiAoIWhhc0xvY2F0aW9uIHx8IHVzZVhocih1cmwsIGRlZmF1bHRQcm90b2NvbCwgZGVmYXVsdEhvc3ROYW1lLCBkZWZhdWx0UG9ydCkpIHsKICAgICAgICAgICAgICAgIHRleHQuZ2V0KHVybCwgZnVuY3Rpb24gKGNvbnRlbnQpIHsKICAgICAgICAgICAgICAgICAgICB0ZXh0LmZpbmlzaExvYWQobmFtZSwgcGFyc2VkLnN0cmlwLCBjb250ZW50LCBvbkxvYWQpOwogICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgICAgIGlmIChvbkxvYWQuZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb25Mb2FkLmVycm9yKGVycik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvL05lZWQgdG8gZmV0Y2ggdGhlIHJlc291cmNlIGFjcm9zcyBkb21haW5zLiBBc3N1bWUKICAgICAgICAgICAgICAgIC8vdGhlIHJlc291cmNlIGhhcyBiZWVuIG9wdGltaXplZCBpbnRvIGEgSlMgbW9kdWxlLiBGZXRjaAogICAgICAgICAgICAgICAgLy9ieSB0aGUgbW9kdWxlIG5hbWUgKyBleHRlbnNpb24sIGJ1dCBkbyBub3QgaW5jbHVkZSB0aGUKICAgICAgICAgICAgICAgIC8vIXN0cmlwIHBhcnQgdG8gYXZvaWQgZmlsZSBzeXN0ZW0gaXNzdWVzLgogICAgICAgICAgICAgICAgcmVxKFtub25TdHJpcE5hbWVdLCBmdW5jdGlvbiAoY29udGVudCkgewogICAgICAgICAgICAgICAgICAgIHRleHQuZmluaXNoTG9hZChwYXJzZWQubW9kdWxlTmFtZSArICcuJyArIHBhcnNlZC5leHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlZC5zdHJpcCwgY29udGVudCwgb25Mb2FkKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgd3JpdGU6IGZ1bmN0aW9uIChwbHVnaW5OYW1lLCBtb2R1bGVOYW1lLCB3cml0ZSwgY29uZmlnKSB7CiAgICAgICAgICAgIGlmIChidWlsZE1hcC5oYXNPd25Qcm9wZXJ0eShtb2R1bGVOYW1lKSkgewogICAgICAgICAgICAgICAgdmFyIGNvbnRlbnQgPSB0ZXh0LmpzRXNjYXBlKGJ1aWxkTWFwW21vZHVsZU5hbWVdKTsKICAgICAgICAgICAgICAgIHdyaXRlLmFzTW9kdWxlKHBsdWdpbk5hbWUgKyAiISIgKyBtb2R1bGVOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlZmluZShmdW5jdGlvbiAoKSB7IHJldHVybiAnIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiJzt9KTtcbiIpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgd3JpdGVGaWxlOiBmdW5jdGlvbiAocGx1Z2luTmFtZSwgbW9kdWxlTmFtZSwgcmVxLCB3cml0ZSwgY29uZmlnKSB7CiAgICAgICAgICAgIHZhciBwYXJzZWQgPSB0ZXh0LnBhcnNlTmFtZShtb2R1bGVOYW1lKSwKICAgICAgICAgICAgICAgIGV4dFBhcnQgPSBwYXJzZWQuZXh0ID8gJy4nICsgcGFyc2VkLmV4dCA6ICcnLAogICAgICAgICAgICAgICAgbm9uU3RyaXBOYW1lID0gcGFyc2VkLm1vZHVsZU5hbWUgKyBleHRQYXJ0LAogICAgICAgICAgICAgICAgLy9Vc2UgYSAnLmpzJyBmaWxlIG5hbWUgc28gdGhhdCBpdCBpbmRpY2F0ZXMgaXQgaXMgYQogICAgICAgICAgICAgICAgLy9zY3JpcHQgdGhhdCBjYW4gYmUgbG9hZGVkIGFjcm9zcyBkb21haW5zLgogICAgICAgICAgICAgICAgZmlsZU5hbWUgPSByZXEudG9VcmwocGFyc2VkLm1vZHVsZU5hbWUgKyBleHRQYXJ0KSArICcuanMnOwoKICAgICAgICAgICAgLy9MZXZlcmFnZSBvd24gbG9hZCgpIG1ldGhvZCB0byBsb2FkIHBsdWdpbiB2YWx1ZSwgYnV0IG9ubHkKICAgICAgICAgICAgLy93cml0ZSBvdXQgdmFsdWVzIHRoYXQgZG8gbm90IGhhdmUgdGhlIHN0cmlwIGFyZ3VtZW50LAogICAgICAgICAgICAvL3RvIGF2b2lkIGFueSBwb3RlbnRpYWwgaXNzdWVzIHdpdGggISBpbiBmaWxlIG5hbWVzLgogICAgICAgICAgICB0ZXh0LmxvYWQobm9uU3RyaXBOYW1lLCByZXEsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgLy9Vc2Ugb3duIHdyaXRlKCkgbWV0aG9kIHRvIGNvbnN0cnVjdCBmdWxsIG1vZHVsZSB2YWx1ZS4KICAgICAgICAgICAgICAgIC8vQnV0IG5lZWQgdG8gY3JlYXRlIHNoZWxsIHRoYXQgdHJhbnNsYXRlcyB3cml0ZUZpbGUncwogICAgICAgICAgICAgICAgLy93cml0ZSgpIHRvIHRoZSByaWdodCBpbnRlcmZhY2UuCiAgICAgICAgICAgICAgICB2YXIgdGV4dFdyaXRlID0gZnVuY3Rpb24gKGNvbnRlbnRzKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdyaXRlKGZpbGVOYW1lLCBjb250ZW50cyk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgdGV4dFdyaXRlLmFzTW9kdWxlID0gZnVuY3Rpb24gKG1vZHVsZU5hbWUsIGNvbnRlbnRzKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdyaXRlLmFzTW9kdWxlKG1vZHVsZU5hbWUsIGZpbGVOYW1lLCBjb250ZW50cyk7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIHRleHQud3JpdGUocGx1Z2luTmFtZSwgbm9uU3RyaXBOYW1lLCB0ZXh0V3JpdGUsIGNvbmZpZyk7CiAgICAgICAgICAgIH0sIGNvbmZpZyk7CiAgICAgICAgfQogICAgfTsKCiAgICBpZiAobWFzdGVyQ29uZmlnLmVudiA9PT0gJ25vZGUnIHx8ICghbWFzdGVyQ29uZmlnLmVudiAmJgogICAgICAgICAgICB0eXBlb2YgcHJvY2VzcyAhPT0gInVuZGVmaW5lZCIgJiYKICAgICAgICAgICAgcHJvY2Vzcy52ZXJzaW9ucyAmJgogICAgICAgICAgICAhIXByb2Nlc3MudmVyc2lvbnMubm9kZSAmJgogICAgICAgICAgICAhcHJvY2Vzcy52ZXJzaW9uc1snbm9kZS13ZWJraXQnXSkpIHsKICAgICAgICAvL1VzaW5nIHNwZWNpYWwgcmVxdWlyZS5ub2RlUmVxdWlyZSwgc29tZXRoaW5nIGFkZGVkIGJ5IHIuanMuCiAgICAgICAgZnMgPSByZXF1aXJlLm5vZGVSZXF1aXJlKCdmcycpOwoKICAgICAgICB0ZXh0LmdldCA9IGZ1bmN0aW9uICh1cmwsIGNhbGxiYWNrLCBlcnJiYWNrKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB2YXIgZmlsZSA9IGZzLnJlYWRGaWxlU3luYyh1cmwsICd1dGY4Jyk7CiAgICAgICAgICAgICAgICAvL1JlbW92ZSBCT00gKEJ5dGUgTWFyayBPcmRlcikgZnJvbSB1dGY4IGZpbGVzIGlmIGl0IGlzIHRoZXJlLgogICAgICAgICAgICAgICAgaWYgKGZpbGUuaW5kZXhPZignXHVGRUZGJykgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBmaWxlID0gZmlsZS5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYWxsYmFjayhmaWxlKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgaWYgKGVycmJhY2spIHsKICAgICAgICAgICAgICAgICAgICBlcnJiYWNrKGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0gZWxzZSBpZiAobWFzdGVyQ29uZmlnLmVudiA9PT0gJ3hocicgfHwgKCFtYXN0ZXJDb25maWcuZW52ICYmCiAgICAgICAgICAgIHRleHQuY3JlYXRlWGhyKCkpKSB7CiAgICAgICAgdGV4dC5nZXQgPSBmdW5jdGlvbiAodXJsLCBjYWxsYmFjaywgZXJyYmFjaywgaGVhZGVycykgewogICAgICAgICAgICB2YXIgeGhyID0gdGV4dC5jcmVhdGVYaHIoKSwgaGVhZGVyOwogICAgICAgICAgICB4aHIub3BlbignR0VUJywgdXJsLCB0cnVlKTsKCiAgICAgICAgICAgIC8vQWxsb3cgcGx1Z2lucyBkaXJlY3QgYWNjZXNzIHRvIHhociBoZWFkZXJzCiAgICAgICAgICAgIGlmIChoZWFkZXJzKSB7CiAgICAgICAgICAgICAgICBmb3IgKGhlYWRlciBpbiBoZWFkZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhlYWRlcnMuaGFzT3duUHJvcGVydHkoaGVhZGVyKSkgewogICAgICAgICAgICAgICAgICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcihoZWFkZXIudG9Mb3dlckNhc2UoKSwgaGVhZGVyc1toZWFkZXJdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vQWxsb3cgb3ZlcnJpZGVzIHNwZWNpZmllZCBpbiBjb25maWcKICAgICAgICAgICAgaWYgKG1hc3RlckNvbmZpZy5vblhocikgewogICAgICAgICAgICAgICAgbWFzdGVyQ29uZmlnLm9uWGhyKHhociwgdXJsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uIChldnQpIHsKICAgICAgICAgICAgICAgIHZhciBzdGF0dXMsIGVycjsKICAgICAgICAgICAgICAgIC8vRG8gbm90IGV4cGxpY2l0bHkgaGFuZGxlIGVycm9ycywgdGhvc2Ugc2hvdWxkIGJlCiAgICAgICAgICAgICAgICAvL3Zpc2libGUgdmlhIGNvbnNvbGUgb3V0cHV0IGluIHRoZSBicm93c2VyLgogICAgICAgICAgICAgICAgaWYgKHhoci5yZWFkeVN0YXRlID09PSA0KSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdHVzID0geGhyLnN0YXR1cyB8fCAwOwogICAgICAgICAgICAgICAgICAgIGlmIChzdGF0dXMgPiAzOTkgJiYgc3RhdHVzIDwgNjAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vQW4gaHR0cCA0eHggb3IgNXh4IGVycm9yLiBTaWduYWwgYW4gZXJyb3IuCiAgICAgICAgICAgICAgICAgICAgICAgIGVyciA9IG5ldyBFcnJvcih1cmwgKyAnIEhUVFAgc3RhdHVzOiAnICsgc3RhdHVzKTsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyLnhociA9IHhocjsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycmJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycmJhY2soZXJyKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHhoci5yZXNwb25zZVRleHQpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKG1hc3RlckNvbmZpZy5vblhockNvbXBsZXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hc3RlckNvbmZpZy5vblhockNvbXBsZXRlKHhociwgdXJsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHhoci5zZW5kKG51bGwpOwogICAgICAgIH07CiAgICB9IGVsc2UgaWYgKG1hc3RlckNvbmZpZy5lbnYgPT09ICdyaGlubycgfHwgKCFtYXN0ZXJDb25maWcuZW52ICYmCiAgICAgICAgICAgIHR5cGVvZiBQYWNrYWdlcyAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIGphdmEgIT09ICd1bmRlZmluZWQnKSkgewogICAgICAgIC8vV2h5IEphdmEsIHdoeSBpcyB0aGlzIHNvIGF3a3dhcmQ/CiAgICAgICAgdGV4dC5nZXQgPSBmdW5jdGlvbiAodXJsLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgc3RyaW5nQnVmZmVyLCBsaW5lLAogICAgICAgICAgICAgICAgZW5jb2RpbmcgPSAidXRmLTgiLAogICAgICAgICAgICAgICAgZmlsZSA9IG5ldyBqYXZhLmlvLkZpbGUodXJsKSwKICAgICAgICAgICAgICAgIGxpbmVTZXBhcmF0b3IgPSBqYXZhLmxhbmcuU3lzdGVtLmdldFByb3BlcnR5KCJsaW5lLnNlcGFyYXRvciIpLAogICAgICAgICAgICAgICAgaW5wdXQgPSBuZXcgamF2YS5pby5CdWZmZXJlZFJlYWRlcihuZXcgamF2YS5pby5JbnB1dFN0cmVhbVJlYWRlcihuZXcgamF2YS5pby5GaWxlSW5wdXRTdHJlYW0oZmlsZSksIGVuY29kaW5nKSksCiAgICAgICAgICAgICAgICBjb250ZW50ID0gJyc7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBzdHJpbmdCdWZmZXIgPSBuZXcgamF2YS5sYW5nLlN0cmluZ0J1ZmZlcigpOwogICAgICAgICAgICAgICAgbGluZSA9IGlucHV0LnJlYWRMaW5lKCk7CgogICAgICAgICAgICAgICAgLy8gQnl0ZSBPcmRlciBNYXJrIChCT00pIC0gVGhlIFVuaWNvZGUgU3RhbmRhcmQsIHZlcnNpb24gMy4wLCBwYWdlIDMyNAogICAgICAgICAgICAgICAgLy8gaHR0cDovL3d3dy51bmljb2RlLm9yZy9mYXEvdXRmX2JvbS5odG1sCgogICAgICAgICAgICAgICAgLy8gTm90ZSB0aGF0IHdoZW4gd2UgdXNlIHV0Zi04LCB0aGUgQk9NIHNob3VsZCBhcHBlYXIgYXMgIkVGIEJCIEJGIiwgYnV0IGl0IGRvZXNuJ3QgZHVlIHRvIHRoaXMgYnVnIGluIHRoZSBKREs6CiAgICAgICAgICAgICAgICAvLyBodHRwOi8vYnVncy5zdW4uY29tL2J1Z2RhdGFiYXNlL3ZpZXdfYnVnLmRvP2J1Z19pZD00NTA4MDU4CiAgICAgICAgICAgICAgICBpZiAobGluZSAmJiBsaW5lLmxlbmd0aCgpICYmIGxpbmUuY2hhckF0KDApID09PSAweGZlZmYpIHsKICAgICAgICAgICAgICAgICAgICAvLyBFYXQgdGhlIEJPTSwgc2luY2Ugd2UndmUgYWxyZWFkeSBmb3VuZCB0aGUgZW5jb2Rpbmcgb24gdGhpcyBmaWxlLAogICAgICAgICAgICAgICAgICAgIC8vIGFuZCB3ZSBwbGFuIHRvIGNvbmNhdGVuYXRpbmcgdGhpcyBidWZmZXIgd2l0aCBvdGhlcnM7IHRoZSBCT00gc2hvdWxkCiAgICAgICAgICAgICAgICAgICAgLy8gb25seSBhcHBlYXIgYXQgdGhlIHRvcCBvZiBhIGZpbGUuCiAgICAgICAgICAgICAgICAgICAgbGluZSA9IGxpbmUuc3Vic3RyaW5nKDEpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChsaW5lICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgc3RyaW5nQnVmZmVyLmFwcGVuZChsaW5lKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB3aGlsZSAoKGxpbmUgPSBpbnB1dC5yZWFkTGluZSgpKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHN0cmluZ0J1ZmZlci5hcHBlbmQobGluZVNlcGFyYXRvcik7CiAgICAgICAgICAgICAgICAgICAgc3RyaW5nQnVmZmVyLmFwcGVuZChsaW5lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vTWFrZSBzdXJlIHdlIHJldHVybiBhIEphdmFTY3JpcHQgc3RyaW5nIGFuZCBub3QgYSBKYXZhIHN0cmluZy4KICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBTdHJpbmcoc3RyaW5nQnVmZmVyLnRvU3RyaW5nKCkpOyAvL1N0cmluZwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgaW5wdXQuY2xvc2UoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYWxsYmFjayhjb250ZW50KTsKICAgICAgICB9OwogICAgfSBlbHNlIGlmIChtYXN0ZXJDb25maWcuZW52ID09PSAneHBjb25uZWN0JyB8fCAoIW1hc3RlckNvbmZpZy5lbnYgJiYKICAgICAgICAgICAgdHlwZW9mIENvbXBvbmVudHMgIT09ICd1bmRlZmluZWQnICYmIENvbXBvbmVudHMuY2xhc3NlcyAmJgogICAgICAgICAgICBDb21wb25lbnRzLmludGVyZmFjZXMpKSB7CiAgICAgICAgLy9BdmVydCB5b3VyIGdhemUhCiAgICAgICAgQ2MgPSBDb21wb25lbnRzLmNsYXNzZXM7CiAgICAgICAgQ2kgPSBDb21wb25lbnRzLmludGVyZmFjZXM7CiAgICAgICAgQ29tcG9uZW50cy51dGlsc1snaW1wb3J0J10oJ3Jlc291cmNlOi8vZ3JlL21vZHVsZXMvRmlsZVV0aWxzLmpzbScpOwogICAgICAgIHhwY0lzV2luZG93cyA9ICgnQG1vemlsbGEub3JnL3dpbmRvd3MtcmVnaXN0cnkta2V5OzEnIGluIENjKTsKCiAgICAgICAgdGV4dC5nZXQgPSBmdW5jdGlvbiAodXJsLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgaW5TdHJlYW0sIGNvbnZlcnRTdHJlYW0sIGZpbGVPYmosCiAgICAgICAgICAgICAgICByZWFkRGF0YSA9IHt9OwoKICAgICAgICAgICAgaWYgKHhwY0lzV2luZG93cykgewogICAgICAgICAgICAgICAgdXJsID0gdXJsLnJlcGxhY2UoL1wvL2csICdcXCcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmaWxlT2JqID0gbmV3IEZpbGVVdGlscy5GaWxlKHVybCk7CgogICAgICAgICAgICAvL1hQQ09NLCB5b3Ugc28gY3JhenkKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGluU3RyZWFtID0gQ2NbJ0Btb3ppbGxhLm9yZy9uZXR3b3JrL2ZpbGUtaW5wdXQtc3RyZWFtOzEnXQogICAgICAgICAgICAgICAgICAgICAgICAgICAuY3JlYXRlSW5zdGFuY2UoQ2kubnNJRmlsZUlucHV0U3RyZWFtKTsKICAgICAgICAgICAgICAgIGluU3RyZWFtLmluaXQoZmlsZU9iaiwgMSwgMCwgZmFsc2UpOwoKICAgICAgICAgICAgICAgIGNvbnZlcnRTdHJlYW0gPSBDY1snQG1vemlsbGEub3JnL2ludGwvY29udmVydGVyLWlucHV0LXN0cmVhbTsxJ10KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY3JlYXRlSW5zdGFuY2UoQ2kubnNJQ29udmVydGVySW5wdXRTdHJlYW0pOwogICAgICAgICAgICAgICAgY29udmVydFN0cmVhbS5pbml0KGluU3RyZWFtLCAidXRmLTgiLCBpblN0cmVhbS5hdmFpbGFibGUoKSwKICAgICAgICAgICAgICAgIENpLm5zSUNvbnZlcnRlcklucHV0U3RyZWFtLkRFRkFVTFRfUkVQTEFDRU1FTlRfQ0hBUkFDVEVSKTsKCiAgICAgICAgICAgICAgICBjb252ZXJ0U3RyZWFtLnJlYWRTdHJpbmcoaW5TdHJlYW0uYXZhaWxhYmxlKCksIHJlYWREYXRhKTsKICAgICAgICAgICAgICAgIGNvbnZlcnRTdHJlYW0uY2xvc2UoKTsKICAgICAgICAgICAgICAgIGluU3RyZWFtLmNsb3NlKCk7CiAgICAgICAgICAgICAgICBjYWxsYmFjayhyZWFkRGF0YS52YWx1ZSk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigoZmlsZU9iaiAmJiBmaWxlT2JqLnBhdGggfHwgJycpICsgJzogJyArIGUpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0KICAgIHJldHVybiB0ZXh0Owp9KTsKCi8vIFJlcXVpcmVKUyBVbmRlcnNjb3JlSlMgdGVtcGxhdGUgcGx1Z2luCi8vIGh0dHA6Ly9naXRodWIuY29tL2pmcGFyYWRpcy9yZXF1aXJlanMtdHBsCi8vCi8vIEFuIGFsdGVybmF0aXZlIHRvIGh0dHA6Ly9naXRodWIuY29tL1plZUFnZW5jeS9yZXF1aXJlanMtdHBsCi8vCi8vIFVzaW5nIFVuZGVyc2NvcmVKUyBtaWNyby10ZW1wbGF0ZXMgYXQgaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcvI3RlbXBsYXRlCi8vIFVzaW5nIGFuZCBSZXF1aXJlSlMgdGV4dC5qcyBhdCBodHRwOi8vcmVxdWlyZWpzLm9yZy9kb2NzL2FwaS5odG1sI3RleHQKLy8gQGF1dGhvciBKRiBQYXJhZGlzCi8vIEB2ZXJzaW9uIDAuMC4yCi8vCi8vIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZQovLwovLyBVc2FnZToKLy8gICByZXF1aXJlKFsnYmFja2JvbmUnLCAndHBsIW15dGVtcGxhdGUnXSwgZnVuY3Rpb24gKEJhY2tib25lLCBteXRlbXBsYXRlKSB7Ci8vICAgICByZXR1cm4gQmFja2JvbmUuVmlldy5leHRlbmQoewovLyAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpewovLyAgICAgICAgIHRoaXMucmVuZGVyKCk7Ci8vICAgICAgIH0sCi8vICAgICAgIHJlbmRlcjogZnVuY3Rpb24oKXsKLy8gICAgICAgICB0aGlzLiRlbC5odG1sKG15dGVtcGxhdGUoe21lc3NhZ2U6ICdoZWxsbyd9KSk7Ci8vICAgICB9KTsKLy8gICB9KTsKLy8KLy8gQ29uZmlndXJhdGlvbjogKG9wdGlvbmFsKQovLyAgIHJlcXVpcmUuY29uZmlnKHsKLy8gICAgIHRwbDogewovLyAgICAgICBleHRlbnNpb246ICcudHBsJyAvLyBkZWZhdWx0ID0gJy5odG1sJwovLyAgICAgfQovLyAgIH0pOwoKLypqc2xpbnQgbm9tZW46IHRydWUgKi8KLypnbG9iYWwgZGVmaW5lOiBmYWxzZSAqLwoKZGVmaW5lKCd0cGwnLFsndGV4dCcsICd1bmRlcnNjb3JlJ10sIGZ1bmN0aW9uICh0ZXh0LCBfKSB7CiAgICAKCiAgICB2YXIgYnVpbGRNYXAgPSB7fSwKICAgICAgICBidWlsZFRlbXBsYXRlU291cmNlID0gImRlZmluZSgne3BsdWdpbk5hbWV9IXttb2R1bGVOYW1lfScsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIHtzb3VyY2V9OyB9KTtcbiI7CgogICAgcmV0dXJuIHsKICAgICAgICB2ZXJzaW9uOiAnMC4wLjInLAoKICAgICAgICBsb2FkOiBmdW5jdGlvbiAobW9kdWxlTmFtZSwgcGFyZW50UmVxdWlyZSwgb25sb2FkLCBjb25maWcpIHsKCiAgICAgICAgICAgIGlmIChjb25maWcudHBsICYmIGNvbmZpZy50cGwudGVtcGxhdGVTZXR0aW5ncykgewogICAgICAgICAgICAgICAgXy50ZW1wbGF0ZVNldHRpbmdzID0gY29uZmlnLnRwbC50ZW1wbGF0ZVNldHRpbmdzOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYnVpbGRNYXBbbW9kdWxlTmFtZV0pIHsKICAgICAgICAgICAgICAgIG9ubG9hZChidWlsZE1hcFttb2R1bGVOYW1lXSk7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGV4dCA9IChjb25maWcudHBsICYmIGNvbmZpZy50cGwuZXh0ZW5zaW9uKSB8fCAnLmh0bWwnOwogICAgICAgICAgICAgICAgdmFyIHBhdGggPSAoY29uZmlnLnRwbCAmJiBjb25maWcudHBsLnBhdGgpIHx8ICcnOwogICAgICAgICAgICAgICAgdGV4dC5sb2FkKHBhdGggKyBtb2R1bGVOYW1lICsgZXh0LCBwYXJlbnRSZXF1aXJlLCBmdW5jdGlvbiAoc291cmNlKSB7CiAgICAgICAgICAgICAgICAgICAgYnVpbGRNYXBbbW9kdWxlTmFtZV0gPSBfLnRlbXBsYXRlKHNvdXJjZSk7CiAgICAgICAgICAgICAgICAgICAgb25sb2FkKGJ1aWxkTWFwW21vZHVsZU5hbWVdKTsKICAgICAgICAgICAgICAgIH0sIGNvbmZpZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICB3cml0ZTogZnVuY3Rpb24gKHBsdWdpbk5hbWUsIG1vZHVsZU5hbWUsIHdyaXRlKSB7CiAgICAgICAgICAgIHZhciBidWlsZCA9IGJ1aWxkTWFwW21vZHVsZU5hbWVdLAogICAgICAgICAgICAgICAgc291cmNlID0gYnVpbGQgJiYgYnVpbGQuc291cmNlOwogICAgICAgICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgICAgICAgICB3cml0ZS5hc01vZHVsZShwbHVnaW5OYW1lICsgJyEnICsgbW9kdWxlTmFtZSwKICAgICAgICAgICAgICAgICAgICBidWlsZFRlbXBsYXRlU291cmNlCiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoJ3twbHVnaW5OYW1lfScsIHBsdWdpbk5hbWUpCiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoJ3ttb2R1bGVOYW1lfScsIG1vZHVsZU5hbWUpCiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoJ3tzb3VyY2V9Jywgc291cmNlKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Owp9KTsKCgpkZWZpbmUoJ3RwbCFhY3Rpb24nLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGRpdiBjbGFzcz0iY2hhdC1tZXNzYWdlICcrCigoX190PShleHRyYV9jbGFzc2VzKSk9PW51bGw/Jyc6X190KSsKJyI+XG4gICAgPHNwYW4gY2xhc3M9ImNoYXQtbWVzc2FnZS0nKwooKF9fdD0oc2VuZGVyKSk9PW51bGw/Jyc6X190KSsKJyI+JysKKChfX3Q9KHRpbWUpKT09bnVsbD8nJzpfX3QpKwonICoqJysKKChfX3Q9KHVzZXJuYW1lKSk9PW51bGw/Jyc6X190KSsKJyA8L3NwYW4+XG4gICAgPHNwYW4gY2xhc3M9ImNoYXQtbWVzc2FnZS1jb250ZW50Ij4nKwooKF9fdD0obWVzc2FnZSkpPT1udWxsPycnOl9fdCkrCic8L3NwYW4+XG48L2Rpdj5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhYWRkX2NvbnRhY3RfZHJvcGRvd24nLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGRsIGNsYXNzPSJhZGQtY29udmVyc2UtY29udGFjdCBkcm9wZG93biI+XG4gICAgPGR0IGlkPSJ4bXBwLWNvbnRhY3Qtc2VhcmNoIiBjbGFzcz0iZmFuY3ktZHJvcGRvd24iPlxuICAgICAgICA8YSBjbGFzcz0idG9nZ2xlLXhtcHAtY29udGFjdC1mb3JtIiBocmVmPSIjIlxuICAgICAgICAgICAgdGl0bGU9IicrCigoX190PShsYWJlbF9jbGlja190b19jaGF0KSk9PW51bGw/Jyc6X190KSsKJyI+XG4gICAgICAgIDxzcGFuIGNsYXNzPSJpY29uLXBsdXMiPjwvc3Bhbj4nKwooKF9fdD0obGFiZWxfYWRkX2NvbnRhY3QpKT09bnVsbD8nJzpfX3QpKwonPC9hPlxuICAgIDwvZHQ+XG4gICAgPGRkIGNsYXNzPSJzZWFyY2gteG1wcCIgc3R5bGU9ImRpc3BsYXk6bm9uZSI+PHVsPjwvdWw+PC9kZD5cbjwvZGw+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIWFkZF9jb250YWN0X2Zvcm0nLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGxpPlxuICAgIDxmb3JtIGNsYXNzPSJhZGQteG1wcC1jb250YWN0Ij5cbiAgICAgICAgPGlucHV0IHR5cGU9InRleHQiXG4gICAgICAgICAgICBuYW1lPSJpZGVudGlmaWVyIlxuICAgICAgICAgICAgY2xhc3M9InVzZXJuYW1lIlxuICAgICAgICAgICAgcGxhY2Vob2xkZXI9IicrCigoX190PShsYWJlbF9jb250YWN0X3VzZXJuYW1lKSk9PW51bGw/Jyc6X190KSsKJyIvPlxuICAgICAgICA8YnV0dG9uIHR5cGU9InN1Ym1pdCI+JysKKChfX3Q9KGxhYmVsX2FkZCkpPT1udWxsPycnOl9fdCkrCic8L2J1dHRvbj5cbiAgICA8L2Zvcm0+XG48L2xpPlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFjaGFuZ2Vfc3RhdHVzX21lc3NhZ2UnLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGZvcm0gaWQ9InNldC1jdXN0b20teG1wcC1zdGF0dXMiPlxuICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBjbGFzcz0iY3VzdG9tLXhtcHAtc3RhdHVzIiAnKwooKF9fdD0oc3RhdHVzX21lc3NhZ2UpKT09bnVsbD8nJzpfX3QpKwonXG4gICAgICAgIHBsYWNlaG9sZGVyPSInKwooKF9fdD0obGFiZWxfY3VzdG9tX3N0YXR1cykpPT1udWxsPycnOl9fdCkrCiciLz5cbiAgICA8YnV0dG9uIHR5cGU9InN1Ym1pdCI+JysKKChfX3Q9KGxhYmVsX3NhdmUpKT09bnVsbD8nJzpfX3QpKwonPC9idXR0b24+XG48L2Zvcm0+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIWNoYXRfc3RhdHVzJywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9JzxkaXYgY2xhc3M9InhtcHAtc3RhdHVzIj5cbiAgICA8YSBjbGFzcz0iY2hvb3NlLXhtcHAtc3RhdHVzICcrCigoX190PShjaGF0X3N0YXR1cykpPT1udWxsPycnOl9fdCkrCiciXG4gICAgICAgZGF0YS12YWx1ZT0iJysKKChfX3Q9KHN0YXR1c19tZXNzYWdlKSk9PW51bGw/Jyc6X190KSsKJyJcbiAgICAgICBocmVmPSIjIiB0aXRsZT0iJysKKChfX3Q9KGRlc2NfY2hhbmdlX3N0YXR1cykpPT1udWxsPycnOl9fdCkrCiciPlxuXG4gICAgICAgIDxzcGFuIGNsYXNzPSJpY29uLScrCigoX190PShjaGF0X3N0YXR1cykpPT1udWxsPycnOl9fdCkrCiciPjwvc3Bhbj4nKwooKF9fdD0oc3RhdHVzX21lc3NhZ2UpKT09bnVsbD8nJzpfX3QpKwonXG4gICAgPC9hPlxuICAgIDxhIGNsYXNzPSJjaGFuZ2UteG1wcC1zdGF0dXMtbWVzc2FnZSBpY29uLXBlbmNpbCJcbiAgICAgICAgaHJlZj0iIyJcbiAgICAgICAgdGl0bGU9IicrCigoX190PShkZXNjX2N1c3RvbV9zdGF0dXMpKT09bnVsbD8nJzpfX3QpKwonIj48L2E+XG48L2Rpdj5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhY2hhdGFyZWEnLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGRpdiBjbGFzcz0iY2hhdC1hcmVhIj5cbiAgICA8ZGl2IGNsYXNzPSJjaGF0LWNvbnRlbnQiPjwvZGl2PlxuICAgIDxmb3JtIGNsYXNzPSJzZW5kWE1QUE1lc3NhZ2UiIGFjdGlvbj0iIiBtZXRob2Q9InBvc3QiPlxuICAgICAgICAnOwogaWYgKHNob3dfdG9vbGJhcikgeyAKX19wKz0nXG4gICAgICAgICAgICA8dWwgY2xhc3M9ImNoYXQtdG9vbGJhciBuby10ZXh0LXNlbGVjdCI+PC91bD5cbiAgICAgICAgJzsKIH0gCl9fcCs9J1xuICAgICAgICA8dGV4dGFyZWEgdHlwZT0idGV4dCIgY2xhc3M9ImNoYXQtdGV4dGFyZWEiIFxuICAgICAgICAgICAgcGxhY2Vob2xkZXI9IicrCigoX190PShsYWJlbF9tZXNzYWdlKSk9PW51bGw/Jyc6X190KSsKJyIvPlxuICAgIDwvZm9ybT5cbjwvZGl2PlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFjaGF0Ym94JywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9JzxkaXYgY2xhc3M9ImJveC1mbHlvdXQiIHN0eWxlPSJoZWlnaHQ6ICcrCigoX190PShoZWlnaHQpKT09bnVsbD8nJzpfX3QpKwoncHgiPlxuICAgIDxkaXYgY2xhc3M9ImRyYWdyZXNpemUgZHJhZ3Jlc2l6ZS10bSI+PC9kaXY+XG4gICAgPGRpdiBjbGFzcz0iY2hhdC1oZWFkIGNoYXQtaGVhZC1jaGF0Ym94Ij5cbiAgICAgICAgPGEgY2xhc3M9ImNsb3NlLWNoYXRib3gtYnV0dG9uIGljb24tY2xvc2UiPjwvYT5cbiAgICAgICAgPGEgY2xhc3M9InRvZ2dsZS1jaGF0Ym94LWJ1dHRvbiBpY29uLW1pbnVzIj48L2E+XG4gICAgICAgIDxkaXYgY2xhc3M9ImNoYXQtdGl0bGUiPlxuICAgICAgICAgICAgJzsKIGlmICh1cmwpIHsgCl9fcCs9J1xuICAgICAgICAgICAgICAgIDxhIGhyZWY9IicrCigoX190PSh1cmwpKT09bnVsbD8nJzpfX3QpKwonIiB0YXJnZXQ9Il9ibGFuayIgY2xhc3M9InVzZXIiPlxuICAgICAgICAgICAgJzsKIH0gCl9fcCs9J1xuICAgICAgICAgICAgICAgICAgICAnKwooKF9fdD0oIGZ1bGxuYW1lICkpPT1udWxsPycnOl9fdCkrCidcbiAgICAgICAgICAgICc7CiBpZiAodXJsKSB7IApfX3ArPSdcbiAgICAgICAgICAgICAgICA8L2E+XG4gICAgICAgICAgICAnOwogfSAKX19wKz0nXG4gICAgICAgIDwvZGl2PlxuICAgICAgICA8cCBjbGFzcz0idXNlci1jdXN0b20tbWVzc2FnZSI+PHAvPlxuICAgIDwvZGl2PlxuICAgIDxkaXYgY2xhc3M9ImNoYXQtYm9keSI+XG4gICAgICAgIDxkaXYgY2xhc3M9ImNoYXQtY29udGVudCI+PC9kaXY+XG4gICAgICAgIDxmb3JtIGNsYXNzPSJzZW5kWE1QUE1lc3NhZ2UiIGFjdGlvbj0iIiBtZXRob2Q9InBvc3QiPlxuICAgICAgICAgICAgJzsKIGlmIChzaG93X3Rvb2xiYXIpIHsgCl9fcCs9J1xuICAgICAgICAgICAgICAgIDx1bCBjbGFzcz0iY2hhdC10b29sYmFyIG5vLXRleHQtc2VsZWN0Ij48L3VsPlxuICAgICAgICAgICAgJzsKIH0gCl9fcCs9J1xuICAgICAgICA8dGV4dGFyZWFcbiAgICAgICAgICAgIHR5cGU9InRleHQiXG4gICAgICAgICAgICBjbGFzcz0iY2hhdC10ZXh0YXJlYSJcbiAgICAgICAgICAgIHBsYWNlaG9sZGVyPSInKwooKF9fdD0obGFiZWxfcGVyc29uYWxfbWVzc2FnZSkpPT1udWxsPycnOl9fdCkrCiciLz5cbiAgICAgICAgPC9mb3JtPlxuICAgIDwvZGl2PlxuPC9kaXY+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIWNoYXRyb29tJywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9JzxkaXYgY2xhc3M9ImJveC1mbHlvdXQiIHN0eWxlPSJoZWlnaHQ6ICcrCigoX190PShoZWlnaHQpKT09bnVsbD8nJzpfX3QpKwoncHgiXG4gICAgJzsKIGlmIChtaW5pbWl6ZWQpIHsgCl9fcCs9JyBzdHlsZT0iZGlzcGxheTpub25lIiAnOwogfSAKX19wKz0nPlxuICAgIDxkaXYgY2xhc3M9ImRyYWdyZXNpemUgZHJhZ3Jlc2l6ZS10bSI+PC9kaXY+XG4gICAgPGRpdiBjbGFzcz0iY2hhdC1oZWFkIGNoYXQtaGVhZC1jaGF0cm9vbSI+XG4gICAgICAgIDxhIGNsYXNzPSJjbG9zZS1jaGF0Ym94LWJ1dHRvbiBpY29uLWNsb3NlIj48L2E+XG4gICAgICAgIDxhIGNsYXNzPSJ0b2dnbGUtY2hhdGJveC1idXR0b24gaWNvbi1taW51cyI+PC9hPlxuICAgICAgICA8YSBjbGFzcz0iY29uZmlndXJlLWNoYXRyb29tLWJ1dHRvbiBpY29uLXdyZW5jaCIgc3R5bGU9ImRpc3BsYXk6bm9uZSI+PC9hPlxuICAgICAgICA8ZGl2IGNsYXNzPSJjaGF0LXRpdGxlIj4gJysKKChfX3Q9KCBuYW1lICkpPT1udWxsPycnOl9fdCkrCicgPC9kaXY+XG4gICAgICAgIDxwIGNsYXNzPSJjaGF0cm9vbS10b3BpYyI+PHAvPlxuICAgIDwvZGl2PlxuICAgIDxkaXYgY2xhc3M9ImNoYXQtYm9keSI+PHNwYW4gY2xhc3M9InNwaW5uZXIgY2VudGVyZWQiLz48L2Rpdj5cbjwvZGl2PlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFjaGF0cm9vbV9wYXNzd29yZF9mb3JtJywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9JzxkaXYgY2xhc3M9ImNoYXRyb29tLWZvcm0tY29udGFpbmVyIj5cbiAgICA8Zm9ybSBjbGFzcz0iY2hhdHJvb20tZm9ybSI+XG4gICAgICAgIDxsZWdlbmQ+JysKKChfX3Q9KGhlYWRpbmcpKT09bnVsbD8nJzpfX3QpKwonPC9sZWdlbmQ+XG4gICAgICAgIDxsYWJlbD4nKwooKF9fdD0obGFiZWxfcGFzc3dvcmQpKT09bnVsbD8nJzpfX3QpKwonPGlucHV0IHR5cGU9InBhc3N3b3JkIiBuYW1lPSJwYXNzd29yZCIvPjwvbGFiZWw+XG4gICAgICAgIDxpbnB1dCB0eXBlPSJzdWJtaXQiIHZhbHVlPSInKwooKF9fdD0obGFiZWxfc3VibWl0KSk9PW51bGw/Jyc6X190KSsKJyIvPlxuICAgIDwvZm9ybT5cbjwvZGl2PlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFjaGF0cm9vbV9zaWRlYmFyJywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9JzwhLS0gPGRpdiBjbGFzcz0icGFydGljaXBhbnRzIj4gLS0+XG48Zm9ybSBjbGFzcz0icm9vbS1pbnZpdGUiPlxuICAgIDxpbnB1dCBjbGFzcz0iaW52aXRlZC1jb250YWN0IiBwbGFjZWhvbGRlcj0iJysKKChfX3Q9KGxhYmVsX2ludml0YXRpb24pKT09bnVsbD8nJzpfX3QpKwonIiB0eXBlPSJ0ZXh0Ii8+XG48L2Zvcm0+XG48bGFiZWw+JysKKChfX3Q9KGxhYmVsX29jY3VwYW50cykpPT1udWxsPycnOl9fdCkrCic6PC9sYWJlbD5cbjx1bCBjbGFzcz0icGFydGljaXBhbnQtbGlzdCI+PC91bD5cbjwhLS0gPC9kaXY+IC0tPlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFjaGF0cm9vbXNfdGFiJywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9JzxsaT48YSBjbGFzcz0icyIgaHJlZj0iI2NoYXRyb29tcyI+JysKKChfX3Q9KGxhYmVsX3Jvb21zKSk9PW51bGw/Jyc6X190KSsKJzwvYT48L2xpPlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFjaGF0c19wYW5lbCcsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8ZGl2IGlkPSJtaW5pbWl6ZWQtY2hhdHMiPlxuICAgIDxhIGlkPSJ0b2dnbGUtbWluaW1pemVkLWNoYXRzIiBocmVmPSIjIj48L2E+XG4gICAgPGRpdiBjbGFzcz0ibWluaW1pemVkLWNoYXRzLWZseW91dCI+PC9kaXY+XG48L2Rpdj5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhY2hvb3NlX3N0YXR1cycsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8ZGwgaWQ9InRhcmdldCIgY2xhc3M9ImRyb3Bkb3duIj5cbiAgICA8ZHQgaWQ9ImZhbmN5LXhtcHAtc3RhdHVzLXNlbGVjdCIgY2xhc3M9ImZhbmN5LWRyb3Bkb3duIj48L2R0PlxuICAgIDxkZD48dWwgY2xhc3M9InhtcHAtc3RhdHVzLW1lbnUiPjwvdWw+PC9kZD5cbjwvZGw+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIWNvbnRhY3RzX3BhbmVsJywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9Jzxmb3JtIGNsYXNzPSJzZXQteG1wcC1zdGF0dXMiIGFjdGlvbj0iIiBtZXRob2Q9InBvc3QiPlxuICAgIDxzcGFuIGlkPSJ4bXBwLXN0YXR1cy1ob2xkZXIiPlxuICAgICAgICA8c2VsZWN0IGlkPSJzZWxlY3QteG1wcC1zdGF0dXMiIHN0eWxlPSJkaXNwbGF5Om5vbmUiPlxuICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0ib25saW5lIj4nKwooKF9fdD0obGFiZWxfb25saW5lKSk9PW51bGw/Jyc6X190KSsKJzwvb3B0aW9uPlxuICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iZG5kIj4nKwooKF9fdD0obGFiZWxfYnVzeSkpPT1udWxsPycnOl9fdCkrCic8L29wdGlvbj5cbiAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9ImF3YXkiPicrCigoX190PShsYWJlbF9hd2F5KSk9PW51bGw/Jyc6X190KSsKJzwvb3B0aW9uPlxuICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0ib2ZmbGluZSI+JysKKChfX3Q9KGxhYmVsX29mZmxpbmUpKT09bnVsbD8nJzpfX3QpKwonPC9vcHRpb24+XG4gICAgICAgICAgICAnOwogaWYgKGFsbG93X2xvZ291dCkgIHsgCl9fcCs9J1xuICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0ibG9nb3V0Ij4nKwooKF9fdD0obGFiZWxfbG9nb3V0KSk9PW51bGw/Jyc6X190KSsKJzwvb3B0aW9uPlxuICAgICAgICAgICAgJzsKIH0gCl9fcCs9J1xuICAgICAgICA8L3NlbGVjdD5cbiAgICA8L3NwYW4+XG48L2Zvcm0+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIWNvbnRhY3RzX3RhYicsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8bGk+PGEgY2xhc3M9InMgY3VycmVudCIgaHJlZj0iI3VzZXJzIj4nKwooKF9fdD0obGFiZWxfY29udGFjdHMpKT09bnVsbD8nJzpfX3QpKwonPC9hPjwvbGk+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIWNvbnRyb2xib3gnLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGRpdiBjbGFzcz0iYm94LWZseW91dCIgc3R5bGU9ImhlaWdodDogJysKKChfX3Q9KGhlaWdodCkpPT1udWxsPycnOl9fdCkrCidweCI+XG4gICAgPGRpdiBjbGFzcz0iZHJhZ3Jlc2l6ZSBkcmFncmVzaXplLXRtIj48L2Rpdj5cbiAgICA8ZGl2IGNsYXNzPSJjaGF0LWhlYWQgY29udHJvbGJveC1oZWFkIj5cbiAgICAgICAgPHVsIGlkPSJjb250cm9sYm94LXRhYnMiPjwvdWw+XG4gICAgICAgIDxhIGNsYXNzPSJjbG9zZS1jaGF0Ym94LWJ1dHRvbiBpY29uLWNsb3NlIj48L2E+XG4gICAgPC9kaXY+XG4gICAgPGRpdiBjbGFzcz0iY29udHJvbGJveC1wYW5lcyI+PC9kaXY+XG48L2Rpdj5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhY29udHJvbGJveF90b2dnbGUnLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPHNwYW4gY2xhc3M9ImNvbm4tZmVlZGJhY2siPicrCigoX190PShsYWJlbF90b2dnbGUpKT09bnVsbD8nJzpfX3QpKwonPC9zcGFuPlxuPHNwYW4gc3R5bGU9ImRpc3BsYXk6IG5vbmUiIGlkPSJvbmxpbmUtY291bnQiPigwKTwvc3Bhbj5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhZmllbGQnLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGZpZWxkIHZhcj0iJysKKChfX3Q9KG5hbWUpKT09bnVsbD8nJzpfX3QpKwonIj48dmFsdWU+JysKKChfX3Q9KHZhbHVlKSk9PW51bGw/Jyc6X190KSsKJzwvdmFsdWU+PC9maWVsZD5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhZm9ybV9jaGVja2JveCcsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8bGFiZWw+JysKKChfX3Q9KGxhYmVsKSk9PW51bGw/Jyc6X190KSsKJzxpbnB1dCBuYW1lPSInKwooKF9fdD0obmFtZSkpPT1udWxsPycnOl9fdCkrCiciIHR5cGU9IicrCigoX190PSh0eXBlKSk9PW51bGw/Jyc6X190KSsKJyIgJysKKChfX3Q9KGNoZWNrZWQpKT09bnVsbD8nJzpfX3QpKwonPjwvbGFiZWw+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIWZvcm1faW5wdXQnLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGxhYmVsPicrCigoX190PShsYWJlbCkpPT1udWxsPycnOl9fdCkrCic8aW5wdXQgbmFtZT0iJysKKChfX3Q9KG5hbWUpKT09bnVsbD8nJzpfX3QpKwonIiB0eXBlPSInKwooKF9fdD0odHlwZSkpPT1udWxsPycnOl9fdCkrCiciIHZhbHVlPSInKwooKF9fdD0odmFsdWUpKT09bnVsbD8nJzpfX3QpKwonIj48L2xhYmVsPlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFmb3JtX3NlbGVjdCcsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8bGFiZWw+JysKKChfX3Q9KGxhYmVsKSk9PW51bGw/Jyc6X190KSsKJzxzZWxlY3QgbmFtZT0iJysKKChfX3Q9KG5hbWUpKT09bnVsbD8nJzpfX3QpKwonIj4nKwooKF9fdD0ob3B0aW9ucykpPT1udWxsPycnOl9fdCkrCic8L3NlbGVjdD48L2xhYmVsPlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFncm91cF9oZWFkZXInLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGEgaHJlZj0iIyIgY2xhc3M9Imdyb3VwLXRvZ2dsZSBpY29uLScrCigoX190PSh0b2dnbGVfc3RhdGUpKT09bnVsbD8nJzpfX3QpKwonIiB0aXRsZT0iJysKKChfX3Q9KGRlc2NfZ3JvdXBfdG9nZ2xlKSk9PW51bGw/Jyc6X190KSsKJyI+JysKKChfX3Q9KGxhYmVsX2dyb3VwKSk9PW51bGw/Jyc6X190KSsKJzwvYT5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhaW5mbycsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8ZGl2IGNsYXNzPSJjaGF0LWluZm8iPicrCigoX190PShtZXNzYWdlKSk9PW51bGw/Jyc6X190KSsKJzwvZGl2PlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFsb2dpbl9wYW5lbCcsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8Zm9ybSBpZD0iY29udmVyc2UtbG9naW4iIG1ldGhvZD0icG9zdCI+XG4gICAgPGxhYmVsPicrCigoX190PShsYWJlbF91c2VybmFtZSkpPT1udWxsPycnOl9fdCkrCic8L2xhYmVsPlxuICAgIDxpbnB1dCB0eXBlPSJ1c2VybmFtZSIgbmFtZT0iamlkIiBwbGFjZWhvbGRlcj0iVXNlcm5hbWUiPlxuICAgIDxsYWJlbD4nKwooKF9fdD0obGFiZWxfcGFzc3dvcmQpKT09bnVsbD8nJzpfX3QpKwonPC9sYWJlbD5cbiAgICA8aW5wdXQgdHlwZT0icGFzc3dvcmQiIG5hbWU9InBhc3N3b3JkIiBwbGFjZWhvbGRlcj0iUGFzc3dvcmQiPlxuICAgIDxpbnB1dCBjbGFzcz0ibG9naW4tc3VibWl0IiB0eXBlPSJzdWJtaXQiIHZhbHVlPSInKwooKF9fdD0obGFiZWxfbG9naW4pKT09bnVsbD8nJzpfX3QpKwonIj5cbiAgICA8c3BhbiBjbGFzcz0iY29ubi1mZWVkYmFjayI+PC9zcGFuPlxuPC9mb3JtPlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFsb2dpbl90YWInLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGxpPjxhIGNsYXNzPSJjdXJyZW50IiBocmVmPSIjbG9naW4iPicrCigoX190PShsYWJlbF9zaWduX2luKSk9PW51bGw/Jyc6X190KSsKJzwvYT48L2xpPlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFtZXNzYWdlJywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9JzxkaXYgY2xhc3M9ImNoYXQtbWVzc2FnZSAnKwooKF9fdD0oZXh0cmFfY2xhc3NlcykpPT1udWxsPycnOl9fdCkrCiciPlxuICAgIDxzcGFuIGNsYXNzPSJjaGF0LW1lc3NhZ2UtJysKKChfX3Q9KHNlbmRlcikpPT1udWxsPycnOl9fdCkrCiciPicrCigoX190PSh0aW1lKSk9PW51bGw/Jyc6X190KSsKJyAnKwooKF9fdD0odXNlcm5hbWUpKT09bnVsbD8nJzpfX3QpKwonOiZuYnNwOzwvc3Bhbj5cbiAgICA8c3BhbiBjbGFzcz0iY2hhdC1tZXNzYWdlLWNvbnRlbnQiPicrCigoX190PShtZXNzYWdlKSk9PW51bGw/Jyc6X190KSsKJzwvc3Bhbj5cbjwvZGl2PlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFuZXdfZGF5JywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9Jzx0aW1lIGNsYXNzPSJjaGF0LWRhdGUiIGRhdGV0aW1lPSInKwooKF9fdD0oaXNvZGF0ZSkpPT1udWxsPycnOl9fdCkrCiciPicrCigoX190PShkYXRlc3RyaW5nKSk9PW51bGw/Jyc6X190KSsKJzwvdGltZT5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhb2NjdXBhbnQnLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGxpIGNsYXNzPSInKwooKF9fdD0ocm9sZSkpPT1udWxsPycnOl9fdCkrCiciXG4gICAgJzsKIGlmIChyb2xlID09PSAibW9kZXJhdG9yIikgeyAKX19wKz0nXG4gICAgICAgdGl0bGU9IicrCigoX190PShkZXNjX21vZGVyYXRvcikpPT1udWxsPycnOl9fdCkrCiciXG4gICAgJzsKIH0gCl9fcCs9J1xuICAgICc7CiBpZiAocm9sZSA9PT0gInBhcnRpY2lwYW50IikgeyAKX19wKz0nXG4gICAgICAgdGl0bGU9IicrCigoX190PShkZXNjX3BhcnRpY2lwYW50KSk9PW51bGw/Jyc6X190KSsKJyJcbiAgICAnOwogfSAKX19wKz0nXG4gICAgJzsKIGlmIChyb2xlID09PSAidmlzaXRvciIpIHsgCl9fcCs9J1xuICAgICAgIHRpdGxlPSInKwooKF9fdD0oZGVzY192aXNpdG9yKSk9PW51bGw/Jyc6X190KSsKJyJcbiAgICAnOwogfSAKX19wKz0nXG4+JysKKChfX3Q9KG5pY2spKT09bnVsbD8nJzpfX3QpKwonPC9saT5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhcGVuZGluZ19jb250YWN0JywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9JzxzcGFuIGNsYXNzPSJwZW5kaW5nLWNvbnRhY3QtbmFtZSI+JysKKChfX3Q9KGZ1bGxuYW1lKSk9PW51bGw/Jyc6X190KSsKJzwvc3Bhbj4gPGEgY2xhc3M9InJlbW92ZS14bXBwLWNvbnRhY3QgaWNvbi1yZW1vdmUiIHRpdGxlPSInKwooKF9fdD0oZGVzY19yZW1vdmUpKT09bnVsbD8nJzpfX3QpKwonIiBocmVmPSIjIj48L2E+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIXBlbmRpbmdfY29udGFjdHMnLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGR0IGlkPSJwZW5kaW5nLXhtcHAtY29udGFjdHMiPjxhIGhyZWY9IiMiIGNsYXNzPSJncm91cC10b2dnbGUgaWNvbi0nKwooKF9fdD0odG9nZ2xlX3N0YXRlKSk9PW51bGw/Jyc6X190KSsKJyIgdGl0bGU9IicrCigoX190PShkZXNjX2dyb3VwX3RvZ2dsZSkpPT1udWxsPycnOl9fdCkrCiciPicrCigoX190PShsYWJlbF9wZW5kaW5nX2NvbnRhY3RzKSk9PW51bGw/Jyc6X190KSsKJzwvYT48L2R0PlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFyZXF1ZXN0aW5nX2NvbnRhY3QnLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPHNwYW4gY2xhc3M9InJlcS1jb250YWN0LW5hbWUiPicrCigoX190PShmdWxsbmFtZSkpPT1udWxsPycnOl9fdCkrCic8L3NwYW4+XG48c3BhbiBjbGFzcz0icmVxdWVzdC1hY3Rpb25zIj5cbiAgICA8YSBjbGFzcz0iYWNjZXB0LXhtcHAtcmVxdWVzdCBpY29uLWNoZWNrbWFyayIgdGl0bGU9IicrCigoX190PShkZXNjX2FjY2VwdCkpPT1udWxsPycnOl9fdCkrCiciIGhyZWY9IiMiPjwvYT5cbiAgICA8YSBjbGFzcz0iZGVjbGluZS14bXBwLXJlcXVlc3QgaWNvbi1jbG9zZSIgdGl0bGU9IicrCigoX190PShkZXNjX2RlY2xpbmUpKT09bnVsbD8nJzpfX3QpKwonIiBocmVmPSIjIj48L2E+XG48L3NwYW4+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIXJlcXVlc3RpbmdfY29udGFjdHMnLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGR0IGlkPSJ4bXBwLWNvbnRhY3QtcmVxdWVzdHMiPjxhIGhyZWY9IiMiIGNsYXNzPSJncm91cC10b2dnbGUgaWNvbi0nKwooKF9fdD0odG9nZ2xlX3N0YXRlKSk9PW51bGw/Jyc6X190KSsKJyIgdGl0bGU9IicrCigoX190PShkZXNjX2dyb3VwX3RvZ2dsZSkpPT1udWxsPycnOl9fdCkrCiciPicrCigoX190PShsYWJlbF9jb250YWN0X3JlcXVlc3RzKSk9PW51bGw/Jyc6X190KSsKJzwvYT48L2R0PlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFyb29tX2Rlc2NyaXB0aW9uJywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9JzwhLS0gRklYTUU6IGNoZWNrIG1hcmt1cCBpbiBtb2NrdXAgLS0+XG48ZGl2IGNsYXNzPSJyb29tLWluZm8iPlxuPHAgY2xhc3M9InJvb20taW5mbyI+PHN0cm9uZz4nKwooKF9fdD0obGFiZWxfZGVzYykpPT1udWxsPycnOl9fdCkrCic8L3N0cm9uZz4gJysKKChfX3Q9KGRlc2MpKT09bnVsbD8nJzpfX3QpKwonPC9wPlxuPHAgY2xhc3M9InJvb20taW5mbyI+PHN0cm9uZz4nKwooKF9fdD0obGFiZWxfb2NjKSk9PW51bGw/Jyc6X190KSsKJzwvc3Ryb25nPiAnKwooKF9fdD0ob2NjKSk9PW51bGw/Jyc6X190KSsKJzwvcD5cbjxwIGNsYXNzPSJyb29tLWluZm8iPjxzdHJvbmc+JysKKChfX3Q9KGxhYmVsX2ZlYXR1cmVzKSk9PW51bGw/Jyc6X190KSsKJzwvc3Ryb25nPlxuICAgIDx1bD5cbiAgICAgICAgJzsKIGlmIChwYXNzd29yZHByb3RlY3RlZCkgeyAKX19wKz0nXG4gICAgICAgIDxsaSBjbGFzcz0icm9vbS1pbmZvIGxvY2tlZCI+JysKKChfX3Q9KGxhYmVsX3JlcXVpcmVzX2F1dGgpKT09bnVsbD8nJzpfX3QpKwonPC9saT5cbiAgICAgICAgJzsKIH0gCl9fcCs9J1xuICAgICAgICAnOwogaWYgKGhpZGRlbikgeyAKX19wKz0nXG4gICAgICAgIDxsaSBjbGFzcz0icm9vbS1pbmZvIj4nKwooKF9fdD0obGFiZWxfaGlkZGVuKSk9PW51bGw/Jyc6X190KSsKJzwvbGk+XG4gICAgICAgICc7CiB9IApfX3ArPSdcbiAgICAgICAgJzsKIGlmIChtZW1iZXJzb25seSkgeyAKX19wKz0nXG4gICAgICAgIDxsaSBjbGFzcz0icm9vbS1pbmZvIj4nKwooKF9fdD0obGFiZWxfcmVxdWlyZXNfaW52aXRlKSk9PW51bGw/Jyc6X190KSsKJzwvbGk+XG4gICAgICAgICc7CiB9IApfX3ArPSdcbiAgICAgICAgJzsKIGlmIChtb2RlcmF0ZWQpIHsgCl9fcCs9J1xuICAgICAgICA8bGkgY2xhc3M9InJvb20taW5mbyI+JysKKChfX3Q9KGxhYmVsX21vZGVyYXRlZCkpPT1udWxsPycnOl9fdCkrCic8L2xpPlxuICAgICAgICAnOwogfSAKX19wKz0nXG4gICAgICAgICc7CiBpZiAobm9uYW5vbnltb3VzKSB7IApfX3ArPSdcbiAgICAgICAgPGxpIGNsYXNzPSJyb29tLWluZm8iPicrCigoX190PShsYWJlbF9ub25fYW5vbikpPT1udWxsPycnOl9fdCkrCic8L2xpPlxuICAgICAgICAnOwogfSAKX19wKz0nXG4gICAgICAgICc7CiBpZiAob3BlbikgeyAKX19wKz0nXG4gICAgICAgIDxsaSBjbGFzcz0icm9vbS1pbmZvIj4nKwooKF9fdD0obGFiZWxfb3Blbl9yb29tKSk9PW51bGw/Jyc6X190KSsKJzwvbGk+XG4gICAgICAgICc7CiB9IApfX3ArPSdcbiAgICAgICAgJzsKIGlmIChwZXJzaXN0ZW50KSB7IApfX3ArPSdcbiAgICAgICAgPGxpIGNsYXNzPSJyb29tLWluZm8iPicrCigoX190PShsYWJlbF9wZXJtYW5lbnRfcm9vbSkpPT1udWxsPycnOl9fdCkrCic8L2xpPlxuICAgICAgICAnOwogfSAKX19wKz0nXG4gICAgICAgICc7CiBpZiAocHVibGljcm9vbSkgeyAKX19wKz0nXG4gICAgICAgIDxsaSBjbGFzcz0icm9vbS1pbmZvIj4nKwooKF9fdD0obGFiZWxfcHVibGljKSk9PW51bGw/Jyc6X190KSsKJzwvbGk+XG4gICAgICAgICc7CiB9IApfX3ArPSdcbiAgICAgICAgJzsKIGlmIChzZW1pYW5vbnltb3VzKSB7IApfX3ArPSdcbiAgICAgICAgPGxpIGNsYXNzPSJyb29tLWluZm8iPicrCigoX190PShsYWJlbF9zZW1pX2Fub24pKT09bnVsbD8nJzpfX3QpKwonPC9saT5cbiAgICAgICAgJzsKIH0gCl9fcCs9J1xuICAgICAgICAnOwogaWYgKHRlbXBvcmFyeSkgeyAKX19wKz0nXG4gICAgICAgIDxsaSBjbGFzcz0icm9vbS1pbmZvIj4nKwooKF9fdD0obGFiZWxfdGVtcF9yb29tKSk9PW51bGw/Jyc6X190KSsKJzwvbGk+XG4gICAgICAgICc7CiB9IApfX3ArPSdcbiAgICAgICAgJzsKIGlmICh1bm1vZGVyYXRlZCkgeyAKX19wKz0nXG4gICAgICAgIDxsaSBjbGFzcz0icm9vbS1pbmZvIj4nKwooKF9fdD0obGFiZWxfdW5tb2RlcmF0ZWQpKT09bnVsbD8nJzpfX3QpKwonPC9saT5cbiAgICAgICAgJzsKIH0gCl9fcCs9J1xuICAgIDwvdWw+XG48L3A+XG48L2Rpdj5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhcm9vbV9pdGVtJywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9JzxkZCBjbGFzcz0iYXZhaWxhYmxlLWNoYXRyb29tIj5cbjxhIGNsYXNzPSJvcGVuLXJvb20iIGRhdGEtcm9vbS1qaWQ9IicrCigoX190PShqaWQpKT09bnVsbD8nJzpfX3QpKwonIlxuICAgdGl0bGU9IicrCigoX190PShvcGVuX3RpdGxlKSk9PW51bGw/Jyc6X190KSsKJyIgaHJlZj0iIyI+JysKKChfX3Q9KG5hbWUpKT09bnVsbD8nJzpfX3QpKwonPC9hPlxuPGEgY2xhc3M9InJvb20taW5mbyBpY29uLXJvb20taW5mbyIgZGF0YS1yb29tLWppZD0iJysKKChfX3Q9KGppZCkpPT1udWxsPycnOl9fdCkrCiciXG4gICB0aXRsZT0iJysKKChfX3Q9KGluZm9fdGl0bGUpKT09bnVsbD8nJzpfX3QpKwonIiBocmVmPSIjIj4mbmJzcDs8L2E+XG48L2RkPlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFyb29tX3BhbmVsJywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9Jzxmb3JtIGNsYXNzPSJhZGQtY2hhdHJvb20iIGFjdGlvbj0iIiBtZXRob2Q9InBvc3QiPlxuICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJjaGF0cm9vbSIgY2xhc3M9Im5ldy1jaGF0cm9vbS1uYW1lIlxuICAgICAgICBwbGFjZWhvbGRlcj0iJysKKChfX3Q9KGxhYmVsX3Jvb21fbmFtZSkpPT1udWxsPycnOl9fdCkrCiciLz5cbiAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0ibmljayIgY2xhc3M9Im5ldy1jaGF0cm9vbS1uaWNrIlxuICAgICAgICBwbGFjZWhvbGRlcj0iJysKKChfX3Q9KGxhYmVsX25pY2tuYW1lKSk9PW51bGw/Jyc6X190KSsKJyIvPlxuICAgIDxpbnB1dCB0eXBlPSInKwooKF9fdD0oc2VydmVyX2lucHV0X3R5cGUpKT09bnVsbD8nJzpfX3QpKwonIiBuYW1lPSJzZXJ2ZXIiIGNsYXNzPSJuZXctY2hhdHJvb20tc2VydmVyIlxuICAgICAgICBwbGFjZWhvbGRlcj0iJysKKChfX3Q9KGxhYmVsX3NlcnZlcikpPT1udWxsPycnOl9fdCkrCiciLz5cbiAgICA8aW5wdXQgdHlwZT0ic3VibWl0IiBuYW1lPSJqb2luIiB2YWx1ZT0iJysKKChfX3Q9KGxhYmVsX2pvaW4pKT09bnVsbD8nJzpfX3QpKwonIi8+XG4gICAgPGlucHV0IHR5cGU9ImJ1dHRvbiIgbmFtZT0ic2hvdyIgaWQ9InNob3ctcm9vbXMiIHZhbHVlPSInKwooKF9fdD0obGFiZWxfc2hvd19yb29tcykpPT1udWxsPycnOl9fdCkrCiciLz5cbjwvZm9ybT5cbjxkbCBpZD0iYXZhaWxhYmxlLWNoYXRyb29tcyI+PC9kbD5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhcm9zdGVyJywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9JzxpbnB1dCBzdHlsZT0iZGlzcGxheTogbm9uZTsiIGNsYXNzPSJyb3N0ZXItZmlsdGVyIiBwbGFjZWhvbGRlcj0iJysKKChfX3Q9KHBsYWNlaG9sZGVyKSk9PW51bGw/Jyc6X190KSsKJyI+XG48c2VsZWN0IHN0eWxlPSJkaXNwbGF5OiBub25lOyIgY2xhc3M9ImZpbHRlci10eXBlIj5cbiAgICA8b3B0aW9uIHZhbHVlPSJjb250YWN0cyI+JysKKChfX3Q9KGxhYmVsX2NvbnRhY3RzKSk9PW51bGw/Jyc6X190KSsKJzwvb3B0aW9uPlxuICAgIDxvcHRpb24gdmFsdWU9Imdyb3VwcyI+JysKKChfX3Q9KGxhYmVsX2dyb3VwcykpPT1udWxsPycnOl9fdCkrCic8L29wdGlvbj5cbjwvc2VsZWN0PlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFyb3N0ZXJfaXRlbScsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8YSBjbGFzcz0ib3Blbi1jaGF0IiB0aXRsZT0iJysKKChfX3Q9KGRlc2NfY2hhdCkpPT1udWxsPycnOl9fdCkrCiciIGhyZWY9IiMiPjxzcGFuIGNsYXNzPSJpY29uLScrCigoX190PShjaGF0X3N0YXR1cykpPT1udWxsPycnOl9fdCkrCiciIHRpdGxlPSInKwooKF9fdD0oZGVzY19zdGF0dXMpKT09bnVsbD8nJzpfX3QpKwonIj48L3NwYW4+JysKKChfX3Q9KGZ1bGxuYW1lKSk9PW51bGw/Jyc6X190KSsKJzwvYT5cbjxhIGNsYXNzPSJyZW1vdmUteG1wcC1jb250YWN0IGljb24tcmVtb3ZlIiB0aXRsZT0iJysKKChfX3Q9KGRlc2NfcmVtb3ZlKSk9PW51bGw/Jyc6X190KSsKJyIgaHJlZj0iIyI+PC9hPlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFzZWxlY3Rfb3B0aW9uJywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9JzxvcHRpb24gdmFsdWU9IicrCigoX190PSh2YWx1ZSkpPT1udWxsPycnOl9fdCkrCiciPicrCigoX190PShsYWJlbCkpPT1udWxsPycnOl9fdCkrCic8L29wdGlvbj5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhc2VhcmNoX2NvbnRhY3QnLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGxpPlxuICAgIDxmb3JtIGNsYXNzPSJzZWFyY2gteG1wcC1jb250YWN0Ij5cbiAgICAgICAgPGlucHV0IHR5cGU9InRleHQiXG4gICAgICAgICAgICBuYW1lPSJpZGVudGlmaWVyIlxuICAgICAgICAgICAgY2xhc3M9InVzZXJuYW1lIlxuICAgICAgICAgICAgcGxhY2Vob2xkZXI9IicrCigoX190PShsYWJlbF9jb250YWN0X25hbWUpKT09bnVsbD8nJzpfX3QpKwonIi8+XG4gICAgICAgIDxidXR0b24gdHlwZT0ic3VibWl0Ij4nKwooKF9fdD0obGFiZWxfc2VhcmNoKSk9PW51bGw/Jyc6X190KSsKJzwvYnV0dG9uPlxuICAgIDwvZm9ybT5cbjwvbGk+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIXN0YXR1c19vcHRpb24nLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGxpPlxuICAgIDxhIGhyZWY9IiMiIGNsYXNzPSInKwooKF9fdD0oIHZhbHVlICkpPT1udWxsPycnOl9fdCkrCiciIGRhdGEtdmFsdWU9IicrCigoX190PSggdmFsdWUgKSk9PW51bGw/Jyc6X190KSsKJyI+XG4gICAgICAgIDxzcGFuIGNsYXNzPSJpY29uLScrCigoX190PSggdmFsdWUgKSk9PW51bGw/Jyc6X190KSsKJyI+PC9zcGFuPlxuICAgICAgICAnKwooKF9fdD0oIHRleHQgKSk9PW51bGw/Jyc6X190KSsKJ1xuICAgIDwvYT5cbjwvbGk+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIXRvZ2dsZV9jaGF0cycsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPScnKwooKF9fdD0oTWluaW1pemVkKSk9PW51bGw/Jyc6X190KSsKJyA8c3BhbiBpZD0ibWluaW1pemVkLWNvdW50Ij4oJysKKChfX3Q9KG51bV9taW5pbWl6ZWQpKT09bnVsbD8nJzpfX3QpKwonKTwvc3Bhbj5cbjxzcGFuIGNsYXNzPSJ1bnJlYWQtbWVzc2FnZS1jb3VudCJcbiAgICAnOwogaWYgKCFudW1fdW5yZWFkKSB7IApfX3ArPScgc3R5bGU9ImRpc3BsYXk6IG5vbmUiICc7CiB9IApfX3ArPSdcbiAgICBocmVmPSIjIj4nKwooKF9fdD0obnVtX3VucmVhZCkpPT1udWxsPycnOl9fdCkrCic8L3NwYW4+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIXRvb2xiYXInLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nJzsKIGlmIChzaG93X2Vtb3RpY29ucykgIHsgCl9fcCs9J1xuICAgIDxsaSBjbGFzcz0idG9nZ2xlLXNtaWxleSBpY29uLWhhcHB5IiB0aXRsZT0iSW5zZXJ0IGEgc21pbGVyeSI+XG4gICAgICAgIDx1bD5cbiAgICAgICAgICAgIDxsaT48YSBjbGFzcz0iaWNvbi1zbWlsZXkiIGhyZWY9IiMiIGRhdGEtZW1vdGljb249IjopIj48L2E+PC9saT5cbiAgICAgICAgICAgIDxsaT48YSBjbGFzcz0iaWNvbi13aW5rIiBocmVmPSIjIiBkYXRhLWVtb3RpY29uPSI7KSI+PC9hPjwvbGk+XG4gICAgICAgICAgICA8bGk+PGEgY2xhc3M9Imljb24tZ3JpbiIgaHJlZj0iIyIgZGF0YS1lbW90aWNvbj0iOkQiPjwvYT48L2xpPlxuICAgICAgICAgICAgPGxpPjxhIGNsYXNzPSJpY29uLXRvbmd1ZSIgaHJlZj0iIyIgZGF0YS1lbW90aWNvbj0iOlAiPjwvYT48L2xpPlxuICAgICAgICAgICAgPGxpPjxhIGNsYXNzPSJpY29uLWNvb2wiIGhyZWY9IiMiIGRhdGEtZW1vdGljb249IjgpIj48L2E+PC9saT5cbiAgICAgICAgICAgIDxsaT48YSBjbGFzcz0iaWNvbi1ldmlsIiBocmVmPSIjIiBkYXRhLWVtb3RpY29uPSI+OikiPjwvYT48L2xpPlxuICAgICAgICAgICAgPGxpPjxhIGNsYXNzPSJpY29uLWNvbmZ1c2VkIiBocmVmPSIjIiBkYXRhLWVtb3RpY29uPSI6UyI+PC9hPjwvbGk+XG4gICAgICAgICAgICA8bGk+PGEgY2xhc3M9Imljb24td29uZGVyaW5nIiBocmVmPSIjIiBkYXRhLWVtb3RpY29uPSI6XFwiPjwvYT48L2xpPlxuICAgICAgICAgICAgPGxpPjxhIGNsYXNzPSJpY29uLWFuZ3J5IiBocmVmPSIjIiBkYXRhLWVtb3RpY29uPSI+OigiPjwvYT48L2xpPlxuICAgICAgICAgICAgPGxpPjxhIGNsYXNzPSJpY29uLXNhZCIgaHJlZj0iIyIgZGF0YS1lbW90aWNvbj0iOigiPjwvYT48L2xpPlxuICAgICAgICAgICAgPGxpPjxhIGNsYXNzPSJpY29uLXNob2NrZWQiIGhyZWY9IiMiIGRhdGEtZW1vdGljb249IjpPIj48L2E+PC9saT5cbiAgICAgICAgICAgIDxsaT48YSBjbGFzcz0iaWNvbi10aHVtYnMtdXAiIGhyZWY9IiMiIGRhdGEtZW1vdGljb249IiheLl4pYiI+PC9hPjwvbGk+XG4gICAgICAgICAgICA8bGk+PGEgY2xhc3M9Imljb24taGVhcnQiIGhyZWY9IiMiIGRhdGEtZW1vdGljb249IjwzIj48L2E+PC9saT5cbiAgICAgICAgPC91bD5cbiAgICA8L2xpPlxuJzsKIH0gCl9fcCs9J1xuJzsKIGlmIChzaG93X2NhbGxfYnV0dG9uKSAgeyAKX19wKz0nXG48bGkgY2xhc3M9InRvZ2dsZS1jYWxsIj48YSBjbGFzcz0iaWNvbi1waG9uZSIgdGl0bGU9IicrCigoX190PShsYWJlbF9zdGFydF9jYWxsKSk9PW51bGw/Jyc6X190KSsKJyI+PC9hPjwvbGk+XG4nOwogfSAKX19wKz0nXG4nOwogaWYgKHNob3dfcGFydGljaXBhbnRzX3RvZ2dsZSkgIHsgCl9fcCs9J1xuPGxpIGNsYXNzPSJ0b2dnbGUtcGFydGljaXBhbnRzIj48YSBjbGFzcz0iaWNvbi1oaWRlLXVzZXJzIiB0aXRsZT0iJysKKChfX3Q9KGxhYmVsX2hpZGVfcGFydGljaXBhbnRzKSk9PW51bGw/Jyc6X190KSsKJyI+PC9hPjwvbGk+XG4nOwogfSAKX19wKz0nXG4nOwogaWYgKHNob3dfY2xlYXJfYnV0dG9uKSAgeyAKX19wKz0nXG48bGkgY2xhc3M9InRvZ2dsZS1jbGVhciI+PGEgY2xhc3M9Imljb24tcmVtb3ZlIiB0aXRsZT0iJysKKChfX3Q9KGxhYmVsX2NsZWFyKSk9PW51bGw/Jyc6X190KSsKJyI+PC9hPjwvbGk+XG4nOwogfSAKX19wKz0nXG4nOwogaWYgKGFsbG93X290cikgIHsgCl9fcCs9J1xuICAgIDxsaSBjbGFzcz0idG9nZ2xlLW90ciAnKwooKF9fdD0ob3RyX3N0YXR1c19jbGFzcykpPT1udWxsPycnOl9fdCkrCiciIHRpdGxlPSInKwooKF9fdD0ob3RyX3Rvb2x0aXApKT09bnVsbD8nJzpfX3QpKwonIj5cbiAgICAgICAgPHNwYW4gY2xhc3M9ImNoYXQtdG9vbGJhci10ZXh0Ij4nKwooKF9fdD0ob3RyX3RyYW5zbGF0ZWRfc3RhdHVzKSk9PW51bGw/Jyc6X190KSsKJzwvc3Bhbj5cbiAgICAgICAgJzsKIGlmIChvdHJfc3RhdHVzID09IFVORU5DUllQVEVEKSB7IApfX3ArPSdcbiAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpY29uLXVubG9ja2VkIj48L3NwYW4+XG4gICAgICAgICc7CiB9IApfX3ArPSdcbiAgICAgICAgJzsKIGlmIChvdHJfc3RhdHVzID09IFVOVkVSSUZJRUQpIHsgCl9fcCs9J1xuICAgICAgICAgICAgPHNwYW4gY2xhc3M9Imljb24tbG9jayI+PC9zcGFuPlxuICAgICAgICAnOwogfSAKX19wKz0nXG4gICAgICAgICc7CiBpZiAob3RyX3N0YXR1cyA9PSBWRVJJRklFRCkgeyAKX19wKz0nXG4gICAgICAgICAgICA8c3BhbiBjbGFzcz0iaWNvbi1sb2NrIj48L3NwYW4+XG4gICAgICAgICc7CiB9IApfX3ArPSdcbiAgICAgICAgJzsKIGlmIChvdHJfc3RhdHVzID09IEZJTklTSEVEKSB7IApfX3ArPSdcbiAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpY29uLXVubG9ja2VkIj48L3NwYW4+XG4gICAgICAgICc7CiB9IApfX3ArPSdcbiAgICAgICAgPHVsPlxuICAgICAgICAgICAgJzsKIGlmIChvdHJfc3RhdHVzID09IFVORU5DUllQVEVEKSB7IApfX3ArPSdcbiAgICAgICAgICAgICAgIDxsaT48YSBjbGFzcz0ic3RhcnQtb3RyIiBocmVmPSIjIj4nKwooKF9fdD0obGFiZWxfc3RhcnRfZW5jcnlwdGVkX2NvbnZlcnNhdGlvbikpPT1udWxsPycnOl9fdCkrCic8L2E+PC9saT5cbiAgICAgICAgICAgICc7CiB9IApfX3ArPSdcbiAgICAgICAgICAgICc7CiBpZiAob3RyX3N0YXR1cyAhPSBVTkVOQ1JZUFRFRCkgeyAKX19wKz0nXG4gICAgICAgICAgICAgICA8bGk+PGEgY2xhc3M9InN0YXJ0LW90ciIgaHJlZj0iIyI+JysKKChfX3Q9KGxhYmVsX3JlZnJlc2hfZW5jcnlwdGVkX2NvbnZlcnNhdGlvbikpPT1udWxsPycnOl9fdCkrCic8L2E+PC9saT5cbiAgICAgICAgICAgICAgIDxsaT48YSBjbGFzcz0iZW5kLW90ciIgaHJlZj0iIyI+JysKKChfX3Q9KGxhYmVsX2VuZF9lbmNyeXB0ZWRfY29udmVyc2F0aW9uKSk9PW51bGw/Jyc6X190KSsKJzwvYT48L2xpPlxuICAgICAgICAgICAgICAgPGxpPjxhIGNsYXNzPSJhdXRoLW90ciIgZGF0YS1zY2hlbWU9InNtcCIgaHJlZj0iIyI+JysKKChfX3Q9KGxhYmVsX3ZlcmlmeV93aXRoX3NtcCkpPT1udWxsPycnOl9fdCkrCic8L2E+PC9saT5cbiAgICAgICAgICAgICc7CiB9IApfX3ArPSdcbiAgICAgICAgICAgICc7CiBpZiAob3RyX3N0YXR1cyA9PSBVTlZFUklGSUVEKSB7IApfX3ArPSdcbiAgICAgICAgICAgICAgIDxsaT48YSBjbGFzcz0iYXV0aC1vdHIiIGRhdGEtc2NoZW1lPSJmaW5nZXJwcmludCIgaHJlZj0iIyI+JysKKChfX3Q9KGxhYmVsX3ZlcmlmeV93aXRoX2ZpbmdlcnByaW50cykpPT1udWxsPycnOl9fdCkrCic8L2E+PC9saT5cbiAgICAgICAgICAgICc7CiB9IApfX3ArPSdcbiAgICAgICAgICAgIDxsaT48YSBocmVmPSJodHRwOi8vd3d3LmN5cGhlcnB1bmtzLmNhL290ci9oZWxwLzMuMi4wL2xldmVscy5waHAiIHRhcmdldD0iX2JsYW5rIj4nKwooKF9fdD0obGFiZWxfd2hhdHNfdGhpcykpPT1udWxsPycnOl9fdCkrCic8L2E+PC9saT5cbiAgICAgICAgPC91bD5cbiAgICA8L2xpPlxuJzsKIH0gCl9fcCs9J1xuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCF0cmltbWVkX2NoYXQnLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGEgY2xhc3M9ImNsb3NlLWNoYXRib3gtYnV0dG9uIGljb24tY2xvc2UiPjwvYT5cbjxhIGNsYXNzPSJjaGF0LWhlYWQtbWVzc2FnZS1jb3VudCIgXG4gICAgJzsKIGlmICghbnVtX3VucmVhZCkgeyAKX19wKz0nIHN0eWxlPSJkaXNwbGF5OiBub25lIiAnOwogfSAKX19wKz0nXG4gICAgaHJlZj0iIyI+JysKKChfX3Q9KG51bV91bnJlYWQpKT09bnVsbD8nJzpfX3QpKwonPC9hPlxuPGEgaHJlZj0iIyIgY2xhc3M9InJlc3RvcmUtY2hhdCIgdGl0bGU9IicrCigoX190PSh0b29sdGlwKSk9PW51bGw/Jyc6X190KSsKJyI+XG4gICAgJysKKChfX3Q9KCB0aXRsZSApKT09bnVsbD8nJzpfX3QpKwonXG48L2E+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKZGVmaW5lKCJjb252ZXJzZS10ZW1wbGF0ZXMiLCBbCiAgICAidHBsIWFjdGlvbiIsCiAgICAidHBsIWFkZF9jb250YWN0X2Ryb3Bkb3duIiwKICAgICJ0cGwhYWRkX2NvbnRhY3RfZm9ybSIsCiAgICAidHBsIWNoYW5nZV9zdGF0dXNfbWVzc2FnZSIsCiAgICAidHBsIWNoYXRfc3RhdHVzIiwKICAgICJ0cGwhY2hhdGFyZWEiLAogICAgInRwbCFjaGF0Ym94IiwKICAgICJ0cGwhY2hhdHJvb20iLAogICAgInRwbCFjaGF0cm9vbV9wYXNzd29yZF9mb3JtIiwKICAgICJ0cGwhY2hhdHJvb21fc2lkZWJhciIsCiAgICAidHBsIWNoYXRyb29tc190YWIiLAogICAgInRwbCFjaGF0c19wYW5lbCIsCiAgICAidHBsIWNob29zZV9zdGF0dXMiLAogICAgInRwbCFjb250YWN0c19wYW5lbCIsCiAgICAidHBsIWNvbnRhY3RzX3RhYiIsCiAgICAidHBsIWNvbnRyb2xib3giLAogICAgInRwbCFjb250cm9sYm94X3RvZ2dsZSIsCiAgICAidHBsIWZpZWxkIiwKICAgICJ0cGwhZm9ybV9jaGVja2JveCIsCiAgICAidHBsIWZvcm1faW5wdXQiLAogICAgInRwbCFmb3JtX3NlbGVjdCIsCiAgICAidHBsIWdyb3VwX2hlYWRlciIsCiAgICAidHBsIWluZm8iLAogICAgInRwbCFsb2dpbl9wYW5lbCIsCiAgICAidHBsIWxvZ2luX3RhYiIsCiAgICAidHBsIW1lc3NhZ2UiLAogICAgInRwbCFuZXdfZGF5IiwKICAgICJ0cGwhb2NjdXBhbnQiLAogICAgInRwbCFwZW5kaW5nX2NvbnRhY3QiLAogICAgInRwbCFwZW5kaW5nX2NvbnRhY3RzIiwKICAgICJ0cGwhcmVxdWVzdGluZ19jb250YWN0IiwKICAgICJ0cGwhcmVxdWVzdGluZ19jb250YWN0cyIsCiAgICAidHBsIXJvb21fZGVzY3JpcHRpb24iLAogICAgInRwbCFyb29tX2l0ZW0iLAogICAgInRwbCFyb29tX3BhbmVsIiwKICAgICJ0cGwhcm9zdGVyIiwKICAgICJ0cGwhcm9zdGVyX2l0ZW0iLAogICAgInRwbCFzZWxlY3Rfb3B0aW9uIiwKICAgICJ0cGwhc2VhcmNoX2NvbnRhY3QiLAogICAgInRwbCFzdGF0dXNfb3B0aW9uIiwKICAgICJ0cGwhdG9nZ2xlX2NoYXRzIiwKICAgICJ0cGwhdG9vbGJhciIsCiAgICAidHBsIXRyaW1tZWRfY2hhdCIKXSwgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHsKICAgICAgICBhY3Rpb246ICAgICAgICAgICAgICAgICBhcmd1bWVudHNbMF0sCiAgICAgICAgYWRkX2NvbnRhY3RfZHJvcGRvd246ICAgYXJndW1lbnRzWzFdLAogICAgICAgIGFkZF9jb250YWN0X2Zvcm06ICAgICAgIGFyZ3VtZW50c1syXSwKICAgICAgICBjaGFuZ2Vfc3RhdHVzX21lc3NhZ2U6ICBhcmd1bWVudHNbM10sCiAgICAgICAgY2hhdF9zdGF0dXM6ICAgICAgICAgICAgYXJndW1lbnRzWzRdLAogICAgICAgIGNoYXRhcmVhOiAgICAgICAgICAgICAgIGFyZ3VtZW50c1s1XSwKICAgICAgICBjaGF0Ym94OiAgICAgICAgICAgICAgICBhcmd1bWVudHNbNl0sCiAgICAgICAgY2hhdHJvb206ICAgICAgICAgICAgICAgYXJndW1lbnRzWzddLAogICAgICAgIGNoYXRyb29tX3Bhc3N3b3JkX2Zvcm06IGFyZ3VtZW50c1s4XSwKICAgICAgICBjaGF0cm9vbV9zaWRlYmFyOiAgICAgICBhcmd1bWVudHNbOV0sCiAgICAgICAgY2hhdHJvb21zX3RhYjogICAgICAgICAgYXJndW1lbnRzWzEwXSwKICAgICAgICBjaGF0c19wYW5lbDogICAgICAgICAgICBhcmd1bWVudHNbMTFdLAogICAgICAgIGNob29zZV9zdGF0dXM6ICAgICAgICAgIGFyZ3VtZW50c1sxMl0sCiAgICAgICAgY29udGFjdHNfcGFuZWw6ICAgICAgICAgYXJndW1lbnRzWzEzXSwKICAgICAgICBjb250YWN0c190YWI6ICAgICAgICAgICBhcmd1bWVudHNbMTRdLAogICAgICAgIGNvbnRyb2xib3g6ICAgICAgICAgICAgIGFyZ3VtZW50c1sxNV0sCiAgICAgICAgY29udHJvbGJveF90b2dnbGU6ICAgICAgYXJndW1lbnRzWzE2XSwKICAgICAgICBmaWVsZDogICAgICAgICAgICAgICAgICBhcmd1bWVudHNbMTddLAogICAgICAgIGZvcm1fY2hlY2tib3g6ICAgICAgICAgIGFyZ3VtZW50c1sxOF0sCiAgICAgICAgZm9ybV9pbnB1dDogICAgICAgICAgICAgYXJndW1lbnRzWzE5XSwKICAgICAgICBmb3JtX3NlbGVjdDogICAgICAgICAgICBhcmd1bWVudHNbMjBdLAogICAgICAgIGdyb3VwX2hlYWRlcjogICAgICAgICAgIGFyZ3VtZW50c1syMV0sCiAgICAgICAgaW5mbzogICAgICAgICAgICAgICAgICAgYXJndW1lbnRzWzIyXSwKICAgICAgICBsb2dpbl9wYW5lbDogICAgICAgICAgICBhcmd1bWVudHNbMjNdLAogICAgICAgIGxvZ2luX3RhYjogICAgICAgICAgICAgIGFyZ3VtZW50c1syNF0sCiAgICAgICAgbWVzc2FnZTogICAgICAgICAgICAgICAgYXJndW1lbnRzWzI1XSwKICAgICAgICBuZXdfZGF5OiAgICAgICAgICAgICAgICBhcmd1bWVudHNbMjZdLAogICAgICAgIG9jY3VwYW50OiAgICAgICAgICAgICAgIGFyZ3VtZW50c1syN10sCiAgICAgICAgcGVuZGluZ19jb250YWN0OiAgICAgICAgYXJndW1lbnRzWzI4XSwKICAgICAgICBwZW5kaW5nX2NvbnRhY3RzOiAgICAgICBhcmd1bWVudHNbMjldLAogICAgICAgIHJlcXVlc3RpbmdfY29udGFjdDogICAgIGFyZ3VtZW50c1szMF0sCiAgICAgICAgcmVxdWVzdGluZ19jb250YWN0czogICAgYXJndW1lbnRzWzMxXSwKICAgICAgICByb29tX2Rlc2NyaXB0aW9uOiAgICAgICBhcmd1bWVudHNbMzJdLAogICAgICAgIHJvb21faXRlbTogICAgICAgICAgICAgIGFyZ3VtZW50c1szM10sCiAgICAgICAgcm9vbV9wYW5lbDogICAgICAgICAgICAgYXJndW1lbnRzWzM0XSwKICAgICAgICByb3N0ZXI6ICAgICAgICAgICAgICAgICBhcmd1bWVudHNbMzVdLAogICAgICAgIHJvc3Rlcl9pdGVtOiAgICAgICAgICAgIGFyZ3VtZW50c1szNl0sCiAgICAgICAgc2VsZWN0X29wdGlvbjogICAgICAgICAgYXJndW1lbnRzWzM3XSwKICAgICAgICBzZWFyY2hfY29udGFjdDogICAgICAgICBhcmd1bWVudHNbMzhdLAogICAgICAgIHN0YXR1c19vcHRpb246ICAgICAgICAgIGFyZ3VtZW50c1szOV0sCiAgICAgICAgdG9nZ2xlX2NoYXRzOiAgICAgICAgICAgYXJndW1lbnRzWzQwXSwKICAgICAgICB0b29sYmFyOiAgICAgICAgICAgICAgICBhcmd1bWVudHNbNDFdLAogICAgICAgIHRyaW1tZWRfY2hhdDogICAgICAgICAgIGFyZ3VtZW50c1s0Ml0KICAgIH07Cn0pOwoKLyohCiAqIENvbnZlcnNlLmpzIChXZWItYmFzZWQgWE1QUCBpbnN0YW50IG1lc3NhZ2luZyBjbGllbnQpCiAqIGh0dHA6Ly9jb252ZXJzZWpzLm9yZwogKgogKiBDb3B5cmlnaHQgKGMpIDIwMTIsIEphbi1DYXJlbCBCcmFuZCA8amNAb3Brb2RlLmNvbT4KICogTGljZW5zZWQgdW5kZXIgdGhlIE1vemlsbGEgUHVibGljIExpY2Vuc2UgKE1QTCkKICovCgovLyBBTUQvZ2xvYmFsIHJlZ2lzdHJhdGlvbnMKKGZ1bmN0aW9uIChyb290LCBmYWN0b3J5KSB7CiAgICBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgZGVmaW5lKCJjb252ZXJzZSIsCiAgICAgICAgICAgICAgWyJjb252ZXJzZS1kZXBlbmRlbmNpZXMiLCAiY29udmVyc2UtdGVtcGxhdGVzIl0sCiAgICAgICAgICAgIGZ1bmN0aW9uIChkZXBlbmRlbmNpZXMsIHRlbXBsYXRlcykgewogICAgICAgICAgICAgICAgdmFyIG90ciA9IGRlcGVuZGVuY2llcy5vdHI7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG90ciAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFjdG9yeSgKICAgICAgICAgICAgICAgICAgICAgICAgZGVwZW5kZW5jaWVzLmpRdWVyeSwKICAgICAgICAgICAgICAgICAgICAgICAgXywKICAgICAgICAgICAgICAgICAgICAgICAgb3RyLk9UUiwKICAgICAgICAgICAgICAgICAgICAgICAgb3RyLkRTQSwKICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVzLAogICAgICAgICAgICAgICAgICAgICAgICBkZXBlbmRlbmNpZXMubW9tZW50LAogICAgICAgICAgICAgICAgICAgICAgICBkZXBlbmRlbmNpZXMudXRpbHMKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFjdG9yeSgKICAgICAgICAgICAgICAgICAgICAgICAgZGVwZW5kZW5jaWVzLmpRdWVyeSwKICAgICAgICAgICAgICAgICAgICAgICAgXywKICAgICAgICAgICAgICAgICAgICAgICAgdW5kZWZpbmVkLAogICAgICAgICAgICAgICAgICAgICAgICB1bmRlZmluZWQsCiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlcywKICAgICAgICAgICAgICAgICAgICAgICAgZGVwZW5kZW5jaWVzLm1vbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgZGVwZW5kZW5jaWVzLnV0aWxzCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICk7CiAgICB9IGVsc2UgewogICAgICAgIHJvb3QuY29udmVyc2UgPSBmYWN0b3J5KGpRdWVyeSwgXywgT1RSLCBEU0EsIEpTVCwgbW9tZW50LCB1dGlscyk7CiAgICB9Cn0odGhpcywgZnVuY3Rpb24gKCQsIF8sIE9UUiwgRFNBLCB0ZW1wbGF0ZXMsIG1vbWVudCwgdXRpbHMpIHsKICAgIC8vIAogICAgLy8gQ2Fubm90IHVzZSB0aGlzIGR1ZSB0byBTYWZhcmkgYnVnLgogICAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9qY2JyYW5kL2NvbnZlcnNlLmpzL2lzc3Vlcy8xOTYKICAgIGlmICh0eXBlb2YgY29uc29sZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGNvbnNvbGUubG9nID09PSAidW5kZWZpbmVkIikgewogICAgICAgIGNvbnNvbGUgPSB7IGxvZzogZnVuY3Rpb24gKCkge30sIGVycm9yOiBmdW5jdGlvbiAoKSB7fSB9OwogICAgfQoKICAgIC8vIENvbmZpZ3VyYXRpb24gb2YgdW5kZXJzY29yZSB0ZW1wbGF0ZXMgKHRoaXMgY29uZmlnIGlzIGRpc3RpY3QgdG8gdGhlCiAgICAvLyBjb25maWcgb2YgcmVxdWlyZWpzLXRwbCBpbiBtYWluLmpzKS4gVGhpcyBvbmUgaXMgZm9yIG5vcm1hbCBpbmxpbmUKICAgIC8vIHRlbXBsYXRlcy4KICAgIC8vIFVzZSBNdXN0YWNoZSBzdHlsZSBzeW50YXggZm9yIHZhcmlhYmxlIGludGVycG9sYXRpb24KICAgIF8udGVtcGxhdGVTZXR0aW5ncyA9IHsKICAgICAgICBldmFsdWF0ZSA6IC9ce1xbKFtcc1xTXSs/KVxdXH0vZywKICAgICAgICBpbnRlcnBvbGF0ZSA6IC9ce1x7KFtcc1xTXSs/KVx9XH0vZwogICAgfTsKCiAgICB2YXIgY29udGFpbnMgPSBmdW5jdGlvbiAoYXR0ciwgcXVlcnkpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBhdHRyID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gZmFsc2U7CiAgICAgICAgICAgICAgICBfLmVhY2goYXR0ciwgZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlIHx8IGl0ZW0uZ2V0KGEpLnRvTG93ZXJDYXNlKCkuaW5kZXhPZihxdWVyeS50b0xvd2VyQ2FzZSgpKSAhPT0gLTE7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXR0ciA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpdGVtLmdldChhdHRyKS50b0xvd2VyQ2FzZSgpLmluZGV4T2YocXVlcnkudG9Mb3dlckNhc2UoKSkgIT09IC0xOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdXcm9uZyBhdHRyaWJ1dGUgdHlwZS4gTXVzdCBiZSBzdHJpbmcgb3IgYXJyYXkuJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfTsKICAgIGNvbnRhaW5zLm5vdCA9IGZ1bmN0aW9uIChhdHRyLCBxdWVyeSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoaXRlbSkgewogICAgICAgICAgICByZXR1cm4gIShjb250YWlucyhhdHRyLCBxdWVyeSkoaXRlbSkpOwogICAgICAgIH07CiAgICB9OwoKICAgIC8vIFhYWDogdGhlc2UgY2FuIHBlcmhhcHMgYmUgbW92ZWQgdG8gc3JjL3BvbHlmaWxscy5qcwogICAgU3RyaW5nLnByb3RvdHlwZS5zcGxpdE9uY2UgPSBmdW5jdGlvbiAoZGVsaW1pdGVyKSB7CiAgICAgICAgdmFyIGNvbXBvbmVudHMgPSB0aGlzLnNwbGl0KGRlbGltaXRlcik7CiAgICAgICAgcmV0dXJuIFtjb21wb25lbnRzLnNoaWZ0KCksIGNvbXBvbmVudHMuam9pbihkZWxpbWl0ZXIpXTsKICAgIH07CgogICAgJC5mbi5hZGRFbW90aWNvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKGNvbnZlcnNlLnZpc2libGVfdG9vbGJhcl9idXR0b25zLmVtb3RpY29ucykgewogICAgICAgICAgICBpZiAodGhpcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24gKGksIG9iaikgewogICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gJChvYmopLmh0bWwoKTsKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC8mZ3Q7OlwpL2csICc8c3BhbiBjbGFzcz0iZW1vdGljb24gaWNvbi1ldmlsIj48L3NwYW4+Jyk7CiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvOlwpL2csICc8c3BhbiBjbGFzcz0iZW1vdGljb24gaWNvbi1zbWlsZXkiPjwvc3Bhbj4nKTsKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC86XC1cKS9nLCAnPHNwYW4gY2xhc3M9ImVtb3RpY29uIGljb24tc21pbGV5Ij48L3NwYW4+Jyk7CiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvO1wpL2csICc8c3BhbiBjbGFzcz0iZW1vdGljb24gaWNvbi13aW5rIj48L3NwYW4+Jyk7CiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvO1wtXCkvZywgJzxzcGFuIGNsYXNzPSJlbW90aWNvbiBpY29uLXdpbmsiPjwvc3Bhbj4nKTsKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC86RC9nLCAnPHNwYW4gY2xhc3M9ImVtb3RpY29uIGljb24tZ3JpbiI+PC9zcGFuPicpOwogICAgICAgICAgICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoLzpcLUQvZywgJzxzcGFuIGNsYXNzPSJlbW90aWNvbiBpY29uLWdyaW4iPjwvc3Bhbj4nKTsKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC86UC9nLCAnPHNwYW4gY2xhc3M9ImVtb3RpY29uIGljb24tdG9uZ3VlIj48L3NwYW4+Jyk7CiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvOlwtUC9nLCAnPHNwYW4gY2xhc3M9ImVtb3RpY29uIGljb24tdG9uZ3VlIj48L3NwYW4+Jyk7CiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvOnAvZywgJzxzcGFuIGNsYXNzPSJlbW90aWNvbiBpY29uLXRvbmd1ZSI+PC9zcGFuPicpOwogICAgICAgICAgICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoLzpcLXAvZywgJzxzcGFuIGNsYXNzPSJlbW90aWNvbiBpY29uLXRvbmd1ZSI+PC9zcGFuPicpOwogICAgICAgICAgICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoLzhcKS9nLCAnPHNwYW4gY2xhc3M9ImVtb3RpY29uIGljb24tY29vbCI+PC9zcGFuPicpOwogICAgICAgICAgICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoLzpTL2csICc8c3BhbiBjbGFzcz0iZW1vdGljb24gaWNvbi1jb25mdXNlZCI+PC9zcGFuPicpOwogICAgICAgICAgICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoLzpcXC9nLCAnPHNwYW4gY2xhc3M9ImVtb3RpY29uIGljb24td29uZGVyaW5nIj48L3NwYW4+Jyk7CiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvOlwvIC9nLCAnPHNwYW4gY2xhc3M9ImVtb3RpY29uIGljb24td29uZGVyaW5nIj48L3NwYW4+Jyk7CiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvJmd0OzpcKC9nLCAnPHNwYW4gY2xhc3M9ImVtb3RpY29uIGljb24tYW5ncnkiPjwvc3Bhbj4nKTsKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC86XCgvZywgJzxzcGFuIGNsYXNzPSJlbW90aWNvbiBpY29uLXNhZCI+PC9zcGFuPicpOwogICAgICAgICAgICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoLzpcLVwoL2csICc8c3BhbiBjbGFzcz0iZW1vdGljb24gaWNvbi1zYWQiPjwvc3Bhbj4nKTsKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC86Ty9nLCAnPHNwYW4gY2xhc3M9ImVtb3RpY29uIGljb24tc2hvY2tlZCI+PC9zcGFuPicpOwogICAgICAgICAgICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoLzpcLU8vZywgJzxzcGFuIGNsYXNzPSJlbW90aWNvbiBpY29uLXNob2NrZWQiPjwvc3Bhbj4nKTsKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC9cPVwtTy9nLCAnPHNwYW4gY2xhc3M9ImVtb3RpY29uIGljb24tc2hvY2tlZCI+PC9zcGFuPicpOwogICAgICAgICAgICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoL1woXF4uXF5cKWIvZywgJzxzcGFuIGNsYXNzPSJlbW90aWNvbiBpY29uLXRodW1icy11cCI+PC9zcGFuPicpOwogICAgICAgICAgICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoLyZsdDszL2csICc8c3BhbiBjbGFzcz0iZW1vdGljb24gaWNvbi1oZWFydCI+PC9zcGFuPicpOwogICAgICAgICAgICAgICAgICAgICQob2JqKS5odG1sKHRleHQpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIHZhciBwbGF5Tm90aWZpY2F0aW9uID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBhdWRpbzsKICAgICAgICBpZiAoY29udmVyc2UucGxheV9zb3VuZHMgJiYgdHlwZW9mIEF1ZGlvICE9PSAidW5kZWZpbmVkIil7CiAgICAgICAgICAgIGF1ZGlvID0gbmV3IEF1ZGlvKCJzb3VuZHMvbXNnX3JlY2VpdmVkLm9nZyIpOwogICAgICAgICAgICBpZiAoYXVkaW8uY2FuUGxheVR5cGUoJy9hdWRpby9vZ2cnKSkgewogICAgICAgICAgICAgICAgYXVkaW8ucGxheSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYXVkaW8gPSBuZXcgQXVkaW8oIi9zb3VuZHMvbXNnX3JlY2VpdmVkLm1wMyIpOwogICAgICAgICAgICAgICAgYXVkaW8ucGxheSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICB2YXIgY29udmVyc2UgPSB7CiAgICAgICAgcGx1Z2luczoge30sCiAgICAgICAgdGVtcGxhdGVzOiB0ZW1wbGF0ZXMsCiAgICAgICAgZW1pdDogZnVuY3Rpb24gKGV2dCwgZGF0YSkgewogICAgICAgICAgICAkKHRoaXMpLnRyaWdnZXIoZXZ0LCBkYXRhKTsKICAgICAgICB9LAogICAgICAgIG9uY2U6IGZ1bmN0aW9uIChldnQsIGhhbmRsZXIpIHsKICAgICAgICAgICAgJCh0aGlzKS5vbmUoZXZ0LCBoYW5kbGVyKTsKICAgICAgICB9LAogICAgICAgIG9uOiBmdW5jdGlvbiAoZXZ0LCBoYW5kbGVyKSB7CiAgICAgICAgICAgICQodGhpcykuYmluZChldnQsIGhhbmRsZXIpOwogICAgICAgIH0sCiAgICAgICAgb2ZmOiBmdW5jdGlvbiAoZXZ0LCBoYW5kbGVyKSB7CiAgICAgICAgICAgICQodGhpcykudW5iaW5kKGV2dCwgaGFuZGxlcik7CiAgICAgICAgfSwKICAgICAgICByZWZyZXNoV2Via2l0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIC8qIFRoaXMgd29ya3MgYXJvdW5kIGEgd2Via2l0IGJ1Zy4gUmVmcmVzaCB0aGUgYnJvd3NlcidzIHZpZXdwb3J0LAogICAgICAgICAgICAqIG90aGVyd2lzZSBjaGF0Ym94ZXMgYXJlIG5vdCBtb3ZlZCBhbG9uZyB3aGVuIG9uZSBpcyBjbG9zZWQuCiAgICAgICAgICAgICovCiAgICAgICAgICAgIGlmICgkLmJyb3dzZXIud2Via2l0KSB7CiAgICAgICAgICAgICAgICB2YXIgY29udmVyc2VqcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb252ZXJzZWpzJyk7CiAgICAgICAgICAgICAgICBjb252ZXJzZWpzLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICBjb252ZXJzZWpzLm9mZnNldEhlaWdodCA9IGNvbnZlcnNlanMub2Zmc2V0SGVpZ2h0OwogICAgICAgICAgICAgICAgY29udmVyc2Vqcy5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgogICAgY29udmVyc2UuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uIChzZXR0aW5ncywgY2FsbGJhY2spIHsKICAgICAgICB2YXIgY29udmVyc2UgPSB0aGlzOwoKICAgICAgICAvLyBDb25zdGFudHMKICAgICAgICAvLyAtLS0tLS0tLS0KICAgICAgICB2YXIgVU5FTkNSWVBURUQgPSAwOwogICAgICAgIHZhciBVTlZFUklGSUVEPSAxOwogICAgICAgIHZhciBWRVJJRklFRD0gMjsKICAgICAgICB2YXIgRklOSVNIRUQgPSAzOwogICAgICAgIHZhciBLRVkgPSB7CiAgICAgICAgICAgIEVOVEVSOiAxMwogICAgICAgIH07CiAgICAgICAgdmFyIFNUQVRVU19XRUlHSFRTID0gewogICAgICAgICAgICAnb2ZmbGluZSc6ICAgICAgNiwKICAgICAgICAgICAgJ3VuYXZhaWxhYmxlJzogIDUsCiAgICAgICAgICAgICd4YSc6ICAgICAgICAgICA0LAogICAgICAgICAgICAnYXdheSc6ICAgICAgICAgMywKICAgICAgICAgICAgJ2RuZCc6ICAgICAgICAgIDIsCiAgICAgICAgICAgICdvbmxpbmUnOiAgICAgICAxCiAgICAgICAgfTsKCiAgICAgICAgdmFyIElOQUNUSVZFID0gJ2luYWN0aXZlJzsKICAgICAgICB2YXIgQUNUSVZFID0gJ2FjdGl2ZSc7CiAgICAgICAgdmFyIENPTVBPU0lORyA9ICdjb21wb3NpbmcnOwogICAgICAgIHZhciBQQVVTRUQgPSAncGF1c2VkJzsKICAgICAgICB2YXIgR09ORSA9ICdnb25lJzsKCiAgICAgICAgdmFyIEhBU19DU1BSTkcgPSAoKHR5cGVvZiBjcnlwdG8gIT09ICd1bmRlZmluZWQnKSAmJgogICAgICAgICAgICAoKHR5cGVvZiBjcnlwdG8ucmFuZG9tQnl0ZXMgPT09ICdmdW5jdGlvbicpIHx8CiAgICAgICAgICAgICAgICAodHlwZW9mIGNyeXB0by5nZXRSYW5kb21WYWx1ZXMgPT09ICdmdW5jdGlvbicpCiAgICAgICAgKSk7CiAgICAgICAgdmFyIEhBU19DUllQVE8gPSBIQVNfQ1NQUk5HICYmICgKICAgICAgICAgICAgKHR5cGVvZiBDcnlwdG9KUyAhPT0gInVuZGVmaW5lZCIpICYmCiAgICAgICAgICAgICh0eXBlb2YgT1RSICE9PSAidW5kZWZpbmVkIikgJiYKICAgICAgICAgICAgKHR5cGVvZiBEU0EgIT09ICJ1bmRlZmluZWQiKQogICAgICAgICk7CgogICAgICAgIHZhciBPUEVORUQgPSAnb3BlbmVkJzsKICAgICAgICB2YXIgQ0xPU0VEID0gJ2Nsb3NlZCc7CgogICAgICAgIC8vIERlZmF1bHQgY29uZmlndXJhdGlvbiB2YWx1ZXMKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgdGhpcy5hbGxvd19jb250YWN0X3JlcXVlc3RzID0gdHJ1ZTsKICAgICAgICB0aGlzLmFsbG93X2RyYWdyZXNpemUgPSB0cnVlOwogICAgICAgIHRoaXMuYWxsb3dfbG9nb3V0ID0gdHJ1ZTsKICAgICAgICB0aGlzLmFsbG93X211YyA9IHRydWU7CiAgICAgICAgdGhpcy5hbGxvd19vdHIgPSB0cnVlOwogICAgICAgIHRoaXMuYW5pbWF0ZSA9IHRydWU7CiAgICAgICAgdGhpcy5hdXRvX2xpc3Rfcm9vbXMgPSBmYWxzZTsKICAgICAgICB0aGlzLmF1dG9fcmVjb25uZWN0ID0gZmFsc2U7CiAgICAgICAgdGhpcy5hdXRvX3N1YnNjcmliZSA9IGZhbHNlOwogICAgICAgIHRoaXMuYm9zaF9zZXJ2aWNlX3VybCA9IHVuZGVmaW5lZDsgLy8gVGhlIEJPU0ggY29ubmVjdGlvbiBtYW5hZ2VyIFVSTC4KICAgICAgICB0aGlzLmNhY2hlX290cl9rZXkgPSBmYWxzZTsKICAgICAgICB0aGlzLmRlYnVnID0gZmFsc2U7CiAgICAgICAgdGhpcy5kZWZhdWx0X2JveF9oZWlnaHQgPSAzMjQ7IC8vIFRoZSBkZWZhdWx0IGhlaWdodCwgaW4gcGl4ZWxzLCBmb3IgdGhlIGNvbnRyb2wgYm94LCBjaGF0IGJveGVzIGFuZCBjaGF0cm9vbXMuCiAgICAgICAgdGhpcy5leHBvc2VfcmlkX2FuZF9zaWQgPSBmYWxzZTsKICAgICAgICB0aGlzLmZvcndhcmRfbWVzc2FnZXMgPSBmYWxzZTsKICAgICAgICB0aGlzLmhpZGVfbXVjX3NlcnZlciA9IGZhbHNlOwogICAgICAgIHRoaXMuaTE4biA9IGxvY2FsZXMuZW47CiAgICAgICAgdGhpcy5rZWVwYWxpdmUgPSBmYWxzZTsKICAgICAgICB0aGlzLm1lc3NhZ2VfY2FyYm9ucyA9IGZhbHNlOwogICAgICAgIHRoaXMubm9fdHJpbW1pbmcgPSBmYWxzZTsgLy8gU2V0IHRvIHRydWUgZm9yIHBoYW50b21qcyB0ZXN0cyAod2hlcmUgYnJvd3NlciBhcHBhcmVudGx5IGhhcyBubyB3aWR0aCkKICAgICAgICB0aGlzLnBsYXlfc291bmRzID0gZmFsc2U7CiAgICAgICAgdGhpcy5wcmViaW5kID0gZmFsc2U7CiAgICAgICAgdGhpcy5yb3N0ZXJfZ3JvdXBzID0gZmFsc2U7CiAgICAgICAgdGhpcy5zaG93X2NvbnRyb2xib3hfYnlfZGVmYXVsdCA9IGZhbHNlOwogICAgICAgIHRoaXMuc2hvd19vbmx5X29ubGluZV91c2VycyA9IGZhbHNlOwogICAgICAgIHRoaXMuc2hvd190b29sYmFyID0gdHJ1ZTsKICAgICAgICB0aGlzLnN0b3JhZ2UgPSAnc2Vzc2lvbic7CiAgICAgICAgdGhpcy51c2Vfb3RyX2J5X2RlZmF1bHQgPSBmYWxzZTsKICAgICAgICB0aGlzLnVzZV92Y2FyZHMgPSB0cnVlOwogICAgICAgIHRoaXMudmlzaWJsZV90b29sYmFyX2J1dHRvbnMgPSB7CiAgICAgICAgICAgICdlbW90aWNvbnMnOiB0cnVlLAogICAgICAgICAgICAnY2FsbCc6IGZhbHNlLAogICAgICAgICAgICAnY2xlYXInOiB0cnVlLAogICAgICAgICAgICAndG9nZ2xlX3BhcnRpY2lwYW50cyc6IHRydWUKICAgICAgICB9OwogICAgICAgIHRoaXMueGhyX2N1c3RvbV9zdGF0dXMgPSBmYWxzZTsKICAgICAgICB0aGlzLnhocl9jdXN0b21fc3RhdHVzX3VybCA9ICcnOwogICAgICAgIHRoaXMueGhyX3VzZXJfc2VhcmNoID0gZmFsc2U7CiAgICAgICAgdGhpcy54aHJfdXNlcl9zZWFyY2hfdXJsID0gJyc7CgogICAgICAgIC8vIEFsbG93IG9ubHkgd2hpdGVsaXN0ZWQgY29uZmlndXJhdGlvbiBhdHRyaWJ1dGVzIHRvIGJlIG92ZXJ3cml0dGVuCiAgICAgICAgXy5leHRlbmQodGhpcywgXy5waWNrKHNldHRpbmdzLCBbCiAgICAgICAgICAgICdhbGxvd19jb250YWN0X3JlcXVlc3RzJywKICAgICAgICAgICAgJ2FsbG93X2RyYWdyZXNpemUnLAogICAgICAgICAgICAnYWxsb3dfbG9nb3V0JywKICAgICAgICAgICAgJ2FsbG93X211YycsCiAgICAgICAgICAgICdhbGxvd19vdHInLAogICAgICAgICAgICAnYW5pbWF0ZScsCiAgICAgICAgICAgICdhdXRvX2xpc3Rfcm9vbXMnLAogICAgICAgICAgICAnYXV0b19yZWNvbm5lY3QnLAogICAgICAgICAgICAnYXV0b19zdWJzY3JpYmUnLAogICAgICAgICAgICAnYm9zaF9zZXJ2aWNlX3VybCcsCiAgICAgICAgICAgICdjYWNoZV9vdHJfa2V5JywKICAgICAgICAgICAgJ2Nvbm5lY3Rpb24nLAogICAgICAgICAgICAnZGVidWcnLAogICAgICAgICAgICAnZGVmYXVsdF9ib3hfaGVpZ2h0JywKICAgICAgICAgICAgJ2tlZXBhbGl2ZScsCiAgICAgICAgICAgICdtZXNzYWdlX2NhcmJvbnMnLAogICAgICAgICAgICAnZXhwb3NlX3JpZF9hbmRfc2lkJywKICAgICAgICAgICAgJ2ZvcndhcmRfbWVzc2FnZXMnLAogICAgICAgICAgICAnZnVsbG5hbWUnLAogICAgICAgICAgICAnaGlkZV9tdWNfc2VydmVyJywKICAgICAgICAgICAgJ2kxOG4nLAogICAgICAgICAgICAnamlkJywKICAgICAgICAgICAgJ25vX3RyaW1taW5nJywKICAgICAgICAgICAgJ3BsYXlfc291bmRzJywKICAgICAgICAgICAgJ3ByZWJpbmQnLAogICAgICAgICAgICAncmlkJywKICAgICAgICAgICAgJ3Jvc3Rlcl9ncm91cHMnLAogICAgICAgICAgICAnc2hvd19jb250cm9sYm94X2J5X2RlZmF1bHQnLAogICAgICAgICAgICAnc2hvd19vbmx5X29ubGluZV91c2VycycsCiAgICAgICAgICAgICdzaG93X3Rvb2xiYXInLAogICAgICAgICAgICAnc2lkJywKICAgICAgICAgICAgJ3N0b3JhZ2UnLAogICAgICAgICAgICAndXNlX290cl9ieV9kZWZhdWx0JywKICAgICAgICAgICAgJ3VzZV92Y2FyZHMnLAogICAgICAgICAgICAneGhyX2N1c3RvbV9zdGF0dXMnLAogICAgICAgICAgICAneGhyX2N1c3RvbV9zdGF0dXNfdXJsJywKICAgICAgICAgICAgJ3hocl91c2VyX3NlYXJjaCcsCiAgICAgICAgICAgICd4aHJfdXNlcl9zZWFyY2hfdXJsJwogICAgICAgIF0pKTsKICAgICAgICBpZiAoc2V0dGluZ3MudmlzaWJsZV90b29sYmFyX2J1dHRvbnMpIHsKICAgICAgICAgICAgXy5leHRlbmQoCiAgICAgICAgICAgICAgICB0aGlzLnZpc2libGVfdG9vbGJhcl9idXR0b25zLAogICAgICAgICAgICAgICAgXy5waWNrKHNldHRpbmdzLnZpc2libGVfdG9vbGJhcl9idXR0b25zLCBbCiAgICAgICAgICAgICAgICAgICAgJ2Vtb3RpY29ucycsICdjYWxsJywgJ2NsZWFyJywgJ3RvZ2dsZV9wYXJ0aWNpcGFudHMnCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgICkpOwogICAgICAgIH0KICAgICAgICAkLmZ4Lm9mZiA9ICF0aGlzLmFuaW1hdGU7CgogICAgICAgIC8vIE9ubHkgYWxsb3cgT1RSIGlmIHdlIGhhdmUgdGhlIGNhcGFiaWxpdHkKICAgICAgICB0aGlzLmFsbG93X290ciA9IHRoaXMuYWxsb3dfb3RyICYmIEhBU19DUllQVE87CgogICAgICAgIC8vIE9ubHkgdXNlIE9UUiBieSBkZWZhdWx0IGlmIGFsbG93IE9UUiBpcyBlbmFibGVkIHRvIGJlZ2luIHdpdGgKICAgICAgICB0aGlzLnVzZV9vdHJfYnlfZGVmYXVsdCA9IHRoaXMudXNlX290cl9ieV9kZWZhdWx0ICYmIHRoaXMuYWxsb3dfb3RyOwoKICAgICAgICAvLyBUcmFuc2xhdGlvbiBtYWNoaW5lcnkKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICB2YXIgX18gPSAkLnByb3h5KHV0aWxzLl9fLCB0aGlzKTsKICAgICAgICB2YXIgX19fID0gdXRpbHMuX19fOwogICAgICAgIC8vIFRyYW5zbGF0aW9uIGF3YXJlIGNvbnN0YW50cwogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIHZhciBPVFJfQ0xBU1NfTUFQUElORyA9IHt9OwogICAgICAgIE9UUl9DTEFTU19NQVBQSU5HW1VORU5DUllQVEVEXSA9ICd1bmVuY3J5cHRlZCc7CiAgICAgICAgT1RSX0NMQVNTX01BUFBJTkdbVU5WRVJJRklFRF0gPSAndW52ZXJpZmllZCc7CiAgICAgICAgT1RSX0NMQVNTX01BUFBJTkdbVkVSSUZJRURdID0gJ3ZlcmlmaWVkJzsKICAgICAgICBPVFJfQ0xBU1NfTUFQUElOR1tGSU5JU0hFRF0gPSAnZmluaXNoZWQnOwoKICAgICAgICB2YXIgT1RSX1RSQU5TTEFURURfTUFQUElORyAgPSB7fTsKICAgICAgICBPVFJfVFJBTlNMQVRFRF9NQVBQSU5HW1VORU5DUllQVEVEXSA9IF9fKCd1bmVuY3J5cHRlZCcpOwogICAgICAgIE9UUl9UUkFOU0xBVEVEX01BUFBJTkdbVU5WRVJJRklFRF0gPSBfXygndW52ZXJpZmllZCcpOwogICAgICAgIE9UUl9UUkFOU0xBVEVEX01BUFBJTkdbVkVSSUZJRURdID0gX18oJ3ZlcmlmaWVkJyk7CiAgICAgICAgT1RSX1RSQU5TTEFURURfTUFQUElOR1tGSU5JU0hFRF0gPSBfXygnZmluaXNoZWQnKTsKCiAgICAgICAgdmFyIFNUQVRVU0VTID0gewogICAgICAgICAgICAnZG5kJzogX18oJ1RoaXMgY29udGFjdCBpcyBidXN5JyksCiAgICAgICAgICAgICdvbmxpbmUnOiBfXygnVGhpcyBjb250YWN0IGlzIG9ubGluZScpLAogICAgICAgICAgICAnb2ZmbGluZSc6IF9fKCdUaGlzIGNvbnRhY3QgaXMgb2ZmbGluZScpLAogICAgICAgICAgICAndW5hdmFpbGFibGUnOiBfXygnVGhpcyBjb250YWN0IGlzIHVuYXZhaWxhYmxlJyksCiAgICAgICAgICAgICd4YSc6IF9fKCdUaGlzIGNvbnRhY3QgaXMgYXdheSBmb3IgYW4gZXh0ZW5kZWQgcGVyaW9kJyksCiAgICAgICAgICAgICdhd2F5JzogX18oJ1RoaXMgY29udGFjdCBpcyBhd2F5JykKICAgICAgICB9OwogICAgICAgIHZhciBERVNDX0dST1VQX1RPR0dMRSA9IF9fKCdDbGljayB0byBoaWRlIHRoZXNlIGNvbnRhY3RzJyk7CgogICAgICAgIHZhciBIRUFERVJfQ1VSUkVOVF9DT05UQUNUUyA9ICBfXygnTXkgY29udGFjdHMnKTsKICAgICAgICB2YXIgSEVBREVSX1BFTkRJTkdfQ09OVEFDVFMgPSBfXygnUGVuZGluZyBjb250YWN0cycpOwogICAgICAgIHZhciBIRUFERVJfUkVRVUVTVElOR19DT05UQUNUUyA9IF9fKCdDb250YWN0IHJlcXVlc3RzJyk7CiAgICAgICAgdmFyIEhFQURFUl9VTkdST1VQRUQgPSBfXygnVW5ncm91cGVkJyk7CgogICAgICAgIHZhciBMQUJFTF9DT05UQUNUUyA9IF9fKCdDb250YWN0cycpOwogICAgICAgIHZhciBMQUJFTF9HUk9VUFMgPSBfXygnR3JvdXBzJyk7CgogICAgICAgIHZhciBIRUFERVJfV0VJR0hUUyA9IHt9OwogICAgICAgIEhFQURFUl9XRUlHSFRTW0hFQURFUl9DVVJSRU5UX0NPTlRBQ1RTXSAgICA9IDA7CiAgICAgICAgSEVBREVSX1dFSUdIVFNbSEVBREVSX1VOR1JPVVBFRF0gICAgICAgICAgID0gMTsKICAgICAgICBIRUFERVJfV0VJR0hUU1tIRUFERVJfUkVRVUVTVElOR19DT05UQUNUU10gPSAyOwogICAgICAgIEhFQURFUl9XRUlHSFRTW0hFQURFUl9QRU5ESU5HX0NPTlRBQ1RTXSAgICA9IDM7CgogICAgICAgIC8vIE1vZHVsZS1sZXZlbCB2YXJpYWJsZXMKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgdGhpcy5jYWxsYmFjayA9IGNhbGxiYWNrIHx8IGZ1bmN0aW9uICgpIHt9OwogICAgICAgIHRoaXMuaW5pdGlhbF9wcmVzZW5jZV9zZW50ID0gMDsKICAgICAgICB0aGlzLm1zZ19jb3VudGVyID0gMDsKCiAgICAgICAgLy8gTW9kdWxlLWxldmVsIGZ1bmN0aW9ucwogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICB0aGlzLmdpdmVGZWVkYmFjayA9IGZ1bmN0aW9uIChtZXNzYWdlLCBrbGFzcykgewogICAgICAgICAgICAkKCcuY29ubi1mZWVkYmFjaycpLmF0dHIoJ2NsYXNzJywgJ2Nvbm4tZmVlZGJhY2snKS50ZXh0KG1lc3NhZ2UpOwogICAgICAgICAgICBpZiAoa2xhc3MpIHsKICAgICAgICAgICAgICAgICQoJy5jb25uLWZlZWRiYWNrJykuYWRkQ2xhc3Moa2xhc3MpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5sb2cgPSBmdW5jdGlvbiAodHh0LCBsZXZlbCkgewogICAgICAgICAgICBpZiAodGhpcy5kZWJ1ZykgewogICAgICAgICAgICAgICAgaWYgKGxldmVsID09ICdlcnJvcicpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRVJST1I6ICcrdHh0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2codHh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHRoaXMuZ2V0VkNhcmQgPSBmdW5jdGlvbiAoamlkLCBjYWxsYmFjaywgZXJyYmFjaykgewogICAgICAgICAgICBpZiAoIXRoaXMudXNlX3ZjYXJkcykgewogICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soamlkLCBqaWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24udmNhcmQuZ2V0KAogICAgICAgICAgICAgICAgJC5wcm94eShmdW5jdGlvbiAoaXEpIHsKICAgICAgICAgICAgICAgICAgICAvLyBTdWNjZXNzZnVsIGNhbGxiYWNrCiAgICAgICAgICAgICAgICAgICAgdmFyICR2Y2FyZCA9ICQoaXEpLmZpbmQoJ3ZDYXJkJyk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZ1bGxuYW1lID0gJHZjYXJkLmZpbmQoJ0ZOJykudGV4dCgpLAogICAgICAgICAgICAgICAgICAgICAgICBpbWcgPSAkdmNhcmQuZmluZCgnQklOVkFMJykudGV4dCgpLAogICAgICAgICAgICAgICAgICAgICAgICBpbWdfdHlwZSA9ICR2Y2FyZC5maW5kKCdUWVBFJykudGV4dCgpLAogICAgICAgICAgICAgICAgICAgICAgICB1cmwgPSAkdmNhcmQuZmluZCgnVVJMJykudGV4dCgpOwogICAgICAgICAgICAgICAgICAgIGlmIChqaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRhY3QgPSBjb252ZXJzZS5yb3N0ZXIuZ2V0KGppZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250YWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdWxsbmFtZSA9IF8uaXNFbXB0eShmdWxsbmFtZSk/IGNvbnRhY3QuZ2V0KCdmdWxsbmFtZScpIHx8IGppZDogZnVsbG5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWN0LnNhdmUoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdmdWxsbmFtZSc6IGZ1bGxuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdpbWFnZV90eXBlJzogaW1nX3R5cGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2ltYWdlJzogaW1nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd1cmwnOiB1cmwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3ZjYXJkX3VwZGF0ZWQnOiBtb21lbnQoKS5mb3JtYXQoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGppZCwgZnVsbG5hbWUsIGltZywgaW1nX3R5cGUsIHVybCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgdGhpcyksCiAgICAgICAgICAgICAgICBqaWQsCiAgICAgICAgICAgICAgICBmdW5jdGlvbiAoaXEpIHsKICAgICAgICAgICAgICAgICAgICAvLyBFcnJvciBjYWxsYmFjawogICAgICAgICAgICAgICAgICAgIHZhciBjb250YWN0ID0gY29udmVyc2Uucm9zdGVyLmdldChqaWQpOwogICAgICAgICAgICAgICAgICAgIGlmIChjb250YWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhY3Quc2F2ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAndmNhcmRfdXBkYXRlZCc6IG1vbWVudCgpLmZvcm1hdCgpCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZXJyYmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJiYWNrKGppZCwgaXEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLnJlY29ubmVjdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgY29udmVyc2UuZ2l2ZUZlZWRiYWNrKF9fKCdSZWNvbm5lY3RpbmcnKSwgJ2Vycm9yJyk7CiAgICAgICAgICAgIGNvbnZlcnNlLmVtaXQoJ3JlY29ubmVjdCcpOwogICAgICAgICAgICBpZiAoIWNvbnZlcnNlLnByZWJpbmQpIHsKICAgICAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbi5jb25uZWN0KAogICAgICAgICAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbi5qaWQsCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb25uZWN0aW9uLnBhc3MsCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKHN0YXR1cywgY29uZGl0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLm9uQ29ubmVjdChzdGF0dXMsIGNvbmRpdGlvbiwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbm5lY3Rpb24ud2FpdCwKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbm5lY3Rpb24uaG9sZCwKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbm5lY3Rpb24ucm91dGUKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB0aGlzLnJlbmRlckxvZ2luUGFuZWwgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGNvbnZlcnNlLl90ZWFyRG93bigpOwogICAgICAgICAgICB2YXIgdmlldyA9IGNvbnZlcnNlLmNoYXRib3h2aWV3cy5nZXQoJ2NvbnRyb2xib3gnKTsKICAgICAgICAgICAgdmlldy5tb2RlbC5zZXQoe2Nvbm5lY3RlZDpmYWxzZX0pOwogICAgICAgICAgICB2aWV3LnJlbmRlckxvZ2luUGFuZWwoKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLm9uQ29ubmVjdCA9IGZ1bmN0aW9uIChzdGF0dXMsIGNvbmRpdGlvbiwgcmVjb25uZWN0KSB7CiAgICAgICAgICAgIHZhciAkYnV0dG9uLCAkZm9ybTsKICAgICAgICAgICAgaWYgKChzdGF0dXMgPT09IFN0cm9waGUuU3RhdHVzLkNPTk5FQ1RFRCkgfHwKICAgICAgICAgICAgICAgIChzdGF0dXMgPT09IFN0cm9waGUuU3RhdHVzLkFUVEFDSEVEKSkgewogICAgICAgICAgICAgICAgaWYgKCh0eXBlb2YgcmVjb25uZWN0ICE9PSAndW5kZWZpbmVkJykgJiYgKHJlY29ubmVjdCkpIHsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5sb2coc3RhdHVzID09PSBTdHJvcGhlLlN0YXR1cy5DT05ORUNURUQgPyAnUmVjb25uZWN0ZWQnIDogJ1JlYXR0YWNoZWQnKTsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5vblJlY29ubmVjdGVkKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmxvZyhzdGF0dXMgPT09IFN0cm9waGUuU3RhdHVzLkNPTk5FQ1RFRCA/ICdDb25uZWN0ZWQnIDogJ0F0dGFjaGVkJyk7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2Uub25Db25uZWN0ZWQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0dXMgPT09IFN0cm9waGUuU3RhdHVzLkRJU0NPTk5FQ1RFRCkgewogICAgICAgICAgICAgICAgY29udmVyc2UuZ2l2ZUZlZWRiYWNrKF9fKCdEaXNjb25uZWN0ZWQnKSwgJ2Vycm9yJyk7CiAgICAgICAgICAgICAgICBpZiAoY29udmVyc2UuYXV0b19yZWNvbm5lY3QpIHsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5yZWNvbm5lY3QoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UucmVuZGVyTG9naW5QYW5lbCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXR1cyA9PT0gU3Ryb3BoZS5TdGF0dXMuRXJyb3IpIHsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJlbmRlckxvZ2luUGFuZWwoKTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLmdpdmVGZWVkYmFjayhfXygnRXJyb3InKSwgJ2Vycm9yJyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdHVzID09PSBTdHJvcGhlLlN0YXR1cy5DT05ORUNUSU5HKSB7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5naXZlRmVlZGJhY2soX18oJ0Nvbm5lY3RpbmcnKSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdHVzID09PSBTdHJvcGhlLlN0YXR1cy5DT05ORkFJTCkgewogICAgICAgICAgICAgICAgY29udmVyc2UucmVuZGVyTG9naW5QYW5lbCgpOwogICAgICAgICAgICAgICAgY29udmVyc2UuZ2l2ZUZlZWRiYWNrKF9fKCdDb25uZWN0aW9uIEZhaWxlZCcpLCAnZXJyb3InKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0dXMgPT09IFN0cm9waGUuU3RhdHVzLkFVVEhFTlRJQ0FUSU5HKSB7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5naXZlRmVlZGJhY2soX18oJ0F1dGhlbnRpY2F0aW5nJykpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXR1cyA9PT0gU3Ryb3BoZS5TdGF0dXMuQVVUSEZBSUwpIHsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJlbmRlckxvZ2luUGFuZWwoKTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLmdpdmVGZWVkYmFjayhfXygnQXV0aGVudGljYXRpb24gRmFpbGVkJyksICdlcnJvcicpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXR1cyA9PT0gU3Ryb3BoZS5TdGF0dXMuRElTQ09OTkVDVElORykgewogICAgICAgICAgICAgICAgaWYgKCFjb252ZXJzZS5jb25uZWN0aW9uLmNvbm5lY3RlZCkgewogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJlbmRlckxvZ2luUGFuZWwoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuZ2l2ZUZlZWRiYWNrKF9fKCdEaXNjb25uZWN0aW5nJyksICdlcnJvcicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5hcHBseUhlaWdodFJlc2lzdGFuY2UgPSBmdW5jdGlvbiAoaGVpZ2h0KSB7CiAgICAgICAgICAgIC8qIFRoaXMgbWV0aG9kIGFwcGxpZXMgc29tZSByZXNpc3RhbmNlL2dyYXZpdHkgYXJvdW5kIHRoZQogICAgICAgICAgICAgKiAiZGVmYXVsdF9ib3hfaGVpZ2h0Ii4gSWYgImhlaWdodCIgaXMgY2xvc2UgZW5vdWdoIHRvCiAgICAgICAgICAgICAqIGRlZmF1bHRfYm94X2hlaWdodCwgdGhlbiB0aGF0IGlzIHJldHVybmVkIGluc3RlYWQuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBpZiAodHlwZW9mIGhlaWdodCA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjb252ZXJzZS5kZWZhdWx0X2JveF9oZWlnaHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJlc2lzdGFuY2UgPSAxMDsKICAgICAgICAgICAgaWYgKChoZWlnaHQgIT09IGNvbnZlcnNlLmRlZmF1bHRfYm94X2hlaWdodCkgJiYKICAgICAgICAgICAgICAgIChNYXRoLmFicyhoZWlnaHQgLSBjb252ZXJzZS5kZWZhdWx0X2JveF9oZWlnaHQpIDwgcmVzaXN0YW5jZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjb252ZXJzZS5kZWZhdWx0X2JveF9oZWlnaHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGhlaWdodDsKICAgICAgICB9OwoKICAgICAgICB0aGlzLnVwZGF0ZU1zZ0NvdW50ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLm1zZ19jb3VudGVyID4gMCkgewogICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LnRpdGxlLnNlYXJjaCgvXk1lc3NhZ2VzIFwoXGQrXCkgLykgPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC50aXRsZSA9ICJNZXNzYWdlcyAoIiArIHRoaXMubXNnX2NvdW50ZXIgKyAiKSAiICsgZG9jdW1lbnQudGl0bGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LnRpdGxlID0gZG9jdW1lbnQudGl0bGUucmVwbGFjZSgvXk1lc3NhZ2VzIFwoXGQrXCkgLywgIk1lc3NhZ2VzICgiICsgdGhpcy5tc2dfY291bnRlciArICIpICIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2luZG93LmJsdXIoKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5mb2N1cygpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGRvY3VtZW50LnRpdGxlLnNlYXJjaCgvXk1lc3NhZ2VzIFwoXGQrXCkgLykgIT0gLTEpIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LnRpdGxlID0gZG9jdW1lbnQudGl0bGUucmVwbGFjZSgvXk1lc3NhZ2VzIFwoXGQrXCkgLywgIiIpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5pbmNyZW1lbnRNc2dDb3VudGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLm1zZ19jb3VudGVyICs9IDE7CiAgICAgICAgICAgIHRoaXMudXBkYXRlTXNnQ291bnRlcigpOwogICAgICAgIH07CgogICAgICAgIHRoaXMuY2xlYXJNc2dDb3VudGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLm1zZ19jb3VudGVyID0gMDsKICAgICAgICAgICAgdGhpcy51cGRhdGVNc2dDb3VudGVyKCk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5pbml0U3RhdHVzID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMueG1wcHN0YXR1cyA9IG5ldyB0aGlzLlhNUFBTdGF0dXMoKTsKICAgICAgICAgICAgdmFyIGlkID0gYjY0X3NoYTEoJ2NvbnZlcnNlLnhtcHBzdGF0dXMtJytjb252ZXJzZS5iYXJlX2ppZCk7CiAgICAgICAgICAgIHRoaXMueG1wcHN0YXR1cy5pZCA9IGlkOyAvLyBBcHBlYXJzIHRvIGJlIG5lY2Vzc2FyeSBmb3IgYmFja2JvbmUuYnJvd3NlclN0b3JhZ2UKICAgICAgICAgICAgdGhpcy54bXBwc3RhdHVzLmJyb3dzZXJTdG9yYWdlID0gbmV3IEJhY2tib25lLkJyb3dzZXJTdG9yYWdlW2NvbnZlcnNlLnN0b3JhZ2VdKGlkKTsKICAgICAgICAgICAgdGhpcy54bXBwc3RhdHVzLmZldGNoKHtzdWNjZXNzOiBjYWxsYmFjaywgZXJyb3I6IGNhbGxiYWNrfSk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5pbml0U2Vzc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy5zZXNzaW9uID0gbmV3IHRoaXMuQk9TSFNlc3Npb24oKTsKICAgICAgICAgICAgdmFyIGlkID0gYjY0X3NoYTEoJ2NvbnZlcnNlLmJvc2gtc2Vzc2lvbicpOwogICAgICAgICAgICB0aGlzLnNlc3Npb24uaWQgPSBpZDsgLy8gQXBwZWFycyB0byBiZSBuZWNlc3NhcnkgZm9yIGJhY2tib25lLmJyb3dzZXJTdG9yYWdlCiAgICAgICAgICAgIHRoaXMuc2Vzc2lvbi5icm93c2VyU3RvcmFnZSA9IG5ldyBCYWNrYm9uZS5Ccm93c2VyU3RvcmFnZVtjb252ZXJzZS5zdG9yYWdlXShpZCk7CiAgICAgICAgICAgIHRoaXMuc2Vzc2lvbi5mZXRjaCgpOwogICAgICAgICAgICAkKHdpbmRvdykub24oJ2JlZm9yZXVubG9hZCcsICQucHJveHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKGNvbnZlcnNlLmNvbm5lY3Rpb24uY29ubmVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRTZXNzaW9uKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJTZXNzaW9uKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHRoaXMpKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLmNsZWFyU2Vzc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy5yb3N0ZXIuYnJvd3NlclN0b3JhZ2UuX2NsZWFyKCk7CiAgICAgICAgICAgIHRoaXMuc2Vzc2lvbi5icm93c2VyU3RvcmFnZS5fY2xlYXIoKTsKICAgICAgICAgICAgLy8gWFhYOiB0aGlzIHNob3VsZCBwZXJoYXBzIGdvIGludG8gdGhlIGJlZm9yZXVubG9hZCBoYW5kbGVyCiAgICAgICAgICAgIGNvbnZlcnNlLmNoYXRib3hlcy5nZXQoJ2NvbnRyb2xib3gnKS5zYXZlKHsnY29ubmVjdGVkJzogZmFsc2V9KTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLnNldFNlc3Npb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmtlZXBhbGl2ZSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXNzaW9uLnNhdmUoewogICAgICAgICAgICAgICAgICAgIGppZDogdGhpcy5jb25uZWN0aW9uLmppZCwKICAgICAgICAgICAgICAgICAgICByaWQ6IHRoaXMuY29ubmVjdGlvbi5fcHJvdG8ucmlkLAogICAgICAgICAgICAgICAgICAgIHNpZDogdGhpcy5jb25uZWN0aW9uLl9wcm90by5zaWQKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5sb2dPdXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGNvbnZlcnNlLmNoYXRib3h2aWV3cy5jbG9zZUFsbENoYXRCb3hlcyhmYWxzZSk7CiAgICAgICAgICAgIGNvbnZlcnNlLmNsZWFyU2Vzc2lvbigpOwogICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLmRpc2Nvbm5lY3QoKTsKICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5yZXNldCgpOwogICAgICAgIH07CgogICAgICAgIHRoaXMucmVnaXN0ZXJHbG9iYWxFdmVudEhhbmRsZXJzID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAkKGRvY3VtZW50KS5jbGljayhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAoJCgnLnRvZ2dsZS1vdHIgdWwnKS5pcygnOnZpc2libGUnKSkgewogICAgICAgICAgICAgICAgICAgICQoJy50b2dnbGUtb3RyIHVsJywgdGhpcykuc2xpZGVVcCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCQoJy50b2dnbGUtc21pbGV5IHVsJykuaXMoJzp2aXNpYmxlJykpIHsKICAgICAgICAgICAgICAgICAgICAkKCcudG9nZ2xlLXNtaWxleSB1bCcsIHRoaXMpLnNsaWRlVXAoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAkKGRvY3VtZW50KS5vbignbW91c2Vtb3ZlJywgJC5wcm94eShmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5yZXNpemVkX2NoYXRib3ggfHwgIXRoaXMuYWxsb3dfZHJhZ3Jlc2l6ZSkgeyByZXR1cm4gdHJ1ZTsgfQogICAgICAgICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIHRoaXMucmVzaXplZF9jaGF0Ym94LnJlc2l6ZUNoYXRCb3goZXYpOwogICAgICAgICAgICB9LCB0aGlzKSk7CgogICAgICAgICAgICAkKGRvY3VtZW50KS5vbignbW91c2V1cCcsICQucHJveHkoZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMucmVzaXplZF9jaGF0Ym94IHx8ICF0aGlzLmFsbG93X2RyYWdyZXNpemUpIHsgcmV0dXJuIHRydWU7IH0KICAgICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICB2YXIgaGVpZ2h0ID0gdGhpcy5hcHBseUhlaWdodFJlc2lzdGFuY2UodGhpcy5yZXNpemVkX2NoYXRib3guaGVpZ2h0KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNvbm5lY3Rpb24uY29ubmVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNpemVkX2NoYXRib3gubW9kZWwuc2F2ZSh7J2hlaWdodCc6IGhlaWdodH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlc2l6ZWRfY2hhdGJveC5tb2RlbC5zZXQoeydoZWlnaHQnOiBoZWlnaHR9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMucmVzaXplZF9jaGF0Ym94ID0gbnVsbDsKICAgICAgICAgICAgfSwgdGhpcykpOwoKICAgICAgICAgICAgJCh3aW5kb3cpLm9uKCJibHVyIGZvY3VzIiwgJC5wcm94eShmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGlmICgodGhpcy53aW5kb3dTdGF0ZSAhPSBldi50eXBlKSAmJiAoZXYudHlwZSA9PSAnZm9jdXMnKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNsZWFyTXNnQ291bnRlcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy53aW5kb3dTdGF0ZSA9IGV2LnR5cGU7CiAgICAgICAgICAgIH0sdGhpcykpOwoKICAgICAgICAgICAgJCh3aW5kb3cpLm9uKCJyZXNpemUiLCBfLmRlYm91bmNlKCQucHJveHkoZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICB0aGlzLmNoYXRib3h2aWV3cy50cmltQ2hhdHMoKTsKICAgICAgICAgICAgfSx0aGlzKSwgMjAwKSk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5vblJlY29ubmVjdGVkID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvLyBXZSBuZWVkIHRvIHJlLXJlZ2lzdGVyIGFsbCB0aGUgZXZlbnQgaGFuZGxlcnMgb24gdGhlIG5ld2x5CiAgICAgICAgICAgIC8vIGNyZWF0ZWQgY29ubmVjdGlvbi4KICAgICAgICAgICAgdGhpcy5pbml0U3RhdHVzKCQucHJveHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RlclJvc3RlclhIYW5kbGVyKCk7CiAgICAgICAgICAgICAgICB0aGlzLnJlZ2lzdGVyUHJlc2VuY2VIYW5kbGVyKCk7CiAgICAgICAgICAgICAgICB0aGlzLmNoYXRib3hlcy5yZWdpc3Rlck1lc3NhZ2VIYW5kbGVyKCk7CiAgICAgICAgICAgICAgICBjb252ZXJzZS54bXBwc3RhdHVzLnNlbmRQcmVzZW5jZSgpOwogICAgICAgICAgICAgICAgdGhpcy5naXZlRmVlZGJhY2soX18oJ09ubGluZSBDb250YWN0cycpKTsKICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgIH07CgogICAgICAgIHRoaXMuZW5hYmxlQ2FyYm9ucyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgLyogQXNrIHRoZSBYTVBQIHNlcnZlciB0byBlbmFibGUgTWVzc2FnZSBDYXJib25zCiAgICAgICAgICAgICAqIFNlZSBYRVAtMDI4MCBodHRwczovL3htcHAub3JnL2V4dGVuc2lvbnMveGVwLTAyODAuaHRtbCNlbmFibGluZwogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaWYgKCF0aGlzLm1lc3NhZ2VfY2FyYm9ucykgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjYXJib25zX2lxID0gbmV3IFN0cm9waGUuQnVpbGRlcignaXEnLCB7CiAgICAgICAgICAgICAgICBmcm9tOiB0aGlzLmNvbm5lY3Rpb24uamlkLAogICAgICAgICAgICAgICAgaWQ6ICdlbmFibGVjYXJib25zJywKICAgICAgICAgICAgICAgIHR5cGU6ICdzZXQnCiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAuYygnZW5hYmxlJywge3htbG5zOiAndXJuOnhtcHA6Y2FyYm9uczoyJ30pOwogICAgICAgICAgICB0aGlzLmNvbm5lY3Rpb24uc2VuZChjYXJib25zX2lxKTsKICAgICAgICAgICAgdGhpcy5jb25uZWN0aW9uLmFkZEhhbmRsZXIoZnVuY3Rpb24gKGlxKSB7CiAgICAgICAgICAgICAgICAvL1RPRE86IGNoZWNrIGlmIGNhcmJvbnMgd2FzIGVuYWJsZWQ6CiAgICAgICAgICAgIH0sIG51bGwsICJpcSIsIG51bGwsICJlbmFibGVjYXJib25zIik7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5vbkNvbm5lY3RlZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZGVidWcpIHsKICAgICAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbi54bWxJbnB1dCA9IGZ1bmN0aW9uIChib2R5KSB7IGNvbnNvbGUubG9nKGJvZHkpOyB9OwogICAgICAgICAgICAgICAgdGhpcy5jb25uZWN0aW9uLnhtbE91dHB1dCA9IGZ1bmN0aW9uIChib2R5KSB7IGNvbnNvbGUubG9nKGJvZHkpOyB9OwogICAgICAgICAgICAgICAgU3Ryb3BoZS5sb2cgPSBmdW5jdGlvbiAobGV2ZWwsIG1zZykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGxldmVsKycgJyttc2cpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIFN0cm9waGUuZXJyb3IgPSBmdW5jdGlvbiAobXNnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0VSUk9SOiAnK21zZyk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFdoZW4gcmVjb25uZWN0aW5nLCB0aGVyZSBtaWdodCBiZSBzb21lIG9wZW4gY2hhdCBib3hlcy4gV2UgZG9uJ3QKICAgICAgICAgICAgLy8ga25vdyB3aGV0aGVyIHRoZXNlIGJveGVzIGFyZSBvZiB0aGUgc2FtZSBhY2NvdW50IG9yIG5vdCwgc28gd2UKICAgICAgICAgICAgLy8gY2xvc2UgdGhlbSBub3cuCiAgICAgICAgICAgIHRoaXMuY2hhdGJveHZpZXdzLmNsb3NlQWxsQ2hhdEJveGVzKCk7CiAgICAgICAgICAgIHRoaXMuc2V0U2Vzc2lvbigpOwogICAgICAgICAgICB0aGlzLmppZCA9IHRoaXMuY29ubmVjdGlvbi5qaWQ7CiAgICAgICAgICAgIHRoaXMuYmFyZV9qaWQgPSBTdHJvcGhlLmdldEJhcmVKaWRGcm9tSmlkKHRoaXMuY29ubmVjdGlvbi5qaWQpOwogICAgICAgICAgICB0aGlzLmRvbWFpbiA9IFN0cm9waGUuZ2V0RG9tYWluRnJvbUppZCh0aGlzLmNvbm5lY3Rpb24uamlkKTsKICAgICAgICAgICAgdGhpcy5taW5pbWl6ZWRfY2hhdHMgPSBuZXcgY29udmVyc2UuTWluaW1pemVkQ2hhdHMoe21vZGVsOiB0aGlzLmNoYXRib3hlc30pOwogICAgICAgICAgICB0aGlzLmZlYXR1cmVzID0gbmV3IHRoaXMuRmVhdHVyZXMoKTsKICAgICAgICAgICAgdGhpcy5lbmFibGVDYXJib25zKCk7CiAgICAgICAgICAgIHRoaXMuaW5pdFN0YXR1cygkLnByb3h5KGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgICAgICB0aGlzLmNoYXRib3hlcy5vbkNvbm5lY3RlZCgpOwogICAgICAgICAgICAgICAgdGhpcy5naXZlRmVlZGJhY2soX18oJ09ubGluZSBDb250YWN0cycpKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY29ubmVjdGlvbi5zZXJ2aWNlID09PSAnamFzbWluZSB0ZXN0cycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gWFhYOiBDYWxsIGJhY2sgd2l0aCB0aGUgaW50ZXJuYWwgY29udmVyc2Ugb2JqZWN0LiBUaGlzCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG9iamVjdCBzaG91bGQgbmV2ZXIgYmUgZXhwb3NlZCB0byBwcm9kdWN0aW9uIHN5c3RlbXMuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vICdqYXNtaW5lIHRlc3RzJyBpcyBhbiBpbnZhbGlkIGh0dHAgYmluZCBzZXJ2aWNlIHZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgICAvLyBzbyB3ZSdyZSBzdXJlIHRoYXQgdGhpcyBpcyBqdXN0IGZvciB0ZXN0cy4KICAgICAgICAgICAgICAgICAgICAgICAgLy8KICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogV2UgbWlnaHQgbmVlZCB0byBjb25zaWRlciB3ZWJzb2NrZXRzLCB3aGljaAogICAgICAgICAgICAgICAgICAgICAgICAvLyBwcm9iYWJseSB3b24ndCB1c2UgdGhlICdzZXJ2aWNlJyBhdHRyLiBDdXJyZW50CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN0cm9waGUuanMgdmVyc2lvbiB1c2VkIGJ5IGNvbnZlcnNlLmpzIGRvZXNuJ3Qgc3VwcG9ydAogICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZWJzb2NrZXRzLgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbGxiYWNrKHRoaXMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB0aGlzKSk7CiAgICAgICAgICAgIGNvbnZlcnNlLmVtaXQoJ3JlYWR5Jyk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gQmFja2JvbmUgTW9kZWxzIGFuZCBWaWV3cwogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICB0aGlzLk9UUiA9IEJhY2tib25lLk1vZGVsLmV4dGVuZCh7CiAgICAgICAgICAgIC8vIEEgbW9kZWwgZm9yIG1hbmFnaW5nIE9UUiBzZXR0aW5ncy4KICAgICAgICAgICAgZ2V0U2Vzc2lvblBhc3NwaHJhc2U6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmIChjb252ZXJzZS5wcmViaW5kKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IGI2NF9zaGExKGNvbnZlcnNlLmNvbm5lY3Rpb24uamlkKSwKICAgICAgICAgICAgICAgICAgICAgICAgcGFzcyA9IHdpbmRvdy5zZXNzaW9uU3RvcmFnZVtrZXldOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcGFzcyA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFzcyA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSo0Mjk0OTY3Mjk1KS50b1N0cmluZygpOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuc2Vzc2lvblN0b3JhZ2Vba2V5XSA9IHBhc3M7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXNzOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29udmVyc2UuY29ubmVjdGlvbi5wYXNzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgZ2VuZXJhdGVQcml2YXRlS2V5OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIga2V5ID0gbmV3IERTQSgpOwogICAgICAgICAgICAgICAgdmFyIGppZCA9IGNvbnZlcnNlLmNvbm5lY3Rpb24uamlkOwogICAgICAgICAgICAgICAgaWYgKGNvbnZlcnNlLmNhY2hlX290cl9rZXkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY2lwaGVyID0gQ3J5cHRvSlMubGliLlBhc3N3b3JkQmFzZWRDaXBoZXI7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBhc3MgPSB0aGlzLmdldFNlc3Npb25QYXNzcGhyYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXNzICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBFbmNyeXB0IHRoZSBrZXkgYW5kIHNldCBpbiBzZXNzaW9uU3RvcmFnZS4gQWxzbyBzdG9yZSBpbnN0YW5jZSB0YWcuCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5zZXNzaW9uU3RvcmFnZVtiNjRfc2hhMShqaWQrJ3ByaXZfa2V5JyldID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNpcGhlci5lbmNyeXB0KENyeXB0b0pTLmFsZ28uQUVTLCBrZXkucGFja1ByaXZhdGUoKSwgcGFzcykudG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LnNlc3Npb25TdG9yYWdlW2I2NF9zaGExKGppZCsnaW5zdGFuY2VfdGFnJyldID0gaW5zdGFuY2VfdGFnOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuc2Vzc2lvblN0b3JhZ2VbYjY0X3NoYTEoamlkKydwYXNzX2NoZWNrJyldID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNpcGhlci5lbmNyeXB0KENyeXB0b0pTLmFsZ28uQUVTLCAnbWF0Y2gnLCBwYXNzKS50b1N0cmluZygpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBrZXk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5NZXNzYWdlID0gQmFja2JvbmUuTW9kZWw7CiAgICAgICAgdGhpcy5NZXNzYWdlcyA9IEJhY2tib25lLkNvbGxlY3Rpb24uZXh0ZW5kKHsKICAgICAgICAgICAgbW9kZWw6IGNvbnZlcnNlLk1lc3NhZ2UKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5DaGF0Qm94ID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kKHsKICAgICAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGhlaWdodCA9IGNvbnZlcnNlLmFwcGx5SGVpZ2h0UmVzaXN0YW5jZSh0aGlzLmdldCgnaGVpZ2h0JykpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2V0KCdib3hfaWQnKSAhPT0gJ2NvbnRyb2xib3gnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNzYWdlcyA9IG5ldyBjb252ZXJzZS5NZXNzYWdlcygpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzc2FnZXMuYnJvd3NlclN0b3JhZ2UgPSBuZXcgQmFja2JvbmUuQnJvd3NlclN0b3JhZ2VbY29udmVyc2Uuc3RvcmFnZV0oCiAgICAgICAgICAgICAgICAgICAgICAgIGI2NF9zaGExKCdjb252ZXJzZS5tZXNzYWdlcycrdGhpcy5nZXQoJ2ppZCcpK2NvbnZlcnNlLmJhcmVfamlkKSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zYXZlKHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2JveF9pZCcgOiBiNjRfc2hhMSh0aGlzLmdldCgnamlkJykpLAogICAgICAgICAgICAgICAgICAgICAgICAnaGVpZ2h0JzogaGVpZ2h0LAogICAgICAgICAgICAgICAgICAgICAgICAnbWluaW1pemVkJzogdGhpcy5nZXQoJ21pbmltaXplZCcpIHx8IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAnb3RyX3N0YXR1cyc6IHRoaXMuZ2V0KCdvdHJfc3RhdHVzJykgfHwgVU5FTkNSWVBURUQsCiAgICAgICAgICAgICAgICAgICAgICAgICd0aW1lX21pbmltaXplZCc6IHRoaXMuZ2V0KCd0aW1lX21pbmltaXplZCcpIHx8IG1vbWVudCgpLAogICAgICAgICAgICAgICAgICAgICAgICAndGltZV9vcGVuZWQnOiB0aGlzLmdldCgndGltZV9vcGVuZWQnKSB8fCBtb21lbnQoKS52YWx1ZU9mKCksCiAgICAgICAgICAgICAgICAgICAgICAgICd1c2VyX2lkJyA6IFN0cm9waGUuZ2V0Tm9kZUZyb21KaWQodGhpcy5nZXQoJ2ppZCcpKSwKICAgICAgICAgICAgICAgICAgICAgICAgJ251bV91bnJlYWQnOiB0aGlzLmdldCgnbnVtX3VucmVhZCcpIHx8IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICd1cmwnOiAnJwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldCh7CiAgICAgICAgICAgICAgICAgICAgICAgICdoZWlnaHQnOiBoZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgICAgICd0aW1lX29wZW5lZCc6IG1vbWVudCgwKS52YWx1ZU9mKCksCiAgICAgICAgICAgICAgICAgICAgICAgICdudW1fdW5yZWFkJzogdGhpcy5nZXQoJ251bV91bnJlYWQnKSB8fCAwCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBtYXhpbWl6ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy5zYXZlKHsKICAgICAgICAgICAgICAgICAgICAnbWluaW1pemVkJzogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgJ3RpbWVfb3BlbmVkJzogbW9tZW50KCkudmFsdWVPZigpCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG1pbmltaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNhdmUoewogICAgICAgICAgICAgICAgICAgICdtaW5pbWl6ZWQnOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICd0aW1lX21pbmltaXplZCc6IG1vbWVudCgpLmZvcm1hdCgpCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGdldFNlc3Npb246IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICAgICAgdmFyIGNpcGhlciA9IENyeXB0b0pTLmxpYi5QYXNzd29yZEJhc2VkQ2lwaGVyOwogICAgICAgICAgICAgICAgdmFyIHJlc3VsdCwgcGFzcywgaW5zdGFuY2VfdGFnLCBzYXZlZF9rZXksIHBhc3NfY2hlY2s7CiAgICAgICAgICAgICAgICBpZiAoY29udmVyc2UuY2FjaGVfb3RyX2tleSkgewogICAgICAgICAgICAgICAgICAgIHBhc3MgPSBjb252ZXJzZS5vdHIuZ2V0U2Vzc2lvblBhc3NwaHJhc2UoKTsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHBhc3MgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlX3RhZyA9IHdpbmRvdy5zZXNzaW9uU3RvcmFnZVtiNjRfc2hhMSh0aGlzLmlkKydpbnN0YW5jZV90YWcnKV07CiAgICAgICAgICAgICAgICAgICAgICAgIHNhdmVkX2tleSA9IHdpbmRvdy5zZXNzaW9uU3RvcmFnZVtiNjRfc2hhMSh0aGlzLmlkKydwcml2X2tleScpXTsKICAgICAgICAgICAgICAgICAgICAgICAgcGFzc19jaGVjayA9IHdpbmRvdy5zZXNzaW9uU3RvcmFnZVtiNjRfc2hhMSh0aGlzLmNvbm5lY3Rpb24uamlkKydwYXNzX2NoZWNrJyldOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2F2ZWRfa2V5ICYmIGluc3RhbmNlX3RhZyAmJiB0eXBlb2YgcGFzc19jaGVjayAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkZWNyeXB0ZWQgPSBjaXBoZXIuZGVjcnlwdChDcnlwdG9KUy5hbGdvLkFFUywgc2F2ZWRfa2V5LCBwYXNzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBrZXkgPSBEU0EucGFyc2VQcml2YXRlKGRlY3J5cHRlZC50b1N0cmluZyhDcnlwdG9KUy5lbmMuTGF0aW4xKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2lwaGVyLmRlY3J5cHQoQ3J5cHRvSlMuYWxnby5BRVMsIHBhc3NfY2hlY2ssIHBhc3MpLnRvU3RyaW5nKENyeXB0b0pTLmVuYy5MYXRpbjEpID09PSAnbWF0Y2gnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVmVyaWZpZWQgdGhhdCB0aGUgcGFzc3BocmFzZSBpcyBzdGlsbCB0aGUgc2FtZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcignc2hvd0hlbHBNZXNzYWdlcycsIFtfXygnUmUtZXN0YWJsaXNoaW5nIGVuY3J5cHRlZCBzZXNzaW9uJyldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdrZXknOiBrZXksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdpbnN0YW5jZV90YWcnOiBpbnN0YW5jZV90YWcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47IC8vIE91ciB3b3JrIGlzIGRvbmUgaGVyZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gV2UgbmVlZCB0byBnZW5lcmF0ZSBhIG5ldyBrZXkgYW5kIGluc3RhbmNlIHRhZwogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdzaG93SGVscE1lc3NhZ2VzJywgWwogICAgICAgICAgICAgICAgICAgIF9fKCdHZW5lcmF0aW5nIHByaXZhdGUga2V5LicpLAogICAgICAgICAgICAgICAgICAgIF9fKCdZb3VyIGJyb3dzZXIgbWlnaHQgYmVjb21lIHVucmVzcG9uc2l2ZS4nKV0sCiAgICAgICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgICAgICB0cnVlIC8vIHNob3cgc3Bpbm5lcgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2tleSc6IGNvbnZlcnNlLm90ci5nZW5lcmF0ZVByaXZhdGVLZXkuYXBwbHkodGhpcyksCiAgICAgICAgICAgICAgICAgICAgICAgICdpbnN0YW5jZV90YWcnOiBPVFIubWFrZUluc3RhbmNlVGFnKCkKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sIDUwMCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB1cGRhdGVPVFJTdGF0dXM6IGZ1bmN0aW9uIChzdGF0ZSkgewogICAgICAgICAgICAgICAgc3dpdGNoIChzdGF0ZSkgewogICAgICAgICAgICAgICAgICAgIGNhc2UgT1RSLkNPTlNULlNUQVRVU19BS0VfU1VDQ0VTUzoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub3RyLm1zZ3N0YXRlID09PSBPVFIuQ09OU1QuTVNHU1RBVEVfRU5DUllQVEVEKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNhdmUoeydvdHJfc3RhdHVzJzogVU5WRVJJRklFRH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgT1RSLkNPTlNULlNUQVRVU19FTkRfT1RSOgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vdHIubXNnc3RhdGUgPT09IE9UUi5DT05TVC5NU0dTVEFURV9GSU5JU0hFRCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zYXZlKHsnb3RyX3N0YXR1cyc6IEZJTklTSEVEfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5vdHIubXNnc3RhdGUgPT09IE9UUi5DT05TVC5NU0dTVEFURV9QTEFJTlRFWFQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2F2ZSh7J290cl9zdGF0dXMnOiBVTkVOQ1JZUFRFRH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25TTVA6IGZ1bmN0aW9uICh0eXBlLCBkYXRhKSB7CiAgICAgICAgICAgICAgICAvLyBFdmVudCBoYW5kbGVyIGZvciBTTVAgKFNvY2lhbGlzdCdzIE1pbGxpb25haXJlIFByb3RvY29sKQogICAgICAgICAgICAgICAgLy8gdXNlZCBieSBPVFIgKG9mZi10aGUtcmVjb3JkKS4KICAgICAgICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICAgICAgICAgIGNhc2UgJ3F1ZXN0aW9uJzoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vdHIuc21wU2VjcmV0KHByb21wdChfXygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdBdXRoZW50aWNhdGlvbiByZXF1ZXN0IGZyb20gJTEkc1xuXG5Zb3VyIGJ1ZGR5IGlzIGF0dGVtcHRpbmcgdG8gdmVyaWZ5IHlvdXIgaWRlbnRpdHksIGJ5IGFza2luZyB5b3UgdGhlIHF1ZXN0aW9uIGJlbG93LlxuXG4lMiRzJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFt0aGlzLmdldCgnZnVsbG5hbWUnKSwgZGF0YV0pKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ3RydXN0JzoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2F2ZSh7J290cl9zdGF0dXMnOiBWRVJJRklFRH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzaG93SGVscE1lc3NhZ2VzJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbX18oIkNvdWxkIG5vdCB2ZXJpZnkgdGhpcyB1c2VyJ3MgaWRlbnRpZnkuIildLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdlcnJvcicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zYXZlKHsnb3RyX3N0YXR1cyc6IFVOVkVSSUZJRUR9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gdHlwZS4nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGluaXRpYXRlT1RSOiBmdW5jdGlvbiAocXVlcnlfbXNnKSB7CiAgICAgICAgICAgICAgICAvLyBTZXRzIHVwIGFuIE9UUiBvYmplY3QgdGhyb3VnaCB3aGljaCB3ZSBjYW4gc2VuZCBhbmQgcmVjZWl2ZQogICAgICAgICAgICAgICAgLy8gZW5jcnlwdGVkIG1lc3NhZ2VzLgogICAgICAgICAgICAgICAgLy8KICAgICAgICAgICAgICAgIC8vIElmICdxdWVyeV9tc2cnIGlzIHBhc3NlZCBpbiwgaXQgbWVhbnMgdGhlcmUgaXMgYW4gYWxyZWFkIGluY29taW5nCiAgICAgICAgICAgICAgICAvLyBxdWVyeSBtZXNzYWdlIGZyb20gb3VyIGJ1ZGR5LiBPdGhlcndpc2UsIGl0IGlzIHVzIHdobyB3aWxsCiAgICAgICAgICAgICAgICAvLyBzZW5kIHRoZSBxdWVyeSBtZXNzYWdlIHRvIHRoZW0uCiAgICAgICAgICAgICAgICB0aGlzLnNhdmUoeydvdHJfc3RhdHVzJzogVU5FTkNSWVBURUR9KTsKICAgICAgICAgICAgICAgIHZhciBzZXNzaW9uID0gdGhpcy5nZXRTZXNzaW9uKCQucHJveHkoZnVuY3Rpb24gKHNlc3Npb24pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm90ciA9IG5ldyBPVFIoewogICAgICAgICAgICAgICAgICAgICAgICBmcmFnbWVudF9zaXplOiAxNDAsCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRfaW50ZXJ2YWw6IDIwMCwKICAgICAgICAgICAgICAgICAgICAgICAgcHJpdjogc2Vzc2lvbi5rZXksCiAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlX3RhZzogc2Vzc2lvbi5pbnN0YW5jZV90YWcsCiAgICAgICAgICAgICAgICAgICAgICAgIGRlYnVnOiB0aGlzLmRlYnVnCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vdHIub24oJ3N0YXR1cycsICQucHJveHkodGhpcy51cGRhdGVPVFJTdGF0dXMsIHRoaXMpKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm90ci5vbignc21wJywgJC5wcm94eSh0aGlzLm9uU01QLCB0aGlzKSk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMub3RyLm9uKCd1aScsICQucHJveHkoZnVuY3Rpb24gKG1zZykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ3Nob3dSZWNlaXZlZE9UUk1lc3NhZ2UnLCBtc2cpOwogICAgICAgICAgICAgICAgICAgIH0sIHRoaXMpKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm90ci5vbignaW8nLCAkLnByb3h5KGZ1bmN0aW9uIChtc2cpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdzZW5kTWVzc2FnZVN0YW56YScsIG1zZyk7CiAgICAgICAgICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgICAgICAgICAgICAgIHRoaXMub3RyLm9uKCdlcnJvcicsICQucHJveHkoZnVuY3Rpb24gKG1zZykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ3Nob3dPVFJFcnJvcicsIG1zZyk7CiAgICAgICAgICAgICAgICAgICAgfSwgdGhpcykpOwoKICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ3Nob3dIZWxwTWVzc2FnZXMnLCBbX18oJ0V4Y2hhbmdpbmcgcHJpdmF0ZSBrZXkgd2l0aCBidWRkeS4nKV0pOwogICAgICAgICAgICAgICAgICAgIGlmIChxdWVyeV9tc2cpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vdHIucmVjZWl2ZU1zZyhxdWVyeV9tc2cpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3RyLnNlbmRRdWVyeU1zZygpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHRoaXMpKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGVuZE9UUjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMub3RyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vdHIuZW5kT3RyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnNhdmUoeydvdHJfc3RhdHVzJzogVU5FTkNSWVBURUR9KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGNyZWF0ZU1lc3NhZ2U6IGZ1bmN0aW9uICgkbWVzc2FnZSkgewogICAgICAgICAgICAgICAgdmFyIGJvZHkgPSAkbWVzc2FnZS5jaGlsZHJlbignYm9keScpLnRleHQoKSwKICAgICAgICAgICAgICAgICAgICBjb21wb3NpbmcgPSAkbWVzc2FnZS5maW5kKCdjb21wb3NpbmcnKSwKICAgICAgICAgICAgICAgICAgICBwYXVzZWQgPSAkbWVzc2FnZS5maW5kKCdwYXVzZWQnKSwKICAgICAgICAgICAgICAgICAgICBkZWxheWVkID0gJG1lc3NhZ2UuZmluZCgnZGVsYXknKS5sZW5ndGggPiAwLAogICAgICAgICAgICAgICAgICAgIGZ1bGxuYW1lID0gdGhpcy5nZXQoJ2Z1bGxuYW1lJyksCiAgICAgICAgICAgICAgICAgICAgaXNfZ3JvdXBjaGF0ID0gJG1lc3NhZ2UuYXR0cigndHlwZScpID09PSAnZ3JvdXBjaGF0JywKICAgICAgICAgICAgICAgICAgICBtc2dpZCA9ICRtZXNzYWdlLmF0dHIoJ2lkJyksCiAgICAgICAgICAgICAgICAgICAgc3RhbXAsIHRpbWUsIHNlbmRlciwgZnJvbTsKCiAgICAgICAgICAgICAgICBpZiAoaXNfZ3JvdXBjaGF0KSB7CiAgICAgICAgICAgICAgICAgICAgZnJvbSA9IFN0cm9waGUudW5lc2NhcGVOb2RlKFN0cm9waGUuZ2V0UmVzb3VyY2VGcm9tSmlkKCRtZXNzYWdlLmF0dHIoJ2Zyb20nKSkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBmcm9tID0gU3Ryb3BoZS5nZXRCYXJlSmlkRnJvbUppZCgkbWVzc2FnZS5hdHRyKCdmcm9tJykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZnVsbG5hbWUgPSAoXy5pc0VtcHR5KGZ1bGxuYW1lKT8gZnJvbTogZnVsbG5hbWUpLnNwbGl0KCcgJylbMF07CgogICAgICAgICAgICAgICAgaWYgKCFib2R5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBvc2luZy5sZW5ndGggfHwgcGF1c2VkLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBGSVhNRTogdXNlIG9uZSBhdHRyaWJ1dGUgZm9yIGNoYXQgc3RhdGVzIChlLmcuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNoYXRzdGF0ZSkgaW5zdGVhZCBvZiBzYXZpbmcgJ3BhdXNlZCcgYW5kCiAgICAgICAgICAgICAgICAgICAgICAgIC8vICdjb21wb3NpbmcnIHNlcGFyYXRlbHkuCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzc2FnZXMuYWRkKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bGxuYW1lOiBmdWxsbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRlcjogJ3RoZW0nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsYXllZDogZGVsYXllZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWU6IG1vbWVudCgpLmZvcm1hdCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9zaW5nOiBjb21wb3NpbmcubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF1c2VkOiBwYXVzZWQubGVuZ3RoCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRlbGF5ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhbXAgPSAkbWVzc2FnZS5maW5kKCdkZWxheScpLmF0dHIoJ3N0YW1wJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWUgPSBzdGFtcDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aW1lID0gbW9tZW50KCkuZm9ybWF0KCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICgoaXNfZ3JvdXBjaGF0ICYmIGZyb20gPT09IHRoaXMuZ2V0KCduaWNrJykpIHx8ICghaXNfZ3JvdXBjaGF0ICYmIGZyb20gPT0gY29udmVyc2UuYmFyZV9qaWQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRlciA9ICdtZSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VuZGVyID0gJ3RoZW0nOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc3NhZ2VzLmNyZWF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bGxuYW1lOiBmdWxsbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgc2VuZGVyOiBzZW5kZXIsCiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGF5ZWQ6IGRlbGF5ZWQsCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWU6IHRpbWUsCiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGJvZHksCiAgICAgICAgICAgICAgICAgICAgICAgIG1zZ2lkOiBtc2dpZAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVjZWl2ZU1lc3NhZ2U6IGZ1bmN0aW9uICgkbWVzc2FnZSkgewogICAgICAgICAgICAgICAgdmFyICRib2R5ID0gJG1lc3NhZ2UuY2hpbGRyZW4oJ2JvZHknKTsKICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gKCRib2R5Lmxlbmd0aCA+IDAgPyAkYm9keS50ZXh0KCkgOiB1bmRlZmluZWQpOwogICAgICAgICAgICAgICAgaWYgKCghdGV4dCkgfHwgKCFjb252ZXJzZS5hbGxvd19vdHIpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlTWVzc2FnZSgkbWVzc2FnZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGV4dC5tYXRjaCgvXlw/T1RSdjIzPy8pKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbml0aWF0ZU9UUih0ZXh0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKF8uY29udGFpbnMoW1VOVkVSSUZJRUQsIFZFUklGSUVEXSwgdGhpcy5nZXQoJ290cl9zdGF0dXMnKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vdHIucmVjZWl2ZU1zZyh0ZXh0KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGV4dC5tYXRjaCgvXlw/T1RSLykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5vdHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmluaXRpYXRlT1RSKHRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm90ci5yZWNlaXZlTXNnKHRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gTm9ybWFsIHVuZW5jcnlwdGVkIG1lc3NhZ2UuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZU1lc3NhZ2UoJG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuQ2hhdEJveFZpZXcgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZCh7CiAgICAgICAgICAgIGxlbmd0aDogMjAwLAogICAgICAgICAgICB0YWdOYW1lOiAnZGl2JywKICAgICAgICAgICAgY2xhc3NOYW1lOiAnY2hhdGJveCcsCiAgICAgICAgICAgIGlzX2NoYXRyb29tOiBmYWxzZSwgIC8vIFRoaXMgaXMgbm90IGEgbXVsdGktdXNlciBjaGF0cm9vbQoKICAgICAgICAgICAgZXZlbnRzOiB7CiAgICAgICAgICAgICAgICAnY2xpY2sgLmNsb3NlLWNoYXRib3gtYnV0dG9uJzogJ2Nsb3NlJywKICAgICAgICAgICAgICAgICdjbGljayAudG9nZ2xlLWNoYXRib3gtYnV0dG9uJzogJ21pbmltaXplJywKICAgICAgICAgICAgICAgICdrZXlwcmVzcyB0ZXh0YXJlYS5jaGF0LXRleHRhcmVhJzogJ2tleVByZXNzZWQnLAogICAgICAgICAgICAgICAgJ2NsaWNrIC50b2dnbGUtc21pbGV5JzogJ3RvZ2dsZUVtb3RpY29uTWVudScsCiAgICAgICAgICAgICAgICAnY2xpY2sgLnRvZ2dsZS1zbWlsZXkgdWwgbGknOiAnaW5zZXJ0RW1vdGljb24nLAogICAgICAgICAgICAgICAgJ2NsaWNrIC50b2dnbGUtY2xlYXInOiAnY2xlYXJNZXNzYWdlcycsCiAgICAgICAgICAgICAgICAnY2xpY2sgLnRvZ2dsZS1vdHInOiAndG9nZ2xlT1RSTWVudScsCiAgICAgICAgICAgICAgICAnY2xpY2sgLnN0YXJ0LW90cic6ICdzdGFydE9UUkZyb21Ub29sYmFyJywKICAgICAgICAgICAgICAgICdjbGljayAuZW5kLW90cic6ICdlbmRPVFInLAogICAgICAgICAgICAgICAgJ2NsaWNrIC5hdXRoLW90cic6ICdhdXRoT1RSJywKICAgICAgICAgICAgICAgICdjbGljayAudG9nZ2xlLWNhbGwnOiAndG9nZ2xlQ2FsbCcsCiAgICAgICAgICAgICAgICAnbW91c2Vkb3duIC5kcmFncmVzaXplLXRtJzogJ29uRHJhZ1Jlc2l6ZVN0YXJ0JwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCl7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm1lc3NhZ2VzLm9uKCdhZGQnLCB0aGlzLm9uTWVzc2FnZUFkZGVkLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oJ3Nob3cnLCB0aGlzLnNob3csIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbignZGVzdHJveScsIHRoaXMuaGlkZSwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCdjaGFuZ2UnLCB0aGlzLm9uQ2hhbmdlLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oJ3Nob3dPVFJFcnJvcicsIHRoaXMuc2hvd09UUkVycm9yLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oJ2J1ZGR5U3RhcnRzT1RSJywgdGhpcy5idWRkeVN0YXJ0c09UUiwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCdzaG93SGVscE1lc3NhZ2VzJywgdGhpcy5zaG93SGVscE1lc3NhZ2VzLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oJ3NlbmRNZXNzYWdlU3RhbnphJywgdGhpcy5zZW5kTWVzc2FnZVN0YW56YSwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCdzaG93U2VudE9UUk1lc3NhZ2UnLCBmdW5jdGlvbiAodGV4dCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd01lc3NhZ2UoeydtZXNzYWdlJzogdGV4dCwgJ3NlbmRlcic6ICdtZSd9KTsKICAgICAgICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbignc2hvd1JlY2VpdmVkT1RSTWVzc2FnZScsIGZ1bmN0aW9uICh0ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TWVzc2FnZSh7J21lc3NhZ2UnOiB0ZXh0LCAnc2VuZGVyJzogJ3RoZW0nfSk7CiAgICAgICAgICAgICAgICB9LCB0aGlzKTsKCiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVZDYXJkKCk7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5pbnNlcnRBZnRlcihjb252ZXJzZS5jaGF0Ym94dmlld3MuZ2V0KCJjb250cm9sYm94IikuJGVsKTsKICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyKCkubW9kZWwubWVzc2FnZXMuZmV0Y2goe2FkZDogdHJ1ZX0pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubW9kZWwuZ2V0KCdtaW5pbWl6ZWQnKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3coKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgoXy5jb250YWlucyhbVU5WRVJJRklFRCwgVkVSSUZJRURdLCB0aGlzLm1vZGVsLmdldCgnb3RyX3N0YXR1cycpKSkgfHwgY29udmVyc2UudXNlX290cl9ieV9kZWZhdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5pbml0aWF0ZU9UUigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5hdHRyKCdpZCcsIHRoaXMubW9kZWwuZ2V0KCdib3hfaWQnKSkKICAgICAgICAgICAgICAgICAgICAuaHRtbChjb252ZXJzZS50ZW1wbGF0ZXMuY2hhdGJveCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uZXh0ZW5kKHRoaXMubW9kZWwudG9KU09OKCksIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvd190b29sYmFyOiBjb252ZXJzZS5zaG93X3Rvb2xiYXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsX3BlcnNvbmFsX21lc3NhZ2U6IF9fKCdQZXJzb25hbCBtZXNzYWdlJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJUb29sYmFyKCkucmVuZGVyQXZhdGFyKCk7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5lbWl0KCdjaGF0Qm94T3BlbmVkJywgdGhpcyk7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5yZWZyZXNoV2Via2l0KCk7CiAgICAgICAgICAgICAgICB9LCA1MCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zaG93U3RhdHVzTWVzc2FnZSgpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaW5pdERyYWdSZXNpemU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMucHJldl9wYWdlWSA9IDA7IC8vIFRvIHN0b3JlIGxhc3Qga25vd24gbW91c2UgcG9zaXRpb24KICAgICAgICAgICAgICAgIGlmIChjb252ZXJzZS5jb25uZWN0aW9uLmNvbm5lY3RlZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGVpZ2h0ID0gdGhpcy5tb2RlbC5nZXQoJ2hlaWdodCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzaG93U3RhdHVzTm90aWZpY2F0aW9uOiBmdW5jdGlvbiAobWVzc2FnZSwga2VlcF9vbGQpIHsKICAgICAgICAgICAgICAgIHZhciAkY2hhdF9jb250ZW50ID0gdGhpcy4kZWwuZmluZCgnLmNoYXQtY29udGVudCcpOwogICAgICAgICAgICAgICAgaWYgKCFrZWVwX29sZCkgewogICAgICAgICAgICAgICAgICAgICRjaGF0X2NvbnRlbnQuZmluZCgnZGl2LmNoYXQtZXZlbnQnKS5yZW1vdmUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICRjaGF0X2NvbnRlbnQuYXBwZW5kKCQoJzxkaXYgY2xhc3M9ImNoYXQtZXZlbnQiPjwvZGl2PicpLnRleHQobWVzc2FnZSkpOwogICAgICAgICAgICAgICAgdGhpcy5zY3JvbGxEb3duKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBjbGVhckNoYXRSb29tTWVzc2FnZXM6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBldiAhPT0gInVuZGVmaW5lZCIpIHsgZXYuc3RvcFByb3BhZ2F0aW9uKCk7IH0KICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBjb25maXJtKF9fKCJBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gY2xlYXIgdGhlIG1lc3NhZ2VzIGZyb20gdGhpcyByb29tPyIpKTsKICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5maW5kKCcuY2hhdC1jb250ZW50JykuZW1wdHkoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2hvd01lc3NhZ2U6IGZ1bmN0aW9uIChtc2dfZGljdCkgewogICAgICAgICAgICAgICAgdmFyICRjb250ZW50ID0gdGhpcy4kZWwuZmluZCgnLmNoYXQtY29udGVudCcpLAogICAgICAgICAgICAgICAgICAgIG1zZ190aW1lID0gbW9tZW50KG1zZ19kaWN0LnRpbWUpIHx8IG1vbWVudCwKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gbXNnX2RpY3QubWVzc2FnZSwKICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IHRleHQubWF0Y2goL15cLyguKj8pKD86ICguKikpPyQvKSwKICAgICAgICAgICAgICAgICAgICBmdWxsbmFtZSA9IG1zZ19kaWN0LmZ1bGxuYW1lIHx8IHRoaXMubW9kZWwuZ2V0KCdmdWxsbmFtZScpLCAvLyBYWFggUGVyaGFwcyBhbHdheXMgdXNlIG1vZGVsJ3M/CiAgICAgICAgICAgICAgICAgICAgZXh0cmFfY2xhc3NlcyA9IG1zZ19kaWN0LmRlbGF5ZWQgJiYgJ2RlbGF5ZWQnIHx8ICcnLAogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLCB1c2VybmFtZTsKCiAgICAgICAgICAgICAgICBpZiAoKG1hdGNoKSAmJiAobWF0Y2hbMV0gPT09ICdtZScpKSB7CiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvXlwvbWUvLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUgPSBjb252ZXJzZS50ZW1wbGF0ZXMuYWN0aW9uOwogICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lID0gZnVsbG5hbWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgIHsKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZSA9IGNvbnZlcnNlLnRlbXBsYXRlcy5tZXNzYWdlOwogICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lID0gbXNnX2RpY3Quc2VuZGVyID09PSAnbWUnICYmIF9fKCdtZScpIHx8IGZ1bGxuYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJGNvbnRlbnQuZmluZCgnZGl2LmNoYXQtZXZlbnQnKS5yZW1vdmUoKTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc19jaGF0cm9vbSAmJiBtc2dfZGljdC5zZW5kZXIgPT0gJ3RoZW0nICYmIChuZXcgUmVnRXhwKCJcXGIiK3RoaXMubW9kZWwuZ2V0KCduaWNrJykrIlxcYiIpKS50ZXN0KHRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQWRkIHNwZWNpYWwgY2xhc3MgdG8gbWFyayBncm91cGNoYXQgbWVzc2FnZXMgaW4gd2hpY2ggd2UKICAgICAgICAgICAgICAgICAgICAvLyBhcmUgbWVudGlvbmVkLgogICAgICAgICAgICAgICAgICAgIGV4dHJhX2NsYXNzZXMgKz0gJyBtZW50aW9uZWQnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSB0ZW1wbGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgJ3NlbmRlcic6IG1zZ19kaWN0LnNlbmRlciwKICAgICAgICAgICAgICAgICAgICAndGltZSc6IG1zZ190aW1lLmZvcm1hdCgnaGg6bW0nKSwKICAgICAgICAgICAgICAgICAgICAndXNlcm5hbWUnOiB1c2VybmFtZSwKICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZSc6ICcnLAogICAgICAgICAgICAgICAgICAgICdleHRyYV9jbGFzc2VzJzogZXh0cmFfY2xhc3NlcwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAkY29udGVudC5hcHBlbmQoJChtZXNzYWdlKS5jaGlsZHJlbignLmNoYXQtbWVzc2FnZS1jb250ZW50JykuZmlyc3QoKS50ZXh0KHRleHQpLmFkZEh5cGVybGlua3MoKS5hZGRFbW90aWNvbnMoKS5wYXJlbnQoKSk7CiAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbERvd24oKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHNob3dIZWxwTWVzc2FnZXM6IGZ1bmN0aW9uIChtc2dzLCB0eXBlLCBzcGlubmVyKSB7CiAgICAgICAgICAgICAgICB2YXIgJGNoYXRfY29udGVudCA9IHRoaXMuJGVsLmZpbmQoJy5jaGF0LWNvbnRlbnQnKSwgaSwKICAgICAgICAgICAgICAgICAgICBtc2dzX2xlbmd0aCA9IG1zZ3MubGVuZ3RoOwogICAgICAgICAgICAgICAgZm9yIChpPTA7IGk8bXNnc19sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICRjaGF0X2NvbnRlbnQuYXBwZW5kKCQoJzxkaXYgY2xhc3M9ImNoYXQtJysodHlwZXx8J2luZm8nKSsnIj4nK21zZ3NbaV0rJzwvZGl2PicpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChzcGlubmVyID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgJGNoYXRfY29udGVudC5hcHBlbmQoJzxzcGFuIGNsYXNzPSJzcGlubmVyIi8+Jyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNwaW5uZXIgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgJGNoYXRfY29udGVudC5maW5kKCdzcGFuLnNwaW5uZXInKS5yZW1vdmUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNjcm9sbERvd24oKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG9uTWVzc2FnZUFkZGVkOiBmdW5jdGlvbiAobWVzc2FnZSkgewogICAgICAgICAgICAgICAgdmFyIHRpbWUgPSBtZXNzYWdlLmdldCgndGltZScpLAogICAgICAgICAgICAgICAgICAgIHRpbWVzID0gdGhpcy5tb2RlbC5tZXNzYWdlcy5wbHVjaygndGltZScpLAogICAgICAgICAgICAgICAgICAgIHByZXZpb3VzX21lc3NhZ2UsIGlkeCwgdGhpc19kYXRlLCBwcmV2X2RhdGUsIHRleHQsIG1hdGNoOwoKICAgICAgICAgICAgICAgIC8vIElmIHRoaXMgbWVzc2FnZSBpcyBvbiBhIGRpZmZlcmVudCBkYXkgdGhhbiB0aGUgb25lIHJlY2VpdmVkCiAgICAgICAgICAgICAgICAvLyBwcmlvciwgdGhlbiBpbmRpY2F0ZSBpdCBvbiB0aGUgY2hhdGJveC4KICAgICAgICAgICAgICAgIGlkeCA9IF8uaW5kZXhPZih0aW1lcywgdGltZSktMTsKICAgICAgICAgICAgICAgIGlmIChpZHggPj0gMCkgewogICAgICAgICAgICAgICAgICAgIHByZXZpb3VzX21lc3NhZ2UgPSB0aGlzLm1vZGVsLm1lc3NhZ2VzLmF0KGlkeCk7CiAgICAgICAgICAgICAgICAgICAgcHJldl9kYXRlID0gbW9tZW50KHByZXZpb3VzX21lc3NhZ2UuZ2V0KCd0aW1lJykpOwogICAgICAgICAgICAgICAgICAgIGlmIChwcmV2X2RhdGUuaXNCZWZvcmUodGltZSwgJ2RheScpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNfZGF0ZSA9IG1vbWVudCh0aW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgnLmNoYXQtY29udGVudCcpLmFwcGVuZChjb252ZXJzZS50ZW1wbGF0ZXMubmV3X2RheSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc29kYXRlOiB0aGlzX2RhdGUuZm9ybWF0KCJZWVlZLU1NLUREIiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRlc3RyaW5nOiB0aGlzX2RhdGUuZm9ybWF0KCJkZGRkIE1NTSBEbyBZWVlZIikKICAgICAgICAgICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLmdldChDT01QT1NJTkcpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93U3RhdHVzTm90aWZpY2F0aW9uKG1lc3NhZ2UuZ2V0KCdmdWxsbmFtZScpKycgJytfXygnaXMgdHlwaW5nJykpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobWVzc2FnZS5nZXQoUEFVU0VEKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1N0YXR1c05vdGlmaWNhdGlvbihtZXNzYWdlLmdldCgnZnVsbG5hbWUnKSsnICcrX18oJ2hhcyBzdG9wcGVkIHR5cGluZycpKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd01lc3NhZ2UoXy5jbG9uZShtZXNzYWdlLmF0dHJpYnV0ZXMpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgobWVzc2FnZS5nZXQoJ3NlbmRlcicpICE9ICdtZScpICYmIChjb252ZXJzZS53aW5kb3dTdGF0ZSA9PSAnYmx1cicpKSB7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuaW5jcmVtZW50TXNnQ291bnRlcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2Nyb2xsRG93bigpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2VuZE1lc3NhZ2VTdGFuemE6IGZ1bmN0aW9uICh0ZXh0KSB7CiAgICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICogU2VuZHMgdGhlIGFjdHVhbCBYTUwgc3RhbnphIHRvIHRoZSBYTVBQIHNlcnZlci4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgLy8gVE9ETzogTG9vayBpbiBDaGF0UGFydG5lcnMgdG8gc2VlIHdoYXQgcmVzb3VyY2VzIHdlIGhhdmUgZm9yIHRoZSByZWNpcGllbnQuCiAgICAgICAgICAgICAgICAvLyBpZiB3ZSBoYXZlIG9uZSByZXNvdXJjZSwgd2Ugc2VudCB0byBvbmx5IHRoYXQgcmVzb3VyY2VzLCBpZiB3ZSBoYXZlIG11bHRpcGxlCiAgICAgICAgICAgICAgICAvLyB3ZSBzZW5kIHRvIHRoZSBiYXJlIGppZC4KICAgICAgICAgICAgICAgIHZhciB0aW1lc3RhbXAgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpOwogICAgICAgICAgICAgICAgdmFyIGJhcmVfamlkID0gdGhpcy5tb2RlbC5nZXQoJ2ppZCcpOwogICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSAkbXNnKHtmcm9tOiBjb252ZXJzZS5jb25uZWN0aW9uLmppZCwgdG86IGJhcmVfamlkLCB0eXBlOiAnY2hhdCcsIGlkOiB0aW1lc3RhbXB9KQogICAgICAgICAgICAgICAgICAgIC5jKCdib2R5JykudCh0ZXh0KS51cCgpCiAgICAgICAgICAgICAgICAgICAgLmMoJ2FjdGl2ZScsIHsneG1sbnMnOiAnaHR0cDovL2phYmJlci5vcmcvcHJvdG9jb2wvY2hhdHN0YXRlcyd9KTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24uc2VuZChtZXNzYWdlKTsKICAgICAgICAgICAgICAgIGlmIChjb252ZXJzZS5mb3J3YXJkX21lc3NhZ2VzKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRm9yd2FyZCB0aGUgbWVzc2FnZSwgc28gdGhhdCBvdGhlciBjb25uZWN0ZWQgcmVzb3VyY2VzIGFyZSBhbHNvIGF3YXJlIG9mIGl0LgogICAgICAgICAgICAgICAgICAgIHZhciBmb3J3YXJkZWQgPSAkbXNnKHt0bzpjb252ZXJzZS5iYXJlX2ppZCwgdHlwZTonY2hhdCcsIGlkOnRpbWVzdGFtcH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jKCdmb3J3YXJkZWQnLCB7eG1sbnM6J3Vybjp4bXBwOmZvcndhcmQ6MCd9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYygnZGVsYXknLCB7eG1uczondXJuOnhtcHA6ZGVsYXknLHN0YW1wOnRpbWVzdGFtcH0pLnVwKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmNub2RlKG1lc3NhZ2UudHJlZSgpKTsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLnNlbmQoZm9yd2FyZGVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHNlbmRNZXNzYWdlOiBmdW5jdGlvbiAodGV4dCkgewogICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gdGV4dC5yZXBsYWNlKC9eXHMqLywgIiIpLm1hdGNoKC9eXC8oLiopXHMqJC8pLCBtc2dzOwogICAgICAgICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoWzFdID09PSAiY2xlYXIiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNsZWFyTWVzc2FnZXMoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobWF0Y2hbMV0gPT09ICJoZWxwIikgewogICAgICAgICAgICAgICAgICAgICAgICBtc2dzID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxzdHJvbmc+L2hlbHA8L3N0cm9uZz46JytfXygnU2hvdyB0aGlzIG1lbnUnKSsnJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8c3Ryb25nPi9tZTwvc3Ryb25nPjonK19fKCdXcml0ZSBpbiB0aGUgdGhpcmQgcGVyc29uJykrJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPHN0cm9uZz4vY2xlYXI8L3N0cm9uZz46JytfXygnUmVtb3ZlIG1lc3NhZ2VzJykrJycKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0hlbHBNZXNzYWdlcyhtc2dzKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGNvbnZlcnNlLmFsbG93X290cikgJiYgKG1hdGNoWzFdID09PSAiZW5kb3RyIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZW5kT1RSKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoY29udmVyc2UuYWxsb3dfb3RyKSAmJiAobWF0Y2hbMV0gPT09ICJvdHIiKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5tb2RlbC5pbml0aWF0ZU9UUigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChfLmNvbnRhaW5zKFtVTlZFUklGSUVELCBWRVJJRklFRF0sIHRoaXMubW9kZWwuZ2V0KCdvdHJfc3RhdHVzJykpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gT2ZmLXRoZS1yZWNvcmQgZW5jcnlwdGlvbiBpcyBhY3RpdmUKICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm90ci5zZW5kTXNnKHRleHQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwudHJpZ2dlcignc2hvd1NlbnRPVFJNZXNzYWdlJywgdGV4dCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIFdlIG9ubHkgc2F2ZSB1bmVuY3J5cHRlZCBtZXNzYWdlcy4KICAgICAgICAgICAgICAgICAgICB2YXIgZnVsbG5hbWUgPSBjb252ZXJzZS54bXBwc3RhdHVzLmdldCgnZnVsbG5hbWUnKTsKICAgICAgICAgICAgICAgICAgICBmdWxsbmFtZSA9IF8uaXNFbXB0eShmdWxsbmFtZSk/IGNvbnZlcnNlLmJhcmVfamlkOiBmdWxsbmFtZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm1lc3NhZ2VzLmNyZWF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bGxuYW1lOiBmdWxsbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgc2VuZGVyOiAnbWUnLAogICAgICAgICAgICAgICAgICAgICAgICB0aW1lOiBtb21lbnQoKS5mb3JtYXQoKSwKICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogdGV4dAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2VuZE1lc3NhZ2VTdGFuemEodGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBrZXlQcmVzc2VkOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIHZhciAkdGV4dGFyZWEgPSAkKGV2LnRhcmdldCksCiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSwgbm90aWZ5LCBjb21wb3Npbmc7CiAgICAgICAgICAgICAgICBpZihldi5rZXlDb2RlID09IEtFWS5FTlRFUikgewogICAgICAgICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSA9ICR0ZXh0YXJlYS52YWwoKTsKICAgICAgICAgICAgICAgICAgICAkdGV4dGFyZWEudmFsKCcnKS5mb2N1cygpOwogICAgICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlICE9PSAnJykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5tb2RlbC5nZXQoJ2NoYXRyb29tJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VuZENoYXRSb29tTWVzc2FnZShtZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VuZE1lc3NhZ2UobWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuZW1pdCgnbWVzc2FnZVNlbmQnLCBtZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuZGF0YSgnY29tcG9zaW5nJywgZmFsc2UpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdGhpcy5tb2RlbC5nZXQoJ2NoYXRyb29tJykpIHsKICAgICAgICAgICAgICAgICAgICAvLyBjb21wb3NpbmcgZGF0YSBpcyBvbmx5IGZvciBzaW5nbGUgdXNlciBjaGF0CiAgICAgICAgICAgICAgICAgICAgY29tcG9zaW5nID0gdGhpcy4kZWwuZGF0YSgnY29tcG9zaW5nJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFjb21wb3NpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV2LmtleUNvZGUgIT0gNDcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIGRvbid0IHNlbmQgY29tcG9zaW5nIG1lc3NhZ2VzIGlmIHRoZSBtZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzdGFydHMgd2l0aCBmb3J3YXJkLXNsYXNoLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm90aWZ5ID0gJG1zZyh7J3RvJzp0aGlzLm1vZGVsLmdldCgnamlkJyksICd0eXBlJzogJ2NoYXQnfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYygnY29tcG9zaW5nJywgeyd4bWxucyc6J2h0dHA6Ly9qYWJiZXIub3JnL3Byb3RvY29sL2NoYXRzdGF0ZXMnfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLnNlbmQobm90aWZ5KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5kYXRhKCdjb21wb3NpbmcnLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBvbkRyYWdSZXNpemVTdGFydDogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBpZiAoIWNvbnZlcnNlLmFsbG93X2RyYWdyZXNpemUpIHsgcmV0dXJuIHRydWU7IH0KICAgICAgICAgICAgICAgIC8vIFJlY29yZCBlbGVtZW50IGF0dHJpYnV0ZXMgZm9yIG1vdXNlTW92ZSgpLgogICAgICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSB0aGlzLiRlbC5jaGlsZHJlbignLmJveC1mbHlvdXQnKS5oZWlnaHQoKTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJlc2l6ZWRfY2hhdGJveCA9IHRoaXM7CiAgICAgICAgICAgICAgICB0aGlzLnByZXZfcGFnZVkgPSBldi5wYWdlWTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHNldENoYXRCb3hIZWlnaHQ6IGZ1bmN0aW9uIChoZWlnaHQpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5tb2RlbC5nZXQoJ21pbmltaXplZCcpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuY2hpbGRyZW4oJy5ib3gtZmx5b3V0JylbMF0uc3R5bGUuaGVpZ2h0ID0gY29udmVyc2UuYXBwbHlIZWlnaHRSZXNpc3RhbmNlKGhlaWdodCkrJ3B4JzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlc2l6ZUNoYXRCb3g6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgdmFyIGRpZmYgPSBldi5wYWdlWSAtIHRoaXMucHJldl9wYWdlWTsKICAgICAgICAgICAgICAgIGlmICghZGlmZikgeyByZXR1cm47IH0KICAgICAgICAgICAgICAgIHRoaXMuaGVpZ2h0IC09IGRpZmY7CiAgICAgICAgICAgICAgICB0aGlzLnByZXZfcGFnZVkgPSBldi5wYWdlWTsKICAgICAgICAgICAgICAgIHRoaXMuc2V0Q2hhdEJveEhlaWdodCh0aGlzLmhlaWdodCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBjbGVhck1lc3NhZ2VzOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGlmIChldiAmJiBldi5wcmV2ZW50RGVmYXVsdCkgeyBldi5wcmV2ZW50RGVmYXVsdCgpOyB9CiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gY29uZmlybShfXygiQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIGNsZWFyIHRoZSBtZXNzYWdlcyBmcm9tIHRoaXMgY2hhdCBib3g/IikpOwogICAgICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLmZpbmQoJy5jaGF0LWNvbnRlbnQnKS5lbXB0eSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwubWVzc2FnZXMucmVzZXQoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm1lc3NhZ2VzLmJyb3dzZXJTdG9yYWdlLl9jbGVhcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpbnNlcnRFbW90aWNvbjogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBldi5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmZpbmQoJy50b2dnbGUtc21pbGV5IHVsJykuc2xpZGVUb2dnbGUoMjAwKTsKICAgICAgICAgICAgICAgIHZhciAkdGV4dGJveCA9IHRoaXMuJGVsLmZpbmQoJ3RleHRhcmVhLmNoYXQtdGV4dGFyZWEnKTsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9ICR0ZXh0Ym94LnZhbCgpOwogICAgICAgICAgICAgICAgdmFyICR0YXJnZXQgPSAkKGV2LnRhcmdldCk7CiAgICAgICAgICAgICAgICAkdGFyZ2V0ID0gJHRhcmdldC5pcygnYScpID8gJHRhcmdldCA6ICR0YXJnZXQuY2hpbGRyZW4oJ2EnKTsKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSAmJiAodmFsdWVbdmFsdWUubGVuZ3RoLTFdICE9PSAnICcpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZSArICcgJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICR0ZXh0Ym94LmZvY3VzKCkudmFsKHZhbHVlKyR0YXJnZXQuZGF0YSgnZW1vdGljb24nKSsnICcpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgdG9nZ2xlRW1vdGljb25NZW51OiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGV2LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgnLnRvZ2dsZS1zbWlsZXkgdWwnKS5zbGlkZVRvZ2dsZSgyMDApOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgdG9nZ2xlT1RSTWVudTogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBldi5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmZpbmQoJy50b2dnbGUtb3RyIHVsJykuc2xpZGVUb2dnbGUoMjAwKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHNob3dPVFJFcnJvcjogZnVuY3Rpb24gKG1zZykgewogICAgICAgICAgICAgICAgaWYgKG1zZyA9PSAnTWVzc2FnZSBjYW5ub3QgYmUgc2VudCBhdCB0aGlzIHRpbWUuJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0hlbHBNZXNzYWdlcygKICAgICAgICAgICAgICAgICAgICAgICAgW19fKCdZb3VyIG1lc3NhZ2UgY291bGQgbm90IGJlIHNlbnQnKV0sICdlcnJvcicpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChtc2cgPT0gJ1JlY2VpdmVkIGFuIHVuZW5jcnlwdGVkIG1lc3NhZ2UuJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0hlbHBNZXNzYWdlcygKICAgICAgICAgICAgICAgICAgICAgICAgW19fKCdXZSByZWNlaXZlZCBhbiB1bmVuY3J5cHRlZCBtZXNzYWdlJyldLCAnZXJyb3InKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobXNnID09ICdSZWNlaXZlZCBhbiB1bnJlYWRhYmxlIGVuY3J5cHRlZCBtZXNzYWdlLicpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dIZWxwTWVzc2FnZXMoCiAgICAgICAgICAgICAgICAgICAgICAgIFtfXygnV2UgcmVjZWl2ZWQgYW4gdW5yZWFkYWJsZSBlbmNyeXB0ZWQgbWVzc2FnZScpXSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2Vycm9yJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0hlbHBNZXNzYWdlcyhbJ0VuY3J5cHRpb24gZXJyb3Igb2NjdXJlZDogJyttc2ddLCAnZXJyb3InKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJPVFIgRVJST1I6Iittc2cpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgYnVkZHlTdGFydHNPVFI6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgdGhpcy5zaG93SGVscE1lc3NhZ2VzKFtfXygnVGhpcyB1c2VyIGhhcyByZXF1ZXN0ZWQgYW4gZW5jcnlwdGVkIHNlc3Npb24uJyldKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuaW5pdGlhdGVPVFIoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHN0YXJ0T1RSRnJvbVRvb2xiYXI6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgJChldi50YXJnZXQpLnBhcmVudCgpLnBhcmVudCgpLnNsaWRlVXAoKTsKICAgICAgICAgICAgICAgIGV2LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5pbml0aWF0ZU9UUigpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgZW5kT1RSOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZXYgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICBldi5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuZW5kT1RSKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBhdXRoT1RSOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIHZhciBzY2hlbWUgPSAkKGV2LnRhcmdldCkuZGF0YSgpLnNjaGVtZTsKICAgICAgICAgICAgICAgIHZhciByZXN1bHQsIHF1ZXN0aW9uLCBhbnN3ZXI7CiAgICAgICAgICAgICAgICBpZiAoc2NoZW1lID09PSAnZmluZ2VycHJpbnQnKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gY29uZmlybShfXygnSGVyZSBhcmUgdGhlIGZpbmdlcnByaW50cywgcGxlYXNlIGNvbmZpcm0gdGhlbSB3aXRoICUxJHMsIG91dHNpZGUgb2YgdGhpcyBjaGF0LlxuXG5GaW5nZXJwcmludCBmb3IgeW91LCAlMiRzOiAlMyRzXG5cbkZpbmdlcnByaW50IGZvciAlMSRzOiAlNCRzXG5cbklmIHlvdSBoYXZlIGNvbmZpcm1lZCB0aGF0IHRoZSBmaW5nZXJwcmludHMgbWF0Y2gsIGNsaWNrIE9LLCBvdGhlcndpc2UgY2xpY2sgQ2FuY2VsLicsIFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuZ2V0KCdmdWxsbmFtZScpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UueG1wcHN0YXR1cy5nZXQoJ2Z1bGxuYW1lJyl8fGNvbnZlcnNlLmJhcmVfamlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vdHIucHJpdi5maW5nZXJwcmludCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vdHIudGhlaXJfcHJpdl9way5maW5nZXJwcmludCgpCiAgICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0ID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuc2F2ZSh7J290cl9zdGF0dXMnOiBWRVJJRklFRH0pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuc2F2ZSh7J290cl9zdGF0dXMnOiBVTlZFUklGSUVEfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzY2hlbWUgPT09ICdzbXAnKSB7CiAgICAgICAgICAgICAgICAgICAgYWxlcnQoX18oJ1lvdSB3aWxsIGJlIHByb21wdGVkIHRvIHByb3ZpZGUgYSBzZWN1cml0eSBxdWVzdGlvbiBhbmQgdGhlbiBhbiBhbnN3ZXIgdG8gdGhhdCBxdWVzdGlvbi5cblxuWW91ciBidWRkeSB3aWxsIHRoZW4gYmUgcHJvbXB0ZWQgdGhlIHNhbWUgcXVlc3Rpb24gYW5kIGlmIHRoZXkgdHlwZSB0aGUgZXhhY3Qgc2FtZSBhbnN3ZXIgKGNhc2Ugc2Vuc2l0aXZlKSwgdGhlaXIgaWRlbnRpdHkgd2lsbCBiZSB2ZXJpZmllZC4nKSk7CiAgICAgICAgICAgICAgICAgICAgcXVlc3Rpb24gPSBwcm9tcHQoX18oJ1doYXQgaXMgeW91ciBzZWN1cml0eSBxdWVzdGlvbj8nKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHF1ZXN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFuc3dlciA9IHByb21wdChfXygnV2hhdCBpcyB0aGUgYW5zd2VyIHRvIHRoZSBzZWN1cml0eSBxdWVzdGlvbj8nKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub3RyLnNtcFNlY3JldChhbnN3ZXIsIHF1ZXN0aW9uKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0hlbHBNZXNzYWdlcyhbX18oJ0ludmFsaWQgYXV0aGVudGljYXRpb24gc2NoZW1lIHByb3ZpZGVkJyldLCAnZXJyb3InKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHRvZ2dsZUNhbGw6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgZXYuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5lbWl0KCdjYWxsQnV0dG9uQ2xpY2tlZCcsIHsKICAgICAgICAgICAgICAgICAgICBjb25uZWN0aW9uOiBjb252ZXJzZS5jb25uZWN0aW9uLAogICAgICAgICAgICAgICAgICAgIG1vZGVsOiB0aGlzLm1vZGVsCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG9uQ2hhbmdlOiBmdW5jdGlvbiAoaXRlbSwgY2hhbmdlZCkgewogICAgICAgICAgICAgICAgaWYgKF8uaGFzKGl0ZW0uY2hhbmdlZCwgJ2NoYXRfc3RhdHVzJykpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY2hhdF9zdGF0dXMgPSBpdGVtLmdldCgnY2hhdF9zdGF0dXMnKSwKICAgICAgICAgICAgICAgICAgICAgICAgZnVsbG5hbWUgPSBpdGVtLmdldCgnZnVsbG5hbWUnKTsKICAgICAgICAgICAgICAgICAgICBmdWxsbmFtZSA9IF8uaXNFbXB0eShmdWxsbmFtZSk/IGl0ZW0uZ2V0KCdqaWQnKTogZnVsbG5hbWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuJGVsLmlzKCc6dmlzaWJsZScpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGF0X3N0YXR1cyA9PT0gJ29mZmxpbmUnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dTdGF0dXNOb3RpZmljYXRpb24oZnVsbG5hbWUrJyAnKydoYXMgZ29uZSBvZmZsaW5lJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hhdF9zdGF0dXMgPT09ICdhd2F5JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93U3RhdHVzTm90aWZpY2F0aW9uKGZ1bGxuYW1lKycgJysnaGFzIGdvbmUgYXdheScpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChjaGF0X3N0YXR1cyA9PT0gJ2RuZCcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dTdGF0dXNOb3RpZmljYXRpb24oZnVsbG5hbWUrJyAnKydpcyBidXN5Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hhdF9zdGF0dXMgPT09ICdvbmxpbmUnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5maW5kKCdkaXYuY2hhdC1ldmVudCcpLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmVtaXQoJ2J1ZGR5U3RhdHVzQ2hhbmdlZCcsIGl0ZW0uYXR0cmlidXRlcywgaXRlbS5nZXQoJ2NoYXRfc3RhdHVzJykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKF8uaGFzKGl0ZW0uY2hhbmdlZCwgJ3N0YXR1cycpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93U3RhdHVzTWVzc2FnZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmVtaXQoJ2J1ZGR5U3RhdHVzTWVzc2FnZUNoYW5nZWQnLCBpdGVtLmF0dHJpYnV0ZXMsIGl0ZW0uZ2V0KCdzdGF0dXMnKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoXy5oYXMoaXRlbS5jaGFuZ2VkLCAnaW1hZ2UnKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyQXZhdGFyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoXy5oYXMoaXRlbS5jaGFuZ2VkLCAnb3RyX3N0YXR1cycpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJUb29sYmFyKCkuaW5mb3JtT1RSQ2hhbmdlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoXy5oYXMoaXRlbS5jaGFuZ2VkLCAnbWluaW1pemVkJykpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5nZXQoJ21pbmltaXplZCcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWF4aW1pemUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBUT0RPIGNoZWNrIGZvciBjaGFuZ2VkIGZ1bGxuYW1lIGFzIHdlbGwKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHNob3dTdGF0dXNNZXNzYWdlOiBmdW5jdGlvbiAobXNnKSB7CiAgICAgICAgICAgICAgICBtc2cgPSBtc2cgfHwgdGhpcy5tb2RlbC5nZXQoJ3N0YXR1cycpOwogICAgICAgICAgICAgICAgaWYgKG1zZykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLmZpbmQoJ3AudXNlci1jdXN0b20tbWVzc2FnZScpLnRleHQobXNnKS5hdHRyKCd0aXRsZScsIG1zZyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGNsb3NlOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGlmIChldiAmJiBldi5wcmV2ZW50RGVmYXVsdCkgeyBldi5wcmV2ZW50RGVmYXVsdCgpOyB9CiAgICAgICAgICAgICAgICBpZiAoY29udmVyc2UuY29ubmVjdGlvbi5jb25uZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC50cmlnZ2VyKCdoaWRlJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb252ZXJzZS5lbWl0KCdjaGF0Qm94Q2xvc2VkJywgdGhpcyk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG1heGltaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAvLyBSZXN0b3JlcyBhIG1pbmltaXplZCBjaGF0IGJveAogICAgICAgICAgICAgICAgdGhpcy4kZWwuaW5zZXJ0QWZ0ZXIoY29udmVyc2UuY2hhdGJveHZpZXdzLmdldCgiY29udHJvbGJveCIpLiRlbCkuc2hvdygnZmFzdCcsICQucHJveHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJlZnJlc2hXZWJraXQoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZvY3VzKCk7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuZW1pdCgnY2hhdEJveE1heGltaXplZCcsIHRoaXMpOwogICAgICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgbWluaW1pemU6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgaWYgKGV2ICYmIGV2LnByZXZlbnREZWZhdWx0KSB7IGV2LnByZXZlbnREZWZhdWx0KCk7IH0KICAgICAgICAgICAgICAgIC8vIE1pbmltaXplcyBhIGNoYXQgYm94CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm1pbmltaXplKCk7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5oaWRlKCdmYXN0JywgY29udmVyc2UucmVmcmVzaHdlYmtpdCk7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5lbWl0KCdjaGF0Qm94TWluaW1pemVkJywgdGhpcyk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB1cGRhdGVWQ2FyZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGppZCA9IHRoaXMubW9kZWwuZ2V0KCdqaWQnKSwKICAgICAgICAgICAgICAgICAgICBjb250YWN0ID0gY29udmVyc2Uucm9zdGVyLmdldChqaWQpOwogICAgICAgICAgICAgICAgaWYgKChjb250YWN0KSAmJiAoIWNvbnRhY3QuZ2V0KCd2Y2FyZF91cGRhdGVkJykpKSB7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuZ2V0VkNhcmQoCiAgICAgICAgICAgICAgICAgICAgICAgIGppZCwKICAgICAgICAgICAgICAgICAgICAgICAgJC5wcm94eShmdW5jdGlvbiAoamlkLCBmdWxsbmFtZSwgaW1hZ2UsIGltYWdlX3R5cGUsIHVybCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5zYXZlKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZnVsbG5hbWUnIDogZnVsbG5hbWUgfHwgamlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd1cmwnOiB1cmwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2ltYWdlX3R5cGUnOiBpbWFnZV90eXBlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdpbWFnZSc6IGltYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSwgdGhpcyksCiAgICAgICAgICAgICAgICAgICAgICAgICQucHJveHkoZnVuY3Rpb24gKHN0YW56YSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UubG9nKCJDaGF0Qm94Vmlldy5pbml0aWFsaXplOiBBbiBlcnJvciBvY2N1cmVkIHdoaWxlIGZldGNoaW5nIHZjYXJkIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIHRoaXMpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGluZm9ybU9UUkNoYW5nZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGRhdGEgPSB0aGlzLm1vZGVsLnRvSlNPTigpOwogICAgICAgICAgICAgICAgdmFyIG1zZ3MgPSBbXTsKICAgICAgICAgICAgICAgIGlmIChkYXRhLm90cl9zdGF0dXMgPT0gVU5FTkNSWVBURUQpIHsKICAgICAgICAgICAgICAgICAgICBtc2dzLnB1c2goX18oIllvdXIgbWVzc2FnZXMgYXJlIG5vdCBlbmNyeXB0ZWQgYW55bW9yZSIpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YS5vdHJfc3RhdHVzID09IFVOVkVSSUZJRUQpewogICAgICAgICAgICAgICAgICAgIG1zZ3MucHVzaChfXygiWW91ciBtZXNzYWdlcyBhcmUgbm93IGVuY3J5cHRlZCBidXQgeW91ciBidWRkeSdzIGlkZW50aXR5IGhhcyBub3QgYmVlbiB2ZXJpZmllZC4iKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRhdGEub3RyX3N0YXR1cyA9PSBWRVJJRklFRCl7CiAgICAgICAgICAgICAgICAgICAgbXNncy5wdXNoKF9fKCJZb3VyIGJ1ZGR5J3MgaWRlbnRpZnkgaGFzIGJlZW4gdmVyaWZpZWQuIikpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhLm90cl9zdGF0dXMgPT0gRklOSVNIRUQpewogICAgICAgICAgICAgICAgICAgIG1zZ3MucHVzaChfXygiWW91ciBidWRkeSBoYXMgZW5kZWQgZW5jcnlwdGlvbiBvbiB0aGVpciBlbmQsIHlvdSBzaG91bGQgZG8gdGhlIHNhbWUuIikpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2hvd0hlbHBNZXNzYWdlcyhtc2dzLCAnaW5mbycsIGZhbHNlKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlbmRlclRvb2xiYXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmIChjb252ZXJzZS5zaG93X3Rvb2xiYXIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IHRoaXMubW9kZWwudG9KU09OKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEub3RyX3N0YXR1cyA9PSBVTkVOQ1JZUFRFRCkgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLm90cl90b29sdGlwID0gX18oJ1lvdXIgbWVzc2FnZXMgYXJlIG5vdCBlbmNyeXB0ZWQuIENsaWNrIGhlcmUgdG8gZW5hYmxlIE9UUiBlbmNyeXB0aW9uLicpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YS5vdHJfc3RhdHVzID09IFVOVkVSSUZJRUQpewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLm90cl90b29sdGlwID0gX18oJ1lvdXIgbWVzc2FnZXMgYXJlIGVuY3J5cHRlZCwgYnV0IHlvdXIgYnVkZHkgaGFzIG5vdCBiZWVuIHZlcmlmaWVkLicpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YS5vdHJfc3RhdHVzID09IFZFUklGSUVEKXsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5vdHJfdG9vbHRpcCA9IF9fKCdZb3VyIG1lc3NhZ2VzIGFyZSBlbmNyeXB0ZWQgYW5kIHlvdXIgYnVkZHkgdmVyaWZpZWQuJyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhLm90cl9zdGF0dXMgPT0gRklOSVNIRUQpewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLm90cl90b29sdGlwID0gX18oJ1lvdXIgYnVkZHkgaGFzIGNsb3NlZCB0aGVpciBlbmQgb2YgdGhlIHByaXZhdGUgc2Vzc2lvbiwgeW91IHNob3VsZCBkbyB0aGUgc2FtZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5maW5kKCcuY2hhdC10b29sYmFyJykuaHRtbCgKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UudGVtcGxhdGVzLnRvb2xiYXIoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLmV4dGVuZChkYXRhLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRklOSVNIRUQ6IEZJTklTSEVELAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFVORU5DUllQVEVEOiBVTkVOQ1JZUFRFRCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBVTlZFUklGSUVEOiBVTlZFUklGSUVELAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFZFUklGSUVEOiBWRVJJRklFRCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxvd19vdHI6IGNvbnZlcnNlLmFsbG93X290ciAmJiAhdGhpcy5pc19jaGF0cm9vbSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbF9jbGVhcjogX18oJ0NsZWFyIGFsbCBtZXNzYWdlcycpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsX2VuZF9lbmNyeXB0ZWRfY29udmVyc2F0aW9uOiBfXygnRW5kIGVuY3J5cHRlZCBjb252ZXJzYXRpb24nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbF9oaWRlX3BhcnRpY2lwYW50czogX18oJ0hpZGUgdGhlIGxpc3Qgb2YgcGFydGljaXBhbnRzJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWxfcmVmcmVzaF9lbmNyeXB0ZWRfY29udmVyc2F0aW9uOiBfXygnUmVmcmVzaCBlbmNyeXB0ZWQgY29udmVyc2F0aW9uJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWxfc3RhcnRfY2FsbDogX18oJ1N0YXJ0IGEgY2FsbCcpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsX3N0YXJ0X2VuY3J5cHRlZF9jb252ZXJzYXRpb246IF9fKCdTdGFydCBlbmNyeXB0ZWQgY29udmVyc2F0aW9uJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWxfdmVyaWZ5X3dpdGhfZmluZ2VycHJpbnRzOiBfXygnVmVyaWZ5IHdpdGggZmluZ2VycHJpbnRzJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWxfdmVyaWZ5X3dpdGhfc21wOiBfXygnVmVyaWZ5IHdpdGggU01QJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWxfd2hhdHNfdGhpczogX18oIldoYXRcJ3MgdGhpcz8iKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdHJfc3RhdHVzX2NsYXNzOiBPVFJfQ0xBU1NfTUFQUElOR1tkYXRhLm90cl9zdGF0dXNdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG90cl90cmFuc2xhdGVkX3N0YXR1czogT1RSX1RSQU5TTEFURURfTUFQUElOR1tkYXRhLm90cl9zdGF0dXNdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3dfY2FsbF9idXR0b246IGNvbnZlcnNlLnZpc2libGVfdG9vbGJhcl9idXR0b25zLmNhbGwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvd19jbGVhcl9idXR0b246IGNvbnZlcnNlLnZpc2libGVfdG9vbGJhcl9idXR0b25zLmNsZWFyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3dfZW1vdGljb25zOiBjb252ZXJzZS52aXNpYmxlX3Rvb2xiYXJfYnV0dG9ucy5lbW90aWNvbnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvd19wYXJ0aWNpcGFudHNfdG9nZ2xlOiB0aGlzLmlzX2NoYXRyb29tICYmIGNvbnZlcnNlLnZpc2libGVfdG9vbGJhcl9idXR0b25zLnRvZ2dsZV9wYXJ0aWNpcGFudHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZW5kZXJBdmF0YXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5tb2RlbC5nZXQoJ2ltYWdlJykpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgaW1nX3NyYyA9ICdkYXRhOicrdGhpcy5tb2RlbC5nZXQoJ2ltYWdlX3R5cGUnKSsnO2Jhc2U2NCwnK3RoaXMubW9kZWwuZ2V0KCdpbWFnZScpLAogICAgICAgICAgICAgICAgICAgIGNhbnZhcyA9ICQoJzxjYW52YXMgaGVpZ2h0PSIzMXB4IiB3aWR0aD0iMzFweCIgY2xhc3M9ImF2YXRhciI+PC9jYW52YXM+JykuZ2V0KDApOwoKICAgICAgICAgICAgICAgIGlmICghKGNhbnZhcy5nZXRDb250ZXh0ICYmIGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgICAgICAgICAgdmFyIGltZyA9IG5ldyBJbWFnZSgpOyAgIC8vIENyZWF0ZSBuZXcgSW1hZ2Ugb2JqZWN0CiAgICAgICAgICAgICAgICBpbWcub25sb2FkID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhciByYXRpbyA9IGltZy53aWR0aC9pbWcuaGVpZ2h0OwogICAgICAgICAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2UoaW1nLCAwLDAsIDM1KnJhdGlvLCAzNSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgaW1nLnNyYyA9IGltZ19zcmM7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5maW5kKCcuY2hhdC10aXRsZScpLmJlZm9yZShjYW52YXMpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBmb2N1czogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgnLmNoYXQtdGV4dGFyZWEnKS5mb2N1cygpOwogICAgICAgICAgICAgICAgY29udmVyc2UuZW1pdCgnY2hhdEJveEZvY3VzZWQnLCB0aGlzKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaGlkZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuJGVsLmlzKCc6dmlzaWJsZScpICYmIHRoaXMuJGVsLmNzcygnb3BhY2l0eScpID09ICIxIikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5yZWZyZXNoV2Via2l0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHNob3c6IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuJGVsLmlzKCc6dmlzaWJsZScpICYmIHRoaXMuJGVsLmNzcygnb3BhY2l0eScpID09ICIxIikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZvY3VzKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5mYWRlSW4oY2FsbGJhY2spOwogICAgICAgICAgICAgICAgaWYgKGNvbnZlcnNlLmNvbm5lY3Rpb24uY29ubmVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gV2l0aG91dCBhIGNvbm5lY3Rpb24sIHdlIGhhdmVuJ3QgeWV0IGluaXRpYWxpemVkCiAgICAgICAgICAgICAgICAgICAgLy8gbG9jYWxzdG9yYWdlCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5zYXZlKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbml0RHJhZ1Jlc2l6ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzY3JvbGxEb3duOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgJGNvbnRlbnQgPSB0aGlzLiQoJy5jaGF0LWNvbnRlbnQnKTsKICAgICAgICAgICAgICAgIGlmICgkY29udGVudC5pcygnOnZpc2libGUnKSkgewogICAgICAgICAgICAgICAgICAgICRjb250ZW50LnNjcm9sbFRvcCgkY29udGVudFswXS5zY3JvbGxIZWlnaHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5Db250YWN0c1BhbmVsID0gQmFja2JvbmUuVmlldy5leHRlbmQoewogICAgICAgICAgICB0YWdOYW1lOiAnZGl2JywKICAgICAgICAgICAgY2xhc3NOYW1lOiAnY29udHJvbGJveC1wYW5lJywKICAgICAgICAgICAgaWQ6ICd1c2VycycsCiAgICAgICAgICAgIGV2ZW50czogewogICAgICAgICAgICAgICAgJ2NsaWNrIGEudG9nZ2xlLXhtcHAtY29udGFjdC1mb3JtJzogJ3RvZ2dsZUNvbnRhY3RGb3JtJywKICAgICAgICAgICAgICAgICdzdWJtaXQgZm9ybS5hZGQteG1wcC1jb250YWN0JzogJ2FkZENvbnRhY3RGcm9tRm9ybScsCiAgICAgICAgICAgICAgICAnc3VibWl0IGZvcm0uc2VhcmNoLXhtcHAtY29udGFjdCc6ICdzZWFyY2hDb250YWN0cycsCiAgICAgICAgICAgICAgICAnY2xpY2sgYS5zdWJzY3JpYmUtdG8tdXNlcic6ICdhZGRDb250YWN0RnJvbUxpc3QnCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoY2ZnKSB7CiAgICAgICAgICAgICAgICBjZmcuJHBhcmVudC5hcHBlbmQodGhpcy4kZWwpOwogICAgICAgICAgICAgICAgdGhpcy4kdGFicyA9IGNmZy4kcGFyZW50LnBhcmVudCgpLmZpbmQoJyNjb250cm9sYm94LXRhYnMnKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIG1hcmt1cDsKICAgICAgICAgICAgICAgIHZhciB3aWRnZXRzID0gY29udmVyc2UudGVtcGxhdGVzLmNvbnRhY3RzX3BhbmVsKHsKICAgICAgICAgICAgICAgICAgICBsYWJlbF9vbmxpbmU6IF9fKCdPbmxpbmUnKSwKICAgICAgICAgICAgICAgICAgICBsYWJlbF9idXN5OiBfXygnQnVzeScpLAogICAgICAgICAgICAgICAgICAgIGxhYmVsX2F3YXk6IF9fKCdBd2F5JyksCiAgICAgICAgICAgICAgICAgICAgbGFiZWxfb2ZmbGluZTogX18oJ09mZmxpbmUnKSwKICAgICAgICAgICAgICAgICAgICBsYWJlbF9sb2dvdXQ6IF9fKCdMb2cgb3V0JyksCiAgICAgICAgICAgICAgICAgICAgYWxsb3dfbG9nb3V0OiBjb252ZXJzZS5hbGxvd19sb2dvdXQKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdGhpcy4kdGFicy5hcHBlbmQoY29udmVyc2UudGVtcGxhdGVzLmNvbnRhY3RzX3RhYih7bGFiZWxfY29udGFjdHM6IExBQkVMX0NPTlRBQ1RTfSkpOwogICAgICAgICAgICAgICAgaWYgKGNvbnZlcnNlLnhocl91c2VyX3NlYXJjaCkgewogICAgICAgICAgICAgICAgICAgIG1hcmt1cCA9IGNvbnZlcnNlLnRlbXBsYXRlcy5zZWFyY2hfY29udGFjdCh7CiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsX2NvbnRhY3RfbmFtZTogX18oJ0NvbnRhY3QgbmFtZScpLAogICAgICAgICAgICAgICAgICAgICAgICBsYWJlbF9zZWFyY2g6IF9fKCdTZWFyY2gnKQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtYXJrdXAgPSBjb252ZXJzZS50ZW1wbGF0ZXMuYWRkX2NvbnRhY3RfZm9ybSh7CiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsX2NvbnRhY3RfdXNlcm5hbWU6IF9fKCdDb250YWN0IHVzZXJuYW1lJyksCiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsX2FkZDogX18oJ0FkZCcpCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY29udmVyc2UuYWxsb3dfY29udGFjdF9yZXF1ZXN0cykgewogICAgICAgICAgICAgICAgICAgIHdpZGdldHMgKz0gY29udmVyc2UudGVtcGxhdGVzLmFkZF9jb250YWN0X2Ryb3Bkb3duKHsKICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWxfY2xpY2tfdG9fY2hhdDogX18oJ0NsaWNrIHRvIGFkZCBuZXcgY2hhdCBjb250YWN0cycpLAogICAgICAgICAgICAgICAgICAgICAgICBsYWJlbF9hZGRfY29udGFjdDogX18oJ0FkZCBhIGNvbnRhY3QnKQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy4kZWwuaHRtbCh3aWRnZXRzKTsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmZpbmQoJy5zZWFyY2gteG1wcCB1bCcpLmFwcGVuZChtYXJrdXApOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB0b2dnbGVDb250YWN0Rm9ybTogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgnLnNlYXJjaC14bXBwJykudG9nZ2xlKCdmYXN0JywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmICgkKHRoaXMpLmlzKCc6dmlzaWJsZScpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykuZmluZCgnaW5wdXQudXNlcm5hbWUnKS5mb2N1cygpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2VhcmNoQ29udGFjdHM6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICQuZ2V0SlNPTihjb252ZXJzZS54aHJfdXNlcl9zZWFyY2hfdXJsKyAiP3E9IiArICQoZXYudGFyZ2V0KS5maW5kKCdpbnB1dC51c2VybmFtZScpLnZhbCgpLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgICAgIHZhciAkdWw9ICQoJy5zZWFyY2gteG1wcCB1bCcpOwogICAgICAgICAgICAgICAgICAgICR1bC5maW5kKCdsaS5mb3VuZC11c2VyJykucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgJHVsLmZpbmQoJ2xpLmNoYXQtaW5mbycpLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgIGlmICghZGF0YS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHVsLmFwcGVuZCgnPGxpIGNsYXNzPSJjaGF0LWluZm8iPicrX18oJ05vIHVzZXJzIGZvdW5kJykrJzwvbGk+Jyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICQoZGF0YSkuZWFjaChmdW5jdGlvbiAoaWR4LCBvYmopIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHVsLmFwcGVuZCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJzxsaSBjbGFzcz0iZm91bmQtdXNlciI+PC9saT4nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmFwcGVuZCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCc8YSBjbGFzcz0ic3Vic2NyaWJlLXRvLXVzZXIiIGhyZWY9IiMiIHRpdGxlPSInK19fKCdDbGljayB0byBhZGQgYXMgYSBjaGF0IGNvbnRhY3QnKSsnIj48L2E+JykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYXR0cignZGF0YS1yZWNpcGllbnQnLCBTdHJvcGhlLmVzY2FwZU5vZGUob2JqLmlkKSsnQCcrY29udmVyc2UuZG9tYWluKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50ZXh0KG9iai5mdWxsbmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgYWRkQ29udGFjdEZyb21Gb3JtOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICB2YXIgJGlucHV0ID0gJChldi50YXJnZXQpLmZpbmQoJ2lucHV0Jyk7CiAgICAgICAgICAgICAgICB2YXIgamlkID0gJGlucHV0LnZhbCgpOwogICAgICAgICAgICAgICAgaWYgKCEgamlkKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyBpcyBub3QgYSB2YWxpZCBKSUQKICAgICAgICAgICAgICAgICAgICAkaW5wdXQuYWRkQ2xhc3MoJ2Vycm9yJyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5hZGRDb250YWN0KGppZCk7CiAgICAgICAgICAgICAgICAkKCcuc2VhcmNoLXhtcHAnKS5oaWRlKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBhZGRDb250YWN0RnJvbUxpc3Q6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIHZhciAkdGFyZ2V0ID0gJChldi50YXJnZXQpLAogICAgICAgICAgICAgICAgICAgIGppZCA9ICR0YXJnZXQuYXR0cignZGF0YS1yZWNpcGllbnQnKSwKICAgICAgICAgICAgICAgICAgICBuYW1lID0gJHRhcmdldC50ZXh0KCk7CiAgICAgICAgICAgICAgICB0aGlzLmFkZENvbnRhY3QoamlkLCBuYW1lKTsKICAgICAgICAgICAgICAgICR0YXJnZXQucGFyZW50KCkucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAkKCcuc2VhcmNoLXhtcHAnKS5oaWRlKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBhZGRDb250YWN0OiBmdW5jdGlvbiAoamlkLCBuYW1lKSB7CiAgICAgICAgICAgICAgICBuYW1lID0gXy5pc0VtcHR5KG5hbWUpPyBqaWQ6IG5hbWU7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLnJvc3Rlci5hZGQoamlkLCBuYW1lLCBbXSwgZnVuY3Rpb24gKGlxKSB7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5yb3N0ZXIuc3Vic2NyaWJlKGppZCwgbnVsbCwgY29udmVyc2UueG1wcHN0YXR1cy5nZXQoJ2Z1bGxuYW1lJykpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5Sb29tc1BhbmVsID0gQmFja2JvbmUuVmlldy5leHRlbmQoewogICAgICAgICAgICB0YWdOYW1lOiAnZGl2JywKICAgICAgICAgICAgaWQ6ICdjaGF0cm9vbXMnLAogICAgICAgICAgICBldmVudHM6IHsKICAgICAgICAgICAgICAgICdzdWJtaXQgZm9ybS5hZGQtY2hhdHJvb20nOiAnY3JlYXRlQ2hhdFJvb20nLAogICAgICAgICAgICAgICAgJ2NsaWNrIGlucHV0I3Nob3ctcm9vbXMnOiAnc2hvd1Jvb21zJywKICAgICAgICAgICAgICAgICdjbGljayBhLm9wZW4tcm9vbSc6ICdjcmVhdGVDaGF0Um9vbScsCiAgICAgICAgICAgICAgICAnY2xpY2sgYS5yb29tLWluZm8nOiAnc2hvd1Jvb21JbmZvJwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKGNmZykgewogICAgICAgICAgICAgICAgY2ZnLiRwYXJlbnQuYXBwZW5kKAogICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLmh0bWwoCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLnRlbXBsYXRlcy5yb29tX3BhbmVsKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzZXJ2ZXJfaW5wdXRfdHlwZSc6IGNvbnZlcnNlLmhpZGVfbXVjX3NlcnZlciAmJiAnaGlkZGVuJyB8fCAndGV4dCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbGFiZWxfcm9vbV9uYW1lJzogX18oJ1Jvb20gbmFtZScpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xhYmVsX25pY2tuYW1lJzogX18oJ05pY2tuYW1lJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbGFiZWxfc2VydmVyJzogX18oJ1NlcnZlcicpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xhYmVsX2pvaW4nOiBfXygnSm9pbicpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xhYmVsX3Nob3dfcm9vbXMnOiBfXygnU2hvdyByb29tcycpCiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgKS5oaWRlKCkpOwogICAgICAgICAgICAgICAgdGhpcy4kdGFicyA9IGNmZy4kcGFyZW50LnBhcmVudCgpLmZpbmQoJyNjb250cm9sYm94LXRhYnMnKTsKCiAgICAgICAgICAgICAgICB0aGlzLm9uKCd1cGRhdGUtcm9vbXMtbGlzdCcsIGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlUm9vbXNMaXN0KCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLnhtcHBzdGF0dXMub24oImNoYW5nZSIsICQucHJveHkoZnVuY3Rpb24gKG1vZGVsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCEoXy5oYXMobW9kZWwuY2hhbmdlZCwgJ2Z1bGxuYW1lJykpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFyICRuaWNrID0gdGhpcy4kZWwuZmluZCgnaW5wdXQubmV3LWNoYXRyb29tLW5pY2snKTsKICAgICAgICAgICAgICAgICAgICBpZiAoISAkbmljay5pcygnOmZvY3VzJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJG5pY2sudmFsKG1vZGVsLmdldCgnZnVsbG5hbWUnKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLiR0YWJzLmFwcGVuZChjb252ZXJzZS50ZW1wbGF0ZXMuY2hhdHJvb21zX3RhYih7bGFiZWxfcm9vbXM6IF9fKCdSb29tcycpfSkpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpbmZvcm1Ob1Jvb21zRm91bmQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciAkYXZhaWxhYmxlX2NoYXRyb29tcyA9IHRoaXMuJGVsLmZpbmQoJyNhdmFpbGFibGUtY2hhdHJvb21zJyk7CiAgICAgICAgICAgICAgICAvLyAjIEZvciB0cmFuc2xhdG9yczogJTEkcyBpcyBhIHZhcmlhYmxlIGFuZCB3aWxsIGJlIHJlcGxhY2VkIHdpdGggdGhlIFhNUFAgc2VydmVyIG5hbWUKICAgICAgICAgICAgICAgICRhdmFpbGFibGVfY2hhdHJvb21zLmh0bWwoJzxkdD4nK19fKCdObyByb29tcyBvbiAlMSRzJyx0aGlzLm11Y19kb21haW4pKyc8L2R0PicpOwogICAgICAgICAgICAgICAgJCgnaW5wdXQjc2hvdy1yb29tcycpLnNob3coKS5zaWJsaW5ncygnc3Bhbi5zcGlubmVyJykucmVtb3ZlKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB1cGRhdGVSb29tc0xpc3Q6IGZ1bmN0aW9uIChkb21haW4pIHsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24ubXVjLmxpc3RSb29tcygKICAgICAgICAgICAgICAgICAgICB0aGlzLm11Y19kb21haW4sCiAgICAgICAgICAgICAgICAgICAgJC5wcm94eShmdW5jdGlvbiAoaXEpIHsgLy8gU3VjY2VzcwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZSwgamlkLCBpLCBmcmFnbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGF2YWlsYWJsZV9jaGF0cm9vbXMgPSB0aGlzLiRlbC5maW5kKCcjYXZhaWxhYmxlLWNoYXRyb29tcycpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJvb21zID0gJChpcSkuZmluZCgncXVlcnknKS5maW5kKCdpdGVtJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJvb21zLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gIyBGb3IgdHJhbnNsYXRvcnM6ICUxJHMgaXMgYSB2YXJpYWJsZSBhbmQgd2lsbCBiZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gIyByZXBsYWNlZCB3aXRoIHRoZSBYTVBQIHNlcnZlciBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYXZhaWxhYmxlX2NoYXRyb29tcy5odG1sKCc8ZHQ+JytfXygnUm9vbXMgb24gJTEkcycsdGhpcy5tdWNfZG9tYWluKSsnPC9kdD4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpPTA7IGk8dGhpcy5yb29tcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSBTdHJvcGhlLnVuZXNjYXBlTm9kZSgkKHRoaXMucm9vbXNbaV0pLmF0dHIoJ25hbWUnKXx8JCh0aGlzLnJvb21zW2ldKS5hdHRyKCdqaWQnKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgamlkID0gJCh0aGlzLnJvb21zW2ldKS5hdHRyKCdqaWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcmFnbWVudC5hcHBlbmRDaGlsZCgkKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS50ZW1wbGF0ZXMucm9vbV9pdGVtKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICduYW1lJzpuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2ppZCc6amlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ29wZW5fdGl0bGUnOiBfXygnQ2xpY2sgdG8gb3BlbiB0aGlzIHJvb20nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdpbmZvX3RpdGxlJzogX18oJ1Nob3cgbW9yZSBpbmZvcm1hdGlvbiBvbiB0aGlzIHJvb20nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKVswXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYXZhaWxhYmxlX2NoYXRyb29tcy5hcHBlbmQoZnJhZ21lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnaW5wdXQjc2hvdy1yb29tcycpLnNob3coKS5zaWJsaW5ncygnc3Bhbi5zcGlubmVyJykucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmluZm9ybU5vUm9vbXNGb3VuZCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0sIHRoaXMpLAogICAgICAgICAgICAgICAgICAgICQucHJveHkoZnVuY3Rpb24gKGlxKSB7IC8vIEZhaWx1cmUKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbmZvcm1Ob1Jvb21zRm91bmQoKTsKICAgICAgICAgICAgICAgICAgICB9LCB0aGlzKSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzaG93Um9vbXM6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgdmFyICRhdmFpbGFibGVfY2hhdHJvb21zID0gdGhpcy4kZWwuZmluZCgnI2F2YWlsYWJsZS1jaGF0cm9vbXMnKTsKICAgICAgICAgICAgICAgIHZhciAkc2VydmVyID0gdGhpcy4kZWwuZmluZCgnaW5wdXQubmV3LWNoYXRyb29tLXNlcnZlcicpOwogICAgICAgICAgICAgICAgdmFyIHNlcnZlciA9ICRzZXJ2ZXIudmFsKCk7CiAgICAgICAgICAgICAgICBpZiAoIXNlcnZlcikgewogICAgICAgICAgICAgICAgICAgICRzZXJ2ZXIuYWRkQ2xhc3MoJ2Vycm9yJyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgnaW5wdXQubmV3LWNoYXRyb29tLW5hbWUnKS5yZW1vdmVDbGFzcygnZXJyb3InKTsKICAgICAgICAgICAgICAgICRzZXJ2ZXIucmVtb3ZlQ2xhc3MoJ2Vycm9yJyk7CiAgICAgICAgICAgICAgICAkYXZhaWxhYmxlX2NoYXRyb29tcy5lbXB0eSgpOwogICAgICAgICAgICAgICAgJCgnaW5wdXQjc2hvdy1yb29tcycpLmhpZGUoKS5hZnRlcignPHNwYW4gY2xhc3M9InNwaW5uZXIiLz4nKTsKICAgICAgICAgICAgICAgIHRoaXMubXVjX2RvbWFpbiA9IHNlcnZlcjsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlUm9vbXNMaXN0KCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzaG93Um9vbUluZm86IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IGV2LnRhcmdldCwKICAgICAgICAgICAgICAgICAgICAkZGQgPSAkKHRhcmdldCkucGFyZW50KCdkZCcpLAogICAgICAgICAgICAgICAgICAgICRkaXYgPSAkZGQuZmluZCgnZGl2LnJvb20taW5mbycpOwogICAgICAgICAgICAgICAgaWYgKCRkaXYubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgJGRpdi5yZW1vdmUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJGRkLmZpbmQoJ3NwYW4uc3Bpbm5lcicpLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgICRkZC5hcHBlbmQoJzxzcGFuIGNsYXNzPSJzcGlubmVyIGhvcl9jZW50ZXJlZCIvPicpOwogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24uZGlzY28uaW5mbygKICAgICAgICAgICAgICAgICAgICAgICAgJCh0YXJnZXQpLmF0dHIoJ2RhdGEtcm9vbS1qaWQnKSwKICAgICAgICAgICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgJC5wcm94eShmdW5jdGlvbiAoc3RhbnphKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgJHN0YW56YSA9ICQoc3RhbnphKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFsbCBNVUMgZmVhdHVyZXMgZm91bmQgaGVyZTogaHR0cDovL3htcHAub3JnL3JlZ2lzdHJhci9kaXNjby1mZWF0dXJlcy5odG1sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZGQuZmluZCgnc3Bhbi5zcGlubmVyJykucmVwbGFjZVdpdGgoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UudGVtcGxhdGVzLnJvb21fZGVzY3JpcHRpb24oewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGVzYyc6ICRzdGFuemEuZmluZCgnZmllbGRbdmFyPSJtdWMjcm9vbWluZm9fZGVzY3JpcHRpb24iXSB2YWx1ZScpLnRleHQoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ29jYyc6ICRzdGFuemEuZmluZCgnZmllbGRbdmFyPSJtdWMjcm9vbWluZm9fb2NjdXBhbnRzIl0gdmFsdWUnKS50ZXh0KCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdoaWRkZW4nOiAkc3RhbnphLmZpbmQoJ2ZlYXR1cmVbdmFyPSJtdWNfaGlkZGVuIl0nKS5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdtZW1iZXJzb25seSc6ICRzdGFuemEuZmluZCgnZmVhdHVyZVt2YXI9Im11Y19tZW1iZXJzb25seSJdJykubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbW9kZXJhdGVkJzogJHN0YW56YS5maW5kKCdmZWF0dXJlW3Zhcj0ibXVjX21vZGVyYXRlZCJdJykubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbm9uYW5vbnltb3VzJzogJHN0YW56YS5maW5kKCdmZWF0dXJlW3Zhcj0ibXVjX25vbmFub255bW91cyJdJykubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb3Blbic6ICRzdGFuemEuZmluZCgnZmVhdHVyZVt2YXI9Im11Y19vcGVuIl0nKS5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdwYXNzd29yZHByb3RlY3RlZCc6ICRzdGFuemEuZmluZCgnZmVhdHVyZVt2YXI9Im11Y19wYXNzd29yZHByb3RlY3RlZCJdJykubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAncGVyc2lzdGVudCc6ICRzdGFuemEuZmluZCgnZmVhdHVyZVt2YXI9Im11Y19wZXJzaXN0ZW50Il0nKS5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdwdWJsaWNyb29tJzogJHN0YW56YS5maW5kKCdmZWF0dXJlW3Zhcj0ibXVjX3B1YmxpYyJdJykubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc2VtaWFub255bW91cyc6ICRzdGFuemEuZmluZCgnZmVhdHVyZVt2YXI9Im11Y19zZW1pYW5vbnltb3VzIl0nKS5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd0ZW1wb3JhcnknOiAkc3RhbnphLmZpbmQoJ2ZlYXR1cmVbdmFyPSJtdWNfdGVtcG9yYXJ5Il0nKS5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd1bm1vZGVyYXRlZCc6ICRzdGFuemEuZmluZCgnZmVhdHVyZVt2YXI9Im11Y191bm1vZGVyYXRlZCJdJykubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbGFiZWxfZGVzYyc6IF9fKCdEZXNjcmlwdGlvbjonKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xhYmVsX29jYyc6IF9fKCdPY2N1cGFudHM6JyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdsYWJlbF9mZWF0dXJlcyc6IF9fKCdGZWF0dXJlczonKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xhYmVsX3JlcXVpcmVzX2F1dGgnOiBfXygnUmVxdWlyZXMgYXV0aGVudGljYXRpb24nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xhYmVsX2hpZGRlbic6IF9fKCdIaWRkZW4nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xhYmVsX3JlcXVpcmVzX2ludml0ZSc6IF9fKCdSZXF1aXJlcyBhbiBpbnZpdGF0aW9uJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdsYWJlbF9tb2RlcmF0ZWQnOiBfXygnTW9kZXJhdGVkJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdsYWJlbF9ub25fYW5vbic6IF9fKCdOb24tYW5vbnltb3VzJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdsYWJlbF9vcGVuX3Jvb20nOiBfXygnT3BlbiByb29tJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdsYWJlbF9wZXJtYW5lbnRfcm9vbSc6IF9fKCdQZXJtYW5lbnQgcm9vbScpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbGFiZWxfcHVibGljJzogX18oJ1B1YmxpYycpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbGFiZWxfc2VtaV9hbm9uJzogIF8oJ1NlbWktYW5vbnltb3VzJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdsYWJlbF90ZW1wX3Jvb20nOiAgXygnVGVtcG9yYXJ5IHJvb20nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xhYmVsX3VubW9kZXJhdGVkJzogX18oJ1VubW9kZXJhdGVkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIHRoaXMpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGNyZWF0ZUNoYXRSb29tOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICB2YXIgbmFtZSwgJG5hbWUsCiAgICAgICAgICAgICAgICAgICAgc2VydmVyLCAkc2VydmVyLAogICAgICAgICAgICAgICAgICAgIGppZCwKICAgICAgICAgICAgICAgICAgICAkbmljayA9IHRoaXMuJGVsLmZpbmQoJ2lucHV0Lm5ldy1jaGF0cm9vbS1uaWNrJyksCiAgICAgICAgICAgICAgICAgICAgbmljayA9ICRuaWNrLnZhbCgpLAogICAgICAgICAgICAgICAgICAgIGNoYXRyb29tOwoKICAgICAgICAgICAgICAgIGlmICghbmljaykgeyAkbmljay5hZGRDbGFzcygnZXJyb3InKTsgfQogICAgICAgICAgICAgICAgZWxzZSB7ICRuaWNrLnJlbW92ZUNsYXNzKCdlcnJvcicpOyB9CgogICAgICAgICAgICAgICAgaWYgKGV2LnR5cGUgPT09ICdjbGljaycpIHsKICAgICAgICAgICAgICAgICAgICBqaWQgPSAkKGV2LnRhcmdldCkuYXR0cignZGF0YS1yb29tLWppZCcpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkbmFtZSA9IHRoaXMuJGVsLmZpbmQoJ2lucHV0Lm5ldy1jaGF0cm9vbS1uYW1lJyk7CiAgICAgICAgICAgICAgICAgICAgJHNlcnZlcj0gdGhpcy4kZWwuZmluZCgnaW5wdXQubmV3LWNoYXRyb29tLXNlcnZlcicpOwogICAgICAgICAgICAgICAgICAgIHNlcnZlciA9ICRzZXJ2ZXIudmFsKCk7CiAgICAgICAgICAgICAgICAgICAgbmFtZSA9ICRuYW1lLnZhbCgpLnRyaW0oKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgICRuYW1lLnZhbCgnJyk7IC8vIENsZWFyIHRoZSBpbnB1dAogICAgICAgICAgICAgICAgICAgIGlmIChuYW1lICYmIHNlcnZlcikgewogICAgICAgICAgICAgICAgICAgICAgICBqaWQgPSBTdHJvcGhlLmVzY2FwZU5vZGUobmFtZSkgKyAnQCcgKyBzZXJ2ZXI7CiAgICAgICAgICAgICAgICAgICAgICAgICRuYW1lLnJlbW92ZUNsYXNzKCdlcnJvcicpOwogICAgICAgICAgICAgICAgICAgICAgICAkc2VydmVyLnJlbW92ZUNsYXNzKCdlcnJvcicpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm11Y19kb21haW4gPSBzZXJ2ZXI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFuYW1lKSB7ICRuYW1lLmFkZENsYXNzKCdlcnJvcicpOyB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2VydmVyKSB7ICRzZXJ2ZXIuYWRkQ2xhc3MoJ2Vycm9yJyk7IH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghbmljaykgeyByZXR1cm47IH0KICAgICAgICAgICAgICAgIGNoYXRyb29tID0gY29udmVyc2UuY2hhdGJveHZpZXdzLnNob3dDaGF0KHsKICAgICAgICAgICAgICAgICAgICAnaWQnOiBqaWQsCiAgICAgICAgICAgICAgICAgICAgJ2ppZCc6IGppZCwKICAgICAgICAgICAgICAgICAgICAnbmFtZSc6IFN0cm9waGUudW5lc2NhcGVOb2RlKFN0cm9waGUuZ2V0Tm9kZUZyb21KaWQoamlkKSksCiAgICAgICAgICAgICAgICAgICAgJ25pY2snOiBuaWNrLAogICAgICAgICAgICAgICAgICAgICdjaGF0cm9vbSc6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgJ2JveF9pZCcgOiBiNjRfc2hhMShqaWQpCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLkNvbnRyb2xCb3hWaWV3ID0gY29udmVyc2UuQ2hhdEJveFZpZXcuZXh0ZW5kKHsKICAgICAgICAgICAgdGFnTmFtZTogJ2RpdicsCiAgICAgICAgICAgIGNsYXNzTmFtZTogJ2NoYXRib3gnLAogICAgICAgICAgICBpZDogJ2NvbnRyb2xib3gnLAogICAgICAgICAgICBldmVudHM6IHsKICAgICAgICAgICAgICAgICdjbGljayBhLmNsb3NlLWNoYXRib3gtYnV0dG9uJzogJ2Nsb3NlJywKICAgICAgICAgICAgICAgICdjbGljayB1bCNjb250cm9sYm94LXRhYnMgbGkgYSc6ICdzd2l0Y2hUYWInLAogICAgICAgICAgICAgICAgJ21vdXNlZG93biAuZHJhZ3Jlc2l6ZS10bSc6ICdvbkRyYWdSZXNpemVTdGFydCcKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmluc2VydEFmdGVyKGNvbnZlcnNlLmNvbnRyb2xib3h0b2dnbGUuJGVsKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oJ2NoYW5nZTpjb25uZWN0ZWQnLCB0aGlzLm9uQ29ubmVjdGVkLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oJ2Rlc3Ryb3knLCB0aGlzLmhpZGUsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbignaGlkZScsIHRoaXMuaGlkZSwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCdzaG93JywgdGhpcy5zaG93LCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oJ2NoYW5nZTpjbG9zZWQnLCB0aGlzLmVuc3VyZUNsb3NlZFN0YXRlLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyKCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5tb2RlbC5nZXQoJ2Nvbm5lY3RlZCcpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbml0Um9zdGVyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMubW9kZWwuZ2V0KCdjbG9zZWQnKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvdygpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG9uQ29ubmVjdGVkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5tb2RlbC5nZXQoJ2Nvbm5lY3RlZCcpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIoKS5pbml0Um9zdGVyKCk7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuZmVhdHVyZXMub2ZmKCdhZGQnLCB0aGlzLmZlYXR1cmVBZGRlZCwgdGhpcyk7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuZmVhdHVyZXMub24oJ2FkZCcsIHRoaXMuZmVhdHVyZUFkZGVkLCB0aGlzKTsKICAgICAgICAgICAgICAgICAgICAvLyBGZWF0dXJlcyBjb3VsZCBoYXZlIGJlZW4gYWRkZWQgYmVmb3JlIHRoZSBjb250cm9sYm94IHdhcwogICAgICAgICAgICAgICAgICAgIC8vIGluaXRpYWxpemVkLiBDdXJyZW50bHkgd2UncmUgb25seSBpbnRlcmVzdGVkIGluIE1VQwogICAgICAgICAgICAgICAgICAgIHZhciBmZWF0dXJlID0gY29udmVyc2UuZmVhdHVyZXMuZmluZFdoZXJlKHsndmFyJzogJ2h0dHA6Ly9qYWJiZXIub3JnL3Byb3RvY29sL211Yyd9KTsKICAgICAgICAgICAgICAgICAgICBpZiAoZmVhdHVyZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZlYXR1cmVBZGRlZChmZWF0dXJlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpbml0Um9zdGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAvKiBXZSBpbml0aWFsaXplIHRoZSByb3N0ZXIsIHdoaWNoIHdpbGwgYXBwZWFyIGluc2lkZSB0aGUKICAgICAgICAgICAgICAgICAqIENvbnRhY3RzIFBhbmVsLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBjb252ZXJzZS5yb3N0ZXIgPSBuZXcgY29udmVyc2UuUm9zdGVyQ29udGFjdHMoKTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJvc3Rlci5icm93c2VyU3RvcmFnZSA9IG5ldyBCYWNrYm9uZS5Ccm93c2VyU3RvcmFnZVtjb252ZXJzZS5zdG9yYWdlXSgKICAgICAgICAgICAgICAgICAgICBiNjRfc2hhMSgnY29udmVyc2UuY29udGFjdHMtJytjb252ZXJzZS5iYXJlX2ppZCkpOwogICAgICAgICAgICAgICAgdmFyIHJvc3Rlcmdyb3VwcyA9IG5ldyBjb252ZXJzZS5Sb3N0ZXJHcm91cHMoKTsKICAgICAgICAgICAgICAgIHJvc3Rlcmdyb3Vwcy5icm93c2VyU3RvcmFnZSA9IG5ldyBCYWNrYm9uZS5Ccm93c2VyU3RvcmFnZVtjb252ZXJzZS5zdG9yYWdlXSgKICAgICAgICAgICAgICAgICAgICBiNjRfc2hhMSgnY29udmVyc2Uucm9zdGVyLmdyb3VwcycrY29udmVyc2UuYmFyZV9qaWQpKTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJvc3RlcnZpZXcgPSBuZXcgY29udmVyc2UuUm9zdGVyVmlldyh7bW9kZWw6IHJvc3Rlcmdyb3Vwc30pOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWN0c3BhbmVsLiRlbC5hcHBlbmQoY29udmVyc2Uucm9zdGVydmlldy4kZWwpOwogICAgICAgICAgICAgICAgLy8gVE9ETzoKICAgICAgICAgICAgICAgIC8vIFNlZSBpZiB3ZSBzaG91bGRuJ3QgYWxzbyBmZXRjaCB0aGUgcm9zdGVyIGhlcmUuLi4gb3RoZXJ3aXNlCiAgICAgICAgICAgICAgICAvLyB0aGUgcm9zdGVyIGlzIGFsd2F5cyBwb3B1bGF0ZWQgYnkgdGhlIHJvc3RlckhhbmRsZXIgbWV0aG9kLAogICAgICAgICAgICAgICAgLy8gd2hpY2ggYXBwZWFycyB0byBiZSBhIGxlc3MgZWNvbm9taWMgd2F5LgogICAgICAgICAgICAgICAgLy8gaS5lLiBmcm9tIHdoYXQgaXQgc2VlbXMsIG9ubHkgZ3JvdXBzIGFyZSBmZXRjaGVkIGZyb20KICAgICAgICAgICAgICAgIC8vIGJyb3dzZXJTdG9yYWdlLCBhbmQgbm8gY29udGFjdHMuCiAgICAgICAgICAgICAgICAvLyBYWFg6IE1ha2Ugc3VyZSB0aGF0IGlmIGZldGNoIGlzIGNhbGxlZCwgd2UgZG9uJ3Qgc29ydCBvbgogICAgICAgICAgICAgICAgLy8gZWFjaCBpdGVtIGFkZC4uLgogICAgICAgICAgICAgICAgLy8gY29udmVyc2Uucm9zdGVyLmZldGNoKCkKICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJvc3RlcnZpZXcucmVuZGVyKCkuZmV0Y2goKS51cGRhdGUoKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAoIWNvbnZlcnNlLmNvbm5lY3Rpb24uY29ubmVjdGVkIHx8ICFjb252ZXJzZS5jb25uZWN0aW9uLmF1dGhlbnRpY2F0ZWQgfHwgY29udmVyc2UuY29ubmVjdGlvbi5kaXNjb25uZWN0aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogd2UgbWlnaHQgbmVlZCB0byB0YWtlIHByZWJpbmRpbmcgaW50byBjb25zaWRlcmF0aW9uIGhlcmUuCiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJMb2dpblBhbmVsKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLmNvbnRhY3RzcGFuZWwgfHwgIXRoaXMuY29udGFjdHNwYW5lbC4kZWwuaXMoJzp2aXNpYmxlJykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlckNvbnRhY3RzUGFuZWwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVuZGVyTG9naW5QYW5lbDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy4kZWwuaHRtbChjb252ZXJzZS50ZW1wbGF0ZXMuY29udHJvbGJveCh0aGlzLm1vZGVsLnRvSlNPTigpKSk7CiAgICAgICAgICAgICAgICB2YXIgY2ZnID0geyckcGFyZW50JzogdGhpcy4kZWwuZmluZCgnLmNvbnRyb2xib3gtcGFuZXMnKSwgJ21vZGVsJzogdGhpc307CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMubG9naW5wYW5lbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMubG9naW5wYW5lbCA9IG5ldyBjb252ZXJzZS5Mb2dpblBhbmVsKGNmZyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMubG9naW5wYW5lbC5kZWxlZ2F0ZUV2ZW50cygpLmluaXRpYWxpemUoY2ZnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMubG9naW5wYW5lbC5yZW5kZXIoKTsKICAgICAgICAgICAgICAgIHRoaXMuaW5pdERyYWdSZXNpemUoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlbmRlckNvbnRhY3RzUGFuZWw6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmh0bWwoY29udmVyc2UudGVtcGxhdGVzLmNvbnRyb2xib3godGhpcy5tb2RlbC50b0pTT04oKSkpOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWN0c3BhbmVsID0gbmV3IGNvbnZlcnNlLkNvbnRhY3RzUGFuZWwoeyckcGFyZW50JzogdGhpcy4kZWwuZmluZCgnLmNvbnRyb2xib3gtcGFuZXMnKX0pOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWN0c3BhbmVsLnJlbmRlcigpOwogICAgICAgICAgICAgICAgY29udmVyc2UueG1wcHN0YXR1c3ZpZXcgPSBuZXcgY29udmVyc2UuWE1QUFN0YXR1c1ZpZXcoeydtb2RlbCc6IGNvbnZlcnNlLnhtcHBzdGF0dXN9KTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLnhtcHBzdGF0dXN2aWV3LnJlbmRlcigpOwogICAgICAgICAgICAgICAgaWYgKGNvbnZlcnNlLmFsbG93X211YykgewogICAgICAgICAgICAgICAgICAgIHRoaXMucm9vbXNwYW5lbCA9IG5ldyBjb252ZXJzZS5Sb29tc1BhbmVsKHsnJHBhcmVudCc6IHRoaXMuJGVsLmZpbmQoJy5jb250cm9sYm94LXBhbmVzJyl9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJvb21zcGFuZWwucmVuZGVyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmluaXREcmFnUmVzaXplKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBjbG9zZTogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBpZiAoZXYgJiYgZXYucHJldmVudERlZmF1bHQpIHsgZXYucHJldmVudERlZmF1bHQoKTsgfQogICAgICAgICAgICAgICAgaWYgKGNvbnZlcnNlLmNvbm5lY3Rpb24uY29ubmVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5zYXZlKHsnY2xvc2VkJzogdHJ1ZX0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLnRyaWdnZXIoJ2hpZGUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnZlcnNlLmVtaXQoJ2NvbnRyb2xCb3hDbG9zZWQnLCB0aGlzKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgZW5zdXJlQ2xvc2VkU3RhdGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1vZGVsLmdldCgnY2xvc2VkJykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZGUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBoaWRlOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmhpZGUoJ2Zhc3QnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UucmVmcmVzaFdlYmtpdCgpOwogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmVtaXQoJ2NoYXRCb3hDbG9zZWQnLCB0aGlzKTsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb250cm9sYm94dG9nZ2xlLnNob3coZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2hvdzogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgY29udmVyc2UuY29udHJvbGJveHRvZ2dsZS5oaWRlKCQucHJveHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLnNob3coJ2Zhc3QnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb252ZXJzZS5yb3N0ZXJ2aWV3KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5yb3N0ZXJ2aWV3LnVwZGF0ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJlZnJlc2hXZWJraXQoKTsKICAgICAgICAgICAgICAgICAgICB9LmJpbmQodGhpcykpOwogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmVtaXQoJ2NvbnRyb2xCb3hPcGVuZWQnLCB0aGlzKTsKICAgICAgICAgICAgICAgIH0sIHRoaXMpKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgZmVhdHVyZUFkZGVkOiBmdW5jdGlvbiAoZmVhdHVyZSkgewogICAgICAgICAgICAgICAgaWYgKChmZWF0dXJlLmdldCgndmFyJykgPT0gJ2h0dHA6Ly9qYWJiZXIub3JnL3Byb3RvY29sL211YycpICYmIChjb252ZXJzZS5hbGxvd19tdWMpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yb29tc3BhbmVsLm11Y19kb21haW4gPSBmZWF0dXJlLmdldCgnZnJvbScpOwogICAgICAgICAgICAgICAgICAgIHZhciAkc2VydmVyPSB0aGlzLiRlbC5maW5kKCdpbnB1dC5uZXctY2hhdHJvb20tc2VydmVyJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCEgJHNlcnZlci5pcygnOmZvY3VzJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHNlcnZlci52YWwodGhpcy5yb29tc3BhbmVsLm11Y19kb21haW4pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoY29udmVyc2UuYXV0b19saXN0X3Jvb21zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucm9vbXNwYW5lbC50cmlnZ2VyKCd1cGRhdGUtcm9vbXMtbGlzdCcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHN3aXRjaFRhYjogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgdmFyICR0YWIgPSAkKGV2LnRhcmdldCksCiAgICAgICAgICAgICAgICAgICAgJHNpYmxpbmcgPSAkdGFiLnBhcmVudCgpLnNpYmxpbmdzKCdsaScpLmNoaWxkcmVuKCdhJyksCiAgICAgICAgICAgICAgICAgICAgJHRhYl9wYW5lbCA9ICQoJHRhYi5hdHRyKCdocmVmJykpOwogICAgICAgICAgICAgICAgJCgkc2libGluZy5hdHRyKCdocmVmJykpLmhpZGUoKTsKICAgICAgICAgICAgICAgICRzaWJsaW5nLnJlbW92ZUNsYXNzKCdjdXJyZW50Jyk7CiAgICAgICAgICAgICAgICAkdGFiLmFkZENsYXNzKCdjdXJyZW50Jyk7CiAgICAgICAgICAgICAgICAkdGFiX3BhbmVsLnNob3coKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHNob3dIZWxwTWVzc2FnZXM6IGZ1bmN0aW9uIChtc2dzKSB7CiAgICAgICAgICAgICAgICAvLyBPdmVycmlkZSBzaG93SGVscE1lc3NhZ2VzIGluIENoYXRCb3hWaWV3LCBmb3Igbm93IGRvIG5vdGhpbmcuCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5DaGF0Um9vbU9jY3VwYW50ID0gQmFja2JvbmUuTW9kZWw7CiAgICAgICAgdGhpcy5DaGF0Um9vbU9jY3VwYW50VmlldyA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKICAgICAgICAgICAgdGFnTmFtZTogJ2xpJywKICAgICAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbignY2hhbmdlJywgdGhpcy5yZW5kZXIsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbignZGVzdHJveScsIHRoaXMuZGVzdHJveSwgdGhpcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyICRuZXcgPSBjb252ZXJzZS50ZW1wbGF0ZXMub2NjdXBhbnQoCiAgICAgICAgICAgICAgICAgICAgXy5leHRlbmQoCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwudG9KU09OKCksIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkZXNjX21vZGVyYXRvcic6IF9fKCdUaGlzIHVzZXIgaXMgYSBtb2RlcmF0b3InKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkZXNjX3BhcnRpY2lwYW50JzogX18oJ1RoaXMgdXNlciBjYW4gc2VuZCBtZXNzYWdlcyBpbiB0aGlzIHJvb20nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkZXNjX3Zpc2l0b3InOiBfXygnVGhpcyB1c2VyIGNhbiBOT1Qgc2VuZCBtZXNzYWdlcyBpbiB0aGlzIHJvb20nKQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgdGhpcy4kZWwucmVwbGFjZVdpdGgoJG5ldyk7CiAgICAgICAgICAgICAgICB0aGlzLnNldEVsZW1lbnQoJG5ldywgdHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLnJlbW92ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuQ2hhdFJvb21PY2N1cGFudHMgPSBCYWNrYm9uZS5Db2xsZWN0aW9uLmV4dGVuZCh7CiAgICAgICAgICAgIG1vZGVsOiBjb252ZXJzZS5DaGF0Um9vbU9jY3VwYW50LAogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAgICAgICAgICAgdGhpcy5icm93c2VyU3RvcmFnZSA9IG5ldyBCYWNrYm9uZS5Ccm93c2VyU3RvcmFnZVtjb252ZXJzZS5zdG9yYWdlXSgKICAgICAgICAgICAgICAgICAgICBiNjRfc2hhMSgnY29udmVyc2Uub2NjdXBhbnRzJytjb252ZXJzZS5iYXJlX2ppZCtvcHRpb25zLm5pY2spKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLkNoYXRSb29tT2NjdXBhbnRzVmlldyA9IEJhY2tib25lLk92ZXJ2aWV3LmV4dGVuZCh7CiAgICAgICAgICAgIHRhZ05hbWU6ICdkaXYnLAogICAgICAgICAgICBjbGFzc05hbWU6ICdwYXJ0aWNpcGFudHMnLAoKICAgICAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbigiYWRkIiwgdGhpcy5vbk9jY3VwYW50QWRkZWQsIHRoaXMpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5odG1sKAogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLnRlbXBsYXRlcy5jaGF0cm9vbV9zaWRlYmFyKHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2xhYmVsX2ludml0YXRpb24nOiBfXygnSW52aXRlLi4uJyksCiAgICAgICAgICAgICAgICAgICAgICAgICdsYWJlbF9vY2N1cGFudHMnOiBfXygnT2NjdXBhbnRzJykKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmluaXRJbnZpdGVXaWRnZXQoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG9uT2NjdXBhbnRBZGRlZDogZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICAgICAgICAgIHZhciB2aWV3ID0gdGhpcy5nZXQoaXRlbS5nZXQoJ2lkJykpOwogICAgICAgICAgICAgICAgaWYgKCF2aWV3KSB7CiAgICAgICAgICAgICAgICAgICAgdmlldyA9IHRoaXMuYWRkKGl0ZW0uZ2V0KCdpZCcpLCBuZXcgY29udmVyc2UuQ2hhdFJvb21PY2N1cGFudFZpZXcoe21vZGVsOiBpdGVtfSkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgdmlldy5tb2RlbDsgLy8gUmVtb3ZlIHJlZiB0byBvbGQgbW9kZWwgdG8gaGVscCBnYXJiYWdlIGNvbGxlY3Rpb24KICAgICAgICAgICAgICAgICAgICB2aWV3Lm1vZGVsID0gaXRlbTsKICAgICAgICAgICAgICAgICAgICB2aWV3LmluaXRpYWxpemUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuJCgnLnBhcnRpY2lwYW50LWxpc3QnKS5hcHBlbmQodmlldy5yZW5kZXIoKS4kZWwpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25DaGF0Um9vbVJvc3RlcjogZnVuY3Rpb24gKHJvc3Rlciwgcm9vbSkgewogICAgICAgICAgICAgICAgdmFyIHJvc3Rlcl9zaXplID0gXy5zaXplKHJvc3RlciksCiAgICAgICAgICAgICAgICAgICAgJHBhcnRpY2lwYW50X2xpc3QgPSB0aGlzLiQoJy5wYXJ0aWNpcGFudC1saXN0JyksCiAgICAgICAgICAgICAgICAgICAgcGFydGljaXBhbnRzID0gW10sCiAgICAgICAgICAgICAgICAgICAga2V5cyA9IF8ua2V5cyhyb3N0ZXIpLAogICAgICAgICAgICAgICAgICAgIG9jY3VwYW50LCBhdHRycywgaSwgbmljazsKCiAgICAgICAgICAgICAgICBmb3IgKGk9MDsgaTxyb3N0ZXJfc2l6ZTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgbmljayA9IFN0cm9waGUudW5lc2NhcGVOb2RlKGtleXNbaV0pOwogICAgICAgICAgICAgICAgICAgIGF0dHJzID0gewogICAgICAgICAgICAgICAgICAgICAgICAnaWQnOiBuaWNrLAogICAgICAgICAgICAgICAgICAgICAgICAncm9sZSc6IHJvc3RlcltrZXlzW2ldXS5yb2xlLAogICAgICAgICAgICAgICAgICAgICAgICAnbmljayc6IG5pY2sKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIG9jY3VwYW50ID0gdGhpcy5tb2RlbC5nZXQobmljayk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9jY3VwYW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9jY3VwYW50LnNhdmUoYXR0cnMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuY3JlYXRlKGF0dHJzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfLmVhY2goXy5kaWZmZXJlbmNlKHRoaXMubW9kZWwucGx1Y2soJ2lkJyksIGtleXMpLCBmdW5jdGlvbiAoaWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLmdldChpZCkuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGluaXRJbnZpdGVXaWRnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciAkZWwgPSB0aGlzLiQoJ2lucHV0Lmludml0ZWQtY29udGFjdCcpOwogICAgICAgICAgICAgICAgJGVsLnR5cGVhaGVhZCh7CiAgICAgICAgICAgICAgICAgICAgbWluTGVuZ3RoOiAxLAogICAgICAgICAgICAgICAgICAgIGhpZ2hsaWdodDogdHJ1ZQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIG5hbWU6ICdjb250YWN0cy1kYXRhc2V0JywKICAgICAgICAgICAgICAgICAgICBzb3VyY2U6IGZ1bmN0aW9uIChxLCBjYikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBfLmVhY2goY29udmVyc2Uucm9zdGVyLmZpbHRlcihjb250YWlucyhbJ2Z1bGxuYW1lJywgJ2ppZCddLCBxKSksIGZ1bmN0aW9uIChuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2goe3ZhbHVlOiBuLmdldCgnZnVsbG5hbWUnKSwgamlkOiBuLmdldCgnamlkJyl9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNiKHJlc3VsdHMpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVzOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN1Z2dlc3Rpb246IF8udGVtcGxhdGUoJzxwIGRhdGEtamlkPSJ7e2ppZH19Ij57e3ZhbHVlfX08L3A+JykKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICRlbC5vbigndHlwZWFoZWFkOnNlbGVjdGVkJywgJC5wcm94eShmdW5jdGlvbiAoZXYsIHN1Z2dlc3Rpb24sIGRuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlYXNvbiA9IHByb21wdCgKICAgICAgICAgICAgICAgICAgICAgICAgX18oX19fKCdZb3UgYXJlIGFib3V0IHRvIGludml0ZSAlMSRzIHRvIHRoZSBjaGF0IHJvb20gIiUyJHMiLiAnKSwgc3VnZ2VzdGlvbi52YWx1ZSwgdGhpcy5tb2RlbC5nZXQoJ2lkJykpICsKICAgICAgICAgICAgICAgICAgICAgICAgX18oIllvdSBtYXkgb3B0aW9uYWxseSBpbmNsdWRlIGEgbWVzc2FnZSwgZXhwbGFpbmluZyB0aGUgcmVhc29uIGZvciB0aGUgaW52aXRhdGlvbi4iKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlYXNvbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLm11Yy5yb29tc1t0aGlzLmNoYXRyb29tdmlldy5tb2RlbC5nZXQoJ2lkJyldLmRpcmVjdEludml0ZShzdWdnZXN0aW9uLmppZCwgcmVhc29uKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuZW1pdCgncm9vbUludml0ZVNlbnQnLCB0aGlzLCBzdWdnZXN0aW9uLmppZCwgcmVhc29uKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgJChldi50YXJnZXQpLnR5cGVhaGVhZCgndmFsJywgJycpOwogICAgICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0KCiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuQ2hhdFJvb21WaWV3ID0gY29udmVyc2UuQ2hhdEJveFZpZXcuZXh0ZW5kKHsKICAgICAgICAgICAgbGVuZ3RoOiAzMDAsCiAgICAgICAgICAgIHRhZ05hbWU6ICdkaXYnLAogICAgICAgICAgICBjbGFzc05hbWU6ICdjaGF0cm9vbScsCiAgICAgICAgICAgIGV2ZW50czogewogICAgICAgICAgICAgICAgJ2NsaWNrIC5jbG9zZS1jaGF0Ym94LWJ1dHRvbic6ICdjbG9zZScsCiAgICAgICAgICAgICAgICAnY2xpY2sgLnRvZ2dsZS1jaGF0Ym94LWJ1dHRvbic6ICdtaW5pbWl6ZScsCiAgICAgICAgICAgICAgICAnY2xpY2sgLmNvbmZpZ3VyZS1jaGF0cm9vbS1idXR0b24nOiAnY29uZmlndXJlQ2hhdFJvb20nLAogICAgICAgICAgICAgICAgJ2NsaWNrIC50b2dnbGUtc21pbGV5JzogJ3RvZ2dsZUVtb3RpY29uTWVudScsCiAgICAgICAgICAgICAgICAnY2xpY2sgLnRvZ2dsZS1zbWlsZXkgdWwgbGknOiAnaW5zZXJ0RW1vdGljb24nLAogICAgICAgICAgICAgICAgJ2NsaWNrIC50b2dnbGUtY2xlYXInOiAnY2xlYXJDaGF0Um9vbU1lc3NhZ2VzJywKICAgICAgICAgICAgICAgICdjbGljayAudG9nZ2xlLXBhcnRpY2lwYW50cyBhJzogJ3RvZ2dsZU9jY3VwYW50cycsCiAgICAgICAgICAgICAgICAna2V5cHJlc3MgdGV4dGFyZWEuY2hhdC10ZXh0YXJlYSc6ICdrZXlQcmVzc2VkJywKICAgICAgICAgICAgICAgICdtb3VzZWRvd24gLmRyYWdyZXNpemUtdG0nOiAnb25EcmFnUmVzaXplU3RhcnQnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlzX2NoYXRyb29tOiB0cnVlLAoKICAgICAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5tZXNzYWdlcy5vbignYWRkJywgdGhpcy5vbk1lc3NhZ2VBZGRlZCwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCdjaGFuZ2U6bWluaW1pemVkJywgZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5nZXQoJ21pbmltaXplZCcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWF4aW1pemUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oJ2Rlc3Ryb3knLCBmdW5jdGlvbiAobW9kZWwsIHJlc3BvbnNlLCBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5tdWMubGVhdmUoCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuZ2V0KCdqaWQnKSwKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5nZXQoJ25pY2snKSwKICAgICAgICAgICAgICAgICAgICAgICAgJC5wcm94eSh0aGlzLm9uTGVhdmUsIHRoaXMpLAogICAgICAgICAgICAgICAgICAgICAgICB1bmRlZmluZWQpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHRoaXMpOwoKICAgICAgICAgICAgICAgIHRoaXMub2NjdXBhbnRzdmlldyA9IG5ldyBjb252ZXJzZS5DaGF0Um9vbU9jY3VwYW50c1ZpZXcoewogICAgICAgICAgICAgICAgICAgIG1vZGVsOiBuZXcgY29udmVyc2UuQ2hhdFJvb21PY2N1cGFudHMoe25pY2s6IHRoaXMubW9kZWwuZ2V0KCduaWNrJyl9KQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLm9jY3VwYW50c3ZpZXcuY2hhdHJvb212aWV3ID0gdGhpczsKICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyKCk7CiAgICAgICAgICAgICAgICB0aGlzLm9jY3VwYW50c3ZpZXcubW9kZWwuZmV0Y2goe2FkZDp0cnVlfSk7CiAgICAgICAgICAgICAgICB0aGlzLmNvbm5lY3QobnVsbCk7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5lbWl0KCdjaGF0Um9vbU9wZW5lZCcsIHRoaXMpOwoKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmluc2VydEFmdGVyKGNvbnZlcnNlLmNoYXRib3h2aWV3cy5nZXQoImNvbnRyb2xib3giKS4kZWwpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5tZXNzYWdlcy5mZXRjaCh7YWRkOiB0cnVlfSk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5tb2RlbC5nZXQoJ21pbmltaXplZCcpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvdygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5hdHRyKCdpZCcsIHRoaXMubW9kZWwuZ2V0KCdib3hfaWQnKSkKICAgICAgICAgICAgICAgICAgICAgICAgLmh0bWwoY29udmVyc2UudGVtcGxhdGVzLmNoYXRyb29tKHRoaXMubW9kZWwudG9KU09OKCkpKTsKICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyQ2hhdEFyZWEoKTsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJlZnJlc2hXZWJraXQoKTsKICAgICAgICAgICAgICAgIH0sIDUwKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVuZGVyQ2hhdEFyZWE6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy4kKCcuY2hhdC1hcmVhJykubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kKCcuY2hhdC1ib2R5JykuZW1wdHkoKQogICAgICAgICAgICAgICAgICAgICAgICAuYXBwZW5kKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UudGVtcGxhdGVzLmNoYXRhcmVhKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc2hvd190b29sYmFyJzogY29udmVyc2Uuc2hvd190b29sYmFyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdsYWJlbF9tZXNzYWdlJzogX18oJ01lc3NhZ2UnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkpCiAgICAgICAgICAgICAgICAgICAgICAgIC5hcHBlbmQodGhpcy5vY2N1cGFudHN2aWV3LnJlbmRlcigpLiRlbCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJUb29sYmFyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBYWFg6IFRoaXMgaXMgYSBiaXQgb2YgYSBoYWNrLCB0byBtYWtlIHN1cmUgdGhhdCB0aGUKICAgICAgICAgICAgICAgIC8vIHNpZGViYXIncyBzdGF0ZSBpcyByZW1lbWJlcmVkLgogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5zZXQoe2hpZGRlbl9vY2N1cGFudHM6ICF0aGlzLm1vZGVsLmdldCgnaGlkZGVuX29jY3VwYW50cycpfSk7CiAgICAgICAgICAgICAgICB0aGlzLnRvZ2dsZU9jY3VwYW50cygpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB0b2dnbGVPY2N1cGFudHM6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgaWYgKGV2KSB7CiAgICAgICAgICAgICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICBldi5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciAkZWwgPSB0aGlzLiQoJy5pY29uLWhpZGUtdXNlcnMnKTsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5tb2RlbC5nZXQoJ2hpZGRlbl9vY2N1cGFudHMnKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuc2F2ZSh7aGlkZGVuX29jY3VwYW50czogdHJ1ZX0pOwogICAgICAgICAgICAgICAgICAgICRlbC5yZW1vdmVDbGFzcygnaWNvbi1oaWRlLXVzZXJzJykuYWRkQ2xhc3MoJ2ljb24tc2hvdy11c2VycycpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuJCgnZm9ybS5zZW5kWE1QUE1lc3NhZ2UsIC5jaGF0LWFyZWEnKS5hbmltYXRlKHt3aWR0aDogJzEwMCUnfSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kKCdkaXYucGFydGljaXBhbnRzJykuYW5pbWF0ZSh7d2lkdGg6IDB9LCAkLnByb3h5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zY3JvbGxEb3duKCk7CiAgICAgICAgICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLnNhdmUoe2hpZGRlbl9vY2N1cGFudHM6IGZhbHNlfSk7CiAgICAgICAgICAgICAgICAgICAgJGVsLnJlbW92ZUNsYXNzKCdpY29uLXNob3ctdXNlcnMnKS5hZGRDbGFzcygnaWNvbi1oaWRlLXVzZXJzJyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kKCcuY2hhdC1hcmVhLCBmb3JtLnNlbmRYTVBQTWVzc2FnZScpLmNzcyh7d2lkdGg6ICcnfSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kKCdkaXYucGFydGljaXBhbnRzJykuc2hvdygpLmFuaW1hdGUoe3dpZHRoOiAnYXV0byd9LCAkLnByb3h5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zY3JvbGxEb3duKCk7CiAgICAgICAgICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25Db21tYW5kRXJyb3I6IGZ1bmN0aW9uIChzdGFuemEpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd1N0YXR1c05vdGlmaWNhdGlvbihfXygiRXJyb3I6IGNvdWxkIG5vdCBleGVjdXRlIHRoZSBjb21tYW5kIiksIHRydWUpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgY3JlYXRlQ2hhdFJvb21NZXNzYWdlOiBmdW5jdGlvbiAodGV4dCkgewogICAgICAgICAgICAgICAgdmFyIGZ1bGxuYW1lID0gY29udmVyc2UueG1wcHN0YXR1cy5nZXQoJ2Z1bGxuYW1lJyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm1lc3NhZ2VzLmNyZWF0ZSh7CiAgICAgICAgICAgICAgICAgICAgZnVsbG5hbWU6IF8uaXNFbXB0eShmdWxsbmFtZSk/IGNvbnZlcnNlLmJhcmVfamlkOiBmdWxsbmFtZSwKICAgICAgICAgICAgICAgICAgICBzZW5kZXI6ICdtZScsCiAgICAgICAgICAgICAgICAgICAgdGltZTogbW9tZW50KCkuZm9ybWF0KCksCiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogdGV4dCwKICAgICAgICAgICAgICAgICAgICBtc2dpZDogY29udmVyc2UuY29ubmVjdGlvbi5tdWMuZ3JvdXBjaGF0KHRoaXMubW9kZWwuZ2V0KCdqaWQnKSwgdGV4dCwgdW5kZWZpbmVkLCBTdHJpbmcoKG5ldyBEYXRlKCkpLmdldFRpbWUoKSkpCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHNlbmRDaGF0Um9vbU1lc3NhZ2U6IGZ1bmN0aW9uICh0ZXh0KSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSB0ZXh0LnJlcGxhY2UoL15ccyovLCAiIikubWF0Y2goL15cLyguKj8pKD86ICguKikpPyQvKSB8fCBbZmFsc2VdLCBhcmdzOwogICAgICAgICAgICAgICAgc3dpdGNoIChtYXRjaFsxXSkgewogICAgICAgICAgICAgICAgICAgIGNhc2UgJ2Jhbic6CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MgPSBtYXRjaFsyXS5zcGxpdE9uY2UoJyAnKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5tdWMuYmFuKHRoaXMubW9kZWwuZ2V0KCdqaWQnKSwgYXJnc1swXSwgYXJnc1sxXSwgdW5kZWZpbmVkLCAkLnByb3h5KHRoaXMub25Db21tYW5kRXJyb3IsIHRoaXMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnY2xlYXInOgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNsZWFyQ2hhdFJvb21NZXNzYWdlcygpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICdkZW9wJzoKICAgICAgICAgICAgICAgICAgICAgICAgYXJncyA9IG1hdGNoWzJdLnNwbGl0T25jZSgnICcpOwogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLm11Yy5kZW9wKHRoaXMubW9kZWwuZ2V0KCdqaWQnKSwgYXJnc1swXSwgYXJnc1sxXSwgdW5kZWZpbmVkLCAkLnByb3h5KHRoaXMub25Db21tYW5kRXJyb3IsIHRoaXMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnaGVscCc6CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0hlbHBNZXNzYWdlcyhbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPHN0cm9uZz4vYmFuPC9zdHJvbmc+OiAnICAgK19fKCdCYW4gdXNlciBmcm9tIHJvb20nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8c3Ryb25nPi9jbGVhcjwvc3Ryb25nPjogJyArX18oJ1JlbW92ZSBtZXNzYWdlcycpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxzdHJvbmc+L2hlbHA8L3N0cm9uZz46ICcgICtfXygnU2hvdyB0aGlzIG1lbnUnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8c3Ryb25nPi9raWNrPC9zdHJvbmc+OiAnICArX18oJ0tpY2sgdXNlciBmcm9tIHJvb20nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8c3Ryb25nPi9tZTwvc3Ryb25nPjogJyAgICArX18oJ1dyaXRlIGluIDNyZCBwZXJzb24nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8c3Ryb25nPi9tdXRlPC9zdHJvbmc+OiAnICArX18oIlJlbW92ZSB1c2VyJ3MgYWJpbGl0eSB0byBwb3N0IG1lc3NhZ2VzIiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPHN0cm9uZz4vbmljazwvc3Ryb25nPjogJyAgK19fKCdDaGFuZ2UgeW91ciBuaWNrbmFtZScpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxzdHJvbmc+L3RvcGljPC9zdHJvbmc+OiAnICtfXygnU2V0IHJvb20gdG9waWMnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8c3Ryb25nPi92b2ljZTwvc3Ryb25nPjogJyArX18oJ0FsbG93IG11dGVkIHVzZXIgdG8gcG9zdCBtZXNzYWdlcycpCiAgICAgICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICdraWNrJzoKICAgICAgICAgICAgICAgICAgICAgICAgYXJncyA9IG1hdGNoWzJdLnNwbGl0T25jZSgnICcpOwogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLm11Yy5raWNrKHRoaXMubW9kZWwuZ2V0KCdqaWQnKSwgYXJnc1swXSwgYXJnc1sxXSwgdW5kZWZpbmVkLCAkLnByb3h5KHRoaXMub25Db21tYW5kRXJyb3IsIHRoaXMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnbXV0ZSc6CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MgPSBtYXRjaFsyXS5zcGxpdE9uY2UoJyAnKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5tdWMubXV0ZSh0aGlzLm1vZGVsLmdldCgnamlkJyksIGFyZ3NbMF0sIGFyZ3NbMV0sIHVuZGVmaW5lZCwgJC5wcm94eSh0aGlzLm9uQ29tbWFuZEVycm9yLCB0aGlzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ25pY2snOgogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLm11Yy5jaGFuZ2VOaWNrKHRoaXMubW9kZWwuZ2V0KCdqaWQnKSwgbWF0Y2hbMl0pOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICdvcCc6CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MgPSBtYXRjaFsyXS5zcGxpdE9uY2UoJyAnKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5tdWMub3AodGhpcy5tb2RlbC5nZXQoJ2ppZCcpLCBhcmdzWzBdLCBhcmdzWzFdLCB1bmRlZmluZWQsICQucHJveHkodGhpcy5vbkNvbW1hbmRFcnJvciwgdGhpcykpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICd0b3BpYyc6CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24ubXVjLnNldFRvcGljKHRoaXMubW9kZWwuZ2V0KCdqaWQnKSwgbWF0Y2hbMl0pOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICd2b2ljZSc6CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MgPSBtYXRjaFsyXS5zcGxpdE9uY2UoJyAnKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5tdWMudm9pY2UodGhpcy5tb2RlbC5nZXQoJ2ppZCcpLCBhcmdzWzBdLCBhcmdzWzFdLCB1bmRlZmluZWQsICQucHJveHkodGhpcy5vbkNvbW1hbmRFcnJvciwgdGhpcykpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZUNoYXRSb29tTWVzc2FnZSh0ZXh0KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGNvbm5lY3Q6IGZ1bmN0aW9uIChwYXNzd29yZCkgewogICAgICAgICAgICAgICAgaWYgKF8uaGFzKGNvbnZlcnNlLmNvbm5lY3Rpb24ubXVjLnJvb21zLCB0aGlzLm1vZGVsLmdldCgnamlkJykpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlIHJvb20gZXhpc3RzLCBpdCBhbHJlYWR5IGhhcyBldmVudCBsaXN0ZW5lcnMsIHNvIHdlCiAgICAgICAgICAgICAgICAgICAgLy8gZG9uJ3QgYWRkIHRoZW0gYWdhaW4uCiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5tdWMuam9pbigKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5nZXQoJ2ppZCcpLCB0aGlzLm1vZGVsLmdldCgnbmljaycpLCBudWxsLCBudWxsLCBudWxsLCBwYXNzd29yZCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24ubXVjLmpvaW4oCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuZ2V0KCdqaWQnKSwKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5nZXQoJ25pY2snKSwKICAgICAgICAgICAgICAgICAgICAgICAgJC5wcm94eSh0aGlzLm9uQ2hhdFJvb21NZXNzYWdlLCB0aGlzKSwKICAgICAgICAgICAgICAgICAgICAgICAgJC5wcm94eSh0aGlzLm9uQ2hhdFJvb21QcmVzZW5jZSwgdGhpcyksCiAgICAgICAgICAgICAgICAgICAgICAgICQucHJveHkodGhpcy5vbkNoYXRSb29tUm9zdGVyLCB0aGlzKSwKICAgICAgICAgICAgICAgICAgICAgICAgcGFzc3dvcmQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25MZWF2ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5zZXQoJ2Nvbm5lY3RlZCcsIGZhbHNlKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlbmRlckNvbmZpZ3VyYXRpb25Gb3JtOiBmdW5jdGlvbiAoc3RhbnphKSB7CiAgICAgICAgICAgICAgICB2YXIgJGZvcm09IHRoaXMuJGVsLmZpbmQoJ2Zvcm0uY2hhdHJvb20tZm9ybScpLAogICAgICAgICAgICAgICAgICAgICRzdGFuemEgPSAkKHN0YW56YSksCiAgICAgICAgICAgICAgICAgICAgJGZpZWxkcyA9ICRzdGFuemEuZmluZCgnZmllbGQnKSwKICAgICAgICAgICAgICAgICAgICB0aXRsZSA9ICRzdGFuemEuZmluZCgndGl0bGUnKS50ZXh0KCksCiAgICAgICAgICAgICAgICAgICAgaW5zdHJ1Y3Rpb25zID0gJHN0YW56YS5maW5kKCdpbnN0cnVjdGlvbnMnKS50ZXh0KCksCiAgICAgICAgICAgICAgICAgICAgaSwgaiwgb3B0aW9ucz1bXSwgJGZpZWxkLCAkb3B0aW9uczsKICAgICAgICAgICAgICAgIHZhciBpbnB1dF90eXBlcyA9IHsKICAgICAgICAgICAgICAgICAgICAndGV4dC1wcml2YXRlJzogJ3Bhc3N3b3JkJywKICAgICAgICAgICAgICAgICAgICAndGV4dC1zaW5nbGUnOiAndGV4dGxpbmUnLAogICAgICAgICAgICAgICAgICAgICdib29sZWFuJzogJ2NoZWNrYm94JywKICAgICAgICAgICAgICAgICAgICAnaGlkZGVuJzogJ2hpZGRlbicsCiAgICAgICAgICAgICAgICAgICAgJ2xpc3Qtc2luZ2xlJzogJ2Ryb3Bkb3duJwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICRmb3JtLmZpbmQoJ3NwYW4uc3Bpbm5lcicpLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgJGZvcm0uYXBwZW5kKCQoJzxsZWdlbmQ+JykudGV4dCh0aXRsZSkpOwogICAgICAgICAgICAgICAgaWYgKGluc3RydWN0aW9ucyAhPSB0aXRsZSkgewogICAgICAgICAgICAgICAgICAgICRmb3JtLmFwcGVuZCgkKCc8cD4nKS50ZXh0KGluc3RydWN0aW9ucykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9yIChpPTA7IGk8JGZpZWxkcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICRmaWVsZCA9ICQoJGZpZWxkc1tpXSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCRmaWVsZC5hdHRyKCd0eXBlJykgPT0gJ2xpc3Qtc2luZ2xlJykgewogICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICRvcHRpb25zID0gJGZpZWxkLmZpbmQoJ29wdGlvbicpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGo9MDsgajwkb3B0aW9ucy5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5wdXNoKGNvbnZlcnNlLnRlbXBsYXRlcy5zZWxlY3Rfb3B0aW9uKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogJCgkb3B0aW9uc1tqXSkuZmluZCgndmFsdWUnKS50ZXh0KCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6ICQoJG9wdGlvbnNbal0pLmF0dHIoJ2xhYmVsJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAkZm9ybS5hcHBlbmQoY29udmVyc2UudGVtcGxhdGVzLmZvcm1fc2VsZWN0KHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICRmaWVsZC5hdHRyKCd2YXInKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiAkZmllbGQuYXR0cignbGFiZWwnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnMuam9pbignJykKICAgICAgICAgICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoJGZpZWxkLmF0dHIoJ3R5cGUnKSA9PSAnYm9vbGVhbicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGZvcm0uYXBwZW5kKGNvbnZlcnNlLnRlbXBsYXRlcy5mb3JtX2NoZWNrYm94KHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICRmaWVsZC5hdHRyKCd2YXInKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IGlucHV0X3R5cGVzWyRmaWVsZC5hdHRyKCd0eXBlJyldLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6ICRmaWVsZC5hdHRyKCdsYWJlbCcpIHx8ICcnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tlZDogJGZpZWxkLmZpbmQoJ3ZhbHVlJykudGV4dCgpID09PSAiMSIgJiYgJ2NoZWNrZWQ9IjEiJyB8fCAnJwogICAgICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGZvcm0uYXBwZW5kKGNvbnZlcnNlLnRlbXBsYXRlcy5mb3JtX2lucHV0KHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICRmaWVsZC5hdHRyKCd2YXInKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IGlucHV0X3R5cGVzWyRmaWVsZC5hdHRyKCd0eXBlJyldLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6ICRmaWVsZC5hdHRyKCdsYWJlbCcpIHx8ICcnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICRmaWVsZC5maW5kKCd2YWx1ZScpLnRleHQoKQogICAgICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJGZvcm0uYXBwZW5kKCc8aW5wdXQgdHlwZT0ic3VibWl0IiB2YWx1ZT0iJytfXygnU2F2ZScpKyciLz4nKTsKICAgICAgICAgICAgICAgICRmb3JtLmFwcGVuZCgnPGlucHV0IHR5cGU9ImJ1dHRvbiIgdmFsdWU9IicrX18oJ0NhbmNlbCcpKyciLz4nKTsKICAgICAgICAgICAgICAgICRmb3JtLm9uKCdzdWJtaXQnLCAkLnByb3h5KHRoaXMuc2F2ZUNvbmZpZ3VyYXRpb24sIHRoaXMpKTsKICAgICAgICAgICAgICAgICRmb3JtLmZpbmQoJ2lucHV0W3R5cGU9YnV0dG9uXScpLm9uKCdjbGljaycsICQucHJveHkodGhpcy5jYW5jZWxDb25maWd1cmF0aW9uLCB0aGlzKSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzYXZlQ29uZmlndXJhdGlvbjogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgdmFyICRpbnB1dHMgPSAkKGV2LnRhcmdldCkuZmluZCgnOmlucHV0Om5vdChbdHlwZT1idXR0b25dKTpub3QoW3R5cGU9c3VibWl0XSknKSwKICAgICAgICAgICAgICAgICAgICBjb3VudCA9ICRpbnB1dHMubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgIGNvbmZpZ0FycmF5ID0gW107CiAgICAgICAgICAgICAgICAkaW5wdXRzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhciAkaW5wdXQgPSAkKHRoaXMpLCB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoJGlucHV0LmlzKCdbdHlwZT1jaGVja2JveF0nKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9ICRpbnB1dC5pcygnOmNoZWNrZWQnKSAmJiAxIHx8IDA7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSAkaW5wdXQudmFsKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhciBjbm9kZSA9ICQoY29udmVyc2UudGVtcGxhdGVzLmZpZWxkKHsKICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogJGlucHV0LmF0dHIoJ25hbWUnKSwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlCiAgICAgICAgICAgICAgICAgICAgfSkpWzBdOwogICAgICAgICAgICAgICAgICAgIGNvbmZpZ0FycmF5LnB1c2goY25vZGUpOwogICAgICAgICAgICAgICAgICAgIGlmICghLS1jb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLm11Yy5zYXZlQ29uZmlndXJhdGlvbigKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQubW9kZWwuZ2V0KCdqaWQnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZ0FycmF5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJC5wcm94eSh0aGF0Lm9uQ29uZmlnU2F2ZWQsIHRoYXQpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJC5wcm94eSh0aGF0Lm9uRXJyb3JDb25maWdTYXZlZCwgdGhhdCkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmZpbmQoJ2Rpdi5jaGF0cm9vbS1mb3JtLWNvbnRhaW5lcicpLmhpZGUoCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGF0LiRlbC5maW5kKCcuY2hhdC1hcmVhJykuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGF0LiRlbC5maW5kKCcucGFydGljaXBhbnRzJykuc2hvdygpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25Db25maWdTYXZlZDogZnVuY3Rpb24gKHN0YW56YSkgewogICAgICAgICAgICAgICAgLy8gWFhYCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBvbkVycm9yQ29uZmlnU2F2ZWQ6IGZ1bmN0aW9uIChzdGFuemEpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd1N0YXR1c05vdGlmaWNhdGlvbihfXygiQW4gZXJyb3Igb2NjdXJyZWQgd2hpbGUgdHJ5aW5nIHRvIHNhdmUgdGhlIGZvcm0uIikpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgY2FuY2VsQ29uZmlndXJhdGlvbjogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgnZGl2LmNoYXRyb29tLWZvcm0tY29udGFpbmVyJykuaGlkZSgKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuJGVsLmZpbmQoJy5jaGF0LWFyZWEnKS5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuJGVsLmZpbmQoJy5wYXJ0aWNpcGFudHMnKS5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBjb25maWd1cmVDaGF0Um9vbTogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuJGVsLmZpbmQoJ2Rpdi5jaGF0cm9vbS1mb3JtLWNvbnRhaW5lcicpLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuJCgnLmNoYXQtYm9keScpLmNoaWxkcmVuKCkuaGlkZSgpOwogICAgICAgICAgICAgICAgdGhpcy4kKCcuY2hhdC1ib2R5JykuYXBwZW5kKAogICAgICAgICAgICAgICAgICAgICQoJzxkaXYgY2xhc3M9ImNoYXRyb29tLWZvcm0tY29udGFpbmVyIj4nKwogICAgICAgICAgICAgICAgICAgICAgICAnPGZvcm0gY2xhc3M9ImNoYXRyb29tLWZvcm0iPicrCiAgICAgICAgICAgICAgICAgICAgICAgICc8c3BhbiBjbGFzcz0ic3Bpbm5lciBjZW50ZXJlZCIvPicrCiAgICAgICAgICAgICAgICAgICAgICAgICc8L2Zvcm0+JysKICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JykpOwogICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5tdWMuY29uZmlndXJlKAogICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuZ2V0KCdqaWQnKSwKICAgICAgICAgICAgICAgICAgICAkLnByb3h5KHRoaXMucmVuZGVyQ29uZmlndXJhdGlvbkZvcm0sIHRoaXMpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc3VibWl0UGFzc3dvcmQ6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIHZhciBwYXNzd29yZCA9IHRoaXMuJGVsLmZpbmQoJy5jaGF0cm9vbS1mb3JtJykuZmluZCgnaW5wdXRbdHlwZT1wYXNzd29yZF0nKS52YWwoKTsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmZpbmQoJy5jaGF0cm9vbS1mb3JtLWNvbnRhaW5lcicpLnJlcGxhY2VXaXRoKCc8c3BhbiBjbGFzcz0ic3Bpbm5lciBjZW50ZXJlZCIvPicpOwogICAgICAgICAgICAgICAgdGhpcy5jb25uZWN0KHBhc3N3b3JkKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlbmRlclBhc3N3b3JkRm9ybTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy4kKCcuY2hhdC1ib2R5JykuY2hpbGRyZW4oKS5oaWRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLiQoJ3NwYW4uY2VudGVyZWQuc3Bpbm5lcicpLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgdGhpcy4kKCcuY2hhdC1ib2R5JykuYXBwZW5kKAogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLnRlbXBsYXRlcy5jaGF0cm9vbV9wYXNzd29yZF9mb3JtKHsKICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGluZzogX18oJ1RoaXMgY2hhdHJvb20gcmVxdWlyZXMgYSBwYXNzd29yZCcpLAogICAgICAgICAgICAgICAgICAgICAgICBsYWJlbF9wYXNzd29yZDogX18oJ1Bhc3N3b3JkOiAnKSwKICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWxfc3VibWl0OiBfXygnU3VibWl0JykKICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICB0aGlzLiQoJy5jaGF0cm9vbS1mb3JtJykub24oJ3N1Ym1pdCcsICQucHJveHkodGhpcy5zdWJtaXRQYXNzd29yZCwgdGhpcykpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2hvd0Rpc2Nvbm5lY3RNZXNzYWdlOiBmdW5jdGlvbiAobXNnKSB7CiAgICAgICAgICAgICAgICB0aGlzLiQoJy5jaGF0LWFyZWEnKS5oaWRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLiQoJy5wYXJ0aWNpcGFudHMnKS5oaWRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLiQoJ3NwYW4uY2VudGVyZWQuc3Bpbm5lcicpLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgdGhpcy4kKCcuY2hhdC1ib2R5JykuYXBwZW5kKCQoJzxwPicrbXNnKyc8L3A+JykpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyogaHR0cDovL3htcHAub3JnL2V4dGVuc2lvbnMveGVwLTAwNDUuaHRtbAogICAgICAgICAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgICAgICAqIDEwMCBtZXNzYWdlICAgICAgRW50ZXJpbmcgYSByb29tICAgICAgICAgSW5mb3JtIHVzZXIgdGhhdCBhbnkgb2NjdXBhbnQgaXMgYWxsb3dlZCB0byBzZWUgdGhlIHVzZXIncyBmdWxsIEpJRAogICAgICAgICAgICAgKiAxMDEgbWVzc2FnZSAob3V0IG9mIGJhbmQpICAgICAgICAgICAgICAgIEFmZmlsaWF0aW9uIGNoYW5nZSAgSW5mb3JtIHVzZXIgdGhhdCBoaXMgb3IgaGVyIGFmZmlsaWF0aW9uIGNoYW5nZWQgd2hpbGUgbm90IGluIHRoZSByb29tCiAgICAgICAgICAgICAqIDEwMiBtZXNzYWdlICAgICAgQ29uZmlndXJhdGlvbiBjaGFuZ2UgICAgSW5mb3JtIG9jY3VwYW50cyB0aGF0IHJvb20gbm93IHNob3dzIHVuYXZhaWxhYmxlIG1lbWJlcnMKICAgICAgICAgICAgICogMTAzIG1lc3NhZ2UgICAgICBDb25maWd1cmF0aW9uIGNoYW5nZSAgICBJbmZvcm0gb2NjdXBhbnRzIHRoYXQgcm9vbSBub3cgZG9lcyBub3Qgc2hvdyB1bmF2YWlsYWJsZSBtZW1iZXJzCiAgICAgICAgICAgICAqIDEwNCBtZXNzYWdlICAgICAgQ29uZmlndXJhdGlvbiBjaGFuZ2UgICAgSW5mb3JtIG9jY3VwYW50cyB0aGF0IGEgbm9uLXByaXZhY3ktcmVsYXRlZCByb29tIGNvbmZpZ3VyYXRpb24gY2hhbmdlIGhhcyBvY2N1cnJlZAogICAgICAgICAgICAgKiAxMTAgcHJlc2VuY2UgICAgIEFueSByb29tIHByZXNlbmNlICAgICAgIEluZm9ybSB1c2VyIHRoYXQgcHJlc2VuY2UgcmVmZXJzIHRvIG9uZSBvZiBpdHMgb3duIHJvb20gb2NjdXBhbnRzCiAgICAgICAgICAgICAqIDE3MCBtZXNzYWdlIG9yIGluaXRpYWwgcHJlc2VuY2UgICAgICAgICAgQ29uZmlndXJhdGlvbiBjaGFuZ2UgICAgSW5mb3JtIG9jY3VwYW50cyB0aGF0IHJvb20gbG9nZ2luZyBpcyBub3cgZW5hYmxlZAogICAgICAgICAgICAgKiAxNzEgbWVzc2FnZSAgICAgIENvbmZpZ3VyYXRpb24gY2hhbmdlICAgIEluZm9ybSBvY2N1cGFudHMgdGhhdCByb29tIGxvZ2dpbmcgaXMgbm93IGRpc2FibGVkCiAgICAgICAgICAgICAqIDE3MiBtZXNzYWdlICAgICAgQ29uZmlndXJhdGlvbiBjaGFuZ2UgICAgSW5mb3JtIG9jY3VwYW50cyB0aGF0IHRoZSByb29tIGlzIG5vdyBub24tYW5vbnltb3VzCiAgICAgICAgICAgICAqIDE3MyBtZXNzYWdlICAgICAgQ29uZmlndXJhdGlvbiBjaGFuZ2UgICAgSW5mb3JtIG9jY3VwYW50cyB0aGF0IHRoZSByb29tIGlzIG5vdyBzZW1pLWFub255bW91cwogICAgICAgICAgICAgKiAxNzQgbWVzc2FnZSAgICAgIENvbmZpZ3VyYXRpb24gY2hhbmdlICAgIEluZm9ybSBvY2N1cGFudHMgdGhhdCB0aGUgcm9vbSBpcyBub3cgZnVsbHktYW5vbnltb3VzCiAgICAgICAgICAgICAqIDIwMSBwcmVzZW5jZSAgICAgRW50ZXJpbmcgYSByb29tICAgICAgICAgSW5mb3JtIHVzZXIgdGhhdCBhIG5ldyByb29tIGhhcyBiZWVuIGNyZWF0ZWQKICAgICAgICAgICAgICogMjEwIHByZXNlbmNlICAgICBFbnRlcmluZyBhIHJvb20gICAgICAgICBJbmZvcm0gdXNlciB0aGF0IHRoZSBzZXJ2aWNlIGhhcyBhc3NpZ25lZCBvciBtb2RpZmllZCB0aGUgb2NjdXBhbnQncyByb29tbmljawogICAgICAgICAgICAgKiAzMDEgcHJlc2VuY2UgICAgIFJlbW92YWwgZnJvbSByb29tICAgICAgIEluZm9ybSB1c2VyIHRoYXQgaGUgb3Igc2hlIGhhcyBiZWVuIGJhbm5lZCBmcm9tIHRoZSByb29tCiAgICAgICAgICAgICAqIDMwMyBwcmVzZW5jZSAgICAgRXhpdGluZyBhIHJvb20gICAgICAgICAgSW5mb3JtIGFsbCBvY2N1cGFudHMgb2YgbmV3IHJvb20gbmlja25hbWUKICAgICAgICAgICAgICogMzA3IHByZXNlbmNlICAgICBSZW1vdmFsIGZyb20gcm9vbSAgICAgICBJbmZvcm0gdXNlciB0aGF0IGhlIG9yIHNoZSBoYXMgYmVlbiBraWNrZWQgZnJvbSB0aGUgcm9vbQogICAgICAgICAgICAgKiAzMjEgcHJlc2VuY2UgICAgIFJlbW92YWwgZnJvbSByb29tICAgICAgIEluZm9ybSB1c2VyIHRoYXQgaGUgb3Igc2hlIGlzIGJlaW5nIHJlbW92ZWQgZnJvbSB0aGUgcm9vbSBiZWNhdXNlIG9mIGFuIGFmZmlsaWF0aW9uIGNoYW5nZQogICAgICAgICAgICAgKiAzMjIgcHJlc2VuY2UgICAgIFJlbW92YWwgZnJvbSByb29tICAgICAgIEluZm9ybSB1c2VyIHRoYXQgaGUgb3Igc2hlIGlzIGJlaW5nIHJlbW92ZWQgZnJvbSB0aGUgcm9vbSBiZWNhdXNlIHRoZSByb29tIGhhcyBiZWVuIGNoYW5nZWQgdG8gbWVtYmVycy1vbmx5IGFuZCB0aGUgdXNlciBpcyBub3QgYSBtZW1iZXIKICAgICAgICAgICAgICogMzMyIHByZXNlbmNlICAgICBSZW1vdmFsIGZyb20gcm9vbSAgICAgICBJbmZvcm0gdXNlciB0aGF0IGhlIG9yIHNoZSBpcyBiZWluZyByZW1vdmVkIGZyb20gdGhlIHJvb20gYmVjYXVzZSBvZiBhIHN5c3RlbSBzaHV0ZG93bgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaW5mb01lc3NhZ2VzOiB7CiAgICAgICAgICAgICAgICAxMDA6IF9fKCdUaGlzIHJvb20gaXMgbm90IGFub255bW91cycpLAogICAgICAgICAgICAgICAgMTAyOiBfXygnVGhpcyByb29tIG5vdyBzaG93cyB1bmF2YWlsYWJsZSBtZW1iZXJzJyksCiAgICAgICAgICAgICAgICAxMDM6IF9fKCdUaGlzIHJvb20gZG9lcyBub3Qgc2hvdyB1bmF2YWlsYWJsZSBtZW1iZXJzJyksCiAgICAgICAgICAgICAgICAxMDQ6IF9fKCdOb24tcHJpdmFjeS1yZWxhdGVkIHJvb20gY29uZmlndXJhdGlvbiBoYXMgY2hhbmdlZCcpLAogICAgICAgICAgICAgICAgMTcwOiBfXygnUm9vbSBsb2dnaW5nIGlzIG5vdyBlbmFibGVkJyksCiAgICAgICAgICAgICAgICAxNzE6IF9fKCdSb29tIGxvZ2dpbmcgaXMgbm93IGRpc2FibGVkJyksCiAgICAgICAgICAgICAgICAxNzI6IF9fKCdUaGlzIHJvb20gaXMgbm93IG5vbi1hbm9ueW1vdXMnKSwKICAgICAgICAgICAgICAgIDE3MzogX18oJ1RoaXMgcm9vbSBpcyBub3cgc2VtaS1hbm9ueW1vdXMnKSwKICAgICAgICAgICAgICAgIDE3NDogX18oJ1RoaXMgcm9vbSBpcyBub3cgZnVsbHktYW5vbnltb3VzJyksCiAgICAgICAgICAgICAgICAyMDE6IF9fKCdBIG5ldyByb29tIGhhcyBiZWVuIGNyZWF0ZWQnKQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgZGlzY29ubmVjdE1lc3NhZ2VzOiB7CiAgICAgICAgICAgICAgICAzMDE6IF9fKCdZb3UgaGF2ZSBiZWVuIGJhbm5lZCBmcm9tIHRoaXMgcm9vbScpLAogICAgICAgICAgICAgICAgMzA3OiBfXygnWW91IGhhdmUgYmVlbiBraWNrZWQgZnJvbSB0aGlzIHJvb20nKSwKICAgICAgICAgICAgICAgIDMyMTogX18oIllvdSBoYXZlIGJlZW4gcmVtb3ZlZCBmcm9tIHRoaXMgcm9vbSBiZWNhdXNlIG9mIGFuIGFmZmlsaWF0aW9uIGNoYW5nZSIpLAogICAgICAgICAgICAgICAgMzIyOiBfXygiWW91IGhhdmUgYmVlbiByZW1vdmVkIGZyb20gdGhpcyByb29tIGJlY2F1c2UgdGhlIHJvb20gaGFzIGNoYW5nZWQgdG8gbWVtYmVycy1vbmx5IGFuZCB5b3UncmUgbm90IGEgbWVtYmVyIiksCiAgICAgICAgICAgICAgICAzMzI6IF9fKCJZb3UgaGF2ZSBiZWVuIHJlbW92ZWQgZnJvbSB0aGlzIHJvb20gYmVjYXVzZSB0aGUgTVVDIChNdWx0aS11c2VyIGNoYXQpIHNlcnZpY2UgaXMgYmVpbmcgc2h1dCBkb3duLiIpCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBhY3Rpb25JbmZvTWVzc2FnZXM6IHsKICAgICAgICAgICAgICAgIC8qIFhYWDogTm90ZSB0aGUgdHJpcGxlIHVuZGVyc2NvcmUgZnVuY3Rpb24gYW5kIG5vdCBkb3VibGUKICAgICAgICAgICAgICAgICAqIHVuZGVyc2NvcmUuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVGhpcyBpcyBhIGhhY2suIFdlIGNhbid0IHBhc3MgdGhlIHN0cmluZ3MgdG8gX18gYmVjYXVzZSB3ZQogICAgICAgICAgICAgICAgICogZG9uJ3QgeWV0IGtub3cgd2hhdCB0aGUgdmFyaWFibGUgdG8gaW50ZXJwb2xhdGUgaXMuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVHJpcGxlIHVuZGVyc2NvcmUgd2lsbCBqdXN0IHJldHVybiB0aGUgc3RyaW5nIGFnYWluLCBidXQgd2UKICAgICAgICAgICAgICAgICAqIGNhbiB0aGVuIGF0IGxlYXN0IHRlbGwgZ2V0dGV4dCB0byBzY2FuIGZvciBpdCBzbyB0aGF0IHRoZXNlCiAgICAgICAgICAgICAgICAgKiBzdHJpbmdzIGFyZSBwaWNrZWQgdXAgYnkgdGhlIHRyYW5zbGF0aW9uIG1hY2hpbmVyeS4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgMzAxOiBfX18oIjxzdHJvbmc+JTEkczwvc3Ryb25nPiBoYXMgYmVlbiBiYW5uZWQiKSwKICAgICAgICAgICAgICAgIDMwMzogX19fKCI8c3Ryb25nPiUxJHM8L3N0cm9uZz4ncyBuaWNrbmFtZSBoYXMgY2hhbmdlZCIpLAogICAgICAgICAgICAgICAgMzA3OiBfX18oIjxzdHJvbmc+JTEkczwvc3Ryb25nPiBoYXMgYmVlbiBraWNrZWQgb3V0IiksCiAgICAgICAgICAgICAgICAzMjE6IF9fXygiPHN0cm9uZz4lMSRzPC9zdHJvbmc+IGhhcyBiZWVuIHJlbW92ZWQgYmVjYXVzZSBvZiBhbiBhZmZpbGlhdGlvbiBjaGFuZ2UiKSwKICAgICAgICAgICAgICAgIDMyMjogX19fKCI8c3Ryb25nPiUxJHM8L3N0cm9uZz4gaGFzIGJlZW4gcmVtb3ZlZCBmb3Igbm90IGJlaW5nIGEgbWVtYmVyIikKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG5ld05pY2tuYW1lTWVzc2FnZXM6IHsKICAgICAgICAgICAgICAgIDIxMDogX19fKCdZb3VyIG5pY2tuYW1lIGhhcyBiZWVuIGF1dG9tYXRpY2FsbHkgY2hhbmdlZCB0bzogPHN0cm9uZz4lMSRzPC9zdHJvbmc+JyksCiAgICAgICAgICAgICAgICAzMDM6IF9fXygnWW91ciBuaWNrbmFtZSBoYXMgYmVlbiBjaGFuZ2VkIHRvOiA8c3Ryb25nPiUxJHM8L3N0cm9uZz4nKQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2hvd1N0YXR1c01lc3NhZ2VzOiBmdW5jdGlvbiAoJGVsLCBpc19zZWxmKSB7CiAgICAgICAgICAgICAgICAvKiBDaGVjayBmb3Igc3RhdHVzIGNvZGVzIGFuZCBjb21tdW5pY2F0ZSB0aGVpciBwdXJwb3NlIHRvIHRoZSB1c2VyLgogICAgICAgICAgICAgICAgICogQWxsb3cgdXNlciB0byBjb25maWd1cmUgY2hhdCByb29tIGlmIHRoZXkgYXJlIHRoZSBvd25lci4KICAgICAgICAgICAgICAgICAqIFNlZTogaHR0cDovL3htcHAub3JnL3JlZ2lzdHJhci9tdWNzdGF0dXMuaHRtbAogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICB2YXIgJGNoYXRfY29udGVudCwKICAgICAgICAgICAgICAgICAgICBkaXNjb25uZWN0X21zZ3MgPSBbXSwKICAgICAgICAgICAgICAgICAgICBtc2dzID0gW10sCiAgICAgICAgICAgICAgICAgICAgcmVhc29ucyA9IFtdOwogICAgICAgICAgICAgICAgJGVsLmZpbmQoJ3hbeG1sbnM9IicrU3Ryb3BoZS5OUy5NVUNfVVNFUisnIl0nKS5lYWNoKCQucHJveHkoZnVuY3Rpb24gKGlkeCwgeCkgewogICAgICAgICAgICAgICAgICAgIHZhciAkaXRlbSA9ICQoeCkuZmluZCgnaXRlbScpOwogICAgICAgICAgICAgICAgICAgIGlmIChTdHJvcGhlLmdldEJhcmVKaWRGcm9tSmlkKCRpdGVtLmF0dHIoJ2ppZCcpKSA9PT0gY29udmVyc2UuYmFyZV9qaWQgJiYgJGl0ZW0uYXR0cignYWZmaWxpYXRpb24nKSA9PT0gJ293bmVyJykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5maW5kKCdhLmNvbmZpZ3VyZS1jaGF0cm9vbS1idXR0b24nKS5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICQoeCkuZmluZCgnaXRlbSByZWFzb24nKS5lYWNoKGZ1bmN0aW9uIChpZHgsIHJlYXNvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJChyZWFzb24pLnRleHQoKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhc29ucy5wdXNoKCQocmVhc29uKS50ZXh0KCkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgJCh4KS5maW5kKCdzdGF0dXMnKS5lYWNoKCQucHJveHkoZnVuY3Rpb24gKGlkeCwgc3RhdCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29kZSA9IHN0YXQuZ2V0QXR0cmlidXRlKCdjb2RlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc19zZWxmICYmIF8uY29udGFpbnMoXy5rZXlzKHRoaXMubmV3Tmlja25hbWVNZXNzYWdlcyksIGNvZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLnNhdmUoeyduaWNrJzogU3Ryb3BoZS5nZXRSZXNvdXJjZUZyb21KaWQoJGVsLmF0dHIoJ2Zyb20nKSl9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zZ3MucHVzaChfXyh0aGlzLm5ld05pY2tuYW1lTWVzc2FnZXNbY29kZV0sICRpdGVtLmF0dHIoJ25pY2snKSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzX3NlbGYgJiYgXy5jb250YWlucyhfLmtleXModGhpcy5kaXNjb25uZWN0TWVzc2FnZXMpLCBjb2RlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzY29ubmVjdF9tc2dzLnB1c2godGhpcy5kaXNjb25uZWN0TWVzc2FnZXNbY29kZV0pOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFpc19zZWxmICYmIF8uY29udGFpbnMoXy5rZXlzKHRoaXMuYWN0aW9uSW5mb01lc3NhZ2VzKSwgY29kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zZ3MucHVzaCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfXyh0aGlzLmFjdGlvbkluZm9NZXNzYWdlc1tjb2RlXSwgU3Ryb3BoZS51bmVzY2FwZU5vZGUoU3Ryb3BoZS5nZXRSZXNvdXJjZUZyb21KaWQoJGVsLmF0dHIoJ2Zyb20nKSkpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChfLmNvbnRhaW5zKF8ua2V5cyh0aGlzLmluZm9NZXNzYWdlcyksIGNvZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtc2dzLnB1c2godGhpcy5pbmZvTWVzc2FnZXNbY29kZV0pOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvZGUgIT09ICcxMTAnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJChzdGF0KS50ZXh0KCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtc2dzLnB1c2goJChzdGF0KS50ZXh0KCkpOyAvLyBTb21ldGltZXMgdGhlIHN0YXR1cyBjb250YWlucyBodW1hbiByZWFkYWJsZSB0ZXh0IGFuZCBub3QgYSBjb2RlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgICAgICAgICAgfSwgdGhpcykpOwoKICAgICAgICAgICAgICAgIGlmIChkaXNjb25uZWN0X21zZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGZvciAoaT0wOyBpPGRpc2Nvbm5lY3RfbXNncy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dEaXNjb25uZWN0TWVzc2FnZShkaXNjb25uZWN0X21zZ3NbaV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBmb3IgKGk9MDsgaTxyZWFzb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Rpc2Nvbm5lY3RNZXNzYWdlKF9fKCdUaGUgcmVhc29uIGdpdmVuIGlzOiAiJytyZWFzb25zW2ldKyciJyksIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLnNldCgnY29ubmVjdGVkJywgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICRjaGF0X2NvbnRlbnQgPSB0aGlzLiRlbC5maW5kKCcuY2hhdC1jb250ZW50Jyk7CiAgICAgICAgICAgICAgICBmb3IgKGk9MDsgaTxtc2dzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgJGNoYXRfY29udGVudC5hcHBlbmQoY29udmVyc2UudGVtcGxhdGVzLmluZm8oe21lc3NhZ2U6IG1zZ3NbaV19KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKGk9MDsgaTxyZWFzb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93U3RhdHVzTm90aWZpY2F0aW9uKF9fKCdUaGUgcmVhc29uIGdpdmVuIGlzOiAiJytyZWFzb25zW2ldKyciJyksIHRydWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2Nyb2xsRG93bigpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2hvd0Vycm9yTWVzc2FnZTogZnVuY3Rpb24gKCRlcnJvciwgcm9vbSkgewogICAgICAgICAgICAgICAgLy8gV2UgZGlkbid0IGVudGVyIHRoZSByb29tLCBzbyB3ZSBtdXN0IHJlbW92ZSBpdCBmcm9tIHRoZSBNVUMKICAgICAgICAgICAgICAgIC8vIGFkZC1vbgogICAgICAgICAgICAgICAgZGVsZXRlIGNvbnZlcnNlLmNvbm5lY3Rpb24ubXVjW3Jvb20ubmFtZV07CiAgICAgICAgICAgICAgICBpZiAoJGVycm9yLmF0dHIoJ3R5cGUnKSA9PSAnYXV0aCcpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoJGVycm9yLmZpbmQoJ25vdC1hdXRob3JpemVkJykubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyUGFzc3dvcmRGb3JtKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgkZXJyb3IuZmluZCgncmVnaXN0cmF0aW9uLXJlcXVpcmVkJykubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Rpc2Nvbm5lY3RNZXNzYWdlKF9fKCdZb3UgYXJlIG5vdCBvbiB0aGUgbWVtYmVyIGxpc3Qgb2YgdGhpcyByb29tJykpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoJGVycm9yLmZpbmQoJ2ZvcmJpZGRlbicpLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dEaXNjb25uZWN0TWVzc2FnZShfXygnWW91IGhhdmUgYmVlbiBiYW5uZWQgZnJvbSB0aGlzIHJvb20nKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgkZXJyb3IuYXR0cigndHlwZScpID09ICdtb2RpZnknKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCRlcnJvci5maW5kKCdqaWQtbWFsZm9ybWVkJykubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Rpc2Nvbm5lY3RNZXNzYWdlKF9fKCdObyBuaWNrbmFtZSB3YXMgc3BlY2lmaWVkJykpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoJGVycm9yLmF0dHIoJ3R5cGUnKSA9PSAnY2FuY2VsJykgewogICAgICAgICAgICAgICAgICAgIGlmICgkZXJyb3IuZmluZCgnbm90LWFsbG93ZWQnKS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93RGlzY29ubmVjdE1lc3NhZ2UoX18oJ1lvdSBhcmUgbm90IGFsbG93ZWQgdG8gY3JlYXRlIG5ldyByb29tcycpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCRlcnJvci5maW5kKCdub3QtYWNjZXB0YWJsZScpLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dEaXNjb25uZWN0TWVzc2FnZShfXygiWW91ciBuaWNrbmFtZSBkb2Vzbid0IGNvbmZvcm0gdG8gdGhpcyByb29tJ3MgcG9saWNpZXMiKSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgkZXJyb3IuZmluZCgnY29uZmxpY3QnKS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogZ2l2ZSB1c2VyIHRoZSBvcHRpb24gb2YgY2hvb3NpbmcgYSBkaWZmZXJlbnQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gbmlja25hbWUKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93RGlzY29ubmVjdE1lc3NhZ2UoX18oIllvdXIgbmlja25hbWUgaXMgYWxyZWFkeSB0YWtlbiIpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCRlcnJvci5maW5kKCdpdGVtLW5vdC1mb3VuZCcpLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dEaXNjb25uZWN0TWVzc2FnZShfXygiVGhpcyByb29tIGRvZXMgbm90ICh5ZXQpIGV4aXN0IikpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoJGVycm9yLmZpbmQoJ3NlcnZpY2UtdW5hdmFpbGFibGUnKS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93RGlzY29ubmVjdE1lc3NhZ2UoX18oIlRoaXMgcm9vbSBoYXMgcmVhY2hlZCBpdCdzIG1heGltdW0gbnVtYmVyIG9mIG9jY3VwYW50cyIpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBvbkNoYXRSb29tUHJlc2VuY2U6IGZ1bmN0aW9uIChwcmVzZW5jZSwgcm9vbSkgewogICAgICAgICAgICAgICAgdmFyICRwcmVzZW5jZSA9ICQocHJlc2VuY2UpLCBpc19zZWxmOwogICAgICAgICAgICAgICAgaWYgKCRwcmVzZW5jZS5hdHRyKCd0eXBlJykgPT09ICdlcnJvcicpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLnNldCgnY29ubmVjdGVkJywgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Vycm9yTWVzc2FnZSgkcHJlc2VuY2UuZmluZCgnZXJyb3InKSwgcm9vbSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlzX3NlbGYgPSAoJHByZXNlbmNlLmZpbmQoInN0YXR1c1tjb2RlPScxMTAnXSIpLmxlbmd0aCkgfHwgKCRwcmVzZW5jZS5hdHRyKCdmcm9tJykgPT0gcm9vbS5uYW1lKycvJytTdHJvcGhlLmVzY2FwZU5vZGUocm9vbS5uaWNrKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLm1vZGVsLmdldCgnY29ubmVjZWQnKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLnNldCgnY29ubmVjdGVkJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCgnc3Bhbi5jZW50ZXJlZC5zcGlubmVyJykucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLmZpbmQoJy5jaGF0LWJvZHknKS5jaGlsZHJlbigpLnNob3coKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93U3RhdHVzTWVzc2FnZXMoJHByZXNlbmNlLCBpc19zZWxmKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25DaGF0Um9vbU1lc3NhZ2U6IGZ1bmN0aW9uIChtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICB2YXIgJG1lc3NhZ2UgPSAkKG1lc3NhZ2UpLAogICAgICAgICAgICAgICAgICAgIGJvZHkgPSAkbWVzc2FnZS5jaGlsZHJlbignYm9keScpLnRleHQoKSwKICAgICAgICAgICAgICAgICAgICBqaWQgPSAkbWVzc2FnZS5hdHRyKCdmcm9tJyksCiAgICAgICAgICAgICAgICAgICAgbXNnaWQgPSAkbWVzc2FnZS5hdHRyKCdpZCcpLAogICAgICAgICAgICAgICAgICAgIHJlc291cmNlID0gU3Ryb3BoZS5nZXRSZXNvdXJjZUZyb21KaWQoamlkKSwKICAgICAgICAgICAgICAgICAgICBzZW5kZXIgPSByZXNvdXJjZSAmJiBTdHJvcGhlLnVuZXNjYXBlTm9kZShyZXNvdXJjZSkgfHwgJycsCiAgICAgICAgICAgICAgICAgICAgZGVsYXllZCA9ICRtZXNzYWdlLmZpbmQoJ2RlbGF5JykubGVuZ3RoID4gMCwKICAgICAgICAgICAgICAgICAgICBzdWJqZWN0ID0gJG1lc3NhZ2UuY2hpbGRyZW4oJ3N1YmplY3QnKS50ZXh0KCk7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMubW9kZWwubWVzc2FnZXMuZmluZFdoZXJlKHttc2dpZDogbXNnaWR9KSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBXZSBhbHJlYWR5IGhhdmUgdGhpcyBtZXNzYWdlIHN0b3JlZC4KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuc2hvd1N0YXR1c01lc3NhZ2VzKCRtZXNzYWdlKTsKICAgICAgICAgICAgICAgIGlmIChzdWJqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgnLmNoYXRyb29tLXRvcGljJykudGV4dChzdWJqZWN0KS5hdHRyKCd0aXRsZScsIHN1YmplY3QpOwogICAgICAgICAgICAgICAgICAgIC8vICMgRm9yIHRyYW5zbGF0b3JzOiB0aGUgJTEkcyBhbmQgJTIkcyBwYXJ0cyB3aWxsIGdldCByZXBsYWNlZCBieSB0aGUgdXNlciBhbmQgdG9waWMgdGV4dCByZXNwZWN0aXZlbHkKICAgICAgICAgICAgICAgICAgICAvLyAjIEV4YW1wbGU6IFRvcGljIHNldCBieSBKQyBCcmFuZCB0bzogSGVsbG8gV29ybGQhCiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgnLmNoYXQtY29udGVudCcpLmFwcGVuZCgKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UudGVtcGxhdGVzLmluZm8oewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiBfXygnVG9waWMgc2V0IGJ5ICUxJHMgdG86ICUyJHMnLCBzZW5kZXIsIHN1YmplY3QpCiAgICAgICAgICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChzZW5kZXIgPT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLmNyZWF0ZU1lc3NhZ2UoJG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgaWYgKCFkZWxheWVkICYmIHNlbmRlciAhPT0gdGhpcy5tb2RlbC5nZXQoJ25pY2snKSAmJiAobmV3IFJlZ0V4cCgiXFxiIit0aGlzLm1vZGVsLmdldCgnbmljaycpKyJcXGIiKSkudGVzdChib2R5KSkgewogICAgICAgICAgICAgICAgICAgIHBsYXlOb3RpZmljYXRpb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChzZW5kZXIgIT09IHRoaXMubW9kZWwuZ2V0KCduaWNrJykpIHsKICAgICAgICAgICAgICAgICAgICAvLyBXZSBvbmx5IGVtaXQgYW4gZXZlbnQgaWYgaXQncyBub3Qgb3VyIG93biBtZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuZW1pdCgnbWVzc2FnZScsIG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBvbkNoYXRSb29tUm9zdGVyOiBmdW5jdGlvbiAocm9zdGVyLCByb29tKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5vY2N1cGFudHN2aWV3Lm9uQ2hhdFJvb21Sb3N0ZXIocm9zdGVyLCByb29tKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLkNoYXRCb3hlcyA9IEJhY2tib25lLkNvbGxlY3Rpb24uZXh0ZW5kKHsKICAgICAgICAgICAgbW9kZWw6IGNvbnZlcnNlLkNoYXRCb3gsCiAgICAgICAgICAgIGNvbXBhcmF0b3I6ICd0aW1lX29wZW5lZCcsCgogICAgICAgICAgICByZWdpc3Rlck1lc3NhZ2VIYW5kbGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLmFkZEhhbmRsZXIoCiAgICAgICAgICAgICAgICAgICAgJC5wcm94eShmdW5jdGlvbiAobWVzc2FnZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uTWVzc2FnZShtZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSwgdGhpcyksIG51bGwsICdtZXNzYWdlJywgJ2NoYXQnKTsKCiAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLmFkZEhhbmRsZXIoCiAgICAgICAgICAgICAgICAgICAgJC5wcm94eShmdW5jdGlvbiAobWVzc2FnZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uSW52aXRlKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9LCB0aGlzKSwgJ2phYmJlcjp4OmNvbmZlcmVuY2UnLCAnbWVzc2FnZScpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25Db25uZWN0ZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMuYnJvd3NlclN0b3JhZ2UgPSBuZXcgQmFja2JvbmUuQnJvd3NlclN0b3JhZ2VbY29udmVyc2Uuc3RvcmFnZV0oCiAgICAgICAgICAgICAgICAgICAgYjY0X3NoYTEoJ2NvbnZlcnNlLmNoYXRib3hlcy0nK2NvbnZlcnNlLmJhcmVfamlkKSk7CiAgICAgICAgICAgICAgICB0aGlzLnJlZ2lzdGVyTWVzc2FnZUhhbmRsZXIoKTsKICAgICAgICAgICAgICAgIHRoaXMuZmV0Y2goewogICAgICAgICAgICAgICAgICAgIGFkZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiAkLnByb3h5KGZ1bmN0aW9uIChjb2xsZWN0aW9uLCByZXNwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghXy5pbmNsdWRlKF8ucGx1Y2socmVzcCwgJ2lkJyksICdjb250cm9sYm94JykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogJ2NvbnRyb2xib3gnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJveF9pZDogJ2NvbnRyb2xib3gnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdldCgnY29udHJvbGJveCcpLnNhdmUoe2Nvbm5lY3RlZDp0cnVlfSk7CiAgICAgICAgICAgICAgICAgICAgfSwgdGhpcykKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaXNPbmx5Q2hhdFN0YXRlTm90aWZpY2F0aW9uOiBmdW5jdGlvbiAoJG1zZykgewogICAgICAgICAgICAgICAgLy8gU2VlIFhFUC0wMDg1IENoYXQgU3RhdGUgTm90aWZpY2F0aW9uCiAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgICRtc2cuZmluZCgnYm9keScpLmxlbmd0aCA9PT0gMCAmJiAoCiAgICAgICAgICAgICAgICAgICAgICAgICRtc2cuZmluZChBQ1RJVkUpLmxlbmd0aCAhPT0gMCB8fAogICAgICAgICAgICAgICAgICAgICAgICAkbXNnLmZpbmQoQ09NUE9TSU5HKS5sZW5ndGggIT09IDAgfHwKICAgICAgICAgICAgICAgICAgICAgICAgJG1zZy5maW5kKElOQUNUSVZFKS5sZW5ndGggIT09IDAgfHwKICAgICAgICAgICAgICAgICAgICAgICAgJG1zZy5maW5kKFBBVVNFRCkubGVuZ3RoICE9PSAwIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICRtc2cuZmluZChHT05FKS5sZW5ndGggIT09IDAKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25JbnZpdGU6IGZ1bmN0aW9uIChtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICB2YXIgJG1lc3NhZ2UgPSAkKG1lc3NhZ2UpLAogICAgICAgICAgICAgICAgICAgICR4ID0gJG1lc3NhZ2UuY2hpbGRyZW4oJ3hbeG1sbnM9ImphYmJlcjp4OmNvbmZlcmVuY2UiXScpLAogICAgICAgICAgICAgICAgICAgIGZyb20gPSBTdHJvcGhlLmdldEJhcmVKaWRGcm9tSmlkKCRtZXNzYWdlLmF0dHIoJ2Zyb20nKSksCiAgICAgICAgICAgICAgICAgICAgcm9vbV9qaWQgPSAkeC5hdHRyKCdqaWQnKSwKICAgICAgICAgICAgICAgICAgICByZWFzb24gPSAkeC5hdHRyKCdyZWFzb24nKSwKICAgICAgICAgICAgICAgICAgICBjb250YWN0ID0gY29udmVyc2Uucm9zdGVyLmdldChmcm9tKSwKICAgICAgICAgICAgICAgICAgICByZXN1bHQ7CgogICAgICAgICAgICAgICAgaWYgKCFyZWFzb24pIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBjb25maXJtKAogICAgICAgICAgICAgICAgICAgICAgICBfXyhfX18oIiUxJHMgaGFzIGludml0ZWQgeW91IHRvIGpvaW4gYSBjaGF0IHJvb206ICUyJHMiKSwgY29udGFjdC5nZXQoJ2Z1bGxuYW1lJyksIHJvb21famlkKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGNvbmZpcm0oCiAgICAgICAgICAgICAgICAgICAgICAgICBfXyhfX18oJyUxJHMgaGFzIGludml0ZWQgeW91IHRvIGpvaW4gYSBjaGF0IHJvb206ICUyJHMsIGFuZCBsZWZ0IHRoZSBmb2xsb3dpbmcgcmVhc29uOiAiJTMkcyInKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWN0LmdldCgnZnVsbG5hbWUnKSwgcm9vbV9qaWQsIHJlYXNvbikKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBjaGF0cm9vbSA9IGNvbnZlcnNlLmNoYXRib3h2aWV3cy5zaG93Q2hhdCh7CiAgICAgICAgICAgICAgICAgICAgICAgICdpZCc6IHJvb21famlkLAogICAgICAgICAgICAgICAgICAgICAgICAnamlkJzogcm9vbV9qaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICduYW1lJzogU3Ryb3BoZS51bmVzY2FwZU5vZGUoU3Ryb3BoZS5nZXROb2RlRnJvbUppZChyb29tX2ppZCkpLAogICAgICAgICAgICAgICAgICAgICAgICAnbmljayc6IFN0cm9waGUudW5lc2NhcGVOb2RlKFN0cm9waGUuZ2V0Tm9kZUZyb21KaWQoY29udmVyc2UuY29ubmVjdGlvbi5qaWQpKSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2NoYXRyb29tJzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2JveF9pZCcgOiBiNjRfc2hhMShyb29tX2ppZCksCiAgICAgICAgICAgICAgICAgICAgICAgICdwYXNzd29yZCc6ICR4LmF0dHIoJ3Bhc3N3b3JkJykKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBpZiAoIWNoYXRyb29tLmdldCgnY29ubmVjdGVkJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY2hhdGJveHZpZXdzLmdldChyb29tX2ppZCkuY29ubmVjdChudWxsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBvbk1lc3NhZ2U6IGZ1bmN0aW9uIChtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICB2YXIgJG1lc3NhZ2UgPSAkKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgdmFyIGJ1ZGR5X2ppZCwgJGZvcndhcmRlZCwgJHJlY2VpdmVkLAogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2VfZnJvbSA9ICRtZXNzYWdlLmF0dHIoJ2Zyb20nKTsKICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlX2Zyb20gPT09IGNvbnZlcnNlLmNvbm5lY3Rpb24uamlkKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRklYTUU6IEZvcndhcmRlZCBtZXNzYWdlcyBzaG91bGQgYmUgc2VudCB0byBzcGVjaWZpYyByZXNvdXJjZXMsCiAgICAgICAgICAgICAgICAgICAgLy8gbm90IGJyb2FkY2FzdGVkCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkZm9yd2FyZGVkID0gJG1lc3NhZ2UuY2hpbGRyZW4oJ2ZvcndhcmRlZCcpOwogICAgICAgICAgICAgICAgJHJlY2VpdmVkID0gJG1lc3NhZ2UuY2hpbGRyZW4oJ3JlY2VpdmVkW3htbG5zPSJ1cm46eG1wcDpjYXJib25zOjIiXScpOwogICAgICAgICAgICAgICAgaWYgKCRmb3J3YXJkZWQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgJG1lc3NhZ2UgPSAkZm9yd2FyZGVkLmNoaWxkcmVuKCdtZXNzYWdlJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCRyZWNlaXZlZC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAkbWVzc2FnZSA9ICRyZWNlaXZlZC5jaGlsZHJlbignZm9yd2FyZGVkJykuY2hpbGRyZW4oJ21lc3NhZ2UnKTsKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlX2Zyb20gPSAkbWVzc2FnZS5hdHRyKCdmcm9tJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgZnJvbSA9IFN0cm9waGUuZ2V0QmFyZUppZEZyb21KaWQobWVzc2FnZV9mcm9tKSwKICAgICAgICAgICAgICAgICAgICB0byA9IFN0cm9waGUuZ2V0QmFyZUppZEZyb21KaWQoJG1lc3NhZ2UuYXR0cigndG8nKSksCiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2UsIGNoYXRib3gsIHJvc3Rlcl9pdGVtOwogICAgICAgICAgICAgICAgaWYgKGZyb20gPT0gY29udmVyc2UuYmFyZV9qaWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBJIGFtIHRoZSBzZW5kZXIsIHNvIHRoaXMgbXVzdCBiZSBhIGZvcndhcmRlZCBtZXNzYWdlLi4uCiAgICAgICAgICAgICAgICAgICAgYnVkZHlfamlkID0gdG87CiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2UgPSBTdHJvcGhlLmdldFJlc291cmNlRnJvbUppZCgkbWVzc2FnZS5hdHRyKCd0bycpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYnVkZHlfamlkID0gZnJvbTsKICAgICAgICAgICAgICAgICAgICByZXNvdXJjZSA9IFN0cm9waGUuZ2V0UmVzb3VyY2VGcm9tSmlkKG1lc3NhZ2VfZnJvbSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjaGF0Ym94ID0gdGhpcy5nZXQoYnVkZHlfamlkKTsKICAgICAgICAgICAgICAgIHJvc3Rlcl9pdGVtID0gY29udmVyc2Uucm9zdGVyLmdldChidWRkeV9qaWQpOwoKICAgICAgICAgICAgICAgIGlmIChyb3N0ZXJfaXRlbSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIGJ1ZGR5IHdhcyBsaWtlbHkgcmVtb3ZlZAogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmxvZygnQ291bGQgbm90IGdldCByb3N0ZXIgaXRlbSBmb3IgSklEICcrYnVkZHlfamlkLCAnZXJyb3InKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIWNoYXRib3gpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZnVsbG5hbWUgPSByb3N0ZXJfaXRlbS5nZXQoJ2Z1bGxuYW1lJyk7CiAgICAgICAgICAgICAgICAgICAgZnVsbG5hbWUgPSBfLmlzRW1wdHkoZnVsbG5hbWUpPyBidWRkeV9qaWQ6IGZ1bGxuYW1lOwogICAgICAgICAgICAgICAgICAgIGNoYXRib3ggPSB0aGlzLmNyZWF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICdpZCc6IGJ1ZGR5X2ppZCwKICAgICAgICAgICAgICAgICAgICAgICAgJ2ppZCc6IGJ1ZGR5X2ppZCwKICAgICAgICAgICAgICAgICAgICAgICAgJ2Z1bGxuYW1lJzogZnVsbG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICdpbWFnZV90eXBlJzogcm9zdGVyX2l0ZW0uZ2V0KCdpbWFnZV90eXBlJyksCiAgICAgICAgICAgICAgICAgICAgICAgICdpbWFnZSc6IHJvc3Rlcl9pdGVtLmdldCgnaW1hZ2UnKSwKICAgICAgICAgICAgICAgICAgICAgICAgJ3VybCc6IHJvc3Rlcl9pdGVtLmdldCgndXJsJykKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc09ubHlDaGF0U3RhdGVOb3RpZmljYXRpb24oJG1lc3NhZ2UpICYmIGZyb20gIT09IGNvbnZlcnNlLmJhcmVfamlkKSB7CiAgICAgICAgICAgICAgICAgICAgcGxheU5vdGlmaWNhdGlvbigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2hhdGJveC5yZWNlaXZlTWVzc2FnZSgkbWVzc2FnZSk7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5yb3N0ZXIuYWRkUmVzb3VyY2UoYnVkZHlfamlkLCByZXNvdXJjZSk7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5lbWl0KCdtZXNzYWdlJywgbWVzc2FnZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLkNoYXRCb3hWaWV3cyA9IEJhY2tib25lLk92ZXJ2aWV3LmV4dGVuZCh7CgogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCJhZGQiLCB0aGlzLm9uQ2hhdEJveEFkZGVkLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oImNoYW5nZTptaW5pbWl6ZWQiLCBmdW5jdGlvbiAoaXRlbSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmdldCgnbWluaW1pemVkJykgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaW1DaGF0cyh0aGlzLmdldChpdGVtLmdldCgnaWQnKSkpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaW1DaGF0cygpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIC8qIE92ZXJyaWRlIG1ldGhvZCBmcm9tIGJhY2tib25lLmpzCiAgICAgICAgICAgICAgICAgKiBJZiB0aGUgI2NvbnZlcnNlanMgZWxlbWVudCBkb2Vzbid0IGV4aXN0LCBjcmVhdGUgaXQuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGlmICghdGhpcy5lbCkgewogICAgICAgICAgICAgICAgICAgIHZhciAkZWwgPSAkKCcjY29udmVyc2VqcycpOwogICAgICAgICAgICAgICAgICAgIGlmICghJGVsLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAkZWwgPSAkKCc8ZGl2IGlkPSJjb252ZXJzZWpzIj4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgJCgnYm9keScpLmFwcGVuZCgkZWwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAkZWwuaHRtbChjb252ZXJzZS50ZW1wbGF0ZXMuY2hhdHNfcGFuZWwoKSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRFbGVtZW50KCRlbCwgZmFsc2UpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEVsZW1lbnQoXy5yZXN1bHQodGhpcywgJ2VsJyksIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG9uQ2hhdEJveEFkZGVkOiBmdW5jdGlvbiAoaXRlbSkgewogICAgICAgICAgICAgICAgdmFyIHZpZXcgPSB0aGlzLmdldChpdGVtLmdldCgnaWQnKSk7CiAgICAgICAgICAgICAgICBpZiAoIXZpZXcpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5nZXQoJ2NoYXRyb29tJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmlldyA9IG5ldyBjb252ZXJzZS5DaGF0Um9vbVZpZXcoeydtb2RlbCc6IGl0ZW19KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGl0ZW0uZ2V0KCdib3hfaWQnKSA9PT0gJ2NvbnRyb2xib3gnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZpZXcgPSBuZXcgY29udmVyc2UuQ29udHJvbEJveFZpZXcoe21vZGVsOiBpdGVtfSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmlldyA9IG5ldyBjb252ZXJzZS5DaGF0Qm94Vmlldyh7bW9kZWw6IGl0ZW19KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGQoaXRlbS5nZXQoJ2lkJyksIHZpZXcpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgdmlldy5tb2RlbDsgLy8gUmVtb3ZlIHJlZiB0byBvbGQgbW9kZWwgdG8gaGVscCBnYXJiYWdlIGNvbGxlY3Rpb24KICAgICAgICAgICAgICAgICAgICB2aWV3Lm1vZGVsID0gaXRlbTsKICAgICAgICAgICAgICAgICAgICB2aWV3LmluaXRpYWxpemUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMudHJpbUNoYXRzKHZpZXcpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgdHJpbUNoYXRzOiBmdW5jdGlvbiAobmV3Y2hhdCkgewogICAgICAgICAgICAgICAgLyogVGhpcyBtZXRob2QgaXMgY2FsbGVkIHdoZW4gYSBuZXdseSBjcmVhdGVkIGNoYXQgYm94IHdpbGwKICAgICAgICAgICAgICAgICAqIGJlIHNob3duLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEl0IGNoZWNrcyB3aGV0aGVyIHRoZXJlIGlzIGVub3VnaCBzcGFjZSBvbiB0aGUgcGFnZSB0byBzaG93CiAgICAgICAgICAgICAgICAgKiBhbm90aGVyIGNoYXQgYm94LiBPdGhlcndpc2UgaXQgbWluaW1pemUgdGhlIG9sZGVzdCBjaGF0IGJveAogICAgICAgICAgICAgICAgICogdG8gY3JlYXRlIHNwYWNlLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBpZiAoY29udmVyc2Uubm9fdHJpbW1pbmcgfHwgKHRoaXMubW9kZWwubGVuZ3RoIDw9IDEpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG9sZGVzdF9jaGF0LAogICAgICAgICAgICAgICAgICAgIGNvbnRyb2xib3hfd2lkdGggPSAwLAogICAgICAgICAgICAgICAgICAgICRtaW5pbWl6ZWQgPSBjb252ZXJzZS5taW5pbWl6ZWRfY2hhdHMuJGVsLAogICAgICAgICAgICAgICAgICAgIG1pbmltaXplZF93aWR0aCA9IF8uY29udGFpbnModGhpcy5tb2RlbC5wbHVjaygnbWluaW1pemVkJyksIHRydWUpID8gJG1pbmltaXplZC5vdXRlcldpZHRoKHRydWUpIDogMCwKICAgICAgICAgICAgICAgICAgICBib3hlc193aWR0aCA9IG5ld2NoYXQgPyBuZXdjaGF0LiRlbC5vdXRlcldpZHRoKHRydWUpIDogMCwKICAgICAgICAgICAgICAgICAgICBuZXdfaWQgPSBuZXdjaGF0ID8gbmV3Y2hhdC5tb2RlbC5nZXQoJ2lkJykgOiBudWxsLAogICAgICAgICAgICAgICAgICAgIGNvbnRyb2xib3ggPSB0aGlzLmdldCgnY29udHJvbGJveCcpOwoKICAgICAgICAgICAgICAgIGlmICghY29udHJvbGJveCB8fCAhY29udHJvbGJveC4kZWwuaXMoJzp2aXNpYmxlJykpIHsKICAgICAgICAgICAgICAgICAgICBjb250cm9sYm94X3dpZHRoID0gY29udmVyc2UuY29udHJvbGJveHRvZ2dsZS4kZWwub3V0ZXJXaWR0aCh0cnVlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29udHJvbGJveF93aWR0aCA9IGNvbnRyb2xib3guJGVsLm91dGVyV2lkdGgodHJ1ZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgXy5lYWNoKHRoaXMuZ2V0QWxsKCksIGZ1bmN0aW9uICh2aWV3KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGlkID0gdmlldy5tb2RlbC5nZXQoJ2lkJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKChpZCAhPT0gJ2NvbnRyb2xib3gnKSAmJiAoaWQgIT09IG5ld19pZCkgJiYgKCF2aWV3Lm1vZGVsLmdldCgnbWluaW1pemVkJykpICYmIHZpZXcuJGVsLmlzKCc6dmlzaWJsZScpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJveGVzX3dpZHRoICs9IHZpZXcuJGVsLm91dGVyV2lkdGgodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgaWYgKChtaW5pbWl6ZWRfd2lkdGggKyBib3hlc193aWR0aCArIGNvbnRyb2xib3hfd2lkdGgpID4gdGhpcy4kZWwub3V0ZXJXaWR0aCh0cnVlKSkgewogICAgICAgICAgICAgICAgICAgIG9sZGVzdF9jaGF0ID0gdGhpcy5nZXRPbGRlc3RNYXhpbWl6ZWRDaGF0KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9sZGVzdF9jaGF0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9sZGVzdF9jaGF0Lm1pbmltaXplKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgZ2V0T2xkZXN0TWF4aW1pemVkQ2hhdDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgLy8gR2V0IG9sZGVzdCB2aWV3ICh3aGljaCBpcyBub3QgY29udHJvbGJveCkKICAgICAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgICAgIHZhciBtb2RlbCA9IHRoaXMubW9kZWwuc29ydCgpLmF0KGkpOwogICAgICAgICAgICAgICAgd2hpbGUgKG1vZGVsLmdldCgnaWQnKSA9PT0gJ2NvbnRyb2xib3gnIHx8IG1vZGVsLmdldCgnbWluaW1pemVkJykgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBpKys7CiAgICAgICAgICAgICAgICAgICAgbW9kZWwgPSB0aGlzLm1vZGVsLmF0KGkpOwogICAgICAgICAgICAgICAgICAgIGlmICghbW9kZWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG1vZGVsOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgY2xvc2VBbGxDaGF0Qm94ZXM6IGZ1bmN0aW9uIChpbmNsdWRlX2NvbnRyb2xib3gpIHsKICAgICAgICAgICAgICAgIHZhciBpLCBjaGF0Ym94OwogICAgICAgICAgICAgICAgLy8gVE9ETzogb25jZSBCYWNrYm9uZS5PdmVydmlldyBoYXMgYmVlbiByZWZhY3RvcmVkLCB3ZSBzaG91bGQKICAgICAgICAgICAgICAgIC8vIGJlIGFibGUgdG8gY2FsbCAuZWFjaCBvbiB0aGUgdmlld3MgdGhlbXNlbHZlcy4KICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuZWFjaCgkLnByb3h5KGZ1bmN0aW9uIChtb2RlbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBpZCA9IG1vZGVsLmdldCgnaWQnKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZV9jb250cm9sYm94IHx8IGlkICE9PSAnY29udHJvbGJveCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXQoaWQpLmNsb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzaG93Q2hhdDogZnVuY3Rpb24gKGF0dHJzKSB7CiAgICAgICAgICAgICAgICAvKiBGaW5kIHRoZSBjaGF0IGJveCBhbmQgc2hvdyBpdC4KICAgICAgICAgICAgICAgICAqIElmIGl0IGRvZXNuJ3QgZXhpc3QsIGNyZWF0ZSBpdC4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgdmFyIGNoYXRib3ggID0gdGhpcy5tb2RlbC5nZXQoYXR0cnMuamlkKTsKICAgICAgICAgICAgICAgIGlmICghY2hhdGJveCkgewogICAgICAgICAgICAgICAgICAgIGNoYXRib3ggPSB0aGlzLm1vZGVsLmNyZWF0ZShhdHRycywgewogICAgICAgICAgICAgICAgICAgICAgICAnZXJyb3InOiBmdW5jdGlvbiAobW9kZWwsIHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5sb2cocmVzcG9uc2UucmVzcG9uc2VUZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGNoYXRib3guZ2V0KCdtaW5pbWl6ZWQnKSkgewogICAgICAgICAgICAgICAgICAgIGNoYXRib3gubWF4aW1pemUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY2hhdGJveC50cmlnZ2VyKCdzaG93Jyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gY2hhdGJveDsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLk1pbmltaXplZENoYXRCb3hWaWV3ID0gQmFja2JvbmUuVmlldy5leHRlbmQoewogICAgICAgICAgICB0YWdOYW1lOiAnZGl2JywKICAgICAgICAgICAgY2xhc3NOYW1lOiAnY2hhdC1oZWFkJywKCiAgICAgICAgICAgIGV2ZW50czogewogICAgICAgICAgICAgICAgJ2NsaWNrIC5jbG9zZS1jaGF0Ym94LWJ1dHRvbic6ICdjbG9zZScsCiAgICAgICAgICAgICAgICAnY2xpY2sgLnJlc3RvcmUtY2hhdCc6ICdyZXN0b3JlJwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5tZXNzYWdlcy5vbignYWRkJywgZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIShtLmdldCgnY29tcG9zaW5nJykgfHwgbS5nZXQoJ3BhdXNlZCcpKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVVucmVhZE1lc3NhZ2VzQ291bnRlcigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbignY2hhbmdlOm1pbmltaXplZCcsIHRoaXMuY2xlYXJVbnJlYWRNZXNzYWdlc0NvdW50ZXIsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbignc2hvd1JlY2VpdmVkT1RSTWVzc2FnZScsIHRoaXMudXBkYXRlVW5yZWFkTWVzc2FnZXNDb3VudGVyLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oJ3Nob3dTZW50T1RSTWVzc2FnZScsIHRoaXMudXBkYXRlVW5yZWFkTWVzc2FnZXNDb3VudGVyLCB0aGlzKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGRhdGEgPSBfLmV4dGVuZCgKICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLnRvSlNPTigpLAogICAgICAgICAgICAgICAgICAgIHsgJ3Rvb2x0aXAnOiBfXygnQ2xpY2sgdG8gcmVzdG9yZSB0aGlzIGNoYXQnKSB9CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubW9kZWwuZ2V0KCdjaGF0cm9vbScpKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YS50aXRsZSA9IHRoaXMubW9kZWwuZ2V0KCduYW1lJyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuYWRkQ2xhc3MoJ2NoYXQtaGVhZC1jaGF0cm9vbScpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBkYXRhLnRpdGxlID0gdGhpcy5tb2RlbC5nZXQoJ2Z1bGxuYW1lJyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuYWRkQ2xhc3MoJ2NoYXQtaGVhZC1jaGF0Ym94Jyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kZWwuaHRtbChjb252ZXJzZS50ZW1wbGF0ZXMudHJpbW1lZF9jaGF0KGRhdGEpKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGNsZWFyVW5yZWFkTWVzc2FnZXNDb3VudGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLnNldCh7J251bV91bnJlYWQnOiAwfSk7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcigpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgdXBkYXRlVW5yZWFkTWVzc2FnZXNDb3VudGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLnNldCh7J251bV91bnJlYWQnOiB0aGlzLm1vZGVsLmdldCgnbnVtX3VucmVhZCcpICsgMX0pOwogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGNsb3NlOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGlmIChldiAmJiBldi5wcmV2ZW50RGVmYXVsdCkgeyBldi5wcmV2ZW50RGVmYXVsdCgpOyB9CiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5lbWl0KCdjaGF0Qm94Q2xvc2VkJywgdGhpcyk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlc3RvcmU6IF8uZGVib3VuY2UoZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBpZiAoZXYgJiYgZXYucHJldmVudERlZmF1bHQpIHsKICAgICAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5yZW1vdmUoKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwubWF4aW1pemUoKTsKICAgICAgICAgICAgfSwgMjAwKQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLk1pbmltaXplZENoYXRzID0gQmFja2JvbmUuT3ZlcnZpZXcuZXh0ZW5kKHsKICAgICAgICAgICAgZWw6ICIjbWluaW1pemVkLWNoYXRzIiwKCiAgICAgICAgICAgIGV2ZW50czogewogICAgICAgICAgICAgICAgImNsaWNrICN0b2dnbGUtbWluaW1pemVkLWNoYXRzIjogInRvZ2dsZSIKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5pdFRvZ2dsZSgpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbigiYWRkIiwgdGhpcy5vbkNoYW5nZWQsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbigiZGVzdHJveSIsIHRoaXMucmVtb3ZlQ2hhdCwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCJjaGFuZ2U6bWluaW1pemVkIiwgdGhpcy5vbkNoYW5nZWQsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbignY2hhbmdlOm51bV91bnJlYWQnLCB0aGlzLnVwZGF0ZVVucmVhZE1lc3NhZ2VzQ291bnRlciwgdGhpcyk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB0ZWFyRG93bjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vZmYoImFkZCIsIHRoaXMub25DaGFuZ2VkKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub2ZmKCJkZXN0cm95IiwgdGhpcy5yZW1vdmVDaGF0KTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub2ZmKCJjaGFuZ2U6bWluaW1pemVkIiwgdGhpcy5vbkNoYW5nZWQpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vZmYoJ2NoYW5nZTpudW1fdW5yZWFkJywgdGhpcy51cGRhdGVVbnJlYWRNZXNzYWdlc0NvdW50ZXIpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpbml0VG9nZ2xlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRvZ2dsZXZpZXcgPSBuZXcgY29udmVyc2UuTWluaW1pemVkQ2hhdHNUb2dnbGVWaWV3KHsKICAgICAgICAgICAgICAgICAgICBtb2RlbDogbmV3IGNvbnZlcnNlLk1pbmltaXplZENoYXRzVG9nZ2xlKCkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdmFyIGlkID0gYjY0X3NoYTEoJ2NvbnZlcnNlLm1pbmNoYXRzdG9nZ2xlJytjb252ZXJzZS5iYXJlX2ppZCk7CiAgICAgICAgICAgICAgICB0aGlzLnRvZ2dsZXZpZXcubW9kZWwuaWQgPSBpZDsgLy8gQXBwZWFycyB0byBiZSBuZWNlc3NhcnkgZm9yIGJhY2tib25lLmJyb3dzZXJTdG9yYWdlCiAgICAgICAgICAgICAgICB0aGlzLnRvZ2dsZXZpZXcubW9kZWwuYnJvd3NlclN0b3JhZ2UgPSBuZXcgQmFja2JvbmUuQnJvd3NlclN0b3JhZ2VbY29udmVyc2Uuc3RvcmFnZV0oaWQpOwogICAgICAgICAgICAgICAgdGhpcy50b2dnbGV2aWV3Lm1vZGVsLmZldGNoKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmtleXMoKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5oaWRlKCdmYXN0Jyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMua2V5cygpLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLnNob3coJ2Zhc3QnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiRlbDsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHRvZ2dsZTogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBpZiAoZXYgJiYgZXYucHJldmVudERlZmF1bHQpIHsgZXYucHJldmVudERlZmF1bHQoKTsgfQogICAgICAgICAgICAgICAgdGhpcy50b2dnbGV2aWV3Lm1vZGVsLnNhdmUoeydjb2xsYXBzZWQnOiAhdGhpcy50b2dnbGV2aWV3Lm1vZGVsLmdldCgnY29sbGFwc2VkJyl9KTsKICAgICAgICAgICAgICAgIHRoaXMuJCgnLm1pbmltaXplZC1jaGF0cy1mbHlvdXQnKS50b2dnbGUoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG9uQ2hhbmdlZDogZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICAgICAgICAgIGlmIChpdGVtLmdldCgnaWQnKSAhPT0gJ2NvbnRyb2xib3gnICYmIGl0ZW0uZ2V0KCdtaW5pbWl6ZWQnKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkQ2hhdChpdGVtKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5nZXQoaXRlbS5nZXQoJ2lkJykpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVDaGF0KGl0ZW0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgYWRkQ2hhdDogZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHRoaXMuZ2V0KGl0ZW0uZ2V0KCdpZCcpKTsKICAgICAgICAgICAgICAgIGlmIChleGlzdGluZyAmJiBleGlzdGluZy4kZWwucGFyZW50KCkubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHZpZXcgPSBuZXcgY29udmVyc2UuTWluaW1pemVkQ2hhdEJveFZpZXcoe21vZGVsOiBpdGVtfSk7CiAgICAgICAgICAgICAgICB0aGlzLiQoJy5taW5pbWl6ZWQtY2hhdHMtZmx5b3V0JykuYXBwZW5kKHZpZXcucmVuZGVyKCkpOwogICAgICAgICAgICAgICAgdGhpcy5hZGQoaXRlbS5nZXQoJ2lkJyksIHZpZXcpOwogICAgICAgICAgICAgICAgdGhpcy50b2dnbGV2aWV3Lm1vZGVsLnNldCh7J251bV9taW5pbWl6ZWQnOiB0aGlzLmtleXMoKS5sZW5ndGh9KTsKICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZW1vdmVDaGF0OiBmdW5jdGlvbiAoaXRlbSkgewogICAgICAgICAgICAgICAgdGhpcy5yZW1vdmUoaXRlbS5nZXQoJ2lkJykpOwogICAgICAgICAgICAgICAgdGhpcy50b2dnbGV2aWV3Lm1vZGVsLnNldCh7J251bV9taW5pbWl6ZWQnOiB0aGlzLmtleXMoKS5sZW5ndGh9KTsKICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB1cGRhdGVVbnJlYWRNZXNzYWdlc0NvdW50ZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBscyA9IHRoaXMubW9kZWwucGx1Y2soJ251bV91bnJlYWQnKSwKICAgICAgICAgICAgICAgICAgICBjb3VudCA9IDAsIGk7CiAgICAgICAgICAgICAgICBmb3IgKGk9MDsgaTxscy5sZW5ndGg7IGkrKykgeyBjb3VudCArPSBsc1tpXTsgfQogICAgICAgICAgICAgICAgdGhpcy50b2dnbGV2aWV3Lm1vZGVsLnNldCh7J251bV91bnJlYWQnOiBjb3VudH0pOwogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIoKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLk1pbmltaXplZENoYXRzVG9nZ2xlID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kKHsKICAgICAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy5zZXQoewogICAgICAgICAgICAgICAgICAgICdjb2xsYXBzZWQnOiB0aGlzLmdldCgnY29sbGFwc2VkJykgfHwgZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgJ251bV9taW5pbWl6ZWQnOiB0aGlzLmdldCgnbnVtX21pbmltaXplZCcpIHx8IDAsCiAgICAgICAgICAgICAgICAgICAgJ251bV91bnJlYWQnOiAgdGhpcy5nZXQoJ251bV91bnJlYWQnKSB8fCAwCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLk1pbmltaXplZENoYXRzVG9nZ2xlVmlldyA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKICAgICAgICAgICAgZWw6ICcjdG9nZ2xlLW1pbmltaXplZC1jaGF0cycsCgogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCdjaGFuZ2U6bnVtX21pbmltaXplZCcsIHRoaXMucmVuZGVyLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oJ2NoYW5nZTpudW1fdW5yZWFkJywgdGhpcy5yZW5kZXIsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy4kZmx5b3V0ID0gdGhpcy4kZWwuc2libGluZ3MoJy5taW5pbWl6ZWQtY2hhdHMtZmx5b3V0Jyk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmh0bWwoY29udmVyc2UudGVtcGxhdGVzLnRvZ2dsZV9jaGF0cygKICAgICAgICAgICAgICAgICAgICBfLmV4dGVuZCh0aGlzLm1vZGVsLnRvSlNPTigpLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICdNaW5pbWl6ZWQnOiBfXygnTWluaW1pemVkJykKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgKSk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5tb2RlbC5nZXQoJ2NvbGxhcHNlZCcpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZmx5b3V0LmhpZGUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZmx5b3V0LnNob3coKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiRlbDsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLlJvc3RlckNvbnRhY3QgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQoewogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoYXR0cmlidXRlcywgb3B0aW9ucykgewogICAgICAgICAgICAgICAgdmFyIGppZCA9IGF0dHJpYnV0ZXMuamlkOwogICAgICAgICAgICAgICAgdmFyIGF0dHJzID0gXy5leHRlbmQoewogICAgICAgICAgICAgICAgICAgICdpZCc6IGppZCwKICAgICAgICAgICAgICAgICAgICAnZnVsbG5hbWUnOiBqaWQsCiAgICAgICAgICAgICAgICAgICAgJ2NoYXRfc3RhdHVzJzogJ29mZmxpbmUnLAogICAgICAgICAgICAgICAgICAgICd1c2VyX2lkJzogU3Ryb3BoZS5nZXROb2RlRnJvbUppZChqaWQpLAogICAgICAgICAgICAgICAgICAgICdyZXNvdXJjZXMnOiBbXSwKICAgICAgICAgICAgICAgICAgICAnZ3JvdXBzJzogW10sCiAgICAgICAgICAgICAgICAgICAgJ3N0YXR1cyc6ICcnCiAgICAgICAgICAgICAgICB9LCBhdHRyaWJ1dGVzKTsKICAgICAgICAgICAgICAgIHRoaXMuc2V0KGF0dHJzKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHNob3dJblJvc3RlcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuICghY29udmVyc2Uuc2hvd19vbmx5X29ubGluZV91c2VycyB8fCB0aGlzLmdldCgnY2hhdF9zdGF0dXMnKSA9PT0gJ29ubGluZScpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuUm9zdGVyQ29udGFjdFZpZXcgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZCh7CiAgICAgICAgICAgIHRhZ05hbWU6ICdkZCcsCgogICAgICAgICAgICBldmVudHM6IHsKICAgICAgICAgICAgICAgICJjbGljayAuYWNjZXB0LXhtcHAtcmVxdWVzdCI6ICJhY2NlcHRSZXF1ZXN0IiwKICAgICAgICAgICAgICAgICJjbGljayAuZGVjbGluZS14bXBwLXJlcXVlc3QiOiAiZGVjbGluZVJlcXVlc3QiLAogICAgICAgICAgICAgICAgImNsaWNrIC5vcGVuLWNoYXQiOiAib3BlbkNoYXQiLAogICAgICAgICAgICAgICAgImNsaWNrIC5yZW1vdmUteG1wcC1jb250YWN0IjogInJlbW92ZUNvbnRhY3QiCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCJjaGFuZ2UiLCB0aGlzLnJlbmRlciwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCJyZW1vdmUiLCB0aGlzLnJlbW92ZSwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCJkZXN0cm95IiwgdGhpcy5yZW1vdmUsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbigib3BlbiIsIHRoaXMub3BlbkNoYXQsIHRoaXMpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb3BlbkNoYXQ6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgaWYgKGV2ICYmIGV2LnByZXZlbnREZWZhdWx0KSB7IGV2LnByZXZlbnREZWZhdWx0KCk7IH0KICAgICAgICAgICAgICAgIC8vIFhYWDogQ2FuIHRoaXMubW9kZWwuYXR0cmlidXRlcyBiZSB1c2VkIGhlcmUsIGluc3RlYWQgb2YKICAgICAgICAgICAgICAgIC8vIG1hbnVhbGx5IHNwZWNpZnlpbmcgYWxsIGF0dHJpYnV0ZXM/CiAgICAgICAgICAgICAgICByZXR1cm4gY29udmVyc2UuY2hhdGJveHZpZXdzLnNob3dDaGF0KHsKICAgICAgICAgICAgICAgICAgICAnaWQnOiB0aGlzLm1vZGVsLmdldCgnamlkJyksCiAgICAgICAgICAgICAgICAgICAgJ2ppZCc6IHRoaXMubW9kZWwuZ2V0KCdqaWQnKSwKICAgICAgICAgICAgICAgICAgICAnZnVsbG5hbWUnOiB0aGlzLm1vZGVsLmdldCgnZnVsbG5hbWUnKSwKICAgICAgICAgICAgICAgICAgICAnaW1hZ2VfdHlwZSc6IHRoaXMubW9kZWwuZ2V0KCdpbWFnZV90eXBlJyksCiAgICAgICAgICAgICAgICAgICAgJ2ltYWdlJzogdGhpcy5tb2RlbC5nZXQoJ2ltYWdlJyksCiAgICAgICAgICAgICAgICAgICAgJ3VybCc6IHRoaXMubW9kZWwuZ2V0KCd1cmwnKSwKICAgICAgICAgICAgICAgICAgICAnc3RhdHVzJzogdGhpcy5tb2RlbC5nZXQoJ3N0YXR1cycpCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlbW92ZUNvbnRhY3Q6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgaWYgKGV2ICYmIGV2LnByZXZlbnREZWZhdWx0KSB7IGV2LnByZXZlbnREZWZhdWx0KCk7IH0KICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBjb25maXJtKF9fKCJBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gcmVtb3ZlIHRoaXMgY29udGFjdD8iKSk7CiAgICAgICAgICAgICAgICBpZiAocmVzdWx0ID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGJhcmVfamlkID0gdGhpcy5tb2RlbC5nZXQoJ2ppZCcpOwogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24ucm9zdGVyLnJlbW92ZShiYXJlX2ppZCwgJC5wcm94eShmdW5jdGlvbiAoaXEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5yb3N0ZXIudW5hdXRob3JpemUoYmFyZV9qaWQpOwogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5yb3N0ZXJ2aWV3Lm1vZGVsLnJlbW92ZShiYXJlX2ppZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgIH0sIHRoaXMpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGFjY2VwdFJlcXVlc3Q6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgaWYgKGV2ICYmIGV2LnByZXZlbnREZWZhdWx0KSB7IGV2LnByZXZlbnREZWZhdWx0KCk7IH0KICAgICAgICAgICAgICAgIHZhciBqaWQgPSB0aGlzLm1vZGVsLmdldCgnamlkJyk7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLnJvc3Rlci5hdXRob3JpemUoamlkKTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24ucm9zdGVyLmFkZChqaWQsIHRoaXMubW9kZWwuZ2V0KCdmdWxsbmFtZScpLCBbXSwgZnVuY3Rpb24gKGlxKSB7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5yb3N0ZXIuc3Vic2NyaWJlKGppZCwgbnVsbCwgY29udmVyc2UueG1wcHN0YXR1cy5nZXQoJ2Z1bGxuYW1lJykpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBkZWNsaW5lUmVxdWVzdDogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBpZiAoZXYgJiYgZXYucHJldmVudERlZmF1bHQpIHsgZXYucHJldmVudERlZmF1bHQoKTsgfQogICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGNvbmZpcm0oX18oIkFyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byBkZWNsaW5lIHRoaXMgY29udGFjdCByZXF1ZXN0PyIpKTsKICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLnJvc3Rlci51bmF1dGhvcml6ZSh0aGlzLm1vZGVsLmdldCgnamlkJykpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5tb2RlbC5zaG93SW5Sb3N0ZXIoKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy4kZWxbMF0uc3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuc2hvdygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGl0ZW0gPSB0aGlzLm1vZGVsLAogICAgICAgICAgICAgICAgICAgIGFzayA9IGl0ZW0uZ2V0KCdhc2snKSwKICAgICAgICAgICAgICAgICAgICBjaGF0X3N0YXR1cyA9IGl0ZW0uZ2V0KCdjaGF0X3N0YXR1cycpLAogICAgICAgICAgICAgICAgICAgIHJlcXVlc3RpbmcgID0gaXRlbS5nZXQoJ3JlcXVlc3RpbmcnKSwKICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb24gPSBpdGVtLmdldCgnc3Vic2NyaXB0aW9uJyk7CgogICAgICAgICAgICAgICAgdmFyIGNsYXNzZXNfdG9fcmVtb3ZlID0gWwogICAgICAgICAgICAgICAgICAgICdjdXJyZW50LXhtcHAtY29udGFjdCcsCiAgICAgICAgICAgICAgICAgICAgJ3BlbmRpbmcteG1wcC1jb250YWN0JywKICAgICAgICAgICAgICAgICAgICAncmVxdWVzdGluZy14bXBwLWNvbnRhY3QnCiAgICAgICAgICAgICAgICAgICAgXS5jb25jYXQoXy5rZXlzKFNUQVRVU0VTKSk7CgogICAgICAgICAgICAgICAgXy5lYWNoKGNsYXNzZXNfdG9fcmVtb3ZlLAogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChjbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZWwuY2xhc3NOYW1lLmluZGV4T2YoY2xzKSAhPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLnJlbW92ZUNsYXNzKGNscyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmFkZENsYXNzKGNoYXRfc3RhdHVzKS5kYXRhKCdzdGF0dXMnLCBjaGF0X3N0YXR1cyk7CgogICAgICAgICAgICAgICAgaWYgKChhc2sgPT09ICdzdWJzY3JpYmUnKSB8fCAoc3Vic2NyaXB0aW9uID09PSAnZnJvbScpKSB7CiAgICAgICAgICAgICAgICAgICAgLyogYXNrID09PSAnc3Vic2NyaWJlJwogICAgICAgICAgICAgICAgICAgICAqICAgICAgTWVhbnMgd2UgaGF2ZSBhc2tlZCB0byBzdWJzY3JpYmUgdG8gdGhlbS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIHN1YnNjcmlwdGlvbiA9PT0gJ2Zyb20nCiAgICAgICAgICAgICAgICAgICAgICogICAgICBUaGV5IGFyZSBzdWJzY3JpYmVkIHRvIHVzZSwgYnV0IG5vdCB2aWNlIHZlcnNhLgogICAgICAgICAgICAgICAgICAgICAqICAgICAgV2UgYXNzdW1lIHRoYXQgdGhlcmUgaXMgYSBwZW5kaW5nIHN1YnNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqICAgICAgZnJvbSB1cyB0byB0aGVtIChvdGhlcndpc2Ugd2UncmUgaW4gYSBzdGF0ZSBub3QKICAgICAgICAgICAgICAgICAgICAgKiAgICAgIHN1cHBvcnRlZCBieSBjb252ZXJzZS5qcykuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAgU28gaW4gYm90aCBjYXNlcyB0aGUgdXNlciBpcyBhICJwZW5kaW5nIiBjb250YWN0LgogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLmFkZENsYXNzKCdwZW5kaW5nLXhtcHAtY29udGFjdCcpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLmh0bWwoY29udmVyc2UudGVtcGxhdGVzLnBlbmRpbmdfY29udGFjdCgKICAgICAgICAgICAgICAgICAgICAgICAgXy5leHRlbmQoaXRlbS50b0pTT04oKSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2Rlc2NfcmVtb3ZlJzogX18oJ0NsaWNrIHRvIHJlbW92ZSB0aGlzIGNvbnRhY3QnKQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZXF1ZXN0aW5nID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuYWRkQ2xhc3MoJ3JlcXVlc3RpbmcteG1wcC1jb250YWN0Jyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuaHRtbChjb252ZXJzZS50ZW1wbGF0ZXMucmVxdWVzdGluZ19jb250YWN0KAogICAgICAgICAgICAgICAgICAgICAgICBfLmV4dGVuZChpdGVtLnRvSlNPTigpLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGVzY19hY2NlcHQnOiBfXygiQ2xpY2sgdG8gYWNjZXB0IHRoaXMgY29udGFjdCByZXF1ZXN0IiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGVzY19kZWNsaW5lJzogX18oIkNsaWNrIHRvIGRlY2xpbmUgdGhpcyBjb250YWN0IHJlcXVlc3QiKQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICkpOwogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbnRyb2xib3h0b2dnbGUuc2hvd0NvbnRyb2xCb3goKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3Vic2NyaXB0aW9uID09PSAnYm90aCcgfHwgc3Vic2NyaXB0aW9uID09PSAndG8nKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuYWRkQ2xhc3MoJ2N1cnJlbnQteG1wcC1jb250YWN0Jyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuaHRtbChjb252ZXJzZS50ZW1wbGF0ZXMucm9zdGVyX2l0ZW0oCiAgICAgICAgICAgICAgICAgICAgICAgIF8uZXh0ZW5kKGl0ZW0udG9KU09OKCksIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkZXNjX3N0YXR1cyc6IFNUQVRVU0VTW2NoYXRfc3RhdHVzfHwnb2ZmbGluZSddLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2Rlc2NfY2hhdCc6IF9fKCdDbGljayB0byBjaGF0IHdpdGggdGhpcyBjb250YWN0JyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGVzY19yZW1vdmUnOiBfXygnQ2xpY2sgdG8gcmVtb3ZlIHRoaXMgY29udGFjdCcpCiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLlJvc3RlckNvbnRhY3RzID0gQmFja2JvbmUuQ29sbGVjdGlvbi5leHRlbmQoewogICAgICAgICAgICBtb2RlbDogY29udmVyc2UuUm9zdGVyQ29udGFjdCwKICAgICAgICAgICAgY29tcGFyYXRvcjogZnVuY3Rpb24gKGNvbnRhY3QxLCBjb250YWN0MikgewogICAgICAgICAgICAgICAgdmFyIG5hbWUxLCBuYW1lMjsKICAgICAgICAgICAgICAgIHZhciBzdGF0dXMxID0gY29udGFjdDEuZ2V0KCdjaGF0X3N0YXR1cycpIHx8ICdvZmZsaW5lJzsKICAgICAgICAgICAgICAgIHZhciBzdGF0dXMyID0gY29udGFjdDIuZ2V0KCdjaGF0X3N0YXR1cycpIHx8ICdvZmZsaW5lJzsKICAgICAgICAgICAgICAgIGlmIChTVEFUVVNfV0VJR0hUU1tzdGF0dXMxXSA9PT0gU1RBVFVTX1dFSUdIVFNbc3RhdHVzMl0pIHsKICAgICAgICAgICAgICAgICAgICBuYW1lMSA9IGNvbnRhY3QxLmdldCgnZnVsbG5hbWUnKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgIG5hbWUyID0gY29udGFjdDIuZ2V0KCdmdWxsbmFtZScpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5hbWUxIDwgbmFtZTIgPyAtMSA6IChuYW1lMSA+IG5hbWUyPyAxIDogMCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gU1RBVFVTX1dFSUdIVFNbc3RhdHVzMV0gPCBTVEFUVVNfV0VJR0hUU1tzdGF0dXMyXSA/IC0xIDogMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHN1YnNjcmliZVRvU3VnZ2VzdGVkSXRlbXM6IGZ1bmN0aW9uIChtc2cpIHsKICAgICAgICAgICAgICAgICQobXNnKS5maW5kKCdpdGVtJykuZWFjaChmdW5jdGlvbiAoaSwgaXRlbXMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgJHRoaXMgPSAkKHRoaXMpLAogICAgICAgICAgICAgICAgICAgICAgICBqaWQgPSAkdGhpcy5hdHRyKCdqaWQnKSwKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gJHRoaXMuYXR0cignYWN0aW9uJyksCiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bGxuYW1lID0gJHRoaXMuYXR0cignbmFtZScpOwogICAgICAgICAgICAgICAgICAgIGlmIChhY3Rpb24gPT09ICdhZGQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24ucm9zdGVyLnN1YnNjcmliZShqaWQsIG51bGwsIGNvbnZlcnNlLnhtcHBzdGF0dXMuZ2V0KCdmdWxsbmFtZScpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaXNTZWxmOiBmdW5jdGlvbiAoamlkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gKFN0cm9waGUuZ2V0QmFyZUppZEZyb21KaWQoamlkKSA9PT0gU3Ryb3BoZS5nZXRCYXJlSmlkRnJvbUppZChjb252ZXJzZS5jb25uZWN0aW9uLmppZCkpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgYWRkUmVzb3VyY2U6IGZ1bmN0aW9uIChiYXJlX2ppZCwgcmVzb3VyY2UpIHsKICAgICAgICAgICAgICAgIHZhciBpdGVtID0gdGhpcy5nZXQoYmFyZV9qaWQpLAogICAgICAgICAgICAgICAgICAgIHJlc291cmNlczsKICAgICAgICAgICAgICAgIGlmIChpdGVtKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VzID0gaXRlbS5nZXQoJ3Jlc291cmNlcycpOwogICAgICAgICAgICAgICAgICAgIGlmIChyZXNvdXJjZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF8uaW5kZXhPZihyZXNvdXJjZXMsIHJlc291cmNlKSA9PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VzLnB1c2gocmVzb3VyY2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5zZXQoeydyZXNvdXJjZXMnOiByZXNvdXJjZXN9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSAgewogICAgICAgICAgICAgICAgICAgICAgICBpdGVtLnNldCh7J3Jlc291cmNlcyc6IFtyZXNvdXJjZV19KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZW1vdmVSZXNvdXJjZTogZnVuY3Rpb24gKGJhcmVfamlkLCByZXNvdXJjZSkgewogICAgICAgICAgICAgICAgdmFyIGl0ZW0gPSB0aGlzLmdldChiYXJlX2ppZCksCiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VzLAogICAgICAgICAgICAgICAgICAgIGlkeDsKICAgICAgICAgICAgICAgIGlmIChpdGVtKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VzID0gaXRlbS5nZXQoJ3Jlc291cmNlcycpOwogICAgICAgICAgICAgICAgICAgIGlkeCA9IF8uaW5kZXhPZihyZXNvdXJjZXMsIHJlc291cmNlKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaWR4ICE9PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXNvdXJjZXMuc3BsaWNlKGlkeCwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0uc2V0KHsncmVzb3VyY2VzJzogcmVzb3VyY2VzfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNvdXJjZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc3Vic2NyaWJlQmFjazogZnVuY3Rpb24gKGppZCkgewogICAgICAgICAgICAgICAgdmFyIGJhcmVfamlkID0gU3Ryb3BoZS5nZXRCYXJlSmlkRnJvbUppZChqaWQpOwogICAgICAgICAgICAgICAgaWYgKGNvbnZlcnNlLmNvbm5lY3Rpb24ucm9zdGVyLmZpbmRJdGVtKGJhcmVfamlkKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24ucm9zdGVyLmF1dGhvcml6ZShiYXJlX2ppZCk7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5yb3N0ZXIuc3Vic2NyaWJlKGppZCwgbnVsbCwgY29udmVyc2UueG1wcHN0YXR1cy5nZXQoJ2Z1bGxuYW1lJykpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLnJvc3Rlci5hZGQoamlkLCAnJywgW10sIGZ1bmN0aW9uIChpcSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLnJvc3Rlci5hdXRob3JpemUoYmFyZV9qaWQpOwogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLnJvc3Rlci5zdWJzY3JpYmUoamlkLCBudWxsLCBjb252ZXJzZS54bXBwc3RhdHVzLmdldCgnZnVsbG5hbWUnKSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB1bnN1YnNjcmliZTogZnVuY3Rpb24gKGppZCkgewogICAgICAgICAgICAgICAgLyogVXBvbiByZWNlaXZpbmcgdGhlIHByZXNlbmNlIHN0YW56YSBvZiB0eXBlICJ1bnN1YnNjcmliZWQiLAogICAgICAgICAgICAgICAgKiB0aGUgdXNlciBTSE9VTEQgYWNrbm93bGVkZ2UgcmVjZWlwdCBvZiB0aGF0IHN1YnNjcmlwdGlvbiBzdGF0ZQogICAgICAgICAgICAgICAgKiBub3RpZmljYXRpb24gYnkgc2VuZGluZyBhIHByZXNlbmNlIHN0YW56YSBvZiB0eXBlICJ1bnN1YnNjcmliZSIKICAgICAgICAgICAgICAgICogdGhpcyBzdGVwIGxldHMgdGhlIHVzZXIncyBzZXJ2ZXIga25vdyB0aGF0IGl0IE1VU1Qgbm8gbG9uZ2VyCiAgICAgICAgICAgICAgICAqIHNlbmQgbm90aWZpY2F0aW9uIG9mIHRoZSBzdWJzY3JpcHRpb24gc3RhdGUgY2hhbmdlIHRvIHRoZSB1c2VyLgogICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGNvbnZlcnNlLnhtcHBzdGF0dXMuc2VuZFByZXNlbmNlKCd1bnN1YnNjcmliZScpOwogICAgICAgICAgICAgICAgaWYgKGNvbnZlcnNlLmNvbm5lY3Rpb24ucm9zdGVyLmZpbmRJdGVtKGppZCkpIHsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLnJvc3Rlci5yZW1vdmUoamlkLCBmdW5jdGlvbiAoaXEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2Uucm9zdGVydmlldy5tb2RlbC5yZW1vdmUoamlkKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGdldE51bU9ubGluZUNvbnRhY3RzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgY291bnQgPSAwLAogICAgICAgICAgICAgICAgICAgIGlnbm9yZWQgPSBbJ29mZmxpbmUnLCAndW5hdmFpbGFibGUnXSwKICAgICAgICAgICAgICAgICAgICBtb2RlbHMgPSB0aGlzLm1vZGVscywKICAgICAgICAgICAgICAgICAgICBtb2RlbHNfbGVuZ3RoID0gbW9kZWxzLmxlbmd0aCwKICAgICAgICAgICAgICAgICAgICBpOwogICAgICAgICAgICAgICAgaWYgKGNvbnZlcnNlLnNob3dfb25seV9vbmxpbmVfdXNlcnMpIHsKICAgICAgICAgICAgICAgICAgICBpZ25vcmVkID0gXy51bmlvbihpZ25vcmVkLCBbJ2RuZCcsICd4YScsICdhd2F5J10pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9yIChpPTA7IGk8bW9kZWxzX2xlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKF8uaW5kZXhPZihpZ25vcmVkLCBtb2RlbHNbaV0uZ2V0KCdjaGF0X3N0YXR1cycpKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY291bnQrKzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gY291bnQ7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBjbGVhckNhY2hlOiBmdW5jdGlvbiAoaXRlbXMpIHsKICAgICAgICAgICAgICAgIC8qIFRoZSBsb2NhbHN0b3JhZ2UgY2FjaGUgY29udGFpbmluZyByb3N0ZXIgY29udGFjdHMgbWlnaHQgY29udGFpbgogICAgICAgICAgICAgICAgKiBzb21lIGNvbnRhY3RzIHRoYXQgYXJlbid0IGFjdHVhbGx5IGluIG91ciByb3N0ZXIgYW55bW9yZS4gV2UKICAgICAgICAgICAgICAgICogdGhlcmVmb3JlIG5lZWQgdG8gcmVtb3ZlIHRoZW0gbm93LgogICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIHZhciBpZCwgaSwgY29udGFjdDsKICAgICAgICAgICAgICAgIGZvciAoaT0wOyBpIDwgdGhpcy5tb2RlbHMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgICAgICBpZCA9IHRoaXMubW9kZWxzW2ldLmdldCgnaWQnKTsKICAgICAgICAgICAgICAgICAgICBpZiAoXy5pbmRleE9mKF8ucGx1Y2soaXRlbXMsICdqaWQnKSwgaWQpID09PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb250YWN0ID0gdGhpcy5nZXQoaWQpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29udGFjdCAmJiAhY29udGFjdC5nZXQoJ3JlcXVlc3RpbmcnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFjdC5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBUT0RPOiBzZWUgaWYgd2UgY2FuIG9ubHkgdXNlIDJuZCBpdGVtIHBhcgogICAgICAgICAgICByb3N0ZXJIYW5kbGVyOiBmdW5jdGlvbiAoaXRlbXMsIGl0ZW0pIHsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLmVtaXQoJ3Jvc3RlcicsIGl0ZW1zKTsKICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJDYWNoZShpdGVtcyk7CiAgICAgICAgICAgICAgICB2YXIgbmV3X2l0ZW1zID0gaXRlbSA/IFtpdGVtXSA6IGl0ZW1zOwogICAgICAgICAgICAgICAgXy5lYWNoKG5ld19pdGVtcywgZnVuY3Rpb24gKGl0ZW0sIGluZGV4LCBpdGVtcykgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzU2VsZihpdGVtLmppZCkpIHsgcmV0dXJuOyB9CiAgICAgICAgICAgICAgICAgICAgdmFyIG1vZGVsID0gdGhpcy5nZXQoaXRlbS5qaWQpOwogICAgICAgICAgICAgICAgICAgIGlmICghbW9kZWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlzX2xhc3QgPSAoaW5kZXggPT09IChpdGVtcy5sZW5ndGgtMSkpID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGl0ZW0uc3Vic2NyaXB0aW9uID09PSAnbm9uZScpICYmIChpdGVtLmFzayA9PT0gbnVsbCkgJiYgIWlzX2xhc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlJ3JlIG5vdCBpbnRlcmVzdGVkIGluIHpvbWJpZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIChIYWNrOiBleGNlcHQgaWYgaXQncyB0aGUgbGFzdCBpdGVtLCB0aGVuIHdlIHN0aWxsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhZGQgaXQgc28gdGhhdCB0aGUgcm9zdGVyIHdpbGwgYmUgc2hvd24pLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzazogaXRlbS5hc2ssCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdWxsbmFtZTogaXRlbS5uYW1lIHx8IGl0ZW0uamlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBzOiBpdGVtLmdyb3VwcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGppZDogaXRlbS5qaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb246IGl0ZW0uc3Vic2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIH0sIHtzb3J0OiBmYWxzZX0pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoaXRlbS5zdWJzY3JpcHRpb24gPT09ICdub25lJykgJiYgKGl0ZW0uYXNrID09PSBudWxsKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyB1c2VyIGlzIG5vIGxvbmdlciBpbiBvdXIgcm9zdGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlbC5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSBvbmx5IGZpbmQgb3V0IGFib3V0IHJlcXVlc3RpbmcgY29udGFjdHMgdmlhIHRoZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcHJlc2VuY2UgaGFuZGxlciwgc28gaWYgd2UgcmVjZWl2ZSBhIGNvbnRhY3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGhlcmUsIHdlIGtub3cgdGhleSBhcmVuJ3QgcmVxdWVzdGluZyBhbnltb3JlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2VlIGRvY3MvREVWRUxPUEVSLnJzdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWwuc2F2ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uOiBpdGVtLnN1YnNjcmlwdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc2s6IGl0ZW0uYXNrLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3Rpbmc6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBzOiBpdGVtLmdyb3VwcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCB0aGlzKTsKCiAgICAgICAgICAgICAgICBpZiAoIWNvbnZlcnNlLmluaXRpYWxfcHJlc2VuY2Vfc2VudCkgewogICAgICAgICAgICAgICAgICAgIC8qIE9uY2Ugd2UndmUgc2VudCBvdXQgb3VyIGluaXRpYWwgcHJlc2VuY2Ugc3RhbnphLCB3ZSdsbAogICAgICAgICAgICAgICAgICAgICAqIHN0YXJ0IHJlY2VpdmluZyBwcmVzZW5jZSBzdGFuemFzIGZyb20gb3VyIGNvbnRhY3RzLgogICAgICAgICAgICAgICAgICAgICAqIFdlIHRoZXJlZm9yZSBvbmx5IHdhbnQgdG8gZG8gdGhpcyBhZnRlciBvdXIgcm9zdGVyIGhhcwogICAgICAgICAgICAgICAgICAgICAqIGJlZW4gc2V0IHVwIChvdGhlcndpc2Ugd2UgY2FuJ3QgbWVhbmluZ2Z1bGx5IHByb2Nlc3MKICAgICAgICAgICAgICAgICAgICAgKiBpbmNvbWluZyBwcmVzZW5jZSBzdGFuemFzKS4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5pbml0aWFsX3ByZXNlbmNlX3NlbnQgPSAxOwogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLnhtcHBzdGF0dXMuc2VuZFByZXNlbmNlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBoYW5kbGVJbmNvbWluZ1N1YnNjcmlwdGlvbjogZnVuY3Rpb24gKGppZCkgewogICAgICAgICAgICAgICAgdmFyIGJhcmVfamlkID0gU3Ryb3BoZS5nZXRCYXJlSmlkRnJvbUppZChqaWQpOwogICAgICAgICAgICAgICAgdmFyIGl0ZW0gPSB0aGlzLmdldChiYXJlX2ppZCk7CgogICAgICAgICAgICAgICAgaWYgKCFjb252ZXJzZS5hbGxvd19jb250YWN0X3JlcXVlc3RzKSB7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5yb3N0ZXIudW5hdXRob3JpemUoYmFyZV9qaWQpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGNvbnZlcnNlLmF1dG9fc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCghaXRlbSkgfHwgKGl0ZW0uZ2V0KCdzdWJzY3JpcHRpb24nKSAhPSAndG8nKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN1YnNjcmliZUJhY2soamlkKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLnJvc3Rlci5hdXRob3JpemUoYmFyZV9qaWQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKChpdGVtKSAmJiAoaXRlbS5nZXQoJ3N1YnNjcmlwdGlvbicpICE9ICdub25lJykpICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24ucm9zdGVyLmF1dGhvcml6ZShiYXJlX2ppZCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmdldChiYXJlX2ppZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmdldFZDYXJkKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhcmVfamlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQucHJveHkoZnVuY3Rpb24gKGppZCwgZnVsbG5hbWUsIGltZywgaW1nX3R5cGUsIHVybCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqaWQ6IGJhcmVfamlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uOiAnbm9uZScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc2s6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0aW5nOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVsbG5hbWU6IGZ1bGxuYW1lIHx8IGppZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlOiBpbWcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWFnZV90eXBlOiBpbWdfdHlwZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmNhcmRfdXBkYXRlZDogbW9tZW50KCkuZm9ybWF0KCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgdGhpcyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJC5wcm94eShmdW5jdGlvbiAoamlkLCBpcSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5sb2coIkVycm9yIHdoaWxlIHJldHJpZXZpbmcgdmNhcmQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGQoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgamlkOiBiYXJlX2ppZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbjogJ25vbmUnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNrOiBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdGluZzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bGxuYW1lOiBiYXJlX2ppZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZjYXJkX3VwZGF0ZWQ6IG1vbWVudCgpLmZvcm1hdCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIHRoaXMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHByZXNlbmNlSGFuZGxlcjogZnVuY3Rpb24gKHByZXNlbmNlKSB7CiAgICAgICAgICAgICAgICB2YXIgJHByZXNlbmNlID0gJChwcmVzZW5jZSksCiAgICAgICAgICAgICAgICAgICAgcHJlc2VuY2VfdHlwZSA9ICRwcmVzZW5jZS5hdHRyKCd0eXBlJyk7CiAgICAgICAgICAgICAgICBpZiAocHJlc2VuY2VfdHlwZSA9PT0gJ2Vycm9yJykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGppZCA9ICRwcmVzZW5jZS5hdHRyKCdmcm9tJyksCiAgICAgICAgICAgICAgICAgICAgYmFyZV9qaWQgPSBTdHJvcGhlLmdldEJhcmVKaWRGcm9tSmlkKGppZCksCiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2UgPSBTdHJvcGhlLmdldFJlc291cmNlRnJvbUppZChqaWQpLAogICAgICAgICAgICAgICAgICAgICRzaG93ID0gJHByZXNlbmNlLmZpbmQoJ3Nob3cnKSwKICAgICAgICAgICAgICAgICAgICBjaGF0X3N0YXR1cyA9ICRzaG93LnRleHQoKSB8fCAnb25saW5lJywKICAgICAgICAgICAgICAgICAgICBzdGF0dXNfbWVzc2FnZSA9ICRwcmVzZW5jZS5maW5kKCdzdGF0dXMnKSwKICAgICAgICAgICAgICAgICAgICBjb250YWN0OwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzU2VsZihiYXJlX2ppZCkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGNvbnZlcnNlLmNvbm5lY3Rpb24uamlkICE9PSBqaWQpJiYocHJlc2VuY2VfdHlwZSAhPT0gJ3VuYXZhaWxhYmxlJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQW5vdGhlciByZXNvdXJjZSBoYXMgY2hhbmdlZCBpdCdzIHN0YXR1cywgd2UnbGwgdXBkYXRlIG91cnMgYXMgd2VsbC4KICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UueG1wcHN0YXR1cy5zYXZlKHsnc3RhdHVzJzogY2hhdF9zdGF0dXN9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCgkcHJlc2VuY2UuZmluZCgneCcpLmF0dHIoJ3htbG5zJykgfHwgJycpLmluZGV4T2YoU3Ryb3BoZS5OUy5NVUMpID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIElnbm9yZSBNVUMKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnRhY3QgPSB0aGlzLmdldChiYXJlX2ppZCk7CiAgICAgICAgICAgICAgICBpZiAoY29udGFjdCAmJiAoc3RhdHVzX21lc3NhZ2UudGV4dCgpICE9IGNvbnRhY3QuZ2V0KCdzdGF0dXMnKSkpIHsKICAgICAgICAgICAgICAgICAgICBjb250YWN0LnNhdmUoeydzdGF0dXMnOiBzdGF0dXNfbWVzc2FnZS50ZXh0KCl9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgocHJlc2VuY2VfdHlwZSA9PT0gJ3N1YnNjcmliZWQnKSB8fCAocHJlc2VuY2VfdHlwZSA9PT0gJ3Vuc3Vic2NyaWJlJykpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocHJlc2VuY2VfdHlwZSA9PT0gJ3N1YnNjcmliZScpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5oYW5kbGVJbmNvbWluZ1N1YnNjcmlwdGlvbihqaWQpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwcmVzZW5jZV90eXBlID09PSAndW5zdWJzY3JpYmVkJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMudW5zdWJzY3JpYmUoYmFyZV9qaWQpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwcmVzZW5jZV90eXBlID09PSAndW5hdmFpbGFibGUnKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucmVtb3ZlUmVzb3VyY2UoYmFyZV9qaWQsIHJlc291cmNlKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29udGFjdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFjdC5zYXZlKHsnY2hhdF9zdGF0dXMnOiAnb2ZmbGluZSd9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29udGFjdCkgewogICAgICAgICAgICAgICAgICAgIC8vIHByZXNlbmNlX3R5cGUgaXMgdW5kZWZpbmVkCiAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRSZXNvdXJjZShiYXJlX2ppZCwgcmVzb3VyY2UpOwogICAgICAgICAgICAgICAgICAgIGNvbnRhY3Quc2F2ZSh7J2NoYXRfc3RhdHVzJzogY2hhdF9zdGF0dXN9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuUm9zdGVyR3JvdXAgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQoewogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoYXR0cmlidXRlcywgb3B0aW9ucykgewogICAgICAgICAgICAgICAgdGhpcy5zZXQoXy5leHRlbmQoewogICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBERVNDX0dST1VQX1RPR0dMRSwKICAgICAgICAgICAgICAgICAgICBzdGF0ZTogT1BFTkVECiAgICAgICAgICAgICAgICB9LCBhdHRyaWJ1dGVzKSk7CiAgICAgICAgICAgICAgICAvLyBDb2xsZWN0aW9uIG9mIGNvbnRhY3RzIGJlbG9uZ2luZyB0byB0aGlzIGdyb3VwLgogICAgICAgICAgICAgICAgdGhpcy5jb250YWN0cyA9IG5ldyBjb252ZXJzZS5Sb3N0ZXJDb250YWN0cygpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuUm9zdGVyR3JvdXBWaWV3ID0gQmFja2JvbmUuT3ZlcnZpZXcuZXh0ZW5kKHsKICAgICAgICAgICAgdGFnTmFtZTogJ2R0JywKICAgICAgICAgICAgY2xhc3NOYW1lOiAncm9zdGVyLWdyb3VwJywKICAgICAgICAgICAgZXZlbnRzOiB7CiAgICAgICAgICAgICAgICAiY2xpY2sgYS5ncm91cC10b2dnbGUiOiAidG9nZ2xlIgogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5jb250YWN0cy5vbigiYWRkIiwgdGhpcy5hZGRDb250YWN0LCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuY29udGFjdHMub24oImNoYW5nZTpzdWJzY3JpcHRpb24iLCB0aGlzLm9uQ29udGFjdFN1YnNjcmlwdGlvbkNoYW5nZSwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLmNvbnRhY3RzLm9uKCJjaGFuZ2U6cmVxdWVzdGluZyIsIHRoaXMub25Db250YWN0UmVxdWVzdENoYW5nZSwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLmNvbnRhY3RzLm9uKCJjaGFuZ2U6Y2hhdF9zdGF0dXMiLCBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgbWlnaHQgYmUgb3B0aW1pemVkIGJ5IGluc3RlYWQgb2YgZmlyc3Qgc29ydGluZywKICAgICAgICAgICAgICAgICAgICAvLyBmaW5kaW5nIHRoZSBjb3JyZWN0IHBvc2l0aW9uIGluIHBvc2l0aW9uQ29udGFjdAogICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuY29udGFjdHMuc29ydCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMucG9zaXRpb25Db250YWN0KGNvbnRhY3QpLnJlbmRlcigpOwogICAgICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLmNvbnRhY3RzLm9uKCJkZXN0cm95IiwgdGhpcy5vblJlbW92ZSwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLmNvbnRhY3RzLm9uKCJyZW1vdmUiLCB0aGlzLm9uUmVtb3ZlLCB0aGlzKTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJvc3Rlci5vbignY2hhbmdlOmdyb3VwcycsIHRoaXMub25Db250YWN0R3JvdXBDaGFuZ2UsIHRoaXMpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5hdHRyKCdkYXRhLWdyb3VwJywgdGhpcy5tb2RlbC5nZXQoJ25hbWUnKSk7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5odG1sKAogICAgICAgICAgICAgICAgICAgICQoY29udmVyc2UudGVtcGxhdGVzLmdyb3VwX2hlYWRlcih7CiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsX2dyb3VwOiB0aGlzLm1vZGVsLmdldCgnbmFtZScpLAogICAgICAgICAgICAgICAgICAgICAgICBkZXNjX2dyb3VwX3RvZ2dsZTogdGhpcy5tb2RlbC5nZXQoJ2Rlc2NyaXB0aW9uJyksCiAgICAgICAgICAgICAgICAgICAgICAgIHRvZ2dsZV9zdGF0ZTogdGhpcy5tb2RlbC5nZXQoJ3N0YXRlJykKICAgICAgICAgICAgICAgICAgICB9KSkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGFkZENvbnRhY3Q6IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgICAgICAgICAgICB2YXIgdmlldyA9IG5ldyBjb252ZXJzZS5Sb3N0ZXJDb250YWN0Vmlldyh7bW9kZWw6IGNvbnRhY3R9KTsKICAgICAgICAgICAgICAgIHRoaXMuYWRkKGNvbnRhY3QuZ2V0KCdpZCcpLCB2aWV3KTsKICAgICAgICAgICAgICAgIHZpZXcgPSB0aGlzLnBvc2l0aW9uQ29udGFjdChjb250YWN0KS5yZW5kZXIoKTsKICAgICAgICAgICAgICAgIGlmIChjb250YWN0LnNob3dJblJvc3RlcigpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubW9kZWwuZ2V0KCdzdGF0ZScpID09PSBDTE9TRUQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXcuJGVsWzBdLnN0eWxlLmRpc3BsYXkgIT09ICJub25lIikgeyB2aWV3LiRlbC5oaWRlKCk7IH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuJGVsWzBdLnN0eWxlLmRpc3BsYXkgPT09ICJub25lIikgeyB0aGlzLiRlbC5zaG93KCk7IH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy4kZWxbMF0uc3R5bGUuZGlzcGxheSAhPT0gImJsb2NrIikgeyB0aGlzLnNob3coKTsgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHBvc2l0aW9uQ29udGFjdDogZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgICAgICAgICAgIC8qIFBsYWNlIHRoZSBjb250YWN0J3MgRE9NIGVsZW1lbnQgaW4gdGhlIGNvcnJlY3QgYWxwaGFiZXRpY2FsCiAgICAgICAgICAgICAgICAgKiBwb3NpdGlvbiBhbW9uZ3N0IHRoZSBvdGhlciBjb250YWN0cyBpbiB0aGlzIGdyb3VwLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICB2YXIgdmlldyA9IHRoaXMuZ2V0KGNvbnRhY3QuZ2V0KCdpZCcpKTsKICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMubW9kZWwuY29udGFjdHMuaW5kZXhPZihjb250YWN0KTsKICAgICAgICAgICAgICAgIHZpZXcuJGVsLmRldGFjaCgpOwogICAgICAgICAgICAgICAgaWYgKGluZGV4ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuYWZ0ZXIodmlldy4kZWwpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpbmRleCA9PSAodGhpcy5tb2RlbC5jb250YWN0cy5sZW5ndGgtMSkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5uZXh0VW50aWwoJ2R0JykubGFzdCgpLmFmdGVyKHZpZXcuJGVsKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwubmV4dFVudGlsKCdkdCcpLmVxKGluZGV4KS5iZWZvcmUodmlldy4kZWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHZpZXc7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzaG93OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAvLyBGSVhNRTogVGhlcmUncyBhIGJ1ZyBoZXJlLCBpZiBzaG93X29ubHlfb25saW5lX3VzZXJzIGlzIHRydWUKICAgICAgICAgICAgICAgIC8vIFBvc3NpYmxlIHNvbHV0aW9uLCBnZXQgdGhlIGdyb3VwLCBjYWxsIF8uZWFjaCBhbmQgY2hlY2sKICAgICAgICAgICAgICAgIC8vIHNob3dJblJvc3RlcgogICAgICAgICAgICAgICAgdGhpcy4kZWwubmV4dFVudGlsKCdkdCcpLmFkZEJhY2soKS5zaG93KCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBoaWRlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5uZXh0VW50aWwoJ2R0JykuYWRkQmFjaygpLmhpZGUoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGZpbHRlcjogZnVuY3Rpb24gKHEpIHsKICAgICAgICAgICAgICAgIC8qIEZpbHRlciB0aGUgZ3JvdXAncyBjb250YWN0cyBiYXNlZCBvbiB0aGUgcXVlcnkgInEiLgogICAgICAgICAgICAgICAgICogVGhlIHF1ZXJ5IGlzIG1hdGNoZWQgYWdhaW5zdCB0aGUgY29udGFjdCdzIGZ1bGwgbmFtZS4KICAgICAgICAgICAgICAgICAqIElmIGFsbCBjb250YWN0cyBhcmUgZmlsdGVyZWQgb3V0IChpLmUuIGhpZGRlbiksIHRoZW4gdGhlCiAgICAgICAgICAgICAgICAgKiBncm91cCBtdXN0IGJlIGZpbHRlcmVkIG91dCBhcyB3ZWxsLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICB2YXIgbWF0Y2hlcywgcmVqZWN0czsKICAgICAgICAgICAgICAgIGlmIChxLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm1vZGVsLmdldCgnc3RhdGUnKSA9PT0gT1BFTkVEKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuY29udGFjdHMuZWFjaCgkLnByb3h5KGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5zaG93SW5Sb3N0ZXIoKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0KGl0ZW0uZ2V0KCdpZCcpKS4kZWwuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9LCB0aGlzKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0lmSW52aXNpYmxlKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHEgPSBxLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgbWF0Y2hlcyA9IHRoaXMubW9kZWwuY29udGFjdHMuZmlsdGVyKGNvbnRhaW5zLm5vdCgnZnVsbG5hbWUnLCBxKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoZXMubGVuZ3RoID09PSB0aGlzLm1vZGVsLmNvbnRhY3RzLmxlbmd0aCkgeyAvLyBoaWRlIHRoZSB3aG9sZSBncm91cAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBfLmVhY2gobWF0Y2hlcywgJC5wcm94eShmdW5jdGlvbiAoaXRlbSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXQoaXRlbS5nZXQoJ2lkJykpLiRlbC5oaWRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIHRoaXMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgXy5lYWNoKHRoaXMubW9kZWwuY29udGFjdHMucmVqZWN0KGNvbnRhaW5zLm5vdCgnZnVsbG5hbWUnLCBxKSksICQucHJveHkoZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0KGl0ZW0uZ2V0KCdpZCcpKS4kZWwuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICB9LCB0aGlzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0lmSW52aXNpYmxlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2hvd0lmSW52aXNpYmxlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuJGVsLmlzKCc6dmlzaWJsZScpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuc2hvdygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgdG9nZ2xlOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGlmIChldiAmJiBldi5wcmV2ZW50RGVmYXVsdCkgeyBldi5wcmV2ZW50RGVmYXVsdCgpOyB9CiAgICAgICAgICAgICAgICB2YXIgJGVsID0gJChldi50YXJnZXQpOwogICAgICAgICAgICAgICAgaWYgKCRlbC5oYXNDbGFzcygiaWNvbi1vcGVuZWQiKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLm5leHRVbnRpbCgnZHQnKS5zbGlkZVVwKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5zYXZlKHtzdGF0ZTogQ0xPU0VEfSk7CiAgICAgICAgICAgICAgICAgICAgJGVsLnJlbW92ZUNsYXNzKCJpY29uLW9wZW5lZCIpLmFkZENsYXNzKCJpY29uLWNsb3NlZCIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkZWwucmVtb3ZlQ2xhc3MoImljb24tY2xvc2VkIikuYWRkQ2xhc3MoImljb24tb3BlbmVkIik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5zYXZlKHtzdGF0ZTogT1BFTkVEfSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5maWx0ZXIoCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJvc3RlcnZpZXcuJCgnLnJvc3Rlci1maWx0ZXInKS52YWwoKSwKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2Uucm9zdGVydmlldy4kKCcuZmlsdGVyLXR5cGUnKS52YWwoKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBvbkNvbnRhY3RHcm91cENoYW5nZTogZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgICAgICAgICAgIHZhciBpbl90aGlzX2dyb3VwID0gXy5jb250YWlucyhjb250YWN0LmdldCgnZ3JvdXBzJyksIHRoaXMubW9kZWwuZ2V0KCduYW1lJykpOwogICAgICAgICAgICAgICAgdmFyIGNpZCA9IGNvbnRhY3QuZ2V0KCdpZCcpOwogICAgICAgICAgICAgICAgdmFyIGluX3RoaXNfb3ZlcnZpZXcgPSAhdGhpcy5nZXQoY2lkKTsKICAgICAgICAgICAgICAgIGlmIChpbl90aGlzX2dyb3VwICYmICFpbl90aGlzX292ZXJ2aWV3KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5jb250YWN0cy5yZW1vdmUoY2lkKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWluX3RoaXNfZ3JvdXAgJiYgaW5fdGhpc19vdmVydmlldykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkQ29udGFjdChjb250YWN0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG9uQ29udGFjdFN1YnNjcmlwdGlvbkNoYW5nZTogZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgICAgICAgICAgIGlmICgodGhpcy5tb2RlbC5nZXQoJ25hbWUnKSA9PT0gSEVBREVSX1BFTkRJTkdfQ09OVEFDVFMpICYmIGNvbnRhY3QuZ2V0KCdzdWJzY3JpcHRpb24nKSAhPT0gJ2Zyb20nKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5jb250YWN0cy5yZW1vdmUoY29udGFjdC5nZXQoJ2lkJykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25Db250YWN0UmVxdWVzdENoYW5nZTogZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgICAgICAgICAgIGlmICgodGhpcy5tb2RlbC5nZXQoJ25hbWUnKSA9PT0gSEVBREVSX1JFUVVFU1RJTkdfQ09OVEFDVFMpICYmICFjb250YWN0LmdldCgncmVxdWVzdGluZycpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5jb250YWN0cy5yZW1vdmUoY29udGFjdC5nZXQoJ2lkJykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25SZW1vdmU6IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZShjb250YWN0LmdldCgnaWQnKSk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5tb2RlbC5jb250YWN0cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5oaWRlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5Sb3N0ZXJHcm91cHMgPSBCYWNrYm9uZS5Db2xsZWN0aW9uLmV4dGVuZCh7CiAgICAgICAgICAgIG1vZGVsOiBjb252ZXJzZS5Sb3N0ZXJHcm91cCwKICAgICAgICAgICAgY29tcGFyYXRvcjogZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgIC8qIEdyb3VwcyBhcmUgc29ydGVkIGFscGhhYmV0aWNhbGx5LCBpZ25vcmluZyBjYXNlLgogICAgICAgICAgICAgICAgICogSG93ZXZlciwgVW5ncm91cGVkLCBSZXF1ZXN0aW5nIENvbnRhY3RzIGFuZCBQZW5kaW5nIENvbnRhY3RzCiAgICAgICAgICAgICAgICAgKiBhcHBlYXIgbGFzdCBhbmQgaW4gdGhhdCBvcmRlci4gKi8KICAgICAgICAgICAgICAgIGEgPSBhLmdldCgnbmFtZScpOwogICAgICAgICAgICAgICAgYiA9IGIuZ2V0KCduYW1lJyk7CiAgICAgICAgICAgICAgICB2YXIgc3BlY2lhbF9ncm91cHMgPSBfLmtleXMoSEVBREVSX1dFSUdIVFMpOwogICAgICAgICAgICAgICAgdmFyIGFfaXNfc3BlY2lhbCA9IF8uY29udGFpbnMoc3BlY2lhbF9ncm91cHMsIGEpOwogICAgICAgICAgICAgICAgdmFyIGJfaXNfc3BlY2lhbCA9IF8uY29udGFpbnMoc3BlY2lhbF9ncm91cHMsIGIpOwogICAgICAgICAgICAgICAgaWYgKCFhX2lzX3NwZWNpYWwgJiYgIWJfaXNfc3BlY2lhbCApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYS50b0xvd2VyQ2FzZSgpIDwgYi50b0xvd2VyQ2FzZSgpID8gLTEgOiAoYS50b0xvd2VyQ2FzZSgpID4gYi50b0xvd2VyQ2FzZSgpID8gMSA6IDApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhX2lzX3NwZWNpYWwgJiYgYl9pc19zcGVjaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEhFQURFUl9XRUlHSFRTW2FdIDwgSEVBREVSX1dFSUdIVFNbYl0gPyAtMSA6IChIRUFERVJfV0VJR0hUU1thXSA+IEhFQURFUl9XRUlHSFRTW2JdID8gMSA6IDApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghYV9pc19zcGVjaWFsICYmIGJfaXNfc3BlY2lhbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoYiA9PT0gSEVBREVSX0NVUlJFTlRfQ09OVEFDVFMpID8gMSA6IC0xOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhX2lzX3NwZWNpYWwgJiYgIWJfaXNfc3BlY2lhbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoYSA9PT0gSEVBREVSX0NVUlJFTlRfQ09OVEFDVFMpID8gLTEgOiAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuUm9zdGVyVmlldyA9IEJhY2tib25lLk92ZXJ2aWV3LmV4dGVuZCh7CiAgICAgICAgICAgIHRhZ05hbWU6ICdkaXYnLAogICAgICAgICAgICBpZDogJ2NvbnZlcnNlLXJvc3RlcicsCiAgICAgICAgICAgIGV2ZW50czogewogICAgICAgICAgICAgICAgImtleWRvd24gLnJvc3Rlci1maWx0ZXIiOiAibGl2ZUZpbHRlciIsCiAgICAgICAgICAgICAgICAiY2xpY2sgLm9uWCI6ICJjbGVhckZpbHRlciIsCiAgICAgICAgICAgICAgICAibW91c2Vtb3ZlIC54IjogInRvZ2dsZVBvaW50ZXIiLAogICAgICAgICAgICAgICAgImNoYW5nZSAuZmlsdGVyLXR5cGUiOiAiY2hhbmdlRmlsdGVyVHlwZSIKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVnaXN0ZXJSb3N0ZXJIYW5kbGVyKCk7CiAgICAgICAgICAgICAgICB0aGlzLnJlZ2lzdGVyUm9zdGVyWEhhbmRsZXIoKTsKICAgICAgICAgICAgICAgIHRoaXMucmVnaXN0ZXJQcmVzZW5jZUhhbmRsZXIoKTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJvc3Rlci5vbigiYWRkIiwgdGhpcy5vbkNvbnRhY3RBZGQsIHRoaXMpOwogICAgICAgICAgICAgICAgY29udmVyc2Uucm9zdGVyLm9uKCdjaGFuZ2UnLCB0aGlzLm9uQ29udGFjdENoYW5nZSwgdGhpcyk7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5yb3N0ZXIub24oImRlc3Ryb3kiLCB0aGlzLnVwZGF0ZSwgdGhpcyk7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5yb3N0ZXIub24oInJlbW92ZSIsIHRoaXMudXBkYXRlLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oImFkZCIsIHRoaXMub25Hcm91cEFkZCwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCJyZXNldCIsIHRoaXMucmVzZXQsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy4kcm9zdGVyID0gJCgnPGRsIGNsYXNzPSJyb3N0ZXItY29udGFjdHMiIHN0eWxlPSJkaXNwbGF5OiBub25lOyI+PC9kbD4nKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHVwZGF0ZTogXy5kZWJvdW5jZShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgJGNvdW50ID0gJCgnI29ubGluZS1jb3VudCcpOwogICAgICAgICAgICAgICAgJGNvdW50LnRleHQoJygnK2NvbnZlcnNlLnJvc3Rlci5nZXROdW1PbmxpbmVDb250YWN0cygpKycpJyk7CiAgICAgICAgICAgICAgICBpZiAoISRjb3VudC5pcygnOnZpc2libGUnKSkgewogICAgICAgICAgICAgICAgICAgICRjb3VudC5zaG93KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy4kcm9zdGVyLnBhcmVudCgpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLmFwcGVuZCh0aGlzLiRyb3N0ZXIuc2hvdygpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNob3dIaWRlRmlsdGVyKCk7CiAgICAgICAgICAgIH0sIGNvbnZlcnNlLmFuaW1hdGUgPyAxMDAgOiAwKSwKCiAgICAgICAgICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy4kZWwuaHRtbChjb252ZXJzZS50ZW1wbGF0ZXMucm9zdGVyKHsKICAgICAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcjogX18oJ1R5cGUgdG8gZmlsdGVyJyksCiAgICAgICAgICAgICAgICAgICAgbGFiZWxfY29udGFjdHM6IExBQkVMX0NPTlRBQ1RTLAogICAgICAgICAgICAgICAgICAgIGxhYmVsX2dyb3VwczogTEFCRUxfR1JPVVBTCiAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGZldGNoOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLmZldGNoKHsKICAgICAgICAgICAgICAgICAgICBzaWxlbnQ6IHRydWUsIC8vIFdlIHVzZSB0aGUgc3VjY2VzcyBoYW5kbGVyIHRvIGhhbmRsZSBncm91cHMgdGhhdCB3ZXJlIGFkZGVkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0byBmaXJzdCBoYXZlIGFsbCBncm91cHMgYmVmb3JlIHBvc2l0aW9uRmV0Y2hlZEdyb3VwcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2lsbCB3b3JrIHByb3Blcmx5LgogICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6ICQucHJveHkoZnVuY3Rpb24gKGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbGxlY3Rpb24ubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uRmV0Y2hlZEdyb3Vwcyhjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5yb3N0ZXIuZmV0Y2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGNvbGxlY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBYWFg6IEJpdCBvZiBhIGhhY2suCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3Ryb3BoZS5yb3N0ZXIgZXhwZWN0cyAuZ2V0IHRvIGJlIGNhbGxlZCBmb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBldmVyeSBwYWdlIGxvYWQgc28gdGhhdCBpdHMgIml0ZW1zIiBhdHRyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZ2V0cyBwb3B1bGF0ZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpcyB2ZXJ5IGluZWZmaWNpZW50IGZvciBsYXJnZSByb3N0ZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFuZCB3ZSBhbHJlYWR5IGhhdmUgdGhlIHJvc3RlciBjYWNoZWQgaW4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzZXNzaW9uU3RvcmFnZS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGVyZWZvcmUgd2UgbWFudWFsbHkgcG9wdWxhdGUgdGhlICJpdGVtcyIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhdHRyLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElkZWFsbHkgd2Ugc2hvdWxkIGV2ZW50dWFsbHkgcmVwbGFjZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN0cm9waGUucm9zdGVyIHdpdGggc29tZXRoaW5nIGJldHRlci4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sbGVjdGlvbi5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbGxlY3Rpb24uZWFjaChmdW5jdGlvbiAoaXRlbSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5yb3N0ZXIuaXRlbXMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSAgICAgICAgIDogaXRlbS5nZXQoJ2Z1bGxuYW1lJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgamlkICAgICAgICAgIDogaXRlbS5nZXQoJ2ppZCcpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbiA6IGl0ZW0uZ2V0KCdzdWJzY3JpcHRpb24nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc2sgICAgICAgICAgOiBpdGVtLmdldCgnYXNrJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBzICAgICAgIDogaXRlbS5nZXQoJ2dyb3VwcycpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc291cmNlcyAgICA6IGl0ZW0uZ2V0KCdyZXNvdXJjZXMnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5pbml0aWFsX3ByZXNlbmNlX3NlbnQgPSAxOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS54bXBwc3RhdHVzLnNlbmRQcmVzZW5jZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24ucm9zdGVyLmdldCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSwgdGhpcykKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBjaGFuZ2VGaWx0ZXJUeXBlOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGlmIChldiAmJiBldi5wcmV2ZW50RGVmYXVsdCkgeyBldi5wcmV2ZW50RGVmYXVsdCgpOyB9CiAgICAgICAgICAgICAgICB0aGlzLmNsZWFyRmlsdGVyKCk7CiAgICAgICAgICAgICAgICB0aGlzLmZpbHRlcigKICAgICAgICAgICAgICAgICAgICB0aGlzLiQoJy5yb3N0ZXItZmlsdGVyJykudmFsKCksCiAgICAgICAgICAgICAgICAgICAgZXYudGFyZ2V0LnZhbHVlCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgdG9nOiBmdW5jdGlvbiAodikgewogICAgICAgICAgICAgICAgcmV0dXJuIHY/J2FkZENsYXNzJzoncmVtb3ZlQ2xhc3MnOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgdG9nZ2xlUG9pbnRlcjogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBpZiAoZXYgJiYgZXYucHJldmVudERlZmF1bHQpIHsgZXYucHJldmVudERlZmF1bHQoKTsgfQogICAgICAgICAgICAgICAgdmFyIGVsID0gZXYudGFyZ2V0OwogICAgICAgICAgICAgICAgJChlbClbdGhpcy50b2coZWwub2Zmc2V0V2lkdGgtMTggPCBldi5jbGllbnRYLWVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmxlZnQpXSgnb25YJyk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBmaWx0ZXI6IGZ1bmN0aW9uIChxdWVyeSwgdHlwZSkgewogICAgICAgICAgICAgICAgdmFyIG1hdGNoZXM7CiAgICAgICAgICAgICAgICBxdWVyeSA9IHF1ZXJ5LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2dyb3VwcycpIHsKICAgICAgICAgICAgICAgICAgICBfLmVhY2godGhpcy5nZXRBbGwoKSwgZnVuY3Rpb24gKHZpZXcsIGlkeCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodmlldy5tb2RlbC5nZXQoJ25hbWUnKS50b0xvd2VyQ2FzZSgpLmluZGV4T2YocXVlcnkudG9Mb3dlckNhc2UoKSkgPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aWV3LmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh2aWV3Lm1vZGVsLmNvbnRhY3RzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpZXcuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF8uZWFjaCh0aGlzLmdldEFsbCgpLCBmdW5jdGlvbiAodmlldykgewogICAgICAgICAgICAgICAgICAgICAgICB2aWV3LmZpbHRlcihxdWVyeSwgdHlwZSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBsaXZlRmlsdGVyOiBfLmRlYm91bmNlKGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgaWYgKGV2ICYmIGV2LnByZXZlbnREZWZhdWx0KSB7IGV2LnByZXZlbnREZWZhdWx0KCk7IH0KICAgICAgICAgICAgICAgIHZhciBxID0gZXYudGFyZ2V0LnZhbHVlOwogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLiQoJy5maWx0ZXItdHlwZScpLnZhbCgpOwogICAgICAgICAgICAgICAgJChldi50YXJnZXQpW3RoaXMudG9nKHEpXSgneCcpOwogICAgICAgICAgICAgICAgdGhpcy5maWx0ZXIocSwgdCk7CiAgICAgICAgICAgIH0sIDMwMCksCgogICAgICAgICAgICBjbGVhckZpbHRlcjogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBpZiAoZXYgJiYgZXYucHJldmVudERlZmF1bHQpIHsKICAgICAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgICQoZXYudGFyZ2V0KS5yZW1vdmVDbGFzcygneCBvblgnKS52YWwoJycpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5maWx0ZXIoJycpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2hvd0hpZGVGaWx0ZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy4kZWwuaXMoJzp2aXNpYmxlJykpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgJGZpbHRlciA9IHRoaXMuJCgnLnJvc3Rlci1maWx0ZXInKTsKICAgICAgICAgICAgICAgIHZhciAkdHlwZSAgPSB0aGlzLiQoJy5maWx0ZXItdHlwZScpOwogICAgICAgICAgICAgICAgdmFyIHZpc2libGUgPSAkZmlsdGVyLmlzKCc6dmlzaWJsZScpOwogICAgICAgICAgICAgICAgaWYgKHZpc2libGUgJiYgJGZpbHRlci52YWwoKS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRG9uJ3QgaGlkZSBpZiB1c2VyIGlzIGN1cnJlbnRseSBmaWx0ZXJpbmcuCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRoaXMuJHJvc3Rlci5oYXNTY3JvbGxCYXIoKSkgewogICAgICAgICAgICAgICAgICAgIGlmICghdmlzaWJsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAkZmlsdGVyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgJHR5cGUuc2hvdygpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJGZpbHRlci5oaWRlKCk7CiAgICAgICAgICAgICAgICAgICAgJHR5cGUuaGlkZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZXNldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgY29udmVyc2Uucm9zdGVyLnJlc2V0KCk7CiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUFsbCgpOwogICAgICAgICAgICAgICAgdGhpcy4kcm9zdGVyID0gJCgnPGRsIGNsYXNzPSJyb3N0ZXItY29udGFjdHMiIHN0eWxlPSJkaXNwbGF5OiBub25lOyI+PC9kbD4nKTsKICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyKCkudXBkYXRlKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlZ2lzdGVyUm9zdGVySGFuZGxlcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgLy8gUmVnaXN0ZXIgaGFuZGxlcnMgdGhhdCBkZXBlbmQgb24gdGhlIHJvc3RlcgogICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5yb3N0ZXIucmVnaXN0ZXJDYWxsYmFjaygKICAgICAgICAgICAgICAgICAgICAkLnByb3h5KGNvbnZlcnNlLnJvc3Rlci5yb3N0ZXJIYW5kbGVyLCBjb252ZXJzZS5yb3N0ZXIpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVnaXN0ZXJSb3N0ZXJYSGFuZGxlcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHQgPSAwOwogICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5hZGRIYW5kbGVyKAogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChtc2cpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5mbHVzaCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQucHJveHkoY29udmVyc2Uucm9zdGVyLnN1YnNjcmliZVRvU3VnZ2VzdGVkSXRlbXMsIGNvbnZlcnNlLnJvc3RlcikobXNnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0CiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgIHQgKz0gJChtc2cpLmZpbmQoJ2l0ZW0nKS5sZW5ndGgqMjUwOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICdodHRwOi8vamFiYmVyLm9yZy9wcm90b2NvbC9yb3N0ZXJ4JywgJ21lc3NhZ2UnLCBudWxsKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlZ2lzdGVyUHJlc2VuY2VIYW5kbGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLmFkZEhhbmRsZXIoCiAgICAgICAgICAgICAgICAgICAgJC5wcm94eShmdW5jdGlvbiAocHJlc2VuY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2Uucm9zdGVyLnByZXNlbmNlSGFuZGxlcihwcmVzZW5jZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0sIHRoaXMpLCBudWxsLCAncHJlc2VuY2UnLCBudWxsKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG9uR3JvdXBBZGQ6IGZ1bmN0aW9uIChncm91cCkgewogICAgICAgICAgICAgICAgdmFyIHZpZXcgPSBuZXcgY29udmVyc2UuUm9zdGVyR3JvdXBWaWV3KHttb2RlbDogZ3JvdXB9KTsKICAgICAgICAgICAgICAgIHRoaXMuYWRkKGdyb3VwLmdldCgnbmFtZScpLCB2aWV3LnJlbmRlcigpKTsKICAgICAgICAgICAgICAgIHRoaXMucG9zaXRpb25Hcm91cCh2aWV3KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG9uQ29udGFjdEFkZDogZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgICAgICAgICAgIHRoaXMuYWRkUm9zdGVyQ29udGFjdChjb250YWN0KS51cGRhdGUoKTsKICAgICAgICAgICAgICAgIGlmICghY29udGFjdC5nZXQoJ3ZjYXJkX3VwZGF0ZWQnKSkgewogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgd2lsbCB1cGRhdGUgdGhlIHZjYXJkLCB3aGljaCB0cmlnZ2VycyBhIGNoYW5nZQogICAgICAgICAgICAgICAgICAgIC8vIHJlcXVlc3Qgd2hpY2ggd2lsbCByZXJlbmRlciB0aGUgcm9zdGVyIGNvbnRhY3QuCiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuZ2V0VkNhcmQoY29udGFjdC5nZXQoJ2ppZCcpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG9uQ29udGFjdENoYW5nZTogZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlQ2hhdEJveChjb250YWN0KS51cGRhdGUoKTsKICAgICAgICAgICAgICAgIGlmIChfLmhhcyhjb250YWN0LmNoYW5nZWQsICdzdWJzY3JpcHRpb24nKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChjb250YWN0LmNoYW5nZWQuc3Vic2NyaXB0aW9uID09ICdmcm9tJykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZENvbnRhY3RUb0dyb3VwKGNvbnRhY3QsIEhFQURFUl9QRU5ESU5HX0NPTlRBQ1RTKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRhY3QuZ2V0KCdzdWJzY3JpcHRpb24nKSA9PT0gJ2JvdGgnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkRXhpc3RpbmdDb250YWN0KGNvbnRhY3QpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChfLmhhcyhjb250YWN0LmNoYW5nZWQsICdhc2snKSAmJiBjb250YWN0LmNoYW5nZWQuYXNrID09ICdzdWJzY3JpYmUnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRDb250YWN0VG9Hcm91cChjb250YWN0LCBIRUFERVJfUEVORElOR19DT05UQUNUUyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoXy5oYXMoY29udGFjdC5jaGFuZ2VkLCAnc3Vic2NyaXB0aW9uJykgJiYgY29udGFjdC5jaGFuZ2VkLnJlcXVlc3RpbmcgPT0gJ3RydWUnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRDb250YWN0VG9Hcm91cChjb250YWN0LCBIRUFERVJfUkVRVUVTVElOR19DT05UQUNUUyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB1cGRhdGVDaGF0Qm94OiBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICAgICAgICAgICAgdmFyIGNoYXRib3ggPSBjb252ZXJzZS5jaGF0Ym94ZXMuZ2V0KGNvbnRhY3QuZ2V0KCdqaWQnKSksCiAgICAgICAgICAgICAgICAgICAgY2hhbmdlcyA9IHt9OwogICAgICAgICAgICAgICAgaWYgKCFjaGF0Ym94KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoXy5oYXMoY29udGFjdC5jaGFuZ2VkLCAnY2hhdF9zdGF0dXMnKSkgewogICAgICAgICAgICAgICAgICAgIGNoYW5nZXMuY2hhdF9zdGF0dXMgPSBjb250YWN0LmdldCgnY2hhdF9zdGF0dXMnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChfLmhhcyhjb250YWN0LmNoYW5nZWQsICdzdGF0dXMnKSkgewogICAgICAgICAgICAgICAgICAgIGNoYW5nZXMuc3RhdHVzID0gY29udGFjdC5nZXQoJ3N0YXR1cycpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2hhdGJveC5zYXZlKGNoYW5nZXMpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBwb3NpdGlvbkZldGNoZWRHcm91cHM6IGZ1bmN0aW9uIChtb2RlbCwgcmVzcCwgb3B0aW9ucykgewogICAgICAgICAgICAgICAgLyogSW5zdGVhZCBvZiB0aHJvd2luZyBhbiBhZGQgZXZlbnQgZm9yIGVhY2ggZ3JvdXAKICAgICAgICAgICAgICAgICAgICAqIGZldGNoZWQsIHdlIHdhaXQgdW50aWwgdGhleSdyZSBhbGwgZmV0Y2hlZCBhbmQgdGhlbgogICAgICAgICAgICAgICAgICAgICogd2UgcG9zaXRpb24gdGhlbS4KICAgICAgICAgICAgICAgICAgICAqIFdvcmtzIGFyb3VuZCB0aGUgcHJvYmxlbSBvZiBwb3NpdGlvbkdyb3VwIG5vdAogICAgICAgICAgICAgICAgICAgICogd29ya2luZyB3aGVuIGFsbCBncm91cHMgYmVzaWRlcyB0aGUgb25lIGJlaW5nCiAgICAgICAgICAgICAgICAgICAgKiBwb3NpdGlvbmVkIGFyZW4ndCBhbHJlYWR5IGluIGluc2VydGVkIGludG8gdGhlCiAgICAgICAgICAgICAgICAgICAgKiByb3N0ZXIgRE9NIGVsZW1lbnQuCiAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIG1vZGVsLnNvcnQoKTsKICAgICAgICAgICAgICAgIG1vZGVsLmVhY2goJC5wcm94eShmdW5jdGlvbiAoZ3JvdXAsIGlkeCkgewogICAgICAgICAgICAgICAgICAgIHZhciB2aWV3ID0gdGhpcy5nZXQoZ3JvdXAuZ2V0KCduYW1lJykpOwogICAgICAgICAgICAgICAgICAgIGlmICghdmlldykgewogICAgICAgICAgICAgICAgICAgICAgICB2aWV3ID0gbmV3IGNvbnZlcnNlLlJvc3Rlckdyb3VwVmlldyh7bW9kZWw6IGdyb3VwfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkKGdyb3VwLmdldCgnbmFtZScpLCB2aWV3LnJlbmRlcigpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGlkeCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRyb3N0ZXIuYXBwZW5kKHZpZXcuJGVsKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZEdyb3VwKHZpZXcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHRoaXMpKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHBvc2l0aW9uR3JvdXA6IGZ1bmN0aW9uICh2aWV3KSB7CiAgICAgICAgICAgICAgICAvKiBQbGFjZSB0aGUgZ3JvdXAncyBET00gZWxlbWVudCBpbiB0aGUgY29ycmVjdCBhbHBoYWJldGljYWwKICAgICAgICAgICAgICAgICAqIHBvc2l0aW9uIGFtb25nc3QgdGhlIG90aGVyIGdyb3VwcyBpbiB0aGUgcm9zdGVyLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICB2YXIgJGdyb3VwcyA9IHRoaXMuJHJvc3Rlci5maW5kKCcucm9zdGVyLWdyb3VwJyksCiAgICAgICAgICAgICAgICAgICAgaW5kZXggPSAkZ3JvdXBzLmxlbmd0aCA/IHRoaXMubW9kZWwuaW5kZXhPZih2aWV3Lm1vZGVsKSA6IDA7CiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRyb3N0ZXIucHJlcGVuZCh2aWV3LiRlbCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGluZGV4ID09ICh0aGlzLm1vZGVsLmxlbmd0aC0xKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kR3JvdXAodmlldyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICQoJGdyb3Vwcy5lcShpbmRleCkpLmJlZm9yZSh2aWV3LiRlbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGFwcGVuZEdyb3VwOiBmdW5jdGlvbiAodmlldykgewogICAgICAgICAgICAgICAgLyogQWRkIHRoZSBncm91cCBhdCB0aGUgYm90dG9tIG9mIHRoZSByb3N0ZXIKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgdmFyICRsYXN0ID0gdGhpcy4kcm9zdGVyLmZpbmQoJy5yb3N0ZXItZ3JvdXAnKS5sYXN0KCk7CiAgICAgICAgICAgICAgICB2YXIgJHNpYmxpbmdzID0gJGxhc3Quc2libGluZ3MoJ2RkJyk7CiAgICAgICAgICAgICAgICBpZiAoJHNpYmxpbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAkc2libGluZ3MubGFzdCgpLmFmdGVyKHZpZXcuJGVsKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJGxhc3QuYWZ0ZXIodmlldy4kZWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBnZXRHcm91cDogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgICAgIC8qIFJldHVybnMgdGhlIGdyb3VwIGFzIHNwZWNpZmllZCBieSBuYW1lLgogICAgICAgICAgICAgICAgICogQ3JlYXRlcyB0aGUgZ3JvdXAgaWYgaXQgZG9lc24ndCBleGlzdC4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgdmFyIHZpZXcgPSAgdGhpcy5nZXQobmFtZSk7CiAgICAgICAgICAgICAgICBpZiAodmlldykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB2aWV3Lm1vZGVsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubW9kZWwuY3JlYXRlKHtuYW1lOiBuYW1lLCBpZDogYjY0X3NoYTEobmFtZSl9KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGFkZENvbnRhY3RUb0dyb3VwOiBmdW5jdGlvbiAoY29udGFjdCwgbmFtZSkgewogICAgICAgICAgICAgICAgdGhpcy5nZXRHcm91cChuYW1lKS5jb250YWN0cy5hZGQoY29udGFjdCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBhZGRFeGlzdGluZ0NvbnRhY3Q6IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgICAgICAgICAgICB2YXIgZ3JvdXBzOwogICAgICAgICAgICAgICAgaWYgKGNvbnZlcnNlLnJvc3Rlcl9ncm91cHMpIHsKICAgICAgICAgICAgICAgICAgICBncm91cHMgPSBjb250YWN0LmdldCgnZ3JvdXBzJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGdyb3Vwcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBzID0gW0hFQURFUl9VTkdST1VQRURdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZ3JvdXBzID0gW0hFQURFUl9DVVJSRU5UX0NPTlRBQ1RTXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIF8uZWFjaChncm91cHMsICQucHJveHkoZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZENvbnRhY3RUb0dyb3VwKGNvbnRhY3QsIG5hbWUpOwogICAgICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgYWRkUm9zdGVyQ29udGFjdDogZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgICAgICAgICAgIGlmIChjb250YWN0LmdldCgnc3Vic2NyaXB0aW9uJykgPT09ICdib3RoJyB8fCBjb250YWN0LmdldCgnc3Vic2NyaXB0aW9uJykgPT09ICd0bycpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZEV4aXN0aW5nQ29udGFjdChjb250YWN0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKChjb250YWN0LmdldCgnYXNrJykgPT09ICdzdWJzY3JpYmUnKSB8fCAoY29udGFjdC5nZXQoJ3N1YnNjcmlwdGlvbicpID09PSAnZnJvbScpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkQ29udGFjdFRvR3JvdXAoY29udGFjdCwgSEVBREVSX1BFTkRJTkdfQ09OVEFDVFMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29udGFjdC5nZXQoJ3JlcXVlc3RpbmcnKSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZENvbnRhY3RUb0dyb3VwKGNvbnRhY3QsIEhFQURFUl9SRVFVRVNUSU5HX0NPTlRBQ1RTKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLlhNUFBTdGF0dXMgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQoewogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldCh7CiAgICAgICAgICAgICAgICAgICAgJ3N0YXR1cycgOiB0aGlzLmdldCgnc3RhdHVzJykgfHwgJ29ubGluZScKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdGhpcy5vbignY2hhbmdlJywgJC5wcm94eShmdW5jdGlvbiAoaXRlbSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdldCgnZnVsbG5hbWUnKSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmdldFZDYXJkKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVsbCwgLy8gTm8gJ3RvJyBhdHRyIHdoZW4gZ2V0dGluZyBvbmUncyBvd24gdkNhcmQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQucHJveHkoZnVuY3Rpb24gKGppZCwgZnVsbG5hbWUsIGltYWdlLCBpbWFnZV90eXBlLCB1cmwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNhdmUoeydmdWxsbmFtZSc6IGZ1bGxuYW1lfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCB0aGlzKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoXy5oYXMoaXRlbS5jaGFuZ2VkLCAnc3RhdHVzJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuZW1pdCgnc3RhdHVzQ2hhbmdlZCcsIHRoaXMuZ2V0KCdzdGF0dXMnKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChfLmhhcyhpdGVtLmNoYW5nZWQsICdzdGF0dXNfbWVzc2FnZScpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmVtaXQoJ3N0YXR1c01lc3NhZ2VDaGFuZ2VkJywgdGhpcy5nZXQoJ3N0YXR1c19tZXNzYWdlJykpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHRoaXMpKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHNlbmRQcmVzZW5jZTogZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gdGhpcy5nZXQoJ3N0YXR1cycpIHx8ICdvbmxpbmUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHN0YXR1c19tZXNzYWdlID0gdGhpcy5nZXQoJ3N0YXR1c19tZXNzYWdlJyksCiAgICAgICAgICAgICAgICAgICAgcHJlc2VuY2U7CiAgICAgICAgICAgICAgICAvLyBNb3N0IG9mIHRoZXNlIHByZXNlbmNlIHR5cGVzIGFyZSBhY3R1YWxseSBub3QgZXhwbGljaXRseSBzZW50LAogICAgICAgICAgICAgICAgLy8gYnV0IEkgYWRkIGFsbCBvZiB0aGVtIGhlcmUgZm9yZSByZWZlcmVuY2UgYW5kIGZ1dHVyZSBwcm9vZmluZy4KICAgICAgICAgICAgICAgIGlmICgodHlwZSA9PT0gJ3VuYXZhaWxhYmxlJykgfHwKICAgICAgICAgICAgICAgICAgICAgICAgKHR5cGUgPT09ICdwcm9iZScpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICh0eXBlID09PSAnZXJyb3InKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAodHlwZSA9PT0gJ3Vuc3Vic2NyaWJlJykgfHwKICAgICAgICAgICAgICAgICAgICAgICAgKHR5cGUgPT09ICd1bnN1YnNjcmliZWQnKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAodHlwZSA9PT0gJ3N1YnNjcmliZScpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICh0eXBlID09PSAnc3Vic2NyaWJlZCcpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJlc2VuY2UgPSAkcHJlcyh7J3R5cGUnOnR5cGV9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdvbmxpbmUnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZXNlbmNlID0gJHByZXMoKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBwcmVzZW5jZSA9ICRwcmVzKCkuYygnc2hvdycpLnQodHlwZSkudXAoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXR1c19tZXNzYWdlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZXNlbmNlLmMoJ3N0YXR1cycpLnQoc3RhdHVzX21lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24uc2VuZChwcmVzZW5jZSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzZXRTdGF0dXM6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5zZW5kUHJlc2VuY2UodmFsdWUpOwogICAgICAgICAgICAgICAgdGhpcy5zYXZlKHsnc3RhdHVzJzogdmFsdWV9KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHNldFN0YXR1c01lc3NhZ2U6IGZ1bmN0aW9uIChzdGF0dXNfbWVzc2FnZSkgewogICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5zZW5kKCRwcmVzKCkuYygnc2hvdycpLnQodGhpcy5nZXQoJ3N0YXR1cycpKS51cCgpLmMoJ3N0YXR1cycpLnQoc3RhdHVzX21lc3NhZ2UpKTsKICAgICAgICAgICAgICAgIHRoaXMuc2F2ZSh7J3N0YXR1c19tZXNzYWdlJzogc3RhdHVzX21lc3NhZ2V9KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnhocl9jdXN0b21fc3RhdHVzKSB7CiAgICAgICAgICAgICAgICAgICAgJC5hamF4KHsKICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiAgdGhpcy54aHJfY3VzdG9tX3N0YXR1c191cmwsCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdQT1NUJywKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogeydtc2cnOiBzdGF0dXNfbWVzc2FnZX0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLlhNUFBTdGF0dXNWaWV3ID0gQmFja2JvbmUuVmlldy5leHRlbmQoewogICAgICAgICAgICBlbDogInNwYW4jeG1wcC1zdGF0dXMtaG9sZGVyIiwKCiAgICAgICAgICAgIGV2ZW50czogewogICAgICAgICAgICAgICAgImNsaWNrIGEuY2hvb3NlLXhtcHAtc3RhdHVzIjogInRvZ2dsZU9wdGlvbnMiLAogICAgICAgICAgICAgICAgImNsaWNrICNmYW5jeS14bXBwLXN0YXR1cy1zZWxlY3QgYS5jaGFuZ2UteG1wcC1zdGF0dXMtbWVzc2FnZSI6ICJyZW5kZXJTdGF0dXNDaGFuZ2VGb3JtIiwKICAgICAgICAgICAgICAgICJzdWJtaXQgI3NldC1jdXN0b20teG1wcC1zdGF0dXMiOiAic2V0U3RhdHVzTWVzc2FnZSIsCiAgICAgICAgICAgICAgICAiY2xpY2sgLmRyb3Bkb3duIGRkIHVsIGxpIGEiOiAic2V0U3RhdHVzIgogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbigiY2hhbmdlIiwgdGhpcy51cGRhdGVTdGF0dXNVSSwgdGhpcyk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgLy8gUmVwbGFjZSB0aGUgZGVmYXVsdCBkcm9wZG93biB3aXRoIHNvbWV0aGluZyBuaWNlcgogICAgICAgICAgICAgICAgdmFyICRzZWxlY3QgPSB0aGlzLiRlbC5maW5kKCdzZWxlY3Qjc2VsZWN0LXhtcHAtc3RhdHVzJyksCiAgICAgICAgICAgICAgICAgICAgY2hhdF9zdGF0dXMgPSB0aGlzLm1vZGVsLmdldCgnc3RhdHVzJykgfHwgJ29mZmxpbmUnLAogICAgICAgICAgICAgICAgICAgIG9wdGlvbnMgPSAkKCdvcHRpb24nLCAkc2VsZWN0KSwKICAgICAgICAgICAgICAgICAgICAkb3B0aW9uc190YXJnZXQsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uc19saXN0ID0gW10sCiAgICAgICAgICAgICAgICAgICAgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5odG1sKGNvbnZlcnNlLnRlbXBsYXRlcy5jaG9vc2Vfc3RhdHVzKCkpOwogICAgICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgnI2ZhbmN5LXhtcHAtc3RhdHVzLXNlbGVjdCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC5odG1sKGNvbnZlcnNlLnRlbXBsYXRlcy5jaGF0X3N0YXR1cyh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc3RhdHVzX21lc3NhZ2UnOiB0aGlzLm1vZGVsLmdldCgnc3RhdHVzX21lc3NhZ2UnKSB8fCBfXygiSSBhbSAlMSRzIiwgdGhpcy5nZXRQcmV0dHlTdGF0dXMoY2hhdF9zdGF0dXMpKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdjaGF0X3N0YXR1cyc6IGNoYXRfc3RhdHVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2Rlc2NfY3VzdG9tX3N0YXR1cyc6IF9fKCdDbGljayBoZXJlIHRvIHdyaXRlIGEgY3VzdG9tIHN0YXR1cyBtZXNzYWdlJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGVzY19jaGFuZ2Vfc3RhdHVzJzogX18oJ0NsaWNrIHRvIGNoYW5nZSB5b3VyIGNoYXQgc3RhdHVzJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgICAgIC8vIGl0ZXJhdGUgdGhyb3VnaCBhbGwgdGhlIDxvcHRpb24+IGVsZW1lbnRzIGFuZCBhZGQgb3B0aW9uIHZhbHVlcwogICAgICAgICAgICAgICAgb3B0aW9ucy5lYWNoKGZ1bmN0aW9uICgpewogICAgICAgICAgICAgICAgICAgIG9wdGlvbnNfbGlzdC5wdXNoKGNvbnZlcnNlLnRlbXBsYXRlcy5zdGF0dXNfb3B0aW9uKHsKICAgICAgICAgICAgICAgICAgICAgICAgJ3ZhbHVlJzogJCh0aGlzKS52YWwoKSwKICAgICAgICAgICAgICAgICAgICAgICAgJ3RleHQnOiB0aGlzLnRleHQKICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICRvcHRpb25zX3RhcmdldCA9IHRoaXMuJGVsLmZpbmQoIiN0YXJnZXQgZGQgdWwiKS5oaWRlKCk7CiAgICAgICAgICAgICAgICAkb3B0aW9uc190YXJnZXQuYXBwZW5kKG9wdGlvbnNfbGlzdC5qb2luKCcnKSk7CiAgICAgICAgICAgICAgICAkc2VsZWN0LnJlbW92ZSgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB0b2dnbGVPcHRpb25zOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAkKGV2LnRhcmdldCkucGFyZW50KCkucGFyZW50KCkuc2libGluZ3MoJ2RkJykuZmluZCgndWwnKS50b2dnbGUoJ2Zhc3QnKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlbmRlclN0YXR1c0NoYW5nZUZvcm06IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIHZhciBzdGF0dXNfbWVzc2FnZSA9IHRoaXMubW9kZWwuZ2V0KCdzdGF0dXMnKSB8fCAnb2ZmbGluZSc7CiAgICAgICAgICAgICAgICB2YXIgaW5wdXQgPSBjb252ZXJzZS50ZW1wbGF0ZXMuY2hhbmdlX3N0YXR1c19tZXNzYWdlKHsKICAgICAgICAgICAgICAgICAgICAnc3RhdHVzX21lc3NhZ2UnOiBzdGF0dXNfbWVzc2FnZSwKICAgICAgICAgICAgICAgICAgICAnbGFiZWxfY3VzdG9tX3N0YXR1cyc6IF9fKCdDdXN0b20gc3RhdHVzJyksCiAgICAgICAgICAgICAgICAgICAgJ2xhYmVsX3NhdmUnOiBfXygnU2F2ZScpCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmZpbmQoJy54bXBwLXN0YXR1cycpLnJlcGxhY2VXaXRoKGlucHV0KTsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmZpbmQoJy5jdXN0b20teG1wcC1zdGF0dXMnKS5mb2N1cygpLmZvY3VzKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzZXRTdGF0dXNNZXNzYWdlOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICB2YXIgc3RhdHVzX21lc3NhZ2UgPSAkKGV2LnRhcmdldCkuZmluZCgnaW5wdXQnKS52YWwoKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuc2V0U3RhdHVzTWVzc2FnZShzdGF0dXNfbWVzc2FnZSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzZXRTdGF0dXM6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIHZhciAkZWwgPSAkKGV2LnRhcmdldCksCiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSAkZWwuYXR0cignZGF0YS12YWx1ZScpOwogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSAnbG9nb3V0JykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLmZpbmQoIi5kcm9wZG93biBkZCB1bCIpLmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5sb2dPdXQoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5zZXRTdGF0dXModmFsdWUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLmZpbmQoIi5kcm9wZG93biBkZCB1bCIpLmhpZGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGdldFByZXR0eVN0YXR1czogZnVuY3Rpb24gKHN0YXQpIHsKICAgICAgICAgICAgICAgIHZhciBwcmV0dHlfc3RhdHVzOwogICAgICAgICAgICAgICAgaWYgKHN0YXQgPT09ICdjaGF0JykgewogICAgICAgICAgICAgICAgICAgIHByZXR0eV9zdGF0dXMgPSBfXygnb25saW5lJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXQgPT09ICdkbmQnKSB7CiAgICAgICAgICAgICAgICAgICAgcHJldHR5X3N0YXR1cyA9IF9fKCdidXN5Jyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXQgPT09ICd4YScpIHsKICAgICAgICAgICAgICAgICAgICBwcmV0dHlfc3RhdHVzID0gX18oJ2F3YXkgZm9yIGxvbmcnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdCA9PT0gJ2F3YXknKSB7CiAgICAgICAgICAgICAgICAgICAgcHJldHR5X3N0YXR1cyA9IF9fKCdhd2F5Jyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHByZXR0eV9zdGF0dXMgPSBfXyhzdGF0KSB8fCBfXygnb25saW5lJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcHJldHR5X3N0YXR1czsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHVwZGF0ZVN0YXR1c1VJOiBmdW5jdGlvbiAobW9kZWwpIHsKICAgICAgICAgICAgICAgIGlmICghKF8uaGFzKG1vZGVsLmNoYW5nZWQsICdzdGF0dXMnKSkgJiYgIShfLmhhcyhtb2RlbC5jaGFuZ2VkLCAnc3RhdHVzX21lc3NhZ2UnKSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgc3RhdCA9IG1vZGVsLmdldCgnc3RhdHVzJyk7CiAgICAgICAgICAgICAgICAvLyAjIEZvciB0cmFuc2xhdG9yczogdGhlICUxJHMgcGFydCBnZXRzIHJlcGxhY2VkIHdpdGggdGhlIHN0YXR1cwogICAgICAgICAgICAgICAgLy8gIyBFeGFtcGxlLCBJIGFtIG9ubGluZQogICAgICAgICAgICAgICAgdmFyIHN0YXR1c19tZXNzYWdlID0gbW9kZWwuZ2V0KCdzdGF0dXNfbWVzc2FnZScpIHx8IF9fKCJJIGFtICUxJHMiLCB0aGlzLmdldFByZXR0eVN0YXR1cyhzdGF0KSk7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5maW5kKCcjZmFuY3kteG1wcC1zdGF0dXMtc2VsZWN0JykuaHRtbCgKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS50ZW1wbGF0ZXMuY2hhdF9zdGF0dXMoewogICAgICAgICAgICAgICAgICAgICAgICAnY2hhdF9zdGF0dXMnOiBzdGF0LAogICAgICAgICAgICAgICAgICAgICAgICAnc3RhdHVzX21lc3NhZ2UnOiBzdGF0dXNfbWVzc2FnZSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2Rlc2NfY3VzdG9tX3N0YXR1cyc6IF9fKCdDbGljayBoZXJlIHRvIHdyaXRlIGEgY3VzdG9tIHN0YXR1cyBtZXNzYWdlJyksCiAgICAgICAgICAgICAgICAgICAgICAgICdkZXNjX2NoYW5nZV9zdGF0dXMnOiBfXygnQ2xpY2sgdG8gY2hhbmdlIHlvdXIgY2hhdCBzdGF0dXMnKQogICAgICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLkJPU0hTZXNzaW9uID0gQmFja2JvbmUuTW9kZWw7CiAgICAgICAgdGhpcy5GZWF0dXJlID0gQmFja2JvbmUuTW9kZWw7CiAgICAgICAgdGhpcy5GZWF0dXJlcyA9IEJhY2tib25lLkNvbGxlY3Rpb24uZXh0ZW5kKHsKICAgICAgICAgICAgLyogU2VydmljZSBEaXNjb3ZlcnkKICAgICAgICAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLQogICAgICAgICAgICAqIFRoaXMgY29sbGVjdGlvbiBzdG9yZXMgRmVhdHVyZSBNb2RlbHMsIHJlcHJlc2VudGluZyBmZWF0dXJlcwogICAgICAgICAgICAqIHByb3ZpZGVkIGJ5IGF2YWlsYWJsZSBYTVBQIGVudGl0aWVzIChlLmcuIHNlcnZlcnMpCiAgICAgICAgICAgICogU2VlIFhFUC0wMDMwIGZvciBtb3JlIGRldGFpbHM6IGh0dHA6Ly94bXBwLm9yZy9leHRlbnNpb25zL3hlcC0wMDMwLmh0bWwKICAgICAgICAgICAgKiBBbGwgZmVhdHVyZXMgYXJlIHNob3duIGhlcmU6IGh0dHA6Ly94bXBwLm9yZy9yZWdpc3RyYXIvZGlzY28tZmVhdHVyZXMuaHRtbAogICAgICAgICAgICAqLwogICAgICAgICAgICBtb2RlbDogY29udmVyc2UuRmVhdHVyZSwKICAgICAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy5hZGRDbGllbnRJZGVudGl0aWVzKCkuYWRkQ2xpZW50RmVhdHVyZXMoKTsKICAgICAgICAgICAgICAgIHRoaXMuYnJvd3NlclN0b3JhZ2UgPSBuZXcgQmFja2JvbmUuQnJvd3NlclN0b3JhZ2VbY29udmVyc2Uuc3RvcmFnZV0oCiAgICAgICAgICAgICAgICAgICAgYjY0X3NoYTEoJ2NvbnZlcnNlLmZlYXR1cmVzJytjb252ZXJzZS5iYXJlX2ppZCkpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuYnJvd3NlclN0b3JhZ2UucmVjb3Jkcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAvLyBicm93c2VyU3RvcmFnZSBpcyBlbXB0eSwgc28gd2UndmUgbGlrZWx5IG5ldmVyIHF1ZXJpZWQgdGhpcwogICAgICAgICAgICAgICAgICAgIC8vIGRvbWFpbiBmb3IgZmVhdHVyZXMgeWV0CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5kaXNjby5pbmZvKGNvbnZlcnNlLmRvbWFpbiwgbnVsbCwgJC5wcm94eSh0aGlzLm9uSW5mbywgdGhpcykpOwogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24uZGlzY28uaXRlbXMoY29udmVyc2UuZG9tYWluLCBudWxsLCAkLnByb3h5KHRoaXMub25JdGVtcywgdGhpcykpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZldGNoKHthZGQ6dHJ1ZX0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgYWRkQ2xpZW50SWRlbnRpdGllczogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgLyogU2VlIGh0dHA6Ly94bXBwLm9yZy9yZWdpc3RyYXIvZGlzY28tY2F0ZWdvcmllcy5odG1sCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLmRpc2NvLmFkZElkZW50aXR5KCdjbGllbnQnLCAnd2ViJywgJ0NvbnZlcnNlLmpzJyk7CiAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBhZGRDbGllbnRGZWF0dXJlczogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgLyogVGhlIHN0cm9waGUuZGlzY28uanMgcGx1Z2luIGtlZXBzIGEgbGlzdCBvZiBmZWF0dXJlcyB3aGljaAogICAgICAgICAgICAgICAgICogaXQgd2lsbCBhZHZlcnRpc2UgdG8gYW55ICNpbmZvIHF1ZXJpZXMgbWFkZSB0byBpdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBTZWU6IGh0dHA6Ly94bXBwLm9yZy9leHRlbnNpb25zL3hlcC0wMDMwLmh0bWwjaW5mbwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFRPRE86IHRoZXNlIGZlYXR1cmVzIG5lZWQgdG8gYmUgYWRkZWQgaW4gdGhlIHJlbGV2YW50CiAgICAgICAgICAgICAgICAgKiBmZWF0dXJlLXByb3ZpZGluZyBNb2RlbHMsIG5vdCBoZXJlCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLmRpc2NvLmFkZEZlYXR1cmUoJ2h0dHA6Ly9qYWJiZXIub3JnL3Byb3RvY29sL2NoYXRzdGF0ZXMnKTsgLy8gTGltaXRlZCBzdXBwb3J0CiAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5kaXNjby5hZGRGZWF0dXJlKCdodHRwOi8vamFiYmVyLm9yZy9wcm90b2NvbC9yb3N0ZXJ4Jyk7IC8vIExpbWl0ZWQgc3VwcG9ydAogICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24uZGlzY28uYWRkRmVhdHVyZSgnamFiYmVyOng6Y29uZmVyZW5jZScpOwogICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24uZGlzY28uYWRkRmVhdHVyZSgndXJuOnhtcHA6Y2FyYm9uczoyJyk7CiAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5kaXNjby5hZGRGZWF0dXJlKCd2Y2FyZC10ZW1wJyk7CiAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5kaXNjby5hZGRGZWF0dXJlKFN0cm9waGUuTlMuQk9TSCk7CiAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5kaXNjby5hZGRGZWF0dXJlKFN0cm9waGUuTlMuRElTQ09fSU5GTyk7CiAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5kaXNjby5hZGRGZWF0dXJlKFN0cm9waGUuTlMuTVVDKTsKICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG9uSXRlbXM6IGZ1bmN0aW9uIChzdGFuemEpIHsKICAgICAgICAgICAgICAgICQoc3RhbnphKS5maW5kKCdxdWVyeSBpdGVtJykuZWFjaCgkLnByb3h5KGZ1bmN0aW9uIChpZHgsIGl0ZW0pIHsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLmRpc2NvLmluZm8oCiAgICAgICAgICAgICAgICAgICAgICAgICQoaXRlbSkuYXR0cignamlkJyksCiAgICAgICAgICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgICQucHJveHkodGhpcy5vbkluZm8sIHRoaXMpKTsKICAgICAgICAgICAgICAgIH0sIHRoaXMpKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG9uSW5mbzogZnVuY3Rpb24gKHN0YW56YSkgewogICAgICAgICAgICAgICAgdmFyICRzdGFuemEgPSAkKHN0YW56YSk7CiAgICAgICAgICAgICAgICBpZiAoKCRzdGFuemEuZmluZCgnaWRlbnRpdHlbY2F0ZWdvcnk9c2VydmVyXVt0eXBlPWltXScpLmxlbmd0aCA9PT0gMCkgJiYKICAgICAgICAgICAgICAgICAgICAoJHN0YW56YS5maW5kKCdpZGVudGl0eVtjYXRlZ29yeT1jb25mZXJlbmNlXVt0eXBlPXRleHRdJykubGVuZ3RoID09PSAwKSkgewogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXNuJ3QgYW4gSU0gc2VydmVyIGNvbXBvbmVudAogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICRzdGFuemEuZmluZCgnZmVhdHVyZScpLmVhY2goJC5wcm94eShmdW5jdGlvbiAoaWR4LCBmZWF0dXJlKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jcmVhdGUoewogICAgICAgICAgICAgICAgICAgICAgICAndmFyJzogJChmZWF0dXJlKS5hdHRyKCd2YXInKSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2Zyb20nOiAkc3RhbnphLmF0dHIoJ2Zyb20nKQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuTG9naW5QYW5lbCA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKICAgICAgICAgICAgdGFnTmFtZTogJ2RpdicsCiAgICAgICAgICAgIGlkOiAibG9naW4tZGlhbG9nIiwKICAgICAgICAgICAgZXZlbnRzOiB7CiAgICAgICAgICAgICAgICAnc3VibWl0IGZvcm0jY29udmVyc2UtbG9naW4nOiAnYXV0aGVudGljYXRlJwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgY29ubmVjdDogZnVuY3Rpb24gKCRmb3JtLCBqaWQsIHBhc3N3b3JkKSB7CiAgICAgICAgICAgICAgICBpZiAoJGZvcm0pIHsKICAgICAgICAgICAgICAgICAgICAkZm9ybS5maW5kKCdpbnB1dFt0eXBlPXN1Ym1pdF0nKS5oaWRlKCkuYWZ0ZXIoJzxzcGFuIGNsYXNzPSJzcGlubmVyIGxvZ2luLXN1Ym1pdCIvPicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHJlc291cmNlID0gU3Ryb3BoZS5nZXRSZXNvdXJjZUZyb21KaWQoamlkKTsKICAgICAgICAgICAgICAgIGlmICghcmVzb3VyY2UpIHsKICAgICAgICAgICAgICAgICAgICBqaWQgKz0gJy9jb252ZXJzZS5qcy0nICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpKjEzOTc0OTgyNSkudG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24uY29ubmVjdChqaWQsIHBhc3N3b3JkLCBjb252ZXJzZS5vbkNvbm5lY3QpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKGNmZykgewogICAgICAgICAgICAgICAgY2ZnLiRwYXJlbnQuaHRtbCh0aGlzLiRlbC5odG1sKAogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLnRlbXBsYXRlcy5sb2dpbl9wYW5lbCh7CiAgICAgICAgICAgICAgICAgICAgICAgICdsYWJlbF91c2VybmFtZSc6IF9fKCdYTVBQL0phYmJlciBVc2VybmFtZTonKSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2xhYmVsX3Bhc3N3b3JkJzogX18oJ1Bhc3N3b3JkOicpLAogICAgICAgICAgICAgICAgICAgICAgICAnbGFiZWxfbG9naW4nOiBfXygnTG9nIEluJykKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgKSk7CiAgICAgICAgICAgICAgICB0aGlzLiR0YWJzID0gY2ZnLiRwYXJlbnQucGFyZW50KCkuZmluZCgnI2NvbnRyb2xib3gtdGFicycpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLiR0YWJzLmFwcGVuZChjb252ZXJzZS50ZW1wbGF0ZXMubG9naW5fdGFiKHtsYWJlbF9zaWduX2luOiBfXygnU2lnbiBpbicpfSkpOwogICAgICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgnaW5wdXQjamlkJykuZm9jdXMoKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgYXV0aGVudGljYXRlOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGlmIChldiAmJiBldi5wcmV2ZW50RGVmYXVsdCkgeyBldi5wcmV2ZW50RGVmYXVsdCgpOyB9CiAgICAgICAgICAgICAgICB2YXIgJGZvcm0gPSAkKGV2LnRhcmdldCksCiAgICAgICAgICAgICAgICAgICAgJGppZF9pbnB1dCA9ICRmb3JtLmZpbmQoJ2lucHV0W25hbWU9amlkXScpLAogICAgICAgICAgICAgICAgICAgIGppZCA9ICRqaWRfaW5wdXQudmFsKCksCiAgICAgICAgICAgICAgICAgICAgJHB3X2lucHV0ID0gJGZvcm0uZmluZCgnaW5wdXRbbmFtZT1wYXNzd29yZF0nKSwKICAgICAgICAgICAgICAgICAgICBwYXNzd29yZCA9ICRwd19pbnB1dC52YWwoKSwKICAgICAgICAgICAgICAgICAgICAkYnN1X2lucHV0ID0gbnVsbCwKICAgICAgICAgICAgICAgICAgICBlcnJvcnMgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICBpZiAoISBjb252ZXJzZS5ib3NoX3NlcnZpY2VfdXJsKSB7CiAgICAgICAgICAgICAgICAgICAgJGJzdV9pbnB1dCA9ICRmb3JtLmZpbmQoJ2lucHV0I2Jvc2hfc2VydmljZV91cmwnKTsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5ib3NoX3NlcnZpY2VfdXJsID0gJGJzdV9pbnB1dC52YWwoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoISBjb252ZXJzZS5ib3NoX3NlcnZpY2VfdXJsKSAgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcnMgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAkYnN1X2lucHV0LmFkZENsYXNzKCdlcnJvcicpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghIGppZCkgewogICAgICAgICAgICAgICAgICAgIGVycm9ycyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgJGppZF9pbnB1dC5hZGRDbGFzcygnZXJyb3InKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghIHBhc3N3b3JkKSAgewogICAgICAgICAgICAgICAgICAgIGVycm9ycyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgJHB3X2lucHV0LmFkZENsYXNzKCdlcnJvcicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9ycykgeyByZXR1cm47IH0KICAgICAgICAgICAgICAgIHRoaXMuY29ubmVjdCgkZm9ybSwgamlkLCBwYXNzd29yZCk7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMuJHRhYnMuZW1wdHkoKTsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLnBhcmVudCgpLmVtcHR5KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5Db250cm9sQm94VG9nZ2xlID0gQmFja2JvbmUuVmlldy5leHRlbmQoewogICAgICAgICAgICB0YWdOYW1lOiAnYScsCiAgICAgICAgICAgIGNsYXNzTmFtZTogJ3RvZ2dsZS1jb250cm9sYm94JywKICAgICAgICAgICAgaWQ6ICd0b2dnbGUtY29udHJvbGJveCcsCiAgICAgICAgICAgIGV2ZW50czogewogICAgICAgICAgICAgICAgJ2NsaWNrJzogJ29uQ2xpY2snCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGF0dHJpYnV0ZXM6IHsKICAgICAgICAgICAgICAgICdocmVmJzogIiMiCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcigpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAkKCcjY29udmVyc2VqcycpLnByZXBlbmQodGhpcy4kZWwuaHRtbCgKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS50ZW1wbGF0ZXMuY29udHJvbGJveF90b2dnbGUoewogICAgICAgICAgICAgICAgICAgICAgICAnbGFiZWxfdG9nZ2xlJzogX18oJ1RvZ2dsZSBjaGF0JykKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgKSk7CiAgICAgICAgICAgICAgICAvLyBXZSBsZXQgdGhlIHJlbmRlciBtZXRob2Qgb2YgQ29udHJvbEJveFZpZXcgZGVjaWRlIHdoZXRoZXIKICAgICAgICAgICAgICAgIC8vIHRoZSBDb250cm9sQm94IG9yIHRoZSBUb2dnbGUgbXVzdCBiZSBzaG93bi4gVGhpcyBwcmV2ZW50cwogICAgICAgICAgICAgICAgLy8gYXJ0aWZhY3RzIChpLmUuIG9uIHBhZ2UgbG9hZCB0aGUgdG9nZ2xlIGlzIHNob3duIG9ubHkgdG8gdGhlbgogICAgICAgICAgICAgICAgLy8gc2Vjb25kcyBsYXRlciBiZSBoaWRkZW4gaW4gZmF2b3Igb2YgdGhlIGNvbnRyb2wgYm94KS4KICAgICAgICAgICAgICAgIHRoaXMuJGVsLmhpZGUoKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaGlkZTogZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5mYWRlT3V0KCdmYXN0JywgY2FsbGJhY2spOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2hvdzogZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5zaG93KCdmYXN0JywgY2FsbGJhY2spOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2hvd0NvbnRyb2xCb3g6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBjb250cm9sYm94ID0gY29udmVyc2UuY2hhdGJveGVzLmdldCgnY29udHJvbGJveCcpOwogICAgICAgICAgICAgICAgaWYgKCFjb250cm9sYm94KSB7CiAgICAgICAgICAgICAgICAgICAgY29udHJvbGJveCA9IGNvbnZlcnNlLmFkZENvbnRyb2xCb3goKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChjb252ZXJzZS5jb25uZWN0aW9uLmNvbm5lY3RlZCkgewogICAgICAgICAgICAgICAgICAgIGNvbnRyb2xib3guc2F2ZSh7Y2xvc2VkOiBmYWxzZX0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb250cm9sYm94LnRyaWdnZXIoJ3Nob3cnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG9uQ2xpY2s6IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBpZiAoJCgiZGl2I2NvbnRyb2xib3giKS5pcygnOnZpc2libGUnKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBjb250cm9sYm94ID0gY29udmVyc2UuY2hhdGJveGVzLmdldCgnY29udHJvbGJveCcpOwogICAgICAgICAgICAgICAgICAgIGlmIChjb252ZXJzZS5jb25uZWN0aW9uLmNvbm5lY3RlZCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sYm94LnNhdmUoe2Nsb3NlZDogdHJ1ZX0pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xib3gudHJpZ2dlcignaGlkZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93Q29udHJvbEJveCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuYWRkQ29udHJvbEJveCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2hhdGJveGVzLmFkZCh7CiAgICAgICAgICAgICAgICBpZDogJ2NvbnRyb2xib3gnLAogICAgICAgICAgICAgICAgYm94X2lkOiAnY29udHJvbGJveCcsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IHRoaXMuZGVmYXVsdF9ib3hfaGVpZ2h0LAogICAgICAgICAgICAgICAgY2xvc2VkOiAhdGhpcy5zaG93X2NvbnRyb2xib3hfYnlfZGVmYXVsdAogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLmluaXRDb25uZWN0aW9uID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgcmlkLCBzaWQsIGppZDsKICAgICAgICAgICAgaWYgKHRoaXMuY29ubmVjdGlvbiAmJiB0aGlzLmNvbm5lY3Rpb24uY29ubmVjdGVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9uQ29ubmVjdGVkKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBYWFg6IGl0J3Mgbm90IHlldCBjbGVhciB3aGF0IHRoZSBvcmRlciBvZiBwcmVmZXJlbmNlIHNob3VsZAogICAgICAgICAgICAgICAgLy8gYmUgYmV0d2VlbiBSSUQgYW5kIFNJRCByZWNlaXZlZCB2aWEgdGhlIGluaXRpYWxpemUgbWV0aG9kIG9yCiAgICAgICAgICAgICAgICAvLyB0aG9zZSByZWNlaXZlZCBmcm9tIHNlc3Npb25TdG9yYWdlLgogICAgICAgICAgICAgICAgLy8KICAgICAgICAgICAgICAgIC8vIFdoYXQgZG8geW91IHdlIGlmIHdlIHJlY2VpdmUgdmFsdWVzIGZyb20gYm90aCBhdmVudWVzPwogICAgICAgICAgICAgICAgLy8KICAgICAgICAgICAgICAgIC8vIEFsc28sIHdoYXQgZG8gd2UgZG8gd2hlbiB0aGUga2VlcGFsaXZlIHNlc3Npb24gdmFsdWVzIGFyZQogICAgICAgICAgICAgICAgLy8gZXhwaXJlZD8gRG8gd2UgdHJ5IHRvIGZhbGwgYmFjaz8KICAgICAgICAgICAgICAgIGlmICghdGhpcy5ib3NoX3NlcnZpY2VfdXJsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3coIkVycm9yOiB5b3UgbXVzdCBzdXBwbHkgYSB2YWx1ZSBmb3IgdGhlIGJvc2hfc2VydmljZV91cmwiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbiA9IG5ldyBTdHJvcGhlLkNvbm5lY3Rpb24odGhpcy5ib3NoX3NlcnZpY2VfdXJsKTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5wcmViaW5kKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuamlkICYmIHRoaXMuc2lkICYmIHRoaXMucmlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbi5hdHRhY2godGhpcy5qaWQsIHRoaXMuc2lkLCB0aGlzLnJpZCwgdGhpcy5vbkNvbm5lY3QpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMua2VlcGFsaXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93KCJJZiB5b3UgdXNlIHByZWJpbmQgYW5kIGRvbid0IHVzZSBrZWVwYWxpdmUsICIrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aGVuIHlvdSBNVVNUIHN1cHBseSBKSUQsIFJJRCBhbmQgU0lEIHZhbHVlcyIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0aGlzLmtlZXBhbGl2ZSkgewogICAgICAgICAgICAgICAgICAgIHJpZCA9IHRoaXMuc2Vzc2lvbi5nZXQoJ3JpZCcpOwogICAgICAgICAgICAgICAgICAgIHNpZCA9IHRoaXMuc2Vzc2lvbi5nZXQoJ3NpZCcpOwogICAgICAgICAgICAgICAgICAgIGppZCA9IHRoaXMuc2Vzc2lvbi5nZXQoJ2ppZCcpOwogICAgICAgICAgICAgICAgICAgIGlmIChyaWQgJiYgamlkICYmIHNpZCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlc3Npb24uc2F2ZSh7cmlkOiByaWR9KTsgLy8gVGhlIFJJRCBuZWVkcyB0byBiZSBpbmNyZWFzZWQgd2l0aCBlYWNoIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbi5hdHRhY2goamlkLCBzaWQsIHJpZCwgdGhpcy5vbkNvbm5lY3QpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5wcmViaW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNvbm5lY3Rpb247CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgnbm9SZXN1bWVhYmxlU2Vzc2lvbicpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHRoaXMuX3RlYXJEb3duID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvKiBSZW1vdmUgdGhvc2Ugdmlld3Mgd2hpY2ggYXJlIG9ubHkgYWxsb3dlZCB3aXRoIGEgdmFsaWQKICAgICAgICAgICAgICogY29ubmVjdGlvbi4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHRoaXMuaW5pdGlhbF9wcmVzZW5jZV9zZW50ID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMucm9zdGVyLm9mZigpLnJlc2V0KCk7IC8vIFJlbW92ZXMgcm9zdGVyIGNvbnRhY3RzCiAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbi5yb3N0ZXIuX2NhbGxiYWNrcyA9IFtdOyAvLyBSZW1vdmUgYWxsIFJvc3RlciBoYW5kbGVycyAoZS5nLiByb3N0ZXJIYW5kbGVyKQogICAgICAgICAgICB0aGlzLnJvc3RlcnZpZXcubW9kZWwub2ZmKCkucmVzZXQoKTsgLy8gUmVtb3ZlcyByb3N0ZXIgZ3JvdXBzCiAgICAgICAgICAgIHRoaXMucm9zdGVydmlldy51bmRlbGVnYXRlRXZlbnRzKCkucmVtb3ZlKCk7CiAgICAgICAgICAgIHRoaXMuY2hhdGJveGVzLnJlbW92ZSgpOyAvLyBEb24ndCBjYWxsIG9mZigpLCBldmVudHMgd29uJ3QgZ2V0IHJlLXJlZ2lzdGVyZWQgdXBvbiByZWNvbm5lY3QuCiAgICAgICAgICAgIGlmICh0aGlzLmZlYXR1cmVzKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZlYXR1cmVzLnJlc2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMubWluaW1pemVkX2NoYXRzKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1pbmltaXplZF9jaGF0cy51bmRlbGVnYXRlRXZlbnRzKCkubW9kZWwucmVzZXQoKTsKICAgICAgICAgICAgICAgIHRoaXMubWluaW1pemVkX2NoYXRzLnJlbW92ZUFsbCgpOyAvLyBSZW1vdmUgc3ViLXZpZXdzCiAgICAgICAgICAgICAgICB0aGlzLm1pbmltaXplZF9jaGF0cy50ZWFyRG93bigpLnJlbW92ZSgpOyAvLyBSZW1vdmUgb3ZlcnZpZXcKICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm1pbmltaXplZF9jaGF0czsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwoKICAgICAgICB0aGlzLl9pbml0aWFsaXplID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLmNoYXRib3hlcyA9IG5ldyB0aGlzLkNoYXRCb3hlcygpOwogICAgICAgICAgICB0aGlzLmNoYXRib3h2aWV3cyA9IG5ldyB0aGlzLkNoYXRCb3hWaWV3cyh7bW9kZWw6IHRoaXMuY2hhdGJveGVzfSk7CiAgICAgICAgICAgIHRoaXMuY29udHJvbGJveHRvZ2dsZSA9IG5ldyB0aGlzLkNvbnRyb2xCb3hUb2dnbGUoKTsKICAgICAgICAgICAgdGhpcy5vdHIgPSBuZXcgdGhpcy5PVFIoKTsKICAgICAgICAgICAgdGhpcy5pbml0U2Vzc2lvbigpOwogICAgICAgICAgICB0aGlzLmluaXRDb25uZWN0aW9uKCk7CiAgICAgICAgICAgIGlmICh0aGlzLmNvbm5lY3Rpb24pIHsKICAgICAgICAgICAgICAgIHRoaXMuYWRkQ29udHJvbEJveCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CgogICAgICAgIHRoaXMuX2luaXRpYWxpemVQbHVnaW5zID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBfLmVhY2godGhpcy5wbHVnaW5zLCAkLnByb3h5KGZ1bmN0aW9uIChwbHVnaW4pIHsKICAgICAgICAgICAgICAgICQucHJveHkocGx1Z2luLCB0aGlzKSh0aGlzKTsKICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgIH07CgogICAgICAgIC8vIEluaXRpYWxpemF0aW9uCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0KICAgICAgICAvLyBUaGlzIGlzIHRoZSBlbmQgb2YgdGhlIGluaXRpYWxpemUgbWV0aG9kLgogICAgICAgIHRoaXMuX2luaXRpYWxpemVQbHVnaW5zKCk7CiAgICAgICAgdGhpcy5faW5pdGlhbGl6ZSgpOwogICAgICAgIHRoaXMucmVnaXN0ZXJHbG9iYWxFdmVudEhhbmRsZXJzKCk7CiAgICAgICAgY29udmVyc2UuZW1pdCgnaW5pdGlhbGl6ZWQnKTsKICAgIH07CgogICAgdmFyIHdyYXBwZWRDaGF0Qm94ID0gZnVuY3Rpb24gKGNoYXRib3gpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAnZW5kT1RSJzogJC5wcm94eShjaGF0Ym94LmVuZE9UUiwgY2hhdGJveCksCiAgICAgICAgICAgICdnZXQnOiAkLnByb3h5KGNoYXRib3guZ2V0LCBjaGF0Ym94KSwKICAgICAgICAgICAgJ2luaXRpYXRlT1RSJzogJC5wcm94eShjaGF0Ym94LmluaXRpYXRlT1RSLCBjaGF0Ym94KSwKICAgICAgICAgICAgJ21heGltaXplJzogJC5wcm94eShjaGF0Ym94Lm1heGltaXplLCBjaGF0Ym94KSwKICAgICAgICAgICAgJ21pbmltaXplJzogJC5wcm94eShjaGF0Ym94Lm1pbmltaXplLCBjaGF0Ym94KSwKICAgICAgICAgICAgJ3NldCc6ICQucHJveHkoY2hhdGJveC5zZXQsIGNoYXRib3gpCiAgICAgICAgfTsKICAgIH07CiAgICByZXR1cm4gewogICAgICAgICdnZXRCdWRkeSc6IGZ1bmN0aW9uIChqaWQpIHsKICAgICAgICAgICAgdmFyIGNvbnRhY3QgPSBjb252ZXJzZS5yb3N0ZXIuZ2V0KFN0cm9waGUuZ2V0QmFyZUppZEZyb21KaWQoamlkKSk7CiAgICAgICAgICAgIGlmIChjb250YWN0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY29udGFjdC5hdHRyaWJ1dGVzOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAnZ2V0Q2hhdEJveCc6IGZ1bmN0aW9uIChqaWQpIHsKICAgICAgICAgICAgdmFyIGNoYXRib3ggPSBjb252ZXJzZS5jaGF0Ym94ZXMuZ2V0KGppZCk7CiAgICAgICAgICAgIGlmIChjaGF0Ym94KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gd3JhcHBlZENoYXRCb3goY2hhdGJveCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICdnZXRSSUQnOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmIChjb252ZXJzZS5leHBvc2VfcmlkX2FuZF9zaWQgJiYgdHlwZW9mIGNvbnZlcnNlLmNvbm5lY3Rpb24gIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY29udmVyc2UuY29ubmVjdGlvbi5yaWQgfHwgY29udmVyc2UuY29ubmVjdGlvbi5fcHJvdG8ucmlkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0sCiAgICAgICAgJ2dldFNJRCc6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKGNvbnZlcnNlLmV4cG9zZV9yaWRfYW5kX3NpZCAmJiB0eXBlb2YgY29udmVyc2UuY29ubmVjdGlvbiAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjb252ZXJzZS5jb25uZWN0aW9uLnNpZCB8fCBjb252ZXJzZS5jb25uZWN0aW9uLl9wcm90by5zaWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfSwKICAgICAgICAnaW5pdGlhbGl6ZSc6IGZ1bmN0aW9uIChzZXR0aW5ncywgY2FsbGJhY2spIHsKICAgICAgICAgICAgY29udmVyc2UuaW5pdGlhbGl6ZShzZXR0aW5ncywgY2FsbGJhY2spOwogICAgICAgIH0sCiAgICAgICAgJ2pRdWVyeSc6ICQsCiAgICAgICAgJ29wZW5DaGF0Qm94JzogZnVuY3Rpb24gKGppZCkgewogICAgICAgICAgICB2YXIgY29udGFjdCA9IGNvbnZlcnNlLnJvc3Rlci5nZXQoU3Ryb3BoZS5nZXRCYXJlSmlkRnJvbUppZChqaWQpKTsKICAgICAgICAgICAgaWYgKGNvbnRhY3QpIHsKICAgICAgICAgICAgICAgIHJldHVybiB3cmFwcGVkQ2hhdEJveChjb252ZXJzZS5jaGF0Ym94dmlld3Muc2hvd0NoYXQoY29udGFjdC5hdHRyaWJ1dGVzKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICdvbmNlJzogZnVuY3Rpb24gKGV2dCwgaGFuZGxlcikgewogICAgICAgICAgICBjb252ZXJzZS5vbmNlKGV2dCwgaGFuZGxlcik7CiAgICAgICAgfSwKICAgICAgICAnb24nOiBmdW5jdGlvbiAoZXZ0LCBoYW5kbGVyKSB7CiAgICAgICAgICAgIGNvbnZlcnNlLm9uKGV2dCwgaGFuZGxlcik7CiAgICAgICAgfSwKICAgICAgICAnb2ZmJzogZnVuY3Rpb24gKGV2dCwgaGFuZGxlcikgewogICAgICAgICAgICBjb252ZXJzZS5vZmYoZXZ0LCBoYW5kbGVyKTsKICAgICAgICB9LAogICAgICAgICdyZWdpc3RlclBsdWdpbic6IGZ1bmN0aW9uIChuYW1lLCBjYWxsYmFjaykgewogICAgICAgICAgICBjb252ZXJzZS5wbHVnaW5zW25hbWVdID0gY2FsbGJhY2s7CiAgICAgICAgfQogICAgfTsKfSkpOwoKcmVxdWlyZS5jb25maWcoewogICAgYmFzZVVybDogJy4nLAogICAgcGF0aHM6IHsKICAgICAgICAiYmFja2JvbmUiOiAgICAgICAgICAgICAgICAgImNvbXBvbmVudHMvYmFja2JvbmUvYmFja2JvbmUiLAogICAgICAgICJiYWNrYm9uZS5icm93c2VyU3RvcmFnZSI6ICAiY29tcG9uZW50cy9iYWNrYm9uZS5icm93c2VyU3RvcmFnZS9iYWNrYm9uZS5icm93c2VyU3RvcmFnZSIsCiAgICAgICAgImJhY2tib25lLm92ZXJ2aWV3IjogICAgICAgICJjb21wb25lbnRzL2JhY2tib25lLm92ZXJ2aWV3L2JhY2tib25lLm92ZXJ2aWV3IiwKICAgICAgICAiYm9vdHN0cmFwIjogICAgICAgICAgICAgICAgImNvbXBvbmVudHMvYm9vdHN0cmFwL2Rpc3QvanMvYm9vdHN0cmFwIiwgICAgICAgICAgIC8vIFhYWDogT25seSByZXF1aXJlZCBmb3IgaHR0cHM6Ly9jb252ZXJzZWpzLm9yZyB3ZWJzaXRlCiAgICAgICAgImJvb3RzdHJhcEpTIjogICAgICAgICAgICAgICJjb21wb25lbnRzL2Jvb3RzdHJhcEpTL2luZGV4IiwgICAgICAgICAgICAgICAgICAgICAvLyBYWFg6IE9ubHkgcmVxdWlyZWQgZm9yIGh0dHBzOi8vY29udmVyc2Vqcy5vcmcgd2Vic2l0ZQogICAgICAgICJjb252ZXJzZS1kZXBlbmRlbmNpZXMiOiAgICAic3JjL2RlcHMtd2Vic2l0ZSIsCiAgICAgICAgImNvbnZlcnNlLXRlbXBsYXRlcyI6ICAgICAgICJzcmMvdGVtcGxhdGVzIiwKICAgICAgICAiZXZlbnRlbWl0dGVyIjogICAgICAgICAgICAgImNvbXBvbmVudHMvb3RyL2J1aWxkL2RlcC9ldmVudGVtaXR0ZXIiLAogICAgICAgICJqcXVlcnkiOiAgICAgICAgICAgICAgICAgICAiY29tcG9uZW50cy9qcXVlcnkvZGlzdC9qcXVlcnkiLAogICAgICAgICJqcXVlcnktcHJpdmF0ZSI6ICAgICAgICAgICAic3JjL2pxdWVyeS1wcml2YXRlIiwKICAgICAgICAianF1ZXJ5LmJyb3dzZXIiOiAgICAgICAgICAgImNvbXBvbmVudHMvanF1ZXJ5LmJyb3dzZXIvaW5kZXgiLAogICAgICAgICJqcXVlcnkuZWFzaW5nIjogICAgICAgICAgICAiY29tcG9uZW50cy9qcXVlcnktZWFzaW5nLW9yaWdpbmFsL2luZGV4IiwgICAgICAgICAgLy8gWFhYOiBPbmx5IHJlcXVpcmVkIGZvciBodHRwczovL2NvbnZlcnNlanMub3JnIHdlYnNpdGUKICAgICAgICAibW9tZW50IjogICAgICAgICAgICAgICAgICAgImNvbXBvbmVudHMvbW9tZW50anMvbW9tZW50IiwKICAgICAgICAic3Ryb3BoZSI6ICAgICAgICAgICAgICAgICAgImNvbXBvbmVudHMvc3Ryb3BoZS9zdHJvcGhlIiwKICAgICAgICAic3Ryb3BoZS5kaXNjbyI6ICAgICAgICAgICAgImNvbXBvbmVudHMvc3Ryb3BoZWpzLXBsdWdpbnMvZGlzY28vc3Ryb3BoZS5kaXNjbyIsCiAgICAgICAgInN0cm9waGUubXVjIjogICAgICAgICAgICAgICJjb21wb25lbnRzL3N0cm9waGUubXVjL2luZGV4IiwKICAgICAgICAic3Ryb3BoZS5yb3N0ZXIiOiAgICAgICAgICAgInNyYy9zdHJvcGhlLnJvc3RlciIsCiAgICAgICAgInN0cm9waGUudmNhcmQiOiAgICAgICAgICAgICJjb21wb25lbnRzL3N0cm9waGVqcy1wbHVnaW5zL3ZjYXJkL3N0cm9waGUudmNhcmQiLAogICAgICAgICJ0ZXh0IjogICAgICAgICAgICAgICAgICAgICAnY29tcG9uZW50cy9yZXF1aXJlanMtdGV4dC90ZXh0JywKICAgICAgICAidHBsIjogICAgICAgICAgICAgICAgICAgICAgJ2NvbXBvbmVudHMvcmVxdWlyZWpzLXRwbC1qY2JyYW5kL3RwbCcsCiAgICAgICAgInR5cGVhaGVhZCI6ICAgICAgICAgICAgICAgICJjb21wb25lbnRzL3R5cGVhaGVhZC5qcy9pbmRleCIsCiAgICAgICAgInVuZGVyc2NvcmUiOiAgICAgICAgICAgICAgICJjb21wb25lbnRzL3VuZGVyc2NvcmUvdW5kZXJzY29yZSIsCiAgICAgICAgInV0aWxzIjogICAgICAgICAgICAgICAgICAgICJzcmMvdXRpbHMiLAoKICAgICAgICAvLyBPZmYtdGhlLXJlY29yZC1lbmNyeXB0aW9uCiAgICAgICAgImJpZ2ludCI6ICAgICAgICAgICAgICAgInNyYy9iaWdpbnQiLAogICAgICAgICJjcnlwdG8iOiAgICAgICAgICAgICAgICJzcmMvY3J5cHRvIiwKICAgICAgICAiY3J5cHRvLmFlcyI6ICAgICAgICAgICAiY29tcG9uZW50cy9vdHIvdmVuZG9yL2NyeXB0b2pzL2FlcyIsCiAgICAgICAgImNyeXB0by5jaXBoZXItY29yZSI6ICAgImNvbXBvbmVudHMvb3RyL3ZlbmRvci9jcnlwdG9qcy9jaXBoZXItY29yZSIsCiAgICAgICAgImNyeXB0by5jb3JlIjogICAgICAgICAgImNvbXBvbmVudHMvb3RyL3ZlbmRvci9jcnlwdG9qcy9jb3JlIiwKICAgICAgICAiY3J5cHRvLmVuYy1iYXNlNjQiOiAgICAiY29tcG9uZW50cy9vdHIvdmVuZG9yL2NyeXB0b2pzL2VuYy1iYXNlNjQiLAogICAgICAgICJjcnlwdG8uZXZwa2RmIjogICAgICAgICJjb21wb25lbnRzL2NyeXB0by1qcy1ldmFudm9zYmVyZy9zcmMvZXZwa2RmIiwKICAgICAgICAiY3J5cHRvLmhtYWMiOiAgICAgICAgICAiY29tcG9uZW50cy9vdHIvdmVuZG9yL2NyeXB0b2pzL2htYWMiLAogICAgICAgICJjcnlwdG8ubWQ1IjogICAgICAgICAgICJjb21wb25lbnRzL2NyeXB0by1qcy1ldmFudm9zYmVyZy9zcmMvbWQ1IiwKICAgICAgICAiY3J5cHRvLm1vZGUtY3RyIjogICAgICAiY29tcG9uZW50cy9vdHIvdmVuZG9yL2NyeXB0b2pzL21vZGUtY3RyIiwKICAgICAgICAiY3J5cHRvLnBhZC1ub3BhZGRpbmciOiAiY29tcG9uZW50cy9vdHIvdmVuZG9yL2NyeXB0b2pzL3BhZC1ub3BhZGRpbmciLAogICAgICAgICJjcnlwdG8uc2hhMSI6ICAgICAgICAgImNvbXBvbmVudHMvb3RyL3ZlbmRvci9jcnlwdG9qcy9zaGExIiwKICAgICAgICAiY3J5cHRvLnNoYTI1NiI6ICAgICAgICAiY29tcG9uZW50cy9vdHIvdmVuZG9yL2NyeXB0b2pzL3NoYTI1NiIsCiAgICAgICAgInNhbHNhMjAiOiAgICAgICAgICAgICAgImNvbXBvbmVudHMvb3RyL2J1aWxkL2RlcC9zYWxzYTIwIiwKICAgICAgICAib3RyIjogICAgICAgICAgICAgICAgICAic3JjL290ciIsCgogICAgICAgIC8vIExvY2FsZXMgcGF0aHMKICAgICAgICAibG9jYWxlcyI6ICAgImxvY2FsZS9sb2NhbGVzIiwKICAgICAgICAiamVkIjogICAgICAgImNvbXBvbmVudHMvamVkL2plZCIsCiAgICAgICAgImFmIjogICAgICAgICJsb2NhbGUvYWYvTENfTUVTU0FHRVMvYWYiLAogICAgICAgICJkZSI6ICAgICAgICAibG9jYWxlL2RlL0xDX01FU1NBR0VTL2RlIiwKICAgICAgICAiZW4iOiAgICAgICAgImxvY2FsZS9lbi9MQ19NRVNTQUdFUy9lbiIsCiAgICAgICAgImVzIjogICAgICAgICJsb2NhbGUvZXMvTENfTUVTU0FHRVMvZXMiLAogICAgICAgICJmciI6ICAgICAgICAibG9jYWxlL2ZyL0xDX01FU1NBR0VTL2ZyIiwKICAgICAgICAiaGUiOiAgICAgICAgImxvY2FsZS9oZS9MQ19NRVNTQUdFUy9oZSIsCiAgICAgICAgImh1IjogICAgICAgICJsb2NhbGUvaHUvTENfTUVTU0FHRVMvaHUiLAogICAgICAgICJpZCI6ICAgICAgICAibG9jYWxlL2lkL0xDX01FU1NBR0VTL2lkIiwKICAgICAgICAiaXQiOiAgICAgICAgImxvY2FsZS9pdC9MQ19NRVNTQUdFUy9pdCIsCiAgICAgICAgImphIjogICAgICAgICJsb2NhbGUvamEvTENfTUVTU0FHRVMvamEiLAogICAgICAgICJubCI6ICAgICAgICAibG9jYWxlL25sL0xDX01FU1NBR0VTL25sIiwKICAgICAgICAicHRfQlIiOiAgICAgImxvY2FsZS9wdF9CUi9MQ19NRVNTQUdFUy9wdF9CUiIsCiAgICAgICAgInJ1IjogICAgICAgICJsb2NhbGUvcnUvTENfTUVTU0FHRVMvcnUiLAogICAgICAgICJ6aCI6ICAgICAgICAibG9jYWxlL3poL0xDX01FU1NBR0VTL3poIiwKCiAgICAgICAgLy8gVGVtcGxhdGVzCiAgICAgICAgImFjdGlvbiI6ICAgICAgICAgICAgICAgICAgICJzcmMvdGVtcGxhdGVzL2FjdGlvbiIsCiAgICAgICAgImFkZF9jb250YWN0X2Ryb3Bkb3duIjogICAgICJzcmMvdGVtcGxhdGVzL2FkZF9jb250YWN0X2Ryb3Bkb3duIiwKICAgICAgICAiYWRkX2NvbnRhY3RfZm9ybSI6ICAgICAgICAgInNyYy90ZW1wbGF0ZXMvYWRkX2NvbnRhY3RfZm9ybSIsCiAgICAgICAgImNoYW5nZV9zdGF0dXNfbWVzc2FnZSI6ICAgICJzcmMvdGVtcGxhdGVzL2NoYW5nZV9zdGF0dXNfbWVzc2FnZSIsCiAgICAgICAgImNoYXRfc3RhdHVzIjogICAgICAgICAgICAgICJzcmMvdGVtcGxhdGVzL2NoYXRfc3RhdHVzIiwKICAgICAgICAiY2hhdGFyZWEiOiAgICAgICAgICAgICAgICAgInNyYy90ZW1wbGF0ZXMvY2hhdGFyZWEiLAogICAgICAgICJjaGF0Ym94IjogICAgICAgICAgICAgICAgICAic3JjL3RlbXBsYXRlcy9jaGF0Ym94IiwKICAgICAgICAiY2hhdHJvb20iOiAgICAgICAgICAgICAgICAgInNyYy90ZW1wbGF0ZXMvY2hhdHJvb20iLAogICAgICAgICJjaGF0cm9vbV9wYXNzd29yZF9mb3JtIjogICAic3JjL3RlbXBsYXRlcy9jaGF0cm9vbV9wYXNzd29yZF9mb3JtIiwKICAgICAgICAiY2hhdHJvb21fc2lkZWJhciI6ICAgICAgICAgInNyYy90ZW1wbGF0ZXMvY2hhdHJvb21fc2lkZWJhciIsCiAgICAgICAgImNoYXRyb29tc190YWIiOiAgICAgICAgICAgICJzcmMvdGVtcGxhdGVzL2NoYXRyb29tc190YWIiLAogICAgICAgICJjaGF0c19wYW5lbCI6ICAgICAgICAgICAgICAic3JjL3RlbXBsYXRlcy9jaGF0c19wYW5lbCIsCiAgICAgICAgImNob29zZV9zdGF0dXMiOiAgICAgICAgICAgICJzcmMvdGVtcGxhdGVzL2Nob29zZV9zdGF0dXMiLAogICAgICAgICJjb250YWN0c19wYW5lbCI6ICAgICAgICAgICAic3JjL3RlbXBsYXRlcy9jb250YWN0c19wYW5lbCIsCiAgICAgICAgImNvbnRhY3RzX3RhYiI6ICAgICAgICAgICAgICJzcmMvdGVtcGxhdGVzL2NvbnRhY3RzX3RhYiIsCiAgICAgICAgImNvbnRyb2xib3giOiAgICAgICAgICAgICAgICJzcmMvdGVtcGxhdGVzL2NvbnRyb2xib3giLAogICAgICAgICJjb250cm9sYm94X3RvZ2dsZSI6ICAgICAgICAic3JjL3RlbXBsYXRlcy9jb250cm9sYm94X3RvZ2dsZSIsCiAgICAgICAgImZpZWxkIjogICAgICAgICAgICAgICAgICAgICJzcmMvdGVtcGxhdGVzL2ZpZWxkIiwKICAgICAgICAiZm9ybV9jaGVja2JveCI6ICAgICAgICAgICAgInNyYy90ZW1wbGF0ZXMvZm9ybV9jaGVja2JveCIsCiAgICAgICAgImZvcm1faW5wdXQiOiAgICAgICAgICAgICAgICJzcmMvdGVtcGxhdGVzL2Zvcm1faW5wdXQiLAogICAgICAgICJmb3JtX3NlbGVjdCI6ICAgICAgICAgICAgICAic3JjL3RlbXBsYXRlcy9mb3JtX3NlbGVjdCIsCiAgICAgICAgImdyb3VwX2hlYWRlciI6ICAgICAgICAgICAgICJzcmMvdGVtcGxhdGVzL2dyb3VwX2hlYWRlciIsCiAgICAgICAgImluZm8iOiAgICAgICAgICAgICAgICAgICAgICJzcmMvdGVtcGxhdGVzL2luZm8iLAogICAgICAgICJsb2dpbl9wYW5lbCI6ICAgICAgICAgICAgICAic3JjL3RlbXBsYXRlcy9sb2dpbl9wYW5lbCIsCiAgICAgICAgImxvZ2luX3RhYiI6ICAgICAgICAgICAgICAgICJzcmMvdGVtcGxhdGVzL2xvZ2luX3RhYiIsCiAgICAgICAgIm1lc3NhZ2UiOiAgICAgICAgICAgICAgICAgICJzcmMvdGVtcGxhdGVzL21lc3NhZ2UiLAogICAgICAgICJuZXdfZGF5IjogICAgICAgICAgICAgICAgICAic3JjL3RlbXBsYXRlcy9uZXdfZGF5IiwKICAgICAgICAib2NjdXBhbnQiOiAgICAgICAgICAgICAgICAgInNyYy90ZW1wbGF0ZXMvb2NjdXBhbnQiLAogICAgICAgICJwZW5kaW5nX2NvbnRhY3QiOiAgICAgICAgICAic3JjL3RlbXBsYXRlcy9wZW5kaW5nX2NvbnRhY3QiLAogICAgICAgICJwZW5kaW5nX2NvbnRhY3RzIjogICAgICAgICAic3JjL3RlbXBsYXRlcy9wZW5kaW5nX2NvbnRhY3RzIiwKICAgICAgICAicmVxdWVzdGluZ19jb250YWN0IjogICAgICAgInNyYy90ZW1wbGF0ZXMvcmVxdWVzdGluZ19jb250YWN0IiwKICAgICAgICAicmVxdWVzdGluZ19jb250YWN0cyI6ICAgICAgInNyYy90ZW1wbGF0ZXMvcmVxdWVzdGluZ19jb250YWN0cyIsCiAgICAgICAgInJvb21fZGVzY3JpcHRpb24iOiAgICAgICAgICJzcmMvdGVtcGxhdGVzL3Jvb21fZGVzY3JpcHRpb24iLAogICAgICAgICJyb29tX2l0ZW0iOiAgICAgICAgICAgICAgICAic3JjL3RlbXBsYXRlcy9yb29tX2l0ZW0iLAogICAgICAgICJyb29tX3BhbmVsIjogICAgICAgICAgICAgICAic3JjL3RlbXBsYXRlcy9yb29tX3BhbmVsIiwKICAgICAgICAicm9zdGVyIjogICAgICAgICAgICAgICAgICAgInNyYy90ZW1wbGF0ZXMvcm9zdGVyIiwKICAgICAgICAicm9zdGVyX2l0ZW0iOiAgICAgICAgICAgICAgInNyYy90ZW1wbGF0ZXMvcm9zdGVyX2l0ZW0iLAogICAgICAgICJzZWFyY2hfY29udGFjdCI6ICAgICAgICAgICAic3JjL3RlbXBsYXRlcy9zZWFyY2hfY29udGFjdCIsCiAgICAgICAgInNlbGVjdF9vcHRpb24iOiAgICAgICAgICAgICJzcmMvdGVtcGxhdGVzL3NlbGVjdF9vcHRpb24iLAogICAgICAgICJzdGF0dXNfb3B0aW9uIjogICAgICAgICAgICAic3JjL3RlbXBsYXRlcy9zdGF0dXNfb3B0aW9uIiwKICAgICAgICAidG9nZ2xlX2NoYXRzIjogICAgICAgICAgICAgInNyYy90ZW1wbGF0ZXMvdG9nZ2xlX2NoYXRzIiwKICAgICAgICAidG9vbGJhciI6ICAgICAgICAgICAgICAgICAgInNyYy90ZW1wbGF0ZXMvdG9vbGJhciIsCiAgICAgICAgInRyaW1tZWRfY2hhdCI6ICAgICAgICAgICAgICJzcmMvdGVtcGxhdGVzL3RyaW1tZWRfY2hhdCIKICAgIH0sCgogICAgbWFwOiB7CiAgICAgICAgLy8gJyonIG1lYW5zIGFsbCBtb2R1bGVzIHdpbGwgZ2V0ICdqcXVlcnktcHJpdmF0ZScKICAgICAgICAvLyBmb3IgdGhlaXIgJ2pxdWVyeScgZGVwZW5kZW5jeS4KICAgICAgICAnKic6IHsgJ2pxdWVyeSc6ICdqcXVlcnktcHJpdmF0ZScgfSwKICAgICAgICAvLyAnanF1ZXJ5LXByaXZhdGUnIHdhbnRzIHRoZSByZWFsIGpRdWVyeSBtb2R1bGUKICAgICAgICAvLyB0aG91Z2guIElmIHRoaXMgbGluZSB3YXMgbm90IGhlcmUsIHRoZXJlIHdvdWxkCiAgICAgICAgLy8gYmUgYW4gdW5yZXNvbHZhYmxlIGN5Y2xpYyBkZXBlbmRlbmN5LgogICAgICAgICdqcXVlcnktcHJpdmF0ZSc6IHsgJ2pxdWVyeSc6ICdqcXVlcnknIH0KICAgIH0sCgogICAgdHBsOiB7CiAgICAgICAgLy8gQ29uZmlndXJhdGlvbiBmb3IgcmVxdWlyZWpzLXRwbAogICAgICAgIC8vIFVzZSBNdXN0YWNoZSBzdHlsZSBzeW50YXggZm9yIHZhcmlhYmxlIGludGVycG9sYXRpb24KICAgICAgICB0ZW1wbGF0ZVNldHRpbmdzOiB7CiAgICAgICAgICAgIGV2YWx1YXRlIDogL1x7XFsoW1xzXFNdKz8pXF1cfS9nLAogICAgICAgICAgICBpbnRlcnBvbGF0ZSA6IC9ce1x7KFtcc1xTXSs/KVx9XH0vZwogICAgICAgIH0KICAgIH0sCgogICAgLy8gZGVmaW5lIG1vZHVsZSBkZXBlbmRlbmNpZXMgZm9yIG1vZHVsZXMgbm90IHVzaW5nIGRlZmluZQogICAgc2hpbTogewogICAgICAgICd1bmRlcnNjb3JlJzogICAgICAgICAgIHsgZXhwb3J0czogJ18nIH0sCiAgICAgICAgJ2NyeXB0by5hZXMnOiAgICAgICAgICAgeyBkZXBzOiBbJ2NyeXB0by5jaXBoZXItY29yZSddIH0sCiAgICAgICAgJ2NyeXB0by5jaXBoZXItY29yZSc6ICAgeyBkZXBzOiBbJ2NyeXB0by5lbmMtYmFzZTY0JywgJ2NyeXB0by5ldnBrZGYnXSB9LAogICAgICAgICdjcnlwdG8uZW5jLWJhc2U2NCc6ICAgIHsgZGVwczogWydjcnlwdG8uY29yZSddIH0sCiAgICAgICAgJ2NyeXB0by5ldnBrZGYnOiAgICAgICAgeyBkZXBzOiBbJ2NyeXB0by5tZDUnXSB9LAogICAgICAgICdjcnlwdG8uaG1hYyc6ICAgICAgICAgIHsgZGVwczogWydjcnlwdG8uY29yZSddIH0sCiAgICAgICAgJ2NyeXB0by5tZDUnOiAgICAgICAgICAgeyBkZXBzOiBbJ2NyeXB0by5jb3JlJ10gfSwKICAgICAgICAnY3J5cHRvLm1vZGUtY3RyJzogICAgICB7IGRlcHM6IFsnY3J5cHRvLmNpcGhlci1jb3JlJ10gfSwKICAgICAgICAnY3J5cHRvLnBhZC1ub3BhZGRpbmcnOiB7IGRlcHM6IFsnY3J5cHRvLmNpcGhlci1jb3JlJ10gfSwKICAgICAgICAnY3J5cHRvLnNoYTEnOiAgICAgICAgICB7IGRlcHM6IFsnY3J5cHRvLmNvcmUnXSB9LAogICAgICAgICdjcnlwdG8uc2hhMjU2JzogICAgICAgIHsgZGVwczogWydjcnlwdG8uY29yZSddIH0sCiAgICAgICAgJ2JpZ2ludCc6ICAgICAgICAgICAgICAgeyBkZXBzOiBbJ2NyeXB0byddIH0sCiAgICAgICAgJ3N0cm9waGUnOiAgICAgICAgICAgICAgeyBleHBvcnRzOiAnU3Ryb3BoZScgfSwKICAgICAgICAnc3Ryb3BoZS5kaXNjbyc6ICAgICAgICB7IGRlcHM6IFsnc3Ryb3BoZSddIH0sCiAgICAgICAgJ3N0cm9waGUubXVjJzogICAgICAgICAgeyBkZXBzOiBbJ3N0cm9waGUnXSB9LAogICAgICAgICdzdHJvcGhlLnJvc3Rlcic6ICAgICAgIHsgZGVwczogWydzdHJvcGhlJ10gfSwKICAgICAgICAnc3Ryb3BoZS52Y2FyZCc6ICAgICAgICB7IGRlcHM6IFsnc3Ryb3BoZSddIH0KICAgIH0KfSk7CnJlcXVpcmUoWyJjb252ZXJzZSJdLCBmdW5jdGlvbihjb252ZXJzZSkgewogICAgd2luZG93LmNvbnZlcnNlID0gY29udmVyc2U7Cn0pOwoKZGVmaW5lKCJtYWluIiwgZnVuY3Rpb24oKXt9KTsKCg==",
                "body": "LyoqCiAqIEBsaWNlbnNlIGFsbW9uZCAwLjIuOSBDb3B5cmlnaHQgKGMpIDIwMTEtMjAxNCwgVGhlIERvam8gRm91bmRhdGlvbiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKiBBdmFpbGFibGUgdmlhIHRoZSBNSVQgb3IgbmV3IEJTRCBsaWNlbnNlLgogKiBzZWU6IGh0dHA6Ly9naXRodWIuY29tL2pyYnVya2UvYWxtb25kIGZvciBkZXRhaWxzCiAqLwovL0dvaW5nIHNsb3BweSB0byBhdm9pZCAndXNlIHN0cmljdCcgc3RyaW5nIGNvc3QsIGJ1dCBzdHJpY3QgcHJhY3RpY2VzIHNob3VsZAovL2JlIGZvbGxvd2VkLgovKmpzbGludCBzbG9wcHk6IHRydWUgKi8KLypnbG9iYWwgc2V0VGltZW91dDogZmFsc2UgKi8KCnZhciByZXF1aXJlanMsIHJlcXVpcmUsIGRlZmluZTsKKGZ1bmN0aW9uICh1bmRlZikgewogICAgdmFyIG1haW4sIHJlcSwgbWFrZU1hcCwgaGFuZGxlcnMsCiAgICAgICAgZGVmaW5lZCA9IHt9LAogICAgICAgIHdhaXRpbmcgPSB7fSwKICAgICAgICBjb25maWcgPSB7fSwKICAgICAgICBkZWZpbmluZyA9IHt9LAogICAgICAgIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksCiAgICAgICAgYXBzID0gW10uc2xpY2UsCiAgICAgICAganNTdWZmaXhSZWdFeHAgPSAvXC5qcyQvOwoKICAgIGZ1bmN0aW9uIGhhc1Byb3Aob2JqLCBwcm9wKSB7CiAgICAgICAgcmV0dXJuIGhhc093bi5jYWxsKG9iaiwgcHJvcCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBHaXZlbiBhIHJlbGF0aXZlIG1vZHVsZSBuYW1lLCBsaWtlIC4vc29tZXRoaW5nLCBub3JtYWxpemUgaXQgdG8KICAgICAqIGEgcmVhbCBuYW1lIHRoYXQgY2FuIGJlIG1hcHBlZCB0byBhIHBhdGguCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSB0aGUgcmVsYXRpdmUgbmFtZQogICAgICogQHBhcmFtIHtTdHJpbmd9IGJhc2VOYW1lIGEgcmVhbCBuYW1lIHRoYXQgdGhlIG5hbWUgYXJnIGlzIHJlbGF0aXZlCiAgICAgKiB0by4KICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IG5vcm1hbGl6ZWQgbmFtZQogICAgICovCiAgICBmdW5jdGlvbiBub3JtYWxpemUobmFtZSwgYmFzZU5hbWUpIHsKICAgICAgICB2YXIgbmFtZVBhcnRzLCBuYW1lU2VnbWVudCwgbWFwVmFsdWUsIGZvdW5kTWFwLCBsYXN0SW5kZXgsCiAgICAgICAgICAgIGZvdW5kSSwgZm91bmRTdGFyTWFwLCBzdGFySSwgaSwgaiwgcGFydCwKICAgICAgICAgICAgYmFzZVBhcnRzID0gYmFzZU5hbWUgJiYgYmFzZU5hbWUuc3BsaXQoIi8iKSwKICAgICAgICAgICAgbWFwID0gY29uZmlnLm1hcCwKICAgICAgICAgICAgc3Rhck1hcCA9IChtYXAgJiYgbWFwWycqJ10pIHx8IHt9OwoKICAgICAgICAvL0FkanVzdCBhbnkgcmVsYXRpdmUgcGF0aHMuCiAgICAgICAgaWYgKG5hbWUgJiYgbmFtZS5jaGFyQXQoMCkgPT09ICIuIikgewogICAgICAgICAgICAvL0lmIGhhdmUgYSBiYXNlIG5hbWUsIHRyeSB0byBub3JtYWxpemUgYWdhaW5zdCBpdCwKICAgICAgICAgICAgLy9vdGhlcndpc2UsIGFzc3VtZSBpdCBpcyBhIHRvcC1sZXZlbCByZXF1aXJlIHRoYXQgd2lsbAogICAgICAgICAgICAvL2JlIHJlbGF0aXZlIHRvIGJhc2VVcmwgaW4gdGhlIGVuZC4KICAgICAgICAgICAgaWYgKGJhc2VOYW1lKSB7CiAgICAgICAgICAgICAgICAvL0NvbnZlcnQgYmFzZU5hbWUgdG8gYXJyYXksIGFuZCBsb3Agb2ZmIHRoZSBsYXN0IHBhcnQsCiAgICAgICAgICAgICAgICAvL3NvIHRoYXQgLiBtYXRjaGVzIHRoYXQgImRpcmVjdG9yeSIgYW5kIG5vdCBuYW1lIG9mIHRoZSBiYXNlTmFtZSdzCiAgICAgICAgICAgICAgICAvL21vZHVsZS4gRm9yIGluc3RhbmNlLCBiYXNlTmFtZSBvZiAib25lL3R3by90aHJlZSIsIG1hcHMgdG8KICAgICAgICAgICAgICAgIC8vIm9uZS90d28vdGhyZWUuanMiLCBidXQgd2Ugd2FudCB0aGUgZGlyZWN0b3J5LCAib25lL3R3byIgZm9yCiAgICAgICAgICAgICAgICAvL3RoaXMgbm9ybWFsaXphdGlvbi4KICAgICAgICAgICAgICAgIGJhc2VQYXJ0cyA9IGJhc2VQYXJ0cy5zbGljZSgwLCBiYXNlUGFydHMubGVuZ3RoIC0gMSk7CiAgICAgICAgICAgICAgICBuYW1lID0gbmFtZS5zcGxpdCgnLycpOwogICAgICAgICAgICAgICAgbGFzdEluZGV4ID0gbmFtZS5sZW5ndGggLSAxOwoKICAgICAgICAgICAgICAgIC8vIE5vZGUgLmpzIGFsbG93YW5jZToKICAgICAgICAgICAgICAgIGlmIChjb25maWcubm9kZUlkQ29tcGF0ICYmIGpzU3VmZml4UmVnRXhwLnRlc3QobmFtZVtsYXN0SW5kZXhdKSkgewogICAgICAgICAgICAgICAgICAgIG5hbWVbbGFzdEluZGV4XSA9IG5hbWVbbGFzdEluZGV4XS5yZXBsYWNlKGpzU3VmZml4UmVnRXhwLCAnJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbmFtZSA9IGJhc2VQYXJ0cy5jb25jYXQobmFtZSk7CgogICAgICAgICAgICAgICAgLy9zdGFydCB0cmltRG90cwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG5hbWUubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gbmFtZVtpXTsKICAgICAgICAgICAgICAgICAgICBpZiAocGFydCA9PT0gIi4iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBpIC09IDE7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwYXJ0ID09PSAiLi4iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpID09PSAxICYmIChuYW1lWzJdID09PSAnLi4nIHx8IG5hbWVbMF0gPT09ICcuLicpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL0VuZCBvZiB0aGUgbGluZS4gS2VlcCBhdCBsZWFzdCBvbmUgbm9uLWRvdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9wYXRoIHNlZ21lbnQgYXQgdGhlIGZyb250IHNvIGl0IGNhbiBiZSBtYXBwZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vY29ycmVjdGx5IHRvIGRpc2suIE90aGVyd2lzZSwgdGhlcmUgaXMgbGlrZWx5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL25vIHBhdGggbWFwcGluZyBmb3IgYSBwYXRoIHN0YXJ0aW5nIHdpdGggJy4uJy4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vVGhpcyBjYW4gc3RpbGwgZmFpbCwgYnV0IGNhdGNoZXMgdGhlIG1vc3QgcmVhc29uYWJsZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy91c2VzIG9mIC4uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZS5zcGxpY2UoaSAtIDEsIDIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaSAtPSAyOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy9lbmQgdHJpbURvdHMKCiAgICAgICAgICAgICAgICBuYW1lID0gbmFtZS5qb2luKCIvIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobmFtZS5pbmRleE9mKCcuLycpID09PSAwKSB7CiAgICAgICAgICAgICAgICAvLyBObyBiYXNlTmFtZSwgc28gdGhpcyBpcyBJRCBpcyByZXNvbHZlZCByZWxhdGl2ZQogICAgICAgICAgICAgICAgLy8gdG8gYmFzZVVybCwgcHVsbCBvZmYgdGhlIGxlYWRpbmcgZG90LgogICAgICAgICAgICAgICAgbmFtZSA9IG5hbWUuc3Vic3RyaW5nKDIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvL0FwcGx5IG1hcCBjb25maWcgaWYgYXZhaWxhYmxlLgogICAgICAgIGlmICgoYmFzZVBhcnRzIHx8IHN0YXJNYXApICYmIG1hcCkgewogICAgICAgICAgICBuYW1lUGFydHMgPSBuYW1lLnNwbGl0KCcvJyk7CgogICAgICAgICAgICBmb3IgKGkgPSBuYW1lUGFydHMubGVuZ3RoOyBpID4gMDsgaSAtPSAxKSB7CiAgICAgICAgICAgICAgICBuYW1lU2VnbWVudCA9IG5hbWVQYXJ0cy5zbGljZSgwLCBpKS5qb2luKCIvIik7CgogICAgICAgICAgICAgICAgaWYgKGJhc2VQYXJ0cykgewogICAgICAgICAgICAgICAgICAgIC8vRmluZCB0aGUgbG9uZ2VzdCBiYXNlTmFtZSBzZWdtZW50IG1hdGNoIGluIHRoZSBjb25maWcuCiAgICAgICAgICAgICAgICAgICAgLy9TbywgZG8gam9pbnMgb24gdGhlIGJpZ2dlc3QgdG8gc21hbGxlc3QgbGVuZ3RocyBvZiBiYXNlUGFydHMuCiAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gYmFzZVBhcnRzLmxlbmd0aDsgaiA+IDA7IGogLT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICBtYXBWYWx1ZSA9IG1hcFtiYXNlUGFydHMuc2xpY2UoMCwgaikuam9pbignLycpXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vYmFzZU5hbWUgc2VnbWVudCBoYXMgIGNvbmZpZywgZmluZCBpZiBpdCBoYXMgb25lIGZvcgogICAgICAgICAgICAgICAgICAgICAgICAvL3RoaXMgbmFtZS4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hcFZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXBWYWx1ZSA9IG1hcFZhbHVlW25hbWVTZWdtZW50XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXBWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vTWF0Y2gsIHVwZGF0ZSBuYW1lIHRvIHRoZSBuZXcgdmFsdWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm91bmRNYXAgPSBtYXBWYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3VuZEkgPSBpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChmb3VuZE1hcCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vQ2hlY2sgZm9yIGEgc3RhciBtYXAgbWF0Y2gsIGJ1dCBqdXN0IGhvbGQgb24gdG8gaXQsCiAgICAgICAgICAgICAgICAvL2lmIHRoZXJlIGlzIGEgc2hvcnRlciBzZWdtZW50IG1hdGNoIGxhdGVyIGluIGEgbWF0Y2hpbmcKICAgICAgICAgICAgICAgIC8vY29uZmlnLCB0aGVuIGZhdm9yIG92ZXIgdGhpcyBzdGFyIG1hcC4KICAgICAgICAgICAgICAgIGlmICghZm91bmRTdGFyTWFwICYmIHN0YXJNYXAgJiYgc3Rhck1hcFtuYW1lU2VnbWVudF0pIHsKICAgICAgICAgICAgICAgICAgICBmb3VuZFN0YXJNYXAgPSBzdGFyTWFwW25hbWVTZWdtZW50XTsKICAgICAgICAgICAgICAgICAgICBzdGFySSA9IGk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghZm91bmRNYXAgJiYgZm91bmRTdGFyTWFwKSB7CiAgICAgICAgICAgICAgICBmb3VuZE1hcCA9IGZvdW5kU3Rhck1hcDsKICAgICAgICAgICAgICAgIGZvdW5kSSA9IHN0YXJJOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZm91bmRNYXApIHsKICAgICAgICAgICAgICAgIG5hbWVQYXJ0cy5zcGxpY2UoMCwgZm91bmRJLCBmb3VuZE1hcCk7CiAgICAgICAgICAgICAgICBuYW1lID0gbmFtZVBhcnRzLmpvaW4oJy8nKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG5hbWU7CiAgICB9CgogICAgZnVuY3Rpb24gbWFrZVJlcXVpcmUocmVsTmFtZSwgZm9yY2VTeW5jKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgLy9BIHZlcnNpb24gb2YgYSByZXF1aXJlIGZ1bmN0aW9uIHRoYXQgcGFzc2VzIGEgbW9kdWxlTmFtZQogICAgICAgICAgICAvL3ZhbHVlIGZvciBpdGVtcyB0aGF0IG1heSBuZWVkIHRvCiAgICAgICAgICAgIC8vbG9vayB1cCBwYXRocyByZWxhdGl2ZSB0byB0aGUgbW9kdWxlTmFtZQogICAgICAgICAgICByZXR1cm4gcmVxLmFwcGx5KHVuZGVmLCBhcHMuY2FsbChhcmd1bWVudHMsIDApLmNvbmNhdChbcmVsTmFtZSwgZm9yY2VTeW5jXSkpOwogICAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gbWFrZU5vcm1hbGl6ZShyZWxOYW1lKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBub3JtYWxpemUobmFtZSwgcmVsTmFtZSk7CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBtYWtlTG9hZChkZXBOYW1lKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBkZWZpbmVkW2RlcE5hbWVdID0gdmFsdWU7CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBjYWxsRGVwKG5hbWUpIHsKICAgICAgICBpZiAoaGFzUHJvcCh3YWl0aW5nLCBuYW1lKSkgewogICAgICAgICAgICB2YXIgYXJncyA9IHdhaXRpbmdbbmFtZV07CiAgICAgICAgICAgIGRlbGV0ZSB3YWl0aW5nW25hbWVdOwogICAgICAgICAgICBkZWZpbmluZ1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgIG1haW4uYXBwbHkodW5kZWYsIGFyZ3MpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFoYXNQcm9wKGRlZmluZWQsIG5hbWUpICYmICFoYXNQcm9wKGRlZmluaW5nLCBuYW1lKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vICcgKyBuYW1lKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlZmluZWRbbmFtZV07CiAgICB9CgogICAgLy9UdXJucyBhIHBsdWdpbiFyZXNvdXJjZSB0byBbcGx1Z2luLCByZXNvdXJjZV0KICAgIC8vd2l0aCB0aGUgcGx1Z2luIGJlaW5nIHVuZGVmaW5lZCBpZiB0aGUgbmFtZQogICAgLy9kaWQgbm90IGhhdmUgYSBwbHVnaW4gcHJlZml4LgogICAgZnVuY3Rpb24gc3BsaXRQcmVmaXgobmFtZSkgewogICAgICAgIHZhciBwcmVmaXgsCiAgICAgICAgICAgIGluZGV4ID0gbmFtZSA/IG5hbWUuaW5kZXhPZignIScpIDogLTE7CiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgICAgcHJlZml4ID0gbmFtZS5zdWJzdHJpbmcoMCwgaW5kZXgpOwogICAgICAgICAgICBuYW1lID0gbmFtZS5zdWJzdHJpbmcoaW5kZXggKyAxLCBuYW1lLmxlbmd0aCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBbcHJlZml4LCBuYW1lXTsKICAgIH0KCiAgICAvKioKICAgICAqIE1ha2VzIGEgbmFtZSBtYXAsIG5vcm1hbGl6aW5nIHRoZSBuYW1lLCBhbmQgdXNpbmcgYSBwbHVnaW4KICAgICAqIGZvciBub3JtYWxpemF0aW9uIGlmIG5lY2Vzc2FyeS4gR3JhYnMgYSByZWYgdG8gcGx1Z2luCiAgICAgKiB0b28sIGFzIGFuIG9wdGltaXphdGlvbi4KICAgICAqLwogICAgbWFrZU1hcCA9IGZ1bmN0aW9uIChuYW1lLCByZWxOYW1lKSB7CiAgICAgICAgdmFyIHBsdWdpbiwKICAgICAgICAgICAgcGFydHMgPSBzcGxpdFByZWZpeChuYW1lKSwKICAgICAgICAgICAgcHJlZml4ID0gcGFydHNbMF07CgogICAgICAgIG5hbWUgPSBwYXJ0c1sxXTsKCiAgICAgICAgaWYgKHByZWZpeCkgewogICAgICAgICAgICBwcmVmaXggPSBub3JtYWxpemUocHJlZml4LCByZWxOYW1lKTsKICAgICAgICAgICAgcGx1Z2luID0gY2FsbERlcChwcmVmaXgpOwogICAgICAgIH0KCiAgICAgICAgLy9Ob3JtYWxpemUgYWNjb3JkaW5nCiAgICAgICAgaWYgKHByZWZpeCkgewogICAgICAgICAgICBpZiAocGx1Z2luICYmIHBsdWdpbi5ub3JtYWxpemUpIHsKICAgICAgICAgICAgICAgIG5hbWUgPSBwbHVnaW4ubm9ybWFsaXplKG5hbWUsIG1ha2VOb3JtYWxpemUocmVsTmFtZSkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmFtZSA9IG5vcm1hbGl6ZShuYW1lLCByZWxOYW1lKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5hbWUgPSBub3JtYWxpemUobmFtZSwgcmVsTmFtZSk7CiAgICAgICAgICAgIHBhcnRzID0gc3BsaXRQcmVmaXgobmFtZSk7CiAgICAgICAgICAgIHByZWZpeCA9IHBhcnRzWzBdOwogICAgICAgICAgICBuYW1lID0gcGFydHNbMV07CiAgICAgICAgICAgIGlmIChwcmVmaXgpIHsKICAgICAgICAgICAgICAgIHBsdWdpbiA9IGNhbGxEZXAocHJlZml4KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy9Vc2luZyByaWRpY3Vsb3VzIHByb3BlcnR5IG5hbWVzIGZvciBzcGFjZSByZWFzb25zCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZjogcHJlZml4ID8gcHJlZml4ICsgJyEnICsgbmFtZSA6IG5hbWUsIC8vZnVsbE5hbWUKICAgICAgICAgICAgbjogbmFtZSwKICAgICAgICAgICAgcHI6IHByZWZpeCwKICAgICAgICAgICAgcDogcGx1Z2luCiAgICAgICAgfTsKICAgIH07CgogICAgZnVuY3Rpb24gbWFrZUNvbmZpZyhuYW1lKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIChjb25maWcgJiYgY29uZmlnLmNvbmZpZyAmJiBjb25maWcuY29uZmlnW25hbWVdKSB8fCB7fTsKICAgICAgICB9OwogICAgfQoKICAgIGhhbmRsZXJzID0gewogICAgICAgIHJlcXVpcmU6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBtYWtlUmVxdWlyZShuYW1lKTsKICAgICAgICB9LAogICAgICAgIGV4cG9ydHM6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciBlID0gZGVmaW5lZFtuYW1lXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBlICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgcmV0dXJuIGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gKGRlZmluZWRbbmFtZV0gPSB7fSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIG1vZHVsZTogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGlkOiBuYW1lLAogICAgICAgICAgICAgICAgdXJpOiAnJywKICAgICAgICAgICAgICAgIGV4cG9ydHM6IGRlZmluZWRbbmFtZV0sCiAgICAgICAgICAgICAgICBjb25maWc6IG1ha2VDb25maWcobmFtZSkKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9OwoKICAgIG1haW4gPSBmdW5jdGlvbiAobmFtZSwgZGVwcywgY2FsbGJhY2ssIHJlbE5hbWUpIHsKICAgICAgICB2YXIgY2pzTW9kdWxlLCBkZXBOYW1lLCByZXQsIG1hcCwgaSwKICAgICAgICAgICAgYXJncyA9IFtdLAogICAgICAgICAgICBjYWxsYmFja1R5cGUgPSB0eXBlb2YgY2FsbGJhY2ssCiAgICAgICAgICAgIHVzaW5nRXhwb3J0czsKCiAgICAgICAgLy9Vc2UgbmFtZSBpZiBubyByZWxOYW1lCiAgICAgICAgcmVsTmFtZSA9IHJlbE5hbWUgfHwgbmFtZTsKCiAgICAgICAgLy9DYWxsIHRoZSBjYWxsYmFjayB0byBkZWZpbmUgdGhlIG1vZHVsZSwgaWYgbmVjZXNzYXJ5LgogICAgICAgIGlmIChjYWxsYmFja1R5cGUgPT09ICd1bmRlZmluZWQnIHx8IGNhbGxiYWNrVHlwZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAvL1B1bGwgb3V0IHRoZSBkZWZpbmVkIGRlcGVuZGVuY2llcyBhbmQgcGFzcyB0aGUgb3JkZXJlZAogICAgICAgICAgICAvL3ZhbHVlcyB0byB0aGUgY2FsbGJhY2suCiAgICAgICAgICAgIC8vRGVmYXVsdCB0byBbcmVxdWlyZSwgZXhwb3J0cywgbW9kdWxlXSBpZiBubyBkZXBzCiAgICAgICAgICAgIGRlcHMgPSAhZGVwcy5sZW5ndGggJiYgY2FsbGJhY2subGVuZ3RoID8gWydyZXF1aXJlJywgJ2V4cG9ydHMnLCAnbW9kdWxlJ10gOiBkZXBzOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZGVwcy5sZW5ndGg7IGkgKz0gMSkgewogICAgICAgICAgICAgICAgbWFwID0gbWFrZU1hcChkZXBzW2ldLCByZWxOYW1lKTsKICAgICAgICAgICAgICAgIGRlcE5hbWUgPSBtYXAuZjsKCiAgICAgICAgICAgICAgICAvL0Zhc3QgcGF0aCBDb21tb25KUyBzdGFuZGFyZCBkZXBlbmRlbmNpZXMuCiAgICAgICAgICAgICAgICBpZiAoZGVwTmFtZSA9PT0gInJlcXVpcmUiKSB7CiAgICAgICAgICAgICAgICAgICAgYXJnc1tpXSA9IGhhbmRsZXJzLnJlcXVpcmUobmFtZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRlcE5hbWUgPT09ICJleHBvcnRzIikgewogICAgICAgICAgICAgICAgICAgIC8vQ29tbW9uSlMgbW9kdWxlIHNwZWMgMS4xCiAgICAgICAgICAgICAgICAgICAgYXJnc1tpXSA9IGhhbmRsZXJzLmV4cG9ydHMobmFtZSk7CiAgICAgICAgICAgICAgICAgICAgdXNpbmdFeHBvcnRzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGVwTmFtZSA9PT0gIm1vZHVsZSIpIHsKICAgICAgICAgICAgICAgICAgICAvL0NvbW1vbkpTIG1vZHVsZSBzcGVjIDEuMQogICAgICAgICAgICAgICAgICAgIGNqc01vZHVsZSA9IGFyZ3NbaV0gPSBoYW5kbGVycy5tb2R1bGUobmFtZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhc1Byb3AoZGVmaW5lZCwgZGVwTmFtZSkgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzUHJvcCh3YWl0aW5nLCBkZXBOYW1lKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNQcm9wKGRlZmluaW5nLCBkZXBOYW1lKSkgewogICAgICAgICAgICAgICAgICAgIGFyZ3NbaV0gPSBjYWxsRGVwKGRlcE5hbWUpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChtYXAucCkgewogICAgICAgICAgICAgICAgICAgIG1hcC5wLmxvYWQobWFwLm4sIG1ha2VSZXF1aXJlKHJlbE5hbWUsIHRydWUpLCBtYWtlTG9hZChkZXBOYW1lKSwge30pOwogICAgICAgICAgICAgICAgICAgIGFyZ3NbaV0gPSBkZWZpbmVkW2RlcE5hbWVdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IobmFtZSArICcgbWlzc2luZyAnICsgZGVwTmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldCA9IGNhbGxiYWNrID8gY2FsbGJhY2suYXBwbHkoZGVmaW5lZFtuYW1lXSwgYXJncykgOiB1bmRlZmluZWQ7CgogICAgICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICAgICAgLy9JZiBzZXR0aW5nIGV4cG9ydHMgdmlhICJtb2R1bGUiIGlzIGluIHBsYXksCiAgICAgICAgICAgICAgICAvL2Zhdm9yIHRoYXQgb3ZlciByZXR1cm4gdmFsdWUgYW5kIGV4cG9ydHMuIEFmdGVyIHRoYXQsCiAgICAgICAgICAgICAgICAvL2Zhdm9yIGEgbm9uLXVuZGVmaW5lZCByZXR1cm4gdmFsdWUgb3ZlciBleHBvcnRzIHVzZS4KICAgICAgICAgICAgICAgIGlmIChjanNNb2R1bGUgJiYgY2pzTW9kdWxlLmV4cG9ydHMgIT09IHVuZGVmICYmCiAgICAgICAgICAgICAgICAgICAgICAgIGNqc01vZHVsZS5leHBvcnRzICE9PSBkZWZpbmVkW25hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgZGVmaW5lZFtuYW1lXSA9IGNqc01vZHVsZS5leHBvcnRzOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZXQgIT09IHVuZGVmIHx8ICF1c2luZ0V4cG9ydHMpIHsKICAgICAgICAgICAgICAgICAgICAvL1VzZSB0aGUgcmV0dXJuIHZhbHVlIGZyb20gdGhlIGZ1bmN0aW9uLgogICAgICAgICAgICAgICAgICAgIGRlZmluZWRbbmFtZV0gPSByZXQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKG5hbWUpIHsKICAgICAgICAgICAgLy9NYXkganVzdCBiZSBhbiBvYmplY3QgZGVmaW5pdGlvbiBmb3IgdGhlIG1vZHVsZS4gT25seQogICAgICAgICAgICAvL3dvcnJ5IGFib3V0IGRlZmluaW5nIGlmIGhhdmUgYSBtb2R1bGUgbmFtZS4KICAgICAgICAgICAgZGVmaW5lZFtuYW1lXSA9IGNhbGxiYWNrOwogICAgICAgIH0KICAgIH07CgogICAgcmVxdWlyZWpzID0gcmVxdWlyZSA9IHJlcSA9IGZ1bmN0aW9uIChkZXBzLCBjYWxsYmFjaywgcmVsTmFtZSwgZm9yY2VTeW5jLCBhbHQpIHsKICAgICAgICBpZiAodHlwZW9mIGRlcHMgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGlmIChoYW5kbGVyc1tkZXBzXSkgewogICAgICAgICAgICAgICAgLy9jYWxsYmFjayBpbiB0aGlzIGNhc2UgaXMgcmVhbGx5IHJlbE5hbWUKICAgICAgICAgICAgICAgIHJldHVybiBoYW5kbGVyc1tkZXBzXShjYWxsYmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy9KdXN0IHJldHVybiB0aGUgbW9kdWxlIHdhbnRlZC4gSW4gdGhpcyBzY2VuYXJpbywgdGhlCiAgICAgICAgICAgIC8vZGVwcyBhcmcgaXMgdGhlIG1vZHVsZSBuYW1lLCBhbmQgc2Vjb25kIGFyZyAoaWYgcGFzc2VkKQogICAgICAgICAgICAvL2lzIGp1c3QgdGhlIHJlbE5hbWUuCiAgICAgICAgICAgIC8vTm9ybWFsaXplIG1vZHVsZSBuYW1lLCBpZiBpdCBjb250YWlucyAuIG9yIC4uCiAgICAgICAgICAgIHJldHVybiBjYWxsRGVwKG1ha2VNYXAoZGVwcywgY2FsbGJhY2spLmYpOwogICAgICAgIH0gZWxzZSBpZiAoIWRlcHMuc3BsaWNlKSB7CiAgICAgICAgICAgIC8vZGVwcyBpcyBhIGNvbmZpZyBvYmplY3QsIG5vdCBhbiBhcnJheS4KICAgICAgICAgICAgY29uZmlnID0gZGVwczsKICAgICAgICAgICAgaWYgKGNvbmZpZy5kZXBzKSB7CiAgICAgICAgICAgICAgICByZXEoY29uZmlnLmRlcHMsIGNvbmZpZy5jYWxsYmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFjYWxsYmFjaykgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY2FsbGJhY2suc3BsaWNlKSB7CiAgICAgICAgICAgICAgICAvL2NhbGxiYWNrIGlzIGFuIGFycmF5LCB3aGljaCBtZWFucyBpdCBpcyBhIGRlcGVuZGVuY3kgbGlzdC4KICAgICAgICAgICAgICAgIC8vQWRqdXN0IGFyZ3MgaWYgdGhlcmUgYXJlIGRlcGVuZGVuY2llcwogICAgICAgICAgICAgICAgZGVwcyA9IGNhbGxiYWNrOwogICAgICAgICAgICAgICAgY2FsbGJhY2sgPSByZWxOYW1lOwogICAgICAgICAgICAgICAgcmVsTmFtZSA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZXBzID0gdW5kZWY7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vU3VwcG9ydCByZXF1aXJlKFsnYSddKQogICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgfHwgZnVuY3Rpb24gKCkge307CgogICAgICAgIC8vSWYgcmVsTmFtZSBpcyBhIGZ1bmN0aW9uLCBpdCBpcyBhbiBlcnJiYWNrIGhhbmRsZXIsCiAgICAgICAgLy9zbyByZW1vdmUgaXQuCiAgICAgICAgaWYgKHR5cGVvZiByZWxOYW1lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIHJlbE5hbWUgPSBmb3JjZVN5bmM7CiAgICAgICAgICAgIGZvcmNlU3luYyA9IGFsdDsKICAgICAgICB9CgogICAgICAgIC8vU2ltdWxhdGUgYXN5bmMgY2FsbGJhY2s7CiAgICAgICAgaWYgKGZvcmNlU3luYykgewogICAgICAgICAgICBtYWluKHVuZGVmLCBkZXBzLCBjYWxsYmFjaywgcmVsTmFtZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy9Vc2luZyBhIG5vbi16ZXJvIHZhbHVlIGJlY2F1c2Ugb2YgY29uY2VybiBmb3Igd2hhdCBvbGQgYnJvd3NlcnMKICAgICAgICAgICAgLy9kbywgYW5kIGxhdGVzdCBicm93c2VycyAidXBncmFkZSIgdG8gNCBpZiBsb3dlciB2YWx1ZSBpcyB1c2VkOgogICAgICAgICAgICAvL2h0dHA6Ly93d3cud2hhdHdnLm9yZy9zcGVjcy93ZWItYXBwcy9jdXJyZW50LXdvcmsvbXVsdGlwYWdlL3RpbWVycy5odG1sI2RvbS13aW5kb3d0aW1lcnMtc2V0dGltZW91dDoKICAgICAgICAgICAgLy9JZiB3YW50IGEgdmFsdWUgaW1tZWRpYXRlbHksIHVzZSByZXF1aXJlKCdpZCcpIGluc3RlYWQgLS0gc29tZXRoaW5nCiAgICAgICAgICAgIC8vdGhhdCB3b3JrcyBpbiBhbG1vbmQgb24gdGhlIGdsb2JhbCBsZXZlbCwgYnV0IG5vdCBndWFyYW50ZWVkIGFuZAogICAgICAgICAgICAvL3VubGlrZWx5IHRvIHdvcmsgaW4gb3RoZXIgQU1EIGltcGxlbWVudGF0aW9ucy4KICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBtYWluKHVuZGVmLCBkZXBzLCBjYWxsYmFjaywgcmVsTmFtZSk7CiAgICAgICAgICAgIH0sIDQpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlcTsKICAgIH07CgogICAgLyoqCiAgICAgKiBKdXN0IGRyb3BzIHRoZSBjb25maWcgb24gdGhlIGZsb29yLCBidXQgcmV0dXJucyByZXEgaW4gY2FzZQogICAgICogdGhlIGNvbmZpZyByZXR1cm4gdmFsdWUgaXMgdXNlZC4KICAgICAqLwogICAgcmVxLmNvbmZpZyA9IGZ1bmN0aW9uIChjZmcpIHsKICAgICAgICByZXR1cm4gcmVxKGNmZyk7CiAgICB9OwoKICAgIC8qKgogICAgICogRXhwb3NlIG1vZHVsZSByZWdpc3RyeSBmb3IgZGVidWdnaW5nIGFuZCB0b29saW5nCiAgICAgKi8KICAgIHJlcXVpcmVqcy5fZGVmaW5lZCA9IGRlZmluZWQ7CgogICAgZGVmaW5lID0gZnVuY3Rpb24gKG5hbWUsIGRlcHMsIGNhbGxiYWNrKSB7CgogICAgICAgIC8vVGhpcyBtb2R1bGUgbWF5IG5vdCBoYXZlIGRlcGVuZGVuY2llcwogICAgICAgIGlmICghZGVwcy5zcGxpY2UpIHsKICAgICAgICAgICAgLy9kZXBzIGlzIG5vdCBhbiBhcnJheSwgc28gcHJvYmFibHkgbWVhbnMKICAgICAgICAgICAgLy9hbiBvYmplY3QgbGl0ZXJhbCBvciBmYWN0b3J5IGZ1bmN0aW9uIGZvcgogICAgICAgICAgICAvL3RoZSB2YWx1ZS4gQWRqdXN0IGFyZ3MuCiAgICAgICAgICAgIGNhbGxiYWNrID0gZGVwczsKICAgICAgICAgICAgZGVwcyA9IFtdOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFoYXNQcm9wKGRlZmluZWQsIG5hbWUpICYmICFoYXNQcm9wKHdhaXRpbmcsIG5hbWUpKSB7CiAgICAgICAgICAgIHdhaXRpbmdbbmFtZV0gPSBbbmFtZSwgZGVwcywgY2FsbGJhY2tdOwogICAgICAgIH0KICAgIH07CgogICAgZGVmaW5lLmFtZCA9IHsKICAgICAgICBqUXVlcnk6IHRydWUKICAgIH07Cn0oKSk7CgpkZWZpbmUoImNvbXBvbmVudHMvYWxtb25kL2FsbW9uZC5qcyIsIGZ1bmN0aW9uKCl7fSk7CgovKiEKICogalF1ZXJ5IEphdmFTY3JpcHQgTGlicmFyeSB2MS4xMS4wCiAqIGh0dHA6Ly9qcXVlcnkuY29tLwogKgogKiBJbmNsdWRlcyBTaXp6bGUuanMKICogaHR0cDovL3NpenpsZWpzLmNvbS8KICoKICogQ29weXJpZ2h0IDIwMDUsIDIwMTQgalF1ZXJ5IEZvdW5kYXRpb24sIEluYy4gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UKICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBEYXRlOiAyMDE0LTAxLTIzVDIxOjAyWgogKi8KCihmdW5jdGlvbiggZ2xvYmFsLCBmYWN0b3J5ICkgewoKCWlmICggdHlwZW9mIG1vZHVsZSA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIG1vZHVsZS5leHBvcnRzID09PSAib2JqZWN0IiApIHsKCQkvLyBGb3IgQ29tbW9uSlMgYW5kIENvbW1vbkpTLWxpa2UgZW52aXJvbm1lbnRzIHdoZXJlIGEgcHJvcGVyIHdpbmRvdyBpcyBwcmVzZW50LAoJCS8vIGV4ZWN1dGUgdGhlIGZhY3RvcnkgYW5kIGdldCBqUXVlcnkKCQkvLyBGb3IgZW52aXJvbm1lbnRzIHRoYXQgZG8gbm90IGluaGVyZW50bHkgcG9zc2VzIGEgd2luZG93IHdpdGggYSBkb2N1bWVudAoJCS8vIChzdWNoIGFzIE5vZGUuanMpLCBleHBvc2UgYSBqUXVlcnktbWFraW5nIGZhY3RvcnkgYXMgbW9kdWxlLmV4cG9ydHMKCQkvLyBUaGlzIGFjY2VudHVhdGVzIHRoZSBuZWVkIGZvciB0aGUgY3JlYXRpb24gb2YgYSByZWFsIHdpbmRvdwoJCS8vIGUuZy4gdmFyIGpRdWVyeSA9IHJlcXVpcmUoImpxdWVyeSIpKHdpbmRvdyk7CgkJLy8gU2VlIHRpY2tldCAjMTQ1NDkgZm9yIG1vcmUgaW5mbwoJCW1vZHVsZS5leHBvcnRzID0gZ2xvYmFsLmRvY3VtZW50ID8KCQkJZmFjdG9yeSggZ2xvYmFsLCB0cnVlICkgOgoJCQlmdW5jdGlvbiggdyApIHsKCQkJCWlmICggIXcuZG9jdW1lbnQgKSB7CgkJCQkJdGhyb3cgbmV3IEVycm9yKCAialF1ZXJ5IHJlcXVpcmVzIGEgd2luZG93IHdpdGggYSBkb2N1bWVudCIgKTsKCQkJCX0KCQkJCXJldHVybiBmYWN0b3J5KCB3ICk7CgkJCX07Cgl9IGVsc2UgewoJCWZhY3RvcnkoIGdsb2JhbCApOwoJfQoKLy8gUGFzcyB0aGlzIGlmIHdpbmRvdyBpcyBub3QgZGVmaW5lZCB5ZXQKfSh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiA/IHdpbmRvdyA6IHRoaXMsIGZ1bmN0aW9uKCB3aW5kb3csIG5vR2xvYmFsICkgewoKLy8gQ2FuJ3QgZG8gdGhpcyBiZWNhdXNlIHNldmVyYWwgYXBwcyBpbmNsdWRpbmcgQVNQLk5FVCB0cmFjZQovLyB0aGUgc3RhY2sgdmlhIGFyZ3VtZW50cy5jYWxsZXIuY2FsbGVlIGFuZCBGaXJlZm94IGRpZXMgaWYKLy8geW91IHRyeSB0byB0cmFjZSB0aHJvdWdoICJ1c2Ugc3RyaWN0IiBjYWxsIGNoYWlucy4gKCMxMzMzNSkKLy8gU3VwcG9ydDogRmlyZWZveCAxOCsKLy8KCnZhciBkZWxldGVkSWRzID0gW107Cgp2YXIgc2xpY2UgPSBkZWxldGVkSWRzLnNsaWNlOwoKdmFyIGNvbmNhdCA9IGRlbGV0ZWRJZHMuY29uY2F0OwoKdmFyIHB1c2ggPSBkZWxldGVkSWRzLnB1c2g7Cgp2YXIgaW5kZXhPZiA9IGRlbGV0ZWRJZHMuaW5kZXhPZjsKCnZhciBjbGFzczJ0eXBlID0ge307Cgp2YXIgdG9TdHJpbmcgPSBjbGFzczJ0eXBlLnRvU3RyaW5nOwoKdmFyIGhhc093biA9IGNsYXNzMnR5cGUuaGFzT3duUHJvcGVydHk7Cgp2YXIgdHJpbSA9ICIiLnRyaW07Cgp2YXIgc3VwcG9ydCA9IHt9OwoKCgp2YXIKCXZlcnNpb24gPSAiMS4xMS4wIiwKCgkvLyBEZWZpbmUgYSBsb2NhbCBjb3B5IG9mIGpRdWVyeQoJalF1ZXJ5ID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0ICkgewoJCS8vIFRoZSBqUXVlcnkgb2JqZWN0IGlzIGFjdHVhbGx5IGp1c3QgdGhlIGluaXQgY29uc3RydWN0b3IgJ2VuaGFuY2VkJwoJCS8vIE5lZWQgaW5pdCBpZiBqUXVlcnkgaXMgY2FsbGVkIChqdXN0IGFsbG93IGVycm9yIHRvIGJlIHRocm93biBpZiBub3QgaW5jbHVkZWQpCgkJcmV0dXJuIG5ldyBqUXVlcnkuZm4uaW5pdCggc2VsZWN0b3IsIGNvbnRleHQgKTsKCX0sCgoJLy8gTWFrZSBzdXJlIHdlIHRyaW0gQk9NIGFuZCBOQlNQIChoZXJlJ3MgbG9va2luZyBhdCB5b3UsIFNhZmFyaSA1LjAgYW5kIElFKQoJcnRyaW0gPSAvXltcc1x1RkVGRlx4QTBdK3xbXHNcdUZFRkZceEEwXSskL2csCgoJLy8gTWF0Y2hlcyBkYXNoZWQgc3RyaW5nIGZvciBjYW1lbGl6aW5nCglybXNQcmVmaXggPSAvXi1tcy0vLAoJcmRhc2hBbHBoYSA9IC8tKFtcZGEtel0pL2dpLAoKCS8vIFVzZWQgYnkgalF1ZXJ5LmNhbWVsQ2FzZSBhcyBjYWxsYmFjayB0byByZXBsYWNlKCkKCWZjYW1lbENhc2UgPSBmdW5jdGlvbiggYWxsLCBsZXR0ZXIgKSB7CgkJcmV0dXJuIGxldHRlci50b1VwcGVyQ2FzZSgpOwoJfTsKCmpRdWVyeS5mbiA9IGpRdWVyeS5wcm90b3R5cGUgPSB7CgkvLyBUaGUgY3VycmVudCB2ZXJzaW9uIG9mIGpRdWVyeSBiZWluZyB1c2VkCglqcXVlcnk6IHZlcnNpb24sCgoJY29uc3RydWN0b3I6IGpRdWVyeSwKCgkvLyBTdGFydCB3aXRoIGFuIGVtcHR5IHNlbGVjdG9yCglzZWxlY3RvcjogIiIsCgoJLy8gVGhlIGRlZmF1bHQgbGVuZ3RoIG9mIGEgalF1ZXJ5IG9iamVjdCBpcyAwCglsZW5ndGg6IDAsCgoJdG9BcnJheTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHNsaWNlLmNhbGwoIHRoaXMgKTsKCX0sCgoJLy8gR2V0IHRoZSBOdGggZWxlbWVudCBpbiB0aGUgbWF0Y2hlZCBlbGVtZW50IHNldCBPUgoJLy8gR2V0IHRoZSB3aG9sZSBtYXRjaGVkIGVsZW1lbnQgc2V0IGFzIGEgY2xlYW4gYXJyYXkKCWdldDogZnVuY3Rpb24oIG51bSApIHsKCQlyZXR1cm4gbnVtICE9IG51bGwgPwoKCQkJLy8gUmV0dXJuIGEgJ2NsZWFuJyBhcnJheQoJCQkoIG51bSA8IDAgPyB0aGlzWyBudW0gKyB0aGlzLmxlbmd0aCBdIDogdGhpc1sgbnVtIF0gKSA6CgoJCQkvLyBSZXR1cm4ganVzdCB0aGUgb2JqZWN0CgkJCXNsaWNlLmNhbGwoIHRoaXMgKTsKCX0sCgoJLy8gVGFrZSBhbiBhcnJheSBvZiBlbGVtZW50cyBhbmQgcHVzaCBpdCBvbnRvIHRoZSBzdGFjawoJLy8gKHJldHVybmluZyB0aGUgbmV3IG1hdGNoZWQgZWxlbWVudCBzZXQpCglwdXNoU3RhY2s6IGZ1bmN0aW9uKCBlbGVtcyApIHsKCgkJLy8gQnVpbGQgYSBuZXcgalF1ZXJ5IG1hdGNoZWQgZWxlbWVudCBzZXQKCQl2YXIgcmV0ID0galF1ZXJ5Lm1lcmdlKCB0aGlzLmNvbnN0cnVjdG9yKCksIGVsZW1zICk7CgoJCS8vIEFkZCB0aGUgb2xkIG9iamVjdCBvbnRvIHRoZSBzdGFjayAoYXMgYSByZWZlcmVuY2UpCgkJcmV0LnByZXZPYmplY3QgPSB0aGlzOwoJCXJldC5jb250ZXh0ID0gdGhpcy5jb250ZXh0OwoKCQkvLyBSZXR1cm4gdGhlIG5ld2x5LWZvcm1lZCBlbGVtZW50IHNldAoJCXJldHVybiByZXQ7Cgl9LAoKCS8vIEV4ZWN1dGUgYSBjYWxsYmFjayBmb3IgZXZlcnkgZWxlbWVudCBpbiB0aGUgbWF0Y2hlZCBzZXQuCgkvLyAoWW91IGNhbiBzZWVkIHRoZSBhcmd1bWVudHMgd2l0aCBhbiBhcnJheSBvZiBhcmdzLCBidXQgdGhpcyBpcwoJLy8gb25seSB1c2VkIGludGVybmFsbHkuKQoJZWFjaDogZnVuY3Rpb24oIGNhbGxiYWNrLCBhcmdzICkgewoJCXJldHVybiBqUXVlcnkuZWFjaCggdGhpcywgY2FsbGJhY2ssIGFyZ3MgKTsKCX0sCgoJbWFwOiBmdW5jdGlvbiggY2FsbGJhY2sgKSB7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqUXVlcnkubWFwKHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCBpICkgewoJCQlyZXR1cm4gY2FsbGJhY2suY2FsbCggZWxlbSwgaSwgZWxlbSApOwoJCX0pKTsKCX0sCgoJc2xpY2U6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggc2xpY2UuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApICk7Cgl9LAoKCWZpcnN0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lcSggMCApOwoJfSwKCglsYXN0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lcSggLTEgKTsKCX0sCgoJZXE6IGZ1bmN0aW9uKCBpICkgewoJCXZhciBsZW4gPSB0aGlzLmxlbmd0aCwKCQkJaiA9ICtpICsgKCBpIDwgMCA/IGxlbiA6IDAgKTsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGogPj0gMCAmJiBqIDwgbGVuID8gWyB0aGlzW2pdIF0gOiBbXSApOwoJfSwKCgllbmQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnByZXZPYmplY3QgfHwgdGhpcy5jb25zdHJ1Y3RvcihudWxsKTsKCX0sCgoJLy8gRm9yIGludGVybmFsIHVzZSBvbmx5LgoJLy8gQmVoYXZlcyBsaWtlIGFuIEFycmF5J3MgbWV0aG9kLCBub3QgbGlrZSBhIGpRdWVyeSBtZXRob2QuCglwdXNoOiBwdXNoLAoJc29ydDogZGVsZXRlZElkcy5zb3J0LAoJc3BsaWNlOiBkZWxldGVkSWRzLnNwbGljZQp9OwoKalF1ZXJ5LmV4dGVuZCA9IGpRdWVyeS5mbi5leHRlbmQgPSBmdW5jdGlvbigpIHsKCXZhciBzcmMsIGNvcHlJc0FycmF5LCBjb3B5LCBuYW1lLCBvcHRpb25zLCBjbG9uZSwKCQl0YXJnZXQgPSBhcmd1bWVudHNbMF0gfHwge30sCgkJaSA9IDEsCgkJbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCwKCQlkZWVwID0gZmFsc2U7CgoJLy8gSGFuZGxlIGEgZGVlcCBjb3B5IHNpdHVhdGlvbgoJaWYgKCB0eXBlb2YgdGFyZ2V0ID09PSAiYm9vbGVhbiIgKSB7CgkJZGVlcCA9IHRhcmdldDsKCgkJLy8gc2tpcCB0aGUgYm9vbGVhbiBhbmQgdGhlIHRhcmdldAoJCXRhcmdldCA9IGFyZ3VtZW50c1sgaSBdIHx8IHt9OwoJCWkrKzsKCX0KCgkvLyBIYW5kbGUgY2FzZSB3aGVuIHRhcmdldCBpcyBhIHN0cmluZyBvciBzb21ldGhpbmcgKHBvc3NpYmxlIGluIGRlZXAgY29weSkKCWlmICggdHlwZW9mIHRhcmdldCAhPT0gIm9iamVjdCIgJiYgIWpRdWVyeS5pc0Z1bmN0aW9uKHRhcmdldCkgKSB7CgkJdGFyZ2V0ID0ge307Cgl9CgoJLy8gZXh0ZW5kIGpRdWVyeSBpdHNlbGYgaWYgb25seSBvbmUgYXJndW1lbnQgaXMgcGFzc2VkCglpZiAoIGkgPT09IGxlbmd0aCApIHsKCQl0YXJnZXQgPSB0aGlzOwoJCWktLTsKCX0KCglmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkvLyBPbmx5IGRlYWwgd2l0aCBub24tbnVsbC91bmRlZmluZWQgdmFsdWVzCgkJaWYgKCAob3B0aW9ucyA9IGFyZ3VtZW50c1sgaSBdKSAhPSBudWxsICkgewoJCQkvLyBFeHRlbmQgdGhlIGJhc2Ugb2JqZWN0CgkJCWZvciAoIG5hbWUgaW4gb3B0aW9ucyApIHsKCQkJCXNyYyA9IHRhcmdldFsgbmFtZSBdOwoJCQkJY29weSA9IG9wdGlvbnNbIG5hbWUgXTsKCgkJCQkvLyBQcmV2ZW50IG5ldmVyLWVuZGluZyBsb29wCgkJCQlpZiAoIHRhcmdldCA9PT0gY29weSApIHsKCQkJCQljb250aW51ZTsKCQkJCX0KCgkJCQkvLyBSZWN1cnNlIGlmIHdlJ3JlIG1lcmdpbmcgcGxhaW4gb2JqZWN0cyBvciBhcnJheXMKCQkJCWlmICggZGVlcCAmJiBjb3B5ICYmICggalF1ZXJ5LmlzUGxhaW5PYmplY3QoY29weSkgfHwgKGNvcHlJc0FycmF5ID0galF1ZXJ5LmlzQXJyYXkoY29weSkpICkgKSB7CgkJCQkJaWYgKCBjb3B5SXNBcnJheSApIHsKCQkJCQkJY29weUlzQXJyYXkgPSBmYWxzZTsKCQkJCQkJY2xvbmUgPSBzcmMgJiYgalF1ZXJ5LmlzQXJyYXkoc3JjKSA/IHNyYyA6IFtdOwoKCQkJCQl9IGVsc2UgewoJCQkJCQljbG9uZSA9IHNyYyAmJiBqUXVlcnkuaXNQbGFpbk9iamVjdChzcmMpID8gc3JjIDoge307CgkJCQkJfQoKCQkJCQkvLyBOZXZlciBtb3ZlIG9yaWdpbmFsIG9iamVjdHMsIGNsb25lIHRoZW0KCQkJCQl0YXJnZXRbIG5hbWUgXSA9IGpRdWVyeS5leHRlbmQoIGRlZXAsIGNsb25lLCBjb3B5ICk7CgoJCQkJLy8gRG9uJ3QgYnJpbmcgaW4gdW5kZWZpbmVkIHZhbHVlcwoJCQkJfSBlbHNlIGlmICggY29weSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCXRhcmdldFsgbmFtZSBdID0gY29weTsKCQkJCX0KCQkJfQoJCX0KCX0KCgkvLyBSZXR1cm4gdGhlIG1vZGlmaWVkIG9iamVjdAoJcmV0dXJuIHRhcmdldDsKfTsKCmpRdWVyeS5leHRlbmQoewoJLy8gVW5pcXVlIGZvciBlYWNoIGNvcHkgb2YgalF1ZXJ5IG9uIHRoZSBwYWdlCglleHBhbmRvOiAialF1ZXJ5IiArICggdmVyc2lvbiArIE1hdGgucmFuZG9tKCkgKS5yZXBsYWNlKCAvXEQvZywgIiIgKSwKCgkvLyBBc3N1bWUgalF1ZXJ5IGlzIHJlYWR5IHdpdGhvdXQgdGhlIHJlYWR5IG1vZHVsZQoJaXNSZWFkeTogdHJ1ZSwKCgllcnJvcjogZnVuY3Rpb24oIG1zZyApIHsKCQl0aHJvdyBuZXcgRXJyb3IoIG1zZyApOwoJfSwKCglub29wOiBmdW5jdGlvbigpIHt9LAoKCS8vIFNlZSB0ZXN0L3VuaXQvY29yZS5qcyBmb3IgZGV0YWlscyBjb25jZXJuaW5nIGlzRnVuY3Rpb24uCgkvLyBTaW5jZSB2ZXJzaW9uIDEuMywgRE9NIG1ldGhvZHMgYW5kIGZ1bmN0aW9ucyBsaWtlIGFsZXJ0CgkvLyBhcmVuJ3Qgc3VwcG9ydGVkLiBUaGV5IHJldHVybiBmYWxzZSBvbiBJRSAoIzI5NjgpLgoJaXNGdW5jdGlvbjogZnVuY3Rpb24oIG9iaiApIHsKCQlyZXR1cm4galF1ZXJ5LnR5cGUob2JqKSA9PT0gImZ1bmN0aW9uIjsKCX0sCgoJaXNBcnJheTogQXJyYXkuaXNBcnJheSB8fCBmdW5jdGlvbiggb2JqICkgewoJCXJldHVybiBqUXVlcnkudHlwZShvYmopID09PSAiYXJyYXkiOwoJfSwKCglpc1dpbmRvdzogZnVuY3Rpb24oIG9iaiApIHsKCQkvKiBqc2hpbnQgZXFlcWVxOiBmYWxzZSAqLwoJCXJldHVybiBvYmogIT0gbnVsbCAmJiBvYmogPT0gb2JqLndpbmRvdzsKCX0sCgoJaXNOdW1lcmljOiBmdW5jdGlvbiggb2JqICkgewoJCS8vIHBhcnNlRmxvYXQgTmFOcyBudW1lcmljLWNhc3QgZmFsc2UgcG9zaXRpdmVzIChudWxsfHRydWV8ZmFsc2V8IiIpCgkJLy8gLi4uYnV0IG1pc2ludGVycHJldHMgbGVhZGluZy1udW1iZXIgc3RyaW5ncywgcGFydGljdWxhcmx5IGhleCBsaXRlcmFscyAoIjB4Li4uIikKCQkvLyBzdWJ0cmFjdGlvbiBmb3JjZXMgaW5maW5pdGllcyB0byBOYU4KCQlyZXR1cm4gb2JqIC0gcGFyc2VGbG9hdCggb2JqICkgPj0gMDsKCX0sCgoJaXNFbXB0eU9iamVjdDogZnVuY3Rpb24oIG9iaiApIHsKCQl2YXIgbmFtZTsKCQlmb3IgKCBuYW1lIGluIG9iaiApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJaXNQbGFpbk9iamVjdDogZnVuY3Rpb24oIG9iaiApIHsKCQl2YXIga2V5OwoKCQkvLyBNdXN0IGJlIGFuIE9iamVjdC4KCQkvLyBCZWNhdXNlIG9mIElFLCB3ZSBhbHNvIGhhdmUgdG8gY2hlY2sgdGhlIHByZXNlbmNlIG9mIHRoZSBjb25zdHJ1Y3RvciBwcm9wZXJ0eS4KCQkvLyBNYWtlIHN1cmUgdGhhdCBET00gbm9kZXMgYW5kIHdpbmRvdyBvYmplY3RzIGRvbid0IHBhc3MgdGhyb3VnaCwgYXMgd2VsbAoJCWlmICggIW9iaiB8fCBqUXVlcnkudHlwZShvYmopICE9PSAib2JqZWN0IiB8fCBvYmoubm9kZVR5cGUgfHwgalF1ZXJ5LmlzV2luZG93KCBvYmogKSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJdHJ5IHsKCQkJLy8gTm90IG93biBjb25zdHJ1Y3RvciBwcm9wZXJ0eSBtdXN0IGJlIE9iamVjdAoJCQlpZiAoIG9iai5jb25zdHJ1Y3RvciAmJgoJCQkJIWhhc093bi5jYWxsKG9iaiwgImNvbnN0cnVjdG9yIikgJiYKCQkJCSFoYXNPd24uY2FsbChvYmouY29uc3RydWN0b3IucHJvdG90eXBlLCAiaXNQcm90b3R5cGVPZiIpICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSBjYXRjaCAoIGUgKSB7CgkJCS8vIElFOCw5IFdpbGwgdGhyb3cgZXhjZXB0aW9ucyBvbiBjZXJ0YWluIGhvc3Qgb2JqZWN0cyAjOTg5NwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQkvLyBTdXBwb3J0OiBJRTw5CgkJLy8gSGFuZGxlIGl0ZXJhdGlvbiBvdmVyIGluaGVyaXRlZCBwcm9wZXJ0aWVzIGJlZm9yZSBvd24gcHJvcGVydGllcy4KCQlpZiAoIHN1cHBvcnQub3duTGFzdCApIHsKCQkJZm9yICgga2V5IGluIG9iaiApIHsKCQkJCXJldHVybiBoYXNPd24uY2FsbCggb2JqLCBrZXkgKTsKCQkJfQoJCX0KCgkJLy8gT3duIHByb3BlcnRpZXMgYXJlIGVudW1lcmF0ZWQgZmlyc3RseSwgc28gdG8gc3BlZWQgdXAsCgkJLy8gaWYgbGFzdCBvbmUgaXMgb3duLCB0aGVuIGFsbCBwcm9wZXJ0aWVzIGFyZSBvd24uCgkJZm9yICgga2V5IGluIG9iaiApIHt9CgoJCXJldHVybiBrZXkgPT09IHVuZGVmaW5lZCB8fCBoYXNPd24uY2FsbCggb2JqLCBrZXkgKTsKCX0sCgoJdHlwZTogZnVuY3Rpb24oIG9iaiApIHsKCQlpZiAoIG9iaiA9PSBudWxsICkgewoJCQlyZXR1cm4gb2JqICsgIiI7CgkJfQoJCXJldHVybiB0eXBlb2Ygb2JqID09PSAib2JqZWN0IiB8fCB0eXBlb2Ygb2JqID09PSAiZnVuY3Rpb24iID8KCQkJY2xhc3MydHlwZVsgdG9TdHJpbmcuY2FsbChvYmopIF0gfHwgIm9iamVjdCIgOgoJCQl0eXBlb2Ygb2JqOwoJfSwKCgkvLyBFdmFsdWF0ZXMgYSBzY3JpcHQgaW4gYSBnbG9iYWwgY29udGV4dAoJLy8gV29ya2Fyb3VuZHMgYmFzZWQgb24gZmluZGluZ3MgYnkgSmltIERyaXNjb2xsCgkvLyBodHRwOi8vd2VibG9ncy5qYXZhLm5ldC9ibG9nL2RyaXNjb2xsL2FyY2hpdmUvMjAwOS8wOS8wOC9ldmFsLWphdmFzY3JpcHQtZ2xvYmFsLWNvbnRleHQKCWdsb2JhbEV2YWw6IGZ1bmN0aW9uKCBkYXRhICkgewoJCWlmICggZGF0YSAmJiBqUXVlcnkudHJpbSggZGF0YSApICkgewoJCQkvLyBXZSB1c2UgZXhlY1NjcmlwdCBvbiBJbnRlcm5ldCBFeHBsb3JlcgoJCQkvLyBXZSB1c2UgYW4gYW5vbnltb3VzIGZ1bmN0aW9uIHNvIHRoYXQgY29udGV4dCBpcyB3aW5kb3cKCQkJLy8gcmF0aGVyIHRoYW4galF1ZXJ5IGluIEZpcmVmb3gKCQkJKCB3aW5kb3cuZXhlY1NjcmlwdCB8fCBmdW5jdGlvbiggZGF0YSApIHsKCQkJCXdpbmRvd1sgImV2YWwiIF0uY2FsbCggd2luZG93LCBkYXRhICk7CgkJCX0gKSggZGF0YSApOwoJCX0KCX0sCgoJLy8gQ29udmVydCBkYXNoZWQgdG8gY2FtZWxDYXNlOyB1c2VkIGJ5IHRoZSBjc3MgYW5kIGRhdGEgbW9kdWxlcwoJLy8gTWljcm9zb2Z0IGZvcmdvdCB0byBodW1wIHRoZWlyIHZlbmRvciBwcmVmaXggKCM5NTcyKQoJY2FtZWxDYXNlOiBmdW5jdGlvbiggc3RyaW5nICkgewoJCXJldHVybiBzdHJpbmcucmVwbGFjZSggcm1zUHJlZml4LCAibXMtIiApLnJlcGxhY2UoIHJkYXNoQWxwaGEsIGZjYW1lbENhc2UgKTsKCX0sCgoJbm9kZU5hbWU6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCXJldHVybiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbmFtZS50b0xvd2VyQ2FzZSgpOwoJfSwKCgkvLyBhcmdzIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CgllYWNoOiBmdW5jdGlvbiggb2JqLCBjYWxsYmFjaywgYXJncyApIHsKCQl2YXIgdmFsdWUsCgkJCWkgPSAwLAoJCQlsZW5ndGggPSBvYmoubGVuZ3RoLAoJCQlpc0FycmF5ID0gaXNBcnJheWxpa2UoIG9iaiApOwoKCQlpZiAoIGFyZ3MgKSB7CgkJCWlmICggaXNBcnJheSApIHsKCQkJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQkJCXZhbHVlID0gY2FsbGJhY2suYXBwbHkoIG9ialsgaSBdLCBhcmdzICk7CgoJCQkJCWlmICggdmFsdWUgPT09IGZhbHNlICkgewoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlmb3IgKCBpIGluIG9iaiApIHsKCQkJCQl2YWx1ZSA9IGNhbGxiYWNrLmFwcGx5KCBvYmpbIGkgXSwgYXJncyApOwoKCQkJCQlpZiAoIHZhbHVlID09PSBmYWxzZSApIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCS8vIEEgc3BlY2lhbCwgZmFzdCwgY2FzZSBmb3IgdGhlIG1vc3QgY29tbW9uIHVzZSBvZiBlYWNoCgkJfSBlbHNlIHsKCQkJaWYgKCBpc0FycmF5ICkgewoJCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQkJdmFsdWUgPSBjYWxsYmFjay5jYWxsKCBvYmpbIGkgXSwgaSwgb2JqWyBpIF0gKTsKCgkJCQkJaWYgKCB2YWx1ZSA9PT0gZmFsc2UgKSB7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWZvciAoIGkgaW4gb2JqICkgewoJCQkJCXZhbHVlID0gY2FsbGJhY2suY2FsbCggb2JqWyBpIF0sIGksIG9ialsgaSBdICk7CgoJCQkJCWlmICggdmFsdWUgPT09IGZhbHNlICkgewoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8vIFVzZSBuYXRpdmUgU3RyaW5nLnRyaW0gZnVuY3Rpb24gd2hlcmV2ZXIgcG9zc2libGUKCXRyaW06IHRyaW0gJiYgIXRyaW0uY2FsbCgiXHVGRUZGXHhBMCIpID8KCQlmdW5jdGlvbiggdGV4dCApIHsKCQkJcmV0dXJuIHRleHQgPT0gbnVsbCA/CgkJCQkiIiA6CgkJCQl0cmltLmNhbGwoIHRleHQgKTsKCQl9IDoKCgkJLy8gT3RoZXJ3aXNlIHVzZSBvdXIgb3duIHRyaW1taW5nIGZ1bmN0aW9uYWxpdHkKCQlmdW5jdGlvbiggdGV4dCApIHsKCQkJcmV0dXJuIHRleHQgPT0gbnVsbCA/CgkJCQkiIiA6CgkJCQkoIHRleHQgKyAiIiApLnJlcGxhY2UoIHJ0cmltLCAiIiApOwoJCX0sCgoJLy8gcmVzdWx0cyBpcyBmb3IgaW50ZXJuYWwgdXNhZ2Ugb25seQoJbWFrZUFycmF5OiBmdW5jdGlvbiggYXJyLCByZXN1bHRzICkgewoJCXZhciByZXQgPSByZXN1bHRzIHx8IFtdOwoKCQlpZiAoIGFyciAhPSBudWxsICkgewoJCQlpZiAoIGlzQXJyYXlsaWtlKCBPYmplY3QoYXJyKSApICkgewoJCQkJalF1ZXJ5Lm1lcmdlKCByZXQsCgkJCQkJdHlwZW9mIGFyciA9PT0gInN0cmluZyIgPwoJCQkJCVsgYXJyIF0gOiBhcnIKCQkJCSk7CgkJCX0gZWxzZSB7CgkJCQlwdXNoLmNhbGwoIHJldCwgYXJyICk7CgkJCX0KCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoKCWluQXJyYXk6IGZ1bmN0aW9uKCBlbGVtLCBhcnIsIGkgKSB7CgkJdmFyIGxlbjsKCgkJaWYgKCBhcnIgKSB7CgkJCWlmICggaW5kZXhPZiApIHsKCQkJCXJldHVybiBpbmRleE9mLmNhbGwoIGFyciwgZWxlbSwgaSApOwoJCQl9CgoJCQlsZW4gPSBhcnIubGVuZ3RoOwoJCQlpID0gaSA/IGkgPCAwID8gTWF0aC5tYXgoIDAsIGxlbiArIGkgKSA6IGkgOiAwOwoKCQkJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CgkJCQkvLyBTa2lwIGFjY2Vzc2luZyBpbiBzcGFyc2UgYXJyYXlzCgkJCQlpZiAoIGkgaW4gYXJyICYmIGFyclsgaSBdID09PSBlbGVtICkgewoJCQkJCXJldHVybiBpOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gLTE7Cgl9LAoKCW1lcmdlOiBmdW5jdGlvbiggZmlyc3QsIHNlY29uZCApIHsKCQl2YXIgbGVuID0gK3NlY29uZC5sZW5ndGgsCgkJCWogPSAwLAoJCQlpID0gZmlyc3QubGVuZ3RoOwoKCQl3aGlsZSAoIGogPCBsZW4gKSB7CgkJCWZpcnN0WyBpKysgXSA9IHNlY29uZFsgaisrIF07CgkJfQoKCQkvLyBTdXBwb3J0OiBJRTw5CgkJLy8gV29ya2Fyb3VuZCBjYXN0aW5nIG9mIC5sZW5ndGggdG8gTmFOIG9uIG90aGVyd2lzZSBhcnJheWxpa2Ugb2JqZWN0cyAoZS5nLiwgTm9kZUxpc3RzKQoJCWlmICggbGVuICE9PSBsZW4gKSB7CgkJCXdoaWxlICggc2Vjb25kW2pdICE9PSB1bmRlZmluZWQgKSB7CgkJCQlmaXJzdFsgaSsrIF0gPSBzZWNvbmRbIGorKyBdOwoJCQl9CgkJfQoKCQlmaXJzdC5sZW5ndGggPSBpOwoKCQlyZXR1cm4gZmlyc3Q7Cgl9LAoKCWdyZXA6IGZ1bmN0aW9uKCBlbGVtcywgY2FsbGJhY2ssIGludmVydCApIHsKCQl2YXIgY2FsbGJhY2tJbnZlcnNlLAoJCQltYXRjaGVzID0gW10sCgkJCWkgPSAwLAoJCQlsZW5ndGggPSBlbGVtcy5sZW5ndGgsCgkJCWNhbGxiYWNrRXhwZWN0ID0gIWludmVydDsKCgkJLy8gR28gdGhyb3VnaCB0aGUgYXJyYXksIG9ubHkgc2F2aW5nIHRoZSBpdGVtcwoJCS8vIHRoYXQgcGFzcyB0aGUgdmFsaWRhdG9yIGZ1bmN0aW9uCgkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCWNhbGxiYWNrSW52ZXJzZSA9ICFjYWxsYmFjayggZWxlbXNbIGkgXSwgaSApOwoJCQlpZiAoIGNhbGxiYWNrSW52ZXJzZSAhPT0gY2FsbGJhY2tFeHBlY3QgKSB7CgkJCQltYXRjaGVzLnB1c2goIGVsZW1zWyBpIF0gKTsKCQkJfQoJCX0KCgkJcmV0dXJuIG1hdGNoZXM7Cgl9LAoKCS8vIGFyZyBpcyBmb3IgaW50ZXJuYWwgdXNhZ2Ugb25seQoJbWFwOiBmdW5jdGlvbiggZWxlbXMsIGNhbGxiYWNrLCBhcmcgKSB7CgkJdmFyIHZhbHVlLAoJCQlpID0gMCwKCQkJbGVuZ3RoID0gZWxlbXMubGVuZ3RoLAoJCQlpc0FycmF5ID0gaXNBcnJheWxpa2UoIGVsZW1zICksCgkJCXJldCA9IFtdOwoKCQkvLyBHbyB0aHJvdWdoIHRoZSBhcnJheSwgdHJhbnNsYXRpbmcgZWFjaCBvZiB0aGUgaXRlbXMgdG8gdGhlaXIgbmV3IHZhbHVlcwoJCWlmICggaXNBcnJheSApIHsKCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQl2YWx1ZSA9IGNhbGxiYWNrKCBlbGVtc1sgaSBdLCBpLCBhcmcgKTsKCgkJCQlpZiAoIHZhbHVlICE9IG51bGwgKSB7CgkJCQkJcmV0LnB1c2goIHZhbHVlICk7CgkJCQl9CgkJCX0KCgkJLy8gR28gdGhyb3VnaCBldmVyeSBrZXkgb24gdGhlIG9iamVjdCwKCQl9IGVsc2UgewoJCQlmb3IgKCBpIGluIGVsZW1zICkgewoJCQkJdmFsdWUgPSBjYWxsYmFjayggZWxlbXNbIGkgXSwgaSwgYXJnICk7CgoJCQkJaWYgKCB2YWx1ZSAhPSBudWxsICkgewoJCQkJCXJldC5wdXNoKCB2YWx1ZSApOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBGbGF0dGVuIGFueSBuZXN0ZWQgYXJyYXlzCgkJcmV0dXJuIGNvbmNhdC5hcHBseSggW10sIHJldCApOwoJfSwKCgkvLyBBIGdsb2JhbCBHVUlEIGNvdW50ZXIgZm9yIG9iamVjdHMKCWd1aWQ6IDEsCgoJLy8gQmluZCBhIGZ1bmN0aW9uIHRvIGEgY29udGV4dCwgb3B0aW9uYWxseSBwYXJ0aWFsbHkgYXBwbHlpbmcgYW55CgkvLyBhcmd1bWVudHMuCglwcm94eTogZnVuY3Rpb24oIGZuLCBjb250ZXh0ICkgewoJCXZhciBhcmdzLCBwcm94eSwgdG1wOwoKCQlpZiAoIHR5cGVvZiBjb250ZXh0ID09PSAic3RyaW5nIiApIHsKCQkJdG1wID0gZm5bIGNvbnRleHQgXTsKCQkJY29udGV4dCA9IGZuOwoJCQlmbiA9IHRtcDsKCQl9CgoJCS8vIFF1aWNrIGNoZWNrIHRvIGRldGVybWluZSBpZiB0YXJnZXQgaXMgY2FsbGFibGUsIGluIHRoZSBzcGVjCgkJLy8gdGhpcyB0aHJvd3MgYSBUeXBlRXJyb3IsIGJ1dCB3ZSB3aWxsIGp1c3QgcmV0dXJuIHVuZGVmaW5lZC4KCQlpZiAoICFqUXVlcnkuaXNGdW5jdGlvbiggZm4gKSApIHsKCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQl9CgoJCS8vIFNpbXVsYXRlZCBiaW5kCgkJYXJncyA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMiApOwoJCXByb3h5ID0gZnVuY3Rpb24oKSB7CgkJCXJldHVybiBmbi5hcHBseSggY29udGV4dCB8fCB0aGlzLCBhcmdzLmNvbmNhdCggc2xpY2UuY2FsbCggYXJndW1lbnRzICkgKSApOwoJCX07CgoJCS8vIFNldCB0aGUgZ3VpZCBvZiB1bmlxdWUgaGFuZGxlciB0byB0aGUgc2FtZSBvZiBvcmlnaW5hbCBoYW5kbGVyLCBzbyBpdCBjYW4gYmUgcmVtb3ZlZAoJCXByb3h5Lmd1aWQgPSBmbi5ndWlkID0gZm4uZ3VpZCB8fCBqUXVlcnkuZ3VpZCsrOwoKCQlyZXR1cm4gcHJveHk7Cgl9LAoKCW5vdzogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICsoIG5ldyBEYXRlKCkgKTsKCX0sCgoJLy8galF1ZXJ5LnN1cHBvcnQgaXMgbm90IHVzZWQgaW4gQ29yZSBidXQgb3RoZXIgcHJvamVjdHMgYXR0YWNoIHRoZWlyCgkvLyBwcm9wZXJ0aWVzIHRvIGl0IHNvIGl0IG5lZWRzIHRvIGV4aXN0LgoJc3VwcG9ydDogc3VwcG9ydAp9KTsKCi8vIFBvcHVsYXRlIHRoZSBjbGFzczJ0eXBlIG1hcApqUXVlcnkuZWFjaCgiQm9vbGVhbiBOdW1iZXIgU3RyaW5nIEZ1bmN0aW9uIEFycmF5IERhdGUgUmVnRXhwIE9iamVjdCBFcnJvciIuc3BsaXQoIiAiKSwgZnVuY3Rpb24oaSwgbmFtZSkgewoJY2xhc3MydHlwZVsgIltvYmplY3QgIiArIG5hbWUgKyAiXSIgXSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKfSk7CgpmdW5jdGlvbiBpc0FycmF5bGlrZSggb2JqICkgewoJdmFyIGxlbmd0aCA9IG9iai5sZW5ndGgsCgkJdHlwZSA9IGpRdWVyeS50eXBlKCBvYmogKTsKCglpZiAoIHR5cGUgPT09ICJmdW5jdGlvbiIgfHwgalF1ZXJ5LmlzV2luZG93KCBvYmogKSApIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJaWYgKCBvYmoubm9kZVR5cGUgPT09IDEgJiYgbGVuZ3RoICkgewoJCXJldHVybiB0cnVlOwoJfQoKCXJldHVybiB0eXBlID09PSAiYXJyYXkiIHx8IGxlbmd0aCA9PT0gMCB8fAoJCXR5cGVvZiBsZW5ndGggPT09ICJudW1iZXIiICYmIGxlbmd0aCA+IDAgJiYgKCBsZW5ndGggLSAxICkgaW4gb2JqOwp9CnZhciBTaXp6bGUgPQovKiEKICogU2l6emxlIENTUyBTZWxlY3RvciBFbmdpbmUgdjEuMTAuMTYKICogaHR0cDovL3NpenpsZWpzLmNvbS8KICoKICogQ29weXJpZ2h0IDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24sIEluYy4gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UKICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBEYXRlOiAyMDE0LTAxLTEzCiAqLwooZnVuY3Rpb24oIHdpbmRvdyApIHsKCnZhciBpLAoJc3VwcG9ydCwKCUV4cHIsCglnZXRUZXh0LAoJaXNYTUwsCgljb21waWxlLAoJb3V0ZXJtb3N0Q29udGV4dCwKCXNvcnRJbnB1dCwKCWhhc0R1cGxpY2F0ZSwKCgkvLyBMb2NhbCBkb2N1bWVudCB2YXJzCglzZXREb2N1bWVudCwKCWRvY3VtZW50LAoJZG9jRWxlbSwKCWRvY3VtZW50SXNIVE1MLAoJcmJ1Z2d5UVNBLAoJcmJ1Z2d5TWF0Y2hlcywKCW1hdGNoZXMsCgljb250YWlucywKCgkvLyBJbnN0YW5jZS1zcGVjaWZpYyBkYXRhCglleHBhbmRvID0gInNpenpsZSIgKyAtKG5ldyBEYXRlKCkpLAoJcHJlZmVycmVkRG9jID0gd2luZG93LmRvY3VtZW50LAoJZGlycnVucyA9IDAsCglkb25lID0gMCwKCWNsYXNzQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLAoJdG9rZW5DYWNoZSA9IGNyZWF0ZUNhY2hlKCksCgljb21waWxlckNhY2hlID0gY3JlYXRlQ2FjaGUoKSwKCXNvcnRPcmRlciA9IGZ1bmN0aW9uKCBhLCBiICkgewoJCWlmICggYSA9PT0gYiApIHsKCQkJaGFzRHVwbGljYXRlID0gdHJ1ZTsKCQl9CgkJcmV0dXJuIDA7Cgl9LAoKCS8vIEdlbmVyYWwtcHVycG9zZSBjb25zdGFudHMKCXN0cnVuZGVmaW5lZCA9IHR5cGVvZiB1bmRlZmluZWQsCglNQVhfTkVHQVRJVkUgPSAxIDw8IDMxLAoKCS8vIEluc3RhbmNlIG1ldGhvZHMKCWhhc093biA9ICh7fSkuaGFzT3duUHJvcGVydHksCglhcnIgPSBbXSwKCXBvcCA9IGFyci5wb3AsCglwdXNoX25hdGl2ZSA9IGFyci5wdXNoLAoJcHVzaCA9IGFyci5wdXNoLAoJc2xpY2UgPSBhcnIuc2xpY2UsCgkvLyBVc2UgYSBzdHJpcHBlZC1kb3duIGluZGV4T2YgaWYgd2UgY2FuJ3QgdXNlIGEgbmF0aXZlIG9uZQoJaW5kZXhPZiA9IGFyci5pbmRleE9mIHx8IGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciBpID0gMCwKCQkJbGVuID0gdGhpcy5sZW5ndGg7CgkJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CgkJCWlmICggdGhpc1tpXSA9PT0gZWxlbSApIHsKCQkJCXJldHVybiBpOwoJCQl9CgkJfQoJCXJldHVybiAtMTsKCX0sCgoJYm9vbGVhbnMgPSAiY2hlY2tlZHxzZWxlY3RlZHxhc3luY3xhdXRvZm9jdXN8YXV0b3BsYXl8Y29udHJvbHN8ZGVmZXJ8ZGlzYWJsZWR8aGlkZGVufGlzbWFwfGxvb3B8bXVsdGlwbGV8b3BlbnxyZWFkb25seXxyZXF1aXJlZHxzY29wZWQiLAoKCS8vIFJlZ3VsYXIgZXhwcmVzc2lvbnMKCgkvLyBXaGl0ZXNwYWNlIGNoYXJhY3RlcnMgaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1zZWxlY3RvcnMvI3doaXRlc3BhY2UKCXdoaXRlc3BhY2UgPSAiW1xceDIwXFx0XFxyXFxuXFxmXSIsCgkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9jc3MzLXN5bnRheC8jY2hhcmFjdGVycwoJY2hhcmFjdGVyRW5jb2RpbmcgPSAiKD86XFxcXC58W1xcdy1dfFteXFx4MDAtXFx4YTBdKSsiLAoKCS8vIExvb3NlbHkgbW9kZWxlZCBvbiBDU1MgaWRlbnRpZmllciBjaGFyYWN0ZXJzCgkvLyBBbiB1bnF1b3RlZCB2YWx1ZSBzaG91bGQgYmUgYSBDU1MgaWRlbnRpZmllciBodHRwOi8vd3d3LnczLm9yZy9UUi9jc3MzLXNlbGVjdG9ycy8jYXR0cmlidXRlLXNlbGVjdG9ycwoJLy8gUHJvcGVyIHN5bnRheDogaHR0cDovL3d3dy53My5vcmcvVFIvQ1NTMjEvc3luZGF0YS5odG1sI3ZhbHVlLWRlZi1pZGVudGlmaWVyCglpZGVudGlmaWVyID0gY2hhcmFjdGVyRW5jb2RpbmcucmVwbGFjZSggInciLCAidyMiICksCgoJLy8gQWNjZXB0YWJsZSBvcGVyYXRvcnMgaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNhdHRyaWJ1dGUtc2VsZWN0b3JzCglhdHRyaWJ1dGVzID0gIlxcWyIgKyB3aGl0ZXNwYWNlICsgIiooIiArIGNoYXJhY3RlckVuY29kaW5nICsgIikiICsgd2hpdGVzcGFjZSArCgkJIiooPzooWypeJHwhfl0/PSkiICsgd2hpdGVzcGFjZSArICIqKD86KFsnXCJdKSgoPzpcXFxcLnxbXlxcXFxdKSo/KVxcM3woIiArIGlkZW50aWZpZXIgKyAiKXwpfCkiICsgd2hpdGVzcGFjZSArICIqXFxdIiwKCgkvLyBQcmVmZXIgYXJndW1lbnRzIHF1b3RlZCwKCS8vICAgdGhlbiBub3QgY29udGFpbmluZyBwc2V1ZG9zL2JyYWNrZXRzLAoJLy8gICB0aGVuIGF0dHJpYnV0ZSBzZWxlY3RvcnMvbm9uLXBhcmVudGhldGljYWwgZXhwcmVzc2lvbnMsCgkvLyAgIHRoZW4gYW55dGhpbmcgZWxzZQoJLy8gVGhlc2UgcHJlZmVyZW5jZXMgYXJlIGhlcmUgdG8gcmVkdWNlIHRoZSBudW1iZXIgb2Ygc2VsZWN0b3JzCgkvLyAgIG5lZWRpbmcgdG9rZW5pemUgaW4gdGhlIFBTRVVETyBwcmVGaWx0ZXIKCXBzZXVkb3MgPSAiOigiICsgY2hhcmFjdGVyRW5jb2RpbmcgKyAiKSg/OlxcKCgoWydcIl0pKCg/OlxcXFwufFteXFxcXF0pKj8pXFwzfCgoPzpcXFxcLnxbXlxcXFwoKVtcXF1dfCIgKyBhdHRyaWJ1dGVzLnJlcGxhY2UoIDMsIDggKSArICIpKil8LiopXFwpfCkiLAoKCS8vIExlYWRpbmcgYW5kIG5vbi1lc2NhcGVkIHRyYWlsaW5nIHdoaXRlc3BhY2UsIGNhcHR1cmluZyBzb21lIG5vbi13aGl0ZXNwYWNlIGNoYXJhY3RlcnMgcHJlY2VkaW5nIHRoZSBsYXR0ZXIKCXJ0cmltID0gbmV3IFJlZ0V4cCggIl4iICsgd2hpdGVzcGFjZSArICIrfCgoPzpefFteXFxcXF0pKD86XFxcXC4pKikiICsgd2hpdGVzcGFjZSArICIrJCIsICJnIiApLAoKCXJjb21tYSA9IG5ldyBSZWdFeHAoICJeIiArIHdoaXRlc3BhY2UgKyAiKiwiICsgd2hpdGVzcGFjZSArICIqIiApLAoJcmNvbWJpbmF0b3JzID0gbmV3IFJlZ0V4cCggIl4iICsgd2hpdGVzcGFjZSArICIqKFs+K35dfCIgKyB3aGl0ZXNwYWNlICsgIikiICsgd2hpdGVzcGFjZSArICIqIiApLAoKCXJhdHRyaWJ1dGVRdW90ZXMgPSBuZXcgUmVnRXhwKCAiPSIgKyB3aGl0ZXNwYWNlICsgIiooW15cXF0nXCJdKj8pIiArIHdoaXRlc3BhY2UgKyAiKlxcXSIsICJnIiApLAoKCXJwc2V1ZG8gPSBuZXcgUmVnRXhwKCBwc2V1ZG9zICksCglyaWRlbnRpZmllciA9IG5ldyBSZWdFeHAoICJeIiArIGlkZW50aWZpZXIgKyAiJCIgKSwKCgltYXRjaEV4cHIgPSB7CgkJIklEIjogbmV3IFJlZ0V4cCggIl4jKCIgKyBjaGFyYWN0ZXJFbmNvZGluZyArICIpIiApLAoJCSJDTEFTUyI6IG5ldyBSZWdFeHAoICJeXFwuKCIgKyBjaGFyYWN0ZXJFbmNvZGluZyArICIpIiApLAoJCSJUQUciOiBuZXcgUmVnRXhwKCAiXigiICsgY2hhcmFjdGVyRW5jb2RpbmcucmVwbGFjZSggInciLCAidyoiICkgKyAiKSIgKSwKCQkiQVRUUiI6IG5ldyBSZWdFeHAoICJeIiArIGF0dHJpYnV0ZXMgKSwKCQkiUFNFVURPIjogbmV3IFJlZ0V4cCggIl4iICsgcHNldWRvcyApLAoJCSJDSElMRCI6IG5ldyBSZWdFeHAoICJeOihvbmx5fGZpcnN0fGxhc3R8bnRofG50aC1sYXN0KS0oY2hpbGR8b2YtdHlwZSkoPzpcXCgiICsgd2hpdGVzcGFjZSArCgkJCSIqKGV2ZW58b2RkfCgoWystXXwpKFxcZCopbnwpIiArIHdoaXRlc3BhY2UgKyAiKig/OihbKy1dfCkiICsgd2hpdGVzcGFjZSArCgkJCSIqKFxcZCspfCkpIiArIHdoaXRlc3BhY2UgKyAiKlxcKXwpIiwgImkiICksCgkJImJvb2wiOiBuZXcgUmVnRXhwKCAiXig/OiIgKyBib29sZWFucyArICIpJCIsICJpIiApLAoJCS8vIEZvciB1c2UgaW4gbGlicmFyaWVzIGltcGxlbWVudGluZyAuaXMoKQoJCS8vIFdlIHVzZSB0aGlzIGZvciBQT1MgbWF0Y2hpbmcgaW4gYHNlbGVjdGAKCQkibmVlZHNDb250ZXh0IjogbmV3IFJlZ0V4cCggIl4iICsgd2hpdGVzcGFjZSArICIqWz4rfl18OihldmVufG9kZHxlcXxndHxsdHxudGh8Zmlyc3R8bGFzdCkoPzpcXCgiICsKCQkJd2hpdGVzcGFjZSArICIqKCg/Oi1cXGQpP1xcZCopIiArIHdoaXRlc3BhY2UgKyAiKlxcKXwpKD89W14tXXwkKSIsICJpIiApCgl9LAoKCXJpbnB1dHMgPSAvXig/OmlucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b24pJC9pLAoJcmhlYWRlciA9IC9eaFxkJC9pLAoKCXJuYXRpdmUgPSAvXltee10rXHtccypcW25hdGl2ZSBcdy8sCgoJLy8gRWFzaWx5LXBhcnNlYWJsZS9yZXRyaWV2YWJsZSBJRCBvciBUQUcgb3IgQ0xBU1Mgc2VsZWN0b3JzCglycXVpY2tFeHByID0gL14oPzojKFtcdy1dKyl8KFx3Kyl8XC4oW1x3LV0rKSkkLywKCglyc2libGluZyA9IC9bK35dLywKCXJlc2NhcGUgPSAvJ3xcXC9nLAoKCS8vIENTUyBlc2NhcGVzIGh0dHA6Ly93d3cudzMub3JnL1RSL0NTUzIxL3N5bmRhdGEuaHRtbCNlc2NhcGVkLWNoYXJhY3RlcnMKCXJ1bmVzY2FwZSA9IG5ldyBSZWdFeHAoICJcXFxcKFtcXGRhLWZdezEsNn0iICsgd2hpdGVzcGFjZSArICI/fCgiICsgd2hpdGVzcGFjZSArICIpfC4pIiwgImlnIiApLAoJZnVuZXNjYXBlID0gZnVuY3Rpb24oIF8sIGVzY2FwZWQsIGVzY2FwZWRXaGl0ZXNwYWNlICkgewoJCXZhciBoaWdoID0gIjB4IiArIGVzY2FwZWQgLSAweDEwMDAwOwoJCS8vIE5hTiBtZWFucyBub24tY29kZXBvaW50CgkJLy8gU3VwcG9ydDogRmlyZWZveAoJCS8vIFdvcmthcm91bmQgZXJyb25lb3VzIG51bWVyaWMgaW50ZXJwcmV0YXRpb24gb2YgKyIweCIKCQlyZXR1cm4gaGlnaCAhPT0gaGlnaCB8fCBlc2NhcGVkV2hpdGVzcGFjZSA/CgkJCWVzY2FwZWQgOgoJCQloaWdoIDwgMCA/CgkJCQkvLyBCTVAgY29kZXBvaW50CgkJCQlTdHJpbmcuZnJvbUNoYXJDb2RlKCBoaWdoICsgMHgxMDAwMCApIDoKCQkJCS8vIFN1cHBsZW1lbnRhbCBQbGFuZSBjb2RlcG9pbnQgKHN1cnJvZ2F0ZSBwYWlyKQoJCQkJU3RyaW5nLmZyb21DaGFyQ29kZSggaGlnaCA+PiAxMCB8IDB4RDgwMCwgaGlnaCAmIDB4M0ZGIHwgMHhEQzAwICk7Cgl9OwoKLy8gT3B0aW1pemUgZm9yIHB1c2guYXBwbHkoIF8sIE5vZGVMaXN0ICkKdHJ5IHsKCXB1c2guYXBwbHkoCgkJKGFyciA9IHNsaWNlLmNhbGwoIHByZWZlcnJlZERvYy5jaGlsZE5vZGVzICkpLAoJCXByZWZlcnJlZERvYy5jaGlsZE5vZGVzCgkpOwoJLy8gU3VwcG9ydDogQW5kcm9pZDw0LjAKCS8vIERldGVjdCBzaWxlbnRseSBmYWlsaW5nIHB1c2guYXBwbHkKCWFyclsgcHJlZmVycmVkRG9jLmNoaWxkTm9kZXMubGVuZ3RoIF0ubm9kZVR5cGU7Cn0gY2F0Y2ggKCBlICkgewoJcHVzaCA9IHsgYXBwbHk6IGFyci5sZW5ndGggPwoKCQkvLyBMZXZlcmFnZSBzbGljZSBpZiBwb3NzaWJsZQoJCWZ1bmN0aW9uKCB0YXJnZXQsIGVscyApIHsKCQkJcHVzaF9uYXRpdmUuYXBwbHkoIHRhcmdldCwgc2xpY2UuY2FsbChlbHMpICk7CgkJfSA6CgoJCS8vIFN1cHBvcnQ6IElFPDkKCQkvLyBPdGhlcndpc2UgYXBwZW5kIGRpcmVjdGx5CgkJZnVuY3Rpb24oIHRhcmdldCwgZWxzICkgewoJCQl2YXIgaiA9IHRhcmdldC5sZW5ndGgsCgkJCQlpID0gMDsKCQkJLy8gQ2FuJ3QgdHJ1c3QgTm9kZUxpc3QubGVuZ3RoCgkJCXdoaWxlICggKHRhcmdldFtqKytdID0gZWxzW2krK10pICkge30KCQkJdGFyZ2V0Lmxlbmd0aCA9IGogLSAxOwoJCX0KCX07Cn0KCmZ1bmN0aW9uIFNpenpsZSggc2VsZWN0b3IsIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQgKSB7Cgl2YXIgbWF0Y2gsIGVsZW0sIG0sIG5vZGVUeXBlLAoJCS8vIFFTQSB2YXJzCgkJaSwgZ3JvdXBzLCBvbGQsIG5pZCwgbmV3Q29udGV4dCwgbmV3U2VsZWN0b3I7CgoJaWYgKCAoIGNvbnRleHQgPyBjb250ZXh0Lm93bmVyRG9jdW1lbnQgfHwgY29udGV4dCA6IHByZWZlcnJlZERvYyApICE9PSBkb2N1bWVudCApIHsKCQlzZXREb2N1bWVudCggY29udGV4dCApOwoJfQoKCWNvbnRleHQgPSBjb250ZXh0IHx8IGRvY3VtZW50OwoJcmVzdWx0cyA9IHJlc3VsdHMgfHwgW107CgoJaWYgKCAhc2VsZWN0b3IgfHwgdHlwZW9mIHNlbGVjdG9yICE9PSAic3RyaW5nIiApIHsKCQlyZXR1cm4gcmVzdWx0czsKCX0KCglpZiAoIChub2RlVHlwZSA9IGNvbnRleHQubm9kZVR5cGUpICE9PSAxICYmIG5vZGVUeXBlICE9PSA5ICkgewoJCXJldHVybiBbXTsKCX0KCglpZiAoIGRvY3VtZW50SXNIVE1MICYmICFzZWVkICkgewoKCQkvLyBTaG9ydGN1dHMKCQlpZiAoIChtYXRjaCA9IHJxdWlja0V4cHIuZXhlYyggc2VsZWN0b3IgKSkgKSB7CgkJCS8vIFNwZWVkLXVwOiBTaXp6bGUoIiNJRCIpCgkJCWlmICggKG0gPSBtYXRjaFsxXSkgKSB7CgkJCQlpZiAoIG5vZGVUeXBlID09PSA5ICkgewoJCQkJCWVsZW0gPSBjb250ZXh0LmdldEVsZW1lbnRCeUlkKCBtICk7CgkJCQkJLy8gQ2hlY2sgcGFyZW50Tm9kZSB0byBjYXRjaCB3aGVuIEJsYWNrYmVycnkgNC42IHJldHVybnMKCQkJCQkvLyBub2RlcyB0aGF0IGFyZSBubyBsb25nZXIgaW4gdGhlIGRvY3VtZW50IChqUXVlcnkgIzY5NjMpCgkJCQkJaWYgKCBlbGVtICYmIGVsZW0ucGFyZW50Tm9kZSApIHsKCQkJCQkJLy8gSGFuZGxlIHRoZSBjYXNlIHdoZXJlIElFLCBPcGVyYSwgYW5kIFdlYmtpdCByZXR1cm4gaXRlbXMKCQkJCQkJLy8gYnkgbmFtZSBpbnN0ZWFkIG9mIElECgkJCQkJCWlmICggZWxlbS5pZCA9PT0gbSApIHsKCQkJCQkJCXJlc3VsdHMucHVzaCggZWxlbSApOwoJCQkJCQkJcmV0dXJuIHJlc3VsdHM7CgkJCQkJCX0KCQkJCQl9IGVsc2UgewoJCQkJCQlyZXR1cm4gcmVzdWx0czsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCS8vIENvbnRleHQgaXMgbm90IGEgZG9jdW1lbnQKCQkJCQlpZiAoIGNvbnRleHQub3duZXJEb2N1bWVudCAmJiAoZWxlbSA9IGNvbnRleHQub3duZXJEb2N1bWVudC5nZXRFbGVtZW50QnlJZCggbSApKSAmJgoJCQkJCQljb250YWlucyggY29udGV4dCwgZWxlbSApICYmIGVsZW0uaWQgPT09IG0gKSB7CgkJCQkJCXJlc3VsdHMucHVzaCggZWxlbSApOwoJCQkJCQlyZXR1cm4gcmVzdWx0czsKCQkJCQl9CgkJCQl9CgoJCQkvLyBTcGVlZC11cDogU2l6emxlKCJUQUciKQoJCQl9IGVsc2UgaWYgKCBtYXRjaFsyXSApIHsKCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHNlbGVjdG9yICkgKTsKCQkJCXJldHVybiByZXN1bHRzOwoKCQkJLy8gU3BlZWQtdXA6IFNpenpsZSgiLkNMQVNTIikKCQkJfSBlbHNlIGlmICggKG0gPSBtYXRjaFszXSkgJiYgc3VwcG9ydC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSApIHsKCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSggbSApICk7CgkJCQlyZXR1cm4gcmVzdWx0czsKCQkJfQoJCX0KCgkJLy8gUVNBIHBhdGgKCQlpZiAoIHN1cHBvcnQucXNhICYmICghcmJ1Z2d5UVNBIHx8ICFyYnVnZ3lRU0EudGVzdCggc2VsZWN0b3IgKSkgKSB7CgkJCW5pZCA9IG9sZCA9IGV4cGFuZG87CgkJCW5ld0NvbnRleHQgPSBjb250ZXh0OwoJCQluZXdTZWxlY3RvciA9IG5vZGVUeXBlID09PSA5ICYmIHNlbGVjdG9yOwoKCQkJLy8gcVNBIHdvcmtzIHN0cmFuZ2VseSBvbiBFbGVtZW50LXJvb3RlZCBxdWVyaWVzCgkJCS8vIFdlIGNhbiB3b3JrIGFyb3VuZCB0aGlzIGJ5IHNwZWNpZnlpbmcgYW4gZXh0cmEgSUQgb24gdGhlIHJvb3QKCQkJLy8gYW5kIHdvcmtpbmcgdXAgZnJvbSB0aGVyZSAoVGhhbmtzIHRvIEFuZHJldyBEdXBvbnQgZm9yIHRoZSB0ZWNobmlxdWUpCgkJCS8vIElFIDggZG9lc24ndCB3b3JrIG9uIG9iamVjdCBlbGVtZW50cwoJCQlpZiAoIG5vZGVUeXBlID09PSAxICYmIGNvbnRleHQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gIm9iamVjdCIgKSB7CgkJCQlncm91cHMgPSB0b2tlbml6ZSggc2VsZWN0b3IgKTsKCgkJCQlpZiAoIChvbGQgPSBjb250ZXh0LmdldEF0dHJpYnV0ZSgiaWQiKSkgKSB7CgkJCQkJbmlkID0gb2xkLnJlcGxhY2UoIHJlc2NhcGUsICJcXCQmIiApOwoJCQkJfSBlbHNlIHsKCQkJCQljb250ZXh0LnNldEF0dHJpYnV0ZSggImlkIiwgbmlkICk7CgkJCQl9CgkJCQluaWQgPSAiW2lkPSciICsgbmlkICsgIiddICI7CgoJCQkJaSA9IGdyb3Vwcy5sZW5ndGg7CgkJCQl3aGlsZSAoIGktLSApIHsKCQkJCQlncm91cHNbaV0gPSBuaWQgKyB0b1NlbGVjdG9yKCBncm91cHNbaV0gKTsKCQkJCX0KCQkJCW5ld0NvbnRleHQgPSByc2libGluZy50ZXN0KCBzZWxlY3RvciApICYmIHRlc3RDb250ZXh0KCBjb250ZXh0LnBhcmVudE5vZGUgKSB8fCBjb250ZXh0OwoJCQkJbmV3U2VsZWN0b3IgPSBncm91cHMuam9pbigiLCIpOwoJCQl9CgoJCQlpZiAoIG5ld1NlbGVjdG9yICkgewoJCQkJdHJ5IHsKCQkJCQlwdXNoLmFwcGx5KCByZXN1bHRzLAoJCQkJCQluZXdDb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwoIG5ld1NlbGVjdG9yICkKCQkJCQkpOwoJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJfSBjYXRjaChxc2FFcnJvcikgewoJCQkJfSBmaW5hbGx5IHsKCQkJCQlpZiAoICFvbGQgKSB7CgkJCQkJCWNvbnRleHQucmVtb3ZlQXR0cmlidXRlKCJpZCIpOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCX0KCgkvLyBBbGwgb3RoZXJzCglyZXR1cm4gc2VsZWN0KCBzZWxlY3Rvci5yZXBsYWNlKCBydHJpbSwgIiQxIiApLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkICk7Cn0KCi8qKgogKiBDcmVhdGUga2V5LXZhbHVlIGNhY2hlcyBvZiBsaW1pdGVkIHNpemUKICogQHJldHVybnMge0Z1bmN0aW9uKHN0cmluZywgT2JqZWN0KX0gUmV0dXJucyB0aGUgT2JqZWN0IGRhdGEgYWZ0ZXIgc3RvcmluZyBpdCBvbiBpdHNlbGYgd2l0aAogKglwcm9wZXJ0eSBuYW1lIHRoZSAoc3BhY2Utc3VmZml4ZWQpIHN0cmluZyBhbmQgKGlmIHRoZSBjYWNoZSBpcyBsYXJnZXIgdGhhbiBFeHByLmNhY2hlTGVuZ3RoKQogKglkZWxldGluZyB0aGUgb2xkZXN0IGVudHJ5CiAqLwpmdW5jdGlvbiBjcmVhdGVDYWNoZSgpIHsKCXZhciBrZXlzID0gW107CgoJZnVuY3Rpb24gY2FjaGUoIGtleSwgdmFsdWUgKSB7CgkJLy8gVXNlIChrZXkgKyAiICIpIHRvIGF2b2lkIGNvbGxpc2lvbiB3aXRoIG5hdGl2ZSBwcm90b3R5cGUgcHJvcGVydGllcyAoc2VlIElzc3VlICMxNTcpCgkJaWYgKCBrZXlzLnB1c2goIGtleSArICIgIiApID4gRXhwci5jYWNoZUxlbmd0aCApIHsKCQkJLy8gT25seSBrZWVwIHRoZSBtb3N0IHJlY2VudCBlbnRyaWVzCgkJCWRlbGV0ZSBjYWNoZVsga2V5cy5zaGlmdCgpIF07CgkJfQoJCXJldHVybiAoY2FjaGVbIGtleSArICIgIiBdID0gdmFsdWUpOwoJfQoJcmV0dXJuIGNhY2hlOwp9CgovKioKICogTWFyayBhIGZ1bmN0aW9uIGZvciBzcGVjaWFsIHVzZSBieSBTaXp6bGUKICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gVGhlIGZ1bmN0aW9uIHRvIG1hcmsKICovCmZ1bmN0aW9uIG1hcmtGdW5jdGlvbiggZm4gKSB7CglmblsgZXhwYW5kbyBdID0gdHJ1ZTsKCXJldHVybiBmbjsKfQoKLyoqCiAqIFN1cHBvcnQgdGVzdGluZyB1c2luZyBhbiBlbGVtZW50CiAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFBhc3NlZCB0aGUgY3JlYXRlZCBkaXYgYW5kIGV4cGVjdHMgYSBib29sZWFuIHJlc3VsdAogKi8KZnVuY3Rpb24gYXNzZXJ0KCBmbiApIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCgl0cnkgewoJCXJldHVybiAhIWZuKCBkaXYgKTsKCX0gY2F0Y2ggKGUpIHsKCQlyZXR1cm4gZmFsc2U7Cgl9IGZpbmFsbHkgewoJCS8vIFJlbW92ZSBmcm9tIGl0cyBwYXJlbnQgYnkgZGVmYXVsdAoJCWlmICggZGl2LnBhcmVudE5vZGUgKSB7CgkJCWRpdi5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCBkaXYgKTsKCQl9CgkJLy8gcmVsZWFzZSBtZW1vcnkgaW4gSUUKCQlkaXYgPSBudWxsOwoJfQp9CgovKioKICogQWRkcyB0aGUgc2FtZSBoYW5kbGVyIGZvciBhbGwgb2YgdGhlIHNwZWNpZmllZCBhdHRycwogKiBAcGFyYW0ge1N0cmluZ30gYXR0cnMgUGlwZS1zZXBhcmF0ZWQgbGlzdCBvZiBhdHRyaWJ1dGVzCiAqIEBwYXJhbSB7RnVuY3Rpb259IGhhbmRsZXIgVGhlIG1ldGhvZCB0aGF0IHdpbGwgYmUgYXBwbGllZAogKi8KZnVuY3Rpb24gYWRkSGFuZGxlKCBhdHRycywgaGFuZGxlciApIHsKCXZhciBhcnIgPSBhdHRycy5zcGxpdCgifCIpLAoJCWkgPSBhdHRycy5sZW5ndGg7CgoJd2hpbGUgKCBpLS0gKSB7CgkJRXhwci5hdHRySGFuZGxlWyBhcnJbaV0gXSA9IGhhbmRsZXI7Cgl9Cn0KCi8qKgogKiBDaGVja3MgZG9jdW1lbnQgb3JkZXIgb2YgdHdvIHNpYmxpbmdzCiAqIEBwYXJhbSB7RWxlbWVudH0gYQogKiBAcGFyYW0ge0VsZW1lbnR9IGIKICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyBsZXNzIHRoYW4gMCBpZiBhIHByZWNlZGVzIGIsIGdyZWF0ZXIgdGhhbiAwIGlmIGEgZm9sbG93cyBiCiAqLwpmdW5jdGlvbiBzaWJsaW5nQ2hlY2soIGEsIGIgKSB7Cgl2YXIgY3VyID0gYiAmJiBhLAoJCWRpZmYgPSBjdXIgJiYgYS5ub2RlVHlwZSA9PT0gMSAmJiBiLm5vZGVUeXBlID09PSAxICYmCgkJCSggfmIuc291cmNlSW5kZXggfHwgTUFYX05FR0FUSVZFICkgLQoJCQkoIH5hLnNvdXJjZUluZGV4IHx8IE1BWF9ORUdBVElWRSApOwoKCS8vIFVzZSBJRSBzb3VyY2VJbmRleCBpZiBhdmFpbGFibGUgb24gYm90aCBub2RlcwoJaWYgKCBkaWZmICkgewoJCXJldHVybiBkaWZmOwoJfQoKCS8vIENoZWNrIGlmIGIgZm9sbG93cyBhCglpZiAoIGN1ciApIHsKCQl3aGlsZSAoIChjdXIgPSBjdXIubmV4dFNpYmxpbmcpICkgewoJCQlpZiAoIGN1ciA9PT0gYiApIHsKCQkJCXJldHVybiAtMTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gYSA/IDEgOiAtMTsKfQoKLyoqCiAqIFJldHVybnMgYSBmdW5jdGlvbiB0byB1c2UgaW4gcHNldWRvcyBmb3IgaW5wdXQgdHlwZXMKICogQHBhcmFtIHtTdHJpbmd9IHR5cGUKICovCmZ1bmN0aW9uIGNyZWF0ZUlucHV0UHNldWRvKCB0eXBlICkgewoJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciBuYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoJCXJldHVybiBuYW1lID09PSAiaW5wdXQiICYmIGVsZW0udHlwZSA9PT0gdHlwZTsKCX07Cn0KCi8qKgogKiBSZXR1cm5zIGEgZnVuY3Rpb24gdG8gdXNlIGluIHBzZXVkb3MgZm9yIGJ1dHRvbnMKICogQHBhcmFtIHtTdHJpbmd9IHR5cGUKICovCmZ1bmN0aW9uIGNyZWF0ZUJ1dHRvblBzZXVkbyggdHlwZSApIHsKCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQl2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCQlyZXR1cm4gKG5hbWUgPT09ICJpbnB1dCIgfHwgbmFtZSA9PT0gImJ1dHRvbiIpICYmIGVsZW0udHlwZSA9PT0gdHlwZTsKCX07Cn0KCi8qKgogKiBSZXR1cm5zIGEgZnVuY3Rpb24gdG8gdXNlIGluIHBzZXVkb3MgZm9yIHBvc2l0aW9uYWxzCiAqIEBwYXJhbSB7RnVuY3Rpb259IGZuCiAqLwpmdW5jdGlvbiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKCBmbiApIHsKCXJldHVybiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIGFyZ3VtZW50ICkgewoJCWFyZ3VtZW50ID0gK2FyZ3VtZW50OwoJCXJldHVybiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlZWQsIG1hdGNoZXMgKSB7CgkJCXZhciBqLAoJCQkJbWF0Y2hJbmRleGVzID0gZm4oIFtdLCBzZWVkLmxlbmd0aCwgYXJndW1lbnQgKSwKCQkJCWkgPSBtYXRjaEluZGV4ZXMubGVuZ3RoOwoKCQkJLy8gTWF0Y2ggZWxlbWVudHMgZm91bmQgYXQgdGhlIHNwZWNpZmllZCBpbmRleGVzCgkJCXdoaWxlICggaS0tICkgewoJCQkJaWYgKCBzZWVkWyAoaiA9IG1hdGNoSW5kZXhlc1tpXSkgXSApIHsKCQkJCQlzZWVkW2pdID0gIShtYXRjaGVzW2pdID0gc2VlZFtqXSk7CgkJCQl9CgkJCX0KCQl9KTsKCX0pOwp9CgovKioKICogQ2hlY2tzIGEgbm9kZSBmb3IgdmFsaWRpdHkgYXMgYSBTaXp6bGUgY29udGV4dAogKiBAcGFyYW0ge0VsZW1lbnR8T2JqZWN0PX0gY29udGV4dAogKiBAcmV0dXJucyB7RWxlbWVudHxPYmplY3R8Qm9vbGVhbn0gVGhlIGlucHV0IG5vZGUgaWYgYWNjZXB0YWJsZSwgb3RoZXJ3aXNlIGEgZmFsc3kgdmFsdWUKICovCmZ1bmN0aW9uIHRlc3RDb250ZXh0KCBjb250ZXh0ICkgewoJcmV0dXJuIGNvbnRleHQgJiYgdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09IHN0cnVuZGVmaW5lZCAmJiBjb250ZXh0Owp9CgovLyBFeHBvc2Ugc3VwcG9ydCB2YXJzIGZvciBjb252ZW5pZW5jZQpzdXBwb3J0ID0gU2l6emxlLnN1cHBvcnQgPSB7fTsKCi8qKgogKiBEZXRlY3RzIFhNTCBub2RlcwogKiBAcGFyYW0ge0VsZW1lbnR8T2JqZWN0fSBlbGVtIEFuIGVsZW1lbnQgb3IgYSBkb2N1bWVudAogKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZmYgZWxlbSBpcyBhIG5vbi1IVE1MIFhNTCBub2RlCiAqLwppc1hNTCA9IFNpenpsZS5pc1hNTCA9IGZ1bmN0aW9uKCBlbGVtICkgewoJLy8gZG9jdW1lbnRFbGVtZW50IGlzIHZlcmlmaWVkIGZvciBjYXNlcyB3aGVyZSBpdCBkb2Vzbid0IHlldCBleGlzdAoJLy8gKHN1Y2ggYXMgbG9hZGluZyBpZnJhbWVzIGluIElFIC0gIzQ4MzMpCgl2YXIgZG9jdW1lbnRFbGVtZW50ID0gZWxlbSAmJiAoZWxlbS5vd25lckRvY3VtZW50IHx8IGVsZW0pLmRvY3VtZW50RWxlbWVudDsKCXJldHVybiBkb2N1bWVudEVsZW1lbnQgPyBkb2N1bWVudEVsZW1lbnQubm9kZU5hbWUgIT09ICJIVE1MIiA6IGZhbHNlOwp9OwoKLyoqCiAqIFNldHMgZG9jdW1lbnQtcmVsYXRlZCB2YXJpYWJsZXMgb25jZSBiYXNlZCBvbiB0aGUgY3VycmVudCBkb2N1bWVudAogKiBAcGFyYW0ge0VsZW1lbnR8T2JqZWN0fSBbZG9jXSBBbiBlbGVtZW50IG9yIGRvY3VtZW50IG9iamVjdCB0byB1c2UgdG8gc2V0IHRoZSBkb2N1bWVudAogKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjdXJyZW50IGRvY3VtZW50CiAqLwpzZXREb2N1bWVudCA9IFNpenpsZS5zZXREb2N1bWVudCA9IGZ1bmN0aW9uKCBub2RlICkgewoJdmFyIGhhc0NvbXBhcmUsCgkJZG9jID0gbm9kZSA/IG5vZGUub3duZXJEb2N1bWVudCB8fCBub2RlIDogcHJlZmVycmVkRG9jLAoJCXBhcmVudCA9IGRvYy5kZWZhdWx0VmlldzsKCgkvLyBJZiBubyBkb2N1bWVudCBhbmQgZG9jdW1lbnRFbGVtZW50IGlzIGF2YWlsYWJsZSwgcmV0dXJuCglpZiAoIGRvYyA9PT0gZG9jdW1lbnQgfHwgZG9jLm5vZGVUeXBlICE9PSA5IHx8ICFkb2MuZG9jdW1lbnRFbGVtZW50ICkgewoJCXJldHVybiBkb2N1bWVudDsKCX0KCgkvLyBTZXQgb3VyIGRvY3VtZW50Cglkb2N1bWVudCA9IGRvYzsKCWRvY0VsZW0gPSBkb2MuZG9jdW1lbnRFbGVtZW50OwoKCS8vIFN1cHBvcnQgdGVzdHMKCWRvY3VtZW50SXNIVE1MID0gIWlzWE1MKCBkb2MgKTsKCgkvLyBTdXBwb3J0OiBJRT44CgkvLyBJZiBpZnJhbWUgZG9jdW1lbnQgaXMgYXNzaWduZWQgdG8gImRvY3VtZW50IiB2YXJpYWJsZSBhbmQgaWYgaWZyYW1lIGhhcyBiZWVuIHJlbG9hZGVkLAoJLy8gSUUgd2lsbCB0aHJvdyAicGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gYWNjZXNzaW5nICJkb2N1bWVudCIgdmFyaWFibGUsIHNlZSBqUXVlcnkgIzEzOTM2CgkvLyBJRTYtOCBkbyBub3Qgc3VwcG9ydCB0aGUgZGVmYXVsdFZpZXcgcHJvcGVydHkgc28gcGFyZW50IHdpbGwgYmUgdW5kZWZpbmVkCglpZiAoIHBhcmVudCAmJiBwYXJlbnQgIT09IHBhcmVudC50b3AgKSB7CgkJLy8gSUUxMSBkb2VzIG5vdCBoYXZlIGF0dGFjaEV2ZW50LCBzbyBhbGwgbXVzdCBzdWZmZXIKCQlpZiAoIHBhcmVudC5hZGRFdmVudExpc3RlbmVyICkgewoJCQlwYXJlbnQuYWRkRXZlbnRMaXN0ZW5lciggInVubG9hZCIsIGZ1bmN0aW9uKCkgewoJCQkJc2V0RG9jdW1lbnQoKTsKCQkJfSwgZmFsc2UgKTsKCQl9IGVsc2UgaWYgKCBwYXJlbnQuYXR0YWNoRXZlbnQgKSB7CgkJCXBhcmVudC5hdHRhY2hFdmVudCggIm9udW5sb2FkIiwgZnVuY3Rpb24oKSB7CgkJCQlzZXREb2N1bWVudCgpOwoJCQl9KTsKCQl9Cgl9CgoJLyogQXR0cmlidXRlcwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwoKCS8vIFN1cHBvcnQ6IElFPDgKCS8vIFZlcmlmeSB0aGF0IGdldEF0dHJpYnV0ZSByZWFsbHkgcmV0dXJucyBhdHRyaWJ1dGVzIGFuZCBub3QgcHJvcGVydGllcyAoZXhjZXB0aW5nIElFOCBib29sZWFucykKCXN1cHBvcnQuYXR0cmlidXRlcyA9IGFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJCWRpdi5jbGFzc05hbWUgPSAiaSI7CgkJcmV0dXJuICFkaXYuZ2V0QXR0cmlidXRlKCJjbGFzc05hbWUiKTsKCX0pOwoKCS8qIGdldEVsZW1lbnQocylCeSoKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KCgkvLyBDaGVjayBpZiBnZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpIHJldHVybnMgb25seSBlbGVtZW50cwoJc3VwcG9ydC5nZXRFbGVtZW50c0J5VGFnTmFtZSA9IGFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJCWRpdi5hcHBlbmRDaGlsZCggZG9jLmNyZWF0ZUNvbW1lbnQoIiIpICk7CgkJcmV0dXJuICFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKS5sZW5ndGg7Cgl9KTsKCgkvLyBDaGVjayBpZiBnZXRFbGVtZW50c0J5Q2xhc3NOYW1lIGNhbiBiZSB0cnVzdGVkCglzdXBwb3J0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgPSBybmF0aXZlLnRlc3QoIGRvYy5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICkgJiYgYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CgkJZGl2LmlubmVySFRNTCA9ICI8ZGl2IGNsYXNzPSdhJz48L2Rpdj48ZGl2IGNsYXNzPSdhIGknPjwvZGl2PiI7CgoJCS8vIFN1cHBvcnQ6IFNhZmFyaTw0CgkJLy8gQ2F0Y2ggY2xhc3Mgb3Zlci1jYWNoaW5nCgkJZGl2LmZpcnN0Q2hpbGQuY2xhc3NOYW1lID0gImkiOwoJCS8vIFN1cHBvcnQ6IE9wZXJhPDEwCgkJLy8gQ2F0Y2ggZ0VCQ04gZmFpbHVyZSB0byBmaW5kIG5vbi1sZWFkaW5nIGNsYXNzZXMKCQlyZXR1cm4gZGl2LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoImkiKS5sZW5ndGggPT09IDI7Cgl9KTsKCgkvLyBTdXBwb3J0OiBJRTwxMAoJLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudEJ5SWQgcmV0dXJucyBlbGVtZW50cyBieSBuYW1lCgkvLyBUaGUgYnJva2VuIGdldEVsZW1lbnRCeUlkIG1ldGhvZHMgZG9uJ3QgcGljayB1cCBwcm9ncmFtYXRpY2FsbHktc2V0IG5hbWVzLAoJLy8gc28gdXNlIGEgcm91bmRhYm91dCBnZXRFbGVtZW50c0J5TmFtZSB0ZXN0CglzdXBwb3J0LmdldEJ5SWQgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQlkb2NFbGVtLmFwcGVuZENoaWxkKCBkaXYgKS5pZCA9IGV4cGFuZG87CgkJcmV0dXJuICFkb2MuZ2V0RWxlbWVudHNCeU5hbWUgfHwgIWRvYy5nZXRFbGVtZW50c0J5TmFtZSggZXhwYW5kbyApLmxlbmd0aDsKCX0pOwoKCS8vIElEIGZpbmQgYW5kIGZpbHRlcgoJaWYgKCBzdXBwb3J0LmdldEJ5SWQgKSB7CgkJRXhwci5maW5kWyJJRCJdID0gZnVuY3Rpb24oIGlkLCBjb250ZXh0ICkgewoJCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRCeUlkICE9PSBzdHJ1bmRlZmluZWQgJiYgZG9jdW1lbnRJc0hUTUwgKSB7CgkJCQl2YXIgbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoIGlkICk7CgkJCQkvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwoJCQkJLy8gbm9kZXMgdGhhdCBhcmUgbm8gbG9uZ2VyIGluIHRoZSBkb2N1bWVudCAjNjk2MwoJCQkJcmV0dXJuIG0gJiYgbS5wYXJlbnROb2RlID8gW21dIDogW107CgkJCX0KCQl9OwoJCUV4cHIuZmlsdGVyWyJJRCJdID0gZnVuY3Rpb24oIGlkICkgewoJCQl2YXIgYXR0cklkID0gaWQucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKTsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCJpZCIpID09PSBhdHRySWQ7CgkJCX07CgkJfTsKCX0gZWxzZSB7CgkJLy8gU3VwcG9ydDogSUU2LzcKCQkvLyBnZXRFbGVtZW50QnlJZCBpcyBub3QgcmVsaWFibGUgYXMgYSBmaW5kIHNob3J0Y3V0CgkJZGVsZXRlIEV4cHIuZmluZFsiSUQiXTsKCgkJRXhwci5maWx0ZXJbIklEIl0gPSAgZnVuY3Rpb24oIGlkICkgewoJCQl2YXIgYXR0cklkID0gaWQucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKTsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJdmFyIG5vZGUgPSB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlICE9PSBzdHJ1bmRlZmluZWQgJiYgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCJpZCIpOwoJCQkJcmV0dXJuIG5vZGUgJiYgbm9kZS52YWx1ZSA9PT0gYXR0cklkOwoJCQl9OwoJCX07Cgl9CgoJLy8gVGFnCglFeHByLmZpbmRbIlRBRyJdID0gc3VwcG9ydC5nZXRFbGVtZW50c0J5VGFnTmFtZSA/CgkJZnVuY3Rpb24oIHRhZywgY29udGV4dCApIHsKCQkJaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gc3RydW5kZWZpbmVkICkgewoJCQkJcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyApOwoJCQl9CgkJfSA6CgkJZnVuY3Rpb24oIHRhZywgY29udGV4dCApIHsKCQkJdmFyIGVsZW0sCgkJCQl0bXAgPSBbXSwKCQkJCWkgPSAwLAoJCQkJcmVzdWx0cyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyApOwoKCQkJLy8gRmlsdGVyIG91dCBwb3NzaWJsZSBjb21tZW50cwoJCQlpZiAoIHRhZyA9PT0gIioiICkgewoJCQkJd2hpbGUgKCAoZWxlbSA9IHJlc3VsdHNbaSsrXSkgKSB7CgkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJCQl0bXAucHVzaCggZWxlbSApOwoJCQkJCX0KCQkJCX0KCgkJCQlyZXR1cm4gdG1wOwoJCQl9CgkJCXJldHVybiByZXN1bHRzOwoJCX07CgoJLy8gQ2xhc3MKCUV4cHIuZmluZFsiQ0xBU1MiXSA9IHN1cHBvcnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiBmdW5jdGlvbiggY2xhc3NOYW1lLCBjb250ZXh0ICkgewoJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAhPT0gc3RydW5kZWZpbmVkICYmIGRvY3VtZW50SXNIVE1MICkgewoJCQlyZXR1cm4gY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCBjbGFzc05hbWUgKTsKCQl9Cgl9OwoKCS8qIFFTQS9tYXRjaGVzU2VsZWN0b3IKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KCgkvLyBRU0EgYW5kIG1hdGNoZXNTZWxlY3RvciBzdXBwb3J0CgoJLy8gbWF0Y2hlc1NlbGVjdG9yKDphY3RpdmUpIHJlcG9ydHMgZmFsc2Ugd2hlbiB0cnVlIChJRTkvT3BlcmEgMTEuNSkKCXJidWdneU1hdGNoZXMgPSBbXTsKCgkvLyBxU2EoOmZvY3VzKSByZXBvcnRzIGZhbHNlIHdoZW4gdHJ1ZSAoQ2hyb21lIDIxKQoJLy8gV2UgYWxsb3cgdGhpcyBiZWNhdXNlIG9mIGEgYnVnIGluIElFOC85IHRoYXQgdGhyb3dzIGFuIGVycm9yCgkvLyB3aGVuZXZlciBgZG9jdW1lbnQuYWN0aXZlRWxlbWVudGAgaXMgYWNjZXNzZWQgb24gYW4gaWZyYW1lCgkvLyBTbywgd2UgYWxsb3cgOmZvY3VzIHRvIHBhc3MgdGhyb3VnaCBRU0EgYWxsIHRoZSB0aW1lIHRvIGF2b2lkIHRoZSBJRSBlcnJvcgoJLy8gU2VlIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzEzMzc4CglyYnVnZ3lRU0EgPSBbXTsKCglpZiAoIChzdXBwb3J0LnFzYSA9IHJuYXRpdmUudGVzdCggZG9jLnF1ZXJ5U2VsZWN0b3JBbGwgKSkgKSB7CgkJLy8gQnVpbGQgUVNBIHJlZ2V4CgkJLy8gUmVnZXggc3RyYXRlZ3kgYWRvcHRlZCBmcm9tIERpZWdvIFBlcmluaQoJCWFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJCQkvLyBTZWxlY3QgaXMgc2V0IHRvIGVtcHR5IHN0cmluZyBvbiBwdXJwb3NlCgkJCS8vIFRoaXMgaXMgdG8gdGVzdCBJRSdzIHRyZWF0bWVudCBvZiBub3QgZXhwbGljaXRseQoJCQkvLyBzZXR0aW5nIGEgYm9vbGVhbiBjb250ZW50IGF0dHJpYnV0ZSwKCQkJLy8gc2luY2UgaXRzIHByZXNlbmNlIHNob3VsZCBiZSBlbm91Z2gKCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTIzNTkKCQkJZGl2LmlubmVySFRNTCA9ICI8c2VsZWN0IHQ9Jyc+PG9wdGlvbiBzZWxlY3RlZD0nJz48L29wdGlvbj48L3NlbGVjdD4iOwoKCQkJLy8gU3VwcG9ydDogSUU4LCBPcGVyYSAxMC0xMgoJCQkvLyBOb3RoaW5nIHNob3VsZCBiZSBzZWxlY3RlZCB3aGVuIGVtcHR5IHN0cmluZ3MgZm9sbG93IF49IG9yICQ9IG9yICo9CgkJCWlmICggZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoIlt0Xj0nJ10iKS5sZW5ndGggKSB7CgkJCQlyYnVnZ3lRU0EucHVzaCggIlsqXiRdPSIgKyB3aGl0ZXNwYWNlICsgIiooPzonJ3xcIlwiKSIgKTsKCQkJfQoKCQkJLy8gU3VwcG9ydDogSUU4CgkJCS8vIEJvb2xlYW4gYXR0cmlidXRlcyBhbmQgInZhbHVlIiBhcmUgbm90IHRyZWF0ZWQgY29ycmVjdGx5CgkJCWlmICggIWRpdi5xdWVyeVNlbGVjdG9yQWxsKCJbc2VsZWN0ZWRdIikubGVuZ3RoICkgewoJCQkJcmJ1Z2d5UVNBLnB1c2goICJcXFsiICsgd2hpdGVzcGFjZSArICIqKD86dmFsdWV8IiArIGJvb2xlYW5zICsgIikiICk7CgkJCX0KCgkJCS8vIFdlYmtpdC9PcGVyYSAtIDpjaGVja2VkIHNob3VsZCByZXR1cm4gc2VsZWN0ZWQgb3B0aW9uIGVsZW1lbnRzCgkJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSLzIwMTEvUkVDLWNzczMtc2VsZWN0b3JzLTIwMTEwOTI5LyNjaGVja2VkCgkJCS8vIElFOCB0aHJvd3MgZXJyb3IgaGVyZSBhbmQgd2lsbCBub3Qgc2VlIGxhdGVyIHRlc3RzCgkJCWlmICggIWRpdi5xdWVyeVNlbGVjdG9yQWxsKCI6Y2hlY2tlZCIpLmxlbmd0aCApIHsKCQkJCXJidWdneVFTQS5wdXNoKCI6Y2hlY2tlZCIpOwoJCQl9CgkJfSk7CgoJCWFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJCQkvLyBTdXBwb3J0OiBXaW5kb3dzIDggTmF0aXZlIEFwcHMKCQkJLy8gVGhlIHR5cGUgYW5kIG5hbWUgYXR0cmlidXRlcyBhcmUgcmVzdHJpY3RlZCBkdXJpbmcgLmlubmVySFRNTCBhc3NpZ25tZW50CgkJCXZhciBpbnB1dCA9IGRvYy5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwoJCQlpbnB1dC5zZXRBdHRyaWJ1dGUoICJ0eXBlIiwgImhpZGRlbiIgKTsKCQkJZGl2LmFwcGVuZENoaWxkKCBpbnB1dCApLnNldEF0dHJpYnV0ZSggIm5hbWUiLCAiRCIgKTsKCgkJCS8vIFN1cHBvcnQ6IElFOAoJCQkvLyBFbmZvcmNlIGNhc2Utc2Vuc2l0aXZpdHkgb2YgbmFtZSBhdHRyaWJ1dGUKCQkJaWYgKCBkaXYucXVlcnlTZWxlY3RvckFsbCgiW25hbWU9ZF0iKS5sZW5ndGggKSB7CgkJCQlyYnVnZ3lRU0EucHVzaCggIm5hbWUiICsgd2hpdGVzcGFjZSArICIqWypeJHwhfl0/PSIgKTsKCQkJfQoKCQkJLy8gRkYgMy41IC0gOmVuYWJsZWQvOmRpc2FibGVkIGFuZCBoaWRkZW4gZWxlbWVudHMgKGhpZGRlbiBlbGVtZW50cyBhcmUgc3RpbGwgZW5hYmxlZCkKCQkJLy8gSUU4IHRocm93cyBlcnJvciBoZXJlIGFuZCB3aWxsIG5vdCBzZWUgbGF0ZXIgdGVzdHMKCQkJaWYgKCAhZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoIjplbmFibGVkIikubGVuZ3RoICkgewoJCQkJcmJ1Z2d5UVNBLnB1c2goICI6ZW5hYmxlZCIsICI6ZGlzYWJsZWQiICk7CgkJCX0KCgkJCS8vIE9wZXJhIDEwLTExIGRvZXMgbm90IHRocm93IG9uIHBvc3QtY29tbWEgaW52YWxpZCBwc2V1ZG9zCgkJCWRpdi5xdWVyeVNlbGVjdG9yQWxsKCIqLDp4Iik7CgkJCXJidWdneVFTQS5wdXNoKCIsLio6Iik7CgkJfSk7Cgl9CgoJaWYgKCAoc3VwcG9ydC5tYXRjaGVzU2VsZWN0b3IgPSBybmF0aXZlLnRlc3QoIChtYXRjaGVzID0gZG9jRWxlbS53ZWJraXRNYXRjaGVzU2VsZWN0b3IgfHwKCQlkb2NFbGVtLm1vek1hdGNoZXNTZWxlY3RvciB8fAoJCWRvY0VsZW0ub01hdGNoZXNTZWxlY3RvciB8fAoJCWRvY0VsZW0ubXNNYXRjaGVzU2VsZWN0b3IpICkpICkgewoKCQlhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQkJLy8gQ2hlY2sgdG8gc2VlIGlmIGl0J3MgcG9zc2libGUgdG8gZG8gbWF0Y2hlc1NlbGVjdG9yCgkJCS8vIG9uIGEgZGlzY29ubmVjdGVkIG5vZGUgKElFIDkpCgkJCXN1cHBvcnQuZGlzY29ubmVjdGVkTWF0Y2ggPSBtYXRjaGVzLmNhbGwoIGRpdiwgImRpdiIgKTsKCgkJCS8vIFRoaXMgc2hvdWxkIGZhaWwgd2l0aCBhbiBleGNlcHRpb24KCQkJLy8gR2Vja28gZG9lcyBub3QgZXJyb3IsIHJldHVybnMgZmFsc2UgaW5zdGVhZAoJCQltYXRjaGVzLmNhbGwoIGRpdiwgIltzIT0nJ106eCIgKTsKCQkJcmJ1Z2d5TWF0Y2hlcy5wdXNoKCAiIT0iLCBwc2V1ZG9zICk7CgkJfSk7Cgl9CgoJcmJ1Z2d5UVNBID0gcmJ1Z2d5UVNBLmxlbmd0aCAmJiBuZXcgUmVnRXhwKCByYnVnZ3lRU0Euam9pbigifCIpICk7CglyYnVnZ3lNYXRjaGVzID0gcmJ1Z2d5TWF0Y2hlcy5sZW5ndGggJiYgbmV3IFJlZ0V4cCggcmJ1Z2d5TWF0Y2hlcy5qb2luKCJ8IikgKTsKCgkvKiBDb250YWlucwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwoJaGFzQ29tcGFyZSA9IHJuYXRpdmUudGVzdCggZG9jRWxlbS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiApOwoKCS8vIEVsZW1lbnQgY29udGFpbnMgYW5vdGhlcgoJLy8gUHVycG9zZWZ1bGx5IGRvZXMgbm90IGltcGxlbWVudCBpbmNsdXNpdmUgZGVzY2VuZGVudAoJLy8gQXMgaW4sIGFuIGVsZW1lbnQgZG9lcyBub3QgY29udGFpbiBpdHNlbGYKCWNvbnRhaW5zID0gaGFzQ29tcGFyZSB8fCBybmF0aXZlLnRlc3QoIGRvY0VsZW0uY29udGFpbnMgKSA/CgkJZnVuY3Rpb24oIGEsIGIgKSB7CgkJCXZhciBhZG93biA9IGEubm9kZVR5cGUgPT09IDkgPyBhLmRvY3VtZW50RWxlbWVudCA6IGEsCgkJCQlidXAgPSBiICYmIGIucGFyZW50Tm9kZTsKCQkJcmV0dXJuIGEgPT09IGJ1cCB8fCAhISggYnVwICYmIGJ1cC5ub2RlVHlwZSA9PT0gMSAmJiAoCgkJCQlhZG93bi5jb250YWlucyA/CgkJCQkJYWRvd24uY29udGFpbnMoIGJ1cCApIDoKCQkJCQlhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uICYmIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oIGJ1cCApICYgMTYKCQkJKSk7CgkJfSA6CgkJZnVuY3Rpb24oIGEsIGIgKSB7CgkJCWlmICggYiApIHsKCQkJCXdoaWxlICggKGIgPSBiLnBhcmVudE5vZGUpICkgewoJCQkJCWlmICggYiA9PT0gYSApIHsKCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJfQoJCQkJfQoJCQl9CgkJCXJldHVybiBmYWxzZTsKCQl9OwoKCS8qIFNvcnRpbmcKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KCgkvLyBEb2N1bWVudCBvcmRlciBzb3J0aW5nCglzb3J0T3JkZXIgPSBoYXNDb21wYXJlID8KCWZ1bmN0aW9uKCBhLCBiICkgewoKCQkvLyBGbGFnIGZvciBkdXBsaWNhdGUgcmVtb3ZhbAoJCWlmICggYSA9PT0gYiApIHsKCQkJaGFzRHVwbGljYXRlID0gdHJ1ZTsKCQkJcmV0dXJuIDA7CgkJfQoKCQkvLyBTb3J0IG9uIG1ldGhvZCBleGlzdGVuY2UgaWYgb25seSBvbmUgaW5wdXQgaGFzIGNvbXBhcmVEb2N1bWVudFBvc2l0aW9uCgkJdmFyIGNvbXBhcmUgPSAhYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiAtICFiLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uOwoJCWlmICggY29tcGFyZSApIHsKCQkJcmV0dXJuIGNvbXBhcmU7CgkJfQoKCQkvLyBDYWxjdWxhdGUgcG9zaXRpb24gaWYgYm90aCBpbnB1dHMgYmVsb25nIHRvIHRoZSBzYW1lIGRvY3VtZW50CgkJY29tcGFyZSA9ICggYS5vd25lckRvY3VtZW50IHx8IGEgKSA9PT0gKCBiLm93bmVyRG9jdW1lbnQgfHwgYiApID8KCQkJYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiggYiApIDoKCgkJCS8vIE90aGVyd2lzZSB3ZSBrbm93IHRoZXkgYXJlIGRpc2Nvbm5lY3RlZAoJCQkxOwoKCQkvLyBEaXNjb25uZWN0ZWQgbm9kZXMKCQlpZiAoIGNvbXBhcmUgJiAxIHx8CgkJCSghc3VwcG9ydC5zb3J0RGV0YWNoZWQgJiYgYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiggYSApID09PSBjb21wYXJlKSApIHsKCgkJCS8vIENob29zZSB0aGUgZmlyc3QgZWxlbWVudCB0aGF0IGlzIHJlbGF0ZWQgdG8gb3VyIHByZWZlcnJlZCBkb2N1bWVudAoJCQlpZiAoIGEgPT09IGRvYyB8fCBhLm93bmVyRG9jdW1lbnQgPT09IHByZWZlcnJlZERvYyAmJiBjb250YWlucyhwcmVmZXJyZWREb2MsIGEpICkgewoJCQkJcmV0dXJuIC0xOwoJCQl9CgkJCWlmICggYiA9PT0gZG9jIHx8IGIub3duZXJEb2N1bWVudCA9PT0gcHJlZmVycmVkRG9jICYmIGNvbnRhaW5zKHByZWZlcnJlZERvYywgYikgKSB7CgkJCQlyZXR1cm4gMTsKCQkJfQoKCQkJLy8gTWFpbnRhaW4gb3JpZ2luYWwgb3JkZXIKCQkJcmV0dXJuIHNvcnRJbnB1dCA/CgkJCQkoIGluZGV4T2YuY2FsbCggc29ydElucHV0LCBhICkgLSBpbmRleE9mLmNhbGwoIHNvcnRJbnB1dCwgYiApICkgOgoJCQkJMDsKCQl9CgoJCXJldHVybiBjb21wYXJlICYgNCA/IC0xIDogMTsKCX0gOgoJZnVuY3Rpb24oIGEsIGIgKSB7CgkJLy8gRXhpdCBlYXJseSBpZiB0aGUgbm9kZXMgYXJlIGlkZW50aWNhbAoJCWlmICggYSA9PT0gYiApIHsKCQkJaGFzRHVwbGljYXRlID0gdHJ1ZTsKCQkJcmV0dXJuIDA7CgkJfQoKCQl2YXIgY3VyLAoJCQlpID0gMCwKCQkJYXVwID0gYS5wYXJlbnROb2RlLAoJCQlidXAgPSBiLnBhcmVudE5vZGUsCgkJCWFwID0gWyBhIF0sCgkJCWJwID0gWyBiIF07CgoJCS8vIFBhcmVudGxlc3Mgbm9kZXMgYXJlIGVpdGhlciBkb2N1bWVudHMgb3IgZGlzY29ubmVjdGVkCgkJaWYgKCAhYXVwIHx8ICFidXAgKSB7CgkJCXJldHVybiBhID09PSBkb2MgPyAtMSA6CgkJCQliID09PSBkb2MgPyAxIDoKCQkJCWF1cCA/IC0xIDoKCQkJCWJ1cCA/IDEgOgoJCQkJc29ydElucHV0ID8KCQkJCSggaW5kZXhPZi5jYWxsKCBzb3J0SW5wdXQsIGEgKSAtIGluZGV4T2YuY2FsbCggc29ydElucHV0LCBiICkgKSA6CgkJCQkwOwoKCQkvLyBJZiB0aGUgbm9kZXMgYXJlIHNpYmxpbmdzLCB3ZSBjYW4gZG8gYSBxdWljayBjaGVjawoJCX0gZWxzZSBpZiAoIGF1cCA9PT0gYnVwICkgewoJCQlyZXR1cm4gc2libGluZ0NoZWNrKCBhLCBiICk7CgkJfQoKCQkvLyBPdGhlcndpc2Ugd2UgbmVlZCBmdWxsIGxpc3RzIG9mIHRoZWlyIGFuY2VzdG9ycyBmb3IgY29tcGFyaXNvbgoJCWN1ciA9IGE7CgkJd2hpbGUgKCAoY3VyID0gY3VyLnBhcmVudE5vZGUpICkgewoJCQlhcC51bnNoaWZ0KCBjdXIgKTsKCQl9CgkJY3VyID0gYjsKCQl3aGlsZSAoIChjdXIgPSBjdXIucGFyZW50Tm9kZSkgKSB7CgkJCWJwLnVuc2hpZnQoIGN1ciApOwoJCX0KCgkJLy8gV2FsayBkb3duIHRoZSB0cmVlIGxvb2tpbmcgZm9yIGEgZGlzY3JlcGFuY3kKCQl3aGlsZSAoIGFwW2ldID09PSBicFtpXSApIHsKCQkJaSsrOwoJCX0KCgkJcmV0dXJuIGkgPwoJCQkvLyBEbyBhIHNpYmxpbmcgY2hlY2sgaWYgdGhlIG5vZGVzIGhhdmUgYSBjb21tb24gYW5jZXN0b3IKCQkJc2libGluZ0NoZWNrKCBhcFtpXSwgYnBbaV0gKSA6CgoJCQkvLyBPdGhlcndpc2Ugbm9kZXMgaW4gb3VyIGRvY3VtZW50IHNvcnQgZmlyc3QKCQkJYXBbaV0gPT09IHByZWZlcnJlZERvYyA/IC0xIDoKCQkJYnBbaV0gPT09IHByZWZlcnJlZERvYyA/IDEgOgoJCQkwOwoJfTsKCglyZXR1cm4gZG9jOwp9OwoKU2l6emxlLm1hdGNoZXMgPSBmdW5jdGlvbiggZXhwciwgZWxlbWVudHMgKSB7CglyZXR1cm4gU2l6emxlKCBleHByLCBudWxsLCBudWxsLCBlbGVtZW50cyApOwp9OwoKU2l6emxlLm1hdGNoZXNTZWxlY3RvciA9IGZ1bmN0aW9uKCBlbGVtLCBleHByICkgewoJLy8gU2V0IGRvY3VtZW50IHZhcnMgaWYgbmVlZGVkCglpZiAoICggZWxlbS5vd25lckRvY3VtZW50IHx8IGVsZW0gKSAhPT0gZG9jdW1lbnQgKSB7CgkJc2V0RG9jdW1lbnQoIGVsZW0gKTsKCX0KCgkvLyBNYWtlIHN1cmUgdGhhdCBhdHRyaWJ1dGUgc2VsZWN0b3JzIGFyZSBxdW90ZWQKCWV4cHIgPSBleHByLnJlcGxhY2UoIHJhdHRyaWJ1dGVRdW90ZXMsICI9JyQxJ10iICk7CgoJaWYgKCBzdXBwb3J0Lm1hdGNoZXNTZWxlY3RvciAmJiBkb2N1bWVudElzSFRNTCAmJgoJCSggIXJidWdneU1hdGNoZXMgfHwgIXJidWdneU1hdGNoZXMudGVzdCggZXhwciApICkgJiYKCQkoICFyYnVnZ3lRU0EgICAgIHx8ICFyYnVnZ3lRU0EudGVzdCggZXhwciApICkgKSB7CgoJCXRyeSB7CgkJCXZhciByZXQgPSBtYXRjaGVzLmNhbGwoIGVsZW0sIGV4cHIgKTsKCgkJCS8vIElFIDkncyBtYXRjaGVzU2VsZWN0b3IgcmV0dXJucyBmYWxzZSBvbiBkaXNjb25uZWN0ZWQgbm9kZXMKCQkJaWYgKCByZXQgfHwgc3VwcG9ydC5kaXNjb25uZWN0ZWRNYXRjaCB8fAoJCQkJCS8vIEFzIHdlbGwsIGRpc2Nvbm5lY3RlZCBub2RlcyBhcmUgc2FpZCB0byBiZSBpbiBhIGRvY3VtZW50CgkJCQkJLy8gZnJhZ21lbnQgaW4gSUUgOQoJCQkJCWVsZW0uZG9jdW1lbnQgJiYgZWxlbS5kb2N1bWVudC5ub2RlVHlwZSAhPT0gMTEgKSB7CgkJCQlyZXR1cm4gcmV0OwoJCQl9CgkJfSBjYXRjaChlKSB7fQoJfQoKCXJldHVybiBTaXp6bGUoIGV4cHIsIGRvY3VtZW50LCBudWxsLCBbZWxlbV0gKS5sZW5ndGggPiAwOwp9OwoKU2l6emxlLmNvbnRhaW5zID0gZnVuY3Rpb24oIGNvbnRleHQsIGVsZW0gKSB7CgkvLyBTZXQgZG9jdW1lbnQgdmFycyBpZiBuZWVkZWQKCWlmICggKCBjb250ZXh0Lm93bmVyRG9jdW1lbnQgfHwgY29udGV4dCApICE9PSBkb2N1bWVudCApIHsKCQlzZXREb2N1bWVudCggY29udGV4dCApOwoJfQoJcmV0dXJuIGNvbnRhaW5zKCBjb250ZXh0LCBlbGVtICk7Cn07CgpTaXp6bGUuYXR0ciA9IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJLy8gU2V0IGRvY3VtZW50IHZhcnMgaWYgbmVlZGVkCglpZiAoICggZWxlbS5vd25lckRvY3VtZW50IHx8IGVsZW0gKSAhPT0gZG9jdW1lbnQgKSB7CgkJc2V0RG9jdW1lbnQoIGVsZW0gKTsKCX0KCgl2YXIgZm4gPSBFeHByLmF0dHJIYW5kbGVbIG5hbWUudG9Mb3dlckNhc2UoKSBdLAoJCS8vIERvbid0IGdldCBmb29sZWQgYnkgT2JqZWN0LnByb3RvdHlwZSBwcm9wZXJ0aWVzIChqUXVlcnkgIzEzODA3KQoJCXZhbCA9IGZuICYmIGhhc093bi5jYWxsKCBFeHByLmF0dHJIYW5kbGUsIG5hbWUudG9Mb3dlckNhc2UoKSApID8KCQkJZm4oIGVsZW0sIG5hbWUsICFkb2N1bWVudElzSFRNTCApIDoKCQkJdW5kZWZpbmVkOwoKCXJldHVybiB2YWwgIT09IHVuZGVmaW5lZCA/CgkJdmFsIDoKCQlzdXBwb3J0LmF0dHJpYnV0ZXMgfHwgIWRvY3VtZW50SXNIVE1MID8KCQkJZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUgKSA6CgkJCSh2YWwgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUobmFtZSkpICYmIHZhbC5zcGVjaWZpZWQgPwoJCQkJdmFsLnZhbHVlIDoKCQkJCW51bGw7Cn07CgpTaXp6bGUuZXJyb3IgPSBmdW5jdGlvbiggbXNnICkgewoJdGhyb3cgbmV3IEVycm9yKCAiU3ludGF4IGVycm9yLCB1bnJlY29nbml6ZWQgZXhwcmVzc2lvbjogIiArIG1zZyApOwp9OwoKLyoqCiAqIERvY3VtZW50IHNvcnRpbmcgYW5kIHJlbW92aW5nIGR1cGxpY2F0ZXMKICogQHBhcmFtIHtBcnJheUxpa2V9IHJlc3VsdHMKICovClNpenpsZS51bmlxdWVTb3J0ID0gZnVuY3Rpb24oIHJlc3VsdHMgKSB7Cgl2YXIgZWxlbSwKCQlkdXBsaWNhdGVzID0gW10sCgkJaiA9IDAsCgkJaSA9IDA7CgoJLy8gVW5sZXNzIHdlICprbm93KiB3ZSBjYW4gZGV0ZWN0IGR1cGxpY2F0ZXMsIGFzc3VtZSB0aGVpciBwcmVzZW5jZQoJaGFzRHVwbGljYXRlID0gIXN1cHBvcnQuZGV0ZWN0RHVwbGljYXRlczsKCXNvcnRJbnB1dCA9ICFzdXBwb3J0LnNvcnRTdGFibGUgJiYgcmVzdWx0cy5zbGljZSggMCApOwoJcmVzdWx0cy5zb3J0KCBzb3J0T3JkZXIgKTsKCglpZiAoIGhhc0R1cGxpY2F0ZSApIHsKCQl3aGlsZSAoIChlbGVtID0gcmVzdWx0c1tpKytdKSApIHsKCQkJaWYgKCBlbGVtID09PSByZXN1bHRzWyBpIF0gKSB7CgkJCQlqID0gZHVwbGljYXRlcy5wdXNoKCBpICk7CgkJCX0KCQl9CgkJd2hpbGUgKCBqLS0gKSB7CgkJCXJlc3VsdHMuc3BsaWNlKCBkdXBsaWNhdGVzWyBqIF0sIDEgKTsKCQl9Cgl9CgoJLy8gQ2xlYXIgaW5wdXQgYWZ0ZXIgc29ydGluZyB0byByZWxlYXNlIG9iamVjdHMKCS8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L3NpenpsZS9wdWxsLzIyNQoJc29ydElucHV0ID0gbnVsbDsKCglyZXR1cm4gcmVzdWx0czsKfTsKCi8qKgogKiBVdGlsaXR5IGZ1bmN0aW9uIGZvciByZXRyaWV2aW5nIHRoZSB0ZXh0IHZhbHVlIG9mIGFuIGFycmF5IG9mIERPTSBub2RlcwogKiBAcGFyYW0ge0FycmF5fEVsZW1lbnR9IGVsZW0KICovCmdldFRleHQgPSBTaXp6bGUuZ2V0VGV4dCA9IGZ1bmN0aW9uKCBlbGVtICkgewoJdmFyIG5vZGUsCgkJcmV0ID0gIiIsCgkJaSA9IDAsCgkJbm9kZVR5cGUgPSBlbGVtLm5vZGVUeXBlOwoKCWlmICggIW5vZGVUeXBlICkgewoJCS8vIElmIG5vIG5vZGVUeXBlLCB0aGlzIGlzIGV4cGVjdGVkIHRvIGJlIGFuIGFycmF5CgkJd2hpbGUgKCAobm9kZSA9IGVsZW1baSsrXSkgKSB7CgkJCS8vIERvIG5vdCB0cmF2ZXJzZSBjb21tZW50IG5vZGVzCgkJCXJldCArPSBnZXRUZXh0KCBub2RlICk7CgkJfQoJfSBlbHNlIGlmICggbm9kZVR5cGUgPT09IDEgfHwgbm9kZVR5cGUgPT09IDkgfHwgbm9kZVR5cGUgPT09IDExICkgewoJCS8vIFVzZSB0ZXh0Q29udGVudCBmb3IgZWxlbWVudHMKCQkvLyBpbm5lclRleHQgdXNhZ2UgcmVtb3ZlZCBmb3IgY29uc2lzdGVuY3kgb2YgbmV3IGxpbmVzIChqUXVlcnkgIzExMTUzKQoJCWlmICggdHlwZW9mIGVsZW0udGV4dENvbnRlbnQgPT09ICJzdHJpbmciICkgewoJCQlyZXR1cm4gZWxlbS50ZXh0Q29udGVudDsKCQl9IGVsc2UgewoJCQkvLyBUcmF2ZXJzZSBpdHMgY2hpbGRyZW4KCQkJZm9yICggZWxlbSA9IGVsZW0uZmlyc3RDaGlsZDsgZWxlbTsgZWxlbSA9IGVsZW0ubmV4dFNpYmxpbmcgKSB7CgkJCQlyZXQgKz0gZ2V0VGV4dCggZWxlbSApOwoJCQl9CgkJfQoJfSBlbHNlIGlmICggbm9kZVR5cGUgPT09IDMgfHwgbm9kZVR5cGUgPT09IDQgKSB7CgkJcmV0dXJuIGVsZW0ubm9kZVZhbHVlOwoJfQoJLy8gRG8gbm90IGluY2x1ZGUgY29tbWVudCBvciBwcm9jZXNzaW5nIGluc3RydWN0aW9uIG5vZGVzCgoJcmV0dXJuIHJldDsKfTsKCkV4cHIgPSBTaXp6bGUuc2VsZWN0b3JzID0gewoKCS8vIENhbiBiZSBhZGp1c3RlZCBieSB0aGUgdXNlcgoJY2FjaGVMZW5ndGg6IDUwLAoKCWNyZWF0ZVBzZXVkbzogbWFya0Z1bmN0aW9uLAoKCW1hdGNoOiBtYXRjaEV4cHIsCgoJYXR0ckhhbmRsZToge30sCgoJZmluZDoge30sCgoJcmVsYXRpdmU6IHsKCQkiPiI6IHsgZGlyOiAicGFyZW50Tm9kZSIsIGZpcnN0OiB0cnVlIH0sCgkJIiAiOiB7IGRpcjogInBhcmVudE5vZGUiIH0sCgkJIisiOiB7IGRpcjogInByZXZpb3VzU2libGluZyIsIGZpcnN0OiB0cnVlIH0sCgkJIn4iOiB7IGRpcjogInByZXZpb3VzU2libGluZyIgfQoJfSwKCglwcmVGaWx0ZXI6IHsKCQkiQVRUUiI6IGZ1bmN0aW9uKCBtYXRjaCApIHsKCQkJbWF0Y2hbMV0gPSBtYXRjaFsxXS5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApOwoKCQkJLy8gTW92ZSB0aGUgZ2l2ZW4gdmFsdWUgdG8gbWF0Y2hbM10gd2hldGhlciBxdW90ZWQgb3IgdW5xdW90ZWQKCQkJbWF0Y2hbM10gPSAoIG1hdGNoWzRdIHx8IG1hdGNoWzVdIHx8ICIiICkucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKTsKCgkJCWlmICggbWF0Y2hbMl0gPT09ICJ+PSIgKSB7CgkJCQltYXRjaFszXSA9ICIgIiArIG1hdGNoWzNdICsgIiAiOwoJCQl9CgoJCQlyZXR1cm4gbWF0Y2guc2xpY2UoIDAsIDQgKTsKCQl9LAoKCQkiQ0hJTEQiOiBmdW5jdGlvbiggbWF0Y2ggKSB7CgkJCS8qIG1hdGNoZXMgZnJvbSBtYXRjaEV4cHJbIkNISUxEIl0KCQkJCTEgdHlwZSAob25seXxudGh8Li4uKQoJCQkJMiB3aGF0IChjaGlsZHxvZi10eXBlKQoJCQkJMyBhcmd1bWVudCAoZXZlbnxvZGR8XGQqfFxkKm4oWystXVxkKyk/fC4uLikKCQkJCTQgeG4tY29tcG9uZW50IG9mIHhuK3kgYXJndW1lbnQgKFsrLV0/XGQqbnwpCgkJCQk1IHNpZ24gb2YgeG4tY29tcG9uZW50CgkJCQk2IHggb2YgeG4tY29tcG9uZW50CgkJCQk3IHNpZ24gb2YgeS1jb21wb25lbnQKCQkJCTggeSBvZiB5LWNvbXBvbmVudAoJCQkqLwoJCQltYXRjaFsxXSA9IG1hdGNoWzFdLnRvTG93ZXJDYXNlKCk7CgoJCQlpZiAoIG1hdGNoWzFdLnNsaWNlKCAwLCAzICkgPT09ICJudGgiICkgewoJCQkJLy8gbnRoLSogcmVxdWlyZXMgYXJndW1lbnQKCQkJCWlmICggIW1hdGNoWzNdICkgewoJCQkJCVNpenpsZS5lcnJvciggbWF0Y2hbMF0gKTsKCQkJCX0KCgkJCQkvLyBudW1lcmljIHggYW5kIHkgcGFyYW1ldGVycyBmb3IgRXhwci5maWx0ZXIuQ0hJTEQKCQkJCS8vIHJlbWVtYmVyIHRoYXQgZmFsc2UvdHJ1ZSBjYXN0IHJlc3BlY3RpdmVseSB0byAwLzEKCQkJCW1hdGNoWzRdID0gKyggbWF0Y2hbNF0gPyBtYXRjaFs1XSArIChtYXRjaFs2XSB8fCAxKSA6IDIgKiAoIG1hdGNoWzNdID09PSAiZXZlbiIgfHwgbWF0Y2hbM10gPT09ICJvZGQiICkgKTsKCQkJCW1hdGNoWzVdID0gKyggKCBtYXRjaFs3XSArIG1hdGNoWzhdICkgfHwgbWF0Y2hbM10gPT09ICJvZGQiICk7CgoJCQkvLyBvdGhlciB0eXBlcyBwcm9oaWJpdCBhcmd1bWVudHMKCQkJfSBlbHNlIGlmICggbWF0Y2hbM10gKSB7CgkJCQlTaXp6bGUuZXJyb3IoIG1hdGNoWzBdICk7CgkJCX0KCgkJCXJldHVybiBtYXRjaDsKCQl9LAoKCQkiUFNFVURPIjogZnVuY3Rpb24oIG1hdGNoICkgewoJCQl2YXIgZXhjZXNzLAoJCQkJdW5xdW90ZWQgPSAhbWF0Y2hbNV0gJiYgbWF0Y2hbMl07CgoJCQlpZiAoIG1hdGNoRXhwclsiQ0hJTEQiXS50ZXN0KCBtYXRjaFswXSApICkgewoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCgkJCS8vIEFjY2VwdCBxdW90ZWQgYXJndW1lbnRzIGFzLWlzCgkJCWlmICggbWF0Y2hbM10gJiYgbWF0Y2hbNF0gIT09IHVuZGVmaW5lZCApIHsKCQkJCW1hdGNoWzJdID0gbWF0Y2hbNF07CgoJCQkvLyBTdHJpcCBleGNlc3MgY2hhcmFjdGVycyBmcm9tIHVucXVvdGVkIGFyZ3VtZW50cwoJCQl9IGVsc2UgaWYgKCB1bnF1b3RlZCAmJiBycHNldWRvLnRlc3QoIHVucXVvdGVkICkgJiYKCQkJCS8vIEdldCBleGNlc3MgZnJvbSB0b2tlbml6ZSAocmVjdXJzaXZlbHkpCgkJCQkoZXhjZXNzID0gdG9rZW5pemUoIHVucXVvdGVkLCB0cnVlICkpICYmCgkJCQkvLyBhZHZhbmNlIHRvIHRoZSBuZXh0IGNsb3NpbmcgcGFyZW50aGVzaXMKCQkJCShleGNlc3MgPSB1bnF1b3RlZC5pbmRleE9mKCAiKSIsIHVucXVvdGVkLmxlbmd0aCAtIGV4Y2VzcyApIC0gdW5xdW90ZWQubGVuZ3RoKSApIHsKCgkJCQkvLyBleGNlc3MgaXMgYSBuZWdhdGl2ZSBpbmRleAoJCQkJbWF0Y2hbMF0gPSBtYXRjaFswXS5zbGljZSggMCwgZXhjZXNzICk7CgkJCQltYXRjaFsyXSA9IHVucXVvdGVkLnNsaWNlKCAwLCBleGNlc3MgKTsKCQkJfQoKCQkJLy8gUmV0dXJuIG9ubHkgY2FwdHVyZXMgbmVlZGVkIGJ5IHRoZSBwc2V1ZG8gZmlsdGVyIG1ldGhvZCAodHlwZSBhbmQgYXJndW1lbnQpCgkJCXJldHVybiBtYXRjaC5zbGljZSggMCwgMyApOwoJCX0KCX0sCgoJZmlsdGVyOiB7CgoJCSJUQUciOiBmdW5jdGlvbiggbm9kZU5hbWVTZWxlY3RvciApIHsKCQkJdmFyIG5vZGVOYW1lID0gbm9kZU5hbWVTZWxlY3Rvci5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApLnRvTG93ZXJDYXNlKCk7CgkJCXJldHVybiBub2RlTmFtZVNlbGVjdG9yID09PSAiKiIgPwoJCQkJZnVuY3Rpb24oKSB7IHJldHVybiB0cnVlOyB9IDoKCQkJCWZ1bmN0aW9uKCBlbGVtICkgewoJCQkJCXJldHVybiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbm9kZU5hbWU7CgkJCQl9OwoJCX0sCgoJCSJDTEFTUyI6IGZ1bmN0aW9uKCBjbGFzc05hbWUgKSB7CgkJCXZhciBwYXR0ZXJuID0gY2xhc3NDYWNoZVsgY2xhc3NOYW1lICsgIiAiIF07CgoJCQlyZXR1cm4gcGF0dGVybiB8fAoJCQkJKHBhdHRlcm4gPSBuZXcgUmVnRXhwKCAiKF58IiArIHdoaXRlc3BhY2UgKyAiKSIgKyBjbGFzc05hbWUgKyAiKCIgKyB3aGl0ZXNwYWNlICsgInwkKSIgKSkgJiYKCQkJCWNsYXNzQ2FjaGUoIGNsYXNzTmFtZSwgZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQkJcmV0dXJuIHBhdHRlcm4udGVzdCggdHlwZW9mIGVsZW0uY2xhc3NOYW1lID09PSAic3RyaW5nIiAmJiBlbGVtLmNsYXNzTmFtZSB8fCB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGUgIT09IHN0cnVuZGVmaW5lZCAmJiBlbGVtLmdldEF0dHJpYnV0ZSgiY2xhc3MiKSB8fCAiIiApOwoJCQkJfSk7CgkJfSwKCgkJIkFUVFIiOiBmdW5jdGlvbiggbmFtZSwgb3BlcmF0b3IsIGNoZWNrICkgewoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQl2YXIgcmVzdWx0ID0gU2l6emxlLmF0dHIoIGVsZW0sIG5hbWUgKTsKCgkJCQlpZiAoIHJlc3VsdCA9PSBudWxsICkgewoJCQkJCXJldHVybiBvcGVyYXRvciA9PT0gIiE9IjsKCQkJCX0KCQkJCWlmICggIW9wZXJhdG9yICkgewoJCQkJCXJldHVybiB0cnVlOwoJCQkJfQoKCQkJCXJlc3VsdCArPSAiIjsKCgkJCQlyZXR1cm4gb3BlcmF0b3IgPT09ICI9IiA/IHJlc3VsdCA9PT0gY2hlY2sgOgoJCQkJCW9wZXJhdG9yID09PSAiIT0iID8gcmVzdWx0ICE9PSBjaGVjayA6CgkJCQkJb3BlcmF0b3IgPT09ICJePSIgPyBjaGVjayAmJiByZXN1bHQuaW5kZXhPZiggY2hlY2sgKSA9PT0gMCA6CgkJCQkJb3BlcmF0b3IgPT09ICIqPSIgPyBjaGVjayAmJiByZXN1bHQuaW5kZXhPZiggY2hlY2sgKSA+IC0xIDoKCQkJCQlvcGVyYXRvciA9PT0gIiQ9IiA/IGNoZWNrICYmIHJlc3VsdC5zbGljZSggLWNoZWNrLmxlbmd0aCApID09PSBjaGVjayA6CgkJCQkJb3BlcmF0b3IgPT09ICJ+PSIgPyAoICIgIiArIHJlc3VsdCArICIgIiApLmluZGV4T2YoIGNoZWNrICkgPiAtMSA6CgkJCQkJb3BlcmF0b3IgPT09ICJ8PSIgPyByZXN1bHQgPT09IGNoZWNrIHx8IHJlc3VsdC5zbGljZSggMCwgY2hlY2subGVuZ3RoICsgMSApID09PSBjaGVjayArICItIiA6CgkJCQkJZmFsc2U7CgkJCX07CgkJfSwKCgkJIkNISUxEIjogZnVuY3Rpb24oIHR5cGUsIHdoYXQsIGFyZ3VtZW50LCBmaXJzdCwgbGFzdCApIHsKCQkJdmFyIHNpbXBsZSA9IHR5cGUuc2xpY2UoIDAsIDMgKSAhPT0gIm50aCIsCgkJCQlmb3J3YXJkID0gdHlwZS5zbGljZSggLTQgKSAhPT0gImxhc3QiLAoJCQkJb2ZUeXBlID0gd2hhdCA9PT0gIm9mLXR5cGUiOwoKCQkJcmV0dXJuIGZpcnN0ID09PSAxICYmIGxhc3QgPT09IDAgPwoKCQkJCS8vIFNob3J0Y3V0IGZvciA6bnRoLSoobikKCQkJCWZ1bmN0aW9uKCBlbGVtICkgewoJCQkJCXJldHVybiAhIWVsZW0ucGFyZW50Tm9kZTsKCQkJCX0gOgoKCQkJCWZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB7CgkJCQkJdmFyIGNhY2hlLCBvdXRlckNhY2hlLCBub2RlLCBkaWZmLCBub2RlSW5kZXgsIHN0YXJ0LAoJCQkJCQlkaXIgPSBzaW1wbGUgIT09IGZvcndhcmQgPyAibmV4dFNpYmxpbmciIDogInByZXZpb3VzU2libGluZyIsCgkJCQkJCXBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZSwKCQkJCQkJbmFtZSA9IG9mVHlwZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCQkJCXVzZUNhY2hlID0gIXhtbCAmJiAhb2ZUeXBlOwoKCQkJCQlpZiAoIHBhcmVudCApIHsKCgkJCQkJCS8vIDooZmlyc3R8bGFzdHxvbmx5KS0oY2hpbGR8b2YtdHlwZSkKCQkJCQkJaWYgKCBzaW1wbGUgKSB7CgkJCQkJCQl3aGlsZSAoIGRpciApIHsKCQkJCQkJCQlub2RlID0gZWxlbTsKCQkJCQkJCQl3aGlsZSAoIChub2RlID0gbm9kZVsgZGlyIF0pICkgewoJCQkJCQkJCQlpZiAoIG9mVHlwZSA/IG5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbmFtZSA6IG5vZGUubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQkJCX0KCQkJCQkJCQl9CgkJCQkJCQkJLy8gUmV2ZXJzZSBkaXJlY3Rpb24gZm9yIDpvbmx5LSogKGlmIHdlIGhhdmVuJ3QgeWV0IGRvbmUgc28pCgkJCQkJCQkJc3RhcnQgPSBkaXIgPSB0eXBlID09PSAib25seSIgJiYgIXN0YXJ0ICYmICJuZXh0U2libGluZyI7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQkJfQoKCQkJCQkJc3RhcnQgPSBbIGZvcndhcmQgPyBwYXJlbnQuZmlyc3RDaGlsZCA6IHBhcmVudC5sYXN0Q2hpbGQgXTsKCgkJCQkJCS8vIG5vbi14bWwgOm50aC1jaGlsZCguLi4pIHN0b3JlcyBjYWNoZSBkYXRhIG9uIGBwYXJlbnRgCgkJCQkJCWlmICggZm9yd2FyZCAmJiB1c2VDYWNoZSApIHsKCQkJCQkJCS8vIFNlZWsgYGVsZW1gIGZyb20gYSBwcmV2aW91c2x5LWNhY2hlZCBpbmRleAoJCQkJCQkJb3V0ZXJDYWNoZSA9IHBhcmVudFsgZXhwYW5kbyBdIHx8IChwYXJlbnRbIGV4cGFuZG8gXSA9IHt9KTsKCQkJCQkJCWNhY2hlID0gb3V0ZXJDYWNoZVsgdHlwZSBdIHx8IFtdOwoJCQkJCQkJbm9kZUluZGV4ID0gY2FjaGVbMF0gPT09IGRpcnJ1bnMgJiYgY2FjaGVbMV07CgkJCQkJCQlkaWZmID0gY2FjaGVbMF0gPT09IGRpcnJ1bnMgJiYgY2FjaGVbMl07CgkJCQkJCQlub2RlID0gbm9kZUluZGV4ICYmIHBhcmVudC5jaGlsZE5vZGVzWyBub2RlSW5kZXggXTsKCgkJCQkJCQl3aGlsZSAoIChub2RlID0gKytub2RlSW5kZXggJiYgbm9kZSAmJiBub2RlWyBkaXIgXSB8fAoKCQkJCQkJCQkvLyBGYWxsYmFjayB0byBzZWVraW5nIGBlbGVtYCBmcm9tIHRoZSBzdGFydAoJCQkJCQkJCShkaWZmID0gbm9kZUluZGV4ID0gMCkgfHwgc3RhcnQucG9wKCkpICkgewoKCQkJCQkJCQkvLyBXaGVuIGZvdW5kLCBjYWNoZSBpbmRleGVzIG9uIGBwYXJlbnRgIGFuZCBicmVhawoJCQkJCQkJCWlmICggbm9kZS5ub2RlVHlwZSA9PT0gMSAmJiArK2RpZmYgJiYgbm9kZSA9PT0gZWxlbSApIHsKCQkJCQkJCQkJb3V0ZXJDYWNoZVsgdHlwZSBdID0gWyBkaXJydW5zLCBub2RlSW5kZXgsIGRpZmYgXTsKCQkJCQkJCQkJYnJlYWs7CgkJCQkJCQkJfQoJCQkJCQkJfQoKCQkJCQkJLy8gVXNlIHByZXZpb3VzbHktY2FjaGVkIGVsZW1lbnQgaW5kZXggaWYgYXZhaWxhYmxlCgkJCQkJCX0gZWxzZSBpZiAoIHVzZUNhY2hlICYmIChjYWNoZSA9IChlbGVtWyBleHBhbmRvIF0gfHwgKGVsZW1bIGV4cGFuZG8gXSA9IHt9KSlbIHR5cGUgXSkgJiYgY2FjaGVbMF0gPT09IGRpcnJ1bnMgKSB7CgkJCQkJCQlkaWZmID0gY2FjaGVbMV07CgoJCQkJCQkvLyB4bWwgOm50aC1jaGlsZCguLi4pIG9yIDpudGgtbGFzdC1jaGlsZCguLi4pIG9yIDpudGgoLWxhc3QpPy1vZi10eXBlKC4uLikKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCS8vIFVzZSB0aGUgc2FtZSBsb29wIGFzIGFib3ZlIHRvIHNlZWsgYGVsZW1gIGZyb20gdGhlIHN0YXJ0CgkJCQkJCQl3aGlsZSAoIChub2RlID0gKytub2RlSW5kZXggJiYgbm9kZSAmJiBub2RlWyBkaXIgXSB8fAoJCQkJCQkJCShkaWZmID0gbm9kZUluZGV4ID0gMCkgfHwgc3RhcnQucG9wKCkpICkgewoKCQkJCQkJCQlpZiAoICggb2ZUeXBlID8gbm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBuYW1lIDogbm9kZS5ub2RlVHlwZSA9PT0gMSApICYmICsrZGlmZiApIHsKCQkJCQkJCQkJLy8gQ2FjaGUgdGhlIGluZGV4IG9mIGVhY2ggZW5jb3VudGVyZWQgZWxlbWVudAoJCQkJCQkJCQlpZiAoIHVzZUNhY2hlICkgewoJCQkJCQkJCQkJKG5vZGVbIGV4cGFuZG8gXSB8fCAobm9kZVsgZXhwYW5kbyBdID0ge30pKVsgdHlwZSBdID0gWyBkaXJydW5zLCBkaWZmIF07CgkJCQkJCQkJCX0KCgkJCQkJCQkJCWlmICggbm9kZSA9PT0gZWxlbSApIHsKCQkJCQkJCQkJCWJyZWFrOwoJCQkJCQkJCQl9CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9CgoJCQkJCQkvLyBJbmNvcnBvcmF0ZSB0aGUgb2Zmc2V0LCB0aGVuIGNoZWNrIGFnYWluc3QgY3ljbGUgc2l6ZQoJCQkJCQlkaWZmIC09IGxhc3Q7CgkJCQkJCXJldHVybiBkaWZmID09PSBmaXJzdCB8fCAoIGRpZmYgJSBmaXJzdCA9PT0gMCAmJiBkaWZmIC8gZmlyc3QgPj0gMCApOwoJCQkJCX0KCQkJCX07CgkJfSwKCgkJIlBTRVVETyI6IGZ1bmN0aW9uKCBwc2V1ZG8sIGFyZ3VtZW50ICkgewoJCQkvLyBwc2V1ZG8tY2xhc3MgbmFtZXMgYXJlIGNhc2UtaW5zZW5zaXRpdmUKCQkJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNwc2V1ZG8tY2xhc3NlcwoJCQkvLyBQcmlvcml0aXplIGJ5IGNhc2Ugc2Vuc2l0aXZpdHkgaW4gY2FzZSBjdXN0b20gcHNldWRvcyBhcmUgYWRkZWQgd2l0aCB1cHBlcmNhc2UgbGV0dGVycwoJCQkvLyBSZW1lbWJlciB0aGF0IHNldEZpbHRlcnMgaW5oZXJpdHMgZnJvbSBwc2V1ZG9zCgkJCXZhciBhcmdzLAoJCQkJZm4gPSBFeHByLnBzZXVkb3NbIHBzZXVkbyBdIHx8IEV4cHIuc2V0RmlsdGVyc1sgcHNldWRvLnRvTG93ZXJDYXNlKCkgXSB8fAoJCQkJCVNpenpsZS5lcnJvciggInVuc3VwcG9ydGVkIHBzZXVkbzogIiArIHBzZXVkbyApOwoKCQkJLy8gVGhlIHVzZXIgbWF5IHVzZSBjcmVhdGVQc2V1ZG8gdG8gaW5kaWNhdGUgdGhhdAoJCQkvLyBhcmd1bWVudHMgYXJlIG5lZWRlZCB0byBjcmVhdGUgdGhlIGZpbHRlciBmdW5jdGlvbgoJCQkvLyBqdXN0IGFzIFNpenpsZSBkb2VzCgkJCWlmICggZm5bIGV4cGFuZG8gXSApIHsKCQkJCXJldHVybiBmbiggYXJndW1lbnQgKTsKCQkJfQoKCQkJLy8gQnV0IG1haW50YWluIHN1cHBvcnQgZm9yIG9sZCBzaWduYXR1cmVzCgkJCWlmICggZm4ubGVuZ3RoID4gMSApIHsKCQkJCWFyZ3MgPSBbIHBzZXVkbywgcHNldWRvLCAiIiwgYXJndW1lbnQgXTsKCQkJCXJldHVybiBFeHByLnNldEZpbHRlcnMuaGFzT3duUHJvcGVydHkoIHBzZXVkby50b0xvd2VyQ2FzZSgpICkgPwoJCQkJCW1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VlZCwgbWF0Y2hlcyApIHsKCQkJCQkJdmFyIGlkeCwKCQkJCQkJCW1hdGNoZWQgPSBmbiggc2VlZCwgYXJndW1lbnQgKSwKCQkJCQkJCWkgPSBtYXRjaGVkLmxlbmd0aDsKCQkJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJCQlpZHggPSBpbmRleE9mLmNhbGwoIHNlZWQsIG1hdGNoZWRbaV0gKTsKCQkJCQkJCXNlZWRbIGlkeCBdID0gISggbWF0Y2hlc1sgaWR4IF0gPSBtYXRjaGVkW2ldICk7CgkJCQkJCX0KCQkJCQl9KSA6CgkJCQkJZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQkJCXJldHVybiBmbiggZWxlbSwgMCwgYXJncyApOwoJCQkJCX07CgkJCX0KCgkJCXJldHVybiBmbjsKCQl9Cgl9LAoKCXBzZXVkb3M6IHsKCQkvLyBQb3RlbnRpYWxseSBjb21wbGV4IHBzZXVkb3MKCQkibm90IjogbWFya0Z1bmN0aW9uKGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQkJLy8gVHJpbSB0aGUgc2VsZWN0b3IgcGFzc2VkIHRvIGNvbXBpbGUKCQkJLy8gdG8gYXZvaWQgdHJlYXRpbmcgbGVhZGluZyBhbmQgdHJhaWxpbmcKCQkJLy8gc3BhY2VzIGFzIGNvbWJpbmF0b3JzCgkJCXZhciBpbnB1dCA9IFtdLAoJCQkJcmVzdWx0cyA9IFtdLAoJCQkJbWF0Y2hlciA9IGNvbXBpbGUoIHNlbGVjdG9yLnJlcGxhY2UoIHJ0cmltLCAiJDEiICkgKTsKCgkJCXJldHVybiBtYXRjaGVyWyBleHBhbmRvIF0gPwoJCQkJbWFya0Z1bmN0aW9uKGZ1bmN0aW9uKCBzZWVkLCBtYXRjaGVzLCBjb250ZXh0LCB4bWwgKSB7CgkJCQkJdmFyIGVsZW0sCgkJCQkJCXVubWF0Y2hlZCA9IG1hdGNoZXIoIHNlZWQsIG51bGwsIHhtbCwgW10gKSwKCQkJCQkJaSA9IHNlZWQubGVuZ3RoOwoKCQkJCQkvLyBNYXRjaCBlbGVtZW50cyB1bm1hdGNoZWQgYnkgYG1hdGNoZXJgCgkJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJCWlmICggKGVsZW0gPSB1bm1hdGNoZWRbaV0pICkgewoJCQkJCQkJc2VlZFtpXSA9ICEobWF0Y2hlc1tpXSA9IGVsZW0pOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSkgOgoJCQkJZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQsIHhtbCApIHsKCQkJCQlpbnB1dFswXSA9IGVsZW07CgkJCQkJbWF0Y2hlciggaW5wdXQsIG51bGwsIHhtbCwgcmVzdWx0cyApOwoJCQkJCXJldHVybiAhcmVzdWx0cy5wb3AoKTsKCQkJCX07CgkJfSksCgoJCSJoYXMiOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQlyZXR1cm4gU2l6emxlKCBzZWxlY3RvciwgZWxlbSApLmxlbmd0aCA+IDA7CgkJCX07CgkJfSksCgoJCSJjb250YWlucyI6IG1hcmtGdW5jdGlvbihmdW5jdGlvbiggdGV4dCApIHsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJcmV0dXJuICggZWxlbS50ZXh0Q29udGVudCB8fCBlbGVtLmlubmVyVGV4dCB8fCBnZXRUZXh0KCBlbGVtICkgKS5pbmRleE9mKCB0ZXh0ICkgPiAtMTsKCQkJfTsKCQl9KSwKCgkJLy8gIldoZXRoZXIgYW4gZWxlbWVudCBpcyByZXByZXNlbnRlZCBieSBhIDpsYW5nKCkgc2VsZWN0b3IKCQkvLyBpcyBiYXNlZCBzb2xlbHkgb24gdGhlIGVsZW1lbnQncyBsYW5ndWFnZSB2YWx1ZQoJCS8vIGJlaW5nIGVxdWFsIHRvIHRoZSBpZGVudGlmaWVyIEMsCgkJLy8gb3IgYmVnaW5uaW5nIHdpdGggdGhlIGlkZW50aWZpZXIgQyBpbW1lZGlhdGVseSBmb2xsb3dlZCBieSAiLSIuCgkJLy8gVGhlIG1hdGNoaW5nIG9mIEMgYWdhaW5zdCB0aGUgZWxlbWVudCdzIGxhbmd1YWdlIHZhbHVlIGlzIHBlcmZvcm1lZCBjYXNlLWluc2Vuc2l0aXZlbHkuCgkJLy8gVGhlIGlkZW50aWZpZXIgQyBkb2VzIG5vdCBoYXZlIHRvIGJlIGEgdmFsaWQgbGFuZ3VhZ2UgbmFtZS4iCgkJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNsYW5nLXBzZXVkbwoJCSJsYW5nIjogbWFya0Z1bmN0aW9uKCBmdW5jdGlvbiggbGFuZyApIHsKCQkJLy8gbGFuZyB2YWx1ZSBtdXN0IGJlIGEgdmFsaWQgaWRlbnRpZmllcgoJCQlpZiAoICFyaWRlbnRpZmllci50ZXN0KGxhbmcgfHwgIiIpICkgewoJCQkJU2l6emxlLmVycm9yKCAidW5zdXBwb3J0ZWQgbGFuZzogIiArIGxhbmcgKTsKCQkJfQoJCQlsYW5nID0gbGFuZy5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApLnRvTG93ZXJDYXNlKCk7CgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXZhciBlbGVtTGFuZzsKCQkJCWRvIHsKCQkJCQlpZiAoIChlbGVtTGFuZyA9IGRvY3VtZW50SXNIVE1MID8KCQkJCQkJZWxlbS5sYW5nIDoKCQkJCQkJZWxlbS5nZXRBdHRyaWJ1dGUoInhtbDpsYW5nIikgfHwgZWxlbS5nZXRBdHRyaWJ1dGUoImxhbmciKSkgKSB7CgoJCQkJCQllbGVtTGFuZyA9IGVsZW1MYW5nLnRvTG93ZXJDYXNlKCk7CgkJCQkJCXJldHVybiBlbGVtTGFuZyA9PT0gbGFuZyB8fCBlbGVtTGFuZy5pbmRleE9mKCBsYW5nICsgIi0iICkgPT09IDA7CgkJCQkJfQoJCQkJfSB3aGlsZSAoIChlbGVtID0gZWxlbS5wYXJlbnROb2RlKSAmJiBlbGVtLm5vZGVUeXBlID09PSAxICk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX07CgkJfSksCgoJCS8vIE1pc2NlbGxhbmVvdXMKCQkidGFyZ2V0IjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXZhciBoYXNoID0gd2luZG93LmxvY2F0aW9uICYmIHdpbmRvdy5sb2NhdGlvbi5oYXNoOwoJCQlyZXR1cm4gaGFzaCAmJiBoYXNoLnNsaWNlKCAxICkgPT09IGVsZW0uaWQ7CgkJfSwKCgkJInJvb3QiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0gPT09IGRvY0VsZW07CgkJfSwKCgkJImZvY3VzIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtID09PSBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmICghZG9jdW1lbnQuaGFzRm9jdXMgfHwgZG9jdW1lbnQuaGFzRm9jdXMoKSkgJiYgISEoZWxlbS50eXBlIHx8IGVsZW0uaHJlZiB8fCB+ZWxlbS50YWJJbmRleCk7CgkJfSwKCgkJLy8gQm9vbGVhbiBwcm9wZXJ0aWVzCgkJImVuYWJsZWQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0uZGlzYWJsZWQgPT09IGZhbHNlOwoJCX0sCgoJCSJkaXNhYmxlZCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbS5kaXNhYmxlZCA9PT0gdHJ1ZTsKCQl9LAoKCQkiY2hlY2tlZCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkvLyBJbiBDU1MzLCA6Y2hlY2tlZCBzaG91bGQgcmV0dXJuIGJvdGggY2hlY2tlZCBhbmQgc2VsZWN0ZWQgZWxlbWVudHMKCQkJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvMjAxMS9SRUMtY3NzMy1zZWxlY3RvcnMtMjAxMTA5MjkvI2NoZWNrZWQKCQkJdmFyIG5vZGVOYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoJCQlyZXR1cm4gKG5vZGVOYW1lID09PSAiaW5wdXQiICYmICEhZWxlbS5jaGVja2VkKSB8fCAobm9kZU5hbWUgPT09ICJvcHRpb24iICYmICEhZWxlbS5zZWxlY3RlZCk7CgkJfSwKCgkJInNlbGVjdGVkIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCS8vIEFjY2Vzc2luZyB0aGlzIHByb3BlcnR5IG1ha2VzIHNlbGVjdGVkLWJ5LWRlZmF1bHQKCQkJLy8gb3B0aW9ucyBpbiBTYWZhcmkgd29yayBwcm9wZXJseQoJCQlpZiAoIGVsZW0ucGFyZW50Tm9kZSApIHsKCQkJCWVsZW0ucGFyZW50Tm9kZS5zZWxlY3RlZEluZGV4OwoJCQl9CgoJCQlyZXR1cm4gZWxlbS5zZWxlY3RlZCA9PT0gdHJ1ZTsKCQl9LAoKCQkvLyBDb250ZW50cwoJCSJlbXB0eSI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI2VtcHR5LXBzZXVkbwoJCQkvLyA6ZW1wdHkgaXMgbmVnYXRlZCBieSBlbGVtZW50ICgxKSBvciBjb250ZW50IG5vZGVzICh0ZXh0OiAzOyBjZGF0YTogNDsgZW50aXR5IHJlZjogNSksCgkJCS8vICAgYnV0IG5vdCBieSBvdGhlcnMgKGNvbW1lbnQ6IDg7IHByb2Nlc3NpbmcgaW5zdHJ1Y3Rpb246IDc7IGV0Yy4pCgkJCS8vIG5vZGVUeXBlIDwgNiB3b3JrcyBiZWNhdXNlIGF0dHJpYnV0ZXMgKDIpIGRvIG5vdCBhcHBlYXIgYXMgY2hpbGRyZW4KCQkJZm9yICggZWxlbSA9IGVsZW0uZmlyc3RDaGlsZDsgZWxlbTsgZWxlbSA9IGVsZW0ubmV4dFNpYmxpbmcgKSB7CgkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPCA2ICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gdHJ1ZTsKCQl9LAoKCQkicGFyZW50IjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiAhRXhwci5wc2V1ZG9zWyJlbXB0eSJdKCBlbGVtICk7CgkJfSwKCgkJLy8gRWxlbWVudC9pbnB1dCB0eXBlcwoJCSJoZWFkZXIiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIHJoZWFkZXIudGVzdCggZWxlbS5ub2RlTmFtZSApOwoJCX0sCgoJCSJpbnB1dCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gcmlucHV0cy50ZXN0KCBlbGVtLm5vZGVOYW1lICk7CgkJfSwKCgkJImJ1dHRvbiI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQl2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCQkJcmV0dXJuIG5hbWUgPT09ICJpbnB1dCIgJiYgZWxlbS50eXBlID09PSAiYnV0dG9uIiB8fCBuYW1lID09PSAiYnV0dG9uIjsKCQl9LAoKCQkidGV4dCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQl2YXIgYXR0cjsKCQkJcmV0dXJuIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJgoJCQkJZWxlbS50eXBlID09PSAidGV4dCIgJiYKCgkJCQkvLyBTdXBwb3J0OiBJRTw4CgkJCQkvLyBOZXcgSFRNTDUgYXR0cmlidXRlIHZhbHVlcyAoZS5nLiwgInNlYXJjaCIpIGFwcGVhciB3aXRoIGVsZW0udHlwZSA9PT0gInRleHQiCgkJCQkoIChhdHRyID0gZWxlbS5nZXRBdHRyaWJ1dGUoInR5cGUiKSkgPT0gbnVsbCB8fCBhdHRyLnRvTG93ZXJDYXNlKCkgPT09ICJ0ZXh0IiApOwoJCX0sCgoJCS8vIFBvc2l0aW9uLWluLWNvbGxlY3Rpb24KCQkiZmlyc3QiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gWyAwIF07CgkJfSksCgoJCSJsYXN0IjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiggbWF0Y2hJbmRleGVzLCBsZW5ndGggKSB7CgkJCXJldHVybiBbIGxlbmd0aCAtIDEgXTsKCQl9KSwKCgkJImVxIjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiggbWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50ICkgewoJCQlyZXR1cm4gWyBhcmd1bWVudCA8IDAgPyBhcmd1bWVudCArIGxlbmd0aCA6IGFyZ3VtZW50IF07CgkJfSksCgoJCSJldmVuIjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiggbWF0Y2hJbmRleGVzLCBsZW5ndGggKSB7CgkJCXZhciBpID0gMDsKCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpICs9IDIgKSB7CgkJCQltYXRjaEluZGV4ZXMucHVzaCggaSApOwoJCQl9CgkJCXJldHVybiBtYXRjaEluZGV4ZXM7CgkJfSksCgoJCSJvZGQiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCApIHsKCQkJdmFyIGkgPSAxOwoJCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkgKz0gMiApIHsKCQkJCW1hdGNoSW5kZXhlcy5wdXNoKCBpICk7CgkJCX0KCQkJcmV0dXJuIG1hdGNoSW5kZXhlczsKCQl9KSwKCgkJImx0IjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiggbWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50ICkgewoJCQl2YXIgaSA9IGFyZ3VtZW50IDwgMCA/IGFyZ3VtZW50ICsgbGVuZ3RoIDogYXJndW1lbnQ7CgkJCWZvciAoIDsgLS1pID49IDA7ICkgewoJCQkJbWF0Y2hJbmRleGVzLnB1c2goIGkgKTsKCQkJfQoJCQlyZXR1cm4gbWF0Y2hJbmRleGVzOwoJCX0pLAoKCQkiZ3QiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCwgYXJndW1lbnQgKSB7CgkJCXZhciBpID0gYXJndW1lbnQgPCAwID8gYXJndW1lbnQgKyBsZW5ndGggOiBhcmd1bWVudDsKCQkJZm9yICggOyArK2kgPCBsZW5ndGg7ICkgewoJCQkJbWF0Y2hJbmRleGVzLnB1c2goIGkgKTsKCQkJfQoJCQlyZXR1cm4gbWF0Y2hJbmRleGVzOwoJCX0pCgl9Cn07CgpFeHByLnBzZXVkb3NbIm50aCJdID0gRXhwci5wc2V1ZG9zWyJlcSJdOwoKLy8gQWRkIGJ1dHRvbi9pbnB1dCB0eXBlIHBzZXVkb3MKZm9yICggaSBpbiB7IHJhZGlvOiB0cnVlLCBjaGVja2JveDogdHJ1ZSwgZmlsZTogdHJ1ZSwgcGFzc3dvcmQ6IHRydWUsIGltYWdlOiB0cnVlIH0gKSB7CglFeHByLnBzZXVkb3NbIGkgXSA9IGNyZWF0ZUlucHV0UHNldWRvKCBpICk7Cn0KZm9yICggaSBpbiB7IHN1Ym1pdDogdHJ1ZSwgcmVzZXQ6IHRydWUgfSApIHsKCUV4cHIucHNldWRvc1sgaSBdID0gY3JlYXRlQnV0dG9uUHNldWRvKCBpICk7Cn0KCi8vIEVhc3kgQVBJIGZvciBjcmVhdGluZyBuZXcgc2V0RmlsdGVycwpmdW5jdGlvbiBzZXRGaWx0ZXJzKCkge30Kc2V0RmlsdGVycy5wcm90b3R5cGUgPSBFeHByLmZpbHRlcnMgPSBFeHByLnBzZXVkb3M7CkV4cHIuc2V0RmlsdGVycyA9IG5ldyBzZXRGaWx0ZXJzKCk7CgpmdW5jdGlvbiB0b2tlbml6ZSggc2VsZWN0b3IsIHBhcnNlT25seSApIHsKCXZhciBtYXRjaGVkLCBtYXRjaCwgdG9rZW5zLCB0eXBlLAoJCXNvRmFyLCBncm91cHMsIHByZUZpbHRlcnMsCgkJY2FjaGVkID0gdG9rZW5DYWNoZVsgc2VsZWN0b3IgKyAiICIgXTsKCglpZiAoIGNhY2hlZCApIHsKCQlyZXR1cm4gcGFyc2VPbmx5ID8gMCA6IGNhY2hlZC5zbGljZSggMCApOwoJfQoKCXNvRmFyID0gc2VsZWN0b3I7Cglncm91cHMgPSBbXTsKCXByZUZpbHRlcnMgPSBFeHByLnByZUZpbHRlcjsKCgl3aGlsZSAoIHNvRmFyICkgewoKCQkvLyBDb21tYSBhbmQgZmlyc3QgcnVuCgkJaWYgKCAhbWF0Y2hlZCB8fCAobWF0Y2ggPSByY29tbWEuZXhlYyggc29GYXIgKSkgKSB7CgkJCWlmICggbWF0Y2ggKSB7CgkJCQkvLyBEb24ndCBjb25zdW1lIHRyYWlsaW5nIGNvbW1hcyBhcyB2YWxpZAoJCQkJc29GYXIgPSBzb0Zhci5zbGljZSggbWF0Y2hbMF0ubGVuZ3RoICkgfHwgc29GYXI7CgkJCX0KCQkJZ3JvdXBzLnB1c2goICh0b2tlbnMgPSBbXSkgKTsKCQl9CgoJCW1hdGNoZWQgPSBmYWxzZTsKCgkJLy8gQ29tYmluYXRvcnMKCQlpZiAoIChtYXRjaCA9IHJjb21iaW5hdG9ycy5leGVjKCBzb0ZhciApKSApIHsKCQkJbWF0Y2hlZCA9IG1hdGNoLnNoaWZ0KCk7CgkJCXRva2Vucy5wdXNoKHsKCQkJCXZhbHVlOiBtYXRjaGVkLAoJCQkJLy8gQ2FzdCBkZXNjZW5kYW50IGNvbWJpbmF0b3JzIHRvIHNwYWNlCgkJCQl0eXBlOiBtYXRjaFswXS5yZXBsYWNlKCBydHJpbSwgIiAiICkKCQkJfSk7CgkJCXNvRmFyID0gc29GYXIuc2xpY2UoIG1hdGNoZWQubGVuZ3RoICk7CgkJfQoKCQkvLyBGaWx0ZXJzCgkJZm9yICggdHlwZSBpbiBFeHByLmZpbHRlciApIHsKCQkJaWYgKCAobWF0Y2ggPSBtYXRjaEV4cHJbIHR5cGUgXS5leGVjKCBzb0ZhciApKSAmJiAoIXByZUZpbHRlcnNbIHR5cGUgXSB8fAoJCQkJKG1hdGNoID0gcHJlRmlsdGVyc1sgdHlwZSBdKCBtYXRjaCApKSkgKSB7CgkJCQltYXRjaGVkID0gbWF0Y2guc2hpZnQoKTsKCQkJCXRva2Vucy5wdXNoKHsKCQkJCQl2YWx1ZTogbWF0Y2hlZCwKCQkJCQl0eXBlOiB0eXBlLAoJCQkJCW1hdGNoZXM6IG1hdGNoCgkJCQl9KTsKCQkJCXNvRmFyID0gc29GYXIuc2xpY2UoIG1hdGNoZWQubGVuZ3RoICk7CgkJCX0KCQl9CgoJCWlmICggIW1hdGNoZWQgKSB7CgkJCWJyZWFrOwoJCX0KCX0KCgkvLyBSZXR1cm4gdGhlIGxlbmd0aCBvZiB0aGUgaW52YWxpZCBleGNlc3MKCS8vIGlmIHdlJ3JlIGp1c3QgcGFyc2luZwoJLy8gT3RoZXJ3aXNlLCB0aHJvdyBhbiBlcnJvciBvciByZXR1cm4gdG9rZW5zCglyZXR1cm4gcGFyc2VPbmx5ID8KCQlzb0Zhci5sZW5ndGggOgoJCXNvRmFyID8KCQkJU2l6emxlLmVycm9yKCBzZWxlY3RvciApIDoKCQkJLy8gQ2FjaGUgdGhlIHRva2VucwoJCQl0b2tlbkNhY2hlKCBzZWxlY3RvciwgZ3JvdXBzICkuc2xpY2UoIDAgKTsKfQoKZnVuY3Rpb24gdG9TZWxlY3RvciggdG9rZW5zICkgewoJdmFyIGkgPSAwLAoJCWxlbiA9IHRva2Vucy5sZW5ndGgsCgkJc2VsZWN0b3IgPSAiIjsKCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgewoJCXNlbGVjdG9yICs9IHRva2Vuc1tpXS52YWx1ZTsKCX0KCXJldHVybiBzZWxlY3RvcjsKfQoKZnVuY3Rpb24gYWRkQ29tYmluYXRvciggbWF0Y2hlciwgY29tYmluYXRvciwgYmFzZSApIHsKCXZhciBkaXIgPSBjb21iaW5hdG9yLmRpciwKCQljaGVja05vbkVsZW1lbnRzID0gYmFzZSAmJiBkaXIgPT09ICJwYXJlbnROb2RlIiwKCQlkb25lTmFtZSA9IGRvbmUrKzsKCglyZXR1cm4gY29tYmluYXRvci5maXJzdCA/CgkJLy8gQ2hlY2sgYWdhaW5zdCBjbG9zZXN0IGFuY2VzdG9yL3ByZWNlZGluZyBlbGVtZW50CgkJZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQsIHhtbCApIHsKCQkJd2hpbGUgKCAoZWxlbSA9IGVsZW1bIGRpciBdKSApIHsKCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBjaGVja05vbkVsZW1lbnRzICkgewoJCQkJCXJldHVybiBtYXRjaGVyKCBlbGVtLCBjb250ZXh0LCB4bWwgKTsKCQkJCX0KCQkJfQoJCX0gOgoKCQkvLyBDaGVjayBhZ2FpbnN0IGFsbCBhbmNlc3Rvci9wcmVjZWRpbmcgZWxlbWVudHMKCQlmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgewoJCQl2YXIgb2xkQ2FjaGUsIG91dGVyQ2FjaGUsCgkJCQluZXdDYWNoZSA9IFsgZGlycnVucywgZG9uZU5hbWUgXTsKCgkJCS8vIFdlIGNhbid0IHNldCBhcmJpdHJhcnkgZGF0YSBvbiBYTUwgbm9kZXMsIHNvIHRoZXkgZG9uJ3QgYmVuZWZpdCBmcm9tIGRpciBjYWNoaW5nCgkJCWlmICggeG1sICkgewoJCQkJd2hpbGUgKCAoZWxlbSA9IGVsZW1bIGRpciBdKSApIHsKCQkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgfHwgY2hlY2tOb25FbGVtZW50cyApIHsKCQkJCQkJaWYgKCBtYXRjaGVyKCBlbGVtLCBjb250ZXh0LCB4bWwgKSApIHsKCQkJCQkJCXJldHVybiB0cnVlOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9IGVsc2UgewoJCQkJd2hpbGUgKCAoZWxlbSA9IGVsZW1bIGRpciBdKSApIHsKCQkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgfHwgY2hlY2tOb25FbGVtZW50cyApIHsKCQkJCQkJb3V0ZXJDYWNoZSA9IGVsZW1bIGV4cGFuZG8gXSB8fCAoZWxlbVsgZXhwYW5kbyBdID0ge30pOwoJCQkJCQlpZiAoIChvbGRDYWNoZSA9IG91dGVyQ2FjaGVbIGRpciBdKSAmJgoJCQkJCQkJb2xkQ2FjaGVbIDAgXSA9PT0gZGlycnVucyAmJiBvbGRDYWNoZVsgMSBdID09PSBkb25lTmFtZSApIHsKCgkJCQkJCQkvLyBBc3NpZ24gdG8gbmV3Q2FjaGUgc28gcmVzdWx0cyBiYWNrLXByb3BhZ2F0ZSB0byBwcmV2aW91cyBlbGVtZW50cwoJCQkJCQkJcmV0dXJuIChuZXdDYWNoZVsgMiBdID0gb2xkQ2FjaGVbIDIgXSk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQkvLyBSZXVzZSBuZXdjYWNoZSBzbyByZXN1bHRzIGJhY2stcHJvcGFnYXRlIHRvIHByZXZpb3VzIGVsZW1lbnRzCgkJCQkJCQlvdXRlckNhY2hlWyBkaXIgXSA9IG5ld0NhY2hlOwoKCQkJCQkJCS8vIEEgbWF0Y2ggbWVhbnMgd2UncmUgZG9uZTsgYSBmYWlsIG1lYW5zIHdlIGhhdmUgdG8ga2VlcCBjaGVja2luZwoJCQkJCQkJaWYgKCAobmV3Q2FjaGVbIDIgXSA9IG1hdGNoZXIoIGVsZW0sIGNvbnRleHQsIHhtbCApKSApIHsKCQkJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCX07Cn0KCmZ1bmN0aW9uIGVsZW1lbnRNYXRjaGVyKCBtYXRjaGVycyApIHsKCXJldHVybiBtYXRjaGVycy5sZW5ndGggPiAxID8KCQlmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgewoJCQl2YXIgaSA9IG1hdGNoZXJzLmxlbmd0aDsKCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQlpZiAoICFtYXRjaGVyc1tpXSggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9CgkJCXJldHVybiB0cnVlOwoJCX0gOgoJCW1hdGNoZXJzWzBdOwp9CgpmdW5jdGlvbiBjb25kZW5zZSggdW5tYXRjaGVkLCBtYXAsIGZpbHRlciwgY29udGV4dCwgeG1sICkgewoJdmFyIGVsZW0sCgkJbmV3VW5tYXRjaGVkID0gW10sCgkJaSA9IDAsCgkJbGVuID0gdW5tYXRjaGVkLmxlbmd0aCwKCQltYXBwZWQgPSBtYXAgIT0gbnVsbDsKCglmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQlpZiAoIChlbGVtID0gdW5tYXRjaGVkW2ldKSApIHsKCQkJaWYgKCAhZmlsdGVyIHx8IGZpbHRlciggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7CgkJCQluZXdVbm1hdGNoZWQucHVzaCggZWxlbSApOwoJCQkJaWYgKCBtYXBwZWQgKSB7CgkJCQkJbWFwLnB1c2goIGkgKTsKCQkJCX0KCQkJfQoJCX0KCX0KCglyZXR1cm4gbmV3VW5tYXRjaGVkOwp9CgpmdW5jdGlvbiBzZXRNYXRjaGVyKCBwcmVGaWx0ZXIsIHNlbGVjdG9yLCBtYXRjaGVyLCBwb3N0RmlsdGVyLCBwb3N0RmluZGVyLCBwb3N0U2VsZWN0b3IgKSB7CglpZiAoIHBvc3RGaWx0ZXIgJiYgIXBvc3RGaWx0ZXJbIGV4cGFuZG8gXSApIHsKCQlwb3N0RmlsdGVyID0gc2V0TWF0Y2hlciggcG9zdEZpbHRlciApOwoJfQoJaWYgKCBwb3N0RmluZGVyICYmICFwb3N0RmluZGVyWyBleHBhbmRvIF0gKSB7CgkJcG9zdEZpbmRlciA9IHNldE1hdGNoZXIoIHBvc3RGaW5kZXIsIHBvc3RTZWxlY3RvciApOwoJfQoJcmV0dXJuIG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VlZCwgcmVzdWx0cywgY29udGV4dCwgeG1sICkgewoJCXZhciB0ZW1wLCBpLCBlbGVtLAoJCQlwcmVNYXAgPSBbXSwKCQkJcG9zdE1hcCA9IFtdLAoJCQlwcmVleGlzdGluZyA9IHJlc3VsdHMubGVuZ3RoLAoKCQkJLy8gR2V0IGluaXRpYWwgZWxlbWVudHMgZnJvbSBzZWVkIG9yIGNvbnRleHQKCQkJZWxlbXMgPSBzZWVkIHx8IG11bHRpcGxlQ29udGV4dHMoIHNlbGVjdG9yIHx8ICIqIiwgY29udGV4dC5ub2RlVHlwZSA/IFsgY29udGV4dCBdIDogY29udGV4dCwgW10gKSwKCgkJCS8vIFByZWZpbHRlciB0byBnZXQgbWF0Y2hlciBpbnB1dCwgcHJlc2VydmluZyBhIG1hcCBmb3Igc2VlZC1yZXN1bHRzIHN5bmNocm9uaXphdGlvbgoJCQltYXRjaGVySW4gPSBwcmVGaWx0ZXIgJiYgKCBzZWVkIHx8ICFzZWxlY3RvciApID8KCQkJCWNvbmRlbnNlKCBlbGVtcywgcHJlTWFwLCBwcmVGaWx0ZXIsIGNvbnRleHQsIHhtbCApIDoKCQkJCWVsZW1zLAoKCQkJbWF0Y2hlck91dCA9IG1hdGNoZXIgPwoJCQkJLy8gSWYgd2UgaGF2ZSBhIHBvc3RGaW5kZXIsIG9yIGZpbHRlcmVkIHNlZWQsIG9yIG5vbi1zZWVkIHBvc3RGaWx0ZXIgb3IgcHJlZXhpc3RpbmcgcmVzdWx0cywKCQkJCXBvc3RGaW5kZXIgfHwgKCBzZWVkID8gcHJlRmlsdGVyIDogcHJlZXhpc3RpbmcgfHwgcG9zdEZpbHRlciApID8KCgkJCQkJLy8gLi4uaW50ZXJtZWRpYXRlIHByb2Nlc3NpbmcgaXMgbmVjZXNzYXJ5CgkJCQkJW10gOgoKCQkJCQkvLyAuLi5vdGhlcndpc2UgdXNlIHJlc3VsdHMgZGlyZWN0bHkKCQkJCQlyZXN1bHRzIDoKCQkJCW1hdGNoZXJJbjsKCgkJLy8gRmluZCBwcmltYXJ5IG1hdGNoZXMKCQlpZiAoIG1hdGNoZXIgKSB7CgkJCW1hdGNoZXIoIG1hdGNoZXJJbiwgbWF0Y2hlck91dCwgY29udGV4dCwgeG1sICk7CgkJfQoKCQkvLyBBcHBseSBwb3N0RmlsdGVyCgkJaWYgKCBwb3N0RmlsdGVyICkgewoJCQl0ZW1wID0gY29uZGVuc2UoIG1hdGNoZXJPdXQsIHBvc3RNYXAgKTsKCQkJcG9zdEZpbHRlciggdGVtcCwgW10sIGNvbnRleHQsIHhtbCApOwoKCQkJLy8gVW4tbWF0Y2ggZmFpbGluZyBlbGVtZW50cyBieSBtb3ZpbmcgdGhlbSBiYWNrIHRvIG1hdGNoZXJJbgoJCQlpID0gdGVtcC5sZW5ndGg7CgkJCXdoaWxlICggaS0tICkgewoJCQkJaWYgKCAoZWxlbSA9IHRlbXBbaV0pICkgewoJCQkJCW1hdGNoZXJPdXRbIHBvc3RNYXBbaV0gXSA9ICEobWF0Y2hlckluWyBwb3N0TWFwW2ldIF0gPSBlbGVtKTsKCQkJCX0KCQkJfQoJCX0KCgkJaWYgKCBzZWVkICkgewoJCQlpZiAoIHBvc3RGaW5kZXIgfHwgcHJlRmlsdGVyICkgewoJCQkJaWYgKCBwb3N0RmluZGVyICkgewoJCQkJCS8vIEdldCB0aGUgZmluYWwgbWF0Y2hlck91dCBieSBjb25kZW5zaW5nIHRoaXMgaW50ZXJtZWRpYXRlIGludG8gcG9zdEZpbmRlciBjb250ZXh0cwoJCQkJCXRlbXAgPSBbXTsKCQkJCQlpID0gbWF0Y2hlck91dC5sZW5ndGg7CgkJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJCWlmICggKGVsZW0gPSBtYXRjaGVyT3V0W2ldKSApIHsKCQkJCQkJCS8vIFJlc3RvcmUgbWF0Y2hlckluIHNpbmNlIGVsZW0gaXMgbm90IHlldCBhIGZpbmFsIG1hdGNoCgkJCQkJCQl0ZW1wLnB1c2goIChtYXRjaGVySW5baV0gPSBlbGVtKSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXBvc3RGaW5kZXIoIG51bGwsIChtYXRjaGVyT3V0ID0gW10pLCB0ZW1wLCB4bWwgKTsKCQkJCX0KCgkJCQkvLyBNb3ZlIG1hdGNoZWQgZWxlbWVudHMgZnJvbSBzZWVkIHRvIHJlc3VsdHMgdG8ga2VlcCB0aGVtIHN5bmNocm9uaXplZAoJCQkJaSA9IG1hdGNoZXJPdXQubGVuZ3RoOwoJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJaWYgKCAoZWxlbSA9IG1hdGNoZXJPdXRbaV0pICYmCgkJCQkJCSh0ZW1wID0gcG9zdEZpbmRlciA/IGluZGV4T2YuY2FsbCggc2VlZCwgZWxlbSApIDogcHJlTWFwW2ldKSA+IC0xICkgewoKCQkJCQkJc2VlZFt0ZW1wXSA9ICEocmVzdWx0c1t0ZW1wXSA9IGVsZW0pOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkvLyBBZGQgZWxlbWVudHMgdG8gcmVzdWx0cywgdGhyb3VnaCBwb3N0RmluZGVyIGlmIGRlZmluZWQKCQl9IGVsc2UgewoJCQltYXRjaGVyT3V0ID0gY29uZGVuc2UoCgkJCQltYXRjaGVyT3V0ID09PSByZXN1bHRzID8KCQkJCQltYXRjaGVyT3V0LnNwbGljZSggcHJlZXhpc3RpbmcsIG1hdGNoZXJPdXQubGVuZ3RoICkgOgoJCQkJCW1hdGNoZXJPdXQKCQkJKTsKCQkJaWYgKCBwb3N0RmluZGVyICkgewoJCQkJcG9zdEZpbmRlciggbnVsbCwgcmVzdWx0cywgbWF0Y2hlck91dCwgeG1sICk7CgkJCX0gZWxzZSB7CgkJCQlwdXNoLmFwcGx5KCByZXN1bHRzLCBtYXRjaGVyT3V0ICk7CgkJCX0KCQl9Cgl9KTsKfQoKZnVuY3Rpb24gbWF0Y2hlckZyb21Ub2tlbnMoIHRva2VucyApIHsKCXZhciBjaGVja0NvbnRleHQsIG1hdGNoZXIsIGosCgkJbGVuID0gdG9rZW5zLmxlbmd0aCwKCQlsZWFkaW5nUmVsYXRpdmUgPSBFeHByLnJlbGF0aXZlWyB0b2tlbnNbMF0udHlwZSBdLAoJCWltcGxpY2l0UmVsYXRpdmUgPSBsZWFkaW5nUmVsYXRpdmUgfHwgRXhwci5yZWxhdGl2ZVsiICJdLAoJCWkgPSBsZWFkaW5nUmVsYXRpdmUgPyAxIDogMCwKCgkJLy8gVGhlIGZvdW5kYXRpb25hbCBtYXRjaGVyIGVuc3VyZXMgdGhhdCBlbGVtZW50cyBhcmUgcmVhY2hhYmxlIGZyb20gdG9wLWxldmVsIGNvbnRleHQocykKCQltYXRjaENvbnRleHQgPSBhZGRDb21iaW5hdG9yKCBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0gPT09IGNoZWNrQ29udGV4dDsKCQl9LCBpbXBsaWNpdFJlbGF0aXZlLCB0cnVlICksCgkJbWF0Y2hBbnlDb250ZXh0ID0gYWRkQ29tYmluYXRvciggZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBpbmRleE9mLmNhbGwoIGNoZWNrQ29udGV4dCwgZWxlbSApID4gLTE7CgkJfSwgaW1wbGljaXRSZWxhdGl2ZSwgdHJ1ZSApLAoJCW1hdGNoZXJzID0gWyBmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgewoJCQlyZXR1cm4gKCAhbGVhZGluZ1JlbGF0aXZlICYmICggeG1sIHx8IGNvbnRleHQgIT09IG91dGVybW9zdENvbnRleHQgKSApIHx8ICgKCQkJCShjaGVja0NvbnRleHQgPSBjb250ZXh0KS5ub2RlVHlwZSA/CgkJCQkJbWF0Y2hDb250ZXh0KCBlbGVtLCBjb250ZXh0LCB4bWwgKSA6CgkJCQkJbWF0Y2hBbnlDb250ZXh0KCBlbGVtLCBjb250ZXh0LCB4bWwgKSApOwoJCX0gXTsKCglmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQlpZiAoIChtYXRjaGVyID0gRXhwci5yZWxhdGl2ZVsgdG9rZW5zW2ldLnR5cGUgXSkgKSB7CgkJCW1hdGNoZXJzID0gWyBhZGRDb21iaW5hdG9yKGVsZW1lbnRNYXRjaGVyKCBtYXRjaGVycyApLCBtYXRjaGVyKSBdOwoJCX0gZWxzZSB7CgkJCW1hdGNoZXIgPSBFeHByLmZpbHRlclsgdG9rZW5zW2ldLnR5cGUgXS5hcHBseSggbnVsbCwgdG9rZW5zW2ldLm1hdGNoZXMgKTsKCgkJCS8vIFJldHVybiBzcGVjaWFsIHVwb24gc2VlaW5nIGEgcG9zaXRpb25hbCBtYXRjaGVyCgkJCWlmICggbWF0Y2hlclsgZXhwYW5kbyBdICkgewoJCQkJLy8gRmluZCB0aGUgbmV4dCByZWxhdGl2ZSBvcGVyYXRvciAoaWYgYW55KSBmb3IgcHJvcGVyIGhhbmRsaW5nCgkJCQlqID0gKytpOwoJCQkJZm9yICggOyBqIDwgbGVuOyBqKysgKSB7CgkJCQkJaWYgKCBFeHByLnJlbGF0aXZlWyB0b2tlbnNbal0udHlwZSBdICkgewoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gc2V0TWF0Y2hlcigKCQkJCQlpID4gMSAmJiBlbGVtZW50TWF0Y2hlciggbWF0Y2hlcnMgKSwKCQkJCQlpID4gMSAmJiB0b1NlbGVjdG9yKAoJCQkJCQkvLyBJZiB0aGUgcHJlY2VkaW5nIHRva2VuIHdhcyBhIGRlc2NlbmRhbnQgY29tYmluYXRvciwgaW5zZXJ0IGFuIGltcGxpY2l0IGFueS1lbGVtZW50IGAqYAoJCQkJCQl0b2tlbnMuc2xpY2UoIDAsIGkgLSAxICkuY29uY2F0KHsgdmFsdWU6IHRva2Vuc1sgaSAtIDIgXS50eXBlID09PSAiICIgPyAiKiIgOiAiIiB9KQoJCQkJCSkucmVwbGFjZSggcnRyaW0sICIkMSIgKSwKCQkJCQltYXRjaGVyLAoJCQkJCWkgPCBqICYmIG1hdGNoZXJGcm9tVG9rZW5zKCB0b2tlbnMuc2xpY2UoIGksIGogKSApLAoJCQkJCWogPCBsZW4gJiYgbWF0Y2hlckZyb21Ub2tlbnMoICh0b2tlbnMgPSB0b2tlbnMuc2xpY2UoIGogKSkgKSwKCQkJCQlqIDwgbGVuICYmIHRvU2VsZWN0b3IoIHRva2VucyApCgkJCQkpOwoJCQl9CgkJCW1hdGNoZXJzLnB1c2goIG1hdGNoZXIgKTsKCQl9Cgl9CgoJcmV0dXJuIGVsZW1lbnRNYXRjaGVyKCBtYXRjaGVycyApOwp9CgpmdW5jdGlvbiBtYXRjaGVyRnJvbUdyb3VwTWF0Y2hlcnMoIGVsZW1lbnRNYXRjaGVycywgc2V0TWF0Y2hlcnMgKSB7Cgl2YXIgYnlTZXQgPSBzZXRNYXRjaGVycy5sZW5ndGggPiAwLAoJCWJ5RWxlbWVudCA9IGVsZW1lbnRNYXRjaGVycy5sZW5ndGggPiAwLAoJCXN1cGVyTWF0Y2hlciA9IGZ1bmN0aW9uKCBzZWVkLCBjb250ZXh0LCB4bWwsIHJlc3VsdHMsIG91dGVybW9zdCApIHsKCQkJdmFyIGVsZW0sIGosIG1hdGNoZXIsCgkJCQltYXRjaGVkQ291bnQgPSAwLAoJCQkJaSA9ICIwIiwKCQkJCXVubWF0Y2hlZCA9IHNlZWQgJiYgW10sCgkJCQlzZXRNYXRjaGVkID0gW10sCgkJCQljb250ZXh0QmFja3VwID0gb3V0ZXJtb3N0Q29udGV4dCwKCQkJCS8vIFdlIG11c3QgYWx3YXlzIGhhdmUgZWl0aGVyIHNlZWQgZWxlbWVudHMgb3Igb3V0ZXJtb3N0IGNvbnRleHQKCQkJCWVsZW1zID0gc2VlZCB8fCBieUVsZW1lbnQgJiYgRXhwci5maW5kWyJUQUciXSggIioiLCBvdXRlcm1vc3QgKSwKCQkJCS8vIFVzZSBpbnRlZ2VyIGRpcnJ1bnMgaWZmIHRoaXMgaXMgdGhlIG91dGVybW9zdCBtYXRjaGVyCgkJCQlkaXJydW5zVW5pcXVlID0gKGRpcnJ1bnMgKz0gY29udGV4dEJhY2t1cCA9PSBudWxsID8gMSA6IE1hdGgucmFuZG9tKCkgfHwgMC4xKSwKCQkJCWxlbiA9IGVsZW1zLmxlbmd0aDsKCgkJCWlmICggb3V0ZXJtb3N0ICkgewoJCQkJb3V0ZXJtb3N0Q29udGV4dCA9IGNvbnRleHQgIT09IGRvY3VtZW50ICYmIGNvbnRleHQ7CgkJCX0KCgkJCS8vIEFkZCBlbGVtZW50cyBwYXNzaW5nIGVsZW1lbnRNYXRjaGVycyBkaXJlY3RseSB0byByZXN1bHRzCgkJCS8vIEtlZXAgYGlgIGEgc3RyaW5nIGlmIHRoZXJlIGFyZSBubyBlbGVtZW50cyBzbyBgbWF0Y2hlZENvdW50YCB3aWxsIGJlICIwMCIgYmVsb3cKCQkJLy8gU3VwcG9ydDogSUU8OSwgU2FmYXJpCgkJCS8vIFRvbGVyYXRlIE5vZGVMaXN0IHByb3BlcnRpZXMgKElFOiAibGVuZ3RoIjsgU2FmYXJpOiA8bnVtYmVyPikgbWF0Y2hpbmcgZWxlbWVudHMgYnkgaWQKCQkJZm9yICggOyBpICE9PSBsZW4gJiYgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCQkJaWYgKCBieUVsZW1lbnQgJiYgZWxlbSApIHsKCQkJCQlqID0gMDsKCQkJCQl3aGlsZSAoIChtYXRjaGVyID0gZWxlbWVudE1hdGNoZXJzW2orK10pICkgewoJCQkJCQlpZiAoIG1hdGNoZXIoIGVsZW0sIGNvbnRleHQsIHhtbCApICkgewoJCQkJCQkJcmVzdWx0cy5wdXNoKCBlbGVtICk7CgkJCQkJCQlicmVhazsKCQkJCQkJfQoJCQkJCX0KCQkJCQlpZiAoIG91dGVybW9zdCApIHsKCQkJCQkJZGlycnVucyA9IGRpcnJ1bnNVbmlxdWU7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIFRyYWNrIHVubWF0Y2hlZCBlbGVtZW50cyBmb3Igc2V0IGZpbHRlcnMKCQkJCWlmICggYnlTZXQgKSB7CgkJCQkJLy8gVGhleSB3aWxsIGhhdmUgZ29uZSB0aHJvdWdoIGFsbCBwb3NzaWJsZSBtYXRjaGVycwoJCQkJCWlmICggKGVsZW0gPSAhbWF0Y2hlciAmJiBlbGVtKSApIHsKCQkJCQkJbWF0Y2hlZENvdW50LS07CgkJCQkJfQoKCQkJCQkvLyBMZW5ndGhlbiB0aGUgYXJyYXkgZm9yIGV2ZXJ5IGVsZW1lbnQsIG1hdGNoZWQgb3Igbm90CgkJCQkJaWYgKCBzZWVkICkgewoJCQkJCQl1bm1hdGNoZWQucHVzaCggZWxlbSApOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJLy8gQXBwbHkgc2V0IGZpbHRlcnMgdG8gdW5tYXRjaGVkIGVsZW1lbnRzCgkJCW1hdGNoZWRDb3VudCArPSBpOwoJCQlpZiAoIGJ5U2V0ICYmIGkgIT09IG1hdGNoZWRDb3VudCApIHsKCQkJCWogPSAwOwoJCQkJd2hpbGUgKCAobWF0Y2hlciA9IHNldE1hdGNoZXJzW2orK10pICkgewoJCQkJCW1hdGNoZXIoIHVubWF0Y2hlZCwgc2V0TWF0Y2hlZCwgY29udGV4dCwgeG1sICk7CgkJCQl9CgoJCQkJaWYgKCBzZWVkICkgewoJCQkJCS8vIFJlaW50ZWdyYXRlIGVsZW1lbnQgbWF0Y2hlcyB0byBlbGltaW5hdGUgdGhlIG5lZWQgZm9yIHNvcnRpbmcKCQkJCQlpZiAoIG1hdGNoZWRDb3VudCA+IDAgKSB7CgkJCQkJCXdoaWxlICggaS0tICkgewoJCQkJCQkJaWYgKCAhKHVubWF0Y2hlZFtpXSB8fCBzZXRNYXRjaGVkW2ldKSApIHsKCQkJCQkJCQlzZXRNYXRjaGVkW2ldID0gcG9wLmNhbGwoIHJlc3VsdHMgKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCgkJCQkJLy8gRGlzY2FyZCBpbmRleCBwbGFjZWhvbGRlciB2YWx1ZXMgdG8gZ2V0IG9ubHkgYWN0dWFsIG1hdGNoZXMKCQkJCQlzZXRNYXRjaGVkID0gY29uZGVuc2UoIHNldE1hdGNoZWQgKTsKCQkJCX0KCgkJCQkvLyBBZGQgbWF0Y2hlcyB0byByZXN1bHRzCgkJCQlwdXNoLmFwcGx5KCByZXN1bHRzLCBzZXRNYXRjaGVkICk7CgoJCQkJLy8gU2VlZGxlc3Mgc2V0IG1hdGNoZXMgc3VjY2VlZGluZyBtdWx0aXBsZSBzdWNjZXNzZnVsIG1hdGNoZXJzIHN0aXB1bGF0ZSBzb3J0aW5nCgkJCQlpZiAoIG91dGVybW9zdCAmJiAhc2VlZCAmJiBzZXRNYXRjaGVkLmxlbmd0aCA+IDAgJiYKCQkJCQkoIG1hdGNoZWRDb3VudCArIHNldE1hdGNoZXJzLmxlbmd0aCApID4gMSApIHsKCgkJCQkJU2l6emxlLnVuaXF1ZVNvcnQoIHJlc3VsdHMgKTsKCQkJCX0KCQkJfQoKCQkJLy8gT3ZlcnJpZGUgbWFuaXB1bGF0aW9uIG9mIGdsb2JhbHMgYnkgbmVzdGVkIG1hdGNoZXJzCgkJCWlmICggb3V0ZXJtb3N0ICkgewoJCQkJZGlycnVucyA9IGRpcnJ1bnNVbmlxdWU7CgkJCQlvdXRlcm1vc3RDb250ZXh0ID0gY29udGV4dEJhY2t1cDsKCQkJfQoKCQkJcmV0dXJuIHVubWF0Y2hlZDsKCQl9OwoKCXJldHVybiBieVNldCA/CgkJbWFya0Z1bmN0aW9uKCBzdXBlck1hdGNoZXIgKSA6CgkJc3VwZXJNYXRjaGVyOwp9Cgpjb21waWxlID0gU2l6emxlLmNvbXBpbGUgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGdyb3VwIC8qIEludGVybmFsIFVzZSBPbmx5ICovICkgewoJdmFyIGksCgkJc2V0TWF0Y2hlcnMgPSBbXSwKCQllbGVtZW50TWF0Y2hlcnMgPSBbXSwKCQljYWNoZWQgPSBjb21waWxlckNhY2hlWyBzZWxlY3RvciArICIgIiBdOwoKCWlmICggIWNhY2hlZCApIHsKCQkvLyBHZW5lcmF0ZSBhIGZ1bmN0aW9uIG9mIHJlY3Vyc2l2ZSBmdW5jdGlvbnMgdGhhdCBjYW4gYmUgdXNlZCB0byBjaGVjayBlYWNoIGVsZW1lbnQKCQlpZiAoICFncm91cCApIHsKCQkJZ3JvdXAgPSB0b2tlbml6ZSggc2VsZWN0b3IgKTsKCQl9CgkJaSA9IGdyb3VwLmxlbmd0aDsKCQl3aGlsZSAoIGktLSApIHsKCQkJY2FjaGVkID0gbWF0Y2hlckZyb21Ub2tlbnMoIGdyb3VwW2ldICk7CgkJCWlmICggY2FjaGVkWyBleHBhbmRvIF0gKSB7CgkJCQlzZXRNYXRjaGVycy5wdXNoKCBjYWNoZWQgKTsKCQkJfSBlbHNlIHsKCQkJCWVsZW1lbnRNYXRjaGVycy5wdXNoKCBjYWNoZWQgKTsKCQkJfQoJCX0KCgkJLy8gQ2FjaGUgdGhlIGNvbXBpbGVkIGZ1bmN0aW9uCgkJY2FjaGVkID0gY29tcGlsZXJDYWNoZSggc2VsZWN0b3IsIG1hdGNoZXJGcm9tR3JvdXBNYXRjaGVycyggZWxlbWVudE1hdGNoZXJzLCBzZXRNYXRjaGVycyApICk7Cgl9CglyZXR1cm4gY2FjaGVkOwp9OwoKZnVuY3Rpb24gbXVsdGlwbGVDb250ZXh0cyggc2VsZWN0b3IsIGNvbnRleHRzLCByZXN1bHRzICkgewoJdmFyIGkgPSAwLAoJCWxlbiA9IGNvbnRleHRzLmxlbmd0aDsKCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgewoJCVNpenpsZSggc2VsZWN0b3IsIGNvbnRleHRzW2ldLCByZXN1bHRzICk7Cgl9CglyZXR1cm4gcmVzdWx0czsKfQoKZnVuY3Rpb24gc2VsZWN0KCBzZWxlY3RvciwgY29udGV4dCwgcmVzdWx0cywgc2VlZCApIHsKCXZhciBpLCB0b2tlbnMsIHRva2VuLCB0eXBlLCBmaW5kLAoJCW1hdGNoID0gdG9rZW5pemUoIHNlbGVjdG9yICk7CgoJaWYgKCAhc2VlZCApIHsKCQkvLyBUcnkgdG8gbWluaW1pemUgb3BlcmF0aW9ucyBpZiB0aGVyZSBpcyBvbmx5IG9uZSBncm91cAoJCWlmICggbWF0Y2gubGVuZ3RoID09PSAxICkgewoKCQkJLy8gVGFrZSBhIHNob3J0Y3V0IGFuZCBzZXQgdGhlIGNvbnRleHQgaWYgdGhlIHJvb3Qgc2VsZWN0b3IgaXMgYW4gSUQKCQkJdG9rZW5zID0gbWF0Y2hbMF0gPSBtYXRjaFswXS5zbGljZSggMCApOwoJCQlpZiAoIHRva2Vucy5sZW5ndGggPiAyICYmICh0b2tlbiA9IHRva2Vuc1swXSkudHlwZSA9PT0gIklEIiAmJgoJCQkJCXN1cHBvcnQuZ2V0QnlJZCAmJiBjb250ZXh0Lm5vZGVUeXBlID09PSA5ICYmIGRvY3VtZW50SXNIVE1MICYmCgkJCQkJRXhwci5yZWxhdGl2ZVsgdG9rZW5zWzFdLnR5cGUgXSApIHsKCgkJCQljb250ZXh0ID0gKCBFeHByLmZpbmRbIklEIl0oIHRva2VuLm1hdGNoZXNbMF0ucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSksIGNvbnRleHQgKSB8fCBbXSApWzBdOwoJCQkJaWYgKCAhY29udGV4dCApIHsKCQkJCQlyZXR1cm4gcmVzdWx0czsKCQkJCX0KCQkJCXNlbGVjdG9yID0gc2VsZWN0b3Iuc2xpY2UoIHRva2Vucy5zaGlmdCgpLnZhbHVlLmxlbmd0aCApOwoJCQl9CgoJCQkvLyBGZXRjaCBhIHNlZWQgc2V0IGZvciByaWdodC10by1sZWZ0IG1hdGNoaW5nCgkJCWkgPSBtYXRjaEV4cHJbIm5lZWRzQ29udGV4dCJdLnRlc3QoIHNlbGVjdG9yICkgPyAwIDogdG9rZW5zLmxlbmd0aDsKCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQl0b2tlbiA9IHRva2Vuc1tpXTsKCgkJCQkvLyBBYm9ydCBpZiB3ZSBoaXQgYSBjb21iaW5hdG9yCgkJCQlpZiAoIEV4cHIucmVsYXRpdmVbICh0eXBlID0gdG9rZW4udHlwZSkgXSApIHsKCQkJCQlicmVhazsKCQkJCX0KCQkJCWlmICggKGZpbmQgPSBFeHByLmZpbmRbIHR5cGUgXSkgKSB7CgkJCQkJLy8gU2VhcmNoLCBleHBhbmRpbmcgY29udGV4dCBmb3IgbGVhZGluZyBzaWJsaW5nIGNvbWJpbmF0b3JzCgkJCQkJaWYgKCAoc2VlZCA9IGZpbmQoCgkJCQkJCXRva2VuLm1hdGNoZXNbMF0ucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKSwKCQkJCQkJcnNpYmxpbmcudGVzdCggdG9rZW5zWzBdLnR5cGUgKSAmJiB0ZXN0Q29udGV4dCggY29udGV4dC5wYXJlbnROb2RlICkgfHwgY29udGV4dAoJCQkJCSkpICkgewoKCQkJCQkJLy8gSWYgc2VlZCBpcyBlbXB0eSBvciBubyB0b2tlbnMgcmVtYWluLCB3ZSBjYW4gcmV0dXJuIGVhcmx5CgkJCQkJCXRva2Vucy5zcGxpY2UoIGksIDEgKTsKCQkJCQkJc2VsZWN0b3IgPSBzZWVkLmxlbmd0aCAmJiB0b1NlbGVjdG9yKCB0b2tlbnMgKTsKCQkJCQkJaWYgKCAhc2VsZWN0b3IgKSB7CgkJCQkJCQlwdXNoLmFwcGx5KCByZXN1bHRzLCBzZWVkICk7CgkJCQkJCQlyZXR1cm4gcmVzdWx0czsKCQkJCQkJfQoKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJfQoKCS8vIENvbXBpbGUgYW5kIGV4ZWN1dGUgYSBmaWx0ZXJpbmcgZnVuY3Rpb24KCS8vIFByb3ZpZGUgYG1hdGNoYCB0byBhdm9pZCByZXRva2VuaXphdGlvbiBpZiB3ZSBtb2RpZmllZCB0aGUgc2VsZWN0b3IgYWJvdmUKCWNvbXBpbGUoIHNlbGVjdG9yLCBtYXRjaCApKAoJCXNlZWQsCgkJY29udGV4dCwKCQkhZG9jdW1lbnRJc0hUTUwsCgkJcmVzdWx0cywKCQlyc2libGluZy50ZXN0KCBzZWxlY3RvciApICYmIHRlc3RDb250ZXh0KCBjb250ZXh0LnBhcmVudE5vZGUgKSB8fCBjb250ZXh0CgkpOwoJcmV0dXJuIHJlc3VsdHM7Cn0KCi8vIE9uZS10aW1lIGFzc2lnbm1lbnRzCgovLyBTb3J0IHN0YWJpbGl0eQpzdXBwb3J0LnNvcnRTdGFibGUgPSBleHBhbmRvLnNwbGl0KCIiKS5zb3J0KCBzb3J0T3JkZXIgKS5qb2luKCIiKSA9PT0gZXhwYW5kbzsKCi8vIFN1cHBvcnQ6IENocm9tZTwxNAovLyBBbHdheXMgYXNzdW1lIGR1cGxpY2F0ZXMgaWYgdGhleSBhcmVuJ3QgcGFzc2VkIHRvIHRoZSBjb21wYXJpc29uIGZ1bmN0aW9uCnN1cHBvcnQuZGV0ZWN0RHVwbGljYXRlcyA9ICEhaGFzRHVwbGljYXRlOwoKLy8gSW5pdGlhbGl6ZSBhZ2FpbnN0IHRoZSBkZWZhdWx0IGRvY3VtZW50CnNldERvY3VtZW50KCk7CgovLyBTdXBwb3J0OiBXZWJraXQ8NTM3LjMyIC0gU2FmYXJpIDYuMC4zL0Nocm9tZSAyNSAoZml4ZWQgaW4gQ2hyb21lIDI3KQovLyBEZXRhY2hlZCBub2RlcyBjb25mb3VuZGluZ2x5IGZvbGxvdyAqZWFjaCBvdGhlcioKc3VwcG9ydC5zb3J0RGV0YWNoZWQgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdjEgKSB7CgkvLyBTaG91bGQgcmV0dXJuIDEsIGJ1dCByZXR1cm5zIDQgKGZvbGxvd2luZykKCXJldHVybiBkaXYxLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSApICYgMTsKfSk7CgovLyBTdXBwb3J0OiBJRTw4Ci8vIFByZXZlbnQgYXR0cmlidXRlL3Byb3BlcnR5ICJpbnRlcnBvbGF0aW9uIgovLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM1MzY0MjklMjhWUy44NSUyOS5hc3B4CmlmICggIWFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJZGl2LmlubmVySFRNTCA9ICI8YSBocmVmPScjJz48L2E+IjsKCXJldHVybiBkaXYuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUoImhyZWYiKSA9PT0gIiMiIDsKfSkgKSB7CglhZGRIYW5kbGUoICJ0eXBlfGhyZWZ8aGVpZ2h0fHdpZHRoIiwgZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGlzWE1MICkgewoJCWlmICggIWlzWE1MICkgewoJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUsIG5hbWUudG9Mb3dlckNhc2UoKSA9PT0gInR5cGUiID8gMSA6IDIgKTsKCQl9Cgl9KTsKfQoKLy8gU3VwcG9ydDogSUU8OQovLyBVc2UgZGVmYXVsdFZhbHVlIGluIHBsYWNlIG9mIGdldEF0dHJpYnV0ZSgidmFsdWUiKQppZiAoICFzdXBwb3J0LmF0dHJpYnV0ZXMgfHwgIWFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJZGl2LmlubmVySFRNTCA9ICI8aW5wdXQvPiI7CglkaXYuZmlyc3RDaGlsZC5zZXRBdHRyaWJ1dGUoICJ2YWx1ZSIsICIiICk7CglyZXR1cm4gZGl2LmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlKCAidmFsdWUiICkgPT09ICIiOwp9KSApIHsKCWFkZEhhbmRsZSggInZhbHVlIiwgZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGlzWE1MICkgewoJCWlmICggIWlzWE1MICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiApIHsKCQkJcmV0dXJuIGVsZW0uZGVmYXVsdFZhbHVlOwoJCX0KCX0pOwp9CgovLyBTdXBwb3J0OiBJRTw5Ci8vIFVzZSBnZXRBdHRyaWJ1dGVOb2RlIHRvIGZldGNoIGJvb2xlYW5zIHdoZW4gZ2V0QXR0cmlidXRlIGxpZXMKaWYgKCAhYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CglyZXR1cm4gZGl2LmdldEF0dHJpYnV0ZSgiZGlzYWJsZWQiKSA9PSBudWxsOwp9KSApIHsKCWFkZEhhbmRsZSggYm9vbGVhbnMsIGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBpc1hNTCApIHsKCQl2YXIgdmFsOwoJCWlmICggIWlzWE1MICkgewoJCQlyZXR1cm4gZWxlbVsgbmFtZSBdID09PSB0cnVlID8gbmFtZS50b0xvd2VyQ2FzZSgpIDoKCQkJCQkodmFsID0gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCBuYW1lICkpICYmIHZhbC5zcGVjaWZpZWQgPwoJCQkJCXZhbC52YWx1ZSA6CgkJCQludWxsOwoJCX0KCX0pOwp9CgpyZXR1cm4gU2l6emxlOwoKfSkoIHdpbmRvdyApOwoKCgpqUXVlcnkuZmluZCA9IFNpenpsZTsKalF1ZXJ5LmV4cHIgPSBTaXp6bGUuc2VsZWN0b3JzOwpqUXVlcnkuZXhwclsiOiJdID0galF1ZXJ5LmV4cHIucHNldWRvczsKalF1ZXJ5LnVuaXF1ZSA9IFNpenpsZS51bmlxdWVTb3J0OwpqUXVlcnkudGV4dCA9IFNpenpsZS5nZXRUZXh0OwpqUXVlcnkuaXNYTUxEb2MgPSBTaXp6bGUuaXNYTUw7CmpRdWVyeS5jb250YWlucyA9IFNpenpsZS5jb250YWluczsKCgoKdmFyIHJuZWVkc0NvbnRleHQgPSBqUXVlcnkuZXhwci5tYXRjaC5uZWVkc0NvbnRleHQ7Cgp2YXIgcnNpbmdsZVRhZyA9ICgvXjwoXHcrKVxzKlwvPz4oPzo8XC9cMT58KSQvKTsKCgoKdmFyIHJpc1NpbXBsZSA9IC9eLlteOiNcW1wuLF0qJC87CgovLyBJbXBsZW1lbnQgdGhlIGlkZW50aWNhbCBmdW5jdGlvbmFsaXR5IGZvciBmaWx0ZXIgYW5kIG5vdApmdW5jdGlvbiB3aW5ub3coIGVsZW1lbnRzLCBxdWFsaWZpZXIsIG5vdCApIHsKCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHF1YWxpZmllciApICkgewoJCXJldHVybiBqUXVlcnkuZ3JlcCggZWxlbWVudHMsIGZ1bmN0aW9uKCBlbGVtLCBpICkgewoJCQkvKiBqc2hpbnQgLVcwMTggKi8KCQkJcmV0dXJuICEhcXVhbGlmaWVyLmNhbGwoIGVsZW0sIGksIGVsZW0gKSAhPT0gbm90OwoJCX0pOwoKCX0KCglpZiAoIHF1YWxpZmllci5ub2RlVHlwZSApIHsKCQlyZXR1cm4galF1ZXJ5LmdyZXAoIGVsZW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuICggZWxlbSA9PT0gcXVhbGlmaWVyICkgIT09IG5vdDsKCQl9KTsKCgl9CgoJaWYgKCB0eXBlb2YgcXVhbGlmaWVyID09PSAic3RyaW5nIiApIHsKCQlpZiAoIHJpc1NpbXBsZS50ZXN0KCBxdWFsaWZpZXIgKSApIHsKCQkJcmV0dXJuIGpRdWVyeS5maWx0ZXIoIHF1YWxpZmllciwgZWxlbWVudHMsIG5vdCApOwoJCX0KCgkJcXVhbGlmaWVyID0galF1ZXJ5LmZpbHRlciggcXVhbGlmaWVyLCBlbGVtZW50cyApOwoJfQoKCXJldHVybiBqUXVlcnkuZ3JlcCggZWxlbWVudHMsIGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiAoIGpRdWVyeS5pbkFycmF5KCBlbGVtLCBxdWFsaWZpZXIgKSA+PSAwICkgIT09IG5vdDsKCX0pOwp9CgpqUXVlcnkuZmlsdGVyID0gZnVuY3Rpb24oIGV4cHIsIGVsZW1zLCBub3QgKSB7Cgl2YXIgZWxlbSA9IGVsZW1zWyAwIF07CgoJaWYgKCBub3QgKSB7CgkJZXhwciA9ICI6bm90KCIgKyBleHByICsgIikiOwoJfQoKCXJldHVybiBlbGVtcy5sZW5ndGggPT09IDEgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSA/CgkJalF1ZXJ5LmZpbmQubWF0Y2hlc1NlbGVjdG9yKCBlbGVtLCBleHByICkgPyBbIGVsZW0gXSA6IFtdIDoKCQlqUXVlcnkuZmluZC5tYXRjaGVzKCBleHByLCBqUXVlcnkuZ3JlcCggZWxlbXMsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbS5ub2RlVHlwZSA9PT0gMTsKCQl9KSk7Cn07CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCWZpbmQ6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQl2YXIgaSwKCQkJcmV0ID0gW10sCgkJCXNlbGYgPSB0aGlzLAoJCQlsZW4gPSBzZWxmLmxlbmd0aDsKCgkJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciICkgewoJCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGpRdWVyeSggc2VsZWN0b3IgKS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCQlmb3IgKCBpID0gMDsgaSA8IGxlbjsgaSsrICkgewoJCQkJCWlmICggalF1ZXJ5LmNvbnRhaW5zKCBzZWxmWyBpIF0sIHRoaXMgKSApIHsKCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJfQoJCQkJfQoJCQl9KSApOwoJCX0KCgkJZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsKCQkJalF1ZXJ5LmZpbmQoIHNlbGVjdG9yLCBzZWxmWyBpIF0sIHJldCApOwoJCX0KCgkJLy8gTmVlZGVkIGJlY2F1c2UgJCggc2VsZWN0b3IsIGNvbnRleHQgKSBiZWNvbWVzICQoIGNvbnRleHQgKS5maW5kKCBzZWxlY3RvciApCgkJcmV0ID0gdGhpcy5wdXNoU3RhY2soIGxlbiA+IDEgPyBqUXVlcnkudW5pcXVlKCByZXQgKSA6IHJldCApOwoJCXJldC5zZWxlY3RvciA9IHRoaXMuc2VsZWN0b3IgPyB0aGlzLnNlbGVjdG9yICsgIiAiICsgc2VsZWN0b3IgOiBzZWxlY3RvcjsKCQlyZXR1cm4gcmV0OwoJfSwKCWZpbHRlcjogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggd2lubm93KHRoaXMsIHNlbGVjdG9yIHx8IFtdLCBmYWxzZSkgKTsKCX0sCglub3Q6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHdpbm5vdyh0aGlzLCBzZWxlY3RvciB8fCBbXSwgdHJ1ZSkgKTsKCX0sCglpczogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiAhIXdpbm5vdygKCQkJdGhpcywKCgkJCS8vIElmIHRoaXMgaXMgYSBwb3NpdGlvbmFsL3JlbGF0aXZlIHNlbGVjdG9yLCBjaGVjayBtZW1iZXJzaGlwIGluIHRoZSByZXR1cm5lZCBzZXQKCQkJLy8gc28gJCgicDpmaXJzdCIpLmlzKCJwOmxhc3QiKSB3b24ndCByZXR1cm4gdHJ1ZSBmb3IgYSBkb2Mgd2l0aCB0d28gInAiLgoJCQl0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciICYmIHJuZWVkc0NvbnRleHQudGVzdCggc2VsZWN0b3IgKSA/CgkJCQlqUXVlcnkoIHNlbGVjdG9yICkgOgoJCQkJc2VsZWN0b3IgfHwgW10sCgkJCWZhbHNlCgkJKS5sZW5ndGg7Cgl9Cn0pOwoKCi8vIEluaXRpYWxpemUgYSBqUXVlcnkgb2JqZWN0CgoKLy8gQSBjZW50cmFsIHJlZmVyZW5jZSB0byB0aGUgcm9vdCBqUXVlcnkoZG9jdW1lbnQpCnZhciByb290alF1ZXJ5LAoKCS8vIFVzZSB0aGUgY29ycmVjdCBkb2N1bWVudCBhY2NvcmRpbmdseSB3aXRoIHdpbmRvdyBhcmd1bWVudCAoc2FuZGJveCkKCWRvY3VtZW50ID0gd2luZG93LmRvY3VtZW50LAoKCS8vIEEgc2ltcGxlIHdheSB0byBjaGVjayBmb3IgSFRNTCBzdHJpbmdzCgkvLyBQcmlvcml0aXplICNpZCBvdmVyIDx0YWc+IHRvIGF2b2lkIFhTUyB2aWEgbG9jYXRpb24uaGFzaCAoIzk1MjEpCgkvLyBTdHJpY3QgSFRNTCByZWNvZ25pdGlvbiAoIzExMjkwOiBtdXN0IHN0YXJ0IHdpdGggPCkKCXJxdWlja0V4cHIgPSAvXig/OlxzKig8W1x3XFddKz4pW14+XSp8IyhbXHctXSopKSQvLAoKCWluaXQgPSBqUXVlcnkuZm4uaW5pdCA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCApIHsKCQl2YXIgbWF0Y2gsIGVsZW07CgoJCS8vIEhBTkRMRTogJCgiIiksICQobnVsbCksICQodW5kZWZpbmVkKSwgJChmYWxzZSkKCQlpZiAoICFzZWxlY3RvciApIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQkvLyBIYW5kbGUgSFRNTCBzdHJpbmdzCgkJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciICkgewoJCQlpZiAoIHNlbGVjdG9yLmNoYXJBdCgwKSA9PT0gIjwiICYmIHNlbGVjdG9yLmNoYXJBdCggc2VsZWN0b3IubGVuZ3RoIC0gMSApID09PSAiPiIgJiYgc2VsZWN0b3IubGVuZ3RoID49IDMgKSB7CgkJCQkvLyBBc3N1bWUgdGhhdCBzdHJpbmdzIHRoYXQgc3RhcnQgYW5kIGVuZCB3aXRoIDw+IGFyZSBIVE1MIGFuZCBza2lwIHRoZSByZWdleCBjaGVjawoJCQkJbWF0Y2ggPSBbIG51bGwsIHNlbGVjdG9yLCBudWxsIF07CgoJCQl9IGVsc2UgewoJCQkJbWF0Y2ggPSBycXVpY2tFeHByLmV4ZWMoIHNlbGVjdG9yICk7CgkJCX0KCgkJCS8vIE1hdGNoIGh0bWwgb3IgbWFrZSBzdXJlIG5vIGNvbnRleHQgaXMgc3BlY2lmaWVkIGZvciAjaWQKCQkJaWYgKCBtYXRjaCAmJiAobWF0Y2hbMV0gfHwgIWNvbnRleHQpICkgewoKCQkJCS8vIEhBTkRMRTogJChodG1sKSAtPiAkKGFycmF5KQoJCQkJaWYgKCBtYXRjaFsxXSApIHsKCQkJCQljb250ZXh0ID0gY29udGV4dCBpbnN0YW5jZW9mIGpRdWVyeSA/IGNvbnRleHRbMF0gOiBjb250ZXh0OwoKCQkJCQkvLyBzY3JpcHRzIGlzIHRydWUgZm9yIGJhY2stY29tcGF0CgkJCQkJLy8gSW50ZW50aW9uYWxseSBsZXQgdGhlIGVycm9yIGJlIHRocm93biBpZiBwYXJzZUhUTUwgaXMgbm90IHByZXNlbnQKCQkJCQlqUXVlcnkubWVyZ2UoIHRoaXMsIGpRdWVyeS5wYXJzZUhUTUwoCgkJCQkJCW1hdGNoWzFdLAoJCQkJCQljb250ZXh0ICYmIGNvbnRleHQubm9kZVR5cGUgPyBjb250ZXh0Lm93bmVyRG9jdW1lbnQgfHwgY29udGV4dCA6IGRvY3VtZW50LAoJCQkJCQl0cnVlCgkJCQkJKSApOwoKCQkJCQkvLyBIQU5ETEU6ICQoaHRtbCwgcHJvcHMpCgkJCQkJaWYgKCByc2luZ2xlVGFnLnRlc3QoIG1hdGNoWzFdICkgJiYgalF1ZXJ5LmlzUGxhaW5PYmplY3QoIGNvbnRleHQgKSApIHsKCQkJCQkJZm9yICggbWF0Y2ggaW4gY29udGV4dCApIHsKCQkJCQkJCS8vIFByb3BlcnRpZXMgb2YgY29udGV4dCBhcmUgY2FsbGVkIGFzIG1ldGhvZHMgaWYgcG9zc2libGUKCQkJCQkJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHRoaXNbIG1hdGNoIF0gKSApIHsKCQkJCQkJCQl0aGlzWyBtYXRjaCBdKCBjb250ZXh0WyBtYXRjaCBdICk7CgoJCQkJCQkJLy8gLi4uYW5kIG90aGVyd2lzZSBzZXQgYXMgYXR0cmlidXRlcwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQl0aGlzLmF0dHIoIG1hdGNoLCBjb250ZXh0WyBtYXRjaCBdICk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgoJCQkJCXJldHVybiB0aGlzOwoKCQkJCS8vIEhBTkRMRTogJCgjaWQpCgkJCQl9IGVsc2UgewoJCQkJCWVsZW0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggbWF0Y2hbMl0gKTsKCgkJCQkJLy8gQ2hlY2sgcGFyZW50Tm9kZSB0byBjYXRjaCB3aGVuIEJsYWNrYmVycnkgNC42IHJldHVybnMKCQkJCQkvLyBub2RlcyB0aGF0IGFyZSBubyBsb25nZXIgaW4gdGhlIGRvY3VtZW50ICM2OTYzCgkJCQkJaWYgKCBlbGVtICYmIGVsZW0ucGFyZW50Tm9kZSApIHsKCQkJCQkJLy8gSGFuZGxlIHRoZSBjYXNlIHdoZXJlIElFIGFuZCBPcGVyYSByZXR1cm4gaXRlbXMKCQkJCQkJLy8gYnkgbmFtZSBpbnN0ZWFkIG9mIElECgkJCQkJCWlmICggZWxlbS5pZCAhPT0gbWF0Y2hbMl0gKSB7CgkJCQkJCQlyZXR1cm4gcm9vdGpRdWVyeS5maW5kKCBzZWxlY3RvciApOwoJCQkJCQl9CgoJCQkJCQkvLyBPdGhlcndpc2UsIHdlIGluamVjdCB0aGUgZWxlbWVudCBkaXJlY3RseSBpbnRvIHRoZSBqUXVlcnkgb2JqZWN0CgkJCQkJCXRoaXMubGVuZ3RoID0gMTsKCQkJCQkJdGhpc1swXSA9IGVsZW07CgkJCQkJfQoKCQkJCQl0aGlzLmNvbnRleHQgPSBkb2N1bWVudDsKCQkJCQl0aGlzLnNlbGVjdG9yID0gc2VsZWN0b3I7CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9CgoJCQkvLyBIQU5ETEU6ICQoZXhwciwgJCguLi4pKQoJCQl9IGVsc2UgaWYgKCAhY29udGV4dCB8fCBjb250ZXh0LmpxdWVyeSApIHsKCQkJCXJldHVybiAoIGNvbnRleHQgfHwgcm9vdGpRdWVyeSApLmZpbmQoIHNlbGVjdG9yICk7CgoJCQkvLyBIQU5ETEU6ICQoZXhwciwgY29udGV4dCkKCQkJLy8gKHdoaWNoIGlzIGp1c3QgZXF1aXZhbGVudCB0bzogJChjb250ZXh0KS5maW5kKGV4cHIpCgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gdGhpcy5jb25zdHJ1Y3RvciggY29udGV4dCApLmZpbmQoIHNlbGVjdG9yICk7CgkJCX0KCgkJLy8gSEFORExFOiAkKERPTUVsZW1lbnQpCgkJfSBlbHNlIGlmICggc2VsZWN0b3Iubm9kZVR5cGUgKSB7CgkJCXRoaXMuY29udGV4dCA9IHRoaXNbMF0gPSBzZWxlY3RvcjsKCQkJdGhpcy5sZW5ndGggPSAxOwoJCQlyZXR1cm4gdGhpczsKCgkJLy8gSEFORExFOiAkKGZ1bmN0aW9uKQoJCS8vIFNob3J0Y3V0IGZvciBkb2N1bWVudCByZWFkeQoJCX0gZWxzZSBpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBzZWxlY3RvciApICkgewoJCQlyZXR1cm4gdHlwZW9mIHJvb3RqUXVlcnkucmVhZHkgIT09ICJ1bmRlZmluZWQiID8KCQkJCXJvb3RqUXVlcnkucmVhZHkoIHNlbGVjdG9yICkgOgoJCQkJLy8gRXhlY3V0ZSBpbW1lZGlhdGVseSBpZiByZWFkeSBpcyBub3QgcHJlc2VudAoJCQkJc2VsZWN0b3IoIGpRdWVyeSApOwoJCX0KCgkJaWYgKCBzZWxlY3Rvci5zZWxlY3RvciAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLnNlbGVjdG9yID0gc2VsZWN0b3Iuc2VsZWN0b3I7CgkJCXRoaXMuY29udGV4dCA9IHNlbGVjdG9yLmNvbnRleHQ7CgkJfQoKCQlyZXR1cm4galF1ZXJ5Lm1ha2VBcnJheSggc2VsZWN0b3IsIHRoaXMgKTsKCX07CgovLyBHaXZlIHRoZSBpbml0IGZ1bmN0aW9uIHRoZSBqUXVlcnkgcHJvdG90eXBlIGZvciBsYXRlciBpbnN0YW50aWF0aW9uCmluaXQucHJvdG90eXBlID0galF1ZXJ5LmZuOwoKLy8gSW5pdGlhbGl6ZSBjZW50cmFsIHJlZmVyZW5jZQpyb290alF1ZXJ5ID0galF1ZXJ5KCBkb2N1bWVudCApOwoKCnZhciBycGFyZW50c3ByZXYgPSAvXig/OnBhcmVudHN8cHJldig/OlVudGlsfEFsbCkpLywKCS8vIG1ldGhvZHMgZ3VhcmFudGVlZCB0byBwcm9kdWNlIGEgdW5pcXVlIHNldCB3aGVuIHN0YXJ0aW5nIGZyb20gYSB1bmlxdWUgc2V0CglndWFyYW50ZWVkVW5pcXVlID0gewoJCWNoaWxkcmVuOiB0cnVlLAoJCWNvbnRlbnRzOiB0cnVlLAoJCW5leHQ6IHRydWUsCgkJcHJldjogdHJ1ZQoJfTsKCmpRdWVyeS5leHRlbmQoewoJZGlyOiBmdW5jdGlvbiggZWxlbSwgZGlyLCB1bnRpbCApIHsKCQl2YXIgbWF0Y2hlZCA9IFtdLAoJCQljdXIgPSBlbGVtWyBkaXIgXTsKCgkJd2hpbGUgKCBjdXIgJiYgY3VyLm5vZGVUeXBlICE9PSA5ICYmICh1bnRpbCA9PT0gdW5kZWZpbmVkIHx8IGN1ci5ub2RlVHlwZSAhPT0gMSB8fCAhalF1ZXJ5KCBjdXIgKS5pcyggdW50aWwgKSkgKSB7CgkJCWlmICggY3VyLm5vZGVUeXBlID09PSAxICkgewoJCQkJbWF0Y2hlZC5wdXNoKCBjdXIgKTsKCQkJfQoJCQljdXIgPSBjdXJbZGlyXTsKCQl9CgkJcmV0dXJuIG1hdGNoZWQ7Cgl9LAoKCXNpYmxpbmc6IGZ1bmN0aW9uKCBuLCBlbGVtICkgewoJCXZhciByID0gW107CgoJCWZvciAoIDsgbjsgbiA9IG4ubmV4dFNpYmxpbmcgKSB7CgkJCWlmICggbi5ub2RlVHlwZSA9PT0gMSAmJiBuICE9PSBlbGVtICkgewoJCQkJci5wdXNoKCBuICk7CgkJCX0KCQl9CgoJCXJldHVybiByOwoJfQp9KTsKCmpRdWVyeS5mbi5leHRlbmQoewoJaGFzOiBmdW5jdGlvbiggdGFyZ2V0ICkgewoJCXZhciBpLAoJCQl0YXJnZXRzID0galF1ZXJ5KCB0YXJnZXQsIHRoaXMgKSwKCQkJbGVuID0gdGFyZ2V0cy5sZW5ndGg7CgoJCXJldHVybiB0aGlzLmZpbHRlcihmdW5jdGlvbigpIHsKCQkJZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsKCQkJCWlmICggalF1ZXJ5LmNvbnRhaW5zKCB0aGlzLCB0YXJnZXRzW2ldICkgKSB7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9CgkJCX0KCQl9KTsKCX0sCgoJY2xvc2VzdDogZnVuY3Rpb24oIHNlbGVjdG9ycywgY29udGV4dCApIHsKCQl2YXIgY3VyLAoJCQlpID0gMCwKCQkJbCA9IHRoaXMubGVuZ3RoLAoJCQltYXRjaGVkID0gW10sCgkJCXBvcyA9IHJuZWVkc0NvbnRleHQudGVzdCggc2VsZWN0b3JzICkgfHwgdHlwZW9mIHNlbGVjdG9ycyAhPT0gInN0cmluZyIgPwoJCQkJalF1ZXJ5KCBzZWxlY3RvcnMsIGNvbnRleHQgfHwgdGhpcy5jb250ZXh0ICkgOgoJCQkJMDsKCgkJZm9yICggOyBpIDwgbDsgaSsrICkgewoJCQlmb3IgKCBjdXIgPSB0aGlzW2ldOyBjdXIgJiYgY3VyICE9PSBjb250ZXh0OyBjdXIgPSBjdXIucGFyZW50Tm9kZSApIHsKCQkJCS8vIEFsd2F5cyBza2lwIGRvY3VtZW50IGZyYWdtZW50cwoJCQkJaWYgKCBjdXIubm9kZVR5cGUgPCAxMSAmJiAocG9zID8KCQkJCQlwb3MuaW5kZXgoY3VyKSA+IC0xIDoKCgkJCQkJLy8gRG9uJ3QgcGFzcyBub24tZWxlbWVudHMgdG8gU2l6emxlCgkJCQkJY3VyLm5vZGVUeXBlID09PSAxICYmCgkJCQkJCWpRdWVyeS5maW5kLm1hdGNoZXNTZWxlY3RvcihjdXIsIHNlbGVjdG9ycykpICkgewoKCQkJCQltYXRjaGVkLnB1c2goIGN1ciApOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIG1hdGNoZWQubGVuZ3RoID4gMSA/IGpRdWVyeS51bmlxdWUoIG1hdGNoZWQgKSA6IG1hdGNoZWQgKTsKCX0sCgoJLy8gRGV0ZXJtaW5lIHRoZSBwb3NpdGlvbiBvZiBhbiBlbGVtZW50IHdpdGhpbgoJLy8gdGhlIG1hdGNoZWQgc2V0IG9mIGVsZW1lbnRzCglpbmRleDogZnVuY3Rpb24oIGVsZW0gKSB7CgoJCS8vIE5vIGFyZ3VtZW50LCByZXR1cm4gaW5kZXggaW4gcGFyZW50CgkJaWYgKCAhZWxlbSApIHsKCQkJcmV0dXJuICggdGhpc1swXSAmJiB0aGlzWzBdLnBhcmVudE5vZGUgKSA/IHRoaXMuZmlyc3QoKS5wcmV2QWxsKCkubGVuZ3RoIDogLTE7CgkJfQoKCQkvLyBpbmRleCBpbiBzZWxlY3RvcgoJCWlmICggdHlwZW9mIGVsZW0gPT09ICJzdHJpbmciICkgewoJCQlyZXR1cm4galF1ZXJ5LmluQXJyYXkoIHRoaXNbMF0sIGpRdWVyeSggZWxlbSApICk7CgkJfQoKCQkvLyBMb2NhdGUgdGhlIHBvc2l0aW9uIG9mIHRoZSBkZXNpcmVkIGVsZW1lbnQKCQlyZXR1cm4galF1ZXJ5LmluQXJyYXkoCgkJCS8vIElmIGl0IHJlY2VpdmVzIGEgalF1ZXJ5IG9iamVjdCwgdGhlIGZpcnN0IGVsZW1lbnQgaXMgdXNlZAoJCQllbGVtLmpxdWVyeSA/IGVsZW1bMF0gOiBlbGVtLCB0aGlzICk7Cgl9LAoKCWFkZDogZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0ICkgewoJCXJldHVybiB0aGlzLnB1c2hTdGFjaygKCQkJalF1ZXJ5LnVuaXF1ZSgKCQkJCWpRdWVyeS5tZXJnZSggdGhpcy5nZXQoKSwgalF1ZXJ5KCBzZWxlY3RvciwgY29udGV4dCApICkKCQkJKQoJCSk7Cgl9LAoKCWFkZEJhY2s6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gdGhpcy5hZGQoIHNlbGVjdG9yID09IG51bGwgPwoJCQl0aGlzLnByZXZPYmplY3QgOiB0aGlzLnByZXZPYmplY3QuZmlsdGVyKHNlbGVjdG9yKQoJCSk7Cgl9Cn0pOwoKZnVuY3Rpb24gc2libGluZyggY3VyLCBkaXIgKSB7CglkbyB7CgkJY3VyID0gY3VyWyBkaXIgXTsKCX0gd2hpbGUgKCBjdXIgJiYgY3VyLm5vZGVUeXBlICE9PSAxICk7CgoJcmV0dXJuIGN1cjsKfQoKalF1ZXJ5LmVhY2goewoJcGFyZW50OiBmdW5jdGlvbiggZWxlbSApIHsKCQl2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwoJCXJldHVybiBwYXJlbnQgJiYgcGFyZW50Lm5vZGVUeXBlICE9PSAxMSA/IHBhcmVudCA6IG51bGw7Cgl9LAoJcGFyZW50czogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJwYXJlbnROb2RlIiApOwoJfSwKCXBhcmVudHNVbnRpbDogZnVuY3Rpb24oIGVsZW0sIGksIHVudGlsICkgewoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAicGFyZW50Tm9kZSIsIHVudGlsICk7Cgl9LAoJbmV4dDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIHNpYmxpbmcoIGVsZW0sICJuZXh0U2libGluZyIgKTsKCX0sCglwcmV2OiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gc2libGluZyggZWxlbSwgInByZXZpb3VzU2libGluZyIgKTsKCX0sCgluZXh0QWxsOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgIm5leHRTaWJsaW5nIiApOwoJfSwKCXByZXZBbGw6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAicHJldmlvdXNTaWJsaW5nIiApOwoJfSwKCW5leHRVbnRpbDogZnVuY3Rpb24oIGVsZW0sIGksIHVudGlsICkgewoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAibmV4dFNpYmxpbmciLCB1bnRpbCApOwoJfSwKCXByZXZVbnRpbDogZnVuY3Rpb24oIGVsZW0sIGksIHVudGlsICkgewoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAicHJldmlvdXNTaWJsaW5nIiwgdW50aWwgKTsKCX0sCglzaWJsaW5nczogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIGpRdWVyeS5zaWJsaW5nKCAoIGVsZW0ucGFyZW50Tm9kZSB8fCB7fSApLmZpcnN0Q2hpbGQsIGVsZW0gKTsKCX0sCgljaGlsZHJlbjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIGpRdWVyeS5zaWJsaW5nKCBlbGVtLmZpcnN0Q2hpbGQgKTsKCX0sCgljb250ZW50czogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIGpRdWVyeS5ub2RlTmFtZSggZWxlbSwgImlmcmFtZSIgKSA/CgkJCWVsZW0uY29udGVudERvY3VtZW50IHx8IGVsZW0uY29udGVudFdpbmRvdy5kb2N1bWVudCA6CgkJCWpRdWVyeS5tZXJnZSggW10sIGVsZW0uY2hpbGROb2RlcyApOwoJfQp9LCBmdW5jdGlvbiggbmFtZSwgZm4gKSB7CglqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCB1bnRpbCwgc2VsZWN0b3IgKSB7CgkJdmFyIHJldCA9IGpRdWVyeS5tYXAoIHRoaXMsIGZuLCB1bnRpbCApOwoKCQlpZiAoIG5hbWUuc2xpY2UoIC01ICkgIT09ICJVbnRpbCIgKSB7CgkJCXNlbGVjdG9yID0gdW50aWw7CgkJfQoKCQlpZiAoIHNlbGVjdG9yICYmIHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIgKSB7CgkJCXJldCA9IGpRdWVyeS5maWx0ZXIoIHNlbGVjdG9yLCByZXQgKTsKCQl9CgoJCWlmICggdGhpcy5sZW5ndGggPiAxICkgewoJCQkvLyBSZW1vdmUgZHVwbGljYXRlcwoJCQlpZiAoICFndWFyYW50ZWVkVW5pcXVlWyBuYW1lIF0gKSB7CgkJCQlyZXQgPSBqUXVlcnkudW5pcXVlKCByZXQgKTsKCQkJfQoKCQkJLy8gUmV2ZXJzZSBvcmRlciBmb3IgcGFyZW50cyogYW5kIHByZXYtZGVyaXZhdGl2ZXMKCQkJaWYgKCBycGFyZW50c3ByZXYudGVzdCggbmFtZSApICkgewoJCQkJcmV0ID0gcmV0LnJldmVyc2UoKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCByZXQgKTsKCX07Cn0pOwp2YXIgcm5vdHdoaXRlID0gKC9cUysvZyk7CgoKCi8vIFN0cmluZyB0byBPYmplY3Qgb3B0aW9ucyBmb3JtYXQgY2FjaGUKdmFyIG9wdGlvbnNDYWNoZSA9IHt9OwoKLy8gQ29udmVydCBTdHJpbmctZm9ybWF0dGVkIG9wdGlvbnMgaW50byBPYmplY3QtZm9ybWF0dGVkIG9uZXMgYW5kIHN0b3JlIGluIGNhY2hlCmZ1bmN0aW9uIGNyZWF0ZU9wdGlvbnMoIG9wdGlvbnMgKSB7Cgl2YXIgb2JqZWN0ID0gb3B0aW9uc0NhY2hlWyBvcHRpb25zIF0gPSB7fTsKCWpRdWVyeS5lYWNoKCBvcHRpb25zLm1hdGNoKCBybm90d2hpdGUgKSB8fCBbXSwgZnVuY3Rpb24oIF8sIGZsYWcgKSB7CgkJb2JqZWN0WyBmbGFnIF0gPSB0cnVlOwoJfSk7CglyZXR1cm4gb2JqZWN0Owp9CgovKgogKiBDcmVhdGUgYSBjYWxsYmFjayBsaXN0IHVzaW5nIHRoZSBmb2xsb3dpbmcgcGFyYW1ldGVyczoKICoKICoJb3B0aW9uczogYW4gb3B0aW9uYWwgbGlzdCBvZiBzcGFjZS1zZXBhcmF0ZWQgb3B0aW9ucyB0aGF0IHdpbGwgY2hhbmdlIGhvdwogKgkJCXRoZSBjYWxsYmFjayBsaXN0IGJlaGF2ZXMgb3IgYSBtb3JlIHRyYWRpdGlvbmFsIG9wdGlvbiBvYmplY3QKICoKICogQnkgZGVmYXVsdCBhIGNhbGxiYWNrIGxpc3Qgd2lsbCBhY3QgbGlrZSBhbiBldmVudCBjYWxsYmFjayBsaXN0IGFuZCBjYW4gYmUKICogImZpcmVkIiBtdWx0aXBsZSB0aW1lcy4KICoKICogUG9zc2libGUgb3B0aW9uczoKICoKICoJb25jZToJCQl3aWxsIGVuc3VyZSB0aGUgY2FsbGJhY2sgbGlzdCBjYW4gb25seSBiZSBmaXJlZCBvbmNlIChsaWtlIGEgRGVmZXJyZWQpCiAqCiAqCW1lbW9yeToJCQl3aWxsIGtlZXAgdHJhY2sgb2YgcHJldmlvdXMgdmFsdWVzIGFuZCB3aWxsIGNhbGwgYW55IGNhbGxiYWNrIGFkZGVkCiAqCQkJCQlhZnRlciB0aGUgbGlzdCBoYXMgYmVlbiBmaXJlZCByaWdodCBhd2F5IHdpdGggdGhlIGxhdGVzdCAibWVtb3JpemVkIgogKgkJCQkJdmFsdWVzIChsaWtlIGEgRGVmZXJyZWQpCiAqCiAqCXVuaXF1ZToJCQl3aWxsIGVuc3VyZSBhIGNhbGxiYWNrIGNhbiBvbmx5IGJlIGFkZGVkIG9uY2UgKG5vIGR1cGxpY2F0ZSBpbiB0aGUgbGlzdCkKICoKICoJc3RvcE9uRmFsc2U6CWludGVycnVwdCBjYWxsaW5ncyB3aGVuIGEgY2FsbGJhY2sgcmV0dXJucyBmYWxzZQogKgogKi8KalF1ZXJ5LkNhbGxiYWNrcyA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoKCS8vIENvbnZlcnQgb3B0aW9ucyBmcm9tIFN0cmluZy1mb3JtYXR0ZWQgdG8gT2JqZWN0LWZvcm1hdHRlZCBpZiBuZWVkZWQKCS8vICh3ZSBjaGVjayBpbiBjYWNoZSBmaXJzdCkKCW9wdGlvbnMgPSB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyIgPwoJCSggb3B0aW9uc0NhY2hlWyBvcHRpb25zIF0gfHwgY3JlYXRlT3B0aW9ucyggb3B0aW9ucyApICkgOgoJCWpRdWVyeS5leHRlbmQoIHt9LCBvcHRpb25zICk7CgoJdmFyIC8vIEZsYWcgdG8ga25vdyBpZiBsaXN0IGlzIGN1cnJlbnRseSBmaXJpbmcKCQlmaXJpbmcsCgkJLy8gTGFzdCBmaXJlIHZhbHVlIChmb3Igbm9uLWZvcmdldHRhYmxlIGxpc3RzKQoJCW1lbW9yeSwKCQkvLyBGbGFnIHRvIGtub3cgaWYgbGlzdCB3YXMgYWxyZWFkeSBmaXJlZAoJCWZpcmVkLAoJCS8vIEVuZCBvZiB0aGUgbG9vcCB3aGVuIGZpcmluZwoJCWZpcmluZ0xlbmd0aCwKCQkvLyBJbmRleCBvZiBjdXJyZW50bHkgZmlyaW5nIGNhbGxiYWNrIChtb2RpZmllZCBieSByZW1vdmUgaWYgbmVlZGVkKQoJCWZpcmluZ0luZGV4LAoJCS8vIEZpcnN0IGNhbGxiYWNrIHRvIGZpcmUgKHVzZWQgaW50ZXJuYWxseSBieSBhZGQgYW5kIGZpcmVXaXRoKQoJCWZpcmluZ1N0YXJ0LAoJCS8vIEFjdHVhbCBjYWxsYmFjayBsaXN0CgkJbGlzdCA9IFtdLAoJCS8vIFN0YWNrIG9mIGZpcmUgY2FsbHMgZm9yIHJlcGVhdGFibGUgbGlzdHMKCQlzdGFjayA9ICFvcHRpb25zLm9uY2UgJiYgW10sCgkJLy8gRmlyZSBjYWxsYmFja3MKCQlmaXJlID0gZnVuY3Rpb24oIGRhdGEgKSB7CgkJCW1lbW9yeSA9IG9wdGlvbnMubWVtb3J5ICYmIGRhdGE7CgkJCWZpcmVkID0gdHJ1ZTsKCQkJZmlyaW5nSW5kZXggPSBmaXJpbmdTdGFydCB8fCAwOwoJCQlmaXJpbmdTdGFydCA9IDA7CgkJCWZpcmluZ0xlbmd0aCA9IGxpc3QubGVuZ3RoOwoJCQlmaXJpbmcgPSB0cnVlOwoJCQlmb3IgKCA7IGxpc3QgJiYgZmlyaW5nSW5kZXggPCBmaXJpbmdMZW5ndGg7IGZpcmluZ0luZGV4KysgKSB7CgkJCQlpZiAoIGxpc3RbIGZpcmluZ0luZGV4IF0uYXBwbHkoIGRhdGFbIDAgXSwgZGF0YVsgMSBdICkgPT09IGZhbHNlICYmIG9wdGlvbnMuc3RvcE9uRmFsc2UgKSB7CgkJCQkJbWVtb3J5ID0gZmFsc2U7IC8vIFRvIHByZXZlbnQgZnVydGhlciBjYWxscyB1c2luZyBhZGQKCQkJCQlicmVhazsKCQkJCX0KCQkJfQoJCQlmaXJpbmcgPSBmYWxzZTsKCQkJaWYgKCBsaXN0ICkgewoJCQkJaWYgKCBzdGFjayApIHsKCQkJCQlpZiAoIHN0YWNrLmxlbmd0aCApIHsKCQkJCQkJZmlyZSggc3RhY2suc2hpZnQoKSApOwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAoIG1lbW9yeSApIHsKCQkJCQlsaXN0ID0gW107CgkJCQl9IGVsc2UgewoJCQkJCXNlbGYuZGlzYWJsZSgpOwoJCQkJfQoJCQl9CgkJfSwKCQkvLyBBY3R1YWwgQ2FsbGJhY2tzIG9iamVjdAoJCXNlbGYgPSB7CgkJCS8vIEFkZCBhIGNhbGxiYWNrIG9yIGEgY29sbGVjdGlvbiBvZiBjYWxsYmFja3MgdG8gdGhlIGxpc3QKCQkJYWRkOiBmdW5jdGlvbigpIHsKCQkJCWlmICggbGlzdCApIHsKCQkJCQkvLyBGaXJzdCwgd2Ugc2F2ZSB0aGUgY3VycmVudCBsZW5ndGgKCQkJCQl2YXIgc3RhcnQgPSBsaXN0Lmxlbmd0aDsKCQkJCQkoZnVuY3Rpb24gYWRkKCBhcmdzICkgewoJCQkJCQlqUXVlcnkuZWFjaCggYXJncywgZnVuY3Rpb24oIF8sIGFyZyApIHsKCQkJCQkJCXZhciB0eXBlID0galF1ZXJ5LnR5cGUoIGFyZyApOwoJCQkJCQkJaWYgKCB0eXBlID09PSAiZnVuY3Rpb24iICkgewoJCQkJCQkJCWlmICggIW9wdGlvbnMudW5pcXVlIHx8ICFzZWxmLmhhcyggYXJnICkgKSB7CgkJCQkJCQkJCWxpc3QucHVzaCggYXJnICk7CgkJCQkJCQkJfQoJCQkJCQkJfSBlbHNlIGlmICggYXJnICYmIGFyZy5sZW5ndGggJiYgdHlwZSAhPT0gInN0cmluZyIgKSB7CgkJCQkJCQkJLy8gSW5zcGVjdCByZWN1cnNpdmVseQoJCQkJCQkJCWFkZCggYXJnICk7CgkJCQkJCQl9CgkJCQkJCX0pOwoJCQkJCX0pKCBhcmd1bWVudHMgKTsKCQkJCQkvLyBEbyB3ZSBuZWVkIHRvIGFkZCB0aGUgY2FsbGJhY2tzIHRvIHRoZQoJCQkJCS8vIGN1cnJlbnQgZmlyaW5nIGJhdGNoPwoJCQkJCWlmICggZmlyaW5nICkgewoJCQkJCQlmaXJpbmdMZW5ndGggPSBsaXN0Lmxlbmd0aDsKCQkJCQkvLyBXaXRoIG1lbW9yeSwgaWYgd2UncmUgbm90IGZpcmluZyB0aGVuCgkJCQkJLy8gd2Ugc2hvdWxkIGNhbGwgcmlnaHQgYXdheQoJCQkJCX0gZWxzZSBpZiAoIG1lbW9yeSApIHsKCQkJCQkJZmlyaW5nU3RhcnQgPSBzdGFydDsKCQkJCQkJZmlyZSggbWVtb3J5ICk7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCS8vIFJlbW92ZSBhIGNhbGxiYWNrIGZyb20gdGhlIGxpc3QKCQkJcmVtb3ZlOiBmdW5jdGlvbigpIHsKCQkJCWlmICggbGlzdCApIHsKCQkJCQlqUXVlcnkuZWFjaCggYXJndW1lbnRzLCBmdW5jdGlvbiggXywgYXJnICkgewoJCQkJCQl2YXIgaW5kZXg7CgkJCQkJCXdoaWxlICggKCBpbmRleCA9IGpRdWVyeS5pbkFycmF5KCBhcmcsIGxpc3QsIGluZGV4ICkgKSA+IC0xICkgewoJCQkJCQkJbGlzdC5zcGxpY2UoIGluZGV4LCAxICk7CgkJCQkJCQkvLyBIYW5kbGUgZmlyaW5nIGluZGV4ZXMKCQkJCQkJCWlmICggZmlyaW5nICkgewoJCQkJCQkJCWlmICggaW5kZXggPD0gZmlyaW5nTGVuZ3RoICkgewoJCQkJCQkJCQlmaXJpbmdMZW5ndGgtLTsKCQkJCQkJCQl9CgkJCQkJCQkJaWYgKCBpbmRleCA8PSBmaXJpbmdJbmRleCApIHsKCQkJCQkJCQkJZmlyaW5nSW5kZXgtLTsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9KTsKCQkJCX0KCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQkvLyBDaGVjayBpZiBhIGdpdmVuIGNhbGxiYWNrIGlzIGluIHRoZSBsaXN0LgoJCQkvLyBJZiBubyBhcmd1bWVudCBpcyBnaXZlbiwgcmV0dXJuIHdoZXRoZXIgb3Igbm90IGxpc3QgaGFzIGNhbGxiYWNrcyBhdHRhY2hlZC4KCQkJaGFzOiBmdW5jdGlvbiggZm4gKSB7CgkJCQlyZXR1cm4gZm4gPyBqUXVlcnkuaW5BcnJheSggZm4sIGxpc3QgKSA+IC0xIDogISEoIGxpc3QgJiYgbGlzdC5sZW5ndGggKTsKCQkJfSwKCQkJLy8gUmVtb3ZlIGFsbCBjYWxsYmFja3MgZnJvbSB0aGUgbGlzdAoJCQllbXB0eTogZnVuY3Rpb24oKSB7CgkJCQlsaXN0ID0gW107CgkJCQlmaXJpbmdMZW5ndGggPSAwOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCS8vIEhhdmUgdGhlIGxpc3QgZG8gbm90aGluZyBhbnltb3JlCgkJCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCQkJbGlzdCA9IHN0YWNrID0gbWVtb3J5ID0gdW5kZWZpbmVkOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCS8vIElzIGl0IGRpc2FibGVkPwoJCQlkaXNhYmxlZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gIWxpc3Q7CgkJCX0sCgkJCS8vIExvY2sgdGhlIGxpc3QgaW4gaXRzIGN1cnJlbnQgc3RhdGUKCQkJbG9jazogZnVuY3Rpb24oKSB7CgkJCQlzdGFjayA9IHVuZGVmaW5lZDsKCQkJCWlmICggIW1lbW9yeSApIHsKCQkJCQlzZWxmLmRpc2FibGUoKTsKCQkJCX0KCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQkvLyBJcyBpdCBsb2NrZWQ/CgkJCWxvY2tlZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gIXN0YWNrOwoJCQl9LAoJCQkvLyBDYWxsIGFsbCBjYWxsYmFja3Mgd2l0aCB0aGUgZ2l2ZW4gY29udGV4dCBhbmQgYXJndW1lbnRzCgkJCWZpcmVXaXRoOiBmdW5jdGlvbiggY29udGV4dCwgYXJncyApIHsKCQkJCWlmICggbGlzdCAmJiAoICFmaXJlZCB8fCBzdGFjayApICkgewoJCQkJCWFyZ3MgPSBhcmdzIHx8IFtdOwoJCQkJCWFyZ3MgPSBbIGNvbnRleHQsIGFyZ3Muc2xpY2UgPyBhcmdzLnNsaWNlKCkgOiBhcmdzIF07CgkJCQkJaWYgKCBmaXJpbmcgKSB7CgkJCQkJCXN0YWNrLnB1c2goIGFyZ3MgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlmaXJlKCBhcmdzICk7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCS8vIENhbGwgYWxsIHRoZSBjYWxsYmFja3Mgd2l0aCB0aGUgZ2l2ZW4gYXJndW1lbnRzCgkJCWZpcmU6IGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5maXJlV2l0aCggdGhpcywgYXJndW1lbnRzICk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJLy8gVG8ga25vdyBpZiB0aGUgY2FsbGJhY2tzIGhhdmUgYWxyZWFkeSBiZWVuIGNhbGxlZCBhdCBsZWFzdCBvbmNlCgkJCWZpcmVkOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAhIWZpcmVkOwoJCQl9CgkJfTsKCglyZXR1cm4gc2VsZjsKfTsKCgpqUXVlcnkuZXh0ZW5kKHsKCglEZWZlcnJlZDogZnVuY3Rpb24oIGZ1bmMgKSB7CgkJdmFyIHR1cGxlcyA9IFsKCQkJCS8vIGFjdGlvbiwgYWRkIGxpc3RlbmVyLCBsaXN0ZW5lciBsaXN0LCBmaW5hbCBzdGF0ZQoJCQkJWyAicmVzb2x2ZSIsICJkb25lIiwgalF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwgInJlc29sdmVkIiBdLAoJCQkJWyAicmVqZWN0IiwgImZhaWwiLCBqUXVlcnkuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLCAicmVqZWN0ZWQiIF0sCgkJCQlbICJub3RpZnkiLCAicHJvZ3Jlc3MiLCBqUXVlcnkuQ2FsbGJhY2tzKCJtZW1vcnkiKSBdCgkJCV0sCgkJCXN0YXRlID0gInBlbmRpbmciLAoJCQlwcm9taXNlID0gewoJCQkJc3RhdGU6IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiBzdGF0ZTsKCQkJCX0sCgkJCQlhbHdheXM6IGZ1bmN0aW9uKCkgewoJCQkJCWRlZmVycmVkLmRvbmUoIGFyZ3VtZW50cyApLmZhaWwoIGFyZ3VtZW50cyApOwoJCQkJCXJldHVybiB0aGlzOwoJCQkJfSwKCQkJCXRoZW46IGZ1bmN0aW9uKCAvKiBmbkRvbmUsIGZuRmFpbCwgZm5Qcm9ncmVzcyAqLyApIHsKCQkJCQl2YXIgZm5zID0gYXJndW1lbnRzOwoJCQkJCXJldHVybiBqUXVlcnkuRGVmZXJyZWQoZnVuY3Rpb24oIG5ld0RlZmVyICkgewoJCQkJCQlqUXVlcnkuZWFjaCggdHVwbGVzLCBmdW5jdGlvbiggaSwgdHVwbGUgKSB7CgkJCQkJCQl2YXIgZm4gPSBqUXVlcnkuaXNGdW5jdGlvbiggZm5zWyBpIF0gKSAmJiBmbnNbIGkgXTsKCQkJCQkJCS8vIGRlZmVycmVkWyBkb25lIHwgZmFpbCB8IHByb2dyZXNzIF0gZm9yIGZvcndhcmRpbmcgYWN0aW9ucyB0byBuZXdEZWZlcgoJCQkJCQkJZGVmZXJyZWRbIHR1cGxlWzFdIF0oZnVuY3Rpb24oKSB7CgkJCQkJCQkJdmFyIHJldHVybmVkID0gZm4gJiYgZm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJCQkJCWlmICggcmV0dXJuZWQgJiYgalF1ZXJ5LmlzRnVuY3Rpb24oIHJldHVybmVkLnByb21pc2UgKSApIHsKCQkJCQkJCQkJcmV0dXJuZWQucHJvbWlzZSgpCgkJCQkJCQkJCQkuZG9uZSggbmV3RGVmZXIucmVzb2x2ZSApCgkJCQkJCQkJCQkuZmFpbCggbmV3RGVmZXIucmVqZWN0ICkKCQkJCQkJCQkJCS5wcm9ncmVzcyggbmV3RGVmZXIubm90aWZ5ICk7CgkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJbmV3RGVmZXJbIHR1cGxlWyAwIF0gKyAiV2l0aCIgXSggdGhpcyA9PT0gcHJvbWlzZSA/IG5ld0RlZmVyLnByb21pc2UoKSA6IHRoaXMsIGZuID8gWyByZXR1cm5lZCBdIDogYXJndW1lbnRzICk7CgkJCQkJCQkJfQoJCQkJCQkJfSk7CgkJCQkJCX0pOwoJCQkJCQlmbnMgPSBudWxsOwoJCQkJCX0pLnByb21pc2UoKTsKCQkJCX0sCgkJCQkvLyBHZXQgYSBwcm9taXNlIGZvciB0aGlzIGRlZmVycmVkCgkJCQkvLyBJZiBvYmogaXMgcHJvdmlkZWQsIHRoZSBwcm9taXNlIGFzcGVjdCBpcyBhZGRlZCB0byB0aGUgb2JqZWN0CgkJCQlwcm9taXNlOiBmdW5jdGlvbiggb2JqICkgewoJCQkJCXJldHVybiBvYmogIT0gbnVsbCA/IGpRdWVyeS5leHRlbmQoIG9iaiwgcHJvbWlzZSApIDogcHJvbWlzZTsKCQkJCX0KCQkJfSwKCQkJZGVmZXJyZWQgPSB7fTsKCgkJLy8gS2VlcCBwaXBlIGZvciBiYWNrLWNvbXBhdAoJCXByb21pc2UucGlwZSA9IHByb21pc2UudGhlbjsKCgkJLy8gQWRkIGxpc3Qtc3BlY2lmaWMgbWV0aG9kcwoJCWpRdWVyeS5lYWNoKCB0dXBsZXMsIGZ1bmN0aW9uKCBpLCB0dXBsZSApIHsKCQkJdmFyIGxpc3QgPSB0dXBsZVsgMiBdLAoJCQkJc3RhdGVTdHJpbmcgPSB0dXBsZVsgMyBdOwoKCQkJLy8gcHJvbWlzZVsgZG9uZSB8IGZhaWwgfCBwcm9ncmVzcyBdID0gbGlzdC5hZGQKCQkJcHJvbWlzZVsgdHVwbGVbMV0gXSA9IGxpc3QuYWRkOwoKCQkJLy8gSGFuZGxlIHN0YXRlCgkJCWlmICggc3RhdGVTdHJpbmcgKSB7CgkJCQlsaXN0LmFkZChmdW5jdGlvbigpIHsKCQkJCQkvLyBzdGF0ZSA9IFsgcmVzb2x2ZWQgfCByZWplY3RlZCBdCgkJCQkJc3RhdGUgPSBzdGF0ZVN0cmluZzsKCgkJCQkvLyBbIHJlamVjdF9saXN0IHwgcmVzb2x2ZV9saXN0IF0uZGlzYWJsZTsgcHJvZ3Jlc3NfbGlzdC5sb2NrCgkJCQl9LCB0dXBsZXNbIGkgXiAxIF1bIDIgXS5kaXNhYmxlLCB0dXBsZXNbIDIgXVsgMiBdLmxvY2sgKTsKCQkJfQoKCQkJLy8gZGVmZXJyZWRbIHJlc29sdmUgfCByZWplY3QgfCBub3RpZnkgXQoJCQlkZWZlcnJlZFsgdHVwbGVbMF0gXSA9IGZ1bmN0aW9uKCkgewoJCQkJZGVmZXJyZWRbIHR1cGxlWzBdICsgIldpdGgiIF0oIHRoaXMgPT09IGRlZmVycmVkID8gcHJvbWlzZSA6IHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX07CgkJCWRlZmVycmVkWyB0dXBsZVswXSArICJXaXRoIiBdID0gbGlzdC5maXJlV2l0aDsKCQl9KTsKCgkJLy8gTWFrZSB0aGUgZGVmZXJyZWQgYSBwcm9taXNlCgkJcHJvbWlzZS5wcm9taXNlKCBkZWZlcnJlZCApOwoKCQkvLyBDYWxsIGdpdmVuIGZ1bmMgaWYgYW55CgkJaWYgKCBmdW5jICkgewoJCQlmdW5jLmNhbGwoIGRlZmVycmVkLCBkZWZlcnJlZCApOwoJCX0KCgkJLy8gQWxsIGRvbmUhCgkJcmV0dXJuIGRlZmVycmVkOwoJfSwKCgkvLyBEZWZlcnJlZCBoZWxwZXIKCXdoZW46IGZ1bmN0aW9uKCBzdWJvcmRpbmF0ZSAvKiAsIC4uLiwgc3Vib3JkaW5hdGVOICovICkgewoJCXZhciBpID0gMCwKCQkJcmVzb2x2ZVZhbHVlcyA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApLAoJCQlsZW5ndGggPSByZXNvbHZlVmFsdWVzLmxlbmd0aCwKCgkJCS8vIHRoZSBjb3VudCBvZiB1bmNvbXBsZXRlZCBzdWJvcmRpbmF0ZXMKCQkJcmVtYWluaW5nID0gbGVuZ3RoICE9PSAxIHx8ICggc3Vib3JkaW5hdGUgJiYgalF1ZXJ5LmlzRnVuY3Rpb24oIHN1Ym9yZGluYXRlLnByb21pc2UgKSApID8gbGVuZ3RoIDogMCwKCgkJCS8vIHRoZSBtYXN0ZXIgRGVmZXJyZWQuIElmIHJlc29sdmVWYWx1ZXMgY29uc2lzdCBvZiBvbmx5IGEgc2luZ2xlIERlZmVycmVkLCBqdXN0IHVzZSB0aGF0LgoJCQlkZWZlcnJlZCA9IHJlbWFpbmluZyA9PT0gMSA/IHN1Ym9yZGluYXRlIDogalF1ZXJ5LkRlZmVycmVkKCksCgoJCQkvLyBVcGRhdGUgZnVuY3Rpb24gZm9yIGJvdGggcmVzb2x2ZSBhbmQgcHJvZ3Jlc3MgdmFsdWVzCgkJCXVwZGF0ZUZ1bmMgPSBmdW5jdGlvbiggaSwgY29udGV4dHMsIHZhbHVlcyApIHsKCQkJCXJldHVybiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCQkJY29udGV4dHNbIGkgXSA9IHRoaXM7CgkJCQkJdmFsdWVzWyBpIF0gPSBhcmd1bWVudHMubGVuZ3RoID4gMSA/IHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApIDogdmFsdWU7CgkJCQkJaWYgKCB2YWx1ZXMgPT09IHByb2dyZXNzVmFsdWVzICkgewoJCQkJCQlkZWZlcnJlZC5ub3RpZnlXaXRoKCBjb250ZXh0cywgdmFsdWVzICk7CgoJCQkJCX0gZWxzZSBpZiAoICEoLS1yZW1haW5pbmcpICkgewoJCQkJCQlkZWZlcnJlZC5yZXNvbHZlV2l0aCggY29udGV4dHMsIHZhbHVlcyApOwoJCQkJCX0KCQkJCX07CgkJCX0sCgoJCQlwcm9ncmVzc1ZhbHVlcywgcHJvZ3Jlc3NDb250ZXh0cywgcmVzb2x2ZUNvbnRleHRzOwoKCQkvLyBhZGQgbGlzdGVuZXJzIHRvIERlZmVycmVkIHN1Ym9yZGluYXRlczsgdHJlYXQgb3RoZXJzIGFzIHJlc29sdmVkCgkJaWYgKCBsZW5ndGggPiAxICkgewoJCQlwcm9ncmVzc1ZhbHVlcyA9IG5ldyBBcnJheSggbGVuZ3RoICk7CgkJCXByb2dyZXNzQ29udGV4dHMgPSBuZXcgQXJyYXkoIGxlbmd0aCApOwoJCQlyZXNvbHZlQ29udGV4dHMgPSBuZXcgQXJyYXkoIGxlbmd0aCApOwoJCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJCWlmICggcmVzb2x2ZVZhbHVlc1sgaSBdICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCByZXNvbHZlVmFsdWVzWyBpIF0ucHJvbWlzZSApICkgewoJCQkJCXJlc29sdmVWYWx1ZXNbIGkgXS5wcm9taXNlKCkKCQkJCQkJLmRvbmUoIHVwZGF0ZUZ1bmMoIGksIHJlc29sdmVDb250ZXh0cywgcmVzb2x2ZVZhbHVlcyApICkKCQkJCQkJLmZhaWwoIGRlZmVycmVkLnJlamVjdCApCgkJCQkJCS5wcm9ncmVzcyggdXBkYXRlRnVuYyggaSwgcHJvZ3Jlc3NDb250ZXh0cywgcHJvZ3Jlc3NWYWx1ZXMgKSApOwoJCQkJfSBlbHNlIHsKCQkJCQktLXJlbWFpbmluZzsKCQkJCX0KCQkJfQoJCX0KCgkJLy8gaWYgd2UncmUgbm90IHdhaXRpbmcgb24gYW55dGhpbmcsIHJlc29sdmUgdGhlIG1hc3RlcgoJCWlmICggIXJlbWFpbmluZyApIHsKCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIHJlc29sdmVDb250ZXh0cywgcmVzb2x2ZVZhbHVlcyApOwoJCX0KCgkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCX0KfSk7CgoKLy8gVGhlIGRlZmVycmVkIHVzZWQgb24gRE9NIHJlYWR5CnZhciByZWFkeUxpc3Q7CgpqUXVlcnkuZm4ucmVhZHkgPSBmdW5jdGlvbiggZm4gKSB7CgkvLyBBZGQgdGhlIGNhbGxiYWNrCglqUXVlcnkucmVhZHkucHJvbWlzZSgpLmRvbmUoIGZuICk7CgoJcmV0dXJuIHRoaXM7Cn07CgpqUXVlcnkuZXh0ZW5kKHsKCS8vIElzIHRoZSBET00gcmVhZHkgdG8gYmUgdXNlZD8gU2V0IHRvIHRydWUgb25jZSBpdCBvY2N1cnMuCglpc1JlYWR5OiBmYWxzZSwKCgkvLyBBIGNvdW50ZXIgdG8gdHJhY2sgaG93IG1hbnkgaXRlbXMgdG8gd2FpdCBmb3IgYmVmb3JlCgkvLyB0aGUgcmVhZHkgZXZlbnQgZmlyZXMuIFNlZSAjNjc4MQoJcmVhZHlXYWl0OiAxLAoKCS8vIEhvbGQgKG9yIHJlbGVhc2UpIHRoZSByZWFkeSBldmVudAoJaG9sZFJlYWR5OiBmdW5jdGlvbiggaG9sZCApIHsKCQlpZiAoIGhvbGQgKSB7CgkJCWpRdWVyeS5yZWFkeVdhaXQrKzsKCQl9IGVsc2UgewoJCQlqUXVlcnkucmVhZHkoIHRydWUgKTsKCQl9Cgl9LAoKCS8vIEhhbmRsZSB3aGVuIHRoZSBET00gaXMgcmVhZHkKCXJlYWR5OiBmdW5jdGlvbiggd2FpdCApIHsKCgkJLy8gQWJvcnQgaWYgdGhlcmUgYXJlIHBlbmRpbmcgaG9sZHMgb3Igd2UncmUgYWxyZWFkeSByZWFkeQoJCWlmICggd2FpdCA9PT0gdHJ1ZSA/IC0talF1ZXJ5LnJlYWR5V2FpdCA6IGpRdWVyeS5pc1JlYWR5ICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBNYWtlIHN1cmUgYm9keSBleGlzdHMsIGF0IGxlYXN0LCBpbiBjYXNlIElFIGdldHMgYSBsaXR0bGUgb3ZlcnplYWxvdXMgKHRpY2tldCAjNTQ0MykuCgkJaWYgKCAhZG9jdW1lbnQuYm9keSApIHsKCQkJcmV0dXJuIHNldFRpbWVvdXQoIGpRdWVyeS5yZWFkeSApOwoJCX0KCgkJLy8gUmVtZW1iZXIgdGhhdCB0aGUgRE9NIGlzIHJlYWR5CgkJalF1ZXJ5LmlzUmVhZHkgPSB0cnVlOwoKCQkvLyBJZiBhIG5vcm1hbCBET00gUmVhZHkgZXZlbnQgZmlyZWQsIGRlY3JlbWVudCwgYW5kIHdhaXQgaWYgbmVlZCBiZQoJCWlmICggd2FpdCAhPT0gdHJ1ZSAmJiAtLWpRdWVyeS5yZWFkeVdhaXQgPiAwICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBJZiB0aGVyZSBhcmUgZnVuY3Rpb25zIGJvdW5kLCB0byBleGVjdXRlCgkJcmVhZHlMaXN0LnJlc29sdmVXaXRoKCBkb2N1bWVudCwgWyBqUXVlcnkgXSApOwoKCQkvLyBUcmlnZ2VyIGFueSBib3VuZCByZWFkeSBldmVudHMKCQlpZiAoIGpRdWVyeS5mbi50cmlnZ2VyICkgewoJCQlqUXVlcnkoIGRvY3VtZW50ICkudHJpZ2dlcigicmVhZHkiKS5vZmYoInJlYWR5Iik7CgkJfQoJfQp9KTsKCi8qKgogKiBDbGVhbi11cCBtZXRob2QgZm9yIGRvbSByZWFkeSBldmVudHMKICovCmZ1bmN0aW9uIGRldGFjaCgpIHsKCWlmICggZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciApIHsKCQlkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCAiRE9NQ29udGVudExvYWRlZCIsIGNvbXBsZXRlZCwgZmFsc2UgKTsKCQl3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lciggImxvYWQiLCBjb21wbGV0ZWQsIGZhbHNlICk7CgoJfSBlbHNlIHsKCQlkb2N1bWVudC5kZXRhY2hFdmVudCggIm9ucmVhZHlzdGF0ZWNoYW5nZSIsIGNvbXBsZXRlZCApOwoJCXdpbmRvdy5kZXRhY2hFdmVudCggIm9ubG9hZCIsIGNvbXBsZXRlZCApOwoJfQp9CgovKioKICogVGhlIHJlYWR5IGV2ZW50IGhhbmRsZXIgYW5kIHNlbGYgY2xlYW51cCBtZXRob2QKICovCmZ1bmN0aW9uIGNvbXBsZXRlZCgpIHsKCS8vIHJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIgaXMgZ29vZCBlbm91Z2ggZm9yIHVzIHRvIGNhbGwgdGhlIGRvbSByZWFkeSBpbiBvbGRJRQoJaWYgKCBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyIHx8IGV2ZW50LnR5cGUgPT09ICJsb2FkIiB8fCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiICkgewoJCWRldGFjaCgpOwoJCWpRdWVyeS5yZWFkeSgpOwoJfQp9CgpqUXVlcnkucmVhZHkucHJvbWlzZSA9IGZ1bmN0aW9uKCBvYmogKSB7CglpZiAoICFyZWFkeUxpc3QgKSB7CgoJCXJlYWR5TGlzdCA9IGpRdWVyeS5EZWZlcnJlZCgpOwoKCQkvLyBDYXRjaCBjYXNlcyB3aGVyZSAkKGRvY3VtZW50KS5yZWFkeSgpIGlzIGNhbGxlZCBhZnRlciB0aGUgYnJvd3NlciBldmVudCBoYXMgYWxyZWFkeSBvY2N1cnJlZC4KCQkvLyB3ZSBvbmNlIHRyaWVkIHRvIHVzZSByZWFkeVN0YXRlICJpbnRlcmFjdGl2ZSIgaGVyZSwgYnV0IGl0IGNhdXNlZCBpc3N1ZXMgbGlrZSB0aGUgb25lCgkJLy8gZGlzY292ZXJlZCBieSBDaHJpc1MgaGVyZTogaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTIyODIjY29tbWVudDoxNQoJCWlmICggZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiApIHsKCQkJLy8gSGFuZGxlIGl0IGFzeW5jaHJvbm91c2x5IHRvIGFsbG93IHNjcmlwdHMgdGhlIG9wcG9ydHVuaXR5IHRvIGRlbGF5IHJlYWR5CgkJCXNldFRpbWVvdXQoIGpRdWVyeS5yZWFkeSApOwoKCQkvLyBTdGFuZGFyZHMtYmFzZWQgYnJvd3NlcnMgc3VwcG9ydCBET01Db250ZW50TG9hZGVkCgkJfSBlbHNlIGlmICggZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciApIHsKCQkJLy8gVXNlIHRoZSBoYW5keSBldmVudCBjYWxsYmFjawoJCQlkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiRE9NQ29udGVudExvYWRlZCIsIGNvbXBsZXRlZCwgZmFsc2UgKTsKCgkJCS8vIEEgZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCwgdGhhdCB3aWxsIGFsd2F5cyB3b3JrCgkJCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCAibG9hZCIsIGNvbXBsZXRlZCwgZmFsc2UgKTsKCgkJLy8gSWYgSUUgZXZlbnQgbW9kZWwgaXMgdXNlZAoJCX0gZWxzZSB7CgkJCS8vIEVuc3VyZSBmaXJpbmcgYmVmb3JlIG9ubG9hZCwgbWF5YmUgbGF0ZSBidXQgc2FmZSBhbHNvIGZvciBpZnJhbWVzCgkJCWRvY3VtZW50LmF0dGFjaEV2ZW50KCAib25yZWFkeXN0YXRlY2hhbmdlIiwgY29tcGxldGVkICk7CgoJCQkvLyBBIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQsIHRoYXQgd2lsbCBhbHdheXMgd29yawoJCQl3aW5kb3cuYXR0YWNoRXZlbnQoICJvbmxvYWQiLCBjb21wbGV0ZWQgKTsKCgkJCS8vIElmIElFIGFuZCBub3QgYSBmcmFtZQoJCQkvLyBjb250aW51YWxseSBjaGVjayB0byBzZWUgaWYgdGhlIGRvY3VtZW50IGlzIHJlYWR5CgkJCXZhciB0b3AgPSBmYWxzZTsKCgkJCXRyeSB7CgkJCQl0b3AgPSB3aW5kb3cuZnJhbWVFbGVtZW50ID09IG51bGwgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoJCQl9IGNhdGNoKGUpIHt9CgoJCQlpZiAoIHRvcCAmJiB0b3AuZG9TY3JvbGwgKSB7CgkJCQkoZnVuY3Rpb24gZG9TY3JvbGxDaGVjaygpIHsKCQkJCQlpZiAoICFqUXVlcnkuaXNSZWFkeSApIHsKCgkJCQkJCXRyeSB7CgkJCQkJCQkvLyBVc2UgdGhlIHRyaWNrIGJ5IERpZWdvIFBlcmluaQoJCQkJCQkJLy8gaHR0cDovL2phdmFzY3JpcHQubndib3guY29tL0lFQ29udGVudExvYWRlZC8KCQkJCQkJCXRvcC5kb1Njcm9sbCgibGVmdCIpOwoJCQkJCQl9IGNhdGNoKGUpIHsKCQkJCQkJCXJldHVybiBzZXRUaW1lb3V0KCBkb1Njcm9sbENoZWNrLCA1MCApOwoJCQkJCQl9CgoJCQkJCQkvLyBkZXRhY2ggYWxsIGRvbSByZWFkeSBldmVudHMKCQkJCQkJZGV0YWNoKCk7CgoJCQkJCQkvLyBhbmQgZXhlY3V0ZSBhbnkgd2FpdGluZyBmdW5jdGlvbnMKCQkJCQkJalF1ZXJ5LnJlYWR5KCk7CgkJCQkJfQoJCQkJfSkoKTsKCQkJfQoJCX0KCX0KCXJldHVybiByZWFkeUxpc3QucHJvbWlzZSggb2JqICk7Cn07CgoKdmFyIHN0cnVuZGVmaW5lZCA9IHR5cGVvZiB1bmRlZmluZWQ7CgoKCi8vIFN1cHBvcnQ6IElFPDkKLy8gSXRlcmF0aW9uIG92ZXIgb2JqZWN0J3MgaW5oZXJpdGVkIHByb3BlcnRpZXMgYmVmb3JlIGl0cyBvd24KdmFyIGk7CmZvciAoIGkgaW4galF1ZXJ5KCBzdXBwb3J0ICkgKSB7CglicmVhazsKfQpzdXBwb3J0Lm93bkxhc3QgPSBpICE9PSAiMCI7CgovLyBOb3RlOiBtb3N0IHN1cHBvcnQgdGVzdHMgYXJlIGRlZmluZWQgaW4gdGhlaXIgcmVzcGVjdGl2ZSBtb2R1bGVzLgovLyBmYWxzZSB1bnRpbCB0aGUgdGVzdCBpcyBydW4Kc3VwcG9ydC5pbmxpbmVCbG9ja05lZWRzTGF5b3V0ID0gZmFsc2U7CgpqUXVlcnkoZnVuY3Rpb24oKSB7CgkvLyBXZSBuZWVkIHRvIGV4ZWN1dGUgdGhpcyBvbmUgc3VwcG9ydCB0ZXN0IEFTQVAgYmVjYXVzZSB3ZSBuZWVkIHRvIGtub3cKCS8vIGlmIGJvZHkuc3R5bGUuem9vbSBuZWVkcyB0byBiZSBzZXQuCgoJdmFyIGNvbnRhaW5lciwgZGl2LAoJCWJvZHkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYm9keSIpWzBdOwoKCWlmICggIWJvZHkgKSB7CgkJLy8gUmV0dXJuIGZvciBmcmFtZXNldCBkb2NzIHRoYXQgZG9uJ3QgaGF2ZSBhIGJvZHkKCQlyZXR1cm47Cgl9CgoJLy8gU2V0dXAKCWNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7Cgljb250YWluZXIuc3R5bGUuY3NzVGV4dCA9ICJib3JkZXI6MDt3aWR0aDowO2hlaWdodDowO3Bvc2l0aW9uOmFic29sdXRlO3RvcDowO2xlZnQ6LTk5OTlweDttYXJnaW4tdG9wOjFweCI7CgoJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCWJvZHkuYXBwZW5kQ2hpbGQoIGNvbnRhaW5lciApLmFwcGVuZENoaWxkKCBkaXYgKTsKCglpZiAoIHR5cGVvZiBkaXYuc3R5bGUuem9vbSAhPT0gc3RydW5kZWZpbmVkICkgewoJCS8vIFN1cHBvcnQ6IElFPDgKCQkvLyBDaGVjayBpZiBuYXRpdmVseSBibG9jay1sZXZlbCBlbGVtZW50cyBhY3QgbGlrZSBpbmxpbmUtYmxvY2sKCQkvLyBlbGVtZW50cyB3aGVuIHNldHRpbmcgdGhlaXIgZGlzcGxheSB0byAnaW5saW5lJyBhbmQgZ2l2aW5nCgkJLy8gdGhlbSBsYXlvdXQKCQlkaXYuc3R5bGUuY3NzVGV4dCA9ICJib3JkZXI6MDttYXJnaW46MDt3aWR0aDoxcHg7cGFkZGluZzoxcHg7ZGlzcGxheTppbmxpbmU7em9vbToxIjsKCgkJaWYgKCAoc3VwcG9ydC5pbmxpbmVCbG9ja05lZWRzTGF5b3V0ID0gKCBkaXYub2Zmc2V0V2lkdGggPT09IDMgKSkgKSB7CgkJCS8vIFByZXZlbnQgSUUgNiBmcm9tIGFmZmVjdGluZyBsYXlvdXQgZm9yIHBvc2l0aW9uZWQgZWxlbWVudHMgIzExMDQ4CgkJCS8vIFByZXZlbnQgSUUgZnJvbSBzaHJpbmtpbmcgdGhlIGJvZHkgaW4gSUUgNyBtb2RlICMxMjg2OQoJCQkvLyBTdXBwb3J0OiBJRTw4CgkJCWJvZHkuc3R5bGUuem9vbSA9IDE7CgkJfQoJfQoKCWJvZHkucmVtb3ZlQ2hpbGQoIGNvbnRhaW5lciApOwoKCS8vIE51bGwgZWxlbWVudHMgdG8gYXZvaWQgbGVha3MgaW4gSUUKCWNvbnRhaW5lciA9IGRpdiA9IG51bGw7Cn0pOwoKCgoKKGZ1bmN0aW9uKCkgewoJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgoJLy8gRXhlY3V0ZSB0aGUgdGVzdCBvbmx5IGlmIG5vdCBhbHJlYWR5IGV4ZWN1dGVkIGluIGFub3RoZXIgbW9kdWxlLgoJaWYgKHN1cHBvcnQuZGVsZXRlRXhwYW5kbyA9PSBudWxsKSB7CgkJLy8gU3VwcG9ydDogSUU8OQoJCXN1cHBvcnQuZGVsZXRlRXhwYW5kbyA9IHRydWU7CgkJdHJ5IHsKCQkJZGVsZXRlIGRpdi50ZXN0OwoJCX0gY2F0Y2goIGUgKSB7CgkJCXN1cHBvcnQuZGVsZXRlRXhwYW5kbyA9IGZhbHNlOwoJCX0KCX0KCgkvLyBOdWxsIGVsZW1lbnRzIHRvIGF2b2lkIGxlYWtzIGluIElFLgoJZGl2ID0gbnVsbDsKfSkoKTsKCgovKioKICogRGV0ZXJtaW5lcyB3aGV0aGVyIGFuIG9iamVjdCBjYW4gaGF2ZSBkYXRhCiAqLwpqUXVlcnkuYWNjZXB0RGF0YSA9IGZ1bmN0aW9uKCBlbGVtICkgewoJdmFyIG5vRGF0YSA9IGpRdWVyeS5ub0RhdGFbIChlbGVtLm5vZGVOYW1lICsgIiAiKS50b0xvd2VyQ2FzZSgpIF0sCgkJbm9kZVR5cGUgPSArZWxlbS5ub2RlVHlwZSB8fCAxOwoKCS8vIERvIG5vdCBzZXQgZGF0YSBvbiBub24tZWxlbWVudCBET00gbm9kZXMgYmVjYXVzZSBpdCB3aWxsIG5vdCBiZSBjbGVhcmVkICgjODMzNSkuCglyZXR1cm4gbm9kZVR5cGUgIT09IDEgJiYgbm9kZVR5cGUgIT09IDkgPwoJCWZhbHNlIDoKCgkJLy8gTm9kZXMgYWNjZXB0IGRhdGEgdW5sZXNzIG90aGVyd2lzZSBzcGVjaWZpZWQ7IHJlamVjdGlvbiBjYW4gYmUgY29uZGl0aW9uYWwKCQkhbm9EYXRhIHx8IG5vRGF0YSAhPT0gdHJ1ZSAmJiBlbGVtLmdldEF0dHJpYnV0ZSgiY2xhc3NpZCIpID09PSBub0RhdGE7Cn07CgoKdmFyIHJicmFjZSA9IC9eKD86XHtbXHdcV10qXH18XFtbXHdcV10qXF0pJC8sCglybXVsdGlEYXNoID0gLyhbQS1aXSkvZzsKCmZ1bmN0aW9uIGRhdGFBdHRyKCBlbGVtLCBrZXksIGRhdGEgKSB7CgkvLyBJZiBub3RoaW5nIHdhcyBmb3VuZCBpbnRlcm5hbGx5LCB0cnkgdG8gZmV0Y2ggYW55CgkvLyBkYXRhIGZyb20gdGhlIEhUTUw1IGRhdGEtKiBhdHRyaWJ1dGUKCWlmICggZGF0YSA9PT0gdW5kZWZpbmVkICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgoJCXZhciBuYW1lID0gImRhdGEtIiArIGtleS5yZXBsYWNlKCBybXVsdGlEYXNoLCAiLSQxIiApLnRvTG93ZXJDYXNlKCk7CgoJCWRhdGEgPSBlbGVtLmdldEF0dHJpYnV0ZSggbmFtZSApOwoKCQlpZiAoIHR5cGVvZiBkYXRhID09PSAic3RyaW5nIiApIHsKCQkJdHJ5IHsKCQkJCWRhdGEgPSBkYXRhID09PSAidHJ1ZSIgPyB0cnVlIDoKCQkJCQlkYXRhID09PSAiZmFsc2UiID8gZmFsc2UgOgoJCQkJCWRhdGEgPT09ICJudWxsIiA/IG51bGwgOgoJCQkJCS8vIE9ubHkgY29udmVydCB0byBhIG51bWJlciBpZiBpdCBkb2Vzbid0IGNoYW5nZSB0aGUgc3RyaW5nCgkJCQkJK2RhdGEgKyAiIiA9PT0gZGF0YSA/ICtkYXRhIDoKCQkJCQlyYnJhY2UudGVzdCggZGF0YSApID8galF1ZXJ5LnBhcnNlSlNPTiggZGF0YSApIDoKCQkJCQlkYXRhOwoJCQl9IGNhdGNoKCBlICkge30KCgkJCS8vIE1ha2Ugc3VyZSB3ZSBzZXQgdGhlIGRhdGEgc28gaXQgaXNuJ3QgY2hhbmdlZCBsYXRlcgoJCQlqUXVlcnkuZGF0YSggZWxlbSwga2V5LCBkYXRhICk7CgoJCX0gZWxzZSB7CgkJCWRhdGEgPSB1bmRlZmluZWQ7CgkJfQoJfQoKCXJldHVybiBkYXRhOwp9CgovLyBjaGVja3MgYSBjYWNoZSBvYmplY3QgZm9yIGVtcHRpbmVzcwpmdW5jdGlvbiBpc0VtcHR5RGF0YU9iamVjdCggb2JqICkgewoJdmFyIG5hbWU7Cglmb3IgKCBuYW1lIGluIG9iaiApIHsKCgkJLy8gaWYgdGhlIHB1YmxpYyBkYXRhIG9iamVjdCBpcyBlbXB0eSwgdGhlIHByaXZhdGUgaXMgc3RpbGwgZW1wdHkKCQlpZiAoIG5hbWUgPT09ICJkYXRhIiAmJiBqUXVlcnkuaXNFbXB0eU9iamVjdCggb2JqW25hbWVdICkgKSB7CgkJCWNvbnRpbnVlOwoJCX0KCQlpZiAoIG5hbWUgIT09ICJ0b0pTT04iICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfQoKCXJldHVybiB0cnVlOwp9CgpmdW5jdGlvbiBpbnRlcm5hbERhdGEoIGVsZW0sIG5hbWUsIGRhdGEsIHB2dCAvKiBJbnRlcm5hbCBVc2UgT25seSAqLyApIHsKCWlmICggIWpRdWVyeS5hY2NlcHREYXRhKCBlbGVtICkgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciByZXQsIHRoaXNDYWNoZSwKCQlpbnRlcm5hbEtleSA9IGpRdWVyeS5leHBhbmRvLAoKCQkvLyBXZSBoYXZlIHRvIGhhbmRsZSBET00gbm9kZXMgYW5kIEpTIG9iamVjdHMgZGlmZmVyZW50bHkgYmVjYXVzZSBJRTYtNwoJCS8vIGNhbid0IEdDIG9iamVjdCByZWZlcmVuY2VzIHByb3Blcmx5IGFjcm9zcyB0aGUgRE9NLUpTIGJvdW5kYXJ5CgkJaXNOb2RlID0gZWxlbS5ub2RlVHlwZSwKCgkJLy8gT25seSBET00gbm9kZXMgbmVlZCB0aGUgZ2xvYmFsIGpRdWVyeSBjYWNoZTsgSlMgb2JqZWN0IGRhdGEgaXMKCQkvLyBhdHRhY2hlZCBkaXJlY3RseSB0byB0aGUgb2JqZWN0IHNvIEdDIGNhbiBvY2N1ciBhdXRvbWF0aWNhbGx5CgkJY2FjaGUgPSBpc05vZGUgPyBqUXVlcnkuY2FjaGUgOiBlbGVtLAoKCQkvLyBPbmx5IGRlZmluaW5nIGFuIElEIGZvciBKUyBvYmplY3RzIGlmIGl0cyBjYWNoZSBhbHJlYWR5IGV4aXN0cyBhbGxvd3MKCQkvLyB0aGUgY29kZSB0byBzaG9ydGN1dCBvbiB0aGUgc2FtZSBwYXRoIGFzIGEgRE9NIG5vZGUgd2l0aCBubyBjYWNoZQoJCWlkID0gaXNOb2RlID8gZWxlbVsgaW50ZXJuYWxLZXkgXSA6IGVsZW1bIGludGVybmFsS2V5IF0gJiYgaW50ZXJuYWxLZXk7CgoJLy8gQXZvaWQgZG9pbmcgYW55IG1vcmUgd29yayB0aGFuIHdlIG5lZWQgdG8gd2hlbiB0cnlpbmcgdG8gZ2V0IGRhdGEgb24gYW4KCS8vIG9iamVjdCB0aGF0IGhhcyBubyBkYXRhIGF0IGFsbAoJaWYgKCAoIWlkIHx8ICFjYWNoZVtpZF0gfHwgKCFwdnQgJiYgIWNhY2hlW2lkXS5kYXRhKSkgJiYgZGF0YSA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiBuYW1lID09PSAic3RyaW5nIiApIHsKCQlyZXR1cm47Cgl9CgoJaWYgKCAhaWQgKSB7CgkJLy8gT25seSBET00gbm9kZXMgbmVlZCBhIG5ldyB1bmlxdWUgSUQgZm9yIGVhY2ggZWxlbWVudCBzaW5jZSB0aGVpciBkYXRhCgkJLy8gZW5kcyB1cCBpbiB0aGUgZ2xvYmFsIGNhY2hlCgkJaWYgKCBpc05vZGUgKSB7CgkJCWlkID0gZWxlbVsgaW50ZXJuYWxLZXkgXSA9IGRlbGV0ZWRJZHMucG9wKCkgfHwgalF1ZXJ5Lmd1aWQrKzsKCQl9IGVsc2UgewoJCQlpZCA9IGludGVybmFsS2V5OwoJCX0KCX0KCglpZiAoICFjYWNoZVsgaWQgXSApIHsKCQkvLyBBdm9pZCBleHBvc2luZyBqUXVlcnkgbWV0YWRhdGEgb24gcGxhaW4gSlMgb2JqZWN0cyB3aGVuIHRoZSBvYmplY3QKCQkvLyBpcyBzZXJpYWxpemVkIHVzaW5nIEpTT04uc3RyaW5naWZ5CgkJY2FjaGVbIGlkIF0gPSBpc05vZGUgPyB7fSA6IHsgdG9KU09OOiBqUXVlcnkubm9vcCB9OwoJfQoKCS8vIEFuIG9iamVjdCBjYW4gYmUgcGFzc2VkIHRvIGpRdWVyeS5kYXRhIGluc3RlYWQgb2YgYSBrZXkvdmFsdWUgcGFpcjsgdGhpcyBnZXRzCgkvLyBzaGFsbG93IGNvcGllZCBvdmVyIG9udG8gdGhlIGV4aXN0aW5nIGNhY2hlCglpZiAoIHR5cGVvZiBuYW1lID09PSAib2JqZWN0IiB8fCB0eXBlb2YgbmFtZSA9PT0gImZ1bmN0aW9uIiApIHsKCQlpZiAoIHB2dCApIHsKCQkJY2FjaGVbIGlkIF0gPSBqUXVlcnkuZXh0ZW5kKCBjYWNoZVsgaWQgXSwgbmFtZSApOwoJCX0gZWxzZSB7CgkJCWNhY2hlWyBpZCBdLmRhdGEgPSBqUXVlcnkuZXh0ZW5kKCBjYWNoZVsgaWQgXS5kYXRhLCBuYW1lICk7CgkJfQoJfQoKCXRoaXNDYWNoZSA9IGNhY2hlWyBpZCBdOwoKCS8vIGpRdWVyeSBkYXRhKCkgaXMgc3RvcmVkIGluIGEgc2VwYXJhdGUgb2JqZWN0IGluc2lkZSB0aGUgb2JqZWN0J3MgaW50ZXJuYWwgZGF0YQoJLy8gY2FjaGUgaW4gb3JkZXIgdG8gYXZvaWQga2V5IGNvbGxpc2lvbnMgYmV0d2VlbiBpbnRlcm5hbCBkYXRhIGFuZCB1c2VyLWRlZmluZWQKCS8vIGRhdGEuCglpZiAoICFwdnQgKSB7CgkJaWYgKCAhdGhpc0NhY2hlLmRhdGEgKSB7CgkJCXRoaXNDYWNoZS5kYXRhID0ge307CgkJfQoKCQl0aGlzQ2FjaGUgPSB0aGlzQ2FjaGUuZGF0YTsKCX0KCglpZiAoIGRhdGEgIT09IHVuZGVmaW5lZCApIHsKCQl0aGlzQ2FjaGVbIGpRdWVyeS5jYW1lbENhc2UoIG5hbWUgKSBdID0gZGF0YTsKCX0KCgkvLyBDaGVjayBmb3IgYm90aCBjb252ZXJ0ZWQtdG8tY2FtZWwgYW5kIG5vbi1jb252ZXJ0ZWQgZGF0YSBwcm9wZXJ0eSBuYW1lcwoJLy8gSWYgYSBkYXRhIHByb3BlcnR5IHdhcyBzcGVjaWZpZWQKCWlmICggdHlwZW9mIG5hbWUgPT09ICJzdHJpbmciICkgewoKCQkvLyBGaXJzdCBUcnkgdG8gZmluZCBhcy1pcyBwcm9wZXJ0eSBkYXRhCgkJcmV0ID0gdGhpc0NhY2hlWyBuYW1lIF07CgoJCS8vIFRlc3QgZm9yIG51bGx8dW5kZWZpbmVkIHByb3BlcnR5IGRhdGEKCQlpZiAoIHJldCA9PSBudWxsICkgewoKCQkJLy8gVHJ5IHRvIGZpbmQgdGhlIGNhbWVsQ2FzZWQgcHJvcGVydHkKCQkJcmV0ID0gdGhpc0NhY2hlWyBqUXVlcnkuY2FtZWxDYXNlKCBuYW1lICkgXTsKCQl9Cgl9IGVsc2UgewoJCXJldCA9IHRoaXNDYWNoZTsKCX0KCglyZXR1cm4gcmV0Owp9CgpmdW5jdGlvbiBpbnRlcm5hbFJlbW92ZURhdGEoIGVsZW0sIG5hbWUsIHB2dCApIHsKCWlmICggIWpRdWVyeS5hY2NlcHREYXRhKCBlbGVtICkgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciB0aGlzQ2FjaGUsIGksCgkJaXNOb2RlID0gZWxlbS5ub2RlVHlwZSwKCgkJLy8gU2VlIGpRdWVyeS5kYXRhIGZvciBtb3JlIGluZm9ybWF0aW9uCgkJY2FjaGUgPSBpc05vZGUgPyBqUXVlcnkuY2FjaGUgOiBlbGVtLAoJCWlkID0gaXNOb2RlID8gZWxlbVsgalF1ZXJ5LmV4cGFuZG8gXSA6IGpRdWVyeS5leHBhbmRvOwoKCS8vIElmIHRoZXJlIGlzIGFscmVhZHkgbm8gY2FjaGUgZW50cnkgZm9yIHRoaXMgb2JqZWN0LCB0aGVyZSBpcyBubwoJLy8gcHVycG9zZSBpbiBjb250aW51aW5nCglpZiAoICFjYWNoZVsgaWQgXSApIHsKCQlyZXR1cm47Cgl9CgoJaWYgKCBuYW1lICkgewoKCQl0aGlzQ2FjaGUgPSBwdnQgPyBjYWNoZVsgaWQgXSA6IGNhY2hlWyBpZCBdLmRhdGE7CgoJCWlmICggdGhpc0NhY2hlICkgewoKCQkJLy8gU3VwcG9ydCBhcnJheSBvciBzcGFjZSBzZXBhcmF0ZWQgc3RyaW5nIG5hbWVzIGZvciBkYXRhIGtleXMKCQkJaWYgKCAhalF1ZXJ5LmlzQXJyYXkoIG5hbWUgKSApIHsKCgkJCQkvLyB0cnkgdGhlIHN0cmluZyBhcyBhIGtleSBiZWZvcmUgYW55IG1hbmlwdWxhdGlvbgoJCQkJaWYgKCBuYW1lIGluIHRoaXNDYWNoZSApIHsKCQkJCQluYW1lID0gWyBuYW1lIF07CgkJCQl9IGVsc2UgewoKCQkJCQkvLyBzcGxpdCB0aGUgY2FtZWwgY2FzZWQgdmVyc2lvbiBieSBzcGFjZXMgdW5sZXNzIGEga2V5IHdpdGggdGhlIHNwYWNlcyBleGlzdHMKCQkJCQluYW1lID0galF1ZXJ5LmNhbWVsQ2FzZSggbmFtZSApOwoJCQkJCWlmICggbmFtZSBpbiB0aGlzQ2FjaGUgKSB7CgkJCQkJCW5hbWUgPSBbIG5hbWUgXTsKCQkJCQl9IGVsc2UgewoJCQkJCQluYW1lID0gbmFtZS5zcGxpdCgiICIpOwoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIHsKCQkJCS8vIElmICJuYW1lIiBpcyBhbiBhcnJheSBvZiBrZXlzLi4uCgkJCQkvLyBXaGVuIGRhdGEgaXMgaW5pdGlhbGx5IGNyZWF0ZWQsIHZpYSAoImtleSIsICJ2YWwiKSBzaWduYXR1cmUsCgkJCQkvLyBrZXlzIHdpbGwgYmUgY29udmVydGVkIHRvIGNhbWVsQ2FzZS4KCQkJCS8vIFNpbmNlIHRoZXJlIGlzIG5vIHdheSB0byB0ZWxsIF9ob3dfIGEga2V5IHdhcyBhZGRlZCwgcmVtb3ZlCgkJCQkvLyBib3RoIHBsYWluIGtleSBhbmQgY2FtZWxDYXNlIGtleS4gIzEyNzg2CgkJCQkvLyBUaGlzIHdpbGwgb25seSBwZW5hbGl6ZSB0aGUgYXJyYXkgYXJndW1lbnQgcGF0aC4KCQkJCW5hbWUgPSBuYW1lLmNvbmNhdCggalF1ZXJ5Lm1hcCggbmFtZSwgalF1ZXJ5LmNhbWVsQ2FzZSApICk7CgkJCX0KCgkJCWkgPSBuYW1lLmxlbmd0aDsKCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQlkZWxldGUgdGhpc0NhY2hlWyBuYW1lW2ldIF07CgkJCX0KCgkJCS8vIElmIHRoZXJlIGlzIG5vIGRhdGEgbGVmdCBpbiB0aGUgY2FjaGUsIHdlIHdhbnQgdG8gY29udGludWUKCQkJLy8gYW5kIGxldCB0aGUgY2FjaGUgb2JqZWN0IGl0c2VsZiBnZXQgZGVzdHJveWVkCgkJCWlmICggcHZ0ID8gIWlzRW1wdHlEYXRhT2JqZWN0KHRoaXNDYWNoZSkgOiAhalF1ZXJ5LmlzRW1wdHlPYmplY3QodGhpc0NhY2hlKSApIHsKCQkJCXJldHVybjsKCQkJfQoJCX0KCX0KCgkvLyBTZWUgalF1ZXJ5LmRhdGEgZm9yIG1vcmUgaW5mb3JtYXRpb24KCWlmICggIXB2dCApIHsKCQlkZWxldGUgY2FjaGVbIGlkIF0uZGF0YTsKCgkJLy8gRG9uJ3QgZGVzdHJveSB0aGUgcGFyZW50IGNhY2hlIHVubGVzcyB0aGUgaW50ZXJuYWwgZGF0YSBvYmplY3QKCQkvLyBoYWQgYmVlbiB0aGUgb25seSB0aGluZyBsZWZ0IGluIGl0CgkJaWYgKCAhaXNFbXB0eURhdGFPYmplY3QoIGNhY2hlWyBpZCBdICkgKSB7CgkJCXJldHVybjsKCQl9Cgl9CgoJLy8gRGVzdHJveSB0aGUgY2FjaGUKCWlmICggaXNOb2RlICkgewoJCWpRdWVyeS5jbGVhbkRhdGEoIFsgZWxlbSBdLCB0cnVlICk7CgoJLy8gVXNlIGRlbGV0ZSB3aGVuIHN1cHBvcnRlZCBmb3IgZXhwYW5kb3Mgb3IgYGNhY2hlYCBpcyBub3QgYSB3aW5kb3cgcGVyIGlzV2luZG93ICgjMTAwODApCgkvKiBqc2hpbnQgZXFlcWVxOiBmYWxzZSAqLwoJfSBlbHNlIGlmICggc3VwcG9ydC5kZWxldGVFeHBhbmRvIHx8IGNhY2hlICE9IGNhY2hlLndpbmRvdyApIHsKCQkvKiBqc2hpbnQgZXFlcWVxOiB0cnVlICovCgkJZGVsZXRlIGNhY2hlWyBpZCBdOwoKCS8vIFdoZW4gYWxsIGVsc2UgZmFpbHMsIG51bGwKCX0gZWxzZSB7CgkJY2FjaGVbIGlkIF0gPSBudWxsOwoJfQp9CgpqUXVlcnkuZXh0ZW5kKHsKCWNhY2hlOiB7fSwKCgkvLyBUaGUgZm9sbG93aW5nIGVsZW1lbnRzIChzcGFjZS1zdWZmaXhlZCB0byBhdm9pZCBPYmplY3QucHJvdG90eXBlIGNvbGxpc2lvbnMpCgkvLyB0aHJvdyB1bmNhdGNoYWJsZSBleGNlcHRpb25zIGlmIHlvdSBhdHRlbXB0IHRvIHNldCBleHBhbmRvIHByb3BlcnRpZXMKCW5vRGF0YTogewoJCSJhcHBsZXQgIjogdHJ1ZSwKCQkiZW1iZWQgIjogdHJ1ZSwKCQkvLyAuLi5idXQgRmxhc2ggb2JqZWN0cyAod2hpY2ggaGF2ZSB0aGlzIGNsYXNzaWQpICpjYW4qIGhhbmRsZSBleHBhbmRvcwoJCSJvYmplY3QgIjogImNsc2lkOkQyN0NEQjZFLUFFNkQtMTFjZi05NkI4LTQ0NDU1MzU0MDAwMCIKCX0sCgoJaGFzRGF0YTogZnVuY3Rpb24oIGVsZW0gKSB7CgkJZWxlbSA9IGVsZW0ubm9kZVR5cGUgPyBqUXVlcnkuY2FjaGVbIGVsZW1balF1ZXJ5LmV4cGFuZG9dIF0gOiBlbGVtWyBqUXVlcnkuZXhwYW5kbyBdOwoJCXJldHVybiAhIWVsZW0gJiYgIWlzRW1wdHlEYXRhT2JqZWN0KCBlbGVtICk7Cgl9LAoKCWRhdGE6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBkYXRhICkgewoJCXJldHVybiBpbnRlcm5hbERhdGEoIGVsZW0sIG5hbWUsIGRhdGEgKTsKCX0sCgoJcmVtb3ZlRGF0YTogZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7CgkJcmV0dXJuIGludGVybmFsUmVtb3ZlRGF0YSggZWxlbSwgbmFtZSApOwoJfSwKCgkvLyBGb3IgaW50ZXJuYWwgdXNlIG9ubHkuCglfZGF0YTogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGRhdGEgKSB7CgkJcmV0dXJuIGludGVybmFsRGF0YSggZWxlbSwgbmFtZSwgZGF0YSwgdHJ1ZSApOwoJfSwKCglfcmVtb3ZlRGF0YTogZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7CgkJcmV0dXJuIGludGVybmFsUmVtb3ZlRGF0YSggZWxlbSwgbmFtZSwgdHJ1ZSApOwoJfQp9KTsKCmpRdWVyeS5mbi5leHRlbmQoewoJZGF0YTogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIGksIG5hbWUsIGRhdGEsCgkJCWVsZW0gPSB0aGlzWzBdLAoJCQlhdHRycyA9IGVsZW0gJiYgZWxlbS5hdHRyaWJ1dGVzOwoKCQkvLyBTcGVjaWFsIGV4cGVjdGlvbnMgb2YgLmRhdGEgYmFzaWNhbGx5IHRod2FydCBqUXVlcnkuYWNjZXNzLAoJCS8vIHNvIGltcGxlbWVudCB0aGUgcmVsZXZhbnQgYmVoYXZpb3Igb3Vyc2VsdmVzCgoJCS8vIEdldHMgYWxsIHZhbHVlcwoJCWlmICgga2V5ID09PSB1bmRlZmluZWQgKSB7CgkJCWlmICggdGhpcy5sZW5ndGggKSB7CgkJCQlkYXRhID0galF1ZXJ5LmRhdGEoIGVsZW0gKTsKCgkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgIWpRdWVyeS5fZGF0YSggZWxlbSwgInBhcnNlZEF0dHJzIiApICkgewoJCQkJCWkgPSBhdHRycy5sZW5ndGg7CgkJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJCW5hbWUgPSBhdHRyc1tpXS5uYW1lOwoKCQkJCQkJaWYgKCBuYW1lLmluZGV4T2YoImRhdGEtIikgPT09IDAgKSB7CgkJCQkJCQluYW1lID0galF1ZXJ5LmNhbWVsQ2FzZSggbmFtZS5zbGljZSg1KSApOwoKCQkJCQkJCWRhdGFBdHRyKCBlbGVtLCBuYW1lLCBkYXRhWyBuYW1lIF0gKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQlqUXVlcnkuX2RhdGEoIGVsZW0sICJwYXJzZWRBdHRycyIsIHRydWUgKTsKCQkJCX0KCQkJfQoKCQkJcmV0dXJuIGRhdGE7CgkJfQoKCQkvLyBTZXRzIG11bHRpcGxlIHZhbHVlcwoJCWlmICggdHlwZW9mIGtleSA9PT0gIm9iamVjdCIgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQlqUXVlcnkuZGF0YSggdGhpcywga2V5ICk7CgkJCX0pOwoJCX0KCgkJcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPiAxID8KCgkJCS8vIFNldHMgb25lIHZhbHVlCgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCWpRdWVyeS5kYXRhKCB0aGlzLCBrZXksIHZhbHVlICk7CgkJCX0pIDoKCgkJCS8vIEdldHMgb25lIHZhbHVlCgkJCS8vIFRyeSB0byBmZXRjaCBhbnkgaW50ZXJuYWxseSBzdG9yZWQgZGF0YSBmaXJzdAoJCQllbGVtID8gZGF0YUF0dHIoIGVsZW0sIGtleSwgalF1ZXJ5LmRhdGEoIGVsZW0sIGtleSApICkgOiB1bmRlZmluZWQ7Cgl9LAoKCXJlbW92ZURhdGE6IGZ1bmN0aW9uKCBrZXkgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LnJlbW92ZURhdGEoIHRoaXMsIGtleSApOwoJCX0pOwoJfQp9KTsKCgpqUXVlcnkuZXh0ZW5kKHsKCXF1ZXVlOiBmdW5jdGlvbiggZWxlbSwgdHlwZSwgZGF0YSApIHsKCQl2YXIgcXVldWU7CgoJCWlmICggZWxlbSApIHsKCQkJdHlwZSA9ICggdHlwZSB8fCAiZngiICkgKyAicXVldWUiOwoJCQlxdWV1ZSA9IGpRdWVyeS5fZGF0YSggZWxlbSwgdHlwZSApOwoKCQkJLy8gU3BlZWQgdXAgZGVxdWV1ZSBieSBnZXR0aW5nIG91dCBxdWlja2x5IGlmIHRoaXMgaXMganVzdCBhIGxvb2t1cAoJCQlpZiAoIGRhdGEgKSB7CgkJCQlpZiAoICFxdWV1ZSB8fCBqUXVlcnkuaXNBcnJheShkYXRhKSApIHsKCQkJCQlxdWV1ZSA9IGpRdWVyeS5fZGF0YSggZWxlbSwgdHlwZSwgalF1ZXJ5Lm1ha2VBcnJheShkYXRhKSApOwoJCQkJfSBlbHNlIHsKCQkJCQlxdWV1ZS5wdXNoKCBkYXRhICk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHF1ZXVlIHx8IFtdOwoJCX0KCX0sCgoJZGVxdWV1ZTogZnVuY3Rpb24oIGVsZW0sIHR5cGUgKSB7CgkJdHlwZSA9IHR5cGUgfHwgImZ4IjsKCgkJdmFyIHF1ZXVlID0galF1ZXJ5LnF1ZXVlKCBlbGVtLCB0eXBlICksCgkJCXN0YXJ0TGVuZ3RoID0gcXVldWUubGVuZ3RoLAoJCQlmbiA9IHF1ZXVlLnNoaWZ0KCksCgkJCWhvb2tzID0galF1ZXJ5Ll9xdWV1ZUhvb2tzKCBlbGVtLCB0eXBlICksCgkJCW5leHQgPSBmdW5jdGlvbigpIHsKCQkJCWpRdWVyeS5kZXF1ZXVlKCBlbGVtLCB0eXBlICk7CgkJCX07CgoJCS8vIElmIHRoZSBmeCBxdWV1ZSBpcyBkZXF1ZXVlZCwgYWx3YXlzIHJlbW92ZSB0aGUgcHJvZ3Jlc3Mgc2VudGluZWwKCQlpZiAoIGZuID09PSAiaW5wcm9ncmVzcyIgKSB7CgkJCWZuID0gcXVldWUuc2hpZnQoKTsKCQkJc3RhcnRMZW5ndGgtLTsKCQl9CgoJCWlmICggZm4gKSB7CgoJCQkvLyBBZGQgYSBwcm9ncmVzcyBzZW50aW5lbCB0byBwcmV2ZW50IHRoZSBmeCBxdWV1ZSBmcm9tIGJlaW5nCgkJCS8vIGF1dG9tYXRpY2FsbHkgZGVxdWV1ZWQKCQkJaWYgKCB0eXBlID09PSAiZngiICkgewoJCQkJcXVldWUudW5zaGlmdCggImlucHJvZ3Jlc3MiICk7CgkJCX0KCgkJCS8vIGNsZWFyIHVwIHRoZSBsYXN0IHF1ZXVlIHN0b3AgZnVuY3Rpb24KCQkJZGVsZXRlIGhvb2tzLnN0b3A7CgkJCWZuLmNhbGwoIGVsZW0sIG5leHQsIGhvb2tzICk7CgkJfQoKCQlpZiAoICFzdGFydExlbmd0aCAmJiBob29rcyApIHsKCQkJaG9va3MuZW1wdHkuZmlyZSgpOwoJCX0KCX0sCgoJLy8gbm90IGludGVuZGVkIGZvciBwdWJsaWMgY29uc3VtcHRpb24gLSBnZW5lcmF0ZXMgYSBxdWV1ZUhvb2tzIG9iamVjdCwgb3IgcmV0dXJucyB0aGUgY3VycmVudCBvbmUKCV9xdWV1ZUhvb2tzOiBmdW5jdGlvbiggZWxlbSwgdHlwZSApIHsKCQl2YXIga2V5ID0gdHlwZSArICJxdWV1ZUhvb2tzIjsKCQlyZXR1cm4galF1ZXJ5Ll9kYXRhKCBlbGVtLCBrZXkgKSB8fCBqUXVlcnkuX2RhdGEoIGVsZW0sIGtleSwgewoJCQllbXB0eTogalF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKS5hZGQoZnVuY3Rpb24oKSB7CgkJCQlqUXVlcnkuX3JlbW92ZURhdGEoIGVsZW0sIHR5cGUgKyAicXVldWUiICk7CgkJCQlqUXVlcnkuX3JlbW92ZURhdGEoIGVsZW0sIGtleSApOwoJCQl9KQoJCX0pOwoJfQp9KTsKCmpRdWVyeS5mbi5leHRlbmQoewoJcXVldWU6IGZ1bmN0aW9uKCB0eXBlLCBkYXRhICkgewoJCXZhciBzZXR0ZXIgPSAyOwoKCQlpZiAoIHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIiApIHsKCQkJZGF0YSA9IHR5cGU7CgkJCXR5cGUgPSAiZngiOwoJCQlzZXR0ZXItLTsKCQl9CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA8IHNldHRlciApIHsKCQkJcmV0dXJuIGpRdWVyeS5xdWV1ZSggdGhpc1swXSwgdHlwZSApOwoJCX0KCgkJcmV0dXJuIGRhdGEgPT09IHVuZGVmaW5lZCA/CgkJCXRoaXMgOgoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgcXVldWUgPSBqUXVlcnkucXVldWUoIHRoaXMsIHR5cGUsIGRhdGEgKTsKCgkJCQkvLyBlbnN1cmUgYSBob29rcyBmb3IgdGhpcyBxdWV1ZQoJCQkJalF1ZXJ5Ll9xdWV1ZUhvb2tzKCB0aGlzLCB0eXBlICk7CgoJCQkJaWYgKCB0eXBlID09PSAiZngiICYmIHF1ZXVlWzBdICE9PSAiaW5wcm9ncmVzcyIgKSB7CgkJCQkJalF1ZXJ5LmRlcXVldWUoIHRoaXMsIHR5cGUgKTsKCQkJCX0KCQkJfSk7Cgl9LAoJZGVxdWV1ZTogZnVuY3Rpb24oIHR5cGUgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LmRlcXVldWUoIHRoaXMsIHR5cGUgKTsKCQl9KTsKCX0sCgljbGVhclF1ZXVlOiBmdW5jdGlvbiggdHlwZSApIHsKCQlyZXR1cm4gdGhpcy5xdWV1ZSggdHlwZSB8fCAiZngiLCBbXSApOwoJfSwKCS8vIEdldCBhIHByb21pc2UgcmVzb2x2ZWQgd2hlbiBxdWV1ZXMgb2YgYSBjZXJ0YWluIHR5cGUKCS8vIGFyZSBlbXB0aWVkIChmeCBpcyB0aGUgdHlwZSBieSBkZWZhdWx0KQoJcHJvbWlzZTogZnVuY3Rpb24oIHR5cGUsIG9iaiApIHsKCQl2YXIgdG1wLAoJCQljb3VudCA9IDEsCgkJCWRlZmVyID0galF1ZXJ5LkRlZmVycmVkKCksCgkJCWVsZW1lbnRzID0gdGhpcywKCQkJaSA9IHRoaXMubGVuZ3RoLAoJCQlyZXNvbHZlID0gZnVuY3Rpb24oKSB7CgkJCQlpZiAoICEoIC0tY291bnQgKSApIHsKCQkJCQlkZWZlci5yZXNvbHZlV2l0aCggZWxlbWVudHMsIFsgZWxlbWVudHMgXSApOwoJCQkJfQoJCQl9OwoKCQlpZiAoIHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIiApIHsKCQkJb2JqID0gdHlwZTsKCQkJdHlwZSA9IHVuZGVmaW5lZDsKCQl9CgkJdHlwZSA9IHR5cGUgfHwgImZ4IjsKCgkJd2hpbGUgKCBpLS0gKSB7CgkJCXRtcCA9IGpRdWVyeS5fZGF0YSggZWxlbWVudHNbIGkgXSwgdHlwZSArICJxdWV1ZUhvb2tzIiApOwoJCQlpZiAoIHRtcCAmJiB0bXAuZW1wdHkgKSB7CgkJCQljb3VudCsrOwoJCQkJdG1wLmVtcHR5LmFkZCggcmVzb2x2ZSApOwoJCQl9CgkJfQoJCXJlc29sdmUoKTsKCQlyZXR1cm4gZGVmZXIucHJvbWlzZSggb2JqICk7Cgl9Cn0pOwp2YXIgcG51bSA9ICgvWystXT8oPzpcZCpcLnwpXGQrKD86W2VFXVsrLV0/XGQrfCkvKS5zb3VyY2U7Cgp2YXIgY3NzRXhwYW5kID0gWyAiVG9wIiwgIlJpZ2h0IiwgIkJvdHRvbSIsICJMZWZ0IiBdOwoKdmFyIGlzSGlkZGVuID0gZnVuY3Rpb24oIGVsZW0sIGVsICkgewoJCS8vIGlzSGlkZGVuIG1pZ2h0IGJlIGNhbGxlZCBmcm9tIGpRdWVyeSNmaWx0ZXIgZnVuY3Rpb247CgkJLy8gaW4gdGhhdCBjYXNlLCBlbGVtZW50IHdpbGwgYmUgc2Vjb25kIGFyZ3VtZW50CgkJZWxlbSA9IGVsIHx8IGVsZW07CgkJcmV0dXJuIGpRdWVyeS5jc3MoIGVsZW0sICJkaXNwbGF5IiApID09PSAibm9uZSIgfHwgIWpRdWVyeS5jb250YWlucyggZWxlbS5vd25lckRvY3VtZW50LCBlbGVtICk7Cgl9OwoKCgovLyBNdWx0aWZ1bmN0aW9uYWwgbWV0aG9kIHRvIGdldCBhbmQgc2V0IHZhbHVlcyBvZiBhIGNvbGxlY3Rpb24KLy8gVGhlIHZhbHVlL3MgY2FuIG9wdGlvbmFsbHkgYmUgZXhlY3V0ZWQgaWYgaXQncyBhIGZ1bmN0aW9uCnZhciBhY2Nlc3MgPSBqUXVlcnkuYWNjZXNzID0gZnVuY3Rpb24oIGVsZW1zLCBmbiwga2V5LCB2YWx1ZSwgY2hhaW5hYmxlLCBlbXB0eUdldCwgcmF3ICkgewoJdmFyIGkgPSAwLAoJCWxlbmd0aCA9IGVsZW1zLmxlbmd0aCwKCQlidWxrID0ga2V5ID09IG51bGw7CgoJLy8gU2V0cyBtYW55IHZhbHVlcwoJaWYgKCBqUXVlcnkudHlwZSgga2V5ICkgPT09ICJvYmplY3QiICkgewoJCWNoYWluYWJsZSA9IHRydWU7CgkJZm9yICggaSBpbiBrZXkgKSB7CgkJCWpRdWVyeS5hY2Nlc3MoIGVsZW1zLCBmbiwgaSwga2V5W2ldLCB0cnVlLCBlbXB0eUdldCwgcmF3ICk7CgkJfQoKCS8vIFNldHMgb25lIHZhbHVlCgl9IGVsc2UgaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCWNoYWluYWJsZSA9IHRydWU7CgoJCWlmICggIWpRdWVyeS5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlyYXcgPSB0cnVlOwoJCX0KCgkJaWYgKCBidWxrICkgewoJCQkvLyBCdWxrIG9wZXJhdGlvbnMgcnVuIGFnYWluc3QgdGhlIGVudGlyZSBzZXQKCQkJaWYgKCByYXcgKSB7CgkJCQlmbi5jYWxsKCBlbGVtcywgdmFsdWUgKTsKCQkJCWZuID0gbnVsbDsKCgkJCS8vIC4uLmV4Y2VwdCB3aGVuIGV4ZWN1dGluZyBmdW5jdGlvbiB2YWx1ZXMKCQkJfSBlbHNlIHsKCQkJCWJ1bGsgPSBmbjsKCQkJCWZuID0gZnVuY3Rpb24oIGVsZW0sIGtleSwgdmFsdWUgKSB7CgkJCQkJcmV0dXJuIGJ1bGsuY2FsbCggalF1ZXJ5KCBlbGVtICksIHZhbHVlICk7CgkJCQl9OwoJCQl9CgkJfQoKCQlpZiAoIGZuICkgewoJCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJCWZuKCBlbGVtc1tpXSwga2V5LCByYXcgPyB2YWx1ZSA6IHZhbHVlLmNhbGwoIGVsZW1zW2ldLCBpLCBmbiggZWxlbXNbaV0sIGtleSApICkgKTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gY2hhaW5hYmxlID8KCQllbGVtcyA6CgoJCS8vIEdldHMKCQlidWxrID8KCQkJZm4uY2FsbCggZWxlbXMgKSA6CgkJCWxlbmd0aCA/IGZuKCBlbGVtc1swXSwga2V5ICkgOiBlbXB0eUdldDsKfTsKdmFyIHJjaGVja2FibGVUeXBlID0gKC9eKD86Y2hlY2tib3h8cmFkaW8pJC9pKTsKCgoKKGZ1bmN0aW9uKCkgewoJdmFyIGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAoJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpLAoJCWlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKCgkvLyBTZXR1cAoJZGl2LnNldEF0dHJpYnV0ZSggImNsYXNzTmFtZSIsICJ0IiApOwoJZGl2LmlubmVySFRNTCA9ICIgIDxsaW5rLz48dGFibGU+PC90YWJsZT48YSBocmVmPScvYSc+YTwvYT4iOwoKCS8vIElFIHN0cmlwcyBsZWFkaW5nIHdoaXRlc3BhY2Ugd2hlbiAuaW5uZXJIVE1MIGlzIHVzZWQKCXN1cHBvcnQubGVhZGluZ1doaXRlc3BhY2UgPSBkaXYuZmlyc3RDaGlsZC5ub2RlVHlwZSA9PT0gMzsKCgkvLyBNYWtlIHN1cmUgdGhhdCB0Ym9keSBlbGVtZW50cyBhcmVuJ3QgYXV0b21hdGljYWxseSBpbnNlcnRlZAoJLy8gSUUgd2lsbCBpbnNlcnQgdGhlbSBpbnRvIGVtcHR5IHRhYmxlcwoJc3VwcG9ydC50Ym9keSA9ICFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoICJ0Ym9keSIgKS5sZW5ndGg7CgoJLy8gTWFrZSBzdXJlIHRoYXQgbGluayBlbGVtZW50cyBnZXQgc2VyaWFsaXplZCBjb3JyZWN0bHkgYnkgaW5uZXJIVE1MCgkvLyBUaGlzIHJlcXVpcmVzIGEgd3JhcHBlciBlbGVtZW50IGluIElFCglzdXBwb3J0Lmh0bWxTZXJpYWxpemUgPSAhIWRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSggImxpbmsiICkubGVuZ3RoOwoKCS8vIE1ha2VzIHN1cmUgY2xvbmluZyBhbiBodG1sNSBlbGVtZW50IGRvZXMgbm90IGNhdXNlIHByb2JsZW1zCgkvLyBXaGVyZSBvdXRlckhUTUwgaXMgdW5kZWZpbmVkLCB0aGlzIHN0aWxsIHdvcmtzCglzdXBwb3J0Lmh0bWw1Q2xvbmUgPQoJCWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJuYXYiICkuY2xvbmVOb2RlKCB0cnVlICkub3V0ZXJIVE1MICE9PSAiPDpuYXY+PC86bmF2PiI7CgoJLy8gQ2hlY2sgaWYgYSBkaXNjb25uZWN0ZWQgY2hlY2tib3ggd2lsbCByZXRhaW4gaXRzIGNoZWNrZWQKCS8vIHZhbHVlIG9mIHRydWUgYWZ0ZXIgYXBwZW5kZWQgdG8gdGhlIERPTSAoSUU2LzcpCglpbnB1dC50eXBlID0gImNoZWNrYm94IjsKCWlucHV0LmNoZWNrZWQgPSB0cnVlOwoJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGlucHV0ICk7CglzdXBwb3J0LmFwcGVuZENoZWNrZWQgPSBpbnB1dC5jaGVja2VkOwoKCS8vIE1ha2Ugc3VyZSB0ZXh0YXJlYSAoYW5kIGNoZWNrYm94KSBkZWZhdWx0VmFsdWUgaXMgcHJvcGVybHkgY2xvbmVkCgkvLyBTdXBwb3J0OiBJRTYtSUUxMSsKCWRpdi5pbm5lckhUTUwgPSAiPHRleHRhcmVhPng8L3RleHRhcmVhPiI7CglzdXBwb3J0Lm5vQ2xvbmVDaGVja2VkID0gISFkaXYuY2xvbmVOb2RlKCB0cnVlICkubGFzdENoaWxkLmRlZmF1bHRWYWx1ZTsKCgkvLyAjMTEyMTcgLSBXZWJLaXQgbG9zZXMgY2hlY2sgd2hlbiB0aGUgbmFtZSBpcyBhZnRlciB0aGUgY2hlY2tlZCBhdHRyaWJ1dGUKCWZyYWdtZW50LmFwcGVuZENoaWxkKCBkaXYgKTsKCWRpdi5pbm5lckhUTUwgPSAiPGlucHV0IHR5cGU9J3JhZGlvJyBjaGVja2VkPSdjaGVja2VkJyBuYW1lPSd0Jy8+IjsKCgkvLyBTdXBwb3J0OiBTYWZhcmkgNS4xLCBpT1MgNS4xLCBBbmRyb2lkIDQueCwgQW5kcm9pZCAyLjMKCS8vIG9sZCBXZWJLaXQgZG9lc24ndCBjbG9uZSBjaGVja2VkIHN0YXRlIGNvcnJlY3RseSBpbiBmcmFnbWVudHMKCXN1cHBvcnQuY2hlY2tDbG9uZSA9IGRpdi5jbG9uZU5vZGUoIHRydWUgKS5jbG9uZU5vZGUoIHRydWUgKS5sYXN0Q2hpbGQuY2hlY2tlZDsKCgkvLyBTdXBwb3J0OiBJRTw5CgkvLyBPcGVyYSBkb2VzIG5vdCBjbG9uZSBldmVudHMgKGFuZCB0eXBlb2YgZGl2LmF0dGFjaEV2ZW50ID09PSB1bmRlZmluZWQpLgoJLy8gSUU5LTEwIGNsb25lcyBldmVudHMgYm91bmQgdmlhIGF0dGFjaEV2ZW50LCBidXQgdGhleSBkb24ndCB0cmlnZ2VyIHdpdGggLmNsaWNrKCkKCXN1cHBvcnQubm9DbG9uZUV2ZW50ID0gdHJ1ZTsKCWlmICggZGl2LmF0dGFjaEV2ZW50ICkgewoJCWRpdi5hdHRhY2hFdmVudCggIm9uY2xpY2siLCBmdW5jdGlvbigpIHsKCQkJc3VwcG9ydC5ub0Nsb25lRXZlbnQgPSBmYWxzZTsKCQl9KTsKCgkJZGl2LmNsb25lTm9kZSggdHJ1ZSApLmNsaWNrKCk7Cgl9CgoJLy8gRXhlY3V0ZSB0aGUgdGVzdCBvbmx5IGlmIG5vdCBhbHJlYWR5IGV4ZWN1dGVkIGluIGFub3RoZXIgbW9kdWxlLgoJaWYgKHN1cHBvcnQuZGVsZXRlRXhwYW5kbyA9PSBudWxsKSB7CgkJLy8gU3VwcG9ydDogSUU8OQoJCXN1cHBvcnQuZGVsZXRlRXhwYW5kbyA9IHRydWU7CgkJdHJ5IHsKCQkJZGVsZXRlIGRpdi50ZXN0OwoJCX0gY2F0Y2goIGUgKSB7CgkJCXN1cHBvcnQuZGVsZXRlRXhwYW5kbyA9IGZhbHNlOwoJCX0KCX0KCgkvLyBOdWxsIGVsZW1lbnRzIHRvIGF2b2lkIGxlYWtzIGluIElFLgoJZnJhZ21lbnQgPSBkaXYgPSBpbnB1dCA9IG51bGw7Cn0pKCk7CgoKKGZ1bmN0aW9uKCkgewoJdmFyIGksIGV2ZW50TmFtZSwKCQlkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoKCS8vIFN1cHBvcnQ6IElFPDkgKGxhY2sgc3VibWl0L2NoYW5nZSBidWJibGUpLCBGaXJlZm94IDIzKyAobGFjayBmb2N1c2luIGV2ZW50KQoJZm9yICggaSBpbiB7IHN1Ym1pdDogdHJ1ZSwgY2hhbmdlOiB0cnVlLCBmb2N1c2luOiB0cnVlIH0pIHsKCQlldmVudE5hbWUgPSAib24iICsgaTsKCgkJaWYgKCAhKHN1cHBvcnRbIGkgKyAiQnViYmxlcyIgXSA9IGV2ZW50TmFtZSBpbiB3aW5kb3cpICkgewoJCQkvLyBCZXdhcmUgb2YgQ1NQIHJlc3RyaWN0aW9ucyAoaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vU2VjdXJpdHkvQ1NQKQoJCQlkaXYuc2V0QXR0cmlidXRlKCBldmVudE5hbWUsICJ0IiApOwoJCQlzdXBwb3J0WyBpICsgIkJ1YmJsZXMiIF0gPSBkaXYuYXR0cmlidXRlc1sgZXZlbnROYW1lIF0uZXhwYW5kbyA9PT0gZmFsc2U7CgkJfQoJfQoKCS8vIE51bGwgZWxlbWVudHMgdG8gYXZvaWQgbGVha3MgaW4gSUUuCglkaXYgPSBudWxsOwp9KSgpOwoKCnZhciByZm9ybUVsZW1zID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWEpJC9pLAoJcmtleUV2ZW50ID0gL15rZXkvLAoJcm1vdXNlRXZlbnQgPSAvXig/Om1vdXNlfGNvbnRleHRtZW51KXxjbGljay8sCglyZm9jdXNNb3JwaCA9IC9eKD86Zm9jdXNpbmZvY3VzfGZvY3Vzb3V0Ymx1cikkLywKCXJ0eXBlbmFtZXNwYWNlID0gL14oW14uXSopKD86XC4oLispfCkkLzsKCmZ1bmN0aW9uIHJldHVyblRydWUoKSB7CglyZXR1cm4gdHJ1ZTsKfQoKZnVuY3Rpb24gcmV0dXJuRmFsc2UoKSB7CglyZXR1cm4gZmFsc2U7Cn0KCmZ1bmN0aW9uIHNhZmVBY3RpdmVFbGVtZW50KCkgewoJdHJ5IHsKCQlyZXR1cm4gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDsKCX0gY2F0Y2ggKCBlcnIgKSB7IH0KfQoKLyoKICogSGVscGVyIGZ1bmN0aW9ucyBmb3IgbWFuYWdpbmcgZXZlbnRzIC0tIG5vdCBwYXJ0IG9mIHRoZSBwdWJsaWMgaW50ZXJmYWNlLgogKiBQcm9wcyB0byBEZWFuIEVkd2FyZHMnIGFkZEV2ZW50IGxpYnJhcnkgZm9yIG1hbnkgb2YgdGhlIGlkZWFzLgogKi8KalF1ZXJ5LmV2ZW50ID0gewoKCWdsb2JhbDoge30sCgoJYWRkOiBmdW5jdGlvbiggZWxlbSwgdHlwZXMsIGhhbmRsZXIsIGRhdGEsIHNlbGVjdG9yICkgewoJCXZhciB0bXAsIGV2ZW50cywgdCwgaGFuZGxlT2JqSW4sCgkJCXNwZWNpYWwsIGV2ZW50SGFuZGxlLCBoYW5kbGVPYmosCgkJCWhhbmRsZXJzLCB0eXBlLCBuYW1lc3BhY2VzLCBvcmlnVHlwZSwKCQkJZWxlbURhdGEgPSBqUXVlcnkuX2RhdGEoIGVsZW0gKTsKCgkJLy8gRG9uJ3QgYXR0YWNoIGV2ZW50cyB0byBub0RhdGEgb3IgdGV4dC9jb21tZW50IG5vZGVzIChidXQgYWxsb3cgcGxhaW4gb2JqZWN0cykKCQlpZiAoICFlbGVtRGF0YSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gQ2FsbGVyIGNhbiBwYXNzIGluIGFuIG9iamVjdCBvZiBjdXN0b20gZGF0YSBpbiBsaWV1IG9mIHRoZSBoYW5kbGVyCgkJaWYgKCBoYW5kbGVyLmhhbmRsZXIgKSB7CgkJCWhhbmRsZU9iakluID0gaGFuZGxlcjsKCQkJaGFuZGxlciA9IGhhbmRsZU9iakluLmhhbmRsZXI7CgkJCXNlbGVjdG9yID0gaGFuZGxlT2JqSW4uc2VsZWN0b3I7CgkJfQoKCQkvLyBNYWtlIHN1cmUgdGhhdCB0aGUgaGFuZGxlciBoYXMgYSB1bmlxdWUgSUQsIHVzZWQgdG8gZmluZC9yZW1vdmUgaXQgbGF0ZXIKCQlpZiAoICFoYW5kbGVyLmd1aWQgKSB7CgkJCWhhbmRsZXIuZ3VpZCA9IGpRdWVyeS5ndWlkKys7CgkJfQoKCQkvLyBJbml0IHRoZSBlbGVtZW50J3MgZXZlbnQgc3RydWN0dXJlIGFuZCBtYWluIGhhbmRsZXIsIGlmIHRoaXMgaXMgdGhlIGZpcnN0CgkJaWYgKCAhKGV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cykgKSB7CgkJCWV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cyA9IHt9OwoJCX0KCQlpZiAoICEoZXZlbnRIYW5kbGUgPSBlbGVtRGF0YS5oYW5kbGUpICkgewoJCQlldmVudEhhbmRsZSA9IGVsZW1EYXRhLmhhbmRsZSA9IGZ1bmN0aW9uKCBlICkgewoJCQkJLy8gRGlzY2FyZCB0aGUgc2Vjb25kIGV2ZW50IG9mIGEgalF1ZXJ5LmV2ZW50LnRyaWdnZXIoKSBhbmQKCQkJCS8vIHdoZW4gYW4gZXZlbnQgaXMgY2FsbGVkIGFmdGVyIGEgcGFnZSBoYXMgdW5sb2FkZWQKCQkJCXJldHVybiB0eXBlb2YgalF1ZXJ5ICE9PSBzdHJ1bmRlZmluZWQgJiYgKCFlIHx8IGpRdWVyeS5ldmVudC50cmlnZ2VyZWQgIT09IGUudHlwZSkgPwoJCQkJCWpRdWVyeS5ldmVudC5kaXNwYXRjaC5hcHBseSggZXZlbnRIYW5kbGUuZWxlbSwgYXJndW1lbnRzICkgOgoJCQkJCXVuZGVmaW5lZDsKCQkJfTsKCQkJLy8gQWRkIGVsZW0gYXMgYSBwcm9wZXJ0eSBvZiB0aGUgaGFuZGxlIGZuIHRvIHByZXZlbnQgYSBtZW1vcnkgbGVhayB3aXRoIElFIG5vbi1uYXRpdmUgZXZlbnRzCgkJCWV2ZW50SGFuZGxlLmVsZW0gPSBlbGVtOwoJCX0KCgkJLy8gSGFuZGxlIG11bHRpcGxlIGV2ZW50cyBzZXBhcmF0ZWQgYnkgYSBzcGFjZQoJCXR5cGVzID0gKCB0eXBlcyB8fCAiIiApLm1hdGNoKCBybm90d2hpdGUgKSB8fCBbICIiIF07CgkJdCA9IHR5cGVzLmxlbmd0aDsKCQl3aGlsZSAoIHQtLSApIHsKCQkJdG1wID0gcnR5cGVuYW1lc3BhY2UuZXhlYyggdHlwZXNbdF0gKSB8fCBbXTsKCQkJdHlwZSA9IG9yaWdUeXBlID0gdG1wWzFdOwoJCQluYW1lc3BhY2VzID0gKCB0bXBbMl0gfHwgIiIgKS5zcGxpdCggIi4iICkuc29ydCgpOwoKCQkJLy8gVGhlcmUgKm11c3QqIGJlIGEgdHlwZSwgbm8gYXR0YWNoaW5nIG5hbWVzcGFjZS1vbmx5IGhhbmRsZXJzCgkJCWlmICggIXR5cGUgKSB7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJLy8gSWYgZXZlbnQgY2hhbmdlcyBpdHMgdHlwZSwgdXNlIHRoZSBzcGVjaWFsIGV2ZW50IGhhbmRsZXJzIGZvciB0aGUgY2hhbmdlZCB0eXBlCgkJCXNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9OwoKCQkJLy8gSWYgc2VsZWN0b3IgZGVmaW5lZCwgZGV0ZXJtaW5lIHNwZWNpYWwgZXZlbnQgYXBpIHR5cGUsIG90aGVyd2lzZSBnaXZlbiB0eXBlCgkJCXR5cGUgPSAoIHNlbGVjdG9yID8gc3BlY2lhbC5kZWxlZ2F0ZVR5cGUgOiBzcGVjaWFsLmJpbmRUeXBlICkgfHwgdHlwZTsKCgkJCS8vIFVwZGF0ZSBzcGVjaWFsIGJhc2VkIG9uIG5ld2x5IHJlc2V0IHR5cGUKCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gfHwge307CgoJCQkvLyBoYW5kbGVPYmogaXMgcGFzc2VkIHRvIGFsbCBldmVudCBoYW5kbGVycwoJCQloYW5kbGVPYmogPSBqUXVlcnkuZXh0ZW5kKHsKCQkJCXR5cGU6IHR5cGUsCgkJCQlvcmlnVHlwZTogb3JpZ1R5cGUsCgkJCQlkYXRhOiBkYXRhLAoJCQkJaGFuZGxlcjogaGFuZGxlciwKCQkJCWd1aWQ6IGhhbmRsZXIuZ3VpZCwKCQkJCXNlbGVjdG9yOiBzZWxlY3RvciwKCQkJCW5lZWRzQ29udGV4dDogc2VsZWN0b3IgJiYgalF1ZXJ5LmV4cHIubWF0Y2gubmVlZHNDb250ZXh0LnRlc3QoIHNlbGVjdG9yICksCgkJCQluYW1lc3BhY2U6IG5hbWVzcGFjZXMuam9pbigiLiIpCgkJCX0sIGhhbmRsZU9iakluICk7CgoJCQkvLyBJbml0IHRoZSBldmVudCBoYW5kbGVyIHF1ZXVlIGlmIHdlJ3JlIHRoZSBmaXJzdAoJCQlpZiAoICEoaGFuZGxlcnMgPSBldmVudHNbIHR5cGUgXSkgKSB7CgkJCQloYW5kbGVycyA9IGV2ZW50c1sgdHlwZSBdID0gW107CgkJCQloYW5kbGVycy5kZWxlZ2F0ZUNvdW50ID0gMDsKCgkJCQkvLyBPbmx5IHVzZSBhZGRFdmVudExpc3RlbmVyL2F0dGFjaEV2ZW50IGlmIHRoZSBzcGVjaWFsIGV2ZW50cyBoYW5kbGVyIHJldHVybnMgZmFsc2UKCQkJCWlmICggIXNwZWNpYWwuc2V0dXAgfHwgc3BlY2lhbC5zZXR1cC5jYWxsKCBlbGVtLCBkYXRhLCBuYW1lc3BhY2VzLCBldmVudEhhbmRsZSApID09PSBmYWxzZSApIHsKCQkJCQkvLyBCaW5kIHRoZSBnbG9iYWwgZXZlbnQgaGFuZGxlciB0byB0aGUgZWxlbWVudAoJCQkJCWlmICggZWxlbS5hZGRFdmVudExpc3RlbmVyICkgewoJCQkJCQllbGVtLmFkZEV2ZW50TGlzdGVuZXIoIHR5cGUsIGV2ZW50SGFuZGxlLCBmYWxzZSApOwoKCQkJCQl9IGVsc2UgaWYgKCBlbGVtLmF0dGFjaEV2ZW50ICkgewoJCQkJCQllbGVtLmF0dGFjaEV2ZW50KCAib24iICsgdHlwZSwgZXZlbnRIYW5kbGUgKTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCWlmICggc3BlY2lhbC5hZGQgKSB7CgkJCQlzcGVjaWFsLmFkZC5jYWxsKCBlbGVtLCBoYW5kbGVPYmogKTsKCgkJCQlpZiAoICFoYW5kbGVPYmouaGFuZGxlci5ndWlkICkgewoJCQkJCWhhbmRsZU9iai5oYW5kbGVyLmd1aWQgPSBoYW5kbGVyLmd1aWQ7CgkJCQl9CgkJCX0KCgkJCS8vIEFkZCB0byB0aGUgZWxlbWVudCdzIGhhbmRsZXIgbGlzdCwgZGVsZWdhdGVzIGluIGZyb250CgkJCWlmICggc2VsZWN0b3IgKSB7CgkJCQloYW5kbGVycy5zcGxpY2UoIGhhbmRsZXJzLmRlbGVnYXRlQ291bnQrKywgMCwgaGFuZGxlT2JqICk7CgkJCX0gZWxzZSB7CgkJCQloYW5kbGVycy5wdXNoKCBoYW5kbGVPYmogKTsKCQkJfQoKCQkJLy8gS2VlcCB0cmFjayBvZiB3aGljaCBldmVudHMgaGF2ZSBldmVyIGJlZW4gdXNlZCwgZm9yIGV2ZW50IG9wdGltaXphdGlvbgoJCQlqUXVlcnkuZXZlbnQuZ2xvYmFsWyB0eXBlIF0gPSB0cnVlOwoJCX0KCgkJLy8gTnVsbGlmeSBlbGVtIHRvIHByZXZlbnQgbWVtb3J5IGxlYWtzIGluIElFCgkJZWxlbSA9IG51bGw7Cgl9LAoKCS8vIERldGFjaCBhbiBldmVudCBvciBzZXQgb2YgZXZlbnRzIGZyb20gYW4gZWxlbWVudAoJcmVtb3ZlOiBmdW5jdGlvbiggZWxlbSwgdHlwZXMsIGhhbmRsZXIsIHNlbGVjdG9yLCBtYXBwZWRUeXBlcyApIHsKCQl2YXIgaiwgaGFuZGxlT2JqLCB0bXAsCgkJCW9yaWdDb3VudCwgdCwgZXZlbnRzLAoJCQlzcGVjaWFsLCBoYW5kbGVycywgdHlwZSwKCQkJbmFtZXNwYWNlcywgb3JpZ1R5cGUsCgkJCWVsZW1EYXRhID0galF1ZXJ5Lmhhc0RhdGEoIGVsZW0gKSAmJiBqUXVlcnkuX2RhdGEoIGVsZW0gKTsKCgkJaWYgKCAhZWxlbURhdGEgfHwgIShldmVudHMgPSBlbGVtRGF0YS5ldmVudHMpICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBPbmNlIGZvciBlYWNoIHR5cGUubmFtZXNwYWNlIGluIHR5cGVzOyB0eXBlIG1heSBiZSBvbWl0dGVkCgkJdHlwZXMgPSAoIHR5cGVzIHx8ICIiICkubWF0Y2goIHJub3R3aGl0ZSApIHx8IFsgIiIgXTsKCQl0ID0gdHlwZXMubGVuZ3RoOwoJCXdoaWxlICggdC0tICkgewoJCQl0bXAgPSBydHlwZW5hbWVzcGFjZS5leGVjKCB0eXBlc1t0XSApIHx8IFtdOwoJCQl0eXBlID0gb3JpZ1R5cGUgPSB0bXBbMV07CgkJCW5hbWVzcGFjZXMgPSAoIHRtcFsyXSB8fCAiIiApLnNwbGl0KCAiLiIgKS5zb3J0KCk7CgoJCQkvLyBVbmJpbmQgYWxsIGV2ZW50cyAob24gdGhpcyBuYW1lc3BhY2UsIGlmIHByb3ZpZGVkKSBmb3IgdGhlIGVsZW1lbnQKCQkJaWYgKCAhdHlwZSApIHsKCQkJCWZvciAoIHR5cGUgaW4gZXZlbnRzICkgewoJCQkJCWpRdWVyeS5ldmVudC5yZW1vdmUoIGVsZW0sIHR5cGUgKyB0eXBlc1sgdCBdLCBoYW5kbGVyLCBzZWxlY3RvciwgdHJ1ZSApOwoJCQkJfQoJCQkJY29udGludWU7CgkJCX0KCgkJCXNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9OwoJCQl0eXBlID0gKCBzZWxlY3RvciA/IHNwZWNpYWwuZGVsZWdhdGVUeXBlIDogc3BlY2lhbC5iaW5kVHlwZSApIHx8IHR5cGU7CgkJCWhhbmRsZXJzID0gZXZlbnRzWyB0eXBlIF0gfHwgW107CgkJCXRtcCA9IHRtcFsyXSAmJiBuZXcgUmVnRXhwKCAiKF58XFwuKSIgKyBuYW1lc3BhY2VzLmpvaW4oIlxcLig/Oi4qXFwufCkiKSArICIoXFwufCQpIiApOwoKCQkJLy8gUmVtb3ZlIG1hdGNoaW5nIGV2ZW50cwoJCQlvcmlnQ291bnQgPSBqID0gaGFuZGxlcnMubGVuZ3RoOwoJCQl3aGlsZSAoIGotLSApIHsKCQkJCWhhbmRsZU9iaiA9IGhhbmRsZXJzWyBqIF07CgoJCQkJaWYgKCAoIG1hcHBlZFR5cGVzIHx8IG9yaWdUeXBlID09PSBoYW5kbGVPYmoub3JpZ1R5cGUgKSAmJgoJCQkJCSggIWhhbmRsZXIgfHwgaGFuZGxlci5ndWlkID09PSBoYW5kbGVPYmouZ3VpZCApICYmCgkJCQkJKCAhdG1wIHx8IHRtcC50ZXN0KCBoYW5kbGVPYmoubmFtZXNwYWNlICkgKSAmJgoJCQkJCSggIXNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSBoYW5kbGVPYmouc2VsZWN0b3IgfHwgc2VsZWN0b3IgPT09ICIqKiIgJiYgaGFuZGxlT2JqLnNlbGVjdG9yICkgKSB7CgkJCQkJaGFuZGxlcnMuc3BsaWNlKCBqLCAxICk7CgoJCQkJCWlmICggaGFuZGxlT2JqLnNlbGVjdG9yICkgewoJCQkJCQloYW5kbGVycy5kZWxlZ2F0ZUNvdW50LS07CgkJCQkJfQoJCQkJCWlmICggc3BlY2lhbC5yZW1vdmUgKSB7CgkJCQkJCXNwZWNpYWwucmVtb3ZlLmNhbGwoIGVsZW0sIGhhbmRsZU9iaiApOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJLy8gUmVtb3ZlIGdlbmVyaWMgZXZlbnQgaGFuZGxlciBpZiB3ZSByZW1vdmVkIHNvbWV0aGluZyBhbmQgbm8gbW9yZSBoYW5kbGVycyBleGlzdAoJCQkvLyAoYXZvaWRzIHBvdGVudGlhbCBmb3IgZW5kbGVzcyByZWN1cnNpb24gZHVyaW5nIHJlbW92YWwgb2Ygc3BlY2lhbCBldmVudCBoYW5kbGVycykKCQkJaWYgKCBvcmlnQ291bnQgJiYgIWhhbmRsZXJzLmxlbmd0aCApIHsKCQkJCWlmICggIXNwZWNpYWwudGVhcmRvd24gfHwgc3BlY2lhbC50ZWFyZG93bi5jYWxsKCBlbGVtLCBuYW1lc3BhY2VzLCBlbGVtRGF0YS5oYW5kbGUgKSA9PT0gZmFsc2UgKSB7CgkJCQkJalF1ZXJ5LnJlbW92ZUV2ZW50KCBlbGVtLCB0eXBlLCBlbGVtRGF0YS5oYW5kbGUgKTsKCQkJCX0KCgkJCQlkZWxldGUgZXZlbnRzWyB0eXBlIF07CgkJCX0KCQl9CgoJCS8vIFJlbW92ZSB0aGUgZXhwYW5kbyBpZiBpdCdzIG5vIGxvbmdlciB1c2VkCgkJaWYgKCBqUXVlcnkuaXNFbXB0eU9iamVjdCggZXZlbnRzICkgKSB7CgkJCWRlbGV0ZSBlbGVtRGF0YS5oYW5kbGU7CgoJCQkvLyByZW1vdmVEYXRhIGFsc28gY2hlY2tzIGZvciBlbXB0aW5lc3MgYW5kIGNsZWFycyB0aGUgZXhwYW5kbyBpZiBlbXB0eQoJCQkvLyBzbyB1c2UgaXQgaW5zdGVhZCBvZiBkZWxldGUKCQkJalF1ZXJ5Ll9yZW1vdmVEYXRhKCBlbGVtLCAiZXZlbnRzIiApOwoJCX0KCX0sCgoJdHJpZ2dlcjogZnVuY3Rpb24oIGV2ZW50LCBkYXRhLCBlbGVtLCBvbmx5SGFuZGxlcnMgKSB7CgkJdmFyIGhhbmRsZSwgb250eXBlLCBjdXIsCgkJCWJ1YmJsZVR5cGUsIHNwZWNpYWwsIHRtcCwgaSwKCQkJZXZlbnRQYXRoID0gWyBlbGVtIHx8IGRvY3VtZW50IF0sCgkJCXR5cGUgPSBoYXNPd24uY2FsbCggZXZlbnQsICJ0eXBlIiApID8gZXZlbnQudHlwZSA6IGV2ZW50LAoJCQluYW1lc3BhY2VzID0gaGFzT3duLmNhbGwoIGV2ZW50LCAibmFtZXNwYWNlIiApID8gZXZlbnQubmFtZXNwYWNlLnNwbGl0KCIuIikgOiBbXTsKCgkJY3VyID0gdG1wID0gZWxlbSA9IGVsZW0gfHwgZG9jdW1lbnQ7CgoJCS8vIERvbid0IGRvIGV2ZW50cyBvbiB0ZXh0IGFuZCBjb21tZW50IG5vZGVzCgkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT09IDggKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIGZvY3VzL2JsdXIgbW9ycGhzIHRvIGZvY3VzaW4vb3V0OyBlbnN1cmUgd2UncmUgbm90IGZpcmluZyB0aGVtIHJpZ2h0IG5vdwoJCWlmICggcmZvY3VzTW9ycGgudGVzdCggdHlwZSArIGpRdWVyeS5ldmVudC50cmlnZ2VyZWQgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCB0eXBlLmluZGV4T2YoIi4iKSA+PSAwICkgewoJCQkvLyBOYW1lc3BhY2VkIHRyaWdnZXI7IGNyZWF0ZSBhIHJlZ2V4cCB0byBtYXRjaCBldmVudCB0eXBlIGluIGhhbmRsZSgpCgkJCW5hbWVzcGFjZXMgPSB0eXBlLnNwbGl0KCIuIik7CgkJCXR5cGUgPSBuYW1lc3BhY2VzLnNoaWZ0KCk7CgkJCW5hbWVzcGFjZXMuc29ydCgpOwoJCX0KCQlvbnR5cGUgPSB0eXBlLmluZGV4T2YoIjoiKSA8IDAgJiYgIm9uIiArIHR5cGU7CgoJCS8vIENhbGxlciBjYW4gcGFzcyBpbiBhIGpRdWVyeS5FdmVudCBvYmplY3QsIE9iamVjdCwgb3IganVzdCBhbiBldmVudCB0eXBlIHN0cmluZwoJCWV2ZW50ID0gZXZlbnRbIGpRdWVyeS5leHBhbmRvIF0gPwoJCQlldmVudCA6CgkJCW5ldyBqUXVlcnkuRXZlbnQoIHR5cGUsIHR5cGVvZiBldmVudCA9PT0gIm9iamVjdCIgJiYgZXZlbnQgKTsKCgkJLy8gVHJpZ2dlciBiaXRtYXNrOiAmIDEgZm9yIG5hdGl2ZSBoYW5kbGVyczsgJiAyIGZvciBqUXVlcnkgKGFsd2F5cyB0cnVlKQoJCWV2ZW50LmlzVHJpZ2dlciA9IG9ubHlIYW5kbGVycyA/IDIgOiAzOwoJCWV2ZW50Lm5hbWVzcGFjZSA9IG5hbWVzcGFjZXMuam9pbigiLiIpOwoJCWV2ZW50Lm5hbWVzcGFjZV9yZSA9IGV2ZW50Lm5hbWVzcGFjZSA/CgkJCW5ldyBSZWdFeHAoICIoXnxcXC4pIiArIG5hbWVzcGFjZXMuam9pbigiXFwuKD86LipcXC58KSIpICsgIihcXC58JCkiICkgOgoJCQludWxsOwoKCQkvLyBDbGVhbiB1cCB0aGUgZXZlbnQgaW4gY2FzZSBpdCBpcyBiZWluZyByZXVzZWQKCQlldmVudC5yZXN1bHQgPSB1bmRlZmluZWQ7CgkJaWYgKCAhZXZlbnQudGFyZ2V0ICkgewoJCQlldmVudC50YXJnZXQgPSBlbGVtOwoJCX0KCgkJLy8gQ2xvbmUgYW55IGluY29taW5nIGRhdGEgYW5kIHByZXBlbmQgdGhlIGV2ZW50LCBjcmVhdGluZyB0aGUgaGFuZGxlciBhcmcgbGlzdAoJCWRhdGEgPSBkYXRhID09IG51bGwgPwoJCQlbIGV2ZW50IF0gOgoJCQlqUXVlcnkubWFrZUFycmF5KCBkYXRhLCBbIGV2ZW50IF0gKTsKCgkJLy8gQWxsb3cgc3BlY2lhbCBldmVudHMgdG8gZHJhdyBvdXRzaWRlIHRoZSBsaW5lcwoJCXNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9OwoJCWlmICggIW9ubHlIYW5kbGVycyAmJiBzcGVjaWFsLnRyaWdnZXIgJiYgc3BlY2lhbC50cmlnZ2VyLmFwcGx5KCBlbGVtLCBkYXRhICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBEZXRlcm1pbmUgZXZlbnQgcHJvcGFnYXRpb24gcGF0aCBpbiBhZHZhbmNlLCBwZXIgVzNDIGV2ZW50cyBzcGVjICgjOTk1MSkKCQkvLyBCdWJibGUgdXAgdG8gZG9jdW1lbnQsIHRoZW4gdG8gd2luZG93OyB3YXRjaCBmb3IgYSBnbG9iYWwgb3duZXJEb2N1bWVudCB2YXIgKCM5NzI0KQoJCWlmICggIW9ubHlIYW5kbGVycyAmJiAhc3BlY2lhbC5ub0J1YmJsZSAmJiAhalF1ZXJ5LmlzV2luZG93KCBlbGVtICkgKSB7CgoJCQlidWJibGVUeXBlID0gc3BlY2lhbC5kZWxlZ2F0ZVR5cGUgfHwgdHlwZTsKCQkJaWYgKCAhcmZvY3VzTW9ycGgudGVzdCggYnViYmxlVHlwZSArIHR5cGUgKSApIHsKCQkJCWN1ciA9IGN1ci5wYXJlbnROb2RlOwoJCQl9CgkJCWZvciAoIDsgY3VyOyBjdXIgPSBjdXIucGFyZW50Tm9kZSApIHsKCQkJCWV2ZW50UGF0aC5wdXNoKCBjdXIgKTsKCQkJCXRtcCA9IGN1cjsKCQkJfQoKCQkJLy8gT25seSBhZGQgd2luZG93IGlmIHdlIGdvdCB0byBkb2N1bWVudCAoZS5nLiwgbm90IHBsYWluIG9iaiBvciBkZXRhY2hlZCBET00pCgkJCWlmICggdG1wID09PSAoZWxlbS5vd25lckRvY3VtZW50IHx8IGRvY3VtZW50KSApIHsKCQkJCWV2ZW50UGF0aC5wdXNoKCB0bXAuZGVmYXVsdFZpZXcgfHwgdG1wLnBhcmVudFdpbmRvdyB8fCB3aW5kb3cgKTsKCQkJfQoJCX0KCgkJLy8gRmlyZSBoYW5kbGVycyBvbiB0aGUgZXZlbnQgcGF0aAoJCWkgPSAwOwoJCXdoaWxlICggKGN1ciA9IGV2ZW50UGF0aFtpKytdKSAmJiAhZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCgkJCWV2ZW50LnR5cGUgPSBpID4gMSA/CgkJCQlidWJibGVUeXBlIDoKCQkJCXNwZWNpYWwuYmluZFR5cGUgfHwgdHlwZTsKCgkJCS8vIGpRdWVyeSBoYW5kbGVyCgkJCWhhbmRsZSA9ICggalF1ZXJ5Ll9kYXRhKCBjdXIsICJldmVudHMiICkgfHwge30gKVsgZXZlbnQudHlwZSBdICYmIGpRdWVyeS5fZGF0YSggY3VyLCAiaGFuZGxlIiApOwoJCQlpZiAoIGhhbmRsZSApIHsKCQkJCWhhbmRsZS5hcHBseSggY3VyLCBkYXRhICk7CgkJCX0KCgkJCS8vIE5hdGl2ZSBoYW5kbGVyCgkJCWhhbmRsZSA9IG9udHlwZSAmJiBjdXJbIG9udHlwZSBdOwoJCQlpZiAoIGhhbmRsZSAmJiBoYW5kbGUuYXBwbHkgJiYgalF1ZXJ5LmFjY2VwdERhdGEoIGN1ciApICkgewoJCQkJZXZlbnQucmVzdWx0ID0gaGFuZGxlLmFwcGx5KCBjdXIsIGRhdGEgKTsKCQkJCWlmICggZXZlbnQucmVzdWx0ID09PSBmYWxzZSApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfQoJCQl9CgkJfQoJCWV2ZW50LnR5cGUgPSB0eXBlOwoKCQkvLyBJZiBub2JvZHkgcHJldmVudGVkIHRoZSBkZWZhdWx0IGFjdGlvbiwgZG8gaXQgbm93CgkJaWYgKCAhb25seUhhbmRsZXJzICYmICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCgkJCWlmICggKCFzcGVjaWFsLl9kZWZhdWx0IHx8IHNwZWNpYWwuX2RlZmF1bHQuYXBwbHkoIGV2ZW50UGF0aC5wb3AoKSwgZGF0YSApID09PSBmYWxzZSkgJiYKCQkJCWpRdWVyeS5hY2NlcHREYXRhKCBlbGVtICkgKSB7CgoJCQkJLy8gQ2FsbCBhIG5hdGl2ZSBET00gbWV0aG9kIG9uIHRoZSB0YXJnZXQgd2l0aCB0aGUgc2FtZSBuYW1lIG5hbWUgYXMgdGhlIGV2ZW50LgoJCQkJLy8gQ2FuJ3QgdXNlIGFuIC5pc0Z1bmN0aW9uKCkgY2hlY2sgaGVyZSBiZWNhdXNlIElFNi83IGZhaWxzIHRoYXQgdGVzdC4KCQkJCS8vIERvbid0IGRvIGRlZmF1bHQgYWN0aW9ucyBvbiB3aW5kb3csIHRoYXQncyB3aGVyZSBnbG9iYWwgdmFyaWFibGVzIGJlICgjNjE3MCkKCQkJCWlmICggb250eXBlICYmIGVsZW1bIHR5cGUgXSAmJiAhalF1ZXJ5LmlzV2luZG93KCBlbGVtICkgKSB7CgoJCQkJCS8vIERvbid0IHJlLXRyaWdnZXIgYW4gb25GT08gZXZlbnQgd2hlbiB3ZSBjYWxsIGl0cyBGT08oKSBtZXRob2QKCQkJCQl0bXAgPSBlbGVtWyBvbnR5cGUgXTsKCgkJCQkJaWYgKCB0bXAgKSB7CgkJCQkJCWVsZW1bIG9udHlwZSBdID0gbnVsbDsKCQkJCQl9CgoJCQkJCS8vIFByZXZlbnQgcmUtdHJpZ2dlcmluZyBvZiB0aGUgc2FtZSBldmVudCwgc2luY2Ugd2UgYWxyZWFkeSBidWJibGVkIGl0IGFib3ZlCgkJCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCA9IHR5cGU7CgkJCQkJdHJ5IHsKCQkJCQkJZWxlbVsgdHlwZSBdKCk7CgkJCQkJfSBjYXRjaCAoIGUgKSB7CgkJCQkJCS8vIElFPDkgZGllcyBvbiBmb2N1cy9ibHVyIHRvIGhpZGRlbiBlbGVtZW50ICgjMTQ4NiwjMTI1MTgpCgkJCQkJCS8vIG9ubHkgcmVwcm9kdWNpYmxlIG9uIHdpblhQIElFOCBuYXRpdmUsIG5vdCBJRTkgaW4gSUU4IG1vZGUKCQkJCQl9CgkJCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCA9IHVuZGVmaW5lZDsKCgkJCQkJaWYgKCB0bXAgKSB7CgkJCQkJCWVsZW1bIG9udHlwZSBdID0gdG1wOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIGV2ZW50LnJlc3VsdDsKCX0sCgoJZGlzcGF0Y2g6IGZ1bmN0aW9uKCBldmVudCApIHsKCgkJLy8gTWFrZSBhIHdyaXRhYmxlIGpRdWVyeS5FdmVudCBmcm9tIHRoZSBuYXRpdmUgZXZlbnQgb2JqZWN0CgkJZXZlbnQgPSBqUXVlcnkuZXZlbnQuZml4KCBldmVudCApOwoKCQl2YXIgaSwgcmV0LCBoYW5kbGVPYmosIG1hdGNoZWQsIGosCgkJCWhhbmRsZXJRdWV1ZSA9IFtdLAoJCQlhcmdzID0gc2xpY2UuY2FsbCggYXJndW1lbnRzICksCgkJCWhhbmRsZXJzID0gKCBqUXVlcnkuX2RhdGEoIHRoaXMsICJldmVudHMiICkgfHwge30gKVsgZXZlbnQudHlwZSBdIHx8IFtdLAoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIGV2ZW50LnR5cGUgXSB8fCB7fTsKCgkJLy8gVXNlIHRoZSBmaXgtZWQgalF1ZXJ5LkV2ZW50IHJhdGhlciB0aGFuIHRoZSAocmVhZC1vbmx5KSBuYXRpdmUgZXZlbnQKCQlhcmdzWzBdID0gZXZlbnQ7CgkJZXZlbnQuZGVsZWdhdGVUYXJnZXQgPSB0aGlzOwoKCQkvLyBDYWxsIHRoZSBwcmVEaXNwYXRjaCBob29rIGZvciB0aGUgbWFwcGVkIHR5cGUsIGFuZCBsZXQgaXQgYmFpbCBpZiBkZXNpcmVkCgkJaWYgKCBzcGVjaWFsLnByZURpc3BhdGNoICYmIHNwZWNpYWwucHJlRGlzcGF0Y2guY2FsbCggdGhpcywgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIERldGVybWluZSBoYW5kbGVycwoJCWhhbmRsZXJRdWV1ZSA9IGpRdWVyeS5ldmVudC5oYW5kbGVycy5jYWxsKCB0aGlzLCBldmVudCwgaGFuZGxlcnMgKTsKCgkJLy8gUnVuIGRlbGVnYXRlcyBmaXJzdDsgdGhleSBtYXkgd2FudCB0byBzdG9wIHByb3BhZ2F0aW9uIGJlbmVhdGggdXMKCQlpID0gMDsKCQl3aGlsZSAoIChtYXRjaGVkID0gaGFuZGxlclF1ZXVlWyBpKysgXSkgJiYgIWV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCWV2ZW50LmN1cnJlbnRUYXJnZXQgPSBtYXRjaGVkLmVsZW07CgoJCQlqID0gMDsKCQkJd2hpbGUgKCAoaGFuZGxlT2JqID0gbWF0Y2hlZC5oYW5kbGVyc1sgaisrIF0pICYmICFldmVudC5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoKCQkJCS8vIFRyaWdnZXJlZCBldmVudCBtdXN0IGVpdGhlciAxKSBoYXZlIG5vIG5hbWVzcGFjZSwgb3IKCQkJCS8vIDIpIGhhdmUgbmFtZXNwYWNlKHMpIGEgc3Vic2V0IG9yIGVxdWFsIHRvIHRob3NlIGluIHRoZSBib3VuZCBldmVudCAoYm90aCBjYW4gaGF2ZSBubyBuYW1lc3BhY2UpLgoJCQkJaWYgKCAhZXZlbnQubmFtZXNwYWNlX3JlIHx8IGV2ZW50Lm5hbWVzcGFjZV9yZS50ZXN0KCBoYW5kbGVPYmoubmFtZXNwYWNlICkgKSB7CgoJCQkJCWV2ZW50LmhhbmRsZU9iaiA9IGhhbmRsZU9iajsKCQkJCQlldmVudC5kYXRhID0gaGFuZGxlT2JqLmRhdGE7CgoJCQkJCXJldCA9ICggKGpRdWVyeS5ldmVudC5zcGVjaWFsWyBoYW5kbGVPYmoub3JpZ1R5cGUgXSB8fCB7fSkuaGFuZGxlIHx8IGhhbmRsZU9iai5oYW5kbGVyICkKCQkJCQkJCS5hcHBseSggbWF0Y2hlZC5lbGVtLCBhcmdzICk7CgoJCQkJCWlmICggcmV0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJCWlmICggKGV2ZW50LnJlc3VsdCA9IHJldCkgPT09IGZhbHNlICkgewoJCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQkvLyBDYWxsIHRoZSBwb3N0RGlzcGF0Y2ggaG9vayBmb3IgdGhlIG1hcHBlZCB0eXBlCgkJaWYgKCBzcGVjaWFsLnBvc3REaXNwYXRjaCApIHsKCQkJc3BlY2lhbC5wb3N0RGlzcGF0Y2guY2FsbCggdGhpcywgZXZlbnQgKTsKCQl9CgoJCXJldHVybiBldmVudC5yZXN1bHQ7Cgl9LAoKCWhhbmRsZXJzOiBmdW5jdGlvbiggZXZlbnQsIGhhbmRsZXJzICkgewoJCXZhciBzZWwsIGhhbmRsZU9iaiwgbWF0Y2hlcywgaSwKCQkJaGFuZGxlclF1ZXVlID0gW10sCgkJCWRlbGVnYXRlQ291bnQgPSBoYW5kbGVycy5kZWxlZ2F0ZUNvdW50LAoJCQljdXIgPSBldmVudC50YXJnZXQ7CgoJCS8vIEZpbmQgZGVsZWdhdGUgaGFuZGxlcnMKCQkvLyBCbGFjay1ob2xlIFNWRyA8dXNlPiBpbnN0YW5jZSB0cmVlcyAoIzEzMTgwKQoJCS8vIEF2b2lkIG5vbi1sZWZ0LWNsaWNrIGJ1YmJsaW5nIGluIEZpcmVmb3ggKCMzODYxKQoJCWlmICggZGVsZWdhdGVDb3VudCAmJiBjdXIubm9kZVR5cGUgJiYgKCFldmVudC5idXR0b24gfHwgZXZlbnQudHlwZSAhPT0gImNsaWNrIikgKSB7CgoJCQkvKiBqc2hpbnQgZXFlcWVxOiBmYWxzZSAqLwoJCQlmb3IgKCA7IGN1ciAhPSB0aGlzOyBjdXIgPSBjdXIucGFyZW50Tm9kZSB8fCB0aGlzICkgewoJCQkJLyoganNoaW50IGVxZXFlcTogdHJ1ZSAqLwoKCQkJCS8vIERvbid0IGNoZWNrIG5vbi1lbGVtZW50cyAoIzEzMjA4KQoJCQkJLy8gRG9uJ3QgcHJvY2VzcyBjbGlja3Mgb24gZGlzYWJsZWQgZWxlbWVudHMgKCM2OTExLCAjODE2NSwgIzExMzgyLCAjMTE3NjQpCgkJCQlpZiAoIGN1ci5ub2RlVHlwZSA9PT0gMSAmJiAoY3VyLmRpc2FibGVkICE9PSB0cnVlIHx8IGV2ZW50LnR5cGUgIT09ICJjbGljayIpICkgewoJCQkJCW1hdGNoZXMgPSBbXTsKCQkJCQlmb3IgKCBpID0gMDsgaSA8IGRlbGVnYXRlQ291bnQ7IGkrKyApIHsKCQkJCQkJaGFuZGxlT2JqID0gaGFuZGxlcnNbIGkgXTsKCgkJCQkJCS8vIERvbid0IGNvbmZsaWN0IHdpdGggT2JqZWN0LnByb3RvdHlwZSBwcm9wZXJ0aWVzICgjMTMyMDMpCgkJCQkJCXNlbCA9IGhhbmRsZU9iai5zZWxlY3RvciArICIgIjsKCgkJCQkJCWlmICggbWF0Y2hlc1sgc2VsIF0gPT09IHVuZGVmaW5lZCApIHsKCQkJCQkJCW1hdGNoZXNbIHNlbCBdID0gaGFuZGxlT2JqLm5lZWRzQ29udGV4dCA/CgkJCQkJCQkJalF1ZXJ5KCBzZWwsIHRoaXMgKS5pbmRleCggY3VyICkgPj0gMCA6CgkJCQkJCQkJalF1ZXJ5LmZpbmQoIHNlbCwgdGhpcywgbnVsbCwgWyBjdXIgXSApLmxlbmd0aDsKCQkJCQkJfQoJCQkJCQlpZiAoIG1hdGNoZXNbIHNlbCBdICkgewoJCQkJCQkJbWF0Y2hlcy5wdXNoKCBoYW5kbGVPYmogKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQlpZiAoIG1hdGNoZXMubGVuZ3RoICkgewoJCQkJCQloYW5kbGVyUXVldWUucHVzaCh7IGVsZW06IGN1ciwgaGFuZGxlcnM6IG1hdGNoZXMgfSk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQkvLyBBZGQgdGhlIHJlbWFpbmluZyAoZGlyZWN0bHktYm91bmQpIGhhbmRsZXJzCgkJaWYgKCBkZWxlZ2F0ZUNvdW50IDwgaGFuZGxlcnMubGVuZ3RoICkgewoJCQloYW5kbGVyUXVldWUucHVzaCh7IGVsZW06IHRoaXMsIGhhbmRsZXJzOiBoYW5kbGVycy5zbGljZSggZGVsZWdhdGVDb3VudCApIH0pOwoJCX0KCgkJcmV0dXJuIGhhbmRsZXJRdWV1ZTsKCX0sCgoJZml4OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCBldmVudFsgalF1ZXJ5LmV4cGFuZG8gXSApIHsKCQkJcmV0dXJuIGV2ZW50OwoJCX0KCgkJLy8gQ3JlYXRlIGEgd3JpdGFibGUgY29weSBvZiB0aGUgZXZlbnQgb2JqZWN0IGFuZCBub3JtYWxpemUgc29tZSBwcm9wZXJ0aWVzCgkJdmFyIGksIHByb3AsIGNvcHksCgkJCXR5cGUgPSBldmVudC50eXBlLAoJCQlvcmlnaW5hbEV2ZW50ID0gZXZlbnQsCgkJCWZpeEhvb2sgPSB0aGlzLmZpeEhvb2tzWyB0eXBlIF07CgoJCWlmICggIWZpeEhvb2sgKSB7CgkJCXRoaXMuZml4SG9va3NbIHR5cGUgXSA9IGZpeEhvb2sgPQoJCQkJcm1vdXNlRXZlbnQudGVzdCggdHlwZSApID8gdGhpcy5tb3VzZUhvb2tzIDoKCQkJCXJrZXlFdmVudC50ZXN0KCB0eXBlICkgPyB0aGlzLmtleUhvb2tzIDoKCQkJCXt9OwoJCX0KCQljb3B5ID0gZml4SG9vay5wcm9wcyA/IHRoaXMucHJvcHMuY29uY2F0KCBmaXhIb29rLnByb3BzICkgOiB0aGlzLnByb3BzOwoKCQlldmVudCA9IG5ldyBqUXVlcnkuRXZlbnQoIG9yaWdpbmFsRXZlbnQgKTsKCgkJaSA9IGNvcHkubGVuZ3RoOwoJCXdoaWxlICggaS0tICkgewoJCQlwcm9wID0gY29weVsgaSBdOwoJCQlldmVudFsgcHJvcCBdID0gb3JpZ2luYWxFdmVudFsgcHJvcCBdOwoJCX0KCgkJLy8gU3VwcG9ydDogSUU8OQoJCS8vIEZpeCB0YXJnZXQgcHJvcGVydHkgKCMxOTI1KQoJCWlmICggIWV2ZW50LnRhcmdldCApIHsKCQkJZXZlbnQudGFyZ2V0ID0gb3JpZ2luYWxFdmVudC5zcmNFbGVtZW50IHx8IGRvY3VtZW50OwoJCX0KCgkJLy8gU3VwcG9ydDogQ2hyb21lIDIzKywgU2FmYXJpPwoJCS8vIFRhcmdldCBzaG91bGQgbm90IGJlIGEgdGV4dCBub2RlICgjNTA0LCAjMTMxNDMpCgkJaWYgKCBldmVudC50YXJnZXQubm9kZVR5cGUgPT09IDMgKSB7CgkJCWV2ZW50LnRhcmdldCA9IGV2ZW50LnRhcmdldC5wYXJlbnROb2RlOwoJCX0KCgkJLy8gU3VwcG9ydDogSUU8OQoJCS8vIEZvciBtb3VzZS9rZXkgZXZlbnRzLCBtZXRhS2V5PT1mYWxzZSBpZiBpdCdzIHVuZGVmaW5lZCAoIzMzNjgsICMxMTMyOCkKCQlldmVudC5tZXRhS2V5ID0gISFldmVudC5tZXRhS2V5OwoKCQlyZXR1cm4gZml4SG9vay5maWx0ZXIgPyBmaXhIb29rLmZpbHRlciggZXZlbnQsIG9yaWdpbmFsRXZlbnQgKSA6IGV2ZW50OwoJfSwKCgkvLyBJbmNsdWRlcyBzb21lIGV2ZW50IHByb3BzIHNoYXJlZCBieSBLZXlFdmVudCBhbmQgTW91c2VFdmVudAoJcHJvcHM6ICJhbHRLZXkgYnViYmxlcyBjYW5jZWxhYmxlIGN0cmxLZXkgY3VycmVudFRhcmdldCBldmVudFBoYXNlIG1ldGFLZXkgcmVsYXRlZFRhcmdldCBzaGlmdEtleSB0YXJnZXQgdGltZVN0YW1wIHZpZXcgd2hpY2giLnNwbGl0KCIgIiksCgoJZml4SG9va3M6IHt9LAoKCWtleUhvb2tzOiB7CgkJcHJvcHM6ICJjaGFyIGNoYXJDb2RlIGtleSBrZXlDb2RlIi5zcGxpdCgiICIpLAoJCWZpbHRlcjogZnVuY3Rpb24oIGV2ZW50LCBvcmlnaW5hbCApIHsKCgkJCS8vIEFkZCB3aGljaCBmb3Iga2V5IGV2ZW50cwoJCQlpZiAoIGV2ZW50LndoaWNoID09IG51bGwgKSB7CgkJCQlldmVudC53aGljaCA9IG9yaWdpbmFsLmNoYXJDb2RlICE9IG51bGwgPyBvcmlnaW5hbC5jaGFyQ29kZSA6IG9yaWdpbmFsLmtleUNvZGU7CgkJCX0KCgkJCXJldHVybiBldmVudDsKCQl9Cgl9LAoKCW1vdXNlSG9va3M6IHsKCQlwcm9wczogImJ1dHRvbiBidXR0b25zIGNsaWVudFggY2xpZW50WSBmcm9tRWxlbWVudCBvZmZzZXRYIG9mZnNldFkgcGFnZVggcGFnZVkgc2NyZWVuWCBzY3JlZW5ZIHRvRWxlbWVudCIuc3BsaXQoIiAiKSwKCQlmaWx0ZXI6IGZ1bmN0aW9uKCBldmVudCwgb3JpZ2luYWwgKSB7CgkJCXZhciBib2R5LCBldmVudERvYywgZG9jLAoJCQkJYnV0dG9uID0gb3JpZ2luYWwuYnV0dG9uLAoJCQkJZnJvbUVsZW1lbnQgPSBvcmlnaW5hbC5mcm9tRWxlbWVudDsKCgkJCS8vIENhbGN1bGF0ZSBwYWdlWC9ZIGlmIG1pc3NpbmcgYW5kIGNsaWVudFgvWSBhdmFpbGFibGUKCQkJaWYgKCBldmVudC5wYWdlWCA9PSBudWxsICYmIG9yaWdpbmFsLmNsaWVudFggIT0gbnVsbCApIHsKCQkJCWV2ZW50RG9jID0gZXZlbnQudGFyZ2V0Lm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQ7CgkJCQlkb2MgPSBldmVudERvYy5kb2N1bWVudEVsZW1lbnQ7CgkJCQlib2R5ID0gZXZlbnREb2MuYm9keTsKCgkJCQlldmVudC5wYWdlWCA9IG9yaWdpbmFsLmNsaWVudFggKyAoIGRvYyAmJiBkb2Muc2Nyb2xsTGVmdCB8fCBib2R5ICYmIGJvZHkuc2Nyb2xsTGVmdCB8fCAwICkgLSAoIGRvYyAmJiBkb2MuY2xpZW50TGVmdCB8fCBib2R5ICYmIGJvZHkuY2xpZW50TGVmdCB8fCAwICk7CgkJCQlldmVudC5wYWdlWSA9IG9yaWdpbmFsLmNsaWVudFkgKyAoIGRvYyAmJiBkb2Muc2Nyb2xsVG9wICB8fCBib2R5ICYmIGJvZHkuc2Nyb2xsVG9wICB8fCAwICkgLSAoIGRvYyAmJiBkb2MuY2xpZW50VG9wICB8fCBib2R5ICYmIGJvZHkuY2xpZW50VG9wICB8fCAwICk7CgkJCX0KCgkJCS8vIEFkZCByZWxhdGVkVGFyZ2V0LCBpZiBuZWNlc3NhcnkKCQkJaWYgKCAhZXZlbnQucmVsYXRlZFRhcmdldCAmJiBmcm9tRWxlbWVudCApIHsKCQkJCWV2ZW50LnJlbGF0ZWRUYXJnZXQgPSBmcm9tRWxlbWVudCA9PT0gZXZlbnQudGFyZ2V0ID8gb3JpZ2luYWwudG9FbGVtZW50IDogZnJvbUVsZW1lbnQ7CgkJCX0KCgkJCS8vIEFkZCB3aGljaCBmb3IgY2xpY2s6IDEgPT09IGxlZnQ7IDIgPT09IG1pZGRsZTsgMyA9PT0gcmlnaHQKCQkJLy8gTm90ZTogYnV0dG9uIGlzIG5vdCBub3JtYWxpemVkLCBzbyBkb24ndCB1c2UgaXQKCQkJaWYgKCAhZXZlbnQud2hpY2ggJiYgYnV0dG9uICE9PSB1bmRlZmluZWQgKSB7CgkJCQlldmVudC53aGljaCA9ICggYnV0dG9uICYgMSA/IDEgOiAoIGJ1dHRvbiAmIDIgPyAzIDogKCBidXR0b24gJiA0ID8gMiA6IDAgKSApICk7CgkJCX0KCgkJCXJldHVybiBldmVudDsKCQl9Cgl9LAoKCXNwZWNpYWw6IHsKCQlsb2FkOiB7CgkJCS8vIFByZXZlbnQgdHJpZ2dlcmVkIGltYWdlLmxvYWQgZXZlbnRzIGZyb20gYnViYmxpbmcgdG8gd2luZG93LmxvYWQKCQkJbm9CdWJibGU6IHRydWUKCQl9LAoJCWZvY3VzOiB7CgkJCS8vIEZpcmUgbmF0aXZlIGV2ZW50IGlmIHBvc3NpYmxlIHNvIGJsdXIvZm9jdXMgc2VxdWVuY2UgaXMgY29ycmVjdAoJCQl0cmlnZ2VyOiBmdW5jdGlvbigpIHsKCQkJCWlmICggdGhpcyAhPT0gc2FmZUFjdGl2ZUVsZW1lbnQoKSAmJiB0aGlzLmZvY3VzICkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuZm9jdXMoKTsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0gY2F0Y2ggKCBlICkgewoJCQkJCQkvLyBTdXBwb3J0OiBJRTw5CgkJCQkJCS8vIElmIHdlIGVycm9yIG9uIGZvY3VzIHRvIGhpZGRlbiBlbGVtZW50ICgjMTQ4NiwgIzEyNTE4KSwKCQkJCQkJLy8gbGV0IC50cmlnZ2VyKCkgcnVuIHRoZSBoYW5kbGVycwoJCQkJCX0KCQkJCX0KCQkJfSwKCQkJZGVsZWdhdGVUeXBlOiAiZm9jdXNpbiIKCQl9LAoJCWJsdXI6IHsKCQkJdHJpZ2dlcjogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHRoaXMgPT09IHNhZmVBY3RpdmVFbGVtZW50KCkgJiYgdGhpcy5ibHVyICkgewoJCQkJCXRoaXMuYmx1cigpOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSwKCQkJZGVsZWdhdGVUeXBlOiAiZm9jdXNvdXQiCgkJfSwKCQljbGljazogewoJCQkvLyBGb3IgY2hlY2tib3gsIGZpcmUgbmF0aXZlIGV2ZW50IHNvIGNoZWNrZWQgc3RhdGUgd2lsbCBiZSByaWdodAoJCQl0cmlnZ2VyOiBmdW5jdGlvbigpIHsKCQkJCWlmICggalF1ZXJ5Lm5vZGVOYW1lKCB0aGlzLCAiaW5wdXQiICkgJiYgdGhpcy50eXBlID09PSAiY2hlY2tib3giICYmIHRoaXMuY2xpY2sgKSB7CgkJCQkJdGhpcy5jbGljaygpOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSwKCgkJCS8vIEZvciBjcm9zcy1icm93c2VyIGNvbnNpc3RlbmN5LCBkb24ndCBmaXJlIG5hdGl2ZSAuY2xpY2soKSBvbiBsaW5rcwoJCQlfZGVmYXVsdDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJcmV0dXJuIGpRdWVyeS5ub2RlTmFtZSggZXZlbnQudGFyZ2V0LCAiYSIgKTsKCQkJfQoJCX0sCgoJCWJlZm9yZXVubG9hZDogewoJCQlwb3N0RGlzcGF0Y2g6IGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQkvLyBFdmVuIHdoZW4gcmV0dXJuVmFsdWUgZXF1YWxzIHRvIHVuZGVmaW5lZCBGaXJlZm94IHdpbGwgc3RpbGwgc2hvdyBhbGVydAoJCQkJaWYgKCBldmVudC5yZXN1bHQgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnJldHVyblZhbHVlID0gZXZlbnQucmVzdWx0OwoJCQkJfQoJCQl9CgkJfQoJfSwKCglzaW11bGF0ZTogZnVuY3Rpb24oIHR5cGUsIGVsZW0sIGV2ZW50LCBidWJibGUgKSB7CgkJLy8gUGlnZ3liYWNrIG9uIGEgZG9ub3IgZXZlbnQgdG8gc2ltdWxhdGUgYSBkaWZmZXJlbnQgb25lLgoJCS8vIEZha2Ugb3JpZ2luYWxFdmVudCB0byBhdm9pZCBkb25vcidzIHN0b3BQcm9wYWdhdGlvbiwgYnV0IGlmIHRoZQoJCS8vIHNpbXVsYXRlZCBldmVudCBwcmV2ZW50cyBkZWZhdWx0IHRoZW4gd2UgZG8gdGhlIHNhbWUgb24gdGhlIGRvbm9yLgoJCXZhciBlID0galF1ZXJ5LmV4dGVuZCgKCQkJbmV3IGpRdWVyeS5FdmVudCgpLAoJCQlldmVudCwKCQkJewoJCQkJdHlwZTogdHlwZSwKCQkJCWlzU2ltdWxhdGVkOiB0cnVlLAoJCQkJb3JpZ2luYWxFdmVudDoge30KCQkJfQoJCSk7CgkJaWYgKCBidWJibGUgKSB7CgkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCBlLCBudWxsLCBlbGVtICk7CgkJfSBlbHNlIHsKCQkJalF1ZXJ5LmV2ZW50LmRpc3BhdGNoLmNhbGwoIGVsZW0sIGUgKTsKCQl9CgkJaWYgKCBlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0KCX0KfTsKCmpRdWVyeS5yZW1vdmVFdmVudCA9IGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIgPwoJZnVuY3Rpb24oIGVsZW0sIHR5cGUsIGhhbmRsZSApIHsKCQlpZiAoIGVsZW0ucmVtb3ZlRXZlbnRMaXN0ZW5lciApIHsKCQkJZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyKCB0eXBlLCBoYW5kbGUsIGZhbHNlICk7CgkJfQoJfSA6CglmdW5jdGlvbiggZWxlbSwgdHlwZSwgaGFuZGxlICkgewoJCXZhciBuYW1lID0gIm9uIiArIHR5cGU7CgoJCWlmICggZWxlbS5kZXRhY2hFdmVudCApIHsKCgkJCS8vICM4NTQ1LCAjNzA1NCwgcHJldmVudGluZyBtZW1vcnkgbGVha3MgZm9yIGN1c3RvbSBldmVudHMgaW4gSUU2LTgKCQkJLy8gZGV0YWNoRXZlbnQgbmVlZGVkIHByb3BlcnR5IG9uIGVsZW1lbnQsIGJ5IG5hbWUgb2YgdGhhdCBldmVudCwgdG8gcHJvcGVybHkgZXhwb3NlIGl0IHRvIEdDCgkJCWlmICggdHlwZW9mIGVsZW1bIG5hbWUgXSA9PT0gc3RydW5kZWZpbmVkICkgewoJCQkJZWxlbVsgbmFtZSBdID0gbnVsbDsKCQkJfQoKCQkJZWxlbS5kZXRhY2hFdmVudCggbmFtZSwgaGFuZGxlICk7CgkJfQoJfTsKCmpRdWVyeS5FdmVudCA9IGZ1bmN0aW9uKCBzcmMsIHByb3BzICkgewoJLy8gQWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0IHRoZSAnbmV3JyBrZXl3b3JkCglpZiAoICEodGhpcyBpbnN0YW5jZW9mIGpRdWVyeS5FdmVudCkgKSB7CgkJcmV0dXJuIG5ldyBqUXVlcnkuRXZlbnQoIHNyYywgcHJvcHMgKTsKCX0KCgkvLyBFdmVudCBvYmplY3QKCWlmICggc3JjICYmIHNyYy50eXBlICkgewoJCXRoaXMub3JpZ2luYWxFdmVudCA9IHNyYzsKCQl0aGlzLnR5cGUgPSBzcmMudHlwZTsKCgkJLy8gRXZlbnRzIGJ1YmJsaW5nIHVwIHRoZSBkb2N1bWVudCBtYXkgaGF2ZSBiZWVuIG1hcmtlZCBhcyBwcmV2ZW50ZWQKCQkvLyBieSBhIGhhbmRsZXIgbG93ZXIgZG93biB0aGUgdHJlZTsgcmVmbGVjdCB0aGUgY29ycmVjdCB2YWx1ZS4KCQl0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IHNyYy5kZWZhdWx0UHJldmVudGVkIHx8CgkJCQlzcmMuZGVmYXVsdFByZXZlbnRlZCA9PT0gdW5kZWZpbmVkICYmICgKCQkJCS8vIFN1cHBvcnQ6IElFIDwgOQoJCQkJc3JjLnJldHVyblZhbHVlID09PSBmYWxzZSB8fAoJCQkJLy8gU3VwcG9ydDogQW5kcm9pZCA8IDQuMAoJCQkJc3JjLmdldFByZXZlbnREZWZhdWx0ICYmIHNyYy5nZXRQcmV2ZW50RGVmYXVsdCgpICkgPwoJCQlyZXR1cm5UcnVlIDoKCQkJcmV0dXJuRmFsc2U7CgoJLy8gRXZlbnQgdHlwZQoJfSBlbHNlIHsKCQl0aGlzLnR5cGUgPSBzcmM7Cgl9CgoJLy8gUHV0IGV4cGxpY2l0bHkgcHJvdmlkZWQgcHJvcGVydGllcyBvbnRvIHRoZSBldmVudCBvYmplY3QKCWlmICggcHJvcHMgKSB7CgkJalF1ZXJ5LmV4dGVuZCggdGhpcywgcHJvcHMgKTsKCX0KCgkvLyBDcmVhdGUgYSB0aW1lc3RhbXAgaWYgaW5jb21pbmcgZXZlbnQgZG9lc24ndCBoYXZlIG9uZQoJdGhpcy50aW1lU3RhbXAgPSBzcmMgJiYgc3JjLnRpbWVTdGFtcCB8fCBqUXVlcnkubm93KCk7CgoJLy8gTWFyayBpdCBhcyBmaXhlZAoJdGhpc1sgalF1ZXJ5LmV4cGFuZG8gXSA9IHRydWU7Cn07CgovLyBqUXVlcnkuRXZlbnQgaXMgYmFzZWQgb24gRE9NMyBFdmVudHMgYXMgc3BlY2lmaWVkIGJ5IHRoZSBFQ01BU2NyaXB0IExhbmd1YWdlIEJpbmRpbmcKLy8gaHR0cDovL3d3dy53My5vcmcvVFIvMjAwMy9XRC1ET00tTGV2ZWwtMy1FdmVudHMtMjAwMzAzMzEvZWNtYS1zY3JpcHQtYmluZGluZy5odG1sCmpRdWVyeS5FdmVudC5wcm90b3R5cGUgPSB7Cglpc0RlZmF1bHRQcmV2ZW50ZWQ6IHJldHVybkZhbHNlLAoJaXNQcm9wYWdhdGlvblN0b3BwZWQ6IHJldHVybkZhbHNlLAoJaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQ6IHJldHVybkZhbHNlLAoKCXByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpIHsKCQl2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKCgkJdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSByZXR1cm5UcnVlOwoJCWlmICggIWUgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIElmIHByZXZlbnREZWZhdWx0IGV4aXN0cywgcnVuIGl0IG9uIHRoZSBvcmlnaW5hbCBldmVudAoJCWlmICggZS5wcmV2ZW50RGVmYXVsdCApIHsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoKCQkvLyBTdXBwb3J0OiBJRQoJCS8vIE90aGVyd2lzZSBzZXQgdGhlIHJldHVyblZhbHVlIHByb3BlcnR5IG9mIHRoZSBvcmlnaW5hbCBldmVudCB0byBmYWxzZQoJCX0gZWxzZSB7CgkJCWUucmV0dXJuVmFsdWUgPSBmYWxzZTsKCQl9Cgl9LAoJc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbigpIHsKCQl2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKCgkJdGhpcy5pc1Byb3BhZ2F0aW9uU3RvcHBlZCA9IHJldHVyblRydWU7CgkJaWYgKCAhZSApIHsKCQkJcmV0dXJuOwoJCX0KCQkvLyBJZiBzdG9wUHJvcGFnYXRpb24gZXhpc3RzLCBydW4gaXQgb24gdGhlIG9yaWdpbmFsIGV2ZW50CgkJaWYgKCBlLnN0b3BQcm9wYWdhdGlvbiApIHsKCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQl9CgoJCS8vIFN1cHBvcnQ6IElFCgkJLy8gU2V0IHRoZSBjYW5jZWxCdWJibGUgcHJvcGVydHkgb2YgdGhlIG9yaWdpbmFsIGV2ZW50IHRvIHRydWUKCQllLmNhbmNlbEJ1YmJsZSA9IHRydWU7Cgl9LAoJc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOiBmdW5jdGlvbigpIHsKCQl0aGlzLmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkID0gcmV0dXJuVHJ1ZTsKCQl0aGlzLnN0b3BQcm9wYWdhdGlvbigpOwoJfQp9OwoKLy8gQ3JlYXRlIG1vdXNlZW50ZXIvbGVhdmUgZXZlbnRzIHVzaW5nIG1vdXNlb3Zlci9vdXQgYW5kIGV2ZW50LXRpbWUgY2hlY2tzCmpRdWVyeS5lYWNoKHsKCW1vdXNlZW50ZXI6ICJtb3VzZW92ZXIiLAoJbW91c2VsZWF2ZTogIm1vdXNlb3V0Igp9LCBmdW5jdGlvbiggb3JpZywgZml4ICkgewoJalF1ZXJ5LmV2ZW50LnNwZWNpYWxbIG9yaWcgXSA9IHsKCQlkZWxlZ2F0ZVR5cGU6IGZpeCwKCQliaW5kVHlwZTogZml4LAoKCQloYW5kbGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIHJldCwKCQkJCXRhcmdldCA9IHRoaXMsCgkJCQlyZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldCwKCQkJCWhhbmRsZU9iaiA9IGV2ZW50LmhhbmRsZU9iajsKCgkJCS8vIEZvciBtb3VzZW50ZXIvbGVhdmUgY2FsbCB0aGUgaGFuZGxlciBpZiByZWxhdGVkIGlzIG91dHNpZGUgdGhlIHRhcmdldC4KCQkJLy8gTkI6IE5vIHJlbGF0ZWRUYXJnZXQgaWYgdGhlIG1vdXNlIGxlZnQvZW50ZXJlZCB0aGUgYnJvd3NlciB3aW5kb3cKCQkJaWYgKCAhcmVsYXRlZCB8fCAocmVsYXRlZCAhPT0gdGFyZ2V0ICYmICFqUXVlcnkuY29udGFpbnMoIHRhcmdldCwgcmVsYXRlZCApKSApIHsKCQkJCWV2ZW50LnR5cGUgPSBoYW5kbGVPYmoub3JpZ1R5cGU7CgkJCQlyZXQgPSBoYW5kbGVPYmouaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCQlldmVudC50eXBlID0gZml4OwoJCQl9CgkJCXJldHVybiByZXQ7CgkJfQoJfTsKfSk7CgovLyBJRSBzdWJtaXQgZGVsZWdhdGlvbgppZiAoICFzdXBwb3J0LnN1Ym1pdEJ1YmJsZXMgKSB7CgoJalF1ZXJ5LmV2ZW50LnNwZWNpYWwuc3VibWl0ID0gewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJLy8gT25seSBuZWVkIHRoaXMgZm9yIGRlbGVnYXRlZCBmb3JtIHN1Ym1pdCBldmVudHMKCQkJaWYgKCBqUXVlcnkubm9kZU5hbWUoIHRoaXMsICJmb3JtIiApICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQkvLyBMYXp5LWFkZCBhIHN1Ym1pdCBoYW5kbGVyIHdoZW4gYSBkZXNjZW5kYW50IGZvcm0gbWF5IHBvdGVudGlhbGx5IGJlIHN1Ym1pdHRlZAoJCQlqUXVlcnkuZXZlbnQuYWRkKCB0aGlzLCAiY2xpY2suX3N1Ym1pdCBrZXlwcmVzcy5fc3VibWl0IiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkvLyBOb2RlIG5hbWUgY2hlY2sgYXZvaWRzIGEgVk1MLXJlbGF0ZWQgY3Jhc2ggaW4gSUUgKCM5ODA3KQoJCQkJdmFyIGVsZW0gPSBlLnRhcmdldCwKCQkJCQlmb3JtID0galF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAiaW5wdXQiICkgfHwgalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAiYnV0dG9uIiApID8gZWxlbS5mb3JtIDogdW5kZWZpbmVkOwoJCQkJaWYgKCBmb3JtICYmICFqUXVlcnkuX2RhdGEoIGZvcm0sICJzdWJtaXRCdWJibGVzIiApICkgewoJCQkJCWpRdWVyeS5ldmVudC5hZGQoIGZvcm0sICJzdWJtaXQuX3N1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQkJZXZlbnQuX3N1Ym1pdF9idWJibGUgPSB0cnVlOwoJCQkJCX0pOwoJCQkJCWpRdWVyeS5fZGF0YSggZm9ybSwgInN1Ym1pdEJ1YmJsZXMiLCB0cnVlICk7CgkJCQl9CgkJCX0pOwoJCQkvLyByZXR1cm4gdW5kZWZpbmVkIHNpbmNlIHdlIGRvbid0IG5lZWQgYW4gZXZlbnQgbGlzdGVuZXIKCQl9LAoKCQlwb3N0RGlzcGF0Y2g6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gSWYgZm9ybSB3YXMgc3VibWl0dGVkIGJ5IHRoZSB1c2VyLCBidWJibGUgdGhlIGV2ZW50IHVwIHRoZSB0cmVlCgkJCWlmICggZXZlbnQuX3N1Ym1pdF9idWJibGUgKSB7CgkJCQlkZWxldGUgZXZlbnQuX3N1Ym1pdF9idWJibGU7CgkJCQlpZiAoIHRoaXMucGFyZW50Tm9kZSAmJiAhZXZlbnQuaXNUcmlnZ2VyICkgewoJCQkJCWpRdWVyeS5ldmVudC5zaW11bGF0ZSggInN1Ym1pdCIsIHRoaXMucGFyZW50Tm9kZSwgZXZlbnQsIHRydWUgKTsKCQkJCX0KCQkJfQoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJLy8gT25seSBuZWVkIHRoaXMgZm9yIGRlbGVnYXRlZCBmb3JtIHN1Ym1pdCBldmVudHMKCQkJaWYgKCBqUXVlcnkubm9kZU5hbWUoIHRoaXMsICJmb3JtIiApICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQkvLyBSZW1vdmUgZGVsZWdhdGVkIGhhbmRsZXJzOyBjbGVhbkRhdGEgZXZlbnR1YWxseSByZWFwcyBzdWJtaXQgaGFuZGxlcnMgYXR0YWNoZWQgYWJvdmUKCQkJalF1ZXJ5LmV2ZW50LnJlbW92ZSggdGhpcywgIi5fc3VibWl0IiApOwoJCX0KCX07Cn0KCi8vIElFIGNoYW5nZSBkZWxlZ2F0aW9uIGFuZCBjaGVja2JveC9yYWRpbyBmaXgKaWYgKCAhc3VwcG9ydC5jaGFuZ2VCdWJibGVzICkgewoKCWpRdWVyeS5ldmVudC5zcGVjaWFsLmNoYW5nZSA9IHsKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoKCQkJaWYgKCByZm9ybUVsZW1zLnRlc3QoIHRoaXMubm9kZU5hbWUgKSApIHsKCQkJCS8vIElFIGRvZXNuJ3QgZmlyZSBjaGFuZ2Ugb24gYSBjaGVjay9yYWRpbyB1bnRpbCBibHVyOyB0cmlnZ2VyIGl0IG9uIGNsaWNrCgkJCQkvLyBhZnRlciBhIHByb3BlcnR5Y2hhbmdlLiBFYXQgdGhlIGJsdXItY2hhbmdlIGluIHNwZWNpYWwuY2hhbmdlLmhhbmRsZS4KCQkJCS8vIFRoaXMgc3RpbGwgZmlyZXMgb25jaGFuZ2UgYSBzZWNvbmQgdGltZSBmb3IgY2hlY2svcmFkaW8gYWZ0ZXIgYmx1ci4KCQkJCWlmICggdGhpcy50eXBlID09PSAiY2hlY2tib3giIHx8IHRoaXMudHlwZSA9PT0gInJhZGlvIiApIHsKCQkJCQlqUXVlcnkuZXZlbnQuYWRkKCB0aGlzLCAicHJvcGVydHljaGFuZ2UuX2NoYW5nZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQkJaWYgKCBldmVudC5vcmlnaW5hbEV2ZW50LnByb3BlcnR5TmFtZSA9PT0gImNoZWNrZWQiICkgewoJCQkJCQkJdGhpcy5fanVzdF9jaGFuZ2VkID0gdHJ1ZTsKCQkJCQkJfQoJCQkJCX0pOwoJCQkJCWpRdWVyeS5ldmVudC5hZGQoIHRoaXMsICJjbGljay5fY2hhbmdlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCQlpZiAoIHRoaXMuX2p1c3RfY2hhbmdlZCAmJiAhZXZlbnQuaXNUcmlnZ2VyICkgewoJCQkJCQkJdGhpcy5fanVzdF9jaGFuZ2VkID0gZmFsc2U7CgkJCQkJCX0KCQkJCQkJLy8gQWxsb3cgdHJpZ2dlcmVkLCBzaW11bGF0ZWQgY2hhbmdlIGV2ZW50cyAoIzExNTAwKQoJCQkJCQlqUXVlcnkuZXZlbnQuc2ltdWxhdGUoICJjaGFuZ2UiLCB0aGlzLCBldmVudCwgdHJ1ZSApOwoJCQkJCX0pOwoJCQkJfQoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCS8vIERlbGVnYXRlZCBldmVudDsgbGF6eS1hZGQgYSBjaGFuZ2UgaGFuZGxlciBvbiBkZXNjZW5kYW50IGlucHV0cwoJCQlqUXVlcnkuZXZlbnQuYWRkKCB0aGlzLCAiYmVmb3JlYWN0aXZhdGUuX2NoYW5nZSIsIGZ1bmN0aW9uKCBlICkgewoJCQkJdmFyIGVsZW0gPSBlLnRhcmdldDsKCgkJCQlpZiAoIHJmb3JtRWxlbXMudGVzdCggZWxlbS5ub2RlTmFtZSApICYmICFqUXVlcnkuX2RhdGEoIGVsZW0sICJjaGFuZ2VCdWJibGVzIiApICkgewoJCQkJCWpRdWVyeS5ldmVudC5hZGQoIGVsZW0sICJjaGFuZ2UuX2NoYW5nZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQkJaWYgKCB0aGlzLnBhcmVudE5vZGUgJiYgIWV2ZW50LmlzU2ltdWxhdGVkICYmICFldmVudC5pc1RyaWdnZXIgKSB7CgkJCQkJCQlqUXVlcnkuZXZlbnQuc2ltdWxhdGUoICJjaGFuZ2UiLCB0aGlzLnBhcmVudE5vZGUsIGV2ZW50LCB0cnVlICk7CgkJCQkJCX0KCQkJCQl9KTsKCQkJCQlqUXVlcnkuX2RhdGEoIGVsZW0sICJjaGFuZ2VCdWJibGVzIiwgdHJ1ZSApOwoJCQkJfQoJCQl9KTsKCQl9LAoKCQloYW5kbGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGVsZW0gPSBldmVudC50YXJnZXQ7CgoJCQkvLyBTd2FsbG93IG5hdGl2ZSBjaGFuZ2UgZXZlbnRzIGZyb20gY2hlY2tib3gvcmFkaW8sIHdlIGFscmVhZHkgdHJpZ2dlcmVkIHRoZW0gYWJvdmUKCQkJaWYgKCB0aGlzICE9PSBlbGVtIHx8IGV2ZW50LmlzU2ltdWxhdGVkIHx8IGV2ZW50LmlzVHJpZ2dlciB8fCAoZWxlbS50eXBlICE9PSAicmFkaW8iICYmIGVsZW0udHlwZSAhPT0gImNoZWNrYm94IikgKSB7CgkJCQlyZXR1cm4gZXZlbnQuaGFuZGxlT2JqLmhhbmRsZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQl9CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCB0aGlzLCAiLl9jaGFuZ2UiICk7CgoJCQlyZXR1cm4gIXJmb3JtRWxlbXMudGVzdCggdGhpcy5ub2RlTmFtZSApOwoJCX0KCX07Cn0KCi8vIENyZWF0ZSAiYnViYmxpbmciIGZvY3VzIGFuZCBibHVyIGV2ZW50cwppZiAoICFzdXBwb3J0LmZvY3VzaW5CdWJibGVzICkgewoJalF1ZXJ5LmVhY2goeyBmb2N1czogImZvY3VzaW4iLCBibHVyOiAiZm9jdXNvdXQiIH0sIGZ1bmN0aW9uKCBvcmlnLCBmaXggKSB7CgoJCS8vIEF0dGFjaCBhIHNpbmdsZSBjYXB0dXJpbmcgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQgd2hpbGUgc29tZW9uZSB3YW50cyBmb2N1c2luL2ZvY3Vzb3V0CgkJdmFyIGhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlqUXVlcnkuZXZlbnQuc2ltdWxhdGUoIGZpeCwgZXZlbnQudGFyZ2V0LCBqUXVlcnkuZXZlbnQuZml4KCBldmVudCApLCB0cnVlICk7CgkJCX07CgoJCWpRdWVyeS5ldmVudC5zcGVjaWFsWyBmaXggXSA9IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIGRvYyA9IHRoaXMub3duZXJEb2N1bWVudCB8fCB0aGlzLAoJCQkJCWF0dGFjaGVzID0galF1ZXJ5Ll9kYXRhKCBkb2MsIGZpeCApOwoKCQkJCWlmICggIWF0dGFjaGVzICkgewoJCQkJCWRvYy5hZGRFdmVudExpc3RlbmVyKCBvcmlnLCBoYW5kbGVyLCB0cnVlICk7CgkJCQl9CgkJCQlqUXVlcnkuX2RhdGEoIGRvYywgZml4LCAoIGF0dGFjaGVzIHx8IDAgKSArIDEgKTsKCQkJfSwKCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkJdmFyIGRvYyA9IHRoaXMub3duZXJEb2N1bWVudCB8fCB0aGlzLAoJCQkJCWF0dGFjaGVzID0galF1ZXJ5Ll9kYXRhKCBkb2MsIGZpeCApIC0gMTsKCgkJCQlpZiAoICFhdHRhY2hlcyApIHsKCQkJCQlkb2MucmVtb3ZlRXZlbnRMaXN0ZW5lciggb3JpZywgaGFuZGxlciwgdHJ1ZSApOwoJCQkJCWpRdWVyeS5fcmVtb3ZlRGF0YSggZG9jLCBmaXggKTsKCQkJCX0gZWxzZSB7CgkJCQkJalF1ZXJ5Ll9kYXRhKCBkb2MsIGZpeCwgYXR0YWNoZXMgKTsKCQkJCX0KCQkJfQoJCX07Cgl9KTsKfQoKalF1ZXJ5LmZuLmV4dGVuZCh7CgoJb246IGZ1bmN0aW9uKCB0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuLCAvKklOVEVSTkFMKi8gb25lICkgewoJCXZhciB0eXBlLCBvcmlnRm47CgoJCS8vIFR5cGVzIGNhbiBiZSBhIG1hcCBvZiB0eXBlcy9oYW5kbGVycwoJCWlmICggdHlwZW9mIHR5cGVzID09PSAib2JqZWN0IiApIHsKCQkJLy8gKCB0eXBlcy1PYmplY3QsIHNlbGVjdG9yLCBkYXRhICkKCQkJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciICkgewoJCQkJLy8gKCB0eXBlcy1PYmplY3QsIGRhdGEgKQoJCQkJZGF0YSA9IGRhdGEgfHwgc2VsZWN0b3I7CgkJCQlzZWxlY3RvciA9IHVuZGVmaW5lZDsKCQkJfQoJCQlmb3IgKCB0eXBlIGluIHR5cGVzICkgewoJCQkJdGhpcy5vbiggdHlwZSwgc2VsZWN0b3IsIGRhdGEsIHR5cGVzWyB0eXBlIF0sIG9uZSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKCBkYXRhID09IG51bGwgJiYgZm4gPT0gbnVsbCApIHsKCQkJLy8gKCB0eXBlcywgZm4gKQoJCQlmbiA9IHNlbGVjdG9yOwoJCQlkYXRhID0gc2VsZWN0b3IgPSB1bmRlZmluZWQ7CgkJfSBlbHNlIGlmICggZm4gPT0gbnVsbCApIHsKCQkJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciICkgewoJCQkJLy8gKCB0eXBlcywgc2VsZWN0b3IsIGZuICkKCQkJCWZuID0gZGF0YTsKCQkJCWRhdGEgPSB1bmRlZmluZWQ7CgkJCX0gZWxzZSB7CgkJCQkvLyAoIHR5cGVzLCBkYXRhLCBmbiApCgkJCQlmbiA9IGRhdGE7CgkJCQlkYXRhID0gc2VsZWN0b3I7CgkJCQlzZWxlY3RvciA9IHVuZGVmaW5lZDsKCQkJfQoJCX0KCQlpZiAoIGZuID09PSBmYWxzZSApIHsKCQkJZm4gPSByZXR1cm5GYWxzZTsKCQl9IGVsc2UgaWYgKCAhZm4gKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKCBvbmUgPT09IDEgKSB7CgkJCW9yaWdGbiA9IGZuOwoJCQlmbiA9IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCS8vIENhbiB1c2UgYW4gZW1wdHkgc2V0LCBzaW5jZSBldmVudCBjb250YWlucyB0aGUgaW5mbwoJCQkJalF1ZXJ5KCkub2ZmKCBldmVudCApOwoJCQkJcmV0dXJuIG9yaWdGbi5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJCS8vIFVzZSBzYW1lIGd1aWQgc28gY2FsbGVyIGNhbiByZW1vdmUgdXNpbmcgb3JpZ0ZuCgkJCWZuLmd1aWQgPSBvcmlnRm4uZ3VpZCB8fCAoIG9yaWdGbi5ndWlkID0galF1ZXJ5Lmd1aWQrKyApOwoJCX0KCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LmV2ZW50LmFkZCggdGhpcywgdHlwZXMsIGZuLCBkYXRhLCBzZWxlY3RvciApOwoJCX0pOwoJfSwKCW9uZTogZnVuY3Rpb24oIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4gKSB7CgkJcmV0dXJuIHRoaXMub24oIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4sIDEgKTsKCX0sCglvZmY6IGZ1bmN0aW9uKCB0eXBlcywgc2VsZWN0b3IsIGZuICkgewoJCXZhciBoYW5kbGVPYmosIHR5cGU7CgkJaWYgKCB0eXBlcyAmJiB0eXBlcy5wcmV2ZW50RGVmYXVsdCAmJiB0eXBlcy5oYW5kbGVPYmogKSB7CgkJCS8vICggZXZlbnQgKSAgZGlzcGF0Y2hlZCBqUXVlcnkuRXZlbnQKCQkJaGFuZGxlT2JqID0gdHlwZXMuaGFuZGxlT2JqOwoJCQlqUXVlcnkoIHR5cGVzLmRlbGVnYXRlVGFyZ2V0ICkub2ZmKAoJCQkJaGFuZGxlT2JqLm5hbWVzcGFjZSA/IGhhbmRsZU9iai5vcmlnVHlwZSArICIuIiArIGhhbmRsZU9iai5uYW1lc3BhY2UgOiBoYW5kbGVPYmoub3JpZ1R5cGUsCgkJCQloYW5kbGVPYmouc2VsZWN0b3IsCgkJCQloYW5kbGVPYmouaGFuZGxlcgoJCQkpOwoJCQlyZXR1cm4gdGhpczsKCQl9CgkJaWYgKCB0eXBlb2YgdHlwZXMgPT09ICJvYmplY3QiICkgewoJCQkvLyAoIHR5cGVzLW9iamVjdCBbLCBzZWxlY3Rvcl0gKQoJCQlmb3IgKCB0eXBlIGluIHR5cGVzICkgewoJCQkJdGhpcy5vZmYoIHR5cGUsIHNlbGVjdG9yLCB0eXBlc1sgdHlwZSBdICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfQoJCWlmICggc2VsZWN0b3IgPT09IGZhbHNlIHx8IHR5cGVvZiBzZWxlY3RvciA9PT0gImZ1bmN0aW9uIiApIHsKCQkJLy8gKCB0eXBlcyBbLCBmbl0gKQoJCQlmbiA9IHNlbGVjdG9yOwoJCQlzZWxlY3RvciA9IHVuZGVmaW5lZDsKCQl9CgkJaWYgKCBmbiA9PT0gZmFsc2UgKSB7CgkJCWZuID0gcmV0dXJuRmFsc2U7CgkJfQoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWpRdWVyeS5ldmVudC5yZW1vdmUoIHRoaXMsIHR5cGVzLCBmbiwgc2VsZWN0b3IgKTsKCQl9KTsKCX0sCgoJdHJpZ2dlcjogZnVuY3Rpb24oIHR5cGUsIGRhdGEgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoIHR5cGUsIGRhdGEsIHRoaXMgKTsKCQl9KTsKCX0sCgl0cmlnZ2VySGFuZGxlcjogZnVuY3Rpb24oIHR5cGUsIGRhdGEgKSB7CgkJdmFyIGVsZW0gPSB0aGlzWzBdOwoJCWlmICggZWxlbSApIHsKCQkJcmV0dXJuIGpRdWVyeS5ldmVudC50cmlnZ2VyKCB0eXBlLCBkYXRhLCBlbGVtLCB0cnVlICk7CgkJfQoJfQp9KTsKCgpmdW5jdGlvbiBjcmVhdGVTYWZlRnJhZ21lbnQoIGRvY3VtZW50ICkgewoJdmFyIGxpc3QgPSBub2RlTmFtZXMuc3BsaXQoICJ8IiApLAoJCXNhZmVGcmFnID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoKCWlmICggc2FmZUZyYWcuY3JlYXRlRWxlbWVudCApIHsKCQl3aGlsZSAoIGxpc3QubGVuZ3RoICkgewoJCQlzYWZlRnJhZy5jcmVhdGVFbGVtZW50KAoJCQkJbGlzdC5wb3AoKQoJCQkpOwoJCX0KCX0KCXJldHVybiBzYWZlRnJhZzsKfQoKdmFyIG5vZGVOYW1lcyA9ICJhYmJyfGFydGljbGV8YXNpZGV8YXVkaW98YmRpfGNhbnZhc3xkYXRhfGRhdGFsaXN0fGRldGFpbHN8ZmlnY2FwdGlvbnxmaWd1cmV8Zm9vdGVyfCIgKwoJCSJoZWFkZXJ8aGdyb3VwfG1hcmt8bWV0ZXJ8bmF2fG91dHB1dHxwcm9ncmVzc3xzZWN0aW9ufHN1bW1hcnl8dGltZXx2aWRlbyIsCglyaW5saW5lalF1ZXJ5ID0gLyBqUXVlcnlcZCs9Iig/Om51bGx8XGQrKSIvZywKCXJub3NoaW1jYWNoZSA9IG5ldyBSZWdFeHAoIjwoPzoiICsgbm9kZU5hbWVzICsgIilbXFxzLz5dIiwgImkiKSwKCXJsZWFkaW5nV2hpdGVzcGFjZSA9IC9eXHMrLywKCXJ4aHRtbFRhZyA9IC88KD8hYXJlYXxicnxjb2x8ZW1iZWR8aHJ8aW1nfGlucHV0fGxpbmt8bWV0YXxwYXJhbSkoKFtcdzpdKylbXj5dKilcLz4vZ2ksCglydGFnTmFtZSA9IC88KFtcdzpdKykvLAoJcnRib2R5ID0gLzx0Ym9keS9pLAoJcmh0bWwgPSAvPHwmIz9cdys7LywKCXJub0lubmVyaHRtbCA9IC88KD86c2NyaXB0fHN0eWxlfGxpbmspL2ksCgkvLyBjaGVja2VkPSJjaGVja2VkIiBvciBjaGVja2VkCglyY2hlY2tlZCA9IC9jaGVja2VkXHMqKD86W149XXw9XHMqLmNoZWNrZWQuKS9pLAoJcnNjcmlwdFR5cGUgPSAvXiR8XC8oPzpqYXZhfGVjbWEpc2NyaXB0L2ksCglyc2NyaXB0VHlwZU1hc2tlZCA9IC9edHJ1ZVwvKC4qKS8sCglyY2xlYW5TY3JpcHQgPSAvXlxzKjwhKD86XFtDREFUQVxbfC0tKXwoPzpcXVxdfC0tKT5ccyokL2csCgoJLy8gV2UgaGF2ZSB0byBjbG9zZSB0aGVzZSB0YWdzIHRvIHN1cHBvcnQgWEhUTUwgKCMxMzIwMCkKCXdyYXBNYXAgPSB7CgkJb3B0aW9uOiBbIDEsICI8c2VsZWN0IG11bHRpcGxlPSdtdWx0aXBsZSc+IiwgIjwvc2VsZWN0PiIgXSwKCQlsZWdlbmQ6IFsgMSwgIjxmaWVsZHNldD4iLCAiPC9maWVsZHNldD4iIF0sCgkJYXJlYTogWyAxLCAiPG1hcD4iLCAiPC9tYXA+IiBdLAoJCXBhcmFtOiBbIDEsICI8b2JqZWN0PiIsICI8L29iamVjdD4iIF0sCgkJdGhlYWQ6IFsgMSwgIjx0YWJsZT4iLCAiPC90YWJsZT4iIF0sCgkJdHI6IFsgMiwgIjx0YWJsZT48dGJvZHk+IiwgIjwvdGJvZHk+PC90YWJsZT4iIF0sCgkJY29sOiBbIDIsICI8dGFibGU+PHRib2R5PjwvdGJvZHk+PGNvbGdyb3VwPiIsICI8L2NvbGdyb3VwPjwvdGFibGU+IiBdLAoJCXRkOiBbIDMsICI8dGFibGU+PHRib2R5Pjx0cj4iLCAiPC90cj48L3Rib2R5PjwvdGFibGU+IiBdLAoKCQkvLyBJRTYtOCBjYW4ndCBzZXJpYWxpemUgbGluaywgc2NyaXB0LCBzdHlsZSwgb3IgYW55IGh0bWw1IChOb1Njb3BlKSB0YWdzLAoJCS8vIHVubGVzcyB3cmFwcGVkIGluIGEgZGl2IHdpdGggbm9uLWJyZWFraW5nIGNoYXJhY3RlcnMgaW4gZnJvbnQgb2YgaXQuCgkJX2RlZmF1bHQ6IHN1cHBvcnQuaHRtbFNlcmlhbGl6ZSA/IFsgMCwgIiIsICIiIF0gOiBbIDEsICJYPGRpdj4iLCAiPC9kaXY+IiAgXQoJfSwKCXNhZmVGcmFnbWVudCA9IGNyZWF0ZVNhZmVGcmFnbWVudCggZG9jdW1lbnQgKSwKCWZyYWdtZW50RGl2ID0gc2FmZUZyYWdtZW50LmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSApOwoKd3JhcE1hcC5vcHRncm91cCA9IHdyYXBNYXAub3B0aW9uOwp3cmFwTWFwLnRib2R5ID0gd3JhcE1hcC50Zm9vdCA9IHdyYXBNYXAuY29sZ3JvdXAgPSB3cmFwTWFwLmNhcHRpb24gPSB3cmFwTWFwLnRoZWFkOwp3cmFwTWFwLnRoID0gd3JhcE1hcC50ZDsKCmZ1bmN0aW9uIGdldEFsbCggY29udGV4dCwgdGFnICkgewoJdmFyIGVsZW1zLCBlbGVtLAoJCWkgPSAwLAoJCWZvdW5kID0gdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09IHN0cnVuZGVmaW5lZCA/IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyB8fCAiKiIgKSA6CgkJCXR5cGVvZiBjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwgIT09IHN0cnVuZGVmaW5lZCA/IGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCggdGFnIHx8ICIqIiApIDoKCQkJdW5kZWZpbmVkOwoKCWlmICggIWZvdW5kICkgewoJCWZvciAoIGZvdW5kID0gW10sIGVsZW1zID0gY29udGV4dC5jaGlsZE5vZGVzIHx8IGNvbnRleHQ7IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQkJaWYgKCAhdGFnIHx8IGpRdWVyeS5ub2RlTmFtZSggZWxlbSwgdGFnICkgKSB7CgkJCQlmb3VuZC5wdXNoKCBlbGVtICk7CgkJCX0gZWxzZSB7CgkJCQlqUXVlcnkubWVyZ2UoIGZvdW5kLCBnZXRBbGwoIGVsZW0sIHRhZyApICk7CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIHRhZyA9PT0gdW5kZWZpbmVkIHx8IHRhZyAmJiBqUXVlcnkubm9kZU5hbWUoIGNvbnRleHQsIHRhZyApID8KCQlqUXVlcnkubWVyZ2UoIFsgY29udGV4dCBdLCBmb3VuZCApIDoKCQlmb3VuZDsKfQoKLy8gVXNlZCBpbiBidWlsZEZyYWdtZW50LCBmaXhlcyB0aGUgZGVmYXVsdENoZWNrZWQgcHJvcGVydHkKZnVuY3Rpb24gZml4RGVmYXVsdENoZWNrZWQoIGVsZW0gKSB7CglpZiAoIHJjaGVja2FibGVUeXBlLnRlc3QoIGVsZW0udHlwZSApICkgewoJCWVsZW0uZGVmYXVsdENoZWNrZWQgPSBlbGVtLmNoZWNrZWQ7Cgl9Cn0KCi8vIFN1cHBvcnQ6IElFPDgKLy8gTWFuaXB1bGF0aW5nIHRhYmxlcyByZXF1aXJlcyBhIHRib2R5CmZ1bmN0aW9uIG1hbmlwdWxhdGlvblRhcmdldCggZWxlbSwgY29udGVudCApIHsKCXJldHVybiBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJ0YWJsZSIgKSAmJgoJCWpRdWVyeS5ub2RlTmFtZSggY29udGVudC5ub2RlVHlwZSAhPT0gMTEgPyBjb250ZW50IDogY29udGVudC5maXJzdENoaWxkLCAidHIiICkgPwoKCQllbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJ0Ym9keSIpWzBdIHx8CgkJCWVsZW0uYXBwZW5kQ2hpbGQoIGVsZW0ub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0Ym9keSIpICkgOgoJCWVsZW07Cn0KCi8vIFJlcGxhY2UvcmVzdG9yZSB0aGUgdHlwZSBhdHRyaWJ1dGUgb2Ygc2NyaXB0IGVsZW1lbnRzIGZvciBzYWZlIERPTSBtYW5pcHVsYXRpb24KZnVuY3Rpb24gZGlzYWJsZVNjcmlwdCggZWxlbSApIHsKCWVsZW0udHlwZSA9IChqUXVlcnkuZmluZC5hdHRyKCBlbGVtLCAidHlwZSIgKSAhPT0gbnVsbCkgKyAiLyIgKyBlbGVtLnR5cGU7CglyZXR1cm4gZWxlbTsKfQpmdW5jdGlvbiByZXN0b3JlU2NyaXB0KCBlbGVtICkgewoJdmFyIG1hdGNoID0gcnNjcmlwdFR5cGVNYXNrZWQuZXhlYyggZWxlbS50eXBlICk7CglpZiAoIG1hdGNoICkgewoJCWVsZW0udHlwZSA9IG1hdGNoWzFdOwoJfSBlbHNlIHsKCQllbGVtLnJlbW92ZUF0dHJpYnV0ZSgidHlwZSIpOwoJfQoJcmV0dXJuIGVsZW07Cn0KCi8vIE1hcmsgc2NyaXB0cyBhcyBoYXZpbmcgYWxyZWFkeSBiZWVuIGV2YWx1YXRlZApmdW5jdGlvbiBzZXRHbG9iYWxFdmFsKCBlbGVtcywgcmVmRWxlbWVudHMgKSB7Cgl2YXIgZWxlbSwKCQlpID0gMDsKCWZvciAoIDsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCWpRdWVyeS5fZGF0YSggZWxlbSwgImdsb2JhbEV2YWwiLCAhcmVmRWxlbWVudHMgfHwgalF1ZXJ5Ll9kYXRhKCByZWZFbGVtZW50c1tpXSwgImdsb2JhbEV2YWwiICkgKTsKCX0KfQoKZnVuY3Rpb24gY2xvbmVDb3B5RXZlbnQoIHNyYywgZGVzdCApIHsKCglpZiAoIGRlc3Qubm9kZVR5cGUgIT09IDEgfHwgIWpRdWVyeS5oYXNEYXRhKCBzcmMgKSApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHR5cGUsIGksIGwsCgkJb2xkRGF0YSA9IGpRdWVyeS5fZGF0YSggc3JjICksCgkJY3VyRGF0YSA9IGpRdWVyeS5fZGF0YSggZGVzdCwgb2xkRGF0YSApLAoJCWV2ZW50cyA9IG9sZERhdGEuZXZlbnRzOwoKCWlmICggZXZlbnRzICkgewoJCWRlbGV0ZSBjdXJEYXRhLmhhbmRsZTsKCQljdXJEYXRhLmV2ZW50cyA9IHt9OwoKCQlmb3IgKCB0eXBlIGluIGV2ZW50cyApIHsKCQkJZm9yICggaSA9IDAsIGwgPSBldmVudHNbIHR5cGUgXS5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCQlqUXVlcnkuZXZlbnQuYWRkKCBkZXN0LCB0eXBlLCBldmVudHNbIHR5cGUgXVsgaSBdICk7CgkJCX0KCQl9Cgl9CgoJLy8gbWFrZSB0aGUgY2xvbmVkIHB1YmxpYyBkYXRhIG9iamVjdCBhIGNvcHkgZnJvbSB0aGUgb3JpZ2luYWwKCWlmICggY3VyRGF0YS5kYXRhICkgewoJCWN1ckRhdGEuZGF0YSA9IGpRdWVyeS5leHRlbmQoIHt9LCBjdXJEYXRhLmRhdGEgKTsKCX0KfQoKZnVuY3Rpb24gZml4Q2xvbmVOb2RlSXNzdWVzKCBzcmMsIGRlc3QgKSB7Cgl2YXIgbm9kZU5hbWUsIGUsIGRhdGE7CgoJLy8gV2UgZG8gbm90IG5lZWQgdG8gZG8gYW55dGhpbmcgZm9yIG5vbi1FbGVtZW50cwoJaWYgKCBkZXN0Lm5vZGVUeXBlICE9PSAxICkgewoJCXJldHVybjsKCX0KCglub2RlTmFtZSA9IGRlc3Qubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCgkvLyBJRTYtOCBjb3BpZXMgZXZlbnRzIGJvdW5kIHZpYSBhdHRhY2hFdmVudCB3aGVuIHVzaW5nIGNsb25lTm9kZS4KCWlmICggIXN1cHBvcnQubm9DbG9uZUV2ZW50ICYmIGRlc3RbIGpRdWVyeS5leHBhbmRvIF0gKSB7CgkJZGF0YSA9IGpRdWVyeS5fZGF0YSggZGVzdCApOwoKCQlmb3IgKCBlIGluIGRhdGEuZXZlbnRzICkgewoJCQlqUXVlcnkucmVtb3ZlRXZlbnQoIGRlc3QsIGUsIGRhdGEuaGFuZGxlICk7CgkJfQoKCQkvLyBFdmVudCBkYXRhIGdldHMgcmVmZXJlbmNlZCBpbnN0ZWFkIG9mIGNvcGllZCBpZiB0aGUgZXhwYW5kbyBnZXRzIGNvcGllZCB0b28KCQlkZXN0LnJlbW92ZUF0dHJpYnV0ZSggalF1ZXJ5LmV4cGFuZG8gKTsKCX0KCgkvLyBJRSBibGFua3MgY29udGVudHMgd2hlbiBjbG9uaW5nIHNjcmlwdHMsIGFuZCB0cmllcyB0byBldmFsdWF0ZSBuZXdseS1zZXQgdGV4dAoJaWYgKCBub2RlTmFtZSA9PT0gInNjcmlwdCIgJiYgZGVzdC50ZXh0ICE9PSBzcmMudGV4dCApIHsKCQlkaXNhYmxlU2NyaXB0KCBkZXN0ICkudGV4dCA9IHNyYy50ZXh0OwoJCXJlc3RvcmVTY3JpcHQoIGRlc3QgKTsKCgkvLyBJRTYtMTAgaW1wcm9wZXJseSBjbG9uZXMgY2hpbGRyZW4gb2Ygb2JqZWN0IGVsZW1lbnRzIHVzaW5nIGNsYXNzaWQuCgkvLyBJRTEwIHRocm93cyBOb01vZGlmaWNhdGlvbkFsbG93ZWRFcnJvciBpZiBwYXJlbnQgaXMgbnVsbCwgIzEyMTMyLgoJfSBlbHNlIGlmICggbm9kZU5hbWUgPT09ICJvYmplY3QiICkgewoJCWlmICggZGVzdC5wYXJlbnROb2RlICkgewoJCQlkZXN0Lm91dGVySFRNTCA9IHNyYy5vdXRlckhUTUw7CgkJfQoKCQkvLyBUaGlzIHBhdGggYXBwZWFycyB1bmF2b2lkYWJsZSBmb3IgSUU5LiBXaGVuIGNsb25pbmcgYW4gb2JqZWN0CgkJLy8gZWxlbWVudCBpbiBJRTksIHRoZSBvdXRlckhUTUwgc3RyYXRlZ3kgYWJvdmUgaXMgbm90IHN1ZmZpY2llbnQuCgkJLy8gSWYgdGhlIHNyYyBoYXMgaW5uZXJIVE1MIGFuZCB0aGUgZGVzdGluYXRpb24gZG9lcyBub3QsCgkJLy8gY29weSB0aGUgc3JjLmlubmVySFRNTCBpbnRvIHRoZSBkZXN0LmlubmVySFRNTC4gIzEwMzI0CgkJaWYgKCBzdXBwb3J0Lmh0bWw1Q2xvbmUgJiYgKCBzcmMuaW5uZXJIVE1MICYmICFqUXVlcnkudHJpbShkZXN0LmlubmVySFRNTCkgKSApIHsKCQkJZGVzdC5pbm5lckhUTUwgPSBzcmMuaW5uZXJIVE1MOwoJCX0KCgl9IGVsc2UgaWYgKCBub2RlTmFtZSA9PT0gImlucHV0IiAmJiByY2hlY2thYmxlVHlwZS50ZXN0KCBzcmMudHlwZSApICkgewoJCS8vIElFNi04IGZhaWxzIHRvIHBlcnNpc3QgdGhlIGNoZWNrZWQgc3RhdGUgb2YgYSBjbG9uZWQgY2hlY2tib3gKCQkvLyBvciByYWRpbyBidXR0b24uIFdvcnNlLCBJRTYtNyBmYWlsIHRvIGdpdmUgdGhlIGNsb25lZCBlbGVtZW50CgkJLy8gYSBjaGVja2VkIGFwcGVhcmFuY2UgaWYgdGhlIGRlZmF1bHRDaGVja2VkIHZhbHVlIGlzbid0IGFsc28gc2V0CgoJCWRlc3QuZGVmYXVsdENoZWNrZWQgPSBkZXN0LmNoZWNrZWQgPSBzcmMuY2hlY2tlZDsKCgkJLy8gSUU2LTcgZ2V0IGNvbmZ1c2VkIGFuZCBlbmQgdXAgc2V0dGluZyB0aGUgdmFsdWUgb2YgYSBjbG9uZWQKCQkvLyBjaGVja2JveC9yYWRpbyBidXR0b24gdG8gYW4gZW1wdHkgc3RyaW5nIGluc3RlYWQgb2YgIm9uIgoJCWlmICggZGVzdC52YWx1ZSAhPT0gc3JjLnZhbHVlICkgewoJCQlkZXN0LnZhbHVlID0gc3JjLnZhbHVlOwoJCX0KCgkvLyBJRTYtOCBmYWlscyB0byByZXR1cm4gdGhlIHNlbGVjdGVkIG9wdGlvbiB0byB0aGUgZGVmYXVsdCBzZWxlY3RlZAoJLy8gc3RhdGUgd2hlbiBjbG9uaW5nIG9wdGlvbnMKCX0gZWxzZSBpZiAoIG5vZGVOYW1lID09PSAib3B0aW9uIiApIHsKCQlkZXN0LmRlZmF1bHRTZWxlY3RlZCA9IGRlc3Quc2VsZWN0ZWQgPSBzcmMuZGVmYXVsdFNlbGVjdGVkOwoKCS8vIElFNi04IGZhaWxzIHRvIHNldCB0aGUgZGVmYXVsdFZhbHVlIHRvIHRoZSBjb3JyZWN0IHZhbHVlIHdoZW4KCS8vIGNsb25pbmcgb3RoZXIgdHlwZXMgb2YgaW5wdXQgZmllbGRzCgl9IGVsc2UgaWYgKCBub2RlTmFtZSA9PT0gImlucHV0IiB8fCBub2RlTmFtZSA9PT0gInRleHRhcmVhIiApIHsKCQlkZXN0LmRlZmF1bHRWYWx1ZSA9IHNyYy5kZWZhdWx0VmFsdWU7Cgl9Cn0KCmpRdWVyeS5leHRlbmQoewoJY2xvbmU6IGZ1bmN0aW9uKCBlbGVtLCBkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cyApIHsKCQl2YXIgZGVzdEVsZW1lbnRzLCBub2RlLCBjbG9uZSwgaSwgc3JjRWxlbWVudHMsCgkJCWluUGFnZSA9IGpRdWVyeS5jb250YWlucyggZWxlbS5vd25lckRvY3VtZW50LCBlbGVtICk7CgoJCWlmICggc3VwcG9ydC5odG1sNUNsb25lIHx8IGpRdWVyeS5pc1hNTERvYyhlbGVtKSB8fCAhcm5vc2hpbWNhY2hlLnRlc3QoICI8IiArIGVsZW0ubm9kZU5hbWUgKyAiPiIgKSApIHsKCQkJY2xvbmUgPSBlbGVtLmNsb25lTm9kZSggdHJ1ZSApOwoKCQkvLyBJRTw9OCBkb2VzIG5vdCBwcm9wZXJseSBjbG9uZSBkZXRhY2hlZCwgdW5rbm93biBlbGVtZW50IG5vZGVzCgkJfSBlbHNlIHsKCQkJZnJhZ21lbnREaXYuaW5uZXJIVE1MID0gZWxlbS5vdXRlckhUTUw7CgkJCWZyYWdtZW50RGl2LnJlbW92ZUNoaWxkKCBjbG9uZSA9IGZyYWdtZW50RGl2LmZpcnN0Q2hpbGQgKTsKCQl9CgoJCWlmICggKCFzdXBwb3J0Lm5vQ2xvbmVFdmVudCB8fCAhc3VwcG9ydC5ub0Nsb25lQ2hlY2tlZCkgJiYKCQkJCShlbGVtLm5vZGVUeXBlID09PSAxIHx8IGVsZW0ubm9kZVR5cGUgPT09IDExKSAmJiAhalF1ZXJ5LmlzWE1MRG9jKGVsZW0pICkgewoKCQkJLy8gV2UgZXNjaGV3IFNpenpsZSBoZXJlIGZvciBwZXJmb3JtYW5jZSByZWFzb25zOiBodHRwOi8vanNwZXJmLmNvbS9nZXRhbGwtdnMtc2l6emxlLzIKCQkJZGVzdEVsZW1lbnRzID0gZ2V0QWxsKCBjbG9uZSApOwoJCQlzcmNFbGVtZW50cyA9IGdldEFsbCggZWxlbSApOwoKCQkJLy8gRml4IGFsbCBJRSBjbG9uaW5nIGlzc3VlcwoJCQlmb3IgKCBpID0gMDsgKG5vZGUgPSBzcmNFbGVtZW50c1tpXSkgIT0gbnVsbDsgKytpICkgewoJCQkJLy8gRW5zdXJlIHRoYXQgdGhlIGRlc3RpbmF0aW9uIG5vZGUgaXMgbm90IG51bGw7IEZpeGVzICM5NTg3CgkJCQlpZiAoIGRlc3RFbGVtZW50c1tpXSApIHsKCQkJCQlmaXhDbG9uZU5vZGVJc3N1ZXMoIG5vZGUsIGRlc3RFbGVtZW50c1tpXSApOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBDb3B5IHRoZSBldmVudHMgZnJvbSB0aGUgb3JpZ2luYWwgdG8gdGhlIGNsb25lCgkJaWYgKCBkYXRhQW5kRXZlbnRzICkgewoJCQlpZiAoIGRlZXBEYXRhQW5kRXZlbnRzICkgewoJCQkJc3JjRWxlbWVudHMgPSBzcmNFbGVtZW50cyB8fCBnZXRBbGwoIGVsZW0gKTsKCQkJCWRlc3RFbGVtZW50cyA9IGRlc3RFbGVtZW50cyB8fCBnZXRBbGwoIGNsb25lICk7CgoJCQkJZm9yICggaSA9IDA7IChub2RlID0gc3JjRWxlbWVudHNbaV0pICE9IG51bGw7IGkrKyApIHsKCQkJCQljbG9uZUNvcHlFdmVudCggbm9kZSwgZGVzdEVsZW1lbnRzW2ldICk7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQljbG9uZUNvcHlFdmVudCggZWxlbSwgY2xvbmUgKTsKCQkJfQoJCX0KCgkJLy8gUHJlc2VydmUgc2NyaXB0IGV2YWx1YXRpb24gaGlzdG9yeQoJCWRlc3RFbGVtZW50cyA9IGdldEFsbCggY2xvbmUsICJzY3JpcHQiICk7CgkJaWYgKCBkZXN0RWxlbWVudHMubGVuZ3RoID4gMCApIHsKCQkJc2V0R2xvYmFsRXZhbCggZGVzdEVsZW1lbnRzLCAhaW5QYWdlICYmIGdldEFsbCggZWxlbSwgInNjcmlwdCIgKSApOwoJCX0KCgkJZGVzdEVsZW1lbnRzID0gc3JjRWxlbWVudHMgPSBub2RlID0gbnVsbDsKCgkJLy8gUmV0dXJuIHRoZSBjbG9uZWQgc2V0CgkJcmV0dXJuIGNsb25lOwoJfSwKCglidWlsZEZyYWdtZW50OiBmdW5jdGlvbiggZWxlbXMsIGNvbnRleHQsIHNjcmlwdHMsIHNlbGVjdGlvbiApIHsKCQl2YXIgaiwgZWxlbSwgY29udGFpbnMsCgkJCXRtcCwgdGFnLCB0Ym9keSwgd3JhcCwKCQkJbCA9IGVsZW1zLmxlbmd0aCwKCgkJCS8vIEVuc3VyZSBhIHNhZmUgZnJhZ21lbnQKCQkJc2FmZSA9IGNyZWF0ZVNhZmVGcmFnbWVudCggY29udGV4dCApLAoKCQkJbm9kZXMgPSBbXSwKCQkJaSA9IDA7CgoJCWZvciAoIDsgaSA8IGw7IGkrKyApIHsKCQkJZWxlbSA9IGVsZW1zWyBpIF07CgoJCQlpZiAoIGVsZW0gfHwgZWxlbSA9PT0gMCApIHsKCgkJCQkvLyBBZGQgbm9kZXMgZGlyZWN0bHkKCQkJCWlmICggalF1ZXJ5LnR5cGUoIGVsZW0gKSA9PT0gIm9iamVjdCIgKSB7CgkJCQkJalF1ZXJ5Lm1lcmdlKCBub2RlcywgZWxlbS5ub2RlVHlwZSA/IFsgZWxlbSBdIDogZWxlbSApOwoKCQkJCS8vIENvbnZlcnQgbm9uLWh0bWwgaW50byBhIHRleHQgbm9kZQoJCQkJfSBlbHNlIGlmICggIXJodG1sLnRlc3QoIGVsZW0gKSApIHsKCQkJCQlub2Rlcy5wdXNoKCBjb250ZXh0LmNyZWF0ZVRleHROb2RlKCBlbGVtICkgKTsKCgkJCQkvLyBDb252ZXJ0IGh0bWwgaW50byBET00gbm9kZXMKCQkJCX0gZWxzZSB7CgkJCQkJdG1wID0gdG1wIHx8IHNhZmUuYXBwZW5kQ2hpbGQoIGNvbnRleHQuY3JlYXRlRWxlbWVudCgiZGl2IikgKTsKCgkJCQkJLy8gRGVzZXJpYWxpemUgYSBzdGFuZGFyZCByZXByZXNlbnRhdGlvbgoJCQkJCXRhZyA9IChydGFnTmFtZS5leGVjKCBlbGVtICkgfHwgWyAiIiwgIiIgXSlbIDEgXS50b0xvd2VyQ2FzZSgpOwoJCQkJCXdyYXAgPSB3cmFwTWFwWyB0YWcgXSB8fCB3cmFwTWFwLl9kZWZhdWx0OwoKCQkJCQl0bXAuaW5uZXJIVE1MID0gd3JhcFsxXSArIGVsZW0ucmVwbGFjZSggcnhodG1sVGFnLCAiPCQxPjwvJDI+IiApICsgd3JhcFsyXTsKCgkJCQkJLy8gRGVzY2VuZCB0aHJvdWdoIHdyYXBwZXJzIHRvIHRoZSByaWdodCBjb250ZW50CgkJCQkJaiA9IHdyYXBbMF07CgkJCQkJd2hpbGUgKCBqLS0gKSB7CgkJCQkJCXRtcCA9IHRtcC5sYXN0Q2hpbGQ7CgkJCQkJfQoKCQkJCQkvLyBNYW51YWxseSBhZGQgbGVhZGluZyB3aGl0ZXNwYWNlIHJlbW92ZWQgYnkgSUUKCQkJCQlpZiAoICFzdXBwb3J0LmxlYWRpbmdXaGl0ZXNwYWNlICYmIHJsZWFkaW5nV2hpdGVzcGFjZS50ZXN0KCBlbGVtICkgKSB7CgkJCQkJCW5vZGVzLnB1c2goIGNvbnRleHQuY3JlYXRlVGV4dE5vZGUoIHJsZWFkaW5nV2hpdGVzcGFjZS5leGVjKCBlbGVtIClbMF0gKSApOwoJCQkJCX0KCgkJCQkJLy8gUmVtb3ZlIElFJ3MgYXV0b2luc2VydGVkIDx0Ym9keT4gZnJvbSB0YWJsZSBmcmFnbWVudHMKCQkJCQlpZiAoICFzdXBwb3J0LnRib2R5ICkgewoKCQkJCQkJLy8gU3RyaW5nIHdhcyBhIDx0YWJsZT4sICptYXkqIGhhdmUgc3B1cmlvdXMgPHRib2R5PgoJCQkJCQllbGVtID0gdGFnID09PSAidGFibGUiICYmICFydGJvZHkudGVzdCggZWxlbSApID8KCQkJCQkJCXRtcC5maXJzdENoaWxkIDoKCgkJCQkJCQkvLyBTdHJpbmcgd2FzIGEgYmFyZSA8dGhlYWQ+IG9yIDx0Zm9vdD4KCQkJCQkJCXdyYXBbMV0gPT09ICI8dGFibGU+IiAmJiAhcnRib2R5LnRlc3QoIGVsZW0gKSA/CgkJCQkJCQkJdG1wIDoKCQkJCQkJCQkwOwoKCQkJCQkJaiA9IGVsZW0gJiYgZWxlbS5jaGlsZE5vZGVzLmxlbmd0aDsKCQkJCQkJd2hpbGUgKCBqLS0gKSB7CgkJCQkJCQlpZiAoIGpRdWVyeS5ub2RlTmFtZSggKHRib2R5ID0gZWxlbS5jaGlsZE5vZGVzW2pdKSwgInRib2R5IiApICYmICF0Ym9keS5jaGlsZE5vZGVzLmxlbmd0aCApIHsKCQkJCQkJCQllbGVtLnJlbW92ZUNoaWxkKCB0Ym9keSApOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoKCQkJCQlqUXVlcnkubWVyZ2UoIG5vZGVzLCB0bXAuY2hpbGROb2RlcyApOwoKCQkJCQkvLyBGaXggIzEyMzkyIGZvciBXZWJLaXQgYW5kIElFID4gOQoJCQkJCXRtcC50ZXh0Q29udGVudCA9ICIiOwoKCQkJCQkvLyBGaXggIzEyMzkyIGZvciBvbGRJRQoJCQkJCXdoaWxlICggdG1wLmZpcnN0Q2hpbGQgKSB7CgkJCQkJCXRtcC5yZW1vdmVDaGlsZCggdG1wLmZpcnN0Q2hpbGQgKTsKCQkJCQl9CgoJCQkJCS8vIFJlbWVtYmVyIHRoZSB0b3AtbGV2ZWwgY29udGFpbmVyIGZvciBwcm9wZXIgY2xlYW51cAoJCQkJCXRtcCA9IHNhZmUubGFzdENoaWxkOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBGaXggIzExMzU2OiBDbGVhciBlbGVtZW50cyBmcm9tIGZyYWdtZW50CgkJaWYgKCB0bXAgKSB7CgkJCXNhZmUucmVtb3ZlQ2hpbGQoIHRtcCApOwoJCX0KCgkJLy8gUmVzZXQgZGVmYXVsdENoZWNrZWQgZm9yIGFueSByYWRpb3MgYW5kIGNoZWNrYm94ZXMKCQkvLyBhYm91dCB0byBiZSBhcHBlbmRlZCB0byB0aGUgRE9NIGluIElFIDYvNyAoIzgwNjApCgkJaWYgKCAhc3VwcG9ydC5hcHBlbmRDaGVja2VkICkgewoJCQlqUXVlcnkuZ3JlcCggZ2V0QWxsKCBub2RlcywgImlucHV0IiApLCBmaXhEZWZhdWx0Q2hlY2tlZCApOwoJCX0KCgkJaSA9IDA7CgkJd2hpbGUgKCAoZWxlbSA9IG5vZGVzWyBpKysgXSkgKSB7CgoJCQkvLyAjNDA4NyAtIElmIG9yaWdpbiBhbmQgZGVzdGluYXRpb24gZWxlbWVudHMgYXJlIHRoZSBzYW1lLCBhbmQgdGhpcyBpcwoJCQkvLyB0aGF0IGVsZW1lbnQsIGRvIG5vdCBkbyBhbnl0aGluZwoJCQlpZiAoIHNlbGVjdGlvbiAmJiBqUXVlcnkuaW5BcnJheSggZWxlbSwgc2VsZWN0aW9uICkgIT09IC0xICkgewoJCQkJY29udGludWU7CgkJCX0KCgkJCWNvbnRhaW5zID0galF1ZXJ5LmNvbnRhaW5zKCBlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0gKTsKCgkJCS8vIEFwcGVuZCB0byBmcmFnbWVudAoJCQl0bXAgPSBnZXRBbGwoIHNhZmUuYXBwZW5kQ2hpbGQoIGVsZW0gKSwgInNjcmlwdCIgKTsKCgkJCS8vIFByZXNlcnZlIHNjcmlwdCBldmFsdWF0aW9uIGhpc3RvcnkKCQkJaWYgKCBjb250YWlucyApIHsKCQkJCXNldEdsb2JhbEV2YWwoIHRtcCApOwoJCQl9CgoJCQkvLyBDYXB0dXJlIGV4ZWN1dGFibGVzCgkJCWlmICggc2NyaXB0cyApIHsKCQkJCWogPSAwOwoJCQkJd2hpbGUgKCAoZWxlbSA9IHRtcFsgaisrIF0pICkgewoJCQkJCWlmICggcnNjcmlwdFR5cGUudGVzdCggZWxlbS50eXBlIHx8ICIiICkgKSB7CgkJCQkJCXNjcmlwdHMucHVzaCggZWxlbSApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJdG1wID0gbnVsbDsKCgkJcmV0dXJuIHNhZmU7Cgl9LAoKCWNsZWFuRGF0YTogZnVuY3Rpb24oIGVsZW1zLCAvKiBpbnRlcm5hbCAqLyBhY2NlcHREYXRhICkgewoJCXZhciBlbGVtLCB0eXBlLCBpZCwgZGF0YSwKCQkJaSA9IDAsCgkJCWludGVybmFsS2V5ID0galF1ZXJ5LmV4cGFuZG8sCgkJCWNhY2hlID0galF1ZXJ5LmNhY2hlLAoJCQlkZWxldGVFeHBhbmRvID0gc3VwcG9ydC5kZWxldGVFeHBhbmRvLAoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWw7CgoJCWZvciAoIDsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCQlpZiAoIGFjY2VwdERhdGEgfHwgalF1ZXJ5LmFjY2VwdERhdGEoIGVsZW0gKSApIHsKCgkJCQlpZCA9IGVsZW1bIGludGVybmFsS2V5IF07CgkJCQlkYXRhID0gaWQgJiYgY2FjaGVbIGlkIF07CgoJCQkJaWYgKCBkYXRhICkgewoJCQkJCWlmICggZGF0YS5ldmVudHMgKSB7CgkJCQkJCWZvciAoIHR5cGUgaW4gZGF0YS5ldmVudHMgKSB7CgkJCQkJCQlpZiAoIHNwZWNpYWxbIHR5cGUgXSApIHsKCQkJCQkJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCBlbGVtLCB0eXBlICk7CgoJCQkJCQkJLy8gVGhpcyBpcyBhIHNob3J0Y3V0IHRvIGF2b2lkIGpRdWVyeS5ldmVudC5yZW1vdmUncyBvdmVyaGVhZAoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlqUXVlcnkucmVtb3ZlRXZlbnQoIGVsZW0sIHR5cGUsIGRhdGEuaGFuZGxlICk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgoJCQkJCS8vIFJlbW92ZSBjYWNoZSBvbmx5IGlmIGl0IHdhcyBub3QgYWxyZWFkeSByZW1vdmVkIGJ5IGpRdWVyeS5ldmVudC5yZW1vdmUKCQkJCQlpZiAoIGNhY2hlWyBpZCBdICkgewoKCQkJCQkJZGVsZXRlIGNhY2hlWyBpZCBdOwoKCQkJCQkJLy8gSUUgZG9lcyBub3QgYWxsb3cgdXMgdG8gZGVsZXRlIGV4cGFuZG8gcHJvcGVydGllcyBmcm9tIG5vZGVzLAoJCQkJCQkvLyBub3IgZG9lcyBpdCBoYXZlIGEgcmVtb3ZlQXR0cmlidXRlIGZ1bmN0aW9uIG9uIERvY3VtZW50IG5vZGVzOwoJCQkJCQkvLyB3ZSBtdXN0IGhhbmRsZSBhbGwgb2YgdGhlc2UgY2FzZXMKCQkJCQkJaWYgKCBkZWxldGVFeHBhbmRvICkgewoJCQkJCQkJZGVsZXRlIGVsZW1bIGludGVybmFsS2V5IF07CgoJCQkJCQl9IGVsc2UgaWYgKCB0eXBlb2YgZWxlbS5yZW1vdmVBdHRyaWJ1dGUgIT09IHN0cnVuZGVmaW5lZCApIHsKCQkJCQkJCWVsZW0ucmVtb3ZlQXR0cmlidXRlKCBpbnRlcm5hbEtleSApOwoKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWVsZW1bIGludGVybmFsS2V5IF0gPSBudWxsOwoJCQkJCQl9CgoJCQkJCQlkZWxldGVkSWRzLnB1c2goIGlkICk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJfQp9KTsKCmpRdWVyeS5mbi5leHRlbmQoewoJdGV4dDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXJldHVybiBhY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPwoJCQkJalF1ZXJ5LnRleHQoIHRoaXMgKSA6CgkJCQl0aGlzLmVtcHR5KCkuYXBwZW5kKCAoIHRoaXNbMF0gJiYgdGhpc1swXS5vd25lckRvY3VtZW50IHx8IGRvY3VtZW50ICkuY3JlYXRlVGV4dE5vZGUoIHZhbHVlICkgKTsKCQl9LCBudWxsLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCApOwoJfSwKCglhcHBlbmQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmRvbU1hbmlwKCBhcmd1bWVudHMsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQlpZiAoIHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gOSApIHsKCQkJCXZhciB0YXJnZXQgPSBtYW5pcHVsYXRpb25UYXJnZXQoIHRoaXMsIGVsZW0gKTsKCQkJCXRhcmdldC5hcHBlbmRDaGlsZCggZWxlbSApOwoJCQl9CgkJfSk7Cgl9LAoKCXByZXBlbmQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmRvbU1hbmlwKCBhcmd1bWVudHMsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQlpZiAoIHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gOSApIHsKCQkJCXZhciB0YXJnZXQgPSBtYW5pcHVsYXRpb25UYXJnZXQoIHRoaXMsIGVsZW0gKTsKCQkJCXRhcmdldC5pbnNlcnRCZWZvcmUoIGVsZW0sIHRhcmdldC5maXJzdENoaWxkICk7CgkJCX0KCQl9KTsKCX0sCgoJYmVmb3JlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5kb21NYW5pcCggYXJndW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJaWYgKCB0aGlzLnBhcmVudE5vZGUgKSB7CgkJCQl0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBlbGVtLCB0aGlzICk7CgkJCX0KCQl9KTsKCX0sCgoJYWZ0ZXI6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmRvbU1hbmlwKCBhcmd1bWVudHMsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQlpZiAoIHRoaXMucGFyZW50Tm9kZSApIHsKCQkJCXRoaXMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoIGVsZW0sIHRoaXMubmV4dFNpYmxpbmcgKTsKCQkJfQoJCX0pOwoJfSwKCglyZW1vdmU6IGZ1bmN0aW9uKCBzZWxlY3Rvciwga2VlcERhdGEgLyogSW50ZXJuYWwgVXNlIE9ubHkgKi8gKSB7CgkJdmFyIGVsZW0sCgkJCWVsZW1zID0gc2VsZWN0b3IgPyBqUXVlcnkuZmlsdGVyKCBzZWxlY3RvciwgdGhpcyApIDogdGhpcywKCQkJaSA9IDA7CgoJCWZvciAoIDsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoKCQkJaWYgKCAha2VlcERhdGEgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCWpRdWVyeS5jbGVhbkRhdGEoIGdldEFsbCggZWxlbSApICk7CgkJCX0KCgkJCWlmICggZWxlbS5wYXJlbnROb2RlICkgewoJCQkJaWYgKCBrZWVwRGF0YSAmJiBqUXVlcnkuY29udGFpbnMoIGVsZW0ub3duZXJEb2N1bWVudCwgZWxlbSApICkgewoJCQkJCXNldEdsb2JhbEV2YWwoIGdldEFsbCggZWxlbSwgInNjcmlwdCIgKSApOwoJCQkJfQoJCQkJZWxlbS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCBlbGVtICk7CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgllbXB0eTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW0sCgkJCWkgPSAwOwoKCQlmb3IgKCA7IChlbGVtID0gdGhpc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCQkvLyBSZW1vdmUgZWxlbWVudCBub2RlcyBhbmQgcHJldmVudCBtZW1vcnkgbGVha3MKCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJalF1ZXJ5LmNsZWFuRGF0YSggZ2V0QWxsKCBlbGVtLCBmYWxzZSApICk7CgkJCX0KCgkJCS8vIFJlbW92ZSBhbnkgcmVtYWluaW5nIG5vZGVzCgkJCXdoaWxlICggZWxlbS5maXJzdENoaWxkICkgewoJCQkJZWxlbS5yZW1vdmVDaGlsZCggZWxlbS5maXJzdENoaWxkICk7CgkJCX0KCgkJCS8vIElmIHRoaXMgaXMgYSBzZWxlY3QsIGVuc3VyZSB0aGF0IGl0IGRpc3BsYXlzIGVtcHR5ICgjMTIzMzYpCgkJCS8vIFN1cHBvcnQ6IElFPDkKCQkJaWYgKCBlbGVtLm9wdGlvbnMgJiYgalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAic2VsZWN0IiApICkgewoJCQkJZWxlbS5vcHRpb25zLmxlbmd0aCA9IDA7CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgljbG9uZTogZnVuY3Rpb24oIGRhdGFBbmRFdmVudHMsIGRlZXBEYXRhQW5kRXZlbnRzICkgewoJCWRhdGFBbmRFdmVudHMgPSBkYXRhQW5kRXZlbnRzID09IG51bGwgPyBmYWxzZSA6IGRhdGFBbmRFdmVudHM7CgkJZGVlcERhdGFBbmRFdmVudHMgPSBkZWVwRGF0YUFuZEV2ZW50cyA9PSBudWxsID8gZGF0YUFuZEV2ZW50cyA6IGRlZXBEYXRhQW5kRXZlbnRzOwoKCQlyZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24oKSB7CgkJCXJldHVybiBqUXVlcnkuY2xvbmUoIHRoaXMsIGRhdGFBbmRFdmVudHMsIGRlZXBEYXRhQW5kRXZlbnRzICk7CgkJfSk7Cgl9LAoKCWh0bWw6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlyZXR1cm4gYWNjZXNzKCB0aGlzLCBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXZhciBlbGVtID0gdGhpc1sgMCBdIHx8IHt9LAoJCQkJaSA9IDAsCgkJCQlsID0gdGhpcy5sZW5ndGg7CgoJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gZWxlbS5ub2RlVHlwZSA9PT0gMSA/CgkJCQkJZWxlbS5pbm5lckhUTUwucmVwbGFjZSggcmlubGluZWpRdWVyeSwgIiIgKSA6CgkJCQkJdW5kZWZpbmVkOwoJCQl9CgoJCQkvLyBTZWUgaWYgd2UgY2FuIHRha2UgYSBzaG9ydGN1dCBhbmQganVzdCB1c2UgaW5uZXJIVE1MCgkJCWlmICggdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiAmJiAhcm5vSW5uZXJodG1sLnRlc3QoIHZhbHVlICkgJiYKCQkJCSggc3VwcG9ydC5odG1sU2VyaWFsaXplIHx8ICFybm9zaGltY2FjaGUudGVzdCggdmFsdWUgKSAgKSAmJgoJCQkJKCBzdXBwb3J0LmxlYWRpbmdXaGl0ZXNwYWNlIHx8ICFybGVhZGluZ1doaXRlc3BhY2UudGVzdCggdmFsdWUgKSApICYmCgkJCQkhd3JhcE1hcFsgKHJ0YWdOYW1lLmV4ZWMoIHZhbHVlICkgfHwgWyAiIiwgIiIgXSlbIDEgXS50b0xvd2VyQ2FzZSgpIF0gKSB7CgoJCQkJdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKCByeGh0bWxUYWcsICI8JDE+PC8kMj4iICk7CgoJCQkJdHJ5IHsKCQkJCQlmb3IgKDsgaSA8IGw7IGkrKyApIHsKCQkJCQkJLy8gUmVtb3ZlIGVsZW1lbnQgbm9kZXMgYW5kIHByZXZlbnQgbWVtb3J5IGxlYWtzCgkJCQkJCWVsZW0gPSB0aGlzW2ldIHx8IHt9OwoJCQkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJCQlqUXVlcnkuY2xlYW5EYXRhKCBnZXRBbGwoIGVsZW0sIGZhbHNlICkgKTsKCQkJCQkJCWVsZW0uaW5uZXJIVE1MID0gdmFsdWU7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWVsZW0gPSAwOwoKCQkJCS8vIElmIHVzaW5nIGlubmVySFRNTCB0aHJvd3MgYW4gZXhjZXB0aW9uLCB1c2UgdGhlIGZhbGxiYWNrIG1ldGhvZAoJCQkJfSBjYXRjaChlKSB7fQoJCQl9CgoJCQlpZiAoIGVsZW0gKSB7CgkJCQl0aGlzLmVtcHR5KCkuYXBwZW5kKCB2YWx1ZSApOwoJCQl9CgkJfSwgbnVsbCwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggKTsKCX0sCgoJcmVwbGFjZVdpdGg6IGZ1bmN0aW9uKCkgewoJCXZhciBhcmcgPSBhcmd1bWVudHNbIDAgXTsKCgkJLy8gTWFrZSB0aGUgY2hhbmdlcywgcmVwbGFjaW5nIGVhY2ggY29udGV4dCBlbGVtZW50IHdpdGggdGhlIG5ldyBjb250ZW50CgkJdGhpcy5kb21NYW5pcCggYXJndW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJYXJnID0gdGhpcy5wYXJlbnROb2RlOwoKCQkJalF1ZXJ5LmNsZWFuRGF0YSggZ2V0QWxsKCB0aGlzICkgKTsKCgkJCWlmICggYXJnICkgewoJCQkJYXJnLnJlcGxhY2VDaGlsZCggZWxlbSwgdGhpcyApOwoJCQl9CgkJfSk7CgoJCS8vIEZvcmNlIHJlbW92YWwgaWYgdGhlcmUgd2FzIG5vIG5ldyBjb250ZW50IChlLmcuLCBmcm9tIGVtcHR5IGFyZ3VtZW50cykKCQlyZXR1cm4gYXJnICYmIChhcmcubGVuZ3RoIHx8IGFyZy5ub2RlVHlwZSkgPyB0aGlzIDogdGhpcy5yZW1vdmUoKTsKCX0sCgoJZGV0YWNoOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMucmVtb3ZlKCBzZWxlY3RvciwgdHJ1ZSApOwoJfSwKCglkb21NYW5pcDogZnVuY3Rpb24oIGFyZ3MsIGNhbGxiYWNrICkgewoKCQkvLyBGbGF0dGVuIGFueSBuZXN0ZWQgYXJyYXlzCgkJYXJncyA9IGNvbmNhdC5hcHBseSggW10sIGFyZ3MgKTsKCgkJdmFyIGZpcnN0LCBub2RlLCBoYXNTY3JpcHRzLAoJCQlzY3JpcHRzLCBkb2MsIGZyYWdtZW50LAoJCQlpID0gMCwKCQkJbCA9IHRoaXMubGVuZ3RoLAoJCQlzZXQgPSB0aGlzLAoJCQlpTm9DbG9uZSA9IGwgLSAxLAoJCQl2YWx1ZSA9IGFyZ3NbMF0sCgkJCWlzRnVuY3Rpb24gPSBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKTsKCgkJLy8gV2UgY2FuJ3QgY2xvbmVOb2RlIGZyYWdtZW50cyB0aGF0IGNvbnRhaW4gY2hlY2tlZCwgaW4gV2ViS2l0CgkJaWYgKCBpc0Z1bmN0aW9uIHx8CgkJCQkoIGwgPiAxICYmIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYKCQkJCQkhc3VwcG9ydC5jaGVja0Nsb25lICYmIHJjaGVja2VkLnRlc3QoIHZhbHVlICkgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaW5kZXggKSB7CgkJCQl2YXIgc2VsZiA9IHNldC5lcSggaW5kZXggKTsKCQkJCWlmICggaXNGdW5jdGlvbiApIHsKCQkJCQlhcmdzWzBdID0gdmFsdWUuY2FsbCggdGhpcywgaW5kZXgsIHNlbGYuaHRtbCgpICk7CgkJCQl9CgkJCQlzZWxmLmRvbU1hbmlwKCBhcmdzLCBjYWxsYmFjayApOwoJCQl9KTsKCQl9CgoJCWlmICggbCApIHsKCQkJZnJhZ21lbnQgPSBqUXVlcnkuYnVpbGRGcmFnbWVudCggYXJncywgdGhpc1sgMCBdLm93bmVyRG9jdW1lbnQsIGZhbHNlLCB0aGlzICk7CgkJCWZpcnN0ID0gZnJhZ21lbnQuZmlyc3RDaGlsZDsKCgkJCWlmICggZnJhZ21lbnQuY2hpbGROb2Rlcy5sZW5ndGggPT09IDEgKSB7CgkJCQlmcmFnbWVudCA9IGZpcnN0OwoJCQl9CgoJCQlpZiAoIGZpcnN0ICkgewoJCQkJc2NyaXB0cyA9IGpRdWVyeS5tYXAoIGdldEFsbCggZnJhZ21lbnQsICJzY3JpcHQiICksIGRpc2FibGVTY3JpcHQgKTsKCQkJCWhhc1NjcmlwdHMgPSBzY3JpcHRzLmxlbmd0aDsKCgkJCQkvLyBVc2UgdGhlIG9yaWdpbmFsIGZyYWdtZW50IGZvciB0aGUgbGFzdCBpdGVtIGluc3RlYWQgb2YgdGhlIGZpcnN0IGJlY2F1c2UgaXQgY2FuIGVuZCB1cAoJCQkJLy8gYmVpbmcgZW1wdGllZCBpbmNvcnJlY3RseSBpbiBjZXJ0YWluIHNpdHVhdGlvbnMgKCM4MDcwKS4KCQkJCWZvciAoIDsgaSA8IGw7IGkrKyApIHsKCQkJCQlub2RlID0gZnJhZ21lbnQ7CgoJCQkJCWlmICggaSAhPT0gaU5vQ2xvbmUgKSB7CgkJCQkJCW5vZGUgPSBqUXVlcnkuY2xvbmUoIG5vZGUsIHRydWUsIHRydWUgKTsKCgkJCQkJCS8vIEtlZXAgcmVmZXJlbmNlcyB0byBjbG9uZWQgc2NyaXB0cyBmb3IgbGF0ZXIgcmVzdG9yYXRpb24KCQkJCQkJaWYgKCBoYXNTY3JpcHRzICkgewoJCQkJCQkJalF1ZXJ5Lm1lcmdlKCBzY3JpcHRzLCBnZXRBbGwoIG5vZGUsICJzY3JpcHQiICkgKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJY2FsbGJhY2suY2FsbCggdGhpc1tpXSwgbm9kZSwgaSApOwoJCQkJfQoKCQkJCWlmICggaGFzU2NyaXB0cyApIHsKCQkJCQlkb2MgPSBzY3JpcHRzWyBzY3JpcHRzLmxlbmd0aCAtIDEgXS5vd25lckRvY3VtZW50OwoKCQkJCQkvLyBSZWVuYWJsZSBzY3JpcHRzCgkJCQkJalF1ZXJ5Lm1hcCggc2NyaXB0cywgcmVzdG9yZVNjcmlwdCApOwoKCQkJCQkvLyBFdmFsdWF0ZSBleGVjdXRhYmxlIHNjcmlwdHMgb24gZmlyc3QgZG9jdW1lbnQgaW5zZXJ0aW9uCgkJCQkJZm9yICggaSA9IDA7IGkgPCBoYXNTY3JpcHRzOyBpKysgKSB7CgkJCQkJCW5vZGUgPSBzY3JpcHRzWyBpIF07CgkJCQkJCWlmICggcnNjcmlwdFR5cGUudGVzdCggbm9kZS50eXBlIHx8ICIiICkgJiYKCQkJCQkJCSFqUXVlcnkuX2RhdGEoIG5vZGUsICJnbG9iYWxFdmFsIiApICYmIGpRdWVyeS5jb250YWlucyggZG9jLCBub2RlICkgKSB7CgoJCQkJCQkJaWYgKCBub2RlLnNyYyApIHsKCQkJCQkJCQkvLyBPcHRpb25hbCBBSkFYIGRlcGVuZGVuY3ksIGJ1dCB3b24ndCBydW4gc2NyaXB0cyBpZiBub3QgcHJlc2VudAoJCQkJCQkJCWlmICggalF1ZXJ5Ll9ldmFsVXJsICkgewoJCQkJCQkJCQlqUXVlcnkuX2V2YWxVcmwoIG5vZGUuc3JjICk7CgkJCQkJCQkJfQoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlqUXVlcnkuZ2xvYmFsRXZhbCggKCBub2RlLnRleHQgfHwgbm9kZS50ZXh0Q29udGVudCB8fCBub2RlLmlubmVySFRNTCB8fCAiIiApLnJlcGxhY2UoIHJjbGVhblNjcmlwdCwgIiIgKSApOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJfQoKCQkJCS8vIEZpeCAjMTE4MDk6IEF2b2lkIGxlYWtpbmcgbWVtb3J5CgkJCQlmcmFnbWVudCA9IGZpcnN0ID0gbnVsbDsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9Cn0pOwoKalF1ZXJ5LmVhY2goewoJYXBwZW5kVG86ICJhcHBlbmQiLAoJcHJlcGVuZFRvOiAicHJlcGVuZCIsCglpbnNlcnRCZWZvcmU6ICJiZWZvcmUiLAoJaW5zZXJ0QWZ0ZXI6ICJhZnRlciIsCglyZXBsYWNlQWxsOiAicmVwbGFjZVdpdGgiCn0sIGZ1bmN0aW9uKCBuYW1lLCBvcmlnaW5hbCApIHsKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXZhciBlbGVtcywKCQkJaSA9IDAsCgkJCXJldCA9IFtdLAoJCQlpbnNlcnQgPSBqUXVlcnkoIHNlbGVjdG9yICksCgkJCWxhc3QgPSBpbnNlcnQubGVuZ3RoIC0gMTsKCgkJZm9yICggOyBpIDw9IGxhc3Q7IGkrKyApIHsKCQkJZWxlbXMgPSBpID09PSBsYXN0ID8gdGhpcyA6IHRoaXMuY2xvbmUodHJ1ZSk7CgkJCWpRdWVyeSggaW5zZXJ0W2ldIClbIG9yaWdpbmFsIF0oIGVsZW1zICk7CgoJCQkvLyBNb2Rlcm4gYnJvd3NlcnMgY2FuIGFwcGx5IGpRdWVyeSBjb2xsZWN0aW9ucyBhcyBhcnJheXMsIGJ1dCBvbGRJRSBuZWVkcyBhIC5nZXQoKQoJCQlwdXNoLmFwcGx5KCByZXQsIGVsZW1zLmdldCgpICk7CgkJfQoKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHJldCApOwoJfTsKfSk7CgoKdmFyIGlmcmFtZSwKCWVsZW1kaXNwbGF5ID0ge307CgovKioKICogUmV0cmlldmUgdGhlIGFjdHVhbCBkaXNwbGF5IG9mIGEgZWxlbWVudAogKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBub2RlTmFtZSBvZiB0aGUgZWxlbWVudAogKiBAcGFyYW0ge09iamVjdH0gZG9jIERvY3VtZW50IG9iamVjdAogKi8KLy8gQ2FsbGVkIG9ubHkgZnJvbSB3aXRoaW4gZGVmYXVsdERpc3BsYXkKZnVuY3Rpb24gYWN0dWFsRGlzcGxheSggbmFtZSwgZG9jICkgewoJdmFyIGVsZW0gPSBqUXVlcnkoIGRvYy5jcmVhdGVFbGVtZW50KCBuYW1lICkgKS5hcHBlbmRUbyggZG9jLmJvZHkgKSwKCgkJLy8gZ2V0RGVmYXVsdENvbXB1dGVkU3R5bGUgbWlnaHQgYmUgcmVsaWFibHkgdXNlZCBvbmx5IG9uIGF0dGFjaGVkIGVsZW1lbnQKCQlkaXNwbGF5ID0gd2luZG93LmdldERlZmF1bHRDb21wdXRlZFN0eWxlID8KCgkJCS8vIFVzZSBvZiB0aGlzIG1ldGhvZCBpcyBhIHRlbXBvcmFyeSBmaXggKG1vcmUgbGlrZSBvcHRtaXphdGlvbikgdW50aWwgc29tZXRoaW5nIGJldHRlciBjb21lcyBhbG9uZywKCQkJLy8gc2luY2UgaXQgd2FzIHJlbW92ZWQgZnJvbSBzcGVjaWZpY2F0aW9uIGFuZCBzdXBwb3J0ZWQgb25seSBpbiBGRgoJCQl3aW5kb3cuZ2V0RGVmYXVsdENvbXB1dGVkU3R5bGUoIGVsZW1bIDAgXSApLmRpc3BsYXkgOiBqUXVlcnkuY3NzKCBlbGVtWyAwIF0sICJkaXNwbGF5IiApOwoKCS8vIFdlIGRvbid0IGhhdmUgYW55IGRhdGEgc3RvcmVkIG9uIHRoZSBlbGVtZW50LAoJLy8gc28gdXNlICJkZXRhY2giIG1ldGhvZCBhcyBmYXN0IHdheSB0byBnZXQgcmlkIG9mIHRoZSBlbGVtZW50CgllbGVtLmRldGFjaCgpOwoKCXJldHVybiBkaXNwbGF5Owp9CgovKioKICogVHJ5IHRvIGRldGVybWluZSB0aGUgZGVmYXVsdCBkaXNwbGF5IHZhbHVlIG9mIGFuIGVsZW1lbnQKICogQHBhcmFtIHtTdHJpbmd9IG5vZGVOYW1lCiAqLwpmdW5jdGlvbiBkZWZhdWx0RGlzcGxheSggbm9kZU5hbWUgKSB7Cgl2YXIgZG9jID0gZG9jdW1lbnQsCgkJZGlzcGxheSA9IGVsZW1kaXNwbGF5WyBub2RlTmFtZSBdOwoKCWlmICggIWRpc3BsYXkgKSB7CgkJZGlzcGxheSA9IGFjdHVhbERpc3BsYXkoIG5vZGVOYW1lLCBkb2MgKTsKCgkJLy8gSWYgdGhlIHNpbXBsZSB3YXkgZmFpbHMsIHJlYWQgZnJvbSBpbnNpZGUgYW4gaWZyYW1lCgkJaWYgKCBkaXNwbGF5ID09PSAibm9uZSIgfHwgIWRpc3BsYXkgKSB7CgoJCQkvLyBVc2UgdGhlIGFscmVhZHktY3JlYXRlZCBpZnJhbWUgaWYgcG9zc2libGUKCQkJaWZyYW1lID0gKGlmcmFtZSB8fCBqUXVlcnkoICI8aWZyYW1lIGZyYW1lYm9yZGVyPScwJyB3aWR0aD0nMCcgaGVpZ2h0PScwJy8+IiApKS5hcHBlbmRUbyggZG9jLmRvY3VtZW50RWxlbWVudCApOwoKCQkJLy8gQWx3YXlzIHdyaXRlIGEgbmV3IEhUTUwgc2tlbGV0b24gc28gV2Via2l0IGFuZCBGaXJlZm94IGRvbid0IGNob2tlIG9uIHJldXNlCgkJCWRvYyA9ICggaWZyYW1lWyAwIF0uY29udGVudFdpbmRvdyB8fCBpZnJhbWVbIDAgXS5jb250ZW50RG9jdW1lbnQgKS5kb2N1bWVudDsKCgkJCS8vIFN1cHBvcnQ6IElFCgkJCWRvYy53cml0ZSgpOwoJCQlkb2MuY2xvc2UoKTsKCgkJCWRpc3BsYXkgPSBhY3R1YWxEaXNwbGF5KCBub2RlTmFtZSwgZG9jICk7CgkJCWlmcmFtZS5kZXRhY2goKTsKCQl9CgoJCS8vIFN0b3JlIHRoZSBjb3JyZWN0IGRlZmF1bHQgZGlzcGxheQoJCWVsZW1kaXNwbGF5WyBub2RlTmFtZSBdID0gZGlzcGxheTsKCX0KCglyZXR1cm4gZGlzcGxheTsKfQoKCihmdW5jdGlvbigpIHsKCXZhciBhLCBzaHJpbmtXcmFwQmxvY2tzVmFsLAoJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCgkJZGl2UmVzZXQgPQoJCQkiLXdlYmtpdC1ib3gtc2l6aW5nOmNvbnRlbnQtYm94Oy1tb3otYm94LXNpemluZzpjb250ZW50LWJveDtib3gtc2l6aW5nOmNvbnRlbnQtYm94OyIgKwoJCQkiZGlzcGxheTpibG9jaztwYWRkaW5nOjA7bWFyZ2luOjA7Ym9yZGVyOjAiOwoKCS8vIFNldHVwCglkaXYuaW5uZXJIVE1MID0gIiAgPGxpbmsvPjx0YWJsZT48L3RhYmxlPjxhIGhyZWY9Jy9hJz5hPC9hPjxpbnB1dCB0eXBlPSdjaGVja2JveCcvPiI7CglhID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCAiYSIgKVsgMCBdOwoKCWEuc3R5bGUuY3NzVGV4dCA9ICJmbG9hdDpsZWZ0O29wYWNpdHk6LjUiOwoKCS8vIE1ha2Ugc3VyZSB0aGF0IGVsZW1lbnQgb3BhY2l0eSBleGlzdHMKCS8vIChJRSB1c2VzIGZpbHRlciBpbnN0ZWFkKQoJLy8gVXNlIGEgcmVnZXggdG8gd29yayBhcm91bmQgYSBXZWJLaXQgaXNzdWUuIFNlZSAjNTE0NQoJc3VwcG9ydC5vcGFjaXR5ID0gL14wLjUvLnRlc3QoIGEuc3R5bGUub3BhY2l0eSApOwoKCS8vIFZlcmlmeSBzdHlsZSBmbG9hdCBleGlzdGVuY2UKCS8vIChJRSB1c2VzIHN0eWxlRmxvYXQgaW5zdGVhZCBvZiBjc3NGbG9hdCkKCXN1cHBvcnQuY3NzRmxvYXQgPSAhIWEuc3R5bGUuY3NzRmxvYXQ7CgoJZGl2LnN0eWxlLmJhY2tncm91bmRDbGlwID0gImNvbnRlbnQtYm94IjsKCWRpdi5jbG9uZU5vZGUoIHRydWUgKS5zdHlsZS5iYWNrZ3JvdW5kQ2xpcCA9ICIiOwoJc3VwcG9ydC5jbGVhckNsb25lU3R5bGUgPSBkaXYuc3R5bGUuYmFja2dyb3VuZENsaXAgPT09ICJjb250ZW50LWJveCI7CgoJLy8gTnVsbCBlbGVtZW50cyB0byBhdm9pZCBsZWFrcyBpbiBJRS4KCWEgPSBkaXYgPSBudWxsOwoKCXN1cHBvcnQuc2hyaW5rV3JhcEJsb2NrcyA9IGZ1bmN0aW9uKCkgewoJCXZhciBib2R5LCBjb250YWluZXIsIGRpdiwgY29udGFpbmVyU3R5bGVzOwoKCQlpZiAoIHNocmlua1dyYXBCbG9ja3NWYWwgPT0gbnVsbCApIHsKCQkJYm9keSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCAiYm9keSIgKVsgMCBdOwoJCQlpZiAoICFib2R5ICkgewoJCQkJLy8gVGVzdCBmaXJlZCB0b28gZWFybHkgb3IgaW4gYW4gdW5zdXBwb3J0ZWQgZW52aXJvbm1lbnQsIGV4aXQuCgkJCQlyZXR1cm47CgkJCX0KCgkJCWNvbnRhaW5lclN0eWxlcyA9ICJib3JkZXI6MDt3aWR0aDowO2hlaWdodDowO3Bvc2l0aW9uOmFic29sdXRlO3RvcDowO2xlZnQ6LTk5OTlweCI7CgkJCWNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgkJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgoJCQlib2R5LmFwcGVuZENoaWxkKCBjb250YWluZXIgKS5hcHBlbmRDaGlsZCggZGl2ICk7CgoJCQkvLyBXaWxsIGJlIGNoYW5nZWQgbGF0ZXIgaWYgbmVlZGVkLgoJCQlzaHJpbmtXcmFwQmxvY2tzVmFsID0gZmFsc2U7CgoJCQlpZiAoIHR5cGVvZiBkaXYuc3R5bGUuem9vbSAhPT0gc3RydW5kZWZpbmVkICkgewoJCQkJLy8gU3VwcG9ydDogSUU2CgkJCQkvLyBDaGVjayBpZiBlbGVtZW50cyB3aXRoIGxheW91dCBzaHJpbmstd3JhcCB0aGVpciBjaGlsZHJlbgoJCQkJZGl2LnN0eWxlLmNzc1RleHQgPSBkaXZSZXNldCArICI7d2lkdGg6MXB4O3BhZGRpbmc6MXB4O3pvb206MSI7CgkJCQlkaXYuaW5uZXJIVE1MID0gIjxkaXY+PC9kaXY+IjsKCQkJCWRpdi5maXJzdENoaWxkLnN0eWxlLndpZHRoID0gIjVweCI7CgkJCQlzaHJpbmtXcmFwQmxvY2tzVmFsID0gZGl2Lm9mZnNldFdpZHRoICE9PSAzOwoJCQl9CgoJCQlib2R5LnJlbW92ZUNoaWxkKCBjb250YWluZXIgKTsKCgkJCS8vIE51bGwgZWxlbWVudHMgdG8gYXZvaWQgbGVha3MgaW4gSUUuCgkJCWJvZHkgPSBjb250YWluZXIgPSBkaXYgPSBudWxsOwoJCX0KCgkJcmV0dXJuIHNocmlua1dyYXBCbG9ja3NWYWw7Cgl9OwoKfSkoKTsKdmFyIHJtYXJnaW4gPSAoL15tYXJnaW4vKTsKCnZhciBybnVtbm9ucHggPSBuZXcgUmVnRXhwKCAiXigiICsgcG51bSArICIpKD8hcHgpW2EteiVdKyQiLCAiaSIgKTsKCgoKdmFyIGdldFN0eWxlcywgY3VyQ1NTLAoJcnBvc2l0aW9uID0gL14odG9wfHJpZ2h0fGJvdHRvbXxsZWZ0KSQvOwoKaWYgKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSApIHsKCWdldFN0eWxlcyA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBlbGVtLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSggZWxlbSwgbnVsbCApOwoJfTsKCgljdXJDU1MgPSBmdW5jdGlvbiggZWxlbSwgbmFtZSwgY29tcHV0ZWQgKSB7CgkJdmFyIHdpZHRoLCBtaW5XaWR0aCwgbWF4V2lkdGgsIHJldCwKCQkJc3R5bGUgPSBlbGVtLnN0eWxlOwoKCQljb21wdXRlZCA9IGNvbXB1dGVkIHx8IGdldFN0eWxlcyggZWxlbSApOwoKCQkvLyBnZXRQcm9wZXJ0eVZhbHVlIGlzIG9ubHkgbmVlZGVkIGZvciAuY3NzKCdmaWx0ZXInKSBpbiBJRTksIHNlZSAjMTI1MzcKCQlyZXQgPSBjb21wdXRlZCA/IGNvbXB1dGVkLmdldFByb3BlcnR5VmFsdWUoIG5hbWUgKSB8fCBjb21wdXRlZFsgbmFtZSBdIDogdW5kZWZpbmVkOwoKCQlpZiAoIGNvbXB1dGVkICkgewoKCQkJaWYgKCByZXQgPT09ICIiICYmICFqUXVlcnkuY29udGFpbnMoIGVsZW0ub3duZXJEb2N1bWVudCwgZWxlbSApICkgewoJCQkJcmV0ID0galF1ZXJ5LnN0eWxlKCBlbGVtLCBuYW1lICk7CgkJCX0KCgkJCS8vIEEgdHJpYnV0ZSB0byB0aGUgImF3ZXNvbWUgaGFjayBieSBEZWFuIEVkd2FyZHMiCgkJCS8vIENocm9tZSA8IDE3IGFuZCBTYWZhcmkgNS4wIHVzZXMgImNvbXB1dGVkIHZhbHVlIiBpbnN0ZWFkIG9mICJ1c2VkIHZhbHVlIiBmb3IgbWFyZ2luLXJpZ2h0CgkJCS8vIFNhZmFyaSA1LjEuNyAoYXQgbGVhc3QpIHJldHVybnMgcGVyY2VudGFnZSBmb3IgYSBsYXJnZXIgc2V0IG9mIHZhbHVlcywgYnV0IHdpZHRoIHNlZW1zIHRvIGJlIHJlbGlhYmx5IHBpeGVscwoJCQkvLyB0aGlzIGlzIGFnYWluc3QgdGhlIENTU09NIGRyYWZ0IHNwZWM6IGh0dHA6Ly9kZXYudzMub3JnL2Nzc3dnL2Nzc29tLyNyZXNvbHZlZC12YWx1ZXMKCQkJaWYgKCBybnVtbm9ucHgudGVzdCggcmV0ICkgJiYgcm1hcmdpbi50ZXN0KCBuYW1lICkgKSB7CgoJCQkJLy8gUmVtZW1iZXIgdGhlIG9yaWdpbmFsIHZhbHVlcwoJCQkJd2lkdGggPSBzdHlsZS53aWR0aDsKCQkJCW1pbldpZHRoID0gc3R5bGUubWluV2lkdGg7CgkJCQltYXhXaWR0aCA9IHN0eWxlLm1heFdpZHRoOwoKCQkJCS8vIFB1dCBpbiB0aGUgbmV3IHZhbHVlcyB0byBnZXQgYSBjb21wdXRlZCB2YWx1ZSBvdXQKCQkJCXN0eWxlLm1pbldpZHRoID0gc3R5bGUubWF4V2lkdGggPSBzdHlsZS53aWR0aCA9IHJldDsKCQkJCXJldCA9IGNvbXB1dGVkLndpZHRoOwoKCQkJCS8vIFJldmVydCB0aGUgY2hhbmdlZCB2YWx1ZXMKCQkJCXN0eWxlLndpZHRoID0gd2lkdGg7CgkJCQlzdHlsZS5taW5XaWR0aCA9IG1pbldpZHRoOwoJCQkJc3R5bGUubWF4V2lkdGggPSBtYXhXaWR0aDsKCQkJfQoJCX0KCgkJLy8gU3VwcG9ydDogSUUKCQkvLyBJRSByZXR1cm5zIHpJbmRleCB2YWx1ZSBhcyBhbiBpbnRlZ2VyLgoJCXJldHVybiByZXQgPT09IHVuZGVmaW5lZCA/CgkJCXJldCA6CgkJCXJldCArICIiOwoJfTsKfSBlbHNlIGlmICggZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmN1cnJlbnRTdHlsZSApIHsKCWdldFN0eWxlcyA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBlbGVtLmN1cnJlbnRTdHlsZTsKCX07CgoJY3VyQ1NTID0gZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGNvbXB1dGVkICkgewoJCXZhciBsZWZ0LCBycywgcnNMZWZ0LCByZXQsCgkJCXN0eWxlID0gZWxlbS5zdHlsZTsKCgkJY29tcHV0ZWQgPSBjb21wdXRlZCB8fCBnZXRTdHlsZXMoIGVsZW0gKTsKCQlyZXQgPSBjb21wdXRlZCA/IGNvbXB1dGVkWyBuYW1lIF0gOiB1bmRlZmluZWQ7CgoJCS8vIEF2b2lkIHNldHRpbmcgcmV0IHRvIGVtcHR5IHN0cmluZyBoZXJlCgkJLy8gc28gd2UgZG9uJ3QgZGVmYXVsdCB0byBhdXRvCgkJaWYgKCByZXQgPT0gbnVsbCAmJiBzdHlsZSAmJiBzdHlsZVsgbmFtZSBdICkgewoJCQlyZXQgPSBzdHlsZVsgbmFtZSBdOwoJCX0KCgkJLy8gRnJvbSB0aGUgYXdlc29tZSBoYWNrIGJ5IERlYW4gRWR3YXJkcwoJCS8vIGh0dHA6Ly9lcmlrLmVhZS5uZXQvYXJjaGl2ZXMvMjAwNy8wNy8yNy8xOC41NC4xNS8jY29tbWVudC0xMDIyOTEKCgkJLy8gSWYgd2UncmUgbm90IGRlYWxpbmcgd2l0aCBhIHJlZ3VsYXIgcGl4ZWwgbnVtYmVyCgkJLy8gYnV0IGEgbnVtYmVyIHRoYXQgaGFzIGEgd2VpcmQgZW5kaW5nLCB3ZSBuZWVkIHRvIGNvbnZlcnQgaXQgdG8gcGl4ZWxzCgkJLy8gYnV0IG5vdCBwb3NpdGlvbiBjc3MgYXR0cmlidXRlcywgYXMgdGhvc2UgYXJlIHByb3BvcnRpb25hbCB0byB0aGUgcGFyZW50IGVsZW1lbnQgaW5zdGVhZAoJCS8vIGFuZCB3ZSBjYW4ndCBtZWFzdXJlIHRoZSBwYXJlbnQgaW5zdGVhZCBiZWNhdXNlIGl0IG1pZ2h0IHRyaWdnZXIgYSAic3RhY2tpbmcgZG9sbHMiIHByb2JsZW0KCQlpZiAoIHJudW1ub25weC50ZXN0KCByZXQgKSAmJiAhcnBvc2l0aW9uLnRlc3QoIG5hbWUgKSApIHsKCgkJCS8vIFJlbWVtYmVyIHRoZSBvcmlnaW5hbCB2YWx1ZXMKCQkJbGVmdCA9IHN0eWxlLmxlZnQ7CgkJCXJzID0gZWxlbS5ydW50aW1lU3R5bGU7CgkJCXJzTGVmdCA9IHJzICYmIHJzLmxlZnQ7CgoJCQkvLyBQdXQgaW4gdGhlIG5ldyB2YWx1ZXMgdG8gZ2V0IGEgY29tcHV0ZWQgdmFsdWUgb3V0CgkJCWlmICggcnNMZWZ0ICkgewoJCQkJcnMubGVmdCA9IGVsZW0uY3VycmVudFN0eWxlLmxlZnQ7CgkJCX0KCQkJc3R5bGUubGVmdCA9IG5hbWUgPT09ICJmb250U2l6ZSIgPyAiMWVtIiA6IHJldDsKCQkJcmV0ID0gc3R5bGUucGl4ZWxMZWZ0ICsgInB4IjsKCgkJCS8vIFJldmVydCB0aGUgY2hhbmdlZCB2YWx1ZXMKCQkJc3R5bGUubGVmdCA9IGxlZnQ7CgkJCWlmICggcnNMZWZ0ICkgewoJCQkJcnMubGVmdCA9IHJzTGVmdDsKCQkJfQoJCX0KCgkJLy8gU3VwcG9ydDogSUUKCQkvLyBJRSByZXR1cm5zIHpJbmRleCB2YWx1ZSBhcyBhbiBpbnRlZ2VyLgoJCXJldHVybiByZXQgPT09IHVuZGVmaW5lZCA/CgkJCXJldCA6CgkJCXJldCArICIiIHx8ICJhdXRvIjsKCX07Cn0KCgoKCmZ1bmN0aW9uIGFkZEdldEhvb2tJZiggY29uZGl0aW9uRm4sIGhvb2tGbiApIHsKCS8vIERlZmluZSB0aGUgaG9vaywgd2UnbGwgY2hlY2sgb24gdGhlIGZpcnN0IHJ1biBpZiBpdCdzIHJlYWxseSBuZWVkZWQuCglyZXR1cm4gewoJCWdldDogZnVuY3Rpb24oKSB7CgkJCXZhciBjb25kaXRpb24gPSBjb25kaXRpb25GbigpOwoKCQkJaWYgKCBjb25kaXRpb24gPT0gbnVsbCApIHsKCQkJCS8vIFRoZSB0ZXN0IHdhcyBub3QgcmVhZHkgYXQgdGhpcyBwb2ludDsgc2NyZXcgdGhlIGhvb2sgdGhpcyB0aW1lCgkJCQkvLyBidXQgY2hlY2sgYWdhaW4gd2hlbiBuZWVkZWQgbmV4dCB0aW1lLgoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIGNvbmRpdGlvbiApIHsKCQkJCS8vIEhvb2sgbm90IG5lZWRlZCAob3IgaXQncyBub3QgcG9zc2libGUgdG8gdXNlIGl0IGR1ZSB0byBtaXNzaW5nIGRlcGVuZGVuY3kpLAoJCQkJLy8gcmVtb3ZlIGl0LgoJCQkJLy8gU2luY2UgdGhlcmUgYXJlIG5vIG90aGVyIGhvb2tzIGZvciBtYXJnaW5SaWdodCwgcmVtb3ZlIHRoZSB3aG9sZSBvYmplY3QuCgkJCQlkZWxldGUgdGhpcy5nZXQ7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIEhvb2sgbmVlZGVkOyByZWRlZmluZSBpdCBzbyB0aGF0IHRoZSBzdXBwb3J0IHRlc3QgaXMgbm90IGV4ZWN1dGVkIGFnYWluLgoKCQkJcmV0dXJuICh0aGlzLmdldCA9IGhvb2tGbikuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCX0KCX07Cn0KCgooZnVuY3Rpb24oKSB7Cgl2YXIgYSwgcmVsaWFibGVIaWRkZW5PZmZzZXRzVmFsLCBib3hTaXppbmdWYWwsIGJveFNpemluZ1JlbGlhYmxlVmFsLAoJCXBpeGVsUG9zaXRpb25WYWwsIHJlbGlhYmxlTWFyZ2luUmlnaHRWYWwsCgkJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCQljb250YWluZXJTdHlsZXMgPSAiYm9yZGVyOjA7d2lkdGg6MDtoZWlnaHQ6MDtwb3NpdGlvbjphYnNvbHV0ZTt0b3A6MDtsZWZ0Oi05OTk5cHgiLAoJCWRpdlJlc2V0ID0KCQkJIi13ZWJraXQtYm94LXNpemluZzpjb250ZW50LWJveDstbW96LWJveC1zaXppbmc6Y29udGVudC1ib3g7Ym94LXNpemluZzpjb250ZW50LWJveDsiICsKCQkJImRpc3BsYXk6YmxvY2s7cGFkZGluZzowO21hcmdpbjowO2JvcmRlcjowIjsKCgkvLyBTZXR1cAoJZGl2LmlubmVySFRNTCA9ICIgIDxsaW5rLz48dGFibGU+PC90YWJsZT48YSBocmVmPScvYSc+YTwvYT48aW5wdXQgdHlwZT0nY2hlY2tib3gnLz4iOwoJYSA9IGRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSggImEiIClbIDAgXTsKCglhLnN0eWxlLmNzc1RleHQgPSAiZmxvYXQ6bGVmdDtvcGFjaXR5Oi41IjsKCgkvLyBNYWtlIHN1cmUgdGhhdCBlbGVtZW50IG9wYWNpdHkgZXhpc3RzCgkvLyAoSUUgdXNlcyBmaWx0ZXIgaW5zdGVhZCkKCS8vIFVzZSBhIHJlZ2V4IHRvIHdvcmsgYXJvdW5kIGEgV2ViS2l0IGlzc3VlLiBTZWUgIzUxNDUKCXN1cHBvcnQub3BhY2l0eSA9IC9eMC41Ly50ZXN0KCBhLnN0eWxlLm9wYWNpdHkgKTsKCgkvLyBWZXJpZnkgc3R5bGUgZmxvYXQgZXhpc3RlbmNlCgkvLyAoSUUgdXNlcyBzdHlsZUZsb2F0IGluc3RlYWQgb2YgY3NzRmxvYXQpCglzdXBwb3J0LmNzc0Zsb2F0ID0gISFhLnN0eWxlLmNzc0Zsb2F0OwoKCWRpdi5zdHlsZS5iYWNrZ3JvdW5kQ2xpcCA9ICJjb250ZW50LWJveCI7CglkaXYuY2xvbmVOb2RlKCB0cnVlICkuc3R5bGUuYmFja2dyb3VuZENsaXAgPSAiIjsKCXN1cHBvcnQuY2xlYXJDbG9uZVN0eWxlID0gZGl2LnN0eWxlLmJhY2tncm91bmRDbGlwID09PSAiY29udGVudC1ib3giOwoKCS8vIE51bGwgZWxlbWVudHMgdG8gYXZvaWQgbGVha3MgaW4gSUUuCglhID0gZGl2ID0gbnVsbDsKCglqUXVlcnkuZXh0ZW5kKHN1cHBvcnQsIHsKCQlyZWxpYWJsZUhpZGRlbk9mZnNldHM6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHJlbGlhYmxlSGlkZGVuT2Zmc2V0c1ZhbCAhPSBudWxsICkgewoJCQkJcmV0dXJuIHJlbGlhYmxlSGlkZGVuT2Zmc2V0c1ZhbDsKCQkJfQoKCQkJdmFyIGNvbnRhaW5lciwgdGRzLCBpc1N1cHBvcnRlZCwKCQkJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCgkJCQlib2R5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoICJib2R5IiApWyAwIF07CgoJCQlpZiAoICFib2R5ICkgewoJCQkJLy8gUmV0dXJuIGZvciBmcmFtZXNldCBkb2NzIHRoYXQgZG9uJ3QgaGF2ZSBhIGJvZHkKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gU2V0dXAKCQkJZGl2LnNldEF0dHJpYnV0ZSggImNsYXNzTmFtZSIsICJ0IiApOwoJCQlkaXYuaW5uZXJIVE1MID0gIiAgPGxpbmsvPjx0YWJsZT48L3RhYmxlPjxhIGhyZWY9Jy9hJz5hPC9hPjxpbnB1dCB0eXBlPSdjaGVja2JveCcvPiI7CgoJCQljb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJCQljb250YWluZXIuc3R5bGUuY3NzVGV4dCA9IGNvbnRhaW5lclN0eWxlczsKCgkJCWJvZHkuYXBwZW5kQ2hpbGQoIGNvbnRhaW5lciApLmFwcGVuZENoaWxkKCBkaXYgKTsKCgkJCS8vIFN1cHBvcnQ6IElFOAoJCQkvLyBDaGVjayBpZiB0YWJsZSBjZWxscyBzdGlsbCBoYXZlIG9mZnNldFdpZHRoL0hlaWdodCB3aGVuIHRoZXkgYXJlIHNldAoJCQkvLyB0byBkaXNwbGF5Om5vbmUgYW5kIHRoZXJlIGFyZSBzdGlsbCBvdGhlciB2aXNpYmxlIHRhYmxlIGNlbGxzIGluIGEKCQkJLy8gdGFibGUgcm93OyBpZiBzbywgb2Zmc2V0V2lkdGgvSGVpZ2h0IGFyZSBub3QgcmVsaWFibGUgZm9yIHVzZSB3aGVuCgkJCS8vIGRldGVybWluaW5nIGlmIGFuIGVsZW1lbnQgaGFzIGJlZW4gaGlkZGVuIGRpcmVjdGx5IHVzaW5nCgkJCS8vIGRpc3BsYXk6bm9uZSAoaXQgaXMgc3RpbGwgc2FmZSB0byB1c2Ugb2Zmc2V0cyBpZiBhIHBhcmVudCBlbGVtZW50IGlzCgkJCS8vIGhpZGRlbjsgZG9uIHNhZmV0eSBnb2dnbGVzIGFuZCBzZWUgYnVnICM0NTEyIGZvciBtb3JlIGluZm9ybWF0aW9uKS4KCQkJZGl2LmlubmVySFRNTCA9ICI8dGFibGU+PHRyPjx0ZD48L3RkPjx0ZD50PC90ZD48L3RyPjwvdGFibGU+IjsKCQkJdGRzID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCAidGQiICk7CgkJCXRkc1sgMCBdLnN0eWxlLmNzc1RleHQgPSAicGFkZGluZzowO21hcmdpbjowO2JvcmRlcjowO2Rpc3BsYXk6bm9uZSI7CgkJCWlzU3VwcG9ydGVkID0gKCB0ZHNbIDAgXS5vZmZzZXRIZWlnaHQgPT09IDAgKTsKCgkJCXRkc1sgMCBdLnN0eWxlLmRpc3BsYXkgPSAiIjsKCQkJdGRzWyAxIF0uc3R5bGUuZGlzcGxheSA9ICJub25lIjsKCgkJCS8vIFN1cHBvcnQ6IElFOAoJCQkvLyBDaGVjayBpZiBlbXB0eSB0YWJsZSBjZWxscyBzdGlsbCBoYXZlIG9mZnNldFdpZHRoL0hlaWdodAoJCQlyZWxpYWJsZUhpZGRlbk9mZnNldHNWYWwgPSBpc1N1cHBvcnRlZCAmJiAoIHRkc1sgMCBdLm9mZnNldEhlaWdodCA9PT0gMCApOwoKCQkJYm9keS5yZW1vdmVDaGlsZCggY29udGFpbmVyICk7CgoJCQkvLyBOdWxsIGVsZW1lbnRzIHRvIGF2b2lkIGxlYWtzIGluIElFLgoJCQlkaXYgPSBib2R5ID0gbnVsbDsKCgkJCXJldHVybiByZWxpYWJsZUhpZGRlbk9mZnNldHNWYWw7CgkJfSwKCgkJYm94U2l6aW5nOiBmdW5jdGlvbigpIHsKCQkJaWYgKCBib3hTaXppbmdWYWwgPT0gbnVsbCApIHsKCQkJCWNvbXB1dGVTdHlsZVRlc3RzKCk7CgkJCX0KCQkJcmV0dXJuIGJveFNpemluZ1ZhbDsKCQl9LAoKCQlib3hTaXppbmdSZWxpYWJsZTogZnVuY3Rpb24oKSB7CgkJCWlmICggYm94U2l6aW5nUmVsaWFibGVWYWwgPT0gbnVsbCApIHsKCQkJCWNvbXB1dGVTdHlsZVRlc3RzKCk7CgkJCX0KCQkJcmV0dXJuIGJveFNpemluZ1JlbGlhYmxlVmFsOwoJCX0sCgoJCXBpeGVsUG9zaXRpb246IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHBpeGVsUG9zaXRpb25WYWwgPT0gbnVsbCApIHsKCQkJCWNvbXB1dGVTdHlsZVRlc3RzKCk7CgkJCX0KCQkJcmV0dXJuIHBpeGVsUG9zaXRpb25WYWw7CgkJfSwKCgkJcmVsaWFibGVNYXJnaW5SaWdodDogZnVuY3Rpb24oKSB7CgkJCXZhciBib2R5LCBjb250YWluZXIsIGRpdiwgbWFyZ2luRGl2OwoKCQkJLy8gVXNlIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlIGJlY2F1c2UganNkb20gb24gbm9kZS5qcyB3aWxsIGJyZWFrIHdpdGhvdXQgaXQuCgkJCWlmICggcmVsaWFibGVNYXJnaW5SaWdodFZhbCA9PSBudWxsICYmIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlICkgewoJCQkJYm9keSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCAiYm9keSIgKVsgMCBdOwoJCQkJaWYgKCAhYm9keSApIHsKCQkJCQkvLyBUZXN0IGZpcmVkIHRvbyBlYXJseSBvciBpbiBhbiB1bnN1cHBvcnRlZCBlbnZpcm9ubWVudCwgZXhpdC4KCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgkJCQljb250YWluZXIuc3R5bGUuY3NzVGV4dCA9IGNvbnRhaW5lclN0eWxlczsKCgkJCQlib2R5LmFwcGVuZENoaWxkKCBjb250YWluZXIgKS5hcHBlbmRDaGlsZCggZGl2ICk7CgoJCQkJLy8gQ2hlY2sgaWYgZGl2IHdpdGggZXhwbGljaXQgd2lkdGggYW5kIG5vIG1hcmdpbi1yaWdodCBpbmNvcnJlY3RseQoJCQkJLy8gZ2V0cyBjb21wdXRlZCBtYXJnaW4tcmlnaHQgYmFzZWQgb24gd2lkdGggb2YgY29udGFpbmVyLiAoIzMzMzMpCgkJCQkvLyBGYWlscyBpbiBXZWJLaXQgYmVmb3JlIEZlYiAyMDExIG5pZ2h0bGllcwoJCQkJLy8gV2ViS2l0IEJ1ZyAxMzM0MyAtIGdldENvbXB1dGVkU3R5bGUgcmV0dXJucyB3cm9uZyB2YWx1ZSBmb3IgbWFyZ2luLXJpZ2h0CgkJCQltYXJnaW5EaXYgPSBkaXYuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICkgKTsKCQkJCW1hcmdpbkRpdi5zdHlsZS5jc3NUZXh0ID0gZGl2LnN0eWxlLmNzc1RleHQgPSBkaXZSZXNldDsKCQkJCW1hcmdpbkRpdi5zdHlsZS5tYXJnaW5SaWdodCA9IG1hcmdpbkRpdi5zdHlsZS53aWR0aCA9ICIwIjsKCQkJCWRpdi5zdHlsZS53aWR0aCA9ICIxcHgiOwoKCQkJCXJlbGlhYmxlTWFyZ2luUmlnaHRWYWwgPQoJCQkJCSFwYXJzZUZsb2F0KCAoIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBtYXJnaW5EaXYsIG51bGwgKSB8fCB7fSApLm1hcmdpblJpZ2h0ICk7CgoJCQkJYm9keS5yZW1vdmVDaGlsZCggY29udGFpbmVyICk7CgkJCX0KCgkJCXJldHVybiByZWxpYWJsZU1hcmdpblJpZ2h0VmFsOwoJCX0KCX0pOwoKCWZ1bmN0aW9uIGNvbXB1dGVTdHlsZVRlc3RzKCkgewoJCXZhciBjb250YWluZXIsIGRpdiwKCQkJYm9keSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCAiYm9keSIgKVsgMCBdOwoKCQlpZiAoICFib2R5ICkgewoJCQkvLyBUZXN0IGZpcmVkIHRvbyBlYXJseSBvciBpbiBhbiB1bnN1cHBvcnRlZCBlbnZpcm9ubWVudCwgZXhpdC4KCQkJcmV0dXJuOwoJCX0KCgkJY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQlkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJCWNvbnRhaW5lci5zdHlsZS5jc3NUZXh0ID0gY29udGFpbmVyU3R5bGVzOwoKCQlib2R5LmFwcGVuZENoaWxkKCBjb250YWluZXIgKS5hcHBlbmRDaGlsZCggZGl2ICk7CgoJCWRpdi5zdHlsZS5jc3NUZXh0ID0KCQkJIi13ZWJraXQtYm94LXNpemluZzpib3JkZXItYm94Oy1tb3otYm94LXNpemluZzpib3JkZXItYm94O2JveC1zaXppbmc6Ym9yZGVyLWJveDsiICsKCQkJCSJwb3NpdGlvbjphYnNvbHV0ZTtkaXNwbGF5OmJsb2NrO3BhZGRpbmc6MXB4O2JvcmRlcjoxcHg7d2lkdGg6NHB4OyIgKwoJCQkJIm1hcmdpbi10b3A6MSU7dG9wOjElIjsKCgkJLy8gV29ya2Fyb3VuZCBmYWlsaW5nIGJveFNpemluZyB0ZXN0IGR1ZSB0byBvZmZzZXRXaWR0aCByZXR1cm5pbmcgd3JvbmcgdmFsdWUKCQkvLyB3aXRoIHNvbWUgbm9uLTEgdmFsdWVzIG9mIGJvZHkgem9vbSwgdGlja2V0ICMxMzU0MwoJCWpRdWVyeS5zd2FwKCBib2R5LCBib2R5LnN0eWxlLnpvb20gIT0gbnVsbCA/IHsgem9vbTogMSB9IDoge30sIGZ1bmN0aW9uKCkgewoJCQlib3hTaXppbmdWYWwgPSBkaXYub2Zmc2V0V2lkdGggPT09IDQ7CgkJfSk7CgoJCS8vIFdpbGwgYmUgY2hhbmdlZCBsYXRlciBpZiBuZWVkZWQuCgkJYm94U2l6aW5nUmVsaWFibGVWYWwgPSB0cnVlOwoJCXBpeGVsUG9zaXRpb25WYWwgPSBmYWxzZTsKCQlyZWxpYWJsZU1hcmdpblJpZ2h0VmFsID0gdHJ1ZTsKCgkJLy8gVXNlIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlIGJlY2F1c2UganNkb20gb24gbm9kZS5qcyB3aWxsIGJyZWFrIHdpdGhvdXQgaXQuCgkJaWYgKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSApIHsKCQkJcGl4ZWxQb3NpdGlvblZhbCA9ICggd2luZG93LmdldENvbXB1dGVkU3R5bGUoIGRpdiwgbnVsbCApIHx8IHt9ICkudG9wICE9PSAiMSUiOwoJCQlib3hTaXppbmdSZWxpYWJsZVZhbCA9CgkJCQkoIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBkaXYsIG51bGwgKSB8fCB7IHdpZHRoOiAiNHB4IiB9ICkud2lkdGggPT09ICI0cHgiOwoJCX0KCgkJYm9keS5yZW1vdmVDaGlsZCggY29udGFpbmVyICk7CgoJCS8vIE51bGwgZWxlbWVudHMgdG8gYXZvaWQgbGVha3MgaW4gSUUuCgkJZGl2ID0gYm9keSA9IG51bGw7Cgl9Cgp9KSgpOwoKCi8vIEEgbWV0aG9kIGZvciBxdWlja2x5IHN3YXBwaW5nIGluL291dCBDU1MgcHJvcGVydGllcyB0byBnZXQgY29ycmVjdCBjYWxjdWxhdGlvbnMuCmpRdWVyeS5zd2FwID0gZnVuY3Rpb24oIGVsZW0sIG9wdGlvbnMsIGNhbGxiYWNrLCBhcmdzICkgewoJdmFyIHJldCwgbmFtZSwKCQlvbGQgPSB7fTsKCgkvLyBSZW1lbWJlciB0aGUgb2xkIHZhbHVlcywgYW5kIGluc2VydCB0aGUgbmV3IG9uZXMKCWZvciAoIG5hbWUgaW4gb3B0aW9ucyApIHsKCQlvbGRbIG5hbWUgXSA9IGVsZW0uc3R5bGVbIG5hbWUgXTsKCQllbGVtLnN0eWxlWyBuYW1lIF0gPSBvcHRpb25zWyBuYW1lIF07Cgl9CgoJcmV0ID0gY2FsbGJhY2suYXBwbHkoIGVsZW0sIGFyZ3MgfHwgW10gKTsKCgkvLyBSZXZlcnQgdGhlIG9sZCB2YWx1ZXMKCWZvciAoIG5hbWUgaW4gb3B0aW9ucyApIHsKCQllbGVtLnN0eWxlWyBuYW1lIF0gPSBvbGRbIG5hbWUgXTsKCX0KCglyZXR1cm4gcmV0Owp9OwoKCnZhcgoJCXJhbHBoYSA9IC9hbHBoYVwoW14pXSpcKS9pLAoJcm9wYWNpdHkgPSAvb3BhY2l0eVxzKj1ccyooW14pXSopLywKCgkvLyBzd2FwcGFibGUgaWYgZGlzcGxheSBpcyBub25lIG9yIHN0YXJ0cyB3aXRoIHRhYmxlIGV4Y2VwdCAidGFibGUiLCAidGFibGUtY2VsbCIsIG9yICJ0YWJsZS1jYXB0aW9uIgoJLy8gc2VlIGhlcmUgZm9yIGRpc3BsYXkgdmFsdWVzOiBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL0NTUy9kaXNwbGF5CglyZGlzcGxheXN3YXAgPSAvXihub25lfHRhYmxlKD8hLWNbZWFdKS4rKS8sCglybnVtc3BsaXQgPSBuZXcgUmVnRXhwKCAiXigiICsgcG51bSArICIpKC4qKSQiLCAiaSIgKSwKCXJyZWxOdW0gPSBuZXcgUmVnRXhwKCAiXihbKy1dKT0oIiArIHBudW0gKyAiKSIsICJpIiApLAoKCWNzc1Nob3cgPSB7IHBvc2l0aW9uOiAiYWJzb2x1dGUiLCB2aXNpYmlsaXR5OiAiaGlkZGVuIiwgZGlzcGxheTogImJsb2NrIiB9LAoJY3NzTm9ybWFsVHJhbnNmb3JtID0gewoJCWxldHRlclNwYWNpbmc6IDAsCgkJZm9udFdlaWdodDogNDAwCgl9LAoKCWNzc1ByZWZpeGVzID0gWyAiV2Via2l0IiwgIk8iLCAiTW96IiwgIm1zIiBdOwoKCi8vIHJldHVybiBhIGNzcyBwcm9wZXJ0eSBtYXBwZWQgdG8gYSBwb3RlbnRpYWxseSB2ZW5kb3IgcHJlZml4ZWQgcHJvcGVydHkKZnVuY3Rpb24gdmVuZG9yUHJvcE5hbWUoIHN0eWxlLCBuYW1lICkgewoKCS8vIHNob3J0Y3V0IGZvciBuYW1lcyB0aGF0IGFyZSBub3QgdmVuZG9yIHByZWZpeGVkCglpZiAoIG5hbWUgaW4gc3R5bGUgKSB7CgkJcmV0dXJuIG5hbWU7Cgl9CgoJLy8gY2hlY2sgZm9yIHZlbmRvciBwcmVmaXhlZCBuYW1lcwoJdmFyIGNhcE5hbWUgPSBuYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbmFtZS5zbGljZSgxKSwKCQlvcmlnTmFtZSA9IG5hbWUsCgkJaSA9IGNzc1ByZWZpeGVzLmxlbmd0aDsKCgl3aGlsZSAoIGktLSApIHsKCQluYW1lID0gY3NzUHJlZml4ZXNbIGkgXSArIGNhcE5hbWU7CgkJaWYgKCBuYW1lIGluIHN0eWxlICkgewoJCQlyZXR1cm4gbmFtZTsKCQl9Cgl9CgoJcmV0dXJuIG9yaWdOYW1lOwp9CgpmdW5jdGlvbiBzaG93SGlkZSggZWxlbWVudHMsIHNob3cgKSB7Cgl2YXIgZGlzcGxheSwgZWxlbSwgaGlkZGVuLAoJCXZhbHVlcyA9IFtdLAoJCWluZGV4ID0gMCwKCQlsZW5ndGggPSBlbGVtZW50cy5sZW5ndGg7CgoJZm9yICggOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsKCQllbGVtID0gZWxlbWVudHNbIGluZGV4IF07CgkJaWYgKCAhZWxlbS5zdHlsZSApIHsKCQkJY29udGludWU7CgkJfQoKCQl2YWx1ZXNbIGluZGV4IF0gPSBqUXVlcnkuX2RhdGEoIGVsZW0sICJvbGRkaXNwbGF5IiApOwoJCWRpc3BsYXkgPSBlbGVtLnN0eWxlLmRpc3BsYXk7CgkJaWYgKCBzaG93ICkgewoJCQkvLyBSZXNldCB0aGUgaW5saW5lIGRpc3BsYXkgb2YgdGhpcyBlbGVtZW50IHRvIGxlYXJuIGlmIGl0IGlzCgkJCS8vIGJlaW5nIGhpZGRlbiBieSBjYXNjYWRlZCBydWxlcyBvciBub3QKCQkJaWYgKCAhdmFsdWVzWyBpbmRleCBdICYmIGRpc3BsYXkgPT09ICJub25lIiApIHsKCQkJCWVsZW0uc3R5bGUuZGlzcGxheSA9ICIiOwoJCQl9CgoJCQkvLyBTZXQgZWxlbWVudHMgd2hpY2ggaGF2ZSBiZWVuIG92ZXJyaWRkZW4gd2l0aCBkaXNwbGF5OiBub25lCgkJCS8vIGluIGEgc3R5bGVzaGVldCB0byB3aGF0ZXZlciB0aGUgZGVmYXVsdCBicm93c2VyIHN0eWxlIGlzCgkJCS8vIGZvciBzdWNoIGFuIGVsZW1lbnQKCQkJaWYgKCBlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICIiICYmIGlzSGlkZGVuKCBlbGVtICkgKSB7CgkJCQl2YWx1ZXNbIGluZGV4IF0gPSBqUXVlcnkuX2RhdGEoIGVsZW0sICJvbGRkaXNwbGF5IiwgZGVmYXVsdERpc3BsYXkoZWxlbS5ub2RlTmFtZSkgKTsKCQkJfQoJCX0gZWxzZSB7CgoJCQlpZiAoICF2YWx1ZXNbIGluZGV4IF0gKSB7CgkJCQloaWRkZW4gPSBpc0hpZGRlbiggZWxlbSApOwoKCQkJCWlmICggZGlzcGxheSAmJiBkaXNwbGF5ICE9PSAibm9uZSIgfHwgIWhpZGRlbiApIHsKCQkJCQlqUXVlcnkuX2RhdGEoIGVsZW0sICJvbGRkaXNwbGF5IiwgaGlkZGVuID8gZGlzcGxheSA6IGpRdWVyeS5jc3MoIGVsZW0sICJkaXNwbGF5IiApICk7CgkJCQl9CgkJCX0KCQl9Cgl9CgoJLy8gU2V0IHRoZSBkaXNwbGF5IG9mIG1vc3Qgb2YgdGhlIGVsZW1lbnRzIGluIGEgc2Vjb25kIGxvb3AKCS8vIHRvIGF2b2lkIHRoZSBjb25zdGFudCByZWZsb3cKCWZvciAoIGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7CgkJZWxlbSA9IGVsZW1lbnRzWyBpbmRleCBdOwoJCWlmICggIWVsZW0uc3R5bGUgKSB7CgkJCWNvbnRpbnVlOwoJCX0KCQlpZiAoICFzaG93IHx8IGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiIHx8IGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIiIgKSB7CgkJCWVsZW0uc3R5bGUuZGlzcGxheSA9IHNob3cgPyB2YWx1ZXNbIGluZGV4IF0gfHwgIiIgOiAibm9uZSI7CgkJfQoJfQoKCXJldHVybiBlbGVtZW50czsKfQoKZnVuY3Rpb24gc2V0UG9zaXRpdmVOdW1iZXIoIGVsZW0sIHZhbHVlLCBzdWJ0cmFjdCApIHsKCXZhciBtYXRjaGVzID0gcm51bXNwbGl0LmV4ZWMoIHZhbHVlICk7CglyZXR1cm4gbWF0Y2hlcyA/CgkJLy8gR3VhcmQgYWdhaW5zdCB1bmRlZmluZWQgInN1YnRyYWN0IiwgZS5nLiwgd2hlbiB1c2VkIGFzIGluIGNzc0hvb2tzCgkJTWF0aC5tYXgoIDAsIG1hdGNoZXNbIDEgXSAtICggc3VidHJhY3QgfHwgMCApICkgKyAoIG1hdGNoZXNbIDIgXSB8fCAicHgiICkgOgoJCXZhbHVlOwp9CgpmdW5jdGlvbiBhdWdtZW50V2lkdGhPckhlaWdodCggZWxlbSwgbmFtZSwgZXh0cmEsIGlzQm9yZGVyQm94LCBzdHlsZXMgKSB7Cgl2YXIgaSA9IGV4dHJhID09PSAoIGlzQm9yZGVyQm94ID8gImJvcmRlciIgOiAiY29udGVudCIgKSA/CgkJLy8gSWYgd2UgYWxyZWFkeSBoYXZlIHRoZSByaWdodCBtZWFzdXJlbWVudCwgYXZvaWQgYXVnbWVudGF0aW9uCgkJNCA6CgkJLy8gT3RoZXJ3aXNlIGluaXRpYWxpemUgZm9yIGhvcml6b250YWwgb3IgdmVydGljYWwgcHJvcGVydGllcwoJCW5hbWUgPT09ICJ3aWR0aCIgPyAxIDogMCwKCgkJdmFsID0gMDsKCglmb3IgKCA7IGkgPCA0OyBpICs9IDIgKSB7CgkJLy8gYm90aCBib3ggbW9kZWxzIGV4Y2x1ZGUgbWFyZ2luLCBzbyBhZGQgaXQgaWYgd2Ugd2FudCBpdAoJCWlmICggZXh0cmEgPT09ICJtYXJnaW4iICkgewoJCQl2YWwgKz0galF1ZXJ5LmNzcyggZWxlbSwgZXh0cmEgKyBjc3NFeHBhbmRbIGkgXSwgdHJ1ZSwgc3R5bGVzICk7CgkJfQoKCQlpZiAoIGlzQm9yZGVyQm94ICkgewoJCQkvLyBib3JkZXItYm94IGluY2x1ZGVzIHBhZGRpbmcsIHNvIHJlbW92ZSBpdCBpZiB3ZSB3YW50IGNvbnRlbnQKCQkJaWYgKCBleHRyYSA9PT0gImNvbnRlbnQiICkgewoJCQkJdmFsIC09IGpRdWVyeS5jc3MoIGVsZW0sICJwYWRkaW5nIiArIGNzc0V4cGFuZFsgaSBdLCB0cnVlLCBzdHlsZXMgKTsKCQkJfQoKCQkJLy8gYXQgdGhpcyBwb2ludCwgZXh0cmEgaXNuJ3QgYm9yZGVyIG5vciBtYXJnaW4sIHNvIHJlbW92ZSBib3JkZXIKCQkJaWYgKCBleHRyYSAhPT0gIm1hcmdpbiIgKSB7CgkJCQl2YWwgLT0galF1ZXJ5LmNzcyggZWxlbSwgImJvcmRlciIgKyBjc3NFeHBhbmRbIGkgXSArICJXaWR0aCIsIHRydWUsIHN0eWxlcyApOwoJCQl9CgkJfSBlbHNlIHsKCQkJLy8gYXQgdGhpcyBwb2ludCwgZXh0cmEgaXNuJ3QgY29udGVudCwgc28gYWRkIHBhZGRpbmcKCQkJdmFsICs9IGpRdWVyeS5jc3MoIGVsZW0sICJwYWRkaW5nIiArIGNzc0V4cGFuZFsgaSBdLCB0cnVlLCBzdHlsZXMgKTsKCgkJCS8vIGF0IHRoaXMgcG9pbnQsIGV4dHJhIGlzbid0IGNvbnRlbnQgbm9yIHBhZGRpbmcsIHNvIGFkZCBib3JkZXIKCQkJaWYgKCBleHRyYSAhPT0gInBhZGRpbmciICkgewoJCQkJdmFsICs9IGpRdWVyeS5jc3MoIGVsZW0sICJib3JkZXIiICsgY3NzRXhwYW5kWyBpIF0gKyAiV2lkdGgiLCB0cnVlLCBzdHlsZXMgKTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gdmFsOwp9CgpmdW5jdGlvbiBnZXRXaWR0aE9ySGVpZ2h0KCBlbGVtLCBuYW1lLCBleHRyYSApIHsKCgkvLyBTdGFydCB3aXRoIG9mZnNldCBwcm9wZXJ0eSwgd2hpY2ggaXMgZXF1aXZhbGVudCB0byB0aGUgYm9yZGVyLWJveCB2YWx1ZQoJdmFyIHZhbHVlSXNCb3JkZXJCb3ggPSB0cnVlLAoJCXZhbCA9IG5hbWUgPT09ICJ3aWR0aCIgPyBlbGVtLm9mZnNldFdpZHRoIDogZWxlbS5vZmZzZXRIZWlnaHQsCgkJc3R5bGVzID0gZ2V0U3R5bGVzKCBlbGVtICksCgkJaXNCb3JkZXJCb3ggPSBzdXBwb3J0LmJveFNpemluZygpICYmIGpRdWVyeS5jc3MoIGVsZW0sICJib3hTaXppbmciLCBmYWxzZSwgc3R5bGVzICkgPT09ICJib3JkZXItYm94IjsKCgkvLyBzb21lIG5vbi1odG1sIGVsZW1lbnRzIHJldHVybiB1bmRlZmluZWQgZm9yIG9mZnNldFdpZHRoLCBzbyBjaGVjayBmb3IgbnVsbC91bmRlZmluZWQKCS8vIHN2ZyAtIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTY0OTI4NQoJLy8gTWF0aE1MIC0gaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NDkxNjY4CglpZiAoIHZhbCA8PSAwIHx8IHZhbCA9PSBudWxsICkgewoJCS8vIEZhbGwgYmFjayB0byBjb21wdXRlZCB0aGVuIHVuY29tcHV0ZWQgY3NzIGlmIG5lY2Vzc2FyeQoJCXZhbCA9IGN1ckNTUyggZWxlbSwgbmFtZSwgc3R5bGVzICk7CgkJaWYgKCB2YWwgPCAwIHx8IHZhbCA9PSBudWxsICkgewoJCQl2YWwgPSBlbGVtLnN0eWxlWyBuYW1lIF07CgkJfQoKCQkvLyBDb21wdXRlZCB1bml0IGlzIG5vdCBwaXhlbHMuIFN0b3AgaGVyZSBhbmQgcmV0dXJuLgoJCWlmICggcm51bW5vbnB4LnRlc3QodmFsKSApIHsKCQkJcmV0dXJuIHZhbDsKCQl9CgoJCS8vIHdlIG5lZWQgdGhlIGNoZWNrIGZvciBzdHlsZSBpbiBjYXNlIGEgYnJvd3NlciB3aGljaCByZXR1cm5zIHVucmVsaWFibGUgdmFsdWVzCgkJLy8gZm9yIGdldENvbXB1dGVkU3R5bGUgc2lsZW50bHkgZmFsbHMgYmFjayB0byB0aGUgcmVsaWFibGUgZWxlbS5zdHlsZQoJCXZhbHVlSXNCb3JkZXJCb3ggPSBpc0JvcmRlckJveCAmJiAoIHN1cHBvcnQuYm94U2l6aW5nUmVsaWFibGUoKSB8fCB2YWwgPT09IGVsZW0uc3R5bGVbIG5hbWUgXSApOwoKCQkvLyBOb3JtYWxpemUgIiIsIGF1dG8sIGFuZCBwcmVwYXJlIGZvciBleHRyYQoJCXZhbCA9IHBhcnNlRmxvYXQoIHZhbCApIHx8IDA7Cgl9CgoJLy8gdXNlIHRoZSBhY3RpdmUgYm94LXNpemluZyBtb2RlbCB0byBhZGQvc3VidHJhY3QgaXJyZWxldmFudCBzdHlsZXMKCXJldHVybiAoIHZhbCArCgkJYXVnbWVudFdpZHRoT3JIZWlnaHQoCgkJCWVsZW0sCgkJCW5hbWUsCgkJCWV4dHJhIHx8ICggaXNCb3JkZXJCb3ggPyAiYm9yZGVyIiA6ICJjb250ZW50IiApLAoJCQl2YWx1ZUlzQm9yZGVyQm94LAoJCQlzdHlsZXMKCQkpCgkpICsgInB4IjsKfQoKalF1ZXJ5LmV4dGVuZCh7CgkvLyBBZGQgaW4gc3R5bGUgcHJvcGVydHkgaG9va3MgZm9yIG92ZXJyaWRpbmcgdGhlIGRlZmF1bHQKCS8vIGJlaGF2aW9yIG9mIGdldHRpbmcgYW5kIHNldHRpbmcgYSBzdHlsZSBwcm9wZXJ0eQoJY3NzSG9va3M6IHsKCQlvcGFjaXR5OiB7CgkJCWdldDogZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkICkgewoJCQkJaWYgKCBjb21wdXRlZCApIHsKCQkJCQkvLyBXZSBzaG91bGQgYWx3YXlzIGdldCBhIG51bWJlciBiYWNrIGZyb20gb3BhY2l0eQoJCQkJCXZhciByZXQgPSBjdXJDU1MoIGVsZW0sICJvcGFjaXR5IiApOwoJCQkJCXJldHVybiByZXQgPT09ICIiID8gIjEiIDogcmV0OwoJCQkJfQoJCQl9CgkJfQoJfSwKCgkvLyBEb24ndCBhdXRvbWF0aWNhbGx5IGFkZCAicHgiIHRvIHRoZXNlIHBvc3NpYmx5LXVuaXRsZXNzIHByb3BlcnRpZXMKCWNzc051bWJlcjogewoJCSJjb2x1bW5Db3VudCI6IHRydWUsCgkJImZpbGxPcGFjaXR5IjogdHJ1ZSwKCQkiZm9udFdlaWdodCI6IHRydWUsCgkJImxpbmVIZWlnaHQiOiB0cnVlLAoJCSJvcGFjaXR5IjogdHJ1ZSwKCQkib3JkZXIiOiB0cnVlLAoJCSJvcnBoYW5zIjogdHJ1ZSwKCQkid2lkb3dzIjogdHJ1ZSwKCQkiekluZGV4IjogdHJ1ZSwKCQkiem9vbSI6IHRydWUKCX0sCgoJLy8gQWRkIGluIHByb3BlcnRpZXMgd2hvc2UgbmFtZXMgeW91IHdpc2ggdG8gZml4IGJlZm9yZQoJLy8gc2V0dGluZyBvciBnZXR0aW5nIHRoZSB2YWx1ZQoJY3NzUHJvcHM6IHsKCQkvLyBub3JtYWxpemUgZmxvYXQgY3NzIHByb3BlcnR5CgkJImZsb2F0Ijogc3VwcG9ydC5jc3NGbG9hdCA/ICJjc3NGbG9hdCIgOiAic3R5bGVGbG9hdCIKCX0sCgoJLy8gR2V0IGFuZCBzZXQgdGhlIHN0eWxlIHByb3BlcnR5IG9uIGEgRE9NIE5vZGUKCXN0eWxlOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUsIGV4dHJhICkgewoJCS8vIERvbid0IHNldCBzdHlsZXMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwoJCWlmICggIWVsZW0gfHwgZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4IHx8ICFlbGVtLnN0eWxlICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBNYWtlIHN1cmUgdGhhdCB3ZSdyZSB3b3JraW5nIHdpdGggdGhlIHJpZ2h0IG5hbWUKCQl2YXIgcmV0LCB0eXBlLCBob29rcywKCQkJb3JpZ05hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKCBuYW1lICksCgkJCXN0eWxlID0gZWxlbS5zdHlsZTsKCgkJbmFtZSA9IGpRdWVyeS5jc3NQcm9wc1sgb3JpZ05hbWUgXSB8fCAoIGpRdWVyeS5jc3NQcm9wc1sgb3JpZ05hbWUgXSA9IHZlbmRvclByb3BOYW1lKCBzdHlsZSwgb3JpZ05hbWUgKSApOwoKCQkvLyBnZXRzIGhvb2sgZm9yIHRoZSBwcmVmaXhlZCB2ZXJzaW9uCgkJLy8gZm9sbG93ZWQgYnkgdGhlIHVucHJlZml4ZWQgdmVyc2lvbgoJCWhvb2tzID0galF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF0gfHwgalF1ZXJ5LmNzc0hvb2tzWyBvcmlnTmFtZSBdOwoKCQkvLyBDaGVjayBpZiB3ZSdyZSBzZXR0aW5nIGEgdmFsdWUKCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCXR5cGUgPSB0eXBlb2YgdmFsdWU7CgoJCQkvLyBjb252ZXJ0IHJlbGF0aXZlIG51bWJlciBzdHJpbmdzICgrPSBvciAtPSkgdG8gcmVsYXRpdmUgbnVtYmVycy4gIzczNDUKCQkJaWYgKCB0eXBlID09PSAic3RyaW5nIiAmJiAocmV0ID0gcnJlbE51bS5leGVjKCB2YWx1ZSApKSApIHsKCQkJCXZhbHVlID0gKCByZXRbMV0gKyAxICkgKiByZXRbMl0gKyBwYXJzZUZsb2F0KCBqUXVlcnkuY3NzKCBlbGVtLCBuYW1lICkgKTsKCQkJCS8vIEZpeGVzIGJ1ZyAjOTIzNwoJCQkJdHlwZSA9ICJudW1iZXIiOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgdGhhdCBudWxsIGFuZCBOYU4gdmFsdWVzIGFyZW4ndCBzZXQuIFNlZTogIzcxMTYKCQkJaWYgKCB2YWx1ZSA9PSBudWxsIHx8IHZhbHVlICE9PSB2YWx1ZSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gSWYgYSBudW1iZXIgd2FzIHBhc3NlZCBpbiwgYWRkICdweCcgdG8gdGhlIChleGNlcHQgZm9yIGNlcnRhaW4gQ1NTIHByb3BlcnRpZXMpCgkJCWlmICggdHlwZSA9PT0gIm51bWJlciIgJiYgIWpRdWVyeS5jc3NOdW1iZXJbIG9yaWdOYW1lIF0gKSB7CgkJCQl2YWx1ZSArPSAicHgiOwoJCQl9CgoJCQkvLyBGaXhlcyAjODkwOCwgaXQgY2FuIGJlIGRvbmUgbW9yZSBjb3JyZWN0bHkgYnkgc3BlY2lmaW5nIHNldHRlcnMgaW4gY3NzSG9va3MsCgkJCS8vIGJ1dCBpdCB3b3VsZCBtZWFuIHRvIGRlZmluZSBlaWdodCAoZm9yIGV2ZXJ5IHByb2JsZW1hdGljIHByb3BlcnR5KSBpZGVudGljYWwgZnVuY3Rpb25zCgkJCWlmICggIXN1cHBvcnQuY2xlYXJDbG9uZVN0eWxlICYmIHZhbHVlID09PSAiIiAmJiBuYW1lLmluZGV4T2YoImJhY2tncm91bmQiKSA9PT0gMCApIHsKCQkJCXN0eWxlWyBuYW1lIF0gPSAiaW5oZXJpdCI7CgkJCX0KCgkJCS8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQsIHVzZSB0aGF0IHZhbHVlLCBvdGhlcndpc2UganVzdCBzZXQgdGhlIHNwZWNpZmllZCB2YWx1ZQoJCQlpZiAoICFob29rcyB8fCAhKCJzZXQiIGluIGhvb2tzKSB8fCAodmFsdWUgPSBob29rcy5zZXQoIGVsZW0sIHZhbHVlLCBleHRyYSApKSAhPT0gdW5kZWZpbmVkICkgewoKCQkJCS8vIFN1cHBvcnQ6IElFCgkJCQkvLyBTd2FsbG93IGVycm9ycyBmcm9tICdpbnZhbGlkJyBDU1MgdmFsdWVzICgjNTUwOSkKCQkJCXRyeSB7CgkJCQkJLy8gU3VwcG9ydDogQ2hyb21lLCBTYWZhcmkKCQkJCQkvLyBTZXR0aW5nIHN0eWxlIHRvIGJsYW5rIHN0cmluZyByZXF1aXJlZCB0byBkZWxldGUgInN0eWxlOiB4ICFpbXBvcnRhbnQ7IgoJCQkJCXN0eWxlWyBuYW1lIF0gPSAiIjsKCQkJCQlzdHlsZVsgbmFtZSBdID0gdmFsdWU7CgkJCQl9IGNhdGNoKGUpIHt9CgkJCX0KCgkJfSBlbHNlIHsKCQkJLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCBnZXQgdGhlIG5vbi1jb21wdXRlZCB2YWx1ZSBmcm9tIHRoZXJlCgkJCWlmICggaG9va3MgJiYgImdldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLmdldCggZWxlbSwgZmFsc2UsIGV4dHJhICkpICE9PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gcmV0OwoJCQl9CgoJCQkvLyBPdGhlcndpc2UganVzdCBnZXQgdGhlIHZhbHVlIGZyb20gdGhlIHN0eWxlIG9iamVjdAoJCQlyZXR1cm4gc3R5bGVbIG5hbWUgXTsKCQl9Cgl9LAoKCWNzczogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGV4dHJhLCBzdHlsZXMgKSB7CgkJdmFyIG51bSwgdmFsLCBob29rcywKCQkJb3JpZ05hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKCBuYW1lICk7CgoJCS8vIE1ha2Ugc3VyZSB0aGF0IHdlJ3JlIHdvcmtpbmcgd2l0aCB0aGUgcmlnaHQgbmFtZQoJCW5hbWUgPSBqUXVlcnkuY3NzUHJvcHNbIG9yaWdOYW1lIF0gfHwgKCBqUXVlcnkuY3NzUHJvcHNbIG9yaWdOYW1lIF0gPSB2ZW5kb3JQcm9wTmFtZSggZWxlbS5zdHlsZSwgb3JpZ05hbWUgKSApOwoKCQkvLyBnZXRzIGhvb2sgZm9yIHRoZSBwcmVmaXhlZCB2ZXJzaW9uCgkJLy8gZm9sbG93ZWQgYnkgdGhlIHVucHJlZml4ZWQgdmVyc2lvbgoJCWhvb2tzID0galF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF0gfHwgalF1ZXJ5LmNzc0hvb2tzWyBvcmlnTmFtZSBdOwoKCQkvLyBJZiBhIGhvb2sgd2FzIHByb3ZpZGVkIGdldCB0aGUgY29tcHV0ZWQgdmFsdWUgZnJvbSB0aGVyZQoJCWlmICggaG9va3MgJiYgImdldCIgaW4gaG9va3MgKSB7CgkJCXZhbCA9IGhvb2tzLmdldCggZWxlbSwgdHJ1ZSwgZXh0cmEgKTsKCQl9CgoJCS8vIE90aGVyd2lzZSwgaWYgYSB3YXkgdG8gZ2V0IHRoZSBjb21wdXRlZCB2YWx1ZSBleGlzdHMsIHVzZSB0aGF0CgkJaWYgKCB2YWwgPT09IHVuZGVmaW5lZCApIHsKCQkJdmFsID0gY3VyQ1NTKCBlbGVtLCBuYW1lLCBzdHlsZXMgKTsKCQl9CgoJCS8vY29udmVydCAibm9ybWFsIiB0byBjb21wdXRlZCB2YWx1ZQoJCWlmICggdmFsID09PSAibm9ybWFsIiAmJiBuYW1lIGluIGNzc05vcm1hbFRyYW5zZm9ybSApIHsKCQkJdmFsID0gY3NzTm9ybWFsVHJhbnNmb3JtWyBuYW1lIF07CgkJfQoKCQkvLyBSZXR1cm4sIGNvbnZlcnRpbmcgdG8gbnVtYmVyIGlmIGZvcmNlZCBvciBhIHF1YWxpZmllciB3YXMgcHJvdmlkZWQgYW5kIHZhbCBsb29rcyBudW1lcmljCgkJaWYgKCBleHRyYSA9PT0gIiIgfHwgZXh0cmEgKSB7CgkJCW51bSA9IHBhcnNlRmxvYXQoIHZhbCApOwoJCQlyZXR1cm4gZXh0cmEgPT09IHRydWUgfHwgalF1ZXJ5LmlzTnVtZXJpYyggbnVtICkgPyBudW0gfHwgMCA6IHZhbDsKCQl9CgkJcmV0dXJuIHZhbDsKCX0KfSk7CgpqUXVlcnkuZWFjaChbICJoZWlnaHQiLCAid2lkdGgiIF0sIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoJalF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF0gPSB7CgkJZ2V0OiBmdW5jdGlvbiggZWxlbSwgY29tcHV0ZWQsIGV4dHJhICkgewoJCQlpZiAoIGNvbXB1dGVkICkgewoJCQkJLy8gY2VydGFpbiBlbGVtZW50cyBjYW4gaGF2ZSBkaW1lbnNpb24gaW5mbyBpZiB3ZSBpbnZpc2libHkgc2hvdyB0aGVtCgkJCQkvLyBob3dldmVyLCBpdCBtdXN0IGhhdmUgYSBjdXJyZW50IGRpc3BsYXkgc3R5bGUgdGhhdCB3b3VsZCBiZW5lZml0IGZyb20gdGhpcwoJCQkJcmV0dXJuIGVsZW0ub2Zmc2V0V2lkdGggPT09IDAgJiYgcmRpc3BsYXlzd2FwLnRlc3QoIGpRdWVyeS5jc3MoIGVsZW0sICJkaXNwbGF5IiApICkgPwoJCQkJCWpRdWVyeS5zd2FwKCBlbGVtLCBjc3NTaG93LCBmdW5jdGlvbigpIHsKCQkJCQkJcmV0dXJuIGdldFdpZHRoT3JIZWlnaHQoIGVsZW0sIG5hbWUsIGV4dHJhICk7CgkJCQkJfSkgOgoJCQkJCWdldFdpZHRoT3JIZWlnaHQoIGVsZW0sIG5hbWUsIGV4dHJhICk7CgkJCX0KCQl9LAoKCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSwgZXh0cmEgKSB7CgkJCXZhciBzdHlsZXMgPSBleHRyYSAmJiBnZXRTdHlsZXMoIGVsZW0gKTsKCQkJcmV0dXJuIHNldFBvc2l0aXZlTnVtYmVyKCBlbGVtLCB2YWx1ZSwgZXh0cmEgPwoJCQkJYXVnbWVudFdpZHRoT3JIZWlnaHQoCgkJCQkJZWxlbSwKCQkJCQluYW1lLAoJCQkJCWV4dHJhLAoJCQkJCXN1cHBvcnQuYm94U2l6aW5nKCkgJiYgalF1ZXJ5LmNzcyggZWxlbSwgImJveFNpemluZyIsIGZhbHNlLCBzdHlsZXMgKSA9PT0gImJvcmRlci1ib3giLAoJCQkJCXN0eWxlcwoJCQkJKSA6IDAKCQkJKTsKCQl9Cgl9Owp9KTsKCmlmICggIXN1cHBvcnQub3BhY2l0eSApIHsKCWpRdWVyeS5jc3NIb29rcy5vcGFjaXR5ID0gewoJCWdldDogZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkICkgewoJCQkvLyBJRSB1c2VzIGZpbHRlcnMgZm9yIG9wYWNpdHkKCQkJcmV0dXJuIHJvcGFjaXR5LnRlc3QoIChjb21wdXRlZCAmJiBlbGVtLmN1cnJlbnRTdHlsZSA/IGVsZW0uY3VycmVudFN0eWxlLmZpbHRlciA6IGVsZW0uc3R5bGUuZmlsdGVyKSB8fCAiIiApID8KCQkJCSggMC4wMSAqIHBhcnNlRmxvYXQoIFJlZ0V4cC4kMSApICkgKyAiIiA6CgkJCQljb21wdXRlZCA/ICIxIiA6ICIiOwoJCX0sCgoJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgewoJCQl2YXIgc3R5bGUgPSBlbGVtLnN0eWxlLAoJCQkJY3VycmVudFN0eWxlID0gZWxlbS5jdXJyZW50U3R5bGUsCgkJCQlvcGFjaXR5ID0galF1ZXJ5LmlzTnVtZXJpYyggdmFsdWUgKSA/ICJhbHBoYShvcGFjaXR5PSIgKyB2YWx1ZSAqIDEwMCArICIpIiA6ICIiLAoJCQkJZmlsdGVyID0gY3VycmVudFN0eWxlICYmIGN1cnJlbnRTdHlsZS5maWx0ZXIgfHwgc3R5bGUuZmlsdGVyIHx8ICIiOwoKCQkJLy8gSUUgaGFzIHRyb3VibGUgd2l0aCBvcGFjaXR5IGlmIGl0IGRvZXMgbm90IGhhdmUgbGF5b3V0CgkJCS8vIEZvcmNlIGl0IGJ5IHNldHRpbmcgdGhlIHpvb20gbGV2ZWwKCQkJc3R5bGUuem9vbSA9IDE7CgoJCQkvLyBpZiBzZXR0aW5nIG9wYWNpdHkgdG8gMSwgYW5kIG5vIG90aGVyIGZpbHRlcnMgZXhpc3QgLSBhdHRlbXB0IHRvIHJlbW92ZSBmaWx0ZXIgYXR0cmlidXRlICM2NjUyCgkJCS8vIGlmIHZhbHVlID09PSAiIiwgdGhlbiByZW1vdmUgaW5saW5lIG9wYWNpdHkgIzEyNjg1CgkJCWlmICggKCB2YWx1ZSA+PSAxIHx8IHZhbHVlID09PSAiIiApICYmCgkJCQkJalF1ZXJ5LnRyaW0oIGZpbHRlci5yZXBsYWNlKCByYWxwaGEsICIiICkgKSA9PT0gIiIgJiYKCQkJCQlzdHlsZS5yZW1vdmVBdHRyaWJ1dGUgKSB7CgoJCQkJLy8gU2V0dGluZyBzdHlsZS5maWx0ZXIgdG8gbnVsbCwgIiIgJiAiICIgc3RpbGwgbGVhdmUgImZpbHRlcjoiIGluIHRoZSBjc3NUZXh0CgkJCQkvLyBpZiAiZmlsdGVyOiIgaXMgcHJlc2VudCBhdCBhbGwsIGNsZWFyVHlwZSBpcyBkaXNhYmxlZCwgd2Ugd2FudCB0byBhdm9pZCB0aGlzCgkJCQkvLyBzdHlsZS5yZW1vdmVBdHRyaWJ1dGUgaXMgSUUgT25seSwgYnV0IHNvIGFwcGFyZW50bHkgaXMgdGhpcyBjb2RlIHBhdGguLi4KCQkJCXN0eWxlLnJlbW92ZUF0dHJpYnV0ZSggImZpbHRlciIgKTsKCgkJCQkvLyBpZiB0aGVyZSBpcyBubyBmaWx0ZXIgc3R5bGUgYXBwbGllZCBpbiBhIGNzcyBydWxlIG9yIHVuc2V0IGlubGluZSBvcGFjaXR5LCB3ZSBhcmUgZG9uZQoJCQkJaWYgKCB2YWx1ZSA9PT0gIiIgfHwgY3VycmVudFN0eWxlICYmICFjdXJyZW50U3R5bGUuZmlsdGVyICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJLy8gb3RoZXJ3aXNlLCBzZXQgbmV3IGZpbHRlciB2YWx1ZXMKCQkJc3R5bGUuZmlsdGVyID0gcmFscGhhLnRlc3QoIGZpbHRlciApID8KCQkJCWZpbHRlci5yZXBsYWNlKCByYWxwaGEsIG9wYWNpdHkgKSA6CgkJCQlmaWx0ZXIgKyAiICIgKyBvcGFjaXR5OwoJCX0KCX07Cn0KCmpRdWVyeS5jc3NIb29rcy5tYXJnaW5SaWdodCA9IGFkZEdldEhvb2tJZiggc3VwcG9ydC5yZWxpYWJsZU1hcmdpblJpZ2h0LAoJZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkICkgewoJCWlmICggY29tcHV0ZWQgKSB7CgkJCS8vIFdlYktpdCBCdWcgMTMzNDMgLSBnZXRDb21wdXRlZFN0eWxlIHJldHVybnMgd3JvbmcgdmFsdWUgZm9yIG1hcmdpbi1yaWdodAoJCQkvLyBXb3JrIGFyb3VuZCBieSB0ZW1wb3JhcmlseSBzZXR0aW5nIGVsZW1lbnQgZGlzcGxheSB0byBpbmxpbmUtYmxvY2sKCQkJcmV0dXJuIGpRdWVyeS5zd2FwKCBlbGVtLCB7ICJkaXNwbGF5IjogImlubGluZS1ibG9jayIgfSwKCQkJCWN1ckNTUywgWyBlbGVtLCAibWFyZ2luUmlnaHQiIF0gKTsKCQl9Cgl9Cik7CgovLyBUaGVzZSBob29rcyBhcmUgdXNlZCBieSBhbmltYXRlIHRvIGV4cGFuZCBwcm9wZXJ0aWVzCmpRdWVyeS5lYWNoKHsKCW1hcmdpbjogIiIsCglwYWRkaW5nOiAiIiwKCWJvcmRlcjogIldpZHRoIgp9LCBmdW5jdGlvbiggcHJlZml4LCBzdWZmaXggKSB7CglqUXVlcnkuY3NzSG9va3NbIHByZWZpeCArIHN1ZmZpeCBdID0gewoJCWV4cGFuZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl2YXIgaSA9IDAsCgkJCQlleHBhbmRlZCA9IHt9LAoKCQkJCS8vIGFzc3VtZXMgYSBzaW5nbGUgbnVtYmVyIGlmIG5vdCBhIHN0cmluZwoJCQkJcGFydHMgPSB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciID8gdmFsdWUuc3BsaXQoIiAiKSA6IFsgdmFsdWUgXTsKCgkJCWZvciAoIDsgaSA8IDQ7IGkrKyApIHsKCQkJCWV4cGFuZGVkWyBwcmVmaXggKyBjc3NFeHBhbmRbIGkgXSArIHN1ZmZpeCBdID0KCQkJCQlwYXJ0c1sgaSBdIHx8IHBhcnRzWyBpIC0gMiBdIHx8IHBhcnRzWyAwIF07CgkJCX0KCgkJCXJldHVybiBleHBhbmRlZDsKCQl9Cgl9OwoKCWlmICggIXJtYXJnaW4udGVzdCggcHJlZml4ICkgKSB7CgkJalF1ZXJ5LmNzc0hvb2tzWyBwcmVmaXggKyBzdWZmaXggXS5zZXQgPSBzZXRQb3NpdGl2ZU51bWJlcjsKCX0KfSk7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCWNzczogZnVuY3Rpb24oIG5hbWUsIHZhbHVlICkgewoJCXJldHVybiBhY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCB2YWx1ZSApIHsKCQkJdmFyIHN0eWxlcywgbGVuLAoJCQkJbWFwID0ge30sCgkJCQlpID0gMDsKCgkJCWlmICggalF1ZXJ5LmlzQXJyYXkoIG5hbWUgKSApIHsKCQkJCXN0eWxlcyA9IGdldFN0eWxlcyggZWxlbSApOwoJCQkJbGVuID0gbmFtZS5sZW5ndGg7CgoJCQkJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CgkJCQkJbWFwWyBuYW1lWyBpIF0gXSA9IGpRdWVyeS5jc3MoIGVsZW0sIG5hbWVbIGkgXSwgZmFsc2UsIHN0eWxlcyApOwoJCQkJfQoKCQkJCXJldHVybiBtYXA7CgkJCX0KCgkJCXJldHVybiB2YWx1ZSAhPT0gdW5kZWZpbmVkID8KCQkJCWpRdWVyeS5zdHlsZSggZWxlbSwgbmFtZSwgdmFsdWUgKSA6CgkJCQlqUXVlcnkuY3NzKCBlbGVtLCBuYW1lICk7CgkJfSwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxICk7Cgl9LAoJc2hvdzogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHNob3dIaWRlKCB0aGlzLCB0cnVlICk7Cgl9LAoJaGlkZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHNob3dIaWRlKCB0aGlzICk7Cgl9LAoJdG9nZ2xlOiBmdW5jdGlvbiggc3RhdGUgKSB7CgkJaWYgKCB0eXBlb2Ygc3RhdGUgPT09ICJib29sZWFuIiApIHsKCQkJcmV0dXJuIHN0YXRlID8gdGhpcy5zaG93KCkgOiB0aGlzLmhpZGUoKTsKCQl9CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWlmICggaXNIaWRkZW4oIHRoaXMgKSApIHsKCQkJCWpRdWVyeSggdGhpcyApLnNob3coKTsKCQkJfSBlbHNlIHsKCQkJCWpRdWVyeSggdGhpcyApLmhpZGUoKTsKCQkJfQoJCX0pOwoJfQp9KTsKCgpmdW5jdGlvbiBUd2VlbiggZWxlbSwgb3B0aW9ucywgcHJvcCwgZW5kLCBlYXNpbmcgKSB7CglyZXR1cm4gbmV3IFR3ZWVuLnByb3RvdHlwZS5pbml0KCBlbGVtLCBvcHRpb25zLCBwcm9wLCBlbmQsIGVhc2luZyApOwp9CmpRdWVyeS5Ud2VlbiA9IFR3ZWVuOwoKVHdlZW4ucHJvdG90eXBlID0gewoJY29uc3RydWN0b3I6IFR3ZWVuLAoJaW5pdDogZnVuY3Rpb24oIGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nLCB1bml0ICkgewoJCXRoaXMuZWxlbSA9IGVsZW07CgkJdGhpcy5wcm9wID0gcHJvcDsKCQl0aGlzLmVhc2luZyA9IGVhc2luZyB8fCAic3dpbmciOwoJCXRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CgkJdGhpcy5zdGFydCA9IHRoaXMubm93ID0gdGhpcy5jdXIoKTsKCQl0aGlzLmVuZCA9IGVuZDsKCQl0aGlzLnVuaXQgPSB1bml0IHx8ICggalF1ZXJ5LmNzc051bWJlclsgcHJvcCBdID8gIiIgOiAicHgiICk7Cgl9LAoJY3VyOiBmdW5jdGlvbigpIHsKCQl2YXIgaG9va3MgPSBUd2Vlbi5wcm9wSG9va3NbIHRoaXMucHJvcCBdOwoKCQlyZXR1cm4gaG9va3MgJiYgaG9va3MuZ2V0ID8KCQkJaG9va3MuZ2V0KCB0aGlzICkgOgoJCQlUd2Vlbi5wcm9wSG9va3MuX2RlZmF1bHQuZ2V0KCB0aGlzICk7Cgl9LAoJcnVuOiBmdW5jdGlvbiggcGVyY2VudCApIHsKCQl2YXIgZWFzZWQsCgkJCWhvb2tzID0gVHdlZW4ucHJvcEhvb2tzWyB0aGlzLnByb3AgXTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZHVyYXRpb24gKSB7CgkJCXRoaXMucG9zID0gZWFzZWQgPSBqUXVlcnkuZWFzaW5nWyB0aGlzLmVhc2luZyBdKAoJCQkJcGVyY2VudCwgdGhpcy5vcHRpb25zLmR1cmF0aW9uICogcGVyY2VudCwgMCwgMSwgdGhpcy5vcHRpb25zLmR1cmF0aW9uCgkJCSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5wb3MgPSBlYXNlZCA9IHBlcmNlbnQ7CgkJfQoJCXRoaXMubm93ID0gKCB0aGlzLmVuZCAtIHRoaXMuc3RhcnQgKSAqIGVhc2VkICsgdGhpcy5zdGFydDsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuc3RlcCApIHsKCQkJdGhpcy5vcHRpb25zLnN0ZXAuY2FsbCggdGhpcy5lbGVtLCB0aGlzLm5vdywgdGhpcyApOwoJCX0KCgkJaWYgKCBob29rcyAmJiBob29rcy5zZXQgKSB7CgkJCWhvb2tzLnNldCggdGhpcyApOwoJCX0gZWxzZSB7CgkJCVR3ZWVuLnByb3BIb29rcy5fZGVmYXVsdC5zZXQoIHRoaXMgKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cn07CgpUd2Vlbi5wcm90b3R5cGUuaW5pdC5wcm90b3R5cGUgPSBUd2Vlbi5wcm90b3R5cGU7CgpUd2Vlbi5wcm9wSG9va3MgPSB7CglfZGVmYXVsdDogewoJCWdldDogZnVuY3Rpb24oIHR3ZWVuICkgewoJCQl2YXIgcmVzdWx0OwoKCQkJaWYgKCB0d2Vlbi5lbGVtWyB0d2Vlbi5wcm9wIF0gIT0gbnVsbCAmJgoJCQkJKCF0d2Vlbi5lbGVtLnN0eWxlIHx8IHR3ZWVuLmVsZW0uc3R5bGVbIHR3ZWVuLnByb3AgXSA9PSBudWxsKSApIHsKCQkJCXJldHVybiB0d2Vlbi5lbGVtWyB0d2Vlbi5wcm9wIF07CgkJCX0KCgkJCS8vIHBhc3NpbmcgYW4gZW1wdHkgc3RyaW5nIGFzIGEgM3JkIHBhcmFtZXRlciB0byAuY3NzIHdpbGwgYXV0b21hdGljYWxseQoJCQkvLyBhdHRlbXB0IGEgcGFyc2VGbG9hdCBhbmQgZmFsbGJhY2sgdG8gYSBzdHJpbmcgaWYgdGhlIHBhcnNlIGZhaWxzCgkJCS8vIHNvLCBzaW1wbGUgdmFsdWVzIHN1Y2ggYXMgIjEwcHgiIGFyZSBwYXJzZWQgdG8gRmxvYXQuCgkJCS8vIGNvbXBsZXggdmFsdWVzIHN1Y2ggYXMgInJvdGF0ZSgxcmFkKSIgYXJlIHJldHVybmVkIGFzIGlzLgoJCQlyZXN1bHQgPSBqUXVlcnkuY3NzKCB0d2Vlbi5lbGVtLCB0d2Vlbi5wcm9wLCAiIiApOwoJCQkvLyBFbXB0eSBzdHJpbmdzLCBudWxsLCB1bmRlZmluZWQgYW5kICJhdXRvIiBhcmUgY29udmVydGVkIHRvIDAuCgkJCXJldHVybiAhcmVzdWx0IHx8IHJlc3VsdCA9PT0gImF1dG8iID8gMCA6IHJlc3VsdDsKCQl9LAoJCXNldDogZnVuY3Rpb24oIHR3ZWVuICkgewoJCQkvLyB1c2Ugc3RlcCBob29rIGZvciBiYWNrIGNvbXBhdCAtIHVzZSBjc3NIb29rIGlmIGl0cyB0aGVyZSAtIHVzZSAuc3R5bGUgaWYgaXRzCgkJCS8vIGF2YWlsYWJsZSBhbmQgdXNlIHBsYWluIHByb3BlcnRpZXMgd2hlcmUgYXZhaWxhYmxlCgkJCWlmICggalF1ZXJ5LmZ4LnN0ZXBbIHR3ZWVuLnByb3AgXSApIHsKCQkJCWpRdWVyeS5meC5zdGVwWyB0d2Vlbi5wcm9wIF0oIHR3ZWVuICk7CgkJCX0gZWxzZSBpZiAoIHR3ZWVuLmVsZW0uc3R5bGUgJiYgKCB0d2Vlbi5lbGVtLnN0eWxlWyBqUXVlcnkuY3NzUHJvcHNbIHR3ZWVuLnByb3AgXSBdICE9IG51bGwgfHwgalF1ZXJ5LmNzc0hvb2tzWyB0d2Vlbi5wcm9wIF0gKSApIHsKCQkJCWpRdWVyeS5zdHlsZSggdHdlZW4uZWxlbSwgdHdlZW4ucHJvcCwgdHdlZW4ubm93ICsgdHdlZW4udW5pdCApOwoJCQl9IGVsc2UgewoJCQkJdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdID0gdHdlZW4ubm93OwoJCQl9CgkJfQoJfQp9OwoKLy8gU3VwcG9ydDogSUUgPD05Ci8vIFBhbmljIGJhc2VkIGFwcHJvYWNoIHRvIHNldHRpbmcgdGhpbmdzIG9uIGRpc2Nvbm5lY3RlZCBub2RlcwoKVHdlZW4ucHJvcEhvb2tzLnNjcm9sbFRvcCA9IFR3ZWVuLnByb3BIb29rcy5zY3JvbGxMZWZ0ID0gewoJc2V0OiBmdW5jdGlvbiggdHdlZW4gKSB7CgkJaWYgKCB0d2Vlbi5lbGVtLm5vZGVUeXBlICYmIHR3ZWVuLmVsZW0ucGFyZW50Tm9kZSApIHsKCQkJdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdID0gdHdlZW4ubm93OwoJCX0KCX0KfTsKCmpRdWVyeS5lYXNpbmcgPSB7CglsaW5lYXI6IGZ1bmN0aW9uKCBwICkgewoJCXJldHVybiBwOwoJfSwKCXN3aW5nOiBmdW5jdGlvbiggcCApIHsKCQlyZXR1cm4gMC41IC0gTWF0aC5jb3MoIHAgKiBNYXRoLlBJICkgLyAyOwoJfQp9OwoKalF1ZXJ5LmZ4ID0gVHdlZW4ucHJvdG90eXBlLmluaXQ7CgovLyBCYWNrIENvbXBhdCA8MS44IGV4dGVuc2lvbiBwb2ludApqUXVlcnkuZnguc3RlcCA9IHt9OwoKCgoKdmFyCglmeE5vdywgdGltZXJJZCwKCXJmeHR5cGVzID0gL14oPzp0b2dnbGV8c2hvd3xoaWRlKSQvLAoJcmZ4bnVtID0gbmV3IFJlZ0V4cCggIl4oPzooWystXSk9fCkoIiArIHBudW0gKyAiKShbYS16JV0qKSQiLCAiaSIgKSwKCXJydW4gPSAvcXVldWVIb29rcyQvLAoJYW5pbWF0aW9uUHJlZmlsdGVycyA9IFsgZGVmYXVsdFByZWZpbHRlciBdLAoJdHdlZW5lcnMgPSB7CgkJIioiOiBbIGZ1bmN0aW9uKCBwcm9wLCB2YWx1ZSApIHsKCQkJdmFyIHR3ZWVuID0gdGhpcy5jcmVhdGVUd2VlbiggcHJvcCwgdmFsdWUgKSwKCQkJCXRhcmdldCA9IHR3ZWVuLmN1cigpLAoJCQkJcGFydHMgPSByZnhudW0uZXhlYyggdmFsdWUgKSwKCQkJCXVuaXQgPSBwYXJ0cyAmJiBwYXJ0c1sgMyBdIHx8ICggalF1ZXJ5LmNzc051bWJlclsgcHJvcCBdID8gIiIgOiAicHgiICksCgoJCQkJLy8gU3RhcnRpbmcgdmFsdWUgY29tcHV0YXRpb24gaXMgcmVxdWlyZWQgZm9yIHBvdGVudGlhbCB1bml0IG1pc21hdGNoZXMKCQkJCXN0YXJ0ID0gKCBqUXVlcnkuY3NzTnVtYmVyWyBwcm9wIF0gfHwgdW5pdCAhPT0gInB4IiAmJiArdGFyZ2V0ICkgJiYKCQkJCQlyZnhudW0uZXhlYyggalF1ZXJ5LmNzcyggdHdlZW4uZWxlbSwgcHJvcCApICksCgkJCQlzY2FsZSA9IDEsCgkJCQltYXhJdGVyYXRpb25zID0gMjA7CgoJCQlpZiAoIHN0YXJ0ICYmIHN0YXJ0WyAzIF0gIT09IHVuaXQgKSB7CgkJCQkvLyBUcnVzdCB1bml0cyByZXBvcnRlZCBieSBqUXVlcnkuY3NzCgkJCQl1bml0ID0gdW5pdCB8fCBzdGFydFsgMyBdOwoKCQkJCS8vIE1ha2Ugc3VyZSB3ZSB1cGRhdGUgdGhlIHR3ZWVuIHByb3BlcnRpZXMgbGF0ZXIgb24KCQkJCXBhcnRzID0gcGFydHMgfHwgW107CgoJCQkJLy8gSXRlcmF0aXZlbHkgYXBwcm94aW1hdGUgZnJvbSBhIG5vbnplcm8gc3RhcnRpbmcgcG9pbnQKCQkJCXN0YXJ0ID0gK3RhcmdldCB8fCAxOwoKCQkJCWRvIHsKCQkJCQkvLyBJZiBwcmV2aW91cyBpdGVyYXRpb24gemVyb2VkIG91dCwgZG91YmxlIHVudGlsIHdlIGdldCAqc29tZXRoaW5nKgoJCQkJCS8vIFVzZSBhIHN0cmluZyBmb3IgZG91YmxpbmcgZmFjdG9yIHNvIHdlIGRvbid0IGFjY2lkZW50YWxseSBzZWUgc2NhbGUgYXMgdW5jaGFuZ2VkIGJlbG93CgkJCQkJc2NhbGUgPSBzY2FsZSB8fCAiLjUiOwoKCQkJCQkvLyBBZGp1c3QgYW5kIGFwcGx5CgkJCQkJc3RhcnQgPSBzdGFydCAvIHNjYWxlOwoJCQkJCWpRdWVyeS5zdHlsZSggdHdlZW4uZWxlbSwgcHJvcCwgc3RhcnQgKyB1bml0ICk7CgoJCQkJLy8gVXBkYXRlIHNjYWxlLCB0b2xlcmF0aW5nIHplcm8gb3IgTmFOIGZyb20gdHdlZW4uY3VyKCkKCQkJCS8vIEFuZCBicmVha2luZyB0aGUgbG9vcCBpZiBzY2FsZSBpcyB1bmNoYW5nZWQgb3IgcGVyZmVjdCwgb3IgaWYgd2UndmUganVzdCBoYWQgZW5vdWdoCgkJCQl9IHdoaWxlICggc2NhbGUgIT09IChzY2FsZSA9IHR3ZWVuLmN1cigpIC8gdGFyZ2V0KSAmJiBzY2FsZSAhPT0gMSAmJiAtLW1heEl0ZXJhdGlvbnMgKTsKCQkJfQoKCQkJLy8gVXBkYXRlIHR3ZWVuIHByb3BlcnRpZXMKCQkJaWYgKCBwYXJ0cyApIHsKCQkJCXN0YXJ0ID0gdHdlZW4uc3RhcnQgPSArc3RhcnQgfHwgK3RhcmdldCB8fCAwOwoJCQkJdHdlZW4udW5pdCA9IHVuaXQ7CgkJCQkvLyBJZiBhICs9Ly09IHRva2VuIHdhcyBwcm92aWRlZCwgd2UncmUgZG9pbmcgYSByZWxhdGl2ZSBhbmltYXRpb24KCQkJCXR3ZWVuLmVuZCA9IHBhcnRzWyAxIF0gPwoJCQkJCXN0YXJ0ICsgKCBwYXJ0c1sgMSBdICsgMSApICogcGFydHNbIDIgXSA6CgkJCQkJK3BhcnRzWyAyIF07CgkJCX0KCgkJCXJldHVybiB0d2VlbjsKCQl9IF0KCX07CgovLyBBbmltYXRpb25zIGNyZWF0ZWQgc3luY2hyb25vdXNseSB3aWxsIHJ1biBzeW5jaHJvbm91c2x5CmZ1bmN0aW9uIGNyZWF0ZUZ4Tm93KCkgewoJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQlmeE5vdyA9IHVuZGVmaW5lZDsKCX0pOwoJcmV0dXJuICggZnhOb3cgPSBqUXVlcnkubm93KCkgKTsKfQoKLy8gR2VuZXJhdGUgcGFyYW1ldGVycyB0byBjcmVhdGUgYSBzdGFuZGFyZCBhbmltYXRpb24KZnVuY3Rpb24gZ2VuRngoIHR5cGUsIGluY2x1ZGVXaWR0aCApIHsKCXZhciB3aGljaCwKCQlhdHRycyA9IHsgaGVpZ2h0OiB0eXBlIH0sCgkJaSA9IDA7CgoJLy8gaWYgd2UgaW5jbHVkZSB3aWR0aCwgc3RlcCB2YWx1ZSBpcyAxIHRvIGRvIGFsbCBjc3NFeHBhbmQgdmFsdWVzLAoJLy8gaWYgd2UgZG9uJ3QgaW5jbHVkZSB3aWR0aCwgc3RlcCB2YWx1ZSBpcyAyIHRvIHNraXAgb3ZlciBMZWZ0IGFuZCBSaWdodAoJaW5jbHVkZVdpZHRoID0gaW5jbHVkZVdpZHRoID8gMSA6IDA7Cglmb3IgKCA7IGkgPCA0IDsgaSArPSAyIC0gaW5jbHVkZVdpZHRoICkgewoJCXdoaWNoID0gY3NzRXhwYW5kWyBpIF07CgkJYXR0cnNbICJtYXJnaW4iICsgd2hpY2ggXSA9IGF0dHJzWyAicGFkZGluZyIgKyB3aGljaCBdID0gdHlwZTsKCX0KCglpZiAoIGluY2x1ZGVXaWR0aCApIHsKCQlhdHRycy5vcGFjaXR5ID0gYXR0cnMud2lkdGggPSB0eXBlOwoJfQoKCXJldHVybiBhdHRyczsKfQoKZnVuY3Rpb24gY3JlYXRlVHdlZW4oIHZhbHVlLCBwcm9wLCBhbmltYXRpb24gKSB7Cgl2YXIgdHdlZW4sCgkJY29sbGVjdGlvbiA9ICggdHdlZW5lcnNbIHByb3AgXSB8fCBbXSApLmNvbmNhdCggdHdlZW5lcnNbICIqIiBdICksCgkJaW5kZXggPSAwLAoJCWxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoJZm9yICggOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsKCQlpZiAoICh0d2VlbiA9IGNvbGxlY3Rpb25bIGluZGV4IF0uY2FsbCggYW5pbWF0aW9uLCBwcm9wLCB2YWx1ZSApKSApIHsKCgkJCS8vIHdlJ3JlIGRvbmUgd2l0aCB0aGlzIHByb3BlcnR5CgkJCXJldHVybiB0d2VlbjsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIGRlZmF1bHRQcmVmaWx0ZXIoIGVsZW0sIHByb3BzLCBvcHRzICkgewoJLyoganNoaW50IHZhbGlkdGhpczogdHJ1ZSAqLwoJdmFyIHByb3AsIHZhbHVlLCB0b2dnbGUsIHR3ZWVuLCBob29rcywgb2xkZmlyZSwgZGlzcGxheSwgZERpc3BsYXksCgkJYW5pbSA9IHRoaXMsCgkJb3JpZyA9IHt9LAoJCXN0eWxlID0gZWxlbS5zdHlsZSwKCQloaWRkZW4gPSBlbGVtLm5vZGVUeXBlICYmIGlzSGlkZGVuKCBlbGVtICksCgkJZGF0YVNob3cgPSBqUXVlcnkuX2RhdGEoIGVsZW0sICJmeHNob3ciICk7CgoJLy8gaGFuZGxlIHF1ZXVlOiBmYWxzZSBwcm9taXNlcwoJaWYgKCAhb3B0cy5xdWV1ZSApIHsKCQlob29rcyA9IGpRdWVyeS5fcXVldWVIb29rcyggZWxlbSwgImZ4IiApOwoJCWlmICggaG9va3MudW5xdWV1ZWQgPT0gbnVsbCApIHsKCQkJaG9va3MudW5xdWV1ZWQgPSAwOwoJCQlvbGRmaXJlID0gaG9va3MuZW1wdHkuZmlyZTsKCQkJaG9va3MuZW1wdHkuZmlyZSA9IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCAhaG9va3MudW5xdWV1ZWQgKSB7CgkJCQkJb2xkZmlyZSgpOwoJCQkJfQoJCQl9OwoJCX0KCQlob29rcy51bnF1ZXVlZCsrOwoKCQlhbmltLmFsd2F5cyhmdW5jdGlvbigpIHsKCQkJLy8gZG9pbmcgdGhpcyBtYWtlcyBzdXJlIHRoYXQgdGhlIGNvbXBsZXRlIGhhbmRsZXIgd2lsbCBiZSBjYWxsZWQKCQkJLy8gYmVmb3JlIHRoaXMgY29tcGxldGVzCgkJCWFuaW0uYWx3YXlzKGZ1bmN0aW9uKCkgewoJCQkJaG9va3MudW5xdWV1ZWQtLTsKCQkJCWlmICggIWpRdWVyeS5xdWV1ZSggZWxlbSwgImZ4IiApLmxlbmd0aCApIHsKCQkJCQlob29rcy5lbXB0eS5maXJlKCk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJfQoKCS8vIGhlaWdodC93aWR0aCBvdmVyZmxvdyBwYXNzCglpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgKCAiaGVpZ2h0IiBpbiBwcm9wcyB8fCAid2lkdGgiIGluIHByb3BzICkgKSB7CgkJLy8gTWFrZSBzdXJlIHRoYXQgbm90aGluZyBzbmVha3Mgb3V0CgkJLy8gUmVjb3JkIGFsbCAzIG92ZXJmbG93IGF0dHJpYnV0ZXMgYmVjYXVzZSBJRSBkb2VzIG5vdAoJCS8vIGNoYW5nZSB0aGUgb3ZlcmZsb3cgYXR0cmlidXRlIHdoZW4gb3ZlcmZsb3dYIGFuZAoJCS8vIG92ZXJmbG93WSBhcmUgc2V0IHRvIHRoZSBzYW1lIHZhbHVlCgkJb3B0cy5vdmVyZmxvdyA9IFsgc3R5bGUub3ZlcmZsb3csIHN0eWxlLm92ZXJmbG93WCwgc3R5bGUub3ZlcmZsb3dZIF07CgoJCS8vIFNldCBkaXNwbGF5IHByb3BlcnR5IHRvIGlubGluZS1ibG9jayBmb3IgaGVpZ2h0L3dpZHRoCgkJLy8gYW5pbWF0aW9ucyBvbiBpbmxpbmUgZWxlbWVudHMgdGhhdCBhcmUgaGF2aW5nIHdpZHRoL2hlaWdodCBhbmltYXRlZAoJCWRpc3BsYXkgPSBqUXVlcnkuY3NzKCBlbGVtLCAiZGlzcGxheSIgKTsKCQlkRGlzcGxheSA9IGRlZmF1bHREaXNwbGF5KCBlbGVtLm5vZGVOYW1lICk7CgkJaWYgKCBkaXNwbGF5ID09PSAibm9uZSIgKSB7CgkJCWRpc3BsYXkgPSBkRGlzcGxheTsKCQl9CgkJaWYgKCBkaXNwbGF5ID09PSAiaW5saW5lIiAmJgoJCQkJalF1ZXJ5LmNzcyggZWxlbSwgImZsb2F0IiApID09PSAibm9uZSIgKSB7CgoJCQkvLyBpbmxpbmUtbGV2ZWwgZWxlbWVudHMgYWNjZXB0IGlubGluZS1ibG9jazsKCQkJLy8gYmxvY2stbGV2ZWwgZWxlbWVudHMgbmVlZCB0byBiZSBpbmxpbmUgd2l0aCBsYXlvdXQKCQkJaWYgKCAhc3VwcG9ydC5pbmxpbmVCbG9ja05lZWRzTGF5b3V0IHx8IGREaXNwbGF5ID09PSAiaW5saW5lIiApIHsKCQkJCXN0eWxlLmRpc3BsYXkgPSAiaW5saW5lLWJsb2NrIjsKCQkJfSBlbHNlIHsKCQkJCXN0eWxlLnpvb20gPSAxOwoJCQl9CgkJfQoJfQoKCWlmICggb3B0cy5vdmVyZmxvdyApIHsKCQlzdHlsZS5vdmVyZmxvdyA9ICJoaWRkZW4iOwoJCWlmICggIXN1cHBvcnQuc2hyaW5rV3JhcEJsb2NrcygpICkgewoJCQlhbmltLmFsd2F5cyhmdW5jdGlvbigpIHsKCQkJCXN0eWxlLm92ZXJmbG93ID0gb3B0cy5vdmVyZmxvd1sgMCBdOwoJCQkJc3R5bGUub3ZlcmZsb3dYID0gb3B0cy5vdmVyZmxvd1sgMSBdOwoJCQkJc3R5bGUub3ZlcmZsb3dZID0gb3B0cy5vdmVyZmxvd1sgMiBdOwoJCQl9KTsKCQl9Cgl9CgoJLy8gc2hvdy9oaWRlIHBhc3MKCWZvciAoIHByb3AgaW4gcHJvcHMgKSB7CgkJdmFsdWUgPSBwcm9wc1sgcHJvcCBdOwoJCWlmICggcmZ4dHlwZXMuZXhlYyggdmFsdWUgKSApIHsKCQkJZGVsZXRlIHByb3BzWyBwcm9wIF07CgkJCXRvZ2dsZSA9IHRvZ2dsZSB8fCB2YWx1ZSA9PT0gInRvZ2dsZSI7CgkJCWlmICggdmFsdWUgPT09ICggaGlkZGVuID8gImhpZGUiIDogInNob3ciICkgKSB7CgoJCQkJLy8gSWYgdGhlcmUgaXMgZGF0YVNob3cgbGVmdCBvdmVyIGZyb20gYSBzdG9wcGVkIGhpZGUgb3Igc2hvdyBhbmQgd2UgYXJlIGdvaW5nIHRvIHByb2NlZWQgd2l0aCBzaG93LCB3ZSBzaG91bGQgcHJldGVuZCB0byBiZSBoaWRkZW4KCQkJCWlmICggdmFsdWUgPT09ICJzaG93IiAmJiBkYXRhU2hvdyAmJiBkYXRhU2hvd1sgcHJvcCBdICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJaGlkZGVuID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJY29udGludWU7CgkJCQl9CgkJCX0KCQkJb3JpZ1sgcHJvcCBdID0gZGF0YVNob3cgJiYgZGF0YVNob3dbIHByb3AgXSB8fCBqUXVlcnkuc3R5bGUoIGVsZW0sIHByb3AgKTsKCQl9Cgl9CgoJaWYgKCAhalF1ZXJ5LmlzRW1wdHlPYmplY3QoIG9yaWcgKSApIHsKCQlpZiAoIGRhdGFTaG93ICkgewoJCQlpZiAoICJoaWRkZW4iIGluIGRhdGFTaG93ICkgewoJCQkJaGlkZGVuID0gZGF0YVNob3cuaGlkZGVuOwoJCQl9CgkJfSBlbHNlIHsKCQkJZGF0YVNob3cgPSBqUXVlcnkuX2RhdGEoIGVsZW0sICJmeHNob3ciLCB7fSApOwoJCX0KCgkJLy8gc3RvcmUgc3RhdGUgaWYgaXRzIHRvZ2dsZSAtIGVuYWJsZXMgLnN0b3AoKS50b2dnbGUoKSB0byAicmV2ZXJzZSIKCQlpZiAoIHRvZ2dsZSApIHsKCQkJZGF0YVNob3cuaGlkZGVuID0gIWhpZGRlbjsKCQl9CgkJaWYgKCBoaWRkZW4gKSB7CgkJCWpRdWVyeSggZWxlbSApLnNob3coKTsKCQl9IGVsc2UgewoJCQlhbmltLmRvbmUoZnVuY3Rpb24oKSB7CgkJCQlqUXVlcnkoIGVsZW0gKS5oaWRlKCk7CgkJCX0pOwoJCX0KCQlhbmltLmRvbmUoZnVuY3Rpb24oKSB7CgkJCXZhciBwcm9wOwoJCQlqUXVlcnkuX3JlbW92ZURhdGEoIGVsZW0sICJmeHNob3ciICk7CgkJCWZvciAoIHByb3AgaW4gb3JpZyApIHsKCQkJCWpRdWVyeS5zdHlsZSggZWxlbSwgcHJvcCwgb3JpZ1sgcHJvcCBdICk7CgkJCX0KCQl9KTsKCQlmb3IgKCBwcm9wIGluIG9yaWcgKSB7CgkJCXR3ZWVuID0gY3JlYXRlVHdlZW4oIGhpZGRlbiA/IGRhdGFTaG93WyBwcm9wIF0gOiAwLCBwcm9wLCBhbmltICk7CgoJCQlpZiAoICEoIHByb3AgaW4gZGF0YVNob3cgKSApIHsKCQkJCWRhdGFTaG93WyBwcm9wIF0gPSB0d2Vlbi5zdGFydDsKCQkJCWlmICggaGlkZGVuICkgewoJCQkJCXR3ZWVuLmVuZCA9IHR3ZWVuLnN0YXJ0OwoJCQkJCXR3ZWVuLnN0YXJ0ID0gcHJvcCA9PT0gIndpZHRoIiB8fCBwcm9wID09PSAiaGVpZ2h0IiA/IDEgOiAwOwoJCQkJfQoJCQl9CgkJfQoJfQp9CgpmdW5jdGlvbiBwcm9wRmlsdGVyKCBwcm9wcywgc3BlY2lhbEVhc2luZyApIHsKCXZhciBpbmRleCwgbmFtZSwgZWFzaW5nLCB2YWx1ZSwgaG9va3M7CgoJLy8gY2FtZWxDYXNlLCBzcGVjaWFsRWFzaW5nIGFuZCBleHBhbmQgY3NzSG9vayBwYXNzCglmb3IgKCBpbmRleCBpbiBwcm9wcyApIHsKCQluYW1lID0galF1ZXJ5LmNhbWVsQ2FzZSggaW5kZXggKTsKCQllYXNpbmcgPSBzcGVjaWFsRWFzaW5nWyBuYW1lIF07CgkJdmFsdWUgPSBwcm9wc1sgaW5kZXggXTsKCQlpZiAoIGpRdWVyeS5pc0FycmF5KCB2YWx1ZSApICkgewoJCQllYXNpbmcgPSB2YWx1ZVsgMSBdOwoJCQl2YWx1ZSA9IHByb3BzWyBpbmRleCBdID0gdmFsdWVbIDAgXTsKCQl9CgoJCWlmICggaW5kZXggIT09IG5hbWUgKSB7CgkJCXByb3BzWyBuYW1lIF0gPSB2YWx1ZTsKCQkJZGVsZXRlIHByb3BzWyBpbmRleCBdOwoJCX0KCgkJaG9va3MgPSBqUXVlcnkuY3NzSG9va3NbIG5hbWUgXTsKCQlpZiAoIGhvb2tzICYmICJleHBhbmQiIGluIGhvb2tzICkgewoJCQl2YWx1ZSA9IGhvb2tzLmV4cGFuZCggdmFsdWUgKTsKCQkJZGVsZXRlIHByb3BzWyBuYW1lIF07CgoJCQkvLyBub3QgcXVpdGUgJC5leHRlbmQsIHRoaXMgd29udCBvdmVyd3JpdGUga2V5cyBhbHJlYWR5IHByZXNlbnQuCgkJCS8vIGFsc28gLSByZXVzaW5nICdpbmRleCcgZnJvbSBhYm92ZSBiZWNhdXNlIHdlIGhhdmUgdGhlIGNvcnJlY3QgIm5hbWUiCgkJCWZvciAoIGluZGV4IGluIHZhbHVlICkgewoJCQkJaWYgKCAhKCBpbmRleCBpbiBwcm9wcyApICkgewoJCQkJCXByb3BzWyBpbmRleCBdID0gdmFsdWVbIGluZGV4IF07CgkJCQkJc3BlY2lhbEVhc2luZ1sgaW5kZXggXSA9IGVhc2luZzsKCQkJCX0KCQkJfQoJCX0gZWxzZSB7CgkJCXNwZWNpYWxFYXNpbmdbIG5hbWUgXSA9IGVhc2luZzsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIEFuaW1hdGlvbiggZWxlbSwgcHJvcGVydGllcywgb3B0aW9ucyApIHsKCXZhciByZXN1bHQsCgkJc3RvcHBlZCwKCQlpbmRleCA9IDAsCgkJbGVuZ3RoID0gYW5pbWF0aW9uUHJlZmlsdGVycy5sZW5ndGgsCgkJZGVmZXJyZWQgPSBqUXVlcnkuRGVmZXJyZWQoKS5hbHdheXMoIGZ1bmN0aW9uKCkgewoJCQkvLyBkb24ndCBtYXRjaCBlbGVtIGluIHRoZSA6YW5pbWF0ZWQgc2VsZWN0b3IKCQkJZGVsZXRlIHRpY2suZWxlbTsKCQl9KSwKCQl0aWNrID0gZnVuY3Rpb24oKSB7CgkJCWlmICggc3RvcHBlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCQl2YXIgY3VycmVudFRpbWUgPSBmeE5vdyB8fCBjcmVhdGVGeE5vdygpLAoJCQkJcmVtYWluaW5nID0gTWF0aC5tYXgoIDAsIGFuaW1hdGlvbi5zdGFydFRpbWUgKyBhbmltYXRpb24uZHVyYXRpb24gLSBjdXJyZW50VGltZSApLAoJCQkJLy8gYXJjaGFpYyBjcmFzaCBidWcgd29uJ3QgYWxsb3cgdXMgdG8gdXNlIDEgLSAoIDAuNSB8fCAwICkgKCMxMjQ5NykKCQkJCXRlbXAgPSByZW1haW5pbmcgLyBhbmltYXRpb24uZHVyYXRpb24gfHwgMCwKCQkJCXBlcmNlbnQgPSAxIC0gdGVtcCwKCQkJCWluZGV4ID0gMCwKCQkJCWxlbmd0aCA9IGFuaW1hdGlvbi50d2VlbnMubGVuZ3RoOwoKCQkJZm9yICggOyBpbmRleCA8IGxlbmd0aCA7IGluZGV4KysgKSB7CgkJCQlhbmltYXRpb24udHdlZW5zWyBpbmRleCBdLnJ1biggcGVyY2VudCApOwoJCQl9CgoJCQlkZWZlcnJlZC5ub3RpZnlXaXRoKCBlbGVtLCBbIGFuaW1hdGlvbiwgcGVyY2VudCwgcmVtYWluaW5nIF0pOwoKCQkJaWYgKCBwZXJjZW50IDwgMSAmJiBsZW5ndGggKSB7CgkJCQlyZXR1cm4gcmVtYWluaW5nOwoJCQl9IGVsc2UgewoJCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uIF0gKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgkJYW5pbWF0aW9uID0gZGVmZXJyZWQucHJvbWlzZSh7CgkJCWVsZW06IGVsZW0sCgkJCXByb3BzOiBqUXVlcnkuZXh0ZW5kKCB7fSwgcHJvcGVydGllcyApLAoJCQlvcHRzOiBqUXVlcnkuZXh0ZW5kKCB0cnVlLCB7IHNwZWNpYWxFYXNpbmc6IHt9IH0sIG9wdGlvbnMgKSwKCQkJb3JpZ2luYWxQcm9wZXJ0aWVzOiBwcm9wZXJ0aWVzLAoJCQlvcmlnaW5hbE9wdGlvbnM6IG9wdGlvbnMsCgkJCXN0YXJ0VGltZTogZnhOb3cgfHwgY3JlYXRlRnhOb3coKSwKCQkJZHVyYXRpb246IG9wdGlvbnMuZHVyYXRpb24sCgkJCXR3ZWVuczogW10sCgkJCWNyZWF0ZVR3ZWVuOiBmdW5jdGlvbiggcHJvcCwgZW5kICkgewoJCQkJdmFyIHR3ZWVuID0galF1ZXJ5LlR3ZWVuKCBlbGVtLCBhbmltYXRpb24ub3B0cywgcHJvcCwgZW5kLAoJCQkJCQlhbmltYXRpb24ub3B0cy5zcGVjaWFsRWFzaW5nWyBwcm9wIF0gfHwgYW5pbWF0aW9uLm9wdHMuZWFzaW5nICk7CgkJCQlhbmltYXRpb24udHdlZW5zLnB1c2goIHR3ZWVuICk7CgkJCQlyZXR1cm4gdHdlZW47CgkJCX0sCgkJCXN0b3A6IGZ1bmN0aW9uKCBnb3RvRW5kICkgewoJCQkJdmFyIGluZGV4ID0gMCwKCQkJCQkvLyBpZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGVuZCwgd2Ugd2FudCB0byBydW4gYWxsIHRoZSB0d2VlbnMKCQkJCQkvLyBvdGhlcndpc2Ugd2Ugc2tpcCB0aGlzIHBhcnQKCQkJCQlsZW5ndGggPSBnb3RvRW5kID8gYW5pbWF0aW9uLnR3ZWVucy5sZW5ndGggOiAwOwoJCQkJaWYgKCBzdG9wcGVkICkgewoJCQkJCXJldHVybiB0aGlzOwoJCQkJfQoJCQkJc3RvcHBlZCA9IHRydWU7CgkJCQlmb3IgKCA7IGluZGV4IDwgbGVuZ3RoIDsgaW5kZXgrKyApIHsKCQkJCQlhbmltYXRpb24udHdlZW5zWyBpbmRleCBdLnJ1biggMSApOwoJCQkJfQoKCQkJCS8vIHJlc29sdmUgd2hlbiB3ZSBwbGF5ZWQgdGhlIGxhc3QgZnJhbWUKCQkJCS8vIG90aGVyd2lzZSwgcmVqZWN0CgkJCQlpZiAoIGdvdG9FbmQgKSB7CgkJCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uLCBnb3RvRW5kIF0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJZGVmZXJyZWQucmVqZWN0V2l0aCggZWxlbSwgWyBhbmltYXRpb24sIGdvdG9FbmQgXSApOwoJCQkJfQoJCQkJcmV0dXJuIHRoaXM7CgkJCX0KCQl9KSwKCQlwcm9wcyA9IGFuaW1hdGlvbi5wcm9wczsKCglwcm9wRmlsdGVyKCBwcm9wcywgYW5pbWF0aW9uLm9wdHMuc3BlY2lhbEVhc2luZyApOwoKCWZvciAoIDsgaW5kZXggPCBsZW5ndGggOyBpbmRleCsrICkgewoJCXJlc3VsdCA9IGFuaW1hdGlvblByZWZpbHRlcnNbIGluZGV4IF0uY2FsbCggYW5pbWF0aW9uLCBlbGVtLCBwcm9wcywgYW5pbWF0aW9uLm9wdHMgKTsKCQlpZiAoIHJlc3VsdCApIHsKCQkJcmV0dXJuIHJlc3VsdDsKCQl9Cgl9CgoJalF1ZXJ5Lm1hcCggcHJvcHMsIGNyZWF0ZVR3ZWVuLCBhbmltYXRpb24gKTsKCglpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBhbmltYXRpb24ub3B0cy5zdGFydCApICkgewoJCWFuaW1hdGlvbi5vcHRzLnN0YXJ0LmNhbGwoIGVsZW0sIGFuaW1hdGlvbiApOwoJfQoKCWpRdWVyeS5meC50aW1lcigKCQlqUXVlcnkuZXh0ZW5kKCB0aWNrLCB7CgkJCWVsZW06IGVsZW0sCgkJCWFuaW06IGFuaW1hdGlvbiwKCQkJcXVldWU6IGFuaW1hdGlvbi5vcHRzLnF1ZXVlCgkJfSkKCSk7CgoJLy8gYXR0YWNoIGNhbGxiYWNrcyBmcm9tIG9wdGlvbnMKCXJldHVybiBhbmltYXRpb24ucHJvZ3Jlc3MoIGFuaW1hdGlvbi5vcHRzLnByb2dyZXNzICkKCQkuZG9uZSggYW5pbWF0aW9uLm9wdHMuZG9uZSwgYW5pbWF0aW9uLm9wdHMuY29tcGxldGUgKQoJCS5mYWlsKCBhbmltYXRpb24ub3B0cy5mYWlsICkKCQkuYWx3YXlzKCBhbmltYXRpb24ub3B0cy5hbHdheXMgKTsKfQoKalF1ZXJ5LkFuaW1hdGlvbiA9IGpRdWVyeS5leHRlbmQoIEFuaW1hdGlvbiwgewoJdHdlZW5lcjogZnVuY3Rpb24oIHByb3BzLCBjYWxsYmFjayApIHsKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBwcm9wcyApICkgewoJCQljYWxsYmFjayA9IHByb3BzOwoJCQlwcm9wcyA9IFsgIioiIF07CgkJfSBlbHNlIHsKCQkJcHJvcHMgPSBwcm9wcy5zcGxpdCgiICIpOwoJCX0KCgkJdmFyIHByb3AsCgkJCWluZGV4ID0gMCwKCQkJbGVuZ3RoID0gcHJvcHMubGVuZ3RoOwoKCQlmb3IgKCA7IGluZGV4IDwgbGVuZ3RoIDsgaW5kZXgrKyApIHsKCQkJcHJvcCA9IHByb3BzWyBpbmRleCBdOwoJCQl0d2VlbmVyc1sgcHJvcCBdID0gdHdlZW5lcnNbIHByb3AgXSB8fCBbXTsKCQkJdHdlZW5lcnNbIHByb3AgXS51bnNoaWZ0KCBjYWxsYmFjayApOwoJCX0KCX0sCgoJcHJlZmlsdGVyOiBmdW5jdGlvbiggY2FsbGJhY2ssIHByZXBlbmQgKSB7CgkJaWYgKCBwcmVwZW5kICkgewoJCQlhbmltYXRpb25QcmVmaWx0ZXJzLnVuc2hpZnQoIGNhbGxiYWNrICk7CgkJfSBlbHNlIHsKCQkJYW5pbWF0aW9uUHJlZmlsdGVycy5wdXNoKCBjYWxsYmFjayApOwoJCX0KCX0KfSk7CgpqUXVlcnkuc3BlZWQgPSBmdW5jdGlvbiggc3BlZWQsIGVhc2luZywgZm4gKSB7Cgl2YXIgb3B0ID0gc3BlZWQgJiYgdHlwZW9mIHNwZWVkID09PSAib2JqZWN0IiA/IGpRdWVyeS5leHRlbmQoIHt9LCBzcGVlZCApIDogewoJCWNvbXBsZXRlOiBmbiB8fCAhZm4gJiYgZWFzaW5nIHx8CgkJCWpRdWVyeS5pc0Z1bmN0aW9uKCBzcGVlZCApICYmIHNwZWVkLAoJCWR1cmF0aW9uOiBzcGVlZCwKCQllYXNpbmc6IGZuICYmIGVhc2luZyB8fCBlYXNpbmcgJiYgIWpRdWVyeS5pc0Z1bmN0aW9uKCBlYXNpbmcgKSAmJiBlYXNpbmcKCX07CgoJb3B0LmR1cmF0aW9uID0galF1ZXJ5LmZ4Lm9mZiA/IDAgOiB0eXBlb2Ygb3B0LmR1cmF0aW9uID09PSAibnVtYmVyIiA/IG9wdC5kdXJhdGlvbiA6CgkJb3B0LmR1cmF0aW9uIGluIGpRdWVyeS5meC5zcGVlZHMgPyBqUXVlcnkuZnguc3BlZWRzWyBvcHQuZHVyYXRpb24gXSA6IGpRdWVyeS5meC5zcGVlZHMuX2RlZmF1bHQ7CgoJLy8gbm9ybWFsaXplIG9wdC5xdWV1ZSAtIHRydWUvdW5kZWZpbmVkL251bGwgLT4gImZ4IgoJaWYgKCBvcHQucXVldWUgPT0gbnVsbCB8fCBvcHQucXVldWUgPT09IHRydWUgKSB7CgkJb3B0LnF1ZXVlID0gImZ4IjsKCX0KCgkvLyBRdWV1ZWluZwoJb3B0Lm9sZCA9IG9wdC5jb21wbGV0ZTsKCglvcHQuY29tcGxldGUgPSBmdW5jdGlvbigpIHsKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBvcHQub2xkICkgKSB7CgkJCW9wdC5vbGQuY2FsbCggdGhpcyApOwoJCX0KCgkJaWYgKCBvcHQucXVldWUgKSB7CgkJCWpRdWVyeS5kZXF1ZXVlKCB0aGlzLCBvcHQucXVldWUgKTsKCQl9Cgl9OwoKCXJldHVybiBvcHQ7Cn07CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCWZhZGVUbzogZnVuY3Rpb24oIHNwZWVkLCB0bywgZWFzaW5nLCBjYWxsYmFjayApIHsKCgkJLy8gc2hvdyBhbnkgaGlkZGVuIGVsZW1lbnRzIGFmdGVyIHNldHRpbmcgb3BhY2l0eSB0byAwCgkJcmV0dXJuIHRoaXMuZmlsdGVyKCBpc0hpZGRlbiApLmNzcyggIm9wYWNpdHkiLCAwICkuc2hvdygpCgoJCQkvLyBhbmltYXRlIHRvIHRoZSB2YWx1ZSBzcGVjaWZpZWQKCQkJLmVuZCgpLmFuaW1hdGUoeyBvcGFjaXR5OiB0byB9LCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApOwoJfSwKCWFuaW1hdGU6IGZ1bmN0aW9uKCBwcm9wLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsKCQl2YXIgZW1wdHkgPSBqUXVlcnkuaXNFbXB0eU9iamVjdCggcHJvcCApLAoJCQlvcHRhbGwgPSBqUXVlcnkuc3BlZWQoIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICksCgkJCWRvQW5pbWF0aW9uID0gZnVuY3Rpb24oKSB7CgkJCQkvLyBPcGVyYXRlIG9uIGEgY29weSBvZiBwcm9wIHNvIHBlci1wcm9wZXJ0eSBlYXNpbmcgd29uJ3QgYmUgbG9zdAoJCQkJdmFyIGFuaW0gPSBBbmltYXRpb24oIHRoaXMsIGpRdWVyeS5leHRlbmQoIHt9LCBwcm9wICksIG9wdGFsbCApOwoKCQkJCS8vIEVtcHR5IGFuaW1hdGlvbnMsIG9yIGZpbmlzaGluZyByZXNvbHZlcyBpbW1lZGlhdGVseQoJCQkJaWYgKCBlbXB0eSB8fCBqUXVlcnkuX2RhdGEoIHRoaXMsICJmaW5pc2giICkgKSB7CgkJCQkJYW5pbS5zdG9wKCB0cnVlICk7CgkJCQl9CgkJCX07CgkJCWRvQW5pbWF0aW9uLmZpbmlzaCA9IGRvQW5pbWF0aW9uOwoKCQlyZXR1cm4gZW1wdHkgfHwgb3B0YWxsLnF1ZXVlID09PSBmYWxzZSA/CgkJCXRoaXMuZWFjaCggZG9BbmltYXRpb24gKSA6CgkJCXRoaXMucXVldWUoIG9wdGFsbC5xdWV1ZSwgZG9BbmltYXRpb24gKTsKCX0sCglzdG9wOiBmdW5jdGlvbiggdHlwZSwgY2xlYXJRdWV1ZSwgZ290b0VuZCApIHsKCQl2YXIgc3RvcFF1ZXVlID0gZnVuY3Rpb24oIGhvb2tzICkgewoJCQl2YXIgc3RvcCA9IGhvb2tzLnN0b3A7CgkJCWRlbGV0ZSBob29rcy5zdG9wOwoJCQlzdG9wKCBnb3RvRW5kICk7CgkJfTsKCgkJaWYgKCB0eXBlb2YgdHlwZSAhPT0gInN0cmluZyIgKSB7CgkJCWdvdG9FbmQgPSBjbGVhclF1ZXVlOwoJCQljbGVhclF1ZXVlID0gdHlwZTsKCQkJdHlwZSA9IHVuZGVmaW5lZDsKCQl9CgkJaWYgKCBjbGVhclF1ZXVlICYmIHR5cGUgIT09IGZhbHNlICkgewoJCQl0aGlzLnF1ZXVlKCB0eXBlIHx8ICJmeCIsIFtdICk7CgkJfQoKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgZGVxdWV1ZSA9IHRydWUsCgkJCQlpbmRleCA9IHR5cGUgIT0gbnVsbCAmJiB0eXBlICsgInF1ZXVlSG9va3MiLAoJCQkJdGltZXJzID0galF1ZXJ5LnRpbWVycywKCQkJCWRhdGEgPSBqUXVlcnkuX2RhdGEoIHRoaXMgKTsKCgkJCWlmICggaW5kZXggKSB7CgkJCQlpZiAoIGRhdGFbIGluZGV4IF0gJiYgZGF0YVsgaW5kZXggXS5zdG9wICkgewoJCQkJCXN0b3BRdWV1ZSggZGF0YVsgaW5kZXggXSApOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJZm9yICggaW5kZXggaW4gZGF0YSApIHsKCQkJCQlpZiAoIGRhdGFbIGluZGV4IF0gJiYgZGF0YVsgaW5kZXggXS5zdG9wICYmIHJydW4udGVzdCggaW5kZXggKSApIHsKCQkJCQkJc3RvcFF1ZXVlKCBkYXRhWyBpbmRleCBdICk7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlmb3IgKCBpbmRleCA9IHRpbWVycy5sZW5ndGg7IGluZGV4LS07ICkgewoJCQkJaWYgKCB0aW1lcnNbIGluZGV4IF0uZWxlbSA9PT0gdGhpcyAmJiAodHlwZSA9PSBudWxsIHx8IHRpbWVyc1sgaW5kZXggXS5xdWV1ZSA9PT0gdHlwZSkgKSB7CgkJCQkJdGltZXJzWyBpbmRleCBdLmFuaW0uc3RvcCggZ290b0VuZCApOwoJCQkJCWRlcXVldWUgPSBmYWxzZTsKCQkJCQl0aW1lcnMuc3BsaWNlKCBpbmRleCwgMSApOwoJCQkJfQoJCQl9CgoJCQkvLyBzdGFydCB0aGUgbmV4dCBpbiB0aGUgcXVldWUgaWYgdGhlIGxhc3Qgc3RlcCB3YXNuJ3QgZm9yY2VkCgkJCS8vIHRpbWVycyBjdXJyZW50bHkgd2lsbCBjYWxsIHRoZWlyIGNvbXBsZXRlIGNhbGxiYWNrcywgd2hpY2ggd2lsbCBkZXF1ZXVlCgkJCS8vIGJ1dCBvbmx5IGlmIHRoZXkgd2VyZSBnb3RvRW5kCgkJCWlmICggZGVxdWV1ZSB8fCAhZ290b0VuZCApIHsKCQkJCWpRdWVyeS5kZXF1ZXVlKCB0aGlzLCB0eXBlICk7CgkJCX0KCQl9KTsKCX0sCglmaW5pc2g6IGZ1bmN0aW9uKCB0eXBlICkgewoJCWlmICggdHlwZSAhPT0gZmFsc2UgKSB7CgkJCXR5cGUgPSB0eXBlIHx8ICJmeCI7CgkJfQoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBpbmRleCwKCQkJCWRhdGEgPSBqUXVlcnkuX2RhdGEoIHRoaXMgKSwKCQkJCXF1ZXVlID0gZGF0YVsgdHlwZSArICJxdWV1ZSIgXSwKCQkJCWhvb2tzID0gZGF0YVsgdHlwZSArICJxdWV1ZUhvb2tzIiBdLAoJCQkJdGltZXJzID0galF1ZXJ5LnRpbWVycywKCQkJCWxlbmd0aCA9IHF1ZXVlID8gcXVldWUubGVuZ3RoIDogMDsKCgkJCS8vIGVuYWJsZSBmaW5pc2hpbmcgZmxhZyBvbiBwcml2YXRlIGRhdGEKCQkJZGF0YS5maW5pc2ggPSB0cnVlOwoKCQkJLy8gZW1wdHkgdGhlIHF1ZXVlIGZpcnN0CgkJCWpRdWVyeS5xdWV1ZSggdGhpcywgdHlwZSwgW10gKTsKCgkJCWlmICggaG9va3MgJiYgaG9va3Muc3RvcCApIHsKCQkJCWhvb2tzLnN0b3AuY2FsbCggdGhpcywgdHJ1ZSApOwoJCQl9CgoJCQkvLyBsb29rIGZvciBhbnkgYWN0aXZlIGFuaW1hdGlvbnMsIGFuZCBmaW5pc2ggdGhlbQoJCQlmb3IgKCBpbmRleCA9IHRpbWVycy5sZW5ndGg7IGluZGV4LS07ICkgewoJCQkJaWYgKCB0aW1lcnNbIGluZGV4IF0uZWxlbSA9PT0gdGhpcyAmJiB0aW1lcnNbIGluZGV4IF0ucXVldWUgPT09IHR5cGUgKSB7CgkJCQkJdGltZXJzWyBpbmRleCBdLmFuaW0uc3RvcCggdHJ1ZSApOwoJCQkJCXRpbWVycy5zcGxpY2UoIGluZGV4LCAxICk7CgkJCQl9CgkJCX0KCgkJCS8vIGxvb2sgZm9yIGFueSBhbmltYXRpb25zIGluIHRoZSBvbGQgcXVldWUgYW5kIGZpbmlzaCB0aGVtCgkJCWZvciAoIGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7CgkJCQlpZiAoIHF1ZXVlWyBpbmRleCBdICYmIHF1ZXVlWyBpbmRleCBdLmZpbmlzaCApIHsKCQkJCQlxdWV1ZVsgaW5kZXggXS5maW5pc2guY2FsbCggdGhpcyApOwoJCQkJfQoJCQl9CgoJCQkvLyB0dXJuIG9mZiBmaW5pc2hpbmcgZmxhZwoJCQlkZWxldGUgZGF0YS5maW5pc2g7CgkJfSk7Cgl9Cn0pOwoKalF1ZXJ5LmVhY2goWyAidG9nZ2xlIiwgInNob3ciLCAiaGlkZSIgXSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7Cgl2YXIgY3NzRm4gPSBqUXVlcnkuZm5bIG5hbWUgXTsKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICkgewoJCXJldHVybiBzcGVlZCA9PSBudWxsIHx8IHR5cGVvZiBzcGVlZCA9PT0gImJvb2xlYW4iID8KCQkJY3NzRm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApIDoKCQkJdGhpcy5hbmltYXRlKCBnZW5GeCggbmFtZSwgdHJ1ZSApLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApOwoJfTsKfSk7CgovLyBHZW5lcmF0ZSBzaG9ydGN1dHMgZm9yIGN1c3RvbSBhbmltYXRpb25zCmpRdWVyeS5lYWNoKHsKCXNsaWRlRG93bjogZ2VuRngoInNob3ciKSwKCXNsaWRlVXA6IGdlbkZ4KCJoaWRlIiksCglzbGlkZVRvZ2dsZTogZ2VuRngoInRvZ2dsZSIpLAoJZmFkZUluOiB7IG9wYWNpdHk6ICJzaG93IiB9LAoJZmFkZU91dDogeyBvcGFjaXR5OiAiaGlkZSIgfSwKCWZhZGVUb2dnbGU6IHsgb3BhY2l0eTogInRvZ2dsZSIgfQp9LCBmdW5jdGlvbiggbmFtZSwgcHJvcHMgKSB7CglqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsKCQlyZXR1cm4gdGhpcy5hbmltYXRlKCBwcm9wcywgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKCX07Cn0pOwoKalF1ZXJ5LnRpbWVycyA9IFtdOwpqUXVlcnkuZngudGljayA9IGZ1bmN0aW9uKCkgewoJdmFyIHRpbWVyLAoJCXRpbWVycyA9IGpRdWVyeS50aW1lcnMsCgkJaSA9IDA7CgoJZnhOb3cgPSBqUXVlcnkubm93KCk7CgoJZm9yICggOyBpIDwgdGltZXJzLmxlbmd0aDsgaSsrICkgewoJCXRpbWVyID0gdGltZXJzWyBpIF07CgkJLy8gQ2hlY2tzIHRoZSB0aW1lciBoYXMgbm90IGFscmVhZHkgYmVlbiByZW1vdmVkCgkJaWYgKCAhdGltZXIoKSAmJiB0aW1lcnNbIGkgXSA9PT0gdGltZXIgKSB7CgkJCXRpbWVycy5zcGxpY2UoIGktLSwgMSApOwoJCX0KCX0KCglpZiAoICF0aW1lcnMubGVuZ3RoICkgewoJCWpRdWVyeS5meC5zdG9wKCk7Cgl9CglmeE5vdyA9IHVuZGVmaW5lZDsKfTsKCmpRdWVyeS5meC50aW1lciA9IGZ1bmN0aW9uKCB0aW1lciApIHsKCWpRdWVyeS50aW1lcnMucHVzaCggdGltZXIgKTsKCWlmICggdGltZXIoKSApIHsKCQlqUXVlcnkuZnguc3RhcnQoKTsKCX0gZWxzZSB7CgkJalF1ZXJ5LnRpbWVycy5wb3AoKTsKCX0KfTsKCmpRdWVyeS5meC5pbnRlcnZhbCA9IDEzOwoKalF1ZXJ5LmZ4LnN0YXJ0ID0gZnVuY3Rpb24oKSB7CglpZiAoICF0aW1lcklkICkgewoJCXRpbWVySWQgPSBzZXRJbnRlcnZhbCggalF1ZXJ5LmZ4LnRpY2ssIGpRdWVyeS5meC5pbnRlcnZhbCApOwoJfQp9OwoKalF1ZXJ5LmZ4LnN0b3AgPSBmdW5jdGlvbigpIHsKCWNsZWFySW50ZXJ2YWwoIHRpbWVySWQgKTsKCXRpbWVySWQgPSBudWxsOwp9OwoKalF1ZXJ5LmZ4LnNwZWVkcyA9IHsKCXNsb3c6IDYwMCwKCWZhc3Q6IDIwMCwKCS8vIERlZmF1bHQgc3BlZWQKCV9kZWZhdWx0OiA0MDAKfTsKCgovLyBCYXNlZCBvZmYgb2YgdGhlIHBsdWdpbiBieSBDbGludCBIZWxmZXJzLCB3aXRoIHBlcm1pc3Npb24uCi8vIGh0dHA6Ly9ibGluZHNpZ25hbHMuY29tL2luZGV4LnBocC8yMDA5LzA3L2pxdWVyeS1kZWxheS8KalF1ZXJ5LmZuLmRlbGF5ID0gZnVuY3Rpb24oIHRpbWUsIHR5cGUgKSB7Cgl0aW1lID0galF1ZXJ5LmZ4ID8galF1ZXJ5LmZ4LnNwZWVkc1sgdGltZSBdIHx8IHRpbWUgOiB0aW1lOwoJdHlwZSA9IHR5cGUgfHwgImZ4IjsKCglyZXR1cm4gdGhpcy5xdWV1ZSggdHlwZSwgZnVuY3Rpb24oIG5leHQsIGhvb2tzICkgewoJCXZhciB0aW1lb3V0ID0gc2V0VGltZW91dCggbmV4dCwgdGltZSApOwoJCWhvb2tzLnN0b3AgPSBmdW5jdGlvbigpIHsKCQkJY2xlYXJUaW1lb3V0KCB0aW1lb3V0ICk7CgkJfTsKCX0pOwp9OwoKCihmdW5jdGlvbigpIHsKCXZhciBhLCBpbnB1dCwgc2VsZWN0LCBvcHQsCgkJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IiApOwoKCS8vIFNldHVwCglkaXYuc2V0QXR0cmlidXRlKCAiY2xhc3NOYW1lIiwgInQiICk7CglkaXYuaW5uZXJIVE1MID0gIiAgPGxpbmsvPjx0YWJsZT48L3RhYmxlPjxhIGhyZWY9Jy9hJz5hPC9hPjxpbnB1dCB0eXBlPSdjaGVja2JveCcvPiI7CglhID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJhIilbIDAgXTsKCgkvLyBGaXJzdCBiYXRjaCBvZiB0ZXN0cy4KCXNlbGVjdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNlbGVjdCIpOwoJb3B0ID0gc2VsZWN0LmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvcHRpb24iKSApOwoJaW5wdXQgPSBkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImlucHV0IilbIDAgXTsKCglhLnN0eWxlLmNzc1RleHQgPSAidG9wOjFweCI7CgoJLy8gVGVzdCBzZXRBdHRyaWJ1dGUgb24gY2FtZWxDYXNlIGNsYXNzLiBJZiBpdCB3b3Jrcywgd2UgbmVlZCBhdHRyRml4ZXMgd2hlbiBkb2luZyBnZXQvc2V0QXR0cmlidXRlIChpZTYvNykKCXN1cHBvcnQuZ2V0U2V0QXR0cmlidXRlID0gZGl2LmNsYXNzTmFtZSAhPT0gInQiOwoKCS8vIEdldCB0aGUgc3R5bGUgaW5mb3JtYXRpb24gZnJvbSBnZXRBdHRyaWJ1dGUKCS8vIChJRSB1c2VzIC5jc3NUZXh0IGluc3RlYWQpCglzdXBwb3J0LnN0eWxlID0gL3RvcC8udGVzdCggYS5nZXRBdHRyaWJ1dGUoInN0eWxlIikgKTsKCgkvLyBNYWtlIHN1cmUgdGhhdCBVUkxzIGFyZW4ndCBtYW5pcHVsYXRlZAoJLy8gKElFIG5vcm1hbGl6ZXMgaXQgYnkgZGVmYXVsdCkKCXN1cHBvcnQuaHJlZk5vcm1hbGl6ZWQgPSBhLmdldEF0dHJpYnV0ZSgiaHJlZiIpID09PSAiL2EiOwoKCS8vIENoZWNrIHRoZSBkZWZhdWx0IGNoZWNrYm94L3JhZGlvIHZhbHVlICgiIiBvbiBXZWJLaXQ7ICJvbiIgZWxzZXdoZXJlKQoJc3VwcG9ydC5jaGVja09uID0gISFpbnB1dC52YWx1ZTsKCgkvLyBNYWtlIHN1cmUgdGhhdCBhIHNlbGVjdGVkLWJ5LWRlZmF1bHQgb3B0aW9uIGhhcyBhIHdvcmtpbmcgc2VsZWN0ZWQgcHJvcGVydHkuCgkvLyAoV2ViS2l0IGRlZmF1bHRzIHRvIGZhbHNlIGluc3RlYWQgb2YgdHJ1ZSwgSUUgdG9vLCBpZiBpdCdzIGluIGFuIG9wdGdyb3VwKQoJc3VwcG9ydC5vcHRTZWxlY3RlZCA9IG9wdC5zZWxlY3RlZDsKCgkvLyBUZXN0cyBmb3IgZW5jdHlwZSBzdXBwb3J0IG9uIGEgZm9ybSAoIzY3NDMpCglzdXBwb3J0LmVuY3R5cGUgPSAhIWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImZvcm0iKS5lbmN0eXBlOwoKCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBvcHRpb25zIGluc2lkZSBkaXNhYmxlZCBzZWxlY3RzIGFyZW4ndCBtYXJrZWQgYXMgZGlzYWJsZWQKCS8vIChXZWJLaXQgbWFya3MgdGhlbSBhcyBkaXNhYmxlZCkKCXNlbGVjdC5kaXNhYmxlZCA9IHRydWU7CglzdXBwb3J0Lm9wdERpc2FibGVkID0gIW9wdC5kaXNhYmxlZDsKCgkvLyBTdXBwb3J0OiBJRTggb25seQoJLy8gQ2hlY2sgaWYgd2UgY2FuIHRydXN0IGdldEF0dHJpYnV0ZSgidmFsdWUiKQoJaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiaW5wdXQiICk7CglpbnB1dC5zZXRBdHRyaWJ1dGUoICJ2YWx1ZSIsICIiICk7CglzdXBwb3J0LmlucHV0ID0gaW5wdXQuZ2V0QXR0cmlidXRlKCAidmFsdWUiICkgPT09ICIiOwoKCS8vIENoZWNrIGlmIGFuIGlucHV0IG1haW50YWlucyBpdHMgdmFsdWUgYWZ0ZXIgYmVjb21pbmcgYSByYWRpbwoJaW5wdXQudmFsdWUgPSAidCI7CglpbnB1dC5zZXRBdHRyaWJ1dGUoICJ0eXBlIiwgInJhZGlvIiApOwoJc3VwcG9ydC5yYWRpb1ZhbHVlID0gaW5wdXQudmFsdWUgPT09ICJ0IjsKCgkvLyBOdWxsIGVsZW1lbnRzIHRvIGF2b2lkIGxlYWtzIGluIElFLgoJYSA9IGlucHV0ID0gc2VsZWN0ID0gb3B0ID0gZGl2ID0gbnVsbDsKfSkoKTsKCgp2YXIgcnJldHVybiA9IC9cci9nOwoKalF1ZXJ5LmZuLmV4dGVuZCh7Cgl2YWw6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YXIgaG9va3MsIHJldCwgaXNGdW5jdGlvbiwKCQkJZWxlbSA9IHRoaXNbMF07CgoJCWlmICggIWFyZ3VtZW50cy5sZW5ndGggKSB7CgkJCWlmICggZWxlbSApIHsKCQkJCWhvb2tzID0galF1ZXJ5LnZhbEhvb2tzWyBlbGVtLnR5cGUgXSB8fCBqUXVlcnkudmFsSG9va3NbIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSBdOwoKCQkJCWlmICggaG9va3MgJiYgImdldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLmdldCggZWxlbSwgInZhbHVlIiApKSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVybiByZXQ7CgkJCQl9CgoJCQkJcmV0ID0gZWxlbS52YWx1ZTsKCgkJCQlyZXR1cm4gdHlwZW9mIHJldCA9PT0gInN0cmluZyIgPwoJCQkJCS8vIGhhbmRsZSBtb3N0IGNvbW1vbiBzdHJpbmcgY2FzZXMKCQkJCQlyZXQucmVwbGFjZShycmV0dXJuLCAiIikgOgoJCQkJCS8vIGhhbmRsZSBjYXNlcyB3aGVyZSB2YWx1ZSBpcyBudWxsL3VuZGVmIG9yIG51bWJlcgoJCQkJCXJldCA9PSBudWxsID8gIiIgOiByZXQ7CgkJCX0KCgkJCXJldHVybjsKCQl9CgoJCWlzRnVuY3Rpb24gPSBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKTsKCgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaSApIHsKCQkJdmFyIHZhbDsKCgkJCWlmICggdGhpcy5ub2RlVHlwZSAhPT0gMSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCBpc0Z1bmN0aW9uICkgewoJCQkJdmFsID0gdmFsdWUuY2FsbCggdGhpcywgaSwgalF1ZXJ5KCB0aGlzICkudmFsKCkgKTsKCQkJfSBlbHNlIHsKCQkJCXZhbCA9IHZhbHVlOwoJCQl9CgoJCQkvLyBUcmVhdCBudWxsL3VuZGVmaW5lZCBhcyAiIjsgY29udmVydCBudW1iZXJzIHRvIHN0cmluZwoJCQlpZiAoIHZhbCA9PSBudWxsICkgewoJCQkJdmFsID0gIiI7CgkJCX0gZWxzZSBpZiAoIHR5cGVvZiB2YWwgPT09ICJudW1iZXIiICkgewoJCQkJdmFsICs9ICIiOwoJCQl9IGVsc2UgaWYgKCBqUXVlcnkuaXNBcnJheSggdmFsICkgKSB7CgkJCQl2YWwgPSBqUXVlcnkubWFwKCB2YWwsIGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJCQlyZXR1cm4gdmFsdWUgPT0gbnVsbCA/ICIiIDogdmFsdWUgKyAiIjsKCQkJCX0pOwoJCQl9CgoJCQlob29rcyA9IGpRdWVyeS52YWxIb29rc1sgdGhpcy50eXBlIF0gfHwgalF1ZXJ5LnZhbEhvb2tzWyB0aGlzLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgXTsKCgkJCS8vIElmIHNldCByZXR1cm5zIHVuZGVmaW5lZCwgZmFsbCBiYWNrIHRvIG5vcm1hbCBzZXR0aW5nCgkJCWlmICggIWhvb2tzIHx8ICEoInNldCIgaW4gaG9va3MpIHx8IGhvb2tzLnNldCggdGhpcywgdmFsLCAidmFsdWUiICkgPT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMudmFsdWUgPSB2YWw7CgkJCX0KCQl9KTsKCX0KfSk7CgpqUXVlcnkuZXh0ZW5kKHsKCXZhbEhvb2tzOiB7CgkJb3B0aW9uOiB7CgkJCWdldDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQl2YXIgdmFsID0galF1ZXJ5LmZpbmQuYXR0ciggZWxlbSwgInZhbHVlIiApOwoJCQkJcmV0dXJuIHZhbCAhPSBudWxsID8KCQkJCQl2YWwgOgoJCQkJCWpRdWVyeS50ZXh0KCBlbGVtICk7CgkJCX0KCQl9LAoJCXNlbGVjdDogewoJCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJdmFyIHZhbHVlLCBvcHRpb24sCgkJCQkJb3B0aW9ucyA9IGVsZW0ub3B0aW9ucywKCQkJCQlpbmRleCA9IGVsZW0uc2VsZWN0ZWRJbmRleCwKCQkJCQlvbmUgPSBlbGVtLnR5cGUgPT09ICJzZWxlY3Qtb25lIiB8fCBpbmRleCA8IDAsCgkJCQkJdmFsdWVzID0gb25lID8gbnVsbCA6IFtdLAoJCQkJCW1heCA9IG9uZSA/IGluZGV4ICsgMSA6IG9wdGlvbnMubGVuZ3RoLAoJCQkJCWkgPSBpbmRleCA8IDAgPwoJCQkJCQltYXggOgoJCQkJCQlvbmUgPyBpbmRleCA6IDA7CgoJCQkJLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgc2VsZWN0ZWQgb3B0aW9ucwoJCQkJZm9yICggOyBpIDwgbWF4OyBpKysgKSB7CgkJCQkJb3B0aW9uID0gb3B0aW9uc1sgaSBdOwoKCQkJCQkvLyBvbGRJRSBkb2Vzbid0IHVwZGF0ZSBzZWxlY3RlZCBhZnRlciBmb3JtIHJlc2V0ICgjMjU1MSkKCQkJCQlpZiAoICggb3B0aW9uLnNlbGVjdGVkIHx8IGkgPT09IGluZGV4ICkgJiYKCQkJCQkJCS8vIERvbid0IHJldHVybiBvcHRpb25zIHRoYXQgYXJlIGRpc2FibGVkIG9yIGluIGEgZGlzYWJsZWQgb3B0Z3JvdXAKCQkJCQkJCSggc3VwcG9ydC5vcHREaXNhYmxlZCA/ICFvcHRpb24uZGlzYWJsZWQgOiBvcHRpb24uZ2V0QXR0cmlidXRlKCJkaXNhYmxlZCIpID09PSBudWxsICkgJiYKCQkJCQkJCSggIW9wdGlvbi5wYXJlbnROb2RlLmRpc2FibGVkIHx8ICFqUXVlcnkubm9kZU5hbWUoIG9wdGlvbi5wYXJlbnROb2RlLCAib3B0Z3JvdXAiICkgKSApIHsKCgkJCQkJCS8vIEdldCB0aGUgc3BlY2lmaWMgdmFsdWUgZm9yIHRoZSBvcHRpb24KCQkJCQkJdmFsdWUgPSBqUXVlcnkoIG9wdGlvbiApLnZhbCgpOwoKCQkJCQkJLy8gV2UgZG9uJ3QgbmVlZCBhbiBhcnJheSBmb3Igb25lIHNlbGVjdHMKCQkJCQkJaWYgKCBvbmUgKSB7CgkJCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQkJCX0KCgkJCQkJCS8vIE11bHRpLVNlbGVjdHMgcmV0dXJuIGFuIGFycmF5CgkJCQkJCXZhbHVlcy5wdXNoKCB2YWx1ZSApOwoJCQkJCX0KCQkJCX0KCgkJCQlyZXR1cm4gdmFsdWVzOwoJCQl9LAoKCQkJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7CgkJCQl2YXIgb3B0aW9uU2V0LCBvcHRpb24sCgkJCQkJb3B0aW9ucyA9IGVsZW0ub3B0aW9ucywKCQkJCQl2YWx1ZXMgPSBqUXVlcnkubWFrZUFycmF5KCB2YWx1ZSApLAoJCQkJCWkgPSBvcHRpb25zLmxlbmd0aDsKCgkJCQl3aGlsZSAoIGktLSApIHsKCQkJCQlvcHRpb24gPSBvcHRpb25zWyBpIF07CgoJCQkJCWlmICggalF1ZXJ5LmluQXJyYXkoIGpRdWVyeS52YWxIb29rcy5vcHRpb24uZ2V0KCBvcHRpb24gKSwgdmFsdWVzICkgPj0gMCApIHsKCgkJCQkJCS8vIFN1cHBvcnQ6IElFNgoJCQkJCQkvLyBXaGVuIG5ldyBvcHRpb24gZWxlbWVudCBpcyBhZGRlZCB0byBzZWxlY3QgYm94IHdlIG5lZWQgdG8KCQkJCQkJLy8gZm9yY2UgcmVmbG93IG9mIG5ld2x5IGFkZGVkIG5vZGUgaW4gb3JkZXIgdG8gd29ya2Fyb3VuZCBkZWxheQoJCQkJCQkvLyBvZiBpbml0aWFsaXphdGlvbiBwcm9wZXJ0aWVzCgkJCQkJCXRyeSB7CgkJCQkJCQlvcHRpb24uc2VsZWN0ZWQgPSBvcHRpb25TZXQgPSB0cnVlOwoKCQkJCQkJfSBjYXRjaCAoIF8gKSB7CgoJCQkJCQkJLy8gV2lsbCBiZSBleGVjdXRlZCBvbmx5IGluIElFNgoJCQkJCQkJb3B0aW9uLnNjcm9sbEhlaWdodDsKCQkJCQkJfQoKCQkJCQl9IGVsc2UgewoJCQkJCQlvcHRpb24uc2VsZWN0ZWQgPSBmYWxzZTsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gRm9yY2UgYnJvd3NlcnMgdG8gYmVoYXZlIGNvbnNpc3RlbnRseSB3aGVuIG5vbi1tYXRjaGluZyB2YWx1ZSBpcyBzZXQKCQkJCWlmICggIW9wdGlvblNldCApIHsKCQkJCQllbGVtLnNlbGVjdGVkSW5kZXggPSAtMTsKCQkJCX0KCgkJCQlyZXR1cm4gb3B0aW9uczsKCQkJfQoJCX0KCX0KfSk7CgovLyBSYWRpb3MgYW5kIGNoZWNrYm94ZXMgZ2V0dGVyL3NldHRlcgpqUXVlcnkuZWFjaChbICJyYWRpbyIsICJjaGVja2JveCIgXSwgZnVuY3Rpb24oKSB7CglqUXVlcnkudmFsSG9va3NbIHRoaXMgXSA9IHsKCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQkJaWYgKCBqUXVlcnkuaXNBcnJheSggdmFsdWUgKSApIHsKCQkJCXJldHVybiAoIGVsZW0uY2hlY2tlZCA9IGpRdWVyeS5pbkFycmF5KCBqUXVlcnkoZWxlbSkudmFsKCksIHZhbHVlICkgPj0gMCApOwoJCQl9CgkJfQoJfTsKCWlmICggIXN1cHBvcnQuY2hlY2tPbiApIHsKCQlqUXVlcnkudmFsSG9va3NbIHRoaXMgXS5nZXQgPSBmdW5jdGlvbiggZWxlbSApIHsKCQkJLy8gU3VwcG9ydDogV2Via2l0CgkJCS8vICIiIGlzIHJldHVybmVkIGluc3RlYWQgb2YgIm9uIiBpZiBhIHZhbHVlIGlzbid0IHNwZWNpZmllZAoJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoInZhbHVlIikgPT09IG51bGwgPyAib24iIDogZWxlbS52YWx1ZTsKCQl9OwoJfQp9KTsKCgoKCnZhciBub2RlSG9vaywgYm9vbEhvb2ssCglhdHRySGFuZGxlID0galF1ZXJ5LmV4cHIuYXR0ckhhbmRsZSwKCXJ1c2VEZWZhdWx0ID0gL14oPzpjaGVja2VkfHNlbGVjdGVkKSQvaSwKCWdldFNldEF0dHJpYnV0ZSA9IHN1cHBvcnQuZ2V0U2V0QXR0cmlidXRlLAoJZ2V0U2V0SW5wdXQgPSBzdXBwb3J0LmlucHV0OwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglhdHRyOiBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7CgkJcmV0dXJuIGFjY2VzcyggdGhpcywgalF1ZXJ5LmF0dHIsIG5hbWUsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSApOwoJfSwKCglyZW1vdmVBdHRyOiBmdW5jdGlvbiggbmFtZSApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkucmVtb3ZlQXR0ciggdGhpcywgbmFtZSApOwoJCX0pOwoJfQp9KTsKCmpRdWVyeS5leHRlbmQoewoJYXR0cjogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIHZhbHVlICkgewoJCXZhciBob29rcywgcmV0LAoJCQluVHlwZSA9IGVsZW0ubm9kZVR5cGU7CgoJCS8vIGRvbid0IGdldC9zZXQgYXR0cmlidXRlcyBvbiB0ZXh0LCBjb21tZW50IGFuZCBhdHRyaWJ1dGUgbm9kZXMKCQlpZiAoICFlbGVtIHx8IG5UeXBlID09PSAzIHx8IG5UeXBlID09PSA4IHx8IG5UeXBlID09PSAyICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBGYWxsYmFjayB0byBwcm9wIHdoZW4gYXR0cmlidXRlcyBhcmUgbm90IHN1cHBvcnRlZAoJCWlmICggdHlwZW9mIGVsZW0uZ2V0QXR0cmlidXRlID09PSBzdHJ1bmRlZmluZWQgKSB7CgkJCXJldHVybiBqUXVlcnkucHJvcCggZWxlbSwgbmFtZSwgdmFsdWUgKTsKCQl9CgoJCS8vIEFsbCBhdHRyaWJ1dGVzIGFyZSBsb3dlcmNhc2UKCQkvLyBHcmFiIG5lY2Vzc2FyeSBob29rIGlmIG9uZSBpcyBkZWZpbmVkCgkJaWYgKCBuVHlwZSAhPT0gMSB8fCAhalF1ZXJ5LmlzWE1MRG9jKCBlbGVtICkgKSB7CgkJCW5hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CgkJCWhvb2tzID0galF1ZXJ5LmF0dHJIb29rc1sgbmFtZSBdIHx8CgkJCQkoIGpRdWVyeS5leHByLm1hdGNoLmJvb2wudGVzdCggbmFtZSApID8gYm9vbEhvb2sgOiBub2RlSG9vayApOwoJCX0KCgkJaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoKCQkJaWYgKCB2YWx1ZSA9PT0gbnVsbCApIHsKCQkJCWpRdWVyeS5yZW1vdmVBdHRyKCBlbGVtLCBuYW1lICk7CgoJCQl9IGVsc2UgaWYgKCBob29rcyAmJiAic2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3Muc2V0KCBlbGVtLCB2YWx1ZSwgbmFtZSApKSAhPT0gdW5kZWZpbmVkICkgewoJCQkJcmV0dXJuIHJldDsKCgkJCX0gZWxzZSB7CgkJCQllbGVtLnNldEF0dHJpYnV0ZSggbmFtZSwgdmFsdWUgKyAiIiApOwoJCQkJcmV0dXJuIHZhbHVlOwoJCQl9CgoJCX0gZWxzZSBpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoIGVsZW0sIG5hbWUgKSkgIT09IG51bGwgKSB7CgkJCXJldHVybiByZXQ7CgoJCX0gZWxzZSB7CgkJCXJldCA9IGpRdWVyeS5maW5kLmF0dHIoIGVsZW0sIG5hbWUgKTsKCgkJCS8vIE5vbi1leGlzdGVudCBhdHRyaWJ1dGVzIHJldHVybiBudWxsLCB3ZSBub3JtYWxpemUgdG8gdW5kZWZpbmVkCgkJCXJldHVybiByZXQgPT0gbnVsbCA/CgkJCQl1bmRlZmluZWQgOgoJCQkJcmV0OwoJCX0KCX0sCgoJcmVtb3ZlQXR0cjogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgewoJCXZhciBuYW1lLCBwcm9wTmFtZSwKCQkJaSA9IDAsCgkJCWF0dHJOYW1lcyA9IHZhbHVlICYmIHZhbHVlLm1hdGNoKCBybm90d2hpdGUgKTsKCgkJaWYgKCBhdHRyTmFtZXMgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJd2hpbGUgKCAobmFtZSA9IGF0dHJOYW1lc1tpKytdKSApIHsKCQkJCXByb3BOYW1lID0galF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lOwoKCQkJCS8vIEJvb2xlYW4gYXR0cmlidXRlcyBnZXQgc3BlY2lhbCB0cmVhdG1lbnQgKCMxMDg3MCkKCQkJCWlmICggalF1ZXJ5LmV4cHIubWF0Y2guYm9vbC50ZXN0KCBuYW1lICkgKSB7CgkJCQkJLy8gU2V0IGNvcnJlc3BvbmRpbmcgcHJvcGVydHkgdG8gZmFsc2UKCQkJCQlpZiAoIGdldFNldElucHV0ICYmIGdldFNldEF0dHJpYnV0ZSB8fCAhcnVzZURlZmF1bHQudGVzdCggbmFtZSApICkgewoJCQkJCQllbGVtWyBwcm9wTmFtZSBdID0gZmFsc2U7CgkJCQkJLy8gU3VwcG9ydDogSUU8OQoJCQkJCS8vIEFsc28gY2xlYXIgZGVmYXVsdENoZWNrZWQvZGVmYXVsdFNlbGVjdGVkIChpZiBhcHByb3ByaWF0ZSkKCQkJCQl9IGVsc2UgewoJCQkJCQllbGVtWyBqUXVlcnkuY2FtZWxDYXNlKCAiZGVmYXVsdC0iICsgbmFtZSApIF0gPQoJCQkJCQkJZWxlbVsgcHJvcE5hbWUgXSA9IGZhbHNlOwoJCQkJCX0KCgkJCQkvLyBTZWUgIzk2OTkgZm9yIGV4cGxhbmF0aW9uIG9mIHRoaXMgYXBwcm9hY2ggKHNldHRpbmcgZmlyc3QsIHRoZW4gcmVtb3ZhbCkKCQkJCX0gZWxzZSB7CgkJCQkJalF1ZXJ5LmF0dHIoIGVsZW0sIG5hbWUsICIiICk7CgkJCQl9CgoJCQkJZWxlbS5yZW1vdmVBdHRyaWJ1dGUoIGdldFNldEF0dHJpYnV0ZSA/IG5hbWUgOiBwcm9wTmFtZSApOwoJCQl9CgkJfQoJfSwKCglhdHRySG9va3M6IHsKCQl0eXBlOiB7CgkJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgewoJCQkJaWYgKCAhc3VwcG9ydC5yYWRpb1ZhbHVlICYmIHZhbHVlID09PSAicmFkaW8iICYmIGpRdWVyeS5ub2RlTmFtZShlbGVtLCAiaW5wdXQiKSApIHsKCQkJCQkvLyBTZXR0aW5nIHRoZSB0eXBlIG9uIGEgcmFkaW8gYnV0dG9uIGFmdGVyIHRoZSB2YWx1ZSByZXNldHMgdGhlIHZhbHVlIGluIElFNi05CgkJCQkJLy8gUmVzZXQgdmFsdWUgdG8gZGVmYXVsdCBpbiBjYXNlIHR5cGUgaXMgc2V0IGFmdGVyIHZhbHVlIGR1cmluZyBjcmVhdGlvbgoJCQkJCXZhciB2YWwgPSBlbGVtLnZhbHVlOwoJCQkJCWVsZW0uc2V0QXR0cmlidXRlKCAidHlwZSIsIHZhbHVlICk7CgkJCQkJaWYgKCB2YWwgKSB7CgkJCQkJCWVsZW0udmFsdWUgPSB2YWw7CgkJCQkJfQoJCQkJCXJldHVybiB2YWx1ZTsKCQkJCX0KCQkJfQoJCX0KCX0KfSk7CgovLyBIb29rIGZvciBib29sZWFuIGF0dHJpYnV0ZXMKYm9vbEhvb2sgPSB7CglzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSwgbmFtZSApIHsKCQlpZiAoIHZhbHVlID09PSBmYWxzZSApIHsKCQkJLy8gUmVtb3ZlIGJvb2xlYW4gYXR0cmlidXRlcyB3aGVuIHNldCB0byBmYWxzZQoJCQlqUXVlcnkucmVtb3ZlQXR0ciggZWxlbSwgbmFtZSApOwoJCX0gZWxzZSBpZiAoIGdldFNldElucHV0ICYmIGdldFNldEF0dHJpYnV0ZSB8fCAhcnVzZURlZmF1bHQudGVzdCggbmFtZSApICkgewoJCQkvLyBJRTw4IG5lZWRzIHRoZSAqcHJvcGVydHkqIG5hbWUKCQkJZWxlbS5zZXRBdHRyaWJ1dGUoICFnZXRTZXRBdHRyaWJ1dGUgJiYgalF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lLCBuYW1lICk7CgoJCS8vIFVzZSBkZWZhdWx0Q2hlY2tlZCBhbmQgZGVmYXVsdFNlbGVjdGVkIGZvciBvbGRJRQoJCX0gZWxzZSB7CgkJCWVsZW1bIGpRdWVyeS5jYW1lbENhc2UoICJkZWZhdWx0LSIgKyBuYW1lICkgXSA9IGVsZW1bIG5hbWUgXSA9IHRydWU7CgkJfQoKCQlyZXR1cm4gbmFtZTsKCX0KfTsKCi8vIFJldHJpZXZlIGJvb2xlYW5zIHNwZWNpYWxseQpqUXVlcnkuZWFjaCggalF1ZXJ5LmV4cHIubWF0Y2guYm9vbC5zb3VyY2UubWF0Y2goIC9cdysvZyApLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgl2YXIgZ2V0dGVyID0gYXR0ckhhbmRsZVsgbmFtZSBdIHx8IGpRdWVyeS5maW5kLmF0dHI7CgoJYXR0ckhhbmRsZVsgbmFtZSBdID0gZ2V0U2V0SW5wdXQgJiYgZ2V0U2V0QXR0cmlidXRlIHx8ICFydXNlRGVmYXVsdC50ZXN0KCBuYW1lICkgPwoJCWZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBpc1hNTCApIHsKCQkJdmFyIHJldCwgaGFuZGxlOwoJCQlpZiAoICFpc1hNTCApIHsKCQkJCS8vIEF2b2lkIGFuIGluZmluaXRlIGxvb3AgYnkgdGVtcG9yYXJpbHkgcmVtb3ZpbmcgdGhpcyBmdW5jdGlvbiBmcm9tIHRoZSBnZXR0ZXIKCQkJCWhhbmRsZSA9IGF0dHJIYW5kbGVbIG5hbWUgXTsKCQkJCWF0dHJIYW5kbGVbIG5hbWUgXSA9IHJldDsKCQkJCXJldCA9IGdldHRlciggZWxlbSwgbmFtZSwgaXNYTUwgKSAhPSBudWxsID8KCQkJCQluYW1lLnRvTG93ZXJDYXNlKCkgOgoJCQkJCW51bGw7CgkJCQlhdHRySGFuZGxlWyBuYW1lIF0gPSBoYW5kbGU7CgkJCX0KCQkJcmV0dXJuIHJldDsKCQl9IDoKCQlmdW5jdGlvbiggZWxlbSwgbmFtZSwgaXNYTUwgKSB7CgkJCWlmICggIWlzWE1MICkgewoJCQkJcmV0dXJuIGVsZW1bIGpRdWVyeS5jYW1lbENhc2UoICJkZWZhdWx0LSIgKyBuYW1lICkgXSA/CgkJCQkJbmFtZS50b0xvd2VyQ2FzZSgpIDoKCQkJCQludWxsOwoJCQl9CgkJfTsKfSk7CgovLyBmaXggb2xkSUUgYXR0cm9wZXJ0aWVzCmlmICggIWdldFNldElucHV0IHx8ICFnZXRTZXRBdHRyaWJ1dGUgKSB7CglqUXVlcnkuYXR0ckhvb2tzLnZhbHVlID0gewoJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBuYW1lICkgewoJCQlpZiAoIGpRdWVyeS5ub2RlTmFtZSggZWxlbSwgImlucHV0IiApICkgewoJCQkJLy8gRG9lcyBub3QgcmV0dXJuIHNvIHRoYXQgc2V0QXR0cmlidXRlIGlzIGFsc28gdXNlZAoJCQkJZWxlbS5kZWZhdWx0VmFsdWUgPSB2YWx1ZTsKCQkJfSBlbHNlIHsKCQkJCS8vIFVzZSBub2RlSG9vayBpZiBkZWZpbmVkICgjMTk1NCk7IG90aGVyd2lzZSBzZXRBdHRyaWJ1dGUgaXMgZmluZQoJCQkJcmV0dXJuIG5vZGVIb29rICYmIG5vZGVIb29rLnNldCggZWxlbSwgdmFsdWUsIG5hbWUgKTsKCQkJfQoJCX0KCX07Cn0KCi8vIElFNi83IGRvIG5vdCBzdXBwb3J0IGdldHRpbmcvc2V0dGluZyBzb21lIGF0dHJpYnV0ZXMgd2l0aCBnZXQvc2V0QXR0cmlidXRlCmlmICggIWdldFNldEF0dHJpYnV0ZSApIHsKCgkvLyBVc2UgdGhpcyBmb3IgYW55IGF0dHJpYnV0ZSBpbiBJRTYvNwoJLy8gVGhpcyBmaXhlcyBhbG1vc3QgZXZlcnkgSUU2LzcgaXNzdWUKCW5vZGVIb29rID0gewoJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBuYW1lICkgewoJCQkvLyBTZXQgdGhlIGV4aXN0aW5nIG9yIGNyZWF0ZSBhIG5ldyBhdHRyaWJ1dGUgbm9kZQoJCQl2YXIgcmV0ID0gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCBuYW1lICk7CgkJCWlmICggIXJldCApIHsKCQkJCWVsZW0uc2V0QXR0cmlidXRlTm9kZSgKCQkJCQkocmV0ID0gZWxlbS5vd25lckRvY3VtZW50LmNyZWF0ZUF0dHJpYnV0ZSggbmFtZSApKQoJCQkJKTsKCQkJfQoKCQkJcmV0LnZhbHVlID0gdmFsdWUgKz0gIiI7CgoJCQkvLyBCcmVhayBhc3NvY2lhdGlvbiB3aXRoIGNsb25lZCBlbGVtZW50cyBieSBhbHNvIHVzaW5nIHNldEF0dHJpYnV0ZSAoIzk2NDYpCgkJCWlmICggbmFtZSA9PT0gInZhbHVlIiB8fCB2YWx1ZSA9PT0gZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUgKSApIHsKCQkJCXJldHVybiB2YWx1ZTsKCQkJfQoJCX0KCX07CgoJLy8gU29tZSBhdHRyaWJ1dGVzIGFyZSBjb25zdHJ1Y3RlZCB3aXRoIGVtcHR5LXN0cmluZyB2YWx1ZXMgd2hlbiBub3QgZGVmaW5lZAoJYXR0ckhhbmRsZS5pZCA9IGF0dHJIYW5kbGUubmFtZSA9IGF0dHJIYW5kbGUuY29vcmRzID0KCQlmdW5jdGlvbiggZWxlbSwgbmFtZSwgaXNYTUwgKSB7CgkJCXZhciByZXQ7CgkJCWlmICggIWlzWE1MICkgewoJCQkJcmV0dXJuIChyZXQgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoIG5hbWUgKSkgJiYgcmV0LnZhbHVlICE9PSAiIiA/CgkJCQkJcmV0LnZhbHVlIDoKCQkJCQludWxsOwoJCQl9CgkJfTsKCgkvLyBGaXhpbmcgdmFsdWUgcmV0cmlldmFsIG9uIGEgYnV0dG9uIHJlcXVpcmVzIHRoaXMgbW9kdWxlCglqUXVlcnkudmFsSG9va3MuYnV0dG9uID0gewoJCWdldDogZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7CgkJCXZhciByZXQgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoIG5hbWUgKTsKCQkJaWYgKCByZXQgJiYgcmV0LnNwZWNpZmllZCApIHsKCQkJCXJldHVybiByZXQudmFsdWU7CgkJCX0KCQl9LAoJCXNldDogbm9kZUhvb2suc2V0Cgl9OwoKCS8vIFNldCBjb250ZW50ZWRpdGFibGUgdG8gZmFsc2Ugb24gcmVtb3ZhbHMoIzEwNDI5KQoJLy8gU2V0dGluZyB0byBlbXB0eSBzdHJpbmcgdGhyb3dzIGFuIGVycm9yIGFzIGFuIGludmFsaWQgdmFsdWUKCWpRdWVyeS5hdHRySG9va3MuY29udGVudGVkaXRhYmxlID0gewoJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBuYW1lICkgewoJCQlub2RlSG9vay5zZXQoIGVsZW0sIHZhbHVlID09PSAiIiA/IGZhbHNlIDogdmFsdWUsIG5hbWUgKTsKCQl9Cgl9OwoKCS8vIFNldCB3aWR0aCBhbmQgaGVpZ2h0IHRvIGF1dG8gaW5zdGVhZCBvZiAwIG9uIGVtcHR5IHN0cmluZyggQnVnICM4MTUwICkKCS8vIFRoaXMgaXMgZm9yIHJlbW92YWxzCglqUXVlcnkuZWFjaChbICJ3aWR0aCIsICJoZWlnaHQiIF0sIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoJCWpRdWVyeS5hdHRySG9va3NbIG5hbWUgXSA9IHsKCQkJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7CgkJCQlpZiAoIHZhbHVlID09PSAiIiApIHsKCQkJCQllbGVtLnNldEF0dHJpYnV0ZSggbmFtZSwgImF1dG8iICk7CgkJCQkJcmV0dXJuIHZhbHVlOwoJCQkJfQoJCQl9CgkJfTsKCX0pOwp9CgppZiAoICFzdXBwb3J0LnN0eWxlICkgewoJalF1ZXJ5LmF0dHJIb29rcy5zdHlsZSA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkvLyBSZXR1cm4gdW5kZWZpbmVkIGluIHRoZSBjYXNlIG9mIGVtcHR5IHN0cmluZwoJCQkvLyBOb3RlOiBJRSB1cHBlcmNhc2VzIGNzcyBwcm9wZXJ0eSBuYW1lcywgYnV0IGlmIHdlIHdlcmUgdG8gLnRvTG93ZXJDYXNlKCkKCQkJLy8gLmNzc1RleHQsIHRoYXQgd291bGQgZGVzdHJveSBjYXNlIHNlbnN0aXRpdml0eSBpbiBVUkwncywgbGlrZSBpbiAiYmFja2dyb3VuZCIKCQkJcmV0dXJuIGVsZW0uc3R5bGUuY3NzVGV4dCB8fCB1bmRlZmluZWQ7CgkJfSwKCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQkJcmV0dXJuICggZWxlbS5zdHlsZS5jc3NUZXh0ID0gdmFsdWUgKyAiIiApOwoJCX0KCX07Cn0KCgoKCnZhciByZm9jdXNhYmxlID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9ufG9iamVjdCkkL2ksCglyY2xpY2thYmxlID0gL14oPzphfGFyZWEpJC9pOwoKalF1ZXJ5LmZuLmV4dGVuZCh7Cglwcm9wOiBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7CgkJcmV0dXJuIGFjY2VzcyggdGhpcywgalF1ZXJ5LnByb3AsIG5hbWUsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSApOwoJfSwKCglyZW1vdmVQcm9wOiBmdW5jdGlvbiggbmFtZSApIHsKCQluYW1lID0galF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lOwoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCS8vIHRyeS9jYXRjaCBoYW5kbGVzIGNhc2VzIHdoZXJlIElFIGJhbGtzIChzdWNoIGFzIHJlbW92aW5nIGEgcHJvcGVydHkgb24gd2luZG93KQoJCQl0cnkgewoJCQkJdGhpc1sgbmFtZSBdID0gdW5kZWZpbmVkOwoJCQkJZGVsZXRlIHRoaXNbIG5hbWUgXTsKCQkJfSBjYXRjaCggZSApIHt9CgkJfSk7Cgl9Cn0pOwoKalF1ZXJ5LmV4dGVuZCh7Cglwcm9wRml4OiB7CgkJImZvciI6ICJodG1sRm9yIiwKCQkiY2xhc3MiOiAiY2xhc3NOYW1lIgoJfSwKCglwcm9wOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUgKSB7CgkJdmFyIHJldCwgaG9va3MsIG5vdHhtbCwKCQkJblR5cGUgPSBlbGVtLm5vZGVUeXBlOwoKCQkvLyBkb24ndCBnZXQvc2V0IHByb3BlcnRpZXMgb24gdGV4dCwgY29tbWVudCBhbmQgYXR0cmlidXRlIG5vZGVzCgkJaWYgKCAhZWxlbSB8fCBuVHlwZSA9PT0gMyB8fCBuVHlwZSA9PT0gOCB8fCBuVHlwZSA9PT0gMiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJbm90eG1sID0gblR5cGUgIT09IDEgfHwgIWpRdWVyeS5pc1hNTERvYyggZWxlbSApOwoKCQlpZiAoIG5vdHhtbCApIHsKCQkJLy8gRml4IG5hbWUgYW5kIGF0dGFjaCBob29rcwoJCQluYW1lID0galF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lOwoJCQlob29rcyA9IGpRdWVyeS5wcm9wSG9va3NbIG5hbWUgXTsKCQl9CgoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIGhvb2tzICYmICJzZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5zZXQoIGVsZW0sIHZhbHVlLCBuYW1lICkpICE9PSB1bmRlZmluZWQgPwoJCQkJcmV0IDoKCQkJCSggZWxlbVsgbmFtZSBdID0gdmFsdWUgKTsKCgkJfSBlbHNlIHsKCQkJcmV0dXJuIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoIGVsZW0sIG5hbWUgKSkgIT09IG51bGwgPwoJCQkJcmV0IDoKCQkJCWVsZW1bIG5hbWUgXTsKCQl9Cgl9LAoKCXByb3BIb29rczogewoJCXRhYkluZGV4OiB7CgkJCWdldDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQkvLyBlbGVtLnRhYkluZGV4IGRvZXNuJ3QgYWx3YXlzIHJldHVybiB0aGUgY29ycmVjdCB2YWx1ZSB3aGVuIGl0IGhhc24ndCBiZWVuIGV4cGxpY2l0bHkgc2V0CgkJCQkvLyBodHRwOi8vZmx1aWRwcm9qZWN0Lm9yZy9ibG9nLzIwMDgvMDEvMDkvZ2V0dGluZy1zZXR0aW5nLWFuZC1yZW1vdmluZy10YWJpbmRleC12YWx1ZXMtd2l0aC1qYXZhc2NyaXB0LwoJCQkJLy8gVXNlIHByb3BlciBhdHRyaWJ1dGUgcmV0cmlldmFsKCMxMjA3MikKCQkJCXZhciB0YWJpbmRleCA9IGpRdWVyeS5maW5kLmF0dHIoIGVsZW0sICJ0YWJpbmRleCIgKTsKCgkJCQlyZXR1cm4gdGFiaW5kZXggPwoJCQkJCXBhcnNlSW50KCB0YWJpbmRleCwgMTAgKSA6CgkJCQkJcmZvY3VzYWJsZS50ZXN0KCBlbGVtLm5vZGVOYW1lICkgfHwgcmNsaWNrYWJsZS50ZXN0KCBlbGVtLm5vZGVOYW1lICkgJiYgZWxlbS5ocmVmID8KCQkJCQkJMCA6CgkJCQkJCS0xOwoJCQl9CgkJfQoJfQp9KTsKCi8vIFNvbWUgYXR0cmlidXRlcyByZXF1aXJlIGEgc3BlY2lhbCBjYWxsIG9uIElFCi8vIGh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9tczUzNjQyOSUyOFZTLjg1JTI5LmFzcHgKaWYgKCAhc3VwcG9ydC5ocmVmTm9ybWFsaXplZCApIHsKCS8vIGhyZWYvc3JjIHByb3BlcnR5IHNob3VsZCBnZXQgdGhlIGZ1bGwgbm9ybWFsaXplZCBVUkwgKCMxMDI5OS8jMTI5MTUpCglqUXVlcnkuZWFjaChbICJocmVmIiwgInNyYyIgXSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgkJalF1ZXJ5LnByb3BIb29rc1sgbmFtZSBdID0gewoJCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lLCA0ICk7CgkJCX0KCQl9OwoJfSk7Cn0KCi8vIFN1cHBvcnQ6IFNhZmFyaSwgSUU5KwovLyBtaXMtcmVwb3J0cyB0aGUgZGVmYXVsdCBzZWxlY3RlZCBwcm9wZXJ0eSBvZiBhbiBvcHRpb24KLy8gQWNjZXNzaW5nIHRoZSBwYXJlbnQncyBzZWxlY3RlZEluZGV4IHByb3BlcnR5IGZpeGVzIGl0CmlmICggIXN1cHBvcnQub3B0U2VsZWN0ZWQgKSB7CglqUXVlcnkucHJvcEhvb2tzLnNlbGVjdGVkID0gewoJCWdldDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXZhciBwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGU7CgoJCQlpZiAoIHBhcmVudCApIHsKCQkJCXBhcmVudC5zZWxlY3RlZEluZGV4OwoKCQkJCS8vIE1ha2Ugc3VyZSB0aGF0IGl0IGFsc28gd29ya3Mgd2l0aCBvcHRncm91cHMsIHNlZSAjNTcwMQoJCQkJaWYgKCBwYXJlbnQucGFyZW50Tm9kZSApIHsKCQkJCQlwYXJlbnQucGFyZW50Tm9kZS5zZWxlY3RlZEluZGV4OwoJCQkJfQoJCQl9CgkJCXJldHVybiBudWxsOwoJCX0KCX07Cn0KCmpRdWVyeS5lYWNoKFsKCSJ0YWJJbmRleCIsCgkicmVhZE9ubHkiLAoJIm1heExlbmd0aCIsCgkiY2VsbFNwYWNpbmciLAoJImNlbGxQYWRkaW5nIiwKCSJyb3dTcGFuIiwKCSJjb2xTcGFuIiwKCSJ1c2VNYXAiLAoJImZyYW1lQm9yZGVyIiwKCSJjb250ZW50RWRpdGFibGUiCl0sIGZ1bmN0aW9uKCkgewoJalF1ZXJ5LnByb3BGaXhbIHRoaXMudG9Mb3dlckNhc2UoKSBdID0gdGhpczsKfSk7CgovLyBJRTYvNyBjYWxsIGVuY3R5cGUgZW5jb2RpbmcKaWYgKCAhc3VwcG9ydC5lbmN0eXBlICkgewoJalF1ZXJ5LnByb3BGaXguZW5jdHlwZSA9ICJlbmNvZGluZyI7Cn0KCgoKCnZhciByY2xhc3MgPSAvW1x0XHJcblxmXS9nOwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglhZGRDbGFzczogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhciBjbGFzc2VzLCBlbGVtLCBjdXIsIGNsYXp6LCBqLCBmaW5hbFZhbHVlLAoJCQlpID0gMCwKCQkJbGVuID0gdGhpcy5sZW5ndGgsCgkJCXByb2NlZWQgPSB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICYmIHZhbHVlOwoKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCBqICkgewoJCQkJalF1ZXJ5KCB0aGlzICkuYWRkQ2xhc3MoIHZhbHVlLmNhbGwoIHRoaXMsIGosIHRoaXMuY2xhc3NOYW1lICkgKTsKCQkJfSk7CgkJfQoKCQlpZiAoIHByb2NlZWQgKSB7CgkJCS8vIFRoZSBkaXNqdW5jdGlvbiBoZXJlIGlzIGZvciBiZXR0ZXIgY29tcHJlc3NpYmlsaXR5IChzZWUgcmVtb3ZlQ2xhc3MpCgkJCWNsYXNzZXMgPSAoIHZhbHVlIHx8ICIiICkubWF0Y2goIHJub3R3aGl0ZSApIHx8IFtdOwoKCQkJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CgkJCQllbGVtID0gdGhpc1sgaSBdOwoJCQkJY3VyID0gZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAoIGVsZW0uY2xhc3NOYW1lID8KCQkJCQkoICIgIiArIGVsZW0uY2xhc3NOYW1lICsgIiAiICkucmVwbGFjZSggcmNsYXNzLCAiICIgKSA6CgkJCQkJIiAiCgkJCQkpOwoKCQkJCWlmICggY3VyICkgewoJCQkJCWogPSAwOwoJCQkJCXdoaWxlICggKGNsYXp6ID0gY2xhc3Nlc1tqKytdKSApIHsKCQkJCQkJaWYgKCBjdXIuaW5kZXhPZiggIiAiICsgY2xhenogKyAiICIgKSA8IDAgKSB7CgkJCQkJCQljdXIgKz0gY2xhenogKyAiICI7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCS8vIG9ubHkgYXNzaWduIGlmIGRpZmZlcmVudCB0byBhdm9pZCB1bm5lZWRlZCByZW5kZXJpbmcuCgkJCQkJZmluYWxWYWx1ZSA9IGpRdWVyeS50cmltKCBjdXIgKTsKCQkJCQlpZiAoIGVsZW0uY2xhc3NOYW1lICE9PSBmaW5hbFZhbHVlICkgewoJCQkJCQllbGVtLmNsYXNzTmFtZSA9IGZpbmFsVmFsdWU7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YXIgY2xhc3NlcywgZWxlbSwgY3VyLCBjbGF6eiwgaiwgZmluYWxWYWx1ZSwKCQkJaSA9IDAsCgkJCWxlbiA9IHRoaXMubGVuZ3RoLAoJCQlwcm9jZWVkID0gYXJndW1lbnRzLmxlbmd0aCA9PT0gMCB8fCB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICYmIHZhbHVlOwoKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCBqICkgewoJCQkJalF1ZXJ5KCB0aGlzICkucmVtb3ZlQ2xhc3MoIHZhbHVlLmNhbGwoIHRoaXMsIGosIHRoaXMuY2xhc3NOYW1lICkgKTsKCQkJfSk7CgkJfQoJCWlmICggcHJvY2VlZCApIHsKCQkJY2xhc3NlcyA9ICggdmFsdWUgfHwgIiIgKS5tYXRjaCggcm5vdHdoaXRlICkgfHwgW107CgoJCQlmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQkJCWVsZW0gPSB0aGlzWyBpIF07CgkJCQkvLyBUaGlzIGV4cHJlc3Npb24gaXMgaGVyZSBmb3IgYmV0dGVyIGNvbXByZXNzaWJpbGl0eSAoc2VlIGFkZENsYXNzKQoJCQkJY3VyID0gZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAoIGVsZW0uY2xhc3NOYW1lID8KCQkJCQkoICIgIiArIGVsZW0uY2xhc3NOYW1lICsgIiAiICkucmVwbGFjZSggcmNsYXNzLCAiICIgKSA6CgkJCQkJIiIKCQkJCSk7CgoJCQkJaWYgKCBjdXIgKSB7CgkJCQkJaiA9IDA7CgkJCQkJd2hpbGUgKCAoY2xhenogPSBjbGFzc2VzW2orK10pICkgewoJCQkJCQkvLyBSZW1vdmUgKmFsbCogaW5zdGFuY2VzCgkJCQkJCXdoaWxlICggY3VyLmluZGV4T2YoICIgIiArIGNsYXp6ICsgIiAiICkgPj0gMCApIHsKCQkJCQkJCWN1ciA9IGN1ci5yZXBsYWNlKCAiICIgKyBjbGF6eiArICIgIiwgIiAiICk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCS8vIG9ubHkgYXNzaWduIGlmIGRpZmZlcmVudCB0byBhdm9pZCB1bm5lZWRlZCByZW5kZXJpbmcuCgkJCQkJZmluYWxWYWx1ZSA9IHZhbHVlID8galF1ZXJ5LnRyaW0oIGN1ciApIDogIiI7CgkJCQkJaWYgKCBlbGVtLmNsYXNzTmFtZSAhPT0gZmluYWxWYWx1ZSApIHsKCQkJCQkJZWxlbS5jbGFzc05hbWUgPSBmaW5hbFZhbHVlOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXRvZ2dsZUNsYXNzOiBmdW5jdGlvbiggdmFsdWUsIHN0YXRlVmFsICkgewoJCXZhciB0eXBlID0gdHlwZW9mIHZhbHVlOwoKCQlpZiAoIHR5cGVvZiBzdGF0ZVZhbCA9PT0gImJvb2xlYW4iICYmIHR5cGUgPT09ICJzdHJpbmciICkgewoJCQlyZXR1cm4gc3RhdGVWYWwgPyB0aGlzLmFkZENsYXNzKCB2YWx1ZSApIDogdGhpcy5yZW1vdmVDbGFzcyggdmFsdWUgKTsKCQl9CgoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oIGkgKSB7CgkJCQlqUXVlcnkoIHRoaXMgKS50b2dnbGVDbGFzcyggdmFsdWUuY2FsbCh0aGlzLCBpLCB0aGlzLmNsYXNzTmFtZSwgc3RhdGVWYWwpLCBzdGF0ZVZhbCApOwoJCQl9KTsKCQl9CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWlmICggdHlwZSA9PT0gInN0cmluZyIgKSB7CgkJCQkvLyB0b2dnbGUgaW5kaXZpZHVhbCBjbGFzcyBuYW1lcwoJCQkJdmFyIGNsYXNzTmFtZSwKCQkJCQlpID0gMCwKCQkJCQlzZWxmID0galF1ZXJ5KCB0aGlzICksCgkJCQkJY2xhc3NOYW1lcyA9IHZhbHVlLm1hdGNoKCBybm90d2hpdGUgKSB8fCBbXTsKCgkJCQl3aGlsZSAoIChjbGFzc05hbWUgPSBjbGFzc05hbWVzWyBpKysgXSkgKSB7CgkJCQkJLy8gY2hlY2sgZWFjaCBjbGFzc05hbWUgZ2l2ZW4sIHNwYWNlIHNlcGFyYXRlZCBsaXN0CgkJCQkJaWYgKCBzZWxmLmhhc0NsYXNzKCBjbGFzc05hbWUgKSApIHsKCQkJCQkJc2VsZi5yZW1vdmVDbGFzcyggY2xhc3NOYW1lICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJc2VsZi5hZGRDbGFzcyggY2xhc3NOYW1lICk7CgkJCQkJfQoJCQkJfQoKCQkJLy8gVG9nZ2xlIHdob2xlIGNsYXNzIG5hbWUKCQkJfSBlbHNlIGlmICggdHlwZSA9PT0gc3RydW5kZWZpbmVkIHx8IHR5cGUgPT09ICJib29sZWFuIiApIHsKCQkJCWlmICggdGhpcy5jbGFzc05hbWUgKSB7CgkJCQkJLy8gc3RvcmUgY2xhc3NOYW1lIGlmIHNldAoJCQkJCWpRdWVyeS5fZGF0YSggdGhpcywgIl9fY2xhc3NOYW1lX18iLCB0aGlzLmNsYXNzTmFtZSApOwoJCQkJfQoKCQkJCS8vIElmIHRoZSBlbGVtZW50IGhhcyBhIGNsYXNzIG5hbWUgb3IgaWYgd2UncmUgcGFzc2VkICJmYWxzZSIsCgkJCQkvLyB0aGVuIHJlbW92ZSB0aGUgd2hvbGUgY2xhc3NuYW1lIChpZiB0aGVyZSB3YXMgb25lLCB0aGUgYWJvdmUgc2F2ZWQgaXQpLgoJCQkJLy8gT3RoZXJ3aXNlIGJyaW5nIGJhY2sgd2hhdGV2ZXIgd2FzIHByZXZpb3VzbHkgc2F2ZWQgKGlmIGFueXRoaW5nKSwKCQkJCS8vIGZhbGxpbmcgYmFjayB0byB0aGUgZW1wdHkgc3RyaW5nIGlmIG5vdGhpbmcgd2FzIHN0b3JlZC4KCQkJCXRoaXMuY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUgfHwgdmFsdWUgPT09IGZhbHNlID8gIiIgOiBqUXVlcnkuX2RhdGEoIHRoaXMsICJfX2NsYXNzTmFtZV9fIiApIHx8ICIiOwoJCQl9CgkJfSk7Cgl9LAoKCWhhc0NsYXNzOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJdmFyIGNsYXNzTmFtZSA9ICIgIiArIHNlbGVjdG9yICsgIiAiLAoJCQlpID0gMCwKCQkJbCA9IHRoaXMubGVuZ3RoOwoJCWZvciAoIDsgaSA8IGw7IGkrKyApIHsKCQkJaWYgKCB0aGlzW2ldLm5vZGVUeXBlID09PSAxICYmICgiICIgKyB0aGlzW2ldLmNsYXNzTmFtZSArICIgIikucmVwbGFjZShyY2xhc3MsICIgIikuaW5kZXhPZiggY2xhc3NOYW1lICkgPj0gMCApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoKCQlyZXR1cm4gZmFsc2U7Cgl9Cn0pOwoKCgoKLy8gUmV0dXJuIGpRdWVyeSBmb3IgYXR0cmlidXRlcy1vbmx5IGluY2x1c2lvbgoKCmpRdWVyeS5lYWNoKCAoImJsdXIgZm9jdXMgZm9jdXNpbiBmb2N1c291dCBsb2FkIHJlc2l6ZSBzY3JvbGwgdW5sb2FkIGNsaWNrIGRibGNsaWNrICIgKwoJIm1vdXNlZG93biBtb3VzZXVwIG1vdXNlbW92ZSBtb3VzZW92ZXIgbW91c2VvdXQgbW91c2VlbnRlciBtb3VzZWxlYXZlICIgKwoJImNoYW5nZSBzZWxlY3Qgc3VibWl0IGtleWRvd24ga2V5cHJlc3Mga2V5dXAgZXJyb3IgY29udGV4dG1lbnUiKS5zcGxpdCgiICIpLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgkvLyBIYW5kbGUgZXZlbnQgYmluZGluZwoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggZGF0YSwgZm4gKSB7CgkJcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPiAwID8KCQkJdGhpcy5vbiggbmFtZSwgbnVsbCwgZGF0YSwgZm4gKSA6CgkJCXRoaXMudHJpZ2dlciggbmFtZSApOwoJfTsKfSk7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCWhvdmVyOiBmdW5jdGlvbiggZm5PdmVyLCBmbk91dCApIHsKCQlyZXR1cm4gdGhpcy5tb3VzZWVudGVyKCBmbk92ZXIgKS5tb3VzZWxlYXZlKCBmbk91dCB8fCBmbk92ZXIgKTsKCX0sCgoJYmluZDogZnVuY3Rpb24oIHR5cGVzLCBkYXRhLCBmbiApIHsKCQlyZXR1cm4gdGhpcy5vbiggdHlwZXMsIG51bGwsIGRhdGEsIGZuICk7Cgl9LAoJdW5iaW5kOiBmdW5jdGlvbiggdHlwZXMsIGZuICkgewoJCXJldHVybiB0aGlzLm9mZiggdHlwZXMsIG51bGwsIGZuICk7Cgl9LAoKCWRlbGVnYXRlOiBmdW5jdGlvbiggc2VsZWN0b3IsIHR5cGVzLCBkYXRhLCBmbiApIHsKCQlyZXR1cm4gdGhpcy5vbiggdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiApOwoJfSwKCXVuZGVsZWdhdGU6IGZ1bmN0aW9uKCBzZWxlY3RvciwgdHlwZXMsIGZuICkgewoJCS8vICggbmFtZXNwYWNlICkgb3IgKCBzZWxlY3RvciwgdHlwZXMgWywgZm5dICkKCQlyZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA9PT0gMSA/IHRoaXMub2ZmKCBzZWxlY3RvciwgIioqIiApIDogdGhpcy5vZmYoIHR5cGVzLCBzZWxlY3RvciB8fCAiKioiLCBmbiApOwoJfQp9KTsKCgp2YXIgbm9uY2UgPSBqUXVlcnkubm93KCk7Cgp2YXIgcnF1ZXJ5ID0gKC9cPy8pOwoKCgp2YXIgcnZhbGlkdG9rZW5zID0gLygsKXwoXFt8eyl8KH18XSl8Iig/OlteIlxcXHJcbl18XFxbIlxcXC9iZm5ydF18XFx1W1xkYS1mQS1GXXs0fSkqIlxzKjo/fHRydWV8ZmFsc2V8bnVsbHwtPyg/ITBcZClcZCsoPzpcLlxkK3wpKD86W2VFXVsrLV0/XGQrfCkvZzsKCmpRdWVyeS5wYXJzZUpTT04gPSBmdW5jdGlvbiggZGF0YSApIHsKCS8vIEF0dGVtcHQgdG8gcGFyc2UgdXNpbmcgdGhlIG5hdGl2ZSBKU09OIHBhcnNlciBmaXJzdAoJaWYgKCB3aW5kb3cuSlNPTiAmJiB3aW5kb3cuSlNPTi5wYXJzZSApIHsKCQkvLyBTdXBwb3J0OiBBbmRyb2lkIDIuMwoJCS8vIFdvcmthcm91bmQgZmFpbHVyZSB0byBzdHJpbmctY2FzdCBudWxsIGlucHV0CgkJcmV0dXJuIHdpbmRvdy5KU09OLnBhcnNlKCBkYXRhICsgIiIgKTsKCX0KCgl2YXIgcmVxdWlyZU5vbkNvbW1hLAoJCWRlcHRoID0gbnVsbCwKCQlzdHIgPSBqUXVlcnkudHJpbSggZGF0YSArICIiICk7CgoJLy8gR3VhcmQgYWdhaW5zdCBpbnZhbGlkIChhbmQgcG9zc2libHkgZGFuZ2Vyb3VzKSBpbnB1dCBieSBlbnN1cmluZyB0aGF0IG5vdGhpbmcgcmVtYWlucwoJLy8gYWZ0ZXIgcmVtb3ZpbmcgdmFsaWQgdG9rZW5zCglyZXR1cm4gc3RyICYmICFqUXVlcnkudHJpbSggc3RyLnJlcGxhY2UoIHJ2YWxpZHRva2VucywgZnVuY3Rpb24oIHRva2VuLCBjb21tYSwgb3BlbiwgY2xvc2UgKSB7CgoJCS8vIEZvcmNlIHRlcm1pbmF0aW9uIGlmIHdlIHNlZSBhIG1pc3BsYWNlZCBjb21tYQoJCWlmICggcmVxdWlyZU5vbkNvbW1hICYmIGNvbW1hICkgewoJCQlkZXB0aCA9IDA7CgkJfQoKCQkvLyBQZXJmb3JtIG5vIG1vcmUgcmVwbGFjZW1lbnRzIGFmdGVyIHJldHVybmluZyB0byBvdXRlcm1vc3QgZGVwdGgKCQlpZiAoIGRlcHRoID09PSAwICkgewoJCQlyZXR1cm4gdG9rZW47CgkJfQoKCQkvLyBDb21tYXMgbXVzdCBub3QgZm9sbG93ICJbIiwgInsiLCBvciAiLCIKCQlyZXF1aXJlTm9uQ29tbWEgPSBvcGVuIHx8IGNvbW1hOwoKCQkvLyBEZXRlcm1pbmUgbmV3IGRlcHRoCgkJLy8gYXJyYXkvb2JqZWN0IG9wZW4gKCJbIiBvciAieyIpOiBkZXB0aCArPSB0cnVlIC0gZmFsc2UgKGluY3JlbWVudCkKCQkvLyBhcnJheS9vYmplY3QgY2xvc2UgKCJdIiBvciAifSIpOiBkZXB0aCArPSBmYWxzZSAtIHRydWUgKGRlY3JlbWVudCkKCQkvLyBvdGhlciBjYXNlcyAoIiwiIG9yIHByaW1pdGl2ZSk6IGRlcHRoICs9IHRydWUgLSB0cnVlIChudW1lcmljIGNhc3QpCgkJZGVwdGggKz0gIWNsb3NlIC0gIW9wZW47CgoJCS8vIFJlbW92ZSB0aGlzIHRva2VuCgkJcmV0dXJuICIiOwoJfSkgKSA/CgkJKCBGdW5jdGlvbiggInJldHVybiAiICsgc3RyICkgKSgpIDoKCQlqUXVlcnkuZXJyb3IoICJJbnZhbGlkIEpTT046ICIgKyBkYXRhICk7Cn07CgoKLy8gQ3Jvc3MtYnJvd3NlciB4bWwgcGFyc2luZwpqUXVlcnkucGFyc2VYTUwgPSBmdW5jdGlvbiggZGF0YSApIHsKCXZhciB4bWwsIHRtcDsKCWlmICggIWRhdGEgfHwgdHlwZW9mIGRhdGEgIT09ICJzdHJpbmciICkgewoJCXJldHVybiBudWxsOwoJfQoJdHJ5IHsKCQlpZiAoIHdpbmRvdy5ET01QYXJzZXIgKSB7IC8vIFN0YW5kYXJkCgkJCXRtcCA9IG5ldyBET01QYXJzZXIoKTsKCQkJeG1sID0gdG1wLnBhcnNlRnJvbVN0cmluZyggZGF0YSwgInRleHQveG1sIiApOwoJCX0gZWxzZSB7IC8vIElFCgkJCXhtbCA9IG5ldyBBY3RpdmVYT2JqZWN0KCAiTWljcm9zb2Z0LlhNTERPTSIgKTsKCQkJeG1sLmFzeW5jID0gImZhbHNlIjsKCQkJeG1sLmxvYWRYTUwoIGRhdGEgKTsKCQl9Cgl9IGNhdGNoKCBlICkgewoJCXhtbCA9IHVuZGVmaW5lZDsKCX0KCWlmICggIXhtbCB8fCAheG1sLmRvY3VtZW50RWxlbWVudCB8fCB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoICJwYXJzZXJlcnJvciIgKS5sZW5ndGggKSB7CgkJalF1ZXJ5LmVycm9yKCAiSW52YWxpZCBYTUw6ICIgKyBkYXRhICk7Cgl9CglyZXR1cm4geG1sOwp9OwoKCnZhcgoJLy8gRG9jdW1lbnQgbG9jYXRpb24KCWFqYXhMb2NQYXJ0cywKCWFqYXhMb2NhdGlvbiwKCglyaGFzaCA9IC8jLiokLywKCXJ0cyA9IC8oWz8mXSlfPVteJl0qLywKCXJoZWFkZXJzID0gL14oLio/KTpbIFx0XSooW15cclxuXSopXHI/JC9tZywgLy8gSUUgbGVhdmVzIGFuIFxyIGNoYXJhY3RlciBhdCBFT0wKCS8vICM3NjUzLCAjODEyNSwgIzgxNTI6IGxvY2FsIHByb3RvY29sIGRldGVjdGlvbgoJcmxvY2FsUHJvdG9jb2wgPSAvXig/OmFib3V0fGFwcHxhcHAtc3RvcmFnZXwuKy1leHRlbnNpb258ZmlsZXxyZXN8d2lkZ2V0KTokLywKCXJub0NvbnRlbnQgPSAvXig/OkdFVHxIRUFEKSQvLAoJcnByb3RvY29sID0gL15cL1wvLywKCXJ1cmwgPSAvXihbXHcuKy1dKzopKD86XC9cLyg/OlteXC8/I10qQHwpKFteXC8/IzpdKikoPzo6KFxkKyl8KXwpLywKCgkvKiBQcmVmaWx0ZXJzCgkgKiAxKSBUaGV5IGFyZSB1c2VmdWwgdG8gaW50cm9kdWNlIGN1c3RvbSBkYXRhVHlwZXMgKHNlZSBhamF4L2pzb25wLmpzIGZvciBhbiBleGFtcGxlKQoJICogMikgVGhlc2UgYXJlIGNhbGxlZDoKCSAqICAgIC0gQkVGT1JFIGFza2luZyBmb3IgYSB0cmFuc3BvcnQKCSAqICAgIC0gQUZURVIgcGFyYW0gc2VyaWFsaXphdGlvbiAocy5kYXRhIGlzIGEgc3RyaW5nIGlmIHMucHJvY2Vzc0RhdGEgaXMgdHJ1ZSkKCSAqIDMpIGtleSBpcyB0aGUgZGF0YVR5cGUKCSAqIDQpIHRoZSBjYXRjaGFsbCBzeW1ib2wgIioiIGNhbiBiZSB1c2VkCgkgKiA1KSBleGVjdXRpb24gd2lsbCBzdGFydCB3aXRoIHRyYW5zcG9ydCBkYXRhVHlwZSBhbmQgVEhFTiBjb250aW51ZSBkb3duIHRvICIqIiBpZiBuZWVkZWQKCSAqLwoJcHJlZmlsdGVycyA9IHt9LAoKCS8qIFRyYW5zcG9ydHMgYmluZGluZ3MKCSAqIDEpIGtleSBpcyB0aGUgZGF0YVR5cGUKCSAqIDIpIHRoZSBjYXRjaGFsbCBzeW1ib2wgIioiIGNhbiBiZSB1c2VkCgkgKiAzKSBzZWxlY3Rpb24gd2lsbCBzdGFydCB3aXRoIHRyYW5zcG9ydCBkYXRhVHlwZSBhbmQgVEhFTiBnbyB0byAiKiIgaWYgbmVlZGVkCgkgKi8KCXRyYW5zcG9ydHMgPSB7fSwKCgkvLyBBdm9pZCBjb21tZW50LXByb2xvZyBjaGFyIHNlcXVlbmNlICgjMTAwOTgpOyBtdXN0IGFwcGVhc2UgbGludCBhbmQgZXZhZGUgY29tcHJlc3Npb24KCWFsbFR5cGVzID0gIiovIi5jb25jYXQoIioiKTsKCi8vICM4MTM4LCBJRSBtYXkgdGhyb3cgYW4gZXhjZXB0aW9uIHdoZW4gYWNjZXNzaW5nCi8vIGEgZmllbGQgZnJvbSB3aW5kb3cubG9jYXRpb24gaWYgZG9jdW1lbnQuZG9tYWluIGhhcyBiZWVuIHNldAp0cnkgewoJYWpheExvY2F0aW9uID0gbG9jYXRpb24uaHJlZjsKfSBjYXRjaCggZSApIHsKCS8vIFVzZSB0aGUgaHJlZiBhdHRyaWJ1dGUgb2YgYW4gQSBlbGVtZW50CgkvLyBzaW5jZSBJRSB3aWxsIG1vZGlmeSBpdCBnaXZlbiBkb2N1bWVudC5sb2NhdGlvbgoJYWpheExvY2F0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICk7CglhamF4TG9jYXRpb24uaHJlZiA9ICIiOwoJYWpheExvY2F0aW9uID0gYWpheExvY2F0aW9uLmhyZWY7Cn0KCi8vIFNlZ21lbnQgbG9jYXRpb24gaW50byBwYXJ0cwphamF4TG9jUGFydHMgPSBydXJsLmV4ZWMoIGFqYXhMb2NhdGlvbi50b0xvd2VyQ2FzZSgpICkgfHwgW107CgovLyBCYXNlICJjb25zdHJ1Y3RvciIgZm9yIGpRdWVyeS5hamF4UHJlZmlsdGVyIGFuZCBqUXVlcnkuYWpheFRyYW5zcG9ydApmdW5jdGlvbiBhZGRUb1ByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHN0cnVjdHVyZSApIHsKCgkvLyBkYXRhVHlwZUV4cHJlc3Npb24gaXMgb3B0aW9uYWwgYW5kIGRlZmF1bHRzIHRvICIqIgoJcmV0dXJuIGZ1bmN0aW9uKCBkYXRhVHlwZUV4cHJlc3Npb24sIGZ1bmMgKSB7CgoJCWlmICggdHlwZW9mIGRhdGFUeXBlRXhwcmVzc2lvbiAhPT0gInN0cmluZyIgKSB7CgkJCWZ1bmMgPSBkYXRhVHlwZUV4cHJlc3Npb247CgkJCWRhdGFUeXBlRXhwcmVzc2lvbiA9ICIqIjsKCQl9CgoJCXZhciBkYXRhVHlwZSwKCQkJaSA9IDAsCgkJCWRhdGFUeXBlcyA9IGRhdGFUeXBlRXhwcmVzc2lvbi50b0xvd2VyQ2FzZSgpLm1hdGNoKCBybm90d2hpdGUgKSB8fCBbXTsKCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggZnVuYyApICkgewoJCQkvLyBGb3IgZWFjaCBkYXRhVHlwZSBpbiB0aGUgZGF0YVR5cGVFeHByZXNzaW9uCgkJCXdoaWxlICggKGRhdGFUeXBlID0gZGF0YVR5cGVzW2krK10pICkgewoJCQkJLy8gUHJlcGVuZCBpZiByZXF1ZXN0ZWQKCQkJCWlmICggZGF0YVR5cGUuY2hhckF0KCAwICkgPT09ICIrIiApIHsKCQkJCQlkYXRhVHlwZSA9IGRhdGFUeXBlLnNsaWNlKCAxICkgfHwgIioiOwoJCQkJCShzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gPSBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gfHwgW10pLnVuc2hpZnQoIGZ1bmMgKTsKCgkJCQkvLyBPdGhlcndpc2UgYXBwZW5kCgkJCQl9IGVsc2UgewoJCQkJCShzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gPSBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gfHwgW10pLnB1c2goIGZ1bmMgKTsKCQkJCX0KCQkJfQoJCX0KCX07Cn0KCi8vIEJhc2UgaW5zcGVjdGlvbiBmdW5jdGlvbiBmb3IgcHJlZmlsdGVycyBhbmQgdHJhbnNwb3J0cwpmdW5jdGlvbiBpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cyggc3RydWN0dXJlLCBvcHRpb25zLCBvcmlnaW5hbE9wdGlvbnMsIGpxWEhSICkgewoKCXZhciBpbnNwZWN0ZWQgPSB7fSwKCQlzZWVraW5nVHJhbnNwb3J0ID0gKCBzdHJ1Y3R1cmUgPT09IHRyYW5zcG9ydHMgKTsKCglmdW5jdGlvbiBpbnNwZWN0KCBkYXRhVHlwZSApIHsKCQl2YXIgc2VsZWN0ZWQ7CgkJaW5zcGVjdGVkWyBkYXRhVHlwZSBdID0gdHJ1ZTsKCQlqUXVlcnkuZWFjaCggc3RydWN0dXJlWyBkYXRhVHlwZSBdIHx8IFtdLCBmdW5jdGlvbiggXywgcHJlZmlsdGVyT3JGYWN0b3J5ICkgewoJCQl2YXIgZGF0YVR5cGVPclRyYW5zcG9ydCA9IHByZWZpbHRlck9yRmFjdG9yeSggb3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUiApOwoJCQlpZiAoIHR5cGVvZiBkYXRhVHlwZU9yVHJhbnNwb3J0ID09PSAic3RyaW5nIiAmJiAhc2Vla2luZ1RyYW5zcG9ydCAmJiAhaW5zcGVjdGVkWyBkYXRhVHlwZU9yVHJhbnNwb3J0IF0gKSB7CgkJCQlvcHRpb25zLmRhdGFUeXBlcy51bnNoaWZ0KCBkYXRhVHlwZU9yVHJhbnNwb3J0ICk7CgkJCQlpbnNwZWN0KCBkYXRhVHlwZU9yVHJhbnNwb3J0ICk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gZWxzZSBpZiAoIHNlZWtpbmdUcmFuc3BvcnQgKSB7CgkJCQlyZXR1cm4gISggc2VsZWN0ZWQgPSBkYXRhVHlwZU9yVHJhbnNwb3J0ICk7CgkJCX0KCQl9KTsKCQlyZXR1cm4gc2VsZWN0ZWQ7Cgl9CgoJcmV0dXJuIGluc3BlY3QoIG9wdGlvbnMuZGF0YVR5cGVzWyAwIF0gKSB8fCAhaW5zcGVjdGVkWyAiKiIgXSAmJiBpbnNwZWN0KCAiKiIgKTsKfQoKLy8gQSBzcGVjaWFsIGV4dGVuZCBmb3IgYWpheCBvcHRpb25zCi8vIHRoYXQgdGFrZXMgImZsYXQiIG9wdGlvbnMgKG5vdCB0byBiZSBkZWVwIGV4dGVuZGVkKQovLyBGaXhlcyAjOTg4NwpmdW5jdGlvbiBhamF4RXh0ZW5kKCB0YXJnZXQsIHNyYyApIHsKCXZhciBkZWVwLCBrZXksCgkJZmxhdE9wdGlvbnMgPSBqUXVlcnkuYWpheFNldHRpbmdzLmZsYXRPcHRpb25zIHx8IHt9OwoKCWZvciAoIGtleSBpbiBzcmMgKSB7CgkJaWYgKCBzcmNbIGtleSBdICE9PSB1bmRlZmluZWQgKSB7CgkJCSggZmxhdE9wdGlvbnNbIGtleSBdID8gdGFyZ2V0IDogKCBkZWVwIHx8IChkZWVwID0ge30pICkgKVsga2V5IF0gPSBzcmNbIGtleSBdOwoJCX0KCX0KCWlmICggZGVlcCApIHsKCQlqUXVlcnkuZXh0ZW5kKCB0cnVlLCB0YXJnZXQsIGRlZXAgKTsKCX0KCglyZXR1cm4gdGFyZ2V0Owp9CgovKiBIYW5kbGVzIHJlc3BvbnNlcyB0byBhbiBhamF4IHJlcXVlc3Q6CiAqIC0gZmluZHMgdGhlIHJpZ2h0IGRhdGFUeXBlIChtZWRpYXRlcyBiZXR3ZWVuIGNvbnRlbnQtdHlwZSBhbmQgZXhwZWN0ZWQgZGF0YVR5cGUpCiAqIC0gcmV0dXJucyB0aGUgY29ycmVzcG9uZGluZyByZXNwb25zZQogKi8KZnVuY3Rpb24gYWpheEhhbmRsZVJlc3BvbnNlcyggcywganFYSFIsIHJlc3BvbnNlcyApIHsKCXZhciBmaXJzdERhdGFUeXBlLCBjdCwgZmluYWxEYXRhVHlwZSwgdHlwZSwKCQljb250ZW50cyA9IHMuY29udGVudHMsCgkJZGF0YVR5cGVzID0gcy5kYXRhVHlwZXM7CgoJLy8gUmVtb3ZlIGF1dG8gZGF0YVR5cGUgYW5kIGdldCBjb250ZW50LXR5cGUgaW4gdGhlIHByb2Nlc3MKCXdoaWxlICggZGF0YVR5cGVzWyAwIF0gPT09ICIqIiApIHsKCQlkYXRhVHlwZXMuc2hpZnQoKTsKCQlpZiAoIGN0ID09PSB1bmRlZmluZWQgKSB7CgkJCWN0ID0gcy5taW1lVHlwZSB8fCBqcVhIUi5nZXRSZXNwb25zZUhlYWRlcigiQ29udGVudC1UeXBlIik7CgkJfQoJfQoKCS8vIENoZWNrIGlmIHdlJ3JlIGRlYWxpbmcgd2l0aCBhIGtub3duIGNvbnRlbnQtdHlwZQoJaWYgKCBjdCApIHsKCQlmb3IgKCB0eXBlIGluIGNvbnRlbnRzICkgewoJCQlpZiAoIGNvbnRlbnRzWyB0eXBlIF0gJiYgY29udGVudHNbIHR5cGUgXS50ZXN0KCBjdCApICkgewoJCQkJZGF0YVR5cGVzLnVuc2hpZnQoIHR5cGUgKTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJfQoKCS8vIENoZWNrIHRvIHNlZSBpZiB3ZSBoYXZlIGEgcmVzcG9uc2UgZm9yIHRoZSBleHBlY3RlZCBkYXRhVHlwZQoJaWYgKCBkYXRhVHlwZXNbIDAgXSBpbiByZXNwb25zZXMgKSB7CgkJZmluYWxEYXRhVHlwZSA9IGRhdGFUeXBlc1sgMCBdOwoJfSBlbHNlIHsKCQkvLyBUcnkgY29udmVydGlibGUgZGF0YVR5cGVzCgkJZm9yICggdHlwZSBpbiByZXNwb25zZXMgKSB7CgkJCWlmICggIWRhdGFUeXBlc1sgMCBdIHx8IHMuY29udmVydGVyc1sgdHlwZSArICIgIiArIGRhdGFUeXBlc1swXSBdICkgewoJCQkJZmluYWxEYXRhVHlwZSA9IHR5cGU7CgkJCQlicmVhazsKCQkJfQoJCQlpZiAoICFmaXJzdERhdGFUeXBlICkgewoJCQkJZmlyc3REYXRhVHlwZSA9IHR5cGU7CgkJCX0KCQl9CgkJLy8gT3IganVzdCB1c2UgZmlyc3Qgb25lCgkJZmluYWxEYXRhVHlwZSA9IGZpbmFsRGF0YVR5cGUgfHwgZmlyc3REYXRhVHlwZTsKCX0KCgkvLyBJZiB3ZSBmb3VuZCBhIGRhdGFUeXBlCgkvLyBXZSBhZGQgdGhlIGRhdGFUeXBlIHRvIHRoZSBsaXN0IGlmIG5lZWRlZAoJLy8gYW5kIHJldHVybiB0aGUgY29ycmVzcG9uZGluZyByZXNwb25zZQoJaWYgKCBmaW5hbERhdGFUeXBlICkgewoJCWlmICggZmluYWxEYXRhVHlwZSAhPT0gZGF0YVR5cGVzWyAwIF0gKSB7CgkJCWRhdGFUeXBlcy51bnNoaWZ0KCBmaW5hbERhdGFUeXBlICk7CgkJfQoJCXJldHVybiByZXNwb25zZXNbIGZpbmFsRGF0YVR5cGUgXTsKCX0KfQoKLyogQ2hhaW4gY29udmVyc2lvbnMgZ2l2ZW4gdGhlIHJlcXVlc3QgYW5kIHRoZSBvcmlnaW5hbCByZXNwb25zZQogKiBBbHNvIHNldHMgdGhlIHJlc3BvbnNlWFhYIGZpZWxkcyBvbiB0aGUganFYSFIgaW5zdGFuY2UKICovCmZ1bmN0aW9uIGFqYXhDb252ZXJ0KCBzLCByZXNwb25zZSwganFYSFIsIGlzU3VjY2VzcyApIHsKCXZhciBjb252MiwgY3VycmVudCwgY29udiwgdG1wLCBwcmV2LAoJCWNvbnZlcnRlcnMgPSB7fSwKCQkvLyBXb3JrIHdpdGggYSBjb3B5IG9mIGRhdGFUeXBlcyBpbiBjYXNlIHdlIG5lZWQgdG8gbW9kaWZ5IGl0IGZvciBjb252ZXJzaW9uCgkJZGF0YVR5cGVzID0gcy5kYXRhVHlwZXMuc2xpY2UoKTsKCgkvLyBDcmVhdGUgY29udmVydGVycyBtYXAgd2l0aCBsb3dlcmNhc2VkIGtleXMKCWlmICggZGF0YVR5cGVzWyAxIF0gKSB7CgkJZm9yICggY29udiBpbiBzLmNvbnZlcnRlcnMgKSB7CgkJCWNvbnZlcnRlcnNbIGNvbnYudG9Mb3dlckNhc2UoKSBdID0gcy5jb252ZXJ0ZXJzWyBjb252IF07CgkJfQoJfQoKCWN1cnJlbnQgPSBkYXRhVHlwZXMuc2hpZnQoKTsKCgkvLyBDb252ZXJ0IHRvIGVhY2ggc2VxdWVudGlhbCBkYXRhVHlwZQoJd2hpbGUgKCBjdXJyZW50ICkgewoKCQlpZiAoIHMucmVzcG9uc2VGaWVsZHNbIGN1cnJlbnQgXSApIHsKCQkJanFYSFJbIHMucmVzcG9uc2VGaWVsZHNbIGN1cnJlbnQgXSBdID0gcmVzcG9uc2U7CgkJfQoKCQkvLyBBcHBseSB0aGUgZGF0YUZpbHRlciBpZiBwcm92aWRlZAoJCWlmICggIXByZXYgJiYgaXNTdWNjZXNzICYmIHMuZGF0YUZpbHRlciApIHsKCQkJcmVzcG9uc2UgPSBzLmRhdGFGaWx0ZXIoIHJlc3BvbnNlLCBzLmRhdGFUeXBlICk7CgkJfQoKCQlwcmV2ID0gY3VycmVudDsKCQljdXJyZW50ID0gZGF0YVR5cGVzLnNoaWZ0KCk7CgoJCWlmICggY3VycmVudCApIHsKCgkJCS8vIFRoZXJlJ3Mgb25seSB3b3JrIHRvIGRvIGlmIGN1cnJlbnQgZGF0YVR5cGUgaXMgbm9uLWF1dG8KCQkJaWYgKCBjdXJyZW50ID09PSAiKiIgKSB7CgoJCQkJY3VycmVudCA9IHByZXY7CgoJCQkvLyBDb252ZXJ0IHJlc3BvbnNlIGlmIHByZXYgZGF0YVR5cGUgaXMgbm9uLWF1dG8gYW5kIGRpZmZlcnMgZnJvbSBjdXJyZW50CgkJCX0gZWxzZSBpZiAoIHByZXYgIT09ICIqIiAmJiBwcmV2ICE9PSBjdXJyZW50ICkgewoKCQkJCS8vIFNlZWsgYSBkaXJlY3QgY29udmVydGVyCgkJCQljb252ID0gY29udmVydGVyc1sgcHJldiArICIgIiArIGN1cnJlbnQgXSB8fCBjb252ZXJ0ZXJzWyAiKiAiICsgY3VycmVudCBdOwoKCQkJCS8vIElmIG5vbmUgZm91bmQsIHNlZWsgYSBwYWlyCgkJCQlpZiAoICFjb252ICkgewoJCQkJCWZvciAoIGNvbnYyIGluIGNvbnZlcnRlcnMgKSB7CgoJCQkJCQkvLyBJZiBjb252MiBvdXRwdXRzIGN1cnJlbnQKCQkJCQkJdG1wID0gY29udjIuc3BsaXQoICIgIiApOwoJCQkJCQlpZiAoIHRtcFsgMSBdID09PSBjdXJyZW50ICkgewoKCQkJCQkJCS8vIElmIHByZXYgY2FuIGJlIGNvbnZlcnRlZCB0byBhY2NlcHRlZCBpbnB1dAoJCQkJCQkJY29udiA9IGNvbnZlcnRlcnNbIHByZXYgKyAiICIgKyB0bXBbIDAgXSBdIHx8CgkJCQkJCQkJY29udmVydGVyc1sgIiogIiArIHRtcFsgMCBdIF07CgkJCQkJCQlpZiAoIGNvbnYgKSB7CgkJCQkJCQkJLy8gQ29uZGVuc2UgZXF1aXZhbGVuY2UgY29udmVydGVycwoJCQkJCQkJCWlmICggY29udiA9PT0gdHJ1ZSApIHsKCQkJCQkJCQkJY29udiA9IGNvbnZlcnRlcnNbIGNvbnYyIF07CgoJCQkJCQkJCS8vIE90aGVyd2lzZSwgaW5zZXJ0IHRoZSBpbnRlcm1lZGlhdGUgZGF0YVR5cGUKCQkJCQkJCQl9IGVsc2UgaWYgKCBjb252ZXJ0ZXJzWyBjb252MiBdICE9PSB0cnVlICkgewoJCQkJCQkJCQljdXJyZW50ID0gdG1wWyAwIF07CgkJCQkJCQkJCWRhdGFUeXBlcy51bnNoaWZ0KCB0bXBbIDEgXSApOwoJCQkJCQkJCX0KCQkJCQkJCQlicmVhazsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0KCgkJCQkvLyBBcHBseSBjb252ZXJ0ZXIgKGlmIG5vdCBhbiBlcXVpdmFsZW5jZSkKCQkJCWlmICggY29udiAhPT0gdHJ1ZSApIHsKCgkJCQkJLy8gVW5sZXNzIGVycm9ycyBhcmUgYWxsb3dlZCB0byBidWJibGUsIGNhdGNoIGFuZCByZXR1cm4gdGhlbQoJCQkJCWlmICggY29udiAmJiBzWyAidGhyb3dzIiBdICkgewoJCQkJCQlyZXNwb25zZSA9IGNvbnYoIHJlc3BvbnNlICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdHJ5IHsKCQkJCQkJCXJlc3BvbnNlID0gY29udiggcmVzcG9uc2UgKTsKCQkJCQkJfSBjYXRjaCAoIGUgKSB7CgkJCQkJCQlyZXR1cm4geyBzdGF0ZTogInBhcnNlcmVycm9yIiwgZXJyb3I6IGNvbnYgPyBlIDogIk5vIGNvbnZlcnNpb24gZnJvbSAiICsgcHJldiArICIgdG8gIiArIGN1cnJlbnQgfTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCX0KCglyZXR1cm4geyBzdGF0ZTogInN1Y2Nlc3MiLCBkYXRhOiByZXNwb25zZSB9Owp9CgpqUXVlcnkuZXh0ZW5kKHsKCgkvLyBDb3VudGVyIGZvciBob2xkaW5nIHRoZSBudW1iZXIgb2YgYWN0aXZlIHF1ZXJpZXMKCWFjdGl2ZTogMCwKCgkvLyBMYXN0LU1vZGlmaWVkIGhlYWRlciBjYWNoZSBmb3IgbmV4dCByZXF1ZXN0CglsYXN0TW9kaWZpZWQ6IHt9LAoJZXRhZzoge30sCgoJYWpheFNldHRpbmdzOiB7CgkJdXJsOiBhamF4TG9jYXRpb24sCgkJdHlwZTogIkdFVCIsCgkJaXNMb2NhbDogcmxvY2FsUHJvdG9jb2wudGVzdCggYWpheExvY1BhcnRzWyAxIF0gKSwKCQlnbG9iYWw6IHRydWUsCgkJcHJvY2Vzc0RhdGE6IHRydWUsCgkJYXN5bmM6IHRydWUsCgkJY29udGVudFR5cGU6ICJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQ7IGNoYXJzZXQ9VVRGLTgiLAoJCS8qCgkJdGltZW91dDogMCwKCQlkYXRhOiBudWxsLAoJCWRhdGFUeXBlOiBudWxsLAoJCXVzZXJuYW1lOiBudWxsLAoJCXBhc3N3b3JkOiBudWxsLAoJCWNhY2hlOiBudWxsLAoJCXRocm93czogZmFsc2UsCgkJdHJhZGl0aW9uYWw6IGZhbHNlLAoJCWhlYWRlcnM6IHt9LAoJCSovCgoJCWFjY2VwdHM6IHsKCQkJIioiOiBhbGxUeXBlcywKCQkJdGV4dDogInRleHQvcGxhaW4iLAoJCQlodG1sOiAidGV4dC9odG1sIiwKCQkJeG1sOiAiYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCIsCgkJCWpzb246ICJhcHBsaWNhdGlvbi9qc29uLCB0ZXh0L2phdmFzY3JpcHQiCgkJfSwKCgkJY29udGVudHM6IHsKCQkJeG1sOiAveG1sLywKCQkJaHRtbDogL2h0bWwvLAoJCQlqc29uOiAvanNvbi8KCQl9LAoKCQlyZXNwb25zZUZpZWxkczogewoJCQl4bWw6ICJyZXNwb25zZVhNTCIsCgkJCXRleHQ6ICJyZXNwb25zZVRleHQiLAoJCQlqc29uOiAicmVzcG9uc2VKU09OIgoJCX0sCgoJCS8vIERhdGEgY29udmVydGVycwoJCS8vIEtleXMgc2VwYXJhdGUgc291cmNlIChvciBjYXRjaGFsbCAiKiIpIGFuZCBkZXN0aW5hdGlvbiB0eXBlcyB3aXRoIGEgc2luZ2xlIHNwYWNlCgkJY29udmVydGVyczogewoKCQkJLy8gQ29udmVydCBhbnl0aGluZyB0byB0ZXh0CgkJCSIqIHRleHQiOiBTdHJpbmcsCgoJCQkvLyBUZXh0IHRvIGh0bWwgKHRydWUgPSBubyB0cmFuc2Zvcm1hdGlvbikKCQkJInRleHQgaHRtbCI6IHRydWUsCgoJCQkvLyBFdmFsdWF0ZSB0ZXh0IGFzIGEganNvbiBleHByZXNzaW9uCgkJCSJ0ZXh0IGpzb24iOiBqUXVlcnkucGFyc2VKU09OLAoKCQkJLy8gUGFyc2UgdGV4dCBhcyB4bWwKCQkJInRleHQgeG1sIjogalF1ZXJ5LnBhcnNlWE1MCgkJfSwKCgkJLy8gRm9yIG9wdGlvbnMgdGhhdCBzaG91bGRuJ3QgYmUgZGVlcCBleHRlbmRlZDoKCQkvLyB5b3UgY2FuIGFkZCB5b3VyIG93biBjdXN0b20gb3B0aW9ucyBoZXJlIGlmCgkJLy8gYW5kIHdoZW4geW91IGNyZWF0ZSBvbmUgdGhhdCBzaG91bGRuJ3QgYmUKCQkvLyBkZWVwIGV4dGVuZGVkIChzZWUgYWpheEV4dGVuZCkKCQlmbGF0T3B0aW9uczogewoJCQl1cmw6IHRydWUsCgkJCWNvbnRleHQ6IHRydWUKCQl9Cgl9LAoKCS8vIENyZWF0ZXMgYSBmdWxsIGZsZWRnZWQgc2V0dGluZ3Mgb2JqZWN0IGludG8gdGFyZ2V0CgkvLyB3aXRoIGJvdGggYWpheFNldHRpbmdzIGFuZCBzZXR0aW5ncyBmaWVsZHMuCgkvLyBJZiB0YXJnZXQgaXMgb21pdHRlZCwgd3JpdGVzIGludG8gYWpheFNldHRpbmdzLgoJYWpheFNldHVwOiBmdW5jdGlvbiggdGFyZ2V0LCBzZXR0aW5ncyApIHsKCQlyZXR1cm4gc2V0dGluZ3MgPwoKCQkJLy8gQnVpbGRpbmcgYSBzZXR0aW5ncyBvYmplY3QKCQkJYWpheEV4dGVuZCggYWpheEV4dGVuZCggdGFyZ2V0LCBqUXVlcnkuYWpheFNldHRpbmdzICksIHNldHRpbmdzICkgOgoKCQkJLy8gRXh0ZW5kaW5nIGFqYXhTZXR0aW5ncwoJCQlhamF4RXh0ZW5kKCBqUXVlcnkuYWpheFNldHRpbmdzLCB0YXJnZXQgKTsKCX0sCgoJYWpheFByZWZpbHRlcjogYWRkVG9QcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKCBwcmVmaWx0ZXJzICksCglhamF4VHJhbnNwb3J0OiBhZGRUb1ByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHRyYW5zcG9ydHMgKSwKCgkvLyBNYWluIG1ldGhvZAoJYWpheDogZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsKCgkJLy8gSWYgdXJsIGlzIGFuIG9iamVjdCwgc2ltdWxhdGUgcHJlLTEuNSBzaWduYXR1cmUKCQlpZiAoIHR5cGVvZiB1cmwgPT09ICJvYmplY3QiICkgewoJCQlvcHRpb25zID0gdXJsOwoJCQl1cmwgPSB1bmRlZmluZWQ7CgkJfQoKCQkvLyBGb3JjZSBvcHRpb25zIHRvIGJlIGFuIG9iamVjdAoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKCQl2YXIgLy8gQ3Jvc3MtZG9tYWluIGRldGVjdGlvbiB2YXJzCgkJCXBhcnRzLAoJCQkvLyBMb29wIHZhcmlhYmxlCgkJCWksCgkJCS8vIFVSTCB3aXRob3V0IGFudGktY2FjaGUgcGFyYW0KCQkJY2FjaGVVUkwsCgkJCS8vIFJlc3BvbnNlIGhlYWRlcnMgYXMgc3RyaW5nCgkJCXJlc3BvbnNlSGVhZGVyc1N0cmluZywKCQkJLy8gdGltZW91dCBoYW5kbGUKCQkJdGltZW91dFRpbWVyLAoKCQkJLy8gVG8ga25vdyBpZiBnbG9iYWwgZXZlbnRzIGFyZSB0byBiZSBkaXNwYXRjaGVkCgkJCWZpcmVHbG9iYWxzLAoKCQkJdHJhbnNwb3J0LAoJCQkvLyBSZXNwb25zZSBoZWFkZXJzCgkJCXJlc3BvbnNlSGVhZGVycywKCQkJLy8gQ3JlYXRlIHRoZSBmaW5hbCBvcHRpb25zIG9iamVjdAoJCQlzID0galF1ZXJ5LmFqYXhTZXR1cCgge30sIG9wdGlvbnMgKSwKCQkJLy8gQ2FsbGJhY2tzIGNvbnRleHQKCQkJY2FsbGJhY2tDb250ZXh0ID0gcy5jb250ZXh0IHx8IHMsCgkJCS8vIENvbnRleHQgZm9yIGdsb2JhbCBldmVudHMgaXMgY2FsbGJhY2tDb250ZXh0IGlmIGl0IGlzIGEgRE9NIG5vZGUgb3IgalF1ZXJ5IGNvbGxlY3Rpb24KCQkJZ2xvYmFsRXZlbnRDb250ZXh0ID0gcy5jb250ZXh0ICYmICggY2FsbGJhY2tDb250ZXh0Lm5vZGVUeXBlIHx8IGNhbGxiYWNrQ29udGV4dC5qcXVlcnkgKSA/CgkJCQlqUXVlcnkoIGNhbGxiYWNrQ29udGV4dCApIDoKCQkJCWpRdWVyeS5ldmVudCwKCQkJLy8gRGVmZXJyZWRzCgkJCWRlZmVycmVkID0galF1ZXJ5LkRlZmVycmVkKCksCgkJCWNvbXBsZXRlRGVmZXJyZWQgPSBqUXVlcnkuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLAoJCQkvLyBTdGF0dXMtZGVwZW5kZW50IGNhbGxiYWNrcwoJCQlzdGF0dXNDb2RlID0gcy5zdGF0dXNDb2RlIHx8IHt9LAoJCQkvLyBIZWFkZXJzICh0aGV5IGFyZSBzZW50IGFsbCBhdCBvbmNlKQoJCQlyZXF1ZXN0SGVhZGVycyA9IHt9LAoJCQlyZXF1ZXN0SGVhZGVyc05hbWVzID0ge30sCgkJCS8vIFRoZSBqcVhIUiBzdGF0ZQoJCQlzdGF0ZSA9IDAsCgkJCS8vIERlZmF1bHQgYWJvcnQgbWVzc2FnZQoJCQlzdHJBYm9ydCA9ICJjYW5jZWxlZCIsCgkJCS8vIEZha2UgeGhyCgkJCWpxWEhSID0gewoJCQkJcmVhZHlTdGF0ZTogMCwKCgkJCQkvLyBCdWlsZHMgaGVhZGVycyBoYXNodGFibGUgaWYgbmVlZGVkCgkJCQlnZXRSZXNwb25zZUhlYWRlcjogZnVuY3Rpb24oIGtleSApIHsKCQkJCQl2YXIgbWF0Y2g7CgkJCQkJaWYgKCBzdGF0ZSA9PT0gMiApIHsKCQkJCQkJaWYgKCAhcmVzcG9uc2VIZWFkZXJzICkgewoJCQkJCQkJcmVzcG9uc2VIZWFkZXJzID0ge307CgkJCQkJCQl3aGlsZSAoIChtYXRjaCA9IHJoZWFkZXJzLmV4ZWMoIHJlc3BvbnNlSGVhZGVyc1N0cmluZyApKSApIHsKCQkJCQkJCQlyZXNwb25zZUhlYWRlcnNbIG1hdGNoWzFdLnRvTG93ZXJDYXNlKCkgXSA9IG1hdGNoWyAyIF07CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJbWF0Y2ggPSByZXNwb25zZUhlYWRlcnNbIGtleS50b0xvd2VyQ2FzZSgpIF07CgkJCQkJfQoJCQkJCXJldHVybiBtYXRjaCA9PSBudWxsID8gbnVsbCA6IG1hdGNoOwoJCQkJfSwKCgkJCQkvLyBSYXcgc3RyaW5nCgkJCQlnZXRBbGxSZXNwb25zZUhlYWRlcnM6IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiBzdGF0ZSA9PT0gMiA/IHJlc3BvbnNlSGVhZGVyc1N0cmluZyA6IG51bGw7CgkJCQl9LAoKCQkJCS8vIENhY2hlcyB0aGUgaGVhZGVyCgkJCQlzZXRSZXF1ZXN0SGVhZGVyOiBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7CgkJCQkJdmFyIGxuYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwoJCQkJCWlmICggIXN0YXRlICkgewoJCQkJCQluYW1lID0gcmVxdWVzdEhlYWRlcnNOYW1lc1sgbG5hbWUgXSA9IHJlcXVlc3RIZWFkZXJzTmFtZXNbIGxuYW1lIF0gfHwgbmFtZTsKCQkJCQkJcmVxdWVzdEhlYWRlcnNbIG5hbWUgXSA9IHZhbHVlOwoJCQkJCX0KCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0sCgoJCQkJLy8gT3ZlcnJpZGVzIHJlc3BvbnNlIGNvbnRlbnQtdHlwZSBoZWFkZXIKCQkJCW92ZXJyaWRlTWltZVR5cGU6IGZ1bmN0aW9uKCB0eXBlICkgewoJCQkJCWlmICggIXN0YXRlICkgewoJCQkJCQlzLm1pbWVUeXBlID0gdHlwZTsKCQkJCQl9CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9LAoKCQkJCS8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzCgkJCQlzdGF0dXNDb2RlOiBmdW5jdGlvbiggbWFwICkgewoJCQkJCXZhciBjb2RlOwoJCQkJCWlmICggbWFwICkgewoJCQkJCQlpZiAoIHN0YXRlIDwgMiApIHsKCQkJCQkJCWZvciAoIGNvZGUgaW4gbWFwICkgewoJCQkJCQkJCS8vIExhenktYWRkIHRoZSBuZXcgY2FsbGJhY2sgaW4gYSB3YXkgdGhhdCBwcmVzZXJ2ZXMgb2xkIG9uZXMKCQkJCQkJCQlzdGF0dXNDb2RlWyBjb2RlIF0gPSBbIHN0YXR1c0NvZGVbIGNvZGUgXSwgbWFwWyBjb2RlIF0gXTsKCQkJCQkJCX0KCQkJCQkJfSBlbHNlIHsKCQkJCQkJCS8vIEV4ZWN1dGUgdGhlIGFwcHJvcHJpYXRlIGNhbGxiYWNrcwoJCQkJCQkJanFYSFIuYWx3YXlzKCBtYXBbIGpxWEhSLnN0YXR1cyBdICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9LAoKCQkJCS8vIENhbmNlbCB0aGUgcmVxdWVzdAoJCQkJYWJvcnQ6IGZ1bmN0aW9uKCBzdGF0dXNUZXh0ICkgewoJCQkJCXZhciBmaW5hbFRleHQgPSBzdGF0dXNUZXh0IHx8IHN0ckFib3J0OwoJCQkJCWlmICggdHJhbnNwb3J0ICkgewoJCQkJCQl0cmFuc3BvcnQuYWJvcnQoIGZpbmFsVGV4dCApOwoJCQkJCX0KCQkJCQlkb25lKCAwLCBmaW5hbFRleHQgKTsKCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0KCQkJfTsKCgkJLy8gQXR0YWNoIGRlZmVycmVkcwoJCWRlZmVycmVkLnByb21pc2UoIGpxWEhSICkuY29tcGxldGUgPSBjb21wbGV0ZURlZmVycmVkLmFkZDsKCQlqcVhIUi5zdWNjZXNzID0ganFYSFIuZG9uZTsKCQlqcVhIUi5lcnJvciA9IGpxWEhSLmZhaWw7CgoJCS8vIFJlbW92ZSBoYXNoIGNoYXJhY3RlciAoIzc1MzE6IGFuZCBzdHJpbmcgcHJvbW90aW9uKQoJCS8vIEFkZCBwcm90b2NvbCBpZiBub3QgcHJvdmlkZWQgKCM1ODY2OiBJRTcgaXNzdWUgd2l0aCBwcm90b2NvbC1sZXNzIHVybHMpCgkJLy8gSGFuZGxlIGZhbHN5IHVybCBpbiB0aGUgc2V0dGluZ3Mgb2JqZWN0ICgjMTAwOTM6IGNvbnNpc3RlbmN5IHdpdGggb2xkIHNpZ25hdHVyZSkKCQkvLyBXZSBhbHNvIHVzZSB0aGUgdXJsIHBhcmFtZXRlciBpZiBhdmFpbGFibGUKCQlzLnVybCA9ICggKCB1cmwgfHwgcy51cmwgfHwgYWpheExvY2F0aW9uICkgKyAiIiApLnJlcGxhY2UoIHJoYXNoLCAiIiApLnJlcGxhY2UoIHJwcm90b2NvbCwgYWpheExvY1BhcnRzWyAxIF0gKyAiLy8iICk7CgoJCS8vIEFsaWFzIG1ldGhvZCBvcHRpb24gdG8gdHlwZSBhcyBwZXIgdGlja2V0ICMxMjAwNAoJCXMudHlwZSA9IG9wdGlvbnMubWV0aG9kIHx8IG9wdGlvbnMudHlwZSB8fCBzLm1ldGhvZCB8fCBzLnR5cGU7CgoJCS8vIEV4dHJhY3QgZGF0YVR5cGVzIGxpc3QKCQlzLmRhdGFUeXBlcyA9IGpRdWVyeS50cmltKCBzLmRhdGFUeXBlIHx8ICIqIiApLnRvTG93ZXJDYXNlKCkubWF0Y2goIHJub3R3aGl0ZSApIHx8IFsgIiIgXTsKCgkJLy8gQSBjcm9zcy1kb21haW4gcmVxdWVzdCBpcyBpbiBvcmRlciB3aGVuIHdlIGhhdmUgYSBwcm90b2NvbDpob3N0OnBvcnQgbWlzbWF0Y2gKCQlpZiAoIHMuY3Jvc3NEb21haW4gPT0gbnVsbCApIHsKCQkJcGFydHMgPSBydXJsLmV4ZWMoIHMudXJsLnRvTG93ZXJDYXNlKCkgKTsKCQkJcy5jcm9zc0RvbWFpbiA9ICEhKCBwYXJ0cyAmJgoJCQkJKCBwYXJ0c1sgMSBdICE9PSBhamF4TG9jUGFydHNbIDEgXSB8fCBwYXJ0c1sgMiBdICE9PSBhamF4TG9jUGFydHNbIDIgXSB8fAoJCQkJCSggcGFydHNbIDMgXSB8fCAoIHBhcnRzWyAxIF0gPT09ICJodHRwOiIgPyAiODAiIDogIjQ0MyIgKSApICE9PQoJCQkJCQkoIGFqYXhMb2NQYXJ0c1sgMyBdIHx8ICggYWpheExvY1BhcnRzWyAxIF0gPT09ICJodHRwOiIgPyAiODAiIDogIjQ0MyIgKSApICkKCQkJKTsKCQl9CgoJCS8vIENvbnZlcnQgZGF0YSBpZiBub3QgYWxyZWFkeSBhIHN0cmluZwoJCWlmICggcy5kYXRhICYmIHMucHJvY2Vzc0RhdGEgJiYgdHlwZW9mIHMuZGF0YSAhPT0gInN0cmluZyIgKSB7CgkJCXMuZGF0YSA9IGpRdWVyeS5wYXJhbSggcy5kYXRhLCBzLnRyYWRpdGlvbmFsICk7CgkJfQoKCQkvLyBBcHBseSBwcmVmaWx0ZXJzCgkJaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHByZWZpbHRlcnMsIHMsIG9wdGlvbnMsIGpxWEhSICk7CgoJCS8vIElmIHJlcXVlc3Qgd2FzIGFib3J0ZWQgaW5zaWRlIGEgcHJlZmlsdGVyLCBzdG9wIHRoZXJlCgkJaWYgKCBzdGF0ZSA9PT0gMiApIHsKCQkJcmV0dXJuIGpxWEhSOwoJCX0KCgkJLy8gV2UgY2FuIGZpcmUgZ2xvYmFsIGV2ZW50cyBhcyBvZiBub3cgaWYgYXNrZWQgdG8KCQlmaXJlR2xvYmFscyA9IHMuZ2xvYmFsOwoKCQkvLyBXYXRjaCBmb3IgYSBuZXcgc2V0IG9mIHJlcXVlc3RzCgkJaWYgKCBmaXJlR2xvYmFscyAmJiBqUXVlcnkuYWN0aXZlKysgPT09IDAgKSB7CgkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCJhamF4U3RhcnQiKTsKCQl9CgoJCS8vIFVwcGVyY2FzZSB0aGUgdHlwZQoJCXMudHlwZSA9IHMudHlwZS50b1VwcGVyQ2FzZSgpOwoKCQkvLyBEZXRlcm1pbmUgaWYgcmVxdWVzdCBoYXMgY29udGVudAoJCXMuaGFzQ29udGVudCA9ICFybm9Db250ZW50LnRlc3QoIHMudHlwZSApOwoKCQkvLyBTYXZlIHRoZSBVUkwgaW4gY2FzZSB3ZSdyZSB0b3lpbmcgd2l0aCB0aGUgSWYtTW9kaWZpZWQtU2luY2UKCQkvLyBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIgbGF0ZXIgb24KCQljYWNoZVVSTCA9IHMudXJsOwoKCQkvLyBNb3JlIG9wdGlvbnMgaGFuZGxpbmcgZm9yIHJlcXVlc3RzIHdpdGggbm8gY29udGVudAoJCWlmICggIXMuaGFzQ29udGVudCApIHsKCgkJCS8vIElmIGRhdGEgaXMgYXZhaWxhYmxlLCBhcHBlbmQgZGF0YSB0byB1cmwKCQkJaWYgKCBzLmRhdGEgKSB7CgkJCQljYWNoZVVSTCA9ICggcy51cmwgKz0gKCBycXVlcnkudGVzdCggY2FjaGVVUkwgKSA/ICImIiA6ICI/IiApICsgcy5kYXRhICk7CgkJCQkvLyAjOTY4MjogcmVtb3ZlIGRhdGEgc28gdGhhdCBpdCdzIG5vdCB1c2VkIGluIGFuIGV2ZW50dWFsIHJldHJ5CgkJCQlkZWxldGUgcy5kYXRhOwoJCQl9CgoJCQkvLyBBZGQgYW50aS1jYWNoZSBpbiB1cmwgaWYgbmVlZGVkCgkJCWlmICggcy5jYWNoZSA9PT0gZmFsc2UgKSB7CgkJCQlzLnVybCA9IHJ0cy50ZXN0KCBjYWNoZVVSTCApID8KCgkJCQkJLy8gSWYgdGhlcmUgaXMgYWxyZWFkeSBhICdfJyBwYXJhbWV0ZXIsIHNldCBpdHMgdmFsdWUKCQkJCQljYWNoZVVSTC5yZXBsYWNlKCBydHMsICIkMV89IiArIG5vbmNlKysgKSA6CgoJCQkJCS8vIE90aGVyd2lzZSBhZGQgb25lIHRvIHRoZSBlbmQKCQkJCQljYWNoZVVSTCArICggcnF1ZXJ5LnRlc3QoIGNhY2hlVVJMICkgPyAiJiIgOiAiPyIgKSArICJfPSIgKyBub25jZSsrOwoJCQl9CgkJfQoKCQkvLyBTZXQgdGhlIElmLU1vZGlmaWVkLVNpbmNlIGFuZC9vciBJZi1Ob25lLU1hdGNoIGhlYWRlciwgaWYgaW4gaWZNb2RpZmllZCBtb2RlLgoJCWlmICggcy5pZk1vZGlmaWVkICkgewoJCQlpZiAoIGpRdWVyeS5sYXN0TW9kaWZpZWRbIGNhY2hlVVJMIF0gKSB7CgkJCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCAiSWYtTW9kaWZpZWQtU2luY2UiLCBqUXVlcnkubGFzdE1vZGlmaWVkWyBjYWNoZVVSTCBdICk7CgkJCX0KCQkJaWYgKCBqUXVlcnkuZXRhZ1sgY2FjaGVVUkwgXSApIHsKCQkJCWpxWEhSLnNldFJlcXVlc3RIZWFkZXIoICJJZi1Ob25lLU1hdGNoIiwgalF1ZXJ5LmV0YWdbIGNhY2hlVVJMIF0gKTsKCQkJfQoJCX0KCgkJLy8gU2V0IHRoZSBjb3JyZWN0IGhlYWRlciwgaWYgZGF0YSBpcyBiZWluZyBzZW50CgkJaWYgKCBzLmRhdGEgJiYgcy5oYXNDb250ZW50ICYmIHMuY29udGVudFR5cGUgIT09IGZhbHNlIHx8IG9wdGlvbnMuY29udGVudFR5cGUgKSB7CgkJCWpxWEhSLnNldFJlcXVlc3RIZWFkZXIoICJDb250ZW50LVR5cGUiLCBzLmNvbnRlbnRUeXBlICk7CgkJfQoKCQkvLyBTZXQgdGhlIEFjY2VwdHMgaGVhZGVyIGZvciB0aGUgc2VydmVyLCBkZXBlbmRpbmcgb24gdGhlIGRhdGFUeXBlCgkJanFYSFIuc2V0UmVxdWVzdEhlYWRlcigKCQkJIkFjY2VwdCIsCgkJCXMuZGF0YVR5cGVzWyAwIF0gJiYgcy5hY2NlcHRzWyBzLmRhdGFUeXBlc1swXSBdID8KCQkJCXMuYWNjZXB0c1sgcy5kYXRhVHlwZXNbMF0gXSArICggcy5kYXRhVHlwZXNbIDAgXSAhPT0gIioiID8gIiwgIiArIGFsbFR5cGVzICsgIjsgcT0wLjAxIiA6ICIiICkgOgoJCQkJcy5hY2NlcHRzWyAiKiIgXQoJCSk7CgoJCS8vIENoZWNrIGZvciBoZWFkZXJzIG9wdGlvbgoJCWZvciAoIGkgaW4gcy5oZWFkZXJzICkgewoJCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCBpLCBzLmhlYWRlcnNbIGkgXSApOwoJCX0KCgkJLy8gQWxsb3cgY3VzdG9tIGhlYWRlcnMvbWltZXR5cGVzIGFuZCBlYXJseSBhYm9ydAoJCWlmICggcy5iZWZvcmVTZW5kICYmICggcy5iZWZvcmVTZW5kLmNhbGwoIGNhbGxiYWNrQ29udGV4dCwganFYSFIsIHMgKSA9PT0gZmFsc2UgfHwgc3RhdGUgPT09IDIgKSApIHsKCQkJLy8gQWJvcnQgaWYgbm90IGRvbmUgYWxyZWFkeSBhbmQgcmV0dXJuCgkJCXJldHVybiBqcVhIUi5hYm9ydCgpOwoJCX0KCgkJLy8gYWJvcnRpbmcgaXMgbm8gbG9uZ2VyIGEgY2FuY2VsbGF0aW9uCgkJc3RyQWJvcnQgPSAiYWJvcnQiOwoKCQkvLyBJbnN0YWxsIGNhbGxiYWNrcyBvbiBkZWZlcnJlZHMKCQlmb3IgKCBpIGluIHsgc3VjY2VzczogMSwgZXJyb3I6IDEsIGNvbXBsZXRlOiAxIH0gKSB7CgkJCWpxWEhSWyBpIF0oIHNbIGkgXSApOwoJCX0KCgkJLy8gR2V0IHRyYW5zcG9ydAoJCXRyYW5zcG9ydCA9IGluc3BlY3RQcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKCB0cmFuc3BvcnRzLCBzLCBvcHRpb25zLCBqcVhIUiApOwoKCQkvLyBJZiBubyB0cmFuc3BvcnQsIHdlIGF1dG8tYWJvcnQKCQlpZiAoICF0cmFuc3BvcnQgKSB7CgkJCWRvbmUoIC0xLCAiTm8gVHJhbnNwb3J0IiApOwoJCX0gZWxzZSB7CgkJCWpxWEhSLnJlYWR5U3RhdGUgPSAxOwoKCQkJLy8gU2VuZCBnbG9iYWwgZXZlbnQKCQkJaWYgKCBmaXJlR2xvYmFscyApIHsKCQkJCWdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCAiYWpheFNlbmQiLCBbIGpxWEhSLCBzIF0gKTsKCQkJfQoJCQkvLyBUaW1lb3V0CgkJCWlmICggcy5hc3luYyAmJiBzLnRpbWVvdXQgPiAwICkgewoJCQkJdGltZW91dFRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQlqcVhIUi5hYm9ydCgidGltZW91dCIpOwoJCQkJfSwgcy50aW1lb3V0ICk7CgkJCX0KCgkJCXRyeSB7CgkJCQlzdGF0ZSA9IDE7CgkJCQl0cmFuc3BvcnQuc2VuZCggcmVxdWVzdEhlYWRlcnMsIGRvbmUgKTsKCQkJfSBjYXRjaCAoIGUgKSB7CgkJCQkvLyBQcm9wYWdhdGUgZXhjZXB0aW9uIGFzIGVycm9yIGlmIG5vdCBkb25lCgkJCQlpZiAoIHN0YXRlIDwgMiApIHsKCQkJCQlkb25lKCAtMSwgZSApOwoJCQkJLy8gU2ltcGx5IHJldGhyb3cgb3RoZXJ3aXNlCgkJCQl9IGVsc2UgewoJCQkJCXRocm93IGU7CgkJCQl9CgkJCX0KCQl9CgoJCS8vIENhbGxiYWNrIGZvciB3aGVuIGV2ZXJ5dGhpbmcgaXMgZG9uZQoJCWZ1bmN0aW9uIGRvbmUoIHN0YXR1cywgbmF0aXZlU3RhdHVzVGV4dCwgcmVzcG9uc2VzLCBoZWFkZXJzICkgewoJCQl2YXIgaXNTdWNjZXNzLCBzdWNjZXNzLCBlcnJvciwgcmVzcG9uc2UsIG1vZGlmaWVkLAoJCQkJc3RhdHVzVGV4dCA9IG5hdGl2ZVN0YXR1c1RleHQ7CgoJCQkvLyBDYWxsZWQgb25jZQoJCQlpZiAoIHN0YXRlID09PSAyICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBTdGF0ZSBpcyAiZG9uZSIgbm93CgkJCXN0YXRlID0gMjsKCgkJCS8vIENsZWFyIHRpbWVvdXQgaWYgaXQgZXhpc3RzCgkJCWlmICggdGltZW91dFRpbWVyICkgewoJCQkJY2xlYXJUaW1lb3V0KCB0aW1lb3V0VGltZXIgKTsKCQkJfQoKCQkJLy8gRGVyZWZlcmVuY2UgdHJhbnNwb3J0IGZvciBlYXJseSBnYXJiYWdlIGNvbGxlY3Rpb24KCQkJLy8gKG5vIG1hdHRlciBob3cgbG9uZyB0aGUganFYSFIgb2JqZWN0IHdpbGwgYmUgdXNlZCkKCQkJdHJhbnNwb3J0ID0gdW5kZWZpbmVkOwoKCQkJLy8gQ2FjaGUgcmVzcG9uc2UgaGVhZGVycwoJCQlyZXNwb25zZUhlYWRlcnNTdHJpbmcgPSBoZWFkZXJzIHx8ICIiOwoKCQkJLy8gU2V0IHJlYWR5U3RhdGUKCQkJanFYSFIucmVhZHlTdGF0ZSA9IHN0YXR1cyA+IDAgPyA0IDogMDsKCgkJCS8vIERldGVybWluZSBpZiBzdWNjZXNzZnVsCgkJCWlzU3VjY2VzcyA9IHN0YXR1cyA+PSAyMDAgJiYgc3RhdHVzIDwgMzAwIHx8IHN0YXR1cyA9PT0gMzA0OwoKCQkJLy8gR2V0IHJlc3BvbnNlIGRhdGEKCQkJaWYgKCByZXNwb25zZXMgKSB7CgkJCQlyZXNwb25zZSA9IGFqYXhIYW5kbGVSZXNwb25zZXMoIHMsIGpxWEhSLCByZXNwb25zZXMgKTsKCQkJfQoKCQkJLy8gQ29udmVydCBubyBtYXR0ZXIgd2hhdCAodGhhdCB3YXkgcmVzcG9uc2VYWFggZmllbGRzIGFyZSBhbHdheXMgc2V0KQoJCQlyZXNwb25zZSA9IGFqYXhDb252ZXJ0KCBzLCByZXNwb25zZSwganFYSFIsIGlzU3VjY2VzcyApOwoKCQkJLy8gSWYgc3VjY2Vzc2Z1bCwgaGFuZGxlIHR5cGUgY2hhaW5pbmcKCQkJaWYgKCBpc1N1Y2Nlc3MgKSB7CgoJCQkJLy8gU2V0IHRoZSBJZi1Nb2RpZmllZC1TaW5jZSBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIsIGlmIGluIGlmTW9kaWZpZWQgbW9kZS4KCQkJCWlmICggcy5pZk1vZGlmaWVkICkgewoJCQkJCW1vZGlmaWVkID0ganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoIkxhc3QtTW9kaWZpZWQiKTsKCQkJCQlpZiAoIG1vZGlmaWVkICkgewoJCQkJCQlqUXVlcnkubGFzdE1vZGlmaWVkWyBjYWNoZVVSTCBdID0gbW9kaWZpZWQ7CgkJCQkJfQoJCQkJCW1vZGlmaWVkID0ganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoImV0YWciKTsKCQkJCQlpZiAoIG1vZGlmaWVkICkgewoJCQkJCQlqUXVlcnkuZXRhZ1sgY2FjaGVVUkwgXSA9IG1vZGlmaWVkOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBpZiBubyBjb250ZW50CgkJCQlpZiAoIHN0YXR1cyA9PT0gMjA0IHx8IHMudHlwZSA9PT0gIkhFQUQiICkgewoJCQkJCXN0YXR1c1RleHQgPSAibm9jb250ZW50IjsKCgkJCQkvLyBpZiBub3QgbW9kaWZpZWQKCQkJCX0gZWxzZSBpZiAoIHN0YXR1cyA9PT0gMzA0ICkgewoJCQkJCXN0YXR1c1RleHQgPSAibm90bW9kaWZpZWQiOwoKCQkJCS8vIElmIHdlIGhhdmUgZGF0YSwgbGV0J3MgY29udmVydCBpdAoJCQkJfSBlbHNlIHsKCQkJCQlzdGF0dXNUZXh0ID0gcmVzcG9uc2Uuc3RhdGU7CgkJCQkJc3VjY2VzcyA9IHJlc3BvbnNlLmRhdGE7CgkJCQkJZXJyb3IgPSByZXNwb25zZS5lcnJvcjsKCQkJCQlpc1N1Y2Nlc3MgPSAhZXJyb3I7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQkvLyBXZSBleHRyYWN0IGVycm9yIGZyb20gc3RhdHVzVGV4dAoJCQkJLy8gdGhlbiBub3JtYWxpemUgc3RhdHVzVGV4dCBhbmQgc3RhdHVzIGZvciBub24tYWJvcnRzCgkJCQllcnJvciA9IHN0YXR1c1RleHQ7CgkJCQlpZiAoIHN0YXR1cyB8fCAhc3RhdHVzVGV4dCApIHsKCQkJCQlzdGF0dXNUZXh0ID0gImVycm9yIjsKCQkJCQlpZiAoIHN0YXR1cyA8IDAgKSB7CgkJCQkJCXN0YXR1cyA9IDA7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQkvLyBTZXQgZGF0YSBmb3IgdGhlIGZha2UgeGhyIG9iamVjdAoJCQlqcVhIUi5zdGF0dXMgPSBzdGF0dXM7CgkJCWpxWEhSLnN0YXR1c1RleHQgPSAoIG5hdGl2ZVN0YXR1c1RleHQgfHwgc3RhdHVzVGV4dCApICsgIiI7CgoJCQkvLyBTdWNjZXNzL0Vycm9yCgkJCWlmICggaXNTdWNjZXNzICkgewoJCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGNhbGxiYWNrQ29udGV4dCwgWyBzdWNjZXNzLCBzdGF0dXNUZXh0LCBqcVhIUiBdICk7CgkJCX0gZWxzZSB7CgkJCQlkZWZlcnJlZC5yZWplY3RXaXRoKCBjYWxsYmFja0NvbnRleHQsIFsganFYSFIsIHN0YXR1c1RleHQsIGVycm9yIF0gKTsKCQkJfQoKCQkJLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKCQkJanFYSFIuc3RhdHVzQ29kZSggc3RhdHVzQ29kZSApOwoJCQlzdGF0dXNDb2RlID0gdW5kZWZpbmVkOwoKCQkJaWYgKCBmaXJlR2xvYmFscyApIHsKCQkJCWdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCBpc1N1Y2Nlc3MgPyAiYWpheFN1Y2Nlc3MiIDogImFqYXhFcnJvciIsCgkJCQkJWyBqcVhIUiwgcywgaXNTdWNjZXNzID8gc3VjY2VzcyA6IGVycm9yIF0gKTsKCQkJfQoKCQkJLy8gQ29tcGxldGUKCQkJY29tcGxldGVEZWZlcnJlZC5maXJlV2l0aCggY2FsbGJhY2tDb250ZXh0LCBbIGpxWEhSLCBzdGF0dXNUZXh0IF0gKTsKCgkJCWlmICggZmlyZUdsb2JhbHMgKSB7CgkJCQlnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlciggImFqYXhDb21wbGV0ZSIsIFsganFYSFIsIHMgXSApOwoJCQkJLy8gSGFuZGxlIHRoZSBnbG9iYWwgQUpBWCBjb3VudGVyCgkJCQlpZiAoICEoIC0talF1ZXJ5LmFjdGl2ZSApICkgewoJCQkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCJhamF4U3RvcCIpOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4ganFYSFI7Cgl9LAoKCWdldEpTT046IGZ1bmN0aW9uKCB1cmwsIGRhdGEsIGNhbGxiYWNrICkgewoJCXJldHVybiBqUXVlcnkuZ2V0KCB1cmwsIGRhdGEsIGNhbGxiYWNrLCAianNvbiIgKTsKCX0sCgoJZ2V0U2NyaXB0OiBmdW5jdGlvbiggdXJsLCBjYWxsYmFjayApIHsKCQlyZXR1cm4galF1ZXJ5LmdldCggdXJsLCB1bmRlZmluZWQsIGNhbGxiYWNrLCAic2NyaXB0IiApOwoJfQp9KTsKCmpRdWVyeS5lYWNoKCBbICJnZXQiLCAicG9zdCIgXSwgZnVuY3Rpb24oIGksIG1ldGhvZCApIHsKCWpRdWVyeVsgbWV0aG9kIF0gPSBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjaywgdHlwZSApIHsKCQkvLyBzaGlmdCBhcmd1bWVudHMgaWYgZGF0YSBhcmd1bWVudCB3YXMgb21pdHRlZAoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIGRhdGEgKSApIHsKCQkJdHlwZSA9IHR5cGUgfHwgY2FsbGJhY2s7CgkJCWNhbGxiYWNrID0gZGF0YTsKCQkJZGF0YSA9IHVuZGVmaW5lZDsKCQl9CgoJCXJldHVybiBqUXVlcnkuYWpheCh7CgkJCXVybDogdXJsLAoJCQl0eXBlOiBtZXRob2QsCgkJCWRhdGFUeXBlOiB0eXBlLAoJCQlkYXRhOiBkYXRhLAoJCQlzdWNjZXNzOiBjYWxsYmFjawoJCX0pOwoJfTsKfSk7CgovLyBBdHRhY2ggYSBidW5jaCBvZiBmdW5jdGlvbnMgZm9yIGhhbmRsaW5nIGNvbW1vbiBBSkFYIGV2ZW50cwpqUXVlcnkuZWFjaCggWyAiYWpheFN0YXJ0IiwgImFqYXhTdG9wIiwgImFqYXhDb21wbGV0ZSIsICJhamF4RXJyb3IiLCAiYWpheFN1Y2Nlc3MiLCAiYWpheFNlbmQiIF0sIGZ1bmN0aW9uKCBpLCB0eXBlICkgewoJalF1ZXJ5LmZuWyB0eXBlIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJcmV0dXJuIHRoaXMub24oIHR5cGUsIGZuICk7Cgl9Owp9KTsKCgpqUXVlcnkuX2V2YWxVcmwgPSBmdW5jdGlvbiggdXJsICkgewoJcmV0dXJuIGpRdWVyeS5hamF4KHsKCQl1cmw6IHVybCwKCQl0eXBlOiAiR0VUIiwKCQlkYXRhVHlwZTogInNjcmlwdCIsCgkJYXN5bmM6IGZhbHNlLAoJCWdsb2JhbDogZmFsc2UsCgkJInRocm93cyI6IHRydWUKCX0pOwp9OwoKCmpRdWVyeS5mbi5leHRlbmQoewoJd3JhcEFsbDogZnVuY3Rpb24oIGh0bWwgKSB7CgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggaHRtbCApICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGkpIHsKCQkJCWpRdWVyeSh0aGlzKS53cmFwQWxsKCBodG1sLmNhbGwodGhpcywgaSkgKTsKCQkJfSk7CgkJfQoKCQlpZiAoIHRoaXNbMF0gKSB7CgkJCS8vIFRoZSBlbGVtZW50cyB0byB3cmFwIHRoZSB0YXJnZXQgYXJvdW5kCgkJCXZhciB3cmFwID0galF1ZXJ5KCBodG1sLCB0aGlzWzBdLm93bmVyRG9jdW1lbnQgKS5lcSgwKS5jbG9uZSh0cnVlKTsKCgkJCWlmICggdGhpc1swXS5wYXJlbnROb2RlICkgewoJCQkJd3JhcC5pbnNlcnRCZWZvcmUoIHRoaXNbMF0gKTsKCQkJfQoKCQkJd3JhcC5tYXAoZnVuY3Rpb24oKSB7CgkJCQl2YXIgZWxlbSA9IHRoaXM7CgoJCQkJd2hpbGUgKCBlbGVtLmZpcnN0Q2hpbGQgJiYgZWxlbS5maXJzdENoaWxkLm5vZGVUeXBlID09PSAxICkgewoJCQkJCWVsZW0gPSBlbGVtLmZpcnN0Q2hpbGQ7CgkJCQl9CgoJCQkJcmV0dXJuIGVsZW07CgkJCX0pLmFwcGVuZCggdGhpcyApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXdyYXBJbm5lcjogZnVuY3Rpb24oIGh0bWwgKSB7CgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggaHRtbCApICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGkpIHsKCQkJCWpRdWVyeSh0aGlzKS53cmFwSW5uZXIoIGh0bWwuY2FsbCh0aGlzLCBpKSApOwoJCQl9KTsKCQl9CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0galF1ZXJ5KCB0aGlzICksCgkJCQljb250ZW50cyA9IHNlbGYuY29udGVudHMoKTsKCgkJCWlmICggY29udGVudHMubGVuZ3RoICkgewoJCQkJY29udGVudHMud3JhcEFsbCggaHRtbCApOwoKCQkJfSBlbHNlIHsKCQkJCXNlbGYuYXBwZW5kKCBodG1sICk7CgkJCX0KCQl9KTsKCX0sCgoJd3JhcDogZnVuY3Rpb24oIGh0bWwgKSB7CgkJdmFyIGlzRnVuY3Rpb24gPSBqUXVlcnkuaXNGdW5jdGlvbiggaHRtbCApOwoKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGkpIHsKCQkJalF1ZXJ5KCB0aGlzICkud3JhcEFsbCggaXNGdW5jdGlvbiA/IGh0bWwuY2FsbCh0aGlzLCBpKSA6IGh0bWwgKTsKCQl9KTsKCX0sCgoJdW53cmFwOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5wYXJlbnQoKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoICFqUXVlcnkubm9kZU5hbWUoIHRoaXMsICJib2R5IiApICkgewoJCQkJalF1ZXJ5KCB0aGlzICkucmVwbGFjZVdpdGgoIHRoaXMuY2hpbGROb2RlcyApOwoJCQl9CgkJfSkuZW5kKCk7Cgl9Cn0pOwoKCmpRdWVyeS5leHByLmZpbHRlcnMuaGlkZGVuID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkvLyBTdXBwb3J0OiBPcGVyYSA8PSAxMi4xMgoJLy8gT3BlcmEgcmVwb3J0cyBvZmZzZXRXaWR0aHMgYW5kIG9mZnNldEhlaWdodHMgbGVzcyB0aGFuIHplcm8gb24gc29tZSBlbGVtZW50cwoJcmV0dXJuIGVsZW0ub2Zmc2V0V2lkdGggPD0gMCAmJiBlbGVtLm9mZnNldEhlaWdodCA8PSAwIHx8CgkJKCFzdXBwb3J0LnJlbGlhYmxlSGlkZGVuT2Zmc2V0cygpICYmCgkJCSgoZWxlbS5zdHlsZSAmJiBlbGVtLnN0eWxlLmRpc3BsYXkpIHx8IGpRdWVyeS5jc3MoIGVsZW0sICJkaXNwbGF5IiApKSA9PT0gIm5vbmUiKTsKfTsKCmpRdWVyeS5leHByLmZpbHRlcnMudmlzaWJsZSA9IGZ1bmN0aW9uKCBlbGVtICkgewoJcmV0dXJuICFqUXVlcnkuZXhwci5maWx0ZXJzLmhpZGRlbiggZWxlbSApOwp9OwoKCgoKdmFyIHIyMCA9IC8lMjAvZywKCXJicmFja2V0ID0gL1xbXF0kLywKCXJDUkxGID0gL1xyP1xuL2csCglyc3VibWl0dGVyVHlwZXMgPSAvXig/OnN1Ym1pdHxidXR0b258aW1hZ2V8cmVzZXR8ZmlsZSkkL2ksCglyc3VibWl0dGFibGUgPSAvXig/OmlucHV0fHNlbGVjdHx0ZXh0YXJlYXxrZXlnZW4pL2k7CgpmdW5jdGlvbiBidWlsZFBhcmFtcyggcHJlZml4LCBvYmosIHRyYWRpdGlvbmFsLCBhZGQgKSB7Cgl2YXIgbmFtZTsKCglpZiAoIGpRdWVyeS5pc0FycmF5KCBvYmogKSApIHsKCQkvLyBTZXJpYWxpemUgYXJyYXkgaXRlbS4KCQlqUXVlcnkuZWFjaCggb2JqLCBmdW5jdGlvbiggaSwgdiApIHsKCQkJaWYgKCB0cmFkaXRpb25hbCB8fCByYnJhY2tldC50ZXN0KCBwcmVmaXggKSApIHsKCQkJCS8vIFRyZWF0IGVhY2ggYXJyYXkgaXRlbSBhcyBhIHNjYWxhci4KCQkJCWFkZCggcHJlZml4LCB2ICk7CgoJCQl9IGVsc2UgewoJCQkJLy8gSXRlbSBpcyBub24tc2NhbGFyIChhcnJheSBvciBvYmplY3QpLCBlbmNvZGUgaXRzIG51bWVyaWMgaW5kZXguCgkJCQlidWlsZFBhcmFtcyggcHJlZml4ICsgIlsiICsgKCB0eXBlb2YgdiA9PT0gIm9iamVjdCIgPyBpIDogIiIgKSArICJdIiwgdiwgdHJhZGl0aW9uYWwsIGFkZCApOwoJCQl9CgkJfSk7CgoJfSBlbHNlIGlmICggIXRyYWRpdGlvbmFsICYmIGpRdWVyeS50eXBlKCBvYmogKSA9PT0gIm9iamVjdCIgKSB7CgkJLy8gU2VyaWFsaXplIG9iamVjdCBpdGVtLgoJCWZvciAoIG5hbWUgaW4gb2JqICkgewoJCQlidWlsZFBhcmFtcyggcHJlZml4ICsgIlsiICsgbmFtZSArICJdIiwgb2JqWyBuYW1lIF0sIHRyYWRpdGlvbmFsLCBhZGQgKTsKCQl9CgoJfSBlbHNlIHsKCQkvLyBTZXJpYWxpemUgc2NhbGFyIGl0ZW0uCgkJYWRkKCBwcmVmaXgsIG9iaiApOwoJfQp9CgovLyBTZXJpYWxpemUgYW4gYXJyYXkgb2YgZm9ybSBlbGVtZW50cyBvciBhIHNldCBvZgovLyBrZXkvdmFsdWVzIGludG8gYSBxdWVyeSBzdHJpbmcKalF1ZXJ5LnBhcmFtID0gZnVuY3Rpb24oIGEsIHRyYWRpdGlvbmFsICkgewoJdmFyIHByZWZpeCwKCQlzID0gW10sCgkJYWRkID0gZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCS8vIElmIHZhbHVlIGlzIGEgZnVuY3Rpb24sIGludm9rZSBpdCBhbmQgcmV0dXJuIGl0cyB2YWx1ZQoJCQl2YWx1ZSA9IGpRdWVyeS5pc0Z1bmN0aW9uKCB2YWx1ZSApID8gdmFsdWUoKSA6ICggdmFsdWUgPT0gbnVsbCA/ICIiIDogdmFsdWUgKTsKCQkJc1sgcy5sZW5ndGggXSA9IGVuY29kZVVSSUNvbXBvbmVudCgga2V5ICkgKyAiPSIgKyBlbmNvZGVVUklDb21wb25lbnQoIHZhbHVlICk7CgkJfTsKCgkvLyBTZXQgdHJhZGl0aW9uYWwgdG8gdHJ1ZSBmb3IgalF1ZXJ5IDw9IDEuMy4yIGJlaGF2aW9yLgoJaWYgKCB0cmFkaXRpb25hbCA9PT0gdW5kZWZpbmVkICkgewoJCXRyYWRpdGlvbmFsID0galF1ZXJ5LmFqYXhTZXR0aW5ncyAmJiBqUXVlcnkuYWpheFNldHRpbmdzLnRyYWRpdGlvbmFsOwoJfQoKCS8vIElmIGFuIGFycmF5IHdhcyBwYXNzZWQgaW4sIGFzc3VtZSB0aGF0IGl0IGlzIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMuCglpZiAoIGpRdWVyeS5pc0FycmF5KCBhICkgfHwgKCBhLmpxdWVyeSAmJiAhalF1ZXJ5LmlzUGxhaW5PYmplY3QoIGEgKSApICkgewoJCS8vIFNlcmlhbGl6ZSB0aGUgZm9ybSBlbGVtZW50cwoJCWpRdWVyeS5lYWNoKCBhLCBmdW5jdGlvbigpIHsKCQkJYWRkKCB0aGlzLm5hbWUsIHRoaXMudmFsdWUgKTsKCQl9KTsKCgl9IGVsc2UgewoJCS8vIElmIHRyYWRpdGlvbmFsLCBlbmNvZGUgdGhlICJvbGQiIHdheSAodGhlIHdheSAxLjMuMiBvciBvbGRlcgoJCS8vIGRpZCBpdCksIG90aGVyd2lzZSBlbmNvZGUgcGFyYW1zIHJlY3Vyc2l2ZWx5LgoJCWZvciAoIHByZWZpeCBpbiBhICkgewoJCQlidWlsZFBhcmFtcyggcHJlZml4LCBhWyBwcmVmaXggXSwgdHJhZGl0aW9uYWwsIGFkZCApOwoJCX0KCX0KCgkvLyBSZXR1cm4gdGhlIHJlc3VsdGluZyBzZXJpYWxpemF0aW9uCglyZXR1cm4gcy5qb2luKCAiJiIgKS5yZXBsYWNlKCByMjAsICIrIiApOwp9OwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglzZXJpYWxpemU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiBqUXVlcnkucGFyYW0oIHRoaXMuc2VyaWFsaXplQXJyYXkoKSApOwoJfSwKCXNlcmlhbGl6ZUFycmF5OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24oKSB7CgkJCS8vIENhbiBhZGQgcHJvcEhvb2sgZm9yICJlbGVtZW50cyIgdG8gZmlsdGVyIG9yIGFkZCBmb3JtIGVsZW1lbnRzCgkJCXZhciBlbGVtZW50cyA9IGpRdWVyeS5wcm9wKCB0aGlzLCAiZWxlbWVudHMiICk7CgkJCXJldHVybiBlbGVtZW50cyA/IGpRdWVyeS5tYWtlQXJyYXkoIGVsZW1lbnRzICkgOiB0aGlzOwoJCX0pCgkJLmZpbHRlcihmdW5jdGlvbigpIHsKCQkJdmFyIHR5cGUgPSB0aGlzLnR5cGU7CgkJCS8vIFVzZSAuaXMoIjpkaXNhYmxlZCIpIHNvIHRoYXQgZmllbGRzZXRbZGlzYWJsZWRdIHdvcmtzCgkJCXJldHVybiB0aGlzLm5hbWUgJiYgIWpRdWVyeSggdGhpcyApLmlzKCAiOmRpc2FibGVkIiApICYmCgkJCQlyc3VibWl0dGFibGUudGVzdCggdGhpcy5ub2RlTmFtZSApICYmICFyc3VibWl0dGVyVHlwZXMudGVzdCggdHlwZSApICYmCgkJCQkoIHRoaXMuY2hlY2tlZCB8fCAhcmNoZWNrYWJsZVR5cGUudGVzdCggdHlwZSApICk7CgkJfSkKCQkubWFwKGZ1bmN0aW9uKCBpLCBlbGVtICkgewoJCQl2YXIgdmFsID0galF1ZXJ5KCB0aGlzICkudmFsKCk7CgoJCQlyZXR1cm4gdmFsID09IG51bGwgPwoJCQkJbnVsbCA6CgkJCQlqUXVlcnkuaXNBcnJheSggdmFsICkgPwoJCQkJCWpRdWVyeS5tYXAoIHZhbCwgZnVuY3Rpb24oIHZhbCApIHsKCQkJCQkJcmV0dXJuIHsgbmFtZTogZWxlbS5uYW1lLCB2YWx1ZTogdmFsLnJlcGxhY2UoIHJDUkxGLCAiXHJcbiIgKSB9OwoJCQkJCX0pIDoKCQkJCQl7IG5hbWU6IGVsZW0ubmFtZSwgdmFsdWU6IHZhbC5yZXBsYWNlKCByQ1JMRiwgIlxyXG4iICkgfTsKCQl9KS5nZXQoKTsKCX0KfSk7CgoKLy8gQ3JlYXRlIHRoZSByZXF1ZXN0IG9iamVjdAovLyAoVGhpcyBpcyBzdGlsbCBhdHRhY2hlZCB0byBhamF4U2V0dGluZ3MgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkpCmpRdWVyeS5hamF4U2V0dGluZ3MueGhyID0gd2luZG93LkFjdGl2ZVhPYmplY3QgIT09IHVuZGVmaW5lZCA/CgkvLyBTdXBwb3J0OiBJRTYrCglmdW5jdGlvbigpIHsKCgkJLy8gWEhSIGNhbm5vdCBhY2Nlc3MgbG9jYWwgZmlsZXMsIGFsd2F5cyB1c2UgQWN0aXZlWCBmb3IgdGhhdCBjYXNlCgkJcmV0dXJuICF0aGlzLmlzTG9jYWwgJiYKCgkJCS8vIFN1cHBvcnQ6IElFNy04CgkJCS8vIG9sZElFIFhIUiBkb2VzIG5vdCBzdXBwb3J0IG5vbi1SRkMyNjE2IG1ldGhvZHMgKCMxMzI0MCkKCQkJLy8gU2VlIGh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9pZS9tczUzNjY0OCh2PXZzLjg1KS5hc3B4CgkJCS8vIGFuZCBodHRwOi8vd3d3LnczLm9yZy9Qcm90b2NvbHMvcmZjMjYxNi9yZmMyNjE2LXNlYzkuaHRtbCNzZWM5CgkJCS8vIEFsdGhvdWdoIHRoaXMgY2hlY2sgZm9yIHNpeCBtZXRob2RzIGluc3RlYWQgb2YgZWlnaHQKCQkJLy8gc2luY2UgSUUgYWxzbyBkb2VzIG5vdCBzdXBwb3J0ICJ0cmFjZSIgYW5kICJjb25uZWN0IgoJCQkvXihnZXR8cG9zdHxoZWFkfHB1dHxkZWxldGV8b3B0aW9ucykkL2kudGVzdCggdGhpcy50eXBlICkgJiYKCgkJCWNyZWF0ZVN0YW5kYXJkWEhSKCkgfHwgY3JlYXRlQWN0aXZlWEhSKCk7Cgl9IDoKCS8vIEZvciBhbGwgb3RoZXIgYnJvd3NlcnMsIHVzZSB0aGUgc3RhbmRhcmQgWE1MSHR0cFJlcXVlc3Qgb2JqZWN0CgljcmVhdGVTdGFuZGFyZFhIUjsKCnZhciB4aHJJZCA9IDAsCgl4aHJDYWxsYmFja3MgPSB7fSwKCXhoclN1cHBvcnRlZCA9IGpRdWVyeS5hamF4U2V0dGluZ3MueGhyKCk7CgovLyBTdXBwb3J0OiBJRTwxMAovLyBPcGVuIHJlcXVlc3RzIG11c3QgYmUgbWFudWFsbHkgYWJvcnRlZCBvbiB1bmxvYWQgKCM1MjgwKQppZiAoIHdpbmRvdy5BY3RpdmVYT2JqZWN0ICkgewoJalF1ZXJ5KCB3aW5kb3cgKS5vbiggInVubG9hZCIsIGZ1bmN0aW9uKCkgewoJCWZvciAoIHZhciBrZXkgaW4geGhyQ2FsbGJhY2tzICkgewoJCQl4aHJDYWxsYmFja3NbIGtleSBdKCB1bmRlZmluZWQsIHRydWUgKTsKCQl9Cgl9KTsKfQoKLy8gRGV0ZXJtaW5lIHN1cHBvcnQgcHJvcGVydGllcwpzdXBwb3J0LmNvcnMgPSAhIXhoclN1cHBvcnRlZCAmJiAoICJ3aXRoQ3JlZGVudGlhbHMiIGluIHhoclN1cHBvcnRlZCApOwp4aHJTdXBwb3J0ZWQgPSBzdXBwb3J0LmFqYXggPSAhIXhoclN1cHBvcnRlZDsKCi8vIENyZWF0ZSB0cmFuc3BvcnQgaWYgdGhlIGJyb3dzZXIgY2FuIHByb3ZpZGUgYW4geGhyCmlmICggeGhyU3VwcG9ydGVkICkgewoKCWpRdWVyeS5hamF4VHJhbnNwb3J0KGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCS8vIENyb3NzIGRvbWFpbiBvbmx5IGFsbG93ZWQgaWYgc3VwcG9ydGVkIHRocm91Z2ggWE1MSHR0cFJlcXVlc3QKCQlpZiAoICFvcHRpb25zLmNyb3NzRG9tYWluIHx8IHN1cHBvcnQuY29ycyApIHsKCgkJCXZhciBjYWxsYmFjazsKCgkJCXJldHVybiB7CgkJCQlzZW5kOiBmdW5jdGlvbiggaGVhZGVycywgY29tcGxldGUgKSB7CgkJCQkJdmFyIGksCgkJCQkJCXhociA9IG9wdGlvbnMueGhyKCksCgkJCQkJCWlkID0gKyt4aHJJZDsKCgkJCQkJLy8gT3BlbiB0aGUgc29ja2V0CgkJCQkJeGhyLm9wZW4oIG9wdGlvbnMudHlwZSwgb3B0aW9ucy51cmwsIG9wdGlvbnMuYXN5bmMsIG9wdGlvbnMudXNlcm5hbWUsIG9wdGlvbnMucGFzc3dvcmQgKTsKCgkJCQkJLy8gQXBwbHkgY3VzdG9tIGZpZWxkcyBpZiBwcm92aWRlZAoJCQkJCWlmICggb3B0aW9ucy54aHJGaWVsZHMgKSB7CgkJCQkJCWZvciAoIGkgaW4gb3B0aW9ucy54aHJGaWVsZHMgKSB7CgkJCQkJCQl4aHJbIGkgXSA9IG9wdGlvbnMueGhyRmllbGRzWyBpIF07CgkJCQkJCX0KCQkJCQl9CgoJCQkJCS8vIE92ZXJyaWRlIG1pbWUgdHlwZSBpZiBuZWVkZWQKCQkJCQlpZiAoIG9wdGlvbnMubWltZVR5cGUgJiYgeGhyLm92ZXJyaWRlTWltZVR5cGUgKSB7CgkJCQkJCXhoci5vdmVycmlkZU1pbWVUeXBlKCBvcHRpb25zLm1pbWVUeXBlICk7CgkJCQkJfQoKCQkJCQkvLyBYLVJlcXVlc3RlZC1XaXRoIGhlYWRlcgoJCQkJCS8vIEZvciBjcm9zcy1kb21haW4gcmVxdWVzdHMsIHNlZWluZyBhcyBjb25kaXRpb25zIGZvciBhIHByZWZsaWdodCBhcmUKCQkJCQkvLyBha2luIHRvIGEgamlnc2F3IHB1enpsZSwgd2Ugc2ltcGx5IG5ldmVyIHNldCBpdCB0byBiZSBzdXJlLgoJCQkJCS8vIChpdCBjYW4gYWx3YXlzIGJlIHNldCBvbiBhIHBlci1yZXF1ZXN0IGJhc2lzIG9yIGV2ZW4gdXNpbmcgYWpheFNldHVwKQoJCQkJCS8vIEZvciBzYW1lLWRvbWFpbiByZXF1ZXN0cywgd29uJ3QgY2hhbmdlIGhlYWRlciBpZiBhbHJlYWR5IHByb3ZpZGVkLgoJCQkJCWlmICggIW9wdGlvbnMuY3Jvc3NEb21haW4gJiYgIWhlYWRlcnNbIlgtUmVxdWVzdGVkLVdpdGgiXSApIHsKCQkJCQkJaGVhZGVyc1siWC1SZXF1ZXN0ZWQtV2l0aCJdID0gIlhNTEh0dHBSZXF1ZXN0IjsKCQkJCQl9CgoJCQkJCS8vIFNldCBoZWFkZXJzCgkJCQkJZm9yICggaSBpbiBoZWFkZXJzICkgewoJCQkJCQkvLyBTdXBwb3J0OiBJRTw5CgkJCQkJCS8vIElFJ3MgQWN0aXZlWE9iamVjdCB0aHJvd3MgYSAnVHlwZSBNaXNtYXRjaCcgZXhjZXB0aW9uIHdoZW4gc2V0dGluZwoJCQkJCQkvLyByZXF1ZXN0IGhlYWRlciB0byBhIG51bGwtdmFsdWUuCgkJCQkJCS8vCgkJCQkJCS8vIFRvIGtlZXAgY29uc2lzdGVudCB3aXRoIG90aGVyIFhIUiBpbXBsZW1lbnRhdGlvbnMsIGNhc3QgdGhlIHZhbHVlCgkJCQkJCS8vIHRvIHN0cmluZyBhbmQgaWdub3JlIGB1bmRlZmluZWRgLgoJCQkJCQlpZiAoIGhlYWRlcnNbIGkgXSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCQkJeGhyLnNldFJlcXVlc3RIZWFkZXIoIGksIGhlYWRlcnNbIGkgXSArICIiICk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCS8vIERvIHNlbmQgdGhlIHJlcXVlc3QKCQkJCQkvLyBUaGlzIG1heSByYWlzZSBhbiBleGNlcHRpb24gd2hpY2ggaXMgYWN0dWFsbHkKCQkJCQkvLyBoYW5kbGVkIGluIGpRdWVyeS5hamF4IChzbyBubyB0cnkvY2F0Y2ggaGVyZSkKCQkJCQl4aHIuc2VuZCggKCBvcHRpb25zLmhhc0NvbnRlbnQgJiYgb3B0aW9ucy5kYXRhICkgfHwgbnVsbCApOwoKCQkJCQkvLyBMaXN0ZW5lcgoJCQkJCWNhbGxiYWNrID0gZnVuY3Rpb24oIF8sIGlzQWJvcnQgKSB7CgkJCQkJCXZhciBzdGF0dXMsIHN0YXR1c1RleHQsIHJlc3BvbnNlczsKCgkJCQkJCS8vIFdhcyBuZXZlciBjYWxsZWQgYW5kIGlzIGFib3J0ZWQgb3IgY29tcGxldGUKCQkJCQkJaWYgKCBjYWxsYmFjayAmJiAoIGlzQWJvcnQgfHwgeGhyLnJlYWR5U3RhdGUgPT09IDQgKSApIHsKCQkJCQkJCS8vIENsZWFuIHVwCgkJCQkJCQlkZWxldGUgeGhyQ2FsbGJhY2tzWyBpZCBdOwoJCQkJCQkJY2FsbGJhY2sgPSB1bmRlZmluZWQ7CgkJCQkJCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0galF1ZXJ5Lm5vb3A7CgoJCQkJCQkJLy8gQWJvcnQgbWFudWFsbHkgaWYgbmVlZGVkCgkJCQkJCQlpZiAoIGlzQWJvcnQgKSB7CgkJCQkJCQkJaWYgKCB4aHIucmVhZHlTdGF0ZSAhPT0gNCApIHsKCQkJCQkJCQkJeGhyLmFib3J0KCk7CgkJCQkJCQkJfQoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlyZXNwb25zZXMgPSB7fTsKCQkJCQkJCQlzdGF0dXMgPSB4aHIuc3RhdHVzOwoKCQkJCQkJCQkvLyBTdXBwb3J0OiBJRTwxMAoJCQkJCQkJCS8vIEFjY2Vzc2luZyBiaW5hcnktZGF0YSByZXNwb25zZVRleHQgdGhyb3dzIGFuIGV4Y2VwdGlvbgoJCQkJCQkJCS8vICgjMTE0MjYpCgkJCQkJCQkJaWYgKCB0eXBlb2YgeGhyLnJlc3BvbnNlVGV4dCA9PT0gInN0cmluZyIgKSB7CgkJCQkJCQkJCXJlc3BvbnNlcy50ZXh0ID0geGhyLnJlc3BvbnNlVGV4dDsKCQkJCQkJCQl9CgoJCQkJCQkJCS8vIEZpcmVmb3ggdGhyb3dzIGFuIGV4Y2VwdGlvbiB3aGVuIGFjY2Vzc2luZwoJCQkJCQkJCS8vIHN0YXR1c1RleHQgZm9yIGZhdWx0eSBjcm9zcy1kb21haW4gcmVxdWVzdHMKCQkJCQkJCQl0cnkgewoJCQkJCQkJCQlzdGF0dXNUZXh0ID0geGhyLnN0YXR1c1RleHQ7CgkJCQkJCQkJfSBjYXRjaCggZSApIHsKCQkJCQkJCQkJLy8gV2Ugbm9ybWFsaXplIHdpdGggV2Via2l0IGdpdmluZyBhbiBlbXB0eSBzdGF0dXNUZXh0CgkJCQkJCQkJCXN0YXR1c1RleHQgPSAiIjsKCQkJCQkJCQl9CgoJCQkJCQkJCS8vIEZpbHRlciBzdGF0dXMgZm9yIG5vbiBzdGFuZGFyZCBiZWhhdmlvcnMKCgkJCQkJCQkJLy8gSWYgdGhlIHJlcXVlc3QgaXMgbG9jYWwgYW5kIHdlIGhhdmUgZGF0YTogYXNzdW1lIGEgc3VjY2VzcwoJCQkJCQkJCS8vIChzdWNjZXNzIHdpdGggbm8gZGF0YSB3b24ndCBnZXQgbm90aWZpZWQsIHRoYXQncyB0aGUgYmVzdCB3ZQoJCQkJCQkJCS8vIGNhbiBkbyBnaXZlbiBjdXJyZW50IGltcGxlbWVudGF0aW9ucykKCQkJCQkJCQlpZiAoICFzdGF0dXMgJiYgb3B0aW9ucy5pc0xvY2FsICYmICFvcHRpb25zLmNyb3NzRG9tYWluICkgewoJCQkJCQkJCQlzdGF0dXMgPSByZXNwb25zZXMudGV4dCA/IDIwMCA6IDQwNDsKCQkJCQkJCQkvLyBJRSAtICMxNDUwOiBzb21ldGltZXMgcmV0dXJucyAxMjIzIHdoZW4gaXQgc2hvdWxkIGJlIDIwNAoJCQkJCQkJCX0gZWxzZSBpZiAoIHN0YXR1cyA9PT0gMTIyMyApIHsKCQkJCQkJCQkJc3RhdHVzID0gMjA0OwoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfQoKCQkJCQkJLy8gQ2FsbCBjb21wbGV0ZSBpZiBuZWVkZWQKCQkJCQkJaWYgKCByZXNwb25zZXMgKSB7CgkJCQkJCQljb21wbGV0ZSggc3RhdHVzLCBzdGF0dXNUZXh0LCByZXNwb25zZXMsIHhoci5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKSApOwoJCQkJCQl9CgkJCQkJfTsKCgkJCQkJaWYgKCAhb3B0aW9ucy5hc3luYyApIHsKCQkJCQkJLy8gaWYgd2UncmUgaW4gc3luYyBtb2RlIHdlIGZpcmUgdGhlIGNhbGxiYWNrCgkJCQkJCWNhbGxiYWNrKCk7CgkJCQkJfSBlbHNlIGlmICggeGhyLnJlYWR5U3RhdGUgPT09IDQgKSB7CgkJCQkJCS8vIChJRTYgJiBJRTcpIGlmIGl0J3MgaW4gY2FjaGUgYW5kIGhhcyBiZWVuCgkJCQkJCS8vIHJldHJpZXZlZCBkaXJlY3RseSB3ZSBuZWVkIHRvIGZpcmUgdGhlIGNhbGxiYWNrCgkJCQkJCXNldFRpbWVvdXQoIGNhbGxiYWNrICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJLy8gQWRkIHRvIHRoZSBsaXN0IG9mIGFjdGl2ZSB4aHIgY2FsbGJhY2tzCgkJCQkJCXhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSB4aHJDYWxsYmFja3NbIGlkIF0gPSBjYWxsYmFjazsKCQkJCQl9CgkJCQl9LAoKCQkJCWFib3J0OiBmdW5jdGlvbigpIHsKCQkJCQlpZiAoIGNhbGxiYWNrICkgewoJCQkJCQljYWxsYmFjayggdW5kZWZpbmVkLCB0cnVlICk7CgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0KCX0pOwp9CgovLyBGdW5jdGlvbnMgdG8gY3JlYXRlIHhocnMKZnVuY3Rpb24gY3JlYXRlU3RhbmRhcmRYSFIoKSB7Cgl0cnkgewoJCXJldHVybiBuZXcgd2luZG93LlhNTEh0dHBSZXF1ZXN0KCk7Cgl9IGNhdGNoKCBlICkge30KfQoKZnVuY3Rpb24gY3JlYXRlQWN0aXZlWEhSKCkgewoJdHJ5IHsKCQlyZXR1cm4gbmV3IHdpbmRvdy5BY3RpdmVYT2JqZWN0KCAiTWljcm9zb2Z0LlhNTEhUVFAiICk7Cgl9IGNhdGNoKCBlICkge30KfQoKCgoKLy8gSW5zdGFsbCBzY3JpcHQgZGF0YVR5cGUKalF1ZXJ5LmFqYXhTZXR1cCh7CglhY2NlcHRzOiB7CgkJc2NyaXB0OiAidGV4dC9qYXZhc2NyaXB0LCBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0LCBhcHBsaWNhdGlvbi9lY21hc2NyaXB0LCBhcHBsaWNhdGlvbi94LWVjbWFzY3JpcHQiCgl9LAoJY29udGVudHM6IHsKCQlzY3JpcHQ6IC8oPzpqYXZhfGVjbWEpc2NyaXB0LwoJfSwKCWNvbnZlcnRlcnM6IHsKCQkidGV4dCBzY3JpcHQiOiBmdW5jdGlvbiggdGV4dCApIHsKCQkJalF1ZXJ5Lmdsb2JhbEV2YWwoIHRleHQgKTsKCQkJcmV0dXJuIHRleHQ7CgkJfQoJfQp9KTsKCi8vIEhhbmRsZSBjYWNoZSdzIHNwZWNpYWwgY2FzZSBhbmQgZ2xvYmFsCmpRdWVyeS5hamF4UHJlZmlsdGVyKCAic2NyaXB0IiwgZnVuY3Rpb24oIHMgKSB7CglpZiAoIHMuY2FjaGUgPT09IHVuZGVmaW5lZCApIHsKCQlzLmNhY2hlID0gZmFsc2U7Cgl9CglpZiAoIHMuY3Jvc3NEb21haW4gKSB7CgkJcy50eXBlID0gIkdFVCI7CgkJcy5nbG9iYWwgPSBmYWxzZTsKCX0KfSk7CgovLyBCaW5kIHNjcmlwdCB0YWcgaGFjayB0cmFuc3BvcnQKalF1ZXJ5LmFqYXhUcmFuc3BvcnQoICJzY3JpcHQiLCBmdW5jdGlvbihzKSB7CgoJLy8gVGhpcyB0cmFuc3BvcnQgb25seSBkZWFscyB3aXRoIGNyb3NzIGRvbWFpbiByZXF1ZXN0cwoJaWYgKCBzLmNyb3NzRG9tYWluICkgewoKCQl2YXIgc2NyaXB0LAoJCQloZWFkID0gZG9jdW1lbnQuaGVhZCB8fCBqUXVlcnkoImhlYWQiKVswXSB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CgoJCXJldHVybiB7CgoJCQlzZW5kOiBmdW5jdGlvbiggXywgY2FsbGJhY2sgKSB7CgoJCQkJc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CgoJCQkJc2NyaXB0LmFzeW5jID0gdHJ1ZTsKCgkJCQlpZiAoIHMuc2NyaXB0Q2hhcnNldCApIHsKCQkJCQlzY3JpcHQuY2hhcnNldCA9IHMuc2NyaXB0Q2hhcnNldDsKCQkJCX0KCgkJCQlzY3JpcHQuc3JjID0gcy51cmw7CgoJCQkJLy8gQXR0YWNoIGhhbmRsZXJzIGZvciBhbGwgYnJvd3NlcnMKCQkJCXNjcmlwdC5vbmxvYWQgPSBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oIF8sIGlzQWJvcnQgKSB7CgoJCQkJCWlmICggaXNBYm9ydCB8fCAhc2NyaXB0LnJlYWR5U3RhdGUgfHwgL2xvYWRlZHxjb21wbGV0ZS8udGVzdCggc2NyaXB0LnJlYWR5U3RhdGUgKSApIHsKCgkJCQkJCS8vIEhhbmRsZSBtZW1vcnkgbGVhayBpbiBJRQoJCQkJCQlzY3JpcHQub25sb2FkID0gc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IG51bGw7CgoJCQkJCQkvLyBSZW1vdmUgdGhlIHNjcmlwdAoJCQkJCQlpZiAoIHNjcmlwdC5wYXJlbnROb2RlICkgewoJCQkJCQkJc2NyaXB0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIHNjcmlwdCApOwoJCQkJCQl9CgoJCQkJCQkvLyBEZXJlZmVyZW5jZSB0aGUgc2NyaXB0CgkJCQkJCXNjcmlwdCA9IG51bGw7CgoJCQkJCQkvLyBDYWxsYmFjayBpZiBub3QgYWJvcnQKCQkJCQkJaWYgKCAhaXNBYm9ydCApIHsKCQkJCQkJCWNhbGxiYWNrKCAyMDAsICJzdWNjZXNzIiApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfTsKCgkJCQkvLyBDaXJjdW12ZW50IElFNiBidWdzIHdpdGggYmFzZSBlbGVtZW50cyAoIzI3MDkgYW5kICM0Mzc4KSBieSBwcmVwZW5kaW5nCgkJCQkvLyBVc2UgbmF0aXZlIERPTSBtYW5pcHVsYXRpb24gdG8gYXZvaWQgb3VyIGRvbU1hbmlwIEFKQVggdHJpY2tlcnkKCQkJCWhlYWQuaW5zZXJ0QmVmb3JlKCBzY3JpcHQsIGhlYWQuZmlyc3RDaGlsZCApOwoJCQl9LAoKCQkJYWJvcnQ6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBzY3JpcHQgKSB7CgkJCQkJc2NyaXB0Lm9ubG9hZCggdW5kZWZpbmVkLCB0cnVlICk7CgkJCQl9CgkJCX0KCQl9OwoJfQp9KTsKCgoKCnZhciBvbGRDYWxsYmFja3MgPSBbXSwKCXJqc29ucCA9IC8oPSlcPyg/PSZ8JCl8XD9cPy87CgovLyBEZWZhdWx0IGpzb25wIHNldHRpbmdzCmpRdWVyeS5hamF4U2V0dXAoewoJanNvbnA6ICJjYWxsYmFjayIsCglqc29ucENhbGxiYWNrOiBmdW5jdGlvbigpIHsKCQl2YXIgY2FsbGJhY2sgPSBvbGRDYWxsYmFja3MucG9wKCkgfHwgKCBqUXVlcnkuZXhwYW5kbyArICJfIiArICggbm9uY2UrKyApICk7CgkJdGhpc1sgY2FsbGJhY2sgXSA9IHRydWU7CgkJcmV0dXJuIGNhbGxiYWNrOwoJfQp9KTsKCi8vIERldGVjdCwgbm9ybWFsaXplIG9wdGlvbnMgYW5kIGluc3RhbGwgY2FsbGJhY2tzIGZvciBqc29ucCByZXF1ZXN0cwpqUXVlcnkuYWpheFByZWZpbHRlciggImpzb24ganNvbnAiLCBmdW5jdGlvbiggcywgb3JpZ2luYWxTZXR0aW5ncywganFYSFIgKSB7CgoJdmFyIGNhbGxiYWNrTmFtZSwgb3ZlcndyaXR0ZW4sIHJlc3BvbnNlQ29udGFpbmVyLAoJCWpzb25Qcm9wID0gcy5qc29ucCAhPT0gZmFsc2UgJiYgKCByanNvbnAudGVzdCggcy51cmwgKSA/CgkJCSJ1cmwiIDoKCQkJdHlwZW9mIHMuZGF0YSA9PT0gInN0cmluZyIgJiYgISggcy5jb250ZW50VHlwZSB8fCAiIiApLmluZGV4T2YoImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCIpICYmIHJqc29ucC50ZXN0KCBzLmRhdGEgKSAmJiAiZGF0YSIKCQkpOwoKCS8vIEhhbmRsZSBpZmYgdGhlIGV4cGVjdGVkIGRhdGEgdHlwZSBpcyAianNvbnAiIG9yIHdlIGhhdmUgYSBwYXJhbWV0ZXIgdG8gc2V0CglpZiAoIGpzb25Qcm9wIHx8IHMuZGF0YVR5cGVzWyAwIF0gPT09ICJqc29ucCIgKSB7CgoJCS8vIEdldCBjYWxsYmFjayBuYW1lLCByZW1lbWJlcmluZyBwcmVleGlzdGluZyB2YWx1ZSBhc3NvY2lhdGVkIHdpdGggaXQKCQljYWxsYmFja05hbWUgPSBzLmpzb25wQ2FsbGJhY2sgPSBqUXVlcnkuaXNGdW5jdGlvbiggcy5qc29ucENhbGxiYWNrICkgPwoJCQlzLmpzb25wQ2FsbGJhY2soKSA6CgkJCXMuanNvbnBDYWxsYmFjazsKCgkJLy8gSW5zZXJ0IGNhbGxiYWNrIGludG8gdXJsIG9yIGZvcm0gZGF0YQoJCWlmICgganNvblByb3AgKSB7CgkJCXNbIGpzb25Qcm9wIF0gPSBzWyBqc29uUHJvcCBdLnJlcGxhY2UoIHJqc29ucCwgIiQxIiArIGNhbGxiYWNrTmFtZSApOwoJCX0gZWxzZSBpZiAoIHMuanNvbnAgIT09IGZhbHNlICkgewoJCQlzLnVybCArPSAoIHJxdWVyeS50ZXN0KCBzLnVybCApID8gIiYiIDogIj8iICkgKyBzLmpzb25wICsgIj0iICsgY2FsbGJhY2tOYW1lOwoJCX0KCgkJLy8gVXNlIGRhdGEgY29udmVydGVyIHRvIHJldHJpZXZlIGpzb24gYWZ0ZXIgc2NyaXB0IGV4ZWN1dGlvbgoJCXMuY29udmVydGVyc1sic2NyaXB0IGpzb24iXSA9IGZ1bmN0aW9uKCkgewoJCQlpZiAoICFyZXNwb25zZUNvbnRhaW5lciApIHsKCQkJCWpRdWVyeS5lcnJvciggY2FsbGJhY2tOYW1lICsgIiB3YXMgbm90IGNhbGxlZCIgKTsKCQkJfQoJCQlyZXR1cm4gcmVzcG9uc2VDb250YWluZXJbIDAgXTsKCQl9OwoKCQkvLyBmb3JjZSBqc29uIGRhdGFUeXBlCgkJcy5kYXRhVHlwZXNbIDAgXSA9ICJqc29uIjsKCgkJLy8gSW5zdGFsbCBjYWxsYmFjawoJCW92ZXJ3cml0dGVuID0gd2luZG93WyBjYWxsYmFja05hbWUgXTsKCQl3aW5kb3dbIGNhbGxiYWNrTmFtZSBdID0gZnVuY3Rpb24oKSB7CgkJCXJlc3BvbnNlQ29udGFpbmVyID0gYXJndW1lbnRzOwoJCX07CgoJCS8vIENsZWFuLXVwIGZ1bmN0aW9uIChmaXJlcyBhZnRlciBjb252ZXJ0ZXJzKQoJCWpxWEhSLmFsd2F5cyhmdW5jdGlvbigpIHsKCQkJLy8gUmVzdG9yZSBwcmVleGlzdGluZyB2YWx1ZQoJCQl3aW5kb3dbIGNhbGxiYWNrTmFtZSBdID0gb3ZlcndyaXR0ZW47CgoJCQkvLyBTYXZlIGJhY2sgYXMgZnJlZQoJCQlpZiAoIHNbIGNhbGxiYWNrTmFtZSBdICkgewoJCQkJLy8gbWFrZSBzdXJlIHRoYXQgcmUtdXNpbmcgdGhlIG9wdGlvbnMgZG9lc24ndCBzY3JldyB0aGluZ3MgYXJvdW5kCgkJCQlzLmpzb25wQ2FsbGJhY2sgPSBvcmlnaW5hbFNldHRpbmdzLmpzb25wQ2FsbGJhY2s7CgoJCQkJLy8gc2F2ZSB0aGUgY2FsbGJhY2sgbmFtZSBmb3IgZnV0dXJlIHVzZQoJCQkJb2xkQ2FsbGJhY2tzLnB1c2goIGNhbGxiYWNrTmFtZSApOwoJCQl9CgoJCQkvLyBDYWxsIGlmIGl0IHdhcyBhIGZ1bmN0aW9uIGFuZCB3ZSBoYXZlIGEgcmVzcG9uc2UKCQkJaWYgKCByZXNwb25zZUNvbnRhaW5lciAmJiBqUXVlcnkuaXNGdW5jdGlvbiggb3ZlcndyaXR0ZW4gKSApIHsKCQkJCW92ZXJ3cml0dGVuKCByZXNwb25zZUNvbnRhaW5lclsgMCBdICk7CgkJCX0KCgkJCXJlc3BvbnNlQ29udGFpbmVyID0gb3ZlcndyaXR0ZW4gPSB1bmRlZmluZWQ7CgkJfSk7CgoJCS8vIERlbGVnYXRlIHRvIHNjcmlwdAoJCXJldHVybiAic2NyaXB0IjsKCX0KfSk7CgoKCgovLyBkYXRhOiBzdHJpbmcgb2YgaHRtbAovLyBjb250ZXh0IChvcHRpb25hbCk6IElmIHNwZWNpZmllZCwgdGhlIGZyYWdtZW50IHdpbGwgYmUgY3JlYXRlZCBpbiB0aGlzIGNvbnRleHQsIGRlZmF1bHRzIHRvIGRvY3VtZW50Ci8vIGtlZXBTY3JpcHRzIChvcHRpb25hbCk6IElmIHRydWUsIHdpbGwgaW5jbHVkZSBzY3JpcHRzIHBhc3NlZCBpbiB0aGUgaHRtbCBzdHJpbmcKalF1ZXJ5LnBhcnNlSFRNTCA9IGZ1bmN0aW9uKCBkYXRhLCBjb250ZXh0LCBrZWVwU2NyaXB0cyApIHsKCWlmICggIWRhdGEgfHwgdHlwZW9mIGRhdGEgIT09ICJzdHJpbmciICkgewoJCXJldHVybiBudWxsOwoJfQoJaWYgKCB0eXBlb2YgY29udGV4dCA9PT0gImJvb2xlYW4iICkgewoJCWtlZXBTY3JpcHRzID0gY29udGV4dDsKCQljb250ZXh0ID0gZmFsc2U7Cgl9Cgljb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKCgl2YXIgcGFyc2VkID0gcnNpbmdsZVRhZy5leGVjKCBkYXRhICksCgkJc2NyaXB0cyA9ICFrZWVwU2NyaXB0cyAmJiBbXTsKCgkvLyBTaW5nbGUgdGFnCglpZiAoIHBhcnNlZCApIHsKCQlyZXR1cm4gWyBjb250ZXh0LmNyZWF0ZUVsZW1lbnQoIHBhcnNlZFsxXSApIF07Cgl9CgoJcGFyc2VkID0galF1ZXJ5LmJ1aWxkRnJhZ21lbnQoIFsgZGF0YSBdLCBjb250ZXh0LCBzY3JpcHRzICk7CgoJaWYgKCBzY3JpcHRzICYmIHNjcmlwdHMubGVuZ3RoICkgewoJCWpRdWVyeSggc2NyaXB0cyApLnJlbW92ZSgpOwoJfQoKCXJldHVybiBqUXVlcnkubWVyZ2UoIFtdLCBwYXJzZWQuY2hpbGROb2RlcyApOwp9OwoKCi8vIEtlZXAgYSBjb3B5IG9mIHRoZSBvbGQgbG9hZCBtZXRob2QKdmFyIF9sb2FkID0galF1ZXJ5LmZuLmxvYWQ7CgovKioKICogTG9hZCBhIHVybCBpbnRvIGEgcGFnZQogKi8KalF1ZXJ5LmZuLmxvYWQgPSBmdW5jdGlvbiggdXJsLCBwYXJhbXMsIGNhbGxiYWNrICkgewoJaWYgKCB0eXBlb2YgdXJsICE9PSAic3RyaW5nIiAmJiBfbG9hZCApIHsKCQlyZXR1cm4gX2xvYWQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJfQoKCXZhciBzZWxlY3RvciwgcmVzcG9uc2UsIHR5cGUsCgkJc2VsZiA9IHRoaXMsCgkJb2ZmID0gdXJsLmluZGV4T2YoIiAiKTsKCglpZiAoIG9mZiA+PSAwICkgewoJCXNlbGVjdG9yID0gdXJsLnNsaWNlKCBvZmYsIHVybC5sZW5ndGggKTsKCQl1cmwgPSB1cmwuc2xpY2UoIDAsIG9mZiApOwoJfQoKCS8vIElmIGl0J3MgYSBmdW5jdGlvbgoJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggcGFyYW1zICkgKSB7CgoJCS8vIFdlIGFzc3VtZSB0aGF0IGl0J3MgdGhlIGNhbGxiYWNrCgkJY2FsbGJhY2sgPSBwYXJhbXM7CgkJcGFyYW1zID0gdW5kZWZpbmVkOwoKCS8vIE90aGVyd2lzZSwgYnVpbGQgYSBwYXJhbSBzdHJpbmcKCX0gZWxzZSBpZiAoIHBhcmFtcyAmJiB0eXBlb2YgcGFyYW1zID09PSAib2JqZWN0IiApIHsKCQl0eXBlID0gIlBPU1QiOwoJfQoKCS8vIElmIHdlIGhhdmUgZWxlbWVudHMgdG8gbW9kaWZ5LCBtYWtlIHRoZSByZXF1ZXN0CglpZiAoIHNlbGYubGVuZ3RoID4gMCApIHsKCQlqUXVlcnkuYWpheCh7CgkJCXVybDogdXJsLAoKCQkJLy8gaWYgInR5cGUiIHZhcmlhYmxlIGlzIHVuZGVmaW5lZCwgdGhlbiAiR0VUIiBtZXRob2Qgd2lsbCBiZSB1c2VkCgkJCXR5cGU6IHR5cGUsCgkJCWRhdGFUeXBlOiAiaHRtbCIsCgkJCWRhdGE6IHBhcmFtcwoJCX0pLmRvbmUoZnVuY3Rpb24oIHJlc3BvbnNlVGV4dCApIHsKCgkJCS8vIFNhdmUgcmVzcG9uc2UgZm9yIHVzZSBpbiBjb21wbGV0ZSBjYWxsYmFjawoJCQlyZXNwb25zZSA9IGFyZ3VtZW50czsKCgkJCXNlbGYuaHRtbCggc2VsZWN0b3IgPwoKCQkJCS8vIElmIGEgc2VsZWN0b3Igd2FzIHNwZWNpZmllZCwgbG9jYXRlIHRoZSByaWdodCBlbGVtZW50cyBpbiBhIGR1bW15IGRpdgoJCQkJLy8gRXhjbHVkZSBzY3JpcHRzIHRvIGF2b2lkIElFICdQZXJtaXNzaW9uIERlbmllZCcgZXJyb3JzCgkJCQlqUXVlcnkoIjxkaXY+IikuYXBwZW5kKCBqUXVlcnkucGFyc2VIVE1MKCByZXNwb25zZVRleHQgKSApLmZpbmQoIHNlbGVjdG9yICkgOgoKCQkJCS8vIE90aGVyd2lzZSB1c2UgdGhlIGZ1bGwgcmVzdWx0CgkJCQlyZXNwb25zZVRleHQgKTsKCgkJfSkuY29tcGxldGUoIGNhbGxiYWNrICYmIGZ1bmN0aW9uKCBqcVhIUiwgc3RhdHVzICkgewoJCQlzZWxmLmVhY2goIGNhbGxiYWNrLCByZXNwb25zZSB8fCBbIGpxWEhSLnJlc3BvbnNlVGV4dCwgc3RhdHVzLCBqcVhIUiBdICk7CgkJfSk7Cgl9CgoJcmV0dXJuIHRoaXM7Cn07CgoKCgpqUXVlcnkuZXhwci5maWx0ZXJzLmFuaW1hdGVkID0gZnVuY3Rpb24oIGVsZW0gKSB7CglyZXR1cm4galF1ZXJ5LmdyZXAoalF1ZXJ5LnRpbWVycywgZnVuY3Rpb24oIGZuICkgewoJCXJldHVybiBlbGVtID09PSBmbi5lbGVtOwoJfSkubGVuZ3RoOwp9OwoKCgoKCnZhciBkb2NFbGVtID0gd2luZG93LmRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCi8qKgogKiBHZXRzIGEgd2luZG93IGZyb20gYW4gZWxlbWVudAogKi8KZnVuY3Rpb24gZ2V0V2luZG93KCBlbGVtICkgewoJcmV0dXJuIGpRdWVyeS5pc1dpbmRvdyggZWxlbSApID8KCQllbGVtIDoKCQllbGVtLm5vZGVUeXBlID09PSA5ID8KCQkJZWxlbS5kZWZhdWx0VmlldyB8fCBlbGVtLnBhcmVudFdpbmRvdyA6CgkJCWZhbHNlOwp9CgpqUXVlcnkub2Zmc2V0ID0gewoJc2V0T2Zmc2V0OiBmdW5jdGlvbiggZWxlbSwgb3B0aW9ucywgaSApIHsKCQl2YXIgY3VyUG9zaXRpb24sIGN1ckxlZnQsIGN1ckNTU1RvcCwgY3VyVG9wLCBjdXJPZmZzZXQsIGN1ckNTU0xlZnQsIGNhbGN1bGF0ZVBvc2l0aW9uLAoJCQlwb3NpdGlvbiA9IGpRdWVyeS5jc3MoIGVsZW0sICJwb3NpdGlvbiIgKSwKCQkJY3VyRWxlbSA9IGpRdWVyeSggZWxlbSApLAoJCQlwcm9wcyA9IHt9OwoKCQkvLyBzZXQgcG9zaXRpb24gZmlyc3QsIGluLWNhc2UgdG9wL2xlZnQgYXJlIHNldCBldmVuIG9uIHN0YXRpYyBlbGVtCgkJaWYgKCBwb3NpdGlvbiA9PT0gInN0YXRpYyIgKSB7CgkJCWVsZW0uc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwoJCX0KCgkJY3VyT2Zmc2V0ID0gY3VyRWxlbS5vZmZzZXQoKTsKCQljdXJDU1NUb3AgPSBqUXVlcnkuY3NzKCBlbGVtLCAidG9wIiApOwoJCWN1ckNTU0xlZnQgPSBqUXVlcnkuY3NzKCBlbGVtLCAibGVmdCIgKTsKCQljYWxjdWxhdGVQb3NpdGlvbiA9ICggcG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgfHwgcG9zaXRpb24gPT09ICJmaXhlZCIgKSAmJgoJCQlqUXVlcnkuaW5BcnJheSgiYXV0byIsIFsgY3VyQ1NTVG9wLCBjdXJDU1NMZWZ0IF0gKSA+IC0xOwoKCQkvLyBuZWVkIHRvIGJlIGFibGUgdG8gY2FsY3VsYXRlIHBvc2l0aW9uIGlmIGVpdGhlciB0b3Agb3IgbGVmdCBpcyBhdXRvIGFuZCBwb3NpdGlvbiBpcyBlaXRoZXIgYWJzb2x1dGUgb3IgZml4ZWQKCQlpZiAoIGNhbGN1bGF0ZVBvc2l0aW9uICkgewoJCQljdXJQb3NpdGlvbiA9IGN1ckVsZW0ucG9zaXRpb24oKTsKCQkJY3VyVG9wID0gY3VyUG9zaXRpb24udG9wOwoJCQljdXJMZWZ0ID0gY3VyUG9zaXRpb24ubGVmdDsKCQl9IGVsc2UgewoJCQljdXJUb3AgPSBwYXJzZUZsb2F0KCBjdXJDU1NUb3AgKSB8fCAwOwoJCQljdXJMZWZ0ID0gcGFyc2VGbG9hdCggY3VyQ1NTTGVmdCApIHx8IDA7CgkJfQoKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBvcHRpb25zICkgKSB7CgkJCW9wdGlvbnMgPSBvcHRpb25zLmNhbGwoIGVsZW0sIGksIGN1ck9mZnNldCApOwoJCX0KCgkJaWYgKCBvcHRpb25zLnRvcCAhPSBudWxsICkgewoJCQlwcm9wcy50b3AgPSAoIG9wdGlvbnMudG9wIC0gY3VyT2Zmc2V0LnRvcCApICsgY3VyVG9wOwoJCX0KCQlpZiAoIG9wdGlvbnMubGVmdCAhPSBudWxsICkgewoJCQlwcm9wcy5sZWZ0ID0gKCBvcHRpb25zLmxlZnQgLSBjdXJPZmZzZXQubGVmdCApICsgY3VyTGVmdDsKCQl9CgoJCWlmICggInVzaW5nIiBpbiBvcHRpb25zICkgewoJCQlvcHRpb25zLnVzaW5nLmNhbGwoIGVsZW0sIHByb3BzICk7CgkJfSBlbHNlIHsKCQkJY3VyRWxlbS5jc3MoIHByb3BzICk7CgkJfQoJfQp9OwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglvZmZzZXQ6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJcmV0dXJuIG9wdGlvbnMgPT09IHVuZGVmaW5lZCA/CgkJCQl0aGlzIDoKCQkJCXRoaXMuZWFjaChmdW5jdGlvbiggaSApIHsKCQkJCQlqUXVlcnkub2Zmc2V0LnNldE9mZnNldCggdGhpcywgb3B0aW9ucywgaSApOwoJCQkJfSk7CgkJfQoKCQl2YXIgZG9jRWxlbSwgd2luLAoJCQlib3ggPSB7IHRvcDogMCwgbGVmdDogMCB9LAoJCQllbGVtID0gdGhpc1sgMCBdLAoJCQlkb2MgPSBlbGVtICYmIGVsZW0ub3duZXJEb2N1bWVudDsKCgkJaWYgKCAhZG9jICkgewoJCQlyZXR1cm47CgkJfQoKCQlkb2NFbGVtID0gZG9jLmRvY3VtZW50RWxlbWVudDsKCgkJLy8gTWFrZSBzdXJlIGl0J3Mgbm90IGEgZGlzY29ubmVjdGVkIERPTSBub2RlCgkJaWYgKCAhalF1ZXJ5LmNvbnRhaW5zKCBkb2NFbGVtLCBlbGVtICkgKSB7CgkJCXJldHVybiBib3g7CgkJfQoKCQkvLyBJZiB3ZSBkb24ndCBoYXZlIGdCQ1IsIGp1c3QgdXNlIDAsMCByYXRoZXIgdGhhbiBlcnJvcgoJCS8vIEJsYWNrQmVycnkgNSwgaU9TIDMgKG9yaWdpbmFsIGlQaG9uZSkKCQlpZiAoIHR5cGVvZiBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCAhPT0gc3RydW5kZWZpbmVkICkgewoJCQlib3ggPSBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwoJCX0KCQl3aW4gPSBnZXRXaW5kb3coIGRvYyApOwoJCXJldHVybiB7CgkJCXRvcDogYm94LnRvcCAgKyAoIHdpbi5wYWdlWU9mZnNldCB8fCBkb2NFbGVtLnNjcm9sbFRvcCApICAtICggZG9jRWxlbS5jbGllbnRUb3AgIHx8IDAgKSwKCQkJbGVmdDogYm94LmxlZnQgKyAoIHdpbi5wYWdlWE9mZnNldCB8fCBkb2NFbGVtLnNjcm9sbExlZnQgKSAtICggZG9jRWxlbS5jbGllbnRMZWZ0IHx8IDAgKQoJCX07Cgl9LAoKCXBvc2l0aW9uOiBmdW5jdGlvbigpIHsKCQlpZiAoICF0aGlzWyAwIF0gKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBvZmZzZXRQYXJlbnQsIG9mZnNldCwKCQkJcGFyZW50T2Zmc2V0ID0geyB0b3A6IDAsIGxlZnQ6IDAgfSwKCQkJZWxlbSA9IHRoaXNbIDAgXTsKCgkJLy8gZml4ZWQgZWxlbWVudHMgYXJlIG9mZnNldCBmcm9tIHdpbmRvdyAocGFyZW50T2Zmc2V0ID0ge3RvcDowLCBsZWZ0OiAwfSwgYmVjYXVzZSBpdCBpcyBpdHMgb25seSBvZmZzZXQgcGFyZW50CgkJaWYgKCBqUXVlcnkuY3NzKCBlbGVtLCAicG9zaXRpb24iICkgPT09ICJmaXhlZCIgKSB7CgkJCS8vIHdlIGFzc3VtZSB0aGF0IGdldEJvdW5kaW5nQ2xpZW50UmVjdCBpcyBhdmFpbGFibGUgd2hlbiBjb21wdXRlZCBwb3NpdGlvbiBpcyBmaXhlZAoJCQlvZmZzZXQgPSBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwoJCX0gZWxzZSB7CgkJCS8vIEdldCAqcmVhbCogb2Zmc2V0UGFyZW50CgkJCW9mZnNldFBhcmVudCA9IHRoaXMub2Zmc2V0UGFyZW50KCk7CgoJCQkvLyBHZXQgY29ycmVjdCBvZmZzZXRzCgkJCW9mZnNldCA9IHRoaXMub2Zmc2V0KCk7CgkJCWlmICggIWpRdWVyeS5ub2RlTmFtZSggb2Zmc2V0UGFyZW50WyAwIF0sICJodG1sIiApICkgewoJCQkJcGFyZW50T2Zmc2V0ID0gb2Zmc2V0UGFyZW50Lm9mZnNldCgpOwoJCQl9CgoJCQkvLyBBZGQgb2Zmc2V0UGFyZW50IGJvcmRlcnMKCQkJcGFyZW50T2Zmc2V0LnRvcCAgKz0galF1ZXJ5LmNzcyggb2Zmc2V0UGFyZW50WyAwIF0sICJib3JkZXJUb3BXaWR0aCIsIHRydWUgKTsKCQkJcGFyZW50T2Zmc2V0LmxlZnQgKz0galF1ZXJ5LmNzcyggb2Zmc2V0UGFyZW50WyAwIF0sICJib3JkZXJMZWZ0V2lkdGgiLCB0cnVlICk7CgkJfQoKCQkvLyBTdWJ0cmFjdCBwYXJlbnQgb2Zmc2V0cyBhbmQgZWxlbWVudCBtYXJnaW5zCgkJLy8gbm90ZTogd2hlbiBhbiBlbGVtZW50IGhhcyBtYXJnaW46IGF1dG8gdGhlIG9mZnNldExlZnQgYW5kIG1hcmdpbkxlZnQKCQkvLyBhcmUgdGhlIHNhbWUgaW4gU2FmYXJpIGNhdXNpbmcgb2Zmc2V0LmxlZnQgdG8gaW5jb3JyZWN0bHkgYmUgMAoJCXJldHVybiB7CgkJCXRvcDogIG9mZnNldC50b3AgIC0gcGFyZW50T2Zmc2V0LnRvcCAtIGpRdWVyeS5jc3MoIGVsZW0sICJtYXJnaW5Ub3AiLCB0cnVlICksCgkJCWxlZnQ6IG9mZnNldC5sZWZ0IC0gcGFyZW50T2Zmc2V0LmxlZnQgLSBqUXVlcnkuY3NzKCBlbGVtLCAibWFyZ2luTGVmdCIsIHRydWUpCgkJfTsKCX0sCgoJb2Zmc2V0UGFyZW50OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24oKSB7CgkJCXZhciBvZmZzZXRQYXJlbnQgPSB0aGlzLm9mZnNldFBhcmVudCB8fCBkb2NFbGVtOwoKCQkJd2hpbGUgKCBvZmZzZXRQYXJlbnQgJiYgKCAhalF1ZXJ5Lm5vZGVOYW1lKCBvZmZzZXRQYXJlbnQsICJodG1sIiApICYmIGpRdWVyeS5jc3MoIG9mZnNldFBhcmVudCwgInBvc2l0aW9uIiApID09PSAic3RhdGljIiApICkgewoJCQkJb2Zmc2V0UGFyZW50ID0gb2Zmc2V0UGFyZW50Lm9mZnNldFBhcmVudDsKCQkJfQoJCQlyZXR1cm4gb2Zmc2V0UGFyZW50IHx8IGRvY0VsZW07CgkJfSk7Cgl9Cn0pOwoKLy8gQ3JlYXRlIHNjcm9sbExlZnQgYW5kIHNjcm9sbFRvcCBtZXRob2RzCmpRdWVyeS5lYWNoKCB7IHNjcm9sbExlZnQ6ICJwYWdlWE9mZnNldCIsIHNjcm9sbFRvcDogInBhZ2VZT2Zmc2V0IiB9LCBmdW5jdGlvbiggbWV0aG9kLCBwcm9wICkgewoJdmFyIHRvcCA9IC9ZLy50ZXN0KCBwcm9wICk7CgoJalF1ZXJ5LmZuWyBtZXRob2QgXSA9IGZ1bmN0aW9uKCB2YWwgKSB7CgkJcmV0dXJuIGFjY2VzcyggdGhpcywgZnVuY3Rpb24oIGVsZW0sIG1ldGhvZCwgdmFsICkgewoJCQl2YXIgd2luID0gZ2V0V2luZG93KCBlbGVtICk7CgoJCQlpZiAoIHZhbCA9PT0gdW5kZWZpbmVkICkgewoJCQkJcmV0dXJuIHdpbiA/IChwcm9wIGluIHdpbikgPyB3aW5bIHByb3AgXSA6CgkJCQkJd2luLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudFsgbWV0aG9kIF0gOgoJCQkJCWVsZW1bIG1ldGhvZCBdOwoJCQl9CgoJCQlpZiAoIHdpbiApIHsKCQkJCXdpbi5zY3JvbGxUbygKCQkJCQkhdG9wID8gdmFsIDogalF1ZXJ5KCB3aW4gKS5zY3JvbGxMZWZ0KCksCgkJCQkJdG9wID8gdmFsIDogalF1ZXJ5KCB3aW4gKS5zY3JvbGxUb3AoKQoJCQkJKTsKCgkJCX0gZWxzZSB7CgkJCQllbGVtWyBtZXRob2QgXSA9IHZhbDsKCQkJfQoJCX0sIG1ldGhvZCwgdmFsLCBhcmd1bWVudHMubGVuZ3RoLCBudWxsICk7Cgl9Owp9KTsKCi8vIEFkZCB0aGUgdG9wL2xlZnQgY3NzSG9va3MgdXNpbmcgalF1ZXJ5LmZuLnBvc2l0aW9uCi8vIFdlYmtpdCBidWc6IGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD0yOTA4NAovLyBnZXRDb21wdXRlZFN0eWxlIHJldHVybnMgcGVyY2VudCB3aGVuIHNwZWNpZmllZCBmb3IgdG9wL2xlZnQvYm90dG9tL3JpZ2h0Ci8vIHJhdGhlciB0aGFuIG1ha2UgdGhlIGNzcyBtb2R1bGUgZGVwZW5kIG9uIHRoZSBvZmZzZXQgbW9kdWxlLCB3ZSBqdXN0IGNoZWNrIGZvciBpdCBoZXJlCmpRdWVyeS5lYWNoKCBbICJ0b3AiLCAibGVmdCIgXSwgZnVuY3Rpb24oIGksIHByb3AgKSB7CglqUXVlcnkuY3NzSG9va3NbIHByb3AgXSA9IGFkZEdldEhvb2tJZiggc3VwcG9ydC5waXhlbFBvc2l0aW9uLAoJCWZ1bmN0aW9uKCBlbGVtLCBjb21wdXRlZCApIHsKCQkJaWYgKCBjb21wdXRlZCApIHsKCQkJCWNvbXB1dGVkID0gY3VyQ1NTKCBlbGVtLCBwcm9wICk7CgkJCQkvLyBpZiBjdXJDU1MgcmV0dXJucyBwZXJjZW50YWdlLCBmYWxsYmFjayB0byBvZmZzZXQKCQkJCXJldHVybiBybnVtbm9ucHgudGVzdCggY29tcHV0ZWQgKSA/CgkJCQkJalF1ZXJ5KCBlbGVtICkucG9zaXRpb24oKVsgcHJvcCBdICsgInB4IiA6CgkJCQkJY29tcHV0ZWQ7CgkJCX0KCQl9CgkpOwp9KTsKCgovLyBDcmVhdGUgaW5uZXJIZWlnaHQsIGlubmVyV2lkdGgsIGhlaWdodCwgd2lkdGgsIG91dGVySGVpZ2h0IGFuZCBvdXRlcldpZHRoIG1ldGhvZHMKalF1ZXJ5LmVhY2goIHsgSGVpZ2h0OiAiaGVpZ2h0IiwgV2lkdGg6ICJ3aWR0aCIgfSwgZnVuY3Rpb24oIG5hbWUsIHR5cGUgKSB7CglqUXVlcnkuZWFjaCggeyBwYWRkaW5nOiAiaW5uZXIiICsgbmFtZSwgY29udGVudDogdHlwZSwgIiI6ICJvdXRlciIgKyBuYW1lIH0sIGZ1bmN0aW9uKCBkZWZhdWx0RXh0cmEsIGZ1bmNOYW1lICkgewoJCS8vIG1hcmdpbiBpcyBvbmx5IGZvciBvdXRlckhlaWdodCwgb3V0ZXJXaWR0aAoJCWpRdWVyeS5mblsgZnVuY05hbWUgXSA9IGZ1bmN0aW9uKCBtYXJnaW4sIHZhbHVlICkgewoJCQl2YXIgY2hhaW5hYmxlID0gYXJndW1lbnRzLmxlbmd0aCAmJiAoIGRlZmF1bHRFeHRyYSB8fCB0eXBlb2YgbWFyZ2luICE9PSAiYm9vbGVhbiIgKSwKCQkJCWV4dHJhID0gZGVmYXVsdEV4dHJhIHx8ICggbWFyZ2luID09PSB0cnVlIHx8IHZhbHVlID09PSB0cnVlID8gIm1hcmdpbiIgOiAiYm9yZGVyIiApOwoKCQkJcmV0dXJuIGFjY2VzcyggdGhpcywgZnVuY3Rpb24oIGVsZW0sIHR5cGUsIHZhbHVlICkgewoJCQkJdmFyIGRvYzsKCgkJCQlpZiAoIGpRdWVyeS5pc1dpbmRvdyggZWxlbSApICkgewoJCQkJCS8vIEFzIG9mIDUvOC8yMDEyIHRoaXMgd2lsbCB5aWVsZCBpbmNvcnJlY3QgcmVzdWx0cyBmb3IgTW9iaWxlIFNhZmFyaSwgYnV0IHRoZXJlCgkJCQkJLy8gaXNuJ3QgYSB3aG9sZSBsb3Qgd2UgY2FuIGRvLiBTZWUgcHVsbCByZXF1ZXN0IGF0IHRoaXMgVVJMIGZvciBkaXNjdXNzaW9uOgoJCQkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5L3B1bGwvNzY0CgkJCQkJcmV0dXJuIGVsZW0uZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50WyAiY2xpZW50IiArIG5hbWUgXTsKCQkJCX0KCgkJCQkvLyBHZXQgZG9jdW1lbnQgd2lkdGggb3IgaGVpZ2h0CgkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDkgKSB7CgkJCQkJZG9jID0gZWxlbS5kb2N1bWVudEVsZW1lbnQ7CgoJCQkJCS8vIEVpdGhlciBzY3JvbGxbV2lkdGgvSGVpZ2h0XSBvciBvZmZzZXRbV2lkdGgvSGVpZ2h0XSBvciBjbGllbnRbV2lkdGgvSGVpZ2h0XSwgd2hpY2hldmVyIGlzIGdyZWF0ZXN0CgkJCQkJLy8gdW5mb3J0dW5hdGVseSwgdGhpcyBjYXVzZXMgYnVnICMzODM4IGluIElFNi84IG9ubHksIGJ1dCB0aGVyZSBpcyBjdXJyZW50bHkgbm8gZ29vZCwgc21hbGwgd2F5IHRvIGZpeCBpdC4KCQkJCQlyZXR1cm4gTWF0aC5tYXgoCgkJCQkJCWVsZW0uYm9keVsgInNjcm9sbCIgKyBuYW1lIF0sIGRvY1sgInNjcm9sbCIgKyBuYW1lIF0sCgkJCQkJCWVsZW0uYm9keVsgIm9mZnNldCIgKyBuYW1lIF0sIGRvY1sgIm9mZnNldCIgKyBuYW1lIF0sCgkJCQkJCWRvY1sgImNsaWVudCIgKyBuYW1lIF0KCQkJCQkpOwoJCQkJfQoKCQkJCXJldHVybiB2YWx1ZSA9PT0gdW5kZWZpbmVkID8KCQkJCQkvLyBHZXQgd2lkdGggb3IgaGVpZ2h0IG9uIHRoZSBlbGVtZW50LCByZXF1ZXN0aW5nIGJ1dCBub3QgZm9yY2luZyBwYXJzZUZsb2F0CgkJCQkJalF1ZXJ5LmNzcyggZWxlbSwgdHlwZSwgZXh0cmEgKSA6CgoJCQkJCS8vIFNldCB3aWR0aCBvciBoZWlnaHQgb24gdGhlIGVsZW1lbnQKCQkJCQlqUXVlcnkuc3R5bGUoIGVsZW0sIHR5cGUsIHZhbHVlLCBleHRyYSApOwoJCQl9LCB0eXBlLCBjaGFpbmFibGUgPyBtYXJnaW4gOiB1bmRlZmluZWQsIGNoYWluYWJsZSwgbnVsbCApOwoJCX07Cgl9KTsKfSk7CgoKLy8gVGhlIG51bWJlciBvZiBlbGVtZW50cyBjb250YWluZWQgaW4gdGhlIG1hdGNoZWQgZWxlbWVudCBzZXQKalF1ZXJ5LmZuLnNpemUgPSBmdW5jdGlvbigpIHsKCXJldHVybiB0aGlzLmxlbmd0aDsKfTsKCmpRdWVyeS5mbi5hbmRTZWxmID0galF1ZXJ5LmZuLmFkZEJhY2s7CgoKCgovLyBSZWdpc3RlciBhcyBhIG5hbWVkIEFNRCBtb2R1bGUsIHNpbmNlIGpRdWVyeSBjYW4gYmUgY29uY2F0ZW5hdGVkIHdpdGggb3RoZXIKLy8gZmlsZXMgdGhhdCBtYXkgdXNlIGRlZmluZSwgYnV0IG5vdCB2aWEgYSBwcm9wZXIgY29uY2F0ZW5hdGlvbiBzY3JpcHQgdGhhdAovLyB1bmRlcnN0YW5kcyBhbm9ueW1vdXMgQU1EIG1vZHVsZXMuIEEgbmFtZWQgQU1EIGlzIHNhZmVzdCBhbmQgbW9zdCByb2J1c3QKLy8gd2F5IHRvIHJlZ2lzdGVyLiBMb3dlcmNhc2UganF1ZXJ5IGlzIHVzZWQgYmVjYXVzZSBBTUQgbW9kdWxlIG5hbWVzIGFyZQovLyBkZXJpdmVkIGZyb20gZmlsZSBuYW1lcywgYW5kIGpRdWVyeSBpcyBub3JtYWxseSBkZWxpdmVyZWQgaW4gYSBsb3dlcmNhc2UKLy8gZmlsZSBuYW1lLiBEbyB0aGlzIGFmdGVyIGNyZWF0aW5nIHRoZSBnbG9iYWwgc28gdGhhdCBpZiBhbiBBTUQgbW9kdWxlIHdhbnRzCi8vIHRvIGNhbGwgbm9Db25mbGljdCB0byBoaWRlIHRoaXMgdmVyc2lvbiBvZiBqUXVlcnksIGl0IHdpbGwgd29yay4KaWYgKCB0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQgKSB7CglkZWZpbmUoICJqcXVlcnkiLCBbXSwgZnVuY3Rpb24oKSB7CgkJcmV0dXJuIGpRdWVyeTsKCX0pOwp9CgoKCgp2YXIKCS8vIE1hcCBvdmVyIGpRdWVyeSBpbiBjYXNlIG9mIG92ZXJ3cml0ZQoJX2pRdWVyeSA9IHdpbmRvdy5qUXVlcnksCgoJLy8gTWFwIG92ZXIgdGhlICQgaW4gY2FzZSBvZiBvdmVyd3JpdGUKCV8kID0gd2luZG93LiQ7CgpqUXVlcnkubm9Db25mbGljdCA9IGZ1bmN0aW9uKCBkZWVwICkgewoJaWYgKCB3aW5kb3cuJCA9PT0galF1ZXJ5ICkgewoJCXdpbmRvdy4kID0gXyQ7Cgl9CgoJaWYgKCBkZWVwICYmIHdpbmRvdy5qUXVlcnkgPT09IGpRdWVyeSApIHsKCQl3aW5kb3cualF1ZXJ5ID0gX2pRdWVyeTsKCX0KCglyZXR1cm4galF1ZXJ5Owp9OwoKLy8gRXhwb3NlIGpRdWVyeSBhbmQgJCBpZGVudGlmaWVycywgZXZlbiBpbgovLyBBTUQgKCM3MTAyI2NvbW1lbnQ6MTAsIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5L3B1bGwvNTU3KQovLyBhbmQgQ29tbW9uSlMgZm9yIGJyb3dzZXIgZW11bGF0b3JzICgjMTM1NjYpCmlmICggdHlwZW9mIG5vR2xvYmFsID09PSBzdHJ1bmRlZmluZWQgKSB7Cgl3aW5kb3cualF1ZXJ5ID0gd2luZG93LiQgPSBqUXVlcnk7Cn0KCgoKCnJldHVybiBqUXVlcnk7Cgp9KSk7CgpkZWZpbmUoJ2pxdWVyeS1wcml2YXRlJyxbJ2pxdWVyeSddLCBmdW5jdGlvbiAoanEpIHsKICAgIHJldHVybiBqcS5ub0NvbmZsaWN0KCB0cnVlICk7Cn0pOwoKZGVmaW5lKCd1dGlscycsWyJqcXVlcnkiXSwgZnVuY3Rpb24gKCQpIHsKICAgICQuZm4uaGFzU2Nyb2xsQmFyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCEkLmNvbnRhaW5zKGRvY3VtZW50LCB0aGlzLmdldCgwKSkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLnBhcmVudCgpLmhlaWdodCgpIDwgdGhpcy5nZXQoMCkuc2Nyb2xsSGVpZ2h0KSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwoKICAgICQuZm4uYWRkSHlwZXJsaW5rcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAodGhpcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbiAoaSwgb2JqKSB7CiAgICAgICAgICAgICAgICB2YXIgeCA9ICQob2JqKS5odG1sKCk7CiAgICAgICAgICAgICAgICB2YXIgbGlzdCA9IHgubWF0Y2goL1xiKGh0dHBzPzpcL1wvfHd3d1wufGh0dHBzPzpcL1wvd3d3XC4pW15cczxdezIsMjAwfVxiL2cgKTsKICAgICAgICAgICAgICAgIGlmIChsaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpPTA7IGk8bGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJvdCA9IGxpc3RbaV0uaW5kZXhPZignaHR0cDovLycpID09PSAwIHx8IGxpc3RbaV0uaW5kZXhPZignaHR0cHM6Ly8nKSA9PT0gMCA/ICcnIDogJ2h0dHA6Ly8nOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXNjYXBlZF91cmwgPSBlbmNvZGVVUkkoZGVjb2RlVVJJKGxpc3RbaV0pKS5yZXBsYWNlKC9bIScoKV0vZywgZXNjYXBlKS5yZXBsYWNlKC9cKi9nLCAiJTJBIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHggPSB4LnJlcGxhY2UobGlzdFtpXSwgIjxhIHRhcmdldD0nX2JsYW5rJyBocmVmPSciICsgcHJvdCArIGVzY2FwZWRfdXJsICsgIic+IisgbGlzdFtpXSArICI8L2E+IiApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICQob2JqKS5odG1sKHgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIHZhciB1dGlscyA9IHsKICAgICAgICAvLyBUcmFuc2xhdGlvbiBtYWNoaW5lcnkKICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBfXzogZnVuY3Rpb24gKHN0cikgewogICAgICAgICAgICAvLyBUcmFuc2xhdGlvbiBmYWN0b3J5CiAgICAgICAgICAgIGlmICh0aGlzLmkxOG4gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhpcy5pMThuID0gbG9jYWxlcy5lbjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdCA9IHRoaXMuaTE4bi50cmFuc2xhdGUoc3RyKTsKICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGg+MSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHQuZmV0Y2guYXBwbHkodCwgW10uc2xpY2UuY2FsbChhcmd1bWVudHMsMSkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHQuZmV0Y2goKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIF9fXzogZnVuY3Rpb24gKHN0cikgewogICAgICAgICAgICAvKiBYWFg6IFRoaXMgaXMgcGFydCBvZiBhIGhhY2sgdG8gZ2V0IGdldHRleHQgdG8gc2NhbiBzdHJpbmdzIHRvIGJlCiAgICAgICAgICAgICAgICAqIHRyYW5zbGF0ZWQuIFN0cmluZ3Mgd2UgY2Fubm90IHNlbmQgdG8gdGhlIGZ1bmN0aW9uIGFib3ZlIGJlY2F1c2UKICAgICAgICAgICAgICAgICogdGhleSByZXF1aXJlIHZhcmlhYmxlIGludGVycG9sYXRpb24gYW5kIHdlIGRvbid0IHlldCBoYXZlIHRoZQogICAgICAgICAgICAgICAgKiB2YXJpYWJsZXMgYXQgc2NhbiB0aW1lLgogICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgKiBTZWUgYWN0aW9uSW5mb01lc3NhZ2VzCiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICByZXR1cm4gc3RyOwogICAgICAgIH0KICAgIH07CiAgICByZXR1cm4gdXRpbHM7Cn0pOwoKLy8hIG1vbWVudC5qcwovLyEgdmVyc2lvbiA6IDIuNi4wCi8vISBhdXRob3JzIDogVGltIFdvb2QsIElza3JlbiBDaGVybmV2LCBNb21lbnQuanMgY29udHJpYnV0b3JzCi8vISBsaWNlbnNlIDogTUlUCi8vISBtb21lbnRqcy5jb20KCihmdW5jdGlvbiAodW5kZWZpbmVkKSB7CgogICAgLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgogICAgICAgIENvbnN0YW50cwogICAgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwoKICAgIHZhciBtb21lbnQsCiAgICAgICAgVkVSU0lPTiA9ICIyLjYuMCIsCiAgICAgICAgLy8gdGhlIGdsb2JhbC1zY29wZSB0aGlzIGlzIE5PVCB0aGUgZ2xvYmFsIG9iamVjdCBpbiBOb2RlLmpzCiAgICAgICAgZ2xvYmFsU2NvcGUgPSB0eXBlb2YgZ2xvYmFsICE9PSAndW5kZWZpbmVkJyA/IGdsb2JhbCA6IHRoaXMsCiAgICAgICAgb2xkR2xvYmFsTW9tZW50LAogICAgICAgIHJvdW5kID0gTWF0aC5yb3VuZCwKICAgICAgICBpLAoKICAgICAgICBZRUFSID0gMCwKICAgICAgICBNT05USCA9IDEsCiAgICAgICAgREFURSA9IDIsCiAgICAgICAgSE9VUiA9IDMsCiAgICAgICAgTUlOVVRFID0gNCwKICAgICAgICBTRUNPTkQgPSA1LAogICAgICAgIE1JTExJU0VDT05EID0gNiwKCiAgICAgICAgLy8gaW50ZXJuYWwgc3RvcmFnZSBmb3IgbGFuZ3VhZ2UgY29uZmlnIGZpbGVzCiAgICAgICAgbGFuZ3VhZ2VzID0ge30sCgogICAgICAgIC8vIG1vbWVudCBpbnRlcm5hbCBwcm9wZXJ0aWVzCiAgICAgICAgbW9tZW50UHJvcGVydGllcyA9IHsKICAgICAgICAgICAgX2lzQU1vbWVudE9iamVjdDogbnVsbCwKICAgICAgICAgICAgX2kgOiBudWxsLAogICAgICAgICAgICBfZiA6IG51bGwsCiAgICAgICAgICAgIF9sIDogbnVsbCwKICAgICAgICAgICAgX3N0cmljdCA6IG51bGwsCiAgICAgICAgICAgIF9pc1VUQyA6IG51bGwsCiAgICAgICAgICAgIF9vZmZzZXQgOiBudWxsLCAgLy8gb3B0aW9uYWwuIENvbWJpbmUgd2l0aCBfaXNVVEMKICAgICAgICAgICAgX3BmIDogbnVsbCwKICAgICAgICAgICAgX2xhbmcgOiBudWxsICAvLyBvcHRpb25hbAogICAgICAgIH0sCgogICAgICAgIC8vIGNoZWNrIGZvciBub2RlSlMKICAgICAgICBoYXNNb2R1bGUgPSAodHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgJiYgbW9kdWxlLmV4cG9ydHMpLAoKICAgICAgICAvLyBBU1AuTkVUIGpzb24gZGF0ZSBmb3JtYXQgcmVnZXgKICAgICAgICBhc3BOZXRKc29uUmVnZXggPSAvXlwvP0RhdGVcKChcLT9cZCspL2ksCiAgICAgICAgYXNwTmV0VGltZVNwYW5Kc29uUmVnZXggPSAvKFwtKT8oPzooXGQqKVwuKT8oXGQrKVw6KFxkKykoPzpcOihcZCspXC4/KFxkezN9KT8pPy8sCgogICAgICAgIC8vIGZyb20gaHR0cDovL2RvY3MuY2xvc3VyZS1saWJyYXJ5Lmdvb2dsZWNvZGUuY29tL2dpdC9jbG9zdXJlX2dvb2dfZGF0ZV9kYXRlLmpzLnNvdXJjZS5odG1sCiAgICAgICAgLy8gc29tZXdoYXQgbW9yZSBpbiBsaW5lIHdpdGggNC40LjMuMiAyMDA0IHNwZWMsIGJ1dCBhbGxvd3MgZGVjaW1hbCBhbnl3aGVyZQogICAgICAgIGlzb0R1cmF0aW9uUmVnZXggPSAvXigtKT9QKD86KD86KFswLTksLl0qKVkpPyg/OihbMC05LC5dKilNKT8oPzooWzAtOSwuXSopRCk/KD86VCg/OihbMC05LC5dKilIKT8oPzooWzAtOSwuXSopTSk/KD86KFswLTksLl0qKVMpPyk/fChbMC05LC5dKilXKSQvLAoKICAgICAgICAvLyBmb3JtYXQgdG9rZW5zCiAgICAgICAgZm9ybWF0dGluZ1Rva2VucyA9IC8oXFtbXlxbXSpcXSl8KFxcKT8oTW98TU0/TT9NP3xEb3xERERvfEREP0Q/RD98ZGRkP2Q/fGRvP3x3W298d10/fFdbb3xXXT98UXxZWVlZWVl8WVlZWVl8WVlZWXxZWXxnZyhnZ2c/KT98R0coR0dHPyk/fGV8RXxhfEF8aGg/fEhIP3xtbT98c3M/fFN7MSw0fXxYfHp6P3xaWj98LikvZywKICAgICAgICBsb2NhbEZvcm1hdHRpbmdUb2tlbnMgPSAvKFxbW15cW10qXF0pfChcXCk/KExUfExMP0w/TD98bHsxLDR9KS9nLAoKICAgICAgICAvLyBwYXJzaW5nIHRva2VuIHJlZ2V4ZXMKICAgICAgICBwYXJzZVRva2VuT25lT3JUd29EaWdpdHMgPSAvXGRcZD8vLCAvLyAwIC0gOTkKICAgICAgICBwYXJzZVRva2VuT25lVG9UaHJlZURpZ2l0cyA9IC9cZHsxLDN9LywgLy8gMCAtIDk5OQogICAgICAgIHBhcnNlVG9rZW5PbmVUb0ZvdXJEaWdpdHMgPSAvXGR7MSw0fS8sIC8vIDAgLSA5OTk5CiAgICAgICAgcGFyc2VUb2tlbk9uZVRvU2l4RGlnaXRzID0gL1srXC1dP1xkezEsNn0vLCAvLyAtOTk5LDk5OSAtIDk5OSw5OTkKICAgICAgICBwYXJzZVRva2VuRGlnaXRzID0gL1xkKy8sIC8vIG5vbnplcm8gbnVtYmVyIG9mIGRpZ2l0cwogICAgICAgIHBhcnNlVG9rZW5Xb3JkID0gL1swLTldKlsnYS16XHUwMEEwLVx1MDVGRlx1MDcwMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0rfFtcdTA2MDAtXHUwNkZGXC9dKyhccyo/W1x1MDYwMC1cdTA2RkZdKyl7MSwyfS9pLCAvLyBhbnkgd29yZCAob3IgdHdvKSBjaGFyYWN0ZXJzIG9yIG51bWJlcnMgaW5jbHVkaW5nIHR3by90aHJlZSB3b3JkIG1vbnRoIGluIGFyYWJpYy4KICAgICAgICBwYXJzZVRva2VuVGltZXpvbmUgPSAvWnxbXCtcLV1cZFxkOj9cZFxkL2dpLCAvLyArMDA6MDAgLTAwOjAwICswMDAwIC0wMDAwIG9yIFoKICAgICAgICBwYXJzZVRva2VuVCA9IC9UL2ksIC8vIFQgKElTTyBzZXBhcmF0b3IpCiAgICAgICAgcGFyc2VUb2tlblRpbWVzdGFtcE1zID0gL1tcK1wtXT9cZCsoXC5cZHsxLDN9KT8vLCAvLyAxMjM0NTY3ODkgMTIzNDU2Nzg5LjEyMwogICAgICAgIHBhcnNlVG9rZW5PcmRpbmFsID0gL1xkezEsMn0vLAoKICAgICAgICAvL3N0cmljdCBwYXJzaW5nIHJlZ2V4ZXMKICAgICAgICBwYXJzZVRva2VuT25lRGlnaXQgPSAvXGQvLCAvLyAwIC0gOQogICAgICAgIHBhcnNlVG9rZW5Ud29EaWdpdHMgPSAvXGRcZC8sIC8vIDAwIC0gOTkKICAgICAgICBwYXJzZVRva2VuVGhyZWVEaWdpdHMgPSAvXGR7M30vLCAvLyAwMDAgLSA5OTkKICAgICAgICBwYXJzZVRva2VuRm91ckRpZ2l0cyA9IC9cZHs0fS8sIC8vIDAwMDAgLSA5OTk5CiAgICAgICAgcGFyc2VUb2tlblNpeERpZ2l0cyA9IC9bKy1dP1xkezZ9LywgLy8gLTk5OSw5OTkgLSA5OTksOTk5CiAgICAgICAgcGFyc2VUb2tlblNpZ25lZE51bWJlciA9IC9bKy1dP1xkKy8sIC8vIC1pbmYgLSBpbmYKCiAgICAgICAgLy8gaXNvIDg2MDEgcmVnZXgKICAgICAgICAvLyAwMDAwLTAwLTAwIDAwMDAtVzAwIG9yIDAwMDAtVzAwLTAgKyBUICsgMDAgb3IgMDA6MDAgb3IgMDA6MDA6MDAgb3IgMDA6MDA6MDAuMDAwICsgKzAwOjAwIG9yICswMDAwIG9yICswMCkKICAgICAgICBpc29SZWdleCA9IC9eXHMqKD86WystXVxkezZ9fFxkezR9KS0oPzooXGRcZC1cZFxkKXwoV1xkXGQkKXwoV1xkXGQtXGQpfChcZFxkXGQpKSgoVHwgKShcZFxkKDpcZFxkKDpcZFxkKFwuXGQrKT8pPyk/KT8oW1wrXC1dXGRcZCg/Ojo/XGRcZCk/fFxzKlopPyk/JC8sCgogICAgICAgIGlzb0Zvcm1hdCA9ICdZWVlZLU1NLUREVEhIOm1tOnNzWicsCgogICAgICAgIGlzb0RhdGVzID0gWwogICAgICAgICAgICBbJ1lZWVlZWS1NTS1ERCcsIC9bKy1dXGR7Nn0tXGR7Mn0tXGR7Mn0vXSwKICAgICAgICAgICAgWydZWVlZLU1NLUREJywgL1xkezR9LVxkezJ9LVxkezJ9L10sCiAgICAgICAgICAgIFsnR0dHRy1bV11XVy1FJywgL1xkezR9LVdcZHsyfS1cZC9dLAogICAgICAgICAgICBbJ0dHR0ctW1ddV1cnLCAvXGR7NH0tV1xkezJ9L10sCiAgICAgICAgICAgIFsnWVlZWS1EREQnLCAvXGR7NH0tXGR7M30vXQogICAgICAgIF0sCgogICAgICAgIC8vIGlzbyB0aW1lIGZvcm1hdHMgYW5kIHJlZ2V4ZXMKICAgICAgICBpc29UaW1lcyA9IFsKICAgICAgICAgICAgWydISDptbTpzcy5TU1NTJywgLyhUfCApXGRcZDpcZFxkOlxkXGRcLlxkKy9dLAogICAgICAgICAgICBbJ0hIOm1tOnNzJywgLyhUfCApXGRcZDpcZFxkOlxkXGQvXSwKICAgICAgICAgICAgWydISDptbScsIC8oVHwgKVxkXGQ6XGRcZC9dLAogICAgICAgICAgICBbJ0hIJywgLyhUfCApXGRcZC9dCiAgICAgICAgXSwKCiAgICAgICAgLy8gdGltZXpvbmUgY2h1bmtlciAiKzEwOjAwIiA+IFsiMTAiLCAiMDAiXSBvciAiLTE1MzAiID4gWyItMTUiLCAiMzAiXQogICAgICAgIHBhcnNlVGltZXpvbmVDaHVua2VyID0gLyhbXCtcLV18XGRcZCkvZ2ksCgogICAgICAgIC8vIGdldHRlciBhbmQgc2V0dGVyIG5hbWVzCiAgICAgICAgcHJveHlHZXR0ZXJzQW5kU2V0dGVycyA9ICdEYXRlfEhvdXJzfE1pbnV0ZXN8U2Vjb25kc3xNaWxsaXNlY29uZHMnLnNwbGl0KCd8JyksCiAgICAgICAgdW5pdE1pbGxpc2Vjb25kRmFjdG9ycyA9IHsKICAgICAgICAgICAgJ01pbGxpc2Vjb25kcycgOiAxLAogICAgICAgICAgICAnU2Vjb25kcycgOiAxZTMsCiAgICAgICAgICAgICdNaW51dGVzJyA6IDZlNCwKICAgICAgICAgICAgJ0hvdXJzJyA6IDM2ZTUsCiAgICAgICAgICAgICdEYXlzJyA6IDg2NGU1LAogICAgICAgICAgICAnTW9udGhzJyA6IDI1OTJlNiwKICAgICAgICAgICAgJ1llYXJzJyA6IDMxNTM2ZTYKICAgICAgICB9LAoKICAgICAgICB1bml0QWxpYXNlcyA9IHsKICAgICAgICAgICAgbXMgOiAnbWlsbGlzZWNvbmQnLAogICAgICAgICAgICBzIDogJ3NlY29uZCcsCiAgICAgICAgICAgIG0gOiAnbWludXRlJywKICAgICAgICAgICAgaCA6ICdob3VyJywKICAgICAgICAgICAgZCA6ICdkYXknLAogICAgICAgICAgICBEIDogJ2RhdGUnLAogICAgICAgICAgICB3IDogJ3dlZWsnLAogICAgICAgICAgICBXIDogJ2lzb1dlZWsnLAogICAgICAgICAgICBNIDogJ21vbnRoJywKICAgICAgICAgICAgUSA6ICdxdWFydGVyJywKICAgICAgICAgICAgeSA6ICd5ZWFyJywKICAgICAgICAgICAgREREIDogJ2RheU9mWWVhcicsCiAgICAgICAgICAgIGUgOiAnd2Vla2RheScsCiAgICAgICAgICAgIEUgOiAnaXNvV2Vla2RheScsCiAgICAgICAgICAgIGdnOiAnd2Vla1llYXInLAogICAgICAgICAgICBHRzogJ2lzb1dlZWtZZWFyJwogICAgICAgIH0sCgogICAgICAgIGNhbWVsRnVuY3Rpb25zID0gewogICAgICAgICAgICBkYXlvZnllYXIgOiAnZGF5T2ZZZWFyJywKICAgICAgICAgICAgaXNvd2Vla2RheSA6ICdpc29XZWVrZGF5JywKICAgICAgICAgICAgaXNvd2VlayA6ICdpc29XZWVrJywKICAgICAgICAgICAgd2Vla3llYXIgOiAnd2Vla1llYXInLAogICAgICAgICAgICBpc293ZWVreWVhciA6ICdpc29XZWVrWWVhcicKICAgICAgICB9LAoKICAgICAgICAvLyBmb3JtYXQgZnVuY3Rpb24gc3RyaW5ncwogICAgICAgIGZvcm1hdEZ1bmN0aW9ucyA9IHt9LAoKICAgICAgICAvLyB0b2tlbnMgdG8gb3JkaW5hbGl6ZSBhbmQgcGFkCiAgICAgICAgb3JkaW5hbGl6ZVRva2VucyA9ICdEREQgdyBXIE0gRCBkJy5zcGxpdCgnICcpLAogICAgICAgIHBhZGRlZFRva2VucyA9ICdNIEQgSCBoIG0gcyB3IFcnLnNwbGl0KCcgJyksCgogICAgICAgIGZvcm1hdFRva2VuRnVuY3Rpb25zID0gewogICAgICAgICAgICBNICAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubW9udGgoKSArIDE7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIE1NTSAgOiBmdW5jdGlvbiAoZm9ybWF0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sYW5nKCkubW9udGhzU2hvcnQodGhpcywgZm9ybWF0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgTU1NTSA6IGZ1bmN0aW9uIChmb3JtYXQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxhbmcoKS5tb250aHModGhpcywgZm9ybWF0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgRCAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRhdGUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgREREICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRheU9mWWVhcigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBkICAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGF5KCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRkICAgOiBmdW5jdGlvbiAoZm9ybWF0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sYW5nKCkud2Vla2RheXNNaW4odGhpcywgZm9ybWF0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGRkICA6IGZ1bmN0aW9uIChmb3JtYXQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxhbmcoKS53ZWVrZGF5c1Nob3J0KHRoaXMsIGZvcm1hdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRkZGQgOiBmdW5jdGlvbiAoZm9ybWF0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sYW5nKCkud2Vla2RheXModGhpcywgZm9ybWF0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdyAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLndlZWsoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgVyAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmlzb1dlZWsoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgWVkgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0WmVyb0ZpbGwodGhpcy55ZWFyKCkgJSAxMDAsIDIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBZWVlZIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRaZXJvRmlsbCh0aGlzLnllYXIoKSwgNCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFlZWVlZIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRaZXJvRmlsbCh0aGlzLnllYXIoKSwgNSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFlZWVlZWSA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciB5ID0gdGhpcy55ZWFyKCksIHNpZ24gPSB5ID49IDAgPyAnKycgOiAnLSc7CiAgICAgICAgICAgICAgICByZXR1cm4gc2lnbiArIGxlZnRaZXJvRmlsbChNYXRoLmFicyh5KSwgNik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdnICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFplcm9GaWxsKHRoaXMud2Vla1llYXIoKSAlIDEwMCwgMik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdnZ2cgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFplcm9GaWxsKHRoaXMud2Vla1llYXIoKSwgNCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdnZ2dnIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRaZXJvRmlsbCh0aGlzLndlZWtZZWFyKCksIDUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBHRyAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRaZXJvRmlsbCh0aGlzLmlzb1dlZWtZZWFyKCkgJSAxMDAsIDIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBHR0dHIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRaZXJvRmlsbCh0aGlzLmlzb1dlZWtZZWFyKCksIDQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBHR0dHRyA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0WmVyb0ZpbGwodGhpcy5pc29XZWVrWWVhcigpLCA1KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZSA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLndlZWtkYXkoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgRSA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmlzb1dlZWtkYXkoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgYSAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxhbmcoKS5tZXJpZGllbSh0aGlzLmhvdXJzKCksIHRoaXMubWludXRlcygpLCB0cnVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgQSAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxhbmcoKS5tZXJpZGllbSh0aGlzLmhvdXJzKCksIHRoaXMubWludXRlcygpLCBmYWxzZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIEggICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5ob3VycygpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBoICAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaG91cnMoKSAlIDEyIHx8IDEyOwogICAgICAgICAgICB9LAogICAgICAgICAgICBtICAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubWludXRlcygpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzICAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2Vjb25kcygpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBTICAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRvSW50KHRoaXMubWlsbGlzZWNvbmRzKCkgLyAxMDApOwogICAgICAgICAgICB9LAogICAgICAgICAgICBTUyAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRaZXJvRmlsbCh0b0ludCh0aGlzLm1pbGxpc2Vjb25kcygpIC8gMTApLCAyKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgU1NTICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0WmVyb0ZpbGwodGhpcy5taWxsaXNlY29uZHMoKSwgMyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFNTU1MgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFplcm9GaWxsKHRoaXMubWlsbGlzZWNvbmRzKCksIDMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBaICAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGEgPSAtdGhpcy56b25lKCksCiAgICAgICAgICAgICAgICAgICAgYiA9ICIrIjsKICAgICAgICAgICAgICAgIGlmIChhIDwgMCkgewogICAgICAgICAgICAgICAgICAgIGEgPSAtYTsKICAgICAgICAgICAgICAgICAgICBiID0gIi0iOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGIgKyBsZWZ0WmVyb0ZpbGwodG9JbnQoYSAvIDYwKSwgMikgKyAiOiIgKyBsZWZ0WmVyb0ZpbGwodG9JbnQoYSkgJSA2MCwgMik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFpaICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgYSA9IC10aGlzLnpvbmUoKSwKICAgICAgICAgICAgICAgICAgICBiID0gIisiOwogICAgICAgICAgICAgICAgaWYgKGEgPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgYSA9IC1hOwogICAgICAgICAgICAgICAgICAgIGIgPSAiLSI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gYiArIGxlZnRaZXJvRmlsbCh0b0ludChhIC8gNjApLCAyKSArIGxlZnRaZXJvRmlsbCh0b0ludChhKSAlIDYwLCAyKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgeiA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnpvbmVBYmJyKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHp6IDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuem9uZU5hbWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgWCAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnVuaXgoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgUSA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnF1YXJ0ZXIoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGxpc3RzID0gWydtb250aHMnLCAnbW9udGhzU2hvcnQnLCAnd2Vla2RheXMnLCAnd2Vla2RheXNTaG9ydCcsICd3ZWVrZGF5c01pbiddOwoKICAgIGZ1bmN0aW9uIGRlZmF1bHRQYXJzaW5nRmxhZ3MoKSB7CiAgICAgICAgLy8gV2UgbmVlZCB0byBkZWVwIGNsb25lIHRoaXMgb2JqZWN0LCBhbmQgZXM1IHN0YW5kYXJkIGlzIG5vdCB2ZXJ5CiAgICAgICAgLy8gaGVscGZ1bC4KICAgICAgICByZXR1cm4gewogICAgICAgICAgICBlbXB0eSA6IGZhbHNlLAogICAgICAgICAgICB1bnVzZWRUb2tlbnMgOiBbXSwKICAgICAgICAgICAgdW51c2VkSW5wdXQgOiBbXSwKICAgICAgICAgICAgb3ZlcmZsb3cgOiAtMiwKICAgICAgICAgICAgY2hhcnNMZWZ0T3ZlciA6IDAsCiAgICAgICAgICAgIG51bGxJbnB1dCA6IGZhbHNlLAogICAgICAgICAgICBpbnZhbGlkTW9udGggOiBudWxsLAogICAgICAgICAgICBpbnZhbGlkRm9ybWF0IDogZmFsc2UsCiAgICAgICAgICAgIHVzZXJJbnZhbGlkYXRlZCA6IGZhbHNlLAogICAgICAgICAgICBpc286IGZhbHNlCiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBkZXByZWNhdGUobXNnLCBmbikgewogICAgICAgIHZhciBmaXJzdFRpbWUgPSB0cnVlOwogICAgICAgIGZ1bmN0aW9uIHByaW50TXNnKCkgewogICAgICAgICAgICBpZiAobW9tZW50LnN1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5ncyA9PT0gZmFsc2UgJiYKICAgICAgICAgICAgICAgICAgICB0eXBlb2YgY29uc29sZSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29uc29sZS53YXJuKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkRlcHJlY2F0aW9uIHdhcm5pbmc6ICIgKyBtc2cpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoZmlyc3RUaW1lKSB7CiAgICAgICAgICAgICAgICBwcmludE1zZygpOwogICAgICAgICAgICAgICAgZmlyc3RUaW1lID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfSwgZm4pOwogICAgfQoKICAgIGZ1bmN0aW9uIHBhZFRva2VuKGZ1bmMsIGNvdW50KSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgIHJldHVybiBsZWZ0WmVyb0ZpbGwoZnVuYy5jYWxsKHRoaXMsIGEpLCBjb3VudCk7CiAgICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIG9yZGluYWxpemVUb2tlbihmdW5jLCBwZXJpb2QpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGFuZygpLm9yZGluYWwoZnVuYy5jYWxsKHRoaXMsIGEpLCBwZXJpb2QpOwogICAgICAgIH07CiAgICB9CgogICAgd2hpbGUgKG9yZGluYWxpemVUb2tlbnMubGVuZ3RoKSB7CiAgICAgICAgaSA9IG9yZGluYWxpemVUb2tlbnMucG9wKCk7CiAgICAgICAgZm9ybWF0VG9rZW5GdW5jdGlvbnNbaSArICdvJ10gPSBvcmRpbmFsaXplVG9rZW4oZm9ybWF0VG9rZW5GdW5jdGlvbnNbaV0sIGkpOwogICAgfQogICAgd2hpbGUgKHBhZGRlZFRva2Vucy5sZW5ndGgpIHsKICAgICAgICBpID0gcGFkZGVkVG9rZW5zLnBvcCgpOwogICAgICAgIGZvcm1hdFRva2VuRnVuY3Rpb25zW2kgKyBpXSA9IHBhZFRva2VuKGZvcm1hdFRva2VuRnVuY3Rpb25zW2ldLCAyKTsKICAgIH0KICAgIGZvcm1hdFRva2VuRnVuY3Rpb25zLkREREQgPSBwYWRUb2tlbihmb3JtYXRUb2tlbkZ1bmN0aW9ucy5EREQsIDMpOwoKCiAgICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICAgICAgQ29uc3RydWN0b3JzCiAgICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCgogICAgZnVuY3Rpb24gTGFuZ3VhZ2UoKSB7CgogICAgfQoKICAgIC8vIE1vbWVudCBwcm90b3R5cGUgb2JqZWN0CiAgICBmdW5jdGlvbiBNb21lbnQoY29uZmlnKSB7CiAgICAgICAgY2hlY2tPdmVyZmxvdyhjb25maWcpOwogICAgICAgIGV4dGVuZCh0aGlzLCBjb25maWcpOwogICAgfQoKICAgIC8vIER1cmF0aW9uIENvbnN0cnVjdG9yCiAgICBmdW5jdGlvbiBEdXJhdGlvbihkdXJhdGlvbikgewogICAgICAgIHZhciBub3JtYWxpemVkSW5wdXQgPSBub3JtYWxpemVPYmplY3RVbml0cyhkdXJhdGlvbiksCiAgICAgICAgICAgIHllYXJzID0gbm9ybWFsaXplZElucHV0LnllYXIgfHwgMCwKICAgICAgICAgICAgcXVhcnRlcnMgPSBub3JtYWxpemVkSW5wdXQucXVhcnRlciB8fCAwLAogICAgICAgICAgICBtb250aHMgPSBub3JtYWxpemVkSW5wdXQubW9udGggfHwgMCwKICAgICAgICAgICAgd2Vla3MgPSBub3JtYWxpemVkSW5wdXQud2VlayB8fCAwLAogICAgICAgICAgICBkYXlzID0gbm9ybWFsaXplZElucHV0LmRheSB8fCAwLAogICAgICAgICAgICBob3VycyA9IG5vcm1hbGl6ZWRJbnB1dC5ob3VyIHx8IDAsCiAgICAgICAgICAgIG1pbnV0ZXMgPSBub3JtYWxpemVkSW5wdXQubWludXRlIHx8IDAsCiAgICAgICAgICAgIHNlY29uZHMgPSBub3JtYWxpemVkSW5wdXQuc2Vjb25kIHx8IDAsCiAgICAgICAgICAgIG1pbGxpc2Vjb25kcyA9IG5vcm1hbGl6ZWRJbnB1dC5taWxsaXNlY29uZCB8fCAwOwoKICAgICAgICAvLyByZXByZXNlbnRhdGlvbiBmb3IgZGF0ZUFkZFJlbW92ZQogICAgICAgIHRoaXMuX21pbGxpc2Vjb25kcyA9ICttaWxsaXNlY29uZHMgKwogICAgICAgICAgICBzZWNvbmRzICogMWUzICsgLy8gMTAwMAogICAgICAgICAgICBtaW51dGVzICogNmU0ICsgLy8gMTAwMCAqIDYwCiAgICAgICAgICAgIGhvdXJzICogMzZlNTsgLy8gMTAwMCAqIDYwICogNjAKICAgICAgICAvLyBCZWNhdXNlIG9mIGRhdGVBZGRSZW1vdmUgdHJlYXRzIDI0IGhvdXJzIGFzIGRpZmZlcmVudCBmcm9tIGEKICAgICAgICAvLyBkYXkgd2hlbiB3b3JraW5nIGFyb3VuZCBEU1QsIHdlIG5lZWQgdG8gc3RvcmUgdGhlbSBzZXBhcmF0ZWx5CiAgICAgICAgdGhpcy5fZGF5cyA9ICtkYXlzICsKICAgICAgICAgICAgd2Vla3MgKiA3OwogICAgICAgIC8vIEl0IGlzIGltcG9zc2libGUgdHJhbnNsYXRlIG1vbnRocyBpbnRvIGRheXMgd2l0aG91dCBrbm93aW5nCiAgICAgICAgLy8gd2hpY2ggbW9udGhzIHlvdSBhcmUgYXJlIHRhbGtpbmcgYWJvdXQsIHNvIHdlIGhhdmUgdG8gc3RvcmUKICAgICAgICAvLyBpdCBzZXBhcmF0ZWx5LgogICAgICAgIHRoaXMuX21vbnRocyA9ICttb250aHMgKwogICAgICAgICAgICBxdWFydGVycyAqIDMgKwogICAgICAgICAgICB5ZWFycyAqIDEyOwoKICAgICAgICB0aGlzLl9kYXRhID0ge307CgogICAgICAgIHRoaXMuX2J1YmJsZSgpOwogICAgfQoKICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgICAgICBIZWxwZXJzCiAgICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCgoKICAgIGZ1bmN0aW9uIGV4dGVuZChhLCBiKSB7CiAgICAgICAgZm9yICh2YXIgaSBpbiBiKSB7CiAgICAgICAgICAgIGlmIChiLmhhc093blByb3BlcnR5KGkpKSB7CiAgICAgICAgICAgICAgICBhW2ldID0gYltpXTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGIuaGFzT3duUHJvcGVydHkoInRvU3RyaW5nIikpIHsKICAgICAgICAgICAgYS50b1N0cmluZyA9IGIudG9TdHJpbmc7CiAgICAgICAgfQoKICAgICAgICBpZiAoYi5oYXNPd25Qcm9wZXJ0eSgidmFsdWVPZiIpKSB7CiAgICAgICAgICAgIGEudmFsdWVPZiA9IGIudmFsdWVPZjsKICAgICAgICB9CgogICAgICAgIHJldHVybiBhOwogICAgfQoKICAgIGZ1bmN0aW9uIGNsb25lTW9tZW50KG0pIHsKICAgICAgICB2YXIgcmVzdWx0ID0ge30sIGk7CiAgICAgICAgZm9yIChpIGluIG0pIHsKICAgICAgICAgICAgaWYgKG0uaGFzT3duUHJvcGVydHkoaSkgJiYgbW9tZW50UHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShpKSkgewogICAgICAgICAgICAgICAgcmVzdWx0W2ldID0gbVtpXTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICBmdW5jdGlvbiBhYnNSb3VuZChudW1iZXIpIHsKICAgICAgICBpZiAobnVtYmVyIDwgMCkgewogICAgICAgICAgICByZXR1cm4gTWF0aC5jZWlsKG51bWJlcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IobnVtYmVyKTsKICAgICAgICB9CiAgICB9CgogICAgLy8gbGVmdCB6ZXJvIGZpbGwgYSBudW1iZXIKICAgIC8vIHNlZSBodHRwOi8vanNwZXJmLmNvbS9sZWZ0LXplcm8tZmlsbGluZyBmb3IgcGVyZm9ybWFuY2UgY29tcGFyaXNvbgogICAgZnVuY3Rpb24gbGVmdFplcm9GaWxsKG51bWJlciwgdGFyZ2V0TGVuZ3RoLCBmb3JjZVNpZ24pIHsKICAgICAgICB2YXIgb3V0cHV0ID0gJycgKyBNYXRoLmFicyhudW1iZXIpLAogICAgICAgICAgICBzaWduID0gbnVtYmVyID49IDA7CgogICAgICAgIHdoaWxlIChvdXRwdXQubGVuZ3RoIDwgdGFyZ2V0TGVuZ3RoKSB7CiAgICAgICAgICAgIG91dHB1dCA9ICcwJyArIG91dHB1dDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIChzaWduID8gKGZvcmNlU2lnbiA/ICcrJyA6ICcnKSA6ICctJykgKyBvdXRwdXQ7CiAgICB9CgogICAgLy8gaGVscGVyIGZ1bmN0aW9uIGZvciBfLmFkZFRpbWUgYW5kIF8uc3VidHJhY3RUaW1lCiAgICBmdW5jdGlvbiBhZGRPclN1YnRyYWN0RHVyYXRpb25Gcm9tTW9tZW50KG1vbSwgZHVyYXRpb24sIGlzQWRkaW5nLCB1cGRhdGVPZmZzZXQpIHsKICAgICAgICB2YXIgbWlsbGlzZWNvbmRzID0gZHVyYXRpb24uX21pbGxpc2Vjb25kcywKICAgICAgICAgICAgZGF5cyA9IGR1cmF0aW9uLl9kYXlzLAogICAgICAgICAgICBtb250aHMgPSBkdXJhdGlvbi5fbW9udGhzOwogICAgICAgIHVwZGF0ZU9mZnNldCA9IHVwZGF0ZU9mZnNldCA9PSBudWxsID8gdHJ1ZSA6IHVwZGF0ZU9mZnNldDsKCiAgICAgICAgaWYgKG1pbGxpc2Vjb25kcykgewogICAgICAgICAgICBtb20uX2Quc2V0VGltZSgrbW9tLl9kICsgbWlsbGlzZWNvbmRzICogaXNBZGRpbmcpOwogICAgICAgIH0KICAgICAgICBpZiAoZGF5cykgewogICAgICAgICAgICByYXdTZXR0ZXIobW9tLCAnRGF0ZScsIHJhd0dldHRlcihtb20sICdEYXRlJykgKyBkYXlzICogaXNBZGRpbmcpOwogICAgICAgIH0KICAgICAgICBpZiAobW9udGhzKSB7CiAgICAgICAgICAgIHJhd01vbnRoU2V0dGVyKG1vbSwgcmF3R2V0dGVyKG1vbSwgJ01vbnRoJykgKyBtb250aHMgKiBpc0FkZGluZyk7CiAgICAgICAgfQogICAgICAgIGlmICh1cGRhdGVPZmZzZXQpIHsKICAgICAgICAgICAgbW9tZW50LnVwZGF0ZU9mZnNldChtb20sIGRheXMgfHwgbW9udGhzKTsKICAgICAgICB9CiAgICB9CgogICAgLy8gY2hlY2sgaWYgaXMgYW4gYXJyYXkKICAgIGZ1bmN0aW9uIGlzQXJyYXkoaW5wdXQpIHsKICAgICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGlucHV0KSA9PT0gJ1tvYmplY3QgQXJyYXldJzsKICAgIH0KCiAgICBmdW5jdGlvbiBpc0RhdGUoaW5wdXQpIHsKICAgICAgICByZXR1cm4gIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChpbnB1dCkgPT09ICdbb2JqZWN0IERhdGVdJyB8fAogICAgICAgICAgICAgICAgaW5wdXQgaW5zdGFuY2VvZiBEYXRlOwogICAgfQoKICAgIC8vIGNvbXBhcmUgdHdvIGFycmF5cywgcmV0dXJuIHRoZSBudW1iZXIgb2YgZGlmZmVyZW5jZXMKICAgIGZ1bmN0aW9uIGNvbXBhcmVBcnJheXMoYXJyYXkxLCBhcnJheTIsIGRvbnRDb252ZXJ0KSB7CiAgICAgICAgdmFyIGxlbiA9IE1hdGgubWluKGFycmF5MS5sZW5ndGgsIGFycmF5Mi5sZW5ndGgpLAogICAgICAgICAgICBsZW5ndGhEaWZmID0gTWF0aC5hYnMoYXJyYXkxLmxlbmd0aCAtIGFycmF5Mi5sZW5ndGgpLAogICAgICAgICAgICBkaWZmcyA9IDAsCiAgICAgICAgICAgIGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmICgoZG9udENvbnZlcnQgJiYgYXJyYXkxW2ldICE9PSBhcnJheTJbaV0pIHx8CiAgICAgICAgICAgICAgICAoIWRvbnRDb252ZXJ0ICYmIHRvSW50KGFycmF5MVtpXSkgIT09IHRvSW50KGFycmF5MltpXSkpKSB7CiAgICAgICAgICAgICAgICBkaWZmcysrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBkaWZmcyArIGxlbmd0aERpZmY7CiAgICB9CgogICAgZnVuY3Rpb24gbm9ybWFsaXplVW5pdHModW5pdHMpIHsKICAgICAgICBpZiAodW5pdHMpIHsKICAgICAgICAgICAgdmFyIGxvd2VyZWQgPSB1bml0cy50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoLyguKXMkLywgJyQxJyk7CiAgICAgICAgICAgIHVuaXRzID0gdW5pdEFsaWFzZXNbdW5pdHNdIHx8IGNhbWVsRnVuY3Rpb25zW2xvd2VyZWRdIHx8IGxvd2VyZWQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiB1bml0czsKICAgIH0KCiAgICBmdW5jdGlvbiBub3JtYWxpemVPYmplY3RVbml0cyhpbnB1dE9iamVjdCkgewogICAgICAgIHZhciBub3JtYWxpemVkSW5wdXQgPSB7fSwKICAgICAgICAgICAgbm9ybWFsaXplZFByb3AsCiAgICAgICAgICAgIHByb3A7CgogICAgICAgIGZvciAocHJvcCBpbiBpbnB1dE9iamVjdCkgewogICAgICAgICAgICBpZiAoaW5wdXRPYmplY3QuaGFzT3duUHJvcGVydHkocHJvcCkpIHsKICAgICAgICAgICAgICAgIG5vcm1hbGl6ZWRQcm9wID0gbm9ybWFsaXplVW5pdHMocHJvcCk7CiAgICAgICAgICAgICAgICBpZiAobm9ybWFsaXplZFByb3ApIHsKICAgICAgICAgICAgICAgICAgICBub3JtYWxpemVkSW5wdXRbbm9ybWFsaXplZFByb3BdID0gaW5wdXRPYmplY3RbcHJvcF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBub3JtYWxpemVkSW5wdXQ7CiAgICB9CgogICAgZnVuY3Rpb24gbWFrZUxpc3QoZmllbGQpIHsKICAgICAgICB2YXIgY291bnQsIHNldHRlcjsKCiAgICAgICAgaWYgKGZpZWxkLmluZGV4T2YoJ3dlZWsnKSA9PT0gMCkgewogICAgICAgICAgICBjb3VudCA9IDc7CiAgICAgICAgICAgIHNldHRlciA9ICdkYXknOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChmaWVsZC5pbmRleE9mKCdtb250aCcpID09PSAwKSB7CiAgICAgICAgICAgIGNvdW50ID0gMTI7CiAgICAgICAgICAgIHNldHRlciA9ICdtb250aCc7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBtb21lbnRbZmllbGRdID0gZnVuY3Rpb24gKGZvcm1hdCwgaW5kZXgpIHsKICAgICAgICAgICAgdmFyIGksIGdldHRlciwKICAgICAgICAgICAgICAgIG1ldGhvZCA9IG1vbWVudC5mbi5fbGFuZ1tmaWVsZF0sCiAgICAgICAgICAgICAgICByZXN1bHRzID0gW107CgogICAgICAgICAgICBpZiAodHlwZW9mIGZvcm1hdCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgICAgIGluZGV4ID0gZm9ybWF0OwogICAgICAgICAgICAgICAgZm9ybWF0ID0gdW5kZWZpbmVkOwogICAgICAgICAgICB9CgogICAgICAgICAgICBnZXR0ZXIgPSBmdW5jdGlvbiAoaSkgewogICAgICAgICAgICAgICAgdmFyIG0gPSBtb21lbnQoKS51dGMoKS5zZXQoc2V0dGVyLCBpKTsKICAgICAgICAgICAgICAgIHJldHVybiBtZXRob2QuY2FsbChtb21lbnQuZm4uX2xhbmcsIG0sIGZvcm1hdCB8fCAnJyk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpZiAoaW5kZXggIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGdldHRlcihpbmRleCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChnZXR0ZXIoaSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIHRvSW50KGFyZ3VtZW50Rm9yQ29lcmNpb24pIHsKICAgICAgICB2YXIgY29lcmNlZE51bWJlciA9ICthcmd1bWVudEZvckNvZXJjaW9uLAogICAgICAgICAgICB2YWx1ZSA9IDA7CgogICAgICAgIGlmIChjb2VyY2VkTnVtYmVyICE9PSAwICYmIGlzRmluaXRlKGNvZXJjZWROdW1iZXIpKSB7CiAgICAgICAgICAgIGlmIChjb2VyY2VkTnVtYmVyID49IDApIHsKICAgICAgICAgICAgICAgIHZhbHVlID0gTWF0aC5mbG9vcihjb2VyY2VkTnVtYmVyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhbHVlID0gTWF0aC5jZWlsKGNvZXJjZWROdW1iZXIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CgogICAgZnVuY3Rpb24gZGF5c0luTW9udGgoeWVhciwgbW9udGgpIHsKICAgICAgICByZXR1cm4gbmV3IERhdGUoRGF0ZS5VVEMoeWVhciwgbW9udGggKyAxLCAwKSkuZ2V0VVRDRGF0ZSgpOwogICAgfQoKICAgIGZ1bmN0aW9uIHdlZWtzSW5ZZWFyKHllYXIsIGRvdywgZG95KSB7CiAgICAgICAgcmV0dXJuIHdlZWtPZlllYXIobW9tZW50KFt5ZWFyLCAxMSwgMzEgKyBkb3cgLSBkb3ldKSwgZG93LCBkb3kpLndlZWs7CiAgICB9CgogICAgZnVuY3Rpb24gZGF5c0luWWVhcih5ZWFyKSB7CiAgICAgICAgcmV0dXJuIGlzTGVhcFllYXIoeWVhcikgPyAzNjYgOiAzNjU7CiAgICB9CgogICAgZnVuY3Rpb24gaXNMZWFwWWVhcih5ZWFyKSB7CiAgICAgICAgcmV0dXJuICh5ZWFyICUgNCA9PT0gMCAmJiB5ZWFyICUgMTAwICE9PSAwKSB8fCB5ZWFyICUgNDAwID09PSAwOwogICAgfQoKICAgIGZ1bmN0aW9uIGNoZWNrT3ZlcmZsb3cobSkgewogICAgICAgIHZhciBvdmVyZmxvdzsKICAgICAgICBpZiAobS5fYSAmJiBtLl9wZi5vdmVyZmxvdyA9PT0gLTIpIHsKICAgICAgICAgICAgb3ZlcmZsb3cgPQogICAgICAgICAgICAgICAgbS5fYVtNT05USF0gPCAwIHx8IG0uX2FbTU9OVEhdID4gMTEgPyBNT05USCA6CiAgICAgICAgICAgICAgICBtLl9hW0RBVEVdIDwgMSB8fCBtLl9hW0RBVEVdID4gZGF5c0luTW9udGgobS5fYVtZRUFSXSwgbS5fYVtNT05USF0pID8gREFURSA6CiAgICAgICAgICAgICAgICBtLl9hW0hPVVJdIDwgMCB8fCBtLl9hW0hPVVJdID4gMjMgPyBIT1VSIDoKICAgICAgICAgICAgICAgIG0uX2FbTUlOVVRFXSA8IDAgfHwgbS5fYVtNSU5VVEVdID4gNTkgPyBNSU5VVEUgOgogICAgICAgICAgICAgICAgbS5fYVtTRUNPTkRdIDwgMCB8fCBtLl9hW1NFQ09ORF0gPiA1OSA/IFNFQ09ORCA6CiAgICAgICAgICAgICAgICBtLl9hW01JTExJU0VDT05EXSA8IDAgfHwgbS5fYVtNSUxMSVNFQ09ORF0gPiA5OTkgPyBNSUxMSVNFQ09ORCA6CiAgICAgICAgICAgICAgICAtMTsKCiAgICAgICAgICAgIGlmIChtLl9wZi5fb3ZlcmZsb3dEYXlPZlllYXIgJiYgKG92ZXJmbG93IDwgWUVBUiB8fCBvdmVyZmxvdyA+IERBVEUpKSB7CiAgICAgICAgICAgICAgICBvdmVyZmxvdyA9IERBVEU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG0uX3BmLm92ZXJmbG93ID0gb3ZlcmZsb3c7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGlzVmFsaWQobSkgewogICAgICAgIGlmIChtLl9pc1ZhbGlkID09IG51bGwpIHsKICAgICAgICAgICAgbS5faXNWYWxpZCA9ICFpc05hTihtLl9kLmdldFRpbWUoKSkgJiYKICAgICAgICAgICAgICAgIG0uX3BmLm92ZXJmbG93IDwgMCAmJgogICAgICAgICAgICAgICAgIW0uX3BmLmVtcHR5ICYmCiAgICAgICAgICAgICAgICAhbS5fcGYuaW52YWxpZE1vbnRoICYmCiAgICAgICAgICAgICAgICAhbS5fcGYubnVsbElucHV0ICYmCiAgICAgICAgICAgICAgICAhbS5fcGYuaW52YWxpZEZvcm1hdCAmJgogICAgICAgICAgICAgICAgIW0uX3BmLnVzZXJJbnZhbGlkYXRlZDsKCiAgICAgICAgICAgIGlmIChtLl9zdHJpY3QpIHsKICAgICAgICAgICAgICAgIG0uX2lzVmFsaWQgPSBtLl9pc1ZhbGlkICYmCiAgICAgICAgICAgICAgICAgICAgbS5fcGYuY2hhcnNMZWZ0T3ZlciA9PT0gMCAmJgogICAgICAgICAgICAgICAgICAgIG0uX3BmLnVudXNlZFRva2Vucy5sZW5ndGggPT09IDA7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG0uX2lzVmFsaWQ7CiAgICB9CgogICAgZnVuY3Rpb24gbm9ybWFsaXplTGFuZ3VhZ2Uoa2V5KSB7CiAgICAgICAgcmV0dXJuIGtleSA/IGtleS50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoJ18nLCAnLScpIDoga2V5OwogICAgfQoKICAgIC8vIFJldHVybiBhIG1vbWVudCBmcm9tIGlucHV0LCB0aGF0IGlzIGxvY2FsL3V0Yy96b25lIGVxdWl2YWxlbnQgdG8gbW9kZWwuCiAgICBmdW5jdGlvbiBtYWtlQXMoaW5wdXQsIG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIG1vZGVsLl9pc1VUQyA/IG1vbWVudChpbnB1dCkuem9uZShtb2RlbC5fb2Zmc2V0IHx8IDApIDoKICAgICAgICAgICAgbW9tZW50KGlucHV0KS5sb2NhbCgpOwogICAgfQoKICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgICAgICBMYW5ndWFnZXMKICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCgogICAgZXh0ZW5kKExhbmd1YWdlLnByb3RvdHlwZSwgewoKICAgICAgICBzZXQgOiBmdW5jdGlvbiAoY29uZmlnKSB7CiAgICAgICAgICAgIHZhciBwcm9wLCBpOwogICAgICAgICAgICBmb3IgKGkgaW4gY29uZmlnKSB7CiAgICAgICAgICAgICAgICBwcm9wID0gY29uZmlnW2ldOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwcm9wID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpc1tpXSA9IHByb3A7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXNbJ18nICsgaV0gPSBwcm9wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgX21vbnRocyA6ICJKYW51YXJ5X0ZlYnJ1YXJ5X01hcmNoX0FwcmlsX01heV9KdW5lX0p1bHlfQXVndXN0X1NlcHRlbWJlcl9PY3RvYmVyX05vdmVtYmVyX0RlY2VtYmVyIi5zcGxpdCgiXyIpLAogICAgICAgIG1vbnRocyA6IGZ1bmN0aW9uIChtKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9tb250aHNbbS5tb250aCgpXTsKICAgICAgICB9LAoKICAgICAgICBfbW9udGhzU2hvcnQgOiAiSmFuX0ZlYl9NYXJfQXByX01heV9KdW5fSnVsX0F1Z19TZXBfT2N0X05vdl9EZWMiLnNwbGl0KCJfIiksCiAgICAgICAgbW9udGhzU2hvcnQgOiBmdW5jdGlvbiAobSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbW9udGhzU2hvcnRbbS5tb250aCgpXTsKICAgICAgICB9LAoKICAgICAgICBtb250aHNQYXJzZSA6IGZ1bmN0aW9uIChtb250aE5hbWUpIHsKICAgICAgICAgICAgdmFyIGksIG1vbSwgcmVnZXg7CgogICAgICAgICAgICBpZiAoIXRoaXMuX21vbnRoc1BhcnNlKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9tb250aHNQYXJzZSA9IFtdOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgMTI7IGkrKykgewogICAgICAgICAgICAgICAgLy8gbWFrZSB0aGUgcmVnZXggaWYgd2UgZG9uJ3QgaGF2ZSBpdCBhbHJlYWR5CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX21vbnRoc1BhcnNlW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgbW9tID0gbW9tZW50LnV0YyhbMjAwMCwgaV0pOwogICAgICAgICAgICAgICAgICAgIHJlZ2V4ID0gJ14nICsgdGhpcy5tb250aHMobW9tLCAnJykgKyAnfF4nICsgdGhpcy5tb250aHNTaG9ydChtb20sICcnKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9tb250aHNQYXJzZVtpXSA9IG5ldyBSZWdFeHAocmVnZXgucmVwbGFjZSgnLicsICcnKSwgJ2knKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIHRlc3QgdGhlIHJlZ2V4CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fbW9udGhzUGFyc2VbaV0udGVzdChtb250aE5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBfd2Vla2RheXMgOiAiU3VuZGF5X01vbmRheV9UdWVzZGF5X1dlZG5lc2RheV9UaHVyc2RheV9GcmlkYXlfU2F0dXJkYXkiLnNwbGl0KCJfIiksCiAgICAgICAgd2Vla2RheXMgOiBmdW5jdGlvbiAobSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fd2Vla2RheXNbbS5kYXkoKV07CiAgICAgICAgfSwKCiAgICAgICAgX3dlZWtkYXlzU2hvcnQgOiAiU3VuX01vbl9UdWVfV2VkX1RodV9GcmlfU2F0Ii5zcGxpdCgiXyIpLAogICAgICAgIHdlZWtkYXlzU2hvcnQgOiBmdW5jdGlvbiAobSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fd2Vla2RheXNTaG9ydFttLmRheSgpXTsKICAgICAgICB9LAoKICAgICAgICBfd2Vla2RheXNNaW4gOiAiU3VfTW9fVHVfV2VfVGhfRnJfU2EiLnNwbGl0KCJfIiksCiAgICAgICAgd2Vla2RheXNNaW4gOiBmdW5jdGlvbiAobSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fd2Vla2RheXNNaW5bbS5kYXkoKV07CiAgICAgICAgfSwKCiAgICAgICAgd2Vla2RheXNQYXJzZSA6IGZ1bmN0aW9uICh3ZWVrZGF5TmFtZSkgewogICAgICAgICAgICB2YXIgaSwgbW9tLCByZWdleDsKCiAgICAgICAgICAgIGlmICghdGhpcy5fd2Vla2RheXNQYXJzZSkgewogICAgICAgICAgICAgICAgdGhpcy5fd2Vla2RheXNQYXJzZSA9IFtdOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgNzsgaSsrKSB7CiAgICAgICAgICAgICAgICAvLyBtYWtlIHRoZSByZWdleCBpZiB3ZSBkb24ndCBoYXZlIGl0IGFscmVhZHkKICAgICAgICAgICAgICAgIGlmICghdGhpcy5fd2Vla2RheXNQYXJzZVtpXSkgewogICAgICAgICAgICAgICAgICAgIG1vbSA9IG1vbWVudChbMjAwMCwgMV0pLmRheShpKTsKICAgICAgICAgICAgICAgICAgICByZWdleCA9ICdeJyArIHRoaXMud2Vla2RheXMobW9tLCAnJykgKyAnfF4nICsgdGhpcy53ZWVrZGF5c1Nob3J0KG1vbSwgJycpICsgJ3xeJyArIHRoaXMud2Vla2RheXNNaW4obW9tLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fd2Vla2RheXNQYXJzZVtpXSA9IG5ldyBSZWdFeHAocmVnZXgucmVwbGFjZSgnLicsICcnKSwgJ2knKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIHRlc3QgdGhlIHJlZ2V4CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fd2Vla2RheXNQYXJzZVtpXS50ZXN0KHdlZWtkYXlOYW1lKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgX2xvbmdEYXRlRm9ybWF0IDogewogICAgICAgICAgICBMVCA6ICJoOm1tIEEiLAogICAgICAgICAgICBMIDogIk1NL0REL1lZWVkiLAogICAgICAgICAgICBMTCA6ICJNTU1NIEQgWVlZWSIsCiAgICAgICAgICAgIExMTCA6ICJNTU1NIEQgWVlZWSBMVCIsCiAgICAgICAgICAgIExMTEwgOiAiZGRkZCwgTU1NTSBEIFlZWVkgTFQiCiAgICAgICAgfSwKICAgICAgICBsb25nRGF0ZUZvcm1hdCA6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgdmFyIG91dHB1dCA9IHRoaXMuX2xvbmdEYXRlRm9ybWF0W2tleV07CiAgICAgICAgICAgIGlmICghb3V0cHV0ICYmIHRoaXMuX2xvbmdEYXRlRm9ybWF0W2tleS50b1VwcGVyQ2FzZSgpXSkgewogICAgICAgICAgICAgICAgb3V0cHV0ID0gdGhpcy5fbG9uZ0RhdGVGb3JtYXRba2V5LnRvVXBwZXJDYXNlKCldLnJlcGxhY2UoL01NTU18TU18RER8ZGRkZC9nLCBmdW5jdGlvbiAodmFsKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbC5zbGljZSgxKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdGhpcy5fbG9uZ0RhdGVGb3JtYXRba2V5XSA9IG91dHB1dDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICAgIH0sCgogICAgICAgIGlzUE0gOiBmdW5jdGlvbiAoaW5wdXQpIHsKICAgICAgICAgICAgLy8gSUU4IFF1aXJrcyBNb2RlICYgSUU3IFN0YW5kYXJkcyBNb2RlIGRvIG5vdCBhbGxvdyBhY2Nlc3Npbmcgc3RyaW5ncyBsaWtlIGFycmF5cwogICAgICAgICAgICAvLyBVc2luZyBjaGFyQXQgc2hvdWxkIGJlIG1vcmUgY29tcGF0aWJsZS4KICAgICAgICAgICAgcmV0dXJuICgoaW5wdXQgKyAnJykudG9Mb3dlckNhc2UoKS5jaGFyQXQoMCkgPT09ICdwJyk7CiAgICAgICAgfSwKCiAgICAgICAgX21lcmlkaWVtUGFyc2UgOiAvW2FwXVwuP20/XC4/L2ksCiAgICAgICAgbWVyaWRpZW0gOiBmdW5jdGlvbiAoaG91cnMsIG1pbnV0ZXMsIGlzTG93ZXIpIHsKICAgICAgICAgICAgaWYgKGhvdXJzID4gMTEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpc0xvd2VyID8gJ3BtJyA6ICdQTSc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaXNMb3dlciA/ICdhbScgOiAnQU0nOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgX2NhbGVuZGFyIDogewogICAgICAgICAgICBzYW1lRGF5IDogJ1tUb2RheSBhdF0gTFQnLAogICAgICAgICAgICBuZXh0RGF5IDogJ1tUb21vcnJvdyBhdF0gTFQnLAogICAgICAgICAgICBuZXh0V2VlayA6ICdkZGRkIFthdF0gTFQnLAogICAgICAgICAgICBsYXN0RGF5IDogJ1tZZXN0ZXJkYXkgYXRdIExUJywKICAgICAgICAgICAgbGFzdFdlZWsgOiAnW0xhc3RdIGRkZGQgW2F0XSBMVCcsCiAgICAgICAgICAgIHNhbWVFbHNlIDogJ0wnCiAgICAgICAgfSwKICAgICAgICBjYWxlbmRhciA6IGZ1bmN0aW9uIChrZXksIG1vbSkgewogICAgICAgICAgICB2YXIgb3V0cHV0ID0gdGhpcy5fY2FsZW5kYXJba2V5XTsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBvdXRwdXQgPT09ICdmdW5jdGlvbicgPyBvdXRwdXQuYXBwbHkobW9tKSA6IG91dHB1dDsKICAgICAgICB9LAoKICAgICAgICBfcmVsYXRpdmVUaW1lIDogewogICAgICAgICAgICBmdXR1cmUgOiAiaW4gJXMiLAogICAgICAgICAgICBwYXN0IDogIiVzIGFnbyIsCiAgICAgICAgICAgIHMgOiAiYSBmZXcgc2Vjb25kcyIsCiAgICAgICAgICAgIG0gOiAiYSBtaW51dGUiLAogICAgICAgICAgICBtbSA6ICIlZCBtaW51dGVzIiwKICAgICAgICAgICAgaCA6ICJhbiBob3VyIiwKICAgICAgICAgICAgaGggOiAiJWQgaG91cnMiLAogICAgICAgICAgICBkIDogImEgZGF5IiwKICAgICAgICAgICAgZGQgOiAiJWQgZGF5cyIsCiAgICAgICAgICAgIE0gOiAiYSBtb250aCIsCiAgICAgICAgICAgIE1NIDogIiVkIG1vbnRocyIsCiAgICAgICAgICAgIHkgOiAiYSB5ZWFyIiwKICAgICAgICAgICAgeXkgOiAiJWQgeWVhcnMiCiAgICAgICAgfSwKICAgICAgICByZWxhdGl2ZVRpbWUgOiBmdW5jdGlvbiAobnVtYmVyLCB3aXRob3V0U3VmZml4LCBzdHJpbmcsIGlzRnV0dXJlKSB7CiAgICAgICAgICAgIHZhciBvdXRwdXQgPSB0aGlzLl9yZWxhdGl2ZVRpbWVbc3RyaW5nXTsKICAgICAgICAgICAgcmV0dXJuICh0eXBlb2Ygb3V0cHV0ID09PSAnZnVuY3Rpb24nKSA/CiAgICAgICAgICAgICAgICBvdXRwdXQobnVtYmVyLCB3aXRob3V0U3VmZml4LCBzdHJpbmcsIGlzRnV0dXJlKSA6CiAgICAgICAgICAgICAgICBvdXRwdXQucmVwbGFjZSgvJWQvaSwgbnVtYmVyKTsKICAgICAgICB9LAogICAgICAgIHBhc3RGdXR1cmUgOiBmdW5jdGlvbiAoZGlmZiwgb3V0cHV0KSB7CiAgICAgICAgICAgIHZhciBmb3JtYXQgPSB0aGlzLl9yZWxhdGl2ZVRpbWVbZGlmZiA+IDAgPyAnZnV0dXJlJyA6ICdwYXN0J107CiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgZm9ybWF0ID09PSAnZnVuY3Rpb24nID8gZm9ybWF0KG91dHB1dCkgOiBmb3JtYXQucmVwbGFjZSgvJXMvaSwgb3V0cHV0KTsKICAgICAgICB9LAoKICAgICAgICBvcmRpbmFsIDogZnVuY3Rpb24gKG51bWJlcikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fb3JkaW5hbC5yZXBsYWNlKCIlZCIsIG51bWJlcik7CiAgICAgICAgfSwKICAgICAgICBfb3JkaW5hbCA6ICIlZCIsCgogICAgICAgIHByZXBhcnNlIDogZnVuY3Rpb24gKHN0cmluZykgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICAgIH0sCgogICAgICAgIHBvc3Rmb3JtYXQgOiBmdW5jdGlvbiAoc3RyaW5nKSB7CiAgICAgICAgICAgIHJldHVybiBzdHJpbmc7CiAgICAgICAgfSwKCiAgICAgICAgd2VlayA6IGZ1bmN0aW9uIChtb20pIHsKICAgICAgICAgICAgcmV0dXJuIHdlZWtPZlllYXIobW9tLCB0aGlzLl93ZWVrLmRvdywgdGhpcy5fd2Vlay5kb3kpLndlZWs7CiAgICAgICAgfSwKCiAgICAgICAgX3dlZWsgOiB7CiAgICAgICAgICAgIGRvdyA6IDAsIC8vIFN1bmRheSBpcyB0aGUgZmlyc3QgZGF5IG9mIHRoZSB3ZWVrLgogICAgICAgICAgICBkb3kgOiA2ICAvLyBUaGUgd2VlayB0aGF0IGNvbnRhaW5zIEphbiAxc3QgaXMgdGhlIGZpcnN0IHdlZWsgb2YgdGhlIHllYXIuCiAgICAgICAgfSwKCiAgICAgICAgX2ludmFsaWREYXRlOiAnSW52YWxpZCBkYXRlJywKICAgICAgICBpbnZhbGlkRGF0ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faW52YWxpZERhdGU7CiAgICAgICAgfQogICAgfSk7CgogICAgLy8gTG9hZHMgYSBsYW5ndWFnZSBkZWZpbml0aW9uIGludG8gdGhlIGBsYW5ndWFnZXNgIGNhY2hlLiAgVGhlIGZ1bmN0aW9uCiAgICAvLyB0YWtlcyBhIGtleSBhbmQgb3B0aW9uYWxseSB2YWx1ZXMuICBJZiBub3QgaW4gdGhlIGJyb3dzZXIgYW5kIG5vIHZhbHVlcwogICAgLy8gYXJlIHByb3ZpZGVkLCBpdCB3aWxsIGxvYWQgdGhlIGxhbmd1YWdlIGZpbGUgbW9kdWxlLiAgQXMgYSBjb252ZW5pZW5jZSwKICAgIC8vIHRoaXMgZnVuY3Rpb24gYWxzbyByZXR1cm5zIHRoZSBsYW5ndWFnZSB2YWx1ZXMuCiAgICBmdW5jdGlvbiBsb2FkTGFuZyhrZXksIHZhbHVlcykgewogICAgICAgIHZhbHVlcy5hYmJyID0ga2V5OwogICAgICAgIGlmICghbGFuZ3VhZ2VzW2tleV0pIHsKICAgICAgICAgICAgbGFuZ3VhZ2VzW2tleV0gPSBuZXcgTGFuZ3VhZ2UoKTsKICAgICAgICB9CiAgICAgICAgbGFuZ3VhZ2VzW2tleV0uc2V0KHZhbHVlcyk7CiAgICAgICAgcmV0dXJuIGxhbmd1YWdlc1trZXldOwogICAgfQoKICAgIC8vIFJlbW92ZSBhIGxhbmd1YWdlIGZyb20gdGhlIGBsYW5ndWFnZXNgIGNhY2hlLiBNb3N0bHkgdXNlZnVsIGluIHRlc3RzLgogICAgZnVuY3Rpb24gdW5sb2FkTGFuZyhrZXkpIHsKICAgICAgICBkZWxldGUgbGFuZ3VhZ2VzW2tleV07CiAgICB9CgogICAgLy8gRGV0ZXJtaW5lcyB3aGljaCBsYW5ndWFnZSBkZWZpbml0aW9uIHRvIHVzZSBhbmQgcmV0dXJucyBpdC4KICAgIC8vCiAgICAvLyBXaXRoIG5vIHBhcmFtZXRlcnMsIGl0IHdpbGwgcmV0dXJuIHRoZSBnbG9iYWwgbGFuZ3VhZ2UuICBJZiB5b3UKICAgIC8vIHBhc3MgaW4gYSBsYW5ndWFnZSBrZXksIHN1Y2ggYXMgJ2VuJywgaXQgd2lsbCByZXR1cm4gdGhlCiAgICAvLyBkZWZpbml0aW9uIGZvciAnZW4nLCBzbyBsb25nIGFzICdlbicgaGFzIGFscmVhZHkgYmVlbiBsb2FkZWQgdXNpbmcKICAgIC8vIG1vbWVudC5sYW5nLgogICAgZnVuY3Rpb24gZ2V0TGFuZ0RlZmluaXRpb24oa2V5KSB7CiAgICAgICAgdmFyIGkgPSAwLCBqLCBsYW5nLCBuZXh0LCBzcGxpdCwKICAgICAgICAgICAgZ2V0ID0gZnVuY3Rpb24gKGspIHsKICAgICAgICAgICAgICAgIGlmICghbGFuZ3VhZ2VzW2tdICYmIGhhc01vZHVsZSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmUoJy4vbGFuZy8nICsgayk7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgeyB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbGFuZ3VhZ2VzW2tdOwogICAgICAgICAgICB9OwoKICAgICAgICBpZiAoIWtleSkgewogICAgICAgICAgICByZXR1cm4gbW9tZW50LmZuLl9sYW5nOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFpc0FycmF5KGtleSkpIHsKICAgICAgICAgICAgLy9zaG9ydC1jaXJjdWl0IGV2ZXJ5dGhpbmcgZWxzZQogICAgICAgICAgICBsYW5nID0gZ2V0KGtleSk7CiAgICAgICAgICAgIGlmIChsYW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbGFuZzsKICAgICAgICAgICAgfQogICAgICAgICAgICBrZXkgPSBba2V5XTsKICAgICAgICB9CgogICAgICAgIC8vcGljayB0aGUgbGFuZ3VhZ2UgZnJvbSB0aGUgYXJyYXkKICAgICAgICAvL3RyeSBbJ2VuLWF1JywgJ2VuLWdiJ10gYXMgJ2VuLWF1JywgJ2VuLWdiJywgJ2VuJywgYXMgaW4gbW92ZSB0aHJvdWdoIHRoZSBsaXN0IHRyeWluZyBlYWNoCiAgICAgICAgLy9zdWJzdHJpbmcgZnJvbSBtb3N0IHNwZWNpZmljIHRvIGxlYXN0LCBidXQgbW92ZSB0byB0aGUgbmV4dCBhcnJheSBpdGVtIGlmIGl0J3MgYSBtb3JlIHNwZWNpZmljIHZhcmlhbnQgdGhhbiB0aGUgY3VycmVudCByb290CiAgICAgICAgd2hpbGUgKGkgPCBrZXkubGVuZ3RoKSB7CiAgICAgICAgICAgIHNwbGl0ID0gbm9ybWFsaXplTGFuZ3VhZ2Uoa2V5W2ldKS5zcGxpdCgnLScpOwogICAgICAgICAgICBqID0gc3BsaXQubGVuZ3RoOwogICAgICAgICAgICBuZXh0ID0gbm9ybWFsaXplTGFuZ3VhZ2Uoa2V5W2kgKyAxXSk7CiAgICAgICAgICAgIG5leHQgPSBuZXh0ID8gbmV4dC5zcGxpdCgnLScpIDogbnVsbDsKICAgICAgICAgICAgd2hpbGUgKGogPiAwKSB7CiAgICAgICAgICAgICAgICBsYW5nID0gZ2V0KHNwbGl0LnNsaWNlKDAsIGopLmpvaW4oJy0nKSk7CiAgICAgICAgICAgICAgICBpZiAobGFuZykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBsYW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG5leHQgJiYgbmV4dC5sZW5ndGggPj0gaiAmJiBjb21wYXJlQXJyYXlzKHNwbGl0LCBuZXh0LCB0cnVlKSA+PSBqIC0gMSkgewogICAgICAgICAgICAgICAgICAgIC8vdGhlIG5leHQgYXJyYXkgaXRlbSBpcyBiZXR0ZXIgdGhhbiBhIHNoYWxsb3dlciBzdWJzdHJpbmcgb2YgdGhpcyBvbmUKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGotLTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpKys7CiAgICAgICAgfQogICAgICAgIHJldHVybiBtb21lbnQuZm4uX2xhbmc7CiAgICB9CgogICAgLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgogICAgICAgIEZvcm1hdHRpbmcKICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCgogICAgZnVuY3Rpb24gcmVtb3ZlRm9ybWF0dGluZ1Rva2VucyhpbnB1dCkgewogICAgICAgIGlmIChpbnB1dC5tYXRjaCgvXFtbXHNcU10vKSkgewogICAgICAgICAgICByZXR1cm4gaW5wdXQucmVwbGFjZSgvXlxbfFxdJC9nLCAiIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpbnB1dC5yZXBsYWNlKC9cXC9nLCAiIik7CiAgICB9CgogICAgZnVuY3Rpb24gbWFrZUZvcm1hdEZ1bmN0aW9uKGZvcm1hdCkgewogICAgICAgIHZhciBhcnJheSA9IGZvcm1hdC5tYXRjaChmb3JtYXR0aW5nVG9rZW5zKSwgaSwgbGVuZ3RoOwoKICAgICAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSBhcnJheS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAoZm9ybWF0VG9rZW5GdW5jdGlvbnNbYXJyYXlbaV1dKSB7CiAgICAgICAgICAgICAgICBhcnJheVtpXSA9IGZvcm1hdFRva2VuRnVuY3Rpb25zW2FycmF5W2ldXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFycmF5W2ldID0gcmVtb3ZlRm9ybWF0dGluZ1Rva2VucyhhcnJheVtpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAobW9tKSB7CiAgICAgICAgICAgIHZhciBvdXRwdXQgPSAiIjsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBvdXRwdXQgKz0gYXJyYXlbaV0gaW5zdGFuY2VvZiBGdW5jdGlvbiA/IGFycmF5W2ldLmNhbGwobW9tLCBmb3JtYXQpIDogYXJyYXlbaV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgICAgICB9OwogICAgfQoKICAgIC8vIGZvcm1hdCBkYXRlIHVzaW5nIG5hdGl2ZSBkYXRlIG9iamVjdAogICAgZnVuY3Rpb24gZm9ybWF0TW9tZW50KG0sIGZvcm1hdCkgewoKICAgICAgICBpZiAoIW0uaXNWYWxpZCgpKSB7CiAgICAgICAgICAgIHJldHVybiBtLmxhbmcoKS5pbnZhbGlkRGF0ZSgpOwogICAgICAgIH0KCiAgICAgICAgZm9ybWF0ID0gZXhwYW5kRm9ybWF0KGZvcm1hdCwgbS5sYW5nKCkpOwoKICAgICAgICBpZiAoIWZvcm1hdEZ1bmN0aW9uc1tmb3JtYXRdKSB7CiAgICAgICAgICAgIGZvcm1hdEZ1bmN0aW9uc1tmb3JtYXRdID0gbWFrZUZvcm1hdEZ1bmN0aW9uKGZvcm1hdCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZm9ybWF0RnVuY3Rpb25zW2Zvcm1hdF0obSk7CiAgICB9CgogICAgZnVuY3Rpb24gZXhwYW5kRm9ybWF0KGZvcm1hdCwgbGFuZykgewogICAgICAgIHZhciBpID0gNTsKCiAgICAgICAgZnVuY3Rpb24gcmVwbGFjZUxvbmdEYXRlRm9ybWF0VG9rZW5zKGlucHV0KSB7CiAgICAgICAgICAgIHJldHVybiBsYW5nLmxvbmdEYXRlRm9ybWF0KGlucHV0KSB8fCBpbnB1dDsKICAgICAgICB9CgogICAgICAgIGxvY2FsRm9ybWF0dGluZ1Rva2Vucy5sYXN0SW5kZXggPSAwOwogICAgICAgIHdoaWxlIChpID49IDAgJiYgbG9jYWxGb3JtYXR0aW5nVG9rZW5zLnRlc3QoZm9ybWF0KSkgewogICAgICAgICAgICBmb3JtYXQgPSBmb3JtYXQucmVwbGFjZShsb2NhbEZvcm1hdHRpbmdUb2tlbnMsIHJlcGxhY2VMb25nRGF0ZUZvcm1hdFRva2Vucyk7CiAgICAgICAgICAgIGxvY2FsRm9ybWF0dGluZ1Rva2Vucy5sYXN0SW5kZXggPSAwOwogICAgICAgICAgICBpIC09IDE7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZm9ybWF0OwogICAgfQoKCiAgICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICAgICAgUGFyc2luZwogICAgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwoKCiAgICAvLyBnZXQgdGhlIHJlZ2V4IHRvIGZpbmQgdGhlIG5leHQgdG9rZW4KICAgIGZ1bmN0aW9uIGdldFBhcnNlUmVnZXhGb3JUb2tlbih0b2tlbiwgY29uZmlnKSB7CiAgICAgICAgdmFyIGEsIHN0cmljdCA9IGNvbmZpZy5fc3RyaWN0OwogICAgICAgIHN3aXRjaCAodG9rZW4pIHsKICAgICAgICBjYXNlICdRJzoKICAgICAgICAgICAgcmV0dXJuIHBhcnNlVG9rZW5PbmVEaWdpdDsKICAgICAgICBjYXNlICdEREREJzoKICAgICAgICAgICAgcmV0dXJuIHBhcnNlVG9rZW5UaHJlZURpZ2l0czsKICAgICAgICBjYXNlICdZWVlZJzoKICAgICAgICBjYXNlICdHR0dHJzoKICAgICAgICBjYXNlICdnZ2dnJzoKICAgICAgICAgICAgcmV0dXJuIHN0cmljdCA/IHBhcnNlVG9rZW5Gb3VyRGlnaXRzIDogcGFyc2VUb2tlbk9uZVRvRm91ckRpZ2l0czsKICAgICAgICBjYXNlICdZJzoKICAgICAgICBjYXNlICdHJzoKICAgICAgICBjYXNlICdnJzoKICAgICAgICAgICAgcmV0dXJuIHBhcnNlVG9rZW5TaWduZWROdW1iZXI7CiAgICAgICAgY2FzZSAnWVlZWVlZJzoKICAgICAgICBjYXNlICdZWVlZWSc6CiAgICAgICAgY2FzZSAnR0dHR0cnOgogICAgICAgIGNhc2UgJ2dnZ2dnJzoKICAgICAgICAgICAgcmV0dXJuIHN0cmljdCA/IHBhcnNlVG9rZW5TaXhEaWdpdHMgOiBwYXJzZVRva2VuT25lVG9TaXhEaWdpdHM7CiAgICAgICAgY2FzZSAnUyc6CiAgICAgICAgICAgIGlmIChzdHJpY3QpIHsgcmV0dXJuIHBhcnNlVG9rZW5PbmVEaWdpdDsgfQogICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgY2FzZSAnU1MnOgogICAgICAgICAgICBpZiAoc3RyaWN0KSB7IHJldHVybiBwYXJzZVRva2VuVHdvRGlnaXRzOyB9CiAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi8KICAgICAgICBjYXNlICdTU1MnOgogICAgICAgICAgICBpZiAoc3RyaWN0KSB7IHJldHVybiBwYXJzZVRva2VuVGhyZWVEaWdpdHM7IH0KICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgIGNhc2UgJ0RERCc6CiAgICAgICAgICAgIHJldHVybiBwYXJzZVRva2VuT25lVG9UaHJlZURpZ2l0czsKICAgICAgICBjYXNlICdNTU0nOgogICAgICAgIGNhc2UgJ01NTU0nOgogICAgICAgIGNhc2UgJ2RkJzoKICAgICAgICBjYXNlICdkZGQnOgogICAgICAgIGNhc2UgJ2RkZGQnOgogICAgICAgICAgICByZXR1cm4gcGFyc2VUb2tlbldvcmQ7CiAgICAgICAgY2FzZSAnYSc6CiAgICAgICAgY2FzZSAnQSc6CiAgICAgICAgICAgIHJldHVybiBnZXRMYW5nRGVmaW5pdGlvbihjb25maWcuX2wpLl9tZXJpZGllbVBhcnNlOwogICAgICAgIGNhc2UgJ1gnOgogICAgICAgICAgICByZXR1cm4gcGFyc2VUb2tlblRpbWVzdGFtcE1zOwogICAgICAgIGNhc2UgJ1onOgogICAgICAgIGNhc2UgJ1paJzoKICAgICAgICAgICAgcmV0dXJuIHBhcnNlVG9rZW5UaW1lem9uZTsKICAgICAgICBjYXNlICdUJzoKICAgICAgICAgICAgcmV0dXJuIHBhcnNlVG9rZW5UOwogICAgICAgIGNhc2UgJ1NTU1MnOgogICAgICAgICAgICByZXR1cm4gcGFyc2VUb2tlbkRpZ2l0czsKICAgICAgICBjYXNlICdNTSc6CiAgICAgICAgY2FzZSAnREQnOgogICAgICAgIGNhc2UgJ1lZJzoKICAgICAgICBjYXNlICdHRyc6CiAgICAgICAgY2FzZSAnZ2cnOgogICAgICAgIGNhc2UgJ0hIJzoKICAgICAgICBjYXNlICdoaCc6CiAgICAgICAgY2FzZSAnbW0nOgogICAgICAgIGNhc2UgJ3NzJzoKICAgICAgICBjYXNlICd3dyc6CiAgICAgICAgY2FzZSAnV1cnOgogICAgICAgICAgICByZXR1cm4gc3RyaWN0ID8gcGFyc2VUb2tlblR3b0RpZ2l0cyA6IHBhcnNlVG9rZW5PbmVPclR3b0RpZ2l0czsKICAgICAgICBjYXNlICdNJzoKICAgICAgICBjYXNlICdEJzoKICAgICAgICBjYXNlICdkJzoKICAgICAgICBjYXNlICdIJzoKICAgICAgICBjYXNlICdoJzoKICAgICAgICBjYXNlICdtJzoKICAgICAgICBjYXNlICdzJzoKICAgICAgICBjYXNlICd3JzoKICAgICAgICBjYXNlICdXJzoKICAgICAgICBjYXNlICdlJzoKICAgICAgICBjYXNlICdFJzoKICAgICAgICAgICAgcmV0dXJuIHBhcnNlVG9rZW5PbmVPclR3b0RpZ2l0czsKICAgICAgICBjYXNlICdEbyc6CiAgICAgICAgICAgIHJldHVybiBwYXJzZVRva2VuT3JkaW5hbDsKICAgICAgICBkZWZhdWx0IDoKICAgICAgICAgICAgYSA9IG5ldyBSZWdFeHAocmVnZXhwRXNjYXBlKHVuZXNjYXBlRm9ybWF0KHRva2VuLnJlcGxhY2UoJ1xcJywgJycpKSwgImkiKSk7CiAgICAgICAgICAgIHJldHVybiBhOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiB0aW1lem9uZU1pbnV0ZXNGcm9tU3RyaW5nKHN0cmluZykgewogICAgICAgIHN0cmluZyA9IHN0cmluZyB8fCAiIjsKICAgICAgICB2YXIgcG9zc2libGVUek1hdGNoZXMgPSAoc3RyaW5nLm1hdGNoKHBhcnNlVG9rZW5UaW1lem9uZSkgfHwgW10pLAogICAgICAgICAgICB0ekNodW5rID0gcG9zc2libGVUek1hdGNoZXNbcG9zc2libGVUek1hdGNoZXMubGVuZ3RoIC0gMV0gfHwgW10sCiAgICAgICAgICAgIHBhcnRzID0gKHR6Q2h1bmsgKyAnJykubWF0Y2gocGFyc2VUaW1lem9uZUNodW5rZXIpIHx8IFsnLScsIDAsIDBdLAogICAgICAgICAgICBtaW51dGVzID0gKyhwYXJ0c1sxXSAqIDYwKSArIHRvSW50KHBhcnRzWzJdKTsKCiAgICAgICAgcmV0dXJuIHBhcnRzWzBdID09PSAnKycgPyAtbWludXRlcyA6IG1pbnV0ZXM7CiAgICB9CgogICAgLy8gZnVuY3Rpb24gdG8gY29udmVydCBzdHJpbmcgaW5wdXQgdG8gZGF0ZQogICAgZnVuY3Rpb24gYWRkVGltZVRvQXJyYXlGcm9tVG9rZW4odG9rZW4sIGlucHV0LCBjb25maWcpIHsKICAgICAgICB2YXIgYSwgZGF0ZVBhcnRBcnJheSA9IGNvbmZpZy5fYTsKCiAgICAgICAgc3dpdGNoICh0b2tlbikgewogICAgICAgIC8vIFFVQVJURVIKICAgICAgICBjYXNlICdRJzoKICAgICAgICAgICAgaWYgKGlucHV0ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGRhdGVQYXJ0QXJyYXlbTU9OVEhdID0gKHRvSW50KGlucHV0KSAtIDEpICogMzsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAvLyBNT05USAogICAgICAgIGNhc2UgJ00nIDogLy8gZmFsbCB0aHJvdWdoIHRvIE1NCiAgICAgICAgY2FzZSAnTU0nIDoKICAgICAgICAgICAgaWYgKGlucHV0ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGRhdGVQYXJ0QXJyYXlbTU9OVEhdID0gdG9JbnQoaW5wdXQpIC0gMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdNTU0nIDogLy8gZmFsbCB0aHJvdWdoIHRvIE1NTU0KICAgICAgICBjYXNlICdNTU1NJyA6CiAgICAgICAgICAgIGEgPSBnZXRMYW5nRGVmaW5pdGlvbihjb25maWcuX2wpLm1vbnRoc1BhcnNlKGlucHV0KTsKICAgICAgICAgICAgLy8gaWYgd2UgZGlkbid0IGZpbmQgYSBtb250aCBuYW1lLCBtYXJrIHRoZSBkYXRlIGFzIGludmFsaWQuCiAgICAgICAgICAgIGlmIChhICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGRhdGVQYXJ0QXJyYXlbTU9OVEhdID0gYTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5fcGYuaW52YWxpZE1vbnRoID0gaW5wdXQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gREFZIE9GIE1PTlRICiAgICAgICAgY2FzZSAnRCcgOiAvLyBmYWxsIHRocm91Z2ggdG8gREQKICAgICAgICBjYXNlICdERCcgOgogICAgICAgICAgICBpZiAoaW5wdXQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZGF0ZVBhcnRBcnJheVtEQVRFXSA9IHRvSW50KGlucHV0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdEbycgOgogICAgICAgICAgICBpZiAoaW5wdXQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZGF0ZVBhcnRBcnJheVtEQVRFXSA9IHRvSW50KHBhcnNlSW50KGlucHV0LCAxMCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIC8vIERBWSBPRiBZRUFSCiAgICAgICAgY2FzZSAnREREJyA6IC8vIGZhbGwgdGhyb3VnaCB0byBERERECiAgICAgICAgY2FzZSAnRERERCcgOgogICAgICAgICAgICBpZiAoaW5wdXQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgY29uZmlnLl9kYXlPZlllYXIgPSB0b0ludChpbnB1dCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIC8vIFlFQVIKICAgICAgICBjYXNlICdZWScgOgogICAgICAgICAgICBkYXRlUGFydEFycmF5W1lFQVJdID0gbW9tZW50LnBhcnNlVHdvRGlnaXRZZWFyKGlucHV0KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAnWVlZWScgOgogICAgICAgIGNhc2UgJ1lZWVlZJyA6CiAgICAgICAgY2FzZSAnWVlZWVlZJyA6CiAgICAgICAgICAgIGRhdGVQYXJ0QXJyYXlbWUVBUl0gPSB0b0ludChpbnB1dCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIC8vIEFNIC8gUE0KICAgICAgICBjYXNlICdhJyA6IC8vIGZhbGwgdGhyb3VnaCB0byBBCiAgICAgICAgY2FzZSAnQScgOgogICAgICAgICAgICBjb25maWcuX2lzUG0gPSBnZXRMYW5nRGVmaW5pdGlvbihjb25maWcuX2wpLmlzUE0oaW5wdXQpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAvLyAyNCBIT1VSCiAgICAgICAgY2FzZSAnSCcgOiAvLyBmYWxsIHRocm91Z2ggdG8gaGgKICAgICAgICBjYXNlICdISCcgOiAvLyBmYWxsIHRocm91Z2ggdG8gaGgKICAgICAgICBjYXNlICdoJyA6IC8vIGZhbGwgdGhyb3VnaCB0byBoaAogICAgICAgIGNhc2UgJ2hoJyA6CiAgICAgICAgICAgIGRhdGVQYXJ0QXJyYXlbSE9VUl0gPSB0b0ludChpbnB1dCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIC8vIE1JTlVURQogICAgICAgIGNhc2UgJ20nIDogLy8gZmFsbCB0aHJvdWdoIHRvIG1tCiAgICAgICAgY2FzZSAnbW0nIDoKICAgICAgICAgICAgZGF0ZVBhcnRBcnJheVtNSU5VVEVdID0gdG9JbnQoaW5wdXQpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAvLyBTRUNPTkQKICAgICAgICBjYXNlICdzJyA6IC8vIGZhbGwgdGhyb3VnaCB0byBzcwogICAgICAgIGNhc2UgJ3NzJyA6CiAgICAgICAgICAgIGRhdGVQYXJ0QXJyYXlbU0VDT05EXSA9IHRvSW50KGlucHV0KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gTUlMTElTRUNPTkQKICAgICAgICBjYXNlICdTJyA6CiAgICAgICAgY2FzZSAnU1MnIDoKICAgICAgICBjYXNlICdTU1MnIDoKICAgICAgICBjYXNlICdTU1NTJyA6CiAgICAgICAgICAgIGRhdGVQYXJ0QXJyYXlbTUlMTElTRUNPTkRdID0gdG9JbnQoKCcwLicgKyBpbnB1dCkgKiAxMDAwKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gVU5JWCBUSU1FU1RBTVAgV0lUSCBNUwogICAgICAgIGNhc2UgJ1gnOgogICAgICAgICAgICBjb25maWcuX2QgPSBuZXcgRGF0ZShwYXJzZUZsb2F0KGlucHV0KSAqIDEwMDApOwogICAgICAgICAgICBicmVhazsKICAgICAgICAvLyBUSU1FWk9ORQogICAgICAgIGNhc2UgJ1onIDogLy8gZmFsbCB0aHJvdWdoIHRvIFpaCiAgICAgICAgY2FzZSAnWlonIDoKICAgICAgICAgICAgY29uZmlnLl91c2VVVEMgPSB0cnVlOwogICAgICAgICAgICBjb25maWcuX3R6bSA9IHRpbWV6b25lTWludXRlc0Zyb21TdHJpbmcoaW5wdXQpOwogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICd3JzoKICAgICAgICBjYXNlICd3dyc6CiAgICAgICAgY2FzZSAnVyc6CiAgICAgICAgY2FzZSAnV1cnOgogICAgICAgIGNhc2UgJ2QnOgogICAgICAgIGNhc2UgJ2RkJzoKICAgICAgICBjYXNlICdkZGQnOgogICAgICAgIGNhc2UgJ2RkZGQnOgogICAgICAgIGNhc2UgJ2UnOgogICAgICAgIGNhc2UgJ0UnOgogICAgICAgICAgICB0b2tlbiA9IHRva2VuLnN1YnN0cigwLCAxKTsKICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgIGNhc2UgJ2dnJzoKICAgICAgICBjYXNlICdnZ2dnJzoKICAgICAgICBjYXNlICdHRyc6CiAgICAgICAgY2FzZSAnR0dHRyc6CiAgICAgICAgY2FzZSAnR0dHR0cnOgogICAgICAgICAgICB0b2tlbiA9IHRva2VuLnN1YnN0cigwLCAyKTsKICAgICAgICAgICAgaWYgKGlucHV0KSB7CiAgICAgICAgICAgICAgICBjb25maWcuX3cgPSBjb25maWcuX3cgfHwge307CiAgICAgICAgICAgICAgICBjb25maWcuX3dbdG9rZW5dID0gaW5wdXQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgfQoKICAgIC8vIGNvbnZlcnQgYW4gYXJyYXkgdG8gYSBkYXRlLgogICAgLy8gdGhlIGFycmF5IHNob3VsZCBtaXJyb3IgdGhlIHBhcmFtZXRlcnMgYmVsb3cKICAgIC8vIG5vdGU6IGFsbCB2YWx1ZXMgcGFzdCB0aGUgeWVhciBhcmUgb3B0aW9uYWwgYW5kIHdpbGwgZGVmYXVsdCB0byB0aGUgbG93ZXN0IHBvc3NpYmxlIHZhbHVlLgogICAgLy8gW3llYXIsIG1vbnRoLCBkYXkgLCBob3VyLCBtaW51dGUsIHNlY29uZCwgbWlsbGlzZWNvbmRdCiAgICBmdW5jdGlvbiBkYXRlRnJvbUNvbmZpZyhjb25maWcpIHsKICAgICAgICB2YXIgaSwgZGF0ZSwgaW5wdXQgPSBbXSwgY3VycmVudERhdGUsCiAgICAgICAgICAgIHllYXJUb1VzZSwgZml4WWVhciwgdywgdGVtcCwgbGFuZywgd2Vla2RheSwgd2VlazsKCiAgICAgICAgaWYgKGNvbmZpZy5fZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjdXJyZW50RGF0ZSA9IGN1cnJlbnREYXRlQXJyYXkoY29uZmlnKTsKCiAgICAgICAgLy9jb21wdXRlIGRheSBvZiB0aGUgeWVhciBmcm9tIHdlZWtzIGFuZCB3ZWVrZGF5cwogICAgICAgIGlmIChjb25maWcuX3cgJiYgY29uZmlnLl9hW0RBVEVdID09IG51bGwgJiYgY29uZmlnLl9hW01PTlRIXSA9PSBudWxsKSB7CiAgICAgICAgICAgIGZpeFllYXIgPSBmdW5jdGlvbiAodmFsKSB7CiAgICAgICAgICAgICAgICB2YXIgaW50VmFsID0gcGFyc2VJbnQodmFsLCAxMCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsID8KICAgICAgICAgICAgICAgICAgKHZhbC5sZW5ndGggPCAzID8gKGludFZhbCA+IDY4ID8gMTkwMCArIGludFZhbCA6IDIwMDAgKyBpbnRWYWwpIDogaW50VmFsKSA6CiAgICAgICAgICAgICAgICAgIChjb25maWcuX2FbWUVBUl0gPT0gbnVsbCA/IG1vbWVudCgpLndlZWtZZWFyKCkgOiBjb25maWcuX2FbWUVBUl0pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdyA9IGNvbmZpZy5fdzsKICAgICAgICAgICAgaWYgKHcuR0cgIT0gbnVsbCB8fCB3LlcgIT0gbnVsbCB8fCB3LkUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGVtcCA9IGRheU9mWWVhckZyb21XZWVrcyhmaXhZZWFyKHcuR0cpLCB3LlcgfHwgMSwgdy5FLCA0LCAxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGxhbmcgPSBnZXRMYW5nRGVmaW5pdGlvbihjb25maWcuX2wpOwogICAgICAgICAgICAgICAgd2Vla2RheSA9IHcuZCAhPSBudWxsID8gIHBhcnNlV2Vla2RheSh3LmQsIGxhbmcpIDoKICAgICAgICAgICAgICAgICAgKHcuZSAhPSBudWxsID8gIHBhcnNlSW50KHcuZSwgMTApICsgbGFuZy5fd2Vlay5kb3cgOiAwKTsKCiAgICAgICAgICAgICAgICB3ZWVrID0gcGFyc2VJbnQody53LCAxMCkgfHwgMTsKCiAgICAgICAgICAgICAgICAvL2lmIHdlJ3JlIHBhcnNpbmcgJ2QnLCB0aGVuIHRoZSBsb3cgZGF5IG51bWJlcnMgbWF5IGJlIG5leHQgd2VlawogICAgICAgICAgICAgICAgaWYgKHcuZCAhPSBudWxsICYmIHdlZWtkYXkgPCBsYW5nLl93ZWVrLmRvdykgewogICAgICAgICAgICAgICAgICAgIHdlZWsrKzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0ZW1wID0gZGF5T2ZZZWFyRnJvbVdlZWtzKGZpeFllYXIody5nZyksIHdlZWssIHdlZWtkYXksIGxhbmcuX3dlZWsuZG95LCBsYW5nLl93ZWVrLmRvdyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbmZpZy5fYVtZRUFSXSA9IHRlbXAueWVhcjsKICAgICAgICAgICAgY29uZmlnLl9kYXlPZlllYXIgPSB0ZW1wLmRheU9mWWVhcjsKICAgICAgICB9CgogICAgICAgIC8vaWYgdGhlIGRheSBvZiB0aGUgeWVhciBpcyBzZXQsIGZpZ3VyZSBvdXQgd2hhdCBpdCBpcwogICAgICAgIGlmIChjb25maWcuX2RheU9mWWVhcikgewogICAgICAgICAgICB5ZWFyVG9Vc2UgPSBjb25maWcuX2FbWUVBUl0gPT0gbnVsbCA/IGN1cnJlbnREYXRlW1lFQVJdIDogY29uZmlnLl9hW1lFQVJdOwoKICAgICAgICAgICAgaWYgKGNvbmZpZy5fZGF5T2ZZZWFyID4gZGF5c0luWWVhcih5ZWFyVG9Vc2UpKSB7CiAgICAgICAgICAgICAgICBjb25maWcuX3BmLl9vdmVyZmxvd0RheU9mWWVhciA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGRhdGUgPSBtYWtlVVRDRGF0ZSh5ZWFyVG9Vc2UsIDAsIGNvbmZpZy5fZGF5T2ZZZWFyKTsKICAgICAgICAgICAgY29uZmlnLl9hW01PTlRIXSA9IGRhdGUuZ2V0VVRDTW9udGgoKTsKICAgICAgICAgICAgY29uZmlnLl9hW0RBVEVdID0gZGF0ZS5nZXRVVENEYXRlKCk7CiAgICAgICAgfQoKICAgICAgICAvLyBEZWZhdWx0IHRvIGN1cnJlbnQgZGF0ZS4KICAgICAgICAvLyAqIGlmIG5vIHllYXIsIG1vbnRoLCBkYXkgb2YgbW9udGggYXJlIGdpdmVuLCBkZWZhdWx0IHRvIHRvZGF5CiAgICAgICAgLy8gKiBpZiBkYXkgb2YgbW9udGggaXMgZ2l2ZW4sIGRlZmF1bHQgbW9udGggYW5kIHllYXIKICAgICAgICAvLyAqIGlmIG1vbnRoIGlzIGdpdmVuLCBkZWZhdWx0IG9ubHkgeWVhcgogICAgICAgIC8vICogaWYgeWVhciBpcyBnaXZlbiwgZG9uJ3QgZGVmYXVsdCBhbnl0aGluZwogICAgICAgIGZvciAoaSA9IDA7IGkgPCAzICYmIGNvbmZpZy5fYVtpXSA9PSBudWxsOyArK2kpIHsKICAgICAgICAgICAgY29uZmlnLl9hW2ldID0gaW5wdXRbaV0gPSBjdXJyZW50RGF0ZVtpXTsKICAgICAgICB9CgogICAgICAgIC8vIFplcm8gb3V0IHdoYXRldmVyIHdhcyBub3QgZGVmYXVsdGVkLCBpbmNsdWRpbmcgdGltZQogICAgICAgIGZvciAoOyBpIDwgNzsgaSsrKSB7CiAgICAgICAgICAgIGNvbmZpZy5fYVtpXSA9IGlucHV0W2ldID0gKGNvbmZpZy5fYVtpXSA9PSBudWxsKSA/IChpID09PSAyID8gMSA6IDApIDogY29uZmlnLl9hW2ldOwogICAgICAgIH0KCiAgICAgICAgLy8gYWRkIHRoZSBvZmZzZXRzIHRvIHRoZSB0aW1lIHRvIGJlIHBhcnNlZCBzbyB0aGF0IHdlIGNhbiBoYXZlIGEgY2xlYW4gYXJyYXkgZm9yIGNoZWNraW5nIGlzVmFsaWQKICAgICAgICBpbnB1dFtIT1VSXSArPSB0b0ludCgoY29uZmlnLl90em0gfHwgMCkgLyA2MCk7CiAgICAgICAgaW5wdXRbTUlOVVRFXSArPSB0b0ludCgoY29uZmlnLl90em0gfHwgMCkgJSA2MCk7CgogICAgICAgIGNvbmZpZy5fZCA9IChjb25maWcuX3VzZVVUQyA/IG1ha2VVVENEYXRlIDogbWFrZURhdGUpLmFwcGx5KG51bGwsIGlucHV0KTsKICAgIH0KCiAgICBmdW5jdGlvbiBkYXRlRnJvbU9iamVjdChjb25maWcpIHsKICAgICAgICB2YXIgbm9ybWFsaXplZElucHV0OwoKICAgICAgICBpZiAoY29uZmlnLl9kKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIG5vcm1hbGl6ZWRJbnB1dCA9IG5vcm1hbGl6ZU9iamVjdFVuaXRzKGNvbmZpZy5faSk7CiAgICAgICAgY29uZmlnLl9hID0gWwogICAgICAgICAgICBub3JtYWxpemVkSW5wdXQueWVhciwKICAgICAgICAgICAgbm9ybWFsaXplZElucHV0Lm1vbnRoLAogICAgICAgICAgICBub3JtYWxpemVkSW5wdXQuZGF5LAogICAgICAgICAgICBub3JtYWxpemVkSW5wdXQuaG91ciwKICAgICAgICAgICAgbm9ybWFsaXplZElucHV0Lm1pbnV0ZSwKICAgICAgICAgICAgbm9ybWFsaXplZElucHV0LnNlY29uZCwKICAgICAgICAgICAgbm9ybWFsaXplZElucHV0Lm1pbGxpc2Vjb25kCiAgICAgICAgXTsKCiAgICAgICAgZGF0ZUZyb21Db25maWcoY29uZmlnKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjdXJyZW50RGF0ZUFycmF5KGNvbmZpZykgewogICAgICAgIHZhciBub3cgPSBuZXcgRGF0ZSgpOwogICAgICAgIGlmIChjb25maWcuX3VzZVVUQykgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgbm93LmdldFVUQ0Z1bGxZZWFyKCksCiAgICAgICAgICAgICAgICBub3cuZ2V0VVRDTW9udGgoKSwKICAgICAgICAgICAgICAgIG5vdy5nZXRVVENEYXRlKCkKICAgICAgICAgICAgXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gW25vdy5nZXRGdWxsWWVhcigpLCBub3cuZ2V0TW9udGgoKSwgbm93LmdldERhdGUoKV07CiAgICAgICAgfQogICAgfQoKICAgIC8vIGRhdGUgZnJvbSBzdHJpbmcgYW5kIGZvcm1hdCBzdHJpbmcKICAgIGZ1bmN0aW9uIG1ha2VEYXRlRnJvbVN0cmluZ0FuZEZvcm1hdChjb25maWcpIHsKCiAgICAgICAgY29uZmlnLl9hID0gW107CiAgICAgICAgY29uZmlnLl9wZi5lbXB0eSA9IHRydWU7CgogICAgICAgIC8vIFRoaXMgYXJyYXkgaXMgdXNlZCB0byBtYWtlIGEgRGF0ZSwgZWl0aGVyIHdpdGggYG5ldyBEYXRlYCBvciBgRGF0ZS5VVENgCiAgICAgICAgdmFyIGxhbmcgPSBnZXRMYW5nRGVmaW5pdGlvbihjb25maWcuX2wpLAogICAgICAgICAgICBzdHJpbmcgPSAnJyArIGNvbmZpZy5faSwKICAgICAgICAgICAgaSwgcGFyc2VkSW5wdXQsIHRva2VucywgdG9rZW4sIHNraXBwZWQsCiAgICAgICAgICAgIHN0cmluZ0xlbmd0aCA9IHN0cmluZy5sZW5ndGgsCiAgICAgICAgICAgIHRvdGFsUGFyc2VkSW5wdXRMZW5ndGggPSAwOwoKICAgICAgICB0b2tlbnMgPSBleHBhbmRGb3JtYXQoY29uZmlnLl9mLCBsYW5nKS5tYXRjaChmb3JtYXR0aW5nVG9rZW5zKSB8fCBbXTsKCiAgICAgICAgZm9yIChpID0gMDsgaSA8IHRva2Vucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB0b2tlbiA9IHRva2Vuc1tpXTsKICAgICAgICAgICAgcGFyc2VkSW5wdXQgPSAoc3RyaW5nLm1hdGNoKGdldFBhcnNlUmVnZXhGb3JUb2tlbih0b2tlbiwgY29uZmlnKSkgfHwgW10pWzBdOwogICAgICAgICAgICBpZiAocGFyc2VkSW5wdXQpIHsKICAgICAgICAgICAgICAgIHNraXBwZWQgPSBzdHJpbmcuc3Vic3RyKDAsIHN0cmluZy5pbmRleE9mKHBhcnNlZElucHV0KSk7CiAgICAgICAgICAgICAgICBpZiAoc2tpcHBlZC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uZmlnLl9wZi51bnVzZWRJbnB1dC5wdXNoKHNraXBwZWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnNsaWNlKHN0cmluZy5pbmRleE9mKHBhcnNlZElucHV0KSArIHBhcnNlZElucHV0Lmxlbmd0aCk7CiAgICAgICAgICAgICAgICB0b3RhbFBhcnNlZElucHV0TGVuZ3RoICs9IHBhcnNlZElucHV0Lmxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBkb24ndCBwYXJzZSBpZiBpdCdzIG5vdCBhIGtub3duIHRva2VuCiAgICAgICAgICAgIGlmIChmb3JtYXRUb2tlbkZ1bmN0aW9uc1t0b2tlbl0pIHsKICAgICAgICAgICAgICAgIGlmIChwYXJzZWRJbnB1dCkgewogICAgICAgICAgICAgICAgICAgIGNvbmZpZy5fcGYuZW1wdHkgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbmZpZy5fcGYudW51c2VkVG9rZW5zLnB1c2godG9rZW4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYWRkVGltZVRvQXJyYXlGcm9tVG9rZW4odG9rZW4sIHBhcnNlZElucHV0LCBjb25maWcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKGNvbmZpZy5fc3RyaWN0ICYmICFwYXJzZWRJbnB1dCkgewogICAgICAgICAgICAgICAgY29uZmlnLl9wZi51bnVzZWRUb2tlbnMucHVzaCh0b2tlbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIGFkZCByZW1haW5pbmcgdW5wYXJzZWQgaW5wdXQgbGVuZ3RoIHRvIHRoZSBzdHJpbmcKICAgICAgICBjb25maWcuX3BmLmNoYXJzTGVmdE92ZXIgPSBzdHJpbmdMZW5ndGggLSB0b3RhbFBhcnNlZElucHV0TGVuZ3RoOwogICAgICAgIGlmIChzdHJpbmcubGVuZ3RoID4gMCkgewogICAgICAgICAgICBjb25maWcuX3BmLnVudXNlZElucHV0LnB1c2goc3RyaW5nKTsKICAgICAgICB9CgogICAgICAgIC8vIGhhbmRsZSBhbSBwbQogICAgICAgIGlmIChjb25maWcuX2lzUG0gJiYgY29uZmlnLl9hW0hPVVJdIDwgMTIpIHsKICAgICAgICAgICAgY29uZmlnLl9hW0hPVVJdICs9IDEyOwogICAgICAgIH0KICAgICAgICAvLyBpZiBpcyAxMiBhbSwgY2hhbmdlIGhvdXJzIHRvIDAKICAgICAgICBpZiAoY29uZmlnLl9pc1BtID09PSBmYWxzZSAmJiBjb25maWcuX2FbSE9VUl0gPT09IDEyKSB7CiAgICAgICAgICAgIGNvbmZpZy5fYVtIT1VSXSA9IDA7CiAgICAgICAgfQoKICAgICAgICBkYXRlRnJvbUNvbmZpZyhjb25maWcpOwogICAgICAgIGNoZWNrT3ZlcmZsb3coY29uZmlnKTsKICAgIH0KCiAgICBmdW5jdGlvbiB1bmVzY2FwZUZvcm1hdChzKSB7CiAgICAgICAgcmV0dXJuIHMucmVwbGFjZSgvXFwoXFspfFxcKFxdKXxcWyhbXlxdXFtdKilcXXxcXCguKS9nLCBmdW5jdGlvbiAobWF0Y2hlZCwgcDEsIHAyLCBwMywgcDQpIHsKICAgICAgICAgICAgcmV0dXJuIHAxIHx8IHAyIHx8IHAzIHx8IHA0OwogICAgICAgIH0pOwogICAgfQoKICAgIC8vIENvZGUgZnJvbSBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzM1NjE0OTMvaXMtdGhlcmUtYS1yZWdleHAtZXNjYXBlLWZ1bmN0aW9uLWluLWphdmFzY3JpcHQKICAgIGZ1bmN0aW9uIHJlZ2V4cEVzY2FwZShzKSB7CiAgICAgICAgcmV0dXJuIHMucmVwbGFjZSgvWy1cL1xcXiQqKz8uKCl8W1xde31dL2csICdcXCQmJyk7CiAgICB9CgogICAgLy8gZGF0ZSBmcm9tIHN0cmluZyBhbmQgYXJyYXkgb2YgZm9ybWF0IHN0cmluZ3MKICAgIGZ1bmN0aW9uIG1ha2VEYXRlRnJvbVN0cmluZ0FuZEFycmF5KGNvbmZpZykgewogICAgICAgIHZhciB0ZW1wQ29uZmlnLAogICAgICAgICAgICBiZXN0TW9tZW50LAoKICAgICAgICAgICAgc2NvcmVUb0JlYXQsCiAgICAgICAgICAgIGksCiAgICAgICAgICAgIGN1cnJlbnRTY29yZTsKCiAgICAgICAgaWYgKGNvbmZpZy5fZi5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgY29uZmlnLl9wZi5pbnZhbGlkRm9ybWF0ID0gdHJ1ZTsKICAgICAgICAgICAgY29uZmlnLl9kID0gbmV3IERhdGUoTmFOKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvbmZpZy5fZi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjdXJyZW50U2NvcmUgPSAwOwogICAgICAgICAgICB0ZW1wQ29uZmlnID0gZXh0ZW5kKHt9LCBjb25maWcpOwogICAgICAgICAgICB0ZW1wQ29uZmlnLl9wZiA9IGRlZmF1bHRQYXJzaW5nRmxhZ3MoKTsKICAgICAgICAgICAgdGVtcENvbmZpZy5fZiA9IGNvbmZpZy5fZltpXTsKICAgICAgICAgICAgbWFrZURhdGVGcm9tU3RyaW5nQW5kRm9ybWF0KHRlbXBDb25maWcpOwoKICAgICAgICAgICAgaWYgKCFpc1ZhbGlkKHRlbXBDb25maWcpKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaWYgdGhlcmUgaXMgYW55IGlucHV0IHRoYXQgd2FzIG5vdCBwYXJzZWQgYWRkIGEgcGVuYWx0eSBmb3IgdGhhdCBmb3JtYXQKICAgICAgICAgICAgY3VycmVudFNjb3JlICs9IHRlbXBDb25maWcuX3BmLmNoYXJzTGVmdE92ZXI7CgogICAgICAgICAgICAvL29yIHRva2VucwogICAgICAgICAgICBjdXJyZW50U2NvcmUgKz0gdGVtcENvbmZpZy5fcGYudW51c2VkVG9rZW5zLmxlbmd0aCAqIDEwOwoKICAgICAgICAgICAgdGVtcENvbmZpZy5fcGYuc2NvcmUgPSBjdXJyZW50U2NvcmU7CgogICAgICAgICAgICBpZiAoc2NvcmVUb0JlYXQgPT0gbnVsbCB8fCBjdXJyZW50U2NvcmUgPCBzY29yZVRvQmVhdCkgewogICAgICAgICAgICAgICAgc2NvcmVUb0JlYXQgPSBjdXJyZW50U2NvcmU7CiAgICAgICAgICAgICAgICBiZXN0TW9tZW50ID0gdGVtcENvbmZpZzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZXh0ZW5kKGNvbmZpZywgYmVzdE1vbWVudCB8fCB0ZW1wQ29uZmlnKTsKICAgIH0KCiAgICAvLyBkYXRlIGZyb20gaXNvIGZvcm1hdAogICAgZnVuY3Rpb24gbWFrZURhdGVGcm9tU3RyaW5nKGNvbmZpZykgewogICAgICAgIHZhciBpLCBsLAogICAgICAgICAgICBzdHJpbmcgPSBjb25maWcuX2ksCiAgICAgICAgICAgIG1hdGNoID0gaXNvUmVnZXguZXhlYyhzdHJpbmcpOwoKICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgY29uZmlnLl9wZi5pc28gPSB0cnVlOwogICAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gaXNvRGF0ZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNvRGF0ZXNbaV1bMV0uZXhlYyhzdHJpbmcpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gbWF0Y2hbNV0gc2hvdWxkIGJlICJUIiBvciB1bmRlZmluZWQKICAgICAgICAgICAgICAgICAgICBjb25maWcuX2YgPSBpc29EYXRlc1tpXVswXSArIChtYXRjaFs2XSB8fCAiICIpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBpc29UaW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChpc29UaW1lc1tpXVsxXS5leGVjKHN0cmluZykpIHsKICAgICAgICAgICAgICAgICAgICBjb25maWcuX2YgKz0gaXNvVGltZXNbaV1bMF07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHN0cmluZy5tYXRjaChwYXJzZVRva2VuVGltZXpvbmUpKSB7CiAgICAgICAgICAgICAgICBjb25maWcuX2YgKz0gIloiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1ha2VEYXRlRnJvbVN0cmluZ0FuZEZvcm1hdChjb25maWcpOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgbW9tZW50LmNyZWF0ZUZyb21JbnB1dEZhbGxiYWNrKGNvbmZpZyk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG1ha2VEYXRlRnJvbUlucHV0KGNvbmZpZykgewogICAgICAgIHZhciBpbnB1dCA9IGNvbmZpZy5faSwKICAgICAgICAgICAgbWF0Y2hlZCA9IGFzcE5ldEpzb25SZWdleC5leGVjKGlucHV0KTsKCiAgICAgICAgaWYgKGlucHV0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgY29uZmlnLl9kID0gbmV3IERhdGUoKTsKICAgICAgICB9IGVsc2UgaWYgKG1hdGNoZWQpIHsKICAgICAgICAgICAgY29uZmlnLl9kID0gbmV3IERhdGUoK21hdGNoZWRbMV0pOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGlucHV0ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICBtYWtlRGF0ZUZyb21TdHJpbmcoY29uZmlnKTsKICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkoaW5wdXQpKSB7CiAgICAgICAgICAgIGNvbmZpZy5fYSA9IGlucHV0LnNsaWNlKDApOwogICAgICAgICAgICBkYXRlRnJvbUNvbmZpZyhjb25maWcpOwogICAgICAgIH0gZWxzZSBpZiAoaXNEYXRlKGlucHV0KSkgewogICAgICAgICAgICBjb25maWcuX2QgPSBuZXcgRGF0ZSgraW5wdXQpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mKGlucHV0KSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgZGF0ZUZyb21PYmplY3QoY29uZmlnKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZihpbnB1dCkgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgIC8vIGZyb20gbWlsbGlzZWNvbmRzCiAgICAgICAgICAgIGNvbmZpZy5fZCA9IG5ldyBEYXRlKGlucHV0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtb21lbnQuY3JlYXRlRnJvbUlucHV0RmFsbGJhY2soY29uZmlnKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gbWFrZURhdGUoeSwgbSwgZCwgaCwgTSwgcywgbXMpIHsKICAgICAgICAvL2Nhbid0IGp1c3QgYXBwbHkoKSB0byBjcmVhdGUgYSBkYXRlOgogICAgICAgIC8vaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8xODEzNDgvaW5zdGFudGlhdGluZy1hLWphdmFzY3JpcHQtb2JqZWN0LWJ5LWNhbGxpbmctcHJvdG90eXBlLWNvbnN0cnVjdG9yLWFwcGx5CiAgICAgICAgdmFyIGRhdGUgPSBuZXcgRGF0ZSh5LCBtLCBkLCBoLCBNLCBzLCBtcyk7CgogICAgICAgIC8vdGhlIGRhdGUgY29uc3RydWN0b3IgZG9lc24ndCBhY2NlcHQgeWVhcnMgPCAxOTcwCiAgICAgICAgaWYgKHkgPCAxOTcwKSB7CiAgICAgICAgICAgIGRhdGUuc2V0RnVsbFllYXIoeSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBkYXRlOwogICAgfQoKICAgIGZ1bmN0aW9uIG1ha2VVVENEYXRlKHkpIHsKICAgICAgICB2YXIgZGF0ZSA9IG5ldyBEYXRlKERhdGUuVVRDLmFwcGx5KG51bGwsIGFyZ3VtZW50cykpOwogICAgICAgIGlmICh5IDwgMTk3MCkgewogICAgICAgICAgICBkYXRlLnNldFVUQ0Z1bGxZZWFyKHkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGF0ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBwYXJzZVdlZWtkYXkoaW5wdXQsIGxhbmd1YWdlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBpbnB1dCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgaWYgKCFpc05hTihpbnB1dCkpIHsKICAgICAgICAgICAgICAgIGlucHV0ID0gcGFyc2VJbnQoaW5wdXQsIDEwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGlucHV0ID0gbGFuZ3VhZ2Uud2Vla2RheXNQYXJzZShpbnB1dCk7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGlucHV0ICE9PSAnbnVtYmVyJykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBpbnB1dDsKICAgIH0KCiAgICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICAgICAgUmVsYXRpdmUgVGltZQogICAgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwoKCiAgICAvLyBoZWxwZXIgZnVuY3Rpb24gZm9yIG1vbWVudC5mbi5mcm9tLCBtb21lbnQuZm4uZnJvbU5vdywgYW5kIG1vbWVudC5kdXJhdGlvbi5mbi5odW1hbml6ZQogICAgZnVuY3Rpb24gc3Vic3RpdHV0ZVRpbWVBZ28oc3RyaW5nLCBudW1iZXIsIHdpdGhvdXRTdWZmaXgsIGlzRnV0dXJlLCBsYW5nKSB7CiAgICAgICAgcmV0dXJuIGxhbmcucmVsYXRpdmVUaW1lKG51bWJlciB8fCAxLCAhIXdpdGhvdXRTdWZmaXgsIHN0cmluZywgaXNGdXR1cmUpOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlbGF0aXZlVGltZShtaWxsaXNlY29uZHMsIHdpdGhvdXRTdWZmaXgsIGxhbmcpIHsKICAgICAgICB2YXIgc2Vjb25kcyA9IHJvdW5kKE1hdGguYWJzKG1pbGxpc2Vjb25kcykgLyAxMDAwKSwKICAgICAgICAgICAgbWludXRlcyA9IHJvdW5kKHNlY29uZHMgLyA2MCksCiAgICAgICAgICAgIGhvdXJzID0gcm91bmQobWludXRlcyAvIDYwKSwKICAgICAgICAgICAgZGF5cyA9IHJvdW5kKGhvdXJzIC8gMjQpLAogICAgICAgICAgICB5ZWFycyA9IHJvdW5kKGRheXMgLyAzNjUpLAogICAgICAgICAgICBhcmdzID0gc2Vjb25kcyA8IDQ1ICYmIFsncycsIHNlY29uZHNdIHx8CiAgICAgICAgICAgICAgICBtaW51dGVzID09PSAxICYmIFsnbSddIHx8CiAgICAgICAgICAgICAgICBtaW51dGVzIDwgNDUgJiYgWydtbScsIG1pbnV0ZXNdIHx8CiAgICAgICAgICAgICAgICBob3VycyA9PT0gMSAmJiBbJ2gnXSB8fAogICAgICAgICAgICAgICAgaG91cnMgPCAyMiAmJiBbJ2hoJywgaG91cnNdIHx8CiAgICAgICAgICAgICAgICBkYXlzID09PSAxICYmIFsnZCddIHx8CiAgICAgICAgICAgICAgICBkYXlzIDw9IDI1ICYmIFsnZGQnLCBkYXlzXSB8fAogICAgICAgICAgICAgICAgZGF5cyA8PSA0NSAmJiBbJ00nXSB8fAogICAgICAgICAgICAgICAgZGF5cyA8IDM0NSAmJiBbJ01NJywgcm91bmQoZGF5cyAvIDMwKV0gfHwKICAgICAgICAgICAgICAgIHllYXJzID09PSAxICYmIFsneSddIHx8IFsneXknLCB5ZWFyc107CiAgICAgICAgYXJnc1syXSA9IHdpdGhvdXRTdWZmaXg7CiAgICAgICAgYXJnc1szXSA9IG1pbGxpc2Vjb25kcyA+IDA7CiAgICAgICAgYXJnc1s0XSA9IGxhbmc7CiAgICAgICAgcmV0dXJuIHN1YnN0aXR1dGVUaW1lQWdvLmFwcGx5KHt9LCBhcmdzKTsKICAgIH0KCgogICAgLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgogICAgICAgIFdlZWsgb2YgWWVhcgogICAgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwoKCiAgICAvLyBmaXJzdERheU9mV2VlayAgICAgICAwID0gc3VuLCA2ID0gc2F0CiAgICAvLyAgICAgICAgICAgICAgICAgICAgICB0aGUgZGF5IG9mIHRoZSB3ZWVrIHRoYXQgc3RhcnRzIHRoZSB3ZWVrCiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAodXN1YWxseSBzdW5kYXkgb3IgbW9uZGF5KQogICAgLy8gZmlyc3REYXlPZldlZWtPZlllYXIgMCA9IHN1biwgNiA9IHNhdAogICAgLy8gICAgICAgICAgICAgICAgICAgICAgdGhlIGZpcnN0IHdlZWsgaXMgdGhlIHdlZWsgdGhhdCBjb250YWlucyB0aGUgZmlyc3QKICAgIC8vICAgICAgICAgICAgICAgICAgICAgIG9mIHRoaXMgZGF5IG9mIHRoZSB3ZWVrCiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAoZWcuIElTTyB3ZWVrcyB1c2UgdGh1cnNkYXkgKDQpKQogICAgZnVuY3Rpb24gd2Vla09mWWVhcihtb20sIGZpcnN0RGF5T2ZXZWVrLCBmaXJzdERheU9mV2Vla09mWWVhcikgewogICAgICAgIHZhciBlbmQgPSBmaXJzdERheU9mV2Vla09mWWVhciAtIGZpcnN0RGF5T2ZXZWVrLAogICAgICAgICAgICBkYXlzVG9EYXlPZldlZWsgPSBmaXJzdERheU9mV2Vla09mWWVhciAtIG1vbS5kYXkoKSwKICAgICAgICAgICAgYWRqdXN0ZWRNb21lbnQ7CgoKICAgICAgICBpZiAoZGF5c1RvRGF5T2ZXZWVrID4gZW5kKSB7CiAgICAgICAgICAgIGRheXNUb0RheU9mV2VlayAtPSA3OwogICAgICAgIH0KCiAgICAgICAgaWYgKGRheXNUb0RheU9mV2VlayA8IGVuZCAtIDcpIHsKICAgICAgICAgICAgZGF5c1RvRGF5T2ZXZWVrICs9IDc7CiAgICAgICAgfQoKICAgICAgICBhZGp1c3RlZE1vbWVudCA9IG1vbWVudChtb20pLmFkZCgnZCcsIGRheXNUb0RheU9mV2Vlayk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgd2VlazogTWF0aC5jZWlsKGFkanVzdGVkTW9tZW50LmRheU9mWWVhcigpIC8gNyksCiAgICAgICAgICAgIHllYXI6IGFkanVzdGVkTW9tZW50LnllYXIoKQogICAgICAgIH07CiAgICB9CgogICAgLy9odHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0lTT193ZWVrX2RhdGUjQ2FsY3VsYXRpbmdfYV9kYXRlX2dpdmVuX3RoZV95ZWFyLjJDX3dlZWtfbnVtYmVyX2FuZF93ZWVrZGF5CiAgICBmdW5jdGlvbiBkYXlPZlllYXJGcm9tV2Vla3MoeWVhciwgd2Vlaywgd2Vla2RheSwgZmlyc3REYXlPZldlZWtPZlllYXIsIGZpcnN0RGF5T2ZXZWVrKSB7CiAgICAgICAgdmFyIGQgPSBtYWtlVVRDRGF0ZSh5ZWFyLCAwLCAxKS5nZXRVVENEYXkoKSwgZGF5c1RvQWRkLCBkYXlPZlllYXI7CgogICAgICAgIHdlZWtkYXkgPSB3ZWVrZGF5ICE9IG51bGwgPyB3ZWVrZGF5IDogZmlyc3REYXlPZldlZWs7CiAgICAgICAgZGF5c1RvQWRkID0gZmlyc3REYXlPZldlZWsgLSBkICsgKGQgPiBmaXJzdERheU9mV2Vla09mWWVhciA/IDcgOiAwKSAtIChkIDwgZmlyc3REYXlPZldlZWsgPyA3IDogMCk7CiAgICAgICAgZGF5T2ZZZWFyID0gNyAqICh3ZWVrIC0gMSkgKyAod2Vla2RheSAtIGZpcnN0RGF5T2ZXZWVrKSArIGRheXNUb0FkZCArIDE7CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHllYXI6IGRheU9mWWVhciA+IDAgPyB5ZWFyIDogeWVhciAtIDEsCiAgICAgICAgICAgIGRheU9mWWVhcjogZGF5T2ZZZWFyID4gMCA/ICBkYXlPZlllYXIgOiBkYXlzSW5ZZWFyKHllYXIgLSAxKSArIGRheU9mWWVhcgogICAgICAgIH07CiAgICB9CgogICAgLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgogICAgICAgIFRvcCBMZXZlbCBGdW5jdGlvbnMKICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCiAgICBmdW5jdGlvbiBtYWtlTW9tZW50KGNvbmZpZykgewogICAgICAgIHZhciBpbnB1dCA9IGNvbmZpZy5faSwKICAgICAgICAgICAgZm9ybWF0ID0gY29uZmlnLl9mOwoKICAgICAgICBpZiAoaW5wdXQgPT09IG51bGwgfHwgKGZvcm1hdCA9PT0gdW5kZWZpbmVkICYmIGlucHV0ID09PSAnJykpIHsKICAgICAgICAgICAgcmV0dXJuIG1vbWVudC5pbnZhbGlkKHtudWxsSW5wdXQ6IHRydWV9KTsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgaW5wdXQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIGNvbmZpZy5faSA9IGlucHV0ID0gZ2V0TGFuZ0RlZmluaXRpb24oKS5wcmVwYXJzZShpbnB1dCk7CiAgICAgICAgfQoKICAgICAgICBpZiAobW9tZW50LmlzTW9tZW50KGlucHV0KSkgewogICAgICAgICAgICBjb25maWcgPSBjbG9uZU1vbWVudChpbnB1dCk7CgogICAgICAgICAgICBjb25maWcuX2QgPSBuZXcgRGF0ZSgraW5wdXQuX2QpOwogICAgICAgIH0gZWxzZSBpZiAoZm9ybWF0KSB7CiAgICAgICAgICAgIGlmIChpc0FycmF5KGZvcm1hdCkpIHsKICAgICAgICAgICAgICAgIG1ha2VEYXRlRnJvbVN0cmluZ0FuZEFycmF5KGNvbmZpZyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtYWtlRGF0ZUZyb21TdHJpbmdBbmRGb3JtYXQoY29uZmlnKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG1ha2VEYXRlRnJvbUlucHV0KGNvbmZpZyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbmV3IE1vbWVudChjb25maWcpOwogICAgfQoKICAgIG1vbWVudCA9IGZ1bmN0aW9uIChpbnB1dCwgZm9ybWF0LCBsYW5nLCBzdHJpY3QpIHsKICAgICAgICB2YXIgYzsKCiAgICAgICAgaWYgKHR5cGVvZihsYW5nKSA9PT0gImJvb2xlYW4iKSB7CiAgICAgICAgICAgIHN0cmljdCA9IGxhbmc7CiAgICAgICAgICAgIGxhbmcgPSB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgICAgIC8vIG9iamVjdCBjb25zdHJ1Y3Rpb24gbXVzdCBiZSBkb25lIHRoaXMgd2F5LgogICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9tb21lbnQvbW9tZW50L2lzc3Vlcy8xNDIzCiAgICAgICAgYyA9IHt9OwogICAgICAgIGMuX2lzQU1vbWVudE9iamVjdCA9IHRydWU7CiAgICAgICAgYy5faSA9IGlucHV0OwogICAgICAgIGMuX2YgPSBmb3JtYXQ7CiAgICAgICAgYy5fbCA9IGxhbmc7CiAgICAgICAgYy5fc3RyaWN0ID0gc3RyaWN0OwogICAgICAgIGMuX2lzVVRDID0gZmFsc2U7CiAgICAgICAgYy5fcGYgPSBkZWZhdWx0UGFyc2luZ0ZsYWdzKCk7CgogICAgICAgIHJldHVybiBtYWtlTW9tZW50KGMpOwogICAgfTsKCiAgICBtb21lbnQuc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmdzID0gZmFsc2U7CgogICAgbW9tZW50LmNyZWF0ZUZyb21JbnB1dEZhbGxiYWNrID0gZGVwcmVjYXRlKAogICAgICAgICAgICAibW9tZW50IGNvbnN0cnVjdGlvbiBmYWxscyBiYWNrIHRvIGpzIERhdGUuIFRoaXMgaXMgIiArCiAgICAgICAgICAgICJkaXNjb3VyYWdlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIHVwY29taW5nIG1ham9yICIgKwogICAgICAgICAgICAicmVsZWFzZS4gUGxlYXNlIHJlZmVyIHRvICIgKwogICAgICAgICAgICAiaHR0cHM6Ly9naXRodWIuY29tL21vbWVudC9tb21lbnQvaXNzdWVzLzE0MDcgZm9yIG1vcmUgaW5mby4iLAogICAgICAgICAgICBmdW5jdGlvbiAoY29uZmlnKSB7CiAgICAgICAgY29uZmlnLl9kID0gbmV3IERhdGUoY29uZmlnLl9pKTsKICAgIH0pOwoKICAgIC8vIGNyZWF0aW5nIHdpdGggdXRjCiAgICBtb21lbnQudXRjID0gZnVuY3Rpb24gKGlucHV0LCBmb3JtYXQsIGxhbmcsIHN0cmljdCkgewogICAgICAgIHZhciBjOwoKICAgICAgICBpZiAodHlwZW9mKGxhbmcpID09PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgc3RyaWN0ID0gbGFuZzsKICAgICAgICAgICAgbGFuZyA9IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICAgICAgLy8gb2JqZWN0IGNvbnN0cnVjdGlvbiBtdXN0IGJlIGRvbmUgdGhpcyB3YXkuCiAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21vbWVudC9tb21lbnQvaXNzdWVzLzE0MjMKICAgICAgICBjID0ge307CiAgICAgICAgYy5faXNBTW9tZW50T2JqZWN0ID0gdHJ1ZTsKICAgICAgICBjLl91c2VVVEMgPSB0cnVlOwogICAgICAgIGMuX2lzVVRDID0gdHJ1ZTsKICAgICAgICBjLl9sID0gbGFuZzsKICAgICAgICBjLl9pID0gaW5wdXQ7CiAgICAgICAgYy5fZiA9IGZvcm1hdDsKICAgICAgICBjLl9zdHJpY3QgPSBzdHJpY3Q7CiAgICAgICAgYy5fcGYgPSBkZWZhdWx0UGFyc2luZ0ZsYWdzKCk7CgogICAgICAgIHJldHVybiBtYWtlTW9tZW50KGMpLnV0YygpOwogICAgfTsKCiAgICAvLyBjcmVhdGluZyB3aXRoIHVuaXggdGltZXN0YW1wIChpbiBzZWNvbmRzKQogICAgbW9tZW50LnVuaXggPSBmdW5jdGlvbiAoaW5wdXQpIHsKICAgICAgICByZXR1cm4gbW9tZW50KGlucHV0ICogMTAwMCk7CiAgICB9OwoKICAgIC8vIGR1cmF0aW9uCiAgICBtb21lbnQuZHVyYXRpb24gPSBmdW5jdGlvbiAoaW5wdXQsIGtleSkgewogICAgICAgIHZhciBkdXJhdGlvbiA9IGlucHV0LAogICAgICAgICAgICAvLyBtYXRjaGluZyBhZ2FpbnN0IHJlZ2V4cCBpcyBleHBlbnNpdmUsIGRvIGl0IG9uIGRlbWFuZAogICAgICAgICAgICBtYXRjaCA9IG51bGwsCiAgICAgICAgICAgIHNpZ24sCiAgICAgICAgICAgIHJldCwKICAgICAgICAgICAgcGFyc2VJc287CgogICAgICAgIGlmIChtb21lbnQuaXNEdXJhdGlvbihpbnB1dCkpIHsKICAgICAgICAgICAgZHVyYXRpb24gPSB7CiAgICAgICAgICAgICAgICBtczogaW5wdXQuX21pbGxpc2Vjb25kcywKICAgICAgICAgICAgICAgIGQ6IGlucHV0Ll9kYXlzLAogICAgICAgICAgICAgICAgTTogaW5wdXQuX21vbnRocwogICAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGlucHV0ID09PSAnbnVtYmVyJykgewogICAgICAgICAgICBkdXJhdGlvbiA9IHt9OwogICAgICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgICBkdXJhdGlvbltrZXldID0gaW5wdXQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkdXJhdGlvbi5taWxsaXNlY29uZHMgPSBpbnB1dDsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoISEobWF0Y2ggPSBhc3BOZXRUaW1lU3Bhbkpzb25SZWdleC5leGVjKGlucHV0KSkpIHsKICAgICAgICAgICAgc2lnbiA9IChtYXRjaFsxXSA9PT0gIi0iKSA/IC0xIDogMTsKICAgICAgICAgICAgZHVyYXRpb24gPSB7CiAgICAgICAgICAgICAgICB5OiAwLAogICAgICAgICAgICAgICAgZDogdG9JbnQobWF0Y2hbREFURV0pICogc2lnbiwKICAgICAgICAgICAgICAgIGg6IHRvSW50KG1hdGNoW0hPVVJdKSAqIHNpZ24sCiAgICAgICAgICAgICAgICBtOiB0b0ludChtYXRjaFtNSU5VVEVdKSAqIHNpZ24sCiAgICAgICAgICAgICAgICBzOiB0b0ludChtYXRjaFtTRUNPTkRdKSAqIHNpZ24sCiAgICAgICAgICAgICAgICBtczogdG9JbnQobWF0Y2hbTUlMTElTRUNPTkRdKSAqIHNpZ24KICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgaWYgKCEhKG1hdGNoID0gaXNvRHVyYXRpb25SZWdleC5leGVjKGlucHV0KSkpIHsKICAgICAgICAgICAgc2lnbiA9IChtYXRjaFsxXSA9PT0gIi0iKSA/IC0xIDogMTsKICAgICAgICAgICAgcGFyc2VJc28gPSBmdW5jdGlvbiAoaW5wKSB7CiAgICAgICAgICAgICAgICAvLyBXZSdkIG5vcm1hbGx5IHVzZSB+fmlucCBmb3IgdGhpcywgYnV0IHVuZm9ydHVuYXRlbHkgaXQgYWxzbwogICAgICAgICAgICAgICAgLy8gY29udmVydHMgZmxvYXRzIHRvIGludHMuCiAgICAgICAgICAgICAgICAvLyBpbnAgbWF5IGJlIHVuZGVmaW5lZCwgc28gY2FyZWZ1bCBjYWxsaW5nIHJlcGxhY2Ugb24gaXQuCiAgICAgICAgICAgICAgICB2YXIgcmVzID0gaW5wICYmIHBhcnNlRmxvYXQoaW5wLnJlcGxhY2UoJywnLCAnLicpKTsKICAgICAgICAgICAgICAgIC8vIGFwcGx5IHNpZ24gd2hpbGUgd2UncmUgYXQgaXQKICAgICAgICAgICAgICAgIHJldHVybiAoaXNOYU4ocmVzKSA/IDAgOiByZXMpICogc2lnbjsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgZHVyYXRpb24gPSB7CiAgICAgICAgICAgICAgICB5OiBwYXJzZUlzbyhtYXRjaFsyXSksCiAgICAgICAgICAgICAgICBNOiBwYXJzZUlzbyhtYXRjaFszXSksCiAgICAgICAgICAgICAgICBkOiBwYXJzZUlzbyhtYXRjaFs0XSksCiAgICAgICAgICAgICAgICBoOiBwYXJzZUlzbyhtYXRjaFs1XSksCiAgICAgICAgICAgICAgICBtOiBwYXJzZUlzbyhtYXRjaFs2XSksCiAgICAgICAgICAgICAgICBzOiBwYXJzZUlzbyhtYXRjaFs3XSksCiAgICAgICAgICAgICAgICB3OiBwYXJzZUlzbyhtYXRjaFs4XSkKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIHJldCA9IG5ldyBEdXJhdGlvbihkdXJhdGlvbik7CgogICAgICAgIGlmIChtb21lbnQuaXNEdXJhdGlvbihpbnB1dCkgJiYgaW5wdXQuaGFzT3duUHJvcGVydHkoJ19sYW5nJykpIHsKICAgICAgICAgICAgcmV0Ll9sYW5nID0gaW5wdXQuX2xhbmc7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmV0OwogICAgfTsKCiAgICAvLyB2ZXJzaW9uIG51bWJlcgogICAgbW9tZW50LnZlcnNpb24gPSBWRVJTSU9OOwoKICAgIC8vIGRlZmF1bHQgZm9ybWF0CiAgICBtb21lbnQuZGVmYXVsdEZvcm1hdCA9IGlzb0Zvcm1hdDsKCiAgICAvLyBQbHVnaW5zIHRoYXQgYWRkIHByb3BlcnRpZXMgc2hvdWxkIGFsc28gYWRkIHRoZSBrZXkgaGVyZSAobnVsbCB2YWx1ZSksCiAgICAvLyBzbyB3ZSBjYW4gcHJvcGVybHkgY2xvbmUgb3Vyc2VsdmVzLgogICAgbW9tZW50Lm1vbWVudFByb3BlcnRpZXMgPSBtb21lbnRQcm9wZXJ0aWVzOwoKICAgIC8vIFRoaXMgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgd2hlbmV2ZXIgYSBtb21lbnQgaXMgbXV0YXRlZC4KICAgIC8vIEl0IGlzIGludGVuZGVkIHRvIGtlZXAgdGhlIG9mZnNldCBpbiBzeW5jIHdpdGggdGhlIHRpbWV6b25lLgogICAgbW9tZW50LnVwZGF0ZU9mZnNldCA9IGZ1bmN0aW9uICgpIHt9OwoKICAgIC8vIFRoaXMgZnVuY3Rpb24gd2lsbCBsb2FkIGxhbmd1YWdlcyBhbmQgdGhlbiBzZXQgdGhlIGdsb2JhbCBsYW5ndWFnZS4gIElmCiAgICAvLyBubyBhcmd1bWVudHMgYXJlIHBhc3NlZCBpbiwgaXQgd2lsbCBzaW1wbHkgcmV0dXJuIHRoZSBjdXJyZW50IGdsb2JhbAogICAgLy8gbGFuZ3VhZ2Uga2V5LgogICAgbW9tZW50LmxhbmcgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZXMpIHsKICAgICAgICB2YXIgcjsKICAgICAgICBpZiAoIWtleSkgewogICAgICAgICAgICByZXR1cm4gbW9tZW50LmZuLl9sYW5nLl9hYmJyOwogICAgICAgIH0KICAgICAgICBpZiAodmFsdWVzKSB7CiAgICAgICAgICAgIGxvYWRMYW5nKG5vcm1hbGl6ZUxhbmd1YWdlKGtleSksIHZhbHVlcyk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZXMgPT09IG51bGwpIHsKICAgICAgICAgICAgdW5sb2FkTGFuZyhrZXkpOwogICAgICAgICAgICBrZXkgPSAnZW4nOwogICAgICAgIH0gZWxzZSBpZiAoIWxhbmd1YWdlc1trZXldKSB7CiAgICAgICAgICAgIGdldExhbmdEZWZpbml0aW9uKGtleSk7CiAgICAgICAgfQogICAgICAgIHIgPSBtb21lbnQuZHVyYXRpb24uZm4uX2xhbmcgPSBtb21lbnQuZm4uX2xhbmcgPSBnZXRMYW5nRGVmaW5pdGlvbihrZXkpOwogICAgICAgIHJldHVybiByLl9hYmJyOwogICAgfTsKCiAgICAvLyByZXR1cm5zIGxhbmd1YWdlIGRhdGEKICAgIG1vbWVudC5sYW5nRGF0YSA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBpZiAoa2V5ICYmIGtleS5fbGFuZyAmJiBrZXkuX2xhbmcuX2FiYnIpIHsKICAgICAgICAgICAga2V5ID0ga2V5Ll9sYW5nLl9hYmJyOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2V0TGFuZ0RlZmluaXRpb24oa2V5KTsKICAgIH07CgogICAgLy8gY29tcGFyZSBtb21lbnQgb2JqZWN0CiAgICBtb21lbnQuaXNNb21lbnQgPSBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgcmV0dXJuIG9iaiBpbnN0YW5jZW9mIE1vbWVudCB8fAogICAgICAgICAgICAob2JqICE9IG51bGwgJiYgIG9iai5oYXNPd25Qcm9wZXJ0eSgnX2lzQU1vbWVudE9iamVjdCcpKTsKICAgIH07CgogICAgLy8gZm9yIHR5cGVjaGVja2luZyBEdXJhdGlvbiBvYmplY3RzCiAgICBtb21lbnQuaXNEdXJhdGlvbiA9IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICByZXR1cm4gb2JqIGluc3RhbmNlb2YgRHVyYXRpb247CiAgICB9OwoKICAgIGZvciAoaSA9IGxpc3RzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgbWFrZUxpc3QobGlzdHNbaV0pOwogICAgfQoKICAgIG1vbWVudC5ub3JtYWxpemVVbml0cyA9IGZ1bmN0aW9uICh1bml0cykgewogICAgICAgIHJldHVybiBub3JtYWxpemVVbml0cyh1bml0cyk7CiAgICB9OwoKICAgIG1vbWVudC5pbnZhbGlkID0gZnVuY3Rpb24gKGZsYWdzKSB7CiAgICAgICAgdmFyIG0gPSBtb21lbnQudXRjKE5hTik7CiAgICAgICAgaWYgKGZsYWdzICE9IG51bGwpIHsKICAgICAgICAgICAgZXh0ZW5kKG0uX3BmLCBmbGFncyk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBtLl9wZi51c2VySW52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG07CiAgICB9OwoKICAgIG1vbWVudC5wYXJzZVpvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIG1vbWVudC5hcHBseShudWxsLCBhcmd1bWVudHMpLnBhcnNlWm9uZSgpOwogICAgfTsKCiAgICBtb21lbnQucGFyc2VUd29EaWdpdFllYXIgPSBmdW5jdGlvbiAoaW5wdXQpIHsKICAgICAgICByZXR1cm4gdG9JbnQoaW5wdXQpICsgKHRvSW50KGlucHV0KSA+IDY4ID8gMTkwMCA6IDIwMDApOwogICAgfTsKCiAgICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICAgICAgTW9tZW50IFByb3RvdHlwZQogICAgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwoKCiAgICBleHRlbmQobW9tZW50LmZuID0gTW9tZW50LnByb3RvdHlwZSwgewoKICAgICAgICBjbG9uZSA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIG1vbWVudCh0aGlzKTsKICAgICAgICB9LAoKICAgICAgICB2YWx1ZU9mIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gK3RoaXMuX2QgKyAoKHRoaXMuX29mZnNldCB8fCAwKSAqIDYwMDAwKTsKICAgICAgICB9LAoKICAgICAgICB1bml4IDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gTWF0aC5mbG9vcigrdGhpcyAvIDEwMDApOwogICAgICAgIH0sCgogICAgICAgIHRvU3RyaW5nIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jbG9uZSgpLmxhbmcoJ2VuJykuZm9ybWF0KCJkZGQgTU1NIEREIFlZWVkgSEg6bW06c3MgW0dNVF1aWiIpOwogICAgICAgIH0sCgogICAgICAgIHRvRGF0ZSA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29mZnNldCA/IG5ldyBEYXRlKCt0aGlzKSA6IHRoaXMuX2Q7CiAgICAgICAgfSwKCiAgICAgICAgdG9JU09TdHJpbmcgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBtID0gbW9tZW50KHRoaXMpLnV0YygpOwogICAgICAgICAgICBpZiAoMCA8IG0ueWVhcigpICYmIG0ueWVhcigpIDw9IDk5OTkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmb3JtYXRNb21lbnQobSwgJ1lZWVktTU0tRERbVF1ISDptbTpzcy5TU1NbWl0nKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBmb3JtYXRNb21lbnQobSwgJ1lZWVlZWS1NTS1ERFtUXUhIOm1tOnNzLlNTU1taXScpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgdG9BcnJheSA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIG0gPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgbS55ZWFyKCksCiAgICAgICAgICAgICAgICBtLm1vbnRoKCksCiAgICAgICAgICAgICAgICBtLmRhdGUoKSwKICAgICAgICAgICAgICAgIG0uaG91cnMoKSwKICAgICAgICAgICAgICAgIG0ubWludXRlcygpLAogICAgICAgICAgICAgICAgbS5zZWNvbmRzKCksCiAgICAgICAgICAgICAgICBtLm1pbGxpc2Vjb25kcygpCiAgICAgICAgICAgIF07CiAgICAgICAgfSwKCiAgICAgICAgaXNWYWxpZCA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGlzVmFsaWQodGhpcyk7CiAgICAgICAgfSwKCiAgICAgICAgaXNEU1RTaGlmdGVkIDogZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgaWYgKHRoaXMuX2EpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmlzVmFsaWQoKSAmJiBjb21wYXJlQXJyYXlzKHRoaXMuX2EsICh0aGlzLl9pc1VUQyA/IG1vbWVudC51dGModGhpcy5fYSkgOiBtb21lbnQodGhpcy5fYSkpLnRvQXJyYXkoKSkgPiAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKCiAgICAgICAgcGFyc2luZ0ZsYWdzIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gZXh0ZW5kKHt9LCB0aGlzLl9wZik7CiAgICAgICAgfSwKCiAgICAgICAgaW52YWxpZEF0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wZi5vdmVyZmxvdzsKICAgICAgICB9LAoKICAgICAgICB1dGMgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnpvbmUoMCk7CiAgICAgICAgfSwKCiAgICAgICAgbG9jYWwgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMuem9uZSgwKTsKICAgICAgICAgICAgdGhpcy5faXNVVEMgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgZm9ybWF0IDogZnVuY3Rpb24gKGlucHV0U3RyaW5nKSB7CiAgICAgICAgICAgIHZhciBvdXRwdXQgPSBmb3JtYXRNb21lbnQodGhpcywgaW5wdXRTdHJpbmcgfHwgbW9tZW50LmRlZmF1bHRGb3JtYXQpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5sYW5nKCkucG9zdGZvcm1hdChvdXRwdXQpOwogICAgICAgIH0sCgogICAgICAgIGFkZCA6IGZ1bmN0aW9uIChpbnB1dCwgdmFsKSB7CiAgICAgICAgICAgIHZhciBkdXI7CiAgICAgICAgICAgIC8vIHN3aXRjaCBhcmdzIHRvIHN1cHBvcnQgYWRkKCdzJywgMSkgYW5kIGFkZCgxLCAncycpCiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5wdXQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICBkdXIgPSBtb21lbnQuZHVyYXRpb24oK3ZhbCwgaW5wdXQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZHVyID0gbW9tZW50LmR1cmF0aW9uKGlucHV0LCB2YWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFkZE9yU3VidHJhY3REdXJhdGlvbkZyb21Nb21lbnQodGhpcywgZHVyLCAxKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgc3VidHJhY3QgOiBmdW5jdGlvbiAoaW5wdXQsIHZhbCkgewogICAgICAgICAgICB2YXIgZHVyOwogICAgICAgICAgICAvLyBzd2l0Y2ggYXJncyB0byBzdXBwb3J0IHN1YnRyYWN0KCdzJywgMSkgYW5kIHN1YnRyYWN0KDEsICdzJykKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnB1dCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIGR1ciA9IG1vbWVudC5kdXJhdGlvbigrdmFsLCBpbnB1dCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkdXIgPSBtb21lbnQuZHVyYXRpb24oaW5wdXQsIHZhbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWRkT3JTdWJ0cmFjdER1cmF0aW9uRnJvbU1vbWVudCh0aGlzLCBkdXIsIC0xKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgZGlmZiA6IGZ1bmN0aW9uIChpbnB1dCwgdW5pdHMsIGFzRmxvYXQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSBtYWtlQXMoaW5wdXQsIHRoaXMpLAogICAgICAgICAgICAgICAgem9uZURpZmYgPSAodGhpcy56b25lKCkgLSB0aGF0LnpvbmUoKSkgKiA2ZTQsCiAgICAgICAgICAgICAgICBkaWZmLCBvdXRwdXQ7CgogICAgICAgICAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKHVuaXRzKTsKCiAgICAgICAgICAgIGlmICh1bml0cyA9PT0gJ3llYXInIHx8IHVuaXRzID09PSAnbW9udGgnKSB7CiAgICAgICAgICAgICAgICAvLyBhdmVyYWdlIG51bWJlciBvZiBkYXlzIGluIHRoZSBtb250aHMgaW4gdGhlIGdpdmVuIGRhdGVzCiAgICAgICAgICAgICAgICBkaWZmID0gKHRoaXMuZGF5c0luTW9udGgoKSArIHRoYXQuZGF5c0luTW9udGgoKSkgKiA0MzJlNTsgLy8gMjQgKiA2MCAqIDYwICogMTAwMCAvIDIKICAgICAgICAgICAgICAgIC8vIGRpZmZlcmVuY2UgaW4gbW9udGhzCiAgICAgICAgICAgICAgICBvdXRwdXQgPSAoKHRoaXMueWVhcigpIC0gdGhhdC55ZWFyKCkpICogMTIpICsgKHRoaXMubW9udGgoKSAtIHRoYXQubW9udGgoKSk7CiAgICAgICAgICAgICAgICAvLyBhZGp1c3QgYnkgdGFraW5nIGRpZmZlcmVuY2UgaW4gZGF5cywgYXZlcmFnZSBudW1iZXIgb2YgZGF5cwogICAgICAgICAgICAgICAgLy8gYW5kIGRzdCBpbiB0aGUgZ2l2ZW4gbW9udGhzLgogICAgICAgICAgICAgICAgb3V0cHV0ICs9ICgodGhpcyAtIG1vbWVudCh0aGlzKS5zdGFydE9mKCdtb250aCcpKSAtCiAgICAgICAgICAgICAgICAgICAgICAgICh0aGF0IC0gbW9tZW50KHRoYXQpLnN0YXJ0T2YoJ21vbnRoJykpKSAvIGRpZmY7CiAgICAgICAgICAgICAgICAvLyBzYW1lIGFzIGFib3ZlIGJ1dCB3aXRoIHpvbmVzLCB0byBuZWdhdGUgYWxsIGRzdAogICAgICAgICAgICAgICAgb3V0cHV0IC09ICgodGhpcy56b25lKCkgLSBtb21lbnQodGhpcykuc3RhcnRPZignbW9udGgnKS56b25lKCkpIC0KICAgICAgICAgICAgICAgICAgICAgICAgKHRoYXQuem9uZSgpIC0gbW9tZW50KHRoYXQpLnN0YXJ0T2YoJ21vbnRoJykuem9uZSgpKSkgKiA2ZTQgLyBkaWZmOwogICAgICAgICAgICAgICAgaWYgKHVuaXRzID09PSAneWVhcicpIHsKICAgICAgICAgICAgICAgICAgICBvdXRwdXQgPSBvdXRwdXQgLyAxMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRpZmYgPSAodGhpcyAtIHRoYXQpOwogICAgICAgICAgICAgICAgb3V0cHV0ID0gdW5pdHMgPT09ICdzZWNvbmQnID8gZGlmZiAvIDFlMyA6IC8vIDEwMDAKICAgICAgICAgICAgICAgICAgICB1bml0cyA9PT0gJ21pbnV0ZScgPyBkaWZmIC8gNmU0IDogLy8gMTAwMCAqIDYwCiAgICAgICAgICAgICAgICAgICAgdW5pdHMgPT09ICdob3VyJyA/IGRpZmYgLyAzNmU1IDogLy8gMTAwMCAqIDYwICogNjAKICAgICAgICAgICAgICAgICAgICB1bml0cyA9PT0gJ2RheScgPyAoZGlmZiAtIHpvbmVEaWZmKSAvIDg2NGU1IDogLy8gMTAwMCAqIDYwICogNjAgKiAyNCwgbmVnYXRlIGRzdAogICAgICAgICAgICAgICAgICAgIHVuaXRzID09PSAnd2VlaycgPyAoZGlmZiAtIHpvbmVEaWZmKSAvIDYwNDhlNSA6IC8vIDEwMDAgKiA2MCAqIDYwICogMjQgKiA3LCBuZWdhdGUgZHN0CiAgICAgICAgICAgICAgICAgICAgZGlmZjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYXNGbG9hdCA/IG91dHB1dCA6IGFic1JvdW5kKG91dHB1dCk7CiAgICAgICAgfSwKCiAgICAgICAgZnJvbSA6IGZ1bmN0aW9uICh0aW1lLCB3aXRob3V0U3VmZml4KSB7CiAgICAgICAgICAgIHJldHVybiBtb21lbnQuZHVyYXRpb24odGhpcy5kaWZmKHRpbWUpKS5sYW5nKHRoaXMubGFuZygpLl9hYmJyKS5odW1hbml6ZSghd2l0aG91dFN1ZmZpeCk7CiAgICAgICAgfSwKCiAgICAgICAgZnJvbU5vdyA6IGZ1bmN0aW9uICh3aXRob3V0U3VmZml4KSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmZyb20obW9tZW50KCksIHdpdGhvdXRTdWZmaXgpOwogICAgICAgIH0sCgogICAgICAgIGNhbGVuZGFyIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvLyBXZSB3YW50IHRvIGNvbXBhcmUgdGhlIHN0YXJ0IG9mIHRvZGF5LCB2cyB0aGlzLgogICAgICAgICAgICAvLyBHZXR0aW5nIHN0YXJ0LW9mLXRvZGF5IGRlcGVuZHMgb24gd2hldGhlciB3ZSdyZSB6b25lJ2Qgb3Igbm90LgogICAgICAgICAgICB2YXIgc29kID0gbWFrZUFzKG1vbWVudCgpLCB0aGlzKS5zdGFydE9mKCdkYXknKSwKICAgICAgICAgICAgICAgIGRpZmYgPSB0aGlzLmRpZmYoc29kLCAnZGF5cycsIHRydWUpLAogICAgICAgICAgICAgICAgZm9ybWF0ID0gZGlmZiA8IC02ID8gJ3NhbWVFbHNlJyA6CiAgICAgICAgICAgICAgICAgICAgZGlmZiA8IC0xID8gJ2xhc3RXZWVrJyA6CiAgICAgICAgICAgICAgICAgICAgZGlmZiA8IDAgPyAnbGFzdERheScgOgogICAgICAgICAgICAgICAgICAgIGRpZmYgPCAxID8gJ3NhbWVEYXknIDoKICAgICAgICAgICAgICAgICAgICBkaWZmIDwgMiA/ICduZXh0RGF5JyA6CiAgICAgICAgICAgICAgICAgICAgZGlmZiA8IDcgPyAnbmV4dFdlZWsnIDogJ3NhbWVFbHNlJzsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0KHRoaXMubGFuZygpLmNhbGVuZGFyKGZvcm1hdCwgdGhpcykpOwogICAgICAgIH0sCgogICAgICAgIGlzTGVhcFllYXIgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBpc0xlYXBZZWFyKHRoaXMueWVhcigpKTsKICAgICAgICB9LAoKICAgICAgICBpc0RTVCA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuICh0aGlzLnpvbmUoKSA8IHRoaXMuY2xvbmUoKS5tb250aCgwKS56b25lKCkgfHwKICAgICAgICAgICAgICAgIHRoaXMuem9uZSgpIDwgdGhpcy5jbG9uZSgpLm1vbnRoKDUpLnpvbmUoKSk7CiAgICAgICAgfSwKCiAgICAgICAgZGF5IDogZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgICAgIHZhciBkYXkgPSB0aGlzLl9pc1VUQyA/IHRoaXMuX2QuZ2V0VVRDRGF5KCkgOiB0aGlzLl9kLmdldERheSgpOwogICAgICAgICAgICBpZiAoaW5wdXQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaW5wdXQgPSBwYXJzZVdlZWtkYXkoaW5wdXQsIHRoaXMubGFuZygpKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZCh7IGQgOiBpbnB1dCAtIGRheSB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBkYXk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBtb250aCA6IG1ha2VBY2Nlc3NvcignTW9udGgnLCB0cnVlKSwKCiAgICAgICAgc3RhcnRPZjogZnVuY3Rpb24gKHVuaXRzKSB7CiAgICAgICAgICAgIHVuaXRzID0gbm9ybWFsaXplVW5pdHModW5pdHMpOwogICAgICAgICAgICAvLyB0aGUgZm9sbG93aW5nIHN3aXRjaCBpbnRlbnRpb25hbGx5IG9taXRzIGJyZWFrIGtleXdvcmRzCiAgICAgICAgICAgIC8vIHRvIHV0aWxpemUgZmFsbGluZyB0aHJvdWdoIHRoZSBjYXNlcy4KICAgICAgICAgICAgc3dpdGNoICh1bml0cykgewogICAgICAgICAgICBjYXNlICd5ZWFyJzoKICAgICAgICAgICAgICAgIHRoaXMubW9udGgoMCk7CiAgICAgICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgICAgIGNhc2UgJ3F1YXJ0ZXInOgogICAgICAgICAgICBjYXNlICdtb250aCc6CiAgICAgICAgICAgICAgICB0aGlzLmRhdGUoMSk7CiAgICAgICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgICAgIGNhc2UgJ3dlZWsnOgogICAgICAgICAgICBjYXNlICdpc29XZWVrJzoKICAgICAgICAgICAgY2FzZSAnZGF5JzoKICAgICAgICAgICAgICAgIHRoaXMuaG91cnMoMCk7CiAgICAgICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgICAgIGNhc2UgJ2hvdXInOgogICAgICAgICAgICAgICAgdGhpcy5taW51dGVzKDApOwogICAgICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgICAgICBjYXNlICdtaW51dGUnOgogICAgICAgICAgICAgICAgdGhpcy5zZWNvbmRzKDApOwogICAgICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgICAgICBjYXNlICdzZWNvbmQnOgogICAgICAgICAgICAgICAgdGhpcy5taWxsaXNlY29uZHMoMCk7CiAgICAgICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHdlZWtzIGFyZSBhIHNwZWNpYWwgY2FzZQogICAgICAgICAgICBpZiAodW5pdHMgPT09ICd3ZWVrJykgewogICAgICAgICAgICAgICAgdGhpcy53ZWVrZGF5KDApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHVuaXRzID09PSAnaXNvV2VlaycpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNvV2Vla2RheSgxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gcXVhcnRlcnMgYXJlIGFsc28gc3BlY2lhbAogICAgICAgICAgICBpZiAodW5pdHMgPT09ICdxdWFydGVyJykgewogICAgICAgICAgICAgICAgdGhpcy5tb250aChNYXRoLmZsb29yKHRoaXMubW9udGgoKSAvIDMpICogMyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIGVuZE9mOiBmdW5jdGlvbiAodW5pdHMpIHsKICAgICAgICAgICAgdW5pdHMgPSBub3JtYWxpemVVbml0cyh1bml0cyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnN0YXJ0T2YodW5pdHMpLmFkZCgodW5pdHMgPT09ICdpc29XZWVrJyA/ICd3ZWVrJyA6IHVuaXRzKSwgMSkuc3VidHJhY3QoJ21zJywgMSk7CiAgICAgICAgfSwKCiAgICAgICAgaXNBZnRlcjogZnVuY3Rpb24gKGlucHV0LCB1bml0cykgewogICAgICAgICAgICB1bml0cyA9IHR5cGVvZiB1bml0cyAhPT0gJ3VuZGVmaW5lZCcgPyB1bml0cyA6ICdtaWxsaXNlY29uZCc7CiAgICAgICAgICAgIHJldHVybiArdGhpcy5jbG9uZSgpLnN0YXJ0T2YodW5pdHMpID4gK21vbWVudChpbnB1dCkuc3RhcnRPZih1bml0cyk7CiAgICAgICAgfSwKCiAgICAgICAgaXNCZWZvcmU6IGZ1bmN0aW9uIChpbnB1dCwgdW5pdHMpIHsKICAgICAgICAgICAgdW5pdHMgPSB0eXBlb2YgdW5pdHMgIT09ICd1bmRlZmluZWQnID8gdW5pdHMgOiAnbWlsbGlzZWNvbmQnOwogICAgICAgICAgICByZXR1cm4gK3RoaXMuY2xvbmUoKS5zdGFydE9mKHVuaXRzKSA8ICttb21lbnQoaW5wdXQpLnN0YXJ0T2YodW5pdHMpOwogICAgICAgIH0sCgogICAgICAgIGlzU2FtZTogZnVuY3Rpb24gKGlucHV0LCB1bml0cykgewogICAgICAgICAgICB1bml0cyA9IHVuaXRzIHx8ICdtcyc7CiAgICAgICAgICAgIHJldHVybiArdGhpcy5jbG9uZSgpLnN0YXJ0T2YodW5pdHMpID09PSArbWFrZUFzKGlucHV0LCB0aGlzKS5zdGFydE9mKHVuaXRzKTsKICAgICAgICB9LAoKICAgICAgICBtaW46IGZ1bmN0aW9uIChvdGhlcikgewogICAgICAgICAgICBvdGhlciA9IG1vbWVudC5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgICByZXR1cm4gb3RoZXIgPCB0aGlzID8gdGhpcyA6IG90aGVyOwogICAgICAgIH0sCgogICAgICAgIG1heDogZnVuY3Rpb24gKG90aGVyKSB7CiAgICAgICAgICAgIG90aGVyID0gbW9tZW50LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIHJldHVybiBvdGhlciA+IHRoaXMgPyB0aGlzIDogb3RoZXI7CiAgICAgICAgfSwKCiAgICAgICAgLy8ga2VlcFRpbWUgPSB0cnVlIG1lYW5zIG9ubHkgY2hhbmdlIHRoZSB0aW1lem9uZSwgd2l0aG91dCBhZmZlY3RpbmcKICAgICAgICAvLyB0aGUgbG9jYWwgaG91ci4gU28gNTozMToyNiArMDMwMCAtLVt6b25lKDIsIHRydWUpXS0tPiA1OjMxOjI2ICswMjAwCiAgICAgICAgLy8gSXQgaXMgcG9zc2libGUgdGhhdCA1OjMxOjI2IGRvZXNuJ3QgZXhpc3QgaW50IHpvbmUgKzAyMDAsIHNvIHdlCiAgICAgICAgLy8gYWRqdXN0IHRoZSB0aW1lIGFzIG5lZWRlZCwgdG8gYmUgdmFsaWQuCiAgICAgICAgLy8KICAgICAgICAvLyBLZWVwaW5nIHRoZSB0aW1lIGFjdHVhbGx5IGFkZHMvc3VidHJhY3RzIChvbmUgaG91cikKICAgICAgICAvLyBmcm9tIHRoZSBhY3R1YWwgcmVwcmVzZW50ZWQgdGltZS4gVGhhdCBpcyB3aHkgd2UgY2FsbCB1cGRhdGVPZmZzZXQKICAgICAgICAvLyBhIHNlY29uZCB0aW1lLiBJbiBjYXNlIGl0IHdhbnRzIHVzIHRvIGNoYW5nZSB0aGUgb2Zmc2V0IGFnYWluCiAgICAgICAgLy8gX2NoYW5nZUluUHJvZ3Jlc3MgPT0gdHJ1ZSBjYXNlLCB0aGVuIHdlIGhhdmUgdG8gYWRqdXN0LCBiZWNhdXNlCiAgICAgICAgLy8gdGhlcmUgaXMgbm8gc3VjaCB0aW1lIGluIHRoZSBnaXZlbiB0aW1lem9uZS4KICAgICAgICB6b25lIDogZnVuY3Rpb24gKGlucHV0LCBrZWVwVGltZSkgewogICAgICAgICAgICB2YXIgb2Zmc2V0ID0gdGhpcy5fb2Zmc2V0IHx8IDA7CiAgICAgICAgICAgIGlmIChpbnB1dCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGlucHV0ID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIGlucHV0ID0gdGltZXpvbmVNaW51dGVzRnJvbVN0cmluZyhpbnB1dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoaW5wdXQpIDwgMTYpIHsKICAgICAgICAgICAgICAgICAgICBpbnB1dCA9IGlucHV0ICogNjA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9vZmZzZXQgPSBpbnB1dDsKICAgICAgICAgICAgICAgIHRoaXMuX2lzVVRDID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmIChvZmZzZXQgIT09IGlucHV0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFrZWVwVGltZSB8fCB0aGlzLl9jaGFuZ2VJblByb2dyZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZE9yU3VidHJhY3REdXJhdGlvbkZyb21Nb21lbnQodGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb21lbnQuZHVyYXRpb24ob2Zmc2V0IC0gaW5wdXQsICdtJyksIDEsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLl9jaGFuZ2VJblByb2dyZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2NoYW5nZUluUHJvZ3Jlc3MgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBtb21lbnQudXBkYXRlT2Zmc2V0KHRoaXMsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jaGFuZ2VJblByb2dyZXNzID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5faXNVVEMgPyBvZmZzZXQgOiB0aGlzLl9kLmdldFRpbWV6b25lT2Zmc2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgem9uZUFiYnIgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9pc1VUQyA/ICJVVEMiIDogIiI7CiAgICAgICAgfSwKCiAgICAgICAgem9uZU5hbWUgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9pc1VUQyA/ICJDb29yZGluYXRlZCBVbml2ZXJzYWwgVGltZSIgOiAiIjsKICAgICAgICB9LAoKICAgICAgICBwYXJzZVpvbmUgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl90em0pIHsKICAgICAgICAgICAgICAgIHRoaXMuem9uZSh0aGlzLl90em0pOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0aGlzLl9pID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgdGhpcy56b25lKHRoaXMuX2kpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIGhhc0FsaWduZWRIb3VyT2Zmc2V0IDogZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgICAgIGlmICghaW5wdXQpIHsKICAgICAgICAgICAgICAgIGlucHV0ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGlucHV0ID0gbW9tZW50KGlucHV0KS56b25lKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiAodGhpcy56b25lKCkgLSBpbnB1dCkgJSA2MCA9PT0gMDsKICAgICAgICB9LAoKICAgICAgICBkYXlzSW5Nb250aCA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGRheXNJbk1vbnRoKHRoaXMueWVhcigpLCB0aGlzLm1vbnRoKCkpOwogICAgICAgIH0sCgogICAgICAgIGRheU9mWWVhciA6IGZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgICAgICB2YXIgZGF5T2ZZZWFyID0gcm91bmQoKG1vbWVudCh0aGlzKS5zdGFydE9mKCdkYXknKSAtIG1vbWVudCh0aGlzKS5zdGFydE9mKCd5ZWFyJykpIC8gODY0ZTUpICsgMTsKICAgICAgICAgICAgcmV0dXJuIGlucHV0ID09IG51bGwgPyBkYXlPZlllYXIgOiB0aGlzLmFkZCgiZCIsIChpbnB1dCAtIGRheU9mWWVhcikpOwogICAgICAgIH0sCgogICAgICAgIHF1YXJ0ZXIgOiBmdW5jdGlvbiAoaW5wdXQpIHsKICAgICAgICAgICAgcmV0dXJuIGlucHV0ID09IG51bGwgPyBNYXRoLmNlaWwoKHRoaXMubW9udGgoKSArIDEpIC8gMykgOiB0aGlzLm1vbnRoKChpbnB1dCAtIDEpICogMyArIHRoaXMubW9udGgoKSAlIDMpOwogICAgICAgIH0sCgogICAgICAgIHdlZWtZZWFyIDogZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgICAgIHZhciB5ZWFyID0gd2Vla09mWWVhcih0aGlzLCB0aGlzLmxhbmcoKS5fd2Vlay5kb3csIHRoaXMubGFuZygpLl93ZWVrLmRveSkueWVhcjsKICAgICAgICAgICAgcmV0dXJuIGlucHV0ID09IG51bGwgPyB5ZWFyIDogdGhpcy5hZGQoInkiLCAoaW5wdXQgLSB5ZWFyKSk7CiAgICAgICAgfSwKCiAgICAgICAgaXNvV2Vla1llYXIgOiBmdW5jdGlvbiAoaW5wdXQpIHsKICAgICAgICAgICAgdmFyIHllYXIgPSB3ZWVrT2ZZZWFyKHRoaXMsIDEsIDQpLnllYXI7CiAgICAgICAgICAgIHJldHVybiBpbnB1dCA9PSBudWxsID8geWVhciA6IHRoaXMuYWRkKCJ5IiwgKGlucHV0IC0geWVhcikpOwogICAgICAgIH0sCgogICAgICAgIHdlZWsgOiBmdW5jdGlvbiAoaW5wdXQpIHsKICAgICAgICAgICAgdmFyIHdlZWsgPSB0aGlzLmxhbmcoKS53ZWVrKHRoaXMpOwogICAgICAgICAgICByZXR1cm4gaW5wdXQgPT0gbnVsbCA/IHdlZWsgOiB0aGlzLmFkZCgiZCIsIChpbnB1dCAtIHdlZWspICogNyk7CiAgICAgICAgfSwKCiAgICAgICAgaXNvV2VlayA6IGZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgICAgICB2YXIgd2VlayA9IHdlZWtPZlllYXIodGhpcywgMSwgNCkud2VlazsKICAgICAgICAgICAgcmV0dXJuIGlucHV0ID09IG51bGwgPyB3ZWVrIDogdGhpcy5hZGQoImQiLCAoaW5wdXQgLSB3ZWVrKSAqIDcpOwogICAgICAgIH0sCgogICAgICAgIHdlZWtkYXkgOiBmdW5jdGlvbiAoaW5wdXQpIHsKICAgICAgICAgICAgdmFyIHdlZWtkYXkgPSAodGhpcy5kYXkoKSArIDcgLSB0aGlzLmxhbmcoKS5fd2Vlay5kb3cpICUgNzsKICAgICAgICAgICAgcmV0dXJuIGlucHV0ID09IG51bGwgPyB3ZWVrZGF5IDogdGhpcy5hZGQoImQiLCBpbnB1dCAtIHdlZWtkYXkpOwogICAgICAgIH0sCgogICAgICAgIGlzb1dlZWtkYXkgOiBmdW5jdGlvbiAoaW5wdXQpIHsKICAgICAgICAgICAgLy8gYmVoYXZlcyB0aGUgc2FtZSBhcyBtb21lbnQjZGF5IGV4Y2VwdAogICAgICAgICAgICAvLyBhcyBhIGdldHRlciwgcmV0dXJucyA3IGluc3RlYWQgb2YgMCAoMS03IHJhbmdlIGluc3RlYWQgb2YgMC02KQogICAgICAgICAgICAvLyBhcyBhIHNldHRlciwgc3VuZGF5IHNob3VsZCBiZWxvbmcgdG8gdGhlIHByZXZpb3VzIHdlZWsuCiAgICAgICAgICAgIHJldHVybiBpbnB1dCA9PSBudWxsID8gdGhpcy5kYXkoKSB8fCA3IDogdGhpcy5kYXkodGhpcy5kYXkoKSAlIDcgPyBpbnB1dCA6IGlucHV0IC0gNyk7CiAgICAgICAgfSwKCiAgICAgICAgaXNvV2Vla3NJblllYXIgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB3ZWVrc0luWWVhcih0aGlzLnllYXIoKSwgMSwgNCk7CiAgICAgICAgfSwKCiAgICAgICAgd2Vla3NJblllYXIgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB3ZWVrSW5mbyA9IHRoaXMuX2xhbmcuX3dlZWs7CiAgICAgICAgICAgIHJldHVybiB3ZWVrc0luWWVhcih0aGlzLnllYXIoKSwgd2Vla0luZm8uZG93LCB3ZWVrSW5mby5kb3kpOwogICAgICAgIH0sCgogICAgICAgIGdldCA6IGZ1bmN0aW9uICh1bml0cykgewogICAgICAgICAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKHVuaXRzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXNbdW5pdHNdKCk7CiAgICAgICAgfSwKCiAgICAgICAgc2V0IDogZnVuY3Rpb24gKHVuaXRzLCB2YWx1ZSkgewogICAgICAgICAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKHVuaXRzKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0aGlzW3VuaXRzXSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgdGhpc1t1bml0c10odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIC8vIElmIHBhc3NlZCBhIGxhbmd1YWdlIGtleSwgaXQgd2lsbCBzZXQgdGhlIGxhbmd1YWdlIGZvciB0aGlzCiAgICAgICAgLy8gaW5zdGFuY2UuICBPdGhlcndpc2UsIGl0IHdpbGwgcmV0dXJuIHRoZSBsYW5ndWFnZSBjb25maWd1cmF0aW9uCiAgICAgICAgLy8gdmFyaWFibGVzIGZvciB0aGlzIGluc3RhbmNlLgogICAgICAgIGxhbmcgOiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgIGlmIChrZXkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2xhbmc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9sYW5nID0gZ2V0TGFuZ0RlZmluaXRpb24oa2V5KTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7CgogICAgZnVuY3Rpb24gcmF3TW9udGhTZXR0ZXIobW9tLCB2YWx1ZSkgewogICAgICAgIHZhciBkYXlPZk1vbnRoOwoKICAgICAgICAvLyBUT0RPOiBNb3ZlIHRoaXMgb3V0IG9mIGhlcmUhCiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgdmFsdWUgPSBtb20ubGFuZygpLm1vbnRoc1BhcnNlKHZhbHVlKTsKICAgICAgICAgICAgLy8gVE9ETzogQW5vdGhlciBzaWxlbnQgZmFpbHVyZT8KICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ251bWJlcicpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtb207CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGRheU9mTW9udGggPSBNYXRoLm1pbihtb20uZGF0ZSgpLAogICAgICAgICAgICAgICAgZGF5c0luTW9udGgobW9tLnllYXIoKSwgdmFsdWUpKTsKICAgICAgICBtb20uX2RbJ3NldCcgKyAobW9tLl9pc1VUQyA/ICdVVEMnIDogJycpICsgJ01vbnRoJ10odmFsdWUsIGRheU9mTW9udGgpOwogICAgICAgIHJldHVybiBtb207CiAgICB9CgogICAgZnVuY3Rpb24gcmF3R2V0dGVyKG1vbSwgdW5pdCkgewogICAgICAgIHJldHVybiBtb20uX2RbJ2dldCcgKyAobW9tLl9pc1VUQyA/ICdVVEMnIDogJycpICsgdW5pdF0oKTsKICAgIH0KCiAgICBmdW5jdGlvbiByYXdTZXR0ZXIobW9tLCB1bml0LCB2YWx1ZSkgewogICAgICAgIGlmICh1bml0ID09PSAnTW9udGgnKSB7CiAgICAgICAgICAgIHJldHVybiByYXdNb250aFNldHRlcihtb20sIHZhbHVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbW9tLl9kWydzZXQnICsgKG1vbS5faXNVVEMgPyAnVVRDJyA6ICcnKSArIHVuaXRdKHZhbHVlKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gbWFrZUFjY2Vzc29yKHVuaXQsIGtlZXBUaW1lKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmF3U2V0dGVyKHRoaXMsIHVuaXQsIHZhbHVlKTsKICAgICAgICAgICAgICAgIG1vbWVudC51cGRhdGVPZmZzZXQodGhpcywga2VlcFRpbWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmF3R2V0dGVyKHRoaXMsIHVuaXQpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0KCiAgICBtb21lbnQuZm4ubWlsbGlzZWNvbmQgPSBtb21lbnQuZm4ubWlsbGlzZWNvbmRzID0gbWFrZUFjY2Vzc29yKCdNaWxsaXNlY29uZHMnLCBmYWxzZSk7CiAgICBtb21lbnQuZm4uc2Vjb25kID0gbW9tZW50LmZuLnNlY29uZHMgPSBtYWtlQWNjZXNzb3IoJ1NlY29uZHMnLCBmYWxzZSk7CiAgICBtb21lbnQuZm4ubWludXRlID0gbW9tZW50LmZuLm1pbnV0ZXMgPSBtYWtlQWNjZXNzb3IoJ01pbnV0ZXMnLCBmYWxzZSk7CiAgICAvLyBTZXR0aW5nIHRoZSBob3VyIHNob3VsZCBrZWVwIHRoZSB0aW1lLCBiZWNhdXNlIHRoZSB1c2VyIGV4cGxpY2l0bHkKICAgIC8vIHNwZWNpZmllZCB3aGljaCBob3VyIGhlIHdhbnRzLiBTbyB0cnlpbmcgdG8gbWFpbnRhaW4gdGhlIHNhbWUgaG91ciAoaW4KICAgIC8vIGEgbmV3IHRpbWV6b25lKSBtYWtlcyBzZW5zZS4gQWRkaW5nL3N1YnRyYWN0aW5nIGhvdXJzIGRvZXMgbm90IGZvbGxvdwogICAgLy8gdGhpcyBydWxlLgogICAgbW9tZW50LmZuLmhvdXIgPSBtb21lbnQuZm4uaG91cnMgPSBtYWtlQWNjZXNzb3IoJ0hvdXJzJywgdHJ1ZSk7CiAgICAvLyBtb21lbnQuZm4ubW9udGggaXMgZGVmaW5lZCBzZXBhcmF0ZWx5CiAgICBtb21lbnQuZm4uZGF0ZSA9IG1ha2VBY2Nlc3NvcignRGF0ZScsIHRydWUpOwogICAgbW9tZW50LmZuLmRhdGVzID0gZGVwcmVjYXRlKCJkYXRlcyBhY2Nlc3NvciBpcyBkZXByZWNhdGVkLiBVc2UgZGF0ZSBpbnN0ZWFkLiIsIG1ha2VBY2Nlc3NvcignRGF0ZScsIHRydWUpKTsKICAgIG1vbWVudC5mbi55ZWFyID0gbWFrZUFjY2Vzc29yKCdGdWxsWWVhcicsIHRydWUpOwogICAgbW9tZW50LmZuLnllYXJzID0gZGVwcmVjYXRlKCJ5ZWFycyBhY2Nlc3NvciBpcyBkZXByZWNhdGVkLiBVc2UgeWVhciBpbnN0ZWFkLiIsIG1ha2VBY2Nlc3NvcignRnVsbFllYXInLCB0cnVlKSk7CgogICAgLy8gYWRkIHBsdXJhbCBtZXRob2RzCiAgICBtb21lbnQuZm4uZGF5cyA9IG1vbWVudC5mbi5kYXk7CiAgICBtb21lbnQuZm4ubW9udGhzID0gbW9tZW50LmZuLm1vbnRoOwogICAgbW9tZW50LmZuLndlZWtzID0gbW9tZW50LmZuLndlZWs7CiAgICBtb21lbnQuZm4uaXNvV2Vla3MgPSBtb21lbnQuZm4uaXNvV2VlazsKICAgIG1vbWVudC5mbi5xdWFydGVycyA9IG1vbWVudC5mbi5xdWFydGVyOwoKICAgIC8vIGFkZCBhbGlhc2VkIGZvcm1hdCBtZXRob2RzCiAgICBtb21lbnQuZm4udG9KU09OID0gbW9tZW50LmZuLnRvSVNPU3RyaW5nOwoKICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgICAgICBEdXJhdGlvbiBQcm90b3R5cGUKICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCgogICAgZXh0ZW5kKG1vbWVudC5kdXJhdGlvbi5mbiA9IER1cmF0aW9uLnByb3RvdHlwZSwgewoKICAgICAgICBfYnViYmxlIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgbWlsbGlzZWNvbmRzID0gdGhpcy5fbWlsbGlzZWNvbmRzLAogICAgICAgICAgICAgICAgZGF5cyA9IHRoaXMuX2RheXMsCiAgICAgICAgICAgICAgICBtb250aHMgPSB0aGlzLl9tb250aHMsCiAgICAgICAgICAgICAgICBkYXRhID0gdGhpcy5fZGF0YSwKICAgICAgICAgICAgICAgIHNlY29uZHMsIG1pbnV0ZXMsIGhvdXJzLCB5ZWFyczsKCiAgICAgICAgICAgIC8vIFRoZSBmb2xsb3dpbmcgY29kZSBidWJibGVzIHVwIHZhbHVlcywgc2VlIHRoZSB0ZXN0cyBmb3IKICAgICAgICAgICAgLy8gZXhhbXBsZXMgb2Ygd2hhdCB0aGF0IG1lYW5zLgogICAgICAgICAgICBkYXRhLm1pbGxpc2Vjb25kcyA9IG1pbGxpc2Vjb25kcyAlIDEwMDA7CgogICAgICAgICAgICBzZWNvbmRzID0gYWJzUm91bmQobWlsbGlzZWNvbmRzIC8gMTAwMCk7CiAgICAgICAgICAgIGRhdGEuc2Vjb25kcyA9IHNlY29uZHMgJSA2MDsKCiAgICAgICAgICAgIG1pbnV0ZXMgPSBhYnNSb3VuZChzZWNvbmRzIC8gNjApOwogICAgICAgICAgICBkYXRhLm1pbnV0ZXMgPSBtaW51dGVzICUgNjA7CgogICAgICAgICAgICBob3VycyA9IGFic1JvdW5kKG1pbnV0ZXMgLyA2MCk7CiAgICAgICAgICAgIGRhdGEuaG91cnMgPSBob3VycyAlIDI0OwoKICAgICAgICAgICAgZGF5cyArPSBhYnNSb3VuZChob3VycyAvIDI0KTsKICAgICAgICAgICAgZGF0YS5kYXlzID0gZGF5cyAlIDMwOwoKICAgICAgICAgICAgbW9udGhzICs9IGFic1JvdW5kKGRheXMgLyAzMCk7CiAgICAgICAgICAgIGRhdGEubW9udGhzID0gbW9udGhzICUgMTI7CgogICAgICAgICAgICB5ZWFycyA9IGFic1JvdW5kKG1vbnRocyAvIDEyKTsKICAgICAgICAgICAgZGF0YS55ZWFycyA9IHllYXJzOwogICAgICAgIH0sCgogICAgICAgIHdlZWtzIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gYWJzUm91bmQodGhpcy5kYXlzKCkgLyA3KTsKICAgICAgICB9LAoKICAgICAgICB2YWx1ZU9mIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbWlsbGlzZWNvbmRzICsKICAgICAgICAgICAgICB0aGlzLl9kYXlzICogODY0ZTUgKwogICAgICAgICAgICAgICh0aGlzLl9tb250aHMgJSAxMikgKiAyNTkyZTYgKwogICAgICAgICAgICAgIHRvSW50KHRoaXMuX21vbnRocyAvIDEyKSAqIDMxNTM2ZTY7CiAgICAgICAgfSwKCiAgICAgICAgaHVtYW5pemUgOiBmdW5jdGlvbiAod2l0aFN1ZmZpeCkgewogICAgICAgICAgICB2YXIgZGlmZmVyZW5jZSA9ICt0aGlzLAogICAgICAgICAgICAgICAgb3V0cHV0ID0gcmVsYXRpdmVUaW1lKGRpZmZlcmVuY2UsICF3aXRoU3VmZml4LCB0aGlzLmxhbmcoKSk7CgogICAgICAgICAgICBpZiAod2l0aFN1ZmZpeCkgewogICAgICAgICAgICAgICAgb3V0cHV0ID0gdGhpcy5sYW5nKCkucGFzdEZ1dHVyZShkaWZmZXJlbmNlLCBvdXRwdXQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpcy5sYW5nKCkucG9zdGZvcm1hdChvdXRwdXQpOwogICAgICAgIH0sCgogICAgICAgIGFkZCA6IGZ1bmN0aW9uIChpbnB1dCwgdmFsKSB7CiAgICAgICAgICAgIC8vIHN1cHBvcnRzIG9ubHkgMi4wLXN0eWxlIGFkZCgxLCAncycpIG9yIGFkZChtb21lbnQpCiAgICAgICAgICAgIHZhciBkdXIgPSBtb21lbnQuZHVyYXRpb24oaW5wdXQsIHZhbCk7CgogICAgICAgICAgICB0aGlzLl9taWxsaXNlY29uZHMgKz0gZHVyLl9taWxsaXNlY29uZHM7CiAgICAgICAgICAgIHRoaXMuX2RheXMgKz0gZHVyLl9kYXlzOwogICAgICAgICAgICB0aGlzLl9tb250aHMgKz0gZHVyLl9tb250aHM7CgogICAgICAgICAgICB0aGlzLl9idWJibGUoKTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIHN1YnRyYWN0IDogZnVuY3Rpb24gKGlucHV0LCB2YWwpIHsKICAgICAgICAgICAgdmFyIGR1ciA9IG1vbWVudC5kdXJhdGlvbihpbnB1dCwgdmFsKTsKCiAgICAgICAgICAgIHRoaXMuX21pbGxpc2Vjb25kcyAtPSBkdXIuX21pbGxpc2Vjb25kczsKICAgICAgICAgICAgdGhpcy5fZGF5cyAtPSBkdXIuX2RheXM7CiAgICAgICAgICAgIHRoaXMuX21vbnRocyAtPSBkdXIuX21vbnRoczsKCiAgICAgICAgICAgIHRoaXMuX2J1YmJsZSgpOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgZ2V0IDogZnVuY3Rpb24gKHVuaXRzKSB7CiAgICAgICAgICAgIHVuaXRzID0gbm9ybWFsaXplVW5pdHModW5pdHMpOwogICAgICAgICAgICByZXR1cm4gdGhpc1t1bml0cy50b0xvd2VyQ2FzZSgpICsgJ3MnXSgpOwogICAgICAgIH0sCgogICAgICAgIGFzIDogZnVuY3Rpb24gKHVuaXRzKSB7CiAgICAgICAgICAgIHVuaXRzID0gbm9ybWFsaXplVW5pdHModW5pdHMpOwogICAgICAgICAgICByZXR1cm4gdGhpc1snYXMnICsgdW5pdHMuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyB1bml0cy5zbGljZSgxKSArICdzJ10oKTsKICAgICAgICB9LAoKICAgICAgICBsYW5nIDogbW9tZW50LmZuLmxhbmcsCgogICAgICAgIHRvSXNvU3RyaW5nIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvLyBpbnNwaXJlZCBieSBodHRwczovL2dpdGh1Yi5jb20vZG9yZGlsbGUvbW9tZW50LWlzb2R1cmF0aW9uL2Jsb2IvbWFzdGVyL21vbWVudC5pc29kdXJhdGlvbi5qcwogICAgICAgICAgICB2YXIgeWVhcnMgPSBNYXRoLmFicyh0aGlzLnllYXJzKCkpLAogICAgICAgICAgICAgICAgbW9udGhzID0gTWF0aC5hYnModGhpcy5tb250aHMoKSksCiAgICAgICAgICAgICAgICBkYXlzID0gTWF0aC5hYnModGhpcy5kYXlzKCkpLAogICAgICAgICAgICAgICAgaG91cnMgPSBNYXRoLmFicyh0aGlzLmhvdXJzKCkpLAogICAgICAgICAgICAgICAgbWludXRlcyA9IE1hdGguYWJzKHRoaXMubWludXRlcygpKSwKICAgICAgICAgICAgICAgIHNlY29uZHMgPSBNYXRoLmFicyh0aGlzLnNlY29uZHMoKSArIHRoaXMubWlsbGlzZWNvbmRzKCkgLyAxMDAwKTsKCiAgICAgICAgICAgIGlmICghdGhpcy5hc1NlY29uZHMoKSkgewogICAgICAgICAgICAgICAgLy8gdGhpcyBpcyB0aGUgc2FtZSBhcyBDIydzIChOb2RhKSBhbmQgcHl0aG9uIChpc29kYXRlKS4uLgogICAgICAgICAgICAgICAgLy8gYnV0IG5vdCBvdGhlciBKUyAoZ29vZy5kYXRlKQogICAgICAgICAgICAgICAgcmV0dXJuICdQMEQnOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gKHRoaXMuYXNTZWNvbmRzKCkgPCAwID8gJy0nIDogJycpICsKICAgICAgICAgICAgICAgICdQJyArCiAgICAgICAgICAgICAgICAoeWVhcnMgPyB5ZWFycyArICdZJyA6ICcnKSArCiAgICAgICAgICAgICAgICAobW9udGhzID8gbW9udGhzICsgJ00nIDogJycpICsKICAgICAgICAgICAgICAgIChkYXlzID8gZGF5cyArICdEJyA6ICcnKSArCiAgICAgICAgICAgICAgICAoKGhvdXJzIHx8IG1pbnV0ZXMgfHwgc2Vjb25kcykgPyAnVCcgOiAnJykgKwogICAgICAgICAgICAgICAgKGhvdXJzID8gaG91cnMgKyAnSCcgOiAnJykgKwogICAgICAgICAgICAgICAgKG1pbnV0ZXMgPyBtaW51dGVzICsgJ00nIDogJycpICsKICAgICAgICAgICAgICAgIChzZWNvbmRzID8gc2Vjb25kcyArICdTJyA6ICcnKTsKICAgICAgICB9CiAgICB9KTsKCiAgICBmdW5jdGlvbiBtYWtlRHVyYXRpb25HZXR0ZXIobmFtZSkgewogICAgICAgIG1vbWVudC5kdXJhdGlvbi5mbltuYW1lXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2RhdGFbbmFtZV07CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBtYWtlRHVyYXRpb25Bc0dldHRlcihuYW1lLCBmYWN0b3IpIHsKICAgICAgICBtb21lbnQuZHVyYXRpb24uZm5bJ2FzJyArIG5hbWVdID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gK3RoaXMgLyBmYWN0b3I7CiAgICAgICAgfTsKICAgIH0KCiAgICBmb3IgKGkgaW4gdW5pdE1pbGxpc2Vjb25kRmFjdG9ycykgewogICAgICAgIGlmICh1bml0TWlsbGlzZWNvbmRGYWN0b3JzLmhhc093blByb3BlcnR5KGkpKSB7CiAgICAgICAgICAgIG1ha2VEdXJhdGlvbkFzR2V0dGVyKGksIHVuaXRNaWxsaXNlY29uZEZhY3RvcnNbaV0pOwogICAgICAgICAgICBtYWtlRHVyYXRpb25HZXR0ZXIoaS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgbWFrZUR1cmF0aW9uQXNHZXR0ZXIoJ1dlZWtzJywgNjA0OGU1KTsKICAgIG1vbWVudC5kdXJhdGlvbi5mbi5hc01vbnRocyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gKCt0aGlzIC0gdGhpcy55ZWFycygpICogMzE1MzZlNikgLyAyNTkyZTYgKyB0aGlzLnllYXJzKCkgKiAxMjsKICAgIH07CgoKICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgICAgICBEZWZhdWx0IExhbmcKICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCgogICAgLy8gU2V0IGRlZmF1bHQgbGFuZ3VhZ2UsIG90aGVyIGxhbmd1YWdlcyB3aWxsIGluaGVyaXQgZnJvbSBFbmdsaXNoLgogICAgbW9tZW50LmxhbmcoJ2VuJywgewogICAgICAgIG9yZGluYWwgOiBmdW5jdGlvbiAobnVtYmVyKSB7CiAgICAgICAgICAgIHZhciBiID0gbnVtYmVyICUgMTAsCiAgICAgICAgICAgICAgICBvdXRwdXQgPSAodG9JbnQobnVtYmVyICUgMTAwIC8gMTApID09PSAxKSA/ICd0aCcgOgogICAgICAgICAgICAgICAgKGIgPT09IDEpID8gJ3N0JyA6CiAgICAgICAgICAgICAgICAoYiA9PT0gMikgPyAnbmQnIDoKICAgICAgICAgICAgICAgIChiID09PSAzKSA/ICdyZCcgOiAndGgnOwogICAgICAgICAgICByZXR1cm4gbnVtYmVyICsgb3V0cHV0OwogICAgICAgIH0KICAgIH0pOwoKICAgIC8qIEVNQkVEX0xBTkdVQUdFUyAqLwoKICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgICAgICBFeHBvc2luZyBNb21lbnQKICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCiAgICBmdW5jdGlvbiBtYWtlR2xvYmFsKHNob3VsZERlcHJlY2F0ZSkgewogICAgICAgIC8qZ2xvYmFsIGVuZGVyOmZhbHNlICovCiAgICAgICAgaWYgKHR5cGVvZiBlbmRlciAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBvbGRHbG9iYWxNb21lbnQgPSBnbG9iYWxTY29wZS5tb21lbnQ7CiAgICAgICAgaWYgKHNob3VsZERlcHJlY2F0ZSkgewogICAgICAgICAgICBnbG9iYWxTY29wZS5tb21lbnQgPSBkZXByZWNhdGUoCiAgICAgICAgICAgICAgICAgICAgIkFjY2Vzc2luZyBNb21lbnQgdGhyb3VnaCB0aGUgZ2xvYmFsIHNjb3BlIGlzICIgKwogICAgICAgICAgICAgICAgICAgICJkZXByZWNhdGVkLCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGFuIHVwY29taW5nICIgKwogICAgICAgICAgICAgICAgICAgICJyZWxlYXNlLiIsCiAgICAgICAgICAgICAgICAgICAgbW9tZW50KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBnbG9iYWxTY29wZS5tb21lbnQgPSBtb21lbnQ7CiAgICAgICAgfQogICAgfQoKICAgIC8vIENvbW1vbkpTIG1vZHVsZSBpcyBkZWZpbmVkCiAgICBpZiAoaGFzTW9kdWxlKSB7CiAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBtb21lbnQ7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgewogICAgICAgIGRlZmluZSgibW9tZW50IiwgWydyZXF1aXJlJywnZXhwb3J0cycsJ21vZHVsZSddLGZ1bmN0aW9uIChyZXF1aXJlLCBleHBvcnRzLCBtb2R1bGUpIHsKICAgICAgICAgICAgaWYgKG1vZHVsZS5jb25maWcgJiYgbW9kdWxlLmNvbmZpZygpICYmIG1vZHVsZS5jb25maWcoKS5ub0dsb2JhbCA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgLy8gcmVsZWFzZSB0aGUgZ2xvYmFsIHZhcmlhYmxlCiAgICAgICAgICAgICAgICBnbG9iYWxTY29wZS5tb21lbnQgPSBvbGRHbG9iYWxNb21lbnQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBtb21lbnQ7CiAgICAgICAgfSk7CiAgICAgICAgbWFrZUdsb2JhbCh0cnVlKTsKICAgIH0gZWxzZSB7CiAgICAgICAgbWFrZUdsb2JhbCgpOwogICAgfQp9KS5jYWxsKHRoaXMpOwoKLyoKamVkLmpzCnYwLjUuMGJldGEKCmh0dHBzOi8vZ2l0aHViLmNvbS9TbGV4QXh0b24vSmVkCi0tLS0tLS0tLS0tCkEgZ2V0dGV4dCBjb21wYXRpYmxlIGkxOG4gbGlicmFyeSBmb3IgbW9kZXJuIEphdmFTY3JpcHQgQXBwbGljYXRpb25zCgpieSBBbGV4IFNleHRvbiAtIEFsZXhTZXh0b24gW2F0XSBnbWFpbCAtIEBTbGV4QXh0b24KV1RGUEwgbGljZW5zZSBmb3IgdXNlCkRvam8gQ0xBIGZvciBjb250cmlidXRpb25zCgpKZWQgb2ZmZXJzIHRoZSBlbnRpcmUgYXBwbGljYWJsZSBHTlUgZ2V0dGV4dCBzcGVjJ2Qgc2V0IG9mCmZ1bmN0aW9ucywgYnV0IGFsc28gb2ZmZXJzIHNvbWUgbmljZXIgd3JhcHBlcnMgYXJvdW5kIHRoZW0uClRoZSBhcGkgZm9yIGdldHRleHQgd2FzIHdyaXR0ZW4gZm9yIGEgbGFuZ3VhZ2Ugd2l0aCBubyBmdW5jdGlvbgpvdmVybG9hZGluZywgc28gSmVkIGFsbG93cyBhIGxpdHRsZSBtb3JlIG9mIHRoYXQuCgpNYW55IHRoYW5rcyB0byBKb3NodWEgSS4gTWlsbGVyIC0gdW5ydHN0QGNwYW4ub3JnIC0gd2hvIHdyb3RlCmdldHRleHQuanMgYmFjayBpbiAyMDA4LiBJIHdhcyBhYmxlIHRvIHZldCBhIGxvdCBvZiBteSBpZGVhcwphZ2FpbnN0IGhpcy4gSSBhbHNvIG1hZGUgc3VyZSBKZWQgcGFzc2VkIGFnYWluc3QgaGlzIHRlc3RzCmluIG9yZGVyIHRvIG9mZmVyIGVhc3kgdXBncmFkZXMgLS0ganNnZXR0ZXh0LmJlcmxpb3MuZGUKKi8KKGZ1bmN0aW9uIChyb290LCB1bmRlZikgewoKICAvLyBTZXQgdXAgc29tZSB1bmRlcnNjb3JlLXN0eWxlIGZ1bmN0aW9ucywgaWYgeW91IGFscmVhZHkgaGF2ZQogIC8vIHVuZGVyc2NvcmUsIGZlZWwgZnJlZSB0byBkZWxldGUgdGhpcyBzZWN0aW9uLCBhbmQgdXNlIGl0CiAgLy8gZGlyZWN0bHksIGhvd2V2ZXIsIHRoZSBhbW91bnQgb2YgZnVuY3Rpb25zIHVzZWQgZG9lc24ndAogIC8vIHdhcnJhbnQgaGF2aW5nIHVuZGVyc2NvcmUgYXMgYSBmdWxsIGRlcGVuZGVuY3kuCiAgLy8gVW5kZXJzY29yZSAxLjMuMCB3YXMgdXNlZCB0byBwb3J0IGFuZCBpcyBsaWNlbnNlZAogIC8vIHVuZGVyIHRoZSBNSVQgTGljZW5zZSBieSBKZXJlbXkgQXNoa2VuYXMuCiAgdmFyIEFycmF5UHJvdG8gICAgPSBBcnJheS5wcm90b3R5cGUsCiAgICAgIE9ialByb3RvICAgICAgPSBPYmplY3QucHJvdG90eXBlLAogICAgICBzbGljZSAgICAgICAgID0gQXJyYXlQcm90by5zbGljZSwKICAgICAgaGFzT3duUHJvcCAgICA9IE9ialByb3RvLmhhc093blByb3BlcnR5LAogICAgICBuYXRpdmVGb3JFYWNoID0gQXJyYXlQcm90by5mb3JFYWNoLAogICAgICBicmVha2VyICAgICAgID0ge307CgogIC8vIFdlJ3JlIG5vdCB1c2luZyB0aGUgT09QIHN0eWxlIF8gc28gd2UgZG9uJ3QgbmVlZCB0aGUKICAvLyBleHRyYSBsZXZlbCBvZiBpbmRpcmVjdGlvbi4gVGhpcyBzdGlsbCBtZWFucyB0aGF0IHlvdQogIC8vIHN1YiBvdXQgZm9yIHJlYWwgYF9gIHRob3VnaC4KICB2YXIgXyA9IHsKICAgIGZvckVhY2ggOiBmdW5jdGlvbiggb2JqLCBpdGVyYXRvciwgY29udGV4dCApIHsKICAgICAgdmFyIGksIGwsIGtleTsKICAgICAgaWYgKCBvYmogPT09IG51bGwgKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoIG5hdGl2ZUZvckVhY2ggJiYgb2JqLmZvckVhY2ggPT09IG5hdGl2ZUZvckVhY2ggKSB7CiAgICAgICAgb2JqLmZvckVhY2goIGl0ZXJhdG9yLCBjb250ZXh0ICk7CiAgICAgIH0KICAgICAgZWxzZSBpZiAoIG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoICkgewogICAgICAgIGZvciAoIGkgPSAwLCBsID0gb2JqLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKICAgICAgICAgIGlmICggaSBpbiBvYmogJiYgaXRlcmF0b3IuY2FsbCggY29udGV4dCwgb2JqW2ldLCBpLCBvYmogKSA9PT0gYnJlYWtlciApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICBmb3IgKCBrZXkgaW4gb2JqKSB7CiAgICAgICAgICBpZiAoIGhhc093blByb3AuY2FsbCggb2JqLCBrZXkgKSApIHsKICAgICAgICAgICAgaWYgKCBpdGVyYXRvci5jYWxsIChjb250ZXh0LCBvYmpba2V5XSwga2V5LCBvYmogKSA9PT0gYnJlYWtlciApIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBleHRlbmQgOiBmdW5jdGlvbiggb2JqICkgewogICAgICB0aGlzLmZvckVhY2goIHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApLCBmdW5jdGlvbiAoIHNvdXJjZSApIHsKICAgICAgICBmb3IgKCB2YXIgcHJvcCBpbiBzb3VyY2UgKSB7CiAgICAgICAgICBvYmpbcHJvcF0gPSBzb3VyY2VbcHJvcF07CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIG9iajsKICAgIH0KICB9OwogIC8vIEVORCBNaW5pYXR1cmUgdW5kZXJzY29yZSBpbXBsCgogIC8vIEplZCBpcyBhIGNvbnN0cnVjdG9yIGZ1bmN0aW9uCiAgdmFyIEplZCA9IGZ1bmN0aW9uICggb3B0aW9ucyApIHsKICAgIC8vIFNvbWUgbWluaW1hbCBkZWZhdWx0cwogICAgdGhpcy5kZWZhdWx0cyA9IHsKICAgICAgImxvY2FsZV9kYXRhIiA6IHsKICAgICAgICAibWVzc2FnZXMiIDogewogICAgICAgICAgIiIgOiB7CiAgICAgICAgICAgICJkb21haW4iICAgICAgIDogIm1lc3NhZ2VzIiwKICAgICAgICAgICAgImxhbmciICAgICAgICAgOiAiZW4iLAogICAgICAgICAgICAicGx1cmFsX2Zvcm1zIiA6ICJucGx1cmFscz0yOyBwbHVyYWw9KG4gIT0gMSk7IgogICAgICAgICAgfQogICAgICAgICAgLy8gVGhlcmUgYXJlIG5vIGRlZmF1bHQga2V5cywgdGhvdWdoCiAgICAgICAgfQogICAgICB9LAogICAgICAvLyBUaGUgZGVmYXVsdCBkb21haW4gaWYgb25lIGlzIG1pc3NpbmcKICAgICAgImRvbWFpbiIgOiAibWVzc2FnZXMiCiAgICB9OwoKICAgIC8vIE1peCBpbiB0aGUgc2VudCBvcHRpb25zIHdpdGggdGhlIGRlZmF1bHQgb3B0aW9ucwogICAgdGhpcy5vcHRpb25zID0gXy5leHRlbmQoIHt9LCB0aGlzLmRlZmF1bHRzLCBvcHRpb25zICk7CiAgICB0aGlzLnRleHRkb21haW4oIHRoaXMub3B0aW9ucy5kb21haW4gKTsKCiAgICBpZiAoIG9wdGlvbnMuZG9tYWluICYmICEgdGhpcy5vcHRpb25zLmxvY2FsZV9kYXRhWyB0aGlzLm9wdGlvbnMuZG9tYWluIF0gKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignVGV4dCBkb21haW4gc2V0IHRvIG5vbi1leGlzdGVudCBkb21haW46IGAnICsgb3B0aW9ucy5kb21haW4gKyAnYCcpOwogICAgfQogIH07CgogIC8vIFRoZSBnZXR0ZXh0IHNwZWMgc2V0cyB0aGlzIGNoYXJhY3RlciBhcyB0aGUgZGVmYXVsdAogIC8vIGRlbGltaXRlciBmb3IgY29udGV4dCBsb29rdXBzLgogIC8vIGUuZy46IGNvbnRleHRcdTAwMDRrZXkKICAvLyBJZiB5b3VyIHRyYW5zbGF0aW9uIGNvbXBhbnkgdXNlcyBzb21ldGhpbmcgZGlmZmVyZW50LAogIC8vIGp1c3QgY2hhbmdlIHRoaXMgYXQgYW55IHRpbWUgYW5kIGl0IHdpbGwgdXNlIHRoYXQgaW5zdGVhZC4KICBKZWQuY29udGV4dF9kZWxpbWl0ZXIgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKCA0ICk7CgogIGZ1bmN0aW9uIGdldFBsdXJhbEZvcm1GdW5jICggcGx1cmFsX2Zvcm1fc3RyaW5nICkgewogICAgcmV0dXJuIEplZC5QRi5jb21waWxlKCBwbHVyYWxfZm9ybV9zdHJpbmcgfHwgIm5wbHVyYWxzPTI7IHBsdXJhbD0obiAhPSAxKTsiKTsKICB9CgogIGZ1bmN0aW9uIENoYWluKCBrZXksIGkxOG4gKXsKICAgIHRoaXMuX2tleSA9IGtleTsKICAgIHRoaXMuX2kxOG4gPSBpMThuOwogIH0KCiAgLy8gQ3JlYXRlIGEgY2hhaW5hYmxlIGFwaSBmb3IgYWRkaW5nIGFyZ3MgcHJldHRpbHkKICBfLmV4dGVuZCggQ2hhaW4ucHJvdG90eXBlLCB7CiAgICBvbkRvbWFpbiA6IGZ1bmN0aW9uICggZG9tYWluICkgewogICAgICB0aGlzLl9kb21haW4gPSBkb21haW47CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIHdpdGhDb250ZXh0IDogZnVuY3Rpb24gKCBjb250ZXh0ICkgewogICAgICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgaWZQbHVyYWwgOiBmdW5jdGlvbiAoIG51bSwgcGtleSApIHsKICAgICAgdGhpcy5fdmFsID0gbnVtOwogICAgICB0aGlzLl9wa2V5ID0gcGtleTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgZmV0Y2ggOiBmdW5jdGlvbiAoIHNBcnIgKSB7CiAgICAgIGlmICgge30udG9TdHJpbmcuY2FsbCggc0FyciApICE9ICdbb2JqZWN0IEFycmF5XScgKSB7CiAgICAgICAgc0FyciA9IFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgfQogICAgICByZXR1cm4gKCBzQXJyICYmIHNBcnIubGVuZ3RoID8gSmVkLnNwcmludGYgOiBmdW5jdGlvbih4KXsgcmV0dXJuIHg7IH0gKSgKICAgICAgICB0aGlzLl9pMThuLmRjbnBnZXR0ZXh0KHRoaXMuX2RvbWFpbiwgdGhpcy5fY29udGV4dCwgdGhpcy5fa2V5LCB0aGlzLl9wa2V5LCB0aGlzLl92YWwpLAogICAgICAgIHNBcnIKICAgICAgKTsKICAgIH0KICB9KTsKCiAgLy8gQWRkIGZ1bmN0aW9ucyB0byB0aGUgSmVkIHByb3RvdHlwZS4KICAvLyBUaGVzZSB3aWxsIGJlIHRoZSBmdW5jdGlvbnMgb24gdGhlIG9iamVjdCB0aGF0J3MgcmV0dXJuZWQKICAvLyBmcm9tIGNyZWF0aW5nIGEgYG5ldyBKZWQoKWAKICAvLyBUaGVzZSBzZWVtIHJlZHVuZGFudCwgYnV0IHRoZXkgZ3ppcCBwcmV0dHkgd2VsbC4KICBfLmV4dGVuZCggSmVkLnByb3RvdHlwZSwgewogICAgLy8gVGhlIHNleGllciBhcGkgc3RhcnQgcG9pbnQKICAgIHRyYW5zbGF0ZSA6IGZ1bmN0aW9uICgga2V5ICkgewogICAgICByZXR1cm4gbmV3IENoYWluKCBrZXksIHRoaXMgKTsKICAgIH0sCgogICAgdGV4dGRvbWFpbiA6IGZ1bmN0aW9uICggZG9tYWluICkgewogICAgICBpZiAoICEgZG9tYWluICkgewogICAgICAgIHJldHVybiB0aGlzLl90ZXh0ZG9tYWluOwogICAgICB9CiAgICAgIHRoaXMuX3RleHRkb21haW4gPSBkb21haW47CiAgICB9LAoKICAgIGdldHRleHQgOiBmdW5jdGlvbiAoIGtleSApIHsKICAgICAgcmV0dXJuIHRoaXMuZGNucGdldHRleHQuY2FsbCggdGhpcywgdW5kZWYsIHVuZGVmLCBrZXkgKTsKICAgIH0sCgogICAgZGdldHRleHQgOiBmdW5jdGlvbiAoIGRvbWFpbiwga2V5ICkgewogICAgIHJldHVybiB0aGlzLmRjbnBnZXR0ZXh0LmNhbGwoIHRoaXMsIGRvbWFpbiwgdW5kZWYsIGtleSApOwogICAgfSwKCiAgICBkY2dldHRleHQgOiBmdW5jdGlvbiAoIGRvbWFpbiAsIGtleSAvKiwgY2F0ZWdvcnkgKi8gKSB7CiAgICAgIC8vIElnbm9yZXMgdGhlIGNhdGVnb3J5IGFueXdheXMKICAgICAgcmV0dXJuIHRoaXMuZGNucGdldHRleHQuY2FsbCggdGhpcywgZG9tYWluLCB1bmRlZiwga2V5ICk7CiAgICB9LAoKICAgIG5nZXR0ZXh0IDogZnVuY3Rpb24gKCBza2V5LCBwa2V5LCB2YWwgKSB7CiAgICAgIHJldHVybiB0aGlzLmRjbnBnZXR0ZXh0LmNhbGwoIHRoaXMsIHVuZGVmLCB1bmRlZiwgc2tleSwgcGtleSwgdmFsICk7CiAgICB9LAoKICAgIGRuZ2V0dGV4dCA6IGZ1bmN0aW9uICggZG9tYWluLCBza2V5LCBwa2V5LCB2YWwgKSB7CiAgICAgIHJldHVybiB0aGlzLmRjbnBnZXR0ZXh0LmNhbGwoIHRoaXMsIGRvbWFpbiwgdW5kZWYsIHNrZXksIHBrZXksIHZhbCApOwogICAgfSwKCiAgICBkY25nZXR0ZXh0IDogZnVuY3Rpb24gKCBkb21haW4sIHNrZXksIHBrZXksIHZhbC8qLCBjYXRlZ29yeSAqLykgewogICAgICByZXR1cm4gdGhpcy5kY25wZ2V0dGV4dC5jYWxsKCB0aGlzLCBkb21haW4sIHVuZGVmLCBza2V5LCBwa2V5LCB2YWwgKTsKICAgIH0sCgogICAgcGdldHRleHQgOiBmdW5jdGlvbiAoIGNvbnRleHQsIGtleSApIHsKICAgICAgcmV0dXJuIHRoaXMuZGNucGdldHRleHQuY2FsbCggdGhpcywgdW5kZWYsIGNvbnRleHQsIGtleSApOwogICAgfSwKCiAgICBkcGdldHRleHQgOiBmdW5jdGlvbiAoIGRvbWFpbiwgY29udGV4dCwga2V5ICkgewogICAgICByZXR1cm4gdGhpcy5kY25wZ2V0dGV4dC5jYWxsKCB0aGlzLCBkb21haW4sIGNvbnRleHQsIGtleSApOwogICAgfSwKCiAgICBkY3BnZXR0ZXh0IDogZnVuY3Rpb24gKCBkb21haW4sIGNvbnRleHQsIGtleS8qLCBjYXRlZ29yeSAqLykgewogICAgICByZXR1cm4gdGhpcy5kY25wZ2V0dGV4dC5jYWxsKCB0aGlzLCBkb21haW4sIGNvbnRleHQsIGtleSApOwogICAgfSwKCiAgICBucGdldHRleHQgOiBmdW5jdGlvbiAoIGNvbnRleHQsIHNrZXksIHBrZXksIHZhbCApIHsKICAgICAgcmV0dXJuIHRoaXMuZGNucGdldHRleHQuY2FsbCggdGhpcywgdW5kZWYsIGNvbnRleHQsIHNrZXksIHBrZXksIHZhbCApOwogICAgfSwKCiAgICBkbnBnZXR0ZXh0IDogZnVuY3Rpb24gKCBkb21haW4sIGNvbnRleHQsIHNrZXksIHBrZXksIHZhbCApIHsKICAgICAgcmV0dXJuIHRoaXMuZGNucGdldHRleHQuY2FsbCggdGhpcywgZG9tYWluLCBjb250ZXh0LCBza2V5LCBwa2V5LCB2YWwgKTsKICAgIH0sCgogICAgLy8gVGhlIG1vc3QgZnVsbHkgcXVhbGlmaWVkIGdldHRleHQgZnVuY3Rpb24uIEl0IGhhcyBldmVyeSBvcHRpb24uCiAgICAvLyBTaW5jZSBpdCBoYXMgZXZlcnkgb3B0aW9uLCB3ZSBjYW4gdXNlIGl0IGZyb20gZXZlcnkgb3RoZXIgbWV0aG9kLgogICAgLy8gVGhpcyBpcyB0aGUgYnJlYWQgYW5kIGJ1dHRlci4KICAgIC8vIFRlY2huaWNhbGx5IHRoZXJlIHNob3VsZCBiZSBvbmUgbW9yZSBhcmd1bWVudCBpbiB0aGlzIGZ1bmN0aW9uIGZvciAnQ2F0ZWdvcnknLAogICAgLy8gYnV0IHNpbmNlIHdlIG5ldmVyIHVzZSBpdCwgd2UgbWlnaHQgYXMgd2VsbCBub3Qgd2FzdGUgdGhlIGJ5dGVzIHRvIGRlZmluZSBpdC4KICAgIGRjbnBnZXR0ZXh0IDogZnVuY3Rpb24gKCBkb21haW4sIGNvbnRleHQsIHNpbmd1bGFyX2tleSwgcGx1cmFsX2tleSwgdmFsICkgewogICAgICAvLyBTZXQgc29tZSBkZWZhdWx0cwoKICAgICAgcGx1cmFsX2tleSA9IHBsdXJhbF9rZXkgfHwgc2luZ3VsYXJfa2V5OwoKICAgICAgLy8gVXNlIHRoZSBnbG9iYWwgZG9tYWluIGRlZmF1bHQgaWYgb25lCiAgICAgIC8vIGlzbid0IGV4cGxpY2l0bHkgcGFzc2VkIGluCiAgICAgIGRvbWFpbiA9IGRvbWFpbiB8fCB0aGlzLl90ZXh0ZG9tYWluOwoKICAgICAgLy8gRGVmYXVsdCB0aGUgdmFsdWUgdG8gdGhlIHNpbmd1bGFyIGNhc2UKICAgICAgdmFsID0gdHlwZW9mIHZhbCA9PSAndW5kZWZpbmVkJyA/IDEgOiB2YWw7CgogICAgICB2YXIgZmFsbGJhY2s7CgogICAgICAvLyBIYW5kbGUgc3BlY2lhbCBjYXNlcwoKICAgICAgLy8gTm8gb3B0aW9ucyBmb3VuZAogICAgICBpZiAoICEgdGhpcy5vcHRpb25zICkgewogICAgICAgIC8vIFRoZXJlJ3MgbGlrZWx5IHNvbWV0aGluZyB3cm9uZywgYnV0IHdlJ2xsIHJldHVybiB0aGUgY29ycmVjdCBrZXkgZm9yIGVuZ2xpc2gKICAgICAgICAvLyBXZSBkbyB0aGlzIGJ5IGluc3RhbnRpYXRpbmcgYSBicmFuZCBuZXcgSmVkIGluc3RhbmNlIHdpdGggdGhlIGRlZmF1bHQgc2V0CiAgICAgICAgLy8gZm9yIGV2ZXJ5dGhpbmcgdGhhdCBjb3VsZCBiZSBicm9rZW4uCiAgICAgICAgZmFsbGJhY2sgPSBuZXcgSmVkKCk7CiAgICAgICAgcmV0dXJuIGZhbGxiYWNrLmRjbnBnZXR0ZXh0LmNhbGwoIGZhbGxiYWNrLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgc2luZ3VsYXJfa2V5LCBwbHVyYWxfa2V5LCB2YWwgKTsKICAgICAgfQoKICAgICAgLy8gTm8gdHJhbnNsYXRpb24gZGF0YSBwcm92aWRlZAogICAgICBpZiAoICEgdGhpcy5vcHRpb25zLmxvY2FsZV9kYXRhICkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gbG9jYWxlIGRhdGEgcHJvdmlkZWQuJyk7CiAgICAgIH0KCiAgICAgIGlmICggISB0aGlzLm9wdGlvbnMubG9jYWxlX2RhdGFbIGRvbWFpbiBdICkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignRG9tYWluIGAnICsgZG9tYWluICsgJ2Agd2FzIG5vdCBmb3VuZC4nKTsKICAgICAgfQoKICAgICAgaWYgKCAhIHRoaXMub3B0aW9ucy5sb2NhbGVfZGF0YVsgZG9tYWluIF1bICIiIF0gKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBsb2NhbGUgbWV0YSBpbmZvcm1hdGlvbiBwcm92aWRlZC4nKTsKICAgICAgfQoKICAgICAgLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSB0cnV0aHkga2V5LiBPdGhlcndpc2Ugd2UgbWlnaHQgc3RhcnQgbG9va2luZwogICAgICAvLyBpbnRvIHRoZSBlbXB0eSBzdHJpbmcga2V5LCB3aGljaCBpcyB0aGUgb3B0aW9ucyBmb3IgdGhlIGxvY2FsZQogICAgICAvLyBkYXRhLgogICAgICBpZiAoICEgc2luZ3VsYXJfa2V5ICkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gdHJhbnNsYXRpb24ga2V5IGZvdW5kLicpOwogICAgICB9CgogICAgICAvLyBIYW5kbGUgaW52YWxpZCBudW1iZXJzLCBidXQgdHJ5IGNhc3Rpbmcgc3RyaW5ncyBmb3IgZ29vZCBtZWFzdXJlCiAgICAgIGlmICggdHlwZW9mIHZhbCAhPSAnbnVtYmVyJyApIHsKICAgICAgICB2YWwgPSBwYXJzZUludCggdmFsLCAxMCApOwoKICAgICAgICBpZiAoIGlzTmFOKCB2YWwgKSApIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVGhlIG51bWJlciB0aGF0IHdhcyBwYXNzZWQgaW4gaXMgbm90IGEgbnVtYmVyLicpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIGtleSAgPSBjb250ZXh0ID8gY29udGV4dCArIEplZC5jb250ZXh0X2RlbGltaXRlciArIHNpbmd1bGFyX2tleSA6IHNpbmd1bGFyX2tleSwKICAgICAgICAgIGxvY2FsZV9kYXRhID0gdGhpcy5vcHRpb25zLmxvY2FsZV9kYXRhLAogICAgICAgICAgZGljdCA9IGxvY2FsZV9kYXRhWyBkb21haW4gXSwKICAgICAgICAgIHBsdXJhbEZvcm1zID0gZGljdFsiIl0ucGx1cmFsX2Zvcm1zIHx8IChsb2NhbGVfZGF0YS5tZXNzYWdlcyB8fCB0aGlzLmRlZmF1bHRzLmxvY2FsZV9kYXRhLm1lc3NhZ2VzKVsiIl0ucGx1cmFsX2Zvcm1zLAogICAgICAgICAgdmFsX2lkeCA9IGdldFBsdXJhbEZvcm1GdW5jKHBsdXJhbEZvcm1zKSh2YWwpICsgMSwKICAgICAgICAgIHZhbF9saXN0LAogICAgICAgICAgcmVzOwoKICAgICAgLy8gVGhyb3cgYW4gZXJyb3IgaWYgYSBkb21haW4gaXNuJ3QgZm91bmQKICAgICAgaWYgKCAhIGRpY3QgKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBkb21haW4gbmFtZWQgYCcgKyBkb21haW4gKyAnYCBjb3VsZCBiZSBmb3VuZC4nKTsKICAgICAgfQoKICAgICAgdmFsX2xpc3QgPSBkaWN0WyBrZXkgXTsKCiAgICAgIC8vIElmIHRoZXJlIGlzIG5vIG1hdGNoLCB0aGVuIHJldmVydCBiYWNrIHRvCiAgICAgIC8vIGVuZ2xpc2ggc3R5bGUgc2luZ3VsYXIvcGx1cmFsIHdpdGggdGhlIGtleXMgcGFzc2VkIGluLgogICAgICBpZiAoICEgdmFsX2xpc3QgfHwgdmFsX2lkeCA+PSB2YWxfbGlzdC5sZW5ndGggKSB7CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5taXNzaW5nX2tleV9jYWxsYmFjaykgewogICAgICAgICAgdGhpcy5vcHRpb25zLm1pc3Npbmdfa2V5X2NhbGxiYWNrKGtleSk7CiAgICAgICAgfQogICAgICAgIHJlcyA9IFsgbnVsbCwgc2luZ3VsYXJfa2V5LCBwbHVyYWxfa2V5IF07CiAgICAgICAgcmV0dXJuIHJlc1sgZ2V0UGx1cmFsRm9ybUZ1bmMocGx1cmFsRm9ybXMpKCB2YWwgKSArIDEgXTsKICAgICAgfQoKICAgICAgcmVzID0gdmFsX2xpc3RbIHZhbF9pZHggXTsKCiAgICAgIC8vIFRoaXMgaW5jbHVkZXMgZW1wdHkgc3RyaW5ncyBvbiBwdXJwb3NlCiAgICAgIGlmICggISByZXMgICkgewogICAgICAgIHJlcyA9IFsgbnVsbCwgc2luZ3VsYXJfa2V5LCBwbHVyYWxfa2V5IF07CiAgICAgICAgcmV0dXJuIHJlc1sgZ2V0UGx1cmFsRm9ybUZ1bmMocGx1cmFsRm9ybXMpKCB2YWwgKSArIDEgXTsKICAgICAgfQogICAgICByZXR1cm4gcmVzOwogICAgfQogIH0pOwoKCiAgLy8gV2UgYWRkIGluIHNwcmludGYgY2FwYWJpbGl0aWVzIGZvciBwb3N0IHRyYW5zbGF0aW9uIHZhbHVlIGludGVyb2xhdGlvbgogIC8vIFRoaXMgaXMgbm90IGludGVybmFsbHkgdXNlZCwgc28geW91IGNhbiByZW1vdmUgaXQgaWYgeW91IGhhdmUgdGhpcwogIC8vIGF2YWlsYWJsZSBzb21ld2hlcmUgZWxzZSwgb3Igd2FudCB0byB1c2UgYSBkaWZmZXJlbnQgc3lzdGVtLgoKICAvLyBXZSBfc2xpZ2h0bHlfIG1vZGlmeSB0aGUgbm9ybWFsIHNwcmludGYgYmVoYXZpb3IgdG8gbW9yZSBncmFjZWZ1bGx5IGhhbmRsZQogIC8vIHVuZGVmaW5lZCB2YWx1ZXMuCgogIC8qKgogICBzcHJpbnRmKCkgZm9yIEphdmFTY3JpcHQgMC43LWJldGExCiAgIGh0dHA6Ly93d3cuZGl2ZWludG9qYXZhc2NyaXB0LmNvbS9wcm9qZWN0cy9qYXZhc2NyaXB0LXNwcmludGYKCiAgIENvcHlyaWdodCAoYykgQWxleGFuZHJ1IE1hcmFzdGVhbnUgPGFsZXhhaG9saWMgW2F0KSBnbWFpbCAoZG90XSBjb20+CiAgIEFsbCByaWdodHMgcmVzZXJ2ZWQuCgogICBSZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXQKICAgbW9kaWZpY2F0aW9uLCBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6CiAgICAgICAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0CiAgICAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci4KICAgICAgICogUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHQKICAgICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZQogICAgICAgICBkb2N1bWVudGF0aW9uIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLgogICAgICAgKiBOZWl0aGVyIHRoZSBuYW1lIG9mIHNwcmludGYoKSBmb3IgSmF2YVNjcmlwdCBub3IgdGhlCiAgICAgICAgIG5hbWVzIG9mIGl0cyBjb250cmlidXRvcnMgbWF5IGJlIHVzZWQgdG8gZW5kb3JzZSBvciBwcm9tb3RlIHByb2R1Y3RzCiAgICAgICAgIGRlcml2ZWQgZnJvbSB0aGlzIHNvZnR3YXJlIHdpdGhvdXQgc3BlY2lmaWMgcHJpb3Igd3JpdHRlbiBwZXJtaXNzaW9uLgoKICAgVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9SUyAiQVMgSVMiIEFORAogICBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRAogICBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFCiAgIERJU0NMQUlNRUQuIElOIE5PIEVWRU5UIFNIQUxMIEFsZXhhbmRydSBNYXJhc3RlYW51IEJFIExJQUJMRSBGT1IgQU5ZCiAgIERJUkVDVCwgSU5ESVJFQ1QsIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTCiAgIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUzsKICAgTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTIElOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5ECiAgIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QgTElBQklMSVRZLCBPUiBUT1JUCiAgIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFIFVTRSBPRiBUSElTCiAgIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLgogICovCiAgdmFyIHNwcmludGYgPSAoZnVuY3Rpb24oKSB7CiAgICBmdW5jdGlvbiBnZXRfdHlwZSh2YXJpYWJsZSkgewogICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhcmlhYmxlKS5zbGljZSg4LCAtMSkudG9Mb3dlckNhc2UoKTsKICAgIH0KICAgIGZ1bmN0aW9uIHN0cl9yZXBlYXQoaW5wdXQsIG11bHRpcGxpZXIpIHsKICAgICAgZm9yICh2YXIgb3V0cHV0ID0gW107IG11bHRpcGxpZXIgPiAwOyBvdXRwdXRbLS1tdWx0aXBsaWVyXSA9IGlucHV0KSB7LyogZG8gbm90aGluZyAqL30KICAgICAgcmV0dXJuIG91dHB1dC5qb2luKCcnKTsKICAgIH0KCiAgICB2YXIgc3RyX2Zvcm1hdCA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXN0cl9mb3JtYXQuY2FjaGUuaGFzT3duUHJvcGVydHkoYXJndW1lbnRzWzBdKSkgewogICAgICAgIHN0cl9mb3JtYXQuY2FjaGVbYXJndW1lbnRzWzBdXSA9IHN0cl9mb3JtYXQucGFyc2UoYXJndW1lbnRzWzBdKTsKICAgICAgfQogICAgICByZXR1cm4gc3RyX2Zvcm1hdC5mb3JtYXQuY2FsbChudWxsLCBzdHJfZm9ybWF0LmNhY2hlW2FyZ3VtZW50c1swXV0sIGFyZ3VtZW50cyk7CiAgICB9OwoKICAgIHN0cl9mb3JtYXQuZm9ybWF0ID0gZnVuY3Rpb24ocGFyc2VfdHJlZSwgYXJndikgewogICAgICB2YXIgY3Vyc29yID0gMSwgdHJlZV9sZW5ndGggPSBwYXJzZV90cmVlLmxlbmd0aCwgbm9kZV90eXBlID0gJycsIGFyZywgb3V0cHV0ID0gW10sIGksIGssIG1hdGNoLCBwYWQsIHBhZF9jaGFyYWN0ZXIsIHBhZF9sZW5ndGg7CiAgICAgIGZvciAoaSA9IDA7IGkgPCB0cmVlX2xlbmd0aDsgaSsrKSB7CiAgICAgICAgbm9kZV90eXBlID0gZ2V0X3R5cGUocGFyc2VfdHJlZVtpXSk7CiAgICAgICAgaWYgKG5vZGVfdHlwZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIG91dHB1dC5wdXNoKHBhcnNlX3RyZWVbaV0pOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChub2RlX3R5cGUgPT09ICdhcnJheScpIHsKICAgICAgICAgIG1hdGNoID0gcGFyc2VfdHJlZVtpXTsgLy8gY29udmVuaWVuY2UgcHVycG9zZXMgb25seQogICAgICAgICAgaWYgKG1hdGNoWzJdKSB7IC8vIGtleXdvcmQgYXJndW1lbnQKICAgICAgICAgICAgYXJnID0gYXJndltjdXJzb3JdOwogICAgICAgICAgICBmb3IgKGsgPSAwOyBrIDwgbWF0Y2hbMl0ubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgICBpZiAoIWFyZy5oYXNPd25Qcm9wZXJ0eShtYXRjaFsyXVtrXSkpIHsKICAgICAgICAgICAgICAgIHRocm93KHNwcmludGYoJ1tzcHJpbnRmXSBwcm9wZXJ0eSAiJXMiIGRvZXMgbm90IGV4aXN0JywgbWF0Y2hbMl1ba10pKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYXJnID0gYXJnW21hdGNoWzJdW2tdXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAobWF0Y2hbMV0pIHsgLy8gcG9zaXRpb25hbCBhcmd1bWVudCAoZXhwbGljaXQpCiAgICAgICAgICAgIGFyZyA9IGFyZ3ZbbWF0Y2hbMV1dOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7IC8vIHBvc2l0aW9uYWwgYXJndW1lbnQgKGltcGxpY2l0KQogICAgICAgICAgICBhcmcgPSBhcmd2W2N1cnNvcisrXTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoL1tec10vLnRlc3QobWF0Y2hbOF0pICYmIChnZXRfdHlwZShhcmcpICE9ICdudW1iZXInKSkgewogICAgICAgICAgICB0aHJvdyhzcHJpbnRmKCdbc3ByaW50Zl0gZXhwZWN0aW5nIG51bWJlciBidXQgZm91bmQgJXMnLCBnZXRfdHlwZShhcmcpKSk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gSmVkIEVESVQKICAgICAgICAgIGlmICggdHlwZW9mIGFyZyA9PSAndW5kZWZpbmVkJyB8fCBhcmcgPT09IG51bGwgKSB7CiAgICAgICAgICAgIGFyZyA9ICcnOwogICAgICAgICAgfQogICAgICAgICAgLy8gSmVkIEVESVQKCiAgICAgICAgICBzd2l0Y2ggKG1hdGNoWzhdKSB7CiAgICAgICAgICAgIGNhc2UgJ2InOiBhcmcgPSBhcmcudG9TdHJpbmcoMik7IGJyZWFrOwogICAgICAgICAgICBjYXNlICdjJzogYXJnID0gU3RyaW5nLmZyb21DaGFyQ29kZShhcmcpOyBicmVhazsKICAgICAgICAgICAgY2FzZSAnZCc6IGFyZyA9IHBhcnNlSW50KGFyZywgMTApOyBicmVhazsKICAgICAgICAgICAgY2FzZSAnZSc6IGFyZyA9IG1hdGNoWzddID8gYXJnLnRvRXhwb25lbnRpYWwobWF0Y2hbN10pIDogYXJnLnRvRXhwb25lbnRpYWwoKTsgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2YnOiBhcmcgPSBtYXRjaFs3XSA/IHBhcnNlRmxvYXQoYXJnKS50b0ZpeGVkKG1hdGNoWzddKSA6IHBhcnNlRmxvYXQoYXJnKTsgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ28nOiBhcmcgPSBhcmcudG9TdHJpbmcoOCk7IGJyZWFrOwogICAgICAgICAgICBjYXNlICdzJzogYXJnID0gKChhcmcgPSBTdHJpbmcoYXJnKSkgJiYgbWF0Y2hbN10gPyBhcmcuc3Vic3RyaW5nKDAsIG1hdGNoWzddKSA6IGFyZyk7IGJyZWFrOwogICAgICAgICAgICBjYXNlICd1JzogYXJnID0gTWF0aC5hYnMoYXJnKTsgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ3gnOiBhcmcgPSBhcmcudG9TdHJpbmcoMTYpOyBicmVhazsKICAgICAgICAgICAgY2FzZSAnWCc6IGFyZyA9IGFyZy50b1N0cmluZygxNikudG9VcHBlckNhc2UoKTsgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBhcmcgPSAoL1tkZWZdLy50ZXN0KG1hdGNoWzhdKSAmJiBtYXRjaFszXSAmJiBhcmcgPj0gMCA/ICcrJysgYXJnIDogYXJnKTsKICAgICAgICAgIHBhZF9jaGFyYWN0ZXIgPSBtYXRjaFs0XSA/IG1hdGNoWzRdID09ICcwJyA/ICcwJyA6IG1hdGNoWzRdLmNoYXJBdCgxKSA6ICcgJzsKICAgICAgICAgIHBhZF9sZW5ndGggPSBtYXRjaFs2XSAtIFN0cmluZyhhcmcpLmxlbmd0aDsKICAgICAgICAgIHBhZCA9IG1hdGNoWzZdID8gc3RyX3JlcGVhdChwYWRfY2hhcmFjdGVyLCBwYWRfbGVuZ3RoKSA6ICcnOwogICAgICAgICAgb3V0cHV0LnB1c2gobWF0Y2hbNV0gPyBhcmcgKyBwYWQgOiBwYWQgKyBhcmcpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gb3V0cHV0LmpvaW4oJycpOwogICAgfTsKCiAgICBzdHJfZm9ybWF0LmNhY2hlID0ge307CgogICAgc3RyX2Zvcm1hdC5wYXJzZSA9IGZ1bmN0aW9uKGZtdCkgewogICAgICB2YXIgX2ZtdCA9IGZtdCwgbWF0Y2ggPSBbXSwgcGFyc2VfdHJlZSA9IFtdLCBhcmdfbmFtZXMgPSAwOwogICAgICB3aGlsZSAoX2ZtdCkgewogICAgICAgIGlmICgobWF0Y2ggPSAvXlteXHgyNV0rLy5leGVjKF9mbXQpKSAhPT0gbnVsbCkgewogICAgICAgICAgcGFyc2VfdHJlZS5wdXNoKG1hdGNoWzBdKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoKG1hdGNoID0gL15ceDI1ezJ9Ly5leGVjKF9mbXQpKSAhPT0gbnVsbCkgewogICAgICAgICAgcGFyc2VfdHJlZS5wdXNoKCclJyk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKChtYXRjaCA9IC9eXHgyNSg/OihbMS05XVxkKilcJHxcKChbXlwpXSspXCkpPyhcKyk/KDB8J1teJF0pPygtKT8oXGQrKT8oPzpcLihcZCspKT8oW2ItZm9zdXhYXSkvLmV4ZWMoX2ZtdCkpICE9PSBudWxsKSB7CiAgICAgICAgICBpZiAobWF0Y2hbMl0pIHsKICAgICAgICAgICAgYXJnX25hbWVzIHw9IDE7CiAgICAgICAgICAgIHZhciBmaWVsZF9saXN0ID0gW10sIHJlcGxhY2VtZW50X2ZpZWxkID0gbWF0Y2hbMl0sIGZpZWxkX21hdGNoID0gW107CiAgICAgICAgICAgIGlmICgoZmllbGRfbWF0Y2ggPSAvXihbYS16X11bYS16X1xkXSopL2kuZXhlYyhyZXBsYWNlbWVudF9maWVsZCkpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmllbGRfbGlzdC5wdXNoKGZpZWxkX21hdGNoWzFdKTsKICAgICAgICAgICAgICB3aGlsZSAoKHJlcGxhY2VtZW50X2ZpZWxkID0gcmVwbGFjZW1lbnRfZmllbGQuc3Vic3RyaW5nKGZpZWxkX21hdGNoWzBdLmxlbmd0aCkpICE9PSAnJykgewogICAgICAgICAgICAgICAgaWYgKChmaWVsZF9tYXRjaCA9IC9eXC4oW2Etel9dW2Etel9cZF0qKS9pLmV4ZWMocmVwbGFjZW1lbnRfZmllbGQpKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBmaWVsZF9saXN0LnB1c2goZmllbGRfbWF0Y2hbMV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoKGZpZWxkX21hdGNoID0gL15cWyhcZCspXF0vLmV4ZWMocmVwbGFjZW1lbnRfZmllbGQpKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBmaWVsZF9saXN0LnB1c2goZmllbGRfbWF0Y2hbMV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRocm93KCdbc3ByaW50Zl0gaHVoPycpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICB0aHJvdygnW3NwcmludGZdIGh1aD8nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBtYXRjaFsyXSA9IGZpZWxkX2xpc3Q7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgYXJnX25hbWVzIHw9IDI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYXJnX25hbWVzID09PSAzKSB7CiAgICAgICAgICAgIHRocm93KCdbc3ByaW50Zl0gbWl4aW5nIHBvc2l0aW9uYWwgYW5kIG5hbWVkIHBsYWNlaG9sZGVycyBpcyBub3QgKHlldCkgc3VwcG9ydGVkJyk7CiAgICAgICAgICB9CiAgICAgICAgICBwYXJzZV90cmVlLnB1c2gobWF0Y2gpOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgIHRocm93KCdbc3ByaW50Zl0gaHVoPycpOwogICAgICAgIH0KICAgICAgICBfZm10ID0gX2ZtdC5zdWJzdHJpbmcobWF0Y2hbMF0ubGVuZ3RoKTsKICAgICAgfQogICAgICByZXR1cm4gcGFyc2VfdHJlZTsKICAgIH07CgogICAgcmV0dXJuIHN0cl9mb3JtYXQ7CiAgfSkoKTsKCiAgdmFyIHZzcHJpbnRmID0gZnVuY3Rpb24oZm10LCBhcmd2KSB7CiAgICBhcmd2LnVuc2hpZnQoZm10KTsKICAgIHJldHVybiBzcHJpbnRmLmFwcGx5KG51bGwsIGFyZ3YpOwogIH07CgogIEplZC5wYXJzZV9wbHVyYWwgPSBmdW5jdGlvbiAoIHBsdXJhbF9mb3JtcywgbiApIHsKICAgIHBsdXJhbF9mb3JtcyA9IHBsdXJhbF9mb3Jtcy5yZXBsYWNlKC9uL2csIG4pOwogICAgcmV0dXJuIEplZC5wYXJzZV9leHByZXNzaW9uKHBsdXJhbF9mb3Jtcyk7CiAgfTsKCiAgSmVkLnNwcmludGYgPSBmdW5jdGlvbiAoIGZtdCwgYXJncyApIHsKICAgIGlmICgge30udG9TdHJpbmcuY2FsbCggYXJncyApID09ICdbb2JqZWN0IEFycmF5XScgKSB7CiAgICAgIHJldHVybiB2c3ByaW50ZiggZm10LCBbXS5zbGljZS5jYWxsKGFyZ3MpICk7CiAgICB9CiAgICByZXR1cm4gc3ByaW50Zi5hcHBseSh0aGlzLCBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cykgKTsKICB9OwoKICBKZWQucHJvdG90eXBlLnNwcmludGYgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gSmVkLnNwcmludGYuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwogIC8vIEVORCBzcHJpbnRmIEltcGxlbWVudGF0aW9uCgogIC8vIFN0YXJ0IHRoZSBQbHVyYWwgZm9ybXMgc2VjdGlvbgogIC8vIFRoaXMgaXMgYSBmdWxsIHBsdXJhbCBmb3JtIGV4cHJlc3Npb24gcGFyc2VyLiBJdCBpcyB1c2VkIHRvIGF2b2lkCiAgLy8gcnVubmluZyAnZXZhbCcgb3IgJ25ldyBGdW5jdGlvbicgZGlyZWN0bHkgYWdhaW5zdCB0aGUgcGx1cmFsCiAgLy8gZm9ybXMuCiAgLy8KICAvLyBUaGlzIGNhbiBiZSBpbXBvcnRhbnQgaWYgeW91IGdldCB0cmFuc2xhdGlvbnMgZG9uZSB0aHJvdWdoIGEgM3JkCiAgLy8gcGFydHkgdmVuZG9yLiBJIGVuY291cmFnZSB5b3UgdG8gdXNlIHRoaXMgaW5zdGVhZCwgaG93ZXZlciwgSQogIC8vIGFsc28gd2lsbCBwcm92aWRlIGEgJ3ByZWNvbXBpbGVyJyB0aGF0IHlvdSBjYW4gdXNlIGF0IGJ1aWxkIHRpbWUKICAvLyB0byBvdXRwdXQgdmFsaWQvc2FmZSBmdW5jdGlvbiByZXByZXNlbnRhdGlvbnMgb2YgdGhlIHBsdXJhbCBmb3JtCiAgLy8gZXhwcmVzc2lvbnMuIFRoaXMgbWVhbnMgeW91IGNhbiBidWlsZCB0aGlzIGNvZGUgb3V0IGZvciB0aGUgbW9zdAogIC8vIHBhcnQuCiAgSmVkLlBGID0ge307CgogIEplZC5QRi5wYXJzZSA9IGZ1bmN0aW9uICggcCApIHsKICAgIHZhciBwbHVyYWxfc3RyID0gSmVkLlBGLmV4dHJhY3RQbHVyYWxFeHByKCBwICk7CiAgICByZXR1cm4gSmVkLlBGLnBhcnNlci5wYXJzZS5jYWxsKEplZC5QRi5wYXJzZXIsIHBsdXJhbF9zdHIpOwogIH07CgogIEplZC5QRi5jb21waWxlID0gZnVuY3Rpb24gKCBwICkgewogICAgLy8gSGFuZGxlIHRydWVzIGFuZCBmYWxzZXMgYXMgMCBhbmQgMQogICAgZnVuY3Rpb24gaW1wbHkoIHZhbCApIHsKICAgICAgcmV0dXJuICh2YWwgPT09IHRydWUgPyAxIDogdmFsID8gdmFsIDogMCk7CiAgICB9CgogICAgdmFyIGFzdCA9IEplZC5QRi5wYXJzZSggcCApOwogICAgcmV0dXJuIGZ1bmN0aW9uICggbiApIHsKICAgICAgcmV0dXJuIGltcGx5KCBKZWQuUEYuaW50ZXJwcmV0ZXIoIGFzdCApKCBuICkgKTsKICAgIH07CiAgfTsKCiAgSmVkLlBGLmludGVycHJldGVyID0gZnVuY3Rpb24gKCBhc3QgKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKCBuICkgewogICAgICB2YXIgcmVzOwogICAgICBzd2l0Y2ggKCBhc3QudHlwZSApIHsKICAgICAgICBjYXNlICdHUk9VUCc6CiAgICAgICAgICByZXR1cm4gSmVkLlBGLmludGVycHJldGVyKCBhc3QuZXhwciApKCBuICk7CiAgICAgICAgY2FzZSAnVEVSTkFSWSc6CiAgICAgICAgICBpZiAoIEplZC5QRi5pbnRlcnByZXRlciggYXN0LmV4cHIgKSggbiApICkgewogICAgICAgICAgICByZXR1cm4gSmVkLlBGLmludGVycHJldGVyKCBhc3QudHJ1dGh5ICkoIG4gKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBKZWQuUEYuaW50ZXJwcmV0ZXIoIGFzdC5mYWxzZXkgKSggbiApOwogICAgICAgIGNhc2UgJ09SJzoKICAgICAgICAgIHJldHVybiBKZWQuUEYuaW50ZXJwcmV0ZXIoIGFzdC5sZWZ0ICkoIG4gKSB8fCBKZWQuUEYuaW50ZXJwcmV0ZXIoIGFzdC5yaWdodCApKCBuICk7CiAgICAgICAgY2FzZSAnQU5EJzoKICAgICAgICAgIHJldHVybiBKZWQuUEYuaW50ZXJwcmV0ZXIoIGFzdC5sZWZ0ICkoIG4gKSAmJiBKZWQuUEYuaW50ZXJwcmV0ZXIoIGFzdC5yaWdodCApKCBuICk7CiAgICAgICAgY2FzZSAnTFQnOgogICAgICAgICAgcmV0dXJuIEplZC5QRi5pbnRlcnByZXRlciggYXN0LmxlZnQgKSggbiApIDwgSmVkLlBGLmludGVycHJldGVyKCBhc3QucmlnaHQgKSggbiApOwogICAgICAgIGNhc2UgJ0dUJzoKICAgICAgICAgIHJldHVybiBKZWQuUEYuaW50ZXJwcmV0ZXIoIGFzdC5sZWZ0ICkoIG4gKSA+IEplZC5QRi5pbnRlcnByZXRlciggYXN0LnJpZ2h0ICkoIG4gKTsKICAgICAgICBjYXNlICdMVEUnOgogICAgICAgICAgcmV0dXJuIEplZC5QRi5pbnRlcnByZXRlciggYXN0LmxlZnQgKSggbiApIDw9IEplZC5QRi5pbnRlcnByZXRlciggYXN0LnJpZ2h0ICkoIG4gKTsKICAgICAgICBjYXNlICdHVEUnOgogICAgICAgICAgcmV0dXJuIEplZC5QRi5pbnRlcnByZXRlciggYXN0LmxlZnQgKSggbiApID49IEplZC5QRi5pbnRlcnByZXRlciggYXN0LnJpZ2h0ICkoIG4gKTsKICAgICAgICBjYXNlICdFUSc6CiAgICAgICAgICByZXR1cm4gSmVkLlBGLmludGVycHJldGVyKCBhc3QubGVmdCApKCBuICkgPT0gSmVkLlBGLmludGVycHJldGVyKCBhc3QucmlnaHQgKSggbiApOwogICAgICAgIGNhc2UgJ05FUSc6CiAgICAgICAgICByZXR1cm4gSmVkLlBGLmludGVycHJldGVyKCBhc3QubGVmdCApKCBuICkgIT0gSmVkLlBGLmludGVycHJldGVyKCBhc3QucmlnaHQgKSggbiApOwogICAgICAgIGNhc2UgJ01PRCc6CiAgICAgICAgICByZXR1cm4gSmVkLlBGLmludGVycHJldGVyKCBhc3QubGVmdCApKCBuICkgJSBKZWQuUEYuaW50ZXJwcmV0ZXIoIGFzdC5yaWdodCApKCBuICk7CiAgICAgICAgY2FzZSAnVkFSJzoKICAgICAgICAgIHJldHVybiBuOwogICAgICAgIGNhc2UgJ05VTSc6CiAgICAgICAgICByZXR1cm4gYXN0LnZhbDsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIFRva2VuIGZvdW5kLiIpOwogICAgICB9CiAgICB9OwogIH07CgogIEplZC5QRi5leHRyYWN0UGx1cmFsRXhwciA9IGZ1bmN0aW9uICggcCApIHsKICAgIC8vIHRyaW0gZmlyc3QKICAgIHAgPSBwLnJlcGxhY2UoL15cc1xzKi8sICcnKS5yZXBsYWNlKC9cc1xzKiQvLCAnJyk7CgogICAgaWYgKCEgLztccyokLy50ZXN0KHApKSB7CiAgICAgIHAgPSBwLmNvbmNhdCgnOycpOwogICAgfQoKICAgIHZhciBucGx1cmFsc19yZSA9IC9ucGx1cmFsc1w9KFxkKyk7LywKICAgICAgICBwbHVyYWxfcmUgPSAvcGx1cmFsXD0oLiopOy8sCiAgICAgICAgbnBsdXJhbHNfbWF0Y2hlcyA9IHAubWF0Y2goIG5wbHVyYWxzX3JlICksCiAgICAgICAgcmVzID0ge30sCiAgICAgICAgcGx1cmFsX21hdGNoZXM7CgogICAgLy8gRmluZCB0aGUgbnBsdXJhbHMgbnVtYmVyCiAgICBpZiAoIG5wbHVyYWxzX21hdGNoZXMubGVuZ3RoID4gMSApIHsKICAgICAgcmVzLm5wbHVyYWxzID0gbnBsdXJhbHNfbWF0Y2hlc1sxXTsKICAgIH0KICAgIGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ25wbHVyYWxzIG5vdCBmb3VuZCBpbiBwbHVyYWxfZm9ybXMgc3RyaW5nOiAnICsgcCApOwogICAgfQoKICAgIC8vIHJlbW92ZSB0aGF0IGRhdGEgdG8gZ2V0IHRvIHRoZSBmb3JtdWxhCiAgICBwID0gcC5yZXBsYWNlKCBucGx1cmFsc19yZSwgIiIgKTsKICAgIHBsdXJhbF9tYXRjaGVzID0gcC5tYXRjaCggcGx1cmFsX3JlICk7CgogICAgaWYgKCEoIHBsdXJhbF9tYXRjaGVzICYmIHBsdXJhbF9tYXRjaGVzLmxlbmd0aCA+IDEgKSApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdgcGx1cmFsYCBleHByZXNzaW9uIG5vdCBmb3VuZDogJyArIHApOwogICAgfQogICAgcmV0dXJuIHBsdXJhbF9tYXRjaGVzWyAxIF07CiAgfTsKCiAgLyogSmlzb24gZ2VuZXJhdGVkIHBhcnNlciAqLwogIEplZC5QRi5wYXJzZXIgPSAoZnVuY3Rpb24oKXsKCnZhciBwYXJzZXIgPSB7dHJhY2U6IGZ1bmN0aW9uIHRyYWNlKCkgeyB9LAp5eToge30sCnN5bWJvbHNfOiB7ImVycm9yIjoyLCJleHByZXNzaW9ucyI6MywiZSI6NCwiRU9GIjo1LCI/Ijo2LCI6Ijo3LCJ8fCI6OCwiJiYiOjksIjwiOjEwLCI8PSI6MTEsIj4iOjEyLCI+PSI6MTMsIiE9IjoxNCwiPT0iOjE1LCIlIjoxNiwiKCI6MTcsIikiOjE4LCJuIjoxOSwiTlVNQkVSIjoyMCwiJGFjY2VwdCI6MCwiJGVuZCI6MX0sCnRlcm1pbmFsc186IHsyOiJlcnJvciIsNToiRU9GIiw2OiI/Iiw3OiI6Iiw4OiJ8fCIsOToiJiYiLDEwOiI8IiwxMToiPD0iLDEyOiI+IiwxMzoiPj0iLDE0OiIhPSIsMTU6Ij09IiwxNjoiJSIsMTc6IigiLDE4OiIpIiwxOToibiIsMjA6Ik5VTUJFUiJ9LApwcm9kdWN0aW9uc186IFswLFszLDJdLFs0LDVdLFs0LDNdLFs0LDNdLFs0LDNdLFs0LDNdLFs0LDNdLFs0LDNdLFs0LDNdLFs0LDNdLFs0LDNdLFs0LDNdLFs0LDFdLFs0LDFdXSwKcGVyZm9ybUFjdGlvbjogZnVuY3Rpb24gYW5vbnltb3VzKHl5dGV4dCx5eWxlbmcseXlsaW5lbm8seXkseXlzdGF0ZSwkJCxfJCkgewoKdmFyICQwID0gJCQubGVuZ3RoIC0gMTsKc3dpdGNoICh5eXN0YXRlKSB7CmNhc2UgMTogcmV0dXJuIHsgdHlwZSA6ICdHUk9VUCcsIGV4cHI6ICQkWyQwLTFdIH07IApicmVhazsKY2FzZSAyOnRoaXMuJCA9IHsgdHlwZTogJ1RFUk5BUlknLCBleHByOiAkJFskMC00XSwgdHJ1dGh5IDogJCRbJDAtMl0sIGZhbHNleTogJCRbJDBdIH07IApicmVhazsKY2FzZSAzOnRoaXMuJCA9IHsgdHlwZTogIk9SIiwgbGVmdDogJCRbJDAtMl0sIHJpZ2h0OiAkJFskMF0gfTsKYnJlYWs7CmNhc2UgNDp0aGlzLiQgPSB7IHR5cGU6ICJBTkQiLCBsZWZ0OiAkJFskMC0yXSwgcmlnaHQ6ICQkWyQwXSB9OwpicmVhazsKY2FzZSA1OnRoaXMuJCA9IHsgdHlwZTogJ0xUJywgbGVmdDogJCRbJDAtMl0sIHJpZ2h0OiAkJFskMF0gfTsgCmJyZWFrOwpjYXNlIDY6dGhpcy4kID0geyB0eXBlOiAnTFRFJywgbGVmdDogJCRbJDAtMl0sIHJpZ2h0OiAkJFskMF0gfTsKYnJlYWs7CmNhc2UgNzp0aGlzLiQgPSB7IHR5cGU6ICdHVCcsIGxlZnQ6ICQkWyQwLTJdLCByaWdodDogJCRbJDBdIH07CmJyZWFrOwpjYXNlIDg6dGhpcy4kID0geyB0eXBlOiAnR1RFJywgbGVmdDogJCRbJDAtMl0sIHJpZ2h0OiAkJFskMF0gfTsKYnJlYWs7CmNhc2UgOTp0aGlzLiQgPSB7IHR5cGU6ICdORVEnLCBsZWZ0OiAkJFskMC0yXSwgcmlnaHQ6ICQkWyQwXSB9OwpicmVhazsKY2FzZSAxMDp0aGlzLiQgPSB7IHR5cGU6ICdFUScsIGxlZnQ6ICQkWyQwLTJdLCByaWdodDogJCRbJDBdIH07CmJyZWFrOwpjYXNlIDExOnRoaXMuJCA9IHsgdHlwZTogJ01PRCcsIGxlZnQ6ICQkWyQwLTJdLCByaWdodDogJCRbJDBdIH07CmJyZWFrOwpjYXNlIDEyOnRoaXMuJCA9IHsgdHlwZTogJ0dST1VQJywgZXhwcjogJCRbJDAtMV0gfTsgCmJyZWFrOwpjYXNlIDEzOnRoaXMuJCA9IHsgdHlwZTogJ1ZBUicgfTsgCmJyZWFrOwpjYXNlIDE0OnRoaXMuJCA9IHsgdHlwZTogJ05VTScsIHZhbDogTnVtYmVyKHl5dGV4dCkgfTsgCmJyZWFrOwp9Cn0sCnRhYmxlOiBbezM6MSw0OjIsMTc6WzEsM10sMTk6WzEsNF0sMjA6WzEsNV19LHsxOlszXX0sezU6WzEsNl0sNjpbMSw3XSw4OlsxLDhdLDk6WzEsOV0sMTA6WzEsMTBdLDExOlsxLDExXSwxMjpbMSwxMl0sMTM6WzEsMTNdLDE0OlsxLDE0XSwxNTpbMSwxNV0sMTY6WzEsMTZdfSx7NDoxNywxNzpbMSwzXSwxOTpbMSw0XSwyMDpbMSw1XX0sezU6WzIsMTNdLDY6WzIsMTNdLDc6WzIsMTNdLDg6WzIsMTNdLDk6WzIsMTNdLDEwOlsyLDEzXSwxMTpbMiwxM10sMTI6WzIsMTNdLDEzOlsyLDEzXSwxNDpbMiwxM10sMTU6WzIsMTNdLDE2OlsyLDEzXSwxODpbMiwxM119LHs1OlsyLDE0XSw2OlsyLDE0XSw3OlsyLDE0XSw4OlsyLDE0XSw5OlsyLDE0XSwxMDpbMiwxNF0sMTE6WzIsMTRdLDEyOlsyLDE0XSwxMzpbMiwxNF0sMTQ6WzIsMTRdLDE1OlsyLDE0XSwxNjpbMiwxNF0sMTg6WzIsMTRdfSx7MTpbMiwxXX0sezQ6MTgsMTc6WzEsM10sMTk6WzEsNF0sMjA6WzEsNV19LHs0OjE5LDE3OlsxLDNdLDE5OlsxLDRdLDIwOlsxLDVdfSx7NDoyMCwxNzpbMSwzXSwxOTpbMSw0XSwyMDpbMSw1XX0sezQ6MjEsMTc6WzEsM10sMTk6WzEsNF0sMjA6WzEsNV19LHs0OjIyLDE3OlsxLDNdLDE5OlsxLDRdLDIwOlsxLDVdfSx7NDoyMywxNzpbMSwzXSwxOTpbMSw0XSwyMDpbMSw1XX0sezQ6MjQsMTc6WzEsM10sMTk6WzEsNF0sMjA6WzEsNV19LHs0OjI1LDE3OlsxLDNdLDE5OlsxLDRdLDIwOlsxLDVdfSx7NDoyNiwxNzpbMSwzXSwxOTpbMSw0XSwyMDpbMSw1XX0sezQ6MjcsMTc6WzEsM10sMTk6WzEsNF0sMjA6WzEsNV19LHs2OlsxLDddLDg6WzEsOF0sOTpbMSw5XSwxMDpbMSwxMF0sMTE6WzEsMTFdLDEyOlsxLDEyXSwxMzpbMSwxM10sMTQ6WzEsMTRdLDE1OlsxLDE1XSwxNjpbMSwxNl0sMTg6WzEsMjhdfSx7NjpbMSw3XSw3OlsxLDI5XSw4OlsxLDhdLDk6WzEsOV0sMTA6WzEsMTBdLDExOlsxLDExXSwxMjpbMSwxMl0sMTM6WzEsMTNdLDE0OlsxLDE0XSwxNTpbMSwxNV0sMTY6WzEsMTZdfSx7NTpbMiwzXSw2OlsyLDNdLDc6WzIsM10sODpbMiwzXSw5OlsxLDldLDEwOlsxLDEwXSwxMTpbMSwxMV0sMTI6WzEsMTJdLDEzOlsxLDEzXSwxNDpbMSwxNF0sMTU6WzEsMTVdLDE2OlsxLDE2XSwxODpbMiwzXX0sezU6WzIsNF0sNjpbMiw0XSw3OlsyLDRdLDg6WzIsNF0sOTpbMiw0XSwxMDpbMSwxMF0sMTE6WzEsMTFdLDEyOlsxLDEyXSwxMzpbMSwxM10sMTQ6WzEsMTRdLDE1OlsxLDE1XSwxNjpbMSwxNl0sMTg6WzIsNF19LHs1OlsyLDVdLDY6WzIsNV0sNzpbMiw1XSw4OlsyLDVdLDk6WzIsNV0sMTA6WzIsNV0sMTE6WzIsNV0sMTI6WzIsNV0sMTM6WzIsNV0sMTQ6WzIsNV0sMTU6WzIsNV0sMTY6WzEsMTZdLDE4OlsyLDVdfSx7NTpbMiw2XSw2OlsyLDZdLDc6WzIsNl0sODpbMiw2XSw5OlsyLDZdLDEwOlsyLDZdLDExOlsyLDZdLDEyOlsyLDZdLDEzOlsyLDZdLDE0OlsyLDZdLDE1OlsyLDZdLDE2OlsxLDE2XSwxODpbMiw2XX0sezU6WzIsN10sNjpbMiw3XSw3OlsyLDddLDg6WzIsN10sOTpbMiw3XSwxMDpbMiw3XSwxMTpbMiw3XSwxMjpbMiw3XSwxMzpbMiw3XSwxNDpbMiw3XSwxNTpbMiw3XSwxNjpbMSwxNl0sMTg6WzIsN119LHs1OlsyLDhdLDY6WzIsOF0sNzpbMiw4XSw4OlsyLDhdLDk6WzIsOF0sMTA6WzIsOF0sMTE6WzIsOF0sMTI6WzIsOF0sMTM6WzIsOF0sMTQ6WzIsOF0sMTU6WzIsOF0sMTY6WzEsMTZdLDE4OlsyLDhdfSx7NTpbMiw5XSw2OlsyLDldLDc6WzIsOV0sODpbMiw5XSw5OlsyLDldLDEwOlsyLDldLDExOlsyLDldLDEyOlsyLDldLDEzOlsyLDldLDE0OlsyLDldLDE1OlsyLDldLDE2OlsxLDE2XSwxODpbMiw5XX0sezU6WzIsMTBdLDY6WzIsMTBdLDc6WzIsMTBdLDg6WzIsMTBdLDk6WzIsMTBdLDEwOlsyLDEwXSwxMTpbMiwxMF0sMTI6WzIsMTBdLDEzOlsyLDEwXSwxNDpbMiwxMF0sMTU6WzIsMTBdLDE2OlsxLDE2XSwxODpbMiwxMF19LHs1OlsyLDExXSw2OlsyLDExXSw3OlsyLDExXSw4OlsyLDExXSw5OlsyLDExXSwxMDpbMiwxMV0sMTE6WzIsMTFdLDEyOlsyLDExXSwxMzpbMiwxMV0sMTQ6WzIsMTFdLDE1OlsyLDExXSwxNjpbMiwxMV0sMTg6WzIsMTFdfSx7NTpbMiwxMl0sNjpbMiwxMl0sNzpbMiwxMl0sODpbMiwxMl0sOTpbMiwxMl0sMTA6WzIsMTJdLDExOlsyLDEyXSwxMjpbMiwxMl0sMTM6WzIsMTJdLDE0OlsyLDEyXSwxNTpbMiwxMl0sMTY6WzIsMTJdLDE4OlsyLDEyXX0sezQ6MzAsMTc6WzEsM10sMTk6WzEsNF0sMjA6WzEsNV19LHs1OlsyLDJdLDY6WzEsN10sNzpbMiwyXSw4OlsxLDhdLDk6WzEsOV0sMTA6WzEsMTBdLDExOlsxLDExXSwxMjpbMSwxMl0sMTM6WzEsMTNdLDE0OlsxLDE0XSwxNTpbMSwxNV0sMTY6WzEsMTZdLDE4OlsyLDJdfV0sCmRlZmF1bHRBY3Rpb25zOiB7NjpbMiwxXX0sCnBhcnNlRXJyb3I6IGZ1bmN0aW9uIHBhcnNlRXJyb3Ioc3RyLCBoYXNoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3Ioc3RyKTsKfSwKcGFyc2U6IGZ1bmN0aW9uIHBhcnNlKGlucHV0KSB7CiAgICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgICAgc3RhY2sgPSBbMF0sCiAgICAgICAgdnN0YWNrID0gW251bGxdLCAvLyBzZW1hbnRpYyB2YWx1ZSBzdGFjawogICAgICAgIGxzdGFjayA9IFtdLCAvLyBsb2NhdGlvbiBzdGFjawogICAgICAgIHRhYmxlID0gdGhpcy50YWJsZSwKICAgICAgICB5eXRleHQgPSAnJywKICAgICAgICB5eWxpbmVubyA9IDAsCiAgICAgICAgeXlsZW5nID0gMCwKICAgICAgICByZWNvdmVyaW5nID0gMCwKICAgICAgICBURVJST1IgPSAyLAogICAgICAgIEVPRiA9IDE7CgogICAgLy90aGlzLnJlZHVjdGlvbkNvdW50ID0gdGhpcy5zaGlmdENvdW50ID0gMDsKCiAgICB0aGlzLmxleGVyLnNldElucHV0KGlucHV0KTsKICAgIHRoaXMubGV4ZXIueXkgPSB0aGlzLnl5OwogICAgdGhpcy55eS5sZXhlciA9IHRoaXMubGV4ZXI7CiAgICBpZiAodHlwZW9mIHRoaXMubGV4ZXIueXlsbG9jID09ICd1bmRlZmluZWQnKQogICAgICAgIHRoaXMubGV4ZXIueXlsbG9jID0ge307CiAgICB2YXIgeXlsb2MgPSB0aGlzLmxleGVyLnl5bGxvYzsKICAgIGxzdGFjay5wdXNoKHl5bG9jKTsKCiAgICBpZiAodHlwZW9mIHRoaXMueXkucGFyc2VFcnJvciA9PT0gJ2Z1bmN0aW9uJykKICAgICAgICB0aGlzLnBhcnNlRXJyb3IgPSB0aGlzLnl5LnBhcnNlRXJyb3I7CgogICAgZnVuY3Rpb24gcG9wU3RhY2sgKG4pIHsKICAgICAgICBzdGFjay5sZW5ndGggPSBzdGFjay5sZW5ndGggLSAyKm47CiAgICAgICAgdnN0YWNrLmxlbmd0aCA9IHZzdGFjay5sZW5ndGggLSBuOwogICAgICAgIGxzdGFjay5sZW5ndGggPSBsc3RhY2subGVuZ3RoIC0gbjsKICAgIH0KCiAgICBmdW5jdGlvbiBsZXgoKSB7CiAgICAgICAgdmFyIHRva2VuOwogICAgICAgIHRva2VuID0gc2VsZi5sZXhlci5sZXgoKSB8fCAxOyAvLyAkZW5kID0gMQogICAgICAgIC8vIGlmIHRva2VuIGlzbid0IGl0cyBudW1lcmljIHZhbHVlLCBjb252ZXJ0CiAgICAgICAgaWYgKHR5cGVvZiB0b2tlbiAhPT0gJ251bWJlcicpIHsKICAgICAgICAgICAgdG9rZW4gPSBzZWxmLnN5bWJvbHNfW3Rva2VuXSB8fCB0b2tlbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRva2VuOwogICAgfQoKICAgIHZhciBzeW1ib2wsIHByZUVycm9yU3ltYm9sLCBzdGF0ZSwgYWN0aW9uLCBhLCByLCB5eXZhbD17fSxwLGxlbixuZXdTdGF0ZSwgZXhwZWN0ZWQ7CiAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIC8vIHJldHJlaXZlIHN0YXRlIG51bWJlciBmcm9tIHRvcCBvZiBzdGFjawogICAgICAgIHN0YXRlID0gc3RhY2tbc3RhY2subGVuZ3RoLTFdOwoKICAgICAgICAvLyB1c2UgZGVmYXVsdCBhY3Rpb25zIGlmIGF2YWlsYWJsZQogICAgICAgIGlmICh0aGlzLmRlZmF1bHRBY3Rpb25zW3N0YXRlXSkgewogICAgICAgICAgICBhY3Rpb24gPSB0aGlzLmRlZmF1bHRBY3Rpb25zW3N0YXRlXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoc3ltYm9sID09IG51bGwpCiAgICAgICAgICAgICAgICBzeW1ib2wgPSBsZXgoKTsKICAgICAgICAgICAgLy8gcmVhZCBhY3Rpb24gZm9yIGN1cnJlbnQgc3RhdGUgYW5kIGZpcnN0IGlucHV0CiAgICAgICAgICAgIGFjdGlvbiA9IHRhYmxlW3N0YXRlXSAmJiB0YWJsZVtzdGF0ZV1bc3ltYm9sXTsKICAgICAgICB9CgogICAgICAgIC8vIGhhbmRsZSBwYXJzZSBlcnJvcgogICAgICAgIF9oYW5kbGVfZXJyb3I6CiAgICAgICAgaWYgKHR5cGVvZiBhY3Rpb24gPT09ICd1bmRlZmluZWQnIHx8ICFhY3Rpb24ubGVuZ3RoIHx8ICFhY3Rpb25bMF0pIHsKCiAgICAgICAgICAgIGlmICghcmVjb3ZlcmluZykgewogICAgICAgICAgICAgICAgLy8gUmVwb3J0IGVycm9yCiAgICAgICAgICAgICAgICBleHBlY3RlZCA9IFtdOwogICAgICAgICAgICAgICAgZm9yIChwIGluIHRhYmxlW3N0YXRlXSkgaWYgKHRoaXMudGVybWluYWxzX1twXSAmJiBwID4gMikgewogICAgICAgICAgICAgICAgICAgIGV4cGVjdGVkLnB1c2goIiciK3RoaXMudGVybWluYWxzX1twXSsiJyIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGVyclN0ciA9ICcnOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubGV4ZXIuc2hvd1Bvc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyU3RyID0gJ1BhcnNlIGVycm9yIG9uIGxpbmUgJysoeXlsaW5lbm8rMSkrIjpcbiIrdGhpcy5sZXhlci5zaG93UG9zaXRpb24oKSsiXG5FeHBlY3RpbmcgIitleHBlY3RlZC5qb2luKCcsICcpICsgIiwgZ290ICciICsgdGhpcy50ZXJtaW5hbHNfW3N5bWJvbF0rICInIjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZXJyU3RyID0gJ1BhcnNlIGVycm9yIG9uIGxpbmUgJysoeXlsaW5lbm8rMSkrIjogVW5leHBlY3RlZCAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChzeW1ib2wgPT0gMSAvKkVPRiovID8gImVuZCBvZiBpbnB1dCIgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKCInIisodGhpcy50ZXJtaW5hbHNfW3N5bWJvbF0gfHwgc3ltYm9sKSsiJyIpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMucGFyc2VFcnJvcihlcnJTdHIsCiAgICAgICAgICAgICAgICAgICAge3RleHQ6IHRoaXMubGV4ZXIubWF0Y2gsIHRva2VuOiB0aGlzLnRlcm1pbmFsc19bc3ltYm9sXSB8fCBzeW1ib2wsIGxpbmU6IHRoaXMubGV4ZXIueXlsaW5lbm8sIGxvYzogeXlsb2MsIGV4cGVjdGVkOiBleHBlY3RlZH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBqdXN0IHJlY292ZXJlZCBmcm9tIGFub3RoZXIgZXJyb3IKICAgICAgICAgICAgaWYgKHJlY292ZXJpbmcgPT0gMykgewogICAgICAgICAgICAgICAgaWYgKHN5bWJvbCA9PSBFT0YpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyU3RyIHx8ICdQYXJzaW5nIGhhbHRlZC4nKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBkaXNjYXJkIGN1cnJlbnQgbG9va2FoZWFkIGFuZCBncmFiIGFub3RoZXIKICAgICAgICAgICAgICAgIHl5bGVuZyA9IHRoaXMubGV4ZXIueXlsZW5nOwogICAgICAgICAgICAgICAgeXl0ZXh0ID0gdGhpcy5sZXhlci55eXRleHQ7CiAgICAgICAgICAgICAgICB5eWxpbmVubyA9IHRoaXMubGV4ZXIueXlsaW5lbm87CiAgICAgICAgICAgICAgICB5eWxvYyA9IHRoaXMubGV4ZXIueXlsbG9jOwogICAgICAgICAgICAgICAgc3ltYm9sID0gbGV4KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHRyeSB0byByZWNvdmVyIGZyb20gZXJyb3IKICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICAgIC8vIGNoZWNrIGZvciBlcnJvciByZWNvdmVyeSBydWxlIGluIHRoaXMgc3RhdGUKICAgICAgICAgICAgICAgIGlmICgoVEVSUk9SLnRvU3RyaW5nKCkpIGluIHRhYmxlW3N0YXRlXSkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlID09IDApIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyU3RyIHx8ICdQYXJzaW5nIGhhbHRlZC4nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBvcFN0YWNrKDEpOwogICAgICAgICAgICAgICAgc3RhdGUgPSBzdGFja1tzdGFjay5sZW5ndGgtMV07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHByZUVycm9yU3ltYm9sID0gc3ltYm9sOyAvLyBzYXZlIHRoZSBsb29rYWhlYWQgdG9rZW4KICAgICAgICAgICAgc3ltYm9sID0gVEVSUk9SOyAgICAgICAgIC8vIGluc2VydCBnZW5lcmljIGVycm9yIHN5bWJvbCBhcyBuZXcgbG9va2FoZWFkCiAgICAgICAgICAgIHN0YXRlID0gc3RhY2tbc3RhY2subGVuZ3RoLTFdOwogICAgICAgICAgICBhY3Rpb24gPSB0YWJsZVtzdGF0ZV0gJiYgdGFibGVbc3RhdGVdW1RFUlJPUl07CiAgICAgICAgICAgIHJlY292ZXJpbmcgPSAzOyAvLyBhbGxvdyAzIHJlYWwgc3ltYm9scyB0byBiZSBzaGlmdGVkIGJlZm9yZSByZXBvcnRpbmcgYSBuZXcgZXJyb3IKICAgICAgICB9CgogICAgICAgIC8vIHRoaXMgc2hvdWxkbid0IGhhcHBlbiwgdW5sZXNzIHJlc29sdmUgZGVmYXVsdHMgYXJlIG9mZgogICAgICAgIGlmIChhY3Rpb25bMF0gaW5zdGFuY2VvZiBBcnJheSAmJiBhY3Rpb24ubGVuZ3RoID4gMSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1BhcnNlIEVycm9yOiBtdWx0aXBsZSBhY3Rpb25zIHBvc3NpYmxlIGF0IHN0YXRlOiAnK3N0YXRlKycsIHRva2VuOiAnK3N5bWJvbCk7CiAgICAgICAgfQoKICAgICAgICBzd2l0Y2ggKGFjdGlvblswXSkgewoKICAgICAgICAgICAgY2FzZSAxOiAvLyBzaGlmdAogICAgICAgICAgICAgICAgLy90aGlzLnNoaWZ0Q291bnQrKzsKCiAgICAgICAgICAgICAgICBzdGFjay5wdXNoKHN5bWJvbCk7CiAgICAgICAgICAgICAgICB2c3RhY2sucHVzaCh0aGlzLmxleGVyLnl5dGV4dCk7CiAgICAgICAgICAgICAgICBsc3RhY2sucHVzaCh0aGlzLmxleGVyLnl5bGxvYyk7CiAgICAgICAgICAgICAgICBzdGFjay5wdXNoKGFjdGlvblsxXSk7IC8vIHB1c2ggc3RhdGUKICAgICAgICAgICAgICAgIHN5bWJvbCA9IG51bGw7CiAgICAgICAgICAgICAgICBpZiAoIXByZUVycm9yU3ltYm9sKSB7IC8vIG5vcm1hbCBleGVjdXRpb24vbm8gZXJyb3IKICAgICAgICAgICAgICAgICAgICB5eWxlbmcgPSB0aGlzLmxleGVyLnl5bGVuZzsKICAgICAgICAgICAgICAgICAgICB5eXRleHQgPSB0aGlzLmxleGVyLnl5dGV4dDsKICAgICAgICAgICAgICAgICAgICB5eWxpbmVubyA9IHRoaXMubGV4ZXIueXlsaW5lbm87CiAgICAgICAgICAgICAgICAgICAgeXlsb2MgPSB0aGlzLmxleGVyLnl5bGxvYzsKICAgICAgICAgICAgICAgICAgICBpZiAocmVjb3ZlcmluZyA+IDApCiAgICAgICAgICAgICAgICAgICAgICAgIHJlY292ZXJpbmctLTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8vIGVycm9yIGp1c3Qgb2NjdXJyZWQsIHJlc3VtZSBvbGQgbG9va2FoZWFkIGYvIGJlZm9yZSBlcnJvcgogICAgICAgICAgICAgICAgICAgIHN5bWJvbCA9IHByZUVycm9yU3ltYm9sOwogICAgICAgICAgICAgICAgICAgIHByZUVycm9yU3ltYm9sID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAyOiAvLyByZWR1Y2UKICAgICAgICAgICAgICAgIC8vdGhpcy5yZWR1Y3Rpb25Db3VudCsrOwoKICAgICAgICAgICAgICAgIGxlbiA9IHRoaXMucHJvZHVjdGlvbnNfW2FjdGlvblsxXV1bMV07CgogICAgICAgICAgICAgICAgLy8gcGVyZm9ybSBzZW1hbnRpYyBhY3Rpb24KICAgICAgICAgICAgICAgIHl5dmFsLiQgPSB2c3RhY2tbdnN0YWNrLmxlbmd0aC1sZW5dOyAvLyBkZWZhdWx0IHRvICQkID0gJDEKICAgICAgICAgICAgICAgIC8vIGRlZmF1bHQgbG9jYXRpb24sIHVzZXMgZmlyc3QgdG9rZW4gZm9yIGZpcnN0cywgbGFzdCBmb3IgbGFzdHMKICAgICAgICAgICAgICAgIHl5dmFsLl8kID0gewogICAgICAgICAgICAgICAgICAgIGZpcnN0X2xpbmU6IGxzdGFja1tsc3RhY2subGVuZ3RoLShsZW58fDEpXS5maXJzdF9saW5lLAogICAgICAgICAgICAgICAgICAgIGxhc3RfbGluZTogbHN0YWNrW2xzdGFjay5sZW5ndGgtMV0ubGFzdF9saW5lLAogICAgICAgICAgICAgICAgICAgIGZpcnN0X2NvbHVtbjogbHN0YWNrW2xzdGFjay5sZW5ndGgtKGxlbnx8MSldLmZpcnN0X2NvbHVtbiwKICAgICAgICAgICAgICAgICAgICBsYXN0X2NvbHVtbjogbHN0YWNrW2xzdGFjay5sZW5ndGgtMV0ubGFzdF9jb2x1bW4KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICByID0gdGhpcy5wZXJmb3JtQWN0aW9uLmNhbGwoeXl2YWwsIHl5dGV4dCwgeXlsZW5nLCB5eWxpbmVubywgdGhpcy55eSwgYWN0aW9uWzFdLCB2c3RhY2ssIGxzdGFjayk7CgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiByOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHBvcCBvZmYgc3RhY2sKICAgICAgICAgICAgICAgIGlmIChsZW4pIHsKICAgICAgICAgICAgICAgICAgICBzdGFjayA9IHN0YWNrLnNsaWNlKDAsLTEqbGVuKjIpOwogICAgICAgICAgICAgICAgICAgIHZzdGFjayA9IHZzdGFjay5zbGljZSgwLCAtMSpsZW4pOwogICAgICAgICAgICAgICAgICAgIGxzdGFjayA9IGxzdGFjay5zbGljZSgwLCAtMSpsZW4pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHN0YWNrLnB1c2godGhpcy5wcm9kdWN0aW9uc19bYWN0aW9uWzFdXVswXSk7ICAgIC8vIHB1c2ggbm9udGVybWluYWwgKHJlZHVjZSkKICAgICAgICAgICAgICAgIHZzdGFjay5wdXNoKHl5dmFsLiQpOwogICAgICAgICAgICAgICAgbHN0YWNrLnB1c2goeXl2YWwuXyQpOwogICAgICAgICAgICAgICAgLy8gZ290byBuZXcgc3RhdGUgPSB0YWJsZVtTVEFURV1bTk9OVEVSTUlOQUxdCiAgICAgICAgICAgICAgICBuZXdTdGF0ZSA9IHRhYmxlW3N0YWNrW3N0YWNrLmxlbmd0aC0yXV1bc3RhY2tbc3RhY2subGVuZ3RoLTFdXTsKICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gobmV3U3RhdGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlIDM6IC8vIGFjY2VwdAogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKfX07LyogSmlzb24gZ2VuZXJhdGVkIGxleGVyICovCnZhciBsZXhlciA9IChmdW5jdGlvbigpewoKdmFyIGxleGVyID0gKHtFT0Y6MSwKcGFyc2VFcnJvcjpmdW5jdGlvbiBwYXJzZUVycm9yKHN0ciwgaGFzaCkgewogICAgICAgIGlmICh0aGlzLnl5LnBhcnNlRXJyb3IpIHsKICAgICAgICAgICAgdGhpcy55eS5wYXJzZUVycm9yKHN0ciwgaGFzaCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHN0cik7CiAgICAgICAgfQogICAgfSwKc2V0SW5wdXQ6ZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgdGhpcy5faW5wdXQgPSBpbnB1dDsKICAgICAgICB0aGlzLl9tb3JlID0gdGhpcy5fbGVzcyA9IHRoaXMuZG9uZSA9IGZhbHNlOwogICAgICAgIHRoaXMueXlsaW5lbm8gPSB0aGlzLnl5bGVuZyA9IDA7CiAgICAgICAgdGhpcy55eXRleHQgPSB0aGlzLm1hdGNoZWQgPSB0aGlzLm1hdGNoID0gJyc7CiAgICAgICAgdGhpcy5jb25kaXRpb25TdGFjayA9IFsnSU5JVElBTCddOwogICAgICAgIHRoaXMueXlsbG9jID0ge2ZpcnN0X2xpbmU6MSxmaXJzdF9jb2x1bW46MCxsYXN0X2xpbmU6MSxsYXN0X2NvbHVtbjowfTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCmlucHV0OmZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgY2ggPSB0aGlzLl9pbnB1dFswXTsKICAgICAgICB0aGlzLnl5dGV4dCs9Y2g7CiAgICAgICAgdGhpcy55eWxlbmcrKzsKICAgICAgICB0aGlzLm1hdGNoKz1jaDsKICAgICAgICB0aGlzLm1hdGNoZWQrPWNoOwogICAgICAgIHZhciBsaW5lcyA9IGNoLm1hdGNoKC9cbi8pOwogICAgICAgIGlmIChsaW5lcykgdGhpcy55eWxpbmVubysrOwogICAgICAgIHRoaXMuX2lucHV0ID0gdGhpcy5faW5wdXQuc2xpY2UoMSk7CiAgICAgICAgcmV0dXJuIGNoOwogICAgfSwKdW5wdXQ6ZnVuY3Rpb24gKGNoKSB7CiAgICAgICAgdGhpcy5faW5wdXQgPSBjaCArIHRoaXMuX2lucHV0OwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKbW9yZTpmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5fbW9yZSA9IHRydWU7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LApwYXN0SW5wdXQ6ZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBwYXN0ID0gdGhpcy5tYXRjaGVkLnN1YnN0cigwLCB0aGlzLm1hdGNoZWQubGVuZ3RoIC0gdGhpcy5tYXRjaC5sZW5ndGgpOwogICAgICAgIHJldHVybiAocGFzdC5sZW5ndGggPiAyMCA/ICcuLi4nOicnKSArIHBhc3Quc3Vic3RyKC0yMCkucmVwbGFjZSgvXG4vZywgIiIpOwogICAgfSwKdXBjb21pbmdJbnB1dDpmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIG5leHQgPSB0aGlzLm1hdGNoOwogICAgICAgIGlmIChuZXh0Lmxlbmd0aCA8IDIwKSB7CiAgICAgICAgICAgIG5leHQgKz0gdGhpcy5faW5wdXQuc3Vic3RyKDAsIDIwLW5leHQubGVuZ3RoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIChuZXh0LnN1YnN0cigwLDIwKSsobmV4dC5sZW5ndGggPiAyMCA/ICcuLi4nOicnKSkucmVwbGFjZSgvXG4vZywgIiIpOwogICAgfSwKc2hvd1Bvc2l0aW9uOmZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgcHJlID0gdGhpcy5wYXN0SW5wdXQoKTsKICAgICAgICB2YXIgYyA9IG5ldyBBcnJheShwcmUubGVuZ3RoICsgMSkuam9pbigiLSIpOwogICAgICAgIHJldHVybiBwcmUgKyB0aGlzLnVwY29taW5nSW5wdXQoKSArICJcbiIgKyBjKyJeIjsKICAgIH0sCm5leHQ6ZnVuY3Rpb24gKCkgewogICAgICAgIGlmICh0aGlzLmRvbmUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuRU9GOwogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuX2lucHV0KSB0aGlzLmRvbmUgPSB0cnVlOwoKICAgICAgICB2YXIgdG9rZW4sCiAgICAgICAgICAgIG1hdGNoLAogICAgICAgICAgICBjb2wsCiAgICAgICAgICAgIGxpbmVzOwogICAgICAgIGlmICghdGhpcy5fbW9yZSkgewogICAgICAgICAgICB0aGlzLnl5dGV4dCA9ICcnOwogICAgICAgICAgICB0aGlzLm1hdGNoID0gJyc7CiAgICAgICAgfQogICAgICAgIHZhciBydWxlcyA9IHRoaXMuX2N1cnJlbnRSdWxlcygpOwogICAgICAgIGZvciAodmFyIGk9MDtpIDwgcnVsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgbWF0Y2ggPSB0aGlzLl9pbnB1dC5tYXRjaCh0aGlzLnJ1bGVzW3J1bGVzW2ldXSk7CiAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgICAgbGluZXMgPSBtYXRjaFswXS5tYXRjaCgvXG4uKi9nKTsKICAgICAgICAgICAgICAgIGlmIChsaW5lcykgdGhpcy55eWxpbmVubyArPSBsaW5lcy5sZW5ndGg7CiAgICAgICAgICAgICAgICB0aGlzLnl5bGxvYyA9IHtmaXJzdF9saW5lOiB0aGlzLnl5bGxvYy5sYXN0X2xpbmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0X2xpbmU6IHRoaXMueXlsaW5lbm8rMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0X2NvbHVtbjogdGhpcy55eWxsb2MubGFzdF9jb2x1bW4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0X2NvbHVtbjogbGluZXMgPyBsaW5lc1tsaW5lcy5sZW5ndGgtMV0ubGVuZ3RoLTEgOiB0aGlzLnl5bGxvYy5sYXN0X2NvbHVtbiArIG1hdGNoWzBdLmxlbmd0aH0KICAgICAgICAgICAgICAgIHRoaXMueXl0ZXh0ICs9IG1hdGNoWzBdOwogICAgICAgICAgICAgICAgdGhpcy5tYXRjaCArPSBtYXRjaFswXTsKICAgICAgICAgICAgICAgIHRoaXMubWF0Y2hlcyA9IG1hdGNoOwogICAgICAgICAgICAgICAgdGhpcy55eWxlbmcgPSB0aGlzLnl5dGV4dC5sZW5ndGg7CiAgICAgICAgICAgICAgICB0aGlzLl9tb3JlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLl9pbnB1dCA9IHRoaXMuX2lucHV0LnNsaWNlKG1hdGNoWzBdLmxlbmd0aCk7CiAgICAgICAgICAgICAgICB0aGlzLm1hdGNoZWQgKz0gbWF0Y2hbMF07CiAgICAgICAgICAgICAgICB0b2tlbiA9IHRoaXMucGVyZm9ybUFjdGlvbi5jYWxsKHRoaXMsIHRoaXMueXksIHRoaXMsIHJ1bGVzW2ldLHRoaXMuY29uZGl0aW9uU3RhY2tbdGhpcy5jb25kaXRpb25TdGFjay5sZW5ndGgtMV0pOwogICAgICAgICAgICAgICAgaWYgKHRva2VuKSByZXR1cm4gdG9rZW47CiAgICAgICAgICAgICAgICBlbHNlIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5faW5wdXQgPT09ICIiKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLkVPRjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnBhcnNlRXJyb3IoJ0xleGljYWwgZXJyb3Igb24gbGluZSAnKyh0aGlzLnl5bGluZW5vKzEpKycuIFVucmVjb2duaXplZCB0ZXh0LlxuJyt0aGlzLnNob3dQb3NpdGlvbigpLCAKICAgICAgICAgICAgICAgICAgICB7dGV4dDogIiIsIHRva2VuOiBudWxsLCBsaW5lOiB0aGlzLnl5bGluZW5vfSk7CiAgICAgICAgfQogICAgfSwKbGV4OmZ1bmN0aW9uIGxleCgpIHsKICAgICAgICB2YXIgciA9IHRoaXMubmV4dCgpOwogICAgICAgIGlmICh0eXBlb2YgciAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGV4KCk7CiAgICAgICAgfQogICAgfSwKYmVnaW46ZnVuY3Rpb24gYmVnaW4oY29uZGl0aW9uKSB7CiAgICAgICAgdGhpcy5jb25kaXRpb25TdGFjay5wdXNoKGNvbmRpdGlvbik7CiAgICB9LApwb3BTdGF0ZTpmdW5jdGlvbiBwb3BTdGF0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25kaXRpb25TdGFjay5wb3AoKTsKICAgIH0sCl9jdXJyZW50UnVsZXM6ZnVuY3Rpb24gX2N1cnJlbnRSdWxlcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25kaXRpb25zW3RoaXMuY29uZGl0aW9uU3RhY2tbdGhpcy5jb25kaXRpb25TdGFjay5sZW5ndGgtMV1dLnJ1bGVzOwogICAgfSwKdG9wU3RhdGU6ZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmNvbmRpdGlvblN0YWNrW3RoaXMuY29uZGl0aW9uU3RhY2subGVuZ3RoLTJdOwogICAgfSwKcHVzaFN0YXRlOmZ1bmN0aW9uIGJlZ2luKGNvbmRpdGlvbikgewogICAgICAgIHRoaXMuYmVnaW4oY29uZGl0aW9uKTsKICAgIH19KTsKbGV4ZXIucGVyZm9ybUFjdGlvbiA9IGZ1bmN0aW9uIGFub255bW91cyh5eSx5eV8sJGF2b2lkaW5nX25hbWVfY29sbGlzaW9ucyxZWV9TVEFSVCkgewoKdmFyIFlZU1RBVEU9WVlfU1RBUlQ7CnN3aXRjaCgkYXZvaWRpbmdfbmFtZV9jb2xsaXNpb25zKSB7CmNhc2UgMDovKiBza2lwIHdoaXRlc3BhY2UgKi8KYnJlYWs7CmNhc2UgMTpyZXR1cm4gMjAKYnJlYWs7CmNhc2UgMjpyZXR1cm4gMTkKYnJlYWs7CmNhc2UgMzpyZXR1cm4gOApicmVhazsKY2FzZSA0OnJldHVybiA5CmJyZWFrOwpjYXNlIDU6cmV0dXJuIDYKYnJlYWs7CmNhc2UgNjpyZXR1cm4gNwpicmVhazsKY2FzZSA3OnJldHVybiAxMQpicmVhazsKY2FzZSA4OnJldHVybiAxMwpicmVhazsKY2FzZSA5OnJldHVybiAxMApicmVhazsKY2FzZSAxMDpyZXR1cm4gMTIKYnJlYWs7CmNhc2UgMTE6cmV0dXJuIDE0CmJyZWFrOwpjYXNlIDEyOnJldHVybiAxNQpicmVhazsKY2FzZSAxMzpyZXR1cm4gMTYKYnJlYWs7CmNhc2UgMTQ6cmV0dXJuIDE3CmJyZWFrOwpjYXNlIDE1OnJldHVybiAxOApicmVhazsKY2FzZSAxNjpyZXR1cm4gNQpicmVhazsKY2FzZSAxNzpyZXR1cm4gJ0lOVkFMSUQnCmJyZWFrOwp9Cn07CmxleGVyLnJ1bGVzID0gWy9eXHMrLywvXlswLTldKyhcLlswLTldKyk/XGIvLC9eblxiLywvXlx8XHwvLC9eJiYvLC9eXD8vLC9eOi8sL148PS8sL14+PS8sL148LywvXj4vLC9eIT0vLC9ePT0vLC9eJS8sL15cKC8sL15cKS8sL14kLywvXi4vXTsKbGV4ZXIuY29uZGl0aW9ucyA9IHsiSU5JVElBTCI6eyJydWxlcyI6WzAsMSwyLDMsNCw1LDYsNyw4LDksMTAsMTEsMTIsMTMsMTQsMTUsMTYsMTddLCJpbmNsdXNpdmUiOnRydWV9fTtyZXR1cm4gbGV4ZXI7fSkoKQpwYXJzZXIubGV4ZXIgPSBsZXhlcjsKcmV0dXJuIHBhcnNlcjsKfSkoKTsKLy8gRW5kIHBhcnNlcgoKICAvLyBIYW5kbGUgbm9kZSwgYW1kLCBhbmQgZ2xvYmFsIHN5c3RlbXMKICBpZiAodHlwZW9mIGV4cG9ydHMgIT09ICd1bmRlZmluZWQnKSB7CiAgICBpZiAodHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgJiYgbW9kdWxlLmV4cG9ydHMpIHsKICAgICAgZXhwb3J0cyA9IG1vZHVsZS5leHBvcnRzID0gSmVkOwogICAgfQogICAgZXhwb3J0cy5KZWQgPSBKZWQ7CiAgfQogIGVsc2UgewogICAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewogICAgICBkZWZpbmUoJ2plZCcsIFtdLGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBKZWQ7CiAgICAgIH0pOwogICAgfQogICAgLy8gTGVhayBhIGdsb2JhbCByZWdhcmRsZXNzIG9mIG1vZHVsZSBzeXN0ZW0KICAgIHJvb3RbJ0plZCddID0gSmVkOwogIH0KCn0pKHRoaXMpOwoKLyoKICogVGhpcyBmaWxlIGNhbiBiZSB1c2VkIGlmIG5vIGxvY2FsZSBzdXBwb3J0IGlzIHJlcXVpcmVkLgogKi8KKGZ1bmN0aW9uIChyb290LCBmYWN0b3J5KSB7CiAgICBkZWZpbmUoImxvY2FsZXMiLCBbJ2plZCddLCBmdW5jdGlvbiAoSmVkKSB7CiAgICAgICAgdmFyIHRyYW5zbGF0aW9ucyA9IHsKICAgICAgICAgICAgImRvbWFpbiI6ICJjb252ZXJzZSIsCiAgICAgICAgICAgICJsb2NhbGVfZGF0YSI6IHsKICAgICAgICAgICAgICAgICJjb252ZXJzZSI6IHsKICAgICAgICAgICAgICAgICAgICAiIjogewogICAgICAgICAgICAgICAgICAgICAgICAiZG9tYWluIjogImNvbnZlcnNlIiwKICAgICAgICAgICAgICAgICAgICAgICAgImxhbmciOiAiZW4iLAogICAgICAgICAgICAgICAgICAgICAgICAicGx1cmFsX2Zvcm1zIjogIm5wbHVyYWxzPTI7IHBsdXJhbD0obiAhPSAxKTsiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICByb290LmxvY2FsZXMgPSB7ICdlbic6IG5ldyBKZWQodHJhbnNsYXRpb25zKSB9OwogICAgfSk7Cn0pKHRoaXMpOwoKLy8gICAgIFVuZGVyc2NvcmUuanMgMS42LjAKLy8gICAgIGh0dHA6Ly91bmRlcnNjb3JlanMub3JnCi8vICAgICAoYykgMjAwOS0yMDE0IEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZCBhbmQgSW52ZXN0aWdhdGl2ZSBSZXBvcnRlcnMgJiBFZGl0b3JzCi8vICAgICBVbmRlcnNjb3JlIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgoKKGZ1bmN0aW9uKCkgewoKICAvLyBCYXNlbGluZSBzZXR1cAogIC8vIC0tLS0tLS0tLS0tLS0tCgogIC8vIEVzdGFibGlzaCB0aGUgcm9vdCBvYmplY3QsIGB3aW5kb3dgIGluIHRoZSBicm93c2VyLCBvciBgZXhwb3J0c2Agb24gdGhlIHNlcnZlci4KICB2YXIgcm9vdCA9IHRoaXM7CgogIC8vIFNhdmUgdGhlIHByZXZpb3VzIHZhbHVlIG9mIHRoZSBgX2AgdmFyaWFibGUuCiAgdmFyIHByZXZpb3VzVW5kZXJzY29yZSA9IHJvb3QuXzsKCiAgLy8gRXN0YWJsaXNoIHRoZSBvYmplY3QgdGhhdCBnZXRzIHJldHVybmVkIHRvIGJyZWFrIG91dCBvZiBhIGxvb3AgaXRlcmF0aW9uLgogIHZhciBicmVha2VyID0ge307CgogIC8vIFNhdmUgYnl0ZXMgaW4gdGhlIG1pbmlmaWVkIChidXQgbm90IGd6aXBwZWQpIHZlcnNpb246CiAgdmFyIEFycmF5UHJvdG8gPSBBcnJheS5wcm90b3R5cGUsIE9ialByb3RvID0gT2JqZWN0LnByb3RvdHlwZSwgRnVuY1Byb3RvID0gRnVuY3Rpb24ucHJvdG90eXBlOwoKICAvLyBDcmVhdGUgcXVpY2sgcmVmZXJlbmNlIHZhcmlhYmxlcyBmb3Igc3BlZWQgYWNjZXNzIHRvIGNvcmUgcHJvdG90eXBlcy4KICB2YXIKICAgIHB1c2ggICAgICAgICAgICAgPSBBcnJheVByb3RvLnB1c2gsCiAgICBzbGljZSAgICAgICAgICAgID0gQXJyYXlQcm90by5zbGljZSwKICAgIGNvbmNhdCAgICAgICAgICAgPSBBcnJheVByb3RvLmNvbmNhdCwKICAgIHRvU3RyaW5nICAgICAgICAgPSBPYmpQcm90by50b1N0cmluZywKICAgIGhhc093blByb3BlcnR5ICAgPSBPYmpQcm90by5oYXNPd25Qcm9wZXJ0eTsKCiAgLy8gQWxsICoqRUNNQVNjcmlwdCA1KiogbmF0aXZlIGZ1bmN0aW9uIGltcGxlbWVudGF0aW9ucyB0aGF0IHdlIGhvcGUgdG8gdXNlCiAgLy8gYXJlIGRlY2xhcmVkIGhlcmUuCiAgdmFyCiAgICBuYXRpdmVGb3JFYWNoICAgICAgPSBBcnJheVByb3RvLmZvckVhY2gsCiAgICBuYXRpdmVNYXAgICAgICAgICAgPSBBcnJheVByb3RvLm1hcCwKICAgIG5hdGl2ZVJlZHVjZSAgICAgICA9IEFycmF5UHJvdG8ucmVkdWNlLAogICAgbmF0aXZlUmVkdWNlUmlnaHQgID0gQXJyYXlQcm90by5yZWR1Y2VSaWdodCwKICAgIG5hdGl2ZUZpbHRlciAgICAgICA9IEFycmF5UHJvdG8uZmlsdGVyLAogICAgbmF0aXZlRXZlcnkgICAgICAgID0gQXJyYXlQcm90by5ldmVyeSwKICAgIG5hdGl2ZVNvbWUgICAgICAgICA9IEFycmF5UHJvdG8uc29tZSwKICAgIG5hdGl2ZUluZGV4T2YgICAgICA9IEFycmF5UHJvdG8uaW5kZXhPZiwKICAgIG5hdGl2ZUxhc3RJbmRleE9mICA9IEFycmF5UHJvdG8ubGFzdEluZGV4T2YsCiAgICBuYXRpdmVJc0FycmF5ICAgICAgPSBBcnJheS5pc0FycmF5LAogICAgbmF0aXZlS2V5cyAgICAgICAgID0gT2JqZWN0LmtleXMsCiAgICBuYXRpdmVCaW5kICAgICAgICAgPSBGdW5jUHJvdG8uYmluZDsKCiAgLy8gQ3JlYXRlIGEgc2FmZSByZWZlcmVuY2UgdG8gdGhlIFVuZGVyc2NvcmUgb2JqZWN0IGZvciB1c2UgYmVsb3cuCiAgdmFyIF8gPSBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogaW5zdGFuY2VvZiBfKSByZXR1cm4gb2JqOwogICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIF8pKSByZXR1cm4gbmV3IF8ob2JqKTsKICAgIHRoaXMuX3dyYXBwZWQgPSBvYmo7CiAgfTsKCiAgLy8gRXhwb3J0IHRoZSBVbmRlcnNjb3JlIG9iamVjdCBmb3IgKipOb2RlLmpzKiosIHdpdGgKICAvLyBiYWNrd2FyZHMtY29tcGF0aWJpbGl0eSBmb3IgdGhlIG9sZCBgcmVxdWlyZSgpYCBBUEkuIElmIHdlJ3JlIGluCiAgLy8gdGhlIGJyb3dzZXIsIGFkZCBgX2AgYXMgYSBnbG9iYWwgb2JqZWN0IHZpYSBhIHN0cmluZyBpZGVudGlmaWVyLAogIC8vIGZvciBDbG9zdXJlIENvbXBpbGVyICJhZHZhbmNlZCIgbW9kZS4KICBpZiAodHlwZW9mIGV4cG9ydHMgIT09ICd1bmRlZmluZWQnKSB7CiAgICBpZiAodHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgJiYgbW9kdWxlLmV4cG9ydHMpIHsKICAgICAgZXhwb3J0cyA9IG1vZHVsZS5leHBvcnRzID0gXzsKICAgIH0KICAgIGV4cG9ydHMuXyA9IF87CiAgfSBlbHNlIHsKICAgIHJvb3QuXyA9IF87CiAgfQoKICAvLyBDdXJyZW50IHZlcnNpb24uCiAgXy5WRVJTSU9OID0gJzEuNi4wJzsKCiAgLy8gQ29sbGVjdGlvbiBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBUaGUgY29ybmVyc3RvbmUsIGFuIGBlYWNoYCBpbXBsZW1lbnRhdGlvbiwgYWthIGBmb3JFYWNoYC4KICAvLyBIYW5kbGVzIG9iamVjdHMgd2l0aCB0aGUgYnVpbHQtaW4gYGZvckVhY2hgLCBhcnJheXMsIGFuZCByYXcgb2JqZWN0cy4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgZm9yRWFjaGAgaWYgYXZhaWxhYmxlLgogIHZhciBlYWNoID0gXy5lYWNoID0gXy5mb3JFYWNoID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gb2JqOwogICAgaWYgKG5hdGl2ZUZvckVhY2ggJiYgb2JqLmZvckVhY2ggPT09IG5hdGl2ZUZvckVhY2gpIHsKICAgICAgb2JqLmZvckVhY2goaXRlcmF0b3IsIGNvbnRleHQpOwogICAgfSBlbHNlIGlmIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgewogICAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gb2JqLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2ldLCBpLCBvYmopID09PSBicmVha2VyKSByZXR1cm47CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBrZXlzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleXNbaV1dLCBrZXlzW2ldLCBvYmopID09PSBicmVha2VyKSByZXR1cm47CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBvYmo7CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSByZXN1bHRzIG9mIGFwcGx5aW5nIHRoZSBpdGVyYXRvciB0byBlYWNoIGVsZW1lbnQuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYG1hcGAgaWYgYXZhaWxhYmxlLgogIF8ubWFwID0gXy5jb2xsZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHJlc3VsdHM7CiAgICBpZiAobmF0aXZlTWFwICYmIG9iai5tYXAgPT09IG5hdGl2ZU1hcCkgcmV0dXJuIG9iai5tYXAoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICByZXN1bHRzLnB1c2goaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKCiAgdmFyIHJlZHVjZUVycm9yID0gJ1JlZHVjZSBvZiBlbXB0eSBhcnJheSB3aXRoIG5vIGluaXRpYWwgdmFsdWUnOwoKICAvLyAqKlJlZHVjZSoqIGJ1aWxkcyB1cCBhIHNpbmdsZSByZXN1bHQgZnJvbSBhIGxpc3Qgb2YgdmFsdWVzLCBha2EgYGluamVjdGAsCiAgLy8gb3IgYGZvbGRsYC4gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYHJlZHVjZWAgaWYgYXZhaWxhYmxlLgogIF8ucmVkdWNlID0gXy5mb2xkbCA9IF8uaW5qZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgbWVtbywgY29udGV4dCkgewogICAgdmFyIGluaXRpYWwgPSBhcmd1bWVudHMubGVuZ3RoID4gMjsKICAgIGlmIChvYmogPT0gbnVsbCkgb2JqID0gW107CiAgICBpZiAobmF0aXZlUmVkdWNlICYmIG9iai5yZWR1Y2UgPT09IG5hdGl2ZVJlZHVjZSkgewogICAgICBpZiAoY29udGV4dCkgaXRlcmF0b3IgPSBfLmJpbmQoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgICByZXR1cm4gaW5pdGlhbCA/IG9iai5yZWR1Y2UoaXRlcmF0b3IsIG1lbW8pIDogb2JqLnJlZHVjZShpdGVyYXRvcik7CiAgICB9CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmICghaW5pdGlhbCkgewogICAgICAgIG1lbW8gPSB2YWx1ZTsKICAgICAgICBpbml0aWFsID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZW1vID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBtZW1vLCB2YWx1ZSwgaW5kZXgsIGxpc3QpOwogICAgICB9CiAgICB9KTsKICAgIGlmICghaW5pdGlhbCkgdGhyb3cgbmV3IFR5cGVFcnJvcihyZWR1Y2VFcnJvcik7CiAgICByZXR1cm4gbWVtbzsKICB9OwoKICAvLyBUaGUgcmlnaHQtYXNzb2NpYXRpdmUgdmVyc2lvbiBvZiByZWR1Y2UsIGFsc28ga25vd24gYXMgYGZvbGRyYC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgcmVkdWNlUmlnaHRgIGlmIGF2YWlsYWJsZS4KICBfLnJlZHVjZVJpZ2h0ID0gXy5mb2xkciA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIG1lbW8sIGNvbnRleHQpIHsKICAgIHZhciBpbml0aWFsID0gYXJndW1lbnRzLmxlbmd0aCA+IDI7CiAgICBpZiAob2JqID09IG51bGwpIG9iaiA9IFtdOwogICAgaWYgKG5hdGl2ZVJlZHVjZVJpZ2h0ICYmIG9iai5yZWR1Y2VSaWdodCA9PT0gbmF0aXZlUmVkdWNlUmlnaHQpIHsKICAgICAgaWYgKGNvbnRleHQpIGl0ZXJhdG9yID0gXy5iaW5kKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgICAgcmV0dXJuIGluaXRpYWwgPyBvYmoucmVkdWNlUmlnaHQoaXRlcmF0b3IsIG1lbW8pIDogb2JqLnJlZHVjZVJpZ2h0KGl0ZXJhdG9yKTsKICAgIH0KICAgIHZhciBsZW5ndGggPSBvYmoubGVuZ3RoOwogICAgaWYgKGxlbmd0aCAhPT0gK2xlbmd0aCkgewogICAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwogICAgICBsZW5ndGggPSBrZXlzLmxlbmd0aDsKICAgIH0KICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaW5kZXggPSBrZXlzID8ga2V5c1stLWxlbmd0aF0gOiAtLWxlbmd0aDsKICAgICAgaWYgKCFpbml0aWFsKSB7CiAgICAgICAgbWVtbyA9IG9ialtpbmRleF07CiAgICAgICAgaW5pdGlhbCA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWVtbyA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgbWVtbywgb2JqW2luZGV4XSwgaW5kZXgsIGxpc3QpOwogICAgICB9CiAgICB9KTsKICAgIGlmICghaW5pdGlhbCkgdGhyb3cgbmV3IFR5cGVFcnJvcihyZWR1Y2VFcnJvcik7CiAgICByZXR1cm4gbWVtbzsKICB9OwoKICAvLyBSZXR1cm4gdGhlIGZpcnN0IHZhbHVlIHdoaWNoIHBhc3NlcyBhIHRydXRoIHRlc3QuIEFsaWFzZWQgYXMgYGRldGVjdGAuCiAgXy5maW5kID0gXy5kZXRlY3QgPSBmdW5jdGlvbihvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdDsKICAgIGFueShvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAocHJlZGljYXRlLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkgewogICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gUmV0dXJuIGFsbCB0aGUgZWxlbWVudHMgdGhhdCBwYXNzIGEgdHJ1dGggdGVzdC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgZmlsdGVyYCBpZiBhdmFpbGFibGUuCiAgLy8gQWxpYXNlZCBhcyBgc2VsZWN0YC4KICBfLmZpbHRlciA9IF8uc2VsZWN0ID0gZnVuY3Rpb24ob2JqLCBwcmVkaWNhdGUsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHRzID0gW107CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHRzOwogICAgaWYgKG5hdGl2ZUZpbHRlciAmJiBvYmouZmlsdGVyID09PSBuYXRpdmVGaWx0ZXIpIHJldHVybiBvYmouZmlsdGVyKHByZWRpY2F0ZSwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmIChwcmVkaWNhdGUuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSByZXN1bHRzLnB1c2godmFsdWUpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyBSZXR1cm4gYWxsIHRoZSBlbGVtZW50cyBmb3Igd2hpY2ggYSB0cnV0aCB0ZXN0IGZhaWxzLgogIF8ucmVqZWN0ID0gZnVuY3Rpb24ob2JqLCBwcmVkaWNhdGUsIGNvbnRleHQpIHsKICAgIHJldHVybiBfLmZpbHRlcihvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICByZXR1cm4gIXByZWRpY2F0ZS5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCk7CiAgICB9LCBjb250ZXh0KTsKICB9OwoKICAvLyBEZXRlcm1pbmUgd2hldGhlciBhbGwgb2YgdGhlIGVsZW1lbnRzIG1hdGNoIGEgdHJ1dGggdGVzdC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgZXZlcnlgIGlmIGF2YWlsYWJsZS4KICAvLyBBbGlhc2VkIGFzIGBhbGxgLgogIF8uZXZlcnkgPSBfLmFsbCA9IGZ1bmN0aW9uKG9iaiwgcHJlZGljYXRlLCBjb250ZXh0KSB7CiAgICBwcmVkaWNhdGUgfHwgKHByZWRpY2F0ZSA9IF8uaWRlbnRpdHkpOwogICAgdmFyIHJlc3VsdCA9IHRydWU7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHQ7CiAgICBpZiAobmF0aXZlRXZlcnkgJiYgb2JqLmV2ZXJ5ID09PSBuYXRpdmVFdmVyeSkgcmV0dXJuIG9iai5ldmVyeShwcmVkaWNhdGUsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoIShyZXN1bHQgPSByZXN1bHQgJiYgcHJlZGljYXRlLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkpIHJldHVybiBicmVha2VyOwogICAgfSk7CiAgICByZXR1cm4gISFyZXN1bHQ7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIGlmIGF0IGxlYXN0IG9uZSBlbGVtZW50IGluIHRoZSBvYmplY3QgbWF0Y2hlcyBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYHNvbWVgIGlmIGF2YWlsYWJsZS4KICAvLyBBbGlhc2VkIGFzIGBhbnlgLgogIHZhciBhbnkgPSBfLnNvbWUgPSBfLmFueSA9IGZ1bmN0aW9uKG9iaiwgcHJlZGljYXRlLCBjb250ZXh0KSB7CiAgICBwcmVkaWNhdGUgfHwgKHByZWRpY2F0ZSA9IF8uaWRlbnRpdHkpOwogICAgdmFyIHJlc3VsdCA9IGZhbHNlOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0OwogICAgaWYgKG5hdGl2ZVNvbWUgJiYgb2JqLnNvbWUgPT09IG5hdGl2ZVNvbWUpIHJldHVybiBvYmouc29tZShwcmVkaWNhdGUsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAocmVzdWx0IHx8IChyZXN1bHQgPSBwcmVkaWNhdGUuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSkgcmV0dXJuIGJyZWFrZXI7CiAgICB9KTsKICAgIHJldHVybiAhIXJlc3VsdDsKICB9OwoKICAvLyBEZXRlcm1pbmUgaWYgdGhlIGFycmF5IG9yIG9iamVjdCBjb250YWlucyBhIGdpdmVuIHZhbHVlICh1c2luZyBgPT09YCkuCiAgLy8gQWxpYXNlZCBhcyBgaW5jbHVkZWAuCiAgXy5jb250YWlucyA9IF8uaW5jbHVkZSA9IGZ1bmN0aW9uKG9iaiwgdGFyZ2V0KSB7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiBmYWxzZTsKICAgIGlmIChuYXRpdmVJbmRleE9mICYmIG9iai5pbmRleE9mID09PSBuYXRpdmVJbmRleE9mKSByZXR1cm4gb2JqLmluZGV4T2YodGFyZ2V0KSAhPSAtMTsKICAgIHJldHVybiBhbnkob2JqLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPT09IHRhcmdldDsKICAgIH0pOwogIH07CgogIC8vIEludm9rZSBhIG1ldGhvZCAod2l0aCBhcmd1bWVudHMpIG9uIGV2ZXJ5IGl0ZW0gaW4gYSBjb2xsZWN0aW9uLgogIF8uaW52b2tlID0gZnVuY3Rpb24ob2JqLCBtZXRob2QpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgdmFyIGlzRnVuYyA9IF8uaXNGdW5jdGlvbihtZXRob2QpOwogICAgcmV0dXJuIF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIChpc0Z1bmMgPyBtZXRob2QgOiB2YWx1ZVttZXRob2RdKS5hcHBseSh2YWx1ZSwgYXJncyk7CiAgICB9KTsKICB9OwoKICAvLyBDb252ZW5pZW5jZSB2ZXJzaW9uIG9mIGEgY29tbW9uIHVzZSBjYXNlIG9mIGBtYXBgOiBmZXRjaGluZyBhIHByb3BlcnR5LgogIF8ucGx1Y2sgPSBmdW5jdGlvbihvYmosIGtleSkgewogICAgcmV0dXJuIF8ubWFwKG9iaiwgXy5wcm9wZXJ0eShrZXkpKTsKICB9OwoKICAvLyBDb252ZW5pZW5jZSB2ZXJzaW9uIG9mIGEgY29tbW9uIHVzZSBjYXNlIG9mIGBmaWx0ZXJgOiBzZWxlY3Rpbmcgb25seSBvYmplY3RzCiAgLy8gY29udGFpbmluZyBzcGVjaWZpYyBga2V5OnZhbHVlYCBwYWlycy4KICBfLndoZXJlID0gZnVuY3Rpb24ob2JqLCBhdHRycykgewogICAgcmV0dXJuIF8uZmlsdGVyKG9iaiwgXy5tYXRjaGVzKGF0dHJzKSk7CiAgfTsKCiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgZmluZGA6IGdldHRpbmcgdGhlIGZpcnN0IG9iamVjdAogIC8vIGNvbnRhaW5pbmcgc3BlY2lmaWMgYGtleTp2YWx1ZWAgcGFpcnMuCiAgXy5maW5kV2hlcmUgPSBmdW5jdGlvbihvYmosIGF0dHJzKSB7CiAgICByZXR1cm4gXy5maW5kKG9iaiwgXy5tYXRjaGVzKGF0dHJzKSk7CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBtYXhpbXVtIGVsZW1lbnQgb3IgKGVsZW1lbnQtYmFzZWQgY29tcHV0YXRpb24pLgogIC8vIENhbid0IG9wdGltaXplIGFycmF5cyBvZiBpbnRlZ2VycyBsb25nZXIgdGhhbiA2NSw1MzUgZWxlbWVudHMuCiAgLy8gU2VlIFtXZWJLaXQgQnVnIDgwNzk3XShodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9ODA3OTcpCiAgXy5tYXggPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpZiAoIWl0ZXJhdG9yICYmIF8uaXNBcnJheShvYmopICYmIG9ialswXSA9PT0gK29ialswXSAmJiBvYmoubGVuZ3RoIDwgNjU1MzUpIHsKICAgICAgcmV0dXJuIE1hdGgubWF4LmFwcGx5KE1hdGgsIG9iaik7CiAgICB9CiAgICB2YXIgcmVzdWx0ID0gLUluZmluaXR5LCBsYXN0Q29tcHV0ZWQgPSAtSW5maW5pdHk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHZhciBjb21wdXRlZCA9IGl0ZXJhdG9yID8gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpIDogdmFsdWU7CiAgICAgIGlmIChjb21wdXRlZCA+IGxhc3RDb21wdXRlZCkgewogICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgIGxhc3RDb21wdXRlZCA9IGNvbXB1dGVkOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBtaW5pbXVtIGVsZW1lbnQgKG9yIGVsZW1lbnQtYmFzZWQgY29tcHV0YXRpb24pLgogIF8ubWluID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzQXJyYXkob2JqKSAmJiBvYmpbMF0gPT09ICtvYmpbMF0gJiYgb2JqLmxlbmd0aCA8IDY1NTM1KSB7CiAgICAgIHJldHVybiBNYXRoLm1pbi5hcHBseShNYXRoLCBvYmopOwogICAgfQogICAgdmFyIHJlc3VsdCA9IEluZmluaXR5LCBsYXN0Q29tcHV0ZWQgPSBJbmZpbml0eTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgdmFyIGNvbXB1dGVkID0gaXRlcmF0b3IgPyBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkgOiB2YWx1ZTsKICAgICAgaWYgKGNvbXB1dGVkIDwgbGFzdENvbXB1dGVkKSB7CiAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgbGFzdENvbXB1dGVkID0gY29tcHV0ZWQ7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBTaHVmZmxlIGFuIGFycmF5LCB1c2luZyB0aGUgbW9kZXJuIHZlcnNpb24gb2YgdGhlCiAgLy8gW0Zpc2hlci1ZYXRlcyBzaHVmZmxlXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0Zpc2hlcuKAk1lhdGVzX3NodWZmbGUpLgogIF8uc2h1ZmZsZSA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIHJhbmQ7CiAgICB2YXIgaW5kZXggPSAwOwogICAgdmFyIHNodWZmbGVkID0gW107CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmFuZCA9IF8ucmFuZG9tKGluZGV4KyspOwogICAgICBzaHVmZmxlZFtpbmRleCAtIDFdID0gc2h1ZmZsZWRbcmFuZF07CiAgICAgIHNodWZmbGVkW3JhbmRdID0gdmFsdWU7CiAgICB9KTsKICAgIHJldHVybiBzaHVmZmxlZDsKICB9OwoKICAvLyBTYW1wbGUgKipuKiogcmFuZG9tIHZhbHVlcyBmcm9tIGEgY29sbGVjdGlvbi4KICAvLyBJZiAqKm4qKiBpcyBub3Qgc3BlY2lmaWVkLCByZXR1cm5zIGEgc2luZ2xlIHJhbmRvbSBlbGVtZW50LgogIC8vIFRoZSBpbnRlcm5hbCBgZ3VhcmRgIGFyZ3VtZW50IGFsbG93cyBpdCB0byB3b3JrIHdpdGggYG1hcGAuCiAgXy5zYW1wbGUgPSBmdW5jdGlvbihvYmosIG4sIGd1YXJkKSB7CiAgICBpZiAobiA9PSBudWxsIHx8IGd1YXJkKSB7CiAgICAgIGlmIChvYmoubGVuZ3RoICE9PSArb2JqLmxlbmd0aCkgb2JqID0gXy52YWx1ZXMob2JqKTsKICAgICAgcmV0dXJuIG9ialtfLnJhbmRvbShvYmoubGVuZ3RoIC0gMSldOwogICAgfQogICAgcmV0dXJuIF8uc2h1ZmZsZShvYmopLnNsaWNlKDAsIE1hdGgubWF4KDAsIG4pKTsKICB9OwoKICAvLyBBbiBpbnRlcm5hbCBmdW5jdGlvbiB0byBnZW5lcmF0ZSBsb29rdXAgaXRlcmF0b3JzLgogIHZhciBsb29rdXBJdGVyYXRvciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT0gbnVsbCkgcmV0dXJuIF8uaWRlbnRpdHk7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKHZhbHVlKSkgcmV0dXJuIHZhbHVlOwogICAgcmV0dXJuIF8ucHJvcGVydHkodmFsdWUpOwogIH07CgogIC8vIFNvcnQgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbiBwcm9kdWNlZCBieSBhbiBpdGVyYXRvci4KICBfLnNvcnRCeSA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGl0ZXJhdG9yID0gbG9va3VwSXRlcmF0b3IoaXRlcmF0b3IpOwogICAgcmV0dXJuIF8ucGx1Y2soXy5tYXAob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgaW5kZXg6IGluZGV4LAogICAgICAgIGNyaXRlcmlhOiBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkKICAgICAgfTsKICAgIH0pLnNvcnQoZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgdmFyIGEgPSBsZWZ0LmNyaXRlcmlhOwogICAgICB2YXIgYiA9IHJpZ2h0LmNyaXRlcmlhOwogICAgICBpZiAoYSAhPT0gYikgewogICAgICAgIGlmIChhID4gYiB8fCBhID09PSB2b2lkIDApIHJldHVybiAxOwogICAgICAgIGlmIChhIDwgYiB8fCBiID09PSB2b2lkIDApIHJldHVybiAtMTsKICAgICAgfQogICAgICByZXR1cm4gbGVmdC5pbmRleCAtIHJpZ2h0LmluZGV4OwogICAgfSksICd2YWx1ZScpOwogIH07CgogIC8vIEFuIGludGVybmFsIGZ1bmN0aW9uIHVzZWQgZm9yIGFnZ3JlZ2F0ZSAiZ3JvdXAgYnkiIG9wZXJhdGlvbnMuCiAgdmFyIGdyb3VwID0gZnVuY3Rpb24oYmVoYXZpb3IpIHsKICAgIHJldHVybiBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgaXRlcmF0b3IgPSBsb29rdXBJdGVyYXRvcihpdGVyYXRvcik7CiAgICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgpIHsKICAgICAgICB2YXIga2V5ID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIG9iaik7CiAgICAgICAgYmVoYXZpb3IocmVzdWx0LCBrZXksIHZhbHVlKTsKICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH07CgogIC8vIEdyb3VwcyB0aGUgb2JqZWN0J3MgdmFsdWVzIGJ5IGEgY3JpdGVyaW9uLiBQYXNzIGVpdGhlciBhIHN0cmluZyBhdHRyaWJ1dGUKICAvLyB0byBncm91cCBieSwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIGNyaXRlcmlvbi4KICBfLmdyb3VwQnkgPSBncm91cChmdW5jdGlvbihyZXN1bHQsIGtleSwgdmFsdWUpIHsKICAgIF8uaGFzKHJlc3VsdCwga2V5KSA/IHJlc3VsdFtrZXldLnB1c2godmFsdWUpIDogcmVzdWx0W2tleV0gPSBbdmFsdWVdOwogIH0pOwoKICAvLyBJbmRleGVzIHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24sIHNpbWlsYXIgdG8gYGdyb3VwQnlgLCBidXQgZm9yCiAgLy8gd2hlbiB5b3Uga25vdyB0aGF0IHlvdXIgaW5kZXggdmFsdWVzIHdpbGwgYmUgdW5pcXVlLgogIF8uaW5kZXhCeSA9IGdyb3VwKGZ1bmN0aW9uKHJlc3VsdCwga2V5LCB2YWx1ZSkgewogICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKICB9KTsKCiAgLy8gQ291bnRzIGluc3RhbmNlcyBvZiBhbiBvYmplY3QgdGhhdCBncm91cCBieSBhIGNlcnRhaW4gY3JpdGVyaW9uLiBQYXNzCiAgLy8gZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZSB0byBjb3VudCBieSwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlCiAgLy8gY3JpdGVyaW9uLgogIF8uY291bnRCeSA9IGdyb3VwKGZ1bmN0aW9uKHJlc3VsdCwga2V5KSB7CiAgICBfLmhhcyhyZXN1bHQsIGtleSkgPyByZXN1bHRba2V5XSsrIDogcmVzdWx0W2tleV0gPSAxOwogIH0pOwoKICAvLyBVc2UgYSBjb21wYXJhdG9yIGZ1bmN0aW9uIHRvIGZpZ3VyZSBvdXQgdGhlIHNtYWxsZXN0IGluZGV4IGF0IHdoaWNoCiAgLy8gYW4gb2JqZWN0IHNob3VsZCBiZSBpbnNlcnRlZCBzbyBhcyB0byBtYWludGFpbiBvcmRlci4gVXNlcyBiaW5hcnkgc2VhcmNoLgogIF8uc29ydGVkSW5kZXggPSBmdW5jdGlvbihhcnJheSwgb2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgPSBsb29rdXBJdGVyYXRvcihpdGVyYXRvcik7CiAgICB2YXIgdmFsdWUgPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9iaik7CiAgICB2YXIgbG93ID0gMCwgaGlnaCA9IGFycmF5Lmxlbmd0aDsKICAgIHdoaWxlIChsb3cgPCBoaWdoKSB7CiAgICAgIHZhciBtaWQgPSAobG93ICsgaGlnaCkgPj4+IDE7CiAgICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgYXJyYXlbbWlkXSkgPCB2YWx1ZSA/IGxvdyA9IG1pZCArIDEgOiBoaWdoID0gbWlkOwogICAgfQogICAgcmV0dXJuIGxvdzsKICB9OwoKICAvLyBTYWZlbHkgY3JlYXRlIGEgcmVhbCwgbGl2ZSBhcnJheSBmcm9tIGFueXRoaW5nIGl0ZXJhYmxlLgogIF8udG9BcnJheSA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCFvYmopIHJldHVybiBbXTsKICAgIGlmIChfLmlzQXJyYXkob2JqKSkgcmV0dXJuIHNsaWNlLmNhbGwob2JqKTsKICAgIGlmIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgcmV0dXJuIF8ubWFwKG9iaiwgXy5pZGVudGl0eSk7CiAgICByZXR1cm4gXy52YWx1ZXMob2JqKTsKICB9OwoKICAvLyBSZXR1cm4gdGhlIG51bWJlciBvZiBlbGVtZW50cyBpbiBhbiBvYmplY3QuCiAgXy5zaXplID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiAwOwogICAgcmV0dXJuIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgPyBvYmoubGVuZ3RoIDogXy5rZXlzKG9iaikubGVuZ3RoOwogIH07CgogIC8vIEFycmF5IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBHZXQgdGhlIGZpcnN0IGVsZW1lbnQgb2YgYW4gYXJyYXkuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gdGhlIGZpcnN0IE4KICAvLyB2YWx1ZXMgaW4gdGhlIGFycmF5LiBBbGlhc2VkIGFzIGBoZWFkYCBhbmQgYHRha2VgLiBUaGUgKipndWFyZCoqIGNoZWNrCiAgLy8gYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8uZmlyc3QgPSBfLmhlYWQgPSBfLnRha2UgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIGlmIChhcnJheSA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwogICAgaWYgKChuID09IG51bGwpIHx8IGd1YXJkKSByZXR1cm4gYXJyYXlbMF07CiAgICBpZiAobiA8IDApIHJldHVybiBbXTsKICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCAwLCBuKTsKICB9OwoKICAvLyBSZXR1cm5zIGV2ZXJ5dGhpbmcgYnV0IHRoZSBsYXN0IGVudHJ5IG9mIHRoZSBhcnJheS4gRXNwZWNpYWxseSB1c2VmdWwgb24KICAvLyB0aGUgYXJndW1lbnRzIG9iamVjdC4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiBhbGwgdGhlIHZhbHVlcyBpbgogIC8vIHRoZSBhcnJheSwgZXhjbHVkaW5nIHRoZSBsYXN0IE4uIFRoZSAqKmd1YXJkKiogY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aAogIC8vIGBfLm1hcGAuCiAgXy5pbml0aWFsID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgMCwgYXJyYXkubGVuZ3RoIC0gKChuID09IG51bGwpIHx8IGd1YXJkID8gMSA6IG4pKTsKICB9OwoKICAvLyBHZXQgdGhlIGxhc3QgZWxlbWVudCBvZiBhbiBhcnJheS4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiB0aGUgbGFzdCBOCiAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gVGhlICoqZ3VhcmQqKiBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCiAgXy5sYXN0ID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKICAgIGlmICgobiA9PSBudWxsKSB8fCBndWFyZCkgcmV0dXJuIGFycmF5W2FycmF5Lmxlbmd0aCAtIDFdOwogICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIE1hdGgubWF4KGFycmF5Lmxlbmd0aCAtIG4sIDApKTsKICB9OwoKICAvLyBSZXR1cm5zIGV2ZXJ5dGhpbmcgYnV0IHRoZSBmaXJzdCBlbnRyeSBvZiB0aGUgYXJyYXkuIEFsaWFzZWQgYXMgYHRhaWxgIGFuZCBgZHJvcGAuCiAgLy8gRXNwZWNpYWxseSB1c2VmdWwgb24gdGhlIGFyZ3VtZW50cyBvYmplY3QuIFBhc3NpbmcgYW4gKipuKiogd2lsbCByZXR1cm4KICAvLyB0aGUgcmVzdCBOIHZhbHVlcyBpbiB0aGUgYXJyYXkuIFRoZSAqKmd1YXJkKioKICAvLyBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCiAgXy5yZXN0ID0gXy50YWlsID0gXy5kcm9wID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgKG4gPT0gbnVsbCkgfHwgZ3VhcmQgPyAxIDogbik7CiAgfTsKCiAgLy8gVHJpbSBvdXQgYWxsIGZhbHN5IHZhbHVlcyBmcm9tIGFuIGFycmF5LgogIF8uY29tcGFjdCA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICByZXR1cm4gXy5maWx0ZXIoYXJyYXksIF8uaWRlbnRpdHkpOwogIH07CgogIC8vIEludGVybmFsIGltcGxlbWVudGF0aW9uIG9mIGEgcmVjdXJzaXZlIGBmbGF0dGVuYCBmdW5jdGlvbi4KICB2YXIgZmxhdHRlbiA9IGZ1bmN0aW9uKGlucHV0LCBzaGFsbG93LCBvdXRwdXQpIHsKICAgIGlmIChzaGFsbG93ICYmIF8uZXZlcnkoaW5wdXQsIF8uaXNBcnJheSkpIHsKICAgICAgcmV0dXJuIGNvbmNhdC5hcHBseShvdXRwdXQsIGlucHV0KTsKICAgIH0KICAgIGVhY2goaW5wdXQsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmIChfLmlzQXJyYXkodmFsdWUpIHx8IF8uaXNBcmd1bWVudHModmFsdWUpKSB7CiAgICAgICAgc2hhbGxvdyA/IHB1c2guYXBwbHkob3V0cHV0LCB2YWx1ZSkgOiBmbGF0dGVuKHZhbHVlLCBzaGFsbG93LCBvdXRwdXQpOwogICAgICB9IGVsc2UgewogICAgICAgIG91dHB1dC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb3V0cHV0OwogIH07CgogIC8vIEZsYXR0ZW4gb3V0IGFuIGFycmF5LCBlaXRoZXIgcmVjdXJzaXZlbHkgKGJ5IGRlZmF1bHQpLCBvciBqdXN0IG9uZSBsZXZlbC4KICBfLmZsYXR0ZW4gPSBmdW5jdGlvbihhcnJheSwgc2hhbGxvdykgewogICAgcmV0dXJuIGZsYXR0ZW4oYXJyYXksIHNoYWxsb3csIFtdKTsKICB9OwoKICAvLyBSZXR1cm4gYSB2ZXJzaW9uIG9mIHRoZSBhcnJheSB0aGF0IGRvZXMgbm90IGNvbnRhaW4gdGhlIHNwZWNpZmllZCB2YWx1ZShzKS4KICBfLndpdGhvdXQgPSBmdW5jdGlvbihhcnJheSkgewogICAgcmV0dXJuIF8uZGlmZmVyZW5jZShhcnJheSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICB9OwoKICAvLyBTcGxpdCBhbiBhcnJheSBpbnRvIHR3byBhcnJheXM6IG9uZSB3aG9zZSBlbGVtZW50cyBhbGwgc2F0aXNmeSB0aGUgZ2l2ZW4KICAvLyBwcmVkaWNhdGUsIGFuZCBvbmUgd2hvc2UgZWxlbWVudHMgYWxsIGRvIG5vdCBzYXRpc2Z5IHRoZSBwcmVkaWNhdGUuCiAgXy5wYXJ0aXRpb24gPSBmdW5jdGlvbihhcnJheSwgcHJlZGljYXRlKSB7CiAgICB2YXIgcGFzcyA9IFtdLCBmYWlsID0gW107CiAgICBlYWNoKGFycmF5LCBmdW5jdGlvbihlbGVtKSB7CiAgICAgIChwcmVkaWNhdGUoZWxlbSkgPyBwYXNzIDogZmFpbCkucHVzaChlbGVtKTsKICAgIH0pOwogICAgcmV0dXJuIFtwYXNzLCBmYWlsXTsKICB9OwoKICAvLyBQcm9kdWNlIGEgZHVwbGljYXRlLWZyZWUgdmVyc2lvbiBvZiB0aGUgYXJyYXkuIElmIHRoZSBhcnJheSBoYXMgYWxyZWFkeQogIC8vIGJlZW4gc29ydGVkLCB5b3UgaGF2ZSB0aGUgb3B0aW9uIG9mIHVzaW5nIGEgZmFzdGVyIGFsZ29yaXRobS4KICAvLyBBbGlhc2VkIGFzIGB1bmlxdWVgLgogIF8udW5pcSA9IF8udW5pcXVlID0gZnVuY3Rpb24oYXJyYXksIGlzU29ydGVkLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaWYgKF8uaXNGdW5jdGlvbihpc1NvcnRlZCkpIHsKICAgICAgY29udGV4dCA9IGl0ZXJhdG9yOwogICAgICBpdGVyYXRvciA9IGlzU29ydGVkOwogICAgICBpc1NvcnRlZCA9IGZhbHNlOwogICAgfQogICAgdmFyIGluaXRpYWwgPSBpdGVyYXRvciA/IF8ubWFwKGFycmF5LCBpdGVyYXRvciwgY29udGV4dCkgOiBhcnJheTsKICAgIHZhciByZXN1bHRzID0gW107CiAgICB2YXIgc2VlbiA9IFtdOwogICAgZWFjaChpbml0aWFsLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgpIHsKICAgICAgaWYgKGlzU29ydGVkID8gKCFpbmRleCB8fCBzZWVuW3NlZW4ubGVuZ3RoIC0gMV0gIT09IHZhbHVlKSA6ICFfLmNvbnRhaW5zKHNlZW4sIHZhbHVlKSkgewogICAgICAgIHNlZW4ucHVzaCh2YWx1ZSk7CiAgICAgICAgcmVzdWx0cy5wdXNoKGFycmF5W2luZGV4XSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKCiAgLy8gUHJvZHVjZSBhbiBhcnJheSB0aGF0IGNvbnRhaW5zIHRoZSB1bmlvbjogZWFjaCBkaXN0aW5jdCBlbGVtZW50IGZyb20gYWxsIG9mCiAgLy8gdGhlIHBhc3NlZC1pbiBhcnJheXMuCiAgXy51bmlvbiA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIF8udW5pcShfLmZsYXR0ZW4oYXJndW1lbnRzLCB0cnVlKSk7CiAgfTsKCiAgLy8gUHJvZHVjZSBhbiBhcnJheSB0aGF0IGNvbnRhaW5zIGV2ZXJ5IGl0ZW0gc2hhcmVkIGJldHdlZW4gYWxsIHRoZQogIC8vIHBhc3NlZC1pbiBhcnJheXMuCiAgXy5pbnRlcnNlY3Rpb24gPSBmdW5jdGlvbihhcnJheSkgewogICAgdmFyIHJlc3QgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICByZXR1cm4gXy5maWx0ZXIoXy51bmlxKGFycmF5KSwgZnVuY3Rpb24oaXRlbSkgewogICAgICByZXR1cm4gXy5ldmVyeShyZXN0LCBmdW5jdGlvbihvdGhlcikgewogICAgICAgIHJldHVybiBfLmNvbnRhaW5zKG90aGVyLCBpdGVtKTsKICAgICAgfSk7CiAgICB9KTsKICB9OwoKICAvLyBUYWtlIHRoZSBkaWZmZXJlbmNlIGJldHdlZW4gb25lIGFycmF5IGFuZCBhIG51bWJlciBvZiBvdGhlciBhcnJheXMuCiAgLy8gT25seSB0aGUgZWxlbWVudHMgcHJlc2VudCBpbiBqdXN0IHRoZSBmaXJzdCBhcnJheSB3aWxsIHJlbWFpbi4KICBfLmRpZmZlcmVuY2UgPSBmdW5jdGlvbihhcnJheSkgewogICAgdmFyIHJlc3QgPSBjb25jYXQuYXBwbHkoQXJyYXlQcm90bywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIHJldHVybiBfLmZpbHRlcihhcnJheSwgZnVuY3Rpb24odmFsdWUpeyByZXR1cm4gIV8uY29udGFpbnMocmVzdCwgdmFsdWUpOyB9KTsKICB9OwoKICAvLyBaaXAgdG9nZXRoZXIgbXVsdGlwbGUgbGlzdHMgaW50byBhIHNpbmdsZSBhcnJheSAtLSBlbGVtZW50cyB0aGF0IHNoYXJlCiAgLy8gYW4gaW5kZXggZ28gdG9nZXRoZXIuCiAgXy56aXAgPSBmdW5jdGlvbigpIHsKICAgIHZhciBsZW5ndGggPSBfLm1heChfLnBsdWNrKGFyZ3VtZW50cywgJ2xlbmd0aCcpLmNvbmNhdCgwKSk7CiAgICB2YXIgcmVzdWx0cyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICByZXN1bHRzW2ldID0gXy5wbHVjayhhcmd1bWVudHMsICcnICsgaSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyBDb252ZXJ0cyBsaXN0cyBpbnRvIG9iamVjdHMuIFBhc3MgZWl0aGVyIGEgc2luZ2xlIGFycmF5IG9mIGBba2V5LCB2YWx1ZV1gCiAgLy8gcGFpcnMsIG9yIHR3byBwYXJhbGxlbCBhcnJheXMgb2YgdGhlIHNhbWUgbGVuZ3RoIC0tIG9uZSBvZiBrZXlzLCBhbmQgb25lIG9mCiAgLy8gdGhlIGNvcnJlc3BvbmRpbmcgdmFsdWVzLgogIF8ub2JqZWN0ID0gZnVuY3Rpb24obGlzdCwgdmFsdWVzKSB7CiAgICBpZiAobGlzdCA9PSBudWxsKSByZXR1cm4ge307CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gbGlzdC5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBpZiAodmFsdWVzKSB7CiAgICAgICAgcmVzdWx0W2xpc3RbaV1dID0gdmFsdWVzW2ldOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3VsdFtsaXN0W2ldWzBdXSA9IGxpc3RbaV1bMV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gSWYgdGhlIGJyb3dzZXIgZG9lc24ndCBzdXBwbHkgdXMgd2l0aCBpbmRleE9mIChJJ20gbG9va2luZyBhdCB5b3UsICoqTVNJRSoqKSwKICAvLyB3ZSBuZWVkIHRoaXMgZnVuY3Rpb24uIFJldHVybiB0aGUgcG9zaXRpb24gb2YgdGhlIGZpcnN0IG9jY3VycmVuY2Ugb2YgYW4KICAvLyBpdGVtIGluIGFuIGFycmF5LCBvciAtMSBpZiB0aGUgaXRlbSBpcyBub3QgaW5jbHVkZWQgaW4gdGhlIGFycmF5LgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBpbmRleE9mYCBpZiBhdmFpbGFibGUuCiAgLy8gSWYgdGhlIGFycmF5IGlzIGxhcmdlIGFuZCBhbHJlYWR5IGluIHNvcnQgb3JkZXIsIHBhc3MgYHRydWVgCiAgLy8gZm9yICoqaXNTb3J0ZWQqKiB0byB1c2UgYmluYXJ5IHNlYXJjaC4KICBfLmluZGV4T2YgPSBmdW5jdGlvbihhcnJheSwgaXRlbSwgaXNTb3J0ZWQpIHsKICAgIGlmIChhcnJheSA9PSBudWxsKSByZXR1cm4gLTE7CiAgICB2YXIgaSA9IDAsIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgIGlmIChpc1NvcnRlZCkgewogICAgICBpZiAodHlwZW9mIGlzU29ydGVkID09ICdudW1iZXInKSB7CiAgICAgICAgaSA9IChpc1NvcnRlZCA8IDAgPyBNYXRoLm1heCgwLCBsZW5ndGggKyBpc1NvcnRlZCkgOiBpc1NvcnRlZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaSA9IF8uc29ydGVkSW5kZXgoYXJyYXksIGl0ZW0pOwogICAgICAgIHJldHVybiBhcnJheVtpXSA9PT0gaXRlbSA/IGkgOiAtMTsKICAgICAgfQogICAgfQogICAgaWYgKG5hdGl2ZUluZGV4T2YgJiYgYXJyYXkuaW5kZXhPZiA9PT0gbmF0aXZlSW5kZXhPZikgcmV0dXJuIGFycmF5LmluZGV4T2YoaXRlbSwgaXNTb3J0ZWQpOwogICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgaWYgKGFycmF5W2ldID09PSBpdGVtKSByZXR1cm4gaTsKICAgIHJldHVybiAtMTsKICB9OwoKICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgbGFzdEluZGV4T2ZgIGlmIGF2YWlsYWJsZS4KICBfLmxhc3RJbmRleE9mID0gZnVuY3Rpb24oYXJyYXksIGl0ZW0sIGZyb20pIHsKICAgIGlmIChhcnJheSA9PSBudWxsKSByZXR1cm4gLTE7CiAgICB2YXIgaGFzSW5kZXggPSBmcm9tICE9IG51bGw7CiAgICBpZiAobmF0aXZlTGFzdEluZGV4T2YgJiYgYXJyYXkubGFzdEluZGV4T2YgPT09IG5hdGl2ZUxhc3RJbmRleE9mKSB7CiAgICAgIHJldHVybiBoYXNJbmRleCA/IGFycmF5Lmxhc3RJbmRleE9mKGl0ZW0sIGZyb20pIDogYXJyYXkubGFzdEluZGV4T2YoaXRlbSk7CiAgICB9CiAgICB2YXIgaSA9IChoYXNJbmRleCA/IGZyb20gOiBhcnJheS5sZW5ndGgpOwogICAgd2hpbGUgKGktLSkgaWYgKGFycmF5W2ldID09PSBpdGVtKSByZXR1cm4gaTsKICAgIHJldHVybiAtMTsKICB9OwoKICAvLyBHZW5lcmF0ZSBhbiBpbnRlZ2VyIEFycmF5IGNvbnRhaW5pbmcgYW4gYXJpdGhtZXRpYyBwcm9ncmVzc2lvbi4gQSBwb3J0IG9mCiAgLy8gdGhlIG5hdGl2ZSBQeXRob24gYHJhbmdlKClgIGZ1bmN0aW9uLiBTZWUKICAvLyBbdGhlIFB5dGhvbiBkb2N1bWVudGF0aW9uXShodHRwOi8vZG9jcy5weXRob24ub3JnL2xpYnJhcnkvZnVuY3Rpb25zLmh0bWwjcmFuZ2UpLgogIF8ucmFuZ2UgPSBmdW5jdGlvbihzdGFydCwgc3RvcCwgc3RlcCkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPD0gMSkgewogICAgICBzdG9wID0gc3RhcnQgfHwgMDsKICAgICAgc3RhcnQgPSAwOwogICAgfQogICAgc3RlcCA9IGFyZ3VtZW50c1syXSB8fCAxOwoKICAgIHZhciBsZW5ndGggPSBNYXRoLm1heChNYXRoLmNlaWwoKHN0b3AgLSBzdGFydCkgLyBzdGVwKSwgMCk7CiAgICB2YXIgaWR4ID0gMDsKICAgIHZhciByYW5nZSA9IG5ldyBBcnJheShsZW5ndGgpOwoKICAgIHdoaWxlKGlkeCA8IGxlbmd0aCkgewogICAgICByYW5nZVtpZHgrK10gPSBzdGFydDsKICAgICAgc3RhcnQgKz0gc3RlcDsKICAgIH0KCiAgICByZXR1cm4gcmFuZ2U7CiAgfTsKCiAgLy8gRnVuY3Rpb24gKGFoZW0pIEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBSZXVzYWJsZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgcHJvdG90eXBlIHNldHRpbmcuCiAgdmFyIGN0b3IgPSBmdW5jdGlvbigpe307CgogIC8vIENyZWF0ZSBhIGZ1bmN0aW9uIGJvdW5kIHRvIGEgZ2l2ZW4gb2JqZWN0IChhc3NpZ25pbmcgYHRoaXNgLCBhbmQgYXJndW1lbnRzLAogIC8vIG9wdGlvbmFsbHkpLiBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgRnVuY3Rpb24uYmluZGAgaWYKICAvLyBhdmFpbGFibGUuCiAgXy5iaW5kID0gZnVuY3Rpb24oZnVuYywgY29udGV4dCkgewogICAgdmFyIGFyZ3MsIGJvdW5kOwogICAgaWYgKG5hdGl2ZUJpbmQgJiYgZnVuYy5iaW5kID09PSBuYXRpdmVCaW5kKSByZXR1cm4gbmF0aXZlQmluZC5hcHBseShmdW5jLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgaWYgKCFfLmlzRnVuY3Rpb24oZnVuYykpIHRocm93IG5ldyBUeXBlRXJyb3I7CiAgICBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIGJvdW5kID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBib3VuZCkpIHJldHVybiBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICBjdG9yLnByb3RvdHlwZSA9IGZ1bmMucHJvdG90eXBlOwogICAgICB2YXIgc2VsZiA9IG5ldyBjdG9yOwogICAgICBjdG9yLnByb3RvdHlwZSA9IG51bGw7CiAgICAgIHZhciByZXN1bHQgPSBmdW5jLmFwcGx5KHNlbGYsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICBpZiAoT2JqZWN0KHJlc3VsdCkgPT09IHJlc3VsdCkgcmV0dXJuIHJlc3VsdDsKICAgICAgcmV0dXJuIHNlbGY7CiAgICB9OwogIH07CgogIC8vIFBhcnRpYWxseSBhcHBseSBhIGZ1bmN0aW9uIGJ5IGNyZWF0aW5nIGEgdmVyc2lvbiB0aGF0IGhhcyBoYWQgc29tZSBvZiBpdHMKICAvLyBhcmd1bWVudHMgcHJlLWZpbGxlZCwgd2l0aG91dCBjaGFuZ2luZyBpdHMgZHluYW1pYyBgdGhpc2AgY29udGV4dC4gXyBhY3RzCiAgLy8gYXMgYSBwbGFjZWhvbGRlciwgYWxsb3dpbmcgYW55IGNvbWJpbmF0aW9uIG9mIGFyZ3VtZW50cyB0byBiZSBwcmUtZmlsbGVkLgogIF8ucGFydGlhbCA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAgIHZhciBib3VuZEFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBwb3NpdGlvbiA9IDA7CiAgICAgIHZhciBhcmdzID0gYm91bmRBcmdzLnNsaWNlKCk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBhcmdzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKGFyZ3NbaV0gPT09IF8pIGFyZ3NbaV0gPSBhcmd1bWVudHNbcG9zaXRpb24rK107CiAgICAgIH0KICAgICAgd2hpbGUgKHBvc2l0aW9uIDwgYXJndW1lbnRzLmxlbmd0aCkgYXJncy5wdXNoKGFyZ3VtZW50c1twb3NpdGlvbisrXSk7CiAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfTsKICB9OwoKICAvLyBCaW5kIGEgbnVtYmVyIG9mIGFuIG9iamVjdCdzIG1ldGhvZHMgdG8gdGhhdCBvYmplY3QuIFJlbWFpbmluZyBhcmd1bWVudHMKICAvLyBhcmUgdGhlIG1ldGhvZCBuYW1lcyB0byBiZSBib3VuZC4gVXNlZnVsIGZvciBlbnN1cmluZyB0aGF0IGFsbCBjYWxsYmFja3MKICAvLyBkZWZpbmVkIG9uIGFuIG9iamVjdCBiZWxvbmcgdG8gaXQuCiAgXy5iaW5kQWxsID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgZnVuY3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICBpZiAoZnVuY3MubGVuZ3RoID09PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ2JpbmRBbGwgbXVzdCBiZSBwYXNzZWQgZnVuY3Rpb24gbmFtZXMnKTsKICAgIGVhY2goZnVuY3MsIGZ1bmN0aW9uKGYpIHsgb2JqW2ZdID0gXy5iaW5kKG9ialtmXSwgb2JqKTsgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIE1lbW9pemUgYW4gZXhwZW5zaXZlIGZ1bmN0aW9uIGJ5IHN0b3JpbmcgaXRzIHJlc3VsdHMuCiAgXy5tZW1vaXplID0gZnVuY3Rpb24oZnVuYywgaGFzaGVyKSB7CiAgICB2YXIgbWVtbyA9IHt9OwogICAgaGFzaGVyIHx8IChoYXNoZXIgPSBfLmlkZW50aXR5KTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGtleSA9IGhhc2hlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICByZXR1cm4gXy5oYXMobWVtbywga2V5KSA/IG1lbW9ba2V5XSA6IChtZW1vW2tleV0gPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgfTsKICB9OwoKICAvLyBEZWxheXMgYSBmdW5jdGlvbiBmb3IgdGhlIGdpdmVuIG51bWJlciBvZiBtaWxsaXNlY29uZHMsIGFuZCB0aGVuIGNhbGxzCiAgLy8gaXQgd2l0aCB0aGUgYXJndW1lbnRzIHN1cHBsaWVkLgogIF8uZGVsYXkgPSBmdW5jdGlvbihmdW5jLCB3YWl0KSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7IHJldHVybiBmdW5jLmFwcGx5KG51bGwsIGFyZ3MpOyB9LCB3YWl0KTsKICB9OwoKICAvLyBEZWZlcnMgYSBmdW5jdGlvbiwgc2NoZWR1bGluZyBpdCB0byBydW4gYWZ0ZXIgdGhlIGN1cnJlbnQgY2FsbCBzdGFjayBoYXMKICAvLyBjbGVhcmVkLgogIF8uZGVmZXIgPSBmdW5jdGlvbihmdW5jKSB7CiAgICByZXR1cm4gXy5kZWxheS5hcHBseShfLCBbZnVuYywgMV0uY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSkpOwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiwgdGhhdCwgd2hlbiBpbnZva2VkLCB3aWxsIG9ubHkgYmUgdHJpZ2dlcmVkIGF0IG1vc3Qgb25jZQogIC8vIGR1cmluZyBhIGdpdmVuIHdpbmRvdyBvZiB0aW1lLiBOb3JtYWxseSwgdGhlIHRocm90dGxlZCBmdW5jdGlvbiB3aWxsIHJ1bgogIC8vIGFzIG11Y2ggYXMgaXQgY2FuLCB3aXRob3V0IGV2ZXIgZ29pbmcgbW9yZSB0aGFuIG9uY2UgcGVyIGB3YWl0YCBkdXJhdGlvbjsKICAvLyBidXQgaWYgeW91J2QgbGlrZSB0byBkaXNhYmxlIHRoZSBleGVjdXRpb24gb24gdGhlIGxlYWRpbmcgZWRnZSwgcGFzcwogIC8vIGB7bGVhZGluZzogZmFsc2V9YC4gVG8gZGlzYWJsZSBleGVjdXRpb24gb24gdGhlIHRyYWlsaW5nIGVkZ2UsIGRpdHRvLgogIF8udGhyb3R0bGUgPSBmdW5jdGlvbihmdW5jLCB3YWl0LCBvcHRpb25zKSB7CiAgICB2YXIgY29udGV4dCwgYXJncywgcmVzdWx0OwogICAgdmFyIHRpbWVvdXQgPSBudWxsOwogICAgdmFyIHByZXZpb3VzID0gMDsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbigpIHsKICAgICAgcHJldmlvdXMgPSBvcHRpb25zLmxlYWRpbmcgPT09IGZhbHNlID8gMCA6IF8ubm93KCk7CiAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICBjb250ZXh0ID0gYXJncyA9IG51bGw7CiAgICB9OwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgbm93ID0gXy5ub3coKTsKICAgICAgaWYgKCFwcmV2aW91cyAmJiBvcHRpb25zLmxlYWRpbmcgPT09IGZhbHNlKSBwcmV2aW91cyA9IG5vdzsKICAgICAgdmFyIHJlbWFpbmluZyA9IHdhaXQgLSAobm93IC0gcHJldmlvdXMpOwogICAgICBjb250ZXh0ID0gdGhpczsKICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgaWYgKHJlbWFpbmluZyA8PSAwKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgIHByZXZpb3VzID0gbm93OwogICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgY29udGV4dCA9IGFyZ3MgPSBudWxsOwogICAgICB9IGVsc2UgaWYgKCF0aW1lb3V0ICYmIG9wdGlvbnMudHJhaWxpbmcgIT09IGZhbHNlKSB7CiAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHJlbWFpbmluZyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0LCBhcyBsb25nIGFzIGl0IGNvbnRpbnVlcyB0byBiZSBpbnZva2VkLCB3aWxsIG5vdAogIC8vIGJlIHRyaWdnZXJlZC4gVGhlIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIGFmdGVyIGl0IHN0b3BzIGJlaW5nIGNhbGxlZCBmb3IKICAvLyBOIG1pbGxpc2Vjb25kcy4gSWYgYGltbWVkaWF0ZWAgaXMgcGFzc2VkLCB0cmlnZ2VyIHRoZSBmdW5jdGlvbiBvbiB0aGUKICAvLyBsZWFkaW5nIGVkZ2UsIGluc3RlYWQgb2YgdGhlIHRyYWlsaW5nLgogIF8uZGVib3VuY2UgPSBmdW5jdGlvbihmdW5jLCB3YWl0LCBpbW1lZGlhdGUpIHsKICAgIHZhciB0aW1lb3V0LCBhcmdzLCBjb250ZXh0LCB0aW1lc3RhbXAsIHJlc3VsdDsKCiAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGxhc3QgPSBfLm5vdygpIC0gdGltZXN0YW1wOwogICAgICBpZiAobGFzdCA8IHdhaXQpIHsKICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCAtIGxhc3QpOwogICAgICB9IGVsc2UgewogICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgIGlmICghaW1tZWRpYXRlKSB7CiAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgY29udGV4dCA9IGFyZ3MgPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGNvbnRleHQgPSB0aGlzOwogICAgICBhcmdzID0gYXJndW1lbnRzOwogICAgICB0aW1lc3RhbXAgPSBfLm5vdygpOwogICAgICB2YXIgY2FsbE5vdyA9IGltbWVkaWF0ZSAmJiAhdGltZW91dDsKICAgICAgaWYgKCF0aW1lb3V0KSB7CiAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQpOwogICAgICB9CiAgICAgIGlmIChjYWxsTm93KSB7CiAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICBjb250ZXh0ID0gYXJncyA9IG51bGw7CiAgICAgIH0KCiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgZXhlY3V0ZWQgYXQgbW9zdCBvbmUgdGltZSwgbm8gbWF0dGVyIGhvdwogIC8vIG9mdGVuIHlvdSBjYWxsIGl0LiBVc2VmdWwgZm9yIGxhenkgaW5pdGlhbGl6YXRpb24uCiAgXy5vbmNlID0gZnVuY3Rpb24oZnVuYykgewogICAgdmFyIHJhbiA9IGZhbHNlLCBtZW1vOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBpZiAocmFuKSByZXR1cm4gbWVtbzsKICAgICAgcmFuID0gdHJ1ZTsKICAgICAgbWVtbyA9IGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgZnVuYyA9IG51bGw7CiAgICAgIHJldHVybiBtZW1vOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIHRoZSBmaXJzdCBmdW5jdGlvbiBwYXNzZWQgYXMgYW4gYXJndW1lbnQgdG8gdGhlIHNlY29uZCwKICAvLyBhbGxvd2luZyB5b3UgdG8gYWRqdXN0IGFyZ3VtZW50cywgcnVuIGNvZGUgYmVmb3JlIGFuZCBhZnRlciwgYW5kCiAgLy8gY29uZGl0aW9uYWxseSBleGVjdXRlIHRoZSBvcmlnaW5hbCBmdW5jdGlvbi4KICBfLndyYXAgPSBmdW5jdGlvbihmdW5jLCB3cmFwcGVyKSB7CiAgICByZXR1cm4gXy5wYXJ0aWFsKHdyYXBwZXIsIGZ1bmMpOwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IGlzIHRoZSBjb21wb3NpdGlvbiBvZiBhIGxpc3Qgb2YgZnVuY3Rpb25zLCBlYWNoCiAgLy8gY29uc3VtaW5nIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGZ1bmN0aW9uIHRoYXQgZm9sbG93cy4KICBfLmNvbXBvc2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBmdW5jcyA9IGFyZ3VtZW50czsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIGZvciAodmFyIGkgPSBmdW5jcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIGFyZ3MgPSBbZnVuY3NbaV0uYXBwbHkodGhpcywgYXJncyldOwogICAgICB9CiAgICAgIHJldHVybiBhcmdzWzBdOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgYWZ0ZXIgYmVpbmcgY2FsbGVkIE4gdGltZXMuCiAgXy5hZnRlciA9IGZ1bmN0aW9uKHRpbWVzLCBmdW5jKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGlmICgtLXRpbWVzIDwgMSkgewogICAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH07CiAgfTsKCiAgLy8gT2JqZWN0IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gUmV0cmlldmUgdGhlIG5hbWVzIG9mIGFuIG9iamVjdCdzIHByb3BlcnRpZXMuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYE9iamVjdC5rZXlzYAogIF8ua2V5cyA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCFfLmlzT2JqZWN0KG9iaikpIHJldHVybiBbXTsKICAgIGlmIChuYXRpdmVLZXlzKSByZXR1cm4gbmF0aXZlS2V5cyhvYmopOwogICAgdmFyIGtleXMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIGtleXMucHVzaChrZXkpOwogICAgcmV0dXJuIGtleXM7CiAgfTsKCiAgLy8gUmV0cmlldmUgdGhlIHZhbHVlcyBvZiBhbiBvYmplY3QncyBwcm9wZXJ0aWVzLgogIF8udmFsdWVzID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwogICAgdmFyIGxlbmd0aCA9IGtleXMubGVuZ3RoOwogICAgdmFyIHZhbHVlcyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICB2YWx1ZXNbaV0gPSBvYmpba2V5c1tpXV07CiAgICB9CiAgICByZXR1cm4gdmFsdWVzOwogIH07CgogIC8vIENvbnZlcnQgYW4gb2JqZWN0IGludG8gYSBsaXN0IG9mIGBba2V5LCB2YWx1ZV1gIHBhaXJzLgogIF8ucGFpcnMgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICB2YXIgbGVuZ3RoID0ga2V5cy5sZW5ndGg7CiAgICB2YXIgcGFpcnMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgcGFpcnNbaV0gPSBba2V5c1tpXSwgb2JqW2tleXNbaV1dXTsKICAgIH0KICAgIHJldHVybiBwYWlyczsKICB9OwoKICAvLyBJbnZlcnQgdGhlIGtleXMgYW5kIHZhbHVlcyBvZiBhbiBvYmplY3QuIFRoZSB2YWx1ZXMgbXVzdCBiZSBzZXJpYWxpemFibGUuCiAgXy5pbnZlcnQgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0ga2V5cy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICByZXN1bHRbb2JqW2tleXNbaV1dXSA9IGtleXNbaV07CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIFJldHVybiBhIHNvcnRlZCBsaXN0IG9mIHRoZSBmdW5jdGlvbiBuYW1lcyBhdmFpbGFibGUgb24gdGhlIG9iamVjdC4KICAvLyBBbGlhc2VkIGFzIGBtZXRob2RzYAogIF8uZnVuY3Rpb25zID0gXy5tZXRob2RzID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgbmFtZXMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihvYmpba2V5XSkpIG5hbWVzLnB1c2goa2V5KTsKICAgIH0KICAgIHJldHVybiBuYW1lcy5zb3J0KCk7CiAgfTsKCiAgLy8gRXh0ZW5kIGEgZ2l2ZW4gb2JqZWN0IHdpdGggYWxsIHRoZSBwcm9wZXJ0aWVzIGluIHBhc3NlZC1pbiBvYmplY3QocykuCiAgXy5leHRlbmQgPSBmdW5jdGlvbihvYmopIHsKICAgIGVhY2goc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLCBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgIGZvciAodmFyIHByb3AgaW4gc291cmNlKSB7CiAgICAgICAgICBvYmpbcHJvcF0gPSBzb3VyY2VbcHJvcF07CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBvYmo7CiAgfTsKCiAgLy8gUmV0dXJuIGEgY29weSBvZiB0aGUgb2JqZWN0IG9ubHkgY29udGFpbmluZyB0aGUgd2hpdGVsaXN0ZWQgcHJvcGVydGllcy4KICBfLnBpY2sgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBjb3B5ID0ge307CiAgICB2YXIga2V5cyA9IGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgZWFjaChrZXlzLCBmdW5jdGlvbihrZXkpIHsKICAgICAgaWYgKGtleSBpbiBvYmopIGNvcHlba2V5XSA9IG9ialtrZXldOwogICAgfSk7CiAgICByZXR1cm4gY29weTsKICB9OwoKICAgLy8gUmV0dXJuIGEgY29weSBvZiB0aGUgb2JqZWN0IHdpdGhvdXQgdGhlIGJsYWNrbGlzdGVkIHByb3BlcnRpZXMuCiAgXy5vbWl0ID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgY29weSA9IHt9OwogICAgdmFyIGtleXMgPSBjb25jYXQuYXBwbHkoQXJyYXlQcm90bywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgaWYgKCFfLmNvbnRhaW5zKGtleXMsIGtleSkpIGNvcHlba2V5XSA9IG9ialtrZXldOwogICAgfQogICAgcmV0dXJuIGNvcHk7CiAgfTsKCiAgLy8gRmlsbCBpbiBhIGdpdmVuIG9iamVjdCB3aXRoIGRlZmF1bHQgcHJvcGVydGllcy4KICBfLmRlZmF1bHRzID0gZnVuY3Rpb24ob2JqKSB7CiAgICBlYWNoKHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSwgZnVuY3Rpb24oc291cmNlKSB7CiAgICAgIGlmIChzb3VyY2UpIHsKICAgICAgICBmb3IgKHZhciBwcm9wIGluIHNvdXJjZSkgewogICAgICAgICAgaWYgKG9ialtwcm9wXSA9PT0gdm9pZCAwKSBvYmpbcHJvcF0gPSBzb3VyY2VbcHJvcF07CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBvYmo7CiAgfTsKCiAgLy8gQ3JlYXRlIGEgKHNoYWxsb3ctY2xvbmVkKSBkdXBsaWNhdGUgb2YgYW4gb2JqZWN0LgogIF8uY2xvbmUgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmICghXy5pc09iamVjdChvYmopKSByZXR1cm4gb2JqOwogICAgcmV0dXJuIF8uaXNBcnJheShvYmopID8gb2JqLnNsaWNlKCkgOiBfLmV4dGVuZCh7fSwgb2JqKTsKICB9OwoKICAvLyBJbnZva2VzIGludGVyY2VwdG9yIHdpdGggdGhlIG9iaiwgYW5kIHRoZW4gcmV0dXJucyBvYmouCiAgLy8gVGhlIHByaW1hcnkgcHVycG9zZSBvZiB0aGlzIG1ldGhvZCBpcyB0byAidGFwIGludG8iIGEgbWV0aG9kIGNoYWluLCBpbgogIC8vIG9yZGVyIHRvIHBlcmZvcm0gb3BlcmF0aW9ucyBvbiBpbnRlcm1lZGlhdGUgcmVzdWx0cyB3aXRoaW4gdGhlIGNoYWluLgogIF8udGFwID0gZnVuY3Rpb24ob2JqLCBpbnRlcmNlcHRvcikgewogICAgaW50ZXJjZXB0b3Iob2JqKTsKICAgIHJldHVybiBvYmo7CiAgfTsKCiAgLy8gSW50ZXJuYWwgcmVjdXJzaXZlIGNvbXBhcmlzb24gZnVuY3Rpb24gZm9yIGBpc0VxdWFsYC4KICB2YXIgZXEgPSBmdW5jdGlvbihhLCBiLCBhU3RhY2ssIGJTdGFjaykgewogICAgLy8gSWRlbnRpY2FsIG9iamVjdHMgYXJlIGVxdWFsLiBgMCA9PT0gLTBgLCBidXQgdGhleSBhcmVuJ3QgaWRlbnRpY2FsLgogICAgLy8gU2VlIHRoZSBbSGFybW9ueSBgZWdhbGAgcHJvcG9zYWxdKGh0dHA6Ly93aWtpLmVjbWFzY3JpcHQub3JnL2Rva3UucGhwP2lkPWhhcm1vbnk6ZWdhbCkuCiAgICBpZiAoYSA9PT0gYikgcmV0dXJuIGEgIT09IDAgfHwgMSAvIGEgPT0gMSAvIGI7CiAgICAvLyBBIHN0cmljdCBjb21wYXJpc29uIGlzIG5lY2Vzc2FyeSBiZWNhdXNlIGBudWxsID09IHVuZGVmaW5lZGAuCiAgICBpZiAoYSA9PSBudWxsIHx8IGIgPT0gbnVsbCkgcmV0dXJuIGEgPT09IGI7CiAgICAvLyBVbndyYXAgYW55IHdyYXBwZWQgb2JqZWN0cy4KICAgIGlmIChhIGluc3RhbmNlb2YgXykgYSA9IGEuX3dyYXBwZWQ7CiAgICBpZiAoYiBpbnN0YW5jZW9mIF8pIGIgPSBiLl93cmFwcGVkOwogICAgLy8gQ29tcGFyZSBgW1tDbGFzc11dYCBuYW1lcy4KICAgIHZhciBjbGFzc05hbWUgPSB0b1N0cmluZy5jYWxsKGEpOwogICAgaWYgKGNsYXNzTmFtZSAhPSB0b1N0cmluZy5jYWxsKGIpKSByZXR1cm4gZmFsc2U7CiAgICBzd2l0Y2ggKGNsYXNzTmFtZSkgewogICAgICAvLyBTdHJpbmdzLCBudW1iZXJzLCBkYXRlcywgYW5kIGJvb2xlYW5zIGFyZSBjb21wYXJlZCBieSB2YWx1ZS4KICAgICAgY2FzZSAnW29iamVjdCBTdHJpbmddJzoKICAgICAgICAvLyBQcmltaXRpdmVzIGFuZCB0aGVpciBjb3JyZXNwb25kaW5nIG9iamVjdCB3cmFwcGVycyBhcmUgZXF1aXZhbGVudDsgdGh1cywgYCI1ImAgaXMKICAgICAgICAvLyBlcXVpdmFsZW50IHRvIGBuZXcgU3RyaW5nKCI1IilgLgogICAgICAgIHJldHVybiBhID09IFN0cmluZyhiKTsKICAgICAgY2FzZSAnW29iamVjdCBOdW1iZXJdJzoKICAgICAgICAvLyBgTmFOYHMgYXJlIGVxdWl2YWxlbnQsIGJ1dCBub24tcmVmbGV4aXZlLiBBbiBgZWdhbGAgY29tcGFyaXNvbiBpcyBwZXJmb3JtZWQgZm9yCiAgICAgICAgLy8gb3RoZXIgbnVtZXJpYyB2YWx1ZXMuCiAgICAgICAgcmV0dXJuIGEgIT0gK2EgPyBiICE9ICtiIDogKGEgPT0gMCA/IDEgLyBhID09IDEgLyBiIDogYSA9PSArYik7CiAgICAgIGNhc2UgJ1tvYmplY3QgRGF0ZV0nOgogICAgICBjYXNlICdbb2JqZWN0IEJvb2xlYW5dJzoKICAgICAgICAvLyBDb2VyY2UgZGF0ZXMgYW5kIGJvb2xlYW5zIHRvIG51bWVyaWMgcHJpbWl0aXZlIHZhbHVlcy4gRGF0ZXMgYXJlIGNvbXBhcmVkIGJ5IHRoZWlyCiAgICAgICAgLy8gbWlsbGlzZWNvbmQgcmVwcmVzZW50YXRpb25zLiBOb3RlIHRoYXQgaW52YWxpZCBkYXRlcyB3aXRoIG1pbGxpc2Vjb25kIHJlcHJlc2VudGF0aW9ucwogICAgICAgIC8vIG9mIGBOYU5gIGFyZSBub3QgZXF1aXZhbGVudC4KICAgICAgICByZXR1cm4gK2EgPT0gK2I7CiAgICAgIC8vIFJlZ0V4cHMgYXJlIGNvbXBhcmVkIGJ5IHRoZWlyIHNvdXJjZSBwYXR0ZXJucyBhbmQgZmxhZ3MuCiAgICAgIGNhc2UgJ1tvYmplY3QgUmVnRXhwXSc6CiAgICAgICAgcmV0dXJuIGEuc291cmNlID09IGIuc291cmNlICYmCiAgICAgICAgICAgICAgIGEuZ2xvYmFsID09IGIuZ2xvYmFsICYmCiAgICAgICAgICAgICAgIGEubXVsdGlsaW5lID09IGIubXVsdGlsaW5lICYmCiAgICAgICAgICAgICAgIGEuaWdub3JlQ2FzZSA9PSBiLmlnbm9yZUNhc2U7CiAgICB9CiAgICBpZiAodHlwZW9mIGEgIT0gJ29iamVjdCcgfHwgdHlwZW9mIGIgIT0gJ29iamVjdCcpIHJldHVybiBmYWxzZTsKICAgIC8vIEFzc3VtZSBlcXVhbGl0eSBmb3IgY3ljbGljIHN0cnVjdHVyZXMuIFRoZSBhbGdvcml0aG0gZm9yIGRldGVjdGluZyBjeWNsaWMKICAgIC8vIHN0cnVjdHVyZXMgaXMgYWRhcHRlZCBmcm9tIEVTIDUuMSBzZWN0aW9uIDE1LjEyLjMsIGFic3RyYWN0IG9wZXJhdGlvbiBgSk9gLgogICAgdmFyIGxlbmd0aCA9IGFTdGFjay5sZW5ndGg7CiAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgLy8gTGluZWFyIHNlYXJjaC4gUGVyZm9ybWFuY2UgaXMgaW52ZXJzZWx5IHByb3BvcnRpb25hbCB0byB0aGUgbnVtYmVyIG9mCiAgICAgIC8vIHVuaXF1ZSBuZXN0ZWQgc3RydWN0dXJlcy4KICAgICAgaWYgKGFTdGFja1tsZW5ndGhdID09IGEpIHJldHVybiBiU3RhY2tbbGVuZ3RoXSA9PSBiOwogICAgfQogICAgLy8gT2JqZWN0cyB3aXRoIGRpZmZlcmVudCBjb25zdHJ1Y3RvcnMgYXJlIG5vdCBlcXVpdmFsZW50LCBidXQgYE9iamVjdGBzCiAgICAvLyBmcm9tIGRpZmZlcmVudCBmcmFtZXMgYXJlLgogICAgdmFyIGFDdG9yID0gYS5jb25zdHJ1Y3RvciwgYkN0b3IgPSBiLmNvbnN0cnVjdG9yOwogICAgaWYgKGFDdG9yICE9PSBiQ3RvciAmJiAhKF8uaXNGdW5jdGlvbihhQ3RvcikgJiYgKGFDdG9yIGluc3RhbmNlb2YgYUN0b3IpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5pc0Z1bmN0aW9uKGJDdG9yKSAmJiAoYkN0b3IgaW5zdGFuY2VvZiBiQ3RvcikpCiAgICAgICAgICAgICAgICAgICAgICAgICYmICgnY29uc3RydWN0b3InIGluIGEgJiYgJ2NvbnN0cnVjdG9yJyBpbiBiKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICAvLyBBZGQgdGhlIGZpcnN0IG9iamVjdCB0byB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMuCiAgICBhU3RhY2sucHVzaChhKTsKICAgIGJTdGFjay5wdXNoKGIpOwogICAgdmFyIHNpemUgPSAwLCByZXN1bHQgPSB0cnVlOwogICAgLy8gUmVjdXJzaXZlbHkgY29tcGFyZSBvYmplY3RzIGFuZCBhcnJheXMuCiAgICBpZiAoY2xhc3NOYW1lID09ICdbb2JqZWN0IEFycmF5XScpIHsKICAgICAgLy8gQ29tcGFyZSBhcnJheSBsZW5ndGhzIHRvIGRldGVybWluZSBpZiBhIGRlZXAgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkuCiAgICAgIHNpemUgPSBhLmxlbmd0aDsKICAgICAgcmVzdWx0ID0gc2l6ZSA9PSBiLmxlbmd0aDsKICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIC8vIERlZXAgY29tcGFyZSB0aGUgY29udGVudHMsIGlnbm9yaW5nIG5vbi1udW1lcmljIHByb3BlcnRpZXMuCiAgICAgICAgd2hpbGUgKHNpemUtLSkgewogICAgICAgICAgaWYgKCEocmVzdWx0ID0gZXEoYVtzaXplXSwgYltzaXplXSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBEZWVwIGNvbXBhcmUgb2JqZWN0cy4KICAgICAgZm9yICh2YXIga2V5IGluIGEpIHsKICAgICAgICBpZiAoXy5oYXMoYSwga2V5KSkgewogICAgICAgICAgLy8gQ291bnQgdGhlIGV4cGVjdGVkIG51bWJlciBvZiBwcm9wZXJ0aWVzLgogICAgICAgICAgc2l6ZSsrOwogICAgICAgICAgLy8gRGVlcCBjb21wYXJlIGVhY2ggbWVtYmVyLgogICAgICAgICAgaWYgKCEocmVzdWx0ID0gXy5oYXMoYiwga2V5KSAmJiBlcShhW2tleV0sIGJba2V5XSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIEVuc3VyZSB0aGF0IGJvdGggb2JqZWN0cyBjb250YWluIHRoZSBzYW1lIG51bWJlciBvZiBwcm9wZXJ0aWVzLgogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgZm9yIChrZXkgaW4gYikgewogICAgICAgICAgaWYgKF8uaGFzKGIsIGtleSkgJiYgIShzaXplLS0pKSBicmVhazsKICAgICAgICB9CiAgICAgICAgcmVzdWx0ID0gIXNpemU7CiAgICAgIH0KICAgIH0KICAgIC8vIFJlbW92ZSB0aGUgZmlyc3Qgb2JqZWN0IGZyb20gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgogICAgYVN0YWNrLnBvcCgpOwogICAgYlN0YWNrLnBvcCgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBQZXJmb3JtIGEgZGVlcCBjb21wYXJpc29uIHRvIGNoZWNrIGlmIHR3byBvYmplY3RzIGFyZSBlcXVhbC4KICBfLmlzRXF1YWwgPSBmdW5jdGlvbihhLCBiKSB7CiAgICByZXR1cm4gZXEoYSwgYiwgW10sIFtdKTsKICB9OwoKICAvLyBJcyBhIGdpdmVuIGFycmF5LCBzdHJpbmcsIG9yIG9iamVjdCBlbXB0eT8KICAvLyBBbiAiZW1wdHkiIG9iamVjdCBoYXMgbm8gZW51bWVyYWJsZSBvd24tcHJvcGVydGllcy4KICBfLmlzRW1wdHkgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHRydWU7CiAgICBpZiAoXy5pc0FycmF5KG9iaikgfHwgXy5pc1N0cmluZyhvYmopKSByZXR1cm4gb2JqLmxlbmd0aCA9PT0gMDsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIHJldHVybiBmYWxzZTsKICAgIHJldHVybiB0cnVlOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBET00gZWxlbWVudD8KICBfLmlzRWxlbWVudCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuICEhKG9iaiAmJiBvYmoubm9kZVR5cGUgPT09IDEpOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYW4gYXJyYXk/CiAgLy8gRGVsZWdhdGVzIHRvIEVDTUE1J3MgbmF0aXZlIEFycmF5LmlzQXJyYXkKICBfLmlzQXJyYXkgPSBuYXRpdmVJc0FycmF5IHx8IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PSAnW29iamVjdCBBcnJheV0nOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFyaWFibGUgYW4gb2JqZWN0PwogIF8uaXNPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IE9iamVjdChvYmopOwogIH07CgogIC8vIEFkZCBzb21lIGlzVHlwZSBtZXRob2RzOiBpc0FyZ3VtZW50cywgaXNGdW5jdGlvbiwgaXNTdHJpbmcsIGlzTnVtYmVyLCBpc0RhdGUsIGlzUmVnRXhwLgogIGVhY2goWydBcmd1bWVudHMnLCAnRnVuY3Rpb24nLCAnU3RyaW5nJywgJ051bWJlcicsICdEYXRlJywgJ1JlZ0V4cCddLCBmdW5jdGlvbihuYW1lKSB7CiAgICBfWydpcycgKyBuYW1lXSA9IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0ICcgKyBuYW1lICsgJ10nOwogICAgfTsKICB9KTsKCiAgLy8gRGVmaW5lIGEgZmFsbGJhY2sgdmVyc2lvbiBvZiB0aGUgbWV0aG9kIGluIGJyb3dzZXJzIChhaGVtLCBJRSksIHdoZXJlCiAgLy8gdGhlcmUgaXNuJ3QgYW55IGluc3BlY3RhYmxlICJBcmd1bWVudHMiIHR5cGUuCiAgaWYgKCFfLmlzQXJndW1lbnRzKGFyZ3VtZW50cykpIHsKICAgIF8uaXNBcmd1bWVudHMgPSBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuICEhKG9iaiAmJiBfLmhhcyhvYmosICdjYWxsZWUnKSk7CiAgICB9OwogIH0KCiAgLy8gT3B0aW1pemUgYGlzRnVuY3Rpb25gIGlmIGFwcHJvcHJpYXRlLgogIGlmICh0eXBlb2YgKC8uLykgIT09ICdmdW5jdGlvbicpIHsKICAgIF8uaXNGdW5jdGlvbiA9IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gJ2Z1bmN0aW9uJzsKICAgIH07CiAgfQoKICAvLyBJcyBhIGdpdmVuIG9iamVjdCBhIGZpbml0ZSBudW1iZXI/CiAgXy5pc0Zpbml0ZSA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIGlzRmluaXRlKG9iaikgJiYgIWlzTmFOKHBhcnNlRmxvYXQob2JqKSk7CiAgfTsKCiAgLy8gSXMgdGhlIGdpdmVuIHZhbHVlIGBOYU5gPyAoTmFOIGlzIHRoZSBvbmx5IG51bWJlciB3aGljaCBkb2VzIG5vdCBlcXVhbCBpdHNlbGYpLgogIF8uaXNOYU4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBfLmlzTnVtYmVyKG9iaikgJiYgb2JqICE9ICtvYmo7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhIGJvb2xlYW4/CiAgXy5pc0Jvb2xlYW4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IHRydWUgfHwgb2JqID09PSBmYWxzZSB8fCB0b1N0cmluZy5jYWxsKG9iaikgPT0gJ1tvYmplY3QgQm9vbGVhbl0nOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgZXF1YWwgdG8gbnVsbD8KICBfLmlzTnVsbCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gbnVsbDsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhcmlhYmxlIHVuZGVmaW5lZD8KICBfLmlzVW5kZWZpbmVkID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSB2b2lkIDA7CiAgfTsKCiAgLy8gU2hvcnRjdXQgZnVuY3Rpb24gZm9yIGNoZWNraW5nIGlmIGFuIG9iamVjdCBoYXMgYSBnaXZlbiBwcm9wZXJ0eSBkaXJlY3RseQogIC8vIG9uIGl0c2VsZiAoaW4gb3RoZXIgd29yZHMsIG5vdCBvbiBhIHByb3RvdHlwZSkuCiAgXy5oYXMgPSBmdW5jdGlvbihvYmosIGtleSkgewogICAgcmV0dXJuIGhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpOwogIH07CgogIC8vIFV0aWxpdHkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gUnVuIFVuZGVyc2NvcmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYF9gIHZhcmlhYmxlIHRvIGl0cwogIC8vIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdC4KICBfLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICAgIHJvb3QuXyA9IHByZXZpb3VzVW5kZXJzY29yZTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIEtlZXAgdGhlIGlkZW50aXR5IGZ1bmN0aW9uIGFyb3VuZCBmb3IgZGVmYXVsdCBpdGVyYXRvcnMuCiAgXy5pZGVudGl0eSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfTsKCiAgXy5jb25zdGFudCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdmFsdWU7CiAgICB9OwogIH07CgogIF8ucHJvcGVydHkgPSBmdW5jdGlvbihrZXkpIHsKICAgIHJldHVybiBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuIG9ialtrZXldOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgcHJlZGljYXRlIGZvciBjaGVja2luZyB3aGV0aGVyIGFuIG9iamVjdCBoYXMgYSBnaXZlbiBzZXQgb2YgYGtleTp2YWx1ZWAgcGFpcnMuCiAgXy5tYXRjaGVzID0gZnVuY3Rpb24oYXR0cnMpIHsKICAgIHJldHVybiBmdW5jdGlvbihvYmopIHsKICAgICAgaWYgKG9iaiA9PT0gYXR0cnMpIHJldHVybiB0cnVlOyAvL2F2b2lkIGNvbXBhcmluZyBhbiBvYmplY3QgdG8gaXRzZWxmLgogICAgICBmb3IgKHZhciBrZXkgaW4gYXR0cnMpIHsKICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gb2JqW2tleV0pCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfTsKCiAgLy8gUnVuIGEgZnVuY3Rpb24gKipuKiogdGltZXMuCiAgXy50aW1lcyA9IGZ1bmN0aW9uKG4sIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgYWNjdW0gPSBBcnJheShNYXRoLm1heCgwLCBuKSk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG47IGkrKykgYWNjdW1baV0gPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIGkpOwogICAgcmV0dXJuIGFjY3VtOwogIH07CgogIC8vIFJldHVybiBhIHJhbmRvbSBpbnRlZ2VyIGJldHdlZW4gbWluIGFuZCBtYXggKGluY2x1c2l2ZSkuCiAgXy5yYW5kb20gPSBmdW5jdGlvbihtaW4sIG1heCkgewogICAgaWYgKG1heCA9PSBudWxsKSB7CiAgICAgIG1heCA9IG1pbjsKICAgICAgbWluID0gMDsKICAgIH0KICAgIHJldHVybiBtaW4gKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluICsgMSkpOwogIH07CgogIC8vIEEgKHBvc3NpYmx5IGZhc3Rlcikgd2F5IHRvIGdldCB0aGUgY3VycmVudCB0aW1lc3RhbXAgYXMgYW4gaW50ZWdlci4KICBfLm5vdyA9IERhdGUubm93IHx8IGZ1bmN0aW9uKCkgeyByZXR1cm4gbmV3IERhdGUoKS5nZXRUaW1lKCk7IH07CgogIC8vIExpc3Qgb2YgSFRNTCBlbnRpdGllcyBmb3IgZXNjYXBpbmcuCiAgdmFyIGVudGl0eU1hcCA9IHsKICAgIGVzY2FwZTogewogICAgICAnJic6ICcmYW1wOycsCiAgICAgICc8JzogJyZsdDsnLAogICAgICAnPic6ICcmZ3Q7JywKICAgICAgJyInOiAnJnF1b3Q7JywKICAgICAgIiciOiAnJiN4Mjc7JwogICAgfQogIH07CiAgZW50aXR5TWFwLnVuZXNjYXBlID0gXy5pbnZlcnQoZW50aXR5TWFwLmVzY2FwZSk7CgogIC8vIFJlZ2V4ZXMgY29udGFpbmluZyB0aGUga2V5cyBhbmQgdmFsdWVzIGxpc3RlZCBpbW1lZGlhdGVseSBhYm92ZS4KICB2YXIgZW50aXR5UmVnZXhlcyA9IHsKICAgIGVzY2FwZTogICBuZXcgUmVnRXhwKCdbJyArIF8ua2V5cyhlbnRpdHlNYXAuZXNjYXBlKS5qb2luKCcnKSArICddJywgJ2cnKSwKICAgIHVuZXNjYXBlOiBuZXcgUmVnRXhwKCcoJyArIF8ua2V5cyhlbnRpdHlNYXAudW5lc2NhcGUpLmpvaW4oJ3wnKSArICcpJywgJ2cnKQogIH07CgogIC8vIEZ1bmN0aW9ucyBmb3IgZXNjYXBpbmcgYW5kIHVuZXNjYXBpbmcgc3RyaW5ncyB0by9mcm9tIEhUTUwgaW50ZXJwb2xhdGlvbi4KICBfLmVhY2goWydlc2NhcGUnLCAndW5lc2NhcGUnXSwgZnVuY3Rpb24obWV0aG9kKSB7CiAgICBfW21ldGhvZF0gPSBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgaWYgKHN0cmluZyA9PSBudWxsKSByZXR1cm4gJyc7CiAgICAgIHJldHVybiAoJycgKyBzdHJpbmcpLnJlcGxhY2UoZW50aXR5UmVnZXhlc1ttZXRob2RdLCBmdW5jdGlvbihtYXRjaCkgewogICAgICAgIHJldHVybiBlbnRpdHlNYXBbbWV0aG9kXVttYXRjaF07CiAgICAgIH0pOwogICAgfTsKICB9KTsKCiAgLy8gSWYgdGhlIHZhbHVlIG9mIHRoZSBuYW1lZCBgcHJvcGVydHlgIGlzIGEgZnVuY3Rpb24gdGhlbiBpbnZva2UgaXQgd2l0aCB0aGUKICAvLyBgb2JqZWN0YCBhcyBjb250ZXh0OyBvdGhlcndpc2UsIHJldHVybiBpdC4KICBfLnJlc3VsdCA9IGZ1bmN0aW9uKG9iamVjdCwgcHJvcGVydHkpIHsKICAgIGlmIChvYmplY3QgPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKICAgIHZhciB2YWx1ZSA9IG9iamVjdFtwcm9wZXJ0eV07CiAgICByZXR1cm4gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlLmNhbGwob2JqZWN0KSA6IHZhbHVlOwogIH07CgogIC8vIEFkZCB5b3VyIG93biBjdXN0b20gZnVuY3Rpb25zIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdC4KICBfLm1peGluID0gZnVuY3Rpb24ob2JqKSB7CiAgICBlYWNoKF8uZnVuY3Rpb25zKG9iaiksIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgdmFyIGZ1bmMgPSBfW25hbWVdID0gb2JqW25hbWVdOwogICAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gW3RoaXMuX3dyYXBwZWRdOwogICAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgZnVuYy5hcHBseShfLCBhcmdzKSk7CiAgICAgIH07CiAgICB9KTsKICB9OwoKICAvLyBHZW5lcmF0ZSBhIHVuaXF1ZSBpbnRlZ2VyIGlkICh1bmlxdWUgd2l0aGluIHRoZSBlbnRpcmUgY2xpZW50IHNlc3Npb24pLgogIC8vIFVzZWZ1bCBmb3IgdGVtcG9yYXJ5IERPTSBpZHMuCiAgdmFyIGlkQ291bnRlciA9IDA7CiAgXy51bmlxdWVJZCA9IGZ1bmN0aW9uKHByZWZpeCkgewogICAgdmFyIGlkID0gKytpZENvdW50ZXIgKyAnJzsKICAgIHJldHVybiBwcmVmaXggPyBwcmVmaXggKyBpZCA6IGlkOwogIH07CgogIC8vIEJ5IGRlZmF1bHQsIFVuZGVyc2NvcmUgdXNlcyBFUkItc3R5bGUgdGVtcGxhdGUgZGVsaW1pdGVycywgY2hhbmdlIHRoZQogIC8vIGZvbGxvd2luZyB0ZW1wbGF0ZSBzZXR0aW5ncyB0byB1c2UgYWx0ZXJuYXRpdmUgZGVsaW1pdGVycy4KICBfLnRlbXBsYXRlU2V0dGluZ3MgPSB7CiAgICBldmFsdWF0ZSAgICA6IC88JShbXHNcU10rPyklPi9nLAogICAgaW50ZXJwb2xhdGUgOiAvPCU9KFtcc1xTXSs/KSU+L2csCiAgICBlc2NhcGUgICAgICA6IC88JS0oW1xzXFNdKz8pJT4vZwogIH07CgogIC8vIFdoZW4gY3VzdG9taXppbmcgYHRlbXBsYXRlU2V0dGluZ3NgLCBpZiB5b3UgZG9uJ3Qgd2FudCB0byBkZWZpbmUgYW4KICAvLyBpbnRlcnBvbGF0aW9uLCBldmFsdWF0aW9uIG9yIGVzY2FwaW5nIHJlZ2V4LCB3ZSBuZWVkIG9uZSB0aGF0IGlzCiAgLy8gZ3VhcmFudGVlZCBub3QgdG8gbWF0Y2guCiAgdmFyIG5vTWF0Y2ggPSAvKC4pXi87CgogIC8vIENlcnRhaW4gY2hhcmFjdGVycyBuZWVkIHRvIGJlIGVzY2FwZWQgc28gdGhhdCB0aGV5IGNhbiBiZSBwdXQgaW50byBhCiAgLy8gc3RyaW5nIGxpdGVyYWwuCiAgdmFyIGVzY2FwZXMgPSB7CiAgICAiJyI6ICAgICAgIiciLAogICAgJ1xcJzogICAgICdcXCcsCiAgICAnXHInOiAgICAgJ3InLAogICAgJ1xuJzogICAgICduJywKICAgICdcdCc6ICAgICAndCcsCiAgICAnXHUyMDI4JzogJ3UyMDI4JywKICAgICdcdTIwMjknOiAndTIwMjknCiAgfTsKCiAgdmFyIGVzY2FwZXIgPSAvXFx8J3xccnxcbnxcdHxcdTIwMjh8XHUyMDI5L2c7CgogIC8vIEphdmFTY3JpcHQgbWljcm8tdGVtcGxhdGluZywgc2ltaWxhciB0byBKb2huIFJlc2lnJ3MgaW1wbGVtZW50YXRpb24uCiAgLy8gVW5kZXJzY29yZSB0ZW1wbGF0aW5nIGhhbmRsZXMgYXJiaXRyYXJ5IGRlbGltaXRlcnMsIHByZXNlcnZlcyB3aGl0ZXNwYWNlLAogIC8vIGFuZCBjb3JyZWN0bHkgZXNjYXBlcyBxdW90ZXMgd2l0aGluIGludGVycG9sYXRlZCBjb2RlLgogIF8udGVtcGxhdGUgPSBmdW5jdGlvbih0ZXh0LCBkYXRhLCBzZXR0aW5ncykgewogICAgdmFyIHJlbmRlcjsKICAgIHNldHRpbmdzID0gXy5kZWZhdWx0cyh7fSwgc2V0dGluZ3MsIF8udGVtcGxhdGVTZXR0aW5ncyk7CgogICAgLy8gQ29tYmluZSBkZWxpbWl0ZXJzIGludG8gb25lIHJlZ3VsYXIgZXhwcmVzc2lvbiB2aWEgYWx0ZXJuYXRpb24uCiAgICB2YXIgbWF0Y2hlciA9IG5ldyBSZWdFeHAoWwogICAgICAoc2V0dGluZ3MuZXNjYXBlIHx8IG5vTWF0Y2gpLnNvdXJjZSwKICAgICAgKHNldHRpbmdzLmludGVycG9sYXRlIHx8IG5vTWF0Y2gpLnNvdXJjZSwKICAgICAgKHNldHRpbmdzLmV2YWx1YXRlIHx8IG5vTWF0Y2gpLnNvdXJjZQogICAgXS5qb2luKCd8JykgKyAnfCQnLCAnZycpOwoKICAgIC8vIENvbXBpbGUgdGhlIHRlbXBsYXRlIHNvdXJjZSwgZXNjYXBpbmcgc3RyaW5nIGxpdGVyYWxzIGFwcHJvcHJpYXRlbHkuCiAgICB2YXIgaW5kZXggPSAwOwogICAgdmFyIHNvdXJjZSA9ICJfX3ArPSciOwogICAgdGV4dC5yZXBsYWNlKG1hdGNoZXIsIGZ1bmN0aW9uKG1hdGNoLCBlc2NhcGUsIGludGVycG9sYXRlLCBldmFsdWF0ZSwgb2Zmc2V0KSB7CiAgICAgIHNvdXJjZSArPSB0ZXh0LnNsaWNlKGluZGV4LCBvZmZzZXQpCiAgICAgICAgLnJlcGxhY2UoZXNjYXBlciwgZnVuY3Rpb24obWF0Y2gpIHsgcmV0dXJuICdcXCcgKyBlc2NhcGVzW21hdGNoXTsgfSk7CgogICAgICBpZiAoZXNjYXBlKSB7CiAgICAgICAgc291cmNlICs9ICInK1xuKChfX3Q9KCIgKyBlc2NhcGUgKyAiKSk9PW51bGw/Jyc6Xy5lc2NhcGUoX190KSkrXG4nIjsKICAgICAgfQogICAgICBpZiAoaW50ZXJwb2xhdGUpIHsKICAgICAgICBzb3VyY2UgKz0gIicrXG4oKF9fdD0oIiArIGludGVycG9sYXRlICsgIikpPT1udWxsPycnOl9fdCkrXG4nIjsKICAgICAgfQogICAgICBpZiAoZXZhbHVhdGUpIHsKICAgICAgICBzb3VyY2UgKz0gIic7XG4iICsgZXZhbHVhdGUgKyAiXG5fX3ArPSciOwogICAgICB9CiAgICAgIGluZGV4ID0gb2Zmc2V0ICsgbWF0Y2gubGVuZ3RoOwogICAgICByZXR1cm4gbWF0Y2g7CiAgICB9KTsKICAgIHNvdXJjZSArPSAiJztcbiI7CgogICAgLy8gSWYgYSB2YXJpYWJsZSBpcyBub3Qgc3BlY2lmaWVkLCBwbGFjZSBkYXRhIHZhbHVlcyBpbiBsb2NhbCBzY29wZS4KICAgIGlmICghc2V0dGluZ3MudmFyaWFibGUpIHNvdXJjZSA9ICd3aXRoKG9ianx8e30pe1xuJyArIHNvdXJjZSArICd9XG4nOwoKICAgIHNvdXJjZSA9ICJ2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4sIiArCiAgICAgICJwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9O1xuIiArCiAgICAgIHNvdXJjZSArICJyZXR1cm4gX19wO1xuIjsKCiAgICB0cnkgewogICAgICByZW5kZXIgPSBuZXcgRnVuY3Rpb24oc2V0dGluZ3MudmFyaWFibGUgfHwgJ29iaicsICdfJywgc291cmNlKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZS5zb3VyY2UgPSBzb3VyY2U7CiAgICAgIHRocm93IGU7CiAgICB9CgogICAgaWYgKGRhdGEpIHJldHVybiByZW5kZXIoZGF0YSwgXyk7CiAgICB2YXIgdGVtcGxhdGUgPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHJldHVybiByZW5kZXIuY2FsbCh0aGlzLCBkYXRhLCBfKTsKICAgIH07CgogICAgLy8gUHJvdmlkZSB0aGUgY29tcGlsZWQgZnVuY3Rpb24gc291cmNlIGFzIGEgY29udmVuaWVuY2UgZm9yIHByZWNvbXBpbGF0aW9uLgogICAgdGVtcGxhdGUuc291cmNlID0gJ2Z1bmN0aW9uKCcgKyAoc2V0dGluZ3MudmFyaWFibGUgfHwgJ29iaicpICsgJyl7XG4nICsgc291cmNlICsgJ30nOwoKICAgIHJldHVybiB0ZW1wbGF0ZTsKICB9OwoKICAvLyBBZGQgYSAiY2hhaW4iIGZ1bmN0aW9uLCB3aGljaCB3aWxsIGRlbGVnYXRlIHRvIHRoZSB3cmFwcGVyLgogIF8uY2hhaW4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBfKG9iaikuY2hhaW4oKTsKICB9OwoKICAvLyBPT1AKICAvLyAtLS0tLS0tLS0tLS0tLS0KICAvLyBJZiBVbmRlcnNjb3JlIGlzIGNhbGxlZCBhcyBhIGZ1bmN0aW9uLCBpdCByZXR1cm5zIGEgd3JhcHBlZCBvYmplY3QgdGhhdAogIC8vIGNhbiBiZSB1c2VkIE9PLXN0eWxlLiBUaGlzIHdyYXBwZXIgaG9sZHMgYWx0ZXJlZCB2ZXJzaW9ucyBvZiBhbGwgdGhlCiAgLy8gdW5kZXJzY29yZSBmdW5jdGlvbnMuIFdyYXBwZWQgb2JqZWN0cyBtYXkgYmUgY2hhaW5lZC4KCiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvbnRpbnVlIGNoYWluaW5nIGludGVybWVkaWF0ZSByZXN1bHRzLgogIHZhciByZXN1bHQgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiB0aGlzLl9jaGFpbiA/IF8ob2JqKS5jaGFpbigpIDogb2JqOwogIH07CgogIC8vIEFkZCBhbGwgb2YgdGhlIFVuZGVyc2NvcmUgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyIG9iamVjdC4KICBfLm1peGluKF8pOwoKICAvLyBBZGQgYWxsIG11dGF0b3IgQXJyYXkgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyLgogIGVhY2goWydwb3AnLCAncHVzaCcsICdyZXZlcnNlJywgJ3NoaWZ0JywgJ3NvcnQnLCAnc3BsaWNlJywgJ3Vuc2hpZnQnXSwgZnVuY3Rpb24obmFtZSkgewogICAgdmFyIG1ldGhvZCA9IEFycmF5UHJvdG9bbmFtZV07CiAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb2JqID0gdGhpcy5fd3JhcHBlZDsKICAgICAgbWV0aG9kLmFwcGx5KG9iaiwgYXJndW1lbnRzKTsKICAgICAgaWYgKChuYW1lID09ICdzaGlmdCcgfHwgbmFtZSA9PSAnc3BsaWNlJykgJiYgb2JqLmxlbmd0aCA9PT0gMCkgZGVsZXRlIG9ialswXTsKICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIG9iaik7CiAgICB9OwogIH0pOwoKICAvLyBBZGQgYWxsIGFjY2Vzc29yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KICBlYWNoKFsnY29uY2F0JywgJ2pvaW4nLCAnc2xpY2UnXSwgZnVuY3Rpb24obmFtZSkgewogICAgdmFyIG1ldGhvZCA9IEFycmF5UHJvdG9bbmFtZV07CiAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgbWV0aG9kLmFwcGx5KHRoaXMuX3dyYXBwZWQsIGFyZ3VtZW50cykpOwogICAgfTsKICB9KTsKCiAgXy5leHRlbmQoXy5wcm90b3R5cGUsIHsKCiAgICAvLyBTdGFydCBjaGFpbmluZyBhIHdyYXBwZWQgVW5kZXJzY29yZSBvYmplY3QuCiAgICBjaGFpbjogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuX2NoYWluID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEV4dHJhY3RzIHRoZSByZXN1bHQgZnJvbSBhIHdyYXBwZWQgYW5kIGNoYWluZWQgb2JqZWN0LgogICAgdmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5fd3JhcHBlZDsKICAgIH0KCiAgfSk7CgogIC8vIEFNRCByZWdpc3RyYXRpb24gaGFwcGVucyBhdCB0aGUgZW5kIGZvciBjb21wYXRpYmlsaXR5IHdpdGggQU1EIGxvYWRlcnMKICAvLyB0aGF0IG1heSBub3QgZW5mb3JjZSBuZXh0LXR1cm4gc2VtYW50aWNzIG9uIG1vZHVsZXMuIEV2ZW4gdGhvdWdoIGdlbmVyYWwKICAvLyBwcmFjdGljZSBmb3IgQU1EIHJlZ2lzdHJhdGlvbiBpcyB0byBiZSBhbm9ueW1vdXMsIHVuZGVyc2NvcmUgcmVnaXN0ZXJzCiAgLy8gYXMgYSBuYW1lZCBtb2R1bGUgYmVjYXVzZSwgbGlrZSBqUXVlcnksIGl0IGlzIGEgYmFzZSBsaWJyYXJ5IHRoYXQgaXMKICAvLyBwb3B1bGFyIGVub3VnaCB0byBiZSBidW5kbGVkIGluIGEgdGhpcmQgcGFydHkgbGliLCBidXQgbm90IGJlIHBhcnQgb2YKICAvLyBhbiBBTUQgbG9hZCByZXF1ZXN0LiBUaG9zZSBjYXNlcyBjb3VsZCBnZW5lcmF0ZSBhbiBlcnJvciB3aGVuIGFuCiAgLy8gYW5vbnltb3VzIGRlZmluZSgpIGlzIGNhbGxlZCBvdXRzaWRlIG9mIGEgbG9hZGVyIHJlcXVlc3QuCiAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewogICAgZGVmaW5lKCd1bmRlcnNjb3JlJywgW10sIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gXzsKICAgIH0pOwogIH0KfSkuY2FsbCh0aGlzKTsKCi8vICAgICBCYWNrYm9uZS5qcyAxLjEuMgoKLy8gICAgIChjKSAyMDEwLTIwMTQgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIGFuZCBJbnZlc3RpZ2F0aXZlIFJlcG9ydGVycyAmIEVkaXRvcnMKLy8gICAgIEJhY2tib25lIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgovLyAgICAgRm9yIGFsbCBkZXRhaWxzIGFuZCBkb2N1bWVudGF0aW9uOgovLyAgICAgaHR0cDovL2JhY2tib25lanMub3JnCgooZnVuY3Rpb24ocm9vdCwgZmFjdG9yeSkgewoKICAvLyBTZXQgdXAgQmFja2JvbmUgYXBwcm9wcmlhdGVseSBmb3IgdGhlIGVudmlyb25tZW50LiBTdGFydCB3aXRoIEFNRC4KICBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CiAgICBkZWZpbmUoJ2JhY2tib25lJyxbJ3VuZGVyc2NvcmUnLCAnanF1ZXJ5JywgJ2V4cG9ydHMnXSwgZnVuY3Rpb24oXywgJCwgZXhwb3J0cykgewogICAgICAvLyBFeHBvcnQgZ2xvYmFsIGV2ZW4gaW4gQU1EIGNhc2UgaW4gY2FzZSB0aGlzIHNjcmlwdCBpcyBsb2FkZWQgd2l0aAogICAgICAvLyBvdGhlcnMgdGhhdCBtYXkgc3RpbGwgZXhwZWN0IGEgZ2xvYmFsIEJhY2tib25lLgogICAgICByb290LkJhY2tib25lID0gZmFjdG9yeShyb290LCBleHBvcnRzLCBfLCAkKTsKICAgIH0pOwoKICAvLyBOZXh0IGZvciBOb2RlLmpzIG9yIENvbW1vbkpTLiBqUXVlcnkgbWF5IG5vdCBiZSBuZWVkZWQgYXMgYSBtb2R1bGUuCiAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIHZhciBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpOwogICAgZmFjdG9yeShyb290LCBleHBvcnRzLCBfKTsKCiAgLy8gRmluYWxseSwgYXMgYSBicm93c2VyIGdsb2JhbC4KICB9IGVsc2UgewogICAgcm9vdC5CYWNrYm9uZSA9IGZhY3Rvcnkocm9vdCwge30sIHJvb3QuXywgKHJvb3QualF1ZXJ5IHx8IHJvb3QuWmVwdG8gfHwgcm9vdC5lbmRlciB8fCByb290LiQpKTsKICB9Cgp9KHRoaXMsIGZ1bmN0aW9uKHJvb3QsIEJhY2tib25lLCBfLCAkKSB7CgogIC8vIEluaXRpYWwgU2V0dXAKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIFNhdmUgdGhlIHByZXZpb3VzIHZhbHVlIG9mIHRoZSBgQmFja2JvbmVgIHZhcmlhYmxlLCBzbyB0aGF0IGl0IGNhbiBiZQogIC8vIHJlc3RvcmVkIGxhdGVyIG9uLCBpZiBgbm9Db25mbGljdGAgaXMgdXNlZC4KICB2YXIgcHJldmlvdXNCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmU7CgogIC8vIENyZWF0ZSBsb2NhbCByZWZlcmVuY2VzIHRvIGFycmF5IG1ldGhvZHMgd2UnbGwgd2FudCB0byB1c2UgbGF0ZXIuCiAgdmFyIGFycmF5ID0gW107CiAgdmFyIHB1c2ggPSBhcnJheS5wdXNoOwogIHZhciBzbGljZSA9IGFycmF5LnNsaWNlOwogIHZhciBzcGxpY2UgPSBhcnJheS5zcGxpY2U7CgogIC8vIEN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgbGlicmFyeS4gS2VlcCBpbiBzeW5jIHdpdGggYHBhY2thZ2UuanNvbmAuCiAgQmFja2JvbmUuVkVSU0lPTiA9ICcxLjEuMic7CgogIC8vIEZvciBCYWNrYm9uZSdzIHB1cnBvc2VzLCBqUXVlcnksIFplcHRvLCBFbmRlciwgb3IgTXkgTGlicmFyeSAoa2lkZGluZykgb3ducwogIC8vIHRoZSBgJGAgdmFyaWFibGUuCiAgQmFja2JvbmUuJCA9ICQ7CgogIC8vIFJ1bnMgQmFja2JvbmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYEJhY2tib25lYCB2YXJpYWJsZQogIC8vIHRvIGl0cyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGlzIEJhY2tib25lIG9iamVjdC4KICBCYWNrYm9uZS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CiAgICByb290LkJhY2tib25lID0gcHJldmlvdXNCYWNrYm9uZTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIFR1cm4gb24gYGVtdWxhdGVIVFRQYCB0byBzdXBwb3J0IGxlZ2FjeSBIVFRQIHNlcnZlcnMuIFNldHRpbmcgdGhpcyBvcHRpb24KICAvLyB3aWxsIGZha2UgYCJQQVRDSCJgLCBgIlBVVCJgIGFuZCBgIkRFTEVURSJgIHJlcXVlc3RzIHZpYSB0aGUgYF9tZXRob2RgIHBhcmFtZXRlciBhbmQKICAvLyBzZXQgYSBgWC1IdHRwLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgogIEJhY2tib25lLmVtdWxhdGVIVFRQID0gZmFsc2U7CgogIC8vIFR1cm4gb24gYGVtdWxhdGVKU09OYCB0byBzdXBwb3J0IGxlZ2FjeSBzZXJ2ZXJzIHRoYXQgY2FuJ3QgZGVhbCB3aXRoIGRpcmVjdAogIC8vIGBhcHBsaWNhdGlvbi9qc29uYCByZXF1ZXN0cyAuLi4gd2lsbCBlbmNvZGUgdGhlIGJvZHkgYXMKICAvLyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYCBpbnN0ZWFkIGFuZCB3aWxsIHNlbmQgdGhlIG1vZGVsIGluIGEKICAvLyBmb3JtIHBhcmFtIG5hbWVkIGBtb2RlbGAuCiAgQmFja2JvbmUuZW11bGF0ZUpTT04gPSBmYWxzZTsKCiAgLy8gQmFja2JvbmUuRXZlbnRzCiAgLy8gLS0tLS0tLS0tLS0tLS0tCgogIC8vIEEgbW9kdWxlIHRoYXQgY2FuIGJlIG1peGVkIGluIHRvICphbnkgb2JqZWN0KiBpbiBvcmRlciB0byBwcm92aWRlIGl0IHdpdGgKICAvLyBjdXN0b20gZXZlbnRzLiBZb3UgbWF5IGJpbmQgd2l0aCBgb25gIG9yIHJlbW92ZSB3aXRoIGBvZmZgIGNhbGxiYWNrCiAgLy8gZnVuY3Rpb25zIHRvIGFuIGV2ZW50OyBgdHJpZ2dlcmAtaW5nIGFuIGV2ZW50IGZpcmVzIGFsbCBjYWxsYmFja3MgaW4KICAvLyBzdWNjZXNzaW9uLgogIC8vCiAgLy8gICAgIHZhciBvYmplY3QgPSB7fTsKICAvLyAgICAgXy5leHRlbmQob2JqZWN0LCBCYWNrYm9uZS5FdmVudHMpOwogIC8vICAgICBvYmplY3Qub24oJ2V4cGFuZCcsIGZ1bmN0aW9uKCl7IGFsZXJ0KCdleHBhbmRlZCcpOyB9KTsKICAvLyAgICAgb2JqZWN0LnRyaWdnZXIoJ2V4cGFuZCcpOwogIC8vCiAgdmFyIEV2ZW50cyA9IEJhY2tib25lLkV2ZW50cyA9IHsKCiAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIGEgYGNhbGxiYWNrYCBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZAogICAgLy8gdGhlIGNhbGxiYWNrIHRvIGFsbCBldmVudHMgZmlyZWQuCiAgICBvbjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ29uJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkgfHwgIWNhbGxiYWNrKSByZXR1cm4gdGhpczsKICAgICAgdGhpcy5fZXZlbnRzIHx8ICh0aGlzLl9ldmVudHMgPSB7fSk7CiAgICAgIHZhciBldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV0gfHwgKHRoaXMuX2V2ZW50c1tuYW1lXSA9IFtdKTsKICAgICAgZXZlbnRzLnB1c2goe2NhbGxiYWNrOiBjYWxsYmFjaywgY29udGV4dDogY29udGV4dCwgY3R4OiBjb250ZXh0IHx8IHRoaXN9KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEJpbmQgYW4gZXZlbnQgdG8gb25seSBiZSB0cmlnZ2VyZWQgYSBzaW5nbGUgdGltZS4gQWZ0ZXIgdGhlIGZpcnN0IHRpbWUKICAgIC8vIHRoZSBjYWxsYmFjayBpcyBpbnZva2VkLCBpdCB3aWxsIGJlIHJlbW92ZWQuCiAgICBvbmNlOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAnb25jZScsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pIHx8ICFjYWxsYmFjaykgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIG9uY2UgPSBfLm9uY2UoZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5vZmYobmFtZSwgb25jZSk7CiAgICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSk7CiAgICAgIG9uY2UuX2NhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgIHJldHVybiB0aGlzLm9uKG5hbWUsIG9uY2UsIGNvbnRleHQpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgb25lIG9yIG1hbnkgY2FsbGJhY2tzLiBJZiBgY29udGV4dGAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKICAgIC8vIGNhbGxiYWNrcyB3aXRoIHRoYXQgZnVuY3Rpb24uIElmIGBjYWxsYmFja2AgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKICAgIC8vIGNhbGxiYWNrcyBmb3IgdGhlIGV2ZW50LiBJZiBgbmFtZWAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwgYm91bmQKICAgIC8vIGNhbGxiYWNrcyBmb3IgYWxsIGV2ZW50cy4KICAgIG9mZjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgdmFyIHJldGFpbiwgZXYsIGV2ZW50cywgbmFtZXMsIGksIGwsIGosIGs7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzIHx8ICFldmVudHNBcGkodGhpcywgJ29mZicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCFuYW1lICYmICFjYWxsYmFjayAmJiAhY29udGV4dCkgewogICAgICAgIHRoaXMuX2V2ZW50cyA9IHZvaWQgMDsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICBuYW1lcyA9IG5hbWUgPyBbbmFtZV0gOiBfLmtleXModGhpcy5fZXZlbnRzKTsKICAgICAgZm9yIChpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG5hbWUgPSBuYW1lc1tpXTsKICAgICAgICBpZiAoZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdKSB7CiAgICAgICAgICB0aGlzLl9ldmVudHNbbmFtZV0gPSByZXRhaW4gPSBbXTsKICAgICAgICAgIGlmIChjYWxsYmFjayB8fCBjb250ZXh0KSB7CiAgICAgICAgICAgIGZvciAoaiA9IDAsIGsgPSBldmVudHMubGVuZ3RoOyBqIDwgazsgaisrKSB7CiAgICAgICAgICAgICAgZXYgPSBldmVudHNbal07CiAgICAgICAgICAgICAgaWYgKChjYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gZXYuY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrLl9jYWxsYmFjaykgfHwKICAgICAgICAgICAgICAgICAgKGNvbnRleHQgJiYgY29udGV4dCAhPT0gZXYuY29udGV4dCkpIHsKICAgICAgICAgICAgICAgIHJldGFpbi5wdXNoKGV2KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghcmV0YWluLmxlbmd0aCkgZGVsZXRlIHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBUcmlnZ2VyIG9uZSBvciBtYW55IGV2ZW50cywgZmlyaW5nIGFsbCBib3VuZCBjYWxsYmFja3MuIENhbGxiYWNrcyBhcmUKICAgIC8vIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAvLyAodW5sZXNzIHlvdSdyZSBsaXN0ZW5pbmcgb24gYCJhbGwiYCwgd2hpY2ggd2lsbCBjYXVzZSB5b3VyIGNhbGxiYWNrIHRvCiAgICAvLyByZWNlaXZlIHRoZSB0cnVlIG5hbWUgb2YgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBhcmd1bWVudCkuCiAgICB0cmlnZ2VyOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzKSByZXR1cm4gdGhpczsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICd0cmlnZ2VyJywgbmFtZSwgYXJncykpIHJldHVybiB0aGlzOwogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdOwogICAgICB2YXIgYWxsRXZlbnRzID0gdGhpcy5fZXZlbnRzLmFsbDsKICAgICAgaWYgKGV2ZW50cykgdHJpZ2dlckV2ZW50cyhldmVudHMsIGFyZ3MpOwogICAgICBpZiAoYWxsRXZlbnRzKSB0cmlnZ2VyRXZlbnRzKGFsbEV2ZW50cywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFRlbGwgdGhpcyBvYmplY3QgdG8gc3RvcCBsaXN0ZW5pbmcgdG8gZWl0aGVyIHNwZWNpZmljIGV2ZW50cyAuLi4gb3IKICAgIC8vIHRvIGV2ZXJ5IG9iamVjdCBpdCdzIGN1cnJlbnRseSBsaXN0ZW5pbmcgdG8uCiAgICBzdG9wTGlzdGVuaW5nOiBmdW5jdGlvbihvYmosIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBsaXN0ZW5pbmdUbyA9IHRoaXMuX2xpc3RlbmluZ1RvOwogICAgICBpZiAoIWxpc3RlbmluZ1RvKSByZXR1cm4gdGhpczsKICAgICAgdmFyIHJlbW92ZSA9ICFuYW1lICYmICFjYWxsYmFjazsKICAgICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIGNhbGxiYWNrID0gdGhpczsKICAgICAgaWYgKG9iaikgKGxpc3RlbmluZ1RvID0ge30pW29iai5fbGlzdGVuSWRdID0gb2JqOwogICAgICBmb3IgKHZhciBpZCBpbiBsaXN0ZW5pbmdUbykgewogICAgICAgIG9iaiA9IGxpc3RlbmluZ1RvW2lkXTsKICAgICAgICBvYmoub2ZmKG5hbWUsIGNhbGxiYWNrLCB0aGlzKTsKICAgICAgICBpZiAocmVtb3ZlIHx8IF8uaXNFbXB0eShvYmouX2V2ZW50cykpIGRlbGV0ZSB0aGlzLl9saXN0ZW5pbmdUb1tpZF07CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogIH07CgogIC8vIFJlZ3VsYXIgZXhwcmVzc2lvbiB1c2VkIHRvIHNwbGl0IGV2ZW50IHN0cmluZ3MuCiAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLzsKCiAgLy8gSW1wbGVtZW50IGZhbmN5IGZlYXR1cmVzIG9mIHRoZSBFdmVudHMgQVBJIHN1Y2ggYXMgbXVsdGlwbGUgZXZlbnQKICAvLyBuYW1lcyBgImNoYW5nZSBibHVyImAgYW5kIGpRdWVyeS1zdHlsZSBldmVudCBtYXBzIGB7Y2hhbmdlOiBhY3Rpb259YAogIC8vIGluIHRlcm1zIG9mIHRoZSBleGlzdGluZyBBUEkuCiAgdmFyIGV2ZW50c0FwaSA9IGZ1bmN0aW9uKG9iaiwgYWN0aW9uLCBuYW1lLCByZXN0KSB7CiAgICBpZiAoIW5hbWUpIHJldHVybiB0cnVlOwoKICAgIC8vIEhhbmRsZSBldmVudCBtYXBzLgogICAgaWYgKHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgewogICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZSkgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW2tleSwgbmFtZVtrZXldXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLyBIYW5kbGUgc3BhY2Ugc2VwYXJhdGVkIGV2ZW50IG5hbWVzLgogICAgaWYgKGV2ZW50U3BsaXR0ZXIudGVzdChuYW1lKSkgewogICAgICB2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW25hbWVzW2ldXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9OwoKICAvLyBBIGRpZmZpY3VsdC10by1iZWxpZXZlLCBidXQgb3B0aW1pemVkIGludGVybmFsIGRpc3BhdGNoIGZ1bmN0aW9uIGZvcgogIC8vIHRyaWdnZXJpbmcgZXZlbnRzLiBUcmllcyB0byBrZWVwIHRoZSB1c3VhbCBjYXNlcyBzcGVlZHkgKG1vc3QgaW50ZXJuYWwKICAvLyBCYWNrYm9uZSBldmVudHMgaGF2ZSAzIGFyZ3VtZW50cykuCiAgdmFyIHRyaWdnZXJFdmVudHMgPSBmdW5jdGlvbihldmVudHMsIGFyZ3MpIHsKICAgIHZhciBldiwgaSA9IC0xLCBsID0gZXZlbnRzLmxlbmd0aCwgYTEgPSBhcmdzWzBdLCBhMiA9IGFyZ3NbMV0sIGEzID0gYXJnc1syXTsKICAgIHN3aXRjaCAoYXJncy5sZW5ndGgpIHsKICAgICAgY2FzZSAwOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCk7IHJldHVybjsKICAgICAgY2FzZSAxOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEpOyByZXR1cm47CiAgICAgIGNhc2UgMjogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExLCBhMik7IHJldHVybjsKICAgICAgY2FzZSAzOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEsIGEyLCBhMyk7IHJldHVybjsKICAgICAgZGVmYXVsdDogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suYXBwbHkoZXYuY3R4LCBhcmdzKTsgcmV0dXJuOwogICAgfQogIH07CgogIHZhciBsaXN0ZW5NZXRob2RzID0ge2xpc3RlblRvOiAnb24nLCBsaXN0ZW5Ub09uY2U6ICdvbmNlJ307CgogIC8vIEludmVyc2lvbi1vZi1jb250cm9sIHZlcnNpb25zIG9mIGBvbmAgYW5kIGBvbmNlYC4gVGVsbCAqdGhpcyogb2JqZWN0IHRvCiAgLy8gbGlzdGVuIHRvIGFuIGV2ZW50IGluIGFub3RoZXIgb2JqZWN0IC4uLiBrZWVwaW5nIHRyYWNrIG9mIHdoYXQgaXQncwogIC8vIGxpc3RlbmluZyB0by4KICBfLmVhY2gobGlzdGVuTWV0aG9kcywgZnVuY3Rpb24oaW1wbGVtZW50YXRpb24sIG1ldGhvZCkgewogICAgRXZlbnRzW21ldGhvZF0gPSBmdW5jdGlvbihvYmosIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBsaXN0ZW5pbmdUbyA9IHRoaXMuX2xpc3RlbmluZ1RvIHx8ICh0aGlzLl9saXN0ZW5pbmdUbyA9IHt9KTsKICAgICAgdmFyIGlkID0gb2JqLl9saXN0ZW5JZCB8fCAob2JqLl9saXN0ZW5JZCA9IF8udW5pcXVlSWQoJ2wnKSk7CiAgICAgIGxpc3RlbmluZ1RvW2lkXSA9IG9iajsKICAgICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIGNhbGxiYWNrID0gdGhpczsKICAgICAgb2JqW2ltcGxlbWVudGF0aW9uXShuYW1lLCBjYWxsYmFjaywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICB9KTsKCiAgLy8gQWxpYXNlcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCiAgRXZlbnRzLmJpbmQgICA9IEV2ZW50cy5vbjsKICBFdmVudHMudW5iaW5kID0gRXZlbnRzLm9mZjsKCiAgLy8gQWxsb3cgdGhlIGBCYWNrYm9uZWAgb2JqZWN0IHRvIHNlcnZlIGFzIGEgZ2xvYmFsIGV2ZW50IGJ1cywgZm9yIGZvbGtzIHdobwogIC8vIHdhbnQgZ2xvYmFsICJwdWJzdWIiIGluIGEgY29udmVuaWVudCBwbGFjZS4KICBfLmV4dGVuZChCYWNrYm9uZSwgRXZlbnRzKTsKCiAgLy8gQmFja2JvbmUuTW9kZWwKICAvLyAtLS0tLS0tLS0tLS0tLQoKICAvLyBCYWNrYm9uZSAqKk1vZGVscyoqIGFyZSB0aGUgYmFzaWMgZGF0YSBvYmplY3QgaW4gdGhlIGZyYW1ld29yayAtLQogIC8vIGZyZXF1ZW50bHkgcmVwcmVzZW50aW5nIGEgcm93IGluIGEgdGFibGUgaW4gYSBkYXRhYmFzZSBvbiB5b3VyIHNlcnZlci4KICAvLyBBIGRpc2NyZXRlIGNodW5rIG9mIGRhdGEgYW5kIGEgYnVuY2ggb2YgdXNlZnVsLCByZWxhdGVkIG1ldGhvZHMgZm9yCiAgLy8gcGVyZm9ybWluZyBjb21wdXRhdGlvbnMgYW5kIHRyYW5zZm9ybWF0aW9ucyBvbiB0aGF0IGRhdGEuCgogIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIHRoZSBzcGVjaWZpZWQgYXR0cmlidXRlcy4gQSBjbGllbnQgaWQgKGBjaWRgKQogIC8vIGlzIGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkIGFuZCBhc3NpZ25lZCBmb3IgeW91LgogIHZhciBNb2RlbCA9IEJhY2tib25lLk1vZGVsID0gZnVuY3Rpb24oYXR0cmlidXRlcywgb3B0aW9ucykgewogICAgdmFyIGF0dHJzID0gYXR0cmlidXRlcyB8fCB7fTsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ2MnKTsKICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwogICAgaWYgKG9wdGlvbnMuY29sbGVjdGlvbikgdGhpcy5jb2xsZWN0aW9uID0gb3B0aW9ucy5jb2xsZWN0aW9uOwogICAgaWYgKG9wdGlvbnMucGFyc2UpIGF0dHJzID0gdGhpcy5wYXJzZShhdHRycywgb3B0aW9ucykgfHwge307CiAgICBhdHRycyA9IF8uZGVmYXVsdHMoe30sIGF0dHJzLCBfLnJlc3VsdCh0aGlzLCAnZGVmYXVsdHMnKSk7CiAgICB0aGlzLnNldChhdHRycywgb3B0aW9ucyk7CiAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CgogIC8vIEF0dGFjaCBhbGwgaW5oZXJpdGFibGUgbWV0aG9kcyB0byB0aGUgTW9kZWwgcHJvdG90eXBlLgogIF8uZXh0ZW5kKE1vZGVsLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gQSBoYXNoIG9mIGF0dHJpYnV0ZXMgd2hvc2UgY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWUgZGlmZmVyLgogICAgY2hhbmdlZDogbnVsbCwKCiAgICAvLyBUaGUgdmFsdWUgcmV0dXJuZWQgZHVyaW5nIHRoZSBsYXN0IGZhaWxlZCB2YWxpZGF0aW9uLgogICAgdmFsaWRhdGlvbkVycm9yOiBudWxsLAoKICAgIC8vIFRoZSBkZWZhdWx0IG5hbWUgZm9yIHRoZSBKU09OIGBpZGAgYXR0cmlidXRlIGlzIGAiaWQiYC4gTW9uZ29EQiBhbmQKICAgIC8vIENvdWNoREIgdXNlcnMgbWF5IHdhbnQgdG8gc2V0IHRoaXMgdG8gYCJfaWQiYC4KICAgIGlkQXR0cmlidXRlOiAnaWQnLAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gUmV0dXJuIGEgY29weSBvZiB0aGUgbW9kZWwncyBgYXR0cmlidXRlc2Agb2JqZWN0LgogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICB9LAoKICAgIC8vIFByb3h5IGBCYWNrYm9uZS5zeW5jYCBieSBkZWZhdWx0IC0tIGJ1dCBvdmVycmlkZSB0aGlzIGlmIHlvdSBuZWVkCiAgICAvLyBjdXN0b20gc3luY2luZyBzZW1hbnRpY3MgZm9yICp0aGlzKiBwYXJ0aWN1bGFyIG1vZGVsLgogICAgc3luYzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgdmFsdWUgb2YgYW4gYXR0cmlidXRlLgogICAgZ2V0OiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiB0aGlzLmF0dHJpYnV0ZXNbYXR0cl07CiAgICB9LAoKICAgIC8vIEdldCB0aGUgSFRNTC1lc2NhcGVkIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGVzY2FwZTogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gXy5lc2NhcGUodGhpcy5nZXQoYXR0cikpOwogICAgfSwKCiAgICAvLyBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYXR0cmlidXRlIGNvbnRhaW5zIGEgdmFsdWUgdGhhdCBpcyBub3QgbnVsbAogICAgLy8gb3IgdW5kZWZpbmVkLgogICAgaGFzOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiB0aGlzLmdldChhdHRyKSAhPSBudWxsOwogICAgfSwKCiAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMgb24gdGhlIG9iamVjdCwgZmlyaW5nIGAiY2hhbmdlImAuIFRoaXMgaXMKICAgIC8vIHRoZSBjb3JlIHByaW1pdGl2ZSBvcGVyYXRpb24gb2YgYSBtb2RlbCwgdXBkYXRpbmcgdGhlIGRhdGEgYW5kIG5vdGlmeWluZwogICAgLy8gYW55b25lIHdobyBuZWVkcyB0byBrbm93IGFib3V0IHRoZSBjaGFuZ2UgaW4gc3RhdGUuIFRoZSBoZWFydCBvZiB0aGUgYmVhc3QuCiAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsLCBvcHRpb25zKSB7CiAgICAgIHZhciBhdHRyLCBhdHRycywgdW5zZXQsIGNoYW5nZXMsIHNpbGVudCwgY2hhbmdpbmcsIHByZXYsIGN1cnJlbnQ7CiAgICAgIGlmIChrZXkgPT0gbnVsbCkgcmV0dXJuIHRoaXM7CgogICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgYXR0cnMgPSBrZXk7CiAgICAgICAgb3B0aW9ucyA9IHZhbDsKICAgICAgfSBlbHNlIHsKICAgICAgICAoYXR0cnMgPSB7fSlba2V5XSA9IHZhbDsKICAgICAgfQoKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCiAgICAgIC8vIFJ1biB2YWxpZGF0aW9uLgogICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwoKICAgICAgLy8gRXh0cmFjdCBhdHRyaWJ1dGVzIGFuZCBvcHRpb25zLgogICAgICB1bnNldCAgICAgICAgICAgPSBvcHRpb25zLnVuc2V0OwogICAgICBzaWxlbnQgICAgICAgICAgPSBvcHRpb25zLnNpbGVudDsKICAgICAgY2hhbmdlcyAgICAgICAgID0gW107CiAgICAgIGNoYW5naW5nICAgICAgICA9IHRoaXMuX2NoYW5naW5nOwogICAgICB0aGlzLl9jaGFuZ2luZyAgPSB0cnVlOwoKICAgICAgaWYgKCFjaGFuZ2luZykgewogICAgICAgIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgICAgfQogICAgICBjdXJyZW50ID0gdGhpcy5hdHRyaWJ1dGVzLCBwcmV2ID0gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzOwoKICAgICAgLy8gQ2hlY2sgZm9yIGNoYW5nZXMgb2YgYGlkYC4KICAgICAgaWYgKHRoaXMuaWRBdHRyaWJ1dGUgaW4gYXR0cnMpIHRoaXMuaWQgPSBhdHRyc1t0aGlzLmlkQXR0cmlidXRlXTsKCiAgICAgIC8vIEZvciBlYWNoIGBzZXRgIGF0dHJpYnV0ZSwgdXBkYXRlIG9yIGRlbGV0ZSB0aGUgY3VycmVudCB2YWx1ZS4KICAgICAgZm9yIChhdHRyIGluIGF0dHJzKSB7CiAgICAgICAgdmFsID0gYXR0cnNbYXR0cl07CiAgICAgICAgaWYgKCFfLmlzRXF1YWwoY3VycmVudFthdHRyXSwgdmFsKSkgY2hhbmdlcy5wdXNoKGF0dHIpOwogICAgICAgIGlmICghXy5pc0VxdWFsKHByZXZbYXR0cl0sIHZhbCkpIHsKICAgICAgICAgIHRoaXMuY2hhbmdlZFthdHRyXSA9IHZhbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGVsZXRlIHRoaXMuY2hhbmdlZFthdHRyXTsKICAgICAgICB9CiAgICAgICAgdW5zZXQgPyBkZWxldGUgY3VycmVudFthdHRyXSA6IGN1cnJlbnRbYXR0cl0gPSB2YWw7CiAgICAgIH0KCiAgICAgIC8vIFRyaWdnZXIgYWxsIHJlbGV2YW50IGF0dHJpYnV0ZSBjaGFuZ2VzLgogICAgICBpZiAoIXNpbGVudCkgewogICAgICAgIGlmIChjaGFuZ2VzLmxlbmd0aCkgdGhpcy5fcGVuZGluZyA9IG9wdGlvbnM7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjaGFuZ2VzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2U6JyArIGNoYW5nZXNbaV0sIHRoaXMsIGN1cnJlbnRbY2hhbmdlc1tpXV0sIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gWW91IG1pZ2h0IGJlIHdvbmRlcmluZyB3aHkgdGhlcmUncyBhIGB3aGlsZWAgbG9vcCBoZXJlLiBDaGFuZ2VzIGNhbgogICAgICAvLyBiZSByZWN1cnNpdmVseSBuZXN0ZWQgd2l0aGluIGAiY2hhbmdlImAgZXZlbnRzLgogICAgICBpZiAoY2hhbmdpbmcpIHJldHVybiB0aGlzOwogICAgICBpZiAoIXNpbGVudCkgewogICAgICAgIHdoaWxlICh0aGlzLl9wZW5kaW5nKSB7CiAgICAgICAgICBvcHRpb25zID0gdGhpcy5fcGVuZGluZzsKICAgICAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsKICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlJywgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsKICAgICAgdGhpcy5fY2hhbmdpbmcgPSBmYWxzZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhbiBhdHRyaWJ1dGUgZnJvbSB0aGUgbW9kZWwsIGZpcmluZyBgImNoYW5nZSJgLiBgdW5zZXRgIGlzIGEgbm9vcAogICAgLy8gaWYgdGhlIGF0dHJpYnV0ZSBkb2Vzbid0IGV4aXN0LgogICAgdW5zZXQ6IGZ1bmN0aW9uKGF0dHIsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHIsIHZvaWQgMCwgXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pKTsKICAgIH0sCgogICAgLy8gQ2xlYXIgYWxsIGF0dHJpYnV0ZXMgb24gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYC4KICAgIGNsZWFyOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBhdHRycyA9IHt9OwogICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5hdHRyaWJ1dGVzKSBhdHRyc1trZXldID0gdm9pZCAwOwogICAgICByZXR1cm4gdGhpcy5zZXQoYXR0cnMsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7CiAgICB9LAoKICAgIC8vIERldGVybWluZSBpZiB0aGUgbW9kZWwgaGFzIGNoYW5nZWQgc2luY2UgdGhlIGxhc3QgYCJjaGFuZ2UiYCBldmVudC4KICAgIC8vIElmIHlvdSBzcGVjaWZ5IGFuIGF0dHJpYnV0ZSBuYW1lLCBkZXRlcm1pbmUgaWYgdGhhdCBhdHRyaWJ1dGUgaGFzIGNoYW5nZWQuCiAgICBoYXNDaGFuZ2VkOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIGlmIChhdHRyID09IG51bGwpIHJldHVybiAhXy5pc0VtcHR5KHRoaXMuY2hhbmdlZCk7CiAgICAgIHJldHVybiBfLmhhcyh0aGlzLmNoYW5nZWQsIGF0dHIpOwogICAgfSwKCiAgICAvLyBSZXR1cm4gYW4gb2JqZWN0IGNvbnRhaW5pbmcgYWxsIHRoZSBhdHRyaWJ1dGVzIHRoYXQgaGF2ZSBjaGFuZ2VkLCBvcgogICAgLy8gZmFsc2UgaWYgdGhlcmUgYXJlIG5vIGNoYW5nZWQgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBkZXRlcm1pbmluZyB3aGF0CiAgICAvLyBwYXJ0cyBvZiBhIHZpZXcgbmVlZCB0byBiZSB1cGRhdGVkIGFuZC9vciB3aGF0IGF0dHJpYnV0ZXMgbmVlZCB0byBiZQogICAgLy8gcGVyc2lzdGVkIHRvIHRoZSBzZXJ2ZXIuIFVuc2V0IGF0dHJpYnV0ZXMgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAgLy8gWW91IGNhbiBhbHNvIHBhc3MgYW4gYXR0cmlidXRlcyBvYmplY3QgdG8gZGlmZiBhZ2FpbnN0IHRoZSBtb2RlbCwKICAgIC8vIGRldGVybWluaW5nIGlmIHRoZXJlICp3b3VsZCBiZSogYSBjaGFuZ2UuCiAgICBjaGFuZ2VkQXR0cmlidXRlczogZnVuY3Rpb24oZGlmZikgewogICAgICBpZiAoIWRpZmYpIHJldHVybiB0aGlzLmhhc0NoYW5nZWQoKSA/IF8uY2xvbmUodGhpcy5jaGFuZ2VkKSA6IGZhbHNlOwogICAgICB2YXIgdmFsLCBjaGFuZ2VkID0gZmFsc2U7CiAgICAgIHZhciBvbGQgPSB0aGlzLl9jaGFuZ2luZyA/IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA6IHRoaXMuYXR0cmlidXRlczsKICAgICAgZm9yICh2YXIgYXR0ciBpbiBkaWZmKSB7CiAgICAgICAgaWYgKF8uaXNFcXVhbChvbGRbYXR0cl0sICh2YWwgPSBkaWZmW2F0dHJdKSkpIGNvbnRpbnVlOwogICAgICAgIChjaGFuZ2VkIHx8IChjaGFuZ2VkID0ge30pKVthdHRyXSA9IHZhbDsKICAgICAgfQogICAgICByZXR1cm4gY2hhbmdlZDsKICAgIH0sCgogICAgLy8gR2V0IHRoZSBwcmV2aW91cyB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUsIHJlY29yZGVkIGF0IHRoZSB0aW1lIHRoZSBsYXN0CiAgICAvLyBgImNoYW5nZSJgIGV2ZW50IHdhcyBmaXJlZC4KICAgIHByZXZpb3VzOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIGlmIChhdHRyID09IG51bGwgfHwgIXRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcykgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXNbYXR0cl07CiAgICB9LAoKICAgIC8vIEdldCBhbGwgb2YgdGhlIGF0dHJpYnV0ZXMgb2YgdGhlIG1vZGVsIGF0IHRoZSB0aW1lIG9mIHRoZSBwcmV2aW91cwogICAgLy8gYCJjaGFuZ2UiYCBldmVudC4KICAgIHByZXZpb3VzQXR0cmlidXRlczogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyk7CiAgICB9LAoKICAgIC8vIEZldGNoIHRoZSBtb2RlbCBmcm9tIHRoZSBzZXJ2ZXIuIElmIHRoZSBzZXJ2ZXIncyByZXByZXNlbnRhdGlvbiBvZiB0aGUKICAgIC8vIG1vZGVsIGRpZmZlcnMgZnJvbSBpdHMgY3VycmVudCBhdHRyaWJ1dGVzLCB0aGV5IHdpbGwgYmUgb3ZlcnJpZGRlbiwKICAgIC8vIHRyaWdnZXJpbmcgYSBgImNoYW5nZSJgIGV2ZW50LgogICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIGlmICghbW9kZWwuc2V0KG1vZGVsLnBhcnNlKHJlc3AsIG9wdGlvbnMpLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKICAgIH0sCgogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzLCBhbmQgc3luYyB0aGUgbW9kZWwgdG8gdGhlIHNlcnZlci4KICAgIC8vIElmIHRoZSBzZXJ2ZXIgcmV0dXJucyBhbiBhdHRyaWJ1dGVzIGhhc2ggdGhhdCBkaWZmZXJzLCB0aGUgbW9kZWwncwogICAgLy8gc3RhdGUgd2lsbCBiZSBgc2V0YCBhZ2Fpbi4KICAgIHNhdmU6IGZ1bmN0aW9uKGtleSwgdmFsLCBvcHRpb25zKSB7CiAgICAgIHZhciBhdHRycywgbWV0aG9kLCB4aHIsIGF0dHJpYnV0ZXMgPSB0aGlzLmF0dHJpYnV0ZXM7CgogICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KICAgICAgaWYgKGtleSA9PSBudWxsIHx8IHR5cGVvZiBrZXkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgYXR0cnMgPSBrZXk7CiAgICAgICAgb3B0aW9ucyA9IHZhbDsKICAgICAgfSBlbHNlIHsKICAgICAgICAoYXR0cnMgPSB7fSlba2V5XSA9IHZhbDsKICAgICAgfQoKICAgICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHt2YWxpZGF0ZTogdHJ1ZX0sIG9wdGlvbnMpOwoKICAgICAgLy8gSWYgd2UncmUgbm90IHdhaXRpbmcgYW5kIGF0dHJpYnV0ZXMgZXhpc3QsIHNhdmUgYWN0cyBhcwogICAgICAvLyBgc2V0KGF0dHIpLnNhdmUobnVsbCwgb3B0cylgIHdpdGggdmFsaWRhdGlvbi4gT3RoZXJ3aXNlLCBjaGVjayBpZgogICAgICAvLyB0aGUgbW9kZWwgd2lsbCBiZSB2YWxpZCB3aGVuIHRoZSBhdHRyaWJ1dGVzLCBpZiBhbnksIGFyZSBzZXQuCiAgICAgIGlmIChhdHRycyAmJiAhb3B0aW9ucy53YWl0KSB7CiAgICAgICAgaWYgKCF0aGlzLnNldChhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICAvLyBTZXQgdGVtcG9yYXJ5IGF0dHJpYnV0ZXMgaWYgYHt3YWl0OiB0cnVlfWAuCiAgICAgIGlmIChhdHRycyAmJiBvcHRpb25zLndhaXQpIHsKICAgICAgICB0aGlzLmF0dHJpYnV0ZXMgPSBfLmV4dGVuZCh7fSwgYXR0cmlidXRlcywgYXR0cnMpOwogICAgICB9CgogICAgICAvLyBBZnRlciBhIHN1Y2Nlc3NmdWwgc2VydmVyLXNpZGUgc2F2ZSwgdGhlIGNsaWVudCBpcyAob3B0aW9uYWxseSkKICAgICAgLy8gdXBkYXRlZCB3aXRoIHRoZSBzZXJ2ZXItc2lkZSBzdGF0ZS4KICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgLy8gRW5zdXJlIGF0dHJpYnV0ZXMgYXJlIHJlc3RvcmVkIGR1cmluZyBzeW5jaHJvbm91cyBzYXZlcy4KICAgICAgICBtb2RlbC5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKICAgICAgICB2YXIgc2VydmVyQXR0cnMgPSBtb2RlbC5wYXJzZShyZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAob3B0aW9ucy53YWl0KSBzZXJ2ZXJBdHRycyA9IF8uZXh0ZW5kKGF0dHJzIHx8IHt9LCBzZXJ2ZXJBdHRycyk7CiAgICAgICAgaWYgKF8uaXNPYmplY3Qoc2VydmVyQXR0cnMpICYmICFtb2RlbC5zZXQoc2VydmVyQXR0cnMsIG9wdGlvbnMpKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CgogICAgICBtZXRob2QgPSB0aGlzLmlzTmV3KCkgPyAnY3JlYXRlJyA6IChvcHRpb25zLnBhdGNoID8gJ3BhdGNoJyA6ICd1cGRhdGUnKTsKICAgICAgaWYgKG1ldGhvZCA9PT0gJ3BhdGNoJykgb3B0aW9ucy5hdHRycyA9IGF0dHJzOwogICAgICB4aHIgPSB0aGlzLnN5bmMobWV0aG9kLCB0aGlzLCBvcHRpb25zKTsKCiAgICAgIC8vIFJlc3RvcmUgYXR0cmlidXRlcy4KICAgICAgaWYgKGF0dHJzICYmIG9wdGlvbnMud2FpdCkgdGhpcy5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKCiAgICAgIHJldHVybiB4aHI7CiAgICB9LAoKICAgIC8vIERlc3Ryb3kgdGhpcyBtb2RlbCBvbiB0aGUgc2VydmVyIGlmIGl0IHdhcyBhbHJlYWR5IHBlcnNpc3RlZC4KICAgIC8vIE9wdGltaXN0aWNhbGx5IHJlbW92ZXMgdGhlIG1vZGVsIGZyb20gaXRzIGNvbGxlY3Rpb24sIGlmIGl0IGhhcyBvbmUuCiAgICAvLyBJZiBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCB3YWl0cyBmb3IgdGhlIHNlcnZlciB0byByZXNwb25kIGJlZm9yZSByZW1vdmFsLgogICAgZGVzdHJveTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CgogICAgICB2YXIgZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIG1vZGVsLnRyaWdnZXIoJ2Rlc3Ryb3knLCBtb2RlbCwgbW9kZWwuY29sbGVjdGlvbiwgb3B0aW9ucyk7CiAgICAgIH07CgogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgaWYgKG9wdGlvbnMud2FpdCB8fCBtb2RlbC5pc05ldygpKSBkZXN0cm95KCk7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGlmICghbW9kZWwuaXNOZXcoKSkgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKCiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHsKICAgICAgICBvcHRpb25zLnN1Y2Nlc3MoKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwoKICAgICAgdmFyIHhociA9IHRoaXMuc3luYygnZGVsZXRlJywgdGhpcywgb3B0aW9ucyk7CiAgICAgIGlmICghb3B0aW9ucy53YWl0KSBkZXN0cm95KCk7CiAgICAgIHJldHVybiB4aHI7CiAgICB9LAoKICAgIC8vIERlZmF1bHQgVVJMIGZvciB0aGUgbW9kZWwncyByZXByZXNlbnRhdGlvbiBvbiB0aGUgc2VydmVyIC0tIGlmIHlvdSdyZQogICAgLy8gdXNpbmcgQmFja2JvbmUncyByZXN0ZnVsIG1ldGhvZHMsIG92ZXJyaWRlIHRoaXMgdG8gY2hhbmdlIHRoZSBlbmRwb2ludAogICAgLy8gdGhhdCB3aWxsIGJlIGNhbGxlZC4KICAgIHVybDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBiYXNlID0KICAgICAgICBfLnJlc3VsdCh0aGlzLCAndXJsUm9vdCcpIHx8CiAgICAgICAgXy5yZXN1bHQodGhpcy5jb2xsZWN0aW9uLCAndXJsJykgfHwKICAgICAgICB1cmxFcnJvcigpOwogICAgICBpZiAodGhpcy5pc05ldygpKSByZXR1cm4gYmFzZTsKICAgICAgcmV0dXJuIGJhc2UucmVwbGFjZSgvKFteXC9dKSQvLCAnJDEvJykgKyBlbmNvZGVVUklDb21wb25lbnQodGhpcy5pZCk7CiAgICB9LAoKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gdGhlIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBgc2V0YCBvbgogICAgLy8gdGhlIG1vZGVsLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgdGhlIHJlc3BvbnNlIGFsb25nLgogICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3AsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHJlc3A7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIGlkZW50aWNhbCBhdHRyaWJ1dGVzIHRvIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5hdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gQSBtb2RlbCBpcyBuZXcgaWYgaXQgaGFzIG5ldmVyIGJlZW4gc2F2ZWQgdG8gdGhlIHNlcnZlciwgYW5kIGxhY2tzIGFuIGlkLgogICAgaXNOZXc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gIXRoaXMuaGFzKHRoaXMuaWRBdHRyaWJ1dGUpOwogICAgfSwKCiAgICAvLyBDaGVjayBpZiB0aGUgbW9kZWwgaXMgY3VycmVudGx5IGluIGEgdmFsaWQgc3RhdGUuCiAgICBpc1ZhbGlkOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLl92YWxpZGF0ZSh7fSwgXy5leHRlbmQob3B0aW9ucyB8fCB7fSwgeyB2YWxpZGF0ZTogdHJ1ZSB9KSk7CiAgICB9LAoKICAgIC8vIFJ1biB2YWxpZGF0aW9uIGFnYWluc3QgdGhlIG5leHQgY29tcGxldGUgc2V0IG9mIG1vZGVsIGF0dHJpYnV0ZXMsCiAgICAvLyByZXR1cm5pbmcgYHRydWVgIGlmIGFsbCBpcyB3ZWxsLiBPdGhlcndpc2UsIGZpcmUgYW4gYCJpbnZhbGlkImAgZXZlbnQuCiAgICBfdmFsaWRhdGU6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgIGlmICghb3B0aW9ucy52YWxpZGF0ZSB8fCAhdGhpcy52YWxpZGF0ZSkgcmV0dXJuIHRydWU7CiAgICAgIGF0dHJzID0gXy5leHRlbmQoe30sIHRoaXMuYXR0cmlidXRlcywgYXR0cnMpOwogICAgICB2YXIgZXJyb3IgPSB0aGlzLnZhbGlkYXRpb25FcnJvciA9IHRoaXMudmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpIHx8IG51bGw7CiAgICAgIGlmICghZXJyb3IpIHJldHVybiB0cnVlOwogICAgICB0aGlzLnRyaWdnZXIoJ2ludmFsaWQnLCB0aGlzLCBlcnJvciwgXy5leHRlbmQob3B0aW9ucywge3ZhbGlkYXRpb25FcnJvcjogZXJyb3J9KSk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgfSk7CgogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHdlIHdhbnQgdG8gaW1wbGVtZW50IG9uIHRoZSBNb2RlbC4KICB2YXIgbW9kZWxNZXRob2RzID0gWydrZXlzJywgJ3ZhbHVlcycsICdwYWlycycsICdpbnZlcnQnLCAncGljaycsICdvbWl0J107CgogIC8vIE1peCBpbiBlYWNoIFVuZGVyc2NvcmUgbWV0aG9kIGFzIGEgcHJveHkgdG8gYE1vZGVsI2F0dHJpYnV0ZXNgLgogIF8uZWFjaChtb2RlbE1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgTW9kZWwucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwogICAgfTsKICB9KTsKCiAgLy8gQmFja2JvbmUuQ29sbGVjdGlvbgogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gSWYgbW9kZWxzIHRlbmQgdG8gcmVwcmVzZW50IGEgc2luZ2xlIHJvdyBvZiBkYXRhLCBhIEJhY2tib25lIENvbGxlY3Rpb24gaXMKICAvLyBtb3JlIGFuYWxhZ291cyB0byBhIHRhYmxlIGZ1bGwgb2YgZGF0YSAuLi4gb3IgYSBzbWFsbCBzbGljZSBvciBwYWdlIG9mIHRoYXQKICAvLyB0YWJsZSwgb3IgYSBjb2xsZWN0aW9uIG9mIHJvd3MgdGhhdCBiZWxvbmcgdG9nZXRoZXIgZm9yIGEgcGFydGljdWxhciByZWFzb24KICAvLyAtLSBhbGwgb2YgdGhlIG1lc3NhZ2VzIGluIHRoaXMgcGFydGljdWxhciBmb2xkZXIsIGFsbCBvZiB0aGUgZG9jdW1lbnRzCiAgLy8gYmVsb25naW5nIHRvIHRoaXMgcGFydGljdWxhciBhdXRob3IsIGFuZCBzbyBvbi4gQ29sbGVjdGlvbnMgbWFpbnRhaW4KICAvLyBpbmRleGVzIG9mIHRoZWlyIG1vZGVscywgYm90aCBpbiBvcmRlciwgYW5kIGZvciBsb29rdXAgYnkgYGlkYC4KCiAgLy8gQ3JlYXRlIGEgbmV3ICoqQ29sbGVjdGlvbioqLCBwZXJoYXBzIHRvIGNvbnRhaW4gYSBzcGVjaWZpYyB0eXBlIG9mIGBtb2RlbGAuCiAgLy8gSWYgYSBgY29tcGFyYXRvcmAgaXMgc3BlY2lmaWVkLCB0aGUgQ29sbGVjdGlvbiB3aWxsIG1haW50YWluCiAgLy8gaXRzIG1vZGVscyBpbiBzb3J0IG9yZGVyLCBhcyB0aGV5J3JlIGFkZGVkIGFuZCByZW1vdmVkLgogIHZhciBDb2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIGlmIChvcHRpb25zLm1vZGVsKSB0aGlzLm1vZGVsID0gb3B0aW9ucy5tb2RlbDsKICAgIGlmIChvcHRpb25zLmNvbXBhcmF0b3IgIT09IHZvaWQgMCkgdGhpcy5jb21wYXJhdG9yID0gb3B0aW9ucy5jb21wYXJhdG9yOwogICAgdGhpcy5fcmVzZXQoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKG1vZGVscykgdGhpcy5yZXNldChtb2RlbHMsIF8uZXh0ZW5kKHtzaWxlbnQ6IHRydWV9LCBvcHRpb25zKSk7CiAgfTsKCiAgLy8gRGVmYXVsdCBvcHRpb25zIGZvciBgQ29sbGVjdGlvbiNzZXRgLgogIHZhciBzZXRPcHRpb25zID0ge2FkZDogdHJ1ZSwgcmVtb3ZlOiB0cnVlLCBtZXJnZTogdHJ1ZX07CiAgdmFyIGFkZE9wdGlvbnMgPSB7YWRkOiB0cnVlLCByZW1vdmU6IGZhbHNlfTsKCiAgLy8gRGVmaW5lIHRoZSBDb2xsZWN0aW9uJ3MgaW5oZXJpdGFibGUgbWV0aG9kcy4KICBfLmV4dGVuZChDb2xsZWN0aW9uLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgbW9kZWwgZm9yIGEgY29sbGVjdGlvbiBpcyBqdXN0IGEgKipCYWNrYm9uZS5Nb2RlbCoqLgogICAgLy8gVGhpcyBzaG91bGQgYmUgb3ZlcnJpZGRlbiBpbiBtb3N0IGNhc2VzLgogICAgbW9kZWw6IE1vZGVsLAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gVGhlIEpTT04gcmVwcmVzZW50YXRpb24gb2YgYSBDb2xsZWN0aW9uIGlzIGFuIGFycmF5IG9mIHRoZQogICAgLy8gbW9kZWxzJyBhdHRyaWJ1dGVzLgogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbihtb2RlbCl7IHJldHVybiBtb2RlbC50b0pTT04ob3B0aW9ucyk7IH0pOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCwgb3IgbGlzdCBvZiBtb2RlbHMgdG8gdGhlIHNldC4KICAgIGFkZDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLnNldChtb2RlbHMsIF8uZXh0ZW5kKHttZXJnZTogZmFsc2V9LCBvcHRpb25zLCBhZGRPcHRpb25zKSk7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsLCBvciBhIGxpc3Qgb2YgbW9kZWxzIGZyb20gdGhlIHNldC4KICAgIHJlbW92ZTogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIHZhciBzaW5ndWxhciA9ICFfLmlzQXJyYXkobW9kZWxzKTsKICAgICAgbW9kZWxzID0gc2luZ3VsYXIgPyBbbW9kZWxzXSA6IF8uY2xvbmUobW9kZWxzKTsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgdmFyIGksIGwsIGluZGV4LCBtb2RlbDsKICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBtb2RlbCA9IG1vZGVsc1tpXSA9IHRoaXMuZ2V0KG1vZGVsc1tpXSk7CiAgICAgICAgaWYgKCFtb2RlbCkgY29udGludWU7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwuaWRdOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmNpZF07CiAgICAgICAgaW5kZXggPSB0aGlzLmluZGV4T2YobW9kZWwpOwogICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgdGhpcy5sZW5ndGgtLTsKICAgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CiAgICAgICAgICBvcHRpb25zLmluZGV4ID0gaW5kZXg7CiAgICAgICAgICBtb2RlbC50cmlnZ2VyKCdyZW1vdmUnLCBtb2RlbCwgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHNpbmd1bGFyID8gbW9kZWxzWzBdIDogbW9kZWxzOwogICAgfSwKCiAgICAvLyBVcGRhdGUgYSBjb2xsZWN0aW9uIGJ5IGBzZXRgLWluZyBhIG5ldyBsaXN0IG9mIG1vZGVscywgYWRkaW5nIG5ldyBvbmVzLAogICAgLy8gcmVtb3ZpbmcgbW9kZWxzIHRoYXQgYXJlIG5vIGxvbmdlciBwcmVzZW50LCBhbmQgbWVyZ2luZyBtb2RlbHMgdGhhdAogICAgLy8gYWxyZWFkeSBleGlzdCBpbiB0aGUgY29sbGVjdGlvbiwgYXMgbmVjZXNzYXJ5LiBTaW1pbGFyIHRvICoqTW9kZWwjc2V0KiosCiAgICAvLyB0aGUgY29yZSBvcGVyYXRpb24gZm9yIHVwZGF0aW5nIHRoZSBkYXRhIGNvbnRhaW5lZCBieSB0aGUgY29sbGVjdGlvbi4KICAgIHNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKHt9LCBvcHRpb25zLCBzZXRPcHRpb25zKTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIG1vZGVscyA9IHRoaXMucGFyc2UobW9kZWxzLCBvcHRpb25zKTsKICAgICAgdmFyIHNpbmd1bGFyID0gIV8uaXNBcnJheShtb2RlbHMpOwogICAgICBtb2RlbHMgPSBzaW5ndWxhciA/IChtb2RlbHMgPyBbbW9kZWxzXSA6IFtdKSA6IF8uY2xvbmUobW9kZWxzKTsKICAgICAgdmFyIGksIGwsIGlkLCBtb2RlbCwgYXR0cnMsIGV4aXN0aW5nLCBzb3J0OwogICAgICB2YXIgYXQgPSBvcHRpb25zLmF0OwogICAgICB2YXIgdGFyZ2V0TW9kZWwgPSB0aGlzLm1vZGVsOwogICAgICB2YXIgc29ydGFibGUgPSB0aGlzLmNvbXBhcmF0b3IgJiYgKGF0ID09IG51bGwpICYmIG9wdGlvbnMuc29ydCAhPT0gZmFsc2U7CiAgICAgIHZhciBzb3J0QXR0ciA9IF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSA/IHRoaXMuY29tcGFyYXRvciA6IG51bGw7CiAgICAgIHZhciB0b0FkZCA9IFtdLCB0b1JlbW92ZSA9IFtdLCBtb2RlbE1hcCA9IHt9OwogICAgICB2YXIgYWRkID0gb3B0aW9ucy5hZGQsIG1lcmdlID0gb3B0aW9ucy5tZXJnZSwgcmVtb3ZlID0gb3B0aW9ucy5yZW1vdmU7CiAgICAgIHZhciBvcmRlciA9ICFzb3J0YWJsZSAmJiBhZGQgJiYgcmVtb3ZlID8gW10gOiBmYWxzZTsKCiAgICAgIC8vIFR1cm4gYmFyZSBvYmplY3RzIGludG8gbW9kZWwgcmVmZXJlbmNlcywgYW5kIHByZXZlbnQgaW52YWxpZCBtb2RlbHMKICAgICAgLy8gZnJvbSBiZWluZyBhZGRlZC4KICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBhdHRycyA9IG1vZGVsc1tpXSB8fCB7fTsKICAgICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiBNb2RlbCkgewogICAgICAgICAgaWQgPSBtb2RlbCA9IGF0dHJzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZCA9IGF0dHJzW3RhcmdldE1vZGVsLnByb3RvdHlwZS5pZEF0dHJpYnV0ZSB8fCAnaWQnXTsKICAgICAgICB9CgogICAgICAgIC8vIElmIGEgZHVwbGljYXRlIGlzIGZvdW5kLCBwcmV2ZW50IGl0IGZyb20gYmVpbmcgYWRkZWQgYW5kCiAgICAgICAgLy8gb3B0aW9uYWxseSBtZXJnZSBpdCBpbnRvIHRoZSBleGlzdGluZyBtb2RlbC4KICAgICAgICBpZiAoZXhpc3RpbmcgPSB0aGlzLmdldChpZCkpIHsKICAgICAgICAgIGlmIChyZW1vdmUpIG1vZGVsTWFwW2V4aXN0aW5nLmNpZF0gPSB0cnVlOwogICAgICAgICAgaWYgKG1lcmdlKSB7CiAgICAgICAgICAgIGF0dHJzID0gYXR0cnMgPT09IG1vZGVsID8gbW9kZWwuYXR0cmlidXRlcyA6IGF0dHJzOwogICAgICAgICAgICBpZiAob3B0aW9ucy5wYXJzZSkgYXR0cnMgPSBleGlzdGluZy5wYXJzZShhdHRycywgb3B0aW9ucyk7CiAgICAgICAgICAgIGV4aXN0aW5nLnNldChhdHRycywgb3B0aW9ucyk7CiAgICAgICAgICAgIGlmIChzb3J0YWJsZSAmJiAhc29ydCAmJiBleGlzdGluZy5oYXNDaGFuZ2VkKHNvcnRBdHRyKSkgc29ydCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBtb2RlbHNbaV0gPSBleGlzdGluZzsKCiAgICAgICAgLy8gSWYgdGhpcyBpcyBhIG5ldywgdmFsaWQgbW9kZWwsIHB1c2ggaXQgdG8gdGhlIGB0b0FkZGAgbGlzdC4KICAgICAgICB9IGVsc2UgaWYgKGFkZCkgewogICAgICAgICAgbW9kZWwgPSBtb2RlbHNbaV0gPSB0aGlzLl9wcmVwYXJlTW9kZWwoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgaWYgKCFtb2RlbCkgY29udGludWU7CiAgICAgICAgICB0b0FkZC5wdXNoKG1vZGVsKTsKICAgICAgICAgIHRoaXMuX2FkZFJlZmVyZW5jZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgICAgfQoKICAgICAgICAvLyBEbyBub3QgYWRkIG11bHRpcGxlIG1vZGVscyB3aXRoIHRoZSBzYW1lIGBpZGAuCiAgICAgICAgbW9kZWwgPSBleGlzdGluZyB8fCBtb2RlbDsKICAgICAgICBpZiAob3JkZXIgJiYgKG1vZGVsLmlzTmV3KCkgfHwgIW1vZGVsTWFwW21vZGVsLmlkXSkpIG9yZGVyLnB1c2gobW9kZWwpOwogICAgICAgIG1vZGVsTWFwW21vZGVsLmlkXSA9IHRydWU7CiAgICAgIH0KCiAgICAgIC8vIFJlbW92ZSBub25leGlzdGVudCBtb2RlbHMgaWYgYXBwcm9wcmlhdGUuCiAgICAgIGlmIChyZW1vdmUpIHsKICAgICAgICBmb3IgKGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyArK2kpIHsKICAgICAgICAgIGlmICghbW9kZWxNYXBbKG1vZGVsID0gdGhpcy5tb2RlbHNbaV0pLmNpZF0pIHRvUmVtb3ZlLnB1c2gobW9kZWwpOwogICAgICAgIH0KICAgICAgICBpZiAodG9SZW1vdmUubGVuZ3RoKSB0aGlzLnJlbW92ZSh0b1JlbW92ZSwgb3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIC8vIFNlZSBpZiBzb3J0aW5nIGlzIG5lZWRlZCwgdXBkYXRlIGBsZW5ndGhgIGFuZCBzcGxpY2UgaW4gbmV3IG1vZGVscy4KICAgICAgaWYgKHRvQWRkLmxlbmd0aCB8fCAob3JkZXIgJiYgb3JkZXIubGVuZ3RoKSkgewogICAgICAgIGlmIChzb3J0YWJsZSkgc29ydCA9IHRydWU7CiAgICAgICAgdGhpcy5sZW5ndGggKz0gdG9BZGQubGVuZ3RoOwogICAgICAgIGlmIChhdCAhPSBudWxsKSB7CiAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gdG9BZGQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShhdCArIGksIDAsIHRvQWRkW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKG9yZGVyKSB0aGlzLm1vZGVscy5sZW5ndGggPSAwOwogICAgICAgICAgdmFyIG9yZGVyZWRNb2RlbHMgPSBvcmRlciB8fCB0b0FkZDsKICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBvcmRlcmVkTW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICB0aGlzLm1vZGVscy5wdXNoKG9yZGVyZWRNb2RlbHNbaV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gU2lsZW50bHkgc29ydCB0aGUgY29sbGVjdGlvbiBpZiBhcHByb3ByaWF0ZS4KICAgICAgaWYgKHNvcnQpIHRoaXMuc29ydCh7c2lsZW50OiB0cnVlfSk7CgogICAgICAvLyBVbmxlc3Mgc2lsZW5jZWQsIGl0J3MgdGltZSB0byBmaXJlIGFsbCBhcHByb3ByaWF0ZSBhZGQvc29ydCBldmVudHMuCiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHsKICAgICAgICBmb3IgKGkgPSAwLCBsID0gdG9BZGQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAobW9kZWwgPSB0b0FkZFtpXSkudHJpZ2dlcignYWRkJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICBpZiAoc29ydCB8fCAob3JkZXIgJiYgb3JkZXIubGVuZ3RoKSkgdGhpcy50cmlnZ2VyKCdzb3J0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIC8vIFJldHVybiB0aGUgYWRkZWQgKG9yIG1lcmdlZCkgbW9kZWwgKG9yIG1vZGVscykuCiAgICAgIHJldHVybiBzaW5ndWxhciA/IG1vZGVsc1swXSA6IG1vZGVsczsKICAgIH0sCgogICAgLy8gV2hlbiB5b3UgaGF2ZSBtb3JlIGl0ZW1zIHRoYW4geW91IHdhbnQgdG8gYWRkIG9yIHJlbW92ZSBpbmRpdmlkdWFsbHksCiAgICAvLyB5b3UgY2FuIHJlc2V0IHRoZSBlbnRpcmUgc2V0IHdpdGggYSBuZXcgbGlzdCBvZiBtb2RlbHMsIHdpdGhvdXQgZmlyaW5nCiAgICAvLyBhbnkgZ3JhbnVsYXIgYGFkZGAgb3IgYHJlbW92ZWAgZXZlbnRzLiBGaXJlcyBgcmVzZXRgIHdoZW4gZmluaXNoZWQuCiAgICAvLyBVc2VmdWwgZm9yIGJ1bGsgb3BlcmF0aW9ucyBhbmQgb3B0aW1pemF0aW9ucy4KICAgIHJlc2V0OiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLm1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UodGhpcy5tb2RlbHNbaV0sIG9wdGlvbnMpOwogICAgICB9CiAgICAgIG9wdGlvbnMucHJldmlvdXNNb2RlbHMgPSB0aGlzLm1vZGVsczsKICAgICAgdGhpcy5fcmVzZXQoKTsKICAgICAgbW9kZWxzID0gdGhpcy5hZGQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3Jlc2V0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbHM7CiAgICB9LAoKICAgIC8vIEFkZCBhIG1vZGVsIHRvIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBwdXNoOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogdGhpcy5sZW5ndGh9LCBvcHRpb25zKSk7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHBvcDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KHRoaXMubGVuZ3RoIC0gMSk7CiAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgdW5zaGlmdDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuYWRkKG1vZGVsLCBfLmV4dGVuZCh7YXQ6IDB9LCBvcHRpb25zKSk7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHNoaWZ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQoMCk7CiAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBTbGljZSBvdXQgYSBzdWItYXJyYXkgb2YgbW9kZWxzIGZyb20gdGhlIGNvbGxlY3Rpb24uCiAgICBzbGljZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBzbGljZS5hcHBseSh0aGlzLm1vZGVscywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgLy8gR2V0IGEgbW9kZWwgZnJvbSB0aGUgc2V0IGJ5IGlkLgogICAgZ2V0OiBmdW5jdGlvbihvYmopIHsKICAgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwogICAgICByZXR1cm4gdGhpcy5fYnlJZFtvYmpdIHx8IHRoaXMuX2J5SWRbb2JqLmlkXSB8fCB0aGlzLl9ieUlkW29iai5jaWRdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIG1vZGVsIGF0IHRoZSBnaXZlbiBpbmRleC4KICAgIGF0OiBmdW5jdGlvbihpbmRleCkgewogICAgICByZXR1cm4gdGhpcy5tb2RlbHNbaW5kZXhdOwogICAgfSwKCiAgICAvLyBSZXR1cm4gbW9kZWxzIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMgb2YKICAgIC8vIGBmaWx0ZXJgLgogICAgd2hlcmU6IGZ1bmN0aW9uKGF0dHJzLCBmaXJzdCkgewogICAgICBpZiAoXy5pc0VtcHR5KGF0dHJzKSkgcmV0dXJuIGZpcnN0ID8gdm9pZCAwIDogW107CiAgICAgIHJldHVybiB0aGlzW2ZpcnN0ID8gJ2ZpbmQnIDogJ2ZpbHRlciddKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gbW9kZWwuZ2V0KGtleSkpIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBSZXR1cm4gdGhlIGZpcnN0IG1vZGVsIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMKICAgIC8vIG9mIGBmaW5kYC4KICAgIGZpbmRXaGVyZTogZnVuY3Rpb24oYXR0cnMpIHsKICAgICAgcmV0dXJuIHRoaXMud2hlcmUoYXR0cnMsIHRydWUpOwogICAgfSwKCiAgICAvLyBGb3JjZSB0aGUgY29sbGVjdGlvbiB0byByZS1zb3J0IGl0c2VsZi4gWW91IGRvbid0IG5lZWQgdG8gY2FsbCB0aGlzIHVuZGVyCiAgICAvLyBub3JtYWwgY2lyY3Vtc3RhbmNlcywgYXMgdGhlIHNldCB3aWxsIG1haW50YWluIHNvcnQgb3JkZXIgYXMgZWFjaCBpdGVtCiAgICAvLyBpcyBhZGRlZC4KICAgIHNvcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKCF0aGlzLmNvbXBhcmF0b3IpIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHNvcnQgYSBzZXQgd2l0aG91dCBhIGNvbXBhcmF0b3InKTsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCiAgICAgIC8vIFJ1biBzb3J0IGJhc2VkIG9uIHR5cGUgb2YgYGNvbXBhcmF0b3JgLgogICAgICBpZiAoXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpIHx8IHRoaXMuY29tcGFyYXRvci5sZW5ndGggPT09IDEpIHsKICAgICAgICB0aGlzLm1vZGVscyA9IHRoaXMuc29ydEJ5KHRoaXMuY29tcGFyYXRvciwgdGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5tb2RlbHMuc29ydChfLmJpbmQodGhpcy5jb21wYXJhdG9yLCB0aGlzKSk7CiAgICAgIH0KCiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUGx1Y2sgYW4gYXR0cmlidXRlIGZyb20gZWFjaCBtb2RlbCBpbiB0aGUgY29sbGVjdGlvbi4KICAgIHBsdWNrOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiBfLmludm9rZSh0aGlzLm1vZGVscywgJ2dldCcsIGF0dHIpOwogICAgfSwKCiAgICAvLyBGZXRjaCB0aGUgZGVmYXVsdCBzZXQgb2YgbW9kZWxzIGZvciB0aGlzIGNvbGxlY3Rpb24sIHJlc2V0dGluZyB0aGUKICAgIC8vIGNvbGxlY3Rpb24gd2hlbiB0aGV5IGFycml2ZS4gSWYgYHJlc2V0OiB0cnVlYCBpcyBwYXNzZWQsIHRoZSByZXNwb25zZQogICAgLy8gZGF0YSB3aWxsIGJlIHBhc3NlZCB0aHJvdWdoIHRoZSBgcmVzZXRgIG1ldGhvZCBpbnN0ZWFkIG9mIGBzZXRgLgogICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgdmFyIGNvbGxlY3Rpb24gPSB0aGlzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IG9wdGlvbnMucmVzZXQgPyAncmVzZXQnIDogJ3NldCc7CiAgICAgICAgY29sbGVjdGlvblttZXRob2RdKHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGNvbGxlY3Rpb24udHJpZ2dlcignc3luYycsIGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIGEgbW9kZWwgaW4gdGhpcyBjb2xsZWN0aW9uLiBBZGQgdGhlIG1vZGVsIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbiBpbW1lZGlhdGVseSwgdW5sZXNzIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIGluIHdoaWNoIGNhc2Ugd2UKICAgIC8vIHdhaXQgZm9yIHRoZSBzZXJ2ZXIgdG8gYWdyZWUuCiAgICBjcmVhdGU6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAoIShtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbCwgb3B0aW9ucykpKSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICghb3B0aW9ucy53YWl0KSB0aGlzLmFkZChtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKG1vZGVsLCByZXNwKSB7CiAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkgY29sbGVjdGlvbi5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgbW9kZWwuc2F2ZShudWxsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIGEgbGlzdCBvZiBtb2RlbHMgdG8gYmUgYWRkZWQgdG8gdGhlCiAgICAvLyBjb2xsZWN0aW9uLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgaXQgdGhyb3VnaC4KICAgIHBhcnNlOiBmdW5jdGlvbihyZXNwLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiByZXNwOwogICAgfSwKCiAgICAvLyBDcmVhdGUgYSBuZXcgY29sbGVjdGlvbiB3aXRoIGFuIGlkZW50aWNhbCBsaXN0IG9mIG1vZGVscyBhcyB0aGlzIG9uZS4KICAgIGNsb25lOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMubW9kZWxzKTsKICAgIH0sCgogICAgLy8gUHJpdmF0ZSBtZXRob2QgdG8gcmVzZXQgYWxsIGludGVybmFsIHN0YXRlLiBDYWxsZWQgd2hlbiB0aGUgY29sbGVjdGlvbgogICAgLy8gaXMgZmlyc3QgaW5pdGlhbGl6ZWQgb3IgcmVzZXQuCiAgICBfcmVzZXQ6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICAgIHRoaXMubW9kZWxzID0gW107CiAgICAgIHRoaXMuX2J5SWQgID0ge307CiAgICB9LAoKICAgIC8vIFByZXBhcmUgYSBoYXNoIG9mIGF0dHJpYnV0ZXMgKG9yIG90aGVyIG1vZGVsKSB0byBiZSBhZGRlZCB0byB0aGlzCiAgICAvLyBjb2xsZWN0aW9uLgogICAgX3ByZXBhcmVNb2RlbDogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKICAgICAgaWYgKGF0dHJzIGluc3RhbmNlb2YgTW9kZWwpIHJldHVybiBhdHRyczsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIG9wdGlvbnMuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBtb2RlbCA9IG5ldyB0aGlzLm1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgaWYgKCFtb2RlbC52YWxpZGF0aW9uRXJyb3IpIHJldHVybiBtb2RlbDsKICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgbW9kZWwudmFsaWRhdGlvbkVycm9yLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gY3JlYXRlIGEgbW9kZWwncyB0aWVzIHRvIGEgY29sbGVjdGlvbi4KICAgIF9hZGRSZWZlcmVuY2U6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIHRoaXMuX2J5SWRbbW9kZWwuY2lkXSA9IG1vZGVsOwogICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgaWYgKCFtb2RlbC5jb2xsZWN0aW9uKSBtb2RlbC5jb2xsZWN0aW9uID0gdGhpczsKICAgICAgbW9kZWwub24oJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBzZXZlciBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uCiAgICBfcmVtb3ZlUmVmZXJlbmNlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICBpZiAodGhpcyA9PT0gbW9kZWwuY29sbGVjdGlvbikgZGVsZXRlIG1vZGVsLmNvbGxlY3Rpb247CiAgICAgIG1vZGVsLm9mZignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgIH0sCgogICAgLy8gSW50ZXJuYWwgbWV0aG9kIGNhbGxlZCBldmVyeSB0aW1lIGEgbW9kZWwgaW4gdGhlIHNldCBmaXJlcyBhbiBldmVudC4KICAgIC8vIFNldHMgbmVlZCB0byB1cGRhdGUgdGhlaXIgaW5kZXhlcyB3aGVuIG1vZGVscyBjaGFuZ2UgaWRzLiBBbGwgb3RoZXIKICAgIC8vIGV2ZW50cyBzaW1wbHkgcHJveHkgdGhyb3VnaC4gImFkZCIgYW5kICJyZW1vdmUiIGV2ZW50cyB0aGF0IG9yaWdpbmF0ZQogICAgLy8gaW4gb3RoZXIgY29sbGVjdGlvbnMgYXJlIGlnbm9yZWQuCiAgICBfb25Nb2RlbEV2ZW50OiBmdW5jdGlvbihldmVudCwgbW9kZWwsIGNvbGxlY3Rpb24sIG9wdGlvbnMpIHsKICAgICAgaWYgKChldmVudCA9PT0gJ2FkZCcgfHwgZXZlbnQgPT09ICdyZW1vdmUnKSAmJiBjb2xsZWN0aW9uICE9PSB0aGlzKSByZXR1cm47CiAgICAgIGlmIChldmVudCA9PT0gJ2Rlc3Ryb3knKSB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIGlmIChtb2RlbCAmJiBldmVudCA9PT0gJ2NoYW5nZTonICsgbW9kZWwuaWRBdHRyaWJ1dGUpIHsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5wcmV2aW91cyhtb2RlbC5pZEF0dHJpYnV0ZSldOwogICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQoKICB9KTsKCiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIENvbGxlY3Rpb24uCiAgLy8gOTAlIG9mIHRoZSBjb3JlIHVzZWZ1bG5lc3Mgb2YgQmFja2JvbmUgQ29sbGVjdGlvbnMgaXMgYWN0dWFsbHkgaW1wbGVtZW50ZWQKICAvLyByaWdodCBoZXJlOgogIHZhciBtZXRob2RzID0gWydmb3JFYWNoJywgJ2VhY2gnLCAnbWFwJywgJ2NvbGxlY3QnLCAncmVkdWNlJywgJ2ZvbGRsJywKICAgICdpbmplY3QnLCAncmVkdWNlUmlnaHQnLCAnZm9sZHInLCAnZmluZCcsICdkZXRlY3QnLCAnZmlsdGVyJywgJ3NlbGVjdCcsCiAgICAncmVqZWN0JywgJ2V2ZXJ5JywgJ2FsbCcsICdzb21lJywgJ2FueScsICdpbmNsdWRlJywgJ2NvbnRhaW5zJywgJ2ludm9rZScsCiAgICAnbWF4JywgJ21pbicsICd0b0FycmF5JywgJ3NpemUnLCAnZmlyc3QnLCAnaGVhZCcsICd0YWtlJywgJ2luaXRpYWwnLCAncmVzdCcsCiAgICAndGFpbCcsICdkcm9wJywgJ2xhc3QnLCAnd2l0aG91dCcsICdkaWZmZXJlbmNlJywgJ2luZGV4T2YnLCAnc2h1ZmZsZScsCiAgICAnbGFzdEluZGV4T2YnLCAnaXNFbXB0eScsICdjaGFpbicsICdzYW1wbGUnXTsKCiAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgQ29sbGVjdGlvbiNtb2RlbHNgLgogIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIENvbGxlY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLm1vZGVscyk7CiAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CiAgICB9OwogIH0pOwoKICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB0YWtlIGEgcHJvcGVydHkgbmFtZSBhcyBhbiBhcmd1bWVudC4KICB2YXIgYXR0cmlidXRlTWV0aG9kcyA9IFsnZ3JvdXBCeScsICdjb3VudEJ5JywgJ3NvcnRCeScsICdpbmRleEJ5J107CgogIC8vIFVzZSBhdHRyaWJ1dGVzIGluc3RlYWQgb2YgcHJvcGVydGllcy4KICBfLmVhY2goYXR0cmlidXRlTWV0aG9kcywgZnVuY3Rpb24obWV0aG9kKSB7CiAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24odmFsdWUsIGNvbnRleHQpIHsKICAgICAgdmFyIGl0ZXJhdG9yID0gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlIDogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgICByZXR1cm4gbW9kZWwuZ2V0KHZhbHVlKTsKICAgICAgfTsKICAgICAgcmV0dXJuIF9bbWV0aG9kXSh0aGlzLm1vZGVscywgaXRlcmF0b3IsIGNvbnRleHQpOwogICAgfTsKICB9KTsKCiAgLy8gQmFja2JvbmUuVmlldwogIC8vIC0tLS0tLS0tLS0tLS0KCiAgLy8gQmFja2JvbmUgVmlld3MgYXJlIGFsbW9zdCBtb3JlIGNvbnZlbnRpb24gdGhhbiB0aGV5IGFyZSBhY3R1YWwgY29kZS4gQSBWaWV3CiAgLy8gaXMgc2ltcGx5IGEgSmF2YVNjcmlwdCBvYmplY3QgdGhhdCByZXByZXNlbnRzIGEgbG9naWNhbCBjaHVuayBvZiBVSSBpbiB0aGUKICAvLyBET00uIFRoaXMgbWlnaHQgYmUgYSBzaW5nbGUgaXRlbSwgYW4gZW50aXJlIGxpc3QsIGEgc2lkZWJhciBvciBwYW5lbCwgb3IKICAvLyBldmVuIHRoZSBzdXJyb3VuZGluZyBmcmFtZSB3aGljaCB3cmFwcyB5b3VyIHdob2xlIGFwcC4gRGVmaW5pbmcgYSBjaHVuayBvZgogIC8vIFVJIGFzIGEgKipWaWV3KiogYWxsb3dzIHlvdSB0byBkZWZpbmUgeW91ciBET00gZXZlbnRzIGRlY2xhcmF0aXZlbHksIHdpdGhvdXQKICAvLyBoYXZpbmcgdG8gd29ycnkgYWJvdXQgcmVuZGVyIG9yZGVyIC4uLiBhbmQgbWFrZXMgaXQgZWFzeSBmb3IgdGhlIHZpZXcgdG8KICAvLyByZWFjdCB0byBzcGVjaWZpYyBjaGFuZ2VzIGluIHRoZSBzdGF0ZSBvZiB5b3VyIG1vZGVscy4KCiAgLy8gQ3JlYXRpbmcgYSBCYWNrYm9uZS5WaWV3IGNyZWF0ZXMgaXRzIGluaXRpYWwgZWxlbWVudCBvdXRzaWRlIG9mIHRoZSBET00sCiAgLy8gaWYgYW4gZXhpc3RpbmcgZWxlbWVudCBpcyBub3QgcHJvdmlkZWQuLi4KICB2YXIgVmlldyA9IEJhY2tib25lLlZpZXcgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ3ZpZXcnKTsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBfLmV4dGVuZCh0aGlzLCBfLnBpY2sob3B0aW9ucywgdmlld09wdGlvbnMpKTsKICAgIHRoaXMuX2Vuc3VyZUVsZW1lbnQoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogIH07CgogIC8vIENhY2hlZCByZWdleCB0byBzcGxpdCBrZXlzIGZvciBgZGVsZWdhdGVgLgogIHZhciBkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIgPSAvXihcUyspXHMqKC4qKSQvOwoKICAvLyBMaXN0IG9mIHZpZXcgb3B0aW9ucyB0byBiZSBtZXJnZWQgYXMgcHJvcGVydGllcy4KICB2YXIgdmlld09wdGlvbnMgPSBbJ21vZGVsJywgJ2NvbGxlY3Rpb24nLCAnZWwnLCAnaWQnLCAnYXR0cmlidXRlcycsICdjbGFzc05hbWUnLCAndGFnTmFtZScsICdldmVudHMnXTsKCiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLlZpZXcqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKFZpZXcucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBUaGUgZGVmYXVsdCBgdGFnTmFtZWAgb2YgYSBWaWV3J3MgZWxlbWVudCBpcyBgImRpdiJgLgogICAgdGFnTmFtZTogJ2RpdicsCgogICAgLy8galF1ZXJ5IGRlbGVnYXRlIGZvciBlbGVtZW50IGxvb2t1cCwgc2NvcGVkIHRvIERPTSBlbGVtZW50cyB3aXRoaW4gdGhlCiAgICAvLyBjdXJyZW50IHZpZXcuIFRoaXMgc2hvdWxkIGJlIHByZWZlcnJlZCB0byBnbG9iYWwgbG9va3VwcyB3aGVyZSBwb3NzaWJsZS4KICAgICQ6IGZ1bmN0aW9uKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLiRlbC5maW5kKHNlbGVjdG9yKTsKICAgIH0sCgogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCiAgICAvLyAqKnJlbmRlcioqIGlzIHRoZSBjb3JlIGZ1bmN0aW9uIHRoYXQgeW91ciB2aWV3IHNob3VsZCBvdmVycmlkZSwgaW4gb3JkZXIKICAgIC8vIHRvIHBvcHVsYXRlIGl0cyBlbGVtZW50IChgdGhpcy5lbGApLCB3aXRoIHRoZSBhcHByb3ByaWF0ZSBIVE1MLiBUaGUKICAgIC8vIGNvbnZlbnRpb24gaXMgZm9yICoqcmVuZGVyKiogdG8gYWx3YXlzIHJldHVybiBgdGhpc2AuCiAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUmVtb3ZlIHRoaXMgdmlldyBieSB0YWtpbmcgdGhlIGVsZW1lbnQgb3V0IG9mIHRoZSBET00sIGFuZCByZW1vdmluZyBhbnkKICAgIC8vIGFwcGxpY2FibGUgQmFja2JvbmUuRXZlbnRzIGxpc3RlbmVycy4KICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLnJlbW92ZSgpOwogICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIENoYW5nZSB0aGUgdmlldydzIGVsZW1lbnQgKGB0aGlzLmVsYCBwcm9wZXJ0eSksIGluY2x1ZGluZyBldmVudAogICAgLy8gcmUtZGVsZWdhdGlvbi4KICAgIHNldEVsZW1lbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIGRlbGVnYXRlKSB7CiAgICAgIGlmICh0aGlzLiRlbCkgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIHRoaXMuJGVsID0gZWxlbWVudCBpbnN0YW5jZW9mIEJhY2tib25lLiQgPyBlbGVtZW50IDogQmFja2JvbmUuJChlbGVtZW50KTsKICAgICAgdGhpcy5lbCA9IHRoaXMuJGVsWzBdOwogICAgICBpZiAoZGVsZWdhdGUgIT09IGZhbHNlKSB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBTZXQgY2FsbGJhY2tzLCB3aGVyZSBgdGhpcy5ldmVudHNgIGlzIGEgaGFzaCBvZgogICAgLy8KICAgIC8vICp7ImV2ZW50IHNlbGVjdG9yIjogImNhbGxiYWNrIn0qCiAgICAvLwogICAgLy8gICAgIHsKICAgIC8vICAgICAgICdtb3VzZWRvd24gLnRpdGxlJzogICdlZGl0JywKICAgIC8vICAgICAgICdjbGljayAuYnV0dG9uJzogICAgICdzYXZlJywKICAgIC8vICAgICAgICdjbGljayAub3Blbic6ICAgICAgIGZ1bmN0aW9uKGUpIHsgLi4uIH0KICAgIC8vICAgICB9CiAgICAvLwogICAgLy8gcGFpcnMuIENhbGxiYWNrcyB3aWxsIGJlIGJvdW5kIHRvIHRoZSB2aWV3LCB3aXRoIGB0aGlzYCBzZXQgcHJvcGVybHkuCiAgICAvLyBVc2VzIGV2ZW50IGRlbGVnYXRpb24gZm9yIGVmZmljaWVuY3kuCiAgICAvLyBPbWl0dGluZyB0aGUgc2VsZWN0b3IgYmluZHMgdGhlIGV2ZW50IHRvIGB0aGlzLmVsYC4KICAgIC8vIFRoaXMgb25seSB3b3JrcyBmb3IgZGVsZWdhdGUtYWJsZSBldmVudHM6IG5vdCBgZm9jdXNgLCBgYmx1cmAsIGFuZAogICAgLy8gbm90IGBjaGFuZ2VgLCBgc3VibWl0YCwgYW5kIGByZXNldGAgaW4gSW50ZXJuZXQgRXhwbG9yZXIuCiAgICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oZXZlbnRzKSB7CiAgICAgIGlmICghKGV2ZW50cyB8fCAoZXZlbnRzID0gXy5yZXN1bHQodGhpcywgJ2V2ZW50cycpKSkpIHJldHVybiB0aGlzOwogICAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgICAgZm9yICh2YXIga2V5IGluIGV2ZW50cykgewogICAgICAgIHZhciBtZXRob2QgPSBldmVudHNba2V5XTsKICAgICAgICBpZiAoIV8uaXNGdW5jdGlvbihtZXRob2QpKSBtZXRob2QgPSB0aGlzW2V2ZW50c1trZXldXTsKICAgICAgICBpZiAoIW1ldGhvZCkgY29udGludWU7CgogICAgICAgIHZhciBtYXRjaCA9IGtleS5tYXRjaChkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIpOwogICAgICAgIHZhciBldmVudE5hbWUgPSBtYXRjaFsxXSwgc2VsZWN0b3IgPSBtYXRjaFsyXTsKICAgICAgICBtZXRob2QgPSBfLmJpbmQobWV0aG9kLCB0aGlzKTsKICAgICAgICBldmVudE5hbWUgKz0gJy5kZWxlZ2F0ZUV2ZW50cycgKyB0aGlzLmNpZDsKICAgICAgICBpZiAoc2VsZWN0b3IgPT09ICcnKSB7CiAgICAgICAgICB0aGlzLiRlbC5vbihldmVudE5hbWUsIG1ldGhvZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuJGVsLm9uKGV2ZW50TmFtZSwgc2VsZWN0b3IsIG1ldGhvZCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBDbGVhcnMgYWxsIGNhbGxiYWNrcyBwcmV2aW91c2x5IGJvdW5kIHRvIHRoZSB2aWV3IHdpdGggYGRlbGVnYXRlRXZlbnRzYC4KICAgIC8vIFlvdSB1c3VhbGx5IGRvbid0IG5lZWQgdG8gdXNlIHRoaXMsIGJ1dCBtYXkgd2lzaCB0byBpZiB5b3UgaGF2ZSBtdWx0aXBsZQogICAgLy8gQmFja2JvbmUgdmlld3MgYXR0YWNoZWQgdG8gdGhlIHNhbWUgRE9NIGVsZW1lbnQuCiAgICB1bmRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy4kZWwub2ZmKCcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gRW5zdXJlIHRoYXQgdGhlIFZpZXcgaGFzIGEgRE9NIGVsZW1lbnQgdG8gcmVuZGVyIGludG8uCiAgICAvLyBJZiBgdGhpcy5lbGAgaXMgYSBzdHJpbmcsIHBhc3MgaXQgdGhyb3VnaCBgJCgpYCwgdGFrZSB0aGUgZmlyc3QKICAgIC8vIG1hdGNoaW5nIGVsZW1lbnQsIGFuZCByZS1hc3NpZ24gaXQgdG8gYGVsYC4gT3RoZXJ3aXNlLCBjcmVhdGUKICAgIC8vIGFuIGVsZW1lbnQgZnJvbSB0aGUgYGlkYCwgYGNsYXNzTmFtZWAgYW5kIGB0YWdOYW1lYCBwcm9wZXJ0aWVzLgogICAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXRoaXMuZWwpIHsKICAgICAgICB2YXIgYXR0cnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ2F0dHJpYnV0ZXMnKSk7CiAgICAgICAgaWYgKHRoaXMuaWQpIGF0dHJzLmlkID0gXy5yZXN1bHQodGhpcywgJ2lkJyk7CiAgICAgICAgaWYgKHRoaXMuY2xhc3NOYW1lKSBhdHRyc1snY2xhc3MnXSA9IF8ucmVzdWx0KHRoaXMsICdjbGFzc05hbWUnKTsKICAgICAgICB2YXIgJGVsID0gQmFja2JvbmUuJCgnPCcgKyBfLnJlc3VsdCh0aGlzLCAndGFnTmFtZScpICsgJz4nKS5hdHRyKGF0dHJzKTsKICAgICAgICB0aGlzLnNldEVsZW1lbnQoJGVsLCBmYWxzZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KF8ucmVzdWx0KHRoaXMsICdlbCcpLCBmYWxzZSk7CiAgICAgIH0KICAgIH0KCiAgfSk7CgogIC8vIEJhY2tib25lLnN5bmMKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIE92ZXJyaWRlIHRoaXMgZnVuY3Rpb24gdG8gY2hhbmdlIHRoZSBtYW5uZXIgaW4gd2hpY2ggQmFja2JvbmUgcGVyc2lzdHMKICAvLyBtb2RlbHMgdG8gdGhlIHNlcnZlci4gWW91IHdpbGwgYmUgcGFzc2VkIHRoZSB0eXBlIG9mIHJlcXVlc3QsIGFuZCB0aGUKICAvLyBtb2RlbCBpbiBxdWVzdGlvbi4gQnkgZGVmYXVsdCwgbWFrZXMgYSBSRVNUZnVsIEFqYXggcmVxdWVzdAogIC8vIHRvIHRoZSBtb2RlbCdzIGB1cmwoKWAuIFNvbWUgcG9zc2libGUgY3VzdG9taXphdGlvbnMgY291bGQgYmU6CiAgLy8KICAvLyAqIFVzZSBgc2V0VGltZW91dGAgdG8gYmF0Y2ggcmFwaWQtZmlyZSB1cGRhdGVzIGludG8gYSBzaW5nbGUgcmVxdWVzdC4KICAvLyAqIFNlbmQgdXAgdGhlIG1vZGVscyBhcyBYTUwgaW5zdGVhZCBvZiBKU09OLgogIC8vICogUGVyc2lzdCBtb2RlbHMgdmlhIFdlYlNvY2tldHMgaW5zdGVhZCBvZiBBamF4LgogIC8vCiAgLy8gVHVybiBvbiBgQmFja2JvbmUuZW11bGF0ZUhUVFBgIGluIG9yZGVyIHRvIHNlbmQgYFBVVGAgYW5kIGBERUxFVEVgIHJlcXVlc3RzCiAgLy8gYXMgYFBPU1RgLCB3aXRoIGEgYF9tZXRob2RgIHBhcmFtZXRlciBjb250YWluaW5nIHRoZSB0cnVlIEhUVFAgbWV0aG9kLAogIC8vIGFzIHdlbGwgYXMgYWxsIHJlcXVlc3RzIHdpdGggdGhlIGJvZHkgYXMgYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAKICAvLyBpbnN0ZWFkIG9mIGBhcHBsaWNhdGlvbi9qc29uYCB3aXRoIHRoZSBtb2RlbCBpbiBhIHBhcmFtIG5hbWVkIGBtb2RlbGAuCiAgLy8gVXNlZnVsIHdoZW4gaW50ZXJmYWNpbmcgd2l0aCBzZXJ2ZXItc2lkZSBsYW5ndWFnZXMgbGlrZSAqKlBIUCoqIHRoYXQgbWFrZQogIC8vIGl0IGRpZmZpY3VsdCB0byByZWFkIHRoZSBib2R5IG9mIGBQVVRgIHJlcXVlc3RzLgogIEJhY2tib25lLnN5bmMgPSBmdW5jdGlvbihtZXRob2QsIG1vZGVsLCBvcHRpb25zKSB7CiAgICB2YXIgdHlwZSA9IG1ldGhvZE1hcFttZXRob2RdOwoKICAgIC8vIERlZmF1bHQgb3B0aW9ucywgdW5sZXNzIHNwZWNpZmllZC4KICAgIF8uZGVmYXVsdHMob3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KSwgewogICAgICBlbXVsYXRlSFRUUDogQmFja2JvbmUuZW11bGF0ZUhUVFAsCiAgICAgIGVtdWxhdGVKU09OOiBCYWNrYm9uZS5lbXVsYXRlSlNPTgogICAgfSk7CgogICAgLy8gRGVmYXVsdCBKU09OLXJlcXVlc3Qgb3B0aW9ucy4KICAgIHZhciBwYXJhbXMgPSB7dHlwZTogdHlwZSwgZGF0YVR5cGU6ICdqc29uJ307CgogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSBhIFVSTC4KICAgIGlmICghb3B0aW9ucy51cmwpIHsKICAgICAgcGFyYW1zLnVybCA9IF8ucmVzdWx0KG1vZGVsLCAndXJsJykgfHwgdXJsRXJyb3IoKTsKICAgIH0KCiAgICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIHRoZSBhcHByb3ByaWF0ZSByZXF1ZXN0IGRhdGEuCiAgICBpZiAob3B0aW9ucy5kYXRhID09IG51bGwgJiYgbW9kZWwgJiYgKG1ldGhvZCA9PT0gJ2NyZWF0ZScgfHwgbWV0aG9kID09PSAndXBkYXRlJyB8fCBtZXRob2QgPT09ICdwYXRjaCcpKSB7CiAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJzsKICAgICAgcGFyYW1zLmRhdGEgPSBKU09OLnN0cmluZ2lmeShvcHRpb25zLmF0dHJzIHx8IG1vZGVsLnRvSlNPTihvcHRpb25zKSk7CiAgICB9CgogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSlNPTiBieSBlbmNvZGluZyB0aGUgcmVxdWVzdCBpbnRvIGFuIEhUTUwtZm9ybS4KICAgIGlmIChvcHRpb25zLmVtdWxhdGVKU09OKSB7CiAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnOwogICAgICBwYXJhbXMuZGF0YSA9IHBhcmFtcy5kYXRhID8ge21vZGVsOiBwYXJhbXMuZGF0YX0gOiB7fTsKICAgIH0KCiAgICAvLyBGb3Igb2xkZXIgc2VydmVycywgZW11bGF0ZSBIVFRQIGJ5IG1pbWlja2luZyB0aGUgSFRUUCBtZXRob2Qgd2l0aCBgX21ldGhvZGAKICAgIC8vIEFuZCBhbiBgWC1IVFRQLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgogICAgaWYgKG9wdGlvbnMuZW11bGF0ZUhUVFAgJiYgKHR5cGUgPT09ICdQVVQnIHx8IHR5cGUgPT09ICdERUxFVEUnIHx8IHR5cGUgPT09ICdQQVRDSCcpKSB7CiAgICAgIHBhcmFtcy50eXBlID0gJ1BPU1QnOwogICAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgcGFyYW1zLmRhdGEuX21ldGhvZCA9IHR5cGU7CiAgICAgIHZhciBiZWZvcmVTZW5kID0gb3B0aW9ucy5iZWZvcmVTZW5kOwogICAgICBvcHRpb25zLmJlZm9yZVNlbmQgPSBmdW5jdGlvbih4aHIpIHsKICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignWC1IVFRQLU1ldGhvZC1PdmVycmlkZScsIHR5cGUpOwogICAgICAgIGlmIChiZWZvcmVTZW5kKSByZXR1cm4gYmVmb3JlU2VuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQoKICAgIC8vIERvbid0IHByb2Nlc3MgZGF0YSBvbiBhIG5vbi1HRVQgcmVxdWVzdC4KICAgIGlmIChwYXJhbXMudHlwZSAhPT0gJ0dFVCcgJiYgIW9wdGlvbnMuZW11bGF0ZUpTT04pIHsKICAgICAgcGFyYW1zLnByb2Nlc3NEYXRhID0gZmFsc2U7CiAgICB9CgogICAgLy8gSWYgd2UncmUgc2VuZGluZyBhIGBQQVRDSGAgcmVxdWVzdCwgYW5kIHdlJ3JlIGluIGFuIG9sZCBJbnRlcm5ldCBFeHBsb3JlcgogICAgLy8gdGhhdCBzdGlsbCBoYXMgQWN0aXZlWCBlbmFibGVkIGJ5IGRlZmF1bHQsIG92ZXJyaWRlIGpRdWVyeSB0byB1c2UgdGhhdAogICAgLy8gZm9yIFhIUiBpbnN0ZWFkLiBSZW1vdmUgdGhpcyBsaW5lIHdoZW4galF1ZXJ5IHN1cHBvcnRzIGBQQVRDSGAgb24gSUU4LgogICAgaWYgKHBhcmFtcy50eXBlID09PSAnUEFUQ0gnICYmIG5vWGhyUGF0Y2gpIHsKICAgICAgcGFyYW1zLnhociA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgiTWljcm9zb2Z0LlhNTEhUVFAiKTsKICAgICAgfTsKICAgIH0KCiAgICAvLyBNYWtlIHRoZSByZXF1ZXN0LCBhbGxvd2luZyB0aGUgdXNlciB0byBvdmVycmlkZSBhbnkgQWpheCBvcHRpb25zLgogICAgdmFyIHhociA9IG9wdGlvbnMueGhyID0gQmFja2JvbmUuYWpheChfLmV4dGVuZChwYXJhbXMsIG9wdGlvbnMpKTsKICAgIG1vZGVsLnRyaWdnZXIoJ3JlcXVlc3QnLCBtb2RlbCwgeGhyLCBvcHRpb25zKTsKICAgIHJldHVybiB4aHI7CiAgfTsKCiAgdmFyIG5vWGhyUGF0Y2ggPQogICAgdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgISF3aW5kb3cuQWN0aXZlWE9iamVjdCAmJgogICAgICAhKHdpbmRvdy5YTUxIdHRwUmVxdWVzdCAmJiAobmV3IFhNTEh0dHBSZXF1ZXN0KS5kaXNwYXRjaEV2ZW50KTsKCiAgLy8gTWFwIGZyb20gQ1JVRCB0byBIVFRQIGZvciBvdXIgZGVmYXVsdCBgQmFja2JvbmUuc3luY2AgaW1wbGVtZW50YXRpb24uCiAgdmFyIG1ldGhvZE1hcCA9IHsKICAgICdjcmVhdGUnOiAnUE9TVCcsCiAgICAndXBkYXRlJzogJ1BVVCcsCiAgICAncGF0Y2gnOiAgJ1BBVENIJywKICAgICdkZWxldGUnOiAnREVMRVRFJywKICAgICdyZWFkJzogICAnR0VUJwogIH07CgogIC8vIFNldCB0aGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiBgQmFja2JvbmUuYWpheGAgdG8gcHJveHkgdGhyb3VnaCB0byBgJGAuCiAgLy8gT3ZlcnJpZGUgdGhpcyBpZiB5b3UnZCBsaWtlIHRvIHVzZSBhIGRpZmZlcmVudCBsaWJyYXJ5LgogIEJhY2tib25lLmFqYXggPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBCYWNrYm9uZS4kLmFqYXguYXBwbHkoQmFja2JvbmUuJCwgYXJndW1lbnRzKTsKICB9OwoKICAvLyBCYWNrYm9uZS5Sb3V0ZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0KCiAgLy8gUm91dGVycyBtYXAgZmF1eC1VUkxzIHRvIGFjdGlvbnMsIGFuZCBmaXJlIGV2ZW50cyB3aGVuIHJvdXRlcyBhcmUKICAvLyBtYXRjaGVkLiBDcmVhdGluZyBhIG5ldyBvbmUgc2V0cyBpdHMgYHJvdXRlc2AgaGFzaCwgaWYgbm90IHNldCBzdGF0aWNhbGx5LgogIHZhciBSb3V0ZXIgPSBCYWNrYm9uZS5Sb3V0ZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgaWYgKG9wdGlvbnMucm91dGVzKSB0aGlzLnJvdXRlcyA9IG9wdGlvbnMucm91dGVzOwogICAgdGhpcy5fYmluZFJvdXRlcygpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLy8gQ2FjaGVkIHJlZ3VsYXIgZXhwcmVzc2lvbnMgZm9yIG1hdGNoaW5nIG5hbWVkIHBhcmFtIHBhcnRzIGFuZCBzcGxhdHRlZAogIC8vIHBhcnRzIG9mIHJvdXRlIHN0cmluZ3MuCiAgdmFyIG9wdGlvbmFsUGFyYW0gPSAvXCgoLio/KVwpL2c7CiAgdmFyIG5hbWVkUGFyYW0gICAgPSAvKFwoXD8pPzpcdysvZzsKICB2YXIgc3BsYXRQYXJhbSAgICA9IC9cKlx3Ky9nOwogIHZhciBlc2NhcGVSZWdFeHAgID0gL1tcLXt9XFtcXSs/LixcXFxeJHwjXHNdL2c7CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5Sb3V0ZXIqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKFJvdXRlci5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gTWFudWFsbHkgYmluZCBhIHNpbmdsZSBuYW1lZCByb3V0ZSB0byBhIGNhbGxiYWNrLiBGb3IgZXhhbXBsZToKICAgIC8vCiAgICAvLyAgICAgdGhpcy5yb3V0ZSgnc2VhcmNoLzpxdWVyeS9wOm51bScsICdzZWFyY2gnLCBmdW5jdGlvbihxdWVyeSwgbnVtKSB7CiAgICAvLyAgICAgICAuLi4KICAgIC8vICAgICB9KTsKICAgIC8vCiAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIGlmICghXy5pc1JlZ0V4cChyb3V0ZSkpIHJvdXRlID0gdGhpcy5fcm91dGVUb1JlZ0V4cChyb3V0ZSk7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24obmFtZSkpIHsKICAgICAgICBjYWxsYmFjayA9IG5hbWU7CiAgICAgICAgbmFtZSA9ICcnOwogICAgICB9CiAgICAgIGlmICghY2FsbGJhY2spIGNhbGxiYWNrID0gdGhpc1tuYW1lXTsKICAgICAgdmFyIHJvdXRlciA9IHRoaXM7CiAgICAgIEJhY2tib25lLmhpc3Rvcnkucm91dGUocm91dGUsIGZ1bmN0aW9uKGZyYWdtZW50KSB7CiAgICAgICAgdmFyIGFyZ3MgPSByb3V0ZXIuX2V4dHJhY3RQYXJhbWV0ZXJzKHJvdXRlLCBmcmFnbWVudCk7CiAgICAgICAgcm91dGVyLmV4ZWN1dGUoY2FsbGJhY2ssIGFyZ3MpOwogICAgICAgIHJvdXRlci50cmlnZ2VyLmFwcGx5KHJvdXRlciwgWydyb3V0ZTonICsgbmFtZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgICByb3V0ZXIudHJpZ2dlcigncm91dGUnLCBuYW1lLCBhcmdzKTsKICAgICAgICBCYWNrYm9uZS5oaXN0b3J5LnRyaWdnZXIoJ3JvdXRlJywgcm91dGVyLCBuYW1lLCBhcmdzKTsKICAgICAgfSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBFeGVjdXRlIGEgcm91dGUgaGFuZGxlciB3aXRoIHRoZSBwcm92aWRlZCBwYXJhbWV0ZXJzLiAgVGhpcyBpcyBhbgogICAgLy8gZXhjZWxsZW50IHBsYWNlIHRvIGRvIHByZS1yb3V0ZSBzZXR1cCBvciBwb3N0LXJvdXRlIGNsZWFudXAuCiAgICBleGVjdXRlOiBmdW5jdGlvbihjYWxsYmFjaywgYXJncykgewogICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfSwKCiAgICAvLyBTaW1wbGUgcHJveHkgdG8gYEJhY2tib25lLmhpc3RvcnlgIHRvIHNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoaXN0b3J5LgogICAgbmF2aWdhdGU6IGZ1bmN0aW9uKGZyYWdtZW50LCBvcHRpb25zKSB7CiAgICAgIEJhY2tib25lLmhpc3RvcnkubmF2aWdhdGUoZnJhZ21lbnQsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gQmluZCBhbGwgZGVmaW5lZCByb3V0ZXMgdG8gYEJhY2tib25lLmhpc3RvcnlgLiBXZSBoYXZlIHRvIHJldmVyc2UgdGhlCiAgICAvLyBvcmRlciBvZiB0aGUgcm91dGVzIGhlcmUgdG8gc3VwcG9ydCBiZWhhdmlvciB3aGVyZSB0aGUgbW9zdCBnZW5lcmFsCiAgICAvLyByb3V0ZXMgY2FuIGJlIGRlZmluZWQgYXQgdGhlIGJvdHRvbSBvZiB0aGUgcm91dGUgbWFwLgogICAgX2JpbmRSb3V0ZXM6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXRoaXMucm91dGVzKSByZXR1cm47CiAgICAgIHRoaXMucm91dGVzID0gXy5yZXN1bHQodGhpcywgJ3JvdXRlcycpOwogICAgICB2YXIgcm91dGUsIHJvdXRlcyA9IF8ua2V5cyh0aGlzLnJvdXRlcyk7CiAgICAgIHdoaWxlICgocm91dGUgPSByb3V0ZXMucG9wKCkpICE9IG51bGwpIHsKICAgICAgICB0aGlzLnJvdXRlKHJvdXRlLCB0aGlzLnJvdXRlc1tyb3V0ZV0pOwogICAgICB9CiAgICB9LAoKICAgIC8vIENvbnZlcnQgYSByb3V0ZSBzdHJpbmcgaW50byBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgc3VpdGFibGUgZm9yIG1hdGNoaW5nCiAgICAvLyBhZ2FpbnN0IHRoZSBjdXJyZW50IGxvY2F0aW9uIGhhc2guCiAgICBfcm91dGVUb1JlZ0V4cDogZnVuY3Rpb24ocm91dGUpIHsKICAgICAgcm91dGUgPSByb3V0ZS5yZXBsYWNlKGVzY2FwZVJlZ0V4cCwgJ1xcJCYnKQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uob3B0aW9uYWxQYXJhbSwgJyg/OiQxKT8nKQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2UobmFtZWRQYXJhbSwgZnVuY3Rpb24obWF0Y2gsIG9wdGlvbmFsKSB7CiAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvcHRpb25hbCA/IG1hdGNoIDogJyhbXi8/XSspJzsKICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZShzcGxhdFBhcmFtLCAnKFteP10qPyknKTsKICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcm91dGUgKyAnKD86XFw/KFtcXHNcXFNdKikpPyQnKTsKICAgIH0sCgogICAgLy8gR2l2ZW4gYSByb3V0ZSwgYW5kIGEgVVJMIGZyYWdtZW50IHRoYXQgaXQgbWF0Y2hlcywgcmV0dXJuIHRoZSBhcnJheSBvZgogICAgLy8gZXh0cmFjdGVkIGRlY29kZWQgcGFyYW1ldGVycy4gRW1wdHkgb3IgdW5tYXRjaGVkIHBhcmFtZXRlcnMgd2lsbCBiZQogICAgLy8gdHJlYXRlZCBhcyBgbnVsbGAgdG8gbm9ybWFsaXplIGNyb3NzLWJyb3dzZXIgYmVoYXZpb3IuCiAgICBfZXh0cmFjdFBhcmFtZXRlcnM6IGZ1bmN0aW9uKHJvdXRlLCBmcmFnbWVudCkgewogICAgICB2YXIgcGFyYW1zID0gcm91dGUuZXhlYyhmcmFnbWVudCkuc2xpY2UoMSk7CiAgICAgIHJldHVybiBfLm1hcChwYXJhbXMsIGZ1bmN0aW9uKHBhcmFtLCBpKSB7CiAgICAgICAgLy8gRG9uJ3QgZGVjb2RlIHRoZSBzZWFyY2ggcGFyYW1zLgogICAgICAgIGlmIChpID09PSBwYXJhbXMubGVuZ3RoIC0gMSkgcmV0dXJuIHBhcmFtIHx8IG51bGw7CiAgICAgICAgcmV0dXJuIHBhcmFtID8gZGVjb2RlVVJJQ29tcG9uZW50KHBhcmFtKSA6IG51bGw7CiAgICAgIH0pOwogICAgfQoKICB9KTsKCiAgLy8gQmFja2JvbmUuSGlzdG9yeQogIC8vIC0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gSGFuZGxlcyBjcm9zcy1icm93c2VyIGhpc3RvcnkgbWFuYWdlbWVudCwgYmFzZWQgb24gZWl0aGVyCiAgLy8gW3B1c2hTdGF0ZV0oaHR0cDovL2RpdmVpbnRvaHRtbDUuaW5mby9oaXN0b3J5Lmh0bWwpIGFuZCByZWFsIFVSTHMsIG9yCiAgLy8gW29uaGFzaGNoYW5nZV0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9ET00vd2luZG93Lm9uaGFzaGNoYW5nZSkKICAvLyBhbmQgVVJMIGZyYWdtZW50cy4gSWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgbmVpdGhlciAob2xkIElFLCBuYXRjaCksCiAgLy8gZmFsbHMgYmFjayB0byBwb2xsaW5nLgogIHZhciBIaXN0b3J5ID0gQmFja2JvbmUuSGlzdG9yeSA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5oYW5kbGVycyA9IFtdOwogICAgXy5iaW5kQWxsKHRoaXMsICdjaGVja1VybCcpOwoKICAgIC8vIEVuc3VyZSB0aGF0IGBIaXN0b3J5YCBjYW4gYmUgdXNlZCBvdXRzaWRlIG9mIHRoZSBicm93c2VyLgogICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHRoaXMubG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CiAgICAgIHRoaXMuaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwogICAgfQogIH07CgogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KICB2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaGVzLgogIHZhciByb290U3RyaXBwZXIgPSAvXlwvK3xcLyskL2c7CgogIC8vIENhY2hlZCByZWdleCBmb3IgZGV0ZWN0aW5nIE1TSUUuCiAgdmFyIGlzRXhwbG9yZXIgPSAvbXNpZSBbXHcuXSsvOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guCiAgdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgdXJscyBvZiBoYXNoLgogIHZhciBwYXRoU3RyaXBwZXIgPSAvIy4qJC87CgogIC8vIEhhcyB0aGUgaGlzdG9yeSBoYW5kbGluZyBhbHJlYWR5IGJlZW4gc3RhcnRlZD8KICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKCiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLkhpc3RvcnkqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKEhpc3RvcnkucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBUaGUgZGVmYXVsdCBpbnRlcnZhbCB0byBwb2xsIGZvciBoYXNoIGNoYW5nZXMsIGlmIG5lY2Vzc2FyeSwgaXMKICAgIC8vIHR3ZW50eSB0aW1lcyBhIHNlY29uZC4KICAgIGludGVydmFsOiA1MCwKCiAgICAvLyBBcmUgd2UgYXQgdGhlIGFwcCByb290PwogICAgYXRSb290OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMubG9jYXRpb24ucGF0aG5hbWUucmVwbGFjZSgvW15cL10kLywgJyQmLycpID09PSB0aGlzLnJvb3Q7CiAgICB9LAoKICAgIC8vIEdldHMgdGhlIHRydWUgaGFzaCB2YWx1ZS4gQ2Fubm90IHVzZSBsb2NhdGlvbi5oYXNoIGRpcmVjdGx5IGR1ZSB0byBidWcKICAgIC8vIGluIEZpcmVmb3ggd2hlcmUgbG9jYXRpb24uaGFzaCB3aWxsIGFsd2F5cyBiZSBkZWNvZGVkLgogICAgZ2V0SGFzaDogZnVuY3Rpb24od2luZG93KSB7CiAgICAgIHZhciBtYXRjaCA9ICh3aW5kb3cgfHwgdGhpcykubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CiAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogJyc7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgY3Jvc3MtYnJvd3NlciBub3JtYWxpemVkIFVSTCBmcmFnbWVudCwgZWl0aGVyIGZyb20gdGhlIFVSTCwKICAgIC8vIHRoZSBoYXNoLCBvciB0aGUgb3ZlcnJpZGUuCiAgICBnZXRGcmFnbWVudDogZnVuY3Rpb24oZnJhZ21lbnQsIGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgIGlmIChmcmFnbWVudCA9PSBudWxsKSB7CiAgICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSB8fCAhdGhpcy5fd2FudHNIYXNoQ2hhbmdlIHx8IGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgICAgICBmcmFnbWVudCA9IGRlY29kZVVSSSh0aGlzLmxvY2F0aW9uLnBhdGhuYW1lICsgdGhpcy5sb2NhdGlvbi5zZWFyY2gpOwogICAgICAgICAgdmFyIHJvb3QgPSB0aGlzLnJvb3QucmVwbGFjZSh0cmFpbGluZ1NsYXNoLCAnJyk7CiAgICAgICAgICBpZiAoIWZyYWdtZW50LmluZGV4T2Yocm9vdCkpIGZyYWdtZW50ID0gZnJhZ21lbnQuc2xpY2Uocm9vdC5sZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZnJhZ21lbnQucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICB9LAoKICAgIC8vIFN0YXJ0IHRoZSBoYXNoIGNoYW5nZSBoYW5kbGluZywgcmV0dXJuaW5nIGB0cnVlYCBpZiB0aGUgY3VycmVudCBVUkwgbWF0Y2hlcwogICAgLy8gYW4gZXhpc3Rpbmcgcm91dGUsIGFuZCBgZmFsc2VgIG90aGVyd2lzZS4KICAgIHN0YXJ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmIChIaXN0b3J5LnN0YXJ0ZWQpIHRocm93IG5ldyBFcnJvcigiQmFja2JvbmUuaGlzdG9yeSBoYXMgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQiKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gdHJ1ZTsKCiAgICAgIC8vIEZpZ3VyZSBvdXQgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbi4gRG8gd2UgbmVlZCBhbiBpZnJhbWU/CiAgICAgIC8vIElzIHB1c2hTdGF0ZSBkZXNpcmVkIC4uLiBpcyBpdCBhdmFpbGFibGU/CiAgICAgIHRoaXMub3B0aW9ucyAgICAgICAgICA9IF8uZXh0ZW5kKHtyb290OiAnLyd9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMpOwogICAgICB0aGlzLnJvb3QgICAgICAgICAgICAgPSB0aGlzLm9wdGlvbnMucm9vdDsKICAgICAgdGhpcy5fd2FudHNIYXNoQ2hhbmdlID0gdGhpcy5vcHRpb25zLmhhc2hDaGFuZ2UgIT09IGZhbHNlOwogICAgICB0aGlzLl93YW50c1B1c2hTdGF0ZSAgPSAhIXRoaXMub3B0aW9ucy5wdXNoU3RhdGU7CiAgICAgIHRoaXMuX2hhc1B1c2hTdGF0ZSAgICA9ICEhKHRoaXMub3B0aW9ucy5wdXNoU3RhdGUgJiYgdGhpcy5oaXN0b3J5ICYmIHRoaXMuaGlzdG9yeS5wdXNoU3RhdGUpOwogICAgICB2YXIgZnJhZ21lbnQgICAgICAgICAgPSB0aGlzLmdldEZyYWdtZW50KCk7CiAgICAgIHZhciBkb2NNb2RlICAgICAgICAgICA9IGRvY3VtZW50LmRvY3VtZW50TW9kZTsKICAgICAgdmFyIG9sZElFICAgICAgICAgICAgID0gKGlzRXhwbG9yZXIuZXhlYyhuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkpICYmICghZG9jTW9kZSB8fCBkb2NNb2RlIDw9IDcpKTsKCiAgICAgIC8vIE5vcm1hbGl6ZSByb290IHRvIGFsd2F5cyBpbmNsdWRlIGEgbGVhZGluZyBhbmQgdHJhaWxpbmcgc2xhc2guCiAgICAgIHRoaXMucm9vdCA9ICgnLycgKyB0aGlzLnJvb3QgKyAnLycpLnJlcGxhY2Uocm9vdFN0cmlwcGVyLCAnLycpOwoKICAgICAgaWYgKG9sZElFICYmIHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHZhciBmcmFtZSA9IEJhY2tib25lLiQoJzxpZnJhbWUgc3JjPSJqYXZhc2NyaXB0OjAiIHRhYmluZGV4PSItMSI+Jyk7CiAgICAgICAgdGhpcy5pZnJhbWUgPSBmcmFtZS5oaWRlKCkuYXBwZW5kVG8oJ2JvZHknKVswXS5jb250ZW50V2luZG93OwogICAgICAgIHRoaXMubmF2aWdhdGUoZnJhZ21lbnQpOwogICAgICB9CgogICAgICAvLyBEZXBlbmRpbmcgb24gd2hldGhlciB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgb3IgaGFzaGVzLCBhbmQgd2hldGhlcgogICAgICAvLyAnb25oYXNoY2hhbmdlJyBpcyBzdXBwb3J0ZWQsIGRldGVybWluZSBob3cgd2UgY2hlY2sgdGhlIFVSTCBzdGF0ZS4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIEJhY2tib25lLiQod2luZG93KS5vbigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgKCdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdykgJiYgIW9sZElFKSB7CiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fY2hlY2tVcmxJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuY2hlY2tVcmwsIHRoaXMuaW50ZXJ2YWwpOwogICAgICB9CgogICAgICAvLyBEZXRlcm1pbmUgaWYgd2UgbmVlZCB0byBjaGFuZ2UgdGhlIGJhc2UgdXJsLCBmb3IgYSBwdXNoU3RhdGUgbGluawogICAgICAvLyBvcGVuZWQgYnkgYSBub24tcHVzaFN0YXRlIGJyb3dzZXIuCiAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKICAgICAgdmFyIGxvYyA9IHRoaXMubG9jYXRpb247CgogICAgICAvLyBUcmFuc2l0aW9uIGZyb20gaGFzaENoYW5nZSB0byBwdXNoU3RhdGUgb3IgdmljZSB2ZXJzYSBpZiBib3RoIGFyZQogICAgICAvLyByZXF1ZXN0ZWQuCiAgICAgIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgdGhpcy5fd2FudHNQdXNoU3RhdGUpIHsKCiAgICAgICAgLy8gSWYgd2UndmUgc3RhcnRlZCBvZmYgd2l0aCBhIHJvdXRlIGZyb20gYSBgcHVzaFN0YXRlYC1lbmFibGVkCiAgICAgICAgLy8gYnJvd3NlciwgYnV0IHdlJ3JlIGN1cnJlbnRseSBpbiBhIGJyb3dzZXIgdGhhdCBkb2Vzbid0IHN1cHBvcnQgaXQuLi4KICAgICAgICBpZiAoIXRoaXMuX2hhc1B1c2hTdGF0ZSAmJiAhdGhpcy5hdFJvb3QoKSkgewogICAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQobnVsbCwgdHJ1ZSk7CiAgICAgICAgICB0aGlzLmxvY2F0aW9uLnJlcGxhY2UodGhpcy5yb290ICsgJyMnICsgdGhpcy5mcmFnbWVudCk7CiAgICAgICAgICAvLyBSZXR1cm4gaW1tZWRpYXRlbHkgYXMgYnJvd3NlciB3aWxsIGRvIHJlZGlyZWN0IHRvIG5ldyB1cmwKICAgICAgICAgIHJldHVybiB0cnVlOwoKICAgICAgICAvLyBPciBpZiB3ZSd2ZSBzdGFydGVkIG91dCB3aXRoIGEgaGFzaC1iYXNlZCByb3V0ZSwgYnV0IHdlJ3JlIGN1cnJlbnRseQogICAgICAgIC8vIGluIGEgYnJvd3NlciB3aGVyZSBpdCBjb3VsZCBiZSBgcHVzaFN0YXRlYC1iYXNlZCBpbnN0ZWFkLi4uCiAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUgJiYgdGhpcy5hdFJvb3QoKSAmJiBsb2MuaGFzaCkgewogICAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpLnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgICAgICAgdGhpcy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsIHRoaXMucm9vdCArIHRoaXMuZnJhZ21lbnQpOwogICAgICAgIH0KCiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5vcHRpb25zLnNpbGVudCkgcmV0dXJuIHRoaXMubG9hZFVybCgpOwogICAgfSwKCiAgICAvLyBEaXNhYmxlIEJhY2tib25lLmhpc3RvcnksIHBlcmhhcHMgdGVtcG9yYXJpbHkuIE5vdCB1c2VmdWwgaW4gYSByZWFsIGFwcCwKICAgIC8vIGJ1dCBwb3NzaWJseSB1c2VmdWwgZm9yIHVuaXQgdGVzdGluZyBSb3V0ZXJzLgogICAgc3RvcDogZnVuY3Rpb24oKSB7CiAgICAgIEJhY2tib25lLiQod2luZG93KS5vZmYoJ3BvcHN0YXRlJywgdGhpcy5jaGVja1VybCkub2ZmKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIGlmICh0aGlzLl9jaGVja1VybEludGVydmFsKSBjbGVhckludGVydmFsKHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwpOwogICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKICAgIH0sCgogICAgLy8gQWRkIGEgcm91dGUgdG8gYmUgdGVzdGVkIHdoZW4gdGhlIGZyYWdtZW50IGNoYW5nZXMuIFJvdXRlcyBhZGRlZCBsYXRlcgogICAgLy8gbWF5IG92ZXJyaWRlIHByZXZpb3VzIHJvdXRlcy4KICAgIHJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgY2FsbGJhY2spIHsKICAgICAgdGhpcy5oYW5kbGVycy51bnNoaWZ0KHtyb3V0ZTogcm91dGUsIGNhbGxiYWNrOiBjYWxsYmFja30pOwogICAgfSwKCiAgICAvLyBDaGVja3MgdGhlIGN1cnJlbnQgVVJMIHRvIHNlZSBpZiBpdCBoYXMgY2hhbmdlZCwgYW5kIGlmIGl0IGhhcywKICAgIC8vIGNhbGxzIGBsb2FkVXJsYCwgbm9ybWFsaXppbmcgYWNyb3NzIHRoZSBoaWRkZW4gaWZyYW1lLgogICAgY2hlY2tVcmw6IGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KCk7CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50ICYmIHRoaXMuaWZyYW1lKSB7CiAgICAgICAgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSk7CiAgICAgIH0KICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQpIHJldHVybiBmYWxzZTsKICAgICAgaWYgKHRoaXMuaWZyYW1lKSB0aGlzLm5hdmlnYXRlKGN1cnJlbnQpOwogICAgICB0aGlzLmxvYWRVcmwoKTsKICAgIH0sCgogICAgLy8gQXR0ZW1wdCB0byBsb2FkIHRoZSBjdXJyZW50IFVSTCBmcmFnbWVudC4gSWYgYSByb3V0ZSBzdWNjZWVkcyB3aXRoIGEKICAgIC8vIG1hdGNoLCByZXR1cm5zIGB0cnVlYC4gSWYgbm8gZGVmaW5lZCByb3V0ZXMgbWF0Y2hlcyB0aGUgZnJhZ21lbnQsCiAgICAvLyByZXR1cm5zIGBmYWxzZWAuCiAgICBsb2FkVXJsOiBmdW5jdGlvbihmcmFnbWVudCkgewogICAgICBmcmFnbWVudCA9IHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50KTsKICAgICAgcmV0dXJuIF8uYW55KHRoaXMuaGFuZGxlcnMsIGZ1bmN0aW9uKGhhbmRsZXIpIHsKICAgICAgICBpZiAoaGFuZGxlci5yb3V0ZS50ZXN0KGZyYWdtZW50KSkgewogICAgICAgICAgaGFuZGxlci5jYWxsYmFjayhmcmFnbWVudCk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBTYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGFzaCBoaXN0b3J5LCBvciByZXBsYWNlIHRoZSBVUkwgc3RhdGUgaWYgdGhlCiAgICAvLyAncmVwbGFjZScgb3B0aW9uIGlzIHBhc3NlZC4gWW91IGFyZSByZXNwb25zaWJsZSBmb3IgcHJvcGVybHkgVVJMLWVuY29kaW5nCiAgICAvLyB0aGUgZnJhZ21lbnQgaW4gYWR2YW5jZS4KICAgIC8vCiAgICAvLyBUaGUgb3B0aW9ucyBvYmplY3QgY2FuIGNvbnRhaW4gYHRyaWdnZXI6IHRydWVgIGlmIHlvdSB3aXNoIHRvIGhhdmUgdGhlCiAgICAvLyByb3V0ZSBjYWxsYmFjayBiZSBmaXJlZCAobm90IHVzdWFsbHkgZGVzaXJhYmxlKSwgb3IgYHJlcGxhY2U6IHRydWVgLCBpZgogICAgLy8geW91IHdpc2ggdG8gbW9kaWZ5IHRoZSBjdXJyZW50IFVSTCB3aXRob3V0IGFkZGluZyBhbiBlbnRyeSB0byB0aGUgaGlzdG9yeS4KICAgIG5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBpZiAoIUhpc3Rvcnkuc3RhcnRlZCkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMgfHwgb3B0aW9ucyA9PT0gdHJ1ZSkgb3B0aW9ucyA9IHt0cmlnZ2VyOiAhIW9wdGlvbnN9OwoKICAgICAgdmFyIHVybCA9IHRoaXMucm9vdCArIChmcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnQgfHwgJycpKTsKCiAgICAgIC8vIFN0cmlwIHRoZSBoYXNoIGZvciBtYXRjaGluZy4KICAgICAgZnJhZ21lbnQgPSBmcmFnbWVudC5yZXBsYWNlKHBhdGhTdHJpcHBlciwgJycpOwoKICAgICAgaWYgKHRoaXMuZnJhZ21lbnQgPT09IGZyYWdtZW50KSByZXR1cm47CiAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKCiAgICAgIC8vIERvbid0IGluY2x1ZGUgYSB0cmFpbGluZyBzbGFzaCBvbiB0aGUgcm9vdC4KICAgICAgaWYgKGZyYWdtZW50ID09PSAnJyAmJiB1cmwgIT09ICcvJykgdXJsID0gdXJsLnNsaWNlKDAsIC0xKTsKCiAgICAgIC8vIElmIHB1c2hTdGF0ZSBpcyBhdmFpbGFibGUsIHdlIHVzZSBpdCB0byBzZXQgdGhlIGZyYWdtZW50IGFzIGEgcmVhbCBVUkwuCiAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKICAgICAgICB0aGlzLmhpc3Rvcnlbb3B0aW9ucy5yZXBsYWNlID8gJ3JlcGxhY2VTdGF0ZScgOiAncHVzaFN0YXRlJ10oe30sIGRvY3VtZW50LnRpdGxlLCB1cmwpOwoKICAgICAgLy8gSWYgaGFzaCBjaGFuZ2VzIGhhdmVuJ3QgYmVlbiBleHBsaWNpdGx5IGRpc2FibGVkLCB1cGRhdGUgdGhlIGhhc2gKICAgICAgLy8gZnJhZ21lbnQgdG8gc3RvcmUgaGlzdG9yeS4KICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwogICAgICAgIGlmICh0aGlzLmlmcmFtZSAmJiAoZnJhZ21lbnQgIT09IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSkpKSB7CiAgICAgICAgICAvLyBPcGVuaW5nIGFuZCBjbG9zaW5nIHRoZSBpZnJhbWUgdHJpY2tzIElFNyBhbmQgZWFybGllciB0byBwdXNoIGEKICAgICAgICAgIC8vIGhpc3RvcnkgZW50cnkgb24gaGFzaC10YWcgY2hhbmdlLiAgV2hlbiByZXBsYWNlIGlzIHRydWUsIHdlIGRvbid0CiAgICAgICAgICAvLyB3YW50IHRoaXMuCiAgICAgICAgICBpZighb3B0aW9ucy5yZXBsYWNlKSB0aGlzLmlmcmFtZS5kb2N1bWVudC5vcGVuKCkuY2xvc2UoKTsKICAgICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5pZnJhbWUubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwogICAgICAgIH0KCiAgICAgIC8vIElmIHlvdSd2ZSB0b2xkIHVzIHRoYXQgeW91IGV4cGxpY2l0bHkgZG9uJ3Qgd2FudCBmYWxsYmFjayBoYXNoY2hhbmdlLQogICAgICAvLyBiYXNlZCBoaXN0b3J5LCB0aGVuIGBuYXZpZ2F0ZWAgYmVjb21lcyBhIHBhZ2UgcmVmcmVzaC4KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5sb2NhdGlvbi5hc3NpZ24odXJsKTsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy50cmlnZ2VyKSByZXR1cm4gdGhpcy5sb2FkVXJsKGZyYWdtZW50KTsKICAgIH0sCgogICAgLy8gVXBkYXRlIHRoZSBoYXNoIGxvY2F0aW9uLCBlaXRoZXIgcmVwbGFjaW5nIHRoZSBjdXJyZW50IGVudHJ5LCBvciBhZGRpbmcKICAgIC8vIGEgbmV3IG9uZSB0byB0aGUgYnJvd3NlciBoaXN0b3J5LgogICAgX3VwZGF0ZUhhc2g6IGZ1bmN0aW9uKGxvY2F0aW9uLCBmcmFnbWVudCwgcmVwbGFjZSkgewogICAgICBpZiAocmVwbGFjZSkgewogICAgICAgIHZhciBocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKC8oamF2YXNjcmlwdDp8IykuKiQvLCAnJyk7CiAgICAgICAgbG9jYXRpb24ucmVwbGFjZShocmVmICsgJyMnICsgZnJhZ21lbnQpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFNvbWUgYnJvd3NlcnMgcmVxdWlyZSB0aGF0IGBoYXNoYCBjb250YWlucyBhIGxlYWRpbmcgIy4KICAgICAgICBsb2NhdGlvbi5oYXNoID0gJyMnICsgZnJhZ21lbnQ7CiAgICAgIH0KICAgIH0KCiAgfSk7CgogIC8vIENyZWF0ZSB0aGUgZGVmYXVsdCBCYWNrYm9uZS5oaXN0b3J5LgogIEJhY2tib25lLmhpc3RvcnkgPSBuZXcgSGlzdG9yeTsKCiAgLy8gSGVscGVycwogIC8vIC0tLS0tLS0KCiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvcnJlY3RseSBzZXQgdXAgdGhlIHByb3RvdHlwZSBjaGFpbiwgZm9yIHN1YmNsYXNzZXMuCiAgLy8gU2ltaWxhciB0byBgZ29vZy5pbmhlcml0c2AsIGJ1dCB1c2VzIGEgaGFzaCBvZiBwcm90b3R5cGUgcHJvcGVydGllcyBhbmQKICAvLyBjbGFzcyBwcm9wZXJ0aWVzIHRvIGJlIGV4dGVuZGVkLgogIHZhciBleHRlbmQgPSBmdW5jdGlvbihwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgewogICAgdmFyIHBhcmVudCA9IHRoaXM7CiAgICB2YXIgY2hpbGQ7CgogICAgLy8gVGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciB0aGUgbmV3IHN1YmNsYXNzIGlzIGVpdGhlciBkZWZpbmVkIGJ5IHlvdQogICAgLy8gKHRoZSAiY29uc3RydWN0b3IiIHByb3BlcnR5IGluIHlvdXIgYGV4dGVuZGAgZGVmaW5pdGlvbiksIG9yIGRlZmF1bHRlZAogICAgLy8gYnkgdXMgdG8gc2ltcGx5IGNhbGwgdGhlIHBhcmVudCdzIGNvbnN0cnVjdG9yLgogICAgaWYgKHByb3RvUHJvcHMgJiYgXy5oYXMocHJvdG9Qcm9wcywgJ2NvbnN0cnVjdG9yJykpIHsKICAgICAgY2hpbGQgPSBwcm90b1Byb3BzLmNvbnN0cnVjdG9yOwogICAgfSBlbHNlIHsKICAgICAgY2hpbGQgPSBmdW5jdGlvbigpeyByZXR1cm4gcGFyZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH07CiAgICB9CgogICAgLy8gQWRkIHN0YXRpYyBwcm9wZXJ0aWVzIHRvIHRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiwgaWYgc3VwcGxpZWQuCiAgICBfLmV4dGVuZChjaGlsZCwgcGFyZW50LCBzdGF0aWNQcm9wcyk7CgogICAgLy8gU2V0IHRoZSBwcm90b3R5cGUgY2hhaW4gdG8gaW5oZXJpdCBmcm9tIGBwYXJlbnRgLCB3aXRob3V0IGNhbGxpbmcKICAgIC8vIGBwYXJlbnRgJ3MgY29uc3RydWN0b3IgZnVuY3Rpb24uCiAgICB2YXIgU3Vycm9nYXRlID0gZnVuY3Rpb24oKXsgdGhpcy5jb25zdHJ1Y3RvciA9IGNoaWxkOyB9OwogICAgU3Vycm9nYXRlLnByb3RvdHlwZSA9IHBhcmVudC5wcm90b3R5cGU7CiAgICBjaGlsZC5wcm90b3R5cGUgPSBuZXcgU3Vycm9nYXRlOwoKICAgIC8vIEFkZCBwcm90b3R5cGUgcHJvcGVydGllcyAoaW5zdGFuY2UgcHJvcGVydGllcykgdG8gdGhlIHN1YmNsYXNzLAogICAgLy8gaWYgc3VwcGxpZWQuCiAgICBpZiAocHJvdG9Qcm9wcykgXy5leHRlbmQoY2hpbGQucHJvdG90eXBlLCBwcm90b1Byb3BzKTsKCiAgICAvLyBTZXQgYSBjb252ZW5pZW5jZSBwcm9wZXJ0eSBpbiBjYXNlIHRoZSBwYXJlbnQncyBwcm90b3R5cGUgaXMgbmVlZGVkCiAgICAvLyBsYXRlci4KICAgIGNoaWxkLl9fc3VwZXJfXyA9IHBhcmVudC5wcm90b3R5cGU7CgogICAgcmV0dXJuIGNoaWxkOwogIH07CgogIC8vIFNldCB1cCBpbmhlcml0YW5jZSBmb3IgdGhlIG1vZGVsLCBjb2xsZWN0aW9uLCByb3V0ZXIsIHZpZXcgYW5kIGhpc3RvcnkuCiAgTW9kZWwuZXh0ZW5kID0gQ29sbGVjdGlvbi5leHRlbmQgPSBSb3V0ZXIuZXh0ZW5kID0gVmlldy5leHRlbmQgPSBIaXN0b3J5LmV4dGVuZCA9IGV4dGVuZDsKCiAgLy8gVGhyb3cgYW4gZXJyb3Igd2hlbiBhIFVSTCBpcyBuZWVkZWQsIGFuZCBub25lIGlzIHN1cHBsaWVkLgogIHZhciB1cmxFcnJvciA9IGZ1bmN0aW9uKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdBICJ1cmwiIHByb3BlcnR5IG9yIGZ1bmN0aW9uIG11c3QgYmUgc3BlY2lmaWVkJyk7CiAgfTsKCiAgLy8gV3JhcCBhbiBvcHRpb25hbCBlcnJvciBjYWxsYmFjayB3aXRoIGEgZmFsbGJhY2sgZXJyb3IgZXZlbnQuCiAgdmFyIHdyYXBFcnJvciA9IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICB2YXIgZXJyb3IgPSBvcHRpb25zLmVycm9yOwogICAgb3B0aW9ucy5lcnJvciA9IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgaWYgKGVycm9yKSBlcnJvcihtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIG1vZGVsLnRyaWdnZXIoJ2Vycm9yJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgfTsKICB9OwoKICByZXR1cm4gQmFja2JvbmU7Cgp9KSk7CgovKioKICogQmFja2JvbmUgbG9jYWxTdG9yYWdlIGFuZCBzZXNzaW9uU3RvcmFnZSBBZGFwdGVyCiAqIFZlcnNpb24gMC4wLjEKICoKICogaHR0cHM6Ly9naXRodWIuY29tL2pjYnJhbmQvQmFja2JvbmUuYnJvd3NlclN0b3JhZ2UKICovCihmdW5jdGlvbiAocm9vdCwgZmFjdG9yeSkgewogIGlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIHJlcXVpcmUgPT09ICdmdW5jdGlvbicpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyZXF1aXJlKCJiYWNrYm9uZSIpLCByZXF1aXJlKCd1bmRlcnNjb3JlJykpOwogIH0gZWxzZSBpZiAodHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kKSB7CiAgICAvLyBBTUQuIFJlZ2lzdGVyIGFzIGFuIGFub255bW91cyBtb2R1bGUuCiAgICBkZWZpbmUoJ2JhY2tib25lLmJyb3dzZXJTdG9yYWdlJyxbImJhY2tib25lIiwgInVuZGVyc2NvcmUiXSwgZnVuY3Rpb24oQmFja2JvbmUsIF8pIHsKICAgICAgLy8gVXNlIGdsb2JhbCB2YXJpYWJsZXMgaWYgdGhlIGxvY2FscyBhcmUgdW5kZWZpbmVkLgogICAgICByZXR1cm4gZmFjdG9yeShCYWNrYm9uZSB8fCByb290LkJhY2tib25lLCBfIHx8IHJvb3QuXyk7CiAgICB9KTsKICB9IGVsc2UgewogICAgZmFjdG9yeShCYWNrYm9uZSwgXyk7CiAgfQp9KHRoaXMsIGZ1bmN0aW9uKEJhY2tib25lLCBfKSB7Ci8vIEEgc2ltcGxlIG1vZHVsZSB0byByZXBsYWNlIGBCYWNrYm9uZS5zeW5jYCB3aXRoICpicm93c2VyIHN0b3JhZ2UqLWJhc2VkCi8vIHBlcnNpc3RlbmNlLiBNb2RlbHMgYXJlIGdpdmVuIEdVSURTLCBhbmQgc2F2ZWQgaW50byBhIEpTT04gb2JqZWN0LiBTaW1wbGUKLy8gYXMgdGhhdC4KCi8vIEhvbGQgcmVmZXJlbmNlIHRvIFVuZGVyc2NvcmUuanMgYW5kIEJhY2tib25lLmpzIGluIHRoZSBjbG9zdXJlIGluIG9yZGVyCi8vIHRvIG1ha2UgdGhpbmdzIHdvcmsgZXZlbiBpZiB0aGV5IGFyZSByZW1vdmVkIGZyb20gdGhlIGdsb2JhbCBuYW1lc3BhY2UKCi8vIEdlbmVyYXRlIGZvdXIgcmFuZG9tIGhleCBkaWdpdHMuCmZ1bmN0aW9uIFM0KCkgewogICByZXR1cm4gKCgoMStNYXRoLnJhbmRvbSgpKSoweDEwMDAwKXwwKS50b1N0cmluZygxNikuc3Vic3RyaW5nKDEpOwp9CgovLyBHZW5lcmF0ZSBhIHBzZXVkby1HVUlEIGJ5IGNvbmNhdGVuYXRpbmcgcmFuZG9tIGhleGFkZWNpbWFsLgpmdW5jdGlvbiBndWlkKCkgewogICByZXR1cm4gKFM0KCkrUzQoKSsiLSIrUzQoKSsiLSIrUzQoKSsiLSIrUzQoKSsiLSIrUzQoKStTNCgpK1M0KCkpOwp9CgpmdW5jdGlvbiBjb250YWlucyhhcnJheSwgaXRlbSkgewogIHZhciBpID0gYXJyYXkubGVuZ3RoOwogIHdoaWxlIChpLS0pIGlmIChhcnJheVtpXSA9PT0gaXRlbSkgcmV0dXJuIHRydWU7CiAgcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBleHRlbmQob2JqLCBwcm9wcykgewogIGZvciAodmFyIGtleSBpbiBwcm9wcykgeyBvYmpba2V5XSA9IHByb3BzW2tleV07IH0KICByZXR1cm4gb2JqOwp9CgpmdW5jdGlvbiBfYnJvd3NlclN0b3JhZ2UgKG5hbWUsIHNlcmlhbGl6ZXIsIHR5cGUpIHsKICAgIHZhciBfc3RvcmU7CiAgICBpZiAodHlwZSA9PT0gJ2xvY2FsJyAmJiAhd2luZG93LmxvY2FsU3RvcmFnZSApIHsKICAgICAgICB0aHJvdyAiQmFja2JvbmUuYnJvd3NlclN0b3JhZ2U6IEVudmlyb25tZW50IGRvZXMgbm90IHN1cHBvcnQgbG9jYWxTdG9yYWdlLiI7CiAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdzZXNzaW9uJyAmJiAhd2luZG93LnNlc3Npb25TdG9yYWdlICkgewogICAgICAgIHRocm93ICJCYWNrYm9uZS5icm93c2VyU3RvcmFnZTogRW52aXJvbm1lbnQgZG9lcyBub3Qgc3VwcG9ydCBzZXNzaW9uU3RvcmFnZS4iOwogICAgfQogICAgdGhpcy5uYW1lID0gbmFtZTsKICAgIHRoaXMuc2VyaWFsaXplciA9IHNlcmlhbGl6ZXIgfHwgewogICAgICAgIHNlcmlhbGl6ZTogZnVuY3Rpb24oaXRlbSkgewogICAgICAgIHJldHVybiBfLmlzT2JqZWN0KGl0ZW0pID8gSlNPTi5zdHJpbmdpZnkoaXRlbSkgOiBpdGVtOwogICAgICAgIH0sCiAgICAgICAgLy8gZml4IGZvciAiaWxsZWdhbCBhY2Nlc3MiIGVycm9yIG9uIEFuZHJvaWQgd2hlbiBKU09OLnBhcnNlIGlzIHBhc3NlZCBudWxsCiAgICAgICAgZGVzZXJpYWxpemU6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgcmV0dXJuIGRhdGEgJiYgSlNPTi5wYXJzZShkYXRhKTsKICAgICAgICB9CiAgICB9OwoKICAgIGlmICh0eXBlID09PSAnc2Vzc2lvbicpIHsKICAgICAgICB0aGlzLnN0b3JlID0gd2luZG93LnNlc3Npb25TdG9yYWdlOwogICAgfSBlbHNlIGlmICh0eXBlID09PSAnbG9jYWwnKSB7CiAgICAgICAgdGhpcy5zdG9yZSA9IHdpbmRvdy5sb2NhbFN0b3JhZ2U7CiAgICB9IGVsc2UgewogICAgICAgIHRocm93ICJCYWNrYm9uZS5icm93c2VyU3RvcmFnZTogTm8gc3RvcmFnZSB0eXBlIHdhcyBzcGVjaWZpZWQiOwogICAgfQogICAgX3N0b3JlID0gdGhpcy5zdG9yZS5nZXRJdGVtKHRoaXMubmFtZSk7CiAgICB0aGlzLnJlY29yZHMgPSAoX3N0b3JlICYmIF9zdG9yZS5zcGxpdCgiLCIpKSB8fCBbXTsKfQoKLy8gT3VyIFN0b3JlIGlzIHJlcHJlc2VudGVkIGJ5IGEgc2luZ2xlIEpTIG9iamVjdCBpbiAqbG9jYWxTdG9yYWdlKiBvciAqc2Vzc2lvblN0b3JhZ2UqLgovLyBDcmVhdGUgaXQgd2l0aCBhIG1lYW5pbmdmdWwgbmFtZSwgbGlrZSB0aGUgbmFtZSB5b3UnZCBnaXZlIGEgdGFibGUuCkJhY2tib25lLkJyb3dzZXJTdG9yYWdlID0gewogICAgbG9jYWw6IGZ1bmN0aW9uIChuYW1lLCBzZXJpYWxpemVyKSB7CiAgICAgICAgcmV0dXJuIF9icm93c2VyU3RvcmFnZS5iaW5kKHRoaXMsIG5hbWUsIHNlcmlhbGl6ZXIsICdsb2NhbCcpKCk7CiAgICB9LAogICAgc2Vzc2lvbjogZnVuY3Rpb24gKG5hbWUsIHNlcmlhbGl6ZXIpIHsKICAgICAgICByZXR1cm4gX2Jyb3dzZXJTdG9yYWdlLmJpbmQodGhpcywgbmFtZSwgc2VyaWFsaXplciwgJ3Nlc3Npb24nKSgpOwogICAgfQp9OwoKLy8gVGhlIGJyb3dzZXIncyBsb2NhbCBhbmQgc2Vzc2lvbiBzdG9yZXMgd2lsbCBiZSBleHRlbmRlZCB3aXRoIHRoaXMgb2JqLgp2YXIgX2V4dGVuc2lvbiA9IHsKCiAgLy8gU2F2ZSB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgKipTdG9yZSoqCiAgc2F2ZTogZnVuY3Rpb24oKSB7CiAgICB0aGlzLnN0b3JlLnNldEl0ZW0odGhpcy5uYW1lLCB0aGlzLnJlY29yZHMuam9pbigiLCIpKTsKICB9LAoKICAvLyBBZGQgYSBtb2RlbCwgZ2l2aW5nIGl0IGEgKGhvcGVmdWxseSktdW5pcXVlIEdVSUQsIGlmIGl0IGRvZXNuJ3QgYWxyZWFkeQogIC8vIGhhdmUgYW4gaWQgb2YgaXQncyBvd24uCiAgY3JlYXRlOiBmdW5jdGlvbihtb2RlbCkgewogICAgaWYgKCFtb2RlbC5pZCkgewogICAgICBtb2RlbC5pZCA9IGd1aWQoKTsKICAgICAgbW9kZWwuc2V0KG1vZGVsLmlkQXR0cmlidXRlLCBtb2RlbC5pZCk7CiAgICB9CiAgICB0aGlzLnN0b3JlLnNldEl0ZW0odGhpcy5faXRlbU5hbWUobW9kZWwuaWQpLCB0aGlzLnNlcmlhbGl6ZXIuc2VyaWFsaXplKG1vZGVsKSk7CiAgICB0aGlzLnJlY29yZHMucHVzaChtb2RlbC5pZC50b1N0cmluZygpKTsKICAgIHRoaXMuc2F2ZSgpOwogICAgcmV0dXJuIHRoaXMuZmluZChtb2RlbCkgIT09IGZhbHNlOwogIH0sCgogIC8vIFVwZGF0ZSBhIG1vZGVsIGJ5IHJlcGxhY2luZyBpdHMgY29weSBpbiBgdGhpcy5kYXRhYC4KICB1cGRhdGU6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICB0aGlzLnN0b3JlLnNldEl0ZW0odGhpcy5faXRlbU5hbWUobW9kZWwuaWQpLCB0aGlzLnNlcmlhbGl6ZXIuc2VyaWFsaXplKG1vZGVsKSk7CiAgICB2YXIgbW9kZWxJZCA9IG1vZGVsLmlkLnRvU3RyaW5nKCk7CiAgICBpZiAoIWNvbnRhaW5zKHRoaXMucmVjb3JkcywgbW9kZWxJZCkpIHsKICAgICAgdGhpcy5yZWNvcmRzLnB1c2gobW9kZWxJZCk7CiAgICAgIHRoaXMuc2F2ZSgpOwogICAgfQogICAgcmV0dXJuIHRoaXMuZmluZChtb2RlbCkgIT09IGZhbHNlOwogIH0sCgogIC8vIFJldHJpZXZlIGEgbW9kZWwgZnJvbSBgdGhpcy5kYXRhYCBieSBpZC4KICBmaW5kOiBmdW5jdGlvbihtb2RlbCkgewogICAgcmV0dXJuIHRoaXMuc2VyaWFsaXplci5kZXNlcmlhbGl6ZSh0aGlzLnN0b3JlLmdldEl0ZW0odGhpcy5faXRlbU5hbWUobW9kZWwuaWQpKSk7CiAgfSwKCiAgLy8gUmV0dXJuIHRoZSBhcnJheSBvZiBhbGwgbW9kZWxzIGN1cnJlbnRseSBpbiBzdG9yYWdlLgogIGZpbmRBbGw6IGZ1bmN0aW9uKCkgewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgZm9yICh2YXIgaSA9IDAsIGlkLCBkYXRhOyBpIDwgdGhpcy5yZWNvcmRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlkID0gdGhpcy5yZWNvcmRzW2ldOwogICAgICBkYXRhID0gdGhpcy5zZXJpYWxpemVyLmRlc2VyaWFsaXplKHRoaXMuc3RvcmUuZ2V0SXRlbSh0aGlzLl9pdGVtTmFtZShpZCkpKTsKICAgICAgaWYgKGRhdGEgIT09IG51bGwpIHJlc3VsdC5wdXNoKGRhdGEpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9LAoKICAvLyBEZWxldGUgYSBtb2RlbCBmcm9tIGB0aGlzLmRhdGFgLCByZXR1cm5pbmcgaXQuCiAgZGVzdHJveTogZnVuY3Rpb24obW9kZWwpIHsKICAgIHRoaXMuc3RvcmUucmVtb3ZlSXRlbSh0aGlzLl9pdGVtTmFtZShtb2RlbC5pZCkpOwogICAgdmFyIG1vZGVsSWQgPSBtb2RlbC5pZC50b1N0cmluZygpOwogICAgZm9yICh2YXIgaSA9IDAsIGlkOyBpIDwgdGhpcy5yZWNvcmRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh0aGlzLnJlY29yZHNbaV0gPT09IG1vZGVsSWQpIHsKICAgICAgICB0aGlzLnJlY29yZHMuc3BsaWNlKGksIDEpOwogICAgICB9CiAgICB9CiAgICB0aGlzLnNhdmUoKTsKICAgIHJldHVybiBtb2RlbDsKICB9LAoKICBicm93c2VyU3RvcmFnZTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICAgIHNlc3Npb246IHNlc3Npb25TdG9yYWdlLAogICAgICAgIGxvY2FsOiBsb2NhbFN0b3JhZ2UKICAgIH07CiAgfSwKCiAgLy8gQ2xlYXIgYnJvd3NlclN0b3JhZ2UgZm9yIHNwZWNpZmljIGNvbGxlY3Rpb24uCiAgX2NsZWFyOiBmdW5jdGlvbigpIHsKICAgIHZhciBsb2NhbCA9IHRoaXMuc3RvcmUsCiAgICAgIGl0ZW1SZSA9IG5ldyBSZWdFeHAoIl4iICsgdGhpcy5uYW1lICsgIi0iKTsKCiAgICAvLyBSZW1vdmUgaWQtdHJhY2tpbmcgaXRlbSAoZS5nLiwgImZvbyIpLgogICAgbG9jYWwucmVtb3ZlSXRlbSh0aGlzLm5hbWUpOwoKICAgIC8vIE1hdGNoIGFsbCBkYXRhIGl0ZW1zIChlLmcuLCAiZm9vLUlEIikgYW5kIHJlbW92ZS4KICAgIGZvciAodmFyIGsgaW4gbG9jYWwpIHsKICAgICAgaWYgKGl0ZW1SZS50ZXN0KGspKSB7CiAgICAgICAgbG9jYWwucmVtb3ZlSXRlbShrKTsKICAgICAgfQogICAgfQoKICAgIHRoaXMucmVjb3Jkcy5sZW5ndGggPSAwOwogIH0sCgogIC8vIFNpemUgb2YgYnJvd3NlclN0b3JhZ2UuCiAgX3N0b3JhZ2VTaXplOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLnN0b3JlLmxlbmd0aDsKICB9LAoKICBfaXRlbU5hbWU6IGZ1bmN0aW9uKGlkKSB7CiAgICByZXR1cm4gdGhpcy5uYW1lKyItIitpZDsKICB9Cgp9OwoKZXh0ZW5kKEJhY2tib25lLkJyb3dzZXJTdG9yYWdlLnNlc3Npb24ucHJvdG90eXBlLCBfZXh0ZW5zaW9uKTsKZXh0ZW5kKEJhY2tib25lLkJyb3dzZXJTdG9yYWdlLmxvY2FsLnByb3RvdHlwZSwgX2V4dGVuc2lvbik7CgovLyBsb2NhbFN5bmMgZGVsZWdhdGUgdG8gdGhlIG1vZGVsIG9yIGNvbGxlY3Rpb24ncwovLyAqYnJvd3NlclN0b3JhZ2UqIHByb3BlcnR5LCB3aGljaCBzaG91bGQgYmUgYW4gaW5zdGFuY2Ugb2YgYFN0b3JlYC4KLy8gd2luZG93LlN0b3JlLnN5bmMgYW5kIEJhY2tib25lLmxvY2FsU3luYyBpcyBkZXByZWNhdGVkLCB1c2UgQmFja2JvbmUuQnJvd3NlclN0b3JhZ2Uuc3luYyBpbnN0ZWFkCkJhY2tib25lLkJyb3dzZXJTdG9yYWdlLnN5bmMgPSBCYWNrYm9uZS5sb2NhbFN5bmMgPSBmdW5jdGlvbihtZXRob2QsIG1vZGVsLCBvcHRpb25zKSB7CiAgdmFyIHN0b3JlID0gbW9kZWwuYnJvd3NlclN0b3JhZ2UgfHwgbW9kZWwuY29sbGVjdGlvbi5icm93c2VyU3RvcmFnZTsKCiAgdmFyIHJlc3AsIGVycm9yTWVzc2FnZTsKICAvL0lmICQgaXMgaGF2aW5nIERlZmVycmVkIC0gdXNlIGl0LgogIHZhciBzeW5jRGZkID0gQmFja2JvbmUuJCA/CiAgICAoQmFja2JvbmUuJC5EZWZlcnJlZCAmJiBCYWNrYm9uZS4kLkRlZmVycmVkKCkpIDoKICAgIChCYWNrYm9uZS5EZWZlcnJlZCAmJiBCYWNrYm9uZS5EZWZlcnJlZCgpKTsKCiAgdHJ5IHsKCiAgICBzd2l0Y2ggKG1ldGhvZCkgewogICAgICBjYXNlICJyZWFkIjoKICAgICAgICByZXNwID0gbW9kZWwuaWQgIT09IHVuZGVmaW5lZCA/IHN0b3JlLmZpbmQobW9kZWwpIDogc3RvcmUuZmluZEFsbCgpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJjcmVhdGUiOgogICAgICAgIHJlc3AgPSBzdG9yZS5jcmVhdGUobW9kZWwpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJ1cGRhdGUiOgogICAgICAgIHJlc3AgPSBzdG9yZS51cGRhdGUobW9kZWwpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJkZWxldGUiOgogICAgICAgIHJlc3AgPSBzdG9yZS5kZXN0cm95KG1vZGVsKTsKICAgICAgICBicmVhazsKICAgIH0KCiAgfSBjYXRjaChlcnJvcikgewogICAgaWYgKGVycm9yLmNvZGUgPT09IDIyICYmIHN0b3JlLl9zdG9yYWdlU2l6ZSgpID09PSAwKQogICAgICBlcnJvck1lc3NhZ2UgPSAiUHJpdmF0ZSBicm93c2luZyBpcyB1bnN1cHBvcnRlZCI7CiAgICBlbHNlCiAgICAgIGVycm9yTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7CiAgfQoKICBpZiAocmVzcCkgewogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5zdWNjZXNzKSB7CiAgICAgIGlmIChCYWNrYm9uZS5WRVJTSU9OID09PSAiMC45LjEwIikgewogICAgICAgIG9wdGlvbnMuc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3B0aW9ucy5zdWNjZXNzKHJlc3ApOwogICAgICB9CiAgICB9CiAgICBpZiAoc3luY0RmZCkgewogICAgICBzeW5jRGZkLnJlc29sdmUocmVzcCk7CiAgICB9CgogIH0gZWxzZSB7CiAgICBlcnJvck1lc3NhZ2UgPSBlcnJvck1lc3NhZ2UgPyBlcnJvck1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICJSZWNvcmQgTm90IEZvdW5kIjsKCiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmVycm9yKQogICAgICBpZiAoQmFja2JvbmUuVkVSU0lPTiA9PT0gIjAuOS4xMCIpIHsKICAgICAgICBvcHRpb25zLmVycm9yKG1vZGVsLCBlcnJvck1lc3NhZ2UsIG9wdGlvbnMpOwogICAgICB9IGVsc2UgewogICAgICAgIG9wdGlvbnMuZXJyb3IoZXJyb3JNZXNzYWdlKTsKICAgICAgfQoKICAgIGlmIChzeW5jRGZkKQogICAgICBzeW5jRGZkLnJlamVjdChlcnJvck1lc3NhZ2UpOwogIH0KCiAgLy8gYWRkIGNvbXBhdGliaWxpdHkgd2l0aCAkLmFqYXgKICAvLyBhbHdheXMgZXhlY3V0ZSBjYWxsYmFjayBmb3Igc3VjY2VzcyBhbmQgZXJyb3IKICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmNvbXBsZXRlKSBvcHRpb25zLmNvbXBsZXRlKHJlc3ApOwoKICByZXR1cm4gc3luY0RmZCAmJiBzeW5jRGZkLnByb21pc2UoKTsKfTsKCkJhY2tib25lLmFqYXhTeW5jID0gQmFja2JvbmUuc3luYzsKCkJhY2tib25lLmdldFN5bmNNZXRob2QgPSBmdW5jdGlvbihtb2RlbCkgewogIGlmKG1vZGVsLmJyb3dzZXJTdG9yYWdlIHx8IChtb2RlbC5jb2xsZWN0aW9uICYmIG1vZGVsLmNvbGxlY3Rpb24uYnJvd3NlclN0b3JhZ2UpKSB7CiAgICByZXR1cm4gQmFja2JvbmUubG9jYWxTeW5jOwogIH0KICByZXR1cm4gQmFja2JvbmUuYWpheFN5bmM7Cn07CgovLyBPdmVycmlkZSAnQmFja2JvbmUuc3luYycgdG8gZGVmYXVsdCB0byBsb2NhbFN5bmMsCi8vIHRoZSBvcmlnaW5hbCAnQmFja2JvbmUuc3luYycgaXMgc3RpbGwgYXZhaWxhYmxlIGluICdCYWNrYm9uZS5hamF4U3luYycKQmFja2JvbmUuc3luYyA9IGZ1bmN0aW9uKG1ldGhvZCwgbW9kZWwsIG9wdGlvbnMpIHsKICByZXR1cm4gQmFja2JvbmUuZ2V0U3luY01ldGhvZChtb2RlbCkuYXBwbHkodGhpcywgW21ldGhvZCwgbW9kZWwsIG9wdGlvbnNdKTsKfTsKCnJldHVybiBCYWNrYm9uZS5Ccm93c2VyU3RvcmFnZTsKfSkpOwoKLyohCiAqIEJhY2tib25lLk92ZXJ2aWV3IAogKgogKiBDb3B5cmlnaHQgKGMpIDIwMTQsIEpDIEJyYW5kIDxqY0BvcGtvZGUuY29tPgogKiBMaWNlbnNlZCB1bmRlciB0aGUgTW96aWxsYSBQdWJsaWMgTGljZW5zZSAoTVBMKSAKICovCgooZnVuY3Rpb24gKHJvb3QsIGZhY3RvcnkpIHsKICAgIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKICAgICAgICBkZWZpbmUoJ2JhY2tib25lLm92ZXJ2aWV3JyxbInVuZGVyc2NvcmUiLCAiYmFja2JvbmUiXSwKICAgICAgICAgICAgZnVuY3Rpb24oXywgQmFja2JvbmUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWN0b3J5KF8gfHwgcm9vdC5fLCBCYWNrYm9uZSB8fCByb290LkJhY2tib25lKTsKICAgICAgICAgICAgfQogICAgICAgICk7CiAgIH0gZWxzZSB7CiAgICAgIC8vIFJlcXVpcmVKUyBpc24ndCBiZWluZyB1c2VkLgogICAgICAvLyBBc3N1bWUgdW5kZXJzY29yZSBhbmQgYmFja2JvbmUgYXJlIGxvYWRlZCBpbiA8c2NyaXB0PiB0YWdzCiAgICAgIGZhY3RvcnkoXywgQmFja2JvbmUpOwogICB9Cn0odGhpcywgZnVuY3Rpb24gKF8sIEJhY2tib25lKSB7CiAgICAKICAgIHZhciBPdmVydmlldyA9IEJhY2tib25lLk92ZXJ2aWV3ID0gZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICAvKiBBbiBPdmVydmlldyBpcyBhIFZpZXcgdGhhdCBjb250YWlucyBhbmQga2VlcHMgdHJhY2sgb2Ygc3ViLXZpZXdzLgogICAgICAgICAqIEtpbmQgb2YgbGlrZSB3aGF0IGEgQ29sbGVjdGlvbiBpcyB0byBhIE1vZGVsLgogICAgICAgICAqLwogICAgICAgIHZhciB2aWV3cyA9IHt9OwogICAgICAgIHRoaXMua2V5cyA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIF8ua2V5cyh2aWV3cykgfTsKICAgICAgICB0aGlzLmdldEFsbCA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHZpZXdzOyB9OwogICAgICAgIHRoaXMuZ2V0ID0gZnVuY3Rpb24gKGlkKSB7IHJldHVybiB2aWV3c1tpZF07IH07CiAgICAgICAgdGhpcy5hZGQgPSBmdW5jdGlvbiAoaWQsIHZpZXcpIHsKICAgICAgICAgICAgdmlld3NbaWRdID0gdmlldzsKICAgICAgICAgICAgcmV0dXJuIHZpZXc7CiAgICAgICAgfTsKICAgICAgICB0aGlzLnJlbW92ZSA9IGZ1bmN0aW9uIChpZCkgewogICAgICAgICAgICB2YXIgdmlldyA9IHZpZXdzW2lkXTsKICAgICAgICAgICAgaWYgKHZpZXcpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSB2aWV3c1tpZF07CiAgICAgICAgICAgICAgICB2aWV3LnJlbW92ZSgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHZpZXc7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHRoaXMucmVtb3ZlQWxsID0gZnVuY3Rpb24gKGlkKSB7CiAgICAgICAgICAgIF8uZWFjaChfLmtleXModmlld3MpLCB0aGlzLnJlbW92ZSk7CiAgICAgICAgfTsKCiAgICAgICAgQmFja2JvbmUuVmlldy5hcHBseSh0aGlzLCBBcnJheS5wcm90b3R5cGUuc2xpY2UuYXBwbHkoYXJndW1lbnRzKSk7CiAgICB9OwogICAgXy5leHRlbmQoT3ZlcnZpZXcucHJvdG90eXBlLCBCYWNrYm9uZS5WaWV3LnByb3RvdHlwZSk7CiAgICBPdmVydmlldy5leHRlbmQgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZDsKICAgIHJldHVybiBCYWNrYm9uZS5PdmVydmlldzsKfSkpOwoKLyohCiAqIGpRdWVyeSBCcm93c2VyIFBsdWdpbiB2MC4wLjYKICogaHR0cHM6Ly9naXRodWIuY29tL2dhYmNlYi9qcXVlcnktYnJvd3Nlci1wbHVnaW4KICoKICogT3JpZ2luYWwganF1ZXJ5LWJyb3dzZXIgY29kZSBDb3B5cmlnaHQgMjAwNSwgMjAxMyBqUXVlcnkgRm91bmRhdGlvbiwgSW5jLiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogTW9kaWZpY2F0aW9ucyBDb3B5cmlnaHQgMjAxMyBHYWJyaWVsIENlYnJpYW4KICogaHR0cHM6Ly9naXRodWIuY29tL2dhYmNlYgogKgogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UKICoKICogRGF0ZTogMjAxMy0wNy0yOVQxNzoyMzoyNy0wNzowMAogKi8KCihmdW5jdGlvbiAocm9vdCwgZmFjdG9yeSkgewogICAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewogICAgICAgIC8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS4KICAgICAgICBkZWZpbmUoJ2pxdWVyeS5icm93c2VyJyxbJ2pxdWVyeSddLCBmdW5jdGlvbiAoJCkgewogICAgICAgICAgICBmYWN0b3J5KCQsIHJvb3QpOwogICAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBCcm93c2VyIGdsb2JhbHMKICAgICAgICBmYWN0b3J5KGpRdWVyeSwgcm9vdCk7CiAgICB9Cn0odGhpcywgZnVuY3Rpb24oalF1ZXJ5LCB3aW5kb3cpIHsKICAKCiAgdmFyIG1hdGNoZWQsIGJyb3dzZXI7CgogIGpRdWVyeS51YU1hdGNoID0gZnVuY3Rpb24oIHVhICkgewogICAgdWEgPSB1YS50b0xvd2VyQ2FzZSgpOwoKICAJdmFyIG1hdGNoID0gLyhvcHIpW1wvXShbXHcuXSspLy5leGVjKCB1YSApIHx8CiAgCQkvKGNocm9tZSlbIFwvXShbXHcuXSspLy5leGVjKCB1YSApIHx8CiAgCQkvKHZlcnNpb24pWyBcL10oW1x3Ll0rKS4qKHNhZmFyaSlbIFwvXShbXHcuXSspLy5leGVjKCB1YSApIHx8CiAgCQkvKHdlYmtpdClbIFwvXShbXHcuXSspLy5leGVjKCB1YSApIHx8CiAgCQkvKG9wZXJhKSg/Oi4qdmVyc2lvbnwpWyBcL10oW1x3Ll0rKS8uZXhlYyggdWEgKSB8fAogIAkJLyhtc2llKSAoW1x3Ll0rKS8uZXhlYyggdWEgKSB8fAogIAkJdWEuaW5kZXhPZigidHJpZGVudCIpID49IDAgJiYgLyhydikoPzo6fCApKFtcdy5dKykvLmV4ZWMoIHVhICkgfHwKICAJCXVhLmluZGV4T2YoImNvbXBhdGlibGUiKSA8IDAgJiYgLyhtb3ppbGxhKSg/Oi4qPyBydjooW1x3Ll0rKXwpLy5leGVjKCB1YSApIHx8CiAgCQlbXTsKCiAgCXZhciBwbGF0Zm9ybV9tYXRjaCA9IC8oaXBhZCkvLmV4ZWMoIHVhICkgfHwKICAJCS8oaXBob25lKS8uZXhlYyggdWEgKSB8fAogIAkJLyhhbmRyb2lkKS8uZXhlYyggdWEgKSB8fAogIAkJLyh3aW5kb3dzIHBob25lKS8uZXhlYyggdWEgKSB8fAogIAkJLyh3aW4pLy5leGVjKCB1YSApIHx8CiAgCQkvKG1hYykvLmV4ZWMoIHVhICkgfHwKICAJCS8obGludXgpLy5leGVjKCB1YSApIHx8CiAgCQkvKGNyb3MpL2kuZXhlYyggdWEgKSB8fAogIAkJW107CgogIAlyZXR1cm4gewogIAkJYnJvd3NlcjogbWF0Y2hbIDMgXSB8fCBtYXRjaFsgMSBdIHx8ICIiLAogIAkJdmVyc2lvbjogbWF0Y2hbIDIgXSB8fCAiMCIsCiAgCQlwbGF0Zm9ybTogcGxhdGZvcm1fbWF0Y2hbIDAgXSB8fCAiIgogIAl9OwogIH07CgogIG1hdGNoZWQgPSBqUXVlcnkudWFNYXRjaCggd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQgKTsKICBicm93c2VyID0ge307CgogIGlmICggbWF0Y2hlZC5icm93c2VyICkgewogIAlicm93c2VyWyBtYXRjaGVkLmJyb3dzZXIgXSA9IHRydWU7CiAgCWJyb3dzZXIudmVyc2lvbiA9IG1hdGNoZWQudmVyc2lvbjsKICAJYnJvd3Nlci52ZXJzaW9uTnVtYmVyID0gcGFyc2VJbnQobWF0Y2hlZC52ZXJzaW9uKTsKICB9CgogIGlmICggbWF0Y2hlZC5wbGF0Zm9ybSApIHsKICAJYnJvd3NlclsgbWF0Y2hlZC5wbGF0Zm9ybSBdID0gdHJ1ZTsKICB9CgogIC8vIFRoZXNlIGFyZSBhbGwgY29uc2lkZXJlZCBtb2JpbGUgcGxhdGZvcm1zLCBtZWFuaW5nIHRoZXkgcnVuIGEgbW9iaWxlIGJyb3dzZXIKICBpZiAoIGJyb3dzZXIuYW5kcm9pZCB8fCBicm93c2VyLmlwYWQgfHwgYnJvd3Nlci5pcGhvbmUgfHwgYnJvd3NlclsgIndpbmRvd3MgcGhvbmUiIF0gKSB7CiAgCWJyb3dzZXIubW9iaWxlID0gdHJ1ZTsKICB9CgogIC8vIFRoZXNlIGFyZSBhbGwgY29uc2lkZXJlZCBkZXNrdG9wIHBsYXRmb3JtcywgbWVhbmluZyB0aGV5IHJ1biBhIGRlc2t0b3AgYnJvd3NlcgogIGlmICggYnJvd3Nlci5jcm9zIHx8IGJyb3dzZXIubWFjIHx8IGJyb3dzZXIubGludXggfHwgYnJvd3Nlci53aW4gKSB7CiAgCWJyb3dzZXIuZGVza3RvcCA9IHRydWU7CiAgfQoKICAvLyBDaHJvbWUsIE9wZXJhIDE1KyBhbmQgU2FmYXJpIGFyZSB3ZWJraXQgYmFzZWQgYnJvd3NlcnMKICBpZiAoIGJyb3dzZXIuY2hyb21lIHx8IGJyb3dzZXIub3ByIHx8IGJyb3dzZXIuc2FmYXJpICkgewogIAlicm93c2VyLndlYmtpdCA9IHRydWU7CiAgfQoKICAvLyBJRTExIGhhcyBhIG5ldyB0b2tlbiBzbyB3ZSB3aWxsIGFzc2lnbiBpdCBtc2llIHRvIGF2b2lkIGJyZWFraW5nIGNoYW5nZXMKICBpZiAoIGJyb3dzZXIucnYgKQogIHsKICAJdmFyIGllID0gIm1zaWUiOwoKICAJbWF0Y2hlZC5icm93c2VyID0gaWU7CiAgCWJyb3dzZXJbaWVdID0gdHJ1ZTsKICB9CgogIC8vIE9wZXJhIDE1KyBhcmUgaWRlbnRpZmllZCBhcyBvcHIKICBpZiAoIGJyb3dzZXIub3ByICkKICB7CiAgCXZhciBvcGVyYSA9ICJvcGVyYSI7CgogIAltYXRjaGVkLmJyb3dzZXIgPSBvcGVyYTsKICAJYnJvd3NlcltvcGVyYV0gPSB0cnVlOwogIH0KCiAgLy8gU3RvY2sgQW5kcm9pZCBicm93c2VycyBhcmUgbWFya2VkIGFzIFNhZmFyaSBvbiBBbmRyb2lkLgogIGlmICggYnJvd3Nlci5zYWZhcmkgJiYgYnJvd3Nlci5hbmRyb2lkICkKICB7CiAgCXZhciBhbmRyb2lkID0gImFuZHJvaWQiOwoKICAJbWF0Y2hlZC5icm93c2VyID0gYW5kcm9pZDsKICAJYnJvd3NlclthbmRyb2lkXSA9IHRydWU7CiAgfQoKICAvLyBBc3NpZ24gdGhlIG5hbWUgYW5kIHBsYXRmb3JtIHZhcmlhYmxlCiAgYnJvd3Nlci5uYW1lID0gbWF0Y2hlZC5icm93c2VyOwogIGJyb3dzZXIucGxhdGZvcm0gPSBtYXRjaGVkLnBsYXRmb3JtOwoKICBqUXVlcnkuYnJvd3NlciA9IGJyb3dzZXI7CiAgcmV0dXJuIGJyb3dzZXI7Cn0pKTsKCi8qIQogKiB0eXBlYWhlYWQuanMgMC4xMC41CiAqIGh0dHBzOi8vZ2l0aHViLmNvbS90d2l0dGVyL3R5cGVhaGVhZC5qcwogKiBDb3B5cmlnaHQgMjAxMy0yMDE0IFR3aXR0ZXIsIEluYy4gYW5kIG90aGVyIGNvbnRyaWJ1dG9yczsgTGljZW5zZWQgTUlUCiAqLwoKKGZ1bmN0aW9uIChyb290LCBmYWN0b3J5KSB7CiAgICBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLgogICAgICAgIGRlZmluZSgndHlwZWFoZWFkJyxbJ2pxdWVyeSddLCBmdW5jdGlvbiAoJCkgewogICAgICAgICAgICBmYWN0b3J5KCQsIHJvb3QpOwogICAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBCcm93c2VyIGdsb2JhbHMKICAgICAgICBmYWN0b3J5KGpRdWVyeSwgcm9vdCk7CiAgICB9Cn0odGhpcywgZnVuY3Rpb24oJCwgd2luZG93KSB7CiAgICB2YXIgXyA9IGZ1bmN0aW9uKCkgewogICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGlzTXNpZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gLyhtc2llfHRyaWRlbnQpL2kudGVzdChuYXZpZ2F0b3IudXNlckFnZW50KSA/IG5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goLyhtc2llIHxydjopKFxkKyguXGQrKT8pL2kpWzJdIDogZmFsc2U7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlzQmxhbmtTdHJpbmc6IGZ1bmN0aW9uKHN0cikgewogICAgICAgICAgICAgICAgcmV0dXJuICFzdHIgfHwgL15ccyokLy50ZXN0KHN0cik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVzY2FwZVJlZ0V4Q2hhcnM6IGZ1bmN0aW9uKHN0cikgewogICAgICAgICAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKC9bXC1cW1xdXC9ce1x9XChcKVwqXCtcP1wuXFxcXlwkXHxdL2csICJcXCQmIik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlzU3RyaW5nOiBmdW5jdGlvbihvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAic3RyaW5nIjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNOdW1iZXI6IGZ1bmN0aW9uKG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICJudW1iZXIiOwogICAgICAgICAgICB9LAogICAgICAgICAgICBpc0FycmF5OiAkLmlzQXJyYXksCiAgICAgICAgICAgIGlzRnVuY3Rpb246ICQuaXNGdW5jdGlvbiwKICAgICAgICAgICAgaXNPYmplY3Q6ICQuaXNQbGFpbk9iamVjdCwKICAgICAgICAgICAgaXNVbmRlZmluZWQ6IGZ1bmN0aW9uKG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICJ1bmRlZmluZWQiOwogICAgICAgICAgICB9LAogICAgICAgICAgICB0b1N0cjogZnVuY3Rpb24gdG9TdHIocykgewogICAgICAgICAgICAgICAgcmV0dXJuIF8uaXNVbmRlZmluZWQocykgfHwgcyA9PT0gbnVsbCA/ICIiIDogcyArICIiOwogICAgICAgICAgICB9LAogICAgICAgICAgICBiaW5kOiAkLnByb3h5LAogICAgICAgICAgICBlYWNoOiBmdW5jdGlvbihjb2xsZWN0aW9uLCBjYikgewogICAgICAgICAgICAgICAgJC5lYWNoKGNvbGxlY3Rpb24sIHJldmVyc2VBcmdzKTsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHJldmVyc2VBcmdzKGluZGV4LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjYih2YWx1ZSwgaW5kZXgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBtYXA6ICQubWFwLAogICAgICAgICAgICBmaWx0ZXI6ICQuZ3JlcCwKICAgICAgICAgICAgZXZlcnk6IGZ1bmN0aW9uKG9iaiwgdGVzdCkgewogICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHRydWU7CiAgICAgICAgICAgICAgICBpZiAoIW9iaikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkLmVhY2gob2JqLCBmdW5jdGlvbihrZXksIHZhbCkgewogICAgICAgICAgICAgICAgICAgIGlmICghKHJlc3VsdCA9IHRlc3QuY2FsbChudWxsLCB2YWwsIGtleSwgb2JqKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuICEhcmVzdWx0OwogICAgICAgICAgICB9LAogICAgICAgICAgICBzb21lOiBmdW5jdGlvbihvYmosIHRlc3QpIHsKICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmICghb2JqKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICQuZWFjaChvYmosIGZ1bmN0aW9uKGtleSwgdmFsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdCA9IHRlc3QuY2FsbChudWxsLCB2YWwsIGtleSwgb2JqKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gISFyZXN1bHQ7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG1peGluOiAkLmV4dGVuZCwKICAgICAgICAgICAgZ2V0VW5pcXVlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGNvdW50ZXIgPSAwOwogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjb3VudGVyKys7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9KCksCiAgICAgICAgICAgIHRlbXBsYXRpZnk6IGZ1bmN0aW9uIHRlbXBsYXRpZnkob2JqKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJC5pc0Z1bmN0aW9uKG9iaikgPyBvYmogOiB0ZW1wbGF0ZTsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHRlbXBsYXRlKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBTdHJpbmcob2JqKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGVmZXI6IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZuLCAwKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGVib3VuY2U6IGZ1bmN0aW9uKGZ1bmMsIHdhaXQsIGltbWVkaWF0ZSkgewogICAgICAgICAgICAgICAgdmFyIHRpbWVvdXQsIHJlc3VsdDsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHRoaXMsIGFyZ3MgPSBhcmd1bWVudHMsIGxhdGVyLCBjYWxsTm93OwogICAgICAgICAgICAgICAgICAgIGxhdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWltbWVkaWF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgY2FsbE5vdyA9IGltbWVkaWF0ZSAmJiAhdGltZW91dDsKICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CiAgICAgICAgICAgICAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQpOwogICAgICAgICAgICAgICAgICAgIGlmIChjYWxsTm93KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9LAogICAgICAgICAgICB0aHJvdHRsZTogZnVuY3Rpb24oZnVuYywgd2FpdCkgewogICAgICAgICAgICAgICAgdmFyIGNvbnRleHQsIGFyZ3MsIHRpbWVvdXQsIHJlc3VsdCwgcHJldmlvdXMsIGxhdGVyOwogICAgICAgICAgICAgICAgcHJldmlvdXMgPSAwOwogICAgICAgICAgICAgICAgbGF0ZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBwcmV2aW91cyA9IG5ldyBEYXRlKCk7CiAgICAgICAgICAgICAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5vdyA9IG5ldyBEYXRlKCksIHJlbWFpbmluZyA9IHdhaXQgLSAobm93IC0gcHJldmlvdXMpOwogICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSB0aGlzOwogICAgICAgICAgICAgICAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlbWFpbmluZyA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZXZpb3VzID0gbm93OwogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXRpbWVvdXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHJlbWFpbmluZyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9LAogICAgICAgICAgICBub29wOiBmdW5jdGlvbigpIHt9CiAgICAgICAgfTsKICAgIH0oKTsKICAgIHZhciBodG1sID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgd3JhcHBlcjogJzxzcGFuIGNsYXNzPSJ0d2l0dGVyLXR5cGVhaGVhZCI+PC9zcGFuPicsCiAgICAgICAgICAgIGRyb3Bkb3duOiAnPHNwYW4gY2xhc3M9InR0LWRyb3Bkb3duLW1lbnUiPjwvc3Bhbj4nLAogICAgICAgICAgICBkYXRhc2V0OiAnPGRpdiBjbGFzcz0idHQtZGF0YXNldC0lQ0xBU1MlIj48L2Rpdj4nLAogICAgICAgICAgICBzdWdnZXN0aW9uczogJzxzcGFuIGNsYXNzPSJ0dC1zdWdnZXN0aW9ucyI+PC9zcGFuPicsCiAgICAgICAgICAgIHN1Z2dlc3Rpb246ICc8ZGl2IGNsYXNzPSJ0dC1zdWdnZXN0aW9uIj48L2Rpdj4nCiAgICAgICAgfTsKICAgIH0oKTsKICAgIHZhciBjc3MgPSBmdW5jdGlvbigpIHsKICAgICAgICAKICAgICAgICB2YXIgY3NzID0gewogICAgICAgICAgICB3cmFwcGVyOiB7CiAgICAgICAgICAgICAgICBwb3NpdGlvbjogInJlbGF0aXZlIiwKICAgICAgICAgICAgICAgIGRpc3BsYXk6ICJpbmxpbmUtYmxvY2siCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGhpbnQ6IHsKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICAgICAgICAgICAgdG9wOiAiMCIsCiAgICAgICAgICAgICAgICBsZWZ0OiAiMCIsCiAgICAgICAgICAgICAgICBib3JkZXJDb2xvcjogInRyYW5zcGFyZW50IiwKICAgICAgICAgICAgICAgIGJveFNoYWRvdzogIm5vbmUiLAogICAgICAgICAgICAgICAgb3BhY2l0eTogIjEiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlucHV0OiB7CiAgICAgICAgICAgICAgICBwb3NpdGlvbjogInJlbGF0aXZlIiwKICAgICAgICAgICAgICAgIHZlcnRpY2FsQWxpZ246ICJ0b3AiLAogICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAidHJhbnNwYXJlbnQiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlucHV0V2l0aE5vSGludDogewogICAgICAgICAgICAgICAgcG9zaXRpb246ICJyZWxhdGl2ZSIsCiAgICAgICAgICAgICAgICB2ZXJ0aWNhbEFsaWduOiAidG9wIgogICAgICAgICAgICB9LAogICAgICAgICAgICBkcm9wZG93bjogewogICAgICAgICAgICAgICAgcG9zaXRpb246ICJhYnNvbHV0ZSIsCiAgICAgICAgICAgICAgICB0b3A6ICIxMDAlIiwKICAgICAgICAgICAgICAgIGxlZnQ6ICIwIiwKICAgICAgICAgICAgICAgIHpJbmRleDogIjEwMCIsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAibm9uZSIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc3VnZ2VzdGlvbnM6IHsKICAgICAgICAgICAgICAgIGRpc3BsYXk6ICJibG9jayIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc3VnZ2VzdGlvbjogewogICAgICAgICAgICAgICAgd2hpdGVTcGFjZTogIm5vd3JhcCIsCiAgICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIgogICAgICAgICAgICB9LAogICAgICAgICAgICBzdWdnZXN0aW9uQ2hpbGQ6IHsKICAgICAgICAgICAgICAgIHdoaXRlU3BhY2U6ICJub3JtYWwiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGx0cjogewogICAgICAgICAgICAgICAgbGVmdDogIjAiLAogICAgICAgICAgICAgICAgcmlnaHQ6ICJhdXRvIgogICAgICAgICAgICB9LAogICAgICAgICAgICBydGw6IHsKICAgICAgICAgICAgICAgIGxlZnQ6ICJhdXRvIiwKICAgICAgICAgICAgICAgIHJpZ2h0OiAiIDAiCiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGlmIChfLmlzTXNpZSgpKSB7CiAgICAgICAgICAgIF8ubWl4aW4oY3NzLmlucHV0LCB7CiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kSW1hZ2U6ICJ1cmwoZGF0YTppbWFnZS9naWY7YmFzZTY0LFIwbEdPRGxoQVFBQkFJQUFBQUFBQVAvLy95SDVCQUVBQUFBQUxBQUFBQUFCQUFFQUFBSUJSQUE3KSIKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmIChfLmlzTXNpZSgpICYmIF8uaXNNc2llKCkgPD0gNykgewogICAgICAgICAgICBfLm1peGluKGNzcy5pbnB1dCwgewogICAgICAgICAgICAgICAgbWFyZ2luVG9wOiAiLTFweCIKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjc3M7CiAgICB9KCk7CiAgICB2YXIgRXZlbnRCdXMgPSBmdW5jdGlvbigpIHsKICAgICAgICAKICAgICAgICB2YXIgbmFtZXNwYWNlID0gInR5cGVhaGVhZDoiOwogICAgICAgIGZ1bmN0aW9uIEV2ZW50QnVzKG8pIHsKICAgICAgICAgICAgaWYgKCFvIHx8ICFvLmVsKSB7CiAgICAgICAgICAgICAgICAkLmVycm9yKCJFdmVudEJ1cyBpbml0aWFsaXplZCB3aXRob3V0IGVsIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy4kZWwgPSAkKG8uZWwpOwogICAgICAgIH0KICAgICAgICBfLm1peGluKEV2ZW50QnVzLnByb3RvdHlwZSwgewogICAgICAgICAgICB0cmlnZ2VyOiBmdW5jdGlvbih0eXBlKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLnRyaWdnZXIobmFtZXNwYWNlICsgdHlwZSwgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gRXZlbnRCdXM7CiAgICB9KCk7CiAgICB2YXIgRXZlbnRFbWl0dGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgCiAgICAgICAgdmFyIHNwbGl0dGVyID0gL1xzKy8sIG5leHRUaWNrID0gZ2V0TmV4dFRpY2soKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBvblN5bmM6IG9uU3luYywKICAgICAgICAgICAgb25Bc3luYzogb25Bc3luYywKICAgICAgICAgICAgb2ZmOiBvZmYsCiAgICAgICAgICAgIHRyaWdnZXI6IHRyaWdnZXIKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIG9uKG1ldGhvZCwgdHlwZXMsIGNiLCBjb250ZXh0KSB7CiAgICAgICAgICAgIHZhciB0eXBlOwogICAgICAgICAgICBpZiAoIWNiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgICAgICB0eXBlcyA9IHR5cGVzLnNwbGl0KHNwbGl0dGVyKTsKICAgICAgICAgICAgY2IgPSBjb250ZXh0ID8gYmluZENvbnRleHQoY2IsIGNvbnRleHQpIDogY2I7CiAgICAgICAgICAgIHRoaXMuX2NhbGxiYWNrcyA9IHRoaXMuX2NhbGxiYWNrcyB8fCB7fTsKICAgICAgICAgICAgd2hpbGUgKHR5cGUgPSB0eXBlcy5zaGlmdCgpKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jYWxsYmFja3NbdHlwZV0gPSB0aGlzLl9jYWxsYmFja3NbdHlwZV0gfHwgewogICAgICAgICAgICAgICAgICAgIHN5bmM6IFtdLAogICAgICAgICAgICAgICAgICAgIGFzeW5jOiBbXQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHRoaXMuX2NhbGxiYWNrc1t0eXBlXVttZXRob2RdLnB1c2goY2IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvbkFzeW5jKHR5cGVzLCBjYiwgY29udGV4dCkgewogICAgICAgICAgICByZXR1cm4gb24uY2FsbCh0aGlzLCAiYXN5bmMiLCB0eXBlcywgY2IsIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvblN5bmModHlwZXMsIGNiLCBjb250ZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBvbi5jYWxsKHRoaXMsICJzeW5jIiwgdHlwZXMsIGNiLCBjb250ZXh0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb2ZmKHR5cGVzKSB7CiAgICAgICAgICAgIHZhciB0eXBlOwogICAgICAgICAgICBpZiAoIXRoaXMuX2NhbGxiYWNrcykgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdHlwZXMgPSB0eXBlcy5zcGxpdChzcGxpdHRlcik7CiAgICAgICAgICAgIHdoaWxlICh0eXBlID0gdHlwZXMuc2hpZnQoKSkgewogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2NhbGxiYWNrc1t0eXBlXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJpZ2dlcih0eXBlcykgewogICAgICAgICAgICB2YXIgdHlwZSwgY2FsbGJhY2tzLCBhcmdzLCBzeW5jRmx1c2gsIGFzeW5jRmx1c2g7CiAgICAgICAgICAgIGlmICghdGhpcy5fY2FsbGJhY2tzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgICAgICB0eXBlcyA9IHR5cGVzLnNwbGl0KHNwbGl0dGVyKTsKICAgICAgICAgICAgYXJncyA9IFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgd2hpbGUgKCh0eXBlID0gdHlwZXMuc2hpZnQoKSkgJiYgKGNhbGxiYWNrcyA9IHRoaXMuX2NhbGxiYWNrc1t0eXBlXSkpIHsKICAgICAgICAgICAgICAgIHN5bmNGbHVzaCA9IGdldEZsdXNoKGNhbGxiYWNrcy5zeW5jLCB0aGlzLCBbIHR5cGUgXS5jb25jYXQoYXJncykpOwogICAgICAgICAgICAgICAgYXN5bmNGbHVzaCA9IGdldEZsdXNoKGNhbGxiYWNrcy5hc3luYywgdGhpcywgWyB0eXBlIF0uY29uY2F0KGFyZ3MpKTsKICAgICAgICAgICAgICAgIHN5bmNGbHVzaCgpICYmIG5leHRUaWNrKGFzeW5jRmx1c2gpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRGbHVzaChjYWxsYmFja3MsIGNvbnRleHQsIGFyZ3MpIHsKICAgICAgICAgICAgcmV0dXJuIGZsdXNoOwogICAgICAgICAgICBmdW5jdGlvbiBmbHVzaCgpIHsKICAgICAgICAgICAgICAgIHZhciBjYW5jZWxsZWQ7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gY2FsbGJhY2tzLmxlbmd0aDsgIWNhbmNlbGxlZCAmJiBpIDwgbGVuOyBpICs9IDEpIHsKICAgICAgICAgICAgICAgICAgICBjYW5jZWxsZWQgPSBjYWxsYmFja3NbaV0uYXBwbHkoY29udGV4dCwgYXJncykgPT09IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuICFjYW5jZWxsZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmV4dFRpY2soKSB7CiAgICAgICAgICAgIHZhciBuZXh0VGlja0ZuOwogICAgICAgICAgICBpZiAod2luZG93LnNldEltbWVkaWF0ZSkgewogICAgICAgICAgICAgICAgbmV4dFRpY2tGbiA9IGZ1bmN0aW9uIG5leHRUaWNrU2V0SW1tZWRpYXRlKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SW1tZWRpYXRlKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRUaWNrRm4gPSBmdW5jdGlvbiBuZXh0VGlja1NldFRpbWVvdXQoZm4pIHsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICAgICAgICAgIH0sIDApOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV4dFRpY2tGbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmluZENvbnRleHQoZm4sIGNvbnRleHQpIHsKICAgICAgICAgICAgcmV0dXJuIGZuLmJpbmQgPyBmbi5iaW5kKGNvbnRleHQpIDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBmbi5hcHBseShjb250ZXh0LCBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCkpOwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgIH0oKTsKICAgIHZhciBoaWdobGlnaHQgPSBmdW5jdGlvbihkb2MpIHsKICAgICAgICAKICAgICAgICB2YXIgZGVmYXVsdHMgPSB7CiAgICAgICAgICAgIG5vZGU6IG51bGwsCiAgICAgICAgICAgIHBhdHRlcm46IG51bGwsCiAgICAgICAgICAgIHRhZ05hbWU6ICJzdHJvbmciLAogICAgICAgICAgICBjbGFzc05hbWU6IG51bGwsCiAgICAgICAgICAgIHdvcmRzT25seTogZmFsc2UsCiAgICAgICAgICAgIGNhc2VTZW5zaXRpdmU6IGZhbHNlCiAgICAgICAgfTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gaGlnaHRsaWdodChvKSB7CiAgICAgICAgICAgIHZhciByZWdleDsKICAgICAgICAgICAgbyA9IF8ubWl4aW4oe30sIGRlZmF1bHRzLCBvKTsKICAgICAgICAgICAgaWYgKCFvLm5vZGUgfHwgIW8ucGF0dGVybikgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG8ucGF0dGVybiA9IF8uaXNBcnJheShvLnBhdHRlcm4pID8gby5wYXR0ZXJuIDogWyBvLnBhdHRlcm4gXTsKICAgICAgICAgICAgcmVnZXggPSBnZXRSZWdleChvLnBhdHRlcm4sIG8uY2FzZVNlbnNpdGl2ZSwgby53b3Jkc09ubHkpOwogICAgICAgICAgICB0cmF2ZXJzZShvLm5vZGUsIGhpZ2h0bGlnaHRUZXh0Tm9kZSk7CiAgICAgICAgICAgIGZ1bmN0aW9uIGhpZ2h0bGlnaHRUZXh0Tm9kZSh0ZXh0Tm9kZSkgewogICAgICAgICAgICAgICAgdmFyIG1hdGNoLCBwYXR0ZXJuTm9kZSwgd3JhcHBlck5vZGU7CiAgICAgICAgICAgICAgICBpZiAobWF0Y2ggPSByZWdleC5leGVjKHRleHROb2RlLmRhdGEpKSB7CiAgICAgICAgICAgICAgICAgICAgd3JhcHBlck5vZGUgPSBkb2MuY3JlYXRlRWxlbWVudChvLnRhZ05hbWUpOwogICAgICAgICAgICAgICAgICAgIG8uY2xhc3NOYW1lICYmICh3cmFwcGVyTm9kZS5jbGFzc05hbWUgPSBvLmNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgcGF0dGVybk5vZGUgPSB0ZXh0Tm9kZS5zcGxpdFRleHQobWF0Y2guaW5kZXgpOwogICAgICAgICAgICAgICAgICAgIHBhdHRlcm5Ob2RlLnNwbGl0VGV4dChtYXRjaFswXS5sZW5ndGgpOwogICAgICAgICAgICAgICAgICAgIHdyYXBwZXJOb2RlLmFwcGVuZENoaWxkKHBhdHRlcm5Ob2RlLmNsb25lTm9kZSh0cnVlKSk7CiAgICAgICAgICAgICAgICAgICAgdGV4dE5vZGUucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQod3JhcHBlck5vZGUsIHBhdHRlcm5Ob2RlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiAhIW1hdGNoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIHRyYXZlcnNlKGVsLCBoaWdodGxpZ2h0VGV4dE5vZGUpIHsKICAgICAgICAgICAgICAgIHZhciBjaGlsZE5vZGUsIFRFWFRfTk9ERV9UWVBFID0gMzsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWwuY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNoaWxkTm9kZSA9IGVsLmNoaWxkTm9kZXNbaV07CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkTm9kZS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaSArPSBoaWdodGxpZ2h0VGV4dE5vZGUoY2hpbGROb2RlKSA/IDEgOiAwOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyYXZlcnNlKGNoaWxkTm9kZSwgaGlnaHRsaWdodFRleHROb2RlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGdldFJlZ2V4KHBhdHRlcm5zLCBjYXNlU2Vuc2l0aXZlLCB3b3Jkc09ubHkpIHsKICAgICAgICAgICAgdmFyIGVzY2FwZWRQYXR0ZXJucyA9IFtdLCByZWdleFN0cjsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHBhdHRlcm5zLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICBlc2NhcGVkUGF0dGVybnMucHVzaChfLmVzY2FwZVJlZ0V4Q2hhcnMocGF0dGVybnNbaV0pKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZWdleFN0ciA9IHdvcmRzT25seSA/ICJcXGIoIiArIGVzY2FwZWRQYXR0ZXJucy5qb2luKCJ8IikgKyAiKVxcYiIgOiAiKCIgKyBlc2NhcGVkUGF0dGVybnMuam9pbigifCIpICsgIikiOwogICAgICAgICAgICByZXR1cm4gY2FzZVNlbnNpdGl2ZSA/IG5ldyBSZWdFeHAocmVnZXhTdHIpIDogbmV3IFJlZ0V4cChyZWdleFN0ciwgImkiKTsKICAgICAgICB9CiAgICB9KHdpbmRvdy5kb2N1bWVudCk7CiAgICB2YXIgSW5wdXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAKICAgICAgICB2YXIgc3BlY2lhbEtleUNvZGVNYXA7CiAgICAgICAgc3BlY2lhbEtleUNvZGVNYXAgPSB7CiAgICAgICAgICAgIDk6ICJ0YWIiLAogICAgICAgICAgICAyNzogImVzYyIsCiAgICAgICAgICAgIDM3OiAibGVmdCIsCiAgICAgICAgICAgIDM5OiAicmlnaHQiLAogICAgICAgICAgICAxMzogImVudGVyIiwKICAgICAgICAgICAgMzg6ICJ1cCIsCiAgICAgICAgICAgIDQwOiAiZG93biIKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIElucHV0KG8pIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBvbkJsdXIsIG9uRm9jdXMsIG9uS2V5ZG93biwgb25JbnB1dDsKICAgICAgICAgICAgbyA9IG8gfHwge307CiAgICAgICAgICAgIGlmICghby5pbnB1dCkgewogICAgICAgICAgICAgICAgJC5lcnJvcigiaW5wdXQgaXMgbWlzc2luZyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9uQmx1ciA9IF8uYmluZCh0aGlzLl9vbkJsdXIsIHRoaXMpOwogICAgICAgICAgICBvbkZvY3VzID0gXy5iaW5kKHRoaXMuX29uRm9jdXMsIHRoaXMpOwogICAgICAgICAgICBvbktleWRvd24gPSBfLmJpbmQodGhpcy5fb25LZXlkb3duLCB0aGlzKTsKICAgICAgICAgICAgb25JbnB1dCA9IF8uYmluZCh0aGlzLl9vbklucHV0LCB0aGlzKTsKICAgICAgICAgICAgdGhpcy4kaGludCA9ICQoby5oaW50KTsKICAgICAgICAgICAgdGhpcy4kaW5wdXQgPSAkKG8uaW5wdXQpLm9uKCJibHVyLnR0Iiwgb25CbHVyKS5vbigiZm9jdXMudHQiLCBvbkZvY3VzKS5vbigia2V5ZG93bi50dCIsIG9uS2V5ZG93bik7CiAgICAgICAgICAgIGlmICh0aGlzLiRoaW50Lmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgdGhpcy5zZXRIaW50ID0gdGhpcy5nZXRIaW50ID0gdGhpcy5jbGVhckhpbnQgPSB0aGlzLmNsZWFySGludElmSW52YWxpZCA9IF8ubm9vcDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIV8uaXNNc2llKCkpIHsKICAgICAgICAgICAgICAgIHRoaXMuJGlucHV0Lm9uKCJpbnB1dC50dCIsIG9uSW5wdXQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy4kaW5wdXQub24oImtleWRvd24udHQga2V5cHJlc3MudHQgY3V0LnR0IHBhc3RlLnR0IiwgZnVuY3Rpb24oJGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc3BlY2lhbEtleUNvZGVNYXBbJGUud2hpY2ggfHwgJGUua2V5Q29kZV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBfLmRlZmVyKF8uYmluZCh0aGF0Ll9vbklucHV0LCB0aGF0LCAkZSkpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5xdWVyeSA9IHRoaXMuJGlucHV0LnZhbCgpOwogICAgICAgICAgICB0aGlzLiRvdmVyZmxvd0hlbHBlciA9IGJ1aWxkT3ZlcmZsb3dIZWxwZXIodGhpcy4kaW5wdXQpOwogICAgICAgIH0KICAgICAgICBJbnB1dC5ub3JtYWxpemVRdWVyeSA9IGZ1bmN0aW9uKHN0cikgewogICAgICAgICAgICByZXR1cm4gKHN0ciB8fCAiIikucmVwbGFjZSgvXlxzKi9nLCAiIikucmVwbGFjZSgvXHN7Mix9L2csICIgIik7CiAgICAgICAgfTsKICAgICAgICBfLm1peGluKElucHV0LnByb3RvdHlwZSwgRXZlbnRFbWl0dGVyLCB7CiAgICAgICAgICAgIF9vbkJsdXI6IGZ1bmN0aW9uIG9uQmx1cigpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXRJbnB1dFZhbHVlKCk7CiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoImJsdXJyZWQiKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uRm9jdXM6IGZ1bmN0aW9uIG9uRm9jdXMoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoImZvY3VzZWQiKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uS2V5ZG93bjogZnVuY3Rpb24gb25LZXlkb3duKCRlKSB7CiAgICAgICAgICAgICAgICB2YXIga2V5TmFtZSA9IHNwZWNpYWxLZXlDb2RlTWFwWyRlLndoaWNoIHx8ICRlLmtleUNvZGVdOwogICAgICAgICAgICAgICAgdGhpcy5fbWFuYWdlUHJldmVudERlZmF1bHQoa2V5TmFtZSwgJGUpOwogICAgICAgICAgICAgICAgaWYgKGtleU5hbWUgJiYgdGhpcy5fc2hvdWxkVHJpZ2dlcihrZXlOYW1lLCAkZSkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoa2V5TmFtZSArICJLZXllZCIsICRlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uSW5wdXQ6IGZ1bmN0aW9uIG9uSW5wdXQoKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jaGVja0lucHV0VmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX21hbmFnZVByZXZlbnREZWZhdWx0OiBmdW5jdGlvbiBtYW5hZ2VQcmV2ZW50RGVmYXVsdChrZXlOYW1lLCAkZSkgewogICAgICAgICAgICAgICAgdmFyIHByZXZlbnREZWZhdWx0LCBoaW50VmFsdWUsIGlucHV0VmFsdWU7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKGtleU5hbWUpIHsKICAgICAgICAgICAgICAgICAgY2FzZSAidGFiIjoKICAgICAgICAgICAgICAgICAgICBoaW50VmFsdWUgPSB0aGlzLmdldEhpbnQoKTsKICAgICAgICAgICAgICAgICAgICBpbnB1dFZhbHVlID0gdGhpcy5nZXRJbnB1dFZhbHVlKCk7CiAgICAgICAgICAgICAgICAgICAgcHJldmVudERlZmF1bHQgPSBoaW50VmFsdWUgJiYgaGludFZhbHVlICE9PSBpbnB1dFZhbHVlICYmICF3aXRoTW9kaWZpZXIoJGUpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgY2FzZSAidXAiOgogICAgICAgICAgICAgICAgICBjYXNlICJkb3duIjoKICAgICAgICAgICAgICAgICAgICBwcmV2ZW50RGVmYXVsdCA9ICF3aXRoTW9kaWZpZXIoJGUpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBwcmV2ZW50RGVmYXVsdCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHJldmVudERlZmF1bHQgJiYgJGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX3Nob3VsZFRyaWdnZXI6IGZ1bmN0aW9uIHNob3VsZFRyaWdnZXIoa2V5TmFtZSwgJGUpIHsKICAgICAgICAgICAgICAgIHZhciB0cmlnZ2VyOwogICAgICAgICAgICAgICAgc3dpdGNoIChrZXlOYW1lKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgInRhYiI6CiAgICAgICAgICAgICAgICAgICAgdHJpZ2dlciA9ICF3aXRoTW9kaWZpZXIoJGUpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICB0cmlnZ2VyID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0cmlnZ2VyOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfY2hlY2tJbnB1dFZhbHVlOiBmdW5jdGlvbiBjaGVja0lucHV0VmFsdWUoKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5wdXRWYWx1ZSwgYXJlRXF1aXZhbGVudCwgaGFzRGlmZmVyZW50V2hpdGVzcGFjZTsKICAgICAgICAgICAgICAgIGlucHV0VmFsdWUgPSB0aGlzLmdldElucHV0VmFsdWUoKTsKICAgICAgICAgICAgICAgIGFyZUVxdWl2YWxlbnQgPSBhcmVRdWVyaWVzRXF1aXZhbGVudChpbnB1dFZhbHVlLCB0aGlzLnF1ZXJ5KTsKICAgICAgICAgICAgICAgIGhhc0RpZmZlcmVudFdoaXRlc3BhY2UgPSBhcmVFcXVpdmFsZW50ID8gdGhpcy5xdWVyeS5sZW5ndGggIT09IGlucHV0VmFsdWUubGVuZ3RoIDogZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnF1ZXJ5ID0gaW5wdXRWYWx1ZTsKICAgICAgICAgICAgICAgIGlmICghYXJlRXF1aXZhbGVudCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcigicXVlcnlDaGFuZ2VkIiwgdGhpcy5xdWVyeSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhc0RpZmZlcmVudFdoaXRlc3BhY2UpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoIndoaXRlc3BhY2VDaGFuZ2VkIiwgdGhpcy5xdWVyeSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGZvY3VzOiBmdW5jdGlvbiBmb2N1cygpIHsKICAgICAgICAgICAgICAgIHRoaXMuJGlucHV0LmZvY3VzKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGJsdXI6IGZ1bmN0aW9uIGJsdXIoKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRpbnB1dC5ibHVyKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldFF1ZXJ5OiBmdW5jdGlvbiBnZXRRdWVyeSgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnF1ZXJ5OwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXRRdWVyeTogZnVuY3Rpb24gc2V0UXVlcnkocXVlcnkpIHsKICAgICAgICAgICAgICAgIHRoaXMucXVlcnkgPSBxdWVyeTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0SW5wdXRWYWx1ZTogZnVuY3Rpb24gZ2V0SW5wdXRWYWx1ZSgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiRpbnB1dC52YWwoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0SW5wdXRWYWx1ZTogZnVuY3Rpb24gc2V0SW5wdXRWYWx1ZSh2YWx1ZSwgc2lsZW50KSB7CiAgICAgICAgICAgICAgICB0aGlzLiRpbnB1dC52YWwodmFsdWUpOwogICAgICAgICAgICAgICAgc2lsZW50ID8gdGhpcy5jbGVhckhpbnQoKSA6IHRoaXMuX2NoZWNrSW5wdXRWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZXNldElucHV0VmFsdWU6IGZ1bmN0aW9uIHJlc2V0SW5wdXRWYWx1ZSgpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXRWYWx1ZSh0aGlzLnF1ZXJ5LCB0cnVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0SGludDogZnVuY3Rpb24gZ2V0SGludCgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiRoaW50LnZhbCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXRIaW50OiBmdW5jdGlvbiBzZXRIaW50KHZhbHVlKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRoaW50LnZhbCh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNsZWFySGludDogZnVuY3Rpb24gY2xlYXJIaW50KCkgewogICAgICAgICAgICAgICAgdGhpcy5zZXRIaW50KCIiKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2xlYXJIaW50SWZJbnZhbGlkOiBmdW5jdGlvbiBjbGVhckhpbnRJZkludmFsaWQoKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsLCBoaW50LCB2YWxJc1ByZWZpeE9mSGludCwgaXNWYWxpZDsKICAgICAgICAgICAgICAgIHZhbCA9IHRoaXMuZ2V0SW5wdXRWYWx1ZSgpOwogICAgICAgICAgICAgICAgaGludCA9IHRoaXMuZ2V0SGludCgpOwogICAgICAgICAgICAgICAgdmFsSXNQcmVmaXhPZkhpbnQgPSB2YWwgIT09IGhpbnQgJiYgaGludC5pbmRleE9mKHZhbCkgPT09IDA7CiAgICAgICAgICAgICAgICBpc1ZhbGlkID0gdmFsICE9PSAiIiAmJiB2YWxJc1ByZWZpeE9mSGludCAmJiAhdGhpcy5oYXNPdmVyZmxvdygpOwogICAgICAgICAgICAgICAgIWlzVmFsaWQgJiYgdGhpcy5jbGVhckhpbnQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0TGFuZ3VhZ2VEaXJlY3Rpb246IGZ1bmN0aW9uIGdldExhbmd1YWdlRGlyZWN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuICh0aGlzLiRpbnB1dC5jc3MoImRpcmVjdGlvbiIpIHx8ICJsdHIiKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBoYXNPdmVyZmxvdzogZnVuY3Rpb24gaGFzT3ZlcmZsb3coKSB7CiAgICAgICAgICAgICAgICB2YXIgY29uc3RyYWludCA9IHRoaXMuJGlucHV0LndpZHRoKCkgLSAyOwogICAgICAgICAgICAgICAgdGhpcy4kb3ZlcmZsb3dIZWxwZXIudGV4dCh0aGlzLmdldElucHV0VmFsdWUoKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kb3ZlcmZsb3dIZWxwZXIud2lkdGgoKSA+PSBjb25zdHJhaW50OwogICAgICAgICAgICB9LAogICAgICAgICAgICBpc0N1cnNvckF0RW5kOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZUxlbmd0aCwgc2VsZWN0aW9uU3RhcnQsIHJhbmdlOwogICAgICAgICAgICAgICAgdmFsdWVMZW5ndGggPSB0aGlzLiRpbnB1dC52YWwoKS5sZW5ndGg7CiAgICAgICAgICAgICAgICBzZWxlY3Rpb25TdGFydCA9IHRoaXMuJGlucHV0WzBdLnNlbGVjdGlvblN0YXJ0OwogICAgICAgICAgICAgICAgaWYgKF8uaXNOdW1iZXIoc2VsZWN0aW9uU3RhcnQpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGVjdGlvblN0YXJ0ID09PSB2YWx1ZUxlbmd0aDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZG9jdW1lbnQuc2VsZWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgcmFuZ2UgPSBkb2N1bWVudC5zZWxlY3Rpb24uY3JlYXRlUmFuZ2UoKTsKICAgICAgICAgICAgICAgICAgICByYW5nZS5tb3ZlU3RhcnQoImNoYXJhY3RlciIsIC12YWx1ZUxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlTGVuZ3RoID09PSByYW5nZS50ZXh0Lmxlbmd0aDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICAgICAgICAgICAgdGhpcy4kaGludC5vZmYoIi50dCIpOwogICAgICAgICAgICAgICAgdGhpcy4kaW5wdXQub2ZmKCIudHQiKTsKICAgICAgICAgICAgICAgIHRoaXMuJGhpbnQgPSB0aGlzLiRpbnB1dCA9IHRoaXMuJG92ZXJmbG93SGVscGVyID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBJbnB1dDsKICAgICAgICBmdW5jdGlvbiBidWlsZE92ZXJmbG93SGVscGVyKCRpbnB1dCkgewogICAgICAgICAgICByZXR1cm4gJCgnPHByZSBhcmlhLWhpZGRlbj0idHJ1ZSI+PC9wcmU+JykuY3NzKHsKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICAgICAgICAgICAgdmlzaWJpbGl0eTogImhpZGRlbiIsCiAgICAgICAgICAgICAgICB3aGl0ZVNwYWNlOiAicHJlIiwKICAgICAgICAgICAgICAgIGZvbnRGYW1pbHk6ICRpbnB1dC5jc3MoImZvbnQtZmFtaWx5IiksCiAgICAgICAgICAgICAgICBmb250U2l6ZTogJGlucHV0LmNzcygiZm9udC1zaXplIiksCiAgICAgICAgICAgICAgICBmb250U3R5bGU6ICRpbnB1dC5jc3MoImZvbnQtc3R5bGUiKSwKICAgICAgICAgICAgICAgIGZvbnRWYXJpYW50OiAkaW5wdXQuY3NzKCJmb250LXZhcmlhbnQiKSwKICAgICAgICAgICAgICAgIGZvbnRXZWlnaHQ6ICRpbnB1dC5jc3MoImZvbnQtd2VpZ2h0IiksCiAgICAgICAgICAgICAgICB3b3JkU3BhY2luZzogJGlucHV0LmNzcygid29yZC1zcGFjaW5nIiksCiAgICAgICAgICAgICAgICBsZXR0ZXJTcGFjaW5nOiAkaW5wdXQuY3NzKCJsZXR0ZXItc3BhY2luZyIpLAogICAgICAgICAgICAgICAgdGV4dEluZGVudDogJGlucHV0LmNzcygidGV4dC1pbmRlbnQiKSwKICAgICAgICAgICAgICAgIHRleHRSZW5kZXJpbmc6ICRpbnB1dC5jc3MoInRleHQtcmVuZGVyaW5nIiksCiAgICAgICAgICAgICAgICB0ZXh0VHJhbnNmb3JtOiAkaW5wdXQuY3NzKCJ0ZXh0LXRyYW5zZm9ybSIpCiAgICAgICAgICAgIH0pLmluc2VydEFmdGVyKCRpbnB1dCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFyZVF1ZXJpZXNFcXVpdmFsZW50KGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIElucHV0Lm5vcm1hbGl6ZVF1ZXJ5KGEpID09PSBJbnB1dC5ub3JtYWxpemVRdWVyeShiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2l0aE1vZGlmaWVyKCRlKSB7CiAgICAgICAgICAgIHJldHVybiAkZS5hbHRLZXkgfHwgJGUuY3RybEtleSB8fCAkZS5tZXRhS2V5IHx8ICRlLnNoaWZ0S2V5OwogICAgICAgIH0KICAgIH0oKTsKICAgIHZhciBEYXRhc2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgCiAgICAgICAgdmFyIGRhdGFzZXRLZXkgPSAidHREYXRhc2V0IiwgdmFsdWVLZXkgPSAidHRWYWx1ZSIsIGRhdHVtS2V5ID0gInR0RGF0dW0iOwogICAgICAgIGZ1bmN0aW9uIERhdGFzZXQobykgewogICAgICAgICAgICBvID0gbyB8fCB7fTsKICAgICAgICAgICAgby50ZW1wbGF0ZXMgPSBvLnRlbXBsYXRlcyB8fCB7fTsKICAgICAgICAgICAgaWYgKCFvLnNvdXJjZSkgewogICAgICAgICAgICAgICAgJC5lcnJvcigibWlzc2luZyBzb3VyY2UiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoby5uYW1lICYmICFpc1ZhbGlkTmFtZShvLm5hbWUpKSB7CiAgICAgICAgICAgICAgICAkLmVycm9yKCJpbnZhbGlkIGRhdGFzZXQgbmFtZTogIiArIG8ubmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5xdWVyeSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuaGlnaGxpZ2h0ID0gISFvLmhpZ2hsaWdodDsKICAgICAgICAgICAgdGhpcy5uYW1lID0gby5uYW1lIHx8IF8uZ2V0VW5pcXVlSWQoKTsKICAgICAgICAgICAgdGhpcy5zb3VyY2UgPSBvLnNvdXJjZTsKICAgICAgICAgICAgdGhpcy5kaXNwbGF5Rm4gPSBnZXREaXNwbGF5Rm4oby5kaXNwbGF5IHx8IG8uZGlzcGxheUtleSk7CiAgICAgICAgICAgIHRoaXMudGVtcGxhdGVzID0gZ2V0VGVtcGxhdGVzKG8udGVtcGxhdGVzLCB0aGlzLmRpc3BsYXlGbik7CiAgICAgICAgICAgIHRoaXMuJGVsID0gJChodG1sLmRhdGFzZXQucmVwbGFjZSgiJUNMQVNTJSIsIHRoaXMubmFtZSkpOwogICAgICAgIH0KICAgICAgICBEYXRhc2V0LmV4dHJhY3REYXRhc2V0TmFtZSA9IGZ1bmN0aW9uIGV4dHJhY3REYXRhc2V0TmFtZShlbCkgewogICAgICAgICAgICByZXR1cm4gJChlbCkuZGF0YShkYXRhc2V0S2V5KTsKICAgICAgICB9OwogICAgICAgIERhdGFzZXQuZXh0cmFjdFZhbHVlID0gZnVuY3Rpb24gZXh0cmFjdERhdHVtKGVsKSB7CiAgICAgICAgICAgIHJldHVybiAkKGVsKS5kYXRhKHZhbHVlS2V5KTsKICAgICAgICB9OwogICAgICAgIERhdGFzZXQuZXh0cmFjdERhdHVtID0gZnVuY3Rpb24gZXh0cmFjdERhdHVtKGVsKSB7CiAgICAgICAgICAgIHJldHVybiAkKGVsKS5kYXRhKGRhdHVtS2V5KTsKICAgICAgICB9OwogICAgICAgIF8ubWl4aW4oRGF0YXNldC5wcm90b3R5cGUsIEV2ZW50RW1pdHRlciwgewogICAgICAgICAgICBfcmVuZGVyOiBmdW5jdGlvbiByZW5kZXIocXVlcnksIHN1Z2dlc3Rpb25zKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuJGVsKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBoYXNTdWdnZXN0aW9uczsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmVtcHR5KCk7CiAgICAgICAgICAgICAgICBoYXNTdWdnZXN0aW9ucyA9IHN1Z2dlc3Rpb25zICYmIHN1Z2dlc3Rpb25zLmxlbmd0aDsKICAgICAgICAgICAgICAgIGlmICghaGFzU3VnZ2VzdGlvbnMgJiYgdGhpcy50ZW1wbGF0ZXMuZW1wdHkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5odG1sKGdldEVtcHR5SHRtbCgpKS5wcmVwZW5kKHRoYXQudGVtcGxhdGVzLmhlYWRlciA/IGdldEhlYWRlckh0bWwoKSA6IG51bGwpLmFwcGVuZCh0aGF0LnRlbXBsYXRlcy5mb290ZXIgPyBnZXRGb290ZXJIdG1sKCkgOiBudWxsKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzU3VnZ2VzdGlvbnMpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5odG1sKGdldFN1Z2dlc3Rpb25zSHRtbCgpKS5wcmVwZW5kKHRoYXQudGVtcGxhdGVzLmhlYWRlciA/IGdldEhlYWRlckh0bWwoKSA6IG51bGwpLmFwcGVuZCh0aGF0LnRlbXBsYXRlcy5mb290ZXIgPyBnZXRGb290ZXJIdG1sKCkgOiBudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcigicmVuZGVyZWQiKTsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGdldEVtcHR5SHRtbCgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC50ZW1wbGF0ZXMuZW1wdHkoewogICAgICAgICAgICAgICAgICAgICAgICBxdWVyeTogcXVlcnksCiAgICAgICAgICAgICAgICAgICAgICAgIGlzRW1wdHk6IHRydWUKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGdldFN1Z2dlc3Rpb25zSHRtbCgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgJHN1Z2dlc3Rpb25zLCBub2RlczsKICAgICAgICAgICAgICAgICAgICAkc3VnZ2VzdGlvbnMgPSAkKGh0bWwuc3VnZ2VzdGlvbnMpLmNzcyhjc3Muc3VnZ2VzdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIG5vZGVzID0gXy5tYXAoc3VnZ2VzdGlvbnMsIGdldFN1Z2dlc3Rpb25Ob2RlKTsKICAgICAgICAgICAgICAgICAgICAkc3VnZ2VzdGlvbnMuYXBwZW5kLmFwcGx5KCRzdWdnZXN0aW9ucywgbm9kZXMpOwogICAgICAgICAgICAgICAgICAgIHRoYXQuaGlnaGxpZ2h0ICYmIGhpZ2hsaWdodCh7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZTogInR0LWhpZ2hsaWdodCIsCiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGU6ICRzdWdnZXN0aW9uc1swXSwKICAgICAgICAgICAgICAgICAgICAgICAgcGF0dGVybjogcXVlcnkKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHN1Z2dlc3Rpb25zOwogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGdldFN1Z2dlc3Rpb25Ob2RlKHN1Z2dlc3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyICRlbDsKICAgICAgICAgICAgICAgICAgICAgICAgJGVsID0gJChodG1sLnN1Z2dlc3Rpb24pLmFwcGVuZCh0aGF0LnRlbXBsYXRlcy5zdWdnZXN0aW9uKHN1Z2dlc3Rpb24pKS5kYXRhKGRhdGFzZXRLZXksIHRoYXQubmFtZSkuZGF0YSh2YWx1ZUtleSwgdGhhdC5kaXNwbGF5Rm4oc3VnZ2VzdGlvbikpLmRhdGEoZGF0dW1LZXksIHN1Z2dlc3Rpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAkZWwuY2hpbGRyZW4oKS5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5jc3MoY3NzLnN1Z2dlc3Rpb25DaGlsZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGVsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGdldEhlYWRlckh0bWwoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoYXQudGVtcGxhdGVzLmhlYWRlcih7CiAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXJ5OiBxdWVyeSwKICAgICAgICAgICAgICAgICAgICAgICAgaXNFbXB0eTogIWhhc1N1Z2dlc3Rpb25zCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBnZXRGb290ZXJIdG1sKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGF0LnRlbXBsYXRlcy5mb290ZXIoewogICAgICAgICAgICAgICAgICAgICAgICBxdWVyeTogcXVlcnksCiAgICAgICAgICAgICAgICAgICAgICAgIGlzRW1wdHk6ICFoYXNTdWdnZXN0aW9ucwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXRSb290OiBmdW5jdGlvbiBnZXRSb290KCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJGVsOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShxdWVyeSkgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgdGhpcy5xdWVyeSA9IHF1ZXJ5OwogICAgICAgICAgICAgICAgdGhpcy5jYW5jZWxlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5zb3VyY2UocXVlcnksIHJlbmRlcik7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiByZW5kZXIoc3VnZ2VzdGlvbnMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoYXQuY2FuY2VsZWQgJiYgcXVlcnkgPT09IHRoYXQucXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5fcmVuZGVyKHF1ZXJ5LCBzdWdnZXN0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBjYW5jZWw6IGZ1bmN0aW9uIGNhbmNlbCgpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2FuY2VsZWQgPSB0cnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjbGVhcjogZnVuY3Rpb24gY2xlYXIoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhbmNlbCgpOwogICAgICAgICAgICAgICAgdGhpcy4kZWwuZW1wdHkoKTsKICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcigicmVuZGVyZWQiKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNFbXB0eTogZnVuY3Rpb24gaXNFbXB0eSgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiRlbC5pcygiOmVtcHR5Iik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRlbCA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gRGF0YXNldDsKICAgICAgICBmdW5jdGlvbiBnZXREaXNwbGF5Rm4oZGlzcGxheSkgewogICAgICAgICAgICBkaXNwbGF5ID0gZGlzcGxheSB8fCAidmFsdWUiOwogICAgICAgICAgICByZXR1cm4gXy5pc0Z1bmN0aW9uKGRpc3BsYXkpID8gZGlzcGxheSA6IGRpc3BsYXlGbjsKICAgICAgICAgICAgZnVuY3Rpb24gZGlzcGxheUZuKG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuIG9ialtkaXNwbGF5XTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUZW1wbGF0ZXModGVtcGxhdGVzLCBkaXNwbGF5Rm4pIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGVtcHR5OiB0ZW1wbGF0ZXMuZW1wdHkgJiYgXy50ZW1wbGF0aWZ5KHRlbXBsYXRlcy5lbXB0eSksCiAgICAgICAgICAgICAgICBoZWFkZXI6IHRlbXBsYXRlcy5oZWFkZXIgJiYgXy50ZW1wbGF0aWZ5KHRlbXBsYXRlcy5oZWFkZXIpLAogICAgICAgICAgICAgICAgZm9vdGVyOiB0ZW1wbGF0ZXMuZm9vdGVyICYmIF8udGVtcGxhdGlmeSh0ZW1wbGF0ZXMuZm9vdGVyKSwKICAgICAgICAgICAgICAgIHN1Z2dlc3Rpb246IHRlbXBsYXRlcy5zdWdnZXN0aW9uIHx8IHN1Z2dlc3Rpb25UZW1wbGF0ZQogICAgICAgICAgICB9OwogICAgICAgICAgICBmdW5jdGlvbiBzdWdnZXN0aW9uVGVtcGxhdGUoY29udGV4dCkgewogICAgICAgICAgICAgICAgcmV0dXJuICI8cD4iICsgZGlzcGxheUZuKGNvbnRleHQpICsgIjwvcD4iOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWROYW1lKHN0cikgewogICAgICAgICAgICByZXR1cm4gL15bX2EtekEtWjAtOS1dKyQvLnRlc3Qoc3RyKTsKICAgICAgICB9CiAgICB9KCk7CiAgICB2YXIgRHJvcGRvd24gPSBmdW5jdGlvbigpIHsKICAgICAgICAKICAgICAgICBmdW5jdGlvbiBEcm9wZG93bihvKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgb25TdWdnZXN0aW9uQ2xpY2ssIG9uU3VnZ2VzdGlvbk1vdXNlRW50ZXIsIG9uU3VnZ2VzdGlvbk1vdXNlTGVhdmU7CiAgICAgICAgICAgIG8gPSBvIHx8IHt9OwogICAgICAgICAgICBpZiAoIW8ubWVudSkgewogICAgICAgICAgICAgICAgJC5lcnJvcigibWVudSBpcyByZXF1aXJlZCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaXNPcGVuID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNFbXB0eSA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuZGF0YXNldHMgPSBfLm1hcChvLmRhdGFzZXRzLCBpbml0aWFsaXplRGF0YXNldCk7CiAgICAgICAgICAgIG9uU3VnZ2VzdGlvbkNsaWNrID0gXy5iaW5kKHRoaXMuX29uU3VnZ2VzdGlvbkNsaWNrLCB0aGlzKTsKICAgICAgICAgICAgb25TdWdnZXN0aW9uTW91c2VFbnRlciA9IF8uYmluZCh0aGlzLl9vblN1Z2dlc3Rpb25Nb3VzZUVudGVyLCB0aGlzKTsKICAgICAgICAgICAgb25TdWdnZXN0aW9uTW91c2VMZWF2ZSA9IF8uYmluZCh0aGlzLl9vblN1Z2dlc3Rpb25Nb3VzZUxlYXZlLCB0aGlzKTsKICAgICAgICAgICAgdGhpcy4kbWVudSA9ICQoby5tZW51KS5vbigiY2xpY2sudHQiLCAiLnR0LXN1Z2dlc3Rpb24iLCBvblN1Z2dlc3Rpb25DbGljaykub24oIm1vdXNlZW50ZXIudHQiLCAiLnR0LXN1Z2dlc3Rpb24iLCBvblN1Z2dlc3Rpb25Nb3VzZUVudGVyKS5vbigibW91c2VsZWF2ZS50dCIsICIudHQtc3VnZ2VzdGlvbiIsIG9uU3VnZ2VzdGlvbk1vdXNlTGVhdmUpOwogICAgICAgICAgICBfLmVhY2godGhpcy5kYXRhc2V0cywgZnVuY3Rpb24oZGF0YXNldCkgewogICAgICAgICAgICAgICAgdGhhdC4kbWVudS5hcHBlbmQoZGF0YXNldC5nZXRSb290KCkpOwogICAgICAgICAgICAgICAgZGF0YXNldC5vblN5bmMoInJlbmRlcmVkIiwgdGhhdC5fb25SZW5kZXJlZCwgdGhhdCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBfLm1peGluKERyb3Bkb3duLnByb3RvdHlwZSwgRXZlbnRFbWl0dGVyLCB7CiAgICAgICAgICAgIF9vblN1Z2dlc3Rpb25DbGljazogZnVuY3Rpb24gb25TdWdnZXN0aW9uQ2xpY2soJGUpIHsKICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcigic3VnZ2VzdGlvbkNsaWNrZWQiLCAkKCRlLmN1cnJlbnRUYXJnZXQpKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uU3VnZ2VzdGlvbk1vdXNlRW50ZXI6IGZ1bmN0aW9uIG9uU3VnZ2VzdGlvbk1vdXNlRW50ZXIoJGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3JlbW92ZUN1cnNvcigpOwogICAgICAgICAgICAgICAgdGhpcy5fc2V0Q3Vyc29yKCQoJGUuY3VycmVudFRhcmdldCksIHRydWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfb25TdWdnZXN0aW9uTW91c2VMZWF2ZTogZnVuY3Rpb24gb25TdWdnZXN0aW9uTW91c2VMZWF2ZSgpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3JlbW92ZUN1cnNvcigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfb25SZW5kZXJlZDogZnVuY3Rpb24gb25SZW5kZXJlZCgpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNFbXB0eSA9IF8uZXZlcnkodGhpcy5kYXRhc2V0cywgaXNEYXRhc2V0RW1wdHkpOwogICAgICAgICAgICAgICAgdGhpcy5pc0VtcHR5ID8gdGhpcy5faGlkZSgpIDogdGhpcy5pc09wZW4gJiYgdGhpcy5fc2hvdygpOwogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCJkYXRhc2V0UmVuZGVyZWQiKTsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGlzRGF0YXNldEVtcHR5KGRhdGFzZXQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0YXNldC5pc0VtcHR5KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9oaWRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRoaXMuJG1lbnUuaGlkZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfc2hvdzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRtZW51LmNzcygiZGlzcGxheSIsICJibG9jayIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfZ2V0U3VnZ2VzdGlvbnM6IGZ1bmN0aW9uIGdldFN1Z2dlc3Rpb25zKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJG1lbnUuZmluZCgiLnR0LXN1Z2dlc3Rpb24iKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX2dldEN1cnNvcjogZnVuY3Rpb24gZ2V0Q3Vyc29yKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJG1lbnUuZmluZCgiLnR0LWN1cnNvciIpLmZpcnN0KCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9zZXRDdXJzb3I6IGZ1bmN0aW9uIHNldEN1cnNvcigkZWwsIHNpbGVudCkgewogICAgICAgICAgICAgICAgJGVsLmZpcnN0KCkuYWRkQ2xhc3MoInR0LWN1cnNvciIpOwogICAgICAgICAgICAgICAgIXNpbGVudCAmJiB0aGlzLnRyaWdnZXIoImN1cnNvck1vdmVkIik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9yZW1vdmVDdXJzb3I6IGZ1bmN0aW9uIHJlbW92ZUN1cnNvcigpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2dldEN1cnNvcigpLnJlbW92ZUNsYXNzKCJ0dC1jdXJzb3IiKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX21vdmVDdXJzb3I6IGZ1bmN0aW9uIG1vdmVDdXJzb3IoaW5jcmVtZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgJHN1Z2dlc3Rpb25zLCAkb2xkQ3Vyc29yLCBuZXdDdXJzb3JJbmRleCwgJG5ld0N1cnNvcjsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc09wZW4pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkb2xkQ3Vyc29yID0gdGhpcy5fZ2V0Q3Vyc29yKCk7CiAgICAgICAgICAgICAgICAkc3VnZ2VzdGlvbnMgPSB0aGlzLl9nZXRTdWdnZXN0aW9ucygpOwogICAgICAgICAgICAgICAgdGhpcy5fcmVtb3ZlQ3Vyc29yKCk7CiAgICAgICAgICAgICAgICBuZXdDdXJzb3JJbmRleCA9ICRzdWdnZXN0aW9ucy5pbmRleCgkb2xkQ3Vyc29yKSArIGluY3JlbWVudDsKICAgICAgICAgICAgICAgIG5ld0N1cnNvckluZGV4ID0gKG5ld0N1cnNvckluZGV4ICsgMSkgJSAoJHN1Z2dlc3Rpb25zLmxlbmd0aCArIDEpIC0gMTsKICAgICAgICAgICAgICAgIGlmIChuZXdDdXJzb3JJbmRleCA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoImN1cnNvclJlbW92ZWQiKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5ld0N1cnNvckluZGV4IDwgLTEpIHsKICAgICAgICAgICAgICAgICAgICBuZXdDdXJzb3JJbmRleCA9ICRzdWdnZXN0aW9ucy5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5fc2V0Q3Vyc29yKCRuZXdDdXJzb3IgPSAkc3VnZ2VzdGlvbnMuZXEobmV3Q3Vyc29ySW5kZXgpKTsKICAgICAgICAgICAgICAgIHRoaXMuX2Vuc3VyZVZpc2libGUoJG5ld0N1cnNvcik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9lbnN1cmVWaXNpYmxlOiBmdW5jdGlvbiBlbnN1cmVWaXNpYmxlKCRlbCkgewogICAgICAgICAgICAgICAgdmFyIGVsVG9wLCBlbEJvdHRvbSwgbWVudVNjcm9sbFRvcCwgbWVudUhlaWdodDsKICAgICAgICAgICAgICAgIGVsVG9wID0gJGVsLnBvc2l0aW9uKCkudG9wOwogICAgICAgICAgICAgICAgZWxCb3R0b20gPSBlbFRvcCArICRlbC5vdXRlckhlaWdodCh0cnVlKTsKICAgICAgICAgICAgICAgIG1lbnVTY3JvbGxUb3AgPSB0aGlzLiRtZW51LnNjcm9sbFRvcCgpOwogICAgICAgICAgICAgICAgbWVudUhlaWdodCA9IHRoaXMuJG1lbnUuaGVpZ2h0KCkgKyBwYXJzZUludCh0aGlzLiRtZW51LmNzcygicGFkZGluZ1RvcCIpLCAxMCkgKyBwYXJzZUludCh0aGlzLiRtZW51LmNzcygicGFkZGluZ0JvdHRvbSIpLCAxMCk7CiAgICAgICAgICAgICAgICBpZiAoZWxUb3AgPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kbWVudS5zY3JvbGxUb3AobWVudVNjcm9sbFRvcCArIGVsVG9wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobWVudUhlaWdodCA8IGVsQm90dG9tKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kbWVudS5zY3JvbGxUb3AobWVudVNjcm9sbFRvcCArIChlbEJvdHRvbSAtIG1lbnVIZWlnaHQpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2xvc2U6IGZ1bmN0aW9uIGNsb3NlKCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNPcGVuKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc09wZW4gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZW1vdmVDdXJzb3IoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCJjbG9zZWQiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgb3BlbjogZnVuY3Rpb24gb3BlbigpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc09wZW4pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzT3BlbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgIXRoaXMuaXNFbXB0eSAmJiB0aGlzLl9zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCJvcGVuZWQiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0TGFuZ3VhZ2VEaXJlY3Rpb246IGZ1bmN0aW9uIHNldExhbmd1YWdlRGlyZWN0aW9uKGRpcikgewogICAgICAgICAgICAgICAgdGhpcy4kbWVudS5jc3MoZGlyID09PSAibHRyIiA/IGNzcy5sdHIgOiBjc3MucnRsKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbW92ZUN1cnNvclVwOiBmdW5jdGlvbiBtb3ZlQ3Vyc29yVXAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9tb3ZlQ3Vyc29yKC0xKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbW92ZUN1cnNvckRvd246IGZ1bmN0aW9uIG1vdmVDdXJzb3JEb3duKCkgewogICAgICAgICAgICAgICAgdGhpcy5fbW92ZUN1cnNvcigrMSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldERhdHVtRm9yU3VnZ2VzdGlvbjogZnVuY3Rpb24gZ2V0RGF0dW1Gb3JTdWdnZXN0aW9uKCRlbCkgewogICAgICAgICAgICAgICAgdmFyIGRhdHVtID0gbnVsbDsKICAgICAgICAgICAgICAgIGlmICgkZWwubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0dW0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJhdzogRGF0YXNldC5leHRyYWN0RGF0dW0oJGVsKSwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IERhdGFzZXQuZXh0cmFjdFZhbHVlKCRlbCksCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFzZXROYW1lOiBEYXRhc2V0LmV4dHJhY3REYXRhc2V0TmFtZSgkZWwpCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBkYXR1bTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0RGF0dW1Gb3JDdXJzb3I6IGZ1bmN0aW9uIGdldERhdHVtRm9yQ3Vyc29yKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RGF0dW1Gb3JTdWdnZXN0aW9uKHRoaXMuX2dldEN1cnNvcigpLmZpcnN0KCkpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXREYXR1bUZvclRvcFN1Z2dlc3Rpb246IGZ1bmN0aW9uIGdldERhdHVtRm9yVG9wU3VnZ2VzdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldERhdHVtRm9yU3VnZ2VzdGlvbih0aGlzLl9nZXRTdWdnZXN0aW9ucygpLmZpcnN0KCkpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShxdWVyeSkgewogICAgICAgICAgICAgICAgXy5lYWNoKHRoaXMuZGF0YXNldHMsIHVwZGF0ZURhdGFzZXQpOwogICAgICAgICAgICAgICAgZnVuY3Rpb24gdXBkYXRlRGF0YXNldChkYXRhc2V0KSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YXNldC51cGRhdGUocXVlcnkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBlbXB0eTogZnVuY3Rpb24gZW1wdHkoKSB7CiAgICAgICAgICAgICAgICBfLmVhY2godGhpcy5kYXRhc2V0cywgY2xlYXJEYXRhc2V0KTsKICAgICAgICAgICAgICAgIHRoaXMuaXNFbXB0eSA9IHRydWU7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjbGVhckRhdGFzZXQoZGF0YXNldCkgewogICAgICAgICAgICAgICAgICAgIGRhdGFzZXQuY2xlYXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNWaXNpYmxlOiBmdW5jdGlvbiBpc1Zpc2libGUoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pc09wZW4gJiYgIXRoaXMuaXNFbXB0eTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgICAgICAgICAgIHRoaXMuJG1lbnUub2ZmKCIudHQiKTsKICAgICAgICAgICAgICAgIHRoaXMuJG1lbnUgPSBudWxsOwogICAgICAgICAgICAgICAgXy5lYWNoKHRoaXMuZGF0YXNldHMsIGRlc3Ryb3lEYXRhc2V0KTsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGRlc3Ryb3lEYXRhc2V0KGRhdGFzZXQpIHsKICAgICAgICAgICAgICAgICAgICBkYXRhc2V0LmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBEcm9wZG93bjsKICAgICAgICBmdW5jdGlvbiBpbml0aWFsaXplRGF0YXNldChvRGF0YXNldCkgewogICAgICAgICAgICByZXR1cm4gbmV3IERhdGFzZXQob0RhdGFzZXQpOwogICAgICAgIH0KICAgIH0oKTsKICAgIHZhciBUeXBlYWhlYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAKICAgICAgICB2YXIgYXR0cnNLZXkgPSAidHRBdHRycyI7CiAgICAgICAgZnVuY3Rpb24gVHlwZWFoZWFkKG8pIHsKICAgICAgICAgICAgdmFyICRtZW51LCAkaW5wdXQsICRoaW50OwogICAgICAgICAgICBvID0gbyB8fCB7fTsKICAgICAgICAgICAgaWYgKCFvLmlucHV0KSB7CiAgICAgICAgICAgICAgICAkLmVycm9yKCJtaXNzaW5nIGlucHV0Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5pc0FjdGl2YXRlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmF1dG9zZWxlY3QgPSAhIW8uYXV0b3NlbGVjdDsKICAgICAgICAgICAgdGhpcy5taW5MZW5ndGggPSBfLmlzTnVtYmVyKG8ubWluTGVuZ3RoKSA/IG8ubWluTGVuZ3RoIDogMTsKICAgICAgICAgICAgdGhpcy4kbm9kZSA9IGJ1aWxkRG9tKG8uaW5wdXQsIG8ud2l0aEhpbnQpOwogICAgICAgICAgICAkbWVudSA9IHRoaXMuJG5vZGUuZmluZCgiLnR0LWRyb3Bkb3duLW1lbnUiKTsKICAgICAgICAgICAgJGlucHV0ID0gdGhpcy4kbm9kZS5maW5kKCIudHQtaW5wdXQiKTsKICAgICAgICAgICAgJGhpbnQgPSB0aGlzLiRub2RlLmZpbmQoIi50dC1oaW50Iik7CiAgICAgICAgICAgICRpbnB1dC5vbigiYmx1ci50dCIsIGZ1bmN0aW9uKCRlKSB7CiAgICAgICAgICAgICAgICB2YXIgYWN0aXZlLCBpc0FjdGl2ZSwgaGFzQWN0aXZlOwogICAgICAgICAgICAgICAgYWN0aXZlID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDsKICAgICAgICAgICAgICAgIGlzQWN0aXZlID0gJG1lbnUuaXMoYWN0aXZlKTsKICAgICAgICAgICAgICAgIGhhc0FjdGl2ZSA9ICRtZW51LmhhcyhhY3RpdmUpLmxlbmd0aCA+IDA7CiAgICAgICAgICAgICAgICBpZiAoXy5pc01zaWUoKSAmJiAoaXNBY3RpdmUgfHwgaGFzQWN0aXZlKSkgewogICAgICAgICAgICAgICAgICAgICRlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgJGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgXy5kZWZlcihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGlucHV0LmZvY3VzKCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAkbWVudS5vbigibW91c2Vkb3duLnR0IiwgZnVuY3Rpb24oJGUpIHsKICAgICAgICAgICAgICAgICRlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmV2ZW50QnVzID0gby5ldmVudEJ1cyB8fCBuZXcgRXZlbnRCdXMoewogICAgICAgICAgICAgICAgZWw6ICRpbnB1dAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5kcm9wZG93biA9IG5ldyBEcm9wZG93bih7CiAgICAgICAgICAgICAgICBtZW51OiAkbWVudSwKICAgICAgICAgICAgICAgIGRhdGFzZXRzOiBvLmRhdGFzZXRzCiAgICAgICAgICAgIH0pLm9uU3luYygic3VnZ2VzdGlvbkNsaWNrZWQiLCB0aGlzLl9vblN1Z2dlc3Rpb25DbGlja2VkLCB0aGlzKS5vblN5bmMoImN1cnNvck1vdmVkIiwgdGhpcy5fb25DdXJzb3JNb3ZlZCwgdGhpcykub25TeW5jKCJjdXJzb3JSZW1vdmVkIiwgdGhpcy5fb25DdXJzb3JSZW1vdmVkLCB0aGlzKS5vblN5bmMoIm9wZW5lZCIsIHRoaXMuX29uT3BlbmVkLCB0aGlzKS5vblN5bmMoImNsb3NlZCIsIHRoaXMuX29uQ2xvc2VkLCB0aGlzKS5vbkFzeW5jKCJkYXRhc2V0UmVuZGVyZWQiLCB0aGlzLl9vbkRhdGFzZXRSZW5kZXJlZCwgdGhpcyk7CiAgICAgICAgICAgIHRoaXMuaW5wdXQgPSBuZXcgSW5wdXQoewogICAgICAgICAgICAgICAgaW5wdXQ6ICRpbnB1dCwKICAgICAgICAgICAgICAgIGhpbnQ6ICRoaW50CiAgICAgICAgICAgIH0pLm9uU3luYygiZm9jdXNlZCIsIHRoaXMuX29uRm9jdXNlZCwgdGhpcykub25TeW5jKCJibHVycmVkIiwgdGhpcy5fb25CbHVycmVkLCB0aGlzKS5vblN5bmMoImVudGVyS2V5ZWQiLCB0aGlzLl9vbkVudGVyS2V5ZWQsIHRoaXMpLm9uU3luYygidGFiS2V5ZWQiLCB0aGlzLl9vblRhYktleWVkLCB0aGlzKS5vblN5bmMoImVzY0tleWVkIiwgdGhpcy5fb25Fc2NLZXllZCwgdGhpcykub25TeW5jKCJ1cEtleWVkIiwgdGhpcy5fb25VcEtleWVkLCB0aGlzKS5vblN5bmMoImRvd25LZXllZCIsIHRoaXMuX29uRG93bktleWVkLCB0aGlzKS5vblN5bmMoImxlZnRLZXllZCIsIHRoaXMuX29uTGVmdEtleWVkLCB0aGlzKS5vblN5bmMoInJpZ2h0S2V5ZWQiLCB0aGlzLl9vblJpZ2h0S2V5ZWQsIHRoaXMpLm9uU3luYygicXVlcnlDaGFuZ2VkIiwgdGhpcy5fb25RdWVyeUNoYW5nZWQsIHRoaXMpLm9uU3luYygid2hpdGVzcGFjZUNoYW5nZWQiLCB0aGlzLl9vbldoaXRlc3BhY2VDaGFuZ2VkLCB0aGlzKTsKICAgICAgICAgICAgdGhpcy5fc2V0TGFuZ3VhZ2VEaXJlY3Rpb24oKTsKICAgICAgICB9CiAgICAgICAgXy5taXhpbihUeXBlYWhlYWQucHJvdG90eXBlLCB7CiAgICAgICAgICAgIF9vblN1Z2dlc3Rpb25DbGlja2VkOiBmdW5jdGlvbiBvblN1Z2dlc3Rpb25DbGlja2VkKHR5cGUsICRlbCkgewogICAgICAgICAgICAgICAgdmFyIGRhdHVtOwogICAgICAgICAgICAgICAgaWYgKGRhdHVtID0gdGhpcy5kcm9wZG93bi5nZXREYXR1bUZvclN1Z2dlc3Rpb24oJGVsKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NlbGVjdChkYXR1bSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9vbkN1cnNvck1vdmVkOiBmdW5jdGlvbiBvbkN1cnNvck1vdmVkKCkgewogICAgICAgICAgICAgICAgdmFyIGRhdHVtID0gdGhpcy5kcm9wZG93bi5nZXREYXR1bUZvckN1cnNvcigpOwogICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5zZXRJbnB1dFZhbHVlKGRhdHVtLnZhbHVlLCB0cnVlKTsKICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRCdXMudHJpZ2dlcigiY3Vyc29yY2hhbmdlZCIsIGRhdHVtLnJhdywgZGF0dW0uZGF0YXNldE5hbWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfb25DdXJzb3JSZW1vdmVkOiBmdW5jdGlvbiBvbkN1cnNvclJlbW92ZWQoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlucHV0LnJlc2V0SW5wdXRWYWx1ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlSGludCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfb25EYXRhc2V0UmVuZGVyZWQ6IGZ1bmN0aW9uIG9uRGF0YXNldFJlbmRlcmVkKCkgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlSGludCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfb25PcGVuZWQ6IGZ1bmN0aW9uIG9uT3BlbmVkKCkgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlSGludCgpOwogICAgICAgICAgICAgICAgdGhpcy5ldmVudEJ1cy50cmlnZ2VyKCJvcGVuZWQiKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uQ2xvc2VkOiBmdW5jdGlvbiBvbkNsb3NlZCgpIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5wdXQuY2xlYXJIaW50KCk7CiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50QnVzLnRyaWdnZXIoImNsb3NlZCIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfb25Gb2N1c2VkOiBmdW5jdGlvbiBvbkZvY3VzZWQoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzQWN0aXZhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcGRvd24ub3BlbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfb25CbHVycmVkOiBmdW5jdGlvbiBvbkJsdXJyZWQoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzQWN0aXZhdGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3Bkb3duLmVtcHR5KCk7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3Bkb3duLmNsb3NlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9vbkVudGVyS2V5ZWQ6IGZ1bmN0aW9uIG9uRW50ZXJLZXllZCh0eXBlLCAkZSkgewogICAgICAgICAgICAgICAgdmFyIGN1cnNvckRhdHVtLCB0b3BTdWdnZXN0aW9uRGF0dW07CiAgICAgICAgICAgICAgICBjdXJzb3JEYXR1bSA9IHRoaXMuZHJvcGRvd24uZ2V0RGF0dW1Gb3JDdXJzb3IoKTsKICAgICAgICAgICAgICAgIHRvcFN1Z2dlc3Rpb25EYXR1bSA9IHRoaXMuZHJvcGRvd24uZ2V0RGF0dW1Gb3JUb3BTdWdnZXN0aW9uKCk7CiAgICAgICAgICAgICAgICBpZiAoY3Vyc29yRGF0dW0pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZWxlY3QoY3Vyc29yRGF0dW0pOwogICAgICAgICAgICAgICAgICAgICRlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuYXV0b3NlbGVjdCAmJiB0b3BTdWdnZXN0aW9uRGF0dW0pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZWxlY3QodG9wU3VnZ2VzdGlvbkRhdHVtKTsKICAgICAgICAgICAgICAgICAgICAkZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBfb25UYWJLZXllZDogZnVuY3Rpb24gb25UYWJLZXllZCh0eXBlLCAkZSkgewogICAgICAgICAgICAgICAgdmFyIGRhdHVtOwogICAgICAgICAgICAgICAgaWYgKGRhdHVtID0gdGhpcy5kcm9wZG93bi5nZXREYXR1bUZvckN1cnNvcigpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2VsZWN0KGRhdHVtKTsKICAgICAgICAgICAgICAgICAgICAkZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hdXRvY29tcGxldGUodHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9vbkVzY0tleWVkOiBmdW5jdGlvbiBvbkVzY0tleWVkKCkgewogICAgICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5jbG9zZSgpOwogICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5yZXNldElucHV0VmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uVXBLZXllZDogZnVuY3Rpb24gb25VcEtleWVkKCkgewogICAgICAgICAgICAgICAgdmFyIHF1ZXJ5ID0gdGhpcy5pbnB1dC5nZXRRdWVyeSgpOwogICAgICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5pc0VtcHR5ICYmIHF1ZXJ5Lmxlbmd0aCA+PSB0aGlzLm1pbkxlbmd0aCA/IHRoaXMuZHJvcGRvd24udXBkYXRlKHF1ZXJ5KSA6IHRoaXMuZHJvcGRvd24ubW92ZUN1cnNvclVwKCk7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3Bkb3duLm9wZW4oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uRG93bktleWVkOiBmdW5jdGlvbiBvbkRvd25LZXllZCgpIHsKICAgICAgICAgICAgICAgIHZhciBxdWVyeSA9IHRoaXMuaW5wdXQuZ2V0UXVlcnkoKTsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uaXNFbXB0eSAmJiBxdWVyeS5sZW5ndGggPj0gdGhpcy5taW5MZW5ndGggPyB0aGlzLmRyb3Bkb3duLnVwZGF0ZShxdWVyeSkgOiB0aGlzLmRyb3Bkb3duLm1vdmVDdXJzb3JEb3duKCk7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3Bkb3duLm9wZW4oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uTGVmdEtleWVkOiBmdW5jdGlvbiBvbkxlZnRLZXllZCgpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGlyID09PSAicnRsIiAmJiB0aGlzLl9hdXRvY29tcGxldGUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uUmlnaHRLZXllZDogZnVuY3Rpb24gb25SaWdodEtleWVkKCkgewogICAgICAgICAgICAgICAgdGhpcy5kaXIgPT09ICJsdHIiICYmIHRoaXMuX2F1dG9jb21wbGV0ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfb25RdWVyeUNoYW5nZWQ6IGZ1bmN0aW9uIG9uUXVlcnlDaGFuZ2VkKGUsIHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICB0aGlzLmlucHV0LmNsZWFySGludElmSW52YWxpZCgpOwogICAgICAgICAgICAgICAgcXVlcnkubGVuZ3RoID49IHRoaXMubWluTGVuZ3RoID8gdGhpcy5kcm9wZG93bi51cGRhdGUocXVlcnkpIDogdGhpcy5kcm9wZG93bi5lbXB0eSgpOwogICAgICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5vcGVuKCk7CiAgICAgICAgICAgICAgICB0aGlzLl9zZXRMYW5ndWFnZURpcmVjdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfb25XaGl0ZXNwYWNlQ2hhbmdlZDogZnVuY3Rpb24gb25XaGl0ZXNwYWNlQ2hhbmdlZCgpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUhpbnQoKTsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcGRvd24ub3BlbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfc2V0TGFuZ3VhZ2VEaXJlY3Rpb246IGZ1bmN0aW9uIHNldExhbmd1YWdlRGlyZWN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGRpcjsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRpciAhPT0gKGRpciA9IHRoaXMuaW5wdXQuZ2V0TGFuZ3VhZ2VEaXJlY3Rpb24oKSkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRpciA9IGRpcjsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRub2RlLmNzcygiZGlyZWN0aW9uIiwgZGlyKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyb3Bkb3duLnNldExhbmd1YWdlRGlyZWN0aW9uKGRpcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF91cGRhdGVIaW50OiBmdW5jdGlvbiB1cGRhdGVIaW50KCkgewogICAgICAgICAgICAgICAgdmFyIGRhdHVtLCB2YWwsIHF1ZXJ5LCBlc2NhcGVkUXVlcnksIGZyb250TWF0Y2hSZWdFeCwgbWF0Y2g7CiAgICAgICAgICAgICAgICBkYXR1bSA9IHRoaXMuZHJvcGRvd24uZ2V0RGF0dW1Gb3JUb3BTdWdnZXN0aW9uKCk7CiAgICAgICAgICAgICAgICBpZiAoZGF0dW0gJiYgdGhpcy5kcm9wZG93bi5pc1Zpc2libGUoKSAmJiAhdGhpcy5pbnB1dC5oYXNPdmVyZmxvdygpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsID0gdGhpcy5pbnB1dC5nZXRJbnB1dFZhbHVlKCk7CiAgICAgICAgICAgICAgICAgICAgcXVlcnkgPSBJbnB1dC5ub3JtYWxpemVRdWVyeSh2YWwpOwogICAgICAgICAgICAgICAgICAgIGVzY2FwZWRRdWVyeSA9IF8uZXNjYXBlUmVnRXhDaGFycyhxdWVyeSk7CiAgICAgICAgICAgICAgICAgICAgZnJvbnRNYXRjaFJlZ0V4ID0gbmV3IFJlZ0V4cCgiXig/OiIgKyBlc2NhcGVkUXVlcnkgKyAiKSguKyQpIiwgImkiKTsKICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IGZyb250TWF0Y2hSZWdFeC5leGVjKGRhdHVtLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICBtYXRjaCA/IHRoaXMuaW5wdXQuc2V0SGludCh2YWwgKyBtYXRjaFsxXSkgOiB0aGlzLmlucHV0LmNsZWFySGludCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlucHV0LmNsZWFySGludCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBfYXV0b2NvbXBsZXRlOiBmdW5jdGlvbiBhdXRvY29tcGxldGUobGF4Q3Vyc29yKSB7CiAgICAgICAgICAgICAgICB2YXIgaGludCwgcXVlcnksIGlzQ3Vyc29yQXRFbmQsIGRhdHVtOwogICAgICAgICAgICAgICAgaGludCA9IHRoaXMuaW5wdXQuZ2V0SGludCgpOwogICAgICAgICAgICAgICAgcXVlcnkgPSB0aGlzLmlucHV0LmdldFF1ZXJ5KCk7CiAgICAgICAgICAgICAgICBpc0N1cnNvckF0RW5kID0gbGF4Q3Vyc29yIHx8IHRoaXMuaW5wdXQuaXNDdXJzb3JBdEVuZCgpOwogICAgICAgICAgICAgICAgaWYgKGhpbnQgJiYgcXVlcnkgIT09IGhpbnQgJiYgaXNDdXJzb3JBdEVuZCkgewogICAgICAgICAgICAgICAgICAgIGRhdHVtID0gdGhpcy5kcm9wZG93bi5nZXREYXR1bUZvclRvcFN1Z2dlc3Rpb24oKTsKICAgICAgICAgICAgICAgICAgICBkYXR1bSAmJiB0aGlzLmlucHV0LnNldElucHV0VmFsdWUoZGF0dW0udmFsdWUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRCdXMudHJpZ2dlcigiYXV0b2NvbXBsZXRlZCIsIGRhdHVtLnJhdywgZGF0dW0uZGF0YXNldE5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBfc2VsZWN0OiBmdW5jdGlvbiBzZWxlY3QoZGF0dW0pIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5wdXQuc2V0UXVlcnkoZGF0dW0udmFsdWUpOwogICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5zZXRJbnB1dFZhbHVlKGRhdHVtLnZhbHVlLCB0cnVlKTsKICAgICAgICAgICAgICAgIHRoaXMuX3NldExhbmd1YWdlRGlyZWN0aW9uKCk7CiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50QnVzLnRyaWdnZXIoInNlbGVjdGVkIiwgZGF0dW0ucmF3LCBkYXR1bS5kYXRhc2V0TmFtZSk7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3Bkb3duLmNsb3NlKCk7CiAgICAgICAgICAgICAgICBfLmRlZmVyKF8uYmluZCh0aGlzLmRyb3Bkb3duLmVtcHR5LCB0aGlzLmRyb3Bkb3duKSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9wZW46IGZ1bmN0aW9uIG9wZW4oKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3Bkb3duLm9wZW4oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2xvc2U6IGZ1bmN0aW9uIGNsb3NlKCkgewogICAgICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5jbG9zZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXRWYWw6IGZ1bmN0aW9uIHNldFZhbCh2YWwpIHsKICAgICAgICAgICAgICAgIHZhbCA9IF8udG9TdHIodmFsKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzQWN0aXZhdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5zZXRJbnB1dFZhbHVlKHZhbCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaW5wdXQuc2V0UXVlcnkodmFsKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlucHV0LnNldElucHV0VmFsdWUodmFsLCB0cnVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX3NldExhbmd1YWdlRGlyZWN0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldFZhbDogZnVuY3Rpb24gZ2V0VmFsKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5wdXQuZ2V0UXVlcnkoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5wdXQuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICBkZXN0cm95RG9tU3RydWN0dXJlKHRoaXMuJG5vZGUpOwogICAgICAgICAgICAgICAgdGhpcy4kbm9kZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gVHlwZWFoZWFkOwogICAgICAgIGZ1bmN0aW9uIGJ1aWxkRG9tKGlucHV0LCB3aXRoSGludCkgewogICAgICAgICAgICB2YXIgJGlucHV0LCAkd3JhcHBlciwgJGRyb3Bkb3duLCAkaGludDsKICAgICAgICAgICAgJGlucHV0ID0gJChpbnB1dCk7CiAgICAgICAgICAgICR3cmFwcGVyID0gJChodG1sLndyYXBwZXIpLmNzcyhjc3Mud3JhcHBlcik7CiAgICAgICAgICAgICRkcm9wZG93biA9ICQoaHRtbC5kcm9wZG93bikuY3NzKGNzcy5kcm9wZG93bik7CiAgICAgICAgICAgICRoaW50ID0gJGlucHV0LmNsb25lKCkuY3NzKGNzcy5oaW50KS5jc3MoZ2V0QmFja2dyb3VuZFN0eWxlcygkaW5wdXQpKTsKICAgICAgICAgICAgJGhpbnQudmFsKCIiKS5yZW1vdmVEYXRhKCkuYWRkQ2xhc3MoInR0LWhpbnQiKS5yZW1vdmVBdHRyKCJpZCBuYW1lIHBsYWNlaG9sZGVyIHJlcXVpcmVkIikucHJvcCgicmVhZG9ubHkiLCB0cnVlKS5hdHRyKHsKICAgICAgICAgICAgICAgIGF1dG9jb21wbGV0ZTogIm9mZiIsCiAgICAgICAgICAgICAgICBzcGVsbGNoZWNrOiAiZmFsc2UiLAogICAgICAgICAgICAgICAgdGFiaW5kZXg6IC0xCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAkaW5wdXQuZGF0YShhdHRyc0tleSwgewogICAgICAgICAgICAgICAgZGlyOiAkaW5wdXQuYXR0cigiZGlyIiksCiAgICAgICAgICAgICAgICBhdXRvY29tcGxldGU6ICRpbnB1dC5hdHRyKCJhdXRvY29tcGxldGUiKSwKICAgICAgICAgICAgICAgIHNwZWxsY2hlY2s6ICRpbnB1dC5hdHRyKCJzcGVsbGNoZWNrIiksCiAgICAgICAgICAgICAgICBzdHlsZTogJGlucHV0LmF0dHIoInN0eWxlIikKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICRpbnB1dC5hZGRDbGFzcygidHQtaW5wdXQiKS5hdHRyKHsKICAgICAgICAgICAgICAgIGF1dG9jb21wbGV0ZTogIm9mZiIsCiAgICAgICAgICAgICAgICBzcGVsbGNoZWNrOiBmYWxzZQogICAgICAgICAgICB9KS5jc3Mod2l0aEhpbnQgPyBjc3MuaW5wdXQgOiBjc3MuaW5wdXRXaXRoTm9IaW50KTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICEkaW5wdXQuYXR0cigiZGlyIikgJiYgJGlucHV0LmF0dHIoImRpciIsICJhdXRvIik7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgICAgIHJldHVybiAkaW5wdXQud3JhcCgkd3JhcHBlcikucGFyZW50KCkucHJlcGVuZCh3aXRoSGludCA/ICRoaW50IDogbnVsbCkuYXBwZW5kKCRkcm9wZG93bik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEJhY2tncm91bmRTdHlsZXMoJGVsKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQXR0YWNobWVudDogJGVsLmNzcygiYmFja2dyb3VuZC1hdHRhY2htZW50IiksCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ2xpcDogJGVsLmNzcygiYmFja2dyb3VuZC1jbGlwIiksCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICRlbC5jc3MoImJhY2tncm91bmQtY29sb3IiKSwKICAgICAgICAgICAgICAgIGJhY2tncm91bmRJbWFnZTogJGVsLmNzcygiYmFja2dyb3VuZC1pbWFnZSIpLAogICAgICAgICAgICAgICAgYmFja2dyb3VuZE9yaWdpbjogJGVsLmNzcygiYmFja2dyb3VuZC1vcmlnaW4iKSwKICAgICAgICAgICAgICAgIGJhY2tncm91bmRQb3NpdGlvbjogJGVsLmNzcygiYmFja2dyb3VuZC1wb3NpdGlvbiIpLAogICAgICAgICAgICAgICAgYmFja2dyb3VuZFJlcGVhdDogJGVsLmNzcygiYmFja2dyb3VuZC1yZXBlYXQiKSwKICAgICAgICAgICAgICAgIGJhY2tncm91bmRTaXplOiAkZWwuY3NzKCJiYWNrZ3JvdW5kLXNpemUiKQogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXN0cm95RG9tU3RydWN0dXJlKCRub2RlKSB7CiAgICAgICAgICAgIHZhciAkaW5wdXQgPSAkbm9kZS5maW5kKCIudHQtaW5wdXQiKTsKICAgICAgICAgICAgXy5lYWNoKCRpbnB1dC5kYXRhKGF0dHJzS2V5KSwgZnVuY3Rpb24odmFsLCBrZXkpIHsKICAgICAgICAgICAgICAgIF8uaXNVbmRlZmluZWQodmFsKSA/ICRpbnB1dC5yZW1vdmVBdHRyKGtleSkgOiAkaW5wdXQuYXR0cihrZXksIHZhbCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAkaW5wdXQuZGV0YWNoKCkucmVtb3ZlRGF0YShhdHRyc0tleSkucmVtb3ZlQ2xhc3MoInR0LWlucHV0IikuaW5zZXJ0QWZ0ZXIoJG5vZGUpOwogICAgICAgICAgICAkbm9kZS5yZW1vdmUoKTsKICAgICAgICB9CiAgICB9KCk7CiAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgCiAgICAgICAgdmFyIG9sZCwgdHlwZWFoZWFkS2V5LCBtZXRob2RzOwogICAgICAgIG9sZCA9ICQuZm4udHlwZWFoZWFkOwogICAgICAgIHR5cGVhaGVhZEtleSA9ICJ0dFR5cGVhaGVhZCI7CiAgICAgICAgbWV0aG9kcyA9IHsKICAgICAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gaW5pdGlhbGl6ZShvLCBkYXRhc2V0cykgewogICAgICAgICAgICAgICAgZGF0YXNldHMgPSBfLmlzQXJyYXkoZGF0YXNldHMpID8gZGF0YXNldHMgOiBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgICAgICBvID0gbyB8fCB7fTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goYXR0YWNoKTsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGF0dGFjaCgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgJGlucHV0ID0gJCh0aGlzKSwgZXZlbnRCdXMsIHR5cGVhaGVhZDsKICAgICAgICAgICAgICAgICAgICBfLmVhY2goZGF0YXNldHMsIGZ1bmN0aW9uKGQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZC5oaWdobGlnaHQgPSAhIW8uaGlnaGxpZ2h0OwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHR5cGVhaGVhZCA9IG5ldyBUeXBlYWhlYWQoewogICAgICAgICAgICAgICAgICAgICAgICBpbnB1dDogJGlucHV0LAogICAgICAgICAgICAgICAgICAgICAgICBldmVudEJ1czogZXZlbnRCdXMgPSBuZXcgRXZlbnRCdXMoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWw6ICRpbnB1dAogICAgICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgd2l0aEhpbnQ6IF8uaXNVbmRlZmluZWQoby5oaW50KSA/IHRydWUgOiAhIW8uaGludCwKICAgICAgICAgICAgICAgICAgICAgICAgbWluTGVuZ3RoOiBvLm1pbkxlbmd0aCwKICAgICAgICAgICAgICAgICAgICAgICAgYXV0b3NlbGVjdDogby5hdXRvc2VsZWN0LAogICAgICAgICAgICAgICAgICAgICAgICBkYXRhc2V0czogZGF0YXNldHMKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAkaW5wdXQuZGF0YSh0eXBlYWhlYWRLZXksIHR5cGVhaGVhZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9wZW46IGZ1bmN0aW9uIG9wZW4oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKG9wZW5UeXBlYWhlYWQpOwogICAgICAgICAgICAgICAgZnVuY3Rpb24gb3BlblR5cGVhaGVhZCgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgJGlucHV0ID0gJCh0aGlzKSwgdHlwZWFoZWFkOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlYWhlYWQgPSAkaW5wdXQuZGF0YSh0eXBlYWhlYWRLZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVhaGVhZC5vcGVuKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBjbG9zZTogZnVuY3Rpb24gY2xvc2UoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGNsb3NlVHlwZWFoZWFkKTsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNsb3NlVHlwZWFoZWFkKCkgewogICAgICAgICAgICAgICAgICAgIHZhciAkaW5wdXQgPSAkKHRoaXMpLCB0eXBlYWhlYWQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVhaGVhZCA9ICRpbnB1dC5kYXRhKHR5cGVhaGVhZEtleSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZWFoZWFkLmNsb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB2YWw6IGZ1bmN0aW9uIHZhbChuZXdWYWwpIHsKICAgICAgICAgICAgICAgIHJldHVybiAhYXJndW1lbnRzLmxlbmd0aCA/IGdldFZhbCh0aGlzLmZpcnN0KCkpIDogdGhpcy5lYWNoKHNldFZhbCk7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzZXRWYWwoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyICRpbnB1dCA9ICQodGhpcyksIHR5cGVhaGVhZDsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZWFoZWFkID0gJGlucHV0LmRhdGEodHlwZWFoZWFkS2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICB0eXBlYWhlYWQuc2V0VmFsKG5ld1ZhbCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0VmFsKCRpbnB1dCkgewogICAgICAgICAgICAgICAgICAgIHZhciB0eXBlYWhlYWQsIHF1ZXJ5OwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlYWhlYWQgPSAkaW5wdXQuZGF0YSh0eXBlYWhlYWRLZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXJ5ID0gdHlwZWFoZWFkLmdldFZhbCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gcXVlcnk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKHVuYXR0YWNoKTsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHVuYXR0YWNoKCkgewogICAgICAgICAgICAgICAgICAgIHZhciAkaW5wdXQgPSAkKHRoaXMpLCB0eXBlYWhlYWQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVhaGVhZCA9ICRpbnB1dC5kYXRhKHR5cGVhaGVhZEtleSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZWFoZWFkLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgICAgJGlucHV0LnJlbW92ZURhdGEodHlwZWFoZWFkS2V5KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgICQuZm4udHlwZWFoZWFkID0gZnVuY3Rpb24obWV0aG9kKSB7CiAgICAgICAgICAgIHZhciB0dHM7CiAgICAgICAgICAgIGlmIChtZXRob2RzW21ldGhvZF0gJiYgbWV0aG9kICE9PSAiaW5pdGlhbGl6ZSIpIHsKICAgICAgICAgICAgICAgIHR0cyA9IHRoaXMuZmlsdGVyKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAhISQodGhpcykuZGF0YSh0eXBlYWhlYWRLZXkpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gbWV0aG9kc1ttZXRob2RdLmFwcGx5KHR0cywgW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBtZXRob2RzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgJC5mbi50eXBlYWhlYWQubm9Db25mbGljdCA9IGZ1bmN0aW9uIG5vQ29uZmxpY3QoKSB7CiAgICAgICAgICAgICQuZm4udHlwZWFoZWFkID0gb2xkOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgfSkoKTsKICAgIHJldHVybiB7fTsKfSkpOwoKLy8gVGhpcyBjb2RlIHdhcyB3cml0dGVuIGJ5IFR5bGVyIEFraW5zIGFuZCBoYXMgYmVlbiBwbGFjZWQgaW4gdGhlCi8vIHB1YmxpYyBkb21haW4uICBJdCB3b3VsZCBiZSBuaWNlIGlmIHlvdSBsZWZ0IHRoaXMgaGVhZGVyIGludGFjdC4KLy8gQmFzZTY0IGNvZGUgZnJvbSBUeWxlciBBa2lucyAtLSBodHRwOi8vcnVta2luLmNvbQoKdmFyIEJhc2U2NCA9IChmdW5jdGlvbiAoKSB7CiAgICB2YXIga2V5U3RyID0gIkFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5Ky89IjsKCiAgICB2YXIgb2JqID0gewogICAgICAgIC8qKgogICAgICAgICAqIEVuY29kZXMgYSBzdHJpbmcgaW4gYmFzZTY0CiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGlucHV0IFRoZSBzdHJpbmcgdG8gZW5jb2RlIGluIGJhc2U2NC4KICAgICAgICAgKi8KICAgICAgICBlbmNvZGU6IGZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgICAgICB2YXIgb3V0cHV0ID0gIiI7CiAgICAgICAgICAgIHZhciBjaHIxLCBjaHIyLCBjaHIzOwogICAgICAgICAgICB2YXIgZW5jMSwgZW5jMiwgZW5jMywgZW5jNDsKICAgICAgICAgICAgdmFyIGkgPSAwOwoKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgY2hyMSA9IGlucHV0LmNoYXJDb2RlQXQoaSsrKTsKICAgICAgICAgICAgICAgIGNocjIgPSBpbnB1dC5jaGFyQ29kZUF0KGkrKyk7CiAgICAgICAgICAgICAgICBjaHIzID0gaW5wdXQuY2hhckNvZGVBdChpKyspOwoKICAgICAgICAgICAgICAgIGVuYzEgPSBjaHIxID4+IDI7CiAgICAgICAgICAgICAgICBlbmMyID0gKChjaHIxICYgMykgPDwgNCkgfCAoY2hyMiA+PiA0KTsKICAgICAgICAgICAgICAgIGVuYzMgPSAoKGNocjIgJiAxNSkgPDwgMikgfCAoY2hyMyA+PiA2KTsKICAgICAgICAgICAgICAgIGVuYzQgPSBjaHIzICYgNjM7CgogICAgICAgICAgICAgICAgaWYgKGlzTmFOKGNocjIpKSB7CiAgICAgICAgICAgICAgICAgICAgZW5jMyA9IGVuYzQgPSA2NDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNOYU4oY2hyMykpIHsKICAgICAgICAgICAgICAgICAgICBlbmM0ID0gNjQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgb3V0cHV0ID0gb3V0cHV0ICsga2V5U3RyLmNoYXJBdChlbmMxKSArIGtleVN0ci5jaGFyQXQoZW5jMikgKwogICAgICAgICAgICAgICAgICAgIGtleVN0ci5jaGFyQXQoZW5jMykgKyBrZXlTdHIuY2hhckF0KGVuYzQpOwogICAgICAgICAgICB9IHdoaWxlIChpIDwgaW5wdXQubGVuZ3RoKTsKCiAgICAgICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogRGVjb2RlcyBhIGJhc2U2NCBzdHJpbmcuCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGlucHV0IFRoZSBzdHJpbmcgdG8gZGVjb2RlLgogICAgICAgICAqLwogICAgICAgIGRlY29kZTogZnVuY3Rpb24gKGlucHV0KSB7CiAgICAgICAgICAgIHZhciBvdXRwdXQgPSAiIjsKICAgICAgICAgICAgdmFyIGNocjEsIGNocjIsIGNocjM7CiAgICAgICAgICAgIHZhciBlbmMxLCBlbmMyLCBlbmMzLCBlbmM0OwogICAgICAgICAgICB2YXIgaSA9IDA7CgogICAgICAgICAgICAvLyByZW1vdmUgYWxsIGNoYXJhY3RlcnMgdGhhdCBhcmUgbm90IEEtWiwgYS16LCAwLTksICssIC8sIG9yID0KICAgICAgICAgICAgaW5wdXQgPSBpbnB1dC5yZXBsYWNlKC9bXkEtWmEtejAtOVwrXC9cPV0vZywgIiIpOwoKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgZW5jMSA9IGtleVN0ci5pbmRleE9mKGlucHV0LmNoYXJBdChpKyspKTsKICAgICAgICAgICAgICAgIGVuYzIgPSBrZXlTdHIuaW5kZXhPZihpbnB1dC5jaGFyQXQoaSsrKSk7CiAgICAgICAgICAgICAgICBlbmMzID0ga2V5U3RyLmluZGV4T2YoaW5wdXQuY2hhckF0KGkrKykpOwogICAgICAgICAgICAgICAgZW5jNCA9IGtleVN0ci5pbmRleE9mKGlucHV0LmNoYXJBdChpKyspKTsKCiAgICAgICAgICAgICAgICBjaHIxID0gKGVuYzEgPDwgMikgfCAoZW5jMiA+PiA0KTsKICAgICAgICAgICAgICAgIGNocjIgPSAoKGVuYzIgJiAxNSkgPDwgNCkgfCAoZW5jMyA+PiAyKTsKICAgICAgICAgICAgICAgIGNocjMgPSAoKGVuYzMgJiAzKSA8PCA2KSB8IGVuYzQ7CgogICAgICAgICAgICAgICAgb3V0cHV0ID0gb3V0cHV0ICsgU3RyaW5nLmZyb21DaGFyQ29kZShjaHIxKTsKCiAgICAgICAgICAgICAgICBpZiAoZW5jMyAhPSA2NCkgewogICAgICAgICAgICAgICAgICAgIG91dHB1dCA9IG91dHB1dCArIFN0cmluZy5mcm9tQ2hhckNvZGUoY2hyMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZW5jNCAhPSA2NCkgewogICAgICAgICAgICAgICAgICAgIG91dHB1dCA9IG91dHB1dCArIFN0cmluZy5mcm9tQ2hhckNvZGUoY2hyMyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gd2hpbGUgKGkgPCBpbnB1dC5sZW5ndGgpOwoKICAgICAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgICAgICB9CiAgICB9OwoKICAgIHJldHVybiBvYmo7Cn0pKCk7CgovKgogKiBBIEphdmFTY3JpcHQgaW1wbGVtZW50YXRpb24gb2YgdGhlIFNlY3VyZSBIYXNoIEFsZ29yaXRobSwgU0hBLTEsIGFzIGRlZmluZWQKICogaW4gRklQUyBQVUIgMTgwLTEKICogVmVyc2lvbiAyLjFhIENvcHlyaWdodCBQYXVsIEpvaG5zdG9uIDIwMDAgLSAyMDAyLgogKiBPdGhlciBjb250cmlidXRvcnM6IEdyZWcgSG9sdCwgQW5kcmV3IEtlcGVydCwgWWRuYXIsIExvc3RpbmV0CiAqIERpc3RyaWJ1dGVkIHVuZGVyIHRoZSBCU0QgTGljZW5zZQogKiBTZWUgaHR0cDovL3BhamhvbWUub3JnLnVrL2NyeXB0L21kNSBmb3IgZGV0YWlscy4KICovCgovKiBTb21lIGZ1bmN0aW9ucyBhbmQgdmFyaWFibGVzIGhhdmUgYmVlbiBzdHJpcHBlZCBmb3IgdXNlIHdpdGggU3Ryb3BoZSAqLwoKLyoKICogVGhlc2UgYXJlIHRoZSBmdW5jdGlvbnMgeW91J2xsIHVzdWFsbHkgd2FudCB0byBjYWxsCiAqIFRoZXkgdGFrZSBzdHJpbmcgYXJndW1lbnRzIGFuZCByZXR1cm4gZWl0aGVyIGhleCBvciBiYXNlLTY0IGVuY29kZWQgc3RyaW5ncwogKi8KZnVuY3Rpb24gYjY0X3NoYTEocyl7cmV0dXJuIGJpbmIyYjY0KGNvcmVfc2hhMShzdHIyYmluYihzKSxzLmxlbmd0aCAqIDgpKTt9CmZ1bmN0aW9uIHN0cl9zaGExKHMpe3JldHVybiBiaW5iMnN0cihjb3JlX3NoYTEoc3RyMmJpbmIocykscy5sZW5ndGggKiA4KSk7fQpmdW5jdGlvbiBiNjRfaG1hY19zaGExKGtleSwgZGF0YSl7IHJldHVybiBiaW5iMmI2NChjb3JlX2htYWNfc2hhMShrZXksIGRhdGEpKTt9CmZ1bmN0aW9uIHN0cl9obWFjX3NoYTEoa2V5LCBkYXRhKXsgcmV0dXJuIGJpbmIyc3RyKGNvcmVfaG1hY19zaGExKGtleSwgZGF0YSkpO30KCi8qCiAqIENhbGN1bGF0ZSB0aGUgU0hBLTEgb2YgYW4gYXJyYXkgb2YgYmlnLWVuZGlhbiB3b3JkcywgYW5kIGEgYml0IGxlbmd0aAogKi8KZnVuY3Rpb24gY29yZV9zaGExKHgsIGxlbikKewogIC8qIGFwcGVuZCBwYWRkaW5nICovCiAgeFtsZW4gPj4gNV0gfD0gMHg4MCA8PCAoMjQgLSBsZW4gJSAzMik7CiAgeFsoKGxlbiArIDY0ID4+IDkpIDw8IDQpICsgMTVdID0gbGVuOwoKICB2YXIgdyA9IG5ldyBBcnJheSg4MCk7CiAgdmFyIGEgPSAgMTczMjU4NDE5MzsKICB2YXIgYiA9IC0yNzE3MzM4Nzk7CiAgdmFyIGMgPSAtMTczMjU4NDE5NDsKICB2YXIgZCA9ICAyNzE3MzM4Nzg7CiAgdmFyIGUgPSAtMTAwOTU4OTc3NjsKCiAgdmFyIGksIGosIHQsIG9sZGEsIG9sZGIsIG9sZGMsIG9sZGQsIG9sZGU7CiAgZm9yIChpID0gMDsgaSA8IHgubGVuZ3RoOyBpICs9IDE2KQogIHsKICAgIG9sZGEgPSBhOwogICAgb2xkYiA9IGI7CiAgICBvbGRjID0gYzsKICAgIG9sZGQgPSBkOwogICAgb2xkZSA9IGU7CgogICAgZm9yIChqID0gMDsgaiA8IDgwOyBqKyspCiAgICB7CiAgICAgIGlmIChqIDwgMTYpIHsgd1tqXSA9IHhbaSArIGpdOyB9CiAgICAgIGVsc2UgeyB3W2pdID0gcm9sKHdbai0zXSBeIHdbai04XSBeIHdbai0xNF0gXiB3W2otMTZdLCAxKTsgfQogICAgICB0ID0gc2FmZV9hZGQoc2FmZV9hZGQocm9sKGEsIDUpLCBzaGExX2Z0KGosIGIsIGMsIGQpKSwKICAgICAgICAgICAgICAgICAgICAgICBzYWZlX2FkZChzYWZlX2FkZChlLCB3W2pdKSwgc2hhMV9rdChqKSkpOwogICAgICBlID0gZDsKICAgICAgZCA9IGM7CiAgICAgIGMgPSByb2woYiwgMzApOwogICAgICBiID0gYTsKICAgICAgYSA9IHQ7CiAgICB9CgogICAgYSA9IHNhZmVfYWRkKGEsIG9sZGEpOwogICAgYiA9IHNhZmVfYWRkKGIsIG9sZGIpOwogICAgYyA9IHNhZmVfYWRkKGMsIG9sZGMpOwogICAgZCA9IHNhZmVfYWRkKGQsIG9sZGQpOwogICAgZSA9IHNhZmVfYWRkKGUsIG9sZGUpOwogIH0KICByZXR1cm4gW2EsIGIsIGMsIGQsIGVdOwp9CgovKgogKiBQZXJmb3JtIHRoZSBhcHByb3ByaWF0ZSB0cmlwbGV0IGNvbWJpbmF0aW9uIGZ1bmN0aW9uIGZvciB0aGUgY3VycmVudAogKiBpdGVyYXRpb24KICovCmZ1bmN0aW9uIHNoYTFfZnQodCwgYiwgYywgZCkKewogIGlmICh0IDwgMjApIHsgcmV0dXJuIChiICYgYykgfCAoKH5iKSAmIGQpOyB9CiAgaWYgKHQgPCA0MCkgeyByZXR1cm4gYiBeIGMgXiBkOyB9CiAgaWYgKHQgPCA2MCkgeyByZXR1cm4gKGIgJiBjKSB8IChiICYgZCkgfCAoYyAmIGQpOyB9CiAgcmV0dXJuIGIgXiBjIF4gZDsKfQoKLyoKICogRGV0ZXJtaW5lIHRoZSBhcHByb3ByaWF0ZSBhZGRpdGl2ZSBjb25zdGFudCBmb3IgdGhlIGN1cnJlbnQgaXRlcmF0aW9uCiAqLwpmdW5jdGlvbiBzaGExX2t0KHQpCnsKICByZXR1cm4gKHQgPCAyMCkgPyAgMTUxODUwMDI0OSA6ICh0IDwgNDApID8gIDE4NTk3NzUzOTMgOgogICAgICAgICAodCA8IDYwKSA/IC0xODk0MDA3NTg4IDogLTg5OTQ5NzUxNDsKfQoKLyoKICogQ2FsY3VsYXRlIHRoZSBITUFDLVNIQTEgb2YgYSBrZXkgYW5kIHNvbWUgZGF0YQogKi8KZnVuY3Rpb24gY29yZV9obWFjX3NoYTEoa2V5LCBkYXRhKQp7CiAgdmFyIGJrZXkgPSBzdHIyYmluYihrZXkpOwogIGlmIChia2V5Lmxlbmd0aCA+IDE2KSB7IGJrZXkgPSBjb3JlX3NoYTEoYmtleSwga2V5Lmxlbmd0aCAqIDgpOyB9CgogIHZhciBpcGFkID0gbmV3IEFycmF5KDE2KSwgb3BhZCA9IG5ldyBBcnJheSgxNik7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCAxNjsgaSsrKQogIHsKICAgIGlwYWRbaV0gPSBia2V5W2ldIF4gMHgzNjM2MzYzNjsKICAgIG9wYWRbaV0gPSBia2V5W2ldIF4gMHg1QzVDNUM1QzsKICB9CgogIHZhciBoYXNoID0gY29yZV9zaGExKGlwYWQuY29uY2F0KHN0cjJiaW5iKGRhdGEpKSwgNTEyICsgZGF0YS5sZW5ndGggKiA4KTsKICByZXR1cm4gY29yZV9zaGExKG9wYWQuY29uY2F0KGhhc2gpLCA1MTIgKyAxNjApOwp9CgovKgogKiBBZGQgaW50ZWdlcnMsIHdyYXBwaW5nIGF0IDJeMzIuIFRoaXMgdXNlcyAxNi1iaXQgb3BlcmF0aW9ucyBpbnRlcm5hbGx5CiAqIHRvIHdvcmsgYXJvdW5kIGJ1Z3MgaW4gc29tZSBKUyBpbnRlcnByZXRlcnMuCiAqLwpmdW5jdGlvbiBzYWZlX2FkZCh4LCB5KQp7CiAgdmFyIGxzdyA9ICh4ICYgMHhGRkZGKSArICh5ICYgMHhGRkZGKTsKICB2YXIgbXN3ID0gKHggPj4gMTYpICsgKHkgPj4gMTYpICsgKGxzdyA+PiAxNik7CiAgcmV0dXJuIChtc3cgPDwgMTYpIHwgKGxzdyAmIDB4RkZGRik7Cn0KCi8qCiAqIEJpdHdpc2Ugcm90YXRlIGEgMzItYml0IG51bWJlciB0byB0aGUgbGVmdC4KICovCmZ1bmN0aW9uIHJvbChudW0sIGNudCkKewogIHJldHVybiAobnVtIDw8IGNudCkgfCAobnVtID4+PiAoMzIgLSBjbnQpKTsKfQoKLyoKICogQ29udmVydCBhbiA4LWJpdCBvciAxNi1iaXQgc3RyaW5nIHRvIGFuIGFycmF5IG9mIGJpZy1lbmRpYW4gd29yZHMKICogSW4gOC1iaXQgZnVuY3Rpb24sIGNoYXJhY3RlcnMgPjI1NSBoYXZlIHRoZWlyIGhpLWJ5dGUgc2lsZW50bHkgaWdub3JlZC4KICovCmZ1bmN0aW9uIHN0cjJiaW5iKHN0cikKewogIHZhciBiaW4gPSBbXTsKICB2YXIgbWFzayA9IDI1NTsKICBmb3IgKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGggKiA4OyBpICs9IDgpCiAgewogICAgYmluW2k+PjVdIHw9IChzdHIuY2hhckNvZGVBdChpIC8gOCkgJiBtYXNrKSA8PCAoMjQgLSBpJTMyKTsKICB9CiAgcmV0dXJuIGJpbjsKfQoKLyoKICogQ29udmVydCBhbiBhcnJheSBvZiBiaWctZW5kaWFuIHdvcmRzIHRvIGEgc3RyaW5nCiAqLwpmdW5jdGlvbiBiaW5iMnN0cihiaW4pCnsKICB2YXIgc3RyID0gIiI7CiAgdmFyIG1hc2sgPSAyNTU7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBiaW4ubGVuZ3RoICogMzI7IGkgKz0gOCkKICB7CiAgICBzdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoYmluW2k+PjVdID4+PiAoMjQgLSBpJTMyKSkgJiBtYXNrKTsKICB9CiAgcmV0dXJuIHN0cjsKfQoKLyoKICogQ29udmVydCBhbiBhcnJheSBvZiBiaWctZW5kaWFuIHdvcmRzIHRvIGEgYmFzZS02NCBzdHJpbmcKICovCmZ1bmN0aW9uIGJpbmIyYjY0KGJpbmFycmF5KQp7CiAgdmFyIHRhYiA9ICJBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWmFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6MDEyMzQ1Njc4OSsvIjsKICB2YXIgc3RyID0gIiI7CiAgdmFyIHRyaXBsZXQsIGo7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBiaW5hcnJheS5sZW5ndGggKiA0OyBpICs9IDMpCiAgewogICAgdHJpcGxldCA9ICgoKGJpbmFycmF5W2kgICA+PiAyXSA+PiA4ICogKDMgLSAgaSAgICU0KSkgJiAweEZGKSA8PCAxNikgfAogICAgICAgICAgICAgICgoKGJpbmFycmF5W2krMSA+PiAyXSA+PiA4ICogKDMgLSAoaSsxKSU0KSkgJiAweEZGKSA8PCA4ICkgfAogICAgICAgICAgICAgICAoKGJpbmFycmF5W2krMiA+PiAyXSA+PiA4ICogKDMgLSAoaSsyKSU0KSkgJiAweEZGKTsKICAgIGZvciAoaiA9IDA7IGogPCA0OyBqKyspCiAgICB7CiAgICAgIGlmIChpICogOCArIGogKiA2ID4gYmluYXJyYXkubGVuZ3RoICogMzIpIHsgc3RyICs9ICI9IjsgfQogICAgICBlbHNlIHsgc3RyICs9IHRhYi5jaGFyQXQoKHRyaXBsZXQgPj4gNiooMy1qKSkgJiAweDNGKTsgfQogICAgfQogIH0KICByZXR1cm4gc3RyOwp9CgovKgogKiBBIEphdmFTY3JpcHQgaW1wbGVtZW50YXRpb24gb2YgdGhlIFJTQSBEYXRhIFNlY3VyaXR5LCBJbmMuIE1ENSBNZXNzYWdlCiAqIERpZ2VzdCBBbGdvcml0aG0sIGFzIGRlZmluZWQgaW4gUkZDIDEzMjEuCiAqIFZlcnNpb24gMi4xIENvcHlyaWdodCAoQykgUGF1bCBKb2huc3RvbiAxOTk5IC0gMjAwMi4KICogT3RoZXIgY29udHJpYnV0b3JzOiBHcmVnIEhvbHQsIEFuZHJldyBLZXBlcnQsIFlkbmFyLCBMb3N0aW5ldAogKiBEaXN0cmlidXRlZCB1bmRlciB0aGUgQlNEIExpY2Vuc2UKICogU2VlIGh0dHA6Ly9wYWpob21lLm9yZy51ay9jcnlwdC9tZDUgZm9yIG1vcmUgaW5mby4KICovCgovKgogKiBFdmVyeXRoaW5nIHRoYXQgaXNuJ3QgdXNlZCBieSBTdHJvcGhlIGhhcyBiZWVuIHN0cmlwcGVkIGhlcmUhCiAqLwoKdmFyIE1ENSA9IChmdW5jdGlvbiAoKSB7CiAgICAvKgogICAgICogQWRkIGludGVnZXJzLCB3cmFwcGluZyBhdCAyXjMyLiBUaGlzIHVzZXMgMTYtYml0IG9wZXJhdGlvbnMgaW50ZXJuYWxseQogICAgICogdG8gd29yayBhcm91bmQgYnVncyBpbiBzb21lIEpTIGludGVycHJldGVycy4KICAgICAqLwogICAgdmFyIHNhZmVfYWRkID0gZnVuY3Rpb24gKHgsIHkpIHsKICAgICAgICB2YXIgbHN3ID0gKHggJiAweEZGRkYpICsgKHkgJiAweEZGRkYpOwogICAgICAgIHZhciBtc3cgPSAoeCA+PiAxNikgKyAoeSA+PiAxNikgKyAobHN3ID4+IDE2KTsKICAgICAgICByZXR1cm4gKG1zdyA8PCAxNikgfCAobHN3ICYgMHhGRkZGKTsKICAgIH07CgogICAgLyoKICAgICAqIEJpdHdpc2Ugcm90YXRlIGEgMzItYml0IG51bWJlciB0byB0aGUgbGVmdC4KICAgICAqLwogICAgdmFyIGJpdF9yb2wgPSBmdW5jdGlvbiAobnVtLCBjbnQpIHsKICAgICAgICByZXR1cm4gKG51bSA8PCBjbnQpIHwgKG51bSA+Pj4gKDMyIC0gY250KSk7CiAgICB9OwoKICAgIC8qCiAgICAgKiBDb252ZXJ0IGEgc3RyaW5nIHRvIGFuIGFycmF5IG9mIGxpdHRsZS1lbmRpYW4gd29yZHMKICAgICAqLwogICAgdmFyIHN0cjJiaW5sID0gZnVuY3Rpb24gKHN0cikgewogICAgICAgIHZhciBiaW4gPSBbXTsKICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aCAqIDg7IGkgKz0gOCkKICAgICAgICB7CiAgICAgICAgICAgIGJpbltpPj41XSB8PSAoc3RyLmNoYXJDb2RlQXQoaSAvIDgpICYgMjU1KSA8PCAoaSUzMik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBiaW47CiAgICB9OwoKICAgIC8qCiAgICAgKiBDb252ZXJ0IGFuIGFycmF5IG9mIGxpdHRsZS1lbmRpYW4gd29yZHMgdG8gYSBzdHJpbmcKICAgICAqLwogICAgdmFyIGJpbmwyc3RyID0gZnVuY3Rpb24gKGJpbikgewogICAgICAgIHZhciBzdHIgPSAiIjsKICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgYmluLmxlbmd0aCAqIDMyOyBpICs9IDgpCiAgICAgICAgewogICAgICAgICAgICBzdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoYmluW2k+PjVdID4+PiAoaSAlIDMyKSkgJiAyNTUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyOwogICAgfTsKCiAgICAvKgogICAgICogQ29udmVydCBhbiBhcnJheSBvZiBsaXR0bGUtZW5kaWFuIHdvcmRzIHRvIGEgaGV4IHN0cmluZy4KICAgICAqLwogICAgdmFyIGJpbmwyaGV4ID0gZnVuY3Rpb24gKGJpbmFycmF5KSB7CiAgICAgICAgdmFyIGhleF90YWIgPSAiMDEyMzQ1Njc4OWFiY2RlZiI7CiAgICAgICAgdmFyIHN0ciA9ICIiOwogICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBiaW5hcnJheS5sZW5ndGggKiA0OyBpKyspCiAgICAgICAgewogICAgICAgICAgICBzdHIgKz0gaGV4X3RhYi5jaGFyQXQoKGJpbmFycmF5W2k+PjJdID4+ICgoaSU0KSo4KzQpKSAmIDB4RikgKwogICAgICAgICAgICAgICAgaGV4X3RhYi5jaGFyQXQoKGJpbmFycmF5W2k+PjJdID4+ICgoaSU0KSo4ICApKSAmIDB4Rik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdHI7CiAgICB9OwoKICAgIC8qCiAgICAgKiBUaGVzZSBmdW5jdGlvbnMgaW1wbGVtZW50IHRoZSBmb3VyIGJhc2ljIG9wZXJhdGlvbnMgdGhlIGFsZ29yaXRobSB1c2VzLgogICAgICovCiAgICB2YXIgbWQ1X2NtbiA9IGZ1bmN0aW9uIChxLCBhLCBiLCB4LCBzLCB0KSB7CiAgICAgICAgcmV0dXJuIHNhZmVfYWRkKGJpdF9yb2woc2FmZV9hZGQoc2FmZV9hZGQoYSwgcSksc2FmZV9hZGQoeCwgdCkpLCBzKSxiKTsKICAgIH07CgogICAgdmFyIG1kNV9mZiA9IGZ1bmN0aW9uIChhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICAgICAgcmV0dXJuIG1kNV9jbW4oKGIgJiBjKSB8ICgofmIpICYgZCksIGEsIGIsIHgsIHMsIHQpOwogICAgfTsKCiAgICB2YXIgbWQ1X2dnID0gZnVuY3Rpb24gKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICAgICAgICByZXR1cm4gbWQ1X2NtbigoYiAmIGQpIHwgKGMgJiAofmQpKSwgYSwgYiwgeCwgcywgdCk7CiAgICB9OwoKICAgIHZhciBtZDVfaGggPSBmdW5jdGlvbiAoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgICAgIHJldHVybiBtZDVfY21uKGIgXiBjIF4gZCwgYSwgYiwgeCwgcywgdCk7CiAgICB9OwoKICAgIHZhciBtZDVfaWkgPSBmdW5jdGlvbiAoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgICAgIHJldHVybiBtZDVfY21uKGMgXiAoYiB8ICh+ZCkpLCBhLCBiLCB4LCBzLCB0KTsKICAgIH07CgogICAgLyoKICAgICAqIENhbGN1bGF0ZSB0aGUgTUQ1IG9mIGFuIGFycmF5IG9mIGxpdHRsZS1lbmRpYW4gd29yZHMsIGFuZCBhIGJpdCBsZW5ndGgKICAgICAqLwogICAgdmFyIGNvcmVfbWQ1ID0gZnVuY3Rpb24gKHgsIGxlbikgewogICAgICAgIC8qIGFwcGVuZCBwYWRkaW5nICovCiAgICAgICAgeFtsZW4gPj4gNV0gfD0gMHg4MCA8PCAoKGxlbikgJSAzMik7CiAgICAgICAgeFsoKChsZW4gKyA2NCkgPj4+IDkpIDw8IDQpICsgMTRdID0gbGVuOwoKICAgICAgICB2YXIgYSA9ICAxNzMyNTg0MTkzOwogICAgICAgIHZhciBiID0gLTI3MTczMzg3OTsKICAgICAgICB2YXIgYyA9IC0xNzMyNTg0MTk0OwogICAgICAgIHZhciBkID0gIDI3MTczMzg3ODsKCiAgICAgICAgdmFyIG9sZGEsIG9sZGIsIG9sZGMsIG9sZGQ7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB4Lmxlbmd0aDsgaSArPSAxNikKICAgICAgICB7CiAgICAgICAgICAgIG9sZGEgPSBhOwogICAgICAgICAgICBvbGRiID0gYjsKICAgICAgICAgICAgb2xkYyA9IGM7CiAgICAgICAgICAgIG9sZGQgPSBkOwoKICAgICAgICAgICAgYSA9IG1kNV9mZihhLCBiLCBjLCBkLCB4W2krIDBdLCA3ICwgLTY4MDg3NjkzNik7CiAgICAgICAgICAgIGQgPSBtZDVfZmYoZCwgYSwgYiwgYywgeFtpKyAxXSwgMTIsIC0zODk1NjQ1ODYpOwogICAgICAgICAgICBjID0gbWQ1X2ZmKGMsIGQsIGEsIGIsIHhbaSsgMl0sIDE3LCAgNjA2MTA1ODE5KTsKICAgICAgICAgICAgYiA9IG1kNV9mZihiLCBjLCBkLCBhLCB4W2krIDNdLCAyMiwgLTEwNDQ1MjUzMzApOwogICAgICAgICAgICBhID0gbWQ1X2ZmKGEsIGIsIGMsIGQsIHhbaSsgNF0sIDcgLCAtMTc2NDE4ODk3KTsKICAgICAgICAgICAgZCA9IG1kNV9mZihkLCBhLCBiLCBjLCB4W2krIDVdLCAxMiwgIDEyMDAwODA0MjYpOwogICAgICAgICAgICBjID0gbWQ1X2ZmKGMsIGQsIGEsIGIsIHhbaSsgNl0sIDE3LCAtMTQ3MzIzMTM0MSk7CiAgICAgICAgICAgIGIgPSBtZDVfZmYoYiwgYywgZCwgYSwgeFtpKyA3XSwgMjIsIC00NTcwNTk4Myk7CiAgICAgICAgICAgIGEgPSBtZDVfZmYoYSwgYiwgYywgZCwgeFtpKyA4XSwgNyAsICAxNzcwMDM1NDE2KTsKICAgICAgICAgICAgZCA9IG1kNV9mZihkLCBhLCBiLCBjLCB4W2krIDldLCAxMiwgLTE5NTg0MTQ0MTcpOwogICAgICAgICAgICBjID0gbWQ1X2ZmKGMsIGQsIGEsIGIsIHhbaSsxMF0sIDE3LCAtNDIwNjMpOwogICAgICAgICAgICBiID0gbWQ1X2ZmKGIsIGMsIGQsIGEsIHhbaSsxMV0sIDIyLCAtMTk5MDQwNDE2Mik7CiAgICAgICAgICAgIGEgPSBtZDVfZmYoYSwgYiwgYywgZCwgeFtpKzEyXSwgNyAsICAxODA0NjAzNjgyKTsKICAgICAgICAgICAgZCA9IG1kNV9mZihkLCBhLCBiLCBjLCB4W2krMTNdLCAxMiwgLTQwMzQxMTAxKTsKICAgICAgICAgICAgYyA9IG1kNV9mZihjLCBkLCBhLCBiLCB4W2krMTRdLCAxNywgLTE1MDIwMDIyOTApOwogICAgICAgICAgICBiID0gbWQ1X2ZmKGIsIGMsIGQsIGEsIHhbaSsxNV0sIDIyLCAgMTIzNjUzNTMyOSk7CgogICAgICAgICAgICBhID0gbWQ1X2dnKGEsIGIsIGMsIGQsIHhbaSsgMV0sIDUgLCAtMTY1Nzk2NTEwKTsKICAgICAgICAgICAgZCA9IG1kNV9nZyhkLCBhLCBiLCBjLCB4W2krIDZdLCA5ICwgLTEwNjk1MDE2MzIpOwogICAgICAgICAgICBjID0gbWQ1X2dnKGMsIGQsIGEsIGIsIHhbaSsxMV0sIDE0LCAgNjQzNzE3NzEzKTsKICAgICAgICAgICAgYiA9IG1kNV9nZyhiLCBjLCBkLCBhLCB4W2krIDBdLCAyMCwgLTM3Mzg5NzMwMik7CiAgICAgICAgICAgIGEgPSBtZDVfZ2coYSwgYiwgYywgZCwgeFtpKyA1XSwgNSAsIC03MDE1NTg2OTEpOwogICAgICAgICAgICBkID0gbWQ1X2dnKGQsIGEsIGIsIGMsIHhbaSsxMF0sIDkgLCAgMzgwMTYwODMpOwogICAgICAgICAgICBjID0gbWQ1X2dnKGMsIGQsIGEsIGIsIHhbaSsxNV0sIDE0LCAtNjYwNDc4MzM1KTsKICAgICAgICAgICAgYiA9IG1kNV9nZyhiLCBjLCBkLCBhLCB4W2krIDRdLCAyMCwgLTQwNTUzNzg0OCk7CiAgICAgICAgICAgIGEgPSBtZDVfZ2coYSwgYiwgYywgZCwgeFtpKyA5XSwgNSAsICA1Njg0NDY0MzgpOwogICAgICAgICAgICBkID0gbWQ1X2dnKGQsIGEsIGIsIGMsIHhbaSsxNF0sIDkgLCAtMTAxOTgwMzY5MCk7CiAgICAgICAgICAgIGMgPSBtZDVfZ2coYywgZCwgYSwgYiwgeFtpKyAzXSwgMTQsIC0xODczNjM5NjEpOwogICAgICAgICAgICBiID0gbWQ1X2dnKGIsIGMsIGQsIGEsIHhbaSsgOF0sIDIwLCAgMTE2MzUzMTUwMSk7CiAgICAgICAgICAgIGEgPSBtZDVfZ2coYSwgYiwgYywgZCwgeFtpKzEzXSwgNSAsIC0xNDQ0NjgxNDY3KTsKICAgICAgICAgICAgZCA9IG1kNV9nZyhkLCBhLCBiLCBjLCB4W2krIDJdLCA5ICwgLTUxNDAzNzg0KTsKICAgICAgICAgICAgYyA9IG1kNV9nZyhjLCBkLCBhLCBiLCB4W2krIDddLCAxNCwgIDE3MzUzMjg0NzMpOwogICAgICAgICAgICBiID0gbWQ1X2dnKGIsIGMsIGQsIGEsIHhbaSsxMl0sIDIwLCAtMTkyNjYwNzczNCk7CgogICAgICAgICAgICBhID0gbWQ1X2hoKGEsIGIsIGMsIGQsIHhbaSsgNV0sIDQgLCAtMzc4NTU4KTsKICAgICAgICAgICAgZCA9IG1kNV9oaChkLCBhLCBiLCBjLCB4W2krIDhdLCAxMSwgLTIwMjI1NzQ0NjMpOwogICAgICAgICAgICBjID0gbWQ1X2hoKGMsIGQsIGEsIGIsIHhbaSsxMV0sIDE2LCAgMTgzOTAzMDU2Mik7CiAgICAgICAgICAgIGIgPSBtZDVfaGgoYiwgYywgZCwgYSwgeFtpKzE0XSwgMjMsIC0zNTMwOTU1Nik7CiAgICAgICAgICAgIGEgPSBtZDVfaGgoYSwgYiwgYywgZCwgeFtpKyAxXSwgNCAsIC0xNTMwOTkyMDYwKTsKICAgICAgICAgICAgZCA9IG1kNV9oaChkLCBhLCBiLCBjLCB4W2krIDRdLCAxMSwgIDEyNzI4OTMzNTMpOwogICAgICAgICAgICBjID0gbWQ1X2hoKGMsIGQsIGEsIGIsIHhbaSsgN10sIDE2LCAtMTU1NDk3NjMyKTsKICAgICAgICAgICAgYiA9IG1kNV9oaChiLCBjLCBkLCBhLCB4W2krMTBdLCAyMywgLTEwOTQ3MzA2NDApOwogICAgICAgICAgICBhID0gbWQ1X2hoKGEsIGIsIGMsIGQsIHhbaSsxM10sIDQgLCAgNjgxMjc5MTc0KTsKICAgICAgICAgICAgZCA9IG1kNV9oaChkLCBhLCBiLCBjLCB4W2krIDBdLCAxMSwgLTM1ODUzNzIyMik7CiAgICAgICAgICAgIGMgPSBtZDVfaGgoYywgZCwgYSwgYiwgeFtpKyAzXSwgMTYsIC03MjI1MjE5NzkpOwogICAgICAgICAgICBiID0gbWQ1X2hoKGIsIGMsIGQsIGEsIHhbaSsgNl0sIDIzLCAgNzYwMjkxODkpOwogICAgICAgICAgICBhID0gbWQ1X2hoKGEsIGIsIGMsIGQsIHhbaSsgOV0sIDQgLCAtNjQwMzY0NDg3KTsKICAgICAgICAgICAgZCA9IG1kNV9oaChkLCBhLCBiLCBjLCB4W2krMTJdLCAxMSwgLTQyMTgxNTgzNSk7CiAgICAgICAgICAgIGMgPSBtZDVfaGgoYywgZCwgYSwgYiwgeFtpKzE1XSwgMTYsICA1MzA3NDI1MjApOwogICAgICAgICAgICBiID0gbWQ1X2hoKGIsIGMsIGQsIGEsIHhbaSsgMl0sIDIzLCAtOTk1MzM4NjUxKTsKCiAgICAgICAgICAgIGEgPSBtZDVfaWkoYSwgYiwgYywgZCwgeFtpKyAwXSwgNiAsIC0xOTg2MzA4NDQpOwogICAgICAgICAgICBkID0gbWQ1X2lpKGQsIGEsIGIsIGMsIHhbaSsgN10sIDEwLCAgMTEyNjg5MTQxNSk7CiAgICAgICAgICAgIGMgPSBtZDVfaWkoYywgZCwgYSwgYiwgeFtpKzE0XSwgMTUsIC0xNDE2MzU0OTA1KTsKICAgICAgICAgICAgYiA9IG1kNV9paShiLCBjLCBkLCBhLCB4W2krIDVdLCAyMSwgLTU3NDM0MDU1KTsKICAgICAgICAgICAgYSA9IG1kNV9paShhLCBiLCBjLCBkLCB4W2krMTJdLCA2ICwgIDE3MDA0ODU1NzEpOwogICAgICAgICAgICBkID0gbWQ1X2lpKGQsIGEsIGIsIGMsIHhbaSsgM10sIDEwLCAtMTg5NDk4NjYwNik7CiAgICAgICAgICAgIGMgPSBtZDVfaWkoYywgZCwgYSwgYiwgeFtpKzEwXSwgMTUsIC0xMDUxNTIzKTsKICAgICAgICAgICAgYiA9IG1kNV9paShiLCBjLCBkLCBhLCB4W2krIDFdLCAyMSwgLTIwNTQ5MjI3OTkpOwogICAgICAgICAgICBhID0gbWQ1X2lpKGEsIGIsIGMsIGQsIHhbaSsgOF0sIDYgLCAgMTg3MzMxMzM1OSk7CiAgICAgICAgICAgIGQgPSBtZDVfaWkoZCwgYSwgYiwgYywgeFtpKzE1XSwgMTAsIC0zMDYxMTc0NCk7CiAgICAgICAgICAgIGMgPSBtZDVfaWkoYywgZCwgYSwgYiwgeFtpKyA2XSwgMTUsIC0xNTYwMTk4MzgwKTsKICAgICAgICAgICAgYiA9IG1kNV9paShiLCBjLCBkLCBhLCB4W2krMTNdLCAyMSwgIDEzMDkxNTE2NDkpOwogICAgICAgICAgICBhID0gbWQ1X2lpKGEsIGIsIGMsIGQsIHhbaSsgNF0sIDYgLCAtMTQ1NTIzMDcwKTsKICAgICAgICAgICAgZCA9IG1kNV9paShkLCBhLCBiLCBjLCB4W2krMTFdLCAxMCwgLTExMjAyMTAzNzkpOwogICAgICAgICAgICBjID0gbWQ1X2lpKGMsIGQsIGEsIGIsIHhbaSsgMl0sIDE1LCAgNzE4Nzg3MjU5KTsKICAgICAgICAgICAgYiA9IG1kNV9paShiLCBjLCBkLCBhLCB4W2krIDldLCAyMSwgLTM0MzQ4NTU1MSk7CgogICAgICAgICAgICBhID0gc2FmZV9hZGQoYSwgb2xkYSk7CiAgICAgICAgICAgIGIgPSBzYWZlX2FkZChiLCBvbGRiKTsKICAgICAgICAgICAgYyA9IHNhZmVfYWRkKGMsIG9sZGMpOwogICAgICAgICAgICBkID0gc2FmZV9hZGQoZCwgb2xkZCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBbYSwgYiwgYywgZF07CiAgICB9OwoKCiAgICB2YXIgb2JqID0gewogICAgICAgIC8qCiAgICAgICAgICogVGhlc2UgYXJlIHRoZSBmdW5jdGlvbnMgeW91J2xsIHVzdWFsbHkgd2FudCB0byBjYWxsLgogICAgICAgICAqIFRoZXkgdGFrZSBzdHJpbmcgYXJndW1lbnRzIGFuZCByZXR1cm4gZWl0aGVyIGhleCBvciBiYXNlLTY0IGVuY29kZWQKICAgICAgICAgKiBzdHJpbmdzLgogICAgICAgICAqLwogICAgICAgIGhleGRpZ2VzdDogZnVuY3Rpb24gKHMpIHsKICAgICAgICAgICAgcmV0dXJuIGJpbmwyaGV4KGNvcmVfbWQ1KHN0cjJiaW5sKHMpLCBzLmxlbmd0aCAqIDgpKTsKICAgICAgICB9LAoKICAgICAgICBoYXNoOiBmdW5jdGlvbiAocykgewogICAgICAgICAgICByZXR1cm4gYmlubDJzdHIoY29yZV9tZDUoc3RyMmJpbmwocyksIHMubGVuZ3RoICogOCkpOwogICAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIG9iajsKfSkoKTsKCi8qCiAgICBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBNSVQgbGljZW5zZS4KICAgIFBsZWFzZSBzZWUgdGhlIExJQ0VOU0UgZmlsZSBmb3IgZGV0YWlscy4KCiAgICBDb3B5cmlnaHQgMjAwNi0yMDA4LCBPR0csIExMQwoqLwoKLyoganNoaW50IHVuZGVmOiB0cnVlLCB1bnVzZWQ6IHRydWU6LCBub2FyZzogdHJ1ZSwgbGF0ZWRlZjogdHJ1ZSAqLwovKmdsb2JhbCBkb2N1bWVudCwgd2luZG93LCBzZXRUaW1lb3V0LCBjbGVhclRpbWVvdXQsIGNvbnNvbGUsCiAgICBBY3RpdmVYT2JqZWN0LCBCYXNlNjQsIE1ENSwgRE9NUGFyc2VyICovCi8vIGZyb20gc2hhMS5qcwovKmdsb2JhbCBjb3JlX2htYWNfc2hhMSwgYmluYjJzdHIsIHN0cl9obWFjX3NoYTEsIHN0cl9zaGExLCBiNjRfaG1hY19zaGExKi8KCi8qKiBGaWxlOiBzdHJvcGhlLmpzCiAqICBBIEphdmFTY3JpcHQgbGlicmFyeSBmb3IgWE1QUCBCT1NIL1hNUFAgb3ZlciBXZWJzb2NrZXQuCiAqCiAqICBUaGlzIGlzIHRoZSBKYXZhU2NyaXB0IHZlcnNpb24gb2YgdGhlIFN0cm9waGUgbGlicmFyeS4gIFNpbmNlIEphdmFTY3JpcHQKICogIGhhZCBubyBmYWNpbGl0aWVzIGZvciBwZXJzaXN0ZW50IFRDUCBjb25uZWN0aW9ucywgdGhpcyBsaWJyYXJ5IHVzZXMKICogIEJpZGlyZWN0aW9uYWwtc3RyZWFtcyBPdmVyIFN5bmNocm9ub3VzIEhUVFAgKEJPU0gpIHRvIGVtdWxhdGUKICogIGEgcGVyc2lzdGVudCwgc3RhdGVmdWwsIHR3by13YXkgY29ubmVjdGlvbiB0byBhbiBYTVBQIHNlcnZlci4gIE1vcmUKICogIGluZm9ybWF0aW9uIG9uIEJPU0ggY2FuIGJlIGZvdW5kIGluIFhFUCAxMjQuCiAqCiAqICBUaGlzIHZlcnNpb24gb2YgU3Ryb3BoZSBhbHNvIHdvcmtzIHdpdGggV2ViU29ja2V0cy4KICogIEZvciBtb3JlIGluZm9ybWF0aW9uIG9uIFhNUFAtb3ZlciBXZWJTb2NrZXQgc2VlIHRoaXMgUkZDIGRyYWZ0OgogKiAgaHR0cDovL3Rvb2xzLmlldGYub3JnL2h0bWwvZHJhZnQtaWV0Zi14bXBwLXdlYnNvY2tldC0wMAogKi8KCi8qKiBQcml2YXRlRnVuY3Rpb246IEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kCiAqICBCaW5kIGEgZnVuY3Rpb24gdG8gYW4gaW5zdGFuY2UuCiAqCiAqICBUaGlzIEZ1bmN0aW9uIG9iamVjdCBleHRlbnNpb24gbWV0aG9kIGNyZWF0ZXMgYSBib3VuZCBtZXRob2Qgc2ltaWxhcgogKiAgdG8gdGhvc2UgaW4gUHl0aG9uLiAgVGhpcyBtZWFucyB0aGF0IHRoZSAndGhpcycgb2JqZWN0IHdpbGwgcG9pbnQKICogIHRvIHRoZSBpbnN0YW5jZSB5b3Ugd2FudC4gIFNlZQogKiAgPGEgaHJlZj0naHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvRnVuY3Rpb24vYmluZCc+TURDJ3MgYmluZCgpIGRvY3VtZW50YXRpb248L2E+IGFuZAogKiAgPGEgaHJlZj0naHR0cDovL2JlbmphbWluLnNtZWRiZXJncy51cy9ibG9nLzIwMDctMDEtMDMvYm91bmQtZnVuY3Rpb25zLWFuZC1mdW5jdGlvbi1pbXBvcnRzLWluLWphdmFzY3JpcHQvJz5Cb3VuZCBGdW5jdGlvbnMgYW5kIEZ1bmN0aW9uIEltcG9ydHMgaW4gSmF2YVNjcmlwdDwvYT4KICogIGZvciBhIGNvbXBsZXRlIGV4cGxhbmF0aW9uLgogKgogKiAgVGhpcyBleHRlbnNpb24gYWxyZWFkeSBleGlzdHMgaW4gc29tZSBicm93c2VycyAobmFtZWx5LCBGaXJlZm94IDMpLCBidXQKICogIHdlIHByb3ZpZGUgaXQgdG8gc3VwcG9ydCB0aG9zZSB0aGF0IGRvbid0LgogKgogKiAgUGFyYW1ldGVyczoKICogICAgKE9iamVjdCkgb2JqIC0gVGhlIG9iamVjdCB0aGF0IHdpbGwgYmVjb21lICd0aGlzJyBpbiB0aGUgYm91bmQgZnVuY3Rpb24uCiAqICAgIChPYmplY3QpIGFyZ04gLSBBbiBvcHRpb24gYXJndW1lbnQgdGhhdCB3aWxsIGJlIHByZXBlbmRlZCB0byB0aGUKICogICAgICBhcmd1bWVudHMgZ2l2ZW4gZm9yIHRoZSBmdW5jdGlvbiBjYWxsCiAqCiAqICBSZXR1cm5zOgogKiAgICBUaGUgYm91bmQgZnVuY3Rpb24uCiAqLwppZiAoIUZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kKSB7CiAgICBGdW5jdGlvbi5wcm90b3R5cGUuYmluZCA9IGZ1bmN0aW9uIChvYmogLyosIGFyZzEsIGFyZzIsIC4uLiAqLykKICAgIHsKICAgICAgICB2YXIgZnVuYyA9IHRoaXM7CiAgICAgICAgdmFyIF9zbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICAgICAgICB2YXIgX2NvbmNhdCA9IEFycmF5LnByb3RvdHlwZS5jb25jYXQ7CiAgICAgICAgdmFyIF9hcmdzID0gX3NsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkob2JqID8gb2JqIDogdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbmNhdC5jYWxsKF9hcmdzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3NsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSkpOwogICAgICAgIH07CiAgICB9Owp9CgovKiogUHJpdmF0ZUZ1bmN0aW9uOiBBcnJheS5wcm90b3R5cGUuaW5kZXhPZgogKiAgUmV0dXJuIHRoZSBpbmRleCBvZiBhbiBvYmplY3QgaW4gYW4gYXJyYXkuCiAqCiAqICBUaGlzIGZ1bmN0aW9uIGlzIG5vdCBzdXBwbGllZCBieSBzb21lIEphdmFTY3JpcHQgaW1wbGVtZW50YXRpb25zLCBzbwogKiAgd2UgcHJvdmlkZSBpdCBpZiBpdCBpcyBtaXNzaW5nLiAgVGhpcyBjb2RlIGlzIGZyb206CiAqICBodHRwOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL0VuL0NvcmVfSmF2YVNjcmlwdF8xLjVfUmVmZXJlbmNlOk9iamVjdHM6QXJyYXk6aW5kZXhPZgogKgogKiAgUGFyYW1ldGVyczoKICogICAgKE9iamVjdCkgZWx0IC0gVGhlIG9iamVjdCB0byBsb29rIGZvci4KICogICAgKEludGVnZXIpIGZyb20gLSBUaGUgaW5kZXggZnJvbSB3aGljaCB0byBzdGFydCBsb29raW5nLiAob3B0aW9uYWwpLgogKgogKiAgUmV0dXJuczoKICogICAgVGhlIGluZGV4IG9mIGVsdCBpbiB0aGUgYXJyYXkgb3IgLTEgaWYgbm90IGZvdW5kLgogKi8KaWYgKCFBcnJheS5wcm90b3R5cGUuaW5kZXhPZikKewogICAgQXJyYXkucHJvdG90eXBlLmluZGV4T2YgPSBmdW5jdGlvbihlbHQgLyosIGZyb20qLykKICAgIHsKICAgICAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGg7CgogICAgICAgIHZhciBmcm9tID0gTnVtYmVyKGFyZ3VtZW50c1sxXSkgfHwgMDsKICAgICAgICBmcm9tID0gKGZyb20gPCAwKSA/IE1hdGguY2VpbChmcm9tKSA6IE1hdGguZmxvb3IoZnJvbSk7CiAgICAgICAgaWYgKGZyb20gPCAwKSB7CiAgICAgICAgICAgIGZyb20gKz0gbGVuOwogICAgICAgIH0KCiAgICAgICAgZm9yICg7IGZyb20gPCBsZW47IGZyb20rKykgewogICAgICAgICAgICBpZiAoZnJvbSBpbiB0aGlzICYmIHRoaXNbZnJvbV0gPT09IGVsdCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZyb207CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiAtMTsKICAgIH07Cn0KCi8qIEFsbCBvZiB0aGUgU3Ryb3BoZSBnbG9iYWxzIGFyZSBkZWZpbmVkIGluIHRoaXMgc3BlY2lhbCBmdW5jdGlvbiBiZWxvdyBzbwogKiB0aGF0IHJlZmVyZW5jZXMgdG8gdGhlIGdsb2JhbHMgYmVjb21lIGNsb3N1cmVzLiAgVGhpcyB3aWxsIGVuc3VyZSB0aGF0CiAqIG9uIHBhZ2UgcmVsb2FkLCB0aGVzZSByZWZlcmVuY2VzIHdpbGwgc3RpbGwgYmUgYXZhaWxhYmxlIHRvIGNhbGxiYWNrcwogKiB0aGF0IGFyZSBzdGlsbCBleGVjdXRpbmcuCiAqLwoKKGZ1bmN0aW9uIChjYWxsYmFjaykgewp2YXIgU3Ryb3BoZTsKCi8qKiBGdW5jdGlvbjogJGJ1aWxkCiAqICBDcmVhdGUgYSBTdHJvcGhlLkJ1aWxkZXIuCiAqICBUaGlzIGlzIGFuIGFsaWFzIGZvciAnbmV3IFN0cm9waGUuQnVpbGRlcihuYW1lLCBhdHRycyknLgogKgogKiAgUGFyYW1ldGVyczoKICogICAgKFN0cmluZykgbmFtZSAtIFRoZSByb290IGVsZW1lbnQgbmFtZS4KICogICAgKE9iamVjdCkgYXR0cnMgLSBUaGUgYXR0cmlidXRlcyBmb3IgdGhlIHJvb3QgZWxlbWVudCBpbiBvYmplY3Qgbm90YXRpb24uCiAqCiAqICBSZXR1cm5zOgogKiAgICBBIG5ldyBTdHJvcGhlLkJ1aWxkZXIgb2JqZWN0LgogKi8KZnVuY3Rpb24gJGJ1aWxkKG5hbWUsIGF0dHJzKSB7IHJldHVybiBuZXcgU3Ryb3BoZS5CdWlsZGVyKG5hbWUsIGF0dHJzKTsgfQovKiogRnVuY3Rpb246ICRtc2cKICogIENyZWF0ZSBhIFN0cm9waGUuQnVpbGRlciB3aXRoIGEgPG1lc3NhZ2UvPiBlbGVtZW50IGFzIHRoZSByb290LgogKgogKiAgUGFybWFldGVyczoKICogICAgKE9iamVjdCkgYXR0cnMgLSBUaGUgPG1lc3NhZ2UvPiBlbGVtZW50IGF0dHJpYnV0ZXMgaW4gb2JqZWN0IG5vdGF0aW9uLgogKgogKiAgUmV0dXJuczoKICogICAgQSBuZXcgU3Ryb3BoZS5CdWlsZGVyIG9iamVjdC4KICovCmZ1bmN0aW9uICRtc2coYXR0cnMpIHsgcmV0dXJuIG5ldyBTdHJvcGhlLkJ1aWxkZXIoIm1lc3NhZ2UiLCBhdHRycyk7IH0KLyoqIEZ1bmN0aW9uOiAkaXEKICogIENyZWF0ZSBhIFN0cm9waGUuQnVpbGRlciB3aXRoIGFuIDxpcS8+IGVsZW1lbnQgYXMgdGhlIHJvb3QuCiAqCiAqICBQYXJhbWV0ZXJzOgogKiAgICAoT2JqZWN0KSBhdHRycyAtIFRoZSA8aXEvPiBlbGVtZW50IGF0dHJpYnV0ZXMgaW4gb2JqZWN0IG5vdGF0aW9uLgogKgogKiAgUmV0dXJuczoKICogICAgQSBuZXcgU3Ryb3BoZS5CdWlsZGVyIG9iamVjdC4KICovCmZ1bmN0aW9uICRpcShhdHRycykgeyByZXR1cm4gbmV3IFN0cm9waGUuQnVpbGRlcigiaXEiLCBhdHRycyk7IH0KLyoqIEZ1bmN0aW9uOiAkcHJlcwogKiAgQ3JlYXRlIGEgU3Ryb3BoZS5CdWlsZGVyIHdpdGggYSA8cHJlc2VuY2UvPiBlbGVtZW50IGFzIHRoZSByb290LgogKgogKiAgUGFyYW1ldGVyczoKICogICAgKE9iamVjdCkgYXR0cnMgLSBUaGUgPHByZXNlbmNlLz4gZWxlbWVudCBhdHRyaWJ1dGVzIGluIG9iamVjdCBub3RhdGlvbi4KICoKICogIFJldHVybnM6CiAqICAgIEEgbmV3IFN0cm9waGUuQnVpbGRlciBvYmplY3QuCiAqLwpmdW5jdGlvbiAkcHJlcyhhdHRycykgeyByZXR1cm4gbmV3IFN0cm9waGUuQnVpbGRlcigicHJlc2VuY2UiLCBhdHRycyk7IH0KCi8qKiBDbGFzczogU3Ryb3BoZQogKiAgQW4gb2JqZWN0IGNvbnRhaW5lciBmb3IgYWxsIFN0cm9waGUgbGlicmFyeSBmdW5jdGlvbnMuCiAqCiAqICBUaGlzIGNsYXNzIGlzIGp1c3QgYSBjb250YWluZXIgZm9yIGFsbCB0aGUgb2JqZWN0cyBhbmQgY29uc3RhbnRzCiAqICB1c2VkIGluIHRoZSBsaWJyYXJ5LiAgSXQgaXMgbm90IG1lYW50IHRvIGJlIGluc3RhbnRpYXRlZCwgYnV0IHRvCiAqICBwcm92aWRlIGEgbmFtZXNwYWNlIGZvciBsaWJyYXJ5IG9iamVjdHMsIGNvbnN0YW50cywgYW5kIGZ1bmN0aW9ucy4KICovClN0cm9waGUgPSB7CiAgICAvKiogQ29uc3RhbnQ6IFZFUlNJT04KICAgICAqICBUaGUgdmVyc2lvbiBvZiB0aGUgU3Ryb3BoZSBsaWJyYXJ5LiBVbnJlbGVhc2VkIGJ1aWxkcyB3aWxsIGhhdmUKICAgICAqICBhIHZlcnNpb24gb2YgaGVhZC1IQVNIIHdoZXJlIEhBU0ggaXMgYSBwYXJ0aWFsIHJldmlzaW9uLgogICAgICovCiAgICBWRVJTSU9OOiAiMS4xLjMiLAoKICAgIC8qKiBDb25zdGFudHM6IFhNUFAgTmFtZXNwYWNlIENvbnN0YW50cwogICAgICogIENvbW1vbiBuYW1lc3BhY2UgY29uc3RhbnRzIGZyb20gdGhlIFhNUFAgUkZDcyBhbmQgWEVQcy4KICAgICAqCiAgICAgKiAgTlMuSFRUUEJJTkQgLSBIVFRQIEJJTkQgbmFtZXNwYWNlIGZyb20gWEVQIDEyNC4KICAgICAqICBOUy5CT1NIIC0gQk9TSCBuYW1lc3BhY2UgZnJvbSBYRVAgMjA2LgogICAgICogIE5TLkNMSUVOVCAtIE1haW4gWE1QUCBjbGllbnQgbmFtZXNwYWNlLgogICAgICogIE5TLkFVVEggLSBMZWdhY3kgYXV0aGVudGljYXRpb24gbmFtZXNwYWNlLgogICAgICogIE5TLlJPU1RFUiAtIFJvc3RlciBvcGVyYXRpb25zIG5hbWVzcGFjZS4KICAgICAqICBOUy5QUk9GSUxFIC0gUHJvZmlsZSBuYW1lc3BhY2UuCiAgICAgKiAgTlMuRElTQ09fSU5GTyAtIFNlcnZpY2UgZGlzY292ZXJ5IGluZm8gbmFtZXNwYWNlIGZyb20gWEVQIDMwLgogICAgICogIE5TLkRJU0NPX0lURU1TIC0gU2VydmljZSBkaXNjb3ZlcnkgaXRlbXMgbmFtZXNwYWNlIGZyb20gWEVQIDMwLgogICAgICogIE5TLk1VQyAtIE11bHRpLVVzZXIgQ2hhdCBuYW1lc3BhY2UgZnJvbSBYRVAgNDUuCiAgICAgKiAgTlMuU0FTTCAtIFhNUFAgU0FTTCBuYW1lc3BhY2UgZnJvbSBSRkMgMzkyMC4KICAgICAqICBOUy5TVFJFQU0gLSBYTVBQIFN0cmVhbXMgbmFtZXNwYWNlIGZyb20gUkZDIDM5MjAuCiAgICAgKiAgTlMuQklORCAtIFhNUFAgQmluZGluZyBuYW1lc3BhY2UgZnJvbSBSRkMgMzkyMC4KICAgICAqICBOUy5TRVNTSU9OIC0gWE1QUCBTZXNzaW9uIG5hbWVzcGFjZSBmcm9tIFJGQyAzOTIwLgogICAgICogIE5TLlhIVE1MX0lNIC0gWEhUTUwtSU0gbmFtZXNwYWNlIGZyb20gWEVQIDcxLgogICAgICogIE5TLlhIVE1MIC0gWEhUTUwgYm9keSBuYW1lc3BhY2UgZnJvbSBYRVAgNzEuCiAgICAgKi8KICAgIE5TOiB7CiAgICAgICAgSFRUUEJJTkQ6ICJodHRwOi8vamFiYmVyLm9yZy9wcm90b2NvbC9odHRwYmluZCIsCiAgICAgICAgQk9TSDogInVybjp4bXBwOnhib3NoIiwKICAgICAgICBDTElFTlQ6ICJqYWJiZXI6Y2xpZW50IiwKICAgICAgICBBVVRIOiAiamFiYmVyOmlxOmF1dGgiLAogICAgICAgIFJPU1RFUjogImphYmJlcjppcTpyb3N0ZXIiLAogICAgICAgIFBST0ZJTEU6ICJqYWJiZXI6aXE6cHJvZmlsZSIsCiAgICAgICAgRElTQ09fSU5GTzogImh0dHA6Ly9qYWJiZXIub3JnL3Byb3RvY29sL2Rpc2NvI2luZm8iLAogICAgICAgIERJU0NPX0lURU1TOiAiaHR0cDovL2phYmJlci5vcmcvcHJvdG9jb2wvZGlzY28jaXRlbXMiLAogICAgICAgIE1VQzogImh0dHA6Ly9qYWJiZXIub3JnL3Byb3RvY29sL211YyIsCiAgICAgICAgU0FTTDogInVybjppZXRmOnBhcmFtczp4bWw6bnM6eG1wcC1zYXNsIiwKICAgICAgICBTVFJFQU06ICJodHRwOi8vZXRoZXJ4LmphYmJlci5vcmcvc3RyZWFtcyIsCiAgICAgICAgQklORDogInVybjppZXRmOnBhcmFtczp4bWw6bnM6eG1wcC1iaW5kIiwKICAgICAgICBTRVNTSU9OOiAidXJuOmlldGY6cGFyYW1zOnhtbDpuczp4bXBwLXNlc3Npb24iLAogICAgICAgIFZFUlNJT046ICJqYWJiZXI6aXE6dmVyc2lvbiIsCiAgICAgICAgU1RBTlpBUzogInVybjppZXRmOnBhcmFtczp4bWw6bnM6eG1wcC1zdGFuemFzIiwKICAgICAgICBYSFRNTF9JTTogImh0dHA6Ly9qYWJiZXIub3JnL3Byb3RvY29sL3hodG1sLWltIiwKICAgICAgICBYSFRNTDogImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiCiAgICB9LAoKCiAgICAvKiogQ29uc3RhbnRzOiBYSFRNTF9JTSBOYW1lc3BhY2UKICAgICAqICBjb250YWlucyBhbGxvd2VkIHRhZ3MsIHRhZyBhdHRyaWJ1dGVzLCBhbmQgY3NzIHByb3BlcnRpZXMuCiAgICAgKiAgVXNlZCBpbiB0aGUgY3JlYXRlSHRtbCBmdW5jdGlvbiB0byBmaWx0ZXIgaW5jb21pbmcgaHRtbCBpbnRvIHRoZSBhbGxvd2VkIFhIVE1MLUlNIHN1YnNldC4KICAgICAqICBTZWUgaHR0cDovL3htcHAub3JnL2V4dGVuc2lvbnMveGVwLTAwNzEuaHRtbCNwcm9maWxlLXN1bW1hcnkgZm9yIHRoZSBsaXN0IG9mIHJlY29tbWVuZGVkCiAgICAgKiAgYWxsb3dlZCB0YWdzIGFuZCB0aGVpciBhdHRyaWJ1dGVzLgogICAgICovCiAgICBYSFRNTDogewogICAgICAgICAgICAgICAgdGFnczogWydhJywnYmxvY2txdW90ZScsJ2JyJywnY2l0ZScsJ2VtJywnaW1nJywnbGknLCdvbCcsJ3AnLCdzcGFuJywnc3Ryb25nJywndWwnLCdib2R5J10sCiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICdhJzogICAgICAgICAgWydocmVmJ10sCiAgICAgICAgICAgICAgICAgICAgICAgICdibG9ja3F1b3RlJzogWydzdHlsZSddLAogICAgICAgICAgICAgICAgICAgICAgICAnYnInOiAgICAgICAgIFtdLAogICAgICAgICAgICAgICAgICAgICAgICAnY2l0ZSc6ICAgICAgIFsnc3R5bGUnXSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2VtJzogICAgICAgICBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2ltZyc6ICAgICAgICBbJ3NyYycsICdhbHQnLCAnc3R5bGUnLCAnaGVpZ2h0JywgJ3dpZHRoJ10sCiAgICAgICAgICAgICAgICAgICAgICAgICdsaSc6ICAgICAgICAgWydzdHlsZSddLAogICAgICAgICAgICAgICAgICAgICAgICAnb2wnOiAgICAgICAgIFsnc3R5bGUnXSwKICAgICAgICAgICAgICAgICAgICAgICAgJ3AnOiAgICAgICAgICBbJ3N0eWxlJ10sCiAgICAgICAgICAgICAgICAgICAgICAgICdzcGFuJzogICAgICAgWydzdHlsZSddLAogICAgICAgICAgICAgICAgICAgICAgICAnc3Ryb25nJzogICAgIFtdLAogICAgICAgICAgICAgICAgICAgICAgICAndWwnOiAgICAgICAgIFsnc3R5bGUnXSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2JvZHknOiAgICAgICBbXQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNzczogWydiYWNrZ3JvdW5kLWNvbG9yJywnY29sb3InLCdmb250LWZhbWlseScsJ2ZvbnQtc2l6ZScsJ2ZvbnQtc3R5bGUnLCdmb250LXdlaWdodCcsJ21hcmdpbi1sZWZ0JywnbWFyZ2luLXJpZ2h0JywndGV4dC1hbGlnbicsJ3RleHQtZGVjb3JhdGlvbiddLAogICAgICAgICAgICAgICAgdmFsaWRUYWc6IGZ1bmN0aW9uKHRhZykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IFN0cm9waGUuWEhUTUwudGFncy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRhZyA9PSBTdHJvcGhlLlhIVE1MLnRhZ3NbaV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmFsaWRBdHRyaWJ1dGU6IGZ1bmN0aW9uKHRhZywgYXR0cmlidXRlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YgU3Ryb3BoZS5YSFRNTC5hdHRyaWJ1dGVzW3RhZ10gIT09ICd1bmRlZmluZWQnICYmIFN0cm9waGUuWEhUTUwuYXR0cmlidXRlc1t0YWddLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgU3Ryb3BoZS5YSFRNTC5hdHRyaWJ1dGVzW3RhZ10ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGF0dHJpYnV0ZSA9PSBTdHJvcGhlLlhIVE1MLmF0dHJpYnV0ZXNbdGFnXVtpXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHZhbGlkQ1NTOiBmdW5jdGlvbihzdHlsZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IFN0cm9waGUuWEhUTUwuY3NzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc3R5bGUgPT0gU3Ryb3BoZS5YSFRNTC5jc3NbaV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICB9LAoKICAgIC8qKiBDb25zdGFudHM6IENvbm5lY3Rpb24gU3RhdHVzIENvbnN0YW50cwogICAgICogIENvbm5lY3Rpb24gc3RhdHVzIGNvbnN0YW50cyBmb3IgdXNlIGJ5IHRoZSBjb25uZWN0aW9uIGhhbmRsZXIKICAgICAqICBjYWxsYmFjay4KICAgICAqCiAgICAgKiAgU3RhdHVzLkVSUk9SIC0gQW4gZXJyb3IgaGFzIG9jY3VycmVkCiAgICAgKiAgU3RhdHVzLkNPTk5FQ1RJTkcgLSBUaGUgY29ubmVjdGlvbiBpcyBjdXJyZW50bHkgYmVpbmcgbWFkZQogICAgICogIFN0YXR1cy5DT05ORkFJTCAtIFRoZSBjb25uZWN0aW9uIGF0dGVtcHQgZmFpbGVkCiAgICAgKiAgU3RhdHVzLkFVVEhFTlRJQ0FUSU5HIC0gVGhlIGNvbm5lY3Rpb24gaXMgYXV0aGVudGljYXRpbmcKICAgICAqICBTdGF0dXMuQVVUSEZBSUwgLSBUaGUgYXV0aGVudGljYXRpb24gYXR0ZW1wdCBmYWlsZWQKICAgICAqICBTdGF0dXMuQ09OTkVDVEVEIC0gVGhlIGNvbm5lY3Rpb24gaGFzIHN1Y2NlZWRlZAogICAgICogIFN0YXR1cy5ESVNDT05ORUNURUQgLSBUaGUgY29ubmVjdGlvbiBoYXMgYmVlbiB0ZXJtaW5hdGVkCiAgICAgKiAgU3RhdHVzLkRJU0NPTk5FQ1RJTkcgLSBUaGUgY29ubmVjdGlvbiBpcyBjdXJyZW50bHkgYmVpbmcgdGVybWluYXRlZAogICAgICogIFN0YXR1cy5BVFRBQ0hFRCAtIFRoZSBjb25uZWN0aW9uIGhhcyBiZWVuIGF0dGFjaGVkCiAgICAgKi8KICAgIFN0YXR1czogewogICAgICAgIEVSUk9SOiAwLAogICAgICAgIENPTk5FQ1RJTkc6IDEsCiAgICAgICAgQ09OTkZBSUw6IDIsCiAgICAgICAgQVVUSEVOVElDQVRJTkc6IDMsCiAgICAgICAgQVVUSEZBSUw6IDQsCiAgICAgICAgQ09OTkVDVEVEOiA1LAogICAgICAgIERJU0NPTk5FQ1RFRDogNiwKICAgICAgICBESVNDT05ORUNUSU5HOiA3LAogICAgICAgIEFUVEFDSEVEOiA4CiAgICB9LAoKICAgIC8qKiBDb25zdGFudHM6IExvZyBMZXZlbCBDb25zdGFudHMKICAgICAqICBMb2dnaW5nIGxldmVsIGluZGljYXRvcnMuCiAgICAgKgogICAgICogIExvZ0xldmVsLkRFQlVHIC0gRGVidWcgb3V0cHV0CiAgICAgKiAgTG9nTGV2ZWwuSU5GTyAtIEluZm9ybWF0aW9uYWwgb3V0cHV0CiAgICAgKiAgTG9nTGV2ZWwuV0FSTiAtIFdhcm5pbmdzCiAgICAgKiAgTG9nTGV2ZWwuRVJST1IgLSBFcnJvcnMKICAgICAqICBMb2dMZXZlbC5GQVRBTCAtIEZhdGFsIGVycm9ycwogICAgICovCiAgICBMb2dMZXZlbDogewogICAgICAgIERFQlVHOiAwLAogICAgICAgIElORk86IDEsCiAgICAgICAgV0FSTjogMiwKICAgICAgICBFUlJPUjogMywKICAgICAgICBGQVRBTDogNAogICAgfSwKCiAgICAvKiogUHJpdmF0ZUNvbnN0YW50czogRE9NIEVsZW1lbnQgVHlwZSBDb25zdGFudHMKICAgICAqICBET00gZWxlbWVudCB0eXBlcy4KICAgICAqCiAgICAgKiAgRWxlbWVudFR5cGUuTk9STUFMIC0gTm9ybWFsIGVsZW1lbnQuCiAgICAgKiAgRWxlbWVudFR5cGUuVEVYVCAtIFRleHQgZGF0YSBlbGVtZW50LgogICAgICogIEVsZW1lbnRUeXBlLkZSQUdNRU5UIC0gWEhUTUwgZnJhZ21lbnQgZWxlbWVudC4KICAgICAqLwogICAgRWxlbWVudFR5cGU6IHsKICAgICAgICBOT1JNQUw6IDEsCiAgICAgICAgVEVYVDogMywKICAgICAgICBDREFUQTogNCwKICAgICAgICBGUkFHTUVOVDogMTEKICAgIH0sCgogICAgLyoqIFByaXZhdGVDb25zdGFudHM6IFRpbWVvdXQgVmFsdWVzCiAgICAgKiAgVGltZW91dCB2YWx1ZXMgZm9yIGVycm9yIHN0YXRlcy4gIFRoZXNlIHZhbHVlcyBhcmUgaW4gc2Vjb25kcy4KICAgICAqICBUaGVzZSBzaG91bGQgbm90IGJlIGNoYW5nZWQgdW5sZXNzIHlvdSBrbm93IGV4YWN0bHkgd2hhdCB5b3UgYXJlCiAgICAgKiAgZG9pbmcuCiAgICAgKgogICAgICogIFRJTUVPVVQgLSBUaW1lb3V0IG11bHRpcGxpZXIuIEEgd2FpdGluZyByZXF1ZXN0IHdpbGwgYmUgY29uc2lkZXJlZAogICAgICogICAgICBmYWlsZWQgYWZ0ZXIgTWF0aC5mbG9vcihUSU1FT1VUICogd2FpdCkgc2Vjb25kcyBoYXZlIGVsYXBzZWQuCiAgICAgKiAgICAgIFRoaXMgZGVmYXVsdHMgdG8gMS4xLCBhbmQgd2l0aCBkZWZhdWx0IHdhaXQsIDY2IHNlY29uZHMuCiAgICAgKiAgU0VDT05EQVJZX1RJTUVPVVQgLSBTZWNvbmRhcnkgdGltZW91dCBtdWx0aXBsaWVyLiBJbiBjYXNlcyB3aGVyZQogICAgICogICAgICBTdHJvcGhlIGNhbiBkZXRlY3QgZWFybHkgZmFpbHVyZSwgaXQgd2lsbCBjb25zaWRlciB0aGUgcmVxdWVzdAogICAgICogICAgICBmYWlsZWQgaWYgaXQgZG9lc24ndCByZXR1cm4gYWZ0ZXIKICAgICAqICAgICAgTWF0aC5mbG9vcihTRUNPTkRBUllfVElNRU9VVCAqIHdhaXQpIHNlY29uZHMgaGF2ZSBlbGFwc2VkLgogICAgICogICAgICBUaGlzIGRlZmF1bHRzIHRvIDAuMSwgYW5kIHdpdGggZGVmYXVsdCB3YWl0LCA2IHNlY29uZHMuCiAgICAgKi8KICAgIFRJTUVPVVQ6IDEuMSwKICAgIFNFQ09OREFSWV9USU1FT1VUOiAwLjEsCgogICAgLyoqIEZ1bmN0aW9uOiBhZGROYW1lc3BhY2UKICAgICAqICBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gZXh0ZW5kIHRoZSBjdXJyZW50IG5hbWVzcGFjZXMgaW4KICAgICAqICBTdHJvcGhlLk5TLiAgSXQgdGFrZXMgYSBrZXkgYW5kIGEgdmFsdWUgd2l0aCB0aGUga2V5IGJlaW5nIHRoZQogICAgICogIG5hbWUgb2YgdGhlIG5ldyBuYW1lc3BhY2UsIHdpdGggaXRzIGFjdHVhbCB2YWx1ZS4KICAgICAqICBGb3IgZXhhbXBsZToKICAgICAqICBTdHJvcGhlLmFkZE5hbWVzcGFjZSgnUFVCU1VCJywgImh0dHA6Ly9qYWJiZXIub3JnL3Byb3RvY29sL3B1YnN1YiIpOwogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cmluZykgbmFtZSAtIFRoZSBuYW1lIHVuZGVyIHdoaWNoIHRoZSBuYW1lc3BhY2Ugd2lsbCBiZQogICAgICogICAgICByZWZlcmVuY2VkIHVuZGVyIFN0cm9waGUuTlMKICAgICAqICAgIChTdHJpbmcpIHZhbHVlIC0gVGhlIGFjdHVhbCBuYW1lc3BhY2UuCiAgICAgKi8KICAgIGFkZE5hbWVzcGFjZTogZnVuY3Rpb24gKG5hbWUsIHZhbHVlKQogICAgewogICAgICBTdHJvcGhlLk5TW25hbWVdID0gdmFsdWU7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogZm9yRWFjaENoaWxkCiAgICAgKiAgTWFwIGEgZnVuY3Rpb24gb3ZlciBzb21lIG9yIGFsbCBjaGlsZCBlbGVtZW50cyBvZiBhIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogIFRoaXMgaXMgYSBzbWFsbCBjb252ZW5pZW5jZSBmdW5jdGlvbiBmb3IgbWFwcGluZyBhIGZ1bmN0aW9uIG92ZXIKICAgICAqICBzb21lIG9yIGFsbCBvZiB0aGUgY2hpbGRyZW4gb2YgYW4gZWxlbWVudC4gIElmIGVsZW1OYW1lIGlzIG51bGwsIGFsbAogICAgICogIGNoaWxkcmVuIHdpbGwgYmUgcGFzc2VkIHRvIHRoZSBmdW5jdGlvbiwgb3RoZXJ3aXNlIG9ubHkgY2hpbGRyZW4KICAgICAqICB3aG9zZSB0YWcgbmFtZXMgbWF0Y2ggZWxlbU5hbWUgd2lsbCBiZSBwYXNzZWQuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoWE1MRWxlbWVudCkgZWxlbSAtIFRoZSBlbGVtZW50IHRvIG9wZXJhdGUgb24uCiAgICAgKiAgICAoU3RyaW5nKSBlbGVtTmFtZSAtIFRoZSBjaGlsZCBlbGVtZW50IHRhZyBuYW1lIGZpbHRlci4KICAgICAqICAgIChGdW5jdGlvbikgZnVuYyAtIFRoZSBmdW5jdGlvbiB0byBhcHBseSB0byBlYWNoIGNoaWxkLiAgVGhpcwogICAgICogICAgICBmdW5jdGlvbiBzaG91bGQgdGFrZSBhIHNpbmdsZSBhcmd1bWVudCwgYSBET00gZWxlbWVudC4KICAgICAqLwogICAgZm9yRWFjaENoaWxkOiBmdW5jdGlvbiAoZWxlbSwgZWxlbU5hbWUsIGZ1bmMpCiAgICB7CiAgICAgICAgdmFyIGksIGNoaWxkTm9kZTsKCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGVsZW0uY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjaGlsZE5vZGUgPSBlbGVtLmNoaWxkTm9kZXNbaV07CiAgICAgICAgICAgIGlmIChjaGlsZE5vZGUubm9kZVR5cGUgPT0gU3Ryb3BoZS5FbGVtZW50VHlwZS5OT1JNQUwgJiYKICAgICAgICAgICAgICAgICghZWxlbU5hbWUgfHwgdGhpcy5pc1RhZ0VxdWFsKGNoaWxkTm9kZSwgZWxlbU5hbWUpKSkgewogICAgICAgICAgICAgICAgZnVuYyhjaGlsZE5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IGlzVGFnRXF1YWwKICAgICAqICBDb21wYXJlIGFuIGVsZW1lbnQncyB0YWcgbmFtZSB3aXRoIGEgc3RyaW5nLgogICAgICoKICAgICAqICBUaGlzIGZ1bmN0aW9uIGlzIGNhc2UgaW5zZW5zaXRpdmUuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoWE1MRWxlbWVudCkgZWwgLSBBIERPTSBlbGVtZW50LgogICAgICogICAgKFN0cmluZykgbmFtZSAtIFRoZSBlbGVtZW50IG5hbWUuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICB0cnVlIGlmIHRoZSBlbGVtZW50J3MgdGFnIG5hbWUgbWF0Y2hlcyBfZWxfLCBhbmQgZmFsc2UKICAgICAqICAgIG90aGVyd2lzZS4KICAgICAqLwogICAgaXNUYWdFcXVhbDogZnVuY3Rpb24gKGVsLCBuYW1lKQogICAgewogICAgICAgIHJldHVybiBlbC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZVZhcmlhYmxlOiBfeG1sR2VuZXJhdG9yCiAgICAgKiAgX1ByaXZhdGVfIHZhcmlhYmxlIHRoYXQgY2FjaGVzIGEgRE9NIGRvY3VtZW50IHRvCiAgICAgKiAgZ2VuZXJhdGUgZWxlbWVudHMuCiAgICAgKi8KICAgIF94bWxHZW5lcmF0b3I6IG51bGwsCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX21ha2VHZW5lcmF0b3IKICAgICAqICBfUHJpdmF0ZV8gZnVuY3Rpb24gdGhhdCBjcmVhdGVzIGEgZHVtbXkgWE1MIERPTSBkb2N1bWVudCB0byBzZXJ2ZSBhcwogICAgICogIGFuIGVsZW1lbnQgYW5kIHRleHQgbm9kZSBnZW5lcmF0b3IuCiAgICAgKi8KICAgIF9tYWtlR2VuZXJhdG9yOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGRvYzsKCiAgICAgICAgLy8gSUU5IGRvZXMgaW1wbGVtZW50IGNyZWF0ZURvY3VtZW50KCk7IGhvd2V2ZXIsIHVzaW5nIGl0IHdpbGwgY2F1c2UgdGhlIGJyb3dzZXIgdG8gbGVhayBtZW1vcnkgb24gcGFnZSB1bmxvYWQuCiAgICAgICAgLy8gSGVyZSwgd2UgdGVzdCBmb3IgcHJlc2VuY2Ugb2YgY3JlYXRlRG9jdW1lbnQoKSBwbHVzIElFJ3MgcHJvcHJpZXRhcnkgZG9jdW1lbnRNb2RlIGF0dHJpYnV0ZSwgd2hpY2ggd291bGQgYmUKICAgICAgICAgICAgICAgIC8vIGxlc3MgdGhhbiAxMCBpbiB0aGUgY2FzZSBvZiBJRTkgYW5kIGJlbG93LgogICAgICAgIGlmIChkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVEb2N1bWVudCA9PT0gdW5kZWZpbmVkIHx8CiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmltcGxlbWVudGF0aW9uLmNyZWF0ZURvY3VtZW50ICYmIGRvY3VtZW50LmRvY3VtZW50TW9kZSAmJiBkb2N1bWVudC5kb2N1bWVudE1vZGUgPCAxMCkgewogICAgICAgICAgICBkb2MgPSB0aGlzLl9nZXRJRVhtbERvbSgpOwogICAgICAgICAgICBkb2MuYXBwZW5kQ2hpbGQoZG9jLmNyZWF0ZUVsZW1lbnQoJ3N0cm9waGUnKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZG9jID0gZG9jdW1lbnQuaW1wbGVtZW50YXRpb24KICAgICAgICAgICAgICAgIC5jcmVhdGVEb2N1bWVudCgnamFiYmVyOmNsaWVudCcsICdzdHJvcGhlJywgbnVsbCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZG9jOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IHhtbEdlbmVyYXRvcgogICAgICogIEdldCB0aGUgRE9NIGRvY3VtZW50IHRvIGdlbmVyYXRlIGVsZW1lbnRzLgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgVGhlIGN1cnJlbnRseSB1c2VkIERPTSBkb2N1bWVudC4KICAgICAqLwogICAgeG1sR2VuZXJhdG9yOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKCFTdHJvcGhlLl94bWxHZW5lcmF0b3IpIHsKICAgICAgICAgICAgU3Ryb3BoZS5feG1sR2VuZXJhdG9yID0gU3Ryb3BoZS5fbWFrZUdlbmVyYXRvcigpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gU3Ryb3BoZS5feG1sR2VuZXJhdG9yOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfZ2V0SUVYbWxEb20KICAgICAqICBHZXRzIElFIHhtbCBkb2Mgb2JqZWN0CiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBBIE1pY3Jvc29mdCBYTUwgRE9NIE9iamVjdAogICAgICogIFNlZSBBbHNvOgogICAgICogICAgaHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L21zNzU3ODM3JTI4VlMuODUlMjkuYXNweAogICAgICovCiAgICBfZ2V0SUVYbWxEb20gOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZG9jID0gbnVsbDsKICAgICAgICB2YXIgZG9jU3RyaW5ncyA9IFsKICAgICAgICAgICAgIk1zeG1sMi5ET01Eb2N1bWVudC42LjAiLAogICAgICAgICAgICAiTXN4bWwyLkRPTURvY3VtZW50LjUuMCIsCiAgICAgICAgICAgICJNc3htbDIuRE9NRG9jdW1lbnQuNC4wIiwKICAgICAgICAgICAgIk1TWE1MMi5ET01Eb2N1bWVudC4zLjAiLAogICAgICAgICAgICAiTVNYTUwyLkRPTURvY3VtZW50IiwKICAgICAgICAgICAgIk1TWE1MLkRPTURvY3VtZW50IiwKICAgICAgICAgICAgIk1pY3Jvc29mdC5YTUxET00iCiAgICAgICAgXTsKCiAgICAgICAgZm9yICh2YXIgZCA9IDA7IGQgPCBkb2NTdHJpbmdzLmxlbmd0aDsgZCsrKSB7CiAgICAgICAgICAgIGlmIChkb2MgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgZG9jID0gbmV3IEFjdGl2ZVhPYmplY3QoZG9jU3RyaW5nc1tkXSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgZG9jID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZG9jOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IHhtbEVsZW1lbnQKICAgICAqICBDcmVhdGUgYW4gWE1MIERPTSBlbGVtZW50LgogICAgICoKICAgICAqICBUaGlzIGZ1bmN0aW9uIGNyZWF0ZXMgYW4gWE1MIERPTSBlbGVtZW50IGNvcnJlY3RseSBhY3Jvc3MgYWxsCiAgICAgKiAgaW1wbGVtZW50YXRpb25zLiBOb3RlIHRoYXQgdGhlc2UgYXJlIG5vdCBIVE1MIERPTSBlbGVtZW50cywgd2hpY2gKICAgICAqICBhcmVuJ3QgYXBwcm9wcmlhdGUgZm9yIFhNUFAgc3Rhbnphcy4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJpbmcpIG5hbWUgLSBUaGUgbmFtZSBmb3IgdGhlIGVsZW1lbnQuCiAgICAgKiAgICAoQXJyYXl8T2JqZWN0KSBhdHRycyAtIEFuIG9wdGlvbmFsIGFycmF5IG9yIG9iamVjdCBjb250YWluaW5nCiAgICAgKiAgICAgIGtleS92YWx1ZSBwYWlycyB0byB1c2UgYXMgZWxlbWVudCBhdHRyaWJ1dGVzLiBUaGUgb2JqZWN0IHNob3VsZAogICAgICogICAgICBiZSBpbiB0aGUgZm9ybWF0IHsna2V5JzogJ3ZhbHVlJ30gb3Ige2tleTogJ3ZhbHVlJ30uIFRoZSBhcnJheQogICAgICogICAgICBzaG91bGQgaGF2ZSB0aGUgZm9ybWF0IFtbJ2tleTEnLCAndmFsdWUxJ10sIFsna2V5MicsICd2YWx1ZTInXV0uCiAgICAgKiAgICAoU3RyaW5nKSB0ZXh0IC0gVGhlIHRleHQgY2hpbGQgZGF0YSBmb3IgdGhlIGVsZW1lbnQuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBBIG5ldyBYTUwgRE9NIGVsZW1lbnQuCiAgICAgKi8KICAgIHhtbEVsZW1lbnQ6IGZ1bmN0aW9uIChuYW1lKQogICAgewogICAgICAgIGlmICghbmFtZSkgeyByZXR1cm4gbnVsbDsgfQoKICAgICAgICB2YXIgbm9kZSA9IFN0cm9waGUueG1sR2VuZXJhdG9yKCkuY3JlYXRlRWxlbWVudChuYW1lKTsKCiAgICAgICAgLy8gRklYTUU6IHRoaXMgc2hvdWxkIHRocm93IGVycm9ycyBpZiBhcmdzIGFyZSB0aGUgd3JvbmcgdHlwZSBvcgogICAgICAgIC8vIHRoZXJlIGFyZSBtb3JlIHRoYW4gdHdvIG9wdGlvbmFsIGFyZ3MKICAgICAgICB2YXIgYSwgaSwgazsKICAgICAgICBmb3IgKGEgPSAxOyBhIDwgYXJndW1lbnRzLmxlbmd0aDsgYSsrKSB7CiAgICAgICAgICAgIGlmICghYXJndW1lbnRzW2FdKSB7IGNvbnRpbnVlOyB9CiAgICAgICAgICAgIGlmICh0eXBlb2YoYXJndW1lbnRzW2FdKSA9PSAic3RyaW5nIiB8fAogICAgICAgICAgICAgICAgdHlwZW9mKGFyZ3VtZW50c1thXSkgPT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIG5vZGUuYXBwZW5kQ2hpbGQoU3Ryb3BoZS54bWxUZXh0Tm9kZShhcmd1bWVudHNbYV0pKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YoYXJndW1lbnRzW2FdKSA9PSAib2JqZWN0IiAmJgogICAgICAgICAgICAgICAgICAgICAgIHR5cGVvZihhcmd1bWVudHNbYV0uc29ydCkgPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGFyZ3VtZW50c1thXS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YoYXJndW1lbnRzW2FdW2ldKSA9PSAib2JqZWN0IiAmJgogICAgICAgICAgICAgICAgICAgICAgICB0eXBlb2YoYXJndW1lbnRzW2FdW2ldLnNvcnQpID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoYXJndW1lbnRzW2FdW2ldWzBdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmd1bWVudHNbYV1baV1bMV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YoYXJndW1lbnRzW2FdKSA9PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgZm9yIChrIGluIGFyZ3VtZW50c1thXSkgewogICAgICAgICAgICAgICAgICAgIGlmIChhcmd1bWVudHNbYV0uaGFzT3duUHJvcGVydHkoaykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoaywgYXJndW1lbnRzW2FdW2tdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBub2RlOwogICAgfSwKCiAgICAvKiAgRnVuY3Rpb246IHhtbGVzY2FwZQogICAgICogIEV4Y2FwZXMgaW52YWxpZCB4bWwgY2hhcmFjdGVycy4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgICAoU3RyaW5nKSB0ZXh0IC0gdGV4dCB0byBlc2NhcGUuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICAgIEVzY2FwZWQgdGV4dC4KICAgICAqLwogICAgeG1sZXNjYXBlOiBmdW5jdGlvbih0ZXh0KQogICAgewogICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoL1wmL2csICImYW1wOyIpOwogICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoLzwvZywgICImbHQ7Iik7CiAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvPi9nLCAgIiZndDsiKTsKICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC8nL2csICAiJmFwb3M7Iik7CiAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvIi9nLCAgIiZxdW90OyIpOwogICAgICAgIHJldHVybiB0ZXh0OwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IHhtbFRleHROb2RlCiAgICAgKiAgQ3JlYXRlcyBhbiBYTUwgRE9NIHRleHQgbm9kZS4KICAgICAqCiAgICAgKiAgUHJvdmlkZXMgYSBjcm9zcyBpbXBsZW1lbnRhdGlvbiB2ZXJzaW9uIG9mIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cmluZykgdGV4dCAtIFRoZSBjb250ZW50IG9mIHRoZSB0ZXh0IG5vZGUuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBBIG5ldyBYTUwgRE9NIHRleHQgbm9kZS4KICAgICAqLwogICAgeG1sVGV4dE5vZGU6IGZ1bmN0aW9uICh0ZXh0KQogICAgewogICAgICAgIHJldHVybiBTdHJvcGhlLnhtbEdlbmVyYXRvcigpLmNyZWF0ZVRleHROb2RlKHRleHQpOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IHhtbEh0bWxOb2RlCiAgICAgKiAgQ3JlYXRlcyBhbiBYTUwgRE9NIGh0bWwgbm9kZS4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJpbmcpIGh0bWwgLSBUaGUgY29udGVudCBvZiB0aGUgaHRtbCBub2RlLgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgQSBuZXcgWE1MIERPTSB0ZXh0IG5vZGUuCiAgICAgKi8KICAgIHhtbEh0bWxOb2RlOiBmdW5jdGlvbiAoaHRtbCkKICAgIHsKICAgICAgICB2YXIgbm9kZTsKICAgICAgICAvL2Vuc3VyZSB0ZXh0IGlzIGVzY2FwZWQKICAgICAgICBpZiAod2luZG93LkRPTVBhcnNlcikgewogICAgICAgICAgICB2YXIgcGFyc2VyID0gbmV3IERPTVBhcnNlcigpOwogICAgICAgICAgICBub2RlID0gcGFyc2VyLnBhcnNlRnJvbVN0cmluZyhodG1sLCAidGV4dC94bWwiKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBub2RlID0gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxET00iKTsKICAgICAgICAgICAgbm9kZS5hc3luYz0iZmFsc2UiOwogICAgICAgICAgICBub2RlLmxvYWRYTUwoaHRtbCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBub2RlOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IGdldFRleHQKICAgICAqICBHZXQgdGhlIGNvbmNhdGVuYXRpb24gb2YgYWxsIHRleHQgY2hpbGRyZW4gb2YgYW4gZWxlbWVudC4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChYTUxFbGVtZW50KSBlbGVtIC0gQSBET00gZWxlbWVudC4KICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgIEEgU3RyaW5nIHdpdGggdGhlIGNvbmNhdGVuYXRlZCB0ZXh0IG9mIGFsbCB0ZXh0IGVsZW1lbnQgY2hpbGRyZW4uCiAgICAgKi8KICAgIGdldFRleHQ6IGZ1bmN0aW9uIChlbGVtKQogICAgewogICAgICAgIGlmICghZWxlbSkgeyByZXR1cm4gbnVsbDsgfQoKICAgICAgICB2YXIgc3RyID0gIiI7CiAgICAgICAgaWYgKGVsZW0uY2hpbGROb2Rlcy5sZW5ndGggPT09IDAgJiYgZWxlbS5ub2RlVHlwZSA9PQogICAgICAgICAgICBTdHJvcGhlLkVsZW1lbnRUeXBlLlRFWFQpIHsKICAgICAgICAgICAgc3RyICs9IGVsZW0ubm9kZVZhbHVlOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbGVtLmNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKGVsZW0uY2hpbGROb2Rlc1tpXS5ub2RlVHlwZSA9PSBTdHJvcGhlLkVsZW1lbnRUeXBlLlRFWFQpIHsKICAgICAgICAgICAgICAgIHN0ciArPSBlbGVtLmNoaWxkTm9kZXNbaV0ubm9kZVZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gU3Ryb3BoZS54bWxlc2NhcGUoc3RyKTsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiBjb3B5RWxlbWVudAogICAgICogIENvcHkgYW4gWE1MIERPTSBlbGVtZW50LgogICAgICoKICAgICAqICBUaGlzIGZ1bmN0aW9uIGNvcGllcyBhIERPTSBlbGVtZW50IGFuZCBhbGwgaXRzIGRlc2NlbmRhbnRzIGFuZCByZXR1cm5zCiAgICAgKiAgdGhlIG5ldyBjb3B5LgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFhNTEVsZW1lbnQpIGVsZW0gLSBBIERPTSBlbGVtZW50LgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgQSBuZXcsIGNvcGllZCBET00gZWxlbWVudCB0cmVlLgogICAgICovCiAgICBjb3B5RWxlbWVudDogZnVuY3Rpb24gKGVsZW0pCiAgICB7CiAgICAgICAgdmFyIGksIGVsOwogICAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09IFN0cm9waGUuRWxlbWVudFR5cGUuTk9STUFMKSB7CiAgICAgICAgICAgIGVsID0gU3Ryb3BoZS54bWxFbGVtZW50KGVsZW0udGFnTmFtZSk7CgogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZWxlbS5hdHRyaWJ1dGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBlbC5zZXRBdHRyaWJ1dGUoZWxlbS5hdHRyaWJ1dGVzW2ldLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS5hdHRyaWJ1dGVzW2ldLnZhbHVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGVsZW0uY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgZWwuYXBwZW5kQ2hpbGQoU3Ryb3BoZS5jb3B5RWxlbWVudChlbGVtLmNoaWxkTm9kZXNbaV0pKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoZWxlbS5ub2RlVHlwZSA9PSBTdHJvcGhlLkVsZW1lbnRUeXBlLlRFWFQpIHsKICAgICAgICAgICAgZWwgPSBTdHJvcGhlLnhtbEdlbmVyYXRvcigpLmNyZWF0ZVRleHROb2RlKGVsZW0ubm9kZVZhbHVlKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBlbDsKICAgIH0sCgoKICAgIC8qKiBGdW5jdGlvbjogY3JlYXRlSHRtbAogICAgICogIENvcHkgYW4gSFRNTCBET00gZWxlbWVudCBpbnRvIGFuIFhNTCBET00uCiAgICAgKgogICAgICogIFRoaXMgZnVuY3Rpb24gY29waWVzIGEgRE9NIGVsZW1lbnQgYW5kIGFsbCBpdHMgZGVzY2VuZGFudHMgYW5kIHJldHVybnMKICAgICAqICB0aGUgbmV3IGNvcHkuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoSFRNTEVsZW1lbnQpIGVsZW0gLSBBIERPTSBlbGVtZW50LgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgQSBuZXcsIGNvcGllZCBET00gZWxlbWVudCB0cmVlLgogICAgICovCiAgICBjcmVhdGVIdG1sOiBmdW5jdGlvbiAoZWxlbSkKICAgIHsKICAgICAgICB2YXIgaSwgZWwsIGosIHRhZywgYXR0cmlidXRlLCB2YWx1ZSwgY3NzLCBjc3NBdHRycywgYXR0ciwgY3NzTmFtZSwgY3NzVmFsdWU7CiAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT0gU3Ryb3BoZS5FbGVtZW50VHlwZS5OT1JNQUwpIHsKICAgICAgICAgICAgdGFnID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBpZihTdHJvcGhlLlhIVE1MLnZhbGlkVGFnKHRhZykpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgZWwgPSBTdHJvcGhlLnhtbEVsZW1lbnQodGFnKTsKICAgICAgICAgICAgICAgICAgICBmb3IoaSA9IDA7IGkgPCBTdHJvcGhlLlhIVE1MLmF0dHJpYnV0ZXNbdGFnXS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGUgPSBTdHJvcGhlLlhIVE1MLmF0dHJpYnV0ZXNbdGFnXVtpXTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBlbGVtLmdldEF0dHJpYnV0ZShhdHRyaWJ1dGUpOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YgdmFsdWUgPT0gJ3VuZGVmaW5lZCcgfHwgdmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09ICcnIHx8IHZhbHVlID09PSBmYWxzZSB8fCB2YWx1ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYoYXR0cmlidXRlID09ICdzdHlsZScgJiYgdHlwZW9mIHZhbHVlID09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YgdmFsdWUuY3NzVGV4dCAhPSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuY3NzVGV4dDsgLy8gd2UncmUgZGVhbGluZyB3aXRoIElFLCBuZWVkIHRvIGdldCBDU1Mgb3V0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gZmlsdGVyIG91dCBpbnZhbGlkIGNzcyBzdHlsZXMKICAgICAgICAgICAgICAgICAgICAgICAgaWYoYXR0cmlidXRlID09ICdzdHlsZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNzcyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3NzQXR0cnMgPSB2YWx1ZS5zcGxpdCgnOycpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGogPSAwOyBqIDwgY3NzQXR0cnMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyID0gY3NzQXR0cnNbal0uc3BsaXQoJzonKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjc3NOYW1lID0gYXR0clswXS5yZXBsYWNlKC9eXHMqLywgIiIpLnJlcGxhY2UoL1xzKiQvLCAiIikudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihTdHJvcGhlLlhIVE1MLnZhbGlkQ1NTKGNzc05hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNzc1ZhbHVlID0gYXR0clsxXS5yZXBsYWNlKC9eXHMqLywgIiIpLnJlcGxhY2UoL1xzKiQvLCAiIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNzcy5wdXNoKGNzc05hbWUgKyAnOiAnICsgY3NzVmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGNzcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBjc3Muam9pbignOyAnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbC5zZXRBdHRyaWJ1dGUoYXR0cmlidXRlLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbC5zZXRBdHRyaWJ1dGUoYXR0cmlidXRlLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBlbGVtLmNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWwuYXBwZW5kQ2hpbGQoU3Ryb3BoZS5jcmVhdGVIdG1sKGVsZW0uY2hpbGROb2Rlc1tpXSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgeyAvLyBpbnZhbGlkIGVsZW1lbnRzCiAgICAgICAgICAgICAgICAgIGVsID0gU3Ryb3BoZS54bWxUZXh0Tm9kZSgnJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbCA9IFN0cm9waGUueG1sR2VuZXJhdG9yKCkuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGVsZW0uY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGVsLmFwcGVuZENoaWxkKFN0cm9waGUuY3JlYXRlSHRtbChlbGVtLmNoaWxkTm9kZXNbaV0pKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoZWxlbS5ub2RlVHlwZSA9PSBTdHJvcGhlLkVsZW1lbnRUeXBlLkZSQUdNRU5UKSB7CiAgICAgICAgICAgIGVsID0gU3Ryb3BoZS54bWxHZW5lcmF0b3IoKS5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBlbGVtLmNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGVsLmFwcGVuZENoaWxkKFN0cm9waGUuY3JlYXRlSHRtbChlbGVtLmNoaWxkTm9kZXNbaV0pKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoZWxlbS5ub2RlVHlwZSA9PSBTdHJvcGhlLkVsZW1lbnRUeXBlLlRFWFQpIHsKICAgICAgICAgICAgZWwgPSBTdHJvcGhlLnhtbFRleHROb2RlKGVsZW0ubm9kZVZhbHVlKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBlbDsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiBlc2NhcGVOb2RlCiAgICAgKiAgRXNjYXBlIHRoZSBub2RlIHBhcnQgKGFsc28gY2FsbGVkIGxvY2FsIHBhcnQpIG9mIGEgSklELgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cmluZykgbm9kZSAtIEEgbm9kZSAob3IgbG9jYWwgcGFydCkuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBBbiBlc2NhcGVkIG5vZGUgKG9yIGxvY2FsIHBhcnQpLgogICAgICovCiAgICBlc2NhcGVOb2RlOiBmdW5jdGlvbiAobm9kZSkKICAgIHsKICAgICAgICByZXR1cm4gbm9kZS5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpCiAgICAgICAgICAgIC5yZXBsYWNlKC9cXC9nLCAgIlxcNWMiKQogICAgICAgICAgICAucmVwbGFjZSgvIC9nLCAgICJcXDIwIikKICAgICAgICAgICAgLnJlcGxhY2UoL1wiL2csICAiXFwyMiIpCiAgICAgICAgICAgIC5yZXBsYWNlKC9cJi9nLCAgIlxcMjYiKQogICAgICAgICAgICAucmVwbGFjZSgvXCcvZywgICJcXDI3IikKICAgICAgICAgICAgLnJlcGxhY2UoL1wvL2csICAiXFwyZiIpCiAgICAgICAgICAgIC5yZXBsYWNlKC86L2csICAgIlxcM2EiKQogICAgICAgICAgICAucmVwbGFjZSgvPC9nLCAgICJcXDNjIikKICAgICAgICAgICAgLnJlcGxhY2UoLz4vZywgICAiXFwzZSIpCiAgICAgICAgICAgIC5yZXBsYWNlKC9AL2csICAgIlxcNDAiKTsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiB1bmVzY2FwZU5vZGUKICAgICAqICBVbmVzY2FwZSBhIG5vZGUgcGFydCAoYWxzbyBjYWxsZWQgbG9jYWwgcGFydCkgb2YgYSBKSUQuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoU3RyaW5nKSBub2RlIC0gQSBub2RlIChvciBsb2NhbCBwYXJ0KS4KICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgIEFuIHVuZXNjYXBlZCBub2RlIChvciBsb2NhbCBwYXJ0KS4KICAgICAqLwogICAgdW5lc2NhcGVOb2RlOiBmdW5jdGlvbiAobm9kZSkKICAgIHsKICAgICAgICByZXR1cm4gbm9kZS5yZXBsYWNlKC9cXDIwL2csICIgIikKICAgICAgICAgICAgLnJlcGxhY2UoL1xcMjIvZywgJyInKQogICAgICAgICAgICAucmVwbGFjZSgvXFwyNi9nLCAiJiIpCiAgICAgICAgICAgIC5yZXBsYWNlKC9cXDI3L2csICInIikKICAgICAgICAgICAgLnJlcGxhY2UoL1xcMmYvZywgIi8iKQogICAgICAgICAgICAucmVwbGFjZSgvXFwzYS9nLCAiOiIpCiAgICAgICAgICAgIC5yZXBsYWNlKC9cXDNjL2csICI8IikKICAgICAgICAgICAgLnJlcGxhY2UoL1xcM2UvZywgIj4iKQogICAgICAgICAgICAucmVwbGFjZSgvXFw0MC9nLCAiQCIpCiAgICAgICAgICAgIC5yZXBsYWNlKC9cXDVjL2csICJcXCIpOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IGdldE5vZGVGcm9tSmlkCiAgICAgKiAgR2V0IHRoZSBub2RlIHBvcnRpb24gb2YgYSBKSUQgU3RyaW5nLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cmluZykgamlkIC0gQSBKSUQuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBBIFN0cmluZyBjb250YWluaW5nIHRoZSBub2RlLgogICAgICovCiAgICBnZXROb2RlRnJvbUppZDogZnVuY3Rpb24gKGppZCkKICAgIHsKICAgICAgICBpZiAoamlkLmluZGV4T2YoIkAiKSA8IDApIHsgcmV0dXJuIG51bGw7IH0KICAgICAgICByZXR1cm4gamlkLnNwbGl0KCJAIilbMF07CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogZ2V0RG9tYWluRnJvbUppZAogICAgICogIEdldCB0aGUgZG9tYWluIHBvcnRpb24gb2YgYSBKSUQgU3RyaW5nLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cmluZykgamlkIC0gQSBKSUQuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBBIFN0cmluZyBjb250YWluaW5nIHRoZSBkb21haW4uCiAgICAgKi8KICAgIGdldERvbWFpbkZyb21KaWQ6IGZ1bmN0aW9uIChqaWQpCiAgICB7CiAgICAgICAgdmFyIGJhcmUgPSBTdHJvcGhlLmdldEJhcmVKaWRGcm9tSmlkKGppZCk7CiAgICAgICAgaWYgKGJhcmUuaW5kZXhPZigiQCIpIDwgMCkgewogICAgICAgICAgICByZXR1cm4gYmFyZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcGFydHMgPSBiYXJlLnNwbGl0KCJAIik7CiAgICAgICAgICAgIHBhcnRzLnNwbGljZSgwLCAxKTsKICAgICAgICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJ0AnKTsKICAgICAgICB9CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogZ2V0UmVzb3VyY2VGcm9tSmlkCiAgICAgKiAgR2V0IHRoZSByZXNvdXJjZSBwb3J0aW9uIG9mIGEgSklEIFN0cmluZy4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJpbmcpIGppZCAtIEEgSklELgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgQSBTdHJpbmcgY29udGFpbmluZyB0aGUgcmVzb3VyY2UuCiAgICAgKi8KICAgIGdldFJlc291cmNlRnJvbUppZDogZnVuY3Rpb24gKGppZCkKICAgIHsKICAgICAgICB2YXIgcyA9IGppZC5zcGxpdCgiLyIpOwogICAgICAgIGlmIChzLmxlbmd0aCA8IDIpIHsgcmV0dXJuIG51bGw7IH0KICAgICAgICBzLnNwbGljZSgwLCAxKTsKICAgICAgICByZXR1cm4gcy5qb2luKCcvJyk7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogZ2V0QmFyZUppZEZyb21KaWQKICAgICAqICBHZXQgdGhlIGJhcmUgSklEIGZyb20gYSBKSUQgU3RyaW5nLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cmluZykgamlkIC0gQSBKSUQuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBBIFN0cmluZyBjb250YWluaW5nIHRoZSBiYXJlIEpJRC4KICAgICAqLwogICAgZ2V0QmFyZUppZEZyb21KaWQ6IGZ1bmN0aW9uIChqaWQpCiAgICB7CiAgICAgICAgcmV0dXJuIGppZCA/IGppZC5zcGxpdCgiLyIpWzBdIDogbnVsbDsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiBsb2cKICAgICAqICBVc2VyIG92ZXJyaWRlYWJsZSBsb2dnaW5nIGZ1bmN0aW9uLgogICAgICoKICAgICAqICBUaGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCB3aGVuZXZlciB0aGUgU3Ryb3BoZSBsaWJyYXJ5IGNhbGxzIGFueQogICAgICogIG9mIHRoZSBsb2dnaW5nIGZ1bmN0aW9ucy4gIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIG9mIHRoaXMKICAgICAqICBmdW5jdGlvbiBkb2VzIG5vdGhpbmcuICBJZiBjbGllbnQgY29kZSB3aXNoZXMgdG8gaGFuZGxlIHRoZSBsb2dnaW5nCiAgICAgKiAgbWVzc2FnZXMsIGl0IHNob3VsZCBvdmVycmlkZSB0aGlzIHdpdGgKICAgICAqICA+IFN0cm9waGUubG9nID0gZnVuY3Rpb24gKGxldmVsLCBtc2cpIHsKICAgICAqICA+ICAgKHVzZXIgY29kZSBoZXJlKQogICAgICogID4gfTsKICAgICAqCiAgICAgKiAgUGxlYXNlIG5vdGUgdGhhdCBkYXRhIHNlbnQgYW5kIHJlY2VpdmVkIG92ZXIgdGhlIHdpcmUgaXMgbG9nZ2VkCiAgICAgKiAgdmlhIFN0cm9waGUuQ29ubmVjdGlvbi5yYXdJbnB1dCgpIGFuZCBTdHJvcGhlLkNvbm5lY3Rpb24ucmF3T3V0cHV0KCkuCiAgICAgKgogICAgICogIFRoZSBkaWZmZXJlbnQgbGV2ZWxzIGFuZCB0aGVpciBtZWFuaW5ncyBhcmUKICAgICAqCiAgICAgKiAgICBERUJVRyAtIE1lc3NhZ2VzIHVzZWZ1bCBmb3IgZGVidWdnaW5nIHB1cnBvc2VzLgogICAgICogICAgSU5GTyAtIEluZm9ybWF0aW9uYWwgbWVzc2FnZXMuICBUaGlzIGlzIG1vc3RseSBpbmZvcm1hdGlvbiBsaWtlCiAgICAgKiAgICAgICdkaXNjb25uZWN0IHdhcyBjYWxsZWQnIG9yICdTQVNMIGF1dGggc3VjY2VlZGVkJy4KICAgICAqICAgIFdBUk4gLSBXYXJuaW5ncyBhYm91dCBwb3RlbnRpYWwgcHJvYmxlbXMuICBUaGlzIGlzIG1vc3RseSB1c2VkCiAgICAgKiAgICAgIHRvIHJlcG9ydCB0cmFuc2llbnQgY29ubmVjdGlvbiBlcnJvcnMgbGlrZSByZXF1ZXN0IHRpbWVvdXRzLgogICAgICogICAgRVJST1IgLSBTb21lIGVycm9yIG9jY3VycmVkLgogICAgICogICAgRkFUQUwgLSBBIG5vbi1yZWNvdmVyYWJsZSBmYXRhbCBlcnJvciBvY2N1cnJlZC4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChJbnRlZ2VyKSBsZXZlbCAtIFRoZSBsb2cgbGV2ZWwgb2YgdGhlIGxvZyBtZXNzYWdlLiAgVGhpcyB3aWxsCiAgICAgKiAgICAgIGJlIG9uZSBvZiB0aGUgdmFsdWVzIGluIFN0cm9waGUuTG9nTGV2ZWwuCiAgICAgKiAgICAoU3RyaW5nKSBtc2cgLSBUaGUgbG9nIG1lc3NhZ2UuCiAgICAgKi8KICAgIC8qIGpzaGludCBpZ25vcmU6c3RhcnQgKi8KICAgIGxvZzogZnVuY3Rpb24gKGxldmVsLCBtc2cpCiAgICB7CiAgICAgICAgcmV0dXJuOwogICAgfSwKICAgIC8qIGpzaGludCBpZ25vcmU6ZW5kICovCgogICAgLyoqIEZ1bmN0aW9uOiBkZWJ1ZwogICAgICogIExvZyBhIG1lc3NhZ2UgYXQgdGhlIFN0cm9waGUuTG9nTGV2ZWwuREVCVUcgbGV2ZWwuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoU3RyaW5nKSBtc2cgLSBUaGUgbG9nIG1lc3NhZ2UuCiAgICAgKi8KICAgIGRlYnVnOiBmdW5jdGlvbihtc2cpCiAgICB7CiAgICAgICAgdGhpcy5sb2codGhpcy5Mb2dMZXZlbC5ERUJVRywgbXNnKTsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiBpbmZvCiAgICAgKiAgTG9nIGEgbWVzc2FnZSBhdCB0aGUgU3Ryb3BoZS5Mb2dMZXZlbC5JTkZPIGxldmVsLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cmluZykgbXNnIC0gVGhlIGxvZyBtZXNzYWdlLgogICAgICovCiAgICBpbmZvOiBmdW5jdGlvbiAobXNnKQogICAgewogICAgICAgIHRoaXMubG9nKHRoaXMuTG9nTGV2ZWwuSU5GTywgbXNnKTsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiB3YXJuCiAgICAgKiAgTG9nIGEgbWVzc2FnZSBhdCB0aGUgU3Ryb3BoZS5Mb2dMZXZlbC5XQVJOIGxldmVsLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cmluZykgbXNnIC0gVGhlIGxvZyBtZXNzYWdlLgogICAgICovCiAgICB3YXJuOiBmdW5jdGlvbiAobXNnKQogICAgewogICAgICAgIHRoaXMubG9nKHRoaXMuTG9nTGV2ZWwuV0FSTiwgbXNnKTsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiBlcnJvcgogICAgICogIExvZyBhIG1lc3NhZ2UgYXQgdGhlIFN0cm9waGUuTG9nTGV2ZWwuRVJST1IgbGV2ZWwuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoU3RyaW5nKSBtc2cgLSBUaGUgbG9nIG1lc3NhZ2UuCiAgICAgKi8KICAgIGVycm9yOiBmdW5jdGlvbiAobXNnKQogICAgewogICAgICAgIHRoaXMubG9nKHRoaXMuTG9nTGV2ZWwuRVJST1IsIG1zZyk7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogZmF0YWwKICAgICAqICBMb2cgYSBtZXNzYWdlIGF0IHRoZSBTdHJvcGhlLkxvZ0xldmVsLkZBVEFMIGxldmVsLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cmluZykgbXNnIC0gVGhlIGxvZyBtZXNzYWdlLgogICAgICovCiAgICBmYXRhbDogZnVuY3Rpb24gKG1zZykKICAgIHsKICAgICAgICB0aGlzLmxvZyh0aGlzLkxvZ0xldmVsLkZBVEFMLCBtc2cpOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IHNlcmlhbGl6ZQogICAgICogIFJlbmRlciBhIERPTSBlbGVtZW50IGFuZCBhbGwgZGVzY2VuZGFudHMgdG8gYSBTdHJpbmcuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoWE1MRWxlbWVudCkgZWxlbSAtIEEgRE9NIGVsZW1lbnQuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBUaGUgc2VyaWFsaXplZCBlbGVtZW50IHRyZWUgYXMgYSBTdHJpbmcuCiAgICAgKi8KICAgIHNlcmlhbGl6ZTogZnVuY3Rpb24gKGVsZW0pCiAgICB7CiAgICAgICAgdmFyIHJlc3VsdDsKCiAgICAgICAgaWYgKCFlbGVtKSB7IHJldHVybiBudWxsOyB9CgogICAgICAgIGlmICh0eXBlb2YoZWxlbS50cmVlKSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBlbGVtID0gZWxlbS50cmVlKCk7CiAgICAgICAgfQoKICAgICAgICB2YXIgbm9kZU5hbWUgPSBlbGVtLm5vZGVOYW1lOwogICAgICAgIHZhciBpLCBjaGlsZDsKCiAgICAgICAgaWYgKGVsZW0uZ2V0QXR0cmlidXRlKCJfcmVhbG5hbWUiKSkgewogICAgICAgICAgICBub2RlTmFtZSA9IGVsZW0uZ2V0QXR0cmlidXRlKCJfcmVhbG5hbWUiKTsKICAgICAgICB9CgogICAgICAgIHJlc3VsdCA9ICI8IiArIG5vZGVOYW1lOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBlbGVtLmF0dHJpYnV0ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgaWYoZWxlbS5hdHRyaWJ1dGVzW2ldLm5vZGVOYW1lICE9ICJfcmVhbG5hbWUiKSB7CiAgICAgICAgICAgICAgICAgcmVzdWx0ICs9ICIgIiArIGVsZW0uYXR0cmlidXRlc1tpXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICsKICAgICAgICAgICAgICAgICI9JyIgKyBlbGVtLmF0dHJpYnV0ZXNbaV0udmFsdWUKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvJi9nLCAiJmFtcDsiKQogICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cJy9nLCAiJmFwb3M7IikKICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvPi9nLCAiJmd0OyIpCiAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoLzwvZywgIiZsdDsiKSArICInIjsKICAgICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGVsZW0uY2hpbGROb2Rlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHJlc3VsdCArPSAiPiI7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBlbGVtLmNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGNoaWxkID0gZWxlbS5jaGlsZE5vZGVzW2ldOwogICAgICAgICAgICAgICAgc3dpdGNoKCBjaGlsZC5ub2RlVHlwZSApewogICAgICAgICAgICAgICAgICBjYXNlIFN0cm9waGUuRWxlbWVudFR5cGUuTk9STUFMOgogICAgICAgICAgICAgICAgICAgIC8vIG5vcm1hbCBlbGVtZW50LCBzbyByZWN1cnNlCiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ICs9IFN0cm9waGUuc2VyaWFsaXplKGNoaWxkKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBTdHJvcGhlLkVsZW1lbnRUeXBlLlRFWFQ6CiAgICAgICAgICAgICAgICAgICAgLy8gdGV4dCBlbGVtZW50IHRvIGVzY2FwZSB2YWx1ZXMKICAgICAgICAgICAgICAgICAgICByZXN1bHQgKz0gU3Ryb3BoZS54bWxlc2NhcGUoY2hpbGQubm9kZVZhbHVlKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBTdHJvcGhlLkVsZW1lbnRUeXBlLkNEQVRBOgogICAgICAgICAgICAgICAgICAgIC8vIGNkYXRhIHNlY3Rpb24gc28gZG9uJ3QgZXNjYXBlIHZhbHVlcwogICAgICAgICAgICAgICAgICAgIHJlc3VsdCArPSAiPCFbQ0RBVEFbIitjaGlsZC5ub2RlVmFsdWUrIl1dPiI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0ICs9ICI8LyIgKyBub2RlTmFtZSArICI+IjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXN1bHQgKz0gIi8+IjsKICAgICAgICB9CgogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlVmFyaWFibGU6IF9yZXF1ZXN0SWQKICAgICAqICBfUHJpdmF0ZV8gdmFyaWFibGUgdGhhdCBrZWVwcyB0cmFjayBvZiB0aGUgcmVxdWVzdCBpZHMgZm9yCiAgICAgKiAgY29ubmVjdGlvbnMuCiAgICAgKi8KICAgIF9yZXF1ZXN0SWQ6IDAsCgogICAgLyoqIFByaXZhdGVWYXJpYWJsZTogU3Ryb3BoZS5jb25uZWN0aW9uUGx1Z2lucwogICAgICogIF9Qcml2YXRlXyB2YXJpYWJsZSBVc2VkIHRvIHN0b3JlIHBsdWdpbiBuYW1lcyB0aGF0IG5lZWQKICAgICAqICBpbml0aWFsaXphdGlvbiBvbiBTdHJvcGhlLkNvbm5lY3Rpb24gY29uc3RydWN0aW9uLgogICAgICovCiAgICBfY29ubmVjdGlvblBsdWdpbnM6IHt9LAoKICAgIC8qKiBGdW5jdGlvbjogYWRkQ29ubmVjdGlvblBsdWdpbgogICAgICogIEV4dGVuZHMgdGhlIFN0cm9waGUuQ29ubmVjdGlvbiBvYmplY3Qgd2l0aCB0aGUgZ2l2ZW4gcGx1Z2luLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cmluZykgbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBleHRlbnNpb24uCiAgICAgKiAgICAoT2JqZWN0KSBwdHlwZSAtIFRoZSBwbHVnaW4ncyBwcm90b3R5cGUuCiAgICAgKi8KICAgIGFkZENvbm5lY3Rpb25QbHVnaW46IGZ1bmN0aW9uIChuYW1lLCBwdHlwZSkKICAgIHsKICAgICAgICBTdHJvcGhlLl9jb25uZWN0aW9uUGx1Z2luc1tuYW1lXSA9IHB0eXBlOwogICAgfQp9OwoKLyoqIENsYXNzOiBTdHJvcGhlLkJ1aWxkZXIKICogIFhNTCBET00gYnVpbGRlci4KICoKICogIFRoaXMgb2JqZWN0IHByb3ZpZGVzIGFuIGludGVyZmFjZSBzaW1pbGFyIHRvIEpRdWVyeSBidXQgZm9yIGJ1aWxkaW5nCiAqICBET00gZWxlbWVudCBlYXNpbHkgYW5kIHJhcGlkbHkuICBBbGwgdGhlIGZ1bmN0aW9ucyBleGNlcHQgZm9yIHRvU3RyaW5nKCkKICogIGFuZCB0cmVlKCkgcmV0dXJuIHRoZSBvYmplY3QsIHNvIGNhbGxzIGNhbiBiZSBjaGFpbmVkLiAgSGVyZSdzIGFuCiAqICBleGFtcGxlIHVzaW5nIHRoZSAkaXEoKSBidWlsZGVyIGhlbHBlci4KICogID4gJGlxKHt0bzogJ3lvdScsIGZyb206ICdtZScsIHR5cGU6ICdnZXQnLCBpZDogJzEnfSkKICogID4gICAgIC5jKCdxdWVyeScsIHt4bWxuczogJ3N0cm9waGU6ZXhhbXBsZSd9KQogKiAgPiAgICAgLmMoJ2V4YW1wbGUnKQogKiAgPiAgICAgLnRvU3RyaW5nKCkKICogIFRoZSBhYm92ZSBnZW5lcmF0ZXMgdGhpcyBYTUwgZnJhZ21lbnQKICogID4gPGlxIHRvPSd5b3UnIGZyb209J21lJyB0eXBlPSdnZXQnIGlkPScxJz4KICogID4gICA8cXVlcnkgeG1sbnM9J3N0cm9waGU6ZXhhbXBsZSc+CiAqICA+ICAgICA8ZXhhbXBsZS8+CiAqICA+ICAgPC9xdWVyeT4KICogID4gPC9pcT4KICogIFRoZSBjb3JyZXNwb25kaW5nIERPTSBtYW5pcHVsYXRpb25zIHRvIGdldCBhIHNpbWlsYXIgZnJhZ21lbnQgd291bGQgYmUKICogIGEgbG90IG1vcmUgdGVkaW91cyBhbmQgcHJvYmFibHkgaW52b2x2ZSBzZXZlcmFsIGhlbHBlciB2YXJpYWJsZXMuCiAqCiAqICBTaW5jZSBhZGRpbmcgY2hpbGRyZW4gbWFrZXMgbmV3IG9wZXJhdGlvbnMgb3BlcmF0ZSBvbiB0aGUgY2hpbGQsIHVwKCkKICogIGlzIHByb3ZpZGVkIHRvIHRyYXZlcnNlIHVwIHRoZSB0cmVlLiAgVG8gYWRkIHR3byBjaGlsZHJlbiwgZG8KICogID4gYnVpbGRlci5jKCdjaGlsZDEnLCAuLi4pLnVwKCkuYygnY2hpbGQyJywgLi4uKQogKiAgVGhlIG5leHQgb3BlcmF0aW9uIG9uIHRoZSBCdWlsZGVyIHdpbGwgYmUgcmVsYXRpdmUgdG8gdGhlIHNlY29uZCBjaGlsZC4KICovCgovKiogQ29uc3RydWN0b3I6IFN0cm9waGUuQnVpbGRlcgogKiAgQ3JlYXRlIGEgU3Ryb3BoZS5CdWlsZGVyIG9iamVjdC4KICoKICogIFRoZSBhdHRyaWJ1dGVzIHNob3VsZCBiZSBwYXNzZWQgaW4gb2JqZWN0IG5vdGF0aW9uLiAgRm9yIGV4YW1wbGUKICogID4gdmFyIGIgPSBuZXcgQnVpbGRlcignbWVzc2FnZScsIHt0bzogJ3lvdScsIGZyb206ICdtZSd9KTsKICogIG9yCiAqICA+IHZhciBiID0gbmV3IEJ1aWxkZXIoJ21lc3NzYWdlJywgeyd4bWw6bGFuZyc6ICdlbid9KTsKICoKICogIFBhcmFtZXRlcnM6CiAqICAgIChTdHJpbmcpIG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgcm9vdCBlbGVtZW50LgogKiAgICAoT2JqZWN0KSBhdHRycyAtIFRoZSBhdHRyaWJ1dGVzIGZvciB0aGUgcm9vdCBlbGVtZW50IGluIG9iamVjdCBub3RhdGlvbi4KICoKICogIFJldHVybnM6CiAqICAgIEEgbmV3IFN0cm9waGUuQnVpbGRlci4KICovClN0cm9waGUuQnVpbGRlciA9IGZ1bmN0aW9uIChuYW1lLCBhdHRycykKewogICAgLy8gU2V0IGNvcnJlY3QgbmFtZXNwYWNlIGZvciBqYWJiZXI6Y2xpZW50IGVsZW1lbnRzCiAgICBpZiAobmFtZSA9PSAicHJlc2VuY2UiIHx8IG5hbWUgPT0gIm1lc3NhZ2UiIHx8IG5hbWUgPT0gImlxIikgewogICAgICAgIGlmIChhdHRycyAmJiAhYXR0cnMueG1sbnMpIHsKICAgICAgICAgICAgYXR0cnMueG1sbnMgPSBTdHJvcGhlLk5TLkNMSUVOVDsKICAgICAgICB9IGVsc2UgaWYgKCFhdHRycykgewogICAgICAgICAgICBhdHRycyA9IHt4bWxuczogU3Ryb3BoZS5OUy5DTElFTlR9OwogICAgICAgIH0KICAgIH0KCiAgICAvLyBIb2xkcyB0aGUgdHJlZSBiZWluZyBidWlsdC4KICAgIHRoaXMubm9kZVRyZWUgPSBTdHJvcGhlLnhtbEVsZW1lbnQobmFtZSwgYXR0cnMpOwoKICAgIC8vIFBvaW50cyB0byB0aGUgY3VycmVudCBvcGVyYXRpb24gbm9kZS4KICAgIHRoaXMubm9kZSA9IHRoaXMubm9kZVRyZWU7Cn07CgpTdHJvcGhlLkJ1aWxkZXIucHJvdG90eXBlID0gewogICAgLyoqIEZ1bmN0aW9uOiB0cmVlCiAgICAgKiAgUmV0dXJuIHRoZSBET00gdHJlZS4KICAgICAqCiAgICAgKiAgVGhpcyBmdW5jdGlvbiByZXR1cm5zIHRoZSBjdXJyZW50IERPTSB0cmVlIGFzIGFuIGVsZW1lbnQgb2JqZWN0LiAgVGhpcwogICAgICogIGlzIHN1aXRhYmxlIGZvciBwYXNzaW5nIHRvIGZ1bmN0aW9ucyBsaWtlIFN0cm9waGUuQ29ubmVjdGlvbi5zZW5kKCkuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBUaGUgRE9NIHRyZWUgYXMgYSBlbGVtZW50IG9iamVjdC4KICAgICAqLwogICAgdHJlZTogZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICByZXR1cm4gdGhpcy5ub2RlVHJlZTsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiB0b1N0cmluZwogICAgICogIFNlcmlhbGl6ZSB0aGUgRE9NIHRyZWUgdG8gYSBTdHJpbmcuCiAgICAgKgogICAgICogIFRoaXMgZnVuY3Rpb24gcmV0dXJucyBhIHN0cmluZyBzZXJpYWxpemF0aW9uIG9mIHRoZSBjdXJyZW50IERPTQogICAgICogIHRyZWUuICBJdCBpcyBvZnRlbiB1c2VkIGludGVybmFsbHkgdG8gcGFzcyBkYXRhIHRvIGEKICAgICAqICBTdHJvcGhlLlJlcXVlc3Qgb2JqZWN0LgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgVGhlIHNlcmlhbGl6ZWQgRE9NIHRyZWUgaW4gYSBTdHJpbmcuCiAgICAgKi8KICAgIHRvU3RyaW5nOiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIHJldHVybiBTdHJvcGhlLnNlcmlhbGl6ZSh0aGlzLm5vZGVUcmVlKTsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiB1cAogICAgICogIE1ha2UgdGhlIGN1cnJlbnQgcGFyZW50IGVsZW1lbnQgdGhlIG5ldyBjdXJyZW50IGVsZW1lbnQuCiAgICAgKgogICAgICogIFRoaXMgZnVuY3Rpb24gaXMgb2Z0ZW4gdXNlZCBhZnRlciBjKCkgdG8gdHJhdmVyc2UgYmFjayB1cCB0aGUgdHJlZS4KICAgICAqICBGb3IgZXhhbXBsZSwgdG8gYWRkIHR3byBjaGlsZHJlbiB0byB0aGUgc2FtZSBlbGVtZW50CiAgICAgKiAgPiBidWlsZGVyLmMoJ2NoaWxkMScsIHt9KS51cCgpLmMoJ2NoaWxkMicsIHt9KTsKICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgIFRoZSBTdG9waGUuQnVpbGRlciBvYmplY3QuCiAgICAgKi8KICAgIHVwOiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIHRoaXMubm9kZSA9IHRoaXMubm9kZS5wYXJlbnROb2RlOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IGF0dHJzCiAgICAgKiAgQWRkIG9yIG1vZGlmeSBhdHRyaWJ1dGVzIG9mIHRoZSBjdXJyZW50IGVsZW1lbnQuCiAgICAgKgogICAgICogIFRoZSBhdHRyaWJ1dGVzIHNob3VsZCBiZSBwYXNzZWQgaW4gb2JqZWN0IG5vdGF0aW9uLiAgVGhpcyBmdW5jdGlvbgogICAgICogIGRvZXMgbm90IG1vdmUgdGhlIGN1cnJlbnQgZWxlbWVudCBwb2ludGVyLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKE9iamVjdCkgbW9yZWF0dHJzIC0gVGhlIGF0dHJpYnV0ZXMgdG8gYWRkL21vZGlmeSBpbiBvYmplY3Qgbm90YXRpb24uCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBUaGUgU3Ryb3BoZS5CdWlsZGVyIG9iamVjdC4KICAgICAqLwogICAgYXR0cnM6IGZ1bmN0aW9uIChtb3JlYXR0cnMpCiAgICB7CiAgICAgICAgZm9yICh2YXIgayBpbiBtb3JlYXR0cnMpIHsKICAgICAgICAgICAgaWYgKG1vcmVhdHRycy5oYXNPd25Qcm9wZXJ0eShrKSkgewogICAgICAgICAgICAgICAgdGhpcy5ub2RlLnNldEF0dHJpYnV0ZShrLCBtb3JlYXR0cnNba10pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IGMKICAgICAqICBBZGQgYSBjaGlsZCB0byB0aGUgY3VycmVudCBlbGVtZW50IGFuZCBtYWtlIGl0IHRoZSBuZXcgY3VycmVudAogICAgICogIGVsZW1lbnQuCiAgICAgKgogICAgICogIFRoaXMgZnVuY3Rpb24gbW92ZXMgdGhlIGN1cnJlbnQgZWxlbWVudCBwb2ludGVyIHRvIHRoZSBjaGlsZCwKICAgICAqICB1bmxlc3MgdGV4dCBpcyBwcm92aWRlZC4gIElmIHlvdSBuZWVkIHRvIGFkZCBhbm90aGVyIGNoaWxkLCBpdAogICAgICogIGlzIG5lY2Vzc2FyeSB0byB1c2UgdXAoKSB0byBnbyBiYWNrIHRvIHRoZSBwYXJlbnQgaW4gdGhlIHRyZWUuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoU3RyaW5nKSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIGNoaWxkLgogICAgICogICAgKE9iamVjdCkgYXR0cnMgLSBUaGUgYXR0cmlidXRlcyBvZiB0aGUgY2hpbGQgaW4gb2JqZWN0IG5vdGF0aW9uLgogICAgICogICAgKFN0cmluZykgdGV4dCAtIFRoZSB0ZXh0IHRvIGFkZCB0byB0aGUgY2hpbGQuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBUaGUgU3Ryb3BoZS5CdWlsZGVyIG9iamVjdC4KICAgICAqLwogICAgYzogZnVuY3Rpb24gKG5hbWUsIGF0dHJzLCB0ZXh0KQogICAgewogICAgICAgIHZhciBjaGlsZCA9IFN0cm9waGUueG1sRWxlbWVudChuYW1lLCBhdHRycywgdGV4dCk7CiAgICAgICAgdGhpcy5ub2RlLmFwcGVuZENoaWxkKGNoaWxkKTsKICAgICAgICBpZiAoIXRleHQpIHsKICAgICAgICAgICAgdGhpcy5ub2RlID0gY2hpbGQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IGNub2RlCiAgICAgKiAgQWRkIGEgY2hpbGQgdG8gdGhlIGN1cnJlbnQgZWxlbWVudCBhbmQgbWFrZSBpdCB0aGUgbmV3IGN1cnJlbnQKICAgICAqICBlbGVtZW50LgogICAgICoKICAgICAqICBUaGlzIGZ1bmN0aW9uIGlzIHRoZSBzYW1lIGFzIGMoKSBleGNlcHQgdGhhdCBpbnN0ZWFkIG9mIHVzaW5nIGEKICAgICAqICBuYW1lIGFuZCBhbiBhdHRyaWJ1dGVzIG9iamVjdCB0byBjcmVhdGUgdGhlIGNoaWxkIGl0IHVzZXMgYW4KICAgICAqICBleGlzdGluZyBET00gZWxlbWVudCBvYmplY3QuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoWE1MRWxlbWVudCkgZWxlbSAtIEEgRE9NIGVsZW1lbnQuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBUaGUgU3Ryb3BoZS5CdWlsZGVyIG9iamVjdC4KICAgICAqLwogICAgY25vZGU6IGZ1bmN0aW9uIChlbGVtKQogICAgewogICAgICAgIHZhciBpbXBOb2RlOwogICAgICAgIHZhciB4bWxHZW4gPSBTdHJvcGhlLnhtbEdlbmVyYXRvcigpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGltcE5vZGUgPSAoeG1sR2VuLmltcG9ydE5vZGUgIT09IHVuZGVmaW5lZCk7CiAgICAgICAgfQogICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgIGltcE5vZGUgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdmFyIG5ld0VsZW0gPSBpbXBOb2RlID8KICAgICAgICAgICAgICAgICAgICAgIHhtbEdlbi5pbXBvcnROb2RlKGVsZW0sIHRydWUpIDoKICAgICAgICAgICAgICAgICAgICAgIFN0cm9waGUuY29weUVsZW1lbnQoZWxlbSk7CiAgICAgICAgdGhpcy5ub2RlLmFwcGVuZENoaWxkKG5ld0VsZW0pOwogICAgICAgIHRoaXMubm9kZSA9IG5ld0VsZW07CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogdAogICAgICogIEFkZCBhIGNoaWxkIHRleHQgZWxlbWVudC4KICAgICAqCiAgICAgKiAgVGhpcyAqZG9lcyBub3QqIG1ha2UgdGhlIGNoaWxkIHRoZSBuZXcgY3VycmVudCBlbGVtZW50IHNpbmNlIHRoZXJlCiAgICAgKiAgYXJlIG5vIGNoaWxkcmVuIG9mIHRleHQgZWxlbWVudHMuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoU3RyaW5nKSB0ZXh0IC0gVGhlIHRleHQgZGF0YSB0byBhcHBlbmQgdG8gdGhlIGN1cnJlbnQgZWxlbWVudC4KICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgIFRoZSBTdHJvcGhlLkJ1aWxkZXIgb2JqZWN0LgogICAgICovCiAgICB0OiBmdW5jdGlvbiAodGV4dCkKICAgIHsKICAgICAgICB2YXIgY2hpbGQgPSBTdHJvcGhlLnhtbFRleHROb2RlKHRleHQpOwogICAgICAgIHRoaXMubm9kZS5hcHBlbmRDaGlsZChjaGlsZCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogaAogICAgICogIFJlcGxhY2UgY3VycmVudCBlbGVtZW50IGNvbnRlbnRzIHdpdGggdGhlIEhUTUwgcGFzc2VkIGluLgogICAgICoKICAgICAqICBUaGlzICpkb2VzIG5vdCogbWFrZSB0aGUgY2hpbGQgdGhlIG5ldyBjdXJyZW50IGVsZW1lbnQKICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJpbmcpIGh0bWwgLSBUaGUgaHRtbCB0byBpbnNlcnQgYXMgY29udGVudHMgb2YgY3VycmVudCBlbGVtZW50LgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgVGhlIFN0cm9waGUuQnVpbGRlciBvYmplY3QuCiAgICAgKi8KICAgIGg6IGZ1bmN0aW9uIChodG1sKQogICAgewogICAgICAgIHZhciBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2JvZHknKTsKCiAgICAgICAgLy8gZm9yY2UgdGhlIGJyb3dzZXIgdG8gdHJ5IGFuZCBmaXggYW55IGludmFsaWQgSFRNTCB0YWdzCiAgICAgICAgZnJhZ21lbnQuaW5uZXJIVE1MID0gaHRtbDsKCiAgICAgICAgLy8gY29weSBjbGVhbmVkIGh0bWwgaW50byBhbiB4bWwgZG9tCiAgICAgICAgdmFyIHhodG1sID0gU3Ryb3BoZS5jcmVhdGVIdG1sKGZyYWdtZW50KTsKCiAgICAgICAgd2hpbGUoeGh0bWwuY2hpbGROb2Rlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHRoaXMubm9kZS5hcHBlbmRDaGlsZCh4aHRtbC5jaGlsZE5vZGVzWzBdKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9Cn07CgovKiogUHJpdmF0ZUNsYXNzOiBTdHJvcGhlLkhhbmRsZXIKICogIF9Qcml2YXRlXyBoZWxwZXIgY2xhc3MgZm9yIG1hbmFnaW5nIHN0YW56YSBoYW5kbGVycy4KICoKICogIEEgU3Ryb3BoZS5IYW5kbGVyIGVuY2Fwc3VsYXRlcyBhIHVzZXIgcHJvdmlkZWQgY2FsbGJhY2sgZnVuY3Rpb24gdG8gYmUKICogIGV4ZWN1dGVkIHdoZW4gbWF0Y2hpbmcgc3RhbnphcyBhcmUgcmVjZWl2ZWQgYnkgdGhlIGNvbm5lY3Rpb24uCiAqICBIYW5kbGVycyBjYW4gYmUgZWl0aGVyIG9uZS1vZmYgb3IgcGVyc2lzdGFudCBkZXBlbmRpbmcgb24gdGhlaXIKICogIHJldHVybiB2YWx1ZS4gUmV0dXJuaW5nIHRydWUgd2lsbCBjYXVzZSBhIEhhbmRsZXIgdG8gcmVtYWluIGFjdGl2ZSwgYW5kCiAqICByZXR1cm5pbmcgZmFsc2Ugd2lsbCByZW1vdmUgdGhlIEhhbmRsZXIuCiAqCiAqICBVc2VycyB3aWxsIG5vdCB1c2UgU3Ryb3BoZS5IYW5kbGVyIG9iamVjdHMgZGlyZWN0bHksIGJ1dCBpbnN0ZWFkIHRoZXkKICogIHdpbGwgdXNlIFN0cm9waGUuQ29ubmVjdGlvbi5hZGRIYW5kbGVyKCkgYW5kCiAqICBTdHJvcGhlLkNvbm5lY3Rpb24uZGVsZXRlSGFuZGxlcigpLgogKi8KCi8qKiBQcml2YXRlQ29uc3RydWN0b3I6IFN0cm9waGUuSGFuZGxlcgogKiAgQ3JlYXRlIGFuZCBpbml0aWFsaXplIGEgbmV3IFN0cm9waGUuSGFuZGxlci4KICoKICogIFBhcmFtZXRlcnM6CiAqICAgIChGdW5jdGlvbikgaGFuZGxlciAtIEEgZnVuY3Rpb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiB0aGUgaGFuZGxlciBpcyBydW4uCiAqICAgIChTdHJpbmcpIG5zIC0gVGhlIG5hbWVzcGFjZSB0byBtYXRjaC4KICogICAgKFN0cmluZykgbmFtZSAtIFRoZSBlbGVtZW50IG5hbWUgdG8gbWF0Y2guCiAqICAgIChTdHJpbmcpIHR5cGUgLSBUaGUgZWxlbWVudCB0eXBlIHRvIG1hdGNoLgogKiAgICAoU3RyaW5nKSBpZCAtIFRoZSBlbGVtZW50IGlkIGF0dHJpYnV0ZSB0byBtYXRjaC4KICogICAgKFN0cmluZykgZnJvbSAtIFRoZSBlbGVtZW50IGZyb20gYXR0cmlidXRlIHRvIG1hdGNoLgogKiAgICAoT2JqZWN0KSBvcHRpb25zIC0gSGFuZGxlciBvcHRpb25zCiAqCiAqICBSZXR1cm5zOgogKiAgICBBIG5ldyBTdHJvcGhlLkhhbmRsZXIgb2JqZWN0LgogKi8KU3Ryb3BoZS5IYW5kbGVyID0gZnVuY3Rpb24gKGhhbmRsZXIsIG5zLCBuYW1lLCB0eXBlLCBpZCwgZnJvbSwgb3B0aW9ucykKewogICAgdGhpcy5oYW5kbGVyID0gaGFuZGxlcjsKICAgIHRoaXMubnMgPSBuczsKICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgdGhpcy5pZCA9IGlkOwogICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucyB8fCB7bWF0Y2hCYXJlOiBmYWxzZX07CgogICAgLy8gZGVmYXVsdCBtYXRjaEJhcmUgdG8gZmFsc2UgaWYgdW5kZWZpbmVkCiAgICBpZiAoIXRoaXMub3B0aW9ucy5tYXRjaEJhcmUpIHsKICAgICAgICB0aGlzLm9wdGlvbnMubWF0Y2hCYXJlID0gZmFsc2U7CiAgICB9CgogICAgaWYgKHRoaXMub3B0aW9ucy5tYXRjaEJhcmUpIHsKICAgICAgICB0aGlzLmZyb20gPSBmcm9tID8gU3Ryb3BoZS5nZXRCYXJlSmlkRnJvbUppZChmcm9tKSA6IG51bGw7CiAgICB9IGVsc2UgewogICAgICAgIHRoaXMuZnJvbSA9IGZyb207CiAgICB9CgogICAgLy8gd2hldGhlciB0aGUgaGFuZGxlciBpcyBhIHVzZXIgaGFuZGxlciBvciBhIHN5c3RlbSBoYW5kbGVyCiAgICB0aGlzLnVzZXIgPSB0cnVlOwp9OwoKU3Ryb3BoZS5IYW5kbGVyLnByb3RvdHlwZSA9IHsKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IGlzTWF0Y2gKICAgICAqICBUZXN0cyBpZiBhIHN0YW56YSBtYXRjaGVzIHRoZSBTdHJvcGhlLkhhbmRsZXIuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoWE1MRWxlbWVudCkgZWxlbSAtIFRoZSBYTUwgZWxlbWVudCB0byB0ZXN0LgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgdHJ1ZSBpZiB0aGUgc3RhbnphIG1hdGNoZXMgYW5kIGZhbHNlIG90aGVyd2lzZS4KICAgICAqLwogICAgaXNNYXRjaDogZnVuY3Rpb24gKGVsZW0pCiAgICB7CiAgICAgICAgdmFyIG5zTWF0Y2g7CiAgICAgICAgdmFyIGZyb20gPSBudWxsOwoKICAgICAgICBpZiAodGhpcy5vcHRpb25zLm1hdGNoQmFyZSkgewogICAgICAgICAgICBmcm9tID0gU3Ryb3BoZS5nZXRCYXJlSmlkRnJvbUppZChlbGVtLmdldEF0dHJpYnV0ZSgnZnJvbScpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmcm9tID0gZWxlbS5nZXRBdHRyaWJ1dGUoJ2Zyb20nKTsKICAgICAgICB9CgogICAgICAgIG5zTWF0Y2ggPSBmYWxzZTsKICAgICAgICBpZiAoIXRoaXMubnMpIHsKICAgICAgICAgICAgbnNNYXRjaCA9IHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBTdHJvcGhlLmZvckVhY2hDaGlsZChlbGVtLCBudWxsLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgICAgaWYgKGVsZW0uZ2V0QXR0cmlidXRlKCJ4bWxucyIpID09IHRoYXQubnMpIHsKICAgICAgICAgICAgICAgICAgICBuc01hdGNoID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBuc01hdGNoID0gbnNNYXRjaCB8fCBlbGVtLmdldEF0dHJpYnV0ZSgieG1sbnMiKSA9PSB0aGlzLm5zOwogICAgICAgIH0KCiAgICAgICAgaWYgKG5zTWF0Y2ggJiYKICAgICAgICAgICAgKCF0aGlzLm5hbWUgfHwgU3Ryb3BoZS5pc1RhZ0VxdWFsKGVsZW0sIHRoaXMubmFtZSkpICYmCiAgICAgICAgICAgICghdGhpcy50eXBlIHx8IGVsZW0uZ2V0QXR0cmlidXRlKCJ0eXBlIikgPT0gdGhpcy50eXBlKSAmJgogICAgICAgICAgICAoIXRoaXMuaWQgfHwgZWxlbS5nZXRBdHRyaWJ1dGUoImlkIikgPT0gdGhpcy5pZCkgJiYKICAgICAgICAgICAgKCF0aGlzLmZyb20gfHwgZnJvbSA9PSB0aGlzLmZyb20pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogcnVuCiAgICAgKiAgUnVuIHRoZSBjYWxsYmFjayBvbiBhIG1hdGNoaW5nIHN0YW56YS4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChYTUxFbGVtZW50KSBlbGVtIC0gVGhlIERPTSBlbGVtZW50IHRoYXQgdHJpZ2dlcmVkIHRoZQogICAgICogICAgICBTdHJvcGhlLkhhbmRsZXIuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBBIGJvb2xlYW4gaW5kaWNhdGluZyBpZiB0aGUgaGFuZGxlciBzaG91bGQgcmVtYWluIGFjdGl2ZS4KICAgICAqLwogICAgcnVuOiBmdW5jdGlvbiAoZWxlbSkKICAgIHsKICAgICAgICB2YXIgcmVzdWx0ID0gbnVsbDsKICAgICAgICB0cnkgewogICAgICAgICAgICByZXN1bHQgPSB0aGlzLmhhbmRsZXIoZWxlbSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBpZiAoZS5zb3VyY2VVUkwpIHsKICAgICAgICAgICAgICAgIFN0cm9waGUuZmF0YWwoImVycm9yOiAiICsgdGhpcy5oYW5kbGVyICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiAiICsgZS5zb3VyY2VVUkwgKyAiOiIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlLmxpbmUgKyAiIC0gIiArIGUubmFtZSArICI6ICIgKyBlLm1lc3NhZ2UpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGUuZmlsZU5hbWUpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YoY29uc29sZSkgIT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLnRyYWNlKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcih0aGlzLmhhbmRsZXIsICIgLSBlcnJvciAtICIsIGUsIGUubWVzc2FnZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBTdHJvcGhlLmZhdGFsKCJlcnJvcjogIiArIHRoaXMuaGFuZGxlciArICIgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUuZmlsZU5hbWUgKyAiOiIgKyBlLmxpbmVOdW1iZXIgKyAiIC0gIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUubmFtZSArICI6ICIgKyBlLm1lc3NhZ2UpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgU3Ryb3BoZS5mYXRhbCgiZXJyb3I6ICIgKyBlLm1lc3NhZ2UgKyAiXG4iICsgZS5zdGFjayk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiB0b1N0cmluZwogICAgICogIEdldCBhIFN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgU3Ryb3BoZS5IYW5kbGVyIG9iamVjdC4KICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgIEEgU3RyaW5nLgogICAgICovCiAgICB0b1N0cmluZzogZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICByZXR1cm4gIntIYW5kbGVyOiAiICsgdGhpcy5oYW5kbGVyICsgIigiICsgdGhpcy5uYW1lICsgIiwiICsKICAgICAgICAgICAgdGhpcy5pZCArICIsIiArIHRoaXMubnMgKyAiKX0iOwogICAgfQp9OwoKLyoqIFByaXZhdGVDbGFzczogU3Ryb3BoZS5UaW1lZEhhbmRsZXIKICogIF9Qcml2YXRlXyBoZWxwZXIgY2xhc3MgZm9yIG1hbmFnaW5nIHRpbWVkIGhhbmRsZXJzLgogKgogKiAgQSBTdHJvcGhlLlRpbWVkSGFuZGxlciBlbmNhcHN1bGF0ZXMgYSB1c2VyIHByb3ZpZGVkIGNhbGxiYWNrIHRoYXQKICogIHNob3VsZCBiZSBjYWxsZWQgYWZ0ZXIgYSBjZXJ0YWluIHBlcmlvZCBvZiB0aW1lIG9yIGF0IHJlZ3VsYXIKICogIGludGVydmFscy4gIFRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGNhbGxiYWNrIGRldGVybWluZXMgd2hldGhlciB0aGUKICogIFN0cm9waGUuVGltZWRIYW5kbGVyIHdpbGwgY29udGludWUgdG8gZmlyZS4KICoKICogIFVzZXJzIHdpbGwgbm90IHVzZSBTdHJvcGhlLlRpbWVkSGFuZGxlciBvYmplY3RzIGRpcmVjdGx5LCBidXQgaW5zdGVhZAogKiAgdGhleSB3aWxsIHVzZSBTdHJvcGhlLkNvbm5lY3Rpb24uYWRkVGltZWRIYW5kbGVyKCkgYW5kCiAqICBTdHJvcGhlLkNvbm5lY3Rpb24uZGVsZXRlVGltZWRIYW5kbGVyKCkuCiAqLwoKLyoqIFByaXZhdGVDb25zdHJ1Y3RvcjogU3Ryb3BoZS5UaW1lZEhhbmRsZXIKICogIENyZWF0ZSBhbmQgaW5pdGlhbGl6ZSBhIG5ldyBTdHJvcGhlLlRpbWVkSGFuZGxlciBvYmplY3QuCiAqCiAqICBQYXJhbWV0ZXJzOgogKiAgICAoSW50ZWdlcikgcGVyaW9kIC0gVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gd2FpdCBiZWZvcmUgdGhlCiAqICAgICAgaGFuZGxlciBpcyBjYWxsZWQuCiAqICAgIChGdW5jdGlvbikgaGFuZGxlciAtIFRoZSBjYWxsYmFjayB0byBydW4gd2hlbiB0aGUgaGFuZGxlciBmaXJlcy4gIFRoaXMKICogICAgICBmdW5jdGlvbiBzaG91bGQgdGFrZSBubyBhcmd1bWVudHMuCiAqCiAqICBSZXR1cm5zOgogKiAgICBBIG5ldyBTdHJvcGhlLlRpbWVkSGFuZGxlciBvYmplY3QuCiAqLwpTdHJvcGhlLlRpbWVkSGFuZGxlciA9IGZ1bmN0aW9uIChwZXJpb2QsIGhhbmRsZXIpCnsKICAgIHRoaXMucGVyaW9kID0gcGVyaW9kOwogICAgdGhpcy5oYW5kbGVyID0gaGFuZGxlcjsKCiAgICB0aGlzLmxhc3RDYWxsZWQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIHRoaXMudXNlciA9IHRydWU7Cn07CgpTdHJvcGhlLlRpbWVkSGFuZGxlci5wcm90b3R5cGUgPSB7CiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBydW4KICAgICAqICBSdW4gdGhlIGNhbGxiYWNrIGZvciB0aGUgU3Ryb3BoZS5UaW1lZEhhbmRsZXIuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICB0cnVlIGlmIHRoZSBTdHJvcGhlLlRpbWVkSGFuZGxlciBzaG91bGQgYmUgY2FsbGVkIGFnYWluLCBhbmQgZmFsc2UKICAgICAqICAgICAgb3RoZXJ3aXNlLgogICAgICovCiAgICBydW46IGZ1bmN0aW9uICgpCiAgICB7CiAgICAgICAgdGhpcy5sYXN0Q2FsbGVkID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICAgICAgcmV0dXJuIHRoaXMuaGFuZGxlcigpOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiByZXNldAogICAgICogIFJlc2V0IHRoZSBsYXN0IGNhbGxlZCB0aW1lIGZvciB0aGUgU3Ryb3BoZS5UaW1lZEhhbmRsZXIuCiAgICAgKi8KICAgIHJlc2V0OiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIHRoaXMubGFzdENhbGxlZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiB0b1N0cmluZwogICAgICogIEdldCBhIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgU3Ryb3BoZS5UaW1lZEhhbmRsZXIgb2JqZWN0LgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgVGhlIHN0cmluZyByZXByZXNlbnRhdGlvbi4KICAgICAqLwogICAgdG9TdHJpbmc6IGZ1bmN0aW9uICgpCiAgICB7CiAgICAgICAgcmV0dXJuICJ7VGltZWRIYW5kbGVyOiAiICsgdGhpcy5oYW5kbGVyICsgIigiICsgdGhpcy5wZXJpb2QgKyIpfSI7CiAgICB9Cn07CgovKiogQ2xhc3M6IFN0cm9waGUuQ29ubmVjdGlvbgogKiAgWE1QUCBDb25uZWN0aW9uIG1hbmFnZXIuCiAqCiAqICBUaGlzIGNsYXNzIGlzIHRoZSBtYWluIHBhcnQgb2YgU3Ryb3BoZS4gIEl0IG1hbmFnZXMgYSBCT1NIIGNvbm5lY3Rpb24KICogIHRvIGFuIFhNUFAgc2VydmVyIGFuZCBkaXNwYXRjaGVzIGV2ZW50cyB0byB0aGUgdXNlciBjYWxsYmFja3MgYXMKICogIGRhdGEgYXJyaXZlcy4gIEl0IHN1cHBvcnRzIFNBU0wgUExBSU4sIFNBU0wgRElHRVNULU1ENSwgU0FTTCBTQ1JBTS1TSEExCiAqICBhbmQgbGVnYWN5IGF1dGhlbnRpY2F0aW9uLgogKgogKiAgQWZ0ZXIgY3JlYXRpbmcgYSBTdHJvcGhlLkNvbm5lY3Rpb24gb2JqZWN0LCB0aGUgdXNlciB3aWxsIHR5cGljYWxseQogKiAgY2FsbCBjb25uZWN0KCkgd2l0aCBhIHVzZXIgc3VwcGxpZWQgY2FsbGJhY2sgdG8gaGFuZGxlIGNvbm5lY3Rpb24gbGV2ZWwKICogIGV2ZW50cyBsaWtlIGF1dGhlbnRpY2F0aW9uIGZhaWx1cmUsIGRpc2Nvbm5lY3Rpb24sIG9yIGNvbm5lY3Rpb24KICogIGNvbXBsZXRlLgogKgogKiAgVGhlIHVzZXIgd2lsbCBhbHNvIGhhdmUgc2V2ZXJhbCBldmVudCBoYW5kbGVycyBkZWZpbmVkIGJ5IHVzaW5nCiAqICBhZGRIYW5kbGVyKCkgYW5kIGFkZFRpbWVkSGFuZGxlcigpLiAgVGhlc2Ugd2lsbCBhbGxvdyB0aGUgdXNlciBjb2RlIHRvCiAqICByZXNwb25kIHRvIGludGVyZXN0aW5nIHN0YW56YXMgb3IgZG8gc29tZXRoaW5nIHBlcmlvZGljYWxseSB3aXRoIHRoZQogKiAgY29ubmVjdGlvbi4gIFRoZXNlIGhhbmRsZXJzIHdpbGwgYmUgYWN0aXZlIG9uY2UgYXV0aGVudGljYXRpb24gaXMKICogIGZpbmlzaGVkLgogKgogKiAgVG8gc2VuZCBkYXRhIHRvIHRoZSBjb25uZWN0aW9uLCB1c2Ugc2VuZCgpLgogKi8KCi8qKiBDb25zdHJ1Y3RvcjogU3Ryb3BoZS5Db25uZWN0aW9uCiAqICBDcmVhdGUgYW5kIGluaXRpYWxpemUgYSBTdHJvcGhlLkNvbm5lY3Rpb24gb2JqZWN0LgogKgogKiAgVGhlIHRyYW5zcG9ydC1wcm90b2NvbCBmb3IgdGhpcyBjb25uZWN0aW9uIHdpbGwgYmUgY2hvc2VuIGF1dG9tYXRpY2FsbHkKICogIGJhc2VkIG9uIHRoZSBnaXZlbiBzZXJ2aWNlIHBhcmFtZXRlci4gVVJMcyBzdGFydGluZyB3aXRoICJ3czovLyIgb3IKICogICJ3c3M6Ly8iIHdpbGwgdXNlIFdlYlNvY2tldHMsIFVSTHMgc3RhcnRpbmcgd2l0aCAiaHR0cDovLyIsICJodHRwczovLyIKICogIG9yIHdpdGhvdXQgYSBwcm90b2NvbCB3aWxsIHVzZSBCT1NILgogKgogKiAgVG8gbWFrZSBTdHJvcGhlIGNvbm5lY3QgdG8gdGhlIGN1cnJlbnQgaG9zdCB5b3UgY2FuIGxlYXZlIG91dCB0aGUgcHJvdG9jb2wKICogIGFuZCBob3N0IHBhcnQgYW5kIGp1c3QgcGFzcyB0aGUgcGF0aCwgZS5nLgogKgogKiAgPiB2YXIgY29ubiA9IG5ldyBTdHJvcGhlLkNvbm5lY3Rpb24oIi9odHRwLWJpbmQvIik7CiAqCiAqICBXZWJTb2NrZXQgb3B0aW9uczoKICoKICogIElmIHlvdSB3YW50IHRvIGNvbm5lY3QgdG8gdGhlIGN1cnJlbnQgaG9zdCB3aXRoIGEgV2ViU29ja2V0IGNvbm5lY3Rpb24geW91CiAqICBjYW4gdGVsbCBTdHJvcGhlIHRvIHVzZSBXZWJTb2NrZXRzIHRocm91Z2ggYSAicHJvdG9jb2wiIGF0dHJpYnV0ZSBpbiB0aGUKICogIG9wdGlvbmFsIG9wdGlvbnMgcGFyYW1ldGVyLiBWYWxpZCB2YWx1ZXMgYXJlICJ3cyIgZm9yIFdlYlNvY2tldCBhbmQgIndzcyIKICogIGZvciBTZWN1cmUgV2ViU29ja2V0LgogKiAgU28gdG8gY29ubmVjdCB0byAid3NzOi8vQ1VSUkVOVF9IT1NUTkFNRS94bXBwLXdlYnNvY2tldCIgeW91IHdvdWxkIGNhbGwKICoKICogID4gdmFyIGNvbm4gPSBuZXcgU3Ryb3BoZS5Db25uZWN0aW9uKCIveG1wcC13ZWJzb2NrZXQvIiwge3Byb3RvY29sOiAid3NzIn0pOwogKgogKiAgTm90ZSB0aGF0IHJlbGF0aXZlIFVSTHMgX05PVF8gc3RhcnRpbmcgd2l0aCBhICIvIiB3aWxsIGFsc28gaW5jbHVkZSB0aGUgcGF0aAogKiAgb2YgdGhlIGN1cnJlbnQgc2l0ZS4KICoKICogIEFsc28gYmVjYXVzZSBkb3duZ3JhZGluZyBzZWN1cml0eSBpcyBub3QgcGVybWl0dGVkIGJ5IGJyb3dzZXJzLCB3aGVuIHVzaW5nCiAqICByZWxhdGl2ZSBVUkxzIGJvdGggQk9TSCBhbmQgV2ViU29ja2V0IGNvbm5lY3Rpb25zIHdpbGwgdXNlIHRoZWlyIHNlY3VyZQogKiAgdmFyaWFudHMgaWYgdGhlIGN1cnJlbnQgY29ubmVjdGlvbiB0byB0aGUgc2l0ZSBpcyBhbHNvIHNlY3VyZSAoaHR0cHMpLgogKgogKiAgQk9TSCBvcHRpb25zOgogKgogKiAgYnkgYWRkaW5nICJzeW5jIiB0byB0aGUgb3B0aW9ucywgeW91IGNhbiBjb250cm9sIGlmIHJlcXVlc3RzIHdpbGwKICogIGJlIG1hZGUgc3luY2hyb25vdXNseSBvciBub3QuIFRoZSBkZWZhdWx0IGJlaGF2aW91ciBpcyBhc3luY2hyb25vdXMuCiAqICBJZiB5b3Ugd2FudCB0byBtYWtlIHJlcXVlc3RzIHN5bmNocm9ub3VzLCBtYWtlICJzeW5jIiBldmFsdWF0ZSB0byB0cnVlOgogKiAgPiB2YXIgY29ubiA9IG5ldyBTdHJvcGhlLkNvbm5lY3Rpb24oIi9odHRwLWJpbmQvIiwge3N5bmM6IHRydWV9KTsKICogIFlvdSBjYW4gYWxzbyB0b2dnbGUgdGhpcyBvbiBhbiBhbHJlYWR5IGVzdGFibGlzaGVkIGNvbm5lY3Rpb246CiAqICA+IGNvbm4ub3B0aW9ucy5zeW5jID0gdHJ1ZTsKICoKICoKICogIFBhcmFtZXRlcnM6CiAqICAgIChTdHJpbmcpIHNlcnZpY2UgLSBUaGUgQk9TSCBvciBXZWJTb2NrZXQgc2VydmljZSBVUkwuCiAqICAgIChPYmplY3QpIG9wdGlvbnMgLSBBIGhhc2ggb2YgY29uZmlndXJhdGlvbiBvcHRpb25zCiAqCiAqICBSZXR1cm5zOgogKiAgICBBIG5ldyBTdHJvcGhlLkNvbm5lY3Rpb24gb2JqZWN0LgogKi8KU3Ryb3BoZS5Db25uZWN0aW9uID0gZnVuY3Rpb24gKHNlcnZpY2UsIG9wdGlvbnMpCnsKICAgIC8vIFRoZSBzZXJ2aWNlIFVSTAogICAgdGhpcy5zZXJ2aWNlID0gc2VydmljZTsKCiAgICAvLyBDb25maWd1cmF0aW9uIG9wdGlvbnMKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB2YXIgcHJvdG8gPSB0aGlzLm9wdGlvbnMucHJvdG9jb2wgfHwgIiI7CgogICAgLy8gU2VsZWN0IHByb3RvY2FsIGJhc2VkIG9uIHNlcnZpY2Ugb3Igb3B0aW9ucwogICAgaWYgKHNlcnZpY2UuaW5kZXhPZigid3M6IikgPT09IDAgfHwgc2VydmljZS5pbmRleE9mKCJ3c3M6IikgPT09IDAgfHwKICAgICAgICAgICAgcHJvdG8uaW5kZXhPZigid3MiKSA9PT0gMCkgewogICAgICAgIHRoaXMuX3Byb3RvID0gbmV3IFN0cm9waGUuV2Vic29ja2V0KHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9wcm90byA9IG5ldyBTdHJvcGhlLkJvc2godGhpcyk7CiAgICB9CiAgICAvKiBUaGUgY29ubmVjdGVkIEpJRC4gKi8KICAgIHRoaXMuamlkID0gIiI7CiAgICAvKiB0aGUgSklEcyBkb21haW4gKi8KICAgIHRoaXMuZG9tYWluID0gbnVsbDsKICAgIC8qIHN0cmVhbTpmZWF0dXJlcyAqLwogICAgdGhpcy5mZWF0dXJlcyA9IG51bGw7CgogICAgLy8gU0FTTAogICAgdGhpcy5fc2FzbF9kYXRhID0ge307CiAgICB0aGlzLmRvX3Nlc3Npb24gPSBmYWxzZTsKICAgIHRoaXMuZG9fYmluZCA9IGZhbHNlOwoKICAgIC8vIGhhbmRsZXIgbGlzdHMKICAgIHRoaXMudGltZWRIYW5kbGVycyA9IFtdOwogICAgdGhpcy5oYW5kbGVycyA9IFtdOwogICAgdGhpcy5yZW1vdmVUaW1lZHMgPSBbXTsKICAgIHRoaXMucmVtb3ZlSGFuZGxlcnMgPSBbXTsKICAgIHRoaXMuYWRkVGltZWRzID0gW107CiAgICB0aGlzLmFkZEhhbmRsZXJzID0gW107CgogICAgdGhpcy5fYXV0aGVudGljYXRpb24gPSB7fTsKICAgIHRoaXMuX2lkbGVUaW1lb3V0ID0gbnVsbDsKICAgIHRoaXMuX2Rpc2Nvbm5lY3RUaW1lb3V0ID0gbnVsbDsKCiAgICB0aGlzLmRvX2F1dGhlbnRpY2F0aW9uID0gdHJ1ZTsKICAgIHRoaXMuYXV0aGVudGljYXRlZCA9IGZhbHNlOwogICAgdGhpcy5kaXNjb25uZWN0aW5nID0gZmFsc2U7CiAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlOwoKICAgIHRoaXMuZXJyb3JzID0gMDsKCiAgICB0aGlzLnBhdXNlZCA9IGZhbHNlOwoKICAgIHRoaXMuX2RhdGEgPSBbXTsKICAgIHRoaXMuX3VuaXF1ZUlkID0gMDsKCiAgICB0aGlzLl9zYXNsX3N1Y2Nlc3NfaGFuZGxlciA9IG51bGw7CiAgICB0aGlzLl9zYXNsX2ZhaWx1cmVfaGFuZGxlciA9IG51bGw7CiAgICB0aGlzLl9zYXNsX2NoYWxsZW5nZV9oYW5kbGVyID0gbnVsbDsKCiAgICAvLyBNYXggcmV0cmllcyBiZWZvcmUgZGlzY29ubmVjdGluZwogICAgdGhpcy5tYXhSZXRyaWVzID0gNTsKCiAgICAvLyBzZXR1cCBvbklkbGUgY2FsbGJhY2sgZXZlcnkgMS8xMHRoIG9mIGEgc2Vjb25kCiAgICB0aGlzLl9pZGxlVGltZW91dCA9IHNldFRpbWVvdXQodGhpcy5fb25JZGxlLmJpbmQodGhpcyksIDEwMCk7CgogICAgLy8gaW5pdGlhbGl6ZSBwbHVnaW5zCiAgICBmb3IgKHZhciBrIGluIFN0cm9waGUuX2Nvbm5lY3Rpb25QbHVnaW5zKSB7CiAgICAgICAgaWYgKFN0cm9waGUuX2Nvbm5lY3Rpb25QbHVnaW5zLmhhc093blByb3BlcnR5KGspKSB7CiAgICAgICAgICAgIHZhciBwdHlwZSA9IFN0cm9waGUuX2Nvbm5lY3Rpb25QbHVnaW5zW2tdOwogICAgICAgICAgICAvLyBqc2xpbnQgY29tcGxhaW50cyBhYm91dCB0aGUgYmVsb3cgbGluZSwgYnV0IHRoaXMgaXMgZmluZQogICAgICAgICAgICB2YXIgRiA9IGZ1bmN0aW9uICgpIHt9OyAvLyBqc2hpbnQgaWdub3JlOmxpbmUKICAgICAgICAgICAgRi5wcm90b3R5cGUgPSBwdHlwZTsKICAgICAgICAgICAgdGhpc1trXSA9IG5ldyBGKCk7CiAgICAgICAgICAgIHRoaXNba10uaW5pdCh0aGlzKTsKICAgICAgICB9CiAgICB9Cn07CgpTdHJvcGhlLkNvbm5lY3Rpb24ucHJvdG90eXBlID0gewogICAgLyoqIEZ1bmN0aW9uOiByZXNldAogICAgICogIFJlc2V0IHRoZSBjb25uZWN0aW9uLgogICAgICoKICAgICAqICBUaGlzIGZ1bmN0aW9uIHNob3VsZCBiZSBjYWxsZWQgYWZ0ZXIgYSBjb25uZWN0aW9uIGlzIGRpc2Nvbm5lY3RlZAogICAgICogIGJlZm9yZSB0aGF0IGNvbm5lY3Rpb24gaXMgcmV1c2VkLgogICAgICovCiAgICByZXNldDogZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICB0aGlzLl9wcm90by5fcmVzZXQoKTsKCiAgICAgICAgLy8gU0FTTAogICAgICAgIHRoaXMuZG9fc2Vzc2lvbiA9IGZhbHNlOwogICAgICAgIHRoaXMuZG9fYmluZCA9IGZhbHNlOwoKICAgICAgICAvLyBoYW5kbGVyIGxpc3RzCiAgICAgICAgdGhpcy50aW1lZEhhbmRsZXJzID0gW107CiAgICAgICAgdGhpcy5oYW5kbGVycyA9IFtdOwogICAgICAgIHRoaXMucmVtb3ZlVGltZWRzID0gW107CiAgICAgICAgdGhpcy5yZW1vdmVIYW5kbGVycyA9IFtdOwogICAgICAgIHRoaXMuYWRkVGltZWRzID0gW107CiAgICAgICAgdGhpcy5hZGRIYW5kbGVycyA9IFtdOwogICAgICAgIHRoaXMuX2F1dGhlbnRpY2F0aW9uID0ge307CgogICAgICAgIHRoaXMuYXV0aGVudGljYXRlZCA9IGZhbHNlOwogICAgICAgIHRoaXMuZGlzY29ubmVjdGluZyA9IGZhbHNlOwogICAgICAgIHRoaXMuY29ubmVjdGVkID0gZmFsc2U7CgogICAgICAgIHRoaXMuZXJyb3JzID0gMDsKCiAgICAgICAgdGhpcy5fcmVxdWVzdHMgPSBbXTsKICAgICAgICB0aGlzLl91bmlxdWVJZCA9IDA7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogcGF1c2UKICAgICAqICBQYXVzZSB0aGUgcmVxdWVzdCBtYW5hZ2VyLgogICAgICoKICAgICAqICBUaGlzIHdpbGwgcHJldmVudCBTdHJvcGhlIGZyb20gc2VuZGluZyBhbnkgbW9yZSByZXF1ZXN0cyB0byB0aGUKICAgICAqICBzZXJ2ZXIuICBUaGlzIGlzIHZlcnkgdXNlZnVsIGZvciB0ZW1wb3JhcmlseSBwYXVzaW5nCiAgICAgKiAgQk9TSC1Db25uZWN0aW9ucyB3aGlsZSBhIGxvdCBvZiBzZW5kKCkgY2FsbHMgYXJlIGhhcHBlbmluZyBxdWlja2x5LgogICAgICogIFRoaXMgY2F1c2VzIFN0cm9waGUgdG8gc2VuZCB0aGUgZGF0YSBpbiBhIHNpbmdsZSByZXF1ZXN0LCBzYXZpbmcKICAgICAqICBtYW55IHJlcXVlc3QgdHJpcHMuCiAgICAgKi8KICAgIHBhdXNlOiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIHRoaXMucGF1c2VkID0gdHJ1ZTsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiByZXN1bWUKICAgICAqICBSZXN1bWUgdGhlIHJlcXVlc3QgbWFuYWdlci4KICAgICAqCiAgICAgKiAgVGhpcyByZXN1bWVzIGFmdGVyIHBhdXNlKCkgaGFzIGJlZW4gY2FsbGVkLgogICAgICovCiAgICByZXN1bWU6IGZ1bmN0aW9uICgpCiAgICB7CiAgICAgICAgdGhpcy5wYXVzZWQgPSBmYWxzZTsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiBnZXRVbmlxdWVJZAogICAgICogIEdlbmVyYXRlIGEgdW5pcXVlIElEIGZvciB1c2UgaW4gPGlxLz4gZWxlbWVudHMuCiAgICAgKgogICAgICogIEFsbCA8aXEvPiBzdGFuemFzIGFyZSByZXF1aXJlZCB0byBoYXZlIHVuaXF1ZSBpZCBhdHRyaWJ1dGVzLiAgVGhpcwogICAgICogIGZ1bmN0aW9uIG1ha2VzIGNyZWF0aW5nIHRoZXNlIGVhc3kuICBFYWNoIGNvbm5lY3Rpb24gaW5zdGFuY2UgaGFzCiAgICAgKiAgYSBjb3VudGVyIHdoaWNoIHN0YXJ0cyBmcm9tIHplcm8sIGFuZCB0aGUgdmFsdWUgb2YgdGhpcyBjb3VudGVyCiAgICAgKiAgcGx1cyBhIGNvbG9uIGZvbGxvd2VkIGJ5IHRoZSBzdWZmaXggYmVjb21lcyB0aGUgdW5pcXVlIGlkLiBJZiBubwogICAgICogIHN1ZmZpeCBpcyBzdXBwbGllZCwgdGhlIGNvdW50ZXIgaXMgdXNlZCBhcyB0aGUgdW5pcXVlIGlkLgogICAgICoKICAgICAqICBTdWZmaXhlcyBhcmUgdXNlZCB0byBtYWtlIGRlYnVnZ2luZyBlYXNpZXIgd2hlbiByZWFkaW5nIHRoZSBzdHJlYW0KICAgICAqICBkYXRhLCBhbmQgdGhlaXIgdXNlIGlzIHJlY29tbWVuZGVkLiAgVGhlIGNvdW50ZXIgcmVzZXRzIHRvIDAgZm9yCiAgICAgKiAgZXZlcnkgbmV3IGNvbm5lY3Rpb24gZm9yIHRoZSBzYW1lIHJlYXNvbi4gIEZvciBjb25uZWN0aW9ucyB0byB0aGUKICAgICAqICBzYW1lIHNlcnZlciB0aGF0IGF1dGhlbnRpY2F0ZSB0aGUgc2FtZSB3YXksIGFsbCB0aGUgaWRzIHNob3VsZCBiZQogICAgICogIHRoZSBzYW1lLCB3aGljaCBtYWtlcyBpdCBlYXN5IHRvIHNlZSBjaGFuZ2VzLiAgVGhpcyBpcyB1c2VmdWwgZm9yCiAgICAgKiAgYXV0b21hdGVkIHRlc3RpbmcgYXMgd2VsbC4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJpbmcpIHN1ZmZpeCAtIEEgb3B0aW9uYWwgc3VmZml4IHRvIGFwcGVuZCB0byB0aGUgaWQuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBBIHVuaXF1ZSBzdHJpbmcgdG8gYmUgdXNlZCBmb3IgdGhlIGlkIGF0dHJpYnV0ZS4KICAgICAqLwogICAgZ2V0VW5pcXVlSWQ6IGZ1bmN0aW9uIChzdWZmaXgpCiAgICB7CiAgICAgICAgaWYgKHR5cGVvZihzdWZmaXgpID09ICJzdHJpbmciIHx8IHR5cGVvZihzdWZmaXgpID09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIHJldHVybiArK3RoaXMuX3VuaXF1ZUlkICsgIjoiICsgc3VmZml4OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiArK3RoaXMuX3VuaXF1ZUlkICsgIiI7CiAgICAgICAgfQogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IGNvbm5lY3QKICAgICAqICBTdGFydHMgdGhlIGNvbm5lY3Rpb24gcHJvY2Vzcy4KICAgICAqCiAgICAgKiAgQXMgdGhlIGNvbm5lY3Rpb24gcHJvY2VzcyBwcm9jZWVkcywgdGhlIHVzZXIgc3VwcGxpZWQgY2FsbGJhY2sgd2lsbAogICAgICogIGJlIHRyaWdnZXJlZCBtdWx0aXBsZSB0aW1lcyB3aXRoIHN0YXR1cyB1cGRhdGVzLiAgVGhlIGNhbGxiYWNrCiAgICAgKiAgc2hvdWxkIHRha2UgdHdvIGFyZ3VtZW50cyAtIHRoZSBzdGF0dXMgY29kZSBhbmQgdGhlIGVycm9yIGNvbmRpdGlvbi4KICAgICAqCiAgICAgKiAgVGhlIHN0YXR1cyBjb2RlIHdpbGwgYmUgb25lIG9mIHRoZSB2YWx1ZXMgaW4gdGhlIFN0cm9waGUuU3RhdHVzCiAgICAgKiAgY29uc3RhbnRzLiAgVGhlIGVycm9yIGNvbmRpdGlvbiB3aWxsIGJlIG9uZSBvZiB0aGUgY29uZGl0aW9ucwogICAgICogIGRlZmluZWQgaW4gUkZDIDM5MjAgb3IgdGhlIGNvbmRpdGlvbiAnc3Ryb3BoZS1wYXJzZXJlcnJvcicuCiAgICAgKgogICAgICogIFRoZSBQYXJhbWV0ZXJzIF93YWl0XywgX2hvbGRfIGFuZCBfcm91dGVfIGFyZSBvcHRpb25hbCBhbmQgb25seSByZWxldmFudAogICAgICogIGZvciBCT1NIIGNvbm5lY3Rpb25zLiBQbGVhc2Ugc2VlIFhFUCAxMjQgZm9yIGEgbW9yZSBkZXRhaWxlZCBleHBsYW5hdGlvbgogICAgICogIG9mIHRoZSBvcHRpb25hbCBwYXJhbWV0ZXJzLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cmluZykgamlkIC0gVGhlIHVzZXIncyBKSUQuICBUaGlzIG1heSBiZSBhIGJhcmUgSklELAogICAgICogICAgICBvciBhIGZ1bGwgSklELiAgSWYgYSBub2RlIGlzIG5vdCBzdXBwbGllZCwgU0FTTCBBTk9OWU1PVVMKICAgICAqICAgICAgYXV0aGVudGljYXRpb24gd2lsbCBiZSBhdHRlbXB0ZWQuCiAgICAgKiAgICAoU3RyaW5nKSBwYXNzIC0gVGhlIHVzZXIncyBwYXNzd29yZC4KICAgICAqICAgIChGdW5jdGlvbikgY2FsbGJhY2sgLSBUaGUgY29ubmVjdCBjYWxsYmFjayBmdW5jdGlvbi4KICAgICAqICAgIChJbnRlZ2VyKSB3YWl0IC0gVGhlIG9wdGlvbmFsIEhUVFBCSU5EIHdhaXQgdmFsdWUuICBUaGlzIGlzIHRoZQogICAgICogICAgICB0aW1lIHRoZSBzZXJ2ZXIgd2lsbCB3YWl0IGJlZm9yZSByZXR1cm5pbmcgYW4gZW1wdHkgcmVzdWx0IGZvcgogICAgICogICAgICBhIHJlcXVlc3QuICBUaGUgZGVmYXVsdCBzZXR0aW5nIG9mIDYwIHNlY29uZHMgaXMgcmVjb21tZW5kZWQuCiAgICAgKiAgICAoSW50ZWdlcikgaG9sZCAtIFRoZSBvcHRpb25hbCBIVFRQQklORCBob2xkIHZhbHVlLiAgVGhpcyBpcyB0aGUKICAgICAqICAgICAgbnVtYmVyIG9mIGNvbm5lY3Rpb25zIHRoZSBzZXJ2ZXIgd2lsbCBob2xkIGF0IG9uZSB0aW1lLiAgVGhpcwogICAgICogICAgICBzaG91bGQgYWxtb3N0IGFsd2F5cyBiZSBzZXQgdG8gMSAodGhlIGRlZmF1bHQpLgogICAgICogICAgKFN0cmluZykgcm91dGUgLSBUaGUgb3B0aW9uYWwgcm91dGUgdmFsdWUuCiAgICAgKi8KICAgIGNvbm5lY3Q6IGZ1bmN0aW9uIChqaWQsIHBhc3MsIGNhbGxiYWNrLCB3YWl0LCBob2xkLCByb3V0ZSkKICAgIHsKICAgICAgICB0aGlzLmppZCA9IGppZDsKICAgICAgICAvKiogVmFyaWFibGU6IGF1dGh6aWQKICAgICAgICAgKiAgQXV0aG9yaXphdGlvbiBpZGVudGl0eS4KICAgICAgICAgKi8KICAgICAgICB0aGlzLmF1dGh6aWQgPSBTdHJvcGhlLmdldEJhcmVKaWRGcm9tSmlkKHRoaXMuamlkKTsKICAgICAgICAvKiogVmFyaWFibGU6IGF1dGhjaWQKICAgICAgICAgKiAgQXV0aGVudGljYXRpb24gaWRlbnRpdHkgKFVzZXIgbmFtZSkuCiAgICAgICAgICovCiAgICAgICAgdGhpcy5hdXRoY2lkID0gU3Ryb3BoZS5nZXROb2RlRnJvbUppZCh0aGlzLmppZCk7CiAgICAgICAgLyoqIFZhcmlhYmxlOiBwYXNzCiAgICAgICAgICogIEF1dGhlbnRpY2F0aW9uIGlkZW50aXR5IChVc2VyIHBhc3N3b3JkKS4KICAgICAgICAgKi8KICAgICAgICB0aGlzLnBhc3MgPSBwYXNzOwogICAgICAgIC8qKiBWYXJpYWJsZTogc2VydnR5cGUKICAgICAgICAgKiAgRGlnZXN0IE1ENSBjb21wYXRpYmlsaXR5LgogICAgICAgICAqLwogICAgICAgIHRoaXMuc2VydnR5cGUgPSAieG1wcCI7CiAgICAgICAgdGhpcy5jb25uZWN0X2NhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgdGhpcy5kaXNjb25uZWN0aW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLmF1dGhlbnRpY2F0ZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLmVycm9ycyA9IDA7CgogICAgICAgIC8vIHBhcnNlIGppZCBmb3IgZG9tYWluCiAgICAgICAgdGhpcy5kb21haW4gPSBTdHJvcGhlLmdldERvbWFpbkZyb21KaWQodGhpcy5qaWQpOwoKICAgICAgICB0aGlzLl9jaGFuZ2VDb25uZWN0U3RhdHVzKFN0cm9waGUuU3RhdHVzLkNPTk5FQ1RJTkcsIG51bGwpOwoKICAgICAgICB0aGlzLl9wcm90by5fY29ubmVjdCh3YWl0LCBob2xkLCByb3V0ZSk7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogYXR0YWNoCiAgICAgKiAgQXR0YWNoIHRvIGFuIGFscmVhZHkgY3JlYXRlZCBhbmQgYXV0aGVudGljYXRlZCBCT1NIIHNlc3Npb24uCiAgICAgKgogICAgICogIFRoaXMgZnVuY3Rpb24gaXMgcHJvdmlkZWQgdG8gYWxsb3cgU3Ryb3BoZSB0byBhdHRhY2ggdG8gQk9TSAogICAgICogIHNlc3Npb25zIHdoaWNoIGhhdmUgYmVlbiBjcmVhdGVkIGV4dGVybmFsbHksIHBlcmhhcHMgYnkgYSBXZWIKICAgICAqICBhcHBsaWNhdGlvbi4gIFRoaXMgaXMgb2Z0ZW4gdXNlZCB0byBzdXBwb3J0IGF1dG8tbG9naW4gdHlwZSBmZWF0dXJlcwogICAgICogIHdpdGhvdXQgcHV0dGluZyB1c2VyIGNyZWRlbnRpYWxzIGludG8gdGhlIHBhZ2UuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoU3RyaW5nKSBqaWQgLSBUaGUgZnVsbCBKSUQgdGhhdCBpcyBib3VuZCBieSB0aGUgc2Vzc2lvbi4KICAgICAqICAgIChTdHJpbmcpIHNpZCAtIFRoZSBTSUQgb2YgdGhlIEJPU0ggc2Vzc2lvbi4KICAgICAqICAgIChTdHJpbmcpIHJpZCAtIFRoZSBjdXJyZW50IFJJRCBvZiB0aGUgQk9TSCBzZXNzaW9uLiAgVGhpcyBSSUQKICAgICAqICAgICAgd2lsbCBiZSB1c2VkIGJ5IHRoZSBuZXh0IHJlcXVlc3QuCiAgICAgKiAgICAoRnVuY3Rpb24pIGNhbGxiYWNrIFRoZSBjb25uZWN0IGNhbGxiYWNrIGZ1bmN0aW9uLgogICAgICogICAgKEludGVnZXIpIHdhaXQgLSBUaGUgb3B0aW9uYWwgSFRUUEJJTkQgd2FpdCB2YWx1ZS4gIFRoaXMgaXMgdGhlCiAgICAgKiAgICAgIHRpbWUgdGhlIHNlcnZlciB3aWxsIHdhaXQgYmVmb3JlIHJldHVybmluZyBhbiBlbXB0eSByZXN1bHQgZm9yCiAgICAgKiAgICAgIGEgcmVxdWVzdC4gIFRoZSBkZWZhdWx0IHNldHRpbmcgb2YgNjAgc2Vjb25kcyBpcyByZWNvbW1lbmRlZC4KICAgICAqICAgICAgT3RoZXIgc2V0dGluZ3Mgd2lsbCByZXF1aXJlIHR3ZWFrcyB0byB0aGUgU3Ryb3BoZS5USU1FT1VUIHZhbHVlLgogICAgICogICAgKEludGVnZXIpIGhvbGQgLSBUaGUgb3B0aW9uYWwgSFRUUEJJTkQgaG9sZCB2YWx1ZS4gIFRoaXMgaXMgdGhlCiAgICAgKiAgICAgIG51bWJlciBvZiBjb25uZWN0aW9ucyB0aGUgc2VydmVyIHdpbGwgaG9sZCBhdCBvbmUgdGltZS4gIFRoaXMKICAgICAqICAgICAgc2hvdWxkIGFsbW9zdCBhbHdheXMgYmUgc2V0IHRvIDEgKHRoZSBkZWZhdWx0KS4KICAgICAqICAgIChJbnRlZ2VyKSB3aW5kIC0gVGhlIG9wdGlvbmFsIEhUVEJJTkQgd2luZG93IHZhbHVlLiAgVGhpcyBpcyB0aGUKICAgICAqICAgICAgYWxsb3dlZCByYW5nZSBvZiByZXF1ZXN0IGlkcyB0aGF0IGFyZSB2YWxpZC4gIFRoZSBkZWZhdWx0IGlzIDUuCiAgICAgKi8KICAgIGF0dGFjaDogZnVuY3Rpb24gKGppZCwgc2lkLCByaWQsIGNhbGxiYWNrLCB3YWl0LCBob2xkLCB3aW5kKQogICAgewogICAgICAgIHRoaXMuX3Byb3RvLl9hdHRhY2goamlkLCBzaWQsIHJpZCwgY2FsbGJhY2ssIHdhaXQsIGhvbGQsIHdpbmQpOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IHhtbElucHV0CiAgICAgKiAgVXNlciBvdmVycmlkZWFibGUgZnVuY3Rpb24gdGhhdCByZWNlaXZlcyBYTUwgZGF0YSBjb21pbmcgaW50byB0aGUKICAgICAqICBjb25uZWN0aW9uLgogICAgICoKICAgICAqICBUaGUgZGVmYXVsdCBmdW5jdGlvbiBkb2VzIG5vdGhpbmcuICBVc2VyIGNvZGUgY2FuIG92ZXJyaWRlIHRoaXMgd2l0aAogICAgICogID4gU3Ryb3BoZS5Db25uZWN0aW9uLnhtbElucHV0ID0gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAqICA+ICAgKHVzZXIgY29kZSkKICAgICAqICA+IH07CiAgICAgKgogICAgICogIER1ZSB0byBsaW1pdGF0aW9ucyBvZiBjdXJyZW50IEJyb3dzZXJzJyBYTUwtUGFyc2VycyB0aGUgb3BlbmluZyBhbmQgY2xvc2luZwogICAgICogIDxzdHJlYW0+IHRhZyBmb3IgV2ViU29ja2V0LUNvbm5vY3Rpb25zIHdpbGwgYmUgcGFzc2VkIGFzIHNlbGZjbG9zaW5nIGhlcmUuCiAgICAgKgogICAgICogIEJPU0gtQ29ubmVjdGlvbnMgd2lsbCBoYXZlIGFsbCBzdGFuemFzIHdyYXBwZWQgaW4gYSA8Ym9keT4gdGFnLiBTZWUKICAgICAqICA8U3Ryb3BoZS5Cb3NoLnN0cmlwPiBpZiB5b3Ugd2FudCB0byBzdHJpcCB0aGlzIHRhZy4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChYTUxFbGVtZW50KSBlbGVtIC0gVGhlIFhNTCBkYXRhIHJlY2VpdmVkIGJ5IHRoZSBjb25uZWN0aW9uLgogICAgICovCiAgICAvKiBqc2hpbnQgdW51c2VkOmZhbHNlICovCiAgICB4bWxJbnB1dDogZnVuY3Rpb24gKGVsZW0pCiAgICB7CiAgICAgICAgcmV0dXJuOwogICAgfSwKICAgIC8qIGpzaGludCB1bnVzZWQ6dHJ1ZSAqLwoKICAgIC8qKiBGdW5jdGlvbjogeG1sT3V0cHV0CiAgICAgKiAgVXNlciBvdmVycmlkZWFibGUgZnVuY3Rpb24gdGhhdCByZWNlaXZlcyBYTUwgZGF0YSBzZW50IHRvIHRoZQogICAgICogIGNvbm5lY3Rpb24uCiAgICAgKgogICAgICogIFRoZSBkZWZhdWx0IGZ1bmN0aW9uIGRvZXMgbm90aGluZy4gIFVzZXIgY29kZSBjYW4gb3ZlcnJpZGUgdGhpcyB3aXRoCiAgICAgKiAgPiBTdHJvcGhlLkNvbm5lY3Rpb24ueG1sT3V0cHV0ID0gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAqICA+ICAgKHVzZXIgY29kZSkKICAgICAqICA+IH07CiAgICAgKgogICAgICogIER1ZSB0byBsaW1pdGF0aW9ucyBvZiBjdXJyZW50IEJyb3dzZXJzJyBYTUwtUGFyc2VycyB0aGUgb3BlbmluZyBhbmQgY2xvc2luZwogICAgICogIDxzdHJlYW0+IHRhZyBmb3IgV2ViU29ja2V0LUNvbm5vY3Rpb25zIHdpbGwgYmUgcGFzc2VkIGFzIHNlbGZjbG9zaW5nIGhlcmUuCiAgICAgKgogICAgICogIEJPU0gtQ29ubmVjdGlvbnMgd2lsbCBoYXZlIGFsbCBzdGFuemFzIHdyYXBwZWQgaW4gYSA8Ym9keT4gdGFnLiBTZWUKICAgICAqICA8U3Ryb3BoZS5Cb3NoLnN0cmlwPiBpZiB5b3Ugd2FudCB0byBzdHJpcCB0aGlzIHRhZy4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChYTUxFbGVtZW50KSBlbGVtIC0gVGhlIFhNTGRhdGEgc2VudCBieSB0aGUgY29ubmVjdGlvbi4KICAgICAqLwogICAgLyoganNoaW50IHVudXNlZDpmYWxzZSAqLwogICAgeG1sT3V0cHV0OiBmdW5jdGlvbiAoZWxlbSkKICAgIHsKICAgICAgICByZXR1cm47CiAgICB9LAogICAgLyoganNoaW50IHVudXNlZDp0cnVlICovCgogICAgLyoqIEZ1bmN0aW9uOiByYXdJbnB1dAogICAgICogIFVzZXIgb3ZlcnJpZGVhYmxlIGZ1bmN0aW9uIHRoYXQgcmVjZWl2ZXMgcmF3IGRhdGEgY29taW5nIGludG8gdGhlCiAgICAgKiAgY29ubmVjdGlvbi4KICAgICAqCiAgICAgKiAgVGhlIGRlZmF1bHQgZnVuY3Rpb24gZG9lcyBub3RoaW5nLiAgVXNlciBjb2RlIGNhbiBvdmVycmlkZSB0aGlzIHdpdGgKICAgICAqICA+IFN0cm9waGUuQ29ubmVjdGlvbi5yYXdJbnB1dCA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgKiAgPiAgICh1c2VyIGNvZGUpCiAgICAgKiAgPiB9OwogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cmluZykgZGF0YSAtIFRoZSBkYXRhIHJlY2VpdmVkIGJ5IHRoZSBjb25uZWN0aW9uLgogICAgICovCiAgICAvKiBqc2hpbnQgdW51c2VkOmZhbHNlICovCiAgICByYXdJbnB1dDogZnVuY3Rpb24gKGRhdGEpCiAgICB7CiAgICAgICAgcmV0dXJuOwogICAgfSwKICAgIC8qIGpzaGludCB1bnVzZWQ6dHJ1ZSAqLwoKICAgIC8qKiBGdW5jdGlvbjogcmF3T3V0cHV0CiAgICAgKiAgVXNlciBvdmVycmlkZWFibGUgZnVuY3Rpb24gdGhhdCByZWNlaXZlcyByYXcgZGF0YSBzZW50IHRvIHRoZQogICAgICogIGNvbm5lY3Rpb24uCiAgICAgKgogICAgICogIFRoZSBkZWZhdWx0IGZ1bmN0aW9uIGRvZXMgbm90aGluZy4gIFVzZXIgY29kZSBjYW4gb3ZlcnJpZGUgdGhpcyB3aXRoCiAgICAgKiAgPiBTdHJvcGhlLkNvbm5lY3Rpb24ucmF3T3V0cHV0ID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgICAqICA+ICAgKHVzZXIgY29kZSkKICAgICAqICA+IH07CiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoU3RyaW5nKSBkYXRhIC0gVGhlIGRhdGEgc2VudCBieSB0aGUgY29ubmVjdGlvbi4KICAgICAqLwogICAgLyoganNoaW50IHVudXNlZDpmYWxzZSAqLwogICAgcmF3T3V0cHV0OiBmdW5jdGlvbiAoZGF0YSkKICAgIHsKICAgICAgICByZXR1cm47CiAgICB9LAogICAgLyoganNoaW50IHVudXNlZDp0cnVlICovCgogICAgLyoqIEZ1bmN0aW9uOiBzZW5kCiAgICAgKiAgU2VuZCBhIHN0YW56YS4KICAgICAqCiAgICAgKiAgVGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQgdG8gcHVzaCBkYXRhIG9udG8gdGhlIHNlbmQgcXVldWUgdG8KICAgICAqICBnbyBvdXQgb3ZlciB0aGUgd2lyZS4gIFdoZW5ldmVyIGEgcmVxdWVzdCBpcyBzZW50IHRvIHRoZSBCT1NICiAgICAgKiAgc2VydmVyLCBhbGwgcGVuZGluZyBkYXRhIGlzIHNlbnQgYW5kIHRoZSBxdWV1ZSBpcyBmbHVzaGVkLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFhNTEVsZW1lbnQgfAogICAgICogICAgIFtYTUxFbGVtZW50XSB8CiAgICAgKiAgICAgU3Ryb3BoZS5CdWlsZGVyKSBlbGVtIC0gVGhlIHN0YW56YSB0byBzZW5kLgogICAgICovCiAgICBzZW5kOiBmdW5jdGlvbiAoZWxlbSkKICAgIHsKICAgICAgICBpZiAoZWxlbSA9PT0gbnVsbCkgeyByZXR1cm4gOyB9CiAgICAgICAgaWYgKHR5cGVvZihlbGVtLnNvcnQpID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWxlbS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdGhpcy5fcXVldWVEYXRhKGVsZW1baV0pOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YoZWxlbS50cmVlKSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aGlzLl9xdWV1ZURhdGEoZWxlbS50cmVlKCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX3F1ZXVlRGF0YShlbGVtKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX3Byb3RvLl9zZW5kKCk7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogZmx1c2gKICAgICAqICBJbW1lZGlhdGVseSBzZW5kIGFueSBwZW5kaW5nIG91dGdvaW5nIGRhdGEuCiAgICAgKgogICAgICogIE5vcm1hbGx5IHNlbmQoKSBxdWV1ZXMgb3V0Z29pbmcgZGF0YSB1bnRpbCB0aGUgbmV4dCBpZGxlIHBlcmlvZAogICAgICogICgxMDBtcyksIHdoaWNoIG9wdGltaXplcyBuZXR3b3JrIHVzZSBpbiB0aGUgY29tbW9uIGNhc2VzIHdoZW4KICAgICAqICBzZXZlcmFsIHNlbmQoKXMgYXJlIGNhbGxlZCBpbiBzdWNjZXNzaW9uLiBmbHVzaCgpIGNhbiBiZSB1c2VkIHRvCiAgICAgKiAgaW1tZWRpYXRlbHkgc2VuZCBhbGwgcGVuZGluZyBkYXRhLgogICAgICovCiAgICBmbHVzaDogZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICAvLyBjYW5jZWwgdGhlIHBlbmRpbmcgaWRsZSBwZXJpb2QgYW5kIHJ1biB0aGUgaWRsZSBmdW5jdGlvbgogICAgICAgIC8vIGltbWVkaWF0ZWx5CiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX2lkbGVUaW1lb3V0KTsKICAgICAgICB0aGlzLl9vbklkbGUoKTsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiBzZW5kSVEKICAgICAqICBIZWxwZXIgZnVuY3Rpb24gdG8gc2VuZCBJUSBzdGFuemFzLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFhNTEVsZW1lbnQpIGVsZW0gLSBUaGUgc3RhbnphIHRvIHNlbmQuCiAgICAgKiAgICAoRnVuY3Rpb24pIGNhbGxiYWNrIC0gVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIGZvciBhIHN1Y2Nlc3NmdWwgcmVxdWVzdC4KICAgICAqICAgIChGdW5jdGlvbikgZXJyYmFjayAtIFRoZSBjYWxsYmFjayBmdW5jdGlvbiBmb3IgYSBmYWlsZWQgb3IgdGltZWQKICAgICAqICAgICAgb3V0IHJlcXVlc3QuICBPbiB0aW1lb3V0LCB0aGUgc3RhbnphIHdpbGwgYmUgbnVsbC4KICAgICAqICAgIChJbnRlZ2VyKSB0aW1lb3V0IC0gVGhlIHRpbWUgc3BlY2lmaWVkIGluIG1pbGxpc2Vjb25kcyBmb3IgYQogICAgICogICAgICB0aW1lb3V0IHRvIG9jY3VyLgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgVGhlIGlkIHVzZWQgdG8gc2VuZCB0aGUgSVEuCiAgICAqLwogICAgc2VuZElROiBmdW5jdGlvbihlbGVtLCBjYWxsYmFjaywgZXJyYmFjaywgdGltZW91dCkgewogICAgICAgIHZhciB0aW1lb3V0SGFuZGxlciA9IG51bGw7CiAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwoKICAgICAgICBpZiAodHlwZW9mKGVsZW0udHJlZSkgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgZWxlbSA9IGVsZW0udHJlZSgpOwogICAgICAgIH0KICAgICAgICB2YXIgaWQgPSBlbGVtLmdldEF0dHJpYnV0ZSgnaWQnKTsKCiAgICAgICAgLy8gaW5qZWN0IGlkIGlmIG5vdCBmb3VuZAogICAgICAgIGlmICghaWQpIHsKICAgICAgICAgICAgaWQgPSB0aGlzLmdldFVuaXF1ZUlkKCJzZW5kSVEiKTsKICAgICAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUoImlkIiwgaWQpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGhhbmRsZXIgPSB0aGlzLmFkZEhhbmRsZXIoZnVuY3Rpb24gKHN0YW56YSkgewogICAgICAgICAgICAvLyByZW1vdmUgdGltZW91dCBoYW5kbGVyIGlmIHRoZXJlIGlzIG9uZQogICAgICAgICAgICBpZiAodGltZW91dEhhbmRsZXIpIHsKICAgICAgICAgICAgICAgIHRoYXQuZGVsZXRlVGltZWRIYW5kbGVyKHRpbWVvdXRIYW5kbGVyKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGlxdHlwZSA9IHN0YW56YS5nZXRBdHRyaWJ1dGUoJ3R5cGUnKTsKICAgICAgICAgICAgaWYgKGlxdHlwZSA9PSAncmVzdWx0JykgewogICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soc3RhbnphKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChpcXR5cGUgPT0gJ2Vycm9yJykgewogICAgICAgICAgICAgICAgaWYgKGVycmJhY2spIHsKICAgICAgICAgICAgICAgICAgICBlcnJiYWNrKHN0YW56YSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyB7CiAgICAgICAgICAgICAgICAgICAgbmFtZTogIlN0cm9waGVFcnJvciIsCiAgICAgICAgICAgIG1lc3NhZ2U6ICJHb3QgYmFkIElRIHR5cGUgb2YgIiArIGlxdHlwZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgIH0sIG51bGwsICdpcScsIG51bGwsIGlkKTsKCiAgICAgICAgLy8gaWYgdGltZW91dCBzcGVjaWZpZWQsIHNldHVwIHRpbWVvdXQgaGFuZGxlci4KICAgICAgICBpZiAodGltZW91dCkgewogICAgICAgICAgICB0aW1lb3V0SGFuZGxlciA9IHRoaXMuYWRkVGltZWRIYW5kbGVyKHRpbWVvdXQsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIC8vIGdldCByaWQgb2Ygbm9ybWFsIGhhbmRsZXIKICAgICAgICAgICAgICAgIHRoYXQuZGVsZXRlSGFuZGxlcihoYW5kbGVyKTsKCiAgICAgICAgICAgICAgICAvLyBjYWxsIGVycmJhY2sgb24gdGltZW91dCB3aXRoIG51bGwgc3RhbnphCiAgICAgICAgICAgICAgICBpZiAoZXJyYmFjaykgewogICAgICAgICAgICAgICAgICAgIGVycmJhY2sobnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5zZW5kKGVsZW0pOwoKICAgICAgICByZXR1cm4gaWQ7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9xdWV1ZURhdGEKICAgICAqICBRdWV1ZSBvdXRnb2luZyBkYXRhIGZvciBsYXRlciBzZW5kaW5nLiAgQWxzbyBlbnN1cmVzIHRoYXQgdGhlIGRhdGEKICAgICAqICBpcyBhIERPTUVsZW1lbnQuCiAgICAgKi8KICAgIF9xdWV1ZURhdGE6IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgaWYgKGVsZW1lbnQgPT09IG51bGwgfHwKICAgICAgICAgICAgIWVsZW1lbnQudGFnTmFtZSB8fAogICAgICAgICAgICAhZWxlbWVudC5jaGlsZE5vZGVzKSB7CiAgICAgICAgICAgIHRocm93IHsKICAgICAgICAgICAgICAgIG5hbWU6ICJTdHJvcGhlRXJyb3IiLAogICAgICAgICAgICAgICAgbWVzc2FnZTogIkNhbm5vdCBxdWV1ZSBub24tRE9NRWxlbWVudC4iCiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9kYXRhLnB1c2goZWxlbWVudCk7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9zZW5kUmVzdGFydAogICAgICogIFNlbmQgYW4geG1wcDpyZXN0YXJ0IHN0YW56YS4KICAgICAqLwogICAgX3NlbmRSZXN0YXJ0OiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIHRoaXMuX2RhdGEucHVzaCgicmVzdGFydCIpOwoKICAgICAgICB0aGlzLl9wcm90by5fc2VuZFJlc3RhcnQoKTsKCiAgICAgICAgdGhpcy5faWRsZVRpbWVvdXQgPSBzZXRUaW1lb3V0KHRoaXMuX29uSWRsZS5iaW5kKHRoaXMpLCAxMDApOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IGFkZFRpbWVkSGFuZGxlcgogICAgICogIEFkZCBhIHRpbWVkIGhhbmRsZXIgdG8gdGhlIGNvbm5lY3Rpb24uCiAgICAgKgogICAgICogIFRoaXMgZnVuY3Rpb24gYWRkcyBhIHRpbWVkIGhhbmRsZXIuICBUaGUgcHJvdmlkZWQgaGFuZGxlciB3aWxsCiAgICAgKiAgYmUgY2FsbGVkIGV2ZXJ5IHBlcmlvZCBtaWxsaXNlY29uZHMgdW50aWwgaXQgcmV0dXJucyBmYWxzZSwKICAgICAqICB0aGUgY29ubmVjdGlvbiBpcyB0ZXJtaW5hdGVkLCBvciB0aGUgaGFuZGxlciBpcyByZW1vdmVkLiAgSGFuZGxlcnMKICAgICAqICB0aGF0IHdpc2ggdG8gY29udGludWUgYmVpbmcgaW52b2tlZCBzaG91bGQgcmV0dXJuIHRydWUuCiAgICAgKgogICAgICogIEJlY2F1c2Ugb2YgbWV0aG9kIGJpbmRpbmcgaXQgaXMgbmVjZXNzYXJ5IHRvIHNhdmUgdGhlIHJlc3VsdCBvZgogICAgICogIHRoaXMgZnVuY3Rpb24gaWYgeW91IHdpc2ggdG8gcmVtb3ZlIGEgaGFuZGxlciB3aXRoCiAgICAgKiAgZGVsZXRlVGltZWRIYW5kbGVyKCkuCiAgICAgKgogICAgICogIE5vdGUgdGhhdCB1c2VyIGhhbmRsZXJzIGFyZSBub3QgYWN0aXZlIHVudGlsIGF1dGhlbnRpY2F0aW9uIGlzCiAgICAgKiAgc3VjY2Vzc2Z1bC4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChJbnRlZ2VyKSBwZXJpb2QgLSBUaGUgcGVyaW9kIG9mIHRoZSBoYW5kbGVyLgogICAgICogICAgKEZ1bmN0aW9uKSBoYW5kbGVyIC0gVGhlIGNhbGxiYWNrIGZ1bmN0aW9uLgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgQSByZWZlcmVuY2UgdG8gdGhlIGhhbmRsZXIgdGhhdCBjYW4gYmUgdXNlZCB0byByZW1vdmUgaXQuCiAgICAgKi8KICAgIGFkZFRpbWVkSGFuZGxlcjogZnVuY3Rpb24gKHBlcmlvZCwgaGFuZGxlcikKICAgIHsKICAgICAgICB2YXIgdGhhbmQgPSBuZXcgU3Ryb3BoZS5UaW1lZEhhbmRsZXIocGVyaW9kLCBoYW5kbGVyKTsKICAgICAgICB0aGlzLmFkZFRpbWVkcy5wdXNoKHRoYW5kKTsKICAgICAgICByZXR1cm4gdGhhbmQ7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogZGVsZXRlVGltZWRIYW5kbGVyCiAgICAgKiAgRGVsZXRlIGEgdGltZWQgaGFuZGxlciBmb3IgYSBjb25uZWN0aW9uLgogICAgICoKICAgICAqICBUaGlzIGZ1bmN0aW9uIHJlbW92ZXMgYSB0aW1lZCBoYW5kbGVyIGZyb20gdGhlIGNvbm5lY3Rpb24uICBUaGUKICAgICAqICBoYW5kUmVmIHBhcmFtZXRlciBpcyAqbm90KiB0aGUgZnVuY3Rpb24gcGFzc2VkIHRvIGFkZFRpbWVkSGFuZGxlcigpLAogICAgICogIGJ1dCBpcyB0aGUgcmVmZXJlbmNlIHJldHVybmVkIGZyb20gYWRkVGltZWRIYW5kbGVyKCkuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoU3Ryb3BoZS5UaW1lZEhhbmRsZXIpIGhhbmRSZWYgLSBUaGUgaGFuZGxlciByZWZlcmVuY2UuCiAgICAgKi8KICAgIGRlbGV0ZVRpbWVkSGFuZGxlcjogZnVuY3Rpb24gKGhhbmRSZWYpCiAgICB7CiAgICAgICAgLy8gdGhpcyBtdXN0IGJlIGRvbmUgaW4gdGhlIElkbGUgbG9vcCBzbyB0aGF0IHdlIGRvbid0IGNoYW5nZQogICAgICAgIC8vIHRoZSBoYW5kbGVycyBkdXJpbmcgaXRlcmF0aW9uCiAgICAgICAgdGhpcy5yZW1vdmVUaW1lZHMucHVzaChoYW5kUmVmKTsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiBhZGRIYW5kbGVyCiAgICAgKiAgQWRkIGEgc3RhbnphIGhhbmRsZXIgZm9yIHRoZSBjb25uZWN0aW9uLgogICAgICoKICAgICAqICBUaGlzIGZ1bmN0aW9uIGFkZHMgYSBzdGFuemEgaGFuZGxlciB0byB0aGUgY29ubmVjdGlvbi4gIFRoZQogICAgICogIGhhbmRsZXIgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgZm9yIGFueSBzdGFuemEgdGhhdCBtYXRjaGVzCiAgICAgKiAgdGhlIHBhcmFtZXRlcnMuICBOb3RlIHRoYXQgaWYgbXVsdGlwbGUgcGFyYW1ldGVycyBhcmUgc3VwcGxpZWQsCiAgICAgKiAgdGhleSBtdXN0IGFsbCBtYXRjaCBmb3IgdGhlIGhhbmRsZXIgdG8gYmUgaW52b2tlZC4KICAgICAqCiAgICAgKiAgVGhlIGhhbmRsZXIgd2lsbCByZWNlaXZlIHRoZSBzdGFuemEgdGhhdCB0cmlnZ2VyZWQgaXQgYXMgaXRzIGFyZ3VtZW50LgogICAgICogIFRoZSBoYW5kbGVyIHNob3VsZCByZXR1cm4gdHJ1ZSBpZiBpdCBpcyB0byBiZSBpbnZva2VkIGFnYWluOwogICAgICogIHJldHVybmluZyBmYWxzZSB3aWxsIHJlbW92ZSB0aGUgaGFuZGxlciBhZnRlciBpdCByZXR1cm5zLgogICAgICoKICAgICAqICBBcyBhIGNvbnZlbmllbmNlLCB0aGUgbnMgcGFyYW1ldGVycyBhcHBsaWVzIHRvIHRoZSB0b3AgbGV2ZWwgZWxlbWVudAogICAgICogIGFuZCBhbHNvIGFueSBvZiBpdHMgaW1tZWRpYXRlIGNoaWxkcmVuLiAgVGhpcyBpcyBwcmltYXJpbHkgdG8gbWFrZQogICAgICogIG1hdGNoaW5nIC9pcS9xdWVyeSBlbGVtZW50cyBlYXN5LgogICAgICoKICAgICAqICBUaGUgb3B0aW9ucyBhcmd1bWVudCBjb250YWlucyBoYW5kbGVyIG1hdGNoaW5nIGZsYWdzIHRoYXQgYWZmZWN0IGhvdwogICAgICogIG1hdGNoZXMgYXJlIGRldGVybWluZWQuIEN1cnJlbnRseSB0aGUgb25seSBmbGFnIGlzIG1hdGNoQmFyZSAoYQogICAgICogIGJvb2xlYW4pLiBXaGVuIG1hdGNoQmFyZSBpcyB0cnVlLCB0aGUgZnJvbSBwYXJhbWV0ZXIgYW5kIHRoZSBmcm9tCiAgICAgKiAgYXR0cmlidXRlIG9uIHRoZSBzdGFuemEgd2lsbCBiZSBtYXRjaGVkIGFzIGJhcmUgSklEcyBpbnN0ZWFkIG9mCiAgICAgKiAgZnVsbCBKSURzLiBUbyB1c2UgdGhpcywgcGFzcyB7bWF0Y2hCYXJlOiB0cnVlfSBhcyB0aGUgdmFsdWUgb2YKICAgICAqICBvcHRpb25zLiBUaGUgZGVmYXVsdCB2YWx1ZSBmb3IgbWF0Y2hCYXJlIGlzIGZhbHNlLgogICAgICoKICAgICAqICBUaGUgcmV0dXJuIHZhbHVlIHNob3VsZCBiZSBzYXZlZCBpZiB5b3Ugd2lzaCB0byByZW1vdmUgdGhlIGhhbmRsZXIKICAgICAqICB3aXRoIGRlbGV0ZUhhbmRsZXIoKS4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChGdW5jdGlvbikgaGFuZGxlciAtIFRoZSB1c2VyIGNhbGxiYWNrLgogICAgICogICAgKFN0cmluZykgbnMgLSBUaGUgbmFtZXNwYWNlIHRvIG1hdGNoLgogICAgICogICAgKFN0cmluZykgbmFtZSAtIFRoZSBzdGFuemEgbmFtZSB0byBtYXRjaC4KICAgICAqICAgIChTdHJpbmcpIHR5cGUgLSBUaGUgc3RhbnphIHR5cGUgYXR0cmlidXRlIHRvIG1hdGNoLgogICAgICogICAgKFN0cmluZykgaWQgLSBUaGUgc3RhbnphIGlkIGF0dHJpYnV0ZSB0byBtYXRjaC4KICAgICAqICAgIChTdHJpbmcpIGZyb20gLSBUaGUgc3RhbnphIGZyb20gYXR0cmlidXRlIHRvIG1hdGNoLgogICAgICogICAgKFN0cmluZykgb3B0aW9ucyAtIFRoZSBoYW5kbGVyIG9wdGlvbnMKICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgIEEgcmVmZXJlbmNlIHRvIHRoZSBoYW5kbGVyIHRoYXQgY2FuIGJlIHVzZWQgdG8gcmVtb3ZlIGl0LgogICAgICovCiAgICBhZGRIYW5kbGVyOiBmdW5jdGlvbiAoaGFuZGxlciwgbnMsIG5hbWUsIHR5cGUsIGlkLCBmcm9tLCBvcHRpb25zKQogICAgewogICAgICAgIHZhciBoYW5kID0gbmV3IFN0cm9waGUuSGFuZGxlcihoYW5kbGVyLCBucywgbmFtZSwgdHlwZSwgaWQsIGZyb20sIG9wdGlvbnMpOwogICAgICAgIHRoaXMuYWRkSGFuZGxlcnMucHVzaChoYW5kKTsKICAgICAgICByZXR1cm4gaGFuZDsKICAgIH0sCgogICAgLyoqIEZ1bmN0aW9uOiBkZWxldGVIYW5kbGVyCiAgICAgKiAgRGVsZXRlIGEgc3RhbnphIGhhbmRsZXIgZm9yIGEgY29ubmVjdGlvbi4KICAgICAqCiAgICAgKiAgVGhpcyBmdW5jdGlvbiByZW1vdmVzIGEgc3RhbnphIGhhbmRsZXIgZnJvbSB0aGUgY29ubmVjdGlvbi4gIFRoZQogICAgICogIGhhbmRSZWYgcGFyYW1ldGVyIGlzICpub3QqIHRoZSBmdW5jdGlvbiBwYXNzZWQgdG8gYWRkSGFuZGxlcigpLAogICAgICogIGJ1dCBpcyB0aGUgcmVmZXJlbmNlIHJldHVybmVkIGZyb20gYWRkSGFuZGxlcigpLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cm9waGUuSGFuZGxlcikgaGFuZFJlZiAtIFRoZSBoYW5kbGVyIHJlZmVyZW5jZS4KICAgICAqLwogICAgZGVsZXRlSGFuZGxlcjogZnVuY3Rpb24gKGhhbmRSZWYpCiAgICB7CiAgICAgICAgLy8gdGhpcyBtdXN0IGJlIGRvbmUgaW4gdGhlIElkbGUgbG9vcCBzbyB0aGF0IHdlIGRvbid0IGNoYW5nZQogICAgICAgIC8vIHRoZSBoYW5kbGVycyBkdXJpbmcgaXRlcmF0aW9uCiAgICAgICAgdGhpcy5yZW1vdmVIYW5kbGVycy5wdXNoKGhhbmRSZWYpOwogICAgfSwKCiAgICAvKiogRnVuY3Rpb246IGRpc2Nvbm5lY3QKICAgICAqICBTdGFydCB0aGUgZ3JhY2VmdWwgZGlzY29ubmVjdGlvbiBwcm9jZXNzLgogICAgICoKICAgICAqICBUaGlzIGZ1bmN0aW9uIHN0YXJ0cyB0aGUgZGlzY29ubmVjdGlvbiBwcm9jZXNzLiAgVGhpcyBwcm9jZXNzIHN0YXJ0cwogICAgICogIGJ5IHNlbmRpbmcgdW5hdmFpbGFibGUgcHJlc2VuY2UgYW5kIHNlbmRpbmcgQk9TSCBib2R5IG9mIHR5cGUKICAgICAqICB0ZXJtaW5hdGUuICBBIHRpbWVvdXQgaGFuZGxlciBtYWtlcyBzdXJlIHRoYXQgZGlzY29ubmVjdGlvbiBoYXBwZW5zCiAgICAgKiAgZXZlbiBpZiB0aGUgQk9TSCBzZXJ2ZXIgZG9lcyBub3QgcmVzcG9uZC4KICAgICAqCiAgICAgKiAgVGhlIHVzZXIgc3VwcGxpZWQgY29ubmVjdGlvbiBjYWxsYmFjayB3aWxsIGJlIG5vdGlmaWVkIG9mIHRoZQogICAgICogIHByb2dyZXNzIGFzIHRoaXMgcHJvY2VzcyBoYXBwZW5zLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cmluZykgcmVhc29uIC0gVGhlIHJlYXNvbiB0aGUgZGlzY29ubmVjdCBpcyBvY2N1cmluZy4KICAgICAqLwogICAgZGlzY29ubmVjdDogZnVuY3Rpb24gKHJlYXNvbikKICAgIHsKICAgICAgICB0aGlzLl9jaGFuZ2VDb25uZWN0U3RhdHVzKFN0cm9waGUuU3RhdHVzLkRJU0NPTk5FQ1RJTkcsIHJlYXNvbik7CgogICAgICAgIFN0cm9waGUuaW5mbygiRGlzY29ubmVjdCB3YXMgY2FsbGVkIGJlY2F1c2U6ICIgKyByZWFzb24pOwogICAgICAgIGlmICh0aGlzLmNvbm5lY3RlZCkgewogICAgICAgICAgICB2YXIgcHJlcyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmRpc2Nvbm5lY3RpbmcgPSB0cnVlOwogICAgICAgICAgICBpZiAodGhpcy5hdXRoZW50aWNhdGVkKSB7CiAgICAgICAgICAgICAgICBwcmVzID0gJHByZXMoewogICAgICAgICAgICAgICAgICAgIHhtbG5zOiBTdHJvcGhlLk5TLkNMSUVOVCwKICAgICAgICAgICAgICAgICAgICB0eXBlOiAndW5hdmFpbGFibGUnCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBzZXR1cCB0aW1lb3V0IGhhbmRsZXIKICAgICAgICAgICAgdGhpcy5fZGlzY29ubmVjdFRpbWVvdXQgPSB0aGlzLl9hZGRTeXNUaW1lZEhhbmRsZXIoCiAgICAgICAgICAgICAgICAzMDAwLCB0aGlzLl9vbkRpc2Nvbm5lY3RUaW1lb3V0LmJpbmQodGhpcykpOwogICAgICAgICAgICB0aGlzLl9wcm90by5fZGlzY29ubmVjdChwcmVzKTsKICAgICAgICB9CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9jaGFuZ2VDb25uZWN0U3RhdHVzCiAgICAgKiAgX1ByaXZhdGVfIGhlbHBlciBmdW5jdGlvbiB0aGF0IG1ha2VzIHN1cmUgcGx1Z2lucyBhbmQgdGhlIHVzZXIncwogICAgICogIGNhbGxiYWNrIGFyZSBub3RpZmllZCBvZiBjb25uZWN0aW9uIHN0YXR1cyBjaGFuZ2VzLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKEludGVnZXIpIHN0YXR1cyAtIHRoZSBuZXcgY29ubmVjdGlvbiBzdGF0dXMsIG9uZSBvZiB0aGUgdmFsdWVzCiAgICAgKiAgICAgIGluIFN0cm9waGUuU3RhdHVzCiAgICAgKiAgICAoU3RyaW5nKSBjb25kaXRpb24gLSB0aGUgZXJyb3IgY29uZGl0aW9uIG9yIG51bGwKICAgICAqLwogICAgX2NoYW5nZUNvbm5lY3RTdGF0dXM6IGZ1bmN0aW9uIChzdGF0dXMsIGNvbmRpdGlvbikKICAgIHsKICAgICAgICAvLyBub3RpZnkgYWxsIHBsdWdpbnMgbGlzdGVuaW5nIGZvciBzdGF0dXMgY2hhbmdlcwogICAgICAgIGZvciAodmFyIGsgaW4gU3Ryb3BoZS5fY29ubmVjdGlvblBsdWdpbnMpIHsKICAgICAgICAgICAgaWYgKFN0cm9waGUuX2Nvbm5lY3Rpb25QbHVnaW5zLmhhc093blByb3BlcnR5KGspKSB7CiAgICAgICAgICAgICAgICB2YXIgcGx1Z2luID0gdGhpc1trXTsKICAgICAgICAgICAgICAgIGlmIChwbHVnaW4uc3RhdHVzQ2hhbmdlZCkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBsdWdpbi5zdGF0dXNDaGFuZ2VkKHN0YXR1cywgY29uZGl0aW9uKTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgU3Ryb3BoZS5lcnJvcigiIiArIGsgKyAiIHBsdWdpbiBjYXVzZWQgYW4gZXhjZXB0aW9uICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjaGFuZ2luZyBzdGF0dXM6ICIgKyBlcnIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gbm90aWZ5IHRoZSB1c2VyJ3MgY2FsbGJhY2sKICAgICAgICBpZiAodGhpcy5jb25uZWN0X2NhbGxiYWNrKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbm5lY3RfY2FsbGJhY2soc3RhdHVzLCBjb25kaXRpb24pOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBTdHJvcGhlLmVycm9yKCJVc2VyIGNvbm5lY3Rpb24gY2FsbGJhY2sgY2F1c2VkIGFuICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZXhjZXB0aW9uOiAiICsgZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9kb0Rpc2Nvbm5lY3QKICAgICAqICBfUHJpdmF0ZV8gZnVuY3Rpb24gdG8gZGlzY29ubmVjdC4KICAgICAqCiAgICAgKiAgVGhpcyBpcyB0aGUgbGFzdCBwaWVjZSBvZiB0aGUgZGlzY29ubmVjdGlvbiBsb2dpYy4gIFRoaXMgcmVzZXRzIHRoZQogICAgICogIGNvbm5lY3Rpb24gYW5kIGFsZXJ0cyB0aGUgdXNlcidzIGNvbm5lY3Rpb24gY2FsbGJhY2suCiAgICAgKi8KICAgIF9kb0Rpc2Nvbm5lY3Q6IGZ1bmN0aW9uICgpCiAgICB7CiAgICAgICAgLy8gQ2FuY2VsIERpc2Nvbm5lY3QgVGltZW91dAogICAgICAgIGlmICh0aGlzLl9kaXNjb25uZWN0VGltZW91dCAhPT0gbnVsbCkgewogICAgICAgICAgICB0aGlzLmRlbGV0ZVRpbWVkSGFuZGxlcih0aGlzLl9kaXNjb25uZWN0VGltZW91dCk7CiAgICAgICAgICAgIHRoaXMuX2Rpc2Nvbm5lY3RUaW1lb3V0ID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIFN0cm9waGUuaW5mbygiX2RvRGlzY29ubmVjdCB3YXMgY2FsbGVkIik7CiAgICAgICAgdGhpcy5fcHJvdG8uX2RvRGlzY29ubmVjdCgpOwoKICAgICAgICB0aGlzLmF1dGhlbnRpY2F0ZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLmRpc2Nvbm5lY3RpbmcgPSBmYWxzZTsKCiAgICAgICAgLy8gZGVsZXRlIGhhbmRsZXJzCiAgICAgICAgdGhpcy5oYW5kbGVycyA9IFtdOwogICAgICAgIHRoaXMudGltZWRIYW5kbGVycyA9IFtdOwogICAgICAgIHRoaXMucmVtb3ZlVGltZWRzID0gW107CiAgICAgICAgdGhpcy5yZW1vdmVIYW5kbGVycyA9IFtdOwogICAgICAgIHRoaXMuYWRkVGltZWRzID0gW107CiAgICAgICAgdGhpcy5hZGRIYW5kbGVycyA9IFtdOwoKICAgICAgICAvLyB0ZWxsIHRoZSBwYXJlbnQgd2UgZGlzY29ubmVjdGVkCiAgICAgICAgdGhpcy5fY2hhbmdlQ29ubmVjdFN0YXR1cyhTdHJvcGhlLlN0YXR1cy5ESVNDT05ORUNURUQsIG51bGwpOwogICAgICAgIHRoaXMuY29ubmVjdGVkID0gZmFsc2U7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9kYXRhUmVjdgogICAgICogIF9Qcml2YXRlXyBoYW5kbGVyIHRvIHByb2Nlc3NlcyBpbmNvbWluZyBkYXRhIGZyb20gdGhlIHRoZSBjb25uZWN0aW9uLgogICAgICoKICAgICAqICBFeGNlcHQgZm9yIF9jb25uZWN0X2NiIGhhbmRsaW5nIHRoZSBpbml0aWFsIGNvbm5lY3Rpb24gcmVxdWVzdCwKICAgICAqICB0aGlzIGZ1bmN0aW9uIGhhbmRsZXMgdGhlIGluY29taW5nIGRhdGEgZm9yIGFsbCByZXF1ZXN0cy4gIFRoaXMKICAgICAqICBmdW5jdGlvbiBhbHNvIGZpcmVzIHN0YW56YSBoYW5kbGVycyB0aGF0IG1hdGNoIGVhY2ggaW5jb21pbmcKICAgICAqICBzdGFuemEuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoU3Ryb3BoZS5SZXF1ZXN0KSByZXEgLSBUaGUgcmVxdWVzdCB0aGF0IGhhcyBkYXRhIHJlYWR5LgogICAgICogICAgKHN0cmluZykgcmVxIC0gVGhlIHN0YW56YSBhIHJhdyBzdHJpbmcgKG9wdGlvbmEpLgogICAgICovCiAgICBfZGF0YVJlY3Y6IGZ1bmN0aW9uIChyZXEsIHJhdykKICAgIHsKICAgICAgICBTdHJvcGhlLmluZm8oIl9kYXRhUmVjdiBjYWxsZWQiKTsKICAgICAgICB2YXIgZWxlbSA9IHRoaXMuX3Byb3RvLl9yZXFUb0RhdGEocmVxKTsKICAgICAgICBpZiAoZWxlbSA9PT0gbnVsbCkgeyByZXR1cm47IH0KCiAgICAgICAgaWYgKHRoaXMueG1sSW5wdXQgIT09IFN0cm9waGUuQ29ubmVjdGlvbi5wcm90b3R5cGUueG1sSW5wdXQpIHsKICAgICAgICAgICAgaWYgKGVsZW0ubm9kZU5hbWUgPT09IHRoaXMuX3Byb3RvLnN0cmlwICYmIGVsZW0uY2hpbGROb2Rlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHRoaXMueG1sSW5wdXQoZWxlbS5jaGlsZE5vZGVzWzBdKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMueG1sSW5wdXQoZWxlbSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMucmF3SW5wdXQgIT09IFN0cm9waGUuQ29ubmVjdGlvbi5wcm90b3R5cGUucmF3SW5wdXQpIHsKICAgICAgICAgICAgaWYgKHJhdykgewogICAgICAgICAgICAgICAgdGhpcy5yYXdJbnB1dChyYXcpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5yYXdJbnB1dChTdHJvcGhlLnNlcmlhbGl6ZShlbGVtKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIHJlbW92ZSBoYW5kbGVycyBzY2hlZHVsZWQgZm9yIGRlbGV0aW9uCiAgICAgICAgdmFyIGksIGhhbmQ7CiAgICAgICAgd2hpbGUgKHRoaXMucmVtb3ZlSGFuZGxlcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBoYW5kID0gdGhpcy5yZW1vdmVIYW5kbGVycy5wb3AoKTsKICAgICAgICAgICAgaSA9IHRoaXMuaGFuZGxlcnMuaW5kZXhPZihoYW5kKTsKICAgICAgICAgICAgaWYgKGkgPj0gMCkgewogICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVycy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIGFkZCBoYW5kbGVycyBzY2hlZHVsZWQgZm9yIGFkZGl0aW9uCiAgICAgICAgd2hpbGUgKHRoaXMuYWRkSGFuZGxlcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB0aGlzLmhhbmRsZXJzLnB1c2godGhpcy5hZGRIYW5kbGVycy5wb3AoKSk7CiAgICAgICAgfQoKICAgICAgICAvLyBoYW5kbGUgZ3JhY2VmdWwgZGlzY29ubmVjdAogICAgICAgIGlmICh0aGlzLmRpc2Nvbm5lY3RpbmcgJiYgdGhpcy5fcHJvdG8uX2VtcHR5UXVldWUoKSkgewogICAgICAgICAgICB0aGlzLl9kb0Rpc2Nvbm5lY3QoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIHR5cCA9IGVsZW0uZ2V0QXR0cmlidXRlKCJ0eXBlIik7CiAgICAgICAgdmFyIGNvbmQsIGNvbmZsaWN0OwogICAgICAgIGlmICh0eXAgIT09IG51bGwgJiYgdHlwID09ICJ0ZXJtaW5hdGUiKSB7CiAgICAgICAgICAgIC8vIERvbid0IHByb2Nlc3Mgc3RhbnphcyB0aGF0IGNvbWUgaW4gYWZ0ZXIgZGlzY29ubmVjdAogICAgICAgICAgICBpZiAodGhpcy5kaXNjb25uZWN0aW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGFuIGVycm9yIG9jY3VycmVkCiAgICAgICAgICAgIGNvbmQgPSBlbGVtLmdldEF0dHJpYnV0ZSgiY29uZGl0aW9uIik7CiAgICAgICAgICAgIGNvbmZsaWN0ID0gZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiY29uZmxpY3QiKTsKICAgICAgICAgICAgaWYgKGNvbmQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChjb25kID09ICJyZW1vdGUtc3RyZWFtLWVycm9yIiAmJiBjb25mbGljdC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uZCA9ICJjb25mbGljdCI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9jaGFuZ2VDb25uZWN0U3RhdHVzKFN0cm9waGUuU3RhdHVzLkNPTk5GQUlMLCBjb25kKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX2NoYW5nZUNvbm5lY3RTdGF0dXMoU3Ryb3BoZS5TdGF0dXMuQ09OTkZBSUwsICJ1bmtub3duIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5kaXNjb25uZWN0KCd1bmtub3duIHN0cmVhbS1lcnJvcicpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBzZW5kIGVhY2ggaW5jb21pbmcgc3RhbnphIHRocm91Z2ggdGhlIGhhbmRsZXIgY2hhaW4KICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgU3Ryb3BoZS5mb3JFYWNoQ2hpbGQoZWxlbSwgbnVsbCwgZnVuY3Rpb24gKGNoaWxkKSB7CiAgICAgICAgICAgIHZhciBpLCBuZXdMaXN0OwogICAgICAgICAgICAvLyBwcm9jZXNzIGhhbmRsZXJzCiAgICAgICAgICAgIG5ld0xpc3QgPSB0aGF0LmhhbmRsZXJzOwogICAgICAgICAgICB0aGF0LmhhbmRsZXJzID0gW107CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBuZXdMaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgaGFuZCA9IG5ld0xpc3RbaV07CiAgICAgICAgICAgICAgICAvLyBlbmNhcHN1bGF0ZSAnaGFuZGxlci5ydW4nIG5vdCB0byBsb3NlIHRoZSB3aG9sZSBoYW5kbGVyIGxpc3QgaWYKICAgICAgICAgICAgICAgIC8vIG9uZSBvZiB0aGUgaGFuZGxlcnMgdGhyb3dzIGFuIGV4Y2VwdGlvbgogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBpZiAoaGFuZC5pc01hdGNoKGNoaWxkKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAodGhhdC5hdXRoZW50aWNhdGVkIHx8ICFoYW5kLnVzZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoYW5kLnJ1bihjaGlsZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuaGFuZGxlcnMucHVzaChoYW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuaGFuZGxlcnMucHVzaChoYW5kKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGUgaGFuZGxlciB0aHJvd3MgYW4gZXhjZXB0aW9uLCB3ZSBjb25zaWRlciBpdCBhcyBmYWxzZQogICAgICAgICAgICAgICAgICAgIFN0cm9waGUud2FybignUmVtb3ZpbmcgU3Ryb3BoZSBoYW5kbGVycyBkdWUgdG8gdW5jYXVnaHQgZXhjZXB0aW9uOiAnICsgZS5tZXNzYWdlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSwKCgogICAgLyoqIEF0dHJpYnV0ZTogbWVjaGFuaXNtcwogICAgICogIFNBU0wgTWVjaGFuaXNtcyBhdmFpbGFibGUgZm9yIENvbm5jZWN0aW9uLgogICAgICovCiAgICBtZWNoYW5pc21zOiB7fSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfY29ubmVjdF9jYgogICAgICogIF9Qcml2YXRlXyBoYW5kbGVyIGZvciBpbml0aWFsIGNvbm5lY3Rpb24gcmVxdWVzdC4KICAgICAqCiAgICAgKiAgVGhpcyBoYW5kbGVyIGlzIHVzZWQgdG8gcHJvY2VzcyB0aGUgaW5pdGlhbCBjb25uZWN0aW9uIHJlcXVlc3QKICAgICAqICByZXNwb25zZSBmcm9tIHRoZSBCT1NIIHNlcnZlci4gSXQgaXMgdXNlZCB0byBzZXQgdXAgYXV0aGVudGljYXRpb24KICAgICAqICBoYW5kbGVycyBhbmQgc3RhcnQgdGhlIGF1dGhlbnRpY2F0aW9uIHByb2Nlc3MuCiAgICAgKgogICAgICogIFNBU0wgYXV0aGVudGljYXRpb24gd2lsbCBiZSBhdHRlbXB0ZWQgaWYgYXZhaWxhYmxlLCBvdGhlcndpc2UKICAgICAqICB0aGUgY29kZSB3aWxsIGZhbGwgYmFjayB0byBsZWdhY3kgYXV0aGVudGljYXRpb24uCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoU3Ryb3BoZS5SZXF1ZXN0KSByZXEgLSBUaGUgY3VycmVudCByZXF1ZXN0LgogICAgICogICAgKEZ1bmN0aW9uKSBfY2FsbGJhY2sgLSBsb3cgbGV2ZWwgKHhtcHApIGNvbm5lY3QgY2FsbGJhY2sgZnVuY3Rpb24uCiAgICAgKiAgICAgIFVzZWZ1bCBmb3IgcGx1Z2lucyB3aXRoIHRoZWlyIG93biB4bXBwIGNvbm5lY3QgY2FsbGJhY2sgKHdoZW4gdGhlaXIpCiAgICAgKiAgICAgIHdhbnQgdG8gZG8gc29tZXRoaW5nIHNwZWNpYWwpLgogICAgICovCiAgICBfY29ubmVjdF9jYjogZnVuY3Rpb24gKHJlcSwgX2NhbGxiYWNrLCByYXcpCiAgICB7CiAgICAgICAgU3Ryb3BoZS5pbmZvKCJfY29ubmVjdF9jYiB3YXMgY2FsbGVkIik7CgogICAgICAgIHRoaXMuY29ubmVjdGVkID0gdHJ1ZTsKCiAgICAgICAgdmFyIGJvZHlXcmFwID0gdGhpcy5fcHJvdG8uX3JlcVRvRGF0YShyZXEpOwogICAgICAgIGlmICghYm9keVdyYXApIHsgcmV0dXJuOyB9CgogICAgICAgIGlmICh0aGlzLnhtbElucHV0ICE9PSBTdHJvcGhlLkNvbm5lY3Rpb24ucHJvdG90eXBlLnhtbElucHV0KSB7CiAgICAgICAgICAgIGlmIChib2R5V3JhcC5ub2RlTmFtZSA9PT0gdGhpcy5fcHJvdG8uc3RyaXAgJiYgYm9keVdyYXAuY2hpbGROb2Rlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHRoaXMueG1sSW5wdXQoYm9keVdyYXAuY2hpbGROb2Rlc1swXSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnhtbElucHV0KGJvZHlXcmFwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5yYXdJbnB1dCAhPT0gU3Ryb3BoZS5Db25uZWN0aW9uLnByb3RvdHlwZS5yYXdJbnB1dCkgewogICAgICAgICAgICBpZiAocmF3KSB7CiAgICAgICAgICAgICAgICB0aGlzLnJhd0lucHV0KHJhdyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnJhd0lucHV0KFN0cm9waGUuc2VyaWFsaXplKGJvZHlXcmFwKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhciBjb25uY2hlY2sgPSB0aGlzLl9wcm90by5fY29ubmVjdF9jYihib2R5V3JhcCk7CiAgICAgICAgaWYgKGNvbm5jaGVjayA9PT0gU3Ryb3BoZS5TdGF0dXMuQ09OTkZBSUwpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fYXV0aGVudGljYXRpb24uc2FzbF9zY3JhbV9zaGExID0gZmFsc2U7CiAgICAgICAgdGhpcy5fYXV0aGVudGljYXRpb24uc2FzbF9wbGFpbiA9IGZhbHNlOwogICAgICAgIHRoaXMuX2F1dGhlbnRpY2F0aW9uLnNhc2xfZGlnZXN0X21kNSA9IGZhbHNlOwogICAgICAgIHRoaXMuX2F1dGhlbnRpY2F0aW9uLnNhc2xfYW5vbnltb3VzID0gZmFsc2U7CgogICAgICAgIHRoaXMuX2F1dGhlbnRpY2F0aW9uLmxlZ2FjeV9hdXRoID0gZmFsc2U7CgogICAgICAgIC8vIENoZWNrIGZvciB0aGUgc3RyZWFtOmZlYXR1cmVzIHRhZwogICAgICAgIHZhciBoYXNGZWF0dXJlcyA9IGJvZHlXcmFwLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJzdHJlYW06ZmVhdHVyZXMiKS5sZW5ndGggPiAwOwogICAgICAgIGlmICghaGFzRmVhdHVyZXMpIHsKICAgICAgICAgICAgaGFzRmVhdHVyZXMgPSBib2R5V3JhcC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiZmVhdHVyZXMiKS5sZW5ndGggPiAwOwogICAgICAgIH0KICAgICAgICB2YXIgbWVjaGFuaXNtcyA9IGJvZHlXcmFwLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJtZWNoYW5pc20iKTsKICAgICAgICB2YXIgbWF0Y2hlZCA9IFtdOwogICAgICAgIHZhciBpLCBtZWNoLCBmb3VuZF9hdXRoZW50aWNhdGlvbiA9IGZhbHNlOwogICAgICAgIGlmICghaGFzRmVhdHVyZXMpIHsKICAgICAgICAgICAgdGhpcy5fcHJvdG8uX25vX2F1dGhfcmVjZWl2ZWQoX2NhbGxiYWNrKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAobWVjaGFuaXNtcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBtZWNoYW5pc21zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBtZWNoID0gU3Ryb3BoZS5nZXRUZXh0KG1lY2hhbmlzbXNbaV0pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubWVjaGFuaXNtc1ttZWNoXSkgbWF0Y2hlZC5wdXNoKHRoaXMubWVjaGFuaXNtc1ttZWNoXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5fYXV0aGVudGljYXRpb24ubGVnYWN5X2F1dGggPQogICAgICAgICAgICBib2R5V3JhcC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYXV0aCIpLmxlbmd0aCA+IDA7CiAgICAgICAgZm91bmRfYXV0aGVudGljYXRpb24gPSB0aGlzLl9hdXRoZW50aWNhdGlvbi5sZWdhY3lfYXV0aCB8fAogICAgICAgICAgICBtYXRjaGVkLmxlbmd0aCA+IDA7CiAgICAgICAgaWYgKCFmb3VuZF9hdXRoZW50aWNhdGlvbikgewogICAgICAgICAgICB0aGlzLl9wcm90by5fbm9fYXV0aF9yZWNlaXZlZChfY2FsbGJhY2spOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmRvX2F1dGhlbnRpY2F0aW9uICE9PSBmYWxzZSkKICAgICAgICAgICAgdGhpcy5hdXRoZW50aWNhdGUobWF0Y2hlZCk7CiAgICB9LAoKICAgIC8qKiBGdW5jdGlvbjogYXV0aGVudGljYXRlCiAgICAgKiBTZXQgdXAgYXV0aGVudGljYXRpb24KICAgICAqCiAgICAgKiAgQ29udGl1bnVlcyB0aGUgaW5pdGlhbCBjb25uZWN0aW9uIHJlcXVlc3QgYnkgc2V0dGluZyB1cCBhdXRoZW50aWNhdGlvbgogICAgICogIGhhbmRsZXJzIGFuZCBzdGFydCB0aGUgYXV0aGVudGljYXRpb24gcHJvY2Vzcy4KICAgICAqCiAgICAgKiAgU0FTTCBhdXRoZW50aWNhdGlvbiB3aWxsIGJlIGF0dGVtcHRlZCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZQogICAgICogIHRoZSBjb2RlIHdpbGwgZmFsbCBiYWNrIHRvIGxlZ2FjeSBhdXRoZW50aWNhdGlvbi4KICAgICAqCiAgICAgKi8KICAgIGF1dGhlbnRpY2F0ZTogZnVuY3Rpb24gKG1hdGNoZWQpCiAgICB7CiAgICAgIHZhciBpOwogICAgICAvLyBTb3J0aW5nIG1hdGNoZWQgbWVjaGFuaXNtcyBhY2NvcmRpbmcgdG8gcHJpb3JpdHkuCiAgICAgIGZvciAoaSA9IDA7IGkgPCBtYXRjaGVkLmxlbmd0aCAtIDE7ICsraSkgewogICAgICAgIHZhciBoaWdoZXIgPSBpOwogICAgICAgIGZvciAodmFyIGogPSBpICsgMTsgaiA8IG1hdGNoZWQubGVuZ3RoOyArK2opIHsKICAgICAgICAgIGlmIChtYXRjaGVkW2pdLnByb3RvdHlwZS5wcmlvcml0eSA+IG1hdGNoZWRbaGlnaGVyXS5wcm90b3R5cGUucHJpb3JpdHkpIHsKICAgICAgICAgICAgaGlnaGVyID0gajsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGhpZ2hlciAhPSBpKSB7CiAgICAgICAgICB2YXIgc3dhcCA9IG1hdGNoZWRbaV07CiAgICAgICAgICBtYXRjaGVkW2ldID0gbWF0Y2hlZFtoaWdoZXJdOwogICAgICAgICAgbWF0Y2hlZFtoaWdoZXJdID0gc3dhcDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIHJ1biBlYWNoIG1lY2hhbmlzbQogICAgICB2YXIgbWVjaGFuaXNtX2ZvdW5kID0gZmFsc2U7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBtYXRjaGVkLmxlbmd0aDsgKytpKSB7CiAgICAgICAgaWYgKCFtYXRjaGVkW2ldLnRlc3QodGhpcykpIGNvbnRpbnVlOwoKICAgICAgICB0aGlzLl9zYXNsX3N1Y2Nlc3NfaGFuZGxlciA9IHRoaXMuX2FkZFN5c0hhbmRsZXIoCiAgICAgICAgICB0aGlzLl9zYXNsX3N1Y2Nlc3NfY2IuYmluZCh0aGlzKSwgbnVsbCwKICAgICAgICAgICJzdWNjZXNzIiwgbnVsbCwgbnVsbCk7CiAgICAgICAgdGhpcy5fc2FzbF9mYWlsdXJlX2hhbmRsZXIgPSB0aGlzLl9hZGRTeXNIYW5kbGVyKAogICAgICAgICAgdGhpcy5fc2FzbF9mYWlsdXJlX2NiLmJpbmQodGhpcyksIG51bGwsCiAgICAgICAgICAiZmFpbHVyZSIsIG51bGwsIG51bGwpOwogICAgICAgIHRoaXMuX3Nhc2xfY2hhbGxlbmdlX2hhbmRsZXIgPSB0aGlzLl9hZGRTeXNIYW5kbGVyKAogICAgICAgICAgdGhpcy5fc2FzbF9jaGFsbGVuZ2VfY2IuYmluZCh0aGlzKSwgbnVsbCwKICAgICAgICAgICJjaGFsbGVuZ2UiLCBudWxsLCBudWxsKTsKCiAgICAgICAgdGhpcy5fc2FzbF9tZWNoYW5pc20gPSBuZXcgbWF0Y2hlZFtpXSgpOwogICAgICAgIHRoaXMuX3Nhc2xfbWVjaGFuaXNtLm9uU3RhcnQodGhpcyk7CgogICAgICAgIHZhciByZXF1ZXN0X2F1dGhfZXhjaGFuZ2UgPSAkYnVpbGQoImF1dGgiLCB7CiAgICAgICAgICB4bWxuczogU3Ryb3BoZS5OUy5TQVNMLAogICAgICAgICAgbWVjaGFuaXNtOiB0aGlzLl9zYXNsX21lY2hhbmlzbS5uYW1lCiAgICAgICAgfSk7CgogICAgICAgIGlmICh0aGlzLl9zYXNsX21lY2hhbmlzbS5pc0NsaWVudEZpcnN0KSB7CiAgICAgICAgICB2YXIgcmVzcG9uc2UgPSB0aGlzLl9zYXNsX21lY2hhbmlzbS5vbkNoYWxsZW5nZSh0aGlzLCBudWxsKTsKICAgICAgICAgIHJlcXVlc3RfYXV0aF9leGNoYW5nZS50KEJhc2U2NC5lbmNvZGUocmVzcG9uc2UpKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuc2VuZChyZXF1ZXN0X2F1dGhfZXhjaGFuZ2UudHJlZSgpKTsKCiAgICAgICAgbWVjaGFuaXNtX2ZvdW5kID0gdHJ1ZTsKICAgICAgICBicmVhazsKICAgICAgfQoKICAgICAgaWYgKCFtZWNoYW5pc21fZm91bmQpIHsKICAgICAgICAvLyBpZiBub25lIG9mIHRoZSBtZWNoYW5pc20gd29ya2VkCiAgICAgICAgaWYgKFN0cm9waGUuZ2V0Tm9kZUZyb21KaWQodGhpcy5qaWQpID09PSBudWxsKSB7CiAgICAgICAgICAgIC8vIHdlIGRvbid0IGhhdmUgYSBub2RlLCB3aGljaCBpcyByZXF1aXJlZCBmb3Igbm9uLWFub255bW91cwogICAgICAgICAgICAvLyBjbGllbnQgY29ubmVjdGlvbnMKICAgICAgICAgICAgdGhpcy5fY2hhbmdlQ29ubmVjdFN0YXR1cyhTdHJvcGhlLlN0YXR1cy5DT05ORkFJTCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAneC1zdHJvcGhlLWJhZC1ub24tYW5vbi1qaWQnKTsKICAgICAgICAgICAgdGhpcy5kaXNjb25uZWN0KCd4LXN0cm9waGUtYmFkLW5vbi1hbm9uLWppZCcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBmYWxsIGJhY2sgdG8gbGVnYWN5IGF1dGhlbnRpY2F0aW9uCiAgICAgICAgICB0aGlzLl9jaGFuZ2VDb25uZWN0U3RhdHVzKFN0cm9waGUuU3RhdHVzLkFVVEhFTlRJQ0FUSU5HLCBudWxsKTsKICAgICAgICAgIHRoaXMuX2FkZFN5c0hhbmRsZXIodGhpcy5fYXV0aDFfY2IuYmluZCh0aGlzKSwgbnVsbCwgbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVsbCwgIl9hdXRoXzEiKTsKCiAgICAgICAgICB0aGlzLnNlbmQoJGlxKHsKICAgICAgICAgICAgdHlwZTogImdldCIsCiAgICAgICAgICAgIHRvOiB0aGlzLmRvbWFpbiwKICAgICAgICAgICAgaWQ6ICJfYXV0aF8xIgogICAgICAgICAgfSkuYygicXVlcnkiLCB7CiAgICAgICAgICAgIHhtbG5zOiBTdHJvcGhlLk5TLkFVVEgKICAgICAgICAgIH0pLmMoInVzZXJuYW1lIiwge30pLnQoU3Ryb3BoZS5nZXROb2RlRnJvbUppZCh0aGlzLmppZCkpLnRyZWUoKSk7CiAgICAgICAgfQogICAgICB9CgogICAgfSwKCiAgICBfc2FzbF9jaGFsbGVuZ2VfY2I6IGZ1bmN0aW9uKGVsZW0pIHsKICAgICAgdmFyIGNoYWxsZW5nZSA9IEJhc2U2NC5kZWNvZGUoU3Ryb3BoZS5nZXRUZXh0KGVsZW0pKTsKICAgICAgdmFyIHJlc3BvbnNlID0gdGhpcy5fc2FzbF9tZWNoYW5pc20ub25DaGFsbGVuZ2UodGhpcywgY2hhbGxlbmdlKTsKCiAgICAgIHZhciBzdGFuemEgPSAkYnVpbGQoJ3Jlc3BvbnNlJywgewogICAgICAgICAgeG1sbnM6IFN0cm9waGUuTlMuU0FTTAogICAgICB9KTsKICAgICAgaWYgKHJlc3BvbnNlICE9PSAiIikgewogICAgICAgIHN0YW56YS50KEJhc2U2NC5lbmNvZGUocmVzcG9uc2UpKTsKICAgICAgfQogICAgICB0aGlzLnNlbmQoc3RhbnphLnRyZWUoKSk7CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX2F1dGgxX2NiCiAgICAgKiAgX1ByaXZhdGVfIGhhbmRsZXIgZm9yIGxlZ2FjeSBhdXRoZW50aWNhdGlvbi4KICAgICAqCiAgICAgKiAgVGhpcyBoYW5kbGVyIGlzIGNhbGxlZCBpbiByZXNwb25zZSB0byB0aGUgaW5pdGlhbCA8aXEgdHlwZT0nZ2V0Jy8+CiAgICAgKiAgZm9yIGxlZ2FjeSBhdXRoZW50aWNhdGlvbi4gIEl0IGJ1aWxkcyBhbiBhdXRoZW50aWNhdGlvbiA8aXEvPiBhbmQKICAgICAqICBzZW5kcyBpdCwgY3JlYXRpbmcgYSBoYW5kbGVyIChjYWxsaW5nIGJhY2sgdG8gX2F1dGgyX2NiKCkpIHRvCiAgICAgKiAgaGFuZGxlIHRoZSByZXN1bHQKICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChYTUxFbGVtZW50KSBlbGVtIC0gVGhlIHN0YW56YSB0aGF0IHRyaWdnZXJlZCB0aGUgY2FsbGJhY2suCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBmYWxzZSB0byByZW1vdmUgdGhlIGhhbmRsZXIuCiAgICAgKi8KICAgIC8qIGpzaGludCB1bnVzZWQ6ZmFsc2UgKi8KICAgIF9hdXRoMV9jYjogZnVuY3Rpb24gKGVsZW0pCiAgICB7CiAgICAgICAgLy8gYnVpbGQgcGxhaW50ZXh0IGF1dGggaXEKICAgICAgICB2YXIgaXEgPSAkaXEoe3R5cGU6ICJzZXQiLCBpZDogIl9hdXRoXzIifSkKICAgICAgICAgICAgLmMoJ3F1ZXJ5Jywge3htbG5zOiBTdHJvcGhlLk5TLkFVVEh9KQogICAgICAgICAgICAuYygndXNlcm5hbWUnLCB7fSkudChTdHJvcGhlLmdldE5vZGVGcm9tSmlkKHRoaXMuamlkKSkKICAgICAgICAgICAgLnVwKCkKICAgICAgICAgICAgLmMoJ3Bhc3N3b3JkJykudCh0aGlzLnBhc3MpOwoKICAgICAgICBpZiAoIVN0cm9waGUuZ2V0UmVzb3VyY2VGcm9tSmlkKHRoaXMuamlkKSkgewogICAgICAgICAgICAvLyBzaW5jZSB0aGUgdXNlciBoYXMgbm90IHN1cHBsaWVkIGEgcmVzb3VyY2UsIHdlIHBpY2sKICAgICAgICAgICAgLy8gYSBkZWZhdWx0IG9uZSBoZXJlLiAgdW5saWtlIG90aGVyIGF1dGggbWV0aG9kcywgdGhlIHNlcnZlcgogICAgICAgICAgICAvLyBjYW5ub3QgZG8gdGhpcyBmb3IgdXMuCiAgICAgICAgICAgIHRoaXMuamlkID0gU3Ryb3BoZS5nZXRCYXJlSmlkRnJvbUppZCh0aGlzLmppZCkgKyAnL3N0cm9waGUnOwogICAgICAgIH0KICAgICAgICBpcS51cCgpLmMoJ3Jlc291cmNlJywge30pLnQoU3Ryb3BoZS5nZXRSZXNvdXJjZUZyb21KaWQodGhpcy5qaWQpKTsKCiAgICAgICAgdGhpcy5fYWRkU3lzSGFuZGxlcih0aGlzLl9hdXRoMl9jYi5iaW5kKHRoaXMpLCBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVsbCwgbnVsbCwgIl9hdXRoXzIiKTsKCiAgICAgICAgdGhpcy5zZW5kKGlxLnRyZWUoKSk7CgogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCiAgICAvKiBqc2hpbnQgdW51c2VkOnRydWUgKi8KCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfc2FzbF9zdWNjZXNzX2NiCiAgICAgKiAgX1ByaXZhdGVfIGhhbmRsZXIgZm9yIHN1Y2Nlc2Z1bCBTQVNMIGF1dGhlbnRpY2F0aW9uLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFhNTEVsZW1lbnQpIGVsZW0gLSBUaGUgbWF0Y2hpbmcgc3RhbnphLgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgZmFsc2UgdG8gcmVtb3ZlIHRoZSBoYW5kbGVyLgogICAgICovCiAgICBfc2FzbF9zdWNjZXNzX2NiOiBmdW5jdGlvbiAoZWxlbSkKICAgIHsKICAgICAgICBpZiAodGhpcy5fc2FzbF9kYXRhWyJzZXJ2ZXItc2lnbmF0dXJlIl0pIHsKICAgICAgICAgICAgdmFyIHNlcnZlclNpZ25hdHVyZTsKICAgICAgICAgICAgdmFyIHN1Y2Nlc3MgPSBCYXNlNjQuZGVjb2RlKFN0cm9waGUuZ2V0VGV4dChlbGVtKSk7CiAgICAgICAgICAgIHZhciBhdHRyaWJNYXRjaCA9IC8oW2Etel0rKT0oW14sXSspKCx8JCkvOwogICAgICAgICAgICB2YXIgbWF0Y2hlcyA9IHN1Y2Nlc3MubWF0Y2goYXR0cmliTWF0Y2gpOwogICAgICAgICAgICBpZiAobWF0Y2hlc1sxXSA9PSAidiIpIHsKICAgICAgICAgICAgICAgIHNlcnZlclNpZ25hdHVyZSA9IG1hdGNoZXNbMl07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChzZXJ2ZXJTaWduYXR1cmUgIT0gdGhpcy5fc2FzbF9kYXRhWyJzZXJ2ZXItc2lnbmF0dXJlIl0pIHsKICAgICAgICAgICAgICAvLyByZW1vdmUgb2xkIGhhbmRsZXJzCiAgICAgICAgICAgICAgdGhpcy5kZWxldGVIYW5kbGVyKHRoaXMuX3Nhc2xfZmFpbHVyZV9oYW5kbGVyKTsKICAgICAgICAgICAgICB0aGlzLl9zYXNsX2ZhaWx1cmVfaGFuZGxlciA9IG51bGw7CiAgICAgICAgICAgICAgaWYgKHRoaXMuX3Nhc2xfY2hhbGxlbmdlX2hhbmRsZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGVsZXRlSGFuZGxlcih0aGlzLl9zYXNsX2NoYWxsZW5nZV9oYW5kbGVyKTsKICAgICAgICAgICAgICAgIHRoaXMuX3Nhc2xfY2hhbGxlbmdlX2hhbmRsZXIgPSBudWxsOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgdGhpcy5fc2FzbF9kYXRhID0ge307CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3Nhc2xfZmFpbHVyZV9jYihudWxsKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgU3Ryb3BoZS5pbmZvKCJTQVNMIGF1dGhlbnRpY2F0aW9uIHN1Y2NlZWRlZC4iKTsKCiAgICAgICAgaWYodGhpcy5fc2FzbF9tZWNoYW5pc20pCiAgICAgICAgICB0aGlzLl9zYXNsX21lY2hhbmlzbS5vblN1Y2Nlc3MoKTsKCiAgICAgICAgLy8gcmVtb3ZlIG9sZCBoYW5kbGVycwogICAgICAgIHRoaXMuZGVsZXRlSGFuZGxlcih0aGlzLl9zYXNsX2ZhaWx1cmVfaGFuZGxlcik7CiAgICAgICAgdGhpcy5fc2FzbF9mYWlsdXJlX2hhbmRsZXIgPSBudWxsOwogICAgICAgIGlmICh0aGlzLl9zYXNsX2NoYWxsZW5nZV9oYW5kbGVyKSB7CiAgICAgICAgICAgIHRoaXMuZGVsZXRlSGFuZGxlcih0aGlzLl9zYXNsX2NoYWxsZW5nZV9oYW5kbGVyKTsKICAgICAgICAgICAgdGhpcy5fc2FzbF9jaGFsbGVuZ2VfaGFuZGxlciA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9hZGRTeXNIYW5kbGVyKHRoaXMuX3Nhc2xfYXV0aDFfY2IuYmluZCh0aGlzKSwgbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzdHJlYW06ZmVhdHVyZXMiLCBudWxsLCBudWxsKTsKCiAgICAgICAgLy8gd2UgbXVzdCBzZW5kIGFuIHhtcHA6cmVzdGFydCBub3cKICAgICAgICB0aGlzLl9zZW5kUmVzdGFydCgpOwoKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9zYXNsX2F1dGgxX2NiCiAgICAgKiAgX1ByaXZhdGVfIGhhbmRsZXIgdG8gc3RhcnQgc3RyZWFtIGJpbmRpbmcuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoWE1MRWxlbWVudCkgZWxlbSAtIFRoZSBtYXRjaGluZyBzdGFuemEuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBmYWxzZSB0byByZW1vdmUgdGhlIGhhbmRsZXIuCiAgICAgKi8KICAgIF9zYXNsX2F1dGgxX2NiOiBmdW5jdGlvbiAoZWxlbSkKICAgIHsKICAgICAgICAvLyBzYXZlIHN0cmVhbTpmZWF0dXJlcyBmb3IgZnV0dXJlIHVzYWdlCiAgICAgICAgdGhpcy5mZWF0dXJlcyA9IGVsZW07CgogICAgICAgIHZhciBpLCBjaGlsZDsKCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGVsZW0uY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjaGlsZCA9IGVsZW0uY2hpbGROb2Rlc1tpXTsKICAgICAgICAgICAgaWYgKGNoaWxkLm5vZGVOYW1lID09ICdiaW5kJykgewogICAgICAgICAgICAgICAgdGhpcy5kb19iaW5kID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNoaWxkLm5vZGVOYW1lID09ICdzZXNzaW9uJykgewogICAgICAgICAgICAgICAgdGhpcy5kb19zZXNzaW9uID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKCF0aGlzLmRvX2JpbmQpIHsKICAgICAgICAgICAgdGhpcy5fY2hhbmdlQ29ubmVjdFN0YXR1cyhTdHJvcGhlLlN0YXR1cy5BVVRIRkFJTCwgbnVsbCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl9hZGRTeXNIYW5kbGVyKHRoaXMuX3Nhc2xfYmluZF9jYi5iaW5kKHRoaXMpLCBudWxsLCBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bGwsICJfYmluZF9hdXRoXzIiKTsKCiAgICAgICAgICAgIHZhciByZXNvdXJjZSA9IFN0cm9waGUuZ2V0UmVzb3VyY2VGcm9tSmlkKHRoaXMuamlkKTsKICAgICAgICAgICAgaWYgKHJlc291cmNlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNlbmQoJGlxKHt0eXBlOiAic2V0IiwgaWQ6ICJfYmluZF9hdXRoXzIifSkKICAgICAgICAgICAgICAgICAgICAgICAgICAuYygnYmluZCcsIHt4bWxuczogU3Ryb3BoZS5OUy5CSU5EfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAuYygncmVzb3VyY2UnLCB7fSkudChyZXNvdXJjZSkudHJlZSgpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2VuZCgkaXEoe3R5cGU6ICJzZXQiLCBpZDogIl9iaW5kX2F1dGhfMiJ9KQogICAgICAgICAgICAgICAgICAgICAgICAgIC5jKCdiaW5kJywge3htbG5zOiBTdHJvcGhlLk5TLkJJTkR9KQogICAgICAgICAgICAgICAgICAgICAgICAgIC50cmVlKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9zYXNsX2JpbmRfY2IKICAgICAqICBfUHJpdmF0ZV8gaGFuZGxlciBmb3IgYmluZGluZyByZXN1bHQgYW5kIHNlc3Npb24gc3RhcnQuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoWE1MRWxlbWVudCkgZWxlbSAtIFRoZSBtYXRjaGluZyBzdGFuemEuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBmYWxzZSB0byByZW1vdmUgdGhlIGhhbmRsZXIuCiAgICAgKi8KICAgIF9zYXNsX2JpbmRfY2I6IGZ1bmN0aW9uIChlbGVtKQogICAgewogICAgICAgIGlmIChlbGVtLmdldEF0dHJpYnV0ZSgidHlwZSIpID09ICJlcnJvciIpIHsKICAgICAgICAgICAgU3Ryb3BoZS5pbmZvKCJTQVNMIGJpbmRpbmcgZmFpbGVkLiIpOwogICAgICAgICAgICB2YXIgY29uZmxpY3QgPSBlbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJjb25mbGljdCIpLCBjb25kaXRpb247CiAgICAgICAgICAgIGlmIChjb25mbGljdC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBjb25kaXRpb24gPSAnY29uZmxpY3QnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX2NoYW5nZUNvbm5lY3RTdGF0dXMoU3Ryb3BoZS5TdGF0dXMuQVVUSEZBSUwsIGNvbmRpdGlvbik7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIC8vIFRPRE8gLSBuZWVkIHRvIGdyYWIgZXJyb3JzCiAgICAgICAgdmFyIGJpbmQgPSBlbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJiaW5kIik7CiAgICAgICAgdmFyIGppZE5vZGU7CiAgICAgICAgaWYgKGJpbmQubGVuZ3RoID4gMCkgewogICAgICAgICAgICAvLyBHcmFiIGppZAogICAgICAgICAgICBqaWROb2RlID0gYmluZFswXS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiamlkIik7CiAgICAgICAgICAgIGlmIChqaWROb2RlLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuamlkID0gU3Ryb3BoZS5nZXRUZXh0KGppZE5vZGVbMF0pOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRvX3Nlc3Npb24pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hZGRTeXNIYW5kbGVyKHRoaXMuX3Nhc2xfc2Vzc2lvbl9jYi5iaW5kKHRoaXMpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVsbCwgbnVsbCwgbnVsbCwgIl9zZXNzaW9uX2F1dGhfMiIpOwoKICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbmQoJGlxKHt0eXBlOiAic2V0IiwgaWQ6ICJfc2Vzc2lvbl9hdXRoXzIifSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jKCdzZXNzaW9uJywge3htbG5zOiBTdHJvcGhlLk5TLlNFU1NJT059KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRyZWUoKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXV0aGVudGljYXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2hhbmdlQ29ubmVjdFN0YXR1cyhTdHJvcGhlLlN0YXR1cy5DT05ORUNURUQsIG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgU3Ryb3BoZS5pbmZvKCJTQVNMIGJpbmRpbmcgZmFpbGVkLiIpOwogICAgICAgICAgICB0aGlzLl9jaGFuZ2VDb25uZWN0U3RhdHVzKFN0cm9waGUuU3RhdHVzLkFVVEhGQUlMLCBudWxsKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX3Nhc2xfc2Vzc2lvbl9jYgogICAgICogIF9Qcml2YXRlXyBoYW5kbGVyIHRvIGZpbmlzaCBzdWNjZXNzZnVsIFNBU0wgY29ubmVjdGlvbi4KICAgICAqCiAgICAgKiAgVGhpcyBzZXRzIENvbm5lY3Rpb24uYXV0aGVudGljYXRlZCB0byB0cnVlIG9uIHN1Y2Nlc3MsIHdoaWNoCiAgICAgKiAgc3RhcnRzIHRoZSBwcm9jZXNzaW5nIG9mIHVzZXIgaGFuZGxlcnMuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoWE1MRWxlbWVudCkgZWxlbSAtIFRoZSBtYXRjaGluZyBzdGFuemEuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBmYWxzZSB0byByZW1vdmUgdGhlIGhhbmRsZXIuCiAgICAgKi8KICAgIF9zYXNsX3Nlc3Npb25fY2I6IGZ1bmN0aW9uIChlbGVtKQogICAgewogICAgICAgIGlmIChlbGVtLmdldEF0dHJpYnV0ZSgidHlwZSIpID09ICJyZXN1bHQiKSB7CiAgICAgICAgICAgIHRoaXMuYXV0aGVudGljYXRlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX2NoYW5nZUNvbm5lY3RTdGF0dXMoU3Ryb3BoZS5TdGF0dXMuQ09OTkVDVEVELCBudWxsKTsKICAgICAgICB9IGVsc2UgaWYgKGVsZW0uZ2V0QXR0cmlidXRlKCJ0eXBlIikgPT0gImVycm9yIikgewogICAgICAgICAgICBTdHJvcGhlLmluZm8oIlNlc3Npb24gY3JlYXRpb24gZmFpbGVkLiIpOwogICAgICAgICAgICB0aGlzLl9jaGFuZ2VDb25uZWN0U3RhdHVzKFN0cm9waGUuU3RhdHVzLkFVVEhGQUlMLCBudWxsKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfc2FzbF9mYWlsdXJlX2NiCiAgICAgKiAgX1ByaXZhdGVfIGhhbmRsZXIgZm9yIFNBU0wgYXV0aGVudGljYXRpb24gZmFpbHVyZS4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChYTUxFbGVtZW50KSBlbGVtIC0gVGhlIG1hdGNoaW5nIHN0YW56YS4KICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgIGZhbHNlIHRvIHJlbW92ZSB0aGUgaGFuZGxlci4KICAgICAqLwogICAgLyoganNoaW50IHVudXNlZDpmYWxzZSAqLwogICAgX3Nhc2xfZmFpbHVyZV9jYjogZnVuY3Rpb24gKGVsZW0pCiAgICB7CiAgICAgICAgLy8gZGVsZXRlIHVubmVlZGVkIGhhbmRsZXJzCiAgICAgICAgaWYgKHRoaXMuX3Nhc2xfc3VjY2Vzc19oYW5kbGVyKSB7CiAgICAgICAgICAgIHRoaXMuZGVsZXRlSGFuZGxlcih0aGlzLl9zYXNsX3N1Y2Nlc3NfaGFuZGxlcik7CiAgICAgICAgICAgIHRoaXMuX3Nhc2xfc3VjY2Vzc19oYW5kbGVyID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX3Nhc2xfY2hhbGxlbmdlX2hhbmRsZXIpIHsKICAgICAgICAgICAgdGhpcy5kZWxldGVIYW5kbGVyKHRoaXMuX3Nhc2xfY2hhbGxlbmdlX2hhbmRsZXIpOwogICAgICAgICAgICB0aGlzLl9zYXNsX2NoYWxsZW5nZV9oYW5kbGVyID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmKHRoaXMuX3Nhc2xfbWVjaGFuaXNtKQogICAgICAgICAgdGhpcy5fc2FzbF9tZWNoYW5pc20ub25GYWlsdXJlKCk7CiAgICAgICAgdGhpcy5fY2hhbmdlQ29ubmVjdFN0YXR1cyhTdHJvcGhlLlN0YXR1cy5BVVRIRkFJTCwgbnVsbCk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAgIC8qIGpzaGludCB1bnVzZWQ6dHJ1ZSAqLwoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9hdXRoMl9jYgogICAgICogIF9Qcml2YXRlXyBoYW5kbGVyIHRvIGZpbmlzaCBsZWdhY3kgYXV0aGVudGljYXRpb24uCiAgICAgKgogICAgICogIFRoaXMgaGFuZGxlciBpcyBjYWxsZWQgd2hlbiB0aGUgcmVzdWx0IGZyb20gdGhlIGphYmJlcjppcTphdXRoCiAgICAgKiAgPGlxLz4gc3RhbnphIGlzIHJldHVybmVkLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFhNTEVsZW1lbnQpIGVsZW0gLSBUaGUgc3RhbnphIHRoYXQgdHJpZ2dlcmVkIHRoZSBjYWxsYmFjay4KICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgIGZhbHNlIHRvIHJlbW92ZSB0aGUgaGFuZGxlci4KICAgICAqLwogICAgX2F1dGgyX2NiOiBmdW5jdGlvbiAoZWxlbSkKICAgIHsKICAgICAgICBpZiAoZWxlbS5nZXRBdHRyaWJ1dGUoInR5cGUiKSA9PSAicmVzdWx0IikgewogICAgICAgICAgICB0aGlzLmF1dGhlbnRpY2F0ZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLl9jaGFuZ2VDb25uZWN0U3RhdHVzKFN0cm9waGUuU3RhdHVzLkNPTk5FQ1RFRCwgbnVsbCk7CiAgICAgICAgfSBlbHNlIGlmIChlbGVtLmdldEF0dHJpYnV0ZSgidHlwZSIpID09ICJlcnJvciIpIHsKICAgICAgICAgICAgdGhpcy5fY2hhbmdlQ29ubmVjdFN0YXR1cyhTdHJvcGhlLlN0YXR1cy5BVVRIRkFJTCwgbnVsbCk7CiAgICAgICAgICAgIHRoaXMuZGlzY29ubmVjdCgnYXV0aGVudGljYXRpb24gZmFpbGVkJyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9hZGRTeXNUaW1lZEhhbmRsZXIKICAgICAqICBfUHJpdmF0ZV8gZnVuY3Rpb24gdG8gYWRkIGEgc3lzdGVtIGxldmVsIHRpbWVkIGhhbmRsZXIuCiAgICAgKgogICAgICogIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhZGQgYSBTdHJvcGhlLlRpbWVkSGFuZGxlciBmb3IgdGhlCiAgICAgKiAgbGlicmFyeSBjb2RlLiAgU3lzdGVtIHRpbWVkIGhhbmRsZXJzIGFyZSBhbGxvd2VkIHRvIHJ1biBiZWZvcmUKICAgICAqICBhdXRoZW50aWNhdGlvbiBpcyBjb21wbGV0ZS4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChJbnRlZ2VyKSBwZXJpb2QgLSBUaGUgcGVyaW9kIG9mIHRoZSBoYW5kbGVyLgogICAgICogICAgKEZ1bmN0aW9uKSBoYW5kbGVyIC0gVGhlIGNhbGxiYWNrIGZ1bmN0aW9uLgogICAgICovCiAgICBfYWRkU3lzVGltZWRIYW5kbGVyOiBmdW5jdGlvbiAocGVyaW9kLCBoYW5kbGVyKQogICAgewogICAgICAgIHZhciB0aGFuZCA9IG5ldyBTdHJvcGhlLlRpbWVkSGFuZGxlcihwZXJpb2QsIGhhbmRsZXIpOwogICAgICAgIHRoYW5kLnVzZXIgPSBmYWxzZTsKICAgICAgICB0aGlzLmFkZFRpbWVkcy5wdXNoKHRoYW5kKTsKICAgICAgICByZXR1cm4gdGhhbmQ7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9hZGRTeXNIYW5kbGVyCiAgICAgKiAgX1ByaXZhdGVfIGZ1bmN0aW9uIHRvIGFkZCBhIHN5c3RlbSBsZXZlbCBzdGFuemEgaGFuZGxlci4KICAgICAqCiAgICAgKiAgVGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGFkZCBhIFN0cm9waGUuSGFuZGxlciBmb3IgdGhlCiAgICAgKiAgbGlicmFyeSBjb2RlLiAgU3lzdGVtIHN0YW56YSBoYW5kbGVycyBhcmUgYWxsb3dlZCB0byBydW4gYmVmb3JlCiAgICAgKiAgYXV0aGVudGljYXRpb24gaXMgY29tcGxldGUuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoRnVuY3Rpb24pIGhhbmRsZXIgLSBUaGUgY2FsbGJhY2sgZnVuY3Rpb24uCiAgICAgKiAgICAoU3RyaW5nKSBucyAtIFRoZSBuYW1lc3BhY2UgdG8gbWF0Y2guCiAgICAgKiAgICAoU3RyaW5nKSBuYW1lIC0gVGhlIHN0YW56YSBuYW1lIHRvIG1hdGNoLgogICAgICogICAgKFN0cmluZykgdHlwZSAtIFRoZSBzdGFuemEgdHlwZSBhdHRyaWJ1dGUgdG8gbWF0Y2guCiAgICAgKiAgICAoU3RyaW5nKSBpZCAtIFRoZSBzdGFuemEgaWQgYXR0cmlidXRlIHRvIG1hdGNoLgogICAgICovCiAgICBfYWRkU3lzSGFuZGxlcjogZnVuY3Rpb24gKGhhbmRsZXIsIG5zLCBuYW1lLCB0eXBlLCBpZCkKICAgIHsKICAgICAgICB2YXIgaGFuZCA9IG5ldyBTdHJvcGhlLkhhbmRsZXIoaGFuZGxlciwgbnMsIG5hbWUsIHR5cGUsIGlkKTsKICAgICAgICBoYW5kLnVzZXIgPSBmYWxzZTsKICAgICAgICB0aGlzLmFkZEhhbmRsZXJzLnB1c2goaGFuZCk7CiAgICAgICAgcmV0dXJuIGhhbmQ7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9vbkRpc2Nvbm5lY3RUaW1lb3V0CiAgICAgKiAgX1ByaXZhdGVfIHRpbWVvdXQgaGFuZGxlciBmb3IgaGFuZGxpbmcgbm9uLWdyYWNlZnVsIGRpc2Nvbm5lY3Rpb24uCiAgICAgKgogICAgICogIElmIHRoZSBncmFjZWZ1bCBkaXNjb25uZWN0IHByb2Nlc3MgZG9lcyBub3QgY29tcGxldGUgd2l0aGluIHRoZQogICAgICogIHRpbWUgYWxsb3R0ZWQsIHRoaXMgaGFuZGxlciBmaW5pc2hlcyB0aGUgZGlzY29ubmVjdCBhbnl3YXkuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBmYWxzZSB0byByZW1vdmUgdGhlIGhhbmRsZXIuCiAgICAgKi8KICAgIF9vbkRpc2Nvbm5lY3RUaW1lb3V0OiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIFN0cm9waGUuaW5mbygiX29uRGlzY29ubmVjdFRpbWVvdXQgd2FzIGNhbGxlZCIpOwoKICAgICAgICB0aGlzLl9wcm90by5fb25EaXNjb25uZWN0VGltZW91dCgpOwoKICAgICAgICAvLyBhY3R1YWxseSBkaXNjb25uZWN0CiAgICAgICAgdGhpcy5fZG9EaXNjb25uZWN0KCk7CgogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX29uSWRsZQogICAgICogIF9Qcml2YXRlXyBoYW5kbGVyIHRvIHByb2Nlc3MgZXZlbnRzIGR1cmluZyBpZGxlIGN5Y2xlLgogICAgICoKICAgICAqICBUaGlzIGhhbmRsZXIgaXMgY2FsbGVkIGV2ZXJ5IDEwMG1zIHRvIGZpcmUgdGltZWQgaGFuZGxlcnMgdGhhdAogICAgICogIGFyZSByZWFkeSBhbmQga2VlcCBwb2xsIHJlcXVlc3RzIGdvaW5nLgogICAgICovCiAgICBfb25JZGxlOiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIHZhciBpLCB0aGFuZCwgc2luY2UsIG5ld0xpc3Q7CgogICAgICAgIC8vIGFkZCB0aW1lZCBoYW5kbGVycyBzY2hlZHVsZWQgZm9yIGFkZGl0aW9uCiAgICAgICAgLy8gTk9URTogd2UgYWRkIGJlZm9yZSByZW1vdmUgaW4gdGhlIGNhc2UgYSB0aW1lZCBoYW5kbGVyIGlzCiAgICAgICAgLy8gYWRkZWQgYW5kIHRoZW4gZGVsZXRlZCBiZWZvcmUgdGhlIG5leHQgX29uSWRsZSgpIGNhbGwuCiAgICAgICAgd2hpbGUgKHRoaXMuYWRkVGltZWRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdGhpcy50aW1lZEhhbmRsZXJzLnB1c2godGhpcy5hZGRUaW1lZHMucG9wKCkpOwogICAgICAgIH0KCiAgICAgICAgLy8gcmVtb3ZlIHRpbWVkIGhhbmRsZXJzIHRoYXQgaGF2ZSBiZWVuIHNjaGVkdWxlZCBmb3IgZGVsZXRpb24KICAgICAgICB3aGlsZSAodGhpcy5yZW1vdmVUaW1lZHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB0aGFuZCA9IHRoaXMucmVtb3ZlVGltZWRzLnBvcCgpOwogICAgICAgICAgICBpID0gdGhpcy50aW1lZEhhbmRsZXJzLmluZGV4T2YodGhhbmQpOwogICAgICAgICAgICBpZiAoaSA+PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRpbWVkSGFuZGxlcnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBjYWxsIHJlYWR5IHRpbWVkIGhhbmRsZXJzCiAgICAgICAgdmFyIG5vdyA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgICAgIG5ld0xpc3QgPSBbXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy50aW1lZEhhbmRsZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHRoYW5kID0gdGhpcy50aW1lZEhhbmRsZXJzW2ldOwogICAgICAgICAgICBpZiAodGhpcy5hdXRoZW50aWNhdGVkIHx8ICF0aGFuZC51c2VyKSB7CiAgICAgICAgICAgICAgICBzaW5jZSA9IHRoYW5kLmxhc3RDYWxsZWQgKyB0aGFuZC5wZXJpb2Q7CiAgICAgICAgICAgICAgICBpZiAoc2luY2UgLSBub3cgPD0gMCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGFuZC5ydW4oKSkgewogICAgICAgICAgICAgICAgICAgICAgICBuZXdMaXN0LnB1c2godGhhbmQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbmV3TGlzdC5wdXNoKHRoYW5kKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLnRpbWVkSGFuZGxlcnMgPSBuZXdMaXN0OwoKICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5faWRsZVRpbWVvdXQpOwoKICAgICAgICB0aGlzLl9wcm90by5fb25JZGxlKCk7CgogICAgICAgIC8vIHJlYWN0aXZhdGUgdGhlIHRpbWVyIG9ubHkgaWYgY29ubmVjdGVkCiAgICAgICAgaWYgKHRoaXMuY29ubmVjdGVkKSB7CiAgICAgICAgICAgIHRoaXMuX2lkbGVUaW1lb3V0ID0gc2V0VGltZW91dCh0aGlzLl9vbklkbGUuYmluZCh0aGlzKSwgMTAwKTsKICAgICAgICB9CiAgICB9Cn07CgppZiAoY2FsbGJhY2spIHsKICAgIGNhbGxiYWNrKFN0cm9waGUsICRidWlsZCwgJG1zZywgJGlxLCAkcHJlcyk7Cn0KCi8qKiBDbGFzczogU3Ryb3BoZS5TQVNMTWVjaGFuaXNtCiAqCiAqICBlbmNhcHN1bGF0ZXMgU0FTTCBhdXRoZW50aWNhdGlvbiBtZWNoYW5pc21zLgogKgogKiAgVXNlciBjb2RlIG1heSBvdmVycmlkZSB0aGUgcHJpb3JpdHkgZm9yIGVhY2ggbWVjaGFuaXNtIG9yIGRpc2FibGUgaXQgY29tcGxldGVseS4KICogIFNlZSA8cHJpb3JpdHk+IGZvciBpbmZvcm1hdGlvbiBhYm91dCBjaGFuZ2luZyBwcmlvcml0eSBhbmQgPHRlc3Q+IGZvciBpbmZvcm1hdGlhbiBvbgogKiAgaG93IHRvIGRpc2FibGUgYSBtZWNoYW5pc20uCiAqCiAqICBCeSBkZWZhdWx0LCBhbGwgbWVjaGFuaXNtcyBhcmUgZW5hYmxlZCBhbmQgdGhlIHByaW9yaXRpZXMgYXJlCiAqCiAqICBTQ1JBTS1TSEExIC0gNDAKICogIERJR0VTVC1NRDUgLSAzMAogKiAgUGxhaW4gLSAyMAogKi8KCi8qKgogKiBQcml2YXRlQ29uc3RydWN0b3I6IFN0cm9waGUuU0FTTE1lY2hhbmlzbQogKiBTQVNMIGF1dGggbWVjaGFuaXNtIGFic3RyYWN0aW9uLgogKgogKiAgUGFyYW1ldGVyczoKICogICAgKFN0cmluZykgbmFtZSAtIFNBU0wgTWVjaGFuaXNtIG5hbWUuCiAqICAgIChCb29sZWFuKSBpc0NsaWVudEZpcnN0IC0gSWYgY2xpZW50IHNob3VsZCBzZW5kIHJlc3BvbnNlIGZpcnN0IHdpdGhvdXQgY2hhbGxlbmdlLgogKiAgICAoTnVtYmVyKSBwcmlvcml0eSAtIFByaW9yaXR5LgogKgogKiAgUmV0dXJuczoKICogICAgQSBuZXcgU3Ryb3BoZS5TQVNMTWVjaGFuaXNtIG9iamVjdC4KICovClN0cm9waGUuU0FTTE1lY2hhbmlzbSA9IGZ1bmN0aW9uKG5hbWUsIGlzQ2xpZW50Rmlyc3QsIHByaW9yaXR5KSB7CiAgLyoqIFByaXZhdGVWYXJpYWJsZTogbmFtZQogICAqICBNZWNoYW5pc20gbmFtZS4KICAgKi8KICB0aGlzLm5hbWUgPSBuYW1lOwogIC8qKiBQcml2YXRlVmFyaWFibGU6IGlzQ2xpZW50Rmlyc3QKICAgKiAgSWYgY2xpZW50IHNlbmRzIHJlc3BvbnNlIHdpdGhvdXQgaW5pdGlhbCBzZXJ2ZXIgY2hhbGxlbmdlLgogICAqLwogIHRoaXMuaXNDbGllbnRGaXJzdCA9IGlzQ2xpZW50Rmlyc3Q7CiAgLyoqIFZhcmlhYmxlOiBwcmlvcml0eQogICAqICBEZXRlcm1pbmVzIHdoaWNoIDxTQVNMTWVjaGFuaXNtPiBpcyBjaG9zZW4gZm9yIGF1dGhlbnRpY2F0aW9uIChIaWdoZXIgaXMgYmV0dGVyKS4KICAgKiAgVXNlcnMgbWF5IG92ZXJyaWRlIHRoaXMgdG8gcHJpb3JpdGl6ZSBtZWNoYW5pc21zIGRpZmZlcmVudGx5LgogICAqCiAgICogIEluIHRoZSBkZWZhdWx0IGNvbmZpZ3VyYXRpb24gdGhlIHByaW9yaXRpZXMgYXJlCiAgICoKICAgKiAgU0NSQU0tU0hBMSAtIDQwCiAgICogIERJR0VTVC1NRDUgLSAzMAogICAqICBQbGFpbiAtIDIwCiAgICoKICAgKiAgRXhhbXBsZTogKFRoaXMgd2lsbCBjYXVzZSBTdHJvcGhlIHRvIGNob29zZSB0aGUgbWVjaGFuaXNtIHRoYXQgdGhlIHNlcnZlciBzZW50IGZpcnN0KQogICAqCiAgICogID4gU3Ryb3BoZS5TQVNMTUQ1LnByaW9yaXR5ID0gU3Ryb3BoZS5TQVNMU0hBMS5wcmlvcml0eTsKICAgKgogICAqICBTZWUgPFNBU0wgbWVjaGFuaXNtcz4gZm9yIGEgbGlzdCBvZiBhdmFpbGFibGUgbWVjaGFuaXNtcy4KICAgKgogICAqLwogIHRoaXMucHJpb3JpdHkgPSBwcmlvcml0eTsKfTsKClN0cm9waGUuU0FTTE1lY2hhbmlzbS5wcm90b3R5cGUgPSB7CiAgLyoqCiAgICogIEZ1bmN0aW9uOiB0ZXN0CiAgICogIENoZWNrcyBpZiBtZWNoYW5pc20gYWJsZSB0byBydW4uCiAgICogIFRvIGRpc2FibGUgYSBtZWNoYW5pc20sIG1ha2UgdGhpcyByZXR1cm4gZmFsc2U7CiAgICoKICAgKiAgVG8gZGlzYWJsZSBwbGFpbiBhdXRoZW50aWNhdGlvbiBydW4KICAgKiAgPiBTdHJvcGhlLlNBU0xQbGFpbi50ZXN0ID0gZnVuY3Rpb24oKSB7CiAgICogID4gICByZXR1cm4gZmFsc2U7CiAgICogID4gfQogICAqCiAgICogIFNlZSA8U0FTTCBtZWNoYW5pc21zPiBmb3IgYSBsaXN0IG9mIGF2YWlsYWJsZSBtZWNoYW5pc21zLgogICAqCiAgICogIFBhcmFtZXRlcnM6CiAgICogICAgKFN0cm9waGUuQ29ubmVjdGlvbikgY29ubmVjdGlvbiAtIFRhcmdldCBDb25uZWN0aW9uLgogICAqCiAgICogIFJldHVybnM6CiAgICogICAgKEJvb2xlYW4pIElmIG1lY2hhbmlzbSB3YXMgYWJsZSB0byBydW4uCiAgICovCiAgLyoganNoaW50IHVudXNlZDpmYWxzZSAqLwogIHRlc3Q6IGZ1bmN0aW9uKGNvbm5lY3Rpb24pIHsKICAgIHJldHVybiB0cnVlOwogIH0sCiAgLyoganNoaW50IHVudXNlZDp0cnVlICovCgogIC8qKiBQcml2YXRlRnVuY3Rpb246IG9uU3RhcnQKICAgKiAgQ2FsbGVkIGJlZm9yZSBzdGFydGluZyBtZWNoYW5pc20gb24gc29tZSBjb25uZWN0aW9uLgogICAqCiAgICogIFBhcmFtZXRlcnM6CiAgICogICAgKFN0cm9waGUuQ29ubmVjdGlvbikgY29ubmVjdGlvbiAtIFRhcmdldCBDb25uZWN0aW9uLgogICAqLwogIG9uU3RhcnQ6IGZ1bmN0aW9uKGNvbm5lY3Rpb24pCiAgewogICAgdGhpcy5fY29ubmVjdGlvbiA9IGNvbm5lY3Rpb247CiAgfSwKCiAgLyoqIFByaXZhdGVGdW5jdGlvbjogb25DaGFsbGVuZ2UKICAgKiAgQ2FsbGVkIGJ5IHByb3RvY29sIGltcGxlbWVudGF0aW9uIG9uIGluY29taW5nIGNoYWxsZW5nZS4gSWYgY2xpZW50IGlzCiAgICogIGZpcnN0IChpc0NsaWVudEZpcnN0ID09IHRydWUpIGNoYWxsZW5nZSB3aWxsIGJlIG51bGwgb24gdGhlIGZpcnN0IGNhbGwuCiAgICoKICAgKiAgUGFyYW1ldGVyczoKICAgKiAgICAoU3Ryb3BoZS5Db25uZWN0aW9uKSBjb25uZWN0aW9uIC0gVGFyZ2V0IENvbm5lY3Rpb24uCiAgICogICAgKFN0cmluZykgY2hhbGxlbmdlIC0gY3VycmVudCBjaGFsbGVuZ2UgdG8gaGFuZGxlLgogICAqCiAgICogIFJldHVybnM6CiAgICogICAgKFN0cmluZykgTWVjaGFuaXNtIHJlc3BvbnNlLgogICAqLwogIC8qIGpzaGludCB1bnVzZWQ6ZmFsc2UgKi8KICBvbkNoYWxsZW5nZTogZnVuY3Rpb24oY29ubmVjdGlvbiwgY2hhbGxlbmdlKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIllvdSBzaG91bGQgaW1wbGVtZW50IGNoYWxsZW5nZSBoYW5kbGluZyEiKTsKICB9LAogIC8qIGpzaGludCB1bnVzZWQ6dHJ1ZSAqLwoKICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBvbkZhaWx1cmUKICAgKiAgUHJvdG9jb2wgaW5mb3JtcyBtZWNoYW5pc20gaW1wbGVtZW50YXRpb24gYWJvdXQgU0FTTCBmYWlsdXJlLgogICAqLwogIG9uRmFpbHVyZTogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9jb25uZWN0aW9uID0gbnVsbDsKICB9LAoKICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBvblN1Y2Nlc3MKICAgKiAgUHJvdG9jb2wgaW5mb3JtcyBtZWNoYW5pc20gaW1wbGVtZW50YXRpb24gYWJvdXQgU0FTTCBzdWNjZXNzLgogICAqLwogIG9uU3VjY2VzczogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9jb25uZWN0aW9uID0gbnVsbDsKICB9Cn07CgogIC8qKiBDb25zdGFudHM6IFNBU0wgbWVjaGFuaXNtcwogICAqICBBdmFpbGFibGUgYXV0aGVudGljYXRpb24gbWVjaGFuaXNtcwogICAqCiAgICogIFN0cm9waGUuU0FTTEFub255bW91cyAtIFNBU0wgQW5vbnltb3VzIGF1dGhlbnRpY2F0aW9uLgogICAqICBTdHJvcGhlLlNBU0xQbGFpbiAtIFNBU0wgUGxhaW4gYXV0aGVudGljYXRpb24uCiAgICogIFN0cm9waGUuU0FTTE1ENSAtIFNBU0wgRGlnZXN0LU1ENSBhdXRoZW50aWNhdGlvbgogICAqICBTdHJvcGhlLlNBU0xTSEExIC0gU0FTTCBTQ1JBTS1TSEExIGF1dGhlbnRpY2F0aW9uCiAgICovCgovLyBCdWlsZGluZyBTQVNMIGNhbGxiYWNrcwoKLyoqIFByaXZhdGVDb25zdHJ1Y3RvcjogU0FTTEFub255bW91cwogKiAgU0FTTCBBbm9ueW1vdXMgYXV0aGVudGljYXRpb24uCiAqLwpTdHJvcGhlLlNBU0xBbm9ueW1vdXMgPSBmdW5jdGlvbigpIHt9OwoKU3Ryb3BoZS5TQVNMQW5vbnltb3VzLnByb3RvdHlwZSA9IG5ldyBTdHJvcGhlLlNBU0xNZWNoYW5pc20oIkFOT05ZTU9VUyIsIGZhbHNlLCAxMCk7CgpTdHJvcGhlLlNBU0xBbm9ueW1vdXMudGVzdCA9IGZ1bmN0aW9uKGNvbm5lY3Rpb24pIHsKICByZXR1cm4gY29ubmVjdGlvbi5hdXRoY2lkID09PSBudWxsOwp9OwoKU3Ryb3BoZS5Db25uZWN0aW9uLnByb3RvdHlwZS5tZWNoYW5pc21zW1N0cm9waGUuU0FTTEFub255bW91cy5wcm90b3R5cGUubmFtZV0gPSBTdHJvcGhlLlNBU0xBbm9ueW1vdXM7CgovKiogUHJpdmF0ZUNvbnN0cnVjdG9yOiBTQVNMUGxhaW4KICogIFNBU0wgUGxhaW4gYXV0aGVudGljYXRpb24uCiAqLwpTdHJvcGhlLlNBU0xQbGFpbiA9IGZ1bmN0aW9uKCkge307CgpTdHJvcGhlLlNBU0xQbGFpbi5wcm90b3R5cGUgPSBuZXcgU3Ryb3BoZS5TQVNMTWVjaGFuaXNtKCJQTEFJTiIsIHRydWUsIDIwKTsKClN0cm9waGUuU0FTTFBsYWluLnRlc3QgPSBmdW5jdGlvbihjb25uZWN0aW9uKSB7CiAgcmV0dXJuIGNvbm5lY3Rpb24uYXV0aGNpZCAhPT0gbnVsbDsKfTsKClN0cm9waGUuU0FTTFBsYWluLnByb3RvdHlwZS5vbkNoYWxsZW5nZSA9IGZ1bmN0aW9uKGNvbm5lY3Rpb24pIHsKICB2YXIgYXV0aF9zdHIgPSBjb25uZWN0aW9uLmF1dGh6aWQ7CiAgYXV0aF9zdHIgPSBhdXRoX3N0ciArICJcdTAwMDAiOwogIGF1dGhfc3RyID0gYXV0aF9zdHIgKyBjb25uZWN0aW9uLmF1dGhjaWQ7CiAgYXV0aF9zdHIgPSBhdXRoX3N0ciArICJcdTAwMDAiOwogIGF1dGhfc3RyID0gYXV0aF9zdHIgKyBjb25uZWN0aW9uLnBhc3M7CiAgcmV0dXJuIGF1dGhfc3RyOwp9OwoKU3Ryb3BoZS5Db25uZWN0aW9uLnByb3RvdHlwZS5tZWNoYW5pc21zW1N0cm9waGUuU0FTTFBsYWluLnByb3RvdHlwZS5uYW1lXSA9IFN0cm9waGUuU0FTTFBsYWluOwoKLyoqIFByaXZhdGVDb25zdHJ1Y3RvcjogU0FTTFNIQTEKICogIFNBU0wgU0NSQU0gU0hBIDEgYXV0aGVudGljYXRpb24uCiAqLwpTdHJvcGhlLlNBU0xTSEExID0gZnVuY3Rpb24oKSB7fTsKCi8qIFRFU1Q6CiAqIFRoaXMgaXMgYSBzaW1wbGUgZXhhbXBsZSBvZiBhIFNDUkFNLVNIQS0xIGF1dGhlbnRpY2F0aW9uIGV4Y2hhbmdlCiAqIHdoZW4gdGhlIGNsaWVudCBkb2Vzbid0IHN1cHBvcnQgY2hhbm5lbCBiaW5kaW5ncyAodXNlcm5hbWUgJ3VzZXInIGFuZAogKiBwYXNzd29yZCAncGVuY2lsJyBhcmUgdXNlZCk6CiAqCiAqIEM6IG4sLG49dXNlcixyPWZ5a28rZDJsYmJGZ09OUnY5cWt4ZGF3TAogKiBTOiByPWZ5a28rZDJsYmJGZ09OUnY5cWt4ZGF3TDNyZmNOSFlKWTFaVnZXVnM3aixzPVFTWENSK1E2c2VrOGJmOTIsCiAqIGk9NDA5NgogKiBDOiBjPWJpd3Mscj1meWtvK2QybGJiRmdPTlJ2OXFreGRhd0wzcmZjTkhZSlkxWlZ2V1ZzN2osCiAqIHA9djBYOHYzQnoyVDBDSkdiSlF5RjBYK0hJNFRzPQogKiBTOiB2PXJtRjlwcVY4UzdzdUFvWldqYTRkSlJrRnNLUT0KICoKICovCgpTdHJvcGhlLlNBU0xTSEExLnByb3RvdHlwZSA9IG5ldyBTdHJvcGhlLlNBU0xNZWNoYW5pc20oIlNDUkFNLVNIQS0xIiwgdHJ1ZSwgNDApOwoKU3Ryb3BoZS5TQVNMU0hBMS50ZXN0ID0gZnVuY3Rpb24oY29ubmVjdGlvbikgewogIHJldHVybiBjb25uZWN0aW9uLmF1dGhjaWQgIT09IG51bGw7Cn07CgpTdHJvcGhlLlNBU0xTSEExLnByb3RvdHlwZS5vbkNoYWxsZW5nZSA9IGZ1bmN0aW9uKGNvbm5lY3Rpb24sIGNoYWxsZW5nZSwgdGVzdF9jbm9uY2UpIHsKICB2YXIgY25vbmNlID0gdGVzdF9jbm9uY2UgfHwgTUQ1LmhleGRpZ2VzdChNYXRoLnJhbmRvbSgpICogMTIzNDU2Nzg5MCk7CgogIHZhciBhdXRoX3N0ciA9ICJuPSIgKyBjb25uZWN0aW9uLmF1dGhjaWQ7CiAgYXV0aF9zdHIgKz0gIixyPSI7CiAgYXV0aF9zdHIgKz0gY25vbmNlOwoKICBjb25uZWN0aW9uLl9zYXNsX2RhdGEuY25vbmNlID0gY25vbmNlOwogIGNvbm5lY3Rpb24uX3Nhc2xfZGF0YVsiY2xpZW50LWZpcnN0LW1lc3NhZ2UtYmFyZSJdID0gYXV0aF9zdHI7CgogIGF1dGhfc3RyID0gIm4sLCIgKyBhdXRoX3N0cjsKCiAgdGhpcy5vbkNoYWxsZW5nZSA9IGZ1bmN0aW9uIChjb25uZWN0aW9uLCBjaGFsbGVuZ2UpCiAgewogICAgdmFyIG5vbmNlLCBzYWx0LCBpdGVyLCBIaSwgVSwgVV9vbGQsIGksIGs7CiAgICB2YXIgY2xpZW50S2V5LCBzZXJ2ZXJLZXksIGNsaWVudFNpZ25hdHVyZTsKICAgIHZhciByZXNwb25zZVRleHQgPSAiYz1iaXdzLCI7CiAgICB2YXIgYXV0aE1lc3NhZ2UgPSBjb25uZWN0aW9uLl9zYXNsX2RhdGFbImNsaWVudC1maXJzdC1tZXNzYWdlLWJhcmUiXSArICIsIiArCiAgICAgIGNoYWxsZW5nZSArICIsIjsKICAgIHZhciBjbm9uY2UgPSBjb25uZWN0aW9uLl9zYXNsX2RhdGEuY25vbmNlOwogICAgdmFyIGF0dHJpYk1hdGNoID0gLyhbYS16XSspPShbXixdKykoLHwkKS87CgogICAgd2hpbGUgKGNoYWxsZW5nZS5tYXRjaChhdHRyaWJNYXRjaCkpIHsKICAgICAgdmFyIG1hdGNoZXMgPSBjaGFsbGVuZ2UubWF0Y2goYXR0cmliTWF0Y2gpOwogICAgICBjaGFsbGVuZ2UgPSBjaGFsbGVuZ2UucmVwbGFjZShtYXRjaGVzWzBdLCAiIik7CiAgICAgIHN3aXRjaCAobWF0Y2hlc1sxXSkgewogICAgICBjYXNlICJyIjoKICAgICAgICBub25jZSA9IG1hdGNoZXNbMl07CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgInMiOgogICAgICAgIHNhbHQgPSBtYXRjaGVzWzJdOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJpIjoKICAgICAgICBpdGVyID0gbWF0Y2hlc1syXTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQoKICAgIGlmIChub25jZS5zdWJzdHIoMCwgY25vbmNlLmxlbmd0aCkgIT09IGNub25jZSkgewogICAgICBjb25uZWN0aW9uLl9zYXNsX2RhdGEgPSB7fTsKICAgICAgcmV0dXJuIGNvbm5lY3Rpb24uX3Nhc2xfZmFpbHVyZV9jYigpOwogICAgfQoKICAgIHJlc3BvbnNlVGV4dCArPSAicj0iICsgbm9uY2U7CiAgICBhdXRoTWVzc2FnZSArPSByZXNwb25zZVRleHQ7CgogICAgc2FsdCA9IEJhc2U2NC5kZWNvZGUoc2FsdCk7CiAgICBzYWx0ICs9ICJceDAwXHgwMFx4MDBceDAxIjsKCiAgICBIaSA9IFVfb2xkID0gY29yZV9obWFjX3NoYTEoY29ubmVjdGlvbi5wYXNzLCBzYWx0KTsKICAgIGZvciAoaSA9IDE7IGkgPCBpdGVyOyBpKyspIHsKICAgICAgVSA9IGNvcmVfaG1hY19zaGExKGNvbm5lY3Rpb24ucGFzcywgYmluYjJzdHIoVV9vbGQpKTsKICAgICAgZm9yIChrID0gMDsgayA8IDU7IGsrKykgewogICAgICAgIEhpW2tdIF49IFVba107CiAgICAgIH0KICAgICAgVV9vbGQgPSBVOwogICAgfQogICAgSGkgPSBiaW5iMnN0cihIaSk7CgogICAgY2xpZW50S2V5ID0gY29yZV9obWFjX3NoYTEoSGksICJDbGllbnQgS2V5Iik7CiAgICBzZXJ2ZXJLZXkgPSBzdHJfaG1hY19zaGExKEhpLCAiU2VydmVyIEtleSIpOwogICAgY2xpZW50U2lnbmF0dXJlID0gY29yZV9obWFjX3NoYTEoc3RyX3NoYTEoYmluYjJzdHIoY2xpZW50S2V5KSksIGF1dGhNZXNzYWdlKTsKICAgIGNvbm5lY3Rpb24uX3Nhc2xfZGF0YVsic2VydmVyLXNpZ25hdHVyZSJdID0gYjY0X2htYWNfc2hhMShzZXJ2ZXJLZXksIGF1dGhNZXNzYWdlKTsKCiAgICBmb3IgKGsgPSAwOyBrIDwgNTsgaysrKSB7CiAgICAgIGNsaWVudEtleVtrXSBePSBjbGllbnRTaWduYXR1cmVba107CiAgICB9CgogICAgcmVzcG9uc2VUZXh0ICs9ICIscD0iICsgQmFzZTY0LmVuY29kZShiaW5iMnN0cihjbGllbnRLZXkpKTsKCiAgICByZXR1cm4gcmVzcG9uc2VUZXh0OwogIH0uYmluZCh0aGlzKTsKCiAgcmV0dXJuIGF1dGhfc3RyOwp9OwoKU3Ryb3BoZS5Db25uZWN0aW9uLnByb3RvdHlwZS5tZWNoYW5pc21zW1N0cm9waGUuU0FTTFNIQTEucHJvdG90eXBlLm5hbWVdID0gU3Ryb3BoZS5TQVNMU0hBMTsKCi8qKiBQcml2YXRlQ29uc3RydWN0b3I6IFNBU0xNRDUKICogIFNBU0wgRElHRVNUIE1ENSBhdXRoZW50aWNhdGlvbi4KICovClN0cm9waGUuU0FTTE1ENSA9IGZ1bmN0aW9uKCkge307CgpTdHJvcGhlLlNBU0xNRDUucHJvdG90eXBlID0gbmV3IFN0cm9waGUuU0FTTE1lY2hhbmlzbSgiRElHRVNULU1ENSIsIGZhbHNlLCAzMCk7CgpTdHJvcGhlLlNBU0xNRDUudGVzdCA9IGZ1bmN0aW9uKGNvbm5lY3Rpb24pIHsKICByZXR1cm4gY29ubmVjdGlvbi5hdXRoY2lkICE9PSBudWxsOwp9OwoKLyoqIFByaXZhdGVGdW5jdGlvbjogX3F1b3RlCiAqICBfUHJpdmF0ZV8gdXRpbGl0eSBmdW5jdGlvbiB0byBiYWNrc2xhc2ggZXNjYXBlIGFuZCBxdW90ZSBzdHJpbmdzLgogKgogKiAgUGFyYW1ldGVyczoKICogICAgKFN0cmluZykgc3RyIC0gVGhlIHN0cmluZyB0byBiZSBxdW90ZWQuCiAqCiAqICBSZXR1cm5zOgogKiAgICBxdW90ZWQgc3RyaW5nCiAqLwpTdHJvcGhlLlNBU0xNRDUucHJvdG90eXBlLl9xdW90ZSA9IGZ1bmN0aW9uIChzdHIpCiAgewogICAgcmV0dXJuICciJyArIHN0ci5yZXBsYWNlKC9cXC9nLCAiXFxcXCIpLnJlcGxhY2UoLyIvZywgJ1xcIicpICsgJyInOwogICAgLy8iIGVuZCBzdHJpbmcgd29ya2Fyb3VuZCBmb3IgZW1hY3MKICB9OwoKClN0cm9waGUuU0FTTE1ENS5wcm90b3R5cGUub25DaGFsbGVuZ2UgPSBmdW5jdGlvbihjb25uZWN0aW9uLCBjaGFsbGVuZ2UsIHRlc3RfY25vbmNlKSB7CiAgdmFyIGF0dHJpYk1hdGNoID0gLyhbYS16XSspPSgiW14iXSsifFteLCJdKykoPzosfCQpLzsKICB2YXIgY25vbmNlID0gdGVzdF9jbm9uY2UgfHwgTUQ1LmhleGRpZ2VzdCgiIiArIChNYXRoLnJhbmRvbSgpICogMTIzNDU2Nzg5MCkpOwogIHZhciByZWFsbSA9ICIiOwogIHZhciBob3N0ID0gbnVsbDsKICB2YXIgbm9uY2UgPSAiIjsKICB2YXIgcW9wID0gIiI7CiAgdmFyIG1hdGNoZXM7CgogIHdoaWxlIChjaGFsbGVuZ2UubWF0Y2goYXR0cmliTWF0Y2gpKSB7CiAgICBtYXRjaGVzID0gY2hhbGxlbmdlLm1hdGNoKGF0dHJpYk1hdGNoKTsKICAgIGNoYWxsZW5nZSA9IGNoYWxsZW5nZS5yZXBsYWNlKG1hdGNoZXNbMF0sICIiKTsKICAgIG1hdGNoZXNbMl0gPSBtYXRjaGVzWzJdLnJlcGxhY2UoL14iKC4rKSIkLywgIiQxIik7CiAgICBzd2l0Y2ggKG1hdGNoZXNbMV0pIHsKICAgIGNhc2UgInJlYWxtIjoKICAgICAgcmVhbG0gPSBtYXRjaGVzWzJdOwogICAgICBicmVhazsKICAgIGNhc2UgIm5vbmNlIjoKICAgICAgbm9uY2UgPSBtYXRjaGVzWzJdOwogICAgICBicmVhazsKICAgIGNhc2UgInFvcCI6CiAgICAgIHFvcCA9IG1hdGNoZXNbMl07CiAgICAgIGJyZWFrOwogICAgY2FzZSAiaG9zdCI6CiAgICAgIGhvc3QgPSBtYXRjaGVzWzJdOwogICAgICBicmVhazsKICAgIH0KICB9CgogIHZhciBkaWdlc3RfdXJpID0gY29ubmVjdGlvbi5zZXJ2dHlwZSArICIvIiArIGNvbm5lY3Rpb24uZG9tYWluOwogIGlmIChob3N0ICE9PSBudWxsKSB7CiAgICBkaWdlc3RfdXJpID0gZGlnZXN0X3VyaSArICIvIiArIGhvc3Q7CiAgfQoKICB2YXIgQTEgPSBNRDUuaGFzaChjb25uZWN0aW9uLmF1dGhjaWQgKwogICAgICAgICAgICAgICAgICAgICI6IiArIHJlYWxtICsgIjoiICsgdGhpcy5fY29ubmVjdGlvbi5wYXNzKSArCiAgICAiOiIgKyBub25jZSArICI6IiArIGNub25jZTsKICB2YXIgQTIgPSAnQVVUSEVOVElDQVRFOicgKyBkaWdlc3RfdXJpOwoKICB2YXIgcmVzcG9uc2VUZXh0ID0gIiI7CiAgcmVzcG9uc2VUZXh0ICs9ICdjaGFyc2V0PXV0Zi04LCc7CiAgcmVzcG9uc2VUZXh0ICs9ICd1c2VybmFtZT0nICsKICAgIHRoaXMuX3F1b3RlKGNvbm5lY3Rpb24uYXV0aGNpZCkgKyAnLCc7CiAgcmVzcG9uc2VUZXh0ICs9ICdyZWFsbT0nICsgdGhpcy5fcXVvdGUocmVhbG0pICsgJywnOwogIHJlc3BvbnNlVGV4dCArPSAnbm9uY2U9JyArIHRoaXMuX3F1b3RlKG5vbmNlKSArICcsJzsKICByZXNwb25zZVRleHQgKz0gJ25jPTAwMDAwMDAxLCc7CiAgcmVzcG9uc2VUZXh0ICs9ICdjbm9uY2U9JyArIHRoaXMuX3F1b3RlKGNub25jZSkgKyAnLCc7CiAgcmVzcG9uc2VUZXh0ICs9ICdkaWdlc3QtdXJpPScgKyB0aGlzLl9xdW90ZShkaWdlc3RfdXJpKSArICcsJzsKICByZXNwb25zZVRleHQgKz0gJ3Jlc3BvbnNlPScgKyBNRDUuaGV4ZGlnZXN0KE1ENS5oZXhkaWdlc3QoQTEpICsgIjoiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vbmNlICsgIjowMDAwMDAwMToiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNub25jZSArICI6YXV0aDoiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1ENS5oZXhkaWdlc3QoQTIpKSArICIsIjsKICByZXNwb25zZVRleHQgKz0gJ3FvcD1hdXRoJzsKCiAgdGhpcy5vbkNoYWxsZW5nZSA9IGZ1bmN0aW9uICgpCiAgewogICAgcmV0dXJuICIiOwogIH0uYmluZCh0aGlzKTsKCiAgcmV0dXJuIHJlc3BvbnNlVGV4dDsKfTsKClN0cm9waGUuQ29ubmVjdGlvbi5wcm90b3R5cGUubWVjaGFuaXNtc1tTdHJvcGhlLlNBU0xNRDUucHJvdG90eXBlLm5hbWVdID0gU3Ryb3BoZS5TQVNMTUQ1OwoKfSkoZnVuY3Rpb24gKCkgewogICAgd2luZG93LlN0cm9waGUgPSBhcmd1bWVudHNbMF07CiAgICB3aW5kb3cuJGJ1aWxkID0gYXJndW1lbnRzWzFdOwogICAgd2luZG93LiRtc2cgPSBhcmd1bWVudHNbMl07CiAgICB3aW5kb3cuJGlxID0gYXJndW1lbnRzWzNdOwogICAgd2luZG93LiRwcmVzID0gYXJndW1lbnRzWzRdOwp9KTsKCi8qCiAgICBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBNSVQgbGljZW5zZS4KICAgIFBsZWFzZSBzZWUgdGhlIExJQ0VOU0UgZmlsZSBmb3IgZGV0YWlscy4KCiAgICBDb3B5cmlnaHQgMjAwNi0yMDA4LCBPR0csIExMQwoqLwoKLyoganNoaW50IHVuZGVmOiB0cnVlLCB1bnVzZWQ6IHRydWU6LCBub2FyZzogdHJ1ZSwgbGF0ZWRlZjogdHJ1ZSAqLwovKmdsb2JhbCB3aW5kb3csIHNldFRpbWVvdXQsIGNsZWFyVGltZW91dCwKICAgIFhNTEh0dHBSZXF1ZXN0LCBBY3RpdmVYT2JqZWN0LAogICAgU3Ryb3BoZSwgJGJ1aWxkICovCgoKLyoqIFByaXZhdGVDbGFzczogU3Ryb3BoZS5SZXF1ZXN0CiAqICBfUHJpdmF0ZV8gaGVscGVyIGNsYXNzIHRoYXQgcHJvdmlkZXMgYSBjcm9zcyBpbXBsZW1lbnRhdGlvbiBhYnN0cmFjdGlvbgogKiAgZm9yIGEgQk9TSCByZWxhdGVkIFhNTEh0dHBSZXF1ZXN0LgogKgogKiAgVGhlIFN0cm9waGUuUmVxdWVzdCBjbGFzcyBpcyB1c2VkIGludGVybmFsbHkgdG8gZW5jYXBzdWxhdGUgQk9TSCByZXF1ZXN0CiAqICBpbmZvcm1hdGlvbi4gIEl0IGlzIG5vdCBtZWFudCB0byBiZSB1c2VkIGZyb20gdXNlcidzIGNvZGUuCiAqLwoKLyoqIFByaXZhdGVDb25zdHJ1Y3RvcjogU3Ryb3BoZS5SZXF1ZXN0CiAqICBDcmVhdGUgYW5kIGluaXRpYWxpemUgYSBuZXcgU3Ryb3BoZS5SZXF1ZXN0IG9iamVjdC4KICoKICogIFBhcmFtZXRlcnM6CiAqICAgIChYTUxFbGVtZW50KSBlbGVtIC0gVGhlIFhNTCBkYXRhIHRvIGJlIHNlbnQgaW4gdGhlIHJlcXVlc3QuCiAqICAgIChGdW5jdGlvbikgZnVuYyAtIFRoZSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIHdoZW4gdGhlCiAqICAgICAgWE1MSHR0cFJlcXVlc3QgcmVhZHlTdGF0ZSBjaGFuZ2VzLgogKiAgICAoSW50ZWdlcikgcmlkIC0gVGhlIEJPU0ggcmlkIGF0dHJpYnV0ZSBhc3NvY2lhdGVkIHdpdGggdGhpcyByZXF1ZXN0LgogKiAgICAoSW50ZWdlcikgc2VuZHMgLSBUaGUgbnVtYmVyIG9mIHRpbWVzIHRoaXMgc2FtZSByZXF1ZXN0IGhhcyBiZWVuCiAqICAgICAgc2VudC4KICovClN0cm9waGUuUmVxdWVzdCA9IGZ1bmN0aW9uIChlbGVtLCBmdW5jLCByaWQsIHNlbmRzKQp7CiAgICB0aGlzLmlkID0gKytTdHJvcGhlLl9yZXF1ZXN0SWQ7CiAgICB0aGlzLnhtbERhdGEgPSBlbGVtOwogICAgdGhpcy5kYXRhID0gU3Ryb3BoZS5zZXJpYWxpemUoZWxlbSk7CiAgICAvLyBzYXZlIG9yaWdpbmFsIGZ1bmN0aW9uIGluIGNhc2Ugd2UgbmVlZCB0byBtYWtlIGEgbmV3IHJlcXVlc3QKICAgIC8vIGZyb20gdGhpcyBvbmUuCiAgICB0aGlzLm9yaWdGdW5jID0gZnVuYzsKICAgIHRoaXMuZnVuYyA9IGZ1bmM7CiAgICB0aGlzLnJpZCA9IHJpZDsKICAgIHRoaXMuZGF0ZSA9IE5hTjsKICAgIHRoaXMuc2VuZHMgPSBzZW5kcyB8fCAwOwogICAgdGhpcy5hYm9ydCA9IGZhbHNlOwogICAgdGhpcy5kZWFkID0gbnVsbDsKCiAgICB0aGlzLmFnZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoIXRoaXMuZGF0ZSkgeyByZXR1cm4gMDsgfQogICAgICAgIHZhciBub3cgPSBuZXcgRGF0ZSgpOwogICAgICAgIHJldHVybiAobm93IC0gdGhpcy5kYXRlKSAvIDEwMDA7CiAgICB9OwogICAgdGhpcy50aW1lRGVhZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoIXRoaXMuZGVhZCkgeyByZXR1cm4gMDsgfQogICAgICAgIHZhciBub3cgPSBuZXcgRGF0ZSgpOwogICAgICAgIHJldHVybiAobm93IC0gdGhpcy5kZWFkKSAvIDEwMDA7CiAgICB9OwogICAgdGhpcy54aHIgPSB0aGlzLl9uZXdYSFIoKTsKfTsKClN0cm9waGUuUmVxdWVzdC5wcm90b3R5cGUgPSB7CiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBnZXRSZXNwb25zZQogICAgICogIEdldCBhIHJlc3BvbnNlIGZyb20gdGhlIHVuZGVybHlpbmcgWE1MSHR0cFJlcXVlc3QuCiAgICAgKgogICAgICogIFRoaXMgZnVuY3Rpb24gYXR0ZW1wdHMgdG8gZ2V0IGEgcmVzcG9uc2UgZnJvbSB0aGUgcmVxdWVzdCBhbmQgY2hlY2tzCiAgICAgKiAgZm9yIGVycm9ycy4KICAgICAqCiAgICAgKiAgVGhyb3dzOgogICAgICogICAgInBhcnNlcmVycm9yIiAtIEEgcGFyc2VyIGVycm9yIG9jY3VyZWQuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBUaGUgRE9NIGVsZW1lbnQgdHJlZSBvZiB0aGUgcmVzcG9uc2UuCiAgICAgKi8KICAgIGdldFJlc3BvbnNlOiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIHZhciBub2RlID0gbnVsbDsKICAgICAgICBpZiAodGhpcy54aHIucmVzcG9uc2VYTUwgJiYgdGhpcy54aHIucmVzcG9uc2VYTUwuZG9jdW1lbnRFbGVtZW50KSB7CiAgICAgICAgICAgIG5vZGUgPSB0aGlzLnhoci5yZXNwb25zZVhNTC5kb2N1bWVudEVsZW1lbnQ7CiAgICAgICAgICAgIGlmIChub2RlLnRhZ05hbWUgPT0gInBhcnNlcmVycm9yIikgewogICAgICAgICAgICAgICAgU3Ryb3BoZS5lcnJvcigiaW52YWxpZCByZXNwb25zZSByZWNlaXZlZCIpOwogICAgICAgICAgICAgICAgU3Ryb3BoZS5lcnJvcigicmVzcG9uc2VUZXh0OiAiICsgdGhpcy54aHIucmVzcG9uc2VUZXh0KTsKICAgICAgICAgICAgICAgIFN0cm9waGUuZXJyb3IoInJlc3BvbnNlWE1MOiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU3Ryb3BoZS5zZXJpYWxpemUodGhpcy54aHIucmVzcG9uc2VYTUwpKTsKICAgICAgICAgICAgICAgIHRocm93ICJwYXJzZXJlcnJvciI7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHRoaXMueGhyLnJlc3BvbnNlVGV4dCkgewogICAgICAgICAgICBTdHJvcGhlLmVycm9yKCJpbnZhbGlkIHJlc3BvbnNlIHJlY2VpdmVkIik7CiAgICAgICAgICAgIFN0cm9waGUuZXJyb3IoInJlc3BvbnNlVGV4dDogIiArIHRoaXMueGhyLnJlc3BvbnNlVGV4dCk7CiAgICAgICAgICAgIFN0cm9waGUuZXJyb3IoInJlc3BvbnNlWE1MOiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICBTdHJvcGhlLnNlcmlhbGl6ZSh0aGlzLnhoci5yZXNwb25zZVhNTCkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG5vZGU7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9uZXdYSFIKICAgICAqICBfUHJpdmF0ZV8gaGVscGVyIGZ1bmN0aW9uIHRvIGNyZWF0ZSBYTUxIdHRwUmVxdWVzdHMuCiAgICAgKgogICAgICogIFRoaXMgZnVuY3Rpb24gY3JlYXRlcyBYTUxIdHRwUmVxdWVzdHMgYWNyb3NzIGFsbCBpbXBsZW1lbnRhdGlvbnMuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBBIG5ldyBYTUxIdHRwUmVxdWVzdC4KICAgICAqLwogICAgX25ld1hIUjogZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICB2YXIgeGhyID0gbnVsbDsKICAgICAgICBpZiAod2luZG93LlhNTEh0dHBSZXF1ZXN0KSB7CiAgICAgICAgICAgIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgICAgICAgICBpZiAoeGhyLm92ZXJyaWRlTWltZVR5cGUpIHsKICAgICAgICAgICAgICAgIHhoci5vdmVycmlkZU1pbWVUeXBlKCJ0ZXh0L3htbCIpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICh3aW5kb3cuQWN0aXZlWE9iamVjdCkgewogICAgICAgICAgICB4aHIgPSBuZXcgQWN0aXZlWE9iamVjdCgiTWljcm9zb2Z0LlhNTEhUVFAiKTsKICAgICAgICB9CgogICAgICAgIC8vIHVzZSBGdW5jdGlvbi5iaW5kKCkgdG8gcHJlcGVuZCBvdXJzZWx2ZXMgYXMgYW4gYXJndW1lbnQKICAgICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gdGhpcy5mdW5jLmJpbmQobnVsbCwgdGhpcyk7CgogICAgICAgIHJldHVybiB4aHI7CiAgICB9Cn07CgovKiogQ2xhc3M6IFN0cm9waGUuQm9zaAogKiAgX1ByaXZhdGVfIGhlbHBlciBjbGFzcyB0aGF0IGhhbmRsZXMgQk9TSCBDb25uZWN0aW9ucwogKgogKiAgVGhlIFN0cm9waGUuQm9zaCBjbGFzcyBpcyB1c2VkIGludGVybmFsbHkgYnkgU3Ryb3BoZS5Db25uZWN0aW9uCiAqICB0byBlbmNhcHN1bGF0ZSBCT1NIIHNlc3Npb25zLiBJdCBpcyBub3QgbWVhbnQgdG8gYmUgdXNlZCBmcm9tIHVzZXIncyBjb2RlLgogKi8KCi8qKiBGaWxlOiBib3NoLmpzCiAqICBBIEphdmFTY3JpcHQgbGlicmFyeSB0byBlbmFibGUgQk9TSCBpbiBTdHJvcGhlanMuCiAqCiAqICB0aGlzIGxpYnJhcnkgdXNlcyBCaWRpcmVjdGlvbmFsLXN0cmVhbXMgT3ZlciBTeW5jaHJvbm91cyBIVFRQIChCT1NIKQogKiAgdG8gZW11bGF0ZSBhIHBlcnNpc3RlbnQsIHN0YXRlZnVsLCB0d28td2F5IGNvbm5lY3Rpb24gdG8gYW4gWE1QUCBzZXJ2ZXIuCiAqICBNb3JlIGluZm9ybWF0aW9uIG9uIEJPU0ggY2FuIGJlIGZvdW5kIGluIFhFUCAxMjQuCiAqLwoKLyoqIFByaXZhdGVDb25zdHJ1Y3RvcjogU3Ryb3BoZS5Cb3NoCiAqICBDcmVhdGUgYW5kIGluaXRpYWxpemUgYSBTdHJvcGhlLkJvc2ggb2JqZWN0LgogKgogKiAgUGFyYW1ldGVyczoKICogICAgKFN0cm9waGUuQ29ubmVjdGlvbikgY29ubmVjdGlvbiAtIFRoZSBTdHJvcGhlLkNvbm5lY3Rpb24gdGhhdCB3aWxsIHVzZSBCT1NILgogKgogKiAgUmV0dXJuczoKICogICAgQSBuZXcgU3Ryb3BoZS5Cb3NoIG9iamVjdC4KICovClN0cm9waGUuQm9zaCA9IGZ1bmN0aW9uKGNvbm5lY3Rpb24pIHsKICAgIHRoaXMuX2Nvbm4gPSBjb25uZWN0aW9uOwogICAgLyogcmVxdWVzdCBpZCBmb3IgYm9keSB0YWdzICovCiAgICB0aGlzLnJpZCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDQyOTQ5NjcyOTUpOwogICAgLyogVGhlIGN1cnJlbnQgc2Vzc2lvbiBJRC4gKi8KICAgIHRoaXMuc2lkID0gbnVsbDsKCiAgICAvLyBkZWZhdWx0IEJPU0ggdmFsdWVzCiAgICB0aGlzLmhvbGQgPSAxOwogICAgdGhpcy53YWl0ID0gNjA7CiAgICB0aGlzLndpbmRvdyA9IDU7CgogICAgdGhpcy5fcmVxdWVzdHMgPSBbXTsKfTsKClN0cm9waGUuQm9zaC5wcm90b3R5cGUgPSB7CiAgICAvKiogVmFyaWFibGU6IHN0cmlwCiAgICAgKgogICAgICogIEJPU0gtQ29ubmVjdGlvbnMgd2lsbCBoYXZlIGFsbCBzdGFuemFzIHdyYXBwZWQgaW4gYSA8Ym9keT4gdGFnIHdoZW4KICAgICAqICBwYXNzZWQgdG8gPFN0cm9waGUuQ29ubmVjdGlvbi54bWxJbnB1dD4gb3IgPFN0cm9waGUuQ29ubmVjdGlvbi54bWxPdXRwdXQ+LgogICAgICogIFRvIHN0cmlwIHRoaXMgdGFnLCBVc2VyIGNvZGUgY2FuIHNldCA8U3Ryb3BoZS5Cb3NoLnN0cmlwPiB0byAiYm9keSI6CiAgICAgKgogICAgICogID4gU3Ryb3BoZS5Cb3NoLnByb3RvdHlwZS5zdHJpcCA9ICJib2R5IjsKICAgICAqCiAgICAgKiAgVGhpcyB3aWxsIGVuYWJsZSBzdHJpcHBpbmcgb2YgdGhlIGJvZHkgdGFnIGluIGJvdGgKICAgICAqICA8U3Ryb3BoZS5Db25uZWN0aW9uLnhtbElucHV0PiBhbmQgPFN0cm9waGUuQ29ubmVjdGlvbi54bWxPdXRwdXQ+LgogICAgICovCiAgICBzdHJpcDogbnVsbCwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfYnVpbGRCb2R5CiAgICAgKiAgX1ByaXZhdGVfIGhlbHBlciBmdW5jdGlvbiB0byBnZW5lcmF0ZSB0aGUgPGJvZHkvPiB3cmFwcGVyIGZvciBCT1NILgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgQSBTdHJvcGhlLkJ1aWxkZXIgd2l0aCBhIDxib2R5Lz4gZWxlbWVudC4KICAgICAqLwogICAgX2J1aWxkQm9keTogZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICB2YXIgYm9keVdyYXAgPSAkYnVpbGQoJ2JvZHknLCB7CiAgICAgICAgICAgIHJpZDogdGhpcy5yaWQrKywKICAgICAgICAgICAgeG1sbnM6IFN0cm9waGUuTlMuSFRUUEJJTkQKICAgICAgICB9KTsKCiAgICAgICAgaWYgKHRoaXMuc2lkICE9PSBudWxsKSB7CiAgICAgICAgICAgIGJvZHlXcmFwLmF0dHJzKHtzaWQ6IHRoaXMuc2lkfSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gYm9keVdyYXA7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9yZXNldAogICAgICogIFJlc2V0IHRoZSBjb25uZWN0aW9uLgogICAgICoKICAgICAqICBUaGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCBieSB0aGUgcmVzZXQgZnVuY3Rpb24gb2YgdGhlIFN0cm9waGUgQ29ubmVjdGlvbgogICAgICovCiAgICBfcmVzZXQ6IGZ1bmN0aW9uICgpCiAgICB7CiAgICAgICAgdGhpcy5yaWQgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA0Mjk0OTY3Mjk1KTsKICAgICAgICB0aGlzLnNpZCA9IG51bGw7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9jb25uZWN0CiAgICAgKiAgX1ByaXZhdGVfIGZ1bmN0aW9uIHRoYXQgaW5pdGlhbGl6ZXMgdGhlIEJPU0ggY29ubmVjdGlvbi4KICAgICAqCiAgICAgKiAgQ3JlYXRlcyBhbmQgc2VuZHMgdGhlIFJlcXVlc3QgdGhhdCBpbml0aWFsaXplcyB0aGUgQk9TSCBjb25uZWN0aW9uLgogICAgICovCiAgICBfY29ubmVjdDogZnVuY3Rpb24gKHdhaXQsIGhvbGQsIHJvdXRlKQogICAgewogICAgICAgIHRoaXMud2FpdCA9IHdhaXQgfHwgdGhpcy53YWl0OwogICAgICAgIHRoaXMuaG9sZCA9IGhvbGQgfHwgdGhpcy5ob2xkOwoKICAgICAgICAvLyBidWlsZCB0aGUgYm9keSB0YWcKICAgICAgICB2YXIgYm9keSA9IHRoaXMuX2J1aWxkQm9keSgpLmF0dHJzKHsKICAgICAgICAgICAgdG86IHRoaXMuX2Nvbm4uZG9tYWluLAogICAgICAgICAgICAieG1sOmxhbmciOiAiZW4iLAogICAgICAgICAgICB3YWl0OiB0aGlzLndhaXQsCiAgICAgICAgICAgIGhvbGQ6IHRoaXMuaG9sZCwKICAgICAgICAgICAgY29udGVudDogInRleHQveG1sOyBjaGFyc2V0PXV0Zi04IiwKICAgICAgICAgICAgdmVyOiAiMS42IiwKICAgICAgICAgICAgInhtcHA6dmVyc2lvbiI6ICIxLjAiLAogICAgICAgICAgICAieG1sbnM6eG1wcCI6IFN0cm9waGUuTlMuQk9TSAogICAgICAgIH0pOwoKICAgICAgICBpZihyb3V0ZSl7CiAgICAgICAgICAgIGJvZHkuYXR0cnMoewogICAgICAgICAgICAgICAgcm91dGU6IHJvdXRlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgdmFyIF9jb25uZWN0X2NiID0gdGhpcy5fY29ubi5fY29ubmVjdF9jYjsKCiAgICAgICAgdGhpcy5fcmVxdWVzdHMucHVzaCgKICAgICAgICAgICAgbmV3IFN0cm9waGUuUmVxdWVzdChib2R5LnRyZWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9vblJlcXVlc3RTdGF0ZUNoYW5nZS5iaW5kKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLCBfY29ubmVjdF9jYi5iaW5kKHRoaXMuX2Nvbm4pKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2R5LnRyZWUoKS5nZXRBdHRyaWJ1dGUoInJpZCIpKSk7CiAgICAgICAgdGhpcy5fdGhyb3R0bGVkUmVxdWVzdEhhbmRsZXIoKTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX2F0dGFjaAogICAgICogIEF0dGFjaCB0byBhbiBhbHJlYWR5IGNyZWF0ZWQgYW5kIGF1dGhlbnRpY2F0ZWQgQk9TSCBzZXNzaW9uLgogICAgICoKICAgICAqICBUaGlzIGZ1bmN0aW9uIGlzIHByb3ZpZGVkIHRvIGFsbG93IFN0cm9waGUgdG8gYXR0YWNoIHRvIEJPU0gKICAgICAqICBzZXNzaW9ucyB3aGljaCBoYXZlIGJlZW4gY3JlYXRlZCBleHRlcm5hbGx5LCBwZXJoYXBzIGJ5IGEgV2ViCiAgICAgKiAgYXBwbGljYXRpb24uICBUaGlzIGlzIG9mdGVuIHVzZWQgdG8gc3VwcG9ydCBhdXRvLWxvZ2luIHR5cGUgZmVhdHVyZXMKICAgICAqICB3aXRob3V0IHB1dHRpbmcgdXNlciBjcmVkZW50aWFscyBpbnRvIHRoZSBwYWdlLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cmluZykgamlkIC0gVGhlIGZ1bGwgSklEIHRoYXQgaXMgYm91bmQgYnkgdGhlIHNlc3Npb24uCiAgICAgKiAgICAoU3RyaW5nKSBzaWQgLSBUaGUgU0lEIG9mIHRoZSBCT1NIIHNlc3Npb24uCiAgICAgKiAgICAoU3RyaW5nKSByaWQgLSBUaGUgY3VycmVudCBSSUQgb2YgdGhlIEJPU0ggc2Vzc2lvbi4gIFRoaXMgUklECiAgICAgKiAgICAgIHdpbGwgYmUgdXNlZCBieSB0aGUgbmV4dCByZXF1ZXN0LgogICAgICogICAgKEZ1bmN0aW9uKSBjYWxsYmFjayBUaGUgY29ubmVjdCBjYWxsYmFjayBmdW5jdGlvbi4KICAgICAqICAgIChJbnRlZ2VyKSB3YWl0IC0gVGhlIG9wdGlvbmFsIEhUVFBCSU5EIHdhaXQgdmFsdWUuICBUaGlzIGlzIHRoZQogICAgICogICAgICB0aW1lIHRoZSBzZXJ2ZXIgd2lsbCB3YWl0IGJlZm9yZSByZXR1cm5pbmcgYW4gZW1wdHkgcmVzdWx0IGZvcgogICAgICogICAgICBhIHJlcXVlc3QuICBUaGUgZGVmYXVsdCBzZXR0aW5nIG9mIDYwIHNlY29uZHMgaXMgcmVjb21tZW5kZWQuCiAgICAgKiAgICAgIE90aGVyIHNldHRpbmdzIHdpbGwgcmVxdWlyZSB0d2Vha3MgdG8gdGhlIFN0cm9waGUuVElNRU9VVCB2YWx1ZS4KICAgICAqICAgIChJbnRlZ2VyKSBob2xkIC0gVGhlIG9wdGlvbmFsIEhUVFBCSU5EIGhvbGQgdmFsdWUuICBUaGlzIGlzIHRoZQogICAgICogICAgICBudW1iZXIgb2YgY29ubmVjdGlvbnMgdGhlIHNlcnZlciB3aWxsIGhvbGQgYXQgb25lIHRpbWUuICBUaGlzCiAgICAgKiAgICAgIHNob3VsZCBhbG1vc3QgYWx3YXlzIGJlIHNldCB0byAxICh0aGUgZGVmYXVsdCkuCiAgICAgKiAgICAoSW50ZWdlcikgd2luZCAtIFRoZSBvcHRpb25hbCBIVFRCSU5EIHdpbmRvdyB2YWx1ZS4gIFRoaXMgaXMgdGhlCiAgICAgKiAgICAgIGFsbG93ZWQgcmFuZ2Ugb2YgcmVxdWVzdCBpZHMgdGhhdCBhcmUgdmFsaWQuICBUaGUgZGVmYXVsdCBpcyA1LgogICAgICovCiAgICBfYXR0YWNoOiBmdW5jdGlvbiAoamlkLCBzaWQsIHJpZCwgY2FsbGJhY2ssIHdhaXQsIGhvbGQsIHdpbmQpCiAgICB7CiAgICAgICAgdGhpcy5fY29ubi5qaWQgPSBqaWQ7CiAgICAgICAgdGhpcy5zaWQgPSBzaWQ7CiAgICAgICAgdGhpcy5yaWQgPSByaWQ7CgogICAgICAgIHRoaXMuX2Nvbm4uY29ubmVjdF9jYWxsYmFjayA9IGNhbGxiYWNrOwoKICAgICAgICB0aGlzLl9jb25uLmRvbWFpbiA9IFN0cm9waGUuZ2V0RG9tYWluRnJvbUppZCh0aGlzLl9jb25uLmppZCk7CgogICAgICAgIHRoaXMuX2Nvbm4uYXV0aGVudGljYXRlZCA9IHRydWU7CiAgICAgICAgdGhpcy5fY29ubi5jb25uZWN0ZWQgPSB0cnVlOwoKICAgICAgICB0aGlzLndhaXQgPSB3YWl0IHx8IHRoaXMud2FpdDsKICAgICAgICB0aGlzLmhvbGQgPSBob2xkIHx8IHRoaXMuaG9sZDsKICAgICAgICB0aGlzLndpbmRvdyA9IHdpbmQgfHwgdGhpcy53aW5kb3c7CgogICAgICAgIHRoaXMuX2Nvbm4uX2NoYW5nZUNvbm5lY3RTdGF0dXMoU3Ryb3BoZS5TdGF0dXMuQVRUQUNIRUQsIG51bGwpOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfY29ubmVjdF9jYgogICAgICogIF9Qcml2YXRlXyBoYW5kbGVyIGZvciBpbml0aWFsIGNvbm5lY3Rpb24gcmVxdWVzdC4KICAgICAqCiAgICAgKiAgVGhpcyBoYW5kbGVyIGlzIHVzZWQgdG8gcHJvY2VzcyB0aGUgQm9zaC1wYXJ0IG9mIHRoZSBpbml0aWFsIHJlcXVlc3QuCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChTdHJvcGhlLlJlcXVlc3QpIGJvZHlXcmFwIC0gVGhlIHJlY2VpdmVkIHN0YW56YS4KICAgICAqLwogICAgX2Nvbm5lY3RfY2I6IGZ1bmN0aW9uIChib2R5V3JhcCkKICAgIHsKICAgICAgICB2YXIgdHlwID0gYm9keVdyYXAuZ2V0QXR0cmlidXRlKCJ0eXBlIik7CiAgICAgICAgdmFyIGNvbmQsIGNvbmZsaWN0OwogICAgICAgIGlmICh0eXAgIT09IG51bGwgJiYgdHlwID09ICJ0ZXJtaW5hdGUiKSB7CiAgICAgICAgICAgIC8vIGFuIGVycm9yIG9jY3VycmVkCiAgICAgICAgICAgIFN0cm9waGUuZXJyb3IoIkJPU0gtQ29ubmVjdGlvbiBmYWlsZWQ6ICIgKyBjb25kKTsKICAgICAgICAgICAgY29uZCA9IGJvZHlXcmFwLmdldEF0dHJpYnV0ZSgiY29uZGl0aW9uIik7CiAgICAgICAgICAgIGNvbmZsaWN0ID0gYm9keVdyYXAuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImNvbmZsaWN0Iik7CiAgICAgICAgICAgIGlmIChjb25kICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoY29uZCA9PSAicmVtb3RlLXN0cmVhbS1lcnJvciIgJiYgY29uZmxpY3QubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbmQgPSAiY29uZmxpY3QiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5fY29ubi5fY2hhbmdlQ29ubmVjdFN0YXR1cyhTdHJvcGhlLlN0YXR1cy5DT05ORkFJTCwgY29uZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jb25uLl9jaGFuZ2VDb25uZWN0U3RhdHVzKFN0cm9waGUuU3RhdHVzLkNPTk5GQUlMLCAidW5rbm93biIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX2Nvbm4uX2RvRGlzY29ubmVjdCgpOwogICAgICAgICAgICByZXR1cm4gU3Ryb3BoZS5TdGF0dXMuQ09OTkZBSUw7CiAgICAgICAgfQoKICAgICAgICAvLyBjaGVjayB0byBtYWtlIHN1cmUgd2UgZG9uJ3Qgb3ZlcndyaXRlIHRoZXNlIGlmIF9jb25uZWN0X2NiIGlzCiAgICAgICAgLy8gY2FsbGVkIG11bHRpcGxlIHRpbWVzIGluIHRoZSBjYXNlIG9mIG1pc3Npbmcgc3RyZWFtOmZlYXR1cmVzCiAgICAgICAgaWYgKCF0aGlzLnNpZCkgewogICAgICAgICAgICB0aGlzLnNpZCA9IGJvZHlXcmFwLmdldEF0dHJpYnV0ZSgic2lkIik7CiAgICAgICAgfQogICAgICAgIHZhciB3aW5kID0gYm9keVdyYXAuZ2V0QXR0cmlidXRlKCdyZXF1ZXN0cycpOwogICAgICAgIGlmICh3aW5kKSB7IHRoaXMud2luZG93ID0gcGFyc2VJbnQod2luZCwgMTApOyB9CiAgICAgICAgdmFyIGhvbGQgPSBib2R5V3JhcC5nZXRBdHRyaWJ1dGUoJ2hvbGQnKTsKICAgICAgICBpZiAoaG9sZCkgeyB0aGlzLmhvbGQgPSBwYXJzZUludChob2xkLCAxMCk7IH0KICAgICAgICB2YXIgd2FpdCA9IGJvZHlXcmFwLmdldEF0dHJpYnV0ZSgnd2FpdCcpOwogICAgICAgIGlmICh3YWl0KSB7IHRoaXMud2FpdCA9IHBhcnNlSW50KHdhaXQsIDEwKTsgfQogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfZGlzY29ubmVjdAogICAgICogIF9Qcml2YXRlXyBwYXJ0IG9mIENvbm5lY3Rpb24uZGlzY29ubmVjdCBmb3IgQm9zaAogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFJlcXVlc3QpIHByZXMgLSBUaGlzIHN0YW56YSB3aWxsIGJlIHNlbnQgYmVmb3JlIGRpc2Nvbm5lY3RpbmcuCiAgICAgKi8KICAgIF9kaXNjb25uZWN0OiBmdW5jdGlvbiAocHJlcykKICAgIHsKICAgICAgICB0aGlzLl9zZW5kVGVybWluYXRlKHByZXMpOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfZG9EaXNjb25uZWN0CiAgICAgKiAgX1ByaXZhdGVfIGZ1bmN0aW9uIHRvIGRpc2Nvbm5lY3QuCiAgICAgKgogICAgICogIFJlc2V0cyB0aGUgU0lEIGFuZCBSSUQuCiAgICAgKi8KICAgIF9kb0Rpc2Nvbm5lY3Q6IGZ1bmN0aW9uICgpCiAgICB7CiAgICAgICAgdGhpcy5zaWQgPSBudWxsOwogICAgICAgIHRoaXMucmlkID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogNDI5NDk2NzI5NSk7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9lbXB0eVF1ZXVlCiAgICAgKiBfUHJpdmF0ZV8gZnVuY3Rpb24gdG8gY2hlY2sgaWYgdGhlIFJlcXVlc3QgcXVldWUgaXMgZW1wdHkuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBUcnVlLCBpZiB0aGVyZSBhcmUgbm8gUmVxdWVzdHMgcXVldWVkLCBGYWxzZSBvdGhlcndpc2UuCiAgICAgKi8KICAgIF9lbXB0eVF1ZXVlOiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIHJldHVybiB0aGlzLl9yZXF1ZXN0cy5sZW5ndGggPT09IDA7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9oaXRFcnJvcgogICAgICogIF9Qcml2YXRlXyBmdW5jdGlvbiB0byBoYW5kbGUgdGhlIGVycm9yIGNvdW50LgogICAgICoKICAgICAqICBSZXF1ZXN0cyBhcmUgcmVzZW50IGF1dG9tYXRpY2FsbHkgdW50aWwgdGhlaXIgZXJyb3IgY291bnQgcmVhY2hlcwogICAgICogIDUuICBFYWNoIHRpbWUgYW4gZXJyb3IgaXMgZW5jb3VudGVyZWQsIHRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIHRvCiAgICAgKiAgaW5jcmVtZW50IHRoZSBjb3VudCBhbmQgZGlzY29ubmVjdCBpZiB0aGUgY291bnQgaXMgdG9vIGhpZ2guCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoSW50ZWdlcikgcmVxU3RhdHVzIC0gVGhlIHJlcXVlc3Qgc3RhdHVzLgogICAgICovCiAgICBfaGl0RXJyb3I6IGZ1bmN0aW9uIChyZXFTdGF0dXMpCiAgICB7CiAgICAgICAgdGhpcy5lcnJvcnMrKzsKICAgICAgICBTdHJvcGhlLndhcm4oInJlcXVlc3QgZXJyb3JlZCwgc3RhdHVzOiAiICsgcmVxU3RhdHVzICsKICAgICAgICAgICAgICAgICAgICAgIiwgbnVtYmVyIG9mIGVycm9yczogIiArIHRoaXMuZXJyb3JzKTsKICAgICAgICBpZiAodGhpcy5lcnJvcnMgPiA0KSB7CiAgICAgICAgICAgIHRoaXMuX29uRGlzY29ubmVjdFRpbWVvdXQoKTsKICAgICAgICB9CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9ub19hdXRoX3JlY2VpdmVkCiAgICAgKgogICAgICogQ2FsbGVkIG9uIHN0cmVhbSBzdGFydC9yZXN0YXJ0IHdoZW4gbm8gc3RyZWFtOmZlYXR1cmVzCiAgICAgKiBoYXMgYmVlbiByZWNlaXZlZCBhbmQgc2VuZHMgYSBibGFuayBwb2xsIHJlcXVlc3QuCiAgICAgKi8KICAgIF9ub19hdXRoX3JlY2VpdmVkOiBmdW5jdGlvbiAoX2NhbGxiYWNrKQogICAgewogICAgICAgIGlmIChfY2FsbGJhY2spIHsKICAgICAgICAgICAgX2NhbGxiYWNrID0gX2NhbGxiYWNrLmJpbmQodGhpcy5fY29ubik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgX2NhbGxiYWNrID0gdGhpcy5fY29ubi5fY29ubmVjdF9jYi5iaW5kKHRoaXMuX2Nvbm4pOwogICAgICAgIH0KICAgICAgICB2YXIgYm9keSA9IHRoaXMuX2J1aWxkQm9keSgpOwogICAgICAgIHRoaXMuX3JlcXVlc3RzLnB1c2goCiAgICAgICAgICAgICAgICBuZXcgU3Ryb3BoZS5SZXF1ZXN0KGJvZHkudHJlZSgpLAogICAgICAgICAgICAgICAgICAgIHRoaXMuX29uUmVxdWVzdFN0YXRlQ2hhbmdlLmJpbmQoCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMsIF9jYWxsYmFjay5iaW5kKHRoaXMuX2Nvbm4pKSwKICAgICAgICAgICAgICAgICAgICBib2R5LnRyZWUoKS5nZXRBdHRyaWJ1dGUoInJpZCIpKSk7CiAgICAgICAgdGhpcy5fdGhyb3R0bGVkUmVxdWVzdEhhbmRsZXIoKTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX29uRGlzY29ubmVjdFRpbWVvdXQKICAgICAqICBfUHJpdmF0ZV8gdGltZW91dCBoYW5kbGVyIGZvciBoYW5kbGluZyBub24tZ3JhY2VmdWwgZGlzY29ubmVjdGlvbi4KICAgICAqCiAgICAgKiAgQ2FuY2VscyBhbGwgcmVtYWluaW5nIFJlcXVlc3RzIGFuZCBjbGVhcnMgdGhlIHF1ZXVlLgogICAgICovCiAgICBfb25EaXNjb25uZWN0VGltZW91dDogZnVuY3Rpb24gKCkKICAgIHsKICAgICAgICB2YXIgcmVxOwogICAgICAgIHdoaWxlICh0aGlzLl9yZXF1ZXN0cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHJlcSA9IHRoaXMuX3JlcXVlc3RzLnBvcCgpOwogICAgICAgICAgICByZXEuYWJvcnQgPSB0cnVlOwogICAgICAgICAgICByZXEueGhyLmFib3J0KCk7CiAgICAgICAgICAgIC8vIGpzbGludCBjb21wbGFpbnMsIGJ1dCB0aGlzIGlzIGZpbmUuIHNldHRpbmcgdG8gZW1wdHkgZnVuYwogICAgICAgICAgICAvLyBpcyBuZWNlc3NhcnkgZm9yIElFNgogICAgICAgICAgICByZXEueGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHt9OyAvLyBqc2hpbnQgaWdub3JlOmxpbmUKICAgICAgICB9CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9vbklkbGUKICAgICAqICBfUHJpdmF0ZV8gaGFuZGxlciBjYWxsZWQgYnkgU3Ryb3BoZS5Db25uZWN0aW9uLl9vbklkbGUKICAgICAqCiAgICAgKiAgU2VuZHMgYWxsIHF1ZXVlZCBSZXF1ZXN0cyBvciBwb2xscyB3aXRoIGVtcHR5IFJlcXVlc3QgaWYgdGhlcmUgYXJlIG5vbmUuCiAgICAgKi8KICAgIF9vbklkbGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZGF0YSA9IHRoaXMuX2Nvbm4uX2RhdGE7CgogICAgICAgIC8vIGlmIG5vIHJlcXVlc3RzIGFyZSBpbiBwcm9ncmVzcywgcG9sbAogICAgICAgIGlmICh0aGlzLl9jb25uLmF1dGhlbnRpY2F0ZWQgJiYgdGhpcy5fcmVxdWVzdHMubGVuZ3RoID09PSAwICYmCiAgICAgICAgICAgIGRhdGEubGVuZ3RoID09PSAwICYmICF0aGlzLl9jb25uLmRpc2Nvbm5lY3RpbmcpIHsKICAgICAgICAgICAgU3Ryb3BoZS5pbmZvKCJubyByZXF1ZXN0cyBkdXJpbmcgaWRsZSBjeWNsZSwgc2VuZGluZyAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICJibGFuayByZXF1ZXN0Iik7CiAgICAgICAgICAgIGRhdGEucHVzaChudWxsKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9yZXF1ZXN0cy5sZW5ndGggPCAyICYmIGRhdGEubGVuZ3RoID4gMCAmJgogICAgICAgICAgICAhdGhpcy5fY29ubi5wYXVzZWQpIHsKICAgICAgICAgICAgdmFyIGJvZHkgPSB0aGlzLl9idWlsZEJvZHkoKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoZGF0YVtpXSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGlmIChkYXRhW2ldID09PSAicmVzdGFydCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYm9keS5hdHRycyh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bzogdGhpcy5fY29ubi5kb21haW4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAieG1sOmxhbmciOiAiZW4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInhtcHA6cmVzdGFydCI6ICJ0cnVlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ4bWxuczp4bXBwIjogU3Ryb3BoZS5OUy5CT1NICiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJvZHkuY25vZGUoZGF0YVtpXSkudXAoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2Nvbm4uX2RhdGE7CiAgICAgICAgICAgIHRoaXMuX2Nvbm4uX2RhdGEgPSBbXTsKICAgICAgICAgICAgdGhpcy5fcmVxdWVzdHMucHVzaCgKICAgICAgICAgICAgICAgIG5ldyBTdHJvcGhlLlJlcXVlc3QoYm9keS50cmVlKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX29uUmVxdWVzdFN0YXRlQ2hhbmdlLmJpbmQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLCB0aGlzLl9jb25uLl9kYXRhUmVjdi5iaW5kKHRoaXMuX2Nvbm4pKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9keS50cmVlKCkuZ2V0QXR0cmlidXRlKCJyaWQiKSkpOwogICAgICAgICAgICB0aGlzLl9wcm9jZXNzUmVxdWVzdCh0aGlzLl9yZXF1ZXN0cy5sZW5ndGggLSAxKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9yZXF1ZXN0cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHZhciB0aW1lX2VsYXBzZWQgPSB0aGlzLl9yZXF1ZXN0c1swXS5hZ2UoKTsKICAgICAgICAgICAgaWYgKHRoaXMuX3JlcXVlc3RzWzBdLmRlYWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9yZXF1ZXN0c1swXS50aW1lRGVhZCgpID4KICAgICAgICAgICAgICAgICAgICBNYXRoLmZsb29yKFN0cm9waGUuU0VDT05EQVJZX1RJTUVPVVQgKiB0aGlzLndhaXQpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdGhyb3R0bGVkUmVxdWVzdEhhbmRsZXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRpbWVfZWxhcHNlZCA+IE1hdGguZmxvb3IoU3Ryb3BoZS5USU1FT1VUICogdGhpcy53YWl0KSkgewogICAgICAgICAgICAgICAgU3Ryb3BoZS53YXJuKCJSZXF1ZXN0ICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlcXVlc3RzWzBdLmlkICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIHRpbWVkIG91dCwgb3ZlciAiICsgTWF0aC5mbG9vcihTdHJvcGhlLlRJTUVPVVQgKiB0aGlzLndhaXQpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIHNlY29uZHMgc2luY2UgbGFzdCBhY3Rpdml0eSIpOwogICAgICAgICAgICAgICAgdGhpcy5fdGhyb3R0bGVkUmVxdWVzdEhhbmRsZXIoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX29uUmVxdWVzdFN0YXRlQ2hhbmdlCiAgICAgKiAgX1ByaXZhdGVfIGhhbmRsZXIgZm9yIFN0cm9waGUuUmVxdWVzdCBzdGF0ZSBjaGFuZ2VzLgogICAgICoKICAgICAqICBUaGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCB3aGVuIHRoZSBYTUxIdHRwUmVxdWVzdCByZWFkeVN0YXRlIGNoYW5nZXMuCiAgICAgKiAgSXQgY29udGFpbnMgYSBsb3Qgb2YgZXJyb3IgaGFuZGxpbmcgbG9naWMgZm9yIHRoZSBtYW55IHdheXMgdGhhdAogICAgICogIHJlcXVlc3RzIGNhbiBmYWlsLCBhbmQgY2FsbHMgdGhlIHJlcXVlc3QgY2FsbGJhY2sgd2hlbiByZXF1ZXN0cwogICAgICogIHN1Y2NlZWQuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoRnVuY3Rpb24pIGZ1bmMgLSBUaGUgaGFuZGxlciBmb3IgdGhlIHJlcXVlc3QuCiAgICAgKiAgICAoU3Ryb3BoZS5SZXF1ZXN0KSByZXEgLSBUaGUgcmVxdWVzdCB0aGF0IGlzIGNoYW5naW5nIHJlYWR5U3RhdGUuCiAgICAgKi8KICAgIF9vblJlcXVlc3RTdGF0ZUNoYW5nZTogZnVuY3Rpb24gKGZ1bmMsIHJlcSkKICAgIHsKICAgICAgICBTdHJvcGhlLmRlYnVnKCJyZXF1ZXN0IGlkICIgKyByZXEuaWQgKwogICAgICAgICAgICAgICAgICAgICAgIi4iICsgcmVxLnNlbmRzICsgIiBzdGF0ZSBjaGFuZ2VkIHRvICIgKwogICAgICAgICAgICAgICAgICAgICAgcmVxLnhoci5yZWFkeVN0YXRlKTsKCiAgICAgICAgaWYgKHJlcS5hYm9ydCkgewogICAgICAgICAgICByZXEuYWJvcnQgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gcmVxdWVzdCBjb21wbGV0ZQogICAgICAgIHZhciByZXFTdGF0dXM7CiAgICAgICAgaWYgKHJlcS54aHIucmVhZHlTdGF0ZSA9PSA0KSB7CiAgICAgICAgICAgIHJlcVN0YXR1cyA9IDA7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXFTdGF0dXMgPSByZXEueGhyLnN0YXR1czsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgLy8gaWdub3JlIGVycm9ycyBmcm9tIHVuZGVmaW5lZCBzdGF0dXMgYXR0cmlidXRlLiAgd29ya3MKICAgICAgICAgICAgICAgIC8vIGFyb3VuZCBhIGJyb3dzZXIgYnVnCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0eXBlb2YocmVxU3RhdHVzKSA9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgcmVxU3RhdHVzID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuZGlzY29ubmVjdGluZykgewogICAgICAgICAgICAgICAgaWYgKHJlcVN0YXR1cyA+PSA0MDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaXRFcnJvcihyZXFTdGF0dXMpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHJlcUlzMCA9ICh0aGlzLl9yZXF1ZXN0c1swXSA9PSByZXEpOwogICAgICAgICAgICB2YXIgcmVxSXMxID0gKHRoaXMuX3JlcXVlc3RzWzFdID09IHJlcSk7CgogICAgICAgICAgICBpZiAoKHJlcVN0YXR1cyA+IDAgJiYgcmVxU3RhdHVzIDwgNTAwKSB8fCByZXEuc2VuZHMgPiA1KSB7CiAgICAgICAgICAgICAgICAvLyByZW1vdmUgZnJvbSBpbnRlcm5hbCBxdWV1ZQogICAgICAgICAgICAgICAgdGhpcy5fcmVtb3ZlUmVxdWVzdChyZXEpOwogICAgICAgICAgICAgICAgU3Ryb3BoZS5kZWJ1ZygicmVxdWVzdCBpZCAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxLmlkICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiBzaG91bGQgbm93IGJlIHJlbW92ZWQiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gcmVxdWVzdCBzdWNjZWVkZWQKICAgICAgICAgICAgaWYgKHJlcVN0YXR1cyA9PSAyMDApIHsKICAgICAgICAgICAgICAgIC8vIGlmIHJlcXVlc3QgMSBmaW5pc2hlZCwgb3IgcmVxdWVzdCAwIGZpbmlzaGVkIGFuZCByZXF1ZXN0CiAgICAgICAgICAgICAgICAvLyAxIGlzIG92ZXIgU3Ryb3BoZS5TRUNPTkRBUllfVElNRU9VVCBzZWNvbmRzIG9sZCwgd2UgbmVlZCB0bwogICAgICAgICAgICAgICAgLy8gcmVzdGFydCB0aGUgb3RoZXIgLSBib3RoIHdpbGwgYmUgaW4gdGhlIGZpcnN0IHNwb3QsIGFzIHRoZQogICAgICAgICAgICAgICAgLy8gY29tcGxldGVkIHJlcXVlc3QgaGFzIGJlZW4gcmVtb3ZlZCBmcm9tIHRoZSBxdWV1ZSBhbHJlYWR5CiAgICAgICAgICAgICAgICBpZiAocmVxSXMxIHx8CiAgICAgICAgICAgICAgICAgICAgKHJlcUlzMCAmJiB0aGlzLl9yZXF1ZXN0cy5sZW5ndGggPiAwICYmCiAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlcXVlc3RzWzBdLmFnZSgpID4gTWF0aC5mbG9vcihTdHJvcGhlLlNFQ09OREFSWV9USU1FT1VUICogdGhpcy53YWl0KSkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXN0YXJ0UmVxdWVzdCgwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIGNhbGwgaGFuZGxlcgogICAgICAgICAgICAgICAgU3Ryb3BoZS5kZWJ1ZygicmVxdWVzdCBpZCAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxLmlkICsgIi4iICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxLnNlbmRzICsgIiBnb3QgMjAwIik7CiAgICAgICAgICAgICAgICBmdW5jKHJlcSk7CiAgICAgICAgICAgICAgICB0aGlzLmVycm9ycyA9IDA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBTdHJvcGhlLmVycm9yKCJyZXF1ZXN0IGlkICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXEuaWQgKyAiLiIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXEuc2VuZHMgKyAiIGVycm9yICIgKyByZXFTdGF0dXMgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIGhhcHBlbmVkIik7CiAgICAgICAgICAgICAgICBpZiAocmVxU3RhdHVzID09PSAwIHx8CiAgICAgICAgICAgICAgICAgICAgKHJlcVN0YXR1cyA+PSA0MDAgJiYgcmVxU3RhdHVzIDwgNjAwKSB8fAogICAgICAgICAgICAgICAgICAgIHJlcVN0YXR1cyA+PSAxMjAwMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpdEVycm9yKHJlcVN0YXR1cyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcVN0YXR1cyA+PSA0MDAgJiYgcmVxU3RhdHVzIDwgNTAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2Nvbm4uX2NoYW5nZUNvbm5lY3RTdGF0dXMoU3Ryb3BoZS5TdGF0dXMuRElTQ09OTkVDVElORywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBudWxsKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY29ubi5fZG9EaXNjb25uZWN0KCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoISgocmVxU3RhdHVzID4gMCAmJiByZXFTdGF0dXMgPCA1MDApIHx8CiAgICAgICAgICAgICAgICAgIHJlcS5zZW5kcyA+IDUpKSB7CiAgICAgICAgICAgICAgICB0aGlzLl90aHJvdHRsZWRSZXF1ZXN0SGFuZGxlcigpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfcHJvY2Vzc1JlcXVlc3QKICAgICAqICBfUHJpdmF0ZV8gZnVuY3Rpb24gdG8gcHJvY2VzcyBhIHJlcXVlc3QgaW4gdGhlIHF1ZXVlLgogICAgICoKICAgICAqICBUaGlzIGZ1bmN0aW9uIHRha2VzIHJlcXVlc3RzIG9mZiB0aGUgcXVldWUgYW5kIHNlbmRzIHRoZW0gYW5kCiAgICAgKiAgcmVzdGFydHMgZGVhZCByZXF1ZXN0cy4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChJbnRlZ2VyKSBpIC0gVGhlIGluZGV4IG9mIHRoZSByZXF1ZXN0IGluIHRoZSBxdWV1ZS4KICAgICAqLwogICAgX3Byb2Nlc3NSZXF1ZXN0OiBmdW5jdGlvbiAoaSkKICAgIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgdmFyIHJlcSA9IHRoaXMuX3JlcXVlc3RzW2ldOwogICAgICAgIHZhciByZXFTdGF0dXMgPSAtMTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKHJlcS54aHIucmVhZHlTdGF0ZSA9PSA0KSB7CiAgICAgICAgICAgICAgICByZXFTdGF0dXMgPSByZXEueGhyLnN0YXR1czsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgU3Ryb3BoZS5lcnJvcigiY2F1Z2h0IGFuIGVycm9yIGluIF9yZXF1ZXN0c1siICsgaSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgIl0sIHJlcVN0YXR1czogIiArIHJlcVN0YXR1cyk7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mKHJlcVN0YXR1cykgPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmVxU3RhdHVzID0gLTE7CiAgICAgICAgfQoKICAgICAgICAvLyBtYWtlIHN1cmUgd2UgbGltaXQgdGhlIG51bWJlciBvZiByZXRyaWVzCiAgICAgICAgaWYgKHJlcS5zZW5kcyA+IHRoaXMubWF4UmV0cmllcykgewogICAgICAgICAgICB0aGlzLl9vbkRpc2Nvbm5lY3RUaW1lb3V0KCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciB0aW1lX2VsYXBzZWQgPSByZXEuYWdlKCk7CiAgICAgICAgdmFyIHByaW1hcnlUaW1lb3V0ID0gKCFpc05hTih0aW1lX2VsYXBzZWQpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVfZWxhcHNlZCA+IE1hdGguZmxvb3IoU3Ryb3BoZS5USU1FT1VUICogdGhpcy53YWl0KSk7CiAgICAgICAgdmFyIHNlY29uZGFyeVRpbWVvdXQgPSAocmVxLmRlYWQgIT09IG51bGwgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXEudGltZURlYWQoKSA+IE1hdGguZmxvb3IoU3Ryb3BoZS5TRUNPTkRBUllfVElNRU9VVCAqIHRoaXMud2FpdCkpOwogICAgICAgIHZhciByZXF1ZXN0Q29tcGxldGVkV2l0aFNlcnZlckVycm9yID0gKHJlcS54aHIucmVhZHlTdGF0ZSA9PSA0ICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHJlcVN0YXR1cyA8IDEgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxU3RhdHVzID49IDUwMCkpOwogICAgICAgIGlmIChwcmltYXJ5VGltZW91dCB8fCBzZWNvbmRhcnlUaW1lb3V0IHx8CiAgICAgICAgICAgIHJlcXVlc3RDb21wbGV0ZWRXaXRoU2VydmVyRXJyb3IpIHsKICAgICAgICAgICAgaWYgKHNlY29uZGFyeVRpbWVvdXQpIHsKICAgICAgICAgICAgICAgIFN0cm9waGUuZXJyb3IoIlJlcXVlc3QgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlcXVlc3RzW2ldLmlkICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiB0aW1lZCBvdXQgKHNlY29uZGFyeSksIHJlc3RhcnRpbmciKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXEuYWJvcnQgPSB0cnVlOwogICAgICAgICAgICByZXEueGhyLmFib3J0KCk7CiAgICAgICAgICAgIC8vIHNldHRpbmcgdG8gbnVsbCBmYWlscyBvbiBJRTYsIHNvIHNldCB0byBlbXB0eSBmdW5jdGlvbgogICAgICAgICAgICByZXEueGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHt9OwogICAgICAgICAgICB0aGlzLl9yZXF1ZXN0c1tpXSA9IG5ldyBTdHJvcGhlLlJlcXVlc3QocmVxLnhtbERhdGEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXEub3JpZ0Z1bmMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXEucmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxLnNlbmRzKTsKICAgICAgICAgICAgcmVxID0gdGhpcy5fcmVxdWVzdHNbaV07CiAgICAgICAgfQoKICAgICAgICBpZiAocmVxLnhoci5yZWFkeVN0YXRlID09PSAwKSB7CiAgICAgICAgICAgIFN0cm9waGUuZGVidWcoInJlcXVlc3QgaWQgIiArIHJlcS5pZCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgIi4iICsgcmVxLnNlbmRzICsgIiBwb3N0aW5nIik7CgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmVxLnhoci5vcGVuKCJQT1NUIiwgdGhpcy5fY29ubi5zZXJ2aWNlLCB0aGlzLl9jb25uLm9wdGlvbnMuc3luYyA/IGZhbHNlIDogdHJ1ZSk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUyKSB7CiAgICAgICAgICAgICAgICBTdHJvcGhlLmVycm9yKCJYSFIgb3BlbiBmYWlsZWQuIik7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2Nvbm4uY29ubmVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY29ubi5fY2hhbmdlQ29ubmVjdFN0YXR1cyhTdHJvcGhlLlN0YXR1cy5DT05ORkFJTCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJiYWQtc2VydmljZSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5fY29ubi5kaXNjb25uZWN0KCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEZpcmVzIHRoZSBYSFIgcmVxdWVzdCAtLSBtYXkgYmUgaW52b2tlZCBpbW1lZGlhdGVseQogICAgICAgICAgICAvLyBvciBvbiBhIGdyYWR1YWxseSBleHBhbmRpbmcgcmV0cnkgd2luZG93IGZvciByZWNvbm5lY3RzCiAgICAgICAgICAgIHZhciBzZW5kRnVuYyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJlcS5kYXRlID0gbmV3IERhdGUoKTsKICAgICAgICAgICAgICAgIGlmIChzZWxmLl9jb25uLm9wdGlvbnMuY3VzdG9tSGVhZGVycyl7CiAgICAgICAgICAgICAgICAgICAgdmFyIGhlYWRlcnMgPSBzZWxmLl9jb25uLm9wdGlvbnMuY3VzdG9tSGVhZGVyczsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBoZWFkZXIgaW4gaGVhZGVycykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGVhZGVycy5oYXNPd25Qcm9wZXJ0eShoZWFkZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXEueGhyLnNldFJlcXVlc3RIZWFkZXIoaGVhZGVyLCBoZWFkZXJzW2hlYWRlcl0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmVxLnhoci5zZW5kKHJlcS5kYXRhKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIEltcGxlbWVudCBwcm9ncmVzc2l2ZSBiYWNrb2ZmIGZvciByZWNvbm5lY3RzIC0tCiAgICAgICAgICAgIC8vIEZpcnN0IHJldHJ5IChzZW5kID09IDEpIHNob3VsZCBhbHNvIGJlIGluc3RhbnRhbmVvdXMKICAgICAgICAgICAgaWYgKHJlcS5zZW5kcyA+IDEpIHsKICAgICAgICAgICAgICAgIC8vIFVzaW5nIGEgY3ViZSBvZiB0aGUgcmV0cnkgbnVtYmVyIGNyZWF0ZXMgYSBuaWNlbHkKICAgICAgICAgICAgICAgIC8vIGV4cGFuZGluZyByZXRyeSB3aW5kb3cKICAgICAgICAgICAgICAgIHZhciBiYWNrb2ZmID0gTWF0aC5taW4oTWF0aC5mbG9vcihTdHJvcGhlLlRJTUVPVVQgKiB0aGlzLndhaXQpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNYXRoLnBvdyhyZXEuc2VuZHMsIDMpKSAqIDEwMDA7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KHNlbmRGdW5jLCBiYWNrb2ZmKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNlbmRGdW5jKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJlcS5zZW5kcysrOwoKICAgICAgICAgICAgaWYgKHRoaXMuX2Nvbm4ueG1sT3V0cHV0ICE9PSBTdHJvcGhlLkNvbm5lY3Rpb24ucHJvdG90eXBlLnhtbE91dHB1dCkgewogICAgICAgICAgICAgICAgaWYgKHJlcS54bWxEYXRhLm5vZGVOYW1lID09PSB0aGlzLnN0cmlwICYmIHJlcS54bWxEYXRhLmNoaWxkTm9kZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY29ubi54bWxPdXRwdXQocmVxLnhtbERhdGEuY2hpbGROb2Rlc1swXSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2Nvbm4ueG1sT3V0cHV0KHJlcS54bWxEYXRhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5fY29ubi5yYXdPdXRwdXQgIT09IFN0cm9waGUuQ29ubmVjdGlvbi5wcm90b3R5cGUucmF3T3V0cHV0KSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jb25uLnJhd091dHB1dChyZXEuZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBTdHJvcGhlLmRlYnVnKCJfcHJvY2Vzc1JlcXVlc3Q6ICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgIChpID09PSAwID8gImZpcnN0IiA6ICJzZWNvbmQiKSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgIiByZXF1ZXN0IGhhcyByZWFkeVN0YXRlIG9mICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgIHJlcS54aHIucmVhZHlTdGF0ZSk7CiAgICAgICAgfQogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfcmVtb3ZlUmVxdWVzdAogICAgICogIF9Qcml2YXRlXyBmdW5jdGlvbiB0byByZW1vdmUgYSByZXF1ZXN0IGZyb20gdGhlIHF1ZXVlLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cm9waGUuUmVxdWVzdCkgcmVxIC0gVGhlIHJlcXVlc3QgdG8gcmVtb3ZlLgogICAgICovCiAgICBfcmVtb3ZlUmVxdWVzdDogZnVuY3Rpb24gKHJlcSkKICAgIHsKICAgICAgICBTdHJvcGhlLmRlYnVnKCJyZW1vdmluZyByZXF1ZXN0Iik7CgogICAgICAgIHZhciBpOwogICAgICAgIGZvciAoaSA9IHRoaXMuX3JlcXVlc3RzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgIGlmIChyZXEgPT0gdGhpcy5fcmVxdWVzdHNbaV0pIHsKICAgICAgICAgICAgICAgIHRoaXMuX3JlcXVlc3RzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gSUU2IGZhaWxzIG9uIHNldHRpbmcgdG8gbnVsbCwgc28gc2V0IHRvIGVtcHR5IGZ1bmN0aW9uCiAgICAgICAgcmVxLnhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbiAoKSB7fTsKCiAgICAgICAgdGhpcy5fdGhyb3R0bGVkUmVxdWVzdEhhbmRsZXIoKTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX3Jlc3RhcnRSZXF1ZXN0CiAgICAgKiAgX1ByaXZhdGVfIGZ1bmN0aW9uIHRvIHJlc3RhcnQgYSByZXF1ZXN0IHRoYXQgaXMgcHJlc3VtZWQgZGVhZC4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChJbnRlZ2VyKSBpIC0gVGhlIGluZGV4IG9mIHRoZSByZXF1ZXN0IGluIHRoZSBxdWV1ZS4KICAgICAqLwogICAgX3Jlc3RhcnRSZXF1ZXN0OiBmdW5jdGlvbiAoaSkKICAgIHsKICAgICAgICB2YXIgcmVxID0gdGhpcy5fcmVxdWVzdHNbaV07CiAgICAgICAgaWYgKHJlcS5kZWFkID09PSBudWxsKSB7CiAgICAgICAgICAgIHJlcS5kZWFkID0gbmV3IERhdGUoKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX3Byb2Nlc3NSZXF1ZXN0KGkpOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfcmVxVG9EYXRhCiAgICAgKiBfUHJpdmF0ZV8gZnVuY3Rpb24gdG8gZ2V0IGEgc3RhbnphIG91dCBvZiBhIHJlcXVlc3QuCiAgICAgKgogICAgICogVHJpZXMgdG8gZXh0cmFjdCBhIHN0YW56YSBvdXQgb2YgYSBSZXF1ZXN0IE9iamVjdC4KICAgICAqIFdoZW4gdGhpcyBmYWlscyB0aGUgY3VycmVudCBjb25uZWN0aW9uIHdpbGwgYmUgZGlzY29ubmVjdGVkLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKE9iamVjdCkgcmVxIC0gVGhlIFJlcXVlc3QuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBUaGUgc3RhbnphIHRoYXQgd2FzIHBhc3NlZC4KICAgICAqLwogICAgX3JlcVRvRGF0YTogZnVuY3Rpb24gKHJlcSkKICAgIHsKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gcmVxLmdldFJlc3BvbnNlKCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBpZiAoZSAhPSAicGFyc2VyZXJyb3IiKSB7IHRocm93IGU7IH0KICAgICAgICAgICAgdGhpcy5fY29ubi5kaXNjb25uZWN0KCJzdHJvcGhlLXBhcnNlcmVycm9yIik7CiAgICAgICAgfQogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfc2VuZFRlcm1pbmF0ZQogICAgICogIF9Qcml2YXRlXyBmdW5jdGlvbiB0byBzZW5kIGluaXRpYWwgZGlzY29ubmVjdCBzZXF1ZW5jZS4KICAgICAqCiAgICAgKiAgVGhpcyBpcyB0aGUgZmlyc3Qgc3RlcCBpbiBhIGdyYWNlZnVsIGRpc2Nvbm5lY3QuICBJdCBzZW5kcwogICAgICogIHRoZSBCT1NIIHNlcnZlciBhIHRlcm1pbmF0ZSBib2R5IGFuZCBpbmNsdWRlcyBhbiB1bmF2YWlsYWJsZQogICAgICogIHByZXNlbmNlIGlmIGF1dGhlbnRpY2F0aW9uIGhhcyBjb21wbGV0ZWQuCiAgICAgKi8KICAgIF9zZW5kVGVybWluYXRlOiBmdW5jdGlvbiAocHJlcykKICAgIHsKICAgICAgICBTdHJvcGhlLmluZm8oIl9zZW5kVGVybWluYXRlIHdhcyBjYWxsZWQiKTsKICAgICAgICB2YXIgYm9keSA9IHRoaXMuX2J1aWxkQm9keSgpLmF0dHJzKHt0eXBlOiAidGVybWluYXRlIn0pOwoKICAgICAgICBpZiAocHJlcykgewogICAgICAgICAgICBib2R5LmNub2RlKHByZXMudHJlZSgpKTsKICAgICAgICB9CgogICAgICAgIHZhciByZXEgPSBuZXcgU3Ryb3BoZS5SZXF1ZXN0KGJvZHkudHJlZSgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX29uUmVxdWVzdFN0YXRlQ2hhbmdlLmJpbmQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMsIHRoaXMuX2Nvbm4uX2RhdGFSZWN2LmJpbmQodGhpcy5fY29ubikpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvZHkudHJlZSgpLmdldEF0dHJpYnV0ZSgicmlkIikpOwoKICAgICAgICB0aGlzLl9yZXF1ZXN0cy5wdXNoKHJlcSk7CiAgICAgICAgdGhpcy5fdGhyb3R0bGVkUmVxdWVzdEhhbmRsZXIoKTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX3NlbmQKICAgICAqICBfUHJpdmF0ZV8gcGFydCBvZiB0aGUgQ29ubmVjdGlvbi5zZW5kIGZ1bmN0aW9uIGZvciBCT1NICiAgICAgKgogICAgICogSnVzdCB0cmlnZ2VycyB0aGUgUmVxdWVzdEhhbmRsZXIgdG8gc2VuZCB0aGUgbWVzc2FnZXMgdGhhdCBhcmUgaW4gdGhlIHF1ZXVlCiAgICAgKi8KICAgIF9zZW5kOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX2Nvbm4uX2lkbGVUaW1lb3V0KTsKICAgICAgICB0aGlzLl90aHJvdHRsZWRSZXF1ZXN0SGFuZGxlcigpOwogICAgICAgIHRoaXMuX2Nvbm4uX2lkbGVUaW1lb3V0ID0gc2V0VGltZW91dCh0aGlzLl9jb25uLl9vbklkbGUuYmluZCh0aGlzLl9jb25uKSwgMTAwKTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX3NlbmRSZXN0YXJ0CiAgICAgKgogICAgICogIFNlbmQgYW4geG1wcDpyZXN0YXJ0IHN0YW56YS4KICAgICAqLwogICAgX3NlbmRSZXN0YXJ0OiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIHRoaXMuX3Rocm90dGxlZFJlcXVlc3RIYW5kbGVyKCk7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX2Nvbm4uX2lkbGVUaW1lb3V0KTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX3Rocm90dGxlZFJlcXVlc3RIYW5kbGVyCiAgICAgKiAgX1ByaXZhdGVfIGZ1bmN0aW9uIHRvIHRocm90dGxlIHJlcXVlc3RzIHRvIHRoZSBjb25uZWN0aW9uIHdpbmRvdy4KICAgICAqCiAgICAgKiAgVGhpcyBmdW5jdGlvbiBtYWtlcyBzdXJlIHdlIGRvbid0IHNlbmQgcmVxdWVzdHMgc28gZmFzdCB0aGF0IHRoZQogICAgICogIHJlcXVlc3QgaWRzIG92ZXJmbG93IHRoZSBjb25uZWN0aW9uIHdpbmRvdyBpbiB0aGUgY2FzZSB0aGF0IG9uZQogICAgICogIHJlcXVlc3QgZGllZC4KICAgICAqLwogICAgX3Rocm90dGxlZFJlcXVlc3RIYW5kbGVyOiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIGlmICghdGhpcy5fcmVxdWVzdHMpIHsKICAgICAgICAgICAgU3Ryb3BoZS5kZWJ1ZygiX3Rocm90dGxlZFJlcXVlc3RIYW5kbGVyIGNhbGxlZCB3aXRoICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICJ1bmRlZmluZWQgcmVxdWVzdHMiKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBTdHJvcGhlLmRlYnVnKCJfdGhyb3R0bGVkUmVxdWVzdEhhbmRsZXIgY2FsbGVkIHdpdGggIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVxdWVzdHMubGVuZ3RoICsgIiByZXF1ZXN0cyIpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCF0aGlzLl9yZXF1ZXN0cyB8fCB0aGlzLl9yZXF1ZXN0cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX3JlcXVlc3RzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdGhpcy5fcHJvY2Vzc1JlcXVlc3QoMCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fcmVxdWVzdHMubGVuZ3RoID4gMSAmJgogICAgICAgICAgICBNYXRoLmFicyh0aGlzLl9yZXF1ZXN0c1swXS5yaWQgLQogICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXF1ZXN0c1sxXS5yaWQpIDwgdGhpcy53aW5kb3cpIHsKICAgICAgICAgICAgdGhpcy5fcHJvY2Vzc1JlcXVlc3QoMSk7CiAgICAgICAgfQogICAgfQp9OwoKLyoKICAgIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIE1JVCBsaWNlbnNlLgogICAgUGxlYXNlIHNlZSB0aGUgTElDRU5TRSBmaWxlIGZvciBkZXRhaWxzLgoKICAgIENvcHlyaWdodCAyMDA2LTIwMDgsIE9HRywgTExDCiovCgovKiBqc2hpbnQgdW5kZWY6IHRydWUsIHVudXNlZDogdHJ1ZTosIG5vYXJnOiB0cnVlLCBsYXRlZGVmOiB0cnVlICovCi8qZ2xvYmFsIGRvY3VtZW50LCB3aW5kb3csIGNsZWFyVGltZW91dCwgV2ViU29ja2V0LAogICAgRE9NUGFyc2VyLCBTdHJvcGhlLCAkYnVpbGQgKi8KCi8qKiBDbGFzczogU3Ryb3BoZS5XZWJTb2NrZXQKICogIF9Qcml2YXRlXyBoZWxwZXIgY2xhc3MgdGhhdCBoYW5kbGVzIFdlYlNvY2tldCBDb25uZWN0aW9ucwogKgogKiAgVGhlIFN0cm9waGUuV2ViU29ja2V0IGNsYXNzIGlzIHVzZWQgaW50ZXJuYWxseSBieSBTdHJvcGhlLkNvbm5lY3Rpb24KICogIHRvIGVuY2Fwc3VsYXRlIFdlYlNvY2tldCBzZXNzaW9ucy4gSXQgaXMgbm90IG1lYW50IHRvIGJlIHVzZWQgZnJvbSB1c2VyJ3MgY29kZS4KICovCgovKiogRmlsZTogd2Vic29ja2V0LmpzCiAqICBBIEphdmFTY3JpcHQgbGlicmFyeSB0byBlbmFibGUgWE1QUCBvdmVyIFdlYnNvY2tldCBpbiBTdHJvcGhlanMuCiAqCiAqICBUaGlzIGZpbGUgaW1wbGVtZW50cyBYTVBQIG92ZXIgV2ViU29ja2V0cyBmb3IgU3Ryb3BoZWpzLgogKiAgSWYgYSBDb25uZWN0aW9uIGlzIGVzdGFibGlzaGVkIHdpdGggYSBXZWJzb2NrZXQgdXJsICh3czovLy4uLikKICogIFN0cm9waGUgd2lsbCB1c2UgV2ViU29ja2V0cy4KICogIEZvciBtb3JlIGluZm9ybWF0aW9uIG9uIFhNUFAtb3ZlciBXZWJTb2NrZXQgc2VlIHRoaXMgUkZDIGRyYWZ0OgogKiAgaHR0cDovL3Rvb2xzLmlldGYub3JnL2h0bWwvZHJhZnQtaWV0Zi14bXBwLXdlYnNvY2tldC0wMAogKgogKiAgV2ViU29ja2V0IHN1cHBvcnQgaW1wbGVtZW50ZWQgYnkgQW5kcmVhcyBHdXRoIChhbmRyZWFzLmd1dGhAcnd0aC1hYWNoZW4uZGUpCiAqLwoKLyoqIFByaXZhdGVDb25zdHJ1Y3RvcjogU3Ryb3BoZS5XZWJzb2NrZXQKICogIENyZWF0ZSBhbmQgaW5pdGlhbGl6ZSBhIFN0cm9waGUuV2ViU29ja2V0IG9iamVjdC4KICogIEN1cnJlbnRseSBvbmx5IHNldHMgdGhlIGNvbm5lY3Rpb24gT2JqZWN0LgogKgogKiAgUGFyYW1ldGVyczoKICogICAgKFN0cm9waGUuQ29ubmVjdGlvbikgY29ubmVjdGlvbiAtIFRoZSBTdHJvcGhlLkNvbm5lY3Rpb24gdGhhdCB3aWxsIHVzZSBXZWJTb2NrZXRzLgogKgogKiAgUmV0dXJuczoKICogICAgQSBuZXcgU3Ryb3BoZS5XZWJTb2NrZXQgb2JqZWN0LgogKi8KU3Ryb3BoZS5XZWJzb2NrZXQgPSBmdW5jdGlvbihjb25uZWN0aW9uKSB7CiAgICB0aGlzLl9jb25uID0gY29ubmVjdGlvbjsKICAgIHRoaXMuc3RyaXAgPSAic3RyZWFtOnN0cmVhbSI7CgogICAgdmFyIHNlcnZpY2UgPSBjb25uZWN0aW9uLnNlcnZpY2U7CiAgICBpZiAoc2VydmljZS5pbmRleE9mKCJ3czoiKSAhPT0gMCAmJiBzZXJ2aWNlLmluZGV4T2YoIndzczoiKSAhPT0gMCkgewogICAgICAgIC8vIElmIHRoZSBzZXJ2aWNlIGlzIG5vdCBhbiBhYnNvbHV0ZSBVUkwsIGFzc3VtZSBpdCBpcyBhIHBhdGggYW5kIHB1dCB0aGUgYWJzb2x1dGUKICAgICAgICAvLyBVUkwgdG9nZXRoZXIgZnJvbSBvcHRpb25zLCBjdXJyZW50IFVSTCBhbmQgdGhlIHBhdGguCiAgICAgICAgdmFyIG5ld19zZXJ2aWNlID0gIiI7CgogICAgICAgIGlmIChjb25uZWN0aW9uLm9wdGlvbnMucHJvdG9jb2wgPT09ICJ3cyIgJiYgd2luZG93LmxvY2F0aW9uLnByb3RvY29sICE9PSAiaHR0cHM6IikgewogICAgICAgICAgICBuZXdfc2VydmljZSArPSAid3MiOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5ld19zZXJ2aWNlICs9ICJ3c3MiOwogICAgICAgIH0KCiAgICAgICAgbmV3X3NlcnZpY2UgKz0gIjovLyIgKyB3aW5kb3cubG9jYXRpb24uaG9zdDsKCiAgICAgICAgaWYgKHNlcnZpY2UuaW5kZXhPZigiLyIpICE9PSAwKSB7CiAgICAgICAgICAgIG5ld19zZXJ2aWNlICs9IHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZSArIHNlcnZpY2U7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV3X3NlcnZpY2UgKz0gc2VydmljZTsKICAgICAgICB9CgogICAgICAgIGNvbm5lY3Rpb24uc2VydmljZSA9IG5ld19zZXJ2aWNlOwogICAgfQp9OwoKU3Ryb3BoZS5XZWJzb2NrZXQucHJvdG90eXBlID0gewogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX2J1aWxkU3RyZWFtCiAgICAgKiAgX1ByaXZhdGVfIGhlbHBlciBmdW5jdGlvbiB0byBnZW5lcmF0ZSB0aGUgPHN0cmVhbT4gc3RhcnQgdGFnIGZvciBXZWJTb2NrZXRzCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBBIFN0cm9waGUuQnVpbGRlciB3aXRoIGEgPHN0cmVhbT4gZWxlbWVudC4KICAgICAqLwogICAgX2J1aWxkU3RyZWFtOiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIHJldHVybiAkYnVpbGQoInN0cmVhbTpzdHJlYW0iLCB7CiAgICAgICAgICAgICJ0byI6IHRoaXMuX2Nvbm4uZG9tYWluLAogICAgICAgICAgICAieG1sbnMiOiBTdHJvcGhlLk5TLkNMSUVOVCwKICAgICAgICAgICAgInhtbG5zOnN0cmVhbSI6IFN0cm9waGUuTlMuU1RSRUFNLAogICAgICAgICAgICAidmVyc2lvbiI6ICcxLjAnCiAgICAgICAgfSk7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9jaGVja19zdHJlYW1lcnJvcgogICAgICogX1ByaXZhdGVfIGNoZWNrcyBhIG1lc3NhZ2UgZm9yIHN0cmVhbTplcnJvcgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKFN0cm9waGUuUmVxdWVzdCkgYm9keVdyYXAgLSBUaGUgcmVjZWl2ZWQgc3RhbnphLgogICAgICogICAgY29ubmVjdHN0YXR1cyAtIFRoZSBDb25uZWN0U3RhdHVzIHRoYXQgd2lsbCBiZSBzZXQgb24gZXJyb3IuCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgICB0cnVlIGlmIHRoZXJlIHdhcyBhIHN0cmVhbWVycm9yLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgKi8KICAgIF9jaGVja19zdHJlYW1lcnJvcjogZnVuY3Rpb24gKGJvZHlXcmFwLCBjb25uZWN0c3RhdHVzKSB7CiAgICAgICAgdmFyIGVycm9ycyA9IGJvZHlXcmFwLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJzdHJlYW06ZXJyb3IiKTsKICAgICAgICBpZiAoZXJyb3JzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHZhciBlcnJvciA9IGVycm9yc1swXTsKCiAgICAgICAgdmFyIGNvbmRpdGlvbiA9ICIiOwogICAgICAgIHZhciB0ZXh0ID0gIiI7CgogICAgICAgIHZhciBucyA9ICJ1cm46aWV0ZjpwYXJhbXM6eG1sOm5zOnhtcHAtc3RyZWFtcyI7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlcnJvci5jaGlsZE5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBlID0gZXJyb3IuY2hpbGROb2Rlc1tpXTsKICAgICAgICAgICAgaWYgKGUuZ2V0QXR0cmlidXRlKCJ4bWxucyIpICE9PSBucykgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gaWYgKGUubm9kZU5hbWUgPT09ICJ0ZXh0IikgewogICAgICAgICAgICAgICAgdGV4dCA9IGUudGV4dENvbnRlbnQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25kaXRpb24gPSBlLm5vZGVOYW1lOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgZXJyb3JTdHJpbmcgPSAiV2ViU29ja2V0IHN0cmVhbSBlcnJvcjogIjsKCiAgICAgICAgaWYgKGNvbmRpdGlvbikgewogICAgICAgICAgICBlcnJvclN0cmluZyArPSBjb25kaXRpb247CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZXJyb3JTdHJpbmcgKz0gInVua25vd24iOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRleHQpIHsKICAgICAgICAgICAgZXJyb3JTdHJpbmcgKz0gIiAtICIgKyBjb25kaXRpb247CiAgICAgICAgfQoKICAgICAgICBTdHJvcGhlLmVycm9yKGVycm9yU3RyaW5nKTsKCiAgICAgICAgLy8gY2xvc2UgdGhlIGNvbm5lY3Rpb24gb24gc3RyZWFtX2Vycm9yCiAgICAgICAgdGhpcy5fY29ubi5fY2hhbmdlQ29ubmVjdFN0YXR1cyhjb25uZWN0c3RhdHVzLCBjb25kaXRpb24pOwogICAgICAgIHRoaXMuX2Nvbm4uX2RvRGlzY29ubmVjdCgpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfcmVzZXQKICAgICAqICBSZXNldCB0aGUgY29ubmVjdGlvbi4KICAgICAqCiAgICAgKiAgVGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQgYnkgdGhlIHJlc2V0IGZ1bmN0aW9uIG9mIHRoZSBTdHJvcGhlIENvbm5lY3Rpb24uCiAgICAgKiAgSXMgbm90IG5lZWRlZCBieSBXZWJTb2NrZXRzLgogICAgICovCiAgICBfcmVzZXQ6IGZ1bmN0aW9uICgpCiAgICB7CiAgICAgICAgcmV0dXJuOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfY29ubmVjdAogICAgICogIF9Qcml2YXRlXyBmdW5jdGlvbiBjYWxsZWQgYnkgU3Ryb3BoZS5Db25uZWN0aW9uLmNvbm5lY3QKICAgICAqCiAgICAgKiAgQ3JlYXRlcyBhIFdlYlNvY2tldCBmb3IgYSBjb25uZWN0aW9uIGFuZCBhc3NpZ25zIENhbGxiYWNrcyB0byBpdC4KICAgICAqICBEb2VzIG5vdGhpbmcgaWYgdGhlcmUgYWxyZWFkeSBpcyBhIFdlYlNvY2tldC4KICAgICAqLwogICAgX2Nvbm5lY3Q6IGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBFbnN1cmUgdGhhdCB0aGVyZSBpcyBubyBvcGVuIFdlYlNvY2tldCBmcm9tIGEgcHJldmlvdXMgQ29ubmVjdGlvbi4KICAgICAgICB0aGlzLl9jbG9zZVNvY2tldCgpOwoKICAgICAgICAvLyBDcmVhdGUgdGhlIG5ldyBXb2JTb2NrZXQKICAgICAgICB0aGlzLnNvY2tldCA9IG5ldyBXZWJTb2NrZXQodGhpcy5fY29ubi5zZXJ2aWNlLCAieG1wcCIpOwogICAgICAgIHRoaXMuc29ja2V0Lm9ub3BlbiA9IHRoaXMuX29uT3Blbi5iaW5kKHRoaXMpOwogICAgICAgIHRoaXMuc29ja2V0Lm9uZXJyb3IgPSB0aGlzLl9vbkVycm9yLmJpbmQodGhpcyk7CiAgICAgICAgdGhpcy5zb2NrZXQub25jbG9zZSA9IHRoaXMuX29uQ2xvc2UuYmluZCh0aGlzKTsKICAgICAgICB0aGlzLnNvY2tldC5vbm1lc3NhZ2UgPSB0aGlzLl9jb25uZWN0X2NiX3dyYXBwZXIuYmluZCh0aGlzKTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX2Nvbm5lY3RfY2IKICAgICAqICBfUHJpdmF0ZV8gZnVuY3Rpb24gY2FsbGVkIGJ5IFN0cm9waGUuQ29ubmVjdGlvbi5fY29ubmVjdF9jYgogICAgICoKICAgICAqIGNoZWNrcyBmb3Igc3RyZWFtOmVycm9yCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoU3Ryb3BoZS5SZXF1ZXN0KSBib2R5V3JhcCAtIFRoZSByZWNlaXZlZCBzdGFuemEuCiAgICAgKi8KICAgIF9jb25uZWN0X2NiOiBmdW5jdGlvbihib2R5V3JhcCkgewogICAgICAgIHZhciBlcnJvciA9IHRoaXMuX2NoZWNrX3N0cmVhbWVycm9yKGJvZHlXcmFwLCBTdHJvcGhlLlN0YXR1cy5DT05ORkFJTCk7CiAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgIHJldHVybiBTdHJvcGhlLlN0YXR1cy5DT05ORkFJTDsKICAgICAgICB9CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9oYW5kbGVTdHJlYW1TdGFydAogICAgICogX1ByaXZhdGVfIGZ1bmN0aW9uIHRoYXQgY2hlY2tzIHRoZSBvcGVuaW5nIHN0cmVhbTpzdHJlYW0gdGFnIGZvciBlcnJvcnMuCiAgICAgKgogICAgICogRGlzY29ubmVjdHMgaWYgdGhlcmUgaXMgYW4gZXJyb3IgYW5kIHJldHVybnMgZmFsc2UsIHRydWUgb3RoZXJ3aXNlLgogICAgICoKICAgICAqICBQYXJhbWV0ZXJzOgogICAgICogICAgKE5vZGUpIG1lc3NhZ2UgLSBTdGFuemEgY29udGFpbmluZyB0aGUgc3RyZWFtOnN0cmVhbS4KICAgICAqLwogICAgX2hhbmRsZVN0cmVhbVN0YXJ0OiBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgICAgdmFyIGVycm9yID0gZmFsc2U7CiAgICAgICAgLy8gQ2hlY2sgZm9yIGVycm9ycyBpbiB0aGUgc3RyZWFtOnN0cmVhbSB0YWcKICAgICAgICB2YXIgbnMgPSBtZXNzYWdlLmdldEF0dHJpYnV0ZSgieG1sbnMiKTsKICAgICAgICBpZiAodHlwZW9mIG5zICE9PSAic3RyaW5nIikgewogICAgICAgICAgICBlcnJvciA9ICJNaXNzaW5nIHhtbG5zIGluIHN0cmVhbTpzdHJlYW0iOwogICAgICAgIH0gZWxzZSBpZiAobnMgIT09IFN0cm9waGUuTlMuQ0xJRU5UKSB7CiAgICAgICAgICAgIGVycm9yID0gIldyb25nIHhtbG5zIGluIHN0cmVhbTpzdHJlYW06ICIgKyBuczsKICAgICAgICB9CgogICAgICAgIHZhciBuc19zdHJlYW0gPSBtZXNzYWdlLm5hbWVzcGFjZVVSSTsKICAgICAgICBpZiAodHlwZW9mIG5zX3N0cmVhbSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgZXJyb3IgPSAiTWlzc2luZyB4bWxuczpzdHJlYW0gaW4gc3RyZWFtOnN0cmVhbSI7CiAgICAgICAgfSBlbHNlIGlmIChuc19zdHJlYW0gIT09IFN0cm9waGUuTlMuU1RSRUFNKSB7CiAgICAgICAgICAgIGVycm9yID0gIldyb25nIHhtbG5zOnN0cmVhbSBpbiBzdHJlYW06c3RyZWFtOiAiICsgbnNfc3RyZWFtOwogICAgICAgIH0KCiAgICAgICAgdmFyIHZlciA9IG1lc3NhZ2UuZ2V0QXR0cmlidXRlKCJ2ZXJzaW9uIik7CiAgICAgICAgaWYgKHR5cGVvZiB2ZXIgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGVycm9yID0gIk1pc3NpbmcgdmVyc2lvbiBpbiBzdHJlYW06c3RyZWFtIjsKICAgICAgICB9IGVsc2UgaWYgKHZlciAhPT0gIjEuMCIpIHsKICAgICAgICAgICAgZXJyb3IgPSAiV3JvbmcgdmVyc2lvbiBpbiBzdHJlYW06c3RyZWFtOiAiICsgdmVyOwogICAgICAgIH0KCiAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgIHRoaXMuX2Nvbm4uX2NoYW5nZUNvbm5lY3RTdGF0dXMoU3Ryb3BoZS5TdGF0dXMuQ09OTkZBSUwsIGVycm9yKTsKICAgICAgICAgICAgdGhpcy5fY29ubi5fZG9EaXNjb25uZWN0KCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfY29ubmVjdF9jYl93cmFwcGVyCiAgICAgKiBfUHJpdmF0ZV8gZnVuY3Rpb24gdGhhdCBoYW5kbGVzIHRoZSBmaXJzdCBjb25uZWN0aW9uIG1lc3NhZ2VzLgogICAgICoKICAgICAqIE9uIHJlY2VpdmluZyBhbiBvcGVuaW5nIHN0cmVhbSB0YWcgdGhpcyBjYWxsYmFjayByZXBsYWNlcyBpdHNlbGYgd2l0aCB0aGUgcmVhbAogICAgICogbWVzc2FnZSBoYW5kbGVyLiBPbiByZWNlaXZpbmcgYSBzdHJlYW0gZXJyb3IgdGhlIGNvbm5lY3Rpb24gaXMgdGVybWluYXRlZC4KICAgICAqLwogICAgX2Nvbm5lY3RfY2Jfd3JhcHBlcjogZnVuY3Rpb24obWVzc2FnZSkgewogICAgICAgIGlmIChtZXNzYWdlLmRhdGEuaW5kZXhPZigiPHN0cmVhbTpzdHJlYW0gIikgPT09IDAgfHwgbWVzc2FnZS5kYXRhLmluZGV4T2YoIjw/eG1sIikgPT09IDApIHsKICAgICAgICAgICAgLy8gU3RyaXAgdGhlIFhNTCBEZWNsYXJhdGlvbiwgaWYgdGhlcmUgaXMgb25lCiAgICAgICAgICAgIHZhciBkYXRhID0gbWVzc2FnZS5kYXRhLnJlcGxhY2UoL14oPFw/Lio/XD8+XHMqKSovLCAiIik7CiAgICAgICAgICAgIGlmIChkYXRhID09PSAnJykgcmV0dXJuOwoKICAgICAgICAgICAgLy9NYWtlIHRoZSBpbml0aWFsIHN0cmVhbTpzdHJlYW0gc2VsZmNsb3NpbmcgdG8gcGFyc2UgaXQgd2l0aG91dCBhIFNBWCBwYXJzZXIuCiAgICAgICAgICAgIGRhdGEgPSBtZXNzYWdlLmRhdGEucmVwbGFjZSgvPHN0cmVhbTpzdHJlYW0gKC4qW15cL10pPi8sICI8c3RyZWFtOnN0cmVhbSAkMS8+Iik7CgogICAgICAgICAgICB2YXIgc3RyZWFtU3RhcnQgPSBuZXcgRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKGRhdGEsICJ0ZXh0L3htbCIpLmRvY3VtZW50RWxlbWVudDsKICAgICAgICAgICAgdGhpcy5fY29ubi54bWxJbnB1dChzdHJlYW1TdGFydCk7CiAgICAgICAgICAgIHRoaXMuX2Nvbm4ucmF3SW5wdXQobWVzc2FnZS5kYXRhKTsKCiAgICAgICAgICAgIC8vX2hhbmRsZVN0cmVhbVN0ZWFydCB3aWxsIGNoZWNrIGZvciBYTUwgZXJyb3JzIGFuZCBkaXNjb25uZWN0IG9uIGVycm9yCiAgICAgICAgICAgIGlmICh0aGlzLl9oYW5kbGVTdHJlYW1TdGFydChzdHJlYW1TdGFydCkpIHsKCiAgICAgICAgICAgICAgICAvL19jb25uZWN0X2NiIHdpbGwgY2hlY2sgZm9yIHN0cmVhbTplcnJvciBhbmQgZGlzY29ubmVjdCBvbiBlcnJvcgogICAgICAgICAgICAgICAgdGhpcy5fY29ubmVjdF9jYihzdHJlYW1TdGFydCk7CgogICAgICAgICAgICAgICAgLy8gZW5zdXJlIHJlY2VpdmVkIHN0cmVhbTpzdHJlYW0gaXMgTk9UIHNlbGZjbG9zaW5nIGFuZCBzYXZlIGl0IGZvciBmb2xsb3dpbmcgbWVzc2FnZXMKICAgICAgICAgICAgICAgIHRoaXMuc3RyZWFtU3RhcnQgPSBtZXNzYWdlLmRhdGEucmVwbGFjZSgvXjxzdHJlYW06KC4qKVwvPiQvLCAiPHN0cmVhbTokMT4iKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAobWVzc2FnZS5kYXRhID09PSAiPC9zdHJlYW06c3RyZWFtPiIpIHsKICAgICAgICAgICAgdGhpcy5fY29ubi5yYXdJbnB1dChtZXNzYWdlLmRhdGEpOwogICAgICAgICAgICB0aGlzLl9jb25uLnhtbElucHV0KGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInN0cmVhbTpzdHJlYW0iKSk7CiAgICAgICAgICAgIHRoaXMuX2Nvbm4uX2NoYW5nZUNvbm5lY3RTdGF0dXMoU3Ryb3BoZS5TdGF0dXMuQ09OTkZBSUwsICJSZWNlaXZlZCBjbG9zaW5nIHN0cmVhbSIpOwogICAgICAgICAgICB0aGlzLl9jb25uLl9kb0Rpc2Nvbm5lY3QoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBzdHJpbmcgPSB0aGlzLl9zdHJlYW1XcmFwKG1lc3NhZ2UuZGF0YSk7CiAgICAgICAgICAgIHZhciBlbGVtID0gbmV3IERPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyhzdHJpbmcsICJ0ZXh0L3htbCIpLmRvY3VtZW50RWxlbWVudDsKICAgICAgICAgICAgdGhpcy5zb2NrZXQub25tZXNzYWdlID0gdGhpcy5fb25NZXNzYWdlLmJpbmQodGhpcyk7CiAgICAgICAgICAgIHRoaXMuX2Nvbm4uX2Nvbm5lY3RfY2IoZWxlbSwgbnVsbCwgbWVzc2FnZS5kYXRhKTsKICAgICAgICB9CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9kaXNjb25uZWN0CiAgICAgKiAgX1ByaXZhdGVfIGZ1bmN0aW9uIGNhbGxlZCBieSBTdHJvcGhlLkNvbm5lY3Rpb24uZGlzY29ubmVjdAogICAgICoKICAgICAqICBEaXNjb25uZWN0cyBhbmQgc2VuZHMgYSBsYXN0IHN0YW56YSBpZiBvbmUgaXMgZ2l2ZW4KICAgICAqCiAgICAgKiAgUGFyYW1ldGVyczoKICAgICAqICAgIChSZXF1ZXN0KSBwcmVzIC0gVGhpcyBzdGFuemEgd2lsbCBiZSBzZW50IGJlZm9yZSBkaXNjb25uZWN0aW5nLgogICAgICovCiAgICBfZGlzY29ubmVjdDogZnVuY3Rpb24gKHByZXMpCiAgICB7CiAgICAgICAgaWYgKHRoaXMuc29ja2V0LnJlYWR5U3RhdGUgIT09IFdlYlNvY2tldC5DTE9TRUQpIHsKICAgICAgICAgICAgaWYgKHByZXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2Nvbm4uc2VuZChwcmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2xvc2UgPSAnPC9zdHJlYW06c3RyZWFtPic7CiAgICAgICAgICAgIHRoaXMuX2Nvbm4ueG1sT3V0cHV0KGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInN0cmVhbTpzdHJlYW0iKSk7CiAgICAgICAgICAgIHRoaXMuX2Nvbm4ucmF3T3V0cHV0KGNsb3NlKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRoaXMuc29ja2V0LnNlbmQoY2xvc2UpOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBTdHJvcGhlLmluZm8oIkNvdWxkbid0IHNlbmQgY2xvc2luZyBzdHJlYW0gdGFnLiIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9jb25uLl9kb0Rpc2Nvbm5lY3QoKTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX2RvRGlzY29ubmVjdAogICAgICogIF9Qcml2YXRlXyBmdW5jdGlvbiB0byBkaXNjb25uZWN0LgogICAgICoKICAgICAqICBKdXN0IGNsb3NlcyB0aGUgU29ja2V0IGZvciBXZWJTb2NrZXRzCiAgICAgKi8KICAgIF9kb0Rpc2Nvbm5lY3Q6IGZ1bmN0aW9uICgpCiAgICB7CiAgICAgICAgU3Ryb3BoZS5pbmZvKCJXZWJTb2NrZXRzIF9kb0Rpc2Nvbm5lY3Qgd2FzIGNhbGxlZCIpOwogICAgICAgIHRoaXMuX2Nsb3NlU29ja2V0KCk7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb24gX3N0cmVhbVdyYXAKICAgICAqICBfUHJpdmF0ZV8gaGVscGVyIGZ1bmN0aW9uIHRvIHdyYXAgYSBzdGFuemEgaW4gYSA8c3RyZWFtPiB0YWcuCiAgICAgKiAgVGhpcyBpcyB1c2VkIHNvIFN0cm9waGUgY2FuIHByb2Nlc3Mgc3RhbnphcyBmcm9tIFdlYlNvY2tldHMgbGlrZSBCT1NICiAgICAgKi8KICAgIF9zdHJlYW1XcmFwOiBmdW5jdGlvbiAoc3RhbnphKQogICAgewogICAgICAgIHJldHVybiB0aGlzLnN0cmVhbVN0YXJ0ICsgc3RhbnphICsgJzwvc3RyZWFtOnN0cmVhbT4nOwogICAgfSwKCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX2Nsb3NlU29ja2V0CiAgICAgKiAgX1ByaXZhdGVfIGZ1bmN0aW9uIHRvIGNsb3NlIHRoZSBXZWJTb2NrZXQuCiAgICAgKgogICAgICogIENsb3NlcyB0aGUgc29ja2V0IGlmIGl0IGlzIHN0aWxsIG9wZW4gYW5kIGRlbGV0ZXMgaXQKICAgICAqLwogICAgX2Nsb3NlU29ja2V0OiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIGlmICh0aGlzLnNvY2tldCkgeyB0cnkgewogICAgICAgICAgICB0aGlzLnNvY2tldC5jbG9zZSgpOwogICAgICAgIH0gY2F0Y2ggKGUpIHt9IH0KICAgICAgICB0aGlzLnNvY2tldCA9IG51bGw7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9lbXB0eVF1ZXVlCiAgICAgKiBfUHJpdmF0ZV8gZnVuY3Rpb24gdG8gY2hlY2sgaWYgdGhlIG1lc3NhZ2UgcXVldWUgaXMgZW1wdHkuCiAgICAgKgogICAgICogIFJldHVybnM6CiAgICAgKiAgICBUcnVlLCBiZWNhdXNlIFdlYlNvY2tldCBtZXNzYWdlcyBhcmUgc2VuZCBpbW1lZGlhdGVseSBhZnRlciBxdWV1ZWluZy4KICAgICAqLwogICAgX2VtcHR5UXVldWU6IGZ1bmN0aW9uICgpCiAgICB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9vbkNsb3NlCiAgICAgKiBfUHJpdmF0ZV8gZnVuY3Rpb24gdG8gaGFuZGxlIHdlYnNvY2tldHMgY2xvc2luZy4KICAgICAqCiAgICAgKiBOb3RoaW5nIHRvIGRvIGhlcmUgZm9yIFdlYlNvY2tldHMKICAgICAqLwogICAgX29uQ2xvc2U6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmKHRoaXMuX2Nvbm4uY29ubmVjdGVkICYmICF0aGlzLl9jb25uLmRpc2Nvbm5lY3RpbmcpIHsKICAgICAgICAgICAgU3Ryb3BoZS5lcnJvcigiV2Vic29ja2V0IGNsb3NlZCB1bmV4Y2VjdGVkbHkiKTsKICAgICAgICAgICAgdGhpcy5fY29ubi5fZG9EaXNjb25uZWN0KCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgU3Ryb3BoZS5pbmZvKCJXZWJzb2NrZXQgY2xvc2VkIik7CiAgICAgICAgfQogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfbm9fYXV0aF9yZWNlaXZlZAogICAgICoKICAgICAqIENhbGxlZCBvbiBzdHJlYW0gc3RhcnQvcmVzdGFydCB3aGVuIG5vIHN0cmVhbTpmZWF0dXJlcwogICAgICogaGFzIGJlZW4gcmVjZWl2ZWQuCiAgICAgKi8KICAgIF9ub19hdXRoX3JlY2VpdmVkOiBmdW5jdGlvbiAoX2NhbGxiYWNrKQogICAgewogICAgICAgIFN0cm9waGUuZXJyb3IoIlNlcnZlciBkaWQgbm90IHNlbmQgYW55IGF1dGggbWV0aG9kcyIpOwogICAgICAgIHRoaXMuX2Nvbm4uX2NoYW5nZUNvbm5lY3RTdGF0dXMoU3Ryb3BoZS5TdGF0dXMuQ09OTkZBSUwsICJTZXJ2ZXIgZGlkIG5vdCBzZW5kIGFueSBhdXRoIG1ldGhvZHMiKTsKICAgICAgICBpZiAoX2NhbGxiYWNrKSB7CiAgICAgICAgICAgIF9jYWxsYmFjayA9IF9jYWxsYmFjay5iaW5kKHRoaXMuX2Nvbm4pOwogICAgICAgICAgICBfY2FsbGJhY2soKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fY29ubi5fZG9EaXNjb25uZWN0KCk7CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9vbkRpc2Nvbm5lY3RUaW1lb3V0CiAgICAgKiAgX1ByaXZhdGVfIHRpbWVvdXQgaGFuZGxlciBmb3IgaGFuZGxpbmcgbm9uLWdyYWNlZnVsIGRpc2Nvbm5lY3Rpb24uCiAgICAgKgogICAgICogIFRoaXMgZG9lcyBub3RoaW5nIGZvciBXZWJTb2NrZXRzCiAgICAgKi8KICAgIF9vbkRpc2Nvbm5lY3RUaW1lb3V0OiBmdW5jdGlvbiAoKSB7fSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfb25FcnJvcgogICAgICogX1ByaXZhdGVfIGZ1bmN0aW9uIHRvIGhhbmRsZSB3ZWJzb2NrZXRzIGVycm9ycy4KICAgICAqCiAgICAgKiBQYXJhbWV0ZXJzOgogICAgICogKE9iamVjdCkgZXJyb3IgLSBUaGUgd2Vic29ja2V0IGVycm9yLgogICAgICovCiAgICBfb25FcnJvcjogZnVuY3Rpb24oZXJyb3IpIHsKICAgICAgICBTdHJvcGhlLmVycm9yKCJXZWJzb2NrZXQgZXJyb3IgIiArIGVycm9yKTsKICAgICAgICB0aGlzLl9jb25uLl9jaGFuZ2VDb25uZWN0U3RhdHVzKFN0cm9waGUuU3RhdHVzLkNPTk5GQUlMLCAiVGhlIFdlYlNvY2tldCBjb25uZWN0aW9uIGNvdWxkIG5vdCBiZSBlc3RhYmxpc2hlZCB3YXMgZGlzY29ubmVjdGVkLiIpOwogICAgICAgIHRoaXMuX2Rpc2Nvbm5lY3QoKTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX29uSWRsZQogICAgICogIF9Qcml2YXRlXyBmdW5jdGlvbiBjYWxsZWQgYnkgU3Ryb3BoZS5Db25uZWN0aW9uLl9vbklkbGUKICAgICAqCiAgICAgKiAgc2VuZHMgYWxsIHF1ZXVlZCBzdGFuemFzCiAgICAgKi8KICAgIF9vbklkbGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZGF0YSA9IHRoaXMuX2Nvbm4uX2RhdGE7CiAgICAgICAgaWYgKGRhdGEubGVuZ3RoID4gMCAmJiAhdGhpcy5fY29ubi5wYXVzZWQpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoZGF0YVtpXSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBzdGFuemEsIHJhd1N0YW56YTsKICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YVtpXSA9PT0gInJlc3RhcnQiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YW56YSA9IHRoaXMuX2J1aWxkU3RyZWFtKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJhd1N0YW56YSA9IHRoaXMuX3JlbW92ZUNsb3NpbmdUYWcoc3RhbnphKTsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhbnphID0gc3RhbnphLnRyZWUoKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBzdGFuemEgPSBkYXRhW2ldOwogICAgICAgICAgICAgICAgICAgICAgICByYXdTdGFuemEgPSBTdHJvcGhlLnNlcmlhbGl6ZShzdGFuemEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9jb25uLnhtbE91dHB1dChzdGFuemEpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2Nvbm4ucmF3T3V0cHV0KHJhd1N0YW56YSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zb2NrZXQuc2VuZChyYXdTdGFuemEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX2Nvbm4uX2RhdGEgPSBbXTsKICAgICAgICB9CiAgICB9LAoKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9vbk1lc3NhZ2UKICAgICAqIF9Qcml2YXRlXyBmdW5jdGlvbiB0byBoYW5kbGUgd2Vic29ja2V0cyBtZXNzYWdlcy4KICAgICAqCiAgICAgKiBUaGlzIGZ1bmN0aW9uIHBhcnNlcyBlYWNoIG9mIHRoZSBtZXNzYWdlcyBhcyBpZiB0aGV5IGFyZSBmdWxsIGRvY3VtZW50cy4gW1RPRE8gOiBXZSBtYXkgYWN0dWFsbHkgd2FudCB0byB1c2UgYSBTQVggUHVzaCBwYXJzZXJdLgogICAgICoKICAgICAqIFNpbmNlIGFsbCBYTVBQIHRyYWZmaWMgc3RhcnRzIHdpdGggIjxzdHJlYW06c3RyZWFtIHZlcnNpb249JzEuMCcgeG1sOmxhbmc9J2VuJyB4bWxucz0namFiYmVyOmNsaWVudCcgeG1sbnM6c3RyZWFtPSdodHRwOi8vZXRoZXJ4LmphYmJlci5vcmcvc3RyZWFtcycgaWQ9JzM2OTczOTU0NjMnIGZyb209J1NFUlZFUic+IgogICAgICogVGhlIGZpcnN0IHN0YW56YSB3aWxsIGFsd2F5cyBmYWlsIHRvIGJlIHBhcnNlZC4uLgogICAgICogQWRkdGlvbm5hbHksIHRoZSBzZWNvbmRzIHN0YW56YSB3aWxsIGFsd2F5cyBiZSBhIDxzdHJlYW06ZmVhdHVyZXM+IHdpdGggdGhlIHN0cmVhbSBOUyBkZWZpbmVkIGluIHRoZSBwcmV2aW91cyBzdGFuemEuLi4gc28gd2UgbmVlZCB0byAnZm9yY2UnIHRoZSBpbmNsdXNpb24gb2YgdGhlIE5TIGluIHRoaXMgc3RhbnphIQogICAgICoKICAgICAqIFBhcmFtZXRlcnM6CiAgICAgKiAoc3RyaW5nKSBtZXNzYWdlIC0gVGhlIHdlYnNvY2tldCBtZXNzYWdlLgogICAgICovCiAgICBfb25NZXNzYWdlOiBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgICAgdmFyIGVsZW0sIGRhdGE7CiAgICAgICAgLy8gY2hlY2sgZm9yIGNsb3Npbmcgc3RyZWFtCiAgICAgICAgaWYgKG1lc3NhZ2UuZGF0YSA9PT0gIjwvc3RyZWFtOnN0cmVhbT4iKSB7CiAgICAgICAgICAgIHZhciBjbG9zZSA9ICI8L3N0cmVhbTpzdHJlYW0+IjsKICAgICAgICAgICAgdGhpcy5fY29ubi5yYXdJbnB1dChjbG9zZSk7CiAgICAgICAgICAgIHRoaXMuX2Nvbm4ueG1sSW5wdXQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3RyZWFtOnN0cmVhbSIpKTsKICAgICAgICAgICAgaWYgKCF0aGlzLl9jb25uLmRpc2Nvbm5lY3RpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2Nvbm4uX2RvRGlzY29ubmVjdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9IGVsc2UgaWYgKG1lc3NhZ2UuZGF0YS5zZWFyY2goIjxzdHJlYW06c3RyZWFtICIpID09PSAwKSB7CiAgICAgICAgICAgIC8vTWFrZSB0aGUgaW5pdGlhbCBzdHJlYW06c3RyZWFtIHNlbGZjbG9zaW5nIHRvIHBhcnNlIGl0IHdpdGhvdXQgYSBTQVggcGFyc2VyLgogICAgICAgICAgICBkYXRhID0gbWVzc2FnZS5kYXRhLnJlcGxhY2UoLzxzdHJlYW06c3RyZWFtICguKlteXC9dKT4vLCAiPHN0cmVhbTpzdHJlYW0gJDEvPiIpOwogICAgICAgICAgICBlbGVtID0gbmV3IERPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyhkYXRhLCAidGV4dC94bWwiKS5kb2N1bWVudEVsZW1lbnQ7CgogICAgICAgICAgICBpZiAoIXRoaXMuX2hhbmRsZVN0cmVhbVN0YXJ0KGVsZW0pKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkYXRhID0gdGhpcy5fc3RyZWFtV3JhcChtZXNzYWdlLmRhdGEpOwogICAgICAgICAgICBlbGVtID0gbmV3IERPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyhkYXRhLCAidGV4dC94bWwiKS5kb2N1bWVudEVsZW1lbnQ7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fY2hlY2tfc3RyZWFtZXJyb3IoZWxlbSwgU3Ryb3BoZS5TdGF0dXMuRVJST1IpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vaGFuZGxlIHVuYXZhaWxhYmxlIHByZXNlbmNlIHN0YW56YSBiZWZvcmUgZGlzY29ubmVjdGluZwogICAgICAgIGlmICh0aGlzLl9jb25uLmRpc2Nvbm5lY3RpbmcgJiYKICAgICAgICAgICAgICAgIGVsZW0uZmlyc3RDaGlsZC5ub2RlTmFtZSA9PT0gInByZXNlbmNlIiAmJgogICAgICAgICAgICAgICAgZWxlbS5maXJzdENoaWxkLmdldEF0dHJpYnV0ZSgidHlwZSIpID09PSAidW5hdmFpbGFibGUiKSB7CiAgICAgICAgICAgIHRoaXMuX2Nvbm4ueG1sSW5wdXQoZWxlbSk7CiAgICAgICAgICAgIHRoaXMuX2Nvbm4ucmF3SW5wdXQoU3Ryb3BoZS5zZXJpYWxpemUoZWxlbSkpOwogICAgICAgICAgICAvLyBpZiB3ZSBhcmUgYWxyZWFkeSBkaXNjb25uZWN0aW5nIHdlIHdpbGwgaWdub3JlIHRoZSB1bmF2YWlsYWJsZSBzdGFuemEgYW5kCiAgICAgICAgICAgIC8vIHdhaXQgZm9yIHRoZSA8L3N0cmVhbTpzdHJlYW0+IHRhZyBiZWZvcmUgd2UgY2xvc2UgdGhlIGNvbm5lY3Rpb24KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLl9jb25uLl9kYXRhUmVjdihlbGVtLCBtZXNzYWdlLmRhdGEpOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfb25PcGVuCiAgICAgKiBfUHJpdmF0ZV8gZnVuY3Rpb24gdG8gaGFuZGxlIHdlYnNvY2tldHMgY29ubmVjdGlvbiBzZXR1cC4KICAgICAqCiAgICAgKiBUaGUgb3BlbmluZyBzdHJlYW0gdGFnIGlzIHNlbnQgaGVyZS4KICAgICAqLwogICAgX29uT3BlbjogZnVuY3Rpb24oKSB7CiAgICAgICAgU3Ryb3BoZS5pbmZvKCJXZWJzb2NrZXQgb3BlbiIpOwogICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2J1aWxkU3RyZWFtKCk7CiAgICAgICAgdGhpcy5fY29ubi54bWxPdXRwdXQoc3RhcnQudHJlZSgpKTsKCiAgICAgICAgdmFyIHN0YXJ0U3RyaW5nID0gdGhpcy5fcmVtb3ZlQ2xvc2luZ1RhZyhzdGFydCk7CiAgICAgICAgdGhpcy5fY29ubi5yYXdPdXRwdXQoc3RhcnRTdHJpbmcpOwogICAgICAgIHRoaXMuc29ja2V0LnNlbmQoc3RhcnRTdHJpbmcpOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfcmVtb3ZlQ2xvc2luZ1RhZwogICAgICogIF9Qcml2YXRlXyBmdW5jdGlvbiB0byBNYWtlIHRoZSBmaXJzdCA8c3RyZWFtOnN0cmVhbT4gbm9uLXNlbGZjbG9zaW5nCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAgIChPYmplY3QpIGVsZW0gLSBUaGUgPHN0cmVhbTpzdHJlYW0+IHRhZy4KICAgICAqCiAgICAgKiAgUmV0dXJuczoKICAgICAqICAgICAgVGhlIHN0cmVhbTpzdHJlYW0gdGFnIGFzIFN0cmluZwogICAgICovCiAgICBfcmVtb3ZlQ2xvc2luZ1RhZzogZnVuY3Rpb24oZWxlbSkgewogICAgICAgIHZhciBzdHJpbmcgPSBTdHJvcGhlLnNlcmlhbGl6ZShlbGVtKTsKICAgICAgICBzdHJpbmcgPSBzdHJpbmcucmVwbGFjZSgvPChzdHJlYW06c3RyZWFtIC4qW15cL10pXC8+JC8sICI8JDE+Iik7CiAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX3JlcVRvRGF0YQogICAgICogX1ByaXZhdGVfIGZ1bmN0aW9uIHRvIGdldCBhIHN0YW56YSBvdXQgb2YgYSByZXF1ZXN0LgogICAgICoKICAgICAqIFdlYlNvY2tldHMgZG9uJ3QgdXNlIHJlcXVlc3RzLCBzbyB0aGUgcGFzc2VkIGFyZ3VtZW50IGlzIGp1c3QgcmV0dXJuZWQuCiAgICAgKgogICAgICogIFBhcmFtZXRlcnM6CiAgICAgKiAgICAoT2JqZWN0KSBzdGFuemEgLSBUaGUgc3RhbnphLgogICAgICoKICAgICAqICBSZXR1cm5zOgogICAgICogICAgVGhlIHN0YW56YSB0aGF0IHdhcyBwYXNzZWQuCiAgICAgKi8KICAgIF9yZXFUb0RhdGE6IGZ1bmN0aW9uIChzdGFuemEpCiAgICB7CiAgICAgICAgcmV0dXJuIHN0YW56YTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX3NlbmQKICAgICAqICBfUHJpdmF0ZV8gcGFydCBvZiB0aGUgQ29ubmVjdGlvbi5zZW5kIGZ1bmN0aW9uIGZvciBXZWJTb2NrZXQKICAgICAqCiAgICAgKiBKdXN0IGZsdXNoZXMgdGhlIG1lc3NhZ2VzIHRoYXQgYXJlIGluIHRoZSBxdWV1ZQogICAgICovCiAgICBfc2VuZDogZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMuX2Nvbm4uZmx1c2goKTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX3NlbmRSZXN0YXJ0CiAgICAgKgogICAgICogIFNlbmQgYW4geG1wcDpyZXN0YXJ0IHN0YW56YS4KICAgICAqLwogICAgX3NlbmRSZXN0YXJ0OiBmdW5jdGlvbiAoKQogICAgewogICAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9jb25uLl9pZGxlVGltZW91dCk7CiAgICAgICAgdGhpcy5fY29ubi5fb25JZGxlLmJpbmQodGhpcy5fY29ubikoKTsKICAgIH0KfTsKCmRlZmluZSgic3Ryb3BoZSIsIChmdW5jdGlvbiAoZ2xvYmFsKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciByZXQsIGZuOwogICAgICAgIHJldHVybiByZXQgfHwgZ2xvYmFsLlN0cm9waGU7CiAgICB9Owp9KHRoaXMpKSk7CgovLyBHZW5lcmF0ZWQgYnkgQ29mZmVlU2NyaXB0IDEuOC4wCgovKgogKlBsdWdpbiB0byBpbXBsZW1lbnQgdGhlIE1VQyBleHRlbnNpb24uCiAgIGh0dHA6Ly94bXBwLm9yZy9leHRlbnNpb25zL3hlcC0wMDQ1Lmh0bWwKICpQcmV2aW91cyBBdXRob3I6CiAgICBOYXRoYW4gWm9ybiA8bmF0aGFuLnpvcm5AZ21haWwuY29tPgogKkNvbXBsZXRlIENvZmZlZVNjcmlwdCByZXdyaXRlOgogICAgQW5kcmVhcyBHdXRoIDxndXRoQGRiaXMucnd0aC1hYWNoZW4uZGU+CiAqLwoKKGZ1bmN0aW9uKCkgewogIHZhciBPY2N1cGFudCwgUm9vbUNvbmZpZywgWG1wcFJvb20sCiAgICBfX2hhc1Byb3AgPSB7fS5oYXNPd25Qcm9wZXJ0eSwKICAgIF9fYmluZCA9IGZ1bmN0aW9uKGZuLCBtZSl7IHJldHVybiBmdW5jdGlvbigpeyByZXR1cm4gZm4uYXBwbHkobWUsIGFyZ3VtZW50cyk7IH07IH07CgogIFN0cm9waGUuYWRkQ29ubmVjdGlvblBsdWdpbignbXVjJywgewogICAgX2Nvbm5lY3Rpb246IG51bGwsCiAgICByb29tczoge30sCiAgICByb29tTmFtZXM6IFtdLAoKICAgIC8qRnVuY3Rpb24KICAgIEluaXRpYWxpemUgdGhlIE1VQyBwbHVnaW4uIFNldHMgdGhlIGNvcnJlY3QgY29ubmVjdGlvbiBvYmplY3QgYW5kCiAgICBleHRlbmRzIHRoZSBuYW1lc2FjZS4KICAgICAqLwogICAgaW5pdDogZnVuY3Rpb24oY29ubikgewogICAgICB0aGlzLl9jb25uZWN0aW9uID0gY29ubjsKICAgICAgdGhpcy5fbXVjX2hhbmRsZXIgPSBudWxsOwogICAgICBTdHJvcGhlLmFkZE5hbWVzcGFjZSgnTVVDX09XTkVSJywgU3Ryb3BoZS5OUy5NVUMgKyAiI293bmVyIik7CiAgICAgIFN0cm9waGUuYWRkTmFtZXNwYWNlKCdNVUNfQURNSU4nLCBTdHJvcGhlLk5TLk1VQyArICIjYWRtaW4iKTsKICAgICAgU3Ryb3BoZS5hZGROYW1lc3BhY2UoJ01VQ19VU0VSJywgU3Ryb3BoZS5OUy5NVUMgKyAiI3VzZXIiKTsKICAgICAgU3Ryb3BoZS5hZGROYW1lc3BhY2UoJ01VQ19ST09NQ09ORicsIFN0cm9waGUuTlMuTVVDICsgIiNyb29tY29uZmlnIik7CiAgICAgIHJldHVybiBTdHJvcGhlLmFkZE5hbWVzcGFjZSgnTVVDX1JFR0lTVEVSJywgImphYmJlcjppcTpyZWdpc3RlciIpOwogICAgfSwKCiAgICAvKkZ1bmN0aW9uCiAgICBKb2luIGEgbXVsdGktdXNlciBjaGF0IHJvb20KICAgIFBhcmFtZXRlcnM6CiAgICAoU3RyaW5nKSByb29tIC0gVGhlIG11bHRpLXVzZXIgY2hhdCByb29tIHRvIGpvaW4uCiAgICAoU3RyaW5nKSBuaWNrIC0gVGhlIG5pY2tuYW1lIHRvIHVzZSBpbiB0aGUgY2hhdCByb29tLiBPcHRpb25hbAogICAgKEZ1bmN0aW9uKSBtc2dfaGFuZGxlcl9jYiAtIFRoZSBmdW5jdGlvbiBjYWxsIHRvIGhhbmRsZSBtZXNzYWdlcyBmcm9tIHRoZQogICAgc3BlY2lmaWVkIGNoYXQgcm9vbS4KICAgIChGdW5jdGlvbikgcHJlc19oYW5kbGVyX2NiIC0gVGhlIGZ1bmN0aW9uIGNhbGwgYmFjayB0byBoYW5kbGUgcHJlc2VuY2UKICAgIGluIHRoZSBjaGF0IHJvb20uCiAgICAoRnVuY3Rpb24pIHJvc3Rlcl9jYiAtIFRoZSBmdW5jdGlvbiBjYWxsIHRvIGhhbmRsZSByb3N0ZXIgaW5mbyBpbiB0aGUgY2hhdCByb29tCiAgICAoU3RyaW5nKSBwYXNzd29yZCAtIFRoZSBvcHRpb25hbCBwYXNzd29yZCB0byB1c2UuIChwYXNzd29yZCBwcm90ZWN0ZWQKICAgIHJvb21zIG9ubHkpCiAgICAoT2JqZWN0KSBoaXN0b3J5X2F0dHJzIC0gT3B0aW9uYWwgYXR0cmlidXRlcyBmb3IgcmV0cmlldmluZyBoaXN0b3J5CiAgICAoWE1MIERPTSBFbGVtZW50KSBleHRlbmRlZF9wcmVzZW5jZSAtIE9wdGlvbmFsIFhNTCBmb3IgZXh0ZW5kaW5nIHByZXNlbmNlCiAgICAgKi8KICAgIGpvaW46IGZ1bmN0aW9uKHJvb20sIG5pY2ssIG1zZ19oYW5kbGVyX2NiLCBwcmVzX2hhbmRsZXJfY2IsIHJvc3Rlcl9jYiwgcGFzc3dvcmQsIGhpc3RvcnlfYXR0cnMpIHsKICAgICAgdmFyIG1zZywgcm9vbV9uaWNrOwogICAgICByb29tX25pY2sgPSB0aGlzLnRlc3RfYXBwZW5kX25pY2socm9vbSwgbmljayk7CiAgICAgIG1zZyA9ICRwcmVzKHsKICAgICAgICBmcm9tOiB0aGlzLl9jb25uZWN0aW9uLmppZCwKICAgICAgICB0bzogcm9vbV9uaWNrCiAgICAgIH0pLmMoIngiLCB7CiAgICAgICAgeG1sbnM6IFN0cm9waGUuTlMuTVVDCiAgICAgIH0pOwogICAgICBpZiAoaGlzdG9yeV9hdHRycyAhPSBudWxsKSB7CiAgICAgICAgbXNnID0gbXNnLmMoImhpc3RvcnkiLCBoaXN0b3J5X2F0dHJzKS51cCgpOwogICAgICB9CiAgICAgIGlmIChwYXNzd29yZCAhPSBudWxsKSB7CiAgICAgICAgbXNnLmNub2RlKFN0cm9waGUueG1sRWxlbWVudCgicGFzc3dvcmQiLCBbXSwgcGFzc3dvcmQpKTsKICAgICAgfQogICAgICBpZiAodHlwZW9mIGV4dGVuZGVkX3ByZXNlbmNlICE9PSAidW5kZWZpbmVkIiAmJiBleHRlbmRlZF9wcmVzZW5jZSAhPT0gbnVsbCkgewogICAgICAgIG1zZy51cC5jbm9kZShleHRlbmRlZF9wcmVzZW5jZSk7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuX211Y19oYW5kbGVyID09IG51bGwpIHsKICAgICAgICB0aGlzLl9tdWNfaGFuZGxlciA9IHRoaXMuX2Nvbm5lY3Rpb24uYWRkSGFuZGxlcigoZnVuY3Rpb24oX3RoaXMpIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbihzdGFuemEpIHsKICAgICAgICAgICAgdmFyIGZyb20sIGhhbmRsZXIsIGhhbmRsZXJzLCBpZCwgcm9vbW5hbWUsIHgsIHhtbG5zLCB4cXVlcnksIF9pLCBfbGVuOwogICAgICAgICAgICBmcm9tID0gc3RhbnphLmdldEF0dHJpYnV0ZSgnZnJvbScpOwogICAgICAgICAgICBpZiAoIWZyb20pIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByb29tbmFtZSA9IGZyb20uc3BsaXQoIi8iKVswXTsKICAgICAgICAgICAgaWYgKCFfdGhpcy5yb29tc1tyb29tbmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByb29tID0gX3RoaXMucm9vbXNbcm9vbW5hbWVdOwogICAgICAgICAgICBoYW5kbGVycyA9IHt9OwogICAgICAgICAgICBpZiAoc3RhbnphLm5vZGVOYW1lID09PSAibWVzc2FnZSIpIHsKICAgICAgICAgICAgICBoYW5kbGVycyA9IHJvb20uX21lc3NhZ2VfaGFuZGxlcnM7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhbnphLm5vZGVOYW1lID09PSAicHJlc2VuY2UiKSB7CiAgICAgICAgICAgICAgeHF1ZXJ5ID0gc3RhbnphLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJ4Iik7CiAgICAgICAgICAgICAgaWYgKHhxdWVyeS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IHhxdWVyeS5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICAgICAgICAgICAgICB4ID0geHF1ZXJ5W19pXTsKICAgICAgICAgICAgICAgICAgeG1sbnMgPSB4LmdldEF0dHJpYnV0ZSgieG1sbnMiKTsKICAgICAgICAgICAgICAgICAgaWYgKHhtbG5zICYmIHhtbG5zLm1hdGNoKFN0cm9waGUuTlMuTVVDKSkgewogICAgICAgICAgICAgICAgICAgIGhhbmRsZXJzID0gcm9vbS5fcHJlc2VuY2VfaGFuZGxlcnM7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChpZCBpbiBoYW5kbGVycykgewogICAgICAgICAgICAgIGhhbmRsZXIgPSBoYW5kbGVyc1tpZF07CiAgICAgICAgICAgICAgaWYgKCFoYW5kbGVyKHN0YW56YSwgcm9vbSkpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBoYW5kbGVyc1tpZF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfTsKICAgICAgICB9KSh0aGlzKSk7CiAgICAgIH0KICAgICAgaWYgKCF0aGlzLnJvb21zLmhhc093blByb3BlcnR5KHJvb20pKSB7CiAgICAgICAgdGhpcy5yb29tc1tyb29tXSA9IG5ldyBYbXBwUm9vbSh0aGlzLCByb29tLCBuaWNrLCBwYXNzd29yZCk7CiAgICAgICAgdGhpcy5yb29tTmFtZXMucHVzaChyb29tKTsKICAgICAgfQogICAgICBpZiAocHJlc19oYW5kbGVyX2NiKSB7CiAgICAgICAgdGhpcy5yb29tc1tyb29tXS5hZGRIYW5kbGVyKCdwcmVzZW5jZScsIHByZXNfaGFuZGxlcl9jYik7CiAgICAgIH0KICAgICAgaWYgKG1zZ19oYW5kbGVyX2NiKSB7CiAgICAgICAgdGhpcy5yb29tc1tyb29tXS5hZGRIYW5kbGVyKCdtZXNzYWdlJywgbXNnX2hhbmRsZXJfY2IpOwogICAgICB9CiAgICAgIGlmIChyb3N0ZXJfY2IpIHsKICAgICAgICB0aGlzLnJvb21zW3Jvb21dLmFkZEhhbmRsZXIoJ3Jvc3RlcicsIHJvc3Rlcl9jYik7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZChtc2cpOwogICAgfSwKCiAgICAvKkZ1bmN0aW9uCiAgICBMZWF2ZSBhIG11bHRpLXVzZXIgY2hhdCByb29tCiAgICBQYXJhbWV0ZXJzOgogICAgKFN0cmluZykgcm9vbSAtIFRoZSBtdWx0aS11c2VyIGNoYXQgcm9vbSB0byBsZWF2ZS4KICAgIChTdHJpbmcpIG5pY2sgLSBUaGUgbmljayBuYW1lIHVzZWQgaW4gdGhlIHJvb20uCiAgICAoRnVuY3Rpb24pIGhhbmRsZXJfY2IgLSBPcHRpb25hbCBmdW5jdGlvbiB0byBoYW5kbGUgdGhlIHN1Y2Nlc3NmdWwgbGVhdmUuCiAgICAoU3RyaW5nKSBleGl0X21zZyAtIG9wdGlvbmFsIGV4aXQgbWVzc2FnZS4KICAgIFJldHVybnM6CiAgICBpcWlkIC0gVGhlIHVuaXF1ZSBpZCBmb3IgdGhlIHJvb20gbGVhdmUuCiAgICAgKi8KICAgIGxlYXZlOiBmdW5jdGlvbihyb29tLCBuaWNrLCBoYW5kbGVyX2NiLCBleGl0X21zZykgewogICAgICB2YXIgaWQsIHByZXNlbmNlLCBwcmVzZW5jZWlkLCByb29tX25pY2s7CiAgICAgIGlkID0gdGhpcy5yb29tTmFtZXMuaW5kZXhPZihyb29tKTsKICAgICAgZGVsZXRlIHRoaXMucm9vbXNbcm9vbV07CiAgICAgIGlmIChpZCA+PSAwKSB7CiAgICAgICAgdGhpcy5yb29tTmFtZXMuc3BsaWNlKGlkLCAxKTsKICAgICAgICBpZiAodGhpcy5yb29tTmFtZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICB0aGlzLl9jb25uZWN0aW9uLmRlbGV0ZUhhbmRsZXIodGhpcy5fbXVjX2hhbmRsZXIpOwogICAgICAgICAgdGhpcy5fbXVjX2hhbmRsZXIgPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgICByb29tX25pY2sgPSB0aGlzLnRlc3RfYXBwZW5kX25pY2socm9vbSwgbmljayk7CiAgICAgIHByZXNlbmNlaWQgPSB0aGlzLl9jb25uZWN0aW9uLmdldFVuaXF1ZUlkKCk7CiAgICAgIHByZXNlbmNlID0gJHByZXMoewogICAgICAgIHR5cGU6ICJ1bmF2YWlsYWJsZSIsCiAgICAgICAgaWQ6IHByZXNlbmNlaWQsCiAgICAgICAgZnJvbTogdGhpcy5fY29ubmVjdGlvbi5qaWQsCiAgICAgICAgdG86IHJvb21fbmljawogICAgICB9KTsKICAgICAgaWYgKGV4aXRfbXNnICE9IG51bGwpIHsKICAgICAgICBwcmVzZW5jZS5jKCJzdGF0dXMiLCBleGl0X21zZyk7CiAgICAgIH0KICAgICAgaWYgKGhhbmRsZXJfY2IgIT0gbnVsbCkgewogICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24uYWRkSGFuZGxlcihoYW5kbGVyX2NiLCBudWxsLCAicHJlc2VuY2UiLCBudWxsLCBwcmVzZW5jZWlkKTsKICAgICAgfQogICAgICB0aGlzLl9jb25uZWN0aW9uLnNlbmQocHJlc2VuY2UpOwogICAgICByZXR1cm4gcHJlc2VuY2VpZDsKICAgIH0sCgogICAgLypGdW5jdGlvbgogICAgUGFyYW1ldGVyczoKICAgIChTdHJpbmcpIHJvb20gLSBUaGUgbXVsdGktdXNlciBjaGF0IHJvb20gbmFtZS4KICAgIChTdHJpbmcpIG5pY2sgLSBUaGUgbmljayBuYW1lIHVzZWQgaW4gdGhlIGNoYXQgcm9vbS4KICAgIChTdHJpbmcpIG1lc3NhZ2UgLSBUaGUgcGxhaW50ZXh0IG1lc3NhZ2UgdG8gc2VuZCB0byB0aGUgcm9vbS4KICAgIChTdHJpbmcpIGh0bWxfbWVzc2FnZSAtIFRoZSBtZXNzYWdlIHRvIHNlbmQgdG8gdGhlIHJvb20gd2l0aCBodG1sIG1hcmt1cC4KICAgIChTdHJpbmcpIHR5cGUgLSAiZ3JvdXBjaGF0IiBmb3IgZ3JvdXAgY2hhdCBtZXNzYWdlcyBvCiAgICAgICAgICAgICAgICAgICAgImNoYXQiIGZvciBwcml2YXRlIGNoYXQgbWVzc2FnZXMKICAgIFJldHVybnM6CiAgICBtc2dpcSAtIHRoZSB1bmlxdWUgaWQgdXNlZCB0byBzZW5kIHRoZSBtZXNzYWdlCiAgICAgKi8KICAgIG1lc3NhZ2U6IGZ1bmN0aW9uKHJvb20sIG5pY2ssIG1lc3NhZ2UsIGh0bWxfbWVzc2FnZSwgdHlwZSwgbXNnaWQpIHsKICAgICAgdmFyIG1zZywgcGFyZW50LCByb29tX25pY2s7CiAgICAgIHJvb21fbmljayA9IHRoaXMudGVzdF9hcHBlbmRfbmljayhyb29tLCBuaWNrKTsKICAgICAgdHlwZSA9IHR5cGUgfHwgKG5pY2sgIT0gbnVsbCA/ICJjaGF0IiA6ICJncm91cGNoYXQiKTsKICAgICAgbXNnaWQgPSBtc2dpZCB8fCB0aGlzLl9jb25uZWN0aW9uLmdldFVuaXF1ZUlkKCk7CiAgICAgIG1zZyA9ICRtc2coewogICAgICAgIHRvOiByb29tX25pY2ssCiAgICAgICAgZnJvbTogdGhpcy5fY29ubmVjdGlvbi5qaWQsCiAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICBpZDogbXNnaWQKICAgICAgfSkuYygiYm9keSIsIHsKICAgICAgICB4bWxuczogU3Ryb3BoZS5OUy5DTElFTlQKICAgICAgfSkudChtZXNzYWdlKTsKICAgICAgbXNnLnVwKCk7CiAgICAgIGlmIChodG1sX21lc3NhZ2UgIT0gbnVsbCkgewogICAgICAgIG1zZy5jKCJodG1sIiwgewogICAgICAgICAgeG1sbnM6IFN0cm9waGUuTlMuWEhUTUxfSU0KICAgICAgICB9KS5jKCJib2R5IiwgewogICAgICAgICAgeG1sbnM6IFN0cm9waGUuTlMuWEhUTUwKICAgICAgICB9KS5oKGh0bWxfbWVzc2FnZSk7CiAgICAgICAgaWYgKG1zZy5ub2RlLmNoaWxkTm9kZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICBwYXJlbnQgPSBtc2cubm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgbXNnLnVwKCkudXAoKTsKICAgICAgICAgIG1zZy5ub2RlLnJlbW92ZUNoaWxkKHBhcmVudCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG1zZy51cCgpLnVwKCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIG1zZy5jKCJ4IiwgewogICAgICAgIHhtbG5zOiAiamFiYmVyOng6ZXZlbnQiCiAgICAgIH0pLmMoImNvbXBvc2luZyIpOwogICAgICB0aGlzLl9jb25uZWN0aW9uLnNlbmQobXNnKTsKICAgICAgcmV0dXJuIG1zZ2lkOwogICAgfSwKCiAgICAvKkZ1bmN0aW9uCiAgICBDb252ZW5pZW5jZSBGdW5jdGlvbiB0byBzZW5kIGEgTWVzc2FnZSB0byBhbGwgT2NjdXBhbnRzCiAgICBQYXJhbWV0ZXJzOgogICAgKFN0cmluZykgcm9vbSAtIFRoZSBtdWx0aS11c2VyIGNoYXQgcm9vbSBuYW1lLgogICAgKFN0cmluZykgbWVzc2FnZSAtIFRoZSBwbGFpbnRleHQgbWVzc2FnZSB0byBzZW5kIHRvIHRoZSByb29tLgogICAgKFN0cmluZykgaHRtbF9tZXNzYWdlIC0gVGhlIG1lc3NhZ2UgdG8gc2VuZCB0byB0aGUgcm9vbSB3aXRoIGh0bWwgbWFya3VwLgogICAgKFN0cmluZykgbXNnaWQgLSBPcHRpb25hbCB1bmlxdWUgSUQgd2hpY2ggd2lsbCBiZSBzZXQgYXMgdGhlICdpZCcgYXR0cmlidXRlIG9mIHRoZSBzdGFuemEKICAgIFJldHVybnM6CiAgICBtc2dpcSAtIHRoZSB1bmlxdWUgaWQgdXNlZCB0byBzZW5kIHRoZSBtZXNzYWdlCiAgICAgKi8KICAgIGdyb3VwY2hhdDogZnVuY3Rpb24ocm9vbSwgbWVzc2FnZSwgaHRtbF9tZXNzYWdlLCBtc2dpZCkgewogICAgICByZXR1cm4gdGhpcy5tZXNzYWdlKHJvb20sIG51bGwsIG1lc3NhZ2UsIGh0bWxfbWVzc2FnZSwgdm9pZCAwLCBtc2dpZCk7CiAgICB9LAoKICAgIC8qRnVuY3Rpb24KICAgIFNlbmQgYSBtZWRpYXRlZCBpbnZpdGF0aW9uLgogICAgUGFyYW1ldGVyczoKICAgIChTdHJpbmcpIHJvb20gLSBUaGUgbXVsdGktdXNlciBjaGF0IHJvb20gbmFtZS4KICAgIChTdHJpbmcpIHJlY2VpdmVyIC0gVGhlIGludml0YXRpb24ncyByZWNlaXZlci4KICAgIChTdHJpbmcpIHJlYXNvbiAtIE9wdGlvbmFsIHJlYXNvbiBmb3Igam9pbmluZyB0aGUgcm9vbS4KICAgIFJldHVybnM6CiAgICBtc2dpcSAtIHRoZSB1bmlxdWUgaWQgdXNlZCB0byBzZW5kIHRoZSBpbnZpdGF0aW9uCiAgICAgKi8KICAgIGludml0ZTogZnVuY3Rpb24ocm9vbSwgcmVjZWl2ZXIsIHJlYXNvbikgewogICAgICB2YXIgaW52aXRhdGlvbiwgbXNnaWQ7CiAgICAgIG1zZ2lkID0gdGhpcy5fY29ubmVjdGlvbi5nZXRVbmlxdWVJZCgpOwogICAgICBpbnZpdGF0aW9uID0gJG1zZyh7CiAgICAgICAgZnJvbTogdGhpcy5fY29ubmVjdGlvbi5qaWQsCiAgICAgICAgdG86IHJvb20sCiAgICAgICAgaWQ6IG1zZ2lkCiAgICAgIH0pLmMoJ3gnLCB7CiAgICAgICAgeG1sbnM6IFN0cm9waGUuTlMuTVVDX1VTRVIKICAgICAgfSkuYygnaW52aXRlJywgewogICAgICAgIHRvOiByZWNlaXZlcgogICAgICB9KTsKICAgICAgaWYgKHJlYXNvbiAhPSBudWxsKSB7CiAgICAgICAgaW52aXRhdGlvbi5jKCdyZWFzb24nLCByZWFzb24pOwogICAgICB9CiAgICAgIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZChpbnZpdGF0aW9uKTsKICAgICAgcmV0dXJuIG1zZ2lkOwogICAgfSwKCiAgICAvKkZ1bmN0aW9uCiAgICBTZW5kIGEgbWVkaWF0ZWQgbXVsdGlwbGUgaW52aXRhdGlvbi4KICAgIFBhcmFtZXRlcnM6CiAgICAoU3RyaW5nKSByb29tIC0gVGhlIG11bHRpLXVzZXIgY2hhdCByb29tIG5hbWUuCiAgICAoQXJyYXkpIHJlY2VpdmVycyAtIFRoZSBpbnZpdGF0aW9uJ3MgcmVjZWl2ZXJzLgogICAgKFN0cmluZykgcmVhc29uIC0gT3B0aW9uYWwgcmVhc29uIGZvciBqb2luaW5nIHRoZSByb29tLgogICAgUmV0dXJuczoKICAgIG1zZ2lxIC0gdGhlIHVuaXF1ZSBpZCB1c2VkIHRvIHNlbmQgdGhlIGludml0YXRpb24KICAgICAqLwogICAgbXVsdGlwbGVJbnZpdGVzOiBmdW5jdGlvbihyb29tLCByZWNlaXZlcnMsIHJlYXNvbikgewogICAgICB2YXIgaW52aXRhdGlvbiwgbXNnaWQsIHJlY2VpdmVyLCBfaSwgX2xlbjsKICAgICAgbXNnaWQgPSB0aGlzLl9jb25uZWN0aW9uLmdldFVuaXF1ZUlkKCk7CiAgICAgIGludml0YXRpb24gPSAkbXNnKHsKICAgICAgICBmcm9tOiB0aGlzLl9jb25uZWN0aW9uLmppZCwKICAgICAgICB0bzogcm9vbSwKICAgICAgICBpZDogbXNnaWQKICAgICAgfSkuYygneCcsIHsKICAgICAgICB4bWxuczogU3Ryb3BoZS5OUy5NVUNfVVNFUgogICAgICB9KTsKICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSByZWNlaXZlcnMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICByZWNlaXZlciA9IHJlY2VpdmVyc1tfaV07CiAgICAgICAgaW52aXRhdGlvbi5jKCdpbnZpdGUnLCB7CiAgICAgICAgICB0bzogcmVjZWl2ZXIKICAgICAgICB9KTsKICAgICAgICBpZiAocmVhc29uICE9IG51bGwpIHsKICAgICAgICAgIGludml0YXRpb24uYygncmVhc29uJywgcmVhc29uKTsKICAgICAgICAgIGludml0YXRpb24udXAoKTsKICAgICAgICB9CiAgICAgICAgaW52aXRhdGlvbi51cCgpOwogICAgICB9CiAgICAgIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZChpbnZpdGF0aW9uKTsKICAgICAgcmV0dXJuIG1zZ2lkOwogICAgfSwKCiAgICAvKkZ1bmN0aW9uCiAgICBTZW5kIGEgZGlyZWN0IGludml0YXRpb24uCiAgICBQYXJhbWV0ZXJzOgogICAgKFN0cmluZykgcm9vbSAtIFRoZSBtdWx0aS11c2VyIGNoYXQgcm9vbSBuYW1lLgogICAgKFN0cmluZykgcmVjZWl2ZXIgLSBUaGUgaW52aXRhdGlvbidzIHJlY2VpdmVyLgogICAgKFN0cmluZykgcmVhc29uIC0gT3B0aW9uYWwgcmVhc29uIGZvciBqb2luaW5nIHRoZSByb29tLgogICAgKFN0cmluZykgcGFzc3dvcmQgLSBPcHRpb25hbCBwYXNzd29yZCBmb3IgdGhlIHJvb20uCiAgICBSZXR1cm5zOgogICAgbXNnaXEgLSB0aGUgdW5pcXVlIGlkIHVzZWQgdG8gc2VuZCB0aGUgaW52aXRhdGlvbgogICAgICovCiAgICBkaXJlY3RJbnZpdGU6IGZ1bmN0aW9uKHJvb20sIHJlY2VpdmVyLCByZWFzb24sIHBhc3N3b3JkKSB7CiAgICAgIHZhciBhdHRycywgaW52aXRhdGlvbiwgbXNnaWQ7CiAgICAgIG1zZ2lkID0gdGhpcy5fY29ubmVjdGlvbi5nZXRVbmlxdWVJZCgpOwogICAgICBhdHRycyA9IHsKICAgICAgICB4bWxuczogJ2phYmJlcjp4OmNvbmZlcmVuY2UnLAogICAgICAgIGppZDogcm9vbQogICAgICB9OwogICAgICBpZiAocmVhc29uICE9IG51bGwpIHsKICAgICAgICBhdHRycy5yZWFzb24gPSByZWFzb247CiAgICAgIH0KICAgICAgaWYgKHBhc3N3b3JkICE9IG51bGwpIHsKICAgICAgICBhdHRycy5wYXNzd29yZCA9IHBhc3N3b3JkOwogICAgICB9CiAgICAgIGludml0YXRpb24gPSAkbXNnKHsKICAgICAgICBmcm9tOiB0aGlzLl9jb25uZWN0aW9uLmppZCwKICAgICAgICB0bzogcmVjZWl2ZXIsCiAgICAgICAgaWQ6IG1zZ2lkCiAgICAgIH0pLmMoJ3gnLCBhdHRycyk7CiAgICAgIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZChpbnZpdGF0aW9uKTsKICAgICAgcmV0dXJuIG1zZ2lkOwogICAgfSwKCiAgICAvKkZ1bmN0aW9uCiAgICBRdWVyaWVzIGEgcm9vbSBmb3IgYSBsaXN0IG9mIG9jY3VwYW50cwogICAgKFN0cmluZykgcm9vbSAtIFRoZSBtdWx0aS11c2VyIGNoYXQgcm9vbSBuYW1lLgogICAgKEZ1bmN0aW9uKSBzdWNjZXNzX2NiIC0gT3B0aW9uYWwgZnVuY3Rpb24gdG8gaGFuZGxlIHRoZSBpbmZvLgogICAgKEZ1bmN0aW9uKSBlcnJvcl9jYiAtIE9wdGlvbmFsIGZ1bmN0aW9uIHRvIGhhbmRsZSBhbiBlcnJvci4KICAgIFJldHVybnM6CiAgICBpZCAtIHRoZSB1bmlxdWUgaWQgdXNlZCB0byBzZW5kIHRoZSBpbmZvIHJlcXVlc3QKICAgICAqLwogICAgcXVlcnlPY2N1cGFudHM6IGZ1bmN0aW9uKHJvb20sIHN1Y2Nlc3NfY2IsIGVycm9yX2NiKSB7CiAgICAgIHZhciBhdHRycywgaW5mbzsKICAgICAgYXR0cnMgPSB7CiAgICAgICAgeG1sbnM6IFN0cm9waGUuTlMuRElTQ09fSVRFTVMKICAgICAgfTsKICAgICAgaW5mbyA9ICRpcSh7CiAgICAgICAgZnJvbTogdGhpcy5fY29ubmVjdGlvbi5qaWQsCiAgICAgICAgdG86IHJvb20sCiAgICAgICAgdHlwZTogJ2dldCcKICAgICAgfSkuYygncXVlcnknLCBhdHRycyk7CiAgICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW9uLnNlbmRJUShpbmZvLCBzdWNjZXNzX2NiLCBlcnJvcl9jYik7CiAgICB9LAoKICAgIC8qRnVuY3Rpb24KICAgIFN0YXJ0IGEgcm9vbSBjb25maWd1cmF0aW9uLgogICAgUGFyYW1ldGVyczoKICAgIChTdHJpbmcpIHJvb20gLSBUaGUgbXVsdGktdXNlciBjaGF0IHJvb20gbmFtZS4KICAgIChGdW5jdGlvbikgaGFuZGxlcl9jYiAtIE9wdGlvbmFsIGZ1bmN0aW9uIHRvIGhhbmRsZSB0aGUgY29uZmlnIGZvcm0uCiAgICBSZXR1cm5zOgogICAgaWQgLSB0aGUgdW5pcXVlIGlkIHVzZWQgdG8gc2VuZCB0aGUgY29uZmlndXJhdGlvbiByZXF1ZXN0CiAgICAgKi8KICAgIGNvbmZpZ3VyZTogZnVuY3Rpb24ocm9vbSwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgdmFyIGNvbmZpZywgc3RhbnphOwogICAgICBjb25maWcgPSAkaXEoewogICAgICAgIHRvOiByb29tLAogICAgICAgIHR5cGU6ICJnZXQiCiAgICAgIH0pLmMoInF1ZXJ5IiwgewogICAgICAgIHhtbG5zOiBTdHJvcGhlLk5TLk1VQ19PV05FUgogICAgICB9KTsKICAgICAgc3RhbnphID0gY29uZmlnLnRyZWUoKTsKICAgICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZElRKHN0YW56YSwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfSwKCiAgICAvKkZ1bmN0aW9uCiAgICBDYW5jZWwgdGhlIHJvb20gY29uZmlndXJhdGlvbgogICAgUGFyYW1ldGVyczoKICAgIChTdHJpbmcpIHJvb20gLSBUaGUgbXVsdGktdXNlciBjaGF0IHJvb20gbmFtZS4KICAgIFJldHVybnM6CiAgICBpZCAtIHRoZSB1bmlxdWUgaWQgdXNlZCB0byBjYW5jZWwgdGhlIGNvbmZpZ3VyYXRpb24uCiAgICAgKi8KICAgIGNhbmNlbENvbmZpZ3VyZTogZnVuY3Rpb24ocm9vbSkgewogICAgICB2YXIgY29uZmlnLCBzdGFuemE7CiAgICAgIGNvbmZpZyA9ICRpcSh7CiAgICAgICAgdG86IHJvb20sCiAgICAgICAgdHlwZTogInNldCIKICAgICAgfSkuYygicXVlcnkiLCB7CiAgICAgICAgeG1sbnM6IFN0cm9waGUuTlMuTVVDX09XTkVSCiAgICAgIH0pLmMoIngiLCB7CiAgICAgICAgeG1sbnM6ICJqYWJiZXI6eDpkYXRhIiwKICAgICAgICB0eXBlOiAiY2FuY2VsIgogICAgICB9KTsKICAgICAgc3RhbnphID0gY29uZmlnLnRyZWUoKTsKICAgICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZElRKHN0YW56YSk7CiAgICB9LAoKICAgIC8qRnVuY3Rpb24KICAgIFNhdmUgYSByb29tIGNvbmZpZ3VyYXRpb24uCiAgICBQYXJhbWV0ZXJzOgogICAgKFN0cmluZykgcm9vbSAtIFRoZSBtdWx0aS11c2VyIGNoYXQgcm9vbSBuYW1lLgogICAgKEFycmF5KSBjb25maWctIEZvcm0gT2JqZWN0IG9yIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMgdXNlZCB0byBjb25maWd1cmUgdGhlIHJvb20uCiAgICBSZXR1cm5zOgogICAgaWQgLSB0aGUgdW5pcXVlIGlkIHVzZWQgdG8gc2F2ZSB0aGUgY29uZmlndXJhdGlvbi4KICAgICAqLwogICAgc2F2ZUNvbmZpZ3VyYXRpb246IGZ1bmN0aW9uKHJvb20sIGNvbmZpZywgc3VjY2Vzc19jYiwgZXJyb3JfY2IpIHsKICAgICAgdmFyIGNvbmYsIGlxLCBzdGFuemEsIF9pLCBfbGVuOwogICAgICBpcSA9ICRpcSh7CiAgICAgICAgdG86IHJvb20sCiAgICAgICAgdHlwZTogInNldCIKICAgICAgfSkuYygicXVlcnkiLCB7CiAgICAgICAgeG1sbnM6IFN0cm9waGUuTlMuTVVDX09XTkVSCiAgICAgIH0pOwogICAgICBpZiAodHlwZW9mIEZvcm0gIT09ICJ1bmRlZmluZWQiICYmIGNvbmZpZyBpbnN0YW5jZW9mIEZvcm0pIHsKICAgICAgICBjb25maWcudHlwZSA9ICJzdWJtaXQiOwogICAgICAgIGlxLmNub2RlKGNvbmZpZy50b1hNTCgpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpcS5jKCJ4IiwgewogICAgICAgICAgeG1sbnM6ICJqYWJiZXI6eDpkYXRhIiwKICAgICAgICAgIHR5cGU6ICJzdWJtaXQiCiAgICAgICAgfSk7CiAgICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBjb25maWcubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICAgIGNvbmYgPSBjb25maWdbX2ldOwogICAgICAgICAgaXEuY25vZGUoY29uZikudXAoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgc3RhbnphID0gaXEudHJlZSgpOwogICAgICByZXR1cm4gdGhpcy5fY29ubmVjdGlvbi5zZW5kSVEoc3RhbnphLCBzdWNjZXNzX2NiLCBlcnJvcl9jYik7CiAgICB9LAoKICAgIC8qRnVuY3Rpb24KICAgIFBhcmFtZXRlcnM6CiAgICAoU3RyaW5nKSByb29tIC0gVGhlIG11bHRpLXVzZXIgY2hhdCByb29tIG5hbWUuCiAgICBSZXR1cm5zOgogICAgaWQgLSB0aGUgdW5pcXVlIGlkIHVzZWQgdG8gY3JlYXRlIHRoZSBjaGF0IHJvb20uCiAgICAgKi8KICAgIGNyZWF0ZUluc3RhbnRSb29tOiBmdW5jdGlvbihyb29tLCBzdWNjZXNzX2NiLCBlcnJvcl9jYikgewogICAgICB2YXIgcm9vbWlxOwogICAgICByb29taXEgPSAkaXEoewogICAgICAgIHRvOiByb29tLAogICAgICAgIHR5cGU6ICJzZXQiCiAgICAgIH0pLmMoInF1ZXJ5IiwgewogICAgICAgIHhtbG5zOiBTdHJvcGhlLk5TLk1VQ19PV05FUgogICAgICB9KS5jKCJ4IiwgewogICAgICAgIHhtbG5zOiAiamFiYmVyOng6ZGF0YSIsCiAgICAgICAgdHlwZTogInN1Ym1pdCIKICAgICAgfSk7CiAgICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW9uLnNlbmRJUShyb29taXEudHJlZSgpLCBzdWNjZXNzX2NiLCBlcnJvcl9jYik7CiAgICB9LAoKICAgIC8qRnVuY3Rpb24KICAgIFBhcmFtZXRlcnM6CiAgICAoU3RyaW5nKSByb29tIC0gVGhlIG11bHRpLXVzZXIgY2hhdCByb29tIG5hbWUuCiAgICAoT2JqZWN0KSBjb25maWcgLSB0aGUgY29uZmlndXJhdGlvbi4gZXg6IHsibXVjI3Jvb21jb25maWdfcHVibGljcm9vbSI6ICIwIiwgIm11YyNyb29tY29uZmlnX3BlcnNpc3RlbnRyb29tIjogIjEifQogICAgUmV0dXJuczoKICAgIGlkIC0gdGhlIHVuaXF1ZSBpZCB1c2VkIHRvIGNyZWF0ZSB0aGUgY2hhdCByb29tLgogICAgICovCiAgICBjcmVhdGVDb25maWd1cmVkUm9vbTogZnVuY3Rpb24ocm9vbSwgY29uZmlnLCBzdWNjZXNzX2NiLCBlcnJvcl9jYikgewogICAgICB2YXIgaywgcm9vbWlxLCB2OwogICAgICByb29taXEgPSAkaXEoewogICAgICAgIHRvOiByb29tLAogICAgICAgIHR5cGU6ICJzZXQiCiAgICAgIH0pLmMoInF1ZXJ5IiwgewogICAgICAgIHhtbG5zOiBTdHJvcGhlLk5TLk1VQ19PV05FUgogICAgICB9KS5jKCJ4IiwgewogICAgICAgIHhtbG5zOiAiamFiYmVyOng6ZGF0YSIsCiAgICAgICAgdHlwZTogInN1Ym1pdCIKICAgICAgfSk7CiAgICAgIHJvb21pcS5jKCdmaWVsZCcsIHsKICAgICAgICAndmFyJzogJ0ZPUk1fVFlQRScKICAgICAgfSkuYygndmFsdWUnKS50KCdodHRwOi8vamFiYmVyLm9yZy9wcm90b2NvbC9tdWMjcm9vbWNvbmZpZycpLnVwKCkudXAoKTsKICAgICAgZm9yIChrIGluIGNvbmZpZykgewogICAgICAgIGlmICghX19oYXNQcm9wLmNhbGwoY29uZmlnLCBrKSkgY29udGludWU7CiAgICAgICAgdiA9IGNvbmZpZ1trXTsKICAgICAgICByb29taXEuYygnZmllbGQnLCB7CiAgICAgICAgICAndmFyJzogawogICAgICAgIH0pLmMoJ3ZhbHVlJykudCh2KS51cCgpLnVwKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZElRKHJvb21pcS50cmVlKCksIHN1Y2Nlc3NfY2IsIGVycm9yX2NiKTsKICAgIH0sCgogICAgLypGdW5jdGlvbgogICAgU2V0IHRoZSB0b3BpYyBvZiB0aGUgY2hhdCByb29tLgogICAgUGFyYW1ldGVyczoKICAgIChTdHJpbmcpIHJvb20gLSBUaGUgbXVsdGktdXNlciBjaGF0IHJvb20gbmFtZS4KICAgIChTdHJpbmcpIHRvcGljIC0gVG9waWMgbWVzc2FnZS4KICAgICAqLwogICAgc2V0VG9waWM6IGZ1bmN0aW9uKHJvb20sIHRvcGljKSB7CiAgICAgIHZhciBtc2c7CiAgICAgIG1zZyA9ICRtc2coewogICAgICAgIHRvOiByb29tLAogICAgICAgIGZyb206IHRoaXMuX2Nvbm5lY3Rpb24uamlkLAogICAgICAgIHR5cGU6ICJncm91cGNoYXQiCiAgICAgIH0pLmMoInN1YmplY3QiLCB7CiAgICAgICAgeG1sbnM6ICJqYWJiZXI6Y2xpZW50IgogICAgICB9KS50KHRvcGljKTsKICAgICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZChtc2cudHJlZSgpKTsKICAgIH0sCgogICAgLypGdW5jdGlvbgogICAgSW50ZXJuYWwgRnVuY3Rpb24gdGhhdCBDaGFuZ2VzIHRoZSByb2xlIG9yIGFmZmlsaWF0aW9uIG9mIGEgbWVtYmVyCiAgICBvZiBhIE1VQyByb29tLiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgYnkgbW9kaWZ5Um9sZSBhbmQgbW9kaWZ5QWZmaWxpYXRpb24uCiAgICBUaGUgbW9kaWZpY2F0aW9uIGNhbiBvbmx5IGJlIGRvbmUgYnkgYSByb29tIG1vZGVyYXRvci4gQW4gZXJyb3Igd2lsbCBiZQogICAgcmV0dXJuZWQgaWYgdGhlIHVzZXIgZG9lc24ndCBoYXZlIHBlcm1pc3Npb24uCiAgICBQYXJhbWV0ZXJzOgogICAgKFN0cmluZykgcm9vbSAtIFRoZSBtdWx0aS11c2VyIGNoYXQgcm9vbSBuYW1lLgogICAgKE9iamVjdCkgaXRlbSAtIE9iamVjdCB3aXRoIG5pY2sgYW5kIHJvbGUgb3IgamlkIGFuZCBhZmZpbGlhdGlvbiBhdHRyaWJ1dGUKICAgIChTdHJpbmcpIHJlYXNvbiAtIE9wdGlvbmFsIHJlYXNvbiBmb3IgdGhlIGNoYW5nZS4KICAgIChGdW5jdGlvbikgaGFuZGxlcl9jYiAtIE9wdGlvbmFsIGNhbGxiYWNrIGZvciBzdWNjZXNzCiAgICAoRnVuY3Rpb24pIGVycm9yX2NiIC0gT3B0aW9uYWwgY2FsbGJhY2sgZm9yIGVycm9yCiAgICBSZXR1cm5zOgogICAgaXEgLSB0aGUgaWQgb2YgdGhlIG1vZGUgY2hhbmdlIHJlcXVlc3QuCiAgICAgKi8KICAgIF9tb2RpZnlQcml2aWxlZ2U6IGZ1bmN0aW9uKHJvb20sIGl0ZW0sIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgdmFyIGlxOwogICAgICBpcSA9ICRpcSh7CiAgICAgICAgdG86IHJvb20sCiAgICAgICAgdHlwZTogInNldCIKICAgICAgfSkuYygicXVlcnkiLCB7CiAgICAgICAgeG1sbnM6IFN0cm9waGUuTlMuTVVDX0FETUlOCiAgICAgIH0pLmNub2RlKGl0ZW0ubm9kZSk7CiAgICAgIGlmIChyZWFzb24gIT0gbnVsbCkgewogICAgICAgIGlxLmMoInJlYXNvbiIsIHJlYXNvbik7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZElRKGlxLnRyZWUoKSwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfSwKCiAgICAvKkZ1bmN0aW9uCiAgICBDaGFuZ2VzIHRoZSByb2xlIG9mIGEgbWVtYmVyIG9mIGEgTVVDIHJvb20uCiAgICBUaGUgbW9kaWZpY2F0aW9uIGNhbiBvbmx5IGJlIGRvbmUgYnkgYSByb29tIG1vZGVyYXRvci4gQW4gZXJyb3Igd2lsbCBiZQogICAgcmV0dXJuZWQgaWYgdGhlIHVzZXIgZG9lc24ndCBoYXZlIHBlcm1pc3Npb24uCiAgICBQYXJhbWV0ZXJzOgogICAgKFN0cmluZykgcm9vbSAtIFRoZSBtdWx0aS11c2VyIGNoYXQgcm9vbSBuYW1lLgogICAgKFN0cmluZykgbmljayAtIFRoZSBuaWNrIG5hbWUgb2YgdGhlIHVzZXIgdG8gbW9kaWZ5LgogICAgKFN0cmluZykgcm9sZSAtIFRoZSBuZXcgcm9sZSBvZiB0aGUgdXNlci4KICAgIChTdHJpbmcpIGFmZmlsaWF0aW9uIC0gVGhlIG5ldyBhZmZpbGlhdGlvbiBvZiB0aGUgdXNlci4KICAgIChTdHJpbmcpIHJlYXNvbiAtIE9wdGlvbmFsIHJlYXNvbiBmb3IgdGhlIGNoYW5nZS4KICAgIChGdW5jdGlvbikgaGFuZGxlcl9jYiAtIE9wdGlvbmFsIGNhbGxiYWNrIGZvciBzdWNjZXNzCiAgICAoRnVuY3Rpb24pIGVycm9yX2NiIC0gT3B0aW9uYWwgY2FsbGJhY2sgZm9yIGVycm9yCiAgICBSZXR1cm5zOgogICAgaXEgLSB0aGUgaWQgb2YgdGhlIG1vZGUgY2hhbmdlIHJlcXVlc3QuCiAgICAgKi8KICAgIG1vZGlmeVJvbGU6IGZ1bmN0aW9uKHJvb20sIG5pY2ssIHJvbGUsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgdmFyIGl0ZW07CiAgICAgIGl0ZW0gPSAkYnVpbGQoIml0ZW0iLCB7CiAgICAgICAgbmljazogbmljaywKICAgICAgICByb2xlOiByb2xlCiAgICAgIH0pOwogICAgICByZXR1cm4gdGhpcy5fbW9kaWZ5UHJpdmlsZWdlKHJvb20sIGl0ZW0sIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfSwKICAgIGtpY2s6IGZ1bmN0aW9uKHJvb20sIG5pY2ssIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kaWZ5Um9sZShyb29tLCBuaWNrLCAnbm9uZScsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfSwKICAgIHZvaWNlOiBmdW5jdGlvbihyb29tLCBuaWNrLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLm1vZGlmeVJvbGUocm9vbSwgbmljaywgJ3BhcnRpY2lwYW50JywgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgICB9LAogICAgbXV0ZTogZnVuY3Rpb24ocm9vbSwgbmljaywgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYikgewogICAgICByZXR1cm4gdGhpcy5tb2RpZnlSb2xlKHJvb20sIG5pY2ssICd2aXNpdG9yJywgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgICB9LAogICAgb3A6IGZ1bmN0aW9uKHJvb20sIG5pY2ssIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kaWZ5Um9sZShyb29tLCBuaWNrLCAnbW9kZXJhdG9yJywgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgICB9LAogICAgZGVvcDogZnVuY3Rpb24ocm9vbSwgbmljaywgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYikgewogICAgICByZXR1cm4gdGhpcy5tb2RpZnlSb2xlKHJvb20sIG5pY2ssICdwYXJ0aWNpcGFudCcsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfSwKCiAgICAvKkZ1bmN0aW9uCiAgICBDaGFuZ2VzIHRoZSBhZmZpbGlhdGlvbiBvZiBhIG1lbWJlciBvZiBhIE1VQyByb29tLgogICAgVGhlIG1vZGlmaWNhdGlvbiBjYW4gb25seSBiZSBkb25lIGJ5IGEgcm9vbSBtb2RlcmF0b3IuIEFuIGVycm9yIHdpbGwgYmUKICAgIHJldHVybmVkIGlmIHRoZSB1c2VyIGRvZXNuJ3QgaGF2ZSBwZXJtaXNzaW9uLgogICAgUGFyYW1ldGVyczoKICAgIChTdHJpbmcpIHJvb20gLSBUaGUgbXVsdGktdXNlciBjaGF0IHJvb20gbmFtZS4KICAgIChTdHJpbmcpIGppZCAgLSBUaGUgamlkIG9mIHRoZSB1c2VyIHRvIG1vZGlmeS4KICAgIChTdHJpbmcpIGFmZmlsaWF0aW9uIC0gVGhlIG5ldyBhZmZpbGlhdGlvbiBvZiB0aGUgdXNlci4KICAgIChTdHJpbmcpIHJlYXNvbiAtIE9wdGlvbmFsIHJlYXNvbiBmb3IgdGhlIGNoYW5nZS4KICAgIChGdW5jdGlvbikgaGFuZGxlcl9jYiAtIE9wdGlvbmFsIGNhbGxiYWNrIGZvciBzdWNjZXNzCiAgICAoRnVuY3Rpb24pIGVycm9yX2NiIC0gT3B0aW9uYWwgY2FsbGJhY2sgZm9yIGVycm9yCiAgICBSZXR1cm5zOgogICAgaXEgLSB0aGUgaWQgb2YgdGhlIG1vZGUgY2hhbmdlIHJlcXVlc3QuCiAgICAgKi8KICAgIG1vZGlmeUFmZmlsaWF0aW9uOiBmdW5jdGlvbihyb29tLCBqaWQsIGFmZmlsaWF0aW9uLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKSB7CiAgICAgIHZhciBpdGVtOwogICAgICBpdGVtID0gJGJ1aWxkKCJpdGVtIiwgewogICAgICAgIGppZDogamlkLAogICAgICAgIGFmZmlsaWF0aW9uOiBhZmZpbGlhdGlvbgogICAgICB9KTsKICAgICAgcmV0dXJuIHRoaXMuX21vZGlmeVByaXZpbGVnZShyb29tLCBpdGVtLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKTsKICAgIH0sCiAgICBiYW46IGZ1bmN0aW9uKHJvb20sIGppZCwgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYikgewogICAgICByZXR1cm4gdGhpcy5tb2RpZnlBZmZpbGlhdGlvbihyb29tLCBqaWQsICdvdXRjYXN0JywgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgICB9LAogICAgbWVtYmVyOiBmdW5jdGlvbihyb29tLCBqaWQsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kaWZ5QWZmaWxpYXRpb24ocm9vbSwgamlkLCAnbWVtYmVyJywgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgICB9LAogICAgcmV2b2tlOiBmdW5jdGlvbihyb29tLCBqaWQsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kaWZ5QWZmaWxpYXRpb24ocm9vbSwgamlkLCAnbm9uZScsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfSwKICAgIG93bmVyOiBmdW5jdGlvbihyb29tLCBqaWQsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kaWZ5QWZmaWxpYXRpb24ocm9vbSwgamlkLCAnb3duZXInLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKTsKICAgIH0sCiAgICBhZG1pbjogZnVuY3Rpb24ocm9vbSwgamlkLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLm1vZGlmeUFmZmlsaWF0aW9uKHJvb20sIGppZCwgJ2FkbWluJywgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgICB9LAoKICAgIC8qRnVuY3Rpb24KICAgIENoYW5nZSB0aGUgY3VycmVudCB1c2VycyBuaWNrIG5hbWUuCiAgICBQYXJhbWV0ZXJzOgogICAgKFN0cmluZykgcm9vbSAtIFRoZSBtdWx0aS11c2VyIGNoYXQgcm9vbSBuYW1lLgogICAgKFN0cmluZykgdXNlciAtIFRoZSBuZXcgbmljayBuYW1lLgogICAgICovCiAgICBjaGFuZ2VOaWNrOiBmdW5jdGlvbihyb29tLCB1c2VyKSB7CiAgICAgIHZhciBwcmVzZW5jZSwgcm9vbV9uaWNrOwogICAgICByb29tX25pY2sgPSB0aGlzLnRlc3RfYXBwZW5kX25pY2socm9vbSwgdXNlcik7CiAgICAgIHByZXNlbmNlID0gJHByZXMoewogICAgICAgIGZyb206IHRoaXMuX2Nvbm5lY3Rpb24uamlkLAogICAgICAgIHRvOiByb29tX25pY2ssCiAgICAgICAgaWQ6IHRoaXMuX2Nvbm5lY3Rpb24uZ2V0VW5pcXVlSWQoKQogICAgICB9KTsKICAgICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZChwcmVzZW5jZS50cmVlKCkpOwogICAgfSwKCiAgICAvKkZ1bmN0aW9uCiAgICBDaGFuZ2UgdGhlIGN1cnJlbnQgdXNlcnMgc3RhdHVzLgogICAgUGFyYW1ldGVyczoKICAgIChTdHJpbmcpIHJvb20gLSBUaGUgbXVsdGktdXNlciBjaGF0IHJvb20gbmFtZS4KICAgIChTdHJpbmcpIHVzZXIgLSBUaGUgY3VycmVudCBuaWNrLgogICAgKFN0cmluZykgc2hvdyAtIFRoZSBuZXcgc2hvdy10ZXh0LgogICAgKFN0cmluZykgc3RhdHVzIC0gVGhlIG5ldyBzdGF0dXMtdGV4dC4KICAgICAqLwogICAgc2V0U3RhdHVzOiBmdW5jdGlvbihyb29tLCB1c2VyLCBzaG93LCBzdGF0dXMpIHsKICAgICAgdmFyIHByZXNlbmNlLCByb29tX25pY2s7CiAgICAgIHJvb21fbmljayA9IHRoaXMudGVzdF9hcHBlbmRfbmljayhyb29tLCB1c2VyKTsKICAgICAgcHJlc2VuY2UgPSAkcHJlcyh7CiAgICAgICAgZnJvbTogdGhpcy5fY29ubmVjdGlvbi5qaWQsCiAgICAgICAgdG86IHJvb21fbmljawogICAgICB9KTsKICAgICAgaWYgKHNob3cgIT0gbnVsbCkgewogICAgICAgIHByZXNlbmNlLmMoJ3Nob3cnLCBzaG93KS51cCgpOwogICAgICB9CiAgICAgIGlmIChzdGF0dXMgIT0gbnVsbCkgewogICAgICAgIHByZXNlbmNlLmMoJ3N0YXR1cycsIHN0YXR1cyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZChwcmVzZW5jZS50cmVlKCkpOwogICAgfSwKCiAgICAvKkZ1bmN0aW9uCiAgICBSZWdpc3RlcmluZyB3aXRoIGEgcm9vbS4KICAgIEBzZWUgaHR0cDovL3htcHAub3JnL2V4dGVuc2lvbnMveGVwLTAwNDUuaHRtbCNyZWdpc3RlcgogICAgUGFyYW1ldGVyczoKICAgIChTdHJpbmcpIHJvb20gLSBUaGUgbXVsdGktdXNlciBjaGF0IHJvb20gbmFtZS4KICAgIChGdW5jdGlvbikgaGFuZGxlX2NiIC0gRnVuY3Rpb24gdG8gY2FsbCBmb3Igcm9vbSBsaXN0IHJldHVybi4KICAgIChGdW5jdGlvbikgZXJyb3JfY2IgLSBGdW5jdGlvbiB0byBjYWxsIG9uIGVycm9yLgogICAgICovCiAgICByZWdpc3RyYXRpb25SZXF1ZXN0OiBmdW5jdGlvbihyb29tLCBoYW5kbGVfY2IsIGVycm9yX2NiKSB7CiAgICAgIHZhciBpcTsKICAgICAgaXEgPSAkaXEoewogICAgICAgIHRvOiByb29tLAogICAgICAgIGZyb206IHRoaXMuX2Nvbm5lY3Rpb24uamlkLAogICAgICAgIHR5cGU6ICJnZXQiCiAgICAgIH0pLmMoInF1ZXJ5IiwgewogICAgICAgIHhtbG5zOiBTdHJvcGhlLk5TLk1VQ19SRUdJU1RFUgogICAgICB9KTsKICAgICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZElRKGlxLCBmdW5jdGlvbihzdGFuemEpIHsKICAgICAgICB2YXIgJGZpZWxkLCAkZmllbGRzLCBmaWVsZCwgZmllbGRzLCBsZW5ndGgsIF9pLCBfbGVuOwogICAgICAgICRmaWVsZHMgPSBzdGFuemEuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2ZpZWxkJyk7CiAgICAgICAgbGVuZ3RoID0gJGZpZWxkcy5sZW5ndGg7CiAgICAgICAgZmllbGRzID0gewogICAgICAgICAgcmVxdWlyZWQ6IFtdLAogICAgICAgICAgb3B0aW9uYWw6IFtdCiAgICAgICAgfTsKICAgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9ICRmaWVsZHMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICAgICRmaWVsZCA9ICRmaWVsZHNbX2ldOwogICAgICAgICAgZmllbGQgPSB7CiAgICAgICAgICAgICJ2YXIiOiAkZmllbGQuZ2V0QXR0cmlidXRlKCd2YXInKSwKICAgICAgICAgICAgbGFiZWw6ICRmaWVsZC5nZXRBdHRyaWJ1dGUoJ2xhYmVsJyksCiAgICAgICAgICAgIHR5cGU6ICRmaWVsZC5nZXRBdHRyaWJ1dGUoJ3R5cGUnKQogICAgICAgICAgfTsKICAgICAgICAgIGlmICgkZmllbGQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3JlcXVpcmVkJykubGVuZ3RoID4gMCkgewogICAgICAgICAgICBmaWVsZHMucmVxdWlyZWQucHVzaChmaWVsZCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmaWVsZHMub3B0aW9uYWwucHVzaChmaWVsZCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBoYW5kbGVfY2IoZmllbGRzKTsKICAgICAgfSwgZXJyb3JfY2IpOwogICAgfSwKCiAgICAvKkZ1bmN0aW9uCiAgICBTdWJtaXRzIHJlZ2lzdHJhdGlvbiBmb3JtLgogICAgUGFyYW1ldGVyczoKICAgIChTdHJpbmcpIHJvb20gLSBUaGUgbXVsdGktdXNlciBjaGF0IHJvb20gbmFtZS4KICAgIChGdW5jdGlvbikgaGFuZGxlX2NiIC0gRnVuY3Rpb24gdG8gY2FsbCBmb3Igcm9vbSBsaXN0IHJldHVybi4KICAgIChGdW5jdGlvbikgZXJyb3JfY2IgLSBGdW5jdGlvbiB0byBjYWxsIG9uIGVycm9yLgogICAgICovCiAgICBzdWJtaXRSZWdpc3RyYXRpb25Gb3JtOiBmdW5jdGlvbihyb29tLCBmaWVsZHMsIGhhbmRsZV9jYiwgZXJyb3JfY2IpIHsKICAgICAgdmFyIGlxLCBrZXksIHZhbDsKICAgICAgaXEgPSAkaXEoewogICAgICAgIHRvOiByb29tLAogICAgICAgIHR5cGU6ICJzZXQiCiAgICAgIH0pLmMoInF1ZXJ5IiwgewogICAgICAgIHhtbG5zOiBTdHJvcGhlLk5TLk1VQ19SRUdJU1RFUgogICAgICB9KTsKICAgICAgaXEuYygieCIsIHsKICAgICAgICB4bWxuczogImphYmJlcjp4OmRhdGEiLAogICAgICAgIHR5cGU6ICJzdWJtaXQiCiAgICAgIH0pOwogICAgICBpcS5jKCdmaWVsZCcsIHsKICAgICAgICAndmFyJzogJ0ZPUk1fVFlQRScKICAgICAgfSkuYygndmFsdWUnKS50KCdodHRwOi8vamFiYmVyLm9yZy9wcm90b2NvbC9tdWMjcmVnaXN0ZXInKS51cCgpLnVwKCk7CiAgICAgIGZvciAoa2V5IGluIGZpZWxkcykgewogICAgICAgIHZhbCA9IGZpZWxkc1trZXldOwogICAgICAgIGlxLmMoJ2ZpZWxkJywgewogICAgICAgICAgJ3Zhcic6IGtleQogICAgICAgIH0pLmMoJ3ZhbHVlJykudCh2YWwpLnVwKCkudXAoKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5fY29ubmVjdGlvbi5zZW5kSVEoaXEsIGhhbmRsZV9jYiwgZXJyb3JfY2IpOwogICAgfSwKCiAgICAvKkZ1bmN0aW9uCiAgICBMaXN0IGFsbCBjaGF0IHJvb20gYXZhaWxhYmxlIG9uIGEgc2VydmVyLgogICAgUGFyYW1ldGVyczoKICAgIChTdHJpbmcpIHNlcnZlciAtIG5hbWUgb2YgY2hhdCBzZXJ2ZXIuCiAgICAoU3RyaW5nKSBoYW5kbGVfY2IgLSBGdW5jdGlvbiB0byBjYWxsIGZvciByb29tIGxpc3QgcmV0dXJuLgogICAgKFN0cmluZykgZXJyb3JfY2IgLSBGdW5jdGlvbiB0byBjYWxsIG9uIGVycm9yLgogICAgICovCiAgICBsaXN0Um9vbXM6IGZ1bmN0aW9uKHNlcnZlciwgaGFuZGxlX2NiLCBlcnJvcl9jYikgewogICAgICB2YXIgaXE7CiAgICAgIGlxID0gJGlxKHsKICAgICAgICB0bzogc2VydmVyLAogICAgICAgIGZyb206IHRoaXMuX2Nvbm5lY3Rpb24uamlkLAogICAgICAgIHR5cGU6ICJnZXQiCiAgICAgIH0pLmMoInF1ZXJ5IiwgewogICAgICAgIHhtbG5zOiBTdHJvcGhlLk5TLkRJU0NPX0lURU1TCiAgICAgIH0pOwogICAgICByZXR1cm4gdGhpcy5fY29ubmVjdGlvbi5zZW5kSVEoaXEsIGhhbmRsZV9jYiwgZXJyb3JfY2IpOwogICAgfSwKICAgIHRlc3RfYXBwZW5kX25pY2s6IGZ1bmN0aW9uKHJvb20sIG5pY2spIHsKICAgICAgdmFyIGRvbWFpbiwgbm9kZTsKICAgICAgbm9kZSA9IFN0cm9waGUuZXNjYXBlTm9kZShTdHJvcGhlLmdldE5vZGVGcm9tSmlkKHJvb20pKTsKICAgICAgZG9tYWluID0gU3Ryb3BoZS5nZXREb21haW5Gcm9tSmlkKHJvb20pOwogICAgICByZXR1cm4gbm9kZSArICJAIiArIGRvbWFpbiArIChuaWNrICE9IG51bGwgPyAiLyIgKyBuaWNrIDogIiIpOwogICAgfQogIH0pOwoKICBYbXBwUm9vbSA9IChmdW5jdGlvbigpIHsKICAgIGZ1bmN0aW9uIFhtcHBSb29tKGNsaWVudCwgbmFtZSwgbmljaywgcGFzc3dvcmQpIHsKICAgICAgdGhpcy5jbGllbnQgPSBjbGllbnQ7CiAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgIHRoaXMubmljayA9IG5pY2s7CiAgICAgIHRoaXMucGFzc3dvcmQgPSBwYXNzd29yZDsKICAgICAgdGhpcy5fcm9vbVJvc3RlckhhbmRsZXIgPSBfX2JpbmQodGhpcy5fcm9vbVJvc3RlckhhbmRsZXIsIHRoaXMpOwogICAgICB0aGlzLl9hZGRPY2N1cGFudCA9IF9fYmluZCh0aGlzLl9hZGRPY2N1cGFudCwgdGhpcyk7CiAgICAgIHRoaXMucm9zdGVyID0ge307CiAgICAgIHRoaXMuX21lc3NhZ2VfaGFuZGxlcnMgPSB7fTsKICAgICAgdGhpcy5fcHJlc2VuY2VfaGFuZGxlcnMgPSB7fTsKICAgICAgdGhpcy5fcm9zdGVyX2hhbmRsZXJzID0ge307CiAgICAgIHRoaXMuX2hhbmRsZXJfaWRzID0gMDsKICAgICAgaWYgKGNsaWVudC5tdWMpIHsKICAgICAgICB0aGlzLmNsaWVudCA9IGNsaWVudC5tdWM7CiAgICAgIH0KICAgICAgdGhpcy5uYW1lID0gU3Ryb3BoZS5nZXRCYXJlSmlkRnJvbUppZChuYW1lKTsKICAgICAgdGhpcy5hZGRIYW5kbGVyKCdwcmVzZW5jZScsIHRoaXMuX3Jvb21Sb3N0ZXJIYW5kbGVyKTsKICAgIH0KCiAgICBYbXBwUm9vbS5wcm90b3R5cGUuam9pbiA9IGZ1bmN0aW9uKG1zZ19oYW5kbGVyX2NiLCBwcmVzX2hhbmRsZXJfY2IsIHJvc3Rlcl9jYikgewogICAgICByZXR1cm4gdGhpcy5jbGllbnQuam9pbih0aGlzLm5hbWUsIHRoaXMubmljaywgbXNnX2hhbmRsZXJfY2IsIHByZXNfaGFuZGxlcl9jYiwgcm9zdGVyX2NiLCB0aGlzLnBhc3N3b3JkKTsKICAgIH07CgogICAgWG1wcFJvb20ucHJvdG90eXBlLmxlYXZlID0gZnVuY3Rpb24oaGFuZGxlcl9jYiwgbWVzc2FnZSkgewogICAgICB0aGlzLmNsaWVudC5sZWF2ZSh0aGlzLm5hbWUsIHRoaXMubmljaywgaGFuZGxlcl9jYiwgbWVzc2FnZSk7CiAgICAgIHJldHVybiBkZWxldGUgdGhpcy5jbGllbnQucm9vbXNbdGhpcy5uYW1lXTsKICAgIH07CgogICAgWG1wcFJvb20ucHJvdG90eXBlLm1lc3NhZ2UgPSBmdW5jdGlvbihuaWNrLCBtZXNzYWdlLCBodG1sX21lc3NhZ2UsIHR5cGUpIHsKICAgICAgcmV0dXJuIHRoaXMuY2xpZW50Lm1lc3NhZ2UodGhpcy5uYW1lLCBuaWNrLCBtZXNzYWdlLCBodG1sX21lc3NhZ2UsIHR5cGUpOwogICAgfTsKCiAgICBYbXBwUm9vbS5wcm90b3R5cGUuZ3JvdXBjaGF0ID0gZnVuY3Rpb24obWVzc2FnZSwgaHRtbF9tZXNzYWdlKSB7CiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5ncm91cGNoYXQodGhpcy5uYW1lLCBtZXNzYWdlLCBodG1sX21lc3NhZ2UpOwogICAgfTsKCiAgICBYbXBwUm9vbS5wcm90b3R5cGUuaW52aXRlID0gZnVuY3Rpb24ocmVjZWl2ZXIsIHJlYXNvbikgewogICAgICByZXR1cm4gdGhpcy5jbGllbnQuaW52aXRlKHRoaXMubmFtZSwgcmVjZWl2ZXIsIHJlYXNvbik7CiAgICB9OwoKICAgIFhtcHBSb29tLnByb3RvdHlwZS5tdWx0aXBsZUludml0ZXMgPSBmdW5jdGlvbihyZWNlaXZlcnMsIHJlYXNvbikgewogICAgICByZXR1cm4gdGhpcy5jbGllbnQuaW52aXRlKHRoaXMubmFtZSwgcmVjZWl2ZXJzLCByZWFzb24pOwogICAgfTsKCiAgICBYbXBwUm9vbS5wcm90b3R5cGUuZGlyZWN0SW52aXRlID0gZnVuY3Rpb24ocmVjZWl2ZXIsIHJlYXNvbikgewogICAgICByZXR1cm4gdGhpcy5jbGllbnQuZGlyZWN0SW52aXRlKHRoaXMubmFtZSwgcmVjZWl2ZXIsIHJlYXNvbiwgdGhpcy5wYXNzd29yZCk7CiAgICB9OwoKICAgIFhtcHBSb29tLnByb3RvdHlwZS5jb25maWd1cmUgPSBmdW5jdGlvbihoYW5kbGVyX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5jb25maWd1cmUodGhpcy5uYW1lLCBoYW5kbGVyX2NiKTsKICAgIH07CgogICAgWG1wcFJvb20ucHJvdG90eXBlLmNhbmNlbENvbmZpZ3VyZSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5jbGllbnQuY2FuY2VsQ29uZmlndXJlKHRoaXMubmFtZSk7CiAgICB9OwoKICAgIFhtcHBSb29tLnByb3RvdHlwZS5zYXZlQ29uZmlndXJhdGlvbiA9IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICByZXR1cm4gdGhpcy5jbGllbnQuc2F2ZUNvbmZpZ3VyYXRpb24odGhpcy5uYW1lLCBjb25maWcpOwogICAgfTsKCiAgICBYbXBwUm9vbS5wcm90b3R5cGUucXVlcnlPY2N1cGFudHMgPSBmdW5jdGlvbihzdWNjZXNzX2NiLCBlcnJvcl9jYikgewogICAgICByZXR1cm4gdGhpcy5jbGllbnQucXVlcnlPY2N1cGFudHModGhpcy5uYW1lLCBzdWNjZXNzX2NiLCBlcnJvcl9jYik7CiAgICB9OwoKICAgIFhtcHBSb29tLnByb3RvdHlwZS5zZXRUb3BpYyA9IGZ1bmN0aW9uKHRvcGljKSB7CiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5zZXRUb3BpYyh0aGlzLm5hbWUsIHRvcGljKTsKICAgIH07CgogICAgWG1wcFJvb20ucHJvdG90eXBlLm1vZGlmeVJvbGUgPSBmdW5jdGlvbihuaWNrLCByb2xlLCByZWFzb24sIHN1Y2Nlc3NfY2IsIGVycm9yX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5tb2RpZnlSb2xlKHRoaXMubmFtZSwgbmljaywgcm9sZSwgcmVhc29uLCBzdWNjZXNzX2NiLCBlcnJvcl9jYik7CiAgICB9OwoKICAgIFhtcHBSb29tLnByb3RvdHlwZS5raWNrID0gZnVuY3Rpb24obmljaywgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYikgewogICAgICByZXR1cm4gdGhpcy5jbGllbnQua2ljayh0aGlzLm5hbWUsIG5pY2ssIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfTsKCiAgICBYbXBwUm9vbS5wcm90b3R5cGUudm9pY2UgPSBmdW5jdGlvbihuaWNrLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLmNsaWVudC52b2ljZSh0aGlzLm5hbWUsIG5pY2ssIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfTsKCiAgICBYbXBwUm9vbS5wcm90b3R5cGUubXV0ZSA9IGZ1bmN0aW9uKG5pY2ssIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMuY2xpZW50Lm11dGUodGhpcy5uYW1lLCBuaWNrLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKTsKICAgIH07CgogICAgWG1wcFJvb20ucHJvdG90eXBlLm9wID0gZnVuY3Rpb24obmljaywgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYikgewogICAgICByZXR1cm4gdGhpcy5jbGllbnQub3AodGhpcy5uYW1lLCBuaWNrLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKTsKICAgIH07CgogICAgWG1wcFJvb20ucHJvdG90eXBlLmRlb3AgPSBmdW5jdGlvbihuaWNrLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5kZW9wKHRoaXMubmFtZSwgbmljaywgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgICB9OwoKICAgIFhtcHBSb29tLnByb3RvdHlwZS5tb2RpZnlBZmZpbGlhdGlvbiA9IGZ1bmN0aW9uKGppZCwgYWZmaWxpYXRpb24sIHJlYXNvbiwgc3VjY2Vzc19jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMuY2xpZW50Lm1vZGlmeUFmZmlsaWF0aW9uKHRoaXMubmFtZSwgamlkLCBhZmZpbGlhdGlvbiwgcmVhc29uLCBzdWNjZXNzX2NiLCBlcnJvcl9jYik7CiAgICB9OwoKICAgIFhtcHBSb29tLnByb3RvdHlwZS5iYW4gPSBmdW5jdGlvbihqaWQsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMuY2xpZW50LmJhbih0aGlzLm5hbWUsIGppZCwgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgICB9OwoKICAgIFhtcHBSb29tLnByb3RvdHlwZS5tZW1iZXIgPSBmdW5jdGlvbihqaWQsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMuY2xpZW50Lm1lbWJlcih0aGlzLm5hbWUsIGppZCwgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgICB9OwoKICAgIFhtcHBSb29tLnByb3RvdHlwZS5yZXZva2UgPSBmdW5jdGlvbihqaWQsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMuY2xpZW50LnJldm9rZSh0aGlzLm5hbWUsIGppZCwgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgICB9OwoKICAgIFhtcHBSb29tLnByb3RvdHlwZS5vd25lciA9IGZ1bmN0aW9uKGppZCwgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYikgewogICAgICByZXR1cm4gdGhpcy5jbGllbnQub3duZXIodGhpcy5uYW1lLCBqaWQsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfTsKCiAgICBYbXBwUm9vbS5wcm90b3R5cGUuYWRtaW4gPSBmdW5jdGlvbihqaWQsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMuY2xpZW50LmFkbWluKHRoaXMubmFtZSwgamlkLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKTsKICAgIH07CgogICAgWG1wcFJvb20ucHJvdG90eXBlLmNoYW5nZU5pY2sgPSBmdW5jdGlvbihuaWNrKSB7CiAgICAgIHRoaXMubmljayA9IG5pY2s7CiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5jaGFuZ2VOaWNrKHRoaXMubmFtZSwgbmljayk7CiAgICB9OwoKICAgIFhtcHBSb29tLnByb3RvdHlwZS5zZXRTdGF0dXMgPSBmdW5jdGlvbihzaG93LCBzdGF0dXMpIHsKICAgICAgcmV0dXJuIHRoaXMuY2xpZW50LnNldFN0YXR1cyh0aGlzLm5hbWUsIHRoaXMubmljaywgc2hvdywgc3RhdHVzKTsKICAgIH07CgoKICAgIC8qRnVuY3Rpb24KICAgIEFkZHMgYSBoYW5kbGVyIHRvIHRoZSBNVUMgcm9vbS4KICAgICAgUGFyYW1ldGVyczoKICAgIChTdHJpbmcpIGhhbmRsZXJfdHlwZSAtICdtZXNzYWdlJywgJ3ByZXNlbmNlJyBvciAncm9zdGVyJy4KICAgIChGdW5jdGlvbikgaGFuZGxlciAtIFRoZSBoYW5kbGVyIGZ1bmN0aW9uLgogICAgUmV0dXJuczoKICAgIGlkIC0gdGhlIGlkIG9mIGhhbmRsZXIuCiAgICAgKi8KCiAgICBYbXBwUm9vbS5wcm90b3R5cGUuYWRkSGFuZGxlciA9IGZ1bmN0aW9uKGhhbmRsZXJfdHlwZSwgaGFuZGxlcikgewogICAgICB2YXIgaWQ7CiAgICAgIGlkID0gdGhpcy5faGFuZGxlcl9pZHMrKzsKICAgICAgc3dpdGNoIChoYW5kbGVyX3R5cGUpIHsKICAgICAgICBjYXNlICdwcmVzZW5jZSc6CiAgICAgICAgICB0aGlzLl9wcmVzZW5jZV9oYW5kbGVyc1tpZF0gPSBoYW5kbGVyOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAnbWVzc2FnZSc6CiAgICAgICAgICB0aGlzLl9tZXNzYWdlX2hhbmRsZXJzW2lkXSA9IGhhbmRsZXI7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdyb3N0ZXInOgogICAgICAgICAgdGhpcy5fcm9zdGVyX2hhbmRsZXJzW2lkXSA9IGhhbmRsZXI7CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgdGhpcy5faGFuZGxlcl9pZHMtLTsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIHJldHVybiBpZDsKICAgIH07CgoKICAgIC8qRnVuY3Rpb24KICAgIFJlbW92ZXMgYSBoYW5kbGVyIGZyb20gdGhlIE1VQyByb29tLgogICAgVGhpcyBmdW5jdGlvbiB0YWtlcyBPTkxZIGlkcyByZXR1cm5lZCBieSB0aGUgYWRkSGFuZGxlciBmdW5jdGlvbgogICAgb2YgdGhpcyByb29tLiBwYXNzaW5nIGhhbmRsZXIgaWRzIHJldHVybmVkIGJ5IGNvbm5lY3Rpb24uYWRkSGFuZGxlcgogICAgbWF5IGJyYWtlIHRoaW5ncyEKICAgICAgUGFyYW1ldGVyczoKICAgIChudW1iZXIpIGlkIC0gdGhlIGlkIG9mIHRoZSBoYW5kbGVyCiAgICAgKi8KCiAgICBYbXBwUm9vbS5wcm90b3R5cGUucmVtb3ZlSGFuZGxlciA9IGZ1bmN0aW9uKGlkKSB7CiAgICAgIGRlbGV0ZSB0aGlzLl9wcmVzZW5jZV9oYW5kbGVyc1tpZF07CiAgICAgIGRlbGV0ZSB0aGlzLl9tZXNzYWdlX2hhbmRsZXJzW2lkXTsKICAgICAgcmV0dXJuIGRlbGV0ZSB0aGlzLl9yb3N0ZXJfaGFuZGxlcnNbaWRdOwogICAgfTsKCgogICAgLypGdW5jdGlvbgogICAgQ3JlYXRlcyBhbmQgYWRkcyBhbiBPY2N1cGFudCB0byB0aGUgUm9vbSBSb3N0ZXIuCiAgICAgIFBhcmFtZXRlcnM6CiAgICAoT2JqZWN0KSBkYXRhIC0gdGhlIGRhdGEgdGhlIE9jY3VwYW50IGlzIGZpbGxlZCB3aXRoCiAgICBSZXR1cm5zOgogICAgb2NjIC0gdGhlIGNyZWF0ZWQgT2NjdXBhbnQuCiAgICAgKi8KCiAgICBYbXBwUm9vbS5wcm90b3R5cGUuX2FkZE9jY3VwYW50ID0gZnVuY3Rpb24oZGF0YSkgewogICAgICB2YXIgb2NjOwogICAgICBvY2MgPSBuZXcgT2NjdXBhbnQoZGF0YSwgdGhpcyk7CiAgICAgIHRoaXMucm9zdGVyW29jYy5uaWNrXSA9IG9jYzsKICAgICAgcmV0dXJuIG9jYzsKICAgIH07CgoKICAgIC8qRnVuY3Rpb24KICAgIFRoZSBzdGFuZGFyZCBoYW5kbGVyIHRoYXQgbWFuYWdlZCB0aGUgUm9vbSBSb3N0ZXIuCiAgICAgIFBhcmFtZXRlcnM6CiAgICAoT2JqZWN0KSBwcmVzIC0gdGhlIHByZXNlbmNlIHN0YW56YSBjb250YWluaW5nIHVzZXIgaW5mb3JtYXRpb24KICAgICAqLwoKICAgIFhtcHBSb29tLnByb3RvdHlwZS5fcm9vbVJvc3RlckhhbmRsZXIgPSBmdW5jdGlvbihwcmVzKSB7CiAgICAgIHZhciBkYXRhLCBoYW5kbGVyLCBpZCwgbmV3bmljaywgbmljaywgX3JlZjsKICAgICAgZGF0YSA9IFhtcHBSb29tLl9wYXJzZVByZXNlbmNlKHByZXMpOwogICAgICBuaWNrID0gZGF0YS5uaWNrOwogICAgICBuZXduaWNrID0gZGF0YS5uZXduaWNrIHx8IG51bGw7CiAgICAgIHN3aXRjaCAoZGF0YS50eXBlKSB7CiAgICAgICAgY2FzZSAnZXJyb3InOgogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgY2FzZSAndW5hdmFpbGFibGUnOgogICAgICAgICAgaWYgKG5ld25pY2spIHsKICAgICAgICAgICAgZGF0YS5uaWNrID0gbmV3bmljazsKICAgICAgICAgICAgaWYgKHRoaXMucm9zdGVyW25pY2tdICYmIHRoaXMucm9zdGVyW25ld25pY2tdKSB7CiAgICAgICAgICAgICAgdGhpcy5yb3N0ZXJbbmlja10udXBkYXRlKHRoaXMucm9zdGVyW25ld25pY2tdKTsKICAgICAgICAgICAgICB0aGlzLnJvc3RlcltuZXduaWNrXSA9IHRoaXMucm9zdGVyW25pY2tdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnJvc3RlcltuaWNrXSAmJiAhdGhpcy5yb3N0ZXJbbmV3bmlja10pIHsKICAgICAgICAgICAgICB0aGlzLnJvc3RlcltuZXduaWNrXSA9IHRoaXMucm9zdGVyW25pY2tdLnVwZGF0ZShkYXRhKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZGVsZXRlIHRoaXMucm9zdGVyW25pY2tdOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIGlmICh0aGlzLnJvc3RlcltuaWNrXSkgewogICAgICAgICAgICB0aGlzLnJvc3RlcltuaWNrXS51cGRhdGUoZGF0YSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl9hZGRPY2N1cGFudChkYXRhKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBfcmVmID0gdGhpcy5fcm9zdGVyX2hhbmRsZXJzOwogICAgICBmb3IgKGlkIGluIF9yZWYpIHsKICAgICAgICBoYW5kbGVyID0gX3JlZltpZF07CiAgICAgICAgaWYgKCFoYW5kbGVyKHRoaXMucm9zdGVyLCB0aGlzKSkgewogICAgICAgICAgZGVsZXRlIHRoaXMuX3Jvc3Rlcl9oYW5kbGVyc1tpZF07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfTsKCgogICAgLypGdW5jdGlvbgogICAgUGFyc2VzIGEgcHJlc2VuY2Ugc3RhbnphCiAgICAgIFBhcmFtZXRlcnM6CiAgICAoT2JqZWN0KSBkYXRhIC0gdGhlIGRhdGEgZXh0cmFjdGVkIGZyb20gdGhlIHByZXNlbmNlIHN0YW56YQogICAgICovCgogICAgWG1wcFJvb20uX3BhcnNlUHJlc2VuY2UgPSBmdW5jdGlvbihwcmVzKSB7CiAgICAgIHZhciBjLCBjMiwgZGF0YSwgX2ksIF9qLCBfbGVuLCBfbGVuMSwgX3JlZiwgX3JlZjE7CiAgICAgIGRhdGEgPSB7fTsKICAgICAgZGF0YS5uaWNrID0gU3Ryb3BoZS5nZXRSZXNvdXJjZUZyb21KaWQocHJlcy5nZXRBdHRyaWJ1dGUoImZyb20iKSk7CiAgICAgIGRhdGEudHlwZSA9IHByZXMuZ2V0QXR0cmlidXRlKCJ0eXBlIik7CiAgICAgIGRhdGEuc3RhdGVzID0gW107CiAgICAgIF9yZWYgPSBwcmVzLmNoaWxkTm9kZXM7CiAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZi5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICAgIGMgPSBfcmVmW19pXTsKICAgICAgICBzd2l0Y2ggKGMubm9kZU5hbWUpIHsKICAgICAgICAgIGNhc2UgInN0YXR1cyI6CiAgICAgICAgICAgIGRhdGEuc3RhdHVzID0gYy50ZXh0Q29udGVudCB8fCBudWxsOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgInNob3ciOgogICAgICAgICAgICBkYXRhLnNob3cgPSBjLnRleHRDb250ZW50IHx8IG51bGw7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAieCI6CiAgICAgICAgICAgIGlmIChjLmdldEF0dHJpYnV0ZSgieG1sbnMiKSA9PT0gU3Ryb3BoZS5OUy5NVUNfVVNFUikgewogICAgICAgICAgICAgIF9yZWYxID0gYy5jaGlsZE5vZGVzOwogICAgICAgICAgICAgIGZvciAoX2ogPSAwLCBfbGVuMSA9IF9yZWYxLmxlbmd0aDsgX2ogPCBfbGVuMTsgX2orKykgewogICAgICAgICAgICAgICAgYzIgPSBfcmVmMVtfal07CiAgICAgICAgICAgICAgICBzd2l0Y2ggKGMyLm5vZGVOYW1lKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgIml0ZW0iOgogICAgICAgICAgICAgICAgICAgIGRhdGEuYWZmaWxpYXRpb24gPSBjMi5nZXRBdHRyaWJ1dGUoImFmZmlsaWF0aW9uIik7CiAgICAgICAgICAgICAgICAgICAgZGF0YS5yb2xlID0gYzIuZ2V0QXR0cmlidXRlKCJyb2xlIik7CiAgICAgICAgICAgICAgICAgICAgZGF0YS5qaWQgPSBjMi5nZXRBdHRyaWJ1dGUoImppZCIpOwogICAgICAgICAgICAgICAgICAgIGRhdGEubmV3bmljayA9IGMyLmdldEF0dHJpYnV0ZSgibmljayIpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlICJzdGF0dXMiOgogICAgICAgICAgICAgICAgICAgIGlmIChjMi5nZXRBdHRyaWJ1dGUoImNvZGUiKSkgewogICAgICAgICAgICAgICAgICAgICAgZGF0YS5zdGF0ZXMucHVzaChjMi5nZXRBdHRyaWJ1dGUoImNvZGUiKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZGF0YTsKICAgIH07CgogICAgcmV0dXJuIFhtcHBSb29tOwoKICB9KSgpOwoKICBSb29tQ29uZmlnID0gKGZ1bmN0aW9uKCkgewogICAgZnVuY3Rpb24gUm9vbUNvbmZpZyhpbmZvKSB7CiAgICAgIHRoaXMucGFyc2UgPSBfX2JpbmQodGhpcy5wYXJzZSwgdGhpcyk7CiAgICAgIGlmIChpbmZvICE9IG51bGwpIHsKICAgICAgICB0aGlzLnBhcnNlKGluZm8pOwogICAgICB9CiAgICB9CgogICAgUm9vbUNvbmZpZy5wcm90b3R5cGUucGFyc2UgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgdmFyIGF0dHIsIGF0dHJzLCBjaGlsZCwgZmllbGQsIGlkZW50aXR5LCBxdWVyeSwgX2ksIF9qLCBfaywgX2xlbiwgX2xlbjEsIF9sZW4yLCBfcmVmOwogICAgICBxdWVyeSA9IHJlc3VsdC5nZXRFbGVtZW50c0J5VGFnTmFtZSgicXVlcnkiKVswXS5jaGlsZE5vZGVzOwogICAgICB0aGlzLmlkZW50aXRpZXMgPSBbXTsKICAgICAgdGhpcy5mZWF0dXJlcyA9IFtdOwogICAgICB0aGlzLnggPSBbXTsKICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBxdWVyeS5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICAgIGNoaWxkID0gcXVlcnlbX2ldOwogICAgICAgIGF0dHJzID0gY2hpbGQuYXR0cmlidXRlczsKICAgICAgICBzd2l0Y2ggKGNoaWxkLm5vZGVOYW1lKSB7CiAgICAgICAgICBjYXNlICJpZGVudGl0eSI6CiAgICAgICAgICAgIGlkZW50aXR5ID0ge307CiAgICAgICAgICAgIGZvciAoX2ogPSAwLCBfbGVuMSA9IGF0dHJzLmxlbmd0aDsgX2ogPCBfbGVuMTsgX2orKykgewogICAgICAgICAgICAgIGF0dHIgPSBhdHRyc1tfal07CiAgICAgICAgICAgICAgaWRlbnRpdHlbYXR0ci5uYW1lXSA9IGF0dHIudGV4dENvbnRlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5pZGVudGl0aWVzLnB1c2goaWRlbnRpdHkpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgImZlYXR1cmUiOgogICAgICAgICAgICB0aGlzLmZlYXR1cmVzLnB1c2goY2hpbGQuZ2V0QXR0cmlidXRlKCJ2YXIiKSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAieCI6CiAgICAgICAgICAgIGlmICgoIWNoaWxkLmNoaWxkTm9kZXNbMF0uZ2V0QXR0cmlidXRlKCJ2YXIiKSA9PT0gJ0ZPUk1fVFlQRScpIHx8ICghY2hpbGQuY2hpbGROb2Rlc1swXS5nZXRBdHRyaWJ1dGUoInR5cGUiKSA9PT0gJ2hpZGRlbicpKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgX3JlZiA9IGNoaWxkLmNoaWxkTm9kZXM7CiAgICAgICAgICAgIGZvciAoX2sgPSAwLCBfbGVuMiA9IF9yZWYubGVuZ3RoOyBfayA8IF9sZW4yOyBfaysrKSB7CiAgICAgICAgICAgICAgZmllbGQgPSBfcmVmW19rXTsKICAgICAgICAgICAgICBpZiAoIWZpZWxkLmF0dHJpYnV0ZXMudHlwZSkgewogICAgICAgICAgICAgICAgdGhpcy54LnB1c2goewogICAgICAgICAgICAgICAgICAidmFyIjogZmllbGQuZ2V0QXR0cmlidXRlKCJ2YXIiKSwKICAgICAgICAgICAgICAgICAgbGFiZWw6IGZpZWxkLmdldEF0dHJpYnV0ZSgibGFiZWwiKSB8fCAiIiwKICAgICAgICAgICAgICAgICAgdmFsdWU6IGZpZWxkLmZpcnN0Q2hpbGQudGV4dENvbnRlbnQgfHwgIiIKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgICJpZGVudGl0aWVzIjogdGhpcy5pZGVudGl0aWVzLAogICAgICAgICJmZWF0dXJlcyI6IHRoaXMuZmVhdHVyZXMsCiAgICAgICAgIngiOiB0aGlzLngKICAgICAgfTsKICAgIH07CgogICAgcmV0dXJuIFJvb21Db25maWc7CgogIH0pKCk7CgogIE9jY3VwYW50ID0gKGZ1bmN0aW9uKCkgewogICAgZnVuY3Rpb24gT2NjdXBhbnQoZGF0YSwgcm9vbSkgewogICAgICB0aGlzLnJvb20gPSByb29tOwogICAgICB0aGlzLnVwZGF0ZSA9IF9fYmluZCh0aGlzLnVwZGF0ZSwgdGhpcyk7CiAgICAgIHRoaXMuYWRtaW4gPSBfX2JpbmQodGhpcy5hZG1pbiwgdGhpcyk7CiAgICAgIHRoaXMub3duZXIgPSBfX2JpbmQodGhpcy5vd25lciwgdGhpcyk7CiAgICAgIHRoaXMucmV2b2tlID0gX19iaW5kKHRoaXMucmV2b2tlLCB0aGlzKTsKICAgICAgdGhpcy5tZW1iZXIgPSBfX2JpbmQodGhpcy5tZW1iZXIsIHRoaXMpOwogICAgICB0aGlzLmJhbiA9IF9fYmluZCh0aGlzLmJhbiwgdGhpcyk7CiAgICAgIHRoaXMubW9kaWZ5QWZmaWxpYXRpb24gPSBfX2JpbmQodGhpcy5tb2RpZnlBZmZpbGlhdGlvbiwgdGhpcyk7CiAgICAgIHRoaXMuZGVvcCA9IF9fYmluZCh0aGlzLmRlb3AsIHRoaXMpOwogICAgICB0aGlzLm9wID0gX19iaW5kKHRoaXMub3AsIHRoaXMpOwogICAgICB0aGlzLm11dGUgPSBfX2JpbmQodGhpcy5tdXRlLCB0aGlzKTsKICAgICAgdGhpcy52b2ljZSA9IF9fYmluZCh0aGlzLnZvaWNlLCB0aGlzKTsKICAgICAgdGhpcy5raWNrID0gX19iaW5kKHRoaXMua2ljaywgdGhpcyk7CiAgICAgIHRoaXMubW9kaWZ5Um9sZSA9IF9fYmluZCh0aGlzLm1vZGlmeVJvbGUsIHRoaXMpOwogICAgICB0aGlzLnVwZGF0ZShkYXRhKTsKICAgIH0KCiAgICBPY2N1cGFudC5wcm90b3R5cGUubW9kaWZ5Um9sZSA9IGZ1bmN0aW9uKHJvbGUsIHJlYXNvbiwgc3VjY2Vzc19jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMucm9vbS5tb2RpZnlSb2xlKHRoaXMubmljaywgcm9sZSwgcmVhc29uLCBzdWNjZXNzX2NiLCBlcnJvcl9jYik7CiAgICB9OwoKICAgIE9jY3VwYW50LnByb3RvdHlwZS5raWNrID0gZnVuY3Rpb24ocmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYikgewogICAgICByZXR1cm4gdGhpcy5yb29tLmtpY2sodGhpcy5uaWNrLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKTsKICAgIH07CgogICAgT2NjdXBhbnQucHJvdG90eXBlLnZvaWNlID0gZnVuY3Rpb24ocmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYikgewogICAgICByZXR1cm4gdGhpcy5yb29tLnZvaWNlKHRoaXMubmljaywgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgICB9OwoKICAgIE9jY3VwYW50LnByb3RvdHlwZS5tdXRlID0gZnVuY3Rpb24ocmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYikgewogICAgICByZXR1cm4gdGhpcy5yb29tLm11dGUodGhpcy5uaWNrLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKTsKICAgIH07CgogICAgT2NjdXBhbnQucHJvdG90eXBlLm9wID0gZnVuY3Rpb24ocmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYikgewogICAgICByZXR1cm4gdGhpcy5yb29tLm9wKHRoaXMubmljaywgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgICB9OwoKICAgIE9jY3VwYW50LnByb3RvdHlwZS5kZW9wID0gZnVuY3Rpb24ocmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYikgewogICAgICByZXR1cm4gdGhpcy5yb29tLmRlb3AodGhpcy5uaWNrLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKTsKICAgIH07CgogICAgT2NjdXBhbnQucHJvdG90eXBlLm1vZGlmeUFmZmlsaWF0aW9uID0gZnVuY3Rpb24oYWZmaWxpYXRpb24sIHJlYXNvbiwgc3VjY2Vzc19jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMucm9vbS5tb2RpZnlBZmZpbGlhdGlvbih0aGlzLmppZCwgYWZmaWxpYXRpb24sIHJlYXNvbiwgc3VjY2Vzc19jYiwgZXJyb3JfY2IpOwogICAgfTsKCiAgICBPY2N1cGFudC5wcm90b3R5cGUuYmFuID0gZnVuY3Rpb24ocmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYikgewogICAgICByZXR1cm4gdGhpcy5yb29tLmJhbih0aGlzLmppZCwgcmVhc29uLCBoYW5kbGVyX2NiLCBlcnJvcl9jYik7CiAgICB9OwoKICAgIE9jY3VwYW50LnByb3RvdHlwZS5tZW1iZXIgPSBmdW5jdGlvbihyZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLnJvb20ubWVtYmVyKHRoaXMuamlkLCByZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKTsKICAgIH07CgogICAgT2NjdXBhbnQucHJvdG90eXBlLnJldm9rZSA9IGZ1bmN0aW9uKHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpIHsKICAgICAgcmV0dXJuIHRoaXMucm9vbS5yZXZva2UodGhpcy5qaWQsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfTsKCiAgICBPY2N1cGFudC5wcm90b3R5cGUub3duZXIgPSBmdW5jdGlvbihyZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLnJvb20ub3duZXIodGhpcy5qaWQsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfTsKCiAgICBPY2N1cGFudC5wcm90b3R5cGUuYWRtaW4gPSBmdW5jdGlvbihyZWFzb24sIGhhbmRsZXJfY2IsIGVycm9yX2NiKSB7CiAgICAgIHJldHVybiB0aGlzLnJvb20uYWRtaW4odGhpcy5qaWQsIHJlYXNvbiwgaGFuZGxlcl9jYiwgZXJyb3JfY2IpOwogICAgfTsKCiAgICBPY2N1cGFudC5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24oZGF0YSkgewogICAgICB0aGlzLm5pY2sgPSBkYXRhLm5pY2sgfHwgbnVsbDsKICAgICAgdGhpcy5hZmZpbGlhdGlvbiA9IGRhdGEuYWZmaWxpYXRpb24gfHwgbnVsbDsKICAgICAgdGhpcy5yb2xlID0gZGF0YS5yb2xlIHx8IG51bGw7CiAgICAgIHRoaXMuamlkID0gZGF0YS5qaWQgfHwgbnVsbDsKICAgICAgdGhpcy5zdGF0dXMgPSBkYXRhLnN0YXR1cyB8fCBudWxsOwogICAgICB0aGlzLnNob3cgPSBkYXRhLnNob3cgfHwgbnVsbDsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIHJldHVybiBPY2N1cGFudDsKCiAgfSkoKTsKCn0pLmNhbGwodGhpcyk7CgpkZWZpbmUoInN0cm9waGUubXVjIiwgWyJzdHJvcGhlIl0sIGZ1bmN0aW9uKCl7fSk7CgovKgogIENvcHlyaWdodCAyMDEwLCBGcmFuw6dvaXMgZGUgTWV0eiA8ZnJhbmNvaXNAMm1ldHouZnI+CiovCi8qKgogKiBSb3N0ZXIgUGx1Z2luCiAqIEFsbG93IGVhc2lseSByb3N0ZXIgbWFuYWdlbWVudAogKgogKiAgRmVhdHVyZXMKICogICogR2V0IHJvc3RlciBmcm9tIHNlcnZlcgogKiAgKiBoYW5kbGUgcHJlc2VuY2UKICogICogaGFuZGxlIHJvc3RlciBpcQogKiAgKiBzdWJzY3JpYmUvdW5zdWJzY3JpYmUKICogICogYXV0aG9yaXplL3VuYXV0aG9yaXplCiAqICAqIHJvc3RlciB2ZXJzaW9uaW5nICh4ZXAgMjM3KQogKi8KU3Ryb3BoZS5hZGRDb25uZWN0aW9uUGx1Z2luKCdyb3N0ZXInLAp7CiAgICAvKiogRnVuY3Rpb246IGluaXQKICAgICAqIFBsdWdpbiBpbml0CiAgICAgKgogICAgICogUGFyYW1ldGVyczoKICAgICAqICAgKFN0cm9waGUuQ29ubmVjdGlvbikgY29ubiAtIFN0cm9waGUgY29ubmVjdGlvbgogICAgICovCiAgICBpbml0OiBmdW5jdGlvbihjb25uKQogICAgewogICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24gPSBjb25uOwogICAgICAgIHRoaXMuX2NhbGxiYWNrcyA9IFtdOwogICAgICAgIC8qKiBQcm9wZXJ0eTogaXRlbXMKICAgICAgICAgKiAgUm9zdGVyIGl0ZW1zCiAgICAgICAgICogIFsKICAgICAgICAgKiAgICB7CiAgICAgICAgICogICAgICAgIG5hbWUgICAgICAgICA6ICIiLAogICAgICAgICAqICAgICAgICBqaWQgICAgICAgICAgOiAiIiwKICAgICAgICAgKiAgICAgICAgc3Vic2NyaXB0aW9uIDogIiIsCiAgICAgICAgICogICAgICAgIGFzayAgICAgICAgICA6ICIiLAogICAgICAgICAqICAgICAgICBncm91cHMgICAgICAgOiBbIiIsICIiXSwKICAgICAgICAgKiAgICAgICAgcmVzb3VyY2VzICAgIDogewogICAgICAgICAqICAgICAgICAgICAgbXlyZXNvdXJjZSA6IHsKICAgICAgICAgKiAgICAgICAgICAgICAgICBzaG93ICAgOiAiIiwKICAgICAgICAgKiAgICAgICAgICAgICAgICBzdGF0dXMgOiAiIiwKICAgICAgICAgKiAgICAgICAgICAgICAgICBwcmlvcml0eSA6ICIiCiAgICAgICAgICogICAgICAgICAgICB9CiAgICAgICAgICogICAgICAgIH0KICAgICAgICAgKiAgICB9CiAgICAgICAgICogXQogICAgICAgICAqLwogICAgICAgIHRoaXMuaXRlbXMgPSBbXTsKICAgICAgICAvKiogUHJvcGVydHk6IHZlcgogICAgICAgICogY3VycmVudCByb3N0ZXIgcmV2aXNpb24KICAgICAgICAqIGFsd2F5cyBudWxsIGlmIHNlcnZlciBkb2Vzbid0IHN1cHBvcnQgeGVwIDIzNwogICAgICAgICovCiAgICAgICAgdGhpcy52ZXIgPSBudWxsOwogICAgICAgIC8vIE92ZXJyaWRlIHRoZSBjb25uZWN0IGFuZCBhdHRhY2ggbWV0aG9kcyB0byBhbHdheXMgYWRkIHByZXNlbmNlIGFuZCByb3N0ZXIgaGFuZGxlcnMuCiAgICAgICAgLy8gVGhleSBhcmUgcmVtb3ZlZCB3aGVuIHRoZSBjb25uZWN0aW9uIGRpc2Nvbm5lY3RzLCBzbyBtdXN0IGJlIGFkZGVkIG9uIGNvbm5lY3Rpb24uCiAgICAgICAgdmFyIG9sZENhbGxiYWNrLCByb3N0ZXIgPSB0aGlzLCBfY29ubmVjdCA9IGNvbm4uY29ubmVjdCwgX2F0dGFjaCA9IGNvbm4uYXR0YWNoOwogICAgICAgIHZhciBuZXdDYWxsYmFjayA9IGZ1bmN0aW9uKHN0YXR1cykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChzdGF0dXMgPT0gU3Ryb3BoZS5TdGF0dXMuQVRUQUNIRUQgfHwgc3RhdHVzID09IFN0cm9waGUuU3RhdHVzLkNPTk5FQ1RFRCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdHJ5CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gUHJlc2VuY2Ugc3Vic2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgY29ubi5hZGRIYW5kbGVyKHJvc3Rlci5fb25SZWNlaXZlUHJlc2VuY2UuYmluZChyb3N0ZXIpLCBudWxsLCAncHJlc2VuY2UnLCBudWxsLCBudWxsLCBudWxsKTsKICAgICAgICAgICAgICAgICAgICBjb25uLmFkZEhhbmRsZXIocm9zdGVyLl9vblJlY2VpdmVJUS5iaW5kKHJvc3RlciksIFN0cm9waGUuTlMuUk9TVEVSLCAnaXEnLCAic2V0IiwgbnVsbCwgbnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaCAoZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBTdHJvcGhlLmVycm9yKGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2Ygb2xkQ2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIG9sZENhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGNvbm4uY29ubmVjdCA9IGZ1bmN0aW9uKGppZCwgcGFzcywgY2FsbGJhY2ssIHdhaXQsIGhvbGQpCiAgICAgICAgewogICAgICAgICAgICBvbGRDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICBpZiAodHlwZW9mIGppZCAgPT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICBqaWQgID0gbnVsbDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXNzID09ICJ1bmRlZmluZWQiKQogICAgICAgICAgICAgICAgcGFzcyA9IG51bGw7CiAgICAgICAgICAgIGNhbGxiYWNrID0gbmV3Q2FsbGJhY2s7CiAgICAgICAgICAgIF9jb25uZWN0LmFwcGx5KGNvbm4sIFtqaWQsIHBhc3MsIGNhbGxiYWNrLCB3YWl0LCBob2xkXSk7CiAgICAgICAgfTsKICAgICAgICBjb25uLmF0dGFjaCA9IGZ1bmN0aW9uKGppZCwgc2lkLCByaWQsIGNhbGxiYWNrLCB3YWl0LCBob2xkLCB3aW5kKQogICAgICAgIHsKICAgICAgICAgICAgb2xkQ2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgaWYgKHR5cGVvZiBqaWQgPT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICBqaWQgPSBudWxsOwogICAgICAgICAgICBpZiAodHlwZW9mIHNpZCA9PSAidW5kZWZpbmVkIikKICAgICAgICAgICAgICAgIHNpZCA9IG51bGw7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmlkID09ICJ1bmRlZmluZWQiKQogICAgICAgICAgICAgICAgcmlkID0gbnVsbDsKICAgICAgICAgICAgY2FsbGJhY2sgPSBuZXdDYWxsYmFjazsKICAgICAgICAgICAgX2F0dGFjaC5hcHBseShjb25uLCBbamlkLCBzaWQsIHJpZCwgY2FsbGJhY2ssIHdhaXQsIGhvbGQsIHdpbmRdKTsKICAgICAgICB9OwoKICAgICAgICBTdHJvcGhlLmFkZE5hbWVzcGFjZSgnUk9TVEVSX1ZFUicsICd1cm46eG1wcDpmZWF0dXJlczpyb3N0ZXJ2ZXInKTsKICAgICAgICBTdHJvcGhlLmFkZE5hbWVzcGFjZSgnTklDSycsICdodHRwOi8vamFiYmVyLm9yZy9wcm90b2NvbC9uaWNrJyk7CiAgICB9LAogICAgLyoqIEZ1bmN0aW9uOiBzdXBwb3J0VmVyc2lvbmluZwogICAgICogcmV0dXJuIHRydWUgaWYgcm9zdGVyIHZlcnNpb25pbmcgaXMgZW5hYmxlZCBvbiBzZXJ2ZXIKICAgICAqLwogICAgc3VwcG9ydFZlcnNpb25pbmc6IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICByZXR1cm4gKHRoaXMuX2Nvbm5lY3Rpb24uZmVhdHVyZXMgJiYgdGhpcy5fY29ubmVjdGlvbi5mZWF0dXJlcy5nZXRFbGVtZW50c0J5VGFnTmFtZSgndmVyJykubGVuZ3RoID4gMCk7CiAgICB9LAogICAgLyoqIEZ1bmN0aW9uOiBnZXQKICAgICAqIEdldCBSb3N0ZXIgb24gc2VydmVyCiAgICAgKgogICAgICogUGFyYW1ldGVyczoKICAgICAqICAgKEZ1bmN0aW9uKSB1c2VyQ2FsbGJhY2sgLSBjYWxsYmFjayBvbiByb3N0ZXIgcmVzdWx0CiAgICAgKiAgIChTdHJpbmcpIHZlciAtIGN1cnJlbnQgcmV2IG9mIHJvc3RlcgogICAgICogICAgICAob25seSB1c2VkIGlmIHJvc3RlciB2ZXJzaW9uaW5nIGlzIGVuYWJsZWQpCiAgICAgKiAgIChBcnJheSkgaXRlbXMgLSBpbml0aWFsIGl0ZW1zIG9mIHZlcgogICAgICogICAgICAob25seSB1c2VkIGlmIHJvc3RlciB2ZXJzaW9uaW5nIGlzIGVuYWJsZWQpCiAgICAgKiAgICAgSW4gYnJvd3NlciBjb250ZXh0IHlvdSBjYW4gdXNlIHNlc3Npb25TdG9yYWdlCiAgICAgKiAgICAgdG8gc3RvcmUgeW91ciByb3N0ZXIgaW4ganNvbiAoSlNPTi5zdHJpbmdpZnkoKSkKICAgICAqLwogICAgZ2V0OiBmdW5jdGlvbih1c2VyQ2FsbGJhY2ssIHZlciwgaXRlbXMpCiAgICB7CiAgICAgICAgdmFyIGF0dHJzID0ge3htbG5zOiBTdHJvcGhlLk5TLlJPU1RFUn07CiAgICAgICAgaWYgKHRoaXMuc3VwcG9ydFZlcnNpb25pbmcoKSkKICAgICAgICB7CiAgICAgICAgICAgIC8vIGVtcHR5IHJldiBiZWNhdXNlIGkgd2FudCBhbiByZXYgYXR0cmlidXRlIGluIHRoZSByZXN1bHQKICAgICAgICAgICAgYXR0cnMudmVyID0gdmVyIHx8ICcnOwogICAgICAgICAgICB0aGlzLml0ZW1zID0gaXRlbXMgfHwgW107CiAgICAgICAgfQogICAgICAgIHZhciBpcSA9ICRpcSh7dHlwZTogJ2dldCcsICAnaWQnIDogdGhpcy5fY29ubmVjdGlvbi5nZXRVbmlxdWVJZCgncm9zdGVyJyl9KS5jKCdxdWVyeScsIGF0dHJzKTsKICAgICAgICByZXR1cm4gdGhpcy5fY29ubmVjdGlvbi5zZW5kSVEoaXEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fb25SZWNlaXZlUm9zdGVyU3VjY2Vzcy5iaW5kKHRoaXMsIHVzZXJDYWxsYmFjayksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fb25SZWNlaXZlUm9zdGVyRXJyb3IuYmluZCh0aGlzLCB1c2VyQ2FsbGJhY2spKTsKICAgIH0sCiAgICAvKiogRnVuY3Rpb246IHJlZ2lzdGVyQ2FsbGJhY2sKICAgICAqIHJlZ2lzdGVyIGNhbGxiYWNrIG9uIHJvc3RlciAocHJlc2VuY2UgYW5kIGlxKQogICAgICoKICAgICAqIFBhcmFtZXRlcnM6CiAgICAgKiAgIChGdW5jdGlvbikgY2FsbF9iYWNrCiAgICAgKi8KICAgIHJlZ2lzdGVyQ2FsbGJhY2s6IGZ1bmN0aW9uKGNhbGxfYmFjaykKICAgIHsKICAgICAgICB0aGlzLl9jYWxsYmFja3MucHVzaChjYWxsX2JhY2spOwogICAgfSwKICAgIC8qKiBGdW5jdGlvbjogZmluZEl0ZW0KICAgICAqIEZpbmQgaXRlbSBieSBKSUQKICAgICAqCiAgICAgKiBQYXJhbWV0ZXJzOgogICAgICogICAgIChTdHJpbmcpIGppZAogICAgICovCiAgICBmaW5kSXRlbSA6IGZ1bmN0aW9uKGppZCkKICAgIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuaXRlbXMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLml0ZW1zW2ldICYmIHRoaXMuaXRlbXNbaV0uamlkID09IGppZCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pdGVtc1tpXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpCiAgICAgICAgewogICAgICAgICAgICBTdHJvcGhlLmVycm9yKGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAogICAgLyoqIEZ1bmN0aW9uOiByZW1vdmVJdGVtCiAgICAgKiBSZW1vdmUgaXRlbSBieSBKSUQKICAgICAqCiAgICAgKiBQYXJhbWV0ZXJzOgogICAgICogICAgIChTdHJpbmcpIGppZAogICAgICovCiAgICByZW1vdmVJdGVtIDogZnVuY3Rpb24oamlkKQogICAgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5pdGVtcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLml0ZW1zW2ldICYmIHRoaXMuaXRlbXNbaV0uamlkID09IGppZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5pdGVtcy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAogICAgLyoqIEZ1bmN0aW9uOiBzdWJzY3JpYmUKICAgICAqIFN1YnNjcmliZSBwcmVzZW5jZQogICAgICoKICAgICAqIFBhcmFtZXRlcnM6CiAgICAgKiAgICAgKFN0cmluZykgamlkCiAgICAgKiAgICAgKFN0cmluZykgbWVzc2FnZSAob3B0aW9uYWwpCiAgICAgKiAgICAgKFN0cmluZykgbmljayAgKG9wdGlvbmFsKQogICAgICovCiAgICBzdWJzY3JpYmU6IGZ1bmN0aW9uKGppZCwgbWVzc2FnZSwgbmljaykgewogICAgICAgIHZhciBwcmVzID0gJHByZXMoe3RvOiBqaWQsIHR5cGU6ICJzdWJzY3JpYmUifSk7CiAgICAgICAgaWYgKG1lc3NhZ2UgJiYgbWVzc2FnZSAhPT0gIiIpIHsKICAgICAgICAgICAgcHJlcy5jKCJzdGF0dXMiKS50KG1lc3NhZ2UpLnVwKCk7CiAgICAgICAgfQogICAgICAgIGlmIChuaWNrICYmIG5pY2sgIT09ICIiKSB7CiAgICAgICAgICAgIHByZXMuYygnbmljaycsIHsneG1sbnMnOiBTdHJvcGhlLk5TLk5JQ0t9KS50KG5pY2spLnVwKCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZChwcmVzKTsKICAgIH0sCiAgICAvKiogRnVuY3Rpb246IHVuc3Vic2NyaWJlCiAgICAgKiBVbnN1YnNjcmliZSBwcmVzZW5jZQogICAgICoKICAgICAqIFBhcmFtZXRlcnM6CiAgICAgKiAgICAgKFN0cmluZykgamlkCiAgICAgKiAgICAgKFN0cmluZykgbWVzc2FnZQogICAgICovCiAgICB1bnN1YnNjcmliZTogZnVuY3Rpb24oamlkLCBtZXNzYWdlKQogICAgewogICAgICAgIHZhciBwcmVzID0gJHByZXMoe3RvOiBqaWQsIHR5cGU6ICJ1bnN1YnNjcmliZSJ9KTsKICAgICAgICBpZiAobWVzc2FnZSAmJiBtZXNzYWdlICE9PSAiIikKICAgICAgICAgICAgcHJlcy5jKCJzdGF0dXMiKS50KG1lc3NhZ2UpOwogICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZChwcmVzKTsKICAgIH0sCiAgICAvKiogRnVuY3Rpb246IGF1dGhvcml6ZQogICAgICogQXV0aG9yaXplIHByZXNlbmNlIHN1YnNjcmlwdGlvbgogICAgICoKICAgICAqIFBhcmFtZXRlcnM6CiAgICAgKiAgICAgKFN0cmluZykgamlkCiAgICAgKiAgICAgKFN0cmluZykgbWVzc2FnZQogICAgICovCiAgICBhdXRob3JpemU6IGZ1bmN0aW9uKGppZCwgbWVzc2FnZSkKICAgIHsKICAgICAgICB2YXIgcHJlcyA9ICRwcmVzKHt0bzogamlkLCB0eXBlOiAic3Vic2NyaWJlZCJ9KTsKICAgICAgICBpZiAobWVzc2FnZSAmJiBtZXNzYWdlICE9PSAiIikKICAgICAgICAgICAgcHJlcy5jKCJzdGF0dXMiKS50KG1lc3NhZ2UpOwogICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZChwcmVzKTsKICAgIH0sCiAgICAvKiogRnVuY3Rpb246IHVuYXV0aG9yaXplCiAgICAgKiBVbmF1dGhvcml6ZSBwcmVzZW5jZSBzdWJzY3JpcHRpb24KICAgICAqCiAgICAgKiBQYXJhbWV0ZXJzOgogICAgICogICAgIChTdHJpbmcpIGppZAogICAgICogICAgIChTdHJpbmcpIG1lc3NhZ2UKICAgICAqLwogICAgdW5hdXRob3JpemU6IGZ1bmN0aW9uKGppZCwgbWVzc2FnZSkKICAgIHsKICAgICAgICB2YXIgcHJlcyA9ICRwcmVzKHt0bzogamlkLCB0eXBlOiAidW5zdWJzY3JpYmVkIn0pOwogICAgICAgIGlmIChtZXNzYWdlICYmIG1lc3NhZ2UgIT09ICIiKQogICAgICAgICAgICBwcmVzLmMoInN0YXR1cyIpLnQobWVzc2FnZSk7CiAgICAgICAgdGhpcy5fY29ubmVjdGlvbi5zZW5kKHByZXMpOwogICAgfSwKICAgIC8qKiBGdW5jdGlvbjogYWRkCiAgICAgKiBBZGQgcm9zdGVyIGl0ZW0KICAgICAqCiAgICAgKiBQYXJhbWV0ZXJzOgogICAgICogICAoU3RyaW5nKSBqaWQgLSBpdGVtIGppZAogICAgICogICAoU3RyaW5nKSBuYW1lIC0gbmFtZQogICAgICogICAoQXJyYXkpIGdyb3VwcwogICAgICogICAoRnVuY3Rpb24pIGNhbGxfYmFjawogICAgICovCiAgICBhZGQ6IGZ1bmN0aW9uKGppZCwgbmFtZSwgZ3JvdXBzLCBjYWxsX2JhY2spCiAgICB7CiAgICAgICAgdmFyIGlxID0gJGlxKHt0eXBlOiAnc2V0J30pLmMoJ3F1ZXJ5Jywge3htbG5zOiBTdHJvcGhlLk5TLlJPU1RFUn0pLmMoJ2l0ZW0nLCB7amlkOiBqaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogbmFtZX0pOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZ3JvdXBzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaXEuYygnZ3JvdXAnKS50KGdyb3Vwc1tpXSkudXAoKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fY29ubmVjdGlvbi5zZW5kSVEoaXEsIGNhbGxfYmFjaywgY2FsbF9iYWNrKTsKICAgIH0sCiAgICAvKiogRnVuY3Rpb246IHVwZGF0ZQogICAgICogVXBkYXRlIHJvc3RlciBpdGVtCiAgICAgKgogICAgICogUGFyYW1ldGVyczoKICAgICAqICAgKFN0cmluZykgamlkIC0gaXRlbSBqaWQKICAgICAqICAgKFN0cmluZykgbmFtZSAtIG5hbWUKICAgICAqICAgKEFycmF5KSBncm91cHMKICAgICAqICAgKEZ1bmN0aW9uKSBjYWxsX2JhY2sKICAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbihqaWQsIG5hbWUsIGdyb3VwcywgY2FsbF9iYWNrKQogICAgewogICAgICAgIHZhciBpdGVtID0gdGhpcy5maW5kSXRlbShqaWQpOwogICAgICAgIGlmICghaXRlbSkKICAgICAgICB7CiAgICAgICAgICAgIHRocm93ICJpdGVtIG5vdCBmb3VuZCI7CiAgICAgICAgfQogICAgICAgIHZhciBuZXdOYW1lID0gbmFtZSB8fCBpdGVtLm5hbWU7CiAgICAgICAgdmFyIG5ld0dyb3VwcyA9IGdyb3VwcyB8fCBpdGVtLmdyb3VwczsKICAgICAgICB2YXIgaXEgPSAkaXEoe3R5cGU6ICdzZXQnfSkuYygncXVlcnknLCB7eG1sbnM6IFN0cm9waGUuTlMuUk9TVEVSfSkuYygnaXRlbScsIHtqaWQ6IGl0ZW0uamlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IG5ld05hbWV9KTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5ld0dyb3Vwcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlxLmMoJ2dyb3VwJykudChuZXdHcm91cHNbaV0pLnVwKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW9uLnNlbmRJUShpcSwgY2FsbF9iYWNrLCBjYWxsX2JhY2spOwogICAgfSwKICAgIC8qKiBGdW5jdGlvbjogcmVtb3ZlCiAgICAgKiBSZW1vdmUgcm9zdGVyIGl0ZW0KICAgICAqCiAgICAgKiBQYXJhbWV0ZXJzOgogICAgICogICAoU3RyaW5nKSBqaWQgLSBpdGVtIGppZAogICAgICogICAoRnVuY3Rpb24pIGNhbGxfYmFjawogICAgICovCiAgICByZW1vdmU6IGZ1bmN0aW9uKGppZCwgY2FsbF9iYWNrKQogICAgewogICAgICAgIHZhciBpdGVtID0gdGhpcy5maW5kSXRlbShqaWQpOwogICAgICAgIGlmICghaXRlbSkKICAgICAgICB7CiAgICAgICAgICAgIHRocm93ICJpdGVtIG5vdCBmb3VuZCI7CiAgICAgICAgfQogICAgICAgIHZhciBpcSA9ICRpcSh7dHlwZTogJ3NldCd9KS5jKCdxdWVyeScsIHt4bWxuczogU3Ryb3BoZS5OUy5ST1NURVJ9KS5jKCdpdGVtJywge2ppZDogaXRlbS5qaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uOiAicmVtb3ZlIn0pOwogICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZElRKGlxLCBjYWxsX2JhY2ssIGNhbGxfYmFjayk7CiAgICB9LAogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX29uUmVjZWl2ZVJvc3RlclN1Y2Nlc3MKICAgICAqCiAgICAgKi8KICAgIF9vblJlY2VpdmVSb3N0ZXJTdWNjZXNzOiBmdW5jdGlvbih1c2VyQ2FsbGJhY2ssIHN0YW56YSkKICAgIHsKICAgICAgICB0aGlzLl91cGRhdGVJdGVtcyhzdGFuemEpOwogICAgICAgIGlmICh0eXBlb2YgdXNlckNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHVzZXJDYWxsYmFjayh0aGlzLml0ZW1zKTsKICAgICAgICB9CiAgICB9LAogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX29uUmVjZWl2ZVJvc3RlckVycm9yCiAgICAgKgogICAgICovCiAgICBfb25SZWNlaXZlUm9zdGVyRXJyb3I6IGZ1bmN0aW9uKHVzZXJDYWxsYmFjaywgc3RhbnphKQogICAgewogICAgICAgIHVzZXJDYWxsYmFjayh0aGlzLml0ZW1zKTsKICAgIH0sCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfb25SZWNlaXZlUHJlc2VuY2UKICAgICAqIEhhbmRsZSBwcmVzZW5jZQogICAgICovCiAgICBfb25SZWNlaXZlUHJlc2VuY2UgOiBmdW5jdGlvbihwcmVzZW5jZSkKICAgIHsKICAgICAgICAvLyBUT0RPOiBmcm9tIGlzIG9wdGlvbmFsCiAgICAgICAgdmFyIGppZCA9IHByZXNlbmNlLmdldEF0dHJpYnV0ZSgnZnJvbScpOwogICAgICAgIHZhciBmcm9tID0gU3Ryb3BoZS5nZXRCYXJlSmlkRnJvbUppZChqaWQpOwogICAgICAgIHZhciBpdGVtID0gdGhpcy5maW5kSXRlbShmcm9tKTsKICAgICAgICAvLyBub3QgaW4gcm9zdGVyCiAgICAgICAgaWYgKCFpdGVtKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHZhciB0eXBlID0gcHJlc2VuY2UuZ2V0QXR0cmlidXRlKCd0eXBlJyk7CiAgICAgICAgaWYgKHR5cGUgPT0gJ3VuYXZhaWxhYmxlJykKICAgICAgICB7CiAgICAgICAgICAgIGRlbGV0ZSBpdGVtLnJlc291cmNlc1tTdHJvcGhlLmdldFJlc291cmNlRnJvbUppZChqaWQpXTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoIXR5cGUpCiAgICAgICAgewogICAgICAgICAgICAvLyBUT0RPOiBhZGQgdGltZXN0YW1wCiAgICAgICAgICAgIGl0ZW0ucmVzb3VyY2VzW1N0cm9waGUuZ2V0UmVzb3VyY2VGcm9tSmlkKGppZCldID0gewogICAgICAgICAgICAgICAgc2hvdyAgICAgOiAocHJlc2VuY2UuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3Nob3cnKS5sZW5ndGggIT09IDApID8gU3Ryb3BoZS5nZXRUZXh0KHByZXNlbmNlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzaG93JylbMF0pIDogIiIsCiAgICAgICAgICAgICAgICBzdGF0dXMgICA6IChwcmVzZW5jZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc3RhdHVzJykubGVuZ3RoICE9PSAwKSA/IFN0cm9waGUuZ2V0VGV4dChwcmVzZW5jZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc3RhdHVzJylbMF0pIDogIiIsCiAgICAgICAgICAgICAgICBwcmlvcml0eSA6IChwcmVzZW5jZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgncHJpb3JpdHknKS5sZW5ndGggIT09IDApID8gU3Ryb3BoZS5nZXRUZXh0KHByZXNlbmNlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdwcmlvcml0eScpWzBdKSA6ICIiCiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vIFN0YW56YSBpcyBub3QgYSBwcmVzZW5jZSBub3RpZmljYXRpb24uIChJdCdzIHByb2JhYmx5IGEgc3Vic2NyaXB0aW9uIHR5cGUgc3RhbnphLikKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHRoaXMuX2NhbGxfYmFja3ModGhpcy5pdGVtcywgaXRlbSk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX2NhbGxfYmFja3MKICAgICAqCiAgICAgKi8KICAgIF9jYWxsX2JhY2tzIDogZnVuY3Rpb24oaXRlbXMsIGl0ZW0pCiAgICB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9jYWxsYmFja3MubGVuZ3RoOyBpKyspIC8vIFtdLmZvckVhY2ggbXkgbG92ZSAuLi4KICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2NhbGxiYWNrc1tpXShpdGVtcywgaXRlbSk7CiAgICAgICAgfQogICAgfSwKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF9vblJlY2VpdmVJUQogICAgICogSGFuZGxlIHJvc3RlciBwdXNoLgogICAgICovCiAgICBfb25SZWNlaXZlSVEgOiBmdW5jdGlvbihpcSkKICAgIHsKICAgICAgICB2YXIgaWQgPSBpcS5nZXRBdHRyaWJ1dGUoJ2lkJyk7CiAgICAgICAgdmFyIGZyb20gPSBpcS5nZXRBdHRyaWJ1dGUoJ2Zyb20nKTsKICAgICAgICAvLyBSZWNlaXZpbmcgY2xpZW50IE1VU1QgaWdub3JlIHN0YW56YSB1bmxlc3MgaXQgaGFzIG5vIGZyb20gb3IgZnJvbSA9IHVzZXIncyBKSUQuCiAgICAgICAgaWYgKGZyb20gJiYgZnJvbSAhPT0gIiIgJiYgZnJvbSAhPSB0aGlzLl9jb25uZWN0aW9uLmppZCAmJiBmcm9tICE9IFN0cm9waGUuZ2V0QmFyZUppZEZyb21KaWQodGhpcy5fY29ubmVjdGlvbi5qaWQpKQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB2YXIgaXFyZXN1bHQgPSAkaXEoe3R5cGU6ICdyZXN1bHQnLCBpZDogaWQsIGZyb206IHRoaXMuX2Nvbm5lY3Rpb24uamlkfSk7CiAgICAgICAgdGhpcy5fY29ubmVjdGlvbi5zZW5kKGlxcmVzdWx0KTsKICAgICAgICB0aGlzLl91cGRhdGVJdGVtcyhpcSk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX3VwZGF0ZUl0ZW1zCiAgICAgKiBVcGRhdGUgaXRlbXMgZnJvbSBpcQogICAgICovCiAgICBfdXBkYXRlSXRlbXMgOiBmdW5jdGlvbihpcSkKICAgIHsKICAgICAgICB2YXIgcXVlcnkgPSBpcS5nZXRFbGVtZW50c0J5VGFnTmFtZSgncXVlcnknKTsKICAgICAgICBpZiAocXVlcnkubGVuZ3RoICE9PSAwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy52ZXIgPSBxdWVyeS5pdGVtKDApLmdldEF0dHJpYnV0ZSgndmVyJyk7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgICAgU3Ryb3BoZS5mb3JFYWNoQ2hpbGQocXVlcnkuaXRlbSgwKSwgJ2l0ZW0nLAogICAgICAgICAgICAgICAgZnVuY3Rpb24gKGl0ZW0pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fdXBkYXRlSXRlbShpdGVtKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICB0aGlzLl9jYWxsX2JhY2tzKHRoaXMuaXRlbXMpOwogICAgfSwKICAgIC8qKiBQcml2YXRlRnVuY3Rpb246IF91cGRhdGVJdGVtCiAgICAgKiBVcGRhdGUgaW50ZXJuYWwgcmVwcmVzZW50YXRpb24gb2Ygcm9zdGVyIGl0ZW0KICAgICAqLwogICAgX3VwZGF0ZUl0ZW0gOiBmdW5jdGlvbihpdGVtKQogICAgewogICAgICAgIHZhciBqaWQgICAgICAgICAgID0gaXRlbS5nZXRBdHRyaWJ1dGUoImppZCIpOwogICAgICAgIHZhciBuYW1lICAgICAgICAgID0gaXRlbS5nZXRBdHRyaWJ1dGUoIm5hbWUiKTsKICAgICAgICB2YXIgc3Vic2NyaXB0aW9uICA9IGl0ZW0uZ2V0QXR0cmlidXRlKCJzdWJzY3JpcHRpb24iKTsKICAgICAgICB2YXIgYXNrICAgICAgICAgICA9IGl0ZW0uZ2V0QXR0cmlidXRlKCJhc2siKTsKICAgICAgICB2YXIgZ3JvdXBzICAgICAgICA9IFtdOwogICAgICAgIFN0cm9waGUuZm9yRWFjaENoaWxkKGl0ZW0sICdncm91cCcsCiAgICAgICAgICAgIGZ1bmN0aW9uKGdyb3VwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBncm91cHMucHVzaChTdHJvcGhlLmdldFRleHQoZ3JvdXApKTsKICAgICAgICAgICAgfQogICAgICAgICk7CgogICAgICAgIGlmIChzdWJzY3JpcHRpb24gPT0gInJlbW92ZSIpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnJlbW92ZUl0ZW0oamlkKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaXRlbSA9IHRoaXMuZmluZEl0ZW0oamlkKTsKICAgICAgICBpZiAoIWl0ZW0pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLml0ZW1zLnB1c2goewogICAgICAgICAgICAgICAgbmFtZSAgICAgICAgIDogbmFtZSwKICAgICAgICAgICAgICAgIGppZCAgICAgICAgICA6IGppZCwKICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbiA6IHN1YnNjcmlwdGlvbiwKICAgICAgICAgICAgICAgIGFzayAgICAgICAgICA6IGFzaywKICAgICAgICAgICAgICAgIGdyb3VwcyAgICAgICA6IGdyb3VwcywKICAgICAgICAgICAgICAgIHJlc291cmNlcyAgICA6IHt9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpdGVtLm5hbWUgPSBuYW1lOwogICAgICAgICAgICBpdGVtLnN1YnNjcmlwdGlvbiA9IHN1YnNjcmlwdGlvbjsKICAgICAgICAgICAgaXRlbS5hc2sgPSBhc2s7CiAgICAgICAgICAgIGl0ZW0uZ3JvdXBzID0gZ3JvdXBzOwogICAgICAgIH0KICAgIH0KfSk7CgpkZWZpbmUoInN0cm9waGUucm9zdGVyIiwgWyJzdHJvcGhlIl0sIGZ1bmN0aW9uKCl7fSk7CgovLyBHZW5lcmF0ZWQgYnkgQ29mZmVlU2NyaXB0IDEuMy4zCi8qClBsdWdpbiB0byBpbXBsZW1lbnQgdGhlIHZDYXJkIGV4dGVuc2lvbi4KaHR0cDovL3htcHAub3JnL2V4dGVuc2lvbnMveGVwLTAwNTQuaHRtbAoKQXV0aG9yOiBOYXRoYW4gWm9ybiAobmF0aGFuLnpvcm5AZ21haWwuY29tKQpDb2ZmZWVTY3JpcHQgcG9ydDogQW5kcmVhcyBHdXRoIChndXRoQGRiaXMucnd0aC1hYWNoZW4uZGUpCiovCgovKiBqc2xpbnQgY29uZmlndXJhdGlvbjoKKi8KCi8qIGdsb2JhbCBkb2N1bWVudCwgd2luZG93LCBzZXRUaW1lb3V0LCBjbGVhclRpbWVvdXQsIGNvbnNvbGUsCiAgICBYTUxIdHRwUmVxdWVzdCwgQWN0aXZlWE9iamVjdCwKICAgIEJhc2U2NCwgTUQ1LAogICAgU3Ryb3BoZSwgJGJ1aWxkLCAkbXNnLCAkaXEsICRwcmVzCiovCgp2YXIgYnVpbGRJcTsKCmJ1aWxkSXEgPSBmdW5jdGlvbih0eXBlLCBqaWQsIHZDYXJkRWwpIHsKICB2YXIgaXE7CiAgaXEgPSAkaXEoamlkID8gewogICAgdHlwZTogdHlwZSwKICAgIHRvOiBqaWQKICB9IDogewogICAgdHlwZTogdHlwZQogIH0pOwogIGlxLmMoInZDYXJkIiwgewogICAgeG1sbnM6IFN0cm9waGUuTlMuVkNBUkQKICB9KTsKICBpZiAodkNhcmRFbCkgewogICAgaXEuY25vZGUodkNhcmRFbCk7CiAgfQogIHJldHVybiBpcTsKfTsKClN0cm9waGUuYWRkQ29ubmVjdGlvblBsdWdpbigndmNhcmQnLCB7CiAgX2Nvbm5lY3Rpb246IG51bGwsCiAgaW5pdDogZnVuY3Rpb24oY29ubikgewogICAgdGhpcy5fY29ubmVjdGlvbiA9IGNvbm47CiAgICByZXR1cm4gU3Ryb3BoZS5hZGROYW1lc3BhY2UoJ1ZDQVJEJywgJ3ZjYXJkLXRlbXAnKTsKICB9LAogIC8qRnVuY3Rpb24KICAgIFJldHJpZXZlIGEgdkNhcmQgZm9yIGEgSklEL0VudGl0eQogICAgUGFyYW1ldGVyczoKICAgIChGdW5jdGlvbikgaGFuZGxlcl9jYiAtIFRoZSBjYWxsYmFjayBmdW5jdGlvbiB1c2VkIHRvIGhhbmRsZSB0aGUgcmVxdWVzdC4KICAgIChTdHJpbmcpIGppZCAtIG9wdGlvbmFsIC0gVGhlIG5hbWUgb2YgdGhlIGVudGl0eSB0byByZXF1ZXN0IHRoZSB2Q2FyZAogICAgICAgSWYgbm8gamlkIGlzIGdpdmVuLCB0aGlzIGZ1bmN0aW9uIHJldHJpZXZlcyB0aGUgY3VycmVudCB1c2VyJ3MgdmNhcmQuCiAgKi8KCiAgZ2V0OiBmdW5jdGlvbihoYW5kbGVyX2NiLCBqaWQsIGVycm9yX2NiKSB7CiAgICB2YXIgaXE7CiAgICBpcSA9IGJ1aWxkSXEoImdldCIsIGppZCk7CiAgICByZXR1cm4gdGhpcy5fY29ubmVjdGlvbi5zZW5kSVEoaXEsIGhhbmRsZXJfY2IsIGVycm9yX2NiKTsKICB9LAogIC8qIEZ1bmN0aW9uCiAgICAgIFNldCBhbiBlbnRpdHkncyB2Q2FyZC4KICAqLwoKICBzZXQ6IGZ1bmN0aW9uKGhhbmRsZXJfY2IsIHZDYXJkRWwsIGppZCwgZXJyb3JfY2IpIHsKICAgIHZhciBpcTsKICAgIGlxID0gYnVpbGRJcSgic2V0IiwgamlkLCB2Q2FyZEVsKTsKICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW9uLnNlbmRJUShpcSwgaGFuZGxlcl9jYiwgZXJyb3JfcmIpOwogIH0KfSk7CgpkZWZpbmUoInN0cm9waGUudmNhcmQiLCBbInN0cm9waGUiXSwgZnVuY3Rpb24oKXt9KTsKCi8qCiAgQ29weXJpZ2h0IDIwMTAsIEZyYW7Dp29pcyBkZSBNZXR6IDxmcmFuY29pc0AybWV0ei5mcj4KKi8KCi8qKgogKiBEaXNjbyBTdHJvcGhlIFBsdWdpbgogKiBJbXBsZW1lbnQgaHR0cDovL3htcHAub3JnL2V4dGVuc2lvbnMveGVwLTAwMzAuaHRtbAogKiBUT0RPOiBtYW5hZ2Ugbm9kZSBoaWVyYXJjaGllcywgYW5kIG5vZGUgb24gaW5mbyByZXF1ZXN0CiAqLwpTdHJvcGhlLmFkZENvbm5lY3Rpb25QbHVnaW4oJ2Rpc2NvJywKewogICAgX2Nvbm5lY3Rpb246IG51bGwsCiAgICBfaWRlbnRpdGllcyA6IFtdLAogICAgX2ZlYXR1cmVzIDogW10sCiAgICBfaXRlbXMgOiBbXSwKICAgIC8qKiBGdW5jdGlvbjogaW5pdAogICAgICogUGx1Z2luIGluaXQKICAgICAqCiAgICAgKiBQYXJhbWV0ZXJzOgogICAgICogICAoU3Ryb3BoZS5Db25uZWN0aW9uKSBjb25uIC0gU3Ryb3BoZSBjb25uZWN0aW9uCiAgICAgKi8KICAgIGluaXQ6IGZ1bmN0aW9uKGNvbm4pCiAgICB7CiAgICB0aGlzLl9jb25uZWN0aW9uID0gY29ubjsKICAgICAgICB0aGlzLl9pZGVudGl0aWVzID0gW107CiAgICAgICAgdGhpcy5fZmVhdHVyZXMgICA9IFtdOwogICAgICAgIHRoaXMuX2l0ZW1zICAgICAgPSBbXTsKICAgICAgICAvLyBkaXNjbyBpbmZvCiAgICAgICAgY29ubi5hZGRIYW5kbGVyKHRoaXMuX29uRGlzY29JbmZvLmJpbmQodGhpcyksIFN0cm9waGUuTlMuRElTQ09fSU5GTywgJ2lxJywgJ2dldCcsIG51bGwsIG51bGwpOwogICAgICAgIC8vIGRpc2NvIGl0ZW1zCiAgICAgICAgY29ubi5hZGRIYW5kbGVyKHRoaXMuX29uRGlzY29JdGVtcy5iaW5kKHRoaXMpLCBTdHJvcGhlLk5TLkRJU0NPX0lURU1TLCAnaXEnLCAnZ2V0JywgbnVsbCwgbnVsbCk7CiAgICB9LAogICAgLyoqIEZ1bmN0aW9uOiBhZGRJZGVudGl0eQogICAgICogU2VlIGh0dHA6Ly94bXBwLm9yZy9yZWdpc3RyYXIvZGlzY28tY2F0ZWdvcmllcy5odG1sCiAgICAgKiBQYXJhbWV0ZXJzOgogICAgICogICAoU3RyaW5nKSBjYXRlZ29yeSAtIGNhdGVnb3J5IG9mIGlkZW50aXR5IChsaWtlIGNsaWVudCwgYXV0b21hdGlvbiwgZXRjIC4uLikKICAgICAqICAgKFN0cmluZykgdHlwZSAtIHR5cGUgb2YgaWRlbnRpdHkgKGxpa2UgcGMsIHdlYiwgYm90ICwgZXRjIC4uLikKICAgICAqICAgKFN0cmluZykgbmFtZSAtIG5hbWUgb2YgaWRlbnRpdHkgaW4gbmF0dXJhbCBsYW5ndWFnZQogICAgICogICAoU3RyaW5nKSBsYW5nIC0gbGFuZyBvZiBuYW1lIHBhcmFtZXRlcgogICAgICoKICAgICAqIFJldHVybnM6CiAgICAgKiAgIEJvb2xlYW4KICAgICAqLwogICAgYWRkSWRlbnRpdHk6IGZ1bmN0aW9uKGNhdGVnb3J5LCB0eXBlLCBuYW1lLCBsYW5nKQogICAgewogICAgICAgIGZvciAodmFyIGk9MDsgaTx0aGlzLl9pZGVudGl0aWVzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2lkZW50aXRpZXNbaV0uY2F0ZWdvcnkgPT0gY2F0ZWdvcnkgJiYKICAgICAgICAgICAgICAgIHRoaXMuX2lkZW50aXRpZXNbaV0udHlwZSA9PSB0eXBlICYmCiAgICAgICAgICAgICAgICB0aGlzLl9pZGVudGl0aWVzW2ldLm5hbWUgPT0gbmFtZSAmJgogICAgICAgICAgICAgICAgdGhpcy5faWRlbnRpdGllc1tpXS5sYW5nID09IGxhbmcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLl9pZGVudGl0aWVzLnB1c2goe2NhdGVnb3J5OiBjYXRlZ29yeSwgdHlwZTogdHlwZSwgbmFtZTogbmFtZSwgbGFuZzogbGFuZ30pOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAgIC8qKiBGdW5jdGlvbjogYWRkRmVhdHVyZQogICAgICoKICAgICAqIFBhcmFtZXRlcnM6CiAgICAgKiAgIChTdHJpbmcpIHZhcl9uYW1lIC0gZmVhdHVyZSBuYW1lIChsaWtlIGphYmJlcjppcTp2ZXJzaW9uKQogICAgICoKICAgICAqIFJldHVybnM6CiAgICAgKiAgIGJvb2xlYW4KICAgICAqLwogICAgYWRkRmVhdHVyZTogZnVuY3Rpb24odmFyX25hbWUpCiAgICB7CiAgICAgICAgZm9yICh2YXIgaT0wOyBpPHRoaXMuX2ZlYXR1cmVzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgIGlmICh0aGlzLl9mZWF0dXJlc1tpXSA9PSB2YXJfbmFtZSkKICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHRoaXMuX2ZlYXR1cmVzLnB1c2godmFyX25hbWUpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAgIC8qKiBGdW5jdGlvbjogcmVtb3ZlRmVhdHVyZQogICAgICoKICAgICAqIFBhcmFtZXRlcnM6CiAgICAgKiAgIChTdHJpbmcpIHZhcl9uYW1lIC0gZmVhdHVyZSBuYW1lIChsaWtlIGphYmJlcjppcTp2ZXJzaW9uKQogICAgICoKICAgICAqIFJldHVybnM6CiAgICAgKiAgIGJvb2xlYW4KICAgICAqLwogICAgcmVtb3ZlRmVhdHVyZTogZnVuY3Rpb24odmFyX25hbWUpCiAgICB7CiAgICAgICAgZm9yICh2YXIgaT0wOyBpPHRoaXMuX2ZlYXR1cmVzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgIGlmICh0aGlzLl9mZWF0dXJlc1tpXSA9PT0gdmFyX25hbWUpewogICAgICAgICAgICAgICAgIHRoaXMuX2ZlYXR1cmVzLnNwbGljZShpLDEpCiAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCiAgICAvKiogRnVuY3Rpb246IGFkZEl0ZW0KICAgICAqCiAgICAgKiBQYXJhbWV0ZXJzOgogICAgICogICAoU3RyaW5nKSBqaWQKICAgICAqICAgKFN0cmluZykgbmFtZQogICAgICogICAoU3RyaW5nKSBub2RlCiAgICAgKiAgIChGdW5jdGlvbikgY2FsbF9iYWNrCiAgICAgKgogICAgICogUmV0dXJuczoKICAgICAqICAgYm9vbGVhbgogICAgICovCiAgICBhZGRJdGVtOiBmdW5jdGlvbihqaWQsIG5hbWUsIG5vZGUsIGNhbGxfYmFjaykKICAgIHsKICAgICAgICBpZiAobm9kZSAmJiAhY2FsbF9iYWNrKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgdGhpcy5faXRlbXMucHVzaCh7amlkOiBqaWQsIG5hbWU6IG5hbWUsIG5vZGU6IG5vZGUsIGNhbGxfYmFjazogY2FsbF9iYWNrfSk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAogICAgLyoqIEZ1bmN0aW9uOiBpbmZvCiAgICAgKiBJbmZvIHF1ZXJ5CiAgICAgKgogICAgICogUGFyYW1ldGVyczoKICAgICAqICAgKEZ1bmN0aW9uKSBjYWxsX2JhY2sKICAgICAqICAgKFN0cmluZykgamlkCiAgICAgKiAgIChTdHJpbmcpIG5vZGUKICAgICAqLwogICAgaW5mbzogZnVuY3Rpb24oamlkLCBub2RlLCBzdWNjZXNzLCBlcnJvciwgdGltZW91dCkKICAgIHsKICAgICAgICB2YXIgYXR0cnMgPSB7eG1sbnM6IFN0cm9waGUuTlMuRElTQ09fSU5GT307CiAgICAgICAgaWYgKG5vZGUpCiAgICAgICAgICAgIGF0dHJzLm5vZGUgPSBub2RlOwoKICAgICAgICB2YXIgaW5mbyA9ICRpcSh7ZnJvbTp0aGlzLl9jb25uZWN0aW9uLmppZCwKICAgICAgICAgICAgICAgICAgICAgICAgIHRvOmppZCwgdHlwZTonZ2V0J30pLmMoJ3F1ZXJ5JywgYXR0cnMpOwogICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZElRKGluZm8sIHN1Y2Nlc3MsIGVycm9yLCB0aW1lb3V0KTsKICAgIH0sCiAgICAvKiogRnVuY3Rpb246IGl0ZW1zCiAgICAgKiBJdGVtcyBxdWVyeQogICAgICoKICAgICAqIFBhcmFtZXRlcnM6CiAgICAgKiAgIChGdW5jdGlvbikgY2FsbF9iYWNrCiAgICAgKiAgIChTdHJpbmcpIGppZAogICAgICogICAoU3RyaW5nKSBub2RlCiAgICAgKi8KICAgIGl0ZW1zOiBmdW5jdGlvbihqaWQsIG5vZGUsIHN1Y2Nlc3MsIGVycm9yLCB0aW1lb3V0KQogICAgewogICAgICAgIHZhciBhdHRycyA9IHt4bWxuczogU3Ryb3BoZS5OUy5ESVNDT19JVEVNU307CiAgICAgICAgaWYgKG5vZGUpCiAgICAgICAgICAgIGF0dHJzLm5vZGUgPSBub2RlOwoKICAgICAgICB2YXIgaXRlbXMgPSAkaXEoe2Zyb206dGhpcy5fY29ubmVjdGlvbi5qaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICB0bzpqaWQsIHR5cGU6J2dldCd9KS5jKCdxdWVyeScsIGF0dHJzKTsKICAgICAgICB0aGlzLl9jb25uZWN0aW9uLnNlbmRJUShpdGVtcywgc3VjY2VzcywgZXJyb3IsIHRpbWVvdXQpOwogICAgfSwKCiAgICAvKiogUHJpdmF0ZUZ1bmN0aW9uOiBfYnVpbGRJUVJlc3VsdAogICAgICovCiAgICBfYnVpbGRJUVJlc3VsdDogZnVuY3Rpb24oc3RhbnphLCBxdWVyeV9hdHRycykKICAgIHsKICAgICAgICB2YXIgaWQgICA9ICBzdGFuemEuZ2V0QXR0cmlidXRlKCdpZCcpOwogICAgICAgIHZhciBmcm9tID0gc3RhbnphLmdldEF0dHJpYnV0ZSgnZnJvbScpOwogICAgICAgIHZhciBpcXJlc3VsdCA9ICRpcSh7dHlwZTogJ3Jlc3VsdCcsIGlkOiBpZH0pOwoKICAgICAgICBpZiAoZnJvbSAhPT0gbnVsbCkgewogICAgICAgICAgICBpcXJlc3VsdC5hdHRycyh7dG86IGZyb219KTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBpcXJlc3VsdC5jKCdxdWVyeScsIHF1ZXJ5X2F0dHJzKTsKICAgIH0sCgogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX29uRGlzY29JbmZvCiAgICAgKiBDYWxsZWQgd2hlbiByZWNlaXZlIGluZm8gcmVxdWVzdAogICAgICovCiAgICBfb25EaXNjb0luZm86IGZ1bmN0aW9uKHN0YW56YSkKICAgIHsKICAgICAgICB2YXIgbm9kZSA9IHN0YW56YS5nZXRFbGVtZW50c0J5VGFnTmFtZSgncXVlcnknKVswXS5nZXRBdHRyaWJ1dGUoJ25vZGUnKTsKICAgICAgICB2YXIgYXR0cnMgPSB7eG1sbnM6IFN0cm9waGUuTlMuRElTQ09fSU5GT307CiAgICAgICAgaWYgKG5vZGUpCiAgICAgICAgewogICAgICAgICAgICBhdHRycy5ub2RlID0gbm9kZTsKICAgICAgICB9CiAgICAgICAgdmFyIGlxcmVzdWx0ID0gdGhpcy5fYnVpbGRJUVJlc3VsdChzdGFuemEsIGF0dHJzKTsKICAgICAgICBmb3IgKHZhciBpPTA7IGk8dGhpcy5faWRlbnRpdGllcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBhdHRycyA9IHtjYXRlZ29yeTogdGhpcy5faWRlbnRpdGllc1tpXS5jYXRlZ29yeSwKICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgICAgOiB0aGlzLl9pZGVudGl0aWVzW2ldLnR5cGV9OwogICAgICAgICAgICBpZiAodGhpcy5faWRlbnRpdGllc1tpXS5uYW1lKQogICAgICAgICAgICAgICAgYXR0cnMubmFtZSA9IHRoaXMuX2lkZW50aXRpZXNbaV0ubmFtZTsKICAgICAgICAgICAgaWYgKHRoaXMuX2lkZW50aXRpZXNbaV0ubGFuZykKICAgICAgICAgICAgICAgIGF0dHJzWyd4bWw6bGFuZyddID0gdGhpcy5faWRlbnRpdGllc1tpXS5sYW5nOwogICAgICAgICAgICBpcXJlc3VsdC5jKCdpZGVudGl0eScsIGF0dHJzKS51cCgpOwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBpPTA7IGk8dGhpcy5fZmVhdHVyZXMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpcXJlc3VsdC5jKCdmZWF0dXJlJywgeyd2YXInOnRoaXMuX2ZlYXR1cmVzW2ldfSkudXAoKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fY29ubmVjdGlvbi5zZW5kKGlxcmVzdWx0LnRyZWUoKSk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAogICAgLyoqIFByaXZhdGVGdW5jdGlvbjogX29uRGlzY29JdGVtcwogICAgICogQ2FsbGVkIHdoZW4gcmVjZWl2ZSBpdGVtcyByZXF1ZXN0CiAgICAgKi8KICAgIF9vbkRpc2NvSXRlbXM6IGZ1bmN0aW9uKHN0YW56YSkKICAgIHsKICAgICAgICB2YXIgcXVlcnlfYXR0cnMgPSB7eG1sbnM6IFN0cm9waGUuTlMuRElTQ09fSVRFTVN9OwogICAgICAgIHZhciBub2RlID0gc3RhbnphLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdxdWVyeScpWzBdLmdldEF0dHJpYnV0ZSgnbm9kZScpOwogICAgICAgIGlmIChub2RlKQogICAgICAgIHsKICAgICAgICAgICAgcXVlcnlfYXR0cnMubm9kZSA9IG5vZGU7CiAgICAgICAgICAgIHZhciBpdGVtcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX2l0ZW1zLmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5faXRlbXNbaV0ubm9kZSA9PSBub2RlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGl0ZW1zID0gdGhpcy5faXRlbXNbaV0uY2FsbF9iYWNrKHN0YW56YSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGl0ZW1zID0gdGhpcy5faXRlbXM7CiAgICAgICAgfQogICAgICAgIHZhciBpcXJlc3VsdCA9IHRoaXMuX2J1aWxkSVFSZXN1bHQoc3RhbnphLCBxdWVyeV9hdHRycyk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBhdHRycyA9IHtqaWQ6ICBpdGVtc1tpXS5qaWR9OwogICAgICAgICAgICBpZiAoaXRlbXNbaV0ubmFtZSkKICAgICAgICAgICAgICAgIGF0dHJzLm5hbWUgPSBpdGVtc1tpXS5uYW1lOwogICAgICAgICAgICBpZiAoaXRlbXNbaV0ubm9kZSkKICAgICAgICAgICAgICAgIGF0dHJzLm5vZGUgPSBpdGVtc1tpXS5ub2RlOwogICAgICAgICAgICBpcXJlc3VsdC5jKCdpdGVtJywgYXR0cnMpLnVwKCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZChpcXJlc3VsdC50cmVlKCkpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQp9KTsKCmRlZmluZSgic3Ryb3BoZS5kaXNjbyIsIFsic3Ryb3BoZSJdLCBmdW5jdGlvbigpe30pOwoKZGVmaW5lKCJjb252ZXJzZS1kZXBlbmRlbmNpZXMiLCBbCiAgICAianF1ZXJ5IiwKICAgICJ1dGlscyIsCiAgICAibW9tZW50IiwKICAgICJsb2NhbGVzIiwKICAgICJiYWNrYm9uZS5icm93c2VyU3RvcmFnZSIsCiAgICAiYmFja2JvbmUub3ZlcnZpZXciLAogICAgImpxdWVyeS5icm93c2VyIiwKICAgICJ0eXBlYWhlYWQiLAogICAgInN0cm9waGUiLAogICAgInN0cm9waGUubXVjIiwKICAgICJzdHJvcGhlLnJvc3RlciIsCiAgICAic3Ryb3BoZS52Y2FyZCIsCiAgICAic3Ryb3BoZS5kaXNjbyIKXSwgZnVuY3Rpb24oJCwgdXRpbHMsIG1vbWVudCkgewogICAgcmV0dXJuIHsKICAgICAgICAnalF1ZXJ5JzogJCwKICAgICAgICAnb3RyJzogdW5kZWZpbmVkLAogICAgICAgICdtb21lbnQnOiBtb21lbnQsCiAgICAgICAgJ3V0aWxzJzogdXRpbHMKICAgIH07Cn0pOwoKLyoqCiAqIEBsaWNlbnNlIFJlcXVpcmVKUyB0ZXh0IDIuMC4xMiBDb3B5cmlnaHQgKGMpIDIwMTAtMjAxNCwgVGhlIERvam8gRm91bmRhdGlvbiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKiBBdmFpbGFibGUgdmlhIHRoZSBNSVQgb3IgbmV3IEJTRCBsaWNlbnNlLgogKiBzZWU6IGh0dHA6Ly9naXRodWIuY29tL3JlcXVpcmVqcy90ZXh0IGZvciBkZXRhaWxzCiAqLwovKmpzbGludCByZWdleHA6IHRydWUgKi8KLypnbG9iYWwgcmVxdWlyZSwgWE1MSHR0cFJlcXVlc3QsIEFjdGl2ZVhPYmplY3QsCiAgZGVmaW5lLCB3aW5kb3csIHByb2Nlc3MsIFBhY2thZ2VzLAogIGphdmEsIGxvY2F0aW9uLCBDb21wb25lbnRzLCBGaWxlVXRpbHMgKi8KCmRlZmluZSgndGV4dCcsWydtb2R1bGUnXSwgZnVuY3Rpb24gKG1vZHVsZSkgewogICAgCgogICAgdmFyIHRleHQsIGZzLCBDYywgQ2ksIHhwY0lzV2luZG93cywKICAgICAgICBwcm9nSWRzID0gWydNc3htbDIuWE1MSFRUUCcsICdNaWNyb3NvZnQuWE1MSFRUUCcsICdNc3htbDIuWE1MSFRUUC40LjAnXSwKICAgICAgICB4bWxSZWdFeHAgPSAvXlxzKjxcP3htbChccykrdmVyc2lvbj1bXCdcIl0oXGQpKi4oXGQpKltcJ1wiXShccykqXD8+L2ltLAogICAgICAgIGJvZHlSZWdFeHAgPSAvPGJvZHlbXj5dKj5ccyooW1xzXFNdKylccyo8XC9ib2R5Pi9pbSwKICAgICAgICBoYXNMb2NhdGlvbiA9IHR5cGVvZiBsb2NhdGlvbiAhPT0gJ3VuZGVmaW5lZCcgJiYgbG9jYXRpb24uaHJlZiwKICAgICAgICBkZWZhdWx0UHJvdG9jb2wgPSBoYXNMb2NhdGlvbiAmJiBsb2NhdGlvbi5wcm90b2NvbCAmJiBsb2NhdGlvbi5wcm90b2NvbC5yZXBsYWNlKC9cOi8sICcnKSwKICAgICAgICBkZWZhdWx0SG9zdE5hbWUgPSBoYXNMb2NhdGlvbiAmJiBsb2NhdGlvbi5ob3N0bmFtZSwKICAgICAgICBkZWZhdWx0UG9ydCA9IGhhc0xvY2F0aW9uICYmIChsb2NhdGlvbi5wb3J0IHx8IHVuZGVmaW5lZCksCiAgICAgICAgYnVpbGRNYXAgPSB7fSwKICAgICAgICBtYXN0ZXJDb25maWcgPSAobW9kdWxlLmNvbmZpZyAmJiBtb2R1bGUuY29uZmlnKCkpIHx8IHt9OwoKICAgIHRleHQgPSB7CiAgICAgICAgdmVyc2lvbjogJzIuMC4xMicsCgogICAgICAgIHN0cmlwOiBmdW5jdGlvbiAoY29udGVudCkgewogICAgICAgICAgICAvL1N0cmlwcyA8P3htbCAuLi4/PiBkZWNsYXJhdGlvbnMgc28gdGhhdCBleHRlcm5hbCBTVkcgYW5kIFhNTAogICAgICAgICAgICAvL2RvY3VtZW50cyBjYW4gYmUgYWRkZWQgdG8gYSBkb2N1bWVudCB3aXRob3V0IHdvcnJ5LiBBbHNvLCBpZiB0aGUgc3RyaW5nCiAgICAgICAgICAgIC8vaXMgYW4gSFRNTCBkb2N1bWVudCwgb25seSB0aGUgcGFydCBpbnNpZGUgdGhlIGJvZHkgdGFnIGlzIHJldHVybmVkLgogICAgICAgICAgICBpZiAoY29udGVudCkgewogICAgICAgICAgICAgICAgY29udGVudCA9IGNvbnRlbnQucmVwbGFjZSh4bWxSZWdFeHAsICIiKTsKICAgICAgICAgICAgICAgIHZhciBtYXRjaGVzID0gY29udGVudC5tYXRjaChib2R5UmVnRXhwKTsKICAgICAgICAgICAgICAgIGlmIChtYXRjaGVzKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGVudCA9IG1hdGNoZXNbMV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb250ZW50ID0gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNvbnRlbnQ7CiAgICAgICAgfSwKCiAgICAgICAganNFc2NhcGU6IGZ1bmN0aW9uIChjb250ZW50KSB7CiAgICAgICAgICAgIHJldHVybiBjb250ZW50LnJlcGxhY2UoLyhbJ1xcXSkvZywgJ1xcJDEnKQogICAgICAgICAgICAgICAgLnJlcGxhY2UoL1tcZl0vZywgIlxcZiIpCiAgICAgICAgICAgICAgICAucmVwbGFjZSgvW1xiXS9nLCAiXFxiIikKICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9bXG5dL2csICJcXG4iKQogICAgICAgICAgICAgICAgLnJlcGxhY2UoL1tcdF0vZywgIlxcdCIpCiAgICAgICAgICAgICAgICAucmVwbGFjZSgvW1xyXS9nLCAiXFxyIikKICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9bXHUyMDI4XS9nLCAiXFx1MjAyOCIpCiAgICAgICAgICAgICAgICAucmVwbGFjZSgvW1x1MjAyOV0vZywgIlxcdTIwMjkiKTsKICAgICAgICB9LAoKICAgICAgICBjcmVhdGVYaHI6IG1hc3RlckNvbmZpZy5jcmVhdGVYaHIgfHwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvL1dvdWxkIGxvdmUgdG8gZHVtcCB0aGUgQWN0aXZlWCBjcmFwIGluIGhlcmUuIE5lZWQgSUUgNiB0byBkaWUgZmlyc3QuCiAgICAgICAgICAgIHZhciB4aHIsIGksIHByb2dJZDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBYTUxIdHRwUmVxdWVzdCAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgQWN0aXZlWE9iamVjdCAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCAzOyBpICs9IDEpIHsKICAgICAgICAgICAgICAgICAgICBwcm9nSWQgPSBwcm9nSWRzW2ldOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHhociA9IG5ldyBBY3RpdmVYT2JqZWN0KHByb2dJZCk7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge30KCiAgICAgICAgICAgICAgICAgICAgaWYgKHhocikgewogICAgICAgICAgICAgICAgICAgICAgICBwcm9nSWRzID0gW3Byb2dJZF07ICAvLyBzbyBmYXN0ZXIgbmV4dCB0aW1lCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHhocjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBQYXJzZXMgYSByZXNvdXJjZSBuYW1lIGludG8gaXRzIGNvbXBvbmVudCBwYXJ0cy4gUmVzb3VyY2UgbmFtZXMKICAgICAgICAgKiBsb29rIGxpa2U6IG1vZHVsZS9uYW1lLmV4dCFzdHJpcCwgd2hlcmUgdGhlICFzdHJpcCBwYXJ0IGlzCiAgICAgICAgICogb3B0aW9uYWwuCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgdGhlIHJlc291cmNlIG5hbWUKICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSB3aXRoIHByb3BlcnRpZXMgIm1vZHVsZU5hbWUiLCAiZXh0IiBhbmQgInN0cmlwIgogICAgICAgICAqIHdoZXJlIHN0cmlwIGlzIGEgYm9vbGVhbi4KICAgICAgICAgKi8KICAgICAgICBwYXJzZU5hbWU6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciBtb2ROYW1lLCBleHQsIHRlbXAsCiAgICAgICAgICAgICAgICBzdHJpcCA9IGZhbHNlLAogICAgICAgICAgICAgICAgaW5kZXggPSBuYW1lLmluZGV4T2YoIi4iKSwKICAgICAgICAgICAgICAgIGlzUmVsYXRpdmUgPSBuYW1lLmluZGV4T2YoJy4vJykgPT09IDAgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lLmluZGV4T2YoJy4uLycpID09PSAwOwoKICAgICAgICAgICAgaWYgKGluZGV4ICE9PSAtMSAmJiAoIWlzUmVsYXRpdmUgfHwgaW5kZXggPiAxKSkgewogICAgICAgICAgICAgICAgbW9kTmFtZSA9IG5hbWUuc3Vic3RyaW5nKDAsIGluZGV4KTsKICAgICAgICAgICAgICAgIGV4dCA9IG5hbWUuc3Vic3RyaW5nKGluZGV4ICsgMSwgbmFtZS5sZW5ndGgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbW9kTmFtZSA9IG5hbWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRlbXAgPSBleHQgfHwgbW9kTmFtZTsKICAgICAgICAgICAgaW5kZXggPSB0ZW1wLmluZGV4T2YoIiEiKTsKICAgICAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICAgICAgICAgICAgLy9QdWxsIG9mZiB0aGUgc3RyaXAgYXJnLgogICAgICAgICAgICAgICAgc3RyaXAgPSB0ZW1wLnN1YnN0cmluZyhpbmRleCArIDEpID09PSAic3RyaXAiOwogICAgICAgICAgICAgICAgdGVtcCA9IHRlbXAuc3Vic3RyaW5nKDAsIGluZGV4KTsKICAgICAgICAgICAgICAgIGlmIChleHQpIHsKICAgICAgICAgICAgICAgICAgICBleHQgPSB0ZW1wOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtb2ROYW1lID0gdGVtcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIG1vZHVsZU5hbWU6IG1vZE5hbWUsCiAgICAgICAgICAgICAgICBleHQ6IGV4dCwKICAgICAgICAgICAgICAgIHN0cmlwOiBzdHJpcAogICAgICAgICAgICB9OwogICAgICAgIH0sCgogICAgICAgIHhkUmVnRXhwOiAvXigoXHcrKVw6KT9cL1wvKFteXC9cXF0rKS8sCgogICAgICAgIC8qKgogICAgICAgICAqIElzIGFuIFVSTCBvbiBhbm90aGVyIGRvbWFpbi4gT25seSB3b3JrcyBmb3IgYnJvd3NlciB1c2UsIHJldHVybnMKICAgICAgICAgKiBmYWxzZSBpbiBub24tYnJvd3NlciBlbnZpcm9ubWVudHMuIE9ubHkgdXNlZCB0byBrbm93IGlmIGFuCiAgICAgICAgICogb3B0aW1pemVkIC5qcyB2ZXJzaW9uIG9mIGEgdGV4dCByZXNvdXJjZSBzaG91bGQgYmUgbG9hZGVkCiAgICAgICAgICogaW5zdGVhZC4KICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdXJsCiAgICAgICAgICogQHJldHVybnMgQm9vbGVhbgogICAgICAgICAqLwogICAgICAgIHVzZVhocjogZnVuY3Rpb24gKHVybCwgcHJvdG9jb2wsIGhvc3RuYW1lLCBwb3J0KSB7CiAgICAgICAgICAgIHZhciB1UHJvdG9jb2wsIHVIb3N0TmFtZSwgdVBvcnQsCiAgICAgICAgICAgICAgICBtYXRjaCA9IHRleHQueGRSZWdFeHAuZXhlYyh1cmwpOwogICAgICAgICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB1UHJvdG9jb2wgPSBtYXRjaFsyXTsKICAgICAgICAgICAgdUhvc3ROYW1lID0gbWF0Y2hbM107CgogICAgICAgICAgICB1SG9zdE5hbWUgPSB1SG9zdE5hbWUuc3BsaXQoJzonKTsKICAgICAgICAgICAgdVBvcnQgPSB1SG9zdE5hbWVbMV07CiAgICAgICAgICAgIHVIb3N0TmFtZSA9IHVIb3N0TmFtZVswXTsKCiAgICAgICAgICAgIHJldHVybiAoIXVQcm90b2NvbCB8fCB1UHJvdG9jb2wgPT09IHByb3RvY29sKSAmJgogICAgICAgICAgICAgICAgICAgKCF1SG9zdE5hbWUgfHwgdUhvc3ROYW1lLnRvTG93ZXJDYXNlKCkgPT09IGhvc3RuYW1lLnRvTG93ZXJDYXNlKCkpICYmCiAgICAgICAgICAgICAgICAgICAoKCF1UG9ydCAmJiAhdUhvc3ROYW1lKSB8fCB1UG9ydCA9PT0gcG9ydCk7CiAgICAgICAgfSwKCiAgICAgICAgZmluaXNoTG9hZDogZnVuY3Rpb24gKG5hbWUsIHN0cmlwLCBjb250ZW50LCBvbkxvYWQpIHsKICAgICAgICAgICAgY29udGVudCA9IHN0cmlwID8gdGV4dC5zdHJpcChjb250ZW50KSA6IGNvbnRlbnQ7CiAgICAgICAgICAgIGlmIChtYXN0ZXJDb25maWcuaXNCdWlsZCkgewogICAgICAgICAgICAgICAgYnVpbGRNYXBbbmFtZV0gPSBjb250ZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9uTG9hZChjb250ZW50KTsKICAgICAgICB9LAoKICAgICAgICBsb2FkOiBmdW5jdGlvbiAobmFtZSwgcmVxLCBvbkxvYWQsIGNvbmZpZykgewogICAgICAgICAgICAvL05hbWUgaGFzIGZvcm1hdDogc29tZS5tb2R1bGUuZmlsZXh0IXN0cmlwCiAgICAgICAgICAgIC8vVGhlIHN0cmlwIHBhcnQgaXMgb3B0aW9uYWwuCiAgICAgICAgICAgIC8vaWYgc3RyaXAgaXMgcHJlc2VudCwgdGhlbiB0aGF0IG1lYW5zIG9ubHkgZ2V0IHRoZSBzdHJpbmcgY29udGVudHMKICAgICAgICAgICAgLy9pbnNpZGUgYSBib2R5IHRhZyBpbiBhbiBIVE1MIHN0cmluZy4gRm9yIFhNTC9TVkcgY29udGVudCBpdCBtZWFucwogICAgICAgICAgICAvL3JlbW92aW5nIHRoZSA8P3htbCAuLi4/PiBkZWNsYXJhdGlvbnMgc28gdGhlIGNvbnRlbnQgY2FuIGJlIGluc2VydGVkCiAgICAgICAgICAgIC8vaW50byB0aGUgY3VycmVudCBkb2Mgd2l0aG91dCBwcm9ibGVtcy4KCiAgICAgICAgICAgIC8vIERvIG5vdCBib3RoZXIgd2l0aCB0aGUgd29yayBpZiBhIGJ1aWxkIGFuZCB0ZXh0IHdpbGwKICAgICAgICAgICAgLy8gbm90IGJlIGlubGluZWQuCiAgICAgICAgICAgIGlmIChjb25maWcgJiYgY29uZmlnLmlzQnVpbGQgJiYgIWNvbmZpZy5pbmxpbmVUZXh0KSB7CiAgICAgICAgICAgICAgICBvbkxvYWQoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbWFzdGVyQ29uZmlnLmlzQnVpbGQgPSBjb25maWcgJiYgY29uZmlnLmlzQnVpbGQ7CgogICAgICAgICAgICB2YXIgcGFyc2VkID0gdGV4dC5wYXJzZU5hbWUobmFtZSksCiAgICAgICAgICAgICAgICBub25TdHJpcE5hbWUgPSBwYXJzZWQubW9kdWxlTmFtZSArCiAgICAgICAgICAgICAgICAgICAgKHBhcnNlZC5leHQgPyAnLicgKyBwYXJzZWQuZXh0IDogJycpLAogICAgICAgICAgICAgICAgdXJsID0gcmVxLnRvVXJsKG5vblN0cmlwTmFtZSksCiAgICAgICAgICAgICAgICB1c2VYaHIgPSAobWFzdGVyQ29uZmlnLnVzZVhocikgfHwKICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQudXNlWGhyOwoKICAgICAgICAgICAgLy8gRG8gbm90IGxvYWQgaWYgaXQgaXMgYW4gZW1wdHk6IHVybAogICAgICAgICAgICBpZiAodXJsLmluZGV4T2YoJ2VtcHR5OicpID09PSAwKSB7CiAgICAgICAgICAgICAgICBvbkxvYWQoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy9Mb2FkIHRoZSB0ZXh0LiBVc2UgWEhSIGlmIHBvc3NpYmxlIGFuZCBpbiBhIGJyb3dzZXIuCiAgICAgICAgICAgIGlmICghaGFzTG9jYXRpb24gfHwgdXNlWGhyKHVybCwgZGVmYXVsdFByb3RvY29sLCBkZWZhdWx0SG9zdE5hbWUsIGRlZmF1bHRQb3J0KSkgewogICAgICAgICAgICAgICAgdGV4dC5nZXQodXJsLCBmdW5jdGlvbiAoY29udGVudCkgewogICAgICAgICAgICAgICAgICAgIHRleHQuZmluaXNoTG9hZChuYW1lLCBwYXJzZWQuc3RyaXAsIGNvbnRlbnQsIG9uTG9hZCk7CiAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9uTG9hZC5lcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICBvbkxvYWQuZXJyb3IoZXJyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vTmVlZCB0byBmZXRjaCB0aGUgcmVzb3VyY2UgYWNyb3NzIGRvbWFpbnMuIEFzc3VtZQogICAgICAgICAgICAgICAgLy90aGUgcmVzb3VyY2UgaGFzIGJlZW4gb3B0aW1pemVkIGludG8gYSBKUyBtb2R1bGUuIEZldGNoCiAgICAgICAgICAgICAgICAvL2J5IHRoZSBtb2R1bGUgbmFtZSArIGV4dGVuc2lvbiwgYnV0IGRvIG5vdCBpbmNsdWRlIHRoZQogICAgICAgICAgICAgICAgLy8hc3RyaXAgcGFydCB0byBhdm9pZCBmaWxlIHN5c3RlbSBpc3N1ZXMuCiAgICAgICAgICAgICAgICByZXEoW25vblN0cmlwTmFtZV0sIGZ1bmN0aW9uIChjb250ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGV4dC5maW5pc2hMb2FkKHBhcnNlZC5tb2R1bGVOYW1lICsgJy4nICsgcGFyc2VkLmV4dCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VkLnN0cmlwLCBjb250ZW50LCBvbkxvYWQpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICB3cml0ZTogZnVuY3Rpb24gKHBsdWdpbk5hbWUsIG1vZHVsZU5hbWUsIHdyaXRlLCBjb25maWcpIHsKICAgICAgICAgICAgaWYgKGJ1aWxkTWFwLmhhc093blByb3BlcnR5KG1vZHVsZU5hbWUpKSB7CiAgICAgICAgICAgICAgICB2YXIgY29udGVudCA9IHRleHQuanNFc2NhcGUoYnVpbGRNYXBbbW9kdWxlTmFtZV0pOwogICAgICAgICAgICAgICAgd3JpdGUuYXNNb2R1bGUocGx1Z2luTmFtZSArICIhIiArIG1vZHVsZU5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVmaW5lKGZ1bmN0aW9uICgpIHsgcmV0dXJuICciICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50ICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICInO30pO1xuIik7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICB3cml0ZUZpbGU6IGZ1bmN0aW9uIChwbHVnaW5OYW1lLCBtb2R1bGVOYW1lLCByZXEsIHdyaXRlLCBjb25maWcpIHsKICAgICAgICAgICAgdmFyIHBhcnNlZCA9IHRleHQucGFyc2VOYW1lKG1vZHVsZU5hbWUpLAogICAgICAgICAgICAgICAgZXh0UGFydCA9IHBhcnNlZC5leHQgPyAnLicgKyBwYXJzZWQuZXh0IDogJycsCiAgICAgICAgICAgICAgICBub25TdHJpcE5hbWUgPSBwYXJzZWQubW9kdWxlTmFtZSArIGV4dFBhcnQsCiAgICAgICAgICAgICAgICAvL1VzZSBhICcuanMnIGZpbGUgbmFtZSBzbyB0aGF0IGl0IGluZGljYXRlcyBpdCBpcyBhCiAgICAgICAgICAgICAgICAvL3NjcmlwdCB0aGF0IGNhbiBiZSBsb2FkZWQgYWNyb3NzIGRvbWFpbnMuCiAgICAgICAgICAgICAgICBmaWxlTmFtZSA9IHJlcS50b1VybChwYXJzZWQubW9kdWxlTmFtZSArIGV4dFBhcnQpICsgJy5qcyc7CgogICAgICAgICAgICAvL0xldmVyYWdlIG93biBsb2FkKCkgbWV0aG9kIHRvIGxvYWQgcGx1Z2luIHZhbHVlLCBidXQgb25seQogICAgICAgICAgICAvL3dyaXRlIG91dCB2YWx1ZXMgdGhhdCBkbyBub3QgaGF2ZSB0aGUgc3RyaXAgYXJndW1lbnQsCiAgICAgICAgICAgIC8vdG8gYXZvaWQgYW55IHBvdGVudGlhbCBpc3N1ZXMgd2l0aCAhIGluIGZpbGUgbmFtZXMuCiAgICAgICAgICAgIHRleHQubG9hZChub25TdHJpcE5hbWUsIHJlcSwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAvL1VzZSBvd24gd3JpdGUoKSBtZXRob2QgdG8gY29uc3RydWN0IGZ1bGwgbW9kdWxlIHZhbHVlLgogICAgICAgICAgICAgICAgLy9CdXQgbmVlZCB0byBjcmVhdGUgc2hlbGwgdGhhdCB0cmFuc2xhdGVzIHdyaXRlRmlsZSdzCiAgICAgICAgICAgICAgICAvL3dyaXRlKCkgdG8gdGhlIHJpZ2h0IGludGVyZmFjZS4KICAgICAgICAgICAgICAgIHZhciB0ZXh0V3JpdGUgPSBmdW5jdGlvbiAoY29udGVudHMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd3JpdGUoZmlsZU5hbWUsIGNvbnRlbnRzKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB0ZXh0V3JpdGUuYXNNb2R1bGUgPSBmdW5jdGlvbiAobW9kdWxlTmFtZSwgY29udGVudHMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd3JpdGUuYXNNb2R1bGUobW9kdWxlTmFtZSwgZmlsZU5hbWUsIGNvbnRlbnRzKTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgdGV4dC53cml0ZShwbHVnaW5OYW1lLCBub25TdHJpcE5hbWUsIHRleHRXcml0ZSwgY29uZmlnKTsKICAgICAgICAgICAgfSwgY29uZmlnKTsKICAgICAgICB9CiAgICB9OwoKICAgIGlmIChtYXN0ZXJDb25maWcuZW52ID09PSAnbm9kZScgfHwgKCFtYXN0ZXJDb25maWcuZW52ICYmCiAgICAgICAgICAgIHR5cGVvZiBwcm9jZXNzICE9PSAidW5kZWZpbmVkIiAmJgogICAgICAgICAgICBwcm9jZXNzLnZlcnNpb25zICYmCiAgICAgICAgICAgICEhcHJvY2Vzcy52ZXJzaW9ucy5ub2RlICYmCiAgICAgICAgICAgICFwcm9jZXNzLnZlcnNpb25zWydub2RlLXdlYmtpdCddKSkgewogICAgICAgIC8vVXNpbmcgc3BlY2lhbCByZXF1aXJlLm5vZGVSZXF1aXJlLCBzb21ldGhpbmcgYWRkZWQgYnkgci5qcy4KICAgICAgICBmcyA9IHJlcXVpcmUubm9kZVJlcXVpcmUoJ2ZzJyk7CgogICAgICAgIHRleHQuZ2V0ID0gZnVuY3Rpb24gKHVybCwgY2FsbGJhY2ssIGVycmJhY2spIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHZhciBmaWxlID0gZnMucmVhZEZpbGVTeW5jKHVybCwgJ3V0ZjgnKTsKICAgICAgICAgICAgICAgIC8vUmVtb3ZlIEJPTSAoQnl0ZSBNYXJrIE9yZGVyKSBmcm9tIHV0ZjggZmlsZXMgaWYgaXQgaXMgdGhlcmUuCiAgICAgICAgICAgICAgICBpZiAoZmlsZS5pbmRleE9mKCdcdUZFRkYnKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGZpbGUgPSBmaWxlLnN1YnN0cmluZygxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZpbGUpOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBpZiAoZXJyYmFjaykgewogICAgICAgICAgICAgICAgICAgIGVycmJhY2soZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfSBlbHNlIGlmIChtYXN0ZXJDb25maWcuZW52ID09PSAneGhyJyB8fCAoIW1hc3RlckNvbmZpZy5lbnYgJiYKICAgICAgICAgICAgdGV4dC5jcmVhdGVYaHIoKSkpIHsKICAgICAgICB0ZXh0LmdldCA9IGZ1bmN0aW9uICh1cmwsIGNhbGxiYWNrLCBlcnJiYWNrLCBoZWFkZXJzKSB7CiAgICAgICAgICAgIHZhciB4aHIgPSB0ZXh0LmNyZWF0ZVhocigpLCBoZWFkZXI7CiAgICAgICAgICAgIHhoci5vcGVuKCdHRVQnLCB1cmwsIHRydWUpOwoKICAgICAgICAgICAgLy9BbGxvdyBwbHVnaW5zIGRpcmVjdCBhY2Nlc3MgdG8geGhyIGhlYWRlcnMKICAgICAgICAgICAgaWYgKGhlYWRlcnMpIHsKICAgICAgICAgICAgICAgIGZvciAoaGVhZGVyIGluIGhlYWRlcnMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaGVhZGVycy5oYXNPd25Qcm9wZXJ0eShoZWFkZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGhlYWRlci50b0xvd2VyQ2FzZSgpLCBoZWFkZXJzW2hlYWRlcl0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy9BbGxvdyBvdmVycmlkZXMgc3BlY2lmaWVkIGluIGNvbmZpZwogICAgICAgICAgICBpZiAobWFzdGVyQ29uZmlnLm9uWGhyKSB7CiAgICAgICAgICAgICAgICBtYXN0ZXJDb25maWcub25YaHIoeGhyLCB1cmwpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKGV2dCkgewogICAgICAgICAgICAgICAgdmFyIHN0YXR1cywgZXJyOwogICAgICAgICAgICAgICAgLy9EbyBub3QgZXhwbGljaXRseSBoYW5kbGUgZXJyb3JzLCB0aG9zZSBzaG91bGQgYmUKICAgICAgICAgICAgICAgIC8vdmlzaWJsZSB2aWEgY29uc29sZSBvdXRwdXQgaW4gdGhlIGJyb3dzZXIuCiAgICAgICAgICAgICAgICBpZiAoeGhyLnJlYWR5U3RhdGUgPT09IDQpIHsKICAgICAgICAgICAgICAgICAgICBzdGF0dXMgPSB4aHIuc3RhdHVzIHx8IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXR1cyA+IDM5OSAmJiBzdGF0dXMgPCA2MDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy9BbiBodHRwIDR4eCBvciA1eHggZXJyb3IuIFNpZ25hbCBhbiBlcnJvci4KICAgICAgICAgICAgICAgICAgICAgICAgZXJyID0gbmV3IEVycm9yKHVybCArICcgSFRUUCBzdGF0dXM6ICcgKyBzdGF0dXMpOwogICAgICAgICAgICAgICAgICAgICAgICBlcnIueGhyID0geGhyOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyYmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyYmFjayhlcnIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soeGhyLnJlc3BvbnNlVGV4dCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAobWFzdGVyQ29uZmlnLm9uWGhyQ29tcGxldGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWFzdGVyQ29uZmlnLm9uWGhyQ29tcGxldGUoeGhyLCB1cmwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgeGhyLnNlbmQobnVsbCk7CiAgICAgICAgfTsKICAgIH0gZWxzZSBpZiAobWFzdGVyQ29uZmlnLmVudiA9PT0gJ3JoaW5vJyB8fCAoIW1hc3RlckNvbmZpZy5lbnYgJiYKICAgICAgICAgICAgdHlwZW9mIFBhY2thZ2VzICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgamF2YSAhPT0gJ3VuZGVmaW5lZCcpKSB7CiAgICAgICAgLy9XaHkgSmF2YSwgd2h5IGlzIHRoaXMgc28gYXdrd2FyZD8KICAgICAgICB0ZXh0LmdldCA9IGZ1bmN0aW9uICh1cmwsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBzdHJpbmdCdWZmZXIsIGxpbmUsCiAgICAgICAgICAgICAgICBlbmNvZGluZyA9ICJ1dGYtOCIsCiAgICAgICAgICAgICAgICBmaWxlID0gbmV3IGphdmEuaW8uRmlsZSh1cmwpLAogICAgICAgICAgICAgICAgbGluZVNlcGFyYXRvciA9IGphdmEubGFuZy5TeXN0ZW0uZ2V0UHJvcGVydHkoImxpbmUuc2VwYXJhdG9yIiksCiAgICAgICAgICAgICAgICBpbnB1dCA9IG5ldyBqYXZhLmlvLkJ1ZmZlcmVkUmVhZGVyKG5ldyBqYXZhLmlvLklucHV0U3RyZWFtUmVhZGVyKG5ldyBqYXZhLmlvLkZpbGVJbnB1dFN0cmVhbShmaWxlKSwgZW5jb2RpbmcpKSwKICAgICAgICAgICAgICAgIGNvbnRlbnQgPSAnJzsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHN0cmluZ0J1ZmZlciA9IG5ldyBqYXZhLmxhbmcuU3RyaW5nQnVmZmVyKCk7CiAgICAgICAgICAgICAgICBsaW5lID0gaW5wdXQucmVhZExpbmUoKTsKCiAgICAgICAgICAgICAgICAvLyBCeXRlIE9yZGVyIE1hcmsgKEJPTSkgLSBUaGUgVW5pY29kZSBTdGFuZGFyZCwgdmVyc2lvbiAzLjAsIHBhZ2UgMzI0CiAgICAgICAgICAgICAgICAvLyBodHRwOi8vd3d3LnVuaWNvZGUub3JnL2ZhcS91dGZfYm9tLmh0bWwKCiAgICAgICAgICAgICAgICAvLyBOb3RlIHRoYXQgd2hlbiB3ZSB1c2UgdXRmLTgsIHRoZSBCT00gc2hvdWxkIGFwcGVhciBhcyAiRUYgQkIgQkYiLCBidXQgaXQgZG9lc24ndCBkdWUgdG8gdGhpcyBidWcgaW4gdGhlIEpESzoKICAgICAgICAgICAgICAgIC8vIGh0dHA6Ly9idWdzLnN1bi5jb20vYnVnZGF0YWJhc2Uvdmlld19idWcuZG8/YnVnX2lkPTQ1MDgwNTgKICAgICAgICAgICAgICAgIGlmIChsaW5lICYmIGxpbmUubGVuZ3RoKCkgJiYgbGluZS5jaGFyQXQoMCkgPT09IDB4ZmVmZikgewogICAgICAgICAgICAgICAgICAgIC8vIEVhdCB0aGUgQk9NLCBzaW5jZSB3ZSd2ZSBhbHJlYWR5IGZvdW5kIHRoZSBlbmNvZGluZyBvbiB0aGlzIGZpbGUsCiAgICAgICAgICAgICAgICAgICAgLy8gYW5kIHdlIHBsYW4gdG8gY29uY2F0ZW5hdGluZyB0aGlzIGJ1ZmZlciB3aXRoIG90aGVyczsgdGhlIEJPTSBzaG91bGQKICAgICAgICAgICAgICAgICAgICAvLyBvbmx5IGFwcGVhciBhdCB0aGUgdG9wIG9mIGEgZmlsZS4KICAgICAgICAgICAgICAgICAgICBsaW5lID0gbGluZS5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGxpbmUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzdHJpbmdCdWZmZXIuYXBwZW5kKGxpbmUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHdoaWxlICgobGluZSA9IGlucHV0LnJlYWRMaW5lKCkpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgc3RyaW5nQnVmZmVyLmFwcGVuZChsaW5lU2VwYXJhdG9yKTsKICAgICAgICAgICAgICAgICAgICBzdHJpbmdCdWZmZXIuYXBwZW5kKGxpbmUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy9NYWtlIHN1cmUgd2UgcmV0dXJuIGEgSmF2YVNjcmlwdCBzdHJpbmcgYW5kIG5vdCBhIEphdmEgc3RyaW5nLgogICAgICAgICAgICAgICAgY29udGVudCA9IFN0cmluZyhzdHJpbmdCdWZmZXIudG9TdHJpbmcoKSk7IC8vU3RyaW5nCiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBpbnB1dC5jbG9zZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhbGxiYWNrKGNvbnRlbnQpOwogICAgICAgIH07CiAgICB9IGVsc2UgaWYgKG1hc3RlckNvbmZpZy5lbnYgPT09ICd4cGNvbm5lY3QnIHx8ICghbWFzdGVyQ29uZmlnLmVudiAmJgogICAgICAgICAgICB0eXBlb2YgQ29tcG9uZW50cyAhPT0gJ3VuZGVmaW5lZCcgJiYgQ29tcG9uZW50cy5jbGFzc2VzICYmCiAgICAgICAgICAgIENvbXBvbmVudHMuaW50ZXJmYWNlcykpIHsKICAgICAgICAvL0F2ZXJ0IHlvdXIgZ2F6ZSEKICAgICAgICBDYyA9IENvbXBvbmVudHMuY2xhc3NlczsKICAgICAgICBDaSA9IENvbXBvbmVudHMuaW50ZXJmYWNlczsKICAgICAgICBDb21wb25lbnRzLnV0aWxzWydpbXBvcnQnXSgncmVzb3VyY2U6Ly9ncmUvbW9kdWxlcy9GaWxlVXRpbHMuanNtJyk7CiAgICAgICAgeHBjSXNXaW5kb3dzID0gKCdAbW96aWxsYS5vcmcvd2luZG93cy1yZWdpc3RyeS1rZXk7MScgaW4gQ2MpOwoKICAgICAgICB0ZXh0LmdldCA9IGZ1bmN0aW9uICh1cmwsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBpblN0cmVhbSwgY29udmVydFN0cmVhbSwgZmlsZU9iaiwKICAgICAgICAgICAgICAgIHJlYWREYXRhID0ge307CgogICAgICAgICAgICBpZiAoeHBjSXNXaW5kb3dzKSB7CiAgICAgICAgICAgICAgICB1cmwgPSB1cmwucmVwbGFjZSgvXC8vZywgJ1xcJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZpbGVPYmogPSBuZXcgRmlsZVV0aWxzLkZpbGUodXJsKTsKCiAgICAgICAgICAgIC8vWFBDT00sIHlvdSBzbyBjcmF6eQogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaW5TdHJlYW0gPSBDY1snQG1vemlsbGEub3JnL25ldHdvcmsvZmlsZS1pbnB1dC1zdHJlYW07MSddCiAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jcmVhdGVJbnN0YW5jZShDaS5uc0lGaWxlSW5wdXRTdHJlYW0pOwogICAgICAgICAgICAgICAgaW5TdHJlYW0uaW5pdChmaWxlT2JqLCAxLCAwLCBmYWxzZSk7CgogICAgICAgICAgICAgICAgY29udmVydFN0cmVhbSA9IENjWydAbW96aWxsYS5vcmcvaW50bC9jb252ZXJ0ZXItaW5wdXQtc3RyZWFtOzEnXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jcmVhdGVJbnN0YW5jZShDaS5uc0lDb252ZXJ0ZXJJbnB1dFN0cmVhbSk7CiAgICAgICAgICAgICAgICBjb252ZXJ0U3RyZWFtLmluaXQoaW5TdHJlYW0sICJ1dGYtOCIsIGluU3RyZWFtLmF2YWlsYWJsZSgpLAogICAgICAgICAgICAgICAgQ2kubnNJQ29udmVydGVySW5wdXRTdHJlYW0uREVGQVVMVF9SRVBMQUNFTUVOVF9DSEFSQUNURVIpOwoKICAgICAgICAgICAgICAgIGNvbnZlcnRTdHJlYW0ucmVhZFN0cmluZyhpblN0cmVhbS5hdmFpbGFibGUoKSwgcmVhZERhdGEpOwogICAgICAgICAgICAgICAgY29udmVydFN0cmVhbS5jbG9zZSgpOwogICAgICAgICAgICAgICAgaW5TdHJlYW0uY2xvc2UoKTsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKHJlYWREYXRhLnZhbHVlKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKChmaWxlT2JqICYmIGZpbGVPYmoucGF0aCB8fCAnJykgKyAnOiAnICsgZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfQogICAgcmV0dXJuIHRleHQ7Cn0pOwoKLy8gUmVxdWlyZUpTIFVuZGVyc2NvcmVKUyB0ZW1wbGF0ZSBwbHVnaW4KLy8gaHR0cDovL2dpdGh1Yi5jb20vamZwYXJhZGlzL3JlcXVpcmVqcy10cGwKLy8KLy8gQW4gYWx0ZXJuYXRpdmUgdG8gaHR0cDovL2dpdGh1Yi5jb20vWmVlQWdlbmN5L3JlcXVpcmVqcy10cGwKLy8KLy8gVXNpbmcgVW5kZXJzY29yZUpTIG1pY3JvLXRlbXBsYXRlcyBhdCBodHRwOi8vdW5kZXJzY29yZWpzLm9yZy8jdGVtcGxhdGUKLy8gVXNpbmcgYW5kIFJlcXVpcmVKUyB0ZXh0LmpzIGF0IGh0dHA6Ly9yZXF1aXJlanMub3JnL2RvY3MvYXBpLmh0bWwjdGV4dAovLyBAYXV0aG9yIEpGIFBhcmFkaXMKLy8gQHZlcnNpb24gMC4wLjIKLy8KLy8gUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlCi8vCi8vIFVzYWdlOgovLyAgIHJlcXVpcmUoWydiYWNrYm9uZScsICd0cGwhbXl0ZW1wbGF0ZSddLCBmdW5jdGlvbiAoQmFja2JvbmUsIG15dGVtcGxhdGUpIHsKLy8gICAgIHJldHVybiBCYWNrYm9uZS5WaWV3LmV4dGVuZCh7Ci8vICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7Ci8vICAgICAgICAgdGhpcy5yZW5kZXIoKTsKLy8gICAgICAgfSwKLy8gICAgICAgcmVuZGVyOiBmdW5jdGlvbigpewovLyAgICAgICAgIHRoaXMuJGVsLmh0bWwobXl0ZW1wbGF0ZSh7bWVzc2FnZTogJ2hlbGxvJ30pKTsKLy8gICAgIH0pOwovLyAgIH0pOwovLwovLyBDb25maWd1cmF0aW9uOiAob3B0aW9uYWwpCi8vICAgcmVxdWlyZS5jb25maWcoewovLyAgICAgdHBsOiB7Ci8vICAgICAgIGV4dGVuc2lvbjogJy50cGwnIC8vIGRlZmF1bHQgPSAnLmh0bWwnCi8vICAgICB9Ci8vICAgfSk7CgovKmpzbGludCBub21lbjogdHJ1ZSAqLwovKmdsb2JhbCBkZWZpbmU6IGZhbHNlICovCgpkZWZpbmUoJ3RwbCcsWyd0ZXh0JywgJ3VuZGVyc2NvcmUnXSwgZnVuY3Rpb24gKHRleHQsIF8pIHsKICAgIAoKICAgIHZhciBidWlsZE1hcCA9IHt9LAogICAgICAgIGJ1aWxkVGVtcGxhdGVTb3VyY2UgPSAiZGVmaW5lKCd7cGx1Z2luTmFtZX0he21vZHVsZU5hbWV9JywgZnVuY3Rpb24gKCkgeyByZXR1cm4ge3NvdXJjZX07IH0pO1xuIjsKCiAgICByZXR1cm4gewogICAgICAgIHZlcnNpb246ICcwLjAuMicsCgogICAgICAgIGxvYWQ6IGZ1bmN0aW9uIChtb2R1bGVOYW1lLCBwYXJlbnRSZXF1aXJlLCBvbmxvYWQsIGNvbmZpZykgewoKICAgICAgICAgICAgaWYgKGNvbmZpZy50cGwgJiYgY29uZmlnLnRwbC50ZW1wbGF0ZVNldHRpbmdzKSB7CiAgICAgICAgICAgICAgICBfLnRlbXBsYXRlU2V0dGluZ3MgPSBjb25maWcudHBsLnRlbXBsYXRlU2V0dGluZ3M7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChidWlsZE1hcFttb2R1bGVOYW1lXSkgewogICAgICAgICAgICAgICAgb25sb2FkKGJ1aWxkTWFwW21vZHVsZU5hbWVdKTsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgZXh0ID0gKGNvbmZpZy50cGwgJiYgY29uZmlnLnRwbC5leHRlbnNpb24pIHx8ICcuaHRtbCc7CiAgICAgICAgICAgICAgICB2YXIgcGF0aCA9IChjb25maWcudHBsICYmIGNvbmZpZy50cGwucGF0aCkgfHwgJyc7CiAgICAgICAgICAgICAgICB0ZXh0LmxvYWQocGF0aCArIG1vZHVsZU5hbWUgKyBleHQsIHBhcmVudFJlcXVpcmUsIGZ1bmN0aW9uIChzb3VyY2UpIHsKICAgICAgICAgICAgICAgICAgICBidWlsZE1hcFttb2R1bGVOYW1lXSA9IF8udGVtcGxhdGUoc291cmNlKTsKICAgICAgICAgICAgICAgICAgICBvbmxvYWQoYnVpbGRNYXBbbW9kdWxlTmFtZV0pOwogICAgICAgICAgICAgICAgfSwgY29uZmlnKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHdyaXRlOiBmdW5jdGlvbiAocGx1Z2luTmFtZSwgbW9kdWxlTmFtZSwgd3JpdGUpIHsKICAgICAgICAgICAgdmFyIGJ1aWxkID0gYnVpbGRNYXBbbW9kdWxlTmFtZV0sCiAgICAgICAgICAgICAgICBzb3VyY2UgPSBidWlsZCAmJiBidWlsZC5zb3VyY2U7CiAgICAgICAgICAgIGlmIChzb3VyY2UpIHsKICAgICAgICAgICAgICAgIHdyaXRlLmFzTW9kdWxlKHBsdWdpbk5hbWUgKyAnIScgKyBtb2R1bGVOYW1lLAogICAgICAgICAgICAgICAgICAgIGJ1aWxkVGVtcGxhdGVTb3VyY2UKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgne3BsdWdpbk5hbWV9JywgcGx1Z2luTmFtZSkKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgne21vZHVsZU5hbWV9JywgbW9kdWxlTmFtZSkKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgne3NvdXJjZX0nLCBzb3VyY2UpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07Cn0pOwoKCmRlZmluZSgndHBsIWFjdGlvbicsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8ZGl2IGNsYXNzPSJjaGF0LW1lc3NhZ2UgJysKKChfX3Q9KGV4dHJhX2NsYXNzZXMpKT09bnVsbD8nJzpfX3QpKwonIj5cbiAgICA8c3BhbiBjbGFzcz0iY2hhdC1tZXNzYWdlLScrCigoX190PShzZW5kZXIpKT09bnVsbD8nJzpfX3QpKwonIj4nKwooKF9fdD0odGltZSkpPT1udWxsPycnOl9fdCkrCicgKionKwooKF9fdD0odXNlcm5hbWUpKT09bnVsbD8nJzpfX3QpKwonIDwvc3Bhbj5cbiAgICA8c3BhbiBjbGFzcz0iY2hhdC1tZXNzYWdlLWNvbnRlbnQiPicrCigoX190PShtZXNzYWdlKSk9PW51bGw/Jyc6X190KSsKJzwvc3Bhbj5cbjwvZGl2PlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFhZGRfY29udGFjdF9kcm9wZG93bicsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8ZGwgY2xhc3M9ImFkZC1jb252ZXJzZS1jb250YWN0IGRyb3Bkb3duIj5cbiAgICA8ZHQgaWQ9InhtcHAtY29udGFjdC1zZWFyY2giIGNsYXNzPSJmYW5jeS1kcm9wZG93biI+XG4gICAgICAgIDxhIGNsYXNzPSJ0b2dnbGUteG1wcC1jb250YWN0LWZvcm0iIGhyZWY9IiMiXG4gICAgICAgICAgICB0aXRsZT0iJysKKChfX3Q9KGxhYmVsX2NsaWNrX3RvX2NoYXQpKT09bnVsbD8nJzpfX3QpKwonIj5cbiAgICAgICAgPHNwYW4gY2xhc3M9Imljb24tcGx1cyI+PC9zcGFuPicrCigoX190PShsYWJlbF9hZGRfY29udGFjdCkpPT1udWxsPycnOl9fdCkrCic8L2E+XG4gICAgPC9kdD5cbiAgICA8ZGQgY2xhc3M9InNlYXJjaC14bXBwIiBzdHlsZT0iZGlzcGxheTpub25lIj48dWw+PC91bD48L2RkPlxuPC9kbD5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhYWRkX2NvbnRhY3RfZm9ybScsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8bGk+XG4gICAgPGZvcm0gY2xhc3M9ImFkZC14bXBwLWNvbnRhY3QiPlxuICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCJcbiAgICAgICAgICAgIG5hbWU9ImlkZW50aWZpZXIiXG4gICAgICAgICAgICBjbGFzcz0idXNlcm5hbWUiXG4gICAgICAgICAgICBwbGFjZWhvbGRlcj0iJysKKChfX3Q9KGxhYmVsX2NvbnRhY3RfdXNlcm5hbWUpKT09bnVsbD8nJzpfX3QpKwonIi8+XG4gICAgICAgIDxidXR0b24gdHlwZT0ic3VibWl0Ij4nKwooKF9fdD0obGFiZWxfYWRkKSk9PW51bGw/Jyc6X190KSsKJzwvYnV0dG9uPlxuICAgIDwvZm9ybT5cbjwvbGk+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIWNoYW5nZV9zdGF0dXNfbWVzc2FnZScsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8Zm9ybSBpZD0ic2V0LWN1c3RvbS14bXBwLXN0YXR1cyI+XG4gICAgPGlucHV0IHR5cGU9InRleHQiIGNsYXNzPSJjdXN0b20teG1wcC1zdGF0dXMiICcrCigoX190PShzdGF0dXNfbWVzc2FnZSkpPT1udWxsPycnOl9fdCkrCidcbiAgICAgICAgcGxhY2Vob2xkZXI9IicrCigoX190PShsYWJlbF9jdXN0b21fc3RhdHVzKSk9PW51bGw/Jyc6X190KSsKJyIvPlxuICAgIDxidXR0b24gdHlwZT0ic3VibWl0Ij4nKwooKF9fdD0obGFiZWxfc2F2ZSkpPT1udWxsPycnOl9fdCkrCic8L2J1dHRvbj5cbjwvZm9ybT5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhY2hhdF9zdGF0dXMnLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGRpdiBjbGFzcz0ieG1wcC1zdGF0dXMiPlxuICAgIDxhIGNsYXNzPSJjaG9vc2UteG1wcC1zdGF0dXMgJysKKChfX3Q9KGNoYXRfc3RhdHVzKSk9PW51bGw/Jyc6X190KSsKJyJcbiAgICAgICBkYXRhLXZhbHVlPSInKwooKF9fdD0oc3RhdHVzX21lc3NhZ2UpKT09bnVsbD8nJzpfX3QpKwonIlxuICAgICAgIGhyZWY9IiMiIHRpdGxlPSInKwooKF9fdD0oZGVzY19jaGFuZ2Vfc3RhdHVzKSk9PW51bGw/Jyc6X190KSsKJyI+XG5cbiAgICAgICAgPHNwYW4gY2xhc3M9Imljb24tJysKKChfX3Q9KGNoYXRfc3RhdHVzKSk9PW51bGw/Jyc6X190KSsKJyI+PC9zcGFuPicrCigoX190PShzdGF0dXNfbWVzc2FnZSkpPT1udWxsPycnOl9fdCkrCidcbiAgICA8L2E+XG4gICAgPGEgY2xhc3M9ImNoYW5nZS14bXBwLXN0YXR1cy1tZXNzYWdlIGljb24tcGVuY2lsIlxuICAgICAgICBocmVmPSIjIlxuICAgICAgICB0aXRsZT0iJysKKChfX3Q9KGRlc2NfY3VzdG9tX3N0YXR1cykpPT1udWxsPycnOl9fdCkrCiciPjwvYT5cbjwvZGl2PlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFjaGF0YXJlYScsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8ZGl2IGNsYXNzPSJjaGF0LWFyZWEiPlxuICAgIDxkaXYgY2xhc3M9ImNoYXQtY29udGVudCI+PC9kaXY+XG4gICAgPGZvcm0gY2xhc3M9InNlbmRYTVBQTWVzc2FnZSIgYWN0aW9uPSIiIG1ldGhvZD0icG9zdCI+XG4gICAgICAgICc7CiBpZiAoc2hvd190b29sYmFyKSB7IApfX3ArPSdcbiAgICAgICAgICAgIDx1bCBjbGFzcz0iY2hhdC10b29sYmFyIG5vLXRleHQtc2VsZWN0Ij48L3VsPlxuICAgICAgICAnOwogfSAKX19wKz0nXG4gICAgICAgIDx0ZXh0YXJlYSB0eXBlPSJ0ZXh0IiBjbGFzcz0iY2hhdC10ZXh0YXJlYSIgXG4gICAgICAgICAgICBwbGFjZWhvbGRlcj0iJysKKChfX3Q9KGxhYmVsX21lc3NhZ2UpKT09bnVsbD8nJzpfX3QpKwonIi8+XG4gICAgPC9mb3JtPlxuPC9kaXY+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIWNoYXRib3gnLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGRpdiBjbGFzcz0iYm94LWZseW91dCIgc3R5bGU9ImhlaWdodDogJysKKChfX3Q9KGhlaWdodCkpPT1udWxsPycnOl9fdCkrCidweCI+XG4gICAgPGRpdiBjbGFzcz0iZHJhZ3Jlc2l6ZSBkcmFncmVzaXplLXRtIj48L2Rpdj5cbiAgICA8ZGl2IGNsYXNzPSJjaGF0LWhlYWQgY2hhdC1oZWFkLWNoYXRib3giPlxuICAgICAgICA8YSBjbGFzcz0iY2xvc2UtY2hhdGJveC1idXR0b24gaWNvbi1jbG9zZSI+PC9hPlxuICAgICAgICA8YSBjbGFzcz0idG9nZ2xlLWNoYXRib3gtYnV0dG9uIGljb24tbWludXMiPjwvYT5cbiAgICAgICAgPGRpdiBjbGFzcz0iY2hhdC10aXRsZSI+XG4gICAgICAgICAgICAnOwogaWYgKHVybCkgeyAKX19wKz0nXG4gICAgICAgICAgICAgICAgPGEgaHJlZj0iJysKKChfX3Q9KHVybCkpPT1udWxsPycnOl9fdCkrCiciIHRhcmdldD0iX2JsYW5rIiBjbGFzcz0idXNlciI+XG4gICAgICAgICAgICAnOwogfSAKX19wKz0nXG4gICAgICAgICAgICAgICAgICAgICcrCigoX190PSggZnVsbG5hbWUgKSk9PW51bGw/Jyc6X190KSsKJ1xuICAgICAgICAgICAgJzsKIGlmICh1cmwpIHsgCl9fcCs9J1xuICAgICAgICAgICAgICAgIDwvYT5cbiAgICAgICAgICAgICc7CiB9IApfX3ArPSdcbiAgICAgICAgPC9kaXY+XG4gICAgICAgIDxwIGNsYXNzPSJ1c2VyLWN1c3RvbS1tZXNzYWdlIj48cC8+XG4gICAgPC9kaXY+XG4gICAgPGRpdiBjbGFzcz0iY2hhdC1ib2R5Ij5cbiAgICAgICAgPGRpdiBjbGFzcz0iY2hhdC1jb250ZW50Ij48L2Rpdj5cbiAgICAgICAgPGZvcm0gY2xhc3M9InNlbmRYTVBQTWVzc2FnZSIgYWN0aW9uPSIiIG1ldGhvZD0icG9zdCI+XG4gICAgICAgICAgICAnOwogaWYgKHNob3dfdG9vbGJhcikgeyAKX19wKz0nXG4gICAgICAgICAgICAgICAgPHVsIGNsYXNzPSJjaGF0LXRvb2xiYXIgbm8tdGV4dC1zZWxlY3QiPjwvdWw+XG4gICAgICAgICAgICAnOwogfSAKX19wKz0nXG4gICAgICAgIDx0ZXh0YXJlYVxuICAgICAgICAgICAgdHlwZT0idGV4dCJcbiAgICAgICAgICAgIGNsYXNzPSJjaGF0LXRleHRhcmVhIlxuICAgICAgICAgICAgcGxhY2Vob2xkZXI9IicrCigoX190PShsYWJlbF9wZXJzb25hbF9tZXNzYWdlKSk9PW51bGw/Jyc6X190KSsKJyIvPlxuICAgICAgICA8L2Zvcm0+XG4gICAgPC9kaXY+XG48L2Rpdj5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhY2hhdHJvb20nLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGRpdiBjbGFzcz0iYm94LWZseW91dCIgc3R5bGU9ImhlaWdodDogJysKKChfX3Q9KGhlaWdodCkpPT1udWxsPycnOl9fdCkrCidweCJcbiAgICAnOwogaWYgKG1pbmltaXplZCkgeyAKX19wKz0nIHN0eWxlPSJkaXNwbGF5Om5vbmUiICc7CiB9IApfX3ArPSc+XG4gICAgPGRpdiBjbGFzcz0iZHJhZ3Jlc2l6ZSBkcmFncmVzaXplLXRtIj48L2Rpdj5cbiAgICA8ZGl2IGNsYXNzPSJjaGF0LWhlYWQgY2hhdC1oZWFkLWNoYXRyb29tIj5cbiAgICAgICAgPGEgY2xhc3M9ImNsb3NlLWNoYXRib3gtYnV0dG9uIGljb24tY2xvc2UiPjwvYT5cbiAgICAgICAgPGEgY2xhc3M9InRvZ2dsZS1jaGF0Ym94LWJ1dHRvbiBpY29uLW1pbnVzIj48L2E+XG4gICAgICAgIDxhIGNsYXNzPSJjb25maWd1cmUtY2hhdHJvb20tYnV0dG9uIGljb24td3JlbmNoIiBzdHlsZT0iZGlzcGxheTpub25lIj48L2E+XG4gICAgICAgIDxkaXYgY2xhc3M9ImNoYXQtdGl0bGUiPiAnKwooKF9fdD0oIG5hbWUgKSk9PW51bGw/Jyc6X190KSsKJyA8L2Rpdj5cbiAgICAgICAgPHAgY2xhc3M9ImNoYXRyb29tLXRvcGljIj48cC8+XG4gICAgPC9kaXY+XG4gICAgPGRpdiBjbGFzcz0iY2hhdC1ib2R5Ij48c3BhbiBjbGFzcz0ic3Bpbm5lciBjZW50ZXJlZCIvPjwvZGl2PlxuPC9kaXY+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIWNoYXRyb29tX3Bhc3N3b3JkX2Zvcm0nLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGRpdiBjbGFzcz0iY2hhdHJvb20tZm9ybS1jb250YWluZXIiPlxuICAgIDxmb3JtIGNsYXNzPSJjaGF0cm9vbS1mb3JtIj5cbiAgICAgICAgPGxlZ2VuZD4nKwooKF9fdD0oaGVhZGluZykpPT1udWxsPycnOl9fdCkrCic8L2xlZ2VuZD5cbiAgICAgICAgPGxhYmVsPicrCigoX190PShsYWJlbF9wYXNzd29yZCkpPT1udWxsPycnOl9fdCkrCic8aW5wdXQgdHlwZT0icGFzc3dvcmQiIG5hbWU9InBhc3N3b3JkIi8+PC9sYWJlbD5cbiAgICAgICAgPGlucHV0IHR5cGU9InN1Ym1pdCIgdmFsdWU9IicrCigoX190PShsYWJlbF9zdWJtaXQpKT09bnVsbD8nJzpfX3QpKwonIi8+XG4gICAgPC9mb3JtPlxuPC9kaXY+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIWNoYXRyb29tX3NpZGViYXInLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPCEtLSA8ZGl2IGNsYXNzPSJwYXJ0aWNpcGFudHMiPiAtLT5cbjxmb3JtIGNsYXNzPSJyb29tLWludml0ZSI+XG4gICAgPGlucHV0IGNsYXNzPSJpbnZpdGVkLWNvbnRhY3QiIHBsYWNlaG9sZGVyPSInKwooKF9fdD0obGFiZWxfaW52aXRhdGlvbikpPT1udWxsPycnOl9fdCkrCiciIHR5cGU9InRleHQiLz5cbjwvZm9ybT5cbjxsYWJlbD4nKwooKF9fdD0obGFiZWxfb2NjdXBhbnRzKSk9PW51bGw/Jyc6X190KSsKJzo8L2xhYmVsPlxuPHVsIGNsYXNzPSJwYXJ0aWNpcGFudC1saXN0Ij48L3VsPlxuPCEtLSA8L2Rpdj4gLS0+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIWNoYXRyb29tc190YWInLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGxpPjxhIGNsYXNzPSJzIiBocmVmPSIjY2hhdHJvb21zIj4nKwooKF9fdD0obGFiZWxfcm9vbXMpKT09bnVsbD8nJzpfX3QpKwonPC9hPjwvbGk+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIWNoYXRzX3BhbmVsJywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9JzxkaXYgaWQ9Im1pbmltaXplZC1jaGF0cyI+XG4gICAgPGEgaWQ9InRvZ2dsZS1taW5pbWl6ZWQtY2hhdHMiIGhyZWY9IiMiPjwvYT5cbiAgICA8ZGl2IGNsYXNzPSJtaW5pbWl6ZWQtY2hhdHMtZmx5b3V0Ij48L2Rpdj5cbjwvZGl2PlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFjaG9vc2Vfc3RhdHVzJywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9JzxkbCBpZD0idGFyZ2V0IiBjbGFzcz0iZHJvcGRvd24iPlxuICAgIDxkdCBpZD0iZmFuY3kteG1wcC1zdGF0dXMtc2VsZWN0IiBjbGFzcz0iZmFuY3ktZHJvcGRvd24iPjwvZHQ+XG4gICAgPGRkPjx1bCBjbGFzcz0ieG1wcC1zdGF0dXMtbWVudSI+PC91bD48L2RkPlxuPC9kbD5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhY29udGFjdHNfcGFuZWwnLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGZvcm0gY2xhc3M9InNldC14bXBwLXN0YXR1cyIgYWN0aW9uPSIiIG1ldGhvZD0icG9zdCI+XG4gICAgPHNwYW4gaWQ9InhtcHAtc3RhdHVzLWhvbGRlciI+XG4gICAgICAgIDxzZWxlY3QgaWQ9InNlbGVjdC14bXBwLXN0YXR1cyIgc3R5bGU9ImRpc3BsYXk6bm9uZSI+XG4gICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJvbmxpbmUiPicrCigoX190PShsYWJlbF9vbmxpbmUpKT09bnVsbD8nJzpfX3QpKwonPC9vcHRpb24+XG4gICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJkbmQiPicrCigoX190PShsYWJlbF9idXN5KSk9PW51bGw/Jyc6X190KSsKJzwvb3B0aW9uPlxuICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iYXdheSI+JysKKChfX3Q9KGxhYmVsX2F3YXkpKT09bnVsbD8nJzpfX3QpKwonPC9vcHRpb24+XG4gICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJvZmZsaW5lIj4nKwooKF9fdD0obGFiZWxfb2ZmbGluZSkpPT1udWxsPycnOl9fdCkrCic8L29wdGlvbj5cbiAgICAgICAgICAgICc7CiBpZiAoYWxsb3dfbG9nb3V0KSAgeyAKX19wKz0nXG4gICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJsb2dvdXQiPicrCigoX190PShsYWJlbF9sb2dvdXQpKT09bnVsbD8nJzpfX3QpKwonPC9vcHRpb24+XG4gICAgICAgICAgICAnOwogfSAKX19wKz0nXG4gICAgICAgIDwvc2VsZWN0PlxuICAgIDwvc3Bhbj5cbjwvZm9ybT5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhY29udGFjdHNfdGFiJywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9JzxsaT48YSBjbGFzcz0icyBjdXJyZW50IiBocmVmPSIjdXNlcnMiPicrCigoX190PShsYWJlbF9jb250YWN0cykpPT1udWxsPycnOl9fdCkrCic8L2E+PC9saT5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhY29udHJvbGJveCcsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8ZGl2IGNsYXNzPSJib3gtZmx5b3V0IiBzdHlsZT0iaGVpZ2h0OiAnKwooKF9fdD0oaGVpZ2h0KSk9PW51bGw/Jyc6X190KSsKJ3B4Ij5cbiAgICA8ZGl2IGNsYXNzPSJkcmFncmVzaXplIGRyYWdyZXNpemUtdG0iPjwvZGl2PlxuICAgIDxkaXYgY2xhc3M9ImNoYXQtaGVhZCBjb250cm9sYm94LWhlYWQiPlxuICAgICAgICA8dWwgaWQ9ImNvbnRyb2xib3gtdGFicyI+PC91bD5cbiAgICAgICAgPGEgY2xhc3M9ImNsb3NlLWNoYXRib3gtYnV0dG9uIGljb24tY2xvc2UiPjwvYT5cbiAgICA8L2Rpdj5cbiAgICA8ZGl2IGNsYXNzPSJjb250cm9sYm94LXBhbmVzIj48L2Rpdj5cbjwvZGl2PlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFjb250cm9sYm94X3RvZ2dsZScsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8c3BhbiBjbGFzcz0iY29ubi1mZWVkYmFjayI+JysKKChfX3Q9KGxhYmVsX3RvZ2dsZSkpPT1udWxsPycnOl9fdCkrCic8L3NwYW4+XG48c3BhbiBzdHlsZT0iZGlzcGxheTogbm9uZSIgaWQ9Im9ubGluZS1jb3VudCI+KDApPC9zcGFuPlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFmaWVsZCcsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8ZmllbGQgdmFyPSInKwooKF9fdD0obmFtZSkpPT1udWxsPycnOl9fdCkrCiciPjx2YWx1ZT4nKwooKF9fdD0odmFsdWUpKT09bnVsbD8nJzpfX3QpKwonPC92YWx1ZT48L2ZpZWxkPlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFmb3JtX2NoZWNrYm94JywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9JzxsYWJlbD4nKwooKF9fdD0obGFiZWwpKT09bnVsbD8nJzpfX3QpKwonPGlucHV0IG5hbWU9IicrCigoX190PShuYW1lKSk9PW51bGw/Jyc6X190KSsKJyIgdHlwZT0iJysKKChfX3Q9KHR5cGUpKT09bnVsbD8nJzpfX3QpKwonIiAnKwooKF9fdD0oY2hlY2tlZCkpPT1udWxsPycnOl9fdCkrCic+PC9sYWJlbD5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhZm9ybV9pbnB1dCcsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8bGFiZWw+JysKKChfX3Q9KGxhYmVsKSk9PW51bGw/Jyc6X190KSsKJzxpbnB1dCBuYW1lPSInKwooKF9fdD0obmFtZSkpPT1udWxsPycnOl9fdCkrCiciIHR5cGU9IicrCigoX190PSh0eXBlKSk9PW51bGw/Jyc6X190KSsKJyIgdmFsdWU9IicrCigoX190PSh2YWx1ZSkpPT1udWxsPycnOl9fdCkrCiciPjwvbGFiZWw+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIWZvcm1fc2VsZWN0JywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9JzxsYWJlbD4nKwooKF9fdD0obGFiZWwpKT09bnVsbD8nJzpfX3QpKwonPHNlbGVjdCBuYW1lPSInKwooKF9fdD0obmFtZSkpPT1udWxsPycnOl9fdCkrCiciPicrCigoX190PShvcHRpb25zKSk9PW51bGw/Jyc6X190KSsKJzwvc2VsZWN0PjwvbGFiZWw+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIWdyb3VwX2hlYWRlcicsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8YSBocmVmPSIjIiBjbGFzcz0iZ3JvdXAtdG9nZ2xlIGljb24tJysKKChfX3Q9KHRvZ2dsZV9zdGF0ZSkpPT1udWxsPycnOl9fdCkrCiciIHRpdGxlPSInKwooKF9fdD0oZGVzY19ncm91cF90b2dnbGUpKT09bnVsbD8nJzpfX3QpKwonIj4nKwooKF9fdD0obGFiZWxfZ3JvdXApKT09bnVsbD8nJzpfX3QpKwonPC9hPlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFpbmZvJywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9JzxkaXYgY2xhc3M9ImNoYXQtaW5mbyI+JysKKChfX3Q9KG1lc3NhZ2UpKT09bnVsbD8nJzpfX3QpKwonPC9kaXY+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIWxvZ2luX3BhbmVsJywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9Jzxmb3JtIGlkPSJjb252ZXJzZS1sb2dpbiIgbWV0aG9kPSJwb3N0Ij5cbiAgICA8bGFiZWw+JysKKChfX3Q9KGxhYmVsX3VzZXJuYW1lKSk9PW51bGw/Jyc6X190KSsKJzwvbGFiZWw+XG4gICAgPGlucHV0IHR5cGU9InVzZXJuYW1lIiBuYW1lPSJqaWQiIHBsYWNlaG9sZGVyPSJVc2VybmFtZSI+XG4gICAgPGxhYmVsPicrCigoX190PShsYWJlbF9wYXNzd29yZCkpPT1udWxsPycnOl9fdCkrCic8L2xhYmVsPlxuICAgIDxpbnB1dCB0eXBlPSJwYXNzd29yZCIgbmFtZT0icGFzc3dvcmQiIHBsYWNlaG9sZGVyPSJQYXNzd29yZCI+XG4gICAgPGlucHV0IGNsYXNzPSJsb2dpbi1zdWJtaXQiIHR5cGU9InN1Ym1pdCIgdmFsdWU9IicrCigoX190PShsYWJlbF9sb2dpbikpPT1udWxsPycnOl9fdCkrCiciPlxuICAgIDxzcGFuIGNsYXNzPSJjb25uLWZlZWRiYWNrIj48L3NwYW4+XG48L2Zvcm0+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIWxvZ2luX3RhYicsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8bGk+PGEgY2xhc3M9ImN1cnJlbnQiIGhyZWY9IiNsb2dpbiI+JysKKChfX3Q9KGxhYmVsX3NpZ25faW4pKT09bnVsbD8nJzpfX3QpKwonPC9hPjwvbGk+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIW1lc3NhZ2UnLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGRpdiBjbGFzcz0iY2hhdC1tZXNzYWdlICcrCigoX190PShleHRyYV9jbGFzc2VzKSk9PW51bGw/Jyc6X190KSsKJyI+XG4gICAgPHNwYW4gY2xhc3M9ImNoYXQtbWVzc2FnZS0nKwooKF9fdD0oc2VuZGVyKSk9PW51bGw/Jyc6X190KSsKJyI+JysKKChfX3Q9KHRpbWUpKT09bnVsbD8nJzpfX3QpKwonICcrCigoX190PSh1c2VybmFtZSkpPT1udWxsPycnOl9fdCkrCic6Jm5ic3A7PC9zcGFuPlxuICAgIDxzcGFuIGNsYXNzPSJjaGF0LW1lc3NhZ2UtY29udGVudCI+JysKKChfX3Q9KG1lc3NhZ2UpKT09bnVsbD8nJzpfX3QpKwonPC9zcGFuPlxuPC9kaXY+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIW5ld19kYXknLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPHRpbWUgY2xhc3M9ImNoYXQtZGF0ZSIgZGF0ZXRpbWU9IicrCigoX190PShpc29kYXRlKSk9PW51bGw/Jyc6X190KSsKJyI+JysKKChfX3Q9KGRhdGVzdHJpbmcpKT09bnVsbD8nJzpfX3QpKwonPC90aW1lPlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFvY2N1cGFudCcsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8bGkgY2xhc3M9IicrCigoX190PShyb2xlKSk9PW51bGw/Jyc6X190KSsKJyJcbiAgICAnOwogaWYgKHJvbGUgPT09ICJtb2RlcmF0b3IiKSB7IApfX3ArPSdcbiAgICAgICB0aXRsZT0iJysKKChfX3Q9KGRlc2NfbW9kZXJhdG9yKSk9PW51bGw/Jyc6X190KSsKJyJcbiAgICAnOwogfSAKX19wKz0nXG4gICAgJzsKIGlmIChyb2xlID09PSAicGFydGljaXBhbnQiKSB7IApfX3ArPSdcbiAgICAgICB0aXRsZT0iJysKKChfX3Q9KGRlc2NfcGFydGljaXBhbnQpKT09bnVsbD8nJzpfX3QpKwonIlxuICAgICc7CiB9IApfX3ArPSdcbiAgICAnOwogaWYgKHJvbGUgPT09ICJ2aXNpdG9yIikgeyAKX19wKz0nXG4gICAgICAgdGl0bGU9IicrCigoX190PShkZXNjX3Zpc2l0b3IpKT09bnVsbD8nJzpfX3QpKwonIlxuICAgICc7CiB9IApfX3ArPSdcbj4nKwooKF9fdD0obmljaykpPT1udWxsPycnOl9fdCkrCic8L2xpPlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFwZW5kaW5nX2NvbnRhY3QnLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPHNwYW4gY2xhc3M9InBlbmRpbmctY29udGFjdC1uYW1lIj4nKwooKF9fdD0oZnVsbG5hbWUpKT09bnVsbD8nJzpfX3QpKwonPC9zcGFuPiA8YSBjbGFzcz0icmVtb3ZlLXhtcHAtY29udGFjdCBpY29uLXJlbW92ZSIgdGl0bGU9IicrCigoX190PShkZXNjX3JlbW92ZSkpPT1udWxsPycnOl9fdCkrCiciIGhyZWY9IiMiPjwvYT5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhcGVuZGluZ19jb250YWN0cycsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8ZHQgaWQ9InBlbmRpbmcteG1wcC1jb250YWN0cyI+PGEgaHJlZj0iIyIgY2xhc3M9Imdyb3VwLXRvZ2dsZSBpY29uLScrCigoX190PSh0b2dnbGVfc3RhdGUpKT09bnVsbD8nJzpfX3QpKwonIiB0aXRsZT0iJysKKChfX3Q9KGRlc2NfZ3JvdXBfdG9nZ2xlKSk9PW51bGw/Jyc6X190KSsKJyI+JysKKChfX3Q9KGxhYmVsX3BlbmRpbmdfY29udGFjdHMpKT09bnVsbD8nJzpfX3QpKwonPC9hPjwvZHQ+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIXJlcXVlc3RpbmdfY29udGFjdCcsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8c3BhbiBjbGFzcz0icmVxLWNvbnRhY3QtbmFtZSI+JysKKChfX3Q9KGZ1bGxuYW1lKSk9PW51bGw/Jyc6X190KSsKJzwvc3Bhbj5cbjxzcGFuIGNsYXNzPSJyZXF1ZXN0LWFjdGlvbnMiPlxuICAgIDxhIGNsYXNzPSJhY2NlcHQteG1wcC1yZXF1ZXN0IGljb24tY2hlY2ttYXJrIiB0aXRsZT0iJysKKChfX3Q9KGRlc2NfYWNjZXB0KSk9PW51bGw/Jyc6X190KSsKJyIgaHJlZj0iIyI+PC9hPlxuICAgIDxhIGNsYXNzPSJkZWNsaW5lLXhtcHAtcmVxdWVzdCBpY29uLWNsb3NlIiB0aXRsZT0iJysKKChfX3Q9KGRlc2NfZGVjbGluZSkpPT1udWxsPycnOl9fdCkrCiciIGhyZWY9IiMiPjwvYT5cbjwvc3Bhbj5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhcmVxdWVzdGluZ19jb250YWN0cycsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8ZHQgaWQ9InhtcHAtY29udGFjdC1yZXF1ZXN0cyI+PGEgaHJlZj0iIyIgY2xhc3M9Imdyb3VwLXRvZ2dsZSBpY29uLScrCigoX190PSh0b2dnbGVfc3RhdGUpKT09bnVsbD8nJzpfX3QpKwonIiB0aXRsZT0iJysKKChfX3Q9KGRlc2NfZ3JvdXBfdG9nZ2xlKSk9PW51bGw/Jyc6X190KSsKJyI+JysKKChfX3Q9KGxhYmVsX2NvbnRhY3RfcmVxdWVzdHMpKT09bnVsbD8nJzpfX3QpKwonPC9hPjwvZHQ+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIXJvb21fZGVzY3JpcHRpb24nLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPCEtLSBGSVhNRTogY2hlY2sgbWFya3VwIGluIG1vY2t1cCAtLT5cbjxkaXYgY2xhc3M9InJvb20taW5mbyI+XG48cCBjbGFzcz0icm9vbS1pbmZvIj48c3Ryb25nPicrCigoX190PShsYWJlbF9kZXNjKSk9PW51bGw/Jyc6X190KSsKJzwvc3Ryb25nPiAnKwooKF9fdD0oZGVzYykpPT1udWxsPycnOl9fdCkrCic8L3A+XG48cCBjbGFzcz0icm9vbS1pbmZvIj48c3Ryb25nPicrCigoX190PShsYWJlbF9vY2MpKT09bnVsbD8nJzpfX3QpKwonPC9zdHJvbmc+ICcrCigoX190PShvY2MpKT09bnVsbD8nJzpfX3QpKwonPC9wPlxuPHAgY2xhc3M9InJvb20taW5mbyI+PHN0cm9uZz4nKwooKF9fdD0obGFiZWxfZmVhdHVyZXMpKT09bnVsbD8nJzpfX3QpKwonPC9zdHJvbmc+XG4gICAgPHVsPlxuICAgICAgICAnOwogaWYgKHBhc3N3b3JkcHJvdGVjdGVkKSB7IApfX3ArPSdcbiAgICAgICAgPGxpIGNsYXNzPSJyb29tLWluZm8gbG9ja2VkIj4nKwooKF9fdD0obGFiZWxfcmVxdWlyZXNfYXV0aCkpPT1udWxsPycnOl9fdCkrCic8L2xpPlxuICAgICAgICAnOwogfSAKX19wKz0nXG4gICAgICAgICc7CiBpZiAoaGlkZGVuKSB7IApfX3ArPSdcbiAgICAgICAgPGxpIGNsYXNzPSJyb29tLWluZm8iPicrCigoX190PShsYWJlbF9oaWRkZW4pKT09bnVsbD8nJzpfX3QpKwonPC9saT5cbiAgICAgICAgJzsKIH0gCl9fcCs9J1xuICAgICAgICAnOwogaWYgKG1lbWJlcnNvbmx5KSB7IApfX3ArPSdcbiAgICAgICAgPGxpIGNsYXNzPSJyb29tLWluZm8iPicrCigoX190PShsYWJlbF9yZXF1aXJlc19pbnZpdGUpKT09bnVsbD8nJzpfX3QpKwonPC9saT5cbiAgICAgICAgJzsKIH0gCl9fcCs9J1xuICAgICAgICAnOwogaWYgKG1vZGVyYXRlZCkgeyAKX19wKz0nXG4gICAgICAgIDxsaSBjbGFzcz0icm9vbS1pbmZvIj4nKwooKF9fdD0obGFiZWxfbW9kZXJhdGVkKSk9PW51bGw/Jyc6X190KSsKJzwvbGk+XG4gICAgICAgICc7CiB9IApfX3ArPSdcbiAgICAgICAgJzsKIGlmIChub25hbm9ueW1vdXMpIHsgCl9fcCs9J1xuICAgICAgICA8bGkgY2xhc3M9InJvb20taW5mbyI+JysKKChfX3Q9KGxhYmVsX25vbl9hbm9uKSk9PW51bGw/Jyc6X190KSsKJzwvbGk+XG4gICAgICAgICc7CiB9IApfX3ArPSdcbiAgICAgICAgJzsKIGlmIChvcGVuKSB7IApfX3ArPSdcbiAgICAgICAgPGxpIGNsYXNzPSJyb29tLWluZm8iPicrCigoX190PShsYWJlbF9vcGVuX3Jvb20pKT09bnVsbD8nJzpfX3QpKwonPC9saT5cbiAgICAgICAgJzsKIH0gCl9fcCs9J1xuICAgICAgICAnOwogaWYgKHBlcnNpc3RlbnQpIHsgCl9fcCs9J1xuICAgICAgICA8bGkgY2xhc3M9InJvb20taW5mbyI+JysKKChfX3Q9KGxhYmVsX3Blcm1hbmVudF9yb29tKSk9PW51bGw/Jyc6X190KSsKJzwvbGk+XG4gICAgICAgICc7CiB9IApfX3ArPSdcbiAgICAgICAgJzsKIGlmIChwdWJsaWNyb29tKSB7IApfX3ArPSdcbiAgICAgICAgPGxpIGNsYXNzPSJyb29tLWluZm8iPicrCigoX190PShsYWJlbF9wdWJsaWMpKT09bnVsbD8nJzpfX3QpKwonPC9saT5cbiAgICAgICAgJzsKIH0gCl9fcCs9J1xuICAgICAgICAnOwogaWYgKHNlbWlhbm9ueW1vdXMpIHsgCl9fcCs9J1xuICAgICAgICA8bGkgY2xhc3M9InJvb20taW5mbyI+JysKKChfX3Q9KGxhYmVsX3NlbWlfYW5vbikpPT1udWxsPycnOl9fdCkrCic8L2xpPlxuICAgICAgICAnOwogfSAKX19wKz0nXG4gICAgICAgICc7CiBpZiAodGVtcG9yYXJ5KSB7IApfX3ArPSdcbiAgICAgICAgPGxpIGNsYXNzPSJyb29tLWluZm8iPicrCigoX190PShsYWJlbF90ZW1wX3Jvb20pKT09bnVsbD8nJzpfX3QpKwonPC9saT5cbiAgICAgICAgJzsKIH0gCl9fcCs9J1xuICAgICAgICAnOwogaWYgKHVubW9kZXJhdGVkKSB7IApfX3ArPSdcbiAgICAgICAgPGxpIGNsYXNzPSJyb29tLWluZm8iPicrCigoX190PShsYWJlbF91bm1vZGVyYXRlZCkpPT1udWxsPycnOl9fdCkrCic8L2xpPlxuICAgICAgICAnOwogfSAKX19wKz0nXG4gICAgPC91bD5cbjwvcD5cbjwvZGl2PlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFyb29tX2l0ZW0nLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGRkIGNsYXNzPSJhdmFpbGFibGUtY2hhdHJvb20iPlxuPGEgY2xhc3M9Im9wZW4tcm9vbSIgZGF0YS1yb29tLWppZD0iJysKKChfX3Q9KGppZCkpPT1udWxsPycnOl9fdCkrCiciXG4gICB0aXRsZT0iJysKKChfX3Q9KG9wZW5fdGl0bGUpKT09bnVsbD8nJzpfX3QpKwonIiBocmVmPSIjIj4nKwooKF9fdD0obmFtZSkpPT1udWxsPycnOl9fdCkrCic8L2E+XG48YSBjbGFzcz0icm9vbS1pbmZvIGljb24tcm9vbS1pbmZvIiBkYXRhLXJvb20tamlkPSInKwooKF9fdD0oamlkKSk9PW51bGw/Jyc6X190KSsKJyJcbiAgIHRpdGxlPSInKwooKF9fdD0oaW5mb190aXRsZSkpPT1udWxsPycnOl9fdCkrCiciIGhyZWY9IiMiPiZuYnNwOzwvYT5cbjwvZGQ+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIXJvb21fcGFuZWwnLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGZvcm0gY2xhc3M9ImFkZC1jaGF0cm9vbSIgYWN0aW9uPSIiIG1ldGhvZD0icG9zdCI+XG4gICAgPGlucHV0IHR5cGU9InRleHQiIG5hbWU9ImNoYXRyb29tIiBjbGFzcz0ibmV3LWNoYXRyb29tLW5hbWUiXG4gICAgICAgIHBsYWNlaG9sZGVyPSInKwooKF9fdD0obGFiZWxfcm9vbV9uYW1lKSk9PW51bGw/Jyc6X190KSsKJyIvPlxuICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJuaWNrIiBjbGFzcz0ibmV3LWNoYXRyb29tLW5pY2siXG4gICAgICAgIHBsYWNlaG9sZGVyPSInKwooKF9fdD0obGFiZWxfbmlja25hbWUpKT09bnVsbD8nJzpfX3QpKwonIi8+XG4gICAgPGlucHV0IHR5cGU9IicrCigoX190PShzZXJ2ZXJfaW5wdXRfdHlwZSkpPT1udWxsPycnOl9fdCkrCiciIG5hbWU9InNlcnZlciIgY2xhc3M9Im5ldy1jaGF0cm9vbS1zZXJ2ZXIiXG4gICAgICAgIHBsYWNlaG9sZGVyPSInKwooKF9fdD0obGFiZWxfc2VydmVyKSk9PW51bGw/Jyc6X190KSsKJyIvPlxuICAgIDxpbnB1dCB0eXBlPSJzdWJtaXQiIG5hbWU9ImpvaW4iIHZhbHVlPSInKwooKF9fdD0obGFiZWxfam9pbikpPT1udWxsPycnOl9fdCkrCiciLz5cbiAgICA8aW5wdXQgdHlwZT0iYnV0dG9uIiBuYW1lPSJzaG93IiBpZD0ic2hvdy1yb29tcyIgdmFsdWU9IicrCigoX190PShsYWJlbF9zaG93X3Jvb21zKSk9PW51bGw/Jyc6X190KSsKJyIvPlxuPC9mb3JtPlxuPGRsIGlkPSJhdmFpbGFibGUtY2hhdHJvb21zIj48L2RsPlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFyb3N0ZXInLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPGlucHV0IHN0eWxlPSJkaXNwbGF5OiBub25lOyIgY2xhc3M9InJvc3Rlci1maWx0ZXIiIHBsYWNlaG9sZGVyPSInKwooKF9fdD0ocGxhY2Vob2xkZXIpKT09bnVsbD8nJzpfX3QpKwonIj5cbjxzZWxlY3Qgc3R5bGU9ImRpc3BsYXk6IG5vbmU7IiBjbGFzcz0iZmlsdGVyLXR5cGUiPlxuICAgIDxvcHRpb24gdmFsdWU9ImNvbnRhY3RzIj4nKwooKF9fdD0obGFiZWxfY29udGFjdHMpKT09bnVsbD8nJzpfX3QpKwonPC9vcHRpb24+XG4gICAgPG9wdGlvbiB2YWx1ZT0iZ3JvdXBzIj4nKwooKF9fdD0obGFiZWxfZ3JvdXBzKSk9PW51bGw/Jyc6X190KSsKJzwvb3B0aW9uPlxuPC9zZWxlY3Q+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIXJvc3Rlcl9pdGVtJywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9JzxhIGNsYXNzPSJvcGVuLWNoYXQiIHRpdGxlPSInKwooKF9fdD0oZGVzY19jaGF0KSk9PW51bGw/Jyc6X190KSsKJyIgaHJlZj0iIyI+PHNwYW4gY2xhc3M9Imljb24tJysKKChfX3Q9KGNoYXRfc3RhdHVzKSk9PW51bGw/Jyc6X190KSsKJyIgdGl0bGU9IicrCigoX190PShkZXNjX3N0YXR1cykpPT1udWxsPycnOl9fdCkrCiciPjwvc3Bhbj4nKwooKF9fdD0oZnVsbG5hbWUpKT09bnVsbD8nJzpfX3QpKwonPC9hPlxuPGEgY2xhc3M9InJlbW92ZS14bXBwLWNvbnRhY3QgaWNvbi1yZW1vdmUiIHRpdGxlPSInKwooKF9fdD0oZGVzY19yZW1vdmUpKT09bnVsbD8nJzpfX3QpKwonIiBocmVmPSIjIj48L2E+XG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIXNlbGVjdF9vcHRpb24nLCBbXSxmdW5jdGlvbiAoKSB7IHJldHVybiBmdW5jdGlvbihvYmopewp2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4scHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTsKd2l0aChvYmp8fHt9KXsKX19wKz0nPG9wdGlvbiB2YWx1ZT0iJysKKChfX3Q9KHZhbHVlKSk9PW51bGw/Jyc6X190KSsKJyI+JysKKChfX3Q9KGxhYmVsKSk9PW51bGw/Jyc6X190KSsKJzwvb3B0aW9uPlxuJzsKfQpyZXR1cm4gX19wOwp9OyB9KTsKCgpkZWZpbmUoJ3RwbCFzZWFyY2hfY29udGFjdCcsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8bGk+XG4gICAgPGZvcm0gY2xhc3M9InNlYXJjaC14bXBwLWNvbnRhY3QiPlxuICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCJcbiAgICAgICAgICAgIG5hbWU9ImlkZW50aWZpZXIiXG4gICAgICAgICAgICBjbGFzcz0idXNlcm5hbWUiXG4gICAgICAgICAgICBwbGFjZWhvbGRlcj0iJysKKChfX3Q9KGxhYmVsX2NvbnRhY3RfbmFtZSkpPT1udWxsPycnOl9fdCkrCiciLz5cbiAgICAgICAgPGJ1dHRvbiB0eXBlPSJzdWJtaXQiPicrCigoX190PShsYWJlbF9zZWFyY2gpKT09bnVsbD8nJzpfX3QpKwonPC9idXR0b24+XG4gICAgPC9mb3JtPlxuPC9saT5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhc3RhdHVzX29wdGlvbicsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8bGk+XG4gICAgPGEgaHJlZj0iIyIgY2xhc3M9IicrCigoX190PSggdmFsdWUgKSk9PW51bGw/Jyc6X190KSsKJyIgZGF0YS12YWx1ZT0iJysKKChfX3Q9KCB2YWx1ZSApKT09bnVsbD8nJzpfX3QpKwonIj5cbiAgICAgICAgPHNwYW4gY2xhc3M9Imljb24tJysKKChfX3Q9KCB2YWx1ZSApKT09bnVsbD8nJzpfX3QpKwonIj48L3NwYW4+XG4gICAgICAgICcrCigoX190PSggdGV4dCApKT09bnVsbD8nJzpfX3QpKwonXG4gICAgPC9hPlxuPC9saT5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhdG9nZ2xlX2NoYXRzJywgW10sZnVuY3Rpb24gKCkgeyByZXR1cm4gZnVuY3Rpb24ob2JqKXsKdmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLHByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307CndpdGgob2JqfHx7fSl7Cl9fcCs9JycrCigoX190PShNaW5pbWl6ZWQpKT09bnVsbD8nJzpfX3QpKwonIDxzcGFuIGlkPSJtaW5pbWl6ZWQtY291bnQiPignKwooKF9fdD0obnVtX21pbmltaXplZCkpPT1udWxsPycnOl9fdCkrCicpPC9zcGFuPlxuPHNwYW4gY2xhc3M9InVucmVhZC1tZXNzYWdlLWNvdW50IlxuICAgICc7CiBpZiAoIW51bV91bnJlYWQpIHsgCl9fcCs9JyBzdHlsZT0iZGlzcGxheTogbm9uZSIgJzsKIH0gCl9fcCs9J1xuICAgIGhyZWY9IiMiPicrCigoX190PShudW1fdW5yZWFkKSk9PW51bGw/Jyc6X190KSsKJzwvc3Bhbj5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgoKZGVmaW5lKCd0cGwhdG9vbGJhcicsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPScnOwogaWYgKHNob3dfZW1vdGljb25zKSAgeyAKX19wKz0nXG4gICAgPGxpIGNsYXNzPSJ0b2dnbGUtc21pbGV5IGljb24taGFwcHkiIHRpdGxlPSJJbnNlcnQgYSBzbWlsZXJ5Ij5cbiAgICAgICAgPHVsPlxuICAgICAgICAgICAgPGxpPjxhIGNsYXNzPSJpY29uLXNtaWxleSIgaHJlZj0iIyIgZGF0YS1lbW90aWNvbj0iOikiPjwvYT48L2xpPlxuICAgICAgICAgICAgPGxpPjxhIGNsYXNzPSJpY29uLXdpbmsiIGhyZWY9IiMiIGRhdGEtZW1vdGljb249IjspIj48L2E+PC9saT5cbiAgICAgICAgICAgIDxsaT48YSBjbGFzcz0iaWNvbi1ncmluIiBocmVmPSIjIiBkYXRhLWVtb3RpY29uPSI6RCI+PC9hPjwvbGk+XG4gICAgICAgICAgICA8bGk+PGEgY2xhc3M9Imljb24tdG9uZ3VlIiBocmVmPSIjIiBkYXRhLWVtb3RpY29uPSI6UCI+PC9hPjwvbGk+XG4gICAgICAgICAgICA8bGk+PGEgY2xhc3M9Imljb24tY29vbCIgaHJlZj0iIyIgZGF0YS1lbW90aWNvbj0iOCkiPjwvYT48L2xpPlxuICAgICAgICAgICAgPGxpPjxhIGNsYXNzPSJpY29uLWV2aWwiIGhyZWY9IiMiIGRhdGEtZW1vdGljb249Ij46KSI+PC9hPjwvbGk+XG4gICAgICAgICAgICA8bGk+PGEgY2xhc3M9Imljb24tY29uZnVzZWQiIGhyZWY9IiMiIGRhdGEtZW1vdGljb249IjpTIj48L2E+PC9saT5cbiAgICAgICAgICAgIDxsaT48YSBjbGFzcz0iaWNvbi13b25kZXJpbmciIGhyZWY9IiMiIGRhdGEtZW1vdGljb249IjpcXCI+PC9hPjwvbGk+XG4gICAgICAgICAgICA8bGk+PGEgY2xhc3M9Imljb24tYW5ncnkiIGhyZWY9IiMiIGRhdGEtZW1vdGljb249Ij46KCI+PC9hPjwvbGk+XG4gICAgICAgICAgICA8bGk+PGEgY2xhc3M9Imljb24tc2FkIiBocmVmPSIjIiBkYXRhLWVtb3RpY29uPSI6KCI+PC9hPjwvbGk+XG4gICAgICAgICAgICA8bGk+PGEgY2xhc3M9Imljb24tc2hvY2tlZCIgaHJlZj0iIyIgZGF0YS1lbW90aWNvbj0iOk8iPjwvYT48L2xpPlxuICAgICAgICAgICAgPGxpPjxhIGNsYXNzPSJpY29uLXRodW1icy11cCIgaHJlZj0iIyIgZGF0YS1lbW90aWNvbj0iKF4uXiliIj48L2E+PC9saT5cbiAgICAgICAgICAgIDxsaT48YSBjbGFzcz0iaWNvbi1oZWFydCIgaHJlZj0iIyIgZGF0YS1lbW90aWNvbj0iPDMiPjwvYT48L2xpPlxuICAgICAgICA8L3VsPlxuICAgIDwvbGk+XG4nOwogfSAKX19wKz0nXG4nOwogaWYgKHNob3dfY2FsbF9idXR0b24pICB7IApfX3ArPSdcbjxsaSBjbGFzcz0idG9nZ2xlLWNhbGwiPjxhIGNsYXNzPSJpY29uLXBob25lIiB0aXRsZT0iJysKKChfX3Q9KGxhYmVsX3N0YXJ0X2NhbGwpKT09bnVsbD8nJzpfX3QpKwonIj48L2E+PC9saT5cbic7CiB9IApfX3ArPSdcbic7CiBpZiAoc2hvd19wYXJ0aWNpcGFudHNfdG9nZ2xlKSAgeyAKX19wKz0nXG48bGkgY2xhc3M9InRvZ2dsZS1wYXJ0aWNpcGFudHMiPjxhIGNsYXNzPSJpY29uLWhpZGUtdXNlcnMiIHRpdGxlPSInKwooKF9fdD0obGFiZWxfaGlkZV9wYXJ0aWNpcGFudHMpKT09bnVsbD8nJzpfX3QpKwonIj48L2E+PC9saT5cbic7CiB9IApfX3ArPSdcbic7CiBpZiAoc2hvd19jbGVhcl9idXR0b24pICB7IApfX3ArPSdcbjxsaSBjbGFzcz0idG9nZ2xlLWNsZWFyIj48YSBjbGFzcz0iaWNvbi1yZW1vdmUiIHRpdGxlPSInKwooKF9fdD0obGFiZWxfY2xlYXIpKT09bnVsbD8nJzpfX3QpKwonIj48L2E+PC9saT5cbic7CiB9IApfX3ArPSdcbic7CiBpZiAoYWxsb3dfb3RyKSAgeyAKX19wKz0nXG4gICAgPGxpIGNsYXNzPSJ0b2dnbGUtb3RyICcrCigoX190PShvdHJfc3RhdHVzX2NsYXNzKSk9PW51bGw/Jyc6X190KSsKJyIgdGl0bGU9IicrCigoX190PShvdHJfdG9vbHRpcCkpPT1udWxsPycnOl9fdCkrCiciPlxuICAgICAgICA8c3BhbiBjbGFzcz0iY2hhdC10b29sYmFyLXRleHQiPicrCigoX190PShvdHJfdHJhbnNsYXRlZF9zdGF0dXMpKT09bnVsbD8nJzpfX3QpKwonPC9zcGFuPlxuICAgICAgICAnOwogaWYgKG90cl9zdGF0dXMgPT0gVU5FTkNSWVBURUQpIHsgCl9fcCs9J1xuICAgICAgICAgICAgPHNwYW4gY2xhc3M9Imljb24tdW5sb2NrZWQiPjwvc3Bhbj5cbiAgICAgICAgJzsKIH0gCl9fcCs9J1xuICAgICAgICAnOwogaWYgKG90cl9zdGF0dXMgPT0gVU5WRVJJRklFRCkgeyAKX19wKz0nXG4gICAgICAgICAgICA8c3BhbiBjbGFzcz0iaWNvbi1sb2NrIj48L3NwYW4+XG4gICAgICAgICc7CiB9IApfX3ArPSdcbiAgICAgICAgJzsKIGlmIChvdHJfc3RhdHVzID09IFZFUklGSUVEKSB7IApfX3ArPSdcbiAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpY29uLWxvY2siPjwvc3Bhbj5cbiAgICAgICAgJzsKIH0gCl9fcCs9J1xuICAgICAgICAnOwogaWYgKG90cl9zdGF0dXMgPT0gRklOSVNIRUQpIHsgCl9fcCs9J1xuICAgICAgICAgICAgPHNwYW4gY2xhc3M9Imljb24tdW5sb2NrZWQiPjwvc3Bhbj5cbiAgICAgICAgJzsKIH0gCl9fcCs9J1xuICAgICAgICA8dWw+XG4gICAgICAgICAgICAnOwogaWYgKG90cl9zdGF0dXMgPT0gVU5FTkNSWVBURUQpIHsgCl9fcCs9J1xuICAgICAgICAgICAgICAgPGxpPjxhIGNsYXNzPSJzdGFydC1vdHIiIGhyZWY9IiMiPicrCigoX190PShsYWJlbF9zdGFydF9lbmNyeXB0ZWRfY29udmVyc2F0aW9uKSk9PW51bGw/Jyc6X190KSsKJzwvYT48L2xpPlxuICAgICAgICAgICAgJzsKIH0gCl9fcCs9J1xuICAgICAgICAgICAgJzsKIGlmIChvdHJfc3RhdHVzICE9IFVORU5DUllQVEVEKSB7IApfX3ArPSdcbiAgICAgICAgICAgICAgIDxsaT48YSBjbGFzcz0ic3RhcnQtb3RyIiBocmVmPSIjIj4nKwooKF9fdD0obGFiZWxfcmVmcmVzaF9lbmNyeXB0ZWRfY29udmVyc2F0aW9uKSk9PW51bGw/Jyc6X190KSsKJzwvYT48L2xpPlxuICAgICAgICAgICAgICAgPGxpPjxhIGNsYXNzPSJlbmQtb3RyIiBocmVmPSIjIj4nKwooKF9fdD0obGFiZWxfZW5kX2VuY3J5cHRlZF9jb252ZXJzYXRpb24pKT09bnVsbD8nJzpfX3QpKwonPC9hPjwvbGk+XG4gICAgICAgICAgICAgICA8bGk+PGEgY2xhc3M9ImF1dGgtb3RyIiBkYXRhLXNjaGVtZT0ic21wIiBocmVmPSIjIj4nKwooKF9fdD0obGFiZWxfdmVyaWZ5X3dpdGhfc21wKSk9PW51bGw/Jyc6X190KSsKJzwvYT48L2xpPlxuICAgICAgICAgICAgJzsKIH0gCl9fcCs9J1xuICAgICAgICAgICAgJzsKIGlmIChvdHJfc3RhdHVzID09IFVOVkVSSUZJRUQpIHsgCl9fcCs9J1xuICAgICAgICAgICAgICAgPGxpPjxhIGNsYXNzPSJhdXRoLW90ciIgZGF0YS1zY2hlbWU9ImZpbmdlcnByaW50IiBocmVmPSIjIj4nKwooKF9fdD0obGFiZWxfdmVyaWZ5X3dpdGhfZmluZ2VycHJpbnRzKSk9PW51bGw/Jyc6X190KSsKJzwvYT48L2xpPlxuICAgICAgICAgICAgJzsKIH0gCl9fcCs9J1xuICAgICAgICAgICAgPGxpPjxhIGhyZWY9Imh0dHA6Ly93d3cuY3lwaGVycHVua3MuY2Evb3RyL2hlbHAvMy4yLjAvbGV2ZWxzLnBocCIgdGFyZ2V0PSJfYmxhbmsiPicrCigoX190PShsYWJlbF93aGF0c190aGlzKSk9PW51bGw/Jyc6X190KSsKJzwvYT48L2xpPlxuICAgICAgICA8L3VsPlxuICAgIDwvbGk+XG4nOwogfSAKX19wKz0nXG4nOwp9CnJldHVybiBfX3A7Cn07IH0pOwoKCmRlZmluZSgndHBsIXRyaW1tZWRfY2hhdCcsIFtdLGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZ1bmN0aW9uKG9iail7CnZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbixwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9Owp3aXRoKG9ianx8e30pewpfX3ArPSc8YSBjbGFzcz0iY2xvc2UtY2hhdGJveC1idXR0b24gaWNvbi1jbG9zZSI+PC9hPlxuPGEgY2xhc3M9ImNoYXQtaGVhZC1tZXNzYWdlLWNvdW50IiBcbiAgICAnOwogaWYgKCFudW1fdW5yZWFkKSB7IApfX3ArPScgc3R5bGU9ImRpc3BsYXk6IG5vbmUiICc7CiB9IApfX3ArPSdcbiAgICBocmVmPSIjIj4nKwooKF9fdD0obnVtX3VucmVhZCkpPT1udWxsPycnOl9fdCkrCic8L2E+XG48YSBocmVmPSIjIiBjbGFzcz0icmVzdG9yZS1jaGF0IiB0aXRsZT0iJysKKChfX3Q9KHRvb2x0aXApKT09bnVsbD8nJzpfX3QpKwonIj5cbiAgICAnKwooKF9fdD0oIHRpdGxlICkpPT1udWxsPycnOl9fdCkrCidcbjwvYT5cbic7Cn0KcmV0dXJuIF9fcDsKfTsgfSk7CgpkZWZpbmUoImNvbnZlcnNlLXRlbXBsYXRlcyIsIFsKICAgICJ0cGwhYWN0aW9uIiwKICAgICJ0cGwhYWRkX2NvbnRhY3RfZHJvcGRvd24iLAogICAgInRwbCFhZGRfY29udGFjdF9mb3JtIiwKICAgICJ0cGwhY2hhbmdlX3N0YXR1c19tZXNzYWdlIiwKICAgICJ0cGwhY2hhdF9zdGF0dXMiLAogICAgInRwbCFjaGF0YXJlYSIsCiAgICAidHBsIWNoYXRib3giLAogICAgInRwbCFjaGF0cm9vbSIsCiAgICAidHBsIWNoYXRyb29tX3Bhc3N3b3JkX2Zvcm0iLAogICAgInRwbCFjaGF0cm9vbV9zaWRlYmFyIiwKICAgICJ0cGwhY2hhdHJvb21zX3RhYiIsCiAgICAidHBsIWNoYXRzX3BhbmVsIiwKICAgICJ0cGwhY2hvb3NlX3N0YXR1cyIsCiAgICAidHBsIWNvbnRhY3RzX3BhbmVsIiwKICAgICJ0cGwhY29udGFjdHNfdGFiIiwKICAgICJ0cGwhY29udHJvbGJveCIsCiAgICAidHBsIWNvbnRyb2xib3hfdG9nZ2xlIiwKICAgICJ0cGwhZmllbGQiLAogICAgInRwbCFmb3JtX2NoZWNrYm94IiwKICAgICJ0cGwhZm9ybV9pbnB1dCIsCiAgICAidHBsIWZvcm1fc2VsZWN0IiwKICAgICJ0cGwhZ3JvdXBfaGVhZGVyIiwKICAgICJ0cGwhaW5mbyIsCiAgICAidHBsIWxvZ2luX3BhbmVsIiwKICAgICJ0cGwhbG9naW5fdGFiIiwKICAgICJ0cGwhbWVzc2FnZSIsCiAgICAidHBsIW5ld19kYXkiLAogICAgInRwbCFvY2N1cGFudCIsCiAgICAidHBsIXBlbmRpbmdfY29udGFjdCIsCiAgICAidHBsIXBlbmRpbmdfY29udGFjdHMiLAogICAgInRwbCFyZXF1ZXN0aW5nX2NvbnRhY3QiLAogICAgInRwbCFyZXF1ZXN0aW5nX2NvbnRhY3RzIiwKICAgICJ0cGwhcm9vbV9kZXNjcmlwdGlvbiIsCiAgICAidHBsIXJvb21faXRlbSIsCiAgICAidHBsIXJvb21fcGFuZWwiLAogICAgInRwbCFyb3N0ZXIiLAogICAgInRwbCFyb3N0ZXJfaXRlbSIsCiAgICAidHBsIXNlbGVjdF9vcHRpb24iLAogICAgInRwbCFzZWFyY2hfY29udGFjdCIsCiAgICAidHBsIXN0YXR1c19vcHRpb24iLAogICAgInRwbCF0b2dnbGVfY2hhdHMiLAogICAgInRwbCF0b29sYmFyIiwKICAgICJ0cGwhdHJpbW1lZF9jaGF0IgpdLCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gewogICAgICAgIGFjdGlvbjogICAgICAgICAgICAgICAgIGFyZ3VtZW50c1swXSwKICAgICAgICBhZGRfY29udGFjdF9kcm9wZG93bjogICBhcmd1bWVudHNbMV0sCiAgICAgICAgYWRkX2NvbnRhY3RfZm9ybTogICAgICAgYXJndW1lbnRzWzJdLAogICAgICAgIGNoYW5nZV9zdGF0dXNfbWVzc2FnZTogIGFyZ3VtZW50c1szXSwKICAgICAgICBjaGF0X3N0YXR1czogICAgICAgICAgICBhcmd1bWVudHNbNF0sCiAgICAgICAgY2hhdGFyZWE6ICAgICAgICAgICAgICAgYXJndW1lbnRzWzVdLAogICAgICAgIGNoYXRib3g6ICAgICAgICAgICAgICAgIGFyZ3VtZW50c1s2XSwKICAgICAgICBjaGF0cm9vbTogICAgICAgICAgICAgICBhcmd1bWVudHNbN10sCiAgICAgICAgY2hhdHJvb21fcGFzc3dvcmRfZm9ybTogYXJndW1lbnRzWzhdLAogICAgICAgIGNoYXRyb29tX3NpZGViYXI6ICAgICAgIGFyZ3VtZW50c1s5XSwKICAgICAgICBjaGF0cm9vbXNfdGFiOiAgICAgICAgICBhcmd1bWVudHNbMTBdLAogICAgICAgIGNoYXRzX3BhbmVsOiAgICAgICAgICAgIGFyZ3VtZW50c1sxMV0sCiAgICAgICAgY2hvb3NlX3N0YXR1czogICAgICAgICAgYXJndW1lbnRzWzEyXSwKICAgICAgICBjb250YWN0c19wYW5lbDogICAgICAgICBhcmd1bWVudHNbMTNdLAogICAgICAgIGNvbnRhY3RzX3RhYjogICAgICAgICAgIGFyZ3VtZW50c1sxNF0sCiAgICAgICAgY29udHJvbGJveDogICAgICAgICAgICAgYXJndW1lbnRzWzE1XSwKICAgICAgICBjb250cm9sYm94X3RvZ2dsZTogICAgICBhcmd1bWVudHNbMTZdLAogICAgICAgIGZpZWxkOiAgICAgICAgICAgICAgICAgIGFyZ3VtZW50c1sxN10sCiAgICAgICAgZm9ybV9jaGVja2JveDogICAgICAgICAgYXJndW1lbnRzWzE4XSwKICAgICAgICBmb3JtX2lucHV0OiAgICAgICAgICAgICBhcmd1bWVudHNbMTldLAogICAgICAgIGZvcm1fc2VsZWN0OiAgICAgICAgICAgIGFyZ3VtZW50c1syMF0sCiAgICAgICAgZ3JvdXBfaGVhZGVyOiAgICAgICAgICAgYXJndW1lbnRzWzIxXSwKICAgICAgICBpbmZvOiAgICAgICAgICAgICAgICAgICBhcmd1bWVudHNbMjJdLAogICAgICAgIGxvZ2luX3BhbmVsOiAgICAgICAgICAgIGFyZ3VtZW50c1syM10sCiAgICAgICAgbG9naW5fdGFiOiAgICAgICAgICAgICAgYXJndW1lbnRzWzI0XSwKICAgICAgICBtZXNzYWdlOiAgICAgICAgICAgICAgICBhcmd1bWVudHNbMjVdLAogICAgICAgIG5ld19kYXk6ICAgICAgICAgICAgICAgIGFyZ3VtZW50c1syNl0sCiAgICAgICAgb2NjdXBhbnQ6ICAgICAgICAgICAgICAgYXJndW1lbnRzWzI3XSwKICAgICAgICBwZW5kaW5nX2NvbnRhY3Q6ICAgICAgICBhcmd1bWVudHNbMjhdLAogICAgICAgIHBlbmRpbmdfY29udGFjdHM6ICAgICAgIGFyZ3VtZW50c1syOV0sCiAgICAgICAgcmVxdWVzdGluZ19jb250YWN0OiAgICAgYXJndW1lbnRzWzMwXSwKICAgICAgICByZXF1ZXN0aW5nX2NvbnRhY3RzOiAgICBhcmd1bWVudHNbMzFdLAogICAgICAgIHJvb21fZGVzY3JpcHRpb246ICAgICAgIGFyZ3VtZW50c1szMl0sCiAgICAgICAgcm9vbV9pdGVtOiAgICAgICAgICAgICAgYXJndW1lbnRzWzMzXSwKICAgICAgICByb29tX3BhbmVsOiAgICAgICAgICAgICBhcmd1bWVudHNbMzRdLAogICAgICAgIHJvc3RlcjogICAgICAgICAgICAgICAgIGFyZ3VtZW50c1szNV0sCiAgICAgICAgcm9zdGVyX2l0ZW06ICAgICAgICAgICAgYXJndW1lbnRzWzM2XSwKICAgICAgICBzZWxlY3Rfb3B0aW9uOiAgICAgICAgICBhcmd1bWVudHNbMzddLAogICAgICAgIHNlYXJjaF9jb250YWN0OiAgICAgICAgIGFyZ3VtZW50c1szOF0sCiAgICAgICAgc3RhdHVzX29wdGlvbjogICAgICAgICAgYXJndW1lbnRzWzM5XSwKICAgICAgICB0b2dnbGVfY2hhdHM6ICAgICAgICAgICBhcmd1bWVudHNbNDBdLAogICAgICAgIHRvb2xiYXI6ICAgICAgICAgICAgICAgIGFyZ3VtZW50c1s0MV0sCiAgICAgICAgdHJpbW1lZF9jaGF0OiAgICAgICAgICAgYXJndW1lbnRzWzQyXQogICAgfTsKfSk7CgovKiEKICogQ29udmVyc2UuanMgKFdlYi1iYXNlZCBYTVBQIGluc3RhbnQgbWVzc2FnaW5nIGNsaWVudCkKICogaHR0cDovL2NvbnZlcnNlanMub3JnCiAqCiAqIENvcHlyaWdodCAoYykgMjAxMiwgSmFuLUNhcmVsIEJyYW5kIDxqY0BvcGtvZGUuY29tPgogKiBMaWNlbnNlZCB1bmRlciB0aGUgTW96aWxsYSBQdWJsaWMgTGljZW5zZSAoTVBMKQogKi8KCi8vIEFNRC9nbG9iYWwgcmVnaXN0cmF0aW9ucwooZnVuY3Rpb24gKHJvb3QsIGZhY3RvcnkpIHsKICAgIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKICAgICAgICBkZWZpbmUoImNvbnZlcnNlIiwKICAgICAgICAgICAgICBbImNvbnZlcnNlLWRlcGVuZGVuY2llcyIsICJjb252ZXJzZS10ZW1wbGF0ZXMiXSwKICAgICAgICAgICAgZnVuY3Rpb24gKGRlcGVuZGVuY2llcywgdGVtcGxhdGVzKSB7CiAgICAgICAgICAgICAgICB2YXIgb3RyID0gZGVwZW5kZW5jaWVzLm90cjsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb3RyICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWN0b3J5KAogICAgICAgICAgICAgICAgICAgICAgICBkZXBlbmRlbmNpZXMualF1ZXJ5LAogICAgICAgICAgICAgICAgICAgICAgICBfLAogICAgICAgICAgICAgICAgICAgICAgICBvdHIuT1RSLAogICAgICAgICAgICAgICAgICAgICAgICBvdHIuRFNBLAogICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGRlcGVuZGVuY2llcy5tb21lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgIGRlcGVuZGVuY2llcy51dGlscwogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWN0b3J5KAogICAgICAgICAgICAgICAgICAgICAgICBkZXBlbmRlbmNpZXMualF1ZXJ5LAogICAgICAgICAgICAgICAgICAgICAgICBfLAogICAgICAgICAgICAgICAgICAgICAgICB1bmRlZmluZWQsCiAgICAgICAgICAgICAgICAgICAgICAgIHVuZGVmaW5lZCwKICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVzLAogICAgICAgICAgICAgICAgICAgICAgICBkZXBlbmRlbmNpZXMubW9tZW50LAogICAgICAgICAgICAgICAgICAgICAgICBkZXBlbmRlbmNpZXMudXRpbHMKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcm9vdC5jb252ZXJzZSA9IGZhY3RvcnkoalF1ZXJ5LCBfLCBPVFIsIERTQSwgSlNULCBtb21lbnQsIHV0aWxzKTsKICAgIH0KfSh0aGlzLCBmdW5jdGlvbiAoJCwgXywgT1RSLCBEU0EsIHRlbXBsYXRlcywgbW9tZW50LCB1dGlscykgewogICAgLy8gCiAgICAvLyBDYW5ub3QgdXNlIHRoaXMgZHVlIHRvIFNhZmFyaSBidWcuCiAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pjYnJhbmQvY29udmVyc2UuanMvaXNzdWVzLzE5NgogICAgaWYgKHR5cGVvZiBjb25zb2xlID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgY29uc29sZS5sb2cgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgY29uc29sZSA9IHsgbG9nOiBmdW5jdGlvbiAoKSB7fSwgZXJyb3I6IGZ1bmN0aW9uICgpIHt9IH07CiAgICB9CgogICAgLy8gQ29uZmlndXJhdGlvbiBvZiB1bmRlcnNjb3JlIHRlbXBsYXRlcyAodGhpcyBjb25maWcgaXMgZGlzdGljdCB0byB0aGUKICAgIC8vIGNvbmZpZyBvZiByZXF1aXJlanMtdHBsIGluIG1haW4uanMpLiBUaGlzIG9uZSBpcyBmb3Igbm9ybWFsIGlubGluZQogICAgLy8gdGVtcGxhdGVzLgogICAgLy8gVXNlIE11c3RhY2hlIHN0eWxlIHN5bnRheCBmb3IgdmFyaWFibGUgaW50ZXJwb2xhdGlvbgogICAgXy50ZW1wbGF0ZVNldHRpbmdzID0gewogICAgICAgIGV2YWx1YXRlIDogL1x7XFsoW1xzXFNdKz8pXF1cfS9nLAogICAgICAgIGludGVycG9sYXRlIDogL1x7XHsoW1xzXFNdKz8pXH1cfS9nCiAgICB9OwoKICAgIHZhciBjb250YWlucyA9IGZ1bmN0aW9uIChhdHRyLCBxdWVyeSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoaXRlbSkgewogICAgICAgICAgICBpZiAodHlwZW9mIGF0dHIgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIF8uZWFjaChhdHRyLCBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUgfHwgaXRlbS5nZXQoYSkudG9Mb3dlckNhc2UoKS5pbmRleE9mKHF1ZXJ5LnRvTG93ZXJDYXNlKCkpICE9PSAtMTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhdHRyID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgcmV0dXJuIGl0ZW0uZ2V0KGF0dHIpLnRvTG93ZXJDYXNlKCkuaW5kZXhPZihxdWVyeS50b0xvd2VyQ2FzZSgpKSAhPT0gLTE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1dyb25nIGF0dHJpYnV0ZSB0eXBlLiBNdXN0IGJlIHN0cmluZyBvciBhcnJheS4nKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9OwogICAgY29udGFpbnMubm90ID0gZnVuY3Rpb24gKGF0dHIsIHF1ZXJ5KSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgICAgICAgIHJldHVybiAhKGNvbnRhaW5zKGF0dHIsIHF1ZXJ5KShpdGVtKSk7CiAgICAgICAgfTsKICAgIH07CgogICAgLy8gWFhYOiB0aGVzZSBjYW4gcGVyaGFwcyBiZSBtb3ZlZCB0byBzcmMvcG9seWZpbGxzLmpzCiAgICBTdHJpbmcucHJvdG90eXBlLnNwbGl0T25jZSA9IGZ1bmN0aW9uIChkZWxpbWl0ZXIpIHsKICAgICAgICB2YXIgY29tcG9uZW50cyA9IHRoaXMuc3BsaXQoZGVsaW1pdGVyKTsKICAgICAgICByZXR1cm4gW2NvbXBvbmVudHMuc2hpZnQoKSwgY29tcG9uZW50cy5qb2luKGRlbGltaXRlcildOwogICAgfTsKCiAgICAkLmZuLmFkZEVtb3RpY29ucyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoY29udmVyc2UudmlzaWJsZV90b29sYmFyX2J1dHRvbnMuZW1vdGljb25zKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbiAoaSwgb2JqKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRleHQgPSAkKG9iaikuaHRtbCgpOwogICAgICAgICAgICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoLyZndDs6XCkvZywgJzxzcGFuIGNsYXNzPSJlbW90aWNvbiBpY29uLWV2aWwiPjwvc3Bhbj4nKTsKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC86XCkvZywgJzxzcGFuIGNsYXNzPSJlbW90aWNvbiBpY29uLXNtaWxleSI+PC9zcGFuPicpOwogICAgICAgICAgICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoLzpcLVwpL2csICc8c3BhbiBjbGFzcz0iZW1vdGljb24gaWNvbi1zbWlsZXkiPjwvc3Bhbj4nKTsKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC87XCkvZywgJzxzcGFuIGNsYXNzPSJlbW90aWNvbiBpY29uLXdpbmsiPjwvc3Bhbj4nKTsKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC87XC1cKS9nLCAnPHNwYW4gY2xhc3M9ImVtb3RpY29uIGljb24td2luayI+PC9zcGFuPicpOwogICAgICAgICAgICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoLzpEL2csICc8c3BhbiBjbGFzcz0iZW1vdGljb24gaWNvbi1ncmluIj48L3NwYW4+Jyk7CiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvOlwtRC9nLCAnPHNwYW4gY2xhc3M9ImVtb3RpY29uIGljb24tZ3JpbiI+PC9zcGFuPicpOwogICAgICAgICAgICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoLzpQL2csICc8c3BhbiBjbGFzcz0iZW1vdGljb24gaWNvbi10b25ndWUiPjwvc3Bhbj4nKTsKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC86XC1QL2csICc8c3BhbiBjbGFzcz0iZW1vdGljb24gaWNvbi10b25ndWUiPjwvc3Bhbj4nKTsKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC86cC9nLCAnPHNwYW4gY2xhc3M9ImVtb3RpY29uIGljb24tdG9uZ3VlIj48L3NwYW4+Jyk7CiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvOlwtcC9nLCAnPHNwYW4gY2xhc3M9ImVtb3RpY29uIGljb24tdG9uZ3VlIj48L3NwYW4+Jyk7CiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvOFwpL2csICc8c3BhbiBjbGFzcz0iZW1vdGljb24gaWNvbi1jb29sIj48L3NwYW4+Jyk7CiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvOlMvZywgJzxzcGFuIGNsYXNzPSJlbW90aWNvbiBpY29uLWNvbmZ1c2VkIj48L3NwYW4+Jyk7CiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvOlxcL2csICc8c3BhbiBjbGFzcz0iZW1vdGljb24gaWNvbi13b25kZXJpbmciPjwvc3Bhbj4nKTsKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC86XC8gL2csICc8c3BhbiBjbGFzcz0iZW1vdGljb24gaWNvbi13b25kZXJpbmciPjwvc3Bhbj4nKTsKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC8mZ3Q7OlwoL2csICc8c3BhbiBjbGFzcz0iZW1vdGljb24gaWNvbi1hbmdyeSI+PC9zcGFuPicpOwogICAgICAgICAgICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoLzpcKC9nLCAnPHNwYW4gY2xhc3M9ImVtb3RpY29uIGljb24tc2FkIj48L3NwYW4+Jyk7CiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvOlwtXCgvZywgJzxzcGFuIGNsYXNzPSJlbW90aWNvbiBpY29uLXNhZCI+PC9zcGFuPicpOwogICAgICAgICAgICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoLzpPL2csICc8c3BhbiBjbGFzcz0iZW1vdGljb24gaWNvbi1zaG9ja2VkIj48L3NwYW4+Jyk7CiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvOlwtTy9nLCAnPHNwYW4gY2xhc3M9ImVtb3RpY29uIGljb24tc2hvY2tlZCI+PC9zcGFuPicpOwogICAgICAgICAgICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoL1w9XC1PL2csICc8c3BhbiBjbGFzcz0iZW1vdGljb24gaWNvbi1zaG9ja2VkIj48L3NwYW4+Jyk7CiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvXChcXi5cXlwpYi9nLCAnPHNwYW4gY2xhc3M9ImVtb3RpY29uIGljb24tdGh1bWJzLXVwIj48L3NwYW4+Jyk7CiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvJmx0OzMvZywgJzxzcGFuIGNsYXNzPSJlbW90aWNvbiBpY29uLWhlYXJ0Ij48L3NwYW4+Jyk7CiAgICAgICAgICAgICAgICAgICAgJChvYmopLmh0bWwodGV4dCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH07CgogICAgdmFyIHBsYXlOb3RpZmljYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGF1ZGlvOwogICAgICAgIGlmIChjb252ZXJzZS5wbGF5X3NvdW5kcyAmJiB0eXBlb2YgQXVkaW8gIT09ICJ1bmRlZmluZWQiKXsKICAgICAgICAgICAgYXVkaW8gPSBuZXcgQXVkaW8oInNvdW5kcy9tc2dfcmVjZWl2ZWQub2dnIik7CiAgICAgICAgICAgIGlmIChhdWRpby5jYW5QbGF5VHlwZSgnL2F1ZGlvL29nZycpKSB7CiAgICAgICAgICAgICAgICBhdWRpby5wbGF5KCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhdWRpbyA9IG5ldyBBdWRpbygiL3NvdW5kcy9tc2dfcmVjZWl2ZWQubXAzIik7CiAgICAgICAgICAgICAgICBhdWRpby5wbGF5KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgIHZhciBjb252ZXJzZSA9IHsKICAgICAgICBwbHVnaW5zOiB7fSwKICAgICAgICB0ZW1wbGF0ZXM6IHRlbXBsYXRlcywKICAgICAgICBlbWl0OiBmdW5jdGlvbiAoZXZ0LCBkYXRhKSB7CiAgICAgICAgICAgICQodGhpcykudHJpZ2dlcihldnQsIGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgb25jZTogZnVuY3Rpb24gKGV2dCwgaGFuZGxlcikgewogICAgICAgICAgICAkKHRoaXMpLm9uZShldnQsIGhhbmRsZXIpOwogICAgICAgIH0sCiAgICAgICAgb246IGZ1bmN0aW9uIChldnQsIGhhbmRsZXIpIHsKICAgICAgICAgICAgJCh0aGlzKS5iaW5kKGV2dCwgaGFuZGxlcik7CiAgICAgICAgfSwKICAgICAgICBvZmY6IGZ1bmN0aW9uIChldnQsIGhhbmRsZXIpIHsKICAgICAgICAgICAgJCh0aGlzKS51bmJpbmQoZXZ0LCBoYW5kbGVyKTsKICAgICAgICB9LAogICAgICAgIHJlZnJlc2hXZWJraXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgLyogVGhpcyB3b3JrcyBhcm91bmQgYSB3ZWJraXQgYnVnLiBSZWZyZXNoIHRoZSBicm93c2VyJ3Mgdmlld3BvcnQsCiAgICAgICAgICAgICogb3RoZXJ3aXNlIGNoYXRib3hlcyBhcmUgbm90IG1vdmVkIGFsb25nIHdoZW4gb25lIGlzIGNsb3NlZC4KICAgICAgICAgICAgKi8KICAgICAgICAgICAgaWYgKCQuYnJvd3Nlci53ZWJraXQpIHsKICAgICAgICAgICAgICAgIHZhciBjb252ZXJzZWpzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbnZlcnNlanMnKTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlanMuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgIGNvbnZlcnNlanMub2Zmc2V0SGVpZ2h0ID0gY29udmVyc2Vqcy5vZmZzZXRIZWlnaHQ7CiAgICAgICAgICAgICAgICBjb252ZXJzZWpzLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICBjb252ZXJzZS5pbml0aWFsaXplID0gZnVuY3Rpb24gKHNldHRpbmdzLCBjYWxsYmFjaykgewogICAgICAgIHZhciBjb252ZXJzZSA9IHRoaXM7CgogICAgICAgIC8vIENvbnN0YW50cwogICAgICAgIC8vIC0tLS0tLS0tLQogICAgICAgIHZhciBVTkVOQ1JZUFRFRCA9IDA7CiAgICAgICAgdmFyIFVOVkVSSUZJRUQ9IDE7CiAgICAgICAgdmFyIFZFUklGSUVEPSAyOwogICAgICAgIHZhciBGSU5JU0hFRCA9IDM7CiAgICAgICAgdmFyIEtFWSA9IHsKICAgICAgICAgICAgRU5URVI6IDEzCiAgICAgICAgfTsKICAgICAgICB2YXIgU1RBVFVTX1dFSUdIVFMgPSB7CiAgICAgICAgICAgICdvZmZsaW5lJzogICAgICA2LAogICAgICAgICAgICAndW5hdmFpbGFibGUnOiAgNSwKICAgICAgICAgICAgJ3hhJzogICAgICAgICAgIDQsCiAgICAgICAgICAgICdhd2F5JzogICAgICAgICAzLAogICAgICAgICAgICAnZG5kJzogICAgICAgICAgMiwKICAgICAgICAgICAgJ29ubGluZSc6ICAgICAgIDEKICAgICAgICB9OwoKICAgICAgICB2YXIgSU5BQ1RJVkUgPSAnaW5hY3RpdmUnOwogICAgICAgIHZhciBBQ1RJVkUgPSAnYWN0aXZlJzsKICAgICAgICB2YXIgQ09NUE9TSU5HID0gJ2NvbXBvc2luZyc7CiAgICAgICAgdmFyIFBBVVNFRCA9ICdwYXVzZWQnOwogICAgICAgIHZhciBHT05FID0gJ2dvbmUnOwoKICAgICAgICB2YXIgSEFTX0NTUFJORyA9ICgodHlwZW9mIGNyeXB0byAhPT0gJ3VuZGVmaW5lZCcpICYmCiAgICAgICAgICAgICgodHlwZW9mIGNyeXB0by5yYW5kb21CeXRlcyA9PT0gJ2Z1bmN0aW9uJykgfHwKICAgICAgICAgICAgICAgICh0eXBlb2YgY3J5cHRvLmdldFJhbmRvbVZhbHVlcyA9PT0gJ2Z1bmN0aW9uJykKICAgICAgICApKTsKICAgICAgICB2YXIgSEFTX0NSWVBUTyA9IEhBU19DU1BSTkcgJiYgKAogICAgICAgICAgICAodHlwZW9mIENyeXB0b0pTICE9PSAidW5kZWZpbmVkIikgJiYKICAgICAgICAgICAgKHR5cGVvZiBPVFIgIT09ICJ1bmRlZmluZWQiKSAmJgogICAgICAgICAgICAodHlwZW9mIERTQSAhPT0gInVuZGVmaW5lZCIpCiAgICAgICAgKTsKCiAgICAgICAgdmFyIE9QRU5FRCA9ICdvcGVuZWQnOwogICAgICAgIHZhciBDTE9TRUQgPSAnY2xvc2VkJzsKCiAgICAgICAgLy8gRGVmYXVsdCBjb25maWd1cmF0aW9uIHZhbHVlcwogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICB0aGlzLmFsbG93X2NvbnRhY3RfcmVxdWVzdHMgPSB0cnVlOwogICAgICAgIHRoaXMuYWxsb3dfZHJhZ3Jlc2l6ZSA9IHRydWU7CiAgICAgICAgdGhpcy5hbGxvd19sb2dvdXQgPSB0cnVlOwogICAgICAgIHRoaXMuYWxsb3dfbXVjID0gdHJ1ZTsKICAgICAgICB0aGlzLmFsbG93X290ciA9IHRydWU7CiAgICAgICAgdGhpcy5hbmltYXRlID0gdHJ1ZTsKICAgICAgICB0aGlzLmF1dG9fbGlzdF9yb29tcyA9IGZhbHNlOwogICAgICAgIHRoaXMuYXV0b19yZWNvbm5lY3QgPSBmYWxzZTsKICAgICAgICB0aGlzLmF1dG9fc3Vic2NyaWJlID0gZmFsc2U7CiAgICAgICAgdGhpcy5ib3NoX3NlcnZpY2VfdXJsID0gdW5kZWZpbmVkOyAvLyBUaGUgQk9TSCBjb25uZWN0aW9uIG1hbmFnZXIgVVJMLgogICAgICAgIHRoaXMuY2FjaGVfb3RyX2tleSA9IGZhbHNlOwogICAgICAgIHRoaXMuZGVidWcgPSBmYWxzZTsKICAgICAgICB0aGlzLmRlZmF1bHRfYm94X2hlaWdodCA9IDMyNDsgLy8gVGhlIGRlZmF1bHQgaGVpZ2h0LCBpbiBwaXhlbHMsIGZvciB0aGUgY29udHJvbCBib3gsIGNoYXQgYm94ZXMgYW5kIGNoYXRyb29tcy4KICAgICAgICB0aGlzLmV4cG9zZV9yaWRfYW5kX3NpZCA9IGZhbHNlOwogICAgICAgIHRoaXMuZm9yd2FyZF9tZXNzYWdlcyA9IGZhbHNlOwogICAgICAgIHRoaXMuaGlkZV9tdWNfc2VydmVyID0gZmFsc2U7CiAgICAgICAgdGhpcy5pMThuID0gbG9jYWxlcy5lbjsKICAgICAgICB0aGlzLmtlZXBhbGl2ZSA9IGZhbHNlOwogICAgICAgIHRoaXMubWVzc2FnZV9jYXJib25zID0gZmFsc2U7CiAgICAgICAgdGhpcy5ub190cmltbWluZyA9IGZhbHNlOyAvLyBTZXQgdG8gdHJ1ZSBmb3IgcGhhbnRvbWpzIHRlc3RzICh3aGVyZSBicm93c2VyIGFwcGFyZW50bHkgaGFzIG5vIHdpZHRoKQogICAgICAgIHRoaXMucGxheV9zb3VuZHMgPSBmYWxzZTsKICAgICAgICB0aGlzLnByZWJpbmQgPSBmYWxzZTsKICAgICAgICB0aGlzLnJvc3Rlcl9ncm91cHMgPSBmYWxzZTsKICAgICAgICB0aGlzLnNob3dfY29udHJvbGJveF9ieV9kZWZhdWx0ID0gZmFsc2U7CiAgICAgICAgdGhpcy5zaG93X29ubHlfb25saW5lX3VzZXJzID0gZmFsc2U7CiAgICAgICAgdGhpcy5zaG93X3Rvb2xiYXIgPSB0cnVlOwogICAgICAgIHRoaXMuc3RvcmFnZSA9ICdzZXNzaW9uJzsKICAgICAgICB0aGlzLnVzZV9vdHJfYnlfZGVmYXVsdCA9IGZhbHNlOwogICAgICAgIHRoaXMudXNlX3ZjYXJkcyA9IHRydWU7CiAgICAgICAgdGhpcy52aXNpYmxlX3Rvb2xiYXJfYnV0dG9ucyA9IHsKICAgICAgICAgICAgJ2Vtb3RpY29ucyc6IHRydWUsCiAgICAgICAgICAgICdjYWxsJzogZmFsc2UsCiAgICAgICAgICAgICdjbGVhcic6IHRydWUsCiAgICAgICAgICAgICd0b2dnbGVfcGFydGljaXBhbnRzJzogdHJ1ZQogICAgICAgIH07CiAgICAgICAgdGhpcy54aHJfY3VzdG9tX3N0YXR1cyA9IGZhbHNlOwogICAgICAgIHRoaXMueGhyX2N1c3RvbV9zdGF0dXNfdXJsID0gJyc7CiAgICAgICAgdGhpcy54aHJfdXNlcl9zZWFyY2ggPSBmYWxzZTsKICAgICAgICB0aGlzLnhocl91c2VyX3NlYXJjaF91cmwgPSAnJzsKCiAgICAgICAgLy8gQWxsb3cgb25seSB3aGl0ZWxpc3RlZCBjb25maWd1cmF0aW9uIGF0dHJpYnV0ZXMgdG8gYmUgb3ZlcndyaXR0ZW4KICAgICAgICBfLmV4dGVuZCh0aGlzLCBfLnBpY2soc2V0dGluZ3MsIFsKICAgICAgICAgICAgJ2FsbG93X2NvbnRhY3RfcmVxdWVzdHMnLAogICAgICAgICAgICAnYWxsb3dfZHJhZ3Jlc2l6ZScsCiAgICAgICAgICAgICdhbGxvd19sb2dvdXQnLAogICAgICAgICAgICAnYWxsb3dfbXVjJywKICAgICAgICAgICAgJ2FsbG93X290cicsCiAgICAgICAgICAgICdhbmltYXRlJywKICAgICAgICAgICAgJ2F1dG9fbGlzdF9yb29tcycsCiAgICAgICAgICAgICdhdXRvX3JlY29ubmVjdCcsCiAgICAgICAgICAgICdhdXRvX3N1YnNjcmliZScsCiAgICAgICAgICAgICdib3NoX3NlcnZpY2VfdXJsJywKICAgICAgICAgICAgJ2NhY2hlX290cl9rZXknLAogICAgICAgICAgICAnY29ubmVjdGlvbicsCiAgICAgICAgICAgICdkZWJ1ZycsCiAgICAgICAgICAgICdkZWZhdWx0X2JveF9oZWlnaHQnLAogICAgICAgICAgICAna2VlcGFsaXZlJywKICAgICAgICAgICAgJ21lc3NhZ2VfY2FyYm9ucycsCiAgICAgICAgICAgICdleHBvc2VfcmlkX2FuZF9zaWQnLAogICAgICAgICAgICAnZm9yd2FyZF9tZXNzYWdlcycsCiAgICAgICAgICAgICdmdWxsbmFtZScsCiAgICAgICAgICAgICdoaWRlX211Y19zZXJ2ZXInLAogICAgICAgICAgICAnaTE4bicsCiAgICAgICAgICAgICdqaWQnLAogICAgICAgICAgICAnbm9fdHJpbW1pbmcnLAogICAgICAgICAgICAncGxheV9zb3VuZHMnLAogICAgICAgICAgICAncHJlYmluZCcsCiAgICAgICAgICAgICdyaWQnLAogICAgICAgICAgICAncm9zdGVyX2dyb3VwcycsCiAgICAgICAgICAgICdzaG93X2NvbnRyb2xib3hfYnlfZGVmYXVsdCcsCiAgICAgICAgICAgICdzaG93X29ubHlfb25saW5lX3VzZXJzJywKICAgICAgICAgICAgJ3Nob3dfdG9vbGJhcicsCiAgICAgICAgICAgICdzaWQnLAogICAgICAgICAgICAnc3RvcmFnZScsCiAgICAgICAgICAgICd1c2Vfb3RyX2J5X2RlZmF1bHQnLAogICAgICAgICAgICAndXNlX3ZjYXJkcycsCiAgICAgICAgICAgICd4aHJfY3VzdG9tX3N0YXR1cycsCiAgICAgICAgICAgICd4aHJfY3VzdG9tX3N0YXR1c191cmwnLAogICAgICAgICAgICAneGhyX3VzZXJfc2VhcmNoJywKICAgICAgICAgICAgJ3hocl91c2VyX3NlYXJjaF91cmwnCiAgICAgICAgXSkpOwogICAgICAgIGlmIChzZXR0aW5ncy52aXNpYmxlX3Rvb2xiYXJfYnV0dG9ucykgewogICAgICAgICAgICBfLmV4dGVuZCgKICAgICAgICAgICAgICAgIHRoaXMudmlzaWJsZV90b29sYmFyX2J1dHRvbnMsCiAgICAgICAgICAgICAgICBfLnBpY2soc2V0dGluZ3MudmlzaWJsZV90b29sYmFyX2J1dHRvbnMsIFsKICAgICAgICAgICAgICAgICAgICAnZW1vdGljb25zJywgJ2NhbGwnLCAnY2xlYXInLCAndG9nZ2xlX3BhcnRpY2lwYW50cycKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgKSk7CiAgICAgICAgfQogICAgICAgICQuZngub2ZmID0gIXRoaXMuYW5pbWF0ZTsKCiAgICAgICAgLy8gT25seSBhbGxvdyBPVFIgaWYgd2UgaGF2ZSB0aGUgY2FwYWJpbGl0eQogICAgICAgIHRoaXMuYWxsb3dfb3RyID0gdGhpcy5hbGxvd19vdHIgJiYgSEFTX0NSWVBUTzsKCiAgICAgICAgLy8gT25seSB1c2UgT1RSIGJ5IGRlZmF1bHQgaWYgYWxsb3cgT1RSIGlzIGVuYWJsZWQgdG8gYmVnaW4gd2l0aAogICAgICAgIHRoaXMudXNlX290cl9ieV9kZWZhdWx0ID0gdGhpcy51c2Vfb3RyX2J5X2RlZmF1bHQgJiYgdGhpcy5hbGxvd19vdHI7CgogICAgICAgIC8vIFRyYW5zbGF0aW9uIG1hY2hpbmVyeQogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIHZhciBfXyA9ICQucHJveHkodXRpbHMuX18sIHRoaXMpOwogICAgICAgIHZhciBfX18gPSB1dGlscy5fX187CiAgICAgICAgLy8gVHJhbnNsYXRpb24gYXdhcmUgY29uc3RhbnRzCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgdmFyIE9UUl9DTEFTU19NQVBQSU5HID0ge307CiAgICAgICAgT1RSX0NMQVNTX01BUFBJTkdbVU5FTkNSWVBURURdID0gJ3VuZW5jcnlwdGVkJzsKICAgICAgICBPVFJfQ0xBU1NfTUFQUElOR1tVTlZFUklGSUVEXSA9ICd1bnZlcmlmaWVkJzsKICAgICAgICBPVFJfQ0xBU1NfTUFQUElOR1tWRVJJRklFRF0gPSAndmVyaWZpZWQnOwogICAgICAgIE9UUl9DTEFTU19NQVBQSU5HW0ZJTklTSEVEXSA9ICdmaW5pc2hlZCc7CgogICAgICAgIHZhciBPVFJfVFJBTlNMQVRFRF9NQVBQSU5HICA9IHt9OwogICAgICAgIE9UUl9UUkFOU0xBVEVEX01BUFBJTkdbVU5FTkNSWVBURURdID0gX18oJ3VuZW5jcnlwdGVkJyk7CiAgICAgICAgT1RSX1RSQU5TTEFURURfTUFQUElOR1tVTlZFUklGSUVEXSA9IF9fKCd1bnZlcmlmaWVkJyk7CiAgICAgICAgT1RSX1RSQU5TTEFURURfTUFQUElOR1tWRVJJRklFRF0gPSBfXygndmVyaWZpZWQnKTsKICAgICAgICBPVFJfVFJBTlNMQVRFRF9NQVBQSU5HW0ZJTklTSEVEXSA9IF9fKCdmaW5pc2hlZCcpOwoKICAgICAgICB2YXIgU1RBVFVTRVMgPSB7CiAgICAgICAgICAgICdkbmQnOiBfXygnVGhpcyBjb250YWN0IGlzIGJ1c3knKSwKICAgICAgICAgICAgJ29ubGluZSc6IF9fKCdUaGlzIGNvbnRhY3QgaXMgb25saW5lJyksCiAgICAgICAgICAgICdvZmZsaW5lJzogX18oJ1RoaXMgY29udGFjdCBpcyBvZmZsaW5lJyksCiAgICAgICAgICAgICd1bmF2YWlsYWJsZSc6IF9fKCdUaGlzIGNvbnRhY3QgaXMgdW5hdmFpbGFibGUnKSwKICAgICAgICAgICAgJ3hhJzogX18oJ1RoaXMgY29udGFjdCBpcyBhd2F5IGZvciBhbiBleHRlbmRlZCBwZXJpb2QnKSwKICAgICAgICAgICAgJ2F3YXknOiBfXygnVGhpcyBjb250YWN0IGlzIGF3YXknKQogICAgICAgIH07CiAgICAgICAgdmFyIERFU0NfR1JPVVBfVE9HR0xFID0gX18oJ0NsaWNrIHRvIGhpZGUgdGhlc2UgY29udGFjdHMnKTsKCiAgICAgICAgdmFyIEhFQURFUl9DVVJSRU5UX0NPTlRBQ1RTID0gIF9fKCdNeSBjb250YWN0cycpOwogICAgICAgIHZhciBIRUFERVJfUEVORElOR19DT05UQUNUUyA9IF9fKCdQZW5kaW5nIGNvbnRhY3RzJyk7CiAgICAgICAgdmFyIEhFQURFUl9SRVFVRVNUSU5HX0NPTlRBQ1RTID0gX18oJ0NvbnRhY3QgcmVxdWVzdHMnKTsKICAgICAgICB2YXIgSEVBREVSX1VOR1JPVVBFRCA9IF9fKCdVbmdyb3VwZWQnKTsKCiAgICAgICAgdmFyIExBQkVMX0NPTlRBQ1RTID0gX18oJ0NvbnRhY3RzJyk7CiAgICAgICAgdmFyIExBQkVMX0dST1VQUyA9IF9fKCdHcm91cHMnKTsKCiAgICAgICAgdmFyIEhFQURFUl9XRUlHSFRTID0ge307CiAgICAgICAgSEVBREVSX1dFSUdIVFNbSEVBREVSX0NVUlJFTlRfQ09OVEFDVFNdICAgID0gMDsKICAgICAgICBIRUFERVJfV0VJR0hUU1tIRUFERVJfVU5HUk9VUEVEXSAgICAgICAgICAgPSAxOwogICAgICAgIEhFQURFUl9XRUlHSFRTW0hFQURFUl9SRVFVRVNUSU5HX0NPTlRBQ1RTXSA9IDI7CiAgICAgICAgSEVBREVSX1dFSUdIVFNbSEVBREVSX1BFTkRJTkdfQ09OVEFDVFNdICAgID0gMzsKCiAgICAgICAgLy8gTW9kdWxlLWxldmVsIHZhcmlhYmxlcwogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICB0aGlzLmNhbGxiYWNrID0gY2FsbGJhY2sgfHwgZnVuY3Rpb24gKCkge307CiAgICAgICAgdGhpcy5pbml0aWFsX3ByZXNlbmNlX3NlbnQgPSAwOwogICAgICAgIHRoaXMubXNnX2NvdW50ZXIgPSAwOwoKICAgICAgICAvLyBNb2R1bGUtbGV2ZWwgZnVuY3Rpb25zCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIHRoaXMuZ2l2ZUZlZWRiYWNrID0gZnVuY3Rpb24gKG1lc3NhZ2UsIGtsYXNzKSB7CiAgICAgICAgICAgICQoJy5jb25uLWZlZWRiYWNrJykuYXR0cignY2xhc3MnLCAnY29ubi1mZWVkYmFjaycpLnRleHQobWVzc2FnZSk7CiAgICAgICAgICAgIGlmIChrbGFzcykgewogICAgICAgICAgICAgICAgJCgnLmNvbm4tZmVlZGJhY2snKS5hZGRDbGFzcyhrbGFzcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB0aGlzLmxvZyA9IGZ1bmN0aW9uICh0eHQsIGxldmVsKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBpZiAobGV2ZWwgPT0gJ2Vycm9yJykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdFUlJPUjogJyt0eHQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyh0eHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5nZXRWQ2FyZCA9IGZ1bmN0aW9uIChqaWQsIGNhbGxiYWNrLCBlcnJiYWNrKSB7CiAgICAgICAgICAgIGlmICghdGhpcy51c2VfdmNhcmRzKSB7CiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhqaWQsIGppZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi52Y2FyZC5nZXQoCiAgICAgICAgICAgICAgICAkLnByb3h5KGZ1bmN0aW9uIChpcSkgewogICAgICAgICAgICAgICAgICAgIC8vIFN1Y2Nlc3NmdWwgY2FsbGJhY2sKICAgICAgICAgICAgICAgICAgICB2YXIgJHZjYXJkID0gJChpcSkuZmluZCgndkNhcmQnKTsKICAgICAgICAgICAgICAgICAgICB2YXIgZnVsbG5hbWUgPSAkdmNhcmQuZmluZCgnRk4nKS50ZXh0KCksCiAgICAgICAgICAgICAgICAgICAgICAgIGltZyA9ICR2Y2FyZC5maW5kKCdCSU5WQUwnKS50ZXh0KCksCiAgICAgICAgICAgICAgICAgICAgICAgIGltZ190eXBlID0gJHZjYXJkLmZpbmQoJ1RZUEUnKS50ZXh0KCksCiAgICAgICAgICAgICAgICAgICAgICAgIHVybCA9ICR2Y2FyZC5maW5kKCdVUkwnKS50ZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGppZCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29udGFjdCA9IGNvbnZlcnNlLnJvc3Rlci5nZXQoamlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnRhY3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bGxuYW1lID0gXy5pc0VtcHR5KGZ1bGxuYW1lKT8gY29udGFjdC5nZXQoJ2Z1bGxuYW1lJykgfHwgamlkOiBmdWxsbmFtZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhY3Quc2F2ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2Z1bGxuYW1lJzogZnVsbG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2ltYWdlX3R5cGUnOiBpbWdfdHlwZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnaW1hZ2UnOiBpbWcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3VybCc6IHVybCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAndmNhcmRfdXBkYXRlZCc6IG1vbWVudCgpLmZvcm1hdCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soamlkLCBmdWxsbmFtZSwgaW1nLCBpbWdfdHlwZSwgdXJsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCB0aGlzKSwKICAgICAgICAgICAgICAgIGppZCwKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChpcSkgewogICAgICAgICAgICAgICAgICAgIC8vIEVycm9yIGNhbGxiYWNrCiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRhY3QgPSBjb252ZXJzZS5yb3N0ZXIuZ2V0KGppZCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnRhY3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGFjdC5zYXZlKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICd2Y2FyZF91cGRhdGVkJzogbW9tZW50KCkuZm9ybWF0KCkKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChlcnJiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycmJhY2soamlkLCBpcSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICApOwogICAgICAgIH07CgogICAgICAgIHRoaXMucmVjb25uZWN0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBjb252ZXJzZS5naXZlRmVlZGJhY2soX18oJ1JlY29ubmVjdGluZycpLCAnZXJyb3InKTsKICAgICAgICAgICAgY29udmVyc2UuZW1pdCgncmVjb25uZWN0Jyk7CiAgICAgICAgICAgIGlmICghY29udmVyc2UucHJlYmluZCkgewogICAgICAgICAgICAgICAgdGhpcy5jb25uZWN0aW9uLmNvbm5lY3QoCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb25uZWN0aW9uLmppZCwKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbm5lY3Rpb24ucGFzcywKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoc3RhdHVzLCBjb25kaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2Uub25Db25uZWN0KHN0YXR1cywgY29uZGl0aW9uLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbi53YWl0LAogICAgICAgICAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbi5ob2xkLAogICAgICAgICAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbi5yb3V0ZQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHRoaXMucmVuZGVyTG9naW5QYW5lbCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgY29udmVyc2UuX3RlYXJEb3duKCk7CiAgICAgICAgICAgIHZhciB2aWV3ID0gY29udmVyc2UuY2hhdGJveHZpZXdzLmdldCgnY29udHJvbGJveCcpOwogICAgICAgICAgICB2aWV3Lm1vZGVsLnNldCh7Y29ubmVjdGVkOmZhbHNlfSk7CiAgICAgICAgICAgIHZpZXcucmVuZGVyTG9naW5QYW5lbCgpOwogICAgICAgIH07CgogICAgICAgIHRoaXMub25Db25uZWN0ID0gZnVuY3Rpb24gKHN0YXR1cywgY29uZGl0aW9uLCByZWNvbm5lY3QpIHsKICAgICAgICAgICAgdmFyICRidXR0b24sICRmb3JtOwogICAgICAgICAgICBpZiAoKHN0YXR1cyA9PT0gU3Ryb3BoZS5TdGF0dXMuQ09OTkVDVEVEKSB8fAogICAgICAgICAgICAgICAgKHN0YXR1cyA9PT0gU3Ryb3BoZS5TdGF0dXMuQVRUQUNIRUQpKSB7CiAgICAgICAgICAgICAgICBpZiAoKHR5cGVvZiByZWNvbm5lY3QgIT09ICd1bmRlZmluZWQnKSAmJiAocmVjb25uZWN0KSkgewogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmxvZyhzdGF0dXMgPT09IFN0cm9waGUuU3RhdHVzLkNPTk5FQ1RFRCA/ICdSZWNvbm5lY3RlZCcgOiAnUmVhdHRhY2hlZCcpOwogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLm9uUmVjb25uZWN0ZWQoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UubG9nKHN0YXR1cyA9PT0gU3Ryb3BoZS5TdGF0dXMuQ09OTkVDVEVEID8gJ0Nvbm5lY3RlZCcgOiAnQXR0YWNoZWQnKTsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5vbkNvbm5lY3RlZCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXR1cyA9PT0gU3Ryb3BoZS5TdGF0dXMuRElTQ09OTkVDVEVEKSB7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5naXZlRmVlZGJhY2soX18oJ0Rpc2Nvbm5lY3RlZCcpLCAnZXJyb3InKTsKICAgICAgICAgICAgICAgIGlmIChjb252ZXJzZS5hdXRvX3JlY29ubmVjdCkgewogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJlY29ubmVjdCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5yZW5kZXJMb2dpblBhbmVsKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdHVzID09PSBTdHJvcGhlLlN0YXR1cy5FcnJvcikgewogICAgICAgICAgICAgICAgY29udmVyc2UucmVuZGVyTG9naW5QYW5lbCgpOwogICAgICAgICAgICAgICAgY29udmVyc2UuZ2l2ZUZlZWRiYWNrKF9fKCdFcnJvcicpLCAnZXJyb3InKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0dXMgPT09IFN0cm9waGUuU3RhdHVzLkNPTk5FQ1RJTkcpIHsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLmdpdmVGZWVkYmFjayhfXygnQ29ubmVjdGluZycpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0dXMgPT09IFN0cm9waGUuU3RhdHVzLkNPTk5GQUlMKSB7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5yZW5kZXJMb2dpblBhbmVsKCk7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5naXZlRmVlZGJhY2soX18oJ0Nvbm5lY3Rpb24gRmFpbGVkJyksICdlcnJvcicpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXR1cyA9PT0gU3Ryb3BoZS5TdGF0dXMuQVVUSEVOVElDQVRJTkcpIHsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLmdpdmVGZWVkYmFjayhfXygnQXV0aGVudGljYXRpbmcnKSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdHVzID09PSBTdHJvcGhlLlN0YXR1cy5BVVRIRkFJTCkgewogICAgICAgICAgICAgICAgY29udmVyc2UucmVuZGVyTG9naW5QYW5lbCgpOwogICAgICAgICAgICAgICAgY29udmVyc2UuZ2l2ZUZlZWRiYWNrKF9fKCdBdXRoZW50aWNhdGlvbiBGYWlsZWQnKSwgJ2Vycm9yJyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdHVzID09PSBTdHJvcGhlLlN0YXR1cy5ESVNDT05ORUNUSU5HKSB7CiAgICAgICAgICAgICAgICBpZiAoIWNvbnZlcnNlLmNvbm5lY3Rpb24uY29ubmVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UucmVuZGVyTG9naW5QYW5lbCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5naXZlRmVlZGJhY2soX18oJ0Rpc2Nvbm5lY3RpbmcnKSwgJ2Vycm9yJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB0aGlzLmFwcGx5SGVpZ2h0UmVzaXN0YW5jZSA9IGZ1bmN0aW9uIChoZWlnaHQpIHsKICAgICAgICAgICAgLyogVGhpcyBtZXRob2QgYXBwbGllcyBzb21lIHJlc2lzdGFuY2UvZ3Jhdml0eSBhcm91bmQgdGhlCiAgICAgICAgICAgICAqICJkZWZhdWx0X2JveF9oZWlnaHQiLiBJZiAiaGVpZ2h0IiBpcyBjbG9zZSBlbm91Z2ggdG8KICAgICAgICAgICAgICogZGVmYXVsdF9ib3hfaGVpZ2h0LCB0aGVuIHRoYXQgaXMgcmV0dXJuZWQgaW5zdGVhZC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGlmICh0eXBlb2YgaGVpZ2h0ID09PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnZlcnNlLmRlZmF1bHRfYm94X2hlaWdodDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcmVzaXN0YW5jZSA9IDEwOwogICAgICAgICAgICBpZiAoKGhlaWdodCAhPT0gY29udmVyc2UuZGVmYXVsdF9ib3hfaGVpZ2h0KSAmJgogICAgICAgICAgICAgICAgKE1hdGguYWJzKGhlaWdodCAtIGNvbnZlcnNlLmRlZmF1bHRfYm94X2hlaWdodCkgPCByZXNpc3RhbmNlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnZlcnNlLmRlZmF1bHRfYm94X2hlaWdodDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaGVpZ2h0OwogICAgICAgIH07CgogICAgICAgIHRoaXMudXBkYXRlTXNnQ291bnRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKHRoaXMubXNnX2NvdW50ZXIgPiAwKSB7CiAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQudGl0bGUuc2VhcmNoKC9eTWVzc2FnZXMgXChcZCtcKSAvKSA9PSAtMSkgewogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LnRpdGxlID0gIk1lc3NhZ2VzICgiICsgdGhpcy5tc2dfY291bnRlciArICIpICIgKyBkb2N1bWVudC50aXRsZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQudGl0bGUgPSBkb2N1bWVudC50aXRsZS5yZXBsYWNlKC9eTWVzc2FnZXMgXChcZCtcKSAvLCAiTWVzc2FnZXMgKCIgKyB0aGlzLm1zZ19jb3VudGVyICsgIikgIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB3aW5kb3cuYmx1cigpOwogICAgICAgICAgICAgICAgd2luZG93LmZvY3VzKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZG9jdW1lbnQudGl0bGUuc2VhcmNoKC9eTWVzc2FnZXMgXChcZCtcKSAvKSAhPSAtMSkgewogICAgICAgICAgICAgICAgZG9jdW1lbnQudGl0bGUgPSBkb2N1bWVudC50aXRsZS5yZXBsYWNlKC9eTWVzc2FnZXMgXChcZCtcKSAvLCAiIik7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB0aGlzLmluY3JlbWVudE1zZ0NvdW50ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMubXNnX2NvdW50ZXIgKz0gMTsKICAgICAgICAgICAgdGhpcy51cGRhdGVNc2dDb3VudGVyKCk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5jbGVhck1zZ0NvdW50ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMubXNnX2NvdW50ZXIgPSAwOwogICAgICAgICAgICB0aGlzLnVwZGF0ZU1zZ0NvdW50ZXIoKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLmluaXRTdGF0dXMgPSBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy54bXBwc3RhdHVzID0gbmV3IHRoaXMuWE1QUFN0YXR1cygpOwogICAgICAgICAgICB2YXIgaWQgPSBiNjRfc2hhMSgnY29udmVyc2UueG1wcHN0YXR1cy0nK2NvbnZlcnNlLmJhcmVfamlkKTsKICAgICAgICAgICAgdGhpcy54bXBwc3RhdHVzLmlkID0gaWQ7IC8vIEFwcGVhcnMgdG8gYmUgbmVjZXNzYXJ5IGZvciBiYWNrYm9uZS5icm93c2VyU3RvcmFnZQogICAgICAgICAgICB0aGlzLnhtcHBzdGF0dXMuYnJvd3NlclN0b3JhZ2UgPSBuZXcgQmFja2JvbmUuQnJvd3NlclN0b3JhZ2VbY29udmVyc2Uuc3RvcmFnZV0oaWQpOwogICAgICAgICAgICB0aGlzLnhtcHBzdGF0dXMuZmV0Y2goe3N1Y2Nlc3M6IGNhbGxiYWNrLCBlcnJvcjogY2FsbGJhY2t9KTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLmluaXRTZXNzaW9uID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLnNlc3Npb24gPSBuZXcgdGhpcy5CT1NIU2Vzc2lvbigpOwogICAgICAgICAgICB2YXIgaWQgPSBiNjRfc2hhMSgnY29udmVyc2UuYm9zaC1zZXNzaW9uJyk7CiAgICAgICAgICAgIHRoaXMuc2Vzc2lvbi5pZCA9IGlkOyAvLyBBcHBlYXJzIHRvIGJlIG5lY2Vzc2FyeSBmb3IgYmFja2JvbmUuYnJvd3NlclN0b3JhZ2UKICAgICAgICAgICAgdGhpcy5zZXNzaW9uLmJyb3dzZXJTdG9yYWdlID0gbmV3IEJhY2tib25lLkJyb3dzZXJTdG9yYWdlW2NvbnZlcnNlLnN0b3JhZ2VdKGlkKTsKICAgICAgICAgICAgdGhpcy5zZXNzaW9uLmZldGNoKCk7CiAgICAgICAgICAgICQod2luZG93KS5vbignYmVmb3JldW5sb2FkJywgJC5wcm94eShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAoY29udmVyc2UuY29ubmVjdGlvbi5jb25uZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFNlc3Npb24oKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbGVhclNlc3Npb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgIH07CgogICAgICAgIHRoaXMuY2xlYXJTZXNzaW9uID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLnJvc3Rlci5icm93c2VyU3RvcmFnZS5fY2xlYXIoKTsKICAgICAgICAgICAgdGhpcy5zZXNzaW9uLmJyb3dzZXJTdG9yYWdlLl9jbGVhcigpOwogICAgICAgICAgICAvLyBYWFg6IHRoaXMgc2hvdWxkIHBlcmhhcHMgZ28gaW50byB0aGUgYmVmb3JldW5sb2FkIGhhbmRsZXIKICAgICAgICAgICAgY29udmVyc2UuY2hhdGJveGVzLmdldCgnY29udHJvbGJveCcpLnNhdmUoeydjb25uZWN0ZWQnOiBmYWxzZX0pOwogICAgICAgIH07CgogICAgICAgIHRoaXMuc2V0U2Vzc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKHRoaXMua2VlcGFsaXZlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNlc3Npb24uc2F2ZSh7CiAgICAgICAgICAgICAgICAgICAgamlkOiB0aGlzLmNvbm5lY3Rpb24uamlkLAogICAgICAgICAgICAgICAgICAgIHJpZDogdGhpcy5jb25uZWN0aW9uLl9wcm90by5yaWQsCiAgICAgICAgICAgICAgICAgICAgc2lkOiB0aGlzLmNvbm5lY3Rpb24uX3Byb3RvLnNpZAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB0aGlzLmxvZ091dCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgY29udmVyc2UuY2hhdGJveHZpZXdzLmNsb3NlQWxsQ2hhdEJveGVzKGZhbHNlKTsKICAgICAgICAgICAgY29udmVyc2UuY2xlYXJTZXNzaW9uKCk7CiAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24uZGlzY29ubmVjdCgpOwogICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLnJlc2V0KCk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5yZWdpc3Rlckdsb2JhbEV2ZW50SGFuZGxlcnMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICQoZG9jdW1lbnQpLmNsaWNrKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmICgkKCcudG9nZ2xlLW90ciB1bCcpLmlzKCc6dmlzaWJsZScpKSB7CiAgICAgICAgICAgICAgICAgICAgJCgnLnRvZ2dsZS1vdHIgdWwnLCB0aGlzKS5zbGlkZVVwKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoJCgnLnRvZ2dsZS1zbWlsZXkgdWwnKS5pcygnOnZpc2libGUnKSkgewogICAgICAgICAgICAgICAgICAgICQoJy50b2dnbGUtc21pbGV5IHVsJywgdGhpcykuc2xpZGVVcCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKCdtb3VzZW1vdmUnLCAkLnByb3h5KGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLnJlc2l6ZWRfY2hhdGJveCB8fCAhdGhpcy5hbGxvd19kcmFncmVzaXplKSB7IHJldHVybiB0cnVlOyB9CiAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgdGhpcy5yZXNpemVkX2NoYXRib3gucmVzaXplQ2hhdEJveChldik7CiAgICAgICAgICAgIH0sIHRoaXMpKTsKCiAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKCdtb3VzZXVwJywgJC5wcm94eShmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5yZXNpemVkX2NoYXRib3ggfHwgIXRoaXMuYWxsb3dfZHJhZ3Jlc2l6ZSkgeyByZXR1cm4gdHJ1ZTsgfQogICAgICAgICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIHZhciBoZWlnaHQgPSB0aGlzLmFwcGx5SGVpZ2h0UmVzaXN0YW5jZSh0aGlzLnJlc2l6ZWRfY2hhdGJveC5oZWlnaHQpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY29ubmVjdGlvbi5jb25uZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlc2l6ZWRfY2hhdGJveC5tb2RlbC5zYXZlKHsnaGVpZ2h0JzogaGVpZ2h0fSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMucmVzaXplZF9jaGF0Ym94Lm1vZGVsLnNldCh7J2hlaWdodCc6IGhlaWdodH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5yZXNpemVkX2NoYXRib3ggPSBudWxsOwogICAgICAgICAgICB9LCB0aGlzKSk7CgogICAgICAgICAgICAkKHdpbmRvdykub24oImJsdXIgZm9jdXMiLCAkLnByb3h5KGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgaWYgKCh0aGlzLndpbmRvd1N0YXRlICE9IGV2LnR5cGUpICYmIChldi50eXBlID09ICdmb2N1cycpKSB7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY2xlYXJNc2dDb3VudGVyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLndpbmRvd1N0YXRlID0gZXYudHlwZTsKICAgICAgICAgICAgfSx0aGlzKSk7CgogICAgICAgICAgICAkKHdpbmRvdykub24oInJlc2l6ZSIsIF8uZGVib3VuY2UoJC5wcm94eShmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2hhdGJveHZpZXdzLnRyaW1DaGF0cygpOwogICAgICAgICAgICB9LHRoaXMpLCAyMDApKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLm9uUmVjb25uZWN0ZWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIC8vIFdlIG5lZWQgdG8gcmUtcmVnaXN0ZXIgYWxsIHRoZSBldmVudCBoYW5kbGVycyBvbiB0aGUgbmV3bHkKICAgICAgICAgICAgLy8gY3JlYXRlZCBjb25uZWN0aW9uLgogICAgICAgICAgICB0aGlzLmluaXRTdGF0dXMoJC5wcm94eShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlZ2lzdGVyUm9zdGVyWEhhbmRsZXIoKTsKICAgICAgICAgICAgICAgIHRoaXMucmVnaXN0ZXJQcmVzZW5jZUhhbmRsZXIoKTsKICAgICAgICAgICAgICAgIHRoaXMuY2hhdGJveGVzLnJlZ2lzdGVyTWVzc2FnZUhhbmRsZXIoKTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLnhtcHBzdGF0dXMuc2VuZFByZXNlbmNlKCk7CiAgICAgICAgICAgICAgICB0aGlzLmdpdmVGZWVkYmFjayhfXygnT25saW5lIENvbnRhY3RzJykpOwogICAgICAgICAgICB9LCB0aGlzKSk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5lbmFibGVDYXJib25zID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvKiBBc2sgdGhlIFhNUFAgc2VydmVyIHRvIGVuYWJsZSBNZXNzYWdlIENhcmJvbnMKICAgICAgICAgICAgICogU2VlIFhFUC0wMjgwIGh0dHBzOi8veG1wcC5vcmcvZXh0ZW5zaW9ucy94ZXAtMDI4MC5odG1sI2VuYWJsaW5nCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBpZiAoIXRoaXMubWVzc2FnZV9jYXJib25zKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNhcmJvbnNfaXEgPSBuZXcgU3Ryb3BoZS5CdWlsZGVyKCdpcScsIHsKICAgICAgICAgICAgICAgIGZyb206IHRoaXMuY29ubmVjdGlvbi5qaWQsCiAgICAgICAgICAgICAgICBpZDogJ2VuYWJsZWNhcmJvbnMnLAogICAgICAgICAgICAgICAgdHlwZTogJ3NldCcKICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIC5jKCdlbmFibGUnLCB7eG1sbnM6ICd1cm46eG1wcDpjYXJib25zOjInfSk7CiAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbi5zZW5kKGNhcmJvbnNfaXEpOwogICAgICAgICAgICB0aGlzLmNvbm5lY3Rpb24uYWRkSGFuZGxlcihmdW5jdGlvbiAoaXEpIHsKICAgICAgICAgICAgICAgIC8vVE9ETzogY2hlY2sgaWYgY2FyYm9ucyB3YXMgZW5hYmxlZDoKICAgICAgICAgICAgfSwgbnVsbCwgImlxIiwgbnVsbCwgImVuYWJsZWNhcmJvbnMiKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLm9uQ29ubmVjdGVkID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAodGhpcy5kZWJ1ZykgewogICAgICAgICAgICAgICAgdGhpcy5jb25uZWN0aW9uLnhtbElucHV0ID0gZnVuY3Rpb24gKGJvZHkpIHsgY29uc29sZS5sb2coYm9keSk7IH07CiAgICAgICAgICAgICAgICB0aGlzLmNvbm5lY3Rpb24ueG1sT3V0cHV0ID0gZnVuY3Rpb24gKGJvZHkpIHsgY29uc29sZS5sb2coYm9keSk7IH07CiAgICAgICAgICAgICAgICBTdHJvcGhlLmxvZyA9IGZ1bmN0aW9uIChsZXZlbCwgbXNnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2cobGV2ZWwrJyAnK21zZyk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgU3Ryb3BoZS5lcnJvciA9IGZ1bmN0aW9uIChtc2cpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRVJST1I6ICcrbXNnKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gV2hlbiByZWNvbm5lY3RpbmcsIHRoZXJlIG1pZ2h0IGJlIHNvbWUgb3BlbiBjaGF0IGJveGVzLiBXZSBkb24ndAogICAgICAgICAgICAvLyBrbm93IHdoZXRoZXIgdGhlc2UgYm94ZXMgYXJlIG9mIHRoZSBzYW1lIGFjY291bnQgb3Igbm90LCBzbyB3ZQogICAgICAgICAgICAvLyBjbG9zZSB0aGVtIG5vdy4KICAgICAgICAgICAgdGhpcy5jaGF0Ym94dmlld3MuY2xvc2VBbGxDaGF0Qm94ZXMoKTsKICAgICAgICAgICAgdGhpcy5zZXRTZXNzaW9uKCk7CiAgICAgICAgICAgIHRoaXMuamlkID0gdGhpcy5jb25uZWN0aW9uLmppZDsKICAgICAgICAgICAgdGhpcy5iYXJlX2ppZCA9IFN0cm9waGUuZ2V0QmFyZUppZEZyb21KaWQodGhpcy5jb25uZWN0aW9uLmppZCk7CiAgICAgICAgICAgIHRoaXMuZG9tYWluID0gU3Ryb3BoZS5nZXREb21haW5Gcm9tSmlkKHRoaXMuY29ubmVjdGlvbi5qaWQpOwogICAgICAgICAgICB0aGlzLm1pbmltaXplZF9jaGF0cyA9IG5ldyBjb252ZXJzZS5NaW5pbWl6ZWRDaGF0cyh7bW9kZWw6IHRoaXMuY2hhdGJveGVzfSk7CiAgICAgICAgICAgIHRoaXMuZmVhdHVyZXMgPSBuZXcgdGhpcy5GZWF0dXJlcygpOwogICAgICAgICAgICB0aGlzLmVuYWJsZUNhcmJvbnMoKTsKICAgICAgICAgICAgdGhpcy5pbml0U3RhdHVzKCQucHJveHkoZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgICAgIHRoaXMuY2hhdGJveGVzLm9uQ29ubmVjdGVkKCk7CiAgICAgICAgICAgICAgICB0aGlzLmdpdmVGZWVkYmFjayhfXygnT25saW5lIENvbnRhY3RzJykpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jb25uZWN0aW9uLnNlcnZpY2UgPT09ICdqYXNtaW5lIHRlc3RzJykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBYWFg6IENhbGwgYmFjayB3aXRoIHRoZSBpbnRlcm5hbCBjb252ZXJzZSBvYmplY3QuIFRoaXMKICAgICAgICAgICAgICAgICAgICAgICAgLy8gb2JqZWN0IHNob3VsZCBuZXZlciBiZSBleHBvc2VkIHRvIHByb2R1Y3Rpb24gc3lzdGVtcy4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gJ2phc21pbmUgdGVzdHMnIGlzIGFuIGludmFsaWQgaHR0cCBiaW5kIHNlcnZpY2UgdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNvIHdlJ3JlIHN1cmUgdGhhdCB0aGlzIGlzIGp1c3QgZm9yIHRlc3RzLgogICAgICAgICAgICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBXZSBtaWdodCBuZWVkIHRvIGNvbnNpZGVyIHdlYnNvY2tldHMsIHdoaWNoCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHByb2JhYmx5IHdvbid0IHVzZSB0aGUgJ3NlcnZpY2UnIGF0dHIuIEN1cnJlbnQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3Ryb3BoZS5qcyB2ZXJzaW9uIHVzZWQgYnkgY29udmVyc2UuanMgZG9lc24ndCBzdXBwb3J0CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlYnNvY2tldHMuCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2FsbGJhY2sodGhpcyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2FsbGJhY2soKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHRoaXMpKTsKICAgICAgICAgICAgY29udmVyc2UuZW1pdCgncmVhZHknKTsKICAgICAgICB9OwoKICAgICAgICAvLyBCYWNrYm9uZSBNb2RlbHMgYW5kIFZpZXdzCiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIHRoaXMuT1RSID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kKHsKICAgICAgICAgICAgLy8gQSBtb2RlbCBmb3IgbWFuYWdpbmcgT1RSIHNldHRpbmdzLgogICAgICAgICAgICBnZXRTZXNzaW9uUGFzc3BocmFzZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKGNvbnZlcnNlLnByZWJpbmQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIga2V5ID0gYjY0X3NoYTEoY29udmVyc2UuY29ubmVjdGlvbi5qaWQpLAogICAgICAgICAgICAgICAgICAgICAgICBwYXNzID0gd2luZG93LnNlc3Npb25TdG9yYWdlW2tleV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXNzID09PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgICAgICAgICBwYXNzID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpKjQyOTQ5NjcyOTUpLnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5zZXNzaW9uU3RvcmFnZVtrZXldID0gcGFzczsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhc3M7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjb252ZXJzZS5jb25uZWN0aW9uLnBhc3M7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBnZW5lcmF0ZVByaXZhdGVLZXk6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBrZXkgPSBuZXcgRFNBKCk7CiAgICAgICAgICAgICAgICB2YXIgamlkID0gY29udmVyc2UuY29ubmVjdGlvbi5qaWQ7CiAgICAgICAgICAgICAgICBpZiAoY29udmVyc2UuY2FjaGVfb3RyX2tleSkgewogICAgICAgICAgICAgICAgICAgIHZhciBjaXBoZXIgPSBDcnlwdG9KUy5saWIuUGFzc3dvcmRCYXNlZENpcGhlcjsKICAgICAgICAgICAgICAgICAgICB2YXIgcGFzcyA9IHRoaXMuZ2V0U2Vzc2lvblBhc3NwaHJhc2UoKTsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHBhc3MgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVuY3J5cHQgdGhlIGtleSBhbmQgc2V0IGluIHNlc3Npb25TdG9yYWdlLiBBbHNvIHN0b3JlIGluc3RhbmNlIHRhZy4KICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LnNlc3Npb25TdG9yYWdlW2I2NF9zaGExKGppZCsncHJpdl9rZXknKV0gPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2lwaGVyLmVuY3J5cHQoQ3J5cHRvSlMuYWxnby5BRVMsIGtleS5wYWNrUHJpdmF0ZSgpLCBwYXNzKS50b1N0cmluZygpOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuc2Vzc2lvblN0b3JhZ2VbYjY0X3NoYTEoamlkKydpbnN0YW5jZV90YWcnKV0gPSBpbnN0YW5jZV90YWc7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5zZXNzaW9uU3RvcmFnZVtiNjRfc2hhMShqaWQrJ3Bhc3NfY2hlY2snKV0gPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2lwaGVyLmVuY3J5cHQoQ3J5cHRvSlMuYWxnby5BRVMsICdtYXRjaCcsIHBhc3MpLnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGtleTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLk1lc3NhZ2UgPSBCYWNrYm9uZS5Nb2RlbDsKICAgICAgICB0aGlzLk1lc3NhZ2VzID0gQmFja2JvbmUuQ29sbGVjdGlvbi5leHRlbmQoewogICAgICAgICAgICBtb2RlbDogY29udmVyc2UuTWVzc2FnZQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLkNoYXRCb3ggPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQoewogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgaGVpZ2h0ID0gY29udmVyc2UuYXBwbHlIZWlnaHRSZXNpc3RhbmNlKHRoaXMuZ2V0KCdoZWlnaHQnKSk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXQoJ2JveF9pZCcpICE9PSAnY29udHJvbGJveCcpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc3NhZ2VzID0gbmV3IGNvbnZlcnNlLk1lc3NhZ2VzKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNzYWdlcy5icm93c2VyU3RvcmFnZSA9IG5ldyBCYWNrYm9uZS5Ccm93c2VyU3RvcmFnZVtjb252ZXJzZS5zdG9yYWdlXSgKICAgICAgICAgICAgICAgICAgICAgICAgYjY0X3NoYTEoJ2NvbnZlcnNlLm1lc3NhZ2VzJyt0aGlzLmdldCgnamlkJykrY29udmVyc2UuYmFyZV9qaWQpKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNhdmUoewogICAgICAgICAgICAgICAgICAgICAgICAnYm94X2lkJyA6IGI2NF9zaGExKHRoaXMuZ2V0KCdqaWQnKSksCiAgICAgICAgICAgICAgICAgICAgICAgICdoZWlnaHQnOiBoZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgICAgICdtaW5pbWl6ZWQnOiB0aGlzLmdldCgnbWluaW1pemVkJykgfHwgZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICdvdHJfc3RhdHVzJzogdGhpcy5nZXQoJ290cl9zdGF0dXMnKSB8fCBVTkVOQ1JZUFRFRCwKICAgICAgICAgICAgICAgICAgICAgICAgJ3RpbWVfbWluaW1pemVkJzogdGhpcy5nZXQoJ3RpbWVfbWluaW1pemVkJykgfHwgbW9tZW50KCksCiAgICAgICAgICAgICAgICAgICAgICAgICd0aW1lX29wZW5lZCc6IHRoaXMuZ2V0KCd0aW1lX29wZW5lZCcpIHx8IG1vbWVudCgpLnZhbHVlT2YoKSwKICAgICAgICAgICAgICAgICAgICAgICAgJ3VzZXJfaWQnIDogU3Ryb3BoZS5nZXROb2RlRnJvbUppZCh0aGlzLmdldCgnamlkJykpLAogICAgICAgICAgICAgICAgICAgICAgICAnbnVtX3VucmVhZCc6IHRoaXMuZ2V0KCdudW1fdW5yZWFkJykgfHwgMCwKICAgICAgICAgICAgICAgICAgICAgICAgJ3VybCc6ICcnCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0KHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2hlaWdodCc6IGhlaWdodCwKICAgICAgICAgICAgICAgICAgICAgICAgJ3RpbWVfb3BlbmVkJzogbW9tZW50KDApLnZhbHVlT2YoKSwKICAgICAgICAgICAgICAgICAgICAgICAgJ251bV91bnJlYWQnOiB0aGlzLmdldCgnbnVtX3VucmVhZCcpIHx8IDAKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG1heGltaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNhdmUoewogICAgICAgICAgICAgICAgICAgICdtaW5pbWl6ZWQnOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAndGltZV9vcGVuZWQnOiBtb21lbnQoKS52YWx1ZU9mKCkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgbWluaW1pemU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2F2ZSh7CiAgICAgICAgICAgICAgICAgICAgJ21pbmltaXplZCc6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgJ3RpbWVfbWluaW1pemVkJzogbW9tZW50KCkuZm9ybWF0KCkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgZ2V0U2Vzc2lvbjogZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICB2YXIgY2lwaGVyID0gQ3J5cHRvSlMubGliLlBhc3N3b3JkQmFzZWRDaXBoZXI7CiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0LCBwYXNzLCBpbnN0YW5jZV90YWcsIHNhdmVkX2tleSwgcGFzc19jaGVjazsKICAgICAgICAgICAgICAgIGlmIChjb252ZXJzZS5jYWNoZV9vdHJfa2V5KSB7CiAgICAgICAgICAgICAgICAgICAgcGFzcyA9IGNvbnZlcnNlLm90ci5nZXRTZXNzaW9uUGFzc3BocmFzZSgpOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcGFzcyAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VfdGFnID0gd2luZG93LnNlc3Npb25TdG9yYWdlW2I2NF9zaGExKHRoaXMuaWQrJ2luc3RhbmNlX3RhZycpXTsKICAgICAgICAgICAgICAgICAgICAgICAgc2F2ZWRfa2V5ID0gd2luZG93LnNlc3Npb25TdG9yYWdlW2I2NF9zaGExKHRoaXMuaWQrJ3ByaXZfa2V5JyldOwogICAgICAgICAgICAgICAgICAgICAgICBwYXNzX2NoZWNrID0gd2luZG93LnNlc3Npb25TdG9yYWdlW2I2NF9zaGExKHRoaXMuY29ubmVjdGlvbi5qaWQrJ3Bhc3NfY2hlY2snKV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzYXZlZF9rZXkgJiYgaW5zdGFuY2VfdGFnICYmIHR5cGVvZiBwYXNzX2NoZWNrICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRlY3J5cHRlZCA9IGNpcGhlci5kZWNyeXB0KENyeXB0b0pTLmFsZ28uQUVTLCBzYXZlZF9rZXksIHBhc3MpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IERTQS5wYXJzZVByaXZhdGUoZGVjcnlwdGVkLnRvU3RyaW5nKENyeXB0b0pTLmVuYy5MYXRpbjEpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaXBoZXIuZGVjcnlwdChDcnlwdG9KUy5hbGdvLkFFUywgcGFzc19jaGVjaywgcGFzcykudG9TdHJpbmcoQ3J5cHRvSlMuZW5jLkxhdGluMSkgPT09ICdtYXRjaCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBWZXJpZmllZCB0aGF0IHRoZSBwYXNzcGhyYXNlIGlzIHN0aWxsIHRoZSBzYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdzaG93SGVscE1lc3NhZ2VzJywgW19fKCdSZS1lc3RhYmxpc2hpbmcgZW5jcnlwdGVkIHNlc3Npb24nKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2tleSc6IGtleSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2luc3RhbmNlX3RhZyc6IGluc3RhbmNlX3RhZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsgLy8gT3VyIHdvcmsgaXMgZG9uZSBoZXJlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBXZSBuZWVkIHRvIGdlbmVyYXRlIGEgbmV3IGtleSBhbmQgaW5zdGFuY2UgdGFnCiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ3Nob3dIZWxwTWVzc2FnZXMnLCBbCiAgICAgICAgICAgICAgICAgICAgX18oJ0dlbmVyYXRpbmcgcHJpdmF0ZSBrZXkuJyksCiAgICAgICAgICAgICAgICAgICAgX18oJ1lvdXIgYnJvd3NlciBtaWdodCBiZWNvbWUgdW5yZXNwb25zaXZlLicpXSwKICAgICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICAgIHRydWUgLy8gc2hvdyBzcGlubmVyCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soewogICAgICAgICAgICAgICAgICAgICAgICAna2V5JzogY29udmVyc2Uub3RyLmdlbmVyYXRlUHJpdmF0ZUtleS5hcHBseSh0aGlzKSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2luc3RhbmNlX3RhZyc6IE9UUi5tYWtlSW5zdGFuY2VUYWcoKQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwgNTAwKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHVwZGF0ZU9UUlN0YXR1czogZnVuY3Rpb24gKHN0YXRlKSB7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBPVFIuQ09OU1QuU1RBVFVTX0FLRV9TVUNDRVNTOgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vdHIubXNnc3RhdGUgPT09IE9UUi5DT05TVC5NU0dTVEFURV9FTkNSWVBURUQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2F2ZSh7J290cl9zdGF0dXMnOiBVTlZFUklGSUVEfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBPVFIuQ09OU1QuU1RBVFVTX0VORF9PVFI6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm90ci5tc2dzdGF0ZSA9PT0gT1RSLkNPTlNULk1TR1NUQVRFX0ZJTklTSEVEKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNhdmUoeydvdHJfc3RhdHVzJzogRklOSVNIRUR9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLm90ci5tc2dzdGF0ZSA9PT0gT1RSLkNPTlNULk1TR1NUQVRFX1BMQUlOVEVYVCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zYXZlKHsnb3RyX3N0YXR1cyc6IFVORU5DUllQVEVEfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBvblNNUDogZnVuY3Rpb24gKHR5cGUsIGRhdGEpIHsKICAgICAgICAgICAgICAgIC8vIEV2ZW50IGhhbmRsZXIgZm9yIFNNUCAoU29jaWFsaXN0J3MgTWlsbGlvbmFpcmUgUHJvdG9jb2wpCiAgICAgICAgICAgICAgICAvLyB1c2VkIGJ5IE9UUiAob2ZmLXRoZS1yZWNvcmQpLgogICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAncXVlc3Rpb24nOgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm90ci5zbXBTZWNyZXQocHJvbXB0KF9fKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0F1dGhlbnRpY2F0aW9uIHJlcXVlc3QgZnJvbSAlMSRzXG5cbllvdXIgYnVkZHkgaXMgYXR0ZW1wdGluZyB0byB2ZXJpZnkgeW91ciBpZGVudGl0eSwgYnkgYXNraW5nIHlvdSB0aGUgcXVlc3Rpb24gYmVsb3cuXG5cbiUyJHMnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgW3RoaXMuZ2V0KCdmdWxsbmFtZScpLCBkYXRhXSkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAndHJ1c3QnOgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zYXZlKHsnb3RyX3N0YXR1cyc6IFZFUklGSUVEfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3Nob3dIZWxwTWVzc2FnZXMnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtfXygiQ291bGQgbm90IHZlcmlmeSB0aGlzIHVzZXIncyBpZGVudGlmeS4iKV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2Vycm9yJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNhdmUoeydvdHJfc3RhdHVzJzogVU5WRVJJRklFRH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biB0eXBlLicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaW5pdGlhdGVPVFI6IGZ1bmN0aW9uIChxdWVyeV9tc2cpIHsKICAgICAgICAgICAgICAgIC8vIFNldHMgdXAgYW4gT1RSIG9iamVjdCB0aHJvdWdoIHdoaWNoIHdlIGNhbiBzZW5kIGFuZCByZWNlaXZlCiAgICAgICAgICAgICAgICAvLyBlbmNyeXB0ZWQgbWVzc2FnZXMuCiAgICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgICAgLy8gSWYgJ3F1ZXJ5X21zZycgaXMgcGFzc2VkIGluLCBpdCBtZWFucyB0aGVyZSBpcyBhbiBhbHJlYWQgaW5jb21pbmcKICAgICAgICAgICAgICAgIC8vIHF1ZXJ5IG1lc3NhZ2UgZnJvbSBvdXIgYnVkZHkuIE90aGVyd2lzZSwgaXQgaXMgdXMgd2hvIHdpbGwKICAgICAgICAgICAgICAgIC8vIHNlbmQgdGhlIHF1ZXJ5IG1lc3NhZ2UgdG8gdGhlbS4KICAgICAgICAgICAgICAgIHRoaXMuc2F2ZSh7J290cl9zdGF0dXMnOiBVTkVOQ1JZUFRFRH0pOwogICAgICAgICAgICAgICAgdmFyIHNlc3Npb24gPSB0aGlzLmdldFNlc3Npb24oJC5wcm94eShmdW5jdGlvbiAoc2Vzc2lvbikgewogICAgICAgICAgICAgICAgICAgIHRoaXMub3RyID0gbmV3IE9UUih7CiAgICAgICAgICAgICAgICAgICAgICAgIGZyYWdtZW50X3NpemU6IDE0MCwKICAgICAgICAgICAgICAgICAgICAgICAgc2VuZF9pbnRlcnZhbDogMjAwLAogICAgICAgICAgICAgICAgICAgICAgICBwcml2OiBzZXNzaW9uLmtleSwKICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VfdGFnOiBzZXNzaW9uLmluc3RhbmNlX3RhZywKICAgICAgICAgICAgICAgICAgICAgICAgZGVidWc6IHRoaXMuZGVidWcKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm90ci5vbignc3RhdHVzJywgJC5wcm94eSh0aGlzLnVwZGF0ZU9UUlN0YXR1cywgdGhpcykpOwogICAgICAgICAgICAgICAgICAgIHRoaXMub3RyLm9uKCdzbXAnLCAkLnByb3h5KHRoaXMub25TTVAsIHRoaXMpKTsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5vdHIub24oJ3VpJywgJC5wcm94eShmdW5jdGlvbiAobXNnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcignc2hvd1JlY2VpdmVkT1RSTWVzc2FnZScsIG1zZyk7CiAgICAgICAgICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgICAgICAgICAgICAgIHRoaXMub3RyLm9uKCdpbycsICQucHJveHkoZnVuY3Rpb24gKG1zZykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ3NlbmRNZXNzYWdlU3RhbnphJywgbXNnKTsKICAgICAgICAgICAgICAgICAgICB9LCB0aGlzKSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vdHIub24oJ2Vycm9yJywgJC5wcm94eShmdW5jdGlvbiAobXNnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcignc2hvd09UUkVycm9yJywgbXNnKTsKICAgICAgICAgICAgICAgICAgICB9LCB0aGlzKSk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcignc2hvd0hlbHBNZXNzYWdlcycsIFtfXygnRXhjaGFuZ2luZyBwcml2YXRlIGtleSB3aXRoIGJ1ZGR5LicpXSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHF1ZXJ5X21zZykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm90ci5yZWNlaXZlTXNnKHF1ZXJ5X21zZyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vdHIuc2VuZFF1ZXJ5TXNnKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgZW5kT1RSOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5vdHIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm90ci5lbmRPdHIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuc2F2ZSh7J290cl9zdGF0dXMnOiBVTkVOQ1JZUFRFRH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgY3JlYXRlTWVzc2FnZTogZnVuY3Rpb24gKCRtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICB2YXIgYm9keSA9ICRtZXNzYWdlLmNoaWxkcmVuKCdib2R5JykudGV4dCgpLAogICAgICAgICAgICAgICAgICAgIGNvbXBvc2luZyA9ICRtZXNzYWdlLmZpbmQoJ2NvbXBvc2luZycpLAogICAgICAgICAgICAgICAgICAgIHBhdXNlZCA9ICRtZXNzYWdlLmZpbmQoJ3BhdXNlZCcpLAogICAgICAgICAgICAgICAgICAgIGRlbGF5ZWQgPSAkbWVzc2FnZS5maW5kKCdkZWxheScpLmxlbmd0aCA+IDAsCiAgICAgICAgICAgICAgICAgICAgZnVsbG5hbWUgPSB0aGlzLmdldCgnZnVsbG5hbWUnKSwKICAgICAgICAgICAgICAgICAgICBpc19ncm91cGNoYXQgPSAkbWVzc2FnZS5hdHRyKCd0eXBlJykgPT09ICdncm91cGNoYXQnLAogICAgICAgICAgICAgICAgICAgIG1zZ2lkID0gJG1lc3NhZ2UuYXR0cignaWQnKSwKICAgICAgICAgICAgICAgICAgICBzdGFtcCwgdGltZSwgc2VuZGVyLCBmcm9tOwoKICAgICAgICAgICAgICAgIGlmIChpc19ncm91cGNoYXQpIHsKICAgICAgICAgICAgICAgICAgICBmcm9tID0gU3Ryb3BoZS51bmVzY2FwZU5vZGUoU3Ryb3BoZS5nZXRSZXNvdXJjZUZyb21KaWQoJG1lc3NhZ2UuYXR0cignZnJvbScpKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZyb20gPSBTdHJvcGhlLmdldEJhcmVKaWRGcm9tSmlkKCRtZXNzYWdlLmF0dHIoJ2Zyb20nKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmdWxsbmFtZSA9IChfLmlzRW1wdHkoZnVsbG5hbWUpPyBmcm9tOiBmdWxsbmFtZSkuc3BsaXQoJyAnKVswXTsKCiAgICAgICAgICAgICAgICBpZiAoIWJvZHkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY29tcG9zaW5nLmxlbmd0aCB8fCBwYXVzZWQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZJWE1FOiB1c2Ugb25lIGF0dHJpYnV0ZSBmb3IgY2hhdCBzdGF0ZXMgKGUuZy4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2hhdHN0YXRlKSBpbnN0ZWFkIG9mIHNhdmluZyAncGF1c2VkJyBhbmQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gJ2NvbXBvc2luZycgc2VwYXJhdGVseS4KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNzYWdlcy5hZGQoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVsbG5hbWU6IGZ1bGxuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VuZGVyOiAndGhlbScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxheWVkOiBkZWxheWVkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZTogbW9tZW50KCkuZm9ybWF0KCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wb3Npbmc6IGNvbXBvc2luZy5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXVzZWQ6IHBhdXNlZC5sZW5ndGgKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZGVsYXllZCkgewogICAgICAgICAgICAgICAgICAgICAgICBzdGFtcCA9ICRtZXNzYWdlLmZpbmQoJ2RlbGF5JykuYXR0cignc3RhbXAnKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGltZSA9IHN0YW1wOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWUgPSBtb21lbnQoKS5mb3JtYXQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKChpc19ncm91cGNoYXQgJiYgZnJvbSA9PT0gdGhpcy5nZXQoJ25pY2snKSkgfHwgKCFpc19ncm91cGNoYXQgJiYgZnJvbSA9PSBjb252ZXJzZS5iYXJlX2ppZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VuZGVyID0gJ21lJzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBzZW5kZXIgPSAndGhlbSc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMubWVzc2FnZXMuY3JlYXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAgZnVsbG5hbWU6IGZ1bGxuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICBzZW5kZXI6IHNlbmRlciwKICAgICAgICAgICAgICAgICAgICAgICAgZGVsYXllZDogZGVsYXllZCwKICAgICAgICAgICAgICAgICAgICAgICAgdGltZTogdGltZSwKICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogYm9keSwKICAgICAgICAgICAgICAgICAgICAgICAgbXNnaWQ6IG1zZ2lkCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZWNlaXZlTWVzc2FnZTogZnVuY3Rpb24gKCRtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICB2YXIgJGJvZHkgPSAkbWVzc2FnZS5jaGlsZHJlbignYm9keScpOwogICAgICAgICAgICAgICAgdmFyIHRleHQgPSAoJGJvZHkubGVuZ3RoID4gMCA/ICRib2R5LnRleHQoKSA6IHVuZGVmaW5lZCk7CiAgICAgICAgICAgICAgICBpZiAoKCF0ZXh0KSB8fCAoIWNvbnZlcnNlLmFsbG93X290cikpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVNZXNzYWdlKCRtZXNzYWdlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0ZXh0Lm1hdGNoKC9eXD9PVFJ2MjM/LykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmluaXRpYXRlT1RSKHRleHQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoXy5jb250YWlucyhbVU5WRVJJRklFRCwgVkVSSUZJRURdLCB0aGlzLmdldCgnb3RyX3N0YXR1cycpKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm90ci5yZWNlaXZlTXNnKHRleHQpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0ZXh0Lm1hdGNoKC9eXD9PVFIvKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLm90cikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5pdGlhdGVPVFIodGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3RyLnJlY2VpdmVNc2codGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBOb3JtYWwgdW5lbmNyeXB0ZWQgbWVzc2FnZS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlTWVzc2FnZSgkbWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5DaGF0Qm94VmlldyA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKICAgICAgICAgICAgbGVuZ3RoOiAyMDAsCiAgICAgICAgICAgIHRhZ05hbWU6ICdkaXYnLAogICAgICAgICAgICBjbGFzc05hbWU6ICdjaGF0Ym94JywKICAgICAgICAgICAgaXNfY2hhdHJvb206IGZhbHNlLCAgLy8gVGhpcyBpcyBub3QgYSBtdWx0aS11c2VyIGNoYXRyb29tCgogICAgICAgICAgICBldmVudHM6IHsKICAgICAgICAgICAgICAgICdjbGljayAuY2xvc2UtY2hhdGJveC1idXR0b24nOiAnY2xvc2UnLAogICAgICAgICAgICAgICAgJ2NsaWNrIC50b2dnbGUtY2hhdGJveC1idXR0b24nOiAnbWluaW1pemUnLAogICAgICAgICAgICAgICAgJ2tleXByZXNzIHRleHRhcmVhLmNoYXQtdGV4dGFyZWEnOiAna2V5UHJlc3NlZCcsCiAgICAgICAgICAgICAgICAnY2xpY2sgLnRvZ2dsZS1zbWlsZXknOiAndG9nZ2xlRW1vdGljb25NZW51JywKICAgICAgICAgICAgICAgICdjbGljayAudG9nZ2xlLXNtaWxleSB1bCBsaSc6ICdpbnNlcnRFbW90aWNvbicsCiAgICAgICAgICAgICAgICAnY2xpY2sgLnRvZ2dsZS1jbGVhcic6ICdjbGVhck1lc3NhZ2VzJywKICAgICAgICAgICAgICAgICdjbGljayAudG9nZ2xlLW90cic6ICd0b2dnbGVPVFJNZW51JywKICAgICAgICAgICAgICAgICdjbGljayAuc3RhcnQtb3RyJzogJ3N0YXJ0T1RSRnJvbVRvb2xiYXInLAogICAgICAgICAgICAgICAgJ2NsaWNrIC5lbmQtb3RyJzogJ2VuZE9UUicsCiAgICAgICAgICAgICAgICAnY2xpY2sgLmF1dGgtb3RyJzogJ2F1dGhPVFInLAogICAgICAgICAgICAgICAgJ2NsaWNrIC50b2dnbGUtY2FsbCc6ICd0b2dnbGVDYWxsJywKICAgICAgICAgICAgICAgICdtb3VzZWRvd24gLmRyYWdyZXNpemUtdG0nOiAnb25EcmFnUmVzaXplU3RhcnQnCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKXsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwubWVzc2FnZXMub24oJ2FkZCcsIHRoaXMub25NZXNzYWdlQWRkZWQsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbignc2hvdycsIHRoaXMuc2hvdywgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCdkZXN0cm95JywgdGhpcy5oaWRlLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oJ2NoYW5nZScsIHRoaXMub25DaGFuZ2UsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbignc2hvd09UUkVycm9yJywgdGhpcy5zaG93T1RSRXJyb3IsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbignYnVkZHlTdGFydHNPVFInLCB0aGlzLmJ1ZGR5U3RhcnRzT1RSLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oJ3Nob3dIZWxwTWVzc2FnZXMnLCB0aGlzLnNob3dIZWxwTWVzc2FnZXMsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbignc2VuZE1lc3NhZ2VTdGFuemEnLCB0aGlzLnNlbmRNZXNzYWdlU3RhbnphLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oJ3Nob3dTZW50T1RSTWVzc2FnZScsIGZ1bmN0aW9uICh0ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TWVzc2FnZSh7J21lc3NhZ2UnOiB0ZXh0LCAnc2VuZGVyJzogJ21lJ30pOwogICAgICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCdzaG93UmVjZWl2ZWRPVFJNZXNzYWdlJywgZnVuY3Rpb24gKHRleHQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dNZXNzYWdlKHsnbWVzc2FnZSc6IHRleHQsICdzZW5kZXInOiAndGhlbSd9KTsKICAgICAgICAgICAgICAgIH0sIHRoaXMpOwoKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlVkNhcmQoKTsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmluc2VydEFmdGVyKGNvbnZlcnNlLmNoYXRib3h2aWV3cy5nZXQoImNvbnRyb2xib3giKS4kZWwpOwogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIoKS5tb2RlbC5tZXNzYWdlcy5mZXRjaCh7YWRkOiB0cnVlfSk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5tb2RlbC5nZXQoJ21pbmltaXplZCcpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvdygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKChfLmNvbnRhaW5zKFtVTlZFUklGSUVELCBWRVJJRklFRF0sIHRoaXMubW9kZWwuZ2V0KCdvdHJfc3RhdHVzJykpKSB8fCBjb252ZXJzZS51c2Vfb3RyX2J5X2RlZmF1bHQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLmluaXRpYXRlT1RSKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmF0dHIoJ2lkJywgdGhpcy5tb2RlbC5nZXQoJ2JveF9pZCcpKQogICAgICAgICAgICAgICAgICAgIC5odG1sKGNvbnZlcnNlLnRlbXBsYXRlcy5jaGF0Ym94KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5leHRlbmQodGhpcy5tb2RlbC50b0pTT04oKSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaG93X3Rvb2xiYXI6IGNvbnZlcnNlLnNob3dfdG9vbGJhciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWxfcGVyc29uYWxfbWVzc2FnZTogX18oJ1BlcnNvbmFsIG1lc3NhZ2UnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclRvb2xiYXIoKS5yZW5kZXJBdmF0YXIoKTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLmVtaXQoJ2NoYXRCb3hPcGVuZWQnLCB0aGlzKTsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJlZnJlc2hXZWJraXQoKTsKICAgICAgICAgICAgICAgIH0sIDUwKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNob3dTdGF0dXNNZXNzYWdlKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpbml0RHJhZ1Jlc2l6ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy5wcmV2X3BhZ2VZID0gMDsgLy8gVG8gc3RvcmUgbGFzdCBrbm93biBtb3VzZSBwb3NpdGlvbgogICAgICAgICAgICAgICAgaWYgKGNvbnZlcnNlLmNvbm5lY3Rpb24uY29ubmVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSB0aGlzLm1vZGVsLmdldCgnaGVpZ2h0Jyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHNob3dTdGF0dXNOb3RpZmljYXRpb246IGZ1bmN0aW9uIChtZXNzYWdlLCBrZWVwX29sZCkgewogICAgICAgICAgICAgICAgdmFyICRjaGF0X2NvbnRlbnQgPSB0aGlzLiRlbC5maW5kKCcuY2hhdC1jb250ZW50Jyk7CiAgICAgICAgICAgICAgICBpZiAoIWtlZXBfb2xkKSB7CiAgICAgICAgICAgICAgICAgICAgJGNoYXRfY29udGVudC5maW5kKCdkaXYuY2hhdC1ldmVudCcpLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJGNoYXRfY29udGVudC5hcHBlbmQoJCgnPGRpdiBjbGFzcz0iY2hhdC1ldmVudCI+PC9kaXY+JykudGV4dChtZXNzYWdlKSk7CiAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbERvd24oKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGNsZWFyQ2hhdFJvb21NZXNzYWdlczogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGV2ICE9PSAidW5kZWZpbmVkIikgeyBldi5zdG9wUHJvcGFnYXRpb24oKTsgfQogICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGNvbmZpcm0oX18oIkFyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byBjbGVhciB0aGUgbWVzc2FnZXMgZnJvbSB0aGlzIHJvb20/IikpOwogICAgICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLmZpbmQoJy5jaGF0LWNvbnRlbnQnKS5lbXB0eSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzaG93TWVzc2FnZTogZnVuY3Rpb24gKG1zZ19kaWN0KSB7CiAgICAgICAgICAgICAgICB2YXIgJGNvbnRlbnQgPSB0aGlzLiRlbC5maW5kKCcuY2hhdC1jb250ZW50JyksCiAgICAgICAgICAgICAgICAgICAgbXNnX3RpbWUgPSBtb21lbnQobXNnX2RpY3QudGltZSkgfHwgbW9tZW50LAogICAgICAgICAgICAgICAgICAgIHRleHQgPSBtc2dfZGljdC5tZXNzYWdlLAogICAgICAgICAgICAgICAgICAgIG1hdGNoID0gdGV4dC5tYXRjaCgvXlwvKC4qPykoPzogKC4qKSk/JC8pLAogICAgICAgICAgICAgICAgICAgIGZ1bGxuYW1lID0gbXNnX2RpY3QuZnVsbG5hbWUgfHwgdGhpcy5tb2RlbC5nZXQoJ2Z1bGxuYW1lJyksIC8vIFhYWCBQZXJoYXBzIGFsd2F5cyB1c2UgbW9kZWwncz8KICAgICAgICAgICAgICAgICAgICBleHRyYV9jbGFzc2VzID0gbXNnX2RpY3QuZGVsYXllZCAmJiAnZGVsYXllZCcgfHwgJycsCiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUsIHVzZXJuYW1lOwoKICAgICAgICAgICAgICAgIGlmICgobWF0Y2gpICYmIChtYXRjaFsxXSA9PT0gJ21lJykpIHsKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC9eXC9tZS8sICcnKTsKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZSA9IGNvbnZlcnNlLnRlbXBsYXRlcy5hY3Rpb247CiAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWUgPSBmdWxsbmFtZTsKICAgICAgICAgICAgICAgIH0gZWxzZSAgewogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlID0gY29udmVyc2UudGVtcGxhdGVzLm1lc3NhZ2U7CiAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWUgPSBtc2dfZGljdC5zZW5kZXIgPT09ICdtZScgJiYgX18oJ21lJykgfHwgZnVsbG5hbWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkY29udGVudC5maW5kKCdkaXYuY2hhdC1ldmVudCcpLnJlbW92ZSgpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzX2NoYXRyb29tICYmIG1zZ19kaWN0LnNlbmRlciA9PSAndGhlbScgJiYgKG5ldyBSZWdFeHAoIlxcYiIrdGhpcy5tb2RlbC5nZXQoJ25pY2snKSsiXFxiIikpLnRlc3QodGV4dCkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBBZGQgc3BlY2lhbCBjbGFzcyB0byBtYXJrIGdyb3VwY2hhdCBtZXNzYWdlcyBpbiB3aGljaCB3ZQogICAgICAgICAgICAgICAgICAgIC8vIGFyZSBtZW50aW9uZWQuCiAgICAgICAgICAgICAgICAgICAgZXh0cmFfY2xhc3NlcyArPSAnIG1lbnRpb25lZCc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgbWVzc2FnZSA9IHRlbXBsYXRlKHsKICAgICAgICAgICAgICAgICAgICAnc2VuZGVyJzogbXNnX2RpY3Quc2VuZGVyLAogICAgICAgICAgICAgICAgICAgICd0aW1lJzogbXNnX3RpbWUuZm9ybWF0KCdoaDptbScpLAogICAgICAgICAgICAgICAgICAgICd1c2VybmFtZSc6IHVzZXJuYW1lLAogICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJzogJycsCiAgICAgICAgICAgICAgICAgICAgJ2V4dHJhX2NsYXNzZXMnOiBleHRyYV9jbGFzc2VzCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICRjb250ZW50LmFwcGVuZCgkKG1lc3NhZ2UpLmNoaWxkcmVuKCcuY2hhdC1tZXNzYWdlLWNvbnRlbnQnKS5maXJzdCgpLnRleHQodGV4dCkuYWRkSHlwZXJsaW5rcygpLmFkZEVtb3RpY29ucygpLnBhcmVudCgpKTsKICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsRG93bigpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2hvd0hlbHBNZXNzYWdlczogZnVuY3Rpb24gKG1zZ3MsIHR5cGUsIHNwaW5uZXIpIHsKICAgICAgICAgICAgICAgIHZhciAkY2hhdF9jb250ZW50ID0gdGhpcy4kZWwuZmluZCgnLmNoYXQtY29udGVudCcpLCBpLAogICAgICAgICAgICAgICAgICAgIG1zZ3NfbGVuZ3RoID0gbXNncy5sZW5ndGg7CiAgICAgICAgICAgICAgICBmb3IgKGk9MDsgaTxtc2dzX2xlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgJGNoYXRfY29udGVudC5hcHBlbmQoJCgnPGRpdiBjbGFzcz0iY2hhdC0nKyh0eXBlfHwnaW5mbycpKyciPicrbXNnc1tpXSsnPC9kaXY+JykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHNwaW5uZXIgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAkY2hhdF9jb250ZW50LmFwcGVuZCgnPHNwYW4gY2xhc3M9InNwaW5uZXIiLz4nKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3Bpbm5lciA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAkY2hhdF9jb250ZW50LmZpbmQoJ3NwYW4uc3Bpbm5lcicpLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2Nyb2xsRG93bigpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25NZXNzYWdlQWRkZWQ6IGZ1bmN0aW9uIChtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICB2YXIgdGltZSA9IG1lc3NhZ2UuZ2V0KCd0aW1lJyksCiAgICAgICAgICAgICAgICAgICAgdGltZXMgPSB0aGlzLm1vZGVsLm1lc3NhZ2VzLnBsdWNrKCd0aW1lJyksCiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNfbWVzc2FnZSwgaWR4LCB0aGlzX2RhdGUsIHByZXZfZGF0ZSwgdGV4dCwgbWF0Y2g7CgogICAgICAgICAgICAgICAgLy8gSWYgdGhpcyBtZXNzYWdlIGlzIG9uIGEgZGlmZmVyZW50IGRheSB0aGFuIHRoZSBvbmUgcmVjZWl2ZWQKICAgICAgICAgICAgICAgIC8vIHByaW9yLCB0aGVuIGluZGljYXRlIGl0IG9uIHRoZSBjaGF0Ym94LgogICAgICAgICAgICAgICAgaWR4ID0gXy5pbmRleE9mKHRpbWVzLCB0aW1lKS0xOwogICAgICAgICAgICAgICAgaWYgKGlkeCA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNfbWVzc2FnZSA9IHRoaXMubW9kZWwubWVzc2FnZXMuYXQoaWR4KTsKICAgICAgICAgICAgICAgICAgICBwcmV2X2RhdGUgPSBtb21lbnQocHJldmlvdXNfbWVzc2FnZS5nZXQoJ3RpbWUnKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZfZGF0ZS5pc0JlZm9yZSh0aW1lLCAnZGF5JykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpc19kYXRlID0gbW9tZW50KHRpbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5maW5kKCcuY2hhdC1jb250ZW50JykuYXBwZW5kKGNvbnZlcnNlLnRlbXBsYXRlcy5uZXdfZGF5KHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzb2RhdGU6IHRoaXNfZGF0ZS5mb3JtYXQoIllZWVktTU0tREQiKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGVzdHJpbmc6IHRoaXNfZGF0ZS5mb3JtYXQoImRkZGQgTU1NIERvIFlZWVkiKQogICAgICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UuZ2V0KENPTVBPU0lORykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dTdGF0dXNOb3RpZmljYXRpb24obWVzc2FnZS5nZXQoJ2Z1bGxuYW1lJykrJyAnK19fKCdpcyB0eXBpbmcnKSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChtZXNzYWdlLmdldChQQVVTRUQpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93U3RhdHVzTm90aWZpY2F0aW9uKG1lc3NhZ2UuZ2V0KCdmdWxsbmFtZScpKycgJytfXygnaGFzIHN0b3BwZWQgdHlwaW5nJykpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TWVzc2FnZShfLmNsb25lKG1lc3NhZ2UuYXR0cmlidXRlcykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKChtZXNzYWdlLmdldCgnc2VuZGVyJykgIT0gJ21lJykgJiYgKGNvbnZlcnNlLndpbmRvd1N0YXRlID09ICdibHVyJykpIHsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5pbmNyZW1lbnRNc2dDb3VudGVyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zY3JvbGxEb3duKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzZW5kTWVzc2FnZVN0YW56YTogZnVuY3Rpb24gKHRleHQpIHsKICAgICAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAgICAgKiBTZW5kcyB0aGUgYWN0dWFsIFhNTCBzdGFuemEgdG8gdGhlIFhNUFAgc2VydmVyLgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAvLyBUT0RPOiBMb29rIGluIENoYXRQYXJ0bmVycyB0byBzZWUgd2hhdCByZXNvdXJjZXMgd2UgaGF2ZSBmb3IgdGhlIHJlY2lwaWVudC4KICAgICAgICAgICAgICAgIC8vIGlmIHdlIGhhdmUgb25lIHJlc291cmNlLCB3ZSBzZW50IHRvIG9ubHkgdGhhdCByZXNvdXJjZXMsIGlmIHdlIGhhdmUgbXVsdGlwbGUKICAgICAgICAgICAgICAgIC8vIHdlIHNlbmQgdG8gdGhlIGJhcmUgamlkLgogICAgICAgICAgICAgICAgdmFyIHRpbWVzdGFtcCA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7CiAgICAgICAgICAgICAgICB2YXIgYmFyZV9qaWQgPSB0aGlzLm1vZGVsLmdldCgnamlkJyk7CiAgICAgICAgICAgICAgICB2YXIgbWVzc2FnZSA9ICRtc2coe2Zyb206IGNvbnZlcnNlLmNvbm5lY3Rpb24uamlkLCB0bzogYmFyZV9qaWQsIHR5cGU6ICdjaGF0JywgaWQ6IHRpbWVzdGFtcH0pCiAgICAgICAgICAgICAgICAgICAgLmMoJ2JvZHknKS50KHRleHQpLnVwKCkKICAgICAgICAgICAgICAgICAgICAuYygnYWN0aXZlJywgeyd4bWxucyc6ICdodHRwOi8vamFiYmVyLm9yZy9wcm90b2NvbC9jaGF0c3RhdGVzJ30pOwogICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5zZW5kKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgaWYgKGNvbnZlcnNlLmZvcndhcmRfbWVzc2FnZXMpIHsKICAgICAgICAgICAgICAgICAgICAvLyBGb3J3YXJkIHRoZSBtZXNzYWdlLCBzbyB0aGF0IG90aGVyIGNvbm5lY3RlZCByZXNvdXJjZXMgYXJlIGFsc28gYXdhcmUgb2YgaXQuCiAgICAgICAgICAgICAgICAgICAgdmFyIGZvcndhcmRlZCA9ICRtc2coe3RvOmNvbnZlcnNlLmJhcmVfamlkLCB0eXBlOidjaGF0JywgaWQ6dGltZXN0YW1wfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmMoJ2ZvcndhcmRlZCcsIHt4bWxuczondXJuOnhtcHA6Zm9yd2FyZDowJ30pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jKCdkZWxheScsIHt4bW5zOid1cm46eG1wcDpkZWxheScsc3RhbXA6dGltZXN0YW1wfSkudXAoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY25vZGUobWVzc2FnZS50cmVlKCkpOwogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24uc2VuZChmb3J3YXJkZWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2VuZE1lc3NhZ2U6IGZ1bmN0aW9uICh0ZXh0KSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSB0ZXh0LnJlcGxhY2UoL15ccyovLCAiIikubWF0Y2goL15cLyguKilccyokLyksIG1zZ3M7CiAgICAgICAgICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2hbMV0gPT09ICJjbGVhciIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2xlYXJNZXNzYWdlcygpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtYXRjaFsxXSA9PT0gImhlbHAiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1zZ3MgPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPHN0cm9uZz4vaGVscDwvc3Ryb25nPjonK19fKCdTaG93IHRoaXMgbWVudScpKycnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxzdHJvbmc+L21lPC9zdHJvbmc+OicrX18oJ1dyaXRlIGluIHRoZSB0aGlyZCBwZXJzb24nKSsnJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8c3Ryb25nPi9jbGVhcjwvc3Ryb25nPjonK19fKCdSZW1vdmUgbWVzc2FnZXMnKSsnJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93SGVscE1lc3NhZ2VzKG1zZ3MpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoY29udmVyc2UuYWxsb3dfb3RyKSAmJiAobWF0Y2hbMV0gPT09ICJlbmRvdHIiKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lbmRPVFIoKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChjb252ZXJzZS5hbGxvd19vdHIpICYmIChtYXRjaFsxXSA9PT0gIm90ciIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm1vZGVsLmluaXRpYXRlT1RSKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKF8uY29udGFpbnMoW1VOVkVSSUZJRUQsIFZFUklGSUVEXSwgdGhpcy5tb2RlbC5nZXQoJ290cl9zdGF0dXMnKSkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBPZmYtdGhlLXJlY29yZCBlbmNyeXB0aW9uIGlzIGFjdGl2ZQogICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub3RyLnNlbmRNc2codGV4dCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC50cmlnZ2VyKCdzaG93U2VudE9UUk1lc3NhZ2UnLCB0ZXh0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gV2Ugb25seSBzYXZlIHVuZW5jcnlwdGVkIG1lc3NhZ2VzLgogICAgICAgICAgICAgICAgICAgIHZhciBmdWxsbmFtZSA9IGNvbnZlcnNlLnhtcHBzdGF0dXMuZ2V0KCdmdWxsbmFtZScpOwogICAgICAgICAgICAgICAgICAgIGZ1bGxuYW1lID0gXy5pc0VtcHR5KGZ1bGxuYW1lKT8gY29udmVyc2UuYmFyZV9qaWQ6IGZ1bGxuYW1lOwogICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwubWVzc2FnZXMuY3JlYXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAgZnVsbG5hbWU6IGZ1bGxuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICBzZW5kZXI6ICdtZScsCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWU6IG1vbWVudCgpLmZvcm1hdCgpLAogICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiB0ZXh0CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZW5kTWVzc2FnZVN0YW56YSh0ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGtleVByZXNzZWQ6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgdmFyICR0ZXh0YXJlYSA9ICQoZXYudGFyZ2V0KSwKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLCBub3RpZnksIGNvbXBvc2luZzsKICAgICAgICAgICAgICAgIGlmKGV2LmtleUNvZGUgPT0gS0VZLkVOVEVSKSB7CiAgICAgICAgICAgICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlID0gJHRleHRhcmVhLnZhbCgpOwogICAgICAgICAgICAgICAgICAgICR0ZXh0YXJlYS52YWwoJycpLmZvY3VzKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UgIT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm1vZGVsLmdldCgnY2hhdHJvb20nKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZW5kQ2hhdFJvb21NZXNzYWdlKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZW5kTWVzc2FnZShtZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5lbWl0KCdtZXNzYWdlU2VuZCcsIG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5kYXRhKCdjb21wb3NpbmcnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLm1vZGVsLmdldCgnY2hhdHJvb20nKSkgewogICAgICAgICAgICAgICAgICAgIC8vIGNvbXBvc2luZyBkYXRhIGlzIG9ubHkgZm9yIHNpbmdsZSB1c2VyIGNoYXQKICAgICAgICAgICAgICAgICAgICBjb21wb3NpbmcgPSB0aGlzLiRlbC5kYXRhKCdjb21wb3NpbmcnKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbXBvc2luZykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXYua2V5Q29kZSAhPSA0NykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2UgZG9uJ3Qgc2VuZCBjb21wb3NpbmcgbWVzc2FnZXMgaWYgdGhlIG1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN0YXJ0cyB3aXRoIGZvcndhcmQtc2xhc2guCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3RpZnkgPSAkbXNnKHsndG8nOnRoaXMubW9kZWwuZ2V0KCdqaWQnKSwgJ3R5cGUnOiAnY2hhdCd9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jKCdjb21wb3NpbmcnLCB7J3htbG5zJzonaHR0cDovL2phYmJlci5vcmcvcHJvdG9jb2wvY2hhdHN0YXRlcyd9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24uc2VuZChub3RpZnkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLmRhdGEoJ2NvbXBvc2luZycsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG9uRHJhZ1Jlc2l6ZVN0YXJ0OiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGlmICghY29udmVyc2UuYWxsb3dfZHJhZ3Jlc2l6ZSkgeyByZXR1cm4gdHJ1ZTsgfQogICAgICAgICAgICAgICAgLy8gUmVjb3JkIGVsZW1lbnQgYXR0cmlidXRlcyBmb3IgbW91c2VNb3ZlKCkuCiAgICAgICAgICAgICAgICB0aGlzLmhlaWdodCA9IHRoaXMuJGVsLmNoaWxkcmVuKCcuYm94LWZseW91dCcpLmhlaWdodCgpOwogICAgICAgICAgICAgICAgY29udmVyc2UucmVzaXplZF9jaGF0Ym94ID0gdGhpczsKICAgICAgICAgICAgICAgIHRoaXMucHJldl9wYWdlWSA9IGV2LnBhZ2VZOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2V0Q2hhdEJveEhlaWdodDogZnVuY3Rpb24gKGhlaWdodCkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLm1vZGVsLmdldCgnbWluaW1pemVkJykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5jaGlsZHJlbignLmJveC1mbHlvdXQnKVswXS5zdHlsZS5oZWlnaHQgPSBjb252ZXJzZS5hcHBseUhlaWdodFJlc2lzdGFuY2UoaGVpZ2h0KSsncHgnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVzaXplQ2hhdEJveDogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICB2YXIgZGlmZiA9IGV2LnBhZ2VZIC0gdGhpcy5wcmV2X3BhZ2VZOwogICAgICAgICAgICAgICAgaWYgKCFkaWZmKSB7IHJldHVybjsgfQogICAgICAgICAgICAgICAgdGhpcy5oZWlnaHQgLT0gZGlmZjsKICAgICAgICAgICAgICAgIHRoaXMucHJldl9wYWdlWSA9IGV2LnBhZ2VZOwogICAgICAgICAgICAgICAgdGhpcy5zZXRDaGF0Qm94SGVpZ2h0KHRoaXMuaGVpZ2h0KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGNsZWFyTWVzc2FnZXM6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgaWYgKGV2ICYmIGV2LnByZXZlbnREZWZhdWx0KSB7IGV2LnByZXZlbnREZWZhdWx0KCk7IH0KICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBjb25maXJtKF9fKCJBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gY2xlYXIgdGhlIG1lc3NhZ2VzIGZyb20gdGhpcyBjaGF0IGJveD8iKSk7CiAgICAgICAgICAgICAgICBpZiAocmVzdWx0ID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgnLmNoYXQtY29udGVudCcpLmVtcHR5KCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5tZXNzYWdlcy5yZXNldCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwubWVzc2FnZXMuYnJvd3NlclN0b3JhZ2UuX2NsZWFyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGluc2VydEVtb3RpY29uOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGV2LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgnLnRvZ2dsZS1zbWlsZXkgdWwnKS5zbGlkZVRvZ2dsZSgyMDApOwogICAgICAgICAgICAgICAgdmFyICR0ZXh0Ym94ID0gdGhpcy4kZWwuZmluZCgndGV4dGFyZWEuY2hhdC10ZXh0YXJlYScpOwogICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gJHRleHRib3gudmFsKCk7CiAgICAgICAgICAgICAgICB2YXIgJHRhcmdldCA9ICQoZXYudGFyZ2V0KTsKICAgICAgICAgICAgICAgICR0YXJnZXQgPSAkdGFyZ2V0LmlzKCdhJykgPyAkdGFyZ2V0IDogJHRhcmdldC5jaGlsZHJlbignYScpOwogICAgICAgICAgICAgICAgaWYgKHZhbHVlICYmICh2YWx1ZVt2YWx1ZS5sZW5ndGgtMV0gIT09ICcgJykpIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlICsgJyAnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJHRleHRib3guZm9jdXMoKS52YWwodmFsdWUrJHRhcmdldC5kYXRhKCdlbW90aWNvbicpKycgJyk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB0b2dnbGVFbW90aWNvbk1lbnU6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgZXYuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5maW5kKCcudG9nZ2xlLXNtaWxleSB1bCcpLnNsaWRlVG9nZ2xlKDIwMCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB0b2dnbGVPVFJNZW51OiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGV2LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgnLnRvZ2dsZS1vdHIgdWwnKS5zbGlkZVRvZ2dsZSgyMDApOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2hvd09UUkVycm9yOiBmdW5jdGlvbiAobXNnKSB7CiAgICAgICAgICAgICAgICBpZiAobXNnID09ICdNZXNzYWdlIGNhbm5vdCBiZSBzZW50IGF0IHRoaXMgdGltZS4nKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93SGVscE1lc3NhZ2VzKAogICAgICAgICAgICAgICAgICAgICAgICBbX18oJ1lvdXIgbWVzc2FnZSBjb3VsZCBub3QgYmUgc2VudCcpXSwgJ2Vycm9yJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1zZyA9PSAnUmVjZWl2ZWQgYW4gdW5lbmNyeXB0ZWQgbWVzc2FnZS4nKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93SGVscE1lc3NhZ2VzKAogICAgICAgICAgICAgICAgICAgICAgICBbX18oJ1dlIHJlY2VpdmVkIGFuIHVuZW5jcnlwdGVkIG1lc3NhZ2UnKV0sICdlcnJvcicpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChtc2cgPT0gJ1JlY2VpdmVkIGFuIHVucmVhZGFibGUgZW5jcnlwdGVkIG1lc3NhZ2UuJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0hlbHBNZXNzYWdlcygKICAgICAgICAgICAgICAgICAgICAgICAgW19fKCdXZSByZWNlaXZlZCBhbiB1bnJlYWRhYmxlIGVuY3J5cHRlZCBtZXNzYWdlJyldLAogICAgICAgICAgICAgICAgICAgICAgICAnZXJyb3InKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93SGVscE1lc3NhZ2VzKFsnRW5jcnlwdGlvbiBlcnJvciBvY2N1cmVkOiAnK21zZ10sICdlcnJvcicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIk9UUiBFUlJPUjoiK21zZyk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBidWRkeVN0YXJ0c09UUjogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICB0aGlzLnNob3dIZWxwTWVzc2FnZXMoW19fKCdUaGlzIHVzZXIgaGFzIHJlcXVlc3RlZCBhbiBlbmNyeXB0ZWQgc2Vzc2lvbi4nKV0pOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5pbml0aWF0ZU9UUigpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc3RhcnRPVFJGcm9tVG9vbGJhcjogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICAkKGV2LnRhcmdldCkucGFyZW50KCkucGFyZW50KCkuc2xpZGVVcCgpOwogICAgICAgICAgICAgICAgZXYuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLmluaXRpYXRlT1RSKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBlbmRPVFI6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBldiAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgIGV2LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5lbmRPVFIoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGF1dGhPVFI6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgdmFyIHNjaGVtZSA9ICQoZXYudGFyZ2V0KS5kYXRhKCkuc2NoZW1lOwogICAgICAgICAgICAgICAgdmFyIHJlc3VsdCwgcXVlc3Rpb24sIGFuc3dlcjsKICAgICAgICAgICAgICAgIGlmIChzY2hlbWUgPT09ICdmaW5nZXJwcmludCcpIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBjb25maXJtKF9fKCdIZXJlIGFyZSB0aGUgZmluZ2VycHJpbnRzLCBwbGVhc2UgY29uZmlybSB0aGVtIHdpdGggJTEkcywgb3V0c2lkZSBvZiB0aGlzIGNoYXQuXG5cbkZpbmdlcnByaW50IGZvciB5b3UsICUyJHM6ICUzJHNcblxuRmluZ2VycHJpbnQgZm9yICUxJHM6ICU0JHNcblxuSWYgeW91IGhhdmUgY29uZmlybWVkIHRoYXQgdGhlIGZpbmdlcnByaW50cyBtYXRjaCwgY2xpY2sgT0ssIG90aGVyd2lzZSBjbGljayBDYW5jZWwuJywgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5nZXQoJ2Z1bGxuYW1lJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS54bXBwc3RhdHVzLmdldCgnZnVsbG5hbWUnKXx8Y29udmVyc2UuYmFyZV9qaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm90ci5wcml2LmZpbmdlcnByaW50KCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm90ci50aGVpcl9wcml2X3BrLmZpbmdlcnByaW50KCkKICAgICAgICAgICAgICAgICAgICAgICAgXQogICAgICAgICAgICAgICAgICAgICkpOwogICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5zYXZlKHsnb3RyX3N0YXR1cyc6IFZFUklGSUVEfSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5zYXZlKHsnb3RyX3N0YXR1cyc6IFVOVkVSSUZJRUR9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNjaGVtZSA9PT0gJ3NtcCcpIHsKICAgICAgICAgICAgICAgICAgICBhbGVydChfXygnWW91IHdpbGwgYmUgcHJvbXB0ZWQgdG8gcHJvdmlkZSBhIHNlY3VyaXR5IHF1ZXN0aW9uIGFuZCB0aGVuIGFuIGFuc3dlciB0byB0aGF0IHF1ZXN0aW9uLlxuXG5Zb3VyIGJ1ZGR5IHdpbGwgdGhlbiBiZSBwcm9tcHRlZCB0aGUgc2FtZSBxdWVzdGlvbiBhbmQgaWYgdGhleSB0eXBlIHRoZSBleGFjdCBzYW1lIGFuc3dlciAoY2FzZSBzZW5zaXRpdmUpLCB0aGVpciBpZGVudGl0eSB3aWxsIGJlIHZlcmlmaWVkLicpKTsKICAgICAgICAgICAgICAgICAgICBxdWVzdGlvbiA9IHByb21wdChfXygnV2hhdCBpcyB5b3VyIHNlY3VyaXR5IHF1ZXN0aW9uPycpKTsKICAgICAgICAgICAgICAgICAgICBpZiAocXVlc3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgYW5zd2VyID0gcHJvbXB0KF9fKCdXaGF0IGlzIHRoZSBhbnN3ZXIgdG8gdGhlIHNlY3VyaXR5IHF1ZXN0aW9uPycpKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vdHIuc21wU2VjcmV0KGFuc3dlciwgcXVlc3Rpb24pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93SGVscE1lc3NhZ2VzKFtfXygnSW52YWxpZCBhdXRoZW50aWNhdGlvbiBzY2hlbWUgcHJvdmlkZWQnKV0sICdlcnJvcicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgdG9nZ2xlQ2FsbDogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBldi5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLmVtaXQoJ2NhbGxCdXR0b25DbGlja2VkJywgewogICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb246IGNvbnZlcnNlLmNvbm5lY3Rpb24sCiAgICAgICAgICAgICAgICAgICAgbW9kZWw6IHRoaXMubW9kZWwKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25DaGFuZ2U6IGZ1bmN0aW9uIChpdGVtLCBjaGFuZ2VkKSB7CiAgICAgICAgICAgICAgICBpZiAoXy5oYXMoaXRlbS5jaGFuZ2VkLCAnY2hhdF9zdGF0dXMnKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBjaGF0X3N0YXR1cyA9IGl0ZW0uZ2V0KCdjaGF0X3N0YXR1cycpLAogICAgICAgICAgICAgICAgICAgICAgICBmdWxsbmFtZSA9IGl0ZW0uZ2V0KCdmdWxsbmFtZScpOwogICAgICAgICAgICAgICAgICAgIGZ1bGxuYW1lID0gXy5pc0VtcHR5KGZ1bGxuYW1lKT8gaXRlbS5nZXQoJ2ppZCcpOiBmdWxsbmFtZTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy4kZWwuaXMoJzp2aXNpYmxlJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoYXRfc3RhdHVzID09PSAnb2ZmbGluZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1N0YXR1c05vdGlmaWNhdGlvbihmdWxsbmFtZSsnICcrJ2hhcyBnb25lIG9mZmxpbmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjaGF0X3N0YXR1cyA9PT0gJ2F3YXknKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dTdGF0dXNOb3RpZmljYXRpb24oZnVsbG5hbWUrJyAnKydoYXMgZ29uZSBhd2F5Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGNoYXRfc3RhdHVzID09PSAnZG5kJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1N0YXR1c05vdGlmaWNhdGlvbihmdWxsbmFtZSsnICcrJ2lzIGJ1c3knKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjaGF0X3N0YXR1cyA9PT0gJ29ubGluZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLmZpbmQoJ2Rpdi5jaGF0LWV2ZW50JykucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuZW1pdCgnYnVkZHlTdGF0dXNDaGFuZ2VkJywgaXRlbS5hdHRyaWJ1dGVzLCBpdGVtLmdldCgnY2hhdF9zdGF0dXMnKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoXy5oYXMoaXRlbS5jaGFuZ2VkLCAnc3RhdHVzJykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dTdGF0dXNNZXNzYWdlKCk7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuZW1pdCgnYnVkZHlTdGF0dXNNZXNzYWdlQ2hhbmdlZCcsIGl0ZW0uYXR0cmlidXRlcywgaXRlbS5nZXQoJ3N0YXR1cycpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChfLmhhcyhpdGVtLmNoYW5nZWQsICdpbWFnZScpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJBdmF0YXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChfLmhhcyhpdGVtLmNoYW5nZWQsICdvdHJfc3RhdHVzJykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclRvb2xiYXIoKS5pbmZvcm1PVFJDaGFuZ2UoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChfLmhhcyhpdGVtLmNoYW5nZWQsICdtaW5pbWl6ZWQnKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmdldCgnbWluaW1pemVkJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tYXhpbWl6ZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIFRPRE8gY2hlY2sgZm9yIGNoYW5nZWQgZnVsbG5hbWUgYXMgd2VsbAogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2hvd1N0YXR1c01lc3NhZ2U6IGZ1bmN0aW9uIChtc2cpIHsKICAgICAgICAgICAgICAgIG1zZyA9IG1zZyB8fCB0aGlzLm1vZGVsLmdldCgnc3RhdHVzJyk7CiAgICAgICAgICAgICAgICBpZiAobXNnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgncC51c2VyLWN1c3RvbS1tZXNzYWdlJykudGV4dChtc2cpLmF0dHIoJ3RpdGxlJywgbXNnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgY2xvc2U6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgaWYgKGV2ICYmIGV2LnByZXZlbnREZWZhdWx0KSB7IGV2LnByZXZlbnREZWZhdWx0KCk7IH0KICAgICAgICAgICAgICAgIGlmIChjb252ZXJzZS5jb25uZWN0aW9uLmNvbm5lY3RlZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLnRyaWdnZXIoJ2hpZGUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnZlcnNlLmVtaXQoJ2NoYXRCb3hDbG9zZWQnLCB0aGlzKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgbWF4aW1pemU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIC8vIFJlc3RvcmVzIGEgbWluaW1pemVkIGNoYXQgYm94CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5pbnNlcnRBZnRlcihjb252ZXJzZS5jaGF0Ym94dmlld3MuZ2V0KCJjb250cm9sYm94IikuJGVsKS5zaG93KCdmYXN0JywgJC5wcm94eShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UucmVmcmVzaFdlYmtpdCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZm9jdXMoKTsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5lbWl0KCdjaGF0Qm94TWF4aW1pemVkJywgdGhpcyk7CiAgICAgICAgICAgICAgICB9LCB0aGlzKSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBtaW5pbWl6ZTogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBpZiAoZXYgJiYgZXYucHJldmVudERlZmF1bHQpIHsgZXYucHJldmVudERlZmF1bHQoKTsgfQogICAgICAgICAgICAgICAgLy8gTWluaW1pemVzIGEgY2hhdCBib3gKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwubWluaW1pemUoKTsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmhpZGUoJ2Zhc3QnLCBjb252ZXJzZS5yZWZyZXNod2Via2l0KTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLmVtaXQoJ2NoYXRCb3hNaW5pbWl6ZWQnLCB0aGlzKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHVwZGF0ZVZDYXJkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgamlkID0gdGhpcy5tb2RlbC5nZXQoJ2ppZCcpLAogICAgICAgICAgICAgICAgICAgIGNvbnRhY3QgPSBjb252ZXJzZS5yb3N0ZXIuZ2V0KGppZCk7CiAgICAgICAgICAgICAgICBpZiAoKGNvbnRhY3QpICYmICghY29udGFjdC5nZXQoJ3ZjYXJkX3VwZGF0ZWQnKSkpIHsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5nZXRWQ2FyZCgKICAgICAgICAgICAgICAgICAgICAgICAgamlkLAogICAgICAgICAgICAgICAgICAgICAgICAkLnByb3h5KGZ1bmN0aW9uIChqaWQsIGZ1bGxuYW1lLCBpbWFnZSwgaW1hZ2VfdHlwZSwgdXJsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLnNhdmUoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdmdWxsbmFtZScgOiBmdWxsbmFtZSB8fCBqaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3VybCc6IHVybCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnaW1hZ2VfdHlwZSc6IGltYWdlX3R5cGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2ltYWdlJzogaW1hZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9LCB0aGlzKSwKICAgICAgICAgICAgICAgICAgICAgICAgJC5wcm94eShmdW5jdGlvbiAoc3RhbnphKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5sb2coIkNoYXRCb3hWaWV3LmluaXRpYWxpemU6IEFuIGVycm9yIG9jY3VyZWQgd2hpbGUgZmV0Y2hpbmcgdmNhcmQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSwgdGhpcykKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaW5mb3JtT1RSQ2hhbmdlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IHRoaXMubW9kZWwudG9KU09OKCk7CiAgICAgICAgICAgICAgICB2YXIgbXNncyA9IFtdOwogICAgICAgICAgICAgICAgaWYgKGRhdGEub3RyX3N0YXR1cyA9PSBVTkVOQ1JZUFRFRCkgewogICAgICAgICAgICAgICAgICAgIG1zZ3MucHVzaChfXygiWW91ciBtZXNzYWdlcyBhcmUgbm90IGVuY3J5cHRlZCBhbnltb3JlIikpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhLm90cl9zdGF0dXMgPT0gVU5WRVJJRklFRCl7CiAgICAgICAgICAgICAgICAgICAgbXNncy5wdXNoKF9fKCJZb3VyIG1lc3NhZ2VzIGFyZSBub3cgZW5jcnlwdGVkIGJ1dCB5b3VyIGJ1ZGR5J3MgaWRlbnRpdHkgaGFzIG5vdCBiZWVuIHZlcmlmaWVkLiIpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YS5vdHJfc3RhdHVzID09IFZFUklGSUVEKXsKICAgICAgICAgICAgICAgICAgICBtc2dzLnB1c2goX18oIllvdXIgYnVkZHkncyBpZGVudGlmeSBoYXMgYmVlbiB2ZXJpZmllZC4iKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRhdGEub3RyX3N0YXR1cyA9PSBGSU5JU0hFRCl7CiAgICAgICAgICAgICAgICAgICAgbXNncy5wdXNoKF9fKCJZb3VyIGJ1ZGR5IGhhcyBlbmRlZCBlbmNyeXB0aW9uIG9uIHRoZWlyIGVuZCwgeW91IHNob3VsZCBkbyB0aGUgc2FtZS4iKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zaG93SGVscE1lc3NhZ2VzKG1zZ3MsICdpbmZvJywgZmFsc2UpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVuZGVyVG9vbGJhcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKGNvbnZlcnNlLnNob3dfdG9vbGJhcikgewogICAgICAgICAgICAgICAgICAgIHZhciBkYXRhID0gdGhpcy5tb2RlbC50b0pTT04oKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5vdHJfc3RhdHVzID09IFVORU5DUllQVEVEKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEub3RyX3Rvb2x0aXAgPSBfXygnWW91ciBtZXNzYWdlcyBhcmUgbm90IGVuY3J5cHRlZC4gQ2xpY2sgaGVyZSB0byBlbmFibGUgT1RSIGVuY3J5cHRpb24uJyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhLm90cl9zdGF0dXMgPT0gVU5WRVJJRklFRCl7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEub3RyX3Rvb2x0aXAgPSBfXygnWW91ciBtZXNzYWdlcyBhcmUgZW5jcnlwdGVkLCBidXQgeW91ciBidWRkeSBoYXMgbm90IGJlZW4gdmVyaWZpZWQuJyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhLm90cl9zdGF0dXMgPT0gVkVSSUZJRUQpewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLm90cl90b29sdGlwID0gX18oJ1lvdXIgbWVzc2FnZXMgYXJlIGVuY3J5cHRlZCBhbmQgeW91ciBidWRkeSB2ZXJpZmllZC4nKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRhdGEub3RyX3N0YXR1cyA9PSBGSU5JU0hFRCl7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEub3RyX3Rvb2x0aXAgPSBfXygnWW91ciBidWRkeSBoYXMgY2xvc2VkIHRoZWlyIGVuZCBvZiB0aGUgcHJpdmF0ZSBzZXNzaW9uLCB5b3Ugc2hvdWxkIGRvIHRoZSBzYW1lJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLmZpbmQoJy5jaGF0LXRvb2xiYXInKS5odG1sKAogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS50ZW1wbGF0ZXMudG9vbGJhcigKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uZXh0ZW5kKGRhdGEsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBGSU5JU0hFRDogRklOSVNIRUQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVU5FTkNSWVBURUQ6IFVORU5DUllQVEVELAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFVOVkVSSUZJRUQ6IFVOVkVSSUZJRUQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVkVSSUZJRUQ6IFZFUklGSUVELAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsbG93X290cjogY29udmVyc2UuYWxsb3dfb3RyICYmICF0aGlzLmlzX2NoYXRyb29tLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsX2NsZWFyOiBfXygnQ2xlYXIgYWxsIG1lc3NhZ2VzJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWxfZW5kX2VuY3J5cHRlZF9jb252ZXJzYXRpb246IF9fKCdFbmQgZW5jcnlwdGVkIGNvbnZlcnNhdGlvbicpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsX2hpZGVfcGFydGljaXBhbnRzOiBfXygnSGlkZSB0aGUgbGlzdCBvZiBwYXJ0aWNpcGFudHMnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbF9yZWZyZXNoX2VuY3J5cHRlZF9jb252ZXJzYXRpb246IF9fKCdSZWZyZXNoIGVuY3J5cHRlZCBjb252ZXJzYXRpb24nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbF9zdGFydF9jYWxsOiBfXygnU3RhcnQgYSBjYWxsJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWxfc3RhcnRfZW5jcnlwdGVkX2NvbnZlcnNhdGlvbjogX18oJ1N0YXJ0IGVuY3J5cHRlZCBjb252ZXJzYXRpb24nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbF92ZXJpZnlfd2l0aF9maW5nZXJwcmludHM6IF9fKCdWZXJpZnkgd2l0aCBmaW5nZXJwcmludHMnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbF92ZXJpZnlfd2l0aF9zbXA6IF9fKCdWZXJpZnkgd2l0aCBTTVAnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbF93aGF0c190aGlzOiBfXygiV2hhdFwncyB0aGlzPyIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG90cl9zdGF0dXNfY2xhc3M6IE9UUl9DTEFTU19NQVBQSU5HW2RhdGEub3RyX3N0YXR1c10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3RyX3RyYW5zbGF0ZWRfc3RhdHVzOiBPVFJfVFJBTlNMQVRFRF9NQVBQSU5HW2RhdGEub3RyX3N0YXR1c10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvd19jYWxsX2J1dHRvbjogY29udmVyc2UudmlzaWJsZV90b29sYmFyX2J1dHRvbnMuY2FsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaG93X2NsZWFyX2J1dHRvbjogY29udmVyc2UudmlzaWJsZV90b29sYmFyX2J1dHRvbnMuY2xlYXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvd19lbW90aWNvbnM6IGNvbnZlcnNlLnZpc2libGVfdG9vbGJhcl9idXR0b25zLmVtb3RpY29ucywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaG93X3BhcnRpY2lwYW50c190b2dnbGU6IHRoaXMuaXNfY2hhdHJvb20gJiYgY29udmVyc2UudmlzaWJsZV90b29sYmFyX2J1dHRvbnMudG9nZ2xlX3BhcnRpY2lwYW50cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlbmRlckF2YXRhcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLm1vZGVsLmdldCgnaW1hZ2UnKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBpbWdfc3JjID0gJ2RhdGE6Jyt0aGlzLm1vZGVsLmdldCgnaW1hZ2VfdHlwZScpKyc7YmFzZTY0LCcrdGhpcy5tb2RlbC5nZXQoJ2ltYWdlJyksCiAgICAgICAgICAgICAgICAgICAgY2FudmFzID0gJCgnPGNhbnZhcyBoZWlnaHQ9IjMxcHgiIHdpZHRoPSIzMXB4IiBjbGFzcz0iYXZhdGFyIj48L2NhbnZhcz4nKS5nZXQoMCk7CgogICAgICAgICAgICAgICAgaWYgKCEoY2FudmFzLmdldENvbnRleHQgJiYgY2FudmFzLmdldENvbnRleHQoJzJkJykpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgY3R4ID0gY2FudmFzLmdldENvbnRleHQoJzJkJyk7CiAgICAgICAgICAgICAgICB2YXIgaW1nID0gbmV3IEltYWdlKCk7ICAgLy8gQ3JlYXRlIG5ldyBJbWFnZSBvYmplY3QKICAgICAgICAgICAgICAgIGltZy5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJhdGlvID0gaW1nLndpZHRoL2ltZy5oZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgY3R4LmRyYXdJbWFnZShpbWcsIDAsMCwgMzUqcmF0aW8sIDM1KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpbWcuc3JjID0gaW1nX3NyYzsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmZpbmQoJy5jaGF0LXRpdGxlJykuYmVmb3JlKGNhbnZhcyk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGZvY3VzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5maW5kKCcuY2hhdC10ZXh0YXJlYScpLmZvY3VzKCk7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5lbWl0KCdjaGF0Qm94Rm9jdXNlZCcsIHRoaXMpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBoaWRlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy4kZWwuaXMoJzp2aXNpYmxlJykgJiYgdGhpcy4kZWwuY3NzKCdvcGFjaXR5JykgPT0gIjEiKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJlZnJlc2hXZWJraXQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2hvdzogZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy4kZWwuaXMoJzp2aXNpYmxlJykgJiYgdGhpcy4kZWwuY3NzKCdvcGFjaXR5JykgPT0gIjEiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZm9jdXMoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuJGVsLmZhZGVJbihjYWxsYmFjayk7CiAgICAgICAgICAgICAgICBpZiAoY29udmVyc2UuY29ubmVjdGlvbi5jb25uZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBXaXRob3V0IGEgY29ubmVjdGlvbiwgd2UgaGF2ZW4ndCB5ZXQgaW5pdGlhbGl6ZWQKICAgICAgICAgICAgICAgICAgICAvLyBsb2NhbHN0b3JhZ2UKICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLnNhdmUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmluaXREcmFnUmVzaXplKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHNjcm9sbERvd246IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciAkY29udGVudCA9IHRoaXMuJCgnLmNoYXQtY29udGVudCcpOwogICAgICAgICAgICAgICAgaWYgKCRjb250ZW50LmlzKCc6dmlzaWJsZScpKSB7CiAgICAgICAgICAgICAgICAgICAgJGNvbnRlbnQuc2Nyb2xsVG9wKCRjb250ZW50WzBdLnNjcm9sbEhlaWdodCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLkNvbnRhY3RzUGFuZWwgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZCh7CiAgICAgICAgICAgIHRhZ05hbWU6ICdkaXYnLAogICAgICAgICAgICBjbGFzc05hbWU6ICdjb250cm9sYm94LXBhbmUnLAogICAgICAgICAgICBpZDogJ3VzZXJzJywKICAgICAgICAgICAgZXZlbnRzOiB7CiAgICAgICAgICAgICAgICAnY2xpY2sgYS50b2dnbGUteG1wcC1jb250YWN0LWZvcm0nOiAndG9nZ2xlQ29udGFjdEZvcm0nLAogICAgICAgICAgICAgICAgJ3N1Ym1pdCBmb3JtLmFkZC14bXBwLWNvbnRhY3QnOiAnYWRkQ29udGFjdEZyb21Gb3JtJywKICAgICAgICAgICAgICAgICdzdWJtaXQgZm9ybS5zZWFyY2gteG1wcC1jb250YWN0JzogJ3NlYXJjaENvbnRhY3RzJywKICAgICAgICAgICAgICAgICdjbGljayBhLnN1YnNjcmliZS10by11c2VyJzogJ2FkZENvbnRhY3RGcm9tTGlzdCcKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uIChjZmcpIHsKICAgICAgICAgICAgICAgIGNmZy4kcGFyZW50LmFwcGVuZCh0aGlzLiRlbCk7CiAgICAgICAgICAgICAgICB0aGlzLiR0YWJzID0gY2ZnLiRwYXJlbnQucGFyZW50KCkuZmluZCgnI2NvbnRyb2xib3gtdGFicycpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgbWFya3VwOwogICAgICAgICAgICAgICAgdmFyIHdpZGdldHMgPSBjb252ZXJzZS50ZW1wbGF0ZXMuY29udGFjdHNfcGFuZWwoewogICAgICAgICAgICAgICAgICAgIGxhYmVsX29ubGluZTogX18oJ09ubGluZScpLAogICAgICAgICAgICAgICAgICAgIGxhYmVsX2J1c3k6IF9fKCdCdXN5JyksCiAgICAgICAgICAgICAgICAgICAgbGFiZWxfYXdheTogX18oJ0F3YXknKSwKICAgICAgICAgICAgICAgICAgICBsYWJlbF9vZmZsaW5lOiBfXygnT2ZmbGluZScpLAogICAgICAgICAgICAgICAgICAgIGxhYmVsX2xvZ291dDogX18oJ0xvZyBvdXQnKSwKICAgICAgICAgICAgICAgICAgICBhbGxvd19sb2dvdXQ6IGNvbnZlcnNlLmFsbG93X2xvZ291dAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLiR0YWJzLmFwcGVuZChjb252ZXJzZS50ZW1wbGF0ZXMuY29udGFjdHNfdGFiKHtsYWJlbF9jb250YWN0czogTEFCRUxfQ09OVEFDVFN9KSk7CiAgICAgICAgICAgICAgICBpZiAoY29udmVyc2UueGhyX3VzZXJfc2VhcmNoKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya3VwID0gY29udmVyc2UudGVtcGxhdGVzLnNlYXJjaF9jb250YWN0KHsKICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWxfY29udGFjdF9uYW1lOiBfXygnQ29udGFjdCBuYW1lJyksCiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsX3NlYXJjaDogX18oJ1NlYXJjaCcpCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG1hcmt1cCA9IGNvbnZlcnNlLnRlbXBsYXRlcy5hZGRfY29udGFjdF9mb3JtKHsKICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWxfY29udGFjdF91c2VybmFtZTogX18oJ0NvbnRhY3QgdXNlcm5hbWUnKSwKICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWxfYWRkOiBfXygnQWRkJykKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChjb252ZXJzZS5hbGxvd19jb250YWN0X3JlcXVlc3RzKSB7CiAgICAgICAgICAgICAgICAgICAgd2lkZ2V0cyArPSBjb252ZXJzZS50ZW1wbGF0ZXMuYWRkX2NvbnRhY3RfZHJvcGRvd24oewogICAgICAgICAgICAgICAgICAgICAgICBsYWJlbF9jbGlja190b19jaGF0OiBfXygnQ2xpY2sgdG8gYWRkIG5ldyBjaGF0IGNvbnRhY3RzJyksCiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsX2FkZF9jb250YWN0OiBfXygnQWRkIGEgY29udGFjdCcpCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5odG1sKHdpZGdldHMpOwogICAgICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgnLnNlYXJjaC14bXBwIHVsJykuYXBwZW5kKG1hcmt1cCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHRvZ2dsZUNvbnRhY3RGb3JtOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5maW5kKCcuc2VhcmNoLXhtcHAnKS50b2dnbGUoJ2Zhc3QnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCQodGhpcykuaXMoJzp2aXNpYmxlJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5maW5kKCdpbnB1dC51c2VybmFtZScpLmZvY3VzKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzZWFyY2hDb250YWN0czogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgJC5nZXRKU09OKGNvbnZlcnNlLnhocl91c2VyX3NlYXJjaF91cmwrICI/cT0iICsgJChldi50YXJnZXQpLmZpbmQoJ2lucHV0LnVzZXJuYW1lJykudmFsKCksIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyICR1bD0gJCgnLnNlYXJjaC14bXBwIHVsJyk7CiAgICAgICAgICAgICAgICAgICAgJHVsLmZpbmQoJ2xpLmZvdW5kLXVzZXInKS5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICAkdWwuZmluZCgnbGkuY2hhdC1pbmZvJykucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFkYXRhLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAkdWwuYXBwZW5kKCc8bGkgY2xhc3M9ImNoYXQtaW5mbyI+JytfXygnTm8gdXNlcnMgZm91bmQnKSsnPC9saT4nKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgJChkYXRhKS5lYWNoKGZ1bmN0aW9uIChpZHgsIG9iaikgewogICAgICAgICAgICAgICAgICAgICAgICAkdWwuYXBwZW5kKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnPGxpIGNsYXNzPSJmb3VuZC11c2VyIj48L2xpPicpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYXBwZW5kKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJzxhIGNsYXNzPSJzdWJzY3JpYmUtdG8tdXNlciIgaHJlZj0iIyIgdGl0bGU9IicrX18oJ0NsaWNrIHRvIGFkZCBhcyBhIGNoYXQgY29udGFjdCcpKyciPjwvYT4nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5hdHRyKCdkYXRhLXJlY2lwaWVudCcsIFN0cm9waGUuZXNjYXBlTm9kZShvYmouaWQpKydAJytjb252ZXJzZS5kb21haW4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRleHQob2JqLmZ1bGxuYW1lKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBhZGRDb250YWN0RnJvbUZvcm06IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIHZhciAkaW5wdXQgPSAkKGV2LnRhcmdldCkuZmluZCgnaW5wdXQnKTsKICAgICAgICAgICAgICAgIHZhciBqaWQgPSAkaW5wdXQudmFsKCk7CiAgICAgICAgICAgICAgICBpZiAoISBqaWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIGlzIG5vdCBhIHZhbGlkIEpJRAogICAgICAgICAgICAgICAgICAgICRpbnB1dC5hZGRDbGFzcygnZXJyb3InKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmFkZENvbnRhY3QoamlkKTsKICAgICAgICAgICAgICAgICQoJy5zZWFyY2gteG1wcCcpLmhpZGUoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGFkZENvbnRhY3RGcm9tTGlzdDogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgdmFyICR0YXJnZXQgPSAkKGV2LnRhcmdldCksCiAgICAgICAgICAgICAgICAgICAgamlkID0gJHRhcmdldC5hdHRyKCdkYXRhLXJlY2lwaWVudCcpLAogICAgICAgICAgICAgICAgICAgIG5hbWUgPSAkdGFyZ2V0LnRleHQoKTsKICAgICAgICAgICAgICAgIHRoaXMuYWRkQ29udGFjdChqaWQsIG5hbWUpOwogICAgICAgICAgICAgICAgJHRhcmdldC5wYXJlbnQoKS5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICQoJy5zZWFyY2gteG1wcCcpLmhpZGUoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGFkZENvbnRhY3Q6IGZ1bmN0aW9uIChqaWQsIG5hbWUpIHsKICAgICAgICAgICAgICAgIG5hbWUgPSBfLmlzRW1wdHkobmFtZSk/IGppZDogbmFtZTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24ucm9zdGVyLmFkZChqaWQsIG5hbWUsIFtdLCBmdW5jdGlvbiAoaXEpIHsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLnJvc3Rlci5zdWJzY3JpYmUoamlkLCBudWxsLCBjb252ZXJzZS54bXBwc3RhdHVzLmdldCgnZnVsbG5hbWUnKSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLlJvb21zUGFuZWwgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZCh7CiAgICAgICAgICAgIHRhZ05hbWU6ICdkaXYnLAogICAgICAgICAgICBpZDogJ2NoYXRyb29tcycsCiAgICAgICAgICAgIGV2ZW50czogewogICAgICAgICAgICAgICAgJ3N1Ym1pdCBmb3JtLmFkZC1jaGF0cm9vbSc6ICdjcmVhdGVDaGF0Um9vbScsCiAgICAgICAgICAgICAgICAnY2xpY2sgaW5wdXQjc2hvdy1yb29tcyc6ICdzaG93Um9vbXMnLAogICAgICAgICAgICAgICAgJ2NsaWNrIGEub3Blbi1yb29tJzogJ2NyZWF0ZUNoYXRSb29tJywKICAgICAgICAgICAgICAgICdjbGljayBhLnJvb20taW5mbyc6ICdzaG93Um9vbUluZm8nCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoY2ZnKSB7CiAgICAgICAgICAgICAgICBjZmcuJHBhcmVudC5hcHBlbmQoCiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuaHRtbCgKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UudGVtcGxhdGVzLnJvb21fcGFuZWwoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3NlcnZlcl9pbnB1dF90eXBlJzogY29udmVyc2UuaGlkZV9tdWNfc2VydmVyICYmICdoaWRkZW4nIHx8ICd0ZXh0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdsYWJlbF9yb29tX25hbWUnOiBfXygnUm9vbSBuYW1lJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbGFiZWxfbmlja25hbWUnOiBfXygnTmlja25hbWUnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdsYWJlbF9zZXJ2ZXInOiBfXygnU2VydmVyJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbGFiZWxfam9pbic6IF9fKCdKb2luJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbGFiZWxfc2hvd19yb29tcyc6IF9fKCdTaG93IHJvb21zJykKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICApLmhpZGUoKSk7CiAgICAgICAgICAgICAgICB0aGlzLiR0YWJzID0gY2ZnLiRwYXJlbnQucGFyZW50KCkuZmluZCgnI2NvbnRyb2xib3gtdGFicycpOwoKICAgICAgICAgICAgICAgIHRoaXMub24oJ3VwZGF0ZS1yb29tcy1saXN0JywgZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVSb29tc0xpc3QoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgY29udmVyc2UueG1wcHN0YXR1cy5vbigiY2hhbmdlIiwgJC5wcm94eShmdW5jdGlvbiAobW9kZWwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIShfLmhhcyhtb2RlbC5jaGFuZ2VkLCAnZnVsbG5hbWUnKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YXIgJG5pY2sgPSB0aGlzLiRlbC5maW5kKCdpbnB1dC5uZXctY2hhdHJvb20tbmljaycpOwogICAgICAgICAgICAgICAgICAgIGlmICghICRuaWNrLmlzKCc6Zm9jdXMnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAkbmljay52YWwobW9kZWwuZ2V0KCdmdWxsbmFtZScpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCB0aGlzKSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMuJHRhYnMuYXBwZW5kKGNvbnZlcnNlLnRlbXBsYXRlcy5jaGF0cm9vbXNfdGFiKHtsYWJlbF9yb29tczogX18oJ1Jvb21zJyl9KSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGluZm9ybU5vUm9vbXNGb3VuZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyICRhdmFpbGFibGVfY2hhdHJvb21zID0gdGhpcy4kZWwuZmluZCgnI2F2YWlsYWJsZS1jaGF0cm9vbXMnKTsKICAgICAgICAgICAgICAgIC8vICMgRm9yIHRyYW5zbGF0b3JzOiAlMSRzIGlzIGEgdmFyaWFibGUgYW5kIHdpbGwgYmUgcmVwbGFjZWQgd2l0aCB0aGUgWE1QUCBzZXJ2ZXIgbmFtZQogICAgICAgICAgICAgICAgJGF2YWlsYWJsZV9jaGF0cm9vbXMuaHRtbCgnPGR0PicrX18oJ05vIHJvb21zIG9uICUxJHMnLHRoaXMubXVjX2RvbWFpbikrJzwvZHQ+Jyk7CiAgICAgICAgICAgICAgICAkKCdpbnB1dCNzaG93LXJvb21zJykuc2hvdygpLnNpYmxpbmdzKCdzcGFuLnNwaW5uZXInKS5yZW1vdmUoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHVwZGF0ZVJvb21zTGlzdDogZnVuY3Rpb24gKGRvbWFpbikgewogICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5tdWMubGlzdFJvb21zKAogICAgICAgICAgICAgICAgICAgIHRoaXMubXVjX2RvbWFpbiwKICAgICAgICAgICAgICAgICAgICAkLnByb3h5KGZ1bmN0aW9uIChpcSkgeyAvLyBTdWNjZXNzCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuYW1lLCBqaWQsIGksIGZyYWdtZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYXZhaWxhYmxlX2NoYXRyb29tcyA9IHRoaXMuJGVsLmZpbmQoJyNhdmFpbGFibGUtY2hhdHJvb21zJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucm9vbXMgPSAkKGlxKS5maW5kKCdxdWVyeScpLmZpbmQoJ2l0ZW0nKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucm9vbXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAjIEZvciB0cmFuc2xhdG9yczogJTEkcyBpcyBhIHZhcmlhYmxlIGFuZCB3aWxsIGJlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAjIHJlcGxhY2VkIHdpdGggdGhlIFhNUFAgc2VydmVyIG5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhdmFpbGFibGVfY2hhdHJvb21zLmh0bWwoJzxkdD4nK19fKCdSb29tcyBvbiAlMSRzJyx0aGlzLm11Y19kb21haW4pKyc8L2R0PicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGk9MDsgaTx0aGlzLnJvb21zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSA9IFN0cm9waGUudW5lc2NhcGVOb2RlKCQodGhpcy5yb29tc1tpXSkuYXR0cignbmFtZScpfHwkKHRoaXMucm9vbXNbaV0pLmF0dHIoJ2ppZCcpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqaWQgPSAkKHRoaXMucm9vbXNbaV0pLmF0dHIoJ2ppZCcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYWdtZW50LmFwcGVuZENoaWxkKCQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLnRlbXBsYXRlcy5yb29tX2l0ZW0oewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ25hbWUnOm5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnamlkJzpqaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb3Blbl90aXRsZSc6IF9fKCdDbGljayB0byBvcGVuIHRoaXMgcm9vbScpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2luZm9fdGl0bGUnOiBfXygnU2hvdyBtb3JlIGluZm9ybWF0aW9uIG9uIHRoaXMgcm9vbScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApWzBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhdmFpbGFibGVfY2hhdHJvb21zLmFwcGVuZChmcmFnbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCdpbnB1dCNzaG93LXJvb21zJykuc2hvdygpLnNpYmxpbmdzKCdzcGFuLnNwaW5uZXInKS5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5mb3JtTm9Sb29tc0ZvdW5kKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSwgdGhpcyksCiAgICAgICAgICAgICAgICAgICAgJC5wcm94eShmdW5jdGlvbiAoaXEpIHsgLy8gRmFpbHVyZQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmluZm9ybU5vUm9vbXNGb3VuZCgpOwogICAgICAgICAgICAgICAgICAgIH0sIHRoaXMpKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHNob3dSb29tczogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICB2YXIgJGF2YWlsYWJsZV9jaGF0cm9vbXMgPSB0aGlzLiRlbC5maW5kKCcjYXZhaWxhYmxlLWNoYXRyb29tcycpOwogICAgICAgICAgICAgICAgdmFyICRzZXJ2ZXIgPSB0aGlzLiRlbC5maW5kKCdpbnB1dC5uZXctY2hhdHJvb20tc2VydmVyJyk7CiAgICAgICAgICAgICAgICB2YXIgc2VydmVyID0gJHNlcnZlci52YWwoKTsKICAgICAgICAgICAgICAgIGlmICghc2VydmVyKSB7CiAgICAgICAgICAgICAgICAgICAgJHNlcnZlci5hZGRDbGFzcygnZXJyb3InKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5maW5kKCdpbnB1dC5uZXctY2hhdHJvb20tbmFtZScpLnJlbW92ZUNsYXNzKCdlcnJvcicpOwogICAgICAgICAgICAgICAgJHNlcnZlci5yZW1vdmVDbGFzcygnZXJyb3InKTsKICAgICAgICAgICAgICAgICRhdmFpbGFibGVfY2hhdHJvb21zLmVtcHR5KCk7CiAgICAgICAgICAgICAgICAkKCdpbnB1dCNzaG93LXJvb21zJykuaGlkZSgpLmFmdGVyKCc8c3BhbiBjbGFzcz0ic3Bpbm5lciIvPicpOwogICAgICAgICAgICAgICAgdGhpcy5tdWNfZG9tYWluID0gc2VydmVyOwogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVSb29tc0xpc3QoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHNob3dSb29tSW5mbzogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gZXYudGFyZ2V0LAogICAgICAgICAgICAgICAgICAgICRkZCA9ICQodGFyZ2V0KS5wYXJlbnQoJ2RkJyksCiAgICAgICAgICAgICAgICAgICAgJGRpdiA9ICRkZC5maW5kKCdkaXYucm9vbS1pbmZvJyk7CiAgICAgICAgICAgICAgICBpZiAoJGRpdi5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAkZGl2LnJlbW92ZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkZGQuZmluZCgnc3Bhbi5zcGlubmVyJykucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgJGRkLmFwcGVuZCgnPHNwYW4gY2xhc3M9InNwaW5uZXIgaG9yX2NlbnRlcmVkIi8+Jyk7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5kaXNjby5pbmZvKAogICAgICAgICAgICAgICAgICAgICAgICAkKHRhcmdldCkuYXR0cignZGF0YS1yb29tLWppZCcpLAogICAgICAgICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICAkLnByb3h5KGZ1bmN0aW9uIChzdGFuemEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciAkc3RhbnphID0gJChzdGFuemEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQWxsIE1VQyBmZWF0dXJlcyBmb3VuZCBoZXJlOiBodHRwOi8veG1wcC5vcmcvcmVnaXN0cmFyL2Rpc2NvLWZlYXR1cmVzLmh0bWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRkZC5maW5kKCdzcGFuLnNwaW5uZXInKS5yZXBsYWNlV2l0aCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS50ZW1wbGF0ZXMucm9vbV9kZXNjcmlwdGlvbih7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkZXNjJzogJHN0YW56YS5maW5kKCdmaWVsZFt2YXI9Im11YyNyb29taW5mb19kZXNjcmlwdGlvbiJdIHZhbHVlJykudGV4dCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb2NjJzogJHN0YW56YS5maW5kKCdmaWVsZFt2YXI9Im11YyNyb29taW5mb19vY2N1cGFudHMiXSB2YWx1ZScpLnRleHQoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2hpZGRlbic6ICRzdGFuemEuZmluZCgnZmVhdHVyZVt2YXI9Im11Y19oaWRkZW4iXScpLmxlbmd0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ21lbWJlcnNvbmx5JzogJHN0YW56YS5maW5kKCdmZWF0dXJlW3Zhcj0ibXVjX21lbWJlcnNvbmx5Il0nKS5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdtb2RlcmF0ZWQnOiAkc3RhbnphLmZpbmQoJ2ZlYXR1cmVbdmFyPSJtdWNfbW9kZXJhdGVkIl0nKS5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdub25hbm9ueW1vdXMnOiAkc3RhbnphLmZpbmQoJ2ZlYXR1cmVbdmFyPSJtdWNfbm9uYW5vbnltb3VzIl0nKS5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvcGVuJzogJHN0YW56YS5maW5kKCdmZWF0dXJlW3Zhcj0ibXVjX29wZW4iXScpLmxlbmd0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3Bhc3N3b3JkcHJvdGVjdGVkJzogJHN0YW56YS5maW5kKCdmZWF0dXJlW3Zhcj0ibXVjX3Bhc3N3b3JkcHJvdGVjdGVkIl0nKS5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdwZXJzaXN0ZW50JzogJHN0YW56YS5maW5kKCdmZWF0dXJlW3Zhcj0ibXVjX3BlcnNpc3RlbnQiXScpLmxlbmd0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3B1YmxpY3Jvb20nOiAkc3RhbnphLmZpbmQoJ2ZlYXR1cmVbdmFyPSJtdWNfcHVibGljIl0nKS5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzZW1pYW5vbnltb3VzJzogJHN0YW56YS5maW5kKCdmZWF0dXJlW3Zhcj0ibXVjX3NlbWlhbm9ueW1vdXMiXScpLmxlbmd0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3RlbXBvcmFyeSc6ICRzdGFuemEuZmluZCgnZmVhdHVyZVt2YXI9Im11Y190ZW1wb3JhcnkiXScpLmxlbmd0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3VubW9kZXJhdGVkJzogJHN0YW56YS5maW5kKCdmZWF0dXJlW3Zhcj0ibXVjX3VubW9kZXJhdGVkIl0nKS5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdsYWJlbF9kZXNjJzogX18oJ0Rlc2NyaXB0aW9uOicpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbGFiZWxfb2NjJzogX18oJ09jY3VwYW50czonKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xhYmVsX2ZlYXR1cmVzJzogX18oJ0ZlYXR1cmVzOicpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbGFiZWxfcmVxdWlyZXNfYXV0aCc6IF9fKCdSZXF1aXJlcyBhdXRoZW50aWNhdGlvbicpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbGFiZWxfaGlkZGVuJzogX18oJ0hpZGRlbicpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbGFiZWxfcmVxdWlyZXNfaW52aXRlJzogX18oJ1JlcXVpcmVzIGFuIGludml0YXRpb24nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xhYmVsX21vZGVyYXRlZCc6IF9fKCdNb2RlcmF0ZWQnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xhYmVsX25vbl9hbm9uJzogX18oJ05vbi1hbm9ueW1vdXMnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xhYmVsX29wZW5fcm9vbSc6IF9fKCdPcGVuIHJvb20nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xhYmVsX3Blcm1hbmVudF9yb29tJzogX18oJ1Blcm1hbmVudCByb29tJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdsYWJlbF9wdWJsaWMnOiBfXygnUHVibGljJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdsYWJlbF9zZW1pX2Fub24nOiAgXygnU2VtaS1hbm9ueW1vdXMnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xhYmVsX3RlbXBfcm9vbSc6ICBfKCdUZW1wb3Jhcnkgcm9vbScpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbGFiZWxfdW5tb2RlcmF0ZWQnOiBfXygnVW5tb2RlcmF0ZWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgY3JlYXRlQ2hhdFJvb206IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIHZhciBuYW1lLCAkbmFtZSwKICAgICAgICAgICAgICAgICAgICBzZXJ2ZXIsICRzZXJ2ZXIsCiAgICAgICAgICAgICAgICAgICAgamlkLAogICAgICAgICAgICAgICAgICAgICRuaWNrID0gdGhpcy4kZWwuZmluZCgnaW5wdXQubmV3LWNoYXRyb29tLW5pY2snKSwKICAgICAgICAgICAgICAgICAgICBuaWNrID0gJG5pY2sudmFsKCksCiAgICAgICAgICAgICAgICAgICAgY2hhdHJvb207CgogICAgICAgICAgICAgICAgaWYgKCFuaWNrKSB7ICRuaWNrLmFkZENsYXNzKCdlcnJvcicpOyB9CiAgICAgICAgICAgICAgICBlbHNlIHsgJG5pY2sucmVtb3ZlQ2xhc3MoJ2Vycm9yJyk7IH0KCiAgICAgICAgICAgICAgICBpZiAoZXYudHlwZSA9PT0gJ2NsaWNrJykgewogICAgICAgICAgICAgICAgICAgIGppZCA9ICQoZXYudGFyZ2V0KS5hdHRyKCdkYXRhLXJvb20tamlkJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICRuYW1lID0gdGhpcy4kZWwuZmluZCgnaW5wdXQubmV3LWNoYXRyb29tLW5hbWUnKTsKICAgICAgICAgICAgICAgICAgICAkc2VydmVyPSB0aGlzLiRlbC5maW5kKCdpbnB1dC5uZXctY2hhdHJvb20tc2VydmVyJyk7CiAgICAgICAgICAgICAgICAgICAgc2VydmVyID0gJHNlcnZlci52YWwoKTsKICAgICAgICAgICAgICAgICAgICBuYW1lID0gJG5hbWUudmFsKCkudHJpbSgpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgJG5hbWUudmFsKCcnKTsgLy8gQ2xlYXIgdGhlIGlucHV0CiAgICAgICAgICAgICAgICAgICAgaWYgKG5hbWUgJiYgc2VydmVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGppZCA9IFN0cm9waGUuZXNjYXBlTm9kZShuYW1lKSArICdAJyArIHNlcnZlcjsKICAgICAgICAgICAgICAgICAgICAgICAgJG5hbWUucmVtb3ZlQ2xhc3MoJ2Vycm9yJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICRzZXJ2ZXIucmVtb3ZlQ2xhc3MoJ2Vycm9yJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubXVjX2RvbWFpbiA9IHNlcnZlcjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5hbWUpIHsgJG5hbWUuYWRkQ2xhc3MoJ2Vycm9yJyk7IH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzZXJ2ZXIpIHsgJHNlcnZlci5hZGRDbGFzcygnZXJyb3InKTsgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFuaWNrKSB7IHJldHVybjsgfQogICAgICAgICAgICAgICAgY2hhdHJvb20gPSBjb252ZXJzZS5jaGF0Ym94dmlld3Muc2hvd0NoYXQoewogICAgICAgICAgICAgICAgICAgICdpZCc6IGppZCwKICAgICAgICAgICAgICAgICAgICAnamlkJzogamlkLAogICAgICAgICAgICAgICAgICAgICduYW1lJzogU3Ryb3BoZS51bmVzY2FwZU5vZGUoU3Ryb3BoZS5nZXROb2RlRnJvbUppZChqaWQpKSwKICAgICAgICAgICAgICAgICAgICAnbmljayc6IG5pY2ssCiAgICAgICAgICAgICAgICAgICAgJ2NoYXRyb29tJzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAnYm94X2lkJyA6IGI2NF9zaGExKGppZCkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuQ29udHJvbEJveFZpZXcgPSBjb252ZXJzZS5DaGF0Qm94Vmlldy5leHRlbmQoewogICAgICAgICAgICB0YWdOYW1lOiAnZGl2JywKICAgICAgICAgICAgY2xhc3NOYW1lOiAnY2hhdGJveCcsCiAgICAgICAgICAgIGlkOiAnY29udHJvbGJveCcsCiAgICAgICAgICAgIGV2ZW50czogewogICAgICAgICAgICAgICAgJ2NsaWNrIGEuY2xvc2UtY2hhdGJveC1idXR0b24nOiAnY2xvc2UnLAogICAgICAgICAgICAgICAgJ2NsaWNrIHVsI2NvbnRyb2xib3gtdGFicyBsaSBhJzogJ3N3aXRjaFRhYicsCiAgICAgICAgICAgICAgICAnbW91c2Vkb3duIC5kcmFncmVzaXplLXRtJzogJ29uRHJhZ1Jlc2l6ZVN0YXJ0JwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy4kZWwuaW5zZXJ0QWZ0ZXIoY29udmVyc2UuY29udHJvbGJveHRvZ2dsZS4kZWwpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbignY2hhbmdlOmNvbm5lY3RlZCcsIHRoaXMub25Db25uZWN0ZWQsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbignZGVzdHJveScsIHRoaXMuaGlkZSwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCdoaWRlJywgdGhpcy5oaWRlLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oJ3Nob3cnLCB0aGlzLnNob3csIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbignY2hhbmdlOmNsb3NlZCcsIHRoaXMuZW5zdXJlQ2xvc2VkU3RhdGUsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIoKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1vZGVsLmdldCgnY29ubmVjdGVkJykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmluaXRSb3N0ZXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghdGhpcy5tb2RlbC5nZXQoJ2Nsb3NlZCcpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93KCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25Db25uZWN0ZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1vZGVsLmdldCgnY29ubmVjdGVkJykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcigpLmluaXRSb3N0ZXIoKTsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5mZWF0dXJlcy5vZmYoJ2FkZCcsIHRoaXMuZmVhdHVyZUFkZGVkLCB0aGlzKTsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5mZWF0dXJlcy5vbignYWRkJywgdGhpcy5mZWF0dXJlQWRkZWQsIHRoaXMpOwogICAgICAgICAgICAgICAgICAgIC8vIEZlYXR1cmVzIGNvdWxkIGhhdmUgYmVlbiBhZGRlZCBiZWZvcmUgdGhlIGNvbnRyb2xib3ggd2FzCiAgICAgICAgICAgICAgICAgICAgLy8gaW5pdGlhbGl6ZWQuIEN1cnJlbnRseSB3ZSdyZSBvbmx5IGludGVyZXN0ZWQgaW4gTVVDCiAgICAgICAgICAgICAgICAgICAgdmFyIGZlYXR1cmUgPSBjb252ZXJzZS5mZWF0dXJlcy5maW5kV2hlcmUoeyd2YXInOiAnaHR0cDovL2phYmJlci5vcmcvcHJvdG9jb2wvbXVjJ30pOwogICAgICAgICAgICAgICAgICAgIGlmIChmZWF0dXJlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmVhdHVyZUFkZGVkKGZlYXR1cmUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGluaXRSb3N0ZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIC8qIFdlIGluaXRpYWxpemUgdGhlIHJvc3Rlciwgd2hpY2ggd2lsbCBhcHBlYXIgaW5zaWRlIHRoZQogICAgICAgICAgICAgICAgICogQ29udGFjdHMgUGFuZWwuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJvc3RlciA9IG5ldyBjb252ZXJzZS5Sb3N0ZXJDb250YWN0cygpOwogICAgICAgICAgICAgICAgY29udmVyc2Uucm9zdGVyLmJyb3dzZXJTdG9yYWdlID0gbmV3IEJhY2tib25lLkJyb3dzZXJTdG9yYWdlW2NvbnZlcnNlLnN0b3JhZ2VdKAogICAgICAgICAgICAgICAgICAgIGI2NF9zaGExKCdjb252ZXJzZS5jb250YWN0cy0nK2NvbnZlcnNlLmJhcmVfamlkKSk7CiAgICAgICAgICAgICAgICB2YXIgcm9zdGVyZ3JvdXBzID0gbmV3IGNvbnZlcnNlLlJvc3Rlckdyb3VwcygpOwogICAgICAgICAgICAgICAgcm9zdGVyZ3JvdXBzLmJyb3dzZXJTdG9yYWdlID0gbmV3IEJhY2tib25lLkJyb3dzZXJTdG9yYWdlW2NvbnZlcnNlLnN0b3JhZ2VdKAogICAgICAgICAgICAgICAgICAgIGI2NF9zaGExKCdjb252ZXJzZS5yb3N0ZXIuZ3JvdXBzJytjb252ZXJzZS5iYXJlX2ppZCkpOwogICAgICAgICAgICAgICAgY29udmVyc2Uucm9zdGVydmlldyA9IG5ldyBjb252ZXJzZS5Sb3N0ZXJWaWV3KHttb2RlbDogcm9zdGVyZ3JvdXBzfSk7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhY3RzcGFuZWwuJGVsLmFwcGVuZChjb252ZXJzZS5yb3N0ZXJ2aWV3LiRlbCk7CiAgICAgICAgICAgICAgICAvLyBUT0RPOgogICAgICAgICAgICAgICAgLy8gU2VlIGlmIHdlIHNob3VsZG4ndCBhbHNvIGZldGNoIHRoZSByb3N0ZXIgaGVyZS4uLiBvdGhlcndpc2UKICAgICAgICAgICAgICAgIC8vIHRoZSByb3N0ZXIgaXMgYWx3YXlzIHBvcHVsYXRlZCBieSB0aGUgcm9zdGVySGFuZGxlciBtZXRob2QsCiAgICAgICAgICAgICAgICAvLyB3aGljaCBhcHBlYXJzIHRvIGJlIGEgbGVzcyBlY29ub21pYyB3YXkuCiAgICAgICAgICAgICAgICAvLyBpLmUuIGZyb20gd2hhdCBpdCBzZWVtcywgb25seSBncm91cHMgYXJlIGZldGNoZWQgZnJvbQogICAgICAgICAgICAgICAgLy8gYnJvd3NlclN0b3JhZ2UsIGFuZCBubyBjb250YWN0cy4KICAgICAgICAgICAgICAgIC8vIFhYWDogTWFrZSBzdXJlIHRoYXQgaWYgZmV0Y2ggaXMgY2FsbGVkLCB3ZSBkb24ndCBzb3J0IG9uCiAgICAgICAgICAgICAgICAvLyBlYWNoIGl0ZW0gYWRkLi4uCiAgICAgICAgICAgICAgICAvLyBjb252ZXJzZS5yb3N0ZXIuZmV0Y2goKQogICAgICAgICAgICAgICAgY29udmVyc2Uucm9zdGVydmlldy5yZW5kZXIoKS5mZXRjaCgpLnVwZGF0ZSgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmICghY29udmVyc2UuY29ubmVjdGlvbi5jb25uZWN0ZWQgfHwgIWNvbnZlcnNlLmNvbm5lY3Rpb24uYXV0aGVudGljYXRlZCB8fCBjb252ZXJzZS5jb25uZWN0aW9uLmRpc2Nvbm5lY3RpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiB3ZSBtaWdodCBuZWVkIHRvIHRha2UgcHJlYmluZGluZyBpbnRvIGNvbnNpZGVyYXRpb24gaGVyZS4KICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlckxvZ2luUGFuZWwoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXRoaXMuY29udGFjdHNwYW5lbCB8fCAhdGhpcy5jb250YWN0c3BhbmVsLiRlbC5pcygnOnZpc2libGUnKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyQ29udGFjdHNQYW5lbCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZW5kZXJMb2dpblBhbmVsOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5odG1sKGNvbnZlcnNlLnRlbXBsYXRlcy5jb250cm9sYm94KHRoaXMubW9kZWwudG9KU09OKCkpKTsKICAgICAgICAgICAgICAgIHZhciBjZmcgPSB7JyRwYXJlbnQnOiB0aGlzLiRlbC5maW5kKCcuY29udHJvbGJveC1wYW5lcycpLCAnbW9kZWwnOiB0aGlzfTsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5sb2dpbnBhbmVsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2dpbnBhbmVsID0gbmV3IGNvbnZlcnNlLkxvZ2luUGFuZWwoY2ZnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2dpbnBhbmVsLmRlbGVnYXRlRXZlbnRzKCkuaW5pdGlhbGl6ZShjZmcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5sb2dpbnBhbmVsLnJlbmRlcigpOwogICAgICAgICAgICAgICAgdGhpcy5pbml0RHJhZ1Jlc2l6ZSgpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVuZGVyQ29udGFjdHNQYW5lbDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy4kZWwuaHRtbChjb252ZXJzZS50ZW1wbGF0ZXMuY29udHJvbGJveCh0aGlzLm1vZGVsLnRvSlNPTigpKSk7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhY3RzcGFuZWwgPSBuZXcgY29udmVyc2UuQ29udGFjdHNQYW5lbCh7JyRwYXJlbnQnOiB0aGlzLiRlbC5maW5kKCcuY29udHJvbGJveC1wYW5lcycpfSk7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhY3RzcGFuZWwucmVuZGVyKCk7CiAgICAgICAgICAgICAgICBjb252ZXJzZS54bXBwc3RhdHVzdmlldyA9IG5ldyBjb252ZXJzZS5YTVBQU3RhdHVzVmlldyh7J21vZGVsJzogY29udmVyc2UueG1wcHN0YXR1c30pOwogICAgICAgICAgICAgICAgY29udmVyc2UueG1wcHN0YXR1c3ZpZXcucmVuZGVyKCk7CiAgICAgICAgICAgICAgICBpZiAoY29udmVyc2UuYWxsb3dfbXVjKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yb29tc3BhbmVsID0gbmV3IGNvbnZlcnNlLlJvb21zUGFuZWwoeyckcGFyZW50JzogdGhpcy4kZWwuZmluZCgnLmNvbnRyb2xib3gtcGFuZXMnKX0pOwogICAgICAgICAgICAgICAgICAgIHRoaXMucm9vbXNwYW5lbC5yZW5kZXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuaW5pdERyYWdSZXNpemUoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGNsb3NlOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGlmIChldiAmJiBldi5wcmV2ZW50RGVmYXVsdCkgeyBldi5wcmV2ZW50RGVmYXVsdCgpOyB9CiAgICAgICAgICAgICAgICBpZiAoY29udmVyc2UuY29ubmVjdGlvbi5jb25uZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLnNhdmUoeydjbG9zZWQnOiB0cnVlfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwudHJpZ2dlcignaGlkZScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29udmVyc2UuZW1pdCgnY29udHJvbEJveENsb3NlZCcsIHRoaXMpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBlbnN1cmVDbG9zZWRTdGF0ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMubW9kZWwuZ2V0KCdjbG9zZWQnKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3coKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGhpZGU6IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICAgICAgdGhpcy4kZWwuaGlkZSgnZmFzdCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5yZWZyZXNoV2Via2l0KCk7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuZW1pdCgnY2hhdEJveENsb3NlZCcsIHRoaXMpOwogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbnRyb2xib3h0b2dnbGUuc2hvdyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzaG93OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5jb250cm9sYm94dG9nZ2xlLmhpZGUoJC5wcm94eShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuc2hvdygnZmFzdCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnZlcnNlLnJvc3RlcnZpZXcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJvc3RlcnZpZXcudXBkYXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UucmVmcmVzaFdlYmtpdCgpOwogICAgICAgICAgICAgICAgICAgIH0uYmluZCh0aGlzKSk7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuZW1pdCgnY29udHJvbEJveE9wZW5lZCcsIHRoaXMpOwogICAgICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBmZWF0dXJlQWRkZWQ6IGZ1bmN0aW9uIChmZWF0dXJlKSB7CiAgICAgICAgICAgICAgICBpZiAoKGZlYXR1cmUuZ2V0KCd2YXInKSA9PSAnaHR0cDovL2phYmJlci5vcmcvcHJvdG9jb2wvbXVjJykgJiYgKGNvbnZlcnNlLmFsbG93X211YykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJvb21zcGFuZWwubXVjX2RvbWFpbiA9IGZlYXR1cmUuZ2V0KCdmcm9tJyk7CiAgICAgICAgICAgICAgICAgICAgdmFyICRzZXJ2ZXI9IHRoaXMuJGVsLmZpbmQoJ2lucHV0Lm5ldy1jaGF0cm9vbS1zZXJ2ZXInKTsKICAgICAgICAgICAgICAgICAgICBpZiAoISAkc2VydmVyLmlzKCc6Zm9jdXMnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAkc2VydmVyLnZhbCh0aGlzLnJvb21zcGFuZWwubXVjX2RvbWFpbik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChjb252ZXJzZS5hdXRvX2xpc3Rfcm9vbXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yb29tc3BhbmVsLnRyaWdnZXIoJ3VwZGF0ZS1yb29tcy1saXN0Jyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc3dpdGNoVGFiOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICB2YXIgJHRhYiA9ICQoZXYudGFyZ2V0KSwKICAgICAgICAgICAgICAgICAgICAkc2libGluZyA9ICR0YWIucGFyZW50KCkuc2libGluZ3MoJ2xpJykuY2hpbGRyZW4oJ2EnKSwKICAgICAgICAgICAgICAgICAgICAkdGFiX3BhbmVsID0gJCgkdGFiLmF0dHIoJ2hyZWYnKSk7CiAgICAgICAgICAgICAgICAkKCRzaWJsaW5nLmF0dHIoJ2hyZWYnKSkuaGlkZSgpOwogICAgICAgICAgICAgICAgJHNpYmxpbmcucmVtb3ZlQ2xhc3MoJ2N1cnJlbnQnKTsKICAgICAgICAgICAgICAgICR0YWIuYWRkQ2xhc3MoJ2N1cnJlbnQnKTsKICAgICAgICAgICAgICAgICR0YWJfcGFuZWwuc2hvdygpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2hvd0hlbHBNZXNzYWdlczogZnVuY3Rpb24gKG1zZ3MpIHsKICAgICAgICAgICAgICAgIC8vIE92ZXJyaWRlIHNob3dIZWxwTWVzc2FnZXMgaW4gQ2hhdEJveFZpZXcsIGZvciBub3cgZG8gbm90aGluZy4KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLkNoYXRSb29tT2NjdXBhbnQgPSBCYWNrYm9uZS5Nb2RlbDsKICAgICAgICB0aGlzLkNoYXRSb29tT2NjdXBhbnRWaWV3ID0gQmFja2JvbmUuVmlldy5leHRlbmQoewogICAgICAgICAgICB0YWdOYW1lOiAnbGknLAogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCdjaGFuZ2UnLCB0aGlzLnJlbmRlciwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCdkZXN0cm95JywgdGhpcy5kZXN0cm95LCB0aGlzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgJG5ldyA9IGNvbnZlcnNlLnRlbXBsYXRlcy5vY2N1cGFudCgKICAgICAgICAgICAgICAgICAgICBfLmV4dGVuZCgKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC50b0pTT04oKSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2Rlc2NfbW9kZXJhdG9yJzogX18oJ1RoaXMgdXNlciBpcyBhIG1vZGVyYXRvcicpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2Rlc2NfcGFydGljaXBhbnQnOiBfXygnVGhpcyB1c2VyIGNhbiBzZW5kIG1lc3NhZ2VzIGluIHRoaXMgcm9vbScpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2Rlc2NfdmlzaXRvcic6IF9fKCdUaGlzIHVzZXIgY2FuIE5PVCBzZW5kIG1lc3NhZ2VzIGluIHRoaXMgcm9vbScpCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5yZXBsYWNlV2l0aCgkbmV3KTsKICAgICAgICAgICAgICAgIHRoaXMuc2V0RWxlbWVudCgkbmV3LCB0cnVlKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy4kZWwucmVtb3ZlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5DaGF0Um9vbU9jY3VwYW50cyA9IEJhY2tib25lLkNvbGxlY3Rpb24uZXh0ZW5kKHsKICAgICAgICAgICAgbW9kZWw6IGNvbnZlcnNlLkNoYXRSb29tT2NjdXBhbnQsCiAgICAgICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJyb3dzZXJTdG9yYWdlID0gbmV3IEJhY2tib25lLkJyb3dzZXJTdG9yYWdlW2NvbnZlcnNlLnN0b3JhZ2VdKAogICAgICAgICAgICAgICAgICAgIGI2NF9zaGExKCdjb252ZXJzZS5vY2N1cGFudHMnK2NvbnZlcnNlLmJhcmVfamlkK29wdGlvbnMubmljaykpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuQ2hhdFJvb21PY2N1cGFudHNWaWV3ID0gQmFja2JvbmUuT3ZlcnZpZXcuZXh0ZW5kKHsKICAgICAgICAgICAgdGFnTmFtZTogJ2RpdicsCiAgICAgICAgICAgIGNsYXNzTmFtZTogJ3BhcnRpY2lwYW50cycsCgogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCJhZGQiLCB0aGlzLm9uT2NjdXBhbnRBZGRlZCwgdGhpcyk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmh0bWwoCiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UudGVtcGxhdGVzLmNoYXRyb29tX3NpZGViYXIoewogICAgICAgICAgICAgICAgICAgICAgICAnbGFiZWxfaW52aXRhdGlvbic6IF9fKCdJbnZpdGUuLi4nKSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2xhYmVsX29jY3VwYW50cyc6IF9fKCdPY2N1cGFudHMnKQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5pdEludml0ZVdpZGdldCgpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25PY2N1cGFudEFkZGVkOiBmdW5jdGlvbiAoaXRlbSkgewogICAgICAgICAgICAgICAgdmFyIHZpZXcgPSB0aGlzLmdldChpdGVtLmdldCgnaWQnKSk7CiAgICAgICAgICAgICAgICBpZiAoIXZpZXcpIHsKICAgICAgICAgICAgICAgICAgICB2aWV3ID0gdGhpcy5hZGQoaXRlbS5nZXQoJ2lkJyksIG5ldyBjb252ZXJzZS5DaGF0Um9vbU9jY3VwYW50Vmlldyh7bW9kZWw6IGl0ZW19KSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB2aWV3Lm1vZGVsOyAvLyBSZW1vdmUgcmVmIHRvIG9sZCBtb2RlbCB0byBoZWxwIGdhcmJhZ2UgY29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgIHZpZXcubW9kZWwgPSBpdGVtOwogICAgICAgICAgICAgICAgICAgIHZpZXcuaW5pdGlhbGl6ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy4kKCcucGFydGljaXBhbnQtbGlzdCcpLmFwcGVuZCh2aWV3LnJlbmRlcigpLiRlbCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBvbkNoYXRSb29tUm9zdGVyOiBmdW5jdGlvbiAocm9zdGVyLCByb29tKSB7CiAgICAgICAgICAgICAgICB2YXIgcm9zdGVyX3NpemUgPSBfLnNpemUocm9zdGVyKSwKICAgICAgICAgICAgICAgICAgICAkcGFydGljaXBhbnRfbGlzdCA9IHRoaXMuJCgnLnBhcnRpY2lwYW50LWxpc3QnKSwKICAgICAgICAgICAgICAgICAgICBwYXJ0aWNpcGFudHMgPSBbXSwKICAgICAgICAgICAgICAgICAgICBrZXlzID0gXy5rZXlzKHJvc3RlciksCiAgICAgICAgICAgICAgICAgICAgb2NjdXBhbnQsIGF0dHJzLCBpLCBuaWNrOwoKICAgICAgICAgICAgICAgIGZvciAoaT0wOyBpPHJvc3Rlcl9zaXplOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBuaWNrID0gU3Ryb3BoZS51bmVzY2FwZU5vZGUoa2V5c1tpXSk7CiAgICAgICAgICAgICAgICAgICAgYXR0cnMgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICdpZCc6IG5pY2ssCiAgICAgICAgICAgICAgICAgICAgICAgICdyb2xlJzogcm9zdGVyW2tleXNbaV1dLnJvbGUsCiAgICAgICAgICAgICAgICAgICAgICAgICduaWNrJzogbmljawogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgb2NjdXBhbnQgPSB0aGlzLm1vZGVsLmdldChuaWNrKTsKICAgICAgICAgICAgICAgICAgICBpZiAob2NjdXBhbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb2NjdXBhbnQuc2F2ZShhdHRycyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5jcmVhdGUoYXR0cnMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIF8uZWFjaChfLmRpZmZlcmVuY2UodGhpcy5tb2RlbC5wbHVjaygnaWQnKSwga2V5cyksIGZ1bmN0aW9uIChpZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuZ2V0KGlkKS5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaW5pdEludml0ZVdpZGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyICRlbCA9IHRoaXMuJCgnaW5wdXQuaW52aXRlZC1jb250YWN0Jyk7CiAgICAgICAgICAgICAgICAkZWwudHlwZWFoZWFkKHsKICAgICAgICAgICAgICAgICAgICBtaW5MZW5ndGg6IDEsCiAgICAgICAgICAgICAgICAgICAgaGlnaGxpZ2h0OiB0cnVlCiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAgbmFtZTogJ2NvbnRhY3RzLWRhdGFzZXQnLAogICAgICAgICAgICAgICAgICAgIHNvdXJjZTogZnVuY3Rpb24gKHEsIGNiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHRzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIF8uZWFjaChjb252ZXJzZS5yb3N0ZXIuZmlsdGVyKGNvbnRhaW5zKFsnZnVsbG5hbWUnLCAnamlkJ10sIHEpKSwgZnVuY3Rpb24gKG4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaCh7dmFsdWU6IG4uZ2V0KCdmdWxsbmFtZScpLCBqaWQ6IG4uZ2V0KCdqaWQnKX0pOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgY2IocmVzdWx0cyk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZXM6IHsKICAgICAgICAgICAgICAgICAgICAgICAgc3VnZ2VzdGlvbjogXy50ZW1wbGF0ZSgnPHAgZGF0YS1qaWQ9Int7amlkfX0iPnt7dmFsdWV9fTwvcD4nKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgJGVsLm9uKCd0eXBlYWhlYWQ6c2VsZWN0ZWQnLCAkLnByb3h5KGZ1bmN0aW9uIChldiwgc3VnZ2VzdGlvbiwgZG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVhc29uID0gcHJvbXB0KAogICAgICAgICAgICAgICAgICAgICAgICBfXyhfX18oJ1lvdSBhcmUgYWJvdXQgdG8gaW52aXRlICUxJHMgdG8gdGhlIGNoYXQgcm9vbSAiJTIkcyIuICcpLCBzdWdnZXN0aW9uLnZhbHVlLCB0aGlzLm1vZGVsLmdldCgnaWQnKSkgKwogICAgICAgICAgICAgICAgICAgICAgICBfXygiWW91IG1heSBvcHRpb25hbGx5IGluY2x1ZGUgYSBtZXNzYWdlLCBleHBsYWluaW5nIHRoZSByZWFzb24gZm9yIHRoZSBpbnZpdGF0aW9uLiIpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmVhc29uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24ubXVjLnJvb21zW3RoaXMuY2hhdHJvb212aWV3Lm1vZGVsLmdldCgnaWQnKV0uZGlyZWN0SW52aXRlKHN1Z2dlc3Rpb24uamlkLCByZWFzb24pOwogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5lbWl0KCdyb29tSW52aXRlU2VudCcsIHRoaXMsIHN1Z2dlc3Rpb24uamlkLCByZWFzb24pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAkKGV2LnRhcmdldCkudHlwZWFoZWFkKCd2YWwnLCAnJyk7CiAgICAgICAgICAgICAgICB9LCB0aGlzKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQoKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5DaGF0Um9vbVZpZXcgPSBjb252ZXJzZS5DaGF0Qm94Vmlldy5leHRlbmQoewogICAgICAgICAgICBsZW5ndGg6IDMwMCwKICAgICAgICAgICAgdGFnTmFtZTogJ2RpdicsCiAgICAgICAgICAgIGNsYXNzTmFtZTogJ2NoYXRyb29tJywKICAgICAgICAgICAgZXZlbnRzOiB7CiAgICAgICAgICAgICAgICAnY2xpY2sgLmNsb3NlLWNoYXRib3gtYnV0dG9uJzogJ2Nsb3NlJywKICAgICAgICAgICAgICAgICdjbGljayAudG9nZ2xlLWNoYXRib3gtYnV0dG9uJzogJ21pbmltaXplJywKICAgICAgICAgICAgICAgICdjbGljayAuY29uZmlndXJlLWNoYXRyb29tLWJ1dHRvbic6ICdjb25maWd1cmVDaGF0Um9vbScsCiAgICAgICAgICAgICAgICAnY2xpY2sgLnRvZ2dsZS1zbWlsZXknOiAndG9nZ2xlRW1vdGljb25NZW51JywKICAgICAgICAgICAgICAgICdjbGljayAudG9nZ2xlLXNtaWxleSB1bCBsaSc6ICdpbnNlcnRFbW90aWNvbicsCiAgICAgICAgICAgICAgICAnY2xpY2sgLnRvZ2dsZS1jbGVhcic6ICdjbGVhckNoYXRSb29tTWVzc2FnZXMnLAogICAgICAgICAgICAgICAgJ2NsaWNrIC50b2dnbGUtcGFydGljaXBhbnRzIGEnOiAndG9nZ2xlT2NjdXBhbnRzJywKICAgICAgICAgICAgICAgICdrZXlwcmVzcyB0ZXh0YXJlYS5jaGF0LXRleHRhcmVhJzogJ2tleVByZXNzZWQnLAogICAgICAgICAgICAgICAgJ21vdXNlZG93biAuZHJhZ3Jlc2l6ZS10bSc6ICdvbkRyYWdSZXNpemVTdGFydCcKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNfY2hhdHJvb206IHRydWUsCgogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm1lc3NhZ2VzLm9uKCdhZGQnLCB0aGlzLm9uTWVzc2FnZUFkZGVkLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oJ2NoYW5nZTptaW5pbWl6ZWQnLCBmdW5jdGlvbiAoaXRlbSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmdldCgnbWluaW1pemVkJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tYXhpbWl6ZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbignZGVzdHJveScsIGZ1bmN0aW9uIChtb2RlbCwgcmVzcG9uc2UsIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLm11Yy5sZWF2ZSgKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5nZXQoJ2ppZCcpLAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLmdldCgnbmljaycpLAogICAgICAgICAgICAgICAgICAgICAgICAkLnByb3h5KHRoaXMub25MZWF2ZSwgdGhpcyksCiAgICAgICAgICAgICAgICAgICAgICAgIHVuZGVmaW5lZCk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdGhpcyk7CgogICAgICAgICAgICAgICAgdGhpcy5vY2N1cGFudHN2aWV3ID0gbmV3IGNvbnZlcnNlLkNoYXRSb29tT2NjdXBhbnRzVmlldyh7CiAgICAgICAgICAgICAgICAgICAgbW9kZWw6IG5ldyBjb252ZXJzZS5DaGF0Um9vbU9jY3VwYW50cyh7bmljazogdGhpcy5tb2RlbC5nZXQoJ25pY2snKX0pCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMub2NjdXBhbnRzdmlldy5jaGF0cm9vbXZpZXcgPSB0aGlzOwogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIoKTsKICAgICAgICAgICAgICAgIHRoaXMub2NjdXBhbnRzdmlldy5tb2RlbC5mZXRjaCh7YWRkOnRydWV9KTsKICAgICAgICAgICAgICAgIHRoaXMuY29ubmVjdChudWxsKTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLmVtaXQoJ2NoYXRSb29tT3BlbmVkJywgdGhpcyk7CgogICAgICAgICAgICAgICAgdGhpcy4kZWwuaW5zZXJ0QWZ0ZXIoY29udmVyc2UuY2hhdGJveHZpZXdzLmdldCgiY29udHJvbGJveCIpLiRlbCk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm1lc3NhZ2VzLmZldGNoKHthZGQ6IHRydWV9KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1vZGVsLmdldCgnbWluaW1pemVkJykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZGUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmF0dHIoJ2lkJywgdGhpcy5tb2RlbC5nZXQoJ2JveF9pZCcpKQogICAgICAgICAgICAgICAgICAgICAgICAuaHRtbChjb252ZXJzZS50ZW1wbGF0ZXMuY2hhdHJvb20odGhpcy5tb2RlbC50b0pTT04oKSkpOwogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJDaGF0QXJlYSgpOwogICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UucmVmcmVzaFdlYmtpdCgpOwogICAgICAgICAgICAgICAgfSwgNTApOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZW5kZXJDaGF0QXJlYTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLiQoJy5jaGF0LWFyZWEnKS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiQoJy5jaGF0LWJvZHknKS5lbXB0eSgpCiAgICAgICAgICAgICAgICAgICAgICAgIC5hcHBlbmQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS50ZW1wbGF0ZXMuY2hhdGFyZWEoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzaG93X3Rvb2xiYXInOiBjb252ZXJzZS5zaG93X3Rvb2xiYXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xhYmVsX21lc3NhZ2UnOiBfXygnTWVzc2FnZScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSkKICAgICAgICAgICAgICAgICAgICAgICAgLmFwcGVuZCh0aGlzLm9jY3VwYW50c3ZpZXcucmVuZGVyKCkuJGVsKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclRvb2xiYXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIFhYWDogVGhpcyBpcyBhIGJpdCBvZiBhIGhhY2ssIHRvIG1ha2Ugc3VyZSB0aGF0IHRoZQogICAgICAgICAgICAgICAgLy8gc2lkZWJhcidzIHN0YXRlIGlzIHJlbWVtYmVyZWQuCiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLnNldCh7aGlkZGVuX29jY3VwYW50czogIXRoaXMubW9kZWwuZ2V0KCdoaWRkZW5fb2NjdXBhbnRzJyl9KTsKICAgICAgICAgICAgICAgIHRoaXMudG9nZ2xlT2NjdXBhbnRzKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHRvZ2dsZU9jY3VwYW50czogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBpZiAoZXYpIHsKICAgICAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgIGV2LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyICRlbCA9IHRoaXMuJCgnLmljb24taGlkZS11c2VycycpOwogICAgICAgICAgICAgICAgaWYgKCF0aGlzLm1vZGVsLmdldCgnaGlkZGVuX29jY3VwYW50cycpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5zYXZlKHtoaWRkZW5fb2NjdXBhbnRzOiB0cnVlfSk7CiAgICAgICAgICAgICAgICAgICAgJGVsLnJlbW92ZUNsYXNzKCdpY29uLWhpZGUtdXNlcnMnKS5hZGRDbGFzcygnaWNvbi1zaG93LXVzZXJzJyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kKCdmb3JtLnNlbmRYTVBQTWVzc2FnZSwgLmNoYXQtYXJlYScpLmFuaW1hdGUoe3dpZHRoOiAnMTAwJSd9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiQoJ2Rpdi5wYXJ0aWNpcGFudHMnKS5hbmltYXRlKHt3aWR0aDogMH0sICQucHJveHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbERvd24oKTsKICAgICAgICAgICAgICAgICAgICB9LCB0aGlzKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuc2F2ZSh7aGlkZGVuX29jY3VwYW50czogZmFsc2V9KTsKICAgICAgICAgICAgICAgICAgICAkZWwucmVtb3ZlQ2xhc3MoJ2ljb24tc2hvdy11c2VycycpLmFkZENsYXNzKCdpY29uLWhpZGUtdXNlcnMnKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiQoJy5jaGF0LWFyZWEsIGZvcm0uc2VuZFhNUFBNZXNzYWdlJykuY3NzKHt3aWR0aDogJyd9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiQoJ2Rpdi5wYXJ0aWNpcGFudHMnKS5zaG93KCkuYW5pbWF0ZSh7d2lkdGg6ICdhdXRvJ30sICQucHJveHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbERvd24oKTsKICAgICAgICAgICAgICAgICAgICB9LCB0aGlzKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBvbkNvbW1hbmRFcnJvcjogZnVuY3Rpb24gKHN0YW56YSkgewogICAgICAgICAgICAgICAgdGhpcy5zaG93U3RhdHVzTm90aWZpY2F0aW9uKF9fKCJFcnJvcjogY291bGQgbm90IGV4ZWN1dGUgdGhlIGNvbW1hbmQiKSwgdHJ1ZSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBjcmVhdGVDaGF0Um9vbU1lc3NhZ2U6IGZ1bmN0aW9uICh0ZXh0KSB7CiAgICAgICAgICAgICAgICB2YXIgZnVsbG5hbWUgPSBjb252ZXJzZS54bXBwc3RhdHVzLmdldCgnZnVsbG5hbWUnKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwubWVzc2FnZXMuY3JlYXRlKHsKICAgICAgICAgICAgICAgICAgICBmdWxsbmFtZTogXy5pc0VtcHR5KGZ1bGxuYW1lKT8gY29udmVyc2UuYmFyZV9qaWQ6IGZ1bGxuYW1lLAogICAgICAgICAgICAgICAgICAgIHNlbmRlcjogJ21lJywKICAgICAgICAgICAgICAgICAgICB0aW1lOiBtb21lbnQoKS5mb3JtYXQoKSwKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiB0ZXh0LAogICAgICAgICAgICAgICAgICAgIG1zZ2lkOiBjb252ZXJzZS5jb25uZWN0aW9uLm11Yy5ncm91cGNoYXQodGhpcy5tb2RlbC5nZXQoJ2ppZCcpLCB0ZXh0LCB1bmRlZmluZWQsIFN0cmluZygobmV3IERhdGUoKSkuZ2V0VGltZSgpKSkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2VuZENoYXRSb29tTWVzc2FnZTogZnVuY3Rpb24gKHRleHQpIHsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IHRleHQucmVwbGFjZSgvXlxzKi8sICIiKS5tYXRjaCgvXlwvKC4qPykoPzogKC4qKSk/JC8pIHx8IFtmYWxzZV0sIGFyZ3M7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKG1hdGNoWzFdKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnYmFuJzoKICAgICAgICAgICAgICAgICAgICAgICAgYXJncyA9IG1hdGNoWzJdLnNwbGl0T25jZSgnICcpOwogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLm11Yy5iYW4odGhpcy5tb2RlbC5nZXQoJ2ppZCcpLCBhcmdzWzBdLCBhcmdzWzFdLCB1bmRlZmluZWQsICQucHJveHkodGhpcy5vbkNvbW1hbmRFcnJvciwgdGhpcykpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICdjbGVhcic6CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJDaGF0Um9vbU1lc3NhZ2VzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ2Rlb3AnOgogICAgICAgICAgICAgICAgICAgICAgICBhcmdzID0gbWF0Y2hbMl0uc3BsaXRPbmNlKCcgJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24ubXVjLmRlb3AodGhpcy5tb2RlbC5nZXQoJ2ppZCcpLCBhcmdzWzBdLCBhcmdzWzFdLCB1bmRlZmluZWQsICQucHJveHkodGhpcy5vbkNvbW1hbmRFcnJvciwgdGhpcykpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICdoZWxwJzoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93SGVscE1lc3NhZ2VzKFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8c3Ryb25nPi9iYW48L3N0cm9uZz46ICcgICArX18oJ0JhbiB1c2VyIGZyb20gcm9vbScpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxzdHJvbmc+L2NsZWFyPC9zdHJvbmc+OiAnICtfXygnUmVtb3ZlIG1lc3NhZ2VzJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPHN0cm9uZz4vaGVscDwvc3Ryb25nPjogJyAgK19fKCdTaG93IHRoaXMgbWVudScpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxzdHJvbmc+L2tpY2s8L3N0cm9uZz46ICcgICtfXygnS2ljayB1c2VyIGZyb20gcm9vbScpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxzdHJvbmc+L21lPC9zdHJvbmc+OiAnICAgICtfXygnV3JpdGUgaW4gM3JkIHBlcnNvbicpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxzdHJvbmc+L211dGU8L3N0cm9uZz46ICcgICtfXygiUmVtb3ZlIHVzZXIncyBhYmlsaXR5IHRvIHBvc3QgbWVzc2FnZXMiKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8c3Ryb25nPi9uaWNrPC9zdHJvbmc+OiAnICArX18oJ0NoYW5nZSB5b3VyIG5pY2tuYW1lJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPHN0cm9uZz4vdG9waWM8L3N0cm9uZz46ICcgK19fKCdTZXQgcm9vbSB0b3BpYycpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxzdHJvbmc+L3ZvaWNlPC9zdHJvbmc+OiAnICtfXygnQWxsb3cgbXV0ZWQgdXNlciB0byBwb3N0IG1lc3NhZ2VzJykKICAgICAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ2tpY2snOgogICAgICAgICAgICAgICAgICAgICAgICBhcmdzID0gbWF0Y2hbMl0uc3BsaXRPbmNlKCcgJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24ubXVjLmtpY2sodGhpcy5tb2RlbC5nZXQoJ2ppZCcpLCBhcmdzWzBdLCBhcmdzWzFdLCB1bmRlZmluZWQsICQucHJveHkodGhpcy5vbkNvbW1hbmRFcnJvciwgdGhpcykpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICdtdXRlJzoKICAgICAgICAgICAgICAgICAgICAgICAgYXJncyA9IG1hdGNoWzJdLnNwbGl0T25jZSgnICcpOwogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLm11Yy5tdXRlKHRoaXMubW9kZWwuZ2V0KCdqaWQnKSwgYXJnc1swXSwgYXJnc1sxXSwgdW5kZWZpbmVkLCAkLnByb3h5KHRoaXMub25Db21tYW5kRXJyb3IsIHRoaXMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnbmljayc6CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24ubXVjLmNoYW5nZU5pY2sodGhpcy5tb2RlbC5nZXQoJ2ppZCcpLCBtYXRjaFsyXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ29wJzoKICAgICAgICAgICAgICAgICAgICAgICAgYXJncyA9IG1hdGNoWzJdLnNwbGl0T25jZSgnICcpOwogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLm11Yy5vcCh0aGlzLm1vZGVsLmdldCgnamlkJyksIGFyZ3NbMF0sIGFyZ3NbMV0sIHVuZGVmaW5lZCwgJC5wcm94eSh0aGlzLm9uQ29tbWFuZEVycm9yLCB0aGlzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ3RvcGljJzoKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5tdWMuc2V0VG9waWModGhpcy5tb2RlbC5nZXQoJ2ppZCcpLCBtYXRjaFsyXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ3ZvaWNlJzoKICAgICAgICAgICAgICAgICAgICAgICAgYXJncyA9IG1hdGNoWzJdLnNwbGl0T25jZSgnICcpOwogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLm11Yy52b2ljZSh0aGlzLm1vZGVsLmdldCgnamlkJyksIGFyZ3NbMF0sIGFyZ3NbMV0sIHVuZGVmaW5lZCwgJC5wcm94eSh0aGlzLm9uQ29tbWFuZEVycm9yLCB0aGlzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlQ2hhdFJvb21NZXNzYWdlKHRleHQpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgY29ubmVjdDogZnVuY3Rpb24gKHBhc3N3b3JkKSB7CiAgICAgICAgICAgICAgICBpZiAoXy5oYXMoY29udmVyc2UuY29ubmVjdGlvbi5tdWMucm9vbXMsIHRoaXMubW9kZWwuZ2V0KCdqaWQnKSkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGUgcm9vbSBleGlzdHMsIGl0IGFscmVhZHkgaGFzIGV2ZW50IGxpc3RlbmVycywgc28gd2UKICAgICAgICAgICAgICAgICAgICAvLyBkb24ndCBhZGQgdGhlbSBhZ2Fpbi4KICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLm11Yy5qb2luKAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLmdldCgnamlkJyksIHRoaXMubW9kZWwuZ2V0KCduaWNrJyksIG51bGwsIG51bGwsIG51bGwsIHBhc3N3b3JkKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5tdWMuam9pbigKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5nZXQoJ2ppZCcpLAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLmdldCgnbmljaycpLAogICAgICAgICAgICAgICAgICAgICAgICAkLnByb3h5KHRoaXMub25DaGF0Um9vbU1lc3NhZ2UsIHRoaXMpLAogICAgICAgICAgICAgICAgICAgICAgICAkLnByb3h5KHRoaXMub25DaGF0Um9vbVByZXNlbmNlLCB0aGlzKSwKICAgICAgICAgICAgICAgICAgICAgICAgJC5wcm94eSh0aGlzLm9uQ2hhdFJvb21Sb3N0ZXIsIHRoaXMpLAogICAgICAgICAgICAgICAgICAgICAgICBwYXNzd29yZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBvbkxlYXZlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLnNldCgnY29ubmVjdGVkJywgZmFsc2UpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVuZGVyQ29uZmlndXJhdGlvbkZvcm06IGZ1bmN0aW9uIChzdGFuemEpIHsKICAgICAgICAgICAgICAgIHZhciAkZm9ybT0gdGhpcy4kZWwuZmluZCgnZm9ybS5jaGF0cm9vbS1mb3JtJyksCiAgICAgICAgICAgICAgICAgICAgJHN0YW56YSA9ICQoc3RhbnphKSwKICAgICAgICAgICAgICAgICAgICAkZmllbGRzID0gJHN0YW56YS5maW5kKCdmaWVsZCcpLAogICAgICAgICAgICAgICAgICAgIHRpdGxlID0gJHN0YW56YS5maW5kKCd0aXRsZScpLnRleHQoKSwKICAgICAgICAgICAgICAgICAgICBpbnN0cnVjdGlvbnMgPSAkc3RhbnphLmZpbmQoJ2luc3RydWN0aW9ucycpLnRleHQoKSwKICAgICAgICAgICAgICAgICAgICBpLCBqLCBvcHRpb25zPVtdLCAkZmllbGQsICRvcHRpb25zOwogICAgICAgICAgICAgICAgdmFyIGlucHV0X3R5cGVzID0gewogICAgICAgICAgICAgICAgICAgICd0ZXh0LXByaXZhdGUnOiAncGFzc3dvcmQnLAogICAgICAgICAgICAgICAgICAgICd0ZXh0LXNpbmdsZSc6ICd0ZXh0bGluZScsCiAgICAgICAgICAgICAgICAgICAgJ2Jvb2xlYW4nOiAnY2hlY2tib3gnLAogICAgICAgICAgICAgICAgICAgICdoaWRkZW4nOiAnaGlkZGVuJywKICAgICAgICAgICAgICAgICAgICAnbGlzdC1zaW5nbGUnOiAnZHJvcGRvd24nCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgJGZvcm0uZmluZCgnc3Bhbi5zcGlubmVyJykucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAkZm9ybS5hcHBlbmQoJCgnPGxlZ2VuZD4nKS50ZXh0KHRpdGxlKSk7CiAgICAgICAgICAgICAgICBpZiAoaW5zdHJ1Y3Rpb25zICE9IHRpdGxlKSB7CiAgICAgICAgICAgICAgICAgICAgJGZvcm0uYXBwZW5kKCQoJzxwPicpLnRleHQoaW5zdHJ1Y3Rpb25zKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKGk9MDsgaTwkZmllbGRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgJGZpZWxkID0gJCgkZmllbGRzW2ldKTsKICAgICAgICAgICAgICAgICAgICBpZiAoJGZpZWxkLmF0dHIoJ3R5cGUnKSA9PSAnbGlzdC1zaW5nbGUnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgJG9wdGlvbnMgPSAkZmllbGQuZmluZCgnb3B0aW9uJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaj0wOyBqPCRvcHRpb25zLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnB1c2goY29udmVyc2UudGVtcGxhdGVzLnNlbGVjdF9vcHRpb24oewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiAkKCRvcHRpb25zW2pdKS5maW5kKCd2YWx1ZScpLnRleHQoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogJCgkb3B0aW9uc1tqXSkuYXR0cignbGFiZWwnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICRmb3JtLmFwcGVuZChjb252ZXJzZS50ZW1wbGF0ZXMuZm9ybV9zZWxlY3QoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogJGZpZWxkLmF0dHIoJ3ZhcicpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6ICRmaWVsZC5hdHRyKCdsYWJlbCcpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uczogb3B0aW9ucy5qb2luKCcnKQogICAgICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgkZmllbGQuYXR0cigndHlwZScpID09ICdib29sZWFuJykgewogICAgICAgICAgICAgICAgICAgICAgICAkZm9ybS5hcHBlbmQoY29udmVyc2UudGVtcGxhdGVzLmZvcm1fY2hlY2tib3goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogJGZpZWxkLmF0dHIoJ3ZhcicpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogaW5wdXRfdHlwZXNbJGZpZWxkLmF0dHIoJ3R5cGUnKV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogJGZpZWxkLmF0dHIoJ2xhYmVsJykgfHwgJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGVja2VkOiAkZmllbGQuZmluZCgndmFsdWUnKS50ZXh0KCkgPT09ICIxIiAmJiAnY2hlY2tlZD0iMSInIHx8ICcnCiAgICAgICAgICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAkZm9ybS5hcHBlbmQoY29udmVyc2UudGVtcGxhdGVzLmZvcm1faW5wdXQoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogJGZpZWxkLmF0dHIoJ3ZhcicpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogaW5wdXRfdHlwZXNbJGZpZWxkLmF0dHIoJ3R5cGUnKV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogJGZpZWxkLmF0dHIoJ2xhYmVsJykgfHwgJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogJGZpZWxkLmZpbmQoJ3ZhbHVlJykudGV4dCgpCiAgICAgICAgICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkZm9ybS5hcHBlbmQoJzxpbnB1dCB0eXBlPSJzdWJtaXQiIHZhbHVlPSInK19fKCdTYXZlJykrJyIvPicpOwogICAgICAgICAgICAgICAgJGZvcm0uYXBwZW5kKCc8aW5wdXQgdHlwZT0iYnV0dG9uIiB2YWx1ZT0iJytfXygnQ2FuY2VsJykrJyIvPicpOwogICAgICAgICAgICAgICAgJGZvcm0ub24oJ3N1Ym1pdCcsICQucHJveHkodGhpcy5zYXZlQ29uZmlndXJhdGlvbiwgdGhpcykpOwogICAgICAgICAgICAgICAgJGZvcm0uZmluZCgnaW5wdXRbdHlwZT1idXR0b25dJykub24oJ2NsaWNrJywgJC5wcm94eSh0aGlzLmNhbmNlbENvbmZpZ3VyYXRpb24sIHRoaXMpKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHNhdmVDb25maWd1cmF0aW9uOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICB2YXIgJGlucHV0cyA9ICQoZXYudGFyZ2V0KS5maW5kKCc6aW5wdXQ6bm90KFt0eXBlPWJ1dHRvbl0pOm5vdChbdHlwZT1zdWJtaXRdKScpLAogICAgICAgICAgICAgICAgICAgIGNvdW50ID0gJGlucHV0cy5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgY29uZmlnQXJyYXkgPSBbXTsKICAgICAgICAgICAgICAgICRpbnB1dHMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyICRpbnB1dCA9ICQodGhpcyksIHZhbHVlOwogICAgICAgICAgICAgICAgICAgIGlmICgkaW5wdXQuaXMoJ1t0eXBlPWNoZWNrYm94XScpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gJGlucHV0LmlzKCc6Y2hlY2tlZCcpICYmIDEgfHwgMDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9ICRpbnB1dC52YWwoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFyIGNub2RlID0gJChjb252ZXJzZS50ZW1wbGF0ZXMuZmllbGQoewogICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAkaW5wdXQuYXR0cignbmFtZScpLAogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdmFsdWUKICAgICAgICAgICAgICAgICAgICB9KSlbMF07CiAgICAgICAgICAgICAgICAgICAgY29uZmlnQXJyYXkucHVzaChjbm9kZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCEtLWNvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24ubXVjLnNhdmVDb25maWd1cmF0aW9uKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5tb2RlbC5nZXQoJ2ppZCcpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnQXJyYXksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkLnByb3h5KHRoYXQub25Db25maWdTYXZlZCwgdGhhdCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkLnByb3h5KHRoYXQub25FcnJvckNvbmZpZ1NhdmVkLCB0aGF0KQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgnZGl2LmNoYXRyb29tLWZvcm0tY29udGFpbmVyJykuaGlkZSgKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuJGVsLmZpbmQoJy5jaGF0LWFyZWEnKS5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuJGVsLmZpbmQoJy5wYXJ0aWNpcGFudHMnKS5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBvbkNvbmZpZ1NhdmVkOiBmdW5jdGlvbiAoc3RhbnphKSB7CiAgICAgICAgICAgICAgICAvLyBYWFgKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG9uRXJyb3JDb25maWdTYXZlZDogZnVuY3Rpb24gKHN0YW56YSkgewogICAgICAgICAgICAgICAgdGhpcy5zaG93U3RhdHVzTm90aWZpY2F0aW9uKF9fKCJBbiBlcnJvciBvY2N1cnJlZCB3aGlsZSB0cnlpbmcgdG8gc2F2ZSB0aGUgZm9ybS4iKSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBjYW5jZWxDb25maWd1cmF0aW9uOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5maW5kKCdkaXYuY2hhdHJvb20tZm9ybS1jb250YWluZXInKS5oaWRlKAogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC4kZWwuZmluZCgnLmNoYXQtYXJlYScpLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC4kZWwuZmluZCgnLnBhcnRpY2lwYW50cycpLnNob3coKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGNvbmZpZ3VyZUNoYXRSb29tOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy4kZWwuZmluZCgnZGl2LmNoYXRyb29tLWZvcm0tY29udGFpbmVyJykubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy4kKCcuY2hhdC1ib2R5JykuY2hpbGRyZW4oKS5oaWRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLiQoJy5jaGF0LWJvZHknKS5hcHBlbmQoCiAgICAgICAgICAgICAgICAgICAgJCgnPGRpdiBjbGFzcz0iY2hhdHJvb20tZm9ybS1jb250YWluZXIiPicrCiAgICAgICAgICAgICAgICAgICAgICAgICc8Zm9ybSBjbGFzcz0iY2hhdHJvb20tZm9ybSI+JysKICAgICAgICAgICAgICAgICAgICAgICAgJzxzcGFuIGNsYXNzPSJzcGlubmVyIGNlbnRlcmVkIi8+JysKICAgICAgICAgICAgICAgICAgICAgICAgJzwvZm9ybT4nKwogICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nKSk7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLm11Yy5jb25maWd1cmUoCiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5nZXQoJ2ppZCcpLAogICAgICAgICAgICAgICAgICAgICQucHJveHkodGhpcy5yZW5kZXJDb25maWd1cmF0aW9uRm9ybSwgdGhpcykKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzdWJtaXRQYXNzd29yZDogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgdmFyIHBhc3N3b3JkID0gdGhpcy4kZWwuZmluZCgnLmNoYXRyb29tLWZvcm0nKS5maW5kKCdpbnB1dFt0eXBlPXBhc3N3b3JkXScpLnZhbCgpOwogICAgICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgnLmNoYXRyb29tLWZvcm0tY29udGFpbmVyJykucmVwbGFjZVdpdGgoJzxzcGFuIGNsYXNzPSJzcGlubmVyIGNlbnRlcmVkIi8+Jyk7CiAgICAgICAgICAgICAgICB0aGlzLmNvbm5lY3QocGFzc3dvcmQpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVuZGVyUGFzc3dvcmRGb3JtOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLiQoJy5jaGF0LWJvZHknKS5jaGlsZHJlbigpLmhpZGUoKTsKICAgICAgICAgICAgICAgIHRoaXMuJCgnc3Bhbi5jZW50ZXJlZC5zcGlubmVyJykucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICB0aGlzLiQoJy5jaGF0LWJvZHknKS5hcHBlbmQoCiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UudGVtcGxhdGVzLmNoYXRyb29tX3Bhc3N3b3JkX2Zvcm0oewogICAgICAgICAgICAgICAgICAgICAgICBoZWFkaW5nOiBfXygnVGhpcyBjaGF0cm9vbSByZXF1aXJlcyBhIHBhc3N3b3JkJyksCiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsX3Bhc3N3b3JkOiBfXygnUGFzc3dvcmQ6ICcpLAogICAgICAgICAgICAgICAgICAgICAgICBsYWJlbF9zdWJtaXQ6IF9fKCdTdWJtaXQnKQogICAgICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgICAgIHRoaXMuJCgnLmNoYXRyb29tLWZvcm0nKS5vbignc3VibWl0JywgJC5wcm94eSh0aGlzLnN1Ym1pdFBhc3N3b3JkLCB0aGlzKSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzaG93RGlzY29ubmVjdE1lc3NhZ2U6IGZ1bmN0aW9uIChtc2cpIHsKICAgICAgICAgICAgICAgIHRoaXMuJCgnLmNoYXQtYXJlYScpLmhpZGUoKTsKICAgICAgICAgICAgICAgIHRoaXMuJCgnLnBhcnRpY2lwYW50cycpLmhpZGUoKTsKICAgICAgICAgICAgICAgIHRoaXMuJCgnc3Bhbi5jZW50ZXJlZC5zcGlubmVyJykucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICB0aGlzLiQoJy5jaGF0LWJvZHknKS5hcHBlbmQoJCgnPHA+Jyttc2crJzwvcD4nKSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKiBodHRwOi8veG1wcC5vcmcvZXh0ZW5zaW9ucy94ZXAtMDA0NS5odG1sCiAgICAgICAgICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAgICAgICogMTAwIG1lc3NhZ2UgICAgICBFbnRlcmluZyBhIHJvb20gICAgICAgICBJbmZvcm0gdXNlciB0aGF0IGFueSBvY2N1cGFudCBpcyBhbGxvd2VkIHRvIHNlZSB0aGUgdXNlcidzIGZ1bGwgSklECiAgICAgICAgICAgICAqIDEwMSBtZXNzYWdlIChvdXQgb2YgYmFuZCkgICAgICAgICAgICAgICAgQWZmaWxpYXRpb24gY2hhbmdlICBJbmZvcm0gdXNlciB0aGF0IGhpcyBvciBoZXIgYWZmaWxpYXRpb24gY2hhbmdlZCB3aGlsZSBub3QgaW4gdGhlIHJvb20KICAgICAgICAgICAgICogMTAyIG1lc3NhZ2UgICAgICBDb25maWd1cmF0aW9uIGNoYW5nZSAgICBJbmZvcm0gb2NjdXBhbnRzIHRoYXQgcm9vbSBub3cgc2hvd3MgdW5hdmFpbGFibGUgbWVtYmVycwogICAgICAgICAgICAgKiAxMDMgbWVzc2FnZSAgICAgIENvbmZpZ3VyYXRpb24gY2hhbmdlICAgIEluZm9ybSBvY2N1cGFudHMgdGhhdCByb29tIG5vdyBkb2VzIG5vdCBzaG93IHVuYXZhaWxhYmxlIG1lbWJlcnMKICAgICAgICAgICAgICogMTA0IG1lc3NhZ2UgICAgICBDb25maWd1cmF0aW9uIGNoYW5nZSAgICBJbmZvcm0gb2NjdXBhbnRzIHRoYXQgYSBub24tcHJpdmFjeS1yZWxhdGVkIHJvb20gY29uZmlndXJhdGlvbiBjaGFuZ2UgaGFzIG9jY3VycmVkCiAgICAgICAgICAgICAqIDExMCBwcmVzZW5jZSAgICAgQW55IHJvb20gcHJlc2VuY2UgICAgICAgSW5mb3JtIHVzZXIgdGhhdCBwcmVzZW5jZSByZWZlcnMgdG8gb25lIG9mIGl0cyBvd24gcm9vbSBvY2N1cGFudHMKICAgICAgICAgICAgICogMTcwIG1lc3NhZ2Ugb3IgaW5pdGlhbCBwcmVzZW5jZSAgICAgICAgICBDb25maWd1cmF0aW9uIGNoYW5nZSAgICBJbmZvcm0gb2NjdXBhbnRzIHRoYXQgcm9vbSBsb2dnaW5nIGlzIG5vdyBlbmFibGVkCiAgICAgICAgICAgICAqIDE3MSBtZXNzYWdlICAgICAgQ29uZmlndXJhdGlvbiBjaGFuZ2UgICAgSW5mb3JtIG9jY3VwYW50cyB0aGF0IHJvb20gbG9nZ2luZyBpcyBub3cgZGlzYWJsZWQKICAgICAgICAgICAgICogMTcyIG1lc3NhZ2UgICAgICBDb25maWd1cmF0aW9uIGNoYW5nZSAgICBJbmZvcm0gb2NjdXBhbnRzIHRoYXQgdGhlIHJvb20gaXMgbm93IG5vbi1hbm9ueW1vdXMKICAgICAgICAgICAgICogMTczIG1lc3NhZ2UgICAgICBDb25maWd1cmF0aW9uIGNoYW5nZSAgICBJbmZvcm0gb2NjdXBhbnRzIHRoYXQgdGhlIHJvb20gaXMgbm93IHNlbWktYW5vbnltb3VzCiAgICAgICAgICAgICAqIDE3NCBtZXNzYWdlICAgICAgQ29uZmlndXJhdGlvbiBjaGFuZ2UgICAgSW5mb3JtIG9jY3VwYW50cyB0aGF0IHRoZSByb29tIGlzIG5vdyBmdWxseS1hbm9ueW1vdXMKICAgICAgICAgICAgICogMjAxIHByZXNlbmNlICAgICBFbnRlcmluZyBhIHJvb20gICAgICAgICBJbmZvcm0gdXNlciB0aGF0IGEgbmV3IHJvb20gaGFzIGJlZW4gY3JlYXRlZAogICAgICAgICAgICAgKiAyMTAgcHJlc2VuY2UgICAgIEVudGVyaW5nIGEgcm9vbSAgICAgICAgIEluZm9ybSB1c2VyIHRoYXQgdGhlIHNlcnZpY2UgaGFzIGFzc2lnbmVkIG9yIG1vZGlmaWVkIHRoZSBvY2N1cGFudCdzIHJvb21uaWNrCiAgICAgICAgICAgICAqIDMwMSBwcmVzZW5jZSAgICAgUmVtb3ZhbCBmcm9tIHJvb20gICAgICAgSW5mb3JtIHVzZXIgdGhhdCBoZSBvciBzaGUgaGFzIGJlZW4gYmFubmVkIGZyb20gdGhlIHJvb20KICAgICAgICAgICAgICogMzAzIHByZXNlbmNlICAgICBFeGl0aW5nIGEgcm9vbSAgICAgICAgICBJbmZvcm0gYWxsIG9jY3VwYW50cyBvZiBuZXcgcm9vbSBuaWNrbmFtZQogICAgICAgICAgICAgKiAzMDcgcHJlc2VuY2UgICAgIFJlbW92YWwgZnJvbSByb29tICAgICAgIEluZm9ybSB1c2VyIHRoYXQgaGUgb3Igc2hlIGhhcyBiZWVuIGtpY2tlZCBmcm9tIHRoZSByb29tCiAgICAgICAgICAgICAqIDMyMSBwcmVzZW5jZSAgICAgUmVtb3ZhbCBmcm9tIHJvb20gICAgICAgSW5mb3JtIHVzZXIgdGhhdCBoZSBvciBzaGUgaXMgYmVpbmcgcmVtb3ZlZCBmcm9tIHRoZSByb29tIGJlY2F1c2Ugb2YgYW4gYWZmaWxpYXRpb24gY2hhbmdlCiAgICAgICAgICAgICAqIDMyMiBwcmVzZW5jZSAgICAgUmVtb3ZhbCBmcm9tIHJvb20gICAgICAgSW5mb3JtIHVzZXIgdGhhdCBoZSBvciBzaGUgaXMgYmVpbmcgcmVtb3ZlZCBmcm9tIHRoZSByb29tIGJlY2F1c2UgdGhlIHJvb20gaGFzIGJlZW4gY2hhbmdlZCB0byBtZW1iZXJzLW9ubHkgYW5kIHRoZSB1c2VyIGlzIG5vdCBhIG1lbWJlcgogICAgICAgICAgICAgKiAzMzIgcHJlc2VuY2UgICAgIFJlbW92YWwgZnJvbSByb29tICAgICAgIEluZm9ybSB1c2VyIHRoYXQgaGUgb3Igc2hlIGlzIGJlaW5nIHJlbW92ZWQgZnJvbSB0aGUgcm9vbSBiZWNhdXNlIG9mIGEgc3lzdGVtIHNodXRkb3duCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBpbmZvTWVzc2FnZXM6IHsKICAgICAgICAgICAgICAgIDEwMDogX18oJ1RoaXMgcm9vbSBpcyBub3QgYW5vbnltb3VzJyksCiAgICAgICAgICAgICAgICAxMDI6IF9fKCdUaGlzIHJvb20gbm93IHNob3dzIHVuYXZhaWxhYmxlIG1lbWJlcnMnKSwKICAgICAgICAgICAgICAgIDEwMzogX18oJ1RoaXMgcm9vbSBkb2VzIG5vdCBzaG93IHVuYXZhaWxhYmxlIG1lbWJlcnMnKSwKICAgICAgICAgICAgICAgIDEwNDogX18oJ05vbi1wcml2YWN5LXJlbGF0ZWQgcm9vbSBjb25maWd1cmF0aW9uIGhhcyBjaGFuZ2VkJyksCiAgICAgICAgICAgICAgICAxNzA6IF9fKCdSb29tIGxvZ2dpbmcgaXMgbm93IGVuYWJsZWQnKSwKICAgICAgICAgICAgICAgIDE3MTogX18oJ1Jvb20gbG9nZ2luZyBpcyBub3cgZGlzYWJsZWQnKSwKICAgICAgICAgICAgICAgIDE3MjogX18oJ1RoaXMgcm9vbSBpcyBub3cgbm9uLWFub255bW91cycpLAogICAgICAgICAgICAgICAgMTczOiBfXygnVGhpcyByb29tIGlzIG5vdyBzZW1pLWFub255bW91cycpLAogICAgICAgICAgICAgICAgMTc0OiBfXygnVGhpcyByb29tIGlzIG5vdyBmdWxseS1hbm9ueW1vdXMnKSwKICAgICAgICAgICAgICAgIDIwMTogX18oJ0EgbmV3IHJvb20gaGFzIGJlZW4gY3JlYXRlZCcpCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBkaXNjb25uZWN0TWVzc2FnZXM6IHsKICAgICAgICAgICAgICAgIDMwMTogX18oJ1lvdSBoYXZlIGJlZW4gYmFubmVkIGZyb20gdGhpcyByb29tJyksCiAgICAgICAgICAgICAgICAzMDc6IF9fKCdZb3UgaGF2ZSBiZWVuIGtpY2tlZCBmcm9tIHRoaXMgcm9vbScpLAogICAgICAgICAgICAgICAgMzIxOiBfXygiWW91IGhhdmUgYmVlbiByZW1vdmVkIGZyb20gdGhpcyByb29tIGJlY2F1c2Ugb2YgYW4gYWZmaWxpYXRpb24gY2hhbmdlIiksCiAgICAgICAgICAgICAgICAzMjI6IF9fKCJZb3UgaGF2ZSBiZWVuIHJlbW92ZWQgZnJvbSB0aGlzIHJvb20gYmVjYXVzZSB0aGUgcm9vbSBoYXMgY2hhbmdlZCB0byBtZW1iZXJzLW9ubHkgYW5kIHlvdSdyZSBub3QgYSBtZW1iZXIiKSwKICAgICAgICAgICAgICAgIDMzMjogX18oIllvdSBoYXZlIGJlZW4gcmVtb3ZlZCBmcm9tIHRoaXMgcm9vbSBiZWNhdXNlIHRoZSBNVUMgKE11bHRpLXVzZXIgY2hhdCkgc2VydmljZSBpcyBiZWluZyBzaHV0IGRvd24uIikKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGFjdGlvbkluZm9NZXNzYWdlczogewogICAgICAgICAgICAgICAgLyogWFhYOiBOb3RlIHRoZSB0cmlwbGUgdW5kZXJzY29yZSBmdW5jdGlvbiBhbmQgbm90IGRvdWJsZQogICAgICAgICAgICAgICAgICogdW5kZXJzY29yZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGlzIGlzIGEgaGFjay4gV2UgY2FuJ3QgcGFzcyB0aGUgc3RyaW5ncyB0byBfXyBiZWNhdXNlIHdlCiAgICAgICAgICAgICAgICAgKiBkb24ndCB5ZXQga25vdyB3aGF0IHRoZSB2YXJpYWJsZSB0byBpbnRlcnBvbGF0ZSBpcy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUcmlwbGUgdW5kZXJzY29yZSB3aWxsIGp1c3QgcmV0dXJuIHRoZSBzdHJpbmcgYWdhaW4sIGJ1dCB3ZQogICAgICAgICAgICAgICAgICogY2FuIHRoZW4gYXQgbGVhc3QgdGVsbCBnZXR0ZXh0IHRvIHNjYW4gZm9yIGl0IHNvIHRoYXQgdGhlc2UKICAgICAgICAgICAgICAgICAqIHN0cmluZ3MgYXJlIHBpY2tlZCB1cCBieSB0aGUgdHJhbnNsYXRpb24gbWFjaGluZXJ5LgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAzMDE6IF9fXygiPHN0cm9uZz4lMSRzPC9zdHJvbmc+IGhhcyBiZWVuIGJhbm5lZCIpLAogICAgICAgICAgICAgICAgMzAzOiBfX18oIjxzdHJvbmc+JTEkczwvc3Ryb25nPidzIG5pY2tuYW1lIGhhcyBjaGFuZ2VkIiksCiAgICAgICAgICAgICAgICAzMDc6IF9fXygiPHN0cm9uZz4lMSRzPC9zdHJvbmc+IGhhcyBiZWVuIGtpY2tlZCBvdXQiKSwKICAgICAgICAgICAgICAgIDMyMTogX19fKCI8c3Ryb25nPiUxJHM8L3N0cm9uZz4gaGFzIGJlZW4gcmVtb3ZlZCBiZWNhdXNlIG9mIGFuIGFmZmlsaWF0aW9uIGNoYW5nZSIpLAogICAgICAgICAgICAgICAgMzIyOiBfX18oIjxzdHJvbmc+JTEkczwvc3Ryb25nPiBoYXMgYmVlbiByZW1vdmVkIGZvciBub3QgYmVpbmcgYSBtZW1iZXIiKQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgbmV3Tmlja25hbWVNZXNzYWdlczogewogICAgICAgICAgICAgICAgMjEwOiBfX18oJ1lvdXIgbmlja25hbWUgaGFzIGJlZW4gYXV0b21hdGljYWxseSBjaGFuZ2VkIHRvOiA8c3Ryb25nPiUxJHM8L3N0cm9uZz4nKSwKICAgICAgICAgICAgICAgIDMwMzogX19fKCdZb3VyIG5pY2tuYW1lIGhhcyBiZWVuIGNoYW5nZWQgdG86IDxzdHJvbmc+JTEkczwvc3Ryb25nPicpCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzaG93U3RhdHVzTWVzc2FnZXM6IGZ1bmN0aW9uICgkZWwsIGlzX3NlbGYpIHsKICAgICAgICAgICAgICAgIC8qIENoZWNrIGZvciBzdGF0dXMgY29kZXMgYW5kIGNvbW11bmljYXRlIHRoZWlyIHB1cnBvc2UgdG8gdGhlIHVzZXIuCiAgICAgICAgICAgICAgICAgKiBBbGxvdyB1c2VyIHRvIGNvbmZpZ3VyZSBjaGF0IHJvb20gaWYgdGhleSBhcmUgdGhlIG93bmVyLgogICAgICAgICAgICAgICAgICogU2VlOiBodHRwOi8veG1wcC5vcmcvcmVnaXN0cmFyL211Y3N0YXR1cy5odG1sCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIHZhciAkY2hhdF9jb250ZW50LAogICAgICAgICAgICAgICAgICAgIGRpc2Nvbm5lY3RfbXNncyA9IFtdLAogICAgICAgICAgICAgICAgICAgIG1zZ3MgPSBbXSwKICAgICAgICAgICAgICAgICAgICByZWFzb25zID0gW107CiAgICAgICAgICAgICAgICAkZWwuZmluZCgneFt4bWxucz0iJytTdHJvcGhlLk5TLk1VQ19VU0VSKyciXScpLmVhY2goJC5wcm94eShmdW5jdGlvbiAoaWR4LCB4KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyICRpdGVtID0gJCh4KS5maW5kKCdpdGVtJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKFN0cm9waGUuZ2V0QmFyZUppZEZyb21KaWQoJGl0ZW0uYXR0cignamlkJykpID09PSBjb252ZXJzZS5iYXJlX2ppZCAmJiAkaXRlbS5hdHRyKCdhZmZpbGlhdGlvbicpID09PSAnb3duZXInKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLmZpbmQoJ2EuY29uZmlndXJlLWNoYXRyb29tLWJ1dHRvbicpLnNob3coKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgJCh4KS5maW5kKCdpdGVtIHJlYXNvbicpLmVhY2goZnVuY3Rpb24gKGlkeCwgcmVhc29uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkKHJlYXNvbikudGV4dCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFzb25zLnB1c2goJChyZWFzb24pLnRleHQoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAkKHgpLmZpbmQoJ3N0YXR1cycpLmVhY2goJC5wcm94eShmdW5jdGlvbiAoaWR4LCBzdGF0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb2RlID0gc3RhdC5nZXRBdHRyaWJ1dGUoJ2NvZGUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzX3NlbGYgJiYgXy5jb250YWlucyhfLmtleXModGhpcy5uZXdOaWNrbmFtZU1lc3NhZ2VzKSwgY29kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuc2F2ZSh7J25pY2snOiBTdHJvcGhlLmdldFJlc291cmNlRnJvbUppZCgkZWwuYXR0cignZnJvbScpKX0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNncy5wdXNoKF9fKHRoaXMubmV3Tmlja25hbWVNZXNzYWdlc1tjb2RlXSwgJGl0ZW0uYXR0cignbmljaycpKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNfc2VsZiAmJiBfLmNvbnRhaW5zKF8ua2V5cyh0aGlzLmRpc2Nvbm5lY3RNZXNzYWdlcyksIGNvZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNjb25uZWN0X21zZ3MucHVzaCh0aGlzLmRpc2Nvbm5lY3RNZXNzYWdlc1tjb2RlXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWlzX3NlbGYgJiYgXy5jb250YWlucyhfLmtleXModGhpcy5hY3Rpb25JbmZvTWVzc2FnZXMpLCBjb2RlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNncy5wdXNoKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9fKHRoaXMuYWN0aW9uSW5mb01lc3NhZ2VzW2NvZGVdLCBTdHJvcGhlLnVuZXNjYXBlTm9kZShTdHJvcGhlLmdldFJlc291cmNlRnJvbUppZCgkZWwuYXR0cignZnJvbScpKSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKF8uY29udGFpbnMoXy5rZXlzKHRoaXMuaW5mb01lc3NhZ2VzKSwgY29kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zZ3MucHVzaCh0aGlzLmluZm9NZXNzYWdlc1tjb2RlXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29kZSAhPT0gJzExMCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkKHN0YXQpLnRleHQoKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zZ3MucHVzaCgkKHN0YXQpLnRleHQoKSk7IC8vIFNvbWV0aW1lcyB0aGUgc3RhdHVzIGNvbnRhaW5zIGh1bWFuIHJlYWRhYmxlIHRleHQgYW5kIG5vdCBhIGNvZGUuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCB0aGlzKSk7CiAgICAgICAgICAgICAgICB9LCB0aGlzKSk7CgogICAgICAgICAgICAgICAgaWYgKGRpc2Nvbm5lY3RfbXNncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpPTA7IGk8ZGlzY29ubmVjdF9tc2dzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Rpc2Nvbm5lY3RNZXNzYWdlKGRpc2Nvbm5lY3RfbXNnc1tpXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZvciAoaT0wOyBpPHJlYXNvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93RGlzY29ubmVjdE1lc3NhZ2UoX18oJ1RoZSByZWFzb24gZ2l2ZW4gaXM6ICInK3JlYXNvbnNbaV0rJyInKSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuc2V0KCdjb25uZWN0ZWQnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJGNoYXRfY29udGVudCA9IHRoaXMuJGVsLmZpbmQoJy5jaGF0LWNvbnRlbnQnKTsKICAgICAgICAgICAgICAgIGZvciAoaT0wOyBpPG1zZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAkY2hhdF9jb250ZW50LmFwcGVuZChjb252ZXJzZS50ZW1wbGF0ZXMuaW5mbyh7bWVzc2FnZTogbXNnc1tpXX0pKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvciAoaT0wOyBpPHJlYXNvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dTdGF0dXNOb3RpZmljYXRpb24oX18oJ1RoZSByZWFzb24gZ2l2ZW4gaXM6ICInK3JlYXNvbnNbaV0rJyInKSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zY3JvbGxEb3duKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzaG93RXJyb3JNZXNzYWdlOiBmdW5jdGlvbiAoJGVycm9yLCByb29tKSB7CiAgICAgICAgICAgICAgICAvLyBXZSBkaWRuJ3QgZW50ZXIgdGhlIHJvb20sIHNvIHdlIG11c3QgcmVtb3ZlIGl0IGZyb20gdGhlIE1VQwogICAgICAgICAgICAgICAgLy8gYWRkLW9uCiAgICAgICAgICAgICAgICBkZWxldGUgY29udmVyc2UuY29ubmVjdGlvbi5tdWNbcm9vbS5uYW1lXTsKICAgICAgICAgICAgICAgIGlmICgkZXJyb3IuYXR0cigndHlwZScpID09ICdhdXRoJykgewogICAgICAgICAgICAgICAgICAgIGlmICgkZXJyb3IuZmluZCgnbm90LWF1dGhvcml6ZWQnKS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJQYXNzd29yZEZvcm0oKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCRlcnJvci5maW5kKCdyZWdpc3RyYXRpb24tcmVxdWlyZWQnKS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93RGlzY29ubmVjdE1lc3NhZ2UoX18oJ1lvdSBhcmUgbm90IG9uIHRoZSBtZW1iZXIgbGlzdCBvZiB0aGlzIHJvb20nKSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgkZXJyb3IuZmluZCgnZm9yYmlkZGVuJykubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Rpc2Nvbm5lY3RNZXNzYWdlKF9fKCdZb3UgaGF2ZSBiZWVuIGJhbm5lZCBmcm9tIHRoaXMgcm9vbScpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCRlcnJvci5hdHRyKCd0eXBlJykgPT0gJ21vZGlmeScpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoJGVycm9yLmZpbmQoJ2ppZC1tYWxmb3JtZWQnKS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93RGlzY29ubmVjdE1lc3NhZ2UoX18oJ05vIG5pY2tuYW1lIHdhcyBzcGVjaWZpZWQnKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgkZXJyb3IuYXR0cigndHlwZScpID09ICdjYW5jZWwnKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCRlcnJvci5maW5kKCdub3QtYWxsb3dlZCcpLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dEaXNjb25uZWN0TWVzc2FnZShfXygnWW91IGFyZSBub3QgYWxsb3dlZCB0byBjcmVhdGUgbmV3IHJvb21zJykpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoJGVycm9yLmZpbmQoJ25vdC1hY2NlcHRhYmxlJykubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Rpc2Nvbm5lY3RNZXNzYWdlKF9fKCJZb3VyIG5pY2tuYW1lIGRvZXNuJ3QgY29uZm9ybSB0byB0aGlzIHJvb20ncyBwb2xpY2llcyIpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCRlcnJvci5maW5kKCdjb25mbGljdCcpLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBnaXZlIHVzZXIgdGhlIG9wdGlvbiBvZiBjaG9vc2luZyBhIGRpZmZlcmVudAogICAgICAgICAgICAgICAgICAgICAgICAvLyBuaWNrbmFtZQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dEaXNjb25uZWN0TWVzc2FnZShfXygiWW91ciBuaWNrbmFtZSBpcyBhbHJlYWR5IHRha2VuIikpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoJGVycm9yLmZpbmQoJ2l0ZW0tbm90LWZvdW5kJykubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Rpc2Nvbm5lY3RNZXNzYWdlKF9fKCJUaGlzIHJvb20gZG9lcyBub3QgKHlldCkgZXhpc3QiKSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgkZXJyb3IuZmluZCgnc2VydmljZS11bmF2YWlsYWJsZScpLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dEaXNjb25uZWN0TWVzc2FnZShfXygiVGhpcyByb29tIGhhcyByZWFjaGVkIGl0J3MgbWF4aW11bSBudW1iZXIgb2Ygb2NjdXBhbnRzIikpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG9uQ2hhdFJvb21QcmVzZW5jZTogZnVuY3Rpb24gKHByZXNlbmNlLCByb29tKSB7CiAgICAgICAgICAgICAgICB2YXIgJHByZXNlbmNlID0gJChwcmVzZW5jZSksIGlzX3NlbGY7CiAgICAgICAgICAgICAgICBpZiAoJHByZXNlbmNlLmF0dHIoJ3R5cGUnKSA9PT0gJ2Vycm9yJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuc2V0KCdjb25uZWN0ZWQnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93RXJyb3JNZXNzYWdlKCRwcmVzZW5jZS5maW5kKCdlcnJvcicpLCByb29tKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaXNfc2VsZiA9ICgkcHJlc2VuY2UuZmluZCgic3RhdHVzW2NvZGU9JzExMCddIikubGVuZ3RoKSB8fCAoJHByZXNlbmNlLmF0dHIoJ2Zyb20nKSA9PSByb29tLm5hbWUrJy8nK1N0cm9waGUuZXNjYXBlTm9kZShyb29tLm5pY2spKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMubW9kZWwuZ2V0KCdjb25uZWNlZCcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuc2V0KCdjb25uZWN0ZWQnLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kKCdzcGFuLmNlbnRlcmVkLnNwaW5uZXInKS5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgnLmNoYXQtYm9keScpLmNoaWxkcmVuKCkuc2hvdygpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dTdGF0dXNNZXNzYWdlcygkcHJlc2VuY2UsIGlzX3NlbGYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBvbkNoYXRSb29tTWVzc2FnZTogZnVuY3Rpb24gKG1lc3NhZ2UpIHsKICAgICAgICAgICAgICAgIHZhciAkbWVzc2FnZSA9ICQobWVzc2FnZSksCiAgICAgICAgICAgICAgICAgICAgYm9keSA9ICRtZXNzYWdlLmNoaWxkcmVuKCdib2R5JykudGV4dCgpLAogICAgICAgICAgICAgICAgICAgIGppZCA9ICRtZXNzYWdlLmF0dHIoJ2Zyb20nKSwKICAgICAgICAgICAgICAgICAgICBtc2dpZCA9ICRtZXNzYWdlLmF0dHIoJ2lkJyksCiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2UgPSBTdHJvcGhlLmdldFJlc291cmNlRnJvbUppZChqaWQpLAogICAgICAgICAgICAgICAgICAgIHNlbmRlciA9IHJlc291cmNlICYmIFN0cm9waGUudW5lc2NhcGVOb2RlKHJlc291cmNlKSB8fCAnJywKICAgICAgICAgICAgICAgICAgICBkZWxheWVkID0gJG1lc3NhZ2UuZmluZCgnZGVsYXknKS5sZW5ndGggPiAwLAogICAgICAgICAgICAgICAgICAgIHN1YmplY3QgPSAkbWVzc2FnZS5jaGlsZHJlbignc3ViamVjdCcpLnRleHQoKTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5tb2RlbC5tZXNzYWdlcy5maW5kV2hlcmUoe21zZ2lkOiBtc2dpZH0pKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIFdlIGFscmVhZHkgaGF2ZSB0aGlzIG1lc3NhZ2Ugc3RvcmVkLgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5zaG93U3RhdHVzTWVzc2FnZXMoJG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgaWYgKHN1YmplY3QpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5maW5kKCcuY2hhdHJvb20tdG9waWMnKS50ZXh0KHN1YmplY3QpLmF0dHIoJ3RpdGxlJywgc3ViamVjdCk7CiAgICAgICAgICAgICAgICAgICAgLy8gIyBGb3IgdHJhbnNsYXRvcnM6IHRoZSAlMSRzIGFuZCAlMiRzIHBhcnRzIHdpbGwgZ2V0IHJlcGxhY2VkIGJ5IHRoZSB1c2VyIGFuZCB0b3BpYyB0ZXh0IHJlc3BlY3RpdmVseQogICAgICAgICAgICAgICAgICAgIC8vICMgRXhhbXBsZTogVG9waWMgc2V0IGJ5IEpDIEJyYW5kIHRvOiBIZWxsbyBXb3JsZCEKICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5maW5kKCcuY2hhdC1jb250ZW50JykuYXBwZW5kKAogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS50ZW1wbGF0ZXMuaW5mbyh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZSc6IF9fKCdUb3BpYyBzZXQgYnkgJTEkcyB0bzogJTIkcycsIHNlbmRlciwgc3ViamVjdCkKICAgICAgICAgICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHNlbmRlciA9PT0gJycpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuY3JlYXRlTWVzc2FnZSgkbWVzc2FnZSk7CiAgICAgICAgICAgICAgICBpZiAoIWRlbGF5ZWQgJiYgc2VuZGVyICE9PSB0aGlzLm1vZGVsLmdldCgnbmljaycpICYmIChuZXcgUmVnRXhwKCJcXGIiK3RoaXMubW9kZWwuZ2V0KCduaWNrJykrIlxcYiIpKS50ZXN0KGJvZHkpKSB7CiAgICAgICAgICAgICAgICAgICAgcGxheU5vdGlmaWNhdGlvbigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHNlbmRlciAhPT0gdGhpcy5tb2RlbC5nZXQoJ25pY2snKSkgewogICAgICAgICAgICAgICAgICAgIC8vIFdlIG9ubHkgZW1pdCBhbiBldmVudCBpZiBpdCdzIG5vdCBvdXIgb3duIG1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5lbWl0KCdtZXNzYWdlJywgbWVzc2FnZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG9uQ2hhdFJvb21Sb3N0ZXI6IGZ1bmN0aW9uIChyb3N0ZXIsIHJvb20pIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm9jY3VwYW50c3ZpZXcub25DaGF0Um9vbVJvc3Rlcihyb3N0ZXIsIHJvb20pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuQ2hhdEJveGVzID0gQmFja2JvbmUuQ29sbGVjdGlvbi5leHRlbmQoewogICAgICAgICAgICBtb2RlbDogY29udmVyc2UuQ2hhdEJveCwKICAgICAgICAgICAgY29tcGFyYXRvcjogJ3RpbWVfb3BlbmVkJywKCiAgICAgICAgICAgIHJlZ2lzdGVyTWVzc2FnZUhhbmRsZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24uYWRkSGFuZGxlcigKICAgICAgICAgICAgICAgICAgICAkLnByb3h5KGZ1bmN0aW9uIChtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25NZXNzYWdlKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9LCB0aGlzKSwgbnVsbCwgJ21lc3NhZ2UnLCAnY2hhdCcpOwoKICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24uYWRkSGFuZGxlcigKICAgICAgICAgICAgICAgICAgICAkLnByb3h5KGZ1bmN0aW9uIChtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25JbnZpdGUobWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0sIHRoaXMpLCAnamFiYmVyOng6Y29uZmVyZW5jZScsICdtZXNzYWdlJyk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBvbkNvbm5lY3RlZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy5icm93c2VyU3RvcmFnZSA9IG5ldyBCYWNrYm9uZS5Ccm93c2VyU3RvcmFnZVtjb252ZXJzZS5zdG9yYWdlXSgKICAgICAgICAgICAgICAgICAgICBiNjRfc2hhMSgnY29udmVyc2UuY2hhdGJveGVzLScrY29udmVyc2UuYmFyZV9qaWQpKTsKICAgICAgICAgICAgICAgIHRoaXMucmVnaXN0ZXJNZXNzYWdlSGFuZGxlcigpOwogICAgICAgICAgICAgICAgdGhpcy5mZXRjaCh7CiAgICAgICAgICAgICAgICAgICAgYWRkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6ICQucHJveHkoZnVuY3Rpb24gKGNvbGxlY3Rpb24sIHJlc3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFfLmluY2x1ZGUoXy5wbHVjayhyZXNwLCAnaWQnKSwgJ2NvbnRyb2xib3gnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGQoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiAnY29udHJvbGJveCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm94X2lkOiAnY29udHJvbGJveCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0KCdjb250cm9sYm94Jykuc2F2ZSh7Y29ubmVjdGVkOnRydWV9KTsKICAgICAgICAgICAgICAgICAgICB9LCB0aGlzKQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpc09ubHlDaGF0U3RhdGVOb3RpZmljYXRpb246IGZ1bmN0aW9uICgkbXNnKSB7CiAgICAgICAgICAgICAgICAvLyBTZWUgWEVQLTAwODUgQ2hhdCBTdGF0ZSBOb3RpZmljYXRpb24KICAgICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAgICAgJG1zZy5maW5kKCdib2R5JykubGVuZ3RoID09PSAwICYmICgKICAgICAgICAgICAgICAgICAgICAgICAgJG1zZy5maW5kKEFDVElWRSkubGVuZ3RoICE9PSAwIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICRtc2cuZmluZChDT01QT1NJTkcpLmxlbmd0aCAhPT0gMCB8fAogICAgICAgICAgICAgICAgICAgICAgICAkbXNnLmZpbmQoSU5BQ1RJVkUpLmxlbmd0aCAhPT0gMCB8fAogICAgICAgICAgICAgICAgICAgICAgICAkbXNnLmZpbmQoUEFVU0VEKS5sZW5ndGggIT09IDAgfHwKICAgICAgICAgICAgICAgICAgICAgICAgJG1zZy5maW5kKEdPTkUpLmxlbmd0aCAhPT0gMAogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBvbkludml0ZTogZnVuY3Rpb24gKG1lc3NhZ2UpIHsKICAgICAgICAgICAgICAgIHZhciAkbWVzc2FnZSA9ICQobWVzc2FnZSksCiAgICAgICAgICAgICAgICAgICAgJHggPSAkbWVzc2FnZS5jaGlsZHJlbigneFt4bWxucz0iamFiYmVyOng6Y29uZmVyZW5jZSJdJyksCiAgICAgICAgICAgICAgICAgICAgZnJvbSA9IFN0cm9waGUuZ2V0QmFyZUppZEZyb21KaWQoJG1lc3NhZ2UuYXR0cignZnJvbScpKSwKICAgICAgICAgICAgICAgICAgICByb29tX2ppZCA9ICR4LmF0dHIoJ2ppZCcpLAogICAgICAgICAgICAgICAgICAgIHJlYXNvbiA9ICR4LmF0dHIoJ3JlYXNvbicpLAogICAgICAgICAgICAgICAgICAgIGNvbnRhY3QgPSBjb252ZXJzZS5yb3N0ZXIuZ2V0KGZyb20pLAogICAgICAgICAgICAgICAgICAgIHJlc3VsdDsKCiAgICAgICAgICAgICAgICBpZiAoIXJlYXNvbikgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGNvbmZpcm0oCiAgICAgICAgICAgICAgICAgICAgICAgIF9fKF9fXygiJTEkcyBoYXMgaW52aXRlZCB5b3UgdG8gam9pbiBhIGNoYXQgcm9vbTogJTIkcyIpLCBjb250YWN0LmdldCgnZnVsbG5hbWUnKSwgcm9vbV9qaWQpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gY29uZmlybSgKICAgICAgICAgICAgICAgICAgICAgICAgIF9fKF9fXygnJTEkcyBoYXMgaW52aXRlZCB5b3UgdG8gam9pbiBhIGNoYXQgcm9vbTogJTIkcywgYW5kIGxlZnQgdGhlIGZvbGxvd2luZyByZWFzb246ICIlMyRzIicpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhY3QuZ2V0KCdmdWxsbmFtZScpLCByb29tX2ppZCwgcmVhc29uKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocmVzdWx0ID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNoYXRyb29tID0gY29udmVyc2UuY2hhdGJveHZpZXdzLnNob3dDaGF0KHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2lkJzogcm9vbV9qaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICdqaWQnOiByb29tX2ppZCwKICAgICAgICAgICAgICAgICAgICAgICAgJ25hbWUnOiBTdHJvcGhlLnVuZXNjYXBlTm9kZShTdHJvcGhlLmdldE5vZGVGcm9tSmlkKHJvb21famlkKSksCiAgICAgICAgICAgICAgICAgICAgICAgICduaWNrJzogU3Ryb3BoZS51bmVzY2FwZU5vZGUoU3Ryb3BoZS5nZXROb2RlRnJvbUppZChjb252ZXJzZS5jb25uZWN0aW9uLmppZCkpLAogICAgICAgICAgICAgICAgICAgICAgICAnY2hhdHJvb20nOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAnYm94X2lkJyA6IGI2NF9zaGExKHJvb21famlkKSwKICAgICAgICAgICAgICAgICAgICAgICAgJ3Bhc3N3b3JkJzogJHguYXR0cigncGFzc3dvcmQnKQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGlmICghY2hhdHJvb20uZ2V0KCdjb25uZWN0ZWQnKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jaGF0Ym94dmlld3MuZ2V0KHJvb21famlkKS5jb25uZWN0KG51bGwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG9uTWVzc2FnZTogZnVuY3Rpb24gKG1lc3NhZ2UpIHsKICAgICAgICAgICAgICAgIHZhciAkbWVzc2FnZSA9ICQobWVzc2FnZSk7CiAgICAgICAgICAgICAgICB2YXIgYnVkZHlfamlkLCAkZm9yd2FyZGVkLCAkcmVjZWl2ZWQsCiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZV9mcm9tID0gJG1lc3NhZ2UuYXR0cignZnJvbScpOwogICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2VfZnJvbSA9PT0gY29udmVyc2UuY29ubmVjdGlvbi5qaWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBGSVhNRTogRm9yd2FyZGVkIG1lc3NhZ2VzIHNob3VsZCBiZSBzZW50IHRvIHNwZWNpZmljIHJlc291cmNlcywKICAgICAgICAgICAgICAgICAgICAvLyBub3QgYnJvYWRjYXN0ZWQKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICRmb3J3YXJkZWQgPSAkbWVzc2FnZS5jaGlsZHJlbignZm9yd2FyZGVkJyk7CiAgICAgICAgICAgICAgICAkcmVjZWl2ZWQgPSAkbWVzc2FnZS5jaGlsZHJlbigncmVjZWl2ZWRbeG1sbnM9InVybjp4bXBwOmNhcmJvbnM6MiJdJyk7CiAgICAgICAgICAgICAgICBpZiAoJGZvcndhcmRlZC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAkbWVzc2FnZSA9ICRmb3J3YXJkZWQuY2hpbGRyZW4oJ21lc3NhZ2UnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoJHJlY2VpdmVkLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICRtZXNzYWdlID0gJHJlY2VpdmVkLmNoaWxkcmVuKCdmb3J3YXJkZWQnKS5jaGlsZHJlbignbWVzc2FnZScpOwogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2VfZnJvbSA9ICRtZXNzYWdlLmF0dHIoJ2Zyb20nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBmcm9tID0gU3Ryb3BoZS5nZXRCYXJlSmlkRnJvbUppZChtZXNzYWdlX2Zyb20pLAogICAgICAgICAgICAgICAgICAgIHRvID0gU3Ryb3BoZS5nZXRCYXJlSmlkRnJvbUppZCgkbWVzc2FnZS5hdHRyKCd0bycpKSwKICAgICAgICAgICAgICAgICAgICByZXNvdXJjZSwgY2hhdGJveCwgcm9zdGVyX2l0ZW07CiAgICAgICAgICAgICAgICBpZiAoZnJvbSA9PSBjb252ZXJzZS5iYXJlX2ppZCkgewogICAgICAgICAgICAgICAgICAgIC8vIEkgYW0gdGhlIHNlbmRlciwgc28gdGhpcyBtdXN0IGJlIGEgZm9yd2FyZGVkIG1lc3NhZ2UuLi4KICAgICAgICAgICAgICAgICAgICBidWRkeV9qaWQgPSB0bzsKICAgICAgICAgICAgICAgICAgICByZXNvdXJjZSA9IFN0cm9waGUuZ2V0UmVzb3VyY2VGcm9tSmlkKCRtZXNzYWdlLmF0dHIoJ3RvJykpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBidWRkeV9qaWQgPSBmcm9tOwogICAgICAgICAgICAgICAgICAgIHJlc291cmNlID0gU3Ryb3BoZS5nZXRSZXNvdXJjZUZyb21KaWQobWVzc2FnZV9mcm9tKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoYXRib3ggPSB0aGlzLmdldChidWRkeV9qaWQpOwogICAgICAgICAgICAgICAgcm9zdGVyX2l0ZW0gPSBjb252ZXJzZS5yb3N0ZXIuZ2V0KGJ1ZGR5X2ppZCk7CgogICAgICAgICAgICAgICAgaWYgKHJvc3Rlcl9pdGVtID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBUaGUgYnVkZHkgd2FzIGxpa2VseSByZW1vdmVkCiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UubG9nKCdDb3VsZCBub3QgZ2V0IHJvc3RlciBpdGVtIGZvciBKSUQgJytidWRkeV9qaWQsICdlcnJvcicpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghY2hhdGJveCkgewogICAgICAgICAgICAgICAgICAgIHZhciBmdWxsbmFtZSA9IHJvc3Rlcl9pdGVtLmdldCgnZnVsbG5hbWUnKTsKICAgICAgICAgICAgICAgICAgICBmdWxsbmFtZSA9IF8uaXNFbXB0eShmdWxsbmFtZSk/IGJ1ZGR5X2ppZDogZnVsbG5hbWU7CiAgICAgICAgICAgICAgICAgICAgY2hhdGJveCA9IHRoaXMuY3JlYXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2lkJzogYnVkZHlfamlkLAogICAgICAgICAgICAgICAgICAgICAgICAnamlkJzogYnVkZHlfamlkLAogICAgICAgICAgICAgICAgICAgICAgICAnZnVsbG5hbWUnOiBmdWxsbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2ltYWdlX3R5cGUnOiByb3N0ZXJfaXRlbS5nZXQoJ2ltYWdlX3R5cGUnKSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2ltYWdlJzogcm9zdGVyX2l0ZW0uZ2V0KCdpbWFnZScpLAogICAgICAgICAgICAgICAgICAgICAgICAndXJsJzogcm9zdGVyX2l0ZW0uZ2V0KCd1cmwnKQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzT25seUNoYXRTdGF0ZU5vdGlmaWNhdGlvbigkbWVzc2FnZSkgJiYgZnJvbSAhPT0gY29udmVyc2UuYmFyZV9qaWQpIHsKICAgICAgICAgICAgICAgICAgICBwbGF5Tm90aWZpY2F0aW9uKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjaGF0Ym94LnJlY2VpdmVNZXNzYWdlKCRtZXNzYWdlKTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJvc3Rlci5hZGRSZXNvdXJjZShidWRkeV9qaWQsIHJlc291cmNlKTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLmVtaXQoJ21lc3NhZ2UnLCBtZXNzYWdlKTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuQ2hhdEJveFZpZXdzID0gQmFja2JvbmUuT3ZlcnZpZXcuZXh0ZW5kKHsKCiAgICAgICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oImFkZCIsIHRoaXMub25DaGF0Qm94QWRkZWQsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbigiY2hhbmdlOm1pbmltaXplZCIsIGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uZ2V0KCdtaW5pbWl6ZWQnKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudHJpbUNoYXRzKHRoaXMuZ2V0KGl0ZW0uZ2V0KCdpZCcpKSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudHJpbUNoYXRzKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBfZW5zdXJlRWxlbWVudDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgLyogT3ZlcnJpZGUgbWV0aG9kIGZyb20gYmFja2JvbmUuanMKICAgICAgICAgICAgICAgICAqIElmIHRoZSAjY29udmVyc2VqcyBlbGVtZW50IGRvZXNuJ3QgZXhpc3QsIGNyZWF0ZSBpdC4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmVsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyICRlbCA9ICQoJyNjb252ZXJzZWpzJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCEkZWwubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRlbCA9ICQoJzxkaXYgaWQ9ImNvbnZlcnNlanMiPicpOwogICAgICAgICAgICAgICAgICAgICAgICAkKCdib2R5JykuYXBwZW5kKCRlbCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICRlbC5odG1sKGNvbnZlcnNlLnRlbXBsYXRlcy5jaGF0c19wYW5lbCgpKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEVsZW1lbnQoJGVsLCBmYWxzZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RWxlbWVudChfLnJlc3VsdCh0aGlzLCAnZWwnKSwgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25DaGF0Qm94QWRkZWQ6IGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgICAgICAgICAgICB2YXIgdmlldyA9IHRoaXMuZ2V0KGl0ZW0uZ2V0KCdpZCcpKTsKICAgICAgICAgICAgICAgIGlmICghdmlldykgewogICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmdldCgnY2hhdHJvb20nKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2aWV3ID0gbmV3IGNvbnZlcnNlLkNoYXRSb29tVmlldyh7J21vZGVsJzogaXRlbX0pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXRlbS5nZXQoJ2JveF9pZCcpID09PSAnY29udHJvbGJveCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmlldyA9IG5ldyBjb252ZXJzZS5Db250cm9sQm94Vmlldyh7bW9kZWw6IGl0ZW19KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2aWV3ID0gbmV3IGNvbnZlcnNlLkNoYXRCb3hWaWV3KHttb2RlbDogaXRlbX0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZChpdGVtLmdldCgnaWQnKSwgdmlldyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB2aWV3Lm1vZGVsOyAvLyBSZW1vdmUgcmVmIHRvIG9sZCBtb2RlbCB0byBoZWxwIGdhcmJhZ2UgY29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgIHZpZXcubW9kZWwgPSBpdGVtOwogICAgICAgICAgICAgICAgICAgIHZpZXcuaW5pdGlhbGl6ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy50cmltQ2hhdHModmlldyk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB0cmltQ2hhdHM6IGZ1bmN0aW9uIChuZXdjaGF0KSB7CiAgICAgICAgICAgICAgICAvKiBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgd2hlbiBhIG5ld2x5IGNyZWF0ZWQgY2hhdCBib3ggd2lsbAogICAgICAgICAgICAgICAgICogYmUgc2hvd24uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogSXQgY2hlY2tzIHdoZXRoZXIgdGhlcmUgaXMgZW5vdWdoIHNwYWNlIG9uIHRoZSBwYWdlIHRvIHNob3cKICAgICAgICAgICAgICAgICAqIGFub3RoZXIgY2hhdCBib3guIE90aGVyd2lzZSBpdCBtaW5pbWl6ZSB0aGUgb2xkZXN0IGNoYXQgYm94CiAgICAgICAgICAgICAgICAgKiB0byBjcmVhdGUgc3BhY2UuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGlmIChjb252ZXJzZS5ub190cmltbWluZyB8fCAodGhpcy5tb2RlbC5sZW5ndGggPD0gMSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgb2xkZXN0X2NoYXQsCiAgICAgICAgICAgICAgICAgICAgY29udHJvbGJveF93aWR0aCA9IDAsCiAgICAgICAgICAgICAgICAgICAgJG1pbmltaXplZCA9IGNvbnZlcnNlLm1pbmltaXplZF9jaGF0cy4kZWwsCiAgICAgICAgICAgICAgICAgICAgbWluaW1pemVkX3dpZHRoID0gXy5jb250YWlucyh0aGlzLm1vZGVsLnBsdWNrKCdtaW5pbWl6ZWQnKSwgdHJ1ZSkgPyAkbWluaW1pemVkLm91dGVyV2lkdGgodHJ1ZSkgOiAwLAogICAgICAgICAgICAgICAgICAgIGJveGVzX3dpZHRoID0gbmV3Y2hhdCA/IG5ld2NoYXQuJGVsLm91dGVyV2lkdGgodHJ1ZSkgOiAwLAogICAgICAgICAgICAgICAgICAgIG5ld19pZCA9IG5ld2NoYXQgPyBuZXdjaGF0Lm1vZGVsLmdldCgnaWQnKSA6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgY29udHJvbGJveCA9IHRoaXMuZ2V0KCdjb250cm9sYm94Jyk7CgogICAgICAgICAgICAgICAgaWYgKCFjb250cm9sYm94IHx8ICFjb250cm9sYm94LiRlbC5pcygnOnZpc2libGUnKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnRyb2xib3hfd2lkdGggPSBjb252ZXJzZS5jb250cm9sYm94dG9nZ2xlLiRlbC5vdXRlcldpZHRoKHRydWUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb250cm9sYm94X3dpZHRoID0gY29udHJvbGJveC4kZWwub3V0ZXJXaWR0aCh0cnVlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBfLmVhY2godGhpcy5nZXRBbGwoKSwgZnVuY3Rpb24gKHZpZXcpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaWQgPSB2aWV3Lm1vZGVsLmdldCgnaWQnKTsKICAgICAgICAgICAgICAgICAgICBpZiAoKGlkICE9PSAnY29udHJvbGJveCcpICYmIChpZCAhPT0gbmV3X2lkKSAmJiAoIXZpZXcubW9kZWwuZ2V0KCdtaW5pbWl6ZWQnKSkgJiYgdmlldy4kZWwuaXMoJzp2aXNpYmxlJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYm94ZXNfd2lkdGggKz0gdmlldy4kZWwub3V0ZXJXaWR0aCh0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBpZiAoKG1pbmltaXplZF93aWR0aCArIGJveGVzX3dpZHRoICsgY29udHJvbGJveF93aWR0aCkgPiB0aGlzLiRlbC5vdXRlcldpZHRoKHRydWUpKSB7CiAgICAgICAgICAgICAgICAgICAgb2xkZXN0X2NoYXQgPSB0aGlzLmdldE9sZGVzdE1heGltaXplZENoYXQoKTsKICAgICAgICAgICAgICAgICAgICBpZiAob2xkZXN0X2NoYXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb2xkZXN0X2NoYXQubWluaW1pemUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBnZXRPbGRlc3RNYXhpbWl6ZWRDaGF0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAvLyBHZXQgb2xkZXN0IHZpZXcgKHdoaWNoIGlzIG5vdCBjb250cm9sYm94KQogICAgICAgICAgICAgICAgdmFyIGkgPSAwOwogICAgICAgICAgICAgICAgdmFyIG1vZGVsID0gdGhpcy5tb2RlbC5zb3J0KCkuYXQoaSk7CiAgICAgICAgICAgICAgICB3aGlsZSAobW9kZWwuZ2V0KCdpZCcpID09PSAnY29udHJvbGJveCcgfHwgbW9kZWwuZ2V0KCdtaW5pbWl6ZWQnKSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgICAgICAgICBtb2RlbCA9IHRoaXMubW9kZWwuYXQoaSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFtb2RlbCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbW9kZWw7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBjbG9zZUFsbENoYXRCb3hlczogZnVuY3Rpb24gKGluY2x1ZGVfY29udHJvbGJveCkgewogICAgICAgICAgICAgICAgdmFyIGksIGNoYXRib3g7CiAgICAgICAgICAgICAgICAvLyBUT0RPOiBvbmNlIEJhY2tib25lLk92ZXJ2aWV3IGhhcyBiZWVuIHJlZmFjdG9yZWQsIHdlIHNob3VsZAogICAgICAgICAgICAgICAgLy8gYmUgYWJsZSB0byBjYWxsIC5lYWNoIG9uIHRoZSB2aWV3cyB0aGVtc2VsdmVzLgogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5lYWNoKCQucHJveHkoZnVuY3Rpb24gKG1vZGVsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGlkID0gbW9kZWwuZ2V0KCdpZCcpOwogICAgICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlX2NvbnRyb2xib3ggfHwgaWQgIT09ICdjb250cm9sYm94JykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdldChpZCkuY2xvc2UoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCB0aGlzKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHNob3dDaGF0OiBmdW5jdGlvbiAoYXR0cnMpIHsKICAgICAgICAgICAgICAgIC8qIEZpbmQgdGhlIGNoYXQgYm94IGFuZCBzaG93IGl0LgogICAgICAgICAgICAgICAgICogSWYgaXQgZG9lc24ndCBleGlzdCwgY3JlYXRlIGl0LgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICB2YXIgY2hhdGJveCAgPSB0aGlzLm1vZGVsLmdldChhdHRycy5qaWQpOwogICAgICAgICAgICAgICAgaWYgKCFjaGF0Ym94KSB7CiAgICAgICAgICAgICAgICAgICAgY2hhdGJveCA9IHRoaXMubW9kZWwuY3JlYXRlKGF0dHJzLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICdlcnJvcic6IGZ1bmN0aW9uIChtb2RlbCwgcmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmxvZyhyZXNwb25zZS5yZXNwb25zZVRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY2hhdGJveC5nZXQoJ21pbmltaXplZCcpKSB7CiAgICAgICAgICAgICAgICAgICAgY2hhdGJveC5tYXhpbWl6ZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjaGF0Ym94LnRyaWdnZXIoJ3Nob3cnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBjaGF0Ym94OwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuTWluaW1pemVkQ2hhdEJveFZpZXcgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZCh7CiAgICAgICAgICAgIHRhZ05hbWU6ICdkaXYnLAogICAgICAgICAgICBjbGFzc05hbWU6ICdjaGF0LWhlYWQnLAoKICAgICAgICAgICAgZXZlbnRzOiB7CiAgICAgICAgICAgICAgICAnY2xpY2sgLmNsb3NlLWNoYXRib3gtYnV0dG9uJzogJ2Nsb3NlJywKICAgICAgICAgICAgICAgICdjbGljayAucmVzdG9yZS1jaGF0JzogJ3Jlc3RvcmUnCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm1lc3NhZ2VzLm9uKCdhZGQnLCBmdW5jdGlvbiAobSkgewogICAgICAgICAgICAgICAgICAgIGlmICghKG0uZ2V0KCdjb21wb3NpbmcnKSB8fCBtLmdldCgncGF1c2VkJykpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlVW5yZWFkTWVzc2FnZXNDb3VudGVyKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCdjaGFuZ2U6bWluaW1pemVkJywgdGhpcy5jbGVhclVucmVhZE1lc3NhZ2VzQ291bnRlciwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCdzaG93UmVjZWl2ZWRPVFJNZXNzYWdlJywgdGhpcy51cGRhdGVVbnJlYWRNZXNzYWdlc0NvdW50ZXIsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbignc2hvd1NlbnRPVFJNZXNzYWdlJywgdGhpcy51cGRhdGVVbnJlYWRNZXNzYWdlc0NvdW50ZXIsIHRoaXMpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IF8uZXh0ZW5kKAogICAgICAgICAgICAgICAgICAgIHRoaXMubW9kZWwudG9KU09OKCksCiAgICAgICAgICAgICAgICAgICAgeyAndG9vbHRpcCc6IF9fKCdDbGljayB0byByZXN0b3JlIHRoaXMgY2hhdCcpIH0KICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5tb2RlbC5nZXQoJ2NoYXRyb29tJykpIHsKICAgICAgICAgICAgICAgICAgICBkYXRhLnRpdGxlID0gdGhpcy5tb2RlbC5nZXQoJ25hbWUnKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5hZGRDbGFzcygnY2hhdC1oZWFkLWNoYXRyb29tJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGRhdGEudGl0bGUgPSB0aGlzLm1vZGVsLmdldCgnZnVsbG5hbWUnKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5hZGRDbGFzcygnY2hhdC1oZWFkLWNoYXRib3gnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiRlbC5odG1sKGNvbnZlcnNlLnRlbXBsYXRlcy50cmltbWVkX2NoYXQoZGF0YSkpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgY2xlYXJVbnJlYWRNZXNzYWdlc0NvdW50ZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuc2V0KHsnbnVtX3VucmVhZCc6IDB9KTsKICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB1cGRhdGVVbnJlYWRNZXNzYWdlc0NvdW50ZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuc2V0KHsnbnVtX3VucmVhZCc6IHRoaXMubW9kZWwuZ2V0KCdudW1fdW5yZWFkJykgKyAxfSk7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcigpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgY2xvc2U6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgaWYgKGV2ICYmIGV2LnByZXZlbnREZWZhdWx0KSB7IGV2LnByZXZlbnREZWZhdWx0KCk7IH0KICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLmVtaXQoJ2NoYXRCb3hDbG9zZWQnLCB0aGlzKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVzdG9yZTogXy5kZWJvdW5jZShmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGlmIChldiAmJiBldi5wcmV2ZW50RGVmYXVsdCkgewogICAgICAgICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5tYXhpbWl6ZSgpOwogICAgICAgICAgICB9LCAyMDApCiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuTWluaW1pemVkQ2hhdHMgPSBCYWNrYm9uZS5PdmVydmlldy5leHRlbmQoewogICAgICAgICAgICBlbDogIiNtaW5pbWl6ZWQtY2hhdHMiLAoKICAgICAgICAgICAgZXZlbnRzOiB7CiAgICAgICAgICAgICAgICAiY2xpY2sgI3RvZ2dsZS1taW5pbWl6ZWQtY2hhdHMiOiAidG9nZ2xlIgogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy5pbml0VG9nZ2xlKCk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCJhZGQiLCB0aGlzLm9uQ2hhbmdlZCwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCJkZXN0cm95IiwgdGhpcy5yZW1vdmVDaGF0LCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oImNoYW5nZTptaW5pbWl6ZWQiLCB0aGlzLm9uQ2hhbmdlZCwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCdjaGFuZ2U6bnVtX3VucmVhZCcsIHRoaXMudXBkYXRlVW5yZWFkTWVzc2FnZXNDb3VudGVyLCB0aGlzKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHRlYXJEb3duOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9mZigiYWRkIiwgdGhpcy5vbkNoYW5nZWQpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vZmYoImRlc3Ryb3kiLCB0aGlzLnJlbW92ZUNoYXQpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vZmYoImNoYW5nZTptaW5pbWl6ZWQiLCB0aGlzLm9uQ2hhbmdlZCk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9mZignY2hhbmdlOm51bV91bnJlYWQnLCB0aGlzLnVwZGF0ZVVucmVhZE1lc3NhZ2VzQ291bnRlcik7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGluaXRUb2dnbGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMudG9nZ2xldmlldyA9IG5ldyBjb252ZXJzZS5NaW5pbWl6ZWRDaGF0c1RvZ2dsZVZpZXcoewogICAgICAgICAgICAgICAgICAgIG1vZGVsOiBuZXcgY29udmVyc2UuTWluaW1pemVkQ2hhdHNUb2dnbGUoKQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB2YXIgaWQgPSBiNjRfc2hhMSgnY29udmVyc2UubWluY2hhdHN0b2dnbGUnK2NvbnZlcnNlLmJhcmVfamlkKTsKICAgICAgICAgICAgICAgIHRoaXMudG9nZ2xldmlldy5tb2RlbC5pZCA9IGlkOyAvLyBBcHBlYXJzIHRvIGJlIG5lY2Vzc2FyeSBmb3IgYmFja2JvbmUuYnJvd3NlclN0b3JhZ2UKICAgICAgICAgICAgICAgIHRoaXMudG9nZ2xldmlldy5tb2RlbC5icm93c2VyU3RvcmFnZSA9IG5ldyBCYWNrYm9uZS5Ccm93c2VyU3RvcmFnZVtjb252ZXJzZS5zdG9yYWdlXShpZCk7CiAgICAgICAgICAgICAgICB0aGlzLnRvZ2dsZXZpZXcubW9kZWwuZmV0Y2goKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMua2V5cygpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLmhpZGUoJ2Zhc3QnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5rZXlzKCkubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuc2hvdygnZmFzdCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJGVsOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgdG9nZ2xlOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGlmIChldiAmJiBldi5wcmV2ZW50RGVmYXVsdCkgeyBldi5wcmV2ZW50RGVmYXVsdCgpOyB9CiAgICAgICAgICAgICAgICB0aGlzLnRvZ2dsZXZpZXcubW9kZWwuc2F2ZSh7J2NvbGxhcHNlZCc6ICF0aGlzLnRvZ2dsZXZpZXcubW9kZWwuZ2V0KCdjb2xsYXBzZWQnKX0pOwogICAgICAgICAgICAgICAgdGhpcy4kKCcubWluaW1pemVkLWNoYXRzLWZseW91dCcpLnRvZ2dsZSgpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25DaGFuZ2VkOiBmdW5jdGlvbiAoaXRlbSkgewogICAgICAgICAgICAgICAgaWYgKGl0ZW0uZ2V0KCdpZCcpICE9PSAnY29udHJvbGJveCcgJiYgaXRlbS5nZXQoJ21pbmltaXplZCcpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRDaGF0KGl0ZW0pOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmdldChpdGVtLmdldCgnaWQnKSkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUNoYXQoaXRlbSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBhZGRDaGF0OiBmdW5jdGlvbiAoaXRlbSkgewogICAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdGhpcy5nZXQoaXRlbS5nZXQoJ2lkJykpOwogICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nICYmIGV4aXN0aW5nLiRlbC5wYXJlbnQoKS5sZW5ndGggIT09IDApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgdmlldyA9IG5ldyBjb252ZXJzZS5NaW5pbWl6ZWRDaGF0Qm94Vmlldyh7bW9kZWw6IGl0ZW19KTsKICAgICAgICAgICAgICAgIHRoaXMuJCgnLm1pbmltaXplZC1jaGF0cy1mbHlvdXQnKS5hcHBlbmQodmlldy5yZW5kZXIoKSk7CiAgICAgICAgICAgICAgICB0aGlzLmFkZChpdGVtLmdldCgnaWQnKSwgdmlldyk7CiAgICAgICAgICAgICAgICB0aGlzLnRvZ2dsZXZpZXcubW9kZWwuc2V0KHsnbnVtX21pbmltaXplZCc6IHRoaXMua2V5cygpLmxlbmd0aH0pOwogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlbW92ZUNoYXQ6IGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZShpdGVtLmdldCgnaWQnKSk7CiAgICAgICAgICAgICAgICB0aGlzLnRvZ2dsZXZpZXcubW9kZWwuc2V0KHsnbnVtX21pbmltaXplZCc6IHRoaXMua2V5cygpLmxlbmd0aH0pOwogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHVwZGF0ZVVucmVhZE1lc3NhZ2VzQ291bnRlcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGxzID0gdGhpcy5tb2RlbC5wbHVjaygnbnVtX3VucmVhZCcpLAogICAgICAgICAgICAgICAgICAgIGNvdW50ID0gMCwgaTsKICAgICAgICAgICAgICAgIGZvciAoaT0wOyBpPGxzLmxlbmd0aDsgaSsrKSB7IGNvdW50ICs9IGxzW2ldOyB9CiAgICAgICAgICAgICAgICB0aGlzLnRvZ2dsZXZpZXcubW9kZWwuc2V0KHsnbnVtX3VucmVhZCc6IGNvdW50fSk7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcigpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuTWluaW1pemVkQ2hhdHNUb2dnbGUgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQoewogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldCh7CiAgICAgICAgICAgICAgICAgICAgJ2NvbGxhcHNlZCc6IHRoaXMuZ2V0KCdjb2xsYXBzZWQnKSB8fCBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAnbnVtX21pbmltaXplZCc6IHRoaXMuZ2V0KCdudW1fbWluaW1pemVkJykgfHwgMCwKICAgICAgICAgICAgICAgICAgICAnbnVtX3VucmVhZCc6ICB0aGlzLmdldCgnbnVtX3VucmVhZCcpIHx8IDAKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuTWluaW1pemVkQ2hhdHNUb2dnbGVWaWV3ID0gQmFja2JvbmUuVmlldy5leHRlbmQoewogICAgICAgICAgICBlbDogJyN0b2dnbGUtbWluaW1pemVkLWNoYXRzJywKCiAgICAgICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oJ2NoYW5nZTpudW1fbWluaW1pemVkJywgdGhpcy5yZW5kZXIsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbignY2hhbmdlOm51bV91bnJlYWQnLCB0aGlzLnJlbmRlciwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLiRmbHlvdXQgPSB0aGlzLiRlbC5zaWJsaW5ncygnLm1pbmltaXplZC1jaGF0cy1mbHlvdXQnKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy4kZWwuaHRtbChjb252ZXJzZS50ZW1wbGF0ZXMudG9nZ2xlX2NoYXRzKAogICAgICAgICAgICAgICAgICAgIF8uZXh0ZW5kKHRoaXMubW9kZWwudG9KU09OKCksIHsKICAgICAgICAgICAgICAgICAgICAgICAgJ01pbmltaXplZCc6IF9fKCdNaW5pbWl6ZWQnKQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1vZGVsLmdldCgnY29sbGFwc2VkJykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRmbHlvdXQuaGlkZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRmbHlvdXQuc2hvdygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJGVsOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuUm9zdGVyQ29udGFjdCA9IEJhY2tib25lLk1vZGVsLmV4dGVuZCh7CiAgICAgICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uIChhdHRyaWJ1dGVzLCBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICB2YXIgamlkID0gYXR0cmlidXRlcy5qaWQ7CiAgICAgICAgICAgICAgICB2YXIgYXR0cnMgPSBfLmV4dGVuZCh7CiAgICAgICAgICAgICAgICAgICAgJ2lkJzogamlkLAogICAgICAgICAgICAgICAgICAgICdmdWxsbmFtZSc6IGppZCwKICAgICAgICAgICAgICAgICAgICAnY2hhdF9zdGF0dXMnOiAnb2ZmbGluZScsCiAgICAgICAgICAgICAgICAgICAgJ3VzZXJfaWQnOiBTdHJvcGhlLmdldE5vZGVGcm9tSmlkKGppZCksCiAgICAgICAgICAgICAgICAgICAgJ3Jlc291cmNlcyc6IFtdLAogICAgICAgICAgICAgICAgICAgICdncm91cHMnOiBbXSwKICAgICAgICAgICAgICAgICAgICAnc3RhdHVzJzogJycKICAgICAgICAgICAgICAgIH0sIGF0dHJpYnV0ZXMpOwogICAgICAgICAgICAgICAgdGhpcy5zZXQoYXR0cnMpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2hvd0luUm9zdGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gKCFjb252ZXJzZS5zaG93X29ubHlfb25saW5lX3VzZXJzIHx8IHRoaXMuZ2V0KCdjaGF0X3N0YXR1cycpID09PSAnb25saW5lJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5Sb3N0ZXJDb250YWN0VmlldyA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKICAgICAgICAgICAgdGFnTmFtZTogJ2RkJywKCiAgICAgICAgICAgIGV2ZW50czogewogICAgICAgICAgICAgICAgImNsaWNrIC5hY2NlcHQteG1wcC1yZXF1ZXN0IjogImFjY2VwdFJlcXVlc3QiLAogICAgICAgICAgICAgICAgImNsaWNrIC5kZWNsaW5lLXhtcHAtcmVxdWVzdCI6ICJkZWNsaW5lUmVxdWVzdCIsCiAgICAgICAgICAgICAgICAiY2xpY2sgLm9wZW4tY2hhdCI6ICJvcGVuQ2hhdCIsCiAgICAgICAgICAgICAgICAiY2xpY2sgLnJlbW92ZS14bXBwLWNvbnRhY3QiOiAicmVtb3ZlQ29udGFjdCIKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oImNoYW5nZSIsIHRoaXMucmVuZGVyLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oInJlbW92ZSIsIHRoaXMucmVtb3ZlLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oImRlc3Ryb3kiLCB0aGlzLnJlbW92ZSwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCJvcGVuIiwgdGhpcy5vcGVuQ2hhdCwgdGhpcyk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBvcGVuQ2hhdDogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBpZiAoZXYgJiYgZXYucHJldmVudERlZmF1bHQpIHsgZXYucHJldmVudERlZmF1bHQoKTsgfQogICAgICAgICAgICAgICAgLy8gWFhYOiBDYW4gdGhpcy5tb2RlbC5hdHRyaWJ1dGVzIGJlIHVzZWQgaGVyZSwgaW5zdGVhZCBvZgogICAgICAgICAgICAgICAgLy8gbWFudWFsbHkgc3BlY2lmeWluZyBhbGwgYXR0cmlidXRlcz8KICAgICAgICAgICAgICAgIHJldHVybiBjb252ZXJzZS5jaGF0Ym94dmlld3Muc2hvd0NoYXQoewogICAgICAgICAgICAgICAgICAgICdpZCc6IHRoaXMubW9kZWwuZ2V0KCdqaWQnKSwKICAgICAgICAgICAgICAgICAgICAnamlkJzogdGhpcy5tb2RlbC5nZXQoJ2ppZCcpLAogICAgICAgICAgICAgICAgICAgICdmdWxsbmFtZSc6IHRoaXMubW9kZWwuZ2V0KCdmdWxsbmFtZScpLAogICAgICAgICAgICAgICAgICAgICdpbWFnZV90eXBlJzogdGhpcy5tb2RlbC5nZXQoJ2ltYWdlX3R5cGUnKSwKICAgICAgICAgICAgICAgICAgICAnaW1hZ2UnOiB0aGlzLm1vZGVsLmdldCgnaW1hZ2UnKSwKICAgICAgICAgICAgICAgICAgICAndXJsJzogdGhpcy5tb2RlbC5nZXQoJ3VybCcpLAogICAgICAgICAgICAgICAgICAgICdzdGF0dXMnOiB0aGlzLm1vZGVsLmdldCgnc3RhdHVzJykKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVtb3ZlQ29udGFjdDogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBpZiAoZXYgJiYgZXYucHJldmVudERlZmF1bHQpIHsgZXYucHJldmVudERlZmF1bHQoKTsgfQogICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGNvbmZpcm0oX18oIkFyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byByZW1vdmUgdGhpcyBjb250YWN0PyIpKTsKICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYmFyZV9qaWQgPSB0aGlzLm1vZGVsLmdldCgnamlkJyk7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5yb3N0ZXIucmVtb3ZlKGJhcmVfamlkLCAkLnByb3h5KGZ1bmN0aW9uIChpcSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLnJvc3Rlci51bmF1dGhvcml6ZShiYXJlX2ppZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJvc3RlcnZpZXcubW9kZWwucmVtb3ZlKGJhcmVfamlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgYWNjZXB0UmVxdWVzdDogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBpZiAoZXYgJiYgZXYucHJldmVudERlZmF1bHQpIHsgZXYucHJldmVudERlZmF1bHQoKTsgfQogICAgICAgICAgICAgICAgdmFyIGppZCA9IHRoaXMubW9kZWwuZ2V0KCdqaWQnKTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24ucm9zdGVyLmF1dGhvcml6ZShqaWQpOwogICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5yb3N0ZXIuYWRkKGppZCwgdGhpcy5tb2RlbC5nZXQoJ2Z1bGxuYW1lJyksIFtdLCBmdW5jdGlvbiAoaXEpIHsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLnJvc3Rlci5zdWJzY3JpYmUoamlkLCBudWxsLCBjb252ZXJzZS54bXBwc3RhdHVzLmdldCgnZnVsbG5hbWUnKSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGRlY2xpbmVSZXF1ZXN0OiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGlmIChldiAmJiBldi5wcmV2ZW50RGVmYXVsdCkgeyBldi5wcmV2ZW50RGVmYXVsdCgpOyB9CiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gY29uZmlybShfXygiQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIGRlY2xpbmUgdGhpcyBjb250YWN0IHJlcXVlc3Q/IikpOwogICAgICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24ucm9zdGVyLnVuYXV0aG9yaXplKHRoaXMubW9kZWwuZ2V0KCdqaWQnKSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLm1vZGVsLnNob3dJblJvc3RlcigpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLiRlbFswXS5zdHlsZS5kaXNwbGF5ID09PSAibm9uZSIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5zaG93KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgaXRlbSA9IHRoaXMubW9kZWwsCiAgICAgICAgICAgICAgICAgICAgYXNrID0gaXRlbS5nZXQoJ2FzaycpLAogICAgICAgICAgICAgICAgICAgIGNoYXRfc3RhdHVzID0gaXRlbS5nZXQoJ2NoYXRfc3RhdHVzJyksCiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdGluZyAgPSBpdGVtLmdldCgncmVxdWVzdGluZycpLAogICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbiA9IGl0ZW0uZ2V0KCdzdWJzY3JpcHRpb24nKTsKCiAgICAgICAgICAgICAgICB2YXIgY2xhc3Nlc190b19yZW1vdmUgPSBbCiAgICAgICAgICAgICAgICAgICAgJ2N1cnJlbnQteG1wcC1jb250YWN0JywKICAgICAgICAgICAgICAgICAgICAncGVuZGluZy14bXBwLWNvbnRhY3QnLAogICAgICAgICAgICAgICAgICAgICdyZXF1ZXN0aW5nLXhtcHAtY29udGFjdCcKICAgICAgICAgICAgICAgICAgICBdLmNvbmNhdChfLmtleXMoU1RBVFVTRVMpKTsKCiAgICAgICAgICAgICAgICBfLmVhY2goY2xhc3Nlc190b19yZW1vdmUsCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGNscykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5lbC5jbGFzc05hbWUuaW5kZXhPZihjbHMpICE9PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwucmVtb3ZlQ2xhc3MoY2xzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy4kZWwuYWRkQ2xhc3MoY2hhdF9zdGF0dXMpLmRhdGEoJ3N0YXR1cycsIGNoYXRfc3RhdHVzKTsKCiAgICAgICAgICAgICAgICBpZiAoKGFzayA9PT0gJ3N1YnNjcmliZScpIHx8IChzdWJzY3JpcHRpb24gPT09ICdmcm9tJykpIHsKICAgICAgICAgICAgICAgICAgICAvKiBhc2sgPT09ICdzdWJzY3JpYmUnCiAgICAgICAgICAgICAgICAgICAgICogICAgICBNZWFucyB3ZSBoYXZlIGFza2VkIHRvIHN1YnNjcmliZSB0byB0aGVtLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogc3Vic2NyaXB0aW9uID09PSAnZnJvbScKICAgICAgICAgICAgICAgICAgICAgKiAgICAgIFRoZXkgYXJlIHN1YnNjcmliZWQgdG8gdXNlLCBidXQgbm90IHZpY2UgdmVyc2EuCiAgICAgICAgICAgICAgICAgICAgICogICAgICBXZSBhc3N1bWUgdGhhdCB0aGVyZSBpcyBhIHBlbmRpbmcgc3Vic2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogICAgICBmcm9tIHVzIHRvIHRoZW0gKG90aGVyd2lzZSB3ZSdyZSBpbiBhIHN0YXRlIG5vdAogICAgICAgICAgICAgICAgICAgICAqICAgICAgc3VwcG9ydGVkIGJ5IGNvbnZlcnNlLmpzKS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICBTbyBpbiBib3RoIGNhc2VzIHRoZSB1c2VyIGlzIGEgInBlbmRpbmciIGNvbnRhY3QuCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuYWRkQ2xhc3MoJ3BlbmRpbmcteG1wcC1jb250YWN0Jyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuaHRtbChjb252ZXJzZS50ZW1wbGF0ZXMucGVuZGluZ19jb250YWN0KAogICAgICAgICAgICAgICAgICAgICAgICBfLmV4dGVuZChpdGVtLnRvSlNPTigpLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGVzY19yZW1vdmUnOiBfXygnQ2xpY2sgdG8gcmVtb3ZlIHRoaXMgY29udGFjdCcpCiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJlcXVlc3RpbmcgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5hZGRDbGFzcygncmVxdWVzdGluZy14bXBwLWNvbnRhY3QnKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5odG1sKGNvbnZlcnNlLnRlbXBsYXRlcy5yZXF1ZXN0aW5nX2NvbnRhY3QoCiAgICAgICAgICAgICAgICAgICAgICAgIF8uZXh0ZW5kKGl0ZW0udG9KU09OKCksIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkZXNjX2FjY2VwdCc6IF9fKCJDbGljayB0byBhY2NlcHQgdGhpcyBjb250YWN0IHJlcXVlc3QiKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkZXNjX2RlY2xpbmUnOiBfXygiQ2xpY2sgdG8gZGVjbGluZSB0aGlzIGNvbnRhY3QgcmVxdWVzdCIpCiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgKSk7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29udHJvbGJveHRvZ2dsZS5zaG93Q29udHJvbEJveCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdWJzY3JpcHRpb24gPT09ICdib3RoJyB8fCBzdWJzY3JpcHRpb24gPT09ICd0bycpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5hZGRDbGFzcygnY3VycmVudC14bXBwLWNvbnRhY3QnKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5odG1sKGNvbnZlcnNlLnRlbXBsYXRlcy5yb3N0ZXJfaXRlbSgKICAgICAgICAgICAgICAgICAgICAgICAgXy5leHRlbmQoaXRlbS50b0pTT04oKSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2Rlc2Nfc3RhdHVzJzogU1RBVFVTRVNbY2hhdF9zdGF0dXN8fCdvZmZsaW5lJ10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGVzY19jaGF0JzogX18oJ0NsaWNrIHRvIGNoYXQgd2l0aCB0aGlzIGNvbnRhY3QnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkZXNjX3JlbW92ZSc6IF9fKCdDbGljayB0byByZW1vdmUgdGhpcyBjb250YWN0JykKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuUm9zdGVyQ29udGFjdHMgPSBCYWNrYm9uZS5Db2xsZWN0aW9uLmV4dGVuZCh7CiAgICAgICAgICAgIG1vZGVsOiBjb252ZXJzZS5Sb3N0ZXJDb250YWN0LAogICAgICAgICAgICBjb21wYXJhdG9yOiBmdW5jdGlvbiAoY29udGFjdDEsIGNvbnRhY3QyKSB7CiAgICAgICAgICAgICAgICB2YXIgbmFtZTEsIG5hbWUyOwogICAgICAgICAgICAgICAgdmFyIHN0YXR1czEgPSBjb250YWN0MS5nZXQoJ2NoYXRfc3RhdHVzJykgfHwgJ29mZmxpbmUnOwogICAgICAgICAgICAgICAgdmFyIHN0YXR1czIgPSBjb250YWN0Mi5nZXQoJ2NoYXRfc3RhdHVzJykgfHwgJ29mZmxpbmUnOwogICAgICAgICAgICAgICAgaWYgKFNUQVRVU19XRUlHSFRTW3N0YXR1czFdID09PSBTVEFUVVNfV0VJR0hUU1tzdGF0dXMyXSkgewogICAgICAgICAgICAgICAgICAgIG5hbWUxID0gY29udGFjdDEuZ2V0KCdmdWxsbmFtZScpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgbmFtZTIgPSBjb250YWN0Mi5nZXQoJ2Z1bGxuYW1lJykudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmFtZTEgPCBuYW1lMiA/IC0xIDogKG5hbWUxID4gbmFtZTI/IDEgOiAwKTsKICAgICAgICAgICAgICAgIH0gZWxzZSAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBTVEFUVVNfV0VJR0hUU1tzdGF0dXMxXSA8IFNUQVRVU19XRUlHSFRTW3N0YXR1czJdID8gLTEgOiAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc3Vic2NyaWJlVG9TdWdnZXN0ZWRJdGVtczogZnVuY3Rpb24gKG1zZykgewogICAgICAgICAgICAgICAgJChtc2cpLmZpbmQoJ2l0ZW0nKS5lYWNoKGZ1bmN0aW9uIChpLCBpdGVtcykgewogICAgICAgICAgICAgICAgICAgIHZhciAkdGhpcyA9ICQodGhpcyksCiAgICAgICAgICAgICAgICAgICAgICAgIGppZCA9ICR0aGlzLmF0dHIoJ2ppZCcpLAogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb24gPSAkdGhpcy5hdHRyKCdhY3Rpb24nKSwKICAgICAgICAgICAgICAgICAgICAgICAgZnVsbG5hbWUgPSAkdGhpcy5hdHRyKCduYW1lJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGlvbiA9PT0gJ2FkZCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5yb3N0ZXIuc3Vic2NyaWJlKGppZCwgbnVsbCwgY29udmVyc2UueG1wcHN0YXR1cy5nZXQoJ2Z1bGxuYW1lJykpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpc1NlbGY6IGZ1bmN0aW9uIChqaWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiAoU3Ryb3BoZS5nZXRCYXJlSmlkRnJvbUppZChqaWQpID09PSBTdHJvcGhlLmdldEJhcmVKaWRGcm9tSmlkKGNvbnZlcnNlLmNvbm5lY3Rpb24uamlkKSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBhZGRSZXNvdXJjZTogZnVuY3Rpb24gKGJhcmVfamlkLCByZXNvdXJjZSkgewogICAgICAgICAgICAgICAgdmFyIGl0ZW0gPSB0aGlzLmdldChiYXJlX2ppZCksCiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VzOwogICAgICAgICAgICAgICAgaWYgKGl0ZW0pIHsKICAgICAgICAgICAgICAgICAgICByZXNvdXJjZXMgPSBpdGVtLmdldCgncmVzb3VyY2VzJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc291cmNlcykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoXy5pbmRleE9mKHJlc291cmNlcywgcmVzb3VyY2UpID09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvdXJjZXMucHVzaChyZXNvdXJjZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtLnNldCh7J3Jlc291cmNlcyc6IHJlc291cmNlc30pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0uc2V0KHsncmVzb3VyY2VzJzogW3Jlc291cmNlXX0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlbW92ZVJlc291cmNlOiBmdW5jdGlvbiAoYmFyZV9qaWQsIHJlc291cmNlKSB7CiAgICAgICAgICAgICAgICB2YXIgaXRlbSA9IHRoaXMuZ2V0KGJhcmVfamlkKSwKICAgICAgICAgICAgICAgICAgICByZXNvdXJjZXMsCiAgICAgICAgICAgICAgICAgICAgaWR4OwogICAgICAgICAgICAgICAgaWYgKGl0ZW0pIHsKICAgICAgICAgICAgICAgICAgICByZXNvdXJjZXMgPSBpdGVtLmdldCgncmVzb3VyY2VzJyk7CiAgICAgICAgICAgICAgICAgICAgaWR4ID0gXy5pbmRleE9mKHJlc291cmNlcywgcmVzb3VyY2UpOwogICAgICAgICAgICAgICAgICAgIGlmIChpZHggIT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc291cmNlcy5zcGxpY2UoaWR4LCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5zZXQoeydyZXNvdXJjZXMnOiByZXNvdXJjZXN9KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc291cmNlcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzdWJzY3JpYmVCYWNrOiBmdW5jdGlvbiAoamlkKSB7CiAgICAgICAgICAgICAgICB2YXIgYmFyZV9qaWQgPSBTdHJvcGhlLmdldEJhcmVKaWRGcm9tSmlkKGppZCk7CiAgICAgICAgICAgICAgICBpZiAoY29udmVyc2UuY29ubmVjdGlvbi5yb3N0ZXIuZmluZEl0ZW0oYmFyZV9qaWQpKSB7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5yb3N0ZXIuYXV0aG9yaXplKGJhcmVfamlkKTsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLnJvc3Rlci5zdWJzY3JpYmUoamlkLCBudWxsLCBjb252ZXJzZS54bXBwc3RhdHVzLmdldCgnZnVsbG5hbWUnKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24ucm9zdGVyLmFkZChqaWQsICcnLCBbXSwgZnVuY3Rpb24gKGlxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24ucm9zdGVyLmF1dGhvcml6ZShiYXJlX2ppZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24ucm9zdGVyLnN1YnNjcmliZShqaWQsIG51bGwsIGNvbnZlcnNlLnhtcHBzdGF0dXMuZ2V0KCdmdWxsbmFtZScpKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHVuc3Vic2NyaWJlOiBmdW5jdGlvbiAoamlkKSB7CiAgICAgICAgICAgICAgICAvKiBVcG9uIHJlY2VpdmluZyB0aGUgcHJlc2VuY2Ugc3RhbnphIG9mIHR5cGUgInVuc3Vic2NyaWJlZCIsCiAgICAgICAgICAgICAgICAqIHRoZSB1c2VyIFNIT1VMRCBhY2tub3dsZWRnZSByZWNlaXB0IG9mIHRoYXQgc3Vic2NyaXB0aW9uIHN0YXRlCiAgICAgICAgICAgICAgICAqIG5vdGlmaWNhdGlvbiBieSBzZW5kaW5nIGEgcHJlc2VuY2Ugc3RhbnphIG9mIHR5cGUgInVuc3Vic2NyaWJlIgogICAgICAgICAgICAgICAgKiB0aGlzIHN0ZXAgbGV0cyB0aGUgdXNlcidzIHNlcnZlciBrbm93IHRoYXQgaXQgTVVTVCBubyBsb25nZXIKICAgICAgICAgICAgICAgICogc2VuZCBub3RpZmljYXRpb24gb2YgdGhlIHN1YnNjcmlwdGlvbiBzdGF0ZSBjaGFuZ2UgdG8gdGhlIHVzZXIuCiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgY29udmVyc2UueG1wcHN0YXR1cy5zZW5kUHJlc2VuY2UoJ3Vuc3Vic2NyaWJlJyk7CiAgICAgICAgICAgICAgICBpZiAoY29udmVyc2UuY29ubmVjdGlvbi5yb3N0ZXIuZmluZEl0ZW0oamlkKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24ucm9zdGVyLnJlbW92ZShqaWQsIGZ1bmN0aW9uIChpcSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5yb3N0ZXJ2aWV3Lm1vZGVsLnJlbW92ZShqaWQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgZ2V0TnVtT25saW5lQ29udGFjdHM6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBjb3VudCA9IDAsCiAgICAgICAgICAgICAgICAgICAgaWdub3JlZCA9IFsnb2ZmbGluZScsICd1bmF2YWlsYWJsZSddLAogICAgICAgICAgICAgICAgICAgIG1vZGVscyA9IHRoaXMubW9kZWxzLAogICAgICAgICAgICAgICAgICAgIG1vZGVsc19sZW5ndGggPSBtb2RlbHMubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgIGk7CiAgICAgICAgICAgICAgICBpZiAoY29udmVyc2Uuc2hvd19vbmx5X29ubGluZV91c2VycykgewogICAgICAgICAgICAgICAgICAgIGlnbm9yZWQgPSBfLnVuaW9uKGlnbm9yZWQsIFsnZG5kJywgJ3hhJywgJ2F3YXknXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKGk9MDsgaTxtb2RlbHNfbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAoXy5pbmRleE9mKGlnbm9yZWQsIG1vZGVsc1tpXS5nZXQoJ2NoYXRfc3RhdHVzJykpID09PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBjb3VudDsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGNsZWFyQ2FjaGU6IGZ1bmN0aW9uIChpdGVtcykgewogICAgICAgICAgICAgICAgLyogVGhlIGxvY2Fsc3RvcmFnZSBjYWNoZSBjb250YWluaW5nIHJvc3RlciBjb250YWN0cyBtaWdodCBjb250YWluCiAgICAgICAgICAgICAgICAqIHNvbWUgY29udGFjdHMgdGhhdCBhcmVuJ3QgYWN0dWFsbHkgaW4gb3VyIHJvc3RlciBhbnltb3JlLiBXZQogICAgICAgICAgICAgICAgKiB0aGVyZWZvcmUgbmVlZCB0byByZW1vdmUgdGhlbSBub3cuCiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgdmFyIGlkLCBpLCBjb250YWN0OwogICAgICAgICAgICAgICAgZm9yIChpPTA7IGkgPCB0aGlzLm1vZGVscy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgICAgIGlkID0gdGhpcy5tb2RlbHNbaV0uZ2V0KCdpZCcpOwogICAgICAgICAgICAgICAgICAgIGlmIChfLmluZGV4T2YoXy5wbHVjayhpdGVtcywgJ2ppZCcpLCBpZCkgPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhY3QgPSB0aGlzLmdldChpZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250YWN0ICYmICFjb250YWN0LmdldCgncmVxdWVzdGluZycpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWN0LmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8vIFRPRE86IHNlZSBpZiB3ZSBjYW4gb25seSB1c2UgMm5kIGl0ZW0gcGFyCiAgICAgICAgICAgIHJvc3RlckhhbmRsZXI6IGZ1bmN0aW9uIChpdGVtcywgaXRlbSkgewogICAgICAgICAgICAgICAgY29udmVyc2UuZW1pdCgncm9zdGVyJywgaXRlbXMpOwogICAgICAgICAgICAgICAgdGhpcy5jbGVhckNhY2hlKGl0ZW1zKTsKICAgICAgICAgICAgICAgIHZhciBuZXdfaXRlbXMgPSBpdGVtID8gW2l0ZW1dIDogaXRlbXM7CiAgICAgICAgICAgICAgICBfLmVhY2gobmV3X2l0ZW1zLCBmdW5jdGlvbiAoaXRlbSwgaW5kZXgsIGl0ZW1zKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNTZWxmKGl0ZW0uamlkKSkgeyByZXR1cm47IH0KICAgICAgICAgICAgICAgICAgICB2YXIgbW9kZWwgPSB0aGlzLmdldChpdGVtLmppZCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFtb2RlbCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXNfbGFzdCA9IChpbmRleCA9PT0gKGl0ZW1zLmxlbmd0aC0xKSkgPyB0cnVlIDogZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoaXRlbS5zdWJzY3JpcHRpb24gPT09ICdub25lJykgJiYgKGl0ZW0uYXNrID09PSBudWxsKSAmJiAhaXNfbGFzdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2UncmUgbm90IGludGVyZXN0ZWQgaW4gem9tYmllcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gKEhhY2s6IGV4Y2VwdCBpZiBpdCdzIHRoZSBsYXN0IGl0ZW0sIHRoZW4gd2Ugc3RpbGwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFkZCBpdCBzbyB0aGF0IHRoZSByb3N0ZXIgd2lsbCBiZSBzaG93bikuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jcmVhdGUoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNrOiBpdGVtLmFzaywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bGxuYW1lOiBpdGVtLm5hbWUgfHwgaXRlbS5qaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cHM6IGl0ZW0uZ3JvdXBzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgamlkOiBpdGVtLmppZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbjogaXRlbS5zdWJzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgfSwge3NvcnQ6IGZhbHNlfSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChpdGVtLnN1YnNjcmlwdGlvbiA9PT0gJ25vbmUnKSAmJiAoaXRlbS5hc2sgPT09IG51bGwpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIHVzZXIgaXMgbm8gbG9uZ2VyIGluIG91ciByb3N0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGVsLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIG9ubHkgZmluZCBvdXQgYWJvdXQgcmVxdWVzdGluZyBjb250YWN0cyB2aWEgdGhlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwcmVzZW5jZSBoYW5kbGVyLCBzbyBpZiB3ZSByZWNlaXZlIGEgY29udGFjdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaGVyZSwgd2Uga25vdyB0aGV5IGFyZW4ndCByZXF1ZXN0aW5nIGFueW1vcmUuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzZWUgZG9jcy9ERVZFTE9QRVIucnN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlbC5zYXZlKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb246IGl0ZW0uc3Vic2NyaXB0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzazogaXRlbS5hc2ssCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdGluZzogbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cHM6IGl0ZW0uZ3JvdXBzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHRoaXMpOwoKICAgICAgICAgICAgICAgIGlmICghY29udmVyc2UuaW5pdGlhbF9wcmVzZW5jZV9zZW50KSB7CiAgICAgICAgICAgICAgICAgICAgLyogT25jZSB3ZSd2ZSBzZW50IG91dCBvdXIgaW5pdGlhbCBwcmVzZW5jZSBzdGFuemEsIHdlJ2xsCiAgICAgICAgICAgICAgICAgICAgICogc3RhcnQgcmVjZWl2aW5nIHByZXNlbmNlIHN0YW56YXMgZnJvbSBvdXIgY29udGFjdHMuCiAgICAgICAgICAgICAgICAgICAgICogV2UgdGhlcmVmb3JlIG9ubHkgd2FudCB0byBkbyB0aGlzIGFmdGVyIG91ciByb3N0ZXIgaGFzCiAgICAgICAgICAgICAgICAgICAgICogYmVlbiBzZXQgdXAgKG90aGVyd2lzZSB3ZSBjYW4ndCBtZWFuaW5nZnVsbHkgcHJvY2VzcwogICAgICAgICAgICAgICAgICAgICAqIGluY29taW5nIHByZXNlbmNlIHN0YW56YXMpLgogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmluaXRpYWxfcHJlc2VuY2Vfc2VudCA9IDE7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UueG1wcHN0YXR1cy5zZW5kUHJlc2VuY2UoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGhhbmRsZUluY29taW5nU3Vic2NyaXB0aW9uOiBmdW5jdGlvbiAoamlkKSB7CiAgICAgICAgICAgICAgICB2YXIgYmFyZV9qaWQgPSBTdHJvcGhlLmdldEJhcmVKaWRGcm9tSmlkKGppZCk7CiAgICAgICAgICAgICAgICB2YXIgaXRlbSA9IHRoaXMuZ2V0KGJhcmVfamlkKTsKCiAgICAgICAgICAgICAgICBpZiAoIWNvbnZlcnNlLmFsbG93X2NvbnRhY3RfcmVxdWVzdHMpIHsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLnJvc3Rlci51bmF1dGhvcml6ZShiYXJlX2ppZCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY29udmVyc2UuYXV0b19zdWJzY3JpYmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKCFpdGVtKSB8fCAoaXRlbS5nZXQoJ3N1YnNjcmlwdGlvbicpICE9ICd0bycpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3Vic2NyaWJlQmFjayhqaWQpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24ucm9zdGVyLmF1dGhvcml6ZShiYXJlX2ppZCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGl0ZW0pICYmIChpdGVtLmdldCgnc3Vic2NyaXB0aW9uJykgIT0gJ25vbmUnKSkgIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5yb3N0ZXIuYXV0aG9yaXplKGJhcmVfamlkKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuZ2V0KGJhcmVfamlkKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuZ2V0VkNhcmQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFyZV9qaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJC5wcm94eShmdW5jdGlvbiAoamlkLCBmdWxsbmFtZSwgaW1nLCBpbWdfdHlwZSwgdXJsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGppZDogYmFyZV9qaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb246ICdub25lJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzazogbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3Rpbmc6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdWxsbmFtZTogZnVsbG5hbWUgfHwgamlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2U6IGltZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlX3R5cGU6IGltZ190eXBlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2Y2FyZF91cGRhdGVkOiBtb21lbnQoKS5mb3JtYXQoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCB0aGlzKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkLnByb3h5KGZ1bmN0aW9uIChqaWQsIGlxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmxvZygiRXJyb3Igd2hpbGUgcmV0cmlldmluZyB2Y2FyZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqaWQ6IGJhcmVfamlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uOiAnbm9uZScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc2s6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0aW5nOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVsbG5hbWU6IGJhcmVfamlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmNhcmRfdXBkYXRlZDogbW9tZW50KCkuZm9ybWF0KCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgdGhpcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcHJlc2VuY2VIYW5kbGVyOiBmdW5jdGlvbiAocHJlc2VuY2UpIHsKICAgICAgICAgICAgICAgIHZhciAkcHJlc2VuY2UgPSAkKHByZXNlbmNlKSwKICAgICAgICAgICAgICAgICAgICBwcmVzZW5jZV90eXBlID0gJHByZXNlbmNlLmF0dHIoJ3R5cGUnKTsKICAgICAgICAgICAgICAgIGlmIChwcmVzZW5jZV90eXBlID09PSAnZXJyb3InKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgamlkID0gJHByZXNlbmNlLmF0dHIoJ2Zyb20nKSwKICAgICAgICAgICAgICAgICAgICBiYXJlX2ppZCA9IFN0cm9waGUuZ2V0QmFyZUppZEZyb21KaWQoamlkKSwKICAgICAgICAgICAgICAgICAgICByZXNvdXJjZSA9IFN0cm9waGUuZ2V0UmVzb3VyY2VGcm9tSmlkKGppZCksCiAgICAgICAgICAgICAgICAgICAgJHNob3cgPSAkcHJlc2VuY2UuZmluZCgnc2hvdycpLAogICAgICAgICAgICAgICAgICAgIGNoYXRfc3RhdHVzID0gJHNob3cudGV4dCgpIHx8ICdvbmxpbmUnLAogICAgICAgICAgICAgICAgICAgIHN0YXR1c19tZXNzYWdlID0gJHByZXNlbmNlLmZpbmQoJ3N0YXR1cycpLAogICAgICAgICAgICAgICAgICAgIGNvbnRhY3Q7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNTZWxmKGJhcmVfamlkKSkgewogICAgICAgICAgICAgICAgICAgIGlmICgoY29udmVyc2UuY29ubmVjdGlvbi5qaWQgIT09IGppZCkmJihwcmVzZW5jZV90eXBlICE9PSAndW5hdmFpbGFibGUnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBBbm90aGVyIHJlc291cmNlIGhhcyBjaGFuZ2VkIGl0J3Mgc3RhdHVzLCB3ZSdsbCB1cGRhdGUgb3VycyBhcyB3ZWxsLgogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS54bXBwc3RhdHVzLnNhdmUoeydzdGF0dXMnOiBjaGF0X3N0YXR1c30pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKCRwcmVzZW5jZS5maW5kKCd4JykuYXR0cigneG1sbnMnKSB8fCAnJykuaW5kZXhPZihTdHJvcGhlLk5TLk1VQykgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gSWdub3JlIE1VQwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29udGFjdCA9IHRoaXMuZ2V0KGJhcmVfamlkKTsKICAgICAgICAgICAgICAgIGlmIChjb250YWN0ICYmIChzdGF0dXNfbWVzc2FnZS50ZXh0KCkgIT0gY29udGFjdC5nZXQoJ3N0YXR1cycpKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnRhY3Quc2F2ZSh7J3N0YXR1cyc6IHN0YXR1c19tZXNzYWdlLnRleHQoKX0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKChwcmVzZW5jZV90eXBlID09PSAnc3Vic2NyaWJlZCcpIHx8IChwcmVzZW5jZV90eXBlID09PSAndW5zdWJzY3JpYmUnKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwcmVzZW5jZV90eXBlID09PSAnc3Vic2NyaWJlJykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmhhbmRsZUluY29taW5nU3Vic2NyaXB0aW9uKGppZCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHByZXNlbmNlX3R5cGUgPT09ICd1bnN1YnNjcmliZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51bnN1YnNjcmliZShiYXJlX2ppZCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHByZXNlbmNlX3R5cGUgPT09ICd1bmF2YWlsYWJsZScpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yZW1vdmVSZXNvdXJjZShiYXJlX2ppZCwgcmVzb3VyY2UpID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250YWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWN0LnNhdmUoeydjaGF0X3N0YXR1cyc6ICdvZmZsaW5lJ30pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb250YWN0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gcHJlc2VuY2VfdHlwZSBpcyB1bmRlZmluZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZFJlc291cmNlKGJhcmVfamlkLCByZXNvdXJjZSk7CiAgICAgICAgICAgICAgICAgICAgY29udGFjdC5zYXZlKHsnY2hhdF9zdGF0dXMnOiBjaGF0X3N0YXR1c30pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5Sb3N0ZXJHcm91cCA9IEJhY2tib25lLk1vZGVsLmV4dGVuZCh7CiAgICAgICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uIChhdHRyaWJ1dGVzLCBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldChfLmV4dGVuZCh7CiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IERFU0NfR1JPVVBfVE9HR0xFLAogICAgICAgICAgICAgICAgICAgIHN0YXRlOiBPUEVORUQKICAgICAgICAgICAgICAgIH0sIGF0dHJpYnV0ZXMpKTsKICAgICAgICAgICAgICAgIC8vIENvbGxlY3Rpb24gb2YgY29udGFjdHMgYmVsb25naW5nIHRvIHRoaXMgZ3JvdXAuCiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhY3RzID0gbmV3IGNvbnZlcnNlLlJvc3RlckNvbnRhY3RzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5Sb3N0ZXJHcm91cFZpZXcgPSBCYWNrYm9uZS5PdmVydmlldy5leHRlbmQoewogICAgICAgICAgICB0YWdOYW1lOiAnZHQnLAogICAgICAgICAgICBjbGFzc05hbWU6ICdyb3N0ZXItZ3JvdXAnLAogICAgICAgICAgICBldmVudHM6IHsKICAgICAgICAgICAgICAgICJjbGljayBhLmdyb3VwLXRvZ2dsZSI6ICJ0b2dnbGUiCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLmNvbnRhY3RzLm9uKCJhZGQiLCB0aGlzLmFkZENvbnRhY3QsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5jb250YWN0cy5vbigiY2hhbmdlOnN1YnNjcmlwdGlvbiIsIHRoaXMub25Db250YWN0U3Vic2NyaXB0aW9uQ2hhbmdlLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuY29udGFjdHMub24oImNoYW5nZTpyZXF1ZXN0aW5nIiwgdGhpcy5vbkNvbnRhY3RSZXF1ZXN0Q2hhbmdlLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuY29udGFjdHMub24oImNoYW5nZTpjaGF0X3N0YXR1cyIsIGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBtaWdodCBiZSBvcHRpbWl6ZWQgYnkgaW5zdGVhZCBvZiBmaXJzdCBzb3J0aW5nLAogICAgICAgICAgICAgICAgICAgIC8vIGZpbmRpbmcgdGhlIGNvcnJlY3QgcG9zaXRpb24gaW4gcG9zaXRpb25Db250YWN0CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5jb250YWN0cy5zb3J0KCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbkNvbnRhY3QoY29udGFjdCkucmVuZGVyKCk7CiAgICAgICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuY29udGFjdHMub24oImRlc3Ryb3kiLCB0aGlzLm9uUmVtb3ZlLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuY29udGFjdHMub24oInJlbW92ZSIsIHRoaXMub25SZW1vdmUsIHRoaXMpOwogICAgICAgICAgICAgICAgY29udmVyc2Uucm9zdGVyLm9uKCdjaGFuZ2U6Z3JvdXBzJywgdGhpcy5vbkNvbnRhY3RHcm91cENoYW5nZSwgdGhpcyk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmF0dHIoJ2RhdGEtZ3JvdXAnLCB0aGlzLm1vZGVsLmdldCgnbmFtZScpKTsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmh0bWwoCiAgICAgICAgICAgICAgICAgICAgJChjb252ZXJzZS50ZW1wbGF0ZXMuZ3JvdXBfaGVhZGVyKHsKICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWxfZ3JvdXA6IHRoaXMubW9kZWwuZ2V0KCduYW1lJyksCiAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NfZ3JvdXBfdG9nZ2xlOiB0aGlzLm1vZGVsLmdldCgnZGVzY3JpcHRpb24nKSwKICAgICAgICAgICAgICAgICAgICAgICAgdG9nZ2xlX3N0YXRlOiB0aGlzLm1vZGVsLmdldCgnc3RhdGUnKQogICAgICAgICAgICAgICAgICAgIH0pKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgYWRkQ29udGFjdDogZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgICAgICAgICAgIHZhciB2aWV3ID0gbmV3IGNvbnZlcnNlLlJvc3RlckNvbnRhY3RWaWV3KHttb2RlbDogY29udGFjdH0pOwogICAgICAgICAgICAgICAgdGhpcy5hZGQoY29udGFjdC5nZXQoJ2lkJyksIHZpZXcpOwogICAgICAgICAgICAgICAgdmlldyA9IHRoaXMucG9zaXRpb25Db250YWN0KGNvbnRhY3QpLnJlbmRlcigpOwogICAgICAgICAgICAgICAgaWYgKGNvbnRhY3Quc2hvd0luUm9zdGVyKCkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5tb2RlbC5nZXQoJ3N0YXRlJykgPT09IENMT1NFRCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodmlldy4kZWxbMF0uc3R5bGUuZGlzcGxheSAhPT0gIm5vbmUiKSB7IHZpZXcuJGVsLmhpZGUoKTsgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy4kZWxbMF0uc3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiKSB7IHRoaXMuJGVsLnNob3coKTsgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLiRlbFswXS5zdHlsZS5kaXNwbGF5ICE9PSAiYmxvY2siKSB7IHRoaXMuc2hvdygpOyB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcG9zaXRpb25Db250YWN0OiBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICAgICAgICAgICAgLyogUGxhY2UgdGhlIGNvbnRhY3QncyBET00gZWxlbWVudCBpbiB0aGUgY29ycmVjdCBhbHBoYWJldGljYWwKICAgICAgICAgICAgICAgICAqIHBvc2l0aW9uIGFtb25nc3QgdGhlIG90aGVyIGNvbnRhY3RzIGluIHRoaXMgZ3JvdXAuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIHZhciB2aWV3ID0gdGhpcy5nZXQoY29udGFjdC5nZXQoJ2lkJykpOwogICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5tb2RlbC5jb250YWN0cy5pbmRleE9mKGNvbnRhY3QpOwogICAgICAgICAgICAgICAgdmlldy4kZWwuZGV0YWNoKCk7CiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5hZnRlcih2aWV3LiRlbCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGluZGV4ID09ICh0aGlzLm1vZGVsLmNvbnRhY3RzLmxlbmd0aC0xKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLm5leHRVbnRpbCgnZHQnKS5sYXN0KCkuYWZ0ZXIodmlldy4kZWwpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5uZXh0VW50aWwoJ2R0JykuZXEoaW5kZXgpLmJlZm9yZSh2aWV3LiRlbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdmlldzsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHNob3c6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIC8vIEZJWE1FOiBUaGVyZSdzIGEgYnVnIGhlcmUsIGlmIHNob3dfb25seV9vbmxpbmVfdXNlcnMgaXMgdHJ1ZQogICAgICAgICAgICAgICAgLy8gUG9zc2libGUgc29sdXRpb24sIGdldCB0aGUgZ3JvdXAsIGNhbGwgXy5lYWNoIGFuZCBjaGVjawogICAgICAgICAgICAgICAgLy8gc2hvd0luUm9zdGVyCiAgICAgICAgICAgICAgICB0aGlzLiRlbC5uZXh0VW50aWwoJ2R0JykuYWRkQmFjaygpLnNob3coKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGhpZGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLm5leHRVbnRpbCgnZHQnKS5hZGRCYWNrKCkuaGlkZSgpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgZmlsdGVyOiBmdW5jdGlvbiAocSkgewogICAgICAgICAgICAgICAgLyogRmlsdGVyIHRoZSBncm91cCdzIGNvbnRhY3RzIGJhc2VkIG9uIHRoZSBxdWVyeSAicSIuCiAgICAgICAgICAgICAgICAgKiBUaGUgcXVlcnkgaXMgbWF0Y2hlZCBhZ2FpbnN0IHRoZSBjb250YWN0J3MgZnVsbCBuYW1lLgogICAgICAgICAgICAgICAgICogSWYgYWxsIGNvbnRhY3RzIGFyZSBmaWx0ZXJlZCBvdXQgKGkuZS4gaGlkZGVuKSwgdGhlbiB0aGUKICAgICAgICAgICAgICAgICAqIGdyb3VwIG11c3QgYmUgZmlsdGVyZWQgb3V0IGFzIHdlbGwuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIHZhciBtYXRjaGVzLCByZWplY3RzOwogICAgICAgICAgICAgICAgaWYgKHEubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubW9kZWwuZ2V0KCdzdGF0ZScpID09PSBPUEVORUQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5jb250YWN0cy5lYWNoKCQucHJveHkoZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLnNob3dJblJvc3RlcigpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXQoaXRlbS5nZXQoJ2lkJykpLiRlbC5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIHRoaXMpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93SWZJbnZpc2libGUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcSA9IHEudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICBtYXRjaGVzID0gdGhpcy5tb2RlbC5jb250YWN0cy5maWx0ZXIoY29udGFpbnMubm90KCdmdWxsbmFtZScsIHEpKTsKICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2hlcy5sZW5ndGggPT09IHRoaXMubW9kZWwuY29udGFjdHMubGVuZ3RoKSB7IC8vIGhpZGUgdGhlIHdob2xlIGdyb3VwCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF8uZWFjaChtYXRjaGVzLCAkLnByb3h5KGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdldChpdGVtLmdldCgnaWQnKSkuJGVsLmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgICAgICAgICAgICAgICAgICBfLmVhY2godGhpcy5tb2RlbC5jb250YWN0cy5yZWplY3QoY29udGFpbnMubm90KCdmdWxsbmFtZScsIHEpKSwgJC5wcm94eShmdW5jdGlvbiAoaXRlbSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXQoaXRlbS5nZXQoJ2lkJykpLiRlbC5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIHRoaXMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93SWZJbnZpc2libGUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzaG93SWZJbnZpc2libGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy4kZWwuaXMoJzp2aXNpYmxlJykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5zaG93KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB0b2dnbGU6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgaWYgKGV2ICYmIGV2LnByZXZlbnREZWZhdWx0KSB7IGV2LnByZXZlbnREZWZhdWx0KCk7IH0KICAgICAgICAgICAgICAgIHZhciAkZWwgPSAkKGV2LnRhcmdldCk7CiAgICAgICAgICAgICAgICBpZiAoJGVsLmhhc0NsYXNzKCJpY29uLW9wZW5lZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwubmV4dFVudGlsKCdkdCcpLnNsaWRlVXAoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLnNhdmUoe3N0YXRlOiBDTE9TRUR9KTsKICAgICAgICAgICAgICAgICAgICAkZWwucmVtb3ZlQ2xhc3MoImljb24tb3BlbmVkIikuYWRkQ2xhc3MoImljb24tY2xvc2VkIik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICRlbC5yZW1vdmVDbGFzcygiaWNvbi1jbG9zZWQiKS5hZGRDbGFzcygiaWNvbi1vcGVuZWQiKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLnNhdmUoe3N0YXRlOiBPUEVORUR9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZpbHRlcigKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2Uucm9zdGVydmlldy4kKCcucm9zdGVyLWZpbHRlcicpLnZhbCgpLAogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5yb3N0ZXJ2aWV3LiQoJy5maWx0ZXItdHlwZScpLnZhbCgpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG9uQ29udGFjdEdyb3VwQ2hhbmdlOiBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICAgICAgICAgICAgdmFyIGluX3RoaXNfZ3JvdXAgPSBfLmNvbnRhaW5zKGNvbnRhY3QuZ2V0KCdncm91cHMnKSwgdGhpcy5tb2RlbC5nZXQoJ25hbWUnKSk7CiAgICAgICAgICAgICAgICB2YXIgY2lkID0gY29udGFjdC5nZXQoJ2lkJyk7CiAgICAgICAgICAgICAgICB2YXIgaW5fdGhpc19vdmVydmlldyA9ICF0aGlzLmdldChjaWQpOwogICAgICAgICAgICAgICAgaWYgKGluX3RoaXNfZ3JvdXAgJiYgIWluX3RoaXNfb3ZlcnZpZXcpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLmNvbnRhY3RzLnJlbW92ZShjaWQpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghaW5fdGhpc19ncm91cCAmJiBpbl90aGlzX292ZXJ2aWV3KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRDb250YWN0KGNvbnRhY3QpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25Db250YWN0U3Vic2NyaXB0aW9uQ2hhbmdlOiBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICAgICAgICAgICAgaWYgKCh0aGlzLm1vZGVsLmdldCgnbmFtZScpID09PSBIRUFERVJfUEVORElOR19DT05UQUNUUykgJiYgY29udGFjdC5nZXQoJ3N1YnNjcmlwdGlvbicpICE9PSAnZnJvbScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLmNvbnRhY3RzLnJlbW92ZShjb250YWN0LmdldCgnaWQnKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBvbkNvbnRhY3RSZXF1ZXN0Q2hhbmdlOiBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICAgICAgICAgICAgaWYgKCh0aGlzLm1vZGVsLmdldCgnbmFtZScpID09PSBIRUFERVJfUkVRVUVTVElOR19DT05UQUNUUykgJiYgIWNvbnRhY3QuZ2V0KCdyZXF1ZXN0aW5nJykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLmNvbnRhY3RzLnJlbW92ZShjb250YWN0LmdldCgnaWQnKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBvblJlbW92ZTogZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlKGNvbnRhY3QuZ2V0KCdpZCcpKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1vZGVsLmNvbnRhY3RzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLmhpZGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLlJvc3Rlckdyb3VwcyA9IEJhY2tib25lLkNvbGxlY3Rpb24uZXh0ZW5kKHsKICAgICAgICAgICAgbW9kZWw6IGNvbnZlcnNlLlJvc3Rlckdyb3VwLAogICAgICAgICAgICBjb21wYXJhdG9yOiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgICAgLyogR3JvdXBzIGFyZSBzb3J0ZWQgYWxwaGFiZXRpY2FsbHksIGlnbm9yaW5nIGNhc2UuCiAgICAgICAgICAgICAgICAgKiBIb3dldmVyLCBVbmdyb3VwZWQsIFJlcXVlc3RpbmcgQ29udGFjdHMgYW5kIFBlbmRpbmcgQ29udGFjdHMKICAgICAgICAgICAgICAgICAqIGFwcGVhciBsYXN0IGFuZCBpbiB0aGF0IG9yZGVyLiAqLwogICAgICAgICAgICAgICAgYSA9IGEuZ2V0KCduYW1lJyk7CiAgICAgICAgICAgICAgICBiID0gYi5nZXQoJ25hbWUnKTsKICAgICAgICAgICAgICAgIHZhciBzcGVjaWFsX2dyb3VwcyA9IF8ua2V5cyhIRUFERVJfV0VJR0hUUyk7CiAgICAgICAgICAgICAgICB2YXIgYV9pc19zcGVjaWFsID0gXy5jb250YWlucyhzcGVjaWFsX2dyb3VwcywgYSk7CiAgICAgICAgICAgICAgICB2YXIgYl9pc19zcGVjaWFsID0gXy5jb250YWlucyhzcGVjaWFsX2dyb3VwcywgYik7CiAgICAgICAgICAgICAgICBpZiAoIWFfaXNfc3BlY2lhbCAmJiAhYl9pc19zcGVjaWFsICkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBhLnRvTG93ZXJDYXNlKCkgPCBiLnRvTG93ZXJDYXNlKCkgPyAtMSA6IChhLnRvTG93ZXJDYXNlKCkgPiBiLnRvTG93ZXJDYXNlKCkgPyAxIDogMCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFfaXNfc3BlY2lhbCAmJiBiX2lzX3NwZWNpYWwpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gSEVBREVSX1dFSUdIVFNbYV0gPCBIRUFERVJfV0VJR0hUU1tiXSA/IC0xIDogKEhFQURFUl9XRUlHSFRTW2FdID4gSEVBREVSX1dFSUdIVFNbYl0gPyAxIDogMCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFhX2lzX3NwZWNpYWwgJiYgYl9pc19zcGVjaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChiID09PSBIRUFERVJfQ1VSUkVOVF9DT05UQUNUUykgPyAxIDogLTE7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFfaXNfc3BlY2lhbCAmJiAhYl9pc19zcGVjaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChhID09PSBIRUFERVJfQ1VSUkVOVF9DT05UQUNUUykgPyAtMSA6IDE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5Sb3N0ZXJWaWV3ID0gQmFja2JvbmUuT3ZlcnZpZXcuZXh0ZW5kKHsKICAgICAgICAgICAgdGFnTmFtZTogJ2RpdicsCiAgICAgICAgICAgIGlkOiAnY29udmVyc2Utcm9zdGVyJywKICAgICAgICAgICAgZXZlbnRzOiB7CiAgICAgICAgICAgICAgICAia2V5ZG93biAucm9zdGVyLWZpbHRlciI6ICJsaXZlRmlsdGVyIiwKICAgICAgICAgICAgICAgICJjbGljayAub25YIjogImNsZWFyRmlsdGVyIiwKICAgICAgICAgICAgICAgICJtb3VzZW1vdmUgLngiOiAidG9nZ2xlUG9pbnRlciIsCiAgICAgICAgICAgICAgICAiY2hhbmdlIC5maWx0ZXItdHlwZSI6ICJjaGFuZ2VGaWx0ZXJUeXBlIgogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RlclJvc3RlckhhbmRsZXIoKTsKICAgICAgICAgICAgICAgIHRoaXMucmVnaXN0ZXJSb3N0ZXJYSGFuZGxlcigpOwogICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RlclByZXNlbmNlSGFuZGxlcigpOwogICAgICAgICAgICAgICAgY29udmVyc2Uucm9zdGVyLm9uKCJhZGQiLCB0aGlzLm9uQ29udGFjdEFkZCwgdGhpcyk7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5yb3N0ZXIub24oJ2NoYW5nZScsIHRoaXMub25Db250YWN0Q2hhbmdlLCB0aGlzKTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJvc3Rlci5vbigiZGVzdHJveSIsIHRoaXMudXBkYXRlLCB0aGlzKTsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJvc3Rlci5vbigicmVtb3ZlIiwgdGhpcy51cGRhdGUsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5vbigiYWRkIiwgdGhpcy5vbkdyb3VwQWRkLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwub24oInJlc2V0IiwgdGhpcy5yZXNldCwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLiRyb3N0ZXIgPSAkKCc8ZGwgY2xhc3M9InJvc3Rlci1jb250YWN0cyIgc3R5bGU9ImRpc3BsYXk6IG5vbmU7Ij48L2RsPicpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgdXBkYXRlOiBfLmRlYm91bmNlKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciAkY291bnQgPSAkKCcjb25saW5lLWNvdW50Jyk7CiAgICAgICAgICAgICAgICAkY291bnQudGV4dCgnKCcrY29udmVyc2Uucm9zdGVyLmdldE51bU9ubGluZUNvbnRhY3RzKCkrJyknKTsKICAgICAgICAgICAgICAgIGlmICghJGNvdW50LmlzKCc6dmlzaWJsZScpKSB7CiAgICAgICAgICAgICAgICAgICAgJGNvdW50LnNob3coKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0aGlzLiRyb3N0ZXIucGFyZW50KCkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuYXBwZW5kKHRoaXMuJHJvc3Rlci5zaG93KCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2hvd0hpZGVGaWx0ZXIoKTsKICAgICAgICAgICAgfSwgY29udmVyc2UuYW5pbWF0ZSA/IDEwMCA6IDApLAoKICAgICAgICAgICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5odG1sKGNvbnZlcnNlLnRlbXBsYXRlcy5yb3N0ZXIoewogICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyOiBfXygnVHlwZSB0byBmaWx0ZXInKSwKICAgICAgICAgICAgICAgICAgICBsYWJlbF9jb250YWN0czogTEFCRUxfQ09OVEFDVFMsCiAgICAgICAgICAgICAgICAgICAgbGFiZWxfZ3JvdXBzOiBMQUJFTF9HUk9VUFMKICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgZmV0Y2g6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuZmV0Y2goewogICAgICAgICAgICAgICAgICAgIHNpbGVudDogdHJ1ZSwgLy8gV2UgdXNlIHRoZSBzdWNjZXNzIGhhbmRsZXIgdG8gaGFuZGxlIGdyb3VwcyB0aGF0IHdlcmUgYWRkZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIGZpcnN0IGhhdmUgYWxsIGdyb3VwcyBiZWZvcmUgcG9zaXRpb25GZXRjaGVkR3JvdXBzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3aWxsIHdvcmsgcHJvcGVybHkuCiAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogJC5wcm94eShmdW5jdGlvbiAoY29sbGVjdGlvbiwgcmVzcCwgb3B0aW9ucykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sbGVjdGlvbi5sZW5ndGggIT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9zaXRpb25GZXRjaGVkR3JvdXBzKGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLnJvc3Rlci5mZXRjaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoY29sbGVjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFhYWDogQml0IG9mIGEgaGFjay4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzdHJvcGhlLnJvc3RlciBleHBlY3RzIC5nZXQgdG8gYmUgY2FsbGVkIGZvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGV2ZXJ5IHBhZ2UgbG9hZCBzbyB0aGF0IGl0cyAiaXRlbXMiIGF0dHIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBnZXRzIHBvcHVsYXRlZC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIHZlcnkgaW5lZmZpY2llbnQgZm9yIGxhcmdlIHJvc3RlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYW5kIHdlIGFscmVhZHkgaGF2ZSB0aGUgcm9zdGVyIGNhY2hlZCBpbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNlc3Npb25TdG9yYWdlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoZXJlZm9yZSB3ZSBtYW51YWxseSBwb3B1bGF0ZSB0aGUgIml0ZW1zIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGF0dHIuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWRlYWxseSB3ZSBzaG91bGQgZXZlbnR1YWxseSByZXBsYWNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3Ryb3BoZS5yb3N0ZXIgd2l0aCBzb21ldGhpbmcgYmV0dGVyLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2xsZWN0aW9uLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sbGVjdGlvbi5lYWNoKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLnJvc3Rlci5pdGVtcy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lICAgICAgICAgOiBpdGVtLmdldCgnZnVsbG5hbWUnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqaWQgICAgICAgICAgOiBpdGVtLmdldCgnamlkJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uIDogaXRlbS5nZXQoJ3N1YnNjcmlwdGlvbicpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzayAgICAgICAgICA6IGl0ZW0uZ2V0KCdhc2snKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cHMgICAgICAgOiBpdGVtLmdldCgnZ3JvdXBzJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VzICAgIDogaXRlbS5nZXQoJ3Jlc291cmNlcycpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmluaXRpYWxfcHJlc2VuY2Vfc2VudCA9IDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLnhtcHBzdGF0dXMuc2VuZFByZXNlbmNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5yb3N0ZXIuZ2V0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9LCB0aGlzKQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGNoYW5nZUZpbHRlclR5cGU6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgaWYgKGV2ICYmIGV2LnByZXZlbnREZWZhdWx0KSB7IGV2LnByZXZlbnREZWZhdWx0KCk7IH0KICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJGaWx0ZXIoKTsKICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyKAogICAgICAgICAgICAgICAgICAgIHRoaXMuJCgnLnJvc3Rlci1maWx0ZXInKS52YWwoKSwKICAgICAgICAgICAgICAgICAgICBldi50YXJnZXQudmFsdWUKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB0b2c6IGZ1bmN0aW9uICh2KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdj8nYWRkQ2xhc3MnOidyZW1vdmVDbGFzcyc7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB0b2dnbGVQb2ludGVyOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGlmIChldiAmJiBldi5wcmV2ZW50RGVmYXVsdCkgeyBldi5wcmV2ZW50RGVmYXVsdCgpOyB9CiAgICAgICAgICAgICAgICB2YXIgZWwgPSBldi50YXJnZXQ7CiAgICAgICAgICAgICAgICAkKGVsKVt0aGlzLnRvZyhlbC5vZmZzZXRXaWR0aC0xOCA8IGV2LmNsaWVudFgtZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkubGVmdCldKCdvblgnKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGZpbHRlcjogZnVuY3Rpb24gKHF1ZXJ5LCB0eXBlKSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2hlczsKICAgICAgICAgICAgICAgIHF1ZXJ5ID0gcXVlcnkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnZ3JvdXBzJykgewogICAgICAgICAgICAgICAgICAgIF8uZWFjaCh0aGlzLmdldEFsbCgpLCBmdW5jdGlvbiAodmlldywgaWR4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2aWV3Lm1vZGVsLmdldCgnbmFtZScpLnRvTG93ZXJDYXNlKCkuaW5kZXhPZihxdWVyeS50b0xvd2VyQ2FzZSgpKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpZXcuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHZpZXcubW9kZWwuY29udGFjdHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlldy5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgXy5lYWNoKHRoaXMuZ2V0QWxsKCksIGZ1bmN0aW9uICh2aWV3KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZpZXcuZmlsdGVyKHF1ZXJ5LCB0eXBlKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGxpdmVGaWx0ZXI6IF8uZGVib3VuY2UoZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBpZiAoZXYgJiYgZXYucHJldmVudERlZmF1bHQpIHsgZXYucHJldmVudERlZmF1bHQoKTsgfQogICAgICAgICAgICAgICAgdmFyIHEgPSBldi50YXJnZXQudmFsdWU7CiAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMuJCgnLmZpbHRlci10eXBlJykudmFsKCk7CiAgICAgICAgICAgICAgICAkKGV2LnRhcmdldClbdGhpcy50b2cocSldKCd4Jyk7CiAgICAgICAgICAgICAgICB0aGlzLmZpbHRlcihxLCB0KTsKICAgICAgICAgICAgfSwgMzAwKSwKCiAgICAgICAgICAgIGNsZWFyRmlsdGVyOiBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgICAgIGlmIChldiAmJiBldi5wcmV2ZW50RGVmYXVsdCkgewogICAgICAgICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgJChldi50YXJnZXQpLnJlbW92ZUNsYXNzKCd4IG9uWCcpLnZhbCgnJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmZpbHRlcignJyk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzaG93SGlkZUZpbHRlcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLiRlbC5pcygnOnZpc2libGUnKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciAkZmlsdGVyID0gdGhpcy4kKCcucm9zdGVyLWZpbHRlcicpOwogICAgICAgICAgICAgICAgdmFyICR0eXBlICA9IHRoaXMuJCgnLmZpbHRlci10eXBlJyk7CiAgICAgICAgICAgICAgICB2YXIgdmlzaWJsZSA9ICRmaWx0ZXIuaXMoJzp2aXNpYmxlJyk7CiAgICAgICAgICAgICAgICBpZiAodmlzaWJsZSAmJiAkZmlsdGVyLnZhbCgpLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAvLyBEb24ndCBoaWRlIGlmIHVzZXIgaXMgY3VycmVudGx5IGZpbHRlcmluZy4KICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy4kcm9zdGVyLmhhc1Njcm9sbEJhcigpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF2aXNpYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRmaWx0ZXIuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICAkdHlwZS5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkZmlsdGVyLmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICAkdHlwZS5oaWRlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlc2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5yb3N0ZXIucmVzZXQoKTsKICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlQWxsKCk7CiAgICAgICAgICAgICAgICB0aGlzLiRyb3N0ZXIgPSAkKCc8ZGwgY2xhc3M9InJvc3Rlci1jb250YWN0cyIgc3R5bGU9ImRpc3BsYXk6IG5vbmU7Ij48L2RsPicpOwogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIoKS51cGRhdGUoKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVnaXN0ZXJSb3N0ZXJIYW5kbGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAvLyBSZWdpc3RlciBoYW5kbGVycyB0aGF0IGRlcGVuZCBvbiB0aGUgcm9zdGVyCiAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLnJvc3Rlci5yZWdpc3RlckNhbGxiYWNrKAogICAgICAgICAgICAgICAgICAgICQucHJveHkoY29udmVyc2Uucm9zdGVyLnJvc3RlckhhbmRsZXIsIGNvbnZlcnNlLnJvc3RlcikKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZWdpc3RlclJvc3RlclhIYW5kbGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgdCA9IDA7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLmFkZEhhbmRsZXIoCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKG1zZykgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLmZsdXNoKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJC5wcm94eShjb252ZXJzZS5yb3N0ZXIuc3Vic2NyaWJlVG9TdWdnZXN0ZWRJdGVtcywgY29udmVyc2Uucm9zdGVyKShtc2cpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgdCArPSAkKG1zZykuZmluZCgnaXRlbScpLmxlbmd0aCoyNTA7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgJ2h0dHA6Ly9qYWJiZXIub3JnL3Byb3RvY29sL3Jvc3RlcngnLCAnbWVzc2FnZScsIG51bGwpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVnaXN0ZXJQcmVzZW5jZUhhbmRsZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24uYWRkSGFuZGxlcigKICAgICAgICAgICAgICAgICAgICAkLnByb3h5KGZ1bmN0aW9uIChwcmVzZW5jZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5yb3N0ZXIucHJlc2VuY2VIYW5kbGVyKHByZXNlbmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSwgdGhpcyksIG51bGwsICdwcmVzZW5jZScsIG51bGwpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25Hcm91cEFkZDogZnVuY3Rpb24gKGdyb3VwKSB7CiAgICAgICAgICAgICAgICB2YXIgdmlldyA9IG5ldyBjb252ZXJzZS5Sb3N0ZXJHcm91cFZpZXcoe21vZGVsOiBncm91cH0pOwogICAgICAgICAgICAgICAgdGhpcy5hZGQoZ3JvdXAuZ2V0KCduYW1lJyksIHZpZXcucmVuZGVyKCkpOwogICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbkdyb3VwKHZpZXcpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25Db250YWN0QWRkOiBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICAgICAgICAgICAgdGhpcy5hZGRSb3N0ZXJDb250YWN0KGNvbnRhY3QpLnVwZGF0ZSgpOwogICAgICAgICAgICAgICAgaWYgKCFjb250YWN0LmdldCgndmNhcmRfdXBkYXRlZCcpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyB3aWxsIHVwZGF0ZSB0aGUgdmNhcmQsIHdoaWNoIHRyaWdnZXJzIGEgY2hhbmdlCiAgICAgICAgICAgICAgICAgICAgLy8gcmVxdWVzdCB3aGljaCB3aWxsIHJlcmVuZGVyIHRoZSByb3N0ZXIgY29udGFjdC4KICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5nZXRWQ2FyZChjb250YWN0LmdldCgnamlkJykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25Db250YWN0Q2hhbmdlOiBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVDaGF0Qm94KGNvbnRhY3QpLnVwZGF0ZSgpOwogICAgICAgICAgICAgICAgaWYgKF8uaGFzKGNvbnRhY3QuY2hhbmdlZCwgJ3N1YnNjcmlwdGlvbicpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnRhY3QuY2hhbmdlZC5zdWJzY3JpcHRpb24gPT0gJ2Zyb20nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkQ29udGFjdFRvR3JvdXAoY29udGFjdCwgSEVBREVSX1BFTkRJTkdfQ09OVEFDVFMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29udGFjdC5nZXQoJ3N1YnNjcmlwdGlvbicpID09PSAnYm90aCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRFeGlzdGluZ0NvbnRhY3QoY29udGFjdCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKF8uaGFzKGNvbnRhY3QuY2hhbmdlZCwgJ2FzaycpICYmIGNvbnRhY3QuY2hhbmdlZC5hc2sgPT0gJ3N1YnNjcmliZScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZENvbnRhY3RUb0dyb3VwKGNvbnRhY3QsIEhFQURFUl9QRU5ESU5HX0NPTlRBQ1RTKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChfLmhhcyhjb250YWN0LmNoYW5nZWQsICdzdWJzY3JpcHRpb24nKSAmJiBjb250YWN0LmNoYW5nZWQucmVxdWVzdGluZyA9PSAndHJ1ZScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZENvbnRhY3RUb0dyb3VwKGNvbnRhY3QsIEhFQURFUl9SRVFVRVNUSU5HX0NPTlRBQ1RTKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHVwZGF0ZUNoYXRCb3g6IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgICAgICAgICAgICB2YXIgY2hhdGJveCA9IGNvbnZlcnNlLmNoYXRib3hlcy5nZXQoY29udGFjdC5nZXQoJ2ppZCcpKSwKICAgICAgICAgICAgICAgICAgICBjaGFuZ2VzID0ge307CiAgICAgICAgICAgICAgICBpZiAoIWNoYXRib3gpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChfLmhhcyhjb250YWN0LmNoYW5nZWQsICdjaGF0X3N0YXR1cycpKSB7CiAgICAgICAgICAgICAgICAgICAgY2hhbmdlcy5jaGF0X3N0YXR1cyA9IGNvbnRhY3QuZ2V0KCdjaGF0X3N0YXR1cycpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKF8uaGFzKGNvbnRhY3QuY2hhbmdlZCwgJ3N0YXR1cycpKSB7CiAgICAgICAgICAgICAgICAgICAgY2hhbmdlcy5zdGF0dXMgPSBjb250YWN0LmdldCgnc3RhdHVzJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjaGF0Ym94LnNhdmUoY2hhbmdlcyk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHBvc2l0aW9uRmV0Y2hlZEdyb3VwczogZnVuY3Rpb24gKG1vZGVsLCByZXNwLCBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICAvKiBJbnN0ZWFkIG9mIHRocm93aW5nIGFuIGFkZCBldmVudCBmb3IgZWFjaCBncm91cAogICAgICAgICAgICAgICAgICAgICogZmV0Y2hlZCwgd2Ugd2FpdCB1bnRpbCB0aGV5J3JlIGFsbCBmZXRjaGVkIGFuZCB0aGVuCiAgICAgICAgICAgICAgICAgICAgKiB3ZSBwb3NpdGlvbiB0aGVtLgogICAgICAgICAgICAgICAgICAgICogV29ya3MgYXJvdW5kIHRoZSBwcm9ibGVtIG9mIHBvc2l0aW9uR3JvdXAgbm90CiAgICAgICAgICAgICAgICAgICAgKiB3b3JraW5nIHdoZW4gYWxsIGdyb3VwcyBiZXNpZGVzIHRoZSBvbmUgYmVpbmcKICAgICAgICAgICAgICAgICAgICAqIHBvc2l0aW9uZWQgYXJlbid0IGFscmVhZHkgaW4gaW5zZXJ0ZWQgaW50byB0aGUKICAgICAgICAgICAgICAgICAgICAqIHJvc3RlciBET00gZWxlbWVudC4KICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgbW9kZWwuc29ydCgpOwogICAgICAgICAgICAgICAgbW9kZWwuZWFjaCgkLnByb3h5KGZ1bmN0aW9uIChncm91cCwgaWR4KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZpZXcgPSB0aGlzLmdldChncm91cC5nZXQoJ25hbWUnKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF2aWV3KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZpZXcgPSBuZXcgY29udmVyc2UuUm9zdGVyR3JvdXBWaWV3KHttb2RlbDogZ3JvdXB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGQoZ3JvdXAuZ2V0KCduYW1lJyksIHZpZXcucmVuZGVyKCkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoaWR4ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJHJvc3Rlci5hcHBlbmQodmlldy4kZWwpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kR3JvdXAodmlldyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcG9zaXRpb25Hcm91cDogZnVuY3Rpb24gKHZpZXcpIHsKICAgICAgICAgICAgICAgIC8qIFBsYWNlIHRoZSBncm91cCdzIERPTSBlbGVtZW50IGluIHRoZSBjb3JyZWN0IGFscGhhYmV0aWNhbAogICAgICAgICAgICAgICAgICogcG9zaXRpb24gYW1vbmdzdCB0aGUgb3RoZXIgZ3JvdXBzIGluIHRoZSByb3N0ZXIuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIHZhciAkZ3JvdXBzID0gdGhpcy4kcm9zdGVyLmZpbmQoJy5yb3N0ZXItZ3JvdXAnKSwKICAgICAgICAgICAgICAgICAgICBpbmRleCA9ICRncm91cHMubGVuZ3RoID8gdGhpcy5tb2RlbC5pbmRleE9mKHZpZXcubW9kZWwpIDogMDsKICAgICAgICAgICAgICAgIGlmIChpbmRleCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJHJvc3Rlci5wcmVwZW5kKHZpZXcuJGVsKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPT0gKHRoaXMubW9kZWwubGVuZ3RoLTEpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRHcm91cCh2aWV3KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJCgkZ3JvdXBzLmVxKGluZGV4KSkuYmVmb3JlKHZpZXcuJGVsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgYXBwZW5kR3JvdXA6IGZ1bmN0aW9uICh2aWV3KSB7CiAgICAgICAgICAgICAgICAvKiBBZGQgdGhlIGdyb3VwIGF0IHRoZSBib3R0b20gb2YgdGhlIHJvc3RlcgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICB2YXIgJGxhc3QgPSB0aGlzLiRyb3N0ZXIuZmluZCgnLnJvc3Rlci1ncm91cCcpLmxhc3QoKTsKICAgICAgICAgICAgICAgIHZhciAkc2libGluZ3MgPSAkbGFzdC5zaWJsaW5ncygnZGQnKTsKICAgICAgICAgICAgICAgIGlmICgkc2libGluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICRzaWJsaW5ncy5sYXN0KCkuYWZ0ZXIodmlldy4kZWwpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkbGFzdC5hZnRlcih2aWV3LiRlbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGdldEdyb3VwOiBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICAgICAgLyogUmV0dXJucyB0aGUgZ3JvdXAgYXMgc3BlY2lmaWVkIGJ5IG5hbWUuCiAgICAgICAgICAgICAgICAgKiBDcmVhdGVzIHRoZSBncm91cCBpZiBpdCBkb2Vzbid0IGV4aXN0LgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICB2YXIgdmlldyA9ICB0aGlzLmdldChuYW1lKTsKICAgICAgICAgICAgICAgIGlmICh2aWV3KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZpZXcubW9kZWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5tb2RlbC5jcmVhdGUoe25hbWU6IG5hbWUsIGlkOiBiNjRfc2hhMShuYW1lKX0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgYWRkQ29udGFjdFRvR3JvdXA6IGZ1bmN0aW9uIChjb250YWN0LCBuYW1lKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdldEdyb3VwKG5hbWUpLmNvbnRhY3RzLmFkZChjb250YWN0KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGFkZEV4aXN0aW5nQ29udGFjdDogZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgICAgICAgICAgIHZhciBncm91cHM7CiAgICAgICAgICAgICAgICBpZiAoY29udmVyc2Uucm9zdGVyX2dyb3VwcykgewogICAgICAgICAgICAgICAgICAgIGdyb3VwcyA9IGNvbnRhY3QuZ2V0KCdncm91cHMnKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZ3JvdXBzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBncm91cHMgPSBbSEVBREVSX1VOR1JPVVBFRF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBncm91cHMgPSBbSEVBREVSX0NVUlJFTlRfQ09OVEFDVFNdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgXy5lYWNoKGdyb3VwcywgJC5wcm94eShmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkQ29udGFjdFRvR3JvdXAoY29udGFjdCwgbmFtZSk7CiAgICAgICAgICAgICAgICB9LCB0aGlzKSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBhZGRSb3N0ZXJDb250YWN0OiBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICAgICAgICAgICAgaWYgKGNvbnRhY3QuZ2V0KCdzdWJzY3JpcHRpb24nKSA9PT0gJ2JvdGgnIHx8IGNvbnRhY3QuZ2V0KCdzdWJzY3JpcHRpb24nKSA9PT0gJ3RvJykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkRXhpc3RpbmdDb250YWN0KGNvbnRhY3QpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGNvbnRhY3QuZ2V0KCdhc2snKSA9PT0gJ3N1YnNjcmliZScpIHx8IChjb250YWN0LmdldCgnc3Vic2NyaXB0aW9uJykgPT09ICdmcm9tJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRDb250YWN0VG9Hcm91cChjb250YWN0LCBIRUFERVJfUEVORElOR19DT05UQUNUUyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb250YWN0LmdldCgncmVxdWVzdGluZycpID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkQ29udGFjdFRvR3JvdXAoY29udGFjdCwgSEVBREVSX1JFUVVFU1RJTkdfQ09OVEFDVFMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuWE1QUFN0YXR1cyA9IEJhY2tib25lLk1vZGVsLmV4dGVuZCh7CiAgICAgICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0KHsKICAgICAgICAgICAgICAgICAgICAnc3RhdHVzJyA6IHRoaXMuZ2V0KCdzdGF0dXMnKSB8fCAnb25saW5lJwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLm9uKCdjaGFuZ2UnLCAkLnByb3h5KGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2V0KCdmdWxsbmFtZScpID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuZ2V0VkNhcmQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBudWxsLCAvLyBObyAndG8nIGF0dHIgd2hlbiBnZXR0aW5nIG9uZSdzIG93biB2Q2FyZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJC5wcm94eShmdW5jdGlvbiAoamlkLCBmdWxsbmFtZSwgaW1hZ2UsIGltYWdlX3R5cGUsIHVybCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2F2ZSh7J2Z1bGxuYW1lJzogZnVsbG5hbWV9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIHRoaXMpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChfLmhhcyhpdGVtLmNoYW5nZWQsICdzdGF0dXMnKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5lbWl0KCdzdGF0dXNDaGFuZ2VkJywgdGhpcy5nZXQoJ3N0YXR1cycpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKF8uaGFzKGl0ZW0uY2hhbmdlZCwgJ3N0YXR1c19tZXNzYWdlJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuZW1pdCgnc3RhdHVzTWVzc2FnZUNoYW5nZWQnLCB0aGlzLmdldCgnc3RhdHVzX21lc3NhZ2UnKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2VuZFByZXNlbmNlOiBmdW5jdGlvbiAodHlwZSkgewogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSB0aGlzLmdldCgnc3RhdHVzJykgfHwgJ29ubGluZSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgc3RhdHVzX21lc3NhZ2UgPSB0aGlzLmdldCgnc3RhdHVzX21lc3NhZ2UnKSwKICAgICAgICAgICAgICAgICAgICBwcmVzZW5jZTsKICAgICAgICAgICAgICAgIC8vIE1vc3Qgb2YgdGhlc2UgcHJlc2VuY2UgdHlwZXMgYXJlIGFjdHVhbGx5IG5vdCBleHBsaWNpdGx5IHNlbnQsCiAgICAgICAgICAgICAgICAvLyBidXQgSSBhZGQgYWxsIG9mIHRoZW0gaGVyZSBmb3JlIHJlZmVyZW5jZSBhbmQgZnV0dXJlIHByb29maW5nLgogICAgICAgICAgICAgICAgaWYgKCh0eXBlID09PSAndW5hdmFpbGFibGUnKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAodHlwZSA9PT0gJ3Byb2JlJykgfHwKICAgICAgICAgICAgICAgICAgICAgICAgKHR5cGUgPT09ICdlcnJvcicpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICh0eXBlID09PSAndW5zdWJzY3JpYmUnKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAodHlwZSA9PT0gJ3Vuc3Vic2NyaWJlZCcpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICh0eXBlID09PSAnc3Vic2NyaWJlJykgfHwKICAgICAgICAgICAgICAgICAgICAgICAgKHR5cGUgPT09ICdzdWJzY3JpYmVkJykpIHsKICAgICAgICAgICAgICAgICAgICBwcmVzZW5jZSA9ICRwcmVzKHsndHlwZSc6dHlwZX0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ29ubGluZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc2VuY2UgPSAkcHJlcygpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZXNlbmNlID0gJHByZXMoKS5jKCdzaG93JykudCh0eXBlKS51cCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdHVzX21lc3NhZ2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlc2VuY2UuYygnc3RhdHVzJykudChzdGF0dXNfbWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5zZW5kKHByZXNlbmNlKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHNldFN0YXR1czogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNlbmRQcmVzZW5jZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICB0aGlzLnNhdmUoeydzdGF0dXMnOiB2YWx1ZX0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2V0U3RhdHVzTWVzc2FnZTogZnVuY3Rpb24gKHN0YXR1c19tZXNzYWdlKSB7CiAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLnNlbmQoJHByZXMoKS5jKCdzaG93JykudCh0aGlzLmdldCgnc3RhdHVzJykpLnVwKCkuYygnc3RhdHVzJykudChzdGF0dXNfbWVzc2FnZSkpOwogICAgICAgICAgICAgICAgdGhpcy5zYXZlKHsnc3RhdHVzX21lc3NhZ2UnOiBzdGF0dXNfbWVzc2FnZX0pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMueGhyX2N1c3RvbV9zdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgICAkLmFqYXgoewogICAgICAgICAgICAgICAgICAgICAgICB1cmw6ICB0aGlzLnhocl9jdXN0b21fc3RhdHVzX3VybCwKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ1BPU1QnLAogICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiB7J21zZyc6IHN0YXR1c19tZXNzYWdlfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuWE1QUFN0YXR1c1ZpZXcgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZCh7CiAgICAgICAgICAgIGVsOiAic3BhbiN4bXBwLXN0YXR1cy1ob2xkZXIiLAoKICAgICAgICAgICAgZXZlbnRzOiB7CiAgICAgICAgICAgICAgICAiY2xpY2sgYS5jaG9vc2UteG1wcC1zdGF0dXMiOiAidG9nZ2xlT3B0aW9ucyIsCiAgICAgICAgICAgICAgICAiY2xpY2sgI2ZhbmN5LXhtcHAtc3RhdHVzLXNlbGVjdCBhLmNoYW5nZS14bXBwLXN0YXR1cy1tZXNzYWdlIjogInJlbmRlclN0YXR1c0NoYW5nZUZvcm0iLAogICAgICAgICAgICAgICAgInN1Ym1pdCAjc2V0LWN1c3RvbS14bXBwLXN0YXR1cyI6ICJzZXRTdGF0dXNNZXNzYWdlIiwKICAgICAgICAgICAgICAgICJjbGljayAuZHJvcGRvd24gZGQgdWwgbGkgYSI6ICJzZXRTdGF0dXMiCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLm9uKCJjaGFuZ2UiLCB0aGlzLnVwZGF0ZVN0YXR1c1VJLCB0aGlzKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAvLyBSZXBsYWNlIHRoZSBkZWZhdWx0IGRyb3Bkb3duIHdpdGggc29tZXRoaW5nIG5pY2VyCiAgICAgICAgICAgICAgICB2YXIgJHNlbGVjdCA9IHRoaXMuJGVsLmZpbmQoJ3NlbGVjdCNzZWxlY3QteG1wcC1zdGF0dXMnKSwKICAgICAgICAgICAgICAgICAgICBjaGF0X3N0YXR1cyA9IHRoaXMubW9kZWwuZ2V0KCdzdGF0dXMnKSB8fCAnb2ZmbGluZScsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucyA9ICQoJ29wdGlvbicsICRzZWxlY3QpLAogICAgICAgICAgICAgICAgICAgICRvcHRpb25zX3RhcmdldCwKICAgICAgICAgICAgICAgICAgICBvcHRpb25zX2xpc3QgPSBbXSwKICAgICAgICAgICAgICAgICAgICB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmh0bWwoY29udmVyc2UudGVtcGxhdGVzLmNob29zZV9zdGF0dXMoKSk7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5maW5kKCcjZmFuY3kteG1wcC1zdGF0dXMtc2VsZWN0JykKICAgICAgICAgICAgICAgICAgICAgICAgLmh0bWwoY29udmVyc2UudGVtcGxhdGVzLmNoYXRfc3RhdHVzKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXNfbWVzc2FnZSc6IHRoaXMubW9kZWwuZ2V0KCdzdGF0dXNfbWVzc2FnZScpIHx8IF9fKCJJIGFtICUxJHMiLCB0aGlzLmdldFByZXR0eVN0YXR1cyhjaGF0X3N0YXR1cykpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2NoYXRfc3RhdHVzJzogY2hhdF9zdGF0dXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGVzY19jdXN0b21fc3RhdHVzJzogX18oJ0NsaWNrIGhlcmUgdG8gd3JpdGUgYSBjdXN0b20gc3RhdHVzIG1lc3NhZ2UnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkZXNjX2NoYW5nZV9zdGF0dXMnOiBfXygnQ2xpY2sgdG8gY2hhbmdlIHlvdXIgY2hhdCBzdGF0dXMnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICAgICAgLy8gaXRlcmF0ZSB0aHJvdWdoIGFsbCB0aGUgPG9wdGlvbj4gZWxlbWVudHMgYW5kIGFkZCBvcHRpb24gdmFsdWVzCiAgICAgICAgICAgICAgICBvcHRpb25zLmVhY2goZnVuY3Rpb24gKCl7CiAgICAgICAgICAgICAgICAgICAgb3B0aW9uc19saXN0LnB1c2goY29udmVyc2UudGVtcGxhdGVzLnN0YXR1c19vcHRpb24oewogICAgICAgICAgICAgICAgICAgICAgICAndmFsdWUnOiAkKHRoaXMpLnZhbCgpLAogICAgICAgICAgICAgICAgICAgICAgICAndGV4dCc6IHRoaXMudGV4dAogICAgICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgJG9wdGlvbnNfdGFyZ2V0ID0gdGhpcy4kZWwuZmluZCgiI3RhcmdldCBkZCB1bCIpLmhpZGUoKTsKICAgICAgICAgICAgICAgICRvcHRpb25zX3RhcmdldC5hcHBlbmQob3B0aW9uc19saXN0LmpvaW4oJycpKTsKICAgICAgICAgICAgICAgICRzZWxlY3QucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHRvZ2dsZU9wdGlvbnM6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICQoZXYudGFyZ2V0KS5wYXJlbnQoKS5wYXJlbnQoKS5zaWJsaW5ncygnZGQnKS5maW5kKCd1bCcpLnRvZ2dsZSgnZmFzdCcpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVuZGVyU3RhdHVzQ2hhbmdlRm9ybTogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgdmFyIHN0YXR1c19tZXNzYWdlID0gdGhpcy5tb2RlbC5nZXQoJ3N0YXR1cycpIHx8ICdvZmZsaW5lJzsKICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9IGNvbnZlcnNlLnRlbXBsYXRlcy5jaGFuZ2Vfc3RhdHVzX21lc3NhZ2UoewogICAgICAgICAgICAgICAgICAgICdzdGF0dXNfbWVzc2FnZSc6IHN0YXR1c19tZXNzYWdlLAogICAgICAgICAgICAgICAgICAgICdsYWJlbF9jdXN0b21fc3RhdHVzJzogX18oJ0N1c3RvbSBzdGF0dXMnKSwKICAgICAgICAgICAgICAgICAgICAnbGFiZWxfc2F2ZSc6IF9fKCdTYXZlJykKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgnLnhtcHAtc3RhdHVzJykucmVwbGFjZVdpdGgoaW5wdXQpOwogICAgICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgnLmN1c3RvbS14bXBwLXN0YXR1cycpLmZvY3VzKCkuZm9jdXMoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHNldFN0YXR1c01lc3NhZ2U6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIHZhciBzdGF0dXNfbWVzc2FnZSA9ICQoZXYudGFyZ2V0KS5maW5kKCdpbnB1dCcpLnZhbCgpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5zZXRTdGF0dXNNZXNzYWdlKHN0YXR1c19tZXNzYWdlKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHNldFN0YXR1czogZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgdmFyICRlbCA9ICQoZXYudGFyZ2V0KSwKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9ICRlbC5hdHRyKCdkYXRhLXZhbHVlJyk7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09ICdsb2dvdXQnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgiLmRyb3Bkb3duIGRkIHVsIikuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmxvZ091dCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVsLnNldFN0YXR1cyh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgiLmRyb3Bkb3duIGRkIHVsIikuaGlkZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgZ2V0UHJldHR5U3RhdHVzOiBmdW5jdGlvbiAoc3RhdCkgewogICAgICAgICAgICAgICAgdmFyIHByZXR0eV9zdGF0dXM7CiAgICAgICAgICAgICAgICBpZiAoc3RhdCA9PT0gJ2NoYXQnKSB7CiAgICAgICAgICAgICAgICAgICAgcHJldHR5X3N0YXR1cyA9IF9fKCdvbmxpbmUnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdCA9PT0gJ2RuZCcpIHsKICAgICAgICAgICAgICAgICAgICBwcmV0dHlfc3RhdHVzID0gX18oJ2J1c3knKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdCA9PT0gJ3hhJykgewogICAgICAgICAgICAgICAgICAgIHByZXR0eV9zdGF0dXMgPSBfXygnYXdheSBmb3IgbG9uZycpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ID09PSAnYXdheScpIHsKICAgICAgICAgICAgICAgICAgICBwcmV0dHlfc3RhdHVzID0gX18oJ2F3YXknKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcHJldHR5X3N0YXR1cyA9IF9fKHN0YXQpIHx8IF9fKCdvbmxpbmUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBwcmV0dHlfc3RhdHVzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgdXBkYXRlU3RhdHVzVUk6IGZ1bmN0aW9uIChtb2RlbCkgewogICAgICAgICAgICAgICAgaWYgKCEoXy5oYXMobW9kZWwuY2hhbmdlZCwgJ3N0YXR1cycpKSAmJiAhKF8uaGFzKG1vZGVsLmNoYW5nZWQsICdzdGF0dXNfbWVzc2FnZScpKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBzdGF0ID0gbW9kZWwuZ2V0KCdzdGF0dXMnKTsKICAgICAgICAgICAgICAgIC8vICMgRm9yIHRyYW5zbGF0b3JzOiB0aGUgJTEkcyBwYXJ0IGdldHMgcmVwbGFjZWQgd2l0aCB0aGUgc3RhdHVzCiAgICAgICAgICAgICAgICAvLyAjIEV4YW1wbGUsIEkgYW0gb25saW5lCiAgICAgICAgICAgICAgICB2YXIgc3RhdHVzX21lc3NhZ2UgPSBtb2RlbC5nZXQoJ3N0YXR1c19tZXNzYWdlJykgfHwgX18oIkkgYW0gJTEkcyIsIHRoaXMuZ2V0UHJldHR5U3RhdHVzKHN0YXQpKTsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmZpbmQoJyNmYW5jeS14bXBwLXN0YXR1cy1zZWxlY3QnKS5odG1sKAogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLnRlbXBsYXRlcy5jaGF0X3N0YXR1cyh7CiAgICAgICAgICAgICAgICAgICAgICAgICdjaGF0X3N0YXR1cyc6IHN0YXQsCiAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXNfbWVzc2FnZSc6IHN0YXR1c19tZXNzYWdlLAogICAgICAgICAgICAgICAgICAgICAgICAnZGVzY19jdXN0b21fc3RhdHVzJzogX18oJ0NsaWNrIGhlcmUgdG8gd3JpdGUgYSBjdXN0b20gc3RhdHVzIG1lc3NhZ2UnKSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2Rlc2NfY2hhbmdlX3N0YXR1cyc6IF9fKCdDbGljayB0byBjaGFuZ2UgeW91ciBjaGF0IHN0YXR1cycpCiAgICAgICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuQk9TSFNlc3Npb24gPSBCYWNrYm9uZS5Nb2RlbDsKICAgICAgICB0aGlzLkZlYXR1cmUgPSBCYWNrYm9uZS5Nb2RlbDsKICAgICAgICB0aGlzLkZlYXR1cmVzID0gQmFja2JvbmUuQ29sbGVjdGlvbi5leHRlbmQoewogICAgICAgICAgICAvKiBTZXJ2aWNlIERpc2NvdmVyeQogICAgICAgICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgICAgICogVGhpcyBjb2xsZWN0aW9uIHN0b3JlcyBGZWF0dXJlIE1vZGVscywgcmVwcmVzZW50aW5nIGZlYXR1cmVzCiAgICAgICAgICAgICogcHJvdmlkZWQgYnkgYXZhaWxhYmxlIFhNUFAgZW50aXRpZXMgKGUuZy4gc2VydmVycykKICAgICAgICAgICAgKiBTZWUgWEVQLTAwMzAgZm9yIG1vcmUgZGV0YWlsczogaHR0cDovL3htcHAub3JnL2V4dGVuc2lvbnMveGVwLTAwMzAuaHRtbAogICAgICAgICAgICAqIEFsbCBmZWF0dXJlcyBhcmUgc2hvd24gaGVyZTogaHR0cDovL3htcHAub3JnL3JlZ2lzdHJhci9kaXNjby1mZWF0dXJlcy5odG1sCiAgICAgICAgICAgICovCiAgICAgICAgICAgIG1vZGVsOiBjb252ZXJzZS5GZWF0dXJlLAogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFkZENsaWVudElkZW50aXRpZXMoKS5hZGRDbGllbnRGZWF0dXJlcygpOwogICAgICAgICAgICAgICAgdGhpcy5icm93c2VyU3RvcmFnZSA9IG5ldyBCYWNrYm9uZS5Ccm93c2VyU3RvcmFnZVtjb252ZXJzZS5zdG9yYWdlXSgKICAgICAgICAgICAgICAgICAgICBiNjRfc2hhMSgnY29udmVyc2UuZmVhdHVyZXMnK2NvbnZlcnNlLmJhcmVfamlkKSk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5icm93c2VyU3RvcmFnZS5yZWNvcmRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIC8vIGJyb3dzZXJTdG9yYWdlIGlzIGVtcHR5LCBzbyB3ZSd2ZSBsaWtlbHkgbmV2ZXIgcXVlcmllZCB0aGlzCiAgICAgICAgICAgICAgICAgICAgLy8gZG9tYWluIGZvciBmZWF0dXJlcyB5ZXQKICAgICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLmRpc2NvLmluZm8oY29udmVyc2UuZG9tYWluLCBudWxsLCAkLnByb3h5KHRoaXMub25JbmZvLCB0aGlzKSk7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5kaXNjby5pdGVtcyhjb252ZXJzZS5kb21haW4sIG51bGwsICQucHJveHkodGhpcy5vbkl0ZW1zLCB0aGlzKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZmV0Y2goe2FkZDp0cnVlfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBhZGRDbGllbnRJZGVudGl0aWVzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAvKiBTZWUgaHR0cDovL3htcHAub3JnL3JlZ2lzdHJhci9kaXNjby1jYXRlZ29yaWVzLmh0bWwKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24uZGlzY28uYWRkSWRlbnRpdHkoJ2NsaWVudCcsICd3ZWInLCAnQ29udmVyc2UuanMnKTsKICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGFkZENsaWVudEZlYXR1cmVzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAvKiBUaGUgc3Ryb3BoZS5kaXNjby5qcyBwbHVnaW4ga2VlcHMgYSBsaXN0IG9mIGZlYXR1cmVzIHdoaWNoCiAgICAgICAgICAgICAgICAgKiBpdCB3aWxsIGFkdmVydGlzZSB0byBhbnkgI2luZm8gcXVlcmllcyBtYWRlIHRvIGl0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFNlZTogaHR0cDovL3htcHAub3JnL2V4dGVuc2lvbnMveGVwLTAwMzAuaHRtbCNpbmZvCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVE9ETzogdGhlc2UgZmVhdHVyZXMgbmVlZCB0byBiZSBhZGRlZCBpbiB0aGUgcmVsZXZhbnQKICAgICAgICAgICAgICAgICAqIGZlYXR1cmUtcHJvdmlkaW5nIE1vZGVscywgbm90IGhlcmUKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24uZGlzY28uYWRkRmVhdHVyZSgnaHR0cDovL2phYmJlci5vcmcvcHJvdG9jb2wvY2hhdHN0YXRlcycpOyAvLyBMaW1pdGVkIHN1cHBvcnQKICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLmRpc2NvLmFkZEZlYXR1cmUoJ2h0dHA6Ly9qYWJiZXIub3JnL3Byb3RvY29sL3Jvc3RlcngnKTsgLy8gTGltaXRlZCBzdXBwb3J0CiAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5kaXNjby5hZGRGZWF0dXJlKCdqYWJiZXI6eDpjb25mZXJlbmNlJyk7CiAgICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5kaXNjby5hZGRGZWF0dXJlKCd1cm46eG1wcDpjYXJib25zOjInKTsKICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLmRpc2NvLmFkZEZlYXR1cmUoJ3ZjYXJkLXRlbXAnKTsKICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLmRpc2NvLmFkZEZlYXR1cmUoU3Ryb3BoZS5OUy5CT1NIKTsKICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLmRpc2NvLmFkZEZlYXR1cmUoU3Ryb3BoZS5OUy5ESVNDT19JTkZPKTsKICAgICAgICAgICAgICAgICBjb252ZXJzZS5jb25uZWN0aW9uLmRpc2NvLmFkZEZlYXR1cmUoU3Ryb3BoZS5OUy5NVUMpOwogICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25JdGVtczogZnVuY3Rpb24gKHN0YW56YSkgewogICAgICAgICAgICAgICAgJChzdGFuemEpLmZpbmQoJ3F1ZXJ5IGl0ZW0nKS5lYWNoKCQucHJveHkoZnVuY3Rpb24gKGlkeCwgaXRlbSkgewogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmNvbm5lY3Rpb24uZGlzY28uaW5mbygKICAgICAgICAgICAgICAgICAgICAgICAgJChpdGVtKS5hdHRyKCdqaWQnKSwKICAgICAgICAgICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgJC5wcm94eSh0aGlzLm9uSW5mbywgdGhpcykpOwogICAgICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25JbmZvOiBmdW5jdGlvbiAoc3RhbnphKSB7CiAgICAgICAgICAgICAgICB2YXIgJHN0YW56YSA9ICQoc3RhbnphKTsKICAgICAgICAgICAgICAgIGlmICgoJHN0YW56YS5maW5kKCdpZGVudGl0eVtjYXRlZ29yeT1zZXJ2ZXJdW3R5cGU9aW1dJykubGVuZ3RoID09PSAwKSAmJgogICAgICAgICAgICAgICAgICAgICgkc3RhbnphLmZpbmQoJ2lkZW50aXR5W2NhdGVnb3J5PWNvbmZlcmVuY2VdW3R5cGU9dGV4dF0nKS5sZW5ndGggPT09IDApKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpc24ndCBhbiBJTSBzZXJ2ZXIgY29tcG9uZW50CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJHN0YW56YS5maW5kKCdmZWF0dXJlJykuZWFjaCgkLnByb3h5KGZ1bmN0aW9uIChpZHgsIGZlYXR1cmUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICd2YXInOiAkKGZlYXR1cmUpLmF0dHIoJ3ZhcicpLAogICAgICAgICAgICAgICAgICAgICAgICAnZnJvbSc6ICRzdGFuemEuYXR0cignZnJvbScpCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9LCB0aGlzKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5Mb2dpblBhbmVsID0gQmFja2JvbmUuVmlldy5leHRlbmQoewogICAgICAgICAgICB0YWdOYW1lOiAnZGl2JywKICAgICAgICAgICAgaWQ6ICJsb2dpbi1kaWFsb2ciLAogICAgICAgICAgICBldmVudHM6IHsKICAgICAgICAgICAgICAgICdzdWJtaXQgZm9ybSNjb252ZXJzZS1sb2dpbic6ICdhdXRoZW50aWNhdGUnCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBjb25uZWN0OiBmdW5jdGlvbiAoJGZvcm0sIGppZCwgcGFzc3dvcmQpIHsKICAgICAgICAgICAgICAgIGlmICgkZm9ybSkgewogICAgICAgICAgICAgICAgICAgICRmb3JtLmZpbmQoJ2lucHV0W3R5cGU9c3VibWl0XScpLmhpZGUoKS5hZnRlcignPHNwYW4gY2xhc3M9InNwaW5uZXIgbG9naW4tc3VibWl0Ii8+Jyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgcmVzb3VyY2UgPSBTdHJvcGhlLmdldFJlc291cmNlRnJvbUppZChqaWQpOwogICAgICAgICAgICAgICAgaWYgKCFyZXNvdXJjZSkgewogICAgICAgICAgICAgICAgICAgIGppZCArPSAnL2NvbnZlcnNlLmpzLScgKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkqMTM5NzQ5ODI1KS50b1N0cmluZygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29udmVyc2UuY29ubmVjdGlvbi5jb25uZWN0KGppZCwgcGFzc3dvcmQsIGNvbnZlcnNlLm9uQ29ubmVjdCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoY2ZnKSB7CiAgICAgICAgICAgICAgICBjZmcuJHBhcmVudC5odG1sKHRoaXMuJGVsLmh0bWwoCiAgICAgICAgICAgICAgICAgICAgY29udmVyc2UudGVtcGxhdGVzLmxvZ2luX3BhbmVsKHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2xhYmVsX3VzZXJuYW1lJzogX18oJ1hNUFAvSmFiYmVyIFVzZXJuYW1lOicpLAogICAgICAgICAgICAgICAgICAgICAgICAnbGFiZWxfcGFzc3dvcmQnOiBfXygnUGFzc3dvcmQ6JyksCiAgICAgICAgICAgICAgICAgICAgICAgICdsYWJlbF9sb2dpbic6IF9fKCdMb2cgSW4nKQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgICAgIHRoaXMuJHRhYnMgPSBjZmcuJHBhcmVudC5wYXJlbnQoKS5maW5kKCcjY29udHJvbGJveC10YWJzJyk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMuJHRhYnMuYXBwZW5kKGNvbnZlcnNlLnRlbXBsYXRlcy5sb2dpbl90YWIoe2xhYmVsX3NpZ25faW46IF9fKCdTaWduIGluJyl9KSk7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5maW5kKCdpbnB1dCNqaWQnKS5mb2N1cygpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBhdXRoZW50aWNhdGU6IGZ1bmN0aW9uIChldikgewogICAgICAgICAgICAgICAgaWYgKGV2ICYmIGV2LnByZXZlbnREZWZhdWx0KSB7IGV2LnByZXZlbnREZWZhdWx0KCk7IH0KICAgICAgICAgICAgICAgIHZhciAkZm9ybSA9ICQoZXYudGFyZ2V0KSwKICAgICAgICAgICAgICAgICAgICAkamlkX2lucHV0ID0gJGZvcm0uZmluZCgnaW5wdXRbbmFtZT1qaWRdJyksCiAgICAgICAgICAgICAgICAgICAgamlkID0gJGppZF9pbnB1dC52YWwoKSwKICAgICAgICAgICAgICAgICAgICAkcHdfaW5wdXQgPSAkZm9ybS5maW5kKCdpbnB1dFtuYW1lPXBhc3N3b3JkXScpLAogICAgICAgICAgICAgICAgICAgIHBhc3N3b3JkID0gJHB3X2lucHV0LnZhbCgpLAogICAgICAgICAgICAgICAgICAgICRic3VfaW5wdXQgPSBudWxsLAogICAgICAgICAgICAgICAgICAgIGVycm9ycyA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIGlmICghIGNvbnZlcnNlLmJvc2hfc2VydmljZV91cmwpIHsKICAgICAgICAgICAgICAgICAgICAkYnN1X2lucHV0ID0gJGZvcm0uZmluZCgnaW5wdXQjYm9zaF9zZXJ2aWNlX3VybCcpOwogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLmJvc2hfc2VydmljZV91cmwgPSAkYnN1X2lucHV0LnZhbCgpOwogICAgICAgICAgICAgICAgICAgIGlmICghIGNvbnZlcnNlLmJvc2hfc2VydmljZV91cmwpICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9ycyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICRic3VfaW5wdXQuYWRkQ2xhc3MoJ2Vycm9yJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCEgamlkKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAkamlkX2lucHV0LmFkZENsYXNzKCdlcnJvcicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCEgcGFzc3dvcmQpICB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAkcHdfaW5wdXQuYWRkQ2xhc3MoJ2Vycm9yJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXJyb3JzKSB7IHJldHVybjsgfQogICAgICAgICAgICAgICAgdGhpcy5jb25uZWN0KCRmb3JtLCBqaWQsIHBhc3N3b3JkKTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy4kdGFicy5lbXB0eSgpOwogICAgICAgICAgICAgICAgdGhpcy4kZWwucGFyZW50KCkuZW1wdHkoKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLkNvbnRyb2xCb3hUb2dnbGUgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZCh7CiAgICAgICAgICAgIHRhZ05hbWU6ICdhJywKICAgICAgICAgICAgY2xhc3NOYW1lOiAndG9nZ2xlLWNvbnRyb2xib3gnLAogICAgICAgICAgICBpZDogJ3RvZ2dsZS1jb250cm9sYm94JywKICAgICAgICAgICAgZXZlbnRzOiB7CiAgICAgICAgICAgICAgICAnY2xpY2snOiAnb25DbGljaycKICAgICAgICAgICAgfSwKICAgICAgICAgICAgYXR0cmlidXRlczogewogICAgICAgICAgICAgICAgJ2hyZWYnOiAiIyIKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICQoJyNjb252ZXJzZWpzJykucHJlcGVuZCh0aGlzLiRlbC5odG1sKAogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNlLnRlbXBsYXRlcy5jb250cm9sYm94X3RvZ2dsZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICdsYWJlbF90b2dnbGUnOiBfXygnVG9nZ2xlIGNoYXQnKQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgICAgIC8vIFdlIGxldCB0aGUgcmVuZGVyIG1ldGhvZCBvZiBDb250cm9sQm94VmlldyBkZWNpZGUgd2hldGhlcgogICAgICAgICAgICAgICAgLy8gdGhlIENvbnRyb2xCb3ggb3IgdGhlIFRvZ2dsZSBtdXN0IGJlIHNob3duLiBUaGlzIHByZXZlbnRzCiAgICAgICAgICAgICAgICAvLyBhcnRpZmFjdHMgKGkuZS4gb24gcGFnZSBsb2FkIHRoZSB0b2dnbGUgaXMgc2hvd24gb25seSB0byB0aGVuCiAgICAgICAgICAgICAgICAvLyBzZWNvbmRzIGxhdGVyIGJlIGhpZGRlbiBpbiBmYXZvciBvZiB0aGUgY29udHJvbCBib3gpLgogICAgICAgICAgICAgICAgdGhpcy4kZWwuaGlkZSgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBoaWRlOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLmZhZGVPdXQoJ2Zhc3QnLCBjYWxsYmFjayk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzaG93OiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLnNob3coJ2Zhc3QnLCBjYWxsYmFjayk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzaG93Q29udHJvbEJveDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGNvbnRyb2xib3ggPSBjb252ZXJzZS5jaGF0Ym94ZXMuZ2V0KCdjb250cm9sYm94Jyk7CiAgICAgICAgICAgICAgICBpZiAoIWNvbnRyb2xib3gpIHsKICAgICAgICAgICAgICAgICAgICBjb250cm9sYm94ID0gY29udmVyc2UuYWRkQ29udHJvbEJveCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGNvbnZlcnNlLmNvbm5lY3Rpb24uY29ubmVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgY29udHJvbGJveC5zYXZlKHtjbG9zZWQ6IGZhbHNlfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbnRyb2xib3gudHJpZ2dlcignc2hvdycpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgb25DbGljazogZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIGlmICgkKCJkaXYjY29udHJvbGJveCIpLmlzKCc6dmlzaWJsZScpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRyb2xib3ggPSBjb252ZXJzZS5jaGF0Ym94ZXMuZ2V0KCdjb250cm9sYm94Jyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnZlcnNlLmNvbm5lY3Rpb24uY29ubmVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xib3guc2F2ZSh7Y2xvc2VkOiB0cnVlfSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGJveC50cmlnZ2VyKCdoaWRlJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dDb250cm9sQm94KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5hZGRDb250cm9sQm94ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jaGF0Ym94ZXMuYWRkKHsKICAgICAgICAgICAgICAgIGlkOiAnY29udHJvbGJveCcsCiAgICAgICAgICAgICAgICBib3hfaWQ6ICdjb250cm9sYm94JywKICAgICAgICAgICAgICAgIGhlaWdodDogdGhpcy5kZWZhdWx0X2JveF9oZWlnaHQsCiAgICAgICAgICAgICAgICBjbG9zZWQ6ICF0aGlzLnNob3dfY29udHJvbGJveF9ieV9kZWZhdWx0CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIHRoaXMuaW5pdENvbm5lY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciByaWQsIHNpZCwgamlkOwogICAgICAgICAgICBpZiAodGhpcy5jb25uZWN0aW9uICYmIHRoaXMuY29ubmVjdGlvbi5jb25uZWN0ZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMub25Db25uZWN0ZWQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFhYWDogaXQncyBub3QgeWV0IGNsZWFyIHdoYXQgdGhlIG9yZGVyIG9mIHByZWZlcmVuY2Ugc2hvdWxkCiAgICAgICAgICAgICAgICAvLyBiZSBiZXR3ZWVuIFJJRCBhbmQgU0lEIHJlY2VpdmVkIHZpYSB0aGUgaW5pdGlhbGl6ZSBtZXRob2Qgb3IKICAgICAgICAgICAgICAgIC8vIHRob3NlIHJlY2VpdmVkIGZyb20gc2Vzc2lvblN0b3JhZ2UuCiAgICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgICAgLy8gV2hhdCBkbyB5b3Ugd2UgaWYgd2UgcmVjZWl2ZSB2YWx1ZXMgZnJvbSBib3RoIGF2ZW51ZXM/CiAgICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgICAgLy8gQWxzbywgd2hhdCBkbyB3ZSBkbyB3aGVuIHRoZSBrZWVwYWxpdmUgc2Vzc2lvbiB2YWx1ZXMgYXJlCiAgICAgICAgICAgICAgICAvLyBleHBpcmVkPyBEbyB3ZSB0cnkgdG8gZmFsbCBiYWNrPwogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvc2hfc2VydmljZV91cmwpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdygiRXJyb3I6IHlvdSBtdXN0IHN1cHBseSBhIHZhbHVlIGZvciB0aGUgYm9zaF9zZXJ2aWNlX3VybCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5jb25uZWN0aW9uID0gbmV3IFN0cm9waGUuQ29ubmVjdGlvbih0aGlzLmJvc2hfc2VydmljZV91cmwpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByZWJpbmQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5qaWQgJiYgdGhpcy5zaWQgJiYgdGhpcy5yaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb25uZWN0aW9uLmF0dGFjaCh0aGlzLmppZCwgdGhpcy5zaWQsIHRoaXMucmlkLCB0aGlzLm9uQ29ubmVjdCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5rZWVwYWxpdmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3coIklmIHlvdSB1c2UgcHJlYmluZCBhbmQgZG9uJ3QgdXNlIGtlZXBhbGl2ZSwgIisKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRoZW4geW91IE1VU1Qgc3VwcGx5IEpJRCwgUklEIGFuZCBTSUQgdmFsdWVzIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRoaXMua2VlcGFsaXZlKSB7CiAgICAgICAgICAgICAgICAgICAgcmlkID0gdGhpcy5zZXNzaW9uLmdldCgncmlkJyk7CiAgICAgICAgICAgICAgICAgICAgc2lkID0gdGhpcy5zZXNzaW9uLmdldCgnc2lkJyk7CiAgICAgICAgICAgICAgICAgICAgamlkID0gdGhpcy5zZXNzaW9uLmdldCgnamlkJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJpZCAmJiBqaWQgJiYgc2lkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2Vzc2lvbi5zYXZlKHtyaWQ6IHJpZH0pOyAvLyBUaGUgUklEIG5lZWRzIHRvIGJlIGluY3JlYXNlZCB3aXRoIGVhY2ggcmVxdWVzdC4KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb25uZWN0aW9uLmF0dGFjaChqaWQsIHNpZCwgcmlkLCB0aGlzLm9uQ29ubmVjdCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnByZWJpbmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY29ubmVjdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdub1Jlc3VtZWFibGVTZXNzaW9uJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5fdGVhckRvd24gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIC8qIFJlbW92ZSB0aG9zZSB2aWV3cyB3aGljaCBhcmUgb25seSBhbGxvd2VkIHdpdGggYSB2YWxpZAogICAgICAgICAgICAgKiBjb25uZWN0aW9uLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdGhpcy5pbml0aWFsX3ByZXNlbmNlX3NlbnQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5yb3N0ZXIub2ZmKCkucmVzZXQoKTsgLy8gUmVtb3ZlcyByb3N0ZXIgY29udGFjdHMKICAgICAgICAgICAgdGhpcy5jb25uZWN0aW9uLnJvc3Rlci5fY2FsbGJhY2tzID0gW107IC8vIFJlbW92ZSBhbGwgUm9zdGVyIGhhbmRsZXJzIChlLmcuIHJvc3RlckhhbmRsZXIpCiAgICAgICAgICAgIHRoaXMucm9zdGVydmlldy5tb2RlbC5vZmYoKS5yZXNldCgpOyAvLyBSZW1vdmVzIHJvc3RlciBncm91cHMKICAgICAgICAgICAgdGhpcy5yb3N0ZXJ2aWV3LnVuZGVsZWdhdGVFdmVudHMoKS5yZW1vdmUoKTsKICAgICAgICAgICAgdGhpcy5jaGF0Ym94ZXMucmVtb3ZlKCk7IC8vIERvbid0IGNhbGwgb2ZmKCksIGV2ZW50cyB3b24ndCBnZXQgcmUtcmVnaXN0ZXJlZCB1cG9uIHJlY29ubmVjdC4KICAgICAgICAgICAgaWYgKHRoaXMuZmVhdHVyZXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuZmVhdHVyZXMucmVzZXQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5taW5pbWl6ZWRfY2hhdHMpIHsKICAgICAgICAgICAgICAgIHRoaXMubWluaW1pemVkX2NoYXRzLnVuZGVsZWdhdGVFdmVudHMoKS5tb2RlbC5yZXNldCgpOwogICAgICAgICAgICAgICAgdGhpcy5taW5pbWl6ZWRfY2hhdHMucmVtb3ZlQWxsKCk7IC8vIFJlbW92ZSBzdWItdmlld3MKICAgICAgICAgICAgICAgIHRoaXMubWluaW1pemVkX2NoYXRzLnRlYXJEb3duKCkucmVtb3ZlKCk7IC8vIFJlbW92ZSBvdmVydmlldwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMubWluaW1pemVkX2NoYXRzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CgogICAgICAgIHRoaXMuX2luaXRpYWxpemUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMuY2hhdGJveGVzID0gbmV3IHRoaXMuQ2hhdEJveGVzKCk7CiAgICAgICAgICAgIHRoaXMuY2hhdGJveHZpZXdzID0gbmV3IHRoaXMuQ2hhdEJveFZpZXdzKHttb2RlbDogdGhpcy5jaGF0Ym94ZXN9KTsKICAgICAgICAgICAgdGhpcy5jb250cm9sYm94dG9nZ2xlID0gbmV3IHRoaXMuQ29udHJvbEJveFRvZ2dsZSgpOwogICAgICAgICAgICB0aGlzLm90ciA9IG5ldyB0aGlzLk9UUigpOwogICAgICAgICAgICB0aGlzLmluaXRTZXNzaW9uKCk7CiAgICAgICAgICAgIHRoaXMuaW5pdENvbm5lY3Rpb24oKTsKICAgICAgICAgICAgaWYgKHRoaXMuY29ubmVjdGlvbikgewogICAgICAgICAgICAgICAgdGhpcy5hZGRDb250cm9sQm94KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5faW5pdGlhbGl6ZVBsdWdpbnMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIF8uZWFjaCh0aGlzLnBsdWdpbnMsICQucHJveHkoZnVuY3Rpb24gKHBsdWdpbikgewogICAgICAgICAgICAgICAgJC5wcm94eShwbHVnaW4sIHRoaXMpKHRoaXMpOwogICAgICAgICAgICB9LCB0aGlzKSk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gSW5pdGlhbGl6YXRpb24KICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLQogICAgICAgIC8vIFRoaXMgaXMgdGhlIGVuZCBvZiB0aGUgaW5pdGlhbGl6ZSBtZXRob2QuCiAgICAgICAgdGhpcy5faW5pdGlhbGl6ZVBsdWdpbnMoKTsKICAgICAgICB0aGlzLl9pbml0aWFsaXplKCk7CiAgICAgICAgdGhpcy5yZWdpc3Rlckdsb2JhbEV2ZW50SGFuZGxlcnMoKTsKICAgICAgICBjb252ZXJzZS5lbWl0KCdpbml0aWFsaXplZCcpOwogICAgfTsKCiAgICB2YXIgd3JhcHBlZENoYXRCb3ggPSBmdW5jdGlvbiAoY2hhdGJveCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICdlbmRPVFInOiAkLnByb3h5KGNoYXRib3guZW5kT1RSLCBjaGF0Ym94KSwKICAgICAgICAgICAgJ2dldCc6ICQucHJveHkoY2hhdGJveC5nZXQsIGNoYXRib3gpLAogICAgICAgICAgICAnaW5pdGlhdGVPVFInOiAkLnByb3h5KGNoYXRib3guaW5pdGlhdGVPVFIsIGNoYXRib3gpLAogICAgICAgICAgICAnbWF4aW1pemUnOiAkLnByb3h5KGNoYXRib3gubWF4aW1pemUsIGNoYXRib3gpLAogICAgICAgICAgICAnbWluaW1pemUnOiAkLnByb3h5KGNoYXRib3gubWluaW1pemUsIGNoYXRib3gpLAogICAgICAgICAgICAnc2V0JzogJC5wcm94eShjaGF0Ym94LnNldCwgY2hhdGJveCkKICAgICAgICB9OwogICAgfTsKICAgIHJldHVybiB7CiAgICAgICAgJ2dldEJ1ZGR5JzogZnVuY3Rpb24gKGppZCkgewogICAgICAgICAgICB2YXIgY29udGFjdCA9IGNvbnZlcnNlLnJvc3Rlci5nZXQoU3Ryb3BoZS5nZXRCYXJlSmlkRnJvbUppZChqaWQpKTsKICAgICAgICAgICAgaWYgKGNvbnRhY3QpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjb250YWN0LmF0dHJpYnV0ZXM7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICdnZXRDaGF0Qm94JzogZnVuY3Rpb24gKGppZCkgewogICAgICAgICAgICB2YXIgY2hhdGJveCA9IGNvbnZlcnNlLmNoYXRib3hlcy5nZXQoamlkKTsKICAgICAgICAgICAgaWYgKGNoYXRib3gpIHsKICAgICAgICAgICAgICAgIHJldHVybiB3cmFwcGVkQ2hhdEJveChjaGF0Ym94KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgJ2dldFJJRCc6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKGNvbnZlcnNlLmV4cG9zZV9yaWRfYW5kX3NpZCAmJiB0eXBlb2YgY29udmVyc2UuY29ubmVjdGlvbiAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjb252ZXJzZS5jb25uZWN0aW9uLnJpZCB8fCBjb252ZXJzZS5jb25uZWN0aW9uLl9wcm90by5yaWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfSwKICAgICAgICAnZ2V0U0lEJzogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoY29udmVyc2UuZXhwb3NlX3JpZF9hbmRfc2lkICYmIHR5cGVvZiBjb252ZXJzZS5jb25uZWN0aW9uICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnZlcnNlLmNvbm5lY3Rpb24uc2lkIHx8IGNvbnZlcnNlLmNvbm5lY3Rpb24uX3Byb3RvLnNpZDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9LAogICAgICAgICdpbml0aWFsaXplJzogZnVuY3Rpb24gKHNldHRpbmdzLCBjYWxsYmFjaykgewogICAgICAgICAgICBjb252ZXJzZS5pbml0aWFsaXplKHNldHRpbmdzLCBjYWxsYmFjayk7CiAgICAgICAgfSwKICAgICAgICAnalF1ZXJ5JzogJCwKICAgICAgICAnb3BlbkNoYXRCb3gnOiBmdW5jdGlvbiAoamlkKSB7CiAgICAgICAgICAgIHZhciBjb250YWN0ID0gY29udmVyc2Uucm9zdGVyLmdldChTdHJvcGhlLmdldEJhcmVKaWRGcm9tSmlkKGppZCkpOwogICAgICAgICAgICBpZiAoY29udGFjdCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHdyYXBwZWRDaGF0Qm94KGNvbnZlcnNlLmNoYXRib3h2aWV3cy5zaG93Q2hhdChjb250YWN0LmF0dHJpYnV0ZXMpKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgJ29uY2UnOiBmdW5jdGlvbiAoZXZ0LCBoYW5kbGVyKSB7CiAgICAgICAgICAgIGNvbnZlcnNlLm9uY2UoZXZ0LCBoYW5kbGVyKTsKICAgICAgICB9LAogICAgICAgICdvbic6IGZ1bmN0aW9uIChldnQsIGhhbmRsZXIpIHsKICAgICAgICAgICAgY29udmVyc2Uub24oZXZ0LCBoYW5kbGVyKTsKICAgICAgICB9LAogICAgICAgICdvZmYnOiBmdW5jdGlvbiAoZXZ0LCBoYW5kbGVyKSB7CiAgICAgICAgICAgIGNvbnZlcnNlLm9mZihldnQsIGhhbmRsZXIpOwogICAgICAgIH0sCiAgICAgICAgJ3JlZ2lzdGVyUGx1Z2luJzogZnVuY3Rpb24gKG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGNvbnZlcnNlLnBsdWdpbnNbbmFtZV0gPSBjYWxsYmFjazsKICAgICAgICB9CiAgICB9Owp9KSk7CgpyZXF1aXJlLmNvbmZpZyh7CiAgICBiYXNlVXJsOiAnLicsCiAgICBwYXRoczogewogICAgICAgICJiYWNrYm9uZSI6ICAgICAgICAgICAgICAgICAiY29tcG9uZW50cy9iYWNrYm9uZS9iYWNrYm9uZSIsCiAgICAgICAgImJhY2tib25lLmJyb3dzZXJTdG9yYWdlIjogICJjb21wb25lbnRzL2JhY2tib25lLmJyb3dzZXJTdG9yYWdlL2JhY2tib25lLmJyb3dzZXJTdG9yYWdlIiwKICAgICAgICAiYmFja2JvbmUub3ZlcnZpZXciOiAgICAgICAgImNvbXBvbmVudHMvYmFja2JvbmUub3ZlcnZpZXcvYmFja2JvbmUub3ZlcnZpZXciLAogICAgICAgICJib290c3RyYXAiOiAgICAgICAgICAgICAgICAiY29tcG9uZW50cy9ib290c3RyYXAvZGlzdC9qcy9ib290c3RyYXAiLCAgICAgICAgICAgLy8gWFhYOiBPbmx5IHJlcXVpcmVkIGZvciBodHRwczovL2NvbnZlcnNlanMub3JnIHdlYnNpdGUKICAgICAgICAiYm9vdHN0cmFwSlMiOiAgICAgICAgICAgICAgImNvbXBvbmVudHMvYm9vdHN0cmFwSlMvaW5kZXgiLCAgICAgICAgICAgICAgICAgICAgIC8vIFhYWDogT25seSByZXF1aXJlZCBmb3IgaHR0cHM6Ly9jb252ZXJzZWpzLm9yZyB3ZWJzaXRlCiAgICAgICAgImNvbnZlcnNlLWRlcGVuZGVuY2llcyI6ICAgICJzcmMvZGVwcy13ZWJzaXRlIiwKICAgICAgICAiY29udmVyc2UtdGVtcGxhdGVzIjogICAgICAgInNyYy90ZW1wbGF0ZXMiLAogICAgICAgICJldmVudGVtaXR0ZXIiOiAgICAgICAgICAgICAiY29tcG9uZW50cy9vdHIvYnVpbGQvZGVwL2V2ZW50ZW1pdHRlciIsCiAgICAgICAgImpxdWVyeSI6ICAgICAgICAgICAgICAgICAgICJjb21wb25lbnRzL2pxdWVyeS9kaXN0L2pxdWVyeSIsCiAgICAgICAgImpxdWVyeS1wcml2YXRlIjogICAgICAgICAgICJzcmMvanF1ZXJ5LXByaXZhdGUiLAogICAgICAgICJqcXVlcnkuYnJvd3NlciI6ICAgICAgICAgICAiY29tcG9uZW50cy9qcXVlcnkuYnJvd3Nlci9pbmRleCIsCiAgICAgICAgImpxdWVyeS5lYXNpbmciOiAgICAgICAgICAgICJjb21wb25lbnRzL2pxdWVyeS1lYXNpbmctb3JpZ2luYWwvaW5kZXgiLCAgICAgICAgICAvLyBYWFg6IE9ubHkgcmVxdWlyZWQgZm9yIGh0dHBzOi8vY29udmVyc2Vqcy5vcmcgd2Vic2l0ZQogICAgICAgICJtb21lbnQiOiAgICAgICAgICAgICAgICAgICAiY29tcG9uZW50cy9tb21lbnRqcy9tb21lbnQiLAogICAgICAgICJzdHJvcGhlIjogICAgICAgICAgICAgICAgICAiY29tcG9uZW50cy9zdHJvcGhlL3N0cm9waGUiLAogICAgICAgICJzdHJvcGhlLmRpc2NvIjogICAgICAgICAgICAiY29tcG9uZW50cy9zdHJvcGhlanMtcGx1Z2lucy9kaXNjby9zdHJvcGhlLmRpc2NvIiwKICAgICAgICAic3Ryb3BoZS5tdWMiOiAgICAgICAgICAgICAgImNvbXBvbmVudHMvc3Ryb3BoZS5tdWMvaW5kZXgiLAogICAgICAgICJzdHJvcGhlLnJvc3RlciI6ICAgICAgICAgICAic3JjL3N0cm9waGUucm9zdGVyIiwKICAgICAgICAic3Ryb3BoZS52Y2FyZCI6ICAgICAgICAgICAgImNvbXBvbmVudHMvc3Ryb3BoZWpzLXBsdWdpbnMvdmNhcmQvc3Ryb3BoZS52Y2FyZCIsCiAgICAgICAgInRleHQiOiAgICAgICAgICAgICAgICAgICAgICdjb21wb25lbnRzL3JlcXVpcmVqcy10ZXh0L3RleHQnLAogICAgICAgICJ0cGwiOiAgICAgICAgICAgICAgICAgICAgICAnY29tcG9uZW50cy9yZXF1aXJlanMtdHBsLWpjYnJhbmQvdHBsJywKICAgICAgICAidHlwZWFoZWFkIjogICAgICAgICAgICAgICAgImNvbXBvbmVudHMvdHlwZWFoZWFkLmpzL2luZGV4IiwKICAgICAgICAidW5kZXJzY29yZSI6ICAgICAgICAgICAgICAgImNvbXBvbmVudHMvdW5kZXJzY29yZS91bmRlcnNjb3JlIiwKICAgICAgICAidXRpbHMiOiAgICAgICAgICAgICAgICAgICAgInNyYy91dGlscyIsCgogICAgICAgIC8vIE9mZi10aGUtcmVjb3JkLWVuY3J5cHRpb24KICAgICAgICAiYmlnaW50IjogICAgICAgICAgICAgICAic3JjL2JpZ2ludCIsCiAgICAgICAgImNyeXB0byI6ICAgICAgICAgICAgICAgInNyYy9jcnlwdG8iLAogICAgICAgICJjcnlwdG8uYWVzIjogICAgICAgICAgICJjb21wb25lbnRzL290ci92ZW5kb3IvY3J5cHRvanMvYWVzIiwKICAgICAgICAiY3J5cHRvLmNpcGhlci1jb3JlIjogICAiY29tcG9uZW50cy9vdHIvdmVuZG9yL2NyeXB0b2pzL2NpcGhlci1jb3JlIiwKICAgICAgICAiY3J5cHRvLmNvcmUiOiAgICAgICAgICAiY29tcG9uZW50cy9vdHIvdmVuZG9yL2NyeXB0b2pzL2NvcmUiLAogICAgICAgICJjcnlwdG8uZW5jLWJhc2U2NCI6ICAgICJjb21wb25lbnRzL290ci92ZW5kb3IvY3J5cHRvanMvZW5jLWJhc2U2NCIsCiAgICAgICAgImNyeXB0by5ldnBrZGYiOiAgICAgICAgImNvbXBvbmVudHMvY3J5cHRvLWpzLWV2YW52b3NiZXJnL3NyYy9ldnBrZGYiLAogICAgICAgICJjcnlwdG8uaG1hYyI6ICAgICAgICAgICJjb21wb25lbnRzL290ci92ZW5kb3IvY3J5cHRvanMvaG1hYyIsCiAgICAgICAgImNyeXB0by5tZDUiOiAgICAgICAgICAgImNvbXBvbmVudHMvY3J5cHRvLWpzLWV2YW52b3NiZXJnL3NyYy9tZDUiLAogICAgICAgICJjcnlwdG8ubW9kZS1jdHIiOiAgICAgICJjb21wb25lbnRzL290ci92ZW5kb3IvY3J5cHRvanMvbW9kZS1jdHIiLAogICAgICAgICJjcnlwdG8ucGFkLW5vcGFkZGluZyI6ICJjb21wb25lbnRzL290ci92ZW5kb3IvY3J5cHRvanMvcGFkLW5vcGFkZGluZyIsCiAgICAgICAgImNyeXB0by5zaGExIjogICAgICAgICAiY29tcG9uZW50cy9vdHIvdmVuZG9yL2NyeXB0b2pzL3NoYTEiLAogICAgICAgICJjcnlwdG8uc2hhMjU2IjogICAgICAgICJjb21wb25lbnRzL290ci92ZW5kb3IvY3J5cHRvanMvc2hhMjU2IiwKICAgICAgICAic2Fsc2EyMCI6ICAgICAgICAgICAgICAiY29tcG9uZW50cy9vdHIvYnVpbGQvZGVwL3NhbHNhMjAiLAogICAgICAgICJvdHIiOiAgICAgICAgICAgICAgICAgICJzcmMvb3RyIiwKCiAgICAgICAgLy8gTG9jYWxlcyBwYXRocwogICAgICAgICJsb2NhbGVzIjogICAibG9jYWxlL2xvY2FsZXMiLAogICAgICAgICJqZWQiOiAgICAgICAiY29tcG9uZW50cy9qZWQvamVkIiwKICAgICAgICAiYWYiOiAgICAgICAgImxvY2FsZS9hZi9MQ19NRVNTQUdFUy9hZiIsCiAgICAgICAgImRlIjogICAgICAgICJsb2NhbGUvZGUvTENfTUVTU0FHRVMvZGUiLAogICAgICAgICJlbiI6ICAgICAgICAibG9jYWxlL2VuL0xDX01FU1NBR0VTL2VuIiwKICAgICAgICAiZXMiOiAgICAgICAgImxvY2FsZS9lcy9MQ19NRVNTQUdFUy9lcyIsCiAgICAgICAgImZyIjogICAgICAgICJsb2NhbGUvZnIvTENfTUVTU0FHRVMvZnIiLAogICAgICAgICJoZSI6ICAgICAgICAibG9jYWxlL2hlL0xDX01FU1NBR0VTL2hlIiwKICAgICAgICAiaHUiOiAgICAgICAgImxvY2FsZS9odS9MQ19NRVNTQUdFUy9odSIsCiAgICAgICAgImlkIjogICAgICAgICJsb2NhbGUvaWQvTENfTUVTU0FHRVMvaWQiLAogICAgICAgICJpdCI6ICAgICAgICAibG9jYWxlL2l0L0xDX01FU1NBR0VTL2l0IiwKICAgICAgICAiamEiOiAgICAgICAgImxvY2FsZS9qYS9MQ19NRVNTQUdFUy9qYSIsCiAgICAgICAgIm5sIjogICAgICAgICJsb2NhbGUvbmwvTENfTUVTU0FHRVMvbmwiLAogICAgICAgICJwdF9CUiI6ICAgICAibG9jYWxlL3B0X0JSL0xDX01FU1NBR0VTL3B0X0JSIiwKICAgICAgICAicnUiOiAgICAgICAgImxvY2FsZS9ydS9MQ19NRVNTQUdFUy9ydSIsCiAgICAgICAgInpoIjogICAgICAgICJsb2NhbGUvemgvTENfTUVTU0FHRVMvemgiLAoKICAgICAgICAvLyBUZW1wbGF0ZXMKICAgICAgICAiYWN0aW9uIjogICAgICAgICAgICAgICAgICAgInNyYy90ZW1wbGF0ZXMvYWN0aW9uIiwKICAgICAgICAiYWRkX2NvbnRhY3RfZHJvcGRvd24iOiAgICAgInNyYy90ZW1wbGF0ZXMvYWRkX2NvbnRhY3RfZHJvcGRvd24iLAogICAgICAgICJhZGRfY29udGFjdF9mb3JtIjogICAgICAgICAic3JjL3RlbXBsYXRlcy9hZGRfY29udGFjdF9mb3JtIiwKICAgICAgICAiY2hhbmdlX3N0YXR1c19tZXNzYWdlIjogICAgInNyYy90ZW1wbGF0ZXMvY2hhbmdlX3N0YXR1c19tZXNzYWdlIiwKICAgICAgICAiY2hhdF9zdGF0dXMiOiAgICAgICAgICAgICAgInNyYy90ZW1wbGF0ZXMvY2hhdF9zdGF0dXMiLAogICAgICAgICJjaGF0YXJlYSI6ICAgICAgICAgICAgICAgICAic3JjL3RlbXBsYXRlcy9jaGF0YXJlYSIsCiAgICAgICAgImNoYXRib3giOiAgICAgICAgICAgICAgICAgICJzcmMvdGVtcGxhdGVzL2NoYXRib3giLAogICAgICAgICJjaGF0cm9vbSI6ICAgICAgICAgICAgICAgICAic3JjL3RlbXBsYXRlcy9jaGF0cm9vbSIsCiAgICAgICAgImNoYXRyb29tX3Bhc3N3b3JkX2Zvcm0iOiAgICJzcmMvdGVtcGxhdGVzL2NoYXRyb29tX3Bhc3N3b3JkX2Zvcm0iLAogICAgICAgICJjaGF0cm9vbV9zaWRlYmFyIjogICAgICAgICAic3JjL3RlbXBsYXRlcy9jaGF0cm9vbV9zaWRlYmFyIiwKICAgICAgICAiY2hhdHJvb21zX3RhYiI6ICAgICAgICAgICAgInNyYy90ZW1wbGF0ZXMvY2hhdHJvb21zX3RhYiIsCiAgICAgICAgImNoYXRzX3BhbmVsIjogICAgICAgICAgICAgICJzcmMvdGVtcGxhdGVzL2NoYXRzX3BhbmVsIiwKICAgICAgICAiY2hvb3NlX3N0YXR1cyI6ICAgICAgICAgICAgInNyYy90ZW1wbGF0ZXMvY2hvb3NlX3N0YXR1cyIsCiAgICAgICAgImNvbnRhY3RzX3BhbmVsIjogICAgICAgICAgICJzcmMvdGVtcGxhdGVzL2NvbnRhY3RzX3BhbmVsIiwKICAgICAgICAiY29udGFjdHNfdGFiIjogICAgICAgICAgICAgInNyYy90ZW1wbGF0ZXMvY29udGFjdHNfdGFiIiwKICAgICAgICAiY29udHJvbGJveCI6ICAgICAgICAgICAgICAgInNyYy90ZW1wbGF0ZXMvY29udHJvbGJveCIsCiAgICAgICAgImNvbnRyb2xib3hfdG9nZ2xlIjogICAgICAgICJzcmMvdGVtcGxhdGVzL2NvbnRyb2xib3hfdG9nZ2xlIiwKICAgICAgICAiZmllbGQiOiAgICAgICAgICAgICAgICAgICAgInNyYy90ZW1wbGF0ZXMvZmllbGQiLAogICAgICAgICJmb3JtX2NoZWNrYm94IjogICAgICAgICAgICAic3JjL3RlbXBsYXRlcy9mb3JtX2NoZWNrYm94IiwKICAgICAgICAiZm9ybV9pbnB1dCI6ICAgICAgICAgICAgICAgInNyYy90ZW1wbGF0ZXMvZm9ybV9pbnB1dCIsCiAgICAgICAgImZvcm1fc2VsZWN0IjogICAgICAgICAgICAgICJzcmMvdGVtcGxhdGVzL2Zvcm1fc2VsZWN0IiwKICAgICAgICAiZ3JvdXBfaGVhZGVyIjogICAgICAgICAgICAgInNyYy90ZW1wbGF0ZXMvZ3JvdXBfaGVhZGVyIiwKICAgICAgICAiaW5mbyI6ICAgICAgICAgICAgICAgICAgICAgInNyYy90ZW1wbGF0ZXMvaW5mbyIsCiAgICAgICAgImxvZ2luX3BhbmVsIjogICAgICAgICAgICAgICJzcmMvdGVtcGxhdGVzL2xvZ2luX3BhbmVsIiwKICAgICAgICAibG9naW5fdGFiIjogICAgICAgICAgICAgICAgInNyYy90ZW1wbGF0ZXMvbG9naW5fdGFiIiwKICAgICAgICAibWVzc2FnZSI6ICAgICAgICAgICAgICAgICAgInNyYy90ZW1wbGF0ZXMvbWVzc2FnZSIsCiAgICAgICAgIm5ld19kYXkiOiAgICAgICAgICAgICAgICAgICJzcmMvdGVtcGxhdGVzL25ld19kYXkiLAogICAgICAgICJvY2N1cGFudCI6ICAgICAgICAgICAgICAgICAic3JjL3RlbXBsYXRlcy9vY2N1cGFudCIsCiAgICAgICAgInBlbmRpbmdfY29udGFjdCI6ICAgICAgICAgICJzcmMvdGVtcGxhdGVzL3BlbmRpbmdfY29udGFjdCIsCiAgICAgICAgInBlbmRpbmdfY29udGFjdHMiOiAgICAgICAgICJzcmMvdGVtcGxhdGVzL3BlbmRpbmdfY29udGFjdHMiLAogICAgICAgICJyZXF1ZXN0aW5nX2NvbnRhY3QiOiAgICAgICAic3JjL3RlbXBsYXRlcy9yZXF1ZXN0aW5nX2NvbnRhY3QiLAogICAgICAgICJyZXF1ZXN0aW5nX2NvbnRhY3RzIjogICAgICAic3JjL3RlbXBsYXRlcy9yZXF1ZXN0aW5nX2NvbnRhY3RzIiwKICAgICAgICAicm9vbV9kZXNjcmlwdGlvbiI6ICAgICAgICAgInNyYy90ZW1wbGF0ZXMvcm9vbV9kZXNjcmlwdGlvbiIsCiAgICAgICAgInJvb21faXRlbSI6ICAgICAgICAgICAgICAgICJzcmMvdGVtcGxhdGVzL3Jvb21faXRlbSIsCiAgICAgICAgInJvb21fcGFuZWwiOiAgICAgICAgICAgICAgICJzcmMvdGVtcGxhdGVzL3Jvb21fcGFuZWwiLAogICAgICAgICJyb3N0ZXIiOiAgICAgICAgICAgICAgICAgICAic3JjL3RlbXBsYXRlcy9yb3N0ZXIiLAogICAgICAgICJyb3N0ZXJfaXRlbSI6ICAgICAgICAgICAgICAic3JjL3RlbXBsYXRlcy9yb3N0ZXJfaXRlbSIsCiAgICAgICAgInNlYXJjaF9jb250YWN0IjogICAgICAgICAgICJzcmMvdGVtcGxhdGVzL3NlYXJjaF9jb250YWN0IiwKICAgICAgICAic2VsZWN0X29wdGlvbiI6ICAgICAgICAgICAgInNyYy90ZW1wbGF0ZXMvc2VsZWN0X29wdGlvbiIsCiAgICAgICAgInN0YXR1c19vcHRpb24iOiAgICAgICAgICAgICJzcmMvdGVtcGxhdGVzL3N0YXR1c19vcHRpb24iLAogICAgICAgICJ0b2dnbGVfY2hhdHMiOiAgICAgICAgICAgICAic3JjL3RlbXBsYXRlcy90b2dnbGVfY2hhdHMiLAogICAgICAgICJ0b29sYmFyIjogICAgICAgICAgICAgICAgICAic3JjL3RlbXBsYXRlcy90b29sYmFyIiwKICAgICAgICAidHJpbW1lZF9jaGF0IjogICAgICAgICAgICAgInNyYy90ZW1wbGF0ZXMvdHJpbW1lZF9jaGF0IgogICAgfSwKCiAgICBtYXA6IHsKICAgICAgICAvLyAnKicgbWVhbnMgYWxsIG1vZHVsZXMgd2lsbCBnZXQgJ2pxdWVyeS1wcml2YXRlJwogICAgICAgIC8vIGZvciB0aGVpciAnanF1ZXJ5JyBkZXBlbmRlbmN5LgogICAgICAgICcqJzogeyAnanF1ZXJ5JzogJ2pxdWVyeS1wcml2YXRlJyB9LAogICAgICAgIC8vICdqcXVlcnktcHJpdmF0ZScgd2FudHMgdGhlIHJlYWwgalF1ZXJ5IG1vZHVsZQogICAgICAgIC8vIHRob3VnaC4gSWYgdGhpcyBsaW5lIHdhcyBub3QgaGVyZSwgdGhlcmUgd291bGQKICAgICAgICAvLyBiZSBhbiB1bnJlc29sdmFibGUgY3ljbGljIGRlcGVuZGVuY3kuCiAgICAgICAgJ2pxdWVyeS1wcml2YXRlJzogeyAnanF1ZXJ5JzogJ2pxdWVyeScgfQogICAgfSwKCiAgICB0cGw6IHsKICAgICAgICAvLyBDb25maWd1cmF0aW9uIGZvciByZXF1aXJlanMtdHBsCiAgICAgICAgLy8gVXNlIE11c3RhY2hlIHN0eWxlIHN5bnRheCBmb3IgdmFyaWFibGUgaW50ZXJwb2xhdGlvbgogICAgICAgIHRlbXBsYXRlU2V0dGluZ3M6IHsKICAgICAgICAgICAgZXZhbHVhdGUgOiAvXHtcWyhbXHNcU10rPylcXVx9L2csCiAgICAgICAgICAgIGludGVycG9sYXRlIDogL1x7XHsoW1xzXFNdKz8pXH1cfS9nCiAgICAgICAgfQogICAgfSwKCiAgICAvLyBkZWZpbmUgbW9kdWxlIGRlcGVuZGVuY2llcyBmb3IgbW9kdWxlcyBub3QgdXNpbmcgZGVmaW5lCiAgICBzaGltOiB7CiAgICAgICAgJ3VuZGVyc2NvcmUnOiAgICAgICAgICAgeyBleHBvcnRzOiAnXycgfSwKICAgICAgICAnY3J5cHRvLmFlcyc6ICAgICAgICAgICB7IGRlcHM6IFsnY3J5cHRvLmNpcGhlci1jb3JlJ10gfSwKICAgICAgICAnY3J5cHRvLmNpcGhlci1jb3JlJzogICB7IGRlcHM6IFsnY3J5cHRvLmVuYy1iYXNlNjQnLCAnY3J5cHRvLmV2cGtkZiddIH0sCiAgICAgICAgJ2NyeXB0by5lbmMtYmFzZTY0JzogICAgeyBkZXBzOiBbJ2NyeXB0by5jb3JlJ10gfSwKICAgICAgICAnY3J5cHRvLmV2cGtkZic6ICAgICAgICB7IGRlcHM6IFsnY3J5cHRvLm1kNSddIH0sCiAgICAgICAgJ2NyeXB0by5obWFjJzogICAgICAgICAgeyBkZXBzOiBbJ2NyeXB0by5jb3JlJ10gfSwKICAgICAgICAnY3J5cHRvLm1kNSc6ICAgICAgICAgICB7IGRlcHM6IFsnY3J5cHRvLmNvcmUnXSB9LAogICAgICAgICdjcnlwdG8ubW9kZS1jdHInOiAgICAgIHsgZGVwczogWydjcnlwdG8uY2lwaGVyLWNvcmUnXSB9LAogICAgICAgICdjcnlwdG8ucGFkLW5vcGFkZGluZyc6IHsgZGVwczogWydjcnlwdG8uY2lwaGVyLWNvcmUnXSB9LAogICAgICAgICdjcnlwdG8uc2hhMSc6ICAgICAgICAgIHsgZGVwczogWydjcnlwdG8uY29yZSddIH0sCiAgICAgICAgJ2NyeXB0by5zaGEyNTYnOiAgICAgICAgeyBkZXBzOiBbJ2NyeXB0by5jb3JlJ10gfSwKICAgICAgICAnYmlnaW50JzogICAgICAgICAgICAgICB7IGRlcHM6IFsnY3J5cHRvJ10gfSwKICAgICAgICAnc3Ryb3BoZSc6ICAgICAgICAgICAgICB7IGV4cG9ydHM6ICdTdHJvcGhlJyB9LAogICAgICAgICdzdHJvcGhlLmRpc2NvJzogICAgICAgIHsgZGVwczogWydzdHJvcGhlJ10gfSwKICAgICAgICAnc3Ryb3BoZS5tdWMnOiAgICAgICAgICB7IGRlcHM6IFsnc3Ryb3BoZSddIH0sCiAgICAgICAgJ3N0cm9waGUucm9zdGVyJzogICAgICAgeyBkZXBzOiBbJ3N0cm9waGUnXSB9LAogICAgICAgICdzdHJvcGhlLnZjYXJkJzogICAgICAgIHsgZGVwczogWydzdHJvcGhlJ10gfQogICAgfQp9KTsKcmVxdWlyZShbImNvbnZlcnNlIl0sIGZ1bmN0aW9uKGNvbnZlcnNlKSB7CiAgICB3aW5kb3cuY29udmVyc2UgPSBjb252ZXJzZTsKfSk7CgpkZWZpbmUoIm1haW4iLCBmdW5jdGlvbigpe30pOwoK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 16:25:10 GMT",
                    "Content-Length": "1088112",
                    "Date": "Thu, 06 Nov 2014 16:25:16 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}