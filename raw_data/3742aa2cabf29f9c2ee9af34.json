{
    "url": "http://localhost:9999/tkambler/edison.js/dist/edison.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>self.name</b> and written to <b>the 'setAttribute()' function of a DOM element</b> via the following statement:<ul><li>tpl.setAttribute('id', 'section_' + self.section.getName() + '_route_' + self.name);</li></ul><b>Note:</b> The name of the current window is a valid attack vector for DOM-based vulnerabilities. An attacker can directly control the name of the targeted application's window by using code on their own domain to load the targeted page using either window.open() or an iframe tag, and specifying the desired window name. ",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/tkambler/edison.js/dist/edison.js",
                "path": "/tkambler/edison.js/dist/edison.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC90a2FtYmxlci9lZGlzb24uanMvZGlzdC9lZGlzb24uanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNjExNjYNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMjI6MjY6MTQgR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDIyOjI2OjEzIEdNVA0KDQoKLy8gICAgIFVuZGVyc2NvcmUuanMgMS41LjIKLy8gICAgIGh0dHA6Ly91bmRlcnNjb3JlanMub3JnCi8vICAgICAoYykgMjAwOS0yMDEzIEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZCBhbmQgSW52ZXN0aWdhdGl2ZSBSZXBvcnRlcnMgJiBFZGl0b3JzCi8vICAgICBVbmRlcnNjb3JlIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgoKKGZ1bmN0aW9uKCkgewoKICAvLyBCYXNlbGluZSBzZXR1cAogIC8vIC0tLS0tLS0tLS0tLS0tCgogIC8vIEVzdGFibGlzaCB0aGUgcm9vdCBvYmplY3QsIGB3aW5kb3dgIGluIHRoZSBicm93c2VyLCBvciBgZXhwb3J0c2Agb24gdGhlIHNlcnZlci4KICB2YXIgcm9vdCA9IHRoaXM7CgogIC8vIFNhdmUgdGhlIHByZXZpb3VzIHZhbHVlIG9mIHRoZSBgX2AgdmFyaWFibGUuCiAgdmFyIHByZXZpb3VzVW5kZXJzY29yZSA9IHJvb3QuXzsKCiAgLy8gRXN0YWJsaXNoIHRoZSBvYmplY3QgdGhhdCBnZXRzIHJldHVybmVkIHRvIGJyZWFrIG91dCBvZiBhIGxvb3AgaXRlcmF0aW9uLgogIHZhciBicmVha2VyID0ge307CgogIC8vIFNhdmUgYnl0ZXMgaW4gdGhlIG1pbmlmaWVkIChidXQgbm90IGd6aXBwZWQpIHZlcnNpb246CiAgdmFyIEFycmF5UHJvdG8gPSBBcnJheS5wcm90b3R5cGUsIE9ialByb3RvID0gT2JqZWN0LnByb3RvdHlwZSwgRnVuY1Byb3RvID0gRnVuY3Rpb24ucHJvdG90eXBlOwoKICAvLyBDcmVhdGUgcXVpY2sgcmVmZXJlbmNlIHZhcmlhYmxlcyBmb3Igc3BlZWQgYWNjZXNzIHRvIGNvcmUgcHJvdG90eXBlcy4KICB2YXIKICAgIHB1c2ggICAgICAgICAgICAgPSBBcnJheVByb3RvLnB1c2gsCiAgICBzbGljZSAgICAgICAgICAgID0gQXJyYXlQcm90by5zbGljZSwKICAgIGNvbmNhdCAgICAgICAgICAgPSBBcnJheVByb3RvLmNvbmNhdCwKICAgIHRvU3RyaW5nICAgICAgICAgPSBPYmpQcm90by50b1N0cmluZywKICAgIGhhc093blByb3BlcnR5ICAgPSBPYmpQcm90by5oYXNPd25Qcm9wZXJ0eTsKCiAgLy8gQWxsICoqRUNNQVNjcmlwdCA1KiogbmF0aXZlIGZ1bmN0aW9uIGltcGxlbWVudGF0aW9ucyB0aGF0IHdlIGhvcGUgdG8gdXNlCiAgLy8gYXJlIGRlY2xhcmVkIGhlcmUuCiAgdmFyCiAgICBuYXRpdmVGb3JFYWNoICAgICAgPSBBcnJheVByb3RvLmZvckVhY2gsCiAgICBuYXRpdmVNYXAgICAgICAgICAgPSBBcnJheVByb3RvLm1hcCwKICAgIG5hdGl2ZVJlZHVjZSAgICAgICA9IEFycmF5UHJvdG8ucmVkdWNlLAogICAgbmF0aXZlUmVkdWNlUmlnaHQgID0gQXJyYXlQcm90by5yZWR1Y2VSaWdodCwKICAgIG5hdGl2ZUZpbHRlciAgICAgICA9IEFycmF5UHJvdG8uZmlsdGVyLAogICAgbmF0aXZlRXZlcnkgICAgICAgID0gQXJyYXlQcm90by5ldmVyeSwKICAgIG5hdGl2ZVNvbWUgICAgICAgICA9IEFycmF5UHJvdG8uc29tZSwKICAgIG5hdGl2ZUluZGV4T2YgICAgICA9IEFycmF5UHJvdG8uaW5kZXhPZiwKICAgIG5hdGl2ZUxhc3RJbmRleE9mICA9IEFycmF5UHJvdG8ubGFzdEluZGV4T2YsCiAgICBuYXRpdmVJc0FycmF5ICAgICAgPSBBcnJheS5pc0FycmF5LAogICAgbmF0aXZlS2V5cyAgICAgICAgID0gT2JqZWN0LmtleXMsCiAgICBuYXRpdmVCaW5kICAgICAgICAgPSBGdW5jUHJvdG8uYmluZDsKCiAgLy8gQ3JlYXRlIGEgc2FmZSByZWZlcmVuY2UgdG8gdGhlIFVuZGVyc2NvcmUgb2JqZWN0IGZvciB1c2UgYmVsb3cuCiAgdmFyIF8gPSBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogaW5zdGFuY2VvZiBfKSByZXR1cm4gb2JqOwogICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIF8pKSByZXR1cm4gbmV3IF8ob2JqKTsKICAgIHRoaXMuX3dyYXBwZWQgPSBvYmo7CiAgfTsKCiAgLy8gRXhwb3J0IHRoZSBVbmRlcnNjb3JlIG9iamVjdCBmb3IgKipOb2RlLmpzKiosIHdpdGgKICAvLyBiYWNrd2FyZHMtY29tcGF0aWJpbGl0eSBmb3IgdGhlIG9sZCBgcmVxdWlyZSgpYCBBUEkuIElmIHdlJ3JlIGluCiAgLy8gdGhlIGJyb3dzZXIsIGFkZCBgX2AgYXMgYSBnbG9iYWwgb2JqZWN0IHZpYSBhIHN0cmluZyBpZGVudGlmaWVyLAogIC8vIGZvciBDbG9zdXJlIENvbXBpbGVyICJhZHZhbmNlZCIgbW9kZS4KICBpZiAodHlwZW9mIGV4cG9ydHMgIT09ICd1bmRlZmluZWQnKSB7CiAgICBpZiAodHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgJiYgbW9kdWxlLmV4cG9ydHMpIHsKICAgICAgZXhwb3J0cyA9IG1vZHVsZS5leHBvcnRzID0gXzsKICAgIH0KICAgIGV4cG9ydHMuXyA9IF87CiAgfSBlbHNlIHsKICAgIHJvb3QuXyA9IF87CiAgfQoKICAvLyBDdXJyZW50IHZlcnNpb24uCiAgXy5WRVJTSU9OID0gJzEuNS4yJzsKCiAgLy8gQ29sbGVjdGlvbiBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBUaGUgY29ybmVyc3RvbmUsIGFuIGBlYWNoYCBpbXBsZW1lbnRhdGlvbiwgYWthIGBmb3JFYWNoYC4KICAvLyBIYW5kbGVzIG9iamVjdHMgd2l0aCB0aGUgYnVpbHQtaW4gYGZvckVhY2hgLCBhcnJheXMsIGFuZCByYXcgb2JqZWN0cy4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgZm9yRWFjaGAgaWYgYXZhaWxhYmxlLgogIHZhciBlYWNoID0gXy5lYWNoID0gXy5mb3JFYWNoID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm47CiAgICBpZiAobmF0aXZlRm9yRWFjaCAmJiBvYmouZm9yRWFjaCA9PT0gbmF0aXZlRm9yRWFjaCkgewogICAgICBvYmouZm9yRWFjaChpdGVyYXRvciwgY29udGV4dCk7CiAgICB9IGVsc2UgaWYgKG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoKSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBvYmoubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpbaV0sIGksIG9iaikgPT09IGJyZWFrZXIpIHJldHVybjsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGtleXMgPSBfLmtleXMob2JqKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGtleXMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5c1tpXV0sIGtleXNbaV0sIG9iaikgPT09IGJyZWFrZXIpIHJldHVybjsKICAgICAgfQogICAgfQogIH07CgogIC8vIFJldHVybiB0aGUgcmVzdWx0cyBvZiBhcHBseWluZyB0aGUgaXRlcmF0b3IgdG8gZWFjaCBlbGVtZW50LgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBtYXBgIGlmIGF2YWlsYWJsZS4KICBfLm1hcCA9IF8uY29sbGVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHRzID0gW107CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHRzOwogICAgaWYgKG5hdGl2ZU1hcCAmJiBvYmoubWFwID09PSBuYXRpdmVNYXApIHJldHVybiBvYmoubWFwKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgcmVzdWx0cy5wdXNoKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIHZhciByZWR1Y2VFcnJvciA9ICdSZWR1Y2Ugb2YgZW1wdHkgYXJyYXkgd2l0aCBubyBpbml0aWFsIHZhbHVlJzsKCiAgLy8gKipSZWR1Y2UqKiBidWlsZHMgdXAgYSBzaW5nbGUgcmVzdWx0IGZyb20gYSBsaXN0IG9mIHZhbHVlcywgYWthIGBpbmplY3RgLAogIC8vIG9yIGBmb2xkbGAuIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGByZWR1Y2VgIGlmIGF2YWlsYWJsZS4KICBfLnJlZHVjZSA9IF8uZm9sZGwgPSBfLmluamVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIG1lbW8sIGNvbnRleHQpIHsKICAgIHZhciBpbml0aWFsID0gYXJndW1lbnRzLmxlbmd0aCA+IDI7CiAgICBpZiAob2JqID09IG51bGwpIG9iaiA9IFtdOwogICAgaWYgKG5hdGl2ZVJlZHVjZSAmJiBvYmoucmVkdWNlID09PSBuYXRpdmVSZWR1Y2UpIHsKICAgICAgaWYgKGNvbnRleHQpIGl0ZXJhdG9yID0gXy5iaW5kKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgICAgcmV0dXJuIGluaXRpYWwgPyBvYmoucmVkdWNlKGl0ZXJhdG9yLCBtZW1vKSA6IG9iai5yZWR1Y2UoaXRlcmF0b3IpOwogICAgfQogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoIWluaXRpYWwpIHsKICAgICAgICBtZW1vID0gdmFsdWU7CiAgICAgICAgaW5pdGlhbCA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWVtbyA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgbWVtbywgdmFsdWUsIGluZGV4LCBsaXN0KTsKICAgICAgfQogICAgfSk7CiAgICBpZiAoIWluaXRpYWwpIHRocm93IG5ldyBUeXBlRXJyb3IocmVkdWNlRXJyb3IpOwogICAgcmV0dXJuIG1lbW87CiAgfTsKCiAgLy8gVGhlIHJpZ2h0LWFzc29jaWF0aXZlIHZlcnNpb24gb2YgcmVkdWNlLCBhbHNvIGtub3duIGFzIGBmb2xkcmAuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYHJlZHVjZVJpZ2h0YCBpZiBhdmFpbGFibGUuCiAgXy5yZWR1Y2VSaWdodCA9IF8uZm9sZHIgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBtZW1vLCBjb250ZXh0KSB7CiAgICB2YXIgaW5pdGlhbCA9IGFyZ3VtZW50cy5sZW5ndGggPiAyOwogICAgaWYgKG9iaiA9PSBudWxsKSBvYmogPSBbXTsKICAgIGlmIChuYXRpdmVSZWR1Y2VSaWdodCAmJiBvYmoucmVkdWNlUmlnaHQgPT09IG5hdGl2ZVJlZHVjZVJpZ2h0KSB7CiAgICAgIGlmIChjb250ZXh0KSBpdGVyYXRvciA9IF8uYmluZChpdGVyYXRvciwgY29udGV4dCk7CiAgICAgIHJldHVybiBpbml0aWFsID8gb2JqLnJlZHVjZVJpZ2h0KGl0ZXJhdG9yLCBtZW1vKSA6IG9iai5yZWR1Y2VSaWdodChpdGVyYXRvcik7CiAgICB9CiAgICB2YXIgbGVuZ3RoID0gb2JqLmxlbmd0aDsKICAgIGlmIChsZW5ndGggIT09ICtsZW5ndGgpIHsKICAgICAgdmFyIGtleXMgPSBfLmtleXMob2JqKTsKICAgICAgbGVuZ3RoID0ga2V5cy5sZW5ndGg7CiAgICB9CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGluZGV4ID0ga2V5cyA/IGtleXNbLS1sZW5ndGhdIDogLS1sZW5ndGg7CiAgICAgIGlmICghaW5pdGlhbCkgewogICAgICAgIG1lbW8gPSBvYmpbaW5kZXhdOwogICAgICAgIGluaXRpYWwgPSB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIG1lbW8gPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG1lbW8sIG9ialtpbmRleF0sIGluZGV4LCBsaXN0KTsKICAgICAgfQogICAgfSk7CiAgICBpZiAoIWluaXRpYWwpIHRocm93IG5ldyBUeXBlRXJyb3IocmVkdWNlRXJyb3IpOwogICAgcmV0dXJuIG1lbW87CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBmaXJzdCB2YWx1ZSB3aGljaCBwYXNzZXMgYSB0cnV0aCB0ZXN0LiBBbGlhc2VkIGFzIGBkZXRlY3RgLgogIF8uZmluZCA9IF8uZGV0ZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdDsKICAgIGFueShvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSB7CiAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBSZXR1cm4gYWxsIHRoZSBlbGVtZW50cyB0aGF0IHBhc3MgYSB0cnV0aCB0ZXN0LgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBmaWx0ZXJgIGlmIGF2YWlsYWJsZS4KICAvLyBBbGlhc2VkIGFzIGBzZWxlY3RgLgogIF8uZmlsdGVyID0gXy5zZWxlY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0czsKICAgIGlmIChuYXRpdmVGaWx0ZXIgJiYgb2JqLmZpbHRlciA9PT0gbmF0aXZlRmlsdGVyKSByZXR1cm4gb2JqLmZpbHRlcihpdGVyYXRvciwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmIChpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpIHJlc3VsdHMucHVzaCh2YWx1ZSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIGZvciB3aGljaCBhIHRydXRoIHRlc3QgZmFpbHMuCiAgXy5yZWplY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICByZXR1cm4gXy5maWx0ZXIob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgcmV0dXJuICFpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCk7CiAgICB9LCBjb250ZXh0KTsKICB9OwoKICAvLyBEZXRlcm1pbmUgd2hldGhlciBhbGwgb2YgdGhlIGVsZW1lbnRzIG1hdGNoIGEgdHJ1dGggdGVzdC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgZXZlcnlgIGlmIGF2YWlsYWJsZS4KICAvLyBBbGlhc2VkIGFzIGBhbGxgLgogIF8uZXZlcnkgPSBfLmFsbCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGl0ZXJhdG9yIHx8IChpdGVyYXRvciA9IF8uaWRlbnRpdHkpOwogICAgdmFyIHJlc3VsdCA9IHRydWU7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHQ7CiAgICBpZiAobmF0aXZlRXZlcnkgJiYgb2JqLmV2ZXJ5ID09PSBuYXRpdmVFdmVyeSkgcmV0dXJuIG9iai5ldmVyeShpdGVyYXRvciwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmICghKHJlc3VsdCA9IHJlc3VsdCAmJiBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpKSByZXR1cm4gYnJlYWtlcjsKICAgIH0pOwogICAgcmV0dXJuICEhcmVzdWx0OwogIH07CgogIC8vIERldGVybWluZSBpZiBhdCBsZWFzdCBvbmUgZWxlbWVudCBpbiB0aGUgb2JqZWN0IG1hdGNoZXMgYSB0cnV0aCB0ZXN0LgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBzb21lYCBpZiBhdmFpbGFibGUuCiAgLy8gQWxpYXNlZCBhcyBgYW55YC4KICB2YXIgYW55ID0gXy5zb21lID0gXy5hbnkgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpdGVyYXRvciB8fCAoaXRlcmF0b3IgPSBfLmlkZW50aXR5KTsKICAgIHZhciByZXN1bHQgPSBmYWxzZTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHJlc3VsdDsKICAgIGlmIChuYXRpdmVTb21lICYmIG9iai5zb21lID09PSBuYXRpdmVTb21lKSByZXR1cm4gb2JqLnNvbWUoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAocmVzdWx0IHx8IChyZXN1bHQgPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpKSByZXR1cm4gYnJlYWtlcjsKICAgIH0pOwogICAgcmV0dXJuICEhcmVzdWx0OwogIH07CgogIC8vIERldGVybWluZSBpZiB0aGUgYXJyYXkgb3Igb2JqZWN0IGNvbnRhaW5zIGEgZ2l2ZW4gdmFsdWUgKHVzaW5nIGA9PT1gKS4KICAvLyBBbGlhc2VkIGFzIGBpbmNsdWRlYC4KICBfLmNvbnRhaW5zID0gXy5pbmNsdWRlID0gZnVuY3Rpb24ob2JqLCB0YXJnZXQpIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIGZhbHNlOwogICAgaWYgKG5hdGl2ZUluZGV4T2YgJiYgb2JqLmluZGV4T2YgPT09IG5hdGl2ZUluZGV4T2YpIHJldHVybiBvYmouaW5kZXhPZih0YXJnZXQpICE9IC0xOwogICAgcmV0dXJuIGFueShvYmosIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSA9PT0gdGFyZ2V0OwogICAgfSk7CiAgfTsKCiAgLy8gSW52b2tlIGEgbWV0aG9kICh3aXRoIGFyZ3VtZW50cykgb24gZXZlcnkgaXRlbSBpbiBhIGNvbGxlY3Rpb24uCiAgXy5pbnZva2UgPSBmdW5jdGlvbihvYmosIG1ldGhvZCkgewogICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICB2YXIgaXNGdW5jID0gXy5pc0Z1bmN0aW9uKG1ldGhvZCk7CiAgICByZXR1cm4gXy5tYXAob2JqLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gKGlzRnVuYyA/IG1ldGhvZCA6IHZhbHVlW21ldGhvZF0pLmFwcGx5KHZhbHVlLCBhcmdzKTsKICAgIH0pOwogIH07CgogIC8vIENvbnZlbmllbmNlIHZlcnNpb24gb2YgYSBjb21tb24gdXNlIGNhc2Ugb2YgYG1hcGA6IGZldGNoaW5nIGEgcHJvcGVydHkuCiAgXy5wbHVjayA9IGZ1bmN0aW9uKG9iaiwga2V5KSB7CiAgICByZXR1cm4gXy5tYXAob2JqLCBmdW5jdGlvbih2YWx1ZSl7IHJldHVybiB2YWx1ZVtrZXldOyB9KTsKICB9OwoKICAvLyBDb252ZW5pZW5jZSB2ZXJzaW9uIG9mIGEgY29tbW9uIHVzZSBjYXNlIG9mIGBmaWx0ZXJgOiBzZWxlY3Rpbmcgb25seSBvYmplY3RzCiAgLy8gY29udGFpbmluZyBzcGVjaWZpYyBga2V5OnZhbHVlYCBwYWlycy4KICBfLndoZXJlID0gZnVuY3Rpb24ob2JqLCBhdHRycywgZmlyc3QpIHsKICAgIGlmIChfLmlzRW1wdHkoYXR0cnMpKSByZXR1cm4gZmlyc3QgPyB2b2lkIDAgOiBbXTsKICAgIHJldHVybiBfW2ZpcnN0ID8gJ2ZpbmQnIDogJ2ZpbHRlciddKG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgaWYgKGF0dHJzW2tleV0gIT09IHZhbHVlW2tleV0pIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0pOwogIH07CgogIC8vIENvbnZlbmllbmNlIHZlcnNpb24gb2YgYSBjb21tb24gdXNlIGNhc2Ugb2YgYGZpbmRgOiBnZXR0aW5nIHRoZSBmaXJzdCBvYmplY3QKICAvLyBjb250YWluaW5nIHNwZWNpZmljIGBrZXk6dmFsdWVgIHBhaXJzLgogIF8uZmluZFdoZXJlID0gZnVuY3Rpb24ob2JqLCBhdHRycykgewogICAgcmV0dXJuIF8ud2hlcmUob2JqLCBhdHRycywgdHJ1ZSk7CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBtYXhpbXVtIGVsZW1lbnQgb3IgKGVsZW1lbnQtYmFzZWQgY29tcHV0YXRpb24pLgogIC8vIENhbid0IG9wdGltaXplIGFycmF5cyBvZiBpbnRlZ2VycyBsb25nZXIgdGhhbiA2NSw1MzUgZWxlbWVudHMuCiAgLy8gU2VlIFtXZWJLaXQgQnVnIDgwNzk3XShodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9ODA3OTcpCiAgXy5tYXggPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpZiAoIWl0ZXJhdG9yICYmIF8uaXNBcnJheShvYmopICYmIG9ialswXSA9PT0gK29ialswXSAmJiBvYmoubGVuZ3RoIDwgNjU1MzUpIHsKICAgICAgcmV0dXJuIE1hdGgubWF4LmFwcGx5KE1hdGgsIG9iaik7CiAgICB9CiAgICBpZiAoIWl0ZXJhdG9yICYmIF8uaXNFbXB0eShvYmopKSByZXR1cm4gLUluZmluaXR5OwogICAgdmFyIHJlc3VsdCA9IHtjb21wdXRlZCA6IC1JbmZpbml0eSwgdmFsdWU6IC1JbmZpbml0eX07CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHZhciBjb21wdXRlZCA9IGl0ZXJhdG9yID8gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpIDogdmFsdWU7CiAgICAgIGNvbXB1dGVkID4gcmVzdWx0LmNvbXB1dGVkICYmIChyZXN1bHQgPSB7dmFsdWUgOiB2YWx1ZSwgY29tcHV0ZWQgOiBjb21wdXRlZH0pOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0LnZhbHVlOwogIH07CgogIC8vIFJldHVybiB0aGUgbWluaW11bSBlbGVtZW50IChvciBlbGVtZW50LWJhc2VkIGNvbXB1dGF0aW9uKS4KICBfLm1pbiA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0FycmF5KG9iaikgJiYgb2JqWzBdID09PSArb2JqWzBdICYmIG9iai5sZW5ndGggPCA2NTUzNSkgewogICAgICByZXR1cm4gTWF0aC5taW4uYXBwbHkoTWF0aCwgb2JqKTsKICAgIH0KICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0VtcHR5KG9iaikpIHJldHVybiBJbmZpbml0eTsKICAgIHZhciByZXN1bHQgPSB7Y29tcHV0ZWQgOiBJbmZpbml0eSwgdmFsdWU6IEluZmluaXR5fTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgdmFyIGNvbXB1dGVkID0gaXRlcmF0b3IgPyBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkgOiB2YWx1ZTsKICAgICAgY29tcHV0ZWQgPCByZXN1bHQuY29tcHV0ZWQgJiYgKHJlc3VsdCA9IHt2YWx1ZSA6IHZhbHVlLCBjb21wdXRlZCA6IGNvbXB1dGVkfSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQudmFsdWU7CiAgfTsKCiAgLy8gU2h1ZmZsZSBhbiBhcnJheSwgdXNpbmcgdGhlIG1vZGVybiB2ZXJzaW9uIG9mIHRoZSAKICAvLyBbRmlzaGVyLVlhdGVzIHNodWZmbGVdKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRmlzaGVy4oCTWWF0ZXNfc2h1ZmZsZSkuCiAgXy5zaHVmZmxlID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgcmFuZDsKICAgIHZhciBpbmRleCA9IDA7CiAgICB2YXIgc2h1ZmZsZWQgPSBbXTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICByYW5kID0gXy5yYW5kb20oaW5kZXgrKyk7CiAgICAgIHNodWZmbGVkW2luZGV4IC0gMV0gPSBzaHVmZmxlZFtyYW5kXTsKICAgICAgc2h1ZmZsZWRbcmFuZF0gPSB2YWx1ZTsKICAgIH0pOwogICAgcmV0dXJuIHNodWZmbGVkOwogIH07CgogIC8vIFNhbXBsZSAqKm4qKiByYW5kb20gdmFsdWVzIGZyb20gYW4gYXJyYXkuCiAgLy8gSWYgKipuKiogaXMgbm90IHNwZWNpZmllZCwgcmV0dXJucyBhIHNpbmdsZSByYW5kb20gZWxlbWVudCBmcm9tIHRoZSBhcnJheS4KICAvLyBUaGUgaW50ZXJuYWwgYGd1YXJkYCBhcmd1bWVudCBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBtYXBgLgogIF8uc2FtcGxlID0gZnVuY3Rpb24ob2JqLCBuLCBndWFyZCkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCAyIHx8IGd1YXJkKSB7CiAgICAgIHJldHVybiBvYmpbXy5yYW5kb20ob2JqLmxlbmd0aCAtIDEpXTsKICAgIH0KICAgIHJldHVybiBfLnNodWZmbGUob2JqKS5zbGljZSgwLCBNYXRoLm1heCgwLCBuKSk7CiAgfTsKCiAgLy8gQW4gaW50ZXJuYWwgZnVuY3Rpb24gdG8gZ2VuZXJhdGUgbG9va3VwIGl0ZXJhdG9ycy4KICB2YXIgbG9va3VwSXRlcmF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG9iail7IHJldHVybiBvYmpbdmFsdWVdOyB9OwogIH07CgogIC8vIFNvcnQgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbiBwcm9kdWNlZCBieSBhbiBpdGVyYXRvci4KICBfLnNvcnRCeSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQpIHsKICAgIHZhciBpdGVyYXRvciA9IGxvb2t1cEl0ZXJhdG9yKHZhbHVlKTsKICAgIHJldHVybiBfLnBsdWNrKF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgIGluZGV4OiBpbmRleCwKICAgICAgICBjcml0ZXJpYTogaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpCiAgICAgIH07CiAgICB9KS5zb3J0KGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgIHZhciBhID0gbGVmdC5jcml0ZXJpYTsKICAgICAgdmFyIGIgPSByaWdodC5jcml0ZXJpYTsKICAgICAgaWYgKGEgIT09IGIpIHsKICAgICAgICBpZiAoYSA+IGIgfHwgYSA9PT0gdm9pZCAwKSByZXR1cm4gMTsKICAgICAgICBpZiAoYSA8IGIgfHwgYiA9PT0gdm9pZCAwKSByZXR1cm4gLTE7CiAgICAgIH0KICAgICAgcmV0dXJuIGxlZnQuaW5kZXggLSByaWdodC5pbmRleDsKICAgIH0pLCAndmFsdWUnKTsKICB9OwoKICAvLyBBbiBpbnRlcm5hbCBmdW5jdGlvbiB1c2VkIGZvciBhZ2dyZWdhdGUgImdyb3VwIGJ5IiBvcGVyYXRpb25zLgogIHZhciBncm91cCA9IGZ1bmN0aW9uKGJlaGF2aW9yKSB7CiAgICByZXR1cm4gZnVuY3Rpb24ob2JqLCB2YWx1ZSwgY29udGV4dCkgewogICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgIHZhciBpdGVyYXRvciA9IHZhbHVlID09IG51bGwgPyBfLmlkZW50aXR5IDogbG9va3VwSXRlcmF0b3IodmFsdWUpOwogICAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CiAgICAgICAgdmFyIGtleSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBvYmopOwogICAgICAgIGJlaGF2aW9yKHJlc3VsdCwga2V5LCB2YWx1ZSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9OwoKICAvLyBHcm91cHMgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbi4gUGFzcyBlaXRoZXIgYSBzdHJpbmcgYXR0cmlidXRlCiAgLy8gdG8gZ3JvdXAgYnksIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZSBjcml0ZXJpb24uCiAgXy5ncm91cEJ5ID0gZ3JvdXAoZnVuY3Rpb24ocmVzdWx0LCBrZXksIHZhbHVlKSB7CiAgICAoXy5oYXMocmVzdWx0LCBrZXkpID8gcmVzdWx0W2tleV0gOiAocmVzdWx0W2tleV0gPSBbXSkpLnB1c2godmFsdWUpOwogIH0pOwoKICAvLyBJbmRleGVzIHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24sIHNpbWlsYXIgdG8gYGdyb3VwQnlgLCBidXQgZm9yCiAgLy8gd2hlbiB5b3Uga25vdyB0aGF0IHlvdXIgaW5kZXggdmFsdWVzIHdpbGwgYmUgdW5pcXVlLgogIF8uaW5kZXhCeSA9IGdyb3VwKGZ1bmN0aW9uKHJlc3VsdCwga2V5LCB2YWx1ZSkgewogICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKICB9KTsKCiAgLy8gQ291bnRzIGluc3RhbmNlcyBvZiBhbiBvYmplY3QgdGhhdCBncm91cCBieSBhIGNlcnRhaW4gY3JpdGVyaW9uLiBQYXNzCiAgLy8gZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZSB0byBjb3VudCBieSwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlCiAgLy8gY3JpdGVyaW9uLgogIF8uY291bnRCeSA9IGdyb3VwKGZ1bmN0aW9uKHJlc3VsdCwga2V5KSB7CiAgICBfLmhhcyhyZXN1bHQsIGtleSkgPyByZXN1bHRba2V5XSsrIDogcmVzdWx0W2tleV0gPSAxOwogIH0pOwoKICAvLyBVc2UgYSBjb21wYXJhdG9yIGZ1bmN0aW9uIHRvIGZpZ3VyZSBvdXQgdGhlIHNtYWxsZXN0IGluZGV4IGF0IHdoaWNoCiAgLy8gYW4gb2JqZWN0IHNob3VsZCBiZSBpbnNlcnRlZCBzbyBhcyB0byBtYWludGFpbiBvcmRlci4gVXNlcyBiaW5hcnkgc2VhcmNoLgogIF8uc29ydGVkSW5kZXggPSBmdW5jdGlvbihhcnJheSwgb2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgPSBpdGVyYXRvciA9PSBudWxsID8gXy5pZGVudGl0eSA6IGxvb2t1cEl0ZXJhdG9yKGl0ZXJhdG9yKTsKICAgIHZhciB2YWx1ZSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqKTsKICAgIHZhciBsb3cgPSAwLCBoaWdoID0gYXJyYXkubGVuZ3RoOwogICAgd2hpbGUgKGxvdyA8IGhpZ2gpIHsKICAgICAgdmFyIG1pZCA9IChsb3cgKyBoaWdoKSA+Pj4gMTsKICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBhcnJheVttaWRdKSA8IHZhbHVlID8gbG93ID0gbWlkICsgMSA6IGhpZ2ggPSBtaWQ7CiAgICB9CiAgICByZXR1cm4gbG93OwogIH07CgogIC8vIFNhZmVseSBjcmVhdGUgYSByZWFsLCBsaXZlIGFycmF5IGZyb20gYW55dGhpbmcgaXRlcmFibGUuCiAgXy50b0FycmF5ID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIW9iaikgcmV0dXJuIFtdOwogICAgaWYgKF8uaXNBcnJheShvYmopKSByZXR1cm4gc2xpY2UuY2FsbChvYmopOwogICAgaWYgKG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoKSByZXR1cm4gXy5tYXAob2JqLCBfLmlkZW50aXR5KTsKICAgIHJldHVybiBfLnZhbHVlcyhvYmopOwogIH07CgogIC8vIFJldHVybiB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIGFuIG9iamVjdC4KICBfLnNpemUgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIDA7CiAgICByZXR1cm4gKG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoKSA/IG9iai5sZW5ndGggOiBfLmtleXMob2JqKS5sZW5ndGg7CiAgfTsKCiAgLy8gQXJyYXkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tCgogIC8vIEdldCB0aGUgZmlyc3QgZWxlbWVudCBvZiBhbiBhcnJheS4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiB0aGUgZmlyc3QgTgogIC8vIHZhbHVlcyBpbiB0aGUgYXJyYXkuIEFsaWFzZWQgYXMgYGhlYWRgIGFuZCBgdGFrZWAuIFRoZSAqKmd1YXJkKiogY2hlY2sKICAvLyBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCiAgXy5maXJzdCA9IF8uaGVhZCA9IF8udGFrZSA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiB2b2lkIDA7CiAgICByZXR1cm4gKG4gPT0gbnVsbCkgfHwgZ3VhcmQgPyBhcnJheVswXSA6IHNsaWNlLmNhbGwoYXJyYXksIDAsIG4pOwogIH07CgogIC8vIFJldHVybnMgZXZlcnl0aGluZyBidXQgdGhlIGxhc3QgZW50cnkgb2YgdGhlIGFycmF5LiBFc3BlY2lhbGx5IHVzZWZ1bCBvbgogIC8vIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIGFsbCB0aGUgdmFsdWVzIGluCiAgLy8gdGhlIGFycmF5LCBleGNsdWRpbmcgdGhlIGxhc3QgTi4gVGhlICoqZ3VhcmQqKiBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoCiAgLy8gYF8ubWFwYC4KICBfLmluaXRpYWwgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCAwLCBhcnJheS5sZW5ndGggLSAoKG4gPT0gbnVsbCkgfHwgZ3VhcmQgPyAxIDogbikpOwogIH07CgogIC8vIEdldCB0aGUgbGFzdCBlbGVtZW50IG9mIGFuIGFycmF5LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIHRoZSBsYXN0IE4KICAvLyB2YWx1ZXMgaW4gdGhlIGFycmF5LiBUaGUgKipndWFyZCoqIGNoZWNrIGFsbG93cyBpdCB0byB3b3JrIHdpdGggYF8ubWFwYC4KICBfLmxhc3QgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIGlmIChhcnJheSA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwogICAgaWYgKChuID09IG51bGwpIHx8IGd1YXJkKSB7CiAgICAgIHJldHVybiBhcnJheVthcnJheS5sZW5ndGggLSAxXTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCBNYXRoLm1heChhcnJheS5sZW5ndGggLSBuLCAwKSk7CiAgICB9CiAgfTsKCiAgLy8gUmV0dXJucyBldmVyeXRoaW5nIGJ1dCB0aGUgZmlyc3QgZW50cnkgb2YgdGhlIGFycmF5LiBBbGlhc2VkIGFzIGB0YWlsYCBhbmQgYGRyb3BgLgogIC8vIEVzcGVjaWFsbHkgdXNlZnVsIG9uIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nIGFuICoqbioqIHdpbGwgcmV0dXJuCiAgLy8gdGhlIHJlc3QgTiB2YWx1ZXMgaW4gdGhlIGFycmF5LiBUaGUgKipndWFyZCoqCiAgLy8gY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8ucmVzdCA9IF8udGFpbCA9IF8uZHJvcCA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewogICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIChuID09IG51bGwpIHx8IGd1YXJkID8gMSA6IG4pOwogIH07CgogIC8vIFRyaW0gb3V0IGFsbCBmYWxzeSB2YWx1ZXMgZnJvbSBhbiBhcnJheS4KICBfLmNvbXBhY3QgPSBmdW5jdGlvbihhcnJheSkgewogICAgcmV0dXJuIF8uZmlsdGVyKGFycmF5LCBfLmlkZW50aXR5KTsKICB9OwoKICAvLyBJbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiBvZiBhIHJlY3Vyc2l2ZSBgZmxhdHRlbmAgZnVuY3Rpb24uCiAgdmFyIGZsYXR0ZW4gPSBmdW5jdGlvbihpbnB1dCwgc2hhbGxvdywgb3V0cHV0KSB7CiAgICBpZiAoc2hhbGxvdyAmJiBfLmV2ZXJ5KGlucHV0LCBfLmlzQXJyYXkpKSB7CiAgICAgIHJldHVybiBjb25jYXQuYXBwbHkob3V0cHV0LCBpbnB1dCk7CiAgICB9CiAgICBlYWNoKGlucHV0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAoXy5pc0FycmF5KHZhbHVlKSB8fCBfLmlzQXJndW1lbnRzKHZhbHVlKSkgewogICAgICAgIHNoYWxsb3cgPyBwdXNoLmFwcGx5KG91dHB1dCwgdmFsdWUpIDogZmxhdHRlbih2YWx1ZSwgc2hhbGxvdywgb3V0cHV0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvdXRwdXQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG91dHB1dDsKICB9OwoKICAvLyBGbGF0dGVuIG91dCBhbiBhcnJheSwgZWl0aGVyIHJlY3Vyc2l2ZWx5IChieSBkZWZhdWx0KSwgb3IganVzdCBvbmUgbGV2ZWwuCiAgXy5mbGF0dGVuID0gZnVuY3Rpb24oYXJyYXksIHNoYWxsb3cpIHsKICAgIHJldHVybiBmbGF0dGVuKGFycmF5LCBzaGFsbG93LCBbXSk7CiAgfTsKCiAgLy8gUmV0dXJuIGEgdmVyc2lvbiBvZiB0aGUgYXJyYXkgdGhhdCBkb2VzIG5vdCBjb250YWluIHRoZSBzcGVjaWZpZWQgdmFsdWUocykuCiAgXy53aXRob3V0ID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgIHJldHVybiBfLmRpZmZlcmVuY2UoYXJyYXksIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgfTsKCiAgLy8gUHJvZHVjZSBhIGR1cGxpY2F0ZS1mcmVlIHZlcnNpb24gb2YgdGhlIGFycmF5LiBJZiB0aGUgYXJyYXkgaGFzIGFscmVhZHkKICAvLyBiZWVuIHNvcnRlZCwgeW91IGhhdmUgdGhlIG9wdGlvbiBvZiB1c2luZyBhIGZhc3RlciBhbGdvcml0aG0uCiAgLy8gQWxpYXNlZCBhcyBgdW5pcXVlYC4KICBfLnVuaXEgPSBfLnVuaXF1ZSA9IGZ1bmN0aW9uKGFycmF5LCBpc1NvcnRlZCwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmIChfLmlzRnVuY3Rpb24oaXNTb3J0ZWQpKSB7CiAgICAgIGNvbnRleHQgPSBpdGVyYXRvcjsKICAgICAgaXRlcmF0b3IgPSBpc1NvcnRlZDsKICAgICAgaXNTb3J0ZWQgPSBmYWxzZTsKICAgIH0KICAgIHZhciBpbml0aWFsID0gaXRlcmF0b3IgPyBfLm1hcChhcnJheSwgaXRlcmF0b3IsIGNvbnRleHQpIDogYXJyYXk7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgdmFyIHNlZW4gPSBbXTsKICAgIGVhY2goaW5pdGlhbCwgZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CiAgICAgIGlmIChpc1NvcnRlZCA/ICghaW5kZXggfHwgc2VlbltzZWVuLmxlbmd0aCAtIDFdICE9PSB2YWx1ZSkgOiAhXy5jb250YWlucyhzZWVuLCB2YWx1ZSkpIHsKICAgICAgICBzZWVuLnB1c2godmFsdWUpOwogICAgICAgIHJlc3VsdHMucHVzaChhcnJheVtpbmRleF0pOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIFByb2R1Y2UgYW4gYXJyYXkgdGhhdCBjb250YWlucyB0aGUgdW5pb246IGVhY2ggZGlzdGluY3QgZWxlbWVudCBmcm9tIGFsbCBvZgogIC8vIHRoZSBwYXNzZWQtaW4gYXJyYXlzLgogIF8udW5pb24gPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBfLnVuaXEoXy5mbGF0dGVuKGFyZ3VtZW50cywgdHJ1ZSkpOwogIH07CgogIC8vIFByb2R1Y2UgYW4gYXJyYXkgdGhhdCBjb250YWlucyBldmVyeSBpdGVtIHNoYXJlZCBiZXR3ZWVuIGFsbCB0aGUKICAvLyBwYXNzZWQtaW4gYXJyYXlzLgogIF8uaW50ZXJzZWN0aW9uID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgIHZhciByZXN0ID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgcmV0dXJuIF8uZmlsdGVyKF8udW5pcShhcnJheSksIGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgcmV0dXJuIF8uZXZlcnkocmVzdCwgZnVuY3Rpb24ob3RoZXIpIHsKICAgICAgICByZXR1cm4gXy5pbmRleE9mKG90aGVyLCBpdGVtKSA+PSAwOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIC8vIFRha2UgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbiBvbmUgYXJyYXkgYW5kIGEgbnVtYmVyIG9mIG90aGVyIGFycmF5cy4KICAvLyBPbmx5IHRoZSBlbGVtZW50cyBwcmVzZW50IGluIGp1c3QgdGhlIGZpcnN0IGFycmF5IHdpbGwgcmVtYWluLgogIF8uZGlmZmVyZW5jZSA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICB2YXIgcmVzdCA9IGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgcmV0dXJuIF8uZmlsdGVyKGFycmF5LCBmdW5jdGlvbih2YWx1ZSl7IHJldHVybiAhXy5jb250YWlucyhyZXN0LCB2YWx1ZSk7IH0pOwogIH07CgogIC8vIFppcCB0b2dldGhlciBtdWx0aXBsZSBsaXN0cyBpbnRvIGEgc2luZ2xlIGFycmF5IC0tIGVsZW1lbnRzIHRoYXQgc2hhcmUKICAvLyBhbiBpbmRleCBnbyB0b2dldGhlci4KICBfLnppcCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGxlbmd0aCA9IF8ubWF4KF8ucGx1Y2soYXJndW1lbnRzLCAibGVuZ3RoIikuY29uY2F0KDApKTsKICAgIHZhciByZXN1bHRzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHJlc3VsdHNbaV0gPSBfLnBsdWNrKGFyZ3VtZW50cywgJycgKyBpKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIENvbnZlcnRzIGxpc3RzIGludG8gb2JqZWN0cy4gUGFzcyBlaXRoZXIgYSBzaW5nbGUgYXJyYXkgb2YgYFtrZXksIHZhbHVlXWAKICAvLyBwYWlycywgb3IgdHdvIHBhcmFsbGVsIGFycmF5cyBvZiB0aGUgc2FtZSBsZW5ndGggLS0gb25lIG9mIGtleXMsIGFuZCBvbmUgb2YKICAvLyB0aGUgY29ycmVzcG9uZGluZyB2YWx1ZXMuCiAgXy5vYmplY3QgPSBmdW5jdGlvbihsaXN0LCB2YWx1ZXMpIHsKICAgIGlmIChsaXN0ID09IG51bGwpIHJldHVybiB7fTsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBsaXN0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh2YWx1ZXMpIHsKICAgICAgICByZXN1bHRbbGlzdFtpXV0gPSB2YWx1ZXNbaV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0W2xpc3RbaV1bMF1dID0gbGlzdFtpXVsxXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBJZiB0aGUgYnJvd3NlciBkb2Vzbid0IHN1cHBseSB1cyB3aXRoIGluZGV4T2YgKEknbSBsb29raW5nIGF0IHlvdSwgKipNU0lFKiopLAogIC8vIHdlIG5lZWQgdGhpcyBmdW5jdGlvbi4gUmV0dXJuIHRoZSBwb3NpdGlvbiBvZiB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBhbgogIC8vIGl0ZW0gaW4gYW4gYXJyYXksIG9yIC0xIGlmIHRoZSBpdGVtIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgYXJyYXkuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGluZGV4T2ZgIGlmIGF2YWlsYWJsZS4KICAvLyBJZiB0aGUgYXJyYXkgaXMgbGFyZ2UgYW5kIGFscmVhZHkgaW4gc29ydCBvcmRlciwgcGFzcyBgdHJ1ZWAKICAvLyBmb3IgKippc1NvcnRlZCoqIHRvIHVzZSBiaW5hcnkgc2VhcmNoLgogIF8uaW5kZXhPZiA9IGZ1bmN0aW9uKGFycmF5LCBpdGVtLCBpc1NvcnRlZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiAtMTsKICAgIHZhciBpID0gMCwgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwogICAgaWYgKGlzU29ydGVkKSB7CiAgICAgIGlmICh0eXBlb2YgaXNTb3J0ZWQgPT0gJ251bWJlcicpIHsKICAgICAgICBpID0gKGlzU29ydGVkIDwgMCA/IE1hdGgubWF4KDAsIGxlbmd0aCArIGlzU29ydGVkKSA6IGlzU29ydGVkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpID0gXy5zb3J0ZWRJbmRleChhcnJheSwgaXRlbSk7CiAgICAgICAgcmV0dXJuIGFycmF5W2ldID09PSBpdGVtID8gaSA6IC0xOwogICAgICB9CiAgICB9CiAgICBpZiAobmF0aXZlSW5kZXhPZiAmJiBhcnJheS5pbmRleE9mID09PSBuYXRpdmVJbmRleE9mKSByZXR1cm4gYXJyYXkuaW5kZXhPZihpdGVtLCBpc1NvcnRlZCk7CiAgICBmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pIHJldHVybiBpOwogICAgcmV0dXJuIC0xOwogIH07CgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBsYXN0SW5kZXhPZmAgaWYgYXZhaWxhYmxlLgogIF8ubGFzdEluZGV4T2YgPSBmdW5jdGlvbihhcnJheSwgaXRlbSwgZnJvbSkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiAtMTsKICAgIHZhciBoYXNJbmRleCA9IGZyb20gIT0gbnVsbDsKICAgIGlmIChuYXRpdmVMYXN0SW5kZXhPZiAmJiBhcnJheS5sYXN0SW5kZXhPZiA9PT0gbmF0aXZlTGFzdEluZGV4T2YpIHsKICAgICAgcmV0dXJuIGhhc0luZGV4ID8gYXJyYXkubGFzdEluZGV4T2YoaXRlbSwgZnJvbSkgOiBhcnJheS5sYXN0SW5kZXhPZihpdGVtKTsKICAgIH0KICAgIHZhciBpID0gKGhhc0luZGV4ID8gZnJvbSA6IGFycmF5Lmxlbmd0aCk7CiAgICB3aGlsZSAoaS0tKSBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pIHJldHVybiBpOwogICAgcmV0dXJuIC0xOwogIH07CgogIC8vIEdlbmVyYXRlIGFuIGludGVnZXIgQXJyYXkgY29udGFpbmluZyBhbiBhcml0aG1ldGljIHByb2dyZXNzaW9uLiBBIHBvcnQgb2YKICAvLyB0aGUgbmF0aXZlIFB5dGhvbiBgcmFuZ2UoKWAgZnVuY3Rpb24uIFNlZQogIC8vIFt0aGUgUHl0aG9uIGRvY3VtZW50YXRpb25dKGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvbGlicmFyeS9mdW5jdGlvbnMuaHRtbCNyYW5nZSkuCiAgXy5yYW5nZSA9IGZ1bmN0aW9uKHN0YXJ0LCBzdG9wLCBzdGVwKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8PSAxKSB7CiAgICAgIHN0b3AgPSBzdGFydCB8fCAwOwogICAgICBzdGFydCA9IDA7CiAgICB9CiAgICBzdGVwID0gYXJndW1lbnRzWzJdIHx8IDE7CgogICAgdmFyIGxlbmd0aCA9IE1hdGgubWF4KE1hdGguY2VpbCgoc3RvcCAtIHN0YXJ0KSAvIHN0ZXApLCAwKTsKICAgIHZhciBpZHggPSAwOwogICAgdmFyIHJhbmdlID0gbmV3IEFycmF5KGxlbmd0aCk7CgogICAgd2hpbGUoaWR4IDwgbGVuZ3RoKSB7CiAgICAgIHJhbmdlW2lkeCsrXSA9IHN0YXJ0OwogICAgICBzdGFydCArPSBzdGVwOwogICAgfQoKICAgIHJldHVybiByYW5nZTsKICB9OwoKICAvLyBGdW5jdGlvbiAoYWhlbSkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJldXNhYmxlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciBwcm90b3R5cGUgc2V0dGluZy4KICB2YXIgY3RvciA9IGZ1bmN0aW9uKCl7fTsKCiAgLy8gQ3JlYXRlIGEgZnVuY3Rpb24gYm91bmQgdG8gYSBnaXZlbiBvYmplY3QgKGFzc2lnbmluZyBgdGhpc2AsIGFuZCBhcmd1bWVudHMsCiAgLy8gb3B0aW9uYWxseSkuIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBGdW5jdGlvbi5iaW5kYCBpZgogIC8vIGF2YWlsYWJsZS4KICBfLmJpbmQgPSBmdW5jdGlvbihmdW5jLCBjb250ZXh0KSB7CiAgICB2YXIgYXJncywgYm91bmQ7CiAgICBpZiAobmF0aXZlQmluZCAmJiBmdW5jLmJpbmQgPT09IG5hdGl2ZUJpbmQpIHJldHVybiBuYXRpdmVCaW5kLmFwcGx5KGZ1bmMsIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBpZiAoIV8uaXNGdW5jdGlvbihmdW5jKSkgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICByZXR1cm4gYm91bmQgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIGJvdW5kKSkgcmV0dXJuIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgIGN0b3IucHJvdG90eXBlID0gZnVuYy5wcm90b3R5cGU7CiAgICAgIHZhciBzZWxmID0gbmV3IGN0b3I7CiAgICAgIGN0b3IucHJvdG90eXBlID0gbnVsbDsKICAgICAgdmFyIHJlc3VsdCA9IGZ1bmMuYXBwbHkoc2VsZiwgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgIGlmIChPYmplY3QocmVzdWx0KSA9PT0gcmVzdWx0KSByZXR1cm4gcmVzdWx0OwogICAgICByZXR1cm4gc2VsZjsKICAgIH07CiAgfTsKCiAgLy8gUGFydGlhbGx5IGFwcGx5IGEgZnVuY3Rpb24gYnkgY3JlYXRpbmcgYSB2ZXJzaW9uIHRoYXQgaGFzIGhhZCBzb21lIG9mIGl0cwogIC8vIGFyZ3VtZW50cyBwcmUtZmlsbGVkLCB3aXRob3V0IGNoYW5naW5nIGl0cyBkeW5hbWljIGB0aGlzYCBjb250ZXh0LgogIF8ucGFydGlhbCA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzLCBhcmdzLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgIH07CiAgfTsKCiAgLy8gQmluZCBhbGwgb2YgYW4gb2JqZWN0J3MgbWV0aG9kcyB0byB0aGF0IG9iamVjdC4gVXNlZnVsIGZvciBlbnN1cmluZyB0aGF0CiAgLy8gYWxsIGNhbGxiYWNrcyBkZWZpbmVkIG9uIGFuIG9iamVjdCBiZWxvbmcgdG8gaXQuCiAgXy5iaW5kQWxsID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgZnVuY3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICBpZiAoZnVuY3MubGVuZ3RoID09PSAwKSB0aHJvdyBuZXcgRXJyb3IoImJpbmRBbGwgbXVzdCBiZSBwYXNzZWQgZnVuY3Rpb24gbmFtZXMiKTsKICAgIGVhY2goZnVuY3MsIGZ1bmN0aW9uKGYpIHsgb2JqW2ZdID0gXy5iaW5kKG9ialtmXSwgb2JqKTsgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIE1lbW9pemUgYW4gZXhwZW5zaXZlIGZ1bmN0aW9uIGJ5IHN0b3JpbmcgaXRzIHJlc3VsdHMuCiAgXy5tZW1vaXplID0gZnVuY3Rpb24oZnVuYywgaGFzaGVyKSB7CiAgICB2YXIgbWVtbyA9IHt9OwogICAgaGFzaGVyIHx8IChoYXNoZXIgPSBfLmlkZW50aXR5KTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGtleSA9IGhhc2hlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICByZXR1cm4gXy5oYXMobWVtbywga2V5KSA/IG1lbW9ba2V5XSA6IChtZW1vW2tleV0gPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgfTsKICB9OwoKICAvLyBEZWxheXMgYSBmdW5jdGlvbiBmb3IgdGhlIGdpdmVuIG51bWJlciBvZiBtaWxsaXNlY29uZHMsIGFuZCB0aGVuIGNhbGxzCiAgLy8gaXQgd2l0aCB0aGUgYXJndW1lbnRzIHN1cHBsaWVkLgogIF8uZGVsYXkgPSBmdW5jdGlvbihmdW5jLCB3YWl0KSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7IHJldHVybiBmdW5jLmFwcGx5KG51bGwsIGFyZ3MpOyB9LCB3YWl0KTsKICB9OwoKICAvLyBEZWZlcnMgYSBmdW5jdGlvbiwgc2NoZWR1bGluZyBpdCB0byBydW4gYWZ0ZXIgdGhlIGN1cnJlbnQgY2FsbCBzdGFjayBoYXMKICAvLyBjbGVhcmVkLgogIF8uZGVmZXIgPSBmdW5jdGlvbihmdW5jKSB7CiAgICByZXR1cm4gXy5kZWxheS5hcHBseShfLCBbZnVuYywgMV0uY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSkpOwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiwgdGhhdCwgd2hlbiBpbnZva2VkLCB3aWxsIG9ubHkgYmUgdHJpZ2dlcmVkIGF0IG1vc3Qgb25jZQogIC8vIGR1cmluZyBhIGdpdmVuIHdpbmRvdyBvZiB0aW1lLiBOb3JtYWxseSwgdGhlIHRocm90dGxlZCBmdW5jdGlvbiB3aWxsIHJ1bgogIC8vIGFzIG11Y2ggYXMgaXQgY2FuLCB3aXRob3V0IGV2ZXIgZ29pbmcgbW9yZSB0aGFuIG9uY2UgcGVyIGB3YWl0YCBkdXJhdGlvbjsKICAvLyBidXQgaWYgeW91J2QgbGlrZSB0byBkaXNhYmxlIHRoZSBleGVjdXRpb24gb24gdGhlIGxlYWRpbmcgZWRnZSwgcGFzcwogIC8vIGB7bGVhZGluZzogZmFsc2V9YC4gVG8gZGlzYWJsZSBleGVjdXRpb24gb24gdGhlIHRyYWlsaW5nIGVkZ2UsIGRpdHRvLgogIF8udGhyb3R0bGUgPSBmdW5jdGlvbihmdW5jLCB3YWl0LCBvcHRpb25zKSB7CiAgICB2YXIgY29udGV4dCwgYXJncywgcmVzdWx0OwogICAgdmFyIHRpbWVvdXQgPSBudWxsOwogICAgdmFyIHByZXZpb3VzID0gMDsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbigpIHsKICAgICAgcHJldmlvdXMgPSBvcHRpb25zLmxlYWRpbmcgPT09IGZhbHNlID8gMCA6IG5ldyBEYXRlOwogICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgIH07CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBub3cgPSBuZXcgRGF0ZTsKICAgICAgaWYgKCFwcmV2aW91cyAmJiBvcHRpb25zLmxlYWRpbmcgPT09IGZhbHNlKSBwcmV2aW91cyA9IG5vdzsKICAgICAgdmFyIHJlbWFpbmluZyA9IHdhaXQgLSAobm93IC0gcHJldmlvdXMpOwogICAgICBjb250ZXh0ID0gdGhpczsKICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgaWYgKHJlbWFpbmluZyA8PSAwKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgIHByZXZpb3VzID0gbm93OwogICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgIH0gZWxzZSBpZiAoIXRpbWVvdXQgJiYgb3B0aW9ucy50cmFpbGluZyAhPT0gZmFsc2UpIHsKICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgcmVtYWluaW5nKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIGFzIGxvbmcgYXMgaXQgY29udGludWVzIHRvIGJlIGludm9rZWQsIHdpbGwgbm90CiAgLy8gYmUgdHJpZ2dlcmVkLiBUaGUgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgYWZ0ZXIgaXQgc3RvcHMgYmVpbmcgY2FsbGVkIGZvcgogIC8vIE4gbWlsbGlzZWNvbmRzLiBJZiBgaW1tZWRpYXRlYCBpcyBwYXNzZWQsIHRyaWdnZXIgdGhlIGZ1bmN0aW9uIG9uIHRoZQogIC8vIGxlYWRpbmcgZWRnZSwgaW5zdGVhZCBvZiB0aGUgdHJhaWxpbmcuCiAgXy5kZWJvdW5jZSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQsIGltbWVkaWF0ZSkgewogICAgdmFyIHRpbWVvdXQsIGFyZ3MsIGNvbnRleHQsIHRpbWVzdGFtcCwgcmVzdWx0OwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBjb250ZXh0ID0gdGhpczsKICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgdGltZXN0YW1wID0gbmV3IERhdGUoKTsKICAgICAgdmFyIGxhdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGxhc3QgPSAobmV3IERhdGUoKSkgLSB0aW1lc3RhbXA7CiAgICAgICAgaWYgKGxhc3QgPCB3YWl0KSB7CiAgICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCAtIGxhc3QpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICAgIGlmICghaW1tZWRpYXRlKSByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgdmFyIGNhbGxOb3cgPSBpbW1lZGlhdGUgJiYgIXRpbWVvdXQ7CiAgICAgIGlmICghdGltZW91dCkgewogICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCB3YWl0KTsKICAgICAgfQogICAgICBpZiAoY2FsbE5vdykgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBleGVjdXRlZCBhdCBtb3N0IG9uZSB0aW1lLCBubyBtYXR0ZXIgaG93CiAgLy8gb2Z0ZW4geW91IGNhbGwgaXQuIFVzZWZ1bCBmb3IgbGF6eSBpbml0aWFsaXphdGlvbi4KICBfLm9uY2UgPSBmdW5jdGlvbihmdW5jKSB7CiAgICB2YXIgcmFuID0gZmFsc2UsIG1lbW87CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGlmIChyYW4pIHJldHVybiBtZW1vOwogICAgICByYW4gPSB0cnVlOwogICAgICBtZW1vID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICBmdW5jID0gbnVsbDsKICAgICAgcmV0dXJuIG1lbW87CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgdGhlIGZpcnN0IGZ1bmN0aW9uIHBhc3NlZCBhcyBhbiBhcmd1bWVudCB0byB0aGUgc2Vjb25kLAogIC8vIGFsbG93aW5nIHlvdSB0byBhZGp1c3QgYXJndW1lbnRzLCBydW4gY29kZSBiZWZvcmUgYW5kIGFmdGVyLCBhbmQKICAvLyBjb25kaXRpb25hbGx5IGV4ZWN1dGUgdGhlIG9yaWdpbmFsIGZ1bmN0aW9uLgogIF8ud3JhcCA9IGZ1bmN0aW9uKGZ1bmMsIHdyYXBwZXIpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBbZnVuY107CiAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHdyYXBwZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IGlzIHRoZSBjb21wb3NpdGlvbiBvZiBhIGxpc3Qgb2YgZnVuY3Rpb25zLCBlYWNoCiAgLy8gY29uc3VtaW5nIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGZ1bmN0aW9uIHRoYXQgZm9sbG93cy4KICBfLmNvbXBvc2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBmdW5jcyA9IGFyZ3VtZW50czsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIGZvciAodmFyIGkgPSBmdW5jcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIGFyZ3MgPSBbZnVuY3NbaV0uYXBwbHkodGhpcywgYXJncyldOwogICAgICB9CiAgICAgIHJldHVybiBhcmdzWzBdOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgYWZ0ZXIgYmVpbmcgY2FsbGVkIE4gdGltZXMuCiAgXy5hZnRlciA9IGZ1bmN0aW9uKHRpbWVzLCBmdW5jKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGlmICgtLXRpbWVzIDwgMSkgewogICAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH07CiAgfTsKCiAgLy8gT2JqZWN0IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gUmV0cmlldmUgdGhlIG5hbWVzIG9mIGFuIG9iamVjdCdzIHByb3BlcnRpZXMuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYE9iamVjdC5rZXlzYAogIF8ua2V5cyA9IG5hdGl2ZUtleXMgfHwgZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqICE9PSBPYmplY3Qob2JqKSkgdGhyb3cgbmV3IFR5cGVFcnJvcignSW52YWxpZCBvYmplY3QnKTsKICAgIHZhciBrZXlzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSBrZXlzLnB1c2goa2V5KTsKICAgIHJldHVybiBrZXlzOwogIH07CgogIC8vIFJldHJpZXZlIHRoZSB2YWx1ZXMgb2YgYW4gb2JqZWN0J3MgcHJvcGVydGllcy4KICBfLnZhbHVlcyA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGtleXMgPSBfLmtleXMob2JqKTsKICAgIHZhciBsZW5ndGggPSBrZXlzLmxlbmd0aDsKICAgIHZhciB2YWx1ZXMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgdmFsdWVzW2ldID0gb2JqW2tleXNbaV1dOwogICAgfQogICAgcmV0dXJuIHZhbHVlczsKICB9OwoKICAvLyBDb252ZXJ0IGFuIG9iamVjdCBpbnRvIGEgbGlzdCBvZiBgW2tleSwgdmFsdWVdYCBwYWlycy4KICBfLnBhaXJzID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwogICAgdmFyIGxlbmd0aCA9IGtleXMubGVuZ3RoOwogICAgdmFyIHBhaXJzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHBhaXJzW2ldID0gW2tleXNbaV0sIG9ialtrZXlzW2ldXV07CiAgICB9CiAgICByZXR1cm4gcGFpcnM7CiAgfTsKCiAgLy8gSW52ZXJ0IHRoZSBrZXlzIGFuZCB2YWx1ZXMgb2YgYW4gb2JqZWN0LiBUaGUgdmFsdWVzIG11c3QgYmUgc2VyaWFsaXphYmxlLgogIF8uaW52ZXJ0ID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwogICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGtleXMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgcmVzdWx0W29ialtrZXlzW2ldXV0gPSBrZXlzW2ldOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBSZXR1cm4gYSBzb3J0ZWQgbGlzdCBvZiB0aGUgZnVuY3Rpb24gbmFtZXMgYXZhaWxhYmxlIG9uIHRoZSBvYmplY3QuCiAgLy8gQWxpYXNlZCBhcyBgbWV0aG9kc2AKICBfLmZ1bmN0aW9ucyA9IF8ubWV0aG9kcyA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIG5hbWVzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24ob2JqW2tleV0pKSBuYW1lcy5wdXNoKGtleSk7CiAgICB9CiAgICByZXR1cm4gbmFtZXMuc29ydCgpOwogIH07CgogIC8vIEV4dGVuZCBhIGdpdmVuIG9iamVjdCB3aXRoIGFsbCB0aGUgcHJvcGVydGllcyBpbiBwYXNzZWQtaW4gb2JqZWN0KHMpLgogIF8uZXh0ZW5kID0gZnVuY3Rpb24ob2JqKSB7CiAgICBlYWNoKHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSwgZnVuY3Rpb24oc291cmNlKSB7CiAgICAgIGlmIChzb3VyY2UpIHsKICAgICAgICBmb3IgKHZhciBwcm9wIGluIHNvdXJjZSkgewogICAgICAgICAgb2JqW3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCBvbmx5IGNvbnRhaW5pbmcgdGhlIHdoaXRlbGlzdGVkIHByb3BlcnRpZXMuCiAgXy5waWNrID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgY29weSA9IHt9OwogICAgdmFyIGtleXMgPSBjb25jYXQuYXBwbHkoQXJyYXlQcm90bywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIGVhY2goa2V5cywgZnVuY3Rpb24oa2V5KSB7CiAgICAgIGlmIChrZXkgaW4gb2JqKSBjb3B5W2tleV0gPSBvYmpba2V5XTsKICAgIH0pOwogICAgcmV0dXJuIGNvcHk7CiAgfTsKCiAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCB3aXRob3V0IHRoZSBibGFja2xpc3RlZCBwcm9wZXJ0aWVzLgogIF8ub21pdCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGNvcHkgPSB7fTsKICAgIHZhciBrZXlzID0gY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgIGlmICghXy5jb250YWlucyhrZXlzLCBrZXkpKSBjb3B5W2tleV0gPSBvYmpba2V5XTsKICAgIH0KICAgIHJldHVybiBjb3B5OwogIH07CgogIC8vIEZpbGwgaW4gYSBnaXZlbiBvYmplY3Qgd2l0aCBkZWZhdWx0IHByb3BlcnRpZXMuCiAgXy5kZWZhdWx0cyA9IGZ1bmN0aW9uKG9iaikgewogICAgZWFjaChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICAgIGlmIChvYmpbcHJvcF0gPT09IHZvaWQgMCkgb2JqW3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIENyZWF0ZSBhIChzaGFsbG93LWNsb25lZCkgZHVwbGljYXRlIG9mIGFuIG9iamVjdC4KICBfLmNsb25lID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIV8uaXNPYmplY3Qob2JqKSkgcmV0dXJuIG9iajsKICAgIHJldHVybiBfLmlzQXJyYXkob2JqKSA/IG9iai5zbGljZSgpIDogXy5leHRlbmQoe30sIG9iaik7CiAgfTsKCiAgLy8gSW52b2tlcyBpbnRlcmNlcHRvciB3aXRoIHRoZSBvYmosIGFuZCB0aGVuIHJldHVybnMgb2JqLgogIC8vIFRoZSBwcmltYXJ5IHB1cnBvc2Ugb2YgdGhpcyBtZXRob2QgaXMgdG8gInRhcCBpbnRvIiBhIG1ldGhvZCBjaGFpbiwgaW4KICAvLyBvcmRlciB0byBwZXJmb3JtIG9wZXJhdGlvbnMgb24gaW50ZXJtZWRpYXRlIHJlc3VsdHMgd2l0aGluIHRoZSBjaGFpbi4KICBfLnRhcCA9IGZ1bmN0aW9uKG9iaiwgaW50ZXJjZXB0b3IpIHsKICAgIGludGVyY2VwdG9yKG9iaik7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIEludGVybmFsIHJlY3Vyc2l2ZSBjb21wYXJpc29uIGZ1bmN0aW9uIGZvciBgaXNFcXVhbGAuCiAgdmFyIGVxID0gZnVuY3Rpb24oYSwgYiwgYVN0YWNrLCBiU3RhY2spIHsKICAgIC8vIElkZW50aWNhbCBvYmplY3RzIGFyZSBlcXVhbC4gYDAgPT09IC0wYCwgYnV0IHRoZXkgYXJlbid0IGlkZW50aWNhbC4KICAgIC8vIFNlZSB0aGUgW0hhcm1vbnkgYGVnYWxgIHByb3Bvc2FsXShodHRwOi8vd2lraS5lY21hc2NyaXB0Lm9yZy9kb2t1LnBocD9pZD1oYXJtb255OmVnYWwpLgogICAgaWYgKGEgPT09IGIpIHJldHVybiBhICE9PSAwIHx8IDEgLyBhID09IDEgLyBiOwogICAgLy8gQSBzdHJpY3QgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkgYmVjYXVzZSBgbnVsbCA9PSB1bmRlZmluZWRgLgogICAgaWYgKGEgPT0gbnVsbCB8fCBiID09IG51bGwpIHJldHVybiBhID09PSBiOwogICAgLy8gVW53cmFwIGFueSB3cmFwcGVkIG9iamVjdHMuCiAgICBpZiAoYSBpbnN0YW5jZW9mIF8pIGEgPSBhLl93cmFwcGVkOwogICAgaWYgKGIgaW5zdGFuY2VvZiBfKSBiID0gYi5fd3JhcHBlZDsKICAgIC8vIENvbXBhcmUgYFtbQ2xhc3NdXWAgbmFtZXMuCiAgICB2YXIgY2xhc3NOYW1lID0gdG9TdHJpbmcuY2FsbChhKTsKICAgIGlmIChjbGFzc05hbWUgIT0gdG9TdHJpbmcuY2FsbChiKSkgcmV0dXJuIGZhbHNlOwogICAgc3dpdGNoIChjbGFzc05hbWUpIHsKICAgICAgLy8gU3RyaW5ncywgbnVtYmVycywgZGF0ZXMsIGFuZCBib29sZWFucyBhcmUgY29tcGFyZWQgYnkgdmFsdWUuCiAgICAgIGNhc2UgJ1tvYmplY3QgU3RyaW5nXSc6CiAgICAgICAgLy8gUHJpbWl0aXZlcyBhbmQgdGhlaXIgY29ycmVzcG9uZGluZyBvYmplY3Qgd3JhcHBlcnMgYXJlIGVxdWl2YWxlbnQ7IHRodXMsIGAiNSJgIGlzCiAgICAgICAgLy8gZXF1aXZhbGVudCB0byBgbmV3IFN0cmluZygiNSIpYC4KICAgICAgICByZXR1cm4gYSA9PSBTdHJpbmcoYik7CiAgICAgIGNhc2UgJ1tvYmplY3QgTnVtYmVyXSc6CiAgICAgICAgLy8gYE5hTmBzIGFyZSBlcXVpdmFsZW50LCBidXQgbm9uLXJlZmxleGl2ZS4gQW4gYGVnYWxgIGNvbXBhcmlzb24gaXMgcGVyZm9ybWVkIGZvcgogICAgICAgIC8vIG90aGVyIG51bWVyaWMgdmFsdWVzLgogICAgICAgIHJldHVybiBhICE9ICthID8gYiAhPSArYiA6IChhID09IDAgPyAxIC8gYSA9PSAxIC8gYiA6IGEgPT0gK2IpOwogICAgICBjYXNlICdbb2JqZWN0IERhdGVdJzoKICAgICAgY2FzZSAnW29iamVjdCBCb29sZWFuXSc6CiAgICAgICAgLy8gQ29lcmNlIGRhdGVzIGFuZCBib29sZWFucyB0byBudW1lcmljIHByaW1pdGl2ZSB2YWx1ZXMuIERhdGVzIGFyZSBjb21wYXJlZCBieSB0aGVpcgogICAgICAgIC8vIG1pbGxpc2Vjb25kIHJlcHJlc2VudGF0aW9ucy4gTm90ZSB0aGF0IGludmFsaWQgZGF0ZXMgd2l0aCBtaWxsaXNlY29uZCByZXByZXNlbnRhdGlvbnMKICAgICAgICAvLyBvZiBgTmFOYCBhcmUgbm90IGVxdWl2YWxlbnQuCiAgICAgICAgcmV0dXJuICthID09ICtiOwogICAgICAvLyBSZWdFeHBzIGFyZSBjb21wYXJlZCBieSB0aGVpciBzb3VyY2UgcGF0dGVybnMgYW5kIGZsYWdzLgogICAgICBjYXNlICdbb2JqZWN0IFJlZ0V4cF0nOgogICAgICAgIHJldHVybiBhLnNvdXJjZSA9PSBiLnNvdXJjZSAmJgogICAgICAgICAgICAgICBhLmdsb2JhbCA9PSBiLmdsb2JhbCAmJgogICAgICAgICAgICAgICBhLm11bHRpbGluZSA9PSBiLm11bHRpbGluZSAmJgogICAgICAgICAgICAgICBhLmlnbm9yZUNhc2UgPT0gYi5pZ25vcmVDYXNlOwogICAgfQogICAgaWYgKHR5cGVvZiBhICE9ICdvYmplY3QnIHx8IHR5cGVvZiBiICE9ICdvYmplY3QnKSByZXR1cm4gZmFsc2U7CiAgICAvLyBBc3N1bWUgZXF1YWxpdHkgZm9yIGN5Y2xpYyBzdHJ1Y3R1cmVzLiBUaGUgYWxnb3JpdGhtIGZvciBkZXRlY3RpbmcgY3ljbGljCiAgICAvLyBzdHJ1Y3R1cmVzIGlzIGFkYXB0ZWQgZnJvbSBFUyA1LjEgc2VjdGlvbiAxNS4xMi4zLCBhYnN0cmFjdCBvcGVyYXRpb24gYEpPYC4KICAgIHZhciBsZW5ndGggPSBhU3RhY2subGVuZ3RoOwogICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgIC8vIExpbmVhciBzZWFyY2guIFBlcmZvcm1hbmNlIGlzIGludmVyc2VseSBwcm9wb3J0aW9uYWwgdG8gdGhlIG51bWJlciBvZgogICAgICAvLyB1bmlxdWUgbmVzdGVkIHN0cnVjdHVyZXMuCiAgICAgIGlmIChhU3RhY2tbbGVuZ3RoXSA9PSBhKSByZXR1cm4gYlN0YWNrW2xlbmd0aF0gPT0gYjsKICAgIH0KICAgIC8vIE9iamVjdHMgd2l0aCBkaWZmZXJlbnQgY29uc3RydWN0b3JzIGFyZSBub3QgZXF1aXZhbGVudCwgYnV0IGBPYmplY3RgcwogICAgLy8gZnJvbSBkaWZmZXJlbnQgZnJhbWVzIGFyZS4KICAgIHZhciBhQ3RvciA9IGEuY29uc3RydWN0b3IsIGJDdG9yID0gYi5jb25zdHJ1Y3RvcjsKICAgIGlmIChhQ3RvciAhPT0gYkN0b3IgJiYgIShfLmlzRnVuY3Rpb24oYUN0b3IpICYmIChhQ3RvciBpbnN0YW5jZW9mIGFDdG9yKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uaXNGdW5jdGlvbihiQ3RvcikgJiYgKGJDdG9yIGluc3RhbmNlb2YgYkN0b3IpKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICAvLyBBZGQgdGhlIGZpcnN0IG9iamVjdCB0byB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMuCiAgICBhU3RhY2sucHVzaChhKTsKICAgIGJTdGFjay5wdXNoKGIpOwogICAgdmFyIHNpemUgPSAwLCByZXN1bHQgPSB0cnVlOwogICAgLy8gUmVjdXJzaXZlbHkgY29tcGFyZSBvYmplY3RzIGFuZCBhcnJheXMuCiAgICBpZiAoY2xhc3NOYW1lID09ICdbb2JqZWN0IEFycmF5XScpIHsKICAgICAgLy8gQ29tcGFyZSBhcnJheSBsZW5ndGhzIHRvIGRldGVybWluZSBpZiBhIGRlZXAgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkuCiAgICAgIHNpemUgPSBhLmxlbmd0aDsKICAgICAgcmVzdWx0ID0gc2l6ZSA9PSBiLmxlbmd0aDsKICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIC8vIERlZXAgY29tcGFyZSB0aGUgY29udGVudHMsIGlnbm9yaW5nIG5vbi1udW1lcmljIHByb3BlcnRpZXMuCiAgICAgICAgd2hpbGUgKHNpemUtLSkgewogICAgICAgICAgaWYgKCEocmVzdWx0ID0gZXEoYVtzaXplXSwgYltzaXplXSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBEZWVwIGNvbXBhcmUgb2JqZWN0cy4KICAgICAgZm9yICh2YXIga2V5IGluIGEpIHsKICAgICAgICBpZiAoXy5oYXMoYSwga2V5KSkgewogICAgICAgICAgLy8gQ291bnQgdGhlIGV4cGVjdGVkIG51bWJlciBvZiBwcm9wZXJ0aWVzLgogICAgICAgICAgc2l6ZSsrOwogICAgICAgICAgLy8gRGVlcCBjb21wYXJlIGVhY2ggbWVtYmVyLgogICAgICAgICAgaWYgKCEocmVzdWx0ID0gXy5oYXMoYiwga2V5KSAmJiBlcShhW2tleV0sIGJba2V5XSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIEVuc3VyZSB0aGF0IGJvdGggb2JqZWN0cyBjb250YWluIHRoZSBzYW1lIG51bWJlciBvZiBwcm9wZXJ0aWVzLgogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgZm9yIChrZXkgaW4gYikgewogICAgICAgICAgaWYgKF8uaGFzKGIsIGtleSkgJiYgIShzaXplLS0pKSBicmVhazsKICAgICAgICB9CiAgICAgICAgcmVzdWx0ID0gIXNpemU7CiAgICAgIH0KICAgIH0KICAgIC8vIFJlbW92ZSB0aGUgZmlyc3Qgb2JqZWN0IGZyb20gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgogICAgYVN0YWNrLnBvcCgpOwogICAgYlN0YWNrLnBvcCgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBQZXJmb3JtIGEgZGVlcCBjb21wYXJpc29uIHRvIGNoZWNrIGlmIHR3byBvYmplY3RzIGFyZSBlcXVhbC4KICBfLmlzRXF1YWwgPSBmdW5jdGlvbihhLCBiKSB7CiAgICByZXR1cm4gZXEoYSwgYiwgW10sIFtdKTsKICB9OwoKICAvLyBJcyBhIGdpdmVuIGFycmF5LCBzdHJpbmcsIG9yIG9iamVjdCBlbXB0eT8KICAvLyBBbiAiZW1wdHkiIG9iamVjdCBoYXMgbm8gZW51bWVyYWJsZSBvd24tcHJvcGVydGllcy4KICBfLmlzRW1wdHkgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHRydWU7CiAgICBpZiAoXy5pc0FycmF5KG9iaikgfHwgXy5pc1N0cmluZyhvYmopKSByZXR1cm4gb2JqLmxlbmd0aCA9PT0gMDsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIHJldHVybiBmYWxzZTsKICAgIHJldHVybiB0cnVlOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBET00gZWxlbWVudD8KICBfLmlzRWxlbWVudCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuICEhKG9iaiAmJiBvYmoubm9kZVR5cGUgPT09IDEpOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYW4gYXJyYXk/CiAgLy8gRGVsZWdhdGVzIHRvIEVDTUE1J3MgbmF0aXZlIEFycmF5LmlzQXJyYXkKICBfLmlzQXJyYXkgPSBuYXRpdmVJc0FycmF5IHx8IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PSAnW29iamVjdCBBcnJheV0nOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFyaWFibGUgYW4gb2JqZWN0PwogIF8uaXNPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IE9iamVjdChvYmopOwogIH07CgogIC8vIEFkZCBzb21lIGlzVHlwZSBtZXRob2RzOiBpc0FyZ3VtZW50cywgaXNGdW5jdGlvbiwgaXNTdHJpbmcsIGlzTnVtYmVyLCBpc0RhdGUsIGlzUmVnRXhwLgogIGVhY2goWydBcmd1bWVudHMnLCAnRnVuY3Rpb24nLCAnU3RyaW5nJywgJ051bWJlcicsICdEYXRlJywgJ1JlZ0V4cCddLCBmdW5jdGlvbihuYW1lKSB7CiAgICBfWydpcycgKyBuYW1lXSA9IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0ICcgKyBuYW1lICsgJ10nOwogICAgfTsKICB9KTsKCiAgLy8gRGVmaW5lIGEgZmFsbGJhY2sgdmVyc2lvbiBvZiB0aGUgbWV0aG9kIGluIGJyb3dzZXJzIChhaGVtLCBJRSksIHdoZXJlCiAgLy8gdGhlcmUgaXNuJ3QgYW55IGluc3BlY3RhYmxlICJBcmd1bWVudHMiIHR5cGUuCiAgaWYgKCFfLmlzQXJndW1lbnRzKGFyZ3VtZW50cykpIHsKICAgIF8uaXNBcmd1bWVudHMgPSBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuICEhKG9iaiAmJiBfLmhhcyhvYmosICdjYWxsZWUnKSk7CiAgICB9OwogIH0KCiAgLy8gT3B0aW1pemUgYGlzRnVuY3Rpb25gIGlmIGFwcHJvcHJpYXRlLgogIGlmICh0eXBlb2YgKC8uLykgIT09ICdmdW5jdGlvbicpIHsKICAgIF8uaXNGdW5jdGlvbiA9IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gJ2Z1bmN0aW9uJzsKICAgIH07CiAgfQoKICAvLyBJcyBhIGdpdmVuIG9iamVjdCBhIGZpbml0ZSBudW1iZXI/CiAgXy5pc0Zpbml0ZSA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIGlzRmluaXRlKG9iaikgJiYgIWlzTmFOKHBhcnNlRmxvYXQob2JqKSk7CiAgfTsKCiAgLy8gSXMgdGhlIGdpdmVuIHZhbHVlIGBOYU5gPyAoTmFOIGlzIHRoZSBvbmx5IG51bWJlciB3aGljaCBkb2VzIG5vdCBlcXVhbCBpdHNlbGYpLgogIF8uaXNOYU4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBfLmlzTnVtYmVyKG9iaikgJiYgb2JqICE9ICtvYmo7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhIGJvb2xlYW4/CiAgXy5pc0Jvb2xlYW4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IHRydWUgfHwgb2JqID09PSBmYWxzZSB8fCB0b1N0cmluZy5jYWxsKG9iaikgPT0gJ1tvYmplY3QgQm9vbGVhbl0nOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgZXF1YWwgdG8gbnVsbD8KICBfLmlzTnVsbCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gbnVsbDsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhcmlhYmxlIHVuZGVmaW5lZD8KICBfLmlzVW5kZWZpbmVkID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSB2b2lkIDA7CiAgfTsKCiAgLy8gU2hvcnRjdXQgZnVuY3Rpb24gZm9yIGNoZWNraW5nIGlmIGFuIG9iamVjdCBoYXMgYSBnaXZlbiBwcm9wZXJ0eSBkaXJlY3RseQogIC8vIG9uIGl0c2VsZiAoaW4gb3RoZXIgd29yZHMsIG5vdCBvbiBhIHByb3RvdHlwZSkuCiAgXy5oYXMgPSBmdW5jdGlvbihvYmosIGtleSkgewogICAgcmV0dXJuIGhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpOwogIH07CgogIC8vIFV0aWxpdHkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gUnVuIFVuZGVyc2NvcmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYF9gIHZhcmlhYmxlIHRvIGl0cwogIC8vIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdC4KICBfLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICAgIHJvb3QuXyA9IHByZXZpb3VzVW5kZXJzY29yZTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIEtlZXAgdGhlIGlkZW50aXR5IGZ1bmN0aW9uIGFyb3VuZCBmb3IgZGVmYXVsdCBpdGVyYXRvcnMuCiAgXy5pZGVudGl0eSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfTsKCiAgLy8gUnVuIGEgZnVuY3Rpb24gKipuKiogdGltZXMuCiAgXy50aW1lcyA9IGZ1bmN0aW9uKG4sIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgYWNjdW0gPSBBcnJheShNYXRoLm1heCgwLCBuKSk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG47IGkrKykgYWNjdW1baV0gPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIGkpOwogICAgcmV0dXJuIGFjY3VtOwogIH07CgogIC8vIFJldHVybiBhIHJhbmRvbSBpbnRlZ2VyIGJldHdlZW4gbWluIGFuZCBtYXggKGluY2x1c2l2ZSkuCiAgXy5yYW5kb20gPSBmdW5jdGlvbihtaW4sIG1heCkgewogICAgaWYgKG1heCA9PSBudWxsKSB7CiAgICAgIG1heCA9IG1pbjsKICAgICAgbWluID0gMDsKICAgIH0KICAgIHJldHVybiBtaW4gKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluICsgMSkpOwogIH07CgogIC8vIExpc3Qgb2YgSFRNTCBlbnRpdGllcyBmb3IgZXNjYXBpbmcuCiAgdmFyIGVudGl0eU1hcCA9IHsKICAgIGVzY2FwZTogewogICAgICAnJic6ICcmYW1wOycsCiAgICAgICc8JzogJyZsdDsnLAogICAgICAnPic6ICcmZ3Q7JywKICAgICAgJyInOiAnJnF1b3Q7JywKICAgICAgIiciOiAnJiN4Mjc7JwogICAgfQogIH07CiAgZW50aXR5TWFwLnVuZXNjYXBlID0gXy5pbnZlcnQoZW50aXR5TWFwLmVzY2FwZSk7CgogIC8vIFJlZ2V4ZXMgY29udGFpbmluZyB0aGUga2V5cyBhbmQgdmFsdWVzIGxpc3RlZCBpbW1lZGlhdGVseSBhYm92ZS4KICB2YXIgZW50aXR5UmVnZXhlcyA9IHsKICAgIGVzY2FwZTogICBuZXcgUmVnRXhwKCdbJyArIF8ua2V5cyhlbnRpdHlNYXAuZXNjYXBlKS5qb2luKCcnKSArICddJywgJ2cnKSwKICAgIHVuZXNjYXBlOiBuZXcgUmVnRXhwKCcoJyArIF8ua2V5cyhlbnRpdHlNYXAudW5lc2NhcGUpLmpvaW4oJ3wnKSArICcpJywgJ2cnKQogIH07CgogIC8vIEZ1bmN0aW9ucyBmb3IgZXNjYXBpbmcgYW5kIHVuZXNjYXBpbmcgc3RyaW5ncyB0by9mcm9tIEhUTUwgaW50ZXJwb2xhdGlvbi4KICBfLmVhY2goWydlc2NhcGUnLCAndW5lc2NhcGUnXSwgZnVuY3Rpb24obWV0aG9kKSB7CiAgICBfW21ldGhvZF0gPSBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgaWYgKHN0cmluZyA9PSBudWxsKSByZXR1cm4gJyc7CiAgICAgIHJldHVybiAoJycgKyBzdHJpbmcpLnJlcGxhY2UoZW50aXR5UmVnZXhlc1ttZXRob2RdLCBmdW5jdGlvbihtYXRjaCkgewogICAgICAgIHJldHVybiBlbnRpdHlNYXBbbWV0aG9kXVttYXRjaF07CiAgICAgIH0pOwogICAgfTsKICB9KTsKCiAgLy8gSWYgdGhlIHZhbHVlIG9mIHRoZSBuYW1lZCBgcHJvcGVydHlgIGlzIGEgZnVuY3Rpb24gdGhlbiBpbnZva2UgaXQgd2l0aCB0aGUKICAvLyBgb2JqZWN0YCBhcyBjb250ZXh0OyBvdGhlcndpc2UsIHJldHVybiBpdC4KICBfLnJlc3VsdCA9IGZ1bmN0aW9uKG9iamVjdCwgcHJvcGVydHkpIHsKICAgIGlmIChvYmplY3QgPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKICAgIHZhciB2YWx1ZSA9IG9iamVjdFtwcm9wZXJ0eV07CiAgICByZXR1cm4gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlLmNhbGwob2JqZWN0KSA6IHZhbHVlOwogIH07CgogIC8vIEFkZCB5b3VyIG93biBjdXN0b20gZnVuY3Rpb25zIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdC4KICBfLm1peGluID0gZnVuY3Rpb24ob2JqKSB7CiAgICBlYWNoKF8uZnVuY3Rpb25zKG9iaiksIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgdmFyIGZ1bmMgPSBfW25hbWVdID0gb2JqW25hbWVdOwogICAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gW3RoaXMuX3dyYXBwZWRdOwogICAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgZnVuYy5hcHBseShfLCBhcmdzKSk7CiAgICAgIH07CiAgICB9KTsKICB9OwoKICAvLyBHZW5lcmF0ZSBhIHVuaXF1ZSBpbnRlZ2VyIGlkICh1bmlxdWUgd2l0aGluIHRoZSBlbnRpcmUgY2xpZW50IHNlc3Npb24pLgogIC8vIFVzZWZ1bCBmb3IgdGVtcG9yYXJ5IERPTSBpZHMuCiAgdmFyIGlkQ291bnRlciA9IDA7CiAgXy51bmlxdWVJZCA9IGZ1bmN0aW9uKHByZWZpeCkgewogICAgdmFyIGlkID0gKytpZENvdW50ZXIgKyAnJzsKICAgIHJldHVybiBwcmVmaXggPyBwcmVmaXggKyBpZCA6IGlkOwogIH07CgogIC8vIEJ5IGRlZmF1bHQsIFVuZGVyc2NvcmUgdXNlcyBFUkItc3R5bGUgdGVtcGxhdGUgZGVsaW1pdGVycywgY2hhbmdlIHRoZQogIC8vIGZvbGxvd2luZyB0ZW1wbGF0ZSBzZXR0aW5ncyB0byB1c2UgYWx0ZXJuYXRpdmUgZGVsaW1pdGVycy4KICBfLnRlbXBsYXRlU2V0dGluZ3MgPSB7CiAgICBldmFsdWF0ZSAgICA6IC88JShbXHNcU10rPyklPi9nLAogICAgaW50ZXJwb2xhdGUgOiAvPCU9KFtcc1xTXSs/KSU+L2csCiAgICBlc2NhcGUgICAgICA6IC88JS0oW1xzXFNdKz8pJT4vZwogIH07CgogIC8vIFdoZW4gY3VzdG9taXppbmcgYHRlbXBsYXRlU2V0dGluZ3NgLCBpZiB5b3UgZG9uJ3Qgd2FudCB0byBkZWZpbmUgYW4KICAvLyBpbnRlcnBvbGF0aW9uLCBldmFsdWF0aW9uIG9yIGVzY2FwaW5nIHJlZ2V4LCB3ZSBuZWVkIG9uZSB0aGF0IGlzCiAgLy8gZ3VhcmFudGVlZCBub3QgdG8gbWF0Y2guCiAgdmFyIG5vTWF0Y2ggPSAvKC4pXi87CgogIC8vIENlcnRhaW4gY2hhcmFjdGVycyBuZWVkIHRvIGJlIGVzY2FwZWQgc28gdGhhdCB0aGV5IGNhbiBiZSBwdXQgaW50byBhCiAgLy8gc3RyaW5nIGxpdGVyYWwuCiAgdmFyIGVzY2FwZXMgPSB7CiAgICAiJyI6ICAgICAgIiciLAogICAgJ1xcJzogICAgICdcXCcsCiAgICAnXHInOiAgICAgJ3InLAogICAgJ1xuJzogICAgICduJywKICAgICdcdCc6ICAgICAndCcsCiAgICAnXHUyMDI4JzogJ3UyMDI4JywKICAgICdcdTIwMjknOiAndTIwMjknCiAgfTsKCiAgdmFyIGVzY2FwZXIgPSAvXFx8J3xccnxcbnxcdHxcdTIwMjh8XHUyMDI5L2c7CgogIC8vIEphdmFTY3JpcHQgbWljcm8tdGVtcGxhdGluZywgc2ltaWxhciB0byBKb2huIFJlc2lnJ3MgaW1wbGVtZW50YXRpb24uCiAgLy8gVW5kZXJzY29yZSB0ZW1wbGF0aW5nIGhhbmRsZXMgYXJiaXRyYXJ5IGRlbGltaXRlcnMsIHByZXNlcnZlcyB3aGl0ZXNwYWNlLAogIC8vIGFuZCBjb3JyZWN0bHkgZXNjYXBlcyBxdW90ZXMgd2l0aGluIGludGVycG9sYXRlZCBjb2RlLgogIF8udGVtcGxhdGUgPSBmdW5jdGlvbih0ZXh0LCBkYXRhLCBzZXR0aW5ncykgewogICAgdmFyIHJlbmRlcjsKICAgIHNldHRpbmdzID0gXy5kZWZhdWx0cyh7fSwgc2V0dGluZ3MsIF8udGVtcGxhdGVTZXR0aW5ncyk7CgogICAgLy8gQ29tYmluZSBkZWxpbWl0ZXJzIGludG8gb25lIHJlZ3VsYXIgZXhwcmVzc2lvbiB2aWEgYWx0ZXJuYXRpb24uCiAgICB2YXIgbWF0Y2hlciA9IG5ldyBSZWdFeHAoWwogICAgICAoc2V0dGluZ3MuZXNjYXBlIHx8IG5vTWF0Y2gpLnNvdXJjZSwKICAgICAgKHNldHRpbmdzLmludGVycG9sYXRlIHx8IG5vTWF0Y2gpLnNvdXJjZSwKICAgICAgKHNldHRpbmdzLmV2YWx1YXRlIHx8IG5vTWF0Y2gpLnNvdXJjZQogICAgXS5qb2luKCd8JykgKyAnfCQnLCAnZycpOwoKICAgIC8vIENvbXBpbGUgdGhlIHRlbXBsYXRlIHNvdXJjZSwgZXNjYXBpbmcgc3RyaW5nIGxpdGVyYWxzIGFwcHJvcHJpYXRlbHkuCiAgICB2YXIgaW5kZXggPSAwOwogICAgdmFyIHNvdXJjZSA9ICJfX3ArPSciOwogICAgdGV4dC5yZXBsYWNlKG1hdGNoZXIsIGZ1bmN0aW9uKG1hdGNoLCBlc2NhcGUsIGludGVycG9sYXRlLCBldmFsdWF0ZSwgb2Zmc2V0KSB7CiAgICAgIHNvdXJjZSArPSB0ZXh0LnNsaWNlKGluZGV4LCBvZmZzZXQpCiAgICAgICAgLnJlcGxhY2UoZXNjYXBlciwgZnVuY3Rpb24obWF0Y2gpIHsgcmV0dXJuICdcXCcgKyBlc2NhcGVzW21hdGNoXTsgfSk7CgogICAgICBpZiAoZXNjYXBlKSB7CiAgICAgICAgc291cmNlICs9ICInK1xuKChfX3Q9KCIgKyBlc2NhcGUgKyAiKSk9PW51bGw/Jyc6Xy5lc2NhcGUoX190KSkrXG4nIjsKICAgICAgfQogICAgICBpZiAoaW50ZXJwb2xhdGUpIHsKICAgICAgICBzb3VyY2UgKz0gIicrXG4oKF9fdD0oIiArIGludGVycG9sYXRlICsgIikpPT1udWxsPycnOl9fdCkrXG4nIjsKICAgICAgfQogICAgICBpZiAoZXZhbHVhdGUpIHsKICAgICAgICBzb3VyY2UgKz0gIic7XG4iICsgZXZhbHVhdGUgKyAiXG5fX3ArPSciOwogICAgICB9CiAgICAgIGluZGV4ID0gb2Zmc2V0ICsgbWF0Y2gubGVuZ3RoOwogICAgICByZXR1cm4gbWF0Y2g7CiAgICB9KTsKICAgIHNvdXJjZSArPSAiJztcbiI7CgogICAgLy8gSWYgYSB2YXJpYWJsZSBpcyBub3Qgc3BlY2lmaWVkLCBwbGFjZSBkYXRhIHZhbHVlcyBpbiBsb2NhbCBzY29wZS4KICAgIGlmICghc2V0dGluZ3MudmFyaWFibGUpIHNvdXJjZSA9ICd3aXRoKG9ianx8e30pe1xuJyArIHNvdXJjZSArICd9XG4nOwoKICAgIHNvdXJjZSA9ICJ2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4sIiArCiAgICAgICJwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9O1xuIiArCiAgICAgIHNvdXJjZSArICJyZXR1cm4gX19wO1xuIjsKCiAgICB0cnkgewogICAgICByZW5kZXIgPSBuZXcgRnVuY3Rpb24oc2V0dGluZ3MudmFyaWFibGUgfHwgJ29iaicsICdfJywgc291cmNlKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZS5zb3VyY2UgPSBzb3VyY2U7CiAgICAgIHRocm93IGU7CiAgICB9CgogICAgaWYgKGRhdGEpIHJldHVybiByZW5kZXIoZGF0YSwgXyk7CiAgICB2YXIgdGVtcGxhdGUgPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHJldHVybiByZW5kZXIuY2FsbCh0aGlzLCBkYXRhLCBfKTsKICAgIH07CgogICAgLy8gUHJvdmlkZSB0aGUgY29tcGlsZWQgZnVuY3Rpb24gc291cmNlIGFzIGEgY29udmVuaWVuY2UgZm9yIHByZWNvbXBpbGF0aW9uLgogICAgdGVtcGxhdGUuc291cmNlID0gJ2Z1bmN0aW9uKCcgKyAoc2V0dGluZ3MudmFyaWFibGUgfHwgJ29iaicpICsgJyl7XG4nICsgc291cmNlICsgJ30nOwoKICAgIHJldHVybiB0ZW1wbGF0ZTsKICB9OwoKICAvLyBBZGQgYSAiY2hhaW4iIGZ1bmN0aW9uLCB3aGljaCB3aWxsIGRlbGVnYXRlIHRvIHRoZSB3cmFwcGVyLgogIF8uY2hhaW4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBfKG9iaikuY2hhaW4oKTsKICB9OwoKICAvLyBPT1AKICAvLyAtLS0tLS0tLS0tLS0tLS0KICAvLyBJZiBVbmRlcnNjb3JlIGlzIGNhbGxlZCBhcyBhIGZ1bmN0aW9uLCBpdCByZXR1cm5zIGEgd3JhcHBlZCBvYmplY3QgdGhhdAogIC8vIGNhbiBiZSB1c2VkIE9PLXN0eWxlLiBUaGlzIHdyYXBwZXIgaG9sZHMgYWx0ZXJlZCB2ZXJzaW9ucyBvZiBhbGwgdGhlCiAgLy8gdW5kZXJzY29yZSBmdW5jdGlvbnMuIFdyYXBwZWQgb2JqZWN0cyBtYXkgYmUgY2hhaW5lZC4KCiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvbnRpbnVlIGNoYWluaW5nIGludGVybWVkaWF0ZSByZXN1bHRzLgogIHZhciByZXN1bHQgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiB0aGlzLl9jaGFpbiA/IF8ob2JqKS5jaGFpbigpIDogb2JqOwogIH07CgogIC8vIEFkZCBhbGwgb2YgdGhlIFVuZGVyc2NvcmUgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyIG9iamVjdC4KICBfLm1peGluKF8pOwoKICAvLyBBZGQgYWxsIG11dGF0b3IgQXJyYXkgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyLgogIGVhY2goWydwb3AnLCAncHVzaCcsICdyZXZlcnNlJywgJ3NoaWZ0JywgJ3NvcnQnLCAnc3BsaWNlJywgJ3Vuc2hpZnQnXSwgZnVuY3Rpb24obmFtZSkgewogICAgdmFyIG1ldGhvZCA9IEFycmF5UHJvdG9bbmFtZV07CiAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb2JqID0gdGhpcy5fd3JhcHBlZDsKICAgICAgbWV0aG9kLmFwcGx5KG9iaiwgYXJndW1lbnRzKTsKICAgICAgaWYgKChuYW1lID09ICdzaGlmdCcgfHwgbmFtZSA9PSAnc3BsaWNlJykgJiYgb2JqLmxlbmd0aCA9PT0gMCkgZGVsZXRlIG9ialswXTsKICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIG9iaik7CiAgICB9OwogIH0pOwoKICAvLyBBZGQgYWxsIGFjY2Vzc29yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KICBlYWNoKFsnY29uY2F0JywgJ2pvaW4nLCAnc2xpY2UnXSwgZnVuY3Rpb24obmFtZSkgewogICAgdmFyIG1ldGhvZCA9IEFycmF5UHJvdG9bbmFtZV07CiAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgbWV0aG9kLmFwcGx5KHRoaXMuX3dyYXBwZWQsIGFyZ3VtZW50cykpOwogICAgfTsKICB9KTsKCiAgXy5leHRlbmQoXy5wcm90b3R5cGUsIHsKCiAgICAvLyBTdGFydCBjaGFpbmluZyBhIHdyYXBwZWQgVW5kZXJzY29yZSBvYmplY3QuCiAgICBjaGFpbjogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuX2NoYWluID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEV4dHJhY3RzIHRoZSByZXN1bHQgZnJvbSBhIHdyYXBwZWQgYW5kIGNoYWluZWQgb2JqZWN0LgogICAgdmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5fd3JhcHBlZDsKICAgIH0KCiAgfSk7Cgp9KS5jYWxsKHRoaXMpOwoKZGVmaW5lKCJ1bmRlcnNjb3JlIiwgKGZ1bmN0aW9uIChnbG9iYWwpIHsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHJldCwgZm47CiAgICAgICAgcmV0dXJuIHJldCB8fCBnbG9iYWwuXzsKICAgIH07Cn0odGhpcykpKTsKCmRlZmluZSgnZWRpc29uL2xpYi9taWNyb2V2ZW50JyxbXSwgZnVuY3Rpb24oKSB7CgoJLyoqCgkgKiBNaWNyb0V2ZW50IC0gdG8gbWFrZSBhbnkganMgb2JqZWN0IGFuIGV2ZW50IGVtaXR0ZXIgKHNlcnZlciBvciBicm93c2VyKQoJICoKCSAqIC0gcHVyZSBqYXZhc2NyaXB0IC0gc2VydmVyIGNvbXBhdGlibGUsIGJyb3dzZXIgY29tcGF0aWJsZQoJICogLSBkb250IHJlbHkgb24gdGhlIGJyb3dzZXIgZG9tcwoJICogLSBzdXBlciBzaW1wbGUgLSB5b3UgZ2V0IGl0IGltbWVkaWF0bHksIG5vIG1pc3RlcnksIG5vIG1hZ2ljIGludm9sdmVkCgkgKgoJICogLSBjcmVhdGUgYSBNaWNyb0V2ZW50RGVidWcgd2l0aCBnb29kaWVzIHRvIGRlYnVnCgkgKiAgIC0gbWFrZSBpdCBzYWZlciB0byB1c2UKCSovCgl2YXIgTWljcm9FdmVudAk9IGZ1bmN0aW9uKCl7fTsKCU1pY3JvRXZlbnQucHJvdG90eXBlCT0gewoJCWJpbmQJOiBmdW5jdGlvbihldmVudCwgZmN0KXsKCQkJdGhpcy5fZXZlbnRzID0gdGhpcy5fZXZlbnRzIHx8IHt9OwoJCQl0aGlzLl9ldmVudHNbZXZlbnRdID0gdGhpcy5fZXZlbnRzW2V2ZW50XQl8fCBbXTsKCQkJdGhpcy5fZXZlbnRzW2V2ZW50XS5wdXNoKGZjdCk7CgkJfSwKCQl1bmJpbmQJOiBmdW5jdGlvbihldmVudCwgZmN0KXsKCQkJdGhpcy5fZXZlbnRzID0gdGhpcy5fZXZlbnRzIHx8IHt9OwoJCQlpZiggZXZlbnQgaW4gdGhpcy5fZXZlbnRzID09PSBmYWxzZSAgKQlyZXR1cm47CgkJCXRoaXMuX2V2ZW50c1tldmVudF0uc3BsaWNlKHRoaXMuX2V2ZW50c1tldmVudF0uaW5kZXhPZihmY3QpLCAxKTsKCQl9LAoJCXRyaWdnZXIJOiBmdW5jdGlvbihldmVudCAvKiAsIGFyZ3MuLi4gKi8pewoJCQl0aGlzLl9ldmVudHMgPSB0aGlzLl9ldmVudHMgfHwge307CgkJCWlmKCBldmVudCBpbiB0aGlzLl9ldmVudHMgPT09IGZhbHNlICApCXJldHVybjsKCQkJZm9yKHZhciBpID0gMDsgaSA8IHRoaXMuX2V2ZW50c1tldmVudF0ubGVuZ3RoOyBpKyspewoJCQkJdGhpcy5fZXZlbnRzW2V2ZW50XVtpXS5hcHBseSh0aGlzLCBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKCQkJfQoJCX0KCX07CgoJLyoqCgkgKiBtaXhpbiB3aWxsIGRlbGVnYXRlIGFsbCBNaWNyb0V2ZW50LmpzIGZ1bmN0aW9uIGluIHRoZSBkZXN0aW5hdGlvbiBvYmplY3QKCSAqCgkgKiAtIHJlcXVpcmUoJ01pY3JvRXZlbnQnKS5taXhpbihGb29iYXIpIHdpbGwgbWFrZSBGb29iYXIgYWJsZSB0byB1c2UgTWljcm9FdmVudAoJICoKCSAqIEBwYXJhbSB7T2JqZWN0fSB0aGUgb2JqZWN0IHdoaWNoIHdpbGwgc3VwcG9ydCBNaWNyb0V2ZW50CgkqLwoJTWljcm9FdmVudC5taXhpbgk9IGZ1bmN0aW9uKGRlc3RPYmplY3QpewoJCXZhciBwcm9wcwk9IFsnYmluZCcsICd1bmJpbmQnLCAndHJpZ2dlciddOwoJCWZvcih2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkgKyspewoJCQlpZiggdHlwZW9mIGRlc3RPYmplY3QgPT09ICdmdW5jdGlvbicgKXsKCQkJCWRlc3RPYmplY3QucHJvdG90eXBlW3Byb3BzW2ldXQk9IE1pY3JvRXZlbnQucHJvdG90eXBlW3Byb3BzW2ldXTsKCQkJfWVsc2V7CgkJCQlkZXN0T2JqZWN0W3Byb3BzW2ldXSA9IE1pY3JvRXZlbnQucHJvdG90eXBlW3Byb3BzW2ldXTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gTWljcm9FdmVudDsKCn0pOwoKZGVmaW5lKCdlZGlzb24vbGliL3NhbmRib3gnLFsncmVxdWlyZScsJ3VuZGVyc2NvcmUnLCcuL21pY3JvZXZlbnQnXSxmdW5jdGlvbihyZXF1aXJlKSB7CgoJdmFyIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyksCgkJTWljcm9FdmVudCA9IHJlcXVpcmUoJy4vbWljcm9ldmVudCcpOwoKCXZhciBTYW5kYm94ID0gZnVuY3Rpb24ocm91dGUpIHsKCQl0aGlzLnJvdXRlID0gcm91dGU7Cgl9OwoKCV8uZXh0ZW5kKFNhbmRib3gucHJvdG90eXBlLCB7CgoJCSdnZXQnOiBmdW5jdGlvbihuYW1lKSB7CgkJCW5hbWUgPSBuYW1lLnJlcGxhY2UoL1tcW10vLCAiXFxcWyIpLnJlcGxhY2UoL1tcXV0vLCAiXFxcXSIpOwoJCQl2YXIgcmVnZXggPSBuZXcgUmVnRXhwKCJbXFw/Jl0iICsgbmFtZSArICI9KFteJiNdKikiKSwKCQkJcmVzdWx0cyA9IHJlZ2V4LmV4ZWMod2luZG93LmxvY2F0aW9uLmhhc2gpOwoJCQlyZXR1cm4gcmVzdWx0cyA9PSBudWxsID8gbnVsbCA6IGRlY29kZVVSSUNvbXBvbmVudChyZXN1bHRzWzFdLnJlcGxhY2UoL1wrL2csICIgIikpOwoJCX0KCgl9KTsKCglNaWNyb0V2ZW50Lm1peGluKFNhbmRib3gucHJvdG90eXBlKTsKCglyZXR1cm4gU2FuZGJveDsKCn0pOwoKZGVmaW5lKCdlZGlzb24vbGliL3JvdXRlJyxbJ3JlcXVpcmUnLCd1bmRlcnNjb3JlJywnLi9zYW5kYm94J10sZnVuY3Rpb24ocmVxdWlyZSkgewoKCXZhciBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpLAoJCVNhbmRib3ggPSByZXF1aXJlKCcuL3NhbmRib3gnKTsKCgkvKioKCSAqIEBjbGFzcyBSb3V0ZQoJICovCgl2YXIgUm91dGUgPSBmdW5jdGlvbihvcHRpb25zLCBzZWN0aW9uLCBlZGlzb24pIHsKCgkJXy5kZWZhdWx0cyhvcHRpb25zLCB7CgkJCSdpbml0JzogZnVuY3Rpb24oZm4pIHsKCQkJCWZuKCk7CgkJCX0KCQl9KTsKCgkJdmFyIHNlbGYgPSB0aGlzOwoJCXNlbGYudGl0bGUgPSBudWxsOwoJCXNlbGYubmFtZSA9IG9wdGlvbnMubmFtZTsKCQlzZWxmLnNlY3Rpb24gPSBzZWN0aW9uOwoJCXNlbGYuY2FsbGJhY2sgPSBvcHRpb25zLmNhbGxiYWNrOwoJCXNlbGYuZXh0ZW5zaW9ucyA9IG9wdGlvbnMuZXh0ZW5kOwoJCXNlbGYudGVtcGxhdGUgPSBvcHRpb25zLnRlbXBsYXRlIHx8ICI8ZGl2PjwvZGl2PiI7CgkJc2VsZi5jbGVhbnVwID0gb3B0aW9ucy5jbGVhbnVwOwoKCQlzZWxmLmxvZyA9IGZ1bmN0aW9uKCkgewoJCQlpZiAoICFlZGlzb24uZ2V0RGVidWcoKSApIHsKCQkJCXJldHVybjsKCQkJfQoJCQljb25zb2xlLmxvZyhhcmd1bWVudHMpOwoJCX07CgoJCS8qKgoJCSAqIFJldHVybnMgYSBzdHJpbmcgaW5kaWNhdGluZyB0aGUgbmFtZSBvZiB0aGUgc2VjdGlvbiArIHRoaXMgcm91dGUuCgkJICovCgkJc2VsZi5nZXRQYXRoID0gZnVuY3Rpb24oKSB7CgkJCXJldHVybiBzZWN0aW9uLmdldE5hbWUoKSArICcvJyArIHNlbGYubmFtZTsKCQl9OwoKCQlzZWxmLmxvZygnTmV3IHJvdXRlIGRlZmluZWQ6ICcgKyBzZWxmLmdldFBhdGgoKSk7CgoJCV8uZWFjaChlZGlzb24uZ2V0Um91dGVFeHRlbnNpb25zKCksIGZ1bmN0aW9uKGV4dCkgewoJCQlfLmV4dGVuZChTYW5kYm94LnByb3RvdHlwZSwgZXh0KTsKCQl9KTsKCgkJc2VsZi5zYW5kYm94ID0gbmV3IFNhbmRib3goKTsKCQlzZWxmLnNhbmRib3guc2VjdGlvbiA9IHNlY3Rpb24uZ2V0U2FuZGJveCgpOwoKCQlzZWxmLmluaXQgPSBmdW5jdGlvbihpZCwgZm4pIHsKCQkJb3B0aW9ucy5pbml0LmNhbGwoc2VsZi5zYW5kYm94LCBmdW5jdGlvbigpIHsKCQkJCWlmICggZWRpc29uLmdldEFjdGl2ZVNlY3Rpb24oKSAhPT0gc2VsZi5zZWN0aW9uICkgewoJCQkJCS8vIFRoZSB1c2VyIGlzIG1ha2luZyB0aGVpciBmaXJzdCBlbnRyeSBpbnRvIHRoaXMgc2VjdGlvbi4KCQkJCQlzZWxmLmxvZygnSW5pdGlhbCBlbnRyeSBpbnRvIHNlY3Rpb246ICcgKyBzZWN0aW9uLmdldE5hbWUoKSk7CgkJCQkJc2VsZi5zZWN0aW9uLmxvYWRUZW1wbGF0ZSgpOwoJCQkJCXNlbGYuc2VjdGlvbi5ydW5DYWxsYmFjaygpOwoJCQkJCVNhbmRib3gucHJvdG90eXBlLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyb3V0ZScpOwoJCQkJCXNlbGYubG9hZFRlbXBsYXRlKCk7CgkJCQl9IGVsc2UgewoJCQkJCS8vIFRoZSB1c2VyIGlzIG5hdmlnYXRpbmcgd2l0aGluIHRoZSBzYW1lIHNlY3Rpb24uCgkJCQkJU2FuZGJveC5wcm90b3R5cGUuY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JvdXRlJyk7CgkJCQkJc2VsZi5sb2FkVGVtcGxhdGUoKTsKCQkJCX0KCQkJCWVkaXNvbi5zZXRBY3RpdmVTZWN0aW9uKHNlbGYuc2VjdGlvbik7CgkJCQllZGlzb24uc2V0QWN0aXZlUm91dGUoc2VsZi5hcGkpOwoJCQkJc2VsZi5jYWxsYmFjay5jYWxsKHNlbGYuc2FuZGJveCwgaWQpOwoJCQkJZm4oKTsKCQkJfSk7CgkJfTsKCgkJXy5lYWNoKHNlbGYuZXh0ZW5zaW9ucywgZnVuY3Rpb24oZm5jLCBleHRuYW1lKSB7CgkJCXNlbGYuc2FuZGJveFtleHRuYW1lXSA9IGZ1bmN0aW9uKCkgewoJCQkJZm5jLmFwcGx5KHNlbGYuc2FuZGJveCwgYXJndW1lbnRzKTsKCQkJfTsKCQl9KTsKCgkJc2VsZi5sb2FkVGVtcGxhdGUgPSBmdW5jdGlvbigpIHsKCQkJdmFyIHRwbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJCQl0cGwuaW5uZXJIVE1MID0gc2VsZi50ZW1wbGF0ZTsKCQkJdHBsLnNldEF0dHJpYnV0ZSgnaWQnLCAnc2VjdGlvbl8nICsgc2VsZi5zZWN0aW9uLmdldE5hbWUoKSArICdfcm91dGVfJyArIHNlbGYubmFtZSk7CgkJCXRwbC5jbGFzc05hbWUgPSAncm91dGUnOwoJCQllZGlzb24uaW5zZXJ0VGVtcGxhdGUodHBsKTsKCQl9OwoKCQkvKioKCQkgKiBQdWJsaWMgSW50ZXJmYWNlCgkJICovCgkJc2VsZi5hcGkgPSB7CgkJCWdldENhbGxiYWNrOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiBzZWxmLmNhbGxiYWNrOwoJCQl9LAoJCQlnZXRTYW5kYm94OiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiBzZWxmLnNhbmRib3g7CgkJCX0sCgkJCWdldE5hbWU6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHNlbGYubmFtZTsKCQkJfSwKCQkJaW5pdDogZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmluaXQuYXBwbHkoc2VsZiwgYXJndW1lbnRzKTsKCQkJfSwKCQkJZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHNlbGYudGl0bGU7CgkJCX0sCgkJCWdldEZ1bGxQYXRoOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB0aGlzLmdldEZ1bGxQYXRoLmFwcGx5KHNlbGYsIGFyZ3VtZW50cyk7CgkJCX0sCgkJCWNsZWFudXA6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBfLmlzRnVuY3Rpb24oc2VsZi5jbGVhbnVwKSApIHsKCQkJCQlzZWxmLmNsZWFudXAuY2FsbChzZWxmLnNhbmRib3gpOwoJCQkJfQoJCQl9CgkJfTsKCgkJcmV0dXJuIHNlbGYuYXBpOwoKCX07CgoJXy5leHRlbmQoUm91dGUucHJvdG90eXBlLCB7CgoJCS8qKgoJCSAqIFJldHVybnMgdGhlIGhhc2hiYW5nIHBhdGggYXQgd2hpY2ggdGhpcyByb3V0ZSBjYW4gYmUgYWNjZXNzZWQ6IHNlY3Rpb25fbmFtZS9yb3V0ZV9uYW1lCgkJICovCgkJJ2dldEZ1bGxQYXRoJzogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnNlY3Rpb24uZ2V0TmFtZSgpICsgJy8nICsgdGhpcy5uYW1lOwoJCX0KCgl9KTsKCglyZXR1cm4gUm91dGU7Cgp9KTsKCmRlZmluZSgnZWRpc29uL2xpYi9zZWN0aW9uJyxbJ3JlcXVpcmUnLCd1bmRlcnNjb3JlJywnLi9yb3V0ZScsJy4vc2FuZGJveCddLGZ1bmN0aW9uKHJlcXVpcmUpIHsKCgl2YXIgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKSwKCQlSb3V0ZSA9IHJlcXVpcmUoJy4vcm91dGUnKSwKCQlTYW5kYm94ID0gcmVxdWlyZSgnLi9zYW5kYm94Jyk7CgoJLyoqCgkgKiBAY2xhc3MgU2VjdGlvbgoJICovCgl2YXIgU2VjdGlvbiA9IGZ1bmN0aW9uKG9wdGlvbnMsIGVkaXNvbikgewoKCQl2YXIgc2VsZiA9IHRoaXM7CgkJc2VsZi5lZGlzb24gPSBlZGlzb247CgkJc2VsZi5uYW1lID0gb3B0aW9ucy5uYW1lOwoJCXNlbGYuY29udHJvbGxlciA9IG9wdGlvbnMuY29udHJvbGxlcjsKCQlzZWxmLmNhbGxiYWNrID0gb3B0aW9ucy5jYWxsYmFjazsKCQlzZWxmLmV4dGVuc2lvbnMgPSBvcHRpb25zLmV4dGVuZDsKCQlzZWxmLnBhcmVudF9zZWN0aW9uID0gb3B0aW9ucy5wYXJlbnRfc2VjdGlvbjsKCQlzZWxmLnRlbXBsYXRlID0gb3B0aW9ucy50ZW1wbGF0ZSB8fCAiPGRpdiBpZD0ncm91dGUnPjwvZGl2PiI7CgkJc2VsZi50ZW1wbGF0ZURhdGEgPSBvcHRpb25zLnRlbXBsYXRlRGF0YTsKCQlzZWxmLmNsZWFudXAgPSBvcHRpb25zLmNsZWFudXA7CgkJc2VsZi5yb3V0ZXMgPSB7fTsKCgkJc2VsZi5jcmVhdGVSb3V0ZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCQkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJCV8uZGVmYXVsdHMob3B0aW9ucywgewoJCQkJJ25hbWUnOiBudWxsLAoJCQkJJ2NhbGxiYWNrJzogbnVsbCwKCQkJCSdleHRlbmQnOiB7fSwKCQkJCSdjbGVhbnVwJzogbnVsbAoJCQl9KTsKCQkJaWYgKCAhXy5pc1N0cmluZyhvcHRpb25zLm5hbWUpIHx8IG9wdGlvbnMubmFtZSA9PT0gJycgKSB7CgkJCQl0aHJvdyAnSW52YWxpZCBgbmFtZWAgc3BlY2lmaWVkLic7CgkJCX0KCQkJdmFyIG5hbWVfY2hlY2sgPSBvcHRpb25zLm5hbWUucmVwbGFjZSgvXFcvZywgJycpOwoJCQlpZiAoIG5hbWVfY2hlY2sgIT09IG9wdGlvbnMubmFtZSApIHsKCQkJCXRocm93ICdJbnZhbGlkIGBuYW1lYCBzcGVjaWZpZWQuJzsKCQkJfQoJCQlpZiAoICFfLmlzRnVuY3Rpb24ob3B0aW9ucy5jYWxsYmFjaykgJiYgIV8uaXNOdWxsKG9wdGlvbnMuY2FsbGJhY2spICkgewoJCQkJdGhyb3cgJ0ludmFsaWQgYGNhbGxiYWNrYCBzcGVjaWZpZWQuJzsKCQkJfQoJCQlpZiAoICFfLmlzT2JqZWN0KG9wdGlvbnMuZXh0ZW5kKSApIHsKCQkJCXRocm93ICdJbnZhbGlkIGBleHRlbmRgIHZhbHVlIHNwZWNpZmllZC4nOwoJCQl9CgkJCWlmICggIV8uaXNOdWxsKG9wdGlvbnMuY2xlYW51cCkgJiYgIV8uaXNGdW5jdGlvbihvcHRpb25zLmNsZWFudXApICkgewoJCQkJdGhyb3cgJ0ludmFsaWQgYGNsZWFudXBgIHZhbHVlIHNwZWNpZmllZC4nOwoJCQl9CgkJCW9wdGlvbnMudGVtcGxhdGVfY29udGFpbmVyX3NlbGVjdG9yID0gJy5yb3V0ZSc7CgkJCXZhciByb3V0ZSA9IG5ldyBSb3V0ZShvcHRpb25zLCBzZWxmLmFwaSwgZWRpc29uKTsKCQkJc2VsZi5yb3V0ZXNbb3B0aW9ucy5uYW1lXSA9IHJvdXRlOwoJCQlyZXR1cm4gcm91dGU7CgkJfTsKCgkJc2VsZi5sb2cgPSBmdW5jdGlvbigpIHsKCQkJaWYgKCAhZWRpc29uLmdldERlYnVnKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJY29uc29sZS5sb2coYXJndW1lbnRzKTsKCQl9OwoKCQlfLmVhY2goZWRpc29uLmdldFJvdXRlRXh0ZW5zaW9ucygpLCBmdW5jdGlvbihleHQpIHsKCQkJXy5leHRlbmQoU2FuZGJveC5wcm90b3R5cGUsIGV4dCk7CgkJfSk7CgoJCV8uZXh0ZW5kKFNhbmRib3gucHJvdG90eXBlLCBzZWxmLmV4dGVuc2lvbnMpOwoKCQlzZWxmLnNhbmRib3ggPSBuZXcgU2FuZGJveCh0aGlzKTsKCgkJc2VsZi5sb2FkVGVtcGxhdGUgPSBmdW5jdGlvbigpIHsKCQkJdmFyIHRwbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJCQl0cGwuaW5uZXJIVE1MID0gc2VsZi50ZW1wbGF0ZTsKCQkJdHBsLnNldEF0dHJpYnV0ZSgnaWQnLCAnZWRpc29uX3NlY3Rpb24nKTsKCQkJdHBsLmNsYXNzTmFtZSA9ICdzZWN0aW9uJzsKCQkJZWRpc29uLmluc2VydFNlY3Rpb25UZW1wbGF0ZSh0cGwpOwoJCX07CgoJCXNlbGYuYXBpID0gewoJCQljcmVhdGVSb3V0ZTogc2VsZi5jcmVhdGVSb3V0ZS5iaW5kKHNlbGYpLAoJCQlnZXRSb3V0ZXM6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHNlbGYucm91dGVzOwoJCQl9LAoJCQloYXNSb3V0ZTogZnVuY3Rpb24obmFtZSkgewoJCQkJaWYgKCBfLmlzVW5kZWZpbmVkKHNlbGYucm91dGVzW25hbWVdKSApIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfSwKCQkJZ2V0Um91dGU6IGZ1bmN0aW9uKG5hbWUpIHsKCQkJCXJldHVybiBzZWxmLnJvdXRlc1tuYW1lXTsKCQkJfSwKCQkJZ2V0RGVmYXVsdFJvdXRlOiBmdW5jdGlvbigpIHsKCQkJCXZhciByb3V0ZXMgPSBfLmtleXMoc2VsZi5yb3V0ZXMpOwoJCQkJdmFyIHJvdXRlX25hbWUgPSByb3V0ZXNbMF07CgkJCQlyZXR1cm4gc2VsZi5yb3V0ZXNbcm91dGVfbmFtZV07CgkJCX0sCgkJCWdldE5hbWU6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHNlbGYubmFtZTsKCQkJfSwKCQkJZ2V0Q29udHJvbGxlcjogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gc2VsZi5jb250cm9sbGVyOwoJCQl9LAoJCQlydW5DYWxsYmFjazogZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmxvYWRUZW1wbGF0ZSgpOwoJCQkJc2VsZi5jYWxsYmFjay5jYWxsKHNlbGYuc2FuZGJveCk7CgkJCX0sCgkJCWdldFBhcmVudFNlY3Rpb246IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHNlbGYucGFyZW50X3NlY3Rpb247CgkJCX0sCgkJCWNsZWFudXA6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBfLmlzRnVuY3Rpb24oc2VsZi5jbGVhbnVwKSApIHsKCQkJCQlzZWxmLmNsZWFudXAuY2FsbChzZWxmLnNhbmRib3gpOwoJCQkJfQoJCQl9LAoJCQlnZXRTYW5kYm94OiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiBzZWxmLnNhbmRib3g7CgkJCX0sCgkJCWxvYWRUZW1wbGF0ZTogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gc2VsZi5sb2FkVGVtcGxhdGUoKTsKCQkJfQoJCX07CgoJCXJldHVybiBzZWxmLmFwaTsKCgl9OwoKCXJldHVybiBTZWN0aW9uOwoKfSk7CgpkZWZpbmUoJ2VkaXNvbi9saWIvcm91dGVyJyxbJ3JlcXVpcmUnLCd1bmRlcnNjb3JlJywnLi9taWNyb2V2ZW50J10sZnVuY3Rpb24ocmVxdWlyZSkgewoKCXZhciBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpLAoJCU1pY3JvRXZlbnQgPSByZXF1aXJlKCcuL21pY3JvZXZlbnQnKTsKCgkvKioKCSAqIEBjbGFzcyBSb3V0ZXIKCSAqLwoJdmFyIFJvdXRlciA9IGZ1bmN0aW9uKGVkaXNvbikgewoJCXRoaXMuaW5pdC5hcHBseSh0aGlzLCBfLnRvQXJyYXkoYXJndW1lbnRzKSk7CgkJLyoKCQlyZXR1cm4gewoJCQknYmluZCc6IHRoaXMuYmluZC5hcHBseSh0aGlzKQoJCX07CgkJKi8KCX07CgoJTWljcm9FdmVudC5taXhpbihSb3V0ZXIucHJvdG90eXBlKTsKCglfLmV4dGVuZChSb3V0ZXIucHJvdG90eXBlLCB7CgoJCSdlZGlzb24nOiBudWxsLAoKCQknbGlzdGVuaW5nJzogZmFsc2UsCgoJCSdpbml0JzogZnVuY3Rpb24oZWRpc29uKSB7CgkJCXRoaXMuZWRpc29uID0gZWRpc29uOwoJCX0sCgoJCSdsaXN0ZW4nOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQlpZiAoIHRoaXMubGlzdGVuaW5nICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCXRoaXMubGlzdGVuaW5nID0gdHJ1ZTsKCQkJdGhpcy5iaW5kKCdoYXNoX2NoYW5nZScsIGZ1bmN0aW9uKGRhdGEpIHsKCQkJCXNlbGYub25IYXNoQ2hhbmdlKGRhdGEpOwoJCQl9KTsKCQkJdGhpcy53YXRjaFVSTCgpOwoJCX0sCgoJCSd3YXRjaFVSTCc6IGZ1bmN0aW9uKCkgewoJCQl3aW5kb3cub25oYXNoY2hhbmdlID0gdGhpcy5wcm9jZXNzSGFzaENoYW5nZS5iaW5kKHRoaXMpOwoJCQlpZiAoIHdpbmRvdy5sb2NhdGlvbi5oYXNoICkgewoJCQkJdGhpcy5wcm9jZXNzSGFzaENoYW5nZSgpOwoJCQl9CgkJfSwKCgkJJ3Byb2Nlc3NIYXNoQ2hhbmdlJzogZnVuY3Rpb24oKSB7CgkJCXRoaXMudHJpZ2dlcignaGFzaF9jaGFuZ2UnLCB7CgkJCQknaGFzaCc6IHdpbmRvdy5sb2NhdGlvbi5oYXNoCgkJCX0pOwoJCX0sCgoJCSdvbkhhc2hDaGFuZ2UnOiBmdW5jdGlvbihkYXRhKSB7CgkJCXZhciBwcm9jZXNzZWQ7CgkJCWRhdGEgPSBkYXRhIHx8IHt9OwoJCQlfLmRlZmF1bHRzKGRhdGEsIHsKCQkJCSdoYXNoJzogbnVsbAoJCQl9KTsKCQkJaWYgKCAhZGF0YS5oYXNoICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCXRyeSB7CgkJCQlwcm9jZXNzZWQgPSB0aGlzLnByb2Nlc3NIYXNoKGRhdGEuaGFzaCk7CgkJCX0gY2F0Y2goZSkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCXRoaXMudHJpZ2dlcignb25fcm91dGUnLCBwcm9jZXNzZWQpOwoJCX0sCgoJCSdwcm9jZXNzSGFzaCc6IGZ1bmN0aW9uKGhhc2gpIHsKCQkJaWYgKCBoYXNoLmluZGV4T2YoJyMnKSA9PT0gMCAmJiBoYXNoLmluZGV4T2YoJyEnKSA9PT0gMSApIHsKCQkJCWhhc2ggPSBoYXNoLnN1YnN0cmluZygyKTsKCQkJfQoJCQlpZiAoIGhhc2ggPT09ICcnICkgewoJCQkJdGhyb3cgJ0ludmFsaWQgaGFzaC4nOwoJCQl9CgkJCXZhciBhZGRyZXNzID0gbnVsbCwKCQkJCXRtcCA9IGhhc2guc3BsaXQoJz8nKSwKCQkJCXNlY3Rpb25fbmFtZSA9IG51bGwsCgkJCQlyb3V0ZV9uYW1lID0gbnVsbCwKCQkJCXJvdXRlX2lkID0gbnVsbDsKCQkJaWYgKCB0bXAubGVuZ3RoID09PSAxICkgewoJCQkJYWRkcmVzcyA9IHRtcC5wb3AoKTsKCQkJfSBlbHNlIHsKCQkJCWFkZHJlc3MgPSB0bXAuc2hpZnQoKTsKCQkJfQoJCQlpZiAoIGFkZHJlc3MuaW5kZXhPZignLycpIDwgMCApIHsKCQkJCXNlY3Rpb25fbmFtZSA9IGFkZHJlc3M7CgkJCX0gZWxzZSB7CgkJCQl0bXAgPSBhZGRyZXNzLnNwbGl0KCcvJyk7CgkJCQlzd2l0Y2ggKCB0bXAubGVuZ3RoICkgewoJCQkJCWNhc2UgMToKCQkJCQkJc2VjdGlvbl9uYW1lID0gdG1wLnBvcCgpOwoJCQkJCQlicmVhazsKCQkJCQljYXNlIDI6CgkJCQkJCXNlY3Rpb25fbmFtZSA9IHRtcC5zaGlmdCgpOwoJCQkJCQlyb3V0ZV9uYW1lID0gdG1wLnNoaWZ0KCk7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgMzoKCQkJCQkJc2VjdGlvbl9uYW1lID0gdG1wLnNoaWZ0KCk7CgkJCQkJCXJvdXRlX25hbWUgPSB0bXAuc2hpZnQoKTsKCQkJCQkJcm91dGVfaWQgPSB0bXAuc2hpZnQoKTsKCQkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCQkJdmFyIHBhcmFtcyA9IHt9OwoJCQlyZXR1cm4gewoJCQkJJ3NlY3Rpb25fbmFtZSc6IHNlY3Rpb25fbmFtZSwKCQkJCSdyb3V0ZV9uYW1lJzogcm91dGVfbmFtZSwKCQkJCSdyb3V0ZV9pZCc6IHJvdXRlX2lkCgkJCX07CgkJfQoKCX0pOwoKCXJldHVybiBSb3V0ZXI7Cgp9KTsKCmRlZmluZSgnZWRpc29uL2xpYi91dGlsJyxbXSwgZnVuY3Rpb24oKSB7CgoJcmV0dXJuIHsKCgkJLyoqCgkJICogUmV0dXJucyB0cnVlIC8gZmFsc2UgYXMgdG8gd2hldGhlciB0aGUgYnJvd3NlciBzdXBwb3J0cyB0aGUgSFRNTDUgSGlzdG9yeSBBUEkKCQkgKi8KCQknc3VwcG9ydHNIaXN0b3J5QVBJJzogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAhISh3aW5kb3cuaGlzdG9yeSAmJiBoaXN0b3J5LnB1c2hTdGF0ZSk7CgkJfQoKCX07Cgp9KTsKCmRlZmluZSgnZWRpc29uL2xpYi9lZGlzb24nLFsncmVxdWlyZScsJ3VuZGVyc2NvcmUnLCcuL3NlY3Rpb24nLCcuL3JvdXRlJywnLi9yb3V0ZXInLCcuL3V0aWwnXSxmdW5jdGlvbihyZXF1aXJlKSB7CgoJdmFyIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyksCgkJU2VjdGlvbiA9IHJlcXVpcmUoJy4vc2VjdGlvbicpLAoJCVJvdXRlID0gcmVxdWlyZSgnLi9yb3V0ZScpLAoJCVJvdXRlciA9IHJlcXVpcmUoJy4vcm91dGVyJyksCgkJdXRpbCA9IHJlcXVpcmUoJy4vdXRpbCcpOwoKCXZhciBFZGlzb24gPSBmdW5jdGlvbigpIHsKCQl0aGlzLmluaXQuYXBwbHkodGhpcywgXy50b0FycmF5KGFyZ3VtZW50cykpOwoJCXJldHVybiB7CgkJCSdjcmVhdGVTZWN0aW9uJzogdGhpcy5jcmVhdGVTZWN0aW9uLmJpbmQodGhpcyksCgkJCSdpbml0Um91dGVzJzogdGhpcy5pbml0Um91dGVzLmJpbmQodGhpcyksCgkJCSdleHRlbmQnOiB0aGlzLmV4dGVuZC5iaW5kKHRoaXMpLAoJCQknZXh0ZW5kQ2xlYW51cCc6IHRoaXMuZXh0ZW5kQ2xlYW51cC5iaW5kKHRoaXMpCgkJfTsKCX07CgoJXy5leHRlbmQoRWRpc29uLnByb3RvdHlwZSwgewoKCQknaW5pdCc6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCQkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJCV8uZGVmYXVsdHMob3B0aW9ucywgdGhpcy5vcHRpb25zKTsKCQkJdGhpcy5vcHRpb25zID0gb3B0aW9uczsKCQkJaWYgKCAhXy5pc0Jvb2xlYW4ob3B0aW9ucy5wdXNoU3RhdGUpICkgewoJCQkJb3B0aW9ucy5wdXNoU3RhdGUgPSBmYWxzZTsKCQkJfQoJCQlpZiAoICFvcHRpb25zLmNvbnRhaW5lciApIHsKCQkJCXRocm93ICdBIHZhbHVlIG11c3QgYmUgc3BlY2lmaWVkIGZvciBgY29udGFpbmVyLmAnOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5yb3V0ZV9jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChvcHRpb25zLmNvbnRhaW5lcik7CgkJCQlpZiAoICEgdGhpcy5yb3V0ZV9jb250YWluZXIgKSB7CgkJCQkJdGhyb3cgJ1NwZWNpZmllZCByb3V0ZSBjb250YWluZXIgZG9lcyBub3QgZXhpc3Q6IGAnICsgb3B0aW9ucy5jb250YWluZXIgKyAnLmAnOwoJCQkJfQoJCQkJaWYgKCBvcHRpb25zLnB1c2hTdGF0ZSAmJiB1dGlsLnN1cHBvcnRzSGlzdG9yeUFQSSgpICkgewoJCQkJCXRoaXMuZW5hYmxlUHVzaFN0YXRlID0gdHJ1ZTsKCQkJCX0KCQkJfQoJCX0sCgoJCSdvcHRpb25zJzogewoJCQknY29udGFpbmVyJzogbnVsbCwKCQkJJ3B1c2hTdGF0ZSc6IGZhbHNlCgkJfSwKCgkJJ2RlYnVnJzogZmFsc2UsCgoJCSdlbmFibGVQdXNoU3RhdGUnOiBmYWxzZSwKCgkJJ3JvdXRlc19pbml0aWFsaXplZCc6IGZhbHNlLAoKCQknc2VjdGlvbnMnOiB7fSwKCgkJJ2FjdGl2ZV9wYXJlbnRfc2VjdGlvbic6IG51bGwsCgoJCSdhY3RpdmVfc2VjdGlvbic6IG51bGwsCgoJCSdhY3RpdmVfc2VjdGlvbl9pbnRlcnZhbHMnOiBbXSwKCgkJJ2FjdGl2ZV9wYXJlbnRfc2VjdGlvbl9pbnRlcnZhbHMnOiBbXSwKCgkJJ2FjdGl2ZV9yb3V0ZSc6IG51bGwsCgoJCSdSb3V0ZXMnOiBudWxsLAoKCQkncm91dGVfZXh0ZW5zaW9ucyc6IFtdLAoKCQknbG9nJzogZnVuY3Rpb24oKSB7CgkJCWlmICggIXRoaXMuZGVidWcgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJY29uc29sZS5sb2coYXJndW1lbnRzKTsKCQl9LAoKCQknY3JlYXRlU2VjdGlvbic6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCQkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJCV8uZGVmYXVsdHMob3B0aW9ucywgewoJCQkJJ25hbWUnOiBudWxsLAoJCQkJJ2NhbGxiYWNrJzogbnVsbCwKCQkJCSdleHRlbmQnOiB7fSwKCQkJCSdjbGVhbnVwJzogbnVsbAoJCQl9KTsKCQkJaWYgKCAhXy5pc1N0cmluZyhvcHRpb25zLm5hbWUpIHx8IG9wdGlvbnMubmFtZSA9PT0gJycgKSB7CgkJCQl0aHJvdyAnSW52YWxpZCBgbmFtZWAgc3BlY2lmaWVkLic7CgkJCX0KCQkJdmFyIG5hbWVfY2hlY2sgPSBvcHRpb25zLm5hbWUucmVwbGFjZSgvXFcvZywgJycpOwoJCQlpZiAoIG5hbWVfY2hlY2sgIT09IG9wdGlvbnMubmFtZSApIHsKCQkJCXRocm93ICdJbnZhbGlkIGBuYW1lYCBzcGVjaWZpZWQuJzsKCQkJfQoJCQlpZiAoICFfLmlzRnVuY3Rpb24ob3B0aW9ucy5jYWxsYmFjaykgJiYgIV8uaXNOdWxsKG9wdGlvbnMuY2FsbGJhY2spICkgewoJCQkJdGhyb3cgJ0ludmFsaWQgYGNhbGxiYWNrYCBzcGVjaWZpZWQuJzsKCQkJfQoJCQlpZiAoICFfLmlzT2JqZWN0KG9wdGlvbnMuZXh0ZW5kKSApIHsKCQkJCXRocm93ICdJbnZhbGlkIGBleHRlbmRgIHZhbHVlIHNwZWNpZmllZC4nOwoJCQl9CgkJCWlmICggIV8uaXNOdWxsKG9wdGlvbnMuY2xlYW51cCkgJiYgIV8uaXNGdW5jdGlvbihvcHRpb25zLmNsZWFudXApICkgewoJCQkJdGhyb3cgJ0ludmFsaWQgYGNsZWFudXBgIHZhbHVlIHNwZWNpZmllZC4nOwoJCQl9CgkJCXRoaXMuc2VjdGlvbnNbb3B0aW9ucy5uYW1lXSA9IG5ldyBTZWN0aW9uKG9wdGlvbnMsIHRoaXMpOwoJCQlyZXR1cm4gdGhpcy5zZWN0aW9uc1tvcHRpb25zLm5hbWVdOwoJCX0sCgoJCSdjaGVja1BhcmVudFNlY3Rpb24nOiBmdW5jdGlvbihzZWN0aW9uX25hbWUpIHsKCQkJaWYgKCBfLmlzU3RyaW5nKHRoaXMuc2VjdGlvbnNbc2VjdGlvbl9uYW1lXS5nZXRQYXJlbnRTZWN0aW9uKCkpICkgewoJCQkJaWYgKCB0aGlzLmFjdGl2ZV9wYXJlbnRfc2VjdGlvbiAhPT0gdGhpcy5zZWN0aW9uc1tzZWN0aW9uX25hbWVdLmdldFBhcmVudFNlY3Rpb24oKSApIHsKCQkJCQlpZiAoICFfLmVtcHR5KHRoaXMuYWN0aXZlX3BhcmVudF9zZWN0aW9uKSApIHsKCQkJCQkJdGhpcy5hY3RpdmVfcGFyZW50X3NlY3Rpb24uY2xlYW51cCgpOwoJCQkJCQl0aGlzLmNsZWFyUGFyZW50U2VjdGlvbkludGVydmFscygpOwoJCQkJCX0KCQkJCQl0aGlzLmFjdGl2ZV9wYXJlbnRfc2VjdGlvbiA9IHRoaXMuc2VjdGlvbnNbc2VjdGlvbl9uYW1lXS5nZXRQYXJlbnRTZWN0aW9uKCk7CgkJCQkJdmFyIHBhcmVudFNlY3Rpb24gPSB0aGlzLnNlY3Rpb25zW3NlY3Rpb25fbmFtZV0uZ2V0UGFyZW50U2VjdGlvbigpOwoJCQkJCXRoaXMuc2VjdGlvbnNbcGFyZW50U2VjdGlvbl0ucnVuQ2FsbGJhY2soKTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXRoaXMuYWN0aXZlX3BhcmVudF9zZWN0aW9uID0gbnVsbDsKCQkJCXRoaXMuY2xlYXJQYXJlbnRTZWN0aW9uSW50ZXJ2YWxzKCk7CgkJCX0KCQl9LAoKCQknY2xlYXJQYXJlbnRTZWN0aW9uSW50ZXJ2YWxzJzogZnVuY3Rpb24oKSB7CgkJCV8uZWFjaCh0aGlzLmFjdGl2ZV9wYXJlbnRfc2VjdGlvbl9pbnRlcnZhbHMsIGZ1bmN0aW9uKGludGVydmFsX2lkKSB7CgkJCQljbGVhckludGVydmFsKGludGVydmFsX2lkKTsKCQkJfSk7CgkJfSwKCgkJJ2luaXRSb3V0ZXMnOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQl0aGlzLmxvZygnSW5pdGlhbGl6aW5nIHJvdXRlcy4uLicpOwoJCQlpZiAoIHRoaXMucm91dGVzX2luaXRpYWxpemVkICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCXRoaXMucm91dGVzX2luaXRpYWxpemVkID0gdHJ1ZTsKCQkJdGhpcy5yb3V0ZXIgPSBuZXcgUm91dGVyKHRoaXMpOwoJCQl0aGlzLnJvdXRlci5iaW5kKCdvbl9yb3V0ZScsIHRoaXMub25Sb3V0ZS5iaW5kKHRoaXMpKTsKCQkJdGhpcy5yb3V0ZXIubGlzdGVuKCk7CgkJfSwKCgkJJ29uUm91dGUnOiBmdW5jdGlvbihkYXRhKSB7CgkJCXRoaXMubG9nKCdvblJvdXRlJywgZGF0YSk7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJaWYgKCAhdGhpcy5zZWN0aW9uc1tkYXRhLnNlY3Rpb25fbmFtZV0gKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJdmFyIHNlY3Rpb24gPSB0aGlzLnNlY3Rpb25zW2RhdGEuc2VjdGlvbl9uYW1lXSwKCQkJCXJvdXRlOwoJCQlpZiAoICFkYXRhLnJvdXRlX25hbWUgKSB7CgkJCQlyb3V0ZSA9IHNlY3Rpb24uZ2V0RGVmYXVsdFJvdXRlKCk7CgkJCX0gZWxzZSB7CgkJCQlyb3V0ZSA9IHNlY3Rpb24uZ2V0Um91dGUoZGF0YS5yb3V0ZV9uYW1lKTsKCQkJfQoJCQlpZiAoICFyb3V0ZSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJXy5lYWNoKHNlbGYuYWN0aXZlX3NlY3Rpb25faW50ZXJ2YWxzLCBmdW5jdGlvbihpbnRlcnZhbF9pZCkgewoJCQkJY2xlYXJJbnRlcnZhbChpbnRlcnZhbF9pZCk7CgkJCX0pOwoKCQkJdmFyIHByZXZpb3VzUm91dGUgPSB0aGlzLmdldEFjdGl2ZVJvdXRlKCk7CgkJCWlmICggcHJldmlvdXNSb3V0ZSApIHsKCQkJCXByZXZpb3VzUm91dGUuY2xlYW51cCgpOwoJCQkJXy5lYWNoKHRoaXMuY2xlYW51cEV4dGVuZGVycywgZnVuY3Rpb24oY2UpIHsKCQkJCQljZS5jYWxsKHByZXZpb3VzUm91dGUuZ2V0U2FuZGJveCgpKTsKCQkJCX0pOwoJCQl9CgoJCQl2YXIgcHJldmlvdXNTZWN0aW9uID0gdGhpcy5nZXRBY3RpdmVTZWN0aW9uKCk7CgkJCWlmICggcHJldmlvdXNTZWN0aW9uICkgewoJCQkJaWYgKCBwcmV2aW91c1NlY3Rpb24uZ2V0TmFtZSgpICE9PSBkYXRhLnNlY3Rpb25fbmFtZSApIHsKCQkJCQlwcmV2aW91c1NlY3Rpb24uY2xlYW51cCgpOwoJCQkJfQoJCQl9CgoJCQl0aGlzLmNoZWNrUGFyZW50U2VjdGlvbihkYXRhLnNlY3Rpb25fbmFtZSk7CgkJCXJvdXRlLmluaXQoZGF0YS5yb3V0ZV9pZCwgZnVuY3Rpb24oZXJyKSB7CgkJCQlpZiAoIGVyciApIHsKCQkJCQkvLyB0b2RvIC0gPwoJCQkJfQoJCQl9KTsKCQl9LAoKCQknbmF2aWdhdGUnOiBmdW5jdGlvbihyb3V0ZSwgbGVhdmVfaGlzdG9yeSkgewoJCQl2YXIgb3B0cyA9IHsKCQkJCXRyaWdnZXI6IHRydWUsCgkJCQlyZXBsYWNlIDogbGVhdmVfaGlzdG9yeQoJCQl9OwoJCQl0aGlzLlJvdXRlcy5uYXZpZ2F0ZShyb3V0ZSwgb3B0cyk7CgkJfSwKCgkJJ3NldEFjdGl2ZVNlY3Rpb24nOiBmdW5jdGlvbihzZWN0aW9uKSB7CgkJCXRoaXMuYWN0aXZlX3NlY3Rpb24gPSBzZWN0aW9uOwoJCX0sCgoJCSdzZXRBY3RpdmVSb3V0ZSc6IGZ1bmN0aW9uKHJvdXRlKSB7CgkJCXRoaXMuYWN0aXZlX3JvdXRlID0gcm91dGU7CgkJfSwKCgkJJ2dldERlYnVnJzogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLmRlYnVnOwoJCX0sCgoJCSdnZXRBY3RpdmVTZWN0aW9uJzogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLmFjdGl2ZV9zZWN0aW9uOwoJCX0sCgoJCSdnZXRBY3RpdmVSb3V0ZSc6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5hY3RpdmVfcm91dGU7CgkJfSwKCgkJJ2NyZWF0ZVNlY3Rpb25JbnRlcnZhbCc6IGZ1bmN0aW9uKGZuLCBpbnRlcnZhbCkgewoJCQl0aGlzLmFjdGl2ZV9zZWN0aW9uX2ludGVydmFscy5wdXNoKHNldEludGVydmFsKGZuLCBpbnRlcnZhbCkpOwoJCX0sCgoJCSdjcmVhdGVQYXJlbnRTZWN0aW9uSW50ZXJ2YWwnOiBmdW5jdGlvbihmbiwgaW50ZXJ2YWwpIHsKCQkJdGhpcy5hY3RpdmVfcGFyZW50X3NlY3Rpb25faW50ZXJ2YWxzLnB1c2goc2V0SW50ZXJ2YWwoZm4sIGludGVydmFsKSk7CgkJfSwKCgkJJ2dldFJvdXRlcyc6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5Sb3V0ZXM7CgkJfSwKCgkJJ2luc2VydFNlY3Rpb25UZW1wbGF0ZSc6IGZ1bmN0aW9uKHRlbXBsYXRlKSB7CgkJCXRoaXMucm91dGVfY29udGFpbmVyLmlubmVySFRNTCA9ICcnOwoJCQl0aGlzLnJvdXRlX2NvbnRhaW5lci5hcHBlbmRDaGlsZCh0ZW1wbGF0ZSk7CgkJfSwKCgkJJ2luc2VydFRlbXBsYXRlJzogZnVuY3Rpb24odGVtcGxhdGUpIHsKCQkJdmFyIGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyb3V0ZScpOwoJCQljb250YWluZXIuaW5uZXJIVE1MID0gJyc7CgkJCWNvbnRhaW5lci5hcHBlbmRDaGlsZCh0ZW1wbGF0ZSk7CgkJfSwKCgkJJ2V4dGVuZCc6IGZ1bmN0aW9uKGV4dCkgewoJCQlpZiAoICFfLmlzT2JqZWN0KGV4dCkgKSB7CgkJCQl0aHJvdyAnSW52YWxpZCBleHRlbnNpb24ocykgc3BlY2lmaWVkOiBleHBlY3RlZCBhbiBvYmplY3QuJzsKCQkJfQoJCQl0aGlzLnJvdXRlX2V4dGVuc2lvbnMucHVzaChleHQpOwoJCX0sCgoJCSdnZXRSb3V0ZUV4dGVuc2lvbnMnOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMucm91dGVfZXh0ZW5zaW9uczsKCQl9LAoKCQknY2xlYW51cEV4dGVuZGVycyc6IFtdLAoKCQknZXh0ZW5kQ2xlYW51cCc6IGZ1bmN0aW9uKGZuKSB7CgkJCWlmICggIV8uaXNGdW5jdGlvbihmbikgKSB7CgkJCQl0aHJvdyAnZXh0ZW5kQ2xlYW51cCBleHBlY3RzIGEgc2luZ2xlIHBhcmFtZXRlcjogYSBjYWxsYmFjayBmdW5jdGlvbi4nOwoJCQl9CgkJCXRoaXMuY2xlYW51cEV4dGVuZGVycy5wdXNoKGZuKTsKCQl9CgoJfSk7CgoJcmV0dXJuIEVkaXNvbjsKCn0pOwoKLyoqCiAqIEBwYWNrYWdlIEVkaXNvbgogKi8KZGVmaW5lKCdlZGlzb24nLCBbJ3JlcXVpcmUnLCcuL2xpYi9lZGlzb24nXSxmdW5jdGlvbihyZXF1aXJlKSB7CglyZXR1cm4gcmVxdWlyZSgnLi9saWIvZWRpc29uJyk7Cn0pOwoKZGVmaW5lKCJlZGlzb24vbWFpbiIsIGZ1bmN0aW9uKCl7fSk7Cg==",
                "body": "Ci8vICAgICBVbmRlcnNjb3JlLmpzIDEuNS4yCi8vICAgICBodHRwOi8vdW5kZXJzY29yZWpzLm9yZwovLyAgICAgKGMpIDIwMDktMjAxMyBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgYW5kIEludmVzdGlnYXRpdmUgUmVwb3J0ZXJzICYgRWRpdG9ycwovLyAgICAgVW5kZXJzY29yZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KCihmdW5jdGlvbigpIHsKCiAgLy8gQmFzZWxpbmUgc2V0dXAKICAvLyAtLS0tLS0tLS0tLS0tLQoKICAvLyBFc3RhYmxpc2ggdGhlIHJvb3Qgb2JqZWN0LCBgd2luZG93YCBpbiB0aGUgYnJvd3Nlciwgb3IgYGV4cG9ydHNgIG9uIHRoZSBzZXJ2ZXIuCiAgdmFyIHJvb3QgPSB0aGlzOwoKICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYF9gIHZhcmlhYmxlLgogIHZhciBwcmV2aW91c1VuZGVyc2NvcmUgPSByb290Ll87CgogIC8vIEVzdGFibGlzaCB0aGUgb2JqZWN0IHRoYXQgZ2V0cyByZXR1cm5lZCB0byBicmVhayBvdXQgb2YgYSBsb29wIGl0ZXJhdGlvbi4KICB2YXIgYnJlYWtlciA9IHt9OwoKICAvLyBTYXZlIGJ5dGVzIGluIHRoZSBtaW5pZmllZCAoYnV0IG5vdCBnemlwcGVkKSB2ZXJzaW9uOgogIHZhciBBcnJheVByb3RvID0gQXJyYXkucHJvdG90eXBlLCBPYmpQcm90byA9IE9iamVjdC5wcm90b3R5cGUsIEZ1bmNQcm90byA9IEZ1bmN0aW9uLnByb3RvdHlwZTsKCiAgLy8gQ3JlYXRlIHF1aWNrIHJlZmVyZW5jZSB2YXJpYWJsZXMgZm9yIHNwZWVkIGFjY2VzcyB0byBjb3JlIHByb3RvdHlwZXMuCiAgdmFyCiAgICBwdXNoICAgICAgICAgICAgID0gQXJyYXlQcm90by5wdXNoLAogICAgc2xpY2UgICAgICAgICAgICA9IEFycmF5UHJvdG8uc2xpY2UsCiAgICBjb25jYXQgICAgICAgICAgID0gQXJyYXlQcm90by5jb25jYXQsCiAgICB0b1N0cmluZyAgICAgICAgID0gT2JqUHJvdG8udG9TdHJpbmcsCiAgICBoYXNPd25Qcm9wZXJ0eSAgID0gT2JqUHJvdG8uaGFzT3duUHJvcGVydHk7CgogIC8vIEFsbCAqKkVDTUFTY3JpcHQgNSoqIG5hdGl2ZSBmdW5jdGlvbiBpbXBsZW1lbnRhdGlvbnMgdGhhdCB3ZSBob3BlIHRvIHVzZQogIC8vIGFyZSBkZWNsYXJlZCBoZXJlLgogIHZhcgogICAgbmF0aXZlRm9yRWFjaCAgICAgID0gQXJyYXlQcm90by5mb3JFYWNoLAogICAgbmF0aXZlTWFwICAgICAgICAgID0gQXJyYXlQcm90by5tYXAsCiAgICBuYXRpdmVSZWR1Y2UgICAgICAgPSBBcnJheVByb3RvLnJlZHVjZSwKICAgIG5hdGl2ZVJlZHVjZVJpZ2h0ICA9IEFycmF5UHJvdG8ucmVkdWNlUmlnaHQsCiAgICBuYXRpdmVGaWx0ZXIgICAgICAgPSBBcnJheVByb3RvLmZpbHRlciwKICAgIG5hdGl2ZUV2ZXJ5ICAgICAgICA9IEFycmF5UHJvdG8uZXZlcnksCiAgICBuYXRpdmVTb21lICAgICAgICAgPSBBcnJheVByb3RvLnNvbWUsCiAgICBuYXRpdmVJbmRleE9mICAgICAgPSBBcnJheVByb3RvLmluZGV4T2YsCiAgICBuYXRpdmVMYXN0SW5kZXhPZiAgPSBBcnJheVByb3RvLmxhc3RJbmRleE9mLAogICAgbmF0aXZlSXNBcnJheSAgICAgID0gQXJyYXkuaXNBcnJheSwKICAgIG5hdGl2ZUtleXMgICAgICAgICA9IE9iamVjdC5rZXlzLAogICAgbmF0aXZlQmluZCAgICAgICAgID0gRnVuY1Byb3RvLmJpbmQ7CgogIC8vIENyZWF0ZSBhIHNhZmUgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdCBmb3IgdXNlIGJlbG93LgogIHZhciBfID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqIGluc3RhbmNlb2YgXykgcmV0dXJuIG9iajsKICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBfKSkgcmV0dXJuIG5ldyBfKG9iaik7CiAgICB0aGlzLl93cmFwcGVkID0gb2JqOwogIH07CgogIC8vIEV4cG9ydCB0aGUgVW5kZXJzY29yZSBvYmplY3QgZm9yICoqTm9kZS5qcyoqLCB3aXRoCiAgLy8gYmFja3dhcmRzLWNvbXBhdGliaWxpdHkgZm9yIHRoZSBvbGQgYHJlcXVpcmUoKWAgQVBJLiBJZiB3ZSdyZSBpbgogIC8vIHRoZSBicm93c2VyLCBhZGQgYF9gIGFzIGEgZ2xvYmFsIG9iamVjdCB2aWEgYSBzdHJpbmcgaWRlbnRpZmllciwKICAvLyBmb3IgQ2xvc3VyZSBDb21waWxlciAiYWR2YW5jZWQiIG1vZGUuCiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgIGV4cG9ydHMgPSBtb2R1bGUuZXhwb3J0cyA9IF87CiAgICB9CiAgICBleHBvcnRzLl8gPSBfOwogIH0gZWxzZSB7CiAgICByb290Ll8gPSBfOwogIH0KCiAgLy8gQ3VycmVudCB2ZXJzaW9uLgogIF8uVkVSU0lPTiA9ICcxLjUuMic7CgogIC8vIENvbGxlY3Rpb24gRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gVGhlIGNvcm5lcnN0b25lLCBhbiBgZWFjaGAgaW1wbGVtZW50YXRpb24sIGFrYSBgZm9yRWFjaGAuCiAgLy8gSGFuZGxlcyBvYmplY3RzIHdpdGggdGhlIGJ1aWx0LWluIGBmb3JFYWNoYCwgYXJyYXlzLCBhbmQgcmF3IG9iamVjdHMuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGZvckVhY2hgIGlmIGF2YWlsYWJsZS4KICB2YXIgZWFjaCA9IF8uZWFjaCA9IF8uZm9yRWFjaCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuOwogICAgaWYgKG5hdGl2ZUZvckVhY2ggJiYgb2JqLmZvckVhY2ggPT09IG5hdGl2ZUZvckVhY2gpIHsKICAgICAgb2JqLmZvckVhY2goaXRlcmF0b3IsIGNvbnRleHQpOwogICAgfSBlbHNlIGlmIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgewogICAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gb2JqLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2ldLCBpLCBvYmopID09PSBicmVha2VyKSByZXR1cm47CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBrZXlzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleXNbaV1dLCBrZXlzW2ldLCBvYmopID09PSBicmVha2VyKSByZXR1cm47CiAgICAgIH0KICAgIH0KICB9OwoKICAvLyBSZXR1cm4gdGhlIHJlc3VsdHMgb2YgYXBwbHlpbmcgdGhlIGl0ZXJhdG9yIHRvIGVhY2ggZWxlbWVudC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgbWFwYCBpZiBhdmFpbGFibGUuCiAgXy5tYXAgPSBfLmNvbGxlY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0czsKICAgIGlmIChuYXRpdmVNYXAgJiYgb2JqLm1hcCA9PT0gbmF0aXZlTWFwKSByZXR1cm4gb2JqLm1hcChpdGVyYXRvciwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJlc3VsdHMucHVzaChpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICB2YXIgcmVkdWNlRXJyb3IgPSAnUmVkdWNlIG9mIGVtcHR5IGFycmF5IHdpdGggbm8gaW5pdGlhbCB2YWx1ZSc7CgogIC8vICoqUmVkdWNlKiogYnVpbGRzIHVwIGEgc2luZ2xlIHJlc3VsdCBmcm9tIGEgbGlzdCBvZiB2YWx1ZXMsIGFrYSBgaW5qZWN0YCwKICAvLyBvciBgZm9sZGxgLiBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgcmVkdWNlYCBpZiBhdmFpbGFibGUuCiAgXy5yZWR1Y2UgPSBfLmZvbGRsID0gXy5pbmplY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBtZW1vLCBjb250ZXh0KSB7CiAgICB2YXIgaW5pdGlhbCA9IGFyZ3VtZW50cy5sZW5ndGggPiAyOwogICAgaWYgKG9iaiA9PSBudWxsKSBvYmogPSBbXTsKICAgIGlmIChuYXRpdmVSZWR1Y2UgJiYgb2JqLnJlZHVjZSA9PT0gbmF0aXZlUmVkdWNlKSB7CiAgICAgIGlmIChjb250ZXh0KSBpdGVyYXRvciA9IF8uYmluZChpdGVyYXRvciwgY29udGV4dCk7CiAgICAgIHJldHVybiBpbml0aWFsID8gb2JqLnJlZHVjZShpdGVyYXRvciwgbWVtbykgOiBvYmoucmVkdWNlKGl0ZXJhdG9yKTsKICAgIH0KICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKCFpbml0aWFsKSB7CiAgICAgICAgbWVtbyA9IHZhbHVlOwogICAgICAgIGluaXRpYWwgPSB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIG1lbW8gPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG1lbW8sIHZhbHVlLCBpbmRleCwgbGlzdCk7CiAgICAgIH0KICAgIH0pOwogICAgaWYgKCFpbml0aWFsKSB0aHJvdyBuZXcgVHlwZUVycm9yKHJlZHVjZUVycm9yKTsKICAgIHJldHVybiBtZW1vOwogIH07CgogIC8vIFRoZSByaWdodC1hc3NvY2lhdGl2ZSB2ZXJzaW9uIG9mIHJlZHVjZSwgYWxzbyBrbm93biBhcyBgZm9sZHJgLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGByZWR1Y2VSaWdodGAgaWYgYXZhaWxhYmxlLgogIF8ucmVkdWNlUmlnaHQgPSBfLmZvbGRyID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgbWVtbywgY29udGV4dCkgewogICAgdmFyIGluaXRpYWwgPSBhcmd1bWVudHMubGVuZ3RoID4gMjsKICAgIGlmIChvYmogPT0gbnVsbCkgb2JqID0gW107CiAgICBpZiAobmF0aXZlUmVkdWNlUmlnaHQgJiYgb2JqLnJlZHVjZVJpZ2h0ID09PSBuYXRpdmVSZWR1Y2VSaWdodCkgewogICAgICBpZiAoY29udGV4dCkgaXRlcmF0b3IgPSBfLmJpbmQoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgICByZXR1cm4gaW5pdGlhbCA/IG9iai5yZWR1Y2VSaWdodChpdGVyYXRvciwgbWVtbykgOiBvYmoucmVkdWNlUmlnaHQoaXRlcmF0b3IpOwogICAgfQogICAgdmFyIGxlbmd0aCA9IG9iai5sZW5ndGg7CiAgICBpZiAobGVuZ3RoICE9PSArbGVuZ3RoKSB7CiAgICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICAgIGxlbmd0aCA9IGtleXMubGVuZ3RoOwogICAgfQogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpbmRleCA9IGtleXMgPyBrZXlzWy0tbGVuZ3RoXSA6IC0tbGVuZ3RoOwogICAgICBpZiAoIWluaXRpYWwpIHsKICAgICAgICBtZW1vID0gb2JqW2luZGV4XTsKICAgICAgICBpbml0aWFsID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZW1vID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBtZW1vLCBvYmpbaW5kZXhdLCBpbmRleCwgbGlzdCk7CiAgICAgIH0KICAgIH0pOwogICAgaWYgKCFpbml0aWFsKSB0aHJvdyBuZXcgVHlwZUVycm9yKHJlZHVjZUVycm9yKTsKICAgIHJldHVybiBtZW1vOwogIH07CgogIC8vIFJldHVybiB0aGUgZmlyc3QgdmFsdWUgd2hpY2ggcGFzc2VzIGEgdHJ1dGggdGVzdC4gQWxpYXNlZCBhcyBgZGV0ZWN0YC4KICBfLmZpbmQgPSBfLmRldGVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHQ7CiAgICBhbnkob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkgewogICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gUmV0dXJuIGFsbCB0aGUgZWxlbWVudHMgdGhhdCBwYXNzIGEgdHJ1dGggdGVzdC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgZmlsdGVyYCBpZiBhdmFpbGFibGUuCiAgLy8gQWxpYXNlZCBhcyBgc2VsZWN0YC4KICBfLmZpbHRlciA9IF8uc2VsZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHJlc3VsdHM7CiAgICBpZiAobmF0aXZlRmlsdGVyICYmIG9iai5maWx0ZXIgPT09IG5hdGl2ZUZpbHRlcikgcmV0dXJuIG9iai5maWx0ZXIoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSByZXN1bHRzLnB1c2godmFsdWUpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyBSZXR1cm4gYWxsIHRoZSBlbGVtZW50cyBmb3Igd2hpY2ggYSB0cnV0aCB0ZXN0IGZhaWxzLgogIF8ucmVqZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgcmV0dXJuIF8uZmlsdGVyKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJldHVybiAhaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpOwogICAgfSwgY29udGV4dCk7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIHdoZXRoZXIgYWxsIG9mIHRoZSBlbGVtZW50cyBtYXRjaCBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGV2ZXJ5YCBpZiBhdmFpbGFibGUuCiAgLy8gQWxpYXNlZCBhcyBgYWxsYC4KICBfLmV2ZXJ5ID0gXy5hbGwgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpdGVyYXRvciB8fCAoaXRlcmF0b3IgPSBfLmlkZW50aXR5KTsKICAgIHZhciByZXN1bHQgPSB0cnVlOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0OwogICAgaWYgKG5hdGl2ZUV2ZXJ5ICYmIG9iai5ldmVyeSA9PT0gbmF0aXZlRXZlcnkpIHJldHVybiBvYmouZXZlcnkoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoIShyZXN1bHQgPSByZXN1bHQgJiYgaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSkgcmV0dXJuIGJyZWFrZXI7CiAgICB9KTsKICAgIHJldHVybiAhIXJlc3VsdDsKICB9OwoKICAvLyBEZXRlcm1pbmUgaWYgYXQgbGVhc3Qgb25lIGVsZW1lbnQgaW4gdGhlIG9iamVjdCBtYXRjaGVzIGEgdHJ1dGggdGVzdC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgc29tZWAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYGFueWAuCiAgdmFyIGFueSA9IF8uc29tZSA9IF8uYW55ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgfHwgKGl0ZXJhdG9yID0gXy5pZGVudGl0eSk7CiAgICB2YXIgcmVzdWx0ID0gZmFsc2U7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHQ7CiAgICBpZiAobmF0aXZlU29tZSAmJiBvYmouc29tZSA9PT0gbmF0aXZlU29tZSkgcmV0dXJuIG9iai5zb21lKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKHJlc3VsdCB8fCAocmVzdWx0ID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSkgcmV0dXJuIGJyZWFrZXI7CiAgICB9KTsKICAgIHJldHVybiAhIXJlc3VsdDsKICB9OwoKICAvLyBEZXRlcm1pbmUgaWYgdGhlIGFycmF5IG9yIG9iamVjdCBjb250YWlucyBhIGdpdmVuIHZhbHVlICh1c2luZyBgPT09YCkuCiAgLy8gQWxpYXNlZCBhcyBgaW5jbHVkZWAuCiAgXy5jb250YWlucyA9IF8uaW5jbHVkZSA9IGZ1bmN0aW9uKG9iaiwgdGFyZ2V0KSB7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiBmYWxzZTsKICAgIGlmIChuYXRpdmVJbmRleE9mICYmIG9iai5pbmRleE9mID09PSBuYXRpdmVJbmRleE9mKSByZXR1cm4gb2JqLmluZGV4T2YodGFyZ2V0KSAhPSAtMTsKICAgIHJldHVybiBhbnkob2JqLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPT09IHRhcmdldDsKICAgIH0pOwogIH07CgogIC8vIEludm9rZSBhIG1ldGhvZCAod2l0aCBhcmd1bWVudHMpIG9uIGV2ZXJ5IGl0ZW0gaW4gYSBjb2xsZWN0aW9uLgogIF8uaW52b2tlID0gZnVuY3Rpb24ob2JqLCBtZXRob2QpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgdmFyIGlzRnVuYyA9IF8uaXNGdW5jdGlvbihtZXRob2QpOwogICAgcmV0dXJuIF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIChpc0Z1bmMgPyBtZXRob2QgOiB2YWx1ZVttZXRob2RdKS5hcHBseSh2YWx1ZSwgYXJncyk7CiAgICB9KTsKICB9OwoKICAvLyBDb252ZW5pZW5jZSB2ZXJzaW9uIG9mIGEgY29tbW9uIHVzZSBjYXNlIG9mIGBtYXBgOiBmZXRjaGluZyBhIHByb3BlcnR5LgogIF8ucGx1Y2sgPSBmdW5jdGlvbihvYmosIGtleSkgewogICAgcmV0dXJuIF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUpeyByZXR1cm4gdmFsdWVba2V5XTsgfSk7CiAgfTsKCiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgZmlsdGVyYDogc2VsZWN0aW5nIG9ubHkgb2JqZWN0cwogIC8vIGNvbnRhaW5pbmcgc3BlY2lmaWMgYGtleTp2YWx1ZWAgcGFpcnMuCiAgXy53aGVyZSA9IGZ1bmN0aW9uKG9iaiwgYXR0cnMsIGZpcnN0KSB7CiAgICBpZiAoXy5pc0VtcHR5KGF0dHJzKSkgcmV0dXJuIGZpcnN0ID8gdm9pZCAwIDogW107CiAgICByZXR1cm4gX1tmaXJzdCA/ICdmaW5kJyA6ICdmaWx0ZXInXShvYmosIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewogICAgICAgIGlmIChhdHRyc1trZXldICE9PSB2YWx1ZVtrZXldKSByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9KTsKICB9OwoKICAvLyBDb252ZW5pZW5jZSB2ZXJzaW9uIG9mIGEgY29tbW9uIHVzZSBjYXNlIG9mIGBmaW5kYDogZ2V0dGluZyB0aGUgZmlyc3Qgb2JqZWN0CiAgLy8gY29udGFpbmluZyBzcGVjaWZpYyBga2V5OnZhbHVlYCBwYWlycy4KICBfLmZpbmRXaGVyZSA9IGZ1bmN0aW9uKG9iaiwgYXR0cnMpIHsKICAgIHJldHVybiBfLndoZXJlKG9iaiwgYXR0cnMsIHRydWUpOwogIH07CgogIC8vIFJldHVybiB0aGUgbWF4aW11bSBlbGVtZW50IG9yIChlbGVtZW50LWJhc2VkIGNvbXB1dGF0aW9uKS4KICAvLyBDYW4ndCBvcHRpbWl6ZSBhcnJheXMgb2YgaW50ZWdlcnMgbG9uZ2VyIHRoYW4gNjUsNTM1IGVsZW1lbnRzLgogIC8vIFNlZSBbV2ViS2l0IEJ1ZyA4MDc5N10oaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTgwNzk3KQogIF8ubWF4ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzQXJyYXkob2JqKSAmJiBvYmpbMF0gPT09ICtvYmpbMF0gJiYgb2JqLmxlbmd0aCA8IDY1NTM1KSB7CiAgICAgIHJldHVybiBNYXRoLm1heC5hcHBseShNYXRoLCBvYmopOwogICAgfQogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzRW1wdHkob2JqKSkgcmV0dXJuIC1JbmZpbml0eTsKICAgIHZhciByZXN1bHQgPSB7Y29tcHV0ZWQgOiAtSW5maW5pdHksIHZhbHVlOiAtSW5maW5pdHl9OwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICB2YXIgY29tcHV0ZWQgPSBpdGVyYXRvciA/IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSA6IHZhbHVlOwogICAgICBjb21wdXRlZCA+IHJlc3VsdC5jb21wdXRlZCAmJiAocmVzdWx0ID0ge3ZhbHVlIDogdmFsdWUsIGNvbXB1dGVkIDogY29tcHV0ZWR9KTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdC52YWx1ZTsKICB9OwoKICAvLyBSZXR1cm4gdGhlIG1pbmltdW0gZWxlbWVudCAob3IgZWxlbWVudC1iYXNlZCBjb21wdXRhdGlvbikuCiAgXy5taW4gPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpZiAoIWl0ZXJhdG9yICYmIF8uaXNBcnJheShvYmopICYmIG9ialswXSA9PT0gK29ialswXSAmJiBvYmoubGVuZ3RoIDwgNjU1MzUpIHsKICAgICAgcmV0dXJuIE1hdGgubWluLmFwcGx5KE1hdGgsIG9iaik7CiAgICB9CiAgICBpZiAoIWl0ZXJhdG9yICYmIF8uaXNFbXB0eShvYmopKSByZXR1cm4gSW5maW5pdHk7CiAgICB2YXIgcmVzdWx0ID0ge2NvbXB1dGVkIDogSW5maW5pdHksIHZhbHVlOiBJbmZpbml0eX07CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHZhciBjb21wdXRlZCA9IGl0ZXJhdG9yID8gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpIDogdmFsdWU7CiAgICAgIGNvbXB1dGVkIDwgcmVzdWx0LmNvbXB1dGVkICYmIChyZXN1bHQgPSB7dmFsdWUgOiB2YWx1ZSwgY29tcHV0ZWQgOiBjb21wdXRlZH0pOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0LnZhbHVlOwogIH07CgogIC8vIFNodWZmbGUgYW4gYXJyYXksIHVzaW5nIHRoZSBtb2Rlcm4gdmVyc2lvbiBvZiB0aGUgCiAgLy8gW0Zpc2hlci1ZYXRlcyBzaHVmZmxlXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0Zpc2hlcuKAk1lhdGVzX3NodWZmbGUpLgogIF8uc2h1ZmZsZSA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIHJhbmQ7CiAgICB2YXIgaW5kZXggPSAwOwogICAgdmFyIHNodWZmbGVkID0gW107CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmFuZCA9IF8ucmFuZG9tKGluZGV4KyspOwogICAgICBzaHVmZmxlZFtpbmRleCAtIDFdID0gc2h1ZmZsZWRbcmFuZF07CiAgICAgIHNodWZmbGVkW3JhbmRdID0gdmFsdWU7CiAgICB9KTsKICAgIHJldHVybiBzaHVmZmxlZDsKICB9OwoKICAvLyBTYW1wbGUgKipuKiogcmFuZG9tIHZhbHVlcyBmcm9tIGFuIGFycmF5LgogIC8vIElmICoqbioqIGlzIG5vdCBzcGVjaWZpZWQsIHJldHVybnMgYSBzaW5nbGUgcmFuZG9tIGVsZW1lbnQgZnJvbSB0aGUgYXJyYXkuCiAgLy8gVGhlIGludGVybmFsIGBndWFyZGAgYXJndW1lbnQgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgbWFwYC4KICBfLnNhbXBsZSA9IGZ1bmN0aW9uKG9iaiwgbiwgZ3VhcmQpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMiB8fCBndWFyZCkgewogICAgICByZXR1cm4gb2JqW18ucmFuZG9tKG9iai5sZW5ndGggLSAxKV07CiAgICB9CiAgICByZXR1cm4gXy5zaHVmZmxlKG9iaikuc2xpY2UoMCwgTWF0aC5tYXgoMCwgbikpOwogIH07CgogIC8vIEFuIGludGVybmFsIGZ1bmN0aW9uIHRvIGdlbmVyYXRlIGxvb2t1cCBpdGVyYXRvcnMuCiAgdmFyIGxvb2t1cEl0ZXJhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiBfLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUgOiBmdW5jdGlvbihvYmopeyByZXR1cm4gb2JqW3ZhbHVlXTsgfTsKICB9OwoKICAvLyBTb3J0IHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24gcHJvZHVjZWQgYnkgYW4gaXRlcmF0b3IuCiAgXy5zb3J0QnkgPSBmdW5jdGlvbihvYmosIHZhbHVlLCBjb250ZXh0KSB7CiAgICB2YXIgaXRlcmF0b3IgPSBsb29rdXBJdGVyYXRvcih2YWx1ZSk7CiAgICByZXR1cm4gXy5wbHVjayhfLm1hcChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICByZXR1cm4gewogICAgICAgIHZhbHVlOiB2YWx1ZSwKICAgICAgICBpbmRleDogaW5kZXgsCiAgICAgICAgY3JpdGVyaWE6IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KQogICAgICB9OwogICAgfSkuc29ydChmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICB2YXIgYSA9IGxlZnQuY3JpdGVyaWE7CiAgICAgIHZhciBiID0gcmlnaHQuY3JpdGVyaWE7CiAgICAgIGlmIChhICE9PSBiKSB7CiAgICAgICAgaWYgKGEgPiBiIHx8IGEgPT09IHZvaWQgMCkgcmV0dXJuIDE7CiAgICAgICAgaWYgKGEgPCBiIHx8IGIgPT09IHZvaWQgMCkgcmV0dXJuIC0xOwogICAgICB9CiAgICAgIHJldHVybiBsZWZ0LmluZGV4IC0gcmlnaHQuaW5kZXg7CiAgICB9KSwgJ3ZhbHVlJyk7CiAgfTsKCiAgLy8gQW4gaW50ZXJuYWwgZnVuY3Rpb24gdXNlZCBmb3IgYWdncmVnYXRlICJncm91cCBieSIgb3BlcmF0aW9ucy4KICB2YXIgZ3JvdXAgPSBmdW5jdGlvbihiZWhhdmlvcikgewogICAgcmV0dXJuIGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQpIHsKICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICB2YXIgaXRlcmF0b3IgPSB2YWx1ZSA9PSBudWxsID8gXy5pZGVudGl0eSA6IGxvb2t1cEl0ZXJhdG9yKHZhbHVlKTsKICAgICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkgewogICAgICAgIHZhciBrZXkgPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgb2JqKTsKICAgICAgICBiZWhhdmlvcihyZXN1bHQsIGtleSwgdmFsdWUpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfTsKCiAgLy8gR3JvdXBzIHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24uIFBhc3MgZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZQogIC8vIHRvIGdyb3VwIGJ5LCBvciBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgY3JpdGVyaW9uLgogIF8uZ3JvdXBCeSA9IGdyb3VwKGZ1bmN0aW9uKHJlc3VsdCwga2V5LCB2YWx1ZSkgewogICAgKF8uaGFzKHJlc3VsdCwga2V5KSA/IHJlc3VsdFtrZXldIDogKHJlc3VsdFtrZXldID0gW10pKS5wdXNoKHZhbHVlKTsKICB9KTsKCiAgLy8gSW5kZXhlcyB0aGUgb2JqZWN0J3MgdmFsdWVzIGJ5IGEgY3JpdGVyaW9uLCBzaW1pbGFyIHRvIGBncm91cEJ5YCwgYnV0IGZvcgogIC8vIHdoZW4geW91IGtub3cgdGhhdCB5b3VyIGluZGV4IHZhbHVlcyB3aWxsIGJlIHVuaXF1ZS4KICBfLmluZGV4QnkgPSBncm91cChmdW5jdGlvbihyZXN1bHQsIGtleSwgdmFsdWUpIHsKICAgIHJlc3VsdFtrZXldID0gdmFsdWU7CiAgfSk7CgogIC8vIENvdW50cyBpbnN0YW5jZXMgb2YgYW4gb2JqZWN0IHRoYXQgZ3JvdXAgYnkgYSBjZXJ0YWluIGNyaXRlcmlvbi4gUGFzcwogIC8vIGVpdGhlciBhIHN0cmluZyBhdHRyaWJ1dGUgdG8gY291bnQgYnksIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZQogIC8vIGNyaXRlcmlvbi4KICBfLmNvdW50QnkgPSBncm91cChmdW5jdGlvbihyZXN1bHQsIGtleSkgewogICAgXy5oYXMocmVzdWx0LCBrZXkpID8gcmVzdWx0W2tleV0rKyA6IHJlc3VsdFtrZXldID0gMTsKICB9KTsKCiAgLy8gVXNlIGEgY29tcGFyYXRvciBmdW5jdGlvbiB0byBmaWd1cmUgb3V0IHRoZSBzbWFsbGVzdCBpbmRleCBhdCB3aGljaAogIC8vIGFuIG9iamVjdCBzaG91bGQgYmUgaW5zZXJ0ZWQgc28gYXMgdG8gbWFpbnRhaW4gb3JkZXIuIFVzZXMgYmluYXJ5IHNlYXJjaC4KICBfLnNvcnRlZEluZGV4ID0gZnVuY3Rpb24oYXJyYXksIG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGl0ZXJhdG9yID0gaXRlcmF0b3IgPT0gbnVsbCA/IF8uaWRlbnRpdHkgOiBsb29rdXBJdGVyYXRvcihpdGVyYXRvcik7CiAgICB2YXIgdmFsdWUgPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9iaik7CiAgICB2YXIgbG93ID0gMCwgaGlnaCA9IGFycmF5Lmxlbmd0aDsKICAgIHdoaWxlIChsb3cgPCBoaWdoKSB7CiAgICAgIHZhciBtaWQgPSAobG93ICsgaGlnaCkgPj4+IDE7CiAgICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgYXJyYXlbbWlkXSkgPCB2YWx1ZSA/IGxvdyA9IG1pZCArIDEgOiBoaWdoID0gbWlkOwogICAgfQogICAgcmV0dXJuIGxvdzsKICB9OwoKICAvLyBTYWZlbHkgY3JlYXRlIGEgcmVhbCwgbGl2ZSBhcnJheSBmcm9tIGFueXRoaW5nIGl0ZXJhYmxlLgogIF8udG9BcnJheSA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCFvYmopIHJldHVybiBbXTsKICAgIGlmIChfLmlzQXJyYXkob2JqKSkgcmV0dXJuIHNsaWNlLmNhbGwob2JqKTsKICAgIGlmIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgcmV0dXJuIF8ubWFwKG9iaiwgXy5pZGVudGl0eSk7CiAgICByZXR1cm4gXy52YWx1ZXMob2JqKTsKICB9OwoKICAvLyBSZXR1cm4gdGhlIG51bWJlciBvZiBlbGVtZW50cyBpbiBhbiBvYmplY3QuCiAgXy5zaXplID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiAwOwogICAgcmV0dXJuIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgPyBvYmoubGVuZ3RoIDogXy5rZXlzKG9iaikubGVuZ3RoOwogIH07CgogIC8vIEFycmF5IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBHZXQgdGhlIGZpcnN0IGVsZW1lbnQgb2YgYW4gYXJyYXkuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gdGhlIGZpcnN0IE4KICAvLyB2YWx1ZXMgaW4gdGhlIGFycmF5LiBBbGlhc2VkIGFzIGBoZWFkYCBhbmQgYHRha2VgLiBUaGUgKipndWFyZCoqIGNoZWNrCiAgLy8gYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8uZmlyc3QgPSBfLmhlYWQgPSBfLnRha2UgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIGlmIChhcnJheSA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwogICAgcmV0dXJuIChuID09IG51bGwpIHx8IGd1YXJkID8gYXJyYXlbMF0gOiBzbGljZS5jYWxsKGFycmF5LCAwLCBuKTsKICB9OwoKICAvLyBSZXR1cm5zIGV2ZXJ5dGhpbmcgYnV0IHRoZSBsYXN0IGVudHJ5IG9mIHRoZSBhcnJheS4gRXNwZWNpYWxseSB1c2VmdWwgb24KICAvLyB0aGUgYXJndW1lbnRzIG9iamVjdC4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiBhbGwgdGhlIHZhbHVlcyBpbgogIC8vIHRoZSBhcnJheSwgZXhjbHVkaW5nIHRoZSBsYXN0IE4uIFRoZSAqKmd1YXJkKiogY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aAogIC8vIGBfLm1hcGAuCiAgXy5pbml0aWFsID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgMCwgYXJyYXkubGVuZ3RoIC0gKChuID09IG51bGwpIHx8IGd1YXJkID8gMSA6IG4pKTsKICB9OwoKICAvLyBHZXQgdGhlIGxhc3QgZWxlbWVudCBvZiBhbiBhcnJheS4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiB0aGUgbGFzdCBOCiAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gVGhlICoqZ3VhcmQqKiBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCiAgXy5sYXN0ID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKICAgIGlmICgobiA9PSBudWxsKSB8fCBndWFyZCkgewogICAgICByZXR1cm4gYXJyYXlbYXJyYXkubGVuZ3RoIC0gMV07CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgTWF0aC5tYXgoYXJyYXkubGVuZ3RoIC0gbiwgMCkpOwogICAgfQogIH07CgogIC8vIFJldHVybnMgZXZlcnl0aGluZyBidXQgdGhlIGZpcnN0IGVudHJ5IG9mIHRoZSBhcnJheS4gQWxpYXNlZCBhcyBgdGFpbGAgYW5kIGBkcm9wYC4KICAvLyBFc3BlY2lhbGx5IHVzZWZ1bCBvbiB0aGUgYXJndW1lbnRzIG9iamVjdC4gUGFzc2luZyBhbiAqKm4qKiB3aWxsIHJldHVybgogIC8vIHRoZSByZXN0IE4gdmFsdWVzIGluIHRoZSBhcnJheS4gVGhlICoqZ3VhcmQqKgogIC8vIGNoZWNrIGFsbG93cyBpdCB0byB3b3JrIHdpdGggYF8ubWFwYC4KICBfLnJlc3QgPSBfLnRhaWwgPSBfLmRyb3AgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCAobiA9PSBudWxsKSB8fCBndWFyZCA/IDEgOiBuKTsKICB9OwoKICAvLyBUcmltIG91dCBhbGwgZmFsc3kgdmFsdWVzIGZyb20gYW4gYXJyYXkuCiAgXy5jb21wYWN0ID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgIHJldHVybiBfLmZpbHRlcihhcnJheSwgXy5pZGVudGl0eSk7CiAgfTsKCiAgLy8gSW50ZXJuYWwgaW1wbGVtZW50YXRpb24gb2YgYSByZWN1cnNpdmUgYGZsYXR0ZW5gIGZ1bmN0aW9uLgogIHZhciBmbGF0dGVuID0gZnVuY3Rpb24oaW5wdXQsIHNoYWxsb3csIG91dHB1dCkgewogICAgaWYgKHNoYWxsb3cgJiYgXy5ldmVyeShpbnB1dCwgXy5pc0FycmF5KSkgewogICAgICByZXR1cm4gY29uY2F0LmFwcGx5KG91dHB1dCwgaW5wdXQpOwogICAgfQogICAgZWFjaChpbnB1dCwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKF8uaXNBcnJheSh2YWx1ZSkgfHwgXy5pc0FyZ3VtZW50cyh2YWx1ZSkpIHsKICAgICAgICBzaGFsbG93ID8gcHVzaC5hcHBseShvdXRwdXQsIHZhbHVlKSA6IGZsYXR0ZW4odmFsdWUsIHNoYWxsb3csIG91dHB1dCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3V0cHV0LnB1c2godmFsdWUpOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBvdXRwdXQ7CiAgfTsKCiAgLy8gRmxhdHRlbiBvdXQgYW4gYXJyYXksIGVpdGhlciByZWN1cnNpdmVseSAoYnkgZGVmYXVsdCksIG9yIGp1c3Qgb25lIGxldmVsLgogIF8uZmxhdHRlbiA9IGZ1bmN0aW9uKGFycmF5LCBzaGFsbG93KSB7CiAgICByZXR1cm4gZmxhdHRlbihhcnJheSwgc2hhbGxvdywgW10pOwogIH07CgogIC8vIFJldHVybiBhIHZlcnNpb24gb2YgdGhlIGFycmF5IHRoYXQgZG9lcyBub3QgY29udGFpbiB0aGUgc3BlY2lmaWVkIHZhbHVlKHMpLgogIF8ud2l0aG91dCA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICByZXR1cm4gXy5kaWZmZXJlbmNlKGFycmF5LCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogIH07CgogIC8vIFByb2R1Y2UgYSBkdXBsaWNhdGUtZnJlZSB2ZXJzaW9uIG9mIHRoZSBhcnJheS4gSWYgdGhlIGFycmF5IGhhcyBhbHJlYWR5CiAgLy8gYmVlbiBzb3J0ZWQsIHlvdSBoYXZlIHRoZSBvcHRpb24gb2YgdXNpbmcgYSBmYXN0ZXIgYWxnb3JpdGhtLgogIC8vIEFsaWFzZWQgYXMgYHVuaXF1ZWAuCiAgXy51bmlxID0gXy51bmlxdWUgPSBmdW5jdGlvbihhcnJheSwgaXNTb3J0ZWQsIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKGlzU29ydGVkKSkgewogICAgICBjb250ZXh0ID0gaXRlcmF0b3I7CiAgICAgIGl0ZXJhdG9yID0gaXNTb3J0ZWQ7CiAgICAgIGlzU29ydGVkID0gZmFsc2U7CiAgICB9CiAgICB2YXIgaW5pdGlhbCA9IGl0ZXJhdG9yID8gXy5tYXAoYXJyYXksIGl0ZXJhdG9yLCBjb250ZXh0KSA6IGFycmF5OwogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIHZhciBzZWVuID0gW107CiAgICBlYWNoKGluaXRpYWwsIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkgewogICAgICBpZiAoaXNTb3J0ZWQgPyAoIWluZGV4IHx8IHNlZW5bc2Vlbi5sZW5ndGggLSAxXSAhPT0gdmFsdWUpIDogIV8uY29udGFpbnMoc2VlbiwgdmFsdWUpKSB7CiAgICAgICAgc2Vlbi5wdXNoKHZhbHVlKTsKICAgICAgICByZXN1bHRzLnB1c2goYXJyYXlbaW5kZXhdKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgdGhlIHVuaW9uOiBlYWNoIGRpc3RpbmN0IGVsZW1lbnQgZnJvbSBhbGwgb2YKICAvLyB0aGUgcGFzc2VkLWluIGFycmF5cy4KICBfLnVuaW9uID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gXy51bmlxKF8uZmxhdHRlbihhcmd1bWVudHMsIHRydWUpKTsKICB9OwoKICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgZXZlcnkgaXRlbSBzaGFyZWQgYmV0d2VlbiBhbGwgdGhlCiAgLy8gcGFzc2VkLWluIGFycmF5cy4KICBfLmludGVyc2VjdGlvbiA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICB2YXIgcmVzdCA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIHJldHVybiBfLmZpbHRlcihfLnVuaXEoYXJyYXkpLCBmdW5jdGlvbihpdGVtKSB7CiAgICAgIHJldHVybiBfLmV2ZXJ5KHJlc3QsIGZ1bmN0aW9uKG90aGVyKSB7CiAgICAgICAgcmV0dXJuIF8uaW5kZXhPZihvdGhlciwgaXRlbSkgPj0gMDsKICAgICAgfSk7CiAgICB9KTsKICB9OwoKICAvLyBUYWtlIHRoZSBkaWZmZXJlbmNlIGJldHdlZW4gb25lIGFycmF5IGFuZCBhIG51bWJlciBvZiBvdGhlciBhcnJheXMuCiAgLy8gT25seSB0aGUgZWxlbWVudHMgcHJlc2VudCBpbiBqdXN0IHRoZSBmaXJzdCBhcnJheSB3aWxsIHJlbWFpbi4KICBfLmRpZmZlcmVuY2UgPSBmdW5jdGlvbihhcnJheSkgewogICAgdmFyIHJlc3QgPSBjb25jYXQuYXBwbHkoQXJyYXlQcm90bywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIHJldHVybiBfLmZpbHRlcihhcnJheSwgZnVuY3Rpb24odmFsdWUpeyByZXR1cm4gIV8uY29udGFpbnMocmVzdCwgdmFsdWUpOyB9KTsKICB9OwoKICAvLyBaaXAgdG9nZXRoZXIgbXVsdGlwbGUgbGlzdHMgaW50byBhIHNpbmdsZSBhcnJheSAtLSBlbGVtZW50cyB0aGF0IHNoYXJlCiAgLy8gYW4gaW5kZXggZ28gdG9nZXRoZXIuCiAgXy56aXAgPSBmdW5jdGlvbigpIHsKICAgIHZhciBsZW5ndGggPSBfLm1heChfLnBsdWNrKGFyZ3VtZW50cywgImxlbmd0aCIpLmNvbmNhdCgwKSk7CiAgICB2YXIgcmVzdWx0cyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICByZXN1bHRzW2ldID0gXy5wbHVjayhhcmd1bWVudHMsICcnICsgaSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyBDb252ZXJ0cyBsaXN0cyBpbnRvIG9iamVjdHMuIFBhc3MgZWl0aGVyIGEgc2luZ2xlIGFycmF5IG9mIGBba2V5LCB2YWx1ZV1gCiAgLy8gcGFpcnMsIG9yIHR3byBwYXJhbGxlbCBhcnJheXMgb2YgdGhlIHNhbWUgbGVuZ3RoIC0tIG9uZSBvZiBrZXlzLCBhbmQgb25lIG9mCiAgLy8gdGhlIGNvcnJlc3BvbmRpbmcgdmFsdWVzLgogIF8ub2JqZWN0ID0gZnVuY3Rpb24obGlzdCwgdmFsdWVzKSB7CiAgICBpZiAobGlzdCA9PSBudWxsKSByZXR1cm4ge307CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gbGlzdC5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBpZiAodmFsdWVzKSB7CiAgICAgICAgcmVzdWx0W2xpc3RbaV1dID0gdmFsdWVzW2ldOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3VsdFtsaXN0W2ldWzBdXSA9IGxpc3RbaV1bMV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gSWYgdGhlIGJyb3dzZXIgZG9lc24ndCBzdXBwbHkgdXMgd2l0aCBpbmRleE9mIChJJ20gbG9va2luZyBhdCB5b3UsICoqTVNJRSoqKSwKICAvLyB3ZSBuZWVkIHRoaXMgZnVuY3Rpb24uIFJldHVybiB0aGUgcG9zaXRpb24gb2YgdGhlIGZpcnN0IG9jY3VycmVuY2Ugb2YgYW4KICAvLyBpdGVtIGluIGFuIGFycmF5LCBvciAtMSBpZiB0aGUgaXRlbSBpcyBub3QgaW5jbHVkZWQgaW4gdGhlIGFycmF5LgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBpbmRleE9mYCBpZiBhdmFpbGFibGUuCiAgLy8gSWYgdGhlIGFycmF5IGlzIGxhcmdlIGFuZCBhbHJlYWR5IGluIHNvcnQgb3JkZXIsIHBhc3MgYHRydWVgCiAgLy8gZm9yICoqaXNTb3J0ZWQqKiB0byB1c2UgYmluYXJ5IHNlYXJjaC4KICBfLmluZGV4T2YgPSBmdW5jdGlvbihhcnJheSwgaXRlbSwgaXNTb3J0ZWQpIHsKICAgIGlmIChhcnJheSA9PSBudWxsKSByZXR1cm4gLTE7CiAgICB2YXIgaSA9IDAsIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgIGlmIChpc1NvcnRlZCkgewogICAgICBpZiAodHlwZW9mIGlzU29ydGVkID09ICdudW1iZXInKSB7CiAgICAgICAgaSA9IChpc1NvcnRlZCA8IDAgPyBNYXRoLm1heCgwLCBsZW5ndGggKyBpc1NvcnRlZCkgOiBpc1NvcnRlZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaSA9IF8uc29ydGVkSW5kZXgoYXJyYXksIGl0ZW0pOwogICAgICAgIHJldHVybiBhcnJheVtpXSA9PT0gaXRlbSA/IGkgOiAtMTsKICAgICAgfQogICAgfQogICAgaWYgKG5hdGl2ZUluZGV4T2YgJiYgYXJyYXkuaW5kZXhPZiA9PT0gbmF0aXZlSW5kZXhPZikgcmV0dXJuIGFycmF5LmluZGV4T2YoaXRlbSwgaXNTb3J0ZWQpOwogICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgaWYgKGFycmF5W2ldID09PSBpdGVtKSByZXR1cm4gaTsKICAgIHJldHVybiAtMTsKICB9OwoKICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgbGFzdEluZGV4T2ZgIGlmIGF2YWlsYWJsZS4KICBfLmxhc3RJbmRleE9mID0gZnVuY3Rpb24oYXJyYXksIGl0ZW0sIGZyb20pIHsKICAgIGlmIChhcnJheSA9PSBudWxsKSByZXR1cm4gLTE7CiAgICB2YXIgaGFzSW5kZXggPSBmcm9tICE9IG51bGw7CiAgICBpZiAobmF0aXZlTGFzdEluZGV4T2YgJiYgYXJyYXkubGFzdEluZGV4T2YgPT09IG5hdGl2ZUxhc3RJbmRleE9mKSB7CiAgICAgIHJldHVybiBoYXNJbmRleCA/IGFycmF5Lmxhc3RJbmRleE9mKGl0ZW0sIGZyb20pIDogYXJyYXkubGFzdEluZGV4T2YoaXRlbSk7CiAgICB9CiAgICB2YXIgaSA9IChoYXNJbmRleCA/IGZyb20gOiBhcnJheS5sZW5ndGgpOwogICAgd2hpbGUgKGktLSkgaWYgKGFycmF5W2ldID09PSBpdGVtKSByZXR1cm4gaTsKICAgIHJldHVybiAtMTsKICB9OwoKICAvLyBHZW5lcmF0ZSBhbiBpbnRlZ2VyIEFycmF5IGNvbnRhaW5pbmcgYW4gYXJpdGhtZXRpYyBwcm9ncmVzc2lvbi4gQSBwb3J0IG9mCiAgLy8gdGhlIG5hdGl2ZSBQeXRob24gYHJhbmdlKClgIGZ1bmN0aW9uLiBTZWUKICAvLyBbdGhlIFB5dGhvbiBkb2N1bWVudGF0aW9uXShodHRwOi8vZG9jcy5weXRob24ub3JnL2xpYnJhcnkvZnVuY3Rpb25zLmh0bWwjcmFuZ2UpLgogIF8ucmFuZ2UgPSBmdW5jdGlvbihzdGFydCwgc3RvcCwgc3RlcCkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPD0gMSkgewogICAgICBzdG9wID0gc3RhcnQgfHwgMDsKICAgICAgc3RhcnQgPSAwOwogICAgfQogICAgc3RlcCA9IGFyZ3VtZW50c1syXSB8fCAxOwoKICAgIHZhciBsZW5ndGggPSBNYXRoLm1heChNYXRoLmNlaWwoKHN0b3AgLSBzdGFydCkgLyBzdGVwKSwgMCk7CiAgICB2YXIgaWR4ID0gMDsKICAgIHZhciByYW5nZSA9IG5ldyBBcnJheShsZW5ndGgpOwoKICAgIHdoaWxlKGlkeCA8IGxlbmd0aCkgewogICAgICByYW5nZVtpZHgrK10gPSBzdGFydDsKICAgICAgc3RhcnQgKz0gc3RlcDsKICAgIH0KCiAgICByZXR1cm4gcmFuZ2U7CiAgfTsKCiAgLy8gRnVuY3Rpb24gKGFoZW0pIEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBSZXVzYWJsZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgcHJvdG90eXBlIHNldHRpbmcuCiAgdmFyIGN0b3IgPSBmdW5jdGlvbigpe307CgogIC8vIENyZWF0ZSBhIGZ1bmN0aW9uIGJvdW5kIHRvIGEgZ2l2ZW4gb2JqZWN0IChhc3NpZ25pbmcgYHRoaXNgLCBhbmQgYXJndW1lbnRzLAogIC8vIG9wdGlvbmFsbHkpLiBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgRnVuY3Rpb24uYmluZGAgaWYKICAvLyBhdmFpbGFibGUuCiAgXy5iaW5kID0gZnVuY3Rpb24oZnVuYywgY29udGV4dCkgewogICAgdmFyIGFyZ3MsIGJvdW5kOwogICAgaWYgKG5hdGl2ZUJpbmQgJiYgZnVuYy5iaW5kID09PSBuYXRpdmVCaW5kKSByZXR1cm4gbmF0aXZlQmluZC5hcHBseShmdW5jLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgaWYgKCFfLmlzRnVuY3Rpb24oZnVuYykpIHRocm93IG5ldyBUeXBlRXJyb3I7CiAgICBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIGJvdW5kID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBib3VuZCkpIHJldHVybiBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICBjdG9yLnByb3RvdHlwZSA9IGZ1bmMucHJvdG90eXBlOwogICAgICB2YXIgc2VsZiA9IG5ldyBjdG9yOwogICAgICBjdG9yLnByb3RvdHlwZSA9IG51bGw7CiAgICAgIHZhciByZXN1bHQgPSBmdW5jLmFwcGx5KHNlbGYsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICBpZiAoT2JqZWN0KHJlc3VsdCkgPT09IHJlc3VsdCkgcmV0dXJuIHJlc3VsdDsKICAgICAgcmV0dXJuIHNlbGY7CiAgICB9OwogIH07CgogIC8vIFBhcnRpYWxseSBhcHBseSBhIGZ1bmN0aW9uIGJ5IGNyZWF0aW5nIGEgdmVyc2lvbiB0aGF0IGhhcyBoYWQgc29tZSBvZiBpdHMKICAvLyBhcmd1bWVudHMgcHJlLWZpbGxlZCwgd2l0aG91dCBjaGFuZ2luZyBpdHMgZHluYW1pYyBgdGhpc2AgY29udGV4dC4KICBfLnBhcnRpYWwgPSBmdW5jdGlvbihmdW5jKSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICB9OwogIH07CgogIC8vIEJpbmQgYWxsIG9mIGFuIG9iamVjdCdzIG1ldGhvZHMgdG8gdGhhdCBvYmplY3QuIFVzZWZ1bCBmb3IgZW5zdXJpbmcgdGhhdAogIC8vIGFsbCBjYWxsYmFja3MgZGVmaW5lZCBvbiBhbiBvYmplY3QgYmVsb25nIHRvIGl0LgogIF8uYmluZEFsbCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGZ1bmNzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgaWYgKGZ1bmNzLmxlbmd0aCA9PT0gMCkgdGhyb3cgbmV3IEVycm9yKCJiaW5kQWxsIG11c3QgYmUgcGFzc2VkIGZ1bmN0aW9uIG5hbWVzIik7CiAgICBlYWNoKGZ1bmNzLCBmdW5jdGlvbihmKSB7IG9ialtmXSA9IF8uYmluZChvYmpbZl0sIG9iaik7IH0pOwogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBNZW1vaXplIGFuIGV4cGVuc2l2ZSBmdW5jdGlvbiBieSBzdG9yaW5nIGl0cyByZXN1bHRzLgogIF8ubWVtb2l6ZSA9IGZ1bmN0aW9uKGZ1bmMsIGhhc2hlcikgewogICAgdmFyIG1lbW8gPSB7fTsKICAgIGhhc2hlciB8fCAoaGFzaGVyID0gXy5pZGVudGl0eSk7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBrZXkgPSBoYXNoZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIF8uaGFzKG1lbW8sIGtleSkgPyBtZW1vW2tleV0gOiAobWVtb1trZXldID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfTsKCiAgLy8gRGVsYXlzIGEgZnVuY3Rpb24gZm9yIHRoZSBnaXZlbiBudW1iZXIgb2YgbWlsbGlzZWNvbmRzLCBhbmQgdGhlbiBjYWxscwogIC8vIGl0IHdpdGggdGhlIGFyZ3VtZW50cyBzdXBwbGllZC4KICBfLmRlbGF5ID0gZnVuY3Rpb24oZnVuYywgd2FpdCkgewogICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICByZXR1cm4gc2V0VGltZW91dChmdW5jdGlvbigpeyByZXR1cm4gZnVuYy5hcHBseShudWxsLCBhcmdzKTsgfSwgd2FpdCk7CiAgfTsKCiAgLy8gRGVmZXJzIGEgZnVuY3Rpb24sIHNjaGVkdWxpbmcgaXQgdG8gcnVuIGFmdGVyIHRoZSBjdXJyZW50IGNhbGwgc3RhY2sgaGFzCiAgLy8gY2xlYXJlZC4KICBfLmRlZmVyID0gZnVuY3Rpb24oZnVuYykgewogICAgcmV0dXJuIF8uZGVsYXkuYXBwbHkoXywgW2Z1bmMsIDFdLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpKTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIHdoZW4gaW52b2tlZCwgd2lsbCBvbmx5IGJlIHRyaWdnZXJlZCBhdCBtb3N0IG9uY2UKICAvLyBkdXJpbmcgYSBnaXZlbiB3aW5kb3cgb2YgdGltZS4gTm9ybWFsbHksIHRoZSB0aHJvdHRsZWQgZnVuY3Rpb24gd2lsbCBydW4KICAvLyBhcyBtdWNoIGFzIGl0IGNhbiwgd2l0aG91dCBldmVyIGdvaW5nIG1vcmUgdGhhbiBvbmNlIHBlciBgd2FpdGAgZHVyYXRpb247CiAgLy8gYnV0IGlmIHlvdSdkIGxpa2UgdG8gZGlzYWJsZSB0aGUgZXhlY3V0aW9uIG9uIHRoZSBsZWFkaW5nIGVkZ2UsIHBhc3MKICAvLyBge2xlYWRpbmc6IGZhbHNlfWAuIFRvIGRpc2FibGUgZXhlY3V0aW9uIG9uIHRoZSB0cmFpbGluZyBlZGdlLCBkaXR0by4KICBfLnRocm90dGxlID0gZnVuY3Rpb24oZnVuYywgd2FpdCwgb3B0aW9ucykgewogICAgdmFyIGNvbnRleHQsIGFyZ3MsIHJlc3VsdDsKICAgIHZhciB0aW1lb3V0ID0gbnVsbDsKICAgIHZhciBwcmV2aW91cyA9IDA7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgdmFyIGxhdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgIHByZXZpb3VzID0gb3B0aW9ucy5sZWFkaW5nID09PSBmYWxzZSA/IDAgOiBuZXcgRGF0ZTsKICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICB9OwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgbm93ID0gbmV3IERhdGU7CiAgICAgIGlmICghcHJldmlvdXMgJiYgb3B0aW9ucy5sZWFkaW5nID09PSBmYWxzZSkgcHJldmlvdXMgPSBub3c7CiAgICAgIHZhciByZW1haW5pbmcgPSB3YWl0IC0gKG5vdyAtIHByZXZpb3VzKTsKICAgICAgY29udGV4dCA9IHRoaXM7CiAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIGlmIChyZW1haW5pbmcgPD0gMCkgewogICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICBwcmV2aW91cyA9IG5vdzsKICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICB9IGVsc2UgaWYgKCF0aW1lb3V0ICYmIG9wdGlvbnMudHJhaWxpbmcgIT09IGZhbHNlKSB7CiAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHJlbWFpbmluZyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0LCBhcyBsb25nIGFzIGl0IGNvbnRpbnVlcyB0byBiZSBpbnZva2VkLCB3aWxsIG5vdAogIC8vIGJlIHRyaWdnZXJlZC4gVGhlIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIGFmdGVyIGl0IHN0b3BzIGJlaW5nIGNhbGxlZCBmb3IKICAvLyBOIG1pbGxpc2Vjb25kcy4gSWYgYGltbWVkaWF0ZWAgaXMgcGFzc2VkLCB0cmlnZ2VyIHRoZSBmdW5jdGlvbiBvbiB0aGUKICAvLyBsZWFkaW5nIGVkZ2UsIGluc3RlYWQgb2YgdGhlIHRyYWlsaW5nLgogIF8uZGVib3VuY2UgPSBmdW5jdGlvbihmdW5jLCB3YWl0LCBpbW1lZGlhdGUpIHsKICAgIHZhciB0aW1lb3V0LCBhcmdzLCBjb250ZXh0LCB0aW1lc3RhbXAsIHJlc3VsdDsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgY29udGV4dCA9IHRoaXM7CiAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIHRpbWVzdGFtcCA9IG5ldyBEYXRlKCk7CiAgICAgIHZhciBsYXRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBsYXN0ID0gKG5ldyBEYXRlKCkpIC0gdGltZXN0YW1wOwogICAgICAgIGlmIChsYXN0IDwgd2FpdCkgewogICAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQgLSBsYXN0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgICBpZiAoIWltbWVkaWF0ZSkgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIHZhciBjYWxsTm93ID0gaW1tZWRpYXRlICYmICF0aW1lb3V0OwogICAgICBpZiAoIXRpbWVvdXQpIHsKICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCk7CiAgICAgIH0KICAgICAgaWYgKGNhbGxOb3cpIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgZXhlY3V0ZWQgYXQgbW9zdCBvbmUgdGltZSwgbm8gbWF0dGVyIGhvdwogIC8vIG9mdGVuIHlvdSBjYWxsIGl0LiBVc2VmdWwgZm9yIGxhenkgaW5pdGlhbGl6YXRpb24uCiAgXy5vbmNlID0gZnVuY3Rpb24oZnVuYykgewogICAgdmFyIHJhbiA9IGZhbHNlLCBtZW1vOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBpZiAocmFuKSByZXR1cm4gbWVtbzsKICAgICAgcmFuID0gdHJ1ZTsKICAgICAgbWVtbyA9IGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgZnVuYyA9IG51bGw7CiAgICAgIHJldHVybiBtZW1vOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIHRoZSBmaXJzdCBmdW5jdGlvbiBwYXNzZWQgYXMgYW4gYXJndW1lbnQgdG8gdGhlIHNlY29uZCwKICAvLyBhbGxvd2luZyB5b3UgdG8gYWRqdXN0IGFyZ3VtZW50cywgcnVuIGNvZGUgYmVmb3JlIGFuZCBhZnRlciwgYW5kCiAgLy8gY29uZGl0aW9uYWxseSBleGVjdXRlIHRoZSBvcmlnaW5hbCBmdW5jdGlvbi4KICBfLndyYXAgPSBmdW5jdGlvbihmdW5jLCB3cmFwcGVyKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gW2Z1bmNdOwogICAgICBwdXNoLmFwcGx5KGFyZ3MsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiB3cmFwcGVyLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCBpcyB0aGUgY29tcG9zaXRpb24gb2YgYSBsaXN0IG9mIGZ1bmN0aW9ucywgZWFjaAogIC8vIGNvbnN1bWluZyB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBmdW5jdGlvbiB0aGF0IGZvbGxvd3MuCiAgXy5jb21wb3NlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgZnVuY3MgPSBhcmd1bWVudHM7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwogICAgICBmb3IgKHZhciBpID0gZnVuY3MubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICBhcmdzID0gW2Z1bmNzW2ldLmFwcGx5KHRoaXMsIGFyZ3MpXTsKICAgICAgfQogICAgICByZXR1cm4gYXJnc1swXTsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBvbmx5IGJlIGV4ZWN1dGVkIGFmdGVyIGJlaW5nIGNhbGxlZCBOIHRpbWVzLgogIF8uYWZ0ZXIgPSBmdW5jdGlvbih0aW1lcywgZnVuYykgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBpZiAoLS10aW1lcyA8IDEpIHsKICAgICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9OwogIH07CgogIC8vIE9iamVjdCBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJldHJpZXZlIHRoZSBuYW1lcyBvZiBhbiBvYmplY3QncyBwcm9wZXJ0aWVzLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBPYmplY3Qua2V5c2AKICBfLmtleXMgPSBuYXRpdmVLZXlzIHx8IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKG9iaiAhPT0gT2JqZWN0KG9iaikpIHRocm93IG5ldyBUeXBlRXJyb3IoJ0ludmFsaWQgb2JqZWN0Jyk7CiAgICB2YXIga2V5cyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkga2V5cy5wdXNoKGtleSk7CiAgICByZXR1cm4ga2V5czsKICB9OwoKICAvLyBSZXRyaWV2ZSB0aGUgdmFsdWVzIG9mIGFuIG9iamVjdCdzIHByb3BlcnRpZXMuCiAgXy52YWx1ZXMgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICB2YXIgbGVuZ3RoID0ga2V5cy5sZW5ndGg7CiAgICB2YXIgdmFsdWVzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHZhbHVlc1tpXSA9IG9ialtrZXlzW2ldXTsKICAgIH0KICAgIHJldHVybiB2YWx1ZXM7CiAgfTsKCiAgLy8gQ29udmVydCBhbiBvYmplY3QgaW50byBhIGxpc3Qgb2YgYFtrZXksIHZhbHVlXWAgcGFpcnMuCiAgXy5wYWlycyA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGtleXMgPSBfLmtleXMob2JqKTsKICAgIHZhciBsZW5ndGggPSBrZXlzLmxlbmd0aDsKICAgIHZhciBwYWlycyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBwYWlyc1tpXSA9IFtrZXlzW2ldLCBvYmpba2V5c1tpXV1dOwogICAgfQogICAgcmV0dXJuIHBhaXJzOwogIH07CgogIC8vIEludmVydCB0aGUga2V5cyBhbmQgdmFsdWVzIG9mIGFuIG9iamVjdC4gVGhlIHZhbHVlcyBtdXN0IGJlIHNlcmlhbGl6YWJsZS4KICBfLmludmVydCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgdmFyIGtleXMgPSBfLmtleXMob2JqKTsKICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBrZXlzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHJlc3VsdFtvYmpba2V5c1tpXV1dID0ga2V5c1tpXTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gUmV0dXJuIGEgc29ydGVkIGxpc3Qgb2YgdGhlIGZ1bmN0aW9uIG5hbWVzIGF2YWlsYWJsZSBvbiB0aGUgb2JqZWN0LgogIC8vIEFsaWFzZWQgYXMgYG1ldGhvZHNgCiAgXy5mdW5jdGlvbnMgPSBfLm1ldGhvZHMgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBuYW1lcyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAoXy5pc0Z1bmN0aW9uKG9ialtrZXldKSkgbmFtZXMucHVzaChrZXkpOwogICAgfQogICAgcmV0dXJuIG5hbWVzLnNvcnQoKTsKICB9OwoKICAvLyBFeHRlbmQgYSBnaXZlbiBvYmplY3Qgd2l0aCBhbGwgdGhlIHByb3BlcnRpZXMgaW4gcGFzc2VkLWluIG9iamVjdChzKS4KICBfLmV4dGVuZCA9IGZ1bmN0aW9uKG9iaikgewogICAgZWFjaChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICAgIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBvYmplY3Qgb25seSBjb250YWluaW5nIHRoZSB3aGl0ZWxpc3RlZCBwcm9wZXJ0aWVzLgogIF8ucGljayA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGNvcHkgPSB7fTsKICAgIHZhciBrZXlzID0gY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBlYWNoKGtleXMsIGZ1bmN0aW9uKGtleSkgewogICAgICBpZiAoa2V5IGluIG9iaikgY29weVtrZXldID0gb2JqW2tleV07CiAgICB9KTsKICAgIHJldHVybiBjb3B5OwogIH07CgogICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBvYmplY3Qgd2l0aG91dCB0aGUgYmxhY2tsaXN0ZWQgcHJvcGVydGllcy4KICBfLm9taXQgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBjb3B5ID0ge307CiAgICB2YXIga2V5cyA9IGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAoIV8uY29udGFpbnMoa2V5cywga2V5KSkgY29weVtrZXldID0gb2JqW2tleV07CiAgICB9CiAgICByZXR1cm4gY29weTsKICB9OwoKICAvLyBGaWxsIGluIGEgZ2l2ZW4gb2JqZWN0IHdpdGggZGVmYXVsdCBwcm9wZXJ0aWVzLgogIF8uZGVmYXVsdHMgPSBmdW5jdGlvbihvYmopIHsKICAgIGVhY2goc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLCBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgIGZvciAodmFyIHByb3AgaW4gc291cmNlKSB7CiAgICAgICAgICBpZiAob2JqW3Byb3BdID09PSB2b2lkIDApIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBDcmVhdGUgYSAoc2hhbGxvdy1jbG9uZWQpIGR1cGxpY2F0ZSBvZiBhbiBvYmplY3QuCiAgXy5jbG9uZSA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCFfLmlzT2JqZWN0KG9iaikpIHJldHVybiBvYmo7CiAgICByZXR1cm4gXy5pc0FycmF5KG9iaikgPyBvYmouc2xpY2UoKSA6IF8uZXh0ZW5kKHt9LCBvYmopOwogIH07CgogIC8vIEludm9rZXMgaW50ZXJjZXB0b3Igd2l0aCB0aGUgb2JqLCBhbmQgdGhlbiByZXR1cm5zIG9iai4KICAvLyBUaGUgcHJpbWFyeSBwdXJwb3NlIG9mIHRoaXMgbWV0aG9kIGlzIHRvICJ0YXAgaW50byIgYSBtZXRob2QgY2hhaW4sIGluCiAgLy8gb3JkZXIgdG8gcGVyZm9ybSBvcGVyYXRpb25zIG9uIGludGVybWVkaWF0ZSByZXN1bHRzIHdpdGhpbiB0aGUgY2hhaW4uCiAgXy50YXAgPSBmdW5jdGlvbihvYmosIGludGVyY2VwdG9yKSB7CiAgICBpbnRlcmNlcHRvcihvYmopOwogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBJbnRlcm5hbCByZWN1cnNpdmUgY29tcGFyaXNvbiBmdW5jdGlvbiBmb3IgYGlzRXF1YWxgLgogIHZhciBlcSA9IGZ1bmN0aW9uKGEsIGIsIGFTdGFjaywgYlN0YWNrKSB7CiAgICAvLyBJZGVudGljYWwgb2JqZWN0cyBhcmUgZXF1YWwuIGAwID09PSAtMGAsIGJ1dCB0aGV5IGFyZW4ndCBpZGVudGljYWwuCiAgICAvLyBTZWUgdGhlIFtIYXJtb255IGBlZ2FsYCBwcm9wb3NhbF0oaHR0cDovL3dpa2kuZWNtYXNjcmlwdC5vcmcvZG9rdS5waHA/aWQ9aGFybW9ueTplZ2FsKS4KICAgIGlmIChhID09PSBiKSByZXR1cm4gYSAhPT0gMCB8fCAxIC8gYSA9PSAxIC8gYjsKICAgIC8vIEEgc3RyaWN0IGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5IGJlY2F1c2UgYG51bGwgPT0gdW5kZWZpbmVkYC4KICAgIGlmIChhID09IG51bGwgfHwgYiA9PSBudWxsKSByZXR1cm4gYSA9PT0gYjsKICAgIC8vIFVud3JhcCBhbnkgd3JhcHBlZCBvYmplY3RzLgogICAgaWYgKGEgaW5zdGFuY2VvZiBfKSBhID0gYS5fd3JhcHBlZDsKICAgIGlmIChiIGluc3RhbmNlb2YgXykgYiA9IGIuX3dyYXBwZWQ7CiAgICAvLyBDb21wYXJlIGBbW0NsYXNzXV1gIG5hbWVzLgogICAgdmFyIGNsYXNzTmFtZSA9IHRvU3RyaW5nLmNhbGwoYSk7CiAgICBpZiAoY2xhc3NOYW1lICE9IHRvU3RyaW5nLmNhbGwoYikpIHJldHVybiBmYWxzZTsKICAgIHN3aXRjaCAoY2xhc3NOYW1lKSB7CiAgICAgIC8vIFN0cmluZ3MsIG51bWJlcnMsIGRhdGVzLCBhbmQgYm9vbGVhbnMgYXJlIGNvbXBhcmVkIGJ5IHZhbHVlLgogICAgICBjYXNlICdbb2JqZWN0IFN0cmluZ10nOgogICAgICAgIC8vIFByaW1pdGl2ZXMgYW5kIHRoZWlyIGNvcnJlc3BvbmRpbmcgb2JqZWN0IHdyYXBwZXJzIGFyZSBlcXVpdmFsZW50OyB0aHVzLCBgIjUiYCBpcwogICAgICAgIC8vIGVxdWl2YWxlbnQgdG8gYG5ldyBTdHJpbmcoIjUiKWAuCiAgICAgICAgcmV0dXJuIGEgPT0gU3RyaW5nKGIpOwogICAgICBjYXNlICdbb2JqZWN0IE51bWJlcl0nOgogICAgICAgIC8vIGBOYU5gcyBhcmUgZXF1aXZhbGVudCwgYnV0IG5vbi1yZWZsZXhpdmUuIEFuIGBlZ2FsYCBjb21wYXJpc29uIGlzIHBlcmZvcm1lZCBmb3IKICAgICAgICAvLyBvdGhlciBudW1lcmljIHZhbHVlcy4KICAgICAgICByZXR1cm4gYSAhPSArYSA/IGIgIT0gK2IgOiAoYSA9PSAwID8gMSAvIGEgPT0gMSAvIGIgOiBhID09ICtiKTsKICAgICAgY2FzZSAnW29iamVjdCBEYXRlXSc6CiAgICAgIGNhc2UgJ1tvYmplY3QgQm9vbGVhbl0nOgogICAgICAgIC8vIENvZXJjZSBkYXRlcyBhbmQgYm9vbGVhbnMgdG8gbnVtZXJpYyBwcmltaXRpdmUgdmFsdWVzLiBEYXRlcyBhcmUgY29tcGFyZWQgYnkgdGhlaXIKICAgICAgICAvLyBtaWxsaXNlY29uZCByZXByZXNlbnRhdGlvbnMuIE5vdGUgdGhhdCBpbnZhbGlkIGRhdGVzIHdpdGggbWlsbGlzZWNvbmQgcmVwcmVzZW50YXRpb25zCiAgICAgICAgLy8gb2YgYE5hTmAgYXJlIG5vdCBlcXVpdmFsZW50LgogICAgICAgIHJldHVybiArYSA9PSArYjsKICAgICAgLy8gUmVnRXhwcyBhcmUgY29tcGFyZWQgYnkgdGhlaXIgc291cmNlIHBhdHRlcm5zIGFuZCBmbGFncy4KICAgICAgY2FzZSAnW29iamVjdCBSZWdFeHBdJzoKICAgICAgICByZXR1cm4gYS5zb3VyY2UgPT0gYi5zb3VyY2UgJiYKICAgICAgICAgICAgICAgYS5nbG9iYWwgPT0gYi5nbG9iYWwgJiYKICAgICAgICAgICAgICAgYS5tdWx0aWxpbmUgPT0gYi5tdWx0aWxpbmUgJiYKICAgICAgICAgICAgICAgYS5pZ25vcmVDYXNlID09IGIuaWdub3JlQ2FzZTsKICAgIH0KICAgIGlmICh0eXBlb2YgYSAhPSAnb2JqZWN0JyB8fCB0eXBlb2YgYiAhPSAnb2JqZWN0JykgcmV0dXJuIGZhbHNlOwogICAgLy8gQXNzdW1lIGVxdWFsaXR5IGZvciBjeWNsaWMgc3RydWN0dXJlcy4gVGhlIGFsZ29yaXRobSBmb3IgZGV0ZWN0aW5nIGN5Y2xpYwogICAgLy8gc3RydWN0dXJlcyBpcyBhZGFwdGVkIGZyb20gRVMgNS4xIHNlY3Rpb24gMTUuMTIuMywgYWJzdHJhY3Qgb3BlcmF0aW9uIGBKT2AuCiAgICB2YXIgbGVuZ3RoID0gYVN0YWNrLmxlbmd0aDsKICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAvLyBMaW5lYXIgc2VhcmNoLiBQZXJmb3JtYW5jZSBpcyBpbnZlcnNlbHkgcHJvcG9ydGlvbmFsIHRvIHRoZSBudW1iZXIgb2YKICAgICAgLy8gdW5pcXVlIG5lc3RlZCBzdHJ1Y3R1cmVzLgogICAgICBpZiAoYVN0YWNrW2xlbmd0aF0gPT0gYSkgcmV0dXJuIGJTdGFja1tsZW5ndGhdID09IGI7CiAgICB9CiAgICAvLyBPYmplY3RzIHdpdGggZGlmZmVyZW50IGNvbnN0cnVjdG9ycyBhcmUgbm90IGVxdWl2YWxlbnQsIGJ1dCBgT2JqZWN0YHMKICAgIC8vIGZyb20gZGlmZmVyZW50IGZyYW1lcyBhcmUuCiAgICB2YXIgYUN0b3IgPSBhLmNvbnN0cnVjdG9yLCBiQ3RvciA9IGIuY29uc3RydWN0b3I7CiAgICBpZiAoYUN0b3IgIT09IGJDdG9yICYmICEoXy5pc0Z1bmN0aW9uKGFDdG9yKSAmJiAoYUN0b3IgaW5zdGFuY2VvZiBhQ3RvcikgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLmlzRnVuY3Rpb24oYkN0b3IpICYmIChiQ3RvciBpbnN0YW5jZW9mIGJDdG9yKSkpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgLy8gQWRkIHRoZSBmaXJzdCBvYmplY3QgdG8gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgogICAgYVN0YWNrLnB1c2goYSk7CiAgICBiU3RhY2sucHVzaChiKTsKICAgIHZhciBzaXplID0gMCwgcmVzdWx0ID0gdHJ1ZTsKICAgIC8vIFJlY3Vyc2l2ZWx5IGNvbXBhcmUgb2JqZWN0cyBhbmQgYXJyYXlzLgogICAgaWYgKGNsYXNzTmFtZSA9PSAnW29iamVjdCBBcnJheV0nKSB7CiAgICAgIC8vIENvbXBhcmUgYXJyYXkgbGVuZ3RocyB0byBkZXRlcm1pbmUgaWYgYSBkZWVwIGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5LgogICAgICBzaXplID0gYS5sZW5ndGg7CiAgICAgIHJlc3VsdCA9IHNpemUgPT0gYi5sZW5ndGg7CiAgICAgIGlmIChyZXN1bHQpIHsKICAgICAgICAvLyBEZWVwIGNvbXBhcmUgdGhlIGNvbnRlbnRzLCBpZ25vcmluZyBub24tbnVtZXJpYyBwcm9wZXJ0aWVzLgogICAgICAgIHdoaWxlIChzaXplLS0pIHsKICAgICAgICAgIGlmICghKHJlc3VsdCA9IGVxKGFbc2l6ZV0sIGJbc2l6ZV0sIGFTdGFjaywgYlN0YWNrKSkpIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gRGVlcCBjb21wYXJlIG9iamVjdHMuCiAgICAgIGZvciAodmFyIGtleSBpbiBhKSB7CiAgICAgICAgaWYgKF8uaGFzKGEsIGtleSkpIHsKICAgICAgICAgIC8vIENvdW50IHRoZSBleHBlY3RlZCBudW1iZXIgb2YgcHJvcGVydGllcy4KICAgICAgICAgIHNpemUrKzsKICAgICAgICAgIC8vIERlZXAgY29tcGFyZSBlYWNoIG1lbWJlci4KICAgICAgICAgIGlmICghKHJlc3VsdCA9IF8uaGFzKGIsIGtleSkgJiYgZXEoYVtrZXldLCBiW2tleV0sIGFTdGFjaywgYlN0YWNrKSkpIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBFbnN1cmUgdGhhdCBib3RoIG9iamVjdHMgY29udGFpbiB0aGUgc2FtZSBudW1iZXIgb2YgcHJvcGVydGllcy4KICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIGZvciAoa2V5IGluIGIpIHsKICAgICAgICAgIGlmIChfLmhhcyhiLCBrZXkpICYmICEoc2l6ZS0tKSkgYnJlYWs7CiAgICAgICAgfQogICAgICAgIHJlc3VsdCA9ICFzaXplOwogICAgICB9CiAgICB9CiAgICAvLyBSZW1vdmUgdGhlIGZpcnN0IG9iamVjdCBmcm9tIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cy4KICAgIGFTdGFjay5wb3AoKTsKICAgIGJTdGFjay5wb3AoKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gUGVyZm9ybSBhIGRlZXAgY29tcGFyaXNvbiB0byBjaGVjayBpZiB0d28gb2JqZWN0cyBhcmUgZXF1YWwuCiAgXy5pc0VxdWFsID0gZnVuY3Rpb24oYSwgYikgewogICAgcmV0dXJuIGVxKGEsIGIsIFtdLCBbXSk7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiBhcnJheSwgc3RyaW5nLCBvciBvYmplY3QgZW1wdHk/CiAgLy8gQW4gImVtcHR5IiBvYmplY3QgaGFzIG5vIGVudW1lcmFibGUgb3duLXByb3BlcnRpZXMuCiAgXy5pc0VtcHR5ID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiB0cnVlOwogICAgaWYgKF8uaXNBcnJheShvYmopIHx8IF8uaXNTdHJpbmcob2JqKSkgcmV0dXJuIG9iai5sZW5ndGggPT09IDA7CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSByZXR1cm4gZmFsc2U7CiAgICByZXR1cm4gdHJ1ZTsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhbHVlIGEgRE9NIGVsZW1lbnQ/CiAgXy5pc0VsZW1lbnQgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiAhIShvYmogJiYgb2JqLm5vZGVUeXBlID09PSAxKTsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhbHVlIGFuIGFycmF5PwogIC8vIERlbGVnYXRlcyB0byBFQ01BNSdzIG5hdGl2ZSBBcnJheS5pc0FycmF5CiAgXy5pc0FycmF5ID0gbmF0aXZlSXNBcnJheSB8fCBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiB0b1N0cmluZy5jYWxsKG9iaikgPT0gJ1tvYmplY3QgQXJyYXldJzsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhcmlhYmxlIGFuIG9iamVjdD8KICBfLmlzT2JqZWN0ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSBPYmplY3Qob2JqKTsKICB9OwoKICAvLyBBZGQgc29tZSBpc1R5cGUgbWV0aG9kczogaXNBcmd1bWVudHMsIGlzRnVuY3Rpb24sIGlzU3RyaW5nLCBpc051bWJlciwgaXNEYXRlLCBpc1JlZ0V4cC4KICBlYWNoKFsnQXJndW1lbnRzJywgJ0Z1bmN0aW9uJywgJ1N0cmluZycsICdOdW1iZXInLCAnRGF0ZScsICdSZWdFeHAnXSwgZnVuY3Rpb24obmFtZSkgewogICAgX1snaXMnICsgbmFtZV0gPSBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PSAnW29iamVjdCAnICsgbmFtZSArICddJzsKICAgIH07CiAgfSk7CgogIC8vIERlZmluZSBhIGZhbGxiYWNrIHZlcnNpb24gb2YgdGhlIG1ldGhvZCBpbiBicm93c2VycyAoYWhlbSwgSUUpLCB3aGVyZQogIC8vIHRoZXJlIGlzbid0IGFueSBpbnNwZWN0YWJsZSAiQXJndW1lbnRzIiB0eXBlLgogIGlmICghXy5pc0FyZ3VtZW50cyhhcmd1bWVudHMpKSB7CiAgICBfLmlzQXJndW1lbnRzID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgIHJldHVybiAhIShvYmogJiYgXy5oYXMob2JqLCAnY2FsbGVlJykpOwogICAgfTsKICB9CgogIC8vIE9wdGltaXplIGBpc0Z1bmN0aW9uYCBpZiBhcHByb3ByaWF0ZS4KICBpZiAodHlwZW9mICgvLi8pICE9PSAnZnVuY3Rpb24nKSB7CiAgICBfLmlzRnVuY3Rpb24gPSBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbic7CiAgICB9OwogIH0KCiAgLy8gSXMgYSBnaXZlbiBvYmplY3QgYSBmaW5pdGUgbnVtYmVyPwogIF8uaXNGaW5pdGUgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBpc0Zpbml0ZShvYmopICYmICFpc05hTihwYXJzZUZsb2F0KG9iaikpOwogIH07CgogIC8vIElzIHRoZSBnaXZlbiB2YWx1ZSBgTmFOYD8gKE5hTiBpcyB0aGUgb25seSBudW1iZXIgd2hpY2ggZG9lcyBub3QgZXF1YWwgaXRzZWxmKS4KICBfLmlzTmFOID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXy5pc051bWJlcihvYmopICYmIG9iaiAhPSArb2JqOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBib29sZWFuPwogIF8uaXNCb29sZWFuID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSB0cnVlIHx8IG9iaiA9PT0gZmFsc2UgfHwgdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0IEJvb2xlYW5dJzsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhbHVlIGVxdWFsIHRvIG51bGw/CiAgXy5pc051bGwgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IG51bGw7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YXJpYWJsZSB1bmRlZmluZWQ/CiAgXy5pc1VuZGVmaW5lZCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gdm9pZCAwOwogIH07CgogIC8vIFNob3J0Y3V0IGZ1bmN0aW9uIGZvciBjaGVja2luZyBpZiBhbiBvYmplY3QgaGFzIGEgZ2l2ZW4gcHJvcGVydHkgZGlyZWN0bHkKICAvLyBvbiBpdHNlbGYgKGluIG90aGVyIHdvcmRzLCBub3Qgb24gYSBwcm90b3R5cGUpLgogIF8uaGFzID0gZnVuY3Rpb24ob2JqLCBrZXkpIHsKICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KTsKICB9OwoKICAvLyBVdGlsaXR5IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJ1biBVbmRlcnNjb3JlLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBfYCB2YXJpYWJsZSB0byBpdHMKICAvLyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QuCiAgXy5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CiAgICByb290Ll8gPSBwcmV2aW91c1VuZGVyc2NvcmU7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBLZWVwIHRoZSBpZGVudGl0eSBmdW5jdGlvbiBhcm91bmQgZm9yIGRlZmF1bHQgaXRlcmF0b3JzLgogIF8uaWRlbnRpdHkgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlOwogIH07CgogIC8vIFJ1biBhIGZ1bmN0aW9uICoqbioqIHRpbWVzLgogIF8udGltZXMgPSBmdW5jdGlvbihuLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIGFjY3VtID0gQXJyYXkoTWF0aC5tYXgoMCwgbikpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuOyBpKyspIGFjY3VtW2ldID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBpKTsKICAgIHJldHVybiBhY2N1bTsKICB9OwoKICAvLyBSZXR1cm4gYSByYW5kb20gaW50ZWdlciBiZXR3ZWVuIG1pbiBhbmQgbWF4IChpbmNsdXNpdmUpLgogIF8ucmFuZG9tID0gZnVuY3Rpb24obWluLCBtYXgpIHsKICAgIGlmIChtYXggPT0gbnVsbCkgewogICAgICBtYXggPSBtaW47CiAgICAgIG1pbiA9IDA7CiAgICB9CiAgICByZXR1cm4gbWluICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKG1heCAtIG1pbiArIDEpKTsKICB9OwoKICAvLyBMaXN0IG9mIEhUTUwgZW50aXRpZXMgZm9yIGVzY2FwaW5nLgogIHZhciBlbnRpdHlNYXAgPSB7CiAgICBlc2NhcGU6IHsKICAgICAgJyYnOiAnJmFtcDsnLAogICAgICAnPCc6ICcmbHQ7JywKICAgICAgJz4nOiAnJmd0OycsCiAgICAgICciJzogJyZxdW90OycsCiAgICAgICInIjogJyYjeDI3OycKICAgIH0KICB9OwogIGVudGl0eU1hcC51bmVzY2FwZSA9IF8uaW52ZXJ0KGVudGl0eU1hcC5lc2NhcGUpOwoKICAvLyBSZWdleGVzIGNvbnRhaW5pbmcgdGhlIGtleXMgYW5kIHZhbHVlcyBsaXN0ZWQgaW1tZWRpYXRlbHkgYWJvdmUuCiAgdmFyIGVudGl0eVJlZ2V4ZXMgPSB7CiAgICBlc2NhcGU6ICAgbmV3IFJlZ0V4cCgnWycgKyBfLmtleXMoZW50aXR5TWFwLmVzY2FwZSkuam9pbignJykgKyAnXScsICdnJyksCiAgICB1bmVzY2FwZTogbmV3IFJlZ0V4cCgnKCcgKyBfLmtleXMoZW50aXR5TWFwLnVuZXNjYXBlKS5qb2luKCd8JykgKyAnKScsICdnJykKICB9OwoKICAvLyBGdW5jdGlvbnMgZm9yIGVzY2FwaW5nIGFuZCB1bmVzY2FwaW5nIHN0cmluZ3MgdG8vZnJvbSBIVE1MIGludGVycG9sYXRpb24uCiAgXy5lYWNoKFsnZXNjYXBlJywgJ3VuZXNjYXBlJ10sIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgX1ttZXRob2RdID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgIGlmIChzdHJpbmcgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICByZXR1cm4gKCcnICsgc3RyaW5nKS5yZXBsYWNlKGVudGl0eVJlZ2V4ZXNbbWV0aG9kXSwgZnVuY3Rpb24obWF0Y2gpIHsKICAgICAgICByZXR1cm4gZW50aXR5TWFwW21ldGhvZF1bbWF0Y2hdOwogICAgICB9KTsKICAgIH07CiAgfSk7CgogIC8vIElmIHRoZSB2YWx1ZSBvZiB0aGUgbmFtZWQgYHByb3BlcnR5YCBpcyBhIGZ1bmN0aW9uIHRoZW4gaW52b2tlIGl0IHdpdGggdGhlCiAgLy8gYG9iamVjdGAgYXMgY29udGV4dDsgb3RoZXJ3aXNlLCByZXR1cm4gaXQuCiAgXy5yZXN1bHQgPSBmdW5jdGlvbihvYmplY3QsIHByb3BlcnR5KSB7CiAgICBpZiAob2JqZWN0ID09IG51bGwpIHJldHVybiB2b2lkIDA7CiAgICB2YXIgdmFsdWUgPSBvYmplY3RbcHJvcGVydHldOwogICAgcmV0dXJuIF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZS5jYWxsKG9iamVjdCkgOiB2YWx1ZTsKICB9OwoKICAvLyBBZGQgeW91ciBvd24gY3VzdG9tIGZ1bmN0aW9ucyB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QuCiAgXy5taXhpbiA9IGZ1bmN0aW9uKG9iaikgewogICAgZWFjaChfLmZ1bmN0aW9ucyhvYmopLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHZhciBmdW5jID0gX1tuYW1lXSA9IG9ialtuYW1lXTsKICAgICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYXJncyA9IFt0aGlzLl93cmFwcGVkXTsKICAgICAgICBwdXNoLmFwcGx5KGFyZ3MsIGFyZ3VtZW50cyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIGZ1bmMuYXBwbHkoXywgYXJncykpOwogICAgICB9OwogICAgfSk7CiAgfTsKCiAgLy8gR2VuZXJhdGUgYSB1bmlxdWUgaW50ZWdlciBpZCAodW5pcXVlIHdpdGhpbiB0aGUgZW50aXJlIGNsaWVudCBzZXNzaW9uKS4KICAvLyBVc2VmdWwgZm9yIHRlbXBvcmFyeSBET00gaWRzLgogIHZhciBpZENvdW50ZXIgPSAwOwogIF8udW5pcXVlSWQgPSBmdW5jdGlvbihwcmVmaXgpIHsKICAgIHZhciBpZCA9ICsraWRDb3VudGVyICsgJyc7CiAgICByZXR1cm4gcHJlZml4ID8gcHJlZml4ICsgaWQgOiBpZDsKICB9OwoKICAvLyBCeSBkZWZhdWx0LCBVbmRlcnNjb3JlIHVzZXMgRVJCLXN0eWxlIHRlbXBsYXRlIGRlbGltaXRlcnMsIGNoYW5nZSB0aGUKICAvLyBmb2xsb3dpbmcgdGVtcGxhdGUgc2V0dGluZ3MgdG8gdXNlIGFsdGVybmF0aXZlIGRlbGltaXRlcnMuCiAgXy50ZW1wbGF0ZVNldHRpbmdzID0gewogICAgZXZhbHVhdGUgICAgOiAvPCUoW1xzXFNdKz8pJT4vZywKICAgIGludGVycG9sYXRlIDogLzwlPShbXHNcU10rPyklPi9nLAogICAgZXNjYXBlICAgICAgOiAvPCUtKFtcc1xTXSs/KSU+L2cKICB9OwoKICAvLyBXaGVuIGN1c3RvbWl6aW5nIGB0ZW1wbGF0ZVNldHRpbmdzYCwgaWYgeW91IGRvbid0IHdhbnQgdG8gZGVmaW5lIGFuCiAgLy8gaW50ZXJwb2xhdGlvbiwgZXZhbHVhdGlvbiBvciBlc2NhcGluZyByZWdleCwgd2UgbmVlZCBvbmUgdGhhdCBpcwogIC8vIGd1YXJhbnRlZWQgbm90IHRvIG1hdGNoLgogIHZhciBub01hdGNoID0gLyguKV4vOwoKICAvLyBDZXJ0YWluIGNoYXJhY3RlcnMgbmVlZCB0byBiZSBlc2NhcGVkIHNvIHRoYXQgdGhleSBjYW4gYmUgcHV0IGludG8gYQogIC8vIHN0cmluZyBsaXRlcmFsLgogIHZhciBlc2NhcGVzID0gewogICAgIiciOiAgICAgICInIiwKICAgICdcXCc6ICAgICAnXFwnLAogICAgJ1xyJzogICAgICdyJywKICAgICdcbic6ICAgICAnbicsCiAgICAnXHQnOiAgICAgJ3QnLAogICAgJ1x1MjAyOCc6ICd1MjAyOCcsCiAgICAnXHUyMDI5JzogJ3UyMDI5JwogIH07CgogIHZhciBlc2NhcGVyID0gL1xcfCd8XHJ8XG58XHR8XHUyMDI4fFx1MjAyOS9nOwoKICAvLyBKYXZhU2NyaXB0IG1pY3JvLXRlbXBsYXRpbmcsIHNpbWlsYXIgdG8gSm9obiBSZXNpZydzIGltcGxlbWVudGF0aW9uLgogIC8vIFVuZGVyc2NvcmUgdGVtcGxhdGluZyBoYW5kbGVzIGFyYml0cmFyeSBkZWxpbWl0ZXJzLCBwcmVzZXJ2ZXMgd2hpdGVzcGFjZSwKICAvLyBhbmQgY29ycmVjdGx5IGVzY2FwZXMgcXVvdGVzIHdpdGhpbiBpbnRlcnBvbGF0ZWQgY29kZS4KICBfLnRlbXBsYXRlID0gZnVuY3Rpb24odGV4dCwgZGF0YSwgc2V0dGluZ3MpIHsKICAgIHZhciByZW5kZXI7CiAgICBzZXR0aW5ncyA9IF8uZGVmYXVsdHMoe30sIHNldHRpbmdzLCBfLnRlbXBsYXRlU2V0dGluZ3MpOwoKICAgIC8vIENvbWJpbmUgZGVsaW1pdGVycyBpbnRvIG9uZSByZWd1bGFyIGV4cHJlc3Npb24gdmlhIGFsdGVybmF0aW9uLgogICAgdmFyIG1hdGNoZXIgPSBuZXcgUmVnRXhwKFsKICAgICAgKHNldHRpbmdzLmVzY2FwZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5pbnRlcnBvbGF0ZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5ldmFsdWF0ZSB8fCBub01hdGNoKS5zb3VyY2UKICAgIF0uam9pbignfCcpICsgJ3wkJywgJ2cnKTsKCiAgICAvLyBDb21waWxlIHRoZSB0ZW1wbGF0ZSBzb3VyY2UsIGVzY2FwaW5nIHN0cmluZyBsaXRlcmFscyBhcHByb3ByaWF0ZWx5LgogICAgdmFyIGluZGV4ID0gMDsKICAgIHZhciBzb3VyY2UgPSAiX19wKz0nIjsKICAgIHRleHQucmVwbGFjZShtYXRjaGVyLCBmdW5jdGlvbihtYXRjaCwgZXNjYXBlLCBpbnRlcnBvbGF0ZSwgZXZhbHVhdGUsIG9mZnNldCkgewogICAgICBzb3VyY2UgKz0gdGV4dC5zbGljZShpbmRleCwgb2Zmc2V0KQogICAgICAgIC5yZXBsYWNlKGVzY2FwZXIsIGZ1bmN0aW9uKG1hdGNoKSB7IHJldHVybiAnXFwnICsgZXNjYXBlc1ttYXRjaF07IH0pOwoKICAgICAgaWYgKGVzY2FwZSkgewogICAgICAgIHNvdXJjZSArPSAiJytcbigoX190PSgiICsgZXNjYXBlICsgIikpPT1udWxsPycnOl8uZXNjYXBlKF9fdCkpK1xuJyI7CiAgICAgIH0KICAgICAgaWYgKGludGVycG9sYXRlKSB7CiAgICAgICAgc291cmNlICs9ICInK1xuKChfX3Q9KCIgKyBpbnRlcnBvbGF0ZSArICIpKT09bnVsbD8nJzpfX3QpK1xuJyI7CiAgICAgIH0KICAgICAgaWYgKGV2YWx1YXRlKSB7CiAgICAgICAgc291cmNlICs9ICInO1xuIiArIGV2YWx1YXRlICsgIlxuX19wKz0nIjsKICAgICAgfQogICAgICBpbmRleCA9IG9mZnNldCArIG1hdGNoLmxlbmd0aDsKICAgICAgcmV0dXJuIG1hdGNoOwogICAgfSk7CiAgICBzb3VyY2UgKz0gIic7XG4iOwoKICAgIC8vIElmIGEgdmFyaWFibGUgaXMgbm90IHNwZWNpZmllZCwgcGxhY2UgZGF0YSB2YWx1ZXMgaW4gbG9jYWwgc2NvcGUuCiAgICBpZiAoIXNldHRpbmdzLnZhcmlhYmxlKSBzb3VyY2UgPSAnd2l0aChvYmp8fHt9KXtcbicgKyBzb3VyY2UgKyAnfVxuJzsKCiAgICBzb3VyY2UgPSAidmFyIF9fdCxfX3A9JycsX19qPUFycmF5LnByb3RvdHlwZS5qb2luLCIgKwogICAgICAicHJpbnQ9ZnVuY3Rpb24oKXtfX3ArPV9fai5jYWxsKGFyZ3VtZW50cywnJyk7fTtcbiIgKwogICAgICBzb3VyY2UgKyAicmV0dXJuIF9fcDtcbiI7CgogICAgdHJ5IHsKICAgICAgcmVuZGVyID0gbmV3IEZ1bmN0aW9uKHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonLCAnXycsIHNvdXJjZSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGUuc291cmNlID0gc291cmNlOwogICAgICB0aHJvdyBlOwogICAgfQoKICAgIGlmIChkYXRhKSByZXR1cm4gcmVuZGVyKGRhdGEsIF8pOwogICAgdmFyIHRlbXBsYXRlID0gZnVuY3Rpb24oZGF0YSkgewogICAgICByZXR1cm4gcmVuZGVyLmNhbGwodGhpcywgZGF0YSwgXyk7CiAgICB9OwoKICAgIC8vIFByb3ZpZGUgdGhlIGNvbXBpbGVkIGZ1bmN0aW9uIHNvdXJjZSBhcyBhIGNvbnZlbmllbmNlIGZvciBwcmVjb21waWxhdGlvbi4KICAgIHRlbXBsYXRlLnNvdXJjZSA9ICdmdW5jdGlvbignICsgKHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonKSArICcpe1xuJyArIHNvdXJjZSArICd9JzsKCiAgICByZXR1cm4gdGVtcGxhdGU7CiAgfTsKCiAgLy8gQWRkIGEgImNoYWluIiBmdW5jdGlvbiwgd2hpY2ggd2lsbCBkZWxlZ2F0ZSB0byB0aGUgd3JhcHBlci4KICBfLmNoYWluID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXyhvYmopLmNoYWluKCk7CiAgfTsKCiAgLy8gT09QCiAgLy8gLS0tLS0tLS0tLS0tLS0tCiAgLy8gSWYgVW5kZXJzY29yZSBpcyBjYWxsZWQgYXMgYSBmdW5jdGlvbiwgaXQgcmV0dXJucyBhIHdyYXBwZWQgb2JqZWN0IHRoYXQKICAvLyBjYW4gYmUgdXNlZCBPTy1zdHlsZS4gVGhpcyB3cmFwcGVyIGhvbGRzIGFsdGVyZWQgdmVyc2lvbnMgb2YgYWxsIHRoZQogIC8vIHVuZGVyc2NvcmUgZnVuY3Rpb25zLiBXcmFwcGVkIG9iamVjdHMgbWF5IGJlIGNoYWluZWQuCgogIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb250aW51ZSBjaGFpbmluZyBpbnRlcm1lZGlhdGUgcmVzdWx0cy4KICB2YXIgcmVzdWx0ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gdGhpcy5fY2hhaW4gPyBfKG9iaikuY2hhaW4oKSA6IG9iajsKICB9OwoKICAvLyBBZGQgYWxsIG9mIHRoZSBVbmRlcnNjb3JlIGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlciBvYmplY3QuCiAgXy5taXhpbihfKTsKCiAgLy8gQWRkIGFsbCBtdXRhdG9yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KICBlYWNoKFsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0J10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIHZhciBtZXRob2QgPSBBcnJheVByb3RvW25hbWVdOwogICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIG9iaiA9IHRoaXMuX3dyYXBwZWQ7CiAgICAgIG1ldGhvZC5hcHBseShvYmosIGFyZ3VtZW50cyk7CiAgICAgIGlmICgobmFtZSA9PSAnc2hpZnQnIHx8IG5hbWUgPT0gJ3NwbGljZScpICYmIG9iai5sZW5ndGggPT09IDApIGRlbGV0ZSBvYmpbMF07CiAgICAgIHJldHVybiByZXN1bHQuY2FsbCh0aGlzLCBvYmopOwogICAgfTsKICB9KTsKCiAgLy8gQWRkIGFsbCBhY2Nlc3NvciBBcnJheSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIuCiAgZWFjaChbJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIHZhciBtZXRob2QgPSBBcnJheVByb3RvW25hbWVdOwogICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIG1ldGhvZC5hcHBseSh0aGlzLl93cmFwcGVkLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfSk7CgogIF8uZXh0ZW5kKF8ucHJvdG90eXBlLCB7CgogICAgLy8gU3RhcnQgY2hhaW5pbmcgYSB3cmFwcGVkIFVuZGVyc2NvcmUgb2JqZWN0LgogICAgY2hhaW46IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLl9jaGFpbiA9IHRydWU7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBFeHRyYWN0cyB0aGUgcmVzdWx0IGZyb20gYSB3cmFwcGVkIGFuZCBjaGFpbmVkIG9iamVjdC4KICAgIHZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuX3dyYXBwZWQ7CiAgICB9CgogIH0pOwoKfSkuY2FsbCh0aGlzKTsKCmRlZmluZSgidW5kZXJzY29yZSIsIChmdW5jdGlvbiAoZ2xvYmFsKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciByZXQsIGZuOwogICAgICAgIHJldHVybiByZXQgfHwgZ2xvYmFsLl87CiAgICB9Owp9KHRoaXMpKSk7CgpkZWZpbmUoJ2VkaXNvbi9saWIvbWljcm9ldmVudCcsW10sIGZ1bmN0aW9uKCkgewoKCS8qKgoJICogTWljcm9FdmVudCAtIHRvIG1ha2UgYW55IGpzIG9iamVjdCBhbiBldmVudCBlbWl0dGVyIChzZXJ2ZXIgb3IgYnJvd3NlcikKCSAqCgkgKiAtIHB1cmUgamF2YXNjcmlwdCAtIHNlcnZlciBjb21wYXRpYmxlLCBicm93c2VyIGNvbXBhdGlibGUKCSAqIC0gZG9udCByZWx5IG9uIHRoZSBicm93c2VyIGRvbXMKCSAqIC0gc3VwZXIgc2ltcGxlIC0geW91IGdldCBpdCBpbW1lZGlhdGx5LCBubyBtaXN0ZXJ5LCBubyBtYWdpYyBpbnZvbHZlZAoJICoKCSAqIC0gY3JlYXRlIGEgTWljcm9FdmVudERlYnVnIHdpdGggZ29vZGllcyB0byBkZWJ1ZwoJICogICAtIG1ha2UgaXQgc2FmZXIgdG8gdXNlCgkqLwoJdmFyIE1pY3JvRXZlbnQJPSBmdW5jdGlvbigpe307CglNaWNyb0V2ZW50LnByb3RvdHlwZQk9IHsKCQliaW5kCTogZnVuY3Rpb24oZXZlbnQsIGZjdCl7CgkJCXRoaXMuX2V2ZW50cyA9IHRoaXMuX2V2ZW50cyB8fCB7fTsKCQkJdGhpcy5fZXZlbnRzW2V2ZW50XSA9IHRoaXMuX2V2ZW50c1tldmVudF0JfHwgW107CgkJCXRoaXMuX2V2ZW50c1tldmVudF0ucHVzaChmY3QpOwoJCX0sCgkJdW5iaW5kCTogZnVuY3Rpb24oZXZlbnQsIGZjdCl7CgkJCXRoaXMuX2V2ZW50cyA9IHRoaXMuX2V2ZW50cyB8fCB7fTsKCQkJaWYoIGV2ZW50IGluIHRoaXMuX2V2ZW50cyA9PT0gZmFsc2UgICkJcmV0dXJuOwoJCQl0aGlzLl9ldmVudHNbZXZlbnRdLnNwbGljZSh0aGlzLl9ldmVudHNbZXZlbnRdLmluZGV4T2YoZmN0KSwgMSk7CgkJfSwKCQl0cmlnZ2VyCTogZnVuY3Rpb24oZXZlbnQgLyogLCBhcmdzLi4uICovKXsKCQkJdGhpcy5fZXZlbnRzID0gdGhpcy5fZXZlbnRzIHx8IHt9OwoJCQlpZiggZXZlbnQgaW4gdGhpcy5fZXZlbnRzID09PSBmYWxzZSAgKQlyZXR1cm47CgkJCWZvcih2YXIgaSA9IDA7IGkgPCB0aGlzLl9ldmVudHNbZXZlbnRdLmxlbmd0aDsgaSsrKXsKCQkJCXRoaXMuX2V2ZW50c1tldmVudF1baV0uYXBwbHkodGhpcywgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CgkJCX0KCQl9Cgl9OwoKCS8qKgoJICogbWl4aW4gd2lsbCBkZWxlZ2F0ZSBhbGwgTWljcm9FdmVudC5qcyBmdW5jdGlvbiBpbiB0aGUgZGVzdGluYXRpb24gb2JqZWN0CgkgKgoJICogLSByZXF1aXJlKCdNaWNyb0V2ZW50JykubWl4aW4oRm9vYmFyKSB3aWxsIG1ha2UgRm9vYmFyIGFibGUgdG8gdXNlIE1pY3JvRXZlbnQKCSAqCgkgKiBAcGFyYW0ge09iamVjdH0gdGhlIG9iamVjdCB3aGljaCB3aWxsIHN1cHBvcnQgTWljcm9FdmVudAoJKi8KCU1pY3JvRXZlbnQubWl4aW4JPSBmdW5jdGlvbihkZXN0T2JqZWN0KXsKCQl2YXIgcHJvcHMJPSBbJ2JpbmQnLCAndW5iaW5kJywgJ3RyaWdnZXInXTsKCQlmb3IodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpICsrKXsKCQkJaWYoIHR5cGVvZiBkZXN0T2JqZWN0ID09PSAnZnVuY3Rpb24nICl7CgkJCQlkZXN0T2JqZWN0LnByb3RvdHlwZVtwcm9wc1tpXV0JPSBNaWNyb0V2ZW50LnByb3RvdHlwZVtwcm9wc1tpXV07CgkJCX1lbHNlewoJCQkJZGVzdE9iamVjdFtwcm9wc1tpXV0gPSBNaWNyb0V2ZW50LnByb3RvdHlwZVtwcm9wc1tpXV07CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIE1pY3JvRXZlbnQ7Cgp9KTsKCmRlZmluZSgnZWRpc29uL2xpYi9zYW5kYm94JyxbJ3JlcXVpcmUnLCd1bmRlcnNjb3JlJywnLi9taWNyb2V2ZW50J10sZnVuY3Rpb24ocmVxdWlyZSkgewoKCXZhciBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpLAoJCU1pY3JvRXZlbnQgPSByZXF1aXJlKCcuL21pY3JvZXZlbnQnKTsKCgl2YXIgU2FuZGJveCA9IGZ1bmN0aW9uKHJvdXRlKSB7CgkJdGhpcy5yb3V0ZSA9IHJvdXRlOwoJfTsKCglfLmV4dGVuZChTYW5kYm94LnByb3RvdHlwZSwgewoKCQknZ2V0JzogZnVuY3Rpb24obmFtZSkgewoJCQluYW1lID0gbmFtZS5yZXBsYWNlKC9bXFtdLywgIlxcXFsiKS5yZXBsYWNlKC9bXF1dLywgIlxcXF0iKTsKCQkJdmFyIHJlZ2V4ID0gbmV3IFJlZ0V4cCgiW1xcPyZdIiArIG5hbWUgKyAiPShbXiYjXSopIiksCgkJCXJlc3VsdHMgPSByZWdleC5leGVjKHdpbmRvdy5sb2NhdGlvbi5oYXNoKTsKCQkJcmV0dXJuIHJlc3VsdHMgPT0gbnVsbCA/IG51bGwgOiBkZWNvZGVVUklDb21wb25lbnQocmVzdWx0c1sxXS5yZXBsYWNlKC9cKy9nLCAiICIpKTsKCQl9CgoJfSk7CgoJTWljcm9FdmVudC5taXhpbihTYW5kYm94LnByb3RvdHlwZSk7CgoJcmV0dXJuIFNhbmRib3g7Cgp9KTsKCmRlZmluZSgnZWRpc29uL2xpYi9yb3V0ZScsWydyZXF1aXJlJywndW5kZXJzY29yZScsJy4vc2FuZGJveCddLGZ1bmN0aW9uKHJlcXVpcmUpIHsKCgl2YXIgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKSwKCQlTYW5kYm94ID0gcmVxdWlyZSgnLi9zYW5kYm94Jyk7CgoJLyoqCgkgKiBAY2xhc3MgUm91dGUKCSAqLwoJdmFyIFJvdXRlID0gZnVuY3Rpb24ob3B0aW9ucywgc2VjdGlvbiwgZWRpc29uKSB7CgoJCV8uZGVmYXVsdHMob3B0aW9ucywgewoJCQknaW5pdCc6IGZ1bmN0aW9uKGZuKSB7CgkJCQlmbigpOwoJCQl9CgkJfSk7CgoJCXZhciBzZWxmID0gdGhpczsKCQlzZWxmLnRpdGxlID0gbnVsbDsKCQlzZWxmLm5hbWUgPSBvcHRpb25zLm5hbWU7CgkJc2VsZi5zZWN0aW9uID0gc2VjdGlvbjsKCQlzZWxmLmNhbGxiYWNrID0gb3B0aW9ucy5jYWxsYmFjazsKCQlzZWxmLmV4dGVuc2lvbnMgPSBvcHRpb25zLmV4dGVuZDsKCQlzZWxmLnRlbXBsYXRlID0gb3B0aW9ucy50ZW1wbGF0ZSB8fCAiPGRpdj48L2Rpdj4iOwoJCXNlbGYuY2xlYW51cCA9IG9wdGlvbnMuY2xlYW51cDsKCgkJc2VsZi5sb2cgPSBmdW5jdGlvbigpIHsKCQkJaWYgKCAhZWRpc29uLmdldERlYnVnKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJY29uc29sZS5sb2coYXJndW1lbnRzKTsKCQl9OwoKCQkvKioKCQkgKiBSZXR1cm5zIGEgc3RyaW5nIGluZGljYXRpbmcgdGhlIG5hbWUgb2YgdGhlIHNlY3Rpb24gKyB0aGlzIHJvdXRlLgoJCSAqLwoJCXNlbGYuZ2V0UGF0aCA9IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gc2VjdGlvbi5nZXROYW1lKCkgKyAnLycgKyBzZWxmLm5hbWU7CgkJfTsKCgkJc2VsZi5sb2coJ05ldyByb3V0ZSBkZWZpbmVkOiAnICsgc2VsZi5nZXRQYXRoKCkpOwoKCQlfLmVhY2goZWRpc29uLmdldFJvdXRlRXh0ZW5zaW9ucygpLCBmdW5jdGlvbihleHQpIHsKCQkJXy5leHRlbmQoU2FuZGJveC5wcm90b3R5cGUsIGV4dCk7CgkJfSk7CgoJCXNlbGYuc2FuZGJveCA9IG5ldyBTYW5kYm94KCk7CgkJc2VsZi5zYW5kYm94LnNlY3Rpb24gPSBzZWN0aW9uLmdldFNhbmRib3goKTsKCgkJc2VsZi5pbml0ID0gZnVuY3Rpb24oaWQsIGZuKSB7CgkJCW9wdGlvbnMuaW5pdC5jYWxsKHNlbGYuc2FuZGJveCwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoIGVkaXNvbi5nZXRBY3RpdmVTZWN0aW9uKCkgIT09IHNlbGYuc2VjdGlvbiApIHsKCQkJCQkvLyBUaGUgdXNlciBpcyBtYWtpbmcgdGhlaXIgZmlyc3QgZW50cnkgaW50byB0aGlzIHNlY3Rpb24uCgkJCQkJc2VsZi5sb2coJ0luaXRpYWwgZW50cnkgaW50byBzZWN0aW9uOiAnICsgc2VjdGlvbi5nZXROYW1lKCkpOwoJCQkJCXNlbGYuc2VjdGlvbi5sb2FkVGVtcGxhdGUoKTsKCQkJCQlzZWxmLnNlY3Rpb24ucnVuQ2FsbGJhY2soKTsKCQkJCQlTYW5kYm94LnByb3RvdHlwZS5jb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncm91dGUnKTsKCQkJCQlzZWxmLmxvYWRUZW1wbGF0ZSgpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBUaGUgdXNlciBpcyBuYXZpZ2F0aW5nIHdpdGhpbiB0aGUgc2FtZSBzZWN0aW9uLgoJCQkJCVNhbmRib3gucHJvdG90eXBlLmNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyb3V0ZScpOwoJCQkJCXNlbGYubG9hZFRlbXBsYXRlKCk7CgkJCQl9CgkJCQllZGlzb24uc2V0QWN0aXZlU2VjdGlvbihzZWxmLnNlY3Rpb24pOwoJCQkJZWRpc29uLnNldEFjdGl2ZVJvdXRlKHNlbGYuYXBpKTsKCQkJCXNlbGYuY2FsbGJhY2suY2FsbChzZWxmLnNhbmRib3gsIGlkKTsKCQkJCWZuKCk7CgkJCX0pOwoJCX07CgoJCV8uZWFjaChzZWxmLmV4dGVuc2lvbnMsIGZ1bmN0aW9uKGZuYywgZXh0bmFtZSkgewoJCQlzZWxmLnNhbmRib3hbZXh0bmFtZV0gPSBmdW5jdGlvbigpIHsKCQkJCWZuYy5hcHBseShzZWxmLnNhbmRib3gsIGFyZ3VtZW50cyk7CgkJCX07CgkJfSk7CgoJCXNlbGYubG9hZFRlbXBsYXRlID0gZnVuY3Rpb24oKSB7CgkJCXZhciB0cGwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJdHBsLmlubmVySFRNTCA9IHNlbGYudGVtcGxhdGU7CgkJCXRwbC5zZXRBdHRyaWJ1dGUoJ2lkJywgJ3NlY3Rpb25fJyArIHNlbGYuc2VjdGlvbi5nZXROYW1lKCkgKyAnX3JvdXRlXycgKyBzZWxmLm5hbWUpOwoJCQl0cGwuY2xhc3NOYW1lID0gJ3JvdXRlJzsKCQkJZWRpc29uLmluc2VydFRlbXBsYXRlKHRwbCk7CgkJfTsKCgkJLyoqCgkJICogUHVibGljIEludGVyZmFjZQoJCSAqLwoJCXNlbGYuYXBpID0gewoJCQlnZXRDYWxsYmFjazogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gc2VsZi5jYWxsYmFjazsKCQkJfSwKCQkJZ2V0U2FuZGJveDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gc2VsZi5zYW5kYm94OwoJCQl9LAoJCQlnZXROYW1lOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiBzZWxmLm5hbWU7CgkJCX0sCgkJCWluaXQ6IGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5pbml0LmFwcGx5KHNlbGYsIGFyZ3VtZW50cyk7CgkJCX0sCgkJCWdldFRpdGxlOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiBzZWxmLnRpdGxlOwoJCQl9LAoJCQlnZXRGdWxsUGF0aDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdGhpcy5nZXRGdWxsUGF0aC5hcHBseShzZWxmLCBhcmd1bWVudHMpOwoJCQl9LAoJCQljbGVhbnVwOiBmdW5jdGlvbigpIHsKCQkJCWlmICggXy5pc0Z1bmN0aW9uKHNlbGYuY2xlYW51cCkgKSB7CgkJCQkJc2VsZi5jbGVhbnVwLmNhbGwoc2VsZi5zYW5kYm94KTsKCQkJCX0KCQkJfQoJCX07CgoJCXJldHVybiBzZWxmLmFwaTsKCgl9OwoKCV8uZXh0ZW5kKFJvdXRlLnByb3RvdHlwZSwgewoKCQkvKioKCQkgKiBSZXR1cm5zIHRoZSBoYXNoYmFuZyBwYXRoIGF0IHdoaWNoIHRoaXMgcm91dGUgY2FuIGJlIGFjY2Vzc2VkOiBzZWN0aW9uX25hbWUvcm91dGVfbmFtZQoJCSAqLwoJCSdnZXRGdWxsUGF0aCc6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5zZWN0aW9uLmdldE5hbWUoKSArICcvJyArIHRoaXMubmFtZTsKCQl9CgoJfSk7CgoJcmV0dXJuIFJvdXRlOwoKfSk7CgpkZWZpbmUoJ2VkaXNvbi9saWIvc2VjdGlvbicsWydyZXF1aXJlJywndW5kZXJzY29yZScsJy4vcm91dGUnLCcuL3NhbmRib3gnXSxmdW5jdGlvbihyZXF1aXJlKSB7CgoJdmFyIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyksCgkJUm91dGUgPSByZXF1aXJlKCcuL3JvdXRlJyksCgkJU2FuZGJveCA9IHJlcXVpcmUoJy4vc2FuZGJveCcpOwoKCS8qKgoJICogQGNsYXNzIFNlY3Rpb24KCSAqLwoJdmFyIFNlY3Rpb24gPSBmdW5jdGlvbihvcHRpb25zLCBlZGlzb24pIHsKCgkJdmFyIHNlbGYgPSB0aGlzOwoJCXNlbGYuZWRpc29uID0gZWRpc29uOwoJCXNlbGYubmFtZSA9IG9wdGlvbnMubmFtZTsKCQlzZWxmLmNvbnRyb2xsZXIgPSBvcHRpb25zLmNvbnRyb2xsZXI7CgkJc2VsZi5jYWxsYmFjayA9IG9wdGlvbnMuY2FsbGJhY2s7CgkJc2VsZi5leHRlbnNpb25zID0gb3B0aW9ucy5leHRlbmQ7CgkJc2VsZi5wYXJlbnRfc2VjdGlvbiA9IG9wdGlvbnMucGFyZW50X3NlY3Rpb247CgkJc2VsZi50ZW1wbGF0ZSA9IG9wdGlvbnMudGVtcGxhdGUgfHwgIjxkaXYgaWQ9J3JvdXRlJz48L2Rpdj4iOwoJCXNlbGYudGVtcGxhdGVEYXRhID0gb3B0aW9ucy50ZW1wbGF0ZURhdGE7CgkJc2VsZi5jbGVhbnVwID0gb3B0aW9ucy5jbGVhbnVwOwoJCXNlbGYucm91dGVzID0ge307CgoJCXNlbGYuY3JlYXRlUm91dGUgPSBmdW5jdGlvbihvcHRpb25zKSB7CgkJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCQlfLmRlZmF1bHRzKG9wdGlvbnMsIHsKCQkJCSduYW1lJzogbnVsbCwKCQkJCSdjYWxsYmFjayc6IG51bGwsCgkJCQknZXh0ZW5kJzoge30sCgkJCQknY2xlYW51cCc6IG51bGwKCQkJfSk7CgkJCWlmICggIV8uaXNTdHJpbmcob3B0aW9ucy5uYW1lKSB8fCBvcHRpb25zLm5hbWUgPT09ICcnICkgewoJCQkJdGhyb3cgJ0ludmFsaWQgYG5hbWVgIHNwZWNpZmllZC4nOwoJCQl9CgkJCXZhciBuYW1lX2NoZWNrID0gb3B0aW9ucy5uYW1lLnJlcGxhY2UoL1xXL2csICcnKTsKCQkJaWYgKCBuYW1lX2NoZWNrICE9PSBvcHRpb25zLm5hbWUgKSB7CgkJCQl0aHJvdyAnSW52YWxpZCBgbmFtZWAgc3BlY2lmaWVkLic7CgkJCX0KCQkJaWYgKCAhXy5pc0Z1bmN0aW9uKG9wdGlvbnMuY2FsbGJhY2spICYmICFfLmlzTnVsbChvcHRpb25zLmNhbGxiYWNrKSApIHsKCQkJCXRocm93ICdJbnZhbGlkIGBjYWxsYmFja2Agc3BlY2lmaWVkLic7CgkJCX0KCQkJaWYgKCAhXy5pc09iamVjdChvcHRpb25zLmV4dGVuZCkgKSB7CgkJCQl0aHJvdyAnSW52YWxpZCBgZXh0ZW5kYCB2YWx1ZSBzcGVjaWZpZWQuJzsKCQkJfQoJCQlpZiAoICFfLmlzTnVsbChvcHRpb25zLmNsZWFudXApICYmICFfLmlzRnVuY3Rpb24ob3B0aW9ucy5jbGVhbnVwKSApIHsKCQkJCXRocm93ICdJbnZhbGlkIGBjbGVhbnVwYCB2YWx1ZSBzcGVjaWZpZWQuJzsKCQkJfQoJCQlvcHRpb25zLnRlbXBsYXRlX2NvbnRhaW5lcl9zZWxlY3RvciA9ICcucm91dGUnOwoJCQl2YXIgcm91dGUgPSBuZXcgUm91dGUob3B0aW9ucywgc2VsZi5hcGksIGVkaXNvbik7CgkJCXNlbGYucm91dGVzW29wdGlvbnMubmFtZV0gPSByb3V0ZTsKCQkJcmV0dXJuIHJvdXRlOwoJCX07CgoJCXNlbGYubG9nID0gZnVuY3Rpb24oKSB7CgkJCWlmICggIWVkaXNvbi5nZXREZWJ1ZygpICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWNvbnNvbGUubG9nKGFyZ3VtZW50cyk7CgkJfTsKCgkJXy5lYWNoKGVkaXNvbi5nZXRSb3V0ZUV4dGVuc2lvbnMoKSwgZnVuY3Rpb24oZXh0KSB7CgkJCV8uZXh0ZW5kKFNhbmRib3gucHJvdG90eXBlLCBleHQpOwoJCX0pOwoKCQlfLmV4dGVuZChTYW5kYm94LnByb3RvdHlwZSwgc2VsZi5leHRlbnNpb25zKTsKCgkJc2VsZi5zYW5kYm94ID0gbmV3IFNhbmRib3godGhpcyk7CgoJCXNlbGYubG9hZFRlbXBsYXRlID0gZnVuY3Rpb24oKSB7CgkJCXZhciB0cGwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJdHBsLmlubmVySFRNTCA9IHNlbGYudGVtcGxhdGU7CgkJCXRwbC5zZXRBdHRyaWJ1dGUoJ2lkJywgJ2VkaXNvbl9zZWN0aW9uJyk7CgkJCXRwbC5jbGFzc05hbWUgPSAnc2VjdGlvbic7CgkJCWVkaXNvbi5pbnNlcnRTZWN0aW9uVGVtcGxhdGUodHBsKTsKCQl9OwoKCQlzZWxmLmFwaSA9IHsKCQkJY3JlYXRlUm91dGU6IHNlbGYuY3JlYXRlUm91dGUuYmluZChzZWxmKSwKCQkJZ2V0Um91dGVzOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiBzZWxmLnJvdXRlczsKCQkJfSwKCQkJaGFzUm91dGU6IGZ1bmN0aW9uKG5hbWUpIHsKCQkJCWlmICggXy5pc1VuZGVmaW5lZChzZWxmLnJvdXRlc1tuYW1lXSkgKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQkJcmV0dXJuIHRydWU7CgkJCX0sCgkJCWdldFJvdXRlOiBmdW5jdGlvbihuYW1lKSB7CgkJCQlyZXR1cm4gc2VsZi5yb3V0ZXNbbmFtZV07CgkJCX0sCgkJCWdldERlZmF1bHRSb3V0ZTogZnVuY3Rpb24oKSB7CgkJCQl2YXIgcm91dGVzID0gXy5rZXlzKHNlbGYucm91dGVzKTsKCQkJCXZhciByb3V0ZV9uYW1lID0gcm91dGVzWzBdOwoJCQkJcmV0dXJuIHNlbGYucm91dGVzW3JvdXRlX25hbWVdOwoJCQl9LAoJCQlnZXROYW1lOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiBzZWxmLm5hbWU7CgkJCX0sCgkJCWdldENvbnRyb2xsZXI6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHNlbGYuY29udHJvbGxlcjsKCQkJfSwKCQkJcnVuQ2FsbGJhY2s6IGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5sb2FkVGVtcGxhdGUoKTsKCQkJCXNlbGYuY2FsbGJhY2suY2FsbChzZWxmLnNhbmRib3gpOwoJCQl9LAoJCQlnZXRQYXJlbnRTZWN0aW9uOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiBzZWxmLnBhcmVudF9zZWN0aW9uOwoJCQl9LAoJCQljbGVhbnVwOiBmdW5jdGlvbigpIHsKCQkJCWlmICggXy5pc0Z1bmN0aW9uKHNlbGYuY2xlYW51cCkgKSB7CgkJCQkJc2VsZi5jbGVhbnVwLmNhbGwoc2VsZi5zYW5kYm94KTsKCQkJCX0KCQkJfSwKCQkJZ2V0U2FuZGJveDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gc2VsZi5zYW5kYm94OwoJCQl9LAoJCQlsb2FkVGVtcGxhdGU6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHNlbGYubG9hZFRlbXBsYXRlKCk7CgkJCX0KCQl9OwoKCQlyZXR1cm4gc2VsZi5hcGk7CgoJfTsKCglyZXR1cm4gU2VjdGlvbjsKCn0pOwoKZGVmaW5lKCdlZGlzb24vbGliL3JvdXRlcicsWydyZXF1aXJlJywndW5kZXJzY29yZScsJy4vbWljcm9ldmVudCddLGZ1bmN0aW9uKHJlcXVpcmUpIHsKCgl2YXIgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKSwKCQlNaWNyb0V2ZW50ID0gcmVxdWlyZSgnLi9taWNyb2V2ZW50Jyk7CgoJLyoqCgkgKiBAY2xhc3MgUm91dGVyCgkgKi8KCXZhciBSb3V0ZXIgPSBmdW5jdGlvbihlZGlzb24pIHsKCQl0aGlzLmluaXQuYXBwbHkodGhpcywgXy50b0FycmF5KGFyZ3VtZW50cykpOwoJCS8qCgkJcmV0dXJuIHsKCQkJJ2JpbmQnOiB0aGlzLmJpbmQuYXBwbHkodGhpcykKCQl9OwoJCSovCgl9OwoKCU1pY3JvRXZlbnQubWl4aW4oUm91dGVyLnByb3RvdHlwZSk7CgoJXy5leHRlbmQoUm91dGVyLnByb3RvdHlwZSwgewoKCQknZWRpc29uJzogbnVsbCwKCgkJJ2xpc3RlbmluZyc6IGZhbHNlLAoKCQknaW5pdCc6IGZ1bmN0aW9uKGVkaXNvbikgewoJCQl0aGlzLmVkaXNvbiA9IGVkaXNvbjsKCQl9LAoKCQknbGlzdGVuJzogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJaWYgKCB0aGlzLmxpc3RlbmluZyApIHsKCQkJCXJldHVybjsKCQkJfQoJCQl0aGlzLmxpc3RlbmluZyA9IHRydWU7CgkJCXRoaXMuYmluZCgnaGFzaF9jaGFuZ2UnLCBmdW5jdGlvbihkYXRhKSB7CgkJCQlzZWxmLm9uSGFzaENoYW5nZShkYXRhKTsKCQkJfSk7CgkJCXRoaXMud2F0Y2hVUkwoKTsKCQl9LAoKCQknd2F0Y2hVUkwnOiBmdW5jdGlvbigpIHsKCQkJd2luZG93Lm9uaGFzaGNoYW5nZSA9IHRoaXMucHJvY2Vzc0hhc2hDaGFuZ2UuYmluZCh0aGlzKTsKCQkJaWYgKCB3aW5kb3cubG9jYXRpb24uaGFzaCApIHsKCQkJCXRoaXMucHJvY2Vzc0hhc2hDaGFuZ2UoKTsKCQkJfQoJCX0sCgoJCSdwcm9jZXNzSGFzaENoYW5nZSc6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnRyaWdnZXIoJ2hhc2hfY2hhbmdlJywgewoJCQkJJ2hhc2gnOiB3aW5kb3cubG9jYXRpb24uaGFzaAoJCQl9KTsKCQl9LAoKCQknb25IYXNoQ2hhbmdlJzogZnVuY3Rpb24oZGF0YSkgewoJCQl2YXIgcHJvY2Vzc2VkOwoJCQlkYXRhID0gZGF0YSB8fCB7fTsKCQkJXy5kZWZhdWx0cyhkYXRhLCB7CgkJCQknaGFzaCc6IG51bGwKCQkJfSk7CgkJCWlmICggIWRhdGEuaGFzaCApIHsKCQkJCXJldHVybjsKCQkJfQoJCQl0cnkgewoJCQkJcHJvY2Vzc2VkID0gdGhpcy5wcm9jZXNzSGFzaChkYXRhLmhhc2gpOwoJCQl9IGNhdGNoKGUpIHsKCQkJCXJldHVybjsKCQkJfQoJCQl0aGlzLnRyaWdnZXIoJ29uX3JvdXRlJywgcHJvY2Vzc2VkKTsKCQl9LAoKCQkncHJvY2Vzc0hhc2gnOiBmdW5jdGlvbihoYXNoKSB7CgkJCWlmICggaGFzaC5pbmRleE9mKCcjJykgPT09IDAgJiYgaGFzaC5pbmRleE9mKCchJykgPT09IDEgKSB7CgkJCQloYXNoID0gaGFzaC5zdWJzdHJpbmcoMik7CgkJCX0KCQkJaWYgKCBoYXNoID09PSAnJyApIHsKCQkJCXRocm93ICdJbnZhbGlkIGhhc2guJzsKCQkJfQoJCQl2YXIgYWRkcmVzcyA9IG51bGwsCgkJCQl0bXAgPSBoYXNoLnNwbGl0KCc/JyksCgkJCQlzZWN0aW9uX25hbWUgPSBudWxsLAoJCQkJcm91dGVfbmFtZSA9IG51bGwsCgkJCQlyb3V0ZV9pZCA9IG51bGw7CgkJCWlmICggdG1wLmxlbmd0aCA9PT0gMSApIHsKCQkJCWFkZHJlc3MgPSB0bXAucG9wKCk7CgkJCX0gZWxzZSB7CgkJCQlhZGRyZXNzID0gdG1wLnNoaWZ0KCk7CgkJCX0KCQkJaWYgKCBhZGRyZXNzLmluZGV4T2YoJy8nKSA8IDAgKSB7CgkJCQlzZWN0aW9uX25hbWUgPSBhZGRyZXNzOwoJCQl9IGVsc2UgewoJCQkJdG1wID0gYWRkcmVzcy5zcGxpdCgnLycpOwoJCQkJc3dpdGNoICggdG1wLmxlbmd0aCApIHsKCQkJCQljYXNlIDE6CgkJCQkJCXNlY3Rpb25fbmFtZSA9IHRtcC5wb3AoKTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAyOgoJCQkJCQlzZWN0aW9uX25hbWUgPSB0bXAuc2hpZnQoKTsKCQkJCQkJcm91dGVfbmFtZSA9IHRtcC5zaGlmdCgpOwoJCQkJCQlicmVhazsKCQkJCQljYXNlIDM6CgkJCQkJCXNlY3Rpb25fbmFtZSA9IHRtcC5zaGlmdCgpOwoJCQkJCQlyb3V0ZV9uYW1lID0gdG1wLnNoaWZ0KCk7CgkJCQkJCXJvdXRlX2lkID0gdG1wLnNoaWZ0KCk7CgkJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJCXZhciBwYXJhbXMgPSB7fTsKCQkJcmV0dXJuIHsKCQkJCSdzZWN0aW9uX25hbWUnOiBzZWN0aW9uX25hbWUsCgkJCQkncm91dGVfbmFtZSc6IHJvdXRlX25hbWUsCgkJCQkncm91dGVfaWQnOiByb3V0ZV9pZAoJCQl9OwoJCX0KCgl9KTsKCglyZXR1cm4gUm91dGVyOwoKfSk7CgpkZWZpbmUoJ2VkaXNvbi9saWIvdXRpbCcsW10sIGZ1bmN0aW9uKCkgewoKCXJldHVybiB7CgoJCS8qKgoJCSAqIFJldHVybnMgdHJ1ZSAvIGZhbHNlIGFzIHRvIHdoZXRoZXIgdGhlIGJyb3dzZXIgc3VwcG9ydHMgdGhlIEhUTUw1IEhpc3RvcnkgQVBJCgkJICovCgkJJ3N1cHBvcnRzSGlzdG9yeUFQSSc6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gISEod2luZG93Lmhpc3RvcnkgJiYgaGlzdG9yeS5wdXNoU3RhdGUpOwoJCX0KCgl9OwoKfSk7CgpkZWZpbmUoJ2VkaXNvbi9saWIvZWRpc29uJyxbJ3JlcXVpcmUnLCd1bmRlcnNjb3JlJywnLi9zZWN0aW9uJywnLi9yb3V0ZScsJy4vcm91dGVyJywnLi91dGlsJ10sZnVuY3Rpb24ocmVxdWlyZSkgewoKCXZhciBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpLAoJCVNlY3Rpb24gPSByZXF1aXJlKCcuL3NlY3Rpb24nKSwKCQlSb3V0ZSA9IHJlcXVpcmUoJy4vcm91dGUnKSwKCQlSb3V0ZXIgPSByZXF1aXJlKCcuL3JvdXRlcicpLAoJCXV0aWwgPSByZXF1aXJlKCcuL3V0aWwnKTsKCgl2YXIgRWRpc29uID0gZnVuY3Rpb24oKSB7CgkJdGhpcy5pbml0LmFwcGx5KHRoaXMsIF8udG9BcnJheShhcmd1bWVudHMpKTsKCQlyZXR1cm4gewoJCQknY3JlYXRlU2VjdGlvbic6IHRoaXMuY3JlYXRlU2VjdGlvbi5iaW5kKHRoaXMpLAoJCQknaW5pdFJvdXRlcyc6IHRoaXMuaW5pdFJvdXRlcy5iaW5kKHRoaXMpLAoJCQknZXh0ZW5kJzogdGhpcy5leHRlbmQuYmluZCh0aGlzKSwKCQkJJ2V4dGVuZENsZWFudXAnOiB0aGlzLmV4dGVuZENsZWFudXAuYmluZCh0aGlzKQoJCX07Cgl9OwoKCV8uZXh0ZW5kKEVkaXNvbi5wcm90b3R5cGUsIHsKCgkJJ2luaXQnOiBmdW5jdGlvbihvcHRpb25zKSB7CgkJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCQlfLmRlZmF1bHRzKG9wdGlvbnMsIHRoaXMub3B0aW9ucyk7CgkJCXRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CgkJCWlmICggIV8uaXNCb29sZWFuKG9wdGlvbnMucHVzaFN0YXRlKSApIHsKCQkJCW9wdGlvbnMucHVzaFN0YXRlID0gZmFsc2U7CgkJCX0KCQkJaWYgKCAhb3B0aW9ucy5jb250YWluZXIgKSB7CgkJCQl0aHJvdyAnQSB2YWx1ZSBtdXN0IGJlIHNwZWNpZmllZCBmb3IgYGNvbnRhaW5lci5gJzsKCQkJfSBlbHNlIHsKCQkJCXRoaXMucm91dGVfY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQob3B0aW9ucy5jb250YWluZXIpOwoJCQkJaWYgKCAhIHRoaXMucm91dGVfY29udGFpbmVyICkgewoJCQkJCXRocm93ICdTcGVjaWZpZWQgcm91dGUgY29udGFpbmVyIGRvZXMgbm90IGV4aXN0OiBgJyArIG9wdGlvbnMuY29udGFpbmVyICsgJy5gJzsKCQkJCX0KCQkJCWlmICggb3B0aW9ucy5wdXNoU3RhdGUgJiYgdXRpbC5zdXBwb3J0c0hpc3RvcnlBUEkoKSApIHsKCQkJCQl0aGlzLmVuYWJsZVB1c2hTdGF0ZSA9IHRydWU7CgkJCQl9CgkJCX0KCQl9LAoKCQknb3B0aW9ucyc6IHsKCQkJJ2NvbnRhaW5lcic6IG51bGwsCgkJCSdwdXNoU3RhdGUnOiBmYWxzZQoJCX0sCgoJCSdkZWJ1Zyc6IGZhbHNlLAoKCQknZW5hYmxlUHVzaFN0YXRlJzogZmFsc2UsCgoJCSdyb3V0ZXNfaW5pdGlhbGl6ZWQnOiBmYWxzZSwKCgkJJ3NlY3Rpb25zJzoge30sCgoJCSdhY3RpdmVfcGFyZW50X3NlY3Rpb24nOiBudWxsLAoKCQknYWN0aXZlX3NlY3Rpb24nOiBudWxsLAoKCQknYWN0aXZlX3NlY3Rpb25faW50ZXJ2YWxzJzogW10sCgoJCSdhY3RpdmVfcGFyZW50X3NlY3Rpb25faW50ZXJ2YWxzJzogW10sCgoJCSdhY3RpdmVfcm91dGUnOiBudWxsLAoKCQknUm91dGVzJzogbnVsbCwKCgkJJ3JvdXRlX2V4dGVuc2lvbnMnOiBbXSwKCgkJJ2xvZyc6IGZ1bmN0aW9uKCkgewoJCQlpZiAoICF0aGlzLmRlYnVnICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWNvbnNvbGUubG9nKGFyZ3VtZW50cyk7CgkJfSwKCgkJJ2NyZWF0ZVNlY3Rpb24nOiBmdW5jdGlvbihvcHRpb25zKSB7CgkJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCQlfLmRlZmF1bHRzKG9wdGlvbnMsIHsKCQkJCSduYW1lJzogbnVsbCwKCQkJCSdjYWxsYmFjayc6IG51bGwsCgkJCQknZXh0ZW5kJzoge30sCgkJCQknY2xlYW51cCc6IG51bGwKCQkJfSk7CgkJCWlmICggIV8uaXNTdHJpbmcob3B0aW9ucy5uYW1lKSB8fCBvcHRpb25zLm5hbWUgPT09ICcnICkgewoJCQkJdGhyb3cgJ0ludmFsaWQgYG5hbWVgIHNwZWNpZmllZC4nOwoJCQl9CgkJCXZhciBuYW1lX2NoZWNrID0gb3B0aW9ucy5uYW1lLnJlcGxhY2UoL1xXL2csICcnKTsKCQkJaWYgKCBuYW1lX2NoZWNrICE9PSBvcHRpb25zLm5hbWUgKSB7CgkJCQl0aHJvdyAnSW52YWxpZCBgbmFtZWAgc3BlY2lmaWVkLic7CgkJCX0KCQkJaWYgKCAhXy5pc0Z1bmN0aW9uKG9wdGlvbnMuY2FsbGJhY2spICYmICFfLmlzTnVsbChvcHRpb25zLmNhbGxiYWNrKSApIHsKCQkJCXRocm93ICdJbnZhbGlkIGBjYWxsYmFja2Agc3BlY2lmaWVkLic7CgkJCX0KCQkJaWYgKCAhXy5pc09iamVjdChvcHRpb25zLmV4dGVuZCkgKSB7CgkJCQl0aHJvdyAnSW52YWxpZCBgZXh0ZW5kYCB2YWx1ZSBzcGVjaWZpZWQuJzsKCQkJfQoJCQlpZiAoICFfLmlzTnVsbChvcHRpb25zLmNsZWFudXApICYmICFfLmlzRnVuY3Rpb24ob3B0aW9ucy5jbGVhbnVwKSApIHsKCQkJCXRocm93ICdJbnZhbGlkIGBjbGVhbnVwYCB2YWx1ZSBzcGVjaWZpZWQuJzsKCQkJfQoJCQl0aGlzLnNlY3Rpb25zW29wdGlvbnMubmFtZV0gPSBuZXcgU2VjdGlvbihvcHRpb25zLCB0aGlzKTsKCQkJcmV0dXJuIHRoaXMuc2VjdGlvbnNbb3B0aW9ucy5uYW1lXTsKCQl9LAoKCQknY2hlY2tQYXJlbnRTZWN0aW9uJzogZnVuY3Rpb24oc2VjdGlvbl9uYW1lKSB7CgkJCWlmICggXy5pc1N0cmluZyh0aGlzLnNlY3Rpb25zW3NlY3Rpb25fbmFtZV0uZ2V0UGFyZW50U2VjdGlvbigpKSApIHsKCQkJCWlmICggdGhpcy5hY3RpdmVfcGFyZW50X3NlY3Rpb24gIT09IHRoaXMuc2VjdGlvbnNbc2VjdGlvbl9uYW1lXS5nZXRQYXJlbnRTZWN0aW9uKCkgKSB7CgkJCQkJaWYgKCAhXy5lbXB0eSh0aGlzLmFjdGl2ZV9wYXJlbnRfc2VjdGlvbikgKSB7CgkJCQkJCXRoaXMuYWN0aXZlX3BhcmVudF9zZWN0aW9uLmNsZWFudXAoKTsKCQkJCQkJdGhpcy5jbGVhclBhcmVudFNlY3Rpb25JbnRlcnZhbHMoKTsKCQkJCQl9CgkJCQkJdGhpcy5hY3RpdmVfcGFyZW50X3NlY3Rpb24gPSB0aGlzLnNlY3Rpb25zW3NlY3Rpb25fbmFtZV0uZ2V0UGFyZW50U2VjdGlvbigpOwoJCQkJCXZhciBwYXJlbnRTZWN0aW9uID0gdGhpcy5zZWN0aW9uc1tzZWN0aW9uX25hbWVdLmdldFBhcmVudFNlY3Rpb24oKTsKCQkJCQl0aGlzLnNlY3Rpb25zW3BhcmVudFNlY3Rpb25dLnJ1bkNhbGxiYWNrKCk7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmFjdGl2ZV9wYXJlbnRfc2VjdGlvbiA9IG51bGw7CgkJCQl0aGlzLmNsZWFyUGFyZW50U2VjdGlvbkludGVydmFscygpOwoJCQl9CgkJfSwKCgkJJ2NsZWFyUGFyZW50U2VjdGlvbkludGVydmFscyc6IGZ1bmN0aW9uKCkgewoJCQlfLmVhY2godGhpcy5hY3RpdmVfcGFyZW50X3NlY3Rpb25faW50ZXJ2YWxzLCBmdW5jdGlvbihpbnRlcnZhbF9pZCkgewoJCQkJY2xlYXJJbnRlcnZhbChpbnRlcnZhbF9pZCk7CgkJCX0pOwoJCX0sCgoJCSdpbml0Um91dGVzJzogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJdGhpcy5sb2coJ0luaXRpYWxpemluZyByb3V0ZXMuLi4nKTsKCQkJaWYgKCB0aGlzLnJvdXRlc19pbml0aWFsaXplZCApIHsKCQkJCXJldHVybjsKCQkJfQoJCQl0aGlzLnJvdXRlc19pbml0aWFsaXplZCA9IHRydWU7CgkJCXRoaXMucm91dGVyID0gbmV3IFJvdXRlcih0aGlzKTsKCQkJdGhpcy5yb3V0ZXIuYmluZCgnb25fcm91dGUnLCB0aGlzLm9uUm91dGUuYmluZCh0aGlzKSk7CgkJCXRoaXMucm91dGVyLmxpc3RlbigpOwoJCX0sCgoJCSdvblJvdXRlJzogZnVuY3Rpb24oZGF0YSkgewoJCQl0aGlzLmxvZygnb25Sb3V0ZScsIGRhdGEpOwoJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCWlmICggIXRoaXMuc2VjdGlvbnNbZGF0YS5zZWN0aW9uX25hbWVdICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCXZhciBzZWN0aW9uID0gdGhpcy5zZWN0aW9uc1tkYXRhLnNlY3Rpb25fbmFtZV0sCgkJCQlyb3V0ZTsKCQkJaWYgKCAhZGF0YS5yb3V0ZV9uYW1lICkgewoJCQkJcm91dGUgPSBzZWN0aW9uLmdldERlZmF1bHRSb3V0ZSgpOwoJCQl9IGVsc2UgewoJCQkJcm91dGUgPSBzZWN0aW9uLmdldFJvdXRlKGRhdGEucm91dGVfbmFtZSk7CgkJCX0KCQkJaWYgKCAhcm91dGUgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCV8uZWFjaChzZWxmLmFjdGl2ZV9zZWN0aW9uX2ludGVydmFscywgZnVuY3Rpb24oaW50ZXJ2YWxfaWQpIHsKCQkJCWNsZWFySW50ZXJ2YWwoaW50ZXJ2YWxfaWQpOwoJCQl9KTsKCgkJCXZhciBwcmV2aW91c1JvdXRlID0gdGhpcy5nZXRBY3RpdmVSb3V0ZSgpOwoJCQlpZiAoIHByZXZpb3VzUm91dGUgKSB7CgkJCQlwcmV2aW91c1JvdXRlLmNsZWFudXAoKTsKCQkJCV8uZWFjaCh0aGlzLmNsZWFudXBFeHRlbmRlcnMsIGZ1bmN0aW9uKGNlKSB7CgkJCQkJY2UuY2FsbChwcmV2aW91c1JvdXRlLmdldFNhbmRib3goKSk7CgkJCQl9KTsKCQkJfQoKCQkJdmFyIHByZXZpb3VzU2VjdGlvbiA9IHRoaXMuZ2V0QWN0aXZlU2VjdGlvbigpOwoJCQlpZiAoIHByZXZpb3VzU2VjdGlvbiApIHsKCQkJCWlmICggcHJldmlvdXNTZWN0aW9uLmdldE5hbWUoKSAhPT0gZGF0YS5zZWN0aW9uX25hbWUgKSB7CgkJCQkJcHJldmlvdXNTZWN0aW9uLmNsZWFudXAoKTsKCQkJCX0KCQkJfQoKCQkJdGhpcy5jaGVja1BhcmVudFNlY3Rpb24oZGF0YS5zZWN0aW9uX25hbWUpOwoJCQlyb3V0ZS5pbml0KGRhdGEucm91dGVfaWQsIGZ1bmN0aW9uKGVycikgewoJCQkJaWYgKCBlcnIgKSB7CgkJCQkJLy8gdG9kbyAtID8KCQkJCX0KCQkJfSk7CgkJfSwKCgkJJ25hdmlnYXRlJzogZnVuY3Rpb24ocm91dGUsIGxlYXZlX2hpc3RvcnkpIHsKCQkJdmFyIG9wdHMgPSB7CgkJCQl0cmlnZ2VyOiB0cnVlLAoJCQkJcmVwbGFjZSA6IGxlYXZlX2hpc3RvcnkKCQkJfTsKCQkJdGhpcy5Sb3V0ZXMubmF2aWdhdGUocm91dGUsIG9wdHMpOwoJCX0sCgoJCSdzZXRBY3RpdmVTZWN0aW9uJzogZnVuY3Rpb24oc2VjdGlvbikgewoJCQl0aGlzLmFjdGl2ZV9zZWN0aW9uID0gc2VjdGlvbjsKCQl9LAoKCQknc2V0QWN0aXZlUm91dGUnOiBmdW5jdGlvbihyb3V0ZSkgewoJCQl0aGlzLmFjdGl2ZV9yb3V0ZSA9IHJvdXRlOwoJCX0sCgoJCSdnZXREZWJ1Zyc6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5kZWJ1ZzsKCQl9LAoKCQknZ2V0QWN0aXZlU2VjdGlvbic6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5hY3RpdmVfc2VjdGlvbjsKCQl9LAoKCQknZ2V0QWN0aXZlUm91dGUnOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuYWN0aXZlX3JvdXRlOwoJCX0sCgoJCSdjcmVhdGVTZWN0aW9uSW50ZXJ2YWwnOiBmdW5jdGlvbihmbiwgaW50ZXJ2YWwpIHsKCQkJdGhpcy5hY3RpdmVfc2VjdGlvbl9pbnRlcnZhbHMucHVzaChzZXRJbnRlcnZhbChmbiwgaW50ZXJ2YWwpKTsKCQl9LAoKCQknY3JlYXRlUGFyZW50U2VjdGlvbkludGVydmFsJzogZnVuY3Rpb24oZm4sIGludGVydmFsKSB7CgkJCXRoaXMuYWN0aXZlX3BhcmVudF9zZWN0aW9uX2ludGVydmFscy5wdXNoKHNldEludGVydmFsKGZuLCBpbnRlcnZhbCkpOwoJCX0sCgoJCSdnZXRSb3V0ZXMnOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuUm91dGVzOwoJCX0sCgoJCSdpbnNlcnRTZWN0aW9uVGVtcGxhdGUnOiBmdW5jdGlvbih0ZW1wbGF0ZSkgewoJCQl0aGlzLnJvdXRlX2NvbnRhaW5lci5pbm5lckhUTUwgPSAnJzsKCQkJdGhpcy5yb3V0ZV9jb250YWluZXIuYXBwZW5kQ2hpbGQodGVtcGxhdGUpOwoJCX0sCgoJCSdpbnNlcnRUZW1wbGF0ZSc6IGZ1bmN0aW9uKHRlbXBsYXRlKSB7CgkJCXZhciBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncm91dGUnKTsKCQkJY29udGFpbmVyLmlubmVySFRNTCA9ICcnOwoJCQljb250YWluZXIuYXBwZW5kQ2hpbGQodGVtcGxhdGUpOwoJCX0sCgoJCSdleHRlbmQnOiBmdW5jdGlvbihleHQpIHsKCQkJaWYgKCAhXy5pc09iamVjdChleHQpICkgewoJCQkJdGhyb3cgJ0ludmFsaWQgZXh0ZW5zaW9uKHMpIHNwZWNpZmllZDogZXhwZWN0ZWQgYW4gb2JqZWN0Lic7CgkJCX0KCQkJdGhpcy5yb3V0ZV9leHRlbnNpb25zLnB1c2goZXh0KTsKCQl9LAoKCQknZ2V0Um91dGVFeHRlbnNpb25zJzogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnJvdXRlX2V4dGVuc2lvbnM7CgkJfSwKCgkJJ2NsZWFudXBFeHRlbmRlcnMnOiBbXSwKCgkJJ2V4dGVuZENsZWFudXAnOiBmdW5jdGlvbihmbikgewoJCQlpZiAoICFfLmlzRnVuY3Rpb24oZm4pICkgewoJCQkJdGhyb3cgJ2V4dGVuZENsZWFudXAgZXhwZWN0cyBhIHNpbmdsZSBwYXJhbWV0ZXI6IGEgY2FsbGJhY2sgZnVuY3Rpb24uJzsKCQkJfQoJCQl0aGlzLmNsZWFudXBFeHRlbmRlcnMucHVzaChmbik7CgkJfQoKCX0pOwoKCXJldHVybiBFZGlzb247Cgp9KTsKCi8qKgogKiBAcGFja2FnZSBFZGlzb24KICovCmRlZmluZSgnZWRpc29uJywgWydyZXF1aXJlJywnLi9saWIvZWRpc29uJ10sZnVuY3Rpb24ocmVxdWlyZSkgewoJcmV0dXJuIHJlcXVpcmUoJy4vbGliL2VkaXNvbicpOwp9KTsKCmRlZmluZSgiZWRpc29uL21haW4iLCBmdW5jdGlvbigpe30pOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 22:26:13 GMT",
                    "Content-Length": "61166",
                    "Date": "Thu, 06 Nov 2014 22:26:14 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}