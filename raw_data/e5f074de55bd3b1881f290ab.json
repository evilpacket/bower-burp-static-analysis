{
    "url": "http://localhost:9999/wenzhixin/bootstrap-table/docs/assets/table-export/html2canvas.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>window.location.href</b> and written to <b>the 'href' property of a DOM element</b> via the following statement:<ul><li>link.href = window.location.href;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/wenzhixin/bootstrap-table/docs/assets/table-export/html2canvas.js",
                "path": "/wenzhixin/bootstrap-table/docs/assets/table-export/html2canvas.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC93ZW56aGl4aW4vYm9vdHN0cmFwLXRhYmxlL2RvY3MvYXNzZXRzL3RhYmxlLWV4cG9ydC9odG1sMmNhbnZhcy5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogOTM2NDANCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMTM6Mzc6MTkgR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDEzOjM3OjE2IEdNVA0KDQovKgogIGh0bWwyY2FudmFzIDAuNC4xIDxodHRwOi8vaHRtbDJjYW52YXMuaGVydHplbi5jb20+CiAgQ29weXJpZ2h0IChjKSAyMDEzIE5pa2xhcyB2b24gSGVydHplbgoKICBSZWxlYXNlZCB1bmRlciBNSVQgTGljZW5zZQoqLwoKKGZ1bmN0aW9uKHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCl7CgovLyJ1c2Ugc3RyaWN0IjsKCnZhciBfaHRtbDJjYW52YXMgPSB7fSwKcHJldmlvdXNFbGVtZW50LApjb21wdXRlZENTUywKaHRtbDJjYW52YXM7CgpfaHRtbDJjYW52YXMuVXRpbCA9IHt9OwoKX2h0bWwyY2FudmFzLlV0aWwubG9nID0gZnVuY3Rpb24oYSkgewogIGlmIChfaHRtbDJjYW52YXMubG9nZ2luZyAmJiB3aW5kb3cuY29uc29sZSAmJiB3aW5kb3cuY29uc29sZS5sb2cpIHsKICAgIHdpbmRvdy5jb25zb2xlLmxvZyhhKTsKICB9Cn07CgpfaHRtbDJjYW52YXMuVXRpbC50cmltVGV4dCA9IChmdW5jdGlvbihpc05hdGl2ZSl7CiAgcmV0dXJuIGZ1bmN0aW9uKGlucHV0KSB7CiAgICByZXR1cm4gaXNOYXRpdmUgPyBpc05hdGl2ZS5hcHBseShpbnB1dCkgOiAoKGlucHV0IHx8ICcnKSArICcnKS5yZXBsYWNlKCAvXlxzK3xccyskL2cgLCAnJyApOwogIH07Cn0pKFN0cmluZy5wcm90b3R5cGUudHJpbSk7CgpfaHRtbDJjYW52YXMuVXRpbC5hc0Zsb2F0ID0gZnVuY3Rpb24odikgewogIHJldHVybiBwYXJzZUZsb2F0KHYpOwp9OwoKKGZ1bmN0aW9uKCkgewogIC8vIFRPRE86IHN1cHBvcnQgYWxsIHBvc3NpYmxlIGxlbmd0aCB2YWx1ZXMKICB2YXIgVEVYVF9TSEFET1dfUFJPUEVSVFkgPSAvKChyZ2JhfHJnYilcKFteXCldK1wpKFxzLT9cZCtweCl7MCx9KS9nOwogIHZhciBURVhUX1NIQURPV19WQUxVRVMgPSAvKC0/XGQrcHgpfCgjLispfChyZ2JcKC4rXCkpfChyZ2JhXCguK1wpKS9nOwogIF9odG1sMmNhbnZhcy5VdGlsLnBhcnNlVGV4dFNoYWRvd3MgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgIGlmICghdmFsdWUgfHwgdmFsdWUgPT09ICdub25lJykgewogICAgICByZXR1cm4gW107CiAgICB9CgogICAgLy8gZmluZCBtdWx0aXBsZSBzaGFkb3cgZGVjbGFyYXRpb25zCiAgICB2YXIgc2hhZG93cyA9IHZhbHVlLm1hdGNoKFRFWFRfU0hBRE9XX1BST1BFUlRZKSwKICAgICAgcmVzdWx0cyA9IFtdOwogICAgZm9yICh2YXIgaSA9IDA7IHNoYWRvd3MgJiYgKGkgPCBzaGFkb3dzLmxlbmd0aCk7IGkrKykgewogICAgICB2YXIgcyA9IHNoYWRvd3NbaV0ubWF0Y2goVEVYVF9TSEFET1dfVkFMVUVTKTsKICAgICAgcmVzdWx0cy5wdXNoKHsKICAgICAgICBjb2xvcjogc1swXSwKICAgICAgICBvZmZzZXRYOiBzWzFdID8gc1sxXS5yZXBsYWNlKCdweCcsICcnKSA6IDAsCiAgICAgICAgb2Zmc2V0WTogc1syXSA/IHNbMl0ucmVwbGFjZSgncHgnLCAnJykgOiAwLAogICAgICAgIGJsdXI6IHNbM10gPyBzWzNdLnJlcGxhY2UoJ3B4JywgJycpIDogMAogICAgICB9KTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH07Cn0pKCk7CgpfaHRtbDJjYW52YXMuVXRpbC5wYXJzZUJhY2tncm91bmRJbWFnZSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgdmFyIHdoaXRlc3BhY2UgPSAnIFxyXG5cdCcsCiAgICAgICAgbWV0aG9kLCBkZWZpbml0aW9uLCBwcmVmaXgsIHByZWZpeF9pLCBibG9jaywgcmVzdWx0cyA9IFtdLAogICAgICAgIGMsIG1vZGUgPSAwLCBudW1QYXJlbiA9IDAsIHF1b3RlLCBhcmdzOwoKICAgIHZhciBhcHBlbmRSZXN1bHQgPSBmdW5jdGlvbigpewogICAgICAgIGlmKG1ldGhvZCkgewogICAgICAgICAgICBpZihkZWZpbml0aW9uLnN1YnN0ciggMCwgMSApID09PSAnIicpIHsKICAgICAgICAgICAgICAgIGRlZmluaXRpb24gPSBkZWZpbml0aW9uLnN1YnN0ciggMSwgZGVmaW5pdGlvbi5sZW5ndGggLSAyICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoZGVmaW5pdGlvbikgewogICAgICAgICAgICAgICAgYXJncy5wdXNoKGRlZmluaXRpb24pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG1ldGhvZC5zdWJzdHIoIDAsIDEgKSA9PT0gJy0nICYmCiAgICAgICAgICAgICAgICAgICAgKHByZWZpeF9pID0gbWV0aG9kLmluZGV4T2YoICctJywgMSApICsgMSkgPiAwKSB7CiAgICAgICAgICAgICAgICBwcmVmaXggPSBtZXRob2Quc3Vic3RyKCAwLCBwcmVmaXhfaSk7CiAgICAgICAgICAgICAgICBtZXRob2QgPSBtZXRob2Quc3Vic3RyKCBwcmVmaXhfaSApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc3VsdHMucHVzaCh7CiAgICAgICAgICAgICAgICBwcmVmaXg6IHByZWZpeCwKICAgICAgICAgICAgICAgIG1ldGhvZDogbWV0aG9kLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgICAgICB2YWx1ZTogYmxvY2ssCiAgICAgICAgICAgICAgICBhcmdzOiBhcmdzCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBhcmdzID0gW107IC8vZm9yIHNvbWUgb2RkIHJlYXNvbiwgc2V0dGluZyAubGVuZ3RoID0gMCBkaWRuJ3Qgd29yayBpbiBzYWZhcmkKICAgICAgICBtZXRob2QgPQogICAgICAgICAgICBwcmVmaXggPQogICAgICAgICAgICBkZWZpbml0aW9uID0KICAgICAgICAgICAgYmxvY2sgPSAnJzsKICAgIH07CgogICAgYXBwZW5kUmVzdWx0KCk7CiAgICBmb3IodmFyIGkgPSAwLCBpaSA9IHZhbHVlLmxlbmd0aDsgaTxpaTsgaSsrKSB7CiAgICAgICAgYyA9IHZhbHVlW2ldOwogICAgICAgIGlmKG1vZGUgPT09IDAgJiYgd2hpdGVzcGFjZS5pbmRleE9mKCBjICkgPiAtMSl7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBzd2l0Y2goYykgewogICAgICAgICAgICBjYXNlICciJzoKICAgICAgICAgICAgICAgIGlmKCFxdW90ZSkgewogICAgICAgICAgICAgICAgICAgIHF1b3RlID0gYzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYocXVvdGUgPT09IGMpIHsKICAgICAgICAgICAgICAgICAgICBxdW90ZSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJygnOgogICAgICAgICAgICAgICAgaWYocXVvdGUpIHsgYnJlYWs7IH0KICAgICAgICAgICAgICAgIGVsc2UgaWYobW9kZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIG1vZGUgPSAxOwogICAgICAgICAgICAgICAgICAgIGJsb2NrICs9IGM7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG51bVBhcmVuKys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJyknOgogICAgICAgICAgICAgICAgaWYocXVvdGUpIHsgYnJlYWs7IH0KICAgICAgICAgICAgICAgIGVsc2UgaWYobW9kZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgIGlmKG51bVBhcmVuID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGUgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBibG9jayArPSBjOwogICAgICAgICAgICAgICAgICAgICAgICBhcHBlbmRSZXN1bHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbnVtUGFyZW4tLTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJywnOgogICAgICAgICAgICAgICAgaWYocXVvdGUpIHsgYnJlYWs7IH0KICAgICAgICAgICAgICAgIGVsc2UgaWYobW9kZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGFwcGVuZFJlc3VsdCgpOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAobW9kZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgIGlmKG51bVBhcmVuID09PSAwICYmICFtZXRob2QubWF0Y2goL151cmwkL2kpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaChkZWZpbml0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVmaW5pdGlvbiA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICBibG9jayArPSBjOwogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIGJsb2NrICs9IGM7CiAgICAgICAgaWYobW9kZSA9PT0gMCkgeyBtZXRob2QgKz0gYzsgfQogICAgICAgIGVsc2UgeyBkZWZpbml0aW9uICs9IGM7IH0KICAgIH0KICAgIGFwcGVuZFJlc3VsdCgpOwoKICAgIHJldHVybiByZXN1bHRzOwp9OwoKX2h0bWwyY2FudmFzLlV0aWwuQm91bmRzID0gZnVuY3Rpb24gKGVsZW1lbnQpIHsKICB2YXIgY2xpZW50UmVjdCwgYm91bmRzID0ge307CgogIGlmIChlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCl7CiAgICBjbGllbnRSZWN0ID0gZWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKCiAgICAvLyBUT0RPIGFkZCBzY3JvbGwgcG9zaXRpb24gdG8gYm91bmRzLCBzbyBubyBzY3JvbGxpbmcgb2Ygd2luZG93IG5lY2Vzc2FyeQogICAgYm91bmRzLnRvcCA9IGNsaWVudFJlY3QudG9wOwogICAgYm91bmRzLmJvdHRvbSA9IGNsaWVudFJlY3QuYm90dG9tIHx8IChjbGllbnRSZWN0LnRvcCArIGNsaWVudFJlY3QuaGVpZ2h0KTsKICAgIGJvdW5kcy5sZWZ0ID0gY2xpZW50UmVjdC5sZWZ0OwoKICAgIGJvdW5kcy53aWR0aCA9IGVsZW1lbnQub2Zmc2V0V2lkdGg7CiAgICBib3VuZHMuaGVpZ2h0ID0gZWxlbWVudC5vZmZzZXRIZWlnaHQ7CiAgfQoKICByZXR1cm4gYm91bmRzOwp9OwoKLy8gVE9ETyBpZGVhbGx5LCB3ZSdkIHdhbnQgZXZlcnl0aGluZyB0byBnbyB0aHJvdWdoIHRoaXMgZnVuY3Rpb24gaW5zdGVhZCBvZiBVdGlsLkJvdW5kcywKLy8gYnV0IHdvdWxkIHJlcXVpcmUgZnVydGhlciB3b3JrIHRvIGNhbGN1bGF0ZSB0aGUgY29ycmVjdCBwb3NpdGlvbnMgZm9yIGVsZW1lbnRzIHdpdGggb2Zmc2V0UGFyZW50cwpfaHRtbDJjYW52YXMuVXRpbC5PZmZzZXRCb3VuZHMgPSBmdW5jdGlvbiAoZWxlbWVudCkgewogIHZhciBwYXJlbnQgPSBlbGVtZW50Lm9mZnNldFBhcmVudCA/IF9odG1sMmNhbnZhcy5VdGlsLk9mZnNldEJvdW5kcyhlbGVtZW50Lm9mZnNldFBhcmVudCkgOiB7dG9wOiAwLCBsZWZ0OiAwfTsKCiAgcmV0dXJuIHsKICAgIHRvcDogZWxlbWVudC5vZmZzZXRUb3AgKyBwYXJlbnQudG9wLAogICAgYm90dG9tOiBlbGVtZW50Lm9mZnNldFRvcCArIGVsZW1lbnQub2Zmc2V0SGVpZ2h0ICsgcGFyZW50LnRvcCwKICAgIGxlZnQ6IGVsZW1lbnQub2Zmc2V0TGVmdCArIHBhcmVudC5sZWZ0LAogICAgd2lkdGg6IGVsZW1lbnQub2Zmc2V0V2lkdGgsCiAgICBoZWlnaHQ6IGVsZW1lbnQub2Zmc2V0SGVpZ2h0CiAgfTsKfTsKCmZ1bmN0aW9uIHRvUFgoZWxlbWVudCwgYXR0cmlidXRlLCB2YWx1ZSApIHsKICAgIHZhciByc0xlZnQgPSBlbGVtZW50LnJ1bnRpbWVTdHlsZSAmJiBlbGVtZW50LnJ1bnRpbWVTdHlsZVthdHRyaWJ1dGVdLAogICAgICAgIGxlZnQsCiAgICAgICAgc3R5bGUgPSBlbGVtZW50LnN0eWxlOwoKICAgIC8vIENoZWNrIGlmIHdlIGFyZSBub3QgZGVhbGluZyB3aXRoIHBpeGVscywgKE9wZXJhIGhhcyBpc3N1ZXMgd2l0aCB0aGlzKQogICAgLy8gUG9ydGVkIGZyb20galF1ZXJ5IGNzcy5qcwogICAgLy8gRnJvbSB0aGUgYXdlc29tZSBoYWNrIGJ5IERlYW4gRWR3YXJkcwogICAgLy8gaHR0cDovL2VyaWsuZWFlLm5ldC9hcmNoaXZlcy8yMDA3LzA3LzI3LzE4LjU0LjE1LyNjb21tZW50LTEwMjI5MQoKICAgIC8vIElmIHdlJ3JlIG5vdCBkZWFsaW5nIHdpdGggYSByZWd1bGFyIHBpeGVsIG51bWJlcgogICAgLy8gYnV0IGEgbnVtYmVyIHRoYXQgaGFzIGEgd2VpcmQgZW5kaW5nLCB3ZSBuZWVkIHRvIGNvbnZlcnQgaXQgdG8gcGl4ZWxzCgogICAgaWYgKCAhL14tP1swLTldK1wuP1swLTldKig/OnB4KT8kL2kudGVzdCggdmFsdWUgKSAmJiAvXi0/XGQvLnRlc3QodmFsdWUpICkgewogICAgICAgIC8vIFJlbWVtYmVyIHRoZSBvcmlnaW5hbCB2YWx1ZXMKICAgICAgICBsZWZ0ID0gc3R5bGUubGVmdDsKCiAgICAgICAgLy8gUHV0IGluIHRoZSBuZXcgdmFsdWVzIHRvIGdldCBhIGNvbXB1dGVkIHZhbHVlIG91dAogICAgICAgIGlmIChyc0xlZnQpIHsKICAgICAgICAgICAgZWxlbWVudC5ydW50aW1lU3R5bGUubGVmdCA9IGVsZW1lbnQuY3VycmVudFN0eWxlLmxlZnQ7CiAgICAgICAgfQogICAgICAgIHN0eWxlLmxlZnQgPSBhdHRyaWJ1dGUgPT09ICJmb250U2l6ZSIgPyAiMWVtIiA6ICh2YWx1ZSB8fCAwKTsKICAgICAgICB2YWx1ZSA9IHN0eWxlLnBpeGVsTGVmdCArICJweCI7CgogICAgICAgIC8vIFJldmVydCB0aGUgY2hhbmdlZCB2YWx1ZXMKICAgICAgICBzdHlsZS5sZWZ0ID0gbGVmdDsKICAgICAgICBpZiAocnNMZWZ0KSB7CiAgICAgICAgICAgIGVsZW1lbnQucnVudGltZVN0eWxlLmxlZnQgPSByc0xlZnQ7CiAgICAgICAgfQogICAgfQoKICAgIGlmICghL14odGhpbnxtZWRpdW18dGhpY2spJC9pLnRlc3QodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQocGFyc2VGbG9hdCh2YWx1ZSkpICsgInB4IjsKICAgIH0KCiAgICByZXR1cm4gdmFsdWU7Cn0KCmZ1bmN0aW9uIGFzSW50KHZhbCkgewogICAgcmV0dXJuIHBhcnNlSW50KHZhbCwgMTApOwp9CgpmdW5jdGlvbiBpc1BlcmNlbnRhZ2UodmFsdWUpIHsKICByZXR1cm4gdmFsdWUudG9TdHJpbmcoKS5pbmRleE9mKCIlIikgIT09IC0xOwp9CgpmdW5jdGlvbiBwYXJzZUJhY2tncm91bmRTaXplUG9zaXRpb24odmFsdWUsIGVsZW1lbnQsIGF0dHJpYnV0ZSwgaW5kZXgpIHsKICAgIHZhbHVlID0gKHZhbHVlIHx8ICcnKS5zcGxpdCgnLCcpOwogICAgdmFsdWUgPSB2YWx1ZVtpbmRleCB8fCAwXSB8fCB2YWx1ZVswXSB8fCAnYXV0byc7CiAgICB2YWx1ZSA9IF9odG1sMmNhbnZhcy5VdGlsLnRyaW1UZXh0KHZhbHVlKS5zcGxpdCgnICcpOwogICAgaWYoYXR0cmlidXRlID09PSAnYmFja2dyb3VuZFNpemUnICYmICh2YWx1ZVswXSAmJiB2YWx1ZVswXS5tYXRjaCgvXihjb3Zlcnxjb250YWlufGF1dG8pJC8pKSkgewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0gZWxzZSB7CiAgICAgICAgdmFsdWVbMF0gPSAodmFsdWVbMF0uaW5kZXhPZiggIiUiICkgPT09IC0xKSA/IHRvUFgoZWxlbWVudCwgYXR0cmlidXRlICsgIlgiLCB2YWx1ZVswXSkgOiB2YWx1ZVswXTsKICAgICAgICBpZih2YWx1ZVsxXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGlmKGF0dHJpYnV0ZSA9PT0gJ2JhY2tncm91bmRTaXplJykgewogICAgICAgICAgICAgICAgdmFsdWVbMV0gPSAnYXV0byc7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBJRSA5IGRvZXNuJ3QgcmV0dXJuIGRvdWJsZSBkaWdpdCBhbHdheXMKICAgICAgICAgICAgICAgIHZhbHVlWzFdID0gdmFsdWVbMF07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFsdWVbMV0gPSAodmFsdWVbMV0uaW5kZXhPZigiJSIpID09PSAtMSkgPyB0b1BYKGVsZW1lbnQsIGF0dHJpYnV0ZSArICJZIiwgdmFsdWVbMV0pIDogdmFsdWVbMV07CiAgICB9CiAgICByZXR1cm4gdmFsdWU7Cn0KCl9odG1sMmNhbnZhcy5VdGlsLmdldENTUyA9IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRyaWJ1dGUsIGluZGV4KSB7CiAgICBpZiAocHJldmlvdXNFbGVtZW50ICE9PSBlbGVtZW50KSB7CiAgICAgIGNvbXB1dGVkQ1NTID0gZG9jdW1lbnQuZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50LCBudWxsKTsKICAgIH0KCiAgICB2YXIgdmFsdWUgPSBjb21wdXRlZENTU1thdHRyaWJ1dGVdOwoKICAgIGlmICgvXmJhY2tncm91bmQoU2l6ZXxQb3NpdGlvbikkLy50ZXN0KGF0dHJpYnV0ZSkpIHsKICAgICAgICByZXR1cm4gcGFyc2VCYWNrZ3JvdW5kU2l6ZVBvc2l0aW9uKHZhbHVlLCBlbGVtZW50LCBhdHRyaWJ1dGUsIGluZGV4KTsKICAgIH0gZWxzZSBpZiAoL2JvcmRlcihUb3B8Qm90dG9tKShMZWZ0fFJpZ2h0KVJhZGl1cy8udGVzdChhdHRyaWJ1dGUpKSB7CiAgICAgIHZhciBhcnIgPSB2YWx1ZS5zcGxpdCgiICIpOwogICAgICBpZiAoYXJyLmxlbmd0aCA8PSAxKSB7CiAgICAgICAgICBhcnJbMV0gPSBhcnJbMF07CiAgICAgIH0KICAgICAgcmV0dXJuIGFyci5tYXAoYXNJbnQpOwogICAgfQoKICByZXR1cm4gdmFsdWU7Cn07CgpfaHRtbDJjYW52YXMuVXRpbC5yZXNpemVCb3VuZHMgPSBmdW5jdGlvbiggY3VycmVudF93aWR0aCwgY3VycmVudF9oZWlnaHQsIHRhcmdldF93aWR0aCwgdGFyZ2V0X2hlaWdodCwgc3RyZXRjaF9tb2RlICl7CiAgdmFyIHRhcmdldF9yYXRpbyA9IHRhcmdldF93aWR0aCAvIHRhcmdldF9oZWlnaHQsCiAgICBjdXJyZW50X3JhdGlvID0gY3VycmVudF93aWR0aCAvIGN1cnJlbnRfaGVpZ2h0LAogICAgb3V0cHV0X3dpZHRoLCBvdXRwdXRfaGVpZ2h0OwoKICBpZighc3RyZXRjaF9tb2RlIHx8IHN0cmV0Y2hfbW9kZSA9PT0gJ2F1dG8nKSB7CiAgICBvdXRwdXRfd2lkdGggPSB0YXJnZXRfd2lkdGg7CiAgICBvdXRwdXRfaGVpZ2h0ID0gdGFyZ2V0X2hlaWdodDsKICB9IGVsc2UgaWYodGFyZ2V0X3JhdGlvIDwgY3VycmVudF9yYXRpbyBeIHN0cmV0Y2hfbW9kZSA9PT0gJ2NvbnRhaW4nKSB7CiAgICBvdXRwdXRfaGVpZ2h0ID0gdGFyZ2V0X2hlaWdodDsKICAgIG91dHB1dF93aWR0aCA9IHRhcmdldF9oZWlnaHQgKiBjdXJyZW50X3JhdGlvOwogIH0gZWxzZSB7CiAgICBvdXRwdXRfd2lkdGggPSB0YXJnZXRfd2lkdGg7CiAgICBvdXRwdXRfaGVpZ2h0ID0gdGFyZ2V0X3dpZHRoIC8gY3VycmVudF9yYXRpbzsKICB9CgogIHJldHVybiB7CiAgICB3aWR0aDogb3V0cHV0X3dpZHRoLAogICAgaGVpZ2h0OiBvdXRwdXRfaGVpZ2h0CiAgfTsKfTsKCl9odG1sMmNhbnZhcy5VdGlsLkJhY2tncm91bmRQb3NpdGlvbiA9IGZ1bmN0aW9uKGVsZW1lbnQsIGJvdW5kcywgaW1hZ2UsIGltYWdlSW5kZXgsIGJhY2tncm91bmRTaXplICkgewogICAgdmFyIGJhY2tncm91bmRQb3NpdGlvbiA9ICBfaHRtbDJjYW52YXMuVXRpbC5nZXRDU1MoZWxlbWVudCwgJ2JhY2tncm91bmRQb3NpdGlvbicsIGltYWdlSW5kZXgpLAogICAgICAgIGxlZnRQb3NpdGlvbiwKICAgICAgICB0b3BQb3NpdGlvbjsKICAgIGlmIChiYWNrZ3JvdW5kUG9zaXRpb24ubGVuZ3RoID09PSAxKXsKICAgICAgICBiYWNrZ3JvdW5kUG9zaXRpb24gPSBbYmFja2dyb3VuZFBvc2l0aW9uWzBdLCBiYWNrZ3JvdW5kUG9zaXRpb25bMF1dOwogICAgfQoKICAgIGlmIChpc1BlcmNlbnRhZ2UoYmFja2dyb3VuZFBvc2l0aW9uWzBdKSl7CiAgICAgICAgbGVmdFBvc2l0aW9uID0gKGJvdW5kcy53aWR0aCAtIChiYWNrZ3JvdW5kU2l6ZSB8fCBpbWFnZSkud2lkdGgpICogKHBhcnNlRmxvYXQoYmFja2dyb3VuZFBvc2l0aW9uWzBdKSAvIDEwMCk7CiAgICB9IGVsc2UgewogICAgICAgIGxlZnRQb3NpdGlvbiA9IHBhcnNlSW50KGJhY2tncm91bmRQb3NpdGlvblswXSwgMTApOwogICAgfQoKICAgIGlmIChiYWNrZ3JvdW5kUG9zaXRpb25bMV0gPT09ICdhdXRvJykgewogICAgICAgIHRvcFBvc2l0aW9uID0gbGVmdFBvc2l0aW9uIC8gaW1hZ2Uud2lkdGggKiBpbWFnZS5oZWlnaHQ7CiAgICB9IGVsc2UgaWYgKGlzUGVyY2VudGFnZShiYWNrZ3JvdW5kUG9zaXRpb25bMV0pKXsKICAgICAgICB0b3BQb3NpdGlvbiA9ICAoYm91bmRzLmhlaWdodCAtIChiYWNrZ3JvdW5kU2l6ZSB8fCBpbWFnZSkuaGVpZ2h0KSAqIHBhcnNlRmxvYXQoYmFja2dyb3VuZFBvc2l0aW9uWzFdKSAvIDEwMDsKICAgIH0gZWxzZSB7CiAgICAgICAgdG9wUG9zaXRpb24gPSBwYXJzZUludChiYWNrZ3JvdW5kUG9zaXRpb25bMV0sIDEwKTsKICAgIH0KCiAgICBpZiAoYmFja2dyb3VuZFBvc2l0aW9uWzBdID09PSAnYXV0bycpIHsKICAgICAgICBsZWZ0UG9zaXRpb24gPSB0b3BQb3NpdGlvbiAvIGltYWdlLmhlaWdodCAqIGltYWdlLndpZHRoOwogICAgfQoKICAgIHJldHVybiB7bGVmdDogbGVmdFBvc2l0aW9uLCB0b3A6IHRvcFBvc2l0aW9ufTsKfTsKCl9odG1sMmNhbnZhcy5VdGlsLkJhY2tncm91bmRTaXplID0gZnVuY3Rpb24oZWxlbWVudCwgYm91bmRzLCBpbWFnZSwgaW1hZ2VJbmRleCkgewogIHZhciBiYWNrZ3JvdW5kU2l6ZSA9ICBfaHRtbDJjYW52YXMuVXRpbC5nZXRDU1MoZWxlbWVudCwgJ2JhY2tncm91bmRTaXplJywgaW1hZ2VJbmRleCksIHdpZHRoLCBoZWlnaHQ7CgogIGlmIChiYWNrZ3JvdW5kU2l6ZS5sZW5ndGggPT09IDEpIHsKICAgIGJhY2tncm91bmRTaXplID0gW2JhY2tncm91bmRTaXplWzBdLCBiYWNrZ3JvdW5kU2l6ZVswXV07CiAgfQoKICBpZiAoaXNQZXJjZW50YWdlKGJhY2tncm91bmRTaXplWzBdKSkgewogICAgd2lkdGggPSBib3VuZHMud2lkdGggKiBwYXJzZUZsb2F0KGJhY2tncm91bmRTaXplWzBdKSAvIDEwMDsKICB9IGVsc2UgaWYgKC9jb250YWlufGNvdmVyLy50ZXN0KGJhY2tncm91bmRTaXplWzBdKSkgewogICAgcmV0dXJuIF9odG1sMmNhbnZhcy5VdGlsLnJlc2l6ZUJvdW5kcyhpbWFnZS53aWR0aCwgaW1hZ2UuaGVpZ2h0LCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQsIGJhY2tncm91bmRTaXplWzBdKTsKICB9IGVsc2UgewogICAgd2lkdGggPSBwYXJzZUludChiYWNrZ3JvdW5kU2l6ZVswXSwgMTApOwogIH0KCiAgaWYgKGJhY2tncm91bmRTaXplWzBdID09PSAnYXV0bycgJiYgYmFja2dyb3VuZFNpemVbMV0gPT09ICdhdXRvJykgewogICAgaGVpZ2h0ID0gaW1hZ2UuaGVpZ2h0OwogIH0gZWxzZSBpZiAoYmFja2dyb3VuZFNpemVbMV0gPT09ICdhdXRvJykgewogICAgaGVpZ2h0ID0gd2lkdGggLyBpbWFnZS53aWR0aCAqIGltYWdlLmhlaWdodDsKICB9IGVsc2UgaWYgKGlzUGVyY2VudGFnZShiYWNrZ3JvdW5kU2l6ZVsxXSkpIHsKICAgIGhlaWdodCA9ICBib3VuZHMuaGVpZ2h0ICogcGFyc2VGbG9hdChiYWNrZ3JvdW5kU2l6ZVsxXSkgLyAxMDA7CiAgfSBlbHNlIHsKICAgIGhlaWdodCA9IHBhcnNlSW50KGJhY2tncm91bmRTaXplWzFdLCAxMCk7CiAgfQoKICBpZiAoYmFja2dyb3VuZFNpemVbMF0gPT09ICdhdXRvJykgewogICAgd2lkdGggPSBoZWlnaHQgLyBpbWFnZS5oZWlnaHQgKiBpbWFnZS53aWR0aDsKICB9CgogIHJldHVybiB7d2lkdGg6IHdpZHRoLCBoZWlnaHQ6IGhlaWdodH07Cn07CgpfaHRtbDJjYW52YXMuVXRpbC5CYWNrZ3JvdW5kUmVwZWF0ID0gZnVuY3Rpb24oZWxlbWVudCwgaW1hZ2VJbmRleCkgewogIHZhciBiYWNrZ3JvdW5kUmVwZWF0ID0gX2h0bWwyY2FudmFzLlV0aWwuZ2V0Q1NTKGVsZW1lbnQsICJiYWNrZ3JvdW5kUmVwZWF0Iikuc3BsaXQoIiwiKS5tYXAoX2h0bWwyY2FudmFzLlV0aWwudHJpbVRleHQpOwogIHJldHVybiBiYWNrZ3JvdW5kUmVwZWF0W2ltYWdlSW5kZXhdIHx8IGJhY2tncm91bmRSZXBlYXRbMF07Cn07CgpfaHRtbDJjYW52YXMuVXRpbC5FeHRlbmQgPSBmdW5jdGlvbiAob3B0aW9ucywgZGVmYXVsdHMpIHsKICBmb3IgKHZhciBrZXkgaW4gb3B0aW9ucykgewogICAgaWYgKG9wdGlvbnMuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICBkZWZhdWx0c1trZXldID0gb3B0aW9uc1trZXldOwogICAgfQogIH0KICByZXR1cm4gZGVmYXVsdHM7Cn07CgoKLyoKICogRGVyaXZlZCBmcm9tIGpRdWVyeS5jb250ZW50cygpCiAqIENvcHlyaWdodCAyMDEwLCBKb2huIFJlc2lnCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBvciBHUEwgVmVyc2lvbiAyIGxpY2Vuc2VzLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwpfaHRtbDJjYW52YXMuVXRpbC5DaGlsZHJlbiA9IGZ1bmN0aW9uKCBlbGVtICkgewogIHZhciBjaGlsZHJlbjsKICB0cnkgewogICAgY2hpbGRyZW4gPSAoZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvVXBwZXJDYXNlKCkgPT09ICJJRlJBTUUiKSA/IGVsZW0uY29udGVudERvY3VtZW50IHx8IGVsZW0uY29udGVudFdpbmRvdy5kb2N1bWVudCA6IChmdW5jdGlvbihhcnJheSkgewogICAgICB2YXIgcmV0ID0gW107CiAgICAgIGlmIChhcnJheSAhPT0gbnVsbCkgewogICAgICAgIChmdW5jdGlvbihmaXJzdCwgc2Vjb25kICkgewogICAgICAgICAgdmFyIGkgPSBmaXJzdC5sZW5ndGgsCiAgICAgICAgICBqID0gMDsKCiAgICAgICAgICBpZiAodHlwZW9mIHNlY29uZC5sZW5ndGggPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIGZvciAodmFyIGwgPSBzZWNvbmQubGVuZ3RoOyBqIDwgbDsgaisrKSB7CiAgICAgICAgICAgICAgZmlyc3RbaSsrXSA9IHNlY29uZFtqXTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd2hpbGUgKHNlY29uZFtqXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgZmlyc3RbaSsrXSA9IHNlY29uZFtqKytdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgZmlyc3QubGVuZ3RoID0gaTsKCiAgICAgICAgICByZXR1cm4gZmlyc3Q7CiAgICAgICAgfSkocmV0LCBhcnJheSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJldDsKICAgIH0pKGVsZW0uY2hpbGROb2Rlcyk7CgogIH0gY2F0Y2ggKGV4KSB7CiAgICBfaHRtbDJjYW52YXMuVXRpbC5sb2coImh0bWwyY2FudmFzLlV0aWwuQ2hpbGRyZW4gZmFpbGVkIHdpdGggZXhjZXB0aW9uOiAiICsgZXgubWVzc2FnZSk7CiAgICBjaGlsZHJlbiA9IFtdOwogIH0KICByZXR1cm4gY2hpbGRyZW47Cn07CgpfaHRtbDJjYW52YXMuVXRpbC5pc1RyYW5zcGFyZW50ID0gZnVuY3Rpb24oYmFja2dyb3VuZENvbG9yKSB7CiAgcmV0dXJuICghYmFja2dyb3VuZENvbG9yIHx8IGJhY2tncm91bmRDb2xvciA9PT0gInRyYW5zcGFyZW50IiB8fCBiYWNrZ3JvdW5kQ29sb3IgPT09ICJyZ2JhKDAsIDAsIDAsIDApIik7Cn07CgpfaHRtbDJjYW52YXMuVXRpbC5Gb250ID0gKGZ1bmN0aW9uICgpIHsKCiAgdmFyIGZvbnREYXRhID0ge307CgogIHJldHVybiBmdW5jdGlvbihmb250LCBmb250U2l6ZSwgZG9jKSB7CiAgICBpZiAoZm9udERhdGFbZm9udCArICItIiArIGZvbnRTaXplXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHJldHVybiBmb250RGF0YVtmb250ICsgIi0iICsgZm9udFNpemVdOwogICAgfQoKICAgIHZhciBjb250YWluZXIgPSBkb2MuY3JlYXRlRWxlbWVudCgnZGl2JyksCiAgICBpbWcgPSBkb2MuY3JlYXRlRWxlbWVudCgnaW1nJyksCiAgICBzcGFuID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKSwKICAgIHNhbXBsZVRleHQgPSAnSGlkZGVuIFRleHQnLAogICAgYmFzZWxpbmUsCiAgICBtaWRkbGUsCiAgICBtZXRyaWNzT2JqOwoKICAgIGNvbnRhaW5lci5zdHlsZS52aXNpYmlsaXR5ID0gImhpZGRlbiI7CiAgICBjb250YWluZXIuc3R5bGUuZm9udEZhbWlseSA9IGZvbnQ7CiAgICBjb250YWluZXIuc3R5bGUuZm9udFNpemUgPSBmb250U2l6ZTsKICAgIGNvbnRhaW5lci5zdHlsZS5tYXJnaW4gPSAwOwogICAgY29udGFpbmVyLnN0eWxlLnBhZGRpbmcgPSAwOwoKICAgIGRvYy5ib2R5LmFwcGVuZENoaWxkKGNvbnRhaW5lcik7CgogICAgLy8gaHR0cDovL3Byb2JhYmx5cHJvZ3JhbW1pbmcuY29tLzIwMDkvMDMvMTUvdGhlLXRpbmllc3QtZ2lmLWV2ZXIgKGhhbmR0aW55d2hpdGUuZ2lmKQogICAgaW1nLnNyYyA9ICJkYXRhOmltYWdlL2dpZjtiYXNlNjQsUjBsR09EbGhBUUFCQUlBQkFQLy8vd0FBQUN3QUFBQUFBUUFCQUFBQ0FrUUJBRHM9IjsKICAgIGltZy53aWR0aCA9IDE7CiAgICBpbWcuaGVpZ2h0ID0gMTsKCiAgICBpbWcuc3R5bGUubWFyZ2luID0gMDsKICAgIGltZy5zdHlsZS5wYWRkaW5nID0gMDsKICAgIGltZy5zdHlsZS52ZXJ0aWNhbEFsaWduID0gImJhc2VsaW5lIjsKCiAgICBzcGFuLnN0eWxlLmZvbnRGYW1pbHkgPSBmb250OwogICAgc3Bhbi5zdHlsZS5mb250U2l6ZSA9IGZvbnRTaXplOwogICAgc3Bhbi5zdHlsZS5tYXJnaW4gPSAwOwogICAgc3Bhbi5zdHlsZS5wYWRkaW5nID0gMDsKCiAgICBzcGFuLmFwcGVuZENoaWxkKGRvYy5jcmVhdGVUZXh0Tm9kZShzYW1wbGVUZXh0KSk7CiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoc3Bhbik7CiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoaW1nKTsKICAgIGJhc2VsaW5lID0gKGltZy5vZmZzZXRUb3AgLSBzcGFuLm9mZnNldFRvcCkgKyAxOwoKICAgIGNvbnRhaW5lci5yZW1vdmVDaGlsZChzcGFuKTsKICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChkb2MuY3JlYXRlVGV4dE5vZGUoc2FtcGxlVGV4dCkpOwoKICAgIGNvbnRhaW5lci5zdHlsZS5saW5lSGVpZ2h0ID0gIm5vcm1hbCI7CiAgICBpbWcuc3R5bGUudmVydGljYWxBbGlnbiA9ICJzdXBlciI7CgogICAgbWlkZGxlID0gKGltZy5vZmZzZXRUb3AtY29udGFpbmVyLm9mZnNldFRvcCkgKyAxOwogICAgbWV0cmljc09iaiA9IHsKICAgICAgYmFzZWxpbmU6IGJhc2VsaW5lLAogICAgICBsaW5lV2lkdGg6IDEsCiAgICAgIG1pZGRsZTogbWlkZGxlCiAgICB9OwoKICAgIGZvbnREYXRhW2ZvbnQgKyAiLSIgKyBmb250U2l6ZV0gPSBtZXRyaWNzT2JqOwoKICAgIGRvYy5ib2R5LnJlbW92ZUNoaWxkKGNvbnRhaW5lcik7CgogICAgcmV0dXJuIG1ldHJpY3NPYmo7CiAgfTsKfSkoKTsKCihmdW5jdGlvbigpewogIHZhciBVdGlsID0gX2h0bWwyY2FudmFzLlV0aWwsCiAgICBHZW5lcmF0ZSA9IHt9OwoKICBfaHRtbDJjYW52YXMuR2VuZXJhdGUgPSBHZW5lcmF0ZTsKCiAgdmFyIHJlR3JhZGllbnRzID0gWwogIC9eKC13ZWJraXQtbGluZWFyLWdyYWRpZW50KVwoKFthLXpcc10rKShbXHdcZFwuXHMsJVwoXCldKylcKSQvLAogIC9eKC1vLWxpbmVhci1ncmFkaWVudClcKChbYS16XHNdKykoW1x3XGRcLlxzLCVcKFwpXSspXCkkLywKICAvXigtd2Via2l0LWdyYWRpZW50KVwoKGxpbmVhcnxyYWRpYWwpLFxzKCg/OlxkezEsM30lPylccyg/OlxkezEsM30lPyksXHMoPzpcZHsxLDN9JT8pXHMoPzpcZHsxLDN9JT8pKShbXHdcZFwuXHMsJVwoXClcLV0rKVwpJC8sCiAgL14oLW1vei1saW5lYXItZ3JhZGllbnQpXCgoKD86XGR7MSwzfSU/KVxzKD86XGR7MSwzfSU/KSkoW1x3XGRcLlxzLCVcKFwpXSspXCkkLywKICAvXigtd2Via2l0LXJhZGlhbC1ncmFkaWVudClcKCgoPzpcZHsxLDN9JT8pXHMoPzpcZHsxLDN9JT8pKSxccyhcdyspXHMoW2EtelwtXSspKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sCiAgL14oLW1vei1yYWRpYWwtZ3JhZGllbnQpXCgoKD86XGR7MSwzfSU/KVxzKD86XGR7MSwzfSU/KSksXHMoXHcrKVxzPyhbYS16XC1dKikoW1x3XGRcLlxzLCVcKFwpXSspXCkkLywKICAvXigtby1yYWRpYWwtZ3JhZGllbnQpXCgoKD86XGR7MSwzfSU/KVxzKD86XGR7MSwzfSU/KSksXHMoXHcrKVxzKFthLXpcLV0rKShbXHdcZFwuXHMsJVwoXCldKylcKSQvCiAgXTsKCiAgLyoKICogVE9ETzogQWRkIElFMTAgdmVuZG9yIHByZWZpeCAoLW1zKSBzdXBwb3J0CiAqIFRPRE86IEFkZCBXM0MgZ3JhZGllbnQgKGxpbmVhci1ncmFkaWVudCkgc3VwcG9ydAogKiBUT0RPOiBBZGQgb2xkIFdlYmtpdCAtd2Via2l0LWdyYWRpZW50KHJhZGlhbCwgLi4uKSBzdXBwb3J0CiAqIFRPRE86IE1heWJlIHNvbWUgUmVnRXhwIG9wdGltaXphdGlvbnMgYXJlIHBvc3NpYmxlIDtvKQogKi8KICBHZW5lcmF0ZS5wYXJzZUdyYWRpZW50ID0gZnVuY3Rpb24oY3NzLCBib3VuZHMpIHsKICAgIHZhciBncmFkaWVudCwgaSwgbGVuID0gcmVHcmFkaWVudHMubGVuZ3RoLCBtMSwgc3RvcCwgbTIsIG0yTGVuLCBzdGVwLCBtMywgdGwsdHIsYnIsYmw7CgogICAgZm9yKGkgPSAwOyBpIDwgbGVuOyBpKz0xKXsKICAgICAgbTEgPSBjc3MubWF0Y2gocmVHcmFkaWVudHNbaV0pOwogICAgICBpZihtMSkgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgaWYobTEpIHsKICAgICAgc3dpdGNoKG0xWzFdKSB7CiAgICAgICAgY2FzZSAnLXdlYmtpdC1saW5lYXItZ3JhZGllbnQnOgogICAgICAgIGNhc2UgJy1vLWxpbmVhci1ncmFkaWVudCc6CgogICAgICAgICAgZ3JhZGllbnQgPSB7CiAgICAgICAgICAgIHR5cGU6ICdsaW5lYXInLAogICAgICAgICAgICB4MDogbnVsbCwKICAgICAgICAgICAgeTA6IG51bGwsCiAgICAgICAgICAgIHgxOiBudWxsLAogICAgICAgICAgICB5MTogbnVsbCwKICAgICAgICAgICAgY29sb3JTdG9wczogW10KICAgICAgICAgIH07CgogICAgICAgICAgLy8gZ2V0IGNvb3JkaW5hdGVzCiAgICAgICAgICBtMiA9IG0xWzJdLm1hdGNoKC9cdysvZyk7CiAgICAgICAgICBpZihtMil7CiAgICAgICAgICAgIG0yTGVuID0gbTIubGVuZ3RoOwogICAgICAgICAgICBmb3IoaSA9IDA7IGkgPCBtMkxlbjsgaSs9MSl7CiAgICAgICAgICAgICAgc3dpdGNoKG0yW2ldKSB7CiAgICAgICAgICAgICAgICBjYXNlICd0b3AnOgogICAgICAgICAgICAgICAgICBncmFkaWVudC55MCA9IDA7CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxID0gYm91bmRzLmhlaWdodDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSAncmlnaHQnOgogICAgICAgICAgICAgICAgICBncmFkaWVudC54MCA9IGJvdW5kcy53aWR0aDsKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgPSAwOwogICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlICdib3R0b20nOgogICAgICAgICAgICAgICAgICBncmFkaWVudC55MCA9IGJvdW5kcy5oZWlnaHQ7CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxID0gMDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSAnbGVmdCc6CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngwID0gMDsKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgPSBib3VuZHMud2lkdGg7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYoZ3JhZGllbnQueDAgPT09IG51bGwgJiYgZ3JhZGllbnQueDEgPT09IG51bGwpeyAvLyBjZW50ZXIKICAgICAgICAgICAgZ3JhZGllbnQueDAgPSBncmFkaWVudC54MSA9IGJvdW5kcy53aWR0aCAvIDI7CiAgICAgICAgICB9CiAgICAgICAgICBpZihncmFkaWVudC55MCA9PT0gbnVsbCAmJiBncmFkaWVudC55MSA9PT0gbnVsbCl7IC8vIGNlbnRlcgogICAgICAgICAgICBncmFkaWVudC55MCA9IGdyYWRpZW50LnkxID0gYm91bmRzLmhlaWdodCAvIDI7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gZ2V0IGNvbG9ycyBhbmQgc3RvcHMKICAgICAgICAgIG0yID0gbTFbM10ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSg/OlxzXGR7MSwzfSg/OiV8cHgpKT8pKy9nKTsKICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgbTJMZW4gPSBtMi5sZW5ndGg7CiAgICAgICAgICAgIHN0ZXAgPSAxIC8gTWF0aC5tYXgobTJMZW4gLSAxLCAxKTsKICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbTJMZW47IGkrPTEpewogICAgICAgICAgICAgIG0zID0gbTJbaV0ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSlccyooXGR7MSwzfSk/KCV8cHgpPy8pOwogICAgICAgICAgICAgIGlmKG0zWzJdKXsKICAgICAgICAgICAgICAgIHN0b3AgPSBwYXJzZUZsb2F0KG0zWzJdKTsKICAgICAgICAgICAgICAgIGlmKG0zWzNdID09PSAnJScpewogICAgICAgICAgICAgICAgICBzdG9wIC89IDEwMDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8vIHB4IC0gc3R1cGlkIG9wZXJhCiAgICAgICAgICAgICAgICAgIHN0b3AgLz0gYm91bmRzLndpZHRoOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdG9wID0gaSAqIHN0ZXA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGdyYWRpZW50LmNvbG9yU3RvcHMucHVzaCh7CiAgICAgICAgICAgICAgICBjb2xvcjogbTNbMV0sCiAgICAgICAgICAgICAgICBzdG9wOiBzdG9wCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICctd2Via2l0LWdyYWRpZW50JzoKCiAgICAgICAgICBncmFkaWVudCA9IHsKICAgICAgICAgICAgdHlwZTogbTFbMl0gPT09ICdyYWRpYWwnID8gJ2NpcmNsZScgOiBtMVsyXSwgLy8gVE9ETzogQWRkIHJhZGlhbCBncmFkaWVudCBzdXBwb3J0IGZvciBvbGRlciBtb3ppbGxhIGRlZmluaXRpb25zCiAgICAgICAgICAgIHgwOiAwLAogICAgICAgICAgICB5MDogMCwKICAgICAgICAgICAgeDE6IDAsCiAgICAgICAgICAgIHkxOiAwLAogICAgICAgICAgICBjb2xvclN0b3BzOiBbXQogICAgICAgICAgfTsKCiAgICAgICAgICAvLyBnZXQgY29vcmRpbmF0ZXMKICAgICAgICAgIG0yID0gbTFbM10ubWF0Y2goLyhcZHsxLDN9KSU/XHMoXGR7MSwzfSklPyxccyhcZHsxLDN9KSU/XHMoXGR7MSwzfSklPy8pOwogICAgICAgICAgaWYobTIpewogICAgICAgICAgICBncmFkaWVudC54MCA9IChtMlsxXSAqIGJvdW5kcy53aWR0aCkgLyAxMDA7CiAgICAgICAgICAgIGdyYWRpZW50LnkwID0gKG0yWzJdICogYm91bmRzLmhlaWdodCkgLyAxMDA7CiAgICAgICAgICAgIGdyYWRpZW50LngxID0gKG0yWzNdICogYm91bmRzLndpZHRoKSAvIDEwMDsKICAgICAgICAgICAgZ3JhZGllbnQueTEgPSAobTJbNF0gKiBib3VuZHMuaGVpZ2h0KSAvIDEwMDsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBnZXQgY29sb3JzIGFuZCBzdG9wcwogICAgICAgICAgbTIgPSBtMVs0XS5tYXRjaCgvKCg/OmZyb218dG98Y29sb3Itc3RvcClcKCg/OlswLTlcLl0rLFxzKT8oPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKVwpKSsvZyk7CiAgICAgICAgICBpZihtMil7CiAgICAgICAgICAgIG0yTGVuID0gbTIubGVuZ3RoOwogICAgICAgICAgICBmb3IoaSA9IDA7IGkgPCBtMkxlbjsgaSs9MSl7CiAgICAgICAgICAgICAgbTMgPSBtMltpXS5tYXRjaCgvKGZyb218dG98Y29sb3Itc3RvcClcKChbMC05XC5dKyk/KD86LFxzKT8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkpXCkvKTsKICAgICAgICAgICAgICBzdG9wID0gcGFyc2VGbG9hdChtM1syXSk7CiAgICAgICAgICAgICAgaWYobTNbMV0gPT09ICdmcm9tJykgewogICAgICAgICAgICAgICAgc3RvcCA9IDAuMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYobTNbMV0gPT09ICd0bycpIHsKICAgICAgICAgICAgICAgIHN0b3AgPSAxLjA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGdyYWRpZW50LmNvbG9yU3RvcHMucHVzaCh7CiAgICAgICAgICAgICAgICBjb2xvcjogbTNbM10sCiAgICAgICAgICAgICAgICBzdG9wOiBzdG9wCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICctbW96LWxpbmVhci1ncmFkaWVudCc6CgogICAgICAgICAgZ3JhZGllbnQgPSB7CiAgICAgICAgICAgIHR5cGU6ICdsaW5lYXInLAogICAgICAgICAgICB4MDogMCwKICAgICAgICAgICAgeTA6IDAsCiAgICAgICAgICAgIHgxOiAwLAogICAgICAgICAgICB5MTogMCwKICAgICAgICAgICAgY29sb3JTdG9wczogW10KICAgICAgICAgIH07CgogICAgICAgICAgLy8gZ2V0IGNvb3JkaW5hdGVzCiAgICAgICAgICBtMiA9IG0xWzJdLm1hdGNoKC8oXGR7MSwzfSklP1xzKFxkezEsM30pJT8vKTsKCiAgICAgICAgICAvLyBtMlsxXSA9PSAwJSAgIC0+IGxlZnQKICAgICAgICAgIC8vIG0yWzFdID09IDUwJSAgLT4gY2VudGVyCiAgICAgICAgICAvLyBtMlsxXSA9PSAxMDAlIC0+IHJpZ2h0CgogICAgICAgICAgLy8gbTJbMl0gPT0gMCUgICAtPiB0b3AKICAgICAgICAgIC8vIG0yWzJdID09IDUwJSAgLT4gY2VudGVyCiAgICAgICAgICAvLyBtMlsyXSA9PSAxMDAlIC0+IGJvdHRvbQoKICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgZ3JhZGllbnQueDAgPSAobTJbMV0gKiBib3VuZHMud2lkdGgpIC8gMTAwOwogICAgICAgICAgICBncmFkaWVudC55MCA9IChtMlsyXSAqIGJvdW5kcy5oZWlnaHQpIC8gMTAwOwogICAgICAgICAgICBncmFkaWVudC54MSA9IGJvdW5kcy53aWR0aCAtIGdyYWRpZW50LngwOwogICAgICAgICAgICBncmFkaWVudC55MSA9IGJvdW5kcy5oZWlnaHQgLSBncmFkaWVudC55MDsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBnZXQgY29sb3JzIGFuZCBzdG9wcwogICAgICAgICAgbTIgPSBtMVszXS5tYXRjaCgvKCg/OnJnYnxyZ2JhKVwoXGR7MSwzfSxcc1xkezEsM30sXHNcZHsxLDN9KD86LFxzWzAtOVwuXSspP1wpKD86XHNcZHsxLDN9JSk/KSsvZyk7CiAgICAgICAgICBpZihtMil7CiAgICAgICAgICAgIG0yTGVuID0gbTIubGVuZ3RoOwogICAgICAgICAgICBzdGVwID0gMSAvIE1hdGgubWF4KG0yTGVuIC0gMSwgMSk7CiAgICAgICAgICAgIGZvcihpID0gMDsgaSA8IG0yTGVuOyBpKz0xKXsKICAgICAgICAgICAgICBtMyA9IG0yW2ldLm1hdGNoKC8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkpXHMqKFxkezEsM30pPyglKT8vKTsKICAgICAgICAgICAgICBpZihtM1syXSl7CiAgICAgICAgICAgICAgICBzdG9wID0gcGFyc2VGbG9hdChtM1syXSk7CiAgICAgICAgICAgICAgICBpZihtM1szXSl7IC8vIHBlcmNlbnRhZ2UKICAgICAgICAgICAgICAgICAgc3RvcCAvPSAxMDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN0b3AgPSBpICogc3RlcDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZ3JhZGllbnQuY29sb3JTdG9wcy5wdXNoKHsKICAgICAgICAgICAgICAgIGNvbG9yOiBtM1sxXSwKICAgICAgICAgICAgICAgIHN0b3A6IHN0b3AKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJy13ZWJraXQtcmFkaWFsLWdyYWRpZW50JzoKICAgICAgICBjYXNlICctbW96LXJhZGlhbC1ncmFkaWVudCc6CiAgICAgICAgY2FzZSAnLW8tcmFkaWFsLWdyYWRpZW50JzoKCiAgICAgICAgICBncmFkaWVudCA9IHsKICAgICAgICAgICAgdHlwZTogJ2NpcmNsZScsCiAgICAgICAgICAgIHgwOiAwLAogICAgICAgICAgICB5MDogMCwKICAgICAgICAgICAgeDE6IGJvdW5kcy53aWR0aCwKICAgICAgICAgICAgeTE6IGJvdW5kcy5oZWlnaHQsCiAgICAgICAgICAgIGN4OiAwLAogICAgICAgICAgICBjeTogMCwKICAgICAgICAgICAgcng6IDAsCiAgICAgICAgICAgIHJ5OiAwLAogICAgICAgICAgICBjb2xvclN0b3BzOiBbXQogICAgICAgICAgfTsKCiAgICAgICAgICAvLyBjZW50ZXIKICAgICAgICAgIG0yID0gbTFbMl0ubWF0Y2goLyhcZHsxLDN9KSU/XHMoXGR7MSwzfSklPy8pOwogICAgICAgICAgaWYobTIpewogICAgICAgICAgICBncmFkaWVudC5jeCA9IChtMlsxXSAqIGJvdW5kcy53aWR0aCkgLyAxMDA7CiAgICAgICAgICAgIGdyYWRpZW50LmN5ID0gKG0yWzJdICogYm91bmRzLmhlaWdodCkgLyAxMDA7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gc2l6ZQogICAgICAgICAgbTIgPSBtMVszXS5tYXRjaCgvXHcrLyk7CiAgICAgICAgICBtMyA9IG0xWzRdLm1hdGNoKC9bYS16XC1dKi8pOwogICAgICAgICAgaWYobTIgJiYgbTMpewogICAgICAgICAgICBzd2l0Y2gobTNbMF0pewogICAgICAgICAgICAgIGNhc2UgJ2ZhcnRoZXN0LWNvcm5lcic6CiAgICAgICAgICAgICAgY2FzZSAnY292ZXInOiAvLyBpcyBlcXVpdmFsZW50IHRvIGZhcnRoZXN0LWNvcm5lcgogICAgICAgICAgICAgIGNhc2UgJyc6IC8vIG1vemlsbGEgcmVtb3ZlcyAiY292ZXIiIGZyb20gZGVmaW5pdGlvbiA6KAogICAgICAgICAgICAgICAgdGwgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQuY3ksIDIpKTsKICAgICAgICAgICAgICAgIHRyID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3ksIDIpKTsKICAgICAgICAgICAgICAgIGJyID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeSwgMikpOwogICAgICAgICAgICAgICAgYmwgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeCwgMikgKyBNYXRoLnBvdyhncmFkaWVudC5jeSwgMikpOwogICAgICAgICAgICAgICAgZ3JhZGllbnQucnggPSBncmFkaWVudC5yeSA9IE1hdGgubWF4KHRsLCB0ciwgYnIsIGJsKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgJ2Nsb3Nlc3QtY29ybmVyJzoKICAgICAgICAgICAgICAgIHRsID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LmN5LCAyKSk7CiAgICAgICAgICAgICAgICB0ciA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC5jeCwgMikgKyBNYXRoLnBvdyhncmFkaWVudC55MSAtIGdyYWRpZW50LmN5LCAyKSk7CiAgICAgICAgICAgICAgICBiciA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC54MSAtIGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3ksIDIpKTsKICAgICAgICAgICAgICAgIGJsID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQuY3ksIDIpKTsKICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gZ3JhZGllbnQucnkgPSBNYXRoLm1pbih0bCwgdHIsIGJyLCBibCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICdmYXJ0aGVzdC1zaWRlJzoKICAgICAgICAgICAgICAgIGlmKG0yWzBdID09PSAnY2lyY2xlJyl7CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gZ3JhZGllbnQucnkgPSBNYXRoLm1heCgKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeCwKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeSwKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC54MSAtIGdyYWRpZW50LmN4LAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3kKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsgLy8gZWxsaXBzZQoKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQudHlwZSA9IG0yWzBdOwoKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQucnggPSBNYXRoLm1heCgKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeCwKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC54MSAtIGdyYWRpZW50LmN4CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQucnkgPSBNYXRoLm1heCgKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeSwKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MSAtIGdyYWRpZW50LmN5CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgJ2Nsb3Nlc3Qtc2lkZSc6CiAgICAgICAgICAgICAgY2FzZSAnY29udGFpbic6IC8vIGlzIGVxdWl2YWxlbnQgdG8gY2xvc2VzdC1zaWRlCiAgICAgICAgICAgICAgICBpZihtMlswXSA9PT0gJ2NpcmNsZScpewogICAgICAgICAgICAgICAgICBncmFkaWVudC5yeCA9IGdyYWRpZW50LnJ5ID0gTWF0aC5taW4oCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3gsCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3ksCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeCwKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MSAtIGdyYWRpZW50LmN5CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8vIGVsbGlwc2UKCiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnR5cGUgPSBtMlswXTsKCiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gTWF0aC5taW4oCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3gsCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeAogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ5ID0gTWF0aC5taW4oCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3ksCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIC8vIFRPRE86IGFkZCBzdXBwb3J0IGZvciAiMzBweCA0MHB4IiBzaXplcyAod2Via2l0IG9ubHkpCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBjb2xvciBzdG9wcwogICAgICAgICAgbTIgPSBtMVs1XS5tYXRjaCgvKCg/OnJnYnxyZ2JhKVwoXGR7MSwzfSxcc1xkezEsM30sXHNcZHsxLDN9KD86LFxzWzAtOVwuXSspP1wpKD86XHNcZHsxLDN9KD86JXxweCkpPykrL2cpOwogICAgICAgICAgaWYobTIpewogICAgICAgICAgICBtMkxlbiA9IG0yLmxlbmd0aDsKICAgICAgICAgICAgc3RlcCA9IDEgLyBNYXRoLm1heChtMkxlbiAtIDEsIDEpOwogICAgICAgICAgICBmb3IoaSA9IDA7IGkgPCBtMkxlbjsgaSs9MSl7CiAgICAgICAgICAgICAgbTMgPSBtMltpXS5tYXRjaCgvKCg/OnJnYnxyZ2JhKVwoXGR7MSwzfSxcc1xkezEsM30sXHNcZHsxLDN9KD86LFxzWzAtOVwuXSspP1wpKVxzKihcZHsxLDN9KT8oJXxweCk/Lyk7CiAgICAgICAgICAgICAgaWYobTNbMl0pewogICAgICAgICAgICAgICAgc3RvcCA9IHBhcnNlRmxvYXQobTNbMl0pOwogICAgICAgICAgICAgICAgaWYobTNbM10gPT09ICclJyl7CiAgICAgICAgICAgICAgICAgIHN0b3AgLz0gMTAwOwogICAgICAgICAgICAgICAgfSBlbHNlIHsgLy8gcHggLSBzdHVwaWQgb3BlcmEKICAgICAgICAgICAgICAgICAgc3RvcCAvPSBib3VuZHMud2lkdGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN0b3AgPSBpICogc3RlcDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZ3JhZGllbnQuY29sb3JTdG9wcy5wdXNoKHsKICAgICAgICAgICAgICAgIGNvbG9yOiBtM1sxXSwKICAgICAgICAgICAgICAgIHN0b3A6IHN0b3AKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZ3JhZGllbnQ7CiAgfTsKCiAgZnVuY3Rpb24gYWRkU2Nyb2xsU3RvcHMoZ3JhZCkgewogICAgcmV0dXJuIGZ1bmN0aW9uKGNvbG9yU3RvcCkgewogICAgICB0cnkgewogICAgICAgIGdyYWQuYWRkQ29sb3JTdG9wKGNvbG9yU3RvcC5zdG9wLCBjb2xvclN0b3AuY29sb3IpOwogICAgICB9CiAgICAgIGNhdGNoKGUpIHsKICAgICAgICBVdGlsLmxvZyhbJ2ZhaWxlZCB0byBhZGQgY29sb3Igc3RvcDogJywgZSwgJzsgdHJpZWQgdG8gYWRkOiAnLCBjb2xvclN0b3BdKTsKICAgICAgfQogICAgfTsKICB9CgogIEdlbmVyYXRlLkdyYWRpZW50ID0gZnVuY3Rpb24oc3JjLCBib3VuZHMpIHsKICAgIGlmKGJvdW5kcy53aWR0aCA9PT0gMCB8fCBib3VuZHMuaGVpZ2h0ID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksCiAgICBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKSwKICAgIGdyYWRpZW50LCBncmFkOwoKICAgIGNhbnZhcy53aWR0aCA9IGJvdW5kcy53aWR0aDsKICAgIGNhbnZhcy5oZWlnaHQgPSBib3VuZHMuaGVpZ2h0OwoKICAgIC8vIFRPRE86IGFkZCBzdXBwb3J0IGZvciBtdWx0aSBkZWZpbmVkIGJhY2tncm91bmQgZ3JhZGllbnRzCiAgICBncmFkaWVudCA9IF9odG1sMmNhbnZhcy5HZW5lcmF0ZS5wYXJzZUdyYWRpZW50KHNyYywgYm91bmRzKTsKCiAgICBpZihncmFkaWVudCkgewogICAgICBzd2l0Y2goZ3JhZGllbnQudHlwZSkgewogICAgICAgIGNhc2UgJ2xpbmVhcic6CiAgICAgICAgICBncmFkID0gY3R4LmNyZWF0ZUxpbmVhckdyYWRpZW50KGdyYWRpZW50LngwLCBncmFkaWVudC55MCwgZ3JhZGllbnQueDEsIGdyYWRpZW50LnkxKTsKICAgICAgICAgIGdyYWRpZW50LmNvbG9yU3RvcHMuZm9yRWFjaChhZGRTY3JvbGxTdG9wcyhncmFkKSk7CiAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZ3JhZDsKICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQpOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ2NpcmNsZSc6CiAgICAgICAgICBncmFkID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KGdyYWRpZW50LmN4LCBncmFkaWVudC5jeSwgMCwgZ3JhZGllbnQuY3gsIGdyYWRpZW50LmN5LCBncmFkaWVudC5yeCk7CiAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLmZvckVhY2goYWRkU2Nyb2xsU3RvcHMoZ3JhZCkpOwogICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGdyYWQ7CiAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0KTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdlbGxpcHNlJzoKICAgICAgICAgIHZhciBjYW52YXNSYWRpYWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKSwKICAgICAgICAgICAgY3R4UmFkaWFsID0gY2FudmFzUmFkaWFsLmdldENvbnRleHQoJzJkJyksCiAgICAgICAgICAgIHJpID0gTWF0aC5tYXgoZ3JhZGllbnQucngsIGdyYWRpZW50LnJ5KSwKICAgICAgICAgICAgZGkgPSByaSAqIDI7CgogICAgICAgICAgY2FudmFzUmFkaWFsLndpZHRoID0gY2FudmFzUmFkaWFsLmhlaWdodCA9IGRpOwoKICAgICAgICAgIGdyYWQgPSBjdHhSYWRpYWwuY3JlYXRlUmFkaWFsR3JhZGllbnQoZ3JhZGllbnQucngsIGdyYWRpZW50LnJ5LCAwLCBncmFkaWVudC5yeCwgZ3JhZGllbnQucnksIHJpKTsKICAgICAgICAgIGdyYWRpZW50LmNvbG9yU3RvcHMuZm9yRWFjaChhZGRTY3JvbGxTdG9wcyhncmFkKSk7CgogICAgICAgICAgY3R4UmFkaWFsLmZpbGxTdHlsZSA9IGdyYWQ7CiAgICAgICAgICBjdHhSYWRpYWwuZmlsbFJlY3QoMCwgMCwgZGksIGRpKTsKCiAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZ3JhZGllbnQuY29sb3JTdG9wc1tncmFkaWVudC5jb2xvclN0b3BzLmxlbmd0aCAtIDFdLmNvbG9yOwogICAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7CiAgICAgICAgICBjdHguZHJhd0ltYWdlKGNhbnZhc1JhZGlhbCwgZ3JhZGllbnQuY3ggLSBncmFkaWVudC5yeCwgZ3JhZGllbnQuY3kgLSBncmFkaWVudC5yeSwgMiAqIGdyYWRpZW50LnJ4LCAyICogZ3JhZGllbnQucnkpOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gY2FudmFzOwogIH07CgogIEdlbmVyYXRlLkxpc3RBbHBoYSA9IGZ1bmN0aW9uKG51bWJlcikgewogICAgdmFyIHRtcCA9ICIiLAogICAgbW9kdWx1czsKCiAgICBkbyB7CiAgICAgIG1vZHVsdXMgPSBudW1iZXIgJSAyNjsKICAgICAgdG1wID0gU3RyaW5nLmZyb21DaGFyQ29kZSgobW9kdWx1cykgKyA2NCkgKyB0bXA7CiAgICAgIG51bWJlciA9IG51bWJlciAvIDI2OwogICAgfXdoaWxlKChudW1iZXIqMjYpID4gMjYpOwoKICAgIHJldHVybiB0bXA7CiAgfTsKCiAgR2VuZXJhdGUuTGlzdFJvbWFuID0gZnVuY3Rpb24obnVtYmVyKSB7CiAgICB2YXIgcm9tYW5BcnJheSA9IFsiTSIsICJDTSIsICJEIiwgIkNEIiwgIkMiLCAiWEMiLCAiTCIsICJYTCIsICJYIiwgIklYIiwgIlYiLCAiSVYiLCAiSSJdLAogICAgZGVjaW1hbCA9IFsxMDAwLCA5MDAsIDUwMCwgNDAwLCAxMDAsIDkwLCA1MCwgNDAsIDEwLCA5LCA1LCA0LCAxXSwKICAgIHJvbWFuID0gIiIsCiAgICB2LAogICAgbGVuID0gcm9tYW5BcnJheS5sZW5ndGg7CgogICAgaWYgKG51bWJlciA8PSAwIHx8IG51bWJlciA+PSA0MDAwKSB7CiAgICAgIHJldHVybiBudW1iZXI7CiAgICB9CgogICAgZm9yICh2PTA7IHYgPCBsZW47IHYrPTEpIHsKICAgICAgd2hpbGUgKG51bWJlciA+PSBkZWNpbWFsW3ZdKSB7CiAgICAgICAgbnVtYmVyIC09IGRlY2ltYWxbdl07CiAgICAgICAgcm9tYW4gKz0gcm9tYW5BcnJheVt2XTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiByb21hbjsKICB9Owp9KSgpOwpmdW5jdGlvbiBoMmNSZW5kZXJDb250ZXh0KHdpZHRoLCBoZWlnaHQpIHsKICB2YXIgc3RvcmFnZSA9IFtdOwogIHJldHVybiB7CiAgICBzdG9yYWdlOiBzdG9yYWdlLAogICAgd2lkdGg6IHdpZHRoLAogICAgaGVpZ2h0OiBoZWlnaHQsCiAgICBjbGlwOiBmdW5jdGlvbigpIHsKICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICB0eXBlOiAiZnVuY3Rpb24iLAogICAgICAgIG5hbWU6ICJjbGlwIiwKICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgIH0pOwogICAgfSwKICAgIHRyYW5zbGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICBuYW1lOiAidHJhbnNsYXRlIiwKICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgIH0pOwogICAgfSwKICAgIGZpbGw6IGZ1bmN0aW9uKCkgewogICAgICBzdG9yYWdlLnB1c2goewogICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsCiAgICAgICAgbmFtZTogImZpbGwiLAogICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgfSk7CiAgICB9LAogICAgc2F2ZTogZnVuY3Rpb24oKSB7CiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICBuYW1lOiAic2F2ZSIsCiAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICB9KTsKICAgIH0sCiAgICByZXN0b3JlOiBmdW5jdGlvbigpIHsKICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICB0eXBlOiAiZnVuY3Rpb24iLAogICAgICAgIG5hbWU6ICJyZXN0b3JlIiwKICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgIH0pOwogICAgfSwKICAgIGZpbGxSZWN0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICBuYW1lOiAiZmlsbFJlY3QiLAogICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgfSk7CiAgICB9LAogICAgY3JlYXRlUGF0dGVybjogZnVuY3Rpb24oKSB7CiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICBuYW1lOiAiY3JlYXRlUGF0dGVybiIsCiAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICB9KTsKICAgIH0sCiAgICBkcmF3U2hhcGU6IGZ1bmN0aW9uKCkgewoKICAgICAgdmFyIHNoYXBlID0gW107CgogICAgICBzdG9yYWdlLnB1c2goewogICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsCiAgICAgICAgbmFtZTogImRyYXdTaGFwZSIsCiAgICAgICAgJ2FyZ3VtZW50cyc6IHNoYXBlCiAgICAgIH0pOwoKICAgICAgcmV0dXJuIHsKICAgICAgICBtb3ZlVG86IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2hhcGUucHVzaCh7CiAgICAgICAgICAgIG5hbWU6ICJtb3ZlVG8iLAogICAgICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGxpbmVUbzogZnVuY3Rpb24oKSB7CiAgICAgICAgICBzaGFwZS5wdXNoKHsKICAgICAgICAgICAgbmFtZTogImxpbmVUbyIsCiAgICAgICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXJjVG86IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2hhcGUucHVzaCh7CiAgICAgICAgICAgIG5hbWU6ICJhcmNUbyIsCiAgICAgICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYmV6aWVyQ3VydmVUbzogZnVuY3Rpb24oKSB7CiAgICAgICAgICBzaGFwZS5wdXNoKHsKICAgICAgICAgICAgbmFtZTogImJlemllckN1cnZlVG8iLAogICAgICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIHF1YWRyYXRpY0N1cnZlVG86IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2hhcGUucHVzaCh7CiAgICAgICAgICAgIG5hbWU6ICJxdWFkcmF0aWNDdXJ2ZVRvIiwKICAgICAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9OwoKICAgIH0sCiAgICBkcmF3SW1hZ2U6IGZ1bmN0aW9uICgpIHsKICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICB0eXBlOiAiZnVuY3Rpb24iLAogICAgICAgIG5hbWU6ICJkcmF3SW1hZ2UiLAogICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgfSk7CiAgICB9LAogICAgZmlsbFRleHQ6IGZ1bmN0aW9uICgpIHsKICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICB0eXBlOiAiZnVuY3Rpb24iLAogICAgICAgIG5hbWU6ICJmaWxsVGV4dCIsCiAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICB9KTsKICAgIH0sCiAgICBzZXRWYXJpYWJsZTogZnVuY3Rpb24gKHZhcmlhYmxlLCB2YWx1ZSkgewogICAgICBzdG9yYWdlLnB1c2goewogICAgICAgIHR5cGU6ICJ2YXJpYWJsZSIsCiAgICAgICAgbmFtZTogdmFyaWFibGUsCiAgICAgICAgJ2FyZ3VtZW50cyc6IHZhbHVlCiAgICAgIH0pOwogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgfTsKfQpfaHRtbDJjYW52YXMuUGFyc2UgPSBmdW5jdGlvbiAoaW1hZ2VzLCBvcHRpb25zLCBjYikgewogIHdpbmRvdy5zY3JvbGwoMCwwKTsKCiAgdmFyIGVsZW1lbnQgPSAoKCBvcHRpb25zLmVsZW1lbnRzID09PSB1bmRlZmluZWQgKSA/IGRvY3VtZW50LmJvZHkgOiBvcHRpb25zLmVsZW1lbnRzWzBdKSwgLy8gc2VsZWN0IGJvZHkgYnkgZGVmYXVsdAogIG51bURyYXdzID0gMCwKICBkb2MgPSBlbGVtZW50Lm93bmVyRG9jdW1lbnQsCiAgVXRpbCA9IF9odG1sMmNhbnZhcy5VdGlsLAogIHN1cHBvcnQgPSBVdGlsLlN1cHBvcnQob3B0aW9ucywgZG9jKSwKICBpZ25vcmVFbGVtZW50c1JlZ0V4cCA9IG5ldyBSZWdFeHAoIigiICsgb3B0aW9ucy5pZ25vcmVFbGVtZW50cyArICIpIiksCiAgYm9keSA9IGRvYy5ib2R5LAogIGdldENTUyA9IFV0aWwuZ2V0Q1NTLAogIHBzZXVkb0hpZGUgPSAiX19faHRtbDJjYW52YXNfX19wc2V1ZG9lbGVtZW50IiwKICBoaWRlUHNldWRvRWxlbWVudHNTdHlsZXMgPSBkb2MuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTsKCiAgaGlkZVBzZXVkb0VsZW1lbnRzU3R5bGVzLmlubmVySFRNTCA9ICcuJyArIHBzZXVkb0hpZGUgKwogICctcGFyZW50OmJlZm9yZSB7IGNvbnRlbnQ6ICIiICFpbXBvcnRhbnQ7IGRpc3BsYXk6IG5vbmUgIWltcG9ydGFudDsgfScgKwogICcuJyArIHBzZXVkb0hpZGUgKyAnLXBhcmVudDphZnRlciB7IGNvbnRlbnQ6ICIiICFpbXBvcnRhbnQ7IGRpc3BsYXk6IG5vbmUgIWltcG9ydGFudDsgfSc7CgogIGJvZHkuYXBwZW5kQ2hpbGQoaGlkZVBzZXVkb0VsZW1lbnRzU3R5bGVzKTsKCiAgaW1hZ2VzID0gaW1hZ2VzIHx8IHt9OwoKICBpbml0KCk7CgogIGZ1bmN0aW9uIGluaXQoKSB7CiAgICB2YXIgYmFja2dyb3VuZCA9IGdldENTUyhkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsICJiYWNrZ3JvdW5kQ29sb3IiKSwKICAgICAgdHJhbnNwYXJlbnRCYWNrZ3JvdW5kID0gKFV0aWwuaXNUcmFuc3BhcmVudChiYWNrZ3JvdW5kKSAmJiBlbGVtZW50ID09PSBkb2N1bWVudC5ib2R5KSwKICAgICAgc3RhY2sgPSByZW5kZXJFbGVtZW50KGVsZW1lbnQsIG51bGwsIGZhbHNlLCB0cmFuc3BhcmVudEJhY2tncm91bmQpOwoKICAgIC8vIGNyZWF0ZSBwc2V1ZG8gZWxlbWVudHMgaW4gYSBzaW5nbGUgcGFzcyB0byBwcmV2ZW50IHN5bmNocm9ub3VzIGxheW91dHMKICAgIGFkZFBzZXVkb0VsZW1lbnRzKGVsZW1lbnQpOwoKICAgIHBhcnNlQ2hpbGRyZW4oZWxlbWVudCwgc3RhY2ssIGZ1bmN0aW9uKCkgewogICAgICBpZiAodHJhbnNwYXJlbnRCYWNrZ3JvdW5kKSB7CiAgICAgICAgYmFja2dyb3VuZCA9IHN0YWNrLmJhY2tncm91bmRDb2xvcjsKICAgICAgfQoKICAgICAgcmVtb3ZlUHNldWRvRWxlbWVudHMoKTsKCiAgICAgIFV0aWwubG9nKCdEb25lIHBhcnNpbmcsIG1vdmluZyB0byBSZW5kZXIuJyk7CgogICAgICBjYih7CiAgICAgICAgYmFja2dyb3VuZENvbG9yOiBiYWNrZ3JvdW5kLAogICAgICAgIHN0YWNrOiBzdGFjawogICAgICB9KTsKICAgIH0pOwogIH0KCiAgLy8gR2l2ZW4gYSByb290IGVsZW1lbnQsIGZpbmQgYWxsIHBzZXVkbyBlbGVtZW50cyBiZWxvdywgY3JlYXRlIGVsZW1lbnRzIG1vY2tpbmcgcHNldWRvIGVsZW1lbnQgc3R5bGVzCiAgLy8gc28gd2UgY2FuIHByb2Nlc3MgdGhlbSBhcyBub3JtYWwgZWxlbWVudHMsIGFuZCBoaWRlIHRoZSBvcmlnaW5hbCBwc2V1ZG8gZWxlbWVudHMgc28gdGhleSBkb24ndCBpbnRlcmZlcmUKICAvLyB3aXRoIGxheW91dC4KICBmdW5jdGlvbiBhZGRQc2V1ZG9FbGVtZW50cyhlbCkgewogICAgLy8gVGhlc2UgYXJlIGRvbmUgaW4gZGlzY3JldGUgc3RlcHMgdG8gcHJldmVudCBhIHJlbGF5b3V0IGxvb3AgY2F1c2VkIGJ5IGFkZENsYXNzKCkgaW52YWxpZGF0aW5nCiAgICAvLyBsYXlvdXRzICYgZ2V0UHNldWRvRWxlbWVudCBjYWxsaW5nIGdldENvbXB1dGVkU3R5bGUuCiAgICB2YXIgam9icyA9IFtdLCBjbGFzc2VzID0gW107CiAgICBnZXRQc2V1ZG9FbGVtZW50Q2xhc3NlcygpOwogICAgZmluZFBzZXVkb0VsZW1lbnRzKGVsKTsKICAgIHJ1bkpvYnMoKTsKCiAgICBmdW5jdGlvbiBnZXRQc2V1ZG9FbGVtZW50Q2xhc3NlcygpewogICAgICB2YXIgZmluZFBzdWVkb0VscyA9IC86YmVmb3JlfDphZnRlci87CiAgICAgIHZhciBzaGVldHMgPSBkb2N1bWVudC5zdHlsZVNoZWV0czsKICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBzaGVldHMubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciBydWxlcyA9IHNoZWV0c1tpXS5jc3NSdWxlczsKICAgICAgICAgIGZvciAodmFyIGsgPSAwLCBsID0gcnVsZXMubGVuZ3RoOyBrIDwgbDsgaysrKSB7CiAgICAgICAgICAgIGlmKGZpbmRQc3VlZG9FbHMudGVzdChydWxlc1trXS5zZWxlY3RvclRleHQpKSB7CiAgICAgICAgICAgICAgY2xhc3Nlcy5wdXNoKHJ1bGVzW2tdLnNlbGVjdG9yVGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY2F0Y2goZSkgeyAvLyB3aWxsIHRocm93IHNlY3VyaXR5IGV4Y2VwdGlvbiBmb3Igc3R5bGUgc2hlZXRzIGxvYWRlZCBmcm9tIGV4dGVybmFsIGRvbWFpbnMKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFRyaW0gb2ZmIHRoZSA6YWZ0ZXIgYW5kIDpiZWZvcmUgKG9yIDo6YWZ0ZXIgYW5kIDo6YmVmb3JlKQogICAgICBmb3IgKGkgPSAwLCBqID0gY2xhc3Nlcy5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgICBjbGFzc2VzW2ldID0gY2xhc3Nlc1tpXS5tYXRjaCgvKF5bXjpdKikvKVsxXTsKICAgICAgfQogICAgfQoKICAgIC8vIFVzaW5nIHRoZSBsaXN0IG9mIGVsZW1lbnRzIHdlIGtub3cgaG93IHBzZXVkbyBlbCBzdHlsZXMsIGNyZWF0ZSBmYWtlIHBzZXVkbyBlbGVtZW50cy4KICAgIGZ1bmN0aW9uIGZpbmRQc2V1ZG9FbGVtZW50cyhlbCkgewogICAgICB2YXIgZWxzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChjbGFzc2VzLmpvaW4oJywnKSk7CiAgICAgIGZvcih2YXIgaSA9IDAsIGogPSBlbHMubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgY3JlYXRlUHNldWRvRWxlbWVudHMoZWxzW2ldKTsKICAgICAgfQogICAgfQoKICAgIC8vIENyZWF0ZSBwc2V1ZG8gZWxlbWVudHMgJiBhZGQgdGhlbSB0byBhIGpvYiBxdWV1ZS4KICAgIGZ1bmN0aW9uIGNyZWF0ZVBzZXVkb0VsZW1lbnRzKGVsKSB7CiAgICAgIHZhciBiZWZvcmUgPSBnZXRQc2V1ZG9FbGVtZW50KGVsLCAnOmJlZm9yZScpLAogICAgICBhZnRlciA9IGdldFBzZXVkb0VsZW1lbnQoZWwsICc6YWZ0ZXInKTsKCiAgICAgIGlmKGJlZm9yZSkgewogICAgICAgIGpvYnMucHVzaCh7dHlwZTogJ2JlZm9yZScsIHBzZXVkbzogYmVmb3JlLCBlbDogZWx9KTsKICAgICAgfQoKICAgICAgaWYgKGFmdGVyKSB7CiAgICAgICAgam9icy5wdXNoKHt0eXBlOiAnYWZ0ZXInLCBwc2V1ZG86IGFmdGVyLCBlbDogZWx9KTsKICAgICAgfQogICAgfQoKICAgIC8vIEFkZHMgYSBjbGFzcyB0byB0aGUgcHNldWRvJ3MgcGFyZW50IHRvIHByZXZlbnQgdGhlIG9yaWdpbmFsIGJlZm9yZS9hZnRlciBmcm9tIG1lc3NpbmcKICAgIC8vIHdpdGggbGF5b3V0cy4KICAgIC8vIEV4ZWN1dGUgdGhlIGluc2VydHMgJiBhZGRDbGFzcygpIGNhbGxzIGluIGEgYmF0Y2ggdG8gcHJldmVudCByZWxheW91dHMuCiAgICBmdW5jdGlvbiBydW5Kb2JzKCkgewogICAgICAvLyBBZGQgQ2xhc3MKICAgICAgam9icy5mb3JFYWNoKGZ1bmN0aW9uKGpvYil7CiAgICAgICAgYWRkQ2xhc3Moam9iLmVsLCBwc2V1ZG9IaWRlICsgIi1wYXJlbnQiKTsKICAgICAgfSk7CgogICAgICAvLyBJbnNlcnQgZWwKICAgICAgam9icy5mb3JFYWNoKGZ1bmN0aW9uKGpvYil7CiAgICAgICAgaWYoam9iLnR5cGUgPT09ICdiZWZvcmUnKXsKICAgICAgICAgIGpvYi5lbC5pbnNlcnRCZWZvcmUoam9iLnBzZXVkbywgam9iLmVsLmZpcnN0Q2hpbGQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBqb2IuZWwuYXBwZW5kQ2hpbGQoam9iLnBzZXVkbyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9CgoKCiAgLy8gRGVsZXRlIG91ciBmYWtlIHBzZXVkbyBlbGVtZW50cyBmcm9tIHRoZSBET00uIFRoaXMgd2lsbCByZW1vdmUgdGhvc2UgYWN0dWFsIGVsZW1lbnRzCiAgLy8gYW5kIHRoZSBjbGFzc2VzIG9uIHRoZWlyIHBhcmVudHMgdGhhdCBoaWRlIHRoZSBhY3R1YWwgcHNldWRvIGVsZW1lbnRzLgogIC8vIE5vdGUgdGhhdCBOb2RlTGlzdHMgYXJlICdsaXZlJyBjb2xsZWN0aW9ucyBzbyB5b3UgY2FuJ3QgdXNlIGEgZm9yIGxvb3AgaGVyZS4gVGhleSBhcmUKICAvLyBhY3R1YWxseSBkZWxldGVkIGZyb20gdGhlIE5vZGVMaXN0IGFmdGVyIGVhY2ggaXRlcmF0aW9uLgogIGZ1bmN0aW9uIHJlbW92ZVBzZXVkb0VsZW1lbnRzKCl7CiAgICAvLyBkZWxldGUgcHNldWRvIGVsZW1lbnRzCiAgICBib2R5LnJlbW92ZUNoaWxkKGhpZGVQc2V1ZG9FbGVtZW50c1N0eWxlcyk7CiAgICB2YXIgcHNldWRvcyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUocHNldWRvSGlkZSArICItZWxlbWVudCIpOwogICAgd2hpbGUgKHBzZXVkb3MubGVuZ3RoKSB7CiAgICAgIHBzZXVkb3NbMF0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChwc2V1ZG9zWzBdKTsKICAgIH0KCiAgICAvLyBSZW1vdmUgcHNldWRvIGhpZGluZyBjbGFzc2VzCiAgICB2YXIgcGFyZW50cyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUocHNldWRvSGlkZSArICItcGFyZW50Iik7CiAgICB3aGlsZShwYXJlbnRzLmxlbmd0aCkgewogICAgICByZW1vdmVDbGFzcyhwYXJlbnRzWzBdLCBwc2V1ZG9IaWRlICsgIi1wYXJlbnQiKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGFkZENsYXNzIChlbCwgY2xhc3NOYW1lKSB7CiAgICBpZiAoZWwuY2xhc3NMaXN0KSB7CiAgICAgIGVsLmNsYXNzTGlzdC5hZGQoY2xhc3NOYW1lKTsKICAgIH0gZWxzZSB7CiAgICAgIGVsLmNsYXNzTmFtZSA9IGVsLmNsYXNzTmFtZSArICIgIiArIGNsYXNzTmFtZTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlbW92ZUNsYXNzIChlbCwgY2xhc3NOYW1lKSB7CiAgICBpZiAoZWwuY2xhc3NMaXN0KSB7CiAgICAgIGVsLmNsYXNzTGlzdC5yZW1vdmUoY2xhc3NOYW1lKTsKICAgIH0gZWxzZSB7CiAgICAgIGVsLmNsYXNzTmFtZSA9IGVsLmNsYXNzTmFtZS5yZXBsYWNlKGNsYXNzTmFtZSwgIiIpLnRyaW0oKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGhhc0NsYXNzIChlbCwgY2xhc3NOYW1lKSB7CiAgICByZXR1cm4gZWwuY2xhc3NOYW1lLmluZGV4T2YoY2xhc3NOYW1lKSA+IC0xOwogIH0KCiAgLy8gTm90ZSB0aGF0IHRoaXMgZG9lc24ndCB3b3JrIGluIDwgSUU4LCBidXQgd2UgZG9uJ3Qgc3VwcG9ydCB0aGF0IGFueWhvdwogIGZ1bmN0aW9uIG5vZGVMaXN0VG9BcnJheSAobm9kZUxpc3QpIHsKICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChub2RlTGlzdCk7CiAgfQoKICBmdW5jdGlvbiBkb2N1bWVudFdpZHRoICgpIHsKICAgIHJldHVybiBNYXRoLm1heCgKICAgICAgTWF0aC5tYXgoZG9jLmJvZHkuc2Nyb2xsV2lkdGgsIGRvYy5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsV2lkdGgpLAogICAgICBNYXRoLm1heChkb2MuYm9keS5vZmZzZXRXaWR0aCwgZG9jLmRvY3VtZW50RWxlbWVudC5vZmZzZXRXaWR0aCksCiAgICAgIE1hdGgubWF4KGRvYy5ib2R5LmNsaWVudFdpZHRoLCBkb2MuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoKQogICAgICApOwogIH0KCiAgZnVuY3Rpb24gZG9jdW1lbnRIZWlnaHQgKCkgewogICAgcmV0dXJuIE1hdGgubWF4KAogICAgICBNYXRoLm1heChkb2MuYm9keS5zY3JvbGxIZWlnaHQsIGRvYy5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsSGVpZ2h0KSwKICAgICAgTWF0aC5tYXgoZG9jLmJvZHkub2Zmc2V0SGVpZ2h0LCBkb2MuZG9jdW1lbnRFbGVtZW50Lm9mZnNldEhlaWdodCksCiAgICAgIE1hdGgubWF4KGRvYy5ib2R5LmNsaWVudEhlaWdodCwgZG9jLmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQpCiAgICAgICk7CiAgfQoKICBmdW5jdGlvbiBnZXRDU1NJbnQoZWxlbWVudCwgYXR0cmlidXRlKSB7CiAgICB2YXIgdmFsID0gcGFyc2VJbnQoZ2V0Q1NTKGVsZW1lbnQsIGF0dHJpYnV0ZSksIDEwKTsKICAgIHJldHVybiAoaXNOYU4odmFsKSkgPyAwIDogdmFsOyAvLyBib3JkZXJzIGluIG9sZCBJRSBhcmUgdGhyb3dpbmcgJ21lZGl1bScgZm9yIGRlbW8uaHRtbAogIH0KCiAgZnVuY3Rpb24gcmVuZGVyUmVjdCAoY3R4LCB4LCB5LCB3LCBoLCBiZ2NvbG9yKSB7CiAgICBpZiAoYmdjb2xvciAhPT0gInRyYW5zcGFyZW50Iil7CiAgICAgIGN0eC5zZXRWYXJpYWJsZSgiZmlsbFN0eWxlIiwgYmdjb2xvcik7CiAgICAgIGN0eC5maWxsUmVjdCh4LCB5LCB3LCBoKTsKICAgICAgbnVtRHJhd3MrPTE7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjYXBpdGFsaXplKG0sIHAxLCBwMikgewogICAgaWYgKG0ubGVuZ3RoID4gMCkgewogICAgICByZXR1cm4gcDEgKyBwMi50b1VwcGVyQ2FzZSgpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gdGV4dFRyYW5zZm9ybSAodGV4dCwgdHJhbnNmb3JtKSB7CiAgICBzd2l0Y2godHJhbnNmb3JtKXsKICAgICAgY2FzZSAibG93ZXJjYXNlIjoKICAgICAgICByZXR1cm4gdGV4dC50b0xvd2VyQ2FzZSgpOwogICAgICBjYXNlICJjYXBpdGFsaXplIjoKICAgICAgICByZXR1cm4gdGV4dC5yZXBsYWNlKCAvKF58XHN8OnwtfFwofFwpKShbYS16XSkvZywgY2FwaXRhbGl6ZSk7CiAgICAgIGNhc2UgInVwcGVyY2FzZSI6CiAgICAgICAgcmV0dXJuIHRleHQudG9VcHBlckNhc2UoKTsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gdGV4dDsKICAgIH0KICB9CgogIGZ1bmN0aW9uIG5vTGV0dGVyU3BhY2luZyhsZXR0ZXJfc3BhY2luZykgewogICAgcmV0dXJuICgvXihub3JtYWx8bm9uZXwwcHgpJC8udGVzdChsZXR0ZXJfc3BhY2luZykpOwogIH0KCiAgZnVuY3Rpb24gZHJhd1RleHQoY3VycmVudFRleHQsIHgsIHksIGN0eCl7CiAgICBpZiAoY3VycmVudFRleHQgIT09IG51bGwgJiYgVXRpbC50cmltVGV4dChjdXJyZW50VGV4dCkubGVuZ3RoID4gMCkgewogICAgICBjdHguZmlsbFRleHQoY3VycmVudFRleHQsIHgsIHkpOwogICAgICBudW1EcmF3cys9MTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHNldFRleHRWYXJpYWJsZXMoY3R4LCBlbCwgdGV4dF9kZWNvcmF0aW9uLCBjb2xvcikgewogICAgdmFyIGFsaWduID0gZmFsc2UsCiAgICBib2xkID0gZ2V0Q1NTKGVsLCAiZm9udFdlaWdodCIpLAogICAgZmFtaWx5ID0gZ2V0Q1NTKGVsLCAiZm9udEZhbWlseSIpLAogICAgc2l6ZSA9IGdldENTUyhlbCwgImZvbnRTaXplIiksCiAgICBzaGFkb3dzID0gVXRpbC5wYXJzZVRleHRTaGFkb3dzKGdldENTUyhlbCwgInRleHRTaGFkb3ciKSk7CgogICAgc3dpdGNoKHBhcnNlSW50KGJvbGQsIDEwKSl7CiAgICAgIGNhc2UgNDAxOgogICAgICAgIGJvbGQgPSAiYm9sZCI7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgNDAwOgogICAgICAgIGJvbGQgPSAibm9ybWFsIjsKICAgICAgICBicmVhazsKICAgIH0KCiAgICBjdHguc2V0VmFyaWFibGUoImZpbGxTdHlsZSIsIGNvbG9yKTsKICAgIGN0eC5zZXRWYXJpYWJsZSgiZm9udCIsIFtnZXRDU1MoZWwsICJmb250U3R5bGUiKSwgZ2V0Q1NTKGVsLCAiZm9udFZhcmlhbnQiKSwgYm9sZCwgc2l6ZSwgZmFtaWx5XS5qb2luKCIgIikpOwogICAgY3R4LnNldFZhcmlhYmxlKCJ0ZXh0QWxpZ24iLCAoYWxpZ24pID8gInJpZ2h0IiA6ICJsZWZ0Iik7CgogICAgaWYgKHNoYWRvd3MubGVuZ3RoKSB7CiAgICAgIC8vIFRPRE86IHN1cHBvcnQgbXVsdGlwbGUgdGV4dCBzaGFkb3dzCiAgICAgIC8vIGFwcGx5IHRoZSBmaXJzdCB0ZXh0IHNoYWRvdwogICAgICBjdHguc2V0VmFyaWFibGUoInNoYWRvd0NvbG9yIiwgc2hhZG93c1swXS5jb2xvcik7CiAgICAgIGN0eC5zZXRWYXJpYWJsZSgic2hhZG93T2Zmc2V0WCIsIHNoYWRvd3NbMF0ub2Zmc2V0WCk7CiAgICAgIGN0eC5zZXRWYXJpYWJsZSgic2hhZG93T2Zmc2V0WSIsIHNoYWRvd3NbMF0ub2Zmc2V0WSk7CiAgICAgIGN0eC5zZXRWYXJpYWJsZSgic2hhZG93Qmx1ciIsIHNoYWRvd3NbMF0uYmx1cik7CiAgICB9CgogICAgaWYgKHRleHRfZGVjb3JhdGlvbiAhPT0gIm5vbmUiKXsKICAgICAgcmV0dXJuIFV0aWwuRm9udChmYW1pbHksIHNpemUsIGRvYyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZW5kZXJUZXh0RGVjb3JhdGlvbihjdHgsIHRleHRfZGVjb3JhdGlvbiwgYm91bmRzLCBtZXRyaWNzLCBjb2xvcikgewogICAgc3dpdGNoKHRleHRfZGVjb3JhdGlvbikgewogICAgICBjYXNlICJ1bmRlcmxpbmUiOgogICAgICAgIC8vIERyYXdzIGEgbGluZSBhdCB0aGUgYmFzZWxpbmUgb2YgdGhlIGZvbnQKICAgICAgICAvLyBUT0RPIEFzIHNvbWUgYnJvd3NlcnMgZGlzcGxheSB0aGUgbGluZSBhcyBtb3JlIHRoYW4gMXB4IGlmIHRoZSBmb250LXNpemUgaXMgYmlnLCBuZWVkIHRvIHRha2UgdGhhdCBpbnRvIGFjY291bnQgYm90aCBpbiBwb3NpdGlvbiBhbmQgc2l6ZQogICAgICAgIHJlbmRlclJlY3QoY3R4LCBib3VuZHMubGVmdCwgTWF0aC5yb3VuZChib3VuZHMudG9wICsgbWV0cmljcy5iYXNlbGluZSArIG1ldHJpY3MubGluZVdpZHRoKSwgYm91bmRzLndpZHRoLCAxLCBjb2xvcik7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIm92ZXJsaW5lIjoKICAgICAgICByZW5kZXJSZWN0KGN0eCwgYm91bmRzLmxlZnQsIE1hdGgucm91bmQoYm91bmRzLnRvcCksIGJvdW5kcy53aWR0aCwgMSwgY29sb3IpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJsaW5lLXRocm91Z2giOgogICAgICAgIC8vIFRPRE8gdHJ5IGFuZCBmaW5kIGV4YWN0IHBvc2l0aW9uIGZvciBsaW5lLXRocm91Z2gKICAgICAgICByZW5kZXJSZWN0KGN0eCwgYm91bmRzLmxlZnQsIE1hdGguY2VpbChib3VuZHMudG9wICsgbWV0cmljcy5taWRkbGUgKyBtZXRyaWNzLmxpbmVXaWR0aCksIGJvdW5kcy53aWR0aCwgMSwgY29sb3IpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZ2V0VGV4dEJvdW5kcyhzdGF0ZSwgdGV4dCwgdGV4dERlY29yYXRpb24sIGlzTGFzdCwgdHJhbnNmb3JtKSB7CiAgICB2YXIgYm91bmRzOwogICAgaWYgKHN1cHBvcnQucmFuZ2VCb3VuZHMgJiYgIXRyYW5zZm9ybSkgewogICAgICBpZiAodGV4dERlY29yYXRpb24gIT09ICJub25lIiB8fCBVdGlsLnRyaW1UZXh0KHRleHQpLmxlbmd0aCAhPT0gMCkgewogICAgICAgIGJvdW5kcyA9IHRleHRSYW5nZUJvdW5kcyh0ZXh0LCBzdGF0ZS5ub2RlLCBzdGF0ZS50ZXh0T2Zmc2V0KTsKICAgICAgfQogICAgICBzdGF0ZS50ZXh0T2Zmc2V0ICs9IHRleHQubGVuZ3RoOwogICAgfSBlbHNlIGlmIChzdGF0ZS5ub2RlICYmIHR5cGVvZiBzdGF0ZS5ub2RlLm5vZGVWYWx1ZSA9PT0gInN0cmluZyIgKXsKICAgICAgdmFyIG5ld1RleHROb2RlID0gKGlzTGFzdCkgPyBzdGF0ZS5ub2RlLnNwbGl0VGV4dCh0ZXh0Lmxlbmd0aCkgOiBudWxsOwogICAgICBib3VuZHMgPSB0ZXh0V3JhcHBlckJvdW5kcyhzdGF0ZS5ub2RlLCB0cmFuc2Zvcm0pOwogICAgICBzdGF0ZS5ub2RlID0gbmV3VGV4dE5vZGU7CiAgICB9CiAgICByZXR1cm4gYm91bmRzOwogIH0KCiAgZnVuY3Rpb24gdGV4dFJhbmdlQm91bmRzKHRleHQsIHRleHROb2RlLCB0ZXh0T2Zmc2V0KSB7CiAgICB2YXIgcmFuZ2UgPSBkb2MuY3JlYXRlUmFuZ2UoKTsKICAgIHJhbmdlLnNldFN0YXJ0KHRleHROb2RlLCB0ZXh0T2Zmc2V0KTsKICAgIHJhbmdlLnNldEVuZCh0ZXh0Tm9kZSwgdGV4dE9mZnNldCArIHRleHQubGVuZ3RoKTsKICAgIHJldHVybiByYW5nZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICB9CgogIGZ1bmN0aW9uIHRleHRXcmFwcGVyQm91bmRzKG9sZFRleHROb2RlLCB0cmFuc2Zvcm0pIHsKICAgIHZhciBwYXJlbnQgPSBvbGRUZXh0Tm9kZS5wYXJlbnROb2RlLAogICAgd3JhcEVsZW1lbnQgPSBkb2MuY3JlYXRlRWxlbWVudCgnd3JhcHBlcicpLAogICAgYmFja3VwVGV4dCA9IG9sZFRleHROb2RlLmNsb25lTm9kZSh0cnVlKTsKCiAgICB3cmFwRWxlbWVudC5hcHBlbmRDaGlsZChvbGRUZXh0Tm9kZS5jbG9uZU5vZGUodHJ1ZSkpOwogICAgcGFyZW50LnJlcGxhY2VDaGlsZCh3cmFwRWxlbWVudCwgb2xkVGV4dE5vZGUpOwoKICAgIHZhciBib3VuZHMgPSB0cmFuc2Zvcm0gPyBVdGlsLk9mZnNldEJvdW5kcyh3cmFwRWxlbWVudCkgOiBVdGlsLkJvdW5kcyh3cmFwRWxlbWVudCk7CiAgICBwYXJlbnQucmVwbGFjZUNoaWxkKGJhY2t1cFRleHQsIHdyYXBFbGVtZW50KTsKICAgIHJldHVybiBib3VuZHM7CiAgfQoKICBmdW5jdGlvbiByZW5kZXJUZXh0KGVsLCB0ZXh0Tm9kZSwgc3RhY2spIHsKICAgIHZhciBjdHggPSBzdGFjay5jdHgsCiAgICBjb2xvciA9IGdldENTUyhlbCwgImNvbG9yIiksCiAgICB0ZXh0RGVjb3JhdGlvbiA9IGdldENTUyhlbCwgInRleHREZWNvcmF0aW9uIiksCiAgICB0ZXh0QWxpZ24gPSBnZXRDU1MoZWwsICJ0ZXh0QWxpZ24iKSwKICAgIG1ldHJpY3MsCiAgICB0ZXh0TGlzdCwKICAgIHN0YXRlID0gewogICAgICBub2RlOiB0ZXh0Tm9kZSwKICAgICAgdGV4dE9mZnNldDogMAogICAgfTsKCiAgICBpZiAoVXRpbC50cmltVGV4dCh0ZXh0Tm9kZS5ub2RlVmFsdWUpLmxlbmd0aCA+IDApIHsKICAgICAgdGV4dE5vZGUubm9kZVZhbHVlID0gdGV4dFRyYW5zZm9ybSh0ZXh0Tm9kZS5ub2RlVmFsdWUsIGdldENTUyhlbCwgInRleHRUcmFuc2Zvcm0iKSk7CiAgICAgIHRleHRBbGlnbiA9IHRleHRBbGlnbi5yZXBsYWNlKFsiLXdlYmtpdC1hdXRvIl0sWyJhdXRvIl0pOwoKICAgICAgdGV4dExpc3QgPSAoIW9wdGlvbnMubGV0dGVyUmVuZGVyaW5nICYmIC9eKGxlZnR8cmlnaHR8anVzdGlmeXxhdXRvKSQvLnRlc3QodGV4dEFsaWduKSAmJiBub0xldHRlclNwYWNpbmcoZ2V0Q1NTKGVsLCAibGV0dGVyU3BhY2luZyIpKSkgPwogICAgICB0ZXh0Tm9kZS5ub2RlVmFsdWUuc3BsaXQoLyhcYnwgKS8pCiAgICAgIDogdGV4dE5vZGUubm9kZVZhbHVlLnNwbGl0KCIiKTsKCiAgICAgIG1ldHJpY3MgPSBzZXRUZXh0VmFyaWFibGVzKGN0eCwgZWwsIHRleHREZWNvcmF0aW9uLCBjb2xvcik7CgogICAgICBpZiAob3B0aW9ucy5jaGluZXNlKSB7CiAgICAgICAgdGV4dExpc3QuZm9yRWFjaChmdW5jdGlvbih3b3JkLCBpbmRleCkgewogICAgICAgICAgaWYgKC8uKltcdTRFMDAtXHU5RkE1XS4qJC8udGVzdCh3b3JkKSkgewogICAgICAgICAgICB3b3JkID0gd29yZC5zcGxpdCgiIik7CiAgICAgICAgICAgIHdvcmQudW5zaGlmdChpbmRleCwgMSk7CiAgICAgICAgICAgIHRleHRMaXN0LnNwbGljZS5hcHBseSh0ZXh0TGlzdCwgd29yZCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHRleHRMaXN0LmZvckVhY2goZnVuY3Rpb24odGV4dCwgaW5kZXgpIHsKICAgICAgICB2YXIgYm91bmRzID0gZ2V0VGV4dEJvdW5kcyhzdGF0ZSwgdGV4dCwgdGV4dERlY29yYXRpb24sIChpbmRleCA8IHRleHRMaXN0Lmxlbmd0aCAtIDEpLCBzdGFjay50cmFuc2Zvcm0ubWF0cml4KTsKICAgICAgICBpZiAoYm91bmRzKSB7CiAgICAgICAgICBkcmF3VGV4dCh0ZXh0LCBib3VuZHMubGVmdCwgYm91bmRzLmJvdHRvbSwgY3R4KTsKICAgICAgICAgIHJlbmRlclRleHREZWNvcmF0aW9uKGN0eCwgdGV4dERlY29yYXRpb24sIGJvdW5kcywgbWV0cmljcywgY29sb3IpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBsaXN0UG9zaXRpb24gKGVsZW1lbnQsIHZhbCkgewogICAgdmFyIGJvdW5kRWxlbWVudCA9IGRvYy5jcmVhdGVFbGVtZW50KCAiYm91bmRlbGVtZW50IiApLAogICAgb3JpZ2luYWxUeXBlLAogICAgYm91bmRzOwoKICAgIGJvdW5kRWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gImlubGluZSI7CgogICAgb3JpZ2luYWxUeXBlID0gZWxlbWVudC5zdHlsZS5saXN0U3R5bGVUeXBlOwogICAgZWxlbWVudC5zdHlsZS5saXN0U3R5bGVUeXBlID0gIm5vbmUiOwoKICAgIGJvdW5kRWxlbWVudC5hcHBlbmRDaGlsZChkb2MuY3JlYXRlVGV4dE5vZGUodmFsKSk7CgogICAgZWxlbWVudC5pbnNlcnRCZWZvcmUoYm91bmRFbGVtZW50LCBlbGVtZW50LmZpcnN0Q2hpbGQpOwoKICAgIGJvdW5kcyA9IFV0aWwuQm91bmRzKGJvdW5kRWxlbWVudCk7CiAgICBlbGVtZW50LnJlbW92ZUNoaWxkKGJvdW5kRWxlbWVudCk7CiAgICBlbGVtZW50LnN0eWxlLmxpc3RTdHlsZVR5cGUgPSBvcmlnaW5hbFR5cGU7CiAgICByZXR1cm4gYm91bmRzOwogIH0KCiAgZnVuY3Rpb24gZWxlbWVudEluZGV4KGVsKSB7CiAgICB2YXIgaSA9IC0xLAogICAgY291bnQgPSAxLAogICAgY2hpbGRzID0gZWwucGFyZW50Tm9kZS5jaGlsZE5vZGVzOwoKICAgIGlmIChlbC5wYXJlbnROb2RlKSB7CiAgICAgIHdoaWxlKGNoaWxkc1srK2ldICE9PSBlbCkgewogICAgICAgIGlmIChjaGlsZHNbaV0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBjb3VudDsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAtMTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGxpc3RJdGVtVGV4dChlbGVtZW50LCB0eXBlKSB7CiAgICB2YXIgY3VycmVudEluZGV4ID0gZWxlbWVudEluZGV4KGVsZW1lbnQpLCB0ZXh0OwogICAgc3dpdGNoKHR5cGUpewogICAgICBjYXNlICJkZWNpbWFsIjoKICAgICAgICB0ZXh0ID0gY3VycmVudEluZGV4OwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJkZWNpbWFsLWxlYWRpbmctemVybyI6CiAgICAgICAgdGV4dCA9IChjdXJyZW50SW5kZXgudG9TdHJpbmcoKS5sZW5ndGggPT09IDEpID8gY3VycmVudEluZGV4ID0gIjAiICsgY3VycmVudEluZGV4LnRvU3RyaW5nKCkgOiBjdXJyZW50SW5kZXgudG9TdHJpbmcoKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAidXBwZXItcm9tYW4iOgogICAgICAgIHRleHQgPSBfaHRtbDJjYW52YXMuR2VuZXJhdGUuTGlzdFJvbWFuKCBjdXJyZW50SW5kZXggKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAibG93ZXItcm9tYW4iOgogICAgICAgIHRleHQgPSBfaHRtbDJjYW52YXMuR2VuZXJhdGUuTGlzdFJvbWFuKCBjdXJyZW50SW5kZXggKS50b0xvd2VyQ2FzZSgpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJsb3dlci1hbHBoYSI6CiAgICAgICAgdGV4dCA9IF9odG1sMmNhbnZhcy5HZW5lcmF0ZS5MaXN0QWxwaGEoIGN1cnJlbnRJbmRleCApLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgInVwcGVyLWFscGhhIjoKICAgICAgICB0ZXh0ID0gX2h0bWwyY2FudmFzLkdlbmVyYXRlLkxpc3RBbHBoYSggY3VycmVudEluZGV4ICk7CiAgICAgICAgYnJlYWs7CiAgICB9CgogICAgcmV0dXJuIHRleHQgKyAiLiAiOwogIH0KCiAgZnVuY3Rpb24gcmVuZGVyTGlzdEl0ZW0oZWxlbWVudCwgc3RhY2ssIGVsQm91bmRzKSB7CiAgICB2YXIgeCwKICAgIHRleHQsCiAgICBjdHggPSBzdGFjay5jdHgsCiAgICB0eXBlID0gZ2V0Q1NTKGVsZW1lbnQsICJsaXN0U3R5bGVUeXBlIiksCiAgICBsaXN0Qm91bmRzOwoKICAgIGlmICgvXihkZWNpbWFsfGRlY2ltYWwtbGVhZGluZy16ZXJvfHVwcGVyLWFscGhhfHVwcGVyLWxhdGlufHVwcGVyLXJvbWFufGxvd2VyLWFscGhhfGxvd2VyLWdyZWVrfGxvd2VyLWxhdGlufGxvd2VyLXJvbWFuKSQvaS50ZXN0KHR5cGUpKSB7CiAgICAgIHRleHQgPSBsaXN0SXRlbVRleHQoZWxlbWVudCwgdHlwZSk7CiAgICAgIGxpc3RCb3VuZHMgPSBsaXN0UG9zaXRpb24oZWxlbWVudCwgdGV4dCk7CiAgICAgIHNldFRleHRWYXJpYWJsZXMoY3R4LCBlbGVtZW50LCAibm9uZSIsIGdldENTUyhlbGVtZW50LCAiY29sb3IiKSk7CgogICAgICBpZiAoZ2V0Q1NTKGVsZW1lbnQsICJsaXN0U3R5bGVQb3NpdGlvbiIpID09PSAiaW5zaWRlIikgewogICAgICAgIGN0eC5zZXRWYXJpYWJsZSgidGV4dEFsaWduIiwgImxlZnQiKTsKICAgICAgICB4ID0gZWxCb3VuZHMubGVmdDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGRyYXdUZXh0KHRleHQsIHgsIGxpc3RCb3VuZHMuYm90dG9tLCBjdHgpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gbG9hZEltYWdlIChzcmMpewogICAgdmFyIGltZyA9IGltYWdlc1tzcmNdOwogICAgcmV0dXJuIChpbWcgJiYgaW1nLnN1Y2NlZWRlZCA9PT0gdHJ1ZSkgPyBpbWcuaW1nIDogZmFsc2U7CiAgfQoKICBmdW5jdGlvbiBjbGlwQm91bmRzKHNyYywgZHN0KXsKICAgIHZhciB4ID0gTWF0aC5tYXgoc3JjLmxlZnQsIGRzdC5sZWZ0KSwKICAgIHkgPSBNYXRoLm1heChzcmMudG9wLCBkc3QudG9wKSwKICAgIHgyID0gTWF0aC5taW4oKHNyYy5sZWZ0ICsgc3JjLndpZHRoKSwgKGRzdC5sZWZ0ICsgZHN0LndpZHRoKSksCiAgICB5MiA9IE1hdGgubWluKChzcmMudG9wICsgc3JjLmhlaWdodCksIChkc3QudG9wICsgZHN0LmhlaWdodCkpOwoKICAgIHJldHVybiB7CiAgICAgIGxlZnQ6eCwKICAgICAgdG9wOnksCiAgICAgIHdpZHRoOngyLXgsCiAgICAgIGhlaWdodDp5Mi15CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gc2V0WihlbGVtZW50LCBzdGFjaywgcGFyZW50U3RhY2spewogICAgdmFyIG5ld0NvbnRleHQsCiAgICBpc1Bvc2l0aW9uZWQgPSBzdGFjay5jc3NQb3NpdGlvbiAhPT0gJ3N0YXRpYycsCiAgICB6SW5kZXggPSBpc1Bvc2l0aW9uZWQgPyBnZXRDU1MoZWxlbWVudCwgJ3pJbmRleCcpIDogJ2F1dG8nLAogICAgb3BhY2l0eSA9IGdldENTUyhlbGVtZW50LCAnb3BhY2l0eScpLAogICAgaXNGbG9hdGVkID0gZ2V0Q1NTKGVsZW1lbnQsICdjc3NGbG9hdCcpICE9PSAnbm9uZSc7CgogICAgLy8gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvR3VpZGUvQ1NTL1VuZGVyc3RhbmRpbmdfel9pbmRleC9UaGVfc3RhY2tpbmdfY29udGV4dAogICAgLy8gV2hlbiBhIG5ldyBzdGFja2luZyBjb250ZXh0IHNob3VsZCBiZSBjcmVhdGVkOgogICAgLy8gdGhlIHJvb3QgZWxlbWVudCAoSFRNTCksCiAgICAvLyBwb3NpdGlvbmVkIChhYnNvbHV0ZWx5IG9yIHJlbGF0aXZlbHkpIHdpdGggYSB6LWluZGV4IHZhbHVlIG90aGVyIHRoYW4gImF1dG8iLAogICAgLy8gZWxlbWVudHMgd2l0aCBhbiBvcGFjaXR5IHZhbHVlIGxlc3MgdGhhbiAxLiAoU2VlIHRoZSBzcGVjaWZpY2F0aW9uIGZvciBvcGFjaXR5KSwKICAgIC8vIG9uIG1vYmlsZSBXZWJLaXQgYW5kIENocm9tZSAyMissIHBvc2l0aW9uOiBmaXhlZCBhbHdheXMgY3JlYXRlcyBhIG5ldyBzdGFja2luZyBjb250ZXh0LCBldmVuIHdoZW4gei1pbmRleCBpcyAiYXV0byIgKFNlZSB0aGlzIHBvc3QpCgogICAgc3RhY2suekluZGV4ID0gbmV3Q29udGV4dCA9IGgyY3pDb250ZXh0KHpJbmRleCk7CiAgICBuZXdDb250ZXh0LmlzUG9zaXRpb25lZCA9IGlzUG9zaXRpb25lZDsKICAgIG5ld0NvbnRleHQuaXNGbG9hdGVkID0gaXNGbG9hdGVkOwogICAgbmV3Q29udGV4dC5vcGFjaXR5ID0gb3BhY2l0eTsKICAgIG5ld0NvbnRleHQub3duU3RhY2tpbmcgPSAoekluZGV4ICE9PSAnYXV0bycgfHwgb3BhY2l0eSA8IDEpOwogICAgbmV3Q29udGV4dC5kZXB0aCA9IHBhcmVudFN0YWNrID8gKHBhcmVudFN0YWNrLnpJbmRleC5kZXB0aCArIDEpIDogMDsKCiAgICBpZiAocGFyZW50U3RhY2spIHsKICAgICAgcGFyZW50U3RhY2suekluZGV4LmNoaWxkcmVuLnB1c2goc3RhY2spOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaDJjekNvbnRleHQoemluZGV4KSB7CiAgICByZXR1cm4gewogICAgICBkZXB0aDogMCwKICAgICAgemluZGV4OiB6aW5kZXgsCiAgICAgIGNoaWxkcmVuOiBbXQogICAgfTsKICB9CgogIGZ1bmN0aW9uIHJlbmRlckltYWdlKGN0eCwgZWxlbWVudCwgaW1hZ2UsIGJvdW5kcywgYm9yZGVycykgewoKICAgIHZhciBwYWRkaW5nTGVmdCA9IGdldENTU0ludChlbGVtZW50LCAncGFkZGluZ0xlZnQnKSwKICAgIHBhZGRpbmdUb3AgPSBnZXRDU1NJbnQoZWxlbWVudCwgJ3BhZGRpbmdUb3AnKSwKICAgIHBhZGRpbmdSaWdodCA9IGdldENTU0ludChlbGVtZW50LCAncGFkZGluZ1JpZ2h0JyksCiAgICBwYWRkaW5nQm90dG9tID0gZ2V0Q1NTSW50KGVsZW1lbnQsICdwYWRkaW5nQm90dG9tJyk7CgogICAgZHJhd0ltYWdlKAogICAgICBjdHgsCiAgICAgIGltYWdlLAogICAgICAwLCAvL3N4CiAgICAgIDAsIC8vc3kKICAgICAgaW1hZ2Uud2lkdGgsIC8vc3cKICAgICAgaW1hZ2UuaGVpZ2h0LCAvL3NoCiAgICAgIGJvdW5kcy5sZWZ0ICsgcGFkZGluZ0xlZnQgKyBib3JkZXJzWzNdLndpZHRoLCAvL2R4CiAgICAgIGJvdW5kcy50b3AgKyBwYWRkaW5nVG9wICsgYm9yZGVyc1swXS53aWR0aCwgLy8gZHkKICAgICAgYm91bmRzLndpZHRoIC0gKGJvcmRlcnNbMV0ud2lkdGggKyBib3JkZXJzWzNdLndpZHRoICsgcGFkZGluZ0xlZnQgKyBwYWRkaW5nUmlnaHQpLCAvL2R3CiAgICAgIGJvdW5kcy5oZWlnaHQgLSAoYm9yZGVyc1swXS53aWR0aCArIGJvcmRlcnNbMl0ud2lkdGggKyBwYWRkaW5nVG9wICsgcGFkZGluZ0JvdHRvbSkgLy9kaAogICAgICApOwogIH0KCiAgZnVuY3Rpb24gZ2V0Qm9yZGVyRGF0YShlbGVtZW50KSB7CiAgICByZXR1cm4gWyJUb3AiLCAiUmlnaHQiLCAiQm90dG9tIiwgIkxlZnQiXS5tYXAoZnVuY3Rpb24oc2lkZSkgewogICAgICByZXR1cm4gewogICAgICAgIHdpZHRoOiBnZXRDU1NJbnQoZWxlbWVudCwgJ2JvcmRlcicgKyBzaWRlICsgJ1dpZHRoJyksCiAgICAgICAgY29sb3I6IGdldENTUyhlbGVtZW50LCAnYm9yZGVyJyArIHNpZGUgKyAnQ29sb3InKQogICAgICB9OwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBnZXRCb3JkZXJSYWRpdXNEYXRhKGVsZW1lbnQpIHsKICAgIHJldHVybiBbIlRvcExlZnQiLCAiVG9wUmlnaHQiLCAiQm90dG9tUmlnaHQiLCAiQm90dG9tTGVmdCJdLm1hcChmdW5jdGlvbihzaWRlKSB7CiAgICAgIHJldHVybiBnZXRDU1MoZWxlbWVudCwgJ2JvcmRlcicgKyBzaWRlICsgJ1JhZGl1cycpOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBnZXRDdXJ2ZVBvaW50cyh4LCB5LCByMSwgcjIpIHsKICAgIHZhciBrYXBwYSA9IDQgKiAoKE1hdGguc3FydCgyKSAtIDEpIC8gMyk7CiAgICB2YXIgb3ggPSAocjEpICoga2FwcGEsIC8vIGNvbnRyb2wgcG9pbnQgb2Zmc2V0IGhvcml6b250YWwKICAgIG95ID0gKHIyKSAqIGthcHBhLCAvLyBjb250cm9sIHBvaW50IG9mZnNldCB2ZXJ0aWNhbAogICAgeG0gPSB4ICsgcjEsIC8vIHgtbWlkZGxlCiAgICB5bSA9IHkgKyByMjsgLy8geS1taWRkbGUKICAgIHJldHVybiB7CiAgICAgIHRvcExlZnQ6IGJlemllckN1cnZlKHsKICAgICAgICB4OngsCiAgICAgICAgeTp5bQogICAgICB9LCB7CiAgICAgICAgeDp4LAogICAgICAgIHk6eW0gLSBveQogICAgICB9LCB7CiAgICAgICAgeDp4bSAtIG94LAogICAgICAgIHk6eQogICAgICB9LCB7CiAgICAgICAgeDp4bSwKICAgICAgICB5OnkKICAgICAgfSksCiAgICAgIHRvcFJpZ2h0OiBiZXppZXJDdXJ2ZSh7CiAgICAgICAgeDp4LAogICAgICAgIHk6eQogICAgICB9LCB7CiAgICAgICAgeDp4ICsgb3gsCiAgICAgICAgeTp5CiAgICAgIH0sIHsKICAgICAgICB4OnhtLAogICAgICAgIHk6eW0gLSBveQogICAgICB9LCB7CiAgICAgICAgeDp4bSwKICAgICAgICB5OnltCiAgICAgIH0pLAogICAgICBib3R0b21SaWdodDogYmV6aWVyQ3VydmUoewogICAgICAgIHg6eG0sCiAgICAgICAgeTp5CiAgICAgIH0sIHsKICAgICAgICB4OnhtLAogICAgICAgIHk6eSArIG95CiAgICAgIH0sIHsKICAgICAgICB4OnggKyBveCwKICAgICAgICB5OnltCiAgICAgIH0sIHsKICAgICAgICB4OngsCiAgICAgICAgeTp5bQogICAgICB9KSwKICAgICAgYm90dG9tTGVmdDogYmV6aWVyQ3VydmUoewogICAgICAgIHg6eG0sCiAgICAgICAgeTp5bQogICAgICB9LCB7CiAgICAgICAgeDp4bSAtIG94LAogICAgICAgIHk6eW0KICAgICAgfSwgewogICAgICAgIHg6eCwKICAgICAgICB5OnkgKyBveQogICAgICB9LCB7CiAgICAgICAgeDp4LAogICAgICAgIHk6eQogICAgICB9KQogICAgfTsKICB9CgogIGZ1bmN0aW9uIGJlemllckN1cnZlKHN0YXJ0LCBzdGFydENvbnRyb2wsIGVuZENvbnRyb2wsIGVuZCkgewoKICAgIHZhciBsZXJwID0gZnVuY3Rpb24gKGEsIGIsIHQpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB4OmEueCArIChiLnggLSBhLngpICogdCwKICAgICAgICB5OmEueSArIChiLnkgLSBhLnkpICogdAogICAgICB9OwogICAgfTsKCiAgICByZXR1cm4gewogICAgICBzdGFydDogc3RhcnQsCiAgICAgIHN0YXJ0Q29udHJvbDogc3RhcnRDb250cm9sLAogICAgICBlbmRDb250cm9sOiBlbmRDb250cm9sLAogICAgICBlbmQ6IGVuZCwKICAgICAgc3ViZGl2aWRlOiBmdW5jdGlvbih0KSB7CiAgICAgICAgdmFyIGFiID0gbGVycChzdGFydCwgc3RhcnRDb250cm9sLCB0KSwKICAgICAgICBiYyA9IGxlcnAoc3RhcnRDb250cm9sLCBlbmRDb250cm9sLCB0KSwKICAgICAgICBjZCA9IGxlcnAoZW5kQ29udHJvbCwgZW5kLCB0KSwKICAgICAgICBhYmJjID0gbGVycChhYiwgYmMsIHQpLAogICAgICAgIGJjY2QgPSBsZXJwKGJjLCBjZCwgdCksCiAgICAgICAgZGVzdCA9IGxlcnAoYWJiYywgYmNjZCwgdCk7CiAgICAgICAgcmV0dXJuIFtiZXppZXJDdXJ2ZShzdGFydCwgYWIsIGFiYmMsIGRlc3QpLCBiZXppZXJDdXJ2ZShkZXN0LCBiY2NkLCBjZCwgZW5kKV07CiAgICAgIH0sCiAgICAgIGN1cnZlVG86IGZ1bmN0aW9uKGJvcmRlckFyZ3MpIHsKICAgICAgICBib3JkZXJBcmdzLnB1c2goWyJiZXppZXJDdXJ2ZSIsIHN0YXJ0Q29udHJvbC54LCBzdGFydENvbnRyb2wueSwgZW5kQ29udHJvbC54LCBlbmRDb250cm9sLnksIGVuZC54LCBlbmQueV0pOwogICAgICB9LAogICAgICBjdXJ2ZVRvUmV2ZXJzZWQ6IGZ1bmN0aW9uKGJvcmRlckFyZ3MpIHsKICAgICAgICBib3JkZXJBcmdzLnB1c2goWyJiZXppZXJDdXJ2ZSIsIGVuZENvbnRyb2wueCwgZW5kQ29udHJvbC55LCBzdGFydENvbnRyb2wueCwgc3RhcnRDb250cm9sLnksIHN0YXJ0LngsIHN0YXJ0LnldKTsKICAgICAgfQogICAgfTsKICB9CgogIGZ1bmN0aW9uIHBhcnNlQ29ybmVyKGJvcmRlckFyZ3MsIHJhZGl1czEsIHJhZGl1czIsIGNvcm5lcjEsIGNvcm5lcjIsIHgsIHkpIHsKICAgIGlmIChyYWRpdXMxWzBdID4gMCB8fCByYWRpdXMxWzFdID4gMCkgewogICAgICBib3JkZXJBcmdzLnB1c2goWyJsaW5lIiwgY29ybmVyMVswXS5zdGFydC54LCBjb3JuZXIxWzBdLnN0YXJ0LnldKTsKICAgICAgY29ybmVyMVswXS5jdXJ2ZVRvKGJvcmRlckFyZ3MpOwogICAgICBjb3JuZXIxWzFdLmN1cnZlVG8oYm9yZGVyQXJncyk7CiAgICB9IGVsc2UgewogICAgICBib3JkZXJBcmdzLnB1c2goWyJsaW5lIiwgeCwgeV0pOwogICAgfQoKICAgIGlmIChyYWRpdXMyWzBdID4gMCB8fCByYWRpdXMyWzFdID4gMCkgewogICAgICBib3JkZXJBcmdzLnB1c2goWyJsaW5lIiwgY29ybmVyMlswXS5zdGFydC54LCBjb3JuZXIyWzBdLnN0YXJ0LnldKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGRyYXdTaWRlKGJvcmRlckRhdGEsIHJhZGl1czEsIHJhZGl1czIsIG91dGVyMSwgaW5uZXIxLCBvdXRlcjIsIGlubmVyMikgewogICAgdmFyIGJvcmRlckFyZ3MgPSBbXTsKCiAgICBpZiAocmFkaXVzMVswXSA+IDAgfHwgcmFkaXVzMVsxXSA+IDApIHsKICAgICAgYm9yZGVyQXJncy5wdXNoKFsibGluZSIsIG91dGVyMVsxXS5zdGFydC54LCBvdXRlcjFbMV0uc3RhcnQueV0pOwogICAgICBvdXRlcjFbMV0uY3VydmVUbyhib3JkZXJBcmdzKTsKICAgIH0gZWxzZSB7CiAgICAgIGJvcmRlckFyZ3MucHVzaChbICJsaW5lIiwgYm9yZGVyRGF0YS5jMVswXSwgYm9yZGVyRGF0YS5jMVsxXV0pOwogICAgfQoKICAgIGlmIChyYWRpdXMyWzBdID4gMCB8fCByYWRpdXMyWzFdID4gMCkgewogICAgICBib3JkZXJBcmdzLnB1c2goWyJsaW5lIiwgb3V0ZXIyWzBdLnN0YXJ0LngsIG91dGVyMlswXS5zdGFydC55XSk7CiAgICAgIG91dGVyMlswXS5jdXJ2ZVRvKGJvcmRlckFyZ3MpOwogICAgICBib3JkZXJBcmdzLnB1c2goWyJsaW5lIiwgaW5uZXIyWzBdLmVuZC54LCBpbm5lcjJbMF0uZW5kLnldKTsKICAgICAgaW5uZXIyWzBdLmN1cnZlVG9SZXZlcnNlZChib3JkZXJBcmdzKTsKICAgIH0gZWxzZSB7CiAgICAgIGJvcmRlckFyZ3MucHVzaChbICJsaW5lIiwgYm9yZGVyRGF0YS5jMlswXSwgYm9yZGVyRGF0YS5jMlsxXV0pOwogICAgICBib3JkZXJBcmdzLnB1c2goWyAibGluZSIsIGJvcmRlckRhdGEuYzNbMF0sIGJvcmRlckRhdGEuYzNbMV1dKTsKICAgIH0KCiAgICBpZiAocmFkaXVzMVswXSA+IDAgfHwgcmFkaXVzMVsxXSA+IDApIHsKICAgICAgYm9yZGVyQXJncy5wdXNoKFsibGluZSIsIGlubmVyMVsxXS5lbmQueCwgaW5uZXIxWzFdLmVuZC55XSk7CiAgICAgIGlubmVyMVsxXS5jdXJ2ZVRvUmV2ZXJzZWQoYm9yZGVyQXJncyk7CiAgICB9IGVsc2UgewogICAgICBib3JkZXJBcmdzLnB1c2goWyAibGluZSIsIGJvcmRlckRhdGEuYzRbMF0sIGJvcmRlckRhdGEuYzRbMV1dKTsKICAgIH0KCiAgICByZXR1cm4gYm9yZGVyQXJnczsKICB9CgogIGZ1bmN0aW9uIGNhbGN1bGF0ZUN1cnZlUG9pbnRzKGJvdW5kcywgYm9yZGVyUmFkaXVzLCBib3JkZXJzKSB7CgogICAgdmFyIHggPSBib3VuZHMubGVmdCwKICAgIHkgPSBib3VuZHMudG9wLAogICAgd2lkdGggPSBib3VuZHMud2lkdGgsCiAgICBoZWlnaHQgPSBib3VuZHMuaGVpZ2h0LAoKICAgIHRsaCA9IGJvcmRlclJhZGl1c1swXVswXSwKICAgIHRsdiA9IGJvcmRlclJhZGl1c1swXVsxXSwKICAgIHRyaCA9IGJvcmRlclJhZGl1c1sxXVswXSwKICAgIHRydiA9IGJvcmRlclJhZGl1c1sxXVsxXSwKICAgIGJyaCA9IGJvcmRlclJhZGl1c1syXVswXSwKICAgIGJydiA9IGJvcmRlclJhZGl1c1syXVsxXSwKICAgIGJsaCA9IGJvcmRlclJhZGl1c1szXVswXSwKICAgIGJsdiA9IGJvcmRlclJhZGl1c1szXVsxXSwKCiAgICB0b3BXaWR0aCA9IHdpZHRoIC0gdHJoLAogICAgcmlnaHRIZWlnaHQgPSBoZWlnaHQgLSBicnYsCiAgICBib3R0b21XaWR0aCA9IHdpZHRoIC0gYnJoLAogICAgbGVmdEhlaWdodCA9IGhlaWdodCAtIGJsdjsKCiAgICByZXR1cm4gewogICAgICB0b3BMZWZ0T3V0ZXI6IGdldEN1cnZlUG9pbnRzKAogICAgICAgIHgsCiAgICAgICAgeSwKICAgICAgICB0bGgsCiAgICAgICAgdGx2CiAgICAgICAgKS50b3BMZWZ0LnN1YmRpdmlkZSgwLjUpLAoKICAgICAgdG9wTGVmdElubmVyOiBnZXRDdXJ2ZVBvaW50cygKICAgICAgICB4ICsgYm9yZGVyc1szXS53aWR0aCwKICAgICAgICB5ICsgYm9yZGVyc1swXS53aWR0aCwKICAgICAgICBNYXRoLm1heCgwLCB0bGggLSBib3JkZXJzWzNdLndpZHRoKSwKICAgICAgICBNYXRoLm1heCgwLCB0bHYgLSBib3JkZXJzWzBdLndpZHRoKQogICAgICAgICkudG9wTGVmdC5zdWJkaXZpZGUoMC41KSwKCiAgICAgIHRvcFJpZ2h0T3V0ZXI6IGdldEN1cnZlUG9pbnRzKAogICAgICAgIHggKyB0b3BXaWR0aCwKICAgICAgICB5LAogICAgICAgIHRyaCwKICAgICAgICB0cnYKICAgICAgICApLnRvcFJpZ2h0LnN1YmRpdmlkZSgwLjUpLAoKICAgICAgdG9wUmlnaHRJbm5lcjogZ2V0Q3VydmVQb2ludHMoCiAgICAgICAgeCArIE1hdGgubWluKHRvcFdpZHRoLCB3aWR0aCArIGJvcmRlcnNbM10ud2lkdGgpLAogICAgICAgIHkgKyBib3JkZXJzWzBdLndpZHRoLAogICAgICAgICh0b3BXaWR0aCA+IHdpZHRoICsgYm9yZGVyc1szXS53aWR0aCkgPyAwIDp0cmggLSBib3JkZXJzWzNdLndpZHRoLAogICAgICAgIHRydiAtIGJvcmRlcnNbMF0ud2lkdGgKICAgICAgICApLnRvcFJpZ2h0LnN1YmRpdmlkZSgwLjUpLAoKICAgICAgYm90dG9tUmlnaHRPdXRlcjogZ2V0Q3VydmVQb2ludHMoCiAgICAgICAgeCArIGJvdHRvbVdpZHRoLAogICAgICAgIHkgKyByaWdodEhlaWdodCwKICAgICAgICBicmgsCiAgICAgICAgYnJ2CiAgICAgICAgKS5ib3R0b21SaWdodC5zdWJkaXZpZGUoMC41KSwKCiAgICAgIGJvdHRvbVJpZ2h0SW5uZXI6IGdldEN1cnZlUG9pbnRzKAogICAgICAgIHggKyBNYXRoLm1pbihib3R0b21XaWR0aCwgd2lkdGggKyBib3JkZXJzWzNdLndpZHRoKSwKICAgICAgICB5ICsgTWF0aC5taW4ocmlnaHRIZWlnaHQsIGhlaWdodCArIGJvcmRlcnNbMF0ud2lkdGgpLAogICAgICAgIE1hdGgubWF4KDAsIGJyaCAtIGJvcmRlcnNbMV0ud2lkdGgpLAogICAgICAgIE1hdGgubWF4KDAsIGJydiAtIGJvcmRlcnNbMl0ud2lkdGgpCiAgICAgICAgKS5ib3R0b21SaWdodC5zdWJkaXZpZGUoMC41KSwKCiAgICAgIGJvdHRvbUxlZnRPdXRlcjogZ2V0Q3VydmVQb2ludHMoCiAgICAgICAgeCwKICAgICAgICB5ICsgbGVmdEhlaWdodCwKICAgICAgICBibGgsCiAgICAgICAgYmx2CiAgICAgICAgKS5ib3R0b21MZWZ0LnN1YmRpdmlkZSgwLjUpLAoKICAgICAgYm90dG9tTGVmdElubmVyOiBnZXRDdXJ2ZVBvaW50cygKICAgICAgICB4ICsgYm9yZGVyc1szXS53aWR0aCwKICAgICAgICB5ICsgbGVmdEhlaWdodCwKICAgICAgICBNYXRoLm1heCgwLCBibGggLSBib3JkZXJzWzNdLndpZHRoKSwKICAgICAgICBNYXRoLm1heCgwLCBibHYgLSBib3JkZXJzWzJdLndpZHRoKQogICAgICAgICkuYm90dG9tTGVmdC5zdWJkaXZpZGUoMC41KQogICAgfTsKICB9CgogIGZ1bmN0aW9uIGdldEJvcmRlckNsaXAoZWxlbWVudCwgYm9yZGVyUG9pbnRzLCBib3JkZXJzLCByYWRpdXMsIGJvdW5kcykgewogICAgdmFyIGJhY2tncm91bmRDbGlwID0gZ2V0Q1NTKGVsZW1lbnQsICdiYWNrZ3JvdW5kQ2xpcCcpLAogICAgYm9yZGVyQXJncyA9IFtdOwoKICAgIHN3aXRjaChiYWNrZ3JvdW5kQ2xpcCkgewogICAgICBjYXNlICJjb250ZW50LWJveCI6CiAgICAgIGNhc2UgInBhZGRpbmctYm94IjoKICAgICAgICBwYXJzZUNvcm5lcihib3JkZXJBcmdzLCByYWRpdXNbMF0sIHJhZGl1c1sxXSwgYm9yZGVyUG9pbnRzLnRvcExlZnRJbm5lciwgYm9yZGVyUG9pbnRzLnRvcFJpZ2h0SW5uZXIsIGJvdW5kcy5sZWZ0ICsgYm9yZGVyc1szXS53aWR0aCwgYm91bmRzLnRvcCArIGJvcmRlcnNbMF0ud2lkdGgpOwogICAgICAgIHBhcnNlQ29ybmVyKGJvcmRlckFyZ3MsIHJhZGl1c1sxXSwgcmFkaXVzWzJdLCBib3JkZXJQb2ludHMudG9wUmlnaHRJbm5lciwgYm9yZGVyUG9pbnRzLmJvdHRvbVJpZ2h0SW5uZXIsIGJvdW5kcy5sZWZ0ICsgYm91bmRzLndpZHRoIC0gYm9yZGVyc1sxXS53aWR0aCwgYm91bmRzLnRvcCArIGJvcmRlcnNbMF0ud2lkdGgpOwogICAgICAgIHBhcnNlQ29ybmVyKGJvcmRlckFyZ3MsIHJhZGl1c1syXSwgcmFkaXVzWzNdLCBib3JkZXJQb2ludHMuYm90dG9tUmlnaHRJbm5lciwgYm9yZGVyUG9pbnRzLmJvdHRvbUxlZnRJbm5lciwgYm91bmRzLmxlZnQgKyBib3VuZHMud2lkdGggLSBib3JkZXJzWzFdLndpZHRoLCBib3VuZHMudG9wICsgYm91bmRzLmhlaWdodCAtIGJvcmRlcnNbMl0ud2lkdGgpOwogICAgICAgIHBhcnNlQ29ybmVyKGJvcmRlckFyZ3MsIHJhZGl1c1szXSwgcmFkaXVzWzBdLCBib3JkZXJQb2ludHMuYm90dG9tTGVmdElubmVyLCBib3JkZXJQb2ludHMudG9wTGVmdElubmVyLCBib3VuZHMubGVmdCArIGJvcmRlcnNbM10ud2lkdGgsIGJvdW5kcy50b3AgKyBib3VuZHMuaGVpZ2h0IC0gYm9yZGVyc1syXS53aWR0aCk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHBhcnNlQ29ybmVyKGJvcmRlckFyZ3MsIHJhZGl1c1swXSwgcmFkaXVzWzFdLCBib3JkZXJQb2ludHMudG9wTGVmdE91dGVyLCBib3JkZXJQb2ludHMudG9wUmlnaHRPdXRlciwgYm91bmRzLmxlZnQsIGJvdW5kcy50b3ApOwogICAgICAgIHBhcnNlQ29ybmVyKGJvcmRlckFyZ3MsIHJhZGl1c1sxXSwgcmFkaXVzWzJdLCBib3JkZXJQb2ludHMudG9wUmlnaHRPdXRlciwgYm9yZGVyUG9pbnRzLmJvdHRvbVJpZ2h0T3V0ZXIsIGJvdW5kcy5sZWZ0ICsgYm91bmRzLndpZHRoLCBib3VuZHMudG9wKTsKICAgICAgICBwYXJzZUNvcm5lcihib3JkZXJBcmdzLCByYWRpdXNbMl0sIHJhZGl1c1szXSwgYm9yZGVyUG9pbnRzLmJvdHRvbVJpZ2h0T3V0ZXIsIGJvcmRlclBvaW50cy5ib3R0b21MZWZ0T3V0ZXIsIGJvdW5kcy5sZWZ0ICsgYm91bmRzLndpZHRoLCBib3VuZHMudG9wICsgYm91bmRzLmhlaWdodCk7CiAgICAgICAgcGFyc2VDb3JuZXIoYm9yZGVyQXJncywgcmFkaXVzWzNdLCByYWRpdXNbMF0sIGJvcmRlclBvaW50cy5ib3R0b21MZWZ0T3V0ZXIsIGJvcmRlclBvaW50cy50b3BMZWZ0T3V0ZXIsIGJvdW5kcy5sZWZ0LCBib3VuZHMudG9wICsgYm91bmRzLmhlaWdodCk7CiAgICAgICAgYnJlYWs7CiAgICB9CgogICAgcmV0dXJuIGJvcmRlckFyZ3M7CiAgfQoKICBmdW5jdGlvbiBwYXJzZUJvcmRlcnMoZWxlbWVudCwgYm91bmRzLCBib3JkZXJzKXsKICAgIHZhciB4ID0gYm91bmRzLmxlZnQsCiAgICB5ID0gYm91bmRzLnRvcCwKICAgIHdpZHRoID0gYm91bmRzLndpZHRoLAogICAgaGVpZ2h0ID0gYm91bmRzLmhlaWdodCwKICAgIGJvcmRlclNpZGUsCiAgICBieCwKICAgIGJ5LAogICAgYncsCiAgICBiaCwKICAgIGJvcmRlckFyZ3MsCiAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9jc3MzLWJhY2tncm91bmQvI3RoZS1ib3JkZXItcmFkaXVzCiAgICBib3JkZXJSYWRpdXMgPSBnZXRCb3JkZXJSYWRpdXNEYXRhKGVsZW1lbnQpLAogICAgYm9yZGVyUG9pbnRzID0gY2FsY3VsYXRlQ3VydmVQb2ludHMoYm91bmRzLCBib3JkZXJSYWRpdXMsIGJvcmRlcnMpLAogICAgYm9yZGVyRGF0YSA9IHsKICAgICAgY2xpcDogZ2V0Qm9yZGVyQ2xpcChlbGVtZW50LCBib3JkZXJQb2ludHMsIGJvcmRlcnMsIGJvcmRlclJhZGl1cywgYm91bmRzKSwKICAgICAgYm9yZGVyczogW10KICAgIH07CgogICAgZm9yIChib3JkZXJTaWRlID0gMDsgYm9yZGVyU2lkZSA8IDQ7IGJvcmRlclNpZGUrKykgewoKICAgICAgaWYgKGJvcmRlcnNbYm9yZGVyU2lkZV0ud2lkdGggPiAwKSB7CiAgICAgICAgYnggPSB4OwogICAgICAgIGJ5ID0geTsKICAgICAgICBidyA9IHdpZHRoOwogICAgICAgIGJoID0gaGVpZ2h0IC0gKGJvcmRlcnNbMl0ud2lkdGgpOwoKICAgICAgICBzd2l0Y2goYm9yZGVyU2lkZSkgewogICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAvLyB0b3AgYm9yZGVyCiAgICAgICAgICAgIGJoID0gYm9yZGVyc1swXS53aWR0aDsKCiAgICAgICAgICAgIGJvcmRlckFyZ3MgPSBkcmF3U2lkZSh7CiAgICAgICAgICAgICAgYzE6IFtieCwgYnldLAogICAgICAgICAgICAgIGMyOiBbYnggKyBidywgYnldLAogICAgICAgICAgICAgIGMzOiBbYnggKyBidyAtIGJvcmRlcnNbMV0ud2lkdGgsIGJ5ICsgYmhdLAogICAgICAgICAgICAgIGM0OiBbYnggKyBib3JkZXJzWzNdLndpZHRoLCBieSArIGJoXQogICAgICAgICAgICB9LCBib3JkZXJSYWRpdXNbMF0sIGJvcmRlclJhZGl1c1sxXSwKICAgICAgICAgICAgYm9yZGVyUG9pbnRzLnRvcExlZnRPdXRlciwgYm9yZGVyUG9pbnRzLnRvcExlZnRJbm5lciwgYm9yZGVyUG9pbnRzLnRvcFJpZ2h0T3V0ZXIsIGJvcmRlclBvaW50cy50b3BSaWdodElubmVyKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIC8vIHJpZ2h0IGJvcmRlcgogICAgICAgICAgICBieCA9IHggKyB3aWR0aCAtIChib3JkZXJzWzFdLndpZHRoKTsKICAgICAgICAgICAgYncgPSBib3JkZXJzWzFdLndpZHRoOwoKICAgICAgICAgICAgYm9yZGVyQXJncyA9IGRyYXdTaWRlKHsKICAgICAgICAgICAgICBjMTogW2J4ICsgYncsIGJ5XSwKICAgICAgICAgICAgICBjMjogW2J4ICsgYncsIGJ5ICsgYmggKyBib3JkZXJzWzJdLndpZHRoXSwKICAgICAgICAgICAgICBjMzogW2J4LCBieSArIGJoXSwKICAgICAgICAgICAgICBjNDogW2J4LCBieSArIGJvcmRlcnNbMF0ud2lkdGhdCiAgICAgICAgICAgIH0sIGJvcmRlclJhZGl1c1sxXSwgYm9yZGVyUmFkaXVzWzJdLAogICAgICAgICAgICBib3JkZXJQb2ludHMudG9wUmlnaHRPdXRlciwgYm9yZGVyUG9pbnRzLnRvcFJpZ2h0SW5uZXIsIGJvcmRlclBvaW50cy5ib3R0b21SaWdodE91dGVyLCBib3JkZXJQb2ludHMuYm90dG9tUmlnaHRJbm5lcik7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAvLyBib3R0b20gYm9yZGVyCiAgICAgICAgICAgIGJ5ID0gKGJ5ICsgaGVpZ2h0KSAtIChib3JkZXJzWzJdLndpZHRoKTsKICAgICAgICAgICAgYmggPSBib3JkZXJzWzJdLndpZHRoOwoKICAgICAgICAgICAgYm9yZGVyQXJncyA9IGRyYXdTaWRlKHsKICAgICAgICAgICAgICBjMTogW2J4ICsgYncsIGJ5ICsgYmhdLAogICAgICAgICAgICAgIGMyOiBbYngsIGJ5ICsgYmhdLAogICAgICAgICAgICAgIGMzOiBbYnggKyBib3JkZXJzWzNdLndpZHRoLCBieV0sCiAgICAgICAgICAgICAgYzQ6IFtieCArIGJ3IC0gYm9yZGVyc1szXS53aWR0aCwgYnldCiAgICAgICAgICAgIH0sIGJvcmRlclJhZGl1c1syXSwgYm9yZGVyUmFkaXVzWzNdLAogICAgICAgICAgICBib3JkZXJQb2ludHMuYm90dG9tUmlnaHRPdXRlciwgYm9yZGVyUG9pbnRzLmJvdHRvbVJpZ2h0SW5uZXIsIGJvcmRlclBvaW50cy5ib3R0b21MZWZ0T3V0ZXIsIGJvcmRlclBvaW50cy5ib3R0b21MZWZ0SW5uZXIpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgLy8gbGVmdCBib3JkZXIKICAgICAgICAgICAgYncgPSBib3JkZXJzWzNdLndpZHRoOwoKICAgICAgICAgICAgYm9yZGVyQXJncyA9IGRyYXdTaWRlKHsKICAgICAgICAgICAgICBjMTogW2J4LCBieSArIGJoICsgYm9yZGVyc1syXS53aWR0aF0sCiAgICAgICAgICAgICAgYzI6IFtieCwgYnldLAogICAgICAgICAgICAgIGMzOiBbYnggKyBidywgYnkgKyBib3JkZXJzWzBdLndpZHRoXSwKICAgICAgICAgICAgICBjNDogW2J4ICsgYncsIGJ5ICsgYmhdCiAgICAgICAgICAgIH0sIGJvcmRlclJhZGl1c1szXSwgYm9yZGVyUmFkaXVzWzBdLAogICAgICAgICAgICBib3JkZXJQb2ludHMuYm90dG9tTGVmdE91dGVyLCBib3JkZXJQb2ludHMuYm90dG9tTGVmdElubmVyLCBib3JkZXJQb2ludHMudG9wTGVmdE91dGVyLCBib3JkZXJQb2ludHMudG9wTGVmdElubmVyKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBib3JkZXJEYXRhLmJvcmRlcnMucHVzaCh7CiAgICAgICAgICBhcmdzOiBib3JkZXJBcmdzLAogICAgICAgICAgY29sb3I6IGJvcmRlcnNbYm9yZGVyU2lkZV0uY29sb3IKICAgICAgICB9KTsKCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYm9yZGVyRGF0YTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZVNoYXBlKGN0eCwgYXJncykgewogICAgdmFyIHNoYXBlID0gY3R4LmRyYXdTaGFwZSgpOwogICAgYXJncy5mb3JFYWNoKGZ1bmN0aW9uKGJvcmRlciwgaW5kZXgpIHsKICAgICAgc2hhcGVbKGluZGV4ID09PSAwKSA/ICJtb3ZlVG8iIDogYm9yZGVyWzBdICsgIlRvIiBdLmFwcGx5KG51bGwsIGJvcmRlci5zbGljZSgxKSk7CiAgICB9KTsKICAgIHJldHVybiBzaGFwZTsKICB9CgogIGZ1bmN0aW9uIHJlbmRlckJvcmRlcnMoY3R4LCBib3JkZXJBcmdzLCBjb2xvcikgewogICAgaWYgKGNvbG9yICE9PSAidHJhbnNwYXJlbnQiKSB7CiAgICAgIGN0eC5zZXRWYXJpYWJsZSggImZpbGxTdHlsZSIsIGNvbG9yKTsKICAgICAgY3JlYXRlU2hhcGUoY3R4LCBib3JkZXJBcmdzKTsKICAgICAgY3R4LmZpbGwoKTsKICAgICAgbnVtRHJhd3MrPTE7CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZW5kZXJGb3JtVmFsdWUgKGVsLCBib3VuZHMsIHN0YWNrKXsKCiAgICB2YXIgdmFsdWVXcmFwID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ3ZhbHVld3JhcCcpLAogICAgY3NzUHJvcGVydHlBcnJheSA9IFsnbGluZUhlaWdodCcsJ3RleHRBbGlnbicsJ2ZvbnRGYW1pbHknLCdjb2xvcicsJ2ZvbnRTaXplJywncGFkZGluZ0xlZnQnLCdwYWRkaW5nVG9wJywnd2lkdGgnLCdoZWlnaHQnLCdib3JkZXInLCdib3JkZXJMZWZ0V2lkdGgnLCdib3JkZXJUb3BXaWR0aCddLAogICAgdGV4dFZhbHVlLAogICAgdGV4dE5vZGU7CgogICAgY3NzUHJvcGVydHlBcnJheS5mb3JFYWNoKGZ1bmN0aW9uKHByb3BlcnR5KSB7CiAgICAgIHRyeSB7CiAgICAgICAgdmFsdWVXcmFwLnN0eWxlW3Byb3BlcnR5XSA9IGdldENTUyhlbCwgcHJvcGVydHkpOwogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAvLyBPbGRlciBJRSBoYXMgaXNzdWVzIHdpdGggImJvcmRlciIKICAgICAgICBVdGlsLmxvZygiaHRtbDJjYW52YXM6IFBhcnNlOiBFeGNlcHRpb24gY2F1Z2h0IGluIHJlbmRlckZvcm1WYWx1ZTogIiArIGUubWVzc2FnZSk7CiAgICAgIH0KICAgIH0pOwoKICAgIHZhbHVlV3JhcC5zdHlsZS5ib3JkZXJDb2xvciA9ICJibGFjayI7CiAgICB2YWx1ZVdyYXAuc3R5bGUuYm9yZGVyU3R5bGUgPSAic29saWQiOwogICAgdmFsdWVXcmFwLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgdmFsdWVXcmFwLnN0eWxlLnBvc2l0aW9uID0gImFic29sdXRlIjsKCiAgICBpZiAoL14oc3VibWl0fHJlc2V0fGJ1dHRvbnx0ZXh0fHBhc3N3b3JkKSQvLnRlc3QoZWwudHlwZSkgfHwgZWwubm9kZU5hbWUgPT09ICJTRUxFQ1QiKXsKICAgICAgdmFsdWVXcmFwLnN0eWxlLmxpbmVIZWlnaHQgPSBnZXRDU1MoZWwsICJoZWlnaHQiKTsKICAgIH0KCiAgICB2YWx1ZVdyYXAuc3R5bGUudG9wID0gYm91bmRzLnRvcCArICJweCI7CiAgICB2YWx1ZVdyYXAuc3R5bGUubGVmdCA9IGJvdW5kcy5sZWZ0ICsgInB4IjsKCiAgICB0ZXh0VmFsdWUgPSAoZWwubm9kZU5hbWUgPT09ICJTRUxFQ1QiKSA/IChlbC5vcHRpb25zW2VsLnNlbGVjdGVkSW5kZXhdIHx8IDApLnRleHQgOiBlbC52YWx1ZTsKICAgIGlmKCF0ZXh0VmFsdWUpIHsKICAgICAgdGV4dFZhbHVlID0gZWwucGxhY2Vob2xkZXI7CiAgICB9CgogICAgdGV4dE5vZGUgPSBkb2MuY3JlYXRlVGV4dE5vZGUodGV4dFZhbHVlKTsKCiAgICB2YWx1ZVdyYXAuYXBwZW5kQ2hpbGQodGV4dE5vZGUpOwogICAgYm9keS5hcHBlbmRDaGlsZCh2YWx1ZVdyYXApOwoKICAgIHJlbmRlclRleHQoZWwsIHRleHROb2RlLCBzdGFjayk7CiAgICBib2R5LnJlbW92ZUNoaWxkKHZhbHVlV3JhcCk7CiAgfQoKICBmdW5jdGlvbiBkcmF3SW1hZ2UgKGN0eCkgewogICAgY3R4LmRyYXdJbWFnZS5hcHBseShjdHgsIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgbnVtRHJhd3MrPTE7CiAgfQoKICBmdW5jdGlvbiBnZXRQc2V1ZG9FbGVtZW50KGVsLCB3aGljaCkgewogICAgdmFyIGVsU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbCwgd2hpY2gpOwogICAgdmFyIHBhcmVudFN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWwpOwogICAgLy8gSWYgbm8gY29udGVudCBhdHRyaWJ1dGUgaXMgcHJlc2VudCwgdGhlIHBzZXVkbyBlbGVtZW50IGlzIGhpZGRlbiwKICAgIC8vIG9yIHRoZSBwYXJlbnQgaGFzIGEgY29udGVudCBwcm9wZXJ0eSBlcXVhbCB0byB0aGUgY29udGVudCBvbiB0aGUgcHNldWRvIGVsZW1lbnQsCiAgICAvLyBtb3ZlIGFsb25nLgogICAgaWYoIWVsU3R5bGUgfHwgIWVsU3R5bGUuY29udGVudCB8fCBlbFN0eWxlLmNvbnRlbnQgPT09ICJub25lIiB8fCBlbFN0eWxlLmNvbnRlbnQgPT09ICItbW96LWFsdC1jb250ZW50IiB8fAogICAgICAgZWxTdHlsZS5kaXNwbGF5ID09PSAibm9uZSIgfHwgcGFyZW50U3R5bGUuY29udGVudCA9PT0gZWxTdHlsZS5jb250ZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBjb250ZW50ID0gZWxTdHlsZS5jb250ZW50ICsgJyc7CgogICAgLy8gU3RyaXAgaW5uZXIgcXVvdGVzCiAgICBpZihjb250ZW50WzBdID09PSAiJyIgfHwgY29udGVudFswXSA9PT0gIlwiIikgewogICAgICBjb250ZW50ID0gY29udGVudC5yZXBsYWNlKC8oXlsnIl0pfChbJyJdJCkvZywgJycpOwogICAgfQoKICAgIHZhciBpc0ltYWdlID0gY29udGVudC5zdWJzdHIoIDAsIDMgKSA9PT0gJ3VybCcsCiAgICBlbHBzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggaXNJbWFnZSA/ICdpbWcnIDogJ3NwYW4nICk7CgogICAgZWxwcy5jbGFzc05hbWUgPSBwc2V1ZG9IaWRlICsgIi1lbGVtZW50ICI7CgogICAgT2JqZWN0LmtleXMoZWxTdHlsZSkuZmlsdGVyKGluZGV4ZWRQcm9wZXJ0eSkuZm9yRWFjaChmdW5jdGlvbihwcm9wKSB7CiAgICAgIC8vIFByZXZlbnQgYXNzaWduaW5nIG9mIHJlYWQgb25seSBDU1MgUnVsZXMsIGV4LiBsZW5ndGgsIHBhcmVudFJ1bGUKICAgICAgdHJ5IHsKICAgICAgICBlbHBzLnN0eWxlW3Byb3BdID0gZWxTdHlsZVtwcm9wXTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIFV0aWwubG9nKFsnVHJpZWQgdG8gYXNzaWduIHJlYWRvbmx5IHByb3BlcnR5ICcsIHByb3AsICdFcnJvcjonLCBlXSk7CiAgICAgIH0KICAgIH0pOwoKICAgIGlmKGlzSW1hZ2UpIHsKICAgICAgZWxwcy5zcmMgPSBVdGlsLnBhcnNlQmFja2dyb3VuZEltYWdlKGNvbnRlbnQpWzBdLmFyZ3NbMF07CiAgICB9IGVsc2UgewogICAgICBlbHBzLmlubmVySFRNTCA9IGNvbnRlbnQ7CiAgICB9CiAgICByZXR1cm4gZWxwczsKICB9CgogIGZ1bmN0aW9uIGluZGV4ZWRQcm9wZXJ0eShwcm9wZXJ0eSkgewogICAgcmV0dXJuIChpc05hTih3aW5kb3cucGFyc2VJbnQocHJvcGVydHksIDEwKSkpOwogIH0KCiAgZnVuY3Rpb24gcmVuZGVyQmFja2dyb3VuZFJlcGVhdChjdHgsIGltYWdlLCBiYWNrZ3JvdW5kUG9zaXRpb24sIGJvdW5kcykgewogICAgdmFyIG9mZnNldFggPSBNYXRoLnJvdW5kKGJvdW5kcy5sZWZ0ICsgYmFja2dyb3VuZFBvc2l0aW9uLmxlZnQpLAogICAgb2Zmc2V0WSA9IE1hdGgucm91bmQoYm91bmRzLnRvcCArIGJhY2tncm91bmRQb3NpdGlvbi50b3ApOwoKICAgIGN0eC5jcmVhdGVQYXR0ZXJuKGltYWdlKTsKICAgIGN0eC50cmFuc2xhdGUob2Zmc2V0WCwgb2Zmc2V0WSk7CiAgICBjdHguZmlsbCgpOwogICAgY3R4LnRyYW5zbGF0ZSgtb2Zmc2V0WCwgLW9mZnNldFkpOwogIH0KCiAgZnVuY3Rpb24gYmFja2dyb3VuZFJlcGVhdFNoYXBlKGN0eCwgaW1hZ2UsIGJhY2tncm91bmRQb3NpdGlvbiwgYm91bmRzLCBsZWZ0LCB0b3AsIHdpZHRoLCBoZWlnaHQpIHsKICAgIHZhciBhcmdzID0gW107CiAgICBhcmdzLnB1c2goWyJsaW5lIiwgTWF0aC5yb3VuZChsZWZ0KSwgTWF0aC5yb3VuZCh0b3ApXSk7CiAgICBhcmdzLnB1c2goWyJsaW5lIiwgTWF0aC5yb3VuZChsZWZ0ICsgd2lkdGgpLCBNYXRoLnJvdW5kKHRvcCldKTsKICAgIGFyZ3MucHVzaChbImxpbmUiLCBNYXRoLnJvdW5kKGxlZnQgKyB3aWR0aCksIE1hdGgucm91bmQoaGVpZ2h0ICsgdG9wKV0pOwogICAgYXJncy5wdXNoKFsibGluZSIsIE1hdGgucm91bmQobGVmdCksIE1hdGgucm91bmQoaGVpZ2h0ICsgdG9wKV0pOwogICAgY3JlYXRlU2hhcGUoY3R4LCBhcmdzKTsKICAgIGN0eC5zYXZlKCk7CiAgICBjdHguY2xpcCgpOwogICAgcmVuZGVyQmFja2dyb3VuZFJlcGVhdChjdHgsIGltYWdlLCBiYWNrZ3JvdW5kUG9zaXRpb24sIGJvdW5kcyk7CiAgICBjdHgucmVzdG9yZSgpOwogIH0KCiAgZnVuY3Rpb24gcmVuZGVyQmFja2dyb3VuZENvbG9yKGN0eCwgYmFja2dyb3VuZEJvdW5kcywgYmdjb2xvcikgewogICAgcmVuZGVyUmVjdCgKICAgICAgY3R4LAogICAgICBiYWNrZ3JvdW5kQm91bmRzLmxlZnQsCiAgICAgIGJhY2tncm91bmRCb3VuZHMudG9wLAogICAgICBiYWNrZ3JvdW5kQm91bmRzLndpZHRoLAogICAgICBiYWNrZ3JvdW5kQm91bmRzLmhlaWdodCwKICAgICAgYmdjb2xvcgogICAgICApOwogIH0KCiAgZnVuY3Rpb24gcmVuZGVyQmFja2dyb3VuZFJlcGVhdGluZyhlbCwgYm91bmRzLCBjdHgsIGltYWdlLCBpbWFnZUluZGV4KSB7CiAgICB2YXIgYmFja2dyb3VuZFNpemUgPSBVdGlsLkJhY2tncm91bmRTaXplKGVsLCBib3VuZHMsIGltYWdlLCBpbWFnZUluZGV4KSwKICAgIGJhY2tncm91bmRQb3NpdGlvbiA9IFV0aWwuQmFja2dyb3VuZFBvc2l0aW9uKGVsLCBib3VuZHMsIGltYWdlLCBpbWFnZUluZGV4LCBiYWNrZ3JvdW5kU2l6ZSksCiAgICBiYWNrZ3JvdW5kUmVwZWF0ID0gVXRpbC5CYWNrZ3JvdW5kUmVwZWF0KGVsLCBpbWFnZUluZGV4KTsKCiAgICBpbWFnZSA9IHJlc2l6ZUltYWdlKGltYWdlLCBiYWNrZ3JvdW5kU2l6ZSk7CgogICAgc3dpdGNoIChiYWNrZ3JvdW5kUmVwZWF0KSB7CiAgICAgIGNhc2UgInJlcGVhdC14IjoKICAgICAgY2FzZSAicmVwZWF0IG5vLXJlcGVhdCI6CiAgICAgICAgYmFja2dyb3VuZFJlcGVhdFNoYXBlKGN0eCwgaW1hZ2UsIGJhY2tncm91bmRQb3NpdGlvbiwgYm91bmRzLAogICAgICAgICAgYm91bmRzLmxlZnQsIGJvdW5kcy50b3AgKyBiYWNrZ3JvdW5kUG9zaXRpb24udG9wLCA5OTk5OSwgaW1hZ2UuaGVpZ2h0KTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAicmVwZWF0LXkiOgogICAgICBjYXNlICJuby1yZXBlYXQgcmVwZWF0IjoKICAgICAgICBiYWNrZ3JvdW5kUmVwZWF0U2hhcGUoY3R4LCBpbWFnZSwgYmFja2dyb3VuZFBvc2l0aW9uLCBib3VuZHMsCiAgICAgICAgICBib3VuZHMubGVmdCArIGJhY2tncm91bmRQb3NpdGlvbi5sZWZ0LCBib3VuZHMudG9wLCBpbWFnZS53aWR0aCwgOTk5OTkpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJuby1yZXBlYXQiOgogICAgICAgIGJhY2tncm91bmRSZXBlYXRTaGFwZShjdHgsIGltYWdlLCBiYWNrZ3JvdW5kUG9zaXRpb24sIGJvdW5kcywKICAgICAgICAgIGJvdW5kcy5sZWZ0ICsgYmFja2dyb3VuZFBvc2l0aW9uLmxlZnQsIGJvdW5kcy50b3AgKyBiYWNrZ3JvdW5kUG9zaXRpb24udG9wLCBpbWFnZS53aWR0aCwgaW1hZ2UuaGVpZ2h0KTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICByZW5kZXJCYWNrZ3JvdW5kUmVwZWF0KGN0eCwgaW1hZ2UsIGJhY2tncm91bmRQb3NpdGlvbiwgewogICAgICAgICAgdG9wOiBib3VuZHMudG9wLAogICAgICAgICAgbGVmdDogYm91bmRzLmxlZnQsCiAgICAgICAgICB3aWR0aDogaW1hZ2Uud2lkdGgsCiAgICAgICAgICBoZWlnaHQ6IGltYWdlLmhlaWdodAogICAgICAgIH0pOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVuZGVyQmFja2dyb3VuZEltYWdlKGVsZW1lbnQsIGJvdW5kcywgY3R4KSB7CiAgICB2YXIgYmFja2dyb3VuZEltYWdlID0gZ2V0Q1NTKGVsZW1lbnQsICJiYWNrZ3JvdW5kSW1hZ2UiKSwKICAgIGJhY2tncm91bmRJbWFnZXMgPSBVdGlsLnBhcnNlQmFja2dyb3VuZEltYWdlKGJhY2tncm91bmRJbWFnZSksCiAgICBpbWFnZSwKICAgIGltYWdlSW5kZXggPSBiYWNrZ3JvdW5kSW1hZ2VzLmxlbmd0aDsKCiAgICB3aGlsZShpbWFnZUluZGV4LS0pIHsKICAgICAgYmFja2dyb3VuZEltYWdlID0gYmFja2dyb3VuZEltYWdlc1tpbWFnZUluZGV4XTsKCiAgICAgIGlmICghYmFja2dyb3VuZEltYWdlLmFyZ3MgfHwgYmFja2dyb3VuZEltYWdlLmFyZ3MubGVuZ3RoID09PSAwKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIHZhciBrZXkgPSBiYWNrZ3JvdW5kSW1hZ2UubWV0aG9kID09PSAndXJsJyA/CiAgICAgIGJhY2tncm91bmRJbWFnZS5hcmdzWzBdIDoKICAgICAgYmFja2dyb3VuZEltYWdlLnZhbHVlOwoKICAgICAgaW1hZ2UgPSBsb2FkSW1hZ2Uoa2V5KTsKCiAgICAgIC8vIFRPRE8gYWRkIHN1cHBvcnQgZm9yIGJhY2tncm91bmQtb3JpZ2luCiAgICAgIGlmIChpbWFnZSkgewogICAgICAgIHJlbmRlckJhY2tncm91bmRSZXBlYXRpbmcoZWxlbWVudCwgYm91bmRzLCBjdHgsIGltYWdlLCBpbWFnZUluZGV4KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBVdGlsLmxvZygiaHRtbDJjYW52YXM6IEVycm9yIGxvYWRpbmcgYmFja2dyb3VuZDoiLCBiYWNrZ3JvdW5kSW1hZ2UpOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZXNpemVJbWFnZShpbWFnZSwgYm91bmRzKSB7CiAgICBpZihpbWFnZS53aWR0aCA9PT0gYm91bmRzLndpZHRoICYmIGltYWdlLmhlaWdodCA9PT0gYm91bmRzLmhlaWdodCkgewogICAgICByZXR1cm4gaW1hZ2U7CiAgICB9CgogICAgdmFyIGN0eCwgY2FudmFzID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgY2FudmFzLndpZHRoID0gYm91bmRzLndpZHRoOwogICAgY2FudmFzLmhlaWdodCA9IGJvdW5kcy5oZWlnaHQ7CiAgICBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsKICAgIGRyYXdJbWFnZShjdHgsIGltYWdlLCAwLCAwLCBpbWFnZS53aWR0aCwgaW1hZ2UuaGVpZ2h0LCAwLCAwLCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQgKTsKICAgIHJldHVybiBjYW52YXM7CiAgfQoKICBmdW5jdGlvbiBzZXRPcGFjaXR5KGN0eCwgZWxlbWVudCwgcGFyZW50U3RhY2spIHsKICAgIHJldHVybiBjdHguc2V0VmFyaWFibGUoImdsb2JhbEFscGhhIiwgZ2V0Q1NTKGVsZW1lbnQsICJvcGFjaXR5IikgKiAoKHBhcmVudFN0YWNrKSA/IHBhcmVudFN0YWNrLm9wYWNpdHkgOiAxKSk7CiAgfQoKICBmdW5jdGlvbiByZW1vdmVQeChzdHIpIHsKICAgIHJldHVybiBzdHIucmVwbGFjZSgicHgiLCAiIik7CiAgfQoKICBmdW5jdGlvbiBnZXRUcmFuc2Zvcm0oZWxlbWVudCwgcGFyZW50U3RhY2spIHsKICAgIHZhciB0cmFuc2Zvcm1SZWdFeHAgPSAvKG1hdHJpeClcKCguKylcKS87CiAgICB2YXIgdHJhbnNmb3JtID0gZ2V0Q1NTKGVsZW1lbnQsICJ0cmFuc2Zvcm0iKSB8fCBnZXRDU1MoZWxlbWVudCwgIi13ZWJraXQtdHJhbnNmb3JtIikgfHwgZ2V0Q1NTKGVsZW1lbnQsICItbW96LXRyYW5zZm9ybSIpIHx8IGdldENTUyhlbGVtZW50LCAiLW1zLXRyYW5zZm9ybSIpIHx8IGdldENTUyhlbGVtZW50LCAiLW8tdHJhbnNmb3JtIik7CiAgICB2YXIgdHJhbnNmb3JtT3JpZ2luID0gZ2V0Q1NTKGVsZW1lbnQsICJ0cmFuc2Zvcm0tb3JpZ2luIikgfHwgZ2V0Q1NTKGVsZW1lbnQsICItd2Via2l0LXRyYW5zZm9ybS1vcmlnaW4iKSB8fCBnZXRDU1MoZWxlbWVudCwgIi1tb3otdHJhbnNmb3JtLW9yaWdpbiIpIHx8IGdldENTUyhlbGVtZW50LCAiLW1zLXRyYW5zZm9ybS1vcmlnaW4iKSB8fCBnZXRDU1MoZWxlbWVudCwgIi1vLXRyYW5zZm9ybS1vcmlnaW4iKSB8fCAiMHB4IDBweCI7CgogICAgdHJhbnNmb3JtT3JpZ2luID0gdHJhbnNmb3JtT3JpZ2luLnNwbGl0KCIgIikubWFwKHJlbW92ZVB4KS5tYXAoVXRpbC5hc0Zsb2F0KTsKCiAgICB2YXIgbWF0cml4OwogICAgaWYgKHRyYW5zZm9ybSAmJiB0cmFuc2Zvcm0gIT09ICJub25lIikgewogICAgICB2YXIgbWF0Y2ggPSB0cmFuc2Zvcm0ubWF0Y2godHJhbnNmb3JtUmVnRXhwKTsKICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgc3dpdGNoKG1hdGNoWzFdKSB7CiAgICAgICAgICBjYXNlICJtYXRyaXgiOgogICAgICAgICAgICBtYXRyaXggPSBtYXRjaFsyXS5zcGxpdCgiLCIpLm1hcChVdGlsLnRyaW1UZXh0KS5tYXAoVXRpbC5hc0Zsb2F0KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgb3JpZ2luOiB0cmFuc2Zvcm1PcmlnaW4sCiAgICAgIG1hdHJpeDogbWF0cml4CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlU3RhY2soZWxlbWVudCwgcGFyZW50U3RhY2ssIGJvdW5kcywgdHJhbnNmb3JtKSB7CiAgICB2YXIgY3R4ID0gaDJjUmVuZGVyQ29udGV4dCgoIXBhcmVudFN0YWNrKSA/IGRvY3VtZW50V2lkdGgoKSA6IGJvdW5kcy53aWR0aCAsICghcGFyZW50U3RhY2spID8gZG9jdW1lbnRIZWlnaHQoKSA6IGJvdW5kcy5oZWlnaHQpLAogICAgc3RhY2sgPSB7CiAgICAgIGN0eDogY3R4LAogICAgICBvcGFjaXR5OiBzZXRPcGFjaXR5KGN0eCwgZWxlbWVudCwgcGFyZW50U3RhY2spLAogICAgICBjc3NQb3NpdGlvbjogZ2V0Q1NTKGVsZW1lbnQsICJwb3NpdGlvbiIpLAogICAgICBib3JkZXJzOiBnZXRCb3JkZXJEYXRhKGVsZW1lbnQpLAogICAgICB0cmFuc2Zvcm06IHRyYW5zZm9ybSwKICAgICAgY2xpcDogKHBhcmVudFN0YWNrICYmIHBhcmVudFN0YWNrLmNsaXApID8gVXRpbC5FeHRlbmQoIHt9LCBwYXJlbnRTdGFjay5jbGlwICkgOiBudWxsCiAgICB9OwoKICAgIHNldFooZWxlbWVudCwgc3RhY2ssIHBhcmVudFN0YWNrKTsKCiAgICAvLyBUT0RPIGNvcnJlY3Qgb3ZlcmZsb3cgZm9yIGFic29sdXRlIGNvbnRlbnQgcmVzaWRpbmcgdW5kZXIgYSBzdGF0aWMgcG9zaXRpb24KICAgIGlmIChvcHRpb25zLnVzZU92ZXJmbG93ID09PSB0cnVlICYmIC8oaGlkZGVufHNjcm9sbHxhdXRvKS8udGVzdChnZXRDU1MoZWxlbWVudCwgIm92ZXJmbG93IikpID09PSB0cnVlICYmIC8oQk9EWSkvaS50ZXN0KGVsZW1lbnQubm9kZU5hbWUpID09PSBmYWxzZSl7CiAgICAgIHN0YWNrLmNsaXAgPSAoc3RhY2suY2xpcCkgPyBjbGlwQm91bmRzKHN0YWNrLmNsaXAsIGJvdW5kcykgOiBib3VuZHM7CiAgICB9CgogICAgcmV0dXJuIHN0YWNrOwogIH0KCiAgZnVuY3Rpb24gZ2V0QmFja2dyb3VuZEJvdW5kcyhib3JkZXJzLCBib3VuZHMsIGNsaXApIHsKICAgIHZhciBiYWNrZ3JvdW5kQm91bmRzID0gewogICAgICBsZWZ0OiBib3VuZHMubGVmdCArIGJvcmRlcnNbM10ud2lkdGgsCiAgICAgIHRvcDogYm91bmRzLnRvcCArIGJvcmRlcnNbMF0ud2lkdGgsCiAgICAgIHdpZHRoOiBib3VuZHMud2lkdGggLSAoYm9yZGVyc1sxXS53aWR0aCArIGJvcmRlcnNbM10ud2lkdGgpLAogICAgICBoZWlnaHQ6IGJvdW5kcy5oZWlnaHQgLSAoYm9yZGVyc1swXS53aWR0aCArIGJvcmRlcnNbMl0ud2lkdGgpCiAgICB9OwoKICAgIGlmIChjbGlwKSB7CiAgICAgIGJhY2tncm91bmRCb3VuZHMgPSBjbGlwQm91bmRzKGJhY2tncm91bmRCb3VuZHMsIGNsaXApOwogICAgfQoKICAgIHJldHVybiBiYWNrZ3JvdW5kQm91bmRzOwogIH0KCiAgZnVuY3Rpb24gZ2V0Qm91bmRzKGVsZW1lbnQsIHRyYW5zZm9ybSkgewogICAgdmFyIGJvdW5kcyA9ICh0cmFuc2Zvcm0ubWF0cml4KSA/IFV0aWwuT2Zmc2V0Qm91bmRzKGVsZW1lbnQpIDogVXRpbC5Cb3VuZHMoZWxlbWVudCk7CiAgICB0cmFuc2Zvcm0ub3JpZ2luWzBdICs9IGJvdW5kcy5sZWZ0OwogICAgdHJhbnNmb3JtLm9yaWdpblsxXSArPSBib3VuZHMudG9wOwogICAgcmV0dXJuIGJvdW5kczsKICB9CgogIGZ1bmN0aW9uIHJlbmRlckVsZW1lbnQoZWxlbWVudCwgcGFyZW50U3RhY2ssIGlnbm9yZUJhY2tncm91bmQpIHsKICAgIHZhciB0cmFuc2Zvcm0gPSBnZXRUcmFuc2Zvcm0oZWxlbWVudCwgcGFyZW50U3RhY2spLAogICAgYm91bmRzID0gZ2V0Qm91bmRzKGVsZW1lbnQsIHRyYW5zZm9ybSksCiAgICBpbWFnZSwKICAgIHN0YWNrID0gY3JlYXRlU3RhY2soZWxlbWVudCwgcGFyZW50U3RhY2ssIGJvdW5kcywgdHJhbnNmb3JtKSwKICAgIGJvcmRlcnMgPSBzdGFjay5ib3JkZXJzLAogICAgY3R4ID0gc3RhY2suY3R4LAogICAgYmFja2dyb3VuZEJvdW5kcyA9IGdldEJhY2tncm91bmRCb3VuZHMoYm9yZGVycywgYm91bmRzLCBzdGFjay5jbGlwKSwKICAgIGJvcmRlckRhdGEgPSBwYXJzZUJvcmRlcnMoZWxlbWVudCwgYm91bmRzLCBib3JkZXJzKSwKICAgIGJhY2tncm91bmRDb2xvciA9IChpZ25vcmVFbGVtZW50c1JlZ0V4cC50ZXN0KGVsZW1lbnQubm9kZU5hbWUpKSA/ICIjZWZlZmVmIiA6IGdldENTUyhlbGVtZW50LCAiYmFja2dyb3VuZENvbG9yIik7CgoKICAgIGNyZWF0ZVNoYXBlKGN0eCwgYm9yZGVyRGF0YS5jbGlwKTsKCiAgICBjdHguc2F2ZSgpOwogICAgY3R4LmNsaXAoKTsKCiAgICBpZiAoYmFja2dyb3VuZEJvdW5kcy5oZWlnaHQgPiAwICYmIGJhY2tncm91bmRCb3VuZHMud2lkdGggPiAwICYmICFpZ25vcmVCYWNrZ3JvdW5kKSB7CiAgICAgIHJlbmRlckJhY2tncm91bmRDb2xvcihjdHgsIGJvdW5kcywgYmFja2dyb3VuZENvbG9yKTsKICAgICAgcmVuZGVyQmFja2dyb3VuZEltYWdlKGVsZW1lbnQsIGJhY2tncm91bmRCb3VuZHMsIGN0eCk7CiAgICB9IGVsc2UgaWYgKGlnbm9yZUJhY2tncm91bmQpIHsKICAgICAgc3RhY2suYmFja2dyb3VuZENvbG9yID0gIGJhY2tncm91bmRDb2xvcjsKICAgIH0KCiAgICBjdHgucmVzdG9yZSgpOwoKICAgIGJvcmRlckRhdGEuYm9yZGVycy5mb3JFYWNoKGZ1bmN0aW9uKGJvcmRlcikgewogICAgICByZW5kZXJCb3JkZXJzKGN0eCwgYm9yZGVyLmFyZ3MsIGJvcmRlci5jb2xvcik7CiAgICB9KTsKCiAgICBzd2l0Y2goZWxlbWVudC5ub2RlTmFtZSl7CiAgICAgIGNhc2UgIklNRyI6CiAgICAgICAgaWYgKChpbWFnZSA9IGxvYWRJbWFnZShlbGVtZW50LmdldEF0dHJpYnV0ZSgnc3JjJykpKSkgewogICAgICAgICAgcmVuZGVySW1hZ2UoY3R4LCBlbGVtZW50LCBpbWFnZSwgYm91bmRzLCBib3JkZXJzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBFcnJvciBsb2FkaW5nIDxpbWc+OiIgKyBlbGVtZW50LmdldEF0dHJpYnV0ZSgnc3JjJykpOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgY2FzZSAiSU5QVVQiOgogICAgICAgIC8vIFRPRE8gYWRkIGFsbCByZWxldmFudCB0eXBlJ3MsIGkuZS4gSFRNTDUgbmV3IHN0dWZmCiAgICAgICAgLy8gdG9kbyBhZGQgc3VwcG9ydCBmb3IgcGxhY2Vob2xkZXIgYXR0cmlidXRlIGZvciBicm93c2VycyB3aGljaCBzdXBwb3J0IGl0CiAgICAgICAgaWYgKC9eKHRleHR8dXJsfGVtYWlsfHN1Ym1pdHxidXR0b258cmVzZXQpJC8udGVzdChlbGVtZW50LnR5cGUpICYmIChlbGVtZW50LnZhbHVlIHx8IGVsZW1lbnQucGxhY2Vob2xkZXIgfHwgIiIpLmxlbmd0aCA+IDApewogICAgICAgICAgcmVuZGVyRm9ybVZhbHVlKGVsZW1lbnQsIGJvdW5kcywgc3RhY2spOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgY2FzZSAiVEVYVEFSRUEiOgogICAgICAgIGlmICgoZWxlbWVudC52YWx1ZSB8fCBlbGVtZW50LnBsYWNlaG9sZGVyIHx8ICIiKS5sZW5ndGggPiAwKXsKICAgICAgICAgIHJlbmRlckZvcm1WYWx1ZShlbGVtZW50LCBib3VuZHMsIHN0YWNrKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIlNFTEVDVCI6CiAgICAgICAgaWYgKChlbGVtZW50Lm9wdGlvbnN8fGVsZW1lbnQucGxhY2Vob2xkZXIgfHwgIiIpLmxlbmd0aCA+IDApewogICAgICAgICAgcmVuZGVyRm9ybVZhbHVlKGVsZW1lbnQsIGJvdW5kcywgc3RhY2spOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgY2FzZSAiTEkiOgogICAgICAgIHJlbmRlckxpc3RJdGVtKGVsZW1lbnQsIHN0YWNrLCBiYWNrZ3JvdW5kQm91bmRzKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiQ0FOVkFTIjoKICAgICAgICByZW5kZXJJbWFnZShjdHgsIGVsZW1lbnQsIGVsZW1lbnQsIGJvdW5kcywgYm9yZGVycyk7CiAgICAgICAgYnJlYWs7CiAgICB9CgogICAgcmV0dXJuIHN0YWNrOwogIH0KCiAgZnVuY3Rpb24gaXNFbGVtZW50VmlzaWJsZShlbGVtZW50KSB7CiAgICByZXR1cm4gKGdldENTUyhlbGVtZW50LCAnZGlzcGxheScpICE9PSAibm9uZSIgJiYgZ2V0Q1NTKGVsZW1lbnQsICd2aXNpYmlsaXR5JykgIT09ICJoaWRkZW4iICYmICFlbGVtZW50Lmhhc0F0dHJpYnV0ZSgiZGF0YS1odG1sMmNhbnZhcy1pZ25vcmUiKSk7CiAgfQoKICBmdW5jdGlvbiBwYXJzZUVsZW1lbnQgKGVsZW1lbnQsIHN0YWNrLCBjYikgewogICAgaWYgKCFjYikgewogICAgICBjYiA9IGZ1bmN0aW9uKCl7fTsKICAgIH0KICAgIGlmIChpc0VsZW1lbnRWaXNpYmxlKGVsZW1lbnQpKSB7CiAgICAgIHN0YWNrID0gcmVuZGVyRWxlbWVudChlbGVtZW50LCBzdGFjaywgZmFsc2UpIHx8IHN0YWNrOwogICAgICBpZiAoIWlnbm9yZUVsZW1lbnRzUmVnRXhwLnRlc3QoZWxlbWVudC5ub2RlTmFtZSkpIHsKICAgICAgICByZXR1cm4gcGFyc2VDaGlsZHJlbihlbGVtZW50LCBzdGFjaywgY2IpOwogICAgICB9CiAgICB9CiAgICBjYigpOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VDaGlsZHJlbihlbGVtZW50LCBzdGFjaywgY2IpIHsKICAgIHZhciBjaGlsZHJlbiA9IFV0aWwuQ2hpbGRyZW4oZWxlbWVudCk7CiAgICAvLyBBZnRlciBhbGwgbm9kZXMgaGF2ZSBwcm9jZXNzZWQsIGZpbmlzaGVkKCkgd2lsbCBjYWxsIHRoZSBjYi4KICAgIC8vIFdlIGFkZCBvbmUgYW5kIGtpY2sgaXQgb2ZmIHNvIHRoaXMgd2lsbCBzdGlsbCB3b3JrIHdoZW4gY2hpbGRyZW4ubGVuZ3RoID09PSAwLgogICAgLy8gTm90ZSB0aGF0IHVubGVzcyBhc3luYyBpcyB0cnVlLCB0aGlzIHdpbGwgaGFwcGVuIHN5bmNocm9ub3VzbHksIGp1c3Qgd2lsbCBjYWxsYmFja3MuCiAgICB2YXIgam9icyA9IGNoaWxkcmVuLmxlbmd0aCArIDE7CiAgICBmaW5pc2hlZCgpOwoKICAgIGlmIChvcHRpb25zLmFzeW5jKSB7CiAgICAgIGNoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24obm9kZSkgewogICAgICAgIC8vIERvbid0IGJsb2NrIHRoZSBwYWdlIGZyb20gcmVuZGVyaW5nCiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpeyBwYXJzZU5vZGUobm9kZSk7IH0sIDApOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGNoaWxkcmVuLmZvckVhY2gocGFyc2VOb2RlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBwYXJzZU5vZGUobm9kZSkgewogICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gbm9kZS5FTEVNRU5UX05PREUpIHsKICAgICAgICBwYXJzZUVsZW1lbnQobm9kZSwgc3RhY2ssIGZpbmlzaGVkKTsKICAgICAgfSBlbHNlIGlmIChub2RlLm5vZGVUeXBlID09PSBub2RlLlRFWFRfTk9ERSkgewogICAgICAgIHJlbmRlclRleHQoZWxlbWVudCwgbm9kZSwgc3RhY2spOwogICAgICAgIGZpbmlzaGVkKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZmluaXNoZWQoKTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZmluaXNoZWQoZWwpIHsKICAgICAgaWYgKC0tam9icyA8PSAwKXsKICAgICAgICBVdGlsLmxvZygiZmluaXNoZWQgcmVuZGVyaW5nICIgKyBjaGlsZHJlbi5sZW5ndGggKyAiIGNoaWxkcmVuLiIpOwogICAgICAgIGNiKCk7CiAgICAgIH0KICAgIH0KICB9Cn07Cl9odG1sMmNhbnZhcy5QcmVsb2FkID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgogIHZhciBpbWFnZXMgPSB7CiAgICBudW1Mb2FkZWQ6IDAsICAgLy8gYWxzbyBmYWlsZWQgYXJlIGNvdW50ZWQgaGVyZQogICAgbnVtRmFpbGVkOiAwLAogICAgbnVtVG90YWw6IDAsCiAgICBjbGVhbnVwRG9uZTogZmFsc2UKICB9LAogIHBhZ2VPcmlnaW4sCiAgVXRpbCA9IF9odG1sMmNhbnZhcy5VdGlsLAogIG1ldGhvZHMsCiAgaSwKICBjb3VudCA9IDAsCiAgZWxlbWVudCA9IG9wdGlvbnMuZWxlbWVudHNbMF0gfHwgZG9jdW1lbnQuYm9keSwKICBkb2MgPSBlbGVtZW50Lm93bmVyRG9jdW1lbnQsCiAgZG9tSW1hZ2VzID0gZWxlbWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaW1nJyksIC8vIEZldGNoIGltYWdlcyBvZiB0aGUgcHJlc2VudCBlbGVtZW50IG9ubHkKICBpbWdMZW4gPSBkb21JbWFnZXMubGVuZ3RoLAogIGxpbmsgPSBkb2MuY3JlYXRlRWxlbWVudCgiYSIpLAogIHN1cHBvcnRDT1JTID0gKGZ1bmN0aW9uKCBpbWcgKXsKICAgIHJldHVybiAoaW1nLmNyb3NzT3JpZ2luICE9PSB1bmRlZmluZWQpOwogIH0pKG5ldyBJbWFnZSgpKSwKICB0aW1lb3V0VGltZXI7CgogIGxpbmsuaHJlZiA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmOwogIHBhZ2VPcmlnaW4gID0gbGluay5wcm90b2NvbCArIGxpbmsuaG9zdDsKCiAgZnVuY3Rpb24gaXNTYW1lT3JpZ2luKHVybCl7CiAgICBsaW5rLmhyZWYgPSB1cmw7CiAgICBsaW5rLmhyZWYgPSBsaW5rLmhyZWY7IC8vIFlFUywgQkVMSUVWRSBJVCBPUiBOT1QsIHRoYXQgaXMgcmVxdWlyZWQgZm9yIElFOSAtIGh0dHA6Ly9qc2ZpZGRsZS5uZXQvbmlrbGFzdmgvMmU0OGIvCiAgICB2YXIgb3JpZ2luID0gbGluay5wcm90b2NvbCArIGxpbmsuaG9zdDsKICAgIHJldHVybiAob3JpZ2luID09PSBwYWdlT3JpZ2luKTsKICB9CgogIGZ1bmN0aW9uIHN0YXJ0KCl7CiAgICBVdGlsLmxvZygiaHRtbDJjYW52YXM6IHN0YXJ0OiBpbWFnZXM6ICIgKyBpbWFnZXMubnVtTG9hZGVkICsgIiAvICIgKyBpbWFnZXMubnVtVG90YWwgKyAiIChmYWlsZWQ6ICIgKyBpbWFnZXMubnVtRmFpbGVkICsgIikiKTsKICAgIGlmICghaW1hZ2VzLmZpcnN0UnVuICYmIGltYWdlcy5udW1Mb2FkZWQgPj0gaW1hZ2VzLm51bVRvdGFsKXsKICAgICAgVXRpbC5sb2coIkZpbmlzaGVkIGxvYWRpbmcgaW1hZ2VzOiAjICIgKyBpbWFnZXMubnVtVG90YWwgKyAiIChmYWlsZWQ6ICIgKyBpbWFnZXMubnVtRmFpbGVkICsgIikiKTsKCiAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5jb21wbGV0ZSA9PT0gImZ1bmN0aW9uIil7CiAgICAgICAgb3B0aW9ucy5jb21wbGV0ZShpbWFnZXMpOwogICAgICB9CgogICAgfQogIH0KCiAgLy8gVE9ETyBtb2RpZnkgcHJveHkgdG8gc2VydmUgaW1hZ2VzIHdpdGggQ09SUyBlbmFibGVkLCB3aGVyZSBhdmFpbGFibGUKICBmdW5jdGlvbiBwcm94eUdldEltYWdlKHVybCwgaW1nLCBpbWFnZU9iail7CiAgICB2YXIgY2FsbGJhY2tfbmFtZSwKICAgIHNjcmlwdFVybCA9IG9wdGlvbnMucHJveHksCiAgICBzY3JpcHQ7CgogICAgbGluay5ocmVmID0gdXJsOwogICAgdXJsID0gbGluay5ocmVmOyAvLyB3b3JrIGFyb3VuZCBmb3IgcGFnZXMgd2l0aCBiYXNlIGhyZWY9IiIgc2V0IC0gV0FSTklORzogdGhpcyBtYXkgY2hhbmdlIHRoZSB1cmwKCiAgICBjYWxsYmFja19uYW1lID0gJ2h0bWwyY2FudmFzXycgKyAoY291bnQrKyk7CiAgICBpbWFnZU9iai5jYWxsYmFja25hbWUgPSBjYWxsYmFja19uYW1lOwoKICAgIGlmIChzY3JpcHRVcmwuaW5kZXhPZigiPyIpID4gLTEpIHsKICAgICAgc2NyaXB0VXJsICs9ICImIjsKICAgIH0gZWxzZSB7CiAgICAgIHNjcmlwdFVybCArPSAiPyI7CiAgICB9CiAgICBzY3JpcHRVcmwgKz0gJ3VybD0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHVybCkgKyAnJmNhbGxiYWNrPScgKyBjYWxsYmFja19uYW1lOwogICAgc2NyaXB0ID0gZG9jLmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwoKICAgIHdpbmRvd1tjYWxsYmFja19uYW1lXSA9IGZ1bmN0aW9uKGEpewogICAgICBpZiAoYS5zdWJzdHJpbmcoMCw2KSA9PT0gImVycm9yOiIpewogICAgICAgIGltYWdlT2JqLnN1Y2NlZWRlZCA9IGZhbHNlOwogICAgICAgIGltYWdlcy5udW1Mb2FkZWQrKzsKICAgICAgICBpbWFnZXMubnVtRmFpbGVkKys7CiAgICAgICAgc3RhcnQoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXRJbWFnZUxvYWRIYW5kbGVycyhpbWcsIGltYWdlT2JqKTsKICAgICAgICBpbWcuc3JjID0gYTsKICAgICAgfQogICAgICB3aW5kb3dbY2FsbGJhY2tfbmFtZV0gPSB1bmRlZmluZWQ7IC8vIHRvIHdvcmsgd2l0aCBJRTw5ICAvLyBOT1RFOiB0aGF0IHRoZSB1bmRlZmluZWQgY2FsbGJhY2sgcHJvcGVydHktbmFtZSBzdGlsbCBleGlzdHMgb24gdGhlIHdpbmRvdyBvYmplY3QgKGZvciBJRTw5KQogICAgICB0cnkgewogICAgICAgIGRlbGV0ZSB3aW5kb3dbY2FsbGJhY2tfbmFtZV07ICAvLyBmb3IgYWxsIGJyb3dzZXIgdGhhdCBzdXBwb3J0IHRoaXMKICAgICAgfSBjYXRjaChleCkge30KICAgICAgc2NyaXB0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKICAgICAgc2NyaXB0ID0gbnVsbDsKICAgICAgZGVsZXRlIGltYWdlT2JqLnNjcmlwdDsKICAgICAgZGVsZXRlIGltYWdlT2JqLmNhbGxiYWNrbmFtZTsKICAgIH07CgogICAgc2NyaXB0LnNldEF0dHJpYnV0ZSgidHlwZSIsICJ0ZXh0L2phdmFzY3JpcHQiKTsKICAgIHNjcmlwdC5zZXRBdHRyaWJ1dGUoInNyYyIsIHNjcmlwdFVybCk7CiAgICBpbWFnZU9iai5zY3JpcHQgPSBzY3JpcHQ7CiAgICB3aW5kb3cuZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzY3JpcHQpOwoKICB9CgogIGZ1bmN0aW9uIGxvYWRQc2V1ZG9FbGVtZW50KGVsZW1lbnQsIHR5cGUpIHsKICAgIHZhciBzdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsZW1lbnQsIHR5cGUpLAogICAgY29udGVudCA9IHN0eWxlLmNvbnRlbnQ7CiAgICBpZiAoY29udGVudC5zdWJzdHIoMCwgMykgPT09ICd1cmwnKSB7CiAgICAgIG1ldGhvZHMubG9hZEltYWdlKF9odG1sMmNhbnZhcy5VdGlsLnBhcnNlQmFja2dyb3VuZEltYWdlKGNvbnRlbnQpWzBdLmFyZ3NbMF0pOwogICAgfQogICAgbG9hZEJhY2tncm91bmRJbWFnZXMoc3R5bGUuYmFja2dyb3VuZEltYWdlLCBlbGVtZW50KTsKICB9CgogIGZ1bmN0aW9uIGxvYWRQc2V1ZG9FbGVtZW50SW1hZ2VzKGVsZW1lbnQpIHsKICAgIGxvYWRQc2V1ZG9FbGVtZW50KGVsZW1lbnQsICI6YmVmb3JlIik7CiAgICBsb2FkUHNldWRvRWxlbWVudChlbGVtZW50LCAiOmFmdGVyIik7CiAgfQoKICBmdW5jdGlvbiBsb2FkR3JhZGllbnRJbWFnZShiYWNrZ3JvdW5kSW1hZ2UsIGJvdW5kcykgewogICAgdmFyIGltZyA9IF9odG1sMmNhbnZhcy5HZW5lcmF0ZS5HcmFkaWVudChiYWNrZ3JvdW5kSW1hZ2UsIGJvdW5kcyk7CgogICAgaWYgKGltZyAhPT0gdW5kZWZpbmVkKXsKICAgICAgaW1hZ2VzW2JhY2tncm91bmRJbWFnZV0gPSB7CiAgICAgICAgaW1nOiBpbWcsCiAgICAgICAgc3VjY2VlZGVkOiB0cnVlCiAgICAgIH07CiAgICAgIGltYWdlcy5udW1Ub3RhbCsrOwogICAgICBpbWFnZXMubnVtTG9hZGVkKys7CiAgICAgIHN0YXJ0KCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpbnZhbGlkQmFja2dyb3VuZHMoYmFja2dyb3VuZF9pbWFnZSkgewogICAgcmV0dXJuIChiYWNrZ3JvdW5kX2ltYWdlICYmIGJhY2tncm91bmRfaW1hZ2UubWV0aG9kICYmIGJhY2tncm91bmRfaW1hZ2UuYXJncyAmJiBiYWNrZ3JvdW5kX2ltYWdlLmFyZ3MubGVuZ3RoID4gMCApOwogIH0KCiAgZnVuY3Rpb24gbG9hZEJhY2tncm91bmRJbWFnZXMoYmFja2dyb3VuZF9pbWFnZSwgZWwpIHsKICAgIHZhciBib3VuZHM7CgogICAgX2h0bWwyY2FudmFzLlV0aWwucGFyc2VCYWNrZ3JvdW5kSW1hZ2UoYmFja2dyb3VuZF9pbWFnZSkuZmlsdGVyKGludmFsaWRCYWNrZ3JvdW5kcykuZm9yRWFjaChmdW5jdGlvbihiYWNrZ3JvdW5kX2ltYWdlKSB7CiAgICAgIGlmIChiYWNrZ3JvdW5kX2ltYWdlLm1ldGhvZCA9PT0gJ3VybCcpIHsKICAgICAgICBtZXRob2RzLmxvYWRJbWFnZShiYWNrZ3JvdW5kX2ltYWdlLmFyZ3NbMF0pOwogICAgICB9IGVsc2UgaWYoYmFja2dyb3VuZF9pbWFnZS5tZXRob2QubWF0Y2goL1wtP2dyYWRpZW50JC8pKSB7CiAgICAgICAgaWYoYm91bmRzID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGJvdW5kcyA9IF9odG1sMmNhbnZhcy5VdGlsLkJvdW5kcyhlbCk7CiAgICAgICAgfQogICAgICAgIGxvYWRHcmFkaWVudEltYWdlKGJhY2tncm91bmRfaW1hZ2UudmFsdWUsIGJvdW5kcyk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gZ2V0SW1hZ2VzIChlbCkgewogICAgdmFyIGVsTm9kZVR5cGUgPSBmYWxzZTsKCiAgICAvLyBGaXJlZm94IGZhaWxzIHdpdGggcGVybWlzc2lvbiBkZW5pZWQgb24gcGFnZXMgd2l0aCBpZnJhbWVzCiAgICB0cnkgewogICAgICBVdGlsLkNoaWxkcmVuKGVsKS5mb3JFYWNoKGdldEltYWdlcyk7CiAgICB9CiAgICBjYXRjaCggZSApIHt9CgogICAgdHJ5IHsKICAgICAgZWxOb2RlVHlwZSA9IGVsLm5vZGVUeXBlOwogICAgfSBjYXRjaCAoZXgpIHsKICAgICAgZWxOb2RlVHlwZSA9IGZhbHNlOwogICAgICBVdGlsLmxvZygiaHRtbDJjYW52YXM6IGZhaWxlZCB0byBhY2Nlc3Mgc29tZSBlbGVtZW50J3Mgbm9kZVR5cGUgLSBFeGNlcHRpb246ICIgKyBleC5tZXNzYWdlKTsKICAgIH0KCiAgICBpZiAoZWxOb2RlVHlwZSA9PT0gMSB8fCBlbE5vZGVUeXBlID09PSB1bmRlZmluZWQpIHsKICAgICAgbG9hZFBzZXVkb0VsZW1lbnRJbWFnZXMoZWwpOwogICAgICB0cnkgewogICAgICAgIGxvYWRCYWNrZ3JvdW5kSW1hZ2VzKFV0aWwuZ2V0Q1NTKGVsLCAnYmFja2dyb3VuZEltYWdlJyksIGVsKTsKICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBmYWlsZWQgdG8gZ2V0IGJhY2tncm91bmQtaW1hZ2UgLSBFeGNlcHRpb246ICIgKyBlLm1lc3NhZ2UpOwogICAgICB9CiAgICAgIGxvYWRCYWNrZ3JvdW5kSW1hZ2VzKGVsKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHNldEltYWdlTG9hZEhhbmRsZXJzKGltZywgaW1hZ2VPYmopIHsKICAgIGltZy5vbmxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKCBpbWFnZU9iai50aW1lciAhPT0gdW5kZWZpbmVkICkgewogICAgICAgIC8vIENPUlMgc3VjY2VlZGVkCiAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCggaW1hZ2VPYmoudGltZXIgKTsKICAgICAgfQoKICAgICAgaW1hZ2VzLm51bUxvYWRlZCsrOwogICAgICBpbWFnZU9iai5zdWNjZWVkZWQgPSB0cnVlOwogICAgICBpbWcub25lcnJvciA9IGltZy5vbmxvYWQgPSBudWxsOwogICAgICBzdGFydCgpOwogICAgfTsKICAgIGltZy5vbmVycm9yID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmIChpbWcuY3Jvc3NPcmlnaW4gPT09ICJhbm9ueW1vdXMiKSB7CiAgICAgICAgLy8gQ09SUyBmYWlsZWQKICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KCBpbWFnZU9iai50aW1lciApOwoKICAgICAgICAvLyBsZXQncyB0cnkgd2l0aCBwcm94eSBpbnN0ZWFkCiAgICAgICAgaWYgKCBvcHRpb25zLnByb3h5ICkgewogICAgICAgICAgdmFyIHNyYyA9IGltZy5zcmM7CiAgICAgICAgICBpbWcgPSBuZXcgSW1hZ2UoKTsKICAgICAgICAgIGltYWdlT2JqLmltZyA9IGltZzsKICAgICAgICAgIGltZy5zcmMgPSBzcmM7CgogICAgICAgICAgcHJveHlHZXRJbWFnZSggaW1nLnNyYywgaW1nLCBpbWFnZU9iaiApOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaW1hZ2VzLm51bUxvYWRlZCsrOwogICAgICBpbWFnZXMubnVtRmFpbGVkKys7CiAgICAgIGltYWdlT2JqLnN1Y2NlZWRlZCA9IGZhbHNlOwogICAgICBpbWcub25lcnJvciA9IGltZy5vbmxvYWQgPSBudWxsOwogICAgICBzdGFydCgpOwogICAgfTsKICB9CgogIG1ldGhvZHMgPSB7CiAgICBsb2FkSW1hZ2U6IGZ1bmN0aW9uKCBzcmMgKSB7CiAgICAgIHZhciBpbWcsIGltYWdlT2JqOwogICAgICBpZiAoIHNyYyAmJiBpbWFnZXNbc3JjXSA9PT0gdW5kZWZpbmVkICkgewogICAgICAgIGltZyA9IG5ldyBJbWFnZSgpOwogICAgICAgIGlmICggc3JjLm1hdGNoKC9kYXRhOmltYWdlXC8uKjtiYXNlNjQsL2kpICkgewogICAgICAgICAgaW1nLnNyYyA9IHNyYy5yZXBsYWNlKC91cmxcKFsnIl17MCx9fFsnIl17MCx9XCkkL2lnLCAnJyk7CiAgICAgICAgICBpbWFnZU9iaiA9IGltYWdlc1tzcmNdID0gewogICAgICAgICAgICBpbWc6IGltZwogICAgICAgICAgfTsKICAgICAgICAgIGltYWdlcy5udW1Ub3RhbCsrOwogICAgICAgICAgc2V0SW1hZ2VMb2FkSGFuZGxlcnMoaW1nLCBpbWFnZU9iaik7CiAgICAgICAgfSBlbHNlIGlmICggaXNTYW1lT3JpZ2luKCBzcmMgKSB8fCBvcHRpb25zLmFsbG93VGFpbnQgPT09ICB0cnVlICkgewogICAgICAgICAgaW1hZ2VPYmogPSBpbWFnZXNbc3JjXSA9IHsKICAgICAgICAgICAgaW1nOiBpbWcKICAgICAgICAgIH07CiAgICAgICAgICBpbWFnZXMubnVtVG90YWwrKzsKICAgICAgICAgIHNldEltYWdlTG9hZEhhbmRsZXJzKGltZywgaW1hZ2VPYmopOwogICAgICAgICAgaW1nLnNyYyA9IHNyYzsKICAgICAgICB9IGVsc2UgaWYgKCBzdXBwb3J0Q09SUyAmJiAhb3B0aW9ucy5hbGxvd1RhaW50ICYmIG9wdGlvbnMudXNlQ09SUyApIHsKICAgICAgICAgIC8vIGF0dGVtcHQgdG8gbG9hZCB3aXRoIENPUlMKCiAgICAgICAgICBpbWcuY3Jvc3NPcmlnaW4gPSAiYW5vbnltb3VzIjsKICAgICAgICAgIGltYWdlT2JqID0gaW1hZ2VzW3NyY10gPSB7CiAgICAgICAgICAgIGltZzogaW1nCiAgICAgICAgICB9OwogICAgICAgICAgaW1hZ2VzLm51bVRvdGFsKys7CiAgICAgICAgICBzZXRJbWFnZUxvYWRIYW5kbGVycyhpbWcsIGltYWdlT2JqKTsKICAgICAgICAgIGltZy5zcmMgPSBzcmM7CiAgICAgICAgfSBlbHNlIGlmICggb3B0aW9ucy5wcm94eSApIHsKICAgICAgICAgIGltYWdlT2JqID0gaW1hZ2VzW3NyY10gPSB7CiAgICAgICAgICAgIGltZzogaW1nCiAgICAgICAgICB9OwogICAgICAgICAgaW1hZ2VzLm51bVRvdGFsKys7CiAgICAgICAgICBwcm94eUdldEltYWdlKCBzcmMsIGltZywgaW1hZ2VPYmogKTsKICAgICAgICB9CiAgICAgIH0KCiAgICB9LAogICAgY2xlYW51cERPTTogZnVuY3Rpb24oY2F1c2UpIHsKICAgICAgdmFyIGltZywgc3JjOwogICAgICBpZiAoIWltYWdlcy5jbGVhbnVwRG9uZSkgewogICAgICAgIGlmIChjYXVzZSAmJiB0eXBlb2YgY2F1c2UgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICBVdGlsLmxvZygiaHRtbDJjYW52YXM6IENsZWFudXAgYmVjYXVzZTogIiArIGNhdXNlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBDbGVhbnVwIGFmdGVyIHRpbWVvdXQ6ICIgKyBvcHRpb25zLnRpbWVvdXQgKyAiIG1zLiIpOwogICAgICAgIH0KCiAgICAgICAgZm9yIChzcmMgaW4gaW1hZ2VzKSB7CiAgICAgICAgICBpZiAoaW1hZ2VzLmhhc093blByb3BlcnR5KHNyYykpIHsKICAgICAgICAgICAgaW1nID0gaW1hZ2VzW3NyY107CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW1nID09PSAib2JqZWN0IiAmJiBpbWcuY2FsbGJhY2tuYW1lICYmIGltZy5zdWNjZWVkZWQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIC8vIGNhbmNlbCBwcm94eSBpbWFnZSByZXF1ZXN0CiAgICAgICAgICAgICAgd2luZG93W2ltZy5jYWxsYmFja25hbWVdID0gdW5kZWZpbmVkOyAvLyB0byB3b3JrIHdpdGggSUU8OSAgLy8gTk9URTogdGhhdCB0aGUgdW5kZWZpbmVkIGNhbGxiYWNrIHByb3BlcnR5LW5hbWUgc3RpbGwgZXhpc3RzIG9uIHRoZSB3aW5kb3cgb2JqZWN0IChmb3IgSUU8OSkKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgZGVsZXRlIHdpbmRvd1tpbWcuY2FsbGJhY2tuYW1lXTsgIC8vIGZvciBhbGwgYnJvd3NlciB0aGF0IHN1cHBvcnQgdGhpcwogICAgICAgICAgICAgIH0gY2F0Y2goZXgpIHt9CiAgICAgICAgICAgICAgaWYgKGltZy5zY3JpcHQgJiYgaW1nLnNjcmlwdC5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICBpbWcuc2NyaXB0LnNldEF0dHJpYnV0ZSgic3JjIiwgImFib3V0OmJsYW5rIik7ICAvLyB0cnkgdG8gY2FuY2VsIHJ1bm5pbmcgcmVxdWVzdAogICAgICAgICAgICAgICAgaW1nLnNjcmlwdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGltZy5zY3JpcHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpbWFnZXMubnVtTG9hZGVkKys7CiAgICAgICAgICAgICAgaW1hZ2VzLm51bUZhaWxlZCsrOwogICAgICAgICAgICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogQ2xlYW5lZCB1cCBmYWlsZWQgaW1nOiAnIiArIHNyYyArICInIFN0ZXBzOiAiICsgaW1hZ2VzLm51bUxvYWRlZCArICIgLyAiICsgaW1hZ2VzLm51bVRvdGFsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gY2FuY2VsIGFueSBwZW5kaW5nIHJlcXVlc3RzCiAgICAgICAgaWYod2luZG93LnN0b3AgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgd2luZG93LnN0b3AoKTsKICAgICAgICB9IGVsc2UgaWYoZG9jdW1lbnQuZXhlY0NvbW1hbmQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoIlN0b3AiLCBmYWxzZSk7CiAgICAgICAgfQogICAgICAgIGlmIChkb2N1bWVudC5jbG9zZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBkb2N1bWVudC5jbG9zZSgpOwogICAgICAgIH0KICAgICAgICBpbWFnZXMuY2xlYW51cERvbmUgPSB0cnVlOwogICAgICAgIGlmICghKGNhdXNlICYmIHR5cGVvZiBjYXVzZSA9PT0gInN0cmluZyIpKSB7CiAgICAgICAgICBzdGFydCgpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICByZW5kZXJpbmdEb25lOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRpbWVvdXRUaW1lcikgewogICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodGltZW91dFRpbWVyKTsKICAgICAgfQogICAgfQogIH07CgogIGlmIChvcHRpb25zLnRpbWVvdXQgPiAwKSB7CiAgICB0aW1lb3V0VGltZXIgPSB3aW5kb3cuc2V0VGltZW91dChtZXRob2RzLmNsZWFudXBET00sIG9wdGlvbnMudGltZW91dCk7CiAgfQoKICBVdGlsLmxvZygnaHRtbDJjYW52YXM6IFByZWxvYWQgc3RhcnRzOiBmaW5kaW5nIGJhY2tncm91bmQtaW1hZ2VzJyk7CiAgaW1hZ2VzLmZpcnN0UnVuID0gdHJ1ZTsKCiAgZ2V0SW1hZ2VzKGVsZW1lbnQpOwoKICBVdGlsLmxvZygnaHRtbDJjYW52YXM6IFByZWxvYWQ6IEZpbmRpbmcgaW1hZ2VzJyk7CiAgLy8gbG9hZCA8aW1nPiBpbWFnZXMKICBmb3IgKGkgPSAwOyBpIDwgaW1nTGVuOyBpKz0xKXsKICAgIG1ldGhvZHMubG9hZEltYWdlKCBkb21JbWFnZXNbaV0uZ2V0QXR0cmlidXRlKCAic3JjIiApICk7CiAgfQoKICBpbWFnZXMuZmlyc3RSdW4gPSBmYWxzZTsKICBVdGlsLmxvZygnaHRtbDJjYW52YXM6IFByZWxvYWQ6IERvbmUuJyk7CiAgaWYgKGltYWdlcy5udW1Ub3RhbCA9PT0gaW1hZ2VzLm51bUxvYWRlZCkgewogICAgc3RhcnQoKTsKICB9CgogIHJldHVybiBtZXRob2RzOwp9OwoKX2h0bWwyY2FudmFzLlJlbmRlcmVyID0gZnVuY3Rpb24ocGFyc2VRdWV1ZSwgb3B0aW9ucyl7CiAgZnVuY3Rpb24gc29ydFppbmRleChhLCBiKSB7CiAgICBpZiAoYSA9PT0gJ2NoaWxkcmVuJykgewogICAgICByZXR1cm4gLTE7CiAgICB9IGVsc2UgaWYgKGIgPT09ICdjaGlsZHJlbicpIHsKICAgICAgcmV0dXJuIDE7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gYSAtIGI7CiAgICB9CiAgfQoKICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9DU1MyMS96aW5kZXguaHRtbAogIGZ1bmN0aW9uIGNyZWF0ZVJlbmRlclF1ZXVlKHBhcnNlUXVldWUpIHsKICAgIHZhciBxdWV1ZSA9IFtdLAogICAgcm9vdENvbnRleHQ7CgogICAgcm9vdENvbnRleHQgPSAoZnVuY3Rpb24gYnVpbGRTdGFja2luZ0NvbnRleHQocm9vdE5vZGUpIHsKICAgICAgdmFyIHJvb3RDb250ZXh0ID0ge307CiAgICAgIGZ1bmN0aW9uIGluc2VydChjb250ZXh0LCBub2RlLCBzcGVjaWFsUGFyZW50KSB7CiAgICAgICAgdmFyIHppID0gKG5vZGUuekluZGV4LnppbmRleCA9PT0gJ2F1dG8nKSA/IDAgOiBOdW1iZXIobm9kZS56SW5kZXguemluZGV4KSwKICAgICAgICBjb250ZXh0Rm9yQ2hpbGRyZW4gPSBjb250ZXh0LCAvLyB0aGUgc3RhY2tpbmcgY29udGV4dCBmb3IgY2hpbGRyZW4KICAgICAgICBpc1Bvc2l0aW9uZWQgPSBub2RlLnpJbmRleC5pc1Bvc2l0aW9uZWQsCiAgICAgICAgaXNGbG9hdGVkID0gbm9kZS56SW5kZXguaXNGbG9hdGVkLAogICAgICAgIHN0dWIgPSB7bm9kZTogbm9kZX0sCiAgICAgICAgY2hpbGRyZW5EZXN0ID0gc3BlY2lhbFBhcmVudDsgLy8gd2hlcmUgY2hpbGRyZW4gd2l0aG91dCB6LWluZGV4IHNob3VsZCBiZSBwdXNoZWQgaW50bwoKICAgICAgICBpZiAobm9kZS56SW5kZXgub3duU3RhY2tpbmcpIHsKICAgICAgICAgIGNvbnRleHRGb3JDaGlsZHJlbiA9IHN0dWIuY29udGV4dCA9IHsKICAgICAgICAgICAgICBjaGlsZHJlbjogW3tub2RlOm5vZGUsIGNoaWxkcmVuOiBbXX1dCiAgICAgICAgICB9OwogICAgICAgICAgY2hpbGRyZW5EZXN0ID0gdW5kZWZpbmVkOwogICAgICAgIH0gZWxzZSBpZiAoaXNQb3NpdGlvbmVkIHx8IGlzRmxvYXRlZCkgewogICAgICAgICAgY2hpbGRyZW5EZXN0ID0gc3R1Yi5jaGlsZHJlbiA9IFtdOwogICAgICAgIH0KCiAgICAgICAgaWYgKHppID09PSAwICYmIHNwZWNpYWxQYXJlbnQpIHsKICAgICAgICAgIHNwZWNpYWxQYXJlbnQucHVzaChzdHViKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKCFjb250ZXh0W3ppXSkgeyBjb250ZXh0W3ppXSA9IFtdOyB9CiAgICAgICAgICBjb250ZXh0W3ppXS5wdXNoKHN0dWIpOwogICAgICAgIH0KCiAgICAgICAgbm9kZS56SW5kZXguY2hpbGRyZW4uZm9yRWFjaChmdW5jdGlvbihjaGlsZE5vZGUpIHsKICAgICAgICAgIGluc2VydChjb250ZXh0Rm9yQ2hpbGRyZW4sIGNoaWxkTm9kZSwgY2hpbGRyZW5EZXN0KTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpbnNlcnQocm9vdENvbnRleHQsIHJvb3ROb2RlKTsKICAgICAgcmV0dXJuIHJvb3RDb250ZXh0OwogICAgfSkocGFyc2VRdWV1ZSk7CgogICAgZnVuY3Rpb24gc29ydFooY29udGV4dCkgewogICAgICBPYmplY3Qua2V5cyhjb250ZXh0KS5zb3J0KHNvcnRaaW5kZXgpLmZvckVhY2goZnVuY3Rpb24oemkpIHsKICAgICAgICB2YXIgbm9uUG9zaXRpb25lZCA9IFtdLAogICAgICAgIGZsb2F0ZWQgPSBbXSwKICAgICAgICBwb3NpdGlvbmVkID0gW10sCiAgICAgICAgbGlzdCA9IFtdOwoKICAgICAgICAvLyBwb3NpdGlvbmVkIGFmdGVyIHN0YXRpYwogICAgICAgIGNvbnRleHRbemldLmZvckVhY2goZnVuY3Rpb24odikgewogICAgICAgICAgaWYgKHYubm9kZS56SW5kZXguaXNQb3NpdGlvbmVkIHx8IHYubm9kZS56SW5kZXgub3BhY2l0eSA8IDEpIHsKICAgICAgICAgICAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1jb2xvci8jdHJhbnNwYXJlbmN5CiAgICAgICAgICAgIC8vIG5vbi1wb3NpdGlvbmVkIGVsZW1lbnQgd2l0aCBvcGFjdGl5IDwgMSBzaG91bGQgYmUgc3RhY2tlZCBhcyBpZiBpdCB3ZXJlIGEgcG9zaXRpb25lZCBlbGVtZW50IHdpdGgg4oCYei1pbmRleDogMOKAmSBhbmQg4oCYb3BhY2l0eTogMeKAmS4KICAgICAgICAgICAgcG9zaXRpb25lZC5wdXNoKHYpOwogICAgICAgICAgfSBlbHNlIGlmICh2Lm5vZGUuekluZGV4LmlzRmxvYXRlZCkgewogICAgICAgICAgICBmbG9hdGVkLnB1c2godik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBub25Qb3NpdGlvbmVkLnB1c2godik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIChmdW5jdGlvbiB3YWxrKGFycikgewogICAgICAgICAgYXJyLmZvckVhY2goZnVuY3Rpb24odikgewogICAgICAgICAgICBsaXN0LnB1c2godik7CiAgICAgICAgICAgIGlmICh2LmNoaWxkcmVuKSB7IHdhbGsodi5jaGlsZHJlbik7IH0KICAgICAgICAgIH0pOwogICAgICAgIH0pKG5vblBvc2l0aW9uZWQuY29uY2F0KGZsb2F0ZWQsIHBvc2l0aW9uZWQpKTsKCiAgICAgICAgbGlzdC5mb3JFYWNoKGZ1bmN0aW9uKHYpIHsKICAgICAgICAgIGlmICh2LmNvbnRleHQpIHsKICAgICAgICAgICAgc29ydFoodi5jb250ZXh0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHF1ZXVlLnB1c2godi5ub2RlKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CgogICAgc29ydFoocm9vdENvbnRleHQpOwoKICAgIHJldHVybiBxdWV1ZTsKICB9CgogIGZ1bmN0aW9uIGdldFJlbmRlcmVyKHJlbmRlcmVyTmFtZSkgewogICAgdmFyIHJlbmRlcmVyOwoKICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5yZW5kZXJlciA9PT0gInN0cmluZyIgJiYgX2h0bWwyY2FudmFzLlJlbmRlcmVyW3JlbmRlcmVyTmFtZV0gIT09IHVuZGVmaW5lZCkgewogICAgICByZW5kZXJlciA9IF9odG1sMmNhbnZhcy5SZW5kZXJlcltyZW5kZXJlck5hbWVdKG9wdGlvbnMpOwogICAgfSBlbHNlIGlmICh0eXBlb2YgcmVuZGVyZXJOYW1lID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHJlbmRlcmVyID0gcmVuZGVyZXJOYW1lKG9wdGlvbnMpOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIHJlbmRlcmVyIik7CiAgICB9CgogICAgaWYgKCB0eXBlb2YgcmVuZGVyZXIgIT09ICJmdW5jdGlvbiIgKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCByZW5kZXJlciBkZWZpbmVkIik7CiAgICB9CiAgICByZXR1cm4gcmVuZGVyZXI7CiAgfQoKICByZXR1cm4gZ2V0UmVuZGVyZXIob3B0aW9ucy5yZW5kZXJlcikocGFyc2VRdWV1ZSwgb3B0aW9ucywgZG9jdW1lbnQsIGNyZWF0ZVJlbmRlclF1ZXVlKHBhcnNlUXVldWUuc3RhY2spLCBfaHRtbDJjYW52YXMpOwp9OwoKX2h0bWwyY2FudmFzLlV0aWwuU3VwcG9ydCA9IGZ1bmN0aW9uIChvcHRpb25zLCBkb2MpIHsKCiAgZnVuY3Rpb24gc3VwcG9ydFNWR1JlbmRlcmluZygpIHsKICAgIHZhciBpbWcgPSBuZXcgSW1hZ2UoKSwKICAgIGNhbnZhcyA9IGRvYy5jcmVhdGVFbGVtZW50KCJjYW52YXMiKSwKICAgIGN0eCA9IChjYW52YXMuZ2V0Q29udGV4dCA9PT0gdW5kZWZpbmVkKSA/IGZhbHNlIDogY2FudmFzLmdldENvbnRleHQoIjJkIik7CiAgICBpZiAoY3R4ID09PSBmYWxzZSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBjYW52YXMud2lkdGggPSBjYW52YXMuaGVpZ2h0ID0gMTA7CiAgICBpbWcuc3JjID0gWwogICAgImRhdGE6aW1hZ2Uvc3ZnK3htbCwiLAogICAgIjxzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB3aWR0aD0nMTAnIGhlaWdodD0nMTAnPiIsCiAgICAiPGZvcmVpZ25PYmplY3Qgd2lkdGg9JzEwJyBoZWlnaHQ9JzEwJz4iLAogICAgIjxkaXYgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwnIHN0eWxlPSd3aWR0aDoxMDtoZWlnaHQ6MTA7Jz4iLAogICAgInN1cCIsCiAgICAiPC9kaXY+IiwKICAgICI8L2ZvcmVpZ25PYmplY3Q+IiwKICAgICI8L3N2Zz4iCiAgICBdLmpvaW4oIiIpOwogICAgdHJ5IHsKICAgICAgY3R4LmRyYXdJbWFnZShpbWcsIDAsIDApOwogICAgICBjYW52YXMudG9EYXRhVVJMKCk7CiAgICB9IGNhdGNoKGUpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgX2h0bWwyY2FudmFzLlV0aWwubG9nKCdodG1sMmNhbnZhczogUGFyc2U6IFNWRyBwb3dlcmVkIHJlbmRlcmluZyBhdmFpbGFibGUnKTsKICAgIHJldHVybiB0cnVlOwogIH0KCiAgLy8gVGVzdCB3aGV0aGVyIHdlIGNhbiB1c2UgcmFuZ2VzIHRvIG1lYXN1cmUgYm91bmRpbmcgYm94ZXMKICAvLyBPcGVyYSBkb2Vzbid0IHByb3ZpZGUgdmFsaWQgYm91bmRzLmhlaWdodC9ib3R0b20gZXZlbiB0aG91Z2ggaXQgc3VwcG9ydHMgdGhlIG1ldGhvZC4KCiAgZnVuY3Rpb24gc3VwcG9ydFJhbmdlQm91bmRzKCkgewogICAgdmFyIHIsIHRlc3RFbGVtZW50LCByYW5nZUJvdW5kcywgcmFuZ2VIZWlnaHQsIHN1cHBvcnQgPSBmYWxzZTsKCiAgICBpZiAoZG9jLmNyZWF0ZVJhbmdlKSB7CiAgICAgIHIgPSBkb2MuY3JlYXRlUmFuZ2UoKTsKICAgICAgaWYgKHIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KSB7CiAgICAgICAgdGVzdEVsZW1lbnQgPSBkb2MuY3JlYXRlRWxlbWVudCgnYm91bmR0ZXN0Jyk7CiAgICAgICAgdGVzdEVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gIjEyM3B4IjsKICAgICAgICB0ZXN0RWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgICAgICBkb2MuYm9keS5hcHBlbmRDaGlsZCh0ZXN0RWxlbWVudCk7CgogICAgICAgIHIuc2VsZWN0Tm9kZSh0ZXN0RWxlbWVudCk7CiAgICAgICAgcmFuZ2VCb3VuZHMgPSByLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgIHJhbmdlSGVpZ2h0ID0gcmFuZ2VCb3VuZHMuaGVpZ2h0OwoKICAgICAgICBpZiAocmFuZ2VIZWlnaHQgPT09IDEyMykgewogICAgICAgICAgc3VwcG9ydCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGRvYy5ib2R5LnJlbW92ZUNoaWxkKHRlc3RFbGVtZW50KTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBzdXBwb3J0OwogIH0KCiAgcmV0dXJuIHsKICAgIHJhbmdlQm91bmRzOiBzdXBwb3J0UmFuZ2VCb3VuZHMoKSwKICAgIHN2Z1JlbmRlcmluZzogb3B0aW9ucy5zdmdSZW5kZXJpbmcgJiYgc3VwcG9ydFNWR1JlbmRlcmluZygpCiAgfTsKfTsKd2luZG93Lmh0bWwyY2FudmFzID0gZnVuY3Rpb24oZWxlbWVudHMsIG9wdHMpIHsKICBlbGVtZW50cyA9IChlbGVtZW50cy5sZW5ndGgpID8gZWxlbWVudHMgOiBbZWxlbWVudHNdOwogIHZhciBxdWV1ZSwKICBjYW52YXMsCiAgb3B0aW9ucyA9IHsKICAgIC8vIGdlbmVyYWwKICAgIGxvZ2dpbmc6IGZhbHNlLAogICAgZWxlbWVudHM6IGVsZW1lbnRzLAogICAgYmFja2dyb3VuZDogIiNmZmYiLAoKICAgIC8vIHByZWxvYWQgb3B0aW9ucwogICAgcHJveHk6IG51bGwsCiAgICB0aW1lb3V0OiAwLCAgICAvLyBubyB0aW1lb3V0CiAgICB1c2VDT1JTOiBmYWxzZSwgLy8gdHJ5IHRvIGxvYWQgaW1hZ2VzIGFzIENPUlMgKHdoZXJlIGF2YWlsYWJsZSksIGJlZm9yZSBmYWxsaW5nIGJhY2sgdG8gcHJveHkKICAgIGFsbG93VGFpbnQ6IGZhbHNlLCAvLyB3aGV0aGVyIHRvIGFsbG93IGltYWdlcyB0byB0YWludCB0aGUgY2FudmFzLCB3b24ndCBuZWVkIHByb3h5IGlmIHNldCB0byB0cnVlCgogICAgLy8gcGFyc2Ugb3B0aW9ucwogICAgc3ZnUmVuZGVyaW5nOiBmYWxzZSwgLy8gdXNlIHN2ZyBwb3dlcmVkIHJlbmRlcmluZyB3aGVyZSBhdmFpbGFibGUgKEZGMTErKQogICAgaWdub3JlRWxlbWVudHM6ICJJRlJBTUV8T0JKRUNUfFBBUkFNIiwKICAgIHVzZU92ZXJmbG93OiB0cnVlLAogICAgbGV0dGVyUmVuZGVyaW5nOiBmYWxzZSwKICAgIGNoaW5lc2U6IGZhbHNlLAogICAgYXN5bmM6IGZhbHNlLCAvLyBJZiB0cnVlLCBwYXJzaW5nIHdpbGwgbm90IGJsb2NrLCBidXQgaWYgdGhlIHVzZXIgc2Nyb2xscyBkdXJpbmcgcGFyc2UgdGhlIGltYWdlIGNhbiBnZXQgd2VpcmQKCiAgICAvLyByZW5kZXIgb3B0aW9ucwogICAgd2lkdGg6IG51bGwsCiAgICBoZWlnaHQ6IG51bGwsCiAgICB0YWludFRlc3Q6IHRydWUsIC8vIGRvIGEgdGFpbnQgdGVzdCB3aXRoIGFsbCBpbWFnZXMgYmVmb3JlIGFwcGx5aW5nIHRvIGNhbnZhcwogICAgcmVuZGVyZXI6ICJDYW52YXMiCiAgfTsKCiAgb3B0aW9ucyA9IF9odG1sMmNhbnZhcy5VdGlsLkV4dGVuZChvcHRzLCBvcHRpb25zKTsKCiAgX2h0bWwyY2FudmFzLmxvZ2dpbmcgPSBvcHRpb25zLmxvZ2dpbmc7CiAgb3B0aW9ucy5jb21wbGV0ZSA9IGZ1bmN0aW9uKCBpbWFnZXMgKSB7CgogICAgaWYgKHR5cGVvZiBvcHRpb25zLm9ucHJlbG9hZGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIGlmICggb3B0aW9ucy5vbnByZWxvYWRlZCggaW1hZ2VzICkgPT09IGZhbHNlICkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogICAgX2h0bWwyY2FudmFzLlBhcnNlKCBpbWFnZXMsIG9wdGlvbnMsIGZ1bmN0aW9uKHF1ZXVlKSB7CiAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5vbnBhcnNlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIGlmICggb3B0aW9ucy5vbnBhcnNlZCggcXVldWUgKSA9PT0gZmFsc2UgKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CgogICAgICBjYW52YXMgPSBfaHRtbDJjYW52YXMuUmVuZGVyZXIoIHF1ZXVlLCBvcHRpb25zICk7CgogICAgICBpZiAodHlwZW9mIG9wdGlvbnMub25yZW5kZXJlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIG9wdGlvbnMub25yZW5kZXJlZCggY2FudmFzICk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIC8vIGZvciBwYWdlcyB3aXRob3V0IGltYWdlcywgd2Ugc3RpbGwgd2FudCB0aGlzIHRvIGJlIGFzeW5jLCBpLmUuIHJldHVybiBtZXRob2RzIGJlZm9yZSBleGVjdXRpbmcKICB3aW5kb3cuc2V0VGltZW91dCggZnVuY3Rpb24oKXsKICAgIF9odG1sMmNhbnZhcy5QcmVsb2FkKCBvcHRpb25zICk7CiAgfSwgMCApOwoKICByZXR1cm4gewogICAgcmVuZGVyOiBmdW5jdGlvbiggcXVldWUsIG9wdHMgKSB7CiAgICAgIHJldHVybiBfaHRtbDJjYW52YXMuUmVuZGVyZXIoIHF1ZXVlLCBfaHRtbDJjYW52YXMuVXRpbC5FeHRlbmQob3B0cywgb3B0aW9ucykgKTsKICAgIH0sCiAgICBwYXJzZTogZnVuY3Rpb24oIGltYWdlcywgb3B0cyApIHsKICAgICAgcmV0dXJuIF9odG1sMmNhbnZhcy5QYXJzZSggaW1hZ2VzLCBfaHRtbDJjYW52YXMuVXRpbC5FeHRlbmQob3B0cywgb3B0aW9ucykgKTsKICAgIH0sCiAgICBwcmVsb2FkOiBmdW5jdGlvbiggb3B0cyApIHsKICAgICAgcmV0dXJuIF9odG1sMmNhbnZhcy5QcmVsb2FkKCBfaHRtbDJjYW52YXMuVXRpbC5FeHRlbmQob3B0cywgb3B0aW9ucykgKTsKICAgIH0sCiAgICBsb2c6IF9odG1sMmNhbnZhcy5VdGlsLmxvZwogIH07Cn07Cgp3aW5kb3cuaHRtbDJjYW52YXMubG9nID0gX2h0bWwyY2FudmFzLlV0aWwubG9nOyAvLyBmb3IgcmVuZGVyZXJzCndpbmRvdy5odG1sMmNhbnZhcy5SZW5kZXJlciA9IHsKICBDYW52YXM6IHVuZGVmaW5lZCAvLyBXZSBhcmUgYXNzdW1pbmcgdGhpcyB3aWxsIGJlIHVzZWQKfTsKX2h0bWwyY2FudmFzLlJlbmRlcmVyLkNhbnZhcyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgdmFyIGRvYyA9IGRvY3VtZW50LAogIHNhZmVJbWFnZXMgPSBbXSwKICB0ZXN0Q2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiY2FudmFzIiksCiAgdGVzdGN0eCA9IHRlc3RDYW52YXMuZ2V0Q29udGV4dCgiMmQiKSwKICBVdGlsID0gX2h0bWwyY2FudmFzLlV0aWwsCiAgY2FudmFzID0gb3B0aW9ucy5jYW52YXMgfHwgZG9jLmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwoKICBmdW5jdGlvbiBjcmVhdGVTaGFwZShjdHgsIGFyZ3MpIHsKICAgIGN0eC5iZWdpblBhdGgoKTsKICAgIGFyZ3MuZm9yRWFjaChmdW5jdGlvbihhcmcpIHsKICAgICAgY3R4W2FyZy5uYW1lXS5hcHBseShjdHgsIGFyZ1snYXJndW1lbnRzJ10pOwogICAgfSk7CiAgICBjdHguY2xvc2VQYXRoKCk7CiAgfQoKICBmdW5jdGlvbiBzYWZlSW1hZ2UoaXRlbSkgewogICAgaWYgKHNhZmVJbWFnZXMuaW5kZXhPZihpdGVtWydhcmd1bWVudHMnXVswXS5zcmMpID09PSAtMSkgewogICAgICB0ZXN0Y3R4LmRyYXdJbWFnZShpdGVtWydhcmd1bWVudHMnXVswXSwgMCwgMCk7CiAgICAgIHRyeSB7CiAgICAgICAgdGVzdGN0eC5nZXRJbWFnZURhdGEoMCwgMCwgMSwgMSk7CiAgICAgIH0gY2F0Y2goZSkgewogICAgICAgIHRlc3RDYW52YXMgPSBkb2MuY3JlYXRlRWxlbWVudCgiY2FudmFzIik7CiAgICAgICAgdGVzdGN0eCA9IHRlc3RDYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgc2FmZUltYWdlcy5wdXNoKGl0ZW1bJ2FyZ3VtZW50cyddWzBdLnNyYyk7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIGZ1bmN0aW9uIHJlbmRlckl0ZW0oY3R4LCBpdGVtKSB7CiAgICBzd2l0Y2goaXRlbS50eXBlKXsKICAgICAgY2FzZSAidmFyaWFibGUiOgogICAgICAgIGN0eFtpdGVtLm5hbWVdID0gaXRlbVsnYXJndW1lbnRzJ107CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgImZ1bmN0aW9uIjoKICAgICAgICBzd2l0Y2goaXRlbS5uYW1lKSB7CiAgICAgICAgICBjYXNlICJjcmVhdGVQYXR0ZXJuIjoKICAgICAgICAgICAgaWYgKGl0ZW1bJ2FyZ3VtZW50cyddWzBdLndpZHRoID4gMCAmJiBpdGVtWydhcmd1bWVudHMnXVswXS5oZWlnaHQgPiAwKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBjdHguY3JlYXRlUGF0dGVybihpdGVtWydhcmd1bWVudHMnXVswXSwgInJlcGVhdCIpOwogICAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBSZW5kZXJlcjogRXJyb3IgY3JlYXRpbmcgcGF0dGVybiIsIGUubWVzc2FnZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiZHJhd1NoYXBlIjoKICAgICAgICAgICAgY3JlYXRlU2hhcGUoY3R4LCBpdGVtWydhcmd1bWVudHMnXSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiZHJhd0ltYWdlIjoKICAgICAgICAgICAgaWYgKGl0ZW1bJ2FyZ3VtZW50cyddWzhdID4gMCAmJiBpdGVtWydhcmd1bWVudHMnXVs3XSA+IDApIHsKICAgICAgICAgICAgICBpZiAoIW9wdGlvbnMudGFpbnRUZXN0IHx8IChvcHRpb25zLnRhaW50VGVzdCAmJiBzYWZlSW1hZ2UoaXRlbSkpKSB7CiAgICAgICAgICAgICAgICBjdHguZHJhd0ltYWdlLmFwcGx5KCBjdHgsIGl0ZW1bJ2FyZ3VtZW50cyddICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgY3R4W2l0ZW0ubmFtZV0uYXBwbHkoY3R4LCBpdGVtWydhcmd1bWVudHMnXSk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIGZ1bmN0aW9uKHBhcnNlZERhdGEsIG9wdGlvbnMsIGRvY3VtZW50LCBxdWV1ZSwgX2h0bWwyY2FudmFzKSB7CiAgICB2YXIgY3R4ID0gY2FudmFzLmdldENvbnRleHQoIjJkIiksCiAgICBuZXdDYW52YXMsCiAgICBib3VuZHMsCiAgICBmc3R5bGUsCiAgICB6U3RhY2sgPSBwYXJzZWREYXRhLnN0YWNrOwoKICAgIGNhbnZhcy53aWR0aCA9IGNhbnZhcy5zdHlsZS53aWR0aCA9ICBvcHRpb25zLndpZHRoIHx8IHpTdGFjay5jdHgud2lkdGg7CiAgICBjYW52YXMuaGVpZ2h0ID0gY2FudmFzLnN0eWxlLmhlaWdodCA9IG9wdGlvbnMuaGVpZ2h0IHx8IHpTdGFjay5jdHguaGVpZ2h0OwoKICAgIGZzdHlsZSA9IGN0eC5maWxsU3R5bGU7CiAgICBjdHguZmlsbFN0eWxlID0gKFV0aWwuaXNUcmFuc3BhcmVudChwYXJzZWREYXRhLmJhY2tncm91bmRDb2xvcikgJiYgb3B0aW9ucy5iYWNrZ3JvdW5kICE9PSB1bmRlZmluZWQpID8gb3B0aW9ucy5iYWNrZ3JvdW5kIDogcGFyc2VkRGF0YS5iYWNrZ3JvdW5kQ29sb3I7CiAgICBjdHguZmlsbFJlY3QoMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTsKICAgIGN0eC5maWxsU3R5bGUgPSBmc3R5bGU7CiAgICBxdWV1ZS5mb3JFYWNoKGZ1bmN0aW9uKHN0b3JhZ2VDb250ZXh0KSB7CiAgICAgIC8vIHNldCBjb21tb24gc2V0dGluZ3MgZm9yIGNhbnZhcwogICAgICBjdHgudGV4dEJhc2VsaW5lID0gImJvdHRvbSI7CiAgICAgIGN0eC5zYXZlKCk7CgogICAgICBpZiAoc3RvcmFnZUNvbnRleHQudHJhbnNmb3JtLm1hdHJpeCkgewogICAgICAgIGN0eC50cmFuc2xhdGUoc3RvcmFnZUNvbnRleHQudHJhbnNmb3JtLm9yaWdpblswXSwgc3RvcmFnZUNvbnRleHQudHJhbnNmb3JtLm9yaWdpblsxXSk7CiAgICAgICAgY3R4LnRyYW5zZm9ybS5hcHBseShjdHgsIHN0b3JhZ2VDb250ZXh0LnRyYW5zZm9ybS5tYXRyaXgpOwogICAgICAgIGN0eC50cmFuc2xhdGUoLXN0b3JhZ2VDb250ZXh0LnRyYW5zZm9ybS5vcmlnaW5bMF0sIC1zdG9yYWdlQ29udGV4dC50cmFuc2Zvcm0ub3JpZ2luWzFdKTsKICAgICAgfQoKICAgICAgaWYgKHN0b3JhZ2VDb250ZXh0LmNsaXApewogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgucmVjdChzdG9yYWdlQ29udGV4dC5jbGlwLmxlZnQsIHN0b3JhZ2VDb250ZXh0LmNsaXAudG9wLCBzdG9yYWdlQ29udGV4dC5jbGlwLndpZHRoLCBzdG9yYWdlQ29udGV4dC5jbGlwLmhlaWdodCk7CiAgICAgICAgY3R4LmNsaXAoKTsKICAgICAgfQoKICAgICAgaWYgKHN0b3JhZ2VDb250ZXh0LmN0eC5zdG9yYWdlKSB7CiAgICAgICAgc3RvcmFnZUNvbnRleHQuY3R4LnN0b3JhZ2UuZm9yRWFjaChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICByZW5kZXJJdGVtKGN0eCwgaXRlbSk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICB9KTsKCiAgICBVdGlsLmxvZygiaHRtbDJjYW52YXM6IFJlbmRlcmVyOiBDYW52YXMgcmVuZGVyZXIgZG9uZSAtIHJldHVybmluZyBjYW52YXMgb2JqIik7CgogICAgaWYgKG9wdGlvbnMuZWxlbWVudHMubGVuZ3RoID09PSAxKSB7CiAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5lbGVtZW50c1swXSA9PT0gIm9iamVjdCIgJiYgb3B0aW9ucy5lbGVtZW50c1swXS5ub2RlTmFtZSAhPT0gIkJPRFkiKSB7CiAgICAgICAgLy8gY3JvcCBpbWFnZSB0byB0aGUgYm91bmRzIG9mIHNlbGVjdGVkIChzaW5nbGUpIGVsZW1lbnQKICAgICAgICBib3VuZHMgPSBfaHRtbDJjYW52YXMuVXRpbC5Cb3VuZHMob3B0aW9ucy5lbGVtZW50c1swXSk7CiAgICAgICAgbmV3Q2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgCgoJICAgIG5ld0NhbnZhcy53aWR0aCA9IE1hdGguY2VpbChib3VuZHMud2lkdGgpOwogICAgICAgIG5ld0NhbnZhcy5oZWlnaHQgPSBNYXRoLmNlaWwoYm91bmRzLmhlaWdodCk7CiAgIAoJICBjdHggPSBuZXdDYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsKICAgICAgY3R4LmRyYXdJbWFnZShjYW52YXMsIGJvdW5kcy5sZWZ0LCBib3VuZHMudG9wLCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQsIDAsIDAsIGJvdW5kcy53aWR0aCwgYm91bmRzLmhlaWdodCk7CgoJCQoJCQoJCWNhbnZhcyA9IG51bGw7CiAgICAgICAgcmV0dXJuIG5ld0NhbnZhczsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBjYW52YXM7CiAgfTsKfTsKfSkod2luZG93LGRvY3VtZW50KTsK",
                "body": "LyoKICBodG1sMmNhbnZhcyAwLjQuMSA8aHR0cDovL2h0bWwyY2FudmFzLmhlcnR6ZW4uY29tPgogIENvcHlyaWdodCAoYykgMjAxMyBOaWtsYXMgdm9uIEhlcnR6ZW4KCiAgUmVsZWFzZWQgdW5kZXIgTUlUIExpY2Vuc2UKKi8KCihmdW5jdGlvbih3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQpewoKLy8idXNlIHN0cmljdCI7Cgp2YXIgX2h0bWwyY2FudmFzID0ge30sCnByZXZpb3VzRWxlbWVudCwKY29tcHV0ZWRDU1MsCmh0bWwyY2FudmFzOwoKX2h0bWwyY2FudmFzLlV0aWwgPSB7fTsKCl9odG1sMmNhbnZhcy5VdGlsLmxvZyA9IGZ1bmN0aW9uKGEpIHsKICBpZiAoX2h0bWwyY2FudmFzLmxvZ2dpbmcgJiYgd2luZG93LmNvbnNvbGUgJiYgd2luZG93LmNvbnNvbGUubG9nKSB7CiAgICB3aW5kb3cuY29uc29sZS5sb2coYSk7CiAgfQp9OwoKX2h0bWwyY2FudmFzLlV0aWwudHJpbVRleHQgPSAoZnVuY3Rpb24oaXNOYXRpdmUpewogIHJldHVybiBmdW5jdGlvbihpbnB1dCkgewogICAgcmV0dXJuIGlzTmF0aXZlID8gaXNOYXRpdmUuYXBwbHkoaW5wdXQpIDogKChpbnB1dCB8fCAnJykgKyAnJykucmVwbGFjZSggL15ccyt8XHMrJC9nICwgJycgKTsKICB9Owp9KShTdHJpbmcucHJvdG90eXBlLnRyaW0pOwoKX2h0bWwyY2FudmFzLlV0aWwuYXNGbG9hdCA9IGZ1bmN0aW9uKHYpIHsKICByZXR1cm4gcGFyc2VGbG9hdCh2KTsKfTsKCihmdW5jdGlvbigpIHsKICAvLyBUT0RPOiBzdXBwb3J0IGFsbCBwb3NzaWJsZSBsZW5ndGggdmFsdWVzCiAgdmFyIFRFWFRfU0hBRE9XX1BST1BFUlRZID0gLygocmdiYXxyZ2IpXChbXlwpXStcKShccy0/XGQrcHgpezAsfSkvZzsKICB2YXIgVEVYVF9TSEFET1dfVkFMVUVTID0gLygtP1xkK3B4KXwoIy4rKXwocmdiXCguK1wpKXwocmdiYVwoLitcKSkvZzsKICBfaHRtbDJjYW52YXMuVXRpbC5wYXJzZVRleHRTaGFkb3dzID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICBpZiAoIXZhbHVlIHx8IHZhbHVlID09PSAnbm9uZScpIHsKICAgICAgcmV0dXJuIFtdOwogICAgfQoKICAgIC8vIGZpbmQgbXVsdGlwbGUgc2hhZG93IGRlY2xhcmF0aW9ucwogICAgdmFyIHNoYWRvd3MgPSB2YWx1ZS5tYXRjaChURVhUX1NIQURPV19QUk9QRVJUWSksCiAgICAgIHJlc3VsdHMgPSBbXTsKICAgIGZvciAodmFyIGkgPSAwOyBzaGFkb3dzICYmIChpIDwgc2hhZG93cy5sZW5ndGgpOyBpKyspIHsKICAgICAgdmFyIHMgPSBzaGFkb3dzW2ldLm1hdGNoKFRFWFRfU0hBRE9XX1ZBTFVFUyk7CiAgICAgIHJlc3VsdHMucHVzaCh7CiAgICAgICAgY29sb3I6IHNbMF0sCiAgICAgICAgb2Zmc2V0WDogc1sxXSA/IHNbMV0ucmVwbGFjZSgncHgnLCAnJykgOiAwLAogICAgICAgIG9mZnNldFk6IHNbMl0gPyBzWzJdLnJlcGxhY2UoJ3B4JywgJycpIDogMCwKICAgICAgICBibHVyOiBzWzNdID8gc1szXS5yZXBsYWNlKCdweCcsICcnKSA6IDAKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9Owp9KSgpOwoKX2h0bWwyY2FudmFzLlV0aWwucGFyc2VCYWNrZ3JvdW5kSW1hZ2UgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgIHZhciB3aGl0ZXNwYWNlID0gJyBcclxuXHQnLAogICAgICAgIG1ldGhvZCwgZGVmaW5pdGlvbiwgcHJlZml4LCBwcmVmaXhfaSwgYmxvY2ssIHJlc3VsdHMgPSBbXSwKICAgICAgICBjLCBtb2RlID0gMCwgbnVtUGFyZW4gPSAwLCBxdW90ZSwgYXJnczsKCiAgICB2YXIgYXBwZW5kUmVzdWx0ID0gZnVuY3Rpb24oKXsKICAgICAgICBpZihtZXRob2QpIHsKICAgICAgICAgICAgaWYoZGVmaW5pdGlvbi5zdWJzdHIoIDAsIDEgKSA9PT0gJyInKSB7CiAgICAgICAgICAgICAgICBkZWZpbml0aW9uID0gZGVmaW5pdGlvbi5zdWJzdHIoIDEsIGRlZmluaXRpb24ubGVuZ3RoIC0gMiApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGRlZmluaXRpb24pIHsKICAgICAgICAgICAgICAgIGFyZ3MucHVzaChkZWZpbml0aW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihtZXRob2Quc3Vic3RyKCAwLCAxICkgPT09ICctJyAmJgogICAgICAgICAgICAgICAgICAgIChwcmVmaXhfaSA9IG1ldGhvZC5pbmRleE9mKCAnLScsIDEgKSArIDEpID4gMCkgewogICAgICAgICAgICAgICAgcHJlZml4ID0gbWV0aG9kLnN1YnN0ciggMCwgcHJlZml4X2kpOwogICAgICAgICAgICAgICAgbWV0aG9kID0gbWV0aG9kLnN1YnN0ciggcHJlZml4X2kgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXN1bHRzLnB1c2goewogICAgICAgICAgICAgICAgcHJlZml4OiBwcmVmaXgsCiAgICAgICAgICAgICAgICBtZXRob2Q6IG1ldGhvZC50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAgICAgdmFsdWU6IGJsb2NrLAogICAgICAgICAgICAgICAgYXJnczogYXJncwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgYXJncyA9IFtdOyAvL2ZvciBzb21lIG9kZCByZWFzb24sIHNldHRpbmcgLmxlbmd0aCA9IDAgZGlkbid0IHdvcmsgaW4gc2FmYXJpCiAgICAgICAgbWV0aG9kID0KICAgICAgICAgICAgcHJlZml4ID0KICAgICAgICAgICAgZGVmaW5pdGlvbiA9CiAgICAgICAgICAgIGJsb2NrID0gJyc7CiAgICB9OwoKICAgIGFwcGVuZFJlc3VsdCgpOwogICAgZm9yKHZhciBpID0gMCwgaWkgPSB2YWx1ZS5sZW5ndGg7IGk8aWk7IGkrKykgewogICAgICAgIGMgPSB2YWx1ZVtpXTsKICAgICAgICBpZihtb2RlID09PSAwICYmIHdoaXRlc3BhY2UuaW5kZXhPZiggYyApID4gLTEpewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgc3dpdGNoKGMpIHsKICAgICAgICAgICAgY2FzZSAnIic6CiAgICAgICAgICAgICAgICBpZighcXVvdGUpIHsKICAgICAgICAgICAgICAgICAgICBxdW90ZSA9IGM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmKHF1b3RlID09PSBjKSB7CiAgICAgICAgICAgICAgICAgICAgcXVvdGUgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICcoJzoKICAgICAgICAgICAgICAgIGlmKHF1b3RlKSB7IGJyZWFrOyB9CiAgICAgICAgICAgICAgICBlbHNlIGlmKG1vZGUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBtb2RlID0gMTsKICAgICAgICAgICAgICAgICAgICBibG9jayArPSBjOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBudW1QYXJlbisrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICcpJzoKICAgICAgICAgICAgICAgIGlmKHF1b3RlKSB7IGJyZWFrOyB9CiAgICAgICAgICAgICAgICBlbHNlIGlmKG1vZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBpZihudW1QYXJlbiA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBtb2RlID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2sgKz0gYzsKICAgICAgICAgICAgICAgICAgICAgICAgYXBwZW5kUmVzdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG51bVBhcmVuLS07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICcsJzoKICAgICAgICAgICAgICAgIGlmKHF1b3RlKSB7IGJyZWFrOyB9CiAgICAgICAgICAgICAgICBlbHNlIGlmKG1vZGUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBhcHBlbmRSZXN1bHQoKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1vZGUgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBpZihudW1QYXJlbiA9PT0gMCAmJiAhbWV0aG9kLm1hdGNoKC9edXJsJC9pKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhcmdzLnB1c2goZGVmaW5pdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmluaXRpb24gPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2sgKz0gYzsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBibG9jayArPSBjOwogICAgICAgIGlmKG1vZGUgPT09IDApIHsgbWV0aG9kICs9IGM7IH0KICAgICAgICBlbHNlIHsgZGVmaW5pdGlvbiArPSBjOyB9CiAgICB9CiAgICBhcHBlbmRSZXN1bHQoKTsKCiAgICByZXR1cm4gcmVzdWx0czsKfTsKCl9odG1sMmNhbnZhcy5VdGlsLkJvdW5kcyA9IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgdmFyIGNsaWVudFJlY3QsIGJvdW5kcyA9IHt9OwoKICBpZiAoZWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QpewogICAgY2xpZW50UmVjdCA9IGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CgogICAgLy8gVE9ETyBhZGQgc2Nyb2xsIHBvc2l0aW9uIHRvIGJvdW5kcywgc28gbm8gc2Nyb2xsaW5nIG9mIHdpbmRvdyBuZWNlc3NhcnkKICAgIGJvdW5kcy50b3AgPSBjbGllbnRSZWN0LnRvcDsKICAgIGJvdW5kcy5ib3R0b20gPSBjbGllbnRSZWN0LmJvdHRvbSB8fCAoY2xpZW50UmVjdC50b3AgKyBjbGllbnRSZWN0LmhlaWdodCk7CiAgICBib3VuZHMubGVmdCA9IGNsaWVudFJlY3QubGVmdDsKCiAgICBib3VuZHMud2lkdGggPSBlbGVtZW50Lm9mZnNldFdpZHRoOwogICAgYm91bmRzLmhlaWdodCA9IGVsZW1lbnQub2Zmc2V0SGVpZ2h0OwogIH0KCiAgcmV0dXJuIGJvdW5kczsKfTsKCi8vIFRPRE8gaWRlYWxseSwgd2UnZCB3YW50IGV2ZXJ5dGhpbmcgdG8gZ28gdGhyb3VnaCB0aGlzIGZ1bmN0aW9uIGluc3RlYWQgb2YgVXRpbC5Cb3VuZHMsCi8vIGJ1dCB3b3VsZCByZXF1aXJlIGZ1cnRoZXIgd29yayB0byBjYWxjdWxhdGUgdGhlIGNvcnJlY3QgcG9zaXRpb25zIGZvciBlbGVtZW50cyB3aXRoIG9mZnNldFBhcmVudHMKX2h0bWwyY2FudmFzLlV0aWwuT2Zmc2V0Qm91bmRzID0gZnVuY3Rpb24gKGVsZW1lbnQpIHsKICB2YXIgcGFyZW50ID0gZWxlbWVudC5vZmZzZXRQYXJlbnQgPyBfaHRtbDJjYW52YXMuVXRpbC5PZmZzZXRCb3VuZHMoZWxlbWVudC5vZmZzZXRQYXJlbnQpIDoge3RvcDogMCwgbGVmdDogMH07CgogIHJldHVybiB7CiAgICB0b3A6IGVsZW1lbnQub2Zmc2V0VG9wICsgcGFyZW50LnRvcCwKICAgIGJvdHRvbTogZWxlbWVudC5vZmZzZXRUb3AgKyBlbGVtZW50Lm9mZnNldEhlaWdodCArIHBhcmVudC50b3AsCiAgICBsZWZ0OiBlbGVtZW50Lm9mZnNldExlZnQgKyBwYXJlbnQubGVmdCwKICAgIHdpZHRoOiBlbGVtZW50Lm9mZnNldFdpZHRoLAogICAgaGVpZ2h0OiBlbGVtZW50Lm9mZnNldEhlaWdodAogIH07Cn07CgpmdW5jdGlvbiB0b1BYKGVsZW1lbnQsIGF0dHJpYnV0ZSwgdmFsdWUgKSB7CiAgICB2YXIgcnNMZWZ0ID0gZWxlbWVudC5ydW50aW1lU3R5bGUgJiYgZWxlbWVudC5ydW50aW1lU3R5bGVbYXR0cmlidXRlXSwKICAgICAgICBsZWZ0LAogICAgICAgIHN0eWxlID0gZWxlbWVudC5zdHlsZTsKCiAgICAvLyBDaGVjayBpZiB3ZSBhcmUgbm90IGRlYWxpbmcgd2l0aCBwaXhlbHMsIChPcGVyYSBoYXMgaXNzdWVzIHdpdGggdGhpcykKICAgIC8vIFBvcnRlZCBmcm9tIGpRdWVyeSBjc3MuanMKICAgIC8vIEZyb20gdGhlIGF3ZXNvbWUgaGFjayBieSBEZWFuIEVkd2FyZHMKICAgIC8vIGh0dHA6Ly9lcmlrLmVhZS5uZXQvYXJjaGl2ZXMvMjAwNy8wNy8yNy8xOC41NC4xNS8jY29tbWVudC0xMDIyOTEKCiAgICAvLyBJZiB3ZSdyZSBub3QgZGVhbGluZyB3aXRoIGEgcmVndWxhciBwaXhlbCBudW1iZXIKICAgIC8vIGJ1dCBhIG51bWJlciB0aGF0IGhhcyBhIHdlaXJkIGVuZGluZywgd2UgbmVlZCB0byBjb252ZXJ0IGl0IHRvIHBpeGVscwoKICAgIGlmICggIS9eLT9bMC05XStcLj9bMC05XSooPzpweCk/JC9pLnRlc3QoIHZhbHVlICkgJiYgL14tP1xkLy50ZXN0KHZhbHVlKSApIHsKICAgICAgICAvLyBSZW1lbWJlciB0aGUgb3JpZ2luYWwgdmFsdWVzCiAgICAgICAgbGVmdCA9IHN0eWxlLmxlZnQ7CgogICAgICAgIC8vIFB1dCBpbiB0aGUgbmV3IHZhbHVlcyB0byBnZXQgYSBjb21wdXRlZCB2YWx1ZSBvdXQKICAgICAgICBpZiAocnNMZWZ0KSB7CiAgICAgICAgICAgIGVsZW1lbnQucnVudGltZVN0eWxlLmxlZnQgPSBlbGVtZW50LmN1cnJlbnRTdHlsZS5sZWZ0OwogICAgICAgIH0KICAgICAgICBzdHlsZS5sZWZ0ID0gYXR0cmlidXRlID09PSAiZm9udFNpemUiID8gIjFlbSIgOiAodmFsdWUgfHwgMCk7CiAgICAgICAgdmFsdWUgPSBzdHlsZS5waXhlbExlZnQgKyAicHgiOwoKICAgICAgICAvLyBSZXZlcnQgdGhlIGNoYW5nZWQgdmFsdWVzCiAgICAgICAgc3R5bGUubGVmdCA9IGxlZnQ7CiAgICAgICAgaWYgKHJzTGVmdCkgewogICAgICAgICAgICBlbGVtZW50LnJ1bnRpbWVTdHlsZS5sZWZ0ID0gcnNMZWZ0OwogICAgICAgIH0KICAgIH0KCiAgICBpZiAoIS9eKHRoaW58bWVkaXVtfHRoaWNrKSQvaS50ZXN0KHZhbHVlKSkgewogICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHBhcnNlRmxvYXQodmFsdWUpKSArICJweCI7CiAgICB9CgogICAgcmV0dXJuIHZhbHVlOwp9CgpmdW5jdGlvbiBhc0ludCh2YWwpIHsKICAgIHJldHVybiBwYXJzZUludCh2YWwsIDEwKTsKfQoKZnVuY3Rpb24gaXNQZXJjZW50YWdlKHZhbHVlKSB7CiAgcmV0dXJuIHZhbHVlLnRvU3RyaW5nKCkuaW5kZXhPZigiJSIpICE9PSAtMTsKfQoKZnVuY3Rpb24gcGFyc2VCYWNrZ3JvdW5kU2l6ZVBvc2l0aW9uKHZhbHVlLCBlbGVtZW50LCBhdHRyaWJ1dGUsIGluZGV4KSB7CiAgICB2YWx1ZSA9ICh2YWx1ZSB8fCAnJykuc3BsaXQoJywnKTsKICAgIHZhbHVlID0gdmFsdWVbaW5kZXggfHwgMF0gfHwgdmFsdWVbMF0gfHwgJ2F1dG8nOwogICAgdmFsdWUgPSBfaHRtbDJjYW52YXMuVXRpbC50cmltVGV4dCh2YWx1ZSkuc3BsaXQoJyAnKTsKICAgIGlmKGF0dHJpYnV0ZSA9PT0gJ2JhY2tncm91bmRTaXplJyAmJiAodmFsdWVbMF0gJiYgdmFsdWVbMF0ubWF0Y2goL14oY292ZXJ8Y29udGFpbnxhdXRvKSQvKSkpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9IGVsc2UgewogICAgICAgIHZhbHVlWzBdID0gKHZhbHVlWzBdLmluZGV4T2YoICIlIiApID09PSAtMSkgPyB0b1BYKGVsZW1lbnQsIGF0dHJpYnV0ZSArICJYIiwgdmFsdWVbMF0pIDogdmFsdWVbMF07CiAgICAgICAgaWYodmFsdWVbMV0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBpZihhdHRyaWJ1dGUgPT09ICdiYWNrZ3JvdW5kU2l6ZScpIHsKICAgICAgICAgICAgICAgIHZhbHVlWzFdID0gJ2F1dG8nOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSUUgOSBkb2Vzbid0IHJldHVybiBkb3VibGUgZGlnaXQgYWx3YXlzCiAgICAgICAgICAgICAgICB2YWx1ZVsxXSA9IHZhbHVlWzBdOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhbHVlWzFdID0gKHZhbHVlWzFdLmluZGV4T2YoIiUiKSA9PT0gLTEpID8gdG9QWChlbGVtZW50LCBhdHRyaWJ1dGUgKyAiWSIsIHZhbHVlWzFdKSA6IHZhbHVlWzFdOwogICAgfQogICAgcmV0dXJuIHZhbHVlOwp9CgpfaHRtbDJjYW52YXMuVXRpbC5nZXRDU1MgPSBmdW5jdGlvbiAoZWxlbWVudCwgYXR0cmlidXRlLCBpbmRleCkgewogICAgaWYgKHByZXZpb3VzRWxlbWVudCAhPT0gZWxlbWVudCkgewogICAgICBjb21wdXRlZENTUyA9IGRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgbnVsbCk7CiAgICB9CgogICAgdmFyIHZhbHVlID0gY29tcHV0ZWRDU1NbYXR0cmlidXRlXTsKCiAgICBpZiAoL15iYWNrZ3JvdW5kKFNpemV8UG9zaXRpb24pJC8udGVzdChhdHRyaWJ1dGUpKSB7CiAgICAgICAgcmV0dXJuIHBhcnNlQmFja2dyb3VuZFNpemVQb3NpdGlvbih2YWx1ZSwgZWxlbWVudCwgYXR0cmlidXRlLCBpbmRleCk7CiAgICB9IGVsc2UgaWYgKC9ib3JkZXIoVG9wfEJvdHRvbSkoTGVmdHxSaWdodClSYWRpdXMvLnRlc3QoYXR0cmlidXRlKSkgewogICAgICB2YXIgYXJyID0gdmFsdWUuc3BsaXQoIiAiKTsKICAgICAgaWYgKGFyci5sZW5ndGggPD0gMSkgewogICAgICAgICAgYXJyWzFdID0gYXJyWzBdOwogICAgICB9CiAgICAgIHJldHVybiBhcnIubWFwKGFzSW50KTsKICAgIH0KCiAgcmV0dXJuIHZhbHVlOwp9OwoKX2h0bWwyY2FudmFzLlV0aWwucmVzaXplQm91bmRzID0gZnVuY3Rpb24oIGN1cnJlbnRfd2lkdGgsIGN1cnJlbnRfaGVpZ2h0LCB0YXJnZXRfd2lkdGgsIHRhcmdldF9oZWlnaHQsIHN0cmV0Y2hfbW9kZSApewogIHZhciB0YXJnZXRfcmF0aW8gPSB0YXJnZXRfd2lkdGggLyB0YXJnZXRfaGVpZ2h0LAogICAgY3VycmVudF9yYXRpbyA9IGN1cnJlbnRfd2lkdGggLyBjdXJyZW50X2hlaWdodCwKICAgIG91dHB1dF93aWR0aCwgb3V0cHV0X2hlaWdodDsKCiAgaWYoIXN0cmV0Y2hfbW9kZSB8fCBzdHJldGNoX21vZGUgPT09ICdhdXRvJykgewogICAgb3V0cHV0X3dpZHRoID0gdGFyZ2V0X3dpZHRoOwogICAgb3V0cHV0X2hlaWdodCA9IHRhcmdldF9oZWlnaHQ7CiAgfSBlbHNlIGlmKHRhcmdldF9yYXRpbyA8IGN1cnJlbnRfcmF0aW8gXiBzdHJldGNoX21vZGUgPT09ICdjb250YWluJykgewogICAgb3V0cHV0X2hlaWdodCA9IHRhcmdldF9oZWlnaHQ7CiAgICBvdXRwdXRfd2lkdGggPSB0YXJnZXRfaGVpZ2h0ICogY3VycmVudF9yYXRpbzsKICB9IGVsc2UgewogICAgb3V0cHV0X3dpZHRoID0gdGFyZ2V0X3dpZHRoOwogICAgb3V0cHV0X2hlaWdodCA9IHRhcmdldF93aWR0aCAvIGN1cnJlbnRfcmF0aW87CiAgfQoKICByZXR1cm4gewogICAgd2lkdGg6IG91dHB1dF93aWR0aCwKICAgIGhlaWdodDogb3V0cHV0X2hlaWdodAogIH07Cn07CgpfaHRtbDJjYW52YXMuVXRpbC5CYWNrZ3JvdW5kUG9zaXRpb24gPSBmdW5jdGlvbihlbGVtZW50LCBib3VuZHMsIGltYWdlLCBpbWFnZUluZGV4LCBiYWNrZ3JvdW5kU2l6ZSApIHsKICAgIHZhciBiYWNrZ3JvdW5kUG9zaXRpb24gPSAgX2h0bWwyY2FudmFzLlV0aWwuZ2V0Q1NTKGVsZW1lbnQsICdiYWNrZ3JvdW5kUG9zaXRpb24nLCBpbWFnZUluZGV4KSwKICAgICAgICBsZWZ0UG9zaXRpb24sCiAgICAgICAgdG9wUG9zaXRpb247CiAgICBpZiAoYmFja2dyb3VuZFBvc2l0aW9uLmxlbmd0aCA9PT0gMSl7CiAgICAgICAgYmFja2dyb3VuZFBvc2l0aW9uID0gW2JhY2tncm91bmRQb3NpdGlvblswXSwgYmFja2dyb3VuZFBvc2l0aW9uWzBdXTsKICAgIH0KCiAgICBpZiAoaXNQZXJjZW50YWdlKGJhY2tncm91bmRQb3NpdGlvblswXSkpewogICAgICAgIGxlZnRQb3NpdGlvbiA9IChib3VuZHMud2lkdGggLSAoYmFja2dyb3VuZFNpemUgfHwgaW1hZ2UpLndpZHRoKSAqIChwYXJzZUZsb2F0KGJhY2tncm91bmRQb3NpdGlvblswXSkgLyAxMDApOwogICAgfSBlbHNlIHsKICAgICAgICBsZWZ0UG9zaXRpb24gPSBwYXJzZUludChiYWNrZ3JvdW5kUG9zaXRpb25bMF0sIDEwKTsKICAgIH0KCiAgICBpZiAoYmFja2dyb3VuZFBvc2l0aW9uWzFdID09PSAnYXV0bycpIHsKICAgICAgICB0b3BQb3NpdGlvbiA9IGxlZnRQb3NpdGlvbiAvIGltYWdlLndpZHRoICogaW1hZ2UuaGVpZ2h0OwogICAgfSBlbHNlIGlmIChpc1BlcmNlbnRhZ2UoYmFja2dyb3VuZFBvc2l0aW9uWzFdKSl7CiAgICAgICAgdG9wUG9zaXRpb24gPSAgKGJvdW5kcy5oZWlnaHQgLSAoYmFja2dyb3VuZFNpemUgfHwgaW1hZ2UpLmhlaWdodCkgKiBwYXJzZUZsb2F0KGJhY2tncm91bmRQb3NpdGlvblsxXSkgLyAxMDA7CiAgICB9IGVsc2UgewogICAgICAgIHRvcFBvc2l0aW9uID0gcGFyc2VJbnQoYmFja2dyb3VuZFBvc2l0aW9uWzFdLCAxMCk7CiAgICB9CgogICAgaWYgKGJhY2tncm91bmRQb3NpdGlvblswXSA9PT0gJ2F1dG8nKSB7CiAgICAgICAgbGVmdFBvc2l0aW9uID0gdG9wUG9zaXRpb24gLyBpbWFnZS5oZWlnaHQgKiBpbWFnZS53aWR0aDsKICAgIH0KCiAgICByZXR1cm4ge2xlZnQ6IGxlZnRQb3NpdGlvbiwgdG9wOiB0b3BQb3NpdGlvbn07Cn07CgpfaHRtbDJjYW52YXMuVXRpbC5CYWNrZ3JvdW5kU2l6ZSA9IGZ1bmN0aW9uKGVsZW1lbnQsIGJvdW5kcywgaW1hZ2UsIGltYWdlSW5kZXgpIHsKICB2YXIgYmFja2dyb3VuZFNpemUgPSAgX2h0bWwyY2FudmFzLlV0aWwuZ2V0Q1NTKGVsZW1lbnQsICdiYWNrZ3JvdW5kU2l6ZScsIGltYWdlSW5kZXgpLCB3aWR0aCwgaGVpZ2h0OwoKICBpZiAoYmFja2dyb3VuZFNpemUubGVuZ3RoID09PSAxKSB7CiAgICBiYWNrZ3JvdW5kU2l6ZSA9IFtiYWNrZ3JvdW5kU2l6ZVswXSwgYmFja2dyb3VuZFNpemVbMF1dOwogIH0KCiAgaWYgKGlzUGVyY2VudGFnZShiYWNrZ3JvdW5kU2l6ZVswXSkpIHsKICAgIHdpZHRoID0gYm91bmRzLndpZHRoICogcGFyc2VGbG9hdChiYWNrZ3JvdW5kU2l6ZVswXSkgLyAxMDA7CiAgfSBlbHNlIGlmICgvY29udGFpbnxjb3Zlci8udGVzdChiYWNrZ3JvdW5kU2l6ZVswXSkpIHsKICAgIHJldHVybiBfaHRtbDJjYW52YXMuVXRpbC5yZXNpemVCb3VuZHMoaW1hZ2Uud2lkdGgsIGltYWdlLmhlaWdodCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0LCBiYWNrZ3JvdW5kU2l6ZVswXSk7CiAgfSBlbHNlIHsKICAgIHdpZHRoID0gcGFyc2VJbnQoYmFja2dyb3VuZFNpemVbMF0sIDEwKTsKICB9CgogIGlmIChiYWNrZ3JvdW5kU2l6ZVswXSA9PT0gJ2F1dG8nICYmIGJhY2tncm91bmRTaXplWzFdID09PSAnYXV0bycpIHsKICAgIGhlaWdodCA9IGltYWdlLmhlaWdodDsKICB9IGVsc2UgaWYgKGJhY2tncm91bmRTaXplWzFdID09PSAnYXV0bycpIHsKICAgIGhlaWdodCA9IHdpZHRoIC8gaW1hZ2Uud2lkdGggKiBpbWFnZS5oZWlnaHQ7CiAgfSBlbHNlIGlmIChpc1BlcmNlbnRhZ2UoYmFja2dyb3VuZFNpemVbMV0pKSB7CiAgICBoZWlnaHQgPSAgYm91bmRzLmhlaWdodCAqIHBhcnNlRmxvYXQoYmFja2dyb3VuZFNpemVbMV0pIC8gMTAwOwogIH0gZWxzZSB7CiAgICBoZWlnaHQgPSBwYXJzZUludChiYWNrZ3JvdW5kU2l6ZVsxXSwgMTApOwogIH0KCiAgaWYgKGJhY2tncm91bmRTaXplWzBdID09PSAnYXV0bycpIHsKICAgIHdpZHRoID0gaGVpZ2h0IC8gaW1hZ2UuaGVpZ2h0ICogaW1hZ2Uud2lkdGg7CiAgfQoKICByZXR1cm4ge3dpZHRoOiB3aWR0aCwgaGVpZ2h0OiBoZWlnaHR9Owp9OwoKX2h0bWwyY2FudmFzLlV0aWwuQmFja2dyb3VuZFJlcGVhdCA9IGZ1bmN0aW9uKGVsZW1lbnQsIGltYWdlSW5kZXgpIHsKICB2YXIgYmFja2dyb3VuZFJlcGVhdCA9IF9odG1sMmNhbnZhcy5VdGlsLmdldENTUyhlbGVtZW50LCAiYmFja2dyb3VuZFJlcGVhdCIpLnNwbGl0KCIsIikubWFwKF9odG1sMmNhbnZhcy5VdGlsLnRyaW1UZXh0KTsKICByZXR1cm4gYmFja2dyb3VuZFJlcGVhdFtpbWFnZUluZGV4XSB8fCBiYWNrZ3JvdW5kUmVwZWF0WzBdOwp9OwoKX2h0bWwyY2FudmFzLlV0aWwuRXh0ZW5kID0gZnVuY3Rpb24gKG9wdGlvbnMsIGRlZmF1bHRzKSB7CiAgZm9yICh2YXIga2V5IGluIG9wdGlvbnMpIHsKICAgIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgZGVmYXVsdHNba2V5XSA9IG9wdGlvbnNba2V5XTsKICAgIH0KICB9CiAgcmV0dXJuIGRlZmF1bHRzOwp9OwoKCi8qCiAqIERlcml2ZWQgZnJvbSBqUXVlcnkuY29udGVudHMoKQogKiBDb3B5cmlnaHQgMjAxMCwgSm9obiBSZXNpZwogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgb3IgR1BMIFZlcnNpb24gMiBsaWNlbnNlcy4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KX2h0bWwyY2FudmFzLlV0aWwuQ2hpbGRyZW4gPSBmdW5jdGlvbiggZWxlbSApIHsKICB2YXIgY2hpbGRyZW47CiAgdHJ5IHsKICAgIGNoaWxkcmVuID0gKGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpID09PSAiSUZSQU1FIikgPyBlbGVtLmNvbnRlbnREb2N1bWVudCB8fCBlbGVtLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQgOiAoZnVuY3Rpb24oYXJyYXkpIHsKICAgICAgdmFyIHJldCA9IFtdOwogICAgICBpZiAoYXJyYXkgIT09IG51bGwpIHsKICAgICAgICAoZnVuY3Rpb24oZmlyc3QsIHNlY29uZCApIHsKICAgICAgICAgIHZhciBpID0gZmlyc3QubGVuZ3RoLAogICAgICAgICAgaiA9IDA7CgogICAgICAgICAgaWYgKHR5cGVvZiBzZWNvbmQubGVuZ3RoID09PSAibnVtYmVyIikgewogICAgICAgICAgICBmb3IgKHZhciBsID0gc2Vjb25kLmxlbmd0aDsgaiA8IGw7IGorKykgewogICAgICAgICAgICAgIGZpcnN0W2krK10gPSBzZWNvbmRbal07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdoaWxlIChzZWNvbmRbal0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIGZpcnN0W2krK10gPSBzZWNvbmRbaisrXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZpcnN0Lmxlbmd0aCA9IGk7CgogICAgICAgICAgcmV0dXJuIGZpcnN0OwogICAgICAgIH0pKHJldCwgYXJyYXkpOwogICAgICB9CiAgICAgIHJldHVybiByZXQ7CiAgICB9KShlbGVtLmNoaWxkTm9kZXMpOwoKICB9IGNhdGNoIChleCkgewogICAgX2h0bWwyY2FudmFzLlV0aWwubG9nKCJodG1sMmNhbnZhcy5VdGlsLkNoaWxkcmVuIGZhaWxlZCB3aXRoIGV4Y2VwdGlvbjogIiArIGV4Lm1lc3NhZ2UpOwogICAgY2hpbGRyZW4gPSBbXTsKICB9CiAgcmV0dXJuIGNoaWxkcmVuOwp9OwoKX2h0bWwyY2FudmFzLlV0aWwuaXNUcmFuc3BhcmVudCA9IGZ1bmN0aW9uKGJhY2tncm91bmRDb2xvcikgewogIHJldHVybiAoIWJhY2tncm91bmRDb2xvciB8fCBiYWNrZ3JvdW5kQ29sb3IgPT09ICJ0cmFuc3BhcmVudCIgfHwgYmFja2dyb3VuZENvbG9yID09PSAicmdiYSgwLCAwLCAwLCAwKSIpOwp9OwoKX2h0bWwyY2FudmFzLlV0aWwuRm9udCA9IChmdW5jdGlvbiAoKSB7CgogIHZhciBmb250RGF0YSA9IHt9OwoKICByZXR1cm4gZnVuY3Rpb24oZm9udCwgZm9udFNpemUsIGRvYykgewogICAgaWYgKGZvbnREYXRhW2ZvbnQgKyAiLSIgKyBmb250U2l6ZV0gIT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm4gZm9udERhdGFbZm9udCArICItIiArIGZvbnRTaXplXTsKICAgIH0KCiAgICB2YXIgY29udGFpbmVyID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2RpdicpLAogICAgaW1nID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2ltZycpLAogICAgc3BhbiA9IGRvYy5jcmVhdGVFbGVtZW50KCdzcGFuJyksCiAgICBzYW1wbGVUZXh0ID0gJ0hpZGRlbiBUZXh0JywKICAgIGJhc2VsaW5lLAogICAgbWlkZGxlLAogICAgbWV0cmljc09iajsKCiAgICBjb250YWluZXIuc3R5bGUudmlzaWJpbGl0eSA9ICJoaWRkZW4iOwogICAgY29udGFpbmVyLnN0eWxlLmZvbnRGYW1pbHkgPSBmb250OwogICAgY29udGFpbmVyLnN0eWxlLmZvbnRTaXplID0gZm9udFNpemU7CiAgICBjb250YWluZXIuc3R5bGUubWFyZ2luID0gMDsKICAgIGNvbnRhaW5lci5zdHlsZS5wYWRkaW5nID0gMDsKCiAgICBkb2MuYm9keS5hcHBlbmRDaGlsZChjb250YWluZXIpOwoKICAgIC8vIGh0dHA6Ly9wcm9iYWJseXByb2dyYW1taW5nLmNvbS8yMDA5LzAzLzE1L3RoZS10aW5pZXN0LWdpZi1ldmVyIChoYW5kdGlueXdoaXRlLmdpZikKICAgIGltZy5zcmMgPSAiZGF0YTppbWFnZS9naWY7YmFzZTY0LFIwbEdPRGxoQVFBQkFJQUJBUC8vL3dBQUFDd0FBQUFBQVFBQkFBQUNBa1FCQURzPSI7CiAgICBpbWcud2lkdGggPSAxOwogICAgaW1nLmhlaWdodCA9IDE7CgogICAgaW1nLnN0eWxlLm1hcmdpbiA9IDA7CiAgICBpbWcuc3R5bGUucGFkZGluZyA9IDA7CiAgICBpbWcuc3R5bGUudmVydGljYWxBbGlnbiA9ICJiYXNlbGluZSI7CgogICAgc3Bhbi5zdHlsZS5mb250RmFtaWx5ID0gZm9udDsKICAgIHNwYW4uc3R5bGUuZm9udFNpemUgPSBmb250U2l6ZTsKICAgIHNwYW4uc3R5bGUubWFyZ2luID0gMDsKICAgIHNwYW4uc3R5bGUucGFkZGluZyA9IDA7CgogICAgc3Bhbi5hcHBlbmRDaGlsZChkb2MuY3JlYXRlVGV4dE5vZGUoc2FtcGxlVGV4dCkpOwogICAgY29udGFpbmVyLmFwcGVuZENoaWxkKHNwYW4pOwogICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGltZyk7CiAgICBiYXNlbGluZSA9IChpbWcub2Zmc2V0VG9wIC0gc3Bhbi5vZmZzZXRUb3ApICsgMTsKCiAgICBjb250YWluZXIucmVtb3ZlQ2hpbGQoc3Bhbik7CiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZG9jLmNyZWF0ZVRleHROb2RlKHNhbXBsZVRleHQpKTsKCiAgICBjb250YWluZXIuc3R5bGUubGluZUhlaWdodCA9ICJub3JtYWwiOwogICAgaW1nLnN0eWxlLnZlcnRpY2FsQWxpZ24gPSAic3VwZXIiOwoKICAgIG1pZGRsZSA9IChpbWcub2Zmc2V0VG9wLWNvbnRhaW5lci5vZmZzZXRUb3ApICsgMTsKICAgIG1ldHJpY3NPYmogPSB7CiAgICAgIGJhc2VsaW5lOiBiYXNlbGluZSwKICAgICAgbGluZVdpZHRoOiAxLAogICAgICBtaWRkbGU6IG1pZGRsZQogICAgfTsKCiAgICBmb250RGF0YVtmb250ICsgIi0iICsgZm9udFNpemVdID0gbWV0cmljc09iajsKCiAgICBkb2MuYm9keS5yZW1vdmVDaGlsZChjb250YWluZXIpOwoKICAgIHJldHVybiBtZXRyaWNzT2JqOwogIH07Cn0pKCk7CgooZnVuY3Rpb24oKXsKICB2YXIgVXRpbCA9IF9odG1sMmNhbnZhcy5VdGlsLAogICAgR2VuZXJhdGUgPSB7fTsKCiAgX2h0bWwyY2FudmFzLkdlbmVyYXRlID0gR2VuZXJhdGU7CgogIHZhciByZUdyYWRpZW50cyA9IFsKICAvXigtd2Via2l0LWxpbmVhci1ncmFkaWVudClcKChbYS16XHNdKykoW1x3XGRcLlxzLCVcKFwpXSspXCkkLywKICAvXigtby1saW5lYXItZ3JhZGllbnQpXCgoW2EtelxzXSspKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sCiAgL14oLXdlYmtpdC1ncmFkaWVudClcKChsaW5lYXJ8cmFkaWFsKSxccygoPzpcZHsxLDN9JT8pXHMoPzpcZHsxLDN9JT8pLFxzKD86XGR7MSwzfSU/KVxzKD86XGR7MSwzfSU/KSkoW1x3XGRcLlxzLCVcKFwpXC1dKylcKSQvLAogIC9eKC1tb3otbGluZWFyLWdyYWRpZW50KVwoKCg/OlxkezEsM30lPylccyg/OlxkezEsM30lPykpKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sCiAgL14oLXdlYmtpdC1yYWRpYWwtZ3JhZGllbnQpXCgoKD86XGR7MSwzfSU/KVxzKD86XGR7MSwzfSU/KSksXHMoXHcrKVxzKFthLXpcLV0rKShbXHdcZFwuXHMsJVwoXCldKylcKSQvLAogIC9eKC1tb3otcmFkaWFsLWdyYWRpZW50KVwoKCg/OlxkezEsM30lPylccyg/OlxkezEsM30lPykpLFxzKFx3Kylccz8oW2EtelwtXSopKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sCiAgL14oLW8tcmFkaWFsLWdyYWRpZW50KVwoKCg/OlxkezEsM30lPylccyg/OlxkezEsM30lPykpLFxzKFx3KylccyhbYS16XC1dKykoW1x3XGRcLlxzLCVcKFwpXSspXCkkLwogIF07CgogIC8qCiAqIFRPRE86IEFkZCBJRTEwIHZlbmRvciBwcmVmaXggKC1tcykgc3VwcG9ydAogKiBUT0RPOiBBZGQgVzNDIGdyYWRpZW50IChsaW5lYXItZ3JhZGllbnQpIHN1cHBvcnQKICogVE9ETzogQWRkIG9sZCBXZWJraXQgLXdlYmtpdC1ncmFkaWVudChyYWRpYWwsIC4uLikgc3VwcG9ydAogKiBUT0RPOiBNYXliZSBzb21lIFJlZ0V4cCBvcHRpbWl6YXRpb25zIGFyZSBwb3NzaWJsZSA7bykKICovCiAgR2VuZXJhdGUucGFyc2VHcmFkaWVudCA9IGZ1bmN0aW9uKGNzcywgYm91bmRzKSB7CiAgICB2YXIgZ3JhZGllbnQsIGksIGxlbiA9IHJlR3JhZGllbnRzLmxlbmd0aCwgbTEsIHN0b3AsIG0yLCBtMkxlbiwgc3RlcCwgbTMsIHRsLHRyLGJyLGJsOwoKICAgIGZvcihpID0gMDsgaSA8IGxlbjsgaSs9MSl7CiAgICAgIG0xID0gY3NzLm1hdGNoKHJlR3JhZGllbnRzW2ldKTsKICAgICAgaWYobTEpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQoKICAgIGlmKG0xKSB7CiAgICAgIHN3aXRjaChtMVsxXSkgewogICAgICAgIGNhc2UgJy13ZWJraXQtbGluZWFyLWdyYWRpZW50JzoKICAgICAgICBjYXNlICctby1saW5lYXItZ3JhZGllbnQnOgoKICAgICAgICAgIGdyYWRpZW50ID0gewogICAgICAgICAgICB0eXBlOiAnbGluZWFyJywKICAgICAgICAgICAgeDA6IG51bGwsCiAgICAgICAgICAgIHkwOiBudWxsLAogICAgICAgICAgICB4MTogbnVsbCwKICAgICAgICAgICAgeTE6IG51bGwsCiAgICAgICAgICAgIGNvbG9yU3RvcHM6IFtdCiAgICAgICAgICB9OwoKICAgICAgICAgIC8vIGdldCBjb29yZGluYXRlcwogICAgICAgICAgbTIgPSBtMVsyXS5tYXRjaCgvXHcrL2cpOwogICAgICAgICAgaWYobTIpewogICAgICAgICAgICBtMkxlbiA9IG0yLmxlbmd0aDsKICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbTJMZW47IGkrPTEpewogICAgICAgICAgICAgIHN3aXRjaChtMltpXSkgewogICAgICAgICAgICAgICAgY2FzZSAndG9wJzoKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTAgPSAwOwogICAgICAgICAgICAgICAgICBncmFkaWVudC55MSA9IGJvdW5kcy5oZWlnaHQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgIGNhc2UgJ3JpZ2h0JzoKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDAgPSBib3VuZHMud2lkdGg7CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxID0gMDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSAnYm90dG9tJzoKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTAgPSBib3VuZHMuaGVpZ2h0OwogICAgICAgICAgICAgICAgICBncmFkaWVudC55MSA9IDA7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgIGNhc2UgJ2xlZnQnOgogICAgICAgICAgICAgICAgICBncmFkaWVudC54MCA9IDA7CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxID0gYm91bmRzLndpZHRoOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmKGdyYWRpZW50LngwID09PSBudWxsICYmIGdyYWRpZW50LngxID09PSBudWxsKXsgLy8gY2VudGVyCiAgICAgICAgICAgIGdyYWRpZW50LngwID0gZ3JhZGllbnQueDEgPSBib3VuZHMud2lkdGggLyAyOwogICAgICAgICAgfQogICAgICAgICAgaWYoZ3JhZGllbnQueTAgPT09IG51bGwgJiYgZ3JhZGllbnQueTEgPT09IG51bGwpeyAvLyBjZW50ZXIKICAgICAgICAgICAgZ3JhZGllbnQueTAgPSBncmFkaWVudC55MSA9IGJvdW5kcy5oZWlnaHQgLyAyOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIGdldCBjb2xvcnMgYW5kIHN0b3BzCiAgICAgICAgICBtMiA9IG0xWzNdLm1hdGNoKC8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkoPzpcc1xkezEsM30oPzolfHB4KSk/KSsvZyk7CiAgICAgICAgICBpZihtMil7CiAgICAgICAgICAgIG0yTGVuID0gbTIubGVuZ3RoOwogICAgICAgICAgICBzdGVwID0gMSAvIE1hdGgubWF4KG0yTGVuIC0gMSwgMSk7CiAgICAgICAgICAgIGZvcihpID0gMDsgaSA8IG0yTGVuOyBpKz0xKXsKICAgICAgICAgICAgICBtMyA9IG0yW2ldLm1hdGNoKC8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkpXHMqKFxkezEsM30pPyglfHB4KT8vKTsKICAgICAgICAgICAgICBpZihtM1syXSl7CiAgICAgICAgICAgICAgICBzdG9wID0gcGFyc2VGbG9hdChtM1syXSk7CiAgICAgICAgICAgICAgICBpZihtM1szXSA9PT0gJyUnKXsKICAgICAgICAgICAgICAgICAgc3RvcCAvPSAxMDA7CiAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBweCAtIHN0dXBpZCBvcGVyYQogICAgICAgICAgICAgICAgICBzdG9wIC89IGJvdW5kcy53aWR0aDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc3RvcCA9IGkgKiBzdGVwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLnB1c2goewogICAgICAgICAgICAgICAgY29sb3I6IG0zWzFdLAogICAgICAgICAgICAgICAgc3RvcDogc3RvcAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnLXdlYmtpdC1ncmFkaWVudCc6CgogICAgICAgICAgZ3JhZGllbnQgPSB7CiAgICAgICAgICAgIHR5cGU6IG0xWzJdID09PSAncmFkaWFsJyA/ICdjaXJjbGUnIDogbTFbMl0sIC8vIFRPRE86IEFkZCByYWRpYWwgZ3JhZGllbnQgc3VwcG9ydCBmb3Igb2xkZXIgbW96aWxsYSBkZWZpbml0aW9ucwogICAgICAgICAgICB4MDogMCwKICAgICAgICAgICAgeTA6IDAsCiAgICAgICAgICAgIHgxOiAwLAogICAgICAgICAgICB5MTogMCwKICAgICAgICAgICAgY29sb3JTdG9wczogW10KICAgICAgICAgIH07CgogICAgICAgICAgLy8gZ2V0IGNvb3JkaW5hdGVzCiAgICAgICAgICBtMiA9IG0xWzNdLm1hdGNoKC8oXGR7MSwzfSklP1xzKFxkezEsM30pJT8sXHMoXGR7MSwzfSklP1xzKFxkezEsM30pJT8vKTsKICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgZ3JhZGllbnQueDAgPSAobTJbMV0gKiBib3VuZHMud2lkdGgpIC8gMTAwOwogICAgICAgICAgICBncmFkaWVudC55MCA9IChtMlsyXSAqIGJvdW5kcy5oZWlnaHQpIC8gMTAwOwogICAgICAgICAgICBncmFkaWVudC54MSA9IChtMlszXSAqIGJvdW5kcy53aWR0aCkgLyAxMDA7CiAgICAgICAgICAgIGdyYWRpZW50LnkxID0gKG0yWzRdICogYm91bmRzLmhlaWdodCkgLyAxMDA7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gZ2V0IGNvbG9ycyBhbmQgc3RvcHMKICAgICAgICAgIG0yID0gbTFbNF0ubWF0Y2goLygoPzpmcm9tfHRvfGNvbG9yLXN0b3ApXCgoPzpbMC05XC5dKyxccyk/KD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XClcKSkrL2cpOwogICAgICAgICAgaWYobTIpewogICAgICAgICAgICBtMkxlbiA9IG0yLmxlbmd0aDsKICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbTJMZW47IGkrPTEpewogICAgICAgICAgICAgIG0zID0gbTJbaV0ubWF0Y2goLyhmcm9tfHRvfGNvbG9yLXN0b3ApXCgoWzAtOVwuXSspPyg/Oixccyk/KCg/OnJnYnxyZ2JhKVwoXGR7MSwzfSxcc1xkezEsM30sXHNcZHsxLDN9KD86LFxzWzAtOVwuXSspP1wpKVwpLyk7CiAgICAgICAgICAgICAgc3RvcCA9IHBhcnNlRmxvYXQobTNbMl0pOwogICAgICAgICAgICAgIGlmKG0zWzFdID09PSAnZnJvbScpIHsKICAgICAgICAgICAgICAgIHN0b3AgPSAwLjA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmKG0zWzFdID09PSAndG8nKSB7CiAgICAgICAgICAgICAgICBzdG9wID0gMS4wOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLnB1c2goewogICAgICAgICAgICAgICAgY29sb3I6IG0zWzNdLAogICAgICAgICAgICAgICAgc3RvcDogc3RvcAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnLW1vei1saW5lYXItZ3JhZGllbnQnOgoKICAgICAgICAgIGdyYWRpZW50ID0gewogICAgICAgICAgICB0eXBlOiAnbGluZWFyJywKICAgICAgICAgICAgeDA6IDAsCiAgICAgICAgICAgIHkwOiAwLAogICAgICAgICAgICB4MTogMCwKICAgICAgICAgICAgeTE6IDAsCiAgICAgICAgICAgIGNvbG9yU3RvcHM6IFtdCiAgICAgICAgICB9OwoKICAgICAgICAgIC8vIGdldCBjb29yZGluYXRlcwogICAgICAgICAgbTIgPSBtMVsyXS5tYXRjaCgvKFxkezEsM30pJT9ccyhcZHsxLDN9KSU/Lyk7CgogICAgICAgICAgLy8gbTJbMV0gPT0gMCUgICAtPiBsZWZ0CiAgICAgICAgICAvLyBtMlsxXSA9PSA1MCUgIC0+IGNlbnRlcgogICAgICAgICAgLy8gbTJbMV0gPT0gMTAwJSAtPiByaWdodAoKICAgICAgICAgIC8vIG0yWzJdID09IDAlICAgLT4gdG9wCiAgICAgICAgICAvLyBtMlsyXSA9PSA1MCUgIC0+IGNlbnRlcgogICAgICAgICAgLy8gbTJbMl0gPT0gMTAwJSAtPiBib3R0b20KCiAgICAgICAgICBpZihtMil7CiAgICAgICAgICAgIGdyYWRpZW50LngwID0gKG0yWzFdICogYm91bmRzLndpZHRoKSAvIDEwMDsKICAgICAgICAgICAgZ3JhZGllbnQueTAgPSAobTJbMl0gKiBib3VuZHMuaGVpZ2h0KSAvIDEwMDsKICAgICAgICAgICAgZ3JhZGllbnQueDEgPSBib3VuZHMud2lkdGggLSBncmFkaWVudC54MDsKICAgICAgICAgICAgZ3JhZGllbnQueTEgPSBib3VuZHMuaGVpZ2h0IC0gZ3JhZGllbnQueTA7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gZ2V0IGNvbG9ycyBhbmQgc3RvcHMKICAgICAgICAgIG0yID0gbTFbM10ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSg/OlxzXGR7MSwzfSUpPykrL2cpOwogICAgICAgICAgaWYobTIpewogICAgICAgICAgICBtMkxlbiA9IG0yLmxlbmd0aDsKICAgICAgICAgICAgc3RlcCA9IDEgLyBNYXRoLm1heChtMkxlbiAtIDEsIDEpOwogICAgICAgICAgICBmb3IoaSA9IDA7IGkgPCBtMkxlbjsgaSs9MSl7CiAgICAgICAgICAgICAgbTMgPSBtMltpXS5tYXRjaCgvKCg/OnJnYnxyZ2JhKVwoXGR7MSwzfSxcc1xkezEsM30sXHNcZHsxLDN9KD86LFxzWzAtOVwuXSspP1wpKVxzKihcZHsxLDN9KT8oJSk/Lyk7CiAgICAgICAgICAgICAgaWYobTNbMl0pewogICAgICAgICAgICAgICAgc3RvcCA9IHBhcnNlRmxvYXQobTNbMl0pOwogICAgICAgICAgICAgICAgaWYobTNbM10peyAvLyBwZXJjZW50YWdlCiAgICAgICAgICAgICAgICAgIHN0b3AgLz0gMTAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdG9wID0gaSAqIHN0ZXA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGdyYWRpZW50LmNvbG9yU3RvcHMucHVzaCh7CiAgICAgICAgICAgICAgICBjb2xvcjogbTNbMV0sCiAgICAgICAgICAgICAgICBzdG9wOiBzdG9wCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICctd2Via2l0LXJhZGlhbC1ncmFkaWVudCc6CiAgICAgICAgY2FzZSAnLW1vei1yYWRpYWwtZ3JhZGllbnQnOgogICAgICAgIGNhc2UgJy1vLXJhZGlhbC1ncmFkaWVudCc6CgogICAgICAgICAgZ3JhZGllbnQgPSB7CiAgICAgICAgICAgIHR5cGU6ICdjaXJjbGUnLAogICAgICAgICAgICB4MDogMCwKICAgICAgICAgICAgeTA6IDAsCiAgICAgICAgICAgIHgxOiBib3VuZHMud2lkdGgsCiAgICAgICAgICAgIHkxOiBib3VuZHMuaGVpZ2h0LAogICAgICAgICAgICBjeDogMCwKICAgICAgICAgICAgY3k6IDAsCiAgICAgICAgICAgIHJ4OiAwLAogICAgICAgICAgICByeTogMCwKICAgICAgICAgICAgY29sb3JTdG9wczogW10KICAgICAgICAgIH07CgogICAgICAgICAgLy8gY2VudGVyCiAgICAgICAgICBtMiA9IG0xWzJdLm1hdGNoKC8oXGR7MSwzfSklP1xzKFxkezEsM30pJT8vKTsKICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgZ3JhZGllbnQuY3ggPSAobTJbMV0gKiBib3VuZHMud2lkdGgpIC8gMTAwOwogICAgICAgICAgICBncmFkaWVudC5jeSA9IChtMlsyXSAqIGJvdW5kcy5oZWlnaHQpIC8gMTAwOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIHNpemUKICAgICAgICAgIG0yID0gbTFbM10ubWF0Y2goL1x3Ky8pOwogICAgICAgICAgbTMgPSBtMVs0XS5tYXRjaCgvW2EtelwtXSovKTsKICAgICAgICAgIGlmKG0yICYmIG0zKXsKICAgICAgICAgICAgc3dpdGNoKG0zWzBdKXsKICAgICAgICAgICAgICBjYXNlICdmYXJ0aGVzdC1jb3JuZXInOgogICAgICAgICAgICAgIGNhc2UgJ2NvdmVyJzogLy8gaXMgZXF1aXZhbGVudCB0byBmYXJ0aGVzdC1jb3JuZXIKICAgICAgICAgICAgICBjYXNlICcnOiAvLyBtb3ppbGxhIHJlbW92ZXMgImNvdmVyIiBmcm9tIGRlZmluaXRpb24gOigKICAgICAgICAgICAgICAgIHRsID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LmN5LCAyKSk7CiAgICAgICAgICAgICAgICB0ciA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC5jeCwgMikgKyBNYXRoLnBvdyhncmFkaWVudC55MSAtIGdyYWRpZW50LmN5LCAyKSk7CiAgICAgICAgICAgICAgICBiciA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC54MSAtIGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3ksIDIpKTsKICAgICAgICAgICAgICAgIGJsID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQuY3ksIDIpKTsKICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gZ3JhZGllbnQucnkgPSBNYXRoLm1heCh0bCwgdHIsIGJyLCBibCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICdjbG9zZXN0LWNvcm5lcic6CiAgICAgICAgICAgICAgICB0bCA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC5jeCwgMikgKyBNYXRoLnBvdyhncmFkaWVudC5jeSwgMikpOwogICAgICAgICAgICAgICAgdHIgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeSwgMikpOwogICAgICAgICAgICAgICAgYnIgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeCwgMikgKyBNYXRoLnBvdyhncmFkaWVudC55MSAtIGdyYWRpZW50LmN5LCAyKSk7CiAgICAgICAgICAgICAgICBibCA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC54MSAtIGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LmN5LCAyKSk7CiAgICAgICAgICAgICAgICBncmFkaWVudC5yeCA9IGdyYWRpZW50LnJ5ID0gTWF0aC5taW4odGwsIHRyLCBiciwgYmwpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAnZmFydGhlc3Qtc2lkZSc6CiAgICAgICAgICAgICAgICBpZihtMlswXSA9PT0gJ2NpcmNsZScpewogICAgICAgICAgICAgICAgICBncmFkaWVudC5yeCA9IGdyYWRpZW50LnJ5ID0gTWF0aC5tYXgoCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3gsCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3ksCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeCwKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MSAtIGdyYWRpZW50LmN5CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8vIGVsbGlwc2UKCiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnR5cGUgPSBtMlswXTsKCiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gTWF0aC5tYXgoCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3gsCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeAogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ5ID0gTWF0aC5tYXgoCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3ksCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICdjbG9zZXN0LXNpZGUnOgogICAgICAgICAgICAgIGNhc2UgJ2NvbnRhaW4nOiAvLyBpcyBlcXVpdmFsZW50IHRvIGNsb3Nlc3Qtc2lkZQogICAgICAgICAgICAgICAgaWYobTJbMF0gPT09ICdjaXJjbGUnKXsKICAgICAgICAgICAgICAgICAgZ3JhZGllbnQucnggPSBncmFkaWVudC5yeSA9IE1hdGgubWluKAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN4LAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN5LAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBlbGxpcHNlCgogICAgICAgICAgICAgICAgICBncmFkaWVudC50eXBlID0gbTJbMF07CgogICAgICAgICAgICAgICAgICBncmFkaWVudC5yeCA9IE1hdGgubWluKAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN4LAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBncmFkaWVudC5yeSA9IE1hdGgubWluKAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN5LAogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3kKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAvLyBUT0RPOiBhZGQgc3VwcG9ydCBmb3IgIjMwcHggNDBweCIgc2l6ZXMgKHdlYmtpdCBvbmx5KQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gY29sb3Igc3RvcHMKICAgICAgICAgIG0yID0gbTFbNV0ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSg/OlxzXGR7MSwzfSg/OiV8cHgpKT8pKy9nKTsKICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgbTJMZW4gPSBtMi5sZW5ndGg7CiAgICAgICAgICAgIHN0ZXAgPSAxIC8gTWF0aC5tYXgobTJMZW4gLSAxLCAxKTsKICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbTJMZW47IGkrPTEpewogICAgICAgICAgICAgIG0zID0gbTJbaV0ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSlccyooXGR7MSwzfSk/KCV8cHgpPy8pOwogICAgICAgICAgICAgIGlmKG0zWzJdKXsKICAgICAgICAgICAgICAgIHN0b3AgPSBwYXJzZUZsb2F0KG0zWzJdKTsKICAgICAgICAgICAgICAgIGlmKG0zWzNdID09PSAnJScpewogICAgICAgICAgICAgICAgICBzdG9wIC89IDEwMDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8vIHB4IC0gc3R1cGlkIG9wZXJhCiAgICAgICAgICAgICAgICAgIHN0b3AgLz0gYm91bmRzLndpZHRoOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdG9wID0gaSAqIHN0ZXA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGdyYWRpZW50LmNvbG9yU3RvcHMucHVzaCh7CiAgICAgICAgICAgICAgICBjb2xvcjogbTNbMV0sCiAgICAgICAgICAgICAgICBzdG9wOiBzdG9wCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGdyYWRpZW50OwogIH07CgogIGZ1bmN0aW9uIGFkZFNjcm9sbFN0b3BzKGdyYWQpIHsKICAgIHJldHVybiBmdW5jdGlvbihjb2xvclN0b3ApIHsKICAgICAgdHJ5IHsKICAgICAgICBncmFkLmFkZENvbG9yU3RvcChjb2xvclN0b3Auc3RvcCwgY29sb3JTdG9wLmNvbG9yKTsKICAgICAgfQogICAgICBjYXRjaChlKSB7CiAgICAgICAgVXRpbC5sb2coWydmYWlsZWQgdG8gYWRkIGNvbG9yIHN0b3A6ICcsIGUsICc7IHRyaWVkIHRvIGFkZDogJywgY29sb3JTdG9wXSk7CiAgICAgIH0KICAgIH07CiAgfQoKICBHZW5lcmF0ZS5HcmFkaWVudCA9IGZ1bmN0aW9uKHNyYywgYm91bmRzKSB7CiAgICBpZihib3VuZHMud2lkdGggPT09IDAgfHwgYm91bmRzLmhlaWdodCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpLAogICAgY3R4ID0gY2FudmFzLmdldENvbnRleHQoJzJkJyksCiAgICBncmFkaWVudCwgZ3JhZDsKCiAgICBjYW52YXMud2lkdGggPSBib3VuZHMud2lkdGg7CiAgICBjYW52YXMuaGVpZ2h0ID0gYm91bmRzLmhlaWdodDsKCiAgICAvLyBUT0RPOiBhZGQgc3VwcG9ydCBmb3IgbXVsdGkgZGVmaW5lZCBiYWNrZ3JvdW5kIGdyYWRpZW50cwogICAgZ3JhZGllbnQgPSBfaHRtbDJjYW52YXMuR2VuZXJhdGUucGFyc2VHcmFkaWVudChzcmMsIGJvdW5kcyk7CgogICAgaWYoZ3JhZGllbnQpIHsKICAgICAgc3dpdGNoKGdyYWRpZW50LnR5cGUpIHsKICAgICAgICBjYXNlICdsaW5lYXInOgogICAgICAgICAgZ3JhZCA9IGN0eC5jcmVhdGVMaW5lYXJHcmFkaWVudChncmFkaWVudC54MCwgZ3JhZGllbnQueTAsIGdyYWRpZW50LngxLCBncmFkaWVudC55MSk7CiAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLmZvckVhY2goYWRkU2Nyb2xsU3RvcHMoZ3JhZCkpOwogICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGdyYWQ7CiAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0KTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdjaXJjbGUnOgogICAgICAgICAgZ3JhZCA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChncmFkaWVudC5jeCwgZ3JhZGllbnQuY3ksIDAsIGdyYWRpZW50LmN4LCBncmFkaWVudC5jeSwgZ3JhZGllbnQucngpOwogICAgICAgICAgZ3JhZGllbnQuY29sb3JTdG9wcy5mb3JFYWNoKGFkZFNjcm9sbFN0b3BzKGdyYWQpKTsKICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBncmFkOwogICAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIGJvdW5kcy53aWR0aCwgYm91bmRzLmhlaWdodCk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnZWxsaXBzZSc6CiAgICAgICAgICB2YXIgY2FudmFzUmFkaWFsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksCiAgICAgICAgICAgIGN0eFJhZGlhbCA9IGNhbnZhc1JhZGlhbC5nZXRDb250ZXh0KCcyZCcpLAogICAgICAgICAgICByaSA9IE1hdGgubWF4KGdyYWRpZW50LnJ4LCBncmFkaWVudC5yeSksCiAgICAgICAgICAgIGRpID0gcmkgKiAyOwoKICAgICAgICAgIGNhbnZhc1JhZGlhbC53aWR0aCA9IGNhbnZhc1JhZGlhbC5oZWlnaHQgPSBkaTsKCiAgICAgICAgICBncmFkID0gY3R4UmFkaWFsLmNyZWF0ZVJhZGlhbEdyYWRpZW50KGdyYWRpZW50LnJ4LCBncmFkaWVudC5yeSwgMCwgZ3JhZGllbnQucngsIGdyYWRpZW50LnJ5LCByaSk7CiAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLmZvckVhY2goYWRkU2Nyb2xsU3RvcHMoZ3JhZCkpOwoKICAgICAgICAgIGN0eFJhZGlhbC5maWxsU3R5bGUgPSBncmFkOwogICAgICAgICAgY3R4UmFkaWFsLmZpbGxSZWN0KDAsIDAsIGRpLCBkaSk7CgogICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGdyYWRpZW50LmNvbG9yU3RvcHNbZ3JhZGllbnQuY29sb3JTdG9wcy5sZW5ndGggLSAxXS5jb2xvcjsKICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHQpOwogICAgICAgICAgY3R4LmRyYXdJbWFnZShjYW52YXNSYWRpYWwsIGdyYWRpZW50LmN4IC0gZ3JhZGllbnQucngsIGdyYWRpZW50LmN5IC0gZ3JhZGllbnQucnksIDIgKiBncmFkaWVudC5yeCwgMiAqIGdyYWRpZW50LnJ5KTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGNhbnZhczsKICB9OwoKICBHZW5lcmF0ZS5MaXN0QWxwaGEgPSBmdW5jdGlvbihudW1iZXIpIHsKICAgIHZhciB0bXAgPSAiIiwKICAgIG1vZHVsdXM7CgogICAgZG8gewogICAgICBtb2R1bHVzID0gbnVtYmVyICUgMjY7CiAgICAgIHRtcCA9IFN0cmluZy5mcm9tQ2hhckNvZGUoKG1vZHVsdXMpICsgNjQpICsgdG1wOwogICAgICBudW1iZXIgPSBudW1iZXIgLyAyNjsKICAgIH13aGlsZSgobnVtYmVyKjI2KSA+IDI2KTsKCiAgICByZXR1cm4gdG1wOwogIH07CgogIEdlbmVyYXRlLkxpc3RSb21hbiA9IGZ1bmN0aW9uKG51bWJlcikgewogICAgdmFyIHJvbWFuQXJyYXkgPSBbIk0iLCAiQ00iLCAiRCIsICJDRCIsICJDIiwgIlhDIiwgIkwiLCAiWEwiLCAiWCIsICJJWCIsICJWIiwgIklWIiwgIkkiXSwKICAgIGRlY2ltYWwgPSBbMTAwMCwgOTAwLCA1MDAsIDQwMCwgMTAwLCA5MCwgNTAsIDQwLCAxMCwgOSwgNSwgNCwgMV0sCiAgICByb21hbiA9ICIiLAogICAgdiwKICAgIGxlbiA9IHJvbWFuQXJyYXkubGVuZ3RoOwoKICAgIGlmIChudW1iZXIgPD0gMCB8fCBudW1iZXIgPj0gNDAwMCkgewogICAgICByZXR1cm4gbnVtYmVyOwogICAgfQoKICAgIGZvciAodj0wOyB2IDwgbGVuOyB2Kz0xKSB7CiAgICAgIHdoaWxlIChudW1iZXIgPj0gZGVjaW1hbFt2XSkgewogICAgICAgIG51bWJlciAtPSBkZWNpbWFsW3ZdOwogICAgICAgIHJvbWFuICs9IHJvbWFuQXJyYXlbdl07CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcm9tYW47CiAgfTsKfSkoKTsKZnVuY3Rpb24gaDJjUmVuZGVyQ29udGV4dCh3aWR0aCwgaGVpZ2h0KSB7CiAgdmFyIHN0b3JhZ2UgPSBbXTsKICByZXR1cm4gewogICAgc3RvcmFnZTogc3RvcmFnZSwKICAgIHdpZHRoOiB3aWR0aCwKICAgIGhlaWdodDogaGVpZ2h0LAogICAgY2xpcDogZnVuY3Rpb24oKSB7CiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICBuYW1lOiAiY2xpcCIsCiAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICB9KTsKICAgIH0sCiAgICB0cmFuc2xhdGU6IGZ1bmN0aW9uKCkgewogICAgICBzdG9yYWdlLnB1c2goewogICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsCiAgICAgICAgbmFtZTogInRyYW5zbGF0ZSIsCiAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICB9KTsKICAgIH0sCiAgICBmaWxsOiBmdW5jdGlvbigpIHsKICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICB0eXBlOiAiZnVuY3Rpb24iLAogICAgICAgIG5hbWU6ICJmaWxsIiwKICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgIH0pOwogICAgfSwKICAgIHNhdmU6IGZ1bmN0aW9uKCkgewogICAgICBzdG9yYWdlLnB1c2goewogICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsCiAgICAgICAgbmFtZTogInNhdmUiLAogICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgfSk7CiAgICB9LAogICAgcmVzdG9yZTogZnVuY3Rpb24oKSB7CiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICBuYW1lOiAicmVzdG9yZSIsCiAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICB9KTsKICAgIH0sCiAgICBmaWxsUmVjdDogZnVuY3Rpb24gKCkgewogICAgICBzdG9yYWdlLnB1c2goewogICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsCiAgICAgICAgbmFtZTogImZpbGxSZWN0IiwKICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgIH0pOwogICAgfSwKICAgIGNyZWF0ZVBhdHRlcm46IGZ1bmN0aW9uKCkgewogICAgICBzdG9yYWdlLnB1c2goewogICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsCiAgICAgICAgbmFtZTogImNyZWF0ZVBhdHRlcm4iLAogICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgfSk7CiAgICB9LAogICAgZHJhd1NoYXBlOiBmdW5jdGlvbigpIHsKCiAgICAgIHZhciBzaGFwZSA9IFtdOwoKICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICB0eXBlOiAiZnVuY3Rpb24iLAogICAgICAgIG5hbWU6ICJkcmF3U2hhcGUiLAogICAgICAgICdhcmd1bWVudHMnOiBzaGFwZQogICAgICB9KTsKCiAgICAgIHJldHVybiB7CiAgICAgICAgbW92ZVRvOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHNoYXBlLnB1c2goewogICAgICAgICAgICBuYW1lOiAibW92ZVRvIiwKICAgICAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBsaW5lVG86IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2hhcGUucHVzaCh7CiAgICAgICAgICAgIG5hbWU6ICJsaW5lVG8iLAogICAgICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGFyY1RvOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHNoYXBlLnB1c2goewogICAgICAgICAgICBuYW1lOiAiYXJjVG8iLAogICAgICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGJlemllckN1cnZlVG86IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2hhcGUucHVzaCh7CiAgICAgICAgICAgIG5hbWU6ICJiZXppZXJDdXJ2ZVRvIiwKICAgICAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBxdWFkcmF0aWNDdXJ2ZVRvOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHNoYXBlLnB1c2goewogICAgICAgICAgICBuYW1lOiAicXVhZHJhdGljQ3VydmVUbyIsCiAgICAgICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfTsKCiAgICB9LAogICAgZHJhd0ltYWdlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICBuYW1lOiAiZHJhd0ltYWdlIiwKICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgIH0pOwogICAgfSwKICAgIGZpbGxUZXh0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICBuYW1lOiAiZmlsbFRleHQiLAogICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgfSk7CiAgICB9LAogICAgc2V0VmFyaWFibGU6IGZ1bmN0aW9uICh2YXJpYWJsZSwgdmFsdWUpIHsKICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICB0eXBlOiAidmFyaWFibGUiLAogICAgICAgIG5hbWU6IHZhcmlhYmxlLAogICAgICAgICdhcmd1bWVudHMnOiB2YWx1ZQogICAgICB9KTsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogIH07Cn0KX2h0bWwyY2FudmFzLlBhcnNlID0gZnVuY3Rpb24gKGltYWdlcywgb3B0aW9ucywgY2IpIHsKICB3aW5kb3cuc2Nyb2xsKDAsMCk7CgogIHZhciBlbGVtZW50ID0gKCggb3B0aW9ucy5lbGVtZW50cyA9PT0gdW5kZWZpbmVkICkgPyBkb2N1bWVudC5ib2R5IDogb3B0aW9ucy5lbGVtZW50c1swXSksIC8vIHNlbGVjdCBib2R5IGJ5IGRlZmF1bHQKICBudW1EcmF3cyA9IDAsCiAgZG9jID0gZWxlbWVudC5vd25lckRvY3VtZW50LAogIFV0aWwgPSBfaHRtbDJjYW52YXMuVXRpbCwKICBzdXBwb3J0ID0gVXRpbC5TdXBwb3J0KG9wdGlvbnMsIGRvYyksCiAgaWdub3JlRWxlbWVudHNSZWdFeHAgPSBuZXcgUmVnRXhwKCIoIiArIG9wdGlvbnMuaWdub3JlRWxlbWVudHMgKyAiKSIpLAogIGJvZHkgPSBkb2MuYm9keSwKICBnZXRDU1MgPSBVdGlsLmdldENTUywKICBwc2V1ZG9IaWRlID0gIl9fX2h0bWwyY2FudmFzX19fcHNldWRvZWxlbWVudCIsCiAgaGlkZVBzZXVkb0VsZW1lbnRzU3R5bGVzID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CgogIGhpZGVQc2V1ZG9FbGVtZW50c1N0eWxlcy5pbm5lckhUTUwgPSAnLicgKyBwc2V1ZG9IaWRlICsKICAnLXBhcmVudDpiZWZvcmUgeyBjb250ZW50OiAiIiAhaW1wb3J0YW50OyBkaXNwbGF5OiBub25lICFpbXBvcnRhbnQ7IH0nICsKICAnLicgKyBwc2V1ZG9IaWRlICsgJy1wYXJlbnQ6YWZ0ZXIgeyBjb250ZW50OiAiIiAhaW1wb3J0YW50OyBkaXNwbGF5OiBub25lICFpbXBvcnRhbnQ7IH0nOwoKICBib2R5LmFwcGVuZENoaWxkKGhpZGVQc2V1ZG9FbGVtZW50c1N0eWxlcyk7CgogIGltYWdlcyA9IGltYWdlcyB8fCB7fTsKCiAgaW5pdCgpOwoKICBmdW5jdGlvbiBpbml0KCkgewogICAgdmFyIGJhY2tncm91bmQgPSBnZXRDU1MoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCAiYmFja2dyb3VuZENvbG9yIiksCiAgICAgIHRyYW5zcGFyZW50QmFja2dyb3VuZCA9IChVdGlsLmlzVHJhbnNwYXJlbnQoYmFja2dyb3VuZCkgJiYgZWxlbWVudCA9PT0gZG9jdW1lbnQuYm9keSksCiAgICAgIHN0YWNrID0gcmVuZGVyRWxlbWVudChlbGVtZW50LCBudWxsLCBmYWxzZSwgdHJhbnNwYXJlbnRCYWNrZ3JvdW5kKTsKCiAgICAvLyBjcmVhdGUgcHNldWRvIGVsZW1lbnRzIGluIGEgc2luZ2xlIHBhc3MgdG8gcHJldmVudCBzeW5jaHJvbm91cyBsYXlvdXRzCiAgICBhZGRQc2V1ZG9FbGVtZW50cyhlbGVtZW50KTsKCiAgICBwYXJzZUNoaWxkcmVuKGVsZW1lbnQsIHN0YWNrLCBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRyYW5zcGFyZW50QmFja2dyb3VuZCkgewogICAgICAgIGJhY2tncm91bmQgPSBzdGFjay5iYWNrZ3JvdW5kQ29sb3I7CiAgICAgIH0KCiAgICAgIHJlbW92ZVBzZXVkb0VsZW1lbnRzKCk7CgogICAgICBVdGlsLmxvZygnRG9uZSBwYXJzaW5nLCBtb3ZpbmcgdG8gUmVuZGVyLicpOwoKICAgICAgY2IoewogICAgICAgIGJhY2tncm91bmRDb2xvcjogYmFja2dyb3VuZCwKICAgICAgICBzdGFjazogc3RhY2sKICAgICAgfSk7CiAgICB9KTsKICB9CgogIC8vIEdpdmVuIGEgcm9vdCBlbGVtZW50LCBmaW5kIGFsbCBwc2V1ZG8gZWxlbWVudHMgYmVsb3csIGNyZWF0ZSBlbGVtZW50cyBtb2NraW5nIHBzZXVkbyBlbGVtZW50IHN0eWxlcwogIC8vIHNvIHdlIGNhbiBwcm9jZXNzIHRoZW0gYXMgbm9ybWFsIGVsZW1lbnRzLCBhbmQgaGlkZSB0aGUgb3JpZ2luYWwgcHNldWRvIGVsZW1lbnRzIHNvIHRoZXkgZG9uJ3QgaW50ZXJmZXJlCiAgLy8gd2l0aCBsYXlvdXQuCiAgZnVuY3Rpb24gYWRkUHNldWRvRWxlbWVudHMoZWwpIHsKICAgIC8vIFRoZXNlIGFyZSBkb25lIGluIGRpc2NyZXRlIHN0ZXBzIHRvIHByZXZlbnQgYSByZWxheW91dCBsb29wIGNhdXNlZCBieSBhZGRDbGFzcygpIGludmFsaWRhdGluZwogICAgLy8gbGF5b3V0cyAmIGdldFBzZXVkb0VsZW1lbnQgY2FsbGluZyBnZXRDb21wdXRlZFN0eWxlLgogICAgdmFyIGpvYnMgPSBbXSwgY2xhc3NlcyA9IFtdOwogICAgZ2V0UHNldWRvRWxlbWVudENsYXNzZXMoKTsKICAgIGZpbmRQc2V1ZG9FbGVtZW50cyhlbCk7CiAgICBydW5Kb2JzKCk7CgogICAgZnVuY3Rpb24gZ2V0UHNldWRvRWxlbWVudENsYXNzZXMoKXsKICAgICAgdmFyIGZpbmRQc3VlZG9FbHMgPSAvOmJlZm9yZXw6YWZ0ZXIvOwogICAgICB2YXIgc2hlZXRzID0gZG9jdW1lbnQuc3R5bGVTaGVldHM7CiAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gc2hlZXRzLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgcnVsZXMgPSBzaGVldHNbaV0uY3NzUnVsZXM7CiAgICAgICAgICBmb3IgKHZhciBrID0gMCwgbCA9IHJ1bGVzLmxlbmd0aDsgayA8IGw7IGsrKykgewogICAgICAgICAgICBpZihmaW5kUHN1ZWRvRWxzLnRlc3QocnVsZXNba10uc2VsZWN0b3JUZXh0KSkgewogICAgICAgICAgICAgIGNsYXNzZXMucHVzaChydWxlc1trXS5zZWxlY3RvclRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNhdGNoKGUpIHsgLy8gd2lsbCB0aHJvdyBzZWN1cml0eSBleGNlcHRpb24gZm9yIHN0eWxlIHNoZWV0cyBsb2FkZWQgZnJvbSBleHRlcm5hbCBkb21haW5zCiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBUcmltIG9mZiB0aGUgOmFmdGVyIGFuZCA6YmVmb3JlIChvciA6OmFmdGVyIGFuZCA6OmJlZm9yZSkKICAgICAgZm9yIChpID0gMCwgaiA9IGNsYXNzZXMubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgY2xhc3Nlc1tpXSA9IGNsYXNzZXNbaV0ubWF0Y2goLyheW146XSopLylbMV07CiAgICAgIH0KICAgIH0KCiAgICAvLyBVc2luZyB0aGUgbGlzdCBvZiBlbGVtZW50cyB3ZSBrbm93IGhvdyBwc2V1ZG8gZWwgc3R5bGVzLCBjcmVhdGUgZmFrZSBwc2V1ZG8gZWxlbWVudHMuCiAgICBmdW5jdGlvbiBmaW5kUHNldWRvRWxlbWVudHMoZWwpIHsKICAgICAgdmFyIGVscyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoY2xhc3Nlcy5qb2luKCcsJykpOwogICAgICBmb3IodmFyIGkgPSAwLCBqID0gZWxzLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgIGNyZWF0ZVBzZXVkb0VsZW1lbnRzKGVsc1tpXSk7CiAgICAgIH0KICAgIH0KCiAgICAvLyBDcmVhdGUgcHNldWRvIGVsZW1lbnRzICYgYWRkIHRoZW0gdG8gYSBqb2IgcXVldWUuCiAgICBmdW5jdGlvbiBjcmVhdGVQc2V1ZG9FbGVtZW50cyhlbCkgewogICAgICB2YXIgYmVmb3JlID0gZ2V0UHNldWRvRWxlbWVudChlbCwgJzpiZWZvcmUnKSwKICAgICAgYWZ0ZXIgPSBnZXRQc2V1ZG9FbGVtZW50KGVsLCAnOmFmdGVyJyk7CgogICAgICBpZihiZWZvcmUpIHsKICAgICAgICBqb2JzLnB1c2goe3R5cGU6ICdiZWZvcmUnLCBwc2V1ZG86IGJlZm9yZSwgZWw6IGVsfSk7CiAgICAgIH0KCiAgICAgIGlmIChhZnRlcikgewogICAgICAgIGpvYnMucHVzaCh7dHlwZTogJ2FmdGVyJywgcHNldWRvOiBhZnRlciwgZWw6IGVsfSk7CiAgICAgIH0KICAgIH0KCiAgICAvLyBBZGRzIGEgY2xhc3MgdG8gdGhlIHBzZXVkbydzIHBhcmVudCB0byBwcmV2ZW50IHRoZSBvcmlnaW5hbCBiZWZvcmUvYWZ0ZXIgZnJvbSBtZXNzaW5nCiAgICAvLyB3aXRoIGxheW91dHMuCiAgICAvLyBFeGVjdXRlIHRoZSBpbnNlcnRzICYgYWRkQ2xhc3MoKSBjYWxscyBpbiBhIGJhdGNoIHRvIHByZXZlbnQgcmVsYXlvdXRzLgogICAgZnVuY3Rpb24gcnVuSm9icygpIHsKICAgICAgLy8gQWRkIENsYXNzCiAgICAgIGpvYnMuZm9yRWFjaChmdW5jdGlvbihqb2IpewogICAgICAgIGFkZENsYXNzKGpvYi5lbCwgcHNldWRvSGlkZSArICItcGFyZW50Iik7CiAgICAgIH0pOwoKICAgICAgLy8gSW5zZXJ0IGVsCiAgICAgIGpvYnMuZm9yRWFjaChmdW5jdGlvbihqb2IpewogICAgICAgIGlmKGpvYi50eXBlID09PSAnYmVmb3JlJyl7CiAgICAgICAgICBqb2IuZWwuaW5zZXJ0QmVmb3JlKGpvYi5wc2V1ZG8sIGpvYi5lbC5maXJzdENoaWxkKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgam9iLmVsLmFwcGVuZENoaWxkKGpvYi5wc2V1ZG8pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfQoKCgogIC8vIERlbGV0ZSBvdXIgZmFrZSBwc2V1ZG8gZWxlbWVudHMgZnJvbSB0aGUgRE9NLiBUaGlzIHdpbGwgcmVtb3ZlIHRob3NlIGFjdHVhbCBlbGVtZW50cwogIC8vIGFuZCB0aGUgY2xhc3NlcyBvbiB0aGVpciBwYXJlbnRzIHRoYXQgaGlkZSB0aGUgYWN0dWFsIHBzZXVkbyBlbGVtZW50cy4KICAvLyBOb3RlIHRoYXQgTm9kZUxpc3RzIGFyZSAnbGl2ZScgY29sbGVjdGlvbnMgc28geW91IGNhbid0IHVzZSBhIGZvciBsb29wIGhlcmUuIFRoZXkgYXJlCiAgLy8gYWN0dWFsbHkgZGVsZXRlZCBmcm9tIHRoZSBOb2RlTGlzdCBhZnRlciBlYWNoIGl0ZXJhdGlvbi4KICBmdW5jdGlvbiByZW1vdmVQc2V1ZG9FbGVtZW50cygpewogICAgLy8gZGVsZXRlIHBzZXVkbyBlbGVtZW50cwogICAgYm9keS5yZW1vdmVDaGlsZChoaWRlUHNldWRvRWxlbWVudHNTdHlsZXMpOwogICAgdmFyIHBzZXVkb3MgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKHBzZXVkb0hpZGUgKyAiLWVsZW1lbnQiKTsKICAgIHdoaWxlIChwc2V1ZG9zLmxlbmd0aCkgewogICAgICBwc2V1ZG9zWzBdLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQocHNldWRvc1swXSk7CiAgICB9CgogICAgLy8gUmVtb3ZlIHBzZXVkbyBoaWRpbmcgY2xhc3NlcwogICAgdmFyIHBhcmVudHMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKHBzZXVkb0hpZGUgKyAiLXBhcmVudCIpOwogICAgd2hpbGUocGFyZW50cy5sZW5ndGgpIHsKICAgICAgcmVtb3ZlQ2xhc3MocGFyZW50c1swXSwgcHNldWRvSGlkZSArICItcGFyZW50Iik7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBhZGRDbGFzcyAoZWwsIGNsYXNzTmFtZSkgewogICAgaWYgKGVsLmNsYXNzTGlzdCkgewogICAgICBlbC5jbGFzc0xpc3QuYWRkKGNsYXNzTmFtZSk7CiAgICB9IGVsc2UgewogICAgICBlbC5jbGFzc05hbWUgPSBlbC5jbGFzc05hbWUgKyAiICIgKyBjbGFzc05hbWU7CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZW1vdmVDbGFzcyAoZWwsIGNsYXNzTmFtZSkgewogICAgaWYgKGVsLmNsYXNzTGlzdCkgewogICAgICBlbC5jbGFzc0xpc3QucmVtb3ZlKGNsYXNzTmFtZSk7CiAgICB9IGVsc2UgewogICAgICBlbC5jbGFzc05hbWUgPSBlbC5jbGFzc05hbWUucmVwbGFjZShjbGFzc05hbWUsICIiKS50cmltKCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBoYXNDbGFzcyAoZWwsIGNsYXNzTmFtZSkgewogICAgcmV0dXJuIGVsLmNsYXNzTmFtZS5pbmRleE9mKGNsYXNzTmFtZSkgPiAtMTsKICB9CgogIC8vIE5vdGUgdGhhdCB0aGlzIGRvZXNuJ3Qgd29yayBpbiA8IElFOCwgYnV0IHdlIGRvbid0IHN1cHBvcnQgdGhhdCBhbnlob3cKICBmdW5jdGlvbiBub2RlTGlzdFRvQXJyYXkgKG5vZGVMaXN0KSB7CiAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwobm9kZUxpc3QpOwogIH0KCiAgZnVuY3Rpb24gZG9jdW1lbnRXaWR0aCAoKSB7CiAgICByZXR1cm4gTWF0aC5tYXgoCiAgICAgIE1hdGgubWF4KGRvYy5ib2R5LnNjcm9sbFdpZHRoLCBkb2MuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFdpZHRoKSwKICAgICAgTWF0aC5tYXgoZG9jLmJvZHkub2Zmc2V0V2lkdGgsIGRvYy5kb2N1bWVudEVsZW1lbnQub2Zmc2V0V2lkdGgpLAogICAgICBNYXRoLm1heChkb2MuYm9keS5jbGllbnRXaWR0aCwgZG9jLmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aCkKICAgICAgKTsKICB9CgogIGZ1bmN0aW9uIGRvY3VtZW50SGVpZ2h0ICgpIHsKICAgIHJldHVybiBNYXRoLm1heCgKICAgICAgTWF0aC5tYXgoZG9jLmJvZHkuc2Nyb2xsSGVpZ2h0LCBkb2MuZG9jdW1lbnRFbGVtZW50LnNjcm9sbEhlaWdodCksCiAgICAgIE1hdGgubWF4KGRvYy5ib2R5Lm9mZnNldEhlaWdodCwgZG9jLmRvY3VtZW50RWxlbWVudC5vZmZzZXRIZWlnaHQpLAogICAgICBNYXRoLm1heChkb2MuYm9keS5jbGllbnRIZWlnaHQsIGRvYy5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0KQogICAgICApOwogIH0KCiAgZnVuY3Rpb24gZ2V0Q1NTSW50KGVsZW1lbnQsIGF0dHJpYnV0ZSkgewogICAgdmFyIHZhbCA9IHBhcnNlSW50KGdldENTUyhlbGVtZW50LCBhdHRyaWJ1dGUpLCAxMCk7CiAgICByZXR1cm4gKGlzTmFOKHZhbCkpID8gMCA6IHZhbDsgLy8gYm9yZGVycyBpbiBvbGQgSUUgYXJlIHRocm93aW5nICdtZWRpdW0nIGZvciBkZW1vLmh0bWwKICB9CgogIGZ1bmN0aW9uIHJlbmRlclJlY3QgKGN0eCwgeCwgeSwgdywgaCwgYmdjb2xvcikgewogICAgaWYgKGJnY29sb3IgIT09ICJ0cmFuc3BhcmVudCIpewogICAgICBjdHguc2V0VmFyaWFibGUoImZpbGxTdHlsZSIsIGJnY29sb3IpOwogICAgICBjdHguZmlsbFJlY3QoeCwgeSwgdywgaCk7CiAgICAgIG51bURyYXdzKz0xOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY2FwaXRhbGl6ZShtLCBwMSwgcDIpIHsKICAgIGlmIChtLmxlbmd0aCA+IDApIHsKICAgICAgcmV0dXJuIHAxICsgcDIudG9VcHBlckNhc2UoKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHRleHRUcmFuc2Zvcm0gKHRleHQsIHRyYW5zZm9ybSkgewogICAgc3dpdGNoKHRyYW5zZm9ybSl7CiAgICAgIGNhc2UgImxvd2VyY2FzZSI6CiAgICAgICAgcmV0dXJuIHRleHQudG9Mb3dlckNhc2UoKTsKICAgICAgY2FzZSAiY2FwaXRhbGl6ZSI6CiAgICAgICAgcmV0dXJuIHRleHQucmVwbGFjZSggLyhefFxzfDp8LXxcKHxcKSkoW2Etel0pL2csIGNhcGl0YWxpemUpOwogICAgICBjYXNlICJ1cHBlcmNhc2UiOgogICAgICAgIHJldHVybiB0ZXh0LnRvVXBwZXJDYXNlKCk7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIHRleHQ7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBub0xldHRlclNwYWNpbmcobGV0dGVyX3NwYWNpbmcpIHsKICAgIHJldHVybiAoL14obm9ybWFsfG5vbmV8MHB4KSQvLnRlc3QobGV0dGVyX3NwYWNpbmcpKTsKICB9CgogIGZ1bmN0aW9uIGRyYXdUZXh0KGN1cnJlbnRUZXh0LCB4LCB5LCBjdHgpewogICAgaWYgKGN1cnJlbnRUZXh0ICE9PSBudWxsICYmIFV0aWwudHJpbVRleHQoY3VycmVudFRleHQpLmxlbmd0aCA+IDApIHsKICAgICAgY3R4LmZpbGxUZXh0KGN1cnJlbnRUZXh0LCB4LCB5KTsKICAgICAgbnVtRHJhd3MrPTE7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBzZXRUZXh0VmFyaWFibGVzKGN0eCwgZWwsIHRleHRfZGVjb3JhdGlvbiwgY29sb3IpIHsKICAgIHZhciBhbGlnbiA9IGZhbHNlLAogICAgYm9sZCA9IGdldENTUyhlbCwgImZvbnRXZWlnaHQiKSwKICAgIGZhbWlseSA9IGdldENTUyhlbCwgImZvbnRGYW1pbHkiKSwKICAgIHNpemUgPSBnZXRDU1MoZWwsICJmb250U2l6ZSIpLAogICAgc2hhZG93cyA9IFV0aWwucGFyc2VUZXh0U2hhZG93cyhnZXRDU1MoZWwsICJ0ZXh0U2hhZG93IikpOwoKICAgIHN3aXRjaChwYXJzZUludChib2xkLCAxMCkpewogICAgICBjYXNlIDQwMToKICAgICAgICBib2xkID0gImJvbGQiOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDQwMDoKICAgICAgICBib2xkID0gIm5vcm1hbCI7CiAgICAgICAgYnJlYWs7CiAgICB9CgogICAgY3R4LnNldFZhcmlhYmxlKCJmaWxsU3R5bGUiLCBjb2xvcik7CiAgICBjdHguc2V0VmFyaWFibGUoImZvbnQiLCBbZ2V0Q1NTKGVsLCAiZm9udFN0eWxlIiksIGdldENTUyhlbCwgImZvbnRWYXJpYW50IiksIGJvbGQsIHNpemUsIGZhbWlseV0uam9pbigiICIpKTsKICAgIGN0eC5zZXRWYXJpYWJsZSgidGV4dEFsaWduIiwgKGFsaWduKSA/ICJyaWdodCIgOiAibGVmdCIpOwoKICAgIGlmIChzaGFkb3dzLmxlbmd0aCkgewogICAgICAvLyBUT0RPOiBzdXBwb3J0IG11bHRpcGxlIHRleHQgc2hhZG93cwogICAgICAvLyBhcHBseSB0aGUgZmlyc3QgdGV4dCBzaGFkb3cKICAgICAgY3R4LnNldFZhcmlhYmxlKCJzaGFkb3dDb2xvciIsIHNoYWRvd3NbMF0uY29sb3IpOwogICAgICBjdHguc2V0VmFyaWFibGUoInNoYWRvd09mZnNldFgiLCBzaGFkb3dzWzBdLm9mZnNldFgpOwogICAgICBjdHguc2V0VmFyaWFibGUoInNoYWRvd09mZnNldFkiLCBzaGFkb3dzWzBdLm9mZnNldFkpOwogICAgICBjdHguc2V0VmFyaWFibGUoInNoYWRvd0JsdXIiLCBzaGFkb3dzWzBdLmJsdXIpOwogICAgfQoKICAgIGlmICh0ZXh0X2RlY29yYXRpb24gIT09ICJub25lIil7CiAgICAgIHJldHVybiBVdGlsLkZvbnQoZmFtaWx5LCBzaXplLCBkb2MpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVuZGVyVGV4dERlY29yYXRpb24oY3R4LCB0ZXh0X2RlY29yYXRpb24sIGJvdW5kcywgbWV0cmljcywgY29sb3IpIHsKICAgIHN3aXRjaCh0ZXh0X2RlY29yYXRpb24pIHsKICAgICAgY2FzZSAidW5kZXJsaW5lIjoKICAgICAgICAvLyBEcmF3cyBhIGxpbmUgYXQgdGhlIGJhc2VsaW5lIG9mIHRoZSBmb250CiAgICAgICAgLy8gVE9ETyBBcyBzb21lIGJyb3dzZXJzIGRpc3BsYXkgdGhlIGxpbmUgYXMgbW9yZSB0aGFuIDFweCBpZiB0aGUgZm9udC1zaXplIGlzIGJpZywgbmVlZCB0byB0YWtlIHRoYXQgaW50byBhY2NvdW50IGJvdGggaW4gcG9zaXRpb24gYW5kIHNpemUKICAgICAgICByZW5kZXJSZWN0KGN0eCwgYm91bmRzLmxlZnQsIE1hdGgucm91bmQoYm91bmRzLnRvcCArIG1ldHJpY3MuYmFzZWxpbmUgKyBtZXRyaWNzLmxpbmVXaWR0aCksIGJvdW5kcy53aWR0aCwgMSwgY29sb3IpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJvdmVybGluZSI6CiAgICAgICAgcmVuZGVyUmVjdChjdHgsIGJvdW5kcy5sZWZ0LCBNYXRoLnJvdW5kKGJvdW5kcy50b3ApLCBib3VuZHMud2lkdGgsIDEsIGNvbG9yKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAibGluZS10aHJvdWdoIjoKICAgICAgICAvLyBUT0RPIHRyeSBhbmQgZmluZCBleGFjdCBwb3NpdGlvbiBmb3IgbGluZS10aHJvdWdoCiAgICAgICAgcmVuZGVyUmVjdChjdHgsIGJvdW5kcy5sZWZ0LCBNYXRoLmNlaWwoYm91bmRzLnRvcCArIG1ldHJpY3MubWlkZGxlICsgbWV0cmljcy5saW5lV2lkdGgpLCBib3VuZHMud2lkdGgsIDEsIGNvbG9yKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGdldFRleHRCb3VuZHMoc3RhdGUsIHRleHQsIHRleHREZWNvcmF0aW9uLCBpc0xhc3QsIHRyYW5zZm9ybSkgewogICAgdmFyIGJvdW5kczsKICAgIGlmIChzdXBwb3J0LnJhbmdlQm91bmRzICYmICF0cmFuc2Zvcm0pIHsKICAgICAgaWYgKHRleHREZWNvcmF0aW9uICE9PSAibm9uZSIgfHwgVXRpbC50cmltVGV4dCh0ZXh0KS5sZW5ndGggIT09IDApIHsKICAgICAgICBib3VuZHMgPSB0ZXh0UmFuZ2VCb3VuZHModGV4dCwgc3RhdGUubm9kZSwgc3RhdGUudGV4dE9mZnNldCk7CiAgICAgIH0KICAgICAgc3RhdGUudGV4dE9mZnNldCArPSB0ZXh0Lmxlbmd0aDsKICAgIH0gZWxzZSBpZiAoc3RhdGUubm9kZSAmJiB0eXBlb2Ygc3RhdGUubm9kZS5ub2RlVmFsdWUgPT09ICJzdHJpbmciICl7CiAgICAgIHZhciBuZXdUZXh0Tm9kZSA9IChpc0xhc3QpID8gc3RhdGUubm9kZS5zcGxpdFRleHQodGV4dC5sZW5ndGgpIDogbnVsbDsKICAgICAgYm91bmRzID0gdGV4dFdyYXBwZXJCb3VuZHMoc3RhdGUubm9kZSwgdHJhbnNmb3JtKTsKICAgICAgc3RhdGUubm9kZSA9IG5ld1RleHROb2RlOwogICAgfQogICAgcmV0dXJuIGJvdW5kczsKICB9CgogIGZ1bmN0aW9uIHRleHRSYW5nZUJvdW5kcyh0ZXh0LCB0ZXh0Tm9kZSwgdGV4dE9mZnNldCkgewogICAgdmFyIHJhbmdlID0gZG9jLmNyZWF0ZVJhbmdlKCk7CiAgICByYW5nZS5zZXRTdGFydCh0ZXh0Tm9kZSwgdGV4dE9mZnNldCk7CiAgICByYW5nZS5zZXRFbmQodGV4dE5vZGUsIHRleHRPZmZzZXQgKyB0ZXh0Lmxlbmd0aCk7CiAgICByZXR1cm4gcmFuZ2UuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgfQoKICBmdW5jdGlvbiB0ZXh0V3JhcHBlckJvdW5kcyhvbGRUZXh0Tm9kZSwgdHJhbnNmb3JtKSB7CiAgICB2YXIgcGFyZW50ID0gb2xkVGV4dE5vZGUucGFyZW50Tm9kZSwKICAgIHdyYXBFbGVtZW50ID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ3dyYXBwZXInKSwKICAgIGJhY2t1cFRleHQgPSBvbGRUZXh0Tm9kZS5jbG9uZU5vZGUodHJ1ZSk7CgogICAgd3JhcEVsZW1lbnQuYXBwZW5kQ2hpbGQob2xkVGV4dE5vZGUuY2xvbmVOb2RlKHRydWUpKTsKICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQod3JhcEVsZW1lbnQsIG9sZFRleHROb2RlKTsKCiAgICB2YXIgYm91bmRzID0gdHJhbnNmb3JtID8gVXRpbC5PZmZzZXRCb3VuZHMod3JhcEVsZW1lbnQpIDogVXRpbC5Cb3VuZHMod3JhcEVsZW1lbnQpOwogICAgcGFyZW50LnJlcGxhY2VDaGlsZChiYWNrdXBUZXh0LCB3cmFwRWxlbWVudCk7CiAgICByZXR1cm4gYm91bmRzOwogIH0KCiAgZnVuY3Rpb24gcmVuZGVyVGV4dChlbCwgdGV4dE5vZGUsIHN0YWNrKSB7CiAgICB2YXIgY3R4ID0gc3RhY2suY3R4LAogICAgY29sb3IgPSBnZXRDU1MoZWwsICJjb2xvciIpLAogICAgdGV4dERlY29yYXRpb24gPSBnZXRDU1MoZWwsICJ0ZXh0RGVjb3JhdGlvbiIpLAogICAgdGV4dEFsaWduID0gZ2V0Q1NTKGVsLCAidGV4dEFsaWduIiksCiAgICBtZXRyaWNzLAogICAgdGV4dExpc3QsCiAgICBzdGF0ZSA9IHsKICAgICAgbm9kZTogdGV4dE5vZGUsCiAgICAgIHRleHRPZmZzZXQ6IDAKICAgIH07CgogICAgaWYgKFV0aWwudHJpbVRleHQodGV4dE5vZGUubm9kZVZhbHVlKS5sZW5ndGggPiAwKSB7CiAgICAgIHRleHROb2RlLm5vZGVWYWx1ZSA9IHRleHRUcmFuc2Zvcm0odGV4dE5vZGUubm9kZVZhbHVlLCBnZXRDU1MoZWwsICJ0ZXh0VHJhbnNmb3JtIikpOwogICAgICB0ZXh0QWxpZ24gPSB0ZXh0QWxpZ24ucmVwbGFjZShbIi13ZWJraXQtYXV0byJdLFsiYXV0byJdKTsKCiAgICAgIHRleHRMaXN0ID0gKCFvcHRpb25zLmxldHRlclJlbmRlcmluZyAmJiAvXihsZWZ0fHJpZ2h0fGp1c3RpZnl8YXV0bykkLy50ZXN0KHRleHRBbGlnbikgJiYgbm9MZXR0ZXJTcGFjaW5nKGdldENTUyhlbCwgImxldHRlclNwYWNpbmciKSkpID8KICAgICAgdGV4dE5vZGUubm9kZVZhbHVlLnNwbGl0KC8oXGJ8ICkvKQogICAgICA6IHRleHROb2RlLm5vZGVWYWx1ZS5zcGxpdCgiIik7CgogICAgICBtZXRyaWNzID0gc2V0VGV4dFZhcmlhYmxlcyhjdHgsIGVsLCB0ZXh0RGVjb3JhdGlvbiwgY29sb3IpOwoKICAgICAgaWYgKG9wdGlvbnMuY2hpbmVzZSkgewogICAgICAgIHRleHRMaXN0LmZvckVhY2goZnVuY3Rpb24od29yZCwgaW5kZXgpIHsKICAgICAgICAgIGlmICgvLipbXHU0RTAwLVx1OUZBNV0uKiQvLnRlc3Qod29yZCkpIHsKICAgICAgICAgICAgd29yZCA9IHdvcmQuc3BsaXQoIiIpOwogICAgICAgICAgICB3b3JkLnVuc2hpZnQoaW5kZXgsIDEpOwogICAgICAgICAgICB0ZXh0TGlzdC5zcGxpY2UuYXBwbHkodGV4dExpc3QsIHdvcmQpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICB0ZXh0TGlzdC5mb3JFYWNoKGZ1bmN0aW9uKHRleHQsIGluZGV4KSB7CiAgICAgICAgdmFyIGJvdW5kcyA9IGdldFRleHRCb3VuZHMoc3RhdGUsIHRleHQsIHRleHREZWNvcmF0aW9uLCAoaW5kZXggPCB0ZXh0TGlzdC5sZW5ndGggLSAxKSwgc3RhY2sudHJhbnNmb3JtLm1hdHJpeCk7CiAgICAgICAgaWYgKGJvdW5kcykgewogICAgICAgICAgZHJhd1RleHQodGV4dCwgYm91bmRzLmxlZnQsIGJvdW5kcy5ib3R0b20sIGN0eCk7CiAgICAgICAgICByZW5kZXJUZXh0RGVjb3JhdGlvbihjdHgsIHRleHREZWNvcmF0aW9uLCBib3VuZHMsIG1ldHJpY3MsIGNvbG9yKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KCiAgZnVuY3Rpb24gbGlzdFBvc2l0aW9uIChlbGVtZW50LCB2YWwpIHsKICAgIHZhciBib3VuZEVsZW1lbnQgPSBkb2MuY3JlYXRlRWxlbWVudCggImJvdW5kZWxlbWVudCIgKSwKICAgIG9yaWdpbmFsVHlwZSwKICAgIGJvdW5kczsKCiAgICBib3VuZEVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICJpbmxpbmUiOwoKICAgIG9yaWdpbmFsVHlwZSA9IGVsZW1lbnQuc3R5bGUubGlzdFN0eWxlVHlwZTsKICAgIGVsZW1lbnQuc3R5bGUubGlzdFN0eWxlVHlwZSA9ICJub25lIjsKCiAgICBib3VuZEVsZW1lbnQuYXBwZW5kQ2hpbGQoZG9jLmNyZWF0ZVRleHROb2RlKHZhbCkpOwoKICAgIGVsZW1lbnQuaW5zZXJ0QmVmb3JlKGJvdW5kRWxlbWVudCwgZWxlbWVudC5maXJzdENoaWxkKTsKCiAgICBib3VuZHMgPSBVdGlsLkJvdW5kcyhib3VuZEVsZW1lbnQpOwogICAgZWxlbWVudC5yZW1vdmVDaGlsZChib3VuZEVsZW1lbnQpOwogICAgZWxlbWVudC5zdHlsZS5saXN0U3R5bGVUeXBlID0gb3JpZ2luYWxUeXBlOwogICAgcmV0dXJuIGJvdW5kczsKICB9CgogIGZ1bmN0aW9uIGVsZW1lbnRJbmRleChlbCkgewogICAgdmFyIGkgPSAtMSwKICAgIGNvdW50ID0gMSwKICAgIGNoaWxkcyA9IGVsLnBhcmVudE5vZGUuY2hpbGROb2RlczsKCiAgICBpZiAoZWwucGFyZW50Tm9kZSkgewogICAgICB3aGlsZShjaGlsZHNbKytpXSAhPT0gZWwpIHsKICAgICAgICBpZiAoY2hpbGRzW2ldLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICBjb3VudCsrOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gY291bnQ7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gLTE7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBsaXN0SXRlbVRleHQoZWxlbWVudCwgdHlwZSkgewogICAgdmFyIGN1cnJlbnRJbmRleCA9IGVsZW1lbnRJbmRleChlbGVtZW50KSwgdGV4dDsKICAgIHN3aXRjaCh0eXBlKXsKICAgICAgY2FzZSAiZGVjaW1hbCI6CiAgICAgICAgdGV4dCA9IGN1cnJlbnRJbmRleDsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiZGVjaW1hbC1sZWFkaW5nLXplcm8iOgogICAgICAgIHRleHQgPSAoY3VycmVudEluZGV4LnRvU3RyaW5nKCkubGVuZ3RoID09PSAxKSA/IGN1cnJlbnRJbmRleCA9ICIwIiArIGN1cnJlbnRJbmRleC50b1N0cmluZygpIDogY3VycmVudEluZGV4LnRvU3RyaW5nKCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgInVwcGVyLXJvbWFuIjoKICAgICAgICB0ZXh0ID0gX2h0bWwyY2FudmFzLkdlbmVyYXRlLkxpc3RSb21hbiggY3VycmVudEluZGV4ICk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgImxvd2VyLXJvbWFuIjoKICAgICAgICB0ZXh0ID0gX2h0bWwyY2FudmFzLkdlbmVyYXRlLkxpc3RSb21hbiggY3VycmVudEluZGV4ICkudG9Mb3dlckNhc2UoKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAibG93ZXItYWxwaGEiOgogICAgICAgIHRleHQgPSBfaHRtbDJjYW52YXMuR2VuZXJhdGUuTGlzdEFscGhhKCBjdXJyZW50SW5kZXggKS50b0xvd2VyQ2FzZSgpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJ1cHBlci1hbHBoYSI6CiAgICAgICAgdGV4dCA9IF9odG1sMmNhbnZhcy5HZW5lcmF0ZS5MaXN0QWxwaGEoIGN1cnJlbnRJbmRleCApOwogICAgICAgIGJyZWFrOwogICAgfQoKICAgIHJldHVybiB0ZXh0ICsgIi4gIjsKICB9CgogIGZ1bmN0aW9uIHJlbmRlckxpc3RJdGVtKGVsZW1lbnQsIHN0YWNrLCBlbEJvdW5kcykgewogICAgdmFyIHgsCiAgICB0ZXh0LAogICAgY3R4ID0gc3RhY2suY3R4LAogICAgdHlwZSA9IGdldENTUyhlbGVtZW50LCAibGlzdFN0eWxlVHlwZSIpLAogICAgbGlzdEJvdW5kczsKCiAgICBpZiAoL14oZGVjaW1hbHxkZWNpbWFsLWxlYWRpbmctemVyb3x1cHBlci1hbHBoYXx1cHBlci1sYXRpbnx1cHBlci1yb21hbnxsb3dlci1hbHBoYXxsb3dlci1ncmVla3xsb3dlci1sYXRpbnxsb3dlci1yb21hbikkL2kudGVzdCh0eXBlKSkgewogICAgICB0ZXh0ID0gbGlzdEl0ZW1UZXh0KGVsZW1lbnQsIHR5cGUpOwogICAgICBsaXN0Qm91bmRzID0gbGlzdFBvc2l0aW9uKGVsZW1lbnQsIHRleHQpOwogICAgICBzZXRUZXh0VmFyaWFibGVzKGN0eCwgZWxlbWVudCwgIm5vbmUiLCBnZXRDU1MoZWxlbWVudCwgImNvbG9yIikpOwoKICAgICAgaWYgKGdldENTUyhlbGVtZW50LCAibGlzdFN0eWxlUG9zaXRpb24iKSA9PT0gImluc2lkZSIpIHsKICAgICAgICBjdHguc2V0VmFyaWFibGUoInRleHRBbGlnbiIsICJsZWZ0Iik7CiAgICAgICAgeCA9IGVsQm91bmRzLmxlZnQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBkcmF3VGV4dCh0ZXh0LCB4LCBsaXN0Qm91bmRzLmJvdHRvbSwgY3R4KTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGxvYWRJbWFnZSAoc3JjKXsKICAgIHZhciBpbWcgPSBpbWFnZXNbc3JjXTsKICAgIHJldHVybiAoaW1nICYmIGltZy5zdWNjZWVkZWQgPT09IHRydWUpID8gaW1nLmltZyA6IGZhbHNlOwogIH0KCiAgZnVuY3Rpb24gY2xpcEJvdW5kcyhzcmMsIGRzdCl7CiAgICB2YXIgeCA9IE1hdGgubWF4KHNyYy5sZWZ0LCBkc3QubGVmdCksCiAgICB5ID0gTWF0aC5tYXgoc3JjLnRvcCwgZHN0LnRvcCksCiAgICB4MiA9IE1hdGgubWluKChzcmMubGVmdCArIHNyYy53aWR0aCksIChkc3QubGVmdCArIGRzdC53aWR0aCkpLAogICAgeTIgPSBNYXRoLm1pbigoc3JjLnRvcCArIHNyYy5oZWlnaHQpLCAoZHN0LnRvcCArIGRzdC5oZWlnaHQpKTsKCiAgICByZXR1cm4gewogICAgICBsZWZ0OngsCiAgICAgIHRvcDp5LAogICAgICB3aWR0aDp4Mi14LAogICAgICBoZWlnaHQ6eTIteQogICAgfTsKICB9CgogIGZ1bmN0aW9uIHNldFooZWxlbWVudCwgc3RhY2ssIHBhcmVudFN0YWNrKXsKICAgIHZhciBuZXdDb250ZXh0LAogICAgaXNQb3NpdGlvbmVkID0gc3RhY2suY3NzUG9zaXRpb24gIT09ICdzdGF0aWMnLAogICAgekluZGV4ID0gaXNQb3NpdGlvbmVkID8gZ2V0Q1NTKGVsZW1lbnQsICd6SW5kZXgnKSA6ICdhdXRvJywKICAgIG9wYWNpdHkgPSBnZXRDU1MoZWxlbWVudCwgJ29wYWNpdHknKSwKICAgIGlzRmxvYXRlZCA9IGdldENTUyhlbGVtZW50LCAnY3NzRmxvYXQnKSAhPT0gJ25vbmUnOwoKICAgIC8vIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0d1aWRlL0NTUy9VbmRlcnN0YW5kaW5nX3pfaW5kZXgvVGhlX3N0YWNraW5nX2NvbnRleHQKICAgIC8vIFdoZW4gYSBuZXcgc3RhY2tpbmcgY29udGV4dCBzaG91bGQgYmUgY3JlYXRlZDoKICAgIC8vIHRoZSByb290IGVsZW1lbnQgKEhUTUwpLAogICAgLy8gcG9zaXRpb25lZCAoYWJzb2x1dGVseSBvciByZWxhdGl2ZWx5KSB3aXRoIGEgei1pbmRleCB2YWx1ZSBvdGhlciB0aGFuICJhdXRvIiwKICAgIC8vIGVsZW1lbnRzIHdpdGggYW4gb3BhY2l0eSB2YWx1ZSBsZXNzIHRoYW4gMS4gKFNlZSB0aGUgc3BlY2lmaWNhdGlvbiBmb3Igb3BhY2l0eSksCiAgICAvLyBvbiBtb2JpbGUgV2ViS2l0IGFuZCBDaHJvbWUgMjIrLCBwb3NpdGlvbjogZml4ZWQgYWx3YXlzIGNyZWF0ZXMgYSBuZXcgc3RhY2tpbmcgY29udGV4dCwgZXZlbiB3aGVuIHotaW5kZXggaXMgImF1dG8iIChTZWUgdGhpcyBwb3N0KQoKICAgIHN0YWNrLnpJbmRleCA9IG5ld0NvbnRleHQgPSBoMmN6Q29udGV4dCh6SW5kZXgpOwogICAgbmV3Q29udGV4dC5pc1Bvc2l0aW9uZWQgPSBpc1Bvc2l0aW9uZWQ7CiAgICBuZXdDb250ZXh0LmlzRmxvYXRlZCA9IGlzRmxvYXRlZDsKICAgIG5ld0NvbnRleHQub3BhY2l0eSA9IG9wYWNpdHk7CiAgICBuZXdDb250ZXh0Lm93blN0YWNraW5nID0gKHpJbmRleCAhPT0gJ2F1dG8nIHx8IG9wYWNpdHkgPCAxKTsKICAgIG5ld0NvbnRleHQuZGVwdGggPSBwYXJlbnRTdGFjayA/IChwYXJlbnRTdGFjay56SW5kZXguZGVwdGggKyAxKSA6IDA7CgogICAgaWYgKHBhcmVudFN0YWNrKSB7CiAgICAgIHBhcmVudFN0YWNrLnpJbmRleC5jaGlsZHJlbi5wdXNoKHN0YWNrKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGgyY3pDb250ZXh0KHppbmRleCkgewogICAgcmV0dXJuIHsKICAgICAgZGVwdGg6IDAsCiAgICAgIHppbmRleDogemluZGV4LAogICAgICBjaGlsZHJlbjogW10KICAgIH07CiAgfQoKICBmdW5jdGlvbiByZW5kZXJJbWFnZShjdHgsIGVsZW1lbnQsIGltYWdlLCBib3VuZHMsIGJvcmRlcnMpIHsKCiAgICB2YXIgcGFkZGluZ0xlZnQgPSBnZXRDU1NJbnQoZWxlbWVudCwgJ3BhZGRpbmdMZWZ0JyksCiAgICBwYWRkaW5nVG9wID0gZ2V0Q1NTSW50KGVsZW1lbnQsICdwYWRkaW5nVG9wJyksCiAgICBwYWRkaW5nUmlnaHQgPSBnZXRDU1NJbnQoZWxlbWVudCwgJ3BhZGRpbmdSaWdodCcpLAogICAgcGFkZGluZ0JvdHRvbSA9IGdldENTU0ludChlbGVtZW50LCAncGFkZGluZ0JvdHRvbScpOwoKICAgIGRyYXdJbWFnZSgKICAgICAgY3R4LAogICAgICBpbWFnZSwKICAgICAgMCwgLy9zeAogICAgICAwLCAvL3N5CiAgICAgIGltYWdlLndpZHRoLCAvL3N3CiAgICAgIGltYWdlLmhlaWdodCwgLy9zaAogICAgICBib3VuZHMubGVmdCArIHBhZGRpbmdMZWZ0ICsgYm9yZGVyc1szXS53aWR0aCwgLy9keAogICAgICBib3VuZHMudG9wICsgcGFkZGluZ1RvcCArIGJvcmRlcnNbMF0ud2lkdGgsIC8vIGR5CiAgICAgIGJvdW5kcy53aWR0aCAtIChib3JkZXJzWzFdLndpZHRoICsgYm9yZGVyc1szXS53aWR0aCArIHBhZGRpbmdMZWZ0ICsgcGFkZGluZ1JpZ2h0KSwgLy9kdwogICAgICBib3VuZHMuaGVpZ2h0IC0gKGJvcmRlcnNbMF0ud2lkdGggKyBib3JkZXJzWzJdLndpZHRoICsgcGFkZGluZ1RvcCArIHBhZGRpbmdCb3R0b20pIC8vZGgKICAgICAgKTsKICB9CgogIGZ1bmN0aW9uIGdldEJvcmRlckRhdGEoZWxlbWVudCkgewogICAgcmV0dXJuIFsiVG9wIiwgIlJpZ2h0IiwgIkJvdHRvbSIsICJMZWZ0Il0ubWFwKGZ1bmN0aW9uKHNpZGUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB3aWR0aDogZ2V0Q1NTSW50KGVsZW1lbnQsICdib3JkZXInICsgc2lkZSArICdXaWR0aCcpLAogICAgICAgIGNvbG9yOiBnZXRDU1MoZWxlbWVudCwgJ2JvcmRlcicgKyBzaWRlICsgJ0NvbG9yJykKICAgICAgfTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gZ2V0Qm9yZGVyUmFkaXVzRGF0YShlbGVtZW50KSB7CiAgICByZXR1cm4gWyJUb3BMZWZ0IiwgIlRvcFJpZ2h0IiwgIkJvdHRvbVJpZ2h0IiwgIkJvdHRvbUxlZnQiXS5tYXAoZnVuY3Rpb24oc2lkZSkgewogICAgICByZXR1cm4gZ2V0Q1NTKGVsZW1lbnQsICdib3JkZXInICsgc2lkZSArICdSYWRpdXMnKTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gZ2V0Q3VydmVQb2ludHMoeCwgeSwgcjEsIHIyKSB7CiAgICB2YXIga2FwcGEgPSA0ICogKChNYXRoLnNxcnQoMikgLSAxKSAvIDMpOwogICAgdmFyIG94ID0gKHIxKSAqIGthcHBhLCAvLyBjb250cm9sIHBvaW50IG9mZnNldCBob3Jpem9udGFsCiAgICBveSA9IChyMikgKiBrYXBwYSwgLy8gY29udHJvbCBwb2ludCBvZmZzZXQgdmVydGljYWwKICAgIHhtID0geCArIHIxLCAvLyB4LW1pZGRsZQogICAgeW0gPSB5ICsgcjI7IC8vIHktbWlkZGxlCiAgICByZXR1cm4gewogICAgICB0b3BMZWZ0OiBiZXppZXJDdXJ2ZSh7CiAgICAgICAgeDp4LAogICAgICAgIHk6eW0KICAgICAgfSwgewogICAgICAgIHg6eCwKICAgICAgICB5OnltIC0gb3kKICAgICAgfSwgewogICAgICAgIHg6eG0gLSBveCwKICAgICAgICB5OnkKICAgICAgfSwgewogICAgICAgIHg6eG0sCiAgICAgICAgeTp5CiAgICAgIH0pLAogICAgICB0b3BSaWdodDogYmV6aWVyQ3VydmUoewogICAgICAgIHg6eCwKICAgICAgICB5OnkKICAgICAgfSwgewogICAgICAgIHg6eCArIG94LAogICAgICAgIHk6eQogICAgICB9LCB7CiAgICAgICAgeDp4bSwKICAgICAgICB5OnltIC0gb3kKICAgICAgfSwgewogICAgICAgIHg6eG0sCiAgICAgICAgeTp5bQogICAgICB9KSwKICAgICAgYm90dG9tUmlnaHQ6IGJlemllckN1cnZlKHsKICAgICAgICB4OnhtLAogICAgICAgIHk6eQogICAgICB9LCB7CiAgICAgICAgeDp4bSwKICAgICAgICB5OnkgKyBveQogICAgICB9LCB7CiAgICAgICAgeDp4ICsgb3gsCiAgICAgICAgeTp5bQogICAgICB9LCB7CiAgICAgICAgeDp4LAogICAgICAgIHk6eW0KICAgICAgfSksCiAgICAgIGJvdHRvbUxlZnQ6IGJlemllckN1cnZlKHsKICAgICAgICB4OnhtLAogICAgICAgIHk6eW0KICAgICAgfSwgewogICAgICAgIHg6eG0gLSBveCwKICAgICAgICB5OnltCiAgICAgIH0sIHsKICAgICAgICB4OngsCiAgICAgICAgeTp5ICsgb3kKICAgICAgfSwgewogICAgICAgIHg6eCwKICAgICAgICB5OnkKICAgICAgfSkKICAgIH07CiAgfQoKICBmdW5jdGlvbiBiZXppZXJDdXJ2ZShzdGFydCwgc3RhcnRDb250cm9sLCBlbmRDb250cm9sLCBlbmQpIHsKCiAgICB2YXIgbGVycCA9IGZ1bmN0aW9uIChhLCBiLCB0KSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgeDphLnggKyAoYi54IC0gYS54KSAqIHQsCiAgICAgICAgeTphLnkgKyAoYi55IC0gYS55KSAqIHQKICAgICAgfTsKICAgIH07CgogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IHN0YXJ0LAogICAgICBzdGFydENvbnRyb2w6IHN0YXJ0Q29udHJvbCwKICAgICAgZW5kQ29udHJvbDogZW5kQ29udHJvbCwKICAgICAgZW5kOiBlbmQsCiAgICAgIHN1YmRpdmlkZTogZnVuY3Rpb24odCkgewogICAgICAgIHZhciBhYiA9IGxlcnAoc3RhcnQsIHN0YXJ0Q29udHJvbCwgdCksCiAgICAgICAgYmMgPSBsZXJwKHN0YXJ0Q29udHJvbCwgZW5kQ29udHJvbCwgdCksCiAgICAgICAgY2QgPSBsZXJwKGVuZENvbnRyb2wsIGVuZCwgdCksCiAgICAgICAgYWJiYyA9IGxlcnAoYWIsIGJjLCB0KSwKICAgICAgICBiY2NkID0gbGVycChiYywgY2QsIHQpLAogICAgICAgIGRlc3QgPSBsZXJwKGFiYmMsIGJjY2QsIHQpOwogICAgICAgIHJldHVybiBbYmV6aWVyQ3VydmUoc3RhcnQsIGFiLCBhYmJjLCBkZXN0KSwgYmV6aWVyQ3VydmUoZGVzdCwgYmNjZCwgY2QsIGVuZCldOwogICAgICB9LAogICAgICBjdXJ2ZVRvOiBmdW5jdGlvbihib3JkZXJBcmdzKSB7CiAgICAgICAgYm9yZGVyQXJncy5wdXNoKFsiYmV6aWVyQ3VydmUiLCBzdGFydENvbnRyb2wueCwgc3RhcnRDb250cm9sLnksIGVuZENvbnRyb2wueCwgZW5kQ29udHJvbC55LCBlbmQueCwgZW5kLnldKTsKICAgICAgfSwKICAgICAgY3VydmVUb1JldmVyc2VkOiBmdW5jdGlvbihib3JkZXJBcmdzKSB7CiAgICAgICAgYm9yZGVyQXJncy5wdXNoKFsiYmV6aWVyQ3VydmUiLCBlbmRDb250cm9sLngsIGVuZENvbnRyb2wueSwgc3RhcnRDb250cm9sLngsIHN0YXJ0Q29udHJvbC55LCBzdGFydC54LCBzdGFydC55XSk7CiAgICAgIH0KICAgIH07CiAgfQoKICBmdW5jdGlvbiBwYXJzZUNvcm5lcihib3JkZXJBcmdzLCByYWRpdXMxLCByYWRpdXMyLCBjb3JuZXIxLCBjb3JuZXIyLCB4LCB5KSB7CiAgICBpZiAocmFkaXVzMVswXSA+IDAgfHwgcmFkaXVzMVsxXSA+IDApIHsKICAgICAgYm9yZGVyQXJncy5wdXNoKFsibGluZSIsIGNvcm5lcjFbMF0uc3RhcnQueCwgY29ybmVyMVswXS5zdGFydC55XSk7CiAgICAgIGNvcm5lcjFbMF0uY3VydmVUbyhib3JkZXJBcmdzKTsKICAgICAgY29ybmVyMVsxXS5jdXJ2ZVRvKGJvcmRlckFyZ3MpOwogICAgfSBlbHNlIHsKICAgICAgYm9yZGVyQXJncy5wdXNoKFsibGluZSIsIHgsIHldKTsKICAgIH0KCiAgICBpZiAocmFkaXVzMlswXSA+IDAgfHwgcmFkaXVzMlsxXSA+IDApIHsKICAgICAgYm9yZGVyQXJncy5wdXNoKFsibGluZSIsIGNvcm5lcjJbMF0uc3RhcnQueCwgY29ybmVyMlswXS5zdGFydC55XSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBkcmF3U2lkZShib3JkZXJEYXRhLCByYWRpdXMxLCByYWRpdXMyLCBvdXRlcjEsIGlubmVyMSwgb3V0ZXIyLCBpbm5lcjIpIHsKICAgIHZhciBib3JkZXJBcmdzID0gW107CgogICAgaWYgKHJhZGl1czFbMF0gPiAwIHx8IHJhZGl1czFbMV0gPiAwKSB7CiAgICAgIGJvcmRlckFyZ3MucHVzaChbImxpbmUiLCBvdXRlcjFbMV0uc3RhcnQueCwgb3V0ZXIxWzFdLnN0YXJ0LnldKTsKICAgICAgb3V0ZXIxWzFdLmN1cnZlVG8oYm9yZGVyQXJncyk7CiAgICB9IGVsc2UgewogICAgICBib3JkZXJBcmdzLnB1c2goWyAibGluZSIsIGJvcmRlckRhdGEuYzFbMF0sIGJvcmRlckRhdGEuYzFbMV1dKTsKICAgIH0KCiAgICBpZiAocmFkaXVzMlswXSA+IDAgfHwgcmFkaXVzMlsxXSA+IDApIHsKICAgICAgYm9yZGVyQXJncy5wdXNoKFsibGluZSIsIG91dGVyMlswXS5zdGFydC54LCBvdXRlcjJbMF0uc3RhcnQueV0pOwogICAgICBvdXRlcjJbMF0uY3VydmVUbyhib3JkZXJBcmdzKTsKICAgICAgYm9yZGVyQXJncy5wdXNoKFsibGluZSIsIGlubmVyMlswXS5lbmQueCwgaW5uZXIyWzBdLmVuZC55XSk7CiAgICAgIGlubmVyMlswXS5jdXJ2ZVRvUmV2ZXJzZWQoYm9yZGVyQXJncyk7CiAgICB9IGVsc2UgewogICAgICBib3JkZXJBcmdzLnB1c2goWyAibGluZSIsIGJvcmRlckRhdGEuYzJbMF0sIGJvcmRlckRhdGEuYzJbMV1dKTsKICAgICAgYm9yZGVyQXJncy5wdXNoKFsgImxpbmUiLCBib3JkZXJEYXRhLmMzWzBdLCBib3JkZXJEYXRhLmMzWzFdXSk7CiAgICB9CgogICAgaWYgKHJhZGl1czFbMF0gPiAwIHx8IHJhZGl1czFbMV0gPiAwKSB7CiAgICAgIGJvcmRlckFyZ3MucHVzaChbImxpbmUiLCBpbm5lcjFbMV0uZW5kLngsIGlubmVyMVsxXS5lbmQueV0pOwogICAgICBpbm5lcjFbMV0uY3VydmVUb1JldmVyc2VkKGJvcmRlckFyZ3MpOwogICAgfSBlbHNlIHsKICAgICAgYm9yZGVyQXJncy5wdXNoKFsgImxpbmUiLCBib3JkZXJEYXRhLmM0WzBdLCBib3JkZXJEYXRhLmM0WzFdXSk7CiAgICB9CgogICAgcmV0dXJuIGJvcmRlckFyZ3M7CiAgfQoKICBmdW5jdGlvbiBjYWxjdWxhdGVDdXJ2ZVBvaW50cyhib3VuZHMsIGJvcmRlclJhZGl1cywgYm9yZGVycykgewoKICAgIHZhciB4ID0gYm91bmRzLmxlZnQsCiAgICB5ID0gYm91bmRzLnRvcCwKICAgIHdpZHRoID0gYm91bmRzLndpZHRoLAogICAgaGVpZ2h0ID0gYm91bmRzLmhlaWdodCwKCiAgICB0bGggPSBib3JkZXJSYWRpdXNbMF1bMF0sCiAgICB0bHYgPSBib3JkZXJSYWRpdXNbMF1bMV0sCiAgICB0cmggPSBib3JkZXJSYWRpdXNbMV1bMF0sCiAgICB0cnYgPSBib3JkZXJSYWRpdXNbMV1bMV0sCiAgICBicmggPSBib3JkZXJSYWRpdXNbMl1bMF0sCiAgICBicnYgPSBib3JkZXJSYWRpdXNbMl1bMV0sCiAgICBibGggPSBib3JkZXJSYWRpdXNbM11bMF0sCiAgICBibHYgPSBib3JkZXJSYWRpdXNbM11bMV0sCgogICAgdG9wV2lkdGggPSB3aWR0aCAtIHRyaCwKICAgIHJpZ2h0SGVpZ2h0ID0gaGVpZ2h0IC0gYnJ2LAogICAgYm90dG9tV2lkdGggPSB3aWR0aCAtIGJyaCwKICAgIGxlZnRIZWlnaHQgPSBoZWlnaHQgLSBibHY7CgogICAgcmV0dXJuIHsKICAgICAgdG9wTGVmdE91dGVyOiBnZXRDdXJ2ZVBvaW50cygKICAgICAgICB4LAogICAgICAgIHksCiAgICAgICAgdGxoLAogICAgICAgIHRsdgogICAgICAgICkudG9wTGVmdC5zdWJkaXZpZGUoMC41KSwKCiAgICAgIHRvcExlZnRJbm5lcjogZ2V0Q3VydmVQb2ludHMoCiAgICAgICAgeCArIGJvcmRlcnNbM10ud2lkdGgsCiAgICAgICAgeSArIGJvcmRlcnNbMF0ud2lkdGgsCiAgICAgICAgTWF0aC5tYXgoMCwgdGxoIC0gYm9yZGVyc1szXS53aWR0aCksCiAgICAgICAgTWF0aC5tYXgoMCwgdGx2IC0gYm9yZGVyc1swXS53aWR0aCkKICAgICAgICApLnRvcExlZnQuc3ViZGl2aWRlKDAuNSksCgogICAgICB0b3BSaWdodE91dGVyOiBnZXRDdXJ2ZVBvaW50cygKICAgICAgICB4ICsgdG9wV2lkdGgsCiAgICAgICAgeSwKICAgICAgICB0cmgsCiAgICAgICAgdHJ2CiAgICAgICAgKS50b3BSaWdodC5zdWJkaXZpZGUoMC41KSwKCiAgICAgIHRvcFJpZ2h0SW5uZXI6IGdldEN1cnZlUG9pbnRzKAogICAgICAgIHggKyBNYXRoLm1pbih0b3BXaWR0aCwgd2lkdGggKyBib3JkZXJzWzNdLndpZHRoKSwKICAgICAgICB5ICsgYm9yZGVyc1swXS53aWR0aCwKICAgICAgICAodG9wV2lkdGggPiB3aWR0aCArIGJvcmRlcnNbM10ud2lkdGgpID8gMCA6dHJoIC0gYm9yZGVyc1szXS53aWR0aCwKICAgICAgICB0cnYgLSBib3JkZXJzWzBdLndpZHRoCiAgICAgICAgKS50b3BSaWdodC5zdWJkaXZpZGUoMC41KSwKCiAgICAgIGJvdHRvbVJpZ2h0T3V0ZXI6IGdldEN1cnZlUG9pbnRzKAogICAgICAgIHggKyBib3R0b21XaWR0aCwKICAgICAgICB5ICsgcmlnaHRIZWlnaHQsCiAgICAgICAgYnJoLAogICAgICAgIGJydgogICAgICAgICkuYm90dG9tUmlnaHQuc3ViZGl2aWRlKDAuNSksCgogICAgICBib3R0b21SaWdodElubmVyOiBnZXRDdXJ2ZVBvaW50cygKICAgICAgICB4ICsgTWF0aC5taW4oYm90dG9tV2lkdGgsIHdpZHRoICsgYm9yZGVyc1szXS53aWR0aCksCiAgICAgICAgeSArIE1hdGgubWluKHJpZ2h0SGVpZ2h0LCBoZWlnaHQgKyBib3JkZXJzWzBdLndpZHRoKSwKICAgICAgICBNYXRoLm1heCgwLCBicmggLSBib3JkZXJzWzFdLndpZHRoKSwKICAgICAgICBNYXRoLm1heCgwLCBicnYgLSBib3JkZXJzWzJdLndpZHRoKQogICAgICAgICkuYm90dG9tUmlnaHQuc3ViZGl2aWRlKDAuNSksCgogICAgICBib3R0b21MZWZ0T3V0ZXI6IGdldEN1cnZlUG9pbnRzKAogICAgICAgIHgsCiAgICAgICAgeSArIGxlZnRIZWlnaHQsCiAgICAgICAgYmxoLAogICAgICAgIGJsdgogICAgICAgICkuYm90dG9tTGVmdC5zdWJkaXZpZGUoMC41KSwKCiAgICAgIGJvdHRvbUxlZnRJbm5lcjogZ2V0Q3VydmVQb2ludHMoCiAgICAgICAgeCArIGJvcmRlcnNbM10ud2lkdGgsCiAgICAgICAgeSArIGxlZnRIZWlnaHQsCiAgICAgICAgTWF0aC5tYXgoMCwgYmxoIC0gYm9yZGVyc1szXS53aWR0aCksCiAgICAgICAgTWF0aC5tYXgoMCwgYmx2IC0gYm9yZGVyc1syXS53aWR0aCkKICAgICAgICApLmJvdHRvbUxlZnQuc3ViZGl2aWRlKDAuNSkKICAgIH07CiAgfQoKICBmdW5jdGlvbiBnZXRCb3JkZXJDbGlwKGVsZW1lbnQsIGJvcmRlclBvaW50cywgYm9yZGVycywgcmFkaXVzLCBib3VuZHMpIHsKICAgIHZhciBiYWNrZ3JvdW5kQ2xpcCA9IGdldENTUyhlbGVtZW50LCAnYmFja2dyb3VuZENsaXAnKSwKICAgIGJvcmRlckFyZ3MgPSBbXTsKCiAgICBzd2l0Y2goYmFja2dyb3VuZENsaXApIHsKICAgICAgY2FzZSAiY29udGVudC1ib3giOgogICAgICBjYXNlICJwYWRkaW5nLWJveCI6CiAgICAgICAgcGFyc2VDb3JuZXIoYm9yZGVyQXJncywgcmFkaXVzWzBdLCByYWRpdXNbMV0sIGJvcmRlclBvaW50cy50b3BMZWZ0SW5uZXIsIGJvcmRlclBvaW50cy50b3BSaWdodElubmVyLCBib3VuZHMubGVmdCArIGJvcmRlcnNbM10ud2lkdGgsIGJvdW5kcy50b3AgKyBib3JkZXJzWzBdLndpZHRoKTsKICAgICAgICBwYXJzZUNvcm5lcihib3JkZXJBcmdzLCByYWRpdXNbMV0sIHJhZGl1c1syXSwgYm9yZGVyUG9pbnRzLnRvcFJpZ2h0SW5uZXIsIGJvcmRlclBvaW50cy5ib3R0b21SaWdodElubmVyLCBib3VuZHMubGVmdCArIGJvdW5kcy53aWR0aCAtIGJvcmRlcnNbMV0ud2lkdGgsIGJvdW5kcy50b3AgKyBib3JkZXJzWzBdLndpZHRoKTsKICAgICAgICBwYXJzZUNvcm5lcihib3JkZXJBcmdzLCByYWRpdXNbMl0sIHJhZGl1c1szXSwgYm9yZGVyUG9pbnRzLmJvdHRvbVJpZ2h0SW5uZXIsIGJvcmRlclBvaW50cy5ib3R0b21MZWZ0SW5uZXIsIGJvdW5kcy5sZWZ0ICsgYm91bmRzLndpZHRoIC0gYm9yZGVyc1sxXS53aWR0aCwgYm91bmRzLnRvcCArIGJvdW5kcy5oZWlnaHQgLSBib3JkZXJzWzJdLndpZHRoKTsKICAgICAgICBwYXJzZUNvcm5lcihib3JkZXJBcmdzLCByYWRpdXNbM10sIHJhZGl1c1swXSwgYm9yZGVyUG9pbnRzLmJvdHRvbUxlZnRJbm5lciwgYm9yZGVyUG9pbnRzLnRvcExlZnRJbm5lciwgYm91bmRzLmxlZnQgKyBib3JkZXJzWzNdLndpZHRoLCBib3VuZHMudG9wICsgYm91bmRzLmhlaWdodCAtIGJvcmRlcnNbMl0ud2lkdGgpOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICBwYXJzZUNvcm5lcihib3JkZXJBcmdzLCByYWRpdXNbMF0sIHJhZGl1c1sxXSwgYm9yZGVyUG9pbnRzLnRvcExlZnRPdXRlciwgYm9yZGVyUG9pbnRzLnRvcFJpZ2h0T3V0ZXIsIGJvdW5kcy5sZWZ0LCBib3VuZHMudG9wKTsKICAgICAgICBwYXJzZUNvcm5lcihib3JkZXJBcmdzLCByYWRpdXNbMV0sIHJhZGl1c1syXSwgYm9yZGVyUG9pbnRzLnRvcFJpZ2h0T3V0ZXIsIGJvcmRlclBvaW50cy5ib3R0b21SaWdodE91dGVyLCBib3VuZHMubGVmdCArIGJvdW5kcy53aWR0aCwgYm91bmRzLnRvcCk7CiAgICAgICAgcGFyc2VDb3JuZXIoYm9yZGVyQXJncywgcmFkaXVzWzJdLCByYWRpdXNbM10sIGJvcmRlclBvaW50cy5ib3R0b21SaWdodE91dGVyLCBib3JkZXJQb2ludHMuYm90dG9tTGVmdE91dGVyLCBib3VuZHMubGVmdCArIGJvdW5kcy53aWR0aCwgYm91bmRzLnRvcCArIGJvdW5kcy5oZWlnaHQpOwogICAgICAgIHBhcnNlQ29ybmVyKGJvcmRlckFyZ3MsIHJhZGl1c1szXSwgcmFkaXVzWzBdLCBib3JkZXJQb2ludHMuYm90dG9tTGVmdE91dGVyLCBib3JkZXJQb2ludHMudG9wTGVmdE91dGVyLCBib3VuZHMubGVmdCwgYm91bmRzLnRvcCArIGJvdW5kcy5oZWlnaHQpOwogICAgICAgIGJyZWFrOwogICAgfQoKICAgIHJldHVybiBib3JkZXJBcmdzOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VCb3JkZXJzKGVsZW1lbnQsIGJvdW5kcywgYm9yZGVycyl7CiAgICB2YXIgeCA9IGJvdW5kcy5sZWZ0LAogICAgeSA9IGJvdW5kcy50b3AsCiAgICB3aWR0aCA9IGJvdW5kcy53aWR0aCwKICAgIGhlaWdodCA9IGJvdW5kcy5oZWlnaHQsCiAgICBib3JkZXJTaWRlLAogICAgYngsCiAgICBieSwKICAgIGJ3LAogICAgYmgsCiAgICBib3JkZXJBcmdzLAogICAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1iYWNrZ3JvdW5kLyN0aGUtYm9yZGVyLXJhZGl1cwogICAgYm9yZGVyUmFkaXVzID0gZ2V0Qm9yZGVyUmFkaXVzRGF0YShlbGVtZW50KSwKICAgIGJvcmRlclBvaW50cyA9IGNhbGN1bGF0ZUN1cnZlUG9pbnRzKGJvdW5kcywgYm9yZGVyUmFkaXVzLCBib3JkZXJzKSwKICAgIGJvcmRlckRhdGEgPSB7CiAgICAgIGNsaXA6IGdldEJvcmRlckNsaXAoZWxlbWVudCwgYm9yZGVyUG9pbnRzLCBib3JkZXJzLCBib3JkZXJSYWRpdXMsIGJvdW5kcyksCiAgICAgIGJvcmRlcnM6IFtdCiAgICB9OwoKICAgIGZvciAoYm9yZGVyU2lkZSA9IDA7IGJvcmRlclNpZGUgPCA0OyBib3JkZXJTaWRlKyspIHsKCiAgICAgIGlmIChib3JkZXJzW2JvcmRlclNpZGVdLndpZHRoID4gMCkgewogICAgICAgIGJ4ID0geDsKICAgICAgICBieSA9IHk7CiAgICAgICAgYncgPSB3aWR0aDsKICAgICAgICBiaCA9IGhlaWdodCAtIChib3JkZXJzWzJdLndpZHRoKTsKCiAgICAgICAgc3dpdGNoKGJvcmRlclNpZGUpIHsKICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgLy8gdG9wIGJvcmRlcgogICAgICAgICAgICBiaCA9IGJvcmRlcnNbMF0ud2lkdGg7CgogICAgICAgICAgICBib3JkZXJBcmdzID0gZHJhd1NpZGUoewogICAgICAgICAgICAgIGMxOiBbYngsIGJ5XSwKICAgICAgICAgICAgICBjMjogW2J4ICsgYncsIGJ5XSwKICAgICAgICAgICAgICBjMzogW2J4ICsgYncgLSBib3JkZXJzWzFdLndpZHRoLCBieSArIGJoXSwKICAgICAgICAgICAgICBjNDogW2J4ICsgYm9yZGVyc1szXS53aWR0aCwgYnkgKyBiaF0KICAgICAgICAgICAgfSwgYm9yZGVyUmFkaXVzWzBdLCBib3JkZXJSYWRpdXNbMV0sCiAgICAgICAgICAgIGJvcmRlclBvaW50cy50b3BMZWZ0T3V0ZXIsIGJvcmRlclBvaW50cy50b3BMZWZ0SW5uZXIsIGJvcmRlclBvaW50cy50b3BSaWdodE91dGVyLCBib3JkZXJQb2ludHMudG9wUmlnaHRJbm5lcik7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAvLyByaWdodCBib3JkZXIKICAgICAgICAgICAgYnggPSB4ICsgd2lkdGggLSAoYm9yZGVyc1sxXS53aWR0aCk7CiAgICAgICAgICAgIGJ3ID0gYm9yZGVyc1sxXS53aWR0aDsKCiAgICAgICAgICAgIGJvcmRlckFyZ3MgPSBkcmF3U2lkZSh7CiAgICAgICAgICAgICAgYzE6IFtieCArIGJ3LCBieV0sCiAgICAgICAgICAgICAgYzI6IFtieCArIGJ3LCBieSArIGJoICsgYm9yZGVyc1syXS53aWR0aF0sCiAgICAgICAgICAgICAgYzM6IFtieCwgYnkgKyBiaF0sCiAgICAgICAgICAgICAgYzQ6IFtieCwgYnkgKyBib3JkZXJzWzBdLndpZHRoXQogICAgICAgICAgICB9LCBib3JkZXJSYWRpdXNbMV0sIGJvcmRlclJhZGl1c1syXSwKICAgICAgICAgICAgYm9yZGVyUG9pbnRzLnRvcFJpZ2h0T3V0ZXIsIGJvcmRlclBvaW50cy50b3BSaWdodElubmVyLCBib3JkZXJQb2ludHMuYm90dG9tUmlnaHRPdXRlciwgYm9yZGVyUG9pbnRzLmJvdHRvbVJpZ2h0SW5uZXIpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgLy8gYm90dG9tIGJvcmRlcgogICAgICAgICAgICBieSA9IChieSArIGhlaWdodCkgLSAoYm9yZGVyc1syXS53aWR0aCk7CiAgICAgICAgICAgIGJoID0gYm9yZGVyc1syXS53aWR0aDsKCiAgICAgICAgICAgIGJvcmRlckFyZ3MgPSBkcmF3U2lkZSh7CiAgICAgICAgICAgICAgYzE6IFtieCArIGJ3LCBieSArIGJoXSwKICAgICAgICAgICAgICBjMjogW2J4LCBieSArIGJoXSwKICAgICAgICAgICAgICBjMzogW2J4ICsgYm9yZGVyc1szXS53aWR0aCwgYnldLAogICAgICAgICAgICAgIGM0OiBbYnggKyBidyAtIGJvcmRlcnNbM10ud2lkdGgsIGJ5XQogICAgICAgICAgICB9LCBib3JkZXJSYWRpdXNbMl0sIGJvcmRlclJhZGl1c1szXSwKICAgICAgICAgICAgYm9yZGVyUG9pbnRzLmJvdHRvbVJpZ2h0T3V0ZXIsIGJvcmRlclBvaW50cy5ib3R0b21SaWdodElubmVyLCBib3JkZXJQb2ludHMuYm90dG9tTGVmdE91dGVyLCBib3JkZXJQb2ludHMuYm90dG9tTGVmdElubmVyKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgIC8vIGxlZnQgYm9yZGVyCiAgICAgICAgICAgIGJ3ID0gYm9yZGVyc1szXS53aWR0aDsKCiAgICAgICAgICAgIGJvcmRlckFyZ3MgPSBkcmF3U2lkZSh7CiAgICAgICAgICAgICAgYzE6IFtieCwgYnkgKyBiaCArIGJvcmRlcnNbMl0ud2lkdGhdLAogICAgICAgICAgICAgIGMyOiBbYngsIGJ5XSwKICAgICAgICAgICAgICBjMzogW2J4ICsgYncsIGJ5ICsgYm9yZGVyc1swXS53aWR0aF0sCiAgICAgICAgICAgICAgYzQ6IFtieCArIGJ3LCBieSArIGJoXQogICAgICAgICAgICB9LCBib3JkZXJSYWRpdXNbM10sIGJvcmRlclJhZGl1c1swXSwKICAgICAgICAgICAgYm9yZGVyUG9pbnRzLmJvdHRvbUxlZnRPdXRlciwgYm9yZGVyUG9pbnRzLmJvdHRvbUxlZnRJbm5lciwgYm9yZGVyUG9pbnRzLnRvcExlZnRPdXRlciwgYm9yZGVyUG9pbnRzLnRvcExlZnRJbm5lcik7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgYm9yZGVyRGF0YS5ib3JkZXJzLnB1c2goewogICAgICAgICAgYXJnczogYm9yZGVyQXJncywKICAgICAgICAgIGNvbG9yOiBib3JkZXJzW2JvcmRlclNpZGVdLmNvbG9yCiAgICAgICAgfSk7CgogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGJvcmRlckRhdGE7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVTaGFwZShjdHgsIGFyZ3MpIHsKICAgIHZhciBzaGFwZSA9IGN0eC5kcmF3U2hhcGUoKTsKICAgIGFyZ3MuZm9yRWFjaChmdW5jdGlvbihib3JkZXIsIGluZGV4KSB7CiAgICAgIHNoYXBlWyhpbmRleCA9PT0gMCkgPyAibW92ZVRvIiA6IGJvcmRlclswXSArICJUbyIgXS5hcHBseShudWxsLCBib3JkZXIuc2xpY2UoMSkpOwogICAgfSk7CiAgICByZXR1cm4gc2hhcGU7CiAgfQoKICBmdW5jdGlvbiByZW5kZXJCb3JkZXJzKGN0eCwgYm9yZGVyQXJncywgY29sb3IpIHsKICAgIGlmIChjb2xvciAhPT0gInRyYW5zcGFyZW50IikgewogICAgICBjdHguc2V0VmFyaWFibGUoICJmaWxsU3R5bGUiLCBjb2xvcik7CiAgICAgIGNyZWF0ZVNoYXBlKGN0eCwgYm9yZGVyQXJncyk7CiAgICAgIGN0eC5maWxsKCk7CiAgICAgIG51bURyYXdzKz0xOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVuZGVyRm9ybVZhbHVlIChlbCwgYm91bmRzLCBzdGFjayl7CgogICAgdmFyIHZhbHVlV3JhcCA9IGRvYy5jcmVhdGVFbGVtZW50KCd2YWx1ZXdyYXAnKSwKICAgIGNzc1Byb3BlcnR5QXJyYXkgPSBbJ2xpbmVIZWlnaHQnLCd0ZXh0QWxpZ24nLCdmb250RmFtaWx5JywnY29sb3InLCdmb250U2l6ZScsJ3BhZGRpbmdMZWZ0JywncGFkZGluZ1RvcCcsJ3dpZHRoJywnaGVpZ2h0JywnYm9yZGVyJywnYm9yZGVyTGVmdFdpZHRoJywnYm9yZGVyVG9wV2lkdGgnXSwKICAgIHRleHRWYWx1ZSwKICAgIHRleHROb2RlOwoKICAgIGNzc1Byb3BlcnR5QXJyYXkuZm9yRWFjaChmdW5jdGlvbihwcm9wZXJ0eSkgewogICAgICB0cnkgewogICAgICAgIHZhbHVlV3JhcC5zdHlsZVtwcm9wZXJ0eV0gPSBnZXRDU1MoZWwsIHByb3BlcnR5KTsKICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgLy8gT2xkZXIgSUUgaGFzIGlzc3VlcyB3aXRoICJib3JkZXIiCiAgICAgICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBQYXJzZTogRXhjZXB0aW9uIGNhdWdodCBpbiByZW5kZXJGb3JtVmFsdWU6ICIgKyBlLm1lc3NhZ2UpOwogICAgICB9CiAgICB9KTsKCiAgICB2YWx1ZVdyYXAuc3R5bGUuYm9yZGVyQ29sb3IgPSAiYmxhY2siOwogICAgdmFsdWVXcmFwLnN0eWxlLmJvcmRlclN0eWxlID0gInNvbGlkIjsKICAgIHZhbHVlV3JhcC5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgIHZhbHVlV3JhcC5zdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7CgogICAgaWYgKC9eKHN1Ym1pdHxyZXNldHxidXR0b258dGV4dHxwYXNzd29yZCkkLy50ZXN0KGVsLnR5cGUpIHx8IGVsLm5vZGVOYW1lID09PSAiU0VMRUNUIil7CiAgICAgIHZhbHVlV3JhcC5zdHlsZS5saW5lSGVpZ2h0ID0gZ2V0Q1NTKGVsLCAiaGVpZ2h0Iik7CiAgICB9CgogICAgdmFsdWVXcmFwLnN0eWxlLnRvcCA9IGJvdW5kcy50b3AgKyAicHgiOwogICAgdmFsdWVXcmFwLnN0eWxlLmxlZnQgPSBib3VuZHMubGVmdCArICJweCI7CgogICAgdGV4dFZhbHVlID0gKGVsLm5vZGVOYW1lID09PSAiU0VMRUNUIikgPyAoZWwub3B0aW9uc1tlbC5zZWxlY3RlZEluZGV4XSB8fCAwKS50ZXh0IDogZWwudmFsdWU7CiAgICBpZighdGV4dFZhbHVlKSB7CiAgICAgIHRleHRWYWx1ZSA9IGVsLnBsYWNlaG9sZGVyOwogICAgfQoKICAgIHRleHROb2RlID0gZG9jLmNyZWF0ZVRleHROb2RlKHRleHRWYWx1ZSk7CgogICAgdmFsdWVXcmFwLmFwcGVuZENoaWxkKHRleHROb2RlKTsKICAgIGJvZHkuYXBwZW5kQ2hpbGQodmFsdWVXcmFwKTsKCiAgICByZW5kZXJUZXh0KGVsLCB0ZXh0Tm9kZSwgc3RhY2spOwogICAgYm9keS5yZW1vdmVDaGlsZCh2YWx1ZVdyYXApOwogIH0KCiAgZnVuY3Rpb24gZHJhd0ltYWdlIChjdHgpIHsKICAgIGN0eC5kcmF3SW1hZ2UuYXBwbHkoY3R4LCBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIG51bURyYXdzKz0xOwogIH0KCiAgZnVuY3Rpb24gZ2V0UHNldWRvRWxlbWVudChlbCwgd2hpY2gpIHsKICAgIHZhciBlbFN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWwsIHdoaWNoKTsKICAgIHZhciBwYXJlbnRTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsKTsKICAgIC8vIElmIG5vIGNvbnRlbnQgYXR0cmlidXRlIGlzIHByZXNlbnQsIHRoZSBwc2V1ZG8gZWxlbWVudCBpcyBoaWRkZW4sCiAgICAvLyBvciB0aGUgcGFyZW50IGhhcyBhIGNvbnRlbnQgcHJvcGVydHkgZXF1YWwgdG8gdGhlIGNvbnRlbnQgb24gdGhlIHBzZXVkbyBlbGVtZW50LAogICAgLy8gbW92ZSBhbG9uZy4KICAgIGlmKCFlbFN0eWxlIHx8ICFlbFN0eWxlLmNvbnRlbnQgfHwgZWxTdHlsZS5jb250ZW50ID09PSAibm9uZSIgfHwgZWxTdHlsZS5jb250ZW50ID09PSAiLW1vei1hbHQtY29udGVudCIgfHwKICAgICAgIGVsU3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiIHx8IHBhcmVudFN0eWxlLmNvbnRlbnQgPT09IGVsU3R5bGUuY29udGVudCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgY29udGVudCA9IGVsU3R5bGUuY29udGVudCArICcnOwoKICAgIC8vIFN0cmlwIGlubmVyIHF1b3RlcwogICAgaWYoY29udGVudFswXSA9PT0gIiciIHx8IGNvbnRlbnRbMF0gPT09ICJcIiIpIHsKICAgICAgY29udGVudCA9IGNvbnRlbnQucmVwbGFjZSgvKF5bJyJdKXwoWyciXSQpL2csICcnKTsKICAgIH0KCiAgICB2YXIgaXNJbWFnZSA9IGNvbnRlbnQuc3Vic3RyKCAwLCAzICkgPT09ICd1cmwnLAogICAgZWxwcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIGlzSW1hZ2UgPyAnaW1nJyA6ICdzcGFuJyApOwoKICAgIGVscHMuY2xhc3NOYW1lID0gcHNldWRvSGlkZSArICItZWxlbWVudCAiOwoKICAgIE9iamVjdC5rZXlzKGVsU3R5bGUpLmZpbHRlcihpbmRleGVkUHJvcGVydHkpLmZvckVhY2goZnVuY3Rpb24ocHJvcCkgewogICAgICAvLyBQcmV2ZW50IGFzc2lnbmluZyBvZiByZWFkIG9ubHkgQ1NTIFJ1bGVzLCBleC4gbGVuZ3RoLCBwYXJlbnRSdWxlCiAgICAgIHRyeSB7CiAgICAgICAgZWxwcy5zdHlsZVtwcm9wXSA9IGVsU3R5bGVbcHJvcF07CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBVdGlsLmxvZyhbJ1RyaWVkIHRvIGFzc2lnbiByZWFkb25seSBwcm9wZXJ0eSAnLCBwcm9wLCAnRXJyb3I6JywgZV0pOwogICAgICB9CiAgICB9KTsKCiAgICBpZihpc0ltYWdlKSB7CiAgICAgIGVscHMuc3JjID0gVXRpbC5wYXJzZUJhY2tncm91bmRJbWFnZShjb250ZW50KVswXS5hcmdzWzBdOwogICAgfSBlbHNlIHsKICAgICAgZWxwcy5pbm5lckhUTUwgPSBjb250ZW50OwogICAgfQogICAgcmV0dXJuIGVscHM7CiAgfQoKICBmdW5jdGlvbiBpbmRleGVkUHJvcGVydHkocHJvcGVydHkpIHsKICAgIHJldHVybiAoaXNOYU4od2luZG93LnBhcnNlSW50KHByb3BlcnR5LCAxMCkpKTsKICB9CgogIGZ1bmN0aW9uIHJlbmRlckJhY2tncm91bmRSZXBlYXQoY3R4LCBpbWFnZSwgYmFja2dyb3VuZFBvc2l0aW9uLCBib3VuZHMpIHsKICAgIHZhciBvZmZzZXRYID0gTWF0aC5yb3VuZChib3VuZHMubGVmdCArIGJhY2tncm91bmRQb3NpdGlvbi5sZWZ0KSwKICAgIG9mZnNldFkgPSBNYXRoLnJvdW5kKGJvdW5kcy50b3AgKyBiYWNrZ3JvdW5kUG9zaXRpb24udG9wKTsKCiAgICBjdHguY3JlYXRlUGF0dGVybihpbWFnZSk7CiAgICBjdHgudHJhbnNsYXRlKG9mZnNldFgsIG9mZnNldFkpOwogICAgY3R4LmZpbGwoKTsKICAgIGN0eC50cmFuc2xhdGUoLW9mZnNldFgsIC1vZmZzZXRZKTsKICB9CgogIGZ1bmN0aW9uIGJhY2tncm91bmRSZXBlYXRTaGFwZShjdHgsIGltYWdlLCBiYWNrZ3JvdW5kUG9zaXRpb24sIGJvdW5kcywgbGVmdCwgdG9wLCB3aWR0aCwgaGVpZ2h0KSB7CiAgICB2YXIgYXJncyA9IFtdOwogICAgYXJncy5wdXNoKFsibGluZSIsIE1hdGgucm91bmQobGVmdCksIE1hdGgucm91bmQodG9wKV0pOwogICAgYXJncy5wdXNoKFsibGluZSIsIE1hdGgucm91bmQobGVmdCArIHdpZHRoKSwgTWF0aC5yb3VuZCh0b3ApXSk7CiAgICBhcmdzLnB1c2goWyJsaW5lIiwgTWF0aC5yb3VuZChsZWZ0ICsgd2lkdGgpLCBNYXRoLnJvdW5kKGhlaWdodCArIHRvcCldKTsKICAgIGFyZ3MucHVzaChbImxpbmUiLCBNYXRoLnJvdW5kKGxlZnQpLCBNYXRoLnJvdW5kKGhlaWdodCArIHRvcCldKTsKICAgIGNyZWF0ZVNoYXBlKGN0eCwgYXJncyk7CiAgICBjdHguc2F2ZSgpOwogICAgY3R4LmNsaXAoKTsKICAgIHJlbmRlckJhY2tncm91bmRSZXBlYXQoY3R4LCBpbWFnZSwgYmFja2dyb3VuZFBvc2l0aW9uLCBib3VuZHMpOwogICAgY3R4LnJlc3RvcmUoKTsKICB9CgogIGZ1bmN0aW9uIHJlbmRlckJhY2tncm91bmRDb2xvcihjdHgsIGJhY2tncm91bmRCb3VuZHMsIGJnY29sb3IpIHsKICAgIHJlbmRlclJlY3QoCiAgICAgIGN0eCwKICAgICAgYmFja2dyb3VuZEJvdW5kcy5sZWZ0LAogICAgICBiYWNrZ3JvdW5kQm91bmRzLnRvcCwKICAgICAgYmFja2dyb3VuZEJvdW5kcy53aWR0aCwKICAgICAgYmFja2dyb3VuZEJvdW5kcy5oZWlnaHQsCiAgICAgIGJnY29sb3IKICAgICAgKTsKICB9CgogIGZ1bmN0aW9uIHJlbmRlckJhY2tncm91bmRSZXBlYXRpbmcoZWwsIGJvdW5kcywgY3R4LCBpbWFnZSwgaW1hZ2VJbmRleCkgewogICAgdmFyIGJhY2tncm91bmRTaXplID0gVXRpbC5CYWNrZ3JvdW5kU2l6ZShlbCwgYm91bmRzLCBpbWFnZSwgaW1hZ2VJbmRleCksCiAgICBiYWNrZ3JvdW5kUG9zaXRpb24gPSBVdGlsLkJhY2tncm91bmRQb3NpdGlvbihlbCwgYm91bmRzLCBpbWFnZSwgaW1hZ2VJbmRleCwgYmFja2dyb3VuZFNpemUpLAogICAgYmFja2dyb3VuZFJlcGVhdCA9IFV0aWwuQmFja2dyb3VuZFJlcGVhdChlbCwgaW1hZ2VJbmRleCk7CgogICAgaW1hZ2UgPSByZXNpemVJbWFnZShpbWFnZSwgYmFja2dyb3VuZFNpemUpOwoKICAgIHN3aXRjaCAoYmFja2dyb3VuZFJlcGVhdCkgewogICAgICBjYXNlICJyZXBlYXQteCI6CiAgICAgIGNhc2UgInJlcGVhdCBuby1yZXBlYXQiOgogICAgICAgIGJhY2tncm91bmRSZXBlYXRTaGFwZShjdHgsIGltYWdlLCBiYWNrZ3JvdW5kUG9zaXRpb24sIGJvdW5kcywKICAgICAgICAgIGJvdW5kcy5sZWZ0LCBib3VuZHMudG9wICsgYmFja2dyb3VuZFBvc2l0aW9uLnRvcCwgOTk5OTksIGltYWdlLmhlaWdodCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgInJlcGVhdC15IjoKICAgICAgY2FzZSAibm8tcmVwZWF0IHJlcGVhdCI6CiAgICAgICAgYmFja2dyb3VuZFJlcGVhdFNoYXBlKGN0eCwgaW1hZ2UsIGJhY2tncm91bmRQb3NpdGlvbiwgYm91bmRzLAogICAgICAgICAgYm91bmRzLmxlZnQgKyBiYWNrZ3JvdW5kUG9zaXRpb24ubGVmdCwgYm91bmRzLnRvcCwgaW1hZ2Uud2lkdGgsIDk5OTk5KTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAibm8tcmVwZWF0IjoKICAgICAgICBiYWNrZ3JvdW5kUmVwZWF0U2hhcGUoY3R4LCBpbWFnZSwgYmFja2dyb3VuZFBvc2l0aW9uLCBib3VuZHMsCiAgICAgICAgICBib3VuZHMubGVmdCArIGJhY2tncm91bmRQb3NpdGlvbi5sZWZ0LCBib3VuZHMudG9wICsgYmFja2dyb3VuZFBvc2l0aW9uLnRvcCwgaW1hZ2Uud2lkdGgsIGltYWdlLmhlaWdodCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmVuZGVyQmFja2dyb3VuZFJlcGVhdChjdHgsIGltYWdlLCBiYWNrZ3JvdW5kUG9zaXRpb24sIHsKICAgICAgICAgIHRvcDogYm91bmRzLnRvcCwKICAgICAgICAgIGxlZnQ6IGJvdW5kcy5sZWZ0LAogICAgICAgICAgd2lkdGg6IGltYWdlLndpZHRoLAogICAgICAgICAgaGVpZ2h0OiBpbWFnZS5oZWlnaHQKICAgICAgICB9KTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlbmRlckJhY2tncm91bmRJbWFnZShlbGVtZW50LCBib3VuZHMsIGN0eCkgewogICAgdmFyIGJhY2tncm91bmRJbWFnZSA9IGdldENTUyhlbGVtZW50LCAiYmFja2dyb3VuZEltYWdlIiksCiAgICBiYWNrZ3JvdW5kSW1hZ2VzID0gVXRpbC5wYXJzZUJhY2tncm91bmRJbWFnZShiYWNrZ3JvdW5kSW1hZ2UpLAogICAgaW1hZ2UsCiAgICBpbWFnZUluZGV4ID0gYmFja2dyb3VuZEltYWdlcy5sZW5ndGg7CgogICAgd2hpbGUoaW1hZ2VJbmRleC0tKSB7CiAgICAgIGJhY2tncm91bmRJbWFnZSA9IGJhY2tncm91bmRJbWFnZXNbaW1hZ2VJbmRleF07CgogICAgICBpZiAoIWJhY2tncm91bmRJbWFnZS5hcmdzIHx8IGJhY2tncm91bmRJbWFnZS5hcmdzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CgogICAgICB2YXIga2V5ID0gYmFja2dyb3VuZEltYWdlLm1ldGhvZCA9PT0gJ3VybCcgPwogICAgICBiYWNrZ3JvdW5kSW1hZ2UuYXJnc1swXSA6CiAgICAgIGJhY2tncm91bmRJbWFnZS52YWx1ZTsKCiAgICAgIGltYWdlID0gbG9hZEltYWdlKGtleSk7CgogICAgICAvLyBUT0RPIGFkZCBzdXBwb3J0IGZvciBiYWNrZ3JvdW5kLW9yaWdpbgogICAgICBpZiAoaW1hZ2UpIHsKICAgICAgICByZW5kZXJCYWNrZ3JvdW5kUmVwZWF0aW5nKGVsZW1lbnQsIGJvdW5kcywgY3R4LCBpbWFnZSwgaW1hZ2VJbmRleCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBFcnJvciBsb2FkaW5nIGJhY2tncm91bmQ6IiwgYmFja2dyb3VuZEltYWdlKTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVzaXplSW1hZ2UoaW1hZ2UsIGJvdW5kcykgewogICAgaWYoaW1hZ2Uud2lkdGggPT09IGJvdW5kcy53aWR0aCAmJiBpbWFnZS5oZWlnaHQgPT09IGJvdW5kcy5oZWlnaHQpIHsKICAgICAgcmV0dXJuIGltYWdlOwogICAgfQoKICAgIHZhciBjdHgsIGNhbnZhcyA9IGRvYy5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgIGNhbnZhcy53aWR0aCA9IGJvdW5kcy53aWR0aDsKICAgIGNhbnZhcy5oZWlnaHQgPSBib3VuZHMuaGVpZ2h0OwogICAgY3R4ID0gY2FudmFzLmdldENvbnRleHQoIjJkIik7CiAgICBkcmF3SW1hZ2UoY3R4LCBpbWFnZSwgMCwgMCwgaW1hZ2Uud2lkdGgsIGltYWdlLmhlaWdodCwgMCwgMCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0ICk7CiAgICByZXR1cm4gY2FudmFzOwogIH0KCiAgZnVuY3Rpb24gc2V0T3BhY2l0eShjdHgsIGVsZW1lbnQsIHBhcmVudFN0YWNrKSB7CiAgICByZXR1cm4gY3R4LnNldFZhcmlhYmxlKCJnbG9iYWxBbHBoYSIsIGdldENTUyhlbGVtZW50LCAib3BhY2l0eSIpICogKChwYXJlbnRTdGFjaykgPyBwYXJlbnRTdGFjay5vcGFjaXR5IDogMSkpOwogIH0KCiAgZnVuY3Rpb24gcmVtb3ZlUHgoc3RyKSB7CiAgICByZXR1cm4gc3RyLnJlcGxhY2UoInB4IiwgIiIpOwogIH0KCiAgZnVuY3Rpb24gZ2V0VHJhbnNmb3JtKGVsZW1lbnQsIHBhcmVudFN0YWNrKSB7CiAgICB2YXIgdHJhbnNmb3JtUmVnRXhwID0gLyhtYXRyaXgpXCgoLispXCkvOwogICAgdmFyIHRyYW5zZm9ybSA9IGdldENTUyhlbGVtZW50LCAidHJhbnNmb3JtIikgfHwgZ2V0Q1NTKGVsZW1lbnQsICItd2Via2l0LXRyYW5zZm9ybSIpIHx8IGdldENTUyhlbGVtZW50LCAiLW1vei10cmFuc2Zvcm0iKSB8fCBnZXRDU1MoZWxlbWVudCwgIi1tcy10cmFuc2Zvcm0iKSB8fCBnZXRDU1MoZWxlbWVudCwgIi1vLXRyYW5zZm9ybSIpOwogICAgdmFyIHRyYW5zZm9ybU9yaWdpbiA9IGdldENTUyhlbGVtZW50LCAidHJhbnNmb3JtLW9yaWdpbiIpIHx8IGdldENTUyhlbGVtZW50LCAiLXdlYmtpdC10cmFuc2Zvcm0tb3JpZ2luIikgfHwgZ2V0Q1NTKGVsZW1lbnQsICItbW96LXRyYW5zZm9ybS1vcmlnaW4iKSB8fCBnZXRDU1MoZWxlbWVudCwgIi1tcy10cmFuc2Zvcm0tb3JpZ2luIikgfHwgZ2V0Q1NTKGVsZW1lbnQsICItby10cmFuc2Zvcm0tb3JpZ2luIikgfHwgIjBweCAwcHgiOwoKICAgIHRyYW5zZm9ybU9yaWdpbiA9IHRyYW5zZm9ybU9yaWdpbi5zcGxpdCgiICIpLm1hcChyZW1vdmVQeCkubWFwKFV0aWwuYXNGbG9hdCk7CgogICAgdmFyIG1hdHJpeDsKICAgIGlmICh0cmFuc2Zvcm0gJiYgdHJhbnNmb3JtICE9PSAibm9uZSIpIHsKICAgICAgdmFyIG1hdGNoID0gdHJhbnNmb3JtLm1hdGNoKHRyYW5zZm9ybVJlZ0V4cCk7CiAgICAgIGlmIChtYXRjaCkgewogICAgICAgIHN3aXRjaChtYXRjaFsxXSkgewogICAgICAgICAgY2FzZSAibWF0cml4IjoKICAgICAgICAgICAgbWF0cml4ID0gbWF0Y2hbMl0uc3BsaXQoIiwiKS5tYXAoVXRpbC50cmltVGV4dCkubWFwKFV0aWwuYXNGbG9hdCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiB7CiAgICAgIG9yaWdpbjogdHJhbnNmb3JtT3JpZ2luLAogICAgICBtYXRyaXg6IG1hdHJpeAogICAgfTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZVN0YWNrKGVsZW1lbnQsIHBhcmVudFN0YWNrLCBib3VuZHMsIHRyYW5zZm9ybSkgewogICAgdmFyIGN0eCA9IGgyY1JlbmRlckNvbnRleHQoKCFwYXJlbnRTdGFjaykgPyBkb2N1bWVudFdpZHRoKCkgOiBib3VuZHMud2lkdGggLCAoIXBhcmVudFN0YWNrKSA/IGRvY3VtZW50SGVpZ2h0KCkgOiBib3VuZHMuaGVpZ2h0KSwKICAgIHN0YWNrID0gewogICAgICBjdHg6IGN0eCwKICAgICAgb3BhY2l0eTogc2V0T3BhY2l0eShjdHgsIGVsZW1lbnQsIHBhcmVudFN0YWNrKSwKICAgICAgY3NzUG9zaXRpb246IGdldENTUyhlbGVtZW50LCAicG9zaXRpb24iKSwKICAgICAgYm9yZGVyczogZ2V0Qm9yZGVyRGF0YShlbGVtZW50KSwKICAgICAgdHJhbnNmb3JtOiB0cmFuc2Zvcm0sCiAgICAgIGNsaXA6IChwYXJlbnRTdGFjayAmJiBwYXJlbnRTdGFjay5jbGlwKSA/IFV0aWwuRXh0ZW5kKCB7fSwgcGFyZW50U3RhY2suY2xpcCApIDogbnVsbAogICAgfTsKCiAgICBzZXRaKGVsZW1lbnQsIHN0YWNrLCBwYXJlbnRTdGFjayk7CgogICAgLy8gVE9ETyBjb3JyZWN0IG92ZXJmbG93IGZvciBhYnNvbHV0ZSBjb250ZW50IHJlc2lkaW5nIHVuZGVyIGEgc3RhdGljIHBvc2l0aW9uCiAgICBpZiAob3B0aW9ucy51c2VPdmVyZmxvdyA9PT0gdHJ1ZSAmJiAvKGhpZGRlbnxzY3JvbGx8YXV0bykvLnRlc3QoZ2V0Q1NTKGVsZW1lbnQsICJvdmVyZmxvdyIpKSA9PT0gdHJ1ZSAmJiAvKEJPRFkpL2kudGVzdChlbGVtZW50Lm5vZGVOYW1lKSA9PT0gZmFsc2UpewogICAgICBzdGFjay5jbGlwID0gKHN0YWNrLmNsaXApID8gY2xpcEJvdW5kcyhzdGFjay5jbGlwLCBib3VuZHMpIDogYm91bmRzOwogICAgfQoKICAgIHJldHVybiBzdGFjazsKICB9CgogIGZ1bmN0aW9uIGdldEJhY2tncm91bmRCb3VuZHMoYm9yZGVycywgYm91bmRzLCBjbGlwKSB7CiAgICB2YXIgYmFja2dyb3VuZEJvdW5kcyA9IHsKICAgICAgbGVmdDogYm91bmRzLmxlZnQgKyBib3JkZXJzWzNdLndpZHRoLAogICAgICB0b3A6IGJvdW5kcy50b3AgKyBib3JkZXJzWzBdLndpZHRoLAogICAgICB3aWR0aDogYm91bmRzLndpZHRoIC0gKGJvcmRlcnNbMV0ud2lkdGggKyBib3JkZXJzWzNdLndpZHRoKSwKICAgICAgaGVpZ2h0OiBib3VuZHMuaGVpZ2h0IC0gKGJvcmRlcnNbMF0ud2lkdGggKyBib3JkZXJzWzJdLndpZHRoKQogICAgfTsKCiAgICBpZiAoY2xpcCkgewogICAgICBiYWNrZ3JvdW5kQm91bmRzID0gY2xpcEJvdW5kcyhiYWNrZ3JvdW5kQm91bmRzLCBjbGlwKTsKICAgIH0KCiAgICByZXR1cm4gYmFja2dyb3VuZEJvdW5kczsKICB9CgogIGZ1bmN0aW9uIGdldEJvdW5kcyhlbGVtZW50LCB0cmFuc2Zvcm0pIHsKICAgIHZhciBib3VuZHMgPSAodHJhbnNmb3JtLm1hdHJpeCkgPyBVdGlsLk9mZnNldEJvdW5kcyhlbGVtZW50KSA6IFV0aWwuQm91bmRzKGVsZW1lbnQpOwogICAgdHJhbnNmb3JtLm9yaWdpblswXSArPSBib3VuZHMubGVmdDsKICAgIHRyYW5zZm9ybS5vcmlnaW5bMV0gKz0gYm91bmRzLnRvcDsKICAgIHJldHVybiBib3VuZHM7CiAgfQoKICBmdW5jdGlvbiByZW5kZXJFbGVtZW50KGVsZW1lbnQsIHBhcmVudFN0YWNrLCBpZ25vcmVCYWNrZ3JvdW5kKSB7CiAgICB2YXIgdHJhbnNmb3JtID0gZ2V0VHJhbnNmb3JtKGVsZW1lbnQsIHBhcmVudFN0YWNrKSwKICAgIGJvdW5kcyA9IGdldEJvdW5kcyhlbGVtZW50LCB0cmFuc2Zvcm0pLAogICAgaW1hZ2UsCiAgICBzdGFjayA9IGNyZWF0ZVN0YWNrKGVsZW1lbnQsIHBhcmVudFN0YWNrLCBib3VuZHMsIHRyYW5zZm9ybSksCiAgICBib3JkZXJzID0gc3RhY2suYm9yZGVycywKICAgIGN0eCA9IHN0YWNrLmN0eCwKICAgIGJhY2tncm91bmRCb3VuZHMgPSBnZXRCYWNrZ3JvdW5kQm91bmRzKGJvcmRlcnMsIGJvdW5kcywgc3RhY2suY2xpcCksCiAgICBib3JkZXJEYXRhID0gcGFyc2VCb3JkZXJzKGVsZW1lbnQsIGJvdW5kcywgYm9yZGVycyksCiAgICBiYWNrZ3JvdW5kQ29sb3IgPSAoaWdub3JlRWxlbWVudHNSZWdFeHAudGVzdChlbGVtZW50Lm5vZGVOYW1lKSkgPyAiI2VmZWZlZiIgOiBnZXRDU1MoZWxlbWVudCwgImJhY2tncm91bmRDb2xvciIpOwoKCiAgICBjcmVhdGVTaGFwZShjdHgsIGJvcmRlckRhdGEuY2xpcCk7CgogICAgY3R4LnNhdmUoKTsKICAgIGN0eC5jbGlwKCk7CgogICAgaWYgKGJhY2tncm91bmRCb3VuZHMuaGVpZ2h0ID4gMCAmJiBiYWNrZ3JvdW5kQm91bmRzLndpZHRoID4gMCAmJiAhaWdub3JlQmFja2dyb3VuZCkgewogICAgICByZW5kZXJCYWNrZ3JvdW5kQ29sb3IoY3R4LCBib3VuZHMsIGJhY2tncm91bmRDb2xvcik7CiAgICAgIHJlbmRlckJhY2tncm91bmRJbWFnZShlbGVtZW50LCBiYWNrZ3JvdW5kQm91bmRzLCBjdHgpOwogICAgfSBlbHNlIGlmIChpZ25vcmVCYWNrZ3JvdW5kKSB7CiAgICAgIHN0YWNrLmJhY2tncm91bmRDb2xvciA9ICBiYWNrZ3JvdW5kQ29sb3I7CiAgICB9CgogICAgY3R4LnJlc3RvcmUoKTsKCiAgICBib3JkZXJEYXRhLmJvcmRlcnMuZm9yRWFjaChmdW5jdGlvbihib3JkZXIpIHsKICAgICAgcmVuZGVyQm9yZGVycyhjdHgsIGJvcmRlci5hcmdzLCBib3JkZXIuY29sb3IpOwogICAgfSk7CgogICAgc3dpdGNoKGVsZW1lbnQubm9kZU5hbWUpewogICAgICBjYXNlICJJTUciOgogICAgICAgIGlmICgoaW1hZ2UgPSBsb2FkSW1hZ2UoZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3NyYycpKSkpIHsKICAgICAgICAgIHJlbmRlckltYWdlKGN0eCwgZWxlbWVudCwgaW1hZ2UsIGJvdW5kcywgYm9yZGVycyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogRXJyb3IgbG9hZGluZyA8aW1nPjoiICsgZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3NyYycpKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIklOUFVUIjoKICAgICAgICAvLyBUT0RPIGFkZCBhbGwgcmVsZXZhbnQgdHlwZSdzLCBpLmUuIEhUTUw1IG5ldyBzdHVmZgogICAgICAgIC8vIHRvZG8gYWRkIHN1cHBvcnQgZm9yIHBsYWNlaG9sZGVyIGF0dHJpYnV0ZSBmb3IgYnJvd3NlcnMgd2hpY2ggc3VwcG9ydCBpdAogICAgICAgIGlmICgvXih0ZXh0fHVybHxlbWFpbHxzdWJtaXR8YnV0dG9ufHJlc2V0KSQvLnRlc3QoZWxlbWVudC50eXBlKSAmJiAoZWxlbWVudC52YWx1ZSB8fCBlbGVtZW50LnBsYWNlaG9sZGVyIHx8ICIiKS5sZW5ndGggPiAwKXsKICAgICAgICAgIHJlbmRlckZvcm1WYWx1ZShlbGVtZW50LCBib3VuZHMsIHN0YWNrKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIlRFWFRBUkVBIjoKICAgICAgICBpZiAoKGVsZW1lbnQudmFsdWUgfHwgZWxlbWVudC5wbGFjZWhvbGRlciB8fCAiIikubGVuZ3RoID4gMCl7CiAgICAgICAgICByZW5kZXJGb3JtVmFsdWUoZWxlbWVudCwgYm91bmRzLCBzdGFjayk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJTRUxFQ1QiOgogICAgICAgIGlmICgoZWxlbWVudC5vcHRpb25zfHxlbGVtZW50LnBsYWNlaG9sZGVyIHx8ICIiKS5sZW5ndGggPiAwKXsKICAgICAgICAgIHJlbmRlckZvcm1WYWx1ZShlbGVtZW50LCBib3VuZHMsIHN0YWNrKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIkxJIjoKICAgICAgICByZW5kZXJMaXN0SXRlbShlbGVtZW50LCBzdGFjaywgYmFja2dyb3VuZEJvdW5kcyk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIkNBTlZBUyI6CiAgICAgICAgcmVuZGVySW1hZ2UoY3R4LCBlbGVtZW50LCBlbGVtZW50LCBib3VuZHMsIGJvcmRlcnMpOwogICAgICAgIGJyZWFrOwogICAgfQoKICAgIHJldHVybiBzdGFjazsKICB9CgogIGZ1bmN0aW9uIGlzRWxlbWVudFZpc2libGUoZWxlbWVudCkgewogICAgcmV0dXJuIChnZXRDU1MoZWxlbWVudCwgJ2Rpc3BsYXknKSAhPT0gIm5vbmUiICYmIGdldENTUyhlbGVtZW50LCAndmlzaWJpbGl0eScpICE9PSAiaGlkZGVuIiAmJiAhZWxlbWVudC5oYXNBdHRyaWJ1dGUoImRhdGEtaHRtbDJjYW52YXMtaWdub3JlIikpOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VFbGVtZW50IChlbGVtZW50LCBzdGFjaywgY2IpIHsKICAgIGlmICghY2IpIHsKICAgICAgY2IgPSBmdW5jdGlvbigpe307CiAgICB9CiAgICBpZiAoaXNFbGVtZW50VmlzaWJsZShlbGVtZW50KSkgewogICAgICBzdGFjayA9IHJlbmRlckVsZW1lbnQoZWxlbWVudCwgc3RhY2ssIGZhbHNlKSB8fCBzdGFjazsKICAgICAgaWYgKCFpZ25vcmVFbGVtZW50c1JlZ0V4cC50ZXN0KGVsZW1lbnQubm9kZU5hbWUpKSB7CiAgICAgICAgcmV0dXJuIHBhcnNlQ2hpbGRyZW4oZWxlbWVudCwgc3RhY2ssIGNiKTsKICAgICAgfQogICAgfQogICAgY2IoKTsKICB9CgogIGZ1bmN0aW9uIHBhcnNlQ2hpbGRyZW4oZWxlbWVudCwgc3RhY2ssIGNiKSB7CiAgICB2YXIgY2hpbGRyZW4gPSBVdGlsLkNoaWxkcmVuKGVsZW1lbnQpOwogICAgLy8gQWZ0ZXIgYWxsIG5vZGVzIGhhdmUgcHJvY2Vzc2VkLCBmaW5pc2hlZCgpIHdpbGwgY2FsbCB0aGUgY2IuCiAgICAvLyBXZSBhZGQgb25lIGFuZCBraWNrIGl0IG9mZiBzbyB0aGlzIHdpbGwgc3RpbGwgd29yayB3aGVuIGNoaWxkcmVuLmxlbmd0aCA9PT0gMC4KICAgIC8vIE5vdGUgdGhhdCB1bmxlc3MgYXN5bmMgaXMgdHJ1ZSwgdGhpcyB3aWxsIGhhcHBlbiBzeW5jaHJvbm91c2x5LCBqdXN0IHdpbGwgY2FsbGJhY2tzLgogICAgdmFyIGpvYnMgPSBjaGlsZHJlbi5sZW5ndGggKyAxOwogICAgZmluaXNoZWQoKTsKCiAgICBpZiAob3B0aW9ucy5hc3luYykgewogICAgICBjaGlsZHJlbi5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAvLyBEb24ndCBibG9jayB0aGUgcGFnZSBmcm9tIHJlbmRlcmluZwogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsgcGFyc2VOb2RlKG5vZGUpOyB9LCAwKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBjaGlsZHJlbi5mb3JFYWNoKHBhcnNlTm9kZSk7CiAgICB9CgogICAgZnVuY3Rpb24gcGFyc2VOb2RlKG5vZGUpIHsKICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IG5vZGUuRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgcGFyc2VFbGVtZW50KG5vZGUsIHN0YWNrLCBmaW5pc2hlZCk7CiAgICAgIH0gZWxzZSBpZiAobm9kZS5ub2RlVHlwZSA9PT0gbm9kZS5URVhUX05PREUpIHsKICAgICAgICByZW5kZXJUZXh0KGVsZW1lbnQsIG5vZGUsIHN0YWNrKTsKICAgICAgICBmaW5pc2hlZCgpOwogICAgICB9IGVsc2UgewogICAgICAgIGZpbmlzaGVkKCk7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGZpbmlzaGVkKGVsKSB7CiAgICAgIGlmICgtLWpvYnMgPD0gMCl7CiAgICAgICAgVXRpbC5sb2coImZpbmlzaGVkIHJlbmRlcmluZyAiICsgY2hpbGRyZW4ubGVuZ3RoICsgIiBjaGlsZHJlbi4iKTsKICAgICAgICBjYigpOwogICAgICB9CiAgICB9CiAgfQp9OwpfaHRtbDJjYW52YXMuUHJlbG9hZCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoKICB2YXIgaW1hZ2VzID0gewogICAgbnVtTG9hZGVkOiAwLCAgIC8vIGFsc28gZmFpbGVkIGFyZSBjb3VudGVkIGhlcmUKICAgIG51bUZhaWxlZDogMCwKICAgIG51bVRvdGFsOiAwLAogICAgY2xlYW51cERvbmU6IGZhbHNlCiAgfSwKICBwYWdlT3JpZ2luLAogIFV0aWwgPSBfaHRtbDJjYW52YXMuVXRpbCwKICBtZXRob2RzLAogIGksCiAgY291bnQgPSAwLAogIGVsZW1lbnQgPSBvcHRpb25zLmVsZW1lbnRzWzBdIHx8IGRvY3VtZW50LmJvZHksCiAgZG9jID0gZWxlbWVudC5vd25lckRvY3VtZW50LAogIGRvbUltYWdlcyA9IGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2ltZycpLCAvLyBGZXRjaCBpbWFnZXMgb2YgdGhlIHByZXNlbnQgZWxlbWVudCBvbmx5CiAgaW1nTGVuID0gZG9tSW1hZ2VzLmxlbmd0aCwKICBsaW5rID0gZG9jLmNyZWF0ZUVsZW1lbnQoImEiKSwKICBzdXBwb3J0Q09SUyA9IChmdW5jdGlvbiggaW1nICl7CiAgICByZXR1cm4gKGltZy5jcm9zc09yaWdpbiAhPT0gdW5kZWZpbmVkKTsKICB9KShuZXcgSW1hZ2UoKSksCiAgdGltZW91dFRpbWVyOwoKICBsaW5rLmhyZWYgPSB3aW5kb3cubG9jYXRpb24uaHJlZjsKICBwYWdlT3JpZ2luICA9IGxpbmsucHJvdG9jb2wgKyBsaW5rLmhvc3Q7CgogIGZ1bmN0aW9uIGlzU2FtZU9yaWdpbih1cmwpewogICAgbGluay5ocmVmID0gdXJsOwogICAgbGluay5ocmVmID0gbGluay5ocmVmOyAvLyBZRVMsIEJFTElFVkUgSVQgT1IgTk9ULCB0aGF0IGlzIHJlcXVpcmVkIGZvciBJRTkgLSBodHRwOi8vanNmaWRkbGUubmV0L25pa2xhc3ZoLzJlNDhiLwogICAgdmFyIG9yaWdpbiA9IGxpbmsucHJvdG9jb2wgKyBsaW5rLmhvc3Q7CiAgICByZXR1cm4gKG9yaWdpbiA9PT0gcGFnZU9yaWdpbik7CiAgfQoKICBmdW5jdGlvbiBzdGFydCgpewogICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBzdGFydDogaW1hZ2VzOiAiICsgaW1hZ2VzLm51bUxvYWRlZCArICIgLyAiICsgaW1hZ2VzLm51bVRvdGFsICsgIiAoZmFpbGVkOiAiICsgaW1hZ2VzLm51bUZhaWxlZCArICIpIik7CiAgICBpZiAoIWltYWdlcy5maXJzdFJ1biAmJiBpbWFnZXMubnVtTG9hZGVkID49IGltYWdlcy5udW1Ub3RhbCl7CiAgICAgIFV0aWwubG9nKCJGaW5pc2hlZCBsb2FkaW5nIGltYWdlczogIyAiICsgaW1hZ2VzLm51bVRvdGFsICsgIiAoZmFpbGVkOiAiICsgaW1hZ2VzLm51bUZhaWxlZCArICIpIik7CgogICAgICBpZiAodHlwZW9mIG9wdGlvbnMuY29tcGxldGUgPT09ICJmdW5jdGlvbiIpewogICAgICAgIG9wdGlvbnMuY29tcGxldGUoaW1hZ2VzKTsKICAgICAgfQoKICAgIH0KICB9CgogIC8vIFRPRE8gbW9kaWZ5IHByb3h5IHRvIHNlcnZlIGltYWdlcyB3aXRoIENPUlMgZW5hYmxlZCwgd2hlcmUgYXZhaWxhYmxlCiAgZnVuY3Rpb24gcHJveHlHZXRJbWFnZSh1cmwsIGltZywgaW1hZ2VPYmopewogICAgdmFyIGNhbGxiYWNrX25hbWUsCiAgICBzY3JpcHRVcmwgPSBvcHRpb25zLnByb3h5LAogICAgc2NyaXB0OwoKICAgIGxpbmsuaHJlZiA9IHVybDsKICAgIHVybCA9IGxpbmsuaHJlZjsgLy8gd29yayBhcm91bmQgZm9yIHBhZ2VzIHdpdGggYmFzZSBocmVmPSIiIHNldCAtIFdBUk5JTkc6IHRoaXMgbWF5IGNoYW5nZSB0aGUgdXJsCgogICAgY2FsbGJhY2tfbmFtZSA9ICdodG1sMmNhbnZhc18nICsgKGNvdW50KyspOwogICAgaW1hZ2VPYmouY2FsbGJhY2tuYW1lID0gY2FsbGJhY2tfbmFtZTsKCiAgICBpZiAoc2NyaXB0VXJsLmluZGV4T2YoIj8iKSA+IC0xKSB7CiAgICAgIHNjcmlwdFVybCArPSAiJiI7CiAgICB9IGVsc2UgewogICAgICBzY3JpcHRVcmwgKz0gIj8iOwogICAgfQogICAgc2NyaXB0VXJsICs9ICd1cmw9JyArIGVuY29kZVVSSUNvbXBvbmVudCh1cmwpICsgJyZjYWxsYmFjaz0nICsgY2FsbGJhY2tfbmFtZTsKICAgIHNjcmlwdCA9IGRvYy5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKCiAgICB3aW5kb3dbY2FsbGJhY2tfbmFtZV0gPSBmdW5jdGlvbihhKXsKICAgICAgaWYgKGEuc3Vic3RyaW5nKDAsNikgPT09ICJlcnJvcjoiKXsKICAgICAgICBpbWFnZU9iai5zdWNjZWVkZWQgPSBmYWxzZTsKICAgICAgICBpbWFnZXMubnVtTG9hZGVkKys7CiAgICAgICAgaW1hZ2VzLm51bUZhaWxlZCsrOwogICAgICAgIHN0YXJ0KCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0SW1hZ2VMb2FkSGFuZGxlcnMoaW1nLCBpbWFnZU9iaik7CiAgICAgICAgaW1nLnNyYyA9IGE7CiAgICAgIH0KICAgICAgd2luZG93W2NhbGxiYWNrX25hbWVdID0gdW5kZWZpbmVkOyAvLyB0byB3b3JrIHdpdGggSUU8OSAgLy8gTk9URTogdGhhdCB0aGUgdW5kZWZpbmVkIGNhbGxiYWNrIHByb3BlcnR5LW5hbWUgc3RpbGwgZXhpc3RzIG9uIHRoZSB3aW5kb3cgb2JqZWN0IChmb3IgSUU8OSkKICAgICAgdHJ5IHsKICAgICAgICBkZWxldGUgd2luZG93W2NhbGxiYWNrX25hbWVdOyAgLy8gZm9yIGFsbCBicm93c2VyIHRoYXQgc3VwcG9ydCB0aGlzCiAgICAgIH0gY2F0Y2goZXgpIHt9CiAgICAgIHNjcmlwdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHNjcmlwdCk7CiAgICAgIHNjcmlwdCA9IG51bGw7CiAgICAgIGRlbGV0ZSBpbWFnZU9iai5zY3JpcHQ7CiAgICAgIGRlbGV0ZSBpbWFnZU9iai5jYWxsYmFja25hbWU7CiAgICB9OwoKICAgIHNjcmlwdC5zZXRBdHRyaWJ1dGUoInR5cGUiLCAidGV4dC9qYXZhc2NyaXB0Iik7CiAgICBzY3JpcHQuc2V0QXR0cmlidXRlKCJzcmMiLCBzY3JpcHRVcmwpOwogICAgaW1hZ2VPYmouc2NyaXB0ID0gc2NyaXB0OwogICAgd2luZG93LmRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCiAgfQoKICBmdW5jdGlvbiBsb2FkUHNldWRvRWxlbWVudChlbGVtZW50LCB0eXBlKSB7CiAgICB2YXIgc3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50LCB0eXBlKSwKICAgIGNvbnRlbnQgPSBzdHlsZS5jb250ZW50OwogICAgaWYgKGNvbnRlbnQuc3Vic3RyKDAsIDMpID09PSAndXJsJykgewogICAgICBtZXRob2RzLmxvYWRJbWFnZShfaHRtbDJjYW52YXMuVXRpbC5wYXJzZUJhY2tncm91bmRJbWFnZShjb250ZW50KVswXS5hcmdzWzBdKTsKICAgIH0KICAgIGxvYWRCYWNrZ3JvdW5kSW1hZ2VzKHN0eWxlLmJhY2tncm91bmRJbWFnZSwgZWxlbWVudCk7CiAgfQoKICBmdW5jdGlvbiBsb2FkUHNldWRvRWxlbWVudEltYWdlcyhlbGVtZW50KSB7CiAgICBsb2FkUHNldWRvRWxlbWVudChlbGVtZW50LCAiOmJlZm9yZSIpOwogICAgbG9hZFBzZXVkb0VsZW1lbnQoZWxlbWVudCwgIjphZnRlciIpOwogIH0KCiAgZnVuY3Rpb24gbG9hZEdyYWRpZW50SW1hZ2UoYmFja2dyb3VuZEltYWdlLCBib3VuZHMpIHsKICAgIHZhciBpbWcgPSBfaHRtbDJjYW52YXMuR2VuZXJhdGUuR3JhZGllbnQoYmFja2dyb3VuZEltYWdlLCBib3VuZHMpOwoKICAgIGlmIChpbWcgIT09IHVuZGVmaW5lZCl7CiAgICAgIGltYWdlc1tiYWNrZ3JvdW5kSW1hZ2VdID0gewogICAgICAgIGltZzogaW1nLAogICAgICAgIHN1Y2NlZWRlZDogdHJ1ZQogICAgICB9OwogICAgICBpbWFnZXMubnVtVG90YWwrKzsKICAgICAgaW1hZ2VzLm51bUxvYWRlZCsrOwogICAgICBzdGFydCgpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaW52YWxpZEJhY2tncm91bmRzKGJhY2tncm91bmRfaW1hZ2UpIHsKICAgIHJldHVybiAoYmFja2dyb3VuZF9pbWFnZSAmJiBiYWNrZ3JvdW5kX2ltYWdlLm1ldGhvZCAmJiBiYWNrZ3JvdW5kX2ltYWdlLmFyZ3MgJiYgYmFja2dyb3VuZF9pbWFnZS5hcmdzLmxlbmd0aCA+IDAgKTsKICB9CgogIGZ1bmN0aW9uIGxvYWRCYWNrZ3JvdW5kSW1hZ2VzKGJhY2tncm91bmRfaW1hZ2UsIGVsKSB7CiAgICB2YXIgYm91bmRzOwoKICAgIF9odG1sMmNhbnZhcy5VdGlsLnBhcnNlQmFja2dyb3VuZEltYWdlKGJhY2tncm91bmRfaW1hZ2UpLmZpbHRlcihpbnZhbGlkQmFja2dyb3VuZHMpLmZvckVhY2goZnVuY3Rpb24oYmFja2dyb3VuZF9pbWFnZSkgewogICAgICBpZiAoYmFja2dyb3VuZF9pbWFnZS5tZXRob2QgPT09ICd1cmwnKSB7CiAgICAgICAgbWV0aG9kcy5sb2FkSW1hZ2UoYmFja2dyb3VuZF9pbWFnZS5hcmdzWzBdKTsKICAgICAgfSBlbHNlIGlmKGJhY2tncm91bmRfaW1hZ2UubWV0aG9kLm1hdGNoKC9cLT9ncmFkaWVudCQvKSkgewogICAgICAgIGlmKGJvdW5kcyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBib3VuZHMgPSBfaHRtbDJjYW52YXMuVXRpbC5Cb3VuZHMoZWwpOwogICAgICAgIH0KICAgICAgICBsb2FkR3JhZGllbnRJbWFnZShiYWNrZ3JvdW5kX2ltYWdlLnZhbHVlLCBib3VuZHMpOwogICAgICB9CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIGdldEltYWdlcyAoZWwpIHsKICAgIHZhciBlbE5vZGVUeXBlID0gZmFsc2U7CgogICAgLy8gRmlyZWZveCBmYWlscyB3aXRoIHBlcm1pc3Npb24gZGVuaWVkIG9uIHBhZ2VzIHdpdGggaWZyYW1lcwogICAgdHJ5IHsKICAgICAgVXRpbC5DaGlsZHJlbihlbCkuZm9yRWFjaChnZXRJbWFnZXMpOwogICAgfQogICAgY2F0Y2goIGUgKSB7fQoKICAgIHRyeSB7CiAgICAgIGVsTm9kZVR5cGUgPSBlbC5ub2RlVHlwZTsKICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgIGVsTm9kZVR5cGUgPSBmYWxzZTsKICAgICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBmYWlsZWQgdG8gYWNjZXNzIHNvbWUgZWxlbWVudCdzIG5vZGVUeXBlIC0gRXhjZXB0aW9uOiAiICsgZXgubWVzc2FnZSk7CiAgICB9CgogICAgaWYgKGVsTm9kZVR5cGUgPT09IDEgfHwgZWxOb2RlVHlwZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGxvYWRQc2V1ZG9FbGVtZW50SW1hZ2VzKGVsKTsKICAgICAgdHJ5IHsKICAgICAgICBsb2FkQmFja2dyb3VuZEltYWdlcyhVdGlsLmdldENTUyhlbCwgJ2JhY2tncm91bmRJbWFnZScpLCBlbCk7CiAgICAgIH0gY2F0Y2goZSkgewogICAgICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogZmFpbGVkIHRvIGdldCBiYWNrZ3JvdW5kLWltYWdlIC0gRXhjZXB0aW9uOiAiICsgZS5tZXNzYWdlKTsKICAgICAgfQogICAgICBsb2FkQmFja2dyb3VuZEltYWdlcyhlbCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBzZXRJbWFnZUxvYWRIYW5kbGVycyhpbWcsIGltYWdlT2JqKSB7CiAgICBpbWcub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmICggaW1hZ2VPYmoudGltZXIgIT09IHVuZGVmaW5lZCApIHsKICAgICAgICAvLyBDT1JTIHN1Y2NlZWRlZAogICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQoIGltYWdlT2JqLnRpbWVyICk7CiAgICAgIH0KCiAgICAgIGltYWdlcy5udW1Mb2FkZWQrKzsKICAgICAgaW1hZ2VPYmouc3VjY2VlZGVkID0gdHJ1ZTsKICAgICAgaW1nLm9uZXJyb3IgPSBpbWcub25sb2FkID0gbnVsbDsKICAgICAgc3RhcnQoKTsKICAgIH07CiAgICBpbWcub25lcnJvciA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAoaW1nLmNyb3NzT3JpZ2luID09PSAiYW5vbnltb3VzIikgewogICAgICAgIC8vIENPUlMgZmFpbGVkCiAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCggaW1hZ2VPYmoudGltZXIgKTsKCiAgICAgICAgLy8gbGV0J3MgdHJ5IHdpdGggcHJveHkgaW5zdGVhZAogICAgICAgIGlmICggb3B0aW9ucy5wcm94eSApIHsKICAgICAgICAgIHZhciBzcmMgPSBpbWcuc3JjOwogICAgICAgICAgaW1nID0gbmV3IEltYWdlKCk7CiAgICAgICAgICBpbWFnZU9iai5pbWcgPSBpbWc7CiAgICAgICAgICBpbWcuc3JjID0gc3JjOwoKICAgICAgICAgIHByb3h5R2V0SW1hZ2UoIGltZy5zcmMsIGltZywgaW1hZ2VPYmogKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGltYWdlcy5udW1Mb2FkZWQrKzsKICAgICAgaW1hZ2VzLm51bUZhaWxlZCsrOwogICAgICBpbWFnZU9iai5zdWNjZWVkZWQgPSBmYWxzZTsKICAgICAgaW1nLm9uZXJyb3IgPSBpbWcub25sb2FkID0gbnVsbDsKICAgICAgc3RhcnQoKTsKICAgIH07CiAgfQoKICBtZXRob2RzID0gewogICAgbG9hZEltYWdlOiBmdW5jdGlvbiggc3JjICkgewogICAgICB2YXIgaW1nLCBpbWFnZU9iajsKICAgICAgaWYgKCBzcmMgJiYgaW1hZ2VzW3NyY10gPT09IHVuZGVmaW5lZCApIHsKICAgICAgICBpbWcgPSBuZXcgSW1hZ2UoKTsKICAgICAgICBpZiAoIHNyYy5tYXRjaCgvZGF0YTppbWFnZVwvLio7YmFzZTY0LC9pKSApIHsKICAgICAgICAgIGltZy5zcmMgPSBzcmMucmVwbGFjZSgvdXJsXChbJyJdezAsfXxbJyJdezAsfVwpJC9pZywgJycpOwogICAgICAgICAgaW1hZ2VPYmogPSBpbWFnZXNbc3JjXSA9IHsKICAgICAgICAgICAgaW1nOiBpbWcKICAgICAgICAgIH07CiAgICAgICAgICBpbWFnZXMubnVtVG90YWwrKzsKICAgICAgICAgIHNldEltYWdlTG9hZEhhbmRsZXJzKGltZywgaW1hZ2VPYmopOwogICAgICAgIH0gZWxzZSBpZiAoIGlzU2FtZU9yaWdpbiggc3JjICkgfHwgb3B0aW9ucy5hbGxvd1RhaW50ID09PSAgdHJ1ZSApIHsKICAgICAgICAgIGltYWdlT2JqID0gaW1hZ2VzW3NyY10gPSB7CiAgICAgICAgICAgIGltZzogaW1nCiAgICAgICAgICB9OwogICAgICAgICAgaW1hZ2VzLm51bVRvdGFsKys7CiAgICAgICAgICBzZXRJbWFnZUxvYWRIYW5kbGVycyhpbWcsIGltYWdlT2JqKTsKICAgICAgICAgIGltZy5zcmMgPSBzcmM7CiAgICAgICAgfSBlbHNlIGlmICggc3VwcG9ydENPUlMgJiYgIW9wdGlvbnMuYWxsb3dUYWludCAmJiBvcHRpb25zLnVzZUNPUlMgKSB7CiAgICAgICAgICAvLyBhdHRlbXB0IHRvIGxvYWQgd2l0aCBDT1JTCgogICAgICAgICAgaW1nLmNyb3NzT3JpZ2luID0gImFub255bW91cyI7CiAgICAgICAgICBpbWFnZU9iaiA9IGltYWdlc1tzcmNdID0gewogICAgICAgICAgICBpbWc6IGltZwogICAgICAgICAgfTsKICAgICAgICAgIGltYWdlcy5udW1Ub3RhbCsrOwogICAgICAgICAgc2V0SW1hZ2VMb2FkSGFuZGxlcnMoaW1nLCBpbWFnZU9iaik7CiAgICAgICAgICBpbWcuc3JjID0gc3JjOwogICAgICAgIH0gZWxzZSBpZiAoIG9wdGlvbnMucHJveHkgKSB7CiAgICAgICAgICBpbWFnZU9iaiA9IGltYWdlc1tzcmNdID0gewogICAgICAgICAgICBpbWc6IGltZwogICAgICAgICAgfTsKICAgICAgICAgIGltYWdlcy5udW1Ub3RhbCsrOwogICAgICAgICAgcHJveHlHZXRJbWFnZSggc3JjLCBpbWcsIGltYWdlT2JqICk7CiAgICAgICAgfQogICAgICB9CgogICAgfSwKICAgIGNsZWFudXBET006IGZ1bmN0aW9uKGNhdXNlKSB7CiAgICAgIHZhciBpbWcsIHNyYzsKICAgICAgaWYgKCFpbWFnZXMuY2xlYW51cERvbmUpIHsKICAgICAgICBpZiAoY2F1c2UgJiYgdHlwZW9mIGNhdXNlID09PSAic3RyaW5nIikgewogICAgICAgICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBDbGVhbnVwIGJlY2F1c2U6ICIgKyBjYXVzZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogQ2xlYW51cCBhZnRlciB0aW1lb3V0OiAiICsgb3B0aW9ucy50aW1lb3V0ICsgIiBtcy4iKTsKICAgICAgICB9CgogICAgICAgIGZvciAoc3JjIGluIGltYWdlcykgewogICAgICAgICAgaWYgKGltYWdlcy5oYXNPd25Qcm9wZXJ0eShzcmMpKSB7CiAgICAgICAgICAgIGltZyA9IGltYWdlc1tzcmNdOwogICAgICAgICAgICBpZiAodHlwZW9mIGltZyA9PT0gIm9iamVjdCIgJiYgaW1nLmNhbGxiYWNrbmFtZSAmJiBpbWcuc3VjY2VlZGVkID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAvLyBjYW5jZWwgcHJveHkgaW1hZ2UgcmVxdWVzdAogICAgICAgICAgICAgIHdpbmRvd1tpbWcuY2FsbGJhY2tuYW1lXSA9IHVuZGVmaW5lZDsgLy8gdG8gd29yayB3aXRoIElFPDkgIC8vIE5PVEU6IHRoYXQgdGhlIHVuZGVmaW5lZCBjYWxsYmFjayBwcm9wZXJ0eS1uYW1lIHN0aWxsIGV4aXN0cyBvbiB0aGUgd2luZG93IG9iamVjdCAoZm9yIElFPDkpCiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGRlbGV0ZSB3aW5kb3dbaW1nLmNhbGxiYWNrbmFtZV07ICAvLyBmb3IgYWxsIGJyb3dzZXIgdGhhdCBzdXBwb3J0IHRoaXMKICAgICAgICAgICAgICB9IGNhdGNoKGV4KSB7fQogICAgICAgICAgICAgIGlmIChpbWcuc2NyaXB0ICYmIGltZy5zY3JpcHQucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgICAgaW1nLnNjcmlwdC5zZXRBdHRyaWJ1dGUoInNyYyIsICJhYm91dDpibGFuayIpOyAgLy8gdHJ5IHRvIGNhbmNlbCBydW5uaW5nIHJlcXVlc3QKICAgICAgICAgICAgICAgIGltZy5zY3JpcHQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChpbWcuc2NyaXB0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaW1hZ2VzLm51bUxvYWRlZCsrOwogICAgICAgICAgICAgIGltYWdlcy5udW1GYWlsZWQrKzsKICAgICAgICAgICAgICBVdGlsLmxvZygiaHRtbDJjYW52YXM6IENsZWFuZWQgdXAgZmFpbGVkIGltZzogJyIgKyBzcmMgKyAiJyBTdGVwczogIiArIGltYWdlcy5udW1Mb2FkZWQgKyAiIC8gIiArIGltYWdlcy5udW1Ub3RhbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIGNhbmNlbCBhbnkgcGVuZGluZyByZXF1ZXN0cwogICAgICAgIGlmKHdpbmRvdy5zdG9wICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHdpbmRvdy5zdG9wKCk7CiAgICAgICAgfSBlbHNlIGlmKGRvY3VtZW50LmV4ZWNDb21tYW5kICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKCJTdG9wIiwgZmFsc2UpOwogICAgICAgIH0KICAgICAgICBpZiAoZG9jdW1lbnQuY2xvc2UgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgZG9jdW1lbnQuY2xvc2UoKTsKICAgICAgICB9CiAgICAgICAgaW1hZ2VzLmNsZWFudXBEb25lID0gdHJ1ZTsKICAgICAgICBpZiAoIShjYXVzZSAmJiB0eXBlb2YgY2F1c2UgPT09ICJzdHJpbmciKSkgewogICAgICAgICAgc3RhcnQoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgcmVuZGVyaW5nRG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aW1lb3V0VGltZXIpIHsKICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRpbWVvdXRUaW1lcik7CiAgICAgIH0KICAgIH0KICB9OwoKICBpZiAob3B0aW9ucy50aW1lb3V0ID4gMCkgewogICAgdGltZW91dFRpbWVyID0gd2luZG93LnNldFRpbWVvdXQobWV0aG9kcy5jbGVhbnVwRE9NLCBvcHRpb25zLnRpbWVvdXQpOwogIH0KCiAgVXRpbC5sb2coJ2h0bWwyY2FudmFzOiBQcmVsb2FkIHN0YXJ0czogZmluZGluZyBiYWNrZ3JvdW5kLWltYWdlcycpOwogIGltYWdlcy5maXJzdFJ1biA9IHRydWU7CgogIGdldEltYWdlcyhlbGVtZW50KTsKCiAgVXRpbC5sb2coJ2h0bWwyY2FudmFzOiBQcmVsb2FkOiBGaW5kaW5nIGltYWdlcycpOwogIC8vIGxvYWQgPGltZz4gaW1hZ2VzCiAgZm9yIChpID0gMDsgaSA8IGltZ0xlbjsgaSs9MSl7CiAgICBtZXRob2RzLmxvYWRJbWFnZSggZG9tSW1hZ2VzW2ldLmdldEF0dHJpYnV0ZSggInNyYyIgKSApOwogIH0KCiAgaW1hZ2VzLmZpcnN0UnVuID0gZmFsc2U7CiAgVXRpbC5sb2coJ2h0bWwyY2FudmFzOiBQcmVsb2FkOiBEb25lLicpOwogIGlmIChpbWFnZXMubnVtVG90YWwgPT09IGltYWdlcy5udW1Mb2FkZWQpIHsKICAgIHN0YXJ0KCk7CiAgfQoKICByZXR1cm4gbWV0aG9kczsKfTsKCl9odG1sMmNhbnZhcy5SZW5kZXJlciA9IGZ1bmN0aW9uKHBhcnNlUXVldWUsIG9wdGlvbnMpewogIGZ1bmN0aW9uIHNvcnRaaW5kZXgoYSwgYikgewogICAgaWYgKGEgPT09ICdjaGlsZHJlbicpIHsKICAgICAgcmV0dXJuIC0xOwogICAgfSBlbHNlIGlmIChiID09PSAnY2hpbGRyZW4nKSB7CiAgICAgIHJldHVybiAxOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGEgLSBiOwogICAgfQogIH0KCiAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvQ1NTMjEvemluZGV4Lmh0bWwKICBmdW5jdGlvbiBjcmVhdGVSZW5kZXJRdWV1ZShwYXJzZVF1ZXVlKSB7CiAgICB2YXIgcXVldWUgPSBbXSwKICAgIHJvb3RDb250ZXh0OwoKICAgIHJvb3RDb250ZXh0ID0gKGZ1bmN0aW9uIGJ1aWxkU3RhY2tpbmdDb250ZXh0KHJvb3ROb2RlKSB7CiAgICAgIHZhciByb290Q29udGV4dCA9IHt9OwogICAgICBmdW5jdGlvbiBpbnNlcnQoY29udGV4dCwgbm9kZSwgc3BlY2lhbFBhcmVudCkgewogICAgICAgIHZhciB6aSA9IChub2RlLnpJbmRleC56aW5kZXggPT09ICdhdXRvJykgPyAwIDogTnVtYmVyKG5vZGUuekluZGV4LnppbmRleCksCiAgICAgICAgY29udGV4dEZvckNoaWxkcmVuID0gY29udGV4dCwgLy8gdGhlIHN0YWNraW5nIGNvbnRleHQgZm9yIGNoaWxkcmVuCiAgICAgICAgaXNQb3NpdGlvbmVkID0gbm9kZS56SW5kZXguaXNQb3NpdGlvbmVkLAogICAgICAgIGlzRmxvYXRlZCA9IG5vZGUuekluZGV4LmlzRmxvYXRlZCwKICAgICAgICBzdHViID0ge25vZGU6IG5vZGV9LAogICAgICAgIGNoaWxkcmVuRGVzdCA9IHNwZWNpYWxQYXJlbnQ7IC8vIHdoZXJlIGNoaWxkcmVuIHdpdGhvdXQgei1pbmRleCBzaG91bGQgYmUgcHVzaGVkIGludG8KCiAgICAgICAgaWYgKG5vZGUuekluZGV4Lm93blN0YWNraW5nKSB7CiAgICAgICAgICBjb250ZXh0Rm9yQ2hpbGRyZW4gPSBzdHViLmNvbnRleHQgPSB7CiAgICAgICAgICAgICAgY2hpbGRyZW46IFt7bm9kZTpub2RlLCBjaGlsZHJlbjogW119XQogICAgICAgICAgfTsKICAgICAgICAgIGNoaWxkcmVuRGVzdCA9IHVuZGVmaW5lZDsKICAgICAgICB9IGVsc2UgaWYgKGlzUG9zaXRpb25lZCB8fCBpc0Zsb2F0ZWQpIHsKICAgICAgICAgIGNoaWxkcmVuRGVzdCA9IHN0dWIuY2hpbGRyZW4gPSBbXTsKICAgICAgICB9CgogICAgICAgIGlmICh6aSA9PT0gMCAmJiBzcGVjaWFsUGFyZW50KSB7CiAgICAgICAgICBzcGVjaWFsUGFyZW50LnB1c2goc3R1Yik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICghY29udGV4dFt6aV0pIHsgY29udGV4dFt6aV0gPSBbXTsgfQogICAgICAgICAgY29udGV4dFt6aV0ucHVzaChzdHViKTsKICAgICAgICB9CgogICAgICAgIG5vZGUuekluZGV4LmNoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24oY2hpbGROb2RlKSB7CiAgICAgICAgICBpbnNlcnQoY29udGV4dEZvckNoaWxkcmVuLCBjaGlsZE5vZGUsIGNoaWxkcmVuRGVzdCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaW5zZXJ0KHJvb3RDb250ZXh0LCByb290Tm9kZSk7CiAgICAgIHJldHVybiByb290Q29udGV4dDsKICAgIH0pKHBhcnNlUXVldWUpOwoKICAgIGZ1bmN0aW9uIHNvcnRaKGNvbnRleHQpIHsKICAgICAgT2JqZWN0LmtleXMoY29udGV4dCkuc29ydChzb3J0WmluZGV4KS5mb3JFYWNoKGZ1bmN0aW9uKHppKSB7CiAgICAgICAgdmFyIG5vblBvc2l0aW9uZWQgPSBbXSwKICAgICAgICBmbG9hdGVkID0gW10sCiAgICAgICAgcG9zaXRpb25lZCA9IFtdLAogICAgICAgIGxpc3QgPSBbXTsKCiAgICAgICAgLy8gcG9zaXRpb25lZCBhZnRlciBzdGF0aWMKICAgICAgICBjb250ZXh0W3ppXS5mb3JFYWNoKGZ1bmN0aW9uKHYpIHsKICAgICAgICAgIGlmICh2Lm5vZGUuekluZGV4LmlzUG9zaXRpb25lZCB8fCB2Lm5vZGUuekluZGV4Lm9wYWNpdHkgPCAxKSB7CiAgICAgICAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL2NzczMtY29sb3IvI3RyYW5zcGFyZW5jeQogICAgICAgICAgICAvLyBub24tcG9zaXRpb25lZCBlbGVtZW50IHdpdGggb3BhY3RpeSA8IDEgc2hvdWxkIGJlIHN0YWNrZWQgYXMgaWYgaXQgd2VyZSBhIHBvc2l0aW9uZWQgZWxlbWVudCB3aXRoIOKAmHotaW5kZXg6IDDigJkgYW5kIOKAmG9wYWNpdHk6IDHigJkuCiAgICAgICAgICAgIHBvc2l0aW9uZWQucHVzaCh2KTsKICAgICAgICAgIH0gZWxzZSBpZiAodi5ub2RlLnpJbmRleC5pc0Zsb2F0ZWQpIHsKICAgICAgICAgICAgZmxvYXRlZC5wdXNoKHYpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbm9uUG9zaXRpb25lZC5wdXNoKHYpOwogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAoZnVuY3Rpb24gd2FsayhhcnIpIHsKICAgICAgICAgIGFyci5mb3JFYWNoKGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgbGlzdC5wdXNoKHYpOwogICAgICAgICAgICBpZiAodi5jaGlsZHJlbikgeyB3YWxrKHYuY2hpbGRyZW4pOyB9CiAgICAgICAgICB9KTsKICAgICAgICB9KShub25Qb3NpdGlvbmVkLmNvbmNhdChmbG9hdGVkLCBwb3NpdGlvbmVkKSk7CgogICAgICAgIGxpc3QuZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICAgICAgICBpZiAodi5jb250ZXh0KSB7CiAgICAgICAgICAgIHNvcnRaKHYuY29udGV4dCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBxdWV1ZS5wdXNoKHYubm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQoKICAgIHNvcnRaKHJvb3RDb250ZXh0KTsKCiAgICByZXR1cm4gcXVldWU7CiAgfQoKICBmdW5jdGlvbiBnZXRSZW5kZXJlcihyZW5kZXJlck5hbWUpIHsKICAgIHZhciByZW5kZXJlcjsKCiAgICBpZiAodHlwZW9mIG9wdGlvbnMucmVuZGVyZXIgPT09ICJzdHJpbmciICYmIF9odG1sMmNhbnZhcy5SZW5kZXJlcltyZW5kZXJlck5hbWVdICE9PSB1bmRlZmluZWQpIHsKICAgICAgcmVuZGVyZXIgPSBfaHRtbDJjYW52YXMuUmVuZGVyZXJbcmVuZGVyZXJOYW1lXShvcHRpb25zKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHJlbmRlcmVyTmFtZSA9PT0gImZ1bmN0aW9uIikgewogICAgICByZW5kZXJlciA9IHJlbmRlcmVyTmFtZShvcHRpb25zKTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biByZW5kZXJlciIpOwogICAgfQoKICAgIGlmICggdHlwZW9mIHJlbmRlcmVyICE9PSAiZnVuY3Rpb24iICkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgcmVuZGVyZXIgZGVmaW5lZCIpOwogICAgfQogICAgcmV0dXJuIHJlbmRlcmVyOwogIH0KCiAgcmV0dXJuIGdldFJlbmRlcmVyKG9wdGlvbnMucmVuZGVyZXIpKHBhcnNlUXVldWUsIG9wdGlvbnMsIGRvY3VtZW50LCBjcmVhdGVSZW5kZXJRdWV1ZShwYXJzZVF1ZXVlLnN0YWNrKSwgX2h0bWwyY2FudmFzKTsKfTsKCl9odG1sMmNhbnZhcy5VdGlsLlN1cHBvcnQgPSBmdW5jdGlvbiAob3B0aW9ucywgZG9jKSB7CgogIGZ1bmN0aW9uIHN1cHBvcnRTVkdSZW5kZXJpbmcoKSB7CiAgICB2YXIgaW1nID0gbmV3IEltYWdlKCksCiAgICBjYW52YXMgPSBkb2MuY3JlYXRlRWxlbWVudCgiY2FudmFzIiksCiAgICBjdHggPSAoY2FudmFzLmdldENvbnRleHQgPT09IHVuZGVmaW5lZCkgPyBmYWxzZSA6IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIpOwogICAgaWYgKGN0eCA9PT0gZmFsc2UpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgY2FudmFzLndpZHRoID0gY2FudmFzLmhlaWdodCA9IDEwOwogICAgaW1nLnNyYyA9IFsKICAgICJkYXRhOmltYWdlL3N2Zyt4bWwsIiwKICAgICI8c3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgd2lkdGg9JzEwJyBoZWlnaHQ9JzEwJz4iLAogICAgIjxmb3JlaWduT2JqZWN0IHdpZHRoPScxMCcgaGVpZ2h0PScxMCc+IiwKICAgICI8ZGl2IHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sJyBzdHlsZT0nd2lkdGg6MTA7aGVpZ2h0OjEwOyc+IiwKICAgICJzdXAiLAogICAgIjwvZGl2PiIsCiAgICAiPC9mb3JlaWduT2JqZWN0PiIsCiAgICAiPC9zdmc+IgogICAgXS5qb2luKCIiKTsKICAgIHRyeSB7CiAgICAgIGN0eC5kcmF3SW1hZ2UoaW1nLCAwLCAwKTsKICAgICAgY2FudmFzLnRvRGF0YVVSTCgpOwogICAgfSBjYXRjaChlKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIF9odG1sMmNhbnZhcy5VdGlsLmxvZygnaHRtbDJjYW52YXM6IFBhcnNlOiBTVkcgcG93ZXJlZCByZW5kZXJpbmcgYXZhaWxhYmxlJyk7CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIC8vIFRlc3Qgd2hldGhlciB3ZSBjYW4gdXNlIHJhbmdlcyB0byBtZWFzdXJlIGJvdW5kaW5nIGJveGVzCiAgLy8gT3BlcmEgZG9lc24ndCBwcm92aWRlIHZhbGlkIGJvdW5kcy5oZWlnaHQvYm90dG9tIGV2ZW4gdGhvdWdoIGl0IHN1cHBvcnRzIHRoZSBtZXRob2QuCgogIGZ1bmN0aW9uIHN1cHBvcnRSYW5nZUJvdW5kcygpIHsKICAgIHZhciByLCB0ZXN0RWxlbWVudCwgcmFuZ2VCb3VuZHMsIHJhbmdlSGVpZ2h0LCBzdXBwb3J0ID0gZmFsc2U7CgogICAgaWYgKGRvYy5jcmVhdGVSYW5nZSkgewogICAgICByID0gZG9jLmNyZWF0ZVJhbmdlKCk7CiAgICAgIGlmIChyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCkgewogICAgICAgIHRlc3RFbGVtZW50ID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2JvdW5kdGVzdCcpOwogICAgICAgIHRlc3RFbGVtZW50LnN0eWxlLmhlaWdodCA9ICIxMjNweCI7CiAgICAgICAgdGVzdEVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICAgICAgZG9jLmJvZHkuYXBwZW5kQ2hpbGQodGVzdEVsZW1lbnQpOwoKICAgICAgICByLnNlbGVjdE5vZGUodGVzdEVsZW1lbnQpOwogICAgICAgIHJhbmdlQm91bmRzID0gci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICByYW5nZUhlaWdodCA9IHJhbmdlQm91bmRzLmhlaWdodDsKCiAgICAgICAgaWYgKHJhbmdlSGVpZ2h0ID09PSAxMjMpIHsKICAgICAgICAgIHN1cHBvcnQgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBkb2MuYm9keS5yZW1vdmVDaGlsZCh0ZXN0RWxlbWVudCk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gc3VwcG9ydDsKICB9CgogIHJldHVybiB7CiAgICByYW5nZUJvdW5kczogc3VwcG9ydFJhbmdlQm91bmRzKCksCiAgICBzdmdSZW5kZXJpbmc6IG9wdGlvbnMuc3ZnUmVuZGVyaW5nICYmIHN1cHBvcnRTVkdSZW5kZXJpbmcoKQogIH07Cn07CndpbmRvdy5odG1sMmNhbnZhcyA9IGZ1bmN0aW9uKGVsZW1lbnRzLCBvcHRzKSB7CiAgZWxlbWVudHMgPSAoZWxlbWVudHMubGVuZ3RoKSA/IGVsZW1lbnRzIDogW2VsZW1lbnRzXTsKICB2YXIgcXVldWUsCiAgY2FudmFzLAogIG9wdGlvbnMgPSB7CiAgICAvLyBnZW5lcmFsCiAgICBsb2dnaW5nOiBmYWxzZSwKICAgIGVsZW1lbnRzOiBlbGVtZW50cywKICAgIGJhY2tncm91bmQ6ICIjZmZmIiwKCiAgICAvLyBwcmVsb2FkIG9wdGlvbnMKICAgIHByb3h5OiBudWxsLAogICAgdGltZW91dDogMCwgICAgLy8gbm8gdGltZW91dAogICAgdXNlQ09SUzogZmFsc2UsIC8vIHRyeSB0byBsb2FkIGltYWdlcyBhcyBDT1JTICh3aGVyZSBhdmFpbGFibGUpLCBiZWZvcmUgZmFsbGluZyBiYWNrIHRvIHByb3h5CiAgICBhbGxvd1RhaW50OiBmYWxzZSwgLy8gd2hldGhlciB0byBhbGxvdyBpbWFnZXMgdG8gdGFpbnQgdGhlIGNhbnZhcywgd29uJ3QgbmVlZCBwcm94eSBpZiBzZXQgdG8gdHJ1ZQoKICAgIC8vIHBhcnNlIG9wdGlvbnMKICAgIHN2Z1JlbmRlcmluZzogZmFsc2UsIC8vIHVzZSBzdmcgcG93ZXJlZCByZW5kZXJpbmcgd2hlcmUgYXZhaWxhYmxlIChGRjExKykKICAgIGlnbm9yZUVsZW1lbnRzOiAiSUZSQU1FfE9CSkVDVHxQQVJBTSIsCiAgICB1c2VPdmVyZmxvdzogdHJ1ZSwKICAgIGxldHRlclJlbmRlcmluZzogZmFsc2UsCiAgICBjaGluZXNlOiBmYWxzZSwKICAgIGFzeW5jOiBmYWxzZSwgLy8gSWYgdHJ1ZSwgcGFyc2luZyB3aWxsIG5vdCBibG9jaywgYnV0IGlmIHRoZSB1c2VyIHNjcm9sbHMgZHVyaW5nIHBhcnNlIHRoZSBpbWFnZSBjYW4gZ2V0IHdlaXJkCgogICAgLy8gcmVuZGVyIG9wdGlvbnMKICAgIHdpZHRoOiBudWxsLAogICAgaGVpZ2h0OiBudWxsLAogICAgdGFpbnRUZXN0OiB0cnVlLCAvLyBkbyBhIHRhaW50IHRlc3Qgd2l0aCBhbGwgaW1hZ2VzIGJlZm9yZSBhcHBseWluZyB0byBjYW52YXMKICAgIHJlbmRlcmVyOiAiQ2FudmFzIgogIH07CgogIG9wdGlvbnMgPSBfaHRtbDJjYW52YXMuVXRpbC5FeHRlbmQob3B0cywgb3B0aW9ucyk7CgogIF9odG1sMmNhbnZhcy5sb2dnaW5nID0gb3B0aW9ucy5sb2dnaW5nOwogIG9wdGlvbnMuY29tcGxldGUgPSBmdW5jdGlvbiggaW1hZ2VzICkgewoKICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5vbnByZWxvYWRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICBpZiAoIG9wdGlvbnMub25wcmVsb2FkZWQoIGltYWdlcyApID09PSBmYWxzZSApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICAgIF9odG1sMmNhbnZhcy5QYXJzZSggaW1hZ2VzLCBvcHRpb25zLCBmdW5jdGlvbihxdWV1ZSkgewogICAgICBpZiAodHlwZW9mIG9wdGlvbnMub25wYXJzZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBpZiAoIG9wdGlvbnMub25wYXJzZWQoIHF1ZXVlICkgPT09IGZhbHNlICkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQoKICAgICAgY2FudmFzID0gX2h0bWwyY2FudmFzLlJlbmRlcmVyKCBxdWV1ZSwgb3B0aW9ucyApOwoKICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLm9ucmVuZGVyZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBvcHRpb25zLm9ucmVuZGVyZWQoIGNhbnZhcyApOwogICAgICB9CiAgICB9KTsKICB9OwoKICAvLyBmb3IgcGFnZXMgd2l0aG91dCBpbWFnZXMsIHdlIHN0aWxsIHdhbnQgdGhpcyB0byBiZSBhc3luYywgaS5lLiByZXR1cm4gbWV0aG9kcyBiZWZvcmUgZXhlY3V0aW5nCiAgd2luZG93LnNldFRpbWVvdXQoIGZ1bmN0aW9uKCl7CiAgICBfaHRtbDJjYW52YXMuUHJlbG9hZCggb3B0aW9ucyApOwogIH0sIDAgKTsKCiAgcmV0dXJuIHsKICAgIHJlbmRlcjogZnVuY3Rpb24oIHF1ZXVlLCBvcHRzICkgewogICAgICByZXR1cm4gX2h0bWwyY2FudmFzLlJlbmRlcmVyKCBxdWV1ZSwgX2h0bWwyY2FudmFzLlV0aWwuRXh0ZW5kKG9wdHMsIG9wdGlvbnMpICk7CiAgICB9LAogICAgcGFyc2U6IGZ1bmN0aW9uKCBpbWFnZXMsIG9wdHMgKSB7CiAgICAgIHJldHVybiBfaHRtbDJjYW52YXMuUGFyc2UoIGltYWdlcywgX2h0bWwyY2FudmFzLlV0aWwuRXh0ZW5kKG9wdHMsIG9wdGlvbnMpICk7CiAgICB9LAogICAgcHJlbG9hZDogZnVuY3Rpb24oIG9wdHMgKSB7CiAgICAgIHJldHVybiBfaHRtbDJjYW52YXMuUHJlbG9hZCggX2h0bWwyY2FudmFzLlV0aWwuRXh0ZW5kKG9wdHMsIG9wdGlvbnMpICk7CiAgICB9LAogICAgbG9nOiBfaHRtbDJjYW52YXMuVXRpbC5sb2cKICB9Owp9OwoKd2luZG93Lmh0bWwyY2FudmFzLmxvZyA9IF9odG1sMmNhbnZhcy5VdGlsLmxvZzsgLy8gZm9yIHJlbmRlcmVycwp3aW5kb3cuaHRtbDJjYW52YXMuUmVuZGVyZXIgPSB7CiAgQ2FudmFzOiB1bmRlZmluZWQgLy8gV2UgYXJlIGFzc3VtaW5nIHRoaXMgd2lsbCBiZSB1c2VkCn07Cl9odG1sMmNhbnZhcy5SZW5kZXJlci5DYW52YXMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogIHZhciBkb2MgPSBkb2N1bWVudCwKICBzYWZlSW1hZ2VzID0gW10sCiAgdGVzdENhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpLAogIHRlc3RjdHggPSB0ZXN0Q2FudmFzLmdldENvbnRleHQoIjJkIiksCiAgVXRpbCA9IF9odG1sMmNhbnZhcy5VdGlsLAogIGNhbnZhcyA9IG9wdGlvbnMuY2FudmFzIHx8IGRvYy5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKCiAgZnVuY3Rpb24gY3JlYXRlU2hhcGUoY3R4LCBhcmdzKSB7CiAgICBjdHguYmVnaW5QYXRoKCk7CiAgICBhcmdzLmZvckVhY2goZnVuY3Rpb24oYXJnKSB7CiAgICAgIGN0eFthcmcubmFtZV0uYXBwbHkoY3R4LCBhcmdbJ2FyZ3VtZW50cyddKTsKICAgIH0pOwogICAgY3R4LmNsb3NlUGF0aCgpOwogIH0KCiAgZnVuY3Rpb24gc2FmZUltYWdlKGl0ZW0pIHsKICAgIGlmIChzYWZlSW1hZ2VzLmluZGV4T2YoaXRlbVsnYXJndW1lbnRzJ11bMF0uc3JjKSA9PT0gLTEpIHsKICAgICAgdGVzdGN0eC5kcmF3SW1hZ2UoaXRlbVsnYXJndW1lbnRzJ11bMF0sIDAsIDApOwogICAgICB0cnkgewogICAgICAgIHRlc3RjdHguZ2V0SW1hZ2VEYXRhKDAsIDAsIDEsIDEpOwogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICB0ZXN0Q2FudmFzID0gZG9jLmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpOwogICAgICAgIHRlc3RjdHggPSB0ZXN0Q2FudmFzLmdldENvbnRleHQoIjJkIik7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHNhZmVJbWFnZXMucHVzaChpdGVtWydhcmd1bWVudHMnXVswXS5zcmMpOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQoKICBmdW5jdGlvbiByZW5kZXJJdGVtKGN0eCwgaXRlbSkgewogICAgc3dpdGNoKGl0ZW0udHlwZSl7CiAgICAgIGNhc2UgInZhcmlhYmxlIjoKICAgICAgICBjdHhbaXRlbS5uYW1lXSA9IGl0ZW1bJ2FyZ3VtZW50cyddOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJmdW5jdGlvbiI6CiAgICAgICAgc3dpdGNoKGl0ZW0ubmFtZSkgewogICAgICAgICAgY2FzZSAiY3JlYXRlUGF0dGVybiI6CiAgICAgICAgICAgIGlmIChpdGVtWydhcmd1bWVudHMnXVswXS53aWR0aCA+IDAgJiYgaXRlbVsnYXJndW1lbnRzJ11bMF0uaGVpZ2h0ID4gMCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gY3R4LmNyZWF0ZVBhdHRlcm4oaXRlbVsnYXJndW1lbnRzJ11bMF0sICJyZXBlYXQiKTsKICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgIFV0aWwubG9nKCJodG1sMmNhbnZhczogUmVuZGVyZXI6IEVycm9yIGNyZWF0aW5nIHBhdHRlcm4iLCBlLm1lc3NhZ2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgImRyYXdTaGFwZSI6CiAgICAgICAgICAgIGNyZWF0ZVNoYXBlKGN0eCwgaXRlbVsnYXJndW1lbnRzJ10pOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgImRyYXdJbWFnZSI6CiAgICAgICAgICAgIGlmIChpdGVtWydhcmd1bWVudHMnXVs4XSA+IDAgJiYgaXRlbVsnYXJndW1lbnRzJ11bN10gPiAwKSB7CiAgICAgICAgICAgICAgaWYgKCFvcHRpb25zLnRhaW50VGVzdCB8fCAob3B0aW9ucy50YWludFRlc3QgJiYgc2FmZUltYWdlKGl0ZW0pKSkgewogICAgICAgICAgICAgICAgY3R4LmRyYXdJbWFnZS5hcHBseSggY3R4LCBpdGVtWydhcmd1bWVudHMnXSApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGN0eFtpdGVtLm5hbWVdLmFwcGx5KGN0eCwgaXRlbVsnYXJndW1lbnRzJ10pOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBmdW5jdGlvbihwYXJzZWREYXRhLCBvcHRpb25zLCBkb2N1bWVudCwgcXVldWUsIF9odG1sMmNhbnZhcykgewogICAgdmFyIGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIpLAogICAgbmV3Q2FudmFzLAogICAgYm91bmRzLAogICAgZnN0eWxlLAogICAgelN0YWNrID0gcGFyc2VkRGF0YS5zdGFjazsKCiAgICBjYW52YXMud2lkdGggPSBjYW52YXMuc3R5bGUud2lkdGggPSAgb3B0aW9ucy53aWR0aCB8fCB6U3RhY2suY3R4LndpZHRoOwogICAgY2FudmFzLmhlaWdodCA9IGNhbnZhcy5zdHlsZS5oZWlnaHQgPSBvcHRpb25zLmhlaWdodCB8fCB6U3RhY2suY3R4LmhlaWdodDsKCiAgICBmc3R5bGUgPSBjdHguZmlsbFN0eWxlOwogICAgY3R4LmZpbGxTdHlsZSA9IChVdGlsLmlzVHJhbnNwYXJlbnQocGFyc2VkRGF0YS5iYWNrZ3JvdW5kQ29sb3IpICYmIG9wdGlvbnMuYmFja2dyb3VuZCAhPT0gdW5kZWZpbmVkKSA/IG9wdGlvbnMuYmFja2dyb3VuZCA6IHBhcnNlZERhdGEuYmFja2dyb3VuZENvbG9yOwogICAgY3R4LmZpbGxSZWN0KDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7CiAgICBjdHguZmlsbFN0eWxlID0gZnN0eWxlOwogICAgcXVldWUuZm9yRWFjaChmdW5jdGlvbihzdG9yYWdlQ29udGV4dCkgewogICAgICAvLyBzZXQgY29tbW9uIHNldHRpbmdzIGZvciBjYW52YXMKICAgICAgY3R4LnRleHRCYXNlbGluZSA9ICJib3R0b20iOwogICAgICBjdHguc2F2ZSgpOwoKICAgICAgaWYgKHN0b3JhZ2VDb250ZXh0LnRyYW5zZm9ybS5tYXRyaXgpIHsKICAgICAgICBjdHgudHJhbnNsYXRlKHN0b3JhZ2VDb250ZXh0LnRyYW5zZm9ybS5vcmlnaW5bMF0sIHN0b3JhZ2VDb250ZXh0LnRyYW5zZm9ybS5vcmlnaW5bMV0pOwogICAgICAgIGN0eC50cmFuc2Zvcm0uYXBwbHkoY3R4LCBzdG9yYWdlQ29udGV4dC50cmFuc2Zvcm0ubWF0cml4KTsKICAgICAgICBjdHgudHJhbnNsYXRlKC1zdG9yYWdlQ29udGV4dC50cmFuc2Zvcm0ub3JpZ2luWzBdLCAtc3RvcmFnZUNvbnRleHQudHJhbnNmb3JtLm9yaWdpblsxXSk7CiAgICAgIH0KCiAgICAgIGlmIChzdG9yYWdlQ29udGV4dC5jbGlwKXsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4LnJlY3Qoc3RvcmFnZUNvbnRleHQuY2xpcC5sZWZ0LCBzdG9yYWdlQ29udGV4dC5jbGlwLnRvcCwgc3RvcmFnZUNvbnRleHQuY2xpcC53aWR0aCwgc3RvcmFnZUNvbnRleHQuY2xpcC5oZWlnaHQpOwogICAgICAgIGN0eC5jbGlwKCk7CiAgICAgIH0KCiAgICAgIGlmIChzdG9yYWdlQ29udGV4dC5jdHguc3RvcmFnZSkgewogICAgICAgIHN0b3JhZ2VDb250ZXh0LmN0eC5zdG9yYWdlLmZvckVhY2goZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgcmVuZGVySXRlbShjdHgsIGl0ZW0pOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBjdHgucmVzdG9yZSgpOwogICAgfSk7CgogICAgVXRpbC5sb2coImh0bWwyY2FudmFzOiBSZW5kZXJlcjogQ2FudmFzIHJlbmRlcmVyIGRvbmUgLSByZXR1cm5pbmcgY2FudmFzIG9iaiIpOwoKICAgIGlmIChvcHRpb25zLmVsZW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgICBpZiAodHlwZW9mIG9wdGlvbnMuZWxlbWVudHNbMF0gPT09ICJvYmplY3QiICYmIG9wdGlvbnMuZWxlbWVudHNbMF0ubm9kZU5hbWUgIT09ICJCT0RZIikgewogICAgICAgIC8vIGNyb3AgaW1hZ2UgdG8gdGhlIGJvdW5kcyBvZiBzZWxlY3RlZCAoc2luZ2xlKSBlbGVtZW50CiAgICAgICAgYm91bmRzID0gX2h0bWwyY2FudmFzLlV0aWwuQm91bmRzKG9wdGlvbnMuZWxlbWVudHNbMF0pOwogICAgICAgIG5ld0NhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIAoKCSAgICBuZXdDYW52YXMud2lkdGggPSBNYXRoLmNlaWwoYm91bmRzLndpZHRoKTsKICAgICAgICBuZXdDYW52YXMuaGVpZ2h0ID0gTWF0aC5jZWlsKGJvdW5kcy5oZWlnaHQpOwogICAKCSAgY3R4ID0gbmV3Q2FudmFzLmdldENvbnRleHQoIjJkIik7CiAgICAgIGN0eC5kcmF3SW1hZ2UoY2FudmFzLCBib3VuZHMubGVmdCwgYm91bmRzLnRvcCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0LCAwLCAwLCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQpOwoKCQkKCQkKCQljYW52YXMgPSBudWxsOwogICAgICAgIHJldHVybiBuZXdDYW52YXM7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gY2FudmFzOwogIH07Cn07Cn0pKHdpbmRvdyxkb2N1bWVudCk7Cg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 13:37:16 GMT",
                    "Content-Length": "93640",
                    "Date": "Thu, 06 Nov 2014 13:37:19 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}