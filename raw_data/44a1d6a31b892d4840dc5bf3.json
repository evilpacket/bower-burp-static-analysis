{
    "url": "http://localhost:9999/movecodemove/SPA/spa.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statements:<ul><li>var href = location.href.replace(/(javascript:|#).*$/, '');</li><li>location.replace(href + '#' + fragment);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/movecodemove/SPA/spa.js",
                "path": "/movecodemove/SPA/spa.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9tb3ZlY29kZW1vdmUvU1BBL3NwYS5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNTU3NDcNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFNhdCwgMDggTm92IDIwMTQgMDU6MTY6MTcgR01UDQpMYXN0LU1vZGlmaWVkOiBTYXQsIDA4IE5vdiAyMDE0IDA1OjE2OjE3IEdNVA0KDQovKiEKICogRXhvc2tlbGV0b24uanMgMC42LjMKICogKGMpIDIwMTMgUGF1bCBNaWxsZXIgPGh0dHA6Ly9wYXVsbWlsbHIuY29tPgogKiBCYXNlZCBvbiBCYWNrYm9uZS5qcwogKiAoYykgMjAxMC0yMDEzIEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZAogKiBFeG9za2VsZXRvbiBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogRm9yIGFsbCBkZXRhaWxzIGFuZCBkb2N1bWVudGF0aW9uOiA8aHR0cDovL2V4b3Nqcy5jb20+CiAqLwoKKGZ1bmN0aW9uKHJvb3QsIGZhY3RvcnkpIHsKLy8JU2V0IHVwIEJhY2tib25lIGFwcHJvcHJpYXRlbHkgZm9yIHRoZSBlbnZpcm9ubWVudC4KCWlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKCQlkZWZpbmUoJ0V4b3NrZWxldG9uJyxbJ3VuZGVyc2NvcmUnLCAnanF1ZXJ5JywgJ2V4cG9ydHMnXSwgZnVuY3Rpb24oXywgJCwgZXhwb3J0cykgewoJCQlyb290LkJhY2tib25lID0gcm9vdC5FeG9za2VsZXRvbiA9IGZhY3Rvcnkocm9vdCwgZXhwb3J0cywgXywgJCk7CgkJfSk7Cgl9IGVsc2UgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewoJCXZhciBfLCAkOwoJCXRyeSB7IF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyk7IH0gY2F0Y2goZSkgeyB9CgkJdHJ5IHsgJCA9IHJlcXVpcmUoJ2pxdWVyeScpOyB9IGNhdGNoKGUpIHsgfQoJCWZhY3Rvcnkocm9vdCwgZXhwb3J0cywgXywgJCk7Cgl9IGVsc2UgewoJCXJvb3QuQmFja2JvbmUgPSByb290LkV4b3NrZWxldG9uID0gZmFjdG9yeShyb290LCB7fSwgcm9vdC5fLCAocm9vdC5qUXVlcnkgfHwgcm9vdC5aZXB0byB8fCByb290LmVuZGVyIHx8IHJvb3QuJCkpOwoJfQoKfSkodGhpcywgZnVuY3Rpb24ocm9vdCwgQmFja2JvbmUsIF8sICQpIHsKCQoKLy8JSW5pdGlhbCBTZXR1cAovLwktLS0tLS0tLS0tLS0tCgovLwlTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYEJhY2tib25lYCB2YXJpYWJsZSwgc28gdGhhdCBpdCBjYW4gYmUKLy8JcmVzdG9yZWQgbGF0ZXIgb24sIGlmIGBub0NvbmZsaWN0YCBpcyB1c2VkLgoJdmFyIHByZXZpb3VzQmFja2JvbmUgPSByb290LkJhY2tib25lOwoJdmFyIHByZXZpb3VzRXhvc2tlbGV0b24gPSByb290LkV4b3NrZWxldG9uOwoKLy8JVW5kZXJzY29yZSByZXBsYWNlbWVudC4KCXZhciB1dGlscyA9IEJhY2tib25lLnV0aWxzID0gXyA9IChfIHx8IHt9KTsKCi8vCUhvbGQgb250byBhIGxvY2FsIHJlZmVyZW5jZSB0byBgJGAuIENhbiBiZSBjaGFuZ2VkIGF0IGFueSBwb2ludC4KCUJhY2tib25lLiQgPSAkOwoKLy8JQ3JlYXRlIGxvY2FsIHJlZmVyZW5jZXMgdG8gYXJyYXkgbWV0aG9kcyB3ZSdsbCB3YW50IHRvIHVzZSBsYXRlci4KCXZhciBhcnJheSA9IFtdOwoJdmFyIHB1c2ggPSBhcnJheS5wdXNoOwoJdmFyIHNsaWNlID0gYXJyYXkuc2xpY2U7Cgl2YXIgdG9TdHJpbmcgPSAoe30pLnRvU3RyaW5nOwoKLy8JQ3VycmVudCB2ZXJzaW9uIG9mIHRoZSBsaWJyYXJ5LiBLZWVwIGluIHN5bmMgd2l0aCBgcGFja2FnZS5qc29uYC4KLy8JQmFja2JvbmUuVkVSU0lPTiA9ICcxLjAuMCc7CgovLwlSdW5zIEJhY2tib25lLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUKLy8JdG8gaXRzIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoaXMgQmFja2JvbmUgb2JqZWN0LgoJQmFja2JvbmUubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewoJCXJvb3QuQmFja2JvbmUgPSBwcmV2aW91c0JhY2tib25lOwoJCXJvb3QuRXhvc2tlbGV0b24gPSBwcmV2aW91c0V4b3NrZWxldG9uOwoJCXJldHVybiB0aGlzOwoJfTsKCi8vCUhlbHBlcnMKLy8JLS0tLS0tLQoKLy8JSGVscGVyIGZ1bmN0aW9uIHRvIGNvcnJlY3RseSBzZXQgdXAgdGhlIHByb3RvdHlwZSBjaGFpbiwgZm9yIHN1YmNsYXNzZXMuCi8vCVNpbWlsYXIgdG8gYGdvb2cuaW5oZXJpdHNgLCBidXQgdXNlcyBhIGhhc2ggb2YgcHJvdG90eXBlIHByb3BlcnRpZXMgYW5kCi8vCWNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuCglCYWNrYm9uZS5leHRlbmQgPSBmdW5jdGlvbihwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgewoJCXZhciBwYXJlbnQgPSB0aGlzOwoJCXZhciBjaGlsZDsKCgkJLy8gVGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciB0aGUgbmV3IHN1YmNsYXNzIGlzIGVpdGhlciBkZWZpbmVkIGJ5IHlvdQoJCS8vICh0aGUgImNvbnN0cnVjdG9yIiBwcm9wZXJ0eSBpbiB5b3VyIGBleHRlbmRgIGRlZmluaXRpb24pLCBvciBkZWZhdWx0ZWQKCQkvLyBieSB1cyB0byBzaW1wbHkgY2FsbCB0aGUgcGFyZW50J3MgY29uc3RydWN0b3IuCgkJaWYgKHByb3RvUHJvcHMgJiYgaGFzT3duUHJvcGVydHkuY2FsbChwcm90b1Byb3BzLCAnY29uc3RydWN0b3InKSkgewoJCQljaGlsZCA9IHByb3RvUHJvcHMuY29uc3RydWN0b3I7CgkJfSBlbHNlIHsKCQkJY2hpbGQgPSBmdW5jdGlvbigpeyByZXR1cm4gcGFyZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH07CgkJfQoKCQkvLyBBZGQgc3RhdGljIHByb3BlcnRpZXMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLCBpZiBzdXBwbGllZC4KCQlfLmV4dGVuZChjaGlsZCwgcGFyZW50LCBzdGF0aWNQcm9wcyk7CgoJCS8vIFNldCB0aGUgcHJvdG90eXBlIGNoYWluIHRvIGluaGVyaXQgZnJvbSBgcGFyZW50YCwgd2l0aG91dCBjYWxsaW5nCgkJLy8gYHBhcmVudGAncyBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KCQl2YXIgU3Vycm9nYXRlID0gZnVuY3Rpb24oKXsgdGhpcy5jb25zdHJ1Y3RvciA9IGNoaWxkOyB9OwoJCVN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOwoJCWNoaWxkLnByb3RvdHlwZSA9IG5ldyBTdXJyb2dhdGU7CgoJCS8vIEFkZCBwcm90b3R5cGUgcHJvcGVydGllcyAoaW5zdGFuY2UgcHJvcGVydGllcykgdG8gdGhlIHN1YmNsYXNzLAoJCS8vIGlmIHN1cHBsaWVkLgoJCWlmIChwcm90b1Byb3BzKSBfLmV4dGVuZChjaGlsZC5wcm90b3R5cGUsIHByb3RvUHJvcHMpOwoKCQkvLyBTZXQgYSBjb252ZW5pZW5jZSBwcm9wZXJ0eSBpbiBjYXNlIHRoZSBwYXJlbnQncyBwcm90b3R5cGUgaXMgbmVlZGVkCgkJLy8gbGF0ZXIuCgkJY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsKCgkJcmV0dXJuIGNoaWxkOwoJfTsKCi8vCVRocm93IGFuIGVycm9yIHdoZW4gYSBVUkwgaXMgbmVlZGVkLCBhbmQgbm9uZSBpcyBzdXBwbGllZC4KCXZhciB1cmxFcnJvciA9IGZ1bmN0aW9uKCkgewoJCXRocm93IG5ldyBFcnJvcignQSAidXJsIiBwcm9wZXJ0eSBvciBmdW5jdGlvbiBtdXN0IGJlIHNwZWNpZmllZCcpOwoJfTsKCi8vCVdyYXAgYW4gb3B0aW9uYWwgZXJyb3IgY2FsbGJhY2sgd2l0aCBhIGZhbGxiYWNrIGVycm9yIGV2ZW50LgoJdmFyIHdyYXBFcnJvciA9IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CgkJdmFyIGVycm9yID0gb3B0aW9ucy5lcnJvcjsKCQlvcHRpb25zLmVycm9yID0gZnVuY3Rpb24ocmVzcCkgewoJCQlpZiAoZXJyb3IpIGVycm9yKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKCQkJbW9kZWwudHJpZ2dlcignZXJyb3InLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CgkJfTsKCX07CgovLwlDaGVja2VyIGZvciB1dGlsaXR5IG1ldGhvZHMuIFVzZWZ1bCBmb3IgY3VzdG9tIGJ1aWxkcy4KCXZhciB1dGlsRXhpc3RzID0gZnVuY3Rpb24obWV0aG9kKSB7CgkJcmV0dXJuIHR5cGVvZiBfW21ldGhvZF0gPT09ICdmdW5jdGlvbic7Cgl9OwoKCS8qIHV0aWxzICovCgoJdXRpbHMucmVzdWx0ID0gZnVuY3Rpb24gcmVzdWx0KG9iamVjdCwgcHJvcGVydHkpIHsKCQl2YXIgdmFsdWUgPSBvYmplY3QgPyBvYmplY3RbcHJvcGVydHldIDogdW5kZWZpbmVkOwoJCXJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicgPyBvYmplY3RbcHJvcGVydHldKCkgOiB2YWx1ZTsKCX07CgoJdXRpbHMuZGVmYXVsdHMgPSBmdW5jdGlvbiBkZWZhdWx0cyhvYmopIHsKCQlzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkuZm9yRWFjaChmdW5jdGlvbihpdGVtKSB7CgkJCWZvciAodmFyIGtleSBpbiBpdGVtKSBpZiAob2JqW2tleV0gPT09IHVuZGVmaW5lZCkKCQkJCW9ialtrZXldID0gaXRlbVtrZXldOwoJCX0pOwoJCXJldHVybiBvYmo7Cgl9OwoKCXV0aWxzLmV4dGVuZCA9IGZ1bmN0aW9uIGV4dGVuZChvYmopIHsKCQlzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkuZm9yRWFjaChmdW5jdGlvbihpdGVtKSB7CgkJCWZvciAodmFyIGtleSBpbiBpdGVtKSBvYmpba2V5XSA9IGl0ZW1ba2V5XTsKCQl9KTsKCQlyZXR1cm4gb2JqOwoJfTsKCgl2YXIgaHRtbEVzY2FwZXMgPSB7CgkJCScmJzogJyZhbXA7JywKCQkJJzwnOiAnJmx0OycsCgkJCSc+JzogJyZndDsnLAoJCQknIic6ICcmcXVvdDsnLAoJCQkiJyI6ICcmIzM5OycKCX07CgoJdXRpbHMuZXNjYXBlID0gZnVuY3Rpb24gZXNjYXBlKHN0cmluZykgewoJCXJldHVybiBzdHJpbmcgPT0gbnVsbCA/ICcnIDogU3RyaW5nKHN0cmluZykucmVwbGFjZSgvWyY8PiInXS9nLCBmdW5jdGlvbihtYXRjaCkgewoJCQlyZXR1cm4gaHRtbEVzY2FwZXNbbWF0Y2hdOwoJCX0pOwoJfTsKCgl1dGlscy5zb3J0QnkgPSBmdW5jdGlvbihvYmosIHZhbHVlLCBjb250ZXh0KSB7CgkJdmFyIGl0ZXJhdG9yID0gdHlwZW9mIHZhbHVlID09PSAnZnVuY3Rpb24nID8gdmFsdWUgOiBmdW5jdGlvbihvYmopeyByZXR1cm4gb2JqW3ZhbHVlXTsgfTsKCQlyZXR1cm4gb2JqCgkJLm1hcChmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKCQkJcmV0dXJuIHsKCQkJCXZhbHVlOiB2YWx1ZSwKCQkJCWluZGV4OiBpbmRleCwKCQkJCWNyaXRlcmlhOiBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkKCQkJfTsKCQl9KQoJCS5zb3J0KGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CgkJCXZhciBhID0gbGVmdC5jcml0ZXJpYTsKCQkJdmFyIGIgPSByaWdodC5jcml0ZXJpYTsKCQkJaWYgKGEgIT09IGIpIHsKCQkJCWlmIChhID4gYiB8fCBhID09PSB2b2lkIDApIHJldHVybiAxOwoJCQkJaWYgKGEgPCBiIHx8IGIgPT09IHZvaWQgMCkgcmV0dXJuIC0xOwoJCQl9CgkJCXJldHVybiBsZWZ0LmluZGV4IC0gcmlnaHQuaW5kZXg7CgkJfSkKCQkubWFwKGZ1bmN0aW9uKGl0ZW0pIHsKCQkJcmV0dXJuIGl0ZW0udmFsdWU7CgkJfSk7Cgl9OwoKCS8qKiBVc2VkIHRvIGdlbmVyYXRlIHVuaXF1ZSBJRHMgKi8KCXZhciBpZENvdW50ZXIgPSAwOwoKCXV0aWxzLnVuaXF1ZUlkID0gZnVuY3Rpb24gdW5pcXVlSWQocHJlZml4KSB7CgkJdmFyIGlkID0gKytpZENvdW50ZXIgKyAnJzsKCQlyZXR1cm4gcHJlZml4ID8gcHJlZml4ICsgaWQgOiBpZDsKCX07CgoJdmFyIGVxID0gZnVuY3Rpb24oYSwgYiwgYVN0YWNrLCBiU3RhY2spIHsKCQkvLyBJZGVudGljYWwgb2JqZWN0cyBhcmUgZXF1YWwuIGAwID09PSAtMGAsIGJ1dCB0aGV5IGFyZW4ndCBpZGVudGljYWwuCgkJLy8gU2VlIHRoZSBbSGFybW9ueSBgZWdhbGAgcHJvcG9zYWxdKGh0dHA6Ly93aWtpLmVjbWFzY3JpcHQub3JnL2Rva3UucGhwP2lkPWhhcm1vbnk6ZWdhbCkuCgkJaWYgKGEgPT09IGIpIHJldHVybiBhICE9PSAwIHx8IDEgLyBhID09IDEgLyBiOwoJCS8vIEEgc3RyaWN0IGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5IGJlY2F1c2UgYG51bGwgPT0gdW5kZWZpbmVkYC4KCQlpZiAoYSA9PSBudWxsIHx8IGIgPT0gbnVsbCkgcmV0dXJuIGEgPT09IGI7CgkJLy8gVW53cmFwIGFueSB3cmFwcGVkIG9iamVjdHMuCgkJLy9pZiAoYSBpbnN0YW5jZW9mIF8pIGEgPSBhLl93cmFwcGVkOwoJCS8vaWYgKGIgaW5zdGFuY2VvZiBfKSBiID0gYi5fd3JhcHBlZDsKCQkvLyBDb21wYXJlIGBbW0NsYXNzXV1gIG5hbWVzLgoJCXZhciBjbGFzc05hbWUgPSB0b1N0cmluZy5jYWxsKGEpOwoJCWlmIChjbGFzc05hbWUgIT0gdG9TdHJpbmcuY2FsbChiKSkgcmV0dXJuIGZhbHNlOwoJCXN3aXRjaCAoY2xhc3NOYW1lKSB7CgkJLy8gU3RyaW5ncywgbnVtYmVycywgZGF0ZXMsIGFuZCBib29sZWFucyBhcmUgY29tcGFyZWQgYnkgdmFsdWUuCgkJY2FzZSAnW29iamVjdCBTdHJpbmddJzoKCQkJLy8gUHJpbWl0aXZlcyBhbmQgdGhlaXIgY29ycmVzcG9uZGluZyBvYmplY3Qgd3JhcHBlcnMgYXJlIGVxdWl2YWxlbnQ7IHRodXMsIGAiNSJgIGlzCgkJCS8vIGVxdWl2YWxlbnQgdG8gYG5ldyBTdHJpbmcoIjUiKWAuCgkJCXJldHVybiBhID09IFN0cmluZyhiKTsKCQljYXNlICdbb2JqZWN0IE51bWJlcl0nOgoJCQkvLyBgTmFOYHMgYXJlIGVxdWl2YWxlbnQsIGJ1dCBub24tcmVmbGV4aXZlLiBBbiBgZWdhbGAgY29tcGFyaXNvbiBpcyBwZXJmb3JtZWQgZm9yCgkJCS8vIG90aGVyIG51bWVyaWMgdmFsdWVzLgoJCQlyZXR1cm4gYSAhPT0gK2EgPyBiICE9PSArYiA6IChhID09PSAwID8gMSAvIGEgPT09IDEgLyBiIDogYSA9PT0gK2IpOwoJCWNhc2UgJ1tvYmplY3QgRGF0ZV0nOgoJCWNhc2UgJ1tvYmplY3QgQm9vbGVhbl0nOgoJCQkvLyBDb2VyY2UgZGF0ZXMgYW5kIGJvb2xlYW5zIHRvIG51bWVyaWMgcHJpbWl0aXZlIHZhbHVlcy4gRGF0ZXMgYXJlIGNvbXBhcmVkIGJ5IHRoZWlyCgkJCS8vIG1pbGxpc2Vjb25kIHJlcHJlc2VudGF0aW9ucy4gTm90ZSB0aGF0IGludmFsaWQgZGF0ZXMgd2l0aCBtaWxsaXNlY29uZCByZXByZXNlbnRhdGlvbnMKCQkJLy8gb2YgYE5hTmAgYXJlIG5vdCBlcXVpdmFsZW50LgoJCQlyZXR1cm4gK2EgPT0gK2I7CgkJCS8vIFJlZ0V4cHMgYXJlIGNvbXBhcmVkIGJ5IHRoZWlyIHNvdXJjZSBwYXR0ZXJucyBhbmQgZmxhZ3MuCgkJY2FzZSAnW29iamVjdCBSZWdFeHBdJzoKCQkJcmV0dXJuIGEuc291cmNlID09IGIuc291cmNlICYmCgkJCWEuZ2xvYmFsID09IGIuZ2xvYmFsICYmCgkJCWEubXVsdGlsaW5lID09IGIubXVsdGlsaW5lICYmCgkJCWEuaWdub3JlQ2FzZSA9PSBiLmlnbm9yZUNhc2U7CgkJfQoJCWlmICh0eXBlb2YgYSAhPSAnb2JqZWN0JyB8fCB0eXBlb2YgYiAhPSAnb2JqZWN0JykgcmV0dXJuIGZhbHNlOwoJCS8vIEFzc3VtZSBlcXVhbGl0eSBmb3IgY3ljbGljIHN0cnVjdHVyZXMuIFRoZSBhbGdvcml0aG0gZm9yIGRldGVjdGluZyBjeWNsaWMKCQkvLyBzdHJ1Y3R1cmVzIGlzIGFkYXB0ZWQgZnJvbSBFUyA1LjEgc2VjdGlvbiAxNS4xMi4zLCBhYnN0cmFjdCBvcGVyYXRpb24gYEpPYC4KCQl2YXIgbGVuZ3RoID0gYVN0YWNrLmxlbmd0aDsKCQl3aGlsZSAobGVuZ3RoLS0pIHsKCQkJLy8gTGluZWFyIHNlYXJjaC4gUGVyZm9ybWFuY2UgaXMgaW52ZXJzZWx5IHByb3BvcnRpb25hbCB0byB0aGUgbnVtYmVyIG9mCgkJCS8vIHVuaXF1ZSBuZXN0ZWQgc3RydWN0dXJlcy4KCQkJaWYgKGFTdGFja1tsZW5ndGhdID09IGEpIHJldHVybiBiU3RhY2tbbGVuZ3RoXSA9PSBiOwoJCX0KCQkvLyBPYmplY3RzIHdpdGggZGlmZmVyZW50IGNvbnN0cnVjdG9ycyBhcmUgbm90IGVxdWl2YWxlbnQsIGJ1dCBgT2JqZWN0YHMKCQkvLyBmcm9tIGRpZmZlcmVudCBmcmFtZXMgYXJlLgoJCXZhciBhQ3RvciA9IGEuY29uc3RydWN0b3IsIGJDdG9yID0gYi5jb25zdHJ1Y3RvcjsKCQlpZiAoYUN0b3IgIT09IGJDdG9yICYmICEodHlwZW9mIGFDdG9yID09PSAnZnVuY3Rpb24nICYmIChhQ3RvciBpbnN0YW5jZW9mIGFDdG9yKSAmJgoJCQkJdHlwZW9mIGJDdG9yID09PSAnZnVuY3Rpb24nICYmIChiQ3RvciBpbnN0YW5jZW9mIGJDdG9yKSkpIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQkvLyBBZGQgdGhlIGZpcnN0IG9iamVjdCB0byB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMuCgkJYVN0YWNrLnB1c2goYSk7CgkJYlN0YWNrLnB1c2goYik7CgkJdmFyIHNpemUgPSAwLCByZXN1bHQgPSB0cnVlOwoJCS8vIFJlY3Vyc2l2ZWx5IGNvbXBhcmUgb2JqZWN0cyBhbmQgYXJyYXlzLgoJCWlmIChjbGFzc05hbWUgPT09ICdbb2JqZWN0IEFycmF5XScpIHsKCQkJLy8gQ29tcGFyZSBhcnJheSBsZW5ndGhzIHRvIGRldGVybWluZSBpZiBhIGRlZXAgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkuCgkJCXNpemUgPSBhLmxlbmd0aDsKCQkJcmVzdWx0ID0gc2l6ZSA9PT0gYi5sZW5ndGg7CgkJCWlmIChyZXN1bHQpIHsKCQkJCS8vIERlZXAgY29tcGFyZSB0aGUgY29udGVudHMsIGlnbm9yaW5nIG5vbi1udW1lcmljIHByb3BlcnRpZXMuCgkJCQl3aGlsZSAoc2l6ZS0tKSB7CgkJCQkJaWYgKCEocmVzdWx0ID0gZXEoYVtzaXplXSwgYltzaXplXSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CgkJCQl9CgkJCX0KCQl9IGVsc2UgewoJCQkvLyBEZWVwIGNvbXBhcmUgb2JqZWN0cy4KCQkJZm9yICh2YXIga2V5IGluIGEpIHsKCQkJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGEsIGtleSkpIHsKCQkJCQkvLyBDb3VudCB0aGUgZXhwZWN0ZWQgbnVtYmVyIG9mIHByb3BlcnRpZXMuCgkJCQkJc2l6ZSsrOwoJCQkJCS8vIERlZXAgY29tcGFyZSBlYWNoIG1lbWJlci4KCQkJCQlpZiAoIShyZXN1bHQgPSBoYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIGtleSkgJiYgZXEoYVtrZXldLCBiW2tleV0sIGFTdGFjaywgYlN0YWNrKSkpIGJyZWFrOwoJCQkJfQoJCQl9CgkJCS8vIEVuc3VyZSB0aGF0IGJvdGggb2JqZWN0cyBjb250YWluIHRoZSBzYW1lIG51bWJlciBvZiBwcm9wZXJ0aWVzLgoJCQlpZiAocmVzdWx0KSB7CgkJCQlmb3IgKGtleSBpbiBiKSB7CgkJCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwoYiwga2V5KSAmJiAhKHNpemUtLSkpIGJyZWFrOwoJCQkJfQoJCQkJcmVzdWx0ID0gIXNpemU7CgkJCX0KCQl9CgkJLy8gUmVtb3ZlIHRoZSBmaXJzdCBvYmplY3QgZnJvbSB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMuCgkJYVN0YWNrLnBvcCgpOwoJCWJTdGFjay5wb3AoKTsKCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkvLyBQZXJmb3JtIGEgZGVlcCBjb21wYXJpc29uIHRvIGNoZWNrIGlmIHR3byBvYmplY3RzIGFyZSBlcXVhbC4KCXV0aWxzLmlzRXF1YWwgPSBmdW5jdGlvbihhLCBiKSB7CgkJcmV0dXJuIGVxKGEsIGIsIFtdLCBbXSk7Cgl9OwoKCS8qIGV2ZW50cyAqLwoKCS8vIEJhY2tib25lLkV2ZW50cwoJLy8gLS0tLS0tLS0tLS0tLS0tCgoJLy8gQSBtb2R1bGUgdGhhdCBjYW4gYmUgbWl4ZWQgaW4gdG8gKmFueSBvYmplY3QqIGluIG9yZGVyIHRvIHByb3ZpZGUgaXQgd2l0aAoJLy8gY3VzdG9tIGV2ZW50cy4gWW91IG1heSBiaW5kIHdpdGggYG9uYCBvciByZW1vdmUgd2l0aCBgb2ZmYCBjYWxsYmFjawoJLy8gZnVuY3Rpb25zIHRvIGFuIGV2ZW50OyBgdHJpZ2dlcmAtaW5nIGFuIGV2ZW50IGZpcmVzIGFsbCBjYWxsYmFja3MgaW4KCS8vIHN1Y2Nlc3Npb24uCgkvLwovLwl2YXIgb2JqZWN0ID0ge307Ci8vCV8uZXh0ZW5kKG9iamVjdCwgQmFja2JvbmUuRXZlbnRzKTsKLy8Jb2JqZWN0Lm9uKCdleHBhbmQnLCBmdW5jdGlvbigpeyBhbGVydCgnZXhwYW5kZWQnKTsgfSk7Ci8vCW9iamVjdC50cmlnZ2VyKCdleHBhbmQnKTsKCS8vCgl2YXIgRXZlbnRzID0gQmFja2JvbmUuRXZlbnRzID0gewoKCQkJLy8gQmluZCBhbiBldmVudCB0byBhIGBjYWxsYmFja2AgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQKCQkJLy8gdGhlIGNhbGxiYWNrIHRvIGFsbCBldmVudHMgZmlyZWQuCgkJCW9uOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewoJCQkJaWYgKCFldmVudHNBcGkodGhpcywgJ29uJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkgfHwgIWNhbGxiYWNrKQoJCQkJCXJldHVybiB0aGlzOwoJCQkJdGhpcy5fZXZlbnRzIHx8ICh0aGlzLl9ldmVudHMgPSB7fSk7CgkJCQl2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdIHx8ICh0aGlzLl9ldmVudHNbbmFtZV0gPSBbXSk7CgkJCQlldmVudHMucHVzaCh7Y2FsbGJhY2s6IGNhbGxiYWNrLCBjb250ZXh0OiBjb250ZXh0LCBjdHg6IGNvbnRleHQgfHwgdGhpc30pOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgoJCQkvLyBCaW5kIGFuIGV2ZW50IHRvIG9ubHkgYmUgdHJpZ2dlcmVkIGEgc2luZ2xlIHRpbWUuIEFmdGVyIHRoZSBmaXJzdCB0aW1lCgkJCS8vIHRoZSBjYWxsYmFjayBpcyBpbnZva2VkLCBpdCB3aWxsIGJlIHJlbW92ZWQuCgkJCW9uY2U6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CgkJCQlpZiAoIWV2ZW50c0FwaSh0aGlzLCAnb25jZScsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pIHx8ICFjYWxsYmFjaykKCQkJCQlyZXR1cm4gdGhpczsKCQkJCXZhciBzZWxmID0gdGhpczsKCQkJCXZhciByYW47CgoJCQkJdmFyIG9uY2UgPSBmdW5jdGlvbigpIHsKCQkJCQlpZiAocmFuKSByZXR1cm47CgkJCQkJcmFuID0gdHJ1ZTsKCQkJCQlzZWxmLm9mZihuYW1lLCBvbmNlKTsKCQkJCQljYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJCQkJfTsKCQkJCW9uY2UuX2NhbGxiYWNrID0gY2FsbGJhY2s7CgkJCQlyZXR1cm4gdGhpcy5vbihuYW1lLCBvbmNlLCBjb250ZXh0KTsKCQkJfSwKCgkJCS8vIFJlbW92ZSBvbmUgb3IgbWFueSBjYWxsYmFja3MuIElmIGBjb250ZXh0YCBpcyBudWxsLCByZW1vdmVzIGFsbAoJCQkvLyBjYWxsYmFja3Mgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsCgkJCS8vIGNhbGxiYWNrcyBmb3IgdGhlIGV2ZW50LiBJZiBgbmFtZWAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwgYm91bmQKCQkJLy8gY2FsbGJhY2tzIGZvciBhbGwgZXZlbnRzLgoJCQlvZmY6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CgkJCQl2YXIgcmV0YWluLCBldiwgZXZlbnRzLCBuYW1lcywgaSwgbCwgaiwgazsKCQkJCWlmICghdGhpcy5fZXZlbnRzIHx8ICFldmVudHNBcGkodGhpcywgJ29mZicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pKQoJCQkJCXJldHVybiB0aGlzOwoJCQkJaWYgKCFuYW1lICYmICFjYWxsYmFjayAmJiAhY29udGV4dCkgewoJCQkJCXRoaXMuX2V2ZW50cyA9IHVuZGVmaW5lZDsKCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0KCgkJCQluYW1lcyA9IG5hbWUgPyBbbmFtZV0gOiBPYmplY3Qua2V5cyh0aGlzLl9ldmVudHMpOwoJCQkJZm9yIChpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJCQkJCW5hbWUgPSBuYW1lc1tpXTsKCQkJCQlpZiAoZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdKSB7CgkJCQkJCXRoaXMuX2V2ZW50c1tuYW1lXSA9IHJldGFpbiA9IFtdOwoJCQkJCQlpZiAoY2FsbGJhY2sgfHwgY29udGV4dCkgewoJCQkJCQkJZm9yIChqID0gMCwgayA9IGV2ZW50cy5sZW5ndGg7IGogPCBrOyBqKyspIHsKCQkJCQkJCQlldiA9IGV2ZW50c1tqXTsKCQkJCQkJCQlpZiAoKGNhbGxiYWNrICYmIGNhbGxiYWNrICE9PSBldi5jYWxsYmFjayAmJgoJCQkJCQkJCQkJY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrLl9jYWxsYmFjaykgfHwKCQkJCQkJCQkJCShjb250ZXh0ICYmIGNvbnRleHQgIT09IGV2LmNvbnRleHQpKSB7CgkJCQkJCQkJCXJldGFpbi5wdXNoKGV2KTsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJaWYgKCFyZXRhaW4ubGVuZ3RoKSBkZWxldGUgdGhpcy5fZXZlbnRzW25hbWVdOwoJCQkJCX0KCQkJCX0KCgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCgkJCS8vIFRyaWdnZXIgb25lIG9yIG1hbnkgZXZlbnRzLCBmaXJpbmcgYWxsIGJvdW5kIGNhbGxiYWNrcy4gQ2FsbGJhY2tzIGFyZQoJCQkvLyBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQoJCQkvLyAodW5sZXNzIHlvdSdyZSBsaXN0ZW5pbmcgb24gYCJhbGwiYCwgd2hpY2ggd2lsbCBjYXVzZSB5b3VyIGNhbGxiYWNrIHRvCgkJCS8vIHJlY2VpdmUgdGhlIHRydWUgbmFtZSBvZiB0aGUgZXZlbnQgYXMgdGhlIGZpcnN0IGFyZ3VtZW50KS4KCQkJdHJpZ2dlcjogZnVuY3Rpb24obmFtZSkgewoJCQkJaWYgKCF0aGlzLl9ldmVudHMpIHJldHVybiB0aGlzOwoJCQkJdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CgkJCQlpZiAoIWV2ZW50c0FwaSh0aGlzLCAndHJpZ2dlcicsIG5hbWUsIGFyZ3MpKSByZXR1cm4gdGhpczsKCQkJCXZhciBldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV07CgkJCQl2YXIgYWxsRXZlbnRzID0gdGhpcy5fZXZlbnRzLmFsbDsKCQkJCWlmIChldmVudHMpIHRyaWdnZXJFdmVudHMoZXZlbnRzLCBhcmdzKTsKCQkJCWlmIChhbGxFdmVudHMpIHRyaWdnZXJFdmVudHMoYWxsRXZlbnRzLCBhcmd1bWVudHMpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgoJCQkvLyBUZWxsIHRoaXMgb2JqZWN0IHRvIHN0b3AgbGlzdGVuaW5nIHRvIGVpdGhlciBzcGVjaWZpYyBldmVudHMgLi4uIG9yCgkJCS8vIHRvIGV2ZXJ5IG9iamVjdCBpdCdzIGN1cnJlbnRseSBsaXN0ZW5pbmcgdG8uCgkJCXN0b3BMaXN0ZW5pbmc6IGZ1bmN0aW9uKG9iaiwgbmFtZSwgY2FsbGJhY2spIHsKCQkJCXZhciBsaXN0ZW5pbmdUbyA9IHRoaXMuX2xpc3RlbmluZ1RvOwoJCQkJaWYgKCFsaXN0ZW5pbmdUbykgcmV0dXJuIHRoaXM7CgkJCQl2YXIgcmVtb3ZlID0gIW5hbWUgJiYgIWNhbGxiYWNrOwoJCQkJaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIGNhbGxiYWNrID0gdGhpczsKCQkJCWlmIChvYmopIChsaXN0ZW5pbmdUbyA9IHt9KVtvYmouX2xpc3RlbklkXSA9IG9iajsKCQkJCWZvciAodmFyIGlkIGluIGxpc3RlbmluZ1RvKSB7CgkJCQkJb2JqID0gbGlzdGVuaW5nVG9baWRdOwoJCQkJCW9iai5vZmYobmFtZSwgY2FsbGJhY2ssIHRoaXMpOwoJCQkJCWlmIChyZW1vdmUgfHwgIU9iamVjdC5rZXlzKG9iai5fZXZlbnRzKS5sZW5ndGgpIHsKCQkJCQkJZGVsZXRlIHRoaXMuX2xpc3RlbmluZ1RvW2lkXTsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gdGhpczsKCQkJfQoKCX07CgoJLy8gUmVndWxhciBleHByZXNzaW9uIHVzZWQgdG8gc3BsaXQgZXZlbnQgc3RyaW5ncy4KCXZhciBldmVudFNwbGl0dGVyID0gL1xzKy87CgoJLy8gSW1wbGVtZW50IGZhbmN5IGZlYXR1cmVzIG9mIHRoZSBFdmVudHMgQVBJIHN1Y2ggYXMgbXVsdGlwbGUgZXZlbnQKCS8vIG5hbWVzIGAiY2hhbmdlIGJsdXIiYCBhbmQgalF1ZXJ5LXN0eWxlIGV2ZW50IG1hcHMgYHtjaGFuZ2U6IGFjdGlvbn1gCgkvLyBpbiB0ZXJtcyBvZiB0aGUgZXhpc3RpbmcgQVBJLgoJdmFyIGV2ZW50c0FwaSA9IGZ1bmN0aW9uKG9iaiwgYWN0aW9uLCBuYW1lLCByZXN0KSB7CgkJaWYgKCFuYW1lKSByZXR1cm4gdHJ1ZTsKCQl2YXIgYXJyOwoKCQkvLyBIYW5kbGUgZXZlbnQgbWFwcy4KCQlpZiAodHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSB7CgkJCWZvciAodmFyIGtleSBpbiBuYW1lKSB7CgkJCQlhcnIgPSBba2V5LCBuYW1lW2tleV1dOwoJCQkJcHVzaC5hcHBseShhcnIsIHJlc3QpOwoJCQkJb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBhcnIpOwoJCQl9CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCS8vIEhhbmRsZSBzcGFjZSBzZXBhcmF0ZWQgZXZlbnQgbmFtZXMuCgkJaWYgKGV2ZW50U3BsaXR0ZXIudGVzdChuYW1lKSkgewoJCQl2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwoJCQlmb3IgKHZhciBpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJCQkJYXJyID0gW25hbWVzW2ldXTsKCQkJCXB1c2guYXBwbHkoYXJyLCByZXN0KTsKCQkJCW9ialthY3Rpb25dLmFwcGx5KG9iaiwgYXJyKTsKCQkJfQoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQlyZXR1cm4gdHJ1ZTsKCX07CgoJLy8gQSBkaWZmaWN1bHQtdG8tYmVsaWV2ZSwgYnV0IG9wdGltaXplZCBpbnRlcm5hbCBkaXNwYXRjaCBmdW5jdGlvbiBmb3IKCS8vIHRyaWdnZXJpbmcgZXZlbnRzLiBUcmllcyB0byBrZWVwIHRoZSB1c3VhbCBjYXNlcyBzcGVlZHkgKG1vc3QgaW50ZXJuYWwKCS8vIEJhY2tib25lIGV2ZW50cyBoYXZlIDMgYXJndW1lbnRzKS4KCXZhciB0cmlnZ2VyRXZlbnRzID0gZnVuY3Rpb24oZXZlbnRzLCBhcmdzKSB7CgkJdmFyIGV2LCBpID0gLTEsIGwgPSBldmVudHMubGVuZ3RoLCBhMSA9IGFyZ3NbMF0sIGEyID0gYXJnc1sxXSwgYTMgPSBhcmdzWzJdOwoJCXN3aXRjaCAoYXJncy5sZW5ndGgpIHsKCQljYXNlIDA6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4KTsgcmV0dXJuOwoJCWNhc2UgMTogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExKTsgcmV0dXJuOwoJCWNhc2UgMjogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExLCBhMik7IHJldHVybjsKCQljYXNlIDM6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIsIGEzKTsgcmV0dXJuOwoJCWRlZmF1bHQ6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmFwcGx5KGV2LmN0eCwgYXJncyk7CgkJfQoJfTsKCgl2YXIgbGlzdGVuTWV0aG9kcyA9IHtsaXN0ZW5UbzogJ29uJywgbGlzdGVuVG9PbmNlOiAnb25jZSd9OwoKCS8vIEludmVyc2lvbi1vZi1jb250cm9sIHZlcnNpb25zIG9mIGBvbmAgYW5kIGBvbmNlYC4gVGVsbCAqdGhpcyogb2JqZWN0IHRvCgkvLyBsaXN0ZW4gdG8gYW4gZXZlbnQgaW4gYW5vdGhlciBvYmplY3QgLi4uIGtlZXBpbmcgdHJhY2sgb2Ygd2hhdCBpdCdzCgkvLyBsaXN0ZW5pbmcgdG8uCglPYmplY3Qua2V5cyhsaXN0ZW5NZXRob2RzKS5mb3JFYWNoKGZ1bmN0aW9uKG1ldGhvZCkgewoJCXZhciBpbXBsZW1lbnRhdGlvbiA9IGxpc3Rlbk1ldGhvZHNbbWV0aG9kXTsKCQlFdmVudHNbbWV0aG9kXSA9IGZ1bmN0aW9uKG9iaiwgbmFtZSwgY2FsbGJhY2spIHsKCQkJdmFyIGxpc3RlbmluZ1RvID0gdGhpcy5fbGlzdGVuaW5nVG8gfHwgKHRoaXMuX2xpc3RlbmluZ1RvID0ge30pOwoJCQl2YXIgaWQgPSBvYmouX2xpc3RlbklkIHx8IChvYmouX2xpc3RlbklkID0gXy51bmlxdWVJZCgnbCcpKTsKCQkJbGlzdGVuaW5nVG9baWRdID0gb2JqOwoJCQlpZiAoIWNhbGxiYWNrICYmIHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgY2FsbGJhY2sgPSB0aGlzOwoJCQlvYmpbaW1wbGVtZW50YXRpb25dKG5hbWUsIGNhbGxiYWNrLCB0aGlzKTsKCQkJcmV0dXJuIHRoaXM7CgkJfTsKCX0pOwoKCS8vIEFsaWFzZXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgoJRXZlbnRzLmJpbmQgICA9IEV2ZW50cy5vbjsKCUV2ZW50cy51bmJpbmQgPSBFdmVudHMub2ZmOwoKCS8qIHJvdXRlciAqLwoKCS8vIEJhY2tib25lLlJvdXRlcgoJLy8gLS0tLS0tLS0tLS0tLS0tCgoJLy8gUm91dGVycyBtYXAgZmF1eC1VUkxzIHRvIGFjdGlvbnMsIGFuZCBmaXJlIGV2ZW50cyB3aGVuIHJvdXRlcyBhcmUKCS8vIG1hdGNoZWQuIENyZWF0aW5nIGEgbmV3IG9uZSBzZXRzIGl0cyBgcm91dGVzYCBoYXNoLCBpZiBub3Qgc2V0IHN0YXRpY2FsbHkuCgl2YXIgUm91dGVyID0gQmFja2JvbmUuUm91dGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewoJCW9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgkJaWYgKG9wdGlvbnMucm91dGVzKSB0aGlzLnJvdXRlcyA9IG9wdGlvbnMucm91dGVzOwoJCXRoaXMuX2JpbmRSb3V0ZXMoKTsKCQl0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCX07CgoJLy8gQ2FjaGVkIHJlZ3VsYXIgZXhwcmVzc2lvbnMgZm9yIG1hdGNoaW5nIG5hbWVkIHBhcmFtIHBhcnRzIGFuZCBzcGxhdHRlZAoJLy8gcGFydHMgb2Ygcm91dGUgc3RyaW5ncy4KCXZhciBvcHRpb25hbFBhcmFtID0gL1woKC4qPylcKS9nOwoJdmFyIG5hbWVkUGFyYW0gICAgPSAvKFwoXD8pPzpcdysvZzsKCXZhciBzcGxhdFBhcmFtICAgID0gL1wqXHcrL2c7Cgl2YXIgZXNjYXBlUmVnRXhwICA9IC9bXC17fVxbXF0rPy4sXFxcXiR8I1xzXS9nOwoKCXZhciBpc1JlZ0V4cCA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkJcmV0dXJuIHZhbHVlID8gKHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT09ICdbb2JqZWN0IFJlZ0V4cF0nKSA6IGZhbHNlOwoJfTsKCgkvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuUm91dGVyKiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KCV8uZXh0ZW5kKFJvdXRlci5wcm90b3R5cGUsIEV2ZW50cywgewoKCQkvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KCQkvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KCQlpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgoJCS8vIE1hbnVhbGx5IGJpbmQgYSBzaW5nbGUgbmFtZWQgcm91dGUgdG8gYSBjYWxsYmFjay4gRm9yIGV4YW1wbGU6CgkJLy8KCQkvLyAgICAgdGhpcy5yb3V0ZSgnc2VhcmNoLzpxdWVyeS9wOm51bScsICdzZWFyY2gnLCBmdW5jdGlvbihxdWVyeSwgbnVtKSB7CgkJLy8gICAgICAgLi4uCgkJLy8gICAgIH0pOwoJCS8vCgkJcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBuYW1lLCBjYWxsYmFjaykgewoJCQlpZiAoIWlzUmVnRXhwKHJvdXRlKSkgcm91dGUgPSB0aGlzLl9yb3V0ZVRvUmVnRXhwKHJvdXRlKTsKCQkJaWYgKHR5cGVvZiBuYW1lID09PSAnZnVuY3Rpb24nKSB7CgkJCQljYWxsYmFjayA9IG5hbWU7CgkJCQluYW1lID0gJyc7CgkJCX0KCQkJaWYgKCFjYWxsYmFjaykgY2FsbGJhY2sgPSB0aGlzW25hbWVdOwoJCQl2YXIgcm91dGVyID0gdGhpczsKCQkJQmFja2JvbmUuaGlzdG9yeS5yb3V0ZShyb3V0ZSwgZnVuY3Rpb24oZnJhZ21lbnQpIHsKCQkJCXZhciBhcmdzID0gcm91dGVyLl9leHRyYWN0UGFyYW1ldGVycyhyb3V0ZSwgZnJhZ21lbnQpOwoJCQkJcm91dGVyLmV4ZWN1dGUoY2FsbGJhY2ssIGFyZ3MpOwoJCQkJcm91dGVyLnRyaWdnZXIuYXBwbHkocm91dGVyLCBbJ3JvdXRlOicgKyBuYW1lXS5jb25jYXQoYXJncykpOwoJCQkJcm91dGVyLnRyaWdnZXIoJ3JvdXRlJywgbmFtZSwgYXJncyk7CgkJCQlCYWNrYm9uZS5oaXN0b3J5LnRyaWdnZXIoJ3JvdXRlJywgcm91dGVyLCBuYW1lLCBhcmdzKTsKCQkJfSk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCS8vIEV4ZWN1dGUgYSByb3V0ZSBoYW5kbGVyIHdpdGggdGhlIHByb3ZpZGVkIHBhcmFtZXRlcnMuICBUaGlzIGlzIGFuCgkJLy8gZXhjZWxsZW50IHBsYWNlIHRvIGRvIHByZS1yb3V0ZSBzZXR1cCBvciBwb3N0LXJvdXRlIGNsZWFudXAuCgkJZXhlY3V0ZTogZnVuY3Rpb24oY2FsbGJhY2ssIGFyZ3MpIHsKCQkJaWYgKGNhbGxiYWNrKSBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmdzKTsKCQl9LAoKCQkvLyBTaW1wbGUgcHJveHkgdG8gYEJhY2tib25lLmhpc3RvcnlgIHRvIHNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoaXN0b3J5LgoJCW5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewoJCQlCYWNrYm9uZS5oaXN0b3J5Lm5hdmlnYXRlKGZyYWdtZW50LCBvcHRpb25zKTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJLy8gQmluZCBhbGwgZGVmaW5lZCByb3V0ZXMgdG8gYEJhY2tib25lLmhpc3RvcnlgLiBXZSBoYXZlIHRvIHJldmVyc2UgdGhlCgkJLy8gb3JkZXIgb2YgdGhlIHJvdXRlcyBoZXJlIHRvIHN1cHBvcnQgYmVoYXZpb3Igd2hlcmUgdGhlIG1vc3QgZ2VuZXJhbAoJCS8vIHJvdXRlcyBjYW4gYmUgZGVmaW5lZCBhdCB0aGUgYm90dG9tIG9mIHRoZSByb3V0ZSBtYXAuCgkJX2JpbmRSb3V0ZXM6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIXRoaXMucm91dGVzKSByZXR1cm47CgkJCXRoaXMucm91dGVzID0gXy5yZXN1bHQodGhpcywgJ3JvdXRlcycpOwoJCQl2YXIgcm91dGUsIHJvdXRlcyA9IE9iamVjdC5rZXlzKHRoaXMucm91dGVzKTsKCQkJd2hpbGUgKChyb3V0ZSA9IHJvdXRlcy5wb3AoKSkgIT0gbnVsbCkgewoJCQkJdGhpcy5yb3V0ZShyb3V0ZSwgdGhpcy5yb3V0ZXNbcm91dGVdKTsKCQkJfQoJCX0sCgoJCS8vIENvbnZlcnQgYSByb3V0ZSBzdHJpbmcgaW50byBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgc3VpdGFibGUgZm9yIG1hdGNoaW5nCgkJLy8gYWdhaW5zdCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoLgoJCV9yb3V0ZVRvUmVnRXhwOiBmdW5jdGlvbihyb3V0ZSkgewoJCQlyb3V0ZSA9IHJvdXRlLnJlcGxhY2UoZXNjYXBlUmVnRXhwLCAnXFwkJicpCgkJCS5yZXBsYWNlKG9wdGlvbmFsUGFyYW0sICcoPzokMSk/JykKCQkJLnJlcGxhY2UobmFtZWRQYXJhbSwgZnVuY3Rpb24obWF0Y2gsIG9wdGlvbmFsKSB7CgkJCQlyZXR1cm4gb3B0aW9uYWwgPyBtYXRjaCA6ICcoW14vP10rKSc7CgkJCX0pCgkJCS5yZXBsYWNlKHNwbGF0UGFyYW0sICcoW14/XSo/KScpOwoJCQlyZXR1cm4gbmV3IFJlZ0V4cCgnXicgKyByb3V0ZSArICcoPzpcXD8oW1xcc1xcU10qKSk/JCcpOwoJCX0sCgoJCS8vIEdpdmVuIGEgcm91dGUsIGFuZCBhIFVSTCBmcmFnbWVudCB0aGF0IGl0IG1hdGNoZXMsIHJldHVybiB0aGUgYXJyYXkgb2YKCQkvLyBleHRyYWN0ZWQgZGVjb2RlZCBwYXJhbWV0ZXJzLiBFbXB0eSBvciB1bm1hdGNoZWQgcGFyYW1ldGVycyB3aWxsIGJlCgkJLy8gdHJlYXRlZCBhcyBgbnVsbGAgdG8gbm9ybWFsaXplIGNyb3NzLWJyb3dzZXIgYmVoYXZpb3IuCgkJX2V4dHJhY3RQYXJhbWV0ZXJzOiBmdW5jdGlvbihyb3V0ZSwgZnJhZ21lbnQpIHsKCQkJdmFyIHBhcmFtcyA9IHJvdXRlLmV4ZWMoZnJhZ21lbnQpLnNsaWNlKDEpOwoJCQlyZXR1cm4gcGFyYW1zLm1hcChmdW5jdGlvbihwYXJhbSwgaSkgewoJCQkJLy8gRG9uJ3QgZGVjb2RlIHRoZSBzZWFyY2ggcGFyYW1zLgoJCQkJaWYgKGkgPT09IHBhcmFtcy5sZW5ndGggLSAxKSByZXR1cm4gcGFyYW0gfHwgbnVsbDsKCQkJCXJldHVybiBwYXJhbSA/IGRlY29kZVVSSUNvbXBvbmVudChwYXJhbSkgOiBudWxsOwoJCQl9KTsKCQl9CgoJfSk7CgoJLyogaGlzdG9yeSAqLwoKCS8vIEJhY2tib25lLkhpc3RvcnkKCS8vIC0tLS0tLS0tLS0tLS0tLS0KCgkvLyBIYW5kbGVzIGNyb3NzLWJyb3dzZXIgaGlzdG9yeSBtYW5hZ2VtZW50LCBiYXNlZCBvbiBlaXRoZXIKCS8vIFtwdXNoU3RhdGVdKGh0dHA6Ly9kaXZlaW50b2h0bWw1LmluZm8vaGlzdG9yeS5odG1sKSBhbmQgcmVhbCBVUkxzLCBvcgoJLy8gW29uaGFzaGNoYW5nZV0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9ET00vd2luZG93Lm9uaGFzaGNoYW5nZSkKCS8vIGFuZCBVUkwgZnJhZ21lbnRzLgoJdmFyIEhpc3RvcnkgPSBCYWNrYm9uZS5IaXN0b3J5ID0gZnVuY3Rpb24oKSB7CgkJdGhpcy5oYW5kbGVycyA9IFtdOwoJCXRoaXMuY2hlY2tVcmwgPSB0aGlzLmNoZWNrVXJsLmJpbmQodGhpcyk7CgoJCS8vIEVuc3VyZSB0aGF0IGBIaXN0b3J5YCBjYW4gYmUgdXNlZCBvdXRzaWRlIG9mIHRoZSBicm93c2VyLgoJCWlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uOwoJCQl0aGlzLmhpc3RvcnkgPSB3aW5kb3cuaGlzdG9yeTsKCQl9Cgl9OwoKCS8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KCXZhciByb3V0ZVN0cmlwcGVyID0gL15bI1wvXXxccyskL2c7CgoJLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgbGVhZGluZyBhbmQgdHJhaWxpbmcgc2xhc2hlcy4KCXZhciByb290U3RyaXBwZXIgPSAvXlwvK3xcLyskL2c7CgoJLy8gQ2FjaGVkIHJlZ2V4IGZvciByZW1vdmluZyBhIHRyYWlsaW5nIHNsYXNoLgoJdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKCgkvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyB1cmxzIG9mIGhhc2ggYW5kIHF1ZXJ5LgoJdmFyIHBhdGhTdHJpcHBlciA9IC9bI10uKiQvOwoKCS8vIEhhcyB0aGUgaGlzdG9yeSBoYW5kbGluZyBhbHJlYWR5IGJlZW4gc3RhcnRlZD8KCUhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOwoKCS8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5IaXN0b3J5KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KCV8uZXh0ZW5kKEhpc3RvcnkucHJvdG90eXBlLCBFdmVudHMsIHsKCgkJLy8gQXJlIHdlIGF0IHRoZSBhcHAgcm9vdD8KCQlhdFJvb3Q6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5sb2NhdGlvbi5wYXRobmFtZS5yZXBsYWNlKC9bXlwvXSQvLCAnJCYvJykgPT09IHRoaXMucm9vdDsKCQl9LAoKCQkvLyBHZXRzIHRoZSB0cnVlIGhhc2ggdmFsdWUuIENhbm5vdCB1c2UgbG9jYXRpb24uaGFzaCBkaXJlY3RseSBkdWUgdG8gYnVnCgkJLy8gaW4gRmlyZWZveCB3aGVyZSBsb2NhdGlvbi5oYXNoIHdpbGwgYWx3YXlzIGJlIGRlY29kZWQuCgkJZ2V0SGFzaDogZnVuY3Rpb24od2luZG93KSB7CgkJCXZhciBtYXRjaCA9ICh3aW5kb3cgfHwgdGhpcykubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CgkJCXJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogJyc7CgkJfSwKCgkJLy8gR2V0IHRoZSBjcm9zcy1icm93c2VyIG5vcm1hbGl6ZWQgVVJMIGZyYWdtZW50LCBlaXRoZXIgZnJvbSB0aGUgVVJMLAoJCS8vIHRoZSBoYXNoLCBvciB0aGUgb3ZlcnJpZGUuCgkJZ2V0RnJhZ21lbnQ6IGZ1bmN0aW9uKGZyYWdtZW50LCBmb3JjZVB1c2hTdGF0ZSkgewoJCQlpZiAoZnJhZ21lbnQgPT0gbnVsbCkgewoJCQkJaWYgKHRoaXMuX3dhbnRzUHVzaFN0YXRlIHx8ICF0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKCQkJCQlmcmFnbWVudCA9IGRlY29kZVVSSSh0aGlzLmxvY2F0aW9uLnBhdGhuYW1lICsgdGhpcy5sb2NhdGlvbi5zZWFyY2gpOwoJCQkJCXZhciByb290ID0gdGhpcy5yb290LnJlcGxhY2UodHJhaWxpbmdTbGFzaCwgJycpOwoJCQkJCWlmICghZnJhZ21lbnQuaW5kZXhPZihyb290KSkgZnJhZ21lbnQgPSBmcmFnbWVudC5zbGljZShyb290Lmxlbmd0aCk7CgkJCQl9IGVsc2UgewoJCQkJCWZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIGZyYWdtZW50LnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwoJCX0sCgoJCS8vIFN0YXJ0IHRoZSBoYXNoIGNoYW5nZSBoYW5kbGluZywgcmV0dXJuaW5nIGB0cnVlYCBpZiB0aGUgY3VycmVudCBVUkwgbWF0Y2hlcwoJCS8vIGFuIGV4aXN0aW5nIHJvdXRlLCBhbmQgYGZhbHNlYCBvdGhlcndpc2UuCgkJc3RhcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCQkJaWYgKEhpc3Rvcnkuc3RhcnRlZCkgdGhyb3cgbmV3IEVycm9yKCJCYWNrYm9uZS5oaXN0b3J5IGhhcyBhbHJlYWR5IGJlZW4gc3RhcnRlZCIpOwoJCQlIaXN0b3J5LnN0YXJ0ZWQgPSB0cnVlOwoKCQkJLy8gRmlndXJlIG91dCB0aGUgaW5pdGlhbCBjb25maWd1cmF0aW9uLgoJCQkvLyBJcyBwdXNoU3RhdGUgZGVzaXJlZCBvciBzaG91bGQgd2UgdXNlIGhhc2hjaGFuZ2Ugb25seT8KCQkJdGhpcy5vcHRpb25zICAgICAgICAgID0gXy5leHRlbmQoe3Jvb3Q6ICcvJ30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyk7CgkJCXRoaXMucm9vdCAgICAgICAgICAgICA9IHRoaXMub3B0aW9ucy5yb290OwoJCQl0aGlzLl93YW50c0hhc2hDaGFuZ2UgPSB0aGlzLm9wdGlvbnMuaGFzaENoYW5nZSAhPT0gZmFsc2U7CgkJCXRoaXMuX3dhbnRzUHVzaFN0YXRlICA9ICEhdGhpcy5vcHRpb25zLnB1c2hTdGF0ZTsKCQkJdmFyIGZyYWdtZW50ICAgICAgICAgID0gdGhpcy5nZXRGcmFnbWVudCgpOwoKCQkJLy8gTm9ybWFsaXplIHJvb3QgdG8gYWx3YXlzIGluY2x1ZGUgYSBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaC4KCQkJdGhpcy5yb290ID0gKCcvJyArIHRoaXMucm9vdCArICcvJykucmVwbGFjZShyb290U3RyaXBwZXIsICcvJyk7CgoJCQkvLyBEZXBlbmRpbmcgb24gd2hldGhlciB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgb3IgaGFzaGVzLCBkZXRlcm1pbmUgaG93IHdlCgkJCS8vIGNoZWNrIHRoZSBVUkwgc3RhdGUuCgkJCWlmICh0aGlzLl93YW50c1B1c2hTdGF0ZSkgewoJCQkJd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3BvcHN0YXRlJywgdGhpcy5jaGVja1VybCwgZmFsc2UpOwoJCQl9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewoJCQkJd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsLCBmYWxzZSk7CgkJCX0KCgkJCS8vIERldGVybWluZSBpZiB3ZSBuZWVkIHRvIGNoYW5nZSB0aGUgYmFzZSB1cmwsIGZvciBhIHB1c2hTdGF0ZSBsaW5rCgkJCS8vIG9wZW5lZCBieSBhIG5vbi1wdXNoU3RhdGUgYnJvd3Nlci4KCQkJdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwoJCQl2YXIgbG9jID0gdGhpcy5sb2NhdGlvbjsKCgkJCS8vIFRyYW5zaXRpb24gZnJvbSBoYXNoQ2hhbmdlIHRvIHB1c2hTdGF0ZSBvciB2aWNlIHZlcnNhIGlmIGJvdGggYXJlCgkJCS8vIHJlcXVlc3RlZC4KCQkJaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiB0aGlzLl93YW50c1B1c2hTdGF0ZSkgewoKCQkJCS8vIElmIHdlJ3ZlIHN0YXJ0ZWQgb3V0IHdpdGggYSBoYXNoLWJhc2VkIHJvdXRlLCBidXQgd2UncmUgY3VycmVudGx5CgkJCQkvLyBpbiBhIGJyb3dzZXIgd2hlcmUgaXQgY291bGQgYmUgYHB1c2hTdGF0ZWAtYmFzZWQgaW5zdGVhZC4uLgoJCQkJaWYgKHRoaXMuYXRSb290KCkgJiYgbG9jLmhhc2gpIHsKCQkJCQl0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCkucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CgkJCQkJdGhpcy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsIHRoaXMucm9vdCArIHRoaXMuZnJhZ21lbnQpOwoJCQkJfQoKCQkJfQoKCQkJaWYgKCF0aGlzLm9wdGlvbnMuc2lsZW50KSByZXR1cm4gdGhpcy5sb2FkVXJsKCk7CgkJfSwKCgkJLy8gRGlzYWJsZSBCYWNrYm9uZS5oaXN0b3J5LCBwZXJoYXBzIHRlbXBvcmFyaWx5LiBOb3QgdXNlZnVsIGluIGEgcmVhbCBhcHAsCgkJLy8gYnV0IHBvc3NpYmx5IHVzZWZ1bCBmb3IgdW5pdCB0ZXN0aW5nIFJvdXRlcnMuCgkJc3RvcDogZnVuY3Rpb24oKSB7CgkJCXdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpOwoJCQl3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwoJCQlIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKCQl9LAoKCQkvLyBBZGQgYSByb3V0ZSB0byBiZSB0ZXN0ZWQgd2hlbiB0aGUgZnJhZ21lbnQgY2hhbmdlcy4gUm91dGVzIGFkZGVkIGxhdGVyCgkJLy8gbWF5IG92ZXJyaWRlIHByZXZpb3VzIHJvdXRlcy4KCQlyb3V0ZTogZnVuY3Rpb24ocm91dGUsIGNhbGxiYWNrKSB7CgkJCXRoaXMuaGFuZGxlcnMudW5zaGlmdCh7cm91dGU6IHJvdXRlLCBjYWxsYmFjazogY2FsbGJhY2t9KTsKCQl9LAoKCQkvLyBDaGVja3MgdGhlIGN1cnJlbnQgVVJMIHRvIHNlZSBpZiBpdCBoYXMgY2hhbmdlZCwgYW5kIGlmIGl0IGhhcywKCQkvLyBjYWxscyBgbG9hZFVybGAuCgkJY2hlY2tVcmw6IGZ1bmN0aW9uKCkgewoJCQl2YXIgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoKTsKCQkJaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQpIHJldHVybiBmYWxzZTsKCQkJdGhpcy5sb2FkVXJsKCk7CgkJfSwKCgkJLy8gQXR0ZW1wdCB0byBsb2FkIHRoZSBjdXJyZW50IFVSTCBmcmFnbWVudC4gSWYgYSByb3V0ZSBzdWNjZWVkcyB3aXRoIGEKCQkvLyBtYXRjaCwgcmV0dXJucyBgdHJ1ZWAuIElmIG5vIGRlZmluZWQgcm91dGVzIG1hdGNoZXMgdGhlIGZyYWdtZW50LAoJCS8vIHJldHVybnMgYGZhbHNlYC4KCQlsb2FkVXJsOiBmdW5jdGlvbihmcmFnbWVudCkgewoJCQlmcmFnbWVudCA9IHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50KTsKCQkJcmV0dXJuIHRoaXMuaGFuZGxlcnMuc29tZShmdW5jdGlvbihoYW5kbGVyKSB7CgkJCQlpZiAoaGFuZGxlci5yb3V0ZS50ZXN0KGZyYWdtZW50KSkgewoJCQkJCWhhbmRsZXIuY2FsbGJhY2soZnJhZ21lbnQpOwoJCQkJCXJldHVybiB0cnVlOwoJCQkJfQoJCQl9KTsKCQl9LAoKCQkvLyBTYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGFzaCBoaXN0b3J5LCBvciByZXBsYWNlIHRoZSBVUkwgc3RhdGUgaWYgdGhlCgkJLy8gJ3JlcGxhY2UnIG9wdGlvbiBpcyBwYXNzZWQuIFlvdSBhcmUgcmVzcG9uc2libGUgZm9yIHByb3Blcmx5IFVSTC1lbmNvZGluZwoJCS8vIHRoZSBmcmFnbWVudCBpbiBhZHZhbmNlLgoJCS8vCgkJLy8gVGhlIG9wdGlvbnMgb2JqZWN0IGNhbiBjb250YWluIGB0cmlnZ2VyOiB0cnVlYCBpZiB5b3Ugd2lzaCB0byBoYXZlIHRoZQoJCS8vIHJvdXRlIGNhbGxiYWNrIGJlIGZpcmVkIChub3QgdXN1YWxseSBkZXNpcmFibGUpLCBvciBgcmVwbGFjZTogdHJ1ZWAsIGlmCgkJLy8geW91IHdpc2ggdG8gbW9kaWZ5IHRoZSBjdXJyZW50IFVSTCB3aXRob3V0IGFkZGluZyBhbiBlbnRyeSB0byB0aGUgaGlzdG9yeS4KCQluYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKCQkJaWYgKCFIaXN0b3J5LnN0YXJ0ZWQpIHJldHVybiBmYWxzZTsKCQkJaWYgKCFvcHRpb25zIHx8IG9wdGlvbnMgPT09IHRydWUpIG9wdGlvbnMgPSB7dHJpZ2dlcjogISFvcHRpb25zfTsKCgkJCXZhciB1cmwgPSB0aGlzLnJvb3QgKyAoZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50IHx8ICcnKSk7CgoJCQkvLyBTdHJpcCB0aGUgaGFzaCBmb3IgbWF0Y2hpbmcuCgkJCWZyYWdtZW50ID0gZnJhZ21lbnQucmVwbGFjZShwYXRoU3RyaXBwZXIsICcnKTsKCgkJCWlmICh0aGlzLmZyYWdtZW50ID09PSBmcmFnbWVudCkgcmV0dXJuOwoJCQl0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CgoJCQkvLyBEb24ndCBpbmNsdWRlIGEgdHJhaWxpbmcgc2xhc2ggb24gdGhlIHJvb3QuCgkJCWlmIChmcmFnbWVudCA9PT0gJycgJiYgdXJsICE9PSAnLycpIHVybCA9IHVybC5zbGljZSgwLCAtMSk7CgoJCQkvLyBJZiB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgd2UgdXNlIGl0IHRvIHNldCB0aGUgZnJhZ21lbnQgYXMgYSByZWFsIFVSTC4KCQkJaWYgKHRoaXMuX3dhbnRzUHVzaFN0YXRlKSB7CgkJCQl0aGlzLmhpc3Rvcnlbb3B0aW9ucy5yZXBsYWNlID8gJ3JlcGxhY2VTdGF0ZScgOiAncHVzaFN0YXRlJ10oe30sIGRvY3VtZW50LnRpdGxlLCB1cmwpOwoKCQkJCS8vIElmIGhhc2ggY2hhbmdlcyBoYXZlbid0IGJlZW4gZXhwbGljaXRseSBkaXNhYmxlZCwgdXBkYXRlIHRoZSBoYXNoCgkJCQkvLyBmcmFnbWVudCB0byBzdG9yZSBoaXN0b3J5LgoJCQl9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewoJCQkJdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKCQkJCS8vIElmIHlvdSd2ZSB0b2xkIHVzIHRoYXQgeW91IGV4cGxpY2l0bHkgZG9uJ3Qgd2FudCBmYWxsYmFjayBoYXNoY2hhbmdlLQoJCQkJLy8gYmFzZWQgaGlzdG9yeSwgdGhlbiBgbmF2aWdhdGVgIGJlY29tZXMgYSBwYWdlIHJlZnJlc2guCgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gdGhpcy5sb2NhdGlvbi5hc3NpZ24odXJsKTsKCQkJfQoJCQlpZiAob3B0aW9ucy50cmlnZ2VyKSByZXR1cm4gdGhpcy5sb2FkVXJsKGZyYWdtZW50KTsKCQl9LAoKCQkvLyBVcGRhdGUgdGhlIGhhc2ggbG9jYXRpb24sIGVpdGhlciByZXBsYWNpbmcgdGhlIGN1cnJlbnQgZW50cnksIG9yIGFkZGluZwoJCS8vIGEgbmV3IG9uZSB0byB0aGUgYnJvd3NlciBoaXN0b3J5LgoJCV91cGRhdGVIYXNoOiBmdW5jdGlvbihsb2NhdGlvbiwgZnJhZ21lbnQsIHJlcGxhY2UpIHsKCQkJaWYgKHJlcGxhY2UpIHsKCQkJCXZhciBocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKC8oamF2YXNjcmlwdDp8IykuKiQvLCAnJyk7CgkJCQlsb2NhdGlvbi5yZXBsYWNlKGhyZWYgKyAnIycgKyBmcmFnbWVudCk7CgkJCX0gZWxzZSB7CgkJCQkvLyBTb21lIGJyb3dzZXJzIHJlcXVpcmUgdGhhdCBgaGFzaGAgY29udGFpbnMgYSBsZWFkaW5nICMuCgkJCQlsb2NhdGlvbi5oYXNoID0gJyMnICsgZnJhZ21lbnQ7CgkJCX0KCQl9CgoJfSk7CgoJLyogZm9vdGVyICovCgoJLy8gISEhCgkvLyBJbml0LgoJWydNb2RlbCcsICdDb2xsZWN0aW9uJywgJ1JvdXRlcicsICdWaWV3JywgJ0hpc3RvcnknXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKCQl2YXIgaXRlbSA9IEJhY2tib25lW25hbWVdOwoJCWlmIChpdGVtKSBpdGVtLmV4dGVuZCA9IEJhY2tib25lLmV4dGVuZDsKCX0pOwoKCS8vIEFsbG93IHRoZSBgQmFja2JvbmVgIG9iamVjdCB0byBzZXJ2ZSBhcyBhIGdsb2JhbCBldmVudCBidXMsIGZvciBmb2xrcyB3aG8KCS8vIHdhbnQgZ2xvYmFsICJwdWJzdWIiIGluIGEgY29udmVuaWVudCBwbGFjZS4KCV8uZXh0ZW5kKEJhY2tib25lLCBFdmVudHMpOwoKCS8vIENyZWF0ZSB0aGUgZGVmYXVsdCBCYWNrYm9uZS5oaXN0b3J5IGlmIHRoZSBIaXN0b3J5IG1vZHVsZSBpcyBpbmNsdWRlZC4KCWlmIChIaXN0b3J5KSBCYWNrYm9uZS5oaXN0b3J5ID0gbmV3IEhpc3RvcnkoKTsKCXJldHVybiBCYWNrYm9uZTsKfSk7CmRlZmluZSgKCgknc3BhL1V0aWxpdHknLFsnRXhvc2tlbGV0b24nXSwKCglmdW5jdGlvbigpCgl7CgkJCgoJCXZhciBVdGlsaXR5ID0gRXhvc2tlbGV0b24udXRpbHMuZXh0ZW5kKHt9LCBFeG9za2VsZXRvbi51dGlscyk7CgoJCVV0aWxpdHkubWVyZ2UgPSBVdGlsaXR5LmV4dGVuZDsKCgkJVXRpbGl0eS5pc0Rlc2NlbmRhbnRQcm90b3R5cGVPZiA9IGZ1bmN0aW9uKHBhcmVudFByb3RvdHlwZSwgcHJvdG90eXBlKQoJCXsKCQkJdmFyIGlzRGVzY2VuZGFudCA9IGZhbHNlOwoKCQkJd2hpbGUgKHByb3RvdHlwZQoJCQkmJiAhaXNEZXNjZW5kYW50KQoJCQl7CgkJCQlpZiAocHJvdG90eXBlID09PSBwYXJlbnRQcm90b3R5cGUpCgkJCQkJaXNEZXNjZW5kYW50ID0gdHJ1ZTsKCgkJCQlwcm90b3R5cGUgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YocHJvdG90eXBlKTsKCQkJfQoKCQkJcmV0dXJuIGlzRGVzY2VuZGFudDsKCQl9OwoKCQlVdGlsaXR5LmlzRGVzY2VuZGFudFR5cGVPZiA9IGZ1bmN0aW9uKHBhcmVudFR5cGUsIHR5cGUpCgkJewoJCQlyZXR1cm4gVXRpbGl0eS5pc0Rlc2NlbmRhbnRQcm90b3R5cGVPZihwYXJlbnRUeXBlLnByb3RvdHlwZSwgdHlwZS5wcm90b3R5cGUpOwoJCX07CgoJCVV0aWxpdHkuaXNUeXBlT2YgPSBmdW5jdGlvbih0eXBlLCB2YWx1ZSkKCQl7CgkJCXN3aXRjaCAodHlwZSkKCQkJewoJCQkJY2FzZSBTdHJpbmc6CgkJCQkJcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZyc7CgkJCQkJYnJlYWsKCgkJCQlkZWZhdWx0OgoJCQkJCXJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIHR5cGU7CgkJCQkJYnJlYWs7CgkJCX0KCgkJCXJldHVybiBmYWxzZTsKCQl9OwoKCQlyZXR1cm4gVXRpbGl0eTsKCX0KKTsKZGVmaW5lKAoKCSdzcGEvRW50aXR5JyxbJy4vVXRpbGl0eSddLAoKCWZ1bmN0aW9uKFV0aWxpdHkpCgl7CgkJCgoJCXZhciB1dGlscyA9IFV0aWxpdHk7CgoJCXZhciBfX3VjYXNlID0gZnVuY3Rpb24oc3RyaW5nKQoJCXsKCQkJcmV0dXJuIHN0cmluZy5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHN0cmluZy5zbGljZSgxKTsKCQl9OwoKCQl2YXIgX19jYWxsT3JTZXQgPSBmdW5jdGlvbihwcmVmaXgsIG5hbWUsIHZhbHVlKQoJCXsKCQkJdmFyIG1ldGhvZE5hbWUgPSBwcmVmaXggKyBfX3VjYXNlKG5hbWUpOwoKCQkJaWYgKHRoaXNbbWV0aG9kTmFtZV0pCgkJCQl0aGlzW21ldGhvZE5hbWVdKHZhbHVlKTsKCgkJCWVsc2UKCQkJCXRoaXNbbmFtZV0gPSB2YWx1ZTsKCQl9OwoKCQl2YXIgRW50aXR5ID0gZnVuY3Rpb24ob3B0aW9ucykKCQl7CgkJCW9wdGlvbnMgPSB1dGlscy5leHRlbmQoe30sIHRoaXMuY29uc3RydWN0b3IuREVGQVVMVF9PUFRJT05TLCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMpOwoKCQkJdGhpcy5iaW5kRnVuY3Rpb25zKCk7CgkJCXRoaXMuY29uZmlndXJlKG9wdGlvbnMpOwoJCQl0aGlzLmVuc3VyZVN1YkVudGl0aWVzKG9wdGlvbnMpOwoJCQl0aGlzLmluaXRpYWxpemUob3B0aW9ucyk7CgkJfTsKCgkJdXRpbHMubWVyZ2UoRW50aXR5LAoJCXsKCQkJYmluZDogZnVuY3Rpb24oZnVuY3Rpb25OYW1lcykKCQkJewoJCQkJaWYgKCF0aGlzLl9fYm91bmRGdW5jdGlvbk5hbWVzKQoJCQkJCXRoaXMuX19ib3VuZEZ1bmN0aW9uTmFtZXMgPSBbXTsKCgkJCQlmdW5jdGlvbk5hbWVzLmZvckVhY2goZnVuY3Rpb24obmFtZSkKCQkJCXsKCQkJCQlpZiAodGhpcy5fX2JvdW5kRnVuY3Rpb25OYW1lcy5pbmRleE9mKG5hbWUpID09PSAtMSkKCQkJCQkJdGhpcy5fX2JvdW5kRnVuY3Rpb25OYW1lcy5wdXNoKG5hbWUpOwoKCQkJCX0uYmluZCh0aGlzKSk7CgkJCX0sCgoJCQl1bmJpbmQ6IGZ1bmN0aW9uKG5hbWVzKQoJCQl7CgkJCQlpZiAodGhpcy5fX2JvdW5kRnVuY3Rpb25OYW1lcykKCQkJCQluYW1lcy5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpCgkJCQkJewoJCQkJCQl2YXIgaW5kZXggPSB0aGlzLl9fYm91bmRGdW5jdGlvbk5hbWVzLmluZGV4T2YobmFtZSk7CgoJCQkJCQlpZiAoaW5kZXggPiAtMSkKCQkJCQkJCXRoaXMuX19ib3VuZEZ1bmN0aW9uTmFtZXMuc3BsaWNlKGluZGV4LCAxKTsKCgkJCQkJfS5iaW5kKHRoaXMpKTsKCQkJfSwKCgkJCWRlY2xhcmVPcHRpb25zOiBmdW5jdGlvbih2YWx1ZXMpCgkJCXsKCQkJCWlmICghdGhpcy5fX29wdGlvblR5cGVzKQoJCQkJCXRoaXMuX19vcHRpb25UeXBlcyA9IHt9OwoKCQkJCWZvciAodmFyIG5hbWUgaW4gdmFsdWVzKQoJCQkJCXRoaXMuX19vcHRpb25UeXBlc1tuYW1lXSA9IHZhbHVlc1tuYW1lXTsKCQkJfSwKCgkJCXVuZGVjbGFyZU9wdGlvbnM6IGZ1bmN0aW9uKG5hbWVzKQoJCQl7CgkJCQluYW1lcy5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpCgkJCQl7CgkJCQkJZGVsZXRlIHRoaXMuX19vcHRpb25UeXBlc1tuYW1lXTsKCgkJCQl9LmJpbmQodGhpcykpCgkJCX0sCgoJCQlkZWNsYXJlU3ViRW50aXRpZXM6IGZ1bmN0aW9uKHZhbHVlcykKCQkJewoJCQkJaWYgKCF0aGlzLl9fc3ViRW50aXR5VHlwZXMpCgkJCQkJdGhpcy5fX3N1YkVudGl0eVR5cGVzID0ge307CgoJCQkJZm9yICh2YXIgbmFtZSBpbiB2YWx1ZXMpCgkJCQkJdGhpcy5fX3N1YkVudGl0eVR5cGVzW25hbWVdID0gdmFsdWVzW25hbWVdOwoJCQl9LAoKCQkJdW5kZWNsYXJlU3ViRW50aXRpZXM6IGZ1bmN0aW9uKG5hbWVzKQoJCQl7CgkJCQluYW1lcy5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpCgkJCQl7CgkJCQkJZGVsZXRlIHRoaXMuX19zdWJFbnRpdHlUeXBlc1tuYW1lXTsKCgkJCQl9LmJpbmQodGhpcykpCgkJCX0sCgoJCQlzZXRTdGF0aWM6IGZ1bmN0aW9uKCkKCQkJewoJCQkJdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwoKCQkJCWFyZ3MudW5zaGlmdCh0aGlzKTsKCgkJCQl1dGlscy5tZXJnZS5hcHBseSh1bmRlZmluZWQsIGFyZ3MpOwoJCQl9LAoKCQkJc2V0UHJvdG90eXBlOiBmdW5jdGlvbigpCgkJCXsKCQkJCXZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKCgkJCQlhcmdzLnVuc2hpZnQodGhpcy5wcm90b3R5cGUpOwoKCQkJCXV0aWxzLm1lcmdlLmFwcGx5KHVuZGVmaW5lZCwgYXJncyk7CgkJCX0sCgoJCQlleHRlbmQ6IGZ1bmN0aW9uKGNoaWxkKQoJCQl7CgkJCQl2YXIgcGFyZW50ID0gdGhpcywKCQkJCQljb3BpZWRQcm9wZXJ0eU5hbWVzID0gWydfX2JvdW5kRnVuY3Rpb25OYW1lcycsICdfX29wdGlvblR5cGVzJywgJ19fc3ViRW50aXR5VHlwZXMnLCAnREVGQVVMVF9PUFRJT05TJ107CgoJCQkJaWYgKCFjaGlsZCkKCQkJCQljaGlsZCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsgcGFyZW50LmNhbGwodGhpcywgb3B0aW9ucyk7IH07CgoJCQkJY2hpbGQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShwYXJlbnQucHJvdG90eXBlKTsKCQkJCWNoaWxkLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGNoaWxkOwoKCQkJCWZvciAodmFyIHByb3BlcnR5IGluIHBhcmVudCkKCQkJCQlpZiAoY29waWVkUHJvcGVydHlOYW1lcy5pbmRleE9mKHByb3BlcnR5KSA+IC0xKQoJCQkJCXsKCQkJCQkJaWYgKHR5cGVvZiBwYXJlbnRbcHJvcGVydHldID09PSAnQXJyYXknKQoJCQkJCQkJY2hpbGRbcHJvcGVydHldID0gcGFyZW50W3Byb3BlcnR5XS5jb25jYXQoKTsKCgkJCQkJCWVsc2UKCQkJCQkJCWNoaWxkW3Byb3BlcnR5XSA9IHV0aWxzLm1lcmdlKHt9LCBwYXJlbnRbcHJvcGVydHldKTsKCQkJCQl9CgoJCQkJCWVsc2UKCQkJCQkJY2hpbGRbcHJvcGVydHldID0gcGFyZW50W3Byb3BlcnR5XTsKCgkJCQlyZXR1cm4gY2hpbGQ7CgkJCX0KCQl9KTsKCgkJdXRpbHMubWVyZ2UoRW50aXR5LnByb3RvdHlwZSwKCQl7CgkJCXV0aWxzOiB1dGlscywKCgkJCWJpbmRGdW5jdGlvbnM6IGZ1bmN0aW9uKCkKCQkJewoJCQkJaWYgKHRoaXMuY29uc3RydWN0b3IuX19ib3VuZEZ1bmN0aW9uTmFtZXMpCgkJCQkJdGhpcy5jb25zdHJ1Y3Rvci5fX2JvdW5kRnVuY3Rpb25OYW1lcy5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpCgkJCQkJewoJCQkJCQlpZiAodGhpc1tuYW1lXQoJCQkJCQkmJiB0eXBlb2YgdGhpc1tuYW1lXSA9PT0gJ2Z1bmN0aW9uJykKCQkJCQkJCXRoaXNbbmFtZV0gPSB0aGlzW25hbWVdLmJpbmQodGhpcyk7CgoJCQkJCX0uYmluZCh0aGlzKSk7CgkJCX0sCgoJCQljb25maWd1cmU6IGZ1bmN0aW9uKG9wdGlvbnMpCgkJCXsKCQkJCWlmICh0aGlzLmNvbnN0cnVjdG9yLl9fb3B0aW9uVHlwZXMpCgkJCQkJZm9yICh2YXIgbmFtZSBpbiB0aGlzLmNvbnN0cnVjdG9yLl9fb3B0aW9uVHlwZXMpCgkJCQkJewoJCQkJCQl2YXIgdmFsdWUgPSBvcHRpb25zW25hbWVdOwoKCQkJCQkJaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ3VuZGVmaW5lZCcpCgkJCQkJCXsKCQkJCQkJCWlmICghVXRpbGl0eS5pc1R5cGVPZih0aGlzLmNvbnN0cnVjdG9yLl9fb3B0aW9uVHlwZXNbbmFtZV0sIHZhbHVlKSkKCQkJCQkJCQl0aHJvdyBuZXcgRXJyb3IoJ09wdGlvbiAnICsgbmFtZSArICcgaXMgbm90IHRoZSBjb3JyZWN0IHR5cGUuJyk7CgoJCQkJCQkJX19jYWxsT3JTZXQuY2FsbCh0aGlzLCAnc2V0JywgbmFtZSwgdmFsdWUpOwoJCQkJCQl9CgkJCQkJfQoJCQl9LAoKCQkJZW5zdXJlU3ViRW50aXRpZXM6IGZ1bmN0aW9uKG9wdGlvbnMpCgkJCXsKCQkJCWlmICh0aGlzLmNvbnN0cnVjdG9yLl9fc3ViRW50aXR5VHlwZXMpCgkJCQkJZm9yICh2YXIgbmFtZSBpbiB0aGlzLmNvbnN0cnVjdG9yLl9fc3ViRW50aXR5VHlwZXMpCgkJCQkJewoJCQkJCQl2YXIgdHlwZSA9IHRoaXMuY29uc3RydWN0b3IuX19zdWJFbnRpdHlUeXBlc1tuYW1lXTsKCQkJCQkJdmFyIHZhbHVlID0gdGhpc1tuYW1lXSB8fCBvcHRpb25zW25hbWVdOwoKCQkJCQkJaWYgKCF2YWx1ZSkKCQkJCQkJewoJCQkJCQkJdmFyIG1ldGhvZE5hbWUgPSAnY3JlYXRlJyArIF9fdWNhc2UobmFtZSk7CgoJCQkJCQkJaWYgKHRoaXNbbWV0aG9kTmFtZV0pCgkJCQkJCQkJdmFsdWUgPSB0aGlzW21ldGhvZE5hbWVdKG9wdGlvbnMpOwoKCQkJCQkJCWVsc2UKCQkJCQkJCQl2YWx1ZSA9IG5ldyB0eXBlKCk7CgkJCQkJCX0KCgkJCQkJCWlmICghVXRpbGl0eS5pc1R5cGVPZih0eXBlLCB2YWx1ZSkpCgkJCQkJCQl0aHJvdyBuZXcgRXJyb3IoJ1N1YmVudGl0eSAnICsgbmFtZSArICcgaXMgbm90IHRoZSBjb3JyZWN0IHR5cGUuJyk7CgoJCQkJCQlfX2NhbGxPclNldC5jYWxsKHRoaXMsICdhZGQnLCBuYW1lLCB2YWx1ZSk7CgkJCQkJfQoJCQl9LAoKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucyl7fSwKCgkJCWRpc3Bvc2VTdWJFbnRpdHk6IGZ1bmN0aW9uKG5hbWUpCgkJCXsKCQkJCXZhciBtZXRob2ROYW1lID0gJ2Rpc3Bvc2UnICsgbmFtZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoMSk7CgoJCQkJaWYgKHRoaXNbbWV0aG9kTmFtZV0pCgkJCQkJdGhpc1ttZXRob2ROYW1lXSgpOwoKCQkJCWVsc2UKCQkJCQlpZiAodGhpc1tuYW1lXQoJCQkJCSYmIHRoaXNbbmFtZV0uZmluYWxpemUgaW5zdGFuY2VvZiBGdW5jdGlvbikKCQkJCQl7CgkJCQkJCXRoaXNbbmFtZV0uZmluYWxpemUoKTsKCgkJCQkJCWRlbGV0ZSB0aGlzW25hbWVdOwoJCQkJCX0KCQkJfSwKCgkJCWRpc3Bvc2VTdWJFbnRpdGllczogZnVuY3Rpb24oKQoJCQl7CgkJCQlpZiAodGhpcy5jb25zdHJ1Y3Rvci5fX3N1YkVudGl0eVR5cGVzKQoJCQkJCWZvciAodmFyIG5hbWUgaW4gdGhpcy5jb25zdHJ1Y3Rvci5fX3N1YkVudGl0eVR5cGVzKQoJCQkJCQl0aGlzLmRpc3Bvc2VTdWJFbnRpdHkobmFtZSk7CgkJCX0sCgoJCQlmaW5hbGl6ZTogZnVuY3Rpb24oKQoJCQl7CgkJCQl0aGlzLmRpc3Bvc2VTdWJFbnRpdGllcygpOwoJCQl9CgkJfSk7CgoJCXJldHVybiBFbnRpdHk7Cgl9Cik7CmRlZmluZSgnc3BhL0V2ZW50QnJva2VyJyxbCgoJJy4vRW50aXR5JywKCSdFeG9za2VsZXRvbiddLAoKCWZ1bmN0aW9uKEVudGl0eSkKCXsKCQkKCgkJdmFyIEV2ZW50QnJva2VyID0gRW50aXR5LmV4dGVuZCgpOwoKCQlFdmVudEJyb2tlci5zZXRQcm90b3R5cGUoRXhvc2tlbGV0b24uRXZlbnRzLAoJCXsKCQkJdHJpZ2dlcjogZnVuY3Rpb24oKQoJCQl7CgkJCQl2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CgoJCQkJRXhvc2tlbGV0b24uRXZlbnRzLnRyaWdnZXIuYXBwbHkodGhpcywgYXJncyk7CgoJCQkJYXJncy5zcGxpY2UoMSwgMCwgdGhpcyk7CgoJCQkJRXhvc2tlbGV0b24uRXZlbnRzLnRyaWdnZXIuYXBwbHkodGhpcy5hcHAsIGFyZ3MpOwoJCQl9LAoKCQkJZmluYWxpemU6IGZ1bmN0aW9uKCkKCQkJewoJCQkJRW50aXR5LnByb3RvdHlwZS5maW5hbGl6ZS5jYWxsKHRoaXMpOwoKCQkJCXRoaXMuc3RvcExpc3RlbmluZygpOwoJCQkJdGhpcy5vZmYoKTsKCQkJfQoJCX0pOwoKCQlyZXR1cm4gRXZlbnRCcm9rZXI7Cgl9Cik7CmRlZmluZSgnc3BhL1ZpZXcnLFsKCgknLi9FdmVudEJyb2tlciddLAoKCWZ1bmN0aW9uKEV2ZW50QnJva2VyKQoJewoJCQoKCQl2YXIgVmlldyA9IEV2ZW50QnJva2VyLmV4dGVuZChmdW5jdGlvbihvcHRpb25zKQoJCXsKCQkJRXZlbnRCcm9rZXIuY2FsbCh0aGlzLCBvcHRpb25zKTsKCgkJCXRoaXMuY2lkID0gdGhpcy51dGlscy51bmlxdWVJZCgndmlldycpOwoJCX0pOwoKCQlWaWV3LmRlY2xhcmVPcHRpb25zKHtwYXJlbnQ6Vmlld30pOwoKCQlWaWV3LnNldFByb3RvdHlwZSgKCQl7CgkJCWlzUmVhZHk6IGZ1bmN0aW9uKCkKCQkJewoJCQkJcmV0dXJuIHRydWU7CgkJCX0sCgoJCQlwcmVwYXJlOiBmdW5jdGlvbigpCgkJCXsKCQkJCXRoaXMudHJpZ2dlcigndmlldzpyZWFkeScsIHRoaXMpOwoJCQl9LAoKCQkJcmVuZGVyOiBmdW5jdGlvbigpIHt9LAoKCQkJcmVtb3ZlOiBmdW5jdGlvbigpCgkJCXsKCQkJCWlmICh0aGlzLnBhcmVudCkKCQkJCQl0aGlzLnBhcmVudC5yZW1vdmVDaGlsZCh0aGlzKTsKCgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCgkJCWFkZENoaWxkOiBmdW5jdGlvbihjaGlsZCkKCQkJewoJCQkJaWYgKCF0aGlzLl9jaGlsZHJlbikKCQkJCQl0aGlzLl9jaGlsZHJlbiA9IFtdOwoKCQkJCWlmICh0aGlzLl9jaGlsZHJlbi5pbmRleE9mKGNoaWxkKSA9PT0gLTEpCgkJCQl7CgkJCQkJaWYgKGNoaWxkLnBhcmVudCkKCQkJCQkJY2hpbGQucmVtb3ZlKCk7CgoJCQkJCXRoaXMuX2NoaWxkcmVuLnB1c2goY2hpbGQpOwoKCQkJCQljaGlsZC5wYXJlbnQgPSB0aGlzOwoKCQkJCQljaGlsZC5yZW5kZXIoKTsKCQkJCX0KCgkJCQlyZXR1cm4gY2hpbGQ7CgkJCX0sCgoJCQloYXNDaGlsZHJlbjogZnVuY3Rpb24oKQoJCQl7CgkJCQlyZXR1cm4gdGhpcy5udW1DaGlsZHJlbigpID4gMDsKCQkJfSwKCgkJCW51bUNoaWxkcmVuOiBmdW5jdGlvbigpCgkJCXsKCQkJCWlmICh0aGlzLl9jaGlsZHJlbikKCQkJCQlyZXR1cm4gdGhpcy5fY2hpbGRyZW4ubGVuZ3RoOwoKCQkJCXJldHVybiAwOwoJCQl9LAoKCQkJaXNEZXNjZW5kYW50OiBmdW5jdGlvbih2aWV3KQoJCQl7CgkJCQlpZiAodmlldy5wYXJlbnQpCgkJCQkJd2hpbGUgKHZpZXcucGFyZW50KQoJCQkJCXsKCQkJCQkJaWYgKHZpZXcucGFyZW50ID09PSB0aGlzKQoJCQkJCQkJcmV0dXJuIHRydWU7CgoJCQkJCQl2aWV3ID0gdmlldy5wYXJlbnQ7CgkJCQkJfQoKCQkJCXJldHVybiBmYWxzZTsKCQkJfSwKCgkJCWdldENoaWxkSW5kZXg6IGZ1bmN0aW9uKGNoaWxkKQoJCQl7CgkJCQlpZiAoIXRoaXMuX2NoaWxkcmVuKQoJCQkJCXJldHVybiAtMTsKCgkJCQlyZXR1cm4gdGhpcy5fY2hpbGRyZW4uaW5kZXhPZihjaGlsZCk7CgkJCX0sCgoJCQlnZXRDaGlsZEF0OiBmdW5jdGlvbihpbmRleCkKCQkJewoJCQkJaWYgKHRoaXMuX2NoaWxkcmVuCgkJCQkmJiB0aGlzLl9jaGlsZHJlbi5sZW5ndGggPiBpbmRleCkKCQkJCQlyZXR1cm4gdGhpcy5fY2hpbGRyZW5baW5kZXhdOwoKCQkJCXJldHVybiB2b2lkIDA7CgkJCX0sCgoJCQlyZW1vdmVDaGlsZDogZnVuY3Rpb24oY2hpbGQpCgkJCXsKCQkJCXZhciBpbmRleCA9IHRoaXMuZ2V0Q2hpbGRJbmRleChjaGlsZCk7CgoJCQkJaWYgKGluZGV4ID4gLTEpCgkJCQl7CgkJCQkJdGhpcy5fY2hpbGRyZW4uc3BsaWNlKGluZGV4LCAxKTsKCgkJCQkJdGhpcy5zdG9wTGlzdGVuaW5nKGNoaWxkKTsKCgkJCQkJZGVsZXRlIGNoaWxkLnBhcmVudDsKCQkJCX0KCgkJCQlyZXR1cm4gY2hpbGQ7CgkJCX0sCgoJCQlyZW1vdmVBbGxDaGlsZHJlbjogZnVuY3Rpb24oKQoJCQl7CgkJCQl3aGlsZSAodGhpcy5oYXNDaGlsZHJlbigpKQoJCQkJCXRoaXMucmVtb3ZlQ2hpbGQodGhpcy5nZXRDaGlsZEF0SW5kZXgodGhpcy5udW1DaGlsZHJlbigpIC0gMSkpOwoJCQl9LAoKCQkJZGlzcG9zZUNoaWxkOiBmdW5jdGlvbihjaGlsZCkKCQkJewoJCQkJY2hpbGQuZmluYWxpemUoKTsKCgkJCQlmb3IgKHZhciBuYW1lIGluIHRoaXMpCgkJCQkJaWYgKHRoaXNbbmFtZV0gPT09IGNoaWxkKQoJCQkJCQlkZWxldGUgdGhpc1tuYW1lXTsKCQkJfSwKCgkJCWZpbmFsaXplOiBmdW5jdGlvbigpCgkJCXsKCQkJCWlmICh0aGlzLnBhcmVudCkKCQkJCQl0aGlzLnJlbW92ZSgpOwoKCQkJCXdoaWxlICh0aGlzLmhhc0NoaWxkcmVuKCkpCgkJCQkJdGhpcy5kaXNwb3NlQ2hpbGQodGhpcy5nZXRDaGlsZEF0KHRoaXMubnVtQ2hpbGRyZW4oKSAtIDEpKTsKCgkJCQlFdmVudEJyb2tlci5wcm90b3R5cGUuZmluYWxpemUuY2FsbCh0aGlzKTsKCQkJfQoJCX0pOwoKCQlyZXR1cm4gVmlldzsKCX0KKTsKZGVmaW5lKAoKCSdzcGEvRE9NVmlldycsWycuL1ZpZXcnXSwKCglmdW5jdGlvbihWaWV3KQoJewoJCQoKCQl2YXIgRE9NVmlldyA9IFZpZXcuZXh0ZW5kKCk7CgoJCURPTVZpZXcuZGVjbGFyZU9wdGlvbnMoCgkJewoJCQl0ZW1wbGF0ZTpTdHJpbmcsCgkJCXRhZ05hbWU6U3RyaW5nLAoJCQlzZWxlY3RvcjpTdHJpbmcsCgkJCXBhcmVudFNlbGVjdG9yOlN0cmluZywKCQkJYXR0cmlidXRlczpPYmplY3QKCQl9KTsKCgkJRE9NVmlldy5zZXRTdGF0aWMoCgkJewoJCQlfdGVtcGxhdGVzOiB7fSwKCgkJCWdldFRlbXBsYXRlOiBmdW5jdGlvbihzZWxlY3RvcikKCQkJewoJCQkJaWYgKCF0aGlzLnByZXBhcmVUZW1wbGF0ZQoJCQkJfHwgIXRoaXMucmVuZGVyVGVtcGxhdGUpCgkJCQkJdGhyb3cgbmV3IEVycm9yKCdObyB0ZW1wbGF0aW5nIGZ1bmN0aW9ucyBkZWZpbmVkJyk7CgoJCQkJaWYgKCF0aGlzLl90ZW1wbGF0ZXNbc2VsZWN0b3JdKQoJCQkJewoJCQkJCXZhciB0ZW1wbGF0ZUhUTUwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKS5pbm5lckhUTUw7CgoJCQkJCWlmICh0ZW1wbGF0ZUhUTUwpCgkJCQkJCXRoaXMuX3RlbXBsYXRlc1tzZWxlY3Rvcl0gPSB0aGlzLnByZXBhcmVUZW1wbGF0ZSh0ZW1wbGF0ZUhUTUwpCgkJCQl9CgoJCQkJcmV0dXJuIHRoaXMuX3RlbXBsYXRlc1tzZWxlY3Rvcl07CgkJCX0KCQl9KTsKCgkJRE9NVmlldy5zZXRQcm90b3R5cGUoCgkJewoJCQl0YWdOYW1lOiAnZGl2JywKCgkJCXJlbmRlcjogZnVuY3Rpb24oKQoJCQl7CgkJCQl0aGlzLmVuc3VyZUVsZW1lbnQoKTsKCQkJfSwKCgkJCWVuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uKCkKCQkJewoJCQkJaWYgKCF0aGlzLmVsZW1lbnQpCgkJCQl7CgkJCQkJdmFyIHF1ZXJ5Q29udGV4dCA9IHRoaXMucGFyZW50CgkJCQkJCT8gdGhpcy5wYXJlbnQuZ2V0RWxlbWVudCgpCgkJCQkJCTogZG9jdW1lbnQ7CgoJCQkJCWlmICh0aGlzLnBhcmVudFNlbGVjdG9yKQoJCQkJCQl0aGlzLnBhcmVudEVsZW1lbnQgPSBxdWVyeUNvbnRleHQucXVlcnlTZWxlY3Rvcih0aGlzLnBhcmVudFNlbGVjdG9yKTsKCgkJCQkJZWxzZSBpZiAodGhpcy5zZWxlY3RvcikKCQkJCQkJdGhpcy5lbGVtZW50ID0gcXVlcnlDb250ZXh0LnF1ZXJ5U2VsZWN0b3IodGhpcy5zZWxlY3Rvcik7CgoJCQkJCWlmICghdGhpcy5lbGVtZW50KQoJCQkJCQl0aGlzLmVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRoaXMudGFnTmFtZSk7CgoJCQkJCWlmICh0aGlzLnRlbXBsYXRlKQoJCQkJCXsKCQkJCQkJdmFyIGh0bWwgPSB0aGlzLnJlbmRlclRlbXBsYXRlKCk7CgoJCQkJCQlpZiAoaHRtbCAhPT0gJycpCgkJCQkJCXsKCQkJCQkJCXRoaXMuZWxlbWVudC5pbm5lckhUTUwgPSBodG1sOwoKCQkJCQkJCWlmICh0aGlzLmVsZW1lbnQuY2hpbGROb2Rlcy5sZW5ndGggPT09IDEpCgkJCQkJCQkJdGhpcy5lbGVtZW50ID0gdGhpcy5lbGVtZW50LmZpcnN0Q2hpbGQ7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmICh0aGlzLnBhcmVudEVsZW1lbnQpCgkJCQkJewoJCQkJCQl0aGlzLnBhcmVudEVsZW1lbnQuaW5uZXJIVE1MID0gJyc7CgkJCQkJCXRoaXMucGFyZW50RWxlbWVudC5hcHBlbmRDaGlsZCh0aGlzLmVsZW1lbnQpOwoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuYXR0cmlidXRlcykKCQkJCQkJZm9yICh2YXIgbmFtZSBpbiB0aGlzLmF0dHJpYnV0ZXMpCgkJCQkJCQl0aGlzLmVsZW1lbnQuc2V0QXR0cmlidXRlKG5hbWUsIHRoaXMuYXR0cmlidXRlc1tuYW1lXSk7CgkJCQl9CgkJCX0sCgoJCQlyZW5kZXJUZW1wbGF0ZTogZnVuY3Rpb24oZGF0YSkKCQkJewoJCQkJdmFyIHRlbXBsYXRlID0gRE9NVmlldy5nZXRUZW1wbGF0ZSh0aGlzLnRlbXBsYXRlKTsKCgkJCQlpZiAodGVtcGxhdGUpCgkJCQkJcmV0dXJuIERPTVZpZXcucmVuZGVyVGVtcGxhdGUodGVtcGxhdGUsIGRhdGEgfHwgdGhpcy5nZXRUZW1wbGF0ZURhdGEoKSk7CgoJCQkJcmV0dXJuICcnOwoJCQl9LAoKCQkJZ2V0VGVtcGxhdGVEYXRhOiBmdW5jdGlvbigpCgkJCXsKCQkJCXJldHVybiB7fTsKCQkJfSwKCgkJCWdldEVsZW1lbnQ6IGZ1bmN0aW9uKCkKCQkJewoJCQkJdGhpcy5lbnN1cmVFbGVtZW50KCk7CgoJCQkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCQkJfSwKCgkJCWFkZENoaWxkOiBmdW5jdGlvbihjaGlsZCkKCQkJewoJCQkJVmlldy5wcm90b3R5cGUuYWRkQ2hpbGQuY2FsbCh0aGlzLCBjaGlsZCk7CgoJCQkJdmFyIHBhcmVudEVsZW1lbnQgPSB0aGlzLmdldEVsZW1lbnQoKSwKCQkJCQljaGlsZEVsZW1lbnQgPSBjaGlsZC5nZXRFbGVtZW50KCk7CgoJCQkJaWYgKGNoaWxkLnBhcmVudEVsZW1lbnQKCQkJCSYmIChjaGlsZC5wYXJlbnRFbGVtZW50ID09PSBwYXJlbnRFbGVtZW50CgkJCQl8fCBwYXJlbnRFbGVtZW50LmNvbnRhaW5zKGNoaWxkLnBhcmVudEVsZW1lbnQpKSkKCQkJCQlwYXJlbnRFbGVtZW50ID0gY2hpbGQucGFyZW50RWxlbWVudDsKCgkJCQlpZiAocGFyZW50RWxlbWVudAoJCQkJJiYgY2hpbGRFbGVtZW50CgkJCQkmJiAhcGFyZW50RWxlbWVudC5jb250YWlucyhjaGlsZEVsZW1lbnQpKQoJCQkJCXBhcmVudEVsZW1lbnQuYXBwZW5kQ2hpbGQoY2hpbGRFbGVtZW50KTsKCgkJCQlyZXR1cm4gY2hpbGQ7CgkJCX0sCgoJCQlyZW1vdmVDaGlsZDogZnVuY3Rpb24oY2hpbGQpCgkJCXsKCQkJCWlmIChjaGlsZC5wYXJlbnQgPT09IHRoaXMpCgkJCQl7CgkJCQkJdmFyIHBhcmVudEVsZW1lbnQgPSB0aGlzLmdldEVsZW1lbnQoKSwKCQkJCQkJY2hpbGRFbGVtZW50ID0gY2hpbGQuZ2V0RWxlbWVudCgpOwoKCQkJCQlpZiAocGFyZW50RWxlbWVudAoJCQkJCSYmIGNoaWxkRWxlbWVudAoJCQkJCSYmIHBhcmVudEVsZW1lbnQuY29udGFpbnMoY2hpbGRFbGVtZW50KSkKCQkJCQkJY2hpbGRFbGVtZW50LnBhcmVudEVsZW1lbnQucmVtb3ZlQ2hpbGQoY2hpbGRFbGVtZW50KTsKCgkJCQkJcmV0dXJuIFZpZXcucHJvdG90eXBlLnJlbW92ZUNoaWxkLmNhbGwodGhpcywgY2hpbGQpOwoJCQkJfQoKCQkJCXJldHVybiBjaGlsZDsKCQkJfSwKCgkJCWZpbmFsaXplOiBmdW5jdGlvbigpCgkJCXsKCQkJCVZpZXcucHJvdG90eXBlLmZpbmFsaXplLmNhbGwodGhpcyk7CgoJCQkJZGVsZXRlIHRoaXMuZWxlbWVudDsKCQkJCWRlbGV0ZSB0aGlzLnBhcmVudEVsZW1lbnQ7CgkJCX0KCQl9KTsKCgkJcmV0dXJuIERPTVZpZXc7Cgl9Cik7CmRlZmluZSgnc3BhL1RyYW5zaXRpb24nLFsKCgknLi9FdmVudEJyb2tlcicsCgknLi9WaWV3J10sCgoJZnVuY3Rpb24oRXZlbnRCcm9rZXIsIFZpZXcpCgl7CgkJCgoJCXZhciBUcmFuc2l0aW9uID0gRXZlbnRCcm9rZXIuZXh0ZW5kKCk7CgoJCVRyYW5zaXRpb24uZGVjbGFyZU9wdGlvbnMoCgkJewoJCQlyb290OlZpZXcsCgkJCXZpZXdzOk9iamVjdCwKCQkJc3RhcnRQYXRoOlN0cmluZywKCQkJZW5kUGF0aDpTdHJpbmcsCgkJCXN1YlRyYW5zaXRpb25zOk9iamVjdAoJCX0pOwoKCQlUcmFuc2l0aW9uLnNldFByb3RvdHlwZSgKCQl7CgkJCWRpc3Bvc2VSZW1vdmVkVmlld3M6IGZhbHNlLAoKCQkJaXNSZWFkeTogZnVuY3Rpb24oKQoJCQl7CgkJCQlpZiAodGhpcy5zdWJUcmFuc2l0aW9uc1ByZXBhcmluZwoJCQkJfHwgdGhpcy52aWV3c1ByZXBhcmluZykKCQkJCQlyZXR1cm4gZmFsc2U7CgoJCQkJcmV0dXJuIHRydWU7CgkJCX0sCgoJCQlwcmVwYXJlOiBmdW5jdGlvbigpCgkJCXsKCQkJCWlmICghdGhpcy5yb290KQoJCQkJCXRocm93IG5ldyBFcnJvcignTm8gcm9vdCB2aWV3IHNldCBmb3IgdHJhbnNpdGlvbicpOwoKCQkJCWlmICghdGhpcy52aWV3cykKCQkJCQl0aHJvdyBuZXcgRXJyb3IoJ05vIHZpZXcgZGF0YSBzZXQgZm9yIHRyYW5zaXRpb24nKTsKCgkJCQlpZiAodGhpcy5zdWJUcmFuc2l0aW9ucykKCQkJCQl0aGlzLnByZXBhcmVTdWJUcmFuc2l0aW9ucygpOwoKCQkJCXRoaXMucHJlcGFyZVZpZXdzKCk7CgkJCX0sCgoJCQlwcmVwYXJlU3ViVHJhbnNpdGlvbnM6IGZ1bmN0aW9uKCkKCQkJewoJCQkJdmFyIHN1YlRyYW5zaXRpb25zID0gW10sCgkJCQkJdHJhbnNpdGlvbiwgcm9vdCwgZGF0YSwgdmlld3MsIGxlbmd0aCwgaTsKCgkJCQlmb3IgKHZhciBuYW1lIGluIHRoaXMuc3ViVHJhbnNpdGlvbnMpCgkJCQl7CgkJCQkJZm9yIChpPTAsIGxlbmd0aD10aGlzLnZpZXdzLmFsbC5sZW5ndGg7IGk8bGVuZ3RoOyBpKyspCgkJCQkJewoJCQkJCQlkYXRhID0gdGhpcy52aWV3cy5hbGxbaV07CgoJCQkJCQlpZiAoZGF0YS5uYW1lID09PSBuYW1lKQoJCQkJCQl7CgkJCQkJCQlyb290ID0gZGF0YS52aWV3OwoKCQkJCQkJCWJyZWFrOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAocm9vdCkKCQkJCQl7CgkJCQkJCXZpZXdzID0gewoJCQkJCQkJYWxsOiBbXSwKCQkJCQkJCWFkZDogW10sCgkJCQkJCQlyZW1vdmU6IFtdCgkJCQkJCX07CgoJCQkJCQlmb3IgKHZhciBhcnJheU5hbWUgaW4gdmlld3MpCgkJCQkJCXsKCQkJCQkJCXZhciBwYXJlbnRBcnJheSA9IHRoaXMudmlld3NbYXJyYXlOYW1lXSwKCQkJCQkJCQljaGlsZEFycmF5ID0gdmlld3NbYXJyYXlOYW1lXTsKCgkJCQkJCQlmb3IgKGk9MDsgaTxwYXJlbnRBcnJheS5sZW5ndGg7IGkrKykKCQkJCQkJCXsKCQkJCQkJCQlkYXRhID0gcGFyZW50QXJyYXlbaV07CgoJCQkJCQkJCWlmIChkYXRhLnBhcmVudCA9PT0gcm9vdCkKCQkJCQkJCQl7CgkJCQkJCQkJCWNoaWxkQXJyYXkucHVzaChkYXRhKTsKCgkJCQkJCQkJCXBhcmVudEFycmF5LnNwbGljZShpLCAxKTsKCgkJCQkJCQkJCWktLTsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0KCgkJCQkJCXN1YlRyYW5zaXRpb25zLnB1c2gobmV3IHRoaXMuc3ViVHJhbnNpdGlvbnNbbmFtZV0oCgkJCQkJCXsKCQkJCQkJCXJvb3Q6cm9vdCwKCQkJCQkJCXZpZXdzOnZpZXdzLAoJCQkJCQkJc3RhcnRQYXRoOnRoaXMuc3RhcnRQYXRoLAoJCQkJCQkJZW5kUGF0aDp0aGlzLmVuZFBhdGgKCQkJCQkJfSkpOwoKCQkJCQkJcm9vdCA9IHZvaWQgMDsKCQkJCQl9CgkJCQl9CgoJCQkJaWYgKHN1YlRyYW5zaXRpb25zLmxlbmd0aCA+IDApCgkJCQl7CgkJCQkJdGhpcy5zdWJUcmFuc2l0aW9ucyA9IHN1YlRyYW5zaXRpb25zOwoKCQkJCQl0aGlzLnN1YlRyYW5zaXRpb25zLmZvckVhY2goZnVuY3Rpb24odHJhbnNpdGlvbikKCQkJCQl7CgkJCQkJCXRyYW5zaXRpb24ucHJlcGFyZSgpOwoKCQkJCQkJaWYgKCF0cmFuc2l0aW9uLmlzUmVhZHkoKSkKCQkJCQkJewoJCQkJCQkJaWYgKCF0aGlzLnN1YlRyYW5zaXRpb25zUHJlcGFyaW5nKQoJCQkJCQkJCXRoaXMuc3ViVHJhbnNpdGlvbnNQcmVwYXJpbmcgPSBbXTsKCgkJCQkJCQl0aGlzLnN1YlRyYW5zaXRpb25zUHJlcGFyaW5nLnB1c2godHJhbnNpdGlvbik7CgoJCQkJCQkJdGhpcy5saXN0ZW5Ub09uY2UodHJhbnNpdGlvbiwgJ3RyYW5zaXRpb246cmVhZHknLCB0aGlzLmhhbmRsZVN1YlRyYW5zaXRpb25SZWFkeSk7CgkJCQkJCX0KCQkJCQl9LmJpbmQodGhpcykpOwoJCQkJfQoKCQkJCWVsc2UKCQkJCQlkZWxldGUgdGhpcy5zdWJUcmFuc2l0aW9uczsKCQkJfSwKCgkJCXByZXBhcmVWaWV3czogZnVuY3Rpb24oKQoJCQl7CgkJCQl0aGlzLnZpZXdzLmFsbC5mb3JFYWNoKGZ1bmN0aW9uKGRhdGEpCgkJCQl7CgkJCQkJdmFyIHZpZXcgPSBkYXRhLnZpZXc7CgoJCQkJCWlmICghdmlldy5pc1JlYWR5KCkpCgkJCQkJewoJCQkJCQl2aWV3LnByZXBhcmUoKTsKCgkJCQkJCWlmICghdmlldy5pc1JlYWR5KCkpCgkJCQkJCXsKCQkJCQkJCWlmICghdGhpcy52aWV3c1ByZXBhcmluZykKCQkJCQkJCQl0aGlzLnZpZXdzUHJlcGFyaW5nID0gW107CgoJCQkJCQkJdGhpcy52aWV3c1ByZXBhcmluZy5wdXNoKHZpZXcpOwoKCQkJCQkJCXRoaXMubGlzdGVuVG9PbmNlKHZpZXcsICd2aWV3OnJlYWR5JywgdGhpcy5oYW5kbGVWaWV3UmVhZHkpOwoJCQkJCQl9CgkJCQkJfQoJCQkJfS5iaW5kKHRoaXMpKTsKCgkJCQlpZiAodGhpcy5pc1JlYWR5KCkpCgkJCQkJdGhpcy50cmlnZ2VyKCd0cmFuc2l0aW9uOnJlYWR5JywgdGhpcyk7CgkJCX0sCgoJCQlzdGFydDogZnVuY3Rpb24oKQoJCQl7CgkJCQl0aGlzLmFkZFZpZXdzKCk7CgkJCX0sCgoJCQlhZGRWaWV3czogZnVuY3Rpb24oKQoJCQl7CgkJCQl0aGlzLmxpc3RlblRvT25jZSh0aGlzLCAndHJhbnNpdGlvbjphbGxWaWV3c0FkZGVkJywgdGhpcy5oYW5kbGVBbGxWaWV3c0FkZGVkKTsKCgkJCQlpZiAodGhpcy52aWV3cy5hZGQubGVuZ3RoID09PSAwKQoJCQkJCXRoaXMudHJpZ2dlcigndHJhbnNpdGlvbjphbGxWaWV3c0FkZGVkJyk7CgoJCQkJZWxzZQoJCQkJewoJCQkJCXRoaXMuX3ZpZXdzQWRkZWRDb3VudCA9IDA7CgoJCQkJCXRoaXMubGlzdGVuVG8odGhpcywgJ3RyYW5zaXRpb246dmlld0FkZGVkJywgdGhpcy5oYW5kbGVWaWV3QWRkZWQpOwoKCQkJCQl0aGlzLnZpZXdzLmFkZC5mb3JFYWNoKGZ1bmN0aW9uKGRhdGEpCgkJCQkJewoJCQkJCQl0aGlzLmFkZFZpZXcoZGF0YS52aWV3LCBkYXRhLnBhcmVudCk7CgoJCQkJCX0uYmluZCh0aGlzKSk7CgkJCQl9CgkJCX0sCgoJCQlhZGRWaWV3OiBmdW5jdGlvbih2aWV3LCBwYXJlbnQpCgkJCXsKCQkJCXBhcmVudC5hZGRDaGlsZCh2aWV3KTsKCgkJCQl0aGlzLnRyaWdnZXIoJ3RyYW5zaXRpb246dmlld0FkZGVkJywgdmlldywgcGFyZW50KTsKCQkJfSwKCgkJCXJlbW92ZVZpZXdzOiBmdW5jdGlvbigpCgkJCXsKCQkJCXRoaXMubGlzdGVuVG9PbmNlKHRoaXMsICd0cmFuc2l0aW9uOmFsbFZpZXdzUmVtb3ZlZCcsIHRoaXMuaGFuZGxlQWxsVmlld3NSZW1vdmVkKTsKCgkJCQlpZiAodGhpcy52aWV3cy5yZW1vdmUubGVuZ3RoID09PSAwKQoJCQkJCXRoaXMudHJpZ2dlcigndHJhbnNpdGlvbjphbGxWaWV3c1JlbW92ZWQnKTsKCgkJCQllbHNlCgkJCQl7CgkJCQkJdGhpcy5fdmlld3NSZW1vdmVkQ291bnQgPSAwOwoKCQkJCQl0aGlzLmxpc3RlblRvKHRoaXMsICd0cmFuc2l0aW9uOnZpZXdSZW1vdmVkJywgdGhpcy5oYW5kbGVWaWV3UmVtb3ZlZCk7CgoJCQkJCXRoaXMudmlld3MucmVtb3ZlLmZvckVhY2goZnVuY3Rpb24oZGF0YSkKCQkJCQl7CgkJCQkJCXRoaXMucmVtb3ZlVmlldyhkYXRhLnZpZXcsIGRhdGEucGFyZW50KTsKCgkJCQkJfS5iaW5kKHRoaXMpKTsKCQkJCX0KCQkJfSwKCgkJCXJlbW92ZVZpZXc6IGZ1bmN0aW9uKHZpZXcsIHBhcmVudCkKCQkJewoJCQkJaWYgKHRoaXMuZGlzcG9zZVJlbW92ZWRWaWV3cykKCQkJCQlwYXJlbnQuZGlzcG9zZUNoaWxkKHZpZXcpOwoKCQkJCWVsc2UKCQkJCQl2aWV3LnJlbW92ZSgpOwoKCQkJCXRoaXMudHJpZ2dlcigndHJhbnNpdGlvbjp2aWV3UmVtb3ZlZCcsIHZpZXcsIHBhcmVudCk7CgkJCX0sCgoJCQlydW5TdWJUcmFuc2l0aW9uczogZnVuY3Rpb24oKQoJCQl7CgkJCQl0aGlzLnN1YlRyYW5zaXRpb25zUnVubmluZyA9IFtdOwoKCQkJCWZvciAodmFyIG5hbWUgaW4gdGhpcy5zdWJUcmFuc2l0aW9ucykKCQkJCXsKCQkJCQl2YXIgdHJhbnNpdGlvbiA9IHRoaXMuc3ViVHJhbnNpdGlvbnNbbmFtZV07CgoJCQkJCXRoaXMubGlzdGVuVG8odHJhbnNpdGlvbiwgJ3RyYW5zaXRpb246Y29tcGxldGUnLCB0aGlzLmhhbmRsZVN1YlRyYW5zaXRpb25Db21wbGV0ZSk7CgoJCQkJCXRoaXMuc3ViVHJhbnNpdGlvbnNSdW5uaW5nLnB1c2godHJhbnNpdGlvbik7CgoJCQkJCXRyYW5zaXRpb24uc3RhcnQoKTsKCQkJCX0KCQkJfSwKCgkJCWNvbXBsZXRlOiBmdW5jdGlvbigpCgkJCXsKCQkJCXRoaXMudHJpZ2dlcigndHJhbnNpdGlvbjpjb21wbGV0ZScsIHRoaXMpOwoJCQl9LAoKCQkJaGFuZGxlU3ViVHJhbnNpdGlvblJlYWR5OiBmdW5jdGlvbih0cmFuc2l0aW9uKQoJCQl7CgkJCQl0aGlzLnN1YlRyYW5zaXRpb25zUHJlcGFyaW5nLnNwbGljZSh0aGlzLnN1YlRyYW5zaXRpb25zUHJlcGFyaW5nLmluZGV4T2YodHJhbnNpdGlvbiksIDEpOwoKCQkJCWlmICh0aGlzLnN1YlRyYW5zaXRpb25zUHJlcGFyaW5nLmxlbmd0aCA9PT0gMCkKCQkJCQlkZWxldGUgdGhpcy5zdWJUcmFuc2l0aW9uc1ByZXBhcmluZzsKCgkJCQlpZiAodGhpcy5pc1JlYWR5KCkpCgkJCQkJdGhpcy50cmlnZ2VyKCd0cmFuc2l0aW9uOnJlYWR5JywgdGhpcyk7CgkJCX0sCgoJCQloYW5kbGVTdWJUcmFuc2l0aW9uQ29tcGxldGU6IGZ1bmN0aW9uKHRyYW5zaXRpb24pCgkJCXsKCQkJCXRoaXMuc3ViVHJhbnNpdGlvbnNSdW5uaW5nLnNwbGljZSh0aGlzLnN1YlRyYW5zaXRpb25zUnVubmluZy5pbmRleE9mKHRyYW5zaXRpb24pLCAxKTsKCgkJCQlpZiAodGhpcy5zdWJUcmFuc2l0aW9uc1J1bm5pbmcubGVuZ3RoID09PSAwKQoJCQkJewoJCQkJCWRlbGV0ZSB0aGlzLnN1YlRyYW5zaXRpb25zOwoJCQkJCWRlbGV0ZSB0aGlzLl9zdWJUcmFuc2l0aW9uc1J1bm5pbmc7CgoJCQkJCXRoaXMuY29tcGxldGUoKTsKCQkJCX0KCQkJfSwKCgkJCWhhbmRsZVZpZXdSZWFkeTogZnVuY3Rpb24odmlldykKCQkJewoJCQkJdGhpcy52aWV3c1ByZXBhcmluZy5zcGxpY2UodGhpcy52aWV3c1ByZXBhcmluZy5pbmRleE9mKHZpZXcpLCAxKTsKCgkJCQlpZiAodGhpcy52aWV3c1ByZXBhcmluZy5sZW5ndGggPT09IDApCgkJCQkJZGVsZXRlIHRoaXMudmlld3NQcmVwYXJpbmc7CgoJCQkJaWYgKHRoaXMuaXNSZWFkeSgpKQoJCQkJCXRoaXMudHJpZ2dlcigndHJhbnNpdGlvbjpyZWFkeScsIHRoaXMpOwoJCQl9LAoKCQkJaGFuZGxlVmlld0FkZGVkOiBmdW5jdGlvbih2aWV3LCBwYXJlbnQpCgkJCXsKCQkJCXRoaXMuX3ZpZXdzQWRkZWRDb3VudCsrOwoKCQkJCWlmICh0aGlzLl92aWV3c0FkZGVkQ291bnQgPT09IHRoaXMudmlld3MuYWRkLmxlbmd0aCkKCQkJCXsKCQkJCQl0aGlzLnN0b3BMaXN0ZW5pbmcodGhpcywgJ3RyYW5zaXRpb246dmlld0FkZGVkJyk7CgoJCQkJCWRlbGV0ZSB0aGlzLl92aWV3c0FkZGVkQ291bnQ7CgoJCQkJCXRoaXMudHJpZ2dlcigndHJhbnNpdGlvbjphbGxWaWV3c0FkZGVkJyk7CgkJCQl9CgkJCX0sCgoJCQloYW5kbGVBbGxWaWV3c0FkZGVkOiBmdW5jdGlvbigpCgkJCXsKCQkJCWRlbGV0ZSB0aGlzLnZpZXdzLmFkZDsKCgkJCQl0aGlzLnJlbW92ZVZpZXdzKCk7CgkJCX0sCgoJCQloYW5kbGVWaWV3UmVtb3ZlZDogZnVuY3Rpb24odmlldywgcGFyZW50KQoJCQl7CgkJCQl0aGlzLl92aWV3c1JlbW92ZWRDb3VudCsrOwoKCQkJCWlmICh0aGlzLl92aWV3c1JlbW92ZWRDb3VudCA9PT0gdGhpcy52aWV3cy5yZW1vdmUubGVuZ3RoKQoJCQkJewoJCQkJCXRoaXMuc3RvcExpc3RlbmluZyh0aGlzLCAndHJhbnNpdGlvbjp2aWV3UmVtb3ZlZCcpOwoKCQkJCQlkZWxldGUgdGhpcy5fdmlld3NSZW1vdmVkQ291bnQ7CgoJCQkJCXRoaXMudHJpZ2dlcigndHJhbnNpdGlvbjphbGxWaWV3c1JlbW92ZWQnKTsKCQkJCX0KCQkJfSwKCgkJCWhhbmRsZUFsbFZpZXdzUmVtb3ZlZDogZnVuY3Rpb24oKQoJCQl7CgkJCQlkZWxldGUgdGhpcy52aWV3cy5yZW1vdmU7CgoJCQkJaWYgKHRoaXMuc3ViVHJhbnNpdGlvbnMpCgkJCQkJdGhpcy5ydW5TdWJUcmFuc2l0aW9ucygpOwoKCQkJCWVsc2UKCQkJCQl0aGlzLmNvbXBsZXRlKCk7CgkJCX0KCQl9KTsKCgkJcmV0dXJuIFRyYW5zaXRpb247Cgl9Cik7CmRlZmluZSgnc3BhL0NvbXBvc2VyJyxbCgoJJy4vRXZlbnRCcm9rZXInLAoJJy4vVmlldyddLAoKCWZ1bmN0aW9uKEV2ZW50QnJva2VyLCBWaWV3KQoJewoJCQoKCQl2YXIgQ29tcG9zZXIgPSBFdmVudEJyb2tlci5leHRlbmQoKTsKCgkJQ29tcG9zZXIuZGVjbGFyZU9wdGlvbnMoCgkJewoJCQlyb290OlZpZXcsCgkJCWRhdGE6T2JqZWN0CgkJfSk7CgoJCUNvbXBvc2VyLnNldFByb3RvdHlwZSgKCQl7CgkJCWNvbXBvc2U6IGZ1bmN0aW9uKHJvb3QsIGRhdGEsIGNhbGxiYWNrKQoJCQl7CgkJCQl0aGlzLmVuc3VyZU1vZHVsZXNMb2FkZWQoZGF0YSwgZnVuY3Rpb24oKQoJCQkJewoJCQkJCWNhbGxiYWNrKHRoaXMuZ2V0Vmlld0xpc3RDaGFuZ2VzKHJvb3QsIGRhdGEudmlld3MpKTsKCgkJCQl9LmJpbmQodGhpcykpOwoJCQl9LAoKCQkJZW5zdXJlTW9kdWxlc0xvYWRlZDogZnVuY3Rpb24oZGF0YSwgY2FsbGJhY2spCgkJCXsKCQkJCXZhciBhcHBseURlZmF1bHRUeXBlID0gZnVuY3Rpb24oZGVmaW5pdGlvbnMsIGRlZmF1bHRUeXBlKQoJCQkJewoJCQkJCWRlZmluaXRpb25zLmZvckVhY2goZnVuY3Rpb24oZGVmaW5pdGlvbikKCQkJCQl7CgkJCQkJCWlmICghZGVmaW5pdGlvbi50eXBlKQoJCQkJCQkJZGVmaW5pdGlvbi50eXBlID0gZGVmYXVsdFR5cGU7CgoJCQkJCQlpZiAoZGVmaW5pdGlvbi5jaGlsZHJlbikKCQkJCQkJCWFwcGx5RGVmYXVsdFR5cGUoZGVmaW5pdGlvbi5jaGlsZHJlbiwgZGVmYXVsdFR5cGUpOwoJCQkJCX0pOwoJCQkJfTsKCgkJCQl2YXIgY29sbGVjdE1vZHVsZVBhdGhzID0gZnVuY3Rpb24oZGVmaW5pdGlvbnMpCgkJCQl7CgkJCQkJdmFyIHBhdGhzID0gW107CgoJCQkJCWZvciAodmFyIGk9MCwgbGVuZ3RoID0gZGVmaW5pdGlvbnMubGVuZ3RoOyBpPGxlbmd0aDsgaSsrKQoJCQkJCXsKCQkJCQkJdmFyIGRlZmluaXRpb24gPSBkZWZpbml0aW9uc1tpXTsKCgkJCQkJCWlmICh0eXBlb2YgZGVmaW5pdGlvbiA9PT0gJ3N0cmluZycpCgkJCQkJCXsKCQkJCQkJCWlmIChyZXF1aXJlLmRlZmluZWQoZGVmaW5pdGlvbikpCgkJCQkJCQl7CgkJCQkJCQkJZGVmaW5pdGlvbiA9IHJlcXVpcmUoZGVmaW5pdGlvbik7CgoJCQkJCQkJCWlmICghZGVmaW5pdGlvbi52aWV3cykKCQkJCQkJCQkJdGhyb3cgbmV3IEVycm9yKCdObyB2aWV3IGRhdGEgc2V0IGluIGNoaWxkIG1vZHVsZScpOwoKCQkJCQkJCQlpZiAoZGF0YS5kZWZhdWx0VHlwZSB8fCBkZWZhdWx0VHlwZSkKCQkJCQkJCQkJYXBwbHlEZWZhdWx0VHlwZShkZWZpbml0aW9uLnZpZXdzLCBkYXRhLmRlZmF1bHRUeXBlIHx8IGRlZmF1bHRUeXBlKTsKCgkJCQkJCQkJQXJyYXkucHJvdG90eXBlLnNwbGljZS5hcHBseShkZWZpbml0aW9ucywgW2ksIDFdLmNvbmNhdChkZWZpbml0aW9uLnZpZXdzKSk7CgoJCQkJCQkJCWxlbmd0aCA9IGRlZmluaXRpb25zLmxlbmd0aDsKCQkJCQkJCQlpLS07CgkJCQkJCQl9CgoJCQkJCQkJZWxzZSBpZiAocGF0aHMuaW5kZXhPZihkZWZpbml0aW9uKSA9PT0gLTEpCgkJCQkJCQkJcGF0aHMucHVzaChkZWZpbml0aW9uKTsKCQkJCQkJfQoKCQkJCQkJZWxzZQoJCQkJCQl7CgkJCQkJCQlpZiAoIWRlZmluaXRpb24udHlwZSkKCQkJCQkJCXsKCQkJCQkJCQlpZiAoZGVmYXVsdFR5cGUpCgkJCQkJCQkJCWRlZmluaXRpb24udHlwZSA9IGRlZmF1bHRUeXBlOwoKCQkJCQkJCQllbHNlCgkJCQkJCQkJCXRocm93IG5ldyBFcnJvcignTm8gdHlwZSBzZXQgZm9yIHZpZXcnKTsKCQkJCQkJCX0KCgkJCQkJCQlpZiAodHlwZW9mIGRlZmluaXRpb24udHlwZSA9PT0gJ3N0cmluZycpCgkJCQkJCQl7CgkJCQkJCQkJaWYgKHJlcXVpcmUuZGVmaW5lZChkZWZpbml0aW9uLnR5cGUpKQoJCQkJCQkJCQlkZWZpbml0aW9uLnR5cGUgPSByZXF1aXJlKGRlZmluaXRpb24udHlwZSk7CgoJCQkJCQkJCWVsc2UgaWYgKHBhdGhzLmluZGV4T2YoZGVmaW5pdGlvbi50eXBlKSA9PT0gLTEpCgkJCQkJCQkJCXBhdGhzLnB1c2goZGVmaW5pdGlvbi50eXBlKTsKCQkJCQkJCX0KCgkJCQkJCQlpZiAoZGVmaW5pdGlvbi5jaGlsZHJlbikKCQkJCQkJCXsKCQkJCQkJCQl2YXIgY2hpbGRQYXRocyA9IGNvbGxlY3RNb2R1bGVQYXRocyhkZWZpbml0aW9uLmNoaWxkcmVuKTsKCgkJCQkJCQkJY2hpbGRQYXRocy5mb3JFYWNoKGZ1bmN0aW9uKHBhdGgpCgkJCQkJCQkJewoJCQkJCQkJCQlpZiAocGF0aHMuaW5kZXhPZihwYXRoKSA9PT0gLTEpCgkJCQkJCQkJCQlwYXRocy5wdXNoKHBhdGgpOwoJCQkJCQkJCX0pOwoJCQkJCQkJfQoJCQkJCQl9CgoJCQkJCX07CgoJCQkJCXJldHVybiBwYXRoczsKCgkJCQl9LmJpbmQodGhpcyk7CgoJCQkJdmFyIGRlZmF1bHRUeXBlID0gZGF0YS5kZWZhdWx0VHlwZSwKCQkJCQltb2R1bGVQYXRoczsKCgkJCQlpZiAoZGVmYXVsdFR5cGUpCgkJCQkJYXBwbHlEZWZhdWx0VHlwZShkYXRhLnZpZXdzLCBkZWZhdWx0VHlwZSk7CgoJCQkJbW9kdWxlUGF0aHMgPSBjb2xsZWN0TW9kdWxlUGF0aHMoZGF0YS52aWV3cyk7CgoJCQkJaWYgKG1vZHVsZVBhdGhzLmxlbmd0aCA+IDApCgkJCQkJcmVxdWlyZShtb2R1bGVQYXRocywgZnVuY3Rpb24oKQoJCQkJCXsKCQkJCQkJdGhpcy5lbnN1cmVNb2R1bGVzTG9hZGVkKGRhdGEsIGNhbGxiYWNrKTsKCgkJCQkJfS5iaW5kKHRoaXMpKTsKCgkJCQllbHNlCgkJCQkJY2FsbGJhY2soKTsKCQkJfSwKCgkJCWdldFZpZXdMaXN0Q2hhbmdlczogZnVuY3Rpb24ocGFyZW50LCBkZWZpbml0aW9ucykKCQkJewoJCQkJdmFyIHZpZXdzID0gewoJCQkJCQlhbGw6IFtdLAoJCQkJCQlhZGQ6IFtdLAoJCQkJCQlyZW1vdmU6IFtdCgkJCQkJfSwKCQkJCQljaGlsZHJlbiA9IFtdLAoJCQkJCWNoaWxkVmlld3MgPSBbXSwKCQkJCQlkYXRhLCB2aWV3LCBsZW5ndGgsIGk7CgoJCQkJZm9yIChpPTAsIGxlbmd0aCA9IGRlZmluaXRpb25zLmxlbmd0aDsgaTxsZW5ndGg7IGkrKykKCQkJCXsKCQkJCQl2YXIgZGVmaW5pdGlvbiA9IGRlZmluaXRpb25zW2ldLAoJCQkJCQluYW1lID0gZGVmaW5pdGlvbi5uYW1lOwoKCQkJCQlpZiAobmFtZQoJCQkJCSYmIHBhcmVudFtuYW1lXSkKCQkJCQkJdmlldyA9IHBhcmVudFtuYW1lXTsKCgkJCQkJZWxzZQoJCQkJCXsKCQkJCQkJdmlldyA9IG5ldyBkZWZpbml0aW9uLnR5cGUoZGVmaW5pdGlvbi5wcm9wZXJ0aWVzKTsKCgkJCQkJCWlmIChuYW1lKQoJCQkJCQkJcGFyZW50W25hbWVdID0gdmlldzsKCQkJCQl9CgoJCQkJCWRhdGEgPSB7CgkJCQkJCXBhcmVudDpwYXJlbnQsCgkJCQkJCW5hbWU6bmFtZSwKCQkJCQkJdmlldzp2aWV3CgkJCQkJfTsKCgkJCQkJdmlld3MuYWxsLnB1c2goZGF0YSk7CgoJCQkJCS8vIFRFTVAKCQkJCQljaGlsZHJlbi5wdXNoKHZpZXcpOwoKCQkJCQlpZiAodmlldy5wYXJlbnQgIT09IHBhcmVudCkKCQkJCQkJdmlld3MuYWRkLnB1c2goZGF0YSk7CgoJCQkJCWlmIChkZWZpbml0aW9uLmNoaWxkcmVuKQoJCQkJCQljaGlsZFZpZXdzLnB1c2godGhpcy5nZXRWaWV3TGlzdENoYW5nZXModmlldywgZGVmaW5pdGlvbi5jaGlsZHJlbikpOwoJCQkJfQoKCQkJCWlmIChwYXJlbnQubnVtQ2hpbGRyZW4oKSA+IDApCgkJCQkJZm9yIChpPTAsIGxlbmd0aCA9IHBhcmVudC5udW1DaGlsZHJlbigpOyBpPGxlbmd0aDsgaSsrKQoJCQkJCXsKCQkJCQkJdmlldyA9IHBhcmVudC5nZXRDaGlsZEF0KGkpOwoKCQkJCQkJaWYgKGNoaWxkcmVuLmluZGV4T2YodmlldykgPT09IC0xKQoJCQkJCQkJdmlld3MucmVtb3ZlLnB1c2goewoJCQkJCQkJCXBhcmVudDpwYXJlbnQsCgkJCQkJCQkJdmlldzp2aWV3CgkJCQkJCQl9KTsKCQkJCQl9CgoJCQkJd2hpbGUgKGNoaWxkVmlld3MubGVuZ3RoID4gMCkKCQkJCXsKCQkJCQl2YXIgY2hpbGQgPSBjaGlsZFZpZXdzLnNoaWZ0KCk7CgoJCQkJCXZpZXdzLmFsbCA9IHZpZXdzLmFsbC5jb25jYXQoY2hpbGQuYWxsKTsKCQkJCQl2aWV3cy5hZGQgPSB2aWV3cy5hZGQuY29uY2F0KGNoaWxkLmFkZCk7CgkJCQkJdmlld3MucmVtb3ZlID0gdmlld3MucmVtb3ZlLmNvbmNhdChjaGlsZC5yZW1vdmUpOwoJCQkJfQoKCQkJCXJldHVybiB2aWV3czsKCQkJfQoJCX0pOwoKCQlyZXR1cm4gQ29tcG9zZXI7Cgl9Cik7CmRlZmluZSgnc3BhL0Rpc3BhdGNoZXInLFsKCgknLi9FdmVudEJyb2tlcicsCgknLi9UcmFuc2l0aW9uJywKCScuL0NvbXBvc2VyJ10sCgoJZnVuY3Rpb24oRXZlbnRCcm9rZXIsIFRyYW5zaXRpb24sIENvbXBvc2VyKQoJewoJCQoKCQl2YXIgRGlzcGF0Y2hlciA9IEV2ZW50QnJva2VyLmV4dGVuZCgpOwoKCQlEaXNwYXRjaGVyLmRlY2xhcmVTdWJFbnRpdGllcygKCQl7CgkJCWNvbXBvc2VyOkNvbXBvc2VyCgkJfSk7CgoJCURpc3BhdGNoZXIuc2V0UHJvdG90eXBlKAoJCXsKCQkJYWRkUm91dGVTdGF0ZXM6IGZ1bmN0aW9uKHN0YXRlcykKCQkJewoJCQkJZm9yICh2YXIgcGF0aCBpbiBzdGF0ZXMpCgkJCQl7CgkJCQkJdmFyIHN0YXRlID0gc3RhdGVzW3BhdGhdOwoKCQkJCQlpZiAodHlwZW9mIHN0YXRlID09PSAnc3RyaW5nJykKCQkJCQkJc3RhdGUgPSB7ZGF0YTpzdGF0ZX07CgoJCQkJCXRoaXMuYWRkUm91dGVTdGF0ZShwYXRoLCBzdGF0ZS5kYXRhLCBzdGF0ZS52aWV3KTsKCQkJCX0KCQkJfSwKCgkJCWFkZFJvdXRlU3RhdGU6IGZ1bmN0aW9uKHBhdGgsIGRhdGEsIHZpZXcpCgkJCXsKCQkJCWlmICghdmlldykKCQkJCQl2aWV3ID0gdGhpcy5hcHAudmlldzsKCgkJCQlpZiAoIXRoaXMuX3JvdXRlU3RhdGVzKQoJCQkJCXRoaXMuX3JvdXRlU3RhdGVzID0ge307CgoJCQkJdGhpcy5fcm91dGVTdGF0ZXNbcGF0aF0gPSB7CgkJCQkJZGF0YTpkYXRhLAoJCQkJCXJvb3Q6dmlldwoJCQkJfTsKCgkJCQl0aGlzLmFwcC5yb3V0ZXIucm91dGUocGF0aCwgJycsIGZ1bmN0aW9uKCkKCQkJCXsKCQkJCQl2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CgoJCQkJCWFyZ3MudW5zaGlmdChwYXRoKTsKCgkJCQkJLy8gVE9ETzogRmlndXJlIG91dCB2YWx1ZXMgcGFzc2VkIHRvIGNhbGxiYWNrIC8gdGVtcCBmaXggdG8gZXhjbHVkZSBudWxsIHZhbHVlcyBiZWxvdwoJCQkJCWFyZ3MgPSBhcmdzLnNwbGljZSgwLCBhcmdzLmluZGV4T2YobnVsbCkpOwoKCQkJCQl0aGlzLmhhbmRsZVJvdXRlLmFwcGx5KHRoaXMsIGFyZ3MpOwoKCQkJCX0uYmluZCh0aGlzKSk7CgkJCX0sCgoJCQlyZW1vdmVSb3V0ZVN0YXRlOiBmdW5jdGlvbihwYXRoKQoJCQl7CgkJCQlpZiAodGhpcy5fcm91dGVTdGF0ZXMKCQkJCSYmIHRoaXMuX3JvdXRlU3RhdGVzW3BhdGhdKQoJCQkJewoJCQkJCXZhciBzdGF0ZSA9IHRoaXMuX3JvdXRlU3RhdGVzW3BhdGhdOwoKCQkJCQlkZWxldGUgdGhpcy5fcm91dGVTdGF0ZXNbcGF0aF07CgoJCQkJCXJldHVybiBzdGF0ZTsKCQkJCX0KCgkJCQlyZXR1cm4gdm9pZCAwOwoJCQl9LAoKCQkJcmVtb3ZlUm91dGVTdGF0ZXM6IGZ1bmN0aW9uKHBhdGhzKQoJCQl7CgkJCQlmb3IgKHZhciBpPTA7IGk8cGF0aHMubGVuZ3RoOyBpKyspCgkJCQkJdGhpcy5yZW1vdmVSb3V0ZVN0YXRlKHBhdGhzW2ldKTsKCQkJfSwKCgkJCWhhc1JvdXRlU3RhdGU6IGZ1bmN0aW9uKHBhdGgpCgkJCXsKCQkJCWlmICh0aGlzLl9yb3V0ZVN0YXRlcwoJCQkJJiYgdGhpcy5fcm91dGVTdGF0ZXNbcGF0aF0pCgkJCQkJcmV0dXJuIHRydWU7CgoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9LAoKCQkJZ2V0Um91dGVTdGF0ZTogZnVuY3Rpb24ocGF0aCkKCQkJewoJCQkJaWYgKHRoaXMuaGFzUm91dGVTdGF0ZShwYXRoKSkKCQkJCXsKCQkJCQl2YXIgc3RhdGUgPSB0aGlzLl9yb3V0ZVN0YXRlc1twYXRoXTsKCgkJCQkJaWYgKHR5cGVvZiBzdGF0ZS5kYXRhID09PSAnc3RyaW5nJwoJCQkJCSYmIHJlcXVpcmUuZGVmaW5lZChzdGF0ZS5kYXRhKSkKCQkJCQkJc3RhdGUuZGF0YSA9IHJlcXVpcmUoc3RhdGUuZGF0YSk7CgoJCQkJCXJldHVybiBzdGF0ZTsKCQkJCX0KCgkJCQlyZXR1cm4gdm9pZCAwOwoJCQl9LAoKCQkJYWRkVHJhbnNpdGlvbnM6IGZ1bmN0aW9uKGRlZmluaXRpb25zKQoJCQl7CgkJCQlkZWZpbml0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKGRlZmluaXRpb24pCgkJCQl7CgkJCQkJdGhpcy5hZGRUcmFuc2l0aW9uKGRlZmluaXRpb24pOwoKCQkJCX0uYmluZCh0aGlzKSk7CgkJCX0sCgoJCQlhZGRUcmFuc2l0aW9uOiBmdW5jdGlvbihkZWZpbml0aW9uKQoJCQl7CgkJCQlpZiAoIXRoaXMuX3RyYW5zaXRpb25zKQoJCQkJCXRoaXMuX3RyYW5zaXRpb25zID0gW107CgoJCQkJdGhpcy5fdHJhbnNpdGlvbnMucHVzaChkZWZpbml0aW9uKTsKCQkJfSwKCgkJCWdldFRyYW5zaXRpb25UeXBlOiBmdW5jdGlvbihwYXRoKQoJCQl7CgkJCQlpZiAodGhpcy5fdHJhbnNpdGlvbnMKCQkJCSYmIHRoaXMuX3RyYW5zaXRpb25zLmxlbmd0aCA+IDApCgkJCQl7CgkJCQkJdmFyIGN1cnJlbnRQYXRoID0gdGhpcy5jdXJyZW50UGF0aCwKCQkJCQkJbWF0Y2hlcyA9IFtdLAoJCQkJCQltYXRjaDsKCgkJCQkJdGhpcy5fdHJhbnNpdGlvbnMuZm9yRWFjaChmdW5jdGlvbihkZWZpbml0aW9uKQoJCQkJCXsKCQkJCQkJaWYgKChkZWZpbml0aW9uLmZyb20gPT09IGN1cnJlbnRQYXRoCgkJCQkJCXx8IGRlZmluaXRpb24uZnJvbSA9PT0gJyonKQoJCQkJCQkmJiAoZGVmaW5pdGlvbi50byA9PT0gcGF0aAoJCQkJCQl8fCBkZWZpbml0aW9uLnRvID09PSAnKicpKQoJCQkJCQkJbWF0Y2hlcy5wdXNoKGRlZmluaXRpb24pOwoJCQkJCX0pOwoKCQkJCQlpZiAobWF0Y2hlcy5sZW5ndGggPT09IDEpCgkJCQkJCW1hdGNoID0gbWF0Y2hlc1swXTsKCgkJCQkJZWxzZSBpZiAobWF0Y2hlcy5sZW5ndGggPiAxKQoJCQkJCXsKCQkJCQkJbWF0Y2hlcy5mb3JFYWNoKGZ1bmN0aW9uKGRlZmluaXRpb24pCgkJCQkJCXsKCQkJCQkJCWlmIChkZWZpbml0aW9uLmZyb20gPT09IGN1cnJlbnRQYXRoCgkJCQkJCQkmJiBkZWZpbml0aW9uLnRvID09PSBwYXRoKQoJCQkJCQkJCW1hdGNoID0gZGVmaW5pdGlvbjsKCQkJCQkJfSk7CgoJCQkJCQlpZiAoIW1hdGNoKQoJCQkJCQkJbWF0Y2hlcy5mb3JFYWNoKGZ1bmN0aW9uKGRlZmluaXRpb24pCgkJCQkJCQl7CgkJCQkJCQkJaWYgKGRlZmluaXRpb24uZnJvbSA9PT0gJyonCgkJCQkJCQkJJiYgZGVmaW5pdGlvbi50byA9PT0gcGF0aCkKCQkJCQkJCQkJbWF0Y2ggPSBkZWZpbml0aW9uOwoJCQkJCQkJfSk7CgoJCQkJCQlpZiAoIW1hdGNoKQoJCQkJCQkJbWF0Y2hlcy5mb3JFYWNoKGZ1bmN0aW9uKGRlZmluaXRpb24pCgkJCQkJCQl7CgkJCQkJCQkJaWYgKGRlZmluaXRpb24uZnJvbSA9PT0gY3VycmVudFBhdGgKCQkJCQkJCQkmJiBkZWZpbml0aW9uLnRvID09PSAnKicpCgkJCQkJCQkJCW1hdGNoID0gZGVmaW5pdGlvbjsKCQkJCQkJCX0pOwoKCQkJCQkJaWYgKCFtYXRjaCkKCQkJCQkJCW1hdGNoZXMuZm9yRWFjaChmdW5jdGlvbihkZWZpbml0aW9uKQoJCQkJCQkJewoJCQkJCQkJCWlmIChkZWZpbml0aW9uLmZyb20gPT09ICcqJwoJCQkJCQkJCSYmIGRlZmluaXRpb24udG8gPT09ICcqJykKCQkJCQkJCQkJbWF0Y2ggPSBkZWZpbml0aW9uOwoJCQkJCQkJfSk7CgkJCQkJfQoKCQkJCQlpZiAobWF0Y2gpCgkJCQkJewoJCQkJCQlpZiAodHlwZW9mIG1hdGNoLnR5cGUgPT09ICdzdHJpbmcnCgkJCQkJCSYmIHJlcXVpcmUuZGVmaW5lZChtYXRjaC50eXBlKSkKCQkJCQkJCW1hdGNoLnR5cGUgPSByZXF1aXJlKG1hdGNoLnR5cGUpOwoKCQkJCQkJcmV0dXJuIG1hdGNoLnR5cGU7CgkJCQkJfQoJCQkJfQoKCQkJCXJldHVybiBUcmFuc2l0aW9uOwoJCQl9LAoKCQkJLy8gVE9ETwoJCQlyZW1vdmVUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHt9LAoJCQlyZW1vdmVUcmFuc2l0aW9uczogZnVuY3Rpb24oKSB7fSwKCgkJCXByZXBhcmVUcmFuc2l0aW9uOiBmdW5jdGlvbihwYXRoKQoJCQl7CgkJCQlpZiAoIXRoaXMuX3RyYW5zaXRpb25QZW5kaW5nCgkJCQkmJiB0aGlzLmhhc1JvdXRlU3RhdGUocGF0aCkpCgkJCQl7CgkJCQkJdmFyIHR5cGUgPSB0aGlzLmdldFRyYW5zaXRpb25UeXBlKHBhdGgpLAoJCQkJCQlzdGF0ZSA9IHRoaXMuZ2V0Um91dGVTdGF0ZShwYXRoKSwKCQkJCQkJcm9vdCA9IHN0YXRlLnJvb3QsCgkJCQkJCWRhdGEgPSBzdGF0ZS5kYXRhOwoKCQkJCQl2YXIgY3JlYXRlVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKHZpZXdzKQoJCQkJCXsKCQkJCQkJdGhpcy5jdXJyZW50VHJhbnNpdGlvbiA9IG5ldyB0eXBlKAoJCQkJCQl7CgkJCQkJCQlyb290OnJvb3QsCgkJCQkJCQl2aWV3czp2aWV3cywKCQkJCQkJCXN0YXJ0UGF0aDp0aGlzLnByZXZpb3VzUGF0aCwKCQkJCQkJCWVuZFBhdGg6dGhpcy5jdXJyZW50UGF0aAoJCQkJCQl9KTsKCgkJCQkJCXRoaXMubGlzdGVuVG9PbmNlKHRoaXMuY3VycmVudFRyYW5zaXRpb24sICd0cmFuc2l0aW9uOnJlYWR5JywgdGhpcy5oYW5kbGVUcmFuc2l0aW9uUmVhZHkpOwoKCQkJCQkJdGhpcy5jdXJyZW50VHJhbnNpdGlvbi5wcmVwYXJlKCk7CgoJCQkJCX0uYmluZCh0aGlzKTsKCgkJCQkJdGhpcy5fdHJhbnNpdGlvblBlbmRpbmcgPSB0cnVlOwoKCQkJCQlpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnCgkJCQkJfHwgdHlwZW9mIHR5cGUgPT09ICdzdHJpbmcnKQoJCQkJCXsKCQkJCQkJdmFyIG1vZHVsZVBhdGhzID0gW107CgoJCQkJCQlpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKQoJCQkJCQkJbW9kdWxlUGF0aHMucHVzaChkYXRhKTsKCgkJCQkJCWlmICh0eXBlb2YgdHlwZSA9PT0gJ3N0cmluZycpCgkJCQkJCQltb2R1bGVQYXRocy5wdXNoKHR5cGUpOwoKCQkJCQkJcmVxdWlyZShtb2R1bGVQYXRocywgZnVuY3Rpb24oKQoJCQkJCQl7CgkJCQkJCQlpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKQoJCQkJCQkJCWRhdGEgPSByZXF1aXJlKGRhdGEpOwoKCQkJCQkJCWlmICh0eXBlb2YgdHlwZSA9PT0gJ3N0cmluZycpCgkJCQkJCQkJdHlwZSA9IHJlcXVpcmUodHlwZSk7CgoJCQkJCQkJdGhpcy5jb21wb3Nlci5jb21wb3NlKHJvb3QsIGRhdGEsIGNyZWF0ZVRyYW5zaXRpb24pOwoKCQkJCQkJfS5iaW5kKHRoaXMpKTsKCQkJCQl9CgoJCQkJCWVsc2UKCQkJCQkJdGhpcy5jb21wb3Nlci5jb21wb3NlKHJvb3QsIGRhdGEsIGNyZWF0ZVRyYW5zaXRpb24pOwoJCQkJfQoJCQl9LAoKCQkJaGFuZGxlUm91dGU6IGZ1bmN0aW9uKHBhdGgpCgkJCXsKCQkJCWlmICh0aGlzLl90cmFuc2l0aW9uUGVuZGluZykKCQkJCQl0aGlzLnF1ZXVlZFBhdGggPSBwYXRoOwoKCQkJCWVsc2UgaWYgKHBhdGggIT09IHRoaXMuY3VycmVudFBhdGgpCgkJCQl7CgkJCQkJdGhpcy5wcmV2aW91c1BhdGggPSB0aGlzLmN1cnJlbnRQYXRoOwoJCQkJCXRoaXMuY3VycmVudFBhdGggPSBwYXRoOwoKCQkJCQlpZiAodGhpcy5oYXNSb3V0ZVN0YXRlKHBhdGgpKQoJCQkJCQl0aGlzLnByZXBhcmVUcmFuc2l0aW9uKHBhdGgpOwoJCQkJfQoJCQl9LAoKCQkJaGFuZGxlVHJhbnNpdGlvblJlYWR5OiBmdW5jdGlvbigpCgkJCXsKCQkJCXRoaXMubGlzdGVuVG9PbmNlKHRoaXMuY3VycmVudFRyYW5zaXRpb24sICd0cmFuc2l0aW9uOmNvbXBsZXRlJywgdGhpcy5oYW5kbGVUcmFuc2l0aW9uQ29tcGxldGUpOwoKCQkJCXRoaXMuY3VycmVudFRyYW5zaXRpb24uc3RhcnQoKTsKCQkJfSwKCgkJCWhhbmRsZVRyYW5zaXRpb25Db21wbGV0ZTogZnVuY3Rpb24oKQoJCQl7CgkJCQl0aGlzLmN1cnJlbnRUcmFuc2l0aW9uLmZpbmFsaXplKCk7CgoJCQkJZGVsZXRlIHRoaXMuY3VycmVudFRyYW5zaXRpb247CgoJCQkJdGhpcy5fdHJhbnNpdGlvblBlbmRpbmcgPSBmYWxzZTsKCgkJCQlpZiAodGhpcy5xdWV1ZWRQYXRoKQoJCQkJewoJCQkJCXRoaXMuaGFuZGxlUm91dGUodGhpcy5xdWV1ZWRQYXRoKTsKCgkJCQkJZGVsZXRlIHRoaXMucXVldWVkUGF0aDsKCQkJCX0KCQkJfQoJCX0pOwoKCQlyZXR1cm4gRGlzcGF0Y2hlcjsKCX0KKTsKZGVmaW5lKCdqcXVlcnknLCB7fSk7CmRlZmluZSgndW5kZXJzY29yZScsIFsnRXhvc2tlbGV0b24nXSwgZnVuY3Rpb24oRXhvc2tlbGV0b24peyByZXR1cm4gRXhvc2tlbGV0b24uVXRpbHM7IH0pOwoKZGVmaW5lKCdzcGEvQXBwbGljYXRpb24nLFsKCgknLi9FbnRpdHknLAoJJy4vRXZlbnRCcm9rZXInLAoJJy4vRE9NVmlldycsCgknLi9EaXNwYXRjaGVyJywKCSdFeG9za2VsZXRvbiddLAoKCWZ1bmN0aW9uKEVudGl0eSwgRXZlbnRCcm9rZXIsIERPTVZpZXcsIERpc3BhdGNoZXIpCgl7CgkJCgoJCXZhciBBcHBsaWNhdGlvbiA9IEV2ZW50QnJva2VyLmV4dGVuZChmdW5jdGlvbihvcHRpb25zKQoJCXsKCQkJRW50aXR5LnByb3RvdHlwZS5hcHAgPSB0aGlzOwoKCQkJRXZlbnRCcm9rZXIuY2FsbCh0aGlzLCBvcHRpb25zKTsKCQl9KTsKCgkJQXBwbGljYXRpb24uREVGQVVMVF9PUFRJT05TID0gewoJCQl2aWV3Um9vdFNlbGVjdG9yOiAnYm9keScKCQl9OwoKCQlBcHBsaWNhdGlvbi5kZWNsYXJlU3ViRW50aXRpZXMoCgkJewoJCQlyb3V0ZXI6RXhvc2tlbGV0b24uUm91dGVyLAoJCQl2aWV3OkRPTVZpZXcsCgkJCWRpc3BhdGNoZXI6RGlzcGF0Y2hlcgoJCX0pOwoKCQlBcHBsaWNhdGlvbi5zZXRQcm90b3R5cGUoCgkJewoJCQljcmVhdGVWaWV3OiBmdW5jdGlvbihvcHRpb25zKQoJCQl7CgkJCQlyZXR1cm4gbmV3IERPTVZpZXcoe3NlbGVjdG9yOm9wdGlvbnMudmlld1Jvb3RTZWxlY3Rvcn0pOwoJCQl9LAoKCQkJY3JlYXRlRGlzcGF0Y2hlcjogZnVuY3Rpb24ob3B0aW9ucykKCQkJewoJCQkJdmFyIGRpc3BhdGNoZXIgPSBuZXcgRGlzcGF0Y2hlcigpOwoKCQkJCWlmIChvcHRpb25zLnJvdXRlcykKCQkJCQlkaXNwYXRjaGVyLmFkZFJvdXRlU3RhdGVzKG9wdGlvbnMucm91dGVzKTsKCgkJCQlpZiAob3B0aW9ucy50cmFuc2l0aW9ucykKCQkJCQlkaXNwYXRjaGVyLmFkZFRyYW5zaXRpb25zKG9wdGlvbnMudHJhbnNpdGlvbnMpOwoKCQkJCXJldHVybiBkaXNwYXRjaGVyOwoJCQl9LAoKCQkJc3RhcnQ6IGZ1bmN0aW9uKCkKCQkJewoJCQkJdGhpcy5oaXN0b3J5ID0gRXhvc2tlbGV0b24uaGlzdG9yeTsKCQkJCXRoaXMuaGlzdG9yeS5zdGFydCgpOwoJCQl9CgkJfSk7CgoJCXJldHVybiBBcHBsaWNhdGlvbjsKCX0KKTsK",
                "body": "LyohCiAqIEV4b3NrZWxldG9uLmpzIDAuNi4zCiAqIChjKSAyMDEzIFBhdWwgTWlsbGVyIDxodHRwOi8vcGF1bG1pbGxyLmNvbT4KICogQmFzZWQgb24gQmFja2JvbmUuanMKICogKGMpIDIwMTAtMjAxMyBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQKICogRXhvc2tlbGV0b24gbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIEZvciBhbGwgZGV0YWlscyBhbmQgZG9jdW1lbnRhdGlvbjogPGh0dHA6Ly9leG9zanMuY29tPgogKi8KCihmdW5jdGlvbihyb290LCBmYWN0b3J5KSB7Ci8vCVNldCB1cCBCYWNrYm9uZSBhcHByb3ByaWF0ZWx5IGZvciB0aGUgZW52aXJvbm1lbnQuCglpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CgkJZGVmaW5lKCdFeG9za2VsZXRvbicsWyd1bmRlcnNjb3JlJywgJ2pxdWVyeScsICdleHBvcnRzJ10sIGZ1bmN0aW9uKF8sICQsIGV4cG9ydHMpIHsKCQkJcm9vdC5CYWNrYm9uZSA9IHJvb3QuRXhvc2tlbGV0b24gPSBmYWN0b3J5KHJvb3QsIGV4cG9ydHMsIF8sICQpOwoJCX0pOwoJfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKCQl2YXIgXywgJDsKCQl0cnkgeyBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpOyB9IGNhdGNoKGUpIHsgfQoJCXRyeSB7ICQgPSByZXF1aXJlKCdqcXVlcnknKTsgfSBjYXRjaChlKSB7IH0KCQlmYWN0b3J5KHJvb3QsIGV4cG9ydHMsIF8sICQpOwoJfSBlbHNlIHsKCQlyb290LkJhY2tib25lID0gcm9vdC5FeG9za2VsZXRvbiA9IGZhY3Rvcnkocm9vdCwge30sIHJvb3QuXywgKHJvb3QualF1ZXJ5IHx8IHJvb3QuWmVwdG8gfHwgcm9vdC5lbmRlciB8fCByb290LiQpKTsKCX0KCn0pKHRoaXMsIGZ1bmN0aW9uKHJvb3QsIEJhY2tib25lLCBfLCAkKSB7CgkKCi8vCUluaXRpYWwgU2V0dXAKLy8JLS0tLS0tLS0tLS0tLQoKLy8JU2F2ZSB0aGUgcHJldmlvdXMgdmFsdWUgb2YgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUsIHNvIHRoYXQgaXQgY2FuIGJlCi8vCXJlc3RvcmVkIGxhdGVyIG9uLCBpZiBgbm9Db25mbGljdGAgaXMgdXNlZC4KCXZhciBwcmV2aW91c0JhY2tib25lID0gcm9vdC5CYWNrYm9uZTsKCXZhciBwcmV2aW91c0V4b3NrZWxldG9uID0gcm9vdC5FeG9za2VsZXRvbjsKCi8vCVVuZGVyc2NvcmUgcmVwbGFjZW1lbnQuCgl2YXIgdXRpbHMgPSBCYWNrYm9uZS51dGlscyA9IF8gPSAoXyB8fCB7fSk7CgovLwlIb2xkIG9udG8gYSBsb2NhbCByZWZlcmVuY2UgdG8gYCRgLiBDYW4gYmUgY2hhbmdlZCBhdCBhbnkgcG9pbnQuCglCYWNrYm9uZS4kID0gJDsKCi8vCUNyZWF0ZSBsb2NhbCByZWZlcmVuY2VzIHRvIGFycmF5IG1ldGhvZHMgd2UnbGwgd2FudCB0byB1c2UgbGF0ZXIuCgl2YXIgYXJyYXkgPSBbXTsKCXZhciBwdXNoID0gYXJyYXkucHVzaDsKCXZhciBzbGljZSA9IGFycmF5LnNsaWNlOwoJdmFyIHRvU3RyaW5nID0gKHt9KS50b1N0cmluZzsKCi8vCUN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgbGlicmFyeS4gS2VlcCBpbiBzeW5jIHdpdGggYHBhY2thZ2UuanNvbmAuCi8vCUJhY2tib25lLlZFUlNJT04gPSAnMS4wLjAnOwoKLy8JUnVucyBCYWNrYm9uZS5qcyBpbiAqbm9Db25mbGljdCogbW9kZSwgcmV0dXJuaW5nIHRoZSBgQmFja2JvbmVgIHZhcmlhYmxlCi8vCXRvIGl0cyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGlzIEJhY2tib25lIG9iamVjdC4KCUJhY2tib25lLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKCQlyb290LkJhY2tib25lID0gcHJldmlvdXNCYWNrYm9uZTsKCQlyb290LkV4b3NrZWxldG9uID0gcHJldmlvdXNFeG9za2VsZXRvbjsKCQlyZXR1cm4gdGhpczsKCX07CgovLwlIZWxwZXJzCi8vCS0tLS0tLS0KCi8vCUhlbHBlciBmdW5jdGlvbiB0byBjb3JyZWN0bHkgc2V0IHVwIHRoZSBwcm90b3R5cGUgY2hhaW4sIGZvciBzdWJjbGFzc2VzLgovLwlTaW1pbGFyIHRvIGBnb29nLmluaGVyaXRzYCwgYnV0IHVzZXMgYSBoYXNoIG9mIHByb3RvdHlwZSBwcm9wZXJ0aWVzIGFuZAovLwljbGFzcyBwcm9wZXJ0aWVzIHRvIGJlIGV4dGVuZGVkLgoJQmFja2JvbmUuZXh0ZW5kID0gZnVuY3Rpb24ocHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKCQl2YXIgcGFyZW50ID0gdGhpczsKCQl2YXIgY2hpbGQ7CgoJCS8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKCQkvLyAodGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgaW4geW91ciBgZXh0ZW5kYCBkZWZpbml0aW9uKSwgb3IgZGVmYXVsdGVkCgkJLy8gYnkgdXMgdG8gc2ltcGx5IGNhbGwgdGhlIHBhcmVudCdzIGNvbnN0cnVjdG9yLgoJCWlmIChwcm90b1Byb3BzICYmIGhhc093blByb3BlcnR5LmNhbGwocHJvdG9Qcm9wcywgJ2NvbnN0cnVjdG9yJykpIHsKCQkJY2hpbGQgPSBwcm90b1Byb3BzLmNvbnN0cnVjdG9yOwoJCX0gZWxzZSB7CgkJCWNoaWxkID0gZnVuY3Rpb24oKXsgcmV0dXJuIHBhcmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyB9OwoJCX0KCgkJLy8gQWRkIHN0YXRpYyBwcm9wZXJ0aWVzIHRvIHRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiwgaWYgc3VwcGxpZWQuCgkJXy5leHRlbmQoY2hpbGQsIHBhcmVudCwgc3RhdGljUHJvcHMpOwoKCQkvLyBTZXQgdGhlIHByb3RvdHlwZSBjaGFpbiB0byBpbmhlcml0IGZyb20gYHBhcmVudGAsIHdpdGhvdXQgY2FsbGluZwoJCS8vIGBwYXJlbnRgJ3MgY29uc3RydWN0b3IgZnVuY3Rpb24uCgkJdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uKCl7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfTsKCQlTdXJyb2dhdGUucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsKCQljaGlsZC5wcm90b3R5cGUgPSBuZXcgU3Vycm9nYXRlOwoKCQkvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKCQkvLyBpZiBzdXBwbGllZC4KCQlpZiAocHJvdG9Qcm9wcykgXy5leHRlbmQoY2hpbGQucHJvdG90eXBlLCBwcm90b1Byb3BzKTsKCgkJLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAoJCS8vIGxhdGVyLgoJCWNoaWxkLl9fc3VwZXJfXyA9IHBhcmVudC5wcm90b3R5cGU7CgoJCXJldHVybiBjaGlsZDsKCX07CgovLwlUaHJvdyBhbiBlcnJvciB3aGVuIGEgVVJMIGlzIG5lZWRlZCwgYW5kIG5vbmUgaXMgc3VwcGxpZWQuCgl2YXIgdXJsRXJyb3IgPSBmdW5jdGlvbigpIHsKCQl0aHJvdyBuZXcgRXJyb3IoJ0EgInVybCIgcHJvcGVydHkgb3IgZnVuY3Rpb24gbXVzdCBiZSBzcGVjaWZpZWQnKTsKCX07CgovLwlXcmFwIGFuIG9wdGlvbmFsIGVycm9yIGNhbGxiYWNrIHdpdGggYSBmYWxsYmFjayBlcnJvciBldmVudC4KCXZhciB3cmFwRXJyb3IgPSBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewoJCXZhciBlcnJvciA9IG9wdGlvbnMuZXJyb3I7CgkJb3B0aW9ucy5lcnJvciA9IGZ1bmN0aW9uKHJlc3ApIHsKCQkJaWYgKGVycm9yKSBlcnJvcihtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CgkJCW1vZGVsLnRyaWdnZXIoJ2Vycm9yJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwoJCX07Cgl9OwoKLy8JQ2hlY2tlciBmb3IgdXRpbGl0eSBtZXRob2RzLiBVc2VmdWwgZm9yIGN1c3RvbSBidWlsZHMuCgl2YXIgdXRpbEV4aXN0cyA9IGZ1bmN0aW9uKG1ldGhvZCkgewoJCXJldHVybiB0eXBlb2YgX1ttZXRob2RdID09PSAnZnVuY3Rpb24nOwoJfTsKCgkvKiB1dGlscyAqLwoKCXV0aWxzLnJlc3VsdCA9IGZ1bmN0aW9uIHJlc3VsdChvYmplY3QsIHByb3BlcnR5KSB7CgkJdmFyIHZhbHVlID0gb2JqZWN0ID8gb2JqZWN0W3Byb3BlcnR5XSA6IHVuZGVmaW5lZDsKCQlyZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnZnVuY3Rpb24nID8gb2JqZWN0W3Byb3BlcnR5XSgpIDogdmFsdWU7Cgl9OwoKCXV0aWxzLmRlZmF1bHRzID0gZnVuY3Rpb24gZGVmYXVsdHMob2JqKSB7CgkJc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLmZvckVhY2goZnVuY3Rpb24oaXRlbSkgewoJCQlmb3IgKHZhciBrZXkgaW4gaXRlbSkgaWYgKG9ialtrZXldID09PSB1bmRlZmluZWQpCgkJCQlvYmpba2V5XSA9IGl0ZW1ba2V5XTsKCQl9KTsKCQlyZXR1cm4gb2JqOwoJfTsKCgl1dGlscy5leHRlbmQgPSBmdW5jdGlvbiBleHRlbmQob2JqKSB7CgkJc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLmZvckVhY2goZnVuY3Rpb24oaXRlbSkgewoJCQlmb3IgKHZhciBrZXkgaW4gaXRlbSkgb2JqW2tleV0gPSBpdGVtW2tleV07CgkJfSk7CgkJcmV0dXJuIG9iajsKCX07CgoJdmFyIGh0bWxFc2NhcGVzID0gewoJCQknJic6ICcmYW1wOycsCgkJCSc8JzogJyZsdDsnLAoJCQknPic6ICcmZ3Q7JywKCQkJJyInOiAnJnF1b3Q7JywKCQkJIiciOiAnJiMzOTsnCgl9OwoKCXV0aWxzLmVzY2FwZSA9IGZ1bmN0aW9uIGVzY2FwZShzdHJpbmcpIHsKCQlyZXR1cm4gc3RyaW5nID09IG51bGwgPyAnJyA6IFN0cmluZyhzdHJpbmcpLnJlcGxhY2UoL1smPD4iJ10vZywgZnVuY3Rpb24obWF0Y2gpIHsKCQkJcmV0dXJuIGh0bWxFc2NhcGVzW21hdGNoXTsKCQl9KTsKCX07CgoJdXRpbHMuc29ydEJ5ID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSwgY29udGV4dCkgewoJCXZhciBpdGVyYXRvciA9IHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJyA/IHZhbHVlIDogZnVuY3Rpb24ob2JqKXsgcmV0dXJuIG9ialt2YWx1ZV07IH07CgkJcmV0dXJuIG9iagoJCS5tYXAoZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CgkJCXJldHVybiB7CgkJCQl2YWx1ZTogdmFsdWUsCgkJCQlpbmRleDogaW5kZXgsCgkJCQljcml0ZXJpYTogaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpCgkJCX07CgkJfSkKCQkuc29ydChmdW5jdGlvbihsZWZ0LCByaWdodCkgewoJCQl2YXIgYSA9IGxlZnQuY3JpdGVyaWE7CgkJCXZhciBiID0gcmlnaHQuY3JpdGVyaWE7CgkJCWlmIChhICE9PSBiKSB7CgkJCQlpZiAoYSA+IGIgfHwgYSA9PT0gdm9pZCAwKSByZXR1cm4gMTsKCQkJCWlmIChhIDwgYiB8fCBiID09PSB2b2lkIDApIHJldHVybiAtMTsKCQkJfQoJCQlyZXR1cm4gbGVmdC5pbmRleCAtIHJpZ2h0LmluZGV4OwoJCX0pCgkJLm1hcChmdW5jdGlvbihpdGVtKSB7CgkJCXJldHVybiBpdGVtLnZhbHVlOwoJCX0pOwoJfTsKCgkvKiogVXNlZCB0byBnZW5lcmF0ZSB1bmlxdWUgSURzICovCgl2YXIgaWRDb3VudGVyID0gMDsKCgl1dGlscy51bmlxdWVJZCA9IGZ1bmN0aW9uIHVuaXF1ZUlkKHByZWZpeCkgewoJCXZhciBpZCA9ICsraWRDb3VudGVyICsgJyc7CgkJcmV0dXJuIHByZWZpeCA/IHByZWZpeCArIGlkIDogaWQ7Cgl9OwoKCXZhciBlcSA9IGZ1bmN0aW9uKGEsIGIsIGFTdGFjaywgYlN0YWNrKSB7CgkJLy8gSWRlbnRpY2FsIG9iamVjdHMgYXJlIGVxdWFsLiBgMCA9PT0gLTBgLCBidXQgdGhleSBhcmVuJ3QgaWRlbnRpY2FsLgoJCS8vIFNlZSB0aGUgW0hhcm1vbnkgYGVnYWxgIHByb3Bvc2FsXShodHRwOi8vd2lraS5lY21hc2NyaXB0Lm9yZy9kb2t1LnBocD9pZD1oYXJtb255OmVnYWwpLgoJCWlmIChhID09PSBiKSByZXR1cm4gYSAhPT0gMCB8fCAxIC8gYSA9PSAxIC8gYjsKCQkvLyBBIHN0cmljdCBjb21wYXJpc29uIGlzIG5lY2Vzc2FyeSBiZWNhdXNlIGBudWxsID09IHVuZGVmaW5lZGAuCgkJaWYgKGEgPT0gbnVsbCB8fCBiID09IG51bGwpIHJldHVybiBhID09PSBiOwoJCS8vIFVud3JhcCBhbnkgd3JhcHBlZCBvYmplY3RzLgoJCS8vaWYgKGEgaW5zdGFuY2VvZiBfKSBhID0gYS5fd3JhcHBlZDsKCQkvL2lmIChiIGluc3RhbmNlb2YgXykgYiA9IGIuX3dyYXBwZWQ7CgkJLy8gQ29tcGFyZSBgW1tDbGFzc11dYCBuYW1lcy4KCQl2YXIgY2xhc3NOYW1lID0gdG9TdHJpbmcuY2FsbChhKTsKCQlpZiAoY2xhc3NOYW1lICE9IHRvU3RyaW5nLmNhbGwoYikpIHJldHVybiBmYWxzZTsKCQlzd2l0Y2ggKGNsYXNzTmFtZSkgewoJCS8vIFN0cmluZ3MsIG51bWJlcnMsIGRhdGVzLCBhbmQgYm9vbGVhbnMgYXJlIGNvbXBhcmVkIGJ5IHZhbHVlLgoJCWNhc2UgJ1tvYmplY3QgU3RyaW5nXSc6CgkJCS8vIFByaW1pdGl2ZXMgYW5kIHRoZWlyIGNvcnJlc3BvbmRpbmcgb2JqZWN0IHdyYXBwZXJzIGFyZSBlcXVpdmFsZW50OyB0aHVzLCBgIjUiYCBpcwoJCQkvLyBlcXVpdmFsZW50IHRvIGBuZXcgU3RyaW5nKCI1IilgLgoJCQlyZXR1cm4gYSA9PSBTdHJpbmcoYik7CgkJY2FzZSAnW29iamVjdCBOdW1iZXJdJzoKCQkJLy8gYE5hTmBzIGFyZSBlcXVpdmFsZW50LCBidXQgbm9uLXJlZmxleGl2ZS4gQW4gYGVnYWxgIGNvbXBhcmlzb24gaXMgcGVyZm9ybWVkIGZvcgoJCQkvLyBvdGhlciBudW1lcmljIHZhbHVlcy4KCQkJcmV0dXJuIGEgIT09ICthID8gYiAhPT0gK2IgOiAoYSA9PT0gMCA/IDEgLyBhID09PSAxIC8gYiA6IGEgPT09ICtiKTsKCQljYXNlICdbb2JqZWN0IERhdGVdJzoKCQljYXNlICdbb2JqZWN0IEJvb2xlYW5dJzoKCQkJLy8gQ29lcmNlIGRhdGVzIGFuZCBib29sZWFucyB0byBudW1lcmljIHByaW1pdGl2ZSB2YWx1ZXMuIERhdGVzIGFyZSBjb21wYXJlZCBieSB0aGVpcgoJCQkvLyBtaWxsaXNlY29uZCByZXByZXNlbnRhdGlvbnMuIE5vdGUgdGhhdCBpbnZhbGlkIGRhdGVzIHdpdGggbWlsbGlzZWNvbmQgcmVwcmVzZW50YXRpb25zCgkJCS8vIG9mIGBOYU5gIGFyZSBub3QgZXF1aXZhbGVudC4KCQkJcmV0dXJuICthID09ICtiOwoJCQkvLyBSZWdFeHBzIGFyZSBjb21wYXJlZCBieSB0aGVpciBzb3VyY2UgcGF0dGVybnMgYW5kIGZsYWdzLgoJCWNhc2UgJ1tvYmplY3QgUmVnRXhwXSc6CgkJCXJldHVybiBhLnNvdXJjZSA9PSBiLnNvdXJjZSAmJgoJCQlhLmdsb2JhbCA9PSBiLmdsb2JhbCAmJgoJCQlhLm11bHRpbGluZSA9PSBiLm11bHRpbGluZSAmJgoJCQlhLmlnbm9yZUNhc2UgPT0gYi5pZ25vcmVDYXNlOwoJCX0KCQlpZiAodHlwZW9mIGEgIT0gJ29iamVjdCcgfHwgdHlwZW9mIGIgIT0gJ29iamVjdCcpIHJldHVybiBmYWxzZTsKCQkvLyBBc3N1bWUgZXF1YWxpdHkgZm9yIGN5Y2xpYyBzdHJ1Y3R1cmVzLiBUaGUgYWxnb3JpdGhtIGZvciBkZXRlY3RpbmcgY3ljbGljCgkJLy8gc3RydWN0dXJlcyBpcyBhZGFwdGVkIGZyb20gRVMgNS4xIHNlY3Rpb24gMTUuMTIuMywgYWJzdHJhY3Qgb3BlcmF0aW9uIGBKT2AuCgkJdmFyIGxlbmd0aCA9IGFTdGFjay5sZW5ndGg7CgkJd2hpbGUgKGxlbmd0aC0tKSB7CgkJCS8vIExpbmVhciBzZWFyY2guIFBlcmZvcm1hbmNlIGlzIGludmVyc2VseSBwcm9wb3J0aW9uYWwgdG8gdGhlIG51bWJlciBvZgoJCQkvLyB1bmlxdWUgbmVzdGVkIHN0cnVjdHVyZXMuCgkJCWlmIChhU3RhY2tbbGVuZ3RoXSA9PSBhKSByZXR1cm4gYlN0YWNrW2xlbmd0aF0gPT0gYjsKCQl9CgkJLy8gT2JqZWN0cyB3aXRoIGRpZmZlcmVudCBjb25zdHJ1Y3RvcnMgYXJlIG5vdCBlcXVpdmFsZW50LCBidXQgYE9iamVjdGBzCgkJLy8gZnJvbSBkaWZmZXJlbnQgZnJhbWVzIGFyZS4KCQl2YXIgYUN0b3IgPSBhLmNvbnN0cnVjdG9yLCBiQ3RvciA9IGIuY29uc3RydWN0b3I7CgkJaWYgKGFDdG9yICE9PSBiQ3RvciAmJiAhKHR5cGVvZiBhQ3RvciA9PT0gJ2Z1bmN0aW9uJyAmJiAoYUN0b3IgaW5zdGFuY2VvZiBhQ3RvcikgJiYKCQkJCXR5cGVvZiBiQ3RvciA9PT0gJ2Z1bmN0aW9uJyAmJiAoYkN0b3IgaW5zdGFuY2VvZiBiQ3RvcikpKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJLy8gQWRkIHRoZSBmaXJzdCBvYmplY3QgdG8gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgoJCWFTdGFjay5wdXNoKGEpOwoJCWJTdGFjay5wdXNoKGIpOwoJCXZhciBzaXplID0gMCwgcmVzdWx0ID0gdHJ1ZTsKCQkvLyBSZWN1cnNpdmVseSBjb21wYXJlIG9iamVjdHMgYW5kIGFycmF5cy4KCQlpZiAoY2xhc3NOYW1lID09PSAnW29iamVjdCBBcnJheV0nKSB7CgkJCS8vIENvbXBhcmUgYXJyYXkgbGVuZ3RocyB0byBkZXRlcm1pbmUgaWYgYSBkZWVwIGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5LgoJCQlzaXplID0gYS5sZW5ndGg7CgkJCXJlc3VsdCA9IHNpemUgPT09IGIubGVuZ3RoOwoJCQlpZiAocmVzdWx0KSB7CgkJCQkvLyBEZWVwIGNvbXBhcmUgdGhlIGNvbnRlbnRzLCBpZ25vcmluZyBub24tbnVtZXJpYyBwcm9wZXJ0aWVzLgoJCQkJd2hpbGUgKHNpemUtLSkgewoJCQkJCWlmICghKHJlc3VsdCA9IGVxKGFbc2l6ZV0sIGJbc2l6ZV0sIGFTdGFjaywgYlN0YWNrKSkpIGJyZWFrOwoJCQkJfQoJCQl9CgkJfSBlbHNlIHsKCQkJLy8gRGVlcCBjb21wYXJlIG9iamVjdHMuCgkJCWZvciAodmFyIGtleSBpbiBhKSB7CgkJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChhLCBrZXkpKSB7CgkJCQkJLy8gQ291bnQgdGhlIGV4cGVjdGVkIG51bWJlciBvZiBwcm9wZXJ0aWVzLgoJCQkJCXNpemUrKzsKCQkJCQkvLyBEZWVwIGNvbXBhcmUgZWFjaCBtZW1iZXIuCgkJCQkJaWYgKCEocmVzdWx0ID0gaGFzT3duUHJvcGVydHkuY2FsbChiLCBrZXkpICYmIGVxKGFba2V5XSwgYltrZXldLCBhU3RhY2ssIGJTdGFjaykpKSBicmVhazsKCQkJCX0KCQkJfQoJCQkvLyBFbnN1cmUgdGhhdCBib3RoIG9iamVjdHMgY29udGFpbiB0aGUgc2FtZSBudW1iZXIgb2YgcHJvcGVydGllcy4KCQkJaWYgKHJlc3VsdCkgewoJCQkJZm9yIChrZXkgaW4gYikgewoJCQkJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIGtleSkgJiYgIShzaXplLS0pKSBicmVhazsKCQkJCX0KCQkJCXJlc3VsdCA9ICFzaXplOwoJCQl9CgkJfQoJCS8vIFJlbW92ZSB0aGUgZmlyc3Qgb2JqZWN0IGZyb20gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgoJCWFTdGFjay5wb3AoKTsKCQliU3RhY2sucG9wKCk7CgkJcmV0dXJuIHJlc3VsdDsKCX07CgoJLy8gUGVyZm9ybSBhIGRlZXAgY29tcGFyaXNvbiB0byBjaGVjayBpZiB0d28gb2JqZWN0cyBhcmUgZXF1YWwuCgl1dGlscy5pc0VxdWFsID0gZnVuY3Rpb24oYSwgYikgewoJCXJldHVybiBlcShhLCBiLCBbXSwgW10pOwoJfTsKCgkvKiBldmVudHMgKi8KCgkvLyBCYWNrYm9uZS5FdmVudHMKCS8vIC0tLS0tLS0tLS0tLS0tLQoKCS8vIEEgbW9kdWxlIHRoYXQgY2FuIGJlIG1peGVkIGluIHRvICphbnkgb2JqZWN0KiBpbiBvcmRlciB0byBwcm92aWRlIGl0IHdpdGgKCS8vIGN1c3RvbSBldmVudHMuIFlvdSBtYXkgYmluZCB3aXRoIGBvbmAgb3IgcmVtb3ZlIHdpdGggYG9mZmAgY2FsbGJhY2sKCS8vIGZ1bmN0aW9ucyB0byBhbiBldmVudDsgYHRyaWdnZXJgLWluZyBhbiBldmVudCBmaXJlcyBhbGwgY2FsbGJhY2tzIGluCgkvLyBzdWNjZXNzaW9uLgoJLy8KLy8JdmFyIG9iamVjdCA9IHt9OwovLwlfLmV4dGVuZChvYmplY3QsIEJhY2tib25lLkV2ZW50cyk7Ci8vCW9iamVjdC5vbignZXhwYW5kJywgZnVuY3Rpb24oKXsgYWxlcnQoJ2V4cGFuZGVkJyk7IH0pOwovLwlvYmplY3QudHJpZ2dlcignZXhwYW5kJyk7CgkvLwoJdmFyIEV2ZW50cyA9IEJhY2tib25lLkV2ZW50cyA9IHsKCgkJCS8vIEJpbmQgYW4gZXZlbnQgdG8gYSBgY2FsbGJhY2tgIGZ1bmN0aW9uLiBQYXNzaW5nIGAiYWxsImAgd2lsbCBiaW5kCgkJCS8vIHRoZSBjYWxsYmFjayB0byBhbGwgZXZlbnRzIGZpcmVkLgoJCQlvbjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKCQkJCWlmICghZXZlbnRzQXBpKHRoaXMsICdvbicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pIHx8ICFjYWxsYmFjaykKCQkJCQlyZXR1cm4gdGhpczsKCQkJCXRoaXMuX2V2ZW50cyB8fCAodGhpcy5fZXZlbnRzID0ge30pOwoJCQkJdmFyIGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXSB8fCAodGhpcy5fZXZlbnRzW25hbWVdID0gW10pOwoJCQkJZXZlbnRzLnB1c2goe2NhbGxiYWNrOiBjYWxsYmFjaywgY29udGV4dDogY29udGV4dCwgY3R4OiBjb250ZXh0IHx8IHRoaXN9KTsKCQkJCXJldHVybiB0aGlzOwoJCQl9LAoKCQkJLy8gQmluZCBhbiBldmVudCB0byBvbmx5IGJlIHRyaWdnZXJlZCBhIHNpbmdsZSB0aW1lLiBBZnRlciB0aGUgZmlyc3QgdGltZQoJCQkvLyB0aGUgY2FsbGJhY2sgaXMgaW52b2tlZCwgaXQgd2lsbCBiZSByZW1vdmVkLgoJCQlvbmNlOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewoJCQkJaWYgKCFldmVudHNBcGkodGhpcywgJ29uY2UnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSB8fCAhY2FsbGJhY2spCgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCQl2YXIgcmFuOwoKCQkJCXZhciBvbmNlID0gZnVuY3Rpb24oKSB7CgkJCQkJaWYgKHJhbikgcmV0dXJuOwoJCQkJCXJhbiA9IHRydWU7CgkJCQkJc2VsZi5vZmYobmFtZSwgb25jZSk7CgkJCQkJY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQkJCX07CgkJCQlvbmNlLl9jYWxsYmFjayA9IGNhbGxiYWNrOwoJCQkJcmV0dXJuIHRoaXMub24obmFtZSwgb25jZSwgY29udGV4dCk7CgkJCX0sCgoJCQkvLyBSZW1vdmUgb25lIG9yIG1hbnkgY2FsbGJhY2tzLiBJZiBgY29udGV4dGAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKCQkJLy8gY2FsbGJhY2tzIHdpdGggdGhhdCBmdW5jdGlvbi4gSWYgYGNhbGxiYWNrYCBpcyBudWxsLCByZW1vdmVzIGFsbAoJCQkvLyBjYWxsYmFja3MgZm9yIHRoZSBldmVudC4gSWYgYG5hbWVgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kCgkJCS8vIGNhbGxiYWNrcyBmb3IgYWxsIGV2ZW50cy4KCQkJb2ZmOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewoJCQkJdmFyIHJldGFpbiwgZXYsIGV2ZW50cywgbmFtZXMsIGksIGwsIGosIGs7CgkJCQlpZiAoIXRoaXMuX2V2ZW50cyB8fCAhZXZlbnRzQXBpKHRoaXMsICdvZmYnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSkKCQkJCQlyZXR1cm4gdGhpczsKCQkJCWlmICghbmFtZSAmJiAhY2FsbGJhY2sgJiYgIWNvbnRleHQpIHsKCQkJCQl0aGlzLl9ldmVudHMgPSB1bmRlZmluZWQ7CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9CgoJCQkJbmFtZXMgPSBuYW1lID8gW25hbWVdIDogT2JqZWN0LmtleXModGhpcy5fZXZlbnRzKTsKCQkJCWZvciAoaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKCQkJCQluYW1lID0gbmFtZXNbaV07CgkJCQkJaWYgKGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXSkgewoJCQkJCQl0aGlzLl9ldmVudHNbbmFtZV0gPSByZXRhaW4gPSBbXTsKCQkJCQkJaWYgKGNhbGxiYWNrIHx8IGNvbnRleHQpIHsKCQkJCQkJCWZvciAoaiA9IDAsIGsgPSBldmVudHMubGVuZ3RoOyBqIDwgazsgaisrKSB7CgkJCQkJCQkJZXYgPSBldmVudHNbal07CgkJCQkJCQkJaWYgKChjYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gZXYuY2FsbGJhY2sgJiYKCQkJCQkJCQkJCWNhbGxiYWNrICE9PSBldi5jYWxsYmFjay5fY2FsbGJhY2spIHx8CgkJCQkJCQkJCQkoY29udGV4dCAmJiBjb250ZXh0ICE9PSBldi5jb250ZXh0KSkgewoJCQkJCQkJCQlyZXRhaW4ucHVzaChldik7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJCWlmICghcmV0YWluLmxlbmd0aCkgZGVsZXRlIHRoaXMuX2V2ZW50c1tuYW1lXTsKCQkJCQl9CgkJCQl9CgoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgoJCQkvLyBUcmlnZ2VyIG9uZSBvciBtYW55IGV2ZW50cywgZmlyaW5nIGFsbCBib3VuZCBjYWxsYmFja3MuIENhbGxiYWNrcyBhcmUKCQkJLy8gcGFzc2VkIHRoZSBzYW1lIGFyZ3VtZW50cyBhcyBgdHJpZ2dlcmAgaXMsIGFwYXJ0IGZyb20gdGhlIGV2ZW50IG5hbWUKCQkJLy8gKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwoJCQkvLyByZWNlaXZlIHRoZSB0cnVlIG5hbWUgb2YgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBhcmd1bWVudCkuCgkJCXRyaWdnZXI6IGZ1bmN0aW9uKG5hbWUpIHsKCQkJCWlmICghdGhpcy5fZXZlbnRzKSByZXR1cm4gdGhpczsKCQkJCXZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwoJCQkJaWYgKCFldmVudHNBcGkodGhpcywgJ3RyaWdnZXInLCBuYW1lLCBhcmdzKSkgcmV0dXJuIHRoaXM7CgkJCQl2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdOwoJCQkJdmFyIGFsbEV2ZW50cyA9IHRoaXMuX2V2ZW50cy5hbGw7CgkJCQlpZiAoZXZlbnRzKSB0cmlnZ2VyRXZlbnRzKGV2ZW50cywgYXJncyk7CgkJCQlpZiAoYWxsRXZlbnRzKSB0cmlnZ2VyRXZlbnRzKGFsbEV2ZW50cywgYXJndW1lbnRzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9LAoKCQkJLy8gVGVsbCB0aGlzIG9iamVjdCB0byBzdG9wIGxpc3RlbmluZyB0byBlaXRoZXIgc3BlY2lmaWMgZXZlbnRzIC4uLiBvcgoJCQkvLyB0byBldmVyeSBvYmplY3QgaXQncyBjdXJyZW50bHkgbGlzdGVuaW5nIHRvLgoJCQlzdG9wTGlzdGVuaW5nOiBmdW5jdGlvbihvYmosIG5hbWUsIGNhbGxiYWNrKSB7CgkJCQl2YXIgbGlzdGVuaW5nVG8gPSB0aGlzLl9saXN0ZW5pbmdUbzsKCQkJCWlmICghbGlzdGVuaW5nVG8pIHJldHVybiB0aGlzOwoJCQkJdmFyIHJlbW92ZSA9ICFuYW1lICYmICFjYWxsYmFjazsKCQkJCWlmICghY2FsbGJhY2sgJiYgdHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSBjYWxsYmFjayA9IHRoaXM7CgkJCQlpZiAob2JqKSAobGlzdGVuaW5nVG8gPSB7fSlbb2JqLl9saXN0ZW5JZF0gPSBvYmo7CgkJCQlmb3IgKHZhciBpZCBpbiBsaXN0ZW5pbmdUbykgewoJCQkJCW9iaiA9IGxpc3RlbmluZ1RvW2lkXTsKCQkJCQlvYmoub2ZmKG5hbWUsIGNhbGxiYWNrLCB0aGlzKTsKCQkJCQlpZiAocmVtb3ZlIHx8ICFPYmplY3Qua2V5cyhvYmouX2V2ZW50cykubGVuZ3RoKSB7CgkJCQkJCWRlbGV0ZSB0aGlzLl9saXN0ZW5pbmdUb1tpZF07CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuIHRoaXM7CgkJCX0KCgl9OwoKCS8vIFJlZ3VsYXIgZXhwcmVzc2lvbiB1c2VkIHRvIHNwbGl0IGV2ZW50IHN0cmluZ3MuCgl2YXIgZXZlbnRTcGxpdHRlciA9IC9ccysvOwoKCS8vIEltcGxlbWVudCBmYW5jeSBmZWF0dXJlcyBvZiB0aGUgRXZlbnRzIEFQSSBzdWNoIGFzIG11bHRpcGxlIGV2ZW50CgkvLyBuYW1lcyBgImNoYW5nZSBibHVyImAgYW5kIGpRdWVyeS1zdHlsZSBldmVudCBtYXBzIGB7Y2hhbmdlOiBhY3Rpb259YAoJLy8gaW4gdGVybXMgb2YgdGhlIGV4aXN0aW5nIEFQSS4KCXZhciBldmVudHNBcGkgPSBmdW5jdGlvbihvYmosIGFjdGlvbiwgbmFtZSwgcmVzdCkgewoJCWlmICghbmFtZSkgcmV0dXJuIHRydWU7CgkJdmFyIGFycjsKCgkJLy8gSGFuZGxlIGV2ZW50IG1hcHMuCgkJaWYgKHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgewoJCQlmb3IgKHZhciBrZXkgaW4gbmFtZSkgewoJCQkJYXJyID0gW2tleSwgbmFtZVtrZXldXTsKCQkJCXB1c2guYXBwbHkoYXJyLCByZXN0KTsKCQkJCW9ialthY3Rpb25dLmFwcGx5KG9iaiwgYXJyKTsKCQkJfQoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQkvLyBIYW5kbGUgc3BhY2Ugc2VwYXJhdGVkIGV2ZW50IG5hbWVzLgoJCWlmIChldmVudFNwbGl0dGVyLnRlc3QobmFtZSkpIHsKCQkJdmFyIG5hbWVzID0gbmFtZS5zcGxpdChldmVudFNwbGl0dGVyKTsKCQkJZm9yICh2YXIgaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKCQkJCWFyciA9IFtuYW1lc1tpXV07CgkJCQlwdXNoLmFwcGx5KGFyciwgcmVzdCk7CgkJCQlvYmpbYWN0aW9uXS5hcHBseShvYmosIGFycik7CgkJCX0KCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJcmV0dXJuIHRydWU7Cgl9OwoKCS8vIEEgZGlmZmljdWx0LXRvLWJlbGlldmUsIGJ1dCBvcHRpbWl6ZWQgaW50ZXJuYWwgZGlzcGF0Y2ggZnVuY3Rpb24gZm9yCgkvLyB0cmlnZ2VyaW5nIGV2ZW50cy4gVHJpZXMgdG8ga2VlcCB0aGUgdXN1YWwgY2FzZXMgc3BlZWR5IChtb3N0IGludGVybmFsCgkvLyBCYWNrYm9uZSBldmVudHMgaGF2ZSAzIGFyZ3VtZW50cykuCgl2YXIgdHJpZ2dlckV2ZW50cyA9IGZ1bmN0aW9uKGV2ZW50cywgYXJncykgewoJCXZhciBldiwgaSA9IC0xLCBsID0gZXZlbnRzLmxlbmd0aCwgYTEgPSBhcmdzWzBdLCBhMiA9IGFyZ3NbMV0sIGEzID0gYXJnc1syXTsKCQlzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7CgkJY2FzZSAwOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCk7IHJldHVybjsKCQljYXNlIDE6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSk7IHJldHVybjsKCQljYXNlIDI6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIpOyByZXR1cm47CgkJY2FzZSAzOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEsIGEyLCBhMyk7IHJldHVybjsKCQlkZWZhdWx0OiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5hcHBseShldi5jdHgsIGFyZ3MpOwoJCX0KCX07CgoJdmFyIGxpc3Rlbk1ldGhvZHMgPSB7bGlzdGVuVG86ICdvbicsIGxpc3RlblRvT25jZTogJ29uY2UnfTsKCgkvLyBJbnZlcnNpb24tb2YtY29udHJvbCB2ZXJzaW9ucyBvZiBgb25gIGFuZCBgb25jZWAuIFRlbGwgKnRoaXMqIG9iamVjdCB0bwoJLy8gbGlzdGVuIHRvIGFuIGV2ZW50IGluIGFub3RoZXIgb2JqZWN0IC4uLiBrZWVwaW5nIHRyYWNrIG9mIHdoYXQgaXQncwoJLy8gbGlzdGVuaW5nIHRvLgoJT2JqZWN0LmtleXMobGlzdGVuTWV0aG9kcykuZm9yRWFjaChmdW5jdGlvbihtZXRob2QpIHsKCQl2YXIgaW1wbGVtZW50YXRpb24gPSBsaXN0ZW5NZXRob2RzW21ldGhvZF07CgkJRXZlbnRzW21ldGhvZF0gPSBmdW5jdGlvbihvYmosIG5hbWUsIGNhbGxiYWNrKSB7CgkJCXZhciBsaXN0ZW5pbmdUbyA9IHRoaXMuX2xpc3RlbmluZ1RvIHx8ICh0aGlzLl9saXN0ZW5pbmdUbyA9IHt9KTsKCQkJdmFyIGlkID0gb2JqLl9saXN0ZW5JZCB8fCAob2JqLl9saXN0ZW5JZCA9IF8udW5pcXVlSWQoJ2wnKSk7CgkJCWxpc3RlbmluZ1RvW2lkXSA9IG9iajsKCQkJaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIGNhbGxiYWNrID0gdGhpczsKCQkJb2JqW2ltcGxlbWVudGF0aW9uXShuYW1lLCBjYWxsYmFjaywgdGhpcyk7CgkJCXJldHVybiB0aGlzOwoJCX07Cgl9KTsKCgkvLyBBbGlhc2VzIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KCUV2ZW50cy5iaW5kICAgPSBFdmVudHMub247CglFdmVudHMudW5iaW5kID0gRXZlbnRzLm9mZjsKCgkvKiByb3V0ZXIgKi8KCgkvLyBCYWNrYm9uZS5Sb3V0ZXIKCS8vIC0tLS0tLS0tLS0tLS0tLQoKCS8vIFJvdXRlcnMgbWFwIGZhdXgtVVJMcyB0byBhY3Rpb25zLCBhbmQgZmlyZSBldmVudHMgd2hlbiByb3V0ZXMgYXJlCgkvLyBtYXRjaGVkLiBDcmVhdGluZyBhIG5ldyBvbmUgc2V0cyBpdHMgYHJvdXRlc2AgaGFzaCwgaWYgbm90IHNldCBzdGF0aWNhbGx5LgoJdmFyIFJvdXRlciA9IEJhY2tib25lLlJvdXRlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCQlvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoJCWlmIChvcHRpb25zLnJvdXRlcykgdGhpcy5yb3V0ZXMgPSBvcHRpb25zLnJvdXRlczsKCQl0aGlzLl9iaW5kUm91dGVzKCk7CgkJdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cgl9OwoKCS8vIENhY2hlZCByZWd1bGFyIGV4cHJlc3Npb25zIGZvciBtYXRjaGluZyBuYW1lZCBwYXJhbSBwYXJ0cyBhbmQgc3BsYXR0ZWQKCS8vIHBhcnRzIG9mIHJvdXRlIHN0cmluZ3MuCgl2YXIgb3B0aW9uYWxQYXJhbSA9IC9cKCguKj8pXCkvZzsKCXZhciBuYW1lZFBhcmFtICAgID0gLyhcKFw/KT86XHcrL2c7Cgl2YXIgc3BsYXRQYXJhbSAgICA9IC9cKlx3Ky9nOwoJdmFyIGVzY2FwZVJlZ0V4cCAgPSAvW1wte31cW1xdKz8uLFxcXF4kfCNcc10vZzsKCgl2YXIgaXNSZWdFeHAgPSBmdW5jdGlvbih2YWx1ZSkgewoJCXJldHVybiB2YWx1ZSA/ICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmIHRvU3RyaW5nLmNhbGwodmFsdWUpID09PSAnW29iamVjdCBSZWdFeHBdJykgOiBmYWxzZTsKCX07CgoJLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLlJvdXRlcioqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCglfLmV4dGVuZChSb3V0ZXIucHJvdG90eXBlLCBFdmVudHMsIHsKCgkJLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCgkJLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCgkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKCQkvLyBNYW51YWxseSBiaW5kIGEgc2luZ2xlIG5hbWVkIHJvdXRlIHRvIGEgY2FsbGJhY2suIEZvciBleGFtcGxlOgoJCS8vCgkJLy8gICAgIHRoaXMucm91dGUoJ3NlYXJjaC86cXVlcnkvcDpudW0nLCAnc2VhcmNoJywgZnVuY3Rpb24ocXVlcnksIG51bSkgewoJCS8vICAgICAgIC4uLgoJCS8vICAgICB9KTsKCQkvLwoJCXJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgbmFtZSwgY2FsbGJhY2spIHsKCQkJaWYgKCFpc1JlZ0V4cChyb3V0ZSkpIHJvdXRlID0gdGhpcy5fcm91dGVUb1JlZ0V4cChyb3V0ZSk7CgkJCWlmICh0eXBlb2YgbmFtZSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJY2FsbGJhY2sgPSBuYW1lOwoJCQkJbmFtZSA9ICcnOwoJCQl9CgkJCWlmICghY2FsbGJhY2spIGNhbGxiYWNrID0gdGhpc1tuYW1lXTsKCQkJdmFyIHJvdXRlciA9IHRoaXM7CgkJCUJhY2tib25lLmhpc3Rvcnkucm91dGUocm91dGUsIGZ1bmN0aW9uKGZyYWdtZW50KSB7CgkJCQl2YXIgYXJncyA9IHJvdXRlci5fZXh0cmFjdFBhcmFtZXRlcnMocm91dGUsIGZyYWdtZW50KTsKCQkJCXJvdXRlci5leGVjdXRlKGNhbGxiYWNrLCBhcmdzKTsKCQkJCXJvdXRlci50cmlnZ2VyLmFwcGx5KHJvdXRlciwgWydyb3V0ZTonICsgbmFtZV0uY29uY2F0KGFyZ3MpKTsKCQkJCXJvdXRlci50cmlnZ2VyKCdyb3V0ZScsIG5hbWUsIGFyZ3MpOwoJCQkJQmFja2JvbmUuaGlzdG9yeS50cmlnZ2VyKCdyb3V0ZScsIHJvdXRlciwgbmFtZSwgYXJncyk7CgkJCX0pOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQkvLyBFeGVjdXRlIGEgcm91dGUgaGFuZGxlciB3aXRoIHRoZSBwcm92aWRlZCBwYXJhbWV0ZXJzLiAgVGhpcyBpcyBhbgoJCS8vIGV4Y2VsbGVudCBwbGFjZSB0byBkbyBwcmUtcm91dGUgc2V0dXAgb3IgcG9zdC1yb3V0ZSBjbGVhbnVwLgoJCWV4ZWN1dGU6IGZ1bmN0aW9uKGNhbGxiYWNrLCBhcmdzKSB7CgkJCWlmIChjYWxsYmFjaykgY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7CgkJfSwKCgkJLy8gU2ltcGxlIHByb3h5IHRvIGBCYWNrYm9uZS5oaXN0b3J5YCB0byBzYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGlzdG9yeS4KCQluYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKCQkJQmFja2JvbmUuaGlzdG9yeS5uYXZpZ2F0ZShmcmFnbWVudCwgb3B0aW9ucyk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCS8vIEJpbmQgYWxsIGRlZmluZWQgcm91dGVzIHRvIGBCYWNrYm9uZS5oaXN0b3J5YC4gV2UgaGF2ZSB0byByZXZlcnNlIHRoZQoJCS8vIG9yZGVyIG9mIHRoZSByb3V0ZXMgaGVyZSB0byBzdXBwb3J0IGJlaGF2aW9yIHdoZXJlIHRoZSBtb3N0IGdlbmVyYWwKCQkvLyByb3V0ZXMgY2FuIGJlIGRlZmluZWQgYXQgdGhlIGJvdHRvbSBvZiB0aGUgcm91dGUgbWFwLgoJCV9iaW5kUm91dGVzOiBmdW5jdGlvbigpIHsKCQkJaWYgKCF0aGlzLnJvdXRlcykgcmV0dXJuOwoJCQl0aGlzLnJvdXRlcyA9IF8ucmVzdWx0KHRoaXMsICdyb3V0ZXMnKTsKCQkJdmFyIHJvdXRlLCByb3V0ZXMgPSBPYmplY3Qua2V5cyh0aGlzLnJvdXRlcyk7CgkJCXdoaWxlICgocm91dGUgPSByb3V0ZXMucG9wKCkpICE9IG51bGwpIHsKCQkJCXRoaXMucm91dGUocm91dGUsIHRoaXMucm91dGVzW3JvdXRlXSk7CgkJCX0KCQl9LAoKCQkvLyBDb252ZXJ0IGEgcm91dGUgc3RyaW5nIGludG8gYSByZWd1bGFyIGV4cHJlc3Npb24sIHN1aXRhYmxlIGZvciBtYXRjaGluZwoJCS8vIGFnYWluc3QgdGhlIGN1cnJlbnQgbG9jYXRpb24gaGFzaC4KCQlfcm91dGVUb1JlZ0V4cDogZnVuY3Rpb24ocm91dGUpIHsKCQkJcm91dGUgPSByb3V0ZS5yZXBsYWNlKGVzY2FwZVJlZ0V4cCwgJ1xcJCYnKQoJCQkucmVwbGFjZShvcHRpb25hbFBhcmFtLCAnKD86JDEpPycpCgkJCS5yZXBsYWNlKG5hbWVkUGFyYW0sIGZ1bmN0aW9uKG1hdGNoLCBvcHRpb25hbCkgewoJCQkJcmV0dXJuIG9wdGlvbmFsID8gbWF0Y2ggOiAnKFteLz9dKyknOwoJCQl9KQoJCQkucmVwbGFjZShzcGxhdFBhcmFtLCAnKFteP10qPyknKTsKCQkJcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcm91dGUgKyAnKD86XFw/KFtcXHNcXFNdKikpPyQnKTsKCQl9LAoKCQkvLyBHaXZlbiBhIHJvdXRlLCBhbmQgYSBVUkwgZnJhZ21lbnQgdGhhdCBpdCBtYXRjaGVzLCByZXR1cm4gdGhlIGFycmF5IG9mCgkJLy8gZXh0cmFjdGVkIGRlY29kZWQgcGFyYW1ldGVycy4gRW1wdHkgb3IgdW5tYXRjaGVkIHBhcmFtZXRlcnMgd2lsbCBiZQoJCS8vIHRyZWF0ZWQgYXMgYG51bGxgIHRvIG5vcm1hbGl6ZSBjcm9zcy1icm93c2VyIGJlaGF2aW9yLgoJCV9leHRyYWN0UGFyYW1ldGVyczogZnVuY3Rpb24ocm91dGUsIGZyYWdtZW50KSB7CgkJCXZhciBwYXJhbXMgPSByb3V0ZS5leGVjKGZyYWdtZW50KS5zbGljZSgxKTsKCQkJcmV0dXJuIHBhcmFtcy5tYXAoZnVuY3Rpb24ocGFyYW0sIGkpIHsKCQkJCS8vIERvbid0IGRlY29kZSB0aGUgc2VhcmNoIHBhcmFtcy4KCQkJCWlmIChpID09PSBwYXJhbXMubGVuZ3RoIC0gMSkgcmV0dXJuIHBhcmFtIHx8IG51bGw7CgkJCQlyZXR1cm4gcGFyYW0gPyBkZWNvZGVVUklDb21wb25lbnQocGFyYW0pIDogbnVsbDsKCQkJfSk7CgkJfQoKCX0pOwoKCS8qIGhpc3RvcnkgKi8KCgkvLyBCYWNrYm9uZS5IaXN0b3J5CgkvLyAtLS0tLS0tLS0tLS0tLS0tCgoJLy8gSGFuZGxlcyBjcm9zcy1icm93c2VyIGhpc3RvcnkgbWFuYWdlbWVudCwgYmFzZWQgb24gZWl0aGVyCgkvLyBbcHVzaFN0YXRlXShodHRwOi8vZGl2ZWludG9odG1sNS5pbmZvL2hpc3RvcnkuaHRtbCkgYW5kIHJlYWwgVVJMcywgb3IKCS8vIFtvbmhhc2hjaGFuZ2VdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvRE9NL3dpbmRvdy5vbmhhc2hjaGFuZ2UpCgkvLyBhbmQgVVJMIGZyYWdtZW50cy4KCXZhciBIaXN0b3J5ID0gQmFja2JvbmUuSGlzdG9yeSA9IGZ1bmN0aW9uKCkgewoJCXRoaXMuaGFuZGxlcnMgPSBbXTsKCQl0aGlzLmNoZWNrVXJsID0gdGhpcy5jaGVja1VybC5iaW5kKHRoaXMpOwoKCQkvLyBFbnN1cmUgdGhhdCBgSGlzdG9yeWAgY2FuIGJlIHVzZWQgb3V0c2lkZSBvZiB0aGUgYnJvd3Nlci4KCQlpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbjsKCQkJdGhpcy5oaXN0b3J5ID0gd2luZG93Lmhpc3Rvcnk7CgkJfQoJfTsKCgkvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBhIGxlYWRpbmcgaGFzaC9zbGFzaCBhbmQgdHJhaWxpbmcgc3BhY2UuCgl2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOwoKCS8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoZXMuCgl2YXIgcm9vdFN0cmlwcGVyID0gL15cLyt8XC8rJC9nOwoKCS8vIENhY2hlZCByZWdleCBmb3IgcmVtb3ZpbmcgYSB0cmFpbGluZyBzbGFzaC4KCXZhciB0cmFpbGluZ1NsYXNoID0gL1wvJC87CgoJLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgdXJscyBvZiBoYXNoIGFuZCBxdWVyeS4KCXZhciBwYXRoU3RyaXBwZXIgPSAvWyNdLiokLzsKCgkvLyBIYXMgdGhlIGhpc3RvcnkgaGFuZGxpbmcgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQ/CglIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKCgkvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuSGlzdG9yeSoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCglfLmV4dGVuZChIaXN0b3J5LnByb3RvdHlwZSwgRXZlbnRzLCB7CgoJCS8vIEFyZSB3ZSBhdCB0aGUgYXBwIHJvb3Q/CgkJYXRSb290OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMubG9jYXRpb24ucGF0aG5hbWUucmVwbGFjZSgvW15cL10kLywgJyQmLycpID09PSB0aGlzLnJvb3Q7CgkJfSwKCgkJLy8gR2V0cyB0aGUgdHJ1ZSBoYXNoIHZhbHVlLiBDYW5ub3QgdXNlIGxvY2F0aW9uLmhhc2ggZGlyZWN0bHkgZHVlIHRvIGJ1ZwoJCS8vIGluIEZpcmVmb3ggd2hlcmUgbG9jYXRpb24uaGFzaCB3aWxsIGFsd2F5cyBiZSBkZWNvZGVkLgoJCWdldEhhc2g6IGZ1bmN0aW9uKHdpbmRvdykgewoJCQl2YXIgbWF0Y2ggPSAod2luZG93IHx8IHRoaXMpLmxvY2F0aW9uLmhyZWYubWF0Y2goLyMoLiopJC8pOwoJCQlyZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6ICcnOwoJCX0sCgoJCS8vIEdldCB0aGUgY3Jvc3MtYnJvd3NlciBub3JtYWxpemVkIFVSTCBmcmFnbWVudCwgZWl0aGVyIGZyb20gdGhlIFVSTCwKCQkvLyB0aGUgaGFzaCwgb3IgdGhlIG92ZXJyaWRlLgoJCWdldEZyYWdtZW50OiBmdW5jdGlvbihmcmFnbWVudCwgZm9yY2VQdXNoU3RhdGUpIHsKCQkJaWYgKGZyYWdtZW50ID09IG51bGwpIHsKCQkJCWlmICh0aGlzLl93YW50c1B1c2hTdGF0ZSB8fCAhdGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CgkJCQkJZnJhZ21lbnQgPSBkZWNvZGVVUkkodGhpcy5sb2NhdGlvbi5wYXRobmFtZSArIHRoaXMubG9jYXRpb24uc2VhcmNoKTsKCQkJCQl2YXIgcm9vdCA9IHRoaXMucm9vdC5yZXBsYWNlKHRyYWlsaW5nU2xhc2gsICcnKTsKCQkJCQlpZiAoIWZyYWdtZW50LmluZGV4T2Yocm9vdCkpIGZyYWdtZW50ID0gZnJhZ21lbnQuc2xpY2Uocm9vdC5sZW5ndGgpOwoJCQkJfSBlbHNlIHsKCQkJCQlmcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpOwoJCQkJfQoJCQl9CgkJCXJldHVybiBmcmFnbWVudC5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsKCQl9LAoKCQkvLyBTdGFydCB0aGUgaGFzaCBjaGFuZ2UgaGFuZGxpbmcsIHJldHVybmluZyBgdHJ1ZWAgaWYgdGhlIGN1cnJlbnQgVVJMIG1hdGNoZXMKCQkvLyBhbiBleGlzdGluZyByb3V0ZSwgYW5kIGBmYWxzZWAgb3RoZXJ3aXNlLgoJCXN0YXJ0OiBmdW5jdGlvbihvcHRpb25zKSB7CgkJCWlmIChIaXN0b3J5LnN0YXJ0ZWQpIHRocm93IG5ldyBFcnJvcigiQmFja2JvbmUuaGlzdG9yeSBoYXMgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQiKTsKCQkJSGlzdG9yeS5zdGFydGVkID0gdHJ1ZTsKCgkJCS8vIEZpZ3VyZSBvdXQgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbi4KCQkJLy8gSXMgcHVzaFN0YXRlIGRlc2lyZWQgb3Igc2hvdWxkIHdlIHVzZSBoYXNoY2hhbmdlIG9ubHk/CgkJCXRoaXMub3B0aW9ucyAgICAgICAgICA9IF8uZXh0ZW5kKHtyb290OiAnLyd9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMpOwoJCQl0aGlzLnJvb3QgICAgICAgICAgICAgPSB0aGlzLm9wdGlvbnMucm9vdDsKCQkJdGhpcy5fd2FudHNIYXNoQ2hhbmdlID0gdGhpcy5vcHRpb25zLmhhc2hDaGFuZ2UgIT09IGZhbHNlOwoJCQl0aGlzLl93YW50c1B1c2hTdGF0ZSAgPSAhIXRoaXMub3B0aW9ucy5wdXNoU3RhdGU7CgkJCXZhciBmcmFnbWVudCAgICAgICAgICA9IHRoaXMuZ2V0RnJhZ21lbnQoKTsKCgkJCS8vIE5vcm1hbGl6ZSByb290IHRvIGFsd2F5cyBpbmNsdWRlIGEgbGVhZGluZyBhbmQgdHJhaWxpbmcgc2xhc2guCgkJCXRoaXMucm9vdCA9ICgnLycgKyB0aGlzLnJvb3QgKyAnLycpLnJlcGxhY2Uocm9vdFN0cmlwcGVyLCAnLycpOwoKCQkJLy8gRGVwZW5kaW5nIG9uIHdoZXRoZXIgd2UncmUgdXNpbmcgcHVzaFN0YXRlIG9yIGhhc2hlcywgZGV0ZXJtaW5lIGhvdyB3ZQoJCQkvLyBjaGVjayB0aGUgVVJMIHN0YXRlLgoJCQlpZiAodGhpcy5fd2FudHNQdXNoU3RhdGUpIHsKCQkJCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwsIGZhbHNlKTsKCQkJfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKCQkJCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCwgZmFsc2UpOwoJCQl9CgoJCQkvLyBEZXRlcm1pbmUgaWYgd2UgbmVlZCB0byBjaGFuZ2UgdGhlIGJhc2UgdXJsLCBmb3IgYSBwdXNoU3RhdGUgbGluawoJCQkvLyBvcGVuZWQgYnkgYSBub24tcHVzaFN0YXRlIGJyb3dzZXIuCgkJCXRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKCQkJdmFyIGxvYyA9IHRoaXMubG9jYXRpb247CgoJCQkvLyBUcmFuc2l0aW9uIGZyb20gaGFzaENoYW5nZSB0byBwdXNoU3RhdGUgb3IgdmljZSB2ZXJzYSBpZiBib3RoIGFyZQoJCQkvLyByZXF1ZXN0ZWQuCgkJCWlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgdGhpcy5fd2FudHNQdXNoU3RhdGUpIHsKCgkJCQkvLyBJZiB3ZSd2ZSBzdGFydGVkIG91dCB3aXRoIGEgaGFzaC1iYXNlZCByb3V0ZSwgYnV0IHdlJ3JlIGN1cnJlbnRseQoJCQkJLy8gaW4gYSBicm93c2VyIHdoZXJlIGl0IGNvdWxkIGJlIGBwdXNoU3RhdGVgLWJhc2VkIGluc3RlYWQuLi4KCQkJCWlmICh0aGlzLmF0Um9vdCgpICYmIGxvYy5oYXNoKSB7CgkJCQkJdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpLnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwoJCQkJCXRoaXMuaGlzdG9yeS5yZXBsYWNlU3RhdGUoe30sIGRvY3VtZW50LnRpdGxlLCB0aGlzLnJvb3QgKyB0aGlzLmZyYWdtZW50KTsKCQkJCX0KCgkJCX0KCgkJCWlmICghdGhpcy5vcHRpb25zLnNpbGVudCkgcmV0dXJuIHRoaXMubG9hZFVybCgpOwoJCX0sCgoJCS8vIERpc2FibGUgQmFja2JvbmUuaGlzdG9yeSwgcGVyaGFwcyB0ZW1wb3JhcmlseS4gTm90IHVzZWZ1bCBpbiBhIHJlYWwgYXBwLAoJCS8vIGJ1dCBwb3NzaWJseSB1c2VmdWwgZm9yIHVuaXQgdGVzdGluZyBSb3V0ZXJzLgoJCXN0b3A6IGZ1bmN0aW9uKCkgewoJCQl3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKTsKCQkJd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsKCQkJSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CgkJfSwKCgkJLy8gQWRkIGEgcm91dGUgdG8gYmUgdGVzdGVkIHdoZW4gdGhlIGZyYWdtZW50IGNoYW5nZXMuIFJvdXRlcyBhZGRlZCBsYXRlcgoJCS8vIG1heSBvdmVycmlkZSBwcmV2aW91cyByb3V0ZXMuCgkJcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBjYWxsYmFjaykgewoJCQl0aGlzLmhhbmRsZXJzLnVuc2hpZnQoe3JvdXRlOiByb3V0ZSwgY2FsbGJhY2s6IGNhbGxiYWNrfSk7CgkJfSwKCgkJLy8gQ2hlY2tzIHRoZSBjdXJyZW50IFVSTCB0byBzZWUgaWYgaXQgaGFzIGNoYW5nZWQsIGFuZCBpZiBpdCBoYXMsCgkJLy8gY2FsbHMgYGxvYWRVcmxgLgoJCWNoZWNrVXJsOiBmdW5jdGlvbigpIHsKCQkJdmFyIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KCk7CgkJCWlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50KSByZXR1cm4gZmFsc2U7CgkJCXRoaXMubG9hZFVybCgpOwoJCX0sCgoJCS8vIEF0dGVtcHQgdG8gbG9hZCB0aGUgY3VycmVudCBVUkwgZnJhZ21lbnQuIElmIGEgcm91dGUgc3VjY2VlZHMgd2l0aCBhCgkJLy8gbWF0Y2gsIHJldHVybnMgYHRydWVgLiBJZiBubyBkZWZpbmVkIHJvdXRlcyBtYXRjaGVzIHRoZSBmcmFnbWVudCwKCQkvLyByZXR1cm5zIGBmYWxzZWAuCgkJbG9hZFVybDogZnVuY3Rpb24oZnJhZ21lbnQpIHsKCQkJZnJhZ21lbnQgPSB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudCk7CgkJCXJldHVybiB0aGlzLmhhbmRsZXJzLnNvbWUoZnVuY3Rpb24oaGFuZGxlcikgewoJCQkJaWYgKGhhbmRsZXIucm91dGUudGVzdChmcmFnbWVudCkpIHsKCQkJCQloYW5kbGVyLmNhbGxiYWNrKGZyYWdtZW50KTsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0KCQkJfSk7CgkJfSwKCgkJLy8gU2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhhc2ggaGlzdG9yeSwgb3IgcmVwbGFjZSB0aGUgVVJMIHN0YXRlIGlmIHRoZQoJCS8vICdyZXBsYWNlJyBvcHRpb24gaXMgcGFzc2VkLiBZb3UgYXJlIHJlc3BvbnNpYmxlIGZvciBwcm9wZXJseSBVUkwtZW5jb2RpbmcKCQkvLyB0aGUgZnJhZ21lbnQgaW4gYWR2YW5jZS4KCQkvLwoJCS8vIFRoZSBvcHRpb25zIG9iamVjdCBjYW4gY29udGFpbiBgdHJpZ2dlcjogdHJ1ZWAgaWYgeW91IHdpc2ggdG8gaGF2ZSB0aGUKCQkvLyByb3V0ZSBjYWxsYmFjayBiZSBmaXJlZCAobm90IHVzdWFsbHkgZGVzaXJhYmxlKSwgb3IgYHJlcGxhY2U6IHRydWVgLCBpZgoJCS8vIHlvdSB3aXNoIHRvIG1vZGlmeSB0aGUgY3VycmVudCBVUkwgd2l0aG91dCBhZGRpbmcgYW4gZW50cnkgdG8gdGhlIGhpc3RvcnkuCgkJbmF2aWdhdGU6IGZ1bmN0aW9uKGZyYWdtZW50LCBvcHRpb25zKSB7CgkJCWlmICghSGlzdG9yeS5zdGFydGVkKSByZXR1cm4gZmFsc2U7CgkJCWlmICghb3B0aW9ucyB8fCBvcHRpb25zID09PSB0cnVlKSBvcHRpb25zID0ge3RyaWdnZXI6ICEhb3B0aW9uc307CgoJCQl2YXIgdXJsID0gdGhpcy5yb290ICsgKGZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudCB8fCAnJykpOwoKCQkJLy8gU3RyaXAgdGhlIGhhc2ggZm9yIG1hdGNoaW5nLgoJCQlmcmFnbWVudCA9IGZyYWdtZW50LnJlcGxhY2UocGF0aFN0cmlwcGVyLCAnJyk7CgoJCQlpZiAodGhpcy5mcmFnbWVudCA9PT0gZnJhZ21lbnQpIHJldHVybjsKCQkJdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwoKCQkJLy8gRG9uJ3QgaW5jbHVkZSBhIHRyYWlsaW5nIHNsYXNoIG9uIHRoZSByb290LgoJCQlpZiAoZnJhZ21lbnQgPT09ICcnICYmIHVybCAhPT0gJy8nKSB1cmwgPSB1cmwuc2xpY2UoMCwgLTEpOwoKCQkJLy8gSWYgd2UncmUgdXNpbmcgcHVzaFN0YXRlIHdlIHVzZSBpdCB0byBzZXQgdGhlIGZyYWdtZW50IGFzIGEgcmVhbCBVUkwuCgkJCWlmICh0aGlzLl93YW50c1B1c2hTdGF0ZSkgewoJCQkJdGhpcy5oaXN0b3J5W29wdGlvbnMucmVwbGFjZSA/ICdyZXBsYWNlU3RhdGUnIDogJ3B1c2hTdGF0ZSddKHt9LCBkb2N1bWVudC50aXRsZSwgdXJsKTsKCgkJCQkvLyBJZiBoYXNoIGNoYW5nZXMgaGF2ZW4ndCBiZWVuIGV4cGxpY2l0bHkgZGlzYWJsZWQsIHVwZGF0ZSB0aGUgaGFzaAoJCQkJLy8gZnJhZ21lbnQgdG8gc3RvcmUgaGlzdG9yeS4KCQkJfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKCQkJCXRoaXMuX3VwZGF0ZUhhc2godGhpcy5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CgkJCQkvLyBJZiB5b3UndmUgdG9sZCB1cyB0aGF0IHlvdSBleHBsaWNpdGx5IGRvbid0IHdhbnQgZmFsbGJhY2sgaGFzaGNoYW5nZS0KCQkJCS8vIGJhc2VkIGhpc3RvcnksIHRoZW4gYG5hdmlnYXRlYCBiZWNvbWVzIGEgcGFnZSByZWZyZXNoLgoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIHRoaXMubG9jYXRpb24uYXNzaWduKHVybCk7CgkJCX0KCQkJaWYgKG9wdGlvbnMudHJpZ2dlcikgcmV0dXJuIHRoaXMubG9hZFVybChmcmFnbWVudCk7CgkJfSwKCgkJLy8gVXBkYXRlIHRoZSBoYXNoIGxvY2F0aW9uLCBlaXRoZXIgcmVwbGFjaW5nIHRoZSBjdXJyZW50IGVudHJ5LCBvciBhZGRpbmcKCQkvLyBhIG5ldyBvbmUgdG8gdGhlIGJyb3dzZXIgaGlzdG9yeS4KCQlfdXBkYXRlSGFzaDogZnVuY3Rpb24obG9jYXRpb24sIGZyYWdtZW50LCByZXBsYWNlKSB7CgkJCWlmIChyZXBsYWNlKSB7CgkJCQl2YXIgaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvKGphdmFzY3JpcHQ6fCMpLiokLywgJycpOwoJCQkJbG9jYXRpb24ucmVwbGFjZShocmVmICsgJyMnICsgZnJhZ21lbnQpOwoJCQl9IGVsc2UgewoJCQkJLy8gU29tZSBicm93c2VycyByZXF1aXJlIHRoYXQgYGhhc2hgIGNvbnRhaW5zIGEgbGVhZGluZyAjLgoJCQkJbG9jYXRpb24uaGFzaCA9ICcjJyArIGZyYWdtZW50OwoJCQl9CgkJfQoKCX0pOwoKCS8qIGZvb3RlciAqLwoKCS8vICEhIQoJLy8gSW5pdC4KCVsnTW9kZWwnLCAnQ29sbGVjdGlvbicsICdSb3V0ZXInLCAnVmlldycsICdIaXN0b3J5J10uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CgkJdmFyIGl0ZW0gPSBCYWNrYm9uZVtuYW1lXTsKCQlpZiAoaXRlbSkgaXRlbS5leHRlbmQgPSBCYWNrYm9uZS5leHRlbmQ7Cgl9KTsKCgkvLyBBbGxvdyB0aGUgYEJhY2tib25lYCBvYmplY3QgdG8gc2VydmUgYXMgYSBnbG9iYWwgZXZlbnQgYnVzLCBmb3IgZm9sa3Mgd2hvCgkvLyB3YW50IGdsb2JhbCAicHVic3ViIiBpbiBhIGNvbnZlbmllbnQgcGxhY2UuCglfLmV4dGVuZChCYWNrYm9uZSwgRXZlbnRzKTsKCgkvLyBDcmVhdGUgdGhlIGRlZmF1bHQgQmFja2JvbmUuaGlzdG9yeSBpZiB0aGUgSGlzdG9yeSBtb2R1bGUgaXMgaW5jbHVkZWQuCglpZiAoSGlzdG9yeSkgQmFja2JvbmUuaGlzdG9yeSA9IG5ldyBIaXN0b3J5KCk7CglyZXR1cm4gQmFja2JvbmU7Cn0pOwpkZWZpbmUoCgoJJ3NwYS9VdGlsaXR5JyxbJ0V4b3NrZWxldG9uJ10sCgoJZnVuY3Rpb24oKQoJewoJCQoKCQl2YXIgVXRpbGl0eSA9IEV4b3NrZWxldG9uLnV0aWxzLmV4dGVuZCh7fSwgRXhvc2tlbGV0b24udXRpbHMpOwoKCQlVdGlsaXR5Lm1lcmdlID0gVXRpbGl0eS5leHRlbmQ7CgoJCVV0aWxpdHkuaXNEZXNjZW5kYW50UHJvdG90eXBlT2YgPSBmdW5jdGlvbihwYXJlbnRQcm90b3R5cGUsIHByb3RvdHlwZSkKCQl7CgkJCXZhciBpc0Rlc2NlbmRhbnQgPSBmYWxzZTsKCgkJCXdoaWxlIChwcm90b3R5cGUKCQkJJiYgIWlzRGVzY2VuZGFudCkKCQkJewoJCQkJaWYgKHByb3RvdHlwZSA9PT0gcGFyZW50UHJvdG90eXBlKQoJCQkJCWlzRGVzY2VuZGFudCA9IHRydWU7CgoJCQkJcHJvdG90eXBlID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHByb3RvdHlwZSk7CgkJCX0KCgkJCXJldHVybiBpc0Rlc2NlbmRhbnQ7CgkJfTsKCgkJVXRpbGl0eS5pc0Rlc2NlbmRhbnRUeXBlT2YgPSBmdW5jdGlvbihwYXJlbnRUeXBlLCB0eXBlKQoJCXsKCQkJcmV0dXJuIFV0aWxpdHkuaXNEZXNjZW5kYW50UHJvdG90eXBlT2YocGFyZW50VHlwZS5wcm90b3R5cGUsIHR5cGUucHJvdG90eXBlKTsKCQl9OwoKCQlVdGlsaXR5LmlzVHlwZU9mID0gZnVuY3Rpb24odHlwZSwgdmFsdWUpCgkJewoJCQlzd2l0Y2ggKHR5cGUpCgkJCXsKCQkJCWNhc2UgU3RyaW5nOgoJCQkJCXJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnOwoJCQkJCWJyZWFrCgoJCQkJZGVmYXVsdDoKCQkJCQlyZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiB0eXBlOwoJCQkJCWJyZWFrOwoJCQl9CgoJCQlyZXR1cm4gZmFsc2U7CgkJfTsKCgkJcmV0dXJuIFV0aWxpdHk7Cgl9Cik7CmRlZmluZSgKCgknc3BhL0VudGl0eScsWycuL1V0aWxpdHknXSwKCglmdW5jdGlvbihVdGlsaXR5KQoJewoJCQoKCQl2YXIgdXRpbHMgPSBVdGlsaXR5OwoKCQl2YXIgX191Y2FzZSA9IGZ1bmN0aW9uKHN0cmluZykKCQl7CgkJCXJldHVybiBzdHJpbmcuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBzdHJpbmcuc2xpY2UoMSk7CgkJfTsKCgkJdmFyIF9fY2FsbE9yU2V0ID0gZnVuY3Rpb24ocHJlZml4LCBuYW1lLCB2YWx1ZSkKCQl7CgkJCXZhciBtZXRob2ROYW1lID0gcHJlZml4ICsgX191Y2FzZShuYW1lKTsKCgkJCWlmICh0aGlzW21ldGhvZE5hbWVdKQoJCQkJdGhpc1ttZXRob2ROYW1lXSh2YWx1ZSk7CgoJCQllbHNlCgkJCQl0aGlzW25hbWVdID0gdmFsdWU7CgkJfTsKCgkJdmFyIEVudGl0eSA9IGZ1bmN0aW9uKG9wdGlvbnMpCgkJewoJCQlvcHRpb25zID0gdXRpbHMuZXh0ZW5kKHt9LCB0aGlzLmNvbnN0cnVjdG9yLkRFRkFVTFRfT1BUSU9OUywgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsKCgkJCXRoaXMuYmluZEZ1bmN0aW9ucygpOwoJCQl0aGlzLmNvbmZpZ3VyZShvcHRpb25zKTsKCQkJdGhpcy5lbnN1cmVTdWJFbnRpdGllcyhvcHRpb25zKTsKCQkJdGhpcy5pbml0aWFsaXplKG9wdGlvbnMpOwoJCX07CgoJCXV0aWxzLm1lcmdlKEVudGl0eSwKCQl7CgkJCWJpbmQ6IGZ1bmN0aW9uKGZ1bmN0aW9uTmFtZXMpCgkJCXsKCQkJCWlmICghdGhpcy5fX2JvdW5kRnVuY3Rpb25OYW1lcykKCQkJCQl0aGlzLl9fYm91bmRGdW5jdGlvbk5hbWVzID0gW107CgoJCQkJZnVuY3Rpb25OYW1lcy5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpCgkJCQl7CgkJCQkJaWYgKHRoaXMuX19ib3VuZEZ1bmN0aW9uTmFtZXMuaW5kZXhPZihuYW1lKSA9PT0gLTEpCgkJCQkJCXRoaXMuX19ib3VuZEZ1bmN0aW9uTmFtZXMucHVzaChuYW1lKTsKCgkJCQl9LmJpbmQodGhpcykpOwoJCQl9LAoKCQkJdW5iaW5kOiBmdW5jdGlvbihuYW1lcykKCQkJewoJCQkJaWYgKHRoaXMuX19ib3VuZEZ1bmN0aW9uTmFtZXMpCgkJCQkJbmFtZXMuZm9yRWFjaChmdW5jdGlvbihuYW1lKQoJCQkJCXsKCQkJCQkJdmFyIGluZGV4ID0gdGhpcy5fX2JvdW5kRnVuY3Rpb25OYW1lcy5pbmRleE9mKG5hbWUpOwoKCQkJCQkJaWYgKGluZGV4ID4gLTEpCgkJCQkJCQl0aGlzLl9fYm91bmRGdW5jdGlvbk5hbWVzLnNwbGljZShpbmRleCwgMSk7CgoJCQkJCX0uYmluZCh0aGlzKSk7CgkJCX0sCgoJCQlkZWNsYXJlT3B0aW9uczogZnVuY3Rpb24odmFsdWVzKQoJCQl7CgkJCQlpZiAoIXRoaXMuX19vcHRpb25UeXBlcykKCQkJCQl0aGlzLl9fb3B0aW9uVHlwZXMgPSB7fTsKCgkJCQlmb3IgKHZhciBuYW1lIGluIHZhbHVlcykKCQkJCQl0aGlzLl9fb3B0aW9uVHlwZXNbbmFtZV0gPSB2YWx1ZXNbbmFtZV07CgkJCX0sCgoJCQl1bmRlY2xhcmVPcHRpb25zOiBmdW5jdGlvbihuYW1lcykKCQkJewoJCQkJbmFtZXMuZm9yRWFjaChmdW5jdGlvbihuYW1lKQoJCQkJewoJCQkJCWRlbGV0ZSB0aGlzLl9fb3B0aW9uVHlwZXNbbmFtZV07CgoJCQkJfS5iaW5kKHRoaXMpKQoJCQl9LAoKCQkJZGVjbGFyZVN1YkVudGl0aWVzOiBmdW5jdGlvbih2YWx1ZXMpCgkJCXsKCQkJCWlmICghdGhpcy5fX3N1YkVudGl0eVR5cGVzKQoJCQkJCXRoaXMuX19zdWJFbnRpdHlUeXBlcyA9IHt9OwoKCQkJCWZvciAodmFyIG5hbWUgaW4gdmFsdWVzKQoJCQkJCXRoaXMuX19zdWJFbnRpdHlUeXBlc1tuYW1lXSA9IHZhbHVlc1tuYW1lXTsKCQkJfSwKCgkJCXVuZGVjbGFyZVN1YkVudGl0aWVzOiBmdW5jdGlvbihuYW1lcykKCQkJewoJCQkJbmFtZXMuZm9yRWFjaChmdW5jdGlvbihuYW1lKQoJCQkJewoJCQkJCWRlbGV0ZSB0aGlzLl9fc3ViRW50aXR5VHlwZXNbbmFtZV07CgoJCQkJfS5iaW5kKHRoaXMpKQoJCQl9LAoKCQkJc2V0U3RhdGljOiBmdW5jdGlvbigpCgkJCXsKCQkJCXZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKCgkJCQlhcmdzLnVuc2hpZnQodGhpcyk7CgoJCQkJdXRpbHMubWVyZ2UuYXBwbHkodW5kZWZpbmVkLCBhcmdzKTsKCQkJfSwKCgkJCXNldFByb3RvdHlwZTogZnVuY3Rpb24oKQoJCQl7CgkJCQl2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CgoJCQkJYXJncy51bnNoaWZ0KHRoaXMucHJvdG90eXBlKTsKCgkJCQl1dGlscy5tZXJnZS5hcHBseSh1bmRlZmluZWQsIGFyZ3MpOwoJCQl9LAoKCQkJZXh0ZW5kOiBmdW5jdGlvbihjaGlsZCkKCQkJewoJCQkJdmFyIHBhcmVudCA9IHRoaXMsCgkJCQkJY29waWVkUHJvcGVydHlOYW1lcyA9IFsnX19ib3VuZEZ1bmN0aW9uTmFtZXMnLCAnX19vcHRpb25UeXBlcycsICdfX3N1YkVudGl0eVR5cGVzJywgJ0RFRkFVTFRfT1BUSU9OUyddOwoKCQkJCWlmICghY2hpbGQpCgkJCQkJY2hpbGQgPSBmdW5jdGlvbihvcHRpb25zKSB7IHBhcmVudC5jYWxsKHRoaXMsIG9wdGlvbnMpOyB9OwoKCQkJCWNoaWxkLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUocGFyZW50LnByb3RvdHlwZSk7CgkJCQljaGlsZC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBjaGlsZDsKCgkJCQlmb3IgKHZhciBwcm9wZXJ0eSBpbiBwYXJlbnQpCgkJCQkJaWYgKGNvcGllZFByb3BlcnR5TmFtZXMuaW5kZXhPZihwcm9wZXJ0eSkgPiAtMSkKCQkJCQl7CgkJCQkJCWlmICh0eXBlb2YgcGFyZW50W3Byb3BlcnR5XSA9PT0gJ0FycmF5JykKCQkJCQkJCWNoaWxkW3Byb3BlcnR5XSA9IHBhcmVudFtwcm9wZXJ0eV0uY29uY2F0KCk7CgoJCQkJCQllbHNlCgkJCQkJCQljaGlsZFtwcm9wZXJ0eV0gPSB1dGlscy5tZXJnZSh7fSwgcGFyZW50W3Byb3BlcnR5XSk7CgkJCQkJfQoKCQkJCQllbHNlCgkJCQkJCWNoaWxkW3Byb3BlcnR5XSA9IHBhcmVudFtwcm9wZXJ0eV07CgoJCQkJcmV0dXJuIGNoaWxkOwoJCQl9CgkJfSk7CgoJCXV0aWxzLm1lcmdlKEVudGl0eS5wcm90b3R5cGUsCgkJewoJCQl1dGlsczogdXRpbHMsCgoJCQliaW5kRnVuY3Rpb25zOiBmdW5jdGlvbigpCgkJCXsKCQkJCWlmICh0aGlzLmNvbnN0cnVjdG9yLl9fYm91bmRGdW5jdGlvbk5hbWVzKQoJCQkJCXRoaXMuY29uc3RydWN0b3IuX19ib3VuZEZ1bmN0aW9uTmFtZXMuZm9yRWFjaChmdW5jdGlvbihuYW1lKQoJCQkJCXsKCQkJCQkJaWYgKHRoaXNbbmFtZV0KCQkJCQkJJiYgdHlwZW9mIHRoaXNbbmFtZV0gPT09ICdmdW5jdGlvbicpCgkJCQkJCQl0aGlzW25hbWVdID0gdGhpc1tuYW1lXS5iaW5kKHRoaXMpOwoKCQkJCQl9LmJpbmQodGhpcykpOwoJCQl9LAoKCQkJY29uZmlndXJlOiBmdW5jdGlvbihvcHRpb25zKQoJCQl7CgkJCQlpZiAodGhpcy5jb25zdHJ1Y3Rvci5fX29wdGlvblR5cGVzKQoJCQkJCWZvciAodmFyIG5hbWUgaW4gdGhpcy5jb25zdHJ1Y3Rvci5fX29wdGlvblR5cGVzKQoJCQkJCXsKCQkJCQkJdmFyIHZhbHVlID0gb3B0aW9uc1tuYW1lXTsKCgkJCQkJCWlmICh0eXBlb2YgdmFsdWUgIT09ICd1bmRlZmluZWQnKQoJCQkJCQl7CgkJCQkJCQlpZiAoIVV0aWxpdHkuaXNUeXBlT2YodGhpcy5jb25zdHJ1Y3Rvci5fX29wdGlvblR5cGVzW25hbWVdLCB2YWx1ZSkpCgkJCQkJCQkJdGhyb3cgbmV3IEVycm9yKCdPcHRpb24gJyArIG5hbWUgKyAnIGlzIG5vdCB0aGUgY29ycmVjdCB0eXBlLicpOwoKCQkJCQkJCV9fY2FsbE9yU2V0LmNhbGwodGhpcywgJ3NldCcsIG5hbWUsIHZhbHVlKTsKCQkJCQkJfQoJCQkJCX0KCQkJfSwKCgkJCWVuc3VyZVN1YkVudGl0aWVzOiBmdW5jdGlvbihvcHRpb25zKQoJCQl7CgkJCQlpZiAodGhpcy5jb25zdHJ1Y3Rvci5fX3N1YkVudGl0eVR5cGVzKQoJCQkJCWZvciAodmFyIG5hbWUgaW4gdGhpcy5jb25zdHJ1Y3Rvci5fX3N1YkVudGl0eVR5cGVzKQoJCQkJCXsKCQkJCQkJdmFyIHR5cGUgPSB0aGlzLmNvbnN0cnVjdG9yLl9fc3ViRW50aXR5VHlwZXNbbmFtZV07CgkJCQkJCXZhciB2YWx1ZSA9IHRoaXNbbmFtZV0gfHwgb3B0aW9uc1tuYW1lXTsKCgkJCQkJCWlmICghdmFsdWUpCgkJCQkJCXsKCQkJCQkJCXZhciBtZXRob2ROYW1lID0gJ2NyZWF0ZScgKyBfX3VjYXNlKG5hbWUpOwoKCQkJCQkJCWlmICh0aGlzW21ldGhvZE5hbWVdKQoJCQkJCQkJCXZhbHVlID0gdGhpc1ttZXRob2ROYW1lXShvcHRpb25zKTsKCgkJCQkJCQllbHNlCgkJCQkJCQkJdmFsdWUgPSBuZXcgdHlwZSgpOwoJCQkJCQl9CgoJCQkJCQlpZiAoIVV0aWxpdHkuaXNUeXBlT2YodHlwZSwgdmFsdWUpKQoJCQkJCQkJdGhyb3cgbmV3IEVycm9yKCdTdWJlbnRpdHkgJyArIG5hbWUgKyAnIGlzIG5vdCB0aGUgY29ycmVjdCB0eXBlLicpOwoKCQkJCQkJX19jYWxsT3JTZXQuY2FsbCh0aGlzLCAnYWRkJywgbmFtZSwgdmFsdWUpOwoJCQkJCX0KCQkJfSwKCgkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpe30sCgoJCQlkaXNwb3NlU3ViRW50aXR5OiBmdW5jdGlvbihuYW1lKQoJCQl7CgkJCQl2YXIgbWV0aG9kTmFtZSA9ICdkaXNwb3NlJyArIG5hbWUuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBuYW1lLnNsaWNlKDEpOwoKCQkJCWlmICh0aGlzW21ldGhvZE5hbWVdKQoJCQkJCXRoaXNbbWV0aG9kTmFtZV0oKTsKCgkJCQllbHNlCgkJCQkJaWYgKHRoaXNbbmFtZV0KCQkJCQkmJiB0aGlzW25hbWVdLmZpbmFsaXplIGluc3RhbmNlb2YgRnVuY3Rpb24pCgkJCQkJewoJCQkJCQl0aGlzW25hbWVdLmZpbmFsaXplKCk7CgoJCQkJCQlkZWxldGUgdGhpc1tuYW1lXTsKCQkJCQl9CgkJCX0sCgoJCQlkaXNwb3NlU3ViRW50aXRpZXM6IGZ1bmN0aW9uKCkKCQkJewoJCQkJaWYgKHRoaXMuY29uc3RydWN0b3IuX19zdWJFbnRpdHlUeXBlcykKCQkJCQlmb3IgKHZhciBuYW1lIGluIHRoaXMuY29uc3RydWN0b3IuX19zdWJFbnRpdHlUeXBlcykKCQkJCQkJdGhpcy5kaXNwb3NlU3ViRW50aXR5KG5hbWUpOwoJCQl9LAoKCQkJZmluYWxpemU6IGZ1bmN0aW9uKCkKCQkJewoJCQkJdGhpcy5kaXNwb3NlU3ViRW50aXRpZXMoKTsKCQkJfQoJCX0pOwoKCQlyZXR1cm4gRW50aXR5OwoJfQopOwpkZWZpbmUoJ3NwYS9FdmVudEJyb2tlcicsWwoKCScuL0VudGl0eScsCgknRXhvc2tlbGV0b24nXSwKCglmdW5jdGlvbihFbnRpdHkpCgl7CgkJCgoJCXZhciBFdmVudEJyb2tlciA9IEVudGl0eS5leHRlbmQoKTsKCgkJRXZlbnRCcm9rZXIuc2V0UHJvdG90eXBlKEV4b3NrZWxldG9uLkV2ZW50cywKCQl7CgkJCXRyaWdnZXI6IGZ1bmN0aW9uKCkKCQkJewoJCQkJdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwoKCQkJCUV4b3NrZWxldG9uLkV2ZW50cy50cmlnZ2VyLmFwcGx5KHRoaXMsIGFyZ3MpOwoKCQkJCWFyZ3Muc3BsaWNlKDEsIDAsIHRoaXMpOwoKCQkJCUV4b3NrZWxldG9uLkV2ZW50cy50cmlnZ2VyLmFwcGx5KHRoaXMuYXBwLCBhcmdzKTsKCQkJfSwKCgkJCWZpbmFsaXplOiBmdW5jdGlvbigpCgkJCXsKCQkJCUVudGl0eS5wcm90b3R5cGUuZmluYWxpemUuY2FsbCh0aGlzKTsKCgkJCQl0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKCQkJCXRoaXMub2ZmKCk7CgkJCX0KCQl9KTsKCgkJcmV0dXJuIEV2ZW50QnJva2VyOwoJfQopOwpkZWZpbmUoJ3NwYS9WaWV3JyxbCgoJJy4vRXZlbnRCcm9rZXInXSwKCglmdW5jdGlvbihFdmVudEJyb2tlcikKCXsKCQkKCgkJdmFyIFZpZXcgPSBFdmVudEJyb2tlci5leHRlbmQoZnVuY3Rpb24ob3B0aW9ucykKCQl7CgkJCUV2ZW50QnJva2VyLmNhbGwodGhpcywgb3B0aW9ucyk7CgoJCQl0aGlzLmNpZCA9IHRoaXMudXRpbHMudW5pcXVlSWQoJ3ZpZXcnKTsKCQl9KTsKCgkJVmlldy5kZWNsYXJlT3B0aW9ucyh7cGFyZW50OlZpZXd9KTsKCgkJVmlldy5zZXRQcm90b3R5cGUoCgkJewoJCQlpc1JlYWR5OiBmdW5jdGlvbigpCgkJCXsKCQkJCXJldHVybiB0cnVlOwoJCQl9LAoKCQkJcHJlcGFyZTogZnVuY3Rpb24oKQoJCQl7CgkJCQl0aGlzLnRyaWdnZXIoJ3ZpZXc6cmVhZHknLCB0aGlzKTsKCQkJfSwKCgkJCXJlbmRlcjogZnVuY3Rpb24oKSB7fSwKCgkJCXJlbW92ZTogZnVuY3Rpb24oKQoJCQl7CgkJCQlpZiAodGhpcy5wYXJlbnQpCgkJCQkJdGhpcy5wYXJlbnQucmVtb3ZlQ2hpbGQodGhpcyk7CgoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgoJCQlhZGRDaGlsZDogZnVuY3Rpb24oY2hpbGQpCgkJCXsKCQkJCWlmICghdGhpcy5fY2hpbGRyZW4pCgkJCQkJdGhpcy5fY2hpbGRyZW4gPSBbXTsKCgkJCQlpZiAodGhpcy5fY2hpbGRyZW4uaW5kZXhPZihjaGlsZCkgPT09IC0xKQoJCQkJewoJCQkJCWlmIChjaGlsZC5wYXJlbnQpCgkJCQkJCWNoaWxkLnJlbW92ZSgpOwoKCQkJCQl0aGlzLl9jaGlsZHJlbi5wdXNoKGNoaWxkKTsKCgkJCQkJY2hpbGQucGFyZW50ID0gdGhpczsKCgkJCQkJY2hpbGQucmVuZGVyKCk7CgkJCQl9CgoJCQkJcmV0dXJuIGNoaWxkOwoJCQl9LAoKCQkJaGFzQ2hpbGRyZW46IGZ1bmN0aW9uKCkKCQkJewoJCQkJcmV0dXJuIHRoaXMubnVtQ2hpbGRyZW4oKSA+IDA7CgkJCX0sCgoJCQludW1DaGlsZHJlbjogZnVuY3Rpb24oKQoJCQl7CgkJCQlpZiAodGhpcy5fY2hpbGRyZW4pCgkJCQkJcmV0dXJuIHRoaXMuX2NoaWxkcmVuLmxlbmd0aDsKCgkJCQlyZXR1cm4gMDsKCQkJfSwKCgkJCWlzRGVzY2VuZGFudDogZnVuY3Rpb24odmlldykKCQkJewoJCQkJaWYgKHZpZXcucGFyZW50KQoJCQkJCXdoaWxlICh2aWV3LnBhcmVudCkKCQkJCQl7CgkJCQkJCWlmICh2aWV3LnBhcmVudCA9PT0gdGhpcykKCQkJCQkJCXJldHVybiB0cnVlOwoKCQkJCQkJdmlldyA9IHZpZXcucGFyZW50OwoJCQkJCX0KCgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0sCgoJCQlnZXRDaGlsZEluZGV4OiBmdW5jdGlvbihjaGlsZCkKCQkJewoJCQkJaWYgKCF0aGlzLl9jaGlsZHJlbikKCQkJCQlyZXR1cm4gLTE7CgoJCQkJcmV0dXJuIHRoaXMuX2NoaWxkcmVuLmluZGV4T2YoY2hpbGQpOwoJCQl9LAoKCQkJZ2V0Q2hpbGRBdDogZnVuY3Rpb24oaW5kZXgpCgkJCXsKCQkJCWlmICh0aGlzLl9jaGlsZHJlbgoJCQkJJiYgdGhpcy5fY2hpbGRyZW4ubGVuZ3RoID4gaW5kZXgpCgkJCQkJcmV0dXJuIHRoaXMuX2NoaWxkcmVuW2luZGV4XTsKCgkJCQlyZXR1cm4gdm9pZCAwOwoJCQl9LAoKCQkJcmVtb3ZlQ2hpbGQ6IGZ1bmN0aW9uKGNoaWxkKQoJCQl7CgkJCQl2YXIgaW5kZXggPSB0aGlzLmdldENoaWxkSW5kZXgoY2hpbGQpOwoKCQkJCWlmIChpbmRleCA+IC0xKQoJCQkJewoJCQkJCXRoaXMuX2NoaWxkcmVuLnNwbGljZShpbmRleCwgMSk7CgoJCQkJCXRoaXMuc3RvcExpc3RlbmluZyhjaGlsZCk7CgoJCQkJCWRlbGV0ZSBjaGlsZC5wYXJlbnQ7CgkJCQl9CgoJCQkJcmV0dXJuIGNoaWxkOwoJCQl9LAoKCQkJcmVtb3ZlQWxsQ2hpbGRyZW46IGZ1bmN0aW9uKCkKCQkJewoJCQkJd2hpbGUgKHRoaXMuaGFzQ2hpbGRyZW4oKSkKCQkJCQl0aGlzLnJlbW92ZUNoaWxkKHRoaXMuZ2V0Q2hpbGRBdEluZGV4KHRoaXMubnVtQ2hpbGRyZW4oKSAtIDEpKTsKCQkJfSwKCgkJCWRpc3Bvc2VDaGlsZDogZnVuY3Rpb24oY2hpbGQpCgkJCXsKCQkJCWNoaWxkLmZpbmFsaXplKCk7CgoJCQkJZm9yICh2YXIgbmFtZSBpbiB0aGlzKQoJCQkJCWlmICh0aGlzW25hbWVdID09PSBjaGlsZCkKCQkJCQkJZGVsZXRlIHRoaXNbbmFtZV07CgkJCX0sCgoJCQlmaW5hbGl6ZTogZnVuY3Rpb24oKQoJCQl7CgkJCQlpZiAodGhpcy5wYXJlbnQpCgkJCQkJdGhpcy5yZW1vdmUoKTsKCgkJCQl3aGlsZSAodGhpcy5oYXNDaGlsZHJlbigpKQoJCQkJCXRoaXMuZGlzcG9zZUNoaWxkKHRoaXMuZ2V0Q2hpbGRBdCh0aGlzLm51bUNoaWxkcmVuKCkgLSAxKSk7CgoJCQkJRXZlbnRCcm9rZXIucHJvdG90eXBlLmZpbmFsaXplLmNhbGwodGhpcyk7CgkJCX0KCQl9KTsKCgkJcmV0dXJuIFZpZXc7Cgl9Cik7CmRlZmluZSgKCgknc3BhL0RPTVZpZXcnLFsnLi9WaWV3J10sCgoJZnVuY3Rpb24oVmlldykKCXsKCQkKCgkJdmFyIERPTVZpZXcgPSBWaWV3LmV4dGVuZCgpOwoKCQlET01WaWV3LmRlY2xhcmVPcHRpb25zKAoJCXsKCQkJdGVtcGxhdGU6U3RyaW5nLAoJCQl0YWdOYW1lOlN0cmluZywKCQkJc2VsZWN0b3I6U3RyaW5nLAoJCQlwYXJlbnRTZWxlY3RvcjpTdHJpbmcsCgkJCWF0dHJpYnV0ZXM6T2JqZWN0CgkJfSk7CgoJCURPTVZpZXcuc2V0U3RhdGljKAoJCXsKCQkJX3RlbXBsYXRlczoge30sCgoJCQlnZXRUZW1wbGF0ZTogZnVuY3Rpb24oc2VsZWN0b3IpCgkJCXsKCQkJCWlmICghdGhpcy5wcmVwYXJlVGVtcGxhdGUKCQkJCXx8ICF0aGlzLnJlbmRlclRlbXBsYXRlKQoJCQkJCXRocm93IG5ldyBFcnJvcignTm8gdGVtcGxhdGluZyBmdW5jdGlvbnMgZGVmaW5lZCcpOwoKCQkJCWlmICghdGhpcy5fdGVtcGxhdGVzW3NlbGVjdG9yXSkKCQkJCXsKCQkJCQl2YXIgdGVtcGxhdGVIVE1MID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWxlY3RvcikuaW5uZXJIVE1MOwoKCQkJCQlpZiAodGVtcGxhdGVIVE1MKQoJCQkJCQl0aGlzLl90ZW1wbGF0ZXNbc2VsZWN0b3JdID0gdGhpcy5wcmVwYXJlVGVtcGxhdGUodGVtcGxhdGVIVE1MKQoJCQkJfQoKCQkJCXJldHVybiB0aGlzLl90ZW1wbGF0ZXNbc2VsZWN0b3JdOwoJCQl9CgkJfSk7CgoJCURPTVZpZXcuc2V0UHJvdG90eXBlKAoJCXsKCQkJdGFnTmFtZTogJ2RpdicsCgoJCQlyZW5kZXI6IGZ1bmN0aW9uKCkKCQkJewoJCQkJdGhpcy5lbnN1cmVFbGVtZW50KCk7CgkJCX0sCgoJCQllbnN1cmVFbGVtZW50OiBmdW5jdGlvbigpCgkJCXsKCQkJCWlmICghdGhpcy5lbGVtZW50KQoJCQkJewoJCQkJCXZhciBxdWVyeUNvbnRleHQgPSB0aGlzLnBhcmVudAoJCQkJCQk/IHRoaXMucGFyZW50LmdldEVsZW1lbnQoKQoJCQkJCQk6IGRvY3VtZW50OwoKCQkJCQlpZiAodGhpcy5wYXJlbnRTZWxlY3RvcikKCQkJCQkJdGhpcy5wYXJlbnRFbGVtZW50ID0gcXVlcnlDb250ZXh0LnF1ZXJ5U2VsZWN0b3IodGhpcy5wYXJlbnRTZWxlY3Rvcik7CgoJCQkJCWVsc2UgaWYgKHRoaXMuc2VsZWN0b3IpCgkJCQkJCXRoaXMuZWxlbWVudCA9IHF1ZXJ5Q29udGV4dC5xdWVyeVNlbGVjdG9yKHRoaXMuc2VsZWN0b3IpOwoKCQkJCQlpZiAoIXRoaXMuZWxlbWVudCkKCQkJCQkJdGhpcy5lbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0aGlzLnRhZ05hbWUpOwoKCQkJCQlpZiAodGhpcy50ZW1wbGF0ZSkKCQkJCQl7CgkJCQkJCXZhciBodG1sID0gdGhpcy5yZW5kZXJUZW1wbGF0ZSgpOwoKCQkJCQkJaWYgKGh0bWwgIT09ICcnKQoJCQkJCQl7CgkJCQkJCQl0aGlzLmVsZW1lbnQuaW5uZXJIVE1MID0gaHRtbDsKCgkJCQkJCQlpZiAodGhpcy5lbGVtZW50LmNoaWxkTm9kZXMubGVuZ3RoID09PSAxKQoJCQkJCQkJCXRoaXMuZWxlbWVudCA9IHRoaXMuZWxlbWVudC5maXJzdENoaWxkOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAodGhpcy5wYXJlbnRFbGVtZW50KQoJCQkJCXsKCQkJCQkJdGhpcy5wYXJlbnRFbGVtZW50LmlubmVySFRNTCA9ICcnOwoJCQkJCQl0aGlzLnBhcmVudEVsZW1lbnQuYXBwZW5kQ2hpbGQodGhpcy5lbGVtZW50KTsKCQkJCQl9CgoJCQkJCWlmICh0aGlzLmF0dHJpYnV0ZXMpCgkJCQkJCWZvciAodmFyIG5hbWUgaW4gdGhpcy5hdHRyaWJ1dGVzKQoJCQkJCQkJdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZShuYW1lLCB0aGlzLmF0dHJpYnV0ZXNbbmFtZV0pOwoJCQkJfQoJCQl9LAoKCQkJcmVuZGVyVGVtcGxhdGU6IGZ1bmN0aW9uKGRhdGEpCgkJCXsKCQkJCXZhciB0ZW1wbGF0ZSA9IERPTVZpZXcuZ2V0VGVtcGxhdGUodGhpcy50ZW1wbGF0ZSk7CgoJCQkJaWYgKHRlbXBsYXRlKQoJCQkJCXJldHVybiBET01WaWV3LnJlbmRlclRlbXBsYXRlKHRlbXBsYXRlLCBkYXRhIHx8IHRoaXMuZ2V0VGVtcGxhdGVEYXRhKCkpOwoKCQkJCXJldHVybiAnJzsKCQkJfSwKCgkJCWdldFRlbXBsYXRlRGF0YTogZnVuY3Rpb24oKQoJCQl7CgkJCQlyZXR1cm4ge307CgkJCX0sCgoJCQlnZXRFbGVtZW50OiBmdW5jdGlvbigpCgkJCXsKCQkJCXRoaXMuZW5zdXJlRWxlbWVudCgpOwoKCQkJCXJldHVybiB0aGlzLmVsZW1lbnQ7CgkJCX0sCgoJCQlhZGRDaGlsZDogZnVuY3Rpb24oY2hpbGQpCgkJCXsKCQkJCVZpZXcucHJvdG90eXBlLmFkZENoaWxkLmNhbGwodGhpcywgY2hpbGQpOwoKCQkJCXZhciBwYXJlbnRFbGVtZW50ID0gdGhpcy5nZXRFbGVtZW50KCksCgkJCQkJY2hpbGRFbGVtZW50ID0gY2hpbGQuZ2V0RWxlbWVudCgpOwoKCQkJCWlmIChjaGlsZC5wYXJlbnRFbGVtZW50CgkJCQkmJiAoY2hpbGQucGFyZW50RWxlbWVudCA9PT0gcGFyZW50RWxlbWVudAoJCQkJfHwgcGFyZW50RWxlbWVudC5jb250YWlucyhjaGlsZC5wYXJlbnRFbGVtZW50KSkpCgkJCQkJcGFyZW50RWxlbWVudCA9IGNoaWxkLnBhcmVudEVsZW1lbnQ7CgoJCQkJaWYgKHBhcmVudEVsZW1lbnQKCQkJCSYmIGNoaWxkRWxlbWVudAoJCQkJJiYgIXBhcmVudEVsZW1lbnQuY29udGFpbnMoY2hpbGRFbGVtZW50KSkKCQkJCQlwYXJlbnRFbGVtZW50LmFwcGVuZENoaWxkKGNoaWxkRWxlbWVudCk7CgoJCQkJcmV0dXJuIGNoaWxkOwoJCQl9LAoKCQkJcmVtb3ZlQ2hpbGQ6IGZ1bmN0aW9uKGNoaWxkKQoJCQl7CgkJCQlpZiAoY2hpbGQucGFyZW50ID09PSB0aGlzKQoJCQkJewoJCQkJCXZhciBwYXJlbnRFbGVtZW50ID0gdGhpcy5nZXRFbGVtZW50KCksCgkJCQkJCWNoaWxkRWxlbWVudCA9IGNoaWxkLmdldEVsZW1lbnQoKTsKCgkJCQkJaWYgKHBhcmVudEVsZW1lbnQKCQkJCQkmJiBjaGlsZEVsZW1lbnQKCQkJCQkmJiBwYXJlbnRFbGVtZW50LmNvbnRhaW5zKGNoaWxkRWxlbWVudCkpCgkJCQkJCWNoaWxkRWxlbWVudC5wYXJlbnRFbGVtZW50LnJlbW92ZUNoaWxkKGNoaWxkRWxlbWVudCk7CgoJCQkJCXJldHVybiBWaWV3LnByb3RvdHlwZS5yZW1vdmVDaGlsZC5jYWxsKHRoaXMsIGNoaWxkKTsKCQkJCX0KCgkJCQlyZXR1cm4gY2hpbGQ7CgkJCX0sCgoJCQlmaW5hbGl6ZTogZnVuY3Rpb24oKQoJCQl7CgkJCQlWaWV3LnByb3RvdHlwZS5maW5hbGl6ZS5jYWxsKHRoaXMpOwoKCQkJCWRlbGV0ZSB0aGlzLmVsZW1lbnQ7CgkJCQlkZWxldGUgdGhpcy5wYXJlbnRFbGVtZW50OwoJCQl9CgkJfSk7CgoJCXJldHVybiBET01WaWV3OwoJfQopOwpkZWZpbmUoJ3NwYS9UcmFuc2l0aW9uJyxbCgoJJy4vRXZlbnRCcm9rZXInLAoJJy4vVmlldyddLAoKCWZ1bmN0aW9uKEV2ZW50QnJva2VyLCBWaWV3KQoJewoJCQoKCQl2YXIgVHJhbnNpdGlvbiA9IEV2ZW50QnJva2VyLmV4dGVuZCgpOwoKCQlUcmFuc2l0aW9uLmRlY2xhcmVPcHRpb25zKAoJCXsKCQkJcm9vdDpWaWV3LAoJCQl2aWV3czpPYmplY3QsCgkJCXN0YXJ0UGF0aDpTdHJpbmcsCgkJCWVuZFBhdGg6U3RyaW5nLAoJCQlzdWJUcmFuc2l0aW9uczpPYmplY3QKCQl9KTsKCgkJVHJhbnNpdGlvbi5zZXRQcm90b3R5cGUoCgkJewoJCQlkaXNwb3NlUmVtb3ZlZFZpZXdzOiBmYWxzZSwKCgkJCWlzUmVhZHk6IGZ1bmN0aW9uKCkKCQkJewoJCQkJaWYgKHRoaXMuc3ViVHJhbnNpdGlvbnNQcmVwYXJpbmcKCQkJCXx8IHRoaXMudmlld3NQcmVwYXJpbmcpCgkJCQkJcmV0dXJuIGZhbHNlOwoKCQkJCXJldHVybiB0cnVlOwoJCQl9LAoKCQkJcHJlcGFyZTogZnVuY3Rpb24oKQoJCQl7CgkJCQlpZiAoIXRoaXMucm9vdCkKCQkJCQl0aHJvdyBuZXcgRXJyb3IoJ05vIHJvb3QgdmlldyBzZXQgZm9yIHRyYW5zaXRpb24nKTsKCgkJCQlpZiAoIXRoaXMudmlld3MpCgkJCQkJdGhyb3cgbmV3IEVycm9yKCdObyB2aWV3IGRhdGEgc2V0IGZvciB0cmFuc2l0aW9uJyk7CgoJCQkJaWYgKHRoaXMuc3ViVHJhbnNpdGlvbnMpCgkJCQkJdGhpcy5wcmVwYXJlU3ViVHJhbnNpdGlvbnMoKTsKCgkJCQl0aGlzLnByZXBhcmVWaWV3cygpOwoJCQl9LAoKCQkJcHJlcGFyZVN1YlRyYW5zaXRpb25zOiBmdW5jdGlvbigpCgkJCXsKCQkJCXZhciBzdWJUcmFuc2l0aW9ucyA9IFtdLAoJCQkJCXRyYW5zaXRpb24sIHJvb3QsIGRhdGEsIHZpZXdzLCBsZW5ndGgsIGk7CgoJCQkJZm9yICh2YXIgbmFtZSBpbiB0aGlzLnN1YlRyYW5zaXRpb25zKQoJCQkJewoJCQkJCWZvciAoaT0wLCBsZW5ndGg9dGhpcy52aWV3cy5hbGwubGVuZ3RoOyBpPGxlbmd0aDsgaSsrKQoJCQkJCXsKCQkJCQkJZGF0YSA9IHRoaXMudmlld3MuYWxsW2ldOwoKCQkJCQkJaWYgKGRhdGEubmFtZSA9PT0gbmFtZSkKCQkJCQkJewoJCQkJCQkJcm9vdCA9IGRhdGEudmlldzsKCgkJCQkJCQlicmVhazsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKHJvb3QpCgkJCQkJewoJCQkJCQl2aWV3cyA9IHsKCQkJCQkJCWFsbDogW10sCgkJCQkJCQlhZGQ6IFtdLAoJCQkJCQkJcmVtb3ZlOiBbXQoJCQkJCQl9OwoKCQkJCQkJZm9yICh2YXIgYXJyYXlOYW1lIGluIHZpZXdzKQoJCQkJCQl7CgkJCQkJCQl2YXIgcGFyZW50QXJyYXkgPSB0aGlzLnZpZXdzW2FycmF5TmFtZV0sCgkJCQkJCQkJY2hpbGRBcnJheSA9IHZpZXdzW2FycmF5TmFtZV07CgoJCQkJCQkJZm9yIChpPTA7IGk8cGFyZW50QXJyYXkubGVuZ3RoOyBpKyspCgkJCQkJCQl7CgkJCQkJCQkJZGF0YSA9IHBhcmVudEFycmF5W2ldOwoKCQkJCQkJCQlpZiAoZGF0YS5wYXJlbnQgPT09IHJvb3QpCgkJCQkJCQkJewoJCQkJCQkJCQljaGlsZEFycmF5LnB1c2goZGF0YSk7CgoJCQkJCQkJCQlwYXJlbnRBcnJheS5zcGxpY2UoaSwgMSk7CgoJCQkJCQkJCQlpLS07CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9CgoJCQkJCQlzdWJUcmFuc2l0aW9ucy5wdXNoKG5ldyB0aGlzLnN1YlRyYW5zaXRpb25zW25hbWVdKAoJCQkJCQl7CgkJCQkJCQlyb290OnJvb3QsCgkJCQkJCQl2aWV3czp2aWV3cywKCQkJCQkJCXN0YXJ0UGF0aDp0aGlzLnN0YXJ0UGF0aCwKCQkJCQkJCWVuZFBhdGg6dGhpcy5lbmRQYXRoCgkJCQkJCX0pKTsKCgkJCQkJCXJvb3QgPSB2b2lkIDA7CgkJCQkJfQoJCQkJfQoKCQkJCWlmIChzdWJUcmFuc2l0aW9ucy5sZW5ndGggPiAwKQoJCQkJewoJCQkJCXRoaXMuc3ViVHJhbnNpdGlvbnMgPSBzdWJUcmFuc2l0aW9uczsKCgkJCQkJdGhpcy5zdWJUcmFuc2l0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKHRyYW5zaXRpb24pCgkJCQkJewoJCQkJCQl0cmFuc2l0aW9uLnByZXBhcmUoKTsKCgkJCQkJCWlmICghdHJhbnNpdGlvbi5pc1JlYWR5KCkpCgkJCQkJCXsKCQkJCQkJCWlmICghdGhpcy5zdWJUcmFuc2l0aW9uc1ByZXBhcmluZykKCQkJCQkJCQl0aGlzLnN1YlRyYW5zaXRpb25zUHJlcGFyaW5nID0gW107CgoJCQkJCQkJdGhpcy5zdWJUcmFuc2l0aW9uc1ByZXBhcmluZy5wdXNoKHRyYW5zaXRpb24pOwoKCQkJCQkJCXRoaXMubGlzdGVuVG9PbmNlKHRyYW5zaXRpb24sICd0cmFuc2l0aW9uOnJlYWR5JywgdGhpcy5oYW5kbGVTdWJUcmFuc2l0aW9uUmVhZHkpOwoJCQkJCQl9CgkJCQkJfS5iaW5kKHRoaXMpKTsKCQkJCX0KCgkJCQllbHNlCgkJCQkJZGVsZXRlIHRoaXMuc3ViVHJhbnNpdGlvbnM7CgkJCX0sCgoJCQlwcmVwYXJlVmlld3M6IGZ1bmN0aW9uKCkKCQkJewoJCQkJdGhpcy52aWV3cy5hbGwuZm9yRWFjaChmdW5jdGlvbihkYXRhKQoJCQkJewoJCQkJCXZhciB2aWV3ID0gZGF0YS52aWV3OwoKCQkJCQlpZiAoIXZpZXcuaXNSZWFkeSgpKQoJCQkJCXsKCQkJCQkJdmlldy5wcmVwYXJlKCk7CgoJCQkJCQlpZiAoIXZpZXcuaXNSZWFkeSgpKQoJCQkJCQl7CgkJCQkJCQlpZiAoIXRoaXMudmlld3NQcmVwYXJpbmcpCgkJCQkJCQkJdGhpcy52aWV3c1ByZXBhcmluZyA9IFtdOwoKCQkJCQkJCXRoaXMudmlld3NQcmVwYXJpbmcucHVzaCh2aWV3KTsKCgkJCQkJCQl0aGlzLmxpc3RlblRvT25jZSh2aWV3LCAndmlldzpyZWFkeScsIHRoaXMuaGFuZGxlVmlld1JlYWR5KTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0uYmluZCh0aGlzKSk7CgoJCQkJaWYgKHRoaXMuaXNSZWFkeSgpKQoJCQkJCXRoaXMudHJpZ2dlcigndHJhbnNpdGlvbjpyZWFkeScsIHRoaXMpOwoJCQl9LAoKCQkJc3RhcnQ6IGZ1bmN0aW9uKCkKCQkJewoJCQkJdGhpcy5hZGRWaWV3cygpOwoJCQl9LAoKCQkJYWRkVmlld3M6IGZ1bmN0aW9uKCkKCQkJewoJCQkJdGhpcy5saXN0ZW5Ub09uY2UodGhpcywgJ3RyYW5zaXRpb246YWxsVmlld3NBZGRlZCcsIHRoaXMuaGFuZGxlQWxsVmlld3NBZGRlZCk7CgoJCQkJaWYgKHRoaXMudmlld3MuYWRkLmxlbmd0aCA9PT0gMCkKCQkJCQl0aGlzLnRyaWdnZXIoJ3RyYW5zaXRpb246YWxsVmlld3NBZGRlZCcpOwoKCQkJCWVsc2UKCQkJCXsKCQkJCQl0aGlzLl92aWV3c0FkZGVkQ291bnQgPSAwOwoKCQkJCQl0aGlzLmxpc3RlblRvKHRoaXMsICd0cmFuc2l0aW9uOnZpZXdBZGRlZCcsIHRoaXMuaGFuZGxlVmlld0FkZGVkKTsKCgkJCQkJdGhpcy52aWV3cy5hZGQuZm9yRWFjaChmdW5jdGlvbihkYXRhKQoJCQkJCXsKCQkJCQkJdGhpcy5hZGRWaWV3KGRhdGEudmlldywgZGF0YS5wYXJlbnQpOwoKCQkJCQl9LmJpbmQodGhpcykpOwoJCQkJfQoJCQl9LAoKCQkJYWRkVmlldzogZnVuY3Rpb24odmlldywgcGFyZW50KQoJCQl7CgkJCQlwYXJlbnQuYWRkQ2hpbGQodmlldyk7CgoJCQkJdGhpcy50cmlnZ2VyKCd0cmFuc2l0aW9uOnZpZXdBZGRlZCcsIHZpZXcsIHBhcmVudCk7CgkJCX0sCgoJCQlyZW1vdmVWaWV3czogZnVuY3Rpb24oKQoJCQl7CgkJCQl0aGlzLmxpc3RlblRvT25jZSh0aGlzLCAndHJhbnNpdGlvbjphbGxWaWV3c1JlbW92ZWQnLCB0aGlzLmhhbmRsZUFsbFZpZXdzUmVtb3ZlZCk7CgoJCQkJaWYgKHRoaXMudmlld3MucmVtb3ZlLmxlbmd0aCA9PT0gMCkKCQkJCQl0aGlzLnRyaWdnZXIoJ3RyYW5zaXRpb246YWxsVmlld3NSZW1vdmVkJyk7CgoJCQkJZWxzZQoJCQkJewoJCQkJCXRoaXMuX3ZpZXdzUmVtb3ZlZENvdW50ID0gMDsKCgkJCQkJdGhpcy5saXN0ZW5Ubyh0aGlzLCAndHJhbnNpdGlvbjp2aWV3UmVtb3ZlZCcsIHRoaXMuaGFuZGxlVmlld1JlbW92ZWQpOwoKCQkJCQl0aGlzLnZpZXdzLnJlbW92ZS5mb3JFYWNoKGZ1bmN0aW9uKGRhdGEpCgkJCQkJewoJCQkJCQl0aGlzLnJlbW92ZVZpZXcoZGF0YS52aWV3LCBkYXRhLnBhcmVudCk7CgoJCQkJCX0uYmluZCh0aGlzKSk7CgkJCQl9CgkJCX0sCgoJCQlyZW1vdmVWaWV3OiBmdW5jdGlvbih2aWV3LCBwYXJlbnQpCgkJCXsKCQkJCWlmICh0aGlzLmRpc3Bvc2VSZW1vdmVkVmlld3MpCgkJCQkJcGFyZW50LmRpc3Bvc2VDaGlsZCh2aWV3KTsKCgkJCQllbHNlCgkJCQkJdmlldy5yZW1vdmUoKTsKCgkJCQl0aGlzLnRyaWdnZXIoJ3RyYW5zaXRpb246dmlld1JlbW92ZWQnLCB2aWV3LCBwYXJlbnQpOwoJCQl9LAoKCQkJcnVuU3ViVHJhbnNpdGlvbnM6IGZ1bmN0aW9uKCkKCQkJewoJCQkJdGhpcy5zdWJUcmFuc2l0aW9uc1J1bm5pbmcgPSBbXTsKCgkJCQlmb3IgKHZhciBuYW1lIGluIHRoaXMuc3ViVHJhbnNpdGlvbnMpCgkJCQl7CgkJCQkJdmFyIHRyYW5zaXRpb24gPSB0aGlzLnN1YlRyYW5zaXRpb25zW25hbWVdOwoKCQkJCQl0aGlzLmxpc3RlblRvKHRyYW5zaXRpb24sICd0cmFuc2l0aW9uOmNvbXBsZXRlJywgdGhpcy5oYW5kbGVTdWJUcmFuc2l0aW9uQ29tcGxldGUpOwoKCQkJCQl0aGlzLnN1YlRyYW5zaXRpb25zUnVubmluZy5wdXNoKHRyYW5zaXRpb24pOwoKCQkJCQl0cmFuc2l0aW9uLnN0YXJ0KCk7CgkJCQl9CgkJCX0sCgoJCQljb21wbGV0ZTogZnVuY3Rpb24oKQoJCQl7CgkJCQl0aGlzLnRyaWdnZXIoJ3RyYW5zaXRpb246Y29tcGxldGUnLCB0aGlzKTsKCQkJfSwKCgkJCWhhbmRsZVN1YlRyYW5zaXRpb25SZWFkeTogZnVuY3Rpb24odHJhbnNpdGlvbikKCQkJewoJCQkJdGhpcy5zdWJUcmFuc2l0aW9uc1ByZXBhcmluZy5zcGxpY2UodGhpcy5zdWJUcmFuc2l0aW9uc1ByZXBhcmluZy5pbmRleE9mKHRyYW5zaXRpb24pLCAxKTsKCgkJCQlpZiAodGhpcy5zdWJUcmFuc2l0aW9uc1ByZXBhcmluZy5sZW5ndGggPT09IDApCgkJCQkJZGVsZXRlIHRoaXMuc3ViVHJhbnNpdGlvbnNQcmVwYXJpbmc7CgoJCQkJaWYgKHRoaXMuaXNSZWFkeSgpKQoJCQkJCXRoaXMudHJpZ2dlcigndHJhbnNpdGlvbjpyZWFkeScsIHRoaXMpOwoJCQl9LAoKCQkJaGFuZGxlU3ViVHJhbnNpdGlvbkNvbXBsZXRlOiBmdW5jdGlvbih0cmFuc2l0aW9uKQoJCQl7CgkJCQl0aGlzLnN1YlRyYW5zaXRpb25zUnVubmluZy5zcGxpY2UodGhpcy5zdWJUcmFuc2l0aW9uc1J1bm5pbmcuaW5kZXhPZih0cmFuc2l0aW9uKSwgMSk7CgoJCQkJaWYgKHRoaXMuc3ViVHJhbnNpdGlvbnNSdW5uaW5nLmxlbmd0aCA9PT0gMCkKCQkJCXsKCQkJCQlkZWxldGUgdGhpcy5zdWJUcmFuc2l0aW9uczsKCQkJCQlkZWxldGUgdGhpcy5fc3ViVHJhbnNpdGlvbnNSdW5uaW5nOwoKCQkJCQl0aGlzLmNvbXBsZXRlKCk7CgkJCQl9CgkJCX0sCgoJCQloYW5kbGVWaWV3UmVhZHk6IGZ1bmN0aW9uKHZpZXcpCgkJCXsKCQkJCXRoaXMudmlld3NQcmVwYXJpbmcuc3BsaWNlKHRoaXMudmlld3NQcmVwYXJpbmcuaW5kZXhPZih2aWV3KSwgMSk7CgoJCQkJaWYgKHRoaXMudmlld3NQcmVwYXJpbmcubGVuZ3RoID09PSAwKQoJCQkJCWRlbGV0ZSB0aGlzLnZpZXdzUHJlcGFyaW5nOwoKCQkJCWlmICh0aGlzLmlzUmVhZHkoKSkKCQkJCQl0aGlzLnRyaWdnZXIoJ3RyYW5zaXRpb246cmVhZHknLCB0aGlzKTsKCQkJfSwKCgkJCWhhbmRsZVZpZXdBZGRlZDogZnVuY3Rpb24odmlldywgcGFyZW50KQoJCQl7CgkJCQl0aGlzLl92aWV3c0FkZGVkQ291bnQrKzsKCgkJCQlpZiAodGhpcy5fdmlld3NBZGRlZENvdW50ID09PSB0aGlzLnZpZXdzLmFkZC5sZW5ndGgpCgkJCQl7CgkJCQkJdGhpcy5zdG9wTGlzdGVuaW5nKHRoaXMsICd0cmFuc2l0aW9uOnZpZXdBZGRlZCcpOwoKCQkJCQlkZWxldGUgdGhpcy5fdmlld3NBZGRlZENvdW50OwoKCQkJCQl0aGlzLnRyaWdnZXIoJ3RyYW5zaXRpb246YWxsVmlld3NBZGRlZCcpOwoJCQkJfQoJCQl9LAoKCQkJaGFuZGxlQWxsVmlld3NBZGRlZDogZnVuY3Rpb24oKQoJCQl7CgkJCQlkZWxldGUgdGhpcy52aWV3cy5hZGQ7CgoJCQkJdGhpcy5yZW1vdmVWaWV3cygpOwoJCQl9LAoKCQkJaGFuZGxlVmlld1JlbW92ZWQ6IGZ1bmN0aW9uKHZpZXcsIHBhcmVudCkKCQkJewoJCQkJdGhpcy5fdmlld3NSZW1vdmVkQ291bnQrKzsKCgkJCQlpZiAodGhpcy5fdmlld3NSZW1vdmVkQ291bnQgPT09IHRoaXMudmlld3MucmVtb3ZlLmxlbmd0aCkKCQkJCXsKCQkJCQl0aGlzLnN0b3BMaXN0ZW5pbmcodGhpcywgJ3RyYW5zaXRpb246dmlld1JlbW92ZWQnKTsKCgkJCQkJZGVsZXRlIHRoaXMuX3ZpZXdzUmVtb3ZlZENvdW50OwoKCQkJCQl0aGlzLnRyaWdnZXIoJ3RyYW5zaXRpb246YWxsVmlld3NSZW1vdmVkJyk7CgkJCQl9CgkJCX0sCgoJCQloYW5kbGVBbGxWaWV3c1JlbW92ZWQ6IGZ1bmN0aW9uKCkKCQkJewoJCQkJZGVsZXRlIHRoaXMudmlld3MucmVtb3ZlOwoKCQkJCWlmICh0aGlzLnN1YlRyYW5zaXRpb25zKQoJCQkJCXRoaXMucnVuU3ViVHJhbnNpdGlvbnMoKTsKCgkJCQllbHNlCgkJCQkJdGhpcy5jb21wbGV0ZSgpOwoJCQl9CgkJfSk7CgoJCXJldHVybiBUcmFuc2l0aW9uOwoJfQopOwpkZWZpbmUoJ3NwYS9Db21wb3NlcicsWwoKCScuL0V2ZW50QnJva2VyJywKCScuL1ZpZXcnXSwKCglmdW5jdGlvbihFdmVudEJyb2tlciwgVmlldykKCXsKCQkKCgkJdmFyIENvbXBvc2VyID0gRXZlbnRCcm9rZXIuZXh0ZW5kKCk7CgoJCUNvbXBvc2VyLmRlY2xhcmVPcHRpb25zKAoJCXsKCQkJcm9vdDpWaWV3LAoJCQlkYXRhOk9iamVjdAoJCX0pOwoKCQlDb21wb3Nlci5zZXRQcm90b3R5cGUoCgkJewoJCQljb21wb3NlOiBmdW5jdGlvbihyb290LCBkYXRhLCBjYWxsYmFjaykKCQkJewoJCQkJdGhpcy5lbnN1cmVNb2R1bGVzTG9hZGVkKGRhdGEsIGZ1bmN0aW9uKCkKCQkJCXsKCQkJCQljYWxsYmFjayh0aGlzLmdldFZpZXdMaXN0Q2hhbmdlcyhyb290LCBkYXRhLnZpZXdzKSk7CgoJCQkJfS5iaW5kKHRoaXMpKTsKCQkJfSwKCgkJCWVuc3VyZU1vZHVsZXNMb2FkZWQ6IGZ1bmN0aW9uKGRhdGEsIGNhbGxiYWNrKQoJCQl7CgkJCQl2YXIgYXBwbHlEZWZhdWx0VHlwZSA9IGZ1bmN0aW9uKGRlZmluaXRpb25zLCBkZWZhdWx0VHlwZSkKCQkJCXsKCQkJCQlkZWZpbml0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKGRlZmluaXRpb24pCgkJCQkJewoJCQkJCQlpZiAoIWRlZmluaXRpb24udHlwZSkKCQkJCQkJCWRlZmluaXRpb24udHlwZSA9IGRlZmF1bHRUeXBlOwoKCQkJCQkJaWYgKGRlZmluaXRpb24uY2hpbGRyZW4pCgkJCQkJCQlhcHBseURlZmF1bHRUeXBlKGRlZmluaXRpb24uY2hpbGRyZW4sIGRlZmF1bHRUeXBlKTsKCQkJCQl9KTsKCQkJCX07CgoJCQkJdmFyIGNvbGxlY3RNb2R1bGVQYXRocyA9IGZ1bmN0aW9uKGRlZmluaXRpb25zKQoJCQkJewoJCQkJCXZhciBwYXRocyA9IFtdOwoKCQkJCQlmb3IgKHZhciBpPTAsIGxlbmd0aCA9IGRlZmluaXRpb25zLmxlbmd0aDsgaTxsZW5ndGg7IGkrKykKCQkJCQl7CgkJCQkJCXZhciBkZWZpbml0aW9uID0gZGVmaW5pdGlvbnNbaV07CgoJCQkJCQlpZiAodHlwZW9mIGRlZmluaXRpb24gPT09ICdzdHJpbmcnKQoJCQkJCQl7CgkJCQkJCQlpZiAocmVxdWlyZS5kZWZpbmVkKGRlZmluaXRpb24pKQoJCQkJCQkJewoJCQkJCQkJCWRlZmluaXRpb24gPSByZXF1aXJlKGRlZmluaXRpb24pOwoKCQkJCQkJCQlpZiAoIWRlZmluaXRpb24udmlld3MpCgkJCQkJCQkJCXRocm93IG5ldyBFcnJvcignTm8gdmlldyBkYXRhIHNldCBpbiBjaGlsZCBtb2R1bGUnKTsKCgkJCQkJCQkJaWYgKGRhdGEuZGVmYXVsdFR5cGUgfHwgZGVmYXVsdFR5cGUpCgkJCQkJCQkJCWFwcGx5RGVmYXVsdFR5cGUoZGVmaW5pdGlvbi52aWV3cywgZGF0YS5kZWZhdWx0VHlwZSB8fCBkZWZhdWx0VHlwZSk7CgoJCQkJCQkJCUFycmF5LnByb3RvdHlwZS5zcGxpY2UuYXBwbHkoZGVmaW5pdGlvbnMsIFtpLCAxXS5jb25jYXQoZGVmaW5pdGlvbi52aWV3cykpOwoKCQkJCQkJCQlsZW5ndGggPSBkZWZpbml0aW9ucy5sZW5ndGg7CgkJCQkJCQkJaS0tOwoJCQkJCQkJfQoKCQkJCQkJCWVsc2UgaWYgKHBhdGhzLmluZGV4T2YoZGVmaW5pdGlvbikgPT09IC0xKQoJCQkJCQkJCXBhdGhzLnB1c2goZGVmaW5pdGlvbik7CgkJCQkJCX0KCgkJCQkJCWVsc2UKCQkJCQkJewoJCQkJCQkJaWYgKCFkZWZpbml0aW9uLnR5cGUpCgkJCQkJCQl7CgkJCQkJCQkJaWYgKGRlZmF1bHRUeXBlKQoJCQkJCQkJCQlkZWZpbml0aW9uLnR5cGUgPSBkZWZhdWx0VHlwZTsKCgkJCQkJCQkJZWxzZQoJCQkJCQkJCQl0aHJvdyBuZXcgRXJyb3IoJ05vIHR5cGUgc2V0IGZvciB2aWV3Jyk7CgkJCQkJCQl9CgoJCQkJCQkJaWYgKHR5cGVvZiBkZWZpbml0aW9uLnR5cGUgPT09ICdzdHJpbmcnKQoJCQkJCQkJewoJCQkJCQkJCWlmIChyZXF1aXJlLmRlZmluZWQoZGVmaW5pdGlvbi50eXBlKSkKCQkJCQkJCQkJZGVmaW5pdGlvbi50eXBlID0gcmVxdWlyZShkZWZpbml0aW9uLnR5cGUpOwoKCQkJCQkJCQllbHNlIGlmIChwYXRocy5pbmRleE9mKGRlZmluaXRpb24udHlwZSkgPT09IC0xKQoJCQkJCQkJCQlwYXRocy5wdXNoKGRlZmluaXRpb24udHlwZSk7CgkJCQkJCQl9CgoJCQkJCQkJaWYgKGRlZmluaXRpb24uY2hpbGRyZW4pCgkJCQkJCQl7CgkJCQkJCQkJdmFyIGNoaWxkUGF0aHMgPSBjb2xsZWN0TW9kdWxlUGF0aHMoZGVmaW5pdGlvbi5jaGlsZHJlbik7CgoJCQkJCQkJCWNoaWxkUGF0aHMuZm9yRWFjaChmdW5jdGlvbihwYXRoKQoJCQkJCQkJCXsKCQkJCQkJCQkJaWYgKHBhdGhzLmluZGV4T2YocGF0aCkgPT09IC0xKQoJCQkJCQkJCQkJcGF0aHMucHVzaChwYXRoKTsKCQkJCQkJCQl9KTsKCQkJCQkJCX0KCQkJCQkJfQoKCQkJCQl9OwoKCQkJCQlyZXR1cm4gcGF0aHM7CgoJCQkJfS5iaW5kKHRoaXMpOwoKCQkJCXZhciBkZWZhdWx0VHlwZSA9IGRhdGEuZGVmYXVsdFR5cGUsCgkJCQkJbW9kdWxlUGF0aHM7CgoJCQkJaWYgKGRlZmF1bHRUeXBlKQoJCQkJCWFwcGx5RGVmYXVsdFR5cGUoZGF0YS52aWV3cywgZGVmYXVsdFR5cGUpOwoKCQkJCW1vZHVsZVBhdGhzID0gY29sbGVjdE1vZHVsZVBhdGhzKGRhdGEudmlld3MpOwoKCQkJCWlmIChtb2R1bGVQYXRocy5sZW5ndGggPiAwKQoJCQkJCXJlcXVpcmUobW9kdWxlUGF0aHMsIGZ1bmN0aW9uKCkKCQkJCQl7CgkJCQkJCXRoaXMuZW5zdXJlTW9kdWxlc0xvYWRlZChkYXRhLCBjYWxsYmFjayk7CgoJCQkJCX0uYmluZCh0aGlzKSk7CgoJCQkJZWxzZQoJCQkJCWNhbGxiYWNrKCk7CgkJCX0sCgoJCQlnZXRWaWV3TGlzdENoYW5nZXM6IGZ1bmN0aW9uKHBhcmVudCwgZGVmaW5pdGlvbnMpCgkJCXsKCQkJCXZhciB2aWV3cyA9IHsKCQkJCQkJYWxsOiBbXSwKCQkJCQkJYWRkOiBbXSwKCQkJCQkJcmVtb3ZlOiBbXQoJCQkJCX0sCgkJCQkJY2hpbGRyZW4gPSBbXSwKCQkJCQljaGlsZFZpZXdzID0gW10sCgkJCQkJZGF0YSwgdmlldywgbGVuZ3RoLCBpOwoKCQkJCWZvciAoaT0wLCBsZW5ndGggPSBkZWZpbml0aW9ucy5sZW5ndGg7IGk8bGVuZ3RoOyBpKyspCgkJCQl7CgkJCQkJdmFyIGRlZmluaXRpb24gPSBkZWZpbml0aW9uc1tpXSwKCQkJCQkJbmFtZSA9IGRlZmluaXRpb24ubmFtZTsKCgkJCQkJaWYgKG5hbWUKCQkJCQkmJiBwYXJlbnRbbmFtZV0pCgkJCQkJCXZpZXcgPSBwYXJlbnRbbmFtZV07CgoJCQkJCWVsc2UKCQkJCQl7CgkJCQkJCXZpZXcgPSBuZXcgZGVmaW5pdGlvbi50eXBlKGRlZmluaXRpb24ucHJvcGVydGllcyk7CgoJCQkJCQlpZiAobmFtZSkKCQkJCQkJCXBhcmVudFtuYW1lXSA9IHZpZXc7CgkJCQkJfQoKCQkJCQlkYXRhID0gewoJCQkJCQlwYXJlbnQ6cGFyZW50LAoJCQkJCQluYW1lOm5hbWUsCgkJCQkJCXZpZXc6dmlldwoJCQkJCX07CgoJCQkJCXZpZXdzLmFsbC5wdXNoKGRhdGEpOwoKCQkJCQkvLyBURU1QCgkJCQkJY2hpbGRyZW4ucHVzaCh2aWV3KTsKCgkJCQkJaWYgKHZpZXcucGFyZW50ICE9PSBwYXJlbnQpCgkJCQkJCXZpZXdzLmFkZC5wdXNoKGRhdGEpOwoKCQkJCQlpZiAoZGVmaW5pdGlvbi5jaGlsZHJlbikKCQkJCQkJY2hpbGRWaWV3cy5wdXNoKHRoaXMuZ2V0Vmlld0xpc3RDaGFuZ2VzKHZpZXcsIGRlZmluaXRpb24uY2hpbGRyZW4pKTsKCQkJCX0KCgkJCQlpZiAocGFyZW50Lm51bUNoaWxkcmVuKCkgPiAwKQoJCQkJCWZvciAoaT0wLCBsZW5ndGggPSBwYXJlbnQubnVtQ2hpbGRyZW4oKTsgaTxsZW5ndGg7IGkrKykKCQkJCQl7CgkJCQkJCXZpZXcgPSBwYXJlbnQuZ2V0Q2hpbGRBdChpKTsKCgkJCQkJCWlmIChjaGlsZHJlbi5pbmRleE9mKHZpZXcpID09PSAtMSkKCQkJCQkJCXZpZXdzLnJlbW92ZS5wdXNoKHsKCQkJCQkJCQlwYXJlbnQ6cGFyZW50LAoJCQkJCQkJCXZpZXc6dmlldwoJCQkJCQkJfSk7CgkJCQkJfQoKCQkJCXdoaWxlIChjaGlsZFZpZXdzLmxlbmd0aCA+IDApCgkJCQl7CgkJCQkJdmFyIGNoaWxkID0gY2hpbGRWaWV3cy5zaGlmdCgpOwoKCQkJCQl2aWV3cy5hbGwgPSB2aWV3cy5hbGwuY29uY2F0KGNoaWxkLmFsbCk7CgkJCQkJdmlld3MuYWRkID0gdmlld3MuYWRkLmNvbmNhdChjaGlsZC5hZGQpOwoJCQkJCXZpZXdzLnJlbW92ZSA9IHZpZXdzLnJlbW92ZS5jb25jYXQoY2hpbGQucmVtb3ZlKTsKCQkJCX0KCgkJCQlyZXR1cm4gdmlld3M7CgkJCX0KCQl9KTsKCgkJcmV0dXJuIENvbXBvc2VyOwoJfQopOwpkZWZpbmUoJ3NwYS9EaXNwYXRjaGVyJyxbCgoJJy4vRXZlbnRCcm9rZXInLAoJJy4vVHJhbnNpdGlvbicsCgknLi9Db21wb3NlciddLAoKCWZ1bmN0aW9uKEV2ZW50QnJva2VyLCBUcmFuc2l0aW9uLCBDb21wb3NlcikKCXsKCQkKCgkJdmFyIERpc3BhdGNoZXIgPSBFdmVudEJyb2tlci5leHRlbmQoKTsKCgkJRGlzcGF0Y2hlci5kZWNsYXJlU3ViRW50aXRpZXMoCgkJewoJCQljb21wb3NlcjpDb21wb3NlcgoJCX0pOwoKCQlEaXNwYXRjaGVyLnNldFByb3RvdHlwZSgKCQl7CgkJCWFkZFJvdXRlU3RhdGVzOiBmdW5jdGlvbihzdGF0ZXMpCgkJCXsKCQkJCWZvciAodmFyIHBhdGggaW4gc3RhdGVzKQoJCQkJewoJCQkJCXZhciBzdGF0ZSA9IHN0YXRlc1twYXRoXTsKCgkJCQkJaWYgKHR5cGVvZiBzdGF0ZSA9PT0gJ3N0cmluZycpCgkJCQkJCXN0YXRlID0ge2RhdGE6c3RhdGV9OwoKCQkJCQl0aGlzLmFkZFJvdXRlU3RhdGUocGF0aCwgc3RhdGUuZGF0YSwgc3RhdGUudmlldyk7CgkJCQl9CgkJCX0sCgoJCQlhZGRSb3V0ZVN0YXRlOiBmdW5jdGlvbihwYXRoLCBkYXRhLCB2aWV3KQoJCQl7CgkJCQlpZiAoIXZpZXcpCgkJCQkJdmlldyA9IHRoaXMuYXBwLnZpZXc7CgoJCQkJaWYgKCF0aGlzLl9yb3V0ZVN0YXRlcykKCQkJCQl0aGlzLl9yb3V0ZVN0YXRlcyA9IHt9OwoKCQkJCXRoaXMuX3JvdXRlU3RhdGVzW3BhdGhdID0gewoJCQkJCWRhdGE6ZGF0YSwKCQkJCQlyb290OnZpZXcKCQkJCX07CgoJCQkJdGhpcy5hcHAucm91dGVyLnJvdXRlKHBhdGgsICcnLCBmdW5jdGlvbigpCgkJCQl7CgkJCQkJdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwoKCQkJCQlhcmdzLnVuc2hpZnQocGF0aCk7CgoJCQkJCS8vIFRPRE86IEZpZ3VyZSBvdXQgdmFsdWVzIHBhc3NlZCB0byBjYWxsYmFjayAvIHRlbXAgZml4IHRvIGV4Y2x1ZGUgbnVsbCB2YWx1ZXMgYmVsb3cKCQkJCQlhcmdzID0gYXJncy5zcGxpY2UoMCwgYXJncy5pbmRleE9mKG51bGwpKTsKCgkJCQkJdGhpcy5oYW5kbGVSb3V0ZS5hcHBseSh0aGlzLCBhcmdzKTsKCgkJCQl9LmJpbmQodGhpcykpOwoJCQl9LAoKCQkJcmVtb3ZlUm91dGVTdGF0ZTogZnVuY3Rpb24ocGF0aCkKCQkJewoJCQkJaWYgKHRoaXMuX3JvdXRlU3RhdGVzCgkJCQkmJiB0aGlzLl9yb3V0ZVN0YXRlc1twYXRoXSkKCQkJCXsKCQkJCQl2YXIgc3RhdGUgPSB0aGlzLl9yb3V0ZVN0YXRlc1twYXRoXTsKCgkJCQkJZGVsZXRlIHRoaXMuX3JvdXRlU3RhdGVzW3BhdGhdOwoKCQkJCQlyZXR1cm4gc3RhdGU7CgkJCQl9CgoJCQkJcmV0dXJuIHZvaWQgMDsKCQkJfSwKCgkJCXJlbW92ZVJvdXRlU3RhdGVzOiBmdW5jdGlvbihwYXRocykKCQkJewoJCQkJZm9yICh2YXIgaT0wOyBpPHBhdGhzLmxlbmd0aDsgaSsrKQoJCQkJCXRoaXMucmVtb3ZlUm91dGVTdGF0ZShwYXRoc1tpXSk7CgkJCX0sCgoJCQloYXNSb3V0ZVN0YXRlOiBmdW5jdGlvbihwYXRoKQoJCQl7CgkJCQlpZiAodGhpcy5fcm91dGVTdGF0ZXMKCQkJCSYmIHRoaXMuX3JvdXRlU3RhdGVzW3BhdGhdKQoJCQkJCXJldHVybiB0cnVlOwoKCQkJCXJldHVybiBmYWxzZTsKCQkJfSwKCgkJCWdldFJvdXRlU3RhdGU6IGZ1bmN0aW9uKHBhdGgpCgkJCXsKCQkJCWlmICh0aGlzLmhhc1JvdXRlU3RhdGUocGF0aCkpCgkJCQl7CgkJCQkJdmFyIHN0YXRlID0gdGhpcy5fcm91dGVTdGF0ZXNbcGF0aF07CgoJCQkJCWlmICh0eXBlb2Ygc3RhdGUuZGF0YSA9PT0gJ3N0cmluZycKCQkJCQkmJiByZXF1aXJlLmRlZmluZWQoc3RhdGUuZGF0YSkpCgkJCQkJCXN0YXRlLmRhdGEgPSByZXF1aXJlKHN0YXRlLmRhdGEpOwoKCQkJCQlyZXR1cm4gc3RhdGU7CgkJCQl9CgoJCQkJcmV0dXJuIHZvaWQgMDsKCQkJfSwKCgkJCWFkZFRyYW5zaXRpb25zOiBmdW5jdGlvbihkZWZpbml0aW9ucykKCQkJewoJCQkJZGVmaW5pdGlvbnMuZm9yRWFjaChmdW5jdGlvbihkZWZpbml0aW9uKQoJCQkJewoJCQkJCXRoaXMuYWRkVHJhbnNpdGlvbihkZWZpbml0aW9uKTsKCgkJCQl9LmJpbmQodGhpcykpOwoJCQl9LAoKCQkJYWRkVHJhbnNpdGlvbjogZnVuY3Rpb24oZGVmaW5pdGlvbikKCQkJewoJCQkJaWYgKCF0aGlzLl90cmFuc2l0aW9ucykKCQkJCQl0aGlzLl90cmFuc2l0aW9ucyA9IFtdOwoKCQkJCXRoaXMuX3RyYW5zaXRpb25zLnB1c2goZGVmaW5pdGlvbik7CgkJCX0sCgoJCQlnZXRUcmFuc2l0aW9uVHlwZTogZnVuY3Rpb24ocGF0aCkKCQkJewoJCQkJaWYgKHRoaXMuX3RyYW5zaXRpb25zCgkJCQkmJiB0aGlzLl90cmFuc2l0aW9ucy5sZW5ndGggPiAwKQoJCQkJewoJCQkJCXZhciBjdXJyZW50UGF0aCA9IHRoaXMuY3VycmVudFBhdGgsCgkJCQkJCW1hdGNoZXMgPSBbXSwKCQkJCQkJbWF0Y2g7CgoJCQkJCXRoaXMuX3RyYW5zaXRpb25zLmZvckVhY2goZnVuY3Rpb24oZGVmaW5pdGlvbikKCQkJCQl7CgkJCQkJCWlmICgoZGVmaW5pdGlvbi5mcm9tID09PSBjdXJyZW50UGF0aAoJCQkJCQl8fCBkZWZpbml0aW9uLmZyb20gPT09ICcqJykKCQkJCQkJJiYgKGRlZmluaXRpb24udG8gPT09IHBhdGgKCQkJCQkJfHwgZGVmaW5pdGlvbi50byA9PT0gJyonKSkKCQkJCQkJCW1hdGNoZXMucHVzaChkZWZpbml0aW9uKTsKCQkJCQl9KTsKCgkJCQkJaWYgKG1hdGNoZXMubGVuZ3RoID09PSAxKQoJCQkJCQltYXRjaCA9IG1hdGNoZXNbMF07CgoJCQkJCWVsc2UgaWYgKG1hdGNoZXMubGVuZ3RoID4gMSkKCQkJCQl7CgkJCQkJCW1hdGNoZXMuZm9yRWFjaChmdW5jdGlvbihkZWZpbml0aW9uKQoJCQkJCQl7CgkJCQkJCQlpZiAoZGVmaW5pdGlvbi5mcm9tID09PSBjdXJyZW50UGF0aAoJCQkJCQkJJiYgZGVmaW5pdGlvbi50byA9PT0gcGF0aCkKCQkJCQkJCQltYXRjaCA9IGRlZmluaXRpb247CgkJCQkJCX0pOwoKCQkJCQkJaWYgKCFtYXRjaCkKCQkJCQkJCW1hdGNoZXMuZm9yRWFjaChmdW5jdGlvbihkZWZpbml0aW9uKQoJCQkJCQkJewoJCQkJCQkJCWlmIChkZWZpbml0aW9uLmZyb20gPT09ICcqJwoJCQkJCQkJCSYmIGRlZmluaXRpb24udG8gPT09IHBhdGgpCgkJCQkJCQkJCW1hdGNoID0gZGVmaW5pdGlvbjsKCQkJCQkJCX0pOwoKCQkJCQkJaWYgKCFtYXRjaCkKCQkJCQkJCW1hdGNoZXMuZm9yRWFjaChmdW5jdGlvbihkZWZpbml0aW9uKQoJCQkJCQkJewoJCQkJCQkJCWlmIChkZWZpbml0aW9uLmZyb20gPT09IGN1cnJlbnRQYXRoCgkJCQkJCQkJJiYgZGVmaW5pdGlvbi50byA9PT0gJyonKQoJCQkJCQkJCQltYXRjaCA9IGRlZmluaXRpb247CgkJCQkJCQl9KTsKCgkJCQkJCWlmICghbWF0Y2gpCgkJCQkJCQltYXRjaGVzLmZvckVhY2goZnVuY3Rpb24oZGVmaW5pdGlvbikKCQkJCQkJCXsKCQkJCQkJCQlpZiAoZGVmaW5pdGlvbi5mcm9tID09PSAnKicKCQkJCQkJCQkmJiBkZWZpbml0aW9uLnRvID09PSAnKicpCgkJCQkJCQkJCW1hdGNoID0gZGVmaW5pdGlvbjsKCQkJCQkJCX0pOwoJCQkJCX0KCgkJCQkJaWYgKG1hdGNoKQoJCQkJCXsKCQkJCQkJaWYgKHR5cGVvZiBtYXRjaC50eXBlID09PSAnc3RyaW5nJwoJCQkJCQkmJiByZXF1aXJlLmRlZmluZWQobWF0Y2gudHlwZSkpCgkJCQkJCQltYXRjaC50eXBlID0gcmVxdWlyZShtYXRjaC50eXBlKTsKCgkJCQkJCXJldHVybiBtYXRjaC50eXBlOwoJCQkJCX0KCQkJCX0KCgkJCQlyZXR1cm4gVHJhbnNpdGlvbjsKCQkJfSwKCgkJCS8vIFRPRE8KCQkJcmVtb3ZlVHJhbnNpdGlvbjogZnVuY3Rpb24oKSB7fSwKCQkJcmVtb3ZlVHJhbnNpdGlvbnM6IGZ1bmN0aW9uKCkge30sCgoJCQlwcmVwYXJlVHJhbnNpdGlvbjogZnVuY3Rpb24ocGF0aCkKCQkJewoJCQkJaWYgKCF0aGlzLl90cmFuc2l0aW9uUGVuZGluZwoJCQkJJiYgdGhpcy5oYXNSb3V0ZVN0YXRlKHBhdGgpKQoJCQkJewoJCQkJCXZhciB0eXBlID0gdGhpcy5nZXRUcmFuc2l0aW9uVHlwZShwYXRoKSwKCQkJCQkJc3RhdGUgPSB0aGlzLmdldFJvdXRlU3RhdGUocGF0aCksCgkJCQkJCXJvb3QgPSBzdGF0ZS5yb290LAoJCQkJCQlkYXRhID0gc3RhdGUuZGF0YTsKCgkJCQkJdmFyIGNyZWF0ZVRyYW5zaXRpb24gPSBmdW5jdGlvbih2aWV3cykKCQkJCQl7CgkJCQkJCXRoaXMuY3VycmVudFRyYW5zaXRpb24gPSBuZXcgdHlwZSgKCQkJCQkJewoJCQkJCQkJcm9vdDpyb290LAoJCQkJCQkJdmlld3M6dmlld3MsCgkJCQkJCQlzdGFydFBhdGg6dGhpcy5wcmV2aW91c1BhdGgsCgkJCQkJCQllbmRQYXRoOnRoaXMuY3VycmVudFBhdGgKCQkJCQkJfSk7CgoJCQkJCQl0aGlzLmxpc3RlblRvT25jZSh0aGlzLmN1cnJlbnRUcmFuc2l0aW9uLCAndHJhbnNpdGlvbjpyZWFkeScsIHRoaXMuaGFuZGxlVHJhbnNpdGlvblJlYWR5KTsKCgkJCQkJCXRoaXMuY3VycmVudFRyYW5zaXRpb24ucHJlcGFyZSgpOwoKCQkJCQl9LmJpbmQodGhpcyk7CgoJCQkJCXRoaXMuX3RyYW5zaXRpb25QZW5kaW5nID0gdHJ1ZTsKCgkJCQkJaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJwoJCQkJCXx8IHR5cGVvZiB0eXBlID09PSAnc3RyaW5nJykKCQkJCQl7CgkJCQkJCXZhciBtb2R1bGVQYXRocyA9IFtdOwoKCQkJCQkJaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykKCQkJCQkJCW1vZHVsZVBhdGhzLnB1c2goZGF0YSk7CgoJCQkJCQlpZiAodHlwZW9mIHR5cGUgPT09ICdzdHJpbmcnKQoJCQkJCQkJbW9kdWxlUGF0aHMucHVzaCh0eXBlKTsKCgkJCQkJCXJlcXVpcmUobW9kdWxlUGF0aHMsIGZ1bmN0aW9uKCkKCQkJCQkJewoJCQkJCQkJaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykKCQkJCQkJCQlkYXRhID0gcmVxdWlyZShkYXRhKTsKCgkJCQkJCQlpZiAodHlwZW9mIHR5cGUgPT09ICdzdHJpbmcnKQoJCQkJCQkJCXR5cGUgPSByZXF1aXJlKHR5cGUpOwoKCQkJCQkJCXRoaXMuY29tcG9zZXIuY29tcG9zZShyb290LCBkYXRhLCBjcmVhdGVUcmFuc2l0aW9uKTsKCgkJCQkJCX0uYmluZCh0aGlzKSk7CgkJCQkJfQoKCQkJCQllbHNlCgkJCQkJCXRoaXMuY29tcG9zZXIuY29tcG9zZShyb290LCBkYXRhLCBjcmVhdGVUcmFuc2l0aW9uKTsKCQkJCX0KCQkJfSwKCgkJCWhhbmRsZVJvdXRlOiBmdW5jdGlvbihwYXRoKQoJCQl7CgkJCQlpZiAodGhpcy5fdHJhbnNpdGlvblBlbmRpbmcpCgkJCQkJdGhpcy5xdWV1ZWRQYXRoID0gcGF0aDsKCgkJCQllbHNlIGlmIChwYXRoICE9PSB0aGlzLmN1cnJlbnRQYXRoKQoJCQkJewoJCQkJCXRoaXMucHJldmlvdXNQYXRoID0gdGhpcy5jdXJyZW50UGF0aDsKCQkJCQl0aGlzLmN1cnJlbnRQYXRoID0gcGF0aDsKCgkJCQkJaWYgKHRoaXMuaGFzUm91dGVTdGF0ZShwYXRoKSkKCQkJCQkJdGhpcy5wcmVwYXJlVHJhbnNpdGlvbihwYXRoKTsKCQkJCX0KCQkJfSwKCgkJCWhhbmRsZVRyYW5zaXRpb25SZWFkeTogZnVuY3Rpb24oKQoJCQl7CgkJCQl0aGlzLmxpc3RlblRvT25jZSh0aGlzLmN1cnJlbnRUcmFuc2l0aW9uLCAndHJhbnNpdGlvbjpjb21wbGV0ZScsIHRoaXMuaGFuZGxlVHJhbnNpdGlvbkNvbXBsZXRlKTsKCgkJCQl0aGlzLmN1cnJlbnRUcmFuc2l0aW9uLnN0YXJ0KCk7CgkJCX0sCgoJCQloYW5kbGVUcmFuc2l0aW9uQ29tcGxldGU6IGZ1bmN0aW9uKCkKCQkJewoJCQkJdGhpcy5jdXJyZW50VHJhbnNpdGlvbi5maW5hbGl6ZSgpOwoKCQkJCWRlbGV0ZSB0aGlzLmN1cnJlbnRUcmFuc2l0aW9uOwoKCQkJCXRoaXMuX3RyYW5zaXRpb25QZW5kaW5nID0gZmFsc2U7CgoJCQkJaWYgKHRoaXMucXVldWVkUGF0aCkKCQkJCXsKCQkJCQl0aGlzLmhhbmRsZVJvdXRlKHRoaXMucXVldWVkUGF0aCk7CgoJCQkJCWRlbGV0ZSB0aGlzLnF1ZXVlZFBhdGg7CgkJCQl9CgkJCX0KCQl9KTsKCgkJcmV0dXJuIERpc3BhdGNoZXI7Cgl9Cik7CmRlZmluZSgnanF1ZXJ5Jywge30pOwpkZWZpbmUoJ3VuZGVyc2NvcmUnLCBbJ0V4b3NrZWxldG9uJ10sIGZ1bmN0aW9uKEV4b3NrZWxldG9uKXsgcmV0dXJuIEV4b3NrZWxldG9uLlV0aWxzOyB9KTsKCmRlZmluZSgnc3BhL0FwcGxpY2F0aW9uJyxbCgoJJy4vRW50aXR5JywKCScuL0V2ZW50QnJva2VyJywKCScuL0RPTVZpZXcnLAoJJy4vRGlzcGF0Y2hlcicsCgknRXhvc2tlbGV0b24nXSwKCglmdW5jdGlvbihFbnRpdHksIEV2ZW50QnJva2VyLCBET01WaWV3LCBEaXNwYXRjaGVyKQoJewoJCQoKCQl2YXIgQXBwbGljYXRpb24gPSBFdmVudEJyb2tlci5leHRlbmQoZnVuY3Rpb24ob3B0aW9ucykKCQl7CgkJCUVudGl0eS5wcm90b3R5cGUuYXBwID0gdGhpczsKCgkJCUV2ZW50QnJva2VyLmNhbGwodGhpcywgb3B0aW9ucyk7CgkJfSk7CgoJCUFwcGxpY2F0aW9uLkRFRkFVTFRfT1BUSU9OUyA9IHsKCQkJdmlld1Jvb3RTZWxlY3RvcjogJ2JvZHknCgkJfTsKCgkJQXBwbGljYXRpb24uZGVjbGFyZVN1YkVudGl0aWVzKAoJCXsKCQkJcm91dGVyOkV4b3NrZWxldG9uLlJvdXRlciwKCQkJdmlldzpET01WaWV3LAoJCQlkaXNwYXRjaGVyOkRpc3BhdGNoZXIKCQl9KTsKCgkJQXBwbGljYXRpb24uc2V0UHJvdG90eXBlKAoJCXsKCQkJY3JlYXRlVmlldzogZnVuY3Rpb24ob3B0aW9ucykKCQkJewoJCQkJcmV0dXJuIG5ldyBET01WaWV3KHtzZWxlY3RvcjpvcHRpb25zLnZpZXdSb290U2VsZWN0b3J9KTsKCQkJfSwKCgkJCWNyZWF0ZURpc3BhdGNoZXI6IGZ1bmN0aW9uKG9wdGlvbnMpCgkJCXsKCQkJCXZhciBkaXNwYXRjaGVyID0gbmV3IERpc3BhdGNoZXIoKTsKCgkJCQlpZiAob3B0aW9ucy5yb3V0ZXMpCgkJCQkJZGlzcGF0Y2hlci5hZGRSb3V0ZVN0YXRlcyhvcHRpb25zLnJvdXRlcyk7CgoJCQkJaWYgKG9wdGlvbnMudHJhbnNpdGlvbnMpCgkJCQkJZGlzcGF0Y2hlci5hZGRUcmFuc2l0aW9ucyhvcHRpb25zLnRyYW5zaXRpb25zKTsKCgkJCQlyZXR1cm4gZGlzcGF0Y2hlcjsKCQkJfSwKCgkJCXN0YXJ0OiBmdW5jdGlvbigpCgkJCXsKCQkJCXRoaXMuaGlzdG9yeSA9IEV4b3NrZWxldG9uLmhpc3Rvcnk7CgkJCQl0aGlzLmhpc3Rvcnkuc3RhcnQoKTsKCQkJfQoJCX0pOwoKCQlyZXR1cm4gQXBwbGljYXRpb247Cgl9Cik7Cg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 05:16:17 GMT",
                    "Content-Length": "55747",
                    "Date": "Sat, 08 Nov 2014 05:16:17 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}