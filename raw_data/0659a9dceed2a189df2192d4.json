{
    "url": "http://localhost:9999/david-driscoll/thrust/dist/thrust.all.0.1.5.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>parent.name</b> and written to <b>the 'name' property of a DOM element</b> via the following statement:<ul><li>this.name = parent.name;</li></ul><b>Note:</b> The name of the current window is a valid attack vector for DOM-based vulnerabilities. An attacker can directly control the name of the targeted application's window by using code on their own domain to load the targeted page using either window.open() or an iframe tag, and specifying the desired window name. ",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/david-driscoll/thrust/dist/thrust.all.0.1.5.js",
                "path": "/david-driscoll/thrust/dist/thrust.all.0.1.5.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9kYXZpZC1kcmlzY29sbC90aHJ1c3QvZGlzdC90aHJ1c3QuYWxsLjAuMS41LmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjMxODc5DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBTYXQsIDA4IE5vdiAyMDE0IDIwOjA1OjI4IEdNVA0KTGFzdC1Nb2RpZmllZDogU2F0LCAwOCBOb3YgMjAxNCAyMDowNToyNyBHTVQNCg0KLyohIHRocnVzdC1qcyAtIHYwLjEuNSAtIDIwMTMtMDEtMjcgKi8KZGVmaW5lKCd0aHJ1c3QvdXRpbC9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICdsb2Rhc2gnLCAndW5kZXJzY29yZS5zdHJpbmcnLCAndXVpZCcsICd3aGVuJywgJ3doZW4vYXBwbHknLCAnd2hlbi9kZWxheScsICd3aGVuL3RpbWVvdXQnLCAnd2hlbi9wYXJhbGxlbCcsICd3aGVuL3BpcGVsaW5lJywgJ3doZW4vc2VxdWVuY2UnLCAnd2hlbi9jYW5jZWxhYmxlJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fX19fXywgX19fc19fLCBfX3V1aWRfXywgX193X18sIF9fd2hlbkFwcGx5X18sIF9fd2hlbkRlbGF5X18sIF9fd2hlblRpbWVvdXRfXywgX193aGVuUGFyYWxsZWxfXywgX193aGVuUGlwZWxpbmVfXywgX193aGVuU2VxdWVuY2VfXywgX193aGVuQ2FuY2VsYWJsZV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSB1dGlsIHsqLwogICAgdmFyIF9fID0gX19fX19fOwoKICAgIHZhciBfcyA9IF9fX3NfXzsKCiAgICB2YXIgdXVpZCA9IF9fdXVpZF9fOwoKICAgIAogICAgX18ubWl4aW4oX3MpOwogICAgZXhwb3J0cy5fID0gX187CiAgICAvLyNyZWdpb24gZnVuY3Rpb24KICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICAgIC8qKgogICAgQSBmdW5jdGlvbiB0aGF0IGRvZXMgbm90aGluZywgb3Igbm8gb3BlcmF0aW9uLiAgSGVuY2UgdGhlIG5hbWUgbm9vcC4KICAgIAogICAgQG1ldGhvZCBub29wCiAgICAqKi8KICAgIGZ1bmN0aW9uIG5vb3AoKSB7CiAgICB9CiAgICBleHBvcnRzLm5vb3AgPSBub29wOwogICAgdmFyIHByb3BlcnR5SXNFbnVtZXJhYmxlID0gbm9vcC5wcm9wZXJ0eUlzRW51bWVyYWJsZTsKICAgIC8qKgogICAgQXR0ZW1wdHMgdG8gaW52b2tlLCBzaW1pbGFyIHRvIF8uaW52b2tlLCBidXQgaW4gdGhpcyBjYXNlIGl0IHZlcmlmaWVzIHRoYXQgdGhlIHByb3BlcnR5IGV4aXN0LAogICAgYW5kIGFsc28gdmVyaWZpZXMgdGhhdCBpdCBpcyBhIGZ1bmN0aW9uLCBhbmQgbm90IHRoZSBub29wIG1ldGhvZCBhdmFpbGFibGUgaW4gdGhydXN0LgogICAgCiAgICBUaGUgaW50ZW50IGlzIGEgbWV0aG9kIHRoYXQgYWxsb3dzIG92ZXJyaWRlIG9mIGZ1bmN0aW9ucywgd2l0aG91dCBjcmVhdGluZyBjdXN0b20gY29kZS4KICAgIAogICAgQG1ldGhvZCBzYXZlSW52b2tlCiAgICBAcGFyYW0ge0FycmF5fE9iamVjdH0gY29sbGVjdGlvbiBUaGUgY29udGFpbmVyIHRoYXQgaGFzIHRoZSBpdGVtcwogICAgQHBhcmFtIHtTdHJpbmd8RnVuY3Rpb259IG1ldGhvZCBUaGUgbWV0aG9kIG5hbWUgb24gZXZlcnkgaXRlbSwgb3IgdGhlIG1ldGhvZCB0byBpbnZva2UgYWdhaW5zdCBlYWNoIGl0ZW0uCiAgICBAcGFyYW0ge09iamVjdH0gW2FyZ3NdKiBUaGUgYWRkaXRpb25hbCBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSBtZXRob2QuCiAgICAqKi8KICAgIGZ1bmN0aW9uIHNhZmVJbnZva2UoY29sbGVjdGlvbiwgbWV0aG9kTmFtZSkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMik7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAyXTsKICAgICAgICB9CiAgICAgICAgLypqc2hpbnQgYml0d2lzZTpmYWxzZSAqLwogICAgICAgICAgICAgICAgdmFyIGluZGV4LCBpdGVyYXRlZSA9IGNvbGxlY3Rpb24sIHJlc3VsdDsKICAgICAgICBpZighY29sbGVjdGlvbikgewogICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgfQogICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpLCBpc0Z1bmMgPSB0eXBlb2YgbWV0aG9kTmFtZSA9PSAnZnVuY3Rpb24nLCBtZXRob2RFeGlzdHM7CiAgICAgICAgdmFyIGxlbmd0aCA9IGl0ZXJhdGVlLmxlbmd0aDsKICAgICAgICBpbmRleCA9IC0xOwogICAgICAgIGlmKGxlbmd0aCA9PT0gbGVuZ3RoID4+PiAwKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICAgIHdoaWxlKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgICAgICAgIG1ldGhvZEV4aXN0cyA9IChpc0Z1bmMgPyBtZXRob2ROYW1lIDogaXRlcmF0ZWVbaW5kZXhdW21ldGhvZE5hbWVdKTsKICAgICAgICAgICAgICAgIG1ldGhvZEV4aXN0cyAmJiBtZXRob2RFeGlzdHMgIT09IG5vb3AgJiYgKHJlc3VsdFtpbmRleF0gPSBtZXRob2RFeGlzdHMuYXBwbHkoaXRlcmF0ZWVbaW5kZXhdLCBhcmdzKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgc2tpcFByb3RvID0gdHlwZW9mIGl0ZXJhdGVlID09ICdmdW5jdGlvbicgJiYgcHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChpdGVyYXRlZSwgJ3Byb3RvdHlwZScpOwogICAgICAgICAgICB2YXIgcHJvcHMgPSBleHBvcnRzLl8ua2V5cyhpdGVyYXRlZSksIHByb3BJbmRleCA9IC0xLCBsZW5ndGggPSBwcm9wcy5sZW5ndGg7CiAgICAgICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICAgIHdoaWxlKCsrcHJvcEluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpbmRleCA9IHByb3BzW3Byb3BJbmRleF07CiAgICAgICAgICAgICAgICBpZighKHNraXBQcm90byAmJiBpbmRleCA9PSAncHJvdG90eXBlJykpIHsKICAgICAgICAgICAgICAgICAgICBtZXRob2RFeGlzdHMgPSAoaXNGdW5jID8gbWV0aG9kTmFtZSA6IGl0ZXJhdGVlW2luZGV4XVttZXRob2ROYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgbWV0aG9kRXhpc3RzICYmIG1ldGhvZEV4aXN0cyAhPT0gbm9vcCAmJiAocmVzdWx0W3Byb3BJbmRleF0gPSAoKGlzRnVuYyA/IG1ldGhvZE5hbWUgOiBpdGVyYXRlZVtpbmRleF1bbWV0aG9kTmFtZV0pLmFwcGx5KGl0ZXJhdGVlW2luZGV4XSwgYXJncykpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZXhwb3J0cy5zYWZlSW52b2tlID0gc2FmZUludm9rZTsKICAgIC8qKgogICAgKiBDb25zdHJ1Y3RvciB1c2VkIHRvIGJlZ2V0IG9iamVjdHMgdGhhdCB3aXJlIG5lZWRzIHRvIGNyZWF0ZSB1c2luZyBuZXcuCiAgICAqIEBwYXJhbSBjdG9yIHtGdW5jdGlvbn0gcmVhbCBjb25zdHJ1Y3RvciB0byBiZSBpbnZva2VkCiAgICAqIEBwYXJhbSBhcmdzIHtBcnJheX0gYXJndW1lbnRzIHRvIGJlIHN1cHBsaWVkIHRvIGN0b3IKICAgICovCiAgICBmdW5jdGlvbiBEeW5hbWljbHlDcmVhdGVkKGN0b3IsIGFyZ3MpIHsKICAgICAgICByZXR1cm4gY3Rvci5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0KICAgIC8qKgogICAgKiBDcmVhdGVzIGFuIG9iamVjdCBieSBlaXRoZXIgaW52b2tpbmcgY3RvciBhcyBhIGZ1bmN0aW9uIGFuZCByZXR1cm5pbmcgdGhlIHJlc3VsdCwKICAgICogb3IgYnkgY2FsbGluZyBuZXcgY3RvcigpLiAgSXQgdXNlcyBhIHNpbXBsZSBoZXVyaXN0aWMgdG8gdHJ5IHRvIGd1ZXNzIHdoaWNoIGFwcHJvYWNoCiAgICAqIGlzIHRoZSAicmlnaHQiIG9uZS4KICAgICoKICAgICogQHBhcmFtIGN0b3Ige0Z1bmN0aW9ufSBmdW5jdGlvbiBvciBjb25zdHJ1Y3RvciB0byBpbnZva2UKICAgICogQHBhcmFtIGFyZ3Mge0FycmF5fSBhcnJheSBvZiBhcmd1bWVudHMgdG8gcGFzcyB0byBjdG9yIGluIGVpdGhlciBjYXNlCiAgICAqCiAgICAqIEByZXR1cm5zIFRoZSByZXN1bHQgb2YgaW52b2tpbmcgY3RvciB3aXRoIGFyZ3MsIHdpdGggb3Igd2l0aG91dCBuZXcsIGRlcGVuZGluZyBvbgogICAgKiB0aGUgc3RyYXRlZ3kgc2VsZWN0ZWQuCiAgICAqLwogICAgZnVuY3Rpb24gaW5zdGFudGlhdGUoY3RvciwgYXJncywgbmFtZSkgewogICAgICAgIER5bmFtaWNseUNyZWF0ZWQucHJvdG90eXBlID0gY3Rvci5wcm90b3R5cGU7CiAgICAgICAgRHluYW1pY2x5Q3JlYXRlZC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBjdG9yOwogICAgICAgIHZhciBiZWdvdHRlbiA9IG5ldyBEeW5hbWljbHlDcmVhdGVkKGN0b3IsIGFyZ3MpOwogICAgICAgIER5bmFtaWNseUNyZWF0ZWQucHJvdG90eXBlID0gdm9pZCAwOwogICAgICAgIHJldHVybiBiZWdvdHRlbjsKICAgIH0KICAgIGV4cG9ydHMuaW5zdGFudGlhdGUgPSBpbnN0YW50aWF0ZTsKICAgIC8qKgogICAgRmxhdHRlbiBhbmQgZmlsdGVyIGFycmF5cyBkb3duIHRvIGp1c3QgdGhlIGV4aXN0aW5nIHByb21pc2VzLgogICAgCiAgICBAbWV0aG9kIGZsYXR0ZW5Ub1Byb21pc2VzCiAgICBAcGFyYW0ge0FycmF5fSBBcnJheSB0byBmbGF0dGVuLCBhbmQgZmlsdGVyLgogICAgQHJldHVybnMge0FycmF5IG9mIFByb21pc2VzfQogICAgKiovCiAgICBmdW5jdGlvbiBmbGF0dGVuVG9Qcm9taXNlcyhhcnJheSkgewogICAgICAgIHJldHVybiBleHBvcnRzLl8uZmxhdHRlbihhcnJheSkuZmlsdGVyKGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIHJldHVybiB3aGVuLmlzUHJvbWlzZSh4KTsKICAgICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMuZmxhdHRlblRvUHJvbWlzZXMgPSBmbGF0dGVuVG9Qcm9taXNlczsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIG9iamVjdAogICAgLyoqCiAgICBJbnZlcnRzIGFuIG9iamVjdC4gIFRoZSBrZXlzIGJlY29tZSB2YWx1ZXMsIGFuZCB0aGUgdmFsdWVzIGJlY29tZSBrZXlzLgogICAgRG9lcyBub3QgZG8gYW55IGNvcHlpbmcuCiAgICAKICAgIEBtZXRob2QgaW52ZXJ0CiAgICBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgdG8gaW52ZXJ0LgogICAgQHJldHVybnMge09iamVjdH0gVGhlIGludmVydGVkIG9iamVjdC4KICAgICoqLwogICAgdmFyIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICBmdW5jdGlvbiBpbnZlcnQob2JqKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IHsKICAgICAgICB9OwogICAgICAgIGZvcih2YXIgaSBpbiBvYmopIHsKICAgICAgICAgICAgaWYoaGFzT3duLmNhbGwob2JqLCBpKSkgewogICAgICAgICAgICAgICAgcmVzdWx0W29ialtpXV0gPSBpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBleHBvcnRzLmludmVydCA9IGludmVydDsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIHR5cGUudHMKICAgIC8qKgogICAgQ2hlY2tzIGlzIHRoZSBvYmplY3QgaXMgYXJyYXkgbGlrZSwgbGlrZSB0aGUgYXJ1Z3VtZW50cyBvYmplY3QsIGJ1dCBub3QgYSBzdHJpbmcsIG9lIGFycmF5LgogICAgalF1ZXJ5IG9iamVjdHMgZm9yIGV4YW1wbGUgd291bGQgcmVwb3J0IGFzIGFycmF5IGxpa2UuCiAgICBBcyB3ZWxsIGFzIGtub2Nrb3V0IG9ic2VydmFibGUgYXJyYXlzIHJlcG9ydCBhcyBhcnJheSBsaWtlLgogICAgCiAgICBAbWV0aG9kIGlzQXJyYXlMaWtlCiAgICBAcGFyYW0ge09iamVjdH0gbyBUaGUgb2JqZWN0IHRvIGNoZWNrCiAgICBAcmV0dXJucyB7Qm9vbGVhbn0gSXMgaXQgdHJ1ZSBvciBmYWxzZS4KICAgICoqLwogICAgZnVuY3Rpb24gaXNBcnJheUxpa2UobykgewogICAgICAgIHJldHVybiAobyAmJiAhZXhwb3J0cy5fLmlzU3RyaW5nKG8pICYmIG8ubGVuZ3RoICE9PSB1bmRlZmluZWQpIHx8IGZhbHNlOwogICAgfQogICAgZXhwb3J0cy5pc0FycmF5TGlrZSA9IGlzQXJyYXlMaWtlOwogICAgLyoqCiAgICBDaGVja3MgaWYgdGhlIGdpdmVuIG9iamVjdCBpcyBhcnJheSBvciBhcnJheSBsaWtlLgogICAgCiAgICBAbWV0aG9kIGlzQXJyYXlPckFycmF5TGlrZQogICAgQHBhcmFtIHtPYmplY3R9IG8gVGhlIG9iamVjdCB0byBjaGVjawogICAgQHJldHVybnMge0Jvb2xlYW59IElzIGl0IHRydWUgb3IgZmFsc2UuCiAgICAqKi8KICAgIGZ1bmN0aW9uIGlzQXJyYXlPckFycmF5TGlrZShvKSB7CiAgICAgICAgcmV0dXJuIGV4cG9ydHMuXy5pc0FycmF5KG8pIHx8IChpc0FycmF5TGlrZShvKSk7CiAgICB9CiAgICBleHBvcnRzLmlzQXJyYXlPckFycmF5TGlrZSA9IGlzQXJyYXlPckFycmF5TGlrZTsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIHV1aWQKICAgICAgICB2YXIgZ3VpZFJlZ2V4ID0gL14oXHt7MCwxfShbMC05YS1mQS1GXSl7OH0tKFswLTlhLWZBLUZdKXs0fS0oWzAtOWEtZkEtRl0pezR9LShbMC05YS1mQS1GXSl7NH0tKFswLTlhLWZBLUZdKXsxMn1cfXswLDF9KSQvLCBlbXRwdHlHdWlkID0gJzAwMDAwMDAwLTAwMDAtMDAwMC0wMDAwLTAwMDAwMDAwMDAwMCc7CiAgICAvKioKICAgIFJldHVybnMgYSBuZXcgc3VkbyBndWlkLCBsaW1pYXRpb25zIGluIEphdmFTY3JpcHQgbWFrZSBtdXN0IG1vcmUgcmVsaWFibGUgZ3VpZHMgZmFpcmx5IGRpZmZpY3VsdCB0byBjcmVhdGUuCiAgICAKICAgIEBmb3IgdGhydXN0LnV0aWwKICAgIEBtZXRob2QgbmV3R3VpZAogICAgQHJldHVybnMge0d1aWR9IFRoZSBuZXcgZ3VpZC4KICAgICoqLwogICAgZnVuY3Rpb24gbmV3R3VpZCgpIHsKICAgICAgICByZXR1cm4gdXVpZC52NCgpOwogICAgfQogICAgZXhwb3J0cy5uZXdHdWlkID0gbmV3R3VpZDsKICAgIC8qKgogICAgUmV0dXJucyBhbiBlbXB0eSBndWlkLgogICAgCiAgICBAbWV0aG9kIGVtcHR5R3VpZAogICAgQHJldHVybnMge0d1aWR9IFRoZSBlbXRwdHkgZ3VpZC4KICAgICoqLwogICAgZnVuY3Rpb24gZW1wdHlHdWlkKCkgewogICAgICAgIHJldHVybiBlbXRwdHlHdWlkOwogICAgfQogICAgZXhwb3J0cy5lbXB0eUd1aWQgPSBlbXB0eUd1aWQ7CiAgICAvKioKICAgIENoZWNrcyBpZiB0aGUgZ2l2ZW4gc3RyaW5nIGlzIGEgZ3VpZC4KICAgIAogICAgQG1ldGhvZCBpc0d1aWQKICAgIEBwYXJhbSB7R3VpZH0gZ3VpZAogICAgQHJldHVybnMge0Jvb2xlYW59IElmIHRoZSBndWlkIGlzIGEgZ3VpZCBvciBub3QuCiAgICAqKi8KICAgIGZ1bmN0aW9uIGlzR3VpZChndWlkKSB7CiAgICAgICAgcmV0dXJuIGV4cG9ydHMuXy5pc1N0cmluZyhndWlkKSA/IGd1aWRSZWdleC50ZXN0KGd1aWQpIDogZmFsc2U7CiAgICB9CiAgICBleHBvcnRzLmlzR3VpZCA9IGlzR3VpZDsKICAgIC8qKgogICAgQ2hlY2tzIGlmIHRoZSBHdWlkIGlzIGFuIEVtcHR5IEd1aWQKICAgIAogICAgQG1ldGhvZCBpc0VtcHR5R3VpZAogICAgQHBhcmFtIHtHdWlkfSBndWlkCiAgICBAcmV0dXJucyB7Qm9vbGVhbn0gSWYgdGhlIGd1aWQgaXMgYSBndWlkIG9yIG5vdC4KICAgICoqLwogICAgZnVuY3Rpb24gaXNFbXB0eUd1aWQoZ3VpZCkgewogICAgICAgIHJldHVybiBndWlkID09PSBlbXRwdHlHdWlkOwogICAgfQogICAgZXhwb3J0cy5pc0VtcHR5R3VpZCA9IGlzRW1wdHlHdWlkOwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gc3RyaW5nCiAgICAgICAgdmFyIG9iamVjdEN1cmx5UmVnZXggPSAvXHtce3xcfVx9fFx7KC4qPylcfS9nLCBudW1iZXJDdXJseVJlZ2V4ID0gL1x7XHt8XH1cfXxceyhcZCspXH0vZzsKICAgIC8qKgogICAgQyMgc3R5bGUgc3RyaW5nIGZvcm1hdC4KICAgIAogICAgQGZvciB0aHJ1c3QudXRpbAogICAgQG1ldGhvZCBmb3JtYXQKICAgICoqLwogICAgZnVuY3Rpb24gZm9ybWF0KHN0cikgewogICAgICAgIHZhciBmb3JtYXRBcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgZm9ybWF0QXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICB9CiAgICAgICAgaWYodHlwZW9mIGZvcm1hdEFyZ3NbMF0gPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgIHZhciBhID0gZm9ybWF0QXJnc1swXTsKICAgICAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKG9iamVjdEN1cmx5UmVnZXgsIGZ1bmN0aW9uIChtLCBuKSB7CiAgICAgICAgICAgICAgICBpZihtID09ICd7eycpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3snOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYobSA9PSAnfX0nKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd9JzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhICYmIGFbbl0gfHwgJyc7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UobnVtYmVyQ3VybHlSZWdleCwgZnVuY3Rpb24gKG0sIG4pIHsKICAgICAgICAgICAgaWYobSA9PSAne3snKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ3snOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG0gPT0gJ319JykgewogICAgICAgICAgICAgICAgcmV0dXJuICd9JzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZm9ybWF0QXJnc1tuXSB8fCAnJzsKICAgICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMuZm9ybWF0ID0gZm9ybWF0OwogICAgZnVuY3Rpb24gZ2V0TW9kdWxlTmFtZUZvclBhdGgobmFtZSkgewogICAgICAgIHJldHVybiAobmFtZS5sYXN0SW5kZXhPZignLycpID4gLTEgPyBuYW1lLnN1YnN0cmluZyhuYW1lLmxhc3RJbmRleE9mKCcvJykgKyAxKSA6IG5hbWUpLnJlcGxhY2UoL1wuL2csICctJyk7CiAgICB9CiAgICBleHBvcnRzLmdldE1vZHVsZU5hbWVGb3JQYXRoID0gZ2V0TW9kdWxlTmFtZUZvclBhdGg7CiAgICAvLyNlbmRyZWdpb24KICAgIC8vI3JlZ2lvbiB1cmwKICAgICAgICB2YXIgZG91YmxlU2xhc2hSZWdleCA9IC9cL1wvL2csIHIyMCA9IC8lMjAvZywgcmJyYWNrZXQgPSAvXFtcXSQvOwogICAgLyoqCiAgICBqUXVlcnkgcGFyYW0gbWV0aG9kIHRvIGVuY29kZSBmb3JtIHBhcmFtZXRlcnMuCiAgICAKICAgIEBmb3IgdGhydXN0LnV0aWwudXJsCiAgICBAbWV0aG9kIHBhcmFtCiAgICAqKi8KICAgIGZ1bmN0aW9uIHBhcmFtKGEsIHRyYWRpdGlvbmFsKSB7CiAgICAgICAgdmFyIHByZWZpeCwgcyA9IFtdLCBhZGQgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAvLyBJZiB2YWx1ZSBpcyBhIGZ1bmN0aW9uLCBpbnZva2UgaXQgYW5kIHJldHVybiBpdHMgdmFsdWUKICAgICAgICAgICAgdmFsdWUgPSBleHBvcnRzLl8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSgpIDogKHZhbHVlID09IG51bGwgPyAiIiA6IHZhbHVlKTsKICAgICAgICAgICAgc1tzLmxlbmd0aF0gPSBlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgICAgICAgfTsKICAgICAgICAvLyBTZXQgdHJhZGl0aW9uYWwgdG8gdHJ1ZSBmb3IgalF1ZXJ5IDw9IDEuMy4yIGJlaGF2aW9yLgogICAgICAgIC8qaWYgKHRyYWRpdGlvbmFsID09PSB1bmRlZmluZWQpCiAgICAgICAgewogICAgICAgIC8vIFRPRE8gU3VwcG9ydCBmb3IgdHJhZGl0aW9uYWxFbmNvZGluZwogICAgICAgIC8vdHJhZGl0aW9uYWwgPSAhIW0uY29uZmlnKCkudHJhZGl0aW9uYWxFbmNvZGluZzsKICAgICAgICB9Ki8KICAgICAgICAvLyBJZiBhbiBhcnJheSB3YXMgcGFzc2VkIGluLCBhc3N1bWUgdGhhdCBpdCBpcyBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzLgogICAgICAgIGlmKGlzQXJyYXlPckFycmF5TGlrZShhKSkgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgdGhlIGZvcm0gZWxlbWVudHMKICAgICAgICAgICAgZXhwb3J0cy5fLmVhY2goYSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIGFkZCh4Lm5hbWUsIHgudmFsdWUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBJZiB0cmFkaXRpb25hbCwgZW5jb2RlIHRoZSAib2xkIiB3YXkgKHRoZSB3YXkgMS4zLjIgb3Igb2xkZXIKICAgICAgICAgICAgLy8gZGlkIGl0KSwgb3RoZXJ3aXNlIGVuY29kZSBwYXJhbXMgcmVjdXJzaXZlbHkuCiAgICAgICAgICAgIGZvcihwcmVmaXggaW4gYSkgewogICAgICAgICAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4LCBhW3ByZWZpeF0sIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIFJldHVybiB0aGUgcmVzdWx0aW5nIHNlcmlhbGl6YXRpb24KICAgICAgICByZXR1cm4gcy5qb2luKCImIikucmVwbGFjZShyMjAsICIrIik7CiAgICB9CiAgICBleHBvcnRzLnBhcmFtID0gcGFyYW07CiAgICBmdW5jdGlvbiBidWlsZFBhcmFtcyhwcmVmaXgsIG9iaiwgdHJhZGl0aW9uYWwsIGFkZCkgewogICAgICAgIGlmKGV4cG9ydHMuXy5pc0FycmF5KG9iaikpIHsKICAgICAgICAgICAgLy8gU2VyaWFsaXplIGFycmF5IGl0ZW0uCiAgICAgICAgICAgIGV4cG9ydHMuXy5lYWNoKG9iaiwgZnVuY3Rpb24gKGksIHYpIHsKICAgICAgICAgICAgICAgIGlmKHRyYWRpdGlvbmFsIHx8IHJicmFja2V0LnRlc3QocHJlZml4KSkgewogICAgICAgICAgICAgICAgICAgIC8vIFRyZWF0IGVhY2ggYXJyYXkgaXRlbSBhcyBhIHNjYWxhci4KICAgICAgICAgICAgICAgICAgICBhZGQocHJlZml4LCB2KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSWYgYXJyYXkgaXRlbSBpcyBub24tc2NhbGFyIChhcnJheSBvciBvYmplY3QpLCBlbmNvZGUgaXRzCiAgICAgICAgICAgICAgICAgICAgLy8gbnVtZXJpYyBpbmRleCB0byByZXNvbHZlIGRlc2VyaWFsaXphdGlvbiBhbWJpZ3VpdHkgaXNzdWVzLgogICAgICAgICAgICAgICAgICAgIC8vIE5vdGUgdGhhdCByYWNrIChhcyBvZiAxLjAuMCkgY2FuJ3QgY3VycmVudGx5IGRlc2VyaWFsaXplCiAgICAgICAgICAgICAgICAgICAgLy8gbmVzdGVkIGFycmF5cyBwcm9wZXJseSwgYW5kIGF0dGVtcHRpbmcgdG8gZG8gc28gbWF5IGNhdXNlCiAgICAgICAgICAgICAgICAgICAgLy8gYSBzZXJ2ZXIgZXJyb3IuIFBvc3NpYmxlIGZpeGVzIGFyZSB0byBtb2RpZnkgcmFjaydzCiAgICAgICAgICAgICAgICAgICAgLy8gZGVzZXJpYWxpemF0aW9uIGFsZ29yaXRobSBvciB0byBwcm92aWRlIGFuIG9wdGlvbiBvciBmbGFnCiAgICAgICAgICAgICAgICAgICAgLy8gdG8gZm9yY2UgYXJyYXkgc2VyaWFsaXphdGlvbiB0byBiZSBzaGFsbG93LgogICAgICAgICAgICAgICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCArICJbIiArICh0eXBlb2YgdiA9PT0gIm9iamVjdCIgfHwgZXhwb3J0cy5fLmlzQXJyYXkodikgPyBpIDogIiIpICsgIl0iLCB2LCB0cmFkaXRpb25hbCwgYWRkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmKCF0cmFkaXRpb25hbCAmJiBvYmogIT0gbnVsbCAmJiB0eXBlb2Ygb2JqID09PSAib2JqZWN0IikgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgb2JqZWN0IGl0ZW0uCiAgICAgICAgICAgIGZvcih2YXIgbmFtZSBpbiBvYmopIHsKICAgICAgICAgICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCArICJbIiArIG5hbWUgKyAiXSIsIG9ialtuYW1lXSwgdHJhZGl0aW9uYWwsIGFkZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgc2NhbGFyIGl0ZW0uCiAgICAgICAgICAgIGFkZChwcmVmaXgsIG9iaik7CiAgICAgICAgfQogICAgfQogICAgLyoqCiAgICBDbGVhbnMgdXAgZG91YmxlIHNsYXNocyBpbiBhIHVybCwgdXNlZCBieSB0aHJ1c3QvZGF0YQogICAgCiAgICBAbWV0aG9kIGNsZWFuVXJsCiAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gY2xlYW4KICAgIEByZXRydXNuIHtTdHJpbmd9IFRoZSBjbGVhbmVkIHVybAogICAgKiovCiAgICBmdW5jdGlvbiBjbGVhblVybCh1cmwpIHsKICAgICAgICByZXR1cm4gdXJsLnJlcGxhY2UoZG91YmxlU2xhc2hSZWdleCwgJy8nKTsKICAgIH0KICAgIGV4cG9ydHMuY2xlYW5VcmwgPSBjbGVhblVybDsKICAgIC8qKgogICAgQ2hlY2tzIGZvciBleGlzdGFuY2Ugb2YgYXBwbGljYXRpb24gcGF0aCBpbiB0aGUgdXJsLCBvciBodHRwIGlmIHRoZSB1cmwgaXMgc3VwcG9zZWQgdG8gZ28gdG8gYW5vdGhlciBsb2NhdGlvbi4KICAgIAogICAgQG1ldGhvZCBmaXh1cFVybAogICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGZpeHVwCiAgICBAcmV0cnVzbiB7U3RyaW5nfSBUaGUgZml4ZWQgdXJsCiAgICAqKi8KICAgIGZ1bmN0aW9uIGZpeHVwVXJsKHVybCwgdXJsUGF0aCkgewogICAgICAgIGlmKHVybC5pbmRleE9mKCdodHRwJykgPT09IC0xKSB7CiAgICAgICAgICAgIHZhciBwYXRoID0gdXJsUGF0aC5sYXN0SW5kZXhPZignLycpID09PSB1cmxQYXRoLmxlbmd0aCAtIDEgPyB1cmxQYXRoLnN1YnN0cmluZygwLCAtMSkgOiB1cmxQYXRoOwogICAgICAgICAgICBpZih1cmwuaW5kZXhPZihwYXRoKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIHVybCA9IHBhdGggKyB1cmw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXJsID0gY2xlYW5VcmwodXJsKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVybDsKICAgIH0KICAgIGV4cG9ydHMuZml4dXBVcmwgPSBmaXh1cFVybDsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIHdoZW4KICAgIHZhciB3ID0gX193X187CgogICAgLy9pbXBvcnQgdyA9IG1vZHVsZSgnd2hlbi9kZWJ1ZycpOwogICAgdmFyIHdoZW5BcHBseSA9IF9fd2hlbkFwcGx5X187CgogICAgdmFyIHdoZW5EZWxheSA9IF9fd2hlbkRlbGF5X187CgogICAgdmFyIHdoZW5UaW1lb3V0ID0gX193aGVuVGltZW91dF9fOwoKICAgIHZhciB3aGVuUGFyYWxsZWwgPSBfX3doZW5QYXJhbGxlbF9fOwoKICAgIHZhciB3aGVuUGlwZWxpbmUgPSBfX3doZW5QaXBlbGluZV9fOwoKICAgIHZhciB3aGVuU2VxdWVuY2UgPSBfX3doZW5TZXF1ZW5jZV9fOwoKICAgIHZhciB3aGVuQ2FuY2VsYWJsZSA9IF9fd2hlbkNhbmNlbGFibGVfXzsKCiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LnV0aWwKICAgIEBzdWJtb2R1bGUgdGhydXN0LnV0aWwud2hlbgogICAgKiovCiAgICAoZnVuY3Rpb24gKHdoZW4pIHsKICAgICAgICB3aGVuLndoZW4gPSB3OwogICAgICAgIC8qKgogICAgICAgIHdoZW4uYXBwbHksIHVzZWQgdG8gYXBwbHkgd2hlbiByZXN1bHRzIG92ZXIgYSBmdW5jdGlvbiwgc2ltaWxhciB0byBqUXVlcnlzIERlZmVycmVkLgogICAgICAgIFNlZSBmb3IgbW9yZSBpbmZvcm1hdGlvbjogW2h0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tYXBwbHldKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tYXBwbHkpCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudXRpbC53aGVuCiAgICAgICAgQG1ldGhvZCB3aGVuLmFwcGx5CiAgICAgICAgKiovCiAgICAgICAgd2hlbi5hcHBseSA9IHdoZW5BcHBseTsKICAgICAgICAvKioKICAgICAgICB3aGVuLmRlbGF5LCBjcmVhdGVzIGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIGluIHggbXMsIHVzaW5nIHNldFRpbWVvdXQuCiAgICAgICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1kZWxheV0oaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1kZWxheSkKICAgICAgICAKICAgICAgICBAbWV0aG9kIHdoZW4uZGVsYXkKICAgICAgICAqKi8KICAgICAgICB3aGVuLmRlbGF5ID0gd2hlbkRlbGF5OwogICAgICAgIC8qKgogICAgICAgIHdoZW4udGltZW91dCwgY3JlYXRlcyBhIHByb21pc2UgdGhhdCB3aWxsIHRpbWVvdXQgaWYgeCBtcyBpZiBub3QgcmVzb2x2ZWQuCiAgICAgICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi10aW1lb3V0XShodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXRpbWVvdXQpCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCB3aGVuLnRpbWVvdXQKICAgICAgICAqKi8KICAgICAgICB3aGVuLnRpbWVvdXQgPSB3aGVuVGltZW91dDsKICAgICAgICAvKioKICAgICAgICB3aGVuLnBhcmFsbGVsCiAgICAgICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1wYXJhbGxlbF0oaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1wYXJhbGxlbCkKICAgICAgICAKICAgICAgICBAbWV0aG9kIHdoZW4ucGFyYWxsZWwKICAgICAgICAqKi8KICAgICAgICB3aGVuLnBhcmFsbGVsID0gd2hlblBhcmFsbGVsOwogICAgICAgIC8qKgogICAgICAgIHdoZW4ucGlwZWxpbmUKICAgICAgICBTZWUgZm9yIG1vcmUgaW5mb3JtYXRpb246IFtodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXBpcGVsaW5lXShodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXBpcGVsaW5lKQogICAgICAgIAogICAgICAgIEBtZXRob2Qgd2hlbi5waXBlbGluZQogICAgICAgICoqLwogICAgICAgIHdoZW4ucGlwZWxpbmUgPSB3aGVuUGlwZWxpbmU7CiAgICAgICAgLyoqCiAgICAgICAgd2hlbi5zZXF1ZW5jZQogICAgICAgIFNlZSBmb3IgbW9yZSBpbmZvcm1hdGlvbjogW2h0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tc2VxdWVuY2VdKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tc2VxdWVuY2UpCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCB3aGVuLnNlcXVlbmNlCiAgICAgICAgKiovCiAgICAgICAgd2hlbi5zZXF1ZW5jZSA9IHdoZW5TZXF1ZW5jZTsKICAgICAgICAvKioKICAgICAgICB3aGVuLmNhbmNlbGFibGUKICAgICAgICBTZWUgZm9yIG1vcmUgaW5mb3JtYXRpb246IFtodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLWNhbmNlbGFibGVdKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tY2FuY2VsYWJsZSkKICAgICAgICAKICAgICAgICBAbWV0aG9kIHdoZW4uY2FuY2VsYWJsZQogICAgICAgICoqLwogICAgICAgIHdoZW4uY2FuY2VsYWJsZSA9IHdoZW5DYW5jZWxhYmxlOwogICAgICAgIHdoZW4uYWxsID0gd2hlbi53aGVuLmFsbDsKICAgICAgICB3aGVuLmFueSA9IHdoZW4ud2hlbi5hbnk7CiAgICAgICAgd2hlbi5jaGFpbiA9IHdoZW4ud2hlbi5jaGFpbjsKICAgICAgICB3aGVuLmRlZmVyID0gd2hlbi53aGVuLmRlZmVyOwogICAgICAgIHdoZW4uaXNQcm9taXNlID0gd2hlbi53aGVuLmlzUHJvbWlzZTsKICAgICAgICB3aGVuLm1hcCA9IHdoZW4ud2hlbi5tYXA7CiAgICAgICAgd2hlbi5yZWR1Y2UgPSB3aGVuLndoZW4ucmVkdWNlOwogICAgICAgIHdoZW4uc29tZSA9IHdoZW4ud2hlbi5zb21lOwogICAgICAgIHdoZW4ucmVzb2x2ZSA9IHdoZW4ud2hlbi5yZXNvbHZlOwogICAgICAgIHdoZW4ucmVqZWN0ID0gd2hlbi53aGVuLnJlamVjdDsKICAgICAgICB3aGVuLmpvaW4gPSB3aGVuLndoZW4uam9pbjsKICAgIH0pKGV4cG9ydHMud2hlbiB8fCAoZXhwb3J0cy53aGVuID0ge30pKTsKICAgIHZhciB3aGVuID0gZXhwb3J0cy53aGVuOwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gY2FtZWxDYXNlCiAgICAgICAgdmFyIHJtc1ByZWZpeCA9IC9eLW1zLS8sIHJkYXNoQWxwaGEgPSAvLShbXGRhLXpdKS9naSwgZmNhbWVsQ2FzZSA9IGZ1bmN0aW9uIChhbGwsIGxldHRlcikgewogICAgICAgIHJldHVybiAobGV0dGVyICsgIiIpLnRvVXBwZXJDYXNlKCk7CiAgICB9OwogICAgZnVuY3Rpb24gY2FtZWxDYXNlKHN0cmluZykgewogICAgICAgIHJldHVybiBzdHJpbmcucmVwbGFjZShybXNQcmVmaXgsICJtcy0iKS5yZXBsYWNlKHJkYXNoQWxwaGEsIGZjYW1lbENhc2UpOwogICAgfQogICAgZXhwb3J0cy5jYW1lbENhc2UgPSBjYW1lbENhc2U7CiAgICBmdW5jdGlvbiB1bkNhbWVsQ2FzZShzdHIpIHsKICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UoLyhbQS1aXSkvZywgZnVuY3Rpb24gKGFsbCwgcykgewogICAgICAgICAgICByZXR1cm4gJy0nICsgcy50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy51bkNhbWVsQ2FzZSA9IHVuQ2FtZWxDYXNlOwogICAgLy8jZW5kcmVnCiAgICB9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3V0aWwnLCBbJ3RocnVzdC91dGlsL21haW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwoKZGVmaW5lKCd0aHJ1c3QvY2Fwc3VsZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L3V0aWwnLCAnLi9sb2cnLCAnaGFzJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdXRpbF9fLCBfX2xvZ19fLCBfX2hhc19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBsb2cgPSBfX2xvZ19fOwoKICAgIHZhciBoYXMgPSBfX2hhc19fOwoKICAgIHZhciBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgZWFjaCA9IF8uZWFjaCwgaXNPYmplY3QgPSBfLmlzT2JqZWN0LCBleHRlbmQgPSBfLmV4dGVuZCwgd2hlbiA9IHV0aWwud2hlbiwgZmxhdHRlbiA9IF8uZmxhdHRlbiwgcGx1Y2sgPSBfLnBsdWNrLCBmbGF0dGVuVG9Qcm9taXNlcyA9IHV0aWwuZmxhdHRlblRvUHJvbWlzZXMsIHRocnVzdENhY2hlID0gewogICAgfSwgX19vcHRpb25hbE1ldGhvZHMgPSBbCiAgICAgICAgLy8gT3B0aW9uYWwgbWV0aG9kcyB0aGF0IG1heSBiZSBvbiBhIG1vZHVsZQogICAgICAgICdzdGFydCcsIAogICAgICAgICdzdG9wJywgCiAgICAgICAgJ3JlYWR5JywgCiAgICAgICAgJ2NvbmZpZycsIAogICAgICAgIAogICAgXSwgX19yZXF1aXJlZE1ldGhvZHMgPSBbCiAgICAgICAgLy8gUmVxdWlyZWQgbWV0aG9kcyB0aGF0IG11c3QgYmUgb24gZXZlcnkgbW9kdWxlCiAgICAgICAgJ2luaXQnLCAKICAgICAgICAnZGVzdHJveScsIAogICAgICAgIAogICAgXTsKICAgIC8qKgogICAgTW92ZXMgYWxsIHByb3BlcnRpZXMsIHRoYXQgc2hvdWxkIGV4aXN0IG91dHNpZGUgb2YgdGhlIG1vZHVsZSwgaW50byBhIHByaXZhdGUgb2JqZWN0IGZvciBob2xkaW5nLgogICAgCiAgICBAbWV0aG9kIG1vdmVUb1RocnVzdENhY2hlCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtPYmplY3R9IGZyb20gT2JqZWN0IHRvIGV4dHJhY3QgaXRlbXMgZnJvbQogICAgQHBhcmFtIHtPYmplY3R9IHRvIE9iamVjdCB0byBwbGFjZSBpdGVtcyBvbgogICAgQHBhcmFtIHtBcnJheX0gbGlzdCBJdGVtcyB0byBtb3ZlIGZyb20gdG8gdGhlIG90aGVyIG9iamVjdAogICAgKiovCiAgICBmdW5jdGlvbiBtb3ZlVG9UaHJ1c3RDYWNoZShmcm9tLCB0bywgbGlzdCkgewogICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBsaXN0Lmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICB0b1tsaXN0W2ldXSA9IGZyb21bbGlzdFtpXV07CiAgICAgICAgICAgIGRlbGV0ZSBmcm9tW2xpc3RbaV1dOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGdldEV2ZW50TmFtZXNwYWNlKG5hbWUsIHByZWZpeCkgewogICAgICAgIGlmKCFwcmVmaXgpIHsKICAgICAgICAgICAgcHJlZml4ID0gJ21vZHVsZS0nOwogICAgICAgIH0KICAgICAgICByZXR1cm4gJy4nICsgKG5hbWUgPT09ICdnbG9iYWwnID8gJ2dsb2JhbCcgOiBwcmVmaXggKyBuYW1lLnJlcGxhY2UoL1wuL2csICctJykpOwogICAgfQogICAgZnVuY3Rpb24gY2FsbEZhY2FkZU1ldGhvZHMobWV0aG9kLCBtb2R1bGVDYWNoZSkgewogICAgICAgIHZhciBtID0gbW9kdWxlQ2FjaGUubW9kdWxlOwogICAgICAgIHZhciByZXN1bHRzID0gW107CiAgICAgICAgXy5mb3JPd24obW9kdWxlQ2FjaGUuZmFjYWRlcywgZnVuY3Rpb24gKGZhY2FkZSwgaSkgewogICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoZm9ybWF0KCd0aHJ1c3QvY2Fwc3VsZTogQ2FsbGluZyBmYWNhZGUgInswfSIgezF9KCknLCBpLCBtZXRob2QpKTsKICAgICAgICAgICAgaWYoZmFjYWRlW21ldGhvZF0gJiYgaXNPYmplY3QoZmFjYWRlKSkgewogICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKGZhY2FkZVttZXRob2RdLmNhbGwoZmFjYWRlLCBtKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXN1bHRzLnB1c2godXRpbC5zYWZlSW52b2tlKChtLnRocnVzdCkuX190aHJ1c3RDb252ZW50aW9ucywgbWV0aG9kLCBtLCBtb2R1bGVDYWNoZS5mYWNhZGVzKSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICB9CiAgICAvKioKICAgIFRoZSBtb2R1bGUgaXMgdGhlIGhlYXJ0IG9mIHRoZSB0aHJ1c3QsIGV2ZXJ5IG1vZHVsZSBnZXRzIG9uZSBmYWNhZGUgcGVyIG1vZHVsZS4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgIEBjbGFzcyB0aHJ1c3QuTW9kdWxlCiAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UKICAgIEBwYXJhbSB7T2JqZWN0fSBkZWYgVGhlIG1vZHVsZSBkZWZpbml0aW9uCiAgICBAcGFyYW0ge1N0cmluZ30gW25hbWVdIFRoZSBtb2R1bGUgbmFtZS4KICAgICoqLwogICAgdmFyIE1vZHVsZSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgLy92YXIgTW9kdWxlID0KICAgICAgICBmdW5jdGlvbiBNb2R1bGUodGhydXN0LCBkZWYsIG5hbWUpIHsKICAgICAgICAgICAgbmFtZSA9IHRoaXMubmFtZSA9IChuYW1lIHx8IGRlZi5uYW1lKTsKICAgICAgICAgICAgaWYodHlwZW9mIGRlZiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgZGVmID0gZGVmKG5hbWUpOwogICAgICAgICAgICAgICAgZGVmLm5hbWUgPSBuYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBtaWQgPSB0aGlzLm1pZCA9IHRocnVzdC5uYW1lICsgJzonICsgbmFtZTsKICAgICAgICAgICAgdmFyIHRDYWNoZSA9IHRocnVzdENhY2hlW2RlZi5oYXNoIHx8IG1pZF07CiAgICAgICAgICAgIC8vIENsZWFyIGFueSBwb3RlbnRpYWwgY2FjaGVkIGNvbmZpZyBvYmplY3RzLCB0byBtYWtlIHN1cmUgdGhleSByZWZyZXNoIGlmIHRoZSBtb2R1bGUgaXMgcmVkZWZpbmVkLgogICAgICAgICAgICBpZih0Q2FjaGUpIHsKICAgICAgICAgICAgICAgIF8ua2V5cyh0Q2FjaGUpLmZpbHRlcihmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB4LmluZGV4T2YoJ2NvbmZpZy4nKSA9PT0gMDsKICAgICAgICAgICAgICAgIH0pLmZvckVhY2goZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGVsZXRlIHRDYWNoZVt4XTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaW5zdGFuY2UgPSBleHRlbmQoZGVmLCB0Q2FjaGUgJiYgdENhY2hlLmluc3RhbmNlIHx8IHsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuaW5zdGFuY2UubmFtZSA9ICh0aGlzLmluc3RhbmNlLm5hbWUgfHwgbmFtZSk7CiAgICAgICAgICAgIHRoaXMuaW5zdGFuY2UubWlkID0gbWlkOwogICAgICAgICAgICBpZighdGhpcy5pbnN0YW5jZS5uYW1lKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FsbCBNb2R1bGVzIG11c3QgaGF2ZSBhIG5hbWUhJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gTW9kdWxlcyBtdXN0IGhhdmUgYW4gaW5pdCBtZXRob2QgYW5kIGEgZGVzdHJveSBtZXRob2QsIGl0J3MgdXAgdG8gdGhlIG1vZHVsZSBkZXZlbG9wZXIgdG8gcG9wdWxhdGUgdGhlc2UgbWV0aG9kcy4KICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IF9fcmVxdWlyZWRNZXRob2RzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgaWYoIWRlZltfX3JlcXVpcmVkTWV0aG9kc1tpXV0pIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdSZXF1aXJlZCAiezB9IiBtZXRob2Qgbm90IGZvdW5kIG9uIG1vZHVsZSAiezF9IiEnLCBfX3JlcXVpcmVkTWV0aG9kc1tpXSwgbmFtZSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIElmIHRoZSBtb2R1bGUgbmFtZSBpcyB1bmRlZmluZWQsIGJyaW5nIHRoZSBuYW1lIGludG8gdGhlIG1vZHVsZS4KICAgICAgICAgICAgaWYodHlwZW9mIGRlZi5uYW1lID09PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgZGVmLm5hbWUgPSBuYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0gPSB0aHJ1c3RDYWNoZVttaWRdID0gZXh0ZW5kKHRDYWNoZSB8fCB7CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIF9zdGFydGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgIG5hbWU6IHV0aWwuZ2V0TW9kdWxlTmFtZUZvclBhdGgobmFtZSksCiAgICAgICAgICAgICAgICBtb2R1bGU6IHRoaXMKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRlbGV0ZSB0aHJ1c3RDYWNoZVtkZWYuaGFzaF07CiAgICAgICAgICAgIHZhciBmYWNhZGVzID0gdGhydXN0TW9kdWxlQ2FjaGVJdGVtLmZhY2FkZXMgfHwgKHRocnVzdE1vZHVsZUNhY2hlSXRlbS5mYWNhZGVzID0gewogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYoIXRocnVzdC5fX2NvbnZlbnRpb25QbHVja1Byb3BlcnRpZXNDYWNoZSkgewogICAgICAgICAgICAgICAgdGhydXN0Ll9fY29udmVudGlvblBsdWNrUHJvcGVydGllc0NhY2hlID0gZmxhdHRlbihwbHVjayh0aHJ1c3QuX19jb252ZW50aW9ucyB8fCBbXSwgJ3Byb3BlcnRpZXMnKSkuZmlsdGVyKGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHguaW5kZXhPZignY29uZmlnLicpICE9PSAwOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gTW92ZSBhbGwgc3BlY2lhbCBwcm9wZXJ0aWVzIG9mZiB0byB0aGUgdGhydXN0J3MgaW50ZXJuYWwgbWV0aG9kLgogICAgICAgICAgICBtb3ZlVG9UaHJ1c3RDYWNoZSh0aGlzLmluc3RhbmNlLCB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0sIF9fcmVxdWlyZWRNZXRob2RzKTsKICAgICAgICAgICAgbW92ZVRvVGhydXN0Q2FjaGUodGhpcy5pbnN0YW5jZSwgdGhydXN0TW9kdWxlQ2FjaGVJdGVtLCBfX29wdGlvbmFsTWV0aG9kcyk7CiAgICAgICAgICAgIG1vdmVUb1RocnVzdENhY2hlKHRoaXMuaW5zdGFuY2UsIHRocnVzdE1vZHVsZUNhY2hlSXRlbSwgdGhydXN0Ll9fY29udmVudGlvblBsdWNrUHJvcGVydGllc0NhY2hlKTsKICAgICAgICAgICAgdXRpbC5zYWZlSW52b2tlKHRocnVzdCwgJ2NyZWF0ZUZhY2FkZScsIHRocnVzdCwgdGhpcy5pbnN0YW5jZSwgZmFjYWRlcyk7CiAgICAgICAgICAgIHRoaXMuX19uYW1lc3BhY2UgPSBnZXRFdmVudE5hbWVzcGFjZSh0aGlzLmluc3RhbmNlLm5hbWUpOwogICAgICAgICAgICB0aGlzLnRocnVzdCA9IHRocnVzdDsKICAgICAgICAgICAgdGhpcy5jYWNoZSA9IHRocnVzdENhY2hlW21pZF07CiAgICAgICAgfQogICAgICAgIE1vZHVsZS50aHJ1c3RDYWNoZSA9IHRocnVzdENhY2hlOwogICAgICAgIE1vZHVsZS5wcm90b3R5cGUuY29udmVudGlvbiA9IC8qKgogICAgICAgIEdldHRlci9TZXR0ZXIgZm9yIGNvbnZlbnRpb24gbWV0aG9kcy4KICAgICAgICBHZXRzIHRoZSB2YWx1ZSBjb252ZW50aW9uIHByb3BlcnR5IChkZWZpbmVkIGluIHRoZSBwcm9wZXJ0aWVzIGFycmF5IG9mIGEgZmFjYWRlKS4KICAgICAgICBTZXRzIHRoZSB2YWx1ZSBvZiBhIGNvbnZlbnRpb24gcHJvcGVydHkgKGZvciBzdG9yaW5nIGNvbnZlbnRpb24gY29uZmlndXJhdGlvbikKICAgICAgICAKICAgICAgICBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkgVGhlIHByb3BlcnR5IHRvIGdldCBvciBzZXQKICAgICAgICBAcGFyYW0ge29iamVjdH0gW3ZhbHVlXSBUaGUgdmFsdWUgdG8gc2V0CiAgICAgICAgQG1ldGhvZCBjb252ZW50aW9uCiAgICAgICAgQHJldHVybnMge09iamVjdH0gVGhlIHZhbGF1ZS4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAocHJvcGVydHksIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciB0YyA9IHRoaXMuY2FjaGU7CiAgICAgICAgICAgIGlmKHByb3BlcnR5LmluZGV4T2YoJ2NvbmZpZy4nKSA9PT0gMCkgewogICAgICAgICAgICAgICAgaWYodHlwZW9mIHRjW3Byb3BlcnR5XSA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgICAgICB0Y1twcm9wZXJ0eV0gPSB0aGlzLmdldFZhbHVlRnJvbVBhdGgocHJvcGVydHksIHRjKSB8fCBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0eXBlb2YgdmFsdWUgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICB0Y1twcm9wZXJ0eV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGNbcHJvcGVydHldOwogICAgICAgIH07CiAgICAgICAgTW9kdWxlLnByb3RvdHlwZS5nZXRWYWx1ZUZyb21QYXRoID0gZnVuY3Rpb24gKHBhdGgsIG9iamVjdCkgewogICAgICAgICAgICB2YXIgcGF0aHMgPSBwYXRoLnNwbGl0KCcuJyksIHYgPSBvYmplY3Q7CiAgICAgICAgICAgIF8uZWFjaChwYXRocywgZnVuY3Rpb24gKHApIHsKICAgICAgICAgICAgICAgIHYgPSB2ICYmIHZbcF07CiAgICAgICAgICAgICAgICBpZighdikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgIH07CiAgICAgICAgTW9kdWxlLnByb3RvdHlwZS50aHJ1c3RDcmVhdGUgPSAvKioKICAgICAgICBJbmplY3RzIHRoaXMgbW9kdWxlIGludG8gdGhlIGdpdmVuIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHRocnVzdENyZWF0ZQogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIHRocnVzdC5fX2luamVjdE1vZHVsZSh0aGlzKTsKICAgICAgICB9OwogICAgICAgIE1vZHVsZS5wcm90b3R5cGUudGhydXN0Q2FsbCA9IC8qKgogICAgICAgIE1ha2VzIGEgY2FsbCB0byBhbGwgdGhlIG1vZHVsZXMgZmFjYWRlcwogICAgICAgIFRoZSBvcmRlciBvZiB0aGUgY2FsbCBkZXBlbmRzIG9uIHRoZSBvcmRlciByZXF1aXJlZC4KICAgICAgICBEdXJpbmcgdGhlIHN0YXJ0dXAgc3RhZ2UgKGluaXQsIHN0YXJ0LCByZWFkeSkgZmFjYWRlcyBhcmUgY2FsbGVkIGZpcnN0LgogICAgICAgIER1cmluZyB0aGUgc2h1dGRvd24gc3RhdGUgKHN0b3AsIGRlc3Ryb3kpIGZhY2FkZXMgYXJlIGNhbGxlZCBsYXN0LgogICAgICAgIFRoaXMgYWxsb3dzIG1vZHVsZXMgdG8gc3RhcnR1cCBhbmQgc2h1dGRvd24gd2lsbCBhbGwgdGhlIHRvb2xzIGl0IGhhZCB0byBiZWdpbiB3aXRoLgogICAgICAgIAogICAgICAgIEBtZXRob2QgdGhydXN0Q2FsbAogICAgICAgIEBwcm90ZWN0ZWQKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbWV0aG9kIHRoZSBtZXRob2QgdG8gY2FsbAogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gZmFjYWRlQWZ0ZXIgY2FsbHMgZmFjYWRlIG1ldGhvZHMgYmVmb3JlIG9yIGFmdGVyIG1vZHVsZSBtZXRob2QuCiAgICAgICAgQHBhcmFtIHtBcnJheX0gYXJncyBBcmdzIHRvIGJlIHBhc3NlZCBvbnRvIHRoZSBtb2R1bGUgbWV0aG9kLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChtZXRob2QsIGZhY2FkZUFmdGVyLCBhcmdzKSB7CiAgICAgICAgICAgIHZhciBzZXEgPSBbXSwgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ3RocnVzdC9jYXBzdWxlOiBDYWxsaW5nIGZhY2FkZXMgZm9yICJ7MH0iJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHZhciBjYWNoZSA9IHRoaXMuY2FjaGUsIG0gPSBjYWNoZVttZXRob2RdOwogICAgICAgICAgICBzZXEucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gY2FsbEZhY2FkZU1ldGhvZHMobWV0aG9kLCBjYWNoZSk7CiAgICAgICAgICAgICAgICBpZihyZXN1bHQgJiYgcmVzdWx0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbChmbGF0dGVuVG9Qcm9taXNlcyhyZXN1bHQpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKG0pIHsKICAgICAgICAgICAgICAgIHNlcS5wdXNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gbS5hcHBseSh0aGF0Lmluc3RhbmNlLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICBpZihyZXN1bHQgJiYgcmVzdWx0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwoZmxhdHRlblRvUHJvbWlzZXMocmVzdWx0KSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoZmFjYWRlQWZ0ZXIpIHsKICAgICAgICAgICAgICAgIHNlcS5wdXNoKHNlcS5zaGlmdCgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gd2hlbi5zZXF1ZW5jZShzZXEpOwogICAgICAgIH07CiAgICAgICAgTW9kdWxlLnByb3RvdHlwZS5zdGFydCA9IC8qKgogICAgICAgIFN0YXJ0IHRoZSBtb2R1bGUsIGluc2lkZSB0aGUgdGhydXN0IGNvbnRhaW5lciBpdCB3YXMgY3JlYXRlZCBvbi4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHN0YXJ0CiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiB0aGF0LnRocnVzdC5zdGFydCh0aGF0Lm5hbWUpOwogICAgICAgIH07CiAgICAgICAgTW9kdWxlLnByb3RvdHlwZS5zdG9wID0gLyoqCiAgICAgICAgU3RvcCB0aGUgbW9kdWxlLCBpbnNpZGUgdGhlIHRocnVzdCBjb250YWluZXIgaXQgd2FzIGNyZWF0ZWQgb24uCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBzdGFydAogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gdGhhdC50aHJ1c3Quc3RvcCh0aGF0Lm5hbWUpOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIE1vZHVsZTsKICAgIH0pKCk7CiAgICBleHBvcnRzLk1vZHVsZSA9IE1vZHVsZTsgICAgCiAgICAvKioKICAgIEFNRCBBUEkKICAgIGxvYWQKICAgIAogICAgSGFuZGxlcyBmZXRjaGluZyBvZiBhIG1vZHVsZSBpbnN0YW5jZS4KICAgIEZvcm1hdDoKICAgIHRocnVzdC9jYXBzdWxlIXtpbnN0YW5jZX06e21vZHVsZU5hbWV9CiAgICAKICAgIEBtZXRob2QgbG9hZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlIHRoYXQgaXMgYmVpbmcgZmV0Y2hlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gcGFyZW50UmVxdWlyZSB0aGUgcmVxdWlyZSBtZXRob2QgdG8gYmUgbG9hZGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBsb2FkIEFsbG93cyB0aGUgbG9hZCB0byBpbmZvcm0gdGhhdCBBTUQgZm9yIHRoZSB2YWx1ZSB0byBoYW5kIG9mZgogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgY3VzdG9tIGNvbmZpZ3VyYXRpb24uCiAgICAqKi8KICAgIGZ1bmN0aW9uIGxvYWQobmFtZSwgcGFyZW50UmVxdWlyZSwgbG9hZCwgY29uZmlnKSB7CiAgICAgICAgdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgnOicpLCBpbnN0YW5jZU5hbWUgPSBwYXJ0c1swXSwgbW9kdWxlTmFtZSA9IHBhcnRzWzFdOwogICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAndGhydXN0IScgKyBpbnN0YW5jZU5hbWUKICAgICAgICBdLCBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIHZhciBtb2R1bGUgPSB0aHJ1c3QubW9kdWxlc1ttb2R1bGVOYW1lXTsKICAgICAgICAgICAgaWYoIW1vZHVsZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZvcm1hdCgnTW9kdWxlICJ7MH0iIGRvZXMgbm90IGV4aXN0IG9uIHRocnVzdCBpbnN0YW5jZSAiezF9Ii4nLCBtb2R1bGVOYW1lLCBpbnN0YW5jZU5hbWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsb2FkKG1vZHVsZSk7CiAgICAgICAgfSk7CiAgICB9CiAgICBleHBvcnRzLmxvYWQgPSBsb2FkOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jYXBzdWxlLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2luc3RhbmNlJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QvY2Fwc3VsZSddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXywgX19jYXBzdWxlX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9ImludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIC8qKgogICAgR2V0cyB0aGUgdGhydXN0IGluc3RhbmNlcy4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgICoqLwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgd2hlbiA9IHV0aWwud2hlbjsKICAgIHZhciBjYXBzdWxlID0gX19jYXBzdWxlX187CgogICAgLyoqCiAgICBUaGUgYXZhaWxhYmxlIHRocnVzdCBpbnN0YW5jZXMKICAgIGluZGV4IGJ5IG5hbWUKICAgIAogICAgQGZvciB0aHJ1c3QuaW5zdGFuY2UKICAgIEBwcm9wZXJ0eSBpbnN0YW5jZXMKICAgIEBwcml2YXRlCiAgICAqKi8KICAgIGV4cG9ydHMuaW5zdGFuY2VzID0gewogICAgfTsKICAgIC8qKgogICAgVGhlIGxvYWRpbmcgdGh1cnN0IGluc3RhbmNlcy4KICAgIGluZGV4IGJ5IG5hbWUKICAgIAogICAgQHByb3BlcnR5IGxvYWRpbmdJbnN0YW5jZXMKICAgIEBwcml2YXRlCiAgICAqKi8KICAgIGV4cG9ydHMubG9hZGluZ0luc3RhbmNlcyA9IHsKICAgIH07CiAgICAvKioKICAgIEdldHMgYSBuYW1lZCB0aHJ1c3Qgc3RhbmNlIGlmIGl0IGV4aXN0cy4KICAgIAogICAgQG1ldGhvZCBnZXRJbnN0YW5jZQogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIGluc3RhbmNlIG5hbWUKICAgIEByZXR1cm5zIHtUaHJ1c3R9IFRoZSB0aHJ1c3QgaW5zdGFuY2UKICAgICoqLwogICAgZnVuY3Rpb24gZ2V0SW5zdGFuY2UobmFtZSkgewogICAgICAgIHJldHVybiBleHBvcnRzLmluc3RhbmNlc1tuYW1lXSB8fCBudWxsOwogICAgfQogICAgZXhwb3J0cy5nZXRJbnN0YW5jZSA9IGdldEluc3RhbmNlOwogICAgLyoqCiAgICBGZXRjaHMgYSBuYW1lZCB0aHJ1c3Qgc3RhbmNlIGlmIGl0IGV4aXN0cy4KICAgIFRoaXMgbG9hZHMgYXN5bmNyb25vdXNseSwgYXMgdGhlIGluc3RhbmNlIG1heSBub3QgYmUgbG9hZGVkCiAgICAKICAgIEBtZXRob2QgZmV0Y2hJbnN0YW5jZQogICAgQHN0YXRpYwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBpbnN0YW5jZSBuYW1lCiAgICBAcmV0dXJucyB7UHJvbWlzZX0gVG8gYSB0aHJ1c3QgaW5zdGFuY2Ugc3BlYwogICAgKiovCiAgICBmdW5jdGlvbiBmZXRjaEluc3RhbmNlKG5hbWUpIHsKICAgICAgICB2YXIgZGVmZXIgPSBleHBvcnRzLmxvYWRpbmdJbnN0YW5jZXNbbmFtZV0gfHwgKGV4cG9ydHMubG9hZGluZ0luc3RhbmNlc1tuYW1lXSA9IHdoZW4uZGVmZXIoKSk7CiAgICAgICAgcmV0dXJuIGRlZmVyOwogICAgfQogICAgZXhwb3J0cy5mZXRjaEluc3RhbmNlID0gZmV0Y2hJbnN0YW5jZTsKICAgIC8qKgogICAgQ2xlYXJzIHRoZSBUaHJ1c3QgSW5zdGFuY2UgY2FjaGUsIHRoaXMgaXMgdXNlZCBmb3IgdW5pdCB0ZXN0aW5nLCBhbmQgY2xlYXJpbmcgYWxsIHRoZSBjYWNoZSBkYXRhIGVhY2ggcnVuLgogICAgCiAgICBAbWV0aG9kIGNsZWFyQ2FjaGUKICAgIEBzdGF0aWMKICAgIEBwcml2YXRlCiAgICAqKi8KICAgIGZ1bmN0aW9uIGNsZWFyQ2FjaGUoKSB7CiAgICAgICAgdXRpbC5fLmVhY2godXRpbC5fLmtleXMoZXhwb3J0cy5pbnN0YW5jZXMpLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICBleHBvcnRzLmluc3RhbmNlc1t4XSA9IG51bGw7CiAgICAgICAgICAgIGRlbGV0ZSBleHBvcnRzLmluc3RhbmNlc1t4XTsKICAgICAgICB9KTsKICAgICAgICB1dGlsLl8uZWFjaCh1dGlsLl8ua2V5cyhleHBvcnRzLmxvYWRpbmdJbnN0YW5jZXMpLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICBleHBvcnRzLmxvYWRpbmdJbnN0YW5jZXNbeF0gPSBudWxsOwogICAgICAgICAgICBkZWxldGUgZXhwb3J0cy5sb2FkaW5nSW5zdGFuY2VzW3hdOwogICAgICAgIH0pOwogICAgICAgIHV0aWwuXy5lYWNoKHV0aWwuXy5rZXlzKGNhcHN1bGUuTW9kdWxlLnRocnVzdENhY2hlKSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgY2Fwc3VsZS5Nb2R1bGUudGhydXN0Q2FjaGVbeF0gPSBudWxsOwogICAgICAgICAgICBkZWxldGUgY2Fwc3VsZS5Nb2R1bGUudGhydXN0Q2FjaGVbeF07CiAgICAgICAgfSk7CiAgICB9CiAgICBleHBvcnRzLmNsZWFyQ2FjaGUgPSBjbGVhckNhY2hlOwogICAgLyp9Ki8gfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9aW5zdGFuY2UuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvY29uZmlnJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICcuL2luc3RhbmNlJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdGhydXN0SW5zdGFuY2VfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgY29uZmlnIHsqLwogICAgCiAgICB2YXIgdGhydXN0SW5zdGFuY2UgPSBfX3RocnVzdEluc3RhbmNlX187CgogICAgLyoqCiAgICBQcm92aWRlcyB0aHJ1c3QgY29uZmlndXJhdGlvbgogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgQHN1Ym1vZHVsZSB0aHJ1c3QuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgVGhpcyBwcm9wZXJ0eSwgdGVsbHMgdGhlIGZyYW1ld29yayBpZiBpdCBzaG91bGQgdGhyb3cgZXJyb3JzIG9yIG5vdC4KICAgIEluIHByb2R1Y3Rpb24gaXQncyByZWNvbW1lbmRlZCBub3QgdG8gdGhyb3cgZXJyb3JzLCB0aGF0IHdheSBpZiBhIGNvbXBvbmVudCBmYWlscwogICAgdGhlcmUgaXMgYSBjaGFuY2UgdGhlIGFwcGxpY2F0aW9uIGNhbiBzdGlsbCByZWNvdmVyLgogICAgCiAgICBAZm9yIHRocnVzdC5jb25maWcKICAgIEBwcm9wZXJ0eSB0aHJvd0Vycm9ycwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgIEBkZWZhdWx0IGZhbHNlCiAgICAqKi8KICAgIGV4cG9ydHMudGhyb3dFcnJvcnMgPSB0cnVlOwogICAgLyoqCiAgICBUZWxscyB0aGUgZnJhbWV3b3JrIHRvIHJ1biBpbiBhc3luYyBtb2RlLCB0aGlzIG1heSBkZWxheSBzdGFydCB1cCwgYnV0IHdpbGwgbWFrZSBpbWFnZSBsb2FkaW5nIGFuZCBpbml0YWwgcnVubmluZyBhcHBlYXIgZmFzdGVyLgogICAgCiAgICBAcHJvcGVydHkgYXN5bmMKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAZGVmYXVsdCB0cnVlCiAgICAqKi8KICAgIGV4cG9ydHMuYXN5bmMgPSB0cnVlOwogICAgLyoqCiAgICBUZWxscyB0aHJ1c3QgdG8gZXhwb3NlIGVhY2ggaW5zdGFuY2UgYXMgYSBnbG9iYWwsIHRoaXMgYWxsb3dzIGxlZ2FjeSBjb21wb25lbnRzIHRvIHV0aWxpemUgcGFydHMgb2YgdGhydXN0LCBvciBlYXNpbHkKICAgIGdldCBhdCB5b3VyIHRocnVzdCBpbnN0YW5jZSBkdXJpbmcgZGVidWdnaW5nLgogICAgCiAgICBAcHJvcGVydHkgZXhwb3NlR2xvYmFscwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgIEBkZWZhdWx0IHRydWUKICAgICoqLwogICAgZXhwb3J0cy5leHBvc2VHbG9iYWxzID0gdHJ1ZTsKICAgIGV4cG9ydHMudXJsID0gewogICAgICAgIHBhdGg6IC8qKgogICAgICAgIFRoaXMgcHJvcGVydHksIGdpdmVzIHRoZSBmcmFtZXdvcmsgaXQncyBkZWZhdWx0IHBhdGgsIGlmIGRpZmZlcmVudCB0aGFuICcvJwogICAgICAgIAogICAgICAgIEBwcm9wZXJ0eSB1cmwucGF0aAogICAgICAgIEByZWFkT25seQogICAgICAgIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgQGRlZmF1bHQgIi8iCiAgICAgICAgKiovCiAgICAgICAgJy8nLAogICAgICAgIHRyYWRpdGlvbmFsRW5jb2Rpbmc6IC8qKgogICAgICAgIFRoaXMgcHJvcGVydHksIHRlbGxzIHRoZSBmcmFtZXdvcmsgaG93IGl0IHNob3VsZCBlbmNvZGUgYXJyYXkgZm9ybSBkYXRhLgogICAgICAgIEluIGdlbmVyYWwsIGZvciBBU1AuTkVUIGJhc2VkIGFwcGxpY2F0aW9ucywgdHJhZGl0aW9uYWwgc2hvdWxkIGJlIHRydWUuCiAgICAgICAgRm9yIFJ1YnkvUHl0aG9uIGJhc2VkIGFwcGxpY2F0aW9ucywgdGhpcyBzaG91bGQgYmUgZmFsc2UuCiAgICAgICAgCiAgICAgICAgQHByb3BlcnR5IHVybC50cmFkaXRpb25hbEVuY29kaW5nCiAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgQHR5cGUge0Jvb2xlYW59CiAgICAgICAgQGRlZmF1bHQgZmFsc2UKICAgICAgICAqKi8KICAgICAgICB0cnVlCiAgICB9OwogICAgZXhwb3J0cy5sb2cgPSB7CiAgICAgICAgbGV2ZWw6IC8qKgogICAgICAgIFRoaXMgbGVuZHMgdG8gdGhlIGxvZyBsZXZlbCBvZiB0aHJ1c3QuCiAgICAgICAgCiAgICAgICAgRVJST1I6IDEKICAgICAgICBXQVJOOiAyCiAgICAgICAgSU5GTzogMwogICAgICAgIERFQlVHOiA0CiAgICAgICAgCiAgICAgICAgQHByb3BlcnR5IGxvZy5sZXZlbAogICAgICAgIEByZWFkT25seQogICAgICAgIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgQGRlZmF1bHQgMQogICAgICAgICoqLwogICAgICAgIDQsCiAgICAgICAgZW5hYmxlZDogLyoqCiAgICAgICAgVGhpcyB0b2dnbGVzIGVuYWJsaW5nIG9uIG9yIG9mZi4KICAgICAgICAKICAgICAgICBAcHJvcGVydHkgbG9nLmVuYWJsZWQKICAgICAgICBAcmVhZE9ubHkKICAgICAgICBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICBAZGVmYXVsdCBmYWxzZQogICAgICAgICoqLwogICAgICAgIHRydWUKICAgIH07CiAgICAvKioKICAgIFBsdWdpbnMgZm9yIHRocnVzdCB0byBsb2FkLCBvdmVycmlkZSB3aXRoIHlvdXIgb3duIHNldCBpZiB5b3UgaGF2ZSBhIGRpZmZlcmVudCBzZXQuCiAgICAKICAgIEBwcm9wZXJ0eSBwbHVnaW5zCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtBcnJheX0KICAgICoqLwogICAgZXhwb3J0cy5wbHVnaW5zID0gW107CiAgICAvKioKICAgICogVGhlIHNldCBvZiBtb2R1bGVzIHRvIHByZWxvYWQgd2l0aCB0aGUgaW5pdGFsIHdpcmV1cCBvZiB0aGUgVGhydXN0IGluc3RhbmNlLgogICAgKgogICAgKiBBY2NlcHRzIHRoZSBtb2R1bGUgcGF0aCBhIHN0cmluZyBvciB0aGUgbW9kdWxlIGFzIGFuIG9iamVjdCBpbiB0aGUgZm9sbG93aW5nIGZvcm1hdC4KICAgICogICBXaGVyZSBhcmdzIHdpbGwgYmUgaGFuZGVkIG9mZiB0byB0aGUgbW9kdWxlIGxpZmUgY3ljbGUgbWV0aG9kcy4KICAgICoKICAgICogICAgewogICAgKiAgICAgICAgcGF0aDogJycsCiAgICAqICAgICAgICBhcmdzOiBbXQogICAgKiAgICB9CiAgICAqCiAgICAqIEBwcm9wZXJ0eSBtb2R1bGVzCiAgICAqIEByZWFkT25seQogICAgKiBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMubW9kdWxlcyA9IFtdOwogICAgLyoqCiAgICBVc2VkIGludGVybmFsbHkgYnkgdGhydXN0IHRvIGRldGVybWluZSBpZiB0aGUgbGlmZS1jeWNsZSBpcyBjb250cm9sbGVkIGJ5IHRocnVzdCwgb3IgYSBwYXJlbnQgaW5zdGFuY2UuCiAgICAKICAgIEBwcm9wZXJ0eSBjaGlsZEluc3RhbmNlCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtCb29sZWFufQogICAgKiovCiAgICBleHBvcnRzLmNoaWxkSW5zdGFuY2UgPSBmYWxzZTsKICAgIC8qKgogICAgVXNlZCBpbnRlcm5hbGx5IGJ5IHRocnVzdCB0byBkZXRlcm1pbmUgaWYgdGhydXN0IHNob3VsZCBjb250cm9sIHRoZSBsaWZlLWN5Y2xlLCBvciB0aGUgY29uc3VtZXIKICAgIAogICAgQHByb3BlcnR5IGF1dG9tYXRpY0xpZmVjeWNsZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgICoqLwogICAgZXhwb3J0cy5hdXRvbWF0aWNMaWZlY3ljbGUgPSB0cnVlOwogICAgLyoqCiAgICBVc2VkIGludGVybmFsbHkgYnkgdGhydXN0IHRvIGRldGVybWluIGlmIHRoZSB0aHJ1c3QgaW5zdGFuY2Ugc2hvdWxkIGF1dG9tYXRpY2FsbHkgc3RhcnQgdXBvbiBjcmVhdGlvbi4KICAgIAogICAgQHByb3BlcnR5IGF1dG9TdGFydAogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgICoqLwogICAgZXhwb3J0cy5hdXRvU3RhcnQgPSBmYWxzZTsKICAgIC8qKgogICAgRGVmaW5lIHRoZSBjb252ZW50aW9ucyB0aGF0IHVuaXF1ZSB0byB0aHJ1c3QsIHRoZXkgYXJlIG5vdCBzcGVjaWZpYyB0byBhbnkgb25lIHBsdWdpbi4KICAgIAogICAgQHByb3BlcnR5IGNvbnZlbnRpb25zCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtBcnJheX0KICAgICoqLwogICAgZXhwb3J0cy5jb252ZW50aW9ucyA9IFsKICAgICAgICAndGhydXN0L2NvbnZlbnRpb24vY29udGFpbmVyJywgCiAgICAgICAgJ3RocnVzdC9jb252ZW50aW9uL2F1dG9zdGFydCcsIAogICAgICAgICd0aHJ1c3QvY29udmVudGlvbi9kZXBlbmRlbnQubW9kdWxlcycKICAgIF07CiAgICAvKioKICAgIEFNRCBBUEkKICAgIGxvYWQKICAgIAogICAgSGFuZGxlcyBmZXRjaGluZyBvZiBhIGN1cnJlbnQgY29uZmlnIGZvciB0aGUgY3VycmVudCB0aHJ1c3QgaW5zdGFuY2UsIG9yIHRoZSBjb25maWcgb2YgdGhlIGdpdmVuIHBsdWdpbi4KICAgIEFkZGluZyB0aGUgOiBjaGFyYWN0ZXIgcmVxdWVzdHMgYSBzcGVjaWZpYyBjb25maWcgcGx1Z2luLgogICAgdGhydXN0L2NvbmZpZyFnbG9iYWwgPSB0aHJ1c3QhZ2xvYmFsOmNvbmZpZyA9IFRocnVzdCBpbnN0YW5jZSBjb25maWcgZnJvbSB0aGUgaW5zdGFuY2UgbmFtZWQgZ2xvYmFsLgogICAgCiAgICBAbWV0aG9kIGxvYWQKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZSB0aGF0IGlzIGJlaW5nIGZldGNoZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IHBhcmVudFJlcXVpcmUgdGhlIHJlcXVpcmUgbWV0aG9kIHRvIGJlIGxvYWRlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gbG9hZCBBbGxvd3MgdGhlIGxvYWQgdG8gaW5mb3JtIHRoYXQgQU1EIGZvciB0aGUgdmFsdWUgdG8gaGFuZCBvZmYKICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIGN1c3RvbSBjb25maWd1cmF0aW9uLgogICAgKiovCiAgICBmdW5jdGlvbiBsb2FkKG5hbWUsIHBhcmVudFJlcXVpcmUsIGxvYWQsIGNvbmZpZykgewogICAgICAgIHZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJzonKSwgcmVhbE5hbWUgPSBwYXJ0c1swXSwgcGx1Z2luTmFtZSA9IHBhcnRzWzFdIHx8IGZhbHNlOwogICAgICAgIHZhciBpbnN0YW5jZURlZmVycmVkID0gdGhydXN0SW5zdGFuY2UuZmV0Y2hJbnN0YW5jZShyZWFsTmFtZSk7CiAgICAgICAgaW5zdGFuY2VEZWZlcnJlZC5wcm9taXNlLnRoZW4oZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgdmFyIHBsdWdpbiA9IHBsdWdpbk5hbWUgJiYgY29udGV4dC5jZmdbcGx1Z2luTmFtZV0gfHwgY29udGV4dC5jb25maWc7CiAgICAgICAgICAgIGlmKCFwbHVnaW4pIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUGx1Z2luICInICsgcGx1Z2luTmFtZSArICciIGRvZXMgbm90IGV4aXN0IG9uIHRocnVzdCBpbnN0YW5jZSAiJyArIHJlYWxOYW1lICsgJyIuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbG9hZChwbHVnaW4pOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5sb2FkID0gbG9hZDsKICAgIC8qfSovIH0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWNvbmZpZy5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9sb2cnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJy4vY29uZmlnJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdENvbmZpZ19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICB2YXIgdENvbmZpZyA9IF9fdENvbmZpZ19fOwoKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgLyoqCiAgICBBIGJhc2ljIGxvZ2dlciBmb3IgdGhlIHRocnVzdCBmcmFtZXdvcmsuCiAgICBEaXNhYmxlcyBkZWJ1ZyBsb2dnaW5nIHdoZW4gdGhydXN0IGlzIG5vdCBpbiBkZWJ1ZyBtb2RlLgogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgCiAgICAqKi8KICAgIAogICAgLy8gTG9nIGxldmVscwogICAgdmFyIExFVkVMID0gewogICAgICAgIERFQlVHOiA0LAogICAgICAgIElORk86IDMsCiAgICAgICAgV0FSTjogMiwKICAgICAgICBFUlJPUjogMQogICAgfTsKICAgIC8vIERlY2xhcmUgb3VyIHZhcmlhYmxlcwogICAgICAgIHZhciBjb25zb2xlID0gd2luZG93LmNvbnNvbGUsIHRpbWVycyA9IHsKICAgIH0sIGNMb2cgPSAoY29uc29sZSAmJiBjb25zb2xlLmxvZykgfHwgZmFsc2UsIGNXYXJuID0gKGNvbnNvbGUgJiYgY29uc29sZS53YXJuKSB8fCBmYWxzZSwgY0luZm8gPSAoY29uc29sZSAmJiBjb25zb2xlLmluZm8pIHx8IGZhbHNlLCBjRXJyb3IgPSAoY29uc29sZSAmJiBjb25zb2xlLmVycm9yKSB8fCBmYWxzZSwgY1RpbWUgPSAoY29uc29sZSAmJiBjb25zb2xlWyd0aW1lJ10pIHx8IGZhbHNlLCBjVGltZUVuZCA9IChjb25zb2xlICYmIGNvbnNvbGVbJ3RpbWVFbmQnXSkgfHwgZmFsc2UsIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBjb25maWdMZXZlbCA9IHRDb25maWcubG9nLmxldmVsIHx8IExFVkVMLkVSUk9SLCBsb2dMZXZlbCA9IExFVkVMW2NvbmZpZ0xldmVsXSB8fCAodHlwZW9mIGNvbmZpZ0xldmVsID09PSAnc3RyaW5nJyAmJiBMRVZFTFtjb25maWdMZXZlbC50b1VwcGVyQ2FzZSgpXSkgfHwgKHR5cGVvZiBjb25maWdMZXZlbCA9PT0gJ251bWJlcicgJiYgY29uZmlnTGV2ZWwpIHx8IExFVkVMLkVSUk9SOwogICAgLy8gVmFyaW91cyBsb2dnZXJzIHRvIGhhbmRsZSBJRTgvOSBzdXBwb3J0LgogICAgdmFyIGxvZ1J1bm5lciA9IGZ1bmN0aW9uIChjb25zb2xlTWV0aG9kLCBsb2dUeXBlKSB7CiAgICAgICAgLy8gU2hvdyBsb2dzIHdoZW4gZW5hYmxlZCBvciBpZiB0aGV5IGFyZSBlcnJvcnMKICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICBpZihjb25zb2xlTWV0aG9kKSB7CiAgICAgICAgICAgIGlmKGNvbnNvbGVNZXRob2QuYXBwbHkpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGVNZXRob2QuYXBwbHkoY29uc29sZSwgYXJncyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zb2xlTWV0aG9kKGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmKCFjb25zb2xlTWV0aG9kICYmIGNMb2cpIHsKICAgICAgICAgICAgaWYoY0xvZy5hcHBseSkgewogICAgICAgICAgICAgICAgY0xvZy5hcHBseShjb25zb2xlLCBhcmdzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNMb2coYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAgLyoqCiAgICBBIGJhc2ljIGxvZ2dlciBmb3IgdGhlIHRocnVzdCBmcmFtZXdvcmsuCiAgICBEaXNhYmxlcyBkZWJ1ZyBsb2dnaW5nIHdoZW4gdGhydXN0IGlzIG5vdCBpbiBkZWJ1ZyBtb2RlLgogICAgCiAgICBAY2xhc3MgdGhydXN0LkxvZwogICAgKiovCiAgICAvKioKICAgIExvZ3MgYSBkZWJ1ZyB0eXBlIG1lc3NhZ2UgdXNpbmcgdGhlIGNvbnNvbGUgbG9nIG1ldGhvZAogICAgCiAgICBAbWV0aG9kIGRlYnVnCiAgICAqKi8KICAgIGZ1bmN0aW9uIGRlYnVnKCkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAwXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5ERUJVRykgewogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KGNMb2cpOwogICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncywgJ2xvZycpOwogICAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuZGVidWcgPSBkZWJ1ZzsKICAgIC8qKgogICAgTG9ncyBhIGluZm8gdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIGluZm8gbWV0aG9kIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGl0IHVzZXMgdGhlIGNvbnNvbGUgbG9nIG1ldGhvZC4KICAgIAogICAgQG1ldGhvZCBpbmZvCiAgICAqKi8KICAgIGZ1bmN0aW9uIGluZm8oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAwKTsgX2krKykgewogICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDBdOwogICAgICAgIH0KICAgICAgICAvLyBTaG9ydCBjaXJjdWl0IGlmIGxvZ2dpbmcgaXMgZGlzYWJsZWQuICBUaGlzIGlzIGFzIGNsb3NlIHRvIG5vb3AgYXMgd2UgY2FuIGdldCwgaW5jYXNlIHRoZXJlIGlzIGEgZGlyZWN0IHJlZmVyZW5jZSB0byB0aGlzIG1ldGhvZC4KICAgICAgICBpZighdENvbmZpZy5sb2cuZW5hYmxlZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKGxvZ0xldmVsID49IExFVkVMLklORk8pIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChjSW5mbyk7CiAgICAgICAgICAgIGxvZ1J1bm5lci5hcHBseSh0aGlzLCBhcmdzLCAnaW5mbycpOwogICAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuaW5mbyA9IGluZm87CiAgICAvKioKICAgIExvZ3MgYSB3YXJuIHR5cGUgbWVzc2FnZSB1c2luZyB0aGUgY29uc29sZSB3YXJuIG1ldGhvZCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBpdCB1c2VzIHRoZSBjb25zb2xlIGxvZyBtZXRob2QuCiAgICAKICAgIEBtZXRob2Qgd2FybgogICAgKiovCiAgICBmdW5jdGlvbiB3YXJuKCkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAwXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5XQVJOKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgICBhcmdzLnVuc2hpZnQoY1dhcm4pOwogICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncywgJ3dhcm4nKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLndhcm4gPSB3YXJuOwogICAgLyoqCiAgICBMb2dzIGEgZXJyb3IgdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIGVycm9yIG1ldGhvZCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBpdCB1c2VzIHRoZSBjb25zb2xlIGxvZyBtZXRob2QuCiAgICAKICAgIEBtZXRob2QgZXJyb3IKICAgICoqLwogICAgZnVuY3Rpb24gZXJyb3IoKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAwKTsgX2krKykgewogICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDBdOwogICAgICAgIH0KICAgICAgICAvLyBTaG9ydCBjaXJjdWl0IGlmIGxvZ2dpbmcgaXMgZGlzYWJsZWQuICBUaGlzIGlzIGFzIGNsb3NlIHRvIG5vb3AgYXMgd2UgY2FuIGdldCwgaW5jYXNlIHRoZXJlIGlzIGEgZGlyZWN0IHJlZmVyZW5jZSB0byB0aGlzIG1ldGhvZC4KICAgICAgICBpZighdENvbmZpZy5sb2cuZW5hYmxlZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKGxvZ0xldmVsID49IExFVkVMLkVSUk9SKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgICBhcmdzLnVuc2hpZnQoY0Vycm9yKTsKICAgICAgICAgICAgbG9nUnVubmVyLmFwcGx5KHRoaXMsIGFyZ3MsICdlcnJvcicpOwogICAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuZXJyb3IgPSBlcnJvcjsKICAgIC8qKgogICAgTG9ncyBhIHRpbWUgdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIHRpbWUgbWV0aG9kIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGl0IHVzZXMgdGhlIGNvbnNvbGUgbG9nIG1ldGhvZC4KICAgIAogICAgQG1ldGhvZCB0aW1lCiAgICAqKi8KICAgIGZ1bmN0aW9uIHRpbWUobWVzc2FnZSkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5ERUJVRykgewogICAgICAgICAgICB0aW1lcnNbbWVzc2FnZV0gPSB7CiAgICAgICAgICAgICAgICBzdGFydDogbmV3IERhdGUoKS5nZXRUaW1lKCkKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIG1zZyA9IHV0aWwuZm9ybWF0KCd7MH06IHRpbWVyIHN0YXJ0ZWQnLCBtZXNzYWdlKSwgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KG1zZyk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChjVGltZSk7CiAgICAgICAgICAgIGxvZ1J1bm5lci5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLnRpbWUgPSB0aW1lOwogICAgLyoqCiAgICBMb2dzIGEgdGltZUVuZCB0eXBlIG1lc3NhZ2UgdXNpbmcgdGhlIGNvbnNvbGUgdGltZUVuZCBtZXRob2QgaWYgYXZhaWxhYmxlLCBvdGhlcndpc2UgaXQgdXNlcyB0aGUgY29uc29sZSBsb2cgbWV0aG9kLgogICAgQ2F1c2VzIHRoZSB0aW1lciB0byBlbmQsIGZvciB0aGUgZ2l2ZW4gbWVzc2FnZS4KICAgIAogICAgQG1ldGhvZCB0aW1lRW5kCiAgICAqKi8KICAgIGZ1bmN0aW9uIHRpbWVFbmQobWVzc2FnZSkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5ERUJVRykgewogICAgICAgICAgICB0aW1lcnNbbWVzc2FnZV0uZW5kID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTsKICAgICAgICAgICAgdmFyIHRpbWUgPSB0aW1lcnNbbWVzc2FnZV0uZW5kIC0gdGltZXJzW21lc3NhZ2VdLnN0YXJ0LCBtc2cgPSB1dGlsLmZvcm1hdCgnezB9OiB7MX1tcycsIG1lc3NhZ2UsIHRpbWUpOwogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KG1zZyk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChjVGltZUVuZCk7CiAgICAgICAgICAgIGxvZ1J1bm5lci5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLnRpbWVFbmQgPSB0aW1lRW5kOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1sb2cuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvaWduaXRlJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICdtb2R1bGUnLCAndGhydXN0L3V0aWwnLCAnLi9jb25maWcnLCAnLi9jYXBzdWxlJywgJy4vaW5zdGFuY2UnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19yZXF1aXJlTW9kdWxlX18sIF9fdXRpbF9fLCBfX2NvbmZpZ19fLCBfX3RtX18sIF9faW5zdGFuY2VfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgcmVxdWlyZU1vZHVsZSA9IF9fcmVxdWlyZU1vZHVsZV9fOwoKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICAKICAgIHZhciBjb25maWcgPSBfX2NvbmZpZ19fOwoKICAgIHZhciB0bSA9IF9fdG1fXzsKCiAgICB2YXIgaW5zdGFuY2UgPSBfX2luc3RhbmNlX187CgogICAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBpc0FycmF5ID0gXy5pc0FycmF5LCB0b0FycmF5ID0gXy50b0FycmF5LCBpc0Z1bmN0aW9uID0gXy5pc0Z1bmN0aW9uLCBlYWNoID0gXy5lYWNoLCBtYXAgPSBfLm1hcCwgYW55ID0gXy5hbnksIGFsbCA9IF8uYWxsLCB3aGVuID0gdXRpbC53aGVuLCBleHRlbmQgPSBfLmV4dGVuZCwgZmxhdHRlbiA9IF8uZmxhdHRlbiwgcGx1Y2sgPSBfLnBsdWNrLCBpc09iamVjdCA9IF8uaXNPYmplY3QsIGtleXMgPSBfLmtleXMsIHVuaW9uID0gXy51bmlvbjsKICAgIC8qZnVuY3Rpb24gcmVjb25jaWxlQXJyYXlzKGNvbmZpZywgc2V0dGluZ3MsIHRvKQogICAgewogICAgdmFyIGtleXMgPSBfLmtleXMoY29uZmlnKTsKICAgIGlmIChzZXR0aW5ncykKICAgIHsKICAgIGtleXMgPSB1bmlvbihfLmtleXMoc2V0dGluZ3MpLCBrZXlzKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgIHNldHRpbmdzID0ge307CiAgICB9CiAgICBlYWNoKGtleXMsIGZ1bmN0aW9uIChpKQogICAgewogICAgdmFyIHggPSBzZXR0aW5nc1tpXSB8fCBjb25maWdbaV07CiAgICBpZiAoaXNBcnJheSh4KSkKICAgIHsKICAgIHRvW2ldID0gdG9BcnJheShzZXR0aW5nc1tpXSB8fCB0b1tpXSk7CiAgICB9CiAgICBlbHNlIGlmIChpc09iamVjdCh4KSAmJiAhaXNGdW5jdGlvbih4KSkKICAgIHsKICAgIHJlY29uY2lsZUFycmF5cyh4LCBudWxsLCB0b1tpXSk7CiAgICB9CiAgICB9KTsKICAgIH0qLwogICAgZnVuY3Rpb24gbWVyZ2VTZXR0aW5ncyhzZXR0aW5ncykgewogICAgICAgIGlmKChzZXR0aW5ncykuX19zZXR0aW5nc01lcmdlZCkgewogICAgICAgICAgICByZXR1cm4gc2V0dGluZ3M7CiAgICAgICAgfQogICAgICAgIHZhciByZXF1aXJlQ29uZmlnID0gcmVxdWlyZU1vZHVsZS5jb25maWcoKSwgcGx1Z2lucyA9IFsKICAgICAgICAgICAgJ3RocnVzdC9tZWRpYXRvcicKICAgICAgICBdLmNvbmNhdChzZXR0aW5ncy5wbHVnaW5zIHx8IHJlcXVpcmVDb25maWcucGx1Z2lucyB8fCBjb25maWcucGx1Z2lucyB8fCBbXSksIGNvbnZlbnRpb25zID0gW10uY29uY2F0KHNldHRpbmdzLmNvbnZlbnRpb25zIHx8IHJlcXVpcmVNb2R1bGUuY29uZmlnKCkuY29udmVudGlvbnMgfHwgY29uZmlnLnBsdWdpbnMgfHwgW10pOwogICAgICAgIHNldHRpbmdzID0gXy5tZXJnZSh7CiAgICAgICAgfSwgY29uZmlnLCByZXF1aXJlTW9kdWxlLmNvbmZpZygpLCBzZXR0aW5ncywgewogICAgICAgICAgICBfX3NldHRpbmdzTWVyZ2VkOiB0cnVlLAogICAgICAgICAgICBwbHVnaW5zOiBwbHVnaW5zLAogICAgICAgICAgICBjb252ZW50aW9uczogY29udmVudGlvbnMKICAgICAgICB9KTsKICAgICAgICBzZXR0aW5ncy5wbHVnaW5zID0gcGx1Z2luczsKICAgICAgICBzZXR0aW5ncy5jb252ZW50aW9ucyA9IGNvbnZlbnRpb25zOwogICAgICAgIHJldHVybiBzZXR0aW5nczsKICAgIH0KICAgIGV4cG9ydHMubWVyZ2VTZXR0aW5ncyA9IG1lcmdlU2V0dGluZ3M7CiAgICBmdW5jdGlvbiBmdXNlKHNldHRpbmdzKSB7CiAgICAgICAgdmFyIHBpcGUgPSBbXTsKICAgICAgICBzZXR0aW5ncyA9IG1lcmdlU2V0dGluZ3Moc2V0dGluZ3MpOwogICAgICAgIGlmKCFpbnN0YW5jZS5pbnN0YW5jZXNbc2V0dGluZ3MubmFtZV0pIHsKICAgICAgICAgICAgcGlwZS5wdXNoKHN0YWdlT25lKTsKICAgICAgICB9CiAgICAgICAgcGlwZS5wdXNoKHN0YWdlVHdvKTsKICAgICAgICBpZihzZXR0aW5ncy5tb2R1bGVzICYmIHNldHRpbmdzLm1vZHVsZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIHBpcGUucHVzaChzdGFnZVRocmVlKTsKICAgICAgICB9CiAgICAgICAgdmFyIHByb21pc2UgPSB3aGVuLnBpcGVsaW5lKHBpcGUsIHNldHRpbmdzKTsKICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgIH0KICAgIGV4cG9ydHMuZnVzZSA9IGZ1c2U7CiAgICAvKioKICAgIENvbnRydWN0cyBhIHdpcmUgc3BlYyBmb3IgdGhydXN0IHRvIGxhdW5jaCBmcm9tLgogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgKiovCiAgICAvKioKICAgIE1lcmdlcyBhIGFsbCB0aGUgcGx1Z2lucyBjb25maWd1cmF0aW9ucywgd2l0aCB0aGUgZGVmYXVsdCBjb25maWcsIGFuZCB0aGVuIGZpbmFsbHkgd2l0aAogICAgYW55IGN1c3RvbWl6ZWQgY29uZmlnIGZyb20gcmVxdWlyZWpzCiAgICAKICAgIEBtZXRob2Qgc3RhZ2VPbmUKICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGludHMgdG8gcGFzcyBvbnRvIHRoZSB0aHJ1c3QgaW5zdGFuY2UgYmVpbmcgY3JlYXRlZC4KICAgICoqLwogICAgZnVuY3Rpb24gc3RhZ2VPbmUoc2V0dGluZ3MpIHsKICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqLwogICAgICAgICAgICAgICAgdmFyIHBsdWdpbnMgPSBzZXR0aW5ncy5wbHVnaW5zLCByZXF1aXJlQ29uZmlnID0gcmVxdWlyZU1vZHVsZS5jb25maWcoKSwgZGVmZXIgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgc2V0dGluZ3MucGx1Z2lucyA9IHBsdWdpbnM7CiAgICAgICAgcmVxdWlyZShwbHVnaW5zLm1hcChmdW5jdGlvbiAoeCkgewogICAgICAgICAgICByZXR1cm4geDsKICAgICAgICB9KSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKICAgICAgICAgICAgcGx1Z2lucy5mb3JFYWNoKGZ1bmN0aW9uIChwbHVnaW4sIGkpIHsKICAgICAgICAgICAgICAgIHZhciBuYW1lID0gcGx1Z2luLnN1YnN0cmluZyhwbHVnaW4ubGFzdEluZGV4T2YoJy8nKSArIDEpLCBwbHVnaW5TZXR0aW5ncyA9IHNldHRpbmdzW25hbWVdIHx8IHsKICAgICAgICAgICAgICAgIH0sIHBsdWdpblJlcXVpcmVDb25maWcgPSByZXF1aXJlQ29uZmlnW25hbWVdIHx8IHsKICAgICAgICAgICAgICAgIH0sIHBsdWdpbkNsYXNzID0gYXJnc1tpXVthcmdzW2ldLmNsYXNzTmFtZV07CiAgICAgICAgICAgICAgICBpZighY29uZmlnW25hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgY29uZmlnW25hbWVdID0gXy5tZXJnZShwbHVnaW5DbGFzcy5jb25maWcsIHBsdWdpblJlcXVpcmVDb25maWcgfHwgewogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGNvbnZlbnRpb25zID0gW10uY29uY2F0KHBsdWdpblNldHRpbmdzLmNvbnZlbnRpb25zIHx8IHBsdWdpblJlcXVpcmVDb25maWcuY29udmVudGlvbnMgfHwgY29uZmlnW25hbWVdLmNvbnZlbnRpb25zIHx8IFtdKTsKICAgICAgICAgICAgICAgIHNldHRpbmdzW25hbWVdID0gXy5tZXJnZSh7CiAgICAgICAgICAgICAgICB9LCBjb25maWdbbmFtZV0sIHBsdWdpblNldHRpbmdzIHx8IHsKICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBjb252ZW50aW9uczogY29udmVudGlvbnMKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgc2V0dGluZ3NbbmFtZV0uY29udmVudGlvbnMgPSBjb252ZW50aW9uczsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRlZmVyLnJlc29sdmUoc2V0dGluZ3MpOwogICAgICAgIH0sIGRlZmVyLnJlamVjdCk7CiAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7CiAgICB9CiAgICBleHBvcnRzLnN0YWdlT25lID0gc3RhZ2VPbmU7CiAgICAvKioKICAgIENyZWF0ZXMgYSB0aHJ1c3QgaW5zdGFuY2UsIGZyb20gdGhlIGdpdmVuIHNldHRpbmdzLgogICAgSW5jbHVkaW5nIHRoZSBwbHVnaW5zLgogICAgCiAgICBAbWV0aG9kIHN0YWdlVHdvCiAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbnRzIHRvIHBhc3Mgb250byB0aGUgdGhydXN0IGluc3RhbmNlIGJlaW5nIGNyZWF0ZWQuCiAgICAqKi8KICAgIGZ1bmN0aW9uIHN0YWdlVHdvKHNldHRpbmdzKSB7CiAgICAgICAgLypqc2hpbnQgbG9vcGZ1bmM6dHJ1ZSAqLwogICAgICAgIC8vIEdldCB0aGUgY29uZmlndXJhdGlvbgogICAgICAgICAgICAgICAgdmFyIGxvY2FsQ29uZmlnID0gc2V0dGluZ3MsIGRlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgIC8vIE1lZGlhdG9yIGlzIGEgcmVxdWlyZWQgcGx1Z2luLCBpbmNsdWRlIGFsbCB0aGUgb3RoZXJzIGluIGFkZGl0aW9uIHRvIGl0LgogICAgICAgICAgICAgICAgdmFyIHBsdWdpbnMgPSBsb2NhbENvbmZpZy5wbHVnaW5zLCBtb2R1bGVzVG9Mb2FkID0gLy8gVGhlIG1vZHVsZXMgdG8gbG9hZAogICAgICAgIFtdLCB0aHJ1c3RDb252ZW50aW9ucyA9IHNldHRpbmdzLmNvbnZlbnRpb25zIHx8IFtdLCBtb2R1bGVzQ29uZmlndXJhdGlvbnMgPSAvLyBUaGUgbW9kdWxlIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgewogICAgICAgICAgICB0aHJ1c3Q6ICd0aHJ1c3QnCiAgICAgICAgfTsKICAgICAgICAvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBwbHVnaW5zLCBjcmVhdGluZyBhIHByb3BlciBkZXBlbmRhbmN5IGxpc3QuCiAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IHBsdWdpbnMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgIHZhciBwbHVnaW4gPSBwbHVnaW5zW2ldLCBuYW1lID0gcGx1Z2luLnN1YnN0cmluZyhwbHVnaW4ubGFzdEluZGV4T2YoJy8nKSArIDEpLCBwbHVnaW5Db25maWcgPSBsb2NhbENvbmZpZ1tuYW1lXTsKICAgICAgICAgICAgbW9kdWxlc1RvTG9hZC5wdXNoKHBsdWdpbik7CiAgICAgICAgICAgIG1vZHVsZXNUb0xvYWQucHVzaChwbHVnaW5Db25maWcgJiYgcGx1Z2luQ29uZmlnLmNvbnZlbnRpb25zIHx8IFtdKTsKICAgICAgICAgICAgbW9kdWxlc0NvbmZpZ3VyYXRpb25zW3BsdWdpbl0gPSBwbHVnaW5Db25maWc7CiAgICAgICAgfQogICAgICAgIC8vIE5hbWUgYW5kIGNmZyBhcmUgZGVmYXVsdCBwcm9wZXJ0aWVzIG9mIHRoZSBjb25maWd1cmF0aW9uIGNvbnRleHQKICAgICAgICAgICAgICAgIHZhciBvcmRlcmVkUGx1Z2lucyA9IFsKICAgICAgICAgICAgJ25hbWUnLCAKICAgICAgICAgICAgJ2NmZycKICAgICAgICBdLCByZWxvb3AgPSAvLyBXZSBsb29wIHRocm91Z2ggdW50aWwgYWxsIHRoZSBwbHVnaW5zIGFyZSBpbiBwcm9wZXIgb3JkZXIuCiAgICAgICAgdHJ1ZSwgaUxlbiA9IG1vZHVsZXNUb0xvYWQubGVuZ3RoLCBpID0gMDsKICAgICAgICAvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBwbHVnaW5zIHVudGlsIHdlIGhhdmUgYSBzZXQgdGhhdCB3aWxsIGxvYWQgaW4gcHJvcGVyIG9yZGVyLgogICAgICAgIHdoaWxlKGkgPCBpTGVuKSB7CiAgICAgICAgICAgIC8vIFRoZSBwbHVnaW4KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBsdWdpbiA9IG1vZHVsZXNUb0xvYWRbaV0sIG5hbWUgPSAvLyBUaGUgaW1wbGllZCBwbHVnaW4gbmFtZQogICAgICAgICAgICBwbHVnaW4uc3Vic3RyaW5nKHBsdWdpbi5sYXN0SW5kZXhPZignLycpICsgMSksIHBsdWdpbkNvbmZpZyA9IC8vIFRoZSBwbHVnaW5zIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgbG9jYWxDb25maWdbbmFtZV07CiAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSBwbHVnaW4gaGFzIHRvIHJlc29sdmUgYW55IG90aGVyIHBsdWdpbnMKICAgICAgICAgICAgaWYocGx1Z2luQ29uZmlnICYmIHBsdWdpbkNvbmZpZy5yZXNvbHZlICYmIHBsdWdpbkNvbmZpZy5yZXNvbHZlLmxlbmd0aCA+IDAgJiYgIWFsbChwbHVnaW5Db25maWcucmVzb2x2ZSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhbnkob3JkZXJlZFBsdWdpbnMsIGZ1bmN0aW9uICh6KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHggPT09IHogfHwgeCA9PT0gejsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KSkgewogICAgICAgICAgICAgICAgLy8gVGhlIG1vZHVsZXMgdG8gbG9hZC4KICAgICAgICAgICAgICAgIC8vIEFsc28gaW5jbHVkZXMgYW55IGNvbnZlbnRpb25zLgogICAgICAgICAgICAgICAgbW9kdWxlc1RvTG9hZC5wdXNoLmFwcGx5KG1vZHVsZXNUb0xvYWQsIG1vZHVsZXNUb0xvYWQuc3BsaWNlKGksIDIpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIHJlb3JkZXIgdGhlIHBsdWdpbgogICAgICAgICAgICAgICAgaSArPSAyOwogICAgICAgICAgICAgICAgb3JkZXJlZFBsdWdpbnMucHVzaChuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBUaGUgbW9kdWxlcyBjb25maWcKICAgICAgICB2YXIgbW9kdWxlcyA9IGxvY2FsQ29uZmlnLm1vZHVsZXMgfHwgW107CiAgICAgICAgLy8gVGhydXN0IGFuZCB0aHJ1c3QvY2Fwc3VsZSBhbHNvIG5lZWQgdG8gYmUgbG9hZGVkLgogICAgICAgIG1vZHVsZXNUb0xvYWQucHVzaC5hcHBseShtb2R1bGVzVG9Mb2FkLCBbCiAgICAgICAgICAgICd0aHJ1c3QnLCAKICAgICAgICAgICAgc2V0dGluZ3MuY29udmVudGlvbnMgfHwgW10KICAgICAgICBdKTsKICAgICAgICAvLyBGbGF0dGVuIHRoZSByZXN1bHRhbnQgYXJyYXkKICAgICAgICBtb2R1bGVzVG9Mb2FkID0gZmxhdHRlbihtb2R1bGVzVG9Mb2FkKTsKICAgICAgICAvLyBDcmVhdGUgdGhlIGNvbmZpZ3VyYXRpb24gc3BlYwogICAgICAgIHZhciBzcGVjID0gewogICAgICAgICAgICBuYW1lOiBsb2NhbENvbmZpZy5uYW1lIHx8ICdnbG9iYWwnLAogICAgICAgICAgICBjZmc6IGxvY2FsQ29uZmlnCiAgICAgICAgfTsKICAgICAgICAvLyBMb2FkIGV2ZXJ5dGhpbmcKICAgICAgICByZXF1aXJlKG1vZHVsZXNUb0xvYWQsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gR2V0IHJlYWR5IHRvIGxvb3AKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRQbHVnaW4gPSBudWxsLCBhbGxDb252ZW50aW9ucyA9IFtdOwogICAgICAgICAgICAvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBtb2R1bGVzIGJlaW5nIGxvYWRlZAogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBpTGVuID0gbW9kdWxlc1RvTG9hZC5sZW5ndGg7IGkgPCBpTGVuIC0gdGhydXN0Q29udmVudGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIC8vIEdldCBwbHVnaW4gYW5kIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGx1Z2luID0gbW9kdWxlc1RvTG9hZFtpXSwgbUNvbmZpZyA9IG1vZHVsZXNDb25maWd1cmF0aW9uc1twbHVnaW5dOwogICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgd2UgaGF2ZSBhIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICBpZihtQ29uZmlnKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTG9hZCBhIG5ldyBwbHVnaW4uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGx1Z2luT2JqZWN0ID0gYXJnc1tpXSwgbmFtZSA9IC8vIEdldCB0aGUgcGx1Z2luIG5hbWUKICAgICAgICAgICAgICAgICAgICBwbHVnaW4uc3Vic3RyaW5nKHBsdWdpbi5sYXN0SW5kZXhPZignLycpICsgMSksIHJlc29sdmVJdGVtcyA9IC8vIFJlc29sdmUgYWxsIHRoZSByZXF1aXJlZCBpdGVtcy4KICAgICAgICAgICAgICAgICAgICBtYXAobUNvbmZpZy5yZXNvbHZlLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3BlY1t4XTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB2YXIgcGx1Z2luQ2xhc3MgPSBwbHVnaW5PYmplY3RbcGx1Z2luT2JqZWN0LmNsYXNzTmFtZV07CiAgICAgICAgICAgICAgICAgICAgLy8gSW5zdGFudGlhdGUgdGhlIHBsdWdpbgogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRQbHVnaW4gPSBzcGVjW25hbWVdID0gdXRpbC5pbnN0YW50aWF0ZShwbHVnaW5DbGFzcywgcmVzb2x2ZUl0ZW1zKTsKICAgICAgICAgICAgICAgICAgICAvLyBTZXR1cCB0aGUgY29udmVudGlvbnMKICAgICAgICAgICAgICAgICAgICBjdXJyZW50UGx1Z2luLl9fY29udmVudGlvbnMgPSBbXTsKICAgICAgICAgICAgICAgIH0gZWxzZSAvLyBMb2FkIGFsbCB0aGUgY29udmVudGlvbnMKICAgICAgICAgICAgICAgIGlmKGN1cnJlbnRQbHVnaW4pIHsKICAgICAgICAgICAgICAgICAgICAvLyBMb2FkIHRoZSBjb252ZW50aW9ucyBpbnRvIHRoZSBwbHVnaW4KICAgICAgICAgICAgICAgICAgICBfLmZvck93bihhcmdzW2ldLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFBsdWdpbi5fX2NvbnZlbnRpb25zLnB1c2goeCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgLy8gTG9hZCB0aGUgY29udmVudGlvbnMgaW50byB0aGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgICAgICAgICAgICAgIF8uZm9yT3duKGFyZ3NbaV0sIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhbGxDb252ZW50aW9ucy5wdXNoKHgpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFRoZSBsYXN0IGN1cnJlbnQgcGx1Z2luLCB3aWxsIGFsd2F5cyBiZSB0aHJ1c3QuCiAgICAgICAgICAgIGN1cnJlbnRQbHVnaW4uX19jb252ZW50aW9ucyA9IGFsbENvbnZlbnRpb25zOwogICAgICAgICAgICB2YXIgdGhydXN0Q29udmVudGlvbkRlZmluaXRpb25zID0gYXJncy5zbGljZShtb2R1bGVzVG9Mb2FkLmxlbmd0aCAtIHRocnVzdENvbnZlbnRpb25zLmxlbmd0aCk7CiAgICAgICAgICAgIHRocnVzdENvbnZlbnRpb25EZWZpbml0aW9ucyA9IGZsYXR0ZW4obWFwKHRocnVzdENvbnZlbnRpb25EZWZpbml0aW9ucywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtYXAoeCwgZnVuY3Rpb24gKHopIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gejsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIGN1cnJlbnRQbHVnaW4uX190aHJ1c3RDb252ZW50aW9ucyA9IHRocnVzdENvbnZlbnRpb25EZWZpbml0aW9uczsKICAgICAgICAgICAgYWxsQ29udmVudGlvbnMucHVzaC5hcHBseShhbGxDb252ZW50aW9ucywgdGhydXN0Q29udmVudGlvbkRlZmluaXRpb25zKTsKICAgICAgICAgICAgLy8gRXh0ZW5kIHRocnVzdCB3aXRoIHRoZSBzcGVjCiAgICAgICAgICAgIGV4dGVuZChjdXJyZW50UGx1Z2luLCBzcGVjKTsKICAgICAgICAgICAgZGVmZXIucmVzb2x2ZShzcGVjKTsKICAgICAgICB9LCBkZWZlci5yZWplY3QpOwogICAgICAgIHJldHVybiBkZWZlci5wcm9taXNlOwogICAgfQogICAgZXhwb3J0cy5zdGFnZVR3byA9IHN0YWdlVHdvOwogICAgLyoqCiAgICBMb2FkcyB1cCB0aGUgZGVmYXVsdCBtb2R1bGVzIGFzIGluZGljYXRlZCB0byB0aHJ1c3QuCiAgICAKICAgIEBtZXRob2Qgc3RhZ2VUaHJlZQogICAgQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgVGhlIGNvbnRleHQgdG8gdXNlIHRvIGxvYWQgdGhlIG1vZHVsZXMuCiAgICAqKi8KICAgIGZ1bmN0aW9uIHN0YWdlVGhyZWUoY29udGV4dCkgewogICAgICAgIHZhciB0aHJ1c3QgPSBjb250ZXh0LnRocnVzdCwgZGVmZXIgPSB3aGVuLmRlZmVyKCksIG1vZHVsZXMgPSBjb250ZXh0LmNmZy5tb2R1bGVzOwogICAgICAgIG1vZHVsZXMgPSBfLmZpbHRlcihtb2R1bGVzLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICByZXR1cm4gIXRocnVzdC5tb2R1bGVzW3hdOwogICAgICAgIH0pOwogICAgICAgIHJlcXVpcmUobW9kdWxlcywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAwKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAwXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgTW9kdWxlID0gdG0uTW9kdWxlOwogICAgICAgICAgICAvLyBHZXQgdGhlIGRlZmluaXRpb25zCiAgICAgICAgICAgIHZhciBtb2R1bGVEZWZpbml0aW9ucyA9IGFyZ3M7CiAgICAgICAgICAgIC8vIExvb3Agb3ZlciBhbGwgdGhlIG1vZHVsZXMKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IG1vZHVsZXMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAvLyBHZXQgdGhlIG1vZHVsZSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vZCA9IG1vZHVsZXNbaV0sIGRlZmluaXRpb24gPSAvLyBHZXQgdGhlIGRlZmluaXRpb24KICAgICAgICAgICAgICAgIG1vZHVsZURlZmluaXRpb25zW2ldOwogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIHRoZSBpbnN0YW5jZQogICAgICAgICAgICAgICAgdmFyIG1vZHVsZUluc3RhbmNlID0gbmV3IE1vZHVsZSh0aHJ1c3QsIGRlZmluaXRpb24sIG1vZCk7CiAgICAgICAgICAgICAgICAvLyBJbmplY3QgaXQgaW50byB0aGUgdGhydXN0IGluc3RhbmNlCiAgICAgICAgICAgICAgICBtb2R1bGVJbnN0YW5jZS50aHJ1c3RDcmVhdGUodGhydXN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZlci5yZXNvbHZlKGNvbnRleHQpOwogICAgICAgIH0sIGRlZmVyLnJlamVjdCk7CiAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7CiAgICB9CiAgICBleHBvcnRzLnN0YWdlVGhyZWUgPSBzdGFnZVRocmVlOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1pZ25pdGUuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvbWFpbicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L3V0aWwnLCAnLi9sb2cnLCAnLi9pbnN0YW5jZScsICcuL2lnbml0ZScsICcuL2NhcHN1bGUnLCAnZG9tUmVhZHknLCAnaGFzJywgJ3RocnVzdC9jb25maWcnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX191dGlsX18sIF9fbG9nX18sIF9fdGhydXN0SW5zdGFuY2VfXywgX19pZ25pdGVTcGVjX18sIF9fbV9fLCBfX2RvbVJlYWR5X18sIF9faGFzX18sIF9fdENvbmZpZ19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSJpbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIAogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBsb2cgPSBfX2xvZ19fOwoKICAgIHZhciB0aHJ1c3RJbnN0YW5jZSA9IF9fdGhydXN0SW5zdGFuY2VfXzsKCiAgICB2YXIgaWduaXRlU3BlYyA9IF9faWduaXRlU3BlY19fOwoKICAgIHZhciBtID0gX19tX187CgogICAgdmFyIE1vZHVsZSA9IG0uTW9kdWxlOwogICAgdmFyIGRvbVJlYWR5ID0gX19kb21SZWFkeV9fOwoKICAgIHZhciBoYXMgPSBfX2hhc19fOwoKICAgIHZhciB0Q29uZmlnID0gX190Q29uZmlnX187CgogICAgZXhwb3J0cy5jbGFzc05hbWUgPSAnVGhydXN0JzsKICAgIC8qKgogICAgVGhlIHRocnVzdCBhcHBsaWNhdGlvbiEKICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgIEBtYWluIHRocnVzdAogICAgKiovCiAgICAgICAgdmFyIElOSVQgPSAnaW5pdCcsIFNUQVJUID0gJ3N0YXJ0JywgUkVBRFkgPSAncmVhZHknLCBTVE9QID0gJ3N0b3AnLCBERVNUUk9ZID0gJ2Rlc3Ryb3knLCBDT1VOVERPV04gPSAnY291bnRkb3duJywgSUdOSVRFID0gJ2lnbml0ZScsIE9SQklUID0gJ29yYml0JywgREVQTE9ZID0gJ2RlcGxveScsIERFT1JCSVQgPSAnZGVvcmJpdCcsIFNQTEFTSERPV04gPSAnc3BsYXNoZG93bicsIElOT1JCSVQgPSAnaW5PcmJpdCcsIG1lbW9pemUgPSBfLm1lbW9pemUsIGVhY2ggPSBfLmVhY2gsIG1hcCA9IF8ubWFwLCBleHRlbmQgPSBfLmV4dGVuZCwgd2hlbiA9IHV0aWwud2hlbiwgYmluZCA9IF8uYmluZCwgaXNBcnJheSA9IF8uaXNBcnJheSwgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsIHRvQXJyYXkgPSBfLnRvQXJyYXksIG1lcmdlID0gXy5tZXJnZSwgZmxhdHRlbiA9IF8uZmxhdHRlbiwgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIHJlc29sdmVNZXRob2RzID0gWwogICAgICAgIElOSVQsIAogICAgICAgIFNUQVJULCAKICAgICAgICBSRUFEWSwgCiAgICAgICAgU1RPUCwgCiAgICAgICAgREVTVFJPWQogICAgXSwgaW5zdGFuY2VzID0gdGhydXN0SW5zdGFuY2UuaW5zdGFuY2VzLCBsb2FkaW5nSW5zdGFuY2VzID0gdGhydXN0SW5zdGFuY2UubG9hZGluZ0luc3RhbmNlcywgc2FmZUludm9rZSA9IHV0aWwuc2FmZUludm9rZTsKICAgIC8vI3JlZ2lvbiBSdW5uZXIgRmFjdG9yaWVzCiAgICB2YXIgcnVuUnVubmVyRmFjdG9yeSA9IG1lbW9pemUoZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICAgIHZhciBjb252ZW50aW9uTWV0aG9kID0gKG1ldGhvZCA9PT0gU1RPUCAmJiBTVEFSVCkgfHwgKG1ldGhvZCA9PT0gREVTVFJPWSAmJiBJTklUKSB8fCBtZXRob2QsIGNvbnZlbnRpb25WYWx1ZSA9ICEobWV0aG9kID09PSBTVE9QIHx8IG1ldGhvZCA9PT0gREVTVFJPWSksIHVuc2V0UmVhZHkgPSBtZXRob2QgPT09IFNUT1AsIGNvbnZlbnRpb25DaGVjayA9IGNvbnZlbnRpb25NZXRob2QgIT09IG1ldGhvZCwgY29udmVudGlvbk5hbWUgPSBmb3JtYXQoJ3swfS1zdGF0dXMnLCBjb252ZW50aW9uTWV0aG9kKSwgcnVubmVyID0gcnVubmVyRmFjdG9yeShtZXRob2QsIGNvbnZlbnRpb25OYW1lLCBjb252ZW50aW9uVmFsdWUsIHVuc2V0UmVhZHkpLCBsb2dNZXNzYWdlID0gZm9ybWF0KCdUaHJ1c3Q6IHswfWluZyBtb2R1bGUgInt7MH19IiBmYWlsZWQhJywgbWV0aG9kKSwgcnVubmluZ01lc3NhZ2UgPSBmb3JtYXQoJ1RocnVzdDogUnVubmluZyB7MH0gZm9yIG1vZHVsZSAie3swfX0iLicsIG1ldGhvZCk7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChuYW1lcykgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCFpc0FycmF5KG5hbWVzKSkgewogICAgICAgICAgICAgICAgbmFtZXMgPSBbCiAgICAgICAgICAgICAgICAgICAgbmFtZXMKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFyZ3MsIHJlc3VsdHMgPSBbXTsKICAgICAgICAgICAgZWFjaChuYW1lcywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgICAgIGZhbHNlICYmIGxvZy5kZWJ1Zyhmb3JtYXQocnVubmluZ01lc3NhZ2UsIG5hbWUpKTsKICAgICAgICAgICAgICAgIHZhciBtb2QgPSB0aGF0Lm1vZHVsZXNbbmFtZV07CiAgICAgICAgICAgICAgICBpZighbW9kICYmICF0aGF0LmZhaWxlZE1vZHVsZXNbbmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICAvLyB0cnkgdG8gZmV0Y2ggdGhlIG1vZHVsZS4KICAgICAgICAgICAgICAgICAgICAvLyByZXR1cm5pbmcgdGhlIHByb3BlciBkZWZlciBpbiBpdCdzIHBsYWNlCiAgICAgICAgICAgICAgICAgICAgdmFyIGxvYWRlckRlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgICAgICAgICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAgICAgICAgICAgICBuYW1lCiAgICAgICAgICAgICAgICAgICAgXSwgZnVuY3Rpb24gKG1vZHVsZURlZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5jcmVhdGVNb2R1bGUobW9kdWxlRGVmbiAmJiBtb2R1bGVEZWZuLm5hbWUgfHwgbmFtZSwgbW9kdWxlRGVmbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBydW5SdW5uZXJGYWN0b3J5KG1ldGhvZCkuYXBwbHkodGhhdCwgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxlRGVmbi5uYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIF0uY29uY2F0KGFyZ3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2hlbi5jaGFpbih3aGVuLmFsbChmbGF0dGVuKHJlc3VsdCkpLCBsb2FkZXJEZWZlcik7CiAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmZhaWxlZE1vZHVsZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBsb2FkZXJEZWZlci5yZXNvbHZlKCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKGxvYWRlckRlZmVyLnByb21pc2UpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmKChjb252ZW50aW9uQ2hlY2sgJiYgbW9kLmNvbnZlbnRpb24oY29udmVudGlvbk5hbWUpKSB8fCAhbW9kLmNvbnZlbnRpb24oY29udmVudGlvbk5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoZmFsc2UgJiYgdENvbmZpZy50aHJvd0Vycm9ycykgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2gocnVubmVyKHRoYXQsIG5hbWUsIG1vZCwgYXJncykpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHJ1bm5lcih0aGF0LCBuYW1lLCBtb2QsIGFyZ3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmVycm9yKGZvcm1hdChsb2dNZXNzYWdlLCBuYW1lKSwgZSwgZS5zdGFjayk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0cy5sZW5ndGggJiYgcmVzdWx0czsKICAgICAgICB9OwogICAgfSk7CiAgICB2YXIgcnVubmVyRmFjdG9yeSA9IG1lbW9pemUoZnVuY3Rpb24gKG1ldGhvZCwgY29udmVudGlvbk5hbWUsIGNvbnZlbnRpb25WYWx1ZSwgdW5zZXRSZWFkeSkgewogICAgICAgIHZhciBldmVudE5hbWUgPSBmb3JtYXQoJ3RocnVzdC9tb2R1bGUvezB9JywgbWV0aG9kKSwgaW5mb0Zvcm1hdCA9IGZvcm1hdCgnVGhydXN0OiB7MH1pbmcgbW9kdWxlICJ7ezB9fSInLCBtZXRob2QuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBtZXRob2Quc3Vic3RyaW5nKDEpKSwgZGVidWdGb3JtYXQgPSBmb3JtYXQoJ1RocnVzdDogQ2FsbGluZyBtb2R1bGUgInt7MH19IiB7MH0oKScsIG1ldGhvZCksIGNvbXBBZnRlciA9IG1ldGhvZCA9PT0gU1RPUCB8fCBtZXRob2QgPT09IERFU1RST1kgfHwgZmFsc2U7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh0aGF0LCBuYW1lLCBtb2QsIGFyZ3MpIHsKICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmluZm8oZm9ybWF0KGluZm9Gb3JtYXQsIG5hbWUpKTsKICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdChjb252ZW50aW9uTmFtZSwgbmFtZSkpOwogICAgICAgICAgICByZXR1cm4gbW9kLnRocnVzdENhbGwobWV0aG9kLCBjb21wQWZ0ZXIsIF9fZ2V0TW9kdWxlQXJncyh0aGF0Lm5hbWUsIG5hbWUsIGFyZ3MpKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoYXQubWVkaWF0b3IgJiYgdGhhdC5tZWRpYXRvci5maXJlKGV2ZW50TmFtZSwgbmFtZSk7CiAgICAgICAgICAgICAgICBtb2QuY29udmVudGlvbihjb252ZW50aW9uTmFtZSwgY29udmVudGlvblZhbHVlKTsKICAgICAgICAgICAgICAgIGlmKHVuc2V0UmVhZHkpIHsKICAgICAgICAgICAgICAgICAgICBtb2QuY29udmVudGlvbihSRUFEWSArICctc3RhdHVzJywgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgfSk7CiAgICB2YXIgYWxsUnVubmVyRmFjdG9yeSA9IG1lbW9pemUoZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICAgIHZhciBpbmZvRm9ybWF0ID0gZm9ybWF0KCdUaHJ1c3Q6IHswfWluZyBhbGwgbW9kdWxlcy4uLiBbe3swfX1dJywgbWV0aG9kLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbWV0aG9kLnN1YnN0cmluZygxKSksIHBsdXJhbE5hbWUgPSBmb3JtYXQoJ3RocnVzdC9tb2R1bGUvYWxsL3swfScsIG1ldGhvZCksIGNoZWNrQXV0b1N0YXJ0ID0gbWV0aG9kID09PSBJTklUIHx8IG1ldGhvZCA9PT0gU1RBUlQgfHwgbWV0aG9kID09PSBSRUFEWTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHRoYXQpIHsKICAgICAgICAgICAgdGhhdC5tZWRpYXRvciAmJiB0aGF0Lm1lZGlhdG9yLmZpcmUocGx1cmFsTmFtZSk7CiAgICAgICAgICAgIHZhciBtb2R1bGVzID0gdGhhdC5tb2R1bGVzLCByZXN1bHRzID0gW107CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5pbmZvKGZvcm1hdChpbmZvRm9ybWF0LCBtYXAobW9kdWxlcywgZnVuY3Rpb24gKHgsIGkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB4LmNvbnZlbnRpb24oJ2F1dG9TdGFydCcpICYmIGk7CiAgICAgICAgICAgIH0pLmpvaW4oJywgJykpKTsKICAgICAgICAgICAgZWFjaChtb2R1bGVzLCBmdW5jdGlvbiAoeCwgaSkgewogICAgICAgICAgICAgICAgaWYoIWNoZWNrQXV0b1N0YXJ0IHx8IChjaGVja0F1dG9TdGFydCAmJiB4LmNvbnZlbnRpb24oJ2F1dG9TdGFydCcpKSkgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaCh0aGF0W21ldGhvZF0oaSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYodGhhdC5zdGFydGluZ01vZHVsZXMgJiYgY2hlY2tBdXRvU3RhcnQpIHsKICAgICAgICAgICAgICAgIGZhbHNlICYmIGxvZy5pbmZvKGZvcm1hdChpbmZvRm9ybWF0LCB0aGF0LnN0YXJ0aW5nTW9kdWxlcy5qb2luKCcsICcpKSk7CiAgICAgICAgICAgICAgICB0aGF0W21ldGhvZF0odGhhdC5zdGFydGluZ01vZHVsZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbChyZXN1bHRzKTsKICAgICAgICB9OwogICAgfSk7CiAgICBmdW5jdGlvbiBmaXJlVGhydXN0RXZlbnQodGhhdCwgZXZlbnQpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGF0Lm1lZGlhdG9yICYmIHRoYXQubWVkaWF0b3IuZmlyZShldmVudCk7CiAgICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIGNoaWxkcmVuQ2FsbE1ldGhvZCh0aGF0LCBtZXRob2QsIHN0b3BwaW5nKSB7CiAgICAgICAgdmFyIGl0ZW1zID0gW107CiAgICAgICAgZWFjaCh0aGF0LmNoaWxkcmVuLCBmdW5jdGlvbiAoY2hpbGQpIHsKICAgICAgICAgICAgaWYoc3RvcHBpbmcpIHsKICAgICAgICAgICAgICAgIGNoaWxkLl9fcHJldmlvdXNTdGF0ZSA9IGNoaWxkLnN0YXJ0ZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoY2hpbGQuY2ZnLmF1dG9TdGFydCB8fCAoIXN0b3BwaW5nICYmIGNoaWxkLl9fcHJldmlvdXNTdGF0ZSkgfHwgKHN0b3BwaW5nICYmIGNoaWxkLnN0YXJ0ZWQpKSB7CiAgICAgICAgICAgICAgICBpdGVtcy5wdXNoKGNoaWxkW21ldGhvZF0oZmFsc2UsIHRydWUpKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGlmKGl0ZW1zLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwoaXRlbXMpOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGZsYXR0ZW5XaXRoQXN5bmModGhhdCwgYXJyKSB7CiAgICAgICAgcmV0dXJuIHV0aWwuZmxhdHRlblRvUHJvbWlzZXMoYXJyLmNvbmNhdCh0aGF0LmNmZy5hc3luYyAmJiBbCiAgICAgICAgICAgIHdoZW4uZGVsYXkoMCkKICAgICAgICBdIHx8IFtdKSk7CiAgICB9CiAgICB2YXIgdGhydXN0TG9nRXZlbnQ7CiAgICBpZihmYWxzZSkgewogICAgICAgIHRocnVzdExvZ0V2ZW50ID0gZnVuY3Rpb24gKG1lc3NhZ2UsIG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGxvZy5kZWJ1Zyhmb3JtYXQuYXBwbHkoZm9ybWF0LCBbCiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZQogICAgICAgICAgICAgICAgXS5jb25jYXQodG9BcnJheShhcmd1bWVudHMpKSkpOwogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICB9IGVsc2UgewogICAgICAgIHRocnVzdExvZ0V2ZW50ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdXRpbC5ub29wOwogICAgICAgIH07CiAgICB9CiAgICB2YXIgdGhydXN0U2hvdWxkRXhlY3V0ZSA9IGZ1bmN0aW9uICh0aGF0LCBjYWxsZWRCeVBhcmVudCwgc3RvcHBpbmcpIHsKICAgICAgICBpZih0aGF0LnBhcmVudCAmJiB0aGF0LmNmZy5jaGlsZEluc3RhbmNlICYmICF0aGF0LnBhcmVudC5zdGFydGVkICYmICFjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICBsb2cud2Fybihmb3JtYXQoJ0Nhbm5vdCBleGVjdXRlIG9uIGNoaWxkIGluc3RhbmNlICJ7MH0iIHBhcmVudCBpbnN0YW5jZSAiezF9IiBtdXN0IGJlIHN0YXJ0ZWQgZmlyc3QuJywgdGhhdC5uYW1lLCB0aGF0LnBhcmVudC5uYW1lKSk7CiAgICAgICAgfQogICAgICAgIGlmKCFzdG9wcGluZyAmJiB0aGF0LnN0YXJ0ZWQgfHwgc3RvcHBpbmcgJiYgIXRoYXQuc3RhcnRlZCkgewogICAgICAgICAgICBsb2cud2Fybihmb3JtYXQoJ0Nhbm5vdCBzdGFydCB0aHJ1c3QgaW5zdGFuY2UgInswfSIgc2luY2UgaXQgYWxyZWFkeSBzdGFydGVkJywgdGhhdC5uYW1lKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgfTsKICAgIC8qKgogICAgR2V0cyB0aGUgbW9kdWxlcyBhcmd1bWVudHMgZnJvbSB0aGUgcmVnaXN0cmF0aW9ucy4KICAgIAogICAgSWYgb3JpZ2luYWwgYXJncyBjb250YWlucyBhbnl0aGluZyBpdCBpcyBwYXNzZWQgaW5zdGVhZCBvZiB0aGUgcmVnaXN0cmF0aW9ucy4KICAgIElmIHRoZSByZWdpc3RyYXRpb25zIGFyZSBpbiBwbGFjZSBpdCB3aWxsIHJldHVybiB0aGVtLgogICAgCiAgICBAbWV0aG9kIF9fZ2V0TW9kdWxlQXJncwogICAgQHN0YXRpYwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZU5hbWUgVGhlIHRocnVzdCBpbnN0YW5jZQogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG1vZHVsZSBuYW1lCiAgICBAcGFyYW0ge0FycmF5fSBvcmlnaW5hbEFyZ3MgVGhlIG9yaWdpbmFsIGFyZ3VtZW50cyBwYXNzZWQgaW50byB0aGUgY2FsbGluZyBtZXRob2QuCiAgICAqKi8KICAgIGZ1bmN0aW9uIF9fZ2V0TW9kdWxlQXJncyhpbnN0YW5jZU5hbWUsIG5hbWUsIG9yaWdpbmFsQXJncykgewogICAgICAgIHZhciBhcmdzID0gdG9BcnJheShvcmlnaW5hbEFyZ3MpOwogICAgICAgIGlmKGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiBhcmdzOwogICAgICAgIH0KICAgICAgICB2YXIgaW5zdGFuY2VSZWdpc3RyYXRpb25zID0gVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9uc1tpbnN0YW5jZU5hbWVdOwogICAgICAgIGlmKGluc3RhbmNlUmVnaXN0cmF0aW9ucyAmJiBpbnN0YW5jZVJlZ2lzdHJhdGlvbnNbbmFtZV0pIHsKICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlUmVnaXN0cmF0aW9uc1tuYW1lXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFyZ3M7CiAgICB9CiAgICAvLyNlbmRyZWdpb24KICAgIC8qKgogICAgVGhlIHByaW1hcnkgdGhydXN0IGNsYXNzLgogICAgCiAgICBAY2xhc3MgdGhydXN0LlRocnVzdAogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGlzIHRocnVzdCBpbnN0YW5jZQogICAgQHJldHVybnMge1RocnVzdH0KICAgICoqLwogICAgdmFyIFRocnVzdCA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gVGhydXN0KG5hbWUpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbnZlbnRpb25zID0gW107CiAgICAgICAgICAgIHRoaXMuX19jb252ZW50aW9uUGx1Y2tQcm9wZXJ0aWVzQ2FjaGUgPSBudWxsOwogICAgICAgICAgICB0aGlzLl9fdGhydXN0Q29udmVudGlvbnMgPSBbXTsKICAgICAgICAgICAgdGhpcy5jZmcgPSBtZXJnZSh0Q29uZmlnLCB7CiAgICAgICAgICAgICAgICBhdXRvU3RhcnQ6IGZhbHNlLAogICAgICAgICAgICAgICAgYXN5bmM6IGZhbHNlLAogICAgICAgICAgICAgICAgY2hpbGRJbnN0YW5jZTogZmFsc2UsCiAgICAgICAgICAgICAgICBhdXRvbWF0aWNMaWZlY3ljbGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuY29uZmlnID0gbWVyZ2UodENvbmZpZywgewogICAgICAgICAgICAgICAgYXV0b1N0YXJ0OiBmYWxzZSwKICAgICAgICAgICAgICAgIGFzeW5jOiBmYWxzZSwKICAgICAgICAgICAgICAgIGNoaWxkSW5zdGFuY2U6IGZhbHNlLAogICAgICAgICAgICAgICAgYXV0b21hdGljTGlmZWN5Y2xlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgICAgICB0aGlzLm1vZHVsZXMgPSB7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuZmFpbGVkTW9kdWxlcyA9IHsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5jaGlsZHJlbiA9IFtdOwogICAgICAgICAgICB0aGlzLnN0YXJ0ZWQgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9ucyA9IHsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuY3JlYXRlID0gLyoqCiAgICAgICAgQ3JlYXRlcyBhIG5ldyB0aHJ1c3QgbW9kdWxlLgogICAgICAgIAogICAgICAgIEBtZXRob2QgY3JlYXRlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHVuaXF1ZSBtb2R1bGUgbmFtZS4KICAgICAgICBAcGFyYW0ge09iamVjdH0gbW9kdWxlIFRoZSBtb2R1bGUgZGVmaW50aW9uLgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gcHJlQnVpbGQgSGFzIHRoaXMgbW9kdWxlIGJlZW4gcHJlYnVpbHQsIGluIG90aGVyIHdvcmRzIGhhcyBpdCBiZWVuIGNyZWF0ZWQsIGJ5IHdpcmUuanMgYW5kIG5lZWRzIHRvIGJlIGluamVjdGVkLgogICAgICAgIEByZXR1cm5zIHtNb2R1bGV9IFRoZSBuZXcgbW9kdWxlIGluc3RhbmNlLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lLCBtb2QsIHByZUJ1aWx0KSB7CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ1RocnVzdDogQ3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mICJ7MH0iJywgbmFtZSkpOwogICAgICAgICAgICB2YXIgb2xkTW9kdWxlLCB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYocHJlQnVpbHQpIHsKICAgICAgICAgICAgICAgIG9sZE1vZHVsZSA9IG1vZDsKICAgICAgICAgICAgICAgIG1vZCA9IG1vZC5pbnN0YW5jZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighcHJlQnVpbHQpIHsKICAgICAgICAgICAgICAgIG1vZCA9IG5ldyBtLk1vZHVsZSh0aGF0LCBtb2QsIG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbW9kID0gb2xkTW9kdWxlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE1vZHVsZXMgY2Fubm90IGhhdmUgZHVwbGljYXRlIG5hbWVzLCBjaG9vc2UgYSBuZXcgb25lLgogICAgICAgICAgICBpZih0aGF0Lm1vZHVsZXNbbW9kLm5hbWVdKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdEdXBsaWNhdGUgbW9kdWxlIG5hbWUgInswfSIuJywgbmFtZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIG0gaXMgdGhlIG1lZGlhdG9ycyBpbnRlcm5hbCBtb2R1bGUuCiAgICAgICAgICAgIHRoYXQubW9kdWxlc1ttb2QubmFtZV0gPSBtb2Q7CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5pbmZvKGZvcm1hdCgnVGhydXN0OiBDcmVhdGVkIG1vZHVsZSAiezB9IicsIG5hbWUpKTsKICAgICAgICAgICAgLy8gTm90aWZ5IHRoZSBtZWRpYXRvciB0aGF0IGEgbW9kdWxlIGhhcyBiZWVuIGNyZWF0ZWQuCiAgICAgICAgICAgIHRoYXQubWVkaWF0b3IuZmlyZSgndGhydXN0L21vZHVsZS9jcmVhdGUnLCBuYW1lKTsKICAgICAgICAgICAgaWYodGhhdCAmJiB0aGF0LnN0YXJ0ZWQgJiYgbW9kLmNvbnZlbnRpb24oJ2F1dG9TdGFydCcpKSB7CiAgICAgICAgICAgICAgICB0aGF0LnN0YXJ0KG1vZC5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbW9kOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5zdGFydHVwID0gLy8jcmVnaW9uIEdsb2JhbCBSdW5uZXJzCiAgICAgICAgZnVuY3Rpb24gKGV2ZW50LCBldmVudFR5cGUpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHdoZW4uYWxsKGZsYXR0ZW5XaXRoQXN5bmModGhhdCwgWwogICAgICAgICAgICAgICAgc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIGV2ZW50LCB0aGF0KSwgCiAgICAgICAgICAgICAgICB0aGF0W2V2ZW50VHlwZV0oKSwgCiAgICAgICAgICAgICAgICBjaGlsZHJlbkNhbGxNZXRob2QodGhhdCwgZXZlbnQpCiAgICAgICAgICAgIF0pKTsKICAgICAgICAgICAgd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgcHJvbWlzZQogICAgICAgICAgICBdKS50aGVuKGZpcmVUaHJ1c3RFdmVudCh0aGF0LCAndGhydXN0LycgKyBldmVudFR5cGUpKTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLl9jb3VudGRvd24gPSBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmYWxzZSAmJiB0aHJ1c3RMb2dFdmVudCgnTGF1bmNoIGluc3RhbmNlICJ7MH0iIGluIDUuLi4gNC4uLiAzLi4uIDIuLi4gMS4uLicsIHRoYXQubmFtZSk7CiAgICAgICAgICAgIHZhciBwcm9taXNlID0gdGhpcy5zdGFydHVwKENPVU5URE9XTiwgSU5JVCk7CiAgICAgICAgICAgIGZhbHNlICYmIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbih0aHJ1c3RMb2dFdmVudCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGhhcyBiZWVuIGluaXRhbGl6ZWQuJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5jb3VudGRvd24gPSAvKioKICAgICAgICBCZWdpbnMgdGhlIGNvdW50ZG93biB0byB0aHJ1c3RzIHN0YXJ0LgogICAgICAgIExvYWRpbmcgY2FuIGJlIGRlZmVycmVkIGJ5IHJldHVybmluZyBhIHByb21pc2UgZnJvbSBhbnkgY29udmVudGlvbiwgb3IgbW9kdWxlIG1ldGhvZC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGNvdW50ZG93bgogICAgICAgIEBhc3luYwogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBvZiB3aGVuIHRoZSBjb3VudGRvd24gaXMgY29tcGxldGVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCF0aHJ1c3RTaG91bGRFeGVjdXRlKHRoYXQsIGNhbGxlZEJ5UGFyZW50KSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoYXQuY2ZnLmF1dG9tYXRpY0xpZmVjeWNsZSAmJiAoIXRoYXQuY2ZnLmNoaWxkSW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gVGhydXN0LmxhdW5jaFNlcXVlbmNlKHRoYXQsIGNhbGxlZEJ5UGFyZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhhdC5fY291bnRkb3duKGNhbGxlZEJ5UGFyZW50KTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuaWduaXRlID0gLyoqCiAgICAgICAgQmVnaW5zIHRoZSBpbmdpdGlvbiBhcyB0aHJ1c3Qgc3RhcnRzIHVwLgogICAgICAgIExvYWRpbmcgY2FuIGJlIGRlZmVycmVkIGJ5IHJldHVybmluZyBhIHByb21pc2UgZnJvbSBhbnkgY29udmVudGlvbiwgb3IgbW9kdWxlIG1ldGhvZC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGlnbml0ZQogICAgICAgIEBhc3luYwogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBvZiB3aGVuIHRoZSBpbmdpdGlvbiBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYoIXRocnVzdFNob3VsZEV4ZWN1dGUodGhhdCwgY2FsbGVkQnlQYXJlbnQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmFsc2UgJiYgdGhydXN0TG9nRXZlbnQoJ0ZpcmluZyByb2NrZXRzIGZvciB0aHVyc3QgaW5zdGFuY2UgInswfSIuJywgdGhhdC5uYW1lKTsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB0aGlzLnN0YXJ0dXAoSUdOSVRFLCBTVEFSVCk7CiAgICAgICAgICAgIGZhbHNlICYmIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbih0aHJ1c3RMb2dFdmVudCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGhhcyBiZWVuIHN0YXJ0ZWQuJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5vcmJpdCA9IC8qKgogICAgICAgIFRocnVzdCBwcmVwYXJlcyBmb3Igb3JiaXQuCiAgICAgICAgTG9hZGluZyBjYW4gYmUgZGVmZXJyZWQgYnkgcmV0dXJuaW5nIGEgcHJvbWlzZSBmcm9tIGFueSBjb252ZW50aW9uLgogICAgICAgIAogICAgICAgIEBtZXRob2Qgb3JiaXQKICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aHJ1c3QgaXMgaW4gb3JiaXQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYoIXRocnVzdFNob3VsZEV4ZWN1dGUodGhhdCwgY2FsbGVkQnlQYXJlbnQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmFsc2UgJiYgdGhydXN0TG9nRXZlbnQoJ0ZpcmluZyBzdGFnZSB0d28gdGhydXN0ZXJzIGZvciB0aHJ1c3QgaW5zdGFuY2UgInswfSIuJywgdGhhdC5uYW1lKSgpOwogICAgICAgICAgICB2YXIgZG9tUmVhZHlEZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgZG9tUmVhZHlEZWZlci5wcm9taXNlLnRoZW4oZmlyZVRocnVzdEV2ZW50KHRoYXQsICd0aHJ1c3QvZG9tL3JlYWR5JykpOwogICAgICAgICAgICBkb21SZWFkeShkb21SZWFkeURlZmVyLnJlc29sdmUpOwogICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHdoZW4uYWxsKGZsYXR0ZW5XaXRoQXN5bmModGhhdCwgWwogICAgICAgICAgICAgICAgZG9tUmVhZHlEZWZlci5wcm9taXNlLCAKICAgICAgICAgICAgICAgIHNhZmVJbnZva2UodGhhdC5fX2NvbnZlbnRpb25zLCBPUkJJVCwgdGhhdCksIAogICAgICAgICAgICAgICAgY2hpbGRyZW5DYWxsTWV0aG9kKHRoYXQsIE9SQklUKQogICAgICAgICAgICBdKSk7CiAgICAgICAgICAgIGZhbHNlICYmIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbih0aHJ1c3RMb2dFdmVudCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGlzIGFsbW9zdCByZWFkeS4nLCB0aGF0Lm5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLmRlcGxveSA9IC8qKgogICAgICAgIFRocnVzdCBkZXBsb3lzIGNvbXBvbmVudHMgaW4gb3JiaXQKICAgICAgICBMb2FkaW5nIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IG1vZHVsZSBtZXRob2QuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBkZXBsb3kKICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aHJ1c3QgaGFzIGZ1bGx5IGRlcGxveWVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCF0aHJ1c3RTaG91bGRFeGVjdXRlKHRoYXQsIGNhbGxlZEJ5UGFyZW50KSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGZhbHNlKSB7CiAgICAgICAgICAgICAgICB2YXIgdGltZVN0YXJ0ID0gdGhhdC5jb25maWcuZGVidWcudGltZVN0YXJ0LCB0aW1lRW5kID0gbmV3IERhdGUoKS5nZXRUaW1lKCksIHN0YXJ0VGltZSA9ICh0aW1lRW5kIC0gdGltZVN0YXJ0KSwgdHRvRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3R0bycpOwogICAgICAgICAgICAgICAgaWYodHRvRGl2KSB7CiAgICAgICAgICAgICAgICAgICAgdHRvRGl2LmlubmVySFRNTCA9IHN0YXJ0VGltZSArICdtcyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByb21pc2UgPSB3aGVuLmFsbChmbGF0dGVuV2l0aEFzeW5jKHRoYXQsIFsKICAgICAgICAgICAgICAgIHRoYXQucmVhZHkoKSwgCiAgICAgICAgICAgICAgICBjaGlsZHJlbkNhbGxNZXRob2QodGhhdCwgREVQTE9ZKQogICAgICAgICAgICBdKSkudGhlbihmaXJlVGhydXN0RXZlbnQodGhhdCwgJ3RocnVzdC9yZWFkeScpKTsKICAgICAgICAgICAgZmFsc2UgJiYgd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgcHJvbWlzZQogICAgICAgICAgICBdKS50aGVuKHRocnVzdExvZ0V2ZW50KCdUaHJ1c3QgaW5zdGFuY2UgInswfSIgaXMgbm93IHJlYWR5LicsIHRoYXQubmFtZSkpOwogICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuaW5PcmJpdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB0aGF0LnN0YXJ0ZWQgPSB0cnVlOwogICAgICAgICAgICBjaGlsZHJlbkNhbGxNZXRob2QodGhhdCwgSU5PUkJJVCk7CiAgICAgICAgICAgIGlmKGZhbHNlKSB7CiAgICAgICAgICAgICAgICB2YXIgdGltZVN0YXJ0ID0gdGhhdC5jb25maWcuZGVidWcudGltZVN0YXJ0LCB0aW1lRW5kID0gbmV3IERhdGUoKS5nZXRUaW1lKCksIHN0YXJ0VGltZSA9ICh0aW1lRW5kIC0gdGltZVN0YXJ0KTsKICAgICAgICAgICAgICAgIGxvZy5pbmZvKCdTdGFydGVkIGluICcgKyBzdGFydFRpbWUgKyAnbXMnKTsKICAgICAgICAgICAgICAgIHZhciB0dHJEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndHRyJyk7CiAgICAgICAgICAgICAgICBpZih0dHJEaXYpIHsKICAgICAgICAgICAgICAgICAgICB0dHJEaXYuaW5uZXJIVE1MID0gc3RhcnRUaW1lICsgJ21zJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5zaHV0ZG93biA9IGZ1bmN0aW9uIChldmVudCwgZXZlbnRUeXBlKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB3aGVuLmFsbChmbGF0dGVuV2l0aEFzeW5jKHRoYXQsIFsKICAgICAgICAgICAgICAgIGNoaWxkcmVuQ2FsbE1ldGhvZCh0aGF0LCBldmVudCwgdHJ1ZSksIAogICAgICAgICAgICAgICAgdGhhdFtldmVudFR5cGVdKCksIAogICAgICAgICAgICAgICAgc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIGV2ZW50LCB0aGF0KQogICAgICAgICAgICBdKSk7CiAgICAgICAgICAgIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbihmaXJlVGhydXN0RXZlbnQodGhhdCwgJ3RocnVzdC8nICsgZXZlbnRUeXBlKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5fZGVvcmJpdCA9IGZ1bmN0aW9uIChjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCF0aHJ1c3RTaG91bGRFeGVjdXRlKHRoYXQsIGNhbGxlZEJ5UGFyZW50LCB0cnVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZhbHNlICYmIHRocnVzdExvZ0V2ZW50KCdSZWVudGVyaW5nIGVhcnRocyBhdG1vc3BoZXJlIGZvciB0aHJ1c3QgaW5zdGFuY2UgInswfSIuJywgdGhhdC5uYW1lKTsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB0aGlzLnNodXRkb3duKERFT1JCSVQsIFNUT1ApOwogICAgICAgICAgICBmYWxzZSAmJiB3aGVuLmFueShbCiAgICAgICAgICAgICAgICBwcm9taXNlCiAgICAgICAgICAgIF0pLnRoZW4odGhydXN0TG9nRXZlbnQoJ1RocnVzdCBpbnN0YW5jZSAiezB9IiBpcyBub3cgc3RvcHBlZC4nLCB0aGF0Lm5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLmRlb3JiaXQgPSAvKioKICAgICAgICBCZWdpbnMgdGhlIGRlb3JiaXQgYXMgdGhydXN0IHNodXRkb3duLgogICAgICAgIFNodXRkb3duIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24sIG9yIG1vZHVsZSBtZXRob2QuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBkZW9yYml0CiAgICAgICAgQGFzeW5jCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIG9mIHdoZW4gdGhlIGluZ2l0aW9uIGlzIGNvbXBsZXRlZC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCwgdHJ1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aGF0LmNmZy5hdXRvbWF0aWNMaWZlY3ljbGUgJiYgKCF0aGF0LmNmZy5jaGlsZEluc3RhbmNlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4uc2VxdWVuY2UoWwogICAgICAgICAgICAgICAgICAgIF8uYmluZCh0aGF0Ll9kZW9yYml0LCB0aGF0KSwgCiAgICAgICAgICAgICAgICAgICAgXy5iaW5kKHRoYXQuc3BsYXNoZG93biwgdGhhdCkKICAgICAgICAgICAgICAgIF0sIGNhbGxlZEJ5UGFyZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhhdC5fZGVvcmJpdChjYWxsZWRCeVBhcmVudCk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLnNwbGFzaGRvd24gPSAvKioKICAgICAgICBCZWdpbnMgdGhlIHNwbGFzaGRvd24gYXMgdGhydXN0IHNodXRkb3duLgogICAgICAgIFNodXRkb3duIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24sIG9yIG1vZHVsZSBtZXRob2QuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBzcGxhc2hkb3duCiAgICAgICAgQGFzeW5jCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIG9mIHdoZW4gdGhlIGluZ2l0aW9uIGlzIGNvbXBsZXRlZC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCwgdHJ1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmYWxzZSAmJiB0aHJ1c3RMb2dFdmVudCgnTGFuZGluZyBpbiB0aGUgbWlkZGxlIG9mIHRoZSBhdGxhbnRpYyBmb3IgdGhydXN0IGluc3RhbmNlICJ7MH0iLicsIHRoYXQubmFtZSk7CiAgICAgICAgICAgIHZhciBwcm9taXNlID0gdGhpcy5zaHV0ZG93bihTUExBU0hET1dOLCBERVNUUk9ZKTsKICAgICAgICAgICAgZmFsc2UgJiYgd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgcHJvbWlzZQogICAgICAgICAgICBdKS50aGVuKHRocnVzdExvZ0V2ZW50KCdUaHJ1c3QgaW5zdGFuY2UgInswfSIgaXMgbm93IGJlaW5nIGRlc3Ryb3llZCcsIHRoYXQubmFtZSkpOwogICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhhdC5zdGFydGVkID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUubW9kdWxlTWV0aG9kID0gZnVuY3Rpb24gKG1ldGhvZCwgbmFtZSwgYXJncywgcmV2ZXJzZSwgZGVwZW5kZW50TWV0aG9kcywgc3RhcnRlZE1ldGhvZHMpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBwaXBlID0gW107CiAgICAgICAgICAgIGlmKCFuYW1lKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gYWxsUnVubmVyRmFjdG9yeShtZXRob2QpKHRoYXQpOwogICAgICAgICAgICAgICAgaWYocmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmFtZXMgPSBbXTsKICAgICAgICAgICAgaWYoIWlzQXJyYXkobmFtZSkpIHsKICAgICAgICAgICAgICAgIG5hbWVzID0gWwogICAgICAgICAgICAgICAgICAgIG5hbWUKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuYW1lcyA9IChuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihkZXBlbmRlbnRNZXRob2RzICYmIGRlcGVuZGVudE1ldGhvZHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB2YXIgaXRlbXMgPSB7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IG5hbWVzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBuID0gbmFtZXNbaV0sIG1vZCA9IHRoYXQubW9kdWxlc1tuXTsKICAgICAgICAgICAgICAgICAgICBlYWNoKGRlcGVuZGVudE1ldGhvZHMsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFpdGVtc1t4XSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNbeF0gPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZighcmV2ZXJzZSAmJiAoIW1vZCB8fCAhbW9kLmNvbnZlbnRpb24oeCArICctc3RhdHVzJykpIHx8IChyZXZlcnNlICYmIG1vZC5jb252ZW50aW9uKHggKyAnLXN0YXR1cycpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNbeF0ucHVzaChuKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWFjaChkZXBlbmRlbnRNZXRob2RzLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgIGlmKGl0ZW1zW3hdICYmIGl0ZW1zW3hdLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBwaXBlLnB1c2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGZsYXR0ZW4odGhhdFt4XS5hcHBseSh0aGF0LCBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNbeF0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0uY29uY2F0KGFyZ3MpKSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwaXBlLnB1c2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGZsYXR0ZW4ocnVuUnVubmVyRmFjdG9yeShtZXRob2QpLmFwcGx5KHRoYXQsIFsKICAgICAgICAgICAgICAgICAgICBuYW1lcwogICAgICAgICAgICAgICAgXS5jb25jYXQoYXJncykpKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZih0aGF0LnN0YXJ0ZWQgJiYgc3RhcnRlZE1ldGhvZHMgJiYgc3RhcnRlZE1ldGhvZHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBlYWNoKHN0YXJ0ZWRNZXRob2RzLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgIHBpcGUucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbChmbGF0dGVuKHRoYXRbeF0uYXBwbHkodGhhdCwgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZXMKICAgICAgICAgICAgICAgICAgICAgICAgXS5jb25jYXQoYXJncykpKSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gd2hlbi5waXBlbGluZShwaXBlKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgcmV0dXJuIHRoYXQubW9kdWxlTWV0aG9kKElOSVQsIG5hbWUsIGFyZ3MsIGZhbHNlKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiB0aGF0Lm1vZHVsZU1ldGhvZChTVEFSVCwgbmFtZSwgYXJncywgZmFsc2UsIFsKICAgICAgICAgICAgICAgIElOSVQKICAgICAgICAgICAgXSwgWwogICAgICAgICAgICAgICAgUkVBRFkKICAgICAgICAgICAgXSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLnJlYWR5ID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gdGhhdC5tb2R1bGVNZXRob2QoUkVBRFksIG5hbWUsIGFyZ3MsIGZhbHNlLCBbCiAgICAgICAgICAgICAgICBJTklULCAKICAgICAgICAgICAgICAgIFNUQVJUCiAgICAgICAgICAgIF0pOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5zdG9wID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gdGhhdC5tb2R1bGVNZXRob2QoU1RPUCwgbmFtZSwgYXJncywgdHJ1ZSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIG1ldGhvZCA9IERFU1RST1k7CiAgICAgICAgICAgIHJldHVybiB0aGF0Lm1vZHVsZU1ldGhvZChERVNUUk9ZLCBuYW1lLCBhcmdzLCB0cnVlLCBbCiAgICAgICAgICAgICAgICBTVE9QCiAgICAgICAgICAgIF0pOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5fX2luamVjdE1vZHVsZSA9IC8vI2VuZHJlZ2lvbgogICAgICAgIC8qKgogICAgICAgIEluamVjdHMgYSBwcmVjb25zdHJ1Y3RlZCBtb2R1bGUgaW50byB0aGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIAogICAgICAgIEBtZXRob2QgX19pbmplY3RNb2R1bGUKICAgICAgICBAcHJpdmF0ZQogICAgICAgIEBwYXJhbSB7TW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZSB0byBpbmplY3QuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG1vZHVsZSkgewogICAgICAgICAgICB0aGlzLmNyZWF0ZShtb2R1bGUubmFtZSwgbW9kdWxlLCB0cnVlKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuY3JlYXRlTW9kdWxlID0gLyoqCiAgICAgICAgQ3JlYXRlcyBhIG1vZHVsZSBmcm9tIHRoZSBnaXZlbiBkZWZpbml0aW9uIG9iamVjdCwgd2l0aCB0aGUgZ2l2ZW4gbmFtZS4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGNyZWF0ZU1vZHVsZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBtb2R1bGUgbmFtZQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBtb2R1bGVEZWZuIFRoZSBtb2R1bGUgZGVmaW5pdGlvbgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lLCBtb2R1bGVEZWZuKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYodGhhdC5tb2R1bGVzW25hbWVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC5tb2R1bGVzW25hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBtb2R1bGUgPSBuZXcgTW9kdWxlKHRoYXQsIG1vZHVsZURlZm4sIG5hbWUpOwogICAgICAgICAgICB0aGF0Ll9faW5qZWN0TW9kdWxlKG1vZHVsZSk7CiAgICAgICAgICAgIHJldHVybiBtb2R1bGU7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLnNwYXduID0gLyoqCiAgICAgICAgTGF1bmNoZXMgYW5vdGhlciBjaGlsZCBtb2R1bGUgZm9yIHRocnVzdC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHNwYXduCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgb25jZSB0aGUgY2hpbGQgaW5zdGFuY2UgaGFzIGZ1bGx5IGxvYWRlZC4gIFJlc29sdmVzIHdpdGggdGhlIGNvbnRleHQgdGhhdCBjb250YWlucyB0aGUgdGhydXN0IGluc3RhbmNlIGFuZCBhbGwgcGx1Z2lucyB0aGF0IHdlcmUgbG9hZGVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChzZXR0aW5ncykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiBUaHJ1c3QubGF1bmNoKGV4dGVuZCh7CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGNoaWxkSW5zdGFuY2U6IHRydWUKICAgICAgICAgICAgfSwgc2V0dGluZ3MpLCB0cnVlKS50aGVuKGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgICAgICB2YXIgdGhydXN0ID0gY29udGV4dC50aHJ1c3Q7CiAgICAgICAgICAgICAgICB0aGF0LmNoaWxkcmVuLnB1c2godGhydXN0KTsKICAgICAgICAgICAgICAgIHRocnVzdC5wYXJlbnQgPSB0aGF0OwogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQ7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5yZWdpc3Rlck1vZHVsZSA9IC8qKgogICAgICAgIFJlZ2lzdGVycyBhIHNwZWNpZmljIG1vZHVsZSBuYW1lLCBhbmQgYXJndW1lbnRzLiAgVGhlIGFyZ3VtZW50cyB3aWxsIGJlIHVzZWQgd2hlbiBpbml0YW50aWF0aW5nIHRoZSBtb2R1bGUuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCByZWdpc3Rlck1vZHVsZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBtb2R1bGUgbmFtZSB0byBhc3NpZ24gdGhlIGFyZ3VtZW50cyB3aXRoLgogICAgICAgIEBwYXJhbSB7T2JqZWN0Kn0gYXJndW1lbnRzLCBhZGRpdGlvbmFsIGFyZ3VtZW50cyB0aGF0IHdpbGwgYmUgcGFzc2VkIG9udG8gdGhlIG1vdWRsZQogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgVGhydXN0LnJlZ2lzdGVyTW9kdWxlLmFwcGx5KFRocnVzdCwgWwogICAgICAgICAgICAgICAgdGhhdC5uYW1lCiAgICAgICAgICAgIF0uY29uY2F0KHRvQXJyYXkoYXJndW1lbnRzKSkpOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LmxhdW5jaFNlcXVlbmNlID0gZnVuY3Rpb24gbGF1bmNoU2VxdWVuY2UoaW5zdGFuY2UsIGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHJldHVybiB3aGVuLnNlcXVlbmNlKFsKICAgICAgICAgICAgICAgIF8uYmluZChpbnN0YW5jZS5fY291bnRkb3duLCBpbnN0YW5jZSksIAogICAgICAgICAgICAgICAgXy5iaW5kKGluc3RhbmNlLmlnbml0ZSwgaW5zdGFuY2UpLCAKICAgICAgICAgICAgICAgIF8uYmluZChpbnN0YW5jZS5vcmJpdCwgaW5zdGFuY2UpLCAKICAgICAgICAgICAgICAgIF8uYmluZChpbnN0YW5jZS5kZXBsb3ksIGluc3RhbmNlKSwgCiAgICAgICAgICAgICAgICBfLmJpbmQoaW5zdGFuY2UuaW5PcmJpdCwgaW5zdGFuY2UpCiAgICAgICAgICAgIF0sIGNhbGxlZEJ5UGFyZW50KTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5sYXVuY2ggPSAvKioKICAgICAgICBJbml0YWxpemVzIGEgbmV3IFRocnVzdCBpbnN0YW5jZSBiYXNlZCBvbiB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBsYXVuY2gKICAgICAgICBAc3RhdGljCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBtb2R1bGUgdG8gaW5qZWN0CiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gbGF1bmNoKHNldHRpbmdzLCBjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICBpZighc2V0dGluZ3MpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gewogICAgICAgICAgICAgICAgICAgIG5hbWU6ICdnbG9iYWwnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFzZXR0aW5ncy5uYW1lKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncy5uYW1lID0gJ2dsb2JhbCc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoZmFsc2UpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzLmRlYnVnID0gewogICAgICAgICAgICAgICAgICAgIHRpbWVTdGFydDogbmV3IERhdGUoKS5nZXRUaW1lKCkKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0dGluZ3MgPSBpZ25pdGVTcGVjLm1lcmdlU2V0dGluZ3Moc2V0dGluZ3MpOwogICAgICAgICAgICB2YXIgcGlwZSA9IFsKICAgICAgICAgICAgICAgIGlnbml0ZVNwZWMuZnVzZQogICAgICAgICAgICBdOwogICAgICAgICAgICB2YXIgc2V0dXBEZWZlciA9IFRocnVzdC5fX2ZldGNoSW5zdGFuY2Uoc2V0dGluZ3MubmFtZSk7CiAgICAgICAgICAgIHBpcGUucHVzaChmdW5jdGlvbiAoY29udGV4dCkgewogICAgICAgICAgICAgICAgdmFyIHRocnVzdCA9IGNvbnRleHQudGhydXN0LCBtb2R1bGVzID0gdGhydXN0LnN0YXJ0aW5nTW9kdWxlcyA9IGNvbnRleHQuY2ZnLm1vZHVsZXMsIGNvbmZpZyA9IHRocnVzdC5jb25maWcgPSB0aHJ1c3QuY2ZnOwogICAgICAgICAgICAgICAgaW5zdGFuY2VzW3RocnVzdC5uYW1lXSA9IHRocnVzdDsKICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0OwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYoc2V0dGluZ3MuYXV0b21hdGljTGlmZWN5Y2xlKSB7CiAgICAgICAgICAgICAgICBwaXBlLnB1c2goZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdGhydXN0ID0gY29udGV4dC50aHJ1c3QsIGQgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgICAgICAgICAgICAgVGhydXN0LmxhdW5jaFNlcXVlbmNlKHRocnVzdCwgY2FsbGVkQnlQYXJlbnQpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZC5yZXNvbHZlKGNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBkLnByb21pc2U7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcGlwZWxpbmUgPSB3aGVuLnBpcGVsaW5lKHBpcGUsIHNldHRpbmdzKS50aGVuKGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2V0dXBEZWZlci5yZXNvbHZlKGNvbnRleHQpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy8gV2UncmUgb25seSBnb2luZyB0byBleHBvc2UgZ2xvYmFscyBpZiByZXF1ZXN0ZWQuICBUaGlzIGlzIGEgcG90ZW50aWFsIHVzZWNhc2UgdGhhdCBtYXkgYmUgbmVlZGVkIGZvciBzb21lIHRlYW1zLgogICAgICAgICAgICBpZih0Q29uZmlnLmV4cG9zZUdsb2JhbHMpIHsKICAgICAgICAgICAgICAgIGlmKCF3aW5kb3dbJ1RocnVzdCddKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93WydUaHJ1c3QnXSA9IFRocnVzdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBpcGVsaW5lLnRoZW4oZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3dbc2V0dGluZ3MubmFtZV0gPSBjb250ZXh0OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBpcGVsaW5lOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LmdldEluc3RhbmNlID0gLyoqCiAgICAgICAgR2V0cyBhIG5hbWVkIHRocnVzdCBzdGFuY2UgaWYgaXQgZXhpc3RzLgogICAgICAgIAogICAgICAgIEBtZXRob2QgZ2V0SW5zdGFuY2UKICAgICAgICBAc3RhdGljCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIGluc3RhbmNlIG5hbWUKICAgICAgICBAcmV0dXJucyB7VGhydXN0fSBUaGUgdGhydXN0IGluc3RhbmNlCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gZ2V0SW5zdGFuY2UobmFtZSkgewogICAgICAgICAgICByZXR1cm4gdGhydXN0SW5zdGFuY2UuZ2V0SW5zdGFuY2UobmFtZSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QuX19mZXRjaEluc3RhbmNlID0gLyoqCiAgICAgICAgRmV0Y2hzIGEgbmFtZWQgdGhydXN0IHN0YW5jZSBpZiBpdCBleGlzdHMuCiAgICAgICAgVGhpcyBsb2FkcyBhc3luY3Jvbm91c2x5LCBhcyB0aGUgaW5zdGFuY2UgbWF5IG5vdCBiZSBsb2FkZWQKICAgICAgICAKICAgICAgICBAbWV0aG9kIF9fZmV0Y2hJbnN0YW5jZQogICAgICAgIEBzdGF0aWMKICAgICAgICBAcHJpdmF0ZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBpbnN0YW5jZSBuYW1lCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRvIGEgdGhydXN0IGluc3RhbmNlIHNwZWMKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiBfX2ZldGNoSW5zdGFuY2UobmFtZSkgewogICAgICAgICAgICByZXR1cm4gdGhydXN0SW5zdGFuY2UuZmV0Y2hJbnN0YW5jZShuYW1lKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5jcmVhdGVNb2R1bGUgPSAvKioKICAgICAgICBDcmVhdGVzIGEgbmV3IG1vZHVsZSBhbmQgaGFuZHMgaXQgb2ZmIHRvIHRoZSBnaXZlbiBpbnN0YW5jZSwgaWYgdGhhdCBpbnN0YW5jZSBleGlzdHMuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBjcmVhdGVNb2R1bGUKICAgICAgICBAc3RhdGljCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGluc3RhbmNlTmFtZSBUaGUgdGhydXN0IGluc3RhbmNlIG5hbWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbW9kdWxlIG5hbWUKICAgICAgICBAcGFyYW0ge09iamVjdH0gbW9kdWxlRGVmbiBUaGUgbW9kdWxlIGRlZmluaXRpb24KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiBjcmVhdGVNb2R1bGUoaW5zdGFuY2VOYW1lLCBuYW1lLCBtb2R1bGVEZWZuKSB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IFRocnVzdC5nZXRJbnN0YW5jZShpbnN0YW5jZU5hbWUpOwogICAgICAgICAgICBpZihpbnN0YW5jZSkgewogICAgICAgICAgICAgICAgdmFyIG1vZHVsZSA9IG5ldyBNb2R1bGUoaW5zdGFuY2UsIG1vZHVsZURlZm4sIG5hbWUpOwogICAgICAgICAgICAgICAgaW5zdGFuY2UuX19pbmplY3RNb2R1bGUobW9kdWxlKTsKICAgICAgICAgICAgICAgIHJldHVybiBtb2R1bGU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIFRocnVzdC5yZWdpc3Rlck1vZHVsZSA9IC8qKgogICAgICAgIFJlZ2lzdGVycyBhIHNwZWNpZmljIG1vZHVsZSBuYW1lLCBhbmQgYXJndW1lbnRzLiAgVGhlIGFyZ3VtZW50cyB3aWxsIGJlIHVzZWQgd2hlbiBpbml0YW50aWF0aW5nIHRoZSBtb2R1bGUuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCByZWdpc3Rlck1vZHVsZQogICAgICAgIEBzdGF0aWMKICAgICAgICBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VOYW1lIFRoZSB0aHJ1c3QgaW5zdGFuY2UgdGhlIG1vZHVsZSBpcyB0byBiZSBhc3NvY2lhdGVkIHdpdGguCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG1vZHVsZSBuYW1lIHRvIGFzc2lnbiB0aGUgYXJndW1lbnRzIHdpdGguCiAgICAgICAgQHBhcmFtIHtPYmplY3QqfSBhcmd1bWVudHMsIGFkZGl0aW9uYWwgYXJndW1lbnRzIHRoYXQgd2lsbCBiZSBwYXNzZWQgb250byB0aGUgbW91ZGxlCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJNb2R1bGUoaW5zdGFuY2VOYW1lLCBuYW1lKSB7CiAgICAgICAgICAgIGlmKCFpbnN0YW5jZU5hbWUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignaW5zdGFuY2VOYW1lIGlzIHJlcXVpcmVkIScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFuYW1lKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ25hbWUgaXMgcmVxdWlyZWQhJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIVRocnVzdC5fX21vZHVsZVJlZ2lzdHJhdGlvbnNbaW5zdGFuY2VOYW1lXSkgewogICAgICAgICAgICAgICAgVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9uc1tpbnN0YW5jZU5hbWVdID0gewogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXJncyA9IHRvQXJyYXkoYXJndW1lbnRzKS5zbGljZSgyKTsKICAgICAgICAgICAgaWYoVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9uc1tpbnN0YW5jZU5hbWVdW25hbWVdKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdNb2R1bGUgInswfSIgYWxyZWFkeSByZWdpc3RlcmVkIHRvIGluc3RhbmNlICJ7MX0iJywgbmFtZSwgaW5zdGFuY2VOYW1lKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9uc1tpbnN0YW5jZU5hbWVdW25hbWVdID0gYXJncyB8fCBbXTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5fX2dldE1vZHVsZUFyZ3MgPSBfX2dldE1vZHVsZUFyZ3M7CiAgICAgICAgcmV0dXJuIFRocnVzdDsKICAgIH0pKCk7CiAgICBleHBvcnRzLlRocnVzdCA9IFRocnVzdDsgICAgCiAgICAvKioKICAgIEFNRCBBUEkKICAgIGxvYWQKICAgIAogICAgSGFuZGxlcyBmZXRjaGluZyBvZiBhIGN1cnJlbnQgdGh1cnN0IGluc3RhbmNlLCBieSBleHBlY3RlZCBuYW1lLgogICAgQWRkaW5nIHRoZSA6IGNoYXJhY3RlciByZXF1ZXN0cyBhIHNwZWNpZmljIHBsdWdpbi4KICAgIHRocnVzdCFnbG9iYWwgPSBUaHJ1c3QgaW5zdGFuY2UKICAgIHRocnVzdCFnbG9iYWw6ZG9tID0gVGhlIHRocnVzdCBkb20gcGx1Z2luIGluc3RhbmNlCiAgICAKICAgIEBtZXRob2QgbG9hZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlIHRoYXQgaXMgYmVpbmcgZmV0Y2hlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gcGFyZW50UmVxdWlyZSB0aGUgcmVxdWlyZSBtZXRob2QgdG8gYmUgbG9hZGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBsb2FkIEFsbG93cyB0aGUgbG9hZCB0byBpbmZvcm0gdGhhdCBBTUQgZm9yIHRoZSB2YWx1ZSB0byBoYW5kIG9mZgogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgY3VzdG9tIGNvbmZpZ3VyYXRpb24uCiAgICAqKi8KICAgIGZ1bmN0aW9uIGxvYWQobmFtZSwgcGFyZW50UmVxdWlyZSwgbG9hZCwgY29uZmlnKSB7CiAgICAgICAgdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgnOicpLCByZWFsTmFtZSA9IHBhcnRzWzBdLCBwbHVnaW5OYW1lID0gcGFydHNbMV0gfHwgJ3RocnVzdCc7CiAgICAgICAgdmFyIGluc3RhbmNlUHJvbWlzZSA9IFRocnVzdC5fX2ZldGNoSW5zdGFuY2UocmVhbE5hbWUpOwogICAgICAgIGluc3RhbmNlUHJvbWlzZS5wcm9taXNlLnRoZW4oZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgdmFyIHBsdWdpbiA9IGNvbnRleHRbcGx1Z2luTmFtZV07CiAgICAgICAgICAgIGlmKCFwbHVnaW4pIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmb3JtYXQoJ1BsdWdpbiAiezB9IiBkb2VzIG5vdCBleGlzdCBvbiB0aHJ1c3QgaW5zdGFuY2UgInsxfSIuJywgcGx1Z2luTmFtZSwgcmVhbE5hbWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsb2FkKHBsdWdpbik7CiAgICAgICAgfSk7CiAgICB9CiAgICBleHBvcnRzLmxvYWQgPSBsb2FkOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0JywgWyd0aHJ1c3QvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgpkZWZpbmUoJ3RocnVzdC9jb252ZW50aW9uJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIC8qKgogICAgQSBDb252ZW50aW9uIGFsbG93cyB0aHJ1c3QgdG8gYmUgYXMgZXh0ZW5kYWJsZSBhcyBwb3NzaWJsZSwgYnkgZ2l2aW5nIGV4dGVuc2lvbiBwb2ludHMgYXQgZXZlcnkgc3RlcCBhbG9uZyB0aGUgd2F5LgogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgKiovCiAgICB2YXIgbWV0aG9kcyA9IFsKICAgICAgICAnY3JlYXRlJywgCiAgICAgICAgJ2luaXQnLCAKICAgICAgICAnc3RhcnQnLCAKICAgICAgICAncmVhZHknLCAKICAgICAgICAnc3RvcCcsIAogICAgICAgICdkZXN0cm95JywgCiAgICAgICAgJ2NvdW50ZG93bicsIAogICAgICAgICdpZ25pdGUnLCAKICAgICAgICAnb3JiaXQnLCAKICAgICAgICAnZGVvcmJpdCcsIAogICAgICAgICdzcGxhc2hkb3duJwogICAgXTsKICAgIC8qKgogICAgVGhlIGNvbnZlbnRpb24gY2xhc3MsIHRha2VzIGFuIG92ZXJsb2FkZWQgc2V0IG9mIG1ldGhvZHMsIGZvciBhbnkgbWV0aG9kIHRoYXQgbmVlZHMgdG8gYmUgb3ZlcmxvYWRlZC4KICAgIAogICAgQGNsYXNzIHRocnVzdC5Db252ZW50aW9uCiAgICBAY29uc3RydWN0b3IKICAgIEBwYXJhbSB7T2JqZWN0fSBtZXRob2RzIEFuIG9iamVjdCBvZiBhcHBsaWNhYmxlIG1ldGhvZHMuCiAgICAqKi8KICAgIHZhciBDb252ZW50aW9uID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBDb252ZW50aW9uKG1ldGhvZE92ZXJyaWRlcykgewogICAgICAgICAgICBfLmV4dGVuZCh0aGlzLCBtZXRob2RPdmVycmlkZXMpOwogICAgICAgICAgICB2YXIga2V5cyA9IF8uZGlmZmVyZW5jZShtZXRob2RzLCBfLmludGVyc2VjdGlvbihtZXRob2RzLCBfLmtleXMobWV0aG9kT3ZlcnJpZGVzKSkpOwogICAgICAgICAgICBfLmVhY2goa2V5cywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIGlmKF8uaXNGdW5jdGlvbih0aGlzW3hdKSkgewogICAgICAgICAgICAgICAgICAgIC8vIG5vb3AgaXMgdXNlZCBpbiBzYWZlaW52b2tlLCBhcyBhIHNhZmUgaWdub3JlIGZ1bmN0aW9uLCBubyBvdGhlciBub29wIHdpbGwgd29yayBjb3JyZWN0bHkuCiAgICAgICAgICAgICAgICAgICAgdGhpc1t4XSA9IHV0aWwubm9vcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgfQogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLmNyZWF0ZSA9IC8qKgogICAgICAgIFRoaXMgaXMgY2FsbGVkIGR1cmluZyBjcmVhdGUgb2YgYSBtb2R1bGUsIGdlbmVyYWxseSB1c2VkIHRvIGNyZWF0ZSBhIGZhY2FkZSwgdGhhdCBpcyB0aGVuIGJvdW5kIHRvIHRoZSBtb2R1bGUuCiAgICAgICAgQG1ldGhvZCBjcmVhdGUKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQHBhcmFtIHtNb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIGluc3RhbmNlLgogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIEFsbCB0aGUgZmFjYWRlcyBhbHJlYWR5IGF0dGFjaGVkIHRvIHRoZSBtb2R1bGUuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCwgbW9kLCBmYWNhZGVzKSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5pbml0ID0gLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGR1cmluZyB0aGUgdGhydXN0IGluaXQgcGhhc2UsIG9yIGFuIGluZGl2aWR1YWwgbW9kdWxlJ3MgaW5pdCBwaGFzZQogICAgICAgIAogICAgICAgIEBtZXRob2QgaW5pdAogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGZvciB0aGUgbW9kdWxlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLnN0YXJ0ID0gLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGR1cmluZyB0aGUgdGhydXN0IHN0YXJ0IHBoYXNlLCBvciBhbiBpbmRpdmlkdWFsIG1vZHVsZSdzIHN0YXJ0IHBoYXNlCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBzdGFydAogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGZvciB0aGUgbW9kdWxlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLnJlYWR5ID0gLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGR1cmluZyB0aGUgdGhydXN0IHJlYWR5IHBoYXNlLCBvciBhbiBpbmRpdmlkdWFsIG1vZHVsZSdzIHJlYWR5IHBoYXNlCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCByZWFkeQogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGZvciB0aGUgbW9kdWxlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLnN0b3AgPSAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgZHVyaW5nIHRoZSB0aHJ1c3Qgc3RvcCBwaGFzZSwgb3IgYW4gaW5kaXZpZHVhbCBtb2R1bGUncyBzdG9wIHBoYXNlCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBzdG9wCiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgVGhlIGZhY2FkZXMgZm9yIHRoZSBtb2R1bGUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUuZGVzdHJveSA9IC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBkdXJpbmcgdGhlIHRocnVzdCBkZXN0cm95IHBoYXNlLCBvciBhbiBpbmRpdmlkdWFsIG1vZHVsZSdzIGRlc3Ryb3kgcGhhc2UKICAgICAgICAKICAgICAgICBAbWV0aG9kIGRlc3Ryb3kKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgZmFjYWRlcyBmb3IgdGhlIG1vZHVsZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobW9kLCBmYWNhZGVzKSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5jb3VudGRvd24gPSAvKioKICAgICAgICBUaGlzIGlzIGNhbGxlZCBkdXJpbmcgdGhlIGluaXQgcGhhc2Ugb2YgYSBUaHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQG1ldGhvZCBjb3VudGRvd24KICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUuaWduaXRlID0gLyoqCiAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIHRoZSBzdGFydCBwaGFzZSBvZiBhIFRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAbWV0aG9kIGlnbml0ZQogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5vcmJpdCA9IC8qKgogICAgICAgIFRoaXMgaXMgY2FsbGVkIGR1cmluZyB0aGUgcmVhZHkgcGhhc2Ugb2YgYSBUaHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQG1ldGhvZCBvcmJpdAogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5kZW9yYml0ID0gLyoqCiAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIHRoZSBzdG9wIHBoYXNlIG9mIGEgVGhydXN0IGluc3RhbmNlLgogICAgICAgIEBtZXRob2QgZGVvcmJpdAogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5zcGxhc2hkb3duID0gLyoqCiAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIHRoZSBkZXN0cm95IHBoYXNlIG9mIGEgVGhydXN0IGluc3RhbmNlLgogICAgICAgIEBtZXRob2Qgc3BsYXNoZG93bgogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gQ29udmVudGlvbjsKICAgIH0pKCk7CiAgICBleHBvcnRzLkNvbnZlbnRpb24gPSBDb252ZW50aW9uOyAgICAKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29udmVudGlvbi5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9ldmVudHMnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJy4vbG9nJywgJy4vY29uZmlnJywgJ2hhcycsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2xvZ19fLCBfX3RDb25maWdfXywgX19oYXNfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9ImludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9ImludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgLy8gICAgIEJhY2tib25lLmpzIDAuOS4xCiAgICAvLyAgICAgKGMpIDIwMTAtMjAxMiBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgSW5jLgogICAgLy8gICAgIEJhY2tib25lIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogICAgLy8gICAgIEZvciBhbGwgZGV0YWlscyBhbmQgZG9jdW1lbnRhdGlvbjoKICAgIC8vICAgICBodHRwOi8vYmFja2JvbmVqcy5vcmcKICAgIC8qKgogICAgVGhydXN0IEV2ZW50cyBhcmUgYmFzZWQgb2ZmIG9mIHRoZSBCYWNrYm9uZSBldmVudCBtb2RlbCwgd2l0aCBzcGVjaWFsIGFkZGl0aW9ucy4KICAgIAogICAgKiBFdmVudHMgY2FuIGJlIGZpcmVkIGFzeW5jcm9ub3VzbHkuCiAgICAqIEV2ZW50cyBjYW4gYmUgbmFtZXNwYWNlZC4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgICoqLwogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIHRDb25maWcgPSBfX3RDb25maWdfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIEV2ZW50Tm9kZSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gRXZlbnROb2RlKCkgewogICAgICAgICAgICB0aGlzLnRhaWwgPSBudWxsOwogICAgICAgICAgICB0aGlzLm5leHQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmNhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5jb250ZXh0ID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5uYW1lc3BhY2UgPSAnJzsKICAgICAgICAgICAgdGhpcy5vbmNlID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiBFdmVudE5vZGU7CiAgICB9KSgpOwogICAgZXhwb3J0cy5FdmVudE5vZGUgPSBFdmVudE5vZGU7ICAgIAogICAgdmFyIGNyZWF0ZUFzeW5jRXZlbnQgPSBmdW5jdGlvbiAob2JqZWN0KSB7CiAgICAgICAgdmFyIGYgPSBmdW5jdGlvbiBmKGV2ZW50cykgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfdHJpZ2dlci5hcHBseShvYmplY3QsIFsKICAgICAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgIF0uY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICAgIH07CiAgICAgICAgZi5hc3luYyA9IGZ1bmN0aW9uIChldmVudHMpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgX3RyaWdnZXIuYXBwbHkob2JqZWN0LCBbCiAgICAgICAgICAgICAgICB0cnVlCiAgICAgICAgICAgIF0uY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGY7CiAgICB9OwogICAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBhc3luY0ZpcmUsIG5vb3AgPSB1dGlsLm5vb3AsIHdoZW4gPSB1dGlsLndoZW4sIHNpemUgPSBfLnNpemUsIGVhY2ggPSBfLmVhY2gsIGRlZmVyID0gXy5kZWZlciwgYmluZCA9IF8uYmluZCwgZXh0ZW5kID0gXy5leHRlbmQsIGZvcm1hdCA9IHV0aWwuZm9ybWF0OwogICAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLywgQUxMID0gJ2FsbCcsIFNUQVJBTEwgPSAnKmFsbCc7CiAgICAvKioKICAgIE5vcm1hbGl6ZXMgdGhlIGdpdmVuIGV2ZW50cyB0byB0aGUgZXhwZWN0ZWQgbmFtZXNwYWNlLgogICAgCiAgICBAbWV0aG9kIG5vcm1hbGl6ZUV2ZW50cwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudHMgVGhlIGV2ZW50cyBkZWxpbWl0ZWQgYnkgYSBzcGFjZQogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWVzcGFjZSBUaGUgbmFtZXNwYWNlLCBpbmNsdWRpbmcgcHJlZml4ZWQgJy4nCiAgICAqKi8KICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZUV2ZW50cyhldmVudHMsIG5hbWVzcGFjZSkgewogICAgICAgIHZhciBldmVudHNBcnJheSA9IGV2ZW50cy5zcGxpdChldmVudFNwbGl0dGVyKTsKICAgICAgICBmb3IodmFyIGkgPSAwLCBpTGVuID0gZXZlbnRzQXJyYXkubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmKGV2ZW50c0FycmF5W2ldLmluZGV4T2YoJy4nKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIGV2ZW50c0FycmF5W2ldID0gZXZlbnRzQXJyYXlbaV0gKyBuYW1lc3BhY2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV2ZW50c0FycmF5LmpvaW4oJyAnKTsKICAgIH0KICAgIC8qKgogICAgVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQogICAgKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgCiAgICBAbWV0aG9kIF90cmlnZ2VyCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtCb29sZWFufSBhc3luYyBGaXJlIGV2ZW50IGFzeW5jIG9yIHN5bmMKICAgIEBwYXJhbSB7T2JqZWN0fSBldmVudHMgVGhlIGV2ZW50cyB0byBiZSBmaXJlZC4KICAgIGRlbGltaXRlZCBieSBhIHNwYWNlLgogICAgQHBhcmFtIFthcmdzXSogVGhlIGFyZ3VtZW50cyB0byBwYXNzIG9udG8gdGhlIGNhbGxiYWNrIG1ldGhvZHMuCiAgICBAcmV0dXJucyBJZiBhc3luYyB0aGVuIHJldHVybnMgYSBQcm9taXNlLCB3aGVyZSB0aGUgZmlyc3QgYXJndW1lbnQgY29udGFpbnMgYWxsIHRoZSByZXR1cm5lZCB2YWx1ZXMsIGFzIGFuIGFycmF5CiAgICBJZiBzeW5jIHRoZW4gcmV0dXJucyBhbiBhcnJheSBvZiB0aGUgcmV0dXJuIHZhbHVlcy4KICAgIElmIG1vcmUgdGhhbiBvbmUgZXZlbnQsIHJldHVybnMgYW4gb2JqZWN0IG9mIGFycmF5cyBvciBwcm9taXNlcywgd2l0aCB0aGUga2V5IGZvciBlYWNoIGV2ZW50LgogICAgKiovCiAgICBmdW5jdGlvbiBfdHJpZ2dlcihhc3luYywgZXZlbnRzKSB7CiAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi8KICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgZXZlbnQsIG5vZGUsIGNhbGxzLCB0YWlsLCBhcmdzLCBhbGwsIHJlc3QsIG5hbWVzcGFjZSwgb25jZU5vZGVzOwogICAgICAgIGlmKCEoY2FsbHMgPSB0aGlzLl9jYWxsYmFja3MpKSB7CiAgICAgICAgICAgIHJldHVybiB0aGF0OwogICAgICAgIH0KICAgICAgICBhbGwgPSBjYWxscy5hbGw7CiAgICAgICAgdmFyIGV2ZW50c0FycmF5ID0gZXZlbnRzLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwogICAgICAgIHJlc3QgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICAgICAgd2hpbGUoZXZlbnQgPSBldmVudHNBcnJheS5zaGlmdCgpKSB7CiAgICAgICAgICAgIGlmKG5vZGUgPSBjYWxsc1tldmVudF0pIHsKICAgICAgICAgICAgICAgIHRyaWdnZXJOb2Rlcyh0aGF0LCBldmVudCwgYXN5bmMsIG5vZGUsIHJlc3QpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG5vZGUgPSBhbGwpIHsKICAgICAgICAgICAgICAgIHRyaWdnZXJOb2Rlcyh0aGF0LCBBTEwsIGFzeW5jLCBub2RlLCBbCiAgICAgICAgICAgICAgICAgICAgZXZlbnQKICAgICAgICAgICAgICAgIF0uY29uY2F0KHJlc3QpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIC8qKgogICAgVHJpZ2dlcnMgYWxsIGV2ZW50cyBvbiBhIG5vZGUuCiAgICBBbHNvIHVuYmluZHMgYW55IG5vZGUgdGhhdCBpcyBzZXQgdG8gb25seSBiZSBjYWxsZWQgb25jZS4KICAgIAogICAgQG1ldGhvZCB0cmlnZ2VyTm9kZXMKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge09iamVjdH0gdGhhdCBUaGUgZXZlbnQgY29udGFpbmVyIGNvbnRleHQuCiAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnQgVGhlIGV2ZW50IHRvIGJlIGJvdW5kIG9yIHVuYm91bmQuCiAgICBAcGFyYW0ge0Jvb2xlYW59IGFzeW5jIEZpcmUgZXZlbnQgYXN5bmMgb3Igc3luYwogICAgQHBhcmFtIHtPYmplY3R9IG5vZGUgVGhlIG5vZGUgbGlua2VkIGxpc3QuCiAgICBAcGFyYW0ge0FycmF5fSBhcmdzIFRoZSBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSB0cmlnZ2VyZWQgbm9kZXMKICAgIAogICAgKiovCiAgICBmdW5jdGlvbiB0cmlnZ2VyTm9kZXModGhhdCwgZXZlbnQsIGFzeW5jLCBub2RlTGlzdCwgYXJncykgewogICAgICAgIHZhciB0YWlsLCBvbmNlTm9kZXMgPSBbXTsKICAgICAgICBmYWxzZSAmJiBsb2cuaW5mbyhmb3JtYXQoJ3swfTogdHJpZ2dlcmluZyB7MX0gZXZlbnQgInsyfSInLCB0aGF0Ll9fcHViU3ViTmFtZSwgYXN5bmMgJiYgJ2FzeW5jJyB8fCAnJywgZXZlbnQpKTsKICAgICAgICBlYWNoKG5vZGVMaXN0LCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICB0YWlsID0gbm9kZS50YWlsOwogICAgICAgICAgICB3aGlsZSgobm9kZSA9IG5vZGUubmV4dCkgIT09IHRhaWwpIHsKICAgICAgICAgICAgICAgIHRyaWdnZXJDYWxsYmFjayhhc3luYywgbm9kZS5jYWxsYmFjaywgbm9kZS5jb250ZXh0IHx8IHRoYXQsIGFyZ3MpOwogICAgICAgICAgICAgICAgbm9kZS5vbmNlICYmIG9uY2VOb2Rlcy5wdXNoKG5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgaWYob25jZU5vZGVzLmxlbmd0aCkgewogICAgICAgICAgICBlYWNoKG9uY2VOb2RlcywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIHRoYXQudW5zdWJzY3JpYmUoZXZlbnQsIHguY2FsbGJhY2ssIHguY29udGV4dCwgeC5uYW1lc3BhY2UpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICAvKioKICAgIEludm9rZXMgYSB0cmlnZ2VyIGNhbGxiYWNrCiAgICAKICAgIEBtZXRob2QgdHJpZ2dlckNhbGxiYWNrCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtCb29sZWFufSBhc3luYyBGaXJlIGV2ZW50IGFzeW5jIG9yIHN5bmMKICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBtZXRob2QKICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IFRoZSBjYWxsaW5nIGNvbnRleHQKICAgIEBwYXJhbSB7QXJyYXl9IGFyZ3MgVGhlIGFyZ3VtZW50cyB0byBjYWxsIHRoZSBjYWxsYmFjayB3aXRoLgogICAgQHJldHVybnMge09iamVjdH0gVGhlIHJldHVybmVkIHZhbHVlLgogICAgRm9yIGFzeW5jIGNhbGxzLCB0aGlzIGlzIGEgcHJvbWlzZQogICAgRm9yIHN5bmMgY2FsbHMgdGhpcyBpcyB0aGUgdmFsdWUgZnJvbSB0aGUgbWV0aG9kLgogICAgKiovCiAgICBmdW5jdGlvbiB0cmlnZ2VyQ2FsbGJhY2soYXN5bmMsIGNhbGxiYWNrLCBjb250ZXh0LCBhcmdzKSB7CiAgICAgICAgaWYoYXN5bmMpIHsKICAgICAgICAgICAgZGVmZXIodHJpZ2dlckFzeW5jQ2FsbGJhY2soY2FsbGJhY2ssIGNvbnRleHQsIGFyZ3MpLCAwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0cnkgIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjay5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgaWYodENvbmZpZy50aHJvd0Vycm9ycykgewogICAgICAgICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAvKioKICAgIENyZWF0ZXMgYW4gYXN5bmMgZXZlbnQgaGFuZGxlcgogICAgCiAgICBAbWV0aG9kIGFzeW5jRXZlbnRGYWN0b3J5CiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIG1ldGhvZAogICAgQHBhcmFtIHtPYmplY3R9IHRoYXQgVGhlIGNhbGxpbmcgY29udGV4dAogICAgQHBhcmFtIHtBcnJheX0gYXJncyBUaGUgYXJndW1lbnRzIHRvIGNhbGwgdGhlIGNhbGxiYWNrIHdpdGguCiAgICBAcmV0dXJucyB7RnVuY3Rpb259IFRoZSBjYWxsYmFjayBmb3IgdGhlIGdpdmVuIGFyZ3VtZW50cy4KICAgICoqLwogICAgZnVuY3Rpb24gdHJpZ2dlckFzeW5jQ2FsbGJhY2soY2FsbGJhY2ssIGNvbnRleHQsIGFyZ3MpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgfTsKICAgIH0KICAgIC8qKgogICAgUmVzdWJzY3JpYmVzIHRvIHRoZSBhcHByb3ByaWF0ZSBldmVudHMKICAgIAogICAgQG1ldGhvZCBfb2ZmUHJvY2Vzc05vZGUKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge09iamVjdH0gdGhhdCBUaGUgZXZlbnQgY29udGV4dAogICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50IFRoZSBldmVudAogICAgQHBhcmFtIHtPYmplY3R9IG5vZGUgVGhlIG5vZGUgbGlua2VkIGxpc3QuCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBldmVudCBjYWxsYmFjayB0byB1bnN1YnNjcmliZQogICAgQHBhcmFtIHtPYmplY3R9IFtjb250ZXh0XSBUaGUgZXZlbnQgY29udGV4dCB0byB1bnN1YnNjcmliZQogICAgQHBhcmFtIHtTdHJpbmd9IFtuYW1lc3BhY2VdIFRoZSBuYW1lc3BhY2UgdG8gdW5zdWJzY3JpYmUKICAgICoqLwogICAgZnVuY3Rpb24gX29mZlByb2Nlc3NOb2RlKHRoYXQsIGV2ZW50LCBub2RlLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIHZhciB0YWlsLCBjYiwgY3R4LCBuczsKICAgICAgICB0YWlsID0gbm9kZS50YWlsOwogICAgICAgIHdoaWxlKChub2RlID0gbm9kZS5uZXh0KSAhPT0gdGFpbCkgewogICAgICAgICAgICBjYiA9IG5vZGUuY2FsbGJhY2s7CiAgICAgICAgICAgIGN0eCA9IG5vZGUuY29udGV4dDsKICAgICAgICAgICAgbnMgPSBub2RlLm5hbWVzcGFjZTsKICAgICAgICAgICAgaWYoKGNhbGxiYWNrICYmIGNiICE9PSBjYWxsYmFjaykgfHwgKGNvbnRleHQgJiYgY3R4ICE9PSBjb250ZXh0KSkgewogICAgICAgICAgICAgICAgdGhhdC5zdWJzY3JpYmUoZXZlbnQgKyAobnMgJiYgKCcuJyArIG5zKSB8fCAnJyksIGNiLCBjdHgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgLyoqCiAgICBHZXRzIHRoZSBuYW1lc3BhY2UgaW5mb3JtYXRpb24sIHRoZSByZWFsIGV2ZW50IHRvIHBhc3MgYmFjayBvbnRvIHRoZSBtZXRob2RzLgogICAgCiAgICBAbWV0aG9kIGdldE5hbWVzcGFjZURhdGEKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnQgVGhlIGV2ZW50IHRvIGNhcHR1cmUgbmFtZXNwYWNlIGRhdGEgZnJvbS4KICAgIEByZXR1cm5zIHtPYmplY3R9IENvbnRhaW5pbmcgZXZlbnQgYW5kIG5hbWVzcGFjZS4KICAgICoqLwogICAgZnVuY3Rpb24gZ2V0TmFtZXNwYWNlRGF0YShldmVudCkgewogICAgICAgIHZhciBuc0luZGV4ID0gKGV2ZW50IHx8ICcnKS5pbmRleE9mKCcuJyksIGhhc05zID0gbnNJbmRleCA+IC0xLCBuYW1lc3BhY2UgPSBoYXNOcyA/IGV2ZW50LnN1YnN0cmluZyhuc0luZGV4ICsgMSkgOiB1bmRlZmluZWQsIGV2ZW50ID0gaGFzTnMgPyBldmVudC5zdWJzdHJpbmcoMCwgbnNJbmRleCkgOiBldmVudDsKICAgICAgICBpZihuc0luZGV4ID09PSAwKSB7CiAgICAgICAgICAgIGV2ZW50ID0gU1RBUkFMTDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZXZlbnQ6IGV2ZW50LAogICAgICAgICAgICBuYW1lc3BhY2U6IG5hbWVzcGFjZQogICAgICAgIH07CiAgICB9CiAgICAvKioKICAgIFRocnVzdCBFdmVudHMgYXJlIGJhc2VkIG9mZiBvZiB0aGUgQmFja2JvbmUgZXZlbnQgbW9kZWwsIHdpdGggc3BlY2lhbCBhZGRpdGlvbnMuCiAgICAKICAgICogRXZlbnRzIGNhbiBiZSBmaXJlZCBhc3luY3Jvbm91c2x5LgogICAgKiBFdmVudHMgY2FuIGJlIG5hbWVzcGFjZWQuCiAgICAKICAgIEBjbGFzcyB0aHJ1c3QuRXZlbnRzCiAgICAqKi8KICAgIGV4cG9ydHMuRXZlbnRzID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZXZlbnRzID0gewogICAgICAgICAgICBzdWJzY3JpYmU6IC8qKgogICAgICAgICAgICBCaW5kIG9uZSBvciBtb3JlIHNwYWNlIHNlcGFyYXRlZCBldmVudHMsIGBldmVudHNgLCB0byBhIGBjYWxsYmFja2AKICAgICAgICAgICAgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQgdGhlIGNhbGxiYWNrIHRvIGFsbCBldmVudHMgZmlyZWQuCiAgICAgICAgICAgIAogICAgICAgICAgICBAbWV0aG9kIHN1YnNjcmliZQogICAgICAgICAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnRzIFNwYXZlIHNlcGVyYXRlZCBldmVudHMKICAgICAgICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIG1ldGhvZCB0byBiZSBjYWxsZWQgd2hlbiB0aGUgZXZlbnRzIGFyZSBmaXJlZC4KICAgICAgICAgICAgQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgVGhlIGNvbnRleHQgdG8gYmluZCB0aGUgY2FsbGluZyBmdW5jdGlvbiB0by4KICAgICAgICAgICAgQHBhcmFtIHtCb29sZWFufSBvbmNlIENhbGwgdGhpcyBldmVudCBvbmx5IG9uY2UuCiAgICAgICAgICAgIEBjaGFpbmFibGUKICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0LCBvbmNlKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FsbHMsIGV2ZW50LCBub2RlLCB0YWlsLCBsaXN0LCBuZDsKICAgICAgICAgICAgICAgIHRoaXMuX19uYW1lc3BhY2UgJiYgKGV2ZW50cyA9IG5vcm1hbGl6ZUV2ZW50cyhldmVudHMsIHRoaXMuX19uYW1lc3BhY2UpKTsKICAgICAgICAgICAgICAgIHZhciBldmVudHNBcnJheSA9IGV2ZW50cy5zcGxpdChldmVudFNwbGl0dGVyKTsKICAgICAgICAgICAgICAgIGNhbGxzID0gdGhpcy5fY2FsbGJhY2tzIHx8ICh0aGlzLl9jYWxsYmFja3MgPSB7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBhbiBpbW11dGFibGUgY2FsbGJhY2sgbGlzdCwgYWxsb3dpbmcgdHJhdmVyc2FsIGR1cmluZwogICAgICAgICAgICAgICAgLy8gbW9kaWZpY2F0aW9uLiAgVGhlIHRhaWwgaXMgYW4gZW1wdHkgb2JqZWN0IHRoYXQgd2lsbCBhbHdheXMgYmUgdXNlZAogICAgICAgICAgICAgICAgLy8gYXMgdGhlIG5leHQgbm9kZS4KICAgICAgICAgICAgICAgIHdoaWxlKGV2ZW50ID0gZXZlbnRzQXJyYXkuc2hpZnQoKSkgewogICAgICAgICAgICAgICAgICAgIG5kID0gZ2V0TmFtZXNwYWNlRGF0YShldmVudCk7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQgPSBuZC5ldmVudDsKICAgICAgICAgICAgICAgICAgICBsaXN0ID0gY2FsbHNbZXZlbnRdIHx8IChjYWxsc1tldmVudF0gPSB7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgbGlzdCA9IGxpc3RbbmQubmFtZXNwYWNlXTsKICAgICAgICAgICAgICAgICAgICBub2RlID0gbGlzdCA/IGxpc3QudGFpbCA6IG5ldyBFdmVudE5vZGUoKTsKICAgICAgICAgICAgICAgICAgICBub2RlLm5leHQgPSB0YWlsID0gbmV3IEV2ZW50Tm9kZSgpOwogICAgICAgICAgICAgICAgICAgIG5vZGUuY29udGV4dCA9IGNvbnRleHQgfHwgdGhpcy5fX2RlZmF1bHRDb250ZXh0IHx8IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICBub2RlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgICAgICAgaWYobmQubmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubmFtZXNwYWNlID0gbmQubmFtZXNwYWNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZihvbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUub25jZSA9IG9uY2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNhbGxzW2V2ZW50XVtuZC5uYW1lc3BhY2VdID0gewogICAgICAgICAgICAgICAgICAgICAgICB0YWlsOiB0YWlsLAogICAgICAgICAgICAgICAgICAgICAgICBuZXh0OiBsaXN0ID8gbGlzdC5uZXh0IDogbm9kZQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25jZTogLyoqCiAgICAgICAgICAgIEJpbmQgb25lIG9yIG1vcmUgc3BhY2Ugc2VwYXJhdGVkIGV2ZW50cywgYGV2ZW50c2AsIHRvIGEgYGNhbGxiYWNrYAogICAgICAgICAgICBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZCB0aGUgY2FsbGJhY2sgdG8gYWxsIGV2ZW50cyBmaXJlZC4KICAgICAgICAgICAgCiAgICAgICAgICAgIEVhY2ggZXZlbnQgd2lsbCBvbmx5IGJlIGNhbGxlZCBvbmNlLgogICAgICAgICAgICAKICAgICAgICAgICAgQG1ldGhvZCBvbmNlCiAgICAgICAgICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudHMgU3BhdmUgc2VwZXJhdGVkIGV2ZW50cwogICAgICAgICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgbWV0aG9kIHRvIGJlIGNhbGxlZCB3aGVuIHRoZSBldmVudHMgYXJlIGZpcmVkLgogICAgICAgICAgICBAcGFyYW0ge09iamVjdH0gY29udGV4dCBUaGUgY29udGV4dCB0byBiaW5kIHRoZSBjYWxsaW5nIGZ1bmN0aW9uIHRvLgogICAgICAgICAgICBAY2hhaW5hYmxlCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3Vic2NyaWJlKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQsIHRydWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN1YnNjcmliZTogLyoqCiAgICAgICAgICAgIFJlbW92ZSBvbmUgb3IgbWFueSBjYWxsYmFja3MuIElmIGBjb250ZXh0YCBpcyBudWxsLCByZW1vdmVzIGFsbCBjYWxsYmFja3MKICAgICAgICAgICAgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGNhbGxiYWNrcyBmb3IgdGhlCiAgICAgICAgICAgIGV2ZW50LiBJZiBgZXZlbnRgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kIGNhbGxiYWNrcyBmb3IgYWxsIGV2ZW50cy4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2QgdW5zdWJzY3JpYmUKICAgICAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50cyBTcGF2ZSBzZXBlcmF0ZWQgZXZlbnRzCiAgICAgICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBtZXRob2QgdG8gYmUgY2FsbGVkIHdoZW4gdGhlIGV2ZW50cyBhcmUgZmlyZWQuCiAgICAgICAgICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IFRoZSBjb250ZXh0IHRvIGJpbmQgdGhlIGNhbGxpbmcgZnVuY3Rpb24gdG8uCiAgICAgICAgICAgIEBjaGFpbmFibGUKICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnQsIGNhbGxzLCBub2RlLCBuZCwgb3VyTnMsIG5hbWVzcGFjZSwgdGhhdCA9IHRoaXMsIGhhc05zOwogICAgICAgICAgICAgICAgb3VyTnMgPSB0aGF0Ll9fbmFtZXNwYWNlOwogICAgICAgICAgICAgICAgb3VyTnMgJiYgKG91ck5zID0gb3VyTnMuc3Vic3RyaW5nKDEpKTsKICAgICAgICAgICAgICAgIC8vIE5vIGV2ZW50cywgb3IgcmVtb3ZpbmcgKmFsbCogZXZlbnRzLgogICAgICAgICAgICAgICAgaWYoIShjYWxscyA9IHRoYXQuX2NhbGxiYWNrcykpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZighKGV2ZW50cyB8fCBjYWxsYmFjayB8fCBjb250ZXh0KSkgewogICAgICAgICAgICAgICAgICAgIGlmKCFvdXJOcykgewogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhhdC5fY2FsbGJhY2tzOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYnMgPSB0aGF0Ll9jYWxsYmFja3M7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSBpbiBjYnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYnNbaV1bb3VyTnNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc2l6ZShjYnNbaV0pID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNic1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIExvb3AgdGhyb3VnaCB0aGUgbGlzdGVkIGV2ZW50cyBhbmQgY29udGV4dHMsIHNwbGljaW5nIHRoZW0gb3V0IG9mIHRoZQogICAgICAgICAgICAgICAgLy8gbGlua2VkIGxpc3Qgb2YgY2FsbGJhY2tzIGlmIGFwcHJvcHJpYXRlLgogICAgICAgICAgICAgICAgb3VyTnMgJiYgKGV2ZW50cyA9IG5vcm1hbGl6ZUV2ZW50cyhldmVudHMsIHRoYXQuX19uYW1lc3BhY2UpKTsKICAgICAgICAgICAgICAgIHZhciBldmVudHNBcnJheSA9IGV2ZW50cyA/IGV2ZW50cy5zcGxpdChldmVudFNwbGl0dGVyKSA6IF8ua2V5cyhjYWxscyk7CiAgICAgICAgICAgICAgICB3aGlsZShldmVudCA9IGV2ZW50c0FycmF5LnNoaWZ0KCkpIHsKICAgICAgICAgICAgICAgICAgICBuZCA9IGdldE5hbWVzcGFjZURhdGEoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgIGV2ZW50ID0gbmQuZXZlbnQ7CiAgICAgICAgICAgICAgICAgICAgbmFtZXNwYWNlID0gbmQubmFtZXNwYWNlOwogICAgICAgICAgICAgICAgICAgIGhhc05zID0gISFuYW1lc3BhY2U7CiAgICAgICAgICAgICAgICAgICAgaWYoIW91ck5zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBjYWxsc1tldmVudF07CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYWxsc1tldmVudF07CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGNhbGxzW2V2ZW50XSkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gY2FsbHNbZXZlbnRdW291ck5zXTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2V2ZW50XVtvdXJOc107CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHNpemUoY2FsbHNbZXZlbnRdKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2V2ZW50XTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZighbm9kZSB8fCAhKGNhbGxiYWNrIHx8IGNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvKmlmIChldmVudCAhPT0gU1RBUkFMTCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGNhbGxzW2V2ZW50XTsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2FsbHNbZXZlbnRdOwogICAgICAgICAgICAgICAgICAgIGlmICghbm9kZSkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfSovCiAgICAgICAgICAgICAgICAgICAgaWYoZXZlbnQgIT09IFNUQVJBTEwgJiYgIWNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9vZmZQcm9jZXNzTm9kZSh0aGF0LCBldmVudCwgbm9kZSwgY2FsbGJhY2ssIGNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihldmVudCA9PT0gQUxMIHx8ICFjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGkgaW4gY2FsbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGhhc05zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gY2FsbHNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9vZmZQcm9jZXNzTm9kZSh0aGF0LCBpLCBub2RlLCBjYWxsYmFjaywgY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBfb2ZmUHJvY2Vzc05vZGUodGhhdCwgZXZlbnQsIG5vZGUsIGNhbGxiYWNrLCBjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhhdDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX19wdWJTdWJOYW1lOiAvKioKICAgICAgICAgICAgVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAgICAgICAgIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAgICAgICAgICh1bmxlc3MgeW91J3JlIGxpc3RlbmluZyBvbiBgImFsbCJgLCB3aGljaCB3aWxsIGNhdXNlIHlvdXIgY2FsbGJhY2sgdG8KICAgICAgICAgICAgcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgICAgICAgICAKICAgICAgICAgICAgQG1ldGhvZCBmaXJlCiAgICAgICAgICAgIEBwYXJhbSB7T2JqZWN0fSBldmVudHMgVGhlIGV2ZW50cyB0byBiZSBmaXJlZC4KICAgICAgICAgICAgZGVsaW1pdGVkIGJ5IGEgc3BhY2UuCiAgICAgICAgICAgIEBwYXJhbSBbYXJnc10qIFRoZSBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSBjYWxsYmFjayBtZXRob2RzLgogICAgICAgICAgICBAcmV0dXJucyB7QXJyYXkgb2YgVmFsdWVzfSBJZiBtb3JlIHRoYW4gb24gZXZlbnQgaXMgZmlyZWQsIGFuIE9iamVjdCBvZiBBcnJheXMgaXMgcmV0dXJuZWQuCiAgICAgICAgICAgICoqLwogICAgICAgICAgICAnRXZlbnRzJywKICAgICAgICAgICAgaW5pdEV2ZW50czogLyoqCiAgICAgICAgICAgIEluaXQncyB0aGUgRXZlbnQgbW9kdWxlLgogICAgICAgICAgICBUaGlzIGlzIG9ubHkgcmVxdWlyZWQgaWYgeW91IHdpc2ggdG8gdXNlIGZpcmUuYXN5bmMsIGFuZCBuYW1lc3BhY2luZy4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2QgaW5pdEV2ZW50cwogICAgICAgICAgICBAY2hhaW5hYmxlCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBmdW5jdGlvbiAoZGVmYXVsdENvbnRleHQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZmlyZSA9IHRoaXMucHVibGlzaCA9IGNyZWF0ZUFzeW5jRXZlbnQodGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLmluaXRFdmVudHMgPSBub29wOwogICAgICAgICAgICAgICAgdGhpcy5fX3B1YlN1Yk5hbWUgPSB0aGlzLm5hbWUgfHwgJ0V2ZW50cyc7CiAgICAgICAgICAgICAgICBpZih0aGlzLm5hbWUgJiYgIXRoaXMuX19uYW1lc3BhY2UpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9fbmFtZXNwYWNlID0gJy4nICsgdGhpcy5uYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5fX2RlZmF1bHRDb250ZXh0ID0gZGVmYXVsdENvbnRleHQ7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZXh0ZW5kOiAvKioKICAgICAgICAgICAgRXh0ZW5kcyBFdmVudHMgaW50byB0aGUgZ2l2ZW4gb2JqZWN0LgogICAgICAgICAgICAKICAgICAgICAgICAgQG1ldGhvZCBleHRlbmQKICAgICAgICAgICAgQHBhcmFtIHtPYmplY3R9IHRvIFRoZSBvYmplY3Qgb3QgZXh0ZW5kIGV2ZW50cyBvbnRvCiAgICAgICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gW2luaXRdIE9wdGlvbmFsbHkgaW5pdCB0aGUgZXZlbnRzLgogICAgICAgICAgICAqKi8KICAgICAgICAgICAgZnVuY3Rpb24gKHRvLCBpbml0KSB7CiAgICAgICAgICAgICAgICBfLmV4dGVuZCh0bywgZXhwb3J0cy5FdmVudHMpOwogICAgICAgICAgICAgICAgZGVsZXRlIHRvLmV4dGVuZDsKICAgICAgICAgICAgICAgIGluaXQgJiYgdG8uaW5pdEV2ZW50cygpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRvOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBldmVudHMuZmlyZSA9IGV2ZW50cy5wdWJsaXNoID0gY3JlYXRlQXN5bmNFdmVudCh7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGV2ZW50czsKICAgIH0pKCk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWV2ZW50cy5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9mYWNhZGUnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC91dGlsJywgJy4vY2Fwc3VsZSddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXywgX190bV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSJpbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgdG0gPSBfX3RtX187CgogICAgdmFyIE1vZHVsZSA9IHRtLk1vZHVsZTsKICAgIC8qKgogICAgCiAgICBUaGUgRmFjYWRlIG1vZHVsZSBvZmZlcnMgdGhlIGFiaWxpdHkgdG8gY3JlYXRlIGFuIGludGVyZmFjZSBvciBzaW1pbGFyIGNvbmNlcHQuCiAgICBXaXRoIHRoZSBGYWNhZGUgaW4gdGhydXN0LCBpdCBhbGxvd3MgeW91IHRvIGNhcHR1cmUgZXZlbnRzIGZyb20gYSBtb2R1bGUsIHdoZW4gbG9hZGVkIHZpYSBjb252ZW50aW9uLgogICAgRmFjYWRlcyBhcmUgbWFpbmx5IGZvciB1c2UgaW4gdGhydXN0IHBsdWdpbnMuCiAgICAKICAgIEBtb2R1bGUgdGhydXN0CiAgICAqKi8KICAgIC8qKgogICAgRmFjYWRlcyBhcmUgbWFpbmx5IGZvciB1c2UgaW4gdGhydXN0IHBsdWdpbnMuCiAgICAKICAgIEZhY2FkZSBoYXMgdGhlc2UgYnVpbHQgaW4gbWV0aG9kczoKICAgICogaW5pdAogICAgKiBzdGFydAogICAgKiByZWFkeQogICAgKiBzdG9wCiAgICAqIGRlc3Ryb3kKICAgIAogICAgQmVoaW5kIHRoZSBzY2VuZXMgdGhlIGZhY2FkZSBtZXRob2RzLCBpbnZva2UgYW55IGNvbnZlbnRpb25zIGxvYWRlZCBmb3IgdGhlIHBsdWdpbi4KICAgIAogICAgQGNsYXNzIHRocnVzdC5GYWNhZGUKICAgICoqLwogICAgdmFyIHRocnVzdENhY2hlID0gTW9kdWxlLnRocnVzdENhY2hlOwogICAgdmFyIGZhY2FkZU1ldGhvZHMgPSBbCiAgICAgICAgJ2luaXQnLCAKICAgICAgICAnc3RhcnQnLCAKICAgICAgICAncmVhZHknLCAKICAgICAgICAnc3RvcCcsIAogICAgICAgICdkZXN0cm95JwogICAgXSwgZGVmYXVsdFByb3RvdHlwZSA9IHsKICAgIH07CiAgICBmdW5jdGlvbiBjb252ZW50aW9uRnVuY3Rpb25GYWN0b3J5KG5hbWUpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgcmV0dXJuVmFsdWVzID0gW107CiAgICAgICAgICAgIGlmKG0gJiYgISgobSkuY29udmVudGlvbikpIHsKICAgICAgICAgICAgICAgIG0gPSB0aHJ1c3RDYWNoZVttLm1pZF0ubW9kdWxlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoYXQuX19jb252ZW50aW9ucykgewogICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwuc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIG5hbWUsIG0sIHRoYXQpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIG1ldGhvZFdyYXAobWV0aG9kKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChmKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgZi5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgcmV0dXJuIG1ldGhvZC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9OwogICAgfQogICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IGZhY2FkZU1ldGhvZHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IGZhY2FkZU1ldGhvZHNbaV07CiAgICAgICAgZGVmYXVsdFByb3RvdHlwZVttZXRob2RdID0gY29udmVudGlvbkZ1bmN0aW9uRmFjdG9yeShtZXRob2QpOwogICAgfQogICAgLyoqCiAgICBGYWNhZGUgaW5pdAogICAgCiAgICBDYWxsZWQgZHVyaW5nIHRoZSBpbml0IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCiAgICAKICAgIEBtZXRob2QgaW5pdAogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgc3RhcnQKICAgIAogICAgQ2FsbGVkIGR1cmluZyB0aGUgc3RhcnQgcGhhc2Ugb2YgYSBtb2R1bGUgc3RhcnR1cC4KICAgIAogICAgQG1ldGhvZCBzdGFydAogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgcmVhZHkKICAgIAogICAgQ2FsbGVkIGR1cmluZyB0aGUgcmVhZHkgcGhhc2Ugb2YgYSBtb2R1bGUgc3RhcnR1cC4KICAgIAogICAgQG1ldGhvZCByZWFkeQogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgc3RvcAogICAgCiAgICBDYWxsZWQgZHVyaW5nIHRoZSBpbml0IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCiAgICAKICAgIEBtZXRob2Qgc3RvcAogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgZGVzdHJveQogICAgCiAgICBDYWxsZWQgZHVyaW5nIHRoZSBkZXN0cm95IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCiAgICAKICAgIEBtZXRob2QgZGVzdHJveQogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBBTUQgQVBJCiAgICBsb2FkCiAgICAKICAgIEhhbmRsZXMgZmV0Y2hpbmcgb2YgYSBtb2R1bGUgaW5zdGFuY2UKICAgIAogICAgRm9ybWF0OgogICAgdGhydXN0L2NhcHN1bGUhe2luc3RhbmNlfTp7cGx1Z2luTmFtZX06e2hhc2hLZXl9CiAgICAKICAgIGhhc0tleTogaXMgYSB1bmlxdWUga2V5LCB0aGF0IHRoZSBtb2R1bGUgc2hhcmVzIHdpdGggdGhlIGZhY2FkZSwgYWxsb3dzIGZvciBkZWZpbmluZyBkZXBlbmRlbmNpZXMKICAgIGluIHlvdXIgZGVmaW5lIGJsb2NrLCBhbmQgZ2V0IGFjY2VzcyB0byB0aGUgbW9kdWxlcyBmYWNhZGUuCiAgICAKICAgIEBtZXRob2QgbG9hZAogICAgQHN0YXRpYwogICAgQG9ic29sZXRlCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UgdGhhdCBpcyBiZWluZyBmZXRjaGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBwYXJlbnRSZXF1aXJlIHRoZSByZXF1aXJlIG1ldGhvZCB0byBiZSBsb2FkZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IGxvYWQgQWxsb3dzIHRoZSBsb2FkIHRvIGluZm9ybSB0aGF0IEFNRCBmb3IgdGhlIHZhbHVlIHRvIGhhbmQgb2ZmCiAgICBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSBjdXN0b20gY29uZmlndXJhdGlvbi4KICAgICoqLwogICAgZnVuY3Rpb24gbG9hZChuYW1lLCBwYXJlbnRSZXF1aXJlLCBsb2FkLCBjb25maWcpIHsKICAgICAgICB2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCc6JyksIGluc3RhbmNlTmFtZSA9IHBhcnRzWzBdLCBwbHVnaW4gPSBwYXJ0c1sxXSwgcGx1Z2luTmFtZSA9IHBsdWdpbi5zdWJzdHJpbmcocGx1Z2luLmxhc3RJbmRleE9mKCcvJykgKyAxIHx8IDApLCBoYXNoS2V5ID0gcGFydHNbMl07CiAgICAgICAgaWYoIWluc3RhbmNlTmFtZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2luc3RhbmNlTmFtZSBpcyByZXF1aXJlZCEnKTsKICAgICAgICB9CiAgICAgICAgaWYoIXBsdWdpbk5hbWUpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdwbHVnaW5OYW1lIGlzIHJlcXVpcmVkIScpOwogICAgICAgIH0KICAgICAgICBpZighaGFzaEtleSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2hhc2hLZXkgaXMgcmVxdWlyZWQhJyk7CiAgICAgICAgfQogICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAndGhydXN0IScgKyBpbnN0YW5jZU5hbWUKICAgICAgICBdLCBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIHZhciB0aHJ1c3RQbHVnaW4gPSB0aHJ1c3RbcGx1Z2luTmFtZV07CiAgICAgICAgICAgIGlmKCF0aHJ1c3RQbHVnaW4pIHsKICAgICAgICAgICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAgICAgICAgIHBsdWdpbgogICAgICAgICAgICAgICAgXSwgZnVuY3Rpb24gKHApIHsKICAgICAgICAgICAgICAgICAgICBsb2FkKHApOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRocnVzdE1vZHVsZUNhY2hlSXRlbSA9IHRocnVzdENhY2hlW2hhc2hLZXldIHx8ICh0aHJ1c3RDYWNoZVtoYXNoS2V5XSA9IHsKICAgICAgICAgICAgICAgIGZhY2FkZXM6IHsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBpbnN0YW5jZTogewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIGZhY2FkZSA9IHRocnVzdFBsdWdpbi5jcmVhdGVGYWNhZGUodGhydXN0LCB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0uaW5zdGFuY2UsIHRocnVzdE1vZHVsZUNhY2hlSXRlbS5mYWNhZGVzKTsKICAgICAgICAgICAgbG9hZChmYWNhZGUpOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5sb2FkID0gbG9hZDsKICAgIGZ1bmN0aW9uIGNyZWF0ZUZhY2FkZShpbml0TWV0aG9kKSB7CiAgICAgICAgdmFyIGYgPSAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgRmFjYWRlID0gZnVuY3Rpb24gKG1vZCkgewogICAgICAgICAgICAgICAgaW5pdE1ldGhvZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IGZhY2FkZU1ldGhvZHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1ldGhvZCA9IGZhY2FkZU1ldGhvZHNbaV07CiAgICAgICAgICAgICAgICAgICAgaWYodGhpc1ttZXRob2RdICE9PSBkZWZhdWx0UHJvdG90eXBlW21ldGhvZF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1ttZXRob2RdID0gXy53cmFwKHRoaXNbbWV0aG9kXSwgbWV0aG9kV3JhcChkZWZhdWx0UHJvdG90eXBlW21ldGhvZF0pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLm1vZCA9IG1vZDsKICAgICAgICAgICAgICAgIC8vdGhpcy5pbml0KG1vZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICBGYWNhZGUucHJvdG90eXBlID0gXy5leHRlbmQoewogICAgICAgICAgICAgICAgdXBkYXRlRmFjYWRlOiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgICAgICAgICBpbml0TWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIGRlZmF1bHRQcm90b3R5cGUpOwogICAgICAgICAgICByZXR1cm4gRmFjYWRlOwogICAgICAgIH0pKCk7CiAgICAgICAgcmV0dXJuIGY7CiAgICB9CiAgICBleHBvcnRzLmNyZWF0ZUZhY2FkZSA9IGNyZWF0ZUZhY2FkZTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9ZmFjYWRlLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2NvbnZlbnRpb24vYXV0b3N0YXJ0JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbiddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiovCiAgICAvKioKICAgICogIyBfX3RocnVzdC9tZWRpYXRvcl9fIENvbnZlbnRpb24gLSBBdXRvIFN0YXJ0CiAgICAqCiAgICAqIFRoZSBhdXRvIHN0YXJ0IHByb3BlcnR5IGFsbG93cyBmb3IgYSBtb2R1bGUsIHRvIGJlIGF1dG9tYXRpY2FsbHkgc3RhcnRlZCBvbmNlIGl0IGlzCiAgICAqIGluY2x1ZGVkIGludG8gYSB0aHJ1c3QgaW5zdG5hY2UsIHdpdGhvdXQgaGF2aW5nIHRvIGV4cGxpY2l0eSBjYWxsIHN0YXJ0IG9uIHRoZSBtb2R1bGUuCiAgICAqCiAgICAqCiAgICAqIFRoaXMgaXMgdXNlZnVsIGZvciBjZXJ0aWFuIHR5cGVzIG9mIG1vZHVsZXMsIHVzdWFsbHkgcGVyc2lzdGFudCBvbmVzIHRoYXQgYWx3YXlzIG5lZWQgdG8gbG9hZCByZWdhcmRsZXNzLgogICAgKiBGb3IgZXhhbXBsZSBhIG5hdmlnYXRpb24gbW9kdWxlLCBvciB1c2VyIHNldHRpbmdzIG1vZHVsZS4KICAgICoKICAgICogQGZvciB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiBAcHJvcGVydHkgYXV0b1N0YXJ0CiAgICAqKi8KICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgJ2NvbmZpZy5hdXRvU3RhcnQnCiAgICAgICAgXQogICAgfTsKICAgIGV4cG9ydHMuYXV0b3N0YXJ0ID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWF1dG9zdGFydC5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9jb252ZW50aW9uL2NvbnRhaW5lcicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL21lZGlhdG9yL21lZGlhdG9yLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiovCiAgICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgIGFueUNvbnRhaW5lcjogJ3RocnVzdC9jb252ZW50aW9uL2NvbnRhaW5lci9hbnknLAogICAgICAgIGNoYW5nZUNvbnRhaW5lcjogJ3RocnVzdC9jb252ZW50aW9uL2NvbnRhaW5lci9jaGFuZ2UnCiAgICB9LCBhbnkgPSBfLmFueSwgYmluZCA9IF8uYmluZCwgQ09OVEFJTkVSID0gJ2NvbmZpZy5jb250YWluZXInLCBTVEFSVCA9ICdzdGFydC1zdGF0dXMnLCBkZWZlciA9IF8uZGVmZXI7CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBwcm9wZXJ0aWVzOiBbCiAgICAgICAgICAgIENPTlRBSU5FUgogICAgICAgIF0sCiAgICAgICAgY2hhbmdlOiBmdW5jdGlvbiAobW9kLCBjb250YWluZXIpIHsKICAgICAgICAgICAgdmFyIGNvbnRhaW5lclZhbHVlID0gbW9kLmNvbnZlbnRpb24oQ09OVEFJTkVSKTsKICAgICAgICAgICAgaWYoY29udGFpbmVyVmFsdWUgJiYgY29udGFpbmVyICYmIGNvbnRhaW5lclZhbHVlID09PSBjb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGlmKG1vZC5jb252ZW50aW9uKFNUQVJUKSkgewogICAgICAgICAgICAgICAgICAgIGRlZmVyKGJpbmQobW9kLnN0b3AsIG1vZCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBzdGFydDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGNvbnRhaW5lclZhbHVlID0gbW9kLmNvbnZlbnRpb24oQ09OVEFJTkVSKTsKICAgICAgICAgICAgaWYoY29udGFpbmVyVmFsdWUpIHsKICAgICAgICAgICAgICAgIGZhY2FkZXMubWVkaWF0b3IuZmlyZShldmVudC5jaGFuZ2VDb250YWluZXIsIGNvbnRhaW5lclZhbHVlKTsKICAgICAgICAgICAgICAgIC8vIFN1YnNjcmlwdGlvbnMgZ2V0IHVuc3Vic2NyaWJlZCB3aGVuIHN0b3BwaW5nIGEgbW9kdWxlLCBzbyB3ZSBuZWVkIHRvIHJlc3Vic2NyaWJlIGV2ZXJ5IHRpbWUgaGVyZS4KICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgcHJvYmFibHkgYmV0dGVyLCBhcyB0aGUgZXZlbnRzIHdpbGwgYmUgbGVzcyBjaGF0dHkuCiAgICAgICAgICAgICAgICBmYWNhZGVzLm1lZGlhdG9yLnN1YnNjcmliZShldmVudC5jaGFuZ2VDb250YWluZXIsIGJpbmQodGhhdC5jaGFuZ2UsIHRoYXQsIG1vZCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuY29udGFpbmVyID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWNvbnRhaW5lci5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9jb252ZW50aW9uL2RlcGVuZGVudC5tb2R1bGVzJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0Lm1lZGlhdG9yCiAgICBAc3VibW9kdWxlIHRocnVzdC5tZWRpYXRvci5jb252ZW50aW9uCiAgICAqKi8KICAgICAgICB2YXIgYW55ID0gXy5hbnksIG1hcCA9IF8ubWFwLCBETU9EVUxFUyA9ICdjb25maWcuZGVwZW5kZW50TW9kdWxlcycsIENNT0RVTEVTID0gJ2NvbmZpZy5jaGlsZE1vZHVsZXMnLCBTVEFSVCA9ICdzdGFydC1zdGF0dXMnLCBkZWZlciA9IF8uZGVmZXIsIGJpbmQgPSBfLmJpbmQ7CiAgICB2YXIgaW52b2tlZGVwZW5kZW50TW9kdWxlcyA9IGZ1bmN0aW9uIChtb2QsIG1ldGhvZCkgewogICAgICAgIHZhciByZXF1aXJlZE1vZHVsZXMgPSBtb2QuY29udmVudGlvbihETU9EVUxFUyk7CiAgICAgICAgaWYocmVxdWlyZWRNb2R1bGVzKSB7CiAgICAgICAgICAgIHJldHVybiBtb2QudGhydXN0W21ldGhvZF0ocmVxdWlyZWRNb2R1bGVzKTsKICAgICAgICB9CiAgICB9OwogICAgdmFyIGludm9rZUNoaWxkTW9kdWxlcyA9IGZ1bmN0aW9uIChtb2QsIG1ldGhvZCkgewogICAgICAgIHZhciByZXF1aXJlZE1vZHVsZXMgPSBtb2QuY29udmVudGlvbihDTU9EVUxFUyk7CiAgICAgICAgaWYocmVxdWlyZWRNb2R1bGVzKSB7CiAgICAgICAgICAgIHJldHVybiBtb2QudGhydXN0W21ldGhvZF0ocmVxdWlyZWRNb2R1bGVzKTsKICAgICAgICB9CiAgICB9OwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBETU9EVUxFUywgCiAgICAgICAgICAgIENNT0RVTEVTCiAgICAgICAgXSwKICAgICAgICBzdGFydDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgaW52b2tlZGVwZW5kZW50TW9kdWxlcyhtb2QsICdzdGFydCcpLCAKICAgICAgICAgICAgICAgIGludm9rZUNoaWxkTW9kdWxlcyhtb2QsICdzdGFydCcpCiAgICAgICAgICAgIF07CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICBpZighbW9kLnRocnVzdC5zdGFydGVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgICAgIGludm9rZWRlcGVuZGVudE1vZHVsZXMobW9kLCAncmVhZHknKSwgCiAgICAgICAgICAgICAgICAgICAgaW52b2tlQ2hpbGRNb2R1bGVzKG1vZCwgJ3JlYWR5JykKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHN0b3A6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgcmV0dXJuIGludm9rZUNoaWxkTW9kdWxlcyhtb2QsICdzdG9wJyk7CiAgICAgICAgfSwKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAobW9kLCBmYWNhZGVzKSB7CiAgICAgICAgICAgIHJldHVybiBpbnZva2VDaGlsZE1vZHVsZXMobW9kLCAnZGVzdHJveScpOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLmRlcGVuZGVudE1vZHVsZXMgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9ZGVwZW5kZW50Lm1vZHVsZXMuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvbWVkaWF0b3IvY29uZmlnJyxbInJlcXVpcmUiLCAiZXhwb3J0cyJdLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgLyoqCiAgICBQcm92aWRlcyB0aHJ1c3QgY29uZmlndXJhdGlvbgogICAgCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luLgogICAgCiAgICBUaGlzIGlzIGZvciBpbnRlcm5hbCB0aHJ1c3QgdXNlLiAgVGhydXN0IHVzZXMgdGhpcyBhcnJheSB0byBnZW5lcmF0ZSB0aGUgcHJvcGVydGllcyB0aGF0IG5lZWQgdG8gYmUgaGFuZGVkCiAgICB0byB0aGUgcGx1Z2luIGNvbnN0cnVjdG9yIG1ldGhvZC4KICAgIAogICAgQGZvciB0aHJ1c3QubWVkaWF0b3IuY29uZmlnCiAgICBAcHJpdmF0ZQogICAgQHByb3BlcnR5IHJlc29sdmUKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLnJlc29sdmUgPSBbCiAgICAgICAgJ25hbWUnLCAKICAgICAgICAnY2ZnJwogICAgXTsKICAgIC8qKgogICAgVGhlIHNldCBvZiBjb252ZW50aW9ucyB0byBsb2FkIGludG8gdGhydXN0L21lZGlhdG9yLgogICAgCiAgICBAcHJvcGVydHkgY29udmVudGlvbnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLmNvbnZlbnRpb25zID0gWwogICAgICAgICd0aHJ1c3QvbWVkaWF0b3IvY29udmVudGlvbi9zdWJzY3JpcHRpb24nCiAgICBdOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb25maWcuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvbWVkaWF0b3IvY29udmVudGlvbi9zdWJzY3JpcHRpb24nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9jb252ZW50aW9uL3N1YnNjcmlwdGlvbi5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9tZWRpYXRvci5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIC8qKgogICAgVGhlIGZhY2FkZSBjb252ZW50aW9uLCBjcmVhdGVzIHRoZSBtZWRpYXRvciBmYWNhZGUgZm9yIGVhY2ggbW9kdWxlLgogICAgCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiovCiAgICAgICAgdmFyIFNVQlNDUklQVElPTlMgPSAnY29uZmlnLm1lZGlhdG9yLnN1YnNjcmlwdGlvbnMnLCBpc0Z1bmN0aW9uID0gXy5pc0Z1bmN0aW9uLCBpc1N0cmluZyA9IF8uaXNTdHJpbmcsIGlzQXJyYXkgPSBfLmlzQXJyYXksIGlzT2JqZWN0ID0gXy5pc09iamVjdCwgaXNQbGFpbk9iamVjdCA9IF8uaXNQbGFpbk9iamVjdCwgZm9yT3duID0gXy5mb3JPd24sIGVhY2ggPSBfLmVhY2g7CiAgICB2YXIgYXJyYXlTaG9ydEhhbmRBcmdzSW5PcmRlciA9IFsKICAgICAgICAnaGFuZGxlcicsIAogICAgICAgICdjb250ZXh0JwogICAgXTsKICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgU1VCU0NSSVBUSU9OUwogICAgICAgIF0sCiAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgc3Vic2NyaXB0aW9ucyA9IG1vZC5jb252ZW50aW9uKFNVQlNDUklQVElPTlMpOwogICAgICAgICAgICBpZihzdWJzY3JpcHRpb25zICYmICEoc3Vic2NyaXB0aW9ucykuX3N1YnNjcmlwdGlvbnNTZXQpIHsKICAgICAgICAgICAgICAgIHZhciBtb2R1bGVJbnN0YW5jZSA9IG1vZC5pbnN0YW5jZTsKICAgICAgICAgICAgICAgIGZvck93bihzdWJzY3JpcHRpb25zLCBmdW5jdGlvbiAoc3Vic2NyaXB0aW9uQ29sbGVjdGlvbiwgc3Vic2NyaXB0aW9uTmFtZSkgewogICAgICAgICAgICAgICAgICAgIGlmKCFpc0FycmF5KHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uQ29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgXQogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihzdWJzY3JpcHRpb25Db2xsZWN0aW9uLmxlbmd0aCAmJiAoIWlzQXJyYXkoc3Vic2NyaXB0aW9uQ29sbGVjdGlvblswXSkgfHwgaXNTdHJpbmcoc3Vic2NyaXB0aW9uQ29sbGVjdGlvblswXSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb25Db2xsZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVhY2goc3Vic2NyaXB0aW9uQ29sbGVjdGlvbiwgZnVuY3Rpb24gKHN1YnNjcmlwdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZihpc0FycmF5KHN1YnNjcmlwdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vbmV3U3Vic2NyaXB0aW9uLnB1c2guYXBwbHkobmV3U3Vic2NyaXB0aW9uLCBzdWJzY3JpcHRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWFjaChzdWJzY3JpcHRpb24sIGZ1bmN0aW9uIChoYW5kbGVyT2JqZWN0LCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1N1YnNjcmlwdGlvbiA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uTmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNTdHJpbmcoaGFuZGxlck9iamVjdCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2gobW9kLmluc3RhbmNlW2hhbmRsZXJPYmplY3RdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc3Vic2NyaXB0aW9uW2kgKyAxXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2goc3Vic2NyaXB0aW9uW2kgKyAxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9yZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGlzRnVuY3Rpb24oaGFuZGxlck9iamVjdCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2goaGFuZGxlck9iamVjdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHN1YnNjcmlwdGlvbltpICsgMV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1N1YnNjcmlwdGlvbi5wdXNoKHN1YnNjcmlwdGlvbltpICsgMV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihpc1BsYWluT2JqZWN0KGhhbmRsZXJPYmplY3QpICYmICgnbW9kdWxlSGFuZGxlcicgaW4gaGFuZGxlck9iamVjdCB8fCAnaGFuZGxlcicgaW4gaGFuZGxlck9iamVjdCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9uZXdTdWJzY3JpcHRpb24gPSBbc3Vic2NyaXB0aW9uTmFtZV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCdtb2R1bGVIYW5kbGVyJyBpbiBoYW5kbGVyT2JqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTdWJzY3JpcHRpb24ucHVzaChtb2QuaW5zdGFuY2VbaGFuZGxlck9iamVjdC5tb2R1bGVIYW5kbGVyXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoJ2hhbmRsZXInIGluIGhhbmRsZXJPYmplY3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlzU3RyaW5nKGhhbmRsZXJPYmplY3QpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2gobW9kLmluc3RhbmNlW2hhbmRsZXJPYmplY3QuaGFuZGxlcl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTdWJzY3JpcHRpb24ucHVzaChoYW5kbGVyT2JqZWN0LmhhbmRsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCdjb250ZXh0JyBpbiBoYW5kbGVyT2JqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTdWJzY3JpcHRpb24ucHVzaChoYW5kbGVyT2JqZWN0LmNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKG5ld1N1YnNjcmlwdGlvbi5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhY2FkZS5zdWJzY3JpYmUuYXBwbHkoZmFjYWRlLCBuZXdTdWJzY3JpcHRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIG1vZC5jb252ZW50aW9uKFNVQlNDUklQVElPTlMpLl9zdWJzY3JpcHRpb25zU2V0ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBzdWJzY3JpcHRpb25zID0gbW9kLmNvbnZlbnRpb24oU1VCU0NSSVBUSU9OUyk7CiAgICAgICAgICAgIGlmKHN1YnNjcmlwdGlvbnMgJiYgc3Vic2NyaXB0aW9ucy5fc3Vic2NyaXB0aW9uc1NldCkgewogICAgICAgICAgICAgICAgbW9kLmNvbnZlbnRpb24oU1VCU0NSSVBUSU9OUykuX3N1YnNjcmlwdGlvbnNTZXQgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLnN1YnNjcmlwdGlvbiA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1zdWJzY3JpcHRpb24uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YS9jb25maWcnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICAvKioKICAgIFByb3ZpZGVzIHRocnVzdCBjb25maWd1cmF0aW9uCiAgICAKICAgIEBtb2R1bGUgdGhydXN0LmRhdGEKICAgIEBzdWJtb2R1bGUgdGhydXN0LmRhdGEuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luLgogICAgCiAgICBUaGlzIGlzIGZvciBpbnRlcm5hbCB0aHJ1c3QgdXNlLiAgVGhydXN0IHVzZXMgdGhpcyBhcnJheSB0byBnZW5lcmF0ZSB0aGUgcHJvcGVydGllcyB0aGF0IG5lZWQgdG8gYmUgaGFuZGVkCiAgICB0byB0aGUgcGx1Z2luIGNvbnN0cnVjdG9yIG1ldGhvZC4KICAgIAogICAgQGZvciB0aHJ1c3QuZGF0YS5jb25maWcKICAgIEBwcml2YXRlCiAgICBAcHJvcGVydHkgcmVzb2x2ZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMucmVzb2x2ZSA9IFsKICAgICAgICAnbmFtZScsIAogICAgICAgICdtZWRpYXRvcicsIAogICAgICAgICdjZmcnCiAgICBdOwogICAgLyoqCiAgICBUaGUgc2V0IG9mIGNvbnZlbnRpb25zIHRvIGxvYWQgaW50byB0aHJ1c3QvZG9tLgogICAgCiAgICBAcHJvcGVydHkgY29udmVudGlvbnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLmNvbnZlbnRpb25zID0gWwogICAgICAgICd0aHJ1c3QvZGF0YS9jb252ZW50aW9uL3N0YXJ0JwogICAgXTsKICAgIC8qKgogICAgRGVjaWRlcyBpZiBgdGhydXN0L2RhdGFgIHNob3VsZCBjYWNoZSByZXF1ZXN0cyBvciBub3QuCiAgICAKICAgIFlvdSBzaG91bGQgdHVybiB0aGlzIHRvIGBmYWxzZWAsIGlmIHlvdSBhcmUgZXhwZXJpZW5jaW5nIGNhY2hpbmcgaXNzdWVzIGFuZCBuZWVkIHRvIGRlYnVnLgogICAgCiAgICBAcHJvcGVydHkgY2FjaGUKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAZGVmYXVsdCB0cnVlCiAgICAqKi8KICAgIGV4cG9ydHMuY2FjaGUgPSB0cnVlOwogICAgLyoqCiAgICAqCiAgICAqIGBzdGFydFRpbWVvdXRgIGlzIHBhcnQgb2YgcXVldWVpbmcgYnVpbHQgaW50byBgdGhydXN0L2RhdGFgLiAgSXQgZGVmaW5lcyB0aGUgd2FpdCB0aW1lIGJlZm9yZSByZXF1ZXN0cwogICAgKiBhcmUgc3RhcnRlZC4KICAgICoKICAgICoKICAgICogVGhlIHF1ZXVlaW5nIHN5c3RlbSB3b3JrcyBpbiB0aGUgZm9sbG93aWcgbWFubmVyLiAgQWxsIHJlcXVlc3RzIHRoYXQgYXJlIHF1ZXVlZCB0b2dldGhlciBwZXIgSFRUUAogICAgKiByZXF1ZXN0IG1ldGhvZCAoYEdFVGAsIGBQT1NUYCwgYFBVVGAsIGBERUxFVEVgLCBgUEFUQ0hgLCBldGMpLiAgQWZ0ZXIgdGhlIGZpcnN0IHJlcXVlc3QsIHRoZSB0aW1lcgogICAgKiBzdGFydHMsIG9uY2UgdGhlIHRpbWVvdXQgZWxhcHNlcywgYWxsIHRoZSByZXF1ZXN0cyBhcmUgc2hpcHBlZCBvZmYgYXQgb25jZS4KICAgICoKICAgICoKICAgICogVGhpcyBjb3VudGVyIGludHVpdGl2ZSBpZiB5b3UncmUgbG9va2luZyB0byBnZXQgdGhlIHJlcXVlc3QgYmFjayBpbW1lZGlhdGVseSwgYnV0IGZyb20gYSBVWCBwZXJzcGVjdGl2ZQogICAgKiB0aGlzIGFsbG93cyB0aGUgVUkgdG8gc3RheSBpbiBzeW5jIGFuZCBnaXZlIHRoZSB1c2VyIGEgY29oZXNpdmUsIGluc3RlYWQgb2Ygc2VlaW5nIGxvYWRlcnMsIHNob3cgdXAgYW5kCiAgICAqIGRpc2FwcGVhciBhdCBzZWVtaW5nbHkgcmFuZG9tIGludGVydmFscywgdGhlIHVzZXIgZG9lcyBhbiBhY3Rpb24sIGFuZCB0aGVuIHNlZXMgYSByZXNwb25zZS4KICAgICoKICAgICoKICAgICogQHByb3BlcnR5IHN0YXJ0VGltZW91dAogICAgKiBAcmVhZE9ubHkKICAgICogQHR5cGUge051bWJlcn0KICAgICogQGRlZmF1bHQgNTAwCiAgICAqKi8KICAgIGV4cG9ydHMuc3RhcnRUaW1lb3V0ID0gMTAwOwogICAgLyoqCiAgICAqCiAgICAqIGBmaW5pc2hUaW1lb3V0YCBpcyBwYXJ0IG9mIHF1ZXVlaW5nIGJ1aWx0IGludG8gYHRocnVzdC9kYXRhYC4gIEl0IGRlZmluZXMgdGhlIHdhaXQgdGltZSBiZWZvcmUgdGhlCiAgICAqIHF1ZXVlIGlzIGNvbXBsZXRlZC4gIElmIGFsbCB0aGUgcmVxdWVzdHMgZmluaXNoIGVhcmx5LCB0aGUgdGltZW91dCBpcyBjYW5jZWxlZC4KICAgICoKICAgICoKICAgICogVGhlIHF1ZXVlaW5nIHN5c3RlbSB3b3JrcyBpbiB0aGUgZm9sbG93aWcgbWFubmVyLiAgQWxsIHJlcXVlc3RzIHRoYXQgYXJlIHF1ZXVlZCB0b2dldGhlciBwZXIgSFRUUAogICAgKiByZXF1ZXN0IG1ldGhvZCAoYEdFVGAsIGBQT1NUYCwgYFBVVGAsIGBERUxFVEVgLCBgUEFUQ0hgLCBldGMpLiAgQWZ0ZXIgdGhlIHJlcXVlc3RzIGFyZSBmaXJlZCBvZmYKICAgICogYHRocnVzdC9kYXRhYCB3aWxsIHdhaXQgdW50aWwgaXQgZ2V0cyBhIHJlc3BvbnNlIGZyb20gZXZlcnlvbmUgb2YgdGhlbS4gIElmIGZvciBzb21lIHJlYXNvbiBhIHJlcXVlc3QKICAgICogdGFrZXMgdG8gbG9uZywgYW5kIHRoZSB0aW1lb3V0IGlzIGhpdCwgYWxsIHRoZSByZXF1ZXN0cyB0aGF0IGhhdmUgY29tcGxldGVkLCB3aWxsIGJlIHJlbGVhc2VlZCwgYWxsb3dpbmcKICAgICogdGhlIGFwcGxpY2F0aW9uIHRvIGNvbnRpbnVlIHVuZGlzcnVwdGVkLgogICAgKgogICAgKgogICAgKiBUaGlzIGNvdW50ZXIgaW50dWl0aXZlIGlmIHlvdSdyZSBsb29raW5nIHRvIGdldCB0aGUgcmVxdWVzdCBiYWNrIGltbWVkaWF0ZWx5LCBidXQgZnJvbSBhIFVYIHBlcnNwZWN0aXZlCiAgICAqIHRoaXMgYWxsb3dzIHRoZSBVSSB0byBzdGF5IGluIHN5bmMgYW5kIGdpdmUgdGhlIHVzZXIgYSBjb2hlc2l2ZSwgaW5zdGVhZCBvZiBzZWVpbmcgbG9hZGVycywgc2hvdyB1cCBhbmQKICAgICogZGlzYXBwZWFyIGF0IHNlZW1pbmdseSByYW5kb20gaW50ZXJ2YWxzLCB0aGUgdXNlciBkb2VzIGFuIGFjdGlvbiwgYW5kIHRoZW4gc2VlcyBhIHJlc3BvbnNlLgogICAgKgogICAgKgogICAgQHByb3BlcnR5IGZpbmlzaFRpbWVvdXQKICAgIEByZWFkT25seQogICAgQHR5cGUge051bWJlcn0KICAgIEBkZWZhdWx0IDIwMDAKICAgICoqLwogICAgZXhwb3J0cy5maW5pc2hUaW1lb3V0ID0gMjAwMDsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RhdGEvZXZlbnQudHlwZXMnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8qKgogICAgCiAgICBAbW9kdWxlIHRocnVzdC5kYXRhCiAgICBAZm9yIHRocnVzdC5kYXRhCiAgICAqKi8KICAgIC8qKgogICAgVGhlIGB0aHJ1c3QvZGF0YS93YWl0YCBldmVudCBpcyBmaXJlZCBvbmNlIGEgZGF0YSBjYWxsIGlzIG1hZGUuCiAgICAKICAgIEBldmVudCB0aHJ1c3QvZGF0YS93YWl0CiAgICBAcGFyYW0ge1N0cmluZ30gcXVlcnlJZCBUaGUgaW50ZXJuYWwgaWQgb2YgdGhlIG91dGJvdW5kIHF1ZXVlLgogICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHR5cGUgb2YgdGhlIG91dGJvdW5kIGV2ZW50IHF1ZXVlIChHZXQvUG9zdC9ldGMpCiAgICAqKi8KICAgIGV4cG9ydHMud2FpdCA9ICd0aHJ1c3QvZGF0YS93YWl0JzsKICAgIC8qKgogICAgVGhlIGB0aHJ1c3QvZGF0YS9zdGFydGAgZXZlbnQgaXMgZmlyZWQgdGhlIHF1ZXVlIGlzIHN0YXJ0ZWQuCiAgICAKICAgIEBldmVudCB0aHJ1c3QvZGF0YS9zdGFydAogICAgQHBhcmFtIHtTdHJpbmd9IHF1ZXJ5SWQgVGhlIGludGVybmFsIGlkIG9mIHRoZSBvdXRib3VuZCBxdWV1ZS4KICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSB0eXBlIG9mIHRoZSBvdXRib3VuZCBldmVudCBxdWV1ZSAoR2V0L1Bvc3QvZXRjKQogICAgQHBhcmFtIHtOdW1iZXJ9IGNvdW50IFRoZSBvdXRnb2luZyBjYWxsIGNvdW50CiAgICAqKi8KICAgIGV4cG9ydHMuc3RhcnQgPSAndGhydXN0L2RhdGEvc3RhcnQnOwogICAgLyoqCiAgICBUaGUgYHRocnVzdC9kYXRhL3N0YXR1c2AgZXZlbnQgaXMgZmlyZWQgZm9yIGV2ZXJ5IGl0ZW0gdGhhdCByZXR1cm5zIGZyb20gdGhlIHF1ZXVlLgogICAgCiAgICBOT1RFOiBJdCBpcyBlbnRpcmVseSBwb3NzaWJsZSBmb3IgYHRocnVzdC9kYXRhL3N0YXR1cyoqIHRvIGJlIGNhbGxlZCBhZnRlciBgdGhydXN0L2RhdGEvc3RvcCoqIGlmIHNldmVyYWwKICAgIGNhbGxzIHRha2UgdG8gbG9uZyB0byBjb21wbGV0ZS4gIFRoaXMgaXMgaW50ZW5kZWQsIGFuZCBwb3RlbnRpYWxseSB1c2VmdWwgaW5mb3JtYXRpb24uCiAgICAKICAgIEBldmVudCB0aHJ1c3QvZGF0YS9zdGF0dXMKICAgIEBwYXJhbSB7U3RyaW5nfSBxdWVyeUlkIFRoZSBpbnRlcm5hbCBpZCBvZiB0aGUgb3V0Ym91bmQgcXVldWUuCiAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdHlwZSBvZiB0aGUgb3V0Ym91bmQgZXZlbnQgcXVldWUgKEdldC9Qb3N0L2V0YykKICAgIEBwYXJhbSB7TnVtYmVyfSBjb3VudCBUaGUgY3VycmVudCBjb21wbGV0ZWQgY2FsbCBjb3VudCBmb3IgdGhpcyBxdWV1ZS4KICAgICoqLwogICAgZXhwb3J0cy5zdGF0dXMgPSAndGhydXN0L2RhdGEvc3RhdHVzJzsKICAgIC8qKgogICAgVGhlIGB0aHJ1c3QvZGF0YS9zdG9wYCBldmVudCBpcyBmaXJlZCB3aGVuIGFsbCBpdGVtcyBpbiB0aGUgcXVldWUgcmV0dXJuLCBvciB0aGUgZmluaXNoZWRUaW1lb3V0IHNldHRpbmcgZWxhcHNlcy4KICAgIAogICAgQGV2ZW50IHRocnVzdC9kYXRhL3N0b3AKICAgIEBwYXJhbSB7U3RyaW5nfSBxdWVyeUlkIFRoZSBpbnRlcm5hbCBpZCBvZiB0aGUgb3V0Ym91bmQgcXVldWUuCiAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdHlwZSBvZiB0aGUgb3V0Ym91bmQgZXZlbnQgcXVldWUgKEdldC9Qb3N0L2V0YykKICAgIEBwYXJhbSB7TnVtYmVyfSBjb3VudCBUaGUgKGN1cnJlbnQpIGNvbXBsZXRlZCBjYWxsIGNvdW50IGZvciB0aGlzIHF1ZXVlLgogICAgKiovCiAgICBleHBvcnRzLnN0b3AgPSAndGhydXN0L2RhdGEvc3RvcCc7CiAgICBleHBvcnRzLmV2ZW50ID0gewogICAgICAgIGJlZm9yZVNlbmQ6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvYmVmb3JlLXNlbmRgIGV2ZW50IGlzIHdyYXBwZWQgYnkgdGhydXN0LCBhbmQgZmlyZWQgdGhyb3VnaCBqUXVlcnkuCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgTk9URTogTWFya2VkIGFzIHByaXZhdGUgYmVjYXVzZSB0aGlzIGV2ZW50IGV4cG9zZXMgdW5kZXJseWluZyBqUXVlcnkgYXJndW1lbnRzLCBhbmQgbWF5CiAgICAgICAgYmUgY2hhbmdlZCBpbiB0aGUgZnV0dXJlLgogICAgICAgIAogICAgICAgIEBldmVudCB0aHJ1c3QvZGF0YS9ldmVudC9iZWZvcmUtc2VuZAogICAgICAgIEBwcml2YXRlCiAgICAgICAgKiovCiAgICAgICAgJ3RocnVzdC9kYXRhL2V2ZW50L2JlZm9yZS1zZW5kJywKICAgICAgICBzdGFydDogLyoqCiAgICAgICAgVGhlIGB0aHJ1c3QvZGF0YS9ldmVudC9zdGFydGAgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3N0YXJ0CiAgICAgICAgQHByaXZhdGUKICAgICAgICAqKi8KICAgICAgICAndGhydXN0L2RhdGEvZXZlbnQvc3RhcnQnLAogICAgICAgIHNlbmQ6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvc2VuZGAgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3NlbmQKICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgICd0aHJ1c3QvZGF0YS9ldmVudC9zZW5kJywKICAgICAgICBlcnJvcjogLyoqCiAgICAgICAgVGhlIGB0aHJ1c3QvZGF0YS9ldmVudC9lcnJvcmAgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L2Vycm9yCiAgICAgICAgQHByaXZhdGUKICAgICAgICAqKi8KICAgICAgICAndGhydXN0L2RhdGEvZXZlbnQvZXJyb3InLAogICAgICAgIHN1Y2Nlc3M6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvc3VjY2Vzc2AgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3N1Y2Nlc3MKICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgICd0aHJ1c3QvZGF0YS9ldmVudC9zdWNlc3MnLAogICAgICAgIGNvbXBsZXRlOiAvKioKICAgICAgICBUaGUgYHRocnVzdC9kYXRhL2V2ZW50L2NvbXBsZXRlYCBldmVudCBpcyB3cmFwcGVkIGJ5IHRocnVzdCwgYW5kIGZpcmVkIHRocm91Z2ggalF1ZXJ5LgogICAgICAgIAogICAgICAgIAogICAgICAgIE5PVEU6IE1hcmtlZCBhcyBwcml2YXRlIGJlY2F1c2UgdGhpcyBldmVudCBleHBvc2VzIHVuZGVybHlpbmcgalF1ZXJ5IGFyZ3VtZW50cywgYW5kIG1heQogICAgICAgIGJlIGNoYW5nZWQgaW4gdGhlIGZ1dHVyZS4KICAgICAgICAKICAgICAgICBAZXZlbnQgdGhydXN0L2RhdGEvZXZlbnQvY29tcGxldGUKICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgICd0aHJ1c3QvZGF0YS9ldmVudC9jb21wbGV0ZScsCiAgICAgICAgc3RvcDogLyoqCiAgICAgICAgVGhlIGB0aHJ1c3QvZGF0YS9ldmVudC9zdG9wYCBldmVudCBpcyB3cmFwcGVkIGJ5IHRocnVzdCwgYW5kIGZpcmVkIHRocm91Z2ggalF1ZXJ5LgogICAgICAgIAogICAgICAgIAogICAgICAgIE5PVEU6IE1hcmtlZCBhcyBwcml2YXRlIGJlY2F1c2UgdGhpcyBldmVudCBleHBvc2VzIHVuZGVybHlpbmcgalF1ZXJ5IGFyZ3VtZW50cywgYW5kIG1heQogICAgICAgIGJlIGNoYW5nZWQgaW4gdGhlIGZ1dHVyZS4KICAgICAgICAKICAgICAgICBAZXZlbnQgdGhydXN0L2RhdGEvZXZlbnQvc3RvcAogICAgICAgIEBwcml2YXRlCiAgICAgICAgKiovCiAgICAgICAgJ3RocnVzdC9kYXRhL2V2ZW50L3N0b3AnCiAgICB9Owp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1ldmVudC50eXBlcy5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kYXRhL2V2ZW50LmZhY3RvcnknLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJywgJy4vZXZlbnQudHlwZXMnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX2V2ZW50VHlwZXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vanF1ZXJ5LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgZXZlbnRUeXBlcyA9IF9fZXZlbnRUeXBlc19fOwoKICAgIHZhciBjYW1lbENhc2UgPSB1dGlsLmNhbWVsQ2FzZSwgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGJpbmQgPSBfLmJpbmQsIGRhdGFFdmVudHMgPSBldmVudFR5cGVzLmV2ZW50LCBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgbWVtb2l6ZSA9IF8ubWVtb2l6ZTsKICAgIC8qKgogICAgVGhlIGV2ZW50IGZhY3RvcnkgbGlua3MgalF1ZXJ5IEV2ZW50cyB1cCB0byB0aHJ1c3QgY2VudHJpYyBldmVudHMuCiAgICBUaGUgZXZlbnQgZmFjdG9yeSB3b3VsZCBiZSByZXBsYWNlZCBpZiB3ZSB3ZXJlIGV2ZXIgbW92ZWQgb2ZmIG9mIHRoZSBqUXVlcnkgZGVwZW5kYW5jeS4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QuZGF0YQogICAgKiovCiAgICB2YXIgZXZlbnRIYW5kbGVycyA9IHsKICAgICAgICAnYmVmb3JlLXNlbmQnOiAvLyBTdXBwb3J0ZWQgZXZlbnQgaGFuZGxlcnMKICAgICAgICB0cnVlLAogICAgICAgICdzZW5kJzogdHJ1ZSwKICAgICAgICAnZXJyb3InOiB0cnVlLAogICAgICAgICdzdWNjZXNzJzogdHJ1ZSwKICAgICAgICAnY29tcGxldGUnOiB0cnVlLAogICAgICAgICdzdGFydCc6IHRydWUsCiAgICAgICAgJ3N0b3AnOiB0cnVlCiAgICB9OwogICAgLyoqCiAgICBXcmFwcyBiZWZvcmVTZW5kLCB3aGljaCBpcyBhIGN1c3RvbSBwcm9wZXJ0eSBvbiB0aGUgalF1ZXJ5IGFqYXggZGF0YSBjYWxsLgogICAgCiAgICBAbWV0aG9kIGJlZm9yZVNlbmRNZXRob2QKICAgIEBwcml2YXRlCiAgICAqKi8KICAgIGZ1bmN0aW9uIGJlZm9yZVNlbmRNZXRob2QoanFYSFIsIHNldHRpbmdzKSB7CiAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi8KICAgICAgICB0aGlzLmZpcmUoZGF0YUV2ZW50c1snYmVmb3JlU2VuZCddLCBqcVhIUiwgc2V0dGluZ3MpOwogICAgfQogICAgZXhwb3J0cy5iZWZvcmVTZW5kTWV0aG9kID0gYmVmb3JlU2VuZE1ldGhvZDsKICAgIHZhciBldmVudEZhY3RvcnkgPSBtZW1vaXplKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHZhciBldnQgPSBkYXRhRXZlbnRzW2V2ZW50XTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KGV2dCk7CiAgICAgICAgICAgIHRoaXMuZmlyZS5hcHBseSh0aGlzLmZpcmUuYXN5bmMsIGFyZ3MpOwogICAgICAgIH07CiAgICB9KTsKICAgIHZhciBub3JtYWxpemVFdmVudHMgPSBmdW5jdGlvbiAoZXZ0cykgewogICAgICAgIGV2dHMgPSBldnRzLnNwbGl0KCcgJyk7CiAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IGV2dHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmKCFldmVudEhhbmRsZXJzW2V2dHNbaV1dKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdFdmVudCAiezB9IiBpcyBub3QgYSB2YWxpZCBkYXRhIGV2ZW50JywgZXZ0c1tpXSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV2dHNbaV0gPSBkYXRhRXZlbnRzW2V2dHNbaV1dOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXZ0cy5qb2luKCcgJyk7CiAgICB9OwogICAgdmFyIHNlbmRFdmVudEZhY3RvcnkgPSBmdW5jdGlvbiAoaSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoZXZlbnQsIGpxWEhSLCBzZXR0aW5ncykgewogICAgICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqLwogICAgICAgICAgICBpZighc2V0dGluZ3MuX19tZWRpYXRvcl9kYXRhX2ZpcmVkX18pIHsKICAgICAgICAgICAgICAgIGpxWEhSLmFib3J0KCk7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgYWJvcnRlZCwgYWxsIGFqYXggY2FsbHMgbXVzdCBwYXNzIHRocm91Z2ggdGhydXN0LWRhdGEuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXNldHRpbmdzLnNpbGVudCkgewogICAgICAgICAgICAgICAgZXZlbnRGYWN0b3J5KGkpLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfTsKICAgIC8qKgogICAgQmluZHMgYWxsIHRoZSBqUXVlcnkgZGF0YSBldmVudHMgYW5kIGNyZWF0ZXMgZXZlbnQgbmF0aXZlIHRocnVzdCBldmVudHMgb3V0IG9mIHRoZW0uCiAgICAKICAgIEBmb3IgdGhydXN0LmRhdGEKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIGluaXQKICAgIEBwYXJhbSB7alF1ZXJ5fSBBIGpRdWVyeSBpbnN0YW5jZSB3cmFwcGluZyAnZG9jdW1lbnQnCiAgICAqKi8KICAgIGZ1bmN0aW9uIGluaXQoakRvYykgewogICAgICAgIC8qanNoaW50IHZhbGlkdGhpczp0cnVlICovCiAgICAgICAgZm9yKHZhciBpIGluIGV2ZW50SGFuZGxlcnMpIHsKICAgICAgICAgICAgdmFyIGpxRXZ0ID0gJ2FqYXgtJyArIGksIG1ldGhvZCA9IGV2ZW50RmFjdG9yeShpKTsKICAgICAgICAgICAgaWYoaSA9PT0gJ3NlbmQnKSB7CiAgICAgICAgICAgICAgICBtZXRob2QgPSBiaW5kKHNlbmRFdmVudEZhY3RvcnkoaSksIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGpEb2Mub24oY2FtZWxDYXNlKGpxRXZ0KSArIHRoaXMubmFtZXNwYWNlLCBtZXRob2QpOwogICAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuaW5pdCA9IGluaXQ7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWV2ZW50LmZhY3RvcnkuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YS9yZXNwb25zZS5xdWV1ZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnLCAnLi9ldmVudC50eXBlcycsICdqcXVlcnknLCAndGhydXN0L2xvZycsICdoYXMnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX2V2ZW50VHlwZXNfXywgX19qUXVlcnlfXywgX19sb2dfXywgX19oYXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9kYXRhL2RhdGEuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9qcXVlcnkuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBldmVudFR5cGVzID0gX19ldmVudFR5cGVzX187CgogICAgdmFyIGpRdWVyeSA9IF9falF1ZXJ5X187CgogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgZXh0ZW5kID0gXy5leHRlbmQsIHdoZW4gPSB1dGlsLndoZW4sIHVpZCA9IF8udW5pcXVlSWQsIGFqYXggPSBqUXVlcnkuYWpheCwgZGF0YUV2ZW50V2FpdCA9IGV2ZW50VHlwZXMud2FpdCwgZGF0YUV2ZW50U3RhcnQgPSBldmVudFR5cGVzLnN0YXJ0LCBkYXRhRXZlbnRTdG9wID0gZXZlbnRUeXBlcy5zdG9wLCBkYXRhRXZlbnRTdGF0dXMgPSBldmVudFR5cGVzLnN0YXR1cywgcXVldWUgPSB7CiAgICB9LCB1cGRhdGVYSFJJbnRlcm5hbHMgPSBmdW5jdGlvbiAoZGZvLCB4aHIpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZighZGZvLl94aHIpIHsKICAgICAgICAgICAgICAgIGRmby5feGhyID0geGhyOwogICAgICAgICAgICAgICAgZGZvLmdldEFsbFJlc3BvbnNlSGVhZGVycyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGZvLl94aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZGZvLmdldFJlc3BvbnNlSGVhZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBkZm8uX3hoci5nZXRBbGxSZXNwb25zZUhlYWRlcnNnZXRSZXNwb25zZUhlYWRlcigpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGRmby5hYm9ydCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGZvLl94aHIuYWJvcnQoKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBkZm8uc2V0UmVxdWVzdEhlYWRlciA9IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBkZm8uX3hoci5zZXRSZXF1ZXN0SGVhZGVyKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGZvLnJlc3BvbnNlVGV4dCA9IHhoci5yZXNwb25zZVRleHQ7CiAgICAgICAgICAgIGRmby5yZXNwb25zZVhNTCA9IHhoci5yZXNwb25zZVhNTDsKICAgICAgICAgICAgZGZvLnJlYWR5U3RhdGUgPSB4aHIucmVhZHlTdGF0ZTsKICAgICAgICAgICAgZGZvLnN0YXR1cyA9IHhoci5zdGF0dXM7CiAgICAgICAgICAgIGRmby5zdGF0dXNUZXh0ID0geGhyLnN0YXR1c1RleHQ7CiAgICAgICAgfTsKICAgIH0sIGFyZ3VtZW50UmVzb2x2ZXIgPSBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIG1ldGhvZChfLnRvQXJyYXkoYXJndW1lbnRzKSk7CiAgICAgICAgfTsKICAgIH0sIGRlZmVyQ29udHJvbGxlckl0ZW1DYWxsYmFjayA9IGZ1bmN0aW9uIChmdW5jKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbCh0aGlzLCBhcmd1bWVudHNbMF1bMF0pOwogICAgICAgIH07CiAgICB9OwogICAgLyoqCiAgICBUaGUgcmVzcG9uc2UgcXVldWUgY2xhc3MgaGFuZGxlcyBjcmVhdGlvbiBvZiBhIHF1ZXVlIG9yIGJhdGNoaW5nIHN5c3RlbS4KICAgIFdpdGggdGhpcyBzeXN0ZW0sIHdlIGNhbiBiYXRjaCB1cCBhbGwgb3VyIHNlcnZlciByZXF1ZXN0cywgYW5kIHJlcXVlc3QgdGhlbSBmcm9tIHRoZSBzZXJ2ZXIgYWxsIGFyb3VuZCB0aGUgc2FtZSB0aW1lLgogICAgSW4gYWRkaXRpb24gdG8gdGhhdCwgd2hlbiB0aGUgcmVxdWVzdHMgY29tZSBiYWNrIHdlIGNhbiBhbHNvIHNwb29sIHRoZW0gdG9nZXRoZXIsIHNvIHRoYXQgdGhlIGNhbGxzIGRvbid0IHJlc29sdmUgdW50aWwKICAgIGVpdGhlciBhbGwgdGhlIGNhbGxzIGNvbWUgYmFjaywgb3IgYSBzcGVjaWZpYyB0aW1lIGhhcyBlbGFwc2VkLgogICAgCiAgICBAZm9yIHRocnVzdC5kYXRhCiAgICBAY2xhc3MgdGhydXN0LmRhdGEuUmVzcG9uc2VRdWV1ZQogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge3RocnVzdC5Nb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIHRvIGNyZWF0ZSB0aGUgcmVzcG9uc2UgcXVldWUgZm9yCiAgICBAcGFyYW0ge051bWJlcn0gc3RhcnRUaW1lb3V0IFRoZSB0aW1lIHRvIHdhaXQgZm9yIGFkZGl0aW9uYWwgcmVxdWVzdHMuCiAgICBAcGFyYW0ge051bWJlcn0gZmluaXNoVGltZW91dCBUaGUgbWF4aW11bSB0aW1lIHRvIHdhaXQgZm9yIHJlcXVlc3RzIHRvIHJldHVybi4KICAgICoqLwogICAgdmFyIFJlc3BvbnNlUXVldWUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFJlc3BvbnNlUXVldWUobW9kdWxlLCBzdGFydFRpbWVvdXQsIGZpbmlzaFRpbWVvdXQpIHsKICAgICAgICAgICAgdGhpcy5zdGFydFRpbWVvdXQgPSBzdGFydFRpbWVvdXQ7CiAgICAgICAgICAgIHRoaXMuZmluaXNoVGltZW91dCA9IGZpbmlzaFRpbWVvdXQ7CiAgICAgICAgICAgIHRoaXMubW9kdWxlID0gbW9kdWxlOwogICAgICAgICAgICB0aGlzLm5hbWVzcGFjZSA9IG1vZHVsZS5uYW1lc3BhY2U7CiAgICAgICAgfQogICAgICAgIFJlc3BvbnNlUXVldWUucHJvdG90eXBlLmFkZFRvUXVldWUgPSAvKioKICAgICAgICBBZGRzIGEgcmVxdWVzdCB0byB0aGUgcXVldWUKICAgICAgICBRdWV1ZXMgYXJlIHNwbGl0IHVwIGJ5IEhUVFAgdHlwZSwgc28gR0VUIHJlcXVlc3RzIGdvIHdpdGggR0VUIHJlcXVlc3RzIGFuZCBQT1NUIHJlcXVlc3RzIGdvIHdpdGggUE9TVCByZXF1ZXN0cy4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGFkZFRvUXVldWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgcmVxdWVzdCB0eXBlIChQT1NULCBHRVQsIGV0YykKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSByZXF1ZXN0IHVybCB0byBxdWV1ZSB1cAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIFRoZSByZXF1ZXN0IG9wdGlvbnMuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIG9yIHJlamVjdCwgd2hlbiB0aGUgcmVxdWVzdCBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHR5cGUsIHVybCwgb3B0aW9ucykgewogICAgICAgICAgICB2YXIgZGZvID0gd2hlbi5kZWZlcigpLCB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYob3B0aW9ucy5iZWZvcmVTZW5kKSB7CiAgICAgICAgICAgICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgICAgICAgICAgIGRmby5wcm9ncmVzcyhmdW5jdGlvbiAoZXZlbnRUeXBlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoZXZlbnRUeXBlICYmIGV2ZW50VHlwZSA9PSAnYmVmb3JlLXNlbmQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmVTZW5kLmFwcGx5KGJlZm9yZVNlbmQsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihvcHRpb25zLmNvbXBsZXRlKSB7CiAgICAgICAgICAgICAgICBkZm8ucHJvbWlzZS5hbHdheXMob3B0aW9ucy5jb21wbGV0ZSk7CiAgICAgICAgICAgICAgICBkZWxldGUgb3B0aW9ucy5jb21wbGV0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihvcHRpb25zLnN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIGRmby5wcm9taXNlLnRoZW4ob3B0aW9ucy5zdWNjZXNzKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYob3B0aW9ucy5lcnJvcikgewogICAgICAgICAgICAgICAgZGZvLnByb21pc2Uub3RoZXJ3aXNlKG9wdGlvbnMuZXJyb3IpOwogICAgICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnMuZXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhhc1F1ZXVlID0gISFxdWV1ZVt0eXBlXSwgbGlzdCA9IHF1ZXVlW3R5cGVdIHx8IChxdWV1ZVt0eXBlXSA9IHsKICAgICAgICAgICAgfSksIHRhaWwgPSBsaXN0LnRhaWwgfHwgKGxpc3QudGFpbCA9IGxpc3QubmV4dCA9IHsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGV4dGVuZCh0YWlsLCB7CiAgICAgICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnMsCiAgICAgICAgICAgICAgICBkZm86IGRmbwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbGlzdC50YWlsID0gdGFpbC5uZXh0ID0gewogICAgICAgICAgICB9OwogICAgICAgICAgICBpZighaGFzUXVldWUpIHsKICAgICAgICAgICAgICAgIHdoZW4uZGVsYXkodGhhdC5zdGFydFRpbWVvdXQpLnRoZW4odGhhdC5wcm9jZXNzKHR5cGUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGZvLnByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBSZXNwb25zZVF1ZXVlLnByb3RvdHlwZS5wcm9jZXNzID0gLyoqCiAgICAgICAgUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0IHdpbGwgcHJvY2VzcyB0aGUgZ2l2ZW4gcXVldWUgYWZ0ZXIgdGhlIHN0YXJ0IHRpbWUgaGFzIGVsYXBzZWQuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBwcm9jZXNzCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHF1ZXVlIHR5cGUsIHRvIHByb2Nlc3MuCiAgICAgICAgQHJldHVybnMge0Z1bmN0aW9ufSBUaGUgZnVuY3Rpb24gdGhhdCB3aWxsIGRvIHRoZSB3b3JrIG9uIHRoZSBxdWV1ZS4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodHlwZSkgewogICAgICAgICAgICB2YXIgcGFyZW50ID0gcXVldWVbdHlwZV0sIG5vZGUgPSBwYXJlbnQsIHRoYXQgPSB0aGlzLCBxdWVyeUlkID0gdWlkKCdkcScpOwogICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdEYXRhW3swfV06IENyZWF0aW5nIHF1ZXVlIGZvciB0eXBlICJ7MX0iJywgdGhhdC5uYW1lc3BhY2UsIHR5cGUpKTsKICAgICAgICAgICAgdGhhdC5tb2R1bGUuZmlyZShkYXRhRXZlbnRXYWl0LCBxdWVyeUlkLCB0eXBlKTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGZhbHNlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RhdGFbezB9XTogUHJvY2Vzc2luZyBxdWV1ZSBmb3IgdHlwZSAiezF9IicsIHRoYXQubmFtZXNwYWNlLCB0eXBlKSk7CiAgICAgICAgICAgICAgICB2YXIgd2hlblF1ZXVlID0gW10sIGRlZmVyQ29udHJvbGxlciA9IHdoZW4uZGVmZXIoKSwgcmV0dXJuQ291bnQgPSAwOwogICAgICAgICAgICAgICAgZGVmZXJDb250cm9sbGVyLnByb21pc2UudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRGF0YVt7MH1dOiBGaW5pc2hpbmcgcXVldWUgZm9yIHR5cGUgInsxfSInLCB0aGF0Lm5hbWVzcGFjZSwgdHlwZSkpOwogICAgICAgICAgICAgICAgICAgIHRoYXQubW9kdWxlLmZpcmUoZGF0YUV2ZW50U3RvcCwgcXVlcnlJZCwgdHlwZSwgcmV0dXJuQ291bnQpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBkZWxldGUgcXVldWVbdHlwZV07CiAgICAgICAgICAgICAgICB2YXIgdGFpbCA9IG5vZGUudGFpbCwgc3RhdHVzQ2FsbGJhY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5tb2R1bGUuZmlyZShkYXRhRXZlbnRTdGF0dXMsIHF1ZXJ5SWQsIHR5cGUsICsrcmV0dXJuQ291bnQpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHdoaWxlKChub2RlID0gbm9kZS5uZXh0KSAhPT0gdGFpbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBkZm8gPSBub2RlLmRmbywgb3B0aW9ucyA9IGV4dGVuZCh7CiAgICAgICAgICAgICAgICAgICAgfSwgbm9kZS5vcHRpb25zKSwgeGhyRGZvID0gd2hlbi5kZWZlcigpLCB4aHIgPSBub2RlLnhociA9IGFqYXgobm9kZS51cmwsIG9wdGlvbnMpLnRoZW4oYXJndW1lbnRSZXNvbHZlcih4aHJEZm8ucmVzb2x2ZSksIGFyZ3VtZW50UmVzb2x2ZXIoeGhyRGZvLnJlamVjdCkpOwogICAgICAgICAgICAgICAgICAgIHhockRmby5wcm9taXNlLnRoZW4oc3RhdHVzQ2FsbGJhY2spOwogICAgICAgICAgICAgICAgICAgIHdoZW5RdWV1ZS5wdXNoKHhocik7CiAgICAgICAgICAgICAgICAgICAgd2hlbi5hbGwoWwogICAgICAgICAgICAgICAgICAgICAgICB4aHJEZm8sIAogICAgICAgICAgICAgICAgICAgICAgICBkZWZlckNvbnRyb2xsZXIucHJvbWlzZQogICAgICAgICAgICAgICAgICAgIF0sIHdoZW4uYXBwbHkoZGZvLnJlc29sdmUpLCB3aGVuLmFwcGx5KGRmby5yZWplY3QpLCB1cGRhdGVYSFJJbnRlcm5hbHMoZGZvLCB4aHIpKTsKICAgICAgICAgICAgICAgICAgICBkZm8ucHJvZ3Jlc3MoJ2JlZm9yZS1zZW5kJywgWwogICAgICAgICAgICAgICAgICAgICAgICBkZm8sIAogICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zCiAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGF0Lm1vZHVsZS5maXJlKGRhdGFFdmVudFN0YXJ0LCBxdWVyeUlkLCB0eXBlLCB3aGVuUXVldWUubGVuZ3RoKTsKICAgICAgICAgICAgICAgIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgICAgICB3aGVuLmFsbCh3aGVuUXVldWUpLCAKICAgICAgICAgICAgICAgICAgICB3aGVuLmRlbGF5KHRoYXQuZmluaXNoVGltZW91dCkKICAgICAgICAgICAgICAgIF0sIGRlZmVyQ29udHJvbGxlci5yZXNvbHZlLCBkZWZlckNvbnRyb2xsZXIucmVzb2x2ZSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gUmVzcG9uc2VRdWV1ZTsKICAgIH0pKCk7CiAgICBleHBvcnRzLlJlc3BvbnNlUXVldWUgPSBSZXNwb25zZVF1ZXVlOyAgICAKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9cmVzcG9uc2UucXVldWUuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YS9jb252ZW50aW9uL3N0YXJ0JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZGF0YS9kYXRhLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgd2hlbiA9IHV0aWwud2hlbjsKICAgIHZhciB3aGVuUXVldWUgPSBbXTsKICAgIGZ1bmN0aW9uIHdhaXRDYWxsYmFjayh1aWQpIHsKICAgICAgICB2YXIgZCA9IHdoZW4uZGVmZXIoKTsKICAgICAgICBkLnJlc29sdmVyWyd1aWQnXSA9IHVpZDsKICAgICAgICB3aGVuUXVldWUucHVzaCh7CiAgICAgICAgICAgIHVpZDogdWlkLAogICAgICAgICAgICByZXNvbHZlcjogZC5yZXNvbHZlcgogICAgICAgIH0pOwogICAgfQogICAgZnVuY3Rpb24gc3RvcENhbGxiYWNrKHVpZCkgewogICAgICAgIHZhciBpdGVtID0gXy5maW5kKHdoZW5RdWV1ZSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgcmV0dXJuIHgudWlkID09PSB1aWQ7CiAgICAgICAgfSk7CiAgICAgICAgd2hlblF1ZXVlID0gXy53aXRob3V0KHdoZW5RdWV1ZSwgaXRlbSk7CiAgICAgICAgaXRlbS5yZXNvbHZlci5yZXNvbHZlKCk7CiAgICB9CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBjb3VudGRvd246IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgLy8gU3Vic2NyaWJlIHRvIHRoZSB3YWl0IGFuZCBzdG9wIGV2ZW50cwogICAgICAgICAgICB0aHJ1c3QuZGF0YS5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3dhaXQnLCB3YWl0Q2FsbGJhY2spOwogICAgICAgICAgICB0aHJ1c3QuZGF0YS5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3N0b3AnLCBzdG9wQ2FsbGJhY2spOwogICAgICAgIH0sCiAgICAgICAgb3JiaXQ6IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgLy8gVW5zdWJzY3JpYmUgZnJvbSB0aGUgd2FpdCBhbmQgc3RvcCBldmVudHMKICAgICAgICAgICAgdGhydXN0LmRhdGEudW5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3dhaXQnLCB3YWl0Q2FsbGJhY2spOwogICAgICAgICAgICB0aHJ1c3QuZGF0YS51bnN1YnNjcmliZSgndGhydXN0L2RhdGEvc3RvcCcsIHN0b3BDYWxsYmFjayk7CiAgICAgICAgICAgIC8vIGRlZmVyIHVudGlsIGFueSBvZiB0aGUgZXZlbnRzIHRoYXQgd2VyZSBjYXB0dXJlZCBhcmUgcmVzb2x2ZWQsIG9yIHRoZSBkZWxheSBwYXNzZXMuCiAgICAgICAgICAgIHZhciBkZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgaWYodGhydXN0LmNmZy5kYXRhLmZpbmlzaFRpbWVvdXQgPT09IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbCh3aGVuUXVldWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB3aGVuLmFueShbCiAgICAgICAgICAgICAgICB3aGVuLmFsbCh3aGVuUXVldWUpLCAKICAgICAgICAgICAgICAgIHdoZW4uZGVsYXkodGhydXN0LmNmZy5kYXRhLmZpbmlzaFRpbWVvdXQpCiAgICAgICAgICAgIF0sIGRlZmVyLnJlc29sdmUsIGRlZmVyLnJlamVjdCk7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuc3Vic2NyaXB0aW9uID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPXN0YXJ0LmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbS9jb25maWcnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICAvKioKICAgIFJlc29sdmVzIHRoZSBnaXZlbiBwcm9wZXJ0aWVzIHdoZW4gY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhlIHBsdWdpbi4KICAgIAogICAgVGhpcyBpcyBmb3IgaW50ZXJuYWwgdGhydXN0IHVzZS4gIFRocnVzdCB1c2VzIHRoaXMgYXJyYXkgdG8gZ2VuZXJhdGUgdGhlIHByb3BlcnRpZXMgdGhhdCBuZWVkIHRvIGJlIGhhbmRlZAogICAgdG8gdGhlIHBsdWdpbiBjb25zdHJ1Y3RvciBtZXRob2QuCiAgICAKICAgIEBmb3IgdGhydXN0LmRvbS5jb25maWcKICAgIEBwcml2YXRlCiAgICBAcHJvcGVydHkgcmVzb2x2ZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMucmVzb2x2ZSA9IFsKICAgICAgICAnbmFtZScsIAogICAgICAgICdtZWRpYXRvcicKICAgIF07CiAgICAvKioKICAgIFRoZSBzZXQgb2YgY29udmVudGlvbnMgdG8gbG9hZCBpbnRvIHRocnVzdC9kb20uCiAgICAKICAgIEBwcm9wZXJ0eSBjb252ZW50aW9ucwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMuY29udmVudGlvbnMgPSBbCiAgICAgICAgJ3RocnVzdC9kb20vY29udmVudGlvbi9hY3Rpb24nLCAKICAgICAgICAndGhydXN0L2RvbS9jb252ZW50aW9uL2NvbnRleHQnLCAKICAgICAgICAndGhydXN0L2RvbS9jb252ZW50aW9uL2V2ZW50JwogICAgXTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbS9zdWJqcXVlcnknLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ2pxdWVyeScsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QvbG9nJywgJ2hhcyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2pRdWVyeV9fLCBfX3V0aWxfXywgX19sb2dfXywgX19oYXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBqUXVlcnkgPSBfX2pRdWVyeV9fOwoKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgbG9nID0gX19sb2dfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICB2YXIgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGVhY2ggPSBfLmVhY2gsIGV4dGVuZCA9IF8uZXh0ZW5kLCBpc09iamVjdCA9IF8uaXNPYmplY3QsIGlzRnVuY3Rpb24gPSBfLmlzRnVuY3Rpb24sIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBHTE9CQUwgPSAnLmdsb2JhbCc7CiAgICB2YXIgalF1ZXJ5Rm5NZXRob2RCbGFja0xpc3QgPSBbCiAgICAgICAgJ3JlYWR5JywgCiAgICAgICAgJ2V4dGVuZCcsIAogICAgICAgICdxdWV1ZScsIAogICAgICAgICdkZXF1ZXVlJywgCiAgICAgICAgJ2NsZWFyUXVldWUnLCAKICAgICAgICAncHJvbWlzZScsIAogICAgICAgICdiaW5kJywgCiAgICAgICAgJ3VuYmluZCcsIAogICAgICAgICdsaXZlJywgCiAgICAgICAgJ2RpZScsIAogICAgICAgICdkZWxlZ2F0ZScsIAogICAgICAgICd1bmRlbGVnYXRlJywgCiAgICAgICAgJ2JsdXInLCAKICAgICAgICAnZm9jdXMnLCAKICAgICAgICAnZm9jdXNpbicsIAogICAgICAgICdmb2N1c291dCcsIAogICAgICAgICdsb2FkJywgCiAgICAgICAgJ3Jlc2l6ZScsIAogICAgICAgICdzY3JvbGwnLCAKICAgICAgICAndW5sb2FkJywgCiAgICAgICAgJ2NsaWNrJywgCiAgICAgICAgJ2RibGNsaWNrJywgCiAgICAgICAgJ21vdXNlZG93bicsIAogICAgICAgICdtb3VzZXVwJywgCiAgICAgICAgJ21vdXNlbW92ZScsIAogICAgICAgICdtb3VzZW92ZXInLCAKICAgICAgICAnbW91c2VvdXQnLCAKICAgICAgICAnbW91c2VlbnRlcicsIAogICAgICAgICdtb3VzZWxlYXZlJywgCiAgICAgICAgJ2NoYW5nZScsIAogICAgICAgICdzZWxlY3QnLCAKICAgICAgICAnc3VibWl0JywgCiAgICAgICAgJ2tleWRvd24nLCAKICAgICAgICAna2V5cHJlc3MnLCAKICAgICAgICAna2V5dXAnLCAKICAgICAgICAnZXJyb3InLCAKICAgICAgICAnc2VyaWFsaXplJywgCiAgICAgICAgJ3NlcmlhbGl6ZUFycmF5JywgCiAgICAgICAgJ2FqYXhTdGFydCcsIAogICAgICAgICdhamF4U3RvcCcsIAogICAgICAgICdhamF4Q29tcGxldGUnLCAKICAgICAgICAnYWpheEVycm9yJywgCiAgICAgICAgJ2FqYXhTdWNjZXNzJywgCiAgICAgICAgJ2FqYXhTZW5kJywgCiAgICAgICAgJ190b2dnbGUnLCAKICAgICAgICAnZmFkZVRvJywgCiAgICAgICAgJ3N0b3AnLCAKICAgICAgICAnc2xpZGVEb3duJywgCiAgICAgICAgJ3NsaWRlVXAnLCAKICAgICAgICAnc2xpZGVUb2dnbGUnLCAKICAgICAgICAnZmFkZUluJywgCiAgICAgICAgJ2ZhZGVPdXQnLCAKICAgICAgICAnZmFkZVRvZ2dsZScvKiwgJ29uJywgJ29mZicsICdvbmUnKi8gCiAgICBdOwogICAgZnVuY3Rpb24gbm9ybWFsaXplRXZlbnRzKGV2ZW50cywgbmFtZXNwYWNlKSB7CiAgICAgICAgaWYoIW5hbWVzcGFjZSkgewogICAgICAgICAgICByZXR1cm4gZXZlbnRzOwogICAgICAgIH0KICAgICAgICBpZihpc09iamVjdChldmVudHMpKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBuZXcgb2JqZWN0LCBzbyB0aGF0IG9yaWdpbmFsIG9iamVjdCB3aWxsIG5vdCBiZSBtb2RpZmllZCB3aGVuIGJpbmRpbmcuCiAgICAgICAgICAgIGV2ZW50cyA9IGV4dGVuZCh7CiAgICAgICAgICAgIH0sIGV2ZW50cyk7CiAgICAgICAgICAgIGZvcih2YXIga2V5IGluIGV2ZW50cykgewogICAgICAgICAgICAgICAgaWYoa2V5LmluZGV4T2YoJy4nKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICBldmVudHNba2V5ICsgbmFtZXNwYWNlXSA9IGV2ZW50c1trZXldOwogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudHNba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZXZlbnRzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmKCFldmVudHMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuYW1lc3BhY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZXZlbnRzID0gZXZlbnRzLnNwbGl0KCcgJyk7CiAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBldmVudHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZ0ID0gZXZlbnRzW2ldOwogICAgICAgICAgICAgICAgaWYoZXZ0LmluZGV4T2YoJy4nKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICBldmVudHNbaV0gPSBldnQgKyBuYW1lc3BhY2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGV2ZW50cy5qb2luKCcgJyk7CiAgICAgICAgfQogICAgfQogICAgLyoKICAgIENsb25lIGpxdWVyeQogICAgUmVtb3ZlIGFsbCBleGNlc3MgbWV0aG9kcyB3ZSBkb24ndCB3YW50IHRvIGV4cG9zZSBuYXRpdmVseS4KICAgIG92ZXJybG9hZCBhbnkgbWV0aG9kcyB3ZSB3YW50IHRvIGNoYW5nZSBiZWhhdmlvciBvZiAobm90ZWFibHkgb24sIG9uZSwgYW5kIG9mZikKICAgIAogICAgSW5zdGVhZCBvZiBkdXBsaWNhdGluZyB0aGUganF1ZXJ5IGJlaGF2aW9yIHdlIGluc3RlYWQgcmVhbGlnbiBpdCB0byBvdXIgb3duLgogICAgKi8KICAgIC8vIGpRdWVyeSBzdWIKICAgIGZ1bmN0aW9uIHN1YkpRdWVyeSgpIHsKICAgICAgICB2YXIgdFF1ZXJ5ID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBjb250ZXh0LCBuYW1lc3BhY2UpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyB0UXVlcnkucHJvdG90eXBlLmluaXQoc2VsZWN0b3IsIGNvbnRleHQsIG5hbWVzcGFjZSB8fCAodGhpcyAmJiB0aGlzLm5hbWVzcGFjZSkpOwogICAgICAgIH07CiAgICAgICAgXy5tZXJnZSh0UXVlcnksIGpRdWVyeSk7CiAgICAgICAgLy8gRG8gbm90IGxpa2UKICAgICAgICAvLyBwcm9iYWJseSBuZWVkZWQgaW4gc29tZSBzcGVjaWFsIHVuaXF1ZSBjYXNlcwogICAgICAgIHRRdWVyeS5qUXVlcnkgPSBqUXVlcnk7CiAgICAgICAgLy8gZXhwb3NlIGV2ZW50cyBmb3IgZG9pbmcgc3BlY2lhbCBldmVudHMgYXMgcmVxdWlyZWQuCiAgICAgICAgdFF1ZXJ5LmV2ZW50ID0gKGpRdWVyeSkuZXZlbnQ7CiAgICAgICAgdFF1ZXJ5LmZuID0gdFF1ZXJ5LnByb3RvdHlwZSA9IGV4dGVuZCh7CiAgICAgICAgfSwgalF1ZXJ5LmZuKTsKICAgICAgICB0UXVlcnkuZm4uY29uc3RydWN0b3IgPSB0UXVlcnk7CiAgICAgICAgdFF1ZXJ5LmZuLmluaXQgPSBmdW5jdGlvbiBpbml0KHNlbGVjdG9yLCBjb250ZXh0LCBuYW1lc3BhY2UpIHsKICAgICAgICAgICAgdmFyIGlvRG9tID0gY29udGV4dCBpbnN0YW5jZW9mIHRRdWVyeTsKICAgICAgICAgICAgaWYoY29udGV4dCAmJiBjb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5ICYmICEoaW9Eb20pKSB7CiAgICAgICAgICAgICAgICBjb250ZXh0ID0gdFF1ZXJ5KGNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBqUXVlcnkuZm4uaW5pdC5jYWxsKHRoaXMsIHNlbGVjdG9yLCBjb250ZXh0LCB0UXVlcnlSb290KTsKICAgICAgICAgICAgaWYobmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICByZXN1bHQubmFtZXNwYWNlID0gbmFtZXNwYWNlOwogICAgICAgICAgICB9IGVsc2UgaWYoaW9Eb20pIHsKICAgICAgICAgICAgICAgIHJlc3VsdC5uYW1lc3BhY2UgPSBjb250ZXh0Lm5hbWVzcGFjZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH07CiAgICAgICAgdFF1ZXJ5LmZuLmluaXQucHJvdG90eXBlID0gdFF1ZXJ5LmZuOwogICAgICAgIHZhciB0UXVlcnlSb290ID0gdFF1ZXJ5KGRvY3VtZW50KTsKICAgICAgICAvLyByZW1vdmUgYWxsIG5vdCBhcHBsaWNhYmxlIG1ldGhvZHMgb2ZmIG9mIGZuLgogICAgICAgIGVhY2goalF1ZXJ5Rm5NZXRob2RCbGFja0xpc3QsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIGlmKHRRdWVyeS5mblt4XSkgewogICAgICAgICAgICAgICAgdFF1ZXJ5LmZuW3hdID0gbnVsbDsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0UXVlcnkuZm5beF07CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBfLmVhY2goWwogICAgICAgICAgICAnb24nLCAKICAgICAgICAgICAgJ29uZScsIAogICAgICAgICAgICAnb2ZmJwogICAgICAgIF0sIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIHRRdWVyeS5mblt4XSA9IF8ud3JhcCh0UXVlcnkuZm5beF0sIGZ1bmN0aW9uIChmKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdCgndFF1ZXJ5W3swfV06IEJpbmRpbmcgJyArIHggKyAnIGV2ZW50cy4uLicsIHRoaXMubmFtZXNwYWNlKSk7CiAgICAgICAgICAgICAgICBhcmdzWzBdID0gbm9ybWFsaXplRXZlbnRzKGFyZ3NbMF0sIHRoaXMubmFtZXNwYWNlKTsKICAgICAgICAgICAgICAgIHJldHVybiBmLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICB0UXVlcnkuZm4ucXVlcnkgPSB0UXVlcnkuZm4uJCA9IHRRdWVyeS5mbi5maW5kOwogICAgICAgIHJldHVybiB0UXVlcnk7CiAgICB9CiAgICBleHBvcnRzLnRRdWVyeSA9IHN1YkpRdWVyeSgpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1zdWJqcXVlcnkuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZG9tL2NvbnZlbnRpb24vYWN0aW9uJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCcsICcuLi9zdWJqcXVlcnknXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX3N1YmpxdWVyeV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9jb252ZW50aW9uL2FjdGlvbi5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9kb20vZG9tLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIHN1YmpxdWVyeSA9IF9fc3VianF1ZXJ5X187CgogICAgdmFyICQgPSBzdWJqcXVlcnkudFF1ZXJ5OwogICAgdmFyIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCBBQ1RJT05TID0gJ2NvbmZpZy5kb20uYWN0aW9ucycsIEFDVElPTlNTSU5HTEUgPSAnYWN0aW9ucycsIFNUUklORyA9ICdzdHJpbmcnLCBSRUdJU1RSQVRJT05TID0gJ19yZWdpc3RyYXRpb25zJywgaXNGdW5jdGlvbiA9IF8uaXNGdW5jdGlvbiwgaXNTdHJpbmcgPSBfLmlzU3RyaW5nLCBpc0FycmF5ID0gXy5pc0FycmF5OwogICAgdmFyIGdldEFjdGlvbkF0dHJpYnV0ZSA9IGZ1bmN0aW9uIChldmVudE5hbWUpIHsKICAgICAgICByZXR1cm4gJ2RhdGEtYWN0aW9uLScgKyBldmVudE5hbWU7CiAgICB9OwogICAgdmFyIEFjdGlvbkhhbmRsZXIgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIEFjdGlvbkhhbmRsZXIoKSB7CiAgICAgICAgICAgIHRoaXMuZXZlbnRzID0gewogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBBY3Rpb25IYW5kbGVyLnByb3RvdHlwZS5yZWdpc3RlciA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGFjdGlvbk5hbWUsIGFjdGlvbikgewogICAgICAgICAgICB2YXIgZXZlbnRzID0gdGhpcy5ldmVudHM7CiAgICAgICAgICAgIGlmKCFldmVudHNbZXZlbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXZlbnRzW2V2ZW50TmFtZV0gPSB7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFldmVudHNbZXZlbnROYW1lXVthY3Rpb25OYW1lXSkgewogICAgICAgICAgICAgICAgZXZlbnRzW2V2ZW50TmFtZV1bYWN0aW9uTmFtZV0gPSBhY3Rpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdUaGUgYWN0aW9uIHsxfSBoYW5kbGVyICJ7MH0iIGhhcyBhbHJlYWR5IGJlZW4gdGFrZW4hJywgYWN0aW9uTmFtZSwgZXZlbnROYW1lKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIEFjdGlvbkhhbmRsZXIucHJvdG90eXBlLnVucmVnaXN0ZXIgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBhY3Rpb25OYW1lKSB7CiAgICAgICAgICAgIHZhciBldmVudHMgPSB0aGlzLmV2ZW50czsKICAgICAgICAgICAgaWYoZXZlbnRzW2V2ZW50TmFtZV0gJiYgZXZlbnRzW2V2ZW50TmFtZV1bYWN0aW9uTmFtZV0pIHsKICAgICAgICAgICAgICAgIGV2ZW50c1tldmVudE5hbWVdW2FjdGlvbk5hbWVdID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgQWN0aW9uSGFuZGxlci5wcm90b3R5cGUuY2FsbGJhY2tGb3IgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCByZXR1cm5SZXN1bHRzKSB7CiAgICAgICAgICAgIHZhciBldmVudHMgPSB0aGlzLmV2ZW50cywgYWN0aW9uQXR0cmlidXRlID0gZ2V0QWN0aW9uQXR0cmlidXRlKGV2ZW50TmFtZSksIHJldHVyblJlc3VsdHNEZWZpbmVkID0gdHlwZW9mIHJldHVyblJlc3VsdHMgIT09ICd1bmRlZmluZWQnOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZVZhbHVlID0gJCh0aGlzKS5hdHRyKGFjdGlvbkF0dHJpYnV0ZSk7CiAgICAgICAgICAgICAgICBpZih0eXBlb2YgYXR0cmlidXRlVmFsdWUgPT09IFNUUklORykgewogICAgICAgICAgICAgICAgICAgIHZhciBhY3Rpb24gPSBldmVudHNbZXZlbnROYW1lXVthdHRyaWJ1dGVWYWx1ZV07CiAgICAgICAgICAgICAgICAgICAgaWYoYWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbi5oYW5kbGVyLmFwcGx5KGFjdGlvbi5jb250ZXh0IHx8IHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmKHJldHVyblJlc3VsdHNEZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXR1cm5SZXN1bHRzOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICBBY3Rpb25IYW5kbGVyLmFjdGlvbkhhbmRsZXJzID0gewogICAgICAgIH07CiAgICAgICAgQWN0aW9uSGFuZGxlci5nZXRGb3IgPSBmdW5jdGlvbiBnZXRGb3IobmFtZSkgewogICAgICAgICAgICBpZih0aGlzLmFjdGlvbkhhbmRsZXJzW25hbWVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hY3Rpb25IYW5kbGVyc1tuYW1lXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gKHRoaXMuYWN0aW9uSGFuZGxlcnNbbmFtZV0gPSBuZXcgQWN0aW9uSGFuZGxlcigpKTsKICAgICAgICB9OwogICAgICAgIHJldHVybiBBY3Rpb25IYW5kbGVyOwogICAgfSkoKTsgICAgCiAgICB2YXIgZXZlbnRzID0gewogICAgICAgIGNsaWNrOiBbCiAgICAgICAgICAgICdhJywgCiAgICAgICAgICAgICdidXR0b24nLCAKICAgICAgICAgICAgJ2lucHV0W3R5cGU9ImJ1dHRvbiJdJywgCiAgICAgICAgICAgICdpbnB1dFt0eXBlPSJzdWJtaXQiXScKICAgICAgICBdLAogICAgICAgIGRibGNsaWNrOiBbCiAgICAgICAgICAgICdhJywgCiAgICAgICAgICAgICdidXR0b24nLCAKICAgICAgICAgICAgJ2lucHV0W3R5cGU9ImJ1dHRvbiJdJywgCiAgICAgICAgICAgICdpbnB1dFt0eXBlPSJzdWJtaXQiXScKICAgICAgICBdLAogICAgICAgIG1vdXNlZW50ZXI6IFsKICAgICAgICAgICAgJycKICAgICAgICBdLAogICAgICAgIG1vdXNlbGVhdmU6IFsKICAgICAgICAgICAgJycKICAgICAgICBdLAogICAgICAgIGZvY3VzOiBbCiAgICAgICAgICAgICdpbnB1dCcKICAgICAgICBdLAogICAgICAgIGJsdXI6IFsKICAgICAgICAgICAgJ2lucHV0JwogICAgICAgIF0KICAgIH07CiAgICB2YXIgYXJyYXlTaG9ydEhhbmRBcmdzSW5PcmRlciA9IFsKICAgICAgICAnbmFtZScsIAogICAgICAgICdoYW5kbGVyJywgCiAgICAgICAgJ2NvbnRleHQnCiAgICBdOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBBQ1RJT05TCiAgICAgICAgXSwKICAgICAgICBpZ25pdGU6IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgdmFyIGFjdGlvbkhhbmRsZXIgPSBBY3Rpb25IYW5kbGVyLmdldEZvcih0aHJ1c3QubmFtZSk7CiAgICAgICAgICAgIHRocnVzdC5kb20uYWN0aW9uSGFuZGxlciA9IGFjdGlvbkhhbmRsZXI7CiAgICAgICAgICAgIHZhciAkYm9keSA9ICQod2luZG93LmRvY3VtZW50LmJvZHkpOwogICAgICAgICAgICBfLmVhY2goZXZlbnRzLCBmdW5jdGlvbiAoZXZlbnRTZWxlY3RvcnMsIGV2ZW50TmFtZSkgewogICAgICAgICAgICAgICAgLy8gdXNpbmcgdGhydXN0IG5hbWUsIGFzIGNhbGxiYWNrIG5lZWRzIHRvIGJlIHBlciB0aHJ1c3QgaW5zdGFuY2UKICAgICAgICAgICAgICAgIC8vIGluIHRoZSBldmVudCBvZiBtdWx0aXBsZSB0aHJ1c3QgaW5zdGFuY2VzLgogICAgICAgICAgICAgICAgJGJvZHkub24oZXZlbnROYW1lICsgJy4nICsgQUNUSU9OU1NJTkdMRSArIHRocnVzdC5uYW1lLCBldmVudFNlbGVjdG9ycy5qb2luKGdldEFjdGlvbkF0dHJpYnV0ZShldmVudE5hbWUpICsgJywgJyksIGFjdGlvbkhhbmRsZXIuY2FsbGJhY2tGb3IoZXZlbnROYW1lLCB0cnVlKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgZGVvcmJpdDogZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB2YXIgYWN0aW9uSGFuZGxlciA9IEFjdGlvbkhhbmRsZXIuZ2V0Rm9yKHRocnVzdC5uYW1lKTsKICAgICAgICAgICAgdmFyICRib2R5ID0gJCh3aW5kb3cuZG9jdW1lbnQuYm9keSk7CiAgICAgICAgICAgIF8uZWFjaChldmVudHMsIGZ1bmN0aW9uIChldmVudFNlbGVjdG9ycywgZXZlbnROYW1lKSB7CiAgICAgICAgICAgICAgICAkYm9keS5vZmYoJy4nICsgQUNUSU9OU1NJTkdMRSArIHRocnVzdC5uYW1lKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBhY3Rpb25zID0gbW9kLmNvbnZlbnRpb24oQUNUSU9OUyksIGFjdGlvbkhhbmRsZXIgPSBBY3Rpb25IYW5kbGVyLmdldEZvcihtb2QudGhydXN0Lm5hbWUpLCBkb20gPSBmYWNhZGUsIG1vZHVsZUluc3RhbmNlID0gbW9kLmluc3RhbmNlOwogICAgICAgICAgICBpZihhY3Rpb25zKSB7CiAgICAgICAgICAgICAgICBfLmZvck93bihhY3Rpb25zLCBmdW5jdGlvbiAoYWN0aW9uQ29sbGVjdGlvbiwgZXZlbnROYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoIWlzQXJyYXkoYWN0aW9uQ29sbGVjdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uQ29sbGVjdGlvbiA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbkNvbGxlY3Rpb24KICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoYWN0aW9uQ29sbGVjdGlvbi5sZW5ndGggJiYgKCFpc0FycmF5KGFjdGlvbkNvbGxlY3Rpb25bMF0pIHx8IGlzU3RyaW5nKGFjdGlvbkNvbGxlY3Rpb25bMF0pKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25Db2xsZWN0aW9uID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uQ29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBfLmVhY2goYWN0aW9uQ29sbGVjdGlvbiwgZnVuY3Rpb24gKGFjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZihpc0FycmF5KGFjdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdBY3Rpb24gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdW5kZWZpbmVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGFycmF5U2hvcnRIYW5kQXJnc0luT3JkZXIsIGZ1bmN0aW9uICh4LCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeCA9PT0gJ2hhbmRsZXInICYmIGlzU3RyaW5nKGFjdGlvbltpXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uW2ldID0gbW9kLmluc3RhbmNlW2FjdGlvbltpXV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0FjdGlvblt4XSA9IGFjdGlvbltpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gbmV3QWN0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhY3Rpb25OYW1lID0gYWN0aW9uLm5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFhY3Rpb24uaGFuZGxlciAmJiBhY3Rpb24ubW9kdWxlSGFuZGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uLmhhbmRsZXIgPSBtb2QuaW5zdGFuY2VbYWN0aW9uLm1vZHVsZUhhbmRsZXJdOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoIWFjdGlvbi5oYW5kbGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ011c3QgZGVmaW5lIGVpdGhlciBhIGhhbmRsZXIgb3IgbW9kdWxlIGhhbmRsZXIuJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uSGFuZGxlci5yZWdpc3RlcihldmVudE5hbWUsIGFjdGlvbk5hbWUsIGFjdGlvbik7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBhY3Rpb25zID0gbW9kLmNvbnZlbnRpb24oQUNUSU9OUyksIGFjdGlvbkhhbmRsZXIgPSBBY3Rpb25IYW5kbGVyLmdldEZvcihtb2QudGhydXN0Lm5hbWUpLCBtb2R1bGVJbnN0YW5jZSA9IG1vZC5pbnN0YW5jZTsKICAgICAgICAgICAgaWYoYWN0aW9ucykgewogICAgICAgICAgICAgICAgZm9yKHZhciBhY3Rpb25FdmVudCBpbiBhY3Rpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGlvbkNvbGxlY3Rpb24gPSBhY3Rpb25zW2FjdGlvbkV2ZW50XTsKICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGFjdGlvbk5hbWUgaW4gYWN0aW9uQ29sbGVjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25IYW5kbGVyLnVucmVnaXN0ZXIoYWN0aW9uRXZlbnQsIGFjdGlvbk5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLmFjdGlvbiA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1hY3Rpb24uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZG9tL2NvbnZlbnRpb24vYW5pbWF0ZS5jb250YWluZXInLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9kb20vY29udmVudGlvbi9jb250ZXh0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9kb20uZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgZXZlbnQgPSB7CiAgICAgICAgYW55Q29udGFpbmVyOiAndGhydXN0LWNvbnZlbnRpb24tY29udGFpbmVyLWFueScsCiAgICAgICAgY2hhbmdlQ29udGFpbmVyOiAndGhydXN0LWNvbnZlbnRpb24tY29udGFpbmVyLWNoYW5nZScKICAgIH0sIGFueSA9IF8uYW55LCBkZWZlciA9IF8uZGVmZXIsIGJpbmQgPSBfLmJpbmQsIFNUQVJUID0gJ3N0YXJ0LXN0YXR1cycsIEFOSU1BVEUgPSAnYW5pbWF0ZScsIENPTlRBSU5FUiA9ICdjb250YWluZXInLCBDT05URVhUID0gJ2NvbnRleHQnOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBBTklNQVRFCiAgICAgICAgXSwKICAgICAgICBpbml0OiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBtZWRpYXRvciA9IG1vZC5pbnN0YW5jZS5tZWRpYXRvcjsKICAgICAgICAgICAgbWVkaWF0b3Iuc3Vic2NyaWJlKGV2ZW50LmNoYW5nZUNvbnRhaW5lciwgYmluZCh0aGF0LmNoYW5nZSwgdGhhdCwgbW9kKSk7CiAgICAgICAgfSwKICAgICAgICBjaGFuZ2U6IGZ1bmN0aW9uIChtb2R1bGUsIGNvbnRhaW5lcikgewogICAgICAgICAgICBpZihtb2R1bGUuY29udmVudGlvbihDT05UQUlORVIpID09PSBjb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGlmKG1vZHVsZS5jb252ZW50aW9uKFNUQVJUKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBhbmltYXRlID0gbW9kdWxlLmNvbnZlbnRpb24oQU5JTUFURSk7CiAgICAgICAgICAgICAgICAgICAgaWYoYW5pbWF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29udGV4dE5vZGUgPSBtb2R1bGUuaW5zdGFuY2UuZG9tKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHROb2RlLnJlbW92ZUNsYXNzKGFuaW1hdGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGFuaW1hdGUgPSBtb2QuY29udmVudGlvbihBTklNQVRFKSwgY29udGFpbmVyID0gbW9kLmNvbnZlbnRpb24oQ09OVEFJTkVSKSwgY29udGV4dCA9IG1vZC5jb252ZW50aW9uKENPTlRFWFQpLCBkb20gPSBmYWNhZGU7CiAgICAgICAgICAgIGlmKGFuaW1hdGUgJiYgY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB2YXIgY2xvbmUgPSBkb20uY29udGV4dC5jbG9uZSgpLmFwcGVuZFRvKGRvbS5jb250ZXh0LnBhcmVudCgpKTsKICAgICAgICAgICAgICAgIGNsb25lLmFkZENsYXNzKGFuaW1hdGUucmVwbGFjZSgvXC4vZywgJyAnKS50cmltKCkpOwogICAgICAgICAgICAgICAgbW9kLmluc3RhbmNlLmRvbSA9IG1vZC5pbnN0YW5jZS4kID0gY2xvbmU7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGJpbmQodGhhdC5jbGVhbnVwLCB0aGF0LCBkb20uY29udGV4dC5wYXJlbnQoKSwgYW5pbWF0ZSwgY29udGV4dCksIDIwMDApOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBjbGVhbnVwOiBmdW5jdGlvbiAoY29udGFpbmVyLCBhbmltYXRlLCBjb250ZXh0KSB7CiAgICAgICAgICAgIGNvbnRhaW5lci5maW5kKGNvbnRleHQpLmZpbHRlcignOm5vdCgnICsgYW5pbWF0ZSArICcpJykucmVtb3ZlKCk7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuYW5pbWF0ZUNvbnRhaW5lciA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1hbmltYXRlLmNvbnRhaW5lci5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kb20vY29udmVudGlvbi9jb250ZXh0JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCcsICcuLi9zdWJqcXVlcnknXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX3N1YmpxdWVyeV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9jb252ZW50aW9uL2NvbnRleHQuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2RvbS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBzdWJqcXVlcnkgPSBfX3N1YmpxdWVyeV9fOwoKICAgIHZhciB0UXVlcnkgPSBzdWJqcXVlcnkudFF1ZXJ5OwogICAgdmFyIENPTlRFWFQgPSAnY29uZmlnLmRvbS5jb250ZXh0JzsKICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgQ09OVEVYVAogICAgICAgIF0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgY29udGV4dCA9IG1vZC5jb252ZW50aW9uKENPTlRFWFQpOwogICAgICAgICAgICBpZihjb250ZXh0KSB7CiAgICAgICAgICAgICAgICBtb2QuaW5zdGFuY2UuZG9tID0gbW9kLmluc3RhbmNlLiQgPSB0UXVlcnkoY29udGV4dCwgZmFjYWRlLmNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuY29udGV4dCA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb250ZXh0LmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbS9jb252ZW50aW9uL2V2ZW50JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2NvbnZlbnRpb24vZXZlbnQuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2RvbS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBDT05URVhUID0gJ2NvbmZpZy5kb20uY29udGV4dCcsIEVWRU5UUyA9ICdjb25maWcuZG9tLmV2ZW50cycsIGlzRnVuY3Rpb24gPSBfLmlzRnVuY3Rpb24sIGlzU3RyaW5nID0gXy5pc1N0cmluZywgaXNBcnJheSA9IF8uaXNBcnJheTsKICAgIHZhciBldmVudFByb3BlcnR5TG9hZE9yZGVyID0gWwogICAgICAgICdzZWxlY3RvcicsIAogICAgICAgICdkYXRhJywgCiAgICAgICAgJ2hhbmRsZXInCiAgICBdOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBFVkVOVFMKICAgICAgICBdLAogICAgICAgIHJlYWR5OiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgdmFyIGV2ZW50cyA9IG1vZC5jb252ZW50aW9uKEVWRU5UUyksICRjb250ZXh0ID0gZmFjYWRlLmNvbnRleHQsIG1vZHVsZUluc3RhbmNlID0gbW9kLmluc3RhbmNlOwogICAgICAgICAgICBpZihldmVudHMpIHsKICAgICAgICAgICAgICAgIF8uZm9ySW4oZXZlbnRzLCBmdW5jdGlvbiAoZXZlbnRzQ29sbGVjdGlvbiwgZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAvL3ZhciBldmVudHNDb2xsZWN0aW9uID0gZXZlbnRzW2V2ZW50XTsKICAgICAgICAgICAgICAgICAgICBpZighaXNBcnJheShldmVudHNDb2xsZWN0aW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgICBldmVudHNDb2xsZWN0aW9uID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRzQ29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihldmVudHNDb2xsZWN0aW9uLmxlbmd0aCAmJiAoIWlzQXJyYXkoZXZlbnRzQ29sbGVjdGlvblswXSkgfHwgaXNTdHJpbmcoZXZlbnRzQ29sbGVjdGlvblswXSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50c0NvbGxlY3Rpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudHNDb2xsZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIF8uZWFjaChldmVudHNDb2xsZWN0aW9uLCBmdW5jdGlvbiAoZGVmaW5pdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYmluZEV2ZW50ID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQKICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNBcnJheShkZWZpbml0aW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmluZEV2ZW50LnB1c2guYXBwbHkoYmluZEV2ZW50LCBkZWZpbml0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIGhhdmUgb25lIGVkZ2VjYXNlIGhlcmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSBzaG9ydCBoYW5kIGFycmF5LCBoYXMgYSBjb250ZXh0IHRoYXQgaXMgYSBzdHJpbmcgb3IgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFuZCBpdCBkb2VzbnQgaGF2ZSBpbmZvcm1hdGlvbiBmb3IgYm90aCBzZWxlY3RvciBhbmQgZGF0YSwgdGhpcyB3aWxsIGZhaWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIGNhbiByZWNvdmVyIHdoZW4gYWxsIDUgcG9zc2libGUgaXRlbXMgYXJlIGRlZmluZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGFuZGxlciA9IGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSB3ZXJlIGFza2VkIGZvciBhIG1ldGhvZCBvbiB0aGUgbW9kdWxlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNTdHJpbmcoaGFuZGxlcikgJiYgYmluZEV2ZW50Lmxlbmd0aCA9PT0gMikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMV0gPSBtb2QuaW5zdGFuY2VbaGFuZGxlcl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgLy8gV2UgZGlkbnQgZmluZCBhIGZ1bmN0aW9uIDooCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgRURHRSBDQVNFOiBJZiBjb250ZXh0IGlzIGEgZnVuY3Rpb24sIHdlIHdpbGwgYXNzdW1lIGFsbCBpcyB3ZWxsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgICAgRXZlbiBpZiB0aGUgaGFuZGxlciBpcyBhIHN0cmluZyB0aGF0IG5lZWRzIHRvIGJlIHJlZmVyZW5jZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXb3JrIGFycm91bmRzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICBTaG9ydGhhbmQ6IGFkZCBudWxsL2VtcHR5IHZhbHVlcyBmb3Igc2VsZWN0b3IgYW5kIGRhdGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICAgTG9uZ2hhbmQ6IHN3aXRjaCB0byBsb25nIGhhbmQgYXMgaXQgaGFzIG1vcmUgZXhwbGljaXQgc3ludGF4LgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWlzU3RyaW5nKGhhbmRsZXIpICYmICFpc0Z1bmN0aW9uKGhhbmRsZXIpICYmIGJpbmRFdmVudC5sZW5ndGggPiAyIHx8IGJpbmRFdmVudC5sZW5ndGggPT09IDUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyID0gYmluZEV2ZW50W2JpbmRFdmVudC5sZW5ndGggLSAyXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihpc1N0cmluZyhoYW5kbGVyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnRbYmluZEV2ZW50Lmxlbmd0aCAtIDJdID0gbW9kLmluc3RhbmNlW2hhbmRsZXJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnRbYmluZEV2ZW50Lmxlbmd0aCAtIDJdID0gXy5iaW5kKGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMl0sIGJpbmRFdmVudC5wb3AoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoaXNTdHJpbmcoaGFuZGxlcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnRbYmluZEV2ZW50Lmxlbmd0aCAtIDFdID0gbW9kLmluc3RhbmNlW2hhbmRsZXJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGV2ZW50UHJvcGVydHlMb2FkT3JkZXIsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZGVmaW5pdGlvblt4XSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBkZWZpbml0aW9uW3hdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih4ID09PSAnaGFuZGxlcicgJiYgZGVmaW5pdGlvbi5jb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IF8uYmluZCh2YWx1ZSwgZGVmaW5pdGlvbi5jb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnQucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2FsbCB0aGUgb24gbWV0aG9kLCB3aXRoIG91ciBhcmd1bWVudHMuCiAgICAgICAgICAgICAgICAgICAgICAgICRjb250ZXh0Lm9uLmFwcGx5KCRjb250ZXh0LCBiaW5kRXZlbnQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHN0b3A6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgZXZlbnRzID0gbW9kLmNvbnZlbnRpb24oRVZFTlRTKSwgJGNvbnRleHQgPSBmYWNhZGUuY29udGV4dDsKICAgICAgICAgICAgaWYoJGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICRjb250ZXh0Lm9mZigpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuZXZlbnQgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9ZXZlbnQuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvdGVtcGxhdGUvY29uZmlnJyxbInJlcXVpcmUiLCAiZXhwb3J0cyJdLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgLyoqCiAgICBQcm92aWRlcyB0aHJ1c3QgY29uZmlndXJhdGlvbgogICAgCiAgICBAbW9kdWxlIHRocnVzdC50ZW1wbGF0ZQogICAgQHN1Ym1vZHVsZSB0aHJ1c3QudGVtcGxhdGUuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luLgogICAgCiAgICBUaGlzIGlzIGZvciBpbnRlcm5hbCB0aHJ1c3QgdXNlLiAgVGhydXN0IHVzZXMgdGhpcyBhcnJheSB0byBnZW5lcmF0ZSB0aGUgcHJvcGVydGllcyB0aGF0IG5lZWQgdG8gYmUgaGFuZGVkCiAgICB0byB0aGUgcGx1Z2luIGNvbnN0cnVjdG9yIG1ldGhvZC4KICAgIAogICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuY29uZmlnCiAgICBAcHJpdmF0ZQogICAgQHByb3BlcnR5IHJlc29sdmUKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLnJlc29sdmUgPSBbCiAgICAgICAgJ2NmZycsIAogICAgICAgICdkYXRhJwogICAgXTsKICAgIC8qKgogICAgVGhlIHNldCBvZiBjb252ZW50aW9ucyB0byBsb2FkIGludG8gdGhydXN0L3RlbXBsYXRlLgogICAgCiAgICBAcHJvcGVydHkgY29udmVudGlvbnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLmNvbnZlbnRpb25zID0gWwogICAgICAgICd0aHJ1c3QvdGVtcGxhdGUvY29udmVudGlvbi90ZW1wbGF0ZScsIAogICAgICAgICd0aHJ1c3QvdGVtcGxhdGUvY29udmVudGlvbi9rbm9ja291dC5lbmdpbmUnCiAgICBdOwogICAgLyoqCiAgICBNYXBzIHRoZSBhdmFpbGFibGUgdGVtcGxhdGVzLCB0byB0aGVpciBhcHByb3ByaWF0ZSBtb2R1bGUgbmFtZS4KICAgIAogICAgKipwcmVjb21waWxlZCBpcyBhIHNwZWNpYWwgY2FzZSwgYW5kIHRob3NlIG1ldGhvZHMgYXJlIGV4cGVjdGVkIHRvIGJlIGNvZGUgYnVpbHQgZnVuY3Rpb25zLgogICAgCiAgICBAcHJvcGVydHkgdHlwZXMKICAgIEByZWFkT25seQogICAgQHR5cGUge09iamVjdH0KICAgICoqLwogICAgZXhwb3J0cy50eXBlcyA9IHsKICAgICAgICAnZG9UJzogJ2RvVCcsCiAgICAgICAgJ3ByZWNvbXBpbGVkJzogdHJ1ZQogICAgfTsKICAgIC8qKgogICAgTWFwcyB0aGUgdGVtcGxhdGUgZXZhbHVhdG9ycywgc28gdGhhdCB3aGVuIGNyZWF0aW5nIGEgdGVtcGxhdGUgZm9yIGtub2Nrb3V0LCBpdCBrbm93cyBob3cgdG8gcHJvcGVybHkgb3V0cHV0IHRoZSBpbmZvcm1hdGlvbi4KICAgIAogICAgQHByb3BlcnR5IGV2YWx1YXRvcnMKICAgIEByZWFkT25seQogICAgQHR5cGUge09iamVjdH0KICAgICoqLwogICAgZXhwb3J0cy5ldmFsdWF0b3JzID0gewogICAgICAgICdkb1QnOiB7CiAgICAgICAgICAgIGxlZnQ6ICd7ez0gJywKICAgICAgICAgICAgcmlnaHQ6ICd9fScKICAgICAgICB9CiAgICB9OwogICAgLyoqCiAgICBUaGUgZGVmYXVsdCB0ZW1wbGF0ZSB0eXBlLCB1c2VkIHdoZW4gZXh0ZW5zaW9uIGlzbid0IGdpdmVuLgogICAgCiAgICBAcHJvcGVydHkgZGVmYXVsdFR5cGUKICAgIEByZWFkT25seQogICAgQHR5cGUge1N0cmluZ30KICAgIEBkZWZhdWx0ICdkb1QnCiAgICAqKi8KICAgIGV4cG9ydHMuZGVmYXVsdFR5cGUgPSAnZG9UJzsKICAgIC8qKgogICAgVGhlIGJhc2UgbG9jYXRpb24sIHJlbGF0aXZlIHRvIHRoZSBhcHBsaWNhdGlvbiBwYXRoIGZvciB0ZW1wbGF0ZSBsb2NhdGlvbi4KICAgIElmIHRlbXBsYXRlIHBhdGhzIGFyZSBnaXZlbiByZWxhdGl2ZSB0byBhcHBsaWNhdGlvbiBwYXRoLCB0aGlzIGNhbiBiZSBsZWZ0IGVtcHR5LgogICAgCiAgICBAcHJvcGVydHkgYmFzZVVybAogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7U3RyaW5nfQogICAgQGRlZmF1bHQgJycKICAgICoqLwogICAgZXhwb3J0cy5iYXNlVXJsID0gJyc7CiAgICAvKioKICAgIERlZmluZXMgdGhlIGV4dGVuc2lvbiB1c2VkIGZvciB0ZW1wbGF0ZXMgc3RvcmVkIG9uIHRoZSBzZXJ2ZXIuCiAgICAKICAgIEBwcm9wZXJ0eSBleHRlbnNpb24KICAgIEByZWFkT25seQogICAgQHR5cGUge1N0cmluZ30KICAgIEBkZWZhdWx0ICcudG1wbCcKICAgICoqLwogICAgZXhwb3J0cy5leHRlbnNpb24gPSAnLnRtcGwnOwogICAgLyoqCiAgICBEZWZpbmVzIHRoZSBBTUQgcGF0aHMgdG8gZmluZCB0aGUgZ2l2ZW4gdGVtcGxhdGUgdHlwZQogICAgCiAgICBAcHJvcGVydHkgdGVtcGxhdGVQYXRocwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7U3RyaW5nfQogICAgQGRlZmF1bHQge30KICAgICoqLwogICAgZXhwb3J0cy50ZW1wbGF0ZVBhdGhzID0gewogICAgICAgICdkb1QnOiAnZG9UJwogICAgfTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3RlbXBsYXRlL2NvbnZlbnRpb24va25vY2tvdXQuZW5naW5lJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCcsICdrbm9ja291dCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18sIF9fa29fXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90ZW1wbGF0ZS90ZW1wbGF0ZS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBrbyA9IF9fa29fXzsKCiAgICB2YXIgd2hlbiA9IHV0aWwud2hlbiwgZWFjaCA9IF8uZWFjaCwgaGFzT3duID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eSwgZmluZCA9IF8uZmluZCwga25vY2tvdXRUZW1wbGF0ZXMgPSB7CiAgICB9OwogICAgdmFyIGluaXRLbm9ja291dEludGVncmF0aW9uID0gZnVuY3Rpb24gKHRlbXBsYXRlTWFuYWdlcikgewogICAgICAgIHZhciBUaHJ1c3RUZW1wbGF0ZVNvdXJjZSA9IChrbykudGVtcGxhdGVTb3VyY2VzLnRocnVzdFRlbXBsYXRlID0gZnVuY3Rpb24gKHRlbXBsYXRlKSB7CiAgICAgICAgICAgIHRoaXMudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKICAgICAgICB9OwogICAgICAgIFRocnVzdFRlbXBsYXRlU291cmNlLnByb3RvdHlwZSA9IHsKICAgICAgICAgICAgdGV4dDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGF0LnRlbXBsYXRlLmh0bWw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoYXQudGVtcGxhdGUuaHRtbCA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAgICAgICAgICAvL3Rocm93IG5ldyBFcnJvcignVGhydXN0IFRlbXBsYXRlIGRvZXMgbm90IHN1cHBvcnQgcmV3cml0aW5nLi4uJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGF0YTogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgaWYoIXRoYXQudGVtcGxhdGUuZGF0YSkgewogICAgICAgICAgICAgICAgICAgIHRoYXQudGVtcGxhdGUuZGF0YSA9IHsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGF0LnRlbXBsYXRlLmRhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC50ZW1wbGF0ZS5kYXRhW2tleV0gPSBhcmd1bWVudHNbMV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIC8vIEJlZ2luIGludGVncmF0aW9uIG9mIHRlbXBsYXRlIHBsdWdpbiwgd2l0aCBLbm9ja291dC4KICAgICAgICB2YXIgb2xkRW5naW5lID0gKGtvKS5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZTsKICAgICAgICB2YXIgY29udmVudGlvblRlbXBsYXRlRW5naW5lID0gKGtvKS5jb252ZW50aW9uVGVtcGxhdGVFbmdpbmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgfTsKICAgICAgICBjb252ZW50aW9uVGVtcGxhdGVFbmdpbmUucHJvdG90eXBlID0ga28udXRpbHMuZXh0ZW5kKG5ldyAoa28pLnRlbXBsYXRlRW5naW5lKCksIHsKICAgICAgICAgICAgcmVuZGVyVGVtcGxhdGVTb3VyY2U6IGZ1bmN0aW9uICh0ZW1wbGF0ZVNvdXJjZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIGlmKHRlbXBsYXRlU291cmNlLnRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV2YWx1YXRvcnMgPSB0aGlzLmV2YWx1YXRvcnM7CiAgICAgICAgICAgICAgICAgICAgaWYoIWV2YWx1YXRvcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ldmFsdWF0b3JzID0gZXZhbHVhdG9ycyA9IHRlbXBsYXRlTWFuYWdlci5jb25maWcuZXZhbHVhdG9yc1t0ZW1wbGF0ZU1hbmFnZXIuY29uZmlnLmRlZmF1bHRUeXBlXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFyIHByZWNvbXBpbGVkID0gdGVtcGxhdGVTb3VyY2VbJ2RhdGEnXSgncHJlY29tcGlsZWQnKTsKICAgICAgICAgICAgICAgICAgICBpZighcHJlY29tcGlsZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlY29tcGlsZWQgPSB0ZW1wbGF0ZU1hbmFnZXIuY29tcGlsZSgne3sgd2l0aCgkZGF0YSkgeyB9fSAnICsgdGVtcGxhdGVTb3VyY2UudGV4dCgpICsgIiB7eyB9IH19Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlU291cmNlWydkYXRhJ10oJ3ByZWNvbXBpbGVkJywgcHJlY29tcGlsZWQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBSdW4gdGhlIHRlbXBsYXRlIGFuZCBwYXJzZSBpdHMgb3V0cHV0IGludG8gYW4gYXJyYXkgb2YgRE9NIGVsZW1lbnRzCiAgICAgICAgICAgICAgICAgICAgdmFyIHJlbmRlcmVkTWFya3VwID0gdGVtcGxhdGVTb3VyY2UudGVtcGxhdGUuY29tcGlsZWQoYmluZGluZ0NvbnRleHQpLnJlcGxhY2UoL1xzKy9nLCAiICIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiAoa28pLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KHJlbmRlcmVkTWFya3VwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBvbGRFbmdpbmUucmVuZGVyVGVtcGxhdGVTb3VyY2UuYXBwbHkob2xkRW5naW5lLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjcmVhdGVKYXZhU2NyaXB0RXZhbHVhdG9yQmxvY2s6IGZ1bmN0aW9uIChzY3JpcHQpIHsKICAgICAgICAgICAgICAgIGlmKCF0aGlzLmV2YWx1YXRvckNhY2hlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV2YWx1YXRvcnMgPSB0ZW1wbGF0ZU1hbmFnZXIuY29uZmlnLmV2YWx1YXRvcnNbdGVtcGxhdGVNYW5hZ2VyLmNvbmZpZy5kZWZhdWx0VHlwZV07CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ldmFsdWF0b3JDYWNoZSA9IGV2YWx1YXRvcnMubGVmdCArIHNjcmlwdCArIGV2YWx1YXRvcnMucmlnaHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5ldmFsdWF0b3JDYWNoZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbWFrZVRlbXBsYXRlU291cmNlOiBmdW5jdGlvbiAodGVtcGxhdGUsIHRlbXBsYXRlRG9jdW1lbnQpIHsKICAgICAgICAgICAgICAgIC8vIE5hbWVkIHRlbXBsYXRlCiAgICAgICAgICAgICAgICBpZih0eXBlb2YgdGVtcGxhdGUgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGVmaW5pdGlvbiA9IHRlbXBsYXRlTWFuYWdlci5nZXQodGVtcGxhdGUpOwogICAgICAgICAgICAgICAgICAgIGlmKGRlZmluaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBUaHJ1c3RUZW1wbGF0ZVNvdXJjZShkZWZpbml0aW9uKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gb2xkRW5naW5lLm1ha2VUZW1wbGF0ZVNvdXJjZS5hcHBseShvbGRFbmdpbmUsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICAoa28pLnNldFRlbXBsYXRlRW5naW5lKG5ldyAoa28pLmNvbnZlbnRpb25UZW1wbGF0ZUVuZ2luZSgpKTsKICAgIH07CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBjb3VudGRvd246IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgaW5pdEtub2Nrb3V0SW50ZWdyYXRpb24odGhydXN0LnRlbXBsYXRlKTsKICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy5rbm9ja291dEVuZ2luZSA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1rbm9ja291dC5lbmdpbmUuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvdGVtcGxhdGUvY29udmVudGlvbi90ZW1wbGF0ZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RlbXBsYXRlL3RlbXBsYXRlLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIFRFTVBMQVRFUyA9ICd0ZW1wbGF0ZXMnLCB3aGVuID0gdXRpbC53aGVuLCBlYWNoID0gXy5lYWNoLCBoYXNPd24gPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LCBmaW5kID0gXy5maW5kOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBURU1QTEFURVMKICAgICAgICBdLAogICAgICAgIGluaXQ6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgZGVmZXIgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZXMgPSBtb2QuY29udmVudGlvbihURU1QTEFURVMpLCBpbnZlcnRlZFRlbXBsYXRlcyA9IHV0aWwuaW52ZXJ0KHRlbXBsYXRlcyksIG1vZHVsZUluc3RhbmNlID0gbW9kLmluc3RhbmNlOwogICAgICAgICAgICBpZih0ZW1wbGF0ZXMpIHsKICAgICAgICAgICAgICAgIHZhciBkZWZlcnMgPSBbXTsKICAgICAgICAgICAgICAgIGVhY2godGVtcGxhdGVzLCBmdW5jdGlvbiAodGVtcGxhdGUpIHsKICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YgdGVtcGxhdGUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycy5wdXNoKGZhY2FkZS5mZXRjaCh0ZW1wbGF0ZSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZmFjYWRlLmxvYWRpbmdQcm9taXNlID0gd2hlbi5hbGwoZGVmZXJzKS50aGVuKGZ1bmN0aW9uIChsb2FkZWRUZW1wbGF0ZXMpIHsKICAgICAgICAgICAgICAgICAgICAvKmpzaGludCBsb29wZnVuYzp0cnVlICovCiAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGludmVydGVkVGVtcGxhdGVzLCBmdW5jdGlvbiAoeCwgaSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSBfLmZpbmQobG9hZGVkVGVtcGxhdGVzLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHguc2hvcnROYW1lID09PSBpIHx8IHgubmFtZSA9PT0gaTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZUluc3RhbmNlLnRlbXBsYXRlc1tpXSA9IHRlbXBsYXRlLmNvbXBpbGVkOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHJlYWR5OiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhY2FkZS5sb2FkaW5nUHJvbWlzZSB8fCB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMudGVtcGxhdGUgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9dGVtcGxhdGUuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3Qvc3BhL2NvbmZpZycsWyJyZXF1aXJlIiwgImV4cG9ydHMiXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIC8qKgogICAgUHJvdmlkZXMgdGhydXN0IGNvbmZpZ3VyYXRpb24KICAgIAogICAgQG1vZHVsZSB0aHJ1c3Quc3BhCiAgICBAc3VibW9kdWxlIHRocnVzdC5zcGEuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luLgogICAgCiAgICBUaGlzIGlzIGZvciBpbnRlcm5hbCB0aHJ1c3QgdXNlLiAgVGhydXN0IHVzZXMgdGhpcyBhcnJheSB0byBnZW5lcmF0ZSB0aGUgcHJvcGVydGllcyB0aGF0IG5lZWQgdG8gYmUgaGFuZGVkCiAgICB0byB0aGUgcGx1Z2luIGNvbnN0cnVjdG9yIG1ldGhvZC4KICAgIAogICAgQGZvciB0aHJ1c3Quc3BhLmNvbmZpZwogICAgQHByaXZhdGUKICAgIEBwcm9wZXJ0eSByZXNvbHZlCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtBcnJheX0KICAgICoqLwogICAgZXhwb3J0cy5yZXNvbHZlID0gWwogICAgICAgICdjZmcnLCAKICAgICAgICAnbmFtZScsIAogICAgICAgICdtZWRpYXRvcicKICAgIF07CiAgICAvKioKICAgIFRoZSBzZXQgb2YgY29udmVudGlvbnMgdG8gbG9hZCBpbnRvIHRocnVzdC9tZWRpYXRvci4KICAgIAogICAgQHByb3BlcnR5IGNvbnZlbnRpb25zCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtBcnJheX0KICAgICoqLwogICAgZXhwb3J0cy5jb252ZW50aW9ucyA9IFsKICAgICAgICAndGhydXN0L3NwYS9jb252ZW50aW9uL3N0YXJ0JywgCiAgICAgICAgJ3RocnVzdC9zcGEvY29udmVudGlvbi9zcGFsaW5rJwogICAgXTsKICAgIC8qKgogICAgRGVmaW5lcyB0aGUgdmFsdWUgb2YgY3VzdG9tIHBhcmFtZXRlcnMuCiAgICBZb3UgY2FuIGFsc28gZGVmaW5lIGN1c3RvbSBwYXJhbWV0ZXJzIHRvIGJlIGEgcmVndWxhciBleHByZXNzaW9uLCBhbmQgdGhlbiB1c2UgdGhlbSBpbiB5b3VyIHJvdXRlcwogICAgCiAgICBAcHJvcGVydHkgcGFyYW1zCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtPYmplY3R9CiAgICAqKi8KICAgIGV4cG9ydHMucGFyYW1zID0gewogICAgfTsKICAgIC8qKgogICAgVGhlIHByZWRmaW5lZCByb3V0ZXMgdG8gYmUgdXNlZCBieSBzcGEuCiAgICAKICAgIEBwcm9wZXJ0eSByb3V0ZXMKICAgIEByZWFkT25seQogICAgQHR5cGUge09iamVjdH0KICAgICoqLwogICAgZXhwb3J0cy5yb3V0ZXMgPSB7CiAgICB9OwogICAgLyoqCiAgICBUaGUgZmlsZSBleHN0ZW5pb24gdGhhdCBzaG91bGQgYmUgcmVtb3ZlZCB3aGVuIHJlc29sdmluZyByb3V0ZXMgYW5kIHN0YXJ0aW5nIG1vZHVsZXMuCiAgICAKICAgIEBwcm9wZXJ0eSBmaWxlRXh0ZW5zaW9uCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtTdHJpbmd9CiAgICAqKi8KICAgIGV4cG9ydHMuZmlsZUV4dGVuc2lvbiA9ICcuaHRtbCc7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWNvbmZpZy5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9zcGEvY29udmVudGlvbi9zcGFsaW5rJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QvZG9tL3N1YmpxdWVyeSddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18sIF9fc3VianF1ZXJ5X18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2RvbS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9zcGEvc3BhLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIHN1YmpxdWVyeSA9IF9fc3VianF1ZXJ5X187CgogICAgdmFyICQgPSBzdWJqcXVlcnkudFF1ZXJ5OwogICAgdmFyIHBhcnNlRnVsbEhyZWYgPSBmdW5jdGlvbiAoaHJlZikgewogICAgICAgIHZhciBiYXNlVXJsID0gbG9jYXRpb24ucGF0aG5hbWUuc3Vic3RyaW5nKDAsIGxvY2F0aW9uLnBhdGhuYW1lLmxhc3RJbmRleE9mKCcvJykpOwogICAgICAgIGlmKGhyZWYuaW5kZXhPZignLycpICE9IC0xKSB7CiAgICAgICAgICAgIGhyZWYgPSBocmVmLnN1YnN0cmluZyhocmVmLmxhc3RJbmRleE9mKCcvJykpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGhyZWYgPSAnLycgKyBocmVmOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYmFzZVVybCArIGhyZWY7CiAgICB9OwogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC5kb20KICAgIEBzdWJtb2R1bGUgdGhydXN0LmRvbS5jb252ZW50aW9uCiAgICAqKi8KICAgIC8qKgogICAgKiAjIF9fdGhydXN0L2RvbV9fIENvbnZlbnRpb24gLSBTaW5nbGUgUGFnZSBBcHAgTGluawogICAgKgogICAgKiBSZXF1aXJlcyB0aHJ1c3QvZG9tCiAgICAqCiAgICAqIEBmb3IgdGhydXN0LmRvbS5jb252ZW50aW9uCiAgICAqIEBwcm9wZXJ0eSBzcGE7aW5rCiAgICAqKi8KICAgIHZhciBtZXRob2RzID0gewogICAgICAgIG9yYml0OiBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIHZhciBjb25maWcgPSB0aHJ1c3QuY29uZmlnLCBzcGEgPSB0aHJ1c3Quc3BhOwogICAgICAgICAgICAkLm9uKCdjbGljaycsICdhJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgIHZhciBsaW5rID0gcGFyc2VGdWxsSHJlZih0aGlzLmdldEF0dHJpYnV0ZSgnaHJlZicpKTsKICAgICAgICAgICAgICAgIGlmKGxpbmsuaW5kZXhPZihjb25maWcudXJsLnBhdGgpID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgc3BhLm5hdmlnYXRlKGxpbmspOwogICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuc3BhbGluayA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1zcGFsaW5rLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3NwYS9jb252ZW50aW9uL3N0YXJ0JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvc3BhL3NwYS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90ZW1wbGF0ZS90ZW1wbGF0ZS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIC8qKgogICAgQG1vZHVsZSB0aHJ1c3Quc3BhCiAgICBAc3VibW9kdWxlIHRocnVzdC5zcGEuY29udmVudGlvbgogICAgKiovCiAgICAvKioKICAgICogIyBfX3RocnVzdC9zcGFfXyBDb252ZW50aW9uIC0gU3RhcnQKICAgICoKICAgICogVGhlIHNpbmdsZSBwYWdlIGFwcCBzdGFydCBjb252ZW50aW9uLCBkb2VzIHRoZSBhY3R1YWwgc3RhcnRpbmcgb2YgdGhlIHBsdWdpbiwgaW4gYWRkaXRpb24gaXQgYWxzbyBkZWxheXMKICAgICogZnVsbCBvcmJpdCwgdW50aWwgYW55IG1vZHVsZSBpdCBoYXMgc3RhcnRlZCBoYXMgYmVlbiBsb2FkZWQuCiAgICAqCiAgICAqIEBmb3IgdGhydXN0LnNwYS5jb252ZW50aW9uCiAgICAqIEBwcm9wZXJ0eSBzdGFydAogICAgKiovCiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBvcmJpdDogZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB2YXIgcm91dGVyID0gdGhydXN0LnNwYTsKICAgICAgICAgICAgcm91dGVyLnN0YXJ0KCk7CiAgICAgICAgICAgIHJldHVybiB0aHJ1c3Quc3BhLnN0YXJ0aW5nTW9kdWxlUHJvbWlzZSB8fCBudWxsOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLnN0YXJ0ID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPXN0YXJ0LmpzLm1hcAo7CmRlZmluZSgndGhydXN0L21lZGlhdG9yL21haW4nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC91dGlsJywgJ3RocnVzdC9sb2cnLCAndGhydXN0L2V2ZW50cycsICd0aHJ1c3QvZmFjYWRlJywgJ2hhcycsICd0aHJ1c3QvY29uZmlnJywgJy4vY29uZmlnJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdXRpbF9fLCBfX2xvZ19fLCBfX2V2ZW50c19fLCBfX2ZhY2FkZV9fLCBfX2hhc19fLCBfX2NvbmZpZ19fLCBfX21lZGlhdG9yQ29uZmlnX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2hhcy5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9tZWRpYXRvci5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgbG9nID0gX19sb2dfXzsKCiAgICAvL2ltcG9ydCBldmVudHMgPSBtb2R1bGUoJ3RocnVzdC9ldmVudHMnKTsKICAgIHZhciBldmVudHMgPSBfX2V2ZW50c19fOwoKICAgIHZhciBFdmVudHMgPSBldmVudHMuRXZlbnRzOwogICAgdmFyIGZhY2FkZSA9IF9fZmFjYWRlX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIGNvbmZpZyA9IF9fY29uZmlnX187CgogICAgdmFyIG1lZGlhdG9yQ29uZmlnID0gX19tZWRpYXRvckNvbmZpZ19fOwoKICAgIGV4cG9ydHMuY2xhc3NOYW1lID0gJ01lZGlhdG9yJzsKICAgIC8vIFZhcmlhYmxlIGRlY2xhcmF0aW9uLgogICAgICAgIHZhciBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgZXh0ZW5kID0gLy8gc3RyaW5nIGZvcm1hdCBtZXRob2QKICAgIF8uZXh0ZW5kLCB3aGVuID0gLy8gb2JqZWN0IGV4dGVuc2lvbiBtZXRob2QKICAgIHV0aWwud2hlbiwgbWVtb2l6ZSA9IF8ubWVtb2l6ZSwgbWVkaWF0b3IsIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwogICAgdmFyIGMgPSBjb25maWc7CiAgICAvLyNyZWdpb24gRmFjYWRlCiAgICAvKioKICAgIENyZWF0ZXMgYSBuZXcgbWVkaWF0b3IgZmFjYWRlIGZvciB0aGUgZ2l2ZW4gbW9kdWxlLgogICAgCiAgICBAZm9yIHRocnVzdC5tZWRpYXRvcgogICAgQGNsYXNzIHRocnVzdC5tZWRpYXRvci5NZWRpYXRvckZhY2FkZQogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge3RocnVzdC5Nb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIHRvIGNyZWF0ZSB0aGUgZmFjYWRlIGZvcgogICAgQHBhcmFtIHt0aHJ1c3QuTWVkaWF0b3J9IHBhcmVudCBUaGUgcGFyZW50IG1lZGlhdG9yIHRvIGNyZWF0ZSB0aGUgZmFjYWRlIG9uLgogICAgKiovCiAgICB2YXIgTWVkaWF0b3JGYWNhZGUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBtZWRpYXRvckZhY2FkZSA9IGZhY2FkZS5jcmVhdGVGYWNhZGUoZnVuY3Rpb24gKG1vZHVsZSwgcGFyZW50KSB7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IG1vZHVsZS5uYW1lOwogICAgICAgICAgICB0aGlzLm1vZHVsZSA9IG1vZHVsZTsKICAgICAgICAgICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CiAgICAgICAgICAgIHRoaXMuX19jb252ZW50aW9ucyA9IHBhcmVudC5fX2NvbnZlbnRpb25zOwogICAgICAgICAgICB0aGlzLl9jYWxsYmFja3MgPSBwYXJlbnQuX2NhbGxiYWNrczsKICAgICAgICAgICAgdGhpcy5pbml0RXZlbnRzKG1vZHVsZSk7CiAgICAgICAgfSk7CiAgICAgICAgXy5leHRlbmQobWVkaWF0b3JGYWNhZGUucHJvdG90eXBlLCBFdmVudHMpOwogICAgICAgIC8qKgogICAgICAgIER1cmluZyB0aGUgc3RhcnQgb2YgYSBtZWRpYXRvciBmYWNhZGUsIHN0YXJ0IGNyZWF0ZXMgdGhlIGludGVybmFsIHN1YnNjcmlwdGlvbnMgYXJyYXkuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QubWVkaWF0b3IuTWVkaWF0b3JGYWNhZGUKICAgICAgICBAbWV0aG9kIHN0YXJ0CiAgICAgICAgKiovCiAgICAgICAgbWVkaWF0b3JGYWNhZGUucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbiAobSkgewogICAgICAgICAgICBpZighdGhpcy5faW50ZXJuYWxTdWJzY3JpcHRpb25zKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9pbnRlcm5hbFN1YnNjcmlwdGlvbnMgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIG1lZGlhdG9yRmFjYWRlLnByb3RvdHlwZS5zdGFydCA9IG1lZGlhdG9yRmFjYWRlLnByb3RvdHlwZS5pbml0OwogICAgICAgIC8qKgogICAgICAgIE92ZXJyaWRlcyB0aGUgc3Vic2NyaWJlIG1ldGhvZCwgYW5kIHRyYWNrcyB0aGUgYW55IGV2ZW50IHRoYXQgaXMgYm91bmQuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QubWVkaWF0b3IuTWVkaWF0b3JGYWNhZGUKICAgICAgICBAbWV0aG9kIHN1YnNjcmliZQogICAgICAgICoqLwogICAgICAgIChtZWRpYXRvckZhY2FkZSkucHJvdG90eXBlLnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgICAgIHRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9ucy5wdXNoKHsKICAgICAgICAgICAgICAgIGV2ZW50czogZXZlbnRzLAogICAgICAgICAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrLAogICAgICAgICAgICAgICAgY29udGV4dDogY29udGV4dAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgRXZlbnRzLnN1YnNjcmliZS5jYWxsKHRoaXMsIGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpOwogICAgICAgIH07CiAgICAgICAgLyoqCiAgICAgICAgVW5zdWJzY3JpYmVzIGZyb20gYWxsIGV2ZW50cyB0aGF0IHdlcmUgc3Vic2NyaWJlZCB0by4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5tZWRpYXRvci5NZWRpYXRvckZhY2FkZQogICAgICAgIEBtZXRob2Qgc3RvcAogICAgICAgICoqLwogICAgICAgIG1lZGlhdG9yRmFjYWRlLnByb3RvdHlwZS5zdG9wID0gZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgaWYodGhpcy5faW50ZXJuYWxTdWJzY3JpcHRpb25zKSB7CiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSB0aGlzLl9pbnRlcm5hbFN1YnNjcmlwdGlvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc3ViID0gdGhpcy5faW50ZXJuYWxTdWJzY3JpcHRpb25zW2ldOwogICAgICAgICAgICAgICAgICAgIHRoaXMudW5zdWJzY3JpYmUoc3ViLmV2ZW50cywgc3ViLmNhbGxiYWNrLCBzdWIuY29udGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9pbnRlcm5hbFN1YnNjcmlwdGlvbnMgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIG1lZGlhdG9yRmFjYWRlOwogICAgfSkoKTsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8gT3VyIGRlZmF1bHQgbmFtZXNwYWNlIHByZWZpeC4KICAgIC8qKgogICAgTWVkaWF0b3IgY2xhc3MuCiAgICBUaGlzIGNyZWF0ZXMgYSBpbnN0YW5jZSBvZiB0aGUgbWVkaWF0b3IsIGZvciB1c2UgaW5zaWRlIHRocnVzdC4KICAgIAogICAgQGZvciB0aHJ1c3QubWVkaWF0b3IKICAgIEBjbGFzcyB0aHJ1c3QubWVkaWF0b3IuTWVkaWF0b3IKICAgIEBjb25zdHJ1Y3RvcgogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIG1lZGlhdG9yLgogICAgKiovCiAgICB2YXIgTWVkaWF0b3IgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIC8vI2VuZHJlZ2lvbgogICAgICAgIGZ1bmN0aW9uIE1lZGlhdG9yKG5hbWUsIGNvbmZpZykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGFwcFBhdGggPSBjb25maWcgJiYgY29uZmlnLnVybCAmJiBjb25maWcudXJsLnBhdGg7CiAgICAgICAgICAgIHRoYXQubmFtZSA9IG5hbWU7CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ01lZGlhdG9yOiBDcmVhdGluZyBuZXcgTWVkaWF0b3IgezB9JywgbmFtZSkpOwogICAgICAgICAgICB0aGF0LmluaXRFdmVudHMoKTsKICAgICAgICAgICAgdGhhdC5zdWJzY3JpYmUoJ3RocnVzdC9yZWFkeScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGZhbHNlICYmIGxvZy5pbmZvKCdNZWRpYXRvcjogUmVhZHkhJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBNZWRpYXRvci5wcm90b3R5cGUuaW5pdEV2ZW50cyA9IC8vI3JlZ2lvbiBFdmVudHMKICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgfTsKICAgICAgICBNZWRpYXRvci5wcm90b3R5cGUuZXh0ZW5kID0gZnVuY3Rpb24gKHRvLCBpbml0KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgTWVkaWF0b3IucHJvdG90eXBlLnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0LCBvbmNlKSB7CiAgICAgICAgfTsKICAgICAgICBNZWRpYXRvci5wcm90b3R5cGUudW5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIH07CiAgICAgICAgTWVkaWF0b3IucHJvdG90eXBlLm9uY2UgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIH07CiAgICAgICAgTWVkaWF0b3IucHJvdG90eXBlLmNyZWF0ZUZhY2FkZSA9IGZ1bmN0aW9uICh0aHJ1c3QsIG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICBpZihmYWNhZGVzLm1lZGlhdG9yICYmICEoZmFjYWRlcy5tZWRpYXRvciBpbnN0YW5jZW9mIE1lZGlhdG9yRmFjYWRlKSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCcibWVkaWF0b3IiIGlzIGEgcmVzZXJ2ZWQgcHJvcGVydHknKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbWVkaWF0b3I7CiAgICAgICAgICAgIGlmKGZhY2FkZXMubWVkaWF0b3IpIHsKICAgICAgICAgICAgICAgIGZhY2FkZXMubWVkaWF0b3IudXBkYXRlRmFjYWRlKG1vZCwgdGhpcyk7CiAgICAgICAgICAgICAgICBtZWRpYXRvciA9IGZhY2FkZXMubWVkaWF0b3I7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtZWRpYXRvciA9IGZhY2FkZXMubWVkaWF0b3IgPSAobW9kKS5tZWRpYXRvciA9IG5ldyBNZWRpYXRvckZhY2FkZShtb2QsIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtZWRpYXRvcjsKICAgICAgICB9OwogICAgICAgIE1lZGlhdG9yLmNvbmZpZyA9IG1lZGlhdG9yQ29uZmlnOwogICAgICAgIHJldHVybiBNZWRpYXRvcjsKICAgIH0pKCk7CiAgICBleHBvcnRzLk1lZGlhdG9yID0gTWVkaWF0b3I7ICAgIAogICAgLy8gR2V0IHRoZSBhY3R1YWwgZXZlbnQgbWV0aG9kcyBvbnRvIHRoZSBNZWRpYXRvcgogICAgXy5leHRlbmQoTWVkaWF0b3IucHJvdG90eXBlLCBFdmVudHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L21lZGlhdG9yJywgWyd0aHJ1c3QvbWVkaWF0b3IvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgpkZWZpbmUoJ3RocnVzdC9kYXRhL21haW4nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJywgJ2pxdWVyeScsICd0aHJ1c3QvbG9nJywgJy4vY29uZmlnJywgJ3RocnVzdC9jb25maWcnLCAnLi9ldmVudC5mYWN0b3J5JywgJy4vcmVzcG9uc2UucXVldWUnLCAndGhydXN0L2V2ZW50cycsICd0aHJ1c3QvZmFjYWRlJywgJy4vZXZlbnQudHlwZXMnLCAnaGFzJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXywgX19qUXVlcnlfXywgX19sb2dfXywgX19jb25maWdfXywgX190Q29uZmlnX18sIF9fZXZlbnRGYWN0b3J5X18sIF9fcmVzcG9uc2VRdWV1ZV9fLCBfX2V2ZW50c19fLCBfX2ZhY2FkZV9fLCBfX2V2ZW50VHlwZXNfXywgX19oYXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9kYXRhL2RhdGEuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2pxdWVyeS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIGpRdWVyeSA9IF9falF1ZXJ5X187CgogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIGNvbmZpZyA9IF9fY29uZmlnX187CgogICAgdmFyIHRDb25maWcgPSBfX3RDb25maWdfXzsKCiAgICB2YXIgZXZlbnRGYWN0b3J5ID0gX19ldmVudEZhY3RvcnlfXzsKCiAgICB2YXIgcmVzcG9uc2VRdWV1ZSA9IF9fcmVzcG9uc2VRdWV1ZV9fOwoKICAgIHZhciBSZXNwb25zZVF1ZXVlID0gcmVzcG9uc2VRdWV1ZS5SZXNwb25zZVF1ZXVlOwogICAgdmFyIGV2ZW50cyA9IF9fZXZlbnRzX187CgogICAgdmFyIEV2ZW50cyA9IGV2ZW50cy5FdmVudHM7CiAgICB2YXIgZmFjYWRlID0gX19mYWNhZGVfXzsKCiAgICB2YXIgZXZlbnRUeXBlcyA9IF9fZXZlbnRUeXBlc19fOwoKICAgIHZhciBoYXMgPSBfX2hhc19fOwoKICAgIGV4cG9ydHMuY2xhc3NOYW1lID0gJ0RhdGEnOwogICAgY29uZmlnOwogICAgLy8gVmFyaWFibGUgZGVjbGFyYXRpb24uCiAgICAgICAgdmFyIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCBleHRlbmQgPSBfLmV4dGVuZCwgd2hlbiA9IHV0aWwud2hlbiwgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsIGFqYXggPSBqUXVlcnkuYWpheCwgdWlkID0gXy51bmlxdWVJZCwgZGF0YUV2ZW50V2FpdCA9IGV2ZW50VHlwZXNbJ3dhaXQnXSwgZGF0YUV2ZW50U3RhcnQgPSBldmVudFR5cGVzWydzdGFydCddLCBkYXRhRXZlbnRTdG9wID0gZXZlbnRUeXBlc1snc3RvcCddLCBkYXRhRXZlbnRTdGF0dXMgPSBldmVudFR5cGVzWydzdGF0dXMnXSwgYXJndW1lbnRSZXNvbHZlciA9IGZ1bmN0aW9uIChtZXRob2QpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gbWV0aG9kKF8udG9BcnJheShhcmd1bWVudHMpKTsKICAgICAgICB9OwogICAgfTsKICAgIGpRdWVyeS5hamF4U2V0dGluZ3MudHJhZGl0aW9uYWwgPSAhIXRDb25maWcudXJsLnRyYWRpdGlvbmFsRW5jb2Rpbmc7CiAgICB2YXIgakRvYyA9IGpRdWVyeShkb2N1bWVudCk7CiAgICBldmVudEZhY3RvcnkuaW5pdChqRG9jKTsKICAgIC8vI3JlZ2lvbiBEYXRhRmFjYWRlCiAgICAvKioKICAgIFRoZSBkYXRhIGZhY2FkZSB0aGF0IGlzIGhhbmRlZCBvZmYgdG8gbW9kdWxlcy4KICAgIAogICAgCiAgICBFbmFibGVzIGRhdGEgdHJhbnNwb3J0LCB1c2luZyBqUXVlcnkgZm9yIHRocnVzdC4KICAgIAogICAgQGZvciB0aHJ1c3QuZGF0YQogICAgQGNsYXNzIHRocnVzdC5kYXRhLkRhdGFGYWNhZGUKICAgIEBwYXJhbSB7dGhydXN0Lk1vZHVsZX0gbW9kdWxlIFRoZSBtb2R1bGUgdG8gY3JlYXRlIHRoZSBmYWNhZGUgZm9yCiAgICBAcGFyYW0ge3RocnVzdC5kYXRhLkRhdGF9IHBhcmVudCBUaGUgcGFyZW50IHRocnVzdCBkYXRhIG9iamVjdCB0byBjcmVhdGUgdGhlIGZhY2FkZSBmb3IuCiAgICBAY29uc3RydWN0b3IKICAgICoqLwogICAgdmFyIERhdGFGYWNhZGUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBkYXRhRmFjYWRlID0gZmFjYWRlLmNyZWF0ZUZhY2FkZShmdW5jdGlvbiAobW9kdWxlLCBwYXJlbnQpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gbW9kdWxlLm5hbWUgKyAnLWRhdGEnOwogICAgICAgICAgICB0aGlzLm1vZHVsZSA9IG1vZHVsZTsKICAgICAgICAgICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CiAgICAgICAgICAgIHRoaXMuX19jb252ZW50aW9ucyA9IHBhcmVudC5fX2NvbnZlbnRpb25zOwogICAgICAgICAgICB0aGlzLl9jYWxsYmFja3MgPSBwYXJlbnQuX2NhbGxiYWNrczsKICAgICAgICAgICAgdGhpcy5yZXNwb25zZVF1ZXVlID0gcGFyZW50LnJlc3BvbnNlUXVldWU7CiAgICAgICAgICAgIHRoaXMuaW5pdEV2ZW50cygpOwogICAgICAgICAgICB0aGlzLmRlZmF1bHRzID0gcGFyZW50LmRlZmF1bHRzOwogICAgICAgICAgICB0aGlzLmFwcFBhdGggPSBwYXJlbnQuYXBwUGF0aDsKICAgICAgICB9KTsKICAgICAgICBfLmV4dGVuZChkYXRhRmFjYWRlLnByb3RvdHlwZSwgZXZlbnRzKTsKICAgICAgICByZXR1cm4gZGF0YUZhY2FkZTsKICAgIH0pKCk7CiAgICAvLyNlbmRyZWdpb24KICAgIC8qKgogICAgVGhlIG1hc3RlciBkYXRhIHBsdWdpbi4KICAgIAogICAgCiAgICBFbmFibGVzIGRhdGEgdHJhbnNwb3J0LCB1c2luZyBqUXVlcnkgZm9yIHRocnVzdC4KICAgIAogICAgQGZvciB0aHJ1c3QuZGF0YQogICAgQGNsYXNzIHRocnVzdC5kYXRhLkRhdGEKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0aHJ1c3QgaW5zdGFuY2UgbmFtZS4KICAgIEBwYXJhbSB7dGhydXN0Lm1lZGlhdG9yLk1lZGlhdG9yfSBtZWRpYXRvciBUaGUgdGhydXN0IG1lZGlhdG9yIGluc3RhbmNlLgogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgdGhydXN0IGluc3RhbmNlIGNvbmZpZ3VyYXRpb24uCiAgICBAY29uc3RydWN0b3IKICAgICoqLwogICAgdmFyIERhdGEgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIC8vI2VuZHJlZ2lvbgogICAgICAgIGZ1bmN0aW9uIERhdGEobmFtZSwgbWVkaWF0b3IsIGNvbmZpZykgewogICAgICAgICAgICBpZighbmFtZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEYXRhOiBtb2R1bGUgbmFtZSBtdXN0IGJlIGRlZmluZWQuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICAgICAgdGhpcy5yZXNwb25zZVF1ZXVlID0gbmV3IFJlc3BvbnNlUXVldWUodGhpcywgY29uZmlnLmRhdGEuc3RhcnRUaW1lb3V0LCBjb25maWcuZGF0YS5maW5pc2hUaW1lb3V0KTsKICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKCdEYXRhOiBDcmVhdGluZyBuZXcgRGF0YScpOwogICAgICAgICAgICB0aGlzLm1lZGlhdG9yID0gbWVkaWF0b3I7CiAgICAgICAgICAgIHRoaXMuX2NhbGxiYWNrcyA9ICh0aGlzKS5tZWRpYXRvci5fY2FsbGJhY2tzOwogICAgICAgICAgICB0aGlzLmluaXRFdmVudHMoKTsKICAgICAgICAgICAgdGhpcy5kZWZhdWx0cyA9IHsKICAgICAgICAgICAgICAgIGNhY2hlOiBjb25maWcuZGF0YS5jYWNoZSwKICAgICAgICAgICAgICAgIGJlZm9yZVNlbmQ6IGV2ZW50RmFjdG9yeS5iZWZvcmVTZW5kTWV0aG9kLAogICAgICAgICAgICAgICAgY29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICAgICAgICAgIHR5cGU6ICdQT1NUJywKICAgICAgICAgICAgICAgIHVybDogJycsCiAgICAgICAgICAgICAgICBkYXRhOiAnJywKICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAnanNvbicsCiAgICAgICAgICAgICAgICBfX21lZGlhdG9yX2RhdGFfZmlyZWRfXzogdHJ1ZSwKICAgICAgICAgICAgICAgIHNpbGVudDogZmFsc2UKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5hcHBQYXRoID0gY29uZmlnLnVybC5wYXRoICsgJy8nOwogICAgICAgIH0KICAgICAgICBEYXRhLnByb3RvdHlwZS5pbml0RXZlbnRzID0gLy8jcmVnaW9uIEV2ZW50cwogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLmV4dGVuZCA9IGZ1bmN0aW9uICh0bywgaW5pdCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0LCBvbmNlKSB7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS51bnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5vbmNlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLmNyZWF0ZUZhY2FkZSA9IC8qKgogICAgICAgIENyZWF0ZXMgYSBEYXRhRmFjYWRlIGZvciB0aGUgZ2l2ZW4gbW9kdWxlLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YQogICAgICAgIEBtZXRob2QgY3JlYXRlRmFjYWRlCiAgICAgICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlCiAgICAgICAgQHBhcmFtIHtNb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgVGhlIGF2YWlsYWJsZSBmYWNhZGVzCiAgICAgICAgQHJldHVybnMge0RhdGFGYWNhZGV9IFRoZSBuZXcgRGF0YUZhY2FkZQogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0aHJ1c3QsIG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICBpZihtb2QuZGF0YSAmJiAhKGZhY2FkZXMuZGF0YSBpbnN0YW5jZW9mIERhdGFGYWNhZGUpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJyJkYXRhIiBpcyBhIHJlc2VydmVkIHByb3BlcnR5Jyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRhdGE7CiAgICAgICAgICAgIGlmKGZhY2FkZXMuZGF0YSkgewogICAgICAgICAgICAgICAgZmFjYWRlcy5kYXRhLnVwZGF0ZUZhY2FkZShtb2QsIHRoaXMpOwogICAgICAgICAgICAgICAgZGF0YSA9IGZhY2FkZXMuZGF0YTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRhdGEgPSBmYWNhZGVzLmRhdGEgPSBtb2QuZGF0YSA9IG5ldyBEYXRhRmFjYWRlKG1vZCwgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5nZXREYXRhID0gLyoqCiAgICAgICAgRG9lcyBhIEdFVCB0byB0aGUgc2VydmVyLCBmb3IgdGhlIGdpdmVuIGRhdGEgYW5kIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YQogICAgICAgIEBtZXRob2QgZ2V0RGF0YQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBnZXQgZGF0YSBmcm9tCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGRhdGEgVGhlIGRhdGEgdG8gcGFzcyB0byB0aGUgZ2l2ZW4gdXJsCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW5ncyBvZiB0aGUgdGFzayB0byBiZSBkb25lCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5jYWNoZSBEbyB3ZSBjYWNoZSB0aGlzIGNhbGwgb3Igbm90LgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3Muc2lsZW50IERvIHdlIHVzZSB0aGUgYnVpbHQgaW4gZGF0YSBxdWV1ZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgaWYgdGhpcyByZXF1ZXN0IGNvbXBsZXRlcyBvciBmYWlscwogICAgICAgICoqLwogICAgICAgIC8qKgogICAgICAgIERvZXMgYSBHRVQgdG8gdGhlIHNlcnZlciwgZm9yIHRoZSBnaXZlbiBkYXRhIGFuZCBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGFGYWNhZGUKICAgICAgICBAbWV0aG9kIGdldERhdGEKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBkYXRhIFRoZSBkYXRhIHRvIHBhc3MgdG8gdGhlIGdpdmVuIHVybAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodXJsLCBkYXRhLCBzZXR0aW5ncykgewogICAgICAgICAgICBzZXR0aW5ncyA9ICFzZXR0aW5ncyA/IHsKICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSA6IGV4dGVuZChzZXR0aW5ncywgewogICAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KHVybCwgc2V0dGluZ3MpOwogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUucG9zdERhdGEgPSAvKioKICAgICAgICBEb2VzIGEgUE9TVCB0byB0aGUgc2VydmVyLCBmb3IgdGhlIGdpdmVuIGRhdGEgYW5kIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YQogICAgICAgIEBtZXRob2QgcG9zdERhdGEKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBkYXRhIFRoZSBkYXRhIHRvIHBhc3MgdG8gdGhlIGdpdmVuIHVybAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICAvKioKICAgICAgICBEb2VzIGEgUE9TVCB0byB0aGUgc2VydmVyLCBmb3IgdGhlIGdpdmVuIGRhdGEgYW5kIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YUZhY2FkZQogICAgICAgIEBtZXRob2QgcG9zdERhdGEKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBkYXRhIFRoZSBkYXRhIHRvIHBhc3MgdG8gdGhlIGdpdmVuIHVybAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodXJsLCBkYXRhLCBzZXR0aW5ncykgewogICAgICAgICAgICBzZXR0aW5ncyA9ICFzZXR0aW5ncyA/IHsKICAgICAgICAgICAgICAgIGRhdGE6IEpTT04uc3RyaW5naWZ5KGRhdGEpCiAgICAgICAgICAgIH0gOiBleHRlbmQoc2V0dGluZ3MsIHsKICAgICAgICAgICAgICAgIGRhdGE6IEpTT04uc3RyaW5naWZ5KGRhdGEpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdGhpcy5wb3N0KHVybCwgc2V0dGluZ3MpOwogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUuZ2V0ID0gLyoqCiAgICAgICAgRG9lcyBhIEdFVCB0byB0aGUgc2VydmVyLCB1c2luZyB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgRGF0YSBtdXN0IGJlIHBhc3NlZCBpbiB1c2luZyBzZXR0aW5nczogeyBkYXRhOiB7fSB9IG90aGVyd2lzZSB1c2UgZ2V0RGF0YS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGEKICAgICAgICBAbWV0aG9kIGdldAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBnZXQgZGF0YSBmcm9tCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW5ncyBvZiB0aGUgdGFzayB0byBiZSBkb25lCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5jYWNoZSBEbyB3ZSBjYWNoZSB0aGlzIGNhbGwgb3Igbm90LgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3Muc2lsZW50IERvIHdlIHVzZSB0aGUgYnVpbHQgaW4gZGF0YSBxdWV1ZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgaWYgdGhpcyByZXF1ZXN0IGNvbXBsZXRlcyBvciBmYWlscwogICAgICAgICoqLwogICAgICAgIC8qKgogICAgICAgIERvZXMgYSBHRVQgdG8gdGhlIHNlcnZlciwgdXNpbmcgdGhlIGdpdmVuIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIERhdGEgbXVzdCBiZSBwYXNzZWQgaW4gdXNpbmcgc2V0dGluZ3M6IHsgZGF0YToge30gfSBvdGhlcndpc2UgdXNlIGdldERhdGEuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhRmFjYWRlCiAgICAgICAgQG1ldGhvZCBnZXQKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodXJsLCBzZXR0aW5ncykgewogICAgICAgICAgICBpZihzZXR0aW5ncyA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiB1cmwgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncyA9IHVybDsKICAgICAgICAgICAgICAgIHVybCA9IHNldHRpbmdzLnVybDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih1cmwgPT09IHVuZGVmaW5lZCAmJiBzZXR0aW5ncy51cmwgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdXJsID0gc2V0dGluZ3MudXJsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHVybCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHVybCBpcyBkZWZpbmVkJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWpheCh1cmwsIGV4dGVuZChzZXR0aW5ncyB8fCB7CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIHR5cGU6ICdnZXQnCiAgICAgICAgICAgIH0pKTsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLnBvc3QgPSAvKioKICAgICAgICBEb2VzIGEgUE9TVCB0byB0aGUgc2VydmVyLCB1c2luZyB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgRGF0YSBtdXN0IGJlIHBhc3NlZCBpbiB1c2luZyBzZXR0aW5nczogeyBkYXRhOiB7fSB9IG90aGVyd2lzZSB1c2UgcG9zdERhdGEuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhCiAgICAgICAgQG1ldGhvZCBwb3N0CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgLyoqCiAgICAgICAgRG9lcyBhIFBPU1QgdG8gdGhlIHNlcnZlciwgdXNpbmcgdGhlIGdpdmVuIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIERhdGEgbXVzdCBiZSBwYXNzZWQgaW4gdXNpbmcgc2V0dGluZ3M6IHsgZGF0YToge30gfSBvdGhlcndpc2UgdXNlIHBvc3REYXRhLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YUZhY2FkZQogICAgICAgIEBtZXRob2QgcG9zdAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBnZXQgZGF0YSBmcm9tCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW5ncyBvZiB0aGUgdGFzayB0byBiZSBkb25lCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5jYWNoZSBEbyB3ZSBjYWNoZSB0aGlzIGNhbGwgb3Igbm90LgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3Muc2lsZW50IERvIHdlIHVzZSB0aGUgYnVpbHQgaW4gZGF0YSBxdWV1ZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgaWYgdGhpcyByZXF1ZXN0IGNvbXBsZXRlcyBvciBmYWlscwogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh1cmwsIHNldHRpbmdzKSB7CiAgICAgICAgICAgIGlmKHNldHRpbmdzID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIHVybCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gdXJsOwogICAgICAgICAgICAgICAgdXJsID0gc2V0dGluZ3MudXJsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHVybCA9PT0gdW5kZWZpbmVkICYmIHNldHRpbmdzLnVybCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB1cmwgPSBzZXR0aW5ncy51cmw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodXJsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gdXJsIGlzIGRlZmluZWQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5hamF4KHVybCwgZXh0ZW5kKHNldHRpbmdzIHx8IHsKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgdHlwZTogJ3Bvc3QnCiAgICAgICAgICAgIH0pKTsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLmFqYXggPSAvKioKICAgICAgICBEb2VzIGFuIGFqYXggY2FsbCB0byB0aGUgZ2l2ZW4gdXJsLCB3aXRoIHRoZSBnaXZlbiBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGEKICAgICAgICBAbWV0aG9kIGFqYXgKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICAvKioKICAgICAgICBEb2VzIGFuIGFqYXggY2FsbCB0byB0aGUgZ2l2ZW4gdXJsLCB3aXRoIHRoZSBnaXZlbiBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGFGYWNhZGUKICAgICAgICBAbWV0aG9kIGFqYXgKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodXJsLCBzZXR0aW5ncykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIG9wdGlvbnMsIHR5cGUsIGJlZm9yZVNlbmQ7CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5pbmZvKGZvcm1hdCgnRGF0YVt7MH1dOiBGZXRjaGluZyBkYXRhIGZyb20gInsxfSInLCB0aGF0Lm5hbWVzcGFjZSwgdXJsKSk7CiAgICAgICAgICAgIGlmKHNldHRpbmdzID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIHVybCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gdXJsOwogICAgICAgICAgICAgICAgdXJsID0gc2V0dGluZ3MudXJsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFzZXR0aW5ncykgewogICAgICAgICAgICAgICAgc2V0dGluZ3MgPSB7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHVybCA9PT0gdW5kZWZpbmVkICYmIHNldHRpbmdzLnVybCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB1cmwgPSBzZXR0aW5ncy51cmw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXJsID0gdXRpbC5maXh1cFVybCh1cmwsIHRoYXQuYXBwUGF0aCk7CiAgICAgICAgICAgIGlmKHNldHRpbmdzLnNpbGVudCkgewogICAgICAgICAgICAgICAgdmFyIGRmbyA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgICAgIHZhciBxdWVyeUlkID0gdWlkKCdkcScpOwogICAgICAgICAgICAgICAgdHlwZSA9IHNldHRpbmdzLnR5cGUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSBleHRlbmQoewogICAgICAgICAgICAgICAgfSwgdGhhdC5kZWZhdWx0cywgewogICAgICAgICAgICAgICAgICAgIGJlZm9yZVNlbmQ6IHV0aWwubm9vcAogICAgICAgICAgICAgICAgfSwgc2V0dGluZ3MpOwogICAgICAgICAgICAgICAgYWpheCh1cmwsIG9wdGlvbnMpLnRoZW4oYXJndW1lbnRSZXNvbHZlcihkZm8ucmVzb2x2ZSksIGFyZ3VtZW50UmVzb2x2ZXIoZGZvLnJlamVjdCkpOwogICAgICAgICAgICAgICAgcmV0dXJuIGRmby5wcm9taXNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9wdGlvbnMgPSBleHRlbmQoewogICAgICAgICAgICB9LCB0aGF0LmRlZmF1bHRzLCBzZXR0aW5ncywgewogICAgICAgICAgICAgICAgYmVmb3JlU2VuZDogZXZlbnRGYWN0b3J5LmJlZm9yZVNlbmRNZXRob2QKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHR5cGUgPSBvcHRpb25zLnR5cGUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVzcG9uc2VRdWV1ZS5hZGRUb1F1ZXVlKHR5cGUsIHVybCwgb3B0aW9ucyk7CiAgICAgICAgfTsKICAgICAgICBEYXRhLmNvbmZpZyA9IGNvbmZpZzsKICAgICAgICByZXR1cm4gRGF0YTsKICAgIH0pKCk7CiAgICBleHBvcnRzLkRhdGEgPSBEYXRhOyAgICAKICAgIF8uZXh0ZW5kKERhdGEucHJvdG90eXBlLCBFdmVudHMpOwogICAgXy5leHRlbmQoRGF0YUZhY2FkZS5wcm90b3R5cGUsIERhdGEucHJvdG90eXBlKTsKICAgIC8vIFRha2UgYSBob2xkIG9mIGpRdWVyeS4uLiB0aGlzIGlzIHN1cmUgdG8gYmUgY29udHJhdmVzaWFsCiAgICBqUXVlcnkuYWpheCA9IChEYXRhKS5wcm90b3R5cGUuYWpheDsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9bWFpbi5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kYXRhJywgWyd0aHJ1c3QvZGF0YS9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCmRlZmluZSgndGhydXN0L2RvbS9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICcuL3N1YmpxdWVyeScsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QvbG9nJywgJ3RocnVzdC9mYWNhZGUnLCAnaGFzJywgJ3RocnVzdC9pbnN0YW5jZScsICcuL2NvbmZpZyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3N1YmpxdWVyeV9fLCBfX3V0aWxfXywgX19sb2dfXywgX19mYWNhZGVfXywgX19oYXNfXywgX19pbnN0YW5jZV9fLCBfX2NvbmZpZ19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL2RvbS9kb20uZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgc3VianF1ZXJ5ID0gX19zdWJqcXVlcnlfXzsKCiAgICB2YXIgdFF1ZXJ5ID0gc3VianF1ZXJ5LnRRdWVyeTsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgbG9nID0gX19sb2dfXzsKCiAgICB2YXIgZmFjYWRlID0gX19mYWNhZGVfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICB2YXIgaW5zdGFuY2UgPSBfX2luc3RhbmNlX187CgogICAgdmFyIGNvbmZpZyA9IF9fY29uZmlnX187CgogICAgZXhwb3J0cy5jbGFzc05hbWUgPSAnRG9tJzsKICAgIHZhciBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgZXh0ZW5kID0gXy5leHRlbmQsIGJpbmQgPSBfLmJpbmQsIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksIGlzT2JqZWN0ID0gXy5pc09iamVjdCwgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsIHdoZW4gPSB1dGlsLndoZW4sIGlzQXJyYXkgPSBfLmlzQXJyYXk7CiAgICAvLyNyZWdpb24gRG9tRmFjYWRlCiAgICB2YXIgRG9tRmFjYWRlID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZG9tRmFjYWRlID0gZmFjYWRlLmNyZWF0ZUZhY2FkZShmdW5jdGlvbiAobW9kLCBwYXJlbnQpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gcGFyZW50Lm5hbWU7CiAgICAgICAgICAgIHRoaXMuX19jb252ZW50aW9ucyA9IHBhcmVudC5fX2NvbnZlbnRpb25zOwogICAgICAgICAgICB0aGlzLmNvbnRleHQgPSB0UXVlcnkoZG9jdW1lbnQsIHVuZGVmaW5lZCwgdGhpcy5uYW1lKTsKICAgICAgICB9KTsKICAgICAgICBkb21GYWNhZGUucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbiAoZmFrZSkgewogICAgICAgICAgICB0aGlzLl9pbnRlcm5hbEV2ZW50cyA9IHRoaXMuX2ludGVybmFsRXZlbnRzIHx8IFtdOwogICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdEb21bezB9XTogSW5pdGFsaXppbmcgezF9RG9tIGZhY2FkZScsIHRoaXMubmFtZSwgZmFrZSA/ICdmYWtlICcgOiAnJykpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIGRvbUZhY2FkZS5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbiAobSkgewogICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdEb21bezB9XTogU3RhcnRpbmcgRG9tIGZhY2FkZScsIHRoaXMubmFtZSkpOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIGRvbUZhY2FkZS5wcm90b3R5cGUuc3RvcCA9IGZ1bmN0aW9uIChtKSB7CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RvbVt7MH1dOiBTdG9wcGluZyBEb20gZmFjYWRlJywgdGhpcy5uYW1lKSk7CiAgICAgICAgICAgIGZvcih2YXIgaSA9IHRoaXMuX2ludGVybmFsRXZlbnRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB2YXIgc3ViID0gdGhpcy5faW50ZXJuYWxFdmVudHNbaV07CiAgICAgICAgICAgICAgICB0aGlzLl9pbnRlcm5hbEV2ZW50cy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICBzdWIuY29udGV4dC5vZmYuYXBwbHkodGhpcywgKGlzQXJyYXkoc3ViKSkgPyBzdWIgOiAoaXNBcnJheShzdWIuYXJncykpID8gc3ViLmFyZ3MgOiBbXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBkb21GYWNhZGUucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAobSkgewogICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdEb21bezB9XTogRGVzdHJveWluZyBEb20gZmFjYWRlJywgdGhpcy5uYW1lKSk7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9pbnRlcm5hbEV2ZW50czsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gZG9tRmFjYWRlOwogICAgfSkoKTsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIERvbQogICAgdmFyIERvbSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8jZW5kcmVnaW9uCiAgICAgICAgZnVuY3Rpb24gRG9tKG5hbWUsIG1lZGlhdG9yKSB7CiAgICAgICAgICAgIGlmKCFuYW1lKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RvbTogbW9kdWxlIG5hbWUgbXVzdCBiZSBkZWZpbmVkLicpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5kZWJ1ZygnRGF0YTogQ3JlYXRpbmcgbmV3IERhdGEnKTsKICAgICAgICAgICAgdGhpcy5tZWRpYXRvciA9IG1lZGlhdG9yOwogICAgICAgICAgICB0aGlzLl9jYWxsYmFja3MgPSAobWVkaWF0b3IpLl9jYWxsYmFja3M7CiAgICAgICAgICAgIHRoaXMuaW5pdEV2ZW50cygpOwogICAgICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGluc3RhbmNlLmZldGNoSW5zdGFuY2UobmFtZSkucHJvbWlzZS50aGVuKGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgICAgIHZhciBtb2QgPSB7CiAgICAgICAgICAgICAgICB9LCBmYWNhZGUgPSB0aGF0LmNyZWF0ZUZhY2FkZSh0aHJ1c3QsIG1vZCwgewogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgRG9tLnByb3RvdHlwZS5pbml0RXZlbnRzID0gLy8jcmVnaW9uIEV2ZW50cwogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICB9OwogICAgICAgIERvbS5wcm90b3R5cGUuZXh0ZW5kID0gZnVuY3Rpb24gKHRvLCBpbml0KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgRG9tLnByb3RvdHlwZS5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCwgb25jZSkgewogICAgICAgIH07CiAgICAgICAgRG9tLnByb3RvdHlwZS51bnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgfTsKICAgICAgICBEb20ucHJvdG90eXBlLm9uY2UgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIH07CiAgICAgICAgRG9tLmNvbmZpZyA9IGNvbmZpZzsKICAgICAgICBEb20ucHJvdG90eXBlLmNyZWF0ZUZhY2FkZSA9IGZ1bmN0aW9uICh0aHJ1c3QsIG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICBpZihmYWNhZGVzLmRvbSAmJiAhKGZhY2FkZXMuZG9tIGluc3RhbmNlb2YgRG9tRmFjYWRlKSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCciZG9tIiBpcyBhIHJlc2VydmVkIHByb3BlcnR5Jyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRvbTsKICAgICAgICAgICAgaWYoZmFjYWRlcy5kb20pIHsKICAgICAgICAgICAgICAgIGZhY2FkZXMuZG9tLnVwZGF0ZUZhY2FkZShtb2QsIHRoaXMpOwogICAgICAgICAgICAgICAgZG9tID0gZmFjYWRlcy5kb207CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkb20gPSBmYWNhZGVzLmRvbSA9IG5ldyBEb21GYWNhZGUobW9kLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZG9tOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIERvbTsKICAgIH0pKCk7CiAgICBleHBvcnRzLkRvbSA9IERvbTsgICAgCiAgICAvLyNlbmRyZWdpb24KICAgIH0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPW1haW4uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZG9tJywgWyd0aHJ1c3QvZG9tL21haW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwoKZGVmaW5lKCd0aHJ1c3QvdGVtcGxhdGUvbWFpbicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L3V0aWwnLCAnZG9tUmVhZHknLCAndGhydXN0L2ZhY2FkZScsICcuL2NvbmZpZyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXywgX19kb21SZWFkeV9fLCBfX2ZhY2FkZV9fLCBfX2NvbmZpZ19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL2RhdGEvZGF0YS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy90ZW1wbGF0ZS90ZW1wbGF0ZS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICAKICAgIAogICAgdmFyIGRvbVJlYWR5ID0gX19kb21SZWFkeV9fOwoKICAgIHZhciBmYWNhZGUgPSBfX2ZhY2FkZV9fOwoKICAgIHZhciBjb25maWcgPSBfX2NvbmZpZ19fOwoKICAgIGV4cG9ydHMuY2xhc3NOYW1lID0gJ1RlbXBsYXRlJzsKICAgIGNvbmZpZzsKICAgIHZhciBMT05HID0gJ2xvbmcnLCBTSE9SVCA9ICdzaG9ydCcsIElEID0gJ2lkJywgZGVlcENvcHkgPSBfLm1lcmdlLCBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgZWFjaCA9IF8uZWFjaCwgYmluZCA9IF8uYmluZCwgd2hlbiA9IHV0aWwud2hlbiwgcmVkdWNlID0gXy5yZWR1Y2UsIG1lbW9pemUgPSBfLm1lbW9pemUsIG1hcCA9IF8ubWFwLCBleHRlbmQgPSBfLmV4dGVuZCwgZ2V0TG9uZ05hbWUgPSBmdW5jdGlvbiAobmFtZSwgdHlwZSkgewogICAgICAgIHZhciB0aGF0ID0gdGhpcywgcmVzdWx0ID0gKHRoYXQuc2hvcnROYW1lKG5hbWUpICsgJy4nICsgKHR5cGUgfHwgdGhhdC5jb25maWcuZGVmYXVsdFR5cGUpICsgdGhhdC5jb25maWcuZXh0ZW5zaW9uKS50b0xvd2VyQ2FzZSgpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9LCBnZXRTaG9ydE5hbWUgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHZhciB0aGF0ID0gdGhpcywgcmVzdWx0ID0gcmVkdWNlKHRoYXQudGVtcGxhdGVUeXBlcywgZnVuY3Rpb24gKG1lbW8sIHgpIHsKICAgICAgICAgICAgcmV0dXJuIG1lbW8ucmVwbGFjZSgnLicgKyB4LnRvTG93ZXJDYXNlKCkgKyB0aGF0LmNvbmZpZy5leHRlbnNpb24sICcnKTsKICAgICAgICB9LCBuYW1lLnRvTG93ZXJDYXNlKCkpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0sIGdldFRlbXBsYXRlSWQgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHZhciB0aGF0ID0gdGhpcywgcmVzdWx0ID0gdGhhdC5zaG9ydE5hbWUobmFtZSkucmVwbGFjZSgvXC8vZywgJy0nKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICAgIC8qKgogICAgQG1vZHVsZSB0aHJ1c3QudGVtcGxhdGUKICAgIEByZXF1aXJlcyB0aHJ1c3QuZGF0YQogICAgKiovCiAgICAvKioKICAgIFRoZSB0ZW1wbGF0ZSBwbHVnaW4gY29uc3R1cmN0b3IuCiAgICAKICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlCiAgICBAY2xhc3MgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlCiAgICBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSB0aHJ1c3QgY29uZmlnIG9iamVjdAogICAgQHBhcmFtIHtPYmplY3R9IGRhdGEgVGhlIHRocnVzdCBkYXRhIGluc3RhbmNlCiAgICBAdXNlcyB0aHJ1c3QuZGF0YS5EYXRhCiAgICBAY29uc3RydWN0b3IKICAgICoqLwogICAgdmFyIFRlbXBsYXRlID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBUZW1wbGF0ZShjb25maWcsIGRhdGEpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCB0ZW1wbGF0ZUNvbmZpZyA9IHRoaXMuY29uZmlnID0gY29uZmlnLnRlbXBsYXRlOwogICAgICAgICAgICB0aGF0LnRlbXBsYXRlVHlwZXMgPSBtYXAodGVtcGxhdGVDb25maWcudHlwZXMsIGZ1bmN0aW9uICh4LCBpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoYXQudGVtcGxhdGVzID0gewogICAgICAgICAgICAgICAgbG9uZzogewogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNob3J0OiB7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaWQ6IHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhhdC5sb25nTmFtZSA9IG1lbW9pemUoYmluZChnZXRMb25nTmFtZSwgdGhhdCkpOwogICAgICAgICAgICB0aGF0LnNob3J0TmFtZSA9IG1lbW9pemUoYmluZChnZXRTaG9ydE5hbWUsIHRoYXQpKTsKICAgICAgICAgICAgdGhhdC50ZW1wbGF0ZUlkID0gbWVtb2l6ZShiaW5kKGdldFRlbXBsYXRlSWQsIHRoYXQpKTsKICAgICAgICAgICAgdGhhdC5lbmdpbmVzID0gewogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGF0LmRhdGEgPSBkYXRhOwogICAgICAgICAgICByZXF1aXJlKFsKICAgICAgICAgICAgICAgICh0ZW1wbGF0ZUNvbmZpZy50ZW1wbGF0ZVBhdGhzW3RlbXBsYXRlQ29uZmlnLmRlZmF1bHRUeXBlXSB8fCAndGhydXN0L3RlbXBsYXRlLycgKyB0ZW1wbGF0ZUNvbmZpZy5kZWZhdWx0VHlwZSkKICAgICAgICAgICAgXSwgZnVuY3Rpb24gKGVuZ2luZSkgewogICAgICAgICAgICAgICAgdGhhdC5lbmdpbmVzW3RlbXBsYXRlQ29uZmlnLmRlZmF1bHRUeXBlXSA9IGVuZ2luZTsKICAgICAgICAgICAgICAgIGRvbVJlYWR5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAoXyhkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc2NyaXB0JykpKS5maWx0ZXIoZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICEheC5nZXRBdHRyaWJ1dGUoJ2RhdGEtdGVtcGxhdGUnKTsKICAgICAgICAgICAgICAgICAgICB9KS5lYWNoKGJpbmQodGhhdC5jcmVhdGVGcm9tRG9tTm9kZSwgdGhhdCkpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuZ2V0ID0gLyoqCiAgICAgICAgR2V0cyBhIHRlbXBsYXRlIGZyb20gdGhlIGNhY2hlIGlmIGl0IGhhcyBiZWVuIGZldGNoZWQuIEZhbHNlIG90aGVyd2lzZS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgICAgIEBtZXRob2QgZ2V0CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRlbXBsYXRlIG5hbWUgdG8gdHJ5IGFuZCBnZXQuCiAgICAgICAgQHJldHVybnMge0Z1bmN0aW9ufSBUaGUgdGVtcGxhdGUgb2JqZWN0CiAgICAgICAgKiovCiAgICAgICAgLyoqCiAgICAgICAgR2V0cyBhIHRlbXBsYXRlIGZyb20gdGhlIGNhY2hlIGlmIGl0IGhhcyBiZWVuIGZldGNoZWQuIEZhbHNlIG90aGVyd2lzZS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZUZhY2FkZQogICAgICAgIEBtZXRob2QgZ2V0CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRlbXBsYXRlIG5hbWUgdG8gdHJ5IGFuZCBnZXQuCiAgICAgICAgQHJldHVybnMge0Z1bmN0aW9ufSBUaGUgdGVtcGxhdGUgb2JqZWN0CiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gbnVsbCwgdGhhdCA9IHRoaXMsIHRlbXBsYXRlcyA9IHRoYXQudGVtcGxhdGVzOwogICAgICAgICAgICBpZih0ZW1wbGF0ZSA9IHRlbXBsYXRlcy5sb25nW3RoYXQubG9uZ05hbWUobmFtZSldKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7CiAgICAgICAgICAgIH0gZWxzZSBpZih0ZW1wbGF0ZSA9IHRlbXBsYXRlcy5zaG9ydFt0aGF0LnNob3J0TmFtZShuYW1lKV0pIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgICAgICAgICAgfSBlbHNlIGlmKHRlbXBsYXRlID0gdGVtcGxhdGVzLmlkW3RoYXQudGVtcGxhdGVJZChuYW1lKV0pIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIFRlbXBsYXRlLnByb3RvdHlwZS5zZXQgPSAvKioKICAgICAgICBTZXRzIGEgdGVtcGxhdGUgdG8gdGhlIGNhY2hlLCB3aXRoIHRoZSBnaXZlbiBpbmZvcm1hdGlvbgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlCiAgICAgICAgQG1ldGhvZCBzZXQKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdGVtcGxhdGUgbmFtZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSB0ZW1wbGF0ZSBlbmdpbmUgdHlwZQogICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNvbXBpbGVkVGVtcGxhdGUgVGhlIGNvbXBpbGVkIHRlbXBsYXRlIG1ldGhvZAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBodG1sIFRoZSB0ZW1wbGF0ZSBIVE1MLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lLCB0eXBlLCBjb21waWxlZFRlbXBsYXRlLCBodG1sKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgc2hvcnROYW1lID0gdGhhdC5zaG9ydE5hbWUobmFtZSksIHRlbXBsYXRlSWQgPSB0aGF0LnRlbXBsYXRlSWQobmFtZSksIGxvbmdOYW1lID0gdGhhdC5sb25nTmFtZShuYW1lLCB0eXBlKSwgdGVtcGxhdGVzID0gdGhhdC50ZW1wbGF0ZXM7CiAgICAgICAgICAgIHRlbXBsYXRlcy5sb25nW2xvbmdOYW1lXSA9IHRlbXBsYXRlcy5zaG9ydFtzaG9ydE5hbWVdID0gdGVtcGxhdGVzLmlkW3RlbXBsYXRlSWRdID0gewogICAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICAgIHNob3J0TmFtZTogbmFtZSwKICAgICAgICAgICAgICAgIGlkOiB0ZW1wbGF0ZUlkLAogICAgICAgICAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICAgICAgICAgIGh0bWw6IGh0bWwsCiAgICAgICAgICAgICAgICBjb21waWxlZDogY29tcGlsZWRUZW1wbGF0ZQogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICAgICAgVGVtcGxhdGUucHJvdG90eXBlLmhhcyA9IC8qKgogICAgICAgIENoZWNrcyBpZiB0aGUgdGVtcGxhdGUgZXhpc3RzIGluIHRoZSBjYWNoZS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgICAgIEBtZXRob2QgaGFzCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRlbXBsYXRlIG5hbWUKICAgICAgICBAcmV0dXJucyB7Qm9vbGVhbn0gV2V0aGVyIHRoZSB0ZW1wbGF0ZSBleGlzdHMgb3Igbm90LgogICAgICAgICoqLwogICAgICAgIC8qKgogICAgICAgIENoZWNrcyBpZiB0aGUgdGVtcGxhdGUgZXhpc3RzIGluIHRoZSBjYWNoZS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZUZhY2FkZQogICAgICAgIEBtZXRob2QgaGFzCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRlbXBsYXRlIG5hbWUKICAgICAgICBAcmV0dXJucyB7Qm9vbGVhbn0gV2V0aGVyIHRoZSB0ZW1wbGF0ZSBleGlzdHMgb3Igbm90LgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgcmV0dXJuICEhdGhhdC5nZXQobmFtZSk7CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUubmV3VGVtcGxhdGUgPSAvKioKICAgICAgICBDcmVhdGVzIGEgbmV3IHRlbXBsYXRlIGdpdmVuIHRoZSBpbmZvcm1hdGlvbgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlCiAgICAgICAgQG1ldGhvZCBuZXdUZW1wbGF0ZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHRlbXBsYXRlIGVuZ2luZSB0eXBlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGh0bWwgVGhlIHRlbXBsYXRlIEhUTUwuCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGVuZ2luZSBUaGUgdGVtcGxhdGUgZW5naW5lCiAgICAgICAgQHJldHVybnMge09iamVjdH0gVGhlIG5ldyB0ZW1wbGF0ZSBpbnN0YW5jZS4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobmFtZSwgdHlwZSwgaHRtbCwgZW5naW5lKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgdGVtcGxhdGUgPSB0aGF0LmdldChuYW1lKTsKICAgICAgICAgICAgaWYoIXRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgICBpZih0eXBlID09ICdwcmVjb21waWxlZCcpIHsKICAgICAgICAgICAgICAgICAgICB0aGF0LnNldChuYW1lLCB0eXBlLCBodG1sLCBodG1sLnRvU3RyaW5nKCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGluZ01ldGhvZDsKICAgICAgICAgICAgICAgICAgICB2YXIgY29tcGlsZWRUZW1wbGF0ZSA9IHRoaXMuY29tcGlsZShodG1sLCBlbmdpbmUpOwogICAgICAgICAgICAgICAgICAgIHRoYXQuc2V0KG5hbWUsIHR5cGUsIGNvbXBpbGVkVGVtcGxhdGUsIGh0bWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGF0LmdldChuYW1lKTsKICAgICAgICB9OwogICAgICAgIFRlbXBsYXRlLnByb3RvdHlwZS5jb21waWxlID0gLyoqCiAgICAgICAgQ29tcGlsZXMgYSB0ZW1wbGF0ZSBnaXZlbiB0aGUgaHRtbCBhbmQgdGhlIGVuZ2luZSB0eXBlLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlCiAgICAgICAgQG1ldGhvZCBjb21waWxlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGh0bWwgVGhlIGh0bWwgdG8gZ2VuZXJhdGUgdGhlIHRlbXBsYXRlIGZyb20KICAgICAgICBAcGFyYW0ge1N0cmluZ30gZW5naW5lIFRoZSB0ZW1wbGF0ZSBlbmdpbmUgdGhhdCBpcyBiZWluZyB1c2VkLgogICAgICAgIEByZXR1cm5zIHtGdW5jdGlvbn0gVGhlIGNvbXBpbGVkIHRlbXBsYXRlIG1ldGhvZAogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChodG1sLCBlbmdpbmUpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCB0ZW1wbGF0aW5nTWV0aG9kOwogICAgICAgICAgICBpZighZW5naW5lKSB7CiAgICAgICAgICAgICAgICBlbmdpbmUgPSB0aGF0LmVuZ2luZXNbdGhhdC5jb25maWcuZGVmYXVsdFR5cGVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHR5cGVvZiBlbmdpbmUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIHRlbXBsYXRpbmdNZXRob2QgPSBlbmdpbmU7CiAgICAgICAgICAgIH0gZWxzZSBpZih0eXBlb2YgZW5naW5lLnRlbXBsYXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB0ZW1wbGF0aW5nTWV0aG9kID0gZW5naW5lLnRlbXBsYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0aW5nTWV0aG9kKGh0bWwpOwogICAgICAgIH07CiAgICAgICAgVGVtcGxhdGUucHJvdG90eXBlLmZldGNoID0gLyoqCiAgICAgICAgRmV0Y2hzIGEgdGVtcGxhdGUgZnJvbSB0aGUgc2VydmVyLCBvciB0ZW1wbGF0ZSBzdG9yZS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgICAgIEBtZXRob2QgZmV0Y2gKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdGVtcGxhdGUgbmFtZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBbdHlwZV0gVGhlIHRlbXBsYXRlIHR5cGUgaWYgbm90IHRoZSBkZWZhdWx0CiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGZvciB3aGVuIHRoZSB0ZW1wbGF0ZSBoYXMgYmVlbiBsb2FkZWQuCiAgICAgICAgKiovCiAgICAgICAgLyoqCiAgICAgICAgRmV0Y2hzIGEgdGVtcGxhdGUgZnJvbSB0aGUgc2VydmVyLCBvciB0ZW1wbGF0ZSBzdG9yZS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZUZhY2FkZQogICAgICAgIEBtZXRob2QgZmV0Y2gKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdGVtcGxhdGUgbmFtZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBbdHlwZV0gVGhlIHRlbXBsYXRlIHR5cGUgaWYgbm90IHRoZSBkZWZhdWx0CiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGZvciB3aGVuIHRoZSB0ZW1wbGF0ZSBoYXMgYmVlbiBsb2FkZWQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG5hbWUsIHR5cGUpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCB0eXBlID0gdHlwZSB8fCB0aGF0LmNvbmZpZy5kZWZhdWx0VHlwZSwgc2hvcnROYW1lID0gdGhhdC5zaG9ydE5hbWUobmFtZSksIGxvbmdOYW1lID0gdGhhdC5sb25nTmFtZShuYW1lLCB0eXBlKSwgdGVtcGxhdGU7CiAgICAgICAgICAgIHZhciBkZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgaWYodGVtcGxhdGUgPSB0aGF0LmdldChuYW1lKSkgewogICAgICAgICAgICAgICAgZGVmZXIucmVzb2x2ZSh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gZGVmZXIucHJvbWlzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGF0LmRhdGEuZ2V0KHRoYXQuY29uZmlnLmJhc2VVcmwgKyBsb25nTmFtZSwgewogICAgICAgICAgICAgICAgY29udGVudFR5cGU6ICd0ZXh0L3BsYWluJywKICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAndGV4dCcsCiAgICAgICAgICAgICAgICBzaWxlbnQ6IHRydWUKICAgICAgICAgICAgfSkudGhlbih3aGVuLmFwcGx5KGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICBpZih0eXBlID09ICdwcmVjb21waWxlZCcpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSB0aGF0Lm5ld1RlbXBsYXRlKG5hbWUsIHR5cGUsIGRhdGEpOwogICAgICAgICAgICAgICAgICAgIGRlZmVyLnJlc29sdmUodGVtcGxhdGUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZih0aGF0LmVuZ2luZXNbdHlwZV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gdGhhdC5uZXdUZW1wbGF0ZShuYW1lLCB0eXBlLCBkYXRhLCB0aGF0LmVuZ2luZXNbdHlwZV0pOwogICAgICAgICAgICAgICAgICAgICAgICBkZWZlci5yZXNvbHZlKHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZXF1aXJlKFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0aGF0LmNvbmZpZy50ZW1wbGF0ZVBhdGhzW3R5cGVdIHx8ICd0aHJ1c3QvdGVtcGxhdGUvJyArIHR5cGUpCiAgICAgICAgICAgICAgICAgICAgICAgIF0sIGZ1bmN0aW9uIChlbmdpbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuZW5naW5lc1t0eXBlXSA9IGVuZ2luZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoYXQubmV3VGVtcGxhdGUobmFtZSwgdHlwZSwgZGF0YSwgZW5naW5lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVyLnJlc29sdmUodGVtcGxhdGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pLCBkZWZlci5yZWplY3QpOwogICAgICAgICAgICByZXR1cm4gZGVmZXIucHJvbWlzZTsKICAgICAgICB9OwogICAgICAgIFRlbXBsYXRlLnByb3RvdHlwZS5jcmVhdGVGcm9tRG9tTm9kZSA9IC8qKgogICAgICAgIENyZWF0ZXMgYSBuZXcgdGVtcGxhdGUgZnJvbSB0aGUgZ2l2ZW4gRE9NIE5vZGUKICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgICAgIEBtZXRob2QgY3JlYXRlRnJvbURvbU5vZGUKICAgICAgICBAcHJvdGVjdGVkCiAgICAgICAgQHBhcmFtIHtOb2RlfSBlbGVtZW50IFRIZSBkb21lIGVsZW1lbnQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB0aGF0Lm5ld1RlbXBsYXRlKGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdkYXRhLXRlbXBsYXRlJyksIGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdkYXRhLXR5cGUnKSwgZWxlbWVudC50ZXh0KTsKICAgICAgICB9OwogICAgICAgIFRlbXBsYXRlLnByb3RvdHlwZS5jcmVhdGVGYWNhZGUgPSAvKioKICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgICAgIEBtZXRob2QgY3JlYXRlRmFjYWRlCiAgICAgICAgQHBhcmFtIHt0aHJ1c3QuVGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZQogICAgICAgIEBwYXJhbSB7dGhydXN0Lk1vZHVsZX0gbW9kdWxlIFRoZSBtb2R1bGUgdG8gY3JlYXRlIHRoZSBmYWNhZGUgZm9yCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgVGhlIGZhY2FkZXMgYWxyZWFkeSBhZGRlZCBmb3IgdGhpcyBtb2R1bGUuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCwgbW9kLCBmYWNhZGVzKSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZUluc3RhbmNlID0gdGhydXN0LnRlbXBsYXRlOwogICAgICAgICAgICB2YXIgZmFjYWRlID0gZmFjYWRlcy50ZW1wbGF0ZSA9IG5ldyBUZW1wbGF0ZUZhY2FkZShtb2QsIHRoaXMpOwogICAgICAgICAgICBtb2QudGVtcGxhdGVzID0gewogICAgICAgICAgICAgICAgZmV0Y2g6IGJpbmQodGVtcGxhdGVJbnN0YW5jZS5mZXRjaCwgdGVtcGxhdGVJbnN0YW5jZSksCiAgICAgICAgICAgICAgICBnZXQ6IGJpbmQodGVtcGxhdGVJbnN0YW5jZS5nZXQsIHRlbXBsYXRlSW5zdGFuY2UpLAogICAgICAgICAgICAgICAgaGFzOiBiaW5kKHRlbXBsYXRlSW5zdGFuY2UuaGFzLCB0ZW1wbGF0ZUluc3RhbmNlKQogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gZmFjYWRlOwogICAgICAgIH07CiAgICAgICAgVGVtcGxhdGUuY29uZmlnID0gY29uZmlnOwogICAgICAgIHJldHVybiBUZW1wbGF0ZTsKICAgIH0pKCk7CiAgICBleHBvcnRzLlRlbXBsYXRlID0gVGVtcGxhdGU7ICAgIAogICAgLyoqCiAgICAKICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlCiAgICBAY2xhc3MgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlRmFjYWRlCiAgICBAY29uc3RydWN0b3IKICAgIEBwYXJhbSB7dGhydXN0Lk1vZHVsZX0gbW9kdWxlIFRoZSBtb2R1bGUgdG8gY3JlYXRlIHRoZSBmYWNhZGUgZm9yCiAgICBAcGFyYW0ge3RocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZX0gcGFyZW50IFRoZSB0ZW1wbGF0ZSBpbnN0YW5jZSB0byBjcmVhdGUgdGhlIGZhY2FkZSBmb3IuCiAgICAqKi8KICAgIHZhciBUZW1wbGF0ZUZhY2FkZSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHRlbXBsYXRlRmFjYWRlID0gZmFjYWRlLmNyZWF0ZUZhY2FkZShmdW5jdGlvbiAobW9kdWxlLCBwYXJlbnQpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gbW9kdWxlLm5hbWUgKyAnLXRlbXBsYXRlJzsKICAgICAgICAgICAgdGhpcy5tb2R1bGUgPSBtb2R1bGU7CiAgICAgICAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgICAgICAgICB0aGlzLl9fY29udmVudGlvbnMgPSBwYXJlbnQuX19jb252ZW50aW9uczsKICAgICAgICAgICAgZXh0ZW5kKHRoaXMsIHsKICAgICAgICAgICAgICAgIGZldGNoOiBiaW5kKHBhcmVudC5mZXRjaCwgcGFyZW50KSwKICAgICAgICAgICAgICAgIGdldDogYmluZChwYXJlbnQuZ2V0LCBwYXJlbnQpLAogICAgICAgICAgICAgICAgaGFzOiBiaW5kKHBhcmVudC5oYXMsIHBhcmVudCkKICAgICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHRlbXBsYXRlRmFjYWRlOwogICAgfSkoKTsKICAgIC8qKgogICAgQU1EIEFQSQogICAgbG9hZAogICAgCiAgICBIYW5kbGVzIGZldGNoaW5nIG9mIGEgdGhydXN0L3RlbXBsYXRlIGJ5IHBhdGguCiAgICBSZXF1aXJlcyB0aGUgaW5zdGFuY2UsIHRoYXQgdGhlIHRlbXBsYXRlIGlzIGV4cGVjdGVkIHRvIGNvbWUgZnJvbS4KICAgIHRocnVzdEluc3RhbmNlWzplbmdpbmVOYW1lXTp0ZW1wbGF0ZVBhdGgKICAgIAogICAgUHJlZml4IHdpdGggPGVuZ2luZU5hbWU+OiB0byBzZWxlY3QgYSBzcGVjaWZpYyB0ZW1wbGF0ZSBlbmdpbmUuCiAgICB0aHJ1c3QvdGVtcGxhdGUhZ2xvYmFsOnRlbXBsYXRlcy9teVRlbXBsYXRlLnRtcGwgPSBTcGVjaWZpYyB0ZW1wbGF0ZQogICAgdGhydXN0L3RlbXBsYXRlIWluc3RhbmNlMjp0ZW1wbGF0ZXMvbXlUZW1wbGF0ZSA9IFVzZXMgZGVmYXVsdCBleHRlbnNpb24gZnJvbSBjb25maWcKICAgIHRocnVzdC90ZW1wbGF0ZSFpbnN0YW5jZTI6a2VuZG86dGVtcGxhdGVzL215VGVtcGxhdGUudG1wbCA9IFVzZXMgdGhlIGtlbmRvIHRlbXBsYXRlIGVuZ2luZS4KICAgIHRocnVzdC90ZW1wbGF0ZSFpbnN0YW5jZTM6a2VuZG86dGVtcGxhdGVzL215VGVtcGxhdGUudG1wbCA9IFVzZXMgdGhlIGtlbmRvIHRlbXBsYXRlIGVuZ2luZSB3aXRoIHRoZSBkZWZhdWx0IGV4dGVuc2lvbgogICAgCiAgICAKICAgIEBtZXRob2QgbG9hZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHRlbXBsYXRlIHRoYXQgaXMgYmVpbmcgZmV0Y2hlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gcGFyZW50UmVxdWlyZSB0aGUgcmVxdWlyZSBtZXRob2QgdG8gYmUgbG9hZGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBsb2FkIEFsbG93cyB0aGUgbG9hZCB0byBpbmZvcm0gdGhhdCBBTUQgZm9yIHRoZSB2YWx1ZSB0byBoYW5kIG9mZgogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgY3VzdG9tIGNvbmZpZ3VyYXRpb24uCiAgICAqKi8KICAgIC8vIE5vdCBjb21wbGV0ZWQgeWV0CiAgICAvLyBTaG91bGQgYmVoYXZlIHNpbWlsYXJseSB0byB0ZXh0IQogICAgLy9leHBvcnQgZnVuY3Rpb24gbG9hZChuYW1lOiBzdHJpbmcsIHBhcmVudFJlcXVpcmUsIGxvYWQsIGNvbmZpZykKICAgIC8vewogICAgLy8gICAgdmFyIHRlbXBsYXRlUGF0aCA9IG5hbWUsCiAgICAvLyAgICAgICAgdGVtcGxhdGVFbmdpbmUsCiAgICAvLyAgICAgICAgY29sb24gPSB0ZW1wbGF0ZVBhdGguaW5kZXhPZignOicpOwogICAgLy8JdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgnOicpLAogICAgLy8gICAgICAgIGluc3RhbmNlTmFtZSA9IHBhcnRzWzBdLAogICAgLy8JCXRlbXBsYXRlRW5naW5lID0gcGFydHNbMV0sCiAgICAvLwkJdGVtcGxhdGVQYXRoID0gcGFydHNbMl0gfHwgdGVtcGxhdGVFbmdpbmU7CiAgICAvLyAgICBpZiAocGFydHMubGVuZ3RoID09PSAyKQogICAgLy8gICAgICAgIHRlbXBsYXRlRW5naW5lID0gbnVsbDsKICAgIC8vCS8vdmFyIGluc3RhbmNlUHJvbWlzZSA9IFRocnVzdC5fX2ZldGNoSW5zdGFuY2UocmVhbE5hbWUpOwogICAgLy8gICAgLy8gR2V0IHRoZSBkYXRhIHBsdWdpbi4KICAgIC8vICAgIHBhcmVudFJlcXVpcmUoWyd0aHJ1c3QhZGF0YTonICsgaW5zdGFuY2VOYW1lXSwgKGRhdGFQbHVnaW4pID0+CiAgICAvLyAgICB7CiAgICAvLyAgICAgICAgdmFyIGRhdGFQbHVnaW4gPSBkYXRhUGx1Z2luCiAgICAvLyAgICB9KTsKICAgIC8vfQogICAgfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9bWFpbi5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC90ZW1wbGF0ZScsIFsndGhydXN0L3RlbXBsYXRlL21haW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwoKZGVmaW5lKCd0aHJ1c3Qvc3BhL21haW4nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC91dGlsJywgJ3RocnVzdCcsICd0aHJ1c3QvbG9nJywgJ2hhcycsICdmbGF0aXJvbi9kaXJlY3RvcicsICd0aHJ1c3QvaW5zdGFuY2UnLCAnLi9jb25maWcnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX191dGlsX18sIF9fdGhydXN0X18sIF9fbG9nX18sIF9faGFzX18sIF9fZmxhdGlyb25Sb3V0ZXJfXywgX19pbnN0YW5jZV9fLCBfX2NvbmZpZ19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL3NwYS9zcGEuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIHRocnVzdCA9IF9fdGhydXN0X187CgogICAgdmFyIFRocnVzdCA9IHRocnVzdC5UaHJ1c3Q7CiAgICB2YXIgbG9nID0gX19sb2dfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICB2YXIgZmxhdGlyb25Sb3V0ZXIgPSBfX2ZsYXRpcm9uUm91dGVyX187CgogICAgdmFyIFJvdXRlciA9IGZsYXRpcm9uUm91dGVyLlJvdXRlciB8fCBmbGF0aXJvblJvdXRlcjsKICAgIAogICAgdmFyIGluc3RhbmNlID0gX19pbnN0YW5jZV9fOwoKICAgIHZhciBjb25maWcgPSBfX2NvbmZpZ19fOwoKICAgIGV4cG9ydHMuY2xhc3NOYW1lID0gJ1NpbmdsZVBhZ2VBcHBsaWNhdGlvbic7CiAgICBjb25maWc7CiAgICB2YXIgZWFjaCA9IF8uZWFjaCwgaXNTdHJpbmcgPSBfLmlzU3RyaW5nLCBpc0FycmF5ID0gXy5pc0FycmF5LCBpc0Z1bmN0aW9uID0gXy5pc0Z1bmN0aW9uLCBpc09iamVjdCA9IF8uaXNPYmplY3QsIGlzUmVnRXhwID0gXy5pc1JlZ0V4cCwgZXh0ZW5kID0gXy5leHRlbmQsIG9uY2UgPSBfLm9uY2UsIHdoZW4gPSB1dGlsLndoZW4sIGJpbmQgPSBfLmJpbmQsIGludm9rZSA9IF8uaW52b2tlLCBwbHVjayA9IF8ucGx1Y2ssIG1hcCA9IF8ubWFwLCBkZWZlciA9IF8uZGVmZXIsIHJlZHVjZSA9IF8ucmVkdWNlLCBtZW1vaXplID0gXy5tZW1vaXplLCB0b0FycmF5ID0gXy50b0FycmF5LCBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgU1RBUlQgPSAnc3RhcnQnOwogICAgdmFyIGV4dHJhY3RQYXJhbXMgPSBmdW5jdGlvbiAocm91dGUpIHsKICAgICAgICB2YXIgcGFyYW1zID0gW10sIGluZGV4ID0gcm91dGUuaW5kZXhPZignOicpLCBzbGFzaEluZGV4OwogICAgICAgIHdoaWxlKGluZGV4ID4gLTEpIHsKICAgICAgICAgICAgc2xhc2hJbmRleCA9IHJvdXRlLmluZGV4T2YoJy8nLCBpbmRleCk7CiAgICAgICAgICAgIGlmKHNsYXNoSW5kZXggPT09IC0xKSB7CiAgICAgICAgICAgICAgICBzbGFzaEluZGV4ID0gcm91dGUubGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBhcmFtcy5wdXNoKHJvdXRlLnN1YnN0cmluZyhpbmRleCwgc2xhc2hJbmRleCAtIGluZGV4ICsgMSkpOwogICAgICAgICAgICByb3V0ZSA9IHJvdXRlLnN1YnN0cmluZyhzbGFzaEluZGV4KTsKICAgICAgICAgICAgaW5kZXggPSByb3V0ZS5pbmRleE9mKCc6Jyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwYXJhbXM7CiAgICB9OwogICAgdmFyIGV2ZW50RmFjdG9yeSA9IGZ1bmN0aW9uIChldmVudCwgbWVkaWF0b3IpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdGaXJpbmcgc3BhICJ7MH0iIHdpdGggW3sxfV0nLCBldmVudCwgdG9BcnJheShhcmd1bWVudHMpLmpvaW4oJywnKSkpOwogICAgICAgICAgICBtZWRpYXRvci5maXJlLmFzeW5jLmFwcGx5KG1lZGlhdG9yLCBbCiAgICAgICAgICAgICAgICBldmVudAogICAgICAgICAgICBdLmNvbmNhdCh0b0FycmF5KGFyZ3VtZW50cykpKTsKICAgICAgICB9OwogICAgfTsKICAgIC8qKgogICAgCiAgICBAZm9yIHRocnVzdC5zcGEKICAgIEBjbGFzcyB0aHJ1c3Quc3BhLlNpbmdsZVBhZ2VBcHAKICAgIEBjb25zdHJ1Y3RvcgogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgdGhydXN0IGluc3RhbmNlIGNvbmZpZ3VyYXRpb24KICAgIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZU5hbWUgVGhlIHRocnVzdCBpbnN0YW5jZSBuYW1lCiAgICBAcGFyYW0ge3RocnVzdC5tZWRpYXRvck1lZGlhdG9yfSBtZWRpYXRvciBUaGUgdGhydXN0IGluc3RhbmNlIG1lZGlhdG9yCiAgICAqKi8KICAgIHZhciBTaW5nbGVQYWdlQXBwbGljYXRpb24gPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFNpbmdsZVBhZ2VBcHBsaWNhdGlvbihjb25maWcsIGluc3RhbmNlTmFtZSwgbWVkaWF0b3IpIHsKICAgICAgICAgICAgdGhpcy5zdGFydGluZ01vZHVsZVByb21pc2UgPSBudWxsOwogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHRoYXQuYmFzZVVybCA9IGNvbmZpZy51cmwucGF0aDsKICAgICAgICAgICAgdmFyIHNwYUNvbmZpZyA9IGNvbmZpZy5zcGE7CiAgICAgICAgICAgIHRoYXQuZmlsZUV4dGVuc2lvbiA9IHNwYUNvbmZpZy5maWxlRXh0ZW5zaW9uOwogICAgICAgICAgICB2YXIgcm91dGVzID0gdGhhdC5jb25maWd1cmVSb3V0ZXMoc3BhQ29uZmlnLnJvdXRlcyksIHBhcmFtcyA9IHNwYUNvbmZpZy5wYXJhbXM7CiAgICAgICAgICAgIHZhciBldmVudEZhY3RvcnkgPSBtZW1vaXplKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdGaXJpbmcgc3BhICJ7MH0iIHdpdGggW3sxfV0nLCBldmVudCwgdG9BcnJheShhcmd1bWVudHMpLmpvaW4oJywnKSkpOwogICAgICAgICAgICAgICAgICAgIG1lZGlhdG9yLmZpcmUuYXN5bmMuYXBwbHkobWVkaWF0b3IsIFsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQKICAgICAgICAgICAgICAgICAgICBdLmNvbmNhdCh0b0FycmF5KGFyZ3VtZW50cykpKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB2YXIgcm91dGVyID0gdGhhdC5yb3V0ZXIgPSBuZXcgUm91dGVyKHJvdXRlcykuY29uZmlndXJlKHsKICAgICAgICAgICAgICAgIHJlY3Vyc2U6IGZhbHNlLAogICAgICAgICAgICAgICAgc3RyaWN0OiBmYWxzZSwKICAgICAgICAgICAgICAgIGFzeW5jOiBmYWxzZSwKICAgICAgICAgICAgICAgIGh0bWw1aGlzdG9yeTogdHJ1ZSwKICAgICAgICAgICAgICAgIG5vdGZvdW5kOiBldmVudEZhY3RvcnkoJ3RocnVzdC9zcGEvcm91dGUvbm90Zm91bmQnKSwKICAgICAgICAgICAgICAgIGJlZm9yZTogZXZlbnRGYWN0b3J5KCd0aHJ1c3Qvc3BhL3JvdXRlL2JlZm9yZScpLAogICAgICAgICAgICAgICAgb246IGV2ZW50RmFjdG9yeSgndGhydXN0L3NwYS9yb3V0ZS9ydW4nKSwKICAgICAgICAgICAgICAgIGFmdGVyOiBldmVudEZhY3RvcnkoJ3RocnVzdC9zcGEvcm91dGUvYWZ0ZXInKQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgXy5lYWNoKHBhcmFtcywgZnVuY3Rpb24gKHgsIGkpIHsKICAgICAgICAgICAgICAgIHJvdXRlci5wYXJhbShpLCB4KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICBTdGFydCB0aGUgc2luZ2xlIHBhZ2UgYXBwIHJvdXRlci4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2Qgc3RhcnQKICAgICAgICAgICAgKiovCiAgICAgICAgICAgIHRoYXQuc3RhcnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGF0LnRocnVzdCA9IGluc3RhbmNlLmdldEluc3RhbmNlKGluc3RhbmNlTmFtZSk7CiAgICAgICAgICAgICAgICB0aGF0LnJvdXRlci5pbml0KCk7CiAgICAgICAgICAgICAgICBtZWRpYXRvci5maXJlLmFzeW5jKCd0aHJ1c3Qvc3BhL3N0YXJ0Jyk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoYXQubmF2aWdhdGUgPSB0aGF0Lm5hdmlnYXRlLmJpbmQodGhhdCk7CiAgICAgICAgfQogICAgICAgIFNpbmdsZVBhZ2VBcHBsaWNhdGlvbi5wcm90b3R5cGUubmF2aWdhdGUgPSAvKioKICAgICAgICBOYXZpZ2F0ZXMgdG8gdGhlIGdpdmVuIHVybC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIG5hdmlnYXRlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGxvY2F0aW9uIFRoZSBsb2NhdGlvbiB0byBuYXZpZ2F0ZSB0by4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobG9jYXRpb24pIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgdXJsID0gdXRpbC5maXh1cFVybChsb2NhdGlvbiwgdGhhdC5iYXNlVXJsKTsKICAgICAgICAgICAgdGhhdC5yb3V0ZXIuc2V0Um91dGUodXJsKTsKICAgICAgICB9OwogICAgICAgIFNpbmdsZVBhZ2VBcHBsaWNhdGlvbi5wcm90b3R5cGUuc3RhcnQgPSAvKioKICAgICAgICBTdGFydCB0aGUgc2luZ2xlIHBhZ2UgYXBwIHJvdXRlci4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHN0YXJ0CiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLnRocnVzdCA9IGluc3RhbmNlLmdldEluc3RhbmNlKHRoaXMuaW5zdGFuY2VOYW1lKTsKICAgICAgICAgICAgdGhpcy5yb3V0ZXIuaW5pdCgpOwogICAgICAgICAgICB0aGlzLnRocnVzdC5tZWRpYXRvci5maXJlLmFzeW5jKCd0aHJ1c3Qvc3BhL3N0YXJ0Jyk7CiAgICAgICAgfTsKICAgICAgICBTaW5nbGVQYWdlQXBwbGljYXRpb24ucHJvdG90eXBlLmNvbmZpZ3VyZVJvdXRlcyA9IC8qKgogICAgICAgIENvbmZpZ3VyZXMgdGhlIHJvdXRlIG9iamVjdCBmb3IgdGhlIHNwYSBpbnN0YW5jZQogICAgICAgIAogICAgICAgIFJvdXRlcyBjYW4gYmUgaW4gNCBmb3JtcwogICAgICAgIAogICAgICAgIHsKICAgICAgICAnL3BhdGgvdG8vOmZvbyc6ICdwYXRoL3RvL21vZHVsZScsCiAgICAgICAgJy9wYXRoL3RvLzpiYXInOiBbJ3BhdGgvdG8vbW9kdWxlMScsICdwYXRoL3RvL21vZHVsZTInXSwKICAgICAgICAnL3BhdGgvdG8vOmZiJzogeyBwYXRoOiAncGF0aC90by9tb2R1bGUnLCBhcmdzOiBbJ2FyZ3MnLCAndG8nLCAnaGFuZCBvZmYgdG8gc3RhcnQnXSB9CiAgICAgICAgJy9wYXRoL3RvLzpmb28vOmJhcic6IGZ1bmN0aW9uKGZvbywgYmFyKXsgIGN1c3RvbSBoYW5kbGVyIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBjb25maWd1cmVSb3V0ZXMKICAgICAgICBAcGFyYW0ge09iamVjdH0gcm91dGVzIE9iamVjdCBvZiByb3V0ZXMuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHJvdXRlcykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGNvbmZpZ3VyZWRSb3V0ZXMgPSB7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIC8vIGVhY2gocm91dGVzLCBmdW5jdGlvbiAodmFsdWUsIHJvdXRlKSB7CiAgICAgICAgICAgIGZvcih2YXIgcm91dGUgaW4gcm91dGVzKSB7CiAgICAgICAgICAgICAgICBpZihfLmhhcyhyb3V0ZXMsIHJvdXRlKSkgewogICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IHJvdXRlc1tyb3V0ZV07CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlYWxSb3V0ZSA9IHV0aWwuZml4dXBVcmwocm91dGUsIHRoYXQuYmFzZVVybCk7CiAgICAgICAgICAgICAgICAgICAgaWYoaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJlZFJvdXRlc1tyZWFsUm91dGVdID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtb2R1bGVzID0gW10sIG1ldGhvZHMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IHZhbHVlLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHYgPSB2YWx1ZVt2XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlzU3RyaW5nKHYpIHx8IGlzT2JqZWN0KHYpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxlcy5wdXNoKHYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGlzRnVuY3Rpb24odikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRob2RzLnB1c2godik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vZHVsZUNhbGxiYWNrID0gdGhhdC5tb2R1bGVTdGFydENhbGxiYWNrKHJvdXRlLCBtb2R1bGVzKTsKICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kcy5wdXNoKG1vZHVsZUNhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJlZFJvdXRlc1tyZWFsUm91dGVdID0gbWV0aG9kczsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoaXNTdHJpbmcodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtb2R1bGVDYWxsYmFjayA9IHRoYXQubW9kdWxlU3RhcnRDYWxsYmFjayhyb3V0ZSwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25maWd1cmVkUm91dGVzW3JlYWxSb3V0ZV0gPSBtb2R1bGVDYWxsYmFjazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy99KTsKICAgICAgICAgICAgcmV0dXJuIGNvbmZpZ3VyZWRSb3V0ZXM7CiAgICAgICAgfTsKICAgICAgICBTaW5nbGVQYWdlQXBwbGljYXRpb24ucHJvdG90eXBlLm1vZHVsZVN0YXJ0Q2FsbGJhY2sgPSAvKioKICAgICAgICAKICAgICAgICBAbWV0aG9kIG1vZHVsZVN0YXJ0Q2FsbGJhY2sKICAgICAgICBAcHJpdmF0ZQogICAgICAgIEBwYXJhbSB7U3RyaW5nIHwgQXJyYXkgfCBPYmplY3R9IG1vZHVsZXMgU3RyaW5nIHRvIHN0YXJ0IGEgc2luZ2xlIG1vZHVsZSwgQXJyYXkgdG8gc3RhcnQgbWFueSBtb2R1bGVzLCBPYmplY3QgdG8gc3RhcnQgYSBtb2R1bGUgd2l0aCBzcGVjaWZpYyBhcmd1bWVudHMuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHJvdXRlLCBtb2R1bGVzKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW10sIHBhcmFtcyA9IGV4dHJhY3RQYXJhbXMocm91dGUpLCB0aGF0ID0gdGhpcywgZmlsZUV4dGVuc2lvbiA9IHRoYXQuZmlsZUV4dGVuc2lvbjsKICAgICAgICAgICAgaWYoaXNPYmplY3QobW9kdWxlcykpIHsKICAgICAgICAgICAgICAgIGFyZ3MgPSBtb2R1bGVzLmFyZ3MgfHwgYXJnczsKICAgICAgICAgICAgICAgIG1vZHVsZXMgPSBtb2R1bGVzLnBhdGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoaXNTdHJpbmcobW9kdWxlcykpIHsKICAgICAgICAgICAgICAgIG1vZHVsZXMgPSBbCiAgICAgICAgICAgICAgICAgICAgbW9kdWxlcwogICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGFyID0gdG9BcnJheShhcmd1bWVudHMpLCB0aHJ1c3QgPSB0aGF0LnRocnVzdCwgbWFwcGVkTW9kdWxlcyA9IG1hcChtb2R1bGVzLCBmdW5jdGlvbiAobW9kdWxlUGF0aCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiByZWR1Y2UoYXIsIGZ1bmN0aW9uIChtZW1vLCBhcmcsIGkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1lbW8ucmVwbGFjZShwYXJhbXNbaV0sIGFyZy50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgICAgICB9LCBtb2R1bGVQYXRoKS5yZXBsYWNlKGZpbGVFeHRlbnNpb24sICcnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdmFyIHByb21pc2UgPSB0aHJ1c3Quc3RhcnQuYXBwbHkodGhydXN0LCBbCiAgICAgICAgICAgICAgICAgICAgbWFwcGVkTW9kdWxlcwogICAgICAgICAgICAgICAgXS5jb25jYXQoYXJncykpOwogICAgICAgICAgICAgICAgaWYoIXRoYXQudGhydXN0LnN0YXJ0ZWQpIHsKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJ1c3QucmVhZHkobWFwcGVkTW9kdWxlcywgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGF0LnN0YXJ0aW5nTW9kdWxlUHJvbWlzZSA9IHByb21pc2U7CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICBTaW5nbGVQYWdlQXBwbGljYXRpb24ucHJvdG90eXBlLmNyZWF0ZUZhY2FkZSA9IC8qKgogICAgICAgIEhhbmRzIHRoZSBuYXZpZ2F0ZSBtZXRob2Qgb2ZmIHRvIHRoZSBtb2R1bGUsIHNvIGFueSBtb2R1bGUgY2FuIHRyaWdnZXIgYSBuYXZpZ2F0aW9uIGV2ZW50LgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnNwYS5TaW5nbGVQYWdlQXBwCiAgICAgICAgQG1ldGhvZCBjcmVhdGVGYWNhZGUKICAgICAgICBAcGFyYW0ge3RocnVzdC5UaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlCiAgICAgICAgQHBhcmFtIHt0aHJ1c3QuTW9kdWxlfSBtb2QgVGhlIG1vZHVsZSB0byBjcmVhdGUgdGhlIGZhY2FkZSBmb3IKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgZmFjYWRlcyBhbHJlYWR5IGFkZGVkIGZvciB0aGlzIG1vZHVsZS4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0LCBtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZihtb2QubmF2aWdhdGUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignIm5hdmlnYXRlIiBpcyBhIHJlc2VydmVkIHByb3BlcnR5Jyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gQWxyZWFkeSBwcmUgYm91bmQsIHNvIHdlIG9ubHkgcGFzcyBhcm91bmQgMSBmdW5jdGlvbiBwZXIgaW5zdGFuY2UuCiAgICAgICAgICAgIG1vZC5uYXZpZ2F0ZSA9IHRoYXQubmF2aWdhdGUuYmluZCh0aGF0KTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBTaW5nbGVQYWdlQXBwbGljYXRpb24uY29uZmlnID0gY29uZmlnOwogICAgICAgIHJldHVybiBTaW5nbGVQYWdlQXBwbGljYXRpb247CiAgICB9KSgpOwogICAgZXhwb3J0cy5TaW5nbGVQYWdlQXBwbGljYXRpb24gPSBTaW5nbGVQYWdlQXBwbGljYXRpb247ICAgIAp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3NwYScsIFsndGhydXN0L3NwYS9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsK",
                "body": "LyohIHRocnVzdC1qcyAtIHYwLjEuNSAtIDIwMTMtMDEtMjcgKi8KZGVmaW5lKCd0aHJ1c3QvdXRpbC9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICdsb2Rhc2gnLCAndW5kZXJzY29yZS5zdHJpbmcnLCAndXVpZCcsICd3aGVuJywgJ3doZW4vYXBwbHknLCAnd2hlbi9kZWxheScsICd3aGVuL3RpbWVvdXQnLCAnd2hlbi9wYXJhbGxlbCcsICd3aGVuL3BpcGVsaW5lJywgJ3doZW4vc2VxdWVuY2UnLCAnd2hlbi9jYW5jZWxhYmxlJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fX19fXywgX19fc19fLCBfX3V1aWRfXywgX193X18sIF9fd2hlbkFwcGx5X18sIF9fd2hlbkRlbGF5X18sIF9fd2hlblRpbWVvdXRfXywgX193aGVuUGFyYWxsZWxfXywgX193aGVuUGlwZWxpbmVfXywgX193aGVuU2VxdWVuY2VfXywgX193aGVuQ2FuY2VsYWJsZV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSB1dGlsIHsqLwogICAgdmFyIF9fID0gX19fX19fOwoKICAgIHZhciBfcyA9IF9fX3NfXzsKCiAgICB2YXIgdXVpZCA9IF9fdXVpZF9fOwoKICAgIAogICAgX18ubWl4aW4oX3MpOwogICAgZXhwb3J0cy5fID0gX187CiAgICAvLyNyZWdpb24gZnVuY3Rpb24KICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICAgIC8qKgogICAgQSBmdW5jdGlvbiB0aGF0IGRvZXMgbm90aGluZywgb3Igbm8gb3BlcmF0aW9uLiAgSGVuY2UgdGhlIG5hbWUgbm9vcC4KICAgIAogICAgQG1ldGhvZCBub29wCiAgICAqKi8KICAgIGZ1bmN0aW9uIG5vb3AoKSB7CiAgICB9CiAgICBleHBvcnRzLm5vb3AgPSBub29wOwogICAgdmFyIHByb3BlcnR5SXNFbnVtZXJhYmxlID0gbm9vcC5wcm9wZXJ0eUlzRW51bWVyYWJsZTsKICAgIC8qKgogICAgQXR0ZW1wdHMgdG8gaW52b2tlLCBzaW1pbGFyIHRvIF8uaW52b2tlLCBidXQgaW4gdGhpcyBjYXNlIGl0IHZlcmlmaWVzIHRoYXQgdGhlIHByb3BlcnR5IGV4aXN0LAogICAgYW5kIGFsc28gdmVyaWZpZXMgdGhhdCBpdCBpcyBhIGZ1bmN0aW9uLCBhbmQgbm90IHRoZSBub29wIG1ldGhvZCBhdmFpbGFibGUgaW4gdGhydXN0LgogICAgCiAgICBUaGUgaW50ZW50IGlzIGEgbWV0aG9kIHRoYXQgYWxsb3dzIG92ZXJyaWRlIG9mIGZ1bmN0aW9ucywgd2l0aG91dCBjcmVhdGluZyBjdXN0b20gY29kZS4KICAgIAogICAgQG1ldGhvZCBzYXZlSW52b2tlCiAgICBAcGFyYW0ge0FycmF5fE9iamVjdH0gY29sbGVjdGlvbiBUaGUgY29udGFpbmVyIHRoYXQgaGFzIHRoZSBpdGVtcwogICAgQHBhcmFtIHtTdHJpbmd8RnVuY3Rpb259IG1ldGhvZCBUaGUgbWV0aG9kIG5hbWUgb24gZXZlcnkgaXRlbSwgb3IgdGhlIG1ldGhvZCB0byBpbnZva2UgYWdhaW5zdCBlYWNoIGl0ZW0uCiAgICBAcGFyYW0ge09iamVjdH0gW2FyZ3NdKiBUaGUgYWRkaXRpb25hbCBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSBtZXRob2QuCiAgICAqKi8KICAgIGZ1bmN0aW9uIHNhZmVJbnZva2UoY29sbGVjdGlvbiwgbWV0aG9kTmFtZSkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMik7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAyXTsKICAgICAgICB9CiAgICAgICAgLypqc2hpbnQgYml0d2lzZTpmYWxzZSAqLwogICAgICAgICAgICAgICAgdmFyIGluZGV4LCBpdGVyYXRlZSA9IGNvbGxlY3Rpb24sIHJlc3VsdDsKICAgICAgICBpZighY29sbGVjdGlvbikgewogICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgfQogICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpLCBpc0Z1bmMgPSB0eXBlb2YgbWV0aG9kTmFtZSA9PSAnZnVuY3Rpb24nLCBtZXRob2RFeGlzdHM7CiAgICAgICAgdmFyIGxlbmd0aCA9IGl0ZXJhdGVlLmxlbmd0aDsKICAgICAgICBpbmRleCA9IC0xOwogICAgICAgIGlmKGxlbmd0aCA9PT0gbGVuZ3RoID4+PiAwKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICAgIHdoaWxlKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgICAgICAgIG1ldGhvZEV4aXN0cyA9IChpc0Z1bmMgPyBtZXRob2ROYW1lIDogaXRlcmF0ZWVbaW5kZXhdW21ldGhvZE5hbWVdKTsKICAgICAgICAgICAgICAgIG1ldGhvZEV4aXN0cyAmJiBtZXRob2RFeGlzdHMgIT09IG5vb3AgJiYgKHJlc3VsdFtpbmRleF0gPSBtZXRob2RFeGlzdHMuYXBwbHkoaXRlcmF0ZWVbaW5kZXhdLCBhcmdzKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgc2tpcFByb3RvID0gdHlwZW9mIGl0ZXJhdGVlID09ICdmdW5jdGlvbicgJiYgcHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChpdGVyYXRlZSwgJ3Byb3RvdHlwZScpOwogICAgICAgICAgICB2YXIgcHJvcHMgPSBleHBvcnRzLl8ua2V5cyhpdGVyYXRlZSksIHByb3BJbmRleCA9IC0xLCBsZW5ndGggPSBwcm9wcy5sZW5ndGg7CiAgICAgICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICAgIHdoaWxlKCsrcHJvcEluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpbmRleCA9IHByb3BzW3Byb3BJbmRleF07CiAgICAgICAgICAgICAgICBpZighKHNraXBQcm90byAmJiBpbmRleCA9PSAncHJvdG90eXBlJykpIHsKICAgICAgICAgICAgICAgICAgICBtZXRob2RFeGlzdHMgPSAoaXNGdW5jID8gbWV0aG9kTmFtZSA6IGl0ZXJhdGVlW2luZGV4XVttZXRob2ROYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgbWV0aG9kRXhpc3RzICYmIG1ldGhvZEV4aXN0cyAhPT0gbm9vcCAmJiAocmVzdWx0W3Byb3BJbmRleF0gPSAoKGlzRnVuYyA/IG1ldGhvZE5hbWUgOiBpdGVyYXRlZVtpbmRleF1bbWV0aG9kTmFtZV0pLmFwcGx5KGl0ZXJhdGVlW2luZGV4XSwgYXJncykpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZXhwb3J0cy5zYWZlSW52b2tlID0gc2FmZUludm9rZTsKICAgIC8qKgogICAgKiBDb25zdHJ1Y3RvciB1c2VkIHRvIGJlZ2V0IG9iamVjdHMgdGhhdCB3aXJlIG5lZWRzIHRvIGNyZWF0ZSB1c2luZyBuZXcuCiAgICAqIEBwYXJhbSBjdG9yIHtGdW5jdGlvbn0gcmVhbCBjb25zdHJ1Y3RvciB0byBiZSBpbnZva2VkCiAgICAqIEBwYXJhbSBhcmdzIHtBcnJheX0gYXJndW1lbnRzIHRvIGJlIHN1cHBsaWVkIHRvIGN0b3IKICAgICovCiAgICBmdW5jdGlvbiBEeW5hbWljbHlDcmVhdGVkKGN0b3IsIGFyZ3MpIHsKICAgICAgICByZXR1cm4gY3Rvci5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0KICAgIC8qKgogICAgKiBDcmVhdGVzIGFuIG9iamVjdCBieSBlaXRoZXIgaW52b2tpbmcgY3RvciBhcyBhIGZ1bmN0aW9uIGFuZCByZXR1cm5pbmcgdGhlIHJlc3VsdCwKICAgICogb3IgYnkgY2FsbGluZyBuZXcgY3RvcigpLiAgSXQgdXNlcyBhIHNpbXBsZSBoZXVyaXN0aWMgdG8gdHJ5IHRvIGd1ZXNzIHdoaWNoIGFwcHJvYWNoCiAgICAqIGlzIHRoZSAicmlnaHQiIG9uZS4KICAgICoKICAgICogQHBhcmFtIGN0b3Ige0Z1bmN0aW9ufSBmdW5jdGlvbiBvciBjb25zdHJ1Y3RvciB0byBpbnZva2UKICAgICogQHBhcmFtIGFyZ3Mge0FycmF5fSBhcnJheSBvZiBhcmd1bWVudHMgdG8gcGFzcyB0byBjdG9yIGluIGVpdGhlciBjYXNlCiAgICAqCiAgICAqIEByZXR1cm5zIFRoZSByZXN1bHQgb2YgaW52b2tpbmcgY3RvciB3aXRoIGFyZ3MsIHdpdGggb3Igd2l0aG91dCBuZXcsIGRlcGVuZGluZyBvbgogICAgKiB0aGUgc3RyYXRlZ3kgc2VsZWN0ZWQuCiAgICAqLwogICAgZnVuY3Rpb24gaW5zdGFudGlhdGUoY3RvciwgYXJncywgbmFtZSkgewogICAgICAgIER5bmFtaWNseUNyZWF0ZWQucHJvdG90eXBlID0gY3Rvci5wcm90b3R5cGU7CiAgICAgICAgRHluYW1pY2x5Q3JlYXRlZC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBjdG9yOwogICAgICAgIHZhciBiZWdvdHRlbiA9IG5ldyBEeW5hbWljbHlDcmVhdGVkKGN0b3IsIGFyZ3MpOwogICAgICAgIER5bmFtaWNseUNyZWF0ZWQucHJvdG90eXBlID0gdm9pZCAwOwogICAgICAgIHJldHVybiBiZWdvdHRlbjsKICAgIH0KICAgIGV4cG9ydHMuaW5zdGFudGlhdGUgPSBpbnN0YW50aWF0ZTsKICAgIC8qKgogICAgRmxhdHRlbiBhbmQgZmlsdGVyIGFycmF5cyBkb3duIHRvIGp1c3QgdGhlIGV4aXN0aW5nIHByb21pc2VzLgogICAgCiAgICBAbWV0aG9kIGZsYXR0ZW5Ub1Byb21pc2VzCiAgICBAcGFyYW0ge0FycmF5fSBBcnJheSB0byBmbGF0dGVuLCBhbmQgZmlsdGVyLgogICAgQHJldHVybnMge0FycmF5IG9mIFByb21pc2VzfQogICAgKiovCiAgICBmdW5jdGlvbiBmbGF0dGVuVG9Qcm9taXNlcyhhcnJheSkgewogICAgICAgIHJldHVybiBleHBvcnRzLl8uZmxhdHRlbihhcnJheSkuZmlsdGVyKGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIHJldHVybiB3aGVuLmlzUHJvbWlzZSh4KTsKICAgICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMuZmxhdHRlblRvUHJvbWlzZXMgPSBmbGF0dGVuVG9Qcm9taXNlczsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIG9iamVjdAogICAgLyoqCiAgICBJbnZlcnRzIGFuIG9iamVjdC4gIFRoZSBrZXlzIGJlY29tZSB2YWx1ZXMsIGFuZCB0aGUgdmFsdWVzIGJlY29tZSBrZXlzLgogICAgRG9lcyBub3QgZG8gYW55IGNvcHlpbmcuCiAgICAKICAgIEBtZXRob2QgaW52ZXJ0CiAgICBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgdG8gaW52ZXJ0LgogICAgQHJldHVybnMge09iamVjdH0gVGhlIGludmVydGVkIG9iamVjdC4KICAgICoqLwogICAgdmFyIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICBmdW5jdGlvbiBpbnZlcnQob2JqKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IHsKICAgICAgICB9OwogICAgICAgIGZvcih2YXIgaSBpbiBvYmopIHsKICAgICAgICAgICAgaWYoaGFzT3duLmNhbGwob2JqLCBpKSkgewogICAgICAgICAgICAgICAgcmVzdWx0W29ialtpXV0gPSBpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBleHBvcnRzLmludmVydCA9IGludmVydDsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIHR5cGUudHMKICAgIC8qKgogICAgQ2hlY2tzIGlzIHRoZSBvYmplY3QgaXMgYXJyYXkgbGlrZSwgbGlrZSB0aGUgYXJ1Z3VtZW50cyBvYmplY3QsIGJ1dCBub3QgYSBzdHJpbmcsIG9lIGFycmF5LgogICAgalF1ZXJ5IG9iamVjdHMgZm9yIGV4YW1wbGUgd291bGQgcmVwb3J0IGFzIGFycmF5IGxpa2UuCiAgICBBcyB3ZWxsIGFzIGtub2Nrb3V0IG9ic2VydmFibGUgYXJyYXlzIHJlcG9ydCBhcyBhcnJheSBsaWtlLgogICAgCiAgICBAbWV0aG9kIGlzQXJyYXlMaWtlCiAgICBAcGFyYW0ge09iamVjdH0gbyBUaGUgb2JqZWN0IHRvIGNoZWNrCiAgICBAcmV0dXJucyB7Qm9vbGVhbn0gSXMgaXQgdHJ1ZSBvciBmYWxzZS4KICAgICoqLwogICAgZnVuY3Rpb24gaXNBcnJheUxpa2UobykgewogICAgICAgIHJldHVybiAobyAmJiAhZXhwb3J0cy5fLmlzU3RyaW5nKG8pICYmIG8ubGVuZ3RoICE9PSB1bmRlZmluZWQpIHx8IGZhbHNlOwogICAgfQogICAgZXhwb3J0cy5pc0FycmF5TGlrZSA9IGlzQXJyYXlMaWtlOwogICAgLyoqCiAgICBDaGVja3MgaWYgdGhlIGdpdmVuIG9iamVjdCBpcyBhcnJheSBvciBhcnJheSBsaWtlLgogICAgCiAgICBAbWV0aG9kIGlzQXJyYXlPckFycmF5TGlrZQogICAgQHBhcmFtIHtPYmplY3R9IG8gVGhlIG9iamVjdCB0byBjaGVjawogICAgQHJldHVybnMge0Jvb2xlYW59IElzIGl0IHRydWUgb3IgZmFsc2UuCiAgICAqKi8KICAgIGZ1bmN0aW9uIGlzQXJyYXlPckFycmF5TGlrZShvKSB7CiAgICAgICAgcmV0dXJuIGV4cG9ydHMuXy5pc0FycmF5KG8pIHx8IChpc0FycmF5TGlrZShvKSk7CiAgICB9CiAgICBleHBvcnRzLmlzQXJyYXlPckFycmF5TGlrZSA9IGlzQXJyYXlPckFycmF5TGlrZTsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIHV1aWQKICAgICAgICB2YXIgZ3VpZFJlZ2V4ID0gL14oXHt7MCwxfShbMC05YS1mQS1GXSl7OH0tKFswLTlhLWZBLUZdKXs0fS0oWzAtOWEtZkEtRl0pezR9LShbMC05YS1mQS1GXSl7NH0tKFswLTlhLWZBLUZdKXsxMn1cfXswLDF9KSQvLCBlbXRwdHlHdWlkID0gJzAwMDAwMDAwLTAwMDAtMDAwMC0wMDAwLTAwMDAwMDAwMDAwMCc7CiAgICAvKioKICAgIFJldHVybnMgYSBuZXcgc3VkbyBndWlkLCBsaW1pYXRpb25zIGluIEphdmFTY3JpcHQgbWFrZSBtdXN0IG1vcmUgcmVsaWFibGUgZ3VpZHMgZmFpcmx5IGRpZmZpY3VsdCB0byBjcmVhdGUuCiAgICAKICAgIEBmb3IgdGhydXN0LnV0aWwKICAgIEBtZXRob2QgbmV3R3VpZAogICAgQHJldHVybnMge0d1aWR9IFRoZSBuZXcgZ3VpZC4KICAgICoqLwogICAgZnVuY3Rpb24gbmV3R3VpZCgpIHsKICAgICAgICByZXR1cm4gdXVpZC52NCgpOwogICAgfQogICAgZXhwb3J0cy5uZXdHdWlkID0gbmV3R3VpZDsKICAgIC8qKgogICAgUmV0dXJucyBhbiBlbXB0eSBndWlkLgogICAgCiAgICBAbWV0aG9kIGVtcHR5R3VpZAogICAgQHJldHVybnMge0d1aWR9IFRoZSBlbXRwdHkgZ3VpZC4KICAgICoqLwogICAgZnVuY3Rpb24gZW1wdHlHdWlkKCkgewogICAgICAgIHJldHVybiBlbXRwdHlHdWlkOwogICAgfQogICAgZXhwb3J0cy5lbXB0eUd1aWQgPSBlbXB0eUd1aWQ7CiAgICAvKioKICAgIENoZWNrcyBpZiB0aGUgZ2l2ZW4gc3RyaW5nIGlzIGEgZ3VpZC4KICAgIAogICAgQG1ldGhvZCBpc0d1aWQKICAgIEBwYXJhbSB7R3VpZH0gZ3VpZAogICAgQHJldHVybnMge0Jvb2xlYW59IElmIHRoZSBndWlkIGlzIGEgZ3VpZCBvciBub3QuCiAgICAqKi8KICAgIGZ1bmN0aW9uIGlzR3VpZChndWlkKSB7CiAgICAgICAgcmV0dXJuIGV4cG9ydHMuXy5pc1N0cmluZyhndWlkKSA/IGd1aWRSZWdleC50ZXN0KGd1aWQpIDogZmFsc2U7CiAgICB9CiAgICBleHBvcnRzLmlzR3VpZCA9IGlzR3VpZDsKICAgIC8qKgogICAgQ2hlY2tzIGlmIHRoZSBHdWlkIGlzIGFuIEVtcHR5IEd1aWQKICAgIAogICAgQG1ldGhvZCBpc0VtcHR5R3VpZAogICAgQHBhcmFtIHtHdWlkfSBndWlkCiAgICBAcmV0dXJucyB7Qm9vbGVhbn0gSWYgdGhlIGd1aWQgaXMgYSBndWlkIG9yIG5vdC4KICAgICoqLwogICAgZnVuY3Rpb24gaXNFbXB0eUd1aWQoZ3VpZCkgewogICAgICAgIHJldHVybiBndWlkID09PSBlbXRwdHlHdWlkOwogICAgfQogICAgZXhwb3J0cy5pc0VtcHR5R3VpZCA9IGlzRW1wdHlHdWlkOwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gc3RyaW5nCiAgICAgICAgdmFyIG9iamVjdEN1cmx5UmVnZXggPSAvXHtce3xcfVx9fFx7KC4qPylcfS9nLCBudW1iZXJDdXJseVJlZ2V4ID0gL1x7XHt8XH1cfXxceyhcZCspXH0vZzsKICAgIC8qKgogICAgQyMgc3R5bGUgc3RyaW5nIGZvcm1hdC4KICAgIAogICAgQGZvciB0aHJ1c3QudXRpbAogICAgQG1ldGhvZCBmb3JtYXQKICAgICoqLwogICAgZnVuY3Rpb24gZm9ybWF0KHN0cikgewogICAgICAgIHZhciBmb3JtYXRBcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgZm9ybWF0QXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICB9CiAgICAgICAgaWYodHlwZW9mIGZvcm1hdEFyZ3NbMF0gPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgIHZhciBhID0gZm9ybWF0QXJnc1swXTsKICAgICAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKG9iamVjdEN1cmx5UmVnZXgsIGZ1bmN0aW9uIChtLCBuKSB7CiAgICAgICAgICAgICAgICBpZihtID09ICd7eycpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3snOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYobSA9PSAnfX0nKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd9JzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhICYmIGFbbl0gfHwgJyc7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UobnVtYmVyQ3VybHlSZWdleCwgZnVuY3Rpb24gKG0sIG4pIHsKICAgICAgICAgICAgaWYobSA9PSAne3snKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ3snOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG0gPT0gJ319JykgewogICAgICAgICAgICAgICAgcmV0dXJuICd9JzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZm9ybWF0QXJnc1tuXSB8fCAnJzsKICAgICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMuZm9ybWF0ID0gZm9ybWF0OwogICAgZnVuY3Rpb24gZ2V0TW9kdWxlTmFtZUZvclBhdGgobmFtZSkgewogICAgICAgIHJldHVybiAobmFtZS5sYXN0SW5kZXhPZignLycpID4gLTEgPyBuYW1lLnN1YnN0cmluZyhuYW1lLmxhc3RJbmRleE9mKCcvJykgKyAxKSA6IG5hbWUpLnJlcGxhY2UoL1wuL2csICctJyk7CiAgICB9CiAgICBleHBvcnRzLmdldE1vZHVsZU5hbWVGb3JQYXRoID0gZ2V0TW9kdWxlTmFtZUZvclBhdGg7CiAgICAvLyNlbmRyZWdpb24KICAgIC8vI3JlZ2lvbiB1cmwKICAgICAgICB2YXIgZG91YmxlU2xhc2hSZWdleCA9IC9cL1wvL2csIHIyMCA9IC8lMjAvZywgcmJyYWNrZXQgPSAvXFtcXSQvOwogICAgLyoqCiAgICBqUXVlcnkgcGFyYW0gbWV0aG9kIHRvIGVuY29kZSBmb3JtIHBhcmFtZXRlcnMuCiAgICAKICAgIEBmb3IgdGhydXN0LnV0aWwudXJsCiAgICBAbWV0aG9kIHBhcmFtCiAgICAqKi8KICAgIGZ1bmN0aW9uIHBhcmFtKGEsIHRyYWRpdGlvbmFsKSB7CiAgICAgICAgdmFyIHByZWZpeCwgcyA9IFtdLCBhZGQgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAvLyBJZiB2YWx1ZSBpcyBhIGZ1bmN0aW9uLCBpbnZva2UgaXQgYW5kIHJldHVybiBpdHMgdmFsdWUKICAgICAgICAgICAgdmFsdWUgPSBleHBvcnRzLl8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSgpIDogKHZhbHVlID09IG51bGwgPyAiIiA6IHZhbHVlKTsKICAgICAgICAgICAgc1tzLmxlbmd0aF0gPSBlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgICAgICAgfTsKICAgICAgICAvLyBTZXQgdHJhZGl0aW9uYWwgdG8gdHJ1ZSBmb3IgalF1ZXJ5IDw9IDEuMy4yIGJlaGF2aW9yLgogICAgICAgIC8qaWYgKHRyYWRpdGlvbmFsID09PSB1bmRlZmluZWQpCiAgICAgICAgewogICAgICAgIC8vIFRPRE8gU3VwcG9ydCBmb3IgdHJhZGl0aW9uYWxFbmNvZGluZwogICAgICAgIC8vdHJhZGl0aW9uYWwgPSAhIW0uY29uZmlnKCkudHJhZGl0aW9uYWxFbmNvZGluZzsKICAgICAgICB9Ki8KICAgICAgICAvLyBJZiBhbiBhcnJheSB3YXMgcGFzc2VkIGluLCBhc3N1bWUgdGhhdCBpdCBpcyBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzLgogICAgICAgIGlmKGlzQXJyYXlPckFycmF5TGlrZShhKSkgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgdGhlIGZvcm0gZWxlbWVudHMKICAgICAgICAgICAgZXhwb3J0cy5fLmVhY2goYSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIGFkZCh4Lm5hbWUsIHgudmFsdWUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBJZiB0cmFkaXRpb25hbCwgZW5jb2RlIHRoZSAib2xkIiB3YXkgKHRoZSB3YXkgMS4zLjIgb3Igb2xkZXIKICAgICAgICAgICAgLy8gZGlkIGl0KSwgb3RoZXJ3aXNlIGVuY29kZSBwYXJhbXMgcmVjdXJzaXZlbHkuCiAgICAgICAgICAgIGZvcihwcmVmaXggaW4gYSkgewogICAgICAgICAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4LCBhW3ByZWZpeF0sIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIFJldHVybiB0aGUgcmVzdWx0aW5nIHNlcmlhbGl6YXRpb24KICAgICAgICByZXR1cm4gcy5qb2luKCImIikucmVwbGFjZShyMjAsICIrIik7CiAgICB9CiAgICBleHBvcnRzLnBhcmFtID0gcGFyYW07CiAgICBmdW5jdGlvbiBidWlsZFBhcmFtcyhwcmVmaXgsIG9iaiwgdHJhZGl0aW9uYWwsIGFkZCkgewogICAgICAgIGlmKGV4cG9ydHMuXy5pc0FycmF5KG9iaikpIHsKICAgICAgICAgICAgLy8gU2VyaWFsaXplIGFycmF5IGl0ZW0uCiAgICAgICAgICAgIGV4cG9ydHMuXy5lYWNoKG9iaiwgZnVuY3Rpb24gKGksIHYpIHsKICAgICAgICAgICAgICAgIGlmKHRyYWRpdGlvbmFsIHx8IHJicmFja2V0LnRlc3QocHJlZml4KSkgewogICAgICAgICAgICAgICAgICAgIC8vIFRyZWF0IGVhY2ggYXJyYXkgaXRlbSBhcyBhIHNjYWxhci4KICAgICAgICAgICAgICAgICAgICBhZGQocHJlZml4LCB2KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSWYgYXJyYXkgaXRlbSBpcyBub24tc2NhbGFyIChhcnJheSBvciBvYmplY3QpLCBlbmNvZGUgaXRzCiAgICAgICAgICAgICAgICAgICAgLy8gbnVtZXJpYyBpbmRleCB0byByZXNvbHZlIGRlc2VyaWFsaXphdGlvbiBhbWJpZ3VpdHkgaXNzdWVzLgogICAgICAgICAgICAgICAgICAgIC8vIE5vdGUgdGhhdCByYWNrIChhcyBvZiAxLjAuMCkgY2FuJ3QgY3VycmVudGx5IGRlc2VyaWFsaXplCiAgICAgICAgICAgICAgICAgICAgLy8gbmVzdGVkIGFycmF5cyBwcm9wZXJseSwgYW5kIGF0dGVtcHRpbmcgdG8gZG8gc28gbWF5IGNhdXNlCiAgICAgICAgICAgICAgICAgICAgLy8gYSBzZXJ2ZXIgZXJyb3IuIFBvc3NpYmxlIGZpeGVzIGFyZSB0byBtb2RpZnkgcmFjaydzCiAgICAgICAgICAgICAgICAgICAgLy8gZGVzZXJpYWxpemF0aW9uIGFsZ29yaXRobSBvciB0byBwcm92aWRlIGFuIG9wdGlvbiBvciBmbGFnCiAgICAgICAgICAgICAgICAgICAgLy8gdG8gZm9yY2UgYXJyYXkgc2VyaWFsaXphdGlvbiB0byBiZSBzaGFsbG93LgogICAgICAgICAgICAgICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCArICJbIiArICh0eXBlb2YgdiA9PT0gIm9iamVjdCIgfHwgZXhwb3J0cy5fLmlzQXJyYXkodikgPyBpIDogIiIpICsgIl0iLCB2LCB0cmFkaXRpb25hbCwgYWRkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmKCF0cmFkaXRpb25hbCAmJiBvYmogIT0gbnVsbCAmJiB0eXBlb2Ygb2JqID09PSAib2JqZWN0IikgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgb2JqZWN0IGl0ZW0uCiAgICAgICAgICAgIGZvcih2YXIgbmFtZSBpbiBvYmopIHsKICAgICAgICAgICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCArICJbIiArIG5hbWUgKyAiXSIsIG9ialtuYW1lXSwgdHJhZGl0aW9uYWwsIGFkZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBTZXJpYWxpemUgc2NhbGFyIGl0ZW0uCiAgICAgICAgICAgIGFkZChwcmVmaXgsIG9iaik7CiAgICAgICAgfQogICAgfQogICAgLyoqCiAgICBDbGVhbnMgdXAgZG91YmxlIHNsYXNocyBpbiBhIHVybCwgdXNlZCBieSB0aHJ1c3QvZGF0YQogICAgCiAgICBAbWV0aG9kIGNsZWFuVXJsCiAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gY2xlYW4KICAgIEByZXRydXNuIHtTdHJpbmd9IFRoZSBjbGVhbmVkIHVybAogICAgKiovCiAgICBmdW5jdGlvbiBjbGVhblVybCh1cmwpIHsKICAgICAgICByZXR1cm4gdXJsLnJlcGxhY2UoZG91YmxlU2xhc2hSZWdleCwgJy8nKTsKICAgIH0KICAgIGV4cG9ydHMuY2xlYW5VcmwgPSBjbGVhblVybDsKICAgIC8qKgogICAgQ2hlY2tzIGZvciBleGlzdGFuY2Ugb2YgYXBwbGljYXRpb24gcGF0aCBpbiB0aGUgdXJsLCBvciBodHRwIGlmIHRoZSB1cmwgaXMgc3VwcG9zZWQgdG8gZ28gdG8gYW5vdGhlciBsb2NhdGlvbi4KICAgIAogICAgQG1ldGhvZCBmaXh1cFVybAogICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGZpeHVwCiAgICBAcmV0cnVzbiB7U3RyaW5nfSBUaGUgZml4ZWQgdXJsCiAgICAqKi8KICAgIGZ1bmN0aW9uIGZpeHVwVXJsKHVybCwgdXJsUGF0aCkgewogICAgICAgIGlmKHVybC5pbmRleE9mKCdodHRwJykgPT09IC0xKSB7CiAgICAgICAgICAgIHZhciBwYXRoID0gdXJsUGF0aC5sYXN0SW5kZXhPZignLycpID09PSB1cmxQYXRoLmxlbmd0aCAtIDEgPyB1cmxQYXRoLnN1YnN0cmluZygwLCAtMSkgOiB1cmxQYXRoOwogICAgICAgICAgICBpZih1cmwuaW5kZXhPZihwYXRoKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIHVybCA9IHBhdGggKyB1cmw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXJsID0gY2xlYW5VcmwodXJsKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVybDsKICAgIH0KICAgIGV4cG9ydHMuZml4dXBVcmwgPSBmaXh1cFVybDsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIHdoZW4KICAgIHZhciB3ID0gX193X187CgogICAgLy9pbXBvcnQgdyA9IG1vZHVsZSgnd2hlbi9kZWJ1ZycpOwogICAgdmFyIHdoZW5BcHBseSA9IF9fd2hlbkFwcGx5X187CgogICAgdmFyIHdoZW5EZWxheSA9IF9fd2hlbkRlbGF5X187CgogICAgdmFyIHdoZW5UaW1lb3V0ID0gX193aGVuVGltZW91dF9fOwoKICAgIHZhciB3aGVuUGFyYWxsZWwgPSBfX3doZW5QYXJhbGxlbF9fOwoKICAgIHZhciB3aGVuUGlwZWxpbmUgPSBfX3doZW5QaXBlbGluZV9fOwoKICAgIHZhciB3aGVuU2VxdWVuY2UgPSBfX3doZW5TZXF1ZW5jZV9fOwoKICAgIHZhciB3aGVuQ2FuY2VsYWJsZSA9IF9fd2hlbkNhbmNlbGFibGVfXzsKCiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0LnV0aWwKICAgIEBzdWJtb2R1bGUgdGhydXN0LnV0aWwud2hlbgogICAgKiovCiAgICAoZnVuY3Rpb24gKHdoZW4pIHsKICAgICAgICB3aGVuLndoZW4gPSB3OwogICAgICAgIC8qKgogICAgICAgIHdoZW4uYXBwbHksIHVzZWQgdG8gYXBwbHkgd2hlbiByZXN1bHRzIG92ZXIgYSBmdW5jdGlvbiwgc2ltaWxhciB0byBqUXVlcnlzIERlZmVycmVkLgogICAgICAgIFNlZSBmb3IgbW9yZSBpbmZvcm1hdGlvbjogW2h0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tYXBwbHldKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tYXBwbHkpCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QudXRpbC53aGVuCiAgICAgICAgQG1ldGhvZCB3aGVuLmFwcGx5CiAgICAgICAgKiovCiAgICAgICAgd2hlbi5hcHBseSA9IHdoZW5BcHBseTsKICAgICAgICAvKioKICAgICAgICB3aGVuLmRlbGF5LCBjcmVhdGVzIGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIGluIHggbXMsIHVzaW5nIHNldFRpbWVvdXQuCiAgICAgICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1kZWxheV0oaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1kZWxheSkKICAgICAgICAKICAgICAgICBAbWV0aG9kIHdoZW4uZGVsYXkKICAgICAgICAqKi8KICAgICAgICB3aGVuLmRlbGF5ID0gd2hlbkRlbGF5OwogICAgICAgIC8qKgogICAgICAgIHdoZW4udGltZW91dCwgY3JlYXRlcyBhIHByb21pc2UgdGhhdCB3aWxsIHRpbWVvdXQgaWYgeCBtcyBpZiBub3QgcmVzb2x2ZWQuCiAgICAgICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi10aW1lb3V0XShodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXRpbWVvdXQpCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCB3aGVuLnRpbWVvdXQKICAgICAgICAqKi8KICAgICAgICB3aGVuLnRpbWVvdXQgPSB3aGVuVGltZW91dDsKICAgICAgICAvKioKICAgICAgICB3aGVuLnBhcmFsbGVsCiAgICAgICAgU2VlIGZvciBtb3JlIGluZm9ybWF0aW9uOiBbaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1wYXJhbGxlbF0oaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL3dpa2kvd2hlbi1wYXJhbGxlbCkKICAgICAgICAKICAgICAgICBAbWV0aG9kIHdoZW4ucGFyYWxsZWwKICAgICAgICAqKi8KICAgICAgICB3aGVuLnBhcmFsbGVsID0gd2hlblBhcmFsbGVsOwogICAgICAgIC8qKgogICAgICAgIHdoZW4ucGlwZWxpbmUKICAgICAgICBTZWUgZm9yIG1vcmUgaW5mb3JtYXRpb246IFtodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXBpcGVsaW5lXShodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLXBpcGVsaW5lKQogICAgICAgIAogICAgICAgIEBtZXRob2Qgd2hlbi5waXBlbGluZQogICAgICAgICoqLwogICAgICAgIHdoZW4ucGlwZWxpbmUgPSB3aGVuUGlwZWxpbmU7CiAgICAgICAgLyoqCiAgICAgICAgd2hlbi5zZXF1ZW5jZQogICAgICAgIFNlZSBmb3IgbW9yZSBpbmZvcm1hdGlvbjogW2h0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tc2VxdWVuY2VdKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tc2VxdWVuY2UpCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCB3aGVuLnNlcXVlbmNlCiAgICAgICAgKiovCiAgICAgICAgd2hlbi5zZXF1ZW5jZSA9IHdoZW5TZXF1ZW5jZTsKICAgICAgICAvKioKICAgICAgICB3aGVuLmNhbmNlbGFibGUKICAgICAgICBTZWUgZm9yIG1vcmUgaW5mb3JtYXRpb246IFtodHRwczovL2dpdGh1Yi5jb20vY3Vqb2pzL3doZW4vd2lraS93aGVuLWNhbmNlbGFibGVdKGh0dHBzOi8vZ2l0aHViLmNvbS9jdWpvanMvd2hlbi93aWtpL3doZW4tY2FuY2VsYWJsZSkKICAgICAgICAKICAgICAgICBAbWV0aG9kIHdoZW4uY2FuY2VsYWJsZQogICAgICAgICoqLwogICAgICAgIHdoZW4uY2FuY2VsYWJsZSA9IHdoZW5DYW5jZWxhYmxlOwogICAgICAgIHdoZW4uYWxsID0gd2hlbi53aGVuLmFsbDsKICAgICAgICB3aGVuLmFueSA9IHdoZW4ud2hlbi5hbnk7CiAgICAgICAgd2hlbi5jaGFpbiA9IHdoZW4ud2hlbi5jaGFpbjsKICAgICAgICB3aGVuLmRlZmVyID0gd2hlbi53aGVuLmRlZmVyOwogICAgICAgIHdoZW4uaXNQcm9taXNlID0gd2hlbi53aGVuLmlzUHJvbWlzZTsKICAgICAgICB3aGVuLm1hcCA9IHdoZW4ud2hlbi5tYXA7CiAgICAgICAgd2hlbi5yZWR1Y2UgPSB3aGVuLndoZW4ucmVkdWNlOwogICAgICAgIHdoZW4uc29tZSA9IHdoZW4ud2hlbi5zb21lOwogICAgICAgIHdoZW4ucmVzb2x2ZSA9IHdoZW4ud2hlbi5yZXNvbHZlOwogICAgICAgIHdoZW4ucmVqZWN0ID0gd2hlbi53aGVuLnJlamVjdDsKICAgICAgICB3aGVuLmpvaW4gPSB3aGVuLndoZW4uam9pbjsKICAgIH0pKGV4cG9ydHMud2hlbiB8fCAoZXhwb3J0cy53aGVuID0ge30pKTsKICAgIHZhciB3aGVuID0gZXhwb3J0cy53aGVuOwogICAgLy8jZW5kcmVnaW9uCiAgICAvLyNyZWdpb24gY2FtZWxDYXNlCiAgICAgICAgdmFyIHJtc1ByZWZpeCA9IC9eLW1zLS8sIHJkYXNoQWxwaGEgPSAvLShbXGRhLXpdKS9naSwgZmNhbWVsQ2FzZSA9IGZ1bmN0aW9uIChhbGwsIGxldHRlcikgewogICAgICAgIHJldHVybiAobGV0dGVyICsgIiIpLnRvVXBwZXJDYXNlKCk7CiAgICB9OwogICAgZnVuY3Rpb24gY2FtZWxDYXNlKHN0cmluZykgewogICAgICAgIHJldHVybiBzdHJpbmcucmVwbGFjZShybXNQcmVmaXgsICJtcy0iKS5yZXBsYWNlKHJkYXNoQWxwaGEsIGZjYW1lbENhc2UpOwogICAgfQogICAgZXhwb3J0cy5jYW1lbENhc2UgPSBjYW1lbENhc2U7CiAgICBmdW5jdGlvbiB1bkNhbWVsQ2FzZShzdHIpIHsKICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UoLyhbQS1aXSkvZywgZnVuY3Rpb24gKGFsbCwgcykgewogICAgICAgICAgICByZXR1cm4gJy0nICsgcy50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy51bkNhbWVsQ2FzZSA9IHVuQ2FtZWxDYXNlOwogICAgLy8jZW5kcmVnCiAgICB9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3V0aWwnLCBbJ3RocnVzdC91dGlsL21haW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwoKZGVmaW5lKCd0aHJ1c3QvY2Fwc3VsZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L3V0aWwnLCAnLi9sb2cnLCAnaGFzJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdXRpbF9fLCBfX2xvZ19fLCBfX2hhc19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBsb2cgPSBfX2xvZ19fOwoKICAgIHZhciBoYXMgPSBfX2hhc19fOwoKICAgIHZhciBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgZWFjaCA9IF8uZWFjaCwgaXNPYmplY3QgPSBfLmlzT2JqZWN0LCBleHRlbmQgPSBfLmV4dGVuZCwgd2hlbiA9IHV0aWwud2hlbiwgZmxhdHRlbiA9IF8uZmxhdHRlbiwgcGx1Y2sgPSBfLnBsdWNrLCBmbGF0dGVuVG9Qcm9taXNlcyA9IHV0aWwuZmxhdHRlblRvUHJvbWlzZXMsIHRocnVzdENhY2hlID0gewogICAgfSwgX19vcHRpb25hbE1ldGhvZHMgPSBbCiAgICAgICAgLy8gT3B0aW9uYWwgbWV0aG9kcyB0aGF0IG1heSBiZSBvbiBhIG1vZHVsZQogICAgICAgICdzdGFydCcsIAogICAgICAgICdzdG9wJywgCiAgICAgICAgJ3JlYWR5JywgCiAgICAgICAgJ2NvbmZpZycsIAogICAgICAgIAogICAgXSwgX19yZXF1aXJlZE1ldGhvZHMgPSBbCiAgICAgICAgLy8gUmVxdWlyZWQgbWV0aG9kcyB0aGF0IG11c3QgYmUgb24gZXZlcnkgbW9kdWxlCiAgICAgICAgJ2luaXQnLCAKICAgICAgICAnZGVzdHJveScsIAogICAgICAgIAogICAgXTsKICAgIC8qKgogICAgTW92ZXMgYWxsIHByb3BlcnRpZXMsIHRoYXQgc2hvdWxkIGV4aXN0IG91dHNpZGUgb2YgdGhlIG1vZHVsZSwgaW50byBhIHByaXZhdGUgb2JqZWN0IGZvciBob2xkaW5nLgogICAgCiAgICBAbWV0aG9kIG1vdmVUb1RocnVzdENhY2hlCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtPYmplY3R9IGZyb20gT2JqZWN0IHRvIGV4dHJhY3QgaXRlbXMgZnJvbQogICAgQHBhcmFtIHtPYmplY3R9IHRvIE9iamVjdCB0byBwbGFjZSBpdGVtcyBvbgogICAgQHBhcmFtIHtBcnJheX0gbGlzdCBJdGVtcyB0byBtb3ZlIGZyb20gdG8gdGhlIG90aGVyIG9iamVjdAogICAgKiovCiAgICBmdW5jdGlvbiBtb3ZlVG9UaHJ1c3RDYWNoZShmcm9tLCB0bywgbGlzdCkgewogICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBsaXN0Lmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICB0b1tsaXN0W2ldXSA9IGZyb21bbGlzdFtpXV07CiAgICAgICAgICAgIGRlbGV0ZSBmcm9tW2xpc3RbaV1dOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGdldEV2ZW50TmFtZXNwYWNlKG5hbWUsIHByZWZpeCkgewogICAgICAgIGlmKCFwcmVmaXgpIHsKICAgICAgICAgICAgcHJlZml4ID0gJ21vZHVsZS0nOwogICAgICAgIH0KICAgICAgICByZXR1cm4gJy4nICsgKG5hbWUgPT09ICdnbG9iYWwnID8gJ2dsb2JhbCcgOiBwcmVmaXggKyBuYW1lLnJlcGxhY2UoL1wuL2csICctJykpOwogICAgfQogICAgZnVuY3Rpb24gY2FsbEZhY2FkZU1ldGhvZHMobWV0aG9kLCBtb2R1bGVDYWNoZSkgewogICAgICAgIHZhciBtID0gbW9kdWxlQ2FjaGUubW9kdWxlOwogICAgICAgIHZhciByZXN1bHRzID0gW107CiAgICAgICAgXy5mb3JPd24obW9kdWxlQ2FjaGUuZmFjYWRlcywgZnVuY3Rpb24gKGZhY2FkZSwgaSkgewogICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoZm9ybWF0KCd0aHJ1c3QvY2Fwc3VsZTogQ2FsbGluZyBmYWNhZGUgInswfSIgezF9KCknLCBpLCBtZXRob2QpKTsKICAgICAgICAgICAgaWYoZmFjYWRlW21ldGhvZF0gJiYgaXNPYmplY3QoZmFjYWRlKSkgewogICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKGZhY2FkZVttZXRob2RdLmNhbGwoZmFjYWRlLCBtKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXN1bHRzLnB1c2godXRpbC5zYWZlSW52b2tlKChtLnRocnVzdCkuX190aHJ1c3RDb252ZW50aW9ucywgbWV0aG9kLCBtLCBtb2R1bGVDYWNoZS5mYWNhZGVzKSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICB9CiAgICAvKioKICAgIFRoZSBtb2R1bGUgaXMgdGhlIGhlYXJ0IG9mIHRoZSB0aHJ1c3QsIGV2ZXJ5IG1vZHVsZSBnZXRzIG9uZSBmYWNhZGUgcGVyIG1vZHVsZS4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgIEBjbGFzcyB0aHJ1c3QuTW9kdWxlCiAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UKICAgIEBwYXJhbSB7T2JqZWN0fSBkZWYgVGhlIG1vZHVsZSBkZWZpbml0aW9uCiAgICBAcGFyYW0ge1N0cmluZ30gW25hbWVdIFRoZSBtb2R1bGUgbmFtZS4KICAgICoqLwogICAgdmFyIE1vZHVsZSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgLy92YXIgTW9kdWxlID0KICAgICAgICBmdW5jdGlvbiBNb2R1bGUodGhydXN0LCBkZWYsIG5hbWUpIHsKICAgICAgICAgICAgbmFtZSA9IHRoaXMubmFtZSA9IChuYW1lIHx8IGRlZi5uYW1lKTsKICAgICAgICAgICAgaWYodHlwZW9mIGRlZiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgZGVmID0gZGVmKG5hbWUpOwogICAgICAgICAgICAgICAgZGVmLm5hbWUgPSBuYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBtaWQgPSB0aGlzLm1pZCA9IHRocnVzdC5uYW1lICsgJzonICsgbmFtZTsKICAgICAgICAgICAgdmFyIHRDYWNoZSA9IHRocnVzdENhY2hlW2RlZi5oYXNoIHx8IG1pZF07CiAgICAgICAgICAgIC8vIENsZWFyIGFueSBwb3RlbnRpYWwgY2FjaGVkIGNvbmZpZyBvYmplY3RzLCB0byBtYWtlIHN1cmUgdGhleSByZWZyZXNoIGlmIHRoZSBtb2R1bGUgaXMgcmVkZWZpbmVkLgogICAgICAgICAgICBpZih0Q2FjaGUpIHsKICAgICAgICAgICAgICAgIF8ua2V5cyh0Q2FjaGUpLmZpbHRlcihmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB4LmluZGV4T2YoJ2NvbmZpZy4nKSA9PT0gMDsKICAgICAgICAgICAgICAgIH0pLmZvckVhY2goZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGVsZXRlIHRDYWNoZVt4XTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaW5zdGFuY2UgPSBleHRlbmQoZGVmLCB0Q2FjaGUgJiYgdENhY2hlLmluc3RhbmNlIHx8IHsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuaW5zdGFuY2UubmFtZSA9ICh0aGlzLmluc3RhbmNlLm5hbWUgfHwgbmFtZSk7CiAgICAgICAgICAgIHRoaXMuaW5zdGFuY2UubWlkID0gbWlkOwogICAgICAgICAgICBpZighdGhpcy5pbnN0YW5jZS5uYW1lKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FsbCBNb2R1bGVzIG11c3QgaGF2ZSBhIG5hbWUhJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gTW9kdWxlcyBtdXN0IGhhdmUgYW4gaW5pdCBtZXRob2QgYW5kIGEgZGVzdHJveSBtZXRob2QsIGl0J3MgdXAgdG8gdGhlIG1vZHVsZSBkZXZlbG9wZXIgdG8gcG9wdWxhdGUgdGhlc2UgbWV0aG9kcy4KICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IF9fcmVxdWlyZWRNZXRob2RzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgaWYoIWRlZltfX3JlcXVpcmVkTWV0aG9kc1tpXV0pIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdSZXF1aXJlZCAiezB9IiBtZXRob2Qgbm90IGZvdW5kIG9uIG1vZHVsZSAiezF9IiEnLCBfX3JlcXVpcmVkTWV0aG9kc1tpXSwgbmFtZSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIElmIHRoZSBtb2R1bGUgbmFtZSBpcyB1bmRlZmluZWQsIGJyaW5nIHRoZSBuYW1lIGludG8gdGhlIG1vZHVsZS4KICAgICAgICAgICAgaWYodHlwZW9mIGRlZi5uYW1lID09PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgZGVmLm5hbWUgPSBuYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0gPSB0aHJ1c3RDYWNoZVttaWRdID0gZXh0ZW5kKHRDYWNoZSB8fCB7CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIF9zdGFydGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgIG5hbWU6IHV0aWwuZ2V0TW9kdWxlTmFtZUZvclBhdGgobmFtZSksCiAgICAgICAgICAgICAgICBtb2R1bGU6IHRoaXMKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRlbGV0ZSB0aHJ1c3RDYWNoZVtkZWYuaGFzaF07CiAgICAgICAgICAgIHZhciBmYWNhZGVzID0gdGhydXN0TW9kdWxlQ2FjaGVJdGVtLmZhY2FkZXMgfHwgKHRocnVzdE1vZHVsZUNhY2hlSXRlbS5mYWNhZGVzID0gewogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYoIXRocnVzdC5fX2NvbnZlbnRpb25QbHVja1Byb3BlcnRpZXNDYWNoZSkgewogICAgICAgICAgICAgICAgdGhydXN0Ll9fY29udmVudGlvblBsdWNrUHJvcGVydGllc0NhY2hlID0gZmxhdHRlbihwbHVjayh0aHJ1c3QuX19jb252ZW50aW9ucyB8fCBbXSwgJ3Byb3BlcnRpZXMnKSkuZmlsdGVyKGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHguaW5kZXhPZignY29uZmlnLicpICE9PSAwOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gTW92ZSBhbGwgc3BlY2lhbCBwcm9wZXJ0aWVzIG9mZiB0byB0aGUgdGhydXN0J3MgaW50ZXJuYWwgbWV0aG9kLgogICAgICAgICAgICBtb3ZlVG9UaHJ1c3RDYWNoZSh0aGlzLmluc3RhbmNlLCB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0sIF9fcmVxdWlyZWRNZXRob2RzKTsKICAgICAgICAgICAgbW92ZVRvVGhydXN0Q2FjaGUodGhpcy5pbnN0YW5jZSwgdGhydXN0TW9kdWxlQ2FjaGVJdGVtLCBfX29wdGlvbmFsTWV0aG9kcyk7CiAgICAgICAgICAgIG1vdmVUb1RocnVzdENhY2hlKHRoaXMuaW5zdGFuY2UsIHRocnVzdE1vZHVsZUNhY2hlSXRlbSwgdGhydXN0Ll9fY29udmVudGlvblBsdWNrUHJvcGVydGllc0NhY2hlKTsKICAgICAgICAgICAgdXRpbC5zYWZlSW52b2tlKHRocnVzdCwgJ2NyZWF0ZUZhY2FkZScsIHRocnVzdCwgdGhpcy5pbnN0YW5jZSwgZmFjYWRlcyk7CiAgICAgICAgICAgIHRoaXMuX19uYW1lc3BhY2UgPSBnZXRFdmVudE5hbWVzcGFjZSh0aGlzLmluc3RhbmNlLm5hbWUpOwogICAgICAgICAgICB0aGlzLnRocnVzdCA9IHRocnVzdDsKICAgICAgICAgICAgdGhpcy5jYWNoZSA9IHRocnVzdENhY2hlW21pZF07CiAgICAgICAgfQogICAgICAgIE1vZHVsZS50aHJ1c3RDYWNoZSA9IHRocnVzdENhY2hlOwogICAgICAgIE1vZHVsZS5wcm90b3R5cGUuY29udmVudGlvbiA9IC8qKgogICAgICAgIEdldHRlci9TZXR0ZXIgZm9yIGNvbnZlbnRpb24gbWV0aG9kcy4KICAgICAgICBHZXRzIHRoZSB2YWx1ZSBjb252ZW50aW9uIHByb3BlcnR5IChkZWZpbmVkIGluIHRoZSBwcm9wZXJ0aWVzIGFycmF5IG9mIGEgZmFjYWRlKS4KICAgICAgICBTZXRzIHRoZSB2YWx1ZSBvZiBhIGNvbnZlbnRpb24gcHJvcGVydHkgKGZvciBzdG9yaW5nIGNvbnZlbnRpb24gY29uZmlndXJhdGlvbikKICAgICAgICAKICAgICAgICBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkgVGhlIHByb3BlcnR5IHRvIGdldCBvciBzZXQKICAgICAgICBAcGFyYW0ge29iamVjdH0gW3ZhbHVlXSBUaGUgdmFsdWUgdG8gc2V0CiAgICAgICAgQG1ldGhvZCBjb252ZW50aW9uCiAgICAgICAgQHJldHVybnMge09iamVjdH0gVGhlIHZhbGF1ZS4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAocHJvcGVydHksIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciB0YyA9IHRoaXMuY2FjaGU7CiAgICAgICAgICAgIGlmKHByb3BlcnR5LmluZGV4T2YoJ2NvbmZpZy4nKSA9PT0gMCkgewogICAgICAgICAgICAgICAgaWYodHlwZW9mIHRjW3Byb3BlcnR5XSA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgICAgICB0Y1twcm9wZXJ0eV0gPSB0aGlzLmdldFZhbHVlRnJvbVBhdGgocHJvcGVydHksIHRjKSB8fCBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0eXBlb2YgdmFsdWUgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICB0Y1twcm9wZXJ0eV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGNbcHJvcGVydHldOwogICAgICAgIH07CiAgICAgICAgTW9kdWxlLnByb3RvdHlwZS5nZXRWYWx1ZUZyb21QYXRoID0gZnVuY3Rpb24gKHBhdGgsIG9iamVjdCkgewogICAgICAgICAgICB2YXIgcGF0aHMgPSBwYXRoLnNwbGl0KCcuJyksIHYgPSBvYmplY3Q7CiAgICAgICAgICAgIF8uZWFjaChwYXRocywgZnVuY3Rpb24gKHApIHsKICAgICAgICAgICAgICAgIHYgPSB2ICYmIHZbcF07CiAgICAgICAgICAgICAgICBpZighdikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgIH07CiAgICAgICAgTW9kdWxlLnByb3RvdHlwZS50aHJ1c3RDcmVhdGUgPSAvKioKICAgICAgICBJbmplY3RzIHRoaXMgbW9kdWxlIGludG8gdGhlIGdpdmVuIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHRocnVzdENyZWF0ZQogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIHRocnVzdC5fX2luamVjdE1vZHVsZSh0aGlzKTsKICAgICAgICB9OwogICAgICAgIE1vZHVsZS5wcm90b3R5cGUudGhydXN0Q2FsbCA9IC8qKgogICAgICAgIE1ha2VzIGEgY2FsbCB0byBhbGwgdGhlIG1vZHVsZXMgZmFjYWRlcwogICAgICAgIFRoZSBvcmRlciBvZiB0aGUgY2FsbCBkZXBlbmRzIG9uIHRoZSBvcmRlciByZXF1aXJlZC4KICAgICAgICBEdXJpbmcgdGhlIHN0YXJ0dXAgc3RhZ2UgKGluaXQsIHN0YXJ0LCByZWFkeSkgZmFjYWRlcyBhcmUgY2FsbGVkIGZpcnN0LgogICAgICAgIER1cmluZyB0aGUgc2h1dGRvd24gc3RhdGUgKHN0b3AsIGRlc3Ryb3kpIGZhY2FkZXMgYXJlIGNhbGxlZCBsYXN0LgogICAgICAgIFRoaXMgYWxsb3dzIG1vZHVsZXMgdG8gc3RhcnR1cCBhbmQgc2h1dGRvd24gd2lsbCBhbGwgdGhlIHRvb2xzIGl0IGhhZCB0byBiZWdpbiB3aXRoLgogICAgICAgIAogICAgICAgIEBtZXRob2QgdGhydXN0Q2FsbAogICAgICAgIEBwcm90ZWN0ZWQKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbWV0aG9kIHRoZSBtZXRob2QgdG8gY2FsbAogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gZmFjYWRlQWZ0ZXIgY2FsbHMgZmFjYWRlIG1ldGhvZHMgYmVmb3JlIG9yIGFmdGVyIG1vZHVsZSBtZXRob2QuCiAgICAgICAgQHBhcmFtIHtBcnJheX0gYXJncyBBcmdzIHRvIGJlIHBhc3NlZCBvbnRvIHRoZSBtb2R1bGUgbWV0aG9kLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChtZXRob2QsIGZhY2FkZUFmdGVyLCBhcmdzKSB7CiAgICAgICAgICAgIHZhciBzZXEgPSBbXSwgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ3RocnVzdC9jYXBzdWxlOiBDYWxsaW5nIGZhY2FkZXMgZm9yICJ7MH0iJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHZhciBjYWNoZSA9IHRoaXMuY2FjaGUsIG0gPSBjYWNoZVttZXRob2RdOwogICAgICAgICAgICBzZXEucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gY2FsbEZhY2FkZU1ldGhvZHMobWV0aG9kLCBjYWNoZSk7CiAgICAgICAgICAgICAgICBpZihyZXN1bHQgJiYgcmVzdWx0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbChmbGF0dGVuVG9Qcm9taXNlcyhyZXN1bHQpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKG0pIHsKICAgICAgICAgICAgICAgIHNlcS5wdXNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gbS5hcHBseSh0aGF0Lmluc3RhbmNlLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICBpZihyZXN1bHQgJiYgcmVzdWx0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwoZmxhdHRlblRvUHJvbWlzZXMocmVzdWx0KSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoZmFjYWRlQWZ0ZXIpIHsKICAgICAgICAgICAgICAgIHNlcS5wdXNoKHNlcS5zaGlmdCgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gd2hlbi5zZXF1ZW5jZShzZXEpOwogICAgICAgIH07CiAgICAgICAgTW9kdWxlLnByb3RvdHlwZS5zdGFydCA9IC8qKgogICAgICAgIFN0YXJ0IHRoZSBtb2R1bGUsIGluc2lkZSB0aGUgdGhydXN0IGNvbnRhaW5lciBpdCB3YXMgY3JlYXRlZCBvbi4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHN0YXJ0CiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiB0aGF0LnRocnVzdC5zdGFydCh0aGF0Lm5hbWUpOwogICAgICAgIH07CiAgICAgICAgTW9kdWxlLnByb3RvdHlwZS5zdG9wID0gLyoqCiAgICAgICAgU3RvcCB0aGUgbW9kdWxlLCBpbnNpZGUgdGhlIHRocnVzdCBjb250YWluZXIgaXQgd2FzIGNyZWF0ZWQgb24uCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBzdGFydAogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gdGhhdC50aHJ1c3Quc3RvcCh0aGF0Lm5hbWUpOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIE1vZHVsZTsKICAgIH0pKCk7CiAgICBleHBvcnRzLk1vZHVsZSA9IE1vZHVsZTsgICAgCiAgICAvKioKICAgIEFNRCBBUEkKICAgIGxvYWQKICAgIAogICAgSGFuZGxlcyBmZXRjaGluZyBvZiBhIG1vZHVsZSBpbnN0YW5jZS4KICAgIEZvcm1hdDoKICAgIHRocnVzdC9jYXBzdWxlIXtpbnN0YW5jZX06e21vZHVsZU5hbWV9CiAgICAKICAgIEBtZXRob2QgbG9hZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlIHRoYXQgaXMgYmVpbmcgZmV0Y2hlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gcGFyZW50UmVxdWlyZSB0aGUgcmVxdWlyZSBtZXRob2QgdG8gYmUgbG9hZGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBsb2FkIEFsbG93cyB0aGUgbG9hZCB0byBpbmZvcm0gdGhhdCBBTUQgZm9yIHRoZSB2YWx1ZSB0byBoYW5kIG9mZgogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgY3VzdG9tIGNvbmZpZ3VyYXRpb24uCiAgICAqKi8KICAgIGZ1bmN0aW9uIGxvYWQobmFtZSwgcGFyZW50UmVxdWlyZSwgbG9hZCwgY29uZmlnKSB7CiAgICAgICAgdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgnOicpLCBpbnN0YW5jZU5hbWUgPSBwYXJ0c1swXSwgbW9kdWxlTmFtZSA9IHBhcnRzWzFdOwogICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAndGhydXN0IScgKyBpbnN0YW5jZU5hbWUKICAgICAgICBdLCBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIHZhciBtb2R1bGUgPSB0aHJ1c3QubW9kdWxlc1ttb2R1bGVOYW1lXTsKICAgICAgICAgICAgaWYoIW1vZHVsZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZvcm1hdCgnTW9kdWxlICJ7MH0iIGRvZXMgbm90IGV4aXN0IG9uIHRocnVzdCBpbnN0YW5jZSAiezF9Ii4nLCBtb2R1bGVOYW1lLCBpbnN0YW5jZU5hbWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsb2FkKG1vZHVsZSk7CiAgICAgICAgfSk7CiAgICB9CiAgICBleHBvcnRzLmxvYWQgPSBsb2FkOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jYXBzdWxlLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2luc3RhbmNlJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QvY2Fwc3VsZSddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXywgX19jYXBzdWxlX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9ImludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIC8qKgogICAgR2V0cyB0aGUgdGhydXN0IGluc3RhbmNlcy4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgICoqLwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgd2hlbiA9IHV0aWwud2hlbjsKICAgIHZhciBjYXBzdWxlID0gX19jYXBzdWxlX187CgogICAgLyoqCiAgICBUaGUgYXZhaWxhYmxlIHRocnVzdCBpbnN0YW5jZXMKICAgIGluZGV4IGJ5IG5hbWUKICAgIAogICAgQGZvciB0aHJ1c3QuaW5zdGFuY2UKICAgIEBwcm9wZXJ0eSBpbnN0YW5jZXMKICAgIEBwcml2YXRlCiAgICAqKi8KICAgIGV4cG9ydHMuaW5zdGFuY2VzID0gewogICAgfTsKICAgIC8qKgogICAgVGhlIGxvYWRpbmcgdGh1cnN0IGluc3RhbmNlcy4KICAgIGluZGV4IGJ5IG5hbWUKICAgIAogICAgQHByb3BlcnR5IGxvYWRpbmdJbnN0YW5jZXMKICAgIEBwcml2YXRlCiAgICAqKi8KICAgIGV4cG9ydHMubG9hZGluZ0luc3RhbmNlcyA9IHsKICAgIH07CiAgICAvKioKICAgIEdldHMgYSBuYW1lZCB0aHJ1c3Qgc3RhbmNlIGlmIGl0IGV4aXN0cy4KICAgIAogICAgQG1ldGhvZCBnZXRJbnN0YW5jZQogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIGluc3RhbmNlIG5hbWUKICAgIEByZXR1cm5zIHtUaHJ1c3R9IFRoZSB0aHJ1c3QgaW5zdGFuY2UKICAgICoqLwogICAgZnVuY3Rpb24gZ2V0SW5zdGFuY2UobmFtZSkgewogICAgICAgIHJldHVybiBleHBvcnRzLmluc3RhbmNlc1tuYW1lXSB8fCBudWxsOwogICAgfQogICAgZXhwb3J0cy5nZXRJbnN0YW5jZSA9IGdldEluc3RhbmNlOwogICAgLyoqCiAgICBGZXRjaHMgYSBuYW1lZCB0aHJ1c3Qgc3RhbmNlIGlmIGl0IGV4aXN0cy4KICAgIFRoaXMgbG9hZHMgYXN5bmNyb25vdXNseSwgYXMgdGhlIGluc3RhbmNlIG1heSBub3QgYmUgbG9hZGVkCiAgICAKICAgIEBtZXRob2QgZmV0Y2hJbnN0YW5jZQogICAgQHN0YXRpYwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBpbnN0YW5jZSBuYW1lCiAgICBAcmV0dXJucyB7UHJvbWlzZX0gVG8gYSB0aHJ1c3QgaW5zdGFuY2Ugc3BlYwogICAgKiovCiAgICBmdW5jdGlvbiBmZXRjaEluc3RhbmNlKG5hbWUpIHsKICAgICAgICB2YXIgZGVmZXIgPSBleHBvcnRzLmxvYWRpbmdJbnN0YW5jZXNbbmFtZV0gfHwgKGV4cG9ydHMubG9hZGluZ0luc3RhbmNlc1tuYW1lXSA9IHdoZW4uZGVmZXIoKSk7CiAgICAgICAgcmV0dXJuIGRlZmVyOwogICAgfQogICAgZXhwb3J0cy5mZXRjaEluc3RhbmNlID0gZmV0Y2hJbnN0YW5jZTsKICAgIC8qKgogICAgQ2xlYXJzIHRoZSBUaHJ1c3QgSW5zdGFuY2UgY2FjaGUsIHRoaXMgaXMgdXNlZCBmb3IgdW5pdCB0ZXN0aW5nLCBhbmQgY2xlYXJpbmcgYWxsIHRoZSBjYWNoZSBkYXRhIGVhY2ggcnVuLgogICAgCiAgICBAbWV0aG9kIGNsZWFyQ2FjaGUKICAgIEBzdGF0aWMKICAgIEBwcml2YXRlCiAgICAqKi8KICAgIGZ1bmN0aW9uIGNsZWFyQ2FjaGUoKSB7CiAgICAgICAgdXRpbC5fLmVhY2godXRpbC5fLmtleXMoZXhwb3J0cy5pbnN0YW5jZXMpLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICBleHBvcnRzLmluc3RhbmNlc1t4XSA9IG51bGw7CiAgICAgICAgICAgIGRlbGV0ZSBleHBvcnRzLmluc3RhbmNlc1t4XTsKICAgICAgICB9KTsKICAgICAgICB1dGlsLl8uZWFjaCh1dGlsLl8ua2V5cyhleHBvcnRzLmxvYWRpbmdJbnN0YW5jZXMpLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICBleHBvcnRzLmxvYWRpbmdJbnN0YW5jZXNbeF0gPSBudWxsOwogICAgICAgICAgICBkZWxldGUgZXhwb3J0cy5sb2FkaW5nSW5zdGFuY2VzW3hdOwogICAgICAgIH0pOwogICAgICAgIHV0aWwuXy5lYWNoKHV0aWwuXy5rZXlzKGNhcHN1bGUuTW9kdWxlLnRocnVzdENhY2hlKSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgY2Fwc3VsZS5Nb2R1bGUudGhydXN0Q2FjaGVbeF0gPSBudWxsOwogICAgICAgICAgICBkZWxldGUgY2Fwc3VsZS5Nb2R1bGUudGhydXN0Q2FjaGVbeF07CiAgICAgICAgfSk7CiAgICB9CiAgICBleHBvcnRzLmNsZWFyQ2FjaGUgPSBjbGVhckNhY2hlOwogICAgLyp9Ki8gfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9aW5zdGFuY2UuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvY29uZmlnJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICcuL2luc3RhbmNlJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdGhydXN0SW5zdGFuY2VfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgY29uZmlnIHsqLwogICAgCiAgICB2YXIgdGhydXN0SW5zdGFuY2UgPSBfX3RocnVzdEluc3RhbmNlX187CgogICAgLyoqCiAgICBQcm92aWRlcyB0aHJ1c3QgY29uZmlndXJhdGlvbgogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgQHN1Ym1vZHVsZSB0aHJ1c3QuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgVGhpcyBwcm9wZXJ0eSwgdGVsbHMgdGhlIGZyYW1ld29yayBpZiBpdCBzaG91bGQgdGhyb3cgZXJyb3JzIG9yIG5vdC4KICAgIEluIHByb2R1Y3Rpb24gaXQncyByZWNvbW1lbmRlZCBub3QgdG8gdGhyb3cgZXJyb3JzLCB0aGF0IHdheSBpZiBhIGNvbXBvbmVudCBmYWlscwogICAgdGhlcmUgaXMgYSBjaGFuY2UgdGhlIGFwcGxpY2F0aW9uIGNhbiBzdGlsbCByZWNvdmVyLgogICAgCiAgICBAZm9yIHRocnVzdC5jb25maWcKICAgIEBwcm9wZXJ0eSB0aHJvd0Vycm9ycwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgIEBkZWZhdWx0IGZhbHNlCiAgICAqKi8KICAgIGV4cG9ydHMudGhyb3dFcnJvcnMgPSB0cnVlOwogICAgLyoqCiAgICBUZWxscyB0aGUgZnJhbWV3b3JrIHRvIHJ1biBpbiBhc3luYyBtb2RlLCB0aGlzIG1heSBkZWxheSBzdGFydCB1cCwgYnV0IHdpbGwgbWFrZSBpbWFnZSBsb2FkaW5nIGFuZCBpbml0YWwgcnVubmluZyBhcHBlYXIgZmFzdGVyLgogICAgCiAgICBAcHJvcGVydHkgYXN5bmMKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAZGVmYXVsdCB0cnVlCiAgICAqKi8KICAgIGV4cG9ydHMuYXN5bmMgPSB0cnVlOwogICAgLyoqCiAgICBUZWxscyB0aHJ1c3QgdG8gZXhwb3NlIGVhY2ggaW5zdGFuY2UgYXMgYSBnbG9iYWwsIHRoaXMgYWxsb3dzIGxlZ2FjeSBjb21wb25lbnRzIHRvIHV0aWxpemUgcGFydHMgb2YgdGhydXN0LCBvciBlYXNpbHkKICAgIGdldCBhdCB5b3VyIHRocnVzdCBpbnN0YW5jZSBkdXJpbmcgZGVidWdnaW5nLgogICAgCiAgICBAcHJvcGVydHkgZXhwb3NlR2xvYmFscwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgIEBkZWZhdWx0IHRydWUKICAgICoqLwogICAgZXhwb3J0cy5leHBvc2VHbG9iYWxzID0gdHJ1ZTsKICAgIGV4cG9ydHMudXJsID0gewogICAgICAgIHBhdGg6IC8qKgogICAgICAgIFRoaXMgcHJvcGVydHksIGdpdmVzIHRoZSBmcmFtZXdvcmsgaXQncyBkZWZhdWx0IHBhdGgsIGlmIGRpZmZlcmVudCB0aGFuICcvJwogICAgICAgIAogICAgICAgIEBwcm9wZXJ0eSB1cmwucGF0aAogICAgICAgIEByZWFkT25seQogICAgICAgIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgQGRlZmF1bHQgIi8iCiAgICAgICAgKiovCiAgICAgICAgJy8nLAogICAgICAgIHRyYWRpdGlvbmFsRW5jb2Rpbmc6IC8qKgogICAgICAgIFRoaXMgcHJvcGVydHksIHRlbGxzIHRoZSBmcmFtZXdvcmsgaG93IGl0IHNob3VsZCBlbmNvZGUgYXJyYXkgZm9ybSBkYXRhLgogICAgICAgIEluIGdlbmVyYWwsIGZvciBBU1AuTkVUIGJhc2VkIGFwcGxpY2F0aW9ucywgdHJhZGl0aW9uYWwgc2hvdWxkIGJlIHRydWUuCiAgICAgICAgRm9yIFJ1YnkvUHl0aG9uIGJhc2VkIGFwcGxpY2F0aW9ucywgdGhpcyBzaG91bGQgYmUgZmFsc2UuCiAgICAgICAgCiAgICAgICAgQHByb3BlcnR5IHVybC50cmFkaXRpb25hbEVuY29kaW5nCiAgICAgICAgQHJlYWRPbmx5CiAgICAgICAgQHR5cGUge0Jvb2xlYW59CiAgICAgICAgQGRlZmF1bHQgZmFsc2UKICAgICAgICAqKi8KICAgICAgICB0cnVlCiAgICB9OwogICAgZXhwb3J0cy5sb2cgPSB7CiAgICAgICAgbGV2ZWw6IC8qKgogICAgICAgIFRoaXMgbGVuZHMgdG8gdGhlIGxvZyBsZXZlbCBvZiB0aHJ1c3QuCiAgICAgICAgCiAgICAgICAgRVJST1I6IDEKICAgICAgICBXQVJOOiAyCiAgICAgICAgSU5GTzogMwogICAgICAgIERFQlVHOiA0CiAgICAgICAgCiAgICAgICAgQHByb3BlcnR5IGxvZy5sZXZlbAogICAgICAgIEByZWFkT25seQogICAgICAgIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgQGRlZmF1bHQgMQogICAgICAgICoqLwogICAgICAgIDQsCiAgICAgICAgZW5hYmxlZDogLyoqCiAgICAgICAgVGhpcyB0b2dnbGVzIGVuYWJsaW5nIG9uIG9yIG9mZi4KICAgICAgICAKICAgICAgICBAcHJvcGVydHkgbG9nLmVuYWJsZWQKICAgICAgICBAcmVhZE9ubHkKICAgICAgICBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICBAZGVmYXVsdCBmYWxzZQogICAgICAgICoqLwogICAgICAgIHRydWUKICAgIH07CiAgICAvKioKICAgIFBsdWdpbnMgZm9yIHRocnVzdCB0byBsb2FkLCBvdmVycmlkZSB3aXRoIHlvdXIgb3duIHNldCBpZiB5b3UgaGF2ZSBhIGRpZmZlcmVudCBzZXQuCiAgICAKICAgIEBwcm9wZXJ0eSBwbHVnaW5zCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtBcnJheX0KICAgICoqLwogICAgZXhwb3J0cy5wbHVnaW5zID0gW107CiAgICAvKioKICAgICogVGhlIHNldCBvZiBtb2R1bGVzIHRvIHByZWxvYWQgd2l0aCB0aGUgaW5pdGFsIHdpcmV1cCBvZiB0aGUgVGhydXN0IGluc3RhbmNlLgogICAgKgogICAgKiBBY2NlcHRzIHRoZSBtb2R1bGUgcGF0aCBhIHN0cmluZyBvciB0aGUgbW9kdWxlIGFzIGFuIG9iamVjdCBpbiB0aGUgZm9sbG93aW5nIGZvcm1hdC4KICAgICogICBXaGVyZSBhcmdzIHdpbGwgYmUgaGFuZGVkIG9mZiB0byB0aGUgbW9kdWxlIGxpZmUgY3ljbGUgbWV0aG9kcy4KICAgICoKICAgICogICAgewogICAgKiAgICAgICAgcGF0aDogJycsCiAgICAqICAgICAgICBhcmdzOiBbXQogICAgKiAgICB9CiAgICAqCiAgICAqIEBwcm9wZXJ0eSBtb2R1bGVzCiAgICAqIEByZWFkT25seQogICAgKiBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMubW9kdWxlcyA9IFtdOwogICAgLyoqCiAgICBVc2VkIGludGVybmFsbHkgYnkgdGhydXN0IHRvIGRldGVybWluZSBpZiB0aGUgbGlmZS1jeWNsZSBpcyBjb250cm9sbGVkIGJ5IHRocnVzdCwgb3IgYSBwYXJlbnQgaW5zdGFuY2UuCiAgICAKICAgIEBwcm9wZXJ0eSBjaGlsZEluc3RhbmNlCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtCb29sZWFufQogICAgKiovCiAgICBleHBvcnRzLmNoaWxkSW5zdGFuY2UgPSBmYWxzZTsKICAgIC8qKgogICAgVXNlZCBpbnRlcm5hbGx5IGJ5IHRocnVzdCB0byBkZXRlcm1pbmUgaWYgdGhydXN0IHNob3VsZCBjb250cm9sIHRoZSBsaWZlLWN5Y2xlLCBvciB0aGUgY29uc3VtZXIKICAgIAogICAgQHByb3BlcnR5IGF1dG9tYXRpY0xpZmVjeWNsZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgICoqLwogICAgZXhwb3J0cy5hdXRvbWF0aWNMaWZlY3ljbGUgPSB0cnVlOwogICAgLyoqCiAgICBVc2VkIGludGVybmFsbHkgYnkgdGhydXN0IHRvIGRldGVybWluIGlmIHRoZSB0aHJ1c3QgaW5zdGFuY2Ugc2hvdWxkIGF1dG9tYXRpY2FsbHkgc3RhcnQgdXBvbiBjcmVhdGlvbi4KICAgIAogICAgQHByb3BlcnR5IGF1dG9TdGFydAogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgICoqLwogICAgZXhwb3J0cy5hdXRvU3RhcnQgPSBmYWxzZTsKICAgIC8qKgogICAgRGVmaW5lIHRoZSBjb252ZW50aW9ucyB0aGF0IHVuaXF1ZSB0byB0aHJ1c3QsIHRoZXkgYXJlIG5vdCBzcGVjaWZpYyB0byBhbnkgb25lIHBsdWdpbi4KICAgIAogICAgQHByb3BlcnR5IGNvbnZlbnRpb25zCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtBcnJheX0KICAgICoqLwogICAgZXhwb3J0cy5jb252ZW50aW9ucyA9IFsKICAgICAgICAndGhydXN0L2NvbnZlbnRpb24vY29udGFpbmVyJywgCiAgICAgICAgJ3RocnVzdC9jb252ZW50aW9uL2F1dG9zdGFydCcsIAogICAgICAgICd0aHJ1c3QvY29udmVudGlvbi9kZXBlbmRlbnQubW9kdWxlcycKICAgIF07CiAgICAvKioKICAgIEFNRCBBUEkKICAgIGxvYWQKICAgIAogICAgSGFuZGxlcyBmZXRjaGluZyBvZiBhIGN1cnJlbnQgY29uZmlnIGZvciB0aGUgY3VycmVudCB0aHJ1c3QgaW5zdGFuY2UsIG9yIHRoZSBjb25maWcgb2YgdGhlIGdpdmVuIHBsdWdpbi4KICAgIEFkZGluZyB0aGUgOiBjaGFyYWN0ZXIgcmVxdWVzdHMgYSBzcGVjaWZpYyBjb25maWcgcGx1Z2luLgogICAgdGhydXN0L2NvbmZpZyFnbG9iYWwgPSB0aHJ1c3QhZ2xvYmFsOmNvbmZpZyA9IFRocnVzdCBpbnN0YW5jZSBjb25maWcgZnJvbSB0aGUgaW5zdGFuY2UgbmFtZWQgZ2xvYmFsLgogICAgCiAgICBAbWV0aG9kIGxvYWQKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZSB0aGF0IGlzIGJlaW5nIGZldGNoZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IHBhcmVudFJlcXVpcmUgdGhlIHJlcXVpcmUgbWV0aG9kIHRvIGJlIGxvYWRlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gbG9hZCBBbGxvd3MgdGhlIGxvYWQgdG8gaW5mb3JtIHRoYXQgQU1EIGZvciB0aGUgdmFsdWUgdG8gaGFuZCBvZmYKICAgIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIGN1c3RvbSBjb25maWd1cmF0aW9uLgogICAgKiovCiAgICBmdW5jdGlvbiBsb2FkKG5hbWUsIHBhcmVudFJlcXVpcmUsIGxvYWQsIGNvbmZpZykgewogICAgICAgIHZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJzonKSwgcmVhbE5hbWUgPSBwYXJ0c1swXSwgcGx1Z2luTmFtZSA9IHBhcnRzWzFdIHx8IGZhbHNlOwogICAgICAgIHZhciBpbnN0YW5jZURlZmVycmVkID0gdGhydXN0SW5zdGFuY2UuZmV0Y2hJbnN0YW5jZShyZWFsTmFtZSk7CiAgICAgICAgaW5zdGFuY2VEZWZlcnJlZC5wcm9taXNlLnRoZW4oZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgdmFyIHBsdWdpbiA9IHBsdWdpbk5hbWUgJiYgY29udGV4dC5jZmdbcGx1Z2luTmFtZV0gfHwgY29udGV4dC5jb25maWc7CiAgICAgICAgICAgIGlmKCFwbHVnaW4pIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUGx1Z2luICInICsgcGx1Z2luTmFtZSArICciIGRvZXMgbm90IGV4aXN0IG9uIHRocnVzdCBpbnN0YW5jZSAiJyArIHJlYWxOYW1lICsgJyIuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbG9hZChwbHVnaW4pOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5sb2FkID0gbG9hZDsKICAgIC8qfSovIH0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWNvbmZpZy5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9sb2cnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJy4vY29uZmlnJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdENvbmZpZ19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICB2YXIgdENvbmZpZyA9IF9fdENvbmZpZ19fOwoKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgLyoqCiAgICBBIGJhc2ljIGxvZ2dlciBmb3IgdGhlIHRocnVzdCBmcmFtZXdvcmsuCiAgICBEaXNhYmxlcyBkZWJ1ZyBsb2dnaW5nIHdoZW4gdGhydXN0IGlzIG5vdCBpbiBkZWJ1ZyBtb2RlLgogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgCiAgICAqKi8KICAgIAogICAgLy8gTG9nIGxldmVscwogICAgdmFyIExFVkVMID0gewogICAgICAgIERFQlVHOiA0LAogICAgICAgIElORk86IDMsCiAgICAgICAgV0FSTjogMiwKICAgICAgICBFUlJPUjogMQogICAgfTsKICAgIC8vIERlY2xhcmUgb3VyIHZhcmlhYmxlcwogICAgICAgIHZhciBjb25zb2xlID0gd2luZG93LmNvbnNvbGUsIHRpbWVycyA9IHsKICAgIH0sIGNMb2cgPSAoY29uc29sZSAmJiBjb25zb2xlLmxvZykgfHwgZmFsc2UsIGNXYXJuID0gKGNvbnNvbGUgJiYgY29uc29sZS53YXJuKSB8fCBmYWxzZSwgY0luZm8gPSAoY29uc29sZSAmJiBjb25zb2xlLmluZm8pIHx8IGZhbHNlLCBjRXJyb3IgPSAoY29uc29sZSAmJiBjb25zb2xlLmVycm9yKSB8fCBmYWxzZSwgY1RpbWUgPSAoY29uc29sZSAmJiBjb25zb2xlWyd0aW1lJ10pIHx8IGZhbHNlLCBjVGltZUVuZCA9IChjb25zb2xlICYmIGNvbnNvbGVbJ3RpbWVFbmQnXSkgfHwgZmFsc2UsIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBjb25maWdMZXZlbCA9IHRDb25maWcubG9nLmxldmVsIHx8IExFVkVMLkVSUk9SLCBsb2dMZXZlbCA9IExFVkVMW2NvbmZpZ0xldmVsXSB8fCAodHlwZW9mIGNvbmZpZ0xldmVsID09PSAnc3RyaW5nJyAmJiBMRVZFTFtjb25maWdMZXZlbC50b1VwcGVyQ2FzZSgpXSkgfHwgKHR5cGVvZiBjb25maWdMZXZlbCA9PT0gJ251bWJlcicgJiYgY29uZmlnTGV2ZWwpIHx8IExFVkVMLkVSUk9SOwogICAgLy8gVmFyaW91cyBsb2dnZXJzIHRvIGhhbmRsZSBJRTgvOSBzdXBwb3J0LgogICAgdmFyIGxvZ1J1bm5lciA9IGZ1bmN0aW9uIChjb25zb2xlTWV0aG9kLCBsb2dUeXBlKSB7CiAgICAgICAgLy8gU2hvdyBsb2dzIHdoZW4gZW5hYmxlZCBvciBpZiB0aGV5IGFyZSBlcnJvcnMKICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICBpZihjb25zb2xlTWV0aG9kKSB7CiAgICAgICAgICAgIGlmKGNvbnNvbGVNZXRob2QuYXBwbHkpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGVNZXRob2QuYXBwbHkoY29uc29sZSwgYXJncyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zb2xlTWV0aG9kKGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmKCFjb25zb2xlTWV0aG9kICYmIGNMb2cpIHsKICAgICAgICAgICAgaWYoY0xvZy5hcHBseSkgewogICAgICAgICAgICAgICAgY0xvZy5hcHBseShjb25zb2xlLCBhcmdzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNMb2coYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAgLyoqCiAgICBBIGJhc2ljIGxvZ2dlciBmb3IgdGhlIHRocnVzdCBmcmFtZXdvcmsuCiAgICBEaXNhYmxlcyBkZWJ1ZyBsb2dnaW5nIHdoZW4gdGhydXN0IGlzIG5vdCBpbiBkZWJ1ZyBtb2RlLgogICAgCiAgICBAY2xhc3MgdGhydXN0LkxvZwogICAgKiovCiAgICAvKioKICAgIExvZ3MgYSBkZWJ1ZyB0eXBlIG1lc3NhZ2UgdXNpbmcgdGhlIGNvbnNvbGUgbG9nIG1ldGhvZAogICAgCiAgICBAbWV0aG9kIGRlYnVnCiAgICAqKi8KICAgIGZ1bmN0aW9uIGRlYnVnKCkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAwXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5ERUJVRykgewogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KGNMb2cpOwogICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncywgJ2xvZycpOwogICAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuZGVidWcgPSBkZWJ1ZzsKICAgIC8qKgogICAgTG9ncyBhIGluZm8gdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIGluZm8gbWV0aG9kIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGl0IHVzZXMgdGhlIGNvbnNvbGUgbG9nIG1ldGhvZC4KICAgIAogICAgQG1ldGhvZCBpbmZvCiAgICAqKi8KICAgIGZ1bmN0aW9uIGluZm8oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAwKTsgX2krKykgewogICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDBdOwogICAgICAgIH0KICAgICAgICAvLyBTaG9ydCBjaXJjdWl0IGlmIGxvZ2dpbmcgaXMgZGlzYWJsZWQuICBUaGlzIGlzIGFzIGNsb3NlIHRvIG5vb3AgYXMgd2UgY2FuIGdldCwgaW5jYXNlIHRoZXJlIGlzIGEgZGlyZWN0IHJlZmVyZW5jZSB0byB0aGlzIG1ldGhvZC4KICAgICAgICBpZighdENvbmZpZy5sb2cuZW5hYmxlZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKGxvZ0xldmVsID49IExFVkVMLklORk8pIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChjSW5mbyk7CiAgICAgICAgICAgIGxvZ1J1bm5lci5hcHBseSh0aGlzLCBhcmdzLCAnaW5mbycpOwogICAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuaW5mbyA9IGluZm87CiAgICAvKioKICAgIExvZ3MgYSB3YXJuIHR5cGUgbWVzc2FnZSB1c2luZyB0aGUgY29uc29sZSB3YXJuIG1ldGhvZCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBpdCB1c2VzIHRoZSBjb25zb2xlIGxvZyBtZXRob2QuCiAgICAKICAgIEBtZXRob2Qgd2FybgogICAgKiovCiAgICBmdW5jdGlvbiB3YXJuKCkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAwXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5XQVJOKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgICBhcmdzLnVuc2hpZnQoY1dhcm4pOwogICAgICAgICAgICBsb2dSdW5uZXIuYXBwbHkodGhpcywgYXJncywgJ3dhcm4nKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLndhcm4gPSB3YXJuOwogICAgLyoqCiAgICBMb2dzIGEgZXJyb3IgdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIGVycm9yIG1ldGhvZCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBpdCB1c2VzIHRoZSBjb25zb2xlIGxvZyBtZXRob2QuCiAgICAKICAgIEBtZXRob2QgZXJyb3IKICAgICoqLwogICAgZnVuY3Rpb24gZXJyb3IoKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAwKTsgX2krKykgewogICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDBdOwogICAgICAgIH0KICAgICAgICAvLyBTaG9ydCBjaXJjdWl0IGlmIGxvZ2dpbmcgaXMgZGlzYWJsZWQuICBUaGlzIGlzIGFzIGNsb3NlIHRvIG5vb3AgYXMgd2UgY2FuIGdldCwgaW5jYXNlIHRoZXJlIGlzIGEgZGlyZWN0IHJlZmVyZW5jZSB0byB0aGlzIG1ldGhvZC4KICAgICAgICBpZighdENvbmZpZy5sb2cuZW5hYmxlZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKGxvZ0xldmVsID49IExFVkVMLkVSUk9SKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgICBhcmdzLnVuc2hpZnQoY0Vycm9yKTsKICAgICAgICAgICAgbG9nUnVubmVyLmFwcGx5KHRoaXMsIGFyZ3MsICdlcnJvcicpOwogICAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuZXJyb3IgPSBlcnJvcjsKICAgIC8qKgogICAgTG9ncyBhIHRpbWUgdHlwZSBtZXNzYWdlIHVzaW5nIHRoZSBjb25zb2xlIHRpbWUgbWV0aG9kIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGl0IHVzZXMgdGhlIGNvbnNvbGUgbG9nIG1ldGhvZC4KICAgIAogICAgQG1ldGhvZCB0aW1lCiAgICAqKi8KICAgIGZ1bmN0aW9uIHRpbWUobWVzc2FnZSkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5ERUJVRykgewogICAgICAgICAgICB0aW1lcnNbbWVzc2FnZV0gPSB7CiAgICAgICAgICAgICAgICBzdGFydDogbmV3IERhdGUoKS5nZXRUaW1lKCkKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIG1zZyA9IHV0aWwuZm9ybWF0KCd7MH06IHRpbWVyIHN0YXJ0ZWQnLCBtZXNzYWdlKSwgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KG1zZyk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChjVGltZSk7CiAgICAgICAgICAgIGxvZ1J1bm5lci5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLnRpbWUgPSB0aW1lOwogICAgLyoqCiAgICBMb2dzIGEgdGltZUVuZCB0eXBlIG1lc3NhZ2UgdXNpbmcgdGhlIGNvbnNvbGUgdGltZUVuZCBtZXRob2QgaWYgYXZhaWxhYmxlLCBvdGhlcndpc2UgaXQgdXNlcyB0aGUgY29uc29sZSBsb2cgbWV0aG9kLgogICAgQ2F1c2VzIHRoZSB0aW1lciB0byBlbmQsIGZvciB0aGUgZ2l2ZW4gbWVzc2FnZS4KICAgIAogICAgQG1ldGhvZCB0aW1lRW5kCiAgICAqKi8KICAgIGZ1bmN0aW9uIHRpbWVFbmQobWVzc2FnZSkgewogICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICB9CiAgICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiBsb2dnaW5nIGlzIGRpc2FibGVkLiAgVGhpcyBpcyBhcyBjbG9zZSB0byBub29wIGFzIHdlIGNhbiBnZXQsIGluY2FzZSB0aGVyZSBpcyBhIGRpcmVjdCByZWZlcmVuY2UgdG8gdGhpcyBtZXRob2QuCiAgICAgICAgaWYoIXRDb25maWcubG9nLmVuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihsb2dMZXZlbCA+PSBMRVZFTC5ERUJVRykgewogICAgICAgICAgICB0aW1lcnNbbWVzc2FnZV0uZW5kID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTsKICAgICAgICAgICAgdmFyIHRpbWUgPSB0aW1lcnNbbWVzc2FnZV0uZW5kIC0gdGltZXJzW21lc3NhZ2VdLnN0YXJ0LCBtc2cgPSB1dGlsLmZvcm1hdCgnezB9OiB7MX1tcycsIG1lc3NhZ2UsIHRpbWUpOwogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KG1zZyk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChjVGltZUVuZCk7CiAgICAgICAgICAgIGxvZ1J1bm5lci5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLnRpbWVFbmQgPSB0aW1lRW5kOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1sb2cuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvaWduaXRlJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICdtb2R1bGUnLCAndGhydXN0L3V0aWwnLCAnLi9jb25maWcnLCAnLi9jYXBzdWxlJywgJy4vaW5zdGFuY2UnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19yZXF1aXJlTW9kdWxlX18sIF9fdXRpbF9fLCBfX2NvbmZpZ19fLCBfX3RtX18sIF9faW5zdGFuY2VfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgcmVxdWlyZU1vZHVsZSA9IF9fcmVxdWlyZU1vZHVsZV9fOwoKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICAKICAgIHZhciBjb25maWcgPSBfX2NvbmZpZ19fOwoKICAgIHZhciB0bSA9IF9fdG1fXzsKCiAgICB2YXIgaW5zdGFuY2UgPSBfX2luc3RhbmNlX187CgogICAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBpc0FycmF5ID0gXy5pc0FycmF5LCB0b0FycmF5ID0gXy50b0FycmF5LCBpc0Z1bmN0aW9uID0gXy5pc0Z1bmN0aW9uLCBlYWNoID0gXy5lYWNoLCBtYXAgPSBfLm1hcCwgYW55ID0gXy5hbnksIGFsbCA9IF8uYWxsLCB3aGVuID0gdXRpbC53aGVuLCBleHRlbmQgPSBfLmV4dGVuZCwgZmxhdHRlbiA9IF8uZmxhdHRlbiwgcGx1Y2sgPSBfLnBsdWNrLCBpc09iamVjdCA9IF8uaXNPYmplY3QsIGtleXMgPSBfLmtleXMsIHVuaW9uID0gXy51bmlvbjsKICAgIC8qZnVuY3Rpb24gcmVjb25jaWxlQXJyYXlzKGNvbmZpZywgc2V0dGluZ3MsIHRvKQogICAgewogICAgdmFyIGtleXMgPSBfLmtleXMoY29uZmlnKTsKICAgIGlmIChzZXR0aW5ncykKICAgIHsKICAgIGtleXMgPSB1bmlvbihfLmtleXMoc2V0dGluZ3MpLCBrZXlzKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgIHNldHRpbmdzID0ge307CiAgICB9CiAgICBlYWNoKGtleXMsIGZ1bmN0aW9uIChpKQogICAgewogICAgdmFyIHggPSBzZXR0aW5nc1tpXSB8fCBjb25maWdbaV07CiAgICBpZiAoaXNBcnJheSh4KSkKICAgIHsKICAgIHRvW2ldID0gdG9BcnJheShzZXR0aW5nc1tpXSB8fCB0b1tpXSk7CiAgICB9CiAgICBlbHNlIGlmIChpc09iamVjdCh4KSAmJiAhaXNGdW5jdGlvbih4KSkKICAgIHsKICAgIHJlY29uY2lsZUFycmF5cyh4LCBudWxsLCB0b1tpXSk7CiAgICB9CiAgICB9KTsKICAgIH0qLwogICAgZnVuY3Rpb24gbWVyZ2VTZXR0aW5ncyhzZXR0aW5ncykgewogICAgICAgIGlmKChzZXR0aW5ncykuX19zZXR0aW5nc01lcmdlZCkgewogICAgICAgICAgICByZXR1cm4gc2V0dGluZ3M7CiAgICAgICAgfQogICAgICAgIHZhciByZXF1aXJlQ29uZmlnID0gcmVxdWlyZU1vZHVsZS5jb25maWcoKSwgcGx1Z2lucyA9IFsKICAgICAgICAgICAgJ3RocnVzdC9tZWRpYXRvcicKICAgICAgICBdLmNvbmNhdChzZXR0aW5ncy5wbHVnaW5zIHx8IHJlcXVpcmVDb25maWcucGx1Z2lucyB8fCBjb25maWcucGx1Z2lucyB8fCBbXSksIGNvbnZlbnRpb25zID0gW10uY29uY2F0KHNldHRpbmdzLmNvbnZlbnRpb25zIHx8IHJlcXVpcmVNb2R1bGUuY29uZmlnKCkuY29udmVudGlvbnMgfHwgY29uZmlnLnBsdWdpbnMgfHwgW10pOwogICAgICAgIHNldHRpbmdzID0gXy5tZXJnZSh7CiAgICAgICAgfSwgY29uZmlnLCByZXF1aXJlTW9kdWxlLmNvbmZpZygpLCBzZXR0aW5ncywgewogICAgICAgICAgICBfX3NldHRpbmdzTWVyZ2VkOiB0cnVlLAogICAgICAgICAgICBwbHVnaW5zOiBwbHVnaW5zLAogICAgICAgICAgICBjb252ZW50aW9uczogY29udmVudGlvbnMKICAgICAgICB9KTsKICAgICAgICBzZXR0aW5ncy5wbHVnaW5zID0gcGx1Z2luczsKICAgICAgICBzZXR0aW5ncy5jb252ZW50aW9ucyA9IGNvbnZlbnRpb25zOwogICAgICAgIHJldHVybiBzZXR0aW5nczsKICAgIH0KICAgIGV4cG9ydHMubWVyZ2VTZXR0aW5ncyA9IG1lcmdlU2V0dGluZ3M7CiAgICBmdW5jdGlvbiBmdXNlKHNldHRpbmdzKSB7CiAgICAgICAgdmFyIHBpcGUgPSBbXTsKICAgICAgICBzZXR0aW5ncyA9IG1lcmdlU2V0dGluZ3Moc2V0dGluZ3MpOwogICAgICAgIGlmKCFpbnN0YW5jZS5pbnN0YW5jZXNbc2V0dGluZ3MubmFtZV0pIHsKICAgICAgICAgICAgcGlwZS5wdXNoKHN0YWdlT25lKTsKICAgICAgICB9CiAgICAgICAgcGlwZS5wdXNoKHN0YWdlVHdvKTsKICAgICAgICBpZihzZXR0aW5ncy5tb2R1bGVzICYmIHNldHRpbmdzLm1vZHVsZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIHBpcGUucHVzaChzdGFnZVRocmVlKTsKICAgICAgICB9CiAgICAgICAgdmFyIHByb21pc2UgPSB3aGVuLnBpcGVsaW5lKHBpcGUsIHNldHRpbmdzKTsKICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgIH0KICAgIGV4cG9ydHMuZnVzZSA9IGZ1c2U7CiAgICAvKioKICAgIENvbnRydWN0cyBhIHdpcmUgc3BlYyBmb3IgdGhydXN0IHRvIGxhdW5jaCBmcm9tLgogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgKiovCiAgICAvKioKICAgIE1lcmdlcyBhIGFsbCB0aGUgcGx1Z2lucyBjb25maWd1cmF0aW9ucywgd2l0aCB0aGUgZGVmYXVsdCBjb25maWcsIGFuZCB0aGVuIGZpbmFsbHkgd2l0aAogICAgYW55IGN1c3RvbWl6ZWQgY29uZmlnIGZyb20gcmVxdWlyZWpzCiAgICAKICAgIEBtZXRob2Qgc3RhZ2VPbmUKICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGludHMgdG8gcGFzcyBvbnRvIHRoZSB0aHJ1c3QgaW5zdGFuY2UgYmVpbmcgY3JlYXRlZC4KICAgICoqLwogICAgZnVuY3Rpb24gc3RhZ2VPbmUoc2V0dGluZ3MpIHsKICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqLwogICAgICAgICAgICAgICAgdmFyIHBsdWdpbnMgPSBzZXR0aW5ncy5wbHVnaW5zLCByZXF1aXJlQ29uZmlnID0gcmVxdWlyZU1vZHVsZS5jb25maWcoKSwgZGVmZXIgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgc2V0dGluZ3MucGx1Z2lucyA9IHBsdWdpbnM7CiAgICAgICAgcmVxdWlyZShwbHVnaW5zLm1hcChmdW5jdGlvbiAoeCkgewogICAgICAgICAgICByZXR1cm4geDsKICAgICAgICB9KSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKICAgICAgICAgICAgcGx1Z2lucy5mb3JFYWNoKGZ1bmN0aW9uIChwbHVnaW4sIGkpIHsKICAgICAgICAgICAgICAgIHZhciBuYW1lID0gcGx1Z2luLnN1YnN0cmluZyhwbHVnaW4ubGFzdEluZGV4T2YoJy8nKSArIDEpLCBwbHVnaW5TZXR0aW5ncyA9IHNldHRpbmdzW25hbWVdIHx8IHsKICAgICAgICAgICAgICAgIH0sIHBsdWdpblJlcXVpcmVDb25maWcgPSByZXF1aXJlQ29uZmlnW25hbWVdIHx8IHsKICAgICAgICAgICAgICAgIH0sIHBsdWdpbkNsYXNzID0gYXJnc1tpXVthcmdzW2ldLmNsYXNzTmFtZV07CiAgICAgICAgICAgICAgICBpZighY29uZmlnW25hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgY29uZmlnW25hbWVdID0gXy5tZXJnZShwbHVnaW5DbGFzcy5jb25maWcsIHBsdWdpblJlcXVpcmVDb25maWcgfHwgewogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGNvbnZlbnRpb25zID0gW10uY29uY2F0KHBsdWdpblNldHRpbmdzLmNvbnZlbnRpb25zIHx8IHBsdWdpblJlcXVpcmVDb25maWcuY29udmVudGlvbnMgfHwgY29uZmlnW25hbWVdLmNvbnZlbnRpb25zIHx8IFtdKTsKICAgICAgICAgICAgICAgIHNldHRpbmdzW25hbWVdID0gXy5tZXJnZSh7CiAgICAgICAgICAgICAgICB9LCBjb25maWdbbmFtZV0sIHBsdWdpblNldHRpbmdzIHx8IHsKICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBjb252ZW50aW9uczogY29udmVudGlvbnMKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgc2V0dGluZ3NbbmFtZV0uY29udmVudGlvbnMgPSBjb252ZW50aW9uczsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRlZmVyLnJlc29sdmUoc2V0dGluZ3MpOwogICAgICAgIH0sIGRlZmVyLnJlamVjdCk7CiAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7CiAgICB9CiAgICBleHBvcnRzLnN0YWdlT25lID0gc3RhZ2VPbmU7CiAgICAvKioKICAgIENyZWF0ZXMgYSB0aHJ1c3QgaW5zdGFuY2UsIGZyb20gdGhlIGdpdmVuIHNldHRpbmdzLgogICAgSW5jbHVkaW5nIHRoZSBwbHVnaW5zLgogICAgCiAgICBAbWV0aG9kIHN0YWdlVHdvCiAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbnRzIHRvIHBhc3Mgb250byB0aGUgdGhydXN0IGluc3RhbmNlIGJlaW5nIGNyZWF0ZWQuCiAgICAqKi8KICAgIGZ1bmN0aW9uIHN0YWdlVHdvKHNldHRpbmdzKSB7CiAgICAgICAgLypqc2hpbnQgbG9vcGZ1bmM6dHJ1ZSAqLwogICAgICAgIC8vIEdldCB0aGUgY29uZmlndXJhdGlvbgogICAgICAgICAgICAgICAgdmFyIGxvY2FsQ29uZmlnID0gc2V0dGluZ3MsIGRlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgIC8vIE1lZGlhdG9yIGlzIGEgcmVxdWlyZWQgcGx1Z2luLCBpbmNsdWRlIGFsbCB0aGUgb3RoZXJzIGluIGFkZGl0aW9uIHRvIGl0LgogICAgICAgICAgICAgICAgdmFyIHBsdWdpbnMgPSBsb2NhbENvbmZpZy5wbHVnaW5zLCBtb2R1bGVzVG9Mb2FkID0gLy8gVGhlIG1vZHVsZXMgdG8gbG9hZAogICAgICAgIFtdLCB0aHJ1c3RDb252ZW50aW9ucyA9IHNldHRpbmdzLmNvbnZlbnRpb25zIHx8IFtdLCBtb2R1bGVzQ29uZmlndXJhdGlvbnMgPSAvLyBUaGUgbW9kdWxlIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgewogICAgICAgICAgICB0aHJ1c3Q6ICd0aHJ1c3QnCiAgICAgICAgfTsKICAgICAgICAvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBwbHVnaW5zLCBjcmVhdGluZyBhIHByb3BlciBkZXBlbmRhbmN5IGxpc3QuCiAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IHBsdWdpbnMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgIHZhciBwbHVnaW4gPSBwbHVnaW5zW2ldLCBuYW1lID0gcGx1Z2luLnN1YnN0cmluZyhwbHVnaW4ubGFzdEluZGV4T2YoJy8nKSArIDEpLCBwbHVnaW5Db25maWcgPSBsb2NhbENvbmZpZ1tuYW1lXTsKICAgICAgICAgICAgbW9kdWxlc1RvTG9hZC5wdXNoKHBsdWdpbik7CiAgICAgICAgICAgIG1vZHVsZXNUb0xvYWQucHVzaChwbHVnaW5Db25maWcgJiYgcGx1Z2luQ29uZmlnLmNvbnZlbnRpb25zIHx8IFtdKTsKICAgICAgICAgICAgbW9kdWxlc0NvbmZpZ3VyYXRpb25zW3BsdWdpbl0gPSBwbHVnaW5Db25maWc7CiAgICAgICAgfQogICAgICAgIC8vIE5hbWUgYW5kIGNmZyBhcmUgZGVmYXVsdCBwcm9wZXJ0aWVzIG9mIHRoZSBjb25maWd1cmF0aW9uIGNvbnRleHQKICAgICAgICAgICAgICAgIHZhciBvcmRlcmVkUGx1Z2lucyA9IFsKICAgICAgICAgICAgJ25hbWUnLCAKICAgICAgICAgICAgJ2NmZycKICAgICAgICBdLCByZWxvb3AgPSAvLyBXZSBsb29wIHRocm91Z2ggdW50aWwgYWxsIHRoZSBwbHVnaW5zIGFyZSBpbiBwcm9wZXIgb3JkZXIuCiAgICAgICAgdHJ1ZSwgaUxlbiA9IG1vZHVsZXNUb0xvYWQubGVuZ3RoLCBpID0gMDsKICAgICAgICAvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBwbHVnaW5zIHVudGlsIHdlIGhhdmUgYSBzZXQgdGhhdCB3aWxsIGxvYWQgaW4gcHJvcGVyIG9yZGVyLgogICAgICAgIHdoaWxlKGkgPCBpTGVuKSB7CiAgICAgICAgICAgIC8vIFRoZSBwbHVnaW4KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBsdWdpbiA9IG1vZHVsZXNUb0xvYWRbaV0sIG5hbWUgPSAvLyBUaGUgaW1wbGllZCBwbHVnaW4gbmFtZQogICAgICAgICAgICBwbHVnaW4uc3Vic3RyaW5nKHBsdWdpbi5sYXN0SW5kZXhPZignLycpICsgMSksIHBsdWdpbkNvbmZpZyA9IC8vIFRoZSBwbHVnaW5zIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgbG9jYWxDb25maWdbbmFtZV07CiAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSBwbHVnaW4gaGFzIHRvIHJlc29sdmUgYW55IG90aGVyIHBsdWdpbnMKICAgICAgICAgICAgaWYocGx1Z2luQ29uZmlnICYmIHBsdWdpbkNvbmZpZy5yZXNvbHZlICYmIHBsdWdpbkNvbmZpZy5yZXNvbHZlLmxlbmd0aCA+IDAgJiYgIWFsbChwbHVnaW5Db25maWcucmVzb2x2ZSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhbnkob3JkZXJlZFBsdWdpbnMsIGZ1bmN0aW9uICh6KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHggPT09IHogfHwgeCA9PT0gejsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KSkgewogICAgICAgICAgICAgICAgLy8gVGhlIG1vZHVsZXMgdG8gbG9hZC4KICAgICAgICAgICAgICAgIC8vIEFsc28gaW5jbHVkZXMgYW55IGNvbnZlbnRpb25zLgogICAgICAgICAgICAgICAgbW9kdWxlc1RvTG9hZC5wdXNoLmFwcGx5KG1vZHVsZXNUb0xvYWQsIG1vZHVsZXNUb0xvYWQuc3BsaWNlKGksIDIpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIHJlb3JkZXIgdGhlIHBsdWdpbgogICAgICAgICAgICAgICAgaSArPSAyOwogICAgICAgICAgICAgICAgb3JkZXJlZFBsdWdpbnMucHVzaChuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBUaGUgbW9kdWxlcyBjb25maWcKICAgICAgICB2YXIgbW9kdWxlcyA9IGxvY2FsQ29uZmlnLm1vZHVsZXMgfHwgW107CiAgICAgICAgLy8gVGhydXN0IGFuZCB0aHJ1c3QvY2Fwc3VsZSBhbHNvIG5lZWQgdG8gYmUgbG9hZGVkLgogICAgICAgIG1vZHVsZXNUb0xvYWQucHVzaC5hcHBseShtb2R1bGVzVG9Mb2FkLCBbCiAgICAgICAgICAgICd0aHJ1c3QnLCAKICAgICAgICAgICAgc2V0dGluZ3MuY29udmVudGlvbnMgfHwgW10KICAgICAgICBdKTsKICAgICAgICAvLyBGbGF0dGVuIHRoZSByZXN1bHRhbnQgYXJyYXkKICAgICAgICBtb2R1bGVzVG9Mb2FkID0gZmxhdHRlbihtb2R1bGVzVG9Mb2FkKTsKICAgICAgICAvLyBDcmVhdGUgdGhlIGNvbmZpZ3VyYXRpb24gc3BlYwogICAgICAgIHZhciBzcGVjID0gewogICAgICAgICAgICBuYW1lOiBsb2NhbENvbmZpZy5uYW1lIHx8ICdnbG9iYWwnLAogICAgICAgICAgICBjZmc6IGxvY2FsQ29uZmlnCiAgICAgICAgfTsKICAgICAgICAvLyBMb2FkIGV2ZXJ5dGhpbmcKICAgICAgICByZXF1aXJlKG1vZHVsZXNUb0xvYWQsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gR2V0IHJlYWR5IHRvIGxvb3AKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRQbHVnaW4gPSBudWxsLCBhbGxDb252ZW50aW9ucyA9IFtdOwogICAgICAgICAgICAvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBtb2R1bGVzIGJlaW5nIGxvYWRlZAogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBpTGVuID0gbW9kdWxlc1RvTG9hZC5sZW5ndGg7IGkgPCBpTGVuIC0gdGhydXN0Q29udmVudGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIC8vIEdldCBwbHVnaW4gYW5kIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGx1Z2luID0gbW9kdWxlc1RvTG9hZFtpXSwgbUNvbmZpZyA9IG1vZHVsZXNDb25maWd1cmF0aW9uc1twbHVnaW5dOwogICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgd2UgaGF2ZSBhIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICBpZihtQ29uZmlnKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTG9hZCBhIG5ldyBwbHVnaW4uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGx1Z2luT2JqZWN0ID0gYXJnc1tpXSwgbmFtZSA9IC8vIEdldCB0aGUgcGx1Z2luIG5hbWUKICAgICAgICAgICAgICAgICAgICBwbHVnaW4uc3Vic3RyaW5nKHBsdWdpbi5sYXN0SW5kZXhPZignLycpICsgMSksIHJlc29sdmVJdGVtcyA9IC8vIFJlc29sdmUgYWxsIHRoZSByZXF1aXJlZCBpdGVtcy4KICAgICAgICAgICAgICAgICAgICBtYXAobUNvbmZpZy5yZXNvbHZlLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3BlY1t4XTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB2YXIgcGx1Z2luQ2xhc3MgPSBwbHVnaW5PYmplY3RbcGx1Z2luT2JqZWN0LmNsYXNzTmFtZV07CiAgICAgICAgICAgICAgICAgICAgLy8gSW5zdGFudGlhdGUgdGhlIHBsdWdpbgogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRQbHVnaW4gPSBzcGVjW25hbWVdID0gdXRpbC5pbnN0YW50aWF0ZShwbHVnaW5DbGFzcywgcmVzb2x2ZUl0ZW1zKTsKICAgICAgICAgICAgICAgICAgICAvLyBTZXR1cCB0aGUgY29udmVudGlvbnMKICAgICAgICAgICAgICAgICAgICBjdXJyZW50UGx1Z2luLl9fY29udmVudGlvbnMgPSBbXTsKICAgICAgICAgICAgICAgIH0gZWxzZSAvLyBMb2FkIGFsbCB0aGUgY29udmVudGlvbnMKICAgICAgICAgICAgICAgIGlmKGN1cnJlbnRQbHVnaW4pIHsKICAgICAgICAgICAgICAgICAgICAvLyBMb2FkIHRoZSBjb252ZW50aW9ucyBpbnRvIHRoZSBwbHVnaW4KICAgICAgICAgICAgICAgICAgICBfLmZvck93bihhcmdzW2ldLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFBsdWdpbi5fX2NvbnZlbnRpb25zLnB1c2goeCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgLy8gTG9hZCB0aGUgY29udmVudGlvbnMgaW50byB0aGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgICAgICAgICAgICAgIF8uZm9yT3duKGFyZ3NbaV0sIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhbGxDb252ZW50aW9ucy5wdXNoKHgpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFRoZSBsYXN0IGN1cnJlbnQgcGx1Z2luLCB3aWxsIGFsd2F5cyBiZSB0aHJ1c3QuCiAgICAgICAgICAgIGN1cnJlbnRQbHVnaW4uX19jb252ZW50aW9ucyA9IGFsbENvbnZlbnRpb25zOwogICAgICAgICAgICB2YXIgdGhydXN0Q29udmVudGlvbkRlZmluaXRpb25zID0gYXJncy5zbGljZShtb2R1bGVzVG9Mb2FkLmxlbmd0aCAtIHRocnVzdENvbnZlbnRpb25zLmxlbmd0aCk7CiAgICAgICAgICAgIHRocnVzdENvbnZlbnRpb25EZWZpbml0aW9ucyA9IGZsYXR0ZW4obWFwKHRocnVzdENvbnZlbnRpb25EZWZpbml0aW9ucywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtYXAoeCwgZnVuY3Rpb24gKHopIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gejsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIGN1cnJlbnRQbHVnaW4uX190aHJ1c3RDb252ZW50aW9ucyA9IHRocnVzdENvbnZlbnRpb25EZWZpbml0aW9uczsKICAgICAgICAgICAgYWxsQ29udmVudGlvbnMucHVzaC5hcHBseShhbGxDb252ZW50aW9ucywgdGhydXN0Q29udmVudGlvbkRlZmluaXRpb25zKTsKICAgICAgICAgICAgLy8gRXh0ZW5kIHRocnVzdCB3aXRoIHRoZSBzcGVjCiAgICAgICAgICAgIGV4dGVuZChjdXJyZW50UGx1Z2luLCBzcGVjKTsKICAgICAgICAgICAgZGVmZXIucmVzb2x2ZShzcGVjKTsKICAgICAgICB9LCBkZWZlci5yZWplY3QpOwogICAgICAgIHJldHVybiBkZWZlci5wcm9taXNlOwogICAgfQogICAgZXhwb3J0cy5zdGFnZVR3byA9IHN0YWdlVHdvOwogICAgLyoqCiAgICBMb2FkcyB1cCB0aGUgZGVmYXVsdCBtb2R1bGVzIGFzIGluZGljYXRlZCB0byB0aHJ1c3QuCiAgICAKICAgIEBtZXRob2Qgc3RhZ2VUaHJlZQogICAgQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgVGhlIGNvbnRleHQgdG8gdXNlIHRvIGxvYWQgdGhlIG1vZHVsZXMuCiAgICAqKi8KICAgIGZ1bmN0aW9uIHN0YWdlVGhyZWUoY29udGV4dCkgewogICAgICAgIHZhciB0aHJ1c3QgPSBjb250ZXh0LnRocnVzdCwgZGVmZXIgPSB3aGVuLmRlZmVyKCksIG1vZHVsZXMgPSBjb250ZXh0LmNmZy5tb2R1bGVzOwogICAgICAgIG1vZHVsZXMgPSBfLmZpbHRlcihtb2R1bGVzLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICByZXR1cm4gIXRocnVzdC5tb2R1bGVzW3hdOwogICAgICAgIH0pOwogICAgICAgIHJlcXVpcmUobW9kdWxlcywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAwKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAwXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgTW9kdWxlID0gdG0uTW9kdWxlOwogICAgICAgICAgICAvLyBHZXQgdGhlIGRlZmluaXRpb25zCiAgICAgICAgICAgIHZhciBtb2R1bGVEZWZpbml0aW9ucyA9IGFyZ3M7CiAgICAgICAgICAgIC8vIExvb3Agb3ZlciBhbGwgdGhlIG1vZHVsZXMKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IG1vZHVsZXMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAvLyBHZXQgdGhlIG1vZHVsZSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vZCA9IG1vZHVsZXNbaV0sIGRlZmluaXRpb24gPSAvLyBHZXQgdGhlIGRlZmluaXRpb24KICAgICAgICAgICAgICAgIG1vZHVsZURlZmluaXRpb25zW2ldOwogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIHRoZSBpbnN0YW5jZQogICAgICAgICAgICAgICAgdmFyIG1vZHVsZUluc3RhbmNlID0gbmV3IE1vZHVsZSh0aHJ1c3QsIGRlZmluaXRpb24sIG1vZCk7CiAgICAgICAgICAgICAgICAvLyBJbmplY3QgaXQgaW50byB0aGUgdGhydXN0IGluc3RhbmNlCiAgICAgICAgICAgICAgICBtb2R1bGVJbnN0YW5jZS50aHJ1c3RDcmVhdGUodGhydXN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZlci5yZXNvbHZlKGNvbnRleHQpOwogICAgICAgIH0sIGRlZmVyLnJlamVjdCk7CiAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7CiAgICB9CiAgICBleHBvcnRzLnN0YWdlVGhyZWUgPSBzdGFnZVRocmVlOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1pZ25pdGUuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvbWFpbicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L3V0aWwnLCAnLi9sb2cnLCAnLi9pbnN0YW5jZScsICcuL2lnbml0ZScsICcuL2NhcHN1bGUnLCAnZG9tUmVhZHknLCAnaGFzJywgJ3RocnVzdC9jb25maWcnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX191dGlsX18sIF9fbG9nX18sIF9fdGhydXN0SW5zdGFuY2VfXywgX19pZ25pdGVTcGVjX18sIF9fbV9fLCBfX2RvbVJlYWR5X18sIF9faGFzX18sIF9fdENvbmZpZ19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSJpbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIAogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBsb2cgPSBfX2xvZ19fOwoKICAgIHZhciB0aHJ1c3RJbnN0YW5jZSA9IF9fdGhydXN0SW5zdGFuY2VfXzsKCiAgICB2YXIgaWduaXRlU3BlYyA9IF9faWduaXRlU3BlY19fOwoKICAgIHZhciBtID0gX19tX187CgogICAgdmFyIE1vZHVsZSA9IG0uTW9kdWxlOwogICAgdmFyIGRvbVJlYWR5ID0gX19kb21SZWFkeV9fOwoKICAgIHZhciBoYXMgPSBfX2hhc19fOwoKICAgIHZhciB0Q29uZmlnID0gX190Q29uZmlnX187CgogICAgZXhwb3J0cy5jbGFzc05hbWUgPSAnVGhydXN0JzsKICAgIC8qKgogICAgVGhlIHRocnVzdCBhcHBsaWNhdGlvbiEKICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgIEBtYWluIHRocnVzdAogICAgKiovCiAgICAgICAgdmFyIElOSVQgPSAnaW5pdCcsIFNUQVJUID0gJ3N0YXJ0JywgUkVBRFkgPSAncmVhZHknLCBTVE9QID0gJ3N0b3AnLCBERVNUUk9ZID0gJ2Rlc3Ryb3knLCBDT1VOVERPV04gPSAnY291bnRkb3duJywgSUdOSVRFID0gJ2lnbml0ZScsIE9SQklUID0gJ29yYml0JywgREVQTE9ZID0gJ2RlcGxveScsIERFT1JCSVQgPSAnZGVvcmJpdCcsIFNQTEFTSERPV04gPSAnc3BsYXNoZG93bicsIElOT1JCSVQgPSAnaW5PcmJpdCcsIG1lbW9pemUgPSBfLm1lbW9pemUsIGVhY2ggPSBfLmVhY2gsIG1hcCA9IF8ubWFwLCBleHRlbmQgPSBfLmV4dGVuZCwgd2hlbiA9IHV0aWwud2hlbiwgYmluZCA9IF8uYmluZCwgaXNBcnJheSA9IF8uaXNBcnJheSwgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsIHRvQXJyYXkgPSBfLnRvQXJyYXksIG1lcmdlID0gXy5tZXJnZSwgZmxhdHRlbiA9IF8uZmxhdHRlbiwgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIHJlc29sdmVNZXRob2RzID0gWwogICAgICAgIElOSVQsIAogICAgICAgIFNUQVJULCAKICAgICAgICBSRUFEWSwgCiAgICAgICAgU1RPUCwgCiAgICAgICAgREVTVFJPWQogICAgXSwgaW5zdGFuY2VzID0gdGhydXN0SW5zdGFuY2UuaW5zdGFuY2VzLCBsb2FkaW5nSW5zdGFuY2VzID0gdGhydXN0SW5zdGFuY2UubG9hZGluZ0luc3RhbmNlcywgc2FmZUludm9rZSA9IHV0aWwuc2FmZUludm9rZTsKICAgIC8vI3JlZ2lvbiBSdW5uZXIgRmFjdG9yaWVzCiAgICB2YXIgcnVuUnVubmVyRmFjdG9yeSA9IG1lbW9pemUoZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICAgIHZhciBjb252ZW50aW9uTWV0aG9kID0gKG1ldGhvZCA9PT0gU1RPUCAmJiBTVEFSVCkgfHwgKG1ldGhvZCA9PT0gREVTVFJPWSAmJiBJTklUKSB8fCBtZXRob2QsIGNvbnZlbnRpb25WYWx1ZSA9ICEobWV0aG9kID09PSBTVE9QIHx8IG1ldGhvZCA9PT0gREVTVFJPWSksIHVuc2V0UmVhZHkgPSBtZXRob2QgPT09IFNUT1AsIGNvbnZlbnRpb25DaGVjayA9IGNvbnZlbnRpb25NZXRob2QgIT09IG1ldGhvZCwgY29udmVudGlvbk5hbWUgPSBmb3JtYXQoJ3swfS1zdGF0dXMnLCBjb252ZW50aW9uTWV0aG9kKSwgcnVubmVyID0gcnVubmVyRmFjdG9yeShtZXRob2QsIGNvbnZlbnRpb25OYW1lLCBjb252ZW50aW9uVmFsdWUsIHVuc2V0UmVhZHkpLCBsb2dNZXNzYWdlID0gZm9ybWF0KCdUaHJ1c3Q6IHswfWluZyBtb2R1bGUgInt7MH19IiBmYWlsZWQhJywgbWV0aG9kKSwgcnVubmluZ01lc3NhZ2UgPSBmb3JtYXQoJ1RocnVzdDogUnVubmluZyB7MH0gZm9yIG1vZHVsZSAie3swfX0iLicsIG1ldGhvZCk7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChuYW1lcykgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCFpc0FycmF5KG5hbWVzKSkgewogICAgICAgICAgICAgICAgbmFtZXMgPSBbCiAgICAgICAgICAgICAgICAgICAgbmFtZXMKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFyZ3MsIHJlc3VsdHMgPSBbXTsKICAgICAgICAgICAgZWFjaChuYW1lcywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgICAgIGZhbHNlICYmIGxvZy5kZWJ1Zyhmb3JtYXQocnVubmluZ01lc3NhZ2UsIG5hbWUpKTsKICAgICAgICAgICAgICAgIHZhciBtb2QgPSB0aGF0Lm1vZHVsZXNbbmFtZV07CiAgICAgICAgICAgICAgICBpZighbW9kICYmICF0aGF0LmZhaWxlZE1vZHVsZXNbbmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICAvLyB0cnkgdG8gZmV0Y2ggdGhlIG1vZHVsZS4KICAgICAgICAgICAgICAgICAgICAvLyByZXR1cm5pbmcgdGhlIHByb3BlciBkZWZlciBpbiBpdCdzIHBsYWNlCiAgICAgICAgICAgICAgICAgICAgdmFyIGxvYWRlckRlZmVyID0gd2hlbi5kZWZlcigpOwogICAgICAgICAgICAgICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAgICAgICAgICAgICBuYW1lCiAgICAgICAgICAgICAgICAgICAgXSwgZnVuY3Rpb24gKG1vZHVsZURlZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5jcmVhdGVNb2R1bGUobW9kdWxlRGVmbiAmJiBtb2R1bGVEZWZuLm5hbWUgfHwgbmFtZSwgbW9kdWxlRGVmbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBydW5SdW5uZXJGYWN0b3J5KG1ldGhvZCkuYXBwbHkodGhhdCwgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxlRGVmbi5uYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIF0uY29uY2F0KGFyZ3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2hlbi5jaGFpbih3aGVuLmFsbChmbGF0dGVuKHJlc3VsdCkpLCBsb2FkZXJEZWZlcik7CiAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmZhaWxlZE1vZHVsZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBsb2FkZXJEZWZlci5yZXNvbHZlKCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKGxvYWRlckRlZmVyLnByb21pc2UpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmKChjb252ZW50aW9uQ2hlY2sgJiYgbW9kLmNvbnZlbnRpb24oY29udmVudGlvbk5hbWUpKSB8fCAhbW9kLmNvbnZlbnRpb24oY29udmVudGlvbk5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoZmFsc2UgJiYgdENvbmZpZy50aHJvd0Vycm9ycykgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2gocnVubmVyKHRoYXQsIG5hbWUsIG1vZCwgYXJncykpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHJ1bm5lcih0aGF0LCBuYW1lLCBtb2QsIGFyZ3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmVycm9yKGZvcm1hdChsb2dNZXNzYWdlLCBuYW1lKSwgZSwgZS5zdGFjayk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0cy5sZW5ndGggJiYgcmVzdWx0czsKICAgICAgICB9OwogICAgfSk7CiAgICB2YXIgcnVubmVyRmFjdG9yeSA9IG1lbW9pemUoZnVuY3Rpb24gKG1ldGhvZCwgY29udmVudGlvbk5hbWUsIGNvbnZlbnRpb25WYWx1ZSwgdW5zZXRSZWFkeSkgewogICAgICAgIHZhciBldmVudE5hbWUgPSBmb3JtYXQoJ3RocnVzdC9tb2R1bGUvezB9JywgbWV0aG9kKSwgaW5mb0Zvcm1hdCA9IGZvcm1hdCgnVGhydXN0OiB7MH1pbmcgbW9kdWxlICJ7ezB9fSInLCBtZXRob2QuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBtZXRob2Quc3Vic3RyaW5nKDEpKSwgZGVidWdGb3JtYXQgPSBmb3JtYXQoJ1RocnVzdDogQ2FsbGluZyBtb2R1bGUgInt7MH19IiB7MH0oKScsIG1ldGhvZCksIGNvbXBBZnRlciA9IG1ldGhvZCA9PT0gU1RPUCB8fCBtZXRob2QgPT09IERFU1RST1kgfHwgZmFsc2U7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh0aGF0LCBuYW1lLCBtb2QsIGFyZ3MpIHsKICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmluZm8oZm9ybWF0KGluZm9Gb3JtYXQsIG5hbWUpKTsKICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdChjb252ZW50aW9uTmFtZSwgbmFtZSkpOwogICAgICAgICAgICByZXR1cm4gbW9kLnRocnVzdENhbGwobWV0aG9kLCBjb21wQWZ0ZXIsIF9fZ2V0TW9kdWxlQXJncyh0aGF0Lm5hbWUsIG5hbWUsIGFyZ3MpKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoYXQubWVkaWF0b3IgJiYgdGhhdC5tZWRpYXRvci5maXJlKGV2ZW50TmFtZSwgbmFtZSk7CiAgICAgICAgICAgICAgICBtb2QuY29udmVudGlvbihjb252ZW50aW9uTmFtZSwgY29udmVudGlvblZhbHVlKTsKICAgICAgICAgICAgICAgIGlmKHVuc2V0UmVhZHkpIHsKICAgICAgICAgICAgICAgICAgICBtb2QuY29udmVudGlvbihSRUFEWSArICctc3RhdHVzJywgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgfSk7CiAgICB2YXIgYWxsUnVubmVyRmFjdG9yeSA9IG1lbW9pemUoZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICAgIHZhciBpbmZvRm9ybWF0ID0gZm9ybWF0KCdUaHJ1c3Q6IHswfWluZyBhbGwgbW9kdWxlcy4uLiBbe3swfX1dJywgbWV0aG9kLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbWV0aG9kLnN1YnN0cmluZygxKSksIHBsdXJhbE5hbWUgPSBmb3JtYXQoJ3RocnVzdC9tb2R1bGUvYWxsL3swfScsIG1ldGhvZCksIGNoZWNrQXV0b1N0YXJ0ID0gbWV0aG9kID09PSBJTklUIHx8IG1ldGhvZCA9PT0gU1RBUlQgfHwgbWV0aG9kID09PSBSRUFEWTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHRoYXQpIHsKICAgICAgICAgICAgdGhhdC5tZWRpYXRvciAmJiB0aGF0Lm1lZGlhdG9yLmZpcmUocGx1cmFsTmFtZSk7CiAgICAgICAgICAgIHZhciBtb2R1bGVzID0gdGhhdC5tb2R1bGVzLCByZXN1bHRzID0gW107CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5pbmZvKGZvcm1hdChpbmZvRm9ybWF0LCBtYXAobW9kdWxlcywgZnVuY3Rpb24gKHgsIGkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB4LmNvbnZlbnRpb24oJ2F1dG9TdGFydCcpICYmIGk7CiAgICAgICAgICAgIH0pLmpvaW4oJywgJykpKTsKICAgICAgICAgICAgZWFjaChtb2R1bGVzLCBmdW5jdGlvbiAoeCwgaSkgewogICAgICAgICAgICAgICAgaWYoIWNoZWNrQXV0b1N0YXJ0IHx8IChjaGVja0F1dG9TdGFydCAmJiB4LmNvbnZlbnRpb24oJ2F1dG9TdGFydCcpKSkgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaCh0aGF0W21ldGhvZF0oaSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYodGhhdC5zdGFydGluZ01vZHVsZXMgJiYgY2hlY2tBdXRvU3RhcnQpIHsKICAgICAgICAgICAgICAgIGZhbHNlICYmIGxvZy5pbmZvKGZvcm1hdChpbmZvRm9ybWF0LCB0aGF0LnN0YXJ0aW5nTW9kdWxlcy5qb2luKCcsICcpKSk7CiAgICAgICAgICAgICAgICB0aGF0W21ldGhvZF0odGhhdC5zdGFydGluZ01vZHVsZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbChyZXN1bHRzKTsKICAgICAgICB9OwogICAgfSk7CiAgICBmdW5jdGlvbiBmaXJlVGhydXN0RXZlbnQodGhhdCwgZXZlbnQpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGF0Lm1lZGlhdG9yICYmIHRoYXQubWVkaWF0b3IuZmlyZShldmVudCk7CiAgICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIGNoaWxkcmVuQ2FsbE1ldGhvZCh0aGF0LCBtZXRob2QsIHN0b3BwaW5nKSB7CiAgICAgICAgdmFyIGl0ZW1zID0gW107CiAgICAgICAgZWFjaCh0aGF0LmNoaWxkcmVuLCBmdW5jdGlvbiAoY2hpbGQpIHsKICAgICAgICAgICAgaWYoc3RvcHBpbmcpIHsKICAgICAgICAgICAgICAgIGNoaWxkLl9fcHJldmlvdXNTdGF0ZSA9IGNoaWxkLnN0YXJ0ZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoY2hpbGQuY2ZnLmF1dG9TdGFydCB8fCAoIXN0b3BwaW5nICYmIGNoaWxkLl9fcHJldmlvdXNTdGF0ZSkgfHwgKHN0b3BwaW5nICYmIGNoaWxkLnN0YXJ0ZWQpKSB7CiAgICAgICAgICAgICAgICBpdGVtcy5wdXNoKGNoaWxkW21ldGhvZF0oZmFsc2UsIHRydWUpKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGlmKGl0ZW1zLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gd2hlbi5hbGwoaXRlbXMpOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGZsYXR0ZW5XaXRoQXN5bmModGhhdCwgYXJyKSB7CiAgICAgICAgcmV0dXJuIHV0aWwuZmxhdHRlblRvUHJvbWlzZXMoYXJyLmNvbmNhdCh0aGF0LmNmZy5hc3luYyAmJiBbCiAgICAgICAgICAgIHdoZW4uZGVsYXkoMCkKICAgICAgICBdIHx8IFtdKSk7CiAgICB9CiAgICB2YXIgdGhydXN0TG9nRXZlbnQ7CiAgICBpZihmYWxzZSkgewogICAgICAgIHRocnVzdExvZ0V2ZW50ID0gZnVuY3Rpb24gKG1lc3NhZ2UsIG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGxvZy5kZWJ1Zyhmb3JtYXQuYXBwbHkoZm9ybWF0LCBbCiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZQogICAgICAgICAgICAgICAgXS5jb25jYXQodG9BcnJheShhcmd1bWVudHMpKSkpOwogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICB9IGVsc2UgewogICAgICAgIHRocnVzdExvZ0V2ZW50ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdXRpbC5ub29wOwogICAgICAgIH07CiAgICB9CiAgICB2YXIgdGhydXN0U2hvdWxkRXhlY3V0ZSA9IGZ1bmN0aW9uICh0aGF0LCBjYWxsZWRCeVBhcmVudCwgc3RvcHBpbmcpIHsKICAgICAgICBpZih0aGF0LnBhcmVudCAmJiB0aGF0LmNmZy5jaGlsZEluc3RhbmNlICYmICF0aGF0LnBhcmVudC5zdGFydGVkICYmICFjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICBsb2cud2Fybihmb3JtYXQoJ0Nhbm5vdCBleGVjdXRlIG9uIGNoaWxkIGluc3RhbmNlICJ7MH0iIHBhcmVudCBpbnN0YW5jZSAiezF9IiBtdXN0IGJlIHN0YXJ0ZWQgZmlyc3QuJywgdGhhdC5uYW1lLCB0aGF0LnBhcmVudC5uYW1lKSk7CiAgICAgICAgfQogICAgICAgIGlmKCFzdG9wcGluZyAmJiB0aGF0LnN0YXJ0ZWQgfHwgc3RvcHBpbmcgJiYgIXRoYXQuc3RhcnRlZCkgewogICAgICAgICAgICBsb2cud2Fybihmb3JtYXQoJ0Nhbm5vdCBzdGFydCB0aHJ1c3QgaW5zdGFuY2UgInswfSIgc2luY2UgaXQgYWxyZWFkeSBzdGFydGVkJywgdGhhdC5uYW1lKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgfTsKICAgIC8qKgogICAgR2V0cyB0aGUgbW9kdWxlcyBhcmd1bWVudHMgZnJvbSB0aGUgcmVnaXN0cmF0aW9ucy4KICAgIAogICAgSWYgb3JpZ2luYWwgYXJncyBjb250YWlucyBhbnl0aGluZyBpdCBpcyBwYXNzZWQgaW5zdGVhZCBvZiB0aGUgcmVnaXN0cmF0aW9ucy4KICAgIElmIHRoZSByZWdpc3RyYXRpb25zIGFyZSBpbiBwbGFjZSBpdCB3aWxsIHJldHVybiB0aGVtLgogICAgCiAgICBAbWV0aG9kIF9fZ2V0TW9kdWxlQXJncwogICAgQHN0YXRpYwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZU5hbWUgVGhlIHRocnVzdCBpbnN0YW5jZQogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG1vZHVsZSBuYW1lCiAgICBAcGFyYW0ge0FycmF5fSBvcmlnaW5hbEFyZ3MgVGhlIG9yaWdpbmFsIGFyZ3VtZW50cyBwYXNzZWQgaW50byB0aGUgY2FsbGluZyBtZXRob2QuCiAgICAqKi8KICAgIGZ1bmN0aW9uIF9fZ2V0TW9kdWxlQXJncyhpbnN0YW5jZU5hbWUsIG5hbWUsIG9yaWdpbmFsQXJncykgewogICAgICAgIHZhciBhcmdzID0gdG9BcnJheShvcmlnaW5hbEFyZ3MpOwogICAgICAgIGlmKGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiBhcmdzOwogICAgICAgIH0KICAgICAgICB2YXIgaW5zdGFuY2VSZWdpc3RyYXRpb25zID0gVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9uc1tpbnN0YW5jZU5hbWVdOwogICAgICAgIGlmKGluc3RhbmNlUmVnaXN0cmF0aW9ucyAmJiBpbnN0YW5jZVJlZ2lzdHJhdGlvbnNbbmFtZV0pIHsKICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlUmVnaXN0cmF0aW9uc1tuYW1lXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFyZ3M7CiAgICB9CiAgICAvLyNlbmRyZWdpb24KICAgIC8qKgogICAgVGhlIHByaW1hcnkgdGhydXN0IGNsYXNzLgogICAgCiAgICBAY2xhc3MgdGhydXN0LlRocnVzdAogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGlzIHRocnVzdCBpbnN0YW5jZQogICAgQHJldHVybnMge1RocnVzdH0KICAgICoqLwogICAgdmFyIFRocnVzdCA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gVGhydXN0KG5hbWUpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbnZlbnRpb25zID0gW107CiAgICAgICAgICAgIHRoaXMuX19jb252ZW50aW9uUGx1Y2tQcm9wZXJ0aWVzQ2FjaGUgPSBudWxsOwogICAgICAgICAgICB0aGlzLl9fdGhydXN0Q29udmVudGlvbnMgPSBbXTsKICAgICAgICAgICAgdGhpcy5jZmcgPSBtZXJnZSh0Q29uZmlnLCB7CiAgICAgICAgICAgICAgICBhdXRvU3RhcnQ6IGZhbHNlLAogICAgICAgICAgICAgICAgYXN5bmM6IGZhbHNlLAogICAgICAgICAgICAgICAgY2hpbGRJbnN0YW5jZTogZmFsc2UsCiAgICAgICAgICAgICAgICBhdXRvbWF0aWNMaWZlY3ljbGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuY29uZmlnID0gbWVyZ2UodENvbmZpZywgewogICAgICAgICAgICAgICAgYXV0b1N0YXJ0OiBmYWxzZSwKICAgICAgICAgICAgICAgIGFzeW5jOiBmYWxzZSwKICAgICAgICAgICAgICAgIGNoaWxkSW5zdGFuY2U6IGZhbHNlLAogICAgICAgICAgICAgICAgYXV0b21hdGljTGlmZWN5Y2xlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgICAgICB0aGlzLm1vZHVsZXMgPSB7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuZmFpbGVkTW9kdWxlcyA9IHsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5jaGlsZHJlbiA9IFtdOwogICAgICAgICAgICB0aGlzLnN0YXJ0ZWQgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9ucyA9IHsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuY3JlYXRlID0gLyoqCiAgICAgICAgQ3JlYXRlcyBhIG5ldyB0aHJ1c3QgbW9kdWxlLgogICAgICAgIAogICAgICAgIEBtZXRob2QgY3JlYXRlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHVuaXF1ZSBtb2R1bGUgbmFtZS4KICAgICAgICBAcGFyYW0ge09iamVjdH0gbW9kdWxlIFRoZSBtb2R1bGUgZGVmaW50aW9uLgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gcHJlQnVpbGQgSGFzIHRoaXMgbW9kdWxlIGJlZW4gcHJlYnVpbHQsIGluIG90aGVyIHdvcmRzIGhhcyBpdCBiZWVuIGNyZWF0ZWQsIGJ5IHdpcmUuanMgYW5kIG5lZWRzIHRvIGJlIGluamVjdGVkLgogICAgICAgIEByZXR1cm5zIHtNb2R1bGV9IFRoZSBuZXcgbW9kdWxlIGluc3RhbmNlLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lLCBtb2QsIHByZUJ1aWx0KSB7CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ1RocnVzdDogQ3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mICJ7MH0iJywgbmFtZSkpOwogICAgICAgICAgICB2YXIgb2xkTW9kdWxlLCB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYocHJlQnVpbHQpIHsKICAgICAgICAgICAgICAgIG9sZE1vZHVsZSA9IG1vZDsKICAgICAgICAgICAgICAgIG1vZCA9IG1vZC5pbnN0YW5jZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighcHJlQnVpbHQpIHsKICAgICAgICAgICAgICAgIG1vZCA9IG5ldyBtLk1vZHVsZSh0aGF0LCBtb2QsIG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbW9kID0gb2xkTW9kdWxlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE1vZHVsZXMgY2Fubm90IGhhdmUgZHVwbGljYXRlIG5hbWVzLCBjaG9vc2UgYSBuZXcgb25lLgogICAgICAgICAgICBpZih0aGF0Lm1vZHVsZXNbbW9kLm5hbWVdKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdEdXBsaWNhdGUgbW9kdWxlIG5hbWUgInswfSIuJywgbmFtZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIG0gaXMgdGhlIG1lZGlhdG9ycyBpbnRlcm5hbCBtb2R1bGUuCiAgICAgICAgICAgIHRoYXQubW9kdWxlc1ttb2QubmFtZV0gPSBtb2Q7CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5pbmZvKGZvcm1hdCgnVGhydXN0OiBDcmVhdGVkIG1vZHVsZSAiezB9IicsIG5hbWUpKTsKICAgICAgICAgICAgLy8gTm90aWZ5IHRoZSBtZWRpYXRvciB0aGF0IGEgbW9kdWxlIGhhcyBiZWVuIGNyZWF0ZWQuCiAgICAgICAgICAgIHRoYXQubWVkaWF0b3IuZmlyZSgndGhydXN0L21vZHVsZS9jcmVhdGUnLCBuYW1lKTsKICAgICAgICAgICAgaWYodGhhdCAmJiB0aGF0LnN0YXJ0ZWQgJiYgbW9kLmNvbnZlbnRpb24oJ2F1dG9TdGFydCcpKSB7CiAgICAgICAgICAgICAgICB0aGF0LnN0YXJ0KG1vZC5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbW9kOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5zdGFydHVwID0gLy8jcmVnaW9uIEdsb2JhbCBSdW5uZXJzCiAgICAgICAgZnVuY3Rpb24gKGV2ZW50LCBldmVudFR5cGUpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHdoZW4uYWxsKGZsYXR0ZW5XaXRoQXN5bmModGhhdCwgWwogICAgICAgICAgICAgICAgc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIGV2ZW50LCB0aGF0KSwgCiAgICAgICAgICAgICAgICB0aGF0W2V2ZW50VHlwZV0oKSwgCiAgICAgICAgICAgICAgICBjaGlsZHJlbkNhbGxNZXRob2QodGhhdCwgZXZlbnQpCiAgICAgICAgICAgIF0pKTsKICAgICAgICAgICAgd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgcHJvbWlzZQogICAgICAgICAgICBdKS50aGVuKGZpcmVUaHJ1c3RFdmVudCh0aGF0LCAndGhydXN0LycgKyBldmVudFR5cGUpKTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLl9jb3VudGRvd24gPSBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmYWxzZSAmJiB0aHJ1c3RMb2dFdmVudCgnTGF1bmNoIGluc3RhbmNlICJ7MH0iIGluIDUuLi4gNC4uLiAzLi4uIDIuLi4gMS4uLicsIHRoYXQubmFtZSk7CiAgICAgICAgICAgIHZhciBwcm9taXNlID0gdGhpcy5zdGFydHVwKENPVU5URE9XTiwgSU5JVCk7CiAgICAgICAgICAgIGZhbHNlICYmIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbih0aHJ1c3RMb2dFdmVudCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGhhcyBiZWVuIGluaXRhbGl6ZWQuJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5jb3VudGRvd24gPSAvKioKICAgICAgICBCZWdpbnMgdGhlIGNvdW50ZG93biB0byB0aHJ1c3RzIHN0YXJ0LgogICAgICAgIExvYWRpbmcgY2FuIGJlIGRlZmVycmVkIGJ5IHJldHVybmluZyBhIHByb21pc2UgZnJvbSBhbnkgY29udmVudGlvbiwgb3IgbW9kdWxlIG1ldGhvZC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGNvdW50ZG93bgogICAgICAgIEBhc3luYwogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBvZiB3aGVuIHRoZSBjb3VudGRvd24gaXMgY29tcGxldGVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCF0aHJ1c3RTaG91bGRFeGVjdXRlKHRoYXQsIGNhbGxlZEJ5UGFyZW50KSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoYXQuY2ZnLmF1dG9tYXRpY0xpZmVjeWNsZSAmJiAoIXRoYXQuY2ZnLmNoaWxkSW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gVGhydXN0LmxhdW5jaFNlcXVlbmNlKHRoYXQsIGNhbGxlZEJ5UGFyZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhhdC5fY291bnRkb3duKGNhbGxlZEJ5UGFyZW50KTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuaWduaXRlID0gLyoqCiAgICAgICAgQmVnaW5zIHRoZSBpbmdpdGlvbiBhcyB0aHJ1c3Qgc3RhcnRzIHVwLgogICAgICAgIExvYWRpbmcgY2FuIGJlIGRlZmVycmVkIGJ5IHJldHVybmluZyBhIHByb21pc2UgZnJvbSBhbnkgY29udmVudGlvbiwgb3IgbW9kdWxlIG1ldGhvZC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGlnbml0ZQogICAgICAgIEBhc3luYwogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBvZiB3aGVuIHRoZSBpbmdpdGlvbiBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYoIXRocnVzdFNob3VsZEV4ZWN1dGUodGhhdCwgY2FsbGVkQnlQYXJlbnQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmFsc2UgJiYgdGhydXN0TG9nRXZlbnQoJ0ZpcmluZyByb2NrZXRzIGZvciB0aHVyc3QgaW5zdGFuY2UgInswfSIuJywgdGhhdC5uYW1lKTsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB0aGlzLnN0YXJ0dXAoSUdOSVRFLCBTVEFSVCk7CiAgICAgICAgICAgIGZhbHNlICYmIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbih0aHJ1c3RMb2dFdmVudCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGhhcyBiZWVuIHN0YXJ0ZWQuJywgdGhhdC5uYW1lKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5vcmJpdCA9IC8qKgogICAgICAgIFRocnVzdCBwcmVwYXJlcyBmb3Igb3JiaXQuCiAgICAgICAgTG9hZGluZyBjYW4gYmUgZGVmZXJyZWQgYnkgcmV0dXJuaW5nIGEgcHJvbWlzZSBmcm9tIGFueSBjb252ZW50aW9uLgogICAgICAgIAogICAgICAgIEBtZXRob2Qgb3JiaXQKICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aHJ1c3QgaXMgaW4gb3JiaXQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYoIXRocnVzdFNob3VsZEV4ZWN1dGUodGhhdCwgY2FsbGVkQnlQYXJlbnQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmFsc2UgJiYgdGhydXN0TG9nRXZlbnQoJ0ZpcmluZyBzdGFnZSB0d28gdGhydXN0ZXJzIGZvciB0aHJ1c3QgaW5zdGFuY2UgInswfSIuJywgdGhhdC5uYW1lKSgpOwogICAgICAgICAgICB2YXIgZG9tUmVhZHlEZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgZG9tUmVhZHlEZWZlci5wcm9taXNlLnRoZW4oZmlyZVRocnVzdEV2ZW50KHRoYXQsICd0aHJ1c3QvZG9tL3JlYWR5JykpOwogICAgICAgICAgICBkb21SZWFkeShkb21SZWFkeURlZmVyLnJlc29sdmUpOwogICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHdoZW4uYWxsKGZsYXR0ZW5XaXRoQXN5bmModGhhdCwgWwogICAgICAgICAgICAgICAgZG9tUmVhZHlEZWZlci5wcm9taXNlLCAKICAgICAgICAgICAgICAgIHNhZmVJbnZva2UodGhhdC5fX2NvbnZlbnRpb25zLCBPUkJJVCwgdGhhdCksIAogICAgICAgICAgICAgICAgY2hpbGRyZW5DYWxsTWV0aG9kKHRoYXQsIE9SQklUKQogICAgICAgICAgICBdKSk7CiAgICAgICAgICAgIGZhbHNlICYmIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbih0aHJ1c3RMb2dFdmVudCgnVGhydXN0IGluc3RhbmNlICJ7MH0iIGlzIGFsbW9zdCByZWFkeS4nLCB0aGF0Lm5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLmRlcGxveSA9IC8qKgogICAgICAgIFRocnVzdCBkZXBsb3lzIGNvbXBvbmVudHMgaW4gb3JiaXQKICAgICAgICBMb2FkaW5nIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IG1vZHVsZSBtZXRob2QuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBkZXBsb3kKICAgICAgICBAYXN5bmMKICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2Ugb2Ygd2hlbiB0aHJ1c3QgaGFzIGZ1bGx5IGRlcGxveWVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCF0aHJ1c3RTaG91bGRFeGVjdXRlKHRoYXQsIGNhbGxlZEJ5UGFyZW50KSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGZhbHNlKSB7CiAgICAgICAgICAgICAgICB2YXIgdGltZVN0YXJ0ID0gdGhhdC5jb25maWcuZGVidWcudGltZVN0YXJ0LCB0aW1lRW5kID0gbmV3IERhdGUoKS5nZXRUaW1lKCksIHN0YXJ0VGltZSA9ICh0aW1lRW5kIC0gdGltZVN0YXJ0KSwgdHRvRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3R0bycpOwogICAgICAgICAgICAgICAgaWYodHRvRGl2KSB7CiAgICAgICAgICAgICAgICAgICAgdHRvRGl2LmlubmVySFRNTCA9IHN0YXJ0VGltZSArICdtcyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByb21pc2UgPSB3aGVuLmFsbChmbGF0dGVuV2l0aEFzeW5jKHRoYXQsIFsKICAgICAgICAgICAgICAgIHRoYXQucmVhZHkoKSwgCiAgICAgICAgICAgICAgICBjaGlsZHJlbkNhbGxNZXRob2QodGhhdCwgREVQTE9ZKQogICAgICAgICAgICBdKSkudGhlbihmaXJlVGhydXN0RXZlbnQodGhhdCwgJ3RocnVzdC9yZWFkeScpKTsKICAgICAgICAgICAgZmFsc2UgJiYgd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgcHJvbWlzZQogICAgICAgICAgICBdKS50aGVuKHRocnVzdExvZ0V2ZW50KCdUaHJ1c3QgaW5zdGFuY2UgInswfSIgaXMgbm93IHJlYWR5LicsIHRoYXQubmFtZSkpOwogICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuaW5PcmJpdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB0aGF0LnN0YXJ0ZWQgPSB0cnVlOwogICAgICAgICAgICBjaGlsZHJlbkNhbGxNZXRob2QodGhhdCwgSU5PUkJJVCk7CiAgICAgICAgICAgIGlmKGZhbHNlKSB7CiAgICAgICAgICAgICAgICB2YXIgdGltZVN0YXJ0ID0gdGhhdC5jb25maWcuZGVidWcudGltZVN0YXJ0LCB0aW1lRW5kID0gbmV3IERhdGUoKS5nZXRUaW1lKCksIHN0YXJ0VGltZSA9ICh0aW1lRW5kIC0gdGltZVN0YXJ0KTsKICAgICAgICAgICAgICAgIGxvZy5pbmZvKCdTdGFydGVkIGluICcgKyBzdGFydFRpbWUgKyAnbXMnKTsKICAgICAgICAgICAgICAgIHZhciB0dHJEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndHRyJyk7CiAgICAgICAgICAgICAgICBpZih0dHJEaXYpIHsKICAgICAgICAgICAgICAgICAgICB0dHJEaXYuaW5uZXJIVE1MID0gc3RhcnRUaW1lICsgJ21zJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5zaHV0ZG93biA9IGZ1bmN0aW9uIChldmVudCwgZXZlbnRUeXBlKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB3aGVuLmFsbChmbGF0dGVuV2l0aEFzeW5jKHRoYXQsIFsKICAgICAgICAgICAgICAgIGNoaWxkcmVuQ2FsbE1ldGhvZCh0aGF0LCBldmVudCwgdHJ1ZSksIAogICAgICAgICAgICAgICAgdGhhdFtldmVudFR5cGVdKCksIAogICAgICAgICAgICAgICAgc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIGV2ZW50LCB0aGF0KQogICAgICAgICAgICBdKSk7CiAgICAgICAgICAgIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgIHByb21pc2UKICAgICAgICAgICAgXSkudGhlbihmaXJlVGhydXN0RXZlbnQodGhhdCwgJ3RocnVzdC8nICsgZXZlbnRUeXBlKSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5fZGVvcmJpdCA9IGZ1bmN0aW9uIChjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGlmKCF0aHJ1c3RTaG91bGRFeGVjdXRlKHRoYXQsIGNhbGxlZEJ5UGFyZW50LCB0cnVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZhbHNlICYmIHRocnVzdExvZ0V2ZW50KCdSZWVudGVyaW5nIGVhcnRocyBhdG1vc3BoZXJlIGZvciB0aHJ1c3QgaW5zdGFuY2UgInswfSIuJywgdGhhdC5uYW1lKTsKICAgICAgICAgICAgdmFyIHByb21pc2UgPSB0aGlzLnNodXRkb3duKERFT1JCSVQsIFNUT1ApOwogICAgICAgICAgICBmYWxzZSAmJiB3aGVuLmFueShbCiAgICAgICAgICAgICAgICBwcm9taXNlCiAgICAgICAgICAgIF0pLnRoZW4odGhydXN0TG9nRXZlbnQoJ1RocnVzdCBpbnN0YW5jZSAiezB9IiBpcyBub3cgc3RvcHBlZC4nLCB0aGF0Lm5hbWUpKTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLmRlb3JiaXQgPSAvKioKICAgICAgICBCZWdpbnMgdGhlIGRlb3JiaXQgYXMgdGhydXN0IHNodXRkb3duLgogICAgICAgIFNodXRkb3duIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24sIG9yIG1vZHVsZSBtZXRob2QuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBkZW9yYml0CiAgICAgICAgQGFzeW5jCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIG9mIHdoZW4gdGhlIGluZ2l0aW9uIGlzIGNvbXBsZXRlZC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCwgdHJ1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aGF0LmNmZy5hdXRvbWF0aWNMaWZlY3ljbGUgJiYgKCF0aGF0LmNmZy5jaGlsZEluc3RhbmNlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4uc2VxdWVuY2UoWwogICAgICAgICAgICAgICAgICAgIF8uYmluZCh0aGF0Ll9kZW9yYml0LCB0aGF0KSwgCiAgICAgICAgICAgICAgICAgICAgXy5iaW5kKHRoYXQuc3BsYXNoZG93biwgdGhhdCkKICAgICAgICAgICAgICAgIF0sIGNhbGxlZEJ5UGFyZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhhdC5fZGVvcmJpdChjYWxsZWRCeVBhcmVudCk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLnNwbGFzaGRvd24gPSAvKioKICAgICAgICBCZWdpbnMgdGhlIHNwbGFzaGRvd24gYXMgdGhydXN0IHNodXRkb3duLgogICAgICAgIFNodXRkb3duIGNhbiBiZSBkZWZlcnJlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGZyb20gYW55IGNvbnZlbnRpb24sIG9yIG1vZHVsZSBtZXRob2QuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBzcGxhc2hkb3duCiAgICAgICAgQGFzeW5jCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIG9mIHdoZW4gdGhlIGluZ2l0aW9uIGlzIGNvbXBsZXRlZC4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAoY2FsbGVkQnlQYXJlbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighdGhydXN0U2hvdWxkRXhlY3V0ZSh0aGF0LCBjYWxsZWRCeVBhcmVudCwgdHJ1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmYWxzZSAmJiB0aHJ1c3RMb2dFdmVudCgnTGFuZGluZyBpbiB0aGUgbWlkZGxlIG9mIHRoZSBhdGxhbnRpYyBmb3IgdGhydXN0IGluc3RhbmNlICJ7MH0iLicsIHRoYXQubmFtZSk7CiAgICAgICAgICAgIHZhciBwcm9taXNlID0gdGhpcy5zaHV0ZG93bihTUExBU0hET1dOLCBERVNUUk9ZKTsKICAgICAgICAgICAgZmFsc2UgJiYgd2hlbi5hbnkoWwogICAgICAgICAgICAgICAgcHJvbWlzZQogICAgICAgICAgICBdKS50aGVuKHRocnVzdExvZ0V2ZW50KCdUaHJ1c3QgaW5zdGFuY2UgInswfSIgaXMgbm93IGJlaW5nIGRlc3Ryb3llZCcsIHRoYXQubmFtZSkpOwogICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhhdC5zdGFydGVkID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUubW9kdWxlTWV0aG9kID0gZnVuY3Rpb24gKG1ldGhvZCwgbmFtZSwgYXJncywgcmV2ZXJzZSwgZGVwZW5kZW50TWV0aG9kcywgc3RhcnRlZE1ldGhvZHMpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBwaXBlID0gW107CiAgICAgICAgICAgIGlmKCFuYW1lKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gYWxsUnVubmVyRmFjdG9yeShtZXRob2QpKHRoYXQpOwogICAgICAgICAgICAgICAgaWYocmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmFtZXMgPSBbXTsKICAgICAgICAgICAgaWYoIWlzQXJyYXkobmFtZSkpIHsKICAgICAgICAgICAgICAgIG5hbWVzID0gWwogICAgICAgICAgICAgICAgICAgIG5hbWUKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuYW1lcyA9IChuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihkZXBlbmRlbnRNZXRob2RzICYmIGRlcGVuZGVudE1ldGhvZHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB2YXIgaXRlbXMgPSB7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IG5hbWVzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBuID0gbmFtZXNbaV0sIG1vZCA9IHRoYXQubW9kdWxlc1tuXTsKICAgICAgICAgICAgICAgICAgICBlYWNoKGRlcGVuZGVudE1ldGhvZHMsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFpdGVtc1t4XSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNbeF0gPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZighcmV2ZXJzZSAmJiAoIW1vZCB8fCAhbW9kLmNvbnZlbnRpb24oeCArICctc3RhdHVzJykpIHx8IChyZXZlcnNlICYmIG1vZC5jb252ZW50aW9uKHggKyAnLXN0YXR1cycpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNbeF0ucHVzaChuKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWFjaChkZXBlbmRlbnRNZXRob2RzLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgIGlmKGl0ZW1zW3hdICYmIGl0ZW1zW3hdLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBwaXBlLnB1c2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGZsYXR0ZW4odGhhdFt4XS5hcHBseSh0aGF0LCBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNbeF0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0uY29uY2F0KGFyZ3MpKSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwaXBlLnB1c2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHdoZW4uYWxsKGZsYXR0ZW4ocnVuUnVubmVyRmFjdG9yeShtZXRob2QpLmFwcGx5KHRoYXQsIFsKICAgICAgICAgICAgICAgICAgICBuYW1lcwogICAgICAgICAgICAgICAgXS5jb25jYXQoYXJncykpKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZih0aGF0LnN0YXJ0ZWQgJiYgc3RhcnRlZE1ldGhvZHMgJiYgc3RhcnRlZE1ldGhvZHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBlYWNoKHN0YXJ0ZWRNZXRob2RzLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgIHBpcGUucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbChmbGF0dGVuKHRoYXRbeF0uYXBwbHkodGhhdCwgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZXMKICAgICAgICAgICAgICAgICAgICAgICAgXS5jb25jYXQoYXJncykpKSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gd2hlbi5waXBlbGluZShwaXBlKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDEpOyBfaSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgcmV0dXJuIHRoYXQubW9kdWxlTWV0aG9kKElOSVQsIG5hbWUsIGFyZ3MsIGZhbHNlKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiB0aGF0Lm1vZHVsZU1ldGhvZChTVEFSVCwgbmFtZSwgYXJncywgZmFsc2UsIFsKICAgICAgICAgICAgICAgIElOSVQKICAgICAgICAgICAgXSwgWwogICAgICAgICAgICAgICAgUkVBRFkKICAgICAgICAgICAgXSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLnJlYWR5ID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gdGhhdC5tb2R1bGVNZXRob2QoUkVBRFksIG5hbWUsIGFyZ3MsIGZhbHNlLCBbCiAgICAgICAgICAgICAgICBJTklULCAKICAgICAgICAgICAgICAgIFNUQVJUCiAgICAgICAgICAgIF0pOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5zdG9wID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gdGhhdC5tb2R1bGVNZXRob2QoU1RPUCwgbmFtZSwgYXJncywgdHJ1ZSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIG1ldGhvZCA9IERFU1RST1k7CiAgICAgICAgICAgIHJldHVybiB0aGF0Lm1vZHVsZU1ldGhvZChERVNUUk9ZLCBuYW1lLCBhcmdzLCB0cnVlLCBbCiAgICAgICAgICAgICAgICBTVE9QCiAgICAgICAgICAgIF0pOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5fX2luamVjdE1vZHVsZSA9IC8vI2VuZHJlZ2lvbgogICAgICAgIC8qKgogICAgICAgIEluamVjdHMgYSBwcmVjb25zdHJ1Y3RlZCBtb2R1bGUgaW50byB0aGUgdGhydXN0IGluc3RhbmNlLgogICAgICAgIAogICAgICAgIEBtZXRob2QgX19pbmplY3RNb2R1bGUKICAgICAgICBAcHJpdmF0ZQogICAgICAgIEBwYXJhbSB7TW9kdWxlfSBtb2R1bGUgVGhlIG1vZHVsZSB0byBpbmplY3QuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG1vZHVsZSkgewogICAgICAgICAgICB0aGlzLmNyZWF0ZShtb2R1bGUubmFtZSwgbW9kdWxlLCB0cnVlKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5wcm90b3R5cGUuY3JlYXRlTW9kdWxlID0gLyoqCiAgICAgICAgQ3JlYXRlcyBhIG1vZHVsZSBmcm9tIHRoZSBnaXZlbiBkZWZpbml0aW9uIG9iamVjdCwgd2l0aCB0aGUgZ2l2ZW4gbmFtZS4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGNyZWF0ZU1vZHVsZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBtb2R1bGUgbmFtZQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBtb2R1bGVEZWZuIFRoZSBtb2R1bGUgZGVmaW5pdGlvbgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lLCBtb2R1bGVEZWZuKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYodGhhdC5tb2R1bGVzW25hbWVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC5tb2R1bGVzW25hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBtb2R1bGUgPSBuZXcgTW9kdWxlKHRoYXQsIG1vZHVsZURlZm4sIG5hbWUpOwogICAgICAgICAgICB0aGF0Ll9faW5qZWN0TW9kdWxlKG1vZHVsZSk7CiAgICAgICAgICAgIHJldHVybiBtb2R1bGU7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QucHJvdG90eXBlLnNwYXduID0gLyoqCiAgICAgICAgTGF1bmNoZXMgYW5vdGhlciBjaGlsZCBtb2R1bGUgZm9yIHRocnVzdC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHNwYXduCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgb25jZSB0aGUgY2hpbGQgaW5zdGFuY2UgaGFzIGZ1bGx5IGxvYWRlZC4gIFJlc29sdmVzIHdpdGggdGhlIGNvbnRleHQgdGhhdCBjb250YWlucyB0aGUgdGhydXN0IGluc3RhbmNlIGFuZCBhbGwgcGx1Z2lucyB0aGF0IHdlcmUgbG9hZGVkLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChzZXR0aW5ncykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiBUaHJ1c3QubGF1bmNoKGV4dGVuZCh7CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGNoaWxkSW5zdGFuY2U6IHRydWUKICAgICAgICAgICAgfSwgc2V0dGluZ3MpLCB0cnVlKS50aGVuKGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgICAgICB2YXIgdGhydXN0ID0gY29udGV4dC50aHJ1c3Q7CiAgICAgICAgICAgICAgICB0aGF0LmNoaWxkcmVuLnB1c2godGhydXN0KTsKICAgICAgICAgICAgICAgIHRocnVzdC5wYXJlbnQgPSB0aGF0OwogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQ7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LnByb3RvdHlwZS5yZWdpc3Rlck1vZHVsZSA9IC8qKgogICAgICAgIFJlZ2lzdGVycyBhIHNwZWNpZmljIG1vZHVsZSBuYW1lLCBhbmQgYXJndW1lbnRzLiAgVGhlIGFyZ3VtZW50cyB3aWxsIGJlIHVzZWQgd2hlbiBpbml0YW50aWF0aW5nIHRoZSBtb2R1bGUuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCByZWdpc3Rlck1vZHVsZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBtb2R1bGUgbmFtZSB0byBhc3NpZ24gdGhlIGFyZ3VtZW50cyB3aXRoLgogICAgICAgIEBwYXJhbSB7T2JqZWN0Kn0gYXJndW1lbnRzLCBhZGRpdGlvbmFsIGFyZ3VtZW50cyB0aGF0IHdpbGwgYmUgcGFzc2VkIG9udG8gdGhlIG1vdWRsZQogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgVGhydXN0LnJlZ2lzdGVyTW9kdWxlLmFwcGx5KFRocnVzdCwgWwogICAgICAgICAgICAgICAgdGhhdC5uYW1lCiAgICAgICAgICAgIF0uY29uY2F0KHRvQXJyYXkoYXJndW1lbnRzKSkpOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LmxhdW5jaFNlcXVlbmNlID0gZnVuY3Rpb24gbGF1bmNoU2VxdWVuY2UoaW5zdGFuY2UsIGNhbGxlZEJ5UGFyZW50KSB7CiAgICAgICAgICAgIHJldHVybiB3aGVuLnNlcXVlbmNlKFsKICAgICAgICAgICAgICAgIF8uYmluZChpbnN0YW5jZS5fY291bnRkb3duLCBpbnN0YW5jZSksIAogICAgICAgICAgICAgICAgXy5iaW5kKGluc3RhbmNlLmlnbml0ZSwgaW5zdGFuY2UpLCAKICAgICAgICAgICAgICAgIF8uYmluZChpbnN0YW5jZS5vcmJpdCwgaW5zdGFuY2UpLCAKICAgICAgICAgICAgICAgIF8uYmluZChpbnN0YW5jZS5kZXBsb3ksIGluc3RhbmNlKSwgCiAgICAgICAgICAgICAgICBfLmJpbmQoaW5zdGFuY2UuaW5PcmJpdCwgaW5zdGFuY2UpCiAgICAgICAgICAgIF0sIGNhbGxlZEJ5UGFyZW50KTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5sYXVuY2ggPSAvKioKICAgICAgICBJbml0YWxpemVzIGEgbmV3IFRocnVzdCBpbnN0YW5jZSBiYXNlZCBvbiB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBsYXVuY2gKICAgICAgICBAc3RhdGljCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBtb2R1bGUgdG8gaW5qZWN0CiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gbGF1bmNoKHNldHRpbmdzLCBjYWxsZWRCeVBhcmVudCkgewogICAgICAgICAgICBpZighc2V0dGluZ3MpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gewogICAgICAgICAgICAgICAgICAgIG5hbWU6ICdnbG9iYWwnCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFzZXR0aW5ncy5uYW1lKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncy5uYW1lID0gJ2dsb2JhbCc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoZmFsc2UpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzLmRlYnVnID0gewogICAgICAgICAgICAgICAgICAgIHRpbWVTdGFydDogbmV3IERhdGUoKS5nZXRUaW1lKCkKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0dGluZ3MgPSBpZ25pdGVTcGVjLm1lcmdlU2V0dGluZ3Moc2V0dGluZ3MpOwogICAgICAgICAgICB2YXIgcGlwZSA9IFsKICAgICAgICAgICAgICAgIGlnbml0ZVNwZWMuZnVzZQogICAgICAgICAgICBdOwogICAgICAgICAgICB2YXIgc2V0dXBEZWZlciA9IFRocnVzdC5fX2ZldGNoSW5zdGFuY2Uoc2V0dGluZ3MubmFtZSk7CiAgICAgICAgICAgIHBpcGUucHVzaChmdW5jdGlvbiAoY29udGV4dCkgewogICAgICAgICAgICAgICAgdmFyIHRocnVzdCA9IGNvbnRleHQudGhydXN0LCBtb2R1bGVzID0gdGhydXN0LnN0YXJ0aW5nTW9kdWxlcyA9IGNvbnRleHQuY2ZnLm1vZHVsZXMsIGNvbmZpZyA9IHRocnVzdC5jb25maWcgPSB0aHJ1c3QuY2ZnOwogICAgICAgICAgICAgICAgaW5zdGFuY2VzW3RocnVzdC5uYW1lXSA9IHRocnVzdDsKICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0OwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYoc2V0dGluZ3MuYXV0b21hdGljTGlmZWN5Y2xlKSB7CiAgICAgICAgICAgICAgICBwaXBlLnB1c2goZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdGhydXN0ID0gY29udGV4dC50aHJ1c3QsIGQgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgICAgICAgICAgICAgVGhydXN0LmxhdW5jaFNlcXVlbmNlKHRocnVzdCwgY2FsbGVkQnlQYXJlbnQpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZC5yZXNvbHZlKGNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBkLnByb21pc2U7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcGlwZWxpbmUgPSB3aGVuLnBpcGVsaW5lKHBpcGUsIHNldHRpbmdzKS50aGVuKGZ1bmN0aW9uIChjb250ZXh0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2V0dXBEZWZlci5yZXNvbHZlKGNvbnRleHQpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy8gV2UncmUgb25seSBnb2luZyB0byBleHBvc2UgZ2xvYmFscyBpZiByZXF1ZXN0ZWQuICBUaGlzIGlzIGEgcG90ZW50aWFsIHVzZWNhc2UgdGhhdCBtYXkgYmUgbmVlZGVkIGZvciBzb21lIHRlYW1zLgogICAgICAgICAgICBpZih0Q29uZmlnLmV4cG9zZUdsb2JhbHMpIHsKICAgICAgICAgICAgICAgIGlmKCF3aW5kb3dbJ1RocnVzdCddKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93WydUaHJ1c3QnXSA9IFRocnVzdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBpcGVsaW5lLnRoZW4oZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3dbc2V0dGluZ3MubmFtZV0gPSBjb250ZXh0OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBpcGVsaW5lOwogICAgICAgIH07CiAgICAgICAgVGhydXN0LmdldEluc3RhbmNlID0gLyoqCiAgICAgICAgR2V0cyBhIG5hbWVkIHRocnVzdCBzdGFuY2UgaWYgaXQgZXhpc3RzLgogICAgICAgIAogICAgICAgIEBtZXRob2QgZ2V0SW5zdGFuY2UKICAgICAgICBAc3RhdGljCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIGluc3RhbmNlIG5hbWUKICAgICAgICBAcmV0dXJucyB7VGhydXN0fSBUaGUgdGhydXN0IGluc3RhbmNlCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gZ2V0SW5zdGFuY2UobmFtZSkgewogICAgICAgICAgICByZXR1cm4gdGhydXN0SW5zdGFuY2UuZ2V0SW5zdGFuY2UobmFtZSk7CiAgICAgICAgfTsKICAgICAgICBUaHJ1c3QuX19mZXRjaEluc3RhbmNlID0gLyoqCiAgICAgICAgRmV0Y2hzIGEgbmFtZWQgdGhydXN0IHN0YW5jZSBpZiBpdCBleGlzdHMuCiAgICAgICAgVGhpcyBsb2FkcyBhc3luY3Jvbm91c2x5LCBhcyB0aGUgaW5zdGFuY2UgbWF5IG5vdCBiZSBsb2FkZWQKICAgICAgICAKICAgICAgICBAbWV0aG9kIF9fZmV0Y2hJbnN0YW5jZQogICAgICAgIEBzdGF0aWMKICAgICAgICBAcHJpdmF0ZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBpbnN0YW5jZSBuYW1lCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRvIGEgdGhydXN0IGluc3RhbmNlIHNwZWMKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiBfX2ZldGNoSW5zdGFuY2UobmFtZSkgewogICAgICAgICAgICByZXR1cm4gdGhydXN0SW5zdGFuY2UuZmV0Y2hJbnN0YW5jZShuYW1lKTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5jcmVhdGVNb2R1bGUgPSAvKioKICAgICAgICBDcmVhdGVzIGEgbmV3IG1vZHVsZSBhbmQgaGFuZHMgaXQgb2ZmIHRvIHRoZSBnaXZlbiBpbnN0YW5jZSwgaWYgdGhhdCBpbnN0YW5jZSBleGlzdHMuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBjcmVhdGVNb2R1bGUKICAgICAgICBAc3RhdGljCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGluc3RhbmNlTmFtZSBUaGUgdGhydXN0IGluc3RhbmNlIG5hbWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbW9kdWxlIG5hbWUKICAgICAgICBAcGFyYW0ge09iamVjdH0gbW9kdWxlRGVmbiBUaGUgbW9kdWxlIGRlZmluaXRpb24KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiBjcmVhdGVNb2R1bGUoaW5zdGFuY2VOYW1lLCBuYW1lLCBtb2R1bGVEZWZuKSB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IFRocnVzdC5nZXRJbnN0YW5jZShpbnN0YW5jZU5hbWUpOwogICAgICAgICAgICBpZihpbnN0YW5jZSkgewogICAgICAgICAgICAgICAgdmFyIG1vZHVsZSA9IG5ldyBNb2R1bGUoaW5zdGFuY2UsIG1vZHVsZURlZm4sIG5hbWUpOwogICAgICAgICAgICAgICAgaW5zdGFuY2UuX19pbmplY3RNb2R1bGUobW9kdWxlKTsKICAgICAgICAgICAgICAgIHJldHVybiBtb2R1bGU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIFRocnVzdC5yZWdpc3Rlck1vZHVsZSA9IC8qKgogICAgICAgIFJlZ2lzdGVycyBhIHNwZWNpZmljIG1vZHVsZSBuYW1lLCBhbmQgYXJndW1lbnRzLiAgVGhlIGFyZ3VtZW50cyB3aWxsIGJlIHVzZWQgd2hlbiBpbml0YW50aWF0aW5nIHRoZSBtb2R1bGUuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCByZWdpc3Rlck1vZHVsZQogICAgICAgIEBzdGF0aWMKICAgICAgICBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VOYW1lIFRoZSB0aHJ1c3QgaW5zdGFuY2UgdGhlIG1vZHVsZSBpcyB0byBiZSBhc3NvY2lhdGVkIHdpdGguCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG1vZHVsZSBuYW1lIHRvIGFzc2lnbiB0aGUgYXJndW1lbnRzIHdpdGguCiAgICAgICAgQHBhcmFtIHtPYmplY3QqfSBhcmd1bWVudHMsIGFkZGl0aW9uYWwgYXJndW1lbnRzIHRoYXQgd2lsbCBiZSBwYXNzZWQgb250byB0aGUgbW91ZGxlCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJNb2R1bGUoaW5zdGFuY2VOYW1lLCBuYW1lKSB7CiAgICAgICAgICAgIGlmKCFpbnN0YW5jZU5hbWUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignaW5zdGFuY2VOYW1lIGlzIHJlcXVpcmVkIScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFuYW1lKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ25hbWUgaXMgcmVxdWlyZWQhJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIVRocnVzdC5fX21vZHVsZVJlZ2lzdHJhdGlvbnNbaW5zdGFuY2VOYW1lXSkgewogICAgICAgICAgICAgICAgVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9uc1tpbnN0YW5jZU5hbWVdID0gewogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXJncyA9IHRvQXJyYXkoYXJndW1lbnRzKS5zbGljZSgyKTsKICAgICAgICAgICAgaWYoVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9uc1tpbnN0YW5jZU5hbWVdW25hbWVdKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdNb2R1bGUgInswfSIgYWxyZWFkeSByZWdpc3RlcmVkIHRvIGluc3RhbmNlICJ7MX0iJywgbmFtZSwgaW5zdGFuY2VOYW1lKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgVGhydXN0Ll9fbW9kdWxlUmVnaXN0cmF0aW9uc1tpbnN0YW5jZU5hbWVdW25hbWVdID0gYXJncyB8fCBbXTsKICAgICAgICB9OwogICAgICAgIFRocnVzdC5fX2dldE1vZHVsZUFyZ3MgPSBfX2dldE1vZHVsZUFyZ3M7CiAgICAgICAgcmV0dXJuIFRocnVzdDsKICAgIH0pKCk7CiAgICBleHBvcnRzLlRocnVzdCA9IFRocnVzdDsgICAgCiAgICAvKioKICAgIEFNRCBBUEkKICAgIGxvYWQKICAgIAogICAgSGFuZGxlcyBmZXRjaGluZyBvZiBhIGN1cnJlbnQgdGh1cnN0IGluc3RhbmNlLCBieSBleHBlY3RlZCBuYW1lLgogICAgQWRkaW5nIHRoZSA6IGNoYXJhY3RlciByZXF1ZXN0cyBhIHNwZWNpZmljIHBsdWdpbi4KICAgIHRocnVzdCFnbG9iYWwgPSBUaHJ1c3QgaW5zdGFuY2UKICAgIHRocnVzdCFnbG9iYWw6ZG9tID0gVGhlIHRocnVzdCBkb20gcGx1Z2luIGluc3RhbmNlCiAgICAKICAgIEBtZXRob2QgbG9hZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlIHRoYXQgaXMgYmVpbmcgZmV0Y2hlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gcGFyZW50UmVxdWlyZSB0aGUgcmVxdWlyZSBtZXRob2QgdG8gYmUgbG9hZGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBsb2FkIEFsbG93cyB0aGUgbG9hZCB0byBpbmZvcm0gdGhhdCBBTUQgZm9yIHRoZSB2YWx1ZSB0byBoYW5kIG9mZgogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgY3VzdG9tIGNvbmZpZ3VyYXRpb24uCiAgICAqKi8KICAgIGZ1bmN0aW9uIGxvYWQobmFtZSwgcGFyZW50UmVxdWlyZSwgbG9hZCwgY29uZmlnKSB7CiAgICAgICAgdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgnOicpLCByZWFsTmFtZSA9IHBhcnRzWzBdLCBwbHVnaW5OYW1lID0gcGFydHNbMV0gfHwgJ3RocnVzdCc7CiAgICAgICAgdmFyIGluc3RhbmNlUHJvbWlzZSA9IFRocnVzdC5fX2ZldGNoSW5zdGFuY2UocmVhbE5hbWUpOwogICAgICAgIGluc3RhbmNlUHJvbWlzZS5wcm9taXNlLnRoZW4oZnVuY3Rpb24gKGNvbnRleHQpIHsKICAgICAgICAgICAgdmFyIHBsdWdpbiA9IGNvbnRleHRbcGx1Z2luTmFtZV07CiAgICAgICAgICAgIGlmKCFwbHVnaW4pIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmb3JtYXQoJ1BsdWdpbiAiezB9IiBkb2VzIG5vdCBleGlzdCBvbiB0aHJ1c3QgaW5zdGFuY2UgInsxfSIuJywgcGx1Z2luTmFtZSwgcmVhbE5hbWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsb2FkKHBsdWdpbik7CiAgICAgICAgfSk7CiAgICB9CiAgICBleHBvcnRzLmxvYWQgPSBsb2FkOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0JywgWyd0aHJ1c3QvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgpkZWZpbmUoJ3RocnVzdC9jb252ZW50aW9uJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIC8qKgogICAgQSBDb252ZW50aW9uIGFsbG93cyB0aHJ1c3QgdG8gYmUgYXMgZXh0ZW5kYWJsZSBhcyBwb3NzaWJsZSwgYnkgZ2l2aW5nIGV4dGVuc2lvbiBwb2ludHMgYXQgZXZlcnkgc3RlcCBhbG9uZyB0aGUgd2F5LgogICAgCiAgICBAbW9kdWxlIHRocnVzdAogICAgKiovCiAgICB2YXIgbWV0aG9kcyA9IFsKICAgICAgICAnY3JlYXRlJywgCiAgICAgICAgJ2luaXQnLCAKICAgICAgICAnc3RhcnQnLCAKICAgICAgICAncmVhZHknLCAKICAgICAgICAnc3RvcCcsIAogICAgICAgICdkZXN0cm95JywgCiAgICAgICAgJ2NvdW50ZG93bicsIAogICAgICAgICdpZ25pdGUnLCAKICAgICAgICAnb3JiaXQnLCAKICAgICAgICAnZGVvcmJpdCcsIAogICAgICAgICdzcGxhc2hkb3duJwogICAgXTsKICAgIC8qKgogICAgVGhlIGNvbnZlbnRpb24gY2xhc3MsIHRha2VzIGFuIG92ZXJsb2FkZWQgc2V0IG9mIG1ldGhvZHMsIGZvciBhbnkgbWV0aG9kIHRoYXQgbmVlZHMgdG8gYmUgb3ZlcmxvYWRlZC4KICAgIAogICAgQGNsYXNzIHRocnVzdC5Db252ZW50aW9uCiAgICBAY29uc3RydWN0b3IKICAgIEBwYXJhbSB7T2JqZWN0fSBtZXRob2RzIEFuIG9iamVjdCBvZiBhcHBsaWNhYmxlIG1ldGhvZHMuCiAgICAqKi8KICAgIHZhciBDb252ZW50aW9uID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBDb252ZW50aW9uKG1ldGhvZE92ZXJyaWRlcykgewogICAgICAgICAgICBfLmV4dGVuZCh0aGlzLCBtZXRob2RPdmVycmlkZXMpOwogICAgICAgICAgICB2YXIga2V5cyA9IF8uZGlmZmVyZW5jZShtZXRob2RzLCBfLmludGVyc2VjdGlvbihtZXRob2RzLCBfLmtleXMobWV0aG9kT3ZlcnJpZGVzKSkpOwogICAgICAgICAgICBfLmVhY2goa2V5cywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIGlmKF8uaXNGdW5jdGlvbih0aGlzW3hdKSkgewogICAgICAgICAgICAgICAgICAgIC8vIG5vb3AgaXMgdXNlZCBpbiBzYWZlaW52b2tlLCBhcyBhIHNhZmUgaWdub3JlIGZ1bmN0aW9uLCBubyBvdGhlciBub29wIHdpbGwgd29yayBjb3JyZWN0bHkuCiAgICAgICAgICAgICAgICAgICAgdGhpc1t4XSA9IHV0aWwubm9vcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgfQogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLmNyZWF0ZSA9IC8qKgogICAgICAgIFRoaXMgaXMgY2FsbGVkIGR1cmluZyBjcmVhdGUgb2YgYSBtb2R1bGUsIGdlbmVyYWxseSB1c2VkIHRvIGNyZWF0ZSBhIGZhY2FkZSwgdGhhdCBpcyB0aGVuIGJvdW5kIHRvIHRoZSBtb2R1bGUuCiAgICAgICAgQG1ldGhvZCBjcmVhdGUKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQHBhcmFtIHtNb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIGluc3RhbmNlLgogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIEFsbCB0aGUgZmFjYWRlcyBhbHJlYWR5IGF0dGFjaGVkIHRvIHRoZSBtb2R1bGUuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCwgbW9kLCBmYWNhZGVzKSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5pbml0ID0gLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGR1cmluZyB0aGUgdGhydXN0IGluaXQgcGhhc2UsIG9yIGFuIGluZGl2aWR1YWwgbW9kdWxlJ3MgaW5pdCBwaGFzZQogICAgICAgIAogICAgICAgIEBtZXRob2QgaW5pdAogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGZvciB0aGUgbW9kdWxlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLnN0YXJ0ID0gLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGR1cmluZyB0aGUgdGhydXN0IHN0YXJ0IHBoYXNlLCBvciBhbiBpbmRpdmlkdWFsIG1vZHVsZSdzIHN0YXJ0IHBoYXNlCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBzdGFydAogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGZvciB0aGUgbW9kdWxlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLnJlYWR5ID0gLyoqCiAgICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGR1cmluZyB0aGUgdGhydXN0IHJlYWR5IHBoYXNlLCBvciBhbiBpbmRpdmlkdWFsIG1vZHVsZSdzIHJlYWR5IHBoYXNlCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCByZWFkeQogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBmYWNhZGVzIFRoZSBmYWNhZGVzIGZvciB0aGUgbW9kdWxlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBBIHByb21pc2UgbWF5IGJlIHJldHVybmVkLCB0byBkZWxheSB0aGUgbmV4dCBwaGFzZSBmcm9tIGJlZ2luaW5nLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICB9OwogICAgICAgIENvbnZlbnRpb24ucHJvdG90eXBlLnN0b3AgPSAvKioKICAgICAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgZHVyaW5nIHRoZSB0aHJ1c3Qgc3RvcCBwaGFzZSwgb3IgYW4gaW5kaXZpZHVhbCBtb2R1bGUncyBzdG9wIHBoYXNlCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBzdG9wCiAgICAgICAgQG9wdGlvbmFsCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgVGhlIGZhY2FkZXMgZm9yIHRoZSBtb2R1bGUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUuZGVzdHJveSA9IC8qKgogICAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBkdXJpbmcgdGhlIHRocnVzdCBkZXN0cm95IHBoYXNlLCBvciBhbiBpbmRpdmlkdWFsIG1vZHVsZSdzIGRlc3Ryb3kgcGhhc2UKICAgICAgICAKICAgICAgICBAbWV0aG9kIGRlc3Ryb3kKICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgZmFjYWRlcyBmb3IgdGhlIG1vZHVsZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobW9kLCBmYWNhZGVzKSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5jb3VudGRvd24gPSAvKioKICAgICAgICBUaGlzIGlzIGNhbGxlZCBkdXJpbmcgdGhlIGluaXQgcGhhc2Ugb2YgYSBUaHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQG1ldGhvZCBjb3VudGRvd24KICAgICAgICBAb3B0aW9uYWwKICAgICAgICBAcGFyYW0ge1RocnVzdH0gdGhydXN0IFRoZSB0aHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IEEgcHJvbWlzZSBtYXkgYmUgcmV0dXJuZWQsIHRvIGRlbGF5IHRoZSBuZXh0IHBoYXNlIGZyb20gYmVnaW5pbmcuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgIH07CiAgICAgICAgQ29udmVudGlvbi5wcm90b3R5cGUuaWduaXRlID0gLyoqCiAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIHRoZSBzdGFydCBwaGFzZSBvZiBhIFRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAbWV0aG9kIGlnbml0ZQogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5vcmJpdCA9IC8qKgogICAgICAgIFRoaXMgaXMgY2FsbGVkIGR1cmluZyB0aGUgcmVhZHkgcGhhc2Ugb2YgYSBUaHJ1c3QgaW5zdGFuY2UuCiAgICAgICAgQG1ldGhvZCBvcmJpdAogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5kZW9yYml0ID0gLyoqCiAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIHRoZSBzdG9wIHBoYXNlIG9mIGEgVGhydXN0IGluc3RhbmNlLgogICAgICAgIEBtZXRob2QgZGVvcmJpdAogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgfTsKICAgICAgICBDb252ZW50aW9uLnByb3RvdHlwZS5zcGxhc2hkb3duID0gLyoqCiAgICAgICAgVGhpcyBpcyBjYWxsZWQgZHVyaW5nIHRoZSBkZXN0cm95IHBoYXNlIG9mIGEgVGhydXN0IGluc3RhbmNlLgogICAgICAgIEBtZXRob2Qgc3BsYXNoZG93bgogICAgICAgIEBvcHRpb25hbAogICAgICAgIEBwYXJhbSB7VGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gQSBwcm9taXNlIG1heSBiZSByZXR1cm5lZCwgdG8gZGVsYXkgdGhlIG5leHQgcGhhc2UgZnJvbSBiZWdpbmluZy4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gQ29udmVudGlvbjsKICAgIH0pKCk7CiAgICBleHBvcnRzLkNvbnZlbnRpb24gPSBDb252ZW50aW9uOyAgICAKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29udmVudGlvbi5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9ldmVudHMnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJy4vbG9nJywgJy4vY29uZmlnJywgJ2hhcycsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2xvZ19fLCBfX3RDb25maWdfXywgX19oYXNfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9ImludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9ImludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgLy8gICAgIEJhY2tib25lLmpzIDAuOS4xCiAgICAvLyAgICAgKGMpIDIwMTAtMjAxMiBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgSW5jLgogICAgLy8gICAgIEJhY2tib25lIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogICAgLy8gICAgIEZvciBhbGwgZGV0YWlscyBhbmQgZG9jdW1lbnRhdGlvbjoKICAgIC8vICAgICBodHRwOi8vYmFja2JvbmVqcy5vcmcKICAgIC8qKgogICAgVGhydXN0IEV2ZW50cyBhcmUgYmFzZWQgb2ZmIG9mIHRoZSBCYWNrYm9uZSBldmVudCBtb2RlbCwgd2l0aCBzcGVjaWFsIGFkZGl0aW9ucy4KICAgIAogICAgKiBFdmVudHMgY2FuIGJlIGZpcmVkIGFzeW5jcm9ub3VzbHkuCiAgICAqIEV2ZW50cyBjYW4gYmUgbmFtZXNwYWNlZC4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QKICAgICoqLwogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIHRDb25maWcgPSBfX3RDb25maWdfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIEV2ZW50Tm9kZSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gRXZlbnROb2RlKCkgewogICAgICAgICAgICB0aGlzLnRhaWwgPSBudWxsOwogICAgICAgICAgICB0aGlzLm5leHQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmNhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5jb250ZXh0ID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5uYW1lc3BhY2UgPSAnJzsKICAgICAgICAgICAgdGhpcy5vbmNlID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiBFdmVudE5vZGU7CiAgICB9KSgpOwogICAgZXhwb3J0cy5FdmVudE5vZGUgPSBFdmVudE5vZGU7ICAgIAogICAgdmFyIGNyZWF0ZUFzeW5jRXZlbnQgPSBmdW5jdGlvbiAob2JqZWN0KSB7CiAgICAgICAgdmFyIGYgPSBmdW5jdGlvbiBmKGV2ZW50cykgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAxKTsgX2krKykgewogICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfdHJpZ2dlci5hcHBseShvYmplY3QsIFsKICAgICAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgIF0uY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICAgIH07CiAgICAgICAgZi5hc3luYyA9IGZ1bmN0aW9uIChldmVudHMpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgX3RyaWdnZXIuYXBwbHkob2JqZWN0LCBbCiAgICAgICAgICAgICAgICB0cnVlCiAgICAgICAgICAgIF0uY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGY7CiAgICB9OwogICAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBhc3luY0ZpcmUsIG5vb3AgPSB1dGlsLm5vb3AsIHdoZW4gPSB1dGlsLndoZW4sIHNpemUgPSBfLnNpemUsIGVhY2ggPSBfLmVhY2gsIGRlZmVyID0gXy5kZWZlciwgYmluZCA9IF8uYmluZCwgZXh0ZW5kID0gXy5leHRlbmQsIGZvcm1hdCA9IHV0aWwuZm9ybWF0OwogICAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLywgQUxMID0gJ2FsbCcsIFNUQVJBTEwgPSAnKmFsbCc7CiAgICAvKioKICAgIE5vcm1hbGl6ZXMgdGhlIGdpdmVuIGV2ZW50cyB0byB0aGUgZXhwZWN0ZWQgbmFtZXNwYWNlLgogICAgCiAgICBAbWV0aG9kIG5vcm1hbGl6ZUV2ZW50cwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudHMgVGhlIGV2ZW50cyBkZWxpbWl0ZWQgYnkgYSBzcGFjZQogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWVzcGFjZSBUaGUgbmFtZXNwYWNlLCBpbmNsdWRpbmcgcHJlZml4ZWQgJy4nCiAgICAqKi8KICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZUV2ZW50cyhldmVudHMsIG5hbWVzcGFjZSkgewogICAgICAgIHZhciBldmVudHNBcnJheSA9IGV2ZW50cy5zcGxpdChldmVudFNwbGl0dGVyKTsKICAgICAgICBmb3IodmFyIGkgPSAwLCBpTGVuID0gZXZlbnRzQXJyYXkubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmKGV2ZW50c0FycmF5W2ldLmluZGV4T2YoJy4nKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIGV2ZW50c0FycmF5W2ldID0gZXZlbnRzQXJyYXlbaV0gKyBuYW1lc3BhY2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV2ZW50c0FycmF5LmpvaW4oJyAnKTsKICAgIH0KICAgIC8qKgogICAgVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQogICAgKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgCiAgICBAbWV0aG9kIF90cmlnZ2VyCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtCb29sZWFufSBhc3luYyBGaXJlIGV2ZW50IGFzeW5jIG9yIHN5bmMKICAgIEBwYXJhbSB7T2JqZWN0fSBldmVudHMgVGhlIGV2ZW50cyB0byBiZSBmaXJlZC4KICAgIGRlbGltaXRlZCBieSBhIHNwYWNlLgogICAgQHBhcmFtIFthcmdzXSogVGhlIGFyZ3VtZW50cyB0byBwYXNzIG9udG8gdGhlIGNhbGxiYWNrIG1ldGhvZHMuCiAgICBAcmV0dXJucyBJZiBhc3luYyB0aGVuIHJldHVybnMgYSBQcm9taXNlLCB3aGVyZSB0aGUgZmlyc3QgYXJndW1lbnQgY29udGFpbnMgYWxsIHRoZSByZXR1cm5lZCB2YWx1ZXMsIGFzIGFuIGFycmF5CiAgICBJZiBzeW5jIHRoZW4gcmV0dXJucyBhbiBhcnJheSBvZiB0aGUgcmV0dXJuIHZhbHVlcy4KICAgIElmIG1vcmUgdGhhbiBvbmUgZXZlbnQsIHJldHVybnMgYW4gb2JqZWN0IG9mIGFycmF5cyBvciBwcm9taXNlcywgd2l0aCB0aGUga2V5IGZvciBlYWNoIGV2ZW50LgogICAgKiovCiAgICBmdW5jdGlvbiBfdHJpZ2dlcihhc3luYywgZXZlbnRzKSB7CiAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi8KICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgZXZlbnQsIG5vZGUsIGNhbGxzLCB0YWlsLCBhcmdzLCBhbGwsIHJlc3QsIG5hbWVzcGFjZSwgb25jZU5vZGVzOwogICAgICAgIGlmKCEoY2FsbHMgPSB0aGlzLl9jYWxsYmFja3MpKSB7CiAgICAgICAgICAgIHJldHVybiB0aGF0OwogICAgICAgIH0KICAgICAgICBhbGwgPSBjYWxscy5hbGw7CiAgICAgICAgdmFyIGV2ZW50c0FycmF5ID0gZXZlbnRzLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwogICAgICAgIHJlc3QgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICAgICAgd2hpbGUoZXZlbnQgPSBldmVudHNBcnJheS5zaGlmdCgpKSB7CiAgICAgICAgICAgIGlmKG5vZGUgPSBjYWxsc1tldmVudF0pIHsKICAgICAgICAgICAgICAgIHRyaWdnZXJOb2Rlcyh0aGF0LCBldmVudCwgYXN5bmMsIG5vZGUsIHJlc3QpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG5vZGUgPSBhbGwpIHsKICAgICAgICAgICAgICAgIHRyaWdnZXJOb2Rlcyh0aGF0LCBBTEwsIGFzeW5jLCBub2RlLCBbCiAgICAgICAgICAgICAgICAgICAgZXZlbnQKICAgICAgICAgICAgICAgIF0uY29uY2F0KHJlc3QpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIC8qKgogICAgVHJpZ2dlcnMgYWxsIGV2ZW50cyBvbiBhIG5vZGUuCiAgICBBbHNvIHVuYmluZHMgYW55IG5vZGUgdGhhdCBpcyBzZXQgdG8gb25seSBiZSBjYWxsZWQgb25jZS4KICAgIAogICAgQG1ldGhvZCB0cmlnZ2VyTm9kZXMKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge09iamVjdH0gdGhhdCBUaGUgZXZlbnQgY29udGFpbmVyIGNvbnRleHQuCiAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnQgVGhlIGV2ZW50IHRvIGJlIGJvdW5kIG9yIHVuYm91bmQuCiAgICBAcGFyYW0ge0Jvb2xlYW59IGFzeW5jIEZpcmUgZXZlbnQgYXN5bmMgb3Igc3luYwogICAgQHBhcmFtIHtPYmplY3R9IG5vZGUgVGhlIG5vZGUgbGlua2VkIGxpc3QuCiAgICBAcGFyYW0ge0FycmF5fSBhcmdzIFRoZSBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSB0cmlnZ2VyZWQgbm9kZXMKICAgIAogICAgKiovCiAgICBmdW5jdGlvbiB0cmlnZ2VyTm9kZXModGhhdCwgZXZlbnQsIGFzeW5jLCBub2RlTGlzdCwgYXJncykgewogICAgICAgIHZhciB0YWlsLCBvbmNlTm9kZXMgPSBbXTsKICAgICAgICBmYWxzZSAmJiBsb2cuaW5mbyhmb3JtYXQoJ3swfTogdHJpZ2dlcmluZyB7MX0gZXZlbnQgInsyfSInLCB0aGF0Ll9fcHViU3ViTmFtZSwgYXN5bmMgJiYgJ2FzeW5jJyB8fCAnJywgZXZlbnQpKTsKICAgICAgICBlYWNoKG5vZGVMaXN0LCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICB0YWlsID0gbm9kZS50YWlsOwogICAgICAgICAgICB3aGlsZSgobm9kZSA9IG5vZGUubmV4dCkgIT09IHRhaWwpIHsKICAgICAgICAgICAgICAgIHRyaWdnZXJDYWxsYmFjayhhc3luYywgbm9kZS5jYWxsYmFjaywgbm9kZS5jb250ZXh0IHx8IHRoYXQsIGFyZ3MpOwogICAgICAgICAgICAgICAgbm9kZS5vbmNlICYmIG9uY2VOb2Rlcy5wdXNoKG5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgaWYob25jZU5vZGVzLmxlbmd0aCkgewogICAgICAgICAgICBlYWNoKG9uY2VOb2RlcywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIHRoYXQudW5zdWJzY3JpYmUoZXZlbnQsIHguY2FsbGJhY2ssIHguY29udGV4dCwgeC5uYW1lc3BhY2UpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICAvKioKICAgIEludm9rZXMgYSB0cmlnZ2VyIGNhbGxiYWNrCiAgICAKICAgIEBtZXRob2QgdHJpZ2dlckNhbGxiYWNrCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtCb29sZWFufSBhc3luYyBGaXJlIGV2ZW50IGFzeW5jIG9yIHN5bmMKICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBtZXRob2QKICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IFRoZSBjYWxsaW5nIGNvbnRleHQKICAgIEBwYXJhbSB7QXJyYXl9IGFyZ3MgVGhlIGFyZ3VtZW50cyB0byBjYWxsIHRoZSBjYWxsYmFjayB3aXRoLgogICAgQHJldHVybnMge09iamVjdH0gVGhlIHJldHVybmVkIHZhbHVlLgogICAgRm9yIGFzeW5jIGNhbGxzLCB0aGlzIGlzIGEgcHJvbWlzZQogICAgRm9yIHN5bmMgY2FsbHMgdGhpcyBpcyB0aGUgdmFsdWUgZnJvbSB0aGUgbWV0aG9kLgogICAgKiovCiAgICBmdW5jdGlvbiB0cmlnZ2VyQ2FsbGJhY2soYXN5bmMsIGNhbGxiYWNrLCBjb250ZXh0LCBhcmdzKSB7CiAgICAgICAgaWYoYXN5bmMpIHsKICAgICAgICAgICAgZGVmZXIodHJpZ2dlckFzeW5jQ2FsbGJhY2soY2FsbGJhY2ssIGNvbnRleHQsIGFyZ3MpLCAwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0cnkgIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjay5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgaWYodENvbmZpZy50aHJvd0Vycm9ycykgewogICAgICAgICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAvKioKICAgIENyZWF0ZXMgYW4gYXN5bmMgZXZlbnQgaGFuZGxlcgogICAgCiAgICBAbWV0aG9kIGFzeW5jRXZlbnRGYWN0b3J5CiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIG1ldGhvZAogICAgQHBhcmFtIHtPYmplY3R9IHRoYXQgVGhlIGNhbGxpbmcgY29udGV4dAogICAgQHBhcmFtIHtBcnJheX0gYXJncyBUaGUgYXJndW1lbnRzIHRvIGNhbGwgdGhlIGNhbGxiYWNrIHdpdGguCiAgICBAcmV0dXJucyB7RnVuY3Rpb259IFRoZSBjYWxsYmFjayBmb3IgdGhlIGdpdmVuIGFyZ3VtZW50cy4KICAgICoqLwogICAgZnVuY3Rpb24gdHJpZ2dlckFzeW5jQ2FsbGJhY2soY2FsbGJhY2ssIGNvbnRleHQsIGFyZ3MpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgfTsKICAgIH0KICAgIC8qKgogICAgUmVzdWJzY3JpYmVzIHRvIHRoZSBhcHByb3ByaWF0ZSBldmVudHMKICAgIAogICAgQG1ldGhvZCBfb2ZmUHJvY2Vzc05vZGUKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge09iamVjdH0gdGhhdCBUaGUgZXZlbnQgY29udGV4dAogICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50IFRoZSBldmVudAogICAgQHBhcmFtIHtPYmplY3R9IG5vZGUgVGhlIG5vZGUgbGlua2VkIGxpc3QuCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBldmVudCBjYWxsYmFjayB0byB1bnN1YnNjcmliZQogICAgQHBhcmFtIHtPYmplY3R9IFtjb250ZXh0XSBUaGUgZXZlbnQgY29udGV4dCB0byB1bnN1YnNjcmliZQogICAgQHBhcmFtIHtTdHJpbmd9IFtuYW1lc3BhY2VdIFRoZSBuYW1lc3BhY2UgdG8gdW5zdWJzY3JpYmUKICAgICoqLwogICAgZnVuY3Rpb24gX29mZlByb2Nlc3NOb2RlKHRoYXQsIGV2ZW50LCBub2RlLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIHZhciB0YWlsLCBjYiwgY3R4LCBuczsKICAgICAgICB0YWlsID0gbm9kZS50YWlsOwogICAgICAgIHdoaWxlKChub2RlID0gbm9kZS5uZXh0KSAhPT0gdGFpbCkgewogICAgICAgICAgICBjYiA9IG5vZGUuY2FsbGJhY2s7CiAgICAgICAgICAgIGN0eCA9IG5vZGUuY29udGV4dDsKICAgICAgICAgICAgbnMgPSBub2RlLm5hbWVzcGFjZTsKICAgICAgICAgICAgaWYoKGNhbGxiYWNrICYmIGNiICE9PSBjYWxsYmFjaykgfHwgKGNvbnRleHQgJiYgY3R4ICE9PSBjb250ZXh0KSkgewogICAgICAgICAgICAgICAgdGhhdC5zdWJzY3JpYmUoZXZlbnQgKyAobnMgJiYgKCcuJyArIG5zKSB8fCAnJyksIGNiLCBjdHgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgLyoqCiAgICBHZXRzIHRoZSBuYW1lc3BhY2UgaW5mb3JtYXRpb24sIHRoZSByZWFsIGV2ZW50IHRvIHBhc3MgYmFjayBvbnRvIHRoZSBtZXRob2RzLgogICAgCiAgICBAbWV0aG9kIGdldE5hbWVzcGFjZURhdGEKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnQgVGhlIGV2ZW50IHRvIGNhcHR1cmUgbmFtZXNwYWNlIGRhdGEgZnJvbS4KICAgIEByZXR1cm5zIHtPYmplY3R9IENvbnRhaW5pbmcgZXZlbnQgYW5kIG5hbWVzcGFjZS4KICAgICoqLwogICAgZnVuY3Rpb24gZ2V0TmFtZXNwYWNlRGF0YShldmVudCkgewogICAgICAgIHZhciBuc0luZGV4ID0gKGV2ZW50IHx8ICcnKS5pbmRleE9mKCcuJyksIGhhc05zID0gbnNJbmRleCA+IC0xLCBuYW1lc3BhY2UgPSBoYXNOcyA/IGV2ZW50LnN1YnN0cmluZyhuc0luZGV4ICsgMSkgOiB1bmRlZmluZWQsIGV2ZW50ID0gaGFzTnMgPyBldmVudC5zdWJzdHJpbmcoMCwgbnNJbmRleCkgOiBldmVudDsKICAgICAgICBpZihuc0luZGV4ID09PSAwKSB7CiAgICAgICAgICAgIGV2ZW50ID0gU1RBUkFMTDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZXZlbnQ6IGV2ZW50LAogICAgICAgICAgICBuYW1lc3BhY2U6IG5hbWVzcGFjZQogICAgICAgIH07CiAgICB9CiAgICAvKioKICAgIFRocnVzdCBFdmVudHMgYXJlIGJhc2VkIG9mZiBvZiB0aGUgQmFja2JvbmUgZXZlbnQgbW9kZWwsIHdpdGggc3BlY2lhbCBhZGRpdGlvbnMuCiAgICAKICAgICogRXZlbnRzIGNhbiBiZSBmaXJlZCBhc3luY3Jvbm91c2x5LgogICAgKiBFdmVudHMgY2FuIGJlIG5hbWVzcGFjZWQuCiAgICAKICAgIEBjbGFzcyB0aHJ1c3QuRXZlbnRzCiAgICAqKi8KICAgIGV4cG9ydHMuRXZlbnRzID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZXZlbnRzID0gewogICAgICAgICAgICBzdWJzY3JpYmU6IC8qKgogICAgICAgICAgICBCaW5kIG9uZSBvciBtb3JlIHNwYWNlIHNlcGFyYXRlZCBldmVudHMsIGBldmVudHNgLCB0byBhIGBjYWxsYmFja2AKICAgICAgICAgICAgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQgdGhlIGNhbGxiYWNrIHRvIGFsbCBldmVudHMgZmlyZWQuCiAgICAgICAgICAgIAogICAgICAgICAgICBAbWV0aG9kIHN1YnNjcmliZQogICAgICAgICAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnRzIFNwYXZlIHNlcGVyYXRlZCBldmVudHMKICAgICAgICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIG1ldGhvZCB0byBiZSBjYWxsZWQgd2hlbiB0aGUgZXZlbnRzIGFyZSBmaXJlZC4KICAgICAgICAgICAgQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgVGhlIGNvbnRleHQgdG8gYmluZCB0aGUgY2FsbGluZyBmdW5jdGlvbiB0by4KICAgICAgICAgICAgQHBhcmFtIHtCb29sZWFufSBvbmNlIENhbGwgdGhpcyBldmVudCBvbmx5IG9uY2UuCiAgICAgICAgICAgIEBjaGFpbmFibGUKICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0LCBvbmNlKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FsbHMsIGV2ZW50LCBub2RlLCB0YWlsLCBsaXN0LCBuZDsKICAgICAgICAgICAgICAgIHRoaXMuX19uYW1lc3BhY2UgJiYgKGV2ZW50cyA9IG5vcm1hbGl6ZUV2ZW50cyhldmVudHMsIHRoaXMuX19uYW1lc3BhY2UpKTsKICAgICAgICAgICAgICAgIHZhciBldmVudHNBcnJheSA9IGV2ZW50cy5zcGxpdChldmVudFNwbGl0dGVyKTsKICAgICAgICAgICAgICAgIGNhbGxzID0gdGhpcy5fY2FsbGJhY2tzIHx8ICh0aGlzLl9jYWxsYmFja3MgPSB7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBhbiBpbW11dGFibGUgY2FsbGJhY2sgbGlzdCwgYWxsb3dpbmcgdHJhdmVyc2FsIGR1cmluZwogICAgICAgICAgICAgICAgLy8gbW9kaWZpY2F0aW9uLiAgVGhlIHRhaWwgaXMgYW4gZW1wdHkgb2JqZWN0IHRoYXQgd2lsbCBhbHdheXMgYmUgdXNlZAogICAgICAgICAgICAgICAgLy8gYXMgdGhlIG5leHQgbm9kZS4KICAgICAgICAgICAgICAgIHdoaWxlKGV2ZW50ID0gZXZlbnRzQXJyYXkuc2hpZnQoKSkgewogICAgICAgICAgICAgICAgICAgIG5kID0gZ2V0TmFtZXNwYWNlRGF0YShldmVudCk7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQgPSBuZC5ldmVudDsKICAgICAgICAgICAgICAgICAgICBsaXN0ID0gY2FsbHNbZXZlbnRdIHx8IChjYWxsc1tldmVudF0gPSB7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgbGlzdCA9IGxpc3RbbmQubmFtZXNwYWNlXTsKICAgICAgICAgICAgICAgICAgICBub2RlID0gbGlzdCA/IGxpc3QudGFpbCA6IG5ldyBFdmVudE5vZGUoKTsKICAgICAgICAgICAgICAgICAgICBub2RlLm5leHQgPSB0YWlsID0gbmV3IEV2ZW50Tm9kZSgpOwogICAgICAgICAgICAgICAgICAgIG5vZGUuY29udGV4dCA9IGNvbnRleHQgfHwgdGhpcy5fX2RlZmF1bHRDb250ZXh0IHx8IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICBub2RlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgICAgICAgaWYobmQubmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubmFtZXNwYWNlID0gbmQubmFtZXNwYWNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZihvbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUub25jZSA9IG9uY2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNhbGxzW2V2ZW50XVtuZC5uYW1lc3BhY2VdID0gewogICAgICAgICAgICAgICAgICAgICAgICB0YWlsOiB0YWlsLAogICAgICAgICAgICAgICAgICAgICAgICBuZXh0OiBsaXN0ID8gbGlzdC5uZXh0IDogbm9kZQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25jZTogLyoqCiAgICAgICAgICAgIEJpbmQgb25lIG9yIG1vcmUgc3BhY2Ugc2VwYXJhdGVkIGV2ZW50cywgYGV2ZW50c2AsIHRvIGEgYGNhbGxiYWNrYAogICAgICAgICAgICBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZCB0aGUgY2FsbGJhY2sgdG8gYWxsIGV2ZW50cyBmaXJlZC4KICAgICAgICAgICAgCiAgICAgICAgICAgIEVhY2ggZXZlbnQgd2lsbCBvbmx5IGJlIGNhbGxlZCBvbmNlLgogICAgICAgICAgICAKICAgICAgICAgICAgQG1ldGhvZCBvbmNlCiAgICAgICAgICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudHMgU3BhdmUgc2VwZXJhdGVkIGV2ZW50cwogICAgICAgICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgbWV0aG9kIHRvIGJlIGNhbGxlZCB3aGVuIHRoZSBldmVudHMgYXJlIGZpcmVkLgogICAgICAgICAgICBAcGFyYW0ge09iamVjdH0gY29udGV4dCBUaGUgY29udGV4dCB0byBiaW5kIHRoZSBjYWxsaW5nIGZ1bmN0aW9uIHRvLgogICAgICAgICAgICBAY2hhaW5hYmxlCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3Vic2NyaWJlKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQsIHRydWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN1YnNjcmliZTogLyoqCiAgICAgICAgICAgIFJlbW92ZSBvbmUgb3IgbWFueSBjYWxsYmFja3MuIElmIGBjb250ZXh0YCBpcyBudWxsLCByZW1vdmVzIGFsbCBjYWxsYmFja3MKICAgICAgICAgICAgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGNhbGxiYWNrcyBmb3IgdGhlCiAgICAgICAgICAgIGV2ZW50LiBJZiBgZXZlbnRgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kIGNhbGxiYWNrcyBmb3IgYWxsIGV2ZW50cy4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2QgdW5zdWJzY3JpYmUKICAgICAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50cyBTcGF2ZSBzZXBlcmF0ZWQgZXZlbnRzCiAgICAgICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBtZXRob2QgdG8gYmUgY2FsbGVkIHdoZW4gdGhlIGV2ZW50cyBhcmUgZmlyZWQuCiAgICAgICAgICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IFRoZSBjb250ZXh0IHRvIGJpbmQgdGhlIGNhbGxpbmcgZnVuY3Rpb24gdG8uCiAgICAgICAgICAgIEBjaGFpbmFibGUKICAgICAgICAgICAgKiovCiAgICAgICAgICAgIGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnQsIGNhbGxzLCBub2RlLCBuZCwgb3VyTnMsIG5hbWVzcGFjZSwgdGhhdCA9IHRoaXMsIGhhc05zOwogICAgICAgICAgICAgICAgb3VyTnMgPSB0aGF0Ll9fbmFtZXNwYWNlOwogICAgICAgICAgICAgICAgb3VyTnMgJiYgKG91ck5zID0gb3VyTnMuc3Vic3RyaW5nKDEpKTsKICAgICAgICAgICAgICAgIC8vIE5vIGV2ZW50cywgb3IgcmVtb3ZpbmcgKmFsbCogZXZlbnRzLgogICAgICAgICAgICAgICAgaWYoIShjYWxscyA9IHRoYXQuX2NhbGxiYWNrcykpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZighKGV2ZW50cyB8fCBjYWxsYmFjayB8fCBjb250ZXh0KSkgewogICAgICAgICAgICAgICAgICAgIGlmKCFvdXJOcykgewogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhhdC5fY2FsbGJhY2tzOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYnMgPSB0aGF0Ll9jYWxsYmFja3M7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSBpbiBjYnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYnNbaV1bb3VyTnNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc2l6ZShjYnNbaV0pID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNic1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIExvb3AgdGhyb3VnaCB0aGUgbGlzdGVkIGV2ZW50cyBhbmQgY29udGV4dHMsIHNwbGljaW5nIHRoZW0gb3V0IG9mIHRoZQogICAgICAgICAgICAgICAgLy8gbGlua2VkIGxpc3Qgb2YgY2FsbGJhY2tzIGlmIGFwcHJvcHJpYXRlLgogICAgICAgICAgICAgICAgb3VyTnMgJiYgKGV2ZW50cyA9IG5vcm1hbGl6ZUV2ZW50cyhldmVudHMsIHRoYXQuX19uYW1lc3BhY2UpKTsKICAgICAgICAgICAgICAgIHZhciBldmVudHNBcnJheSA9IGV2ZW50cyA/IGV2ZW50cy5zcGxpdChldmVudFNwbGl0dGVyKSA6IF8ua2V5cyhjYWxscyk7CiAgICAgICAgICAgICAgICB3aGlsZShldmVudCA9IGV2ZW50c0FycmF5LnNoaWZ0KCkpIHsKICAgICAgICAgICAgICAgICAgICBuZCA9IGdldE5hbWVzcGFjZURhdGEoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgIGV2ZW50ID0gbmQuZXZlbnQ7CiAgICAgICAgICAgICAgICAgICAgbmFtZXNwYWNlID0gbmQubmFtZXNwYWNlOwogICAgICAgICAgICAgICAgICAgIGhhc05zID0gISFuYW1lc3BhY2U7CiAgICAgICAgICAgICAgICAgICAgaWYoIW91ck5zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBjYWxsc1tldmVudF07CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYWxsc1tldmVudF07CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGNhbGxzW2V2ZW50XSkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gY2FsbHNbZXZlbnRdW291ck5zXTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2V2ZW50XVtvdXJOc107CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHNpemUoY2FsbHNbZXZlbnRdKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2V2ZW50XTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZighbm9kZSB8fCAhKGNhbGxiYWNrIHx8IGNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvKmlmIChldmVudCAhPT0gU1RBUkFMTCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGNhbGxzW2V2ZW50XTsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2FsbHNbZXZlbnRdOwogICAgICAgICAgICAgICAgICAgIGlmICghbm9kZSkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfSovCiAgICAgICAgICAgICAgICAgICAgaWYoZXZlbnQgIT09IFNUQVJBTEwgJiYgIWNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9vZmZQcm9jZXNzTm9kZSh0aGF0LCBldmVudCwgbm9kZSwgY2FsbGJhY2ssIGNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihldmVudCA9PT0gQUxMIHx8ICFjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGkgaW4gY2FsbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGhhc05zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gY2FsbHNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNhbGxzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9vZmZQcm9jZXNzTm9kZSh0aGF0LCBpLCBub2RlLCBjYWxsYmFjaywgY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBfb2ZmUHJvY2Vzc05vZGUodGhhdCwgZXZlbnQsIG5vZGUsIGNhbGxiYWNrLCBjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhhdDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX19wdWJTdWJOYW1lOiAvKioKICAgICAgICAgICAgVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAgICAgICAgIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAgICAgICAgICh1bmxlc3MgeW91J3JlIGxpc3RlbmluZyBvbiBgImFsbCJgLCB3aGljaCB3aWxsIGNhdXNlIHlvdXIgY2FsbGJhY2sgdG8KICAgICAgICAgICAgcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgICAgICAgICAKICAgICAgICAgICAgQG1ldGhvZCBmaXJlCiAgICAgICAgICAgIEBwYXJhbSB7T2JqZWN0fSBldmVudHMgVGhlIGV2ZW50cyB0byBiZSBmaXJlZC4KICAgICAgICAgICAgZGVsaW1pdGVkIGJ5IGEgc3BhY2UuCiAgICAgICAgICAgIEBwYXJhbSBbYXJnc10qIFRoZSBhcmd1bWVudHMgdG8gcGFzcyBvbnRvIHRoZSBjYWxsYmFjayBtZXRob2RzLgogICAgICAgICAgICBAcmV0dXJucyB7QXJyYXkgb2YgVmFsdWVzfSBJZiBtb3JlIHRoYW4gb24gZXZlbnQgaXMgZmlyZWQsIGFuIE9iamVjdCBvZiBBcnJheXMgaXMgcmV0dXJuZWQuCiAgICAgICAgICAgICoqLwogICAgICAgICAgICAnRXZlbnRzJywKICAgICAgICAgICAgaW5pdEV2ZW50czogLyoqCiAgICAgICAgICAgIEluaXQncyB0aGUgRXZlbnQgbW9kdWxlLgogICAgICAgICAgICBUaGlzIGlzIG9ubHkgcmVxdWlyZWQgaWYgeW91IHdpc2ggdG8gdXNlIGZpcmUuYXN5bmMsIGFuZCBuYW1lc3BhY2luZy4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2QgaW5pdEV2ZW50cwogICAgICAgICAgICBAY2hhaW5hYmxlCiAgICAgICAgICAgICoqLwogICAgICAgICAgICBmdW5jdGlvbiAoZGVmYXVsdENvbnRleHQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZmlyZSA9IHRoaXMucHVibGlzaCA9IGNyZWF0ZUFzeW5jRXZlbnQodGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLmluaXRFdmVudHMgPSBub29wOwogICAgICAgICAgICAgICAgdGhpcy5fX3B1YlN1Yk5hbWUgPSB0aGlzLm5hbWUgfHwgJ0V2ZW50cyc7CiAgICAgICAgICAgICAgICBpZih0aGlzLm5hbWUgJiYgIXRoaXMuX19uYW1lc3BhY2UpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9fbmFtZXNwYWNlID0gJy4nICsgdGhpcy5uYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5fX2RlZmF1bHRDb250ZXh0ID0gZGVmYXVsdENvbnRleHQ7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZXh0ZW5kOiAvKioKICAgICAgICAgICAgRXh0ZW5kcyBFdmVudHMgaW50byB0aGUgZ2l2ZW4gb2JqZWN0LgogICAgICAgICAgICAKICAgICAgICAgICAgQG1ldGhvZCBleHRlbmQKICAgICAgICAgICAgQHBhcmFtIHtPYmplY3R9IHRvIFRoZSBvYmplY3Qgb3QgZXh0ZW5kIGV2ZW50cyBvbnRvCiAgICAgICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gW2luaXRdIE9wdGlvbmFsbHkgaW5pdCB0aGUgZXZlbnRzLgogICAgICAgICAgICAqKi8KICAgICAgICAgICAgZnVuY3Rpb24gKHRvLCBpbml0KSB7CiAgICAgICAgICAgICAgICBfLmV4dGVuZCh0bywgZXhwb3J0cy5FdmVudHMpOwogICAgICAgICAgICAgICAgZGVsZXRlIHRvLmV4dGVuZDsKICAgICAgICAgICAgICAgIGluaXQgJiYgdG8uaW5pdEV2ZW50cygpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRvOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBldmVudHMuZmlyZSA9IGV2ZW50cy5wdWJsaXNoID0gY3JlYXRlQXN5bmNFdmVudCh7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGV2ZW50czsKICAgIH0pKCk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWV2ZW50cy5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9mYWNhZGUnLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC91dGlsJywgJy4vY2Fwc3VsZSddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXywgX190bV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSJpbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgdG0gPSBfX3RtX187CgogICAgdmFyIE1vZHVsZSA9IHRtLk1vZHVsZTsKICAgIC8qKgogICAgCiAgICBUaGUgRmFjYWRlIG1vZHVsZSBvZmZlcnMgdGhlIGFiaWxpdHkgdG8gY3JlYXRlIGFuIGludGVyZmFjZSBvciBzaW1pbGFyIGNvbmNlcHQuCiAgICBXaXRoIHRoZSBGYWNhZGUgaW4gdGhydXN0LCBpdCBhbGxvd3MgeW91IHRvIGNhcHR1cmUgZXZlbnRzIGZyb20gYSBtb2R1bGUsIHdoZW4gbG9hZGVkIHZpYSBjb252ZW50aW9uLgogICAgRmFjYWRlcyBhcmUgbWFpbmx5IGZvciB1c2UgaW4gdGhydXN0IHBsdWdpbnMuCiAgICAKICAgIEBtb2R1bGUgdGhydXN0CiAgICAqKi8KICAgIC8qKgogICAgRmFjYWRlcyBhcmUgbWFpbmx5IGZvciB1c2UgaW4gdGhydXN0IHBsdWdpbnMuCiAgICAKICAgIEZhY2FkZSBoYXMgdGhlc2UgYnVpbHQgaW4gbWV0aG9kczoKICAgICogaW5pdAogICAgKiBzdGFydAogICAgKiByZWFkeQogICAgKiBzdG9wCiAgICAqIGRlc3Ryb3kKICAgIAogICAgQmVoaW5kIHRoZSBzY2VuZXMgdGhlIGZhY2FkZSBtZXRob2RzLCBpbnZva2UgYW55IGNvbnZlbnRpb25zIGxvYWRlZCBmb3IgdGhlIHBsdWdpbi4KICAgIAogICAgQGNsYXNzIHRocnVzdC5GYWNhZGUKICAgICoqLwogICAgdmFyIHRocnVzdENhY2hlID0gTW9kdWxlLnRocnVzdENhY2hlOwogICAgdmFyIGZhY2FkZU1ldGhvZHMgPSBbCiAgICAgICAgJ2luaXQnLCAKICAgICAgICAnc3RhcnQnLCAKICAgICAgICAncmVhZHknLCAKICAgICAgICAnc3RvcCcsIAogICAgICAgICdkZXN0cm95JwogICAgXSwgZGVmYXVsdFByb3RvdHlwZSA9IHsKICAgIH07CiAgICBmdW5jdGlvbiBjb252ZW50aW9uRnVuY3Rpb25GYWN0b3J5KG5hbWUpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgcmV0dXJuVmFsdWVzID0gW107CiAgICAgICAgICAgIGlmKG0gJiYgISgobSkuY29udmVudGlvbikpIHsKICAgICAgICAgICAgICAgIG0gPSB0aHJ1c3RDYWNoZVttLm1pZF0ubW9kdWxlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoYXQuX19jb252ZW50aW9ucykgewogICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwuc2FmZUludm9rZSh0aGF0Ll9fY29udmVudGlvbnMsIG5hbWUsIG0sIHRoYXQpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIG1ldGhvZFdyYXAobWV0aG9kKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChmKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgZi5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgcmV0dXJuIG1ldGhvZC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9OwogICAgfQogICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IGZhY2FkZU1ldGhvZHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IGZhY2FkZU1ldGhvZHNbaV07CiAgICAgICAgZGVmYXVsdFByb3RvdHlwZVttZXRob2RdID0gY29udmVudGlvbkZ1bmN0aW9uRmFjdG9yeShtZXRob2QpOwogICAgfQogICAgLyoqCiAgICBGYWNhZGUgaW5pdAogICAgCiAgICBDYWxsZWQgZHVyaW5nIHRoZSBpbml0IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCiAgICAKICAgIEBtZXRob2QgaW5pdAogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgc3RhcnQKICAgIAogICAgQ2FsbGVkIGR1cmluZyB0aGUgc3RhcnQgcGhhc2Ugb2YgYSBtb2R1bGUgc3RhcnR1cC4KICAgIAogICAgQG1ldGhvZCBzdGFydAogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgcmVhZHkKICAgIAogICAgQ2FsbGVkIGR1cmluZyB0aGUgcmVhZHkgcGhhc2Ugb2YgYSBtb2R1bGUgc3RhcnR1cC4KICAgIAogICAgQG1ldGhvZCByZWFkeQogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgc3RvcAogICAgCiAgICBDYWxsZWQgZHVyaW5nIHRoZSBpbml0IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCiAgICAKICAgIEBtZXRob2Qgc3RvcAogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBGYWNhZGUgZGVzdHJveQogICAgCiAgICBDYWxsZWQgZHVyaW5nIHRoZSBkZXN0cm95IHBoYXNlIG9mIGEgbW9kdWxlIHN0YXJ0dXAuCiAgICAKICAgIEBtZXRob2QgZGVzdHJveQogICAgQHJldHVybnMgUHJvbWlzZSBhbnkgZmFjYWRlIG1ldGhvZCBtYXkgb3B0aW9uYWxseSByZXR1cm4gYSBwcm9taXNlIHRvIGRlbGF5IHRoZSBzdGFydCBvZiB0aGUgbmV4dCBwaGFzZS4KICAgICoqLwogICAgLyoqCiAgICBBTUQgQVBJCiAgICBsb2FkCiAgICAKICAgIEhhbmRsZXMgZmV0Y2hpbmcgb2YgYSBtb2R1bGUgaW5zdGFuY2UKICAgIAogICAgRm9ybWF0OgogICAgdGhydXN0L2NhcHN1bGUhe2luc3RhbmNlfTp7cGx1Z2luTmFtZX06e2hhc2hLZXl9CiAgICAKICAgIGhhc0tleTogaXMgYSB1bmlxdWUga2V5LCB0aGF0IHRoZSBtb2R1bGUgc2hhcmVzIHdpdGggdGhlIGZhY2FkZSwgYWxsb3dzIGZvciBkZWZpbmluZyBkZXBlbmRlbmNpZXMKICAgIGluIHlvdXIgZGVmaW5lIGJsb2NrLCBhbmQgZ2V0IGFjY2VzcyB0byB0aGUgbW9kdWxlcyBmYWNhZGUuCiAgICAKICAgIEBtZXRob2QgbG9hZAogICAgQHN0YXRpYwogICAgQG9ic29sZXRlCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UgdGhhdCBpcyBiZWluZyBmZXRjaGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBwYXJlbnRSZXF1aXJlIHRoZSByZXF1aXJlIG1ldGhvZCB0byBiZSBsb2FkZWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IGxvYWQgQWxsb3dzIHRoZSBsb2FkIHRvIGluZm9ybSB0aGF0IEFNRCBmb3IgdGhlIHZhbHVlIHRvIGhhbmQgb2ZmCiAgICBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSBjdXN0b20gY29uZmlndXJhdGlvbi4KICAgICoqLwogICAgZnVuY3Rpb24gbG9hZChuYW1lLCBwYXJlbnRSZXF1aXJlLCBsb2FkLCBjb25maWcpIHsKICAgICAgICB2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCc6JyksIGluc3RhbmNlTmFtZSA9IHBhcnRzWzBdLCBwbHVnaW4gPSBwYXJ0c1sxXSwgcGx1Z2luTmFtZSA9IHBsdWdpbi5zdWJzdHJpbmcocGx1Z2luLmxhc3RJbmRleE9mKCcvJykgKyAxIHx8IDApLCBoYXNoS2V5ID0gcGFydHNbMl07CiAgICAgICAgaWYoIWluc3RhbmNlTmFtZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2luc3RhbmNlTmFtZSBpcyByZXF1aXJlZCEnKTsKICAgICAgICB9CiAgICAgICAgaWYoIXBsdWdpbk5hbWUpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdwbHVnaW5OYW1lIGlzIHJlcXVpcmVkIScpOwogICAgICAgIH0KICAgICAgICBpZighaGFzaEtleSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2hhc2hLZXkgaXMgcmVxdWlyZWQhJyk7CiAgICAgICAgfQogICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAndGhydXN0IScgKyBpbnN0YW5jZU5hbWUKICAgICAgICBdLCBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIHZhciB0aHJ1c3RQbHVnaW4gPSB0aHJ1c3RbcGx1Z2luTmFtZV07CiAgICAgICAgICAgIGlmKCF0aHJ1c3RQbHVnaW4pIHsKICAgICAgICAgICAgICAgIHJlcXVpcmUoWwogICAgICAgICAgICAgICAgICAgIHBsdWdpbgogICAgICAgICAgICAgICAgXSwgZnVuY3Rpb24gKHApIHsKICAgICAgICAgICAgICAgICAgICBsb2FkKHApOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRocnVzdE1vZHVsZUNhY2hlSXRlbSA9IHRocnVzdENhY2hlW2hhc2hLZXldIHx8ICh0aHJ1c3RDYWNoZVtoYXNoS2V5XSA9IHsKICAgICAgICAgICAgICAgIGZhY2FkZXM6IHsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBpbnN0YW5jZTogewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIGZhY2FkZSA9IHRocnVzdFBsdWdpbi5jcmVhdGVGYWNhZGUodGhydXN0LCB0aHJ1c3RNb2R1bGVDYWNoZUl0ZW0uaW5zdGFuY2UsIHRocnVzdE1vZHVsZUNhY2hlSXRlbS5mYWNhZGVzKTsKICAgICAgICAgICAgbG9hZChmYWNhZGUpOwogICAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5sb2FkID0gbG9hZDsKICAgIGZ1bmN0aW9uIGNyZWF0ZUZhY2FkZShpbml0TWV0aG9kKSB7CiAgICAgICAgdmFyIGYgPSAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgRmFjYWRlID0gZnVuY3Rpb24gKG1vZCkgewogICAgICAgICAgICAgICAgaW5pdE1ldGhvZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IGZhY2FkZU1ldGhvZHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1ldGhvZCA9IGZhY2FkZU1ldGhvZHNbaV07CiAgICAgICAgICAgICAgICAgICAgaWYodGhpc1ttZXRob2RdICE9PSBkZWZhdWx0UHJvdG90eXBlW21ldGhvZF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1ttZXRob2RdID0gXy53cmFwKHRoaXNbbWV0aG9kXSwgbWV0aG9kV3JhcChkZWZhdWx0UHJvdG90eXBlW21ldGhvZF0pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLm1vZCA9IG1vZDsKICAgICAgICAgICAgICAgIC8vdGhpcy5pbml0KG1vZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICBGYWNhZGUucHJvdG90eXBlID0gXy5leHRlbmQoewogICAgICAgICAgICAgICAgdXBkYXRlRmFjYWRlOiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgICAgICAgICBpbml0TWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIGRlZmF1bHRQcm90b3R5cGUpOwogICAgICAgICAgICByZXR1cm4gRmFjYWRlOwogICAgICAgIH0pKCk7CiAgICAgICAgcmV0dXJuIGY7CiAgICB9CiAgICBleHBvcnRzLmNyZWF0ZUZhY2FkZSA9IGNyZWF0ZUZhY2FkZTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9ZmFjYWRlLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2NvbnZlbnRpb24vYXV0b3N0YXJ0JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbiddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiovCiAgICAvKioKICAgICogIyBfX3RocnVzdC9tZWRpYXRvcl9fIENvbnZlbnRpb24gLSBBdXRvIFN0YXJ0CiAgICAqCiAgICAqIFRoZSBhdXRvIHN0YXJ0IHByb3BlcnR5IGFsbG93cyBmb3IgYSBtb2R1bGUsIHRvIGJlIGF1dG9tYXRpY2FsbHkgc3RhcnRlZCBvbmNlIGl0IGlzCiAgICAqIGluY2x1ZGVkIGludG8gYSB0aHJ1c3QgaW5zdG5hY2UsIHdpdGhvdXQgaGF2aW5nIHRvIGV4cGxpY2l0eSBjYWxsIHN0YXJ0IG9uIHRoZSBtb2R1bGUuCiAgICAqCiAgICAqCiAgICAqIFRoaXMgaXMgdXNlZnVsIGZvciBjZXJ0aWFuIHR5cGVzIG9mIG1vZHVsZXMsIHVzdWFsbHkgcGVyc2lzdGFudCBvbmVzIHRoYXQgYWx3YXlzIG5lZWQgdG8gbG9hZCByZWdhcmRsZXNzLgogICAgKiBGb3IgZXhhbXBsZSBhIG5hdmlnYXRpb24gbW9kdWxlLCBvciB1c2VyIHNldHRpbmdzIG1vZHVsZS4KICAgICoKICAgICogQGZvciB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiBAcHJvcGVydHkgYXV0b1N0YXJ0CiAgICAqKi8KICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgJ2NvbmZpZy5hdXRvU3RhcnQnCiAgICAgICAgXQogICAgfTsKICAgIGV4cG9ydHMuYXV0b3N0YXJ0ID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWF1dG9zdGFydC5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9jb252ZW50aW9uL2NvbnRhaW5lcicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL21lZGlhdG9yL21lZGlhdG9yLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiovCiAgICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgIGFueUNvbnRhaW5lcjogJ3RocnVzdC9jb252ZW50aW9uL2NvbnRhaW5lci9hbnknLAogICAgICAgIGNoYW5nZUNvbnRhaW5lcjogJ3RocnVzdC9jb252ZW50aW9uL2NvbnRhaW5lci9jaGFuZ2UnCiAgICB9LCBhbnkgPSBfLmFueSwgYmluZCA9IF8uYmluZCwgQ09OVEFJTkVSID0gJ2NvbmZpZy5jb250YWluZXInLCBTVEFSVCA9ICdzdGFydC1zdGF0dXMnLCBkZWZlciA9IF8uZGVmZXI7CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBwcm9wZXJ0aWVzOiBbCiAgICAgICAgICAgIENPTlRBSU5FUgogICAgICAgIF0sCiAgICAgICAgY2hhbmdlOiBmdW5jdGlvbiAobW9kLCBjb250YWluZXIpIHsKICAgICAgICAgICAgdmFyIGNvbnRhaW5lclZhbHVlID0gbW9kLmNvbnZlbnRpb24oQ09OVEFJTkVSKTsKICAgICAgICAgICAgaWYoY29udGFpbmVyVmFsdWUgJiYgY29udGFpbmVyICYmIGNvbnRhaW5lclZhbHVlID09PSBjb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGlmKG1vZC5jb252ZW50aW9uKFNUQVJUKSkgewogICAgICAgICAgICAgICAgICAgIGRlZmVyKGJpbmQobW9kLnN0b3AsIG1vZCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBzdGFydDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGNvbnRhaW5lclZhbHVlID0gbW9kLmNvbnZlbnRpb24oQ09OVEFJTkVSKTsKICAgICAgICAgICAgaWYoY29udGFpbmVyVmFsdWUpIHsKICAgICAgICAgICAgICAgIGZhY2FkZXMubWVkaWF0b3IuZmlyZShldmVudC5jaGFuZ2VDb250YWluZXIsIGNvbnRhaW5lclZhbHVlKTsKICAgICAgICAgICAgICAgIC8vIFN1YnNjcmlwdGlvbnMgZ2V0IHVuc3Vic2NyaWJlZCB3aGVuIHN0b3BwaW5nIGEgbW9kdWxlLCBzbyB3ZSBuZWVkIHRvIHJlc3Vic2NyaWJlIGV2ZXJ5IHRpbWUgaGVyZS4KICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgcHJvYmFibHkgYmV0dGVyLCBhcyB0aGUgZXZlbnRzIHdpbGwgYmUgbGVzcyBjaGF0dHkuCiAgICAgICAgICAgICAgICBmYWNhZGVzLm1lZGlhdG9yLnN1YnNjcmliZShldmVudC5jaGFuZ2VDb250YWluZXIsIGJpbmQodGhhdC5jaGFuZ2UsIHRoYXQsIG1vZCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuY29udGFpbmVyID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWNvbnRhaW5lci5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9jb252ZW50aW9uL2RlcGVuZGVudC5tb2R1bGVzJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICAvKioKICAgIEBtb2R1bGUgdGhydXN0Lm1lZGlhdG9yCiAgICBAc3VibW9kdWxlIHRocnVzdC5tZWRpYXRvci5jb252ZW50aW9uCiAgICAqKi8KICAgICAgICB2YXIgYW55ID0gXy5hbnksIG1hcCA9IF8ubWFwLCBETU9EVUxFUyA9ICdjb25maWcuZGVwZW5kZW50TW9kdWxlcycsIENNT0RVTEVTID0gJ2NvbmZpZy5jaGlsZE1vZHVsZXMnLCBTVEFSVCA9ICdzdGFydC1zdGF0dXMnLCBkZWZlciA9IF8uZGVmZXIsIGJpbmQgPSBfLmJpbmQ7CiAgICB2YXIgaW52b2tlZGVwZW5kZW50TW9kdWxlcyA9IGZ1bmN0aW9uIChtb2QsIG1ldGhvZCkgewogICAgICAgIHZhciByZXF1aXJlZE1vZHVsZXMgPSBtb2QuY29udmVudGlvbihETU9EVUxFUyk7CiAgICAgICAgaWYocmVxdWlyZWRNb2R1bGVzKSB7CiAgICAgICAgICAgIHJldHVybiBtb2QudGhydXN0W21ldGhvZF0ocmVxdWlyZWRNb2R1bGVzKTsKICAgICAgICB9CiAgICB9OwogICAgdmFyIGludm9rZUNoaWxkTW9kdWxlcyA9IGZ1bmN0aW9uIChtb2QsIG1ldGhvZCkgewogICAgICAgIHZhciByZXF1aXJlZE1vZHVsZXMgPSBtb2QuY29udmVudGlvbihDTU9EVUxFUyk7CiAgICAgICAgaWYocmVxdWlyZWRNb2R1bGVzKSB7CiAgICAgICAgICAgIHJldHVybiBtb2QudGhydXN0W21ldGhvZF0ocmVxdWlyZWRNb2R1bGVzKTsKICAgICAgICB9CiAgICB9OwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBETU9EVUxFUywgCiAgICAgICAgICAgIENNT0RVTEVTCiAgICAgICAgXSwKICAgICAgICBzdGFydDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgaW52b2tlZGVwZW5kZW50TW9kdWxlcyhtb2QsICdzdGFydCcpLCAKICAgICAgICAgICAgICAgIGludm9rZUNoaWxkTW9kdWxlcyhtb2QsICdzdGFydCcpCiAgICAgICAgICAgIF07CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICBpZighbW9kLnRocnVzdC5zdGFydGVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgICAgIGludm9rZWRlcGVuZGVudE1vZHVsZXMobW9kLCAncmVhZHknKSwgCiAgICAgICAgICAgICAgICAgICAgaW52b2tlQ2hpbGRNb2R1bGVzKG1vZCwgJ3JlYWR5JykKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHN0b3A6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgcmV0dXJuIGludm9rZUNoaWxkTW9kdWxlcyhtb2QsICdzdG9wJyk7CiAgICAgICAgfSwKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAobW9kLCBmYWNhZGVzKSB7CiAgICAgICAgICAgIHJldHVybiBpbnZva2VDaGlsZE1vZHVsZXMobW9kLCAnZGVzdHJveScpOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLmRlcGVuZGVudE1vZHVsZXMgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9ZGVwZW5kZW50Lm1vZHVsZXMuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvbWVkaWF0b3IvY29uZmlnJyxbInJlcXVpcmUiLCAiZXhwb3J0cyJdLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgLyoqCiAgICBQcm92aWRlcyB0aHJ1c3QgY29uZmlndXJhdGlvbgogICAgCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luLgogICAgCiAgICBUaGlzIGlzIGZvciBpbnRlcm5hbCB0aHJ1c3QgdXNlLiAgVGhydXN0IHVzZXMgdGhpcyBhcnJheSB0byBnZW5lcmF0ZSB0aGUgcHJvcGVydGllcyB0aGF0IG5lZWQgdG8gYmUgaGFuZGVkCiAgICB0byB0aGUgcGx1Z2luIGNvbnN0cnVjdG9yIG1ldGhvZC4KICAgIAogICAgQGZvciB0aHJ1c3QubWVkaWF0b3IuY29uZmlnCiAgICBAcHJpdmF0ZQogICAgQHByb3BlcnR5IHJlc29sdmUKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLnJlc29sdmUgPSBbCiAgICAgICAgJ25hbWUnLCAKICAgICAgICAnY2ZnJwogICAgXTsKICAgIC8qKgogICAgVGhlIHNldCBvZiBjb252ZW50aW9ucyB0byBsb2FkIGludG8gdGhydXN0L21lZGlhdG9yLgogICAgCiAgICBAcHJvcGVydHkgY29udmVudGlvbnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLmNvbnZlbnRpb25zID0gWwogICAgICAgICd0aHJ1c3QvbWVkaWF0b3IvY29udmVudGlvbi9zdWJzY3JpcHRpb24nCiAgICBdOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb25maWcuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvbWVkaWF0b3IvY29udmVudGlvbi9zdWJzY3JpcHRpb24nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9jb252ZW50aW9uL3N1YnNjcmlwdGlvbi5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9tZWRpYXRvci5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIC8qKgogICAgVGhlIGZhY2FkZSBjb252ZW50aW9uLCBjcmVhdGVzIHRoZSBtZWRpYXRvciBmYWNhZGUgZm9yIGVhY2ggbW9kdWxlLgogICAgCiAgICBAbW9kdWxlIHRocnVzdC5tZWRpYXRvcgogICAgQHN1Ym1vZHVsZSB0aHJ1c3QubWVkaWF0b3IuY29udmVudGlvbgogICAgKiovCiAgICAgICAgdmFyIFNVQlNDUklQVElPTlMgPSAnY29uZmlnLm1lZGlhdG9yLnN1YnNjcmlwdGlvbnMnLCBpc0Z1bmN0aW9uID0gXy5pc0Z1bmN0aW9uLCBpc1N0cmluZyA9IF8uaXNTdHJpbmcsIGlzQXJyYXkgPSBfLmlzQXJyYXksIGlzT2JqZWN0ID0gXy5pc09iamVjdCwgaXNQbGFpbk9iamVjdCA9IF8uaXNQbGFpbk9iamVjdCwgZm9yT3duID0gXy5mb3JPd24sIGVhY2ggPSBfLmVhY2g7CiAgICB2YXIgYXJyYXlTaG9ydEhhbmRBcmdzSW5PcmRlciA9IFsKICAgICAgICAnaGFuZGxlcicsIAogICAgICAgICdjb250ZXh0JwogICAgXTsKICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgU1VCU0NSSVBUSU9OUwogICAgICAgIF0sCiAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgc3Vic2NyaXB0aW9ucyA9IG1vZC5jb252ZW50aW9uKFNVQlNDUklQVElPTlMpOwogICAgICAgICAgICBpZihzdWJzY3JpcHRpb25zICYmICEoc3Vic2NyaXB0aW9ucykuX3N1YnNjcmlwdGlvbnNTZXQpIHsKICAgICAgICAgICAgICAgIHZhciBtb2R1bGVJbnN0YW5jZSA9IG1vZC5pbnN0YW5jZTsKICAgICAgICAgICAgICAgIGZvck93bihzdWJzY3JpcHRpb25zLCBmdW5jdGlvbiAoc3Vic2NyaXB0aW9uQ29sbGVjdGlvbiwgc3Vic2NyaXB0aW9uTmFtZSkgewogICAgICAgICAgICAgICAgICAgIGlmKCFpc0FycmF5KHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uQ29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgXQogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihzdWJzY3JpcHRpb25Db2xsZWN0aW9uLmxlbmd0aCAmJiAoIWlzQXJyYXkoc3Vic2NyaXB0aW9uQ29sbGVjdGlvblswXSkgfHwgaXNTdHJpbmcoc3Vic2NyaXB0aW9uQ29sbGVjdGlvblswXSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbkNvbGxlY3Rpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb25Db2xsZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVhY2goc3Vic2NyaXB0aW9uQ29sbGVjdGlvbiwgZnVuY3Rpb24gKHN1YnNjcmlwdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZihpc0FycmF5KHN1YnNjcmlwdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vbmV3U3Vic2NyaXB0aW9uLnB1c2guYXBwbHkobmV3U3Vic2NyaXB0aW9uLCBzdWJzY3JpcHRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWFjaChzdWJzY3JpcHRpb24sIGZ1bmN0aW9uIChoYW5kbGVyT2JqZWN0LCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1N1YnNjcmlwdGlvbiA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uTmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNTdHJpbmcoaGFuZGxlck9iamVjdCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2gobW9kLmluc3RhbmNlW2hhbmRsZXJPYmplY3RdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc3Vic2NyaXB0aW9uW2kgKyAxXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2goc3Vic2NyaXB0aW9uW2kgKyAxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9yZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGlzRnVuY3Rpb24oaGFuZGxlck9iamVjdCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2goaGFuZGxlck9iamVjdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHN1YnNjcmlwdGlvbltpICsgMV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1N1YnNjcmlwdGlvbi5wdXNoKHN1YnNjcmlwdGlvbltpICsgMV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihpc1BsYWluT2JqZWN0KGhhbmRsZXJPYmplY3QpICYmICgnbW9kdWxlSGFuZGxlcicgaW4gaGFuZGxlck9iamVjdCB8fCAnaGFuZGxlcicgaW4gaGFuZGxlck9iamVjdCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9uZXdTdWJzY3JpcHRpb24gPSBbc3Vic2NyaXB0aW9uTmFtZV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCdtb2R1bGVIYW5kbGVyJyBpbiBoYW5kbGVyT2JqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTdWJzY3JpcHRpb24ucHVzaChtb2QuaW5zdGFuY2VbaGFuZGxlck9iamVjdC5tb2R1bGVIYW5kbGVyXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoJ2hhbmRsZXInIGluIGhhbmRsZXJPYmplY3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlzU3RyaW5nKGhhbmRsZXJPYmplY3QpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3Vic2NyaXB0aW9uLnB1c2gobW9kLmluc3RhbmNlW2hhbmRsZXJPYmplY3QuaGFuZGxlcl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTdWJzY3JpcHRpb24ucHVzaChoYW5kbGVyT2JqZWN0LmhhbmRsZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCdjb250ZXh0JyBpbiBoYW5kbGVyT2JqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTdWJzY3JpcHRpb24ucHVzaChoYW5kbGVyT2JqZWN0LmNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKG5ld1N1YnNjcmlwdGlvbi5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhY2FkZS5zdWJzY3JpYmUuYXBwbHkoZmFjYWRlLCBuZXdTdWJzY3JpcHRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIG1vZC5jb252ZW50aW9uKFNVQlNDUklQVElPTlMpLl9zdWJzY3JpcHRpb25zU2V0ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBzdWJzY3JpcHRpb25zID0gbW9kLmNvbnZlbnRpb24oU1VCU0NSSVBUSU9OUyk7CiAgICAgICAgICAgIGlmKHN1YnNjcmlwdGlvbnMgJiYgc3Vic2NyaXB0aW9ucy5fc3Vic2NyaXB0aW9uc1NldCkgewogICAgICAgICAgICAgICAgbW9kLmNvbnZlbnRpb24oU1VCU0NSSVBUSU9OUykuX3N1YnNjcmlwdGlvbnNTZXQgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLnN1YnNjcmlwdGlvbiA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1zdWJzY3JpcHRpb24uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YS9jb25maWcnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICAvKioKICAgIFByb3ZpZGVzIHRocnVzdCBjb25maWd1cmF0aW9uCiAgICAKICAgIEBtb2R1bGUgdGhydXN0LmRhdGEKICAgIEBzdWJtb2R1bGUgdGhydXN0LmRhdGEuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luLgogICAgCiAgICBUaGlzIGlzIGZvciBpbnRlcm5hbCB0aHJ1c3QgdXNlLiAgVGhydXN0IHVzZXMgdGhpcyBhcnJheSB0byBnZW5lcmF0ZSB0aGUgcHJvcGVydGllcyB0aGF0IG5lZWQgdG8gYmUgaGFuZGVkCiAgICB0byB0aGUgcGx1Z2luIGNvbnN0cnVjdG9yIG1ldGhvZC4KICAgIAogICAgQGZvciB0aHJ1c3QuZGF0YS5jb25maWcKICAgIEBwcml2YXRlCiAgICBAcHJvcGVydHkgcmVzb2x2ZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMucmVzb2x2ZSA9IFsKICAgICAgICAnbmFtZScsIAogICAgICAgICdtZWRpYXRvcicsIAogICAgICAgICdjZmcnCiAgICBdOwogICAgLyoqCiAgICBUaGUgc2V0IG9mIGNvbnZlbnRpb25zIHRvIGxvYWQgaW50byB0aHJ1c3QvZG9tLgogICAgCiAgICBAcHJvcGVydHkgY29udmVudGlvbnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLmNvbnZlbnRpb25zID0gWwogICAgICAgICd0aHJ1c3QvZGF0YS9jb252ZW50aW9uL3N0YXJ0JwogICAgXTsKICAgIC8qKgogICAgRGVjaWRlcyBpZiBgdGhydXN0L2RhdGFgIHNob3VsZCBjYWNoZSByZXF1ZXN0cyBvciBub3QuCiAgICAKICAgIFlvdSBzaG91bGQgdHVybiB0aGlzIHRvIGBmYWxzZWAsIGlmIHlvdSBhcmUgZXhwZXJpZW5jaW5nIGNhY2hpbmcgaXNzdWVzIGFuZCBuZWVkIHRvIGRlYnVnLgogICAgCiAgICBAcHJvcGVydHkgY2FjaGUKICAgIEByZWFkT25seQogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAZGVmYXVsdCB0cnVlCiAgICAqKi8KICAgIGV4cG9ydHMuY2FjaGUgPSB0cnVlOwogICAgLyoqCiAgICAqCiAgICAqIGBzdGFydFRpbWVvdXRgIGlzIHBhcnQgb2YgcXVldWVpbmcgYnVpbHQgaW50byBgdGhydXN0L2RhdGFgLiAgSXQgZGVmaW5lcyB0aGUgd2FpdCB0aW1lIGJlZm9yZSByZXF1ZXN0cwogICAgKiBhcmUgc3RhcnRlZC4KICAgICoKICAgICoKICAgICogVGhlIHF1ZXVlaW5nIHN5c3RlbSB3b3JrcyBpbiB0aGUgZm9sbG93aWcgbWFubmVyLiAgQWxsIHJlcXVlc3RzIHRoYXQgYXJlIHF1ZXVlZCB0b2dldGhlciBwZXIgSFRUUAogICAgKiByZXF1ZXN0IG1ldGhvZCAoYEdFVGAsIGBQT1NUYCwgYFBVVGAsIGBERUxFVEVgLCBgUEFUQ0hgLCBldGMpLiAgQWZ0ZXIgdGhlIGZpcnN0IHJlcXVlc3QsIHRoZSB0aW1lcgogICAgKiBzdGFydHMsIG9uY2UgdGhlIHRpbWVvdXQgZWxhcHNlcywgYWxsIHRoZSByZXF1ZXN0cyBhcmUgc2hpcHBlZCBvZmYgYXQgb25jZS4KICAgICoKICAgICoKICAgICogVGhpcyBjb3VudGVyIGludHVpdGl2ZSBpZiB5b3UncmUgbG9va2luZyB0byBnZXQgdGhlIHJlcXVlc3QgYmFjayBpbW1lZGlhdGVseSwgYnV0IGZyb20gYSBVWCBwZXJzcGVjdGl2ZQogICAgKiB0aGlzIGFsbG93cyB0aGUgVUkgdG8gc3RheSBpbiBzeW5jIGFuZCBnaXZlIHRoZSB1c2VyIGEgY29oZXNpdmUsIGluc3RlYWQgb2Ygc2VlaW5nIGxvYWRlcnMsIHNob3cgdXAgYW5kCiAgICAqIGRpc2FwcGVhciBhdCBzZWVtaW5nbHkgcmFuZG9tIGludGVydmFscywgdGhlIHVzZXIgZG9lcyBhbiBhY3Rpb24sIGFuZCB0aGVuIHNlZXMgYSByZXNwb25zZS4KICAgICoKICAgICoKICAgICogQHByb3BlcnR5IHN0YXJ0VGltZW91dAogICAgKiBAcmVhZE9ubHkKICAgICogQHR5cGUge051bWJlcn0KICAgICogQGRlZmF1bHQgNTAwCiAgICAqKi8KICAgIGV4cG9ydHMuc3RhcnRUaW1lb3V0ID0gMTAwOwogICAgLyoqCiAgICAqCiAgICAqIGBmaW5pc2hUaW1lb3V0YCBpcyBwYXJ0IG9mIHF1ZXVlaW5nIGJ1aWx0IGludG8gYHRocnVzdC9kYXRhYC4gIEl0IGRlZmluZXMgdGhlIHdhaXQgdGltZSBiZWZvcmUgdGhlCiAgICAqIHF1ZXVlIGlzIGNvbXBsZXRlZC4gIElmIGFsbCB0aGUgcmVxdWVzdHMgZmluaXNoIGVhcmx5LCB0aGUgdGltZW91dCBpcyBjYW5jZWxlZC4KICAgICoKICAgICoKICAgICogVGhlIHF1ZXVlaW5nIHN5c3RlbSB3b3JrcyBpbiB0aGUgZm9sbG93aWcgbWFubmVyLiAgQWxsIHJlcXVlc3RzIHRoYXQgYXJlIHF1ZXVlZCB0b2dldGhlciBwZXIgSFRUUAogICAgKiByZXF1ZXN0IG1ldGhvZCAoYEdFVGAsIGBQT1NUYCwgYFBVVGAsIGBERUxFVEVgLCBgUEFUQ0hgLCBldGMpLiAgQWZ0ZXIgdGhlIHJlcXVlc3RzIGFyZSBmaXJlZCBvZmYKICAgICogYHRocnVzdC9kYXRhYCB3aWxsIHdhaXQgdW50aWwgaXQgZ2V0cyBhIHJlc3BvbnNlIGZyb20gZXZlcnlvbmUgb2YgdGhlbS4gIElmIGZvciBzb21lIHJlYXNvbiBhIHJlcXVlc3QKICAgICogdGFrZXMgdG8gbG9uZywgYW5kIHRoZSB0aW1lb3V0IGlzIGhpdCwgYWxsIHRoZSByZXF1ZXN0cyB0aGF0IGhhdmUgY29tcGxldGVkLCB3aWxsIGJlIHJlbGVhc2VlZCwgYWxsb3dpbmcKICAgICogdGhlIGFwcGxpY2F0aW9uIHRvIGNvbnRpbnVlIHVuZGlzcnVwdGVkLgogICAgKgogICAgKgogICAgKiBUaGlzIGNvdW50ZXIgaW50dWl0aXZlIGlmIHlvdSdyZSBsb29raW5nIHRvIGdldCB0aGUgcmVxdWVzdCBiYWNrIGltbWVkaWF0ZWx5LCBidXQgZnJvbSBhIFVYIHBlcnNwZWN0aXZlCiAgICAqIHRoaXMgYWxsb3dzIHRoZSBVSSB0byBzdGF5IGluIHN5bmMgYW5kIGdpdmUgdGhlIHVzZXIgYSBjb2hlc2l2ZSwgaW5zdGVhZCBvZiBzZWVpbmcgbG9hZGVycywgc2hvdyB1cCBhbmQKICAgICogZGlzYXBwZWFyIGF0IHNlZW1pbmdseSByYW5kb20gaW50ZXJ2YWxzLCB0aGUgdXNlciBkb2VzIGFuIGFjdGlvbiwgYW5kIHRoZW4gc2VlcyBhIHJlc3BvbnNlLgogICAgKgogICAgKgogICAgQHByb3BlcnR5IGZpbmlzaFRpbWVvdXQKICAgIEByZWFkT25seQogICAgQHR5cGUge051bWJlcn0KICAgIEBkZWZhdWx0IDIwMDAKICAgICoqLwogICAgZXhwb3J0cy5maW5pc2hUaW1lb3V0ID0gMjAwMDsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RhdGEvZXZlbnQudHlwZXMnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8qKgogICAgCiAgICBAbW9kdWxlIHRocnVzdC5kYXRhCiAgICBAZm9yIHRocnVzdC5kYXRhCiAgICAqKi8KICAgIC8qKgogICAgVGhlIGB0aHJ1c3QvZGF0YS93YWl0YCBldmVudCBpcyBmaXJlZCBvbmNlIGEgZGF0YSBjYWxsIGlzIG1hZGUuCiAgICAKICAgIEBldmVudCB0aHJ1c3QvZGF0YS93YWl0CiAgICBAcGFyYW0ge1N0cmluZ30gcXVlcnlJZCBUaGUgaW50ZXJuYWwgaWQgb2YgdGhlIG91dGJvdW5kIHF1ZXVlLgogICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHR5cGUgb2YgdGhlIG91dGJvdW5kIGV2ZW50IHF1ZXVlIChHZXQvUG9zdC9ldGMpCiAgICAqKi8KICAgIGV4cG9ydHMud2FpdCA9ICd0aHJ1c3QvZGF0YS93YWl0JzsKICAgIC8qKgogICAgVGhlIGB0aHJ1c3QvZGF0YS9zdGFydGAgZXZlbnQgaXMgZmlyZWQgdGhlIHF1ZXVlIGlzIHN0YXJ0ZWQuCiAgICAKICAgIEBldmVudCB0aHJ1c3QvZGF0YS9zdGFydAogICAgQHBhcmFtIHtTdHJpbmd9IHF1ZXJ5SWQgVGhlIGludGVybmFsIGlkIG9mIHRoZSBvdXRib3VuZCBxdWV1ZS4KICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSB0eXBlIG9mIHRoZSBvdXRib3VuZCBldmVudCBxdWV1ZSAoR2V0L1Bvc3QvZXRjKQogICAgQHBhcmFtIHtOdW1iZXJ9IGNvdW50IFRoZSBvdXRnb2luZyBjYWxsIGNvdW50CiAgICAqKi8KICAgIGV4cG9ydHMuc3RhcnQgPSAndGhydXN0L2RhdGEvc3RhcnQnOwogICAgLyoqCiAgICBUaGUgYHRocnVzdC9kYXRhL3N0YXR1c2AgZXZlbnQgaXMgZmlyZWQgZm9yIGV2ZXJ5IGl0ZW0gdGhhdCByZXR1cm5zIGZyb20gdGhlIHF1ZXVlLgogICAgCiAgICBOT1RFOiBJdCBpcyBlbnRpcmVseSBwb3NzaWJsZSBmb3IgYHRocnVzdC9kYXRhL3N0YXR1cyoqIHRvIGJlIGNhbGxlZCBhZnRlciBgdGhydXN0L2RhdGEvc3RvcCoqIGlmIHNldmVyYWwKICAgIGNhbGxzIHRha2UgdG8gbG9uZyB0byBjb21wbGV0ZS4gIFRoaXMgaXMgaW50ZW5kZWQsIGFuZCBwb3RlbnRpYWxseSB1c2VmdWwgaW5mb3JtYXRpb24uCiAgICAKICAgIEBldmVudCB0aHJ1c3QvZGF0YS9zdGF0dXMKICAgIEBwYXJhbSB7U3RyaW5nfSBxdWVyeUlkIFRoZSBpbnRlcm5hbCBpZCBvZiB0aGUgb3V0Ym91bmQgcXVldWUuCiAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdHlwZSBvZiB0aGUgb3V0Ym91bmQgZXZlbnQgcXVldWUgKEdldC9Qb3N0L2V0YykKICAgIEBwYXJhbSB7TnVtYmVyfSBjb3VudCBUaGUgY3VycmVudCBjb21wbGV0ZWQgY2FsbCBjb3VudCBmb3IgdGhpcyBxdWV1ZS4KICAgICoqLwogICAgZXhwb3J0cy5zdGF0dXMgPSAndGhydXN0L2RhdGEvc3RhdHVzJzsKICAgIC8qKgogICAgVGhlIGB0aHJ1c3QvZGF0YS9zdG9wYCBldmVudCBpcyBmaXJlZCB3aGVuIGFsbCBpdGVtcyBpbiB0aGUgcXVldWUgcmV0dXJuLCBvciB0aGUgZmluaXNoZWRUaW1lb3V0IHNldHRpbmcgZWxhcHNlcy4KICAgIAogICAgQGV2ZW50IHRocnVzdC9kYXRhL3N0b3AKICAgIEBwYXJhbSB7U3RyaW5nfSBxdWVyeUlkIFRoZSBpbnRlcm5hbCBpZCBvZiB0aGUgb3V0Ym91bmQgcXVldWUuCiAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdHlwZSBvZiB0aGUgb3V0Ym91bmQgZXZlbnQgcXVldWUgKEdldC9Qb3N0L2V0YykKICAgIEBwYXJhbSB7TnVtYmVyfSBjb3VudCBUaGUgKGN1cnJlbnQpIGNvbXBsZXRlZCBjYWxsIGNvdW50IGZvciB0aGlzIHF1ZXVlLgogICAgKiovCiAgICBleHBvcnRzLnN0b3AgPSAndGhydXN0L2RhdGEvc3RvcCc7CiAgICBleHBvcnRzLmV2ZW50ID0gewogICAgICAgIGJlZm9yZVNlbmQ6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvYmVmb3JlLXNlbmRgIGV2ZW50IGlzIHdyYXBwZWQgYnkgdGhydXN0LCBhbmQgZmlyZWQgdGhyb3VnaCBqUXVlcnkuCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgTk9URTogTWFya2VkIGFzIHByaXZhdGUgYmVjYXVzZSB0aGlzIGV2ZW50IGV4cG9zZXMgdW5kZXJseWluZyBqUXVlcnkgYXJndW1lbnRzLCBhbmQgbWF5CiAgICAgICAgYmUgY2hhbmdlZCBpbiB0aGUgZnV0dXJlLgogICAgICAgIAogICAgICAgIEBldmVudCB0aHJ1c3QvZGF0YS9ldmVudC9iZWZvcmUtc2VuZAogICAgICAgIEBwcml2YXRlCiAgICAgICAgKiovCiAgICAgICAgJ3RocnVzdC9kYXRhL2V2ZW50L2JlZm9yZS1zZW5kJywKICAgICAgICBzdGFydDogLyoqCiAgICAgICAgVGhlIGB0aHJ1c3QvZGF0YS9ldmVudC9zdGFydGAgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3N0YXJ0CiAgICAgICAgQHByaXZhdGUKICAgICAgICAqKi8KICAgICAgICAndGhydXN0L2RhdGEvZXZlbnQvc3RhcnQnLAogICAgICAgIHNlbmQ6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvc2VuZGAgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3NlbmQKICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgICd0aHJ1c3QvZGF0YS9ldmVudC9zZW5kJywKICAgICAgICBlcnJvcjogLyoqCiAgICAgICAgVGhlIGB0aHJ1c3QvZGF0YS9ldmVudC9lcnJvcmAgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L2Vycm9yCiAgICAgICAgQHByaXZhdGUKICAgICAgICAqKi8KICAgICAgICAndGhydXN0L2RhdGEvZXZlbnQvZXJyb3InLAogICAgICAgIHN1Y2Nlc3M6IC8qKgogICAgICAgIFRoZSBgdGhydXN0L2RhdGEvZXZlbnQvc3VjY2Vzc2AgZXZlbnQgaXMgd3JhcHBlZCBieSB0aHJ1c3QsIGFuZCBmaXJlZCB0aHJvdWdoIGpRdWVyeS4KICAgICAgICAKICAgICAgICAKICAgICAgICBOT1RFOiBNYXJrZWQgYXMgcHJpdmF0ZSBiZWNhdXNlIHRoaXMgZXZlbnQgZXhwb3NlcyB1bmRlcmx5aW5nIGpRdWVyeSBhcmd1bWVudHMsIGFuZCBtYXkKICAgICAgICBiZSBjaGFuZ2VkIGluIHRoZSBmdXR1cmUuCiAgICAgICAgCiAgICAgICAgQGV2ZW50IHRocnVzdC9kYXRhL2V2ZW50L3N1Y2Nlc3MKICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgICd0aHJ1c3QvZGF0YS9ldmVudC9zdWNlc3MnLAogICAgICAgIGNvbXBsZXRlOiAvKioKICAgICAgICBUaGUgYHRocnVzdC9kYXRhL2V2ZW50L2NvbXBsZXRlYCBldmVudCBpcyB3cmFwcGVkIGJ5IHRocnVzdCwgYW5kIGZpcmVkIHRocm91Z2ggalF1ZXJ5LgogICAgICAgIAogICAgICAgIAogICAgICAgIE5PVEU6IE1hcmtlZCBhcyBwcml2YXRlIGJlY2F1c2UgdGhpcyBldmVudCBleHBvc2VzIHVuZGVybHlpbmcgalF1ZXJ5IGFyZ3VtZW50cywgYW5kIG1heQogICAgICAgIGJlIGNoYW5nZWQgaW4gdGhlIGZ1dHVyZS4KICAgICAgICAKICAgICAgICBAZXZlbnQgdGhydXN0L2RhdGEvZXZlbnQvY29tcGxldGUKICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgICd0aHJ1c3QvZGF0YS9ldmVudC9jb21wbGV0ZScsCiAgICAgICAgc3RvcDogLyoqCiAgICAgICAgVGhlIGB0aHJ1c3QvZGF0YS9ldmVudC9zdG9wYCBldmVudCBpcyB3cmFwcGVkIGJ5IHRocnVzdCwgYW5kIGZpcmVkIHRocm91Z2ggalF1ZXJ5LgogICAgICAgIAogICAgICAgIAogICAgICAgIE5PVEU6IE1hcmtlZCBhcyBwcml2YXRlIGJlY2F1c2UgdGhpcyBldmVudCBleHBvc2VzIHVuZGVybHlpbmcgalF1ZXJ5IGFyZ3VtZW50cywgYW5kIG1heQogICAgICAgIGJlIGNoYW5nZWQgaW4gdGhlIGZ1dHVyZS4KICAgICAgICAKICAgICAgICBAZXZlbnQgdGhydXN0L2RhdGEvZXZlbnQvc3RvcAogICAgICAgIEBwcml2YXRlCiAgICAgICAgKiovCiAgICAgICAgJ3RocnVzdC9kYXRhL2V2ZW50L3N0b3AnCiAgICB9Owp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1ldmVudC50eXBlcy5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kYXRhL2V2ZW50LmZhY3RvcnknLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJywgJy4vZXZlbnQudHlwZXMnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX2V2ZW50VHlwZXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vanF1ZXJ5LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgZXZlbnRUeXBlcyA9IF9fZXZlbnRUeXBlc19fOwoKICAgIHZhciBjYW1lbENhc2UgPSB1dGlsLmNhbWVsQ2FzZSwgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGJpbmQgPSBfLmJpbmQsIGRhdGFFdmVudHMgPSBldmVudFR5cGVzLmV2ZW50LCBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwgbWVtb2l6ZSA9IF8ubWVtb2l6ZTsKICAgIC8qKgogICAgVGhlIGV2ZW50IGZhY3RvcnkgbGlua3MgalF1ZXJ5IEV2ZW50cyB1cCB0byB0aHJ1c3QgY2VudHJpYyBldmVudHMuCiAgICBUaGUgZXZlbnQgZmFjdG9yeSB3b3VsZCBiZSByZXBsYWNlZCBpZiB3ZSB3ZXJlIGV2ZXIgbW92ZWQgb2ZmIG9mIHRoZSBqUXVlcnkgZGVwZW5kYW5jeS4KICAgIAogICAgQG1vZHVsZSB0aHJ1c3QuZGF0YQogICAgKiovCiAgICB2YXIgZXZlbnRIYW5kbGVycyA9IHsKICAgICAgICAnYmVmb3JlLXNlbmQnOiAvLyBTdXBwb3J0ZWQgZXZlbnQgaGFuZGxlcnMKICAgICAgICB0cnVlLAogICAgICAgICdzZW5kJzogdHJ1ZSwKICAgICAgICAnZXJyb3InOiB0cnVlLAogICAgICAgICdzdWNjZXNzJzogdHJ1ZSwKICAgICAgICAnY29tcGxldGUnOiB0cnVlLAogICAgICAgICdzdGFydCc6IHRydWUsCiAgICAgICAgJ3N0b3AnOiB0cnVlCiAgICB9OwogICAgLyoqCiAgICBXcmFwcyBiZWZvcmVTZW5kLCB3aGljaCBpcyBhIGN1c3RvbSBwcm9wZXJ0eSBvbiB0aGUgalF1ZXJ5IGFqYXggZGF0YSBjYWxsLgogICAgCiAgICBAbWV0aG9kIGJlZm9yZVNlbmRNZXRob2QKICAgIEBwcml2YXRlCiAgICAqKi8KICAgIGZ1bmN0aW9uIGJlZm9yZVNlbmRNZXRob2QoanFYSFIsIHNldHRpbmdzKSB7CiAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi8KICAgICAgICB0aGlzLmZpcmUoZGF0YUV2ZW50c1snYmVmb3JlU2VuZCddLCBqcVhIUiwgc2V0dGluZ3MpOwogICAgfQogICAgZXhwb3J0cy5iZWZvcmVTZW5kTWV0aG9kID0gYmVmb3JlU2VuZE1ldGhvZDsKICAgIHZhciBldmVudEZhY3RvcnkgPSBtZW1vaXplKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHZhciBldnQgPSBkYXRhRXZlbnRzW2V2ZW50XTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KGV2dCk7CiAgICAgICAgICAgIHRoaXMuZmlyZS5hcHBseSh0aGlzLmZpcmUuYXN5bmMsIGFyZ3MpOwogICAgICAgIH07CiAgICB9KTsKICAgIHZhciBub3JtYWxpemVFdmVudHMgPSBmdW5jdGlvbiAoZXZ0cykgewogICAgICAgIGV2dHMgPSBldnRzLnNwbGl0KCcgJyk7CiAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IGV2dHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmKCFldmVudEhhbmRsZXJzW2V2dHNbaV1dKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdFdmVudCAiezB9IiBpcyBub3QgYSB2YWxpZCBkYXRhIGV2ZW50JywgZXZ0c1tpXSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV2dHNbaV0gPSBkYXRhRXZlbnRzW2V2dHNbaV1dOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXZ0cy5qb2luKCcgJyk7CiAgICB9OwogICAgdmFyIHNlbmRFdmVudEZhY3RvcnkgPSBmdW5jdGlvbiAoaSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoZXZlbnQsIGpxWEhSLCBzZXR0aW5ncykgewogICAgICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqLwogICAgICAgICAgICBpZighc2V0dGluZ3MuX19tZWRpYXRvcl9kYXRhX2ZpcmVkX18pIHsKICAgICAgICAgICAgICAgIGpxWEhSLmFib3J0KCk7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgYWJvcnRlZCwgYWxsIGFqYXggY2FsbHMgbXVzdCBwYXNzIHRocm91Z2ggdGhydXN0LWRhdGEuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXNldHRpbmdzLnNpbGVudCkgewogICAgICAgICAgICAgICAgZXZlbnRGYWN0b3J5KGkpLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfTsKICAgIC8qKgogICAgQmluZHMgYWxsIHRoZSBqUXVlcnkgZGF0YSBldmVudHMgYW5kIGNyZWF0ZXMgZXZlbnQgbmF0aXZlIHRocnVzdCBldmVudHMgb3V0IG9mIHRoZW0uCiAgICAKICAgIEBmb3IgdGhydXN0LmRhdGEKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIGluaXQKICAgIEBwYXJhbSB7alF1ZXJ5fSBBIGpRdWVyeSBpbnN0YW5jZSB3cmFwcGluZyAnZG9jdW1lbnQnCiAgICAqKi8KICAgIGZ1bmN0aW9uIGluaXQoakRvYykgewogICAgICAgIC8qanNoaW50IHZhbGlkdGhpczp0cnVlICovCiAgICAgICAgZm9yKHZhciBpIGluIGV2ZW50SGFuZGxlcnMpIHsKICAgICAgICAgICAgdmFyIGpxRXZ0ID0gJ2FqYXgtJyArIGksIG1ldGhvZCA9IGV2ZW50RmFjdG9yeShpKTsKICAgICAgICAgICAgaWYoaSA9PT0gJ3NlbmQnKSB7CiAgICAgICAgICAgICAgICBtZXRob2QgPSBiaW5kKHNlbmRFdmVudEZhY3RvcnkoaSksIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGpEb2Mub24oY2FtZWxDYXNlKGpxRXZ0KSArIHRoaXMubmFtZXNwYWNlLCBtZXRob2QpOwogICAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuaW5pdCA9IGluaXQ7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWV2ZW50LmZhY3RvcnkuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YS9yZXNwb25zZS5xdWV1ZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnLCAnLi9ldmVudC50eXBlcycsICdqcXVlcnknLCAndGhydXN0L2xvZycsICdoYXMnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX2V2ZW50VHlwZXNfXywgX19qUXVlcnlfXywgX19sb2dfXywgX19oYXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9kYXRhL2RhdGEuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9qcXVlcnkuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBldmVudFR5cGVzID0gX19ldmVudFR5cGVzX187CgogICAgdmFyIGpRdWVyeSA9IF9falF1ZXJ5X187CgogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgZXh0ZW5kID0gXy5leHRlbmQsIHdoZW4gPSB1dGlsLndoZW4sIHVpZCA9IF8udW5pcXVlSWQsIGFqYXggPSBqUXVlcnkuYWpheCwgZGF0YUV2ZW50V2FpdCA9IGV2ZW50VHlwZXMud2FpdCwgZGF0YUV2ZW50U3RhcnQgPSBldmVudFR5cGVzLnN0YXJ0LCBkYXRhRXZlbnRTdG9wID0gZXZlbnRUeXBlcy5zdG9wLCBkYXRhRXZlbnRTdGF0dXMgPSBldmVudFR5cGVzLnN0YXR1cywgcXVldWUgPSB7CiAgICB9LCB1cGRhdGVYSFJJbnRlcm5hbHMgPSBmdW5jdGlvbiAoZGZvLCB4aHIpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZighZGZvLl94aHIpIHsKICAgICAgICAgICAgICAgIGRmby5feGhyID0geGhyOwogICAgICAgICAgICAgICAgZGZvLmdldEFsbFJlc3BvbnNlSGVhZGVycyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGZvLl94aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZGZvLmdldFJlc3BvbnNlSGVhZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBkZm8uX3hoci5nZXRBbGxSZXNwb25zZUhlYWRlcnNnZXRSZXNwb25zZUhlYWRlcigpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGRmby5hYm9ydCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGZvLl94aHIuYWJvcnQoKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBkZm8uc2V0UmVxdWVzdEhlYWRlciA9IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBkZm8uX3hoci5zZXRSZXF1ZXN0SGVhZGVyKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGZvLnJlc3BvbnNlVGV4dCA9IHhoci5yZXNwb25zZVRleHQ7CiAgICAgICAgICAgIGRmby5yZXNwb25zZVhNTCA9IHhoci5yZXNwb25zZVhNTDsKICAgICAgICAgICAgZGZvLnJlYWR5U3RhdGUgPSB4aHIucmVhZHlTdGF0ZTsKICAgICAgICAgICAgZGZvLnN0YXR1cyA9IHhoci5zdGF0dXM7CiAgICAgICAgICAgIGRmby5zdGF0dXNUZXh0ID0geGhyLnN0YXR1c1RleHQ7CiAgICAgICAgfTsKICAgIH0sIGFyZ3VtZW50UmVzb2x2ZXIgPSBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIG1ldGhvZChfLnRvQXJyYXkoYXJndW1lbnRzKSk7CiAgICAgICAgfTsKICAgIH0sIGRlZmVyQ29udHJvbGxlckl0ZW1DYWxsYmFjayA9IGZ1bmN0aW9uIChmdW5jKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbCh0aGlzLCBhcmd1bWVudHNbMF1bMF0pOwogICAgICAgIH07CiAgICB9OwogICAgLyoqCiAgICBUaGUgcmVzcG9uc2UgcXVldWUgY2xhc3MgaGFuZGxlcyBjcmVhdGlvbiBvZiBhIHF1ZXVlIG9yIGJhdGNoaW5nIHN5c3RlbS4KICAgIFdpdGggdGhpcyBzeXN0ZW0sIHdlIGNhbiBiYXRjaCB1cCBhbGwgb3VyIHNlcnZlciByZXF1ZXN0cywgYW5kIHJlcXVlc3QgdGhlbSBmcm9tIHRoZSBzZXJ2ZXIgYWxsIGFyb3VuZCB0aGUgc2FtZSB0aW1lLgogICAgSW4gYWRkaXRpb24gdG8gdGhhdCwgd2hlbiB0aGUgcmVxdWVzdHMgY29tZSBiYWNrIHdlIGNhbiBhbHNvIHNwb29sIHRoZW0gdG9nZXRoZXIsIHNvIHRoYXQgdGhlIGNhbGxzIGRvbid0IHJlc29sdmUgdW50aWwKICAgIGVpdGhlciBhbGwgdGhlIGNhbGxzIGNvbWUgYmFjaywgb3IgYSBzcGVjaWZpYyB0aW1lIGhhcyBlbGFwc2VkLgogICAgCiAgICBAZm9yIHRocnVzdC5kYXRhCiAgICBAY2xhc3MgdGhydXN0LmRhdGEuUmVzcG9uc2VRdWV1ZQogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge3RocnVzdC5Nb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIHRvIGNyZWF0ZSB0aGUgcmVzcG9uc2UgcXVldWUgZm9yCiAgICBAcGFyYW0ge051bWJlcn0gc3RhcnRUaW1lb3V0IFRoZSB0aW1lIHRvIHdhaXQgZm9yIGFkZGl0aW9uYWwgcmVxdWVzdHMuCiAgICBAcGFyYW0ge051bWJlcn0gZmluaXNoVGltZW91dCBUaGUgbWF4aW11bSB0aW1lIHRvIHdhaXQgZm9yIHJlcXVlc3RzIHRvIHJldHVybi4KICAgICoqLwogICAgdmFyIFJlc3BvbnNlUXVldWUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFJlc3BvbnNlUXVldWUobW9kdWxlLCBzdGFydFRpbWVvdXQsIGZpbmlzaFRpbWVvdXQpIHsKICAgICAgICAgICAgdGhpcy5zdGFydFRpbWVvdXQgPSBzdGFydFRpbWVvdXQ7CiAgICAgICAgICAgIHRoaXMuZmluaXNoVGltZW91dCA9IGZpbmlzaFRpbWVvdXQ7CiAgICAgICAgICAgIHRoaXMubW9kdWxlID0gbW9kdWxlOwogICAgICAgICAgICB0aGlzLm5hbWVzcGFjZSA9IG1vZHVsZS5uYW1lc3BhY2U7CiAgICAgICAgfQogICAgICAgIFJlc3BvbnNlUXVldWUucHJvdG90eXBlLmFkZFRvUXVldWUgPSAvKioKICAgICAgICBBZGRzIGEgcmVxdWVzdCB0byB0aGUgcXVldWUKICAgICAgICBRdWV1ZXMgYXJlIHNwbGl0IHVwIGJ5IEhUVFAgdHlwZSwgc28gR0VUIHJlcXVlc3RzIGdvIHdpdGggR0VUIHJlcXVlc3RzIGFuZCBQT1NUIHJlcXVlc3RzIGdvIHdpdGggUE9TVCByZXF1ZXN0cy4KICAgICAgICAKICAgICAgICBAbWV0aG9kIGFkZFRvUXVldWUKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgcmVxdWVzdCB0eXBlIChQT1NULCBHRVQsIGV0YykKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSByZXF1ZXN0IHVybCB0byBxdWV1ZSB1cAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIFRoZSByZXF1ZXN0IG9wdGlvbnMuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIG9yIHJlamVjdCwgd2hlbiB0aGUgcmVxdWVzdCBpcyBjb21wbGV0ZWQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHR5cGUsIHVybCwgb3B0aW9ucykgewogICAgICAgICAgICB2YXIgZGZvID0gd2hlbi5kZWZlcigpLCB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYob3B0aW9ucy5iZWZvcmVTZW5kKSB7CiAgICAgICAgICAgICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgICAgICAgICAgIGRmby5wcm9ncmVzcyhmdW5jdGlvbiAoZXZlbnRUeXBlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoZXZlbnRUeXBlICYmIGV2ZW50VHlwZSA9PSAnYmVmb3JlLXNlbmQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmVTZW5kLmFwcGx5KGJlZm9yZVNlbmQsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihvcHRpb25zLmNvbXBsZXRlKSB7CiAgICAgICAgICAgICAgICBkZm8ucHJvbWlzZS5hbHdheXMob3B0aW9ucy5jb21wbGV0ZSk7CiAgICAgICAgICAgICAgICBkZWxldGUgb3B0aW9ucy5jb21wbGV0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihvcHRpb25zLnN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIGRmby5wcm9taXNlLnRoZW4ob3B0aW9ucy5zdWNjZXNzKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYob3B0aW9ucy5lcnJvcikgewogICAgICAgICAgICAgICAgZGZvLnByb21pc2Uub3RoZXJ3aXNlKG9wdGlvbnMuZXJyb3IpOwogICAgICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnMuZXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhhc1F1ZXVlID0gISFxdWV1ZVt0eXBlXSwgbGlzdCA9IHF1ZXVlW3R5cGVdIHx8IChxdWV1ZVt0eXBlXSA9IHsKICAgICAgICAgICAgfSksIHRhaWwgPSBsaXN0LnRhaWwgfHwgKGxpc3QudGFpbCA9IGxpc3QubmV4dCA9IHsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGV4dGVuZCh0YWlsLCB7CiAgICAgICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnMsCiAgICAgICAgICAgICAgICBkZm86IGRmbwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbGlzdC50YWlsID0gdGFpbC5uZXh0ID0gewogICAgICAgICAgICB9OwogICAgICAgICAgICBpZighaGFzUXVldWUpIHsKICAgICAgICAgICAgICAgIHdoZW4uZGVsYXkodGhhdC5zdGFydFRpbWVvdXQpLnRoZW4odGhhdC5wcm9jZXNzKHR5cGUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGZvLnByb21pc2U7CiAgICAgICAgfTsKICAgICAgICBSZXNwb25zZVF1ZXVlLnByb3RvdHlwZS5wcm9jZXNzID0gLyoqCiAgICAgICAgUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0IHdpbGwgcHJvY2VzcyB0aGUgZ2l2ZW4gcXVldWUgYWZ0ZXIgdGhlIHN0YXJ0IHRpbWUgaGFzIGVsYXBzZWQuCiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBwcm9jZXNzCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHF1ZXVlIHR5cGUsIHRvIHByb2Nlc3MuCiAgICAgICAgQHJldHVybnMge0Z1bmN0aW9ufSBUaGUgZnVuY3Rpb24gdGhhdCB3aWxsIGRvIHRoZSB3b3JrIG9uIHRoZSBxdWV1ZS4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodHlwZSkgewogICAgICAgICAgICB2YXIgcGFyZW50ID0gcXVldWVbdHlwZV0sIG5vZGUgPSBwYXJlbnQsIHRoYXQgPSB0aGlzLCBxdWVyeUlkID0gdWlkKCdkcScpOwogICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdEYXRhW3swfV06IENyZWF0aW5nIHF1ZXVlIGZvciB0eXBlICJ7MX0iJywgdGhhdC5uYW1lc3BhY2UsIHR5cGUpKTsKICAgICAgICAgICAgdGhhdC5tb2R1bGUuZmlyZShkYXRhRXZlbnRXYWl0LCBxdWVyeUlkLCB0eXBlKTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGZhbHNlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RhdGFbezB9XTogUHJvY2Vzc2luZyBxdWV1ZSBmb3IgdHlwZSAiezF9IicsIHRoYXQubmFtZXNwYWNlLCB0eXBlKSk7CiAgICAgICAgICAgICAgICB2YXIgd2hlblF1ZXVlID0gW10sIGRlZmVyQ29udHJvbGxlciA9IHdoZW4uZGVmZXIoKSwgcmV0dXJuQ291bnQgPSAwOwogICAgICAgICAgICAgICAgZGVmZXJDb250cm9sbGVyLnByb21pc2UudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdCgnRGF0YVt7MH1dOiBGaW5pc2hpbmcgcXVldWUgZm9yIHR5cGUgInsxfSInLCB0aGF0Lm5hbWVzcGFjZSwgdHlwZSkpOwogICAgICAgICAgICAgICAgICAgIHRoYXQubW9kdWxlLmZpcmUoZGF0YUV2ZW50U3RvcCwgcXVlcnlJZCwgdHlwZSwgcmV0dXJuQ291bnQpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBkZWxldGUgcXVldWVbdHlwZV07CiAgICAgICAgICAgICAgICB2YXIgdGFpbCA9IG5vZGUudGFpbCwgc3RhdHVzQ2FsbGJhY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5tb2R1bGUuZmlyZShkYXRhRXZlbnRTdGF0dXMsIHF1ZXJ5SWQsIHR5cGUsICsrcmV0dXJuQ291bnQpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHdoaWxlKChub2RlID0gbm9kZS5uZXh0KSAhPT0gdGFpbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBkZm8gPSBub2RlLmRmbywgb3B0aW9ucyA9IGV4dGVuZCh7CiAgICAgICAgICAgICAgICAgICAgfSwgbm9kZS5vcHRpb25zKSwgeGhyRGZvID0gd2hlbi5kZWZlcigpLCB4aHIgPSBub2RlLnhociA9IGFqYXgobm9kZS51cmwsIG9wdGlvbnMpLnRoZW4oYXJndW1lbnRSZXNvbHZlcih4aHJEZm8ucmVzb2x2ZSksIGFyZ3VtZW50UmVzb2x2ZXIoeGhyRGZvLnJlamVjdCkpOwogICAgICAgICAgICAgICAgICAgIHhockRmby5wcm9taXNlLnRoZW4oc3RhdHVzQ2FsbGJhY2spOwogICAgICAgICAgICAgICAgICAgIHdoZW5RdWV1ZS5wdXNoKHhocik7CiAgICAgICAgICAgICAgICAgICAgd2hlbi5hbGwoWwogICAgICAgICAgICAgICAgICAgICAgICB4aHJEZm8sIAogICAgICAgICAgICAgICAgICAgICAgICBkZWZlckNvbnRyb2xsZXIucHJvbWlzZQogICAgICAgICAgICAgICAgICAgIF0sIHdoZW4uYXBwbHkoZGZvLnJlc29sdmUpLCB3aGVuLmFwcGx5KGRmby5yZWplY3QpLCB1cGRhdGVYSFJJbnRlcm5hbHMoZGZvLCB4aHIpKTsKICAgICAgICAgICAgICAgICAgICBkZm8ucHJvZ3Jlc3MoJ2JlZm9yZS1zZW5kJywgWwogICAgICAgICAgICAgICAgICAgICAgICBkZm8sIAogICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zCiAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGF0Lm1vZHVsZS5maXJlKGRhdGFFdmVudFN0YXJ0LCBxdWVyeUlkLCB0eXBlLCB3aGVuUXVldWUubGVuZ3RoKTsKICAgICAgICAgICAgICAgIHdoZW4uYW55KFsKICAgICAgICAgICAgICAgICAgICB3aGVuLmFsbCh3aGVuUXVldWUpLCAKICAgICAgICAgICAgICAgICAgICB3aGVuLmRlbGF5KHRoYXQuZmluaXNoVGltZW91dCkKICAgICAgICAgICAgICAgIF0sIGRlZmVyQ29udHJvbGxlci5yZXNvbHZlLCBkZWZlckNvbnRyb2xsZXIucmVzb2x2ZSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gUmVzcG9uc2VRdWV1ZTsKICAgIH0pKCk7CiAgICBleHBvcnRzLlJlc3BvbnNlUXVldWUgPSBSZXNwb25zZVF1ZXVlOyAgICAKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9cmVzcG9uc2UucXVldWUuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZGF0YS9jb252ZW50aW9uL3N0YXJ0JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZGF0YS9kYXRhLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgd2hlbiA9IHV0aWwud2hlbjsKICAgIHZhciB3aGVuUXVldWUgPSBbXTsKICAgIGZ1bmN0aW9uIHdhaXRDYWxsYmFjayh1aWQpIHsKICAgICAgICB2YXIgZCA9IHdoZW4uZGVmZXIoKTsKICAgICAgICBkLnJlc29sdmVyWyd1aWQnXSA9IHVpZDsKICAgICAgICB3aGVuUXVldWUucHVzaCh7CiAgICAgICAgICAgIHVpZDogdWlkLAogICAgICAgICAgICByZXNvbHZlcjogZC5yZXNvbHZlcgogICAgICAgIH0pOwogICAgfQogICAgZnVuY3Rpb24gc3RvcENhbGxiYWNrKHVpZCkgewogICAgICAgIHZhciBpdGVtID0gXy5maW5kKHdoZW5RdWV1ZSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgcmV0dXJuIHgudWlkID09PSB1aWQ7CiAgICAgICAgfSk7CiAgICAgICAgd2hlblF1ZXVlID0gXy53aXRob3V0KHdoZW5RdWV1ZSwgaXRlbSk7CiAgICAgICAgaXRlbS5yZXNvbHZlci5yZXNvbHZlKCk7CiAgICB9CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBjb3VudGRvd246IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgLy8gU3Vic2NyaWJlIHRvIHRoZSB3YWl0IGFuZCBzdG9wIGV2ZW50cwogICAgICAgICAgICB0aHJ1c3QuZGF0YS5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3dhaXQnLCB3YWl0Q2FsbGJhY2spOwogICAgICAgICAgICB0aHJ1c3QuZGF0YS5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3N0b3AnLCBzdG9wQ2FsbGJhY2spOwogICAgICAgIH0sCiAgICAgICAgb3JiaXQ6IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgLy8gVW5zdWJzY3JpYmUgZnJvbSB0aGUgd2FpdCBhbmQgc3RvcCBldmVudHMKICAgICAgICAgICAgdGhydXN0LmRhdGEudW5zdWJzY3JpYmUoJ3RocnVzdC9kYXRhL3dhaXQnLCB3YWl0Q2FsbGJhY2spOwogICAgICAgICAgICB0aHJ1c3QuZGF0YS51bnN1YnNjcmliZSgndGhydXN0L2RhdGEvc3RvcCcsIHN0b3BDYWxsYmFjayk7CiAgICAgICAgICAgIC8vIGRlZmVyIHVudGlsIGFueSBvZiB0aGUgZXZlbnRzIHRoYXQgd2VyZSBjYXB0dXJlZCBhcmUgcmVzb2x2ZWQsIG9yIHRoZSBkZWxheSBwYXNzZXMuCiAgICAgICAgICAgIHZhciBkZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgaWYodGhydXN0LmNmZy5kYXRhLmZpbmlzaFRpbWVvdXQgPT09IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB3aGVuLmFsbCh3aGVuUXVldWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB3aGVuLmFueShbCiAgICAgICAgICAgICAgICB3aGVuLmFsbCh3aGVuUXVldWUpLCAKICAgICAgICAgICAgICAgIHdoZW4uZGVsYXkodGhydXN0LmNmZy5kYXRhLmZpbmlzaFRpbWVvdXQpCiAgICAgICAgICAgIF0sIGRlZmVyLnJlc29sdmUsIGRlZmVyLnJlamVjdCk7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuc3Vic2NyaXB0aW9uID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPXN0YXJ0LmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbS9jb25maWcnLFsicmVxdWlyZSIsICJleHBvcnRzIl0sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMpIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICAvKioKICAgIFJlc29sdmVzIHRoZSBnaXZlbiBwcm9wZXJ0aWVzIHdoZW4gY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhlIHBsdWdpbi4KICAgIAogICAgVGhpcyBpcyBmb3IgaW50ZXJuYWwgdGhydXN0IHVzZS4gIFRocnVzdCB1c2VzIHRoaXMgYXJyYXkgdG8gZ2VuZXJhdGUgdGhlIHByb3BlcnRpZXMgdGhhdCBuZWVkIHRvIGJlIGhhbmRlZAogICAgdG8gdGhlIHBsdWdpbiBjb25zdHJ1Y3RvciBtZXRob2QuCiAgICAKICAgIEBmb3IgdGhydXN0LmRvbS5jb25maWcKICAgIEBwcml2YXRlCiAgICBAcHJvcGVydHkgcmVzb2x2ZQogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMucmVzb2x2ZSA9IFsKICAgICAgICAnbmFtZScsIAogICAgICAgICdtZWRpYXRvcicKICAgIF07CiAgICAvKioKICAgIFRoZSBzZXQgb2YgY29udmVudGlvbnMgdG8gbG9hZCBpbnRvIHRocnVzdC9kb20uCiAgICAKICAgIEBwcm9wZXJ0eSBjb252ZW50aW9ucwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7QXJyYXl9CiAgICAqKi8KICAgIGV4cG9ydHMuY29udmVudGlvbnMgPSBbCiAgICAgICAgJ3RocnVzdC9kb20vY29udmVudGlvbi9hY3Rpb24nLCAKICAgICAgICAndGhydXN0L2RvbS9jb252ZW50aW9uL2NvbnRleHQnLCAKICAgICAgICAndGhydXN0L2RvbS9jb252ZW50aW9uL2V2ZW50JwogICAgXTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbS9zdWJqcXVlcnknLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ2pxdWVyeScsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QvbG9nJywgJ2hhcyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2pRdWVyeV9fLCBfX3V0aWxfXywgX19sb2dfXywgX19oYXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBqUXVlcnkgPSBfX2pRdWVyeV9fOwoKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgbG9nID0gX19sb2dfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICB2YXIgZm9ybWF0ID0gdXRpbC5mb3JtYXQsIGVhY2ggPSBfLmVhY2gsIGV4dGVuZCA9IF8uZXh0ZW5kLCBpc09iamVjdCA9IF8uaXNPYmplY3QsIGlzRnVuY3Rpb24gPSBfLmlzRnVuY3Rpb24sIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLCBHTE9CQUwgPSAnLmdsb2JhbCc7CiAgICB2YXIgalF1ZXJ5Rm5NZXRob2RCbGFja0xpc3QgPSBbCiAgICAgICAgJ3JlYWR5JywgCiAgICAgICAgJ2V4dGVuZCcsIAogICAgICAgICdxdWV1ZScsIAogICAgICAgICdkZXF1ZXVlJywgCiAgICAgICAgJ2NsZWFyUXVldWUnLCAKICAgICAgICAncHJvbWlzZScsIAogICAgICAgICdiaW5kJywgCiAgICAgICAgJ3VuYmluZCcsIAogICAgICAgICdsaXZlJywgCiAgICAgICAgJ2RpZScsIAogICAgICAgICdkZWxlZ2F0ZScsIAogICAgICAgICd1bmRlbGVnYXRlJywgCiAgICAgICAgJ2JsdXInLCAKICAgICAgICAnZm9jdXMnLCAKICAgICAgICAnZm9jdXNpbicsIAogICAgICAgICdmb2N1c291dCcsIAogICAgICAgICdsb2FkJywgCiAgICAgICAgJ3Jlc2l6ZScsIAogICAgICAgICdzY3JvbGwnLCAKICAgICAgICAndW5sb2FkJywgCiAgICAgICAgJ2NsaWNrJywgCiAgICAgICAgJ2RibGNsaWNrJywgCiAgICAgICAgJ21vdXNlZG93bicsIAogICAgICAgICdtb3VzZXVwJywgCiAgICAgICAgJ21vdXNlbW92ZScsIAogICAgICAgICdtb3VzZW92ZXInLCAKICAgICAgICAnbW91c2VvdXQnLCAKICAgICAgICAnbW91c2VlbnRlcicsIAogICAgICAgICdtb3VzZWxlYXZlJywgCiAgICAgICAgJ2NoYW5nZScsIAogICAgICAgICdzZWxlY3QnLCAKICAgICAgICAnc3VibWl0JywgCiAgICAgICAgJ2tleWRvd24nLCAKICAgICAgICAna2V5cHJlc3MnLCAKICAgICAgICAna2V5dXAnLCAKICAgICAgICAnZXJyb3InLCAKICAgICAgICAnc2VyaWFsaXplJywgCiAgICAgICAgJ3NlcmlhbGl6ZUFycmF5JywgCiAgICAgICAgJ2FqYXhTdGFydCcsIAogICAgICAgICdhamF4U3RvcCcsIAogICAgICAgICdhamF4Q29tcGxldGUnLCAKICAgICAgICAnYWpheEVycm9yJywgCiAgICAgICAgJ2FqYXhTdWNjZXNzJywgCiAgICAgICAgJ2FqYXhTZW5kJywgCiAgICAgICAgJ190b2dnbGUnLCAKICAgICAgICAnZmFkZVRvJywgCiAgICAgICAgJ3N0b3AnLCAKICAgICAgICAnc2xpZGVEb3duJywgCiAgICAgICAgJ3NsaWRlVXAnLCAKICAgICAgICAnc2xpZGVUb2dnbGUnLCAKICAgICAgICAnZmFkZUluJywgCiAgICAgICAgJ2ZhZGVPdXQnLCAKICAgICAgICAnZmFkZVRvZ2dsZScvKiwgJ29uJywgJ29mZicsICdvbmUnKi8gCiAgICBdOwogICAgZnVuY3Rpb24gbm9ybWFsaXplRXZlbnRzKGV2ZW50cywgbmFtZXNwYWNlKSB7CiAgICAgICAgaWYoIW5hbWVzcGFjZSkgewogICAgICAgICAgICByZXR1cm4gZXZlbnRzOwogICAgICAgIH0KICAgICAgICBpZihpc09iamVjdChldmVudHMpKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBuZXcgb2JqZWN0LCBzbyB0aGF0IG9yaWdpbmFsIG9iamVjdCB3aWxsIG5vdCBiZSBtb2RpZmllZCB3aGVuIGJpbmRpbmcuCiAgICAgICAgICAgIGV2ZW50cyA9IGV4dGVuZCh7CiAgICAgICAgICAgIH0sIGV2ZW50cyk7CiAgICAgICAgICAgIGZvcih2YXIga2V5IGluIGV2ZW50cykgewogICAgICAgICAgICAgICAgaWYoa2V5LmluZGV4T2YoJy4nKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICBldmVudHNba2V5ICsgbmFtZXNwYWNlXSA9IGV2ZW50c1trZXldOwogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBldmVudHNba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZXZlbnRzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmKCFldmVudHMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuYW1lc3BhY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZXZlbnRzID0gZXZlbnRzLnNwbGl0KCcgJyk7CiAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGlMZW4gPSBldmVudHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZ0ID0gZXZlbnRzW2ldOwogICAgICAgICAgICAgICAgaWYoZXZ0LmluZGV4T2YoJy4nKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICBldmVudHNbaV0gPSBldnQgKyBuYW1lc3BhY2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGV2ZW50cy5qb2luKCcgJyk7CiAgICAgICAgfQogICAgfQogICAgLyoKICAgIENsb25lIGpxdWVyeQogICAgUmVtb3ZlIGFsbCBleGNlc3MgbWV0aG9kcyB3ZSBkb24ndCB3YW50IHRvIGV4cG9zZSBuYXRpdmVseS4KICAgIG92ZXJybG9hZCBhbnkgbWV0aG9kcyB3ZSB3YW50IHRvIGNoYW5nZSBiZWhhdmlvciBvZiAobm90ZWFibHkgb24sIG9uZSwgYW5kIG9mZikKICAgIAogICAgSW5zdGVhZCBvZiBkdXBsaWNhdGluZyB0aGUganF1ZXJ5IGJlaGF2aW9yIHdlIGluc3RlYWQgcmVhbGlnbiBpdCB0byBvdXIgb3duLgogICAgKi8KICAgIC8vIGpRdWVyeSBzdWIKICAgIGZ1bmN0aW9uIHN1YkpRdWVyeSgpIHsKICAgICAgICB2YXIgdFF1ZXJ5ID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBjb250ZXh0LCBuYW1lc3BhY2UpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyB0UXVlcnkucHJvdG90eXBlLmluaXQoc2VsZWN0b3IsIGNvbnRleHQsIG5hbWVzcGFjZSB8fCAodGhpcyAmJiB0aGlzLm5hbWVzcGFjZSkpOwogICAgICAgIH07CiAgICAgICAgXy5tZXJnZSh0UXVlcnksIGpRdWVyeSk7CiAgICAgICAgLy8gRG8gbm90IGxpa2UKICAgICAgICAvLyBwcm9iYWJseSBuZWVkZWQgaW4gc29tZSBzcGVjaWFsIHVuaXF1ZSBjYXNlcwogICAgICAgIHRRdWVyeS5qUXVlcnkgPSBqUXVlcnk7CiAgICAgICAgLy8gZXhwb3NlIGV2ZW50cyBmb3IgZG9pbmcgc3BlY2lhbCBldmVudHMgYXMgcmVxdWlyZWQuCiAgICAgICAgdFF1ZXJ5LmV2ZW50ID0gKGpRdWVyeSkuZXZlbnQ7CiAgICAgICAgdFF1ZXJ5LmZuID0gdFF1ZXJ5LnByb3RvdHlwZSA9IGV4dGVuZCh7CiAgICAgICAgfSwgalF1ZXJ5LmZuKTsKICAgICAgICB0UXVlcnkuZm4uY29uc3RydWN0b3IgPSB0UXVlcnk7CiAgICAgICAgdFF1ZXJ5LmZuLmluaXQgPSBmdW5jdGlvbiBpbml0KHNlbGVjdG9yLCBjb250ZXh0LCBuYW1lc3BhY2UpIHsKICAgICAgICAgICAgdmFyIGlvRG9tID0gY29udGV4dCBpbnN0YW5jZW9mIHRRdWVyeTsKICAgICAgICAgICAgaWYoY29udGV4dCAmJiBjb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5ICYmICEoaW9Eb20pKSB7CiAgICAgICAgICAgICAgICBjb250ZXh0ID0gdFF1ZXJ5KGNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBqUXVlcnkuZm4uaW5pdC5jYWxsKHRoaXMsIHNlbGVjdG9yLCBjb250ZXh0LCB0UXVlcnlSb290KTsKICAgICAgICAgICAgaWYobmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICByZXN1bHQubmFtZXNwYWNlID0gbmFtZXNwYWNlOwogICAgICAgICAgICB9IGVsc2UgaWYoaW9Eb20pIHsKICAgICAgICAgICAgICAgIHJlc3VsdC5uYW1lc3BhY2UgPSBjb250ZXh0Lm5hbWVzcGFjZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH07CiAgICAgICAgdFF1ZXJ5LmZuLmluaXQucHJvdG90eXBlID0gdFF1ZXJ5LmZuOwogICAgICAgIHZhciB0UXVlcnlSb290ID0gdFF1ZXJ5KGRvY3VtZW50KTsKICAgICAgICAvLyByZW1vdmUgYWxsIG5vdCBhcHBsaWNhYmxlIG1ldGhvZHMgb2ZmIG9mIGZuLgogICAgICAgIGVhY2goalF1ZXJ5Rm5NZXRob2RCbGFja0xpc3QsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIGlmKHRRdWVyeS5mblt4XSkgewogICAgICAgICAgICAgICAgdFF1ZXJ5LmZuW3hdID0gbnVsbDsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0UXVlcnkuZm5beF07CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBfLmVhY2goWwogICAgICAgICAgICAnb24nLCAKICAgICAgICAgICAgJ29uZScsIAogICAgICAgICAgICAnb2ZmJwogICAgICAgIF0sIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIHRRdWVyeS5mblt4XSA9IF8ud3JhcCh0UXVlcnkuZm5beF0sIGZ1bmN0aW9uIChmKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMSk7IF9pKyspIHsKICAgICAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDFdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKGZvcm1hdCgndFF1ZXJ5W3swfV06IEJpbmRpbmcgJyArIHggKyAnIGV2ZW50cy4uLicsIHRoaXMubmFtZXNwYWNlKSk7CiAgICAgICAgICAgICAgICBhcmdzWzBdID0gbm9ybWFsaXplRXZlbnRzKGFyZ3NbMF0sIHRoaXMubmFtZXNwYWNlKTsKICAgICAgICAgICAgICAgIHJldHVybiBmLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICB0UXVlcnkuZm4ucXVlcnkgPSB0UXVlcnkuZm4uJCA9IHRRdWVyeS5mbi5maW5kOwogICAgICAgIHJldHVybiB0UXVlcnk7CiAgICB9CiAgICBleHBvcnRzLnRRdWVyeSA9IHN1YkpRdWVyeSgpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1zdWJqcXVlcnkuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZG9tL2NvbnZlbnRpb24vYWN0aW9uJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCcsICcuLi9zdWJqcXVlcnknXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX3N1YmpxdWVyeV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9jb252ZW50aW9uL2FjdGlvbi5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9kb20vZG9tLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIHN1YmpxdWVyeSA9IF9fc3VianF1ZXJ5X187CgogICAgdmFyICQgPSBzdWJqcXVlcnkudFF1ZXJ5OwogICAgdmFyIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCBBQ1RJT05TID0gJ2NvbmZpZy5kb20uYWN0aW9ucycsIEFDVElPTlNTSU5HTEUgPSAnYWN0aW9ucycsIFNUUklORyA9ICdzdHJpbmcnLCBSRUdJU1RSQVRJT05TID0gJ19yZWdpc3RyYXRpb25zJywgaXNGdW5jdGlvbiA9IF8uaXNGdW5jdGlvbiwgaXNTdHJpbmcgPSBfLmlzU3RyaW5nLCBpc0FycmF5ID0gXy5pc0FycmF5OwogICAgdmFyIGdldEFjdGlvbkF0dHJpYnV0ZSA9IGZ1bmN0aW9uIChldmVudE5hbWUpIHsKICAgICAgICByZXR1cm4gJ2RhdGEtYWN0aW9uLScgKyBldmVudE5hbWU7CiAgICB9OwogICAgdmFyIEFjdGlvbkhhbmRsZXIgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIEFjdGlvbkhhbmRsZXIoKSB7CiAgICAgICAgICAgIHRoaXMuZXZlbnRzID0gewogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBBY3Rpb25IYW5kbGVyLnByb3RvdHlwZS5yZWdpc3RlciA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGFjdGlvbk5hbWUsIGFjdGlvbikgewogICAgICAgICAgICB2YXIgZXZlbnRzID0gdGhpcy5ldmVudHM7CiAgICAgICAgICAgIGlmKCFldmVudHNbZXZlbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXZlbnRzW2V2ZW50TmFtZV0gPSB7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFldmVudHNbZXZlbnROYW1lXVthY3Rpb25OYW1lXSkgewogICAgICAgICAgICAgICAgZXZlbnRzW2V2ZW50TmFtZV1bYWN0aW9uTmFtZV0gPSBhY3Rpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0KCdUaGUgYWN0aW9uIHsxfSBoYW5kbGVyICJ7MH0iIGhhcyBhbHJlYWR5IGJlZW4gdGFrZW4hJywgYWN0aW9uTmFtZSwgZXZlbnROYW1lKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIEFjdGlvbkhhbmRsZXIucHJvdG90eXBlLnVucmVnaXN0ZXIgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBhY3Rpb25OYW1lKSB7CiAgICAgICAgICAgIHZhciBldmVudHMgPSB0aGlzLmV2ZW50czsKICAgICAgICAgICAgaWYoZXZlbnRzW2V2ZW50TmFtZV0gJiYgZXZlbnRzW2V2ZW50TmFtZV1bYWN0aW9uTmFtZV0pIHsKICAgICAgICAgICAgICAgIGV2ZW50c1tldmVudE5hbWVdW2FjdGlvbk5hbWVdID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgQWN0aW9uSGFuZGxlci5wcm90b3R5cGUuY2FsbGJhY2tGb3IgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCByZXR1cm5SZXN1bHRzKSB7CiAgICAgICAgICAgIHZhciBldmVudHMgPSB0aGlzLmV2ZW50cywgYWN0aW9uQXR0cmlidXRlID0gZ2V0QWN0aW9uQXR0cmlidXRlKGV2ZW50TmFtZSksIHJldHVyblJlc3VsdHNEZWZpbmVkID0gdHlwZW9mIHJldHVyblJlc3VsdHMgIT09ICd1bmRlZmluZWQnOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZVZhbHVlID0gJCh0aGlzKS5hdHRyKGFjdGlvbkF0dHJpYnV0ZSk7CiAgICAgICAgICAgICAgICBpZih0eXBlb2YgYXR0cmlidXRlVmFsdWUgPT09IFNUUklORykgewogICAgICAgICAgICAgICAgICAgIHZhciBhY3Rpb24gPSBldmVudHNbZXZlbnROYW1lXVthdHRyaWJ1dGVWYWx1ZV07CiAgICAgICAgICAgICAgICAgICAgaWYoYWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbi5oYW5kbGVyLmFwcGx5KGFjdGlvbi5jb250ZXh0IHx8IHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmKHJldHVyblJlc3VsdHNEZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXR1cm5SZXN1bHRzOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICBBY3Rpb25IYW5kbGVyLmFjdGlvbkhhbmRsZXJzID0gewogICAgICAgIH07CiAgICAgICAgQWN0aW9uSGFuZGxlci5nZXRGb3IgPSBmdW5jdGlvbiBnZXRGb3IobmFtZSkgewogICAgICAgICAgICBpZih0aGlzLmFjdGlvbkhhbmRsZXJzW25hbWVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hY3Rpb25IYW5kbGVyc1tuYW1lXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gKHRoaXMuYWN0aW9uSGFuZGxlcnNbbmFtZV0gPSBuZXcgQWN0aW9uSGFuZGxlcigpKTsKICAgICAgICB9OwogICAgICAgIHJldHVybiBBY3Rpb25IYW5kbGVyOwogICAgfSkoKTsgICAgCiAgICB2YXIgZXZlbnRzID0gewogICAgICAgIGNsaWNrOiBbCiAgICAgICAgICAgICdhJywgCiAgICAgICAgICAgICdidXR0b24nLCAKICAgICAgICAgICAgJ2lucHV0W3R5cGU9ImJ1dHRvbiJdJywgCiAgICAgICAgICAgICdpbnB1dFt0eXBlPSJzdWJtaXQiXScKICAgICAgICBdLAogICAgICAgIGRibGNsaWNrOiBbCiAgICAgICAgICAgICdhJywgCiAgICAgICAgICAgICdidXR0b24nLCAKICAgICAgICAgICAgJ2lucHV0W3R5cGU9ImJ1dHRvbiJdJywgCiAgICAgICAgICAgICdpbnB1dFt0eXBlPSJzdWJtaXQiXScKICAgICAgICBdLAogICAgICAgIG1vdXNlZW50ZXI6IFsKICAgICAgICAgICAgJycKICAgICAgICBdLAogICAgICAgIG1vdXNlbGVhdmU6IFsKICAgICAgICAgICAgJycKICAgICAgICBdLAogICAgICAgIGZvY3VzOiBbCiAgICAgICAgICAgICdpbnB1dCcKICAgICAgICBdLAogICAgICAgIGJsdXI6IFsKICAgICAgICAgICAgJ2lucHV0JwogICAgICAgIF0KICAgIH07CiAgICB2YXIgYXJyYXlTaG9ydEhhbmRBcmdzSW5PcmRlciA9IFsKICAgICAgICAnbmFtZScsIAogICAgICAgICdoYW5kbGVyJywgCiAgICAgICAgJ2NvbnRleHQnCiAgICBdOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBBQ1RJT05TCiAgICAgICAgXSwKICAgICAgICBpZ25pdGU6IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgdmFyIGFjdGlvbkhhbmRsZXIgPSBBY3Rpb25IYW5kbGVyLmdldEZvcih0aHJ1c3QubmFtZSk7CiAgICAgICAgICAgIHRocnVzdC5kb20uYWN0aW9uSGFuZGxlciA9IGFjdGlvbkhhbmRsZXI7CiAgICAgICAgICAgIHZhciAkYm9keSA9ICQod2luZG93LmRvY3VtZW50LmJvZHkpOwogICAgICAgICAgICBfLmVhY2goZXZlbnRzLCBmdW5jdGlvbiAoZXZlbnRTZWxlY3RvcnMsIGV2ZW50TmFtZSkgewogICAgICAgICAgICAgICAgLy8gdXNpbmcgdGhydXN0IG5hbWUsIGFzIGNhbGxiYWNrIG5lZWRzIHRvIGJlIHBlciB0aHJ1c3QgaW5zdGFuY2UKICAgICAgICAgICAgICAgIC8vIGluIHRoZSBldmVudCBvZiBtdWx0aXBsZSB0aHJ1c3QgaW5zdGFuY2VzLgogICAgICAgICAgICAgICAgJGJvZHkub24oZXZlbnROYW1lICsgJy4nICsgQUNUSU9OU1NJTkdMRSArIHRocnVzdC5uYW1lLCBldmVudFNlbGVjdG9ycy5qb2luKGdldEFjdGlvbkF0dHJpYnV0ZShldmVudE5hbWUpICsgJywgJyksIGFjdGlvbkhhbmRsZXIuY2FsbGJhY2tGb3IoZXZlbnROYW1lLCB0cnVlKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgZGVvcmJpdDogZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB2YXIgYWN0aW9uSGFuZGxlciA9IEFjdGlvbkhhbmRsZXIuZ2V0Rm9yKHRocnVzdC5uYW1lKTsKICAgICAgICAgICAgdmFyICRib2R5ID0gJCh3aW5kb3cuZG9jdW1lbnQuYm9keSk7CiAgICAgICAgICAgIF8uZWFjaChldmVudHMsIGZ1bmN0aW9uIChldmVudFNlbGVjdG9ycywgZXZlbnROYW1lKSB7CiAgICAgICAgICAgICAgICAkYm9keS5vZmYoJy4nICsgQUNUSU9OU1NJTkdMRSArIHRocnVzdC5uYW1lKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICByZWFkeTogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBhY3Rpb25zID0gbW9kLmNvbnZlbnRpb24oQUNUSU9OUyksIGFjdGlvbkhhbmRsZXIgPSBBY3Rpb25IYW5kbGVyLmdldEZvcihtb2QudGhydXN0Lm5hbWUpLCBkb20gPSBmYWNhZGUsIG1vZHVsZUluc3RhbmNlID0gbW9kLmluc3RhbmNlOwogICAgICAgICAgICBpZihhY3Rpb25zKSB7CiAgICAgICAgICAgICAgICBfLmZvck93bihhY3Rpb25zLCBmdW5jdGlvbiAoYWN0aW9uQ29sbGVjdGlvbiwgZXZlbnROYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoIWlzQXJyYXkoYWN0aW9uQ29sbGVjdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uQ29sbGVjdGlvbiA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbkNvbGxlY3Rpb24KICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoYWN0aW9uQ29sbGVjdGlvbi5sZW5ndGggJiYgKCFpc0FycmF5KGFjdGlvbkNvbGxlY3Rpb25bMF0pIHx8IGlzU3RyaW5nKGFjdGlvbkNvbGxlY3Rpb25bMF0pKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25Db2xsZWN0aW9uID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uQ29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBfLmVhY2goYWN0aW9uQ29sbGVjdGlvbiwgZnVuY3Rpb24gKGFjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZihpc0FycmF5KGFjdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdBY3Rpb24gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdW5kZWZpbmVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGFycmF5U2hvcnRIYW5kQXJnc0luT3JkZXIsIGZ1bmN0aW9uICh4LCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeCA9PT0gJ2hhbmRsZXInICYmIGlzU3RyaW5nKGFjdGlvbltpXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uW2ldID0gbW9kLmluc3RhbmNlW2FjdGlvbltpXV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0FjdGlvblt4XSA9IGFjdGlvbltpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gbmV3QWN0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhY3Rpb25OYW1lID0gYWN0aW9uLm5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFhY3Rpb24uaGFuZGxlciAmJiBhY3Rpb24ubW9kdWxlSGFuZGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uLmhhbmRsZXIgPSBtb2QuaW5zdGFuY2VbYWN0aW9uLm1vZHVsZUhhbmRsZXJdOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoIWFjdGlvbi5oYW5kbGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ011c3QgZGVmaW5lIGVpdGhlciBhIGhhbmRsZXIgb3IgbW9kdWxlIGhhbmRsZXIuJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uSGFuZGxlci5yZWdpc3RlcihldmVudE5hbWUsIGFjdGlvbk5hbWUsIGFjdGlvbik7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKG1vZCwgZmFjYWRlKSB7CiAgICAgICAgICAgIHZhciBhY3Rpb25zID0gbW9kLmNvbnZlbnRpb24oQUNUSU9OUyksIGFjdGlvbkhhbmRsZXIgPSBBY3Rpb25IYW5kbGVyLmdldEZvcihtb2QudGhydXN0Lm5hbWUpLCBtb2R1bGVJbnN0YW5jZSA9IG1vZC5pbnN0YW5jZTsKICAgICAgICAgICAgaWYoYWN0aW9ucykgewogICAgICAgICAgICAgICAgZm9yKHZhciBhY3Rpb25FdmVudCBpbiBhY3Rpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGlvbkNvbGxlY3Rpb24gPSBhY3Rpb25zW2FjdGlvbkV2ZW50XTsKICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGFjdGlvbk5hbWUgaW4gYWN0aW9uQ29sbGVjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25IYW5kbGVyLnVucmVnaXN0ZXIoYWN0aW9uRXZlbnQsIGFjdGlvbk5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLmFjdGlvbiA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1hY3Rpb24uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZG9tL2NvbnZlbnRpb24vYW5pbWF0ZS5jb250YWluZXInLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9kb20vY29udmVudGlvbi9jb250ZXh0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9kb20uZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvdGhydXN0LmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgdmFyIGMgPSBfX2NfXzsKCiAgICB2YXIgQ29udmVudGlvbiA9IGMuQ29udmVudGlvbjsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgZXZlbnQgPSB7CiAgICAgICAgYW55Q29udGFpbmVyOiAndGhydXN0LWNvbnZlbnRpb24tY29udGFpbmVyLWFueScsCiAgICAgICAgY2hhbmdlQ29udGFpbmVyOiAndGhydXN0LWNvbnZlbnRpb24tY29udGFpbmVyLWNoYW5nZScKICAgIH0sIGFueSA9IF8uYW55LCBkZWZlciA9IF8uZGVmZXIsIGJpbmQgPSBfLmJpbmQsIFNUQVJUID0gJ3N0YXJ0LXN0YXR1cycsIEFOSU1BVEUgPSAnYW5pbWF0ZScsIENPTlRBSU5FUiA9ICdjb250YWluZXInLCBDT05URVhUID0gJ2NvbnRleHQnOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBBTklNQVRFCiAgICAgICAgXSwKICAgICAgICBpbml0OiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBtZWRpYXRvciA9IG1vZC5pbnN0YW5jZS5tZWRpYXRvcjsKICAgICAgICAgICAgbWVkaWF0b3Iuc3Vic2NyaWJlKGV2ZW50LmNoYW5nZUNvbnRhaW5lciwgYmluZCh0aGF0LmNoYW5nZSwgdGhhdCwgbW9kKSk7CiAgICAgICAgfSwKICAgICAgICBjaGFuZ2U6IGZ1bmN0aW9uIChtb2R1bGUsIGNvbnRhaW5lcikgewogICAgICAgICAgICBpZihtb2R1bGUuY29udmVudGlvbihDT05UQUlORVIpID09PSBjb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGlmKG1vZHVsZS5jb252ZW50aW9uKFNUQVJUKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBhbmltYXRlID0gbW9kdWxlLmNvbnZlbnRpb24oQU5JTUFURSk7CiAgICAgICAgICAgICAgICAgICAgaWYoYW5pbWF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29udGV4dE5vZGUgPSBtb2R1bGUuaW5zdGFuY2UuZG9tKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHROb2RlLnJlbW92ZUNsYXNzKGFuaW1hdGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGFuaW1hdGUgPSBtb2QuY29udmVudGlvbihBTklNQVRFKSwgY29udGFpbmVyID0gbW9kLmNvbnZlbnRpb24oQ09OVEFJTkVSKSwgY29udGV4dCA9IG1vZC5jb252ZW50aW9uKENPTlRFWFQpLCBkb20gPSBmYWNhZGU7CiAgICAgICAgICAgIGlmKGFuaW1hdGUgJiYgY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB2YXIgY2xvbmUgPSBkb20uY29udGV4dC5jbG9uZSgpLmFwcGVuZFRvKGRvbS5jb250ZXh0LnBhcmVudCgpKTsKICAgICAgICAgICAgICAgIGNsb25lLmFkZENsYXNzKGFuaW1hdGUucmVwbGFjZSgvXC4vZywgJyAnKS50cmltKCkpOwogICAgICAgICAgICAgICAgbW9kLmluc3RhbmNlLmRvbSA9IG1vZC5pbnN0YW5jZS4kID0gY2xvbmU7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGJpbmQodGhhdC5jbGVhbnVwLCB0aGF0LCBkb20uY29udGV4dC5wYXJlbnQoKSwgYW5pbWF0ZSwgY29udGV4dCksIDIwMDApOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBjbGVhbnVwOiBmdW5jdGlvbiAoY29udGFpbmVyLCBhbmltYXRlLCBjb250ZXh0KSB7CiAgICAgICAgICAgIGNvbnRhaW5lci5maW5kKGNvbnRleHQpLmZpbHRlcignOm5vdCgnICsgYW5pbWF0ZSArICcpJykucmVtb3ZlKCk7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuYW5pbWF0ZUNvbnRhaW5lciA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1hbmltYXRlLmNvbnRhaW5lci5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kb20vY29udmVudGlvbi9jb250ZXh0JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCcsICcuLi9zdWJqcXVlcnknXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fLCBfX3N1YmpxdWVyeV9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL2RvbS9jb252ZW50aW9uL2NvbnRleHQuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2RvbS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBzdWJqcXVlcnkgPSBfX3N1YmpxdWVyeV9fOwoKICAgIHZhciB0UXVlcnkgPSBzdWJqcXVlcnkudFF1ZXJ5OwogICAgdmFyIENPTlRFWFQgPSAnY29uZmlnLmRvbS5jb250ZXh0JzsKICAgIHZhciBtZXRob2RzID0gewogICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgQ09OVEVYVAogICAgICAgIF0sCiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgY29udGV4dCA9IG1vZC5jb252ZW50aW9uKENPTlRFWFQpOwogICAgICAgICAgICBpZihjb250ZXh0KSB7CiAgICAgICAgICAgICAgICBtb2QuaW5zdGFuY2UuZG9tID0gbW9kLmluc3RhbmNlLiQgPSB0UXVlcnkoY29udGV4dCwgZmFjYWRlLmNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuY29udGV4dCA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1jb250ZXh0LmpzLm1hcAo7CmRlZmluZSgndGhydXN0L2RvbS9jb252ZW50aW9uL2V2ZW50JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2NvbnZlbnRpb24vZXZlbnQuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2RvbS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBDT05URVhUID0gJ2NvbmZpZy5kb20uY29udGV4dCcsIEVWRU5UUyA9ICdjb25maWcuZG9tLmV2ZW50cycsIGlzRnVuY3Rpb24gPSBfLmlzRnVuY3Rpb24sIGlzU3RyaW5nID0gXy5pc1N0cmluZywgaXNBcnJheSA9IF8uaXNBcnJheTsKICAgIHZhciBldmVudFByb3BlcnR5TG9hZE9yZGVyID0gWwogICAgICAgICdzZWxlY3RvcicsIAogICAgICAgICdkYXRhJywgCiAgICAgICAgJ2hhbmRsZXInCiAgICBdOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBFVkVOVFMKICAgICAgICBdLAogICAgICAgIHJlYWR5OiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgdmFyIGV2ZW50cyA9IG1vZC5jb252ZW50aW9uKEVWRU5UUyksICRjb250ZXh0ID0gZmFjYWRlLmNvbnRleHQsIG1vZHVsZUluc3RhbmNlID0gbW9kLmluc3RhbmNlOwogICAgICAgICAgICBpZihldmVudHMpIHsKICAgICAgICAgICAgICAgIF8uZm9ySW4oZXZlbnRzLCBmdW5jdGlvbiAoZXZlbnRzQ29sbGVjdGlvbiwgZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAvL3ZhciBldmVudHNDb2xsZWN0aW9uID0gZXZlbnRzW2V2ZW50XTsKICAgICAgICAgICAgICAgICAgICBpZighaXNBcnJheShldmVudHNDb2xsZWN0aW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgICBldmVudHNDb2xsZWN0aW9uID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRzQ29sbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihldmVudHNDb2xsZWN0aW9uLmxlbmd0aCAmJiAoIWlzQXJyYXkoZXZlbnRzQ29sbGVjdGlvblswXSkgfHwgaXNTdHJpbmcoZXZlbnRzQ29sbGVjdGlvblswXSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50c0NvbGxlY3Rpb24gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudHNDb2xsZWN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIF8uZWFjaChldmVudHNDb2xsZWN0aW9uLCBmdW5jdGlvbiAoZGVmaW5pdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYmluZEV2ZW50ID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQKICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNBcnJheShkZWZpbml0aW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmluZEV2ZW50LnB1c2guYXBwbHkoYmluZEV2ZW50LCBkZWZpbml0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIGhhdmUgb25lIGVkZ2VjYXNlIGhlcmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSBzaG9ydCBoYW5kIGFycmF5LCBoYXMgYSBjb250ZXh0IHRoYXQgaXMgYSBzdHJpbmcgb3IgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFuZCBpdCBkb2VzbnQgaGF2ZSBpbmZvcm1hdGlvbiBmb3IgYm90aCBzZWxlY3RvciBhbmQgZGF0YSwgdGhpcyB3aWxsIGZhaWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIGNhbiByZWNvdmVyIHdoZW4gYWxsIDUgcG9zc2libGUgaXRlbXMgYXJlIGRlZmluZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGFuZGxlciA9IGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSB3ZXJlIGFza2VkIGZvciBhIG1ldGhvZCBvbiB0aGUgbW9kdWxlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNTdHJpbmcoaGFuZGxlcikgJiYgYmluZEV2ZW50Lmxlbmd0aCA9PT0gMikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMV0gPSBtb2QuaW5zdGFuY2VbaGFuZGxlcl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgLy8gV2UgZGlkbnQgZmluZCBhIGZ1bmN0aW9uIDooCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgRURHRSBDQVNFOiBJZiBjb250ZXh0IGlzIGEgZnVuY3Rpb24sIHdlIHdpbGwgYXNzdW1lIGFsbCBpcyB3ZWxsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgICAgRXZlbiBpZiB0aGUgaGFuZGxlciBpcyBhIHN0cmluZyB0aGF0IG5lZWRzIHRvIGJlIHJlZmVyZW5jZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXb3JrIGFycm91bmRzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICBTaG9ydGhhbmQ6IGFkZCBudWxsL2VtcHR5IHZhbHVlcyBmb3Igc2VsZWN0b3IgYW5kIGRhdGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICAgTG9uZ2hhbmQ6IHN3aXRjaCB0byBsb25nIGhhbmQgYXMgaXQgaGFzIG1vcmUgZXhwbGljaXQgc3ludGF4LgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWlzU3RyaW5nKGhhbmRsZXIpICYmICFpc0Z1bmN0aW9uKGhhbmRsZXIpICYmIGJpbmRFdmVudC5sZW5ndGggPiAyIHx8IGJpbmRFdmVudC5sZW5ndGggPT09IDUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyID0gYmluZEV2ZW50W2JpbmRFdmVudC5sZW5ndGggLSAyXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihpc1N0cmluZyhoYW5kbGVyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnRbYmluZEV2ZW50Lmxlbmd0aCAtIDJdID0gbW9kLmluc3RhbmNlW2hhbmRsZXJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnRbYmluZEV2ZW50Lmxlbmd0aCAtIDJdID0gXy5iaW5kKGJpbmRFdmVudFtiaW5kRXZlbnQubGVuZ3RoIC0gMl0sIGJpbmRFdmVudC5wb3AoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoaXNTdHJpbmcoaGFuZGxlcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnRbYmluZEV2ZW50Lmxlbmd0aCAtIDFdID0gbW9kLmluc3RhbmNlW2hhbmRsZXJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGV2ZW50UHJvcGVydHlMb2FkT3JkZXIsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZGVmaW5pdGlvblt4XSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBkZWZpbml0aW9uW3hdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih4ID09PSAnaGFuZGxlcicgJiYgZGVmaW5pdGlvbi5jb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IF8uYmluZCh2YWx1ZSwgZGVmaW5pdGlvbi5jb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kRXZlbnQucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2FsbCB0aGUgb24gbWV0aG9kLCB3aXRoIG91ciBhcmd1bWVudHMuCiAgICAgICAgICAgICAgICAgICAgICAgICRjb250ZXh0Lm9uLmFwcGx5KCRjb250ZXh0LCBiaW5kRXZlbnQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHN0b3A6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgZXZlbnRzID0gbW9kLmNvbnZlbnRpb24oRVZFTlRTKSwgJGNvbnRleHQgPSBmYWNhZGUuY29udGV4dDsKICAgICAgICAgICAgaWYoJGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICRjb250ZXh0Lm9mZigpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuZXZlbnQgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9ZXZlbnQuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvdGVtcGxhdGUvY29uZmlnJyxbInJlcXVpcmUiLCAiZXhwb3J0cyJdLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi8uLi9saWIvRGVmaW5pdGVseVR5cGVkL3JlcXVpcmVqcy9yZXF1aXJlLmQudHMiIC8+CiAgICAvLyBEaXNhYmxlZCB1bnRpbCBUUyBzdXBwb3J0cyBtb2R1bGUgcGVyIGZpbGUgaW4gc29tZSB3YXkgKGllIGV4cG9ydHMgaXMgZXhwb3J0cy48ZXhwb3J0PiBub3QgIGV4cG9ydHMubW9kdWxlTmFtZS48ZXhwb3J0PikKICAgIC8qZXhwb3J0IG1vZHVsZSBpbnN0YW5jZSB7Ki8KICAgIAogICAgLyoqCiAgICBQcm92aWRlcyB0aHJ1c3QgY29uZmlndXJhdGlvbgogICAgCiAgICBAbW9kdWxlIHRocnVzdC50ZW1wbGF0ZQogICAgQHN1Ym1vZHVsZSB0aHJ1c3QudGVtcGxhdGUuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luLgogICAgCiAgICBUaGlzIGlzIGZvciBpbnRlcm5hbCB0aHJ1c3QgdXNlLiAgVGhydXN0IHVzZXMgdGhpcyBhcnJheSB0byBnZW5lcmF0ZSB0aGUgcHJvcGVydGllcyB0aGF0IG5lZWQgdG8gYmUgaGFuZGVkCiAgICB0byB0aGUgcGx1Z2luIGNvbnN0cnVjdG9yIG1ldGhvZC4KICAgIAogICAgQGZvciB0aHJ1c3QudGVtcGxhdGUuY29uZmlnCiAgICBAcHJpdmF0ZQogICAgQHByb3BlcnR5IHJlc29sdmUKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLnJlc29sdmUgPSBbCiAgICAgICAgJ2NmZycsIAogICAgICAgICdkYXRhJwogICAgXTsKICAgIC8qKgogICAgVGhlIHNldCBvZiBjb252ZW50aW9ucyB0byBsb2FkIGludG8gdGhydXN0L3RlbXBsYXRlLgogICAgCiAgICBAcHJvcGVydHkgY29udmVudGlvbnMKICAgIEByZWFkT25seQogICAgQHR5cGUge0FycmF5fQogICAgKiovCiAgICBleHBvcnRzLmNvbnZlbnRpb25zID0gWwogICAgICAgICd0aHJ1c3QvdGVtcGxhdGUvY29udmVudGlvbi90ZW1wbGF0ZScsIAogICAgICAgICd0aHJ1c3QvdGVtcGxhdGUvY29udmVudGlvbi9rbm9ja291dC5lbmdpbmUnCiAgICBdOwogICAgLyoqCiAgICBNYXBzIHRoZSBhdmFpbGFibGUgdGVtcGxhdGVzLCB0byB0aGVpciBhcHByb3ByaWF0ZSBtb2R1bGUgbmFtZS4KICAgIAogICAgKipwcmVjb21waWxlZCBpcyBhIHNwZWNpYWwgY2FzZSwgYW5kIHRob3NlIG1ldGhvZHMgYXJlIGV4cGVjdGVkIHRvIGJlIGNvZGUgYnVpbHQgZnVuY3Rpb25zLgogICAgCiAgICBAcHJvcGVydHkgdHlwZXMKICAgIEByZWFkT25seQogICAgQHR5cGUge09iamVjdH0KICAgICoqLwogICAgZXhwb3J0cy50eXBlcyA9IHsKICAgICAgICAnZG9UJzogJ2RvVCcsCiAgICAgICAgJ3ByZWNvbXBpbGVkJzogdHJ1ZQogICAgfTsKICAgIC8qKgogICAgTWFwcyB0aGUgdGVtcGxhdGUgZXZhbHVhdG9ycywgc28gdGhhdCB3aGVuIGNyZWF0aW5nIGEgdGVtcGxhdGUgZm9yIGtub2Nrb3V0LCBpdCBrbm93cyBob3cgdG8gcHJvcGVybHkgb3V0cHV0IHRoZSBpbmZvcm1hdGlvbi4KICAgIAogICAgQHByb3BlcnR5IGV2YWx1YXRvcnMKICAgIEByZWFkT25seQogICAgQHR5cGUge09iamVjdH0KICAgICoqLwogICAgZXhwb3J0cy5ldmFsdWF0b3JzID0gewogICAgICAgICdkb1QnOiB7CiAgICAgICAgICAgIGxlZnQ6ICd7ez0gJywKICAgICAgICAgICAgcmlnaHQ6ICd9fScKICAgICAgICB9CiAgICB9OwogICAgLyoqCiAgICBUaGUgZGVmYXVsdCB0ZW1wbGF0ZSB0eXBlLCB1c2VkIHdoZW4gZXh0ZW5zaW9uIGlzbid0IGdpdmVuLgogICAgCiAgICBAcHJvcGVydHkgZGVmYXVsdFR5cGUKICAgIEByZWFkT25seQogICAgQHR5cGUge1N0cmluZ30KICAgIEBkZWZhdWx0ICdkb1QnCiAgICAqKi8KICAgIGV4cG9ydHMuZGVmYXVsdFR5cGUgPSAnZG9UJzsKICAgIC8qKgogICAgVGhlIGJhc2UgbG9jYXRpb24sIHJlbGF0aXZlIHRvIHRoZSBhcHBsaWNhdGlvbiBwYXRoIGZvciB0ZW1wbGF0ZSBsb2NhdGlvbi4KICAgIElmIHRlbXBsYXRlIHBhdGhzIGFyZSBnaXZlbiByZWxhdGl2ZSB0byBhcHBsaWNhdGlvbiBwYXRoLCB0aGlzIGNhbiBiZSBsZWZ0IGVtcHR5LgogICAgCiAgICBAcHJvcGVydHkgYmFzZVVybAogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7U3RyaW5nfQogICAgQGRlZmF1bHQgJycKICAgICoqLwogICAgZXhwb3J0cy5iYXNlVXJsID0gJyc7CiAgICAvKioKICAgIERlZmluZXMgdGhlIGV4dGVuc2lvbiB1c2VkIGZvciB0ZW1wbGF0ZXMgc3RvcmVkIG9uIHRoZSBzZXJ2ZXIuCiAgICAKICAgIEBwcm9wZXJ0eSBleHRlbnNpb24KICAgIEByZWFkT25seQogICAgQHR5cGUge1N0cmluZ30KICAgIEBkZWZhdWx0ICcudG1wbCcKICAgICoqLwogICAgZXhwb3J0cy5leHRlbnNpb24gPSAnLnRtcGwnOwogICAgLyoqCiAgICBEZWZpbmVzIHRoZSBBTUQgcGF0aHMgdG8gZmluZCB0aGUgZ2l2ZW4gdGVtcGxhdGUgdHlwZQogICAgCiAgICBAcHJvcGVydHkgdGVtcGxhdGVQYXRocwogICAgQHJlYWRPbmx5CiAgICBAdHlwZSB7U3RyaW5nfQogICAgQGRlZmF1bHQge30KICAgICoqLwogICAgZXhwb3J0cy50ZW1wbGF0ZVBhdGhzID0gewogICAgICAgICdkb1QnOiAnZG9UJwogICAgfTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3RlbXBsYXRlL2NvbnZlbnRpb24va25vY2tvdXQuZW5naW5lJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCcsICdrbm9ja291dCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18sIF9fa29fXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90ZW1wbGF0ZS90ZW1wbGF0ZS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIHZhciBrbyA9IF9fa29fXzsKCiAgICB2YXIgd2hlbiA9IHV0aWwud2hlbiwgZWFjaCA9IF8uZWFjaCwgaGFzT3duID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eSwgZmluZCA9IF8uZmluZCwga25vY2tvdXRUZW1wbGF0ZXMgPSB7CiAgICB9OwogICAgdmFyIGluaXRLbm9ja291dEludGVncmF0aW9uID0gZnVuY3Rpb24gKHRlbXBsYXRlTWFuYWdlcikgewogICAgICAgIHZhciBUaHJ1c3RUZW1wbGF0ZVNvdXJjZSA9IChrbykudGVtcGxhdGVTb3VyY2VzLnRocnVzdFRlbXBsYXRlID0gZnVuY3Rpb24gKHRlbXBsYXRlKSB7CiAgICAgICAgICAgIHRoaXMudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKICAgICAgICB9OwogICAgICAgIFRocnVzdFRlbXBsYXRlU291cmNlLnByb3RvdHlwZSA9IHsKICAgICAgICAgICAgdGV4dDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGF0LnRlbXBsYXRlLmh0bWw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoYXQudGVtcGxhdGUuaHRtbCA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAgICAgICAgICAvL3Rocm93IG5ldyBFcnJvcignVGhydXN0IFRlbXBsYXRlIGRvZXMgbm90IHN1cHBvcnQgcmV3cml0aW5nLi4uJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGF0YTogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgaWYoIXRoYXQudGVtcGxhdGUuZGF0YSkgewogICAgICAgICAgICAgICAgICAgIHRoYXQudGVtcGxhdGUuZGF0YSA9IHsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGF0LnRlbXBsYXRlLmRhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC50ZW1wbGF0ZS5kYXRhW2tleV0gPSBhcmd1bWVudHNbMV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIC8vIEJlZ2luIGludGVncmF0aW9uIG9mIHRlbXBsYXRlIHBsdWdpbiwgd2l0aCBLbm9ja291dC4KICAgICAgICB2YXIgb2xkRW5naW5lID0gKGtvKS5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZTsKICAgICAgICB2YXIgY29udmVudGlvblRlbXBsYXRlRW5naW5lID0gKGtvKS5jb252ZW50aW9uVGVtcGxhdGVFbmdpbmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgfTsKICAgICAgICBjb252ZW50aW9uVGVtcGxhdGVFbmdpbmUucHJvdG90eXBlID0ga28udXRpbHMuZXh0ZW5kKG5ldyAoa28pLnRlbXBsYXRlRW5naW5lKCksIHsKICAgICAgICAgICAgcmVuZGVyVGVtcGxhdGVTb3VyY2U6IGZ1bmN0aW9uICh0ZW1wbGF0ZVNvdXJjZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIGlmKHRlbXBsYXRlU291cmNlLnRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV2YWx1YXRvcnMgPSB0aGlzLmV2YWx1YXRvcnM7CiAgICAgICAgICAgICAgICAgICAgaWYoIWV2YWx1YXRvcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ldmFsdWF0b3JzID0gZXZhbHVhdG9ycyA9IHRlbXBsYXRlTWFuYWdlci5jb25maWcuZXZhbHVhdG9yc1t0ZW1wbGF0ZU1hbmFnZXIuY29uZmlnLmRlZmF1bHRUeXBlXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFyIHByZWNvbXBpbGVkID0gdGVtcGxhdGVTb3VyY2VbJ2RhdGEnXSgncHJlY29tcGlsZWQnKTsKICAgICAgICAgICAgICAgICAgICBpZighcHJlY29tcGlsZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlY29tcGlsZWQgPSB0ZW1wbGF0ZU1hbmFnZXIuY29tcGlsZSgne3sgd2l0aCgkZGF0YSkgeyB9fSAnICsgdGVtcGxhdGVTb3VyY2UudGV4dCgpICsgIiB7eyB9IH19Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlU291cmNlWydkYXRhJ10oJ3ByZWNvbXBpbGVkJywgcHJlY29tcGlsZWQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBSdW4gdGhlIHRlbXBsYXRlIGFuZCBwYXJzZSBpdHMgb3V0cHV0IGludG8gYW4gYXJyYXkgb2YgRE9NIGVsZW1lbnRzCiAgICAgICAgICAgICAgICAgICAgdmFyIHJlbmRlcmVkTWFya3VwID0gdGVtcGxhdGVTb3VyY2UudGVtcGxhdGUuY29tcGlsZWQoYmluZGluZ0NvbnRleHQpLnJlcGxhY2UoL1xzKy9nLCAiICIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiAoa28pLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KHJlbmRlcmVkTWFya3VwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBvbGRFbmdpbmUucmVuZGVyVGVtcGxhdGVTb3VyY2UuYXBwbHkob2xkRW5naW5lLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjcmVhdGVKYXZhU2NyaXB0RXZhbHVhdG9yQmxvY2s6IGZ1bmN0aW9uIChzY3JpcHQpIHsKICAgICAgICAgICAgICAgIGlmKCF0aGlzLmV2YWx1YXRvckNhY2hlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV2YWx1YXRvcnMgPSB0ZW1wbGF0ZU1hbmFnZXIuY29uZmlnLmV2YWx1YXRvcnNbdGVtcGxhdGVNYW5hZ2VyLmNvbmZpZy5kZWZhdWx0VHlwZV07CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ldmFsdWF0b3JDYWNoZSA9IGV2YWx1YXRvcnMubGVmdCArIHNjcmlwdCArIGV2YWx1YXRvcnMucmlnaHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5ldmFsdWF0b3JDYWNoZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbWFrZVRlbXBsYXRlU291cmNlOiBmdW5jdGlvbiAodGVtcGxhdGUsIHRlbXBsYXRlRG9jdW1lbnQpIHsKICAgICAgICAgICAgICAgIC8vIE5hbWVkIHRlbXBsYXRlCiAgICAgICAgICAgICAgICBpZih0eXBlb2YgdGVtcGxhdGUgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGVmaW5pdGlvbiA9IHRlbXBsYXRlTWFuYWdlci5nZXQodGVtcGxhdGUpOwogICAgICAgICAgICAgICAgICAgIGlmKGRlZmluaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBUaHJ1c3RUZW1wbGF0ZVNvdXJjZShkZWZpbml0aW9uKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gb2xkRW5naW5lLm1ha2VUZW1wbGF0ZVNvdXJjZS5hcHBseShvbGRFbmdpbmUsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICAoa28pLnNldFRlbXBsYXRlRW5naW5lKG5ldyAoa28pLmNvbnZlbnRpb25UZW1wbGF0ZUVuZ2luZSgpKTsKICAgIH07CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBjb3VudGRvd246IGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgaW5pdEtub2Nrb3V0SW50ZWdyYXRpb24odGhydXN0LnRlbXBsYXRlKTsKICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy5rbm9ja291dEVuZ2luZSA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1rbm9ja291dC5lbmdpbmUuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvdGVtcGxhdGUvY29udmVudGlvbi90ZW1wbGF0ZScsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L2NvbnZlbnRpb24nLCAndGhydXN0L3V0aWwnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX19jX18sIF9fdXRpbF9fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RlbXBsYXRlL3RlbXBsYXRlLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIFRFTVBMQVRFUyA9ICd0ZW1wbGF0ZXMnLCB3aGVuID0gdXRpbC53aGVuLCBlYWNoID0gXy5lYWNoLCBoYXNPd24gPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LCBmaW5kID0gXy5maW5kOwogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgICAgcHJvcGVydGllczogWwogICAgICAgICAgICBURU1QTEFURVMKICAgICAgICBdLAogICAgICAgIGluaXQ6IGZ1bmN0aW9uIChtb2QsIGZhY2FkZSkgewogICAgICAgICAgICB2YXIgZGVmZXIgPSB3aGVuLmRlZmVyKCk7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZXMgPSBtb2QuY29udmVudGlvbihURU1QTEFURVMpLCBpbnZlcnRlZFRlbXBsYXRlcyA9IHV0aWwuaW52ZXJ0KHRlbXBsYXRlcyksIG1vZHVsZUluc3RhbmNlID0gbW9kLmluc3RhbmNlOwogICAgICAgICAgICBpZih0ZW1wbGF0ZXMpIHsKICAgICAgICAgICAgICAgIHZhciBkZWZlcnMgPSBbXTsKICAgICAgICAgICAgICAgIGVhY2godGVtcGxhdGVzLCBmdW5jdGlvbiAodGVtcGxhdGUpIHsKICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YgdGVtcGxhdGUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycy5wdXNoKGZhY2FkZS5mZXRjaCh0ZW1wbGF0ZSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZmFjYWRlLmxvYWRpbmdQcm9taXNlID0gd2hlbi5hbGwoZGVmZXJzKS50aGVuKGZ1bmN0aW9uIChsb2FkZWRUZW1wbGF0ZXMpIHsKICAgICAgICAgICAgICAgICAgICAvKmpzaGludCBsb29wZnVuYzp0cnVlICovCiAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGludmVydGVkVGVtcGxhdGVzLCBmdW5jdGlvbiAoeCwgaSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSBfLmZpbmQobG9hZGVkVGVtcGxhdGVzLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHguc2hvcnROYW1lID09PSBpIHx8IHgubmFtZSA9PT0gaTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZUluc3RhbmNlLnRlbXBsYXRlc1tpXSA9IHRlbXBsYXRlLmNvbXBpbGVkOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHJlYWR5OiBmdW5jdGlvbiAobW9kLCBmYWNhZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhY2FkZS5sb2FkaW5nUHJvbWlzZSB8fCB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMudGVtcGxhdGUgPSBuZXcgQ29udmVudGlvbihtZXRob2RzKTsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9dGVtcGxhdGUuanMubWFwCjsKZGVmaW5lKCd0aHJ1c3Qvc3BhL2NvbmZpZycsWyJyZXF1aXJlIiwgImV4cG9ydHMiXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIC8qKgogICAgUHJvdmlkZXMgdGhydXN0IGNvbmZpZ3VyYXRpb24KICAgIAogICAgQG1vZHVsZSB0aHJ1c3Quc3BhCiAgICBAc3VibW9kdWxlIHRocnVzdC5zcGEuY29uZmlnCiAgICAqKi8KICAgIC8qKgogICAgUmVzb2x2ZXMgdGhlIGdpdmVuIHByb3BlcnRpZXMgd2hlbiBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGUgcGx1Z2luLgogICAgCiAgICBUaGlzIGlzIGZvciBpbnRlcm5hbCB0aHJ1c3QgdXNlLiAgVGhydXN0IHVzZXMgdGhpcyBhcnJheSB0byBnZW5lcmF0ZSB0aGUgcHJvcGVydGllcyB0aGF0IG5lZWQgdG8gYmUgaGFuZGVkCiAgICB0byB0aGUgcGx1Z2luIGNvbnN0cnVjdG9yIG1ldGhvZC4KICAgIAogICAgQGZvciB0aHJ1c3Quc3BhLmNvbmZpZwogICAgQHByaXZhdGUKICAgIEBwcm9wZXJ0eSByZXNvbHZlCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtBcnJheX0KICAgICoqLwogICAgZXhwb3J0cy5yZXNvbHZlID0gWwogICAgICAgICdjZmcnLCAKICAgICAgICAnbmFtZScsIAogICAgICAgICdtZWRpYXRvcicKICAgIF07CiAgICAvKioKICAgIFRoZSBzZXQgb2YgY29udmVudGlvbnMgdG8gbG9hZCBpbnRvIHRocnVzdC9tZWRpYXRvci4KICAgIAogICAgQHByb3BlcnR5IGNvbnZlbnRpb25zCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtBcnJheX0KICAgICoqLwogICAgZXhwb3J0cy5jb252ZW50aW9ucyA9IFsKICAgICAgICAndGhydXN0L3NwYS9jb252ZW50aW9uL3N0YXJ0JywgCiAgICAgICAgJ3RocnVzdC9zcGEvY29udmVudGlvbi9zcGFsaW5rJwogICAgXTsKICAgIC8qKgogICAgRGVmaW5lcyB0aGUgdmFsdWUgb2YgY3VzdG9tIHBhcmFtZXRlcnMuCiAgICBZb3UgY2FuIGFsc28gZGVmaW5lIGN1c3RvbSBwYXJhbWV0ZXJzIHRvIGJlIGEgcmVndWxhciBleHByZXNzaW9uLCBhbmQgdGhlbiB1c2UgdGhlbSBpbiB5b3VyIHJvdXRlcwogICAgCiAgICBAcHJvcGVydHkgcGFyYW1zCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtPYmplY3R9CiAgICAqKi8KICAgIGV4cG9ydHMucGFyYW1zID0gewogICAgfTsKICAgIC8qKgogICAgVGhlIHByZWRmaW5lZCByb3V0ZXMgdG8gYmUgdXNlZCBieSBzcGEuCiAgICAKICAgIEBwcm9wZXJ0eSByb3V0ZXMKICAgIEByZWFkT25seQogICAgQHR5cGUge09iamVjdH0KICAgICoqLwogICAgZXhwb3J0cy5yb3V0ZXMgPSB7CiAgICB9OwogICAgLyoqCiAgICBUaGUgZmlsZSBleHN0ZW5pb24gdGhhdCBzaG91bGQgYmUgcmVtb3ZlZCB3aGVuIHJlc29sdmluZyByb3V0ZXMgYW5kIHN0YXJ0aW5nIG1vZHVsZXMuCiAgICAKICAgIEBwcm9wZXJ0eSBmaWxlRXh0ZW5zaW9uCiAgICBAcmVhZE9ubHkKICAgIEB0eXBlIHtTdHJpbmd9CiAgICAqKi8KICAgIGV4cG9ydHMuZmlsZUV4dGVuc2lvbiA9ICcuaHRtbCc7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPWNvbmZpZy5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9zcGEvY29udmVudGlvbi9zcGFsaW5rJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QvZG9tL3N1YmpxdWVyeSddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18sIF9fc3VianF1ZXJ5X18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvZG9tL2RvbS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy9zcGEvc3BhLmQudHMiIC8+CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi8uLi9pbnRlcmZhY2VzL3RocnVzdC5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIHN1YmpxdWVyeSA9IF9fc3VianF1ZXJ5X187CgogICAgdmFyICQgPSBzdWJqcXVlcnkudFF1ZXJ5OwogICAgdmFyIHBhcnNlRnVsbEhyZWYgPSBmdW5jdGlvbiAoaHJlZikgewogICAgICAgIHZhciBiYXNlVXJsID0gbG9jYXRpb24ucGF0aG5hbWUuc3Vic3RyaW5nKDAsIGxvY2F0aW9uLnBhdGhuYW1lLmxhc3RJbmRleE9mKCcvJykpOwogICAgICAgIGlmKGhyZWYuaW5kZXhPZignLycpICE9IC0xKSB7CiAgICAgICAgICAgIGhyZWYgPSBocmVmLnN1YnN0cmluZyhocmVmLmxhc3RJbmRleE9mKCcvJykpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGhyZWYgPSAnLycgKyBocmVmOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYmFzZVVybCArIGhyZWY7CiAgICB9OwogICAgLyoqCiAgICBAbW9kdWxlIHRocnVzdC5kb20KICAgIEBzdWJtb2R1bGUgdGhydXN0LmRvbS5jb252ZW50aW9uCiAgICAqKi8KICAgIC8qKgogICAgKiAjIF9fdGhydXN0L2RvbV9fIENvbnZlbnRpb24gLSBTaW5nbGUgUGFnZSBBcHAgTGluawogICAgKgogICAgKiBSZXF1aXJlcyB0aHJ1c3QvZG9tCiAgICAqCiAgICAqIEBmb3IgdGhydXN0LmRvbS5jb252ZW50aW9uCiAgICAqIEBwcm9wZXJ0eSBzcGE7aW5rCiAgICAqKi8KICAgIHZhciBtZXRob2RzID0gewogICAgICAgIG9yYml0OiBmdW5jdGlvbiAodGhydXN0KSB7CiAgICAgICAgICAgIHZhciBjb25maWcgPSB0aHJ1c3QuY29uZmlnLCBzcGEgPSB0aHJ1c3Quc3BhOwogICAgICAgICAgICAkLm9uKCdjbGljaycsICdhJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgIHZhciBsaW5rID0gcGFyc2VGdWxsSHJlZih0aGlzLmdldEF0dHJpYnV0ZSgnaHJlZicpKTsKICAgICAgICAgICAgICAgIGlmKGxpbmsuaW5kZXhPZihjb25maWcudXJsLnBhdGgpID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgc3BhLm5hdmlnYXRlKGxpbmspOwogICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuc3BhbGluayA9IG5ldyBDb252ZW50aW9uKG1ldGhvZHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1zcGFsaW5rLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3NwYS9jb252ZW50aW9uL3N0YXJ0JyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICd0aHJ1c3QvY29udmVudGlvbicsICd0aHJ1c3QvdXRpbCddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX2NfXywgX191dGlsX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2ludGVyZmFjZXMvc3BhL3NwYS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90ZW1wbGF0ZS90ZW1wbGF0ZS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vaW50ZXJmYWNlcy90aHJ1c3QuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgYyA9IF9fY19fOwoKICAgIHZhciBDb252ZW50aW9uID0gYy5Db252ZW50aW9uOwogICAgdmFyIHV0aWwgPSBfX3V0aWxfXzsKCiAgICB2YXIgXyA9IHV0aWwuXzsKICAgIC8qKgogICAgQG1vZHVsZSB0aHJ1c3Quc3BhCiAgICBAc3VibW9kdWxlIHRocnVzdC5zcGEuY29udmVudGlvbgogICAgKiovCiAgICAvKioKICAgICogIyBfX3RocnVzdC9zcGFfXyBDb252ZW50aW9uIC0gU3RhcnQKICAgICoKICAgICogVGhlIHNpbmdsZSBwYWdlIGFwcCBzdGFydCBjb252ZW50aW9uLCBkb2VzIHRoZSBhY3R1YWwgc3RhcnRpbmcgb2YgdGhlIHBsdWdpbiwgaW4gYWRkaXRpb24gaXQgYWxzbyBkZWxheXMKICAgICogZnVsbCBvcmJpdCwgdW50aWwgYW55IG1vZHVsZSBpdCBoYXMgc3RhcnRlZCBoYXMgYmVlbiBsb2FkZWQuCiAgICAqCiAgICAqIEBmb3IgdGhydXN0LnNwYS5jb252ZW50aW9uCiAgICAqIEBwcm9wZXJ0eSBzdGFydAogICAgKiovCiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgICBvcmJpdDogZnVuY3Rpb24gKHRocnVzdCkgewogICAgICAgICAgICB2YXIgcm91dGVyID0gdGhydXN0LnNwYTsKICAgICAgICAgICAgcm91dGVyLnN0YXJ0KCk7CiAgICAgICAgICAgIHJldHVybiB0aHJ1c3Quc3BhLnN0YXJ0aW5nTW9kdWxlUHJvbWlzZSB8fCBudWxsOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLnN0YXJ0ID0gbmV3IENvbnZlbnRpb24obWV0aG9kcyk7Cn0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPXN0YXJ0LmpzLm1hcAo7CmRlZmluZSgndGhydXN0L21lZGlhdG9yL21haW4nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC91dGlsJywgJ3RocnVzdC9sb2cnLCAndGhydXN0L2V2ZW50cycsICd0aHJ1c3QvZmFjYWRlJywgJ2hhcycsICd0aHJ1c3QvY29uZmlnJywgJy4vY29uZmlnJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fdXRpbF9fLCBfX2xvZ19fLCBfX2V2ZW50c19fLCBfX2ZhY2FkZV9fLCBfX2hhc19fLCBfX2NvbmZpZ19fLCBfX21lZGlhdG9yQ29uZmlnX18pIHsKICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2hhcy5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9tZWRpYXRvci9tZWRpYXRvci5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgbG9nID0gX19sb2dfXzsKCiAgICAvL2ltcG9ydCBldmVudHMgPSBtb2R1bGUoJ3RocnVzdC9ldmVudHMnKTsKICAgIHZhciBldmVudHMgPSBfX2V2ZW50c19fOwoKICAgIHZhciBFdmVudHMgPSBldmVudHMuRXZlbnRzOwogICAgdmFyIGZhY2FkZSA9IF9fZmFjYWRlX187CgogICAgdmFyIGhhcyA9IF9faGFzX187CgogICAgdmFyIGNvbmZpZyA9IF9fY29uZmlnX187CgogICAgdmFyIG1lZGlhdG9yQ29uZmlnID0gX19tZWRpYXRvckNvbmZpZ19fOwoKICAgIGV4cG9ydHMuY2xhc3NOYW1lID0gJ01lZGlhdG9yJzsKICAgIC8vIFZhcmlhYmxlIGRlY2xhcmF0aW9uLgogICAgICAgIHZhciBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgZXh0ZW5kID0gLy8gc3RyaW5nIGZvcm1hdCBtZXRob2QKICAgIF8uZXh0ZW5kLCB3aGVuID0gLy8gb2JqZWN0IGV4dGVuc2lvbiBtZXRob2QKICAgIHV0aWwud2hlbiwgbWVtb2l6ZSA9IF8ubWVtb2l6ZSwgbWVkaWF0b3IsIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwogICAgdmFyIGMgPSBjb25maWc7CiAgICAvLyNyZWdpb24gRmFjYWRlCiAgICAvKioKICAgIENyZWF0ZXMgYSBuZXcgbWVkaWF0b3IgZmFjYWRlIGZvciB0aGUgZ2l2ZW4gbW9kdWxlLgogICAgCiAgICBAZm9yIHRocnVzdC5tZWRpYXRvcgogICAgQGNsYXNzIHRocnVzdC5tZWRpYXRvci5NZWRpYXRvckZhY2FkZQogICAgQGNvbnN0cnVjdG9yCiAgICBAcGFyYW0ge3RocnVzdC5Nb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlIHRvIGNyZWF0ZSB0aGUgZmFjYWRlIGZvcgogICAgQHBhcmFtIHt0aHJ1c3QuTWVkaWF0b3J9IHBhcmVudCBUaGUgcGFyZW50IG1lZGlhdG9yIHRvIGNyZWF0ZSB0aGUgZmFjYWRlIG9uLgogICAgKiovCiAgICB2YXIgTWVkaWF0b3JGYWNhZGUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBtZWRpYXRvckZhY2FkZSA9IGZhY2FkZS5jcmVhdGVGYWNhZGUoZnVuY3Rpb24gKG1vZHVsZSwgcGFyZW50KSB7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IG1vZHVsZS5uYW1lOwogICAgICAgICAgICB0aGlzLm1vZHVsZSA9IG1vZHVsZTsKICAgICAgICAgICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CiAgICAgICAgICAgIHRoaXMuX19jb252ZW50aW9ucyA9IHBhcmVudC5fX2NvbnZlbnRpb25zOwogICAgICAgICAgICB0aGlzLl9jYWxsYmFja3MgPSBwYXJlbnQuX2NhbGxiYWNrczsKICAgICAgICAgICAgdGhpcy5pbml0RXZlbnRzKG1vZHVsZSk7CiAgICAgICAgfSk7CiAgICAgICAgXy5leHRlbmQobWVkaWF0b3JGYWNhZGUucHJvdG90eXBlLCBFdmVudHMpOwogICAgICAgIC8qKgogICAgICAgIER1cmluZyB0aGUgc3RhcnQgb2YgYSBtZWRpYXRvciBmYWNhZGUsIHN0YXJ0IGNyZWF0ZXMgdGhlIGludGVybmFsIHN1YnNjcmlwdGlvbnMgYXJyYXkuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QubWVkaWF0b3IuTWVkaWF0b3JGYWNhZGUKICAgICAgICBAbWV0aG9kIHN0YXJ0CiAgICAgICAgKiovCiAgICAgICAgbWVkaWF0b3JGYWNhZGUucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbiAobSkgewogICAgICAgICAgICBpZighdGhpcy5faW50ZXJuYWxTdWJzY3JpcHRpb25zKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9pbnRlcm5hbFN1YnNjcmlwdGlvbnMgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIG1lZGlhdG9yRmFjYWRlLnByb3RvdHlwZS5zdGFydCA9IG1lZGlhdG9yRmFjYWRlLnByb3RvdHlwZS5pbml0OwogICAgICAgIC8qKgogICAgICAgIE92ZXJyaWRlcyB0aGUgc3Vic2NyaWJlIG1ldGhvZCwgYW5kIHRyYWNrcyB0aGUgYW55IGV2ZW50IHRoYXQgaXMgYm91bmQuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QubWVkaWF0b3IuTWVkaWF0b3JGYWNhZGUKICAgICAgICBAbWV0aG9kIHN1YnNjcmliZQogICAgICAgICoqLwogICAgICAgIChtZWRpYXRvckZhY2FkZSkucHJvdG90eXBlLnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgICAgIHRoaXMuX2ludGVybmFsU3Vic2NyaXB0aW9ucy5wdXNoKHsKICAgICAgICAgICAgICAgIGV2ZW50czogZXZlbnRzLAogICAgICAgICAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrLAogICAgICAgICAgICAgICAgY29udGV4dDogY29udGV4dAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgRXZlbnRzLnN1YnNjcmliZS5jYWxsKHRoaXMsIGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpOwogICAgICAgIH07CiAgICAgICAgLyoqCiAgICAgICAgVW5zdWJzY3JpYmVzIGZyb20gYWxsIGV2ZW50cyB0aGF0IHdlcmUgc3Vic2NyaWJlZCB0by4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5tZWRpYXRvci5NZWRpYXRvckZhY2FkZQogICAgICAgIEBtZXRob2Qgc3RvcAogICAgICAgICoqLwogICAgICAgIG1lZGlhdG9yRmFjYWRlLnByb3RvdHlwZS5zdG9wID0gZnVuY3Rpb24gKG0pIHsKICAgICAgICAgICAgaWYodGhpcy5faW50ZXJuYWxTdWJzY3JpcHRpb25zKSB7CiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSB0aGlzLl9pbnRlcm5hbFN1YnNjcmlwdGlvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc3ViID0gdGhpcy5faW50ZXJuYWxTdWJzY3JpcHRpb25zW2ldOwogICAgICAgICAgICAgICAgICAgIHRoaXMudW5zdWJzY3JpYmUoc3ViLmV2ZW50cywgc3ViLmNhbGxiYWNrLCBzdWIuY29udGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9pbnRlcm5hbFN1YnNjcmlwdGlvbnMgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIG1lZGlhdG9yRmFjYWRlOwogICAgfSkoKTsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8gT3VyIGRlZmF1bHQgbmFtZXNwYWNlIHByZWZpeC4KICAgIC8qKgogICAgTWVkaWF0b3IgY2xhc3MuCiAgICBUaGlzIGNyZWF0ZXMgYSBpbnN0YW5jZSBvZiB0aGUgbWVkaWF0b3IsIGZvciB1c2UgaW5zaWRlIHRocnVzdC4KICAgIAogICAgQGZvciB0aHJ1c3QubWVkaWF0b3IKICAgIEBjbGFzcyB0aHJ1c3QubWVkaWF0b3IuTWVkaWF0b3IKICAgIEBjb25zdHJ1Y3RvcgogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIG1lZGlhdG9yLgogICAgKiovCiAgICB2YXIgTWVkaWF0b3IgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIC8vI2VuZHJlZ2lvbgogICAgICAgIGZ1bmN0aW9uIE1lZGlhdG9yKG5hbWUsIGNvbmZpZykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGFwcFBhdGggPSBjb25maWcgJiYgY29uZmlnLnVybCAmJiBjb25maWcudXJsLnBhdGg7CiAgICAgICAgICAgIHRoYXQubmFtZSA9IG5hbWU7CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ01lZGlhdG9yOiBDcmVhdGluZyBuZXcgTWVkaWF0b3IgezB9JywgbmFtZSkpOwogICAgICAgICAgICB0aGF0LmluaXRFdmVudHMoKTsKICAgICAgICAgICAgdGhhdC5zdWJzY3JpYmUoJ3RocnVzdC9yZWFkeScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGZhbHNlICYmIGxvZy5pbmZvKCdNZWRpYXRvcjogUmVhZHkhJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBNZWRpYXRvci5wcm90b3R5cGUuaW5pdEV2ZW50cyA9IC8vI3JlZ2lvbiBFdmVudHMKICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgfTsKICAgICAgICBNZWRpYXRvci5wcm90b3R5cGUuZXh0ZW5kID0gZnVuY3Rpb24gKHRvLCBpbml0KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgTWVkaWF0b3IucHJvdG90eXBlLnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0LCBvbmNlKSB7CiAgICAgICAgfTsKICAgICAgICBNZWRpYXRvci5wcm90b3R5cGUudW5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIH07CiAgICAgICAgTWVkaWF0b3IucHJvdG90eXBlLm9uY2UgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIH07CiAgICAgICAgTWVkaWF0b3IucHJvdG90eXBlLmNyZWF0ZUZhY2FkZSA9IGZ1bmN0aW9uICh0aHJ1c3QsIG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICBpZihmYWNhZGVzLm1lZGlhdG9yICYmICEoZmFjYWRlcy5tZWRpYXRvciBpbnN0YW5jZW9mIE1lZGlhdG9yRmFjYWRlKSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCcibWVkaWF0b3IiIGlzIGEgcmVzZXJ2ZWQgcHJvcGVydHknKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbWVkaWF0b3I7CiAgICAgICAgICAgIGlmKGZhY2FkZXMubWVkaWF0b3IpIHsKICAgICAgICAgICAgICAgIGZhY2FkZXMubWVkaWF0b3IudXBkYXRlRmFjYWRlKG1vZCwgdGhpcyk7CiAgICAgICAgICAgICAgICBtZWRpYXRvciA9IGZhY2FkZXMubWVkaWF0b3I7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtZWRpYXRvciA9IGZhY2FkZXMubWVkaWF0b3IgPSAobW9kKS5tZWRpYXRvciA9IG5ldyBNZWRpYXRvckZhY2FkZShtb2QsIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtZWRpYXRvcjsKICAgICAgICB9OwogICAgICAgIE1lZGlhdG9yLmNvbmZpZyA9IG1lZGlhdG9yQ29uZmlnOwogICAgICAgIHJldHVybiBNZWRpYXRvcjsKICAgIH0pKCk7CiAgICBleHBvcnRzLk1lZGlhdG9yID0gTWVkaWF0b3I7ICAgIAogICAgLy8gR2V0IHRoZSBhY3R1YWwgZXZlbnQgbWV0aG9kcyBvbnRvIHRoZSBNZWRpYXRvcgogICAgXy5leHRlbmQoTWVkaWF0b3IucHJvdG90eXBlLCBFdmVudHMpOwp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L21lZGlhdG9yJywgWyd0aHJ1c3QvbWVkaWF0b3IvbWFpbiddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgpkZWZpbmUoJ3RocnVzdC9kYXRhL21haW4nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC9jb252ZW50aW9uJywgJ3RocnVzdC91dGlsJywgJ2pxdWVyeScsICd0aHJ1c3QvbG9nJywgJy4vY29uZmlnJywgJ3RocnVzdC9jb25maWcnLCAnLi9ldmVudC5mYWN0b3J5JywgJy4vcmVzcG9uc2UucXVldWUnLCAndGhydXN0L2V2ZW50cycsICd0aHJ1c3QvZmFjYWRlJywgJy4vZXZlbnQudHlwZXMnLCAnaGFzJ10sIGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIF9fY19fLCBfX3V0aWxfXywgX19qUXVlcnlfXywgX19sb2dfXywgX19jb25maWdfXywgX190Q29uZmlnX18sIF9fZXZlbnRGYWN0b3J5X18sIF9fcmVzcG9uc2VRdWV1ZV9fLCBfX2V2ZW50c19fLCBfX2ZhY2FkZV9fLCBfX2V2ZW50VHlwZXNfXywgX19oYXNfXykgewogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy9kYXRhL2RhdGEuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uL2pxdWVyeS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciBjID0gX19jX187CgogICAgdmFyIENvbnZlbnRpb24gPSBjLkNvbnZlbnRpb247CiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIGpRdWVyeSA9IF9falF1ZXJ5X187CgogICAgdmFyIGxvZyA9IF9fbG9nX187CgogICAgdmFyIGNvbmZpZyA9IF9fY29uZmlnX187CgogICAgdmFyIHRDb25maWcgPSBfX3RDb25maWdfXzsKCiAgICB2YXIgZXZlbnRGYWN0b3J5ID0gX19ldmVudEZhY3RvcnlfXzsKCiAgICB2YXIgcmVzcG9uc2VRdWV1ZSA9IF9fcmVzcG9uc2VRdWV1ZV9fOwoKICAgIHZhciBSZXNwb25zZVF1ZXVlID0gcmVzcG9uc2VRdWV1ZS5SZXNwb25zZVF1ZXVlOwogICAgdmFyIGV2ZW50cyA9IF9fZXZlbnRzX187CgogICAgdmFyIEV2ZW50cyA9IGV2ZW50cy5FdmVudHM7CiAgICB2YXIgZmFjYWRlID0gX19mYWNhZGVfXzsKCiAgICB2YXIgZXZlbnRUeXBlcyA9IF9fZXZlbnRUeXBlc19fOwoKICAgIHZhciBoYXMgPSBfX2hhc19fOwoKICAgIGV4cG9ydHMuY2xhc3NOYW1lID0gJ0RhdGEnOwogICAgY29uZmlnOwogICAgLy8gVmFyaWFibGUgZGVjbGFyYXRpb24uCiAgICAgICAgdmFyIGZvcm1hdCA9IHV0aWwuZm9ybWF0LCBleHRlbmQgPSBfLmV4dGVuZCwgd2hlbiA9IHV0aWwud2hlbiwgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsIGFqYXggPSBqUXVlcnkuYWpheCwgdWlkID0gXy51bmlxdWVJZCwgZGF0YUV2ZW50V2FpdCA9IGV2ZW50VHlwZXNbJ3dhaXQnXSwgZGF0YUV2ZW50U3RhcnQgPSBldmVudFR5cGVzWydzdGFydCddLCBkYXRhRXZlbnRTdG9wID0gZXZlbnRUeXBlc1snc3RvcCddLCBkYXRhRXZlbnRTdGF0dXMgPSBldmVudFR5cGVzWydzdGF0dXMnXSwgYXJndW1lbnRSZXNvbHZlciA9IGZ1bmN0aW9uIChtZXRob2QpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gbWV0aG9kKF8udG9BcnJheShhcmd1bWVudHMpKTsKICAgICAgICB9OwogICAgfTsKICAgIGpRdWVyeS5hamF4U2V0dGluZ3MudHJhZGl0aW9uYWwgPSAhIXRDb25maWcudXJsLnRyYWRpdGlvbmFsRW5jb2Rpbmc7CiAgICB2YXIgakRvYyA9IGpRdWVyeShkb2N1bWVudCk7CiAgICBldmVudEZhY3RvcnkuaW5pdChqRG9jKTsKICAgIC8vI3JlZ2lvbiBEYXRhRmFjYWRlCiAgICAvKioKICAgIFRoZSBkYXRhIGZhY2FkZSB0aGF0IGlzIGhhbmRlZCBvZmYgdG8gbW9kdWxlcy4KICAgIAogICAgCiAgICBFbmFibGVzIGRhdGEgdHJhbnNwb3J0LCB1c2luZyBqUXVlcnkgZm9yIHRocnVzdC4KICAgIAogICAgQGZvciB0aHJ1c3QuZGF0YQogICAgQGNsYXNzIHRocnVzdC5kYXRhLkRhdGFGYWNhZGUKICAgIEBwYXJhbSB7dGhydXN0Lk1vZHVsZX0gbW9kdWxlIFRoZSBtb2R1bGUgdG8gY3JlYXRlIHRoZSBmYWNhZGUgZm9yCiAgICBAcGFyYW0ge3RocnVzdC5kYXRhLkRhdGF9IHBhcmVudCBUaGUgcGFyZW50IHRocnVzdCBkYXRhIG9iamVjdCB0byBjcmVhdGUgdGhlIGZhY2FkZSBmb3IuCiAgICBAY29uc3RydWN0b3IKICAgICoqLwogICAgdmFyIERhdGFGYWNhZGUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBkYXRhRmFjYWRlID0gZmFjYWRlLmNyZWF0ZUZhY2FkZShmdW5jdGlvbiAobW9kdWxlLCBwYXJlbnQpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gbW9kdWxlLm5hbWUgKyAnLWRhdGEnOwogICAgICAgICAgICB0aGlzLm1vZHVsZSA9IG1vZHVsZTsKICAgICAgICAgICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CiAgICAgICAgICAgIHRoaXMuX19jb252ZW50aW9ucyA9IHBhcmVudC5fX2NvbnZlbnRpb25zOwogICAgICAgICAgICB0aGlzLl9jYWxsYmFja3MgPSBwYXJlbnQuX2NhbGxiYWNrczsKICAgICAgICAgICAgdGhpcy5yZXNwb25zZVF1ZXVlID0gcGFyZW50LnJlc3BvbnNlUXVldWU7CiAgICAgICAgICAgIHRoaXMuaW5pdEV2ZW50cygpOwogICAgICAgICAgICB0aGlzLmRlZmF1bHRzID0gcGFyZW50LmRlZmF1bHRzOwogICAgICAgICAgICB0aGlzLmFwcFBhdGggPSBwYXJlbnQuYXBwUGF0aDsKICAgICAgICB9KTsKICAgICAgICBfLmV4dGVuZChkYXRhRmFjYWRlLnByb3RvdHlwZSwgZXZlbnRzKTsKICAgICAgICByZXR1cm4gZGF0YUZhY2FkZTsKICAgIH0pKCk7CiAgICAvLyNlbmRyZWdpb24KICAgIC8qKgogICAgVGhlIG1hc3RlciBkYXRhIHBsdWdpbi4KICAgIAogICAgCiAgICBFbmFibGVzIGRhdGEgdHJhbnNwb3J0LCB1c2luZyBqUXVlcnkgZm9yIHRocnVzdC4KICAgIAogICAgQGZvciB0aHJ1c3QuZGF0YQogICAgQGNsYXNzIHRocnVzdC5kYXRhLkRhdGEKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0aHJ1c3QgaW5zdGFuY2UgbmFtZS4KICAgIEBwYXJhbSB7dGhydXN0Lm1lZGlhdG9yLk1lZGlhdG9yfSBtZWRpYXRvciBUaGUgdGhydXN0IG1lZGlhdG9yIGluc3RhbmNlLgogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgdGhydXN0IGluc3RhbmNlIGNvbmZpZ3VyYXRpb24uCiAgICBAY29uc3RydWN0b3IKICAgICoqLwogICAgdmFyIERhdGEgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIC8vI2VuZHJlZ2lvbgogICAgICAgIGZ1bmN0aW9uIERhdGEobmFtZSwgbWVkaWF0b3IsIGNvbmZpZykgewogICAgICAgICAgICBpZighbmFtZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEYXRhOiBtb2R1bGUgbmFtZSBtdXN0IGJlIGRlZmluZWQuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICAgICAgdGhpcy5yZXNwb25zZVF1ZXVlID0gbmV3IFJlc3BvbnNlUXVldWUodGhpcywgY29uZmlnLmRhdGEuc3RhcnRUaW1lb3V0LCBjb25maWcuZGF0YS5maW5pc2hUaW1lb3V0KTsKICAgICAgICAgICAgZmFsc2UgJiYgbG9nLmRlYnVnKCdEYXRhOiBDcmVhdGluZyBuZXcgRGF0YScpOwogICAgICAgICAgICB0aGlzLm1lZGlhdG9yID0gbWVkaWF0b3I7CiAgICAgICAgICAgIHRoaXMuX2NhbGxiYWNrcyA9ICh0aGlzKS5tZWRpYXRvci5fY2FsbGJhY2tzOwogICAgICAgICAgICB0aGlzLmluaXRFdmVudHMoKTsKICAgICAgICAgICAgdGhpcy5kZWZhdWx0cyA9IHsKICAgICAgICAgICAgICAgIGNhY2hlOiBjb25maWcuZGF0YS5jYWNoZSwKICAgICAgICAgICAgICAgIGJlZm9yZVNlbmQ6IGV2ZW50RmFjdG9yeS5iZWZvcmVTZW5kTWV0aG9kLAogICAgICAgICAgICAgICAgY29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICAgICAgICAgIHR5cGU6ICdQT1NUJywKICAgICAgICAgICAgICAgIHVybDogJycsCiAgICAgICAgICAgICAgICBkYXRhOiAnJywKICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAnanNvbicsCiAgICAgICAgICAgICAgICBfX21lZGlhdG9yX2RhdGFfZmlyZWRfXzogdHJ1ZSwKICAgICAgICAgICAgICAgIHNpbGVudDogZmFsc2UKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5hcHBQYXRoID0gY29uZmlnLnVybC5wYXRoICsgJy8nOwogICAgICAgIH0KICAgICAgICBEYXRhLnByb3RvdHlwZS5pbml0RXZlbnRzID0gLy8jcmVnaW9uIEV2ZW50cwogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLmV4dGVuZCA9IGZ1bmN0aW9uICh0bywgaW5pdCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0LCBvbmNlKSB7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS51bnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5vbmNlID0gZnVuY3Rpb24gKGV2ZW50cywgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLmNyZWF0ZUZhY2FkZSA9IC8qKgogICAgICAgIENyZWF0ZXMgYSBEYXRhRmFjYWRlIGZvciB0aGUgZ2l2ZW4gbW9kdWxlLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YQogICAgICAgIEBtZXRob2QgY3JlYXRlRmFjYWRlCiAgICAgICAgQHBhcmFtIHtUaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlCiAgICAgICAgQHBhcmFtIHtNb2R1bGV9IG1vZHVsZSBUaGUgbW9kdWxlCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgVGhlIGF2YWlsYWJsZSBmYWNhZGVzCiAgICAgICAgQHJldHVybnMge0RhdGFGYWNhZGV9IFRoZSBuZXcgRGF0YUZhY2FkZQogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh0aHJ1c3QsIG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICBpZihtb2QuZGF0YSAmJiAhKGZhY2FkZXMuZGF0YSBpbnN0YW5jZW9mIERhdGFGYWNhZGUpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJyJkYXRhIiBpcyBhIHJlc2VydmVkIHByb3BlcnR5Jyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRhdGE7CiAgICAgICAgICAgIGlmKGZhY2FkZXMuZGF0YSkgewogICAgICAgICAgICAgICAgZmFjYWRlcy5kYXRhLnVwZGF0ZUZhY2FkZShtb2QsIHRoaXMpOwogICAgICAgICAgICAgICAgZGF0YSA9IGZhY2FkZXMuZGF0YTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRhdGEgPSBmYWNhZGVzLmRhdGEgPSBtb2QuZGF0YSA9IG5ldyBEYXRhRmFjYWRlKG1vZCwgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgfTsKICAgICAgICBEYXRhLnByb3RvdHlwZS5nZXREYXRhID0gLyoqCiAgICAgICAgRG9lcyBhIEdFVCB0byB0aGUgc2VydmVyLCBmb3IgdGhlIGdpdmVuIGRhdGEgYW5kIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YQogICAgICAgIEBtZXRob2QgZ2V0RGF0YQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBnZXQgZGF0YSBmcm9tCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGRhdGEgVGhlIGRhdGEgdG8gcGFzcyB0byB0aGUgZ2l2ZW4gdXJsCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW5ncyBvZiB0aGUgdGFzayB0byBiZSBkb25lCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5jYWNoZSBEbyB3ZSBjYWNoZSB0aGlzIGNhbGwgb3Igbm90LgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3Muc2lsZW50IERvIHdlIHVzZSB0aGUgYnVpbHQgaW4gZGF0YSBxdWV1ZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgaWYgdGhpcyByZXF1ZXN0IGNvbXBsZXRlcyBvciBmYWlscwogICAgICAgICoqLwogICAgICAgIC8qKgogICAgICAgIERvZXMgYSBHRVQgdG8gdGhlIHNlcnZlciwgZm9yIHRoZSBnaXZlbiBkYXRhIGFuZCBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGFGYWNhZGUKICAgICAgICBAbWV0aG9kIGdldERhdGEKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBkYXRhIFRoZSBkYXRhIHRvIHBhc3MgdG8gdGhlIGdpdmVuIHVybAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodXJsLCBkYXRhLCBzZXR0aW5ncykgewogICAgICAgICAgICBzZXR0aW5ncyA9ICFzZXR0aW5ncyA/IHsKICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSA6IGV4dGVuZChzZXR0aW5ncywgewogICAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KHVybCwgc2V0dGluZ3MpOwogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUucG9zdERhdGEgPSAvKioKICAgICAgICBEb2VzIGEgUE9TVCB0byB0aGUgc2VydmVyLCBmb3IgdGhlIGdpdmVuIGRhdGEgYW5kIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YQogICAgICAgIEBtZXRob2QgcG9zdERhdGEKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBkYXRhIFRoZSBkYXRhIHRvIHBhc3MgdG8gdGhlIGdpdmVuIHVybAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICAvKioKICAgICAgICBEb2VzIGEgUE9TVCB0byB0aGUgc2VydmVyLCBmb3IgdGhlIGdpdmVuIGRhdGEgYW5kIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YUZhY2FkZQogICAgICAgIEBtZXRob2QgcG9zdERhdGEKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBkYXRhIFRoZSBkYXRhIHRvIHBhc3MgdG8gdGhlIGdpdmVuIHVybAogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodXJsLCBkYXRhLCBzZXR0aW5ncykgewogICAgICAgICAgICBzZXR0aW5ncyA9ICFzZXR0aW5ncyA/IHsKICAgICAgICAgICAgICAgIGRhdGE6IEpTT04uc3RyaW5naWZ5KGRhdGEpCiAgICAgICAgICAgIH0gOiBleHRlbmQoc2V0dGluZ3MsIHsKICAgICAgICAgICAgICAgIGRhdGE6IEpTT04uc3RyaW5naWZ5KGRhdGEpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdGhpcy5wb3N0KHVybCwgc2V0dGluZ3MpOwogICAgICAgIH07CiAgICAgICAgRGF0YS5wcm90b3R5cGUuZ2V0ID0gLyoqCiAgICAgICAgRG9lcyBhIEdFVCB0byB0aGUgc2VydmVyLCB1c2luZyB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgRGF0YSBtdXN0IGJlIHBhc3NlZCBpbiB1c2luZyBzZXR0aW5nczogeyBkYXRhOiB7fSB9IG90aGVyd2lzZSB1c2UgZ2V0RGF0YS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGEKICAgICAgICBAbWV0aG9kIGdldAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBnZXQgZGF0YSBmcm9tCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW5ncyBvZiB0aGUgdGFzayB0byBiZSBkb25lCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5jYWNoZSBEbyB3ZSBjYWNoZSB0aGlzIGNhbGwgb3Igbm90LgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3Muc2lsZW50IERvIHdlIHVzZSB0aGUgYnVpbHQgaW4gZGF0YSBxdWV1ZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgaWYgdGhpcyByZXF1ZXN0IGNvbXBsZXRlcyBvciBmYWlscwogICAgICAgICoqLwogICAgICAgIC8qKgogICAgICAgIERvZXMgYSBHRVQgdG8gdGhlIHNlcnZlciwgdXNpbmcgdGhlIGdpdmVuIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIERhdGEgbXVzdCBiZSBwYXNzZWQgaW4gdXNpbmcgc2V0dGluZ3M6IHsgZGF0YToge30gfSBvdGhlcndpc2UgdXNlIGdldERhdGEuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhRmFjYWRlCiAgICAgICAgQG1ldGhvZCBnZXQKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodXJsLCBzZXR0aW5ncykgewogICAgICAgICAgICBpZihzZXR0aW5ncyA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiB1cmwgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncyA9IHVybDsKICAgICAgICAgICAgICAgIHVybCA9IHNldHRpbmdzLnVybDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih1cmwgPT09IHVuZGVmaW5lZCAmJiBzZXR0aW5ncy51cmwgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdXJsID0gc2V0dGluZ3MudXJsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHVybCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHVybCBpcyBkZWZpbmVkJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWpheCh1cmwsIGV4dGVuZChzZXR0aW5ncyB8fCB7CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIHR5cGU6ICdnZXQnCiAgICAgICAgICAgIH0pKTsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLnBvc3QgPSAvKioKICAgICAgICBEb2VzIGEgUE9TVCB0byB0aGUgc2VydmVyLCB1c2luZyB0aGUgZ2l2ZW4gc2V0dGluZ3MuCiAgICAgICAgCiAgICAgICAgRGF0YSBtdXN0IGJlIHBhc3NlZCBpbiB1c2luZyBzZXR0aW5nczogeyBkYXRhOiB7fSB9IG90aGVyd2lzZSB1c2UgcG9zdERhdGEuCiAgICAgICAgCiAgICAgICAgQGZvciB0aHJ1c3QuZGF0YS5EYXRhCiAgICAgICAgQG1ldGhvZCBwb3N0CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGdldCBkYXRhIGZyb20KICAgICAgICBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgVGhlIHNldHRpbmdzIG9mIHRoZSB0YXNrIHRvIGJlIGRvbmUKICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLmNhY2hlIERvIHdlIGNhY2hlIHRoaXMgY2FsbCBvciBub3QuCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5zaWxlbnQgRG8gd2UgdXNlIHRoZSBidWlsdCBpbiBkYXRhIHF1ZXVlLgogICAgICAgIEByZXR1cm5zIHtQcm9taXNlfSBUaGUgcHJvbWlzZSBpZiB0aGlzIHJlcXVlc3QgY29tcGxldGVzIG9yIGZhaWxzCiAgICAgICAgKiovCiAgICAgICAgLyoqCiAgICAgICAgRG9lcyBhIFBPU1QgdG8gdGhlIHNlcnZlciwgdXNpbmcgdGhlIGdpdmVuIHNldHRpbmdzLgogICAgICAgIAogICAgICAgIERhdGEgbXVzdCBiZSBwYXNzZWQgaW4gdXNpbmcgc2V0dGluZ3M6IHsgZGF0YToge30gfSBvdGhlcndpc2UgdXNlIHBvc3REYXRhLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LmRhdGEuRGF0YUZhY2FkZQogICAgICAgIEBtZXRob2QgcG9zdAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBnZXQgZGF0YSBmcm9tCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIFRoZSBzZXR0aW5ncyBvZiB0aGUgdGFzayB0byBiZSBkb25lCiAgICAgICAgQHBhcmFtIHtCb29sZWFufSBzZXR0aW5ncy5jYWNoZSBEbyB3ZSBjYWNoZSB0aGlzIGNhbGwgb3Igbm90LgogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3Muc2lsZW50IERvIHdlIHVzZSB0aGUgYnVpbHQgaW4gZGF0YSBxdWV1ZS4KICAgICAgICBAcmV0dXJucyB7UHJvbWlzZX0gVGhlIHByb21pc2UgaWYgdGhpcyByZXF1ZXN0IGNvbXBsZXRlcyBvciBmYWlscwogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uICh1cmwsIHNldHRpbmdzKSB7CiAgICAgICAgICAgIGlmKHNldHRpbmdzID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIHVybCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gdXJsOwogICAgICAgICAgICAgICAgdXJsID0gc2V0dGluZ3MudXJsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHVybCA9PT0gdW5kZWZpbmVkICYmIHNldHRpbmdzLnVybCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB1cmwgPSBzZXR0aW5ncy51cmw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodXJsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gdXJsIGlzIGRlZmluZWQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5hamF4KHVybCwgZXh0ZW5kKHNldHRpbmdzIHx8IHsKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgdHlwZTogJ3Bvc3QnCiAgICAgICAgICAgIH0pKTsKICAgICAgICB9OwogICAgICAgIERhdGEucHJvdG90eXBlLmFqYXggPSAvKioKICAgICAgICBEb2VzIGFuIGFqYXggY2FsbCB0byB0aGUgZ2l2ZW4gdXJsLCB3aXRoIHRoZSBnaXZlbiBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGEKICAgICAgICBAbWV0aG9kIGFqYXgKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICAvKioKICAgICAgICBEb2VzIGFuIGFqYXggY2FsbCB0byB0aGUgZ2l2ZW4gdXJsLCB3aXRoIHRoZSBnaXZlbiBzZXR0aW5ncy4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC5kYXRhLkRhdGFGYWNhZGUKICAgICAgICBAbWV0aG9kIGFqYXgKICAgICAgICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZ2V0IGRhdGEgZnJvbQogICAgICAgIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBUaGUgc2V0dGluZ3Mgb2YgdGhlIHRhc2sgdG8gYmUgZG9uZQogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gc2V0dGluZ3MuY2FjaGUgRG8gd2UgY2FjaGUgdGhpcyBjYWxsIG9yIG5vdC4KICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IHNldHRpbmdzLnNpbGVudCBEbyB3ZSB1c2UgdGhlIGJ1aWx0IGluIGRhdGEgcXVldWUuCiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGlmIHRoaXMgcmVxdWVzdCBjb21wbGV0ZXMgb3IgZmFpbHMKICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodXJsLCBzZXR0aW5ncykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIG9wdGlvbnMsIHR5cGUsIGJlZm9yZVNlbmQ7CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5pbmZvKGZvcm1hdCgnRGF0YVt7MH1dOiBGZXRjaGluZyBkYXRhIGZyb20gInsxfSInLCB0aGF0Lm5hbWVzcGFjZSwgdXJsKSk7CiAgICAgICAgICAgIGlmKHNldHRpbmdzID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIHVybCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzID0gdXJsOwogICAgICAgICAgICAgICAgdXJsID0gc2V0dGluZ3MudXJsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFzZXR0aW5ncykgewogICAgICAgICAgICAgICAgc2V0dGluZ3MgPSB7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHVybCA9PT0gdW5kZWZpbmVkICYmIHNldHRpbmdzLnVybCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB1cmwgPSBzZXR0aW5ncy51cmw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXJsID0gdXRpbC5maXh1cFVybCh1cmwsIHRoYXQuYXBwUGF0aCk7CiAgICAgICAgICAgIGlmKHNldHRpbmdzLnNpbGVudCkgewogICAgICAgICAgICAgICAgdmFyIGRmbyA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgICAgIHZhciBxdWVyeUlkID0gdWlkKCdkcScpOwogICAgICAgICAgICAgICAgdHlwZSA9IHNldHRpbmdzLnR5cGUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSBleHRlbmQoewogICAgICAgICAgICAgICAgfSwgdGhhdC5kZWZhdWx0cywgewogICAgICAgICAgICAgICAgICAgIGJlZm9yZVNlbmQ6IHV0aWwubm9vcAogICAgICAgICAgICAgICAgfSwgc2V0dGluZ3MpOwogICAgICAgICAgICAgICAgYWpheCh1cmwsIG9wdGlvbnMpLnRoZW4oYXJndW1lbnRSZXNvbHZlcihkZm8ucmVzb2x2ZSksIGFyZ3VtZW50UmVzb2x2ZXIoZGZvLnJlamVjdCkpOwogICAgICAgICAgICAgICAgcmV0dXJuIGRmby5wcm9taXNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9wdGlvbnMgPSBleHRlbmQoewogICAgICAgICAgICB9LCB0aGF0LmRlZmF1bHRzLCBzZXR0aW5ncywgewogICAgICAgICAgICAgICAgYmVmb3JlU2VuZDogZXZlbnRGYWN0b3J5LmJlZm9yZVNlbmRNZXRob2QKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHR5cGUgPSBvcHRpb25zLnR5cGUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVzcG9uc2VRdWV1ZS5hZGRUb1F1ZXVlKHR5cGUsIHVybCwgb3B0aW9ucyk7CiAgICAgICAgfTsKICAgICAgICBEYXRhLmNvbmZpZyA9IGNvbmZpZzsKICAgICAgICByZXR1cm4gRGF0YTsKICAgIH0pKCk7CiAgICBleHBvcnRzLkRhdGEgPSBEYXRhOyAgICAKICAgIF8uZXh0ZW5kKERhdGEucHJvdG90eXBlLCBFdmVudHMpOwogICAgXy5leHRlbmQoRGF0YUZhY2FkZS5wcm90b3R5cGUsIERhdGEucHJvdG90eXBlKTsKICAgIC8vIFRha2UgYSBob2xkIG9mIGpRdWVyeS4uLiB0aGlzIGlzIHN1cmUgdG8gYmUgY29udHJhdmVzaWFsCiAgICBqUXVlcnkuYWpheCA9IChEYXRhKS5wcm90b3R5cGUuYWpheDsKfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9bWFpbi5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC9kYXRhJywgWyd0aHJ1c3QvZGF0YS9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCmRlZmluZSgndGhydXN0L2RvbS9tYWluJyxbInJlcXVpcmUiLCAiZXhwb3J0cyIsICcuL3N1YmpxdWVyeScsICd0aHJ1c3QvdXRpbCcsICd0aHJ1c3QvbG9nJywgJ3RocnVzdC9mYWNhZGUnLCAnaGFzJywgJ3RocnVzdC9pbnN0YW5jZScsICcuL2NvbmZpZyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3N1YmpxdWVyeV9fLCBfX3V0aWxfXywgX19sb2dfXywgX19mYWNhZGVfXywgX19oYXNfXywgX19pbnN0YW5jZV9fLCBfX2NvbmZpZ19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL2RvbS9kb20uZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgc3VianF1ZXJ5ID0gX19zdWJqcXVlcnlfXzsKCiAgICB2YXIgdFF1ZXJ5ID0gc3VianF1ZXJ5LnRRdWVyeTsKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICB2YXIgbG9nID0gX19sb2dfXzsKCiAgICB2YXIgZmFjYWRlID0gX19mYWNhZGVfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICB2YXIgaW5zdGFuY2UgPSBfX2luc3RhbmNlX187CgogICAgdmFyIGNvbmZpZyA9IF9fY29uZmlnX187CgogICAgZXhwb3J0cy5jbGFzc05hbWUgPSAnRG9tJzsKICAgIHZhciBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgZXh0ZW5kID0gXy5leHRlbmQsIGJpbmQgPSBfLmJpbmQsIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksIGlzT2JqZWN0ID0gXy5pc09iamVjdCwgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsIHdoZW4gPSB1dGlsLndoZW4sIGlzQXJyYXkgPSBfLmlzQXJyYXk7CiAgICAvLyNyZWdpb24gRG9tRmFjYWRlCiAgICB2YXIgRG9tRmFjYWRlID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZG9tRmFjYWRlID0gZmFjYWRlLmNyZWF0ZUZhY2FkZShmdW5jdGlvbiAobW9kLCBwYXJlbnQpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gcGFyZW50Lm5hbWU7CiAgICAgICAgICAgIHRoaXMuX19jb252ZW50aW9ucyA9IHBhcmVudC5fX2NvbnZlbnRpb25zOwogICAgICAgICAgICB0aGlzLmNvbnRleHQgPSB0UXVlcnkoZG9jdW1lbnQsIHVuZGVmaW5lZCwgdGhpcy5uYW1lKTsKICAgICAgICB9KTsKICAgICAgICBkb21GYWNhZGUucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbiAoZmFrZSkgewogICAgICAgICAgICB0aGlzLl9pbnRlcm5hbEV2ZW50cyA9IHRoaXMuX2ludGVybmFsRXZlbnRzIHx8IFtdOwogICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdEb21bezB9XTogSW5pdGFsaXppbmcgezF9RG9tIGZhY2FkZScsIHRoaXMubmFtZSwgZmFrZSA/ICdmYWtlICcgOiAnJykpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIGRvbUZhY2FkZS5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbiAobSkgewogICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdEb21bezB9XTogU3RhcnRpbmcgRG9tIGZhY2FkZScsIHRoaXMubmFtZSkpOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIGRvbUZhY2FkZS5wcm90b3R5cGUuc3RvcCA9IGZ1bmN0aW9uIChtKSB7CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5kZWJ1Zyhmb3JtYXQoJ0RvbVt7MH1dOiBTdG9wcGluZyBEb20gZmFjYWRlJywgdGhpcy5uYW1lKSk7CiAgICAgICAgICAgIGZvcih2YXIgaSA9IHRoaXMuX2ludGVybmFsRXZlbnRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB2YXIgc3ViID0gdGhpcy5faW50ZXJuYWxFdmVudHNbaV07CiAgICAgICAgICAgICAgICB0aGlzLl9pbnRlcm5hbEV2ZW50cy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICBzdWIuY29udGV4dC5vZmYuYXBwbHkodGhpcywgKGlzQXJyYXkoc3ViKSkgPyBzdWIgOiAoaXNBcnJheShzdWIuYXJncykpID8gc3ViLmFyZ3MgOiBbXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBkb21GYWNhZGUucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAobSkgewogICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdEb21bezB9XTogRGVzdHJveWluZyBEb20gZmFjYWRlJywgdGhpcy5uYW1lKSk7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9pbnRlcm5hbEV2ZW50czsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gZG9tRmFjYWRlOwogICAgfSkoKTsKICAgIC8vI2VuZHJlZ2lvbgogICAgLy8jcmVnaW9uIERvbQogICAgdmFyIERvbSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8jZW5kcmVnaW9uCiAgICAgICAgZnVuY3Rpb24gRG9tKG5hbWUsIG1lZGlhdG9yKSB7CiAgICAgICAgICAgIGlmKCFuYW1lKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RvbTogbW9kdWxlIG5hbWUgbXVzdCBiZSBkZWZpbmVkLicpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZhbHNlICYmIGxvZy5kZWJ1ZygnRGF0YTogQ3JlYXRpbmcgbmV3IERhdGEnKTsKICAgICAgICAgICAgdGhpcy5tZWRpYXRvciA9IG1lZGlhdG9yOwogICAgICAgICAgICB0aGlzLl9jYWxsYmFja3MgPSAobWVkaWF0b3IpLl9jYWxsYmFja3M7CiAgICAgICAgICAgIHRoaXMuaW5pdEV2ZW50cygpOwogICAgICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIGluc3RhbmNlLmZldGNoSW5zdGFuY2UobmFtZSkucHJvbWlzZS50aGVuKGZ1bmN0aW9uICh0aHJ1c3QpIHsKICAgICAgICAgICAgICAgIHZhciBtb2QgPSB7CiAgICAgICAgICAgICAgICB9LCBmYWNhZGUgPSB0aGF0LmNyZWF0ZUZhY2FkZSh0aHJ1c3QsIG1vZCwgewogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgRG9tLnByb3RvdHlwZS5pbml0RXZlbnRzID0gLy8jcmVnaW9uIEV2ZW50cwogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICB9OwogICAgICAgIERvbS5wcm90b3R5cGUuZXh0ZW5kID0gZnVuY3Rpb24gKHRvLCBpbml0KSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgRG9tLnByb3RvdHlwZS5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCwgb25jZSkgewogICAgICAgIH07CiAgICAgICAgRG9tLnByb3RvdHlwZS51bnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudHMsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgfTsKICAgICAgICBEb20ucHJvdG90eXBlLm9uY2UgPSBmdW5jdGlvbiAoZXZlbnRzLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgIH07CiAgICAgICAgRG9tLmNvbmZpZyA9IGNvbmZpZzsKICAgICAgICBEb20ucHJvdG90eXBlLmNyZWF0ZUZhY2FkZSA9IGZ1bmN0aW9uICh0aHJ1c3QsIG1vZCwgZmFjYWRlcykgewogICAgICAgICAgICBpZihmYWNhZGVzLmRvbSAmJiAhKGZhY2FkZXMuZG9tIGluc3RhbmNlb2YgRG9tRmFjYWRlKSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCciZG9tIiBpcyBhIHJlc2VydmVkIHByb3BlcnR5Jyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRvbTsKICAgICAgICAgICAgaWYoZmFjYWRlcy5kb20pIHsKICAgICAgICAgICAgICAgIGZhY2FkZXMuZG9tLnVwZGF0ZUZhY2FkZShtb2QsIHRoaXMpOwogICAgICAgICAgICAgICAgZG9tID0gZmFjYWRlcy5kb207CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkb20gPSBmYWNhZGVzLmRvbSA9IG5ldyBEb21GYWNhZGUobW9kLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZG9tOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIERvbTsKICAgIH0pKCk7CiAgICBleHBvcnRzLkRvbSA9IERvbTsgICAgCiAgICAvLyNlbmRyZWdpb24KICAgIH0pCi8vQCBzb3VyY2VNYXBwaW5nVVJMPW1haW4uanMubWFwCjsKZGVmaW5lKCd0aHJ1c3QvZG9tJywgWyd0aHJ1c3QvZG9tL21haW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwoKZGVmaW5lKCd0aHJ1c3QvdGVtcGxhdGUvbWFpbicsWyJyZXF1aXJlIiwgImV4cG9ydHMiLCAndGhydXN0L3V0aWwnLCAnZG9tUmVhZHknLCAndGhydXN0L2ZhY2FkZScsICcuL2NvbmZpZyddLCBmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBfX3V0aWxfXywgX19kb21SZWFkeV9fLCBfX2ZhY2FkZV9fLCBfX2NvbmZpZ19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL2RhdGEvZGF0YS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vaW50ZXJmYWNlcy90ZW1wbGF0ZS90ZW1wbGF0ZS5kLnRzIiAvPgogICAgLy8vIDxyZWZlcmVuY2UgcGF0aD0iLi4vLi4vLi4vbGliL0RlZmluaXRlbHlUeXBlZC9yZXF1aXJlanMvcmVxdWlyZS5kLnRzIiAvPgogICAgLy8gRGlzYWJsZWQgdW50aWwgVFMgc3VwcG9ydHMgbW9kdWxlIHBlciBmaWxlIGluIHNvbWUgd2F5IChpZSBleHBvcnRzIGlzIGV4cG9ydHMuPGV4cG9ydD4gbm90ICBleHBvcnRzLm1vZHVsZU5hbWUuPGV4cG9ydD4pCiAgICAvKmV4cG9ydCBtb2R1bGUgaW5zdGFuY2UgeyovCiAgICAKICAgIHZhciB1dGlsID0gX191dGlsX187CgogICAgdmFyIF8gPSB1dGlsLl87CiAgICAKICAgIAogICAgdmFyIGRvbVJlYWR5ID0gX19kb21SZWFkeV9fOwoKICAgIHZhciBmYWNhZGUgPSBfX2ZhY2FkZV9fOwoKICAgIHZhciBjb25maWcgPSBfX2NvbmZpZ19fOwoKICAgIGV4cG9ydHMuY2xhc3NOYW1lID0gJ1RlbXBsYXRlJzsKICAgIGNvbmZpZzsKICAgIHZhciBMT05HID0gJ2xvbmcnLCBTSE9SVCA9ICdzaG9ydCcsIElEID0gJ2lkJywgZGVlcENvcHkgPSBfLm1lcmdlLCBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgZWFjaCA9IF8uZWFjaCwgYmluZCA9IF8uYmluZCwgd2hlbiA9IHV0aWwud2hlbiwgcmVkdWNlID0gXy5yZWR1Y2UsIG1lbW9pemUgPSBfLm1lbW9pemUsIG1hcCA9IF8ubWFwLCBleHRlbmQgPSBfLmV4dGVuZCwgZ2V0TG9uZ05hbWUgPSBmdW5jdGlvbiAobmFtZSwgdHlwZSkgewogICAgICAgIHZhciB0aGF0ID0gdGhpcywgcmVzdWx0ID0gKHRoYXQuc2hvcnROYW1lKG5hbWUpICsgJy4nICsgKHR5cGUgfHwgdGhhdC5jb25maWcuZGVmYXVsdFR5cGUpICsgdGhhdC5jb25maWcuZXh0ZW5zaW9uKS50b0xvd2VyQ2FzZSgpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9LCBnZXRTaG9ydE5hbWUgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHZhciB0aGF0ID0gdGhpcywgcmVzdWx0ID0gcmVkdWNlKHRoYXQudGVtcGxhdGVUeXBlcywgZnVuY3Rpb24gKG1lbW8sIHgpIHsKICAgICAgICAgICAgcmV0dXJuIG1lbW8ucmVwbGFjZSgnLicgKyB4LnRvTG93ZXJDYXNlKCkgKyB0aGF0LmNvbmZpZy5leHRlbnNpb24sICcnKTsKICAgICAgICB9LCBuYW1lLnRvTG93ZXJDYXNlKCkpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0sIGdldFRlbXBsYXRlSWQgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHZhciB0aGF0ID0gdGhpcywgcmVzdWx0ID0gdGhhdC5zaG9ydE5hbWUobmFtZSkucmVwbGFjZSgvXC8vZywgJy0nKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICAgIC8qKgogICAgQG1vZHVsZSB0aHJ1c3QudGVtcGxhdGUKICAgIEByZXF1aXJlcyB0aHJ1c3QuZGF0YQogICAgKiovCiAgICAvKioKICAgIFRoZSB0ZW1wbGF0ZSBwbHVnaW4gY29uc3R1cmN0b3IuCiAgICAKICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlCiAgICBAY2xhc3MgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlCiAgICBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSB0aHJ1c3QgY29uZmlnIG9iamVjdAogICAgQHBhcmFtIHtPYmplY3R9IGRhdGEgVGhlIHRocnVzdCBkYXRhIGluc3RhbmNlCiAgICBAdXNlcyB0aHJ1c3QuZGF0YS5EYXRhCiAgICBAY29uc3RydWN0b3IKICAgICoqLwogICAgdmFyIFRlbXBsYXRlID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBUZW1wbGF0ZShjb25maWcsIGRhdGEpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCB0ZW1wbGF0ZUNvbmZpZyA9IHRoaXMuY29uZmlnID0gY29uZmlnLnRlbXBsYXRlOwogICAgICAgICAgICB0aGF0LnRlbXBsYXRlVHlwZXMgPSBtYXAodGVtcGxhdGVDb25maWcudHlwZXMsIGZ1bmN0aW9uICh4LCBpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoYXQudGVtcGxhdGVzID0gewogICAgICAgICAgICAgICAgbG9uZzogewogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNob3J0OiB7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaWQ6IHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhhdC5sb25nTmFtZSA9IG1lbW9pemUoYmluZChnZXRMb25nTmFtZSwgdGhhdCkpOwogICAgICAgICAgICB0aGF0LnNob3J0TmFtZSA9IG1lbW9pemUoYmluZChnZXRTaG9ydE5hbWUsIHRoYXQpKTsKICAgICAgICAgICAgdGhhdC50ZW1wbGF0ZUlkID0gbWVtb2l6ZShiaW5kKGdldFRlbXBsYXRlSWQsIHRoYXQpKTsKICAgICAgICAgICAgdGhhdC5lbmdpbmVzID0gewogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGF0LmRhdGEgPSBkYXRhOwogICAgICAgICAgICByZXF1aXJlKFsKICAgICAgICAgICAgICAgICh0ZW1wbGF0ZUNvbmZpZy50ZW1wbGF0ZVBhdGhzW3RlbXBsYXRlQ29uZmlnLmRlZmF1bHRUeXBlXSB8fCAndGhydXN0L3RlbXBsYXRlLycgKyB0ZW1wbGF0ZUNvbmZpZy5kZWZhdWx0VHlwZSkKICAgICAgICAgICAgXSwgZnVuY3Rpb24gKGVuZ2luZSkgewogICAgICAgICAgICAgICAgdGhhdC5lbmdpbmVzW3RlbXBsYXRlQ29uZmlnLmRlZmF1bHRUeXBlXSA9IGVuZ2luZTsKICAgICAgICAgICAgICAgIGRvbVJlYWR5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAoXyhkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc2NyaXB0JykpKS5maWx0ZXIoZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICEheC5nZXRBdHRyaWJ1dGUoJ2RhdGEtdGVtcGxhdGUnKTsKICAgICAgICAgICAgICAgICAgICB9KS5lYWNoKGJpbmQodGhhdC5jcmVhdGVGcm9tRG9tTm9kZSwgdGhhdCkpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUuZ2V0ID0gLyoqCiAgICAgICAgR2V0cyBhIHRlbXBsYXRlIGZyb20gdGhlIGNhY2hlIGlmIGl0IGhhcyBiZWVuIGZldGNoZWQuIEZhbHNlIG90aGVyd2lzZS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgICAgIEBtZXRob2QgZ2V0CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRlbXBsYXRlIG5hbWUgdG8gdHJ5IGFuZCBnZXQuCiAgICAgICAgQHJldHVybnMge0Z1bmN0aW9ufSBUaGUgdGVtcGxhdGUgb2JqZWN0CiAgICAgICAgKiovCiAgICAgICAgLyoqCiAgICAgICAgR2V0cyBhIHRlbXBsYXRlIGZyb20gdGhlIGNhY2hlIGlmIGl0IGhhcyBiZWVuIGZldGNoZWQuIEZhbHNlIG90aGVyd2lzZS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZUZhY2FkZQogICAgICAgIEBtZXRob2QgZ2V0CiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRlbXBsYXRlIG5hbWUgdG8gdHJ5IGFuZCBnZXQuCiAgICAgICAgQHJldHVybnMge0Z1bmN0aW9ufSBUaGUgdGVtcGxhdGUgb2JqZWN0CiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gbnVsbCwgdGhhdCA9IHRoaXMsIHRlbXBsYXRlcyA9IHRoYXQudGVtcGxhdGVzOwogICAgICAgICAgICBpZih0ZW1wbGF0ZSA9IHRlbXBsYXRlcy5sb25nW3RoYXQubG9uZ05hbWUobmFtZSldKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7CiAgICAgICAgICAgIH0gZWxzZSBpZih0ZW1wbGF0ZSA9IHRlbXBsYXRlcy5zaG9ydFt0aGF0LnNob3J0TmFtZShuYW1lKV0pIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgICAgICAgICAgfSBlbHNlIGlmKHRlbXBsYXRlID0gdGVtcGxhdGVzLmlkW3RoYXQudGVtcGxhdGVJZChuYW1lKV0pIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIFRlbXBsYXRlLnByb3RvdHlwZS5zZXQgPSAvKioKICAgICAgICBTZXRzIGEgdGVtcGxhdGUgdG8gdGhlIGNhY2hlLCB3aXRoIHRoZSBnaXZlbiBpbmZvcm1hdGlvbgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlCiAgICAgICAgQG1ldGhvZCBzZXQKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdGVtcGxhdGUgbmFtZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSB0ZW1wbGF0ZSBlbmdpbmUgdHlwZQogICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNvbXBpbGVkVGVtcGxhdGUgVGhlIGNvbXBpbGVkIHRlbXBsYXRlIG1ldGhvZAogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBodG1sIFRoZSB0ZW1wbGF0ZSBIVE1MLgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lLCB0eXBlLCBjb21waWxlZFRlbXBsYXRlLCBodG1sKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgc2hvcnROYW1lID0gdGhhdC5zaG9ydE5hbWUobmFtZSksIHRlbXBsYXRlSWQgPSB0aGF0LnRlbXBsYXRlSWQobmFtZSksIGxvbmdOYW1lID0gdGhhdC5sb25nTmFtZShuYW1lLCB0eXBlKSwgdGVtcGxhdGVzID0gdGhhdC50ZW1wbGF0ZXM7CiAgICAgICAgICAgIHRlbXBsYXRlcy5sb25nW2xvbmdOYW1lXSA9IHRlbXBsYXRlcy5zaG9ydFtzaG9ydE5hbWVdID0gdGVtcGxhdGVzLmlkW3RlbXBsYXRlSWRdID0gewogICAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICAgIHNob3J0TmFtZTogbmFtZSwKICAgICAgICAgICAgICAgIGlkOiB0ZW1wbGF0ZUlkLAogICAgICAgICAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICAgICAgICAgIGh0bWw6IGh0bWwsCiAgICAgICAgICAgICAgICBjb21waWxlZDogY29tcGlsZWRUZW1wbGF0ZQogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICAgICAgVGVtcGxhdGUucHJvdG90eXBlLmhhcyA9IC8qKgogICAgICAgIENoZWNrcyBpZiB0aGUgdGVtcGxhdGUgZXhpc3RzIGluIHRoZSBjYWNoZS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgICAgIEBtZXRob2QgaGFzCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRlbXBsYXRlIG5hbWUKICAgICAgICBAcmV0dXJucyB7Qm9vbGVhbn0gV2V0aGVyIHRoZSB0ZW1wbGF0ZSBleGlzdHMgb3Igbm90LgogICAgICAgICoqLwogICAgICAgIC8qKgogICAgICAgIENoZWNrcyBpZiB0aGUgdGVtcGxhdGUgZXhpc3RzIGluIHRoZSBjYWNoZS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZUZhY2FkZQogICAgICAgIEBtZXRob2QgaGFzCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRlbXBsYXRlIG5hbWUKICAgICAgICBAcmV0dXJucyB7Qm9vbGVhbn0gV2V0aGVyIHRoZSB0ZW1wbGF0ZSBleGlzdHMgb3Igbm90LgogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgcmV0dXJuICEhdGhhdC5nZXQobmFtZSk7CiAgICAgICAgfTsKICAgICAgICBUZW1wbGF0ZS5wcm90b3R5cGUubmV3VGVtcGxhdGUgPSAvKioKICAgICAgICBDcmVhdGVzIGEgbmV3IHRlbXBsYXRlIGdpdmVuIHRoZSBpbmZvcm1hdGlvbgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlCiAgICAgICAgQG1ldGhvZCBuZXdUZW1wbGF0ZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0ZW1wbGF0ZSBuYW1lCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHRlbXBsYXRlIGVuZ2luZSB0eXBlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGh0bWwgVGhlIHRlbXBsYXRlIEhUTUwuCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGVuZ2luZSBUaGUgdGVtcGxhdGUgZW5naW5lCiAgICAgICAgQHJldHVybnMge09iamVjdH0gVGhlIG5ldyB0ZW1wbGF0ZSBpbnN0YW5jZS4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobmFtZSwgdHlwZSwgaHRtbCwgZW5naW5lKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgdGVtcGxhdGUgPSB0aGF0LmdldChuYW1lKTsKICAgICAgICAgICAgaWYoIXRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgICBpZih0eXBlID09ICdwcmVjb21waWxlZCcpIHsKICAgICAgICAgICAgICAgICAgICB0aGF0LnNldChuYW1lLCB0eXBlLCBodG1sLCBodG1sLnRvU3RyaW5nKCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGluZ01ldGhvZDsKICAgICAgICAgICAgICAgICAgICB2YXIgY29tcGlsZWRUZW1wbGF0ZSA9IHRoaXMuY29tcGlsZShodG1sLCBlbmdpbmUpOwogICAgICAgICAgICAgICAgICAgIHRoYXQuc2V0KG5hbWUsIHR5cGUsIGNvbXBpbGVkVGVtcGxhdGUsIGh0bWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGF0LmdldChuYW1lKTsKICAgICAgICB9OwogICAgICAgIFRlbXBsYXRlLnByb3RvdHlwZS5jb21waWxlID0gLyoqCiAgICAgICAgQ29tcGlsZXMgYSB0ZW1wbGF0ZSBnaXZlbiB0aGUgaHRtbCBhbmQgdGhlIGVuZ2luZSB0eXBlLgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlCiAgICAgICAgQG1ldGhvZCBjb21waWxlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGh0bWwgVGhlIGh0bWwgdG8gZ2VuZXJhdGUgdGhlIHRlbXBsYXRlIGZyb20KICAgICAgICBAcGFyYW0ge1N0cmluZ30gZW5naW5lIFRoZSB0ZW1wbGF0ZSBlbmdpbmUgdGhhdCBpcyBiZWluZyB1c2VkLgogICAgICAgIEByZXR1cm5zIHtGdW5jdGlvbn0gVGhlIGNvbXBpbGVkIHRlbXBsYXRlIG1ldGhvZAogICAgICAgICoqLwogICAgICAgIGZ1bmN0aW9uIChodG1sLCBlbmdpbmUpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCB0ZW1wbGF0aW5nTWV0aG9kOwogICAgICAgICAgICBpZighZW5naW5lKSB7CiAgICAgICAgICAgICAgICBlbmdpbmUgPSB0aGF0LmVuZ2luZXNbdGhhdC5jb25maWcuZGVmYXVsdFR5cGVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHR5cGVvZiBlbmdpbmUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIHRlbXBsYXRpbmdNZXRob2QgPSBlbmdpbmU7CiAgICAgICAgICAgIH0gZWxzZSBpZih0eXBlb2YgZW5naW5lLnRlbXBsYXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB0ZW1wbGF0aW5nTWV0aG9kID0gZW5naW5lLnRlbXBsYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0aW5nTWV0aG9kKGh0bWwpOwogICAgICAgIH07CiAgICAgICAgVGVtcGxhdGUucHJvdG90eXBlLmZldGNoID0gLyoqCiAgICAgICAgRmV0Y2hzIGEgdGVtcGxhdGUgZnJvbSB0aGUgc2VydmVyLCBvciB0ZW1wbGF0ZSBzdG9yZS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgICAgIEBtZXRob2QgZmV0Y2gKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdGVtcGxhdGUgbmFtZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBbdHlwZV0gVGhlIHRlbXBsYXRlIHR5cGUgaWYgbm90IHRoZSBkZWZhdWx0CiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGZvciB3aGVuIHRoZSB0ZW1wbGF0ZSBoYXMgYmVlbiBsb2FkZWQuCiAgICAgICAgKiovCiAgICAgICAgLyoqCiAgICAgICAgRmV0Y2hzIGEgdGVtcGxhdGUgZnJvbSB0aGUgc2VydmVyLCBvciB0ZW1wbGF0ZSBzdG9yZS4KICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZUZhY2FkZQogICAgICAgIEBtZXRob2QgZmV0Y2gKICAgICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdGVtcGxhdGUgbmFtZQogICAgICAgIEBwYXJhbSB7U3RyaW5nfSBbdHlwZV0gVGhlIHRlbXBsYXRlIHR5cGUgaWYgbm90IHRoZSBkZWZhdWx0CiAgICAgICAgQHJldHVybnMge1Byb21pc2V9IFRoZSBwcm9taXNlIGZvciB3aGVuIHRoZSB0ZW1wbGF0ZSBoYXMgYmVlbiBsb2FkZWQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKG5hbWUsIHR5cGUpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCB0eXBlID0gdHlwZSB8fCB0aGF0LmNvbmZpZy5kZWZhdWx0VHlwZSwgc2hvcnROYW1lID0gdGhhdC5zaG9ydE5hbWUobmFtZSksIGxvbmdOYW1lID0gdGhhdC5sb25nTmFtZShuYW1lLCB0eXBlKSwgdGVtcGxhdGU7CiAgICAgICAgICAgIHZhciBkZWZlciA9IHdoZW4uZGVmZXIoKTsKICAgICAgICAgICAgaWYodGVtcGxhdGUgPSB0aGF0LmdldChuYW1lKSkgewogICAgICAgICAgICAgICAgZGVmZXIucmVzb2x2ZSh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gZGVmZXIucHJvbWlzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGF0LmRhdGEuZ2V0KHRoYXQuY29uZmlnLmJhc2VVcmwgKyBsb25nTmFtZSwgewogICAgICAgICAgICAgICAgY29udGVudFR5cGU6ICd0ZXh0L3BsYWluJywKICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAndGV4dCcsCiAgICAgICAgICAgICAgICBzaWxlbnQ6IHRydWUKICAgICAgICAgICAgfSkudGhlbih3aGVuLmFwcGx5KGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICBpZih0eXBlID09ICdwcmVjb21waWxlZCcpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSB0aGF0Lm5ld1RlbXBsYXRlKG5hbWUsIHR5cGUsIGRhdGEpOwogICAgICAgICAgICAgICAgICAgIGRlZmVyLnJlc29sdmUodGVtcGxhdGUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZih0aGF0LmVuZ2luZXNbdHlwZV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gdGhhdC5uZXdUZW1wbGF0ZShuYW1lLCB0eXBlLCBkYXRhLCB0aGF0LmVuZ2luZXNbdHlwZV0pOwogICAgICAgICAgICAgICAgICAgICAgICBkZWZlci5yZXNvbHZlKHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZXF1aXJlKFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0aGF0LmNvbmZpZy50ZW1wbGF0ZVBhdGhzW3R5cGVdIHx8ICd0aHJ1c3QvdGVtcGxhdGUvJyArIHR5cGUpCiAgICAgICAgICAgICAgICAgICAgICAgIF0sIGZ1bmN0aW9uIChlbmdpbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuZW5naW5lc1t0eXBlXSA9IGVuZ2luZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoYXQubmV3VGVtcGxhdGUobmFtZSwgdHlwZSwgZGF0YSwgZW5naW5lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVyLnJlc29sdmUodGVtcGxhdGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pLCBkZWZlci5yZWplY3QpOwogICAgICAgICAgICByZXR1cm4gZGVmZXIucHJvbWlzZTsKICAgICAgICB9OwogICAgICAgIFRlbXBsYXRlLnByb3RvdHlwZS5jcmVhdGVGcm9tRG9tTm9kZSA9IC8qKgogICAgICAgIENyZWF0ZXMgYSBuZXcgdGVtcGxhdGUgZnJvbSB0aGUgZ2l2ZW4gRE9NIE5vZGUKICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgICAgIEBtZXRob2QgY3JlYXRlRnJvbURvbU5vZGUKICAgICAgICBAcHJvdGVjdGVkCiAgICAgICAgQHBhcmFtIHtOb2RlfSBlbGVtZW50IFRIZSBkb21lIGVsZW1lbnQuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB0aGF0Lm5ld1RlbXBsYXRlKGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdkYXRhLXRlbXBsYXRlJyksIGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdkYXRhLXR5cGUnKSwgZWxlbWVudC50ZXh0KTsKICAgICAgICB9OwogICAgICAgIFRlbXBsYXRlLnByb3RvdHlwZS5jcmVhdGVGYWNhZGUgPSAvKioKICAgICAgICAKICAgICAgICBAZm9yIHRocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZQogICAgICAgIEBtZXRob2QgY3JlYXRlRmFjYWRlCiAgICAgICAgQHBhcmFtIHt0aHJ1c3QuVGhydXN0fSB0aHJ1c3QgVGhlIHRocnVzdCBpbnN0YW5jZQogICAgICAgIEBwYXJhbSB7dGhydXN0Lk1vZHVsZX0gbW9kdWxlIFRoZSBtb2R1bGUgdG8gY3JlYXRlIHRoZSBmYWNhZGUgZm9yCiAgICAgICAgQHBhcmFtIHtPYmplY3R9IGZhY2FkZXMgVGhlIGZhY2FkZXMgYWxyZWFkeSBhZGRlZCBmb3IgdGhpcyBtb2R1bGUuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHRocnVzdCwgbW9kLCBmYWNhZGVzKSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZUluc3RhbmNlID0gdGhydXN0LnRlbXBsYXRlOwogICAgICAgICAgICB2YXIgZmFjYWRlID0gZmFjYWRlcy50ZW1wbGF0ZSA9IG5ldyBUZW1wbGF0ZUZhY2FkZShtb2QsIHRoaXMpOwogICAgICAgICAgICBtb2QudGVtcGxhdGVzID0gewogICAgICAgICAgICAgICAgZmV0Y2g6IGJpbmQodGVtcGxhdGVJbnN0YW5jZS5mZXRjaCwgdGVtcGxhdGVJbnN0YW5jZSksCiAgICAgICAgICAgICAgICBnZXQ6IGJpbmQodGVtcGxhdGVJbnN0YW5jZS5nZXQsIHRlbXBsYXRlSW5zdGFuY2UpLAogICAgICAgICAgICAgICAgaGFzOiBiaW5kKHRlbXBsYXRlSW5zdGFuY2UuaGFzLCB0ZW1wbGF0ZUluc3RhbmNlKQogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gZmFjYWRlOwogICAgICAgIH07CiAgICAgICAgVGVtcGxhdGUuY29uZmlnID0gY29uZmlnOwogICAgICAgIHJldHVybiBUZW1wbGF0ZTsKICAgIH0pKCk7CiAgICBleHBvcnRzLlRlbXBsYXRlID0gVGVtcGxhdGU7ICAgIAogICAgLyoqCiAgICAKICAgIEBmb3IgdGhydXN0LnRlbXBsYXRlCiAgICBAY2xhc3MgdGhydXN0LnRlbXBsYXRlLlRlbXBsYXRlRmFjYWRlCiAgICBAY29uc3RydWN0b3IKICAgIEBwYXJhbSB7dGhydXN0Lk1vZHVsZX0gbW9kdWxlIFRoZSBtb2R1bGUgdG8gY3JlYXRlIHRoZSBmYWNhZGUgZm9yCiAgICBAcGFyYW0ge3RocnVzdC50ZW1wbGF0ZS5UZW1wbGF0ZX0gcGFyZW50IFRoZSB0ZW1wbGF0ZSBpbnN0YW5jZSB0byBjcmVhdGUgdGhlIGZhY2FkZSBmb3IuCiAgICAqKi8KICAgIHZhciBUZW1wbGF0ZUZhY2FkZSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHRlbXBsYXRlRmFjYWRlID0gZmFjYWRlLmNyZWF0ZUZhY2FkZShmdW5jdGlvbiAobW9kdWxlLCBwYXJlbnQpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gbW9kdWxlLm5hbWUgKyAnLXRlbXBsYXRlJzsKICAgICAgICAgICAgdGhpcy5tb2R1bGUgPSBtb2R1bGU7CiAgICAgICAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgICAgICAgICB0aGlzLl9fY29udmVudGlvbnMgPSBwYXJlbnQuX19jb252ZW50aW9uczsKICAgICAgICAgICAgZXh0ZW5kKHRoaXMsIHsKICAgICAgICAgICAgICAgIGZldGNoOiBiaW5kKHBhcmVudC5mZXRjaCwgcGFyZW50KSwKICAgICAgICAgICAgICAgIGdldDogYmluZChwYXJlbnQuZ2V0LCBwYXJlbnQpLAogICAgICAgICAgICAgICAgaGFzOiBiaW5kKHBhcmVudC5oYXMsIHBhcmVudCkKICAgICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHRlbXBsYXRlRmFjYWRlOwogICAgfSkoKTsKICAgIC8qKgogICAgQU1EIEFQSQogICAgbG9hZAogICAgCiAgICBIYW5kbGVzIGZldGNoaW5nIG9mIGEgdGhydXN0L3RlbXBsYXRlIGJ5IHBhdGguCiAgICBSZXF1aXJlcyB0aGUgaW5zdGFuY2UsIHRoYXQgdGhlIHRlbXBsYXRlIGlzIGV4cGVjdGVkIHRvIGNvbWUgZnJvbS4KICAgIHRocnVzdEluc3RhbmNlWzplbmdpbmVOYW1lXTp0ZW1wbGF0ZVBhdGgKICAgIAogICAgUHJlZml4IHdpdGggPGVuZ2luZU5hbWU+OiB0byBzZWxlY3QgYSBzcGVjaWZpYyB0ZW1wbGF0ZSBlbmdpbmUuCiAgICB0aHJ1c3QvdGVtcGxhdGUhZ2xvYmFsOnRlbXBsYXRlcy9teVRlbXBsYXRlLnRtcGwgPSBTcGVjaWZpYyB0ZW1wbGF0ZQogICAgdGhydXN0L3RlbXBsYXRlIWluc3RhbmNlMjp0ZW1wbGF0ZXMvbXlUZW1wbGF0ZSA9IFVzZXMgZGVmYXVsdCBleHRlbnNpb24gZnJvbSBjb25maWcKICAgIHRocnVzdC90ZW1wbGF0ZSFpbnN0YW5jZTI6a2VuZG86dGVtcGxhdGVzL215VGVtcGxhdGUudG1wbCA9IFVzZXMgdGhlIGtlbmRvIHRlbXBsYXRlIGVuZ2luZS4KICAgIHRocnVzdC90ZW1wbGF0ZSFpbnN0YW5jZTM6a2VuZG86dGVtcGxhdGVzL215VGVtcGxhdGUudG1wbCA9IFVzZXMgdGhlIGtlbmRvIHRlbXBsYXRlIGVuZ2luZSB3aXRoIHRoZSBkZWZhdWx0IGV4dGVuc2lvbgogICAgCiAgICAKICAgIEBtZXRob2QgbG9hZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHRlbXBsYXRlIHRoYXQgaXMgYmVpbmcgZmV0Y2hlZAogICAgQHBhcmFtIHtGdW5jdGlvbn0gcGFyZW50UmVxdWlyZSB0aGUgcmVxdWlyZSBtZXRob2QgdG8gYmUgbG9hZGVkCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBsb2FkIEFsbG93cyB0aGUgbG9hZCB0byBpbmZvcm0gdGhhdCBBTUQgZm9yIHRoZSB2YWx1ZSB0byBoYW5kIG9mZgogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgY3VzdG9tIGNvbmZpZ3VyYXRpb24uCiAgICAqKi8KICAgIC8vIE5vdCBjb21wbGV0ZWQgeWV0CiAgICAvLyBTaG91bGQgYmVoYXZlIHNpbWlsYXJseSB0byB0ZXh0IQogICAgLy9leHBvcnQgZnVuY3Rpb24gbG9hZChuYW1lOiBzdHJpbmcsIHBhcmVudFJlcXVpcmUsIGxvYWQsIGNvbmZpZykKICAgIC8vewogICAgLy8gICAgdmFyIHRlbXBsYXRlUGF0aCA9IG5hbWUsCiAgICAvLyAgICAgICAgdGVtcGxhdGVFbmdpbmUsCiAgICAvLyAgICAgICAgY29sb24gPSB0ZW1wbGF0ZVBhdGguaW5kZXhPZignOicpOwogICAgLy8JdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgnOicpLAogICAgLy8gICAgICAgIGluc3RhbmNlTmFtZSA9IHBhcnRzWzBdLAogICAgLy8JCXRlbXBsYXRlRW5naW5lID0gcGFydHNbMV0sCiAgICAvLwkJdGVtcGxhdGVQYXRoID0gcGFydHNbMl0gfHwgdGVtcGxhdGVFbmdpbmU7CiAgICAvLyAgICBpZiAocGFydHMubGVuZ3RoID09PSAyKQogICAgLy8gICAgICAgIHRlbXBsYXRlRW5naW5lID0gbnVsbDsKICAgIC8vCS8vdmFyIGluc3RhbmNlUHJvbWlzZSA9IFRocnVzdC5fX2ZldGNoSW5zdGFuY2UocmVhbE5hbWUpOwogICAgLy8gICAgLy8gR2V0IHRoZSBkYXRhIHBsdWdpbi4KICAgIC8vICAgIHBhcmVudFJlcXVpcmUoWyd0aHJ1c3QhZGF0YTonICsgaW5zdGFuY2VOYW1lXSwgKGRhdGFQbHVnaW4pID0+CiAgICAvLyAgICB7CiAgICAvLyAgICAgICAgdmFyIGRhdGFQbHVnaW4gPSBkYXRhUGx1Z2luCiAgICAvLyAgICB9KTsKICAgIC8vfQogICAgfSkKLy9AIHNvdXJjZU1hcHBpbmdVUkw9bWFpbi5qcy5tYXAKOwpkZWZpbmUoJ3RocnVzdC90ZW1wbGF0ZScsIFsndGhydXN0L3RlbXBsYXRlL21haW4nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwoKZGVmaW5lKCd0aHJ1c3Qvc3BhL21haW4nLFsicmVxdWlyZSIsICJleHBvcnRzIiwgJ3RocnVzdC91dGlsJywgJ3RocnVzdCcsICd0aHJ1c3QvbG9nJywgJ2hhcycsICdmbGF0aXJvbi9kaXJlY3RvcicsICd0aHJ1c3QvaW5zdGFuY2UnLCAnLi9jb25maWcnXSwgZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgX191dGlsX18sIF9fdGhydXN0X18sIF9fbG9nX18sIF9faGFzX18sIF9fZmxhdGlyb25Sb3V0ZXJfXywgX19pbnN0YW5jZV9fLCBfX2NvbmZpZ19fKSB7CiAgICAvLy8gPHJlZmVyZW5jZSBwYXRoPSIuLi9pbnRlcmZhY2VzL3NwYS9zcGEuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uL2ludGVyZmFjZXMvbWVkaWF0b3IvbWVkaWF0b3IuZC50cyIgLz4KICAgIC8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4uLy4uLy4uL2xpYi9EZWZpbml0ZWx5VHlwZWQvcmVxdWlyZWpzL3JlcXVpcmUuZC50cyIgLz4KICAgIC8vIERpc2FibGVkIHVudGlsIFRTIHN1cHBvcnRzIG1vZHVsZSBwZXIgZmlsZSBpbiBzb21lIHdheSAoaWUgZXhwb3J0cyBpcyBleHBvcnRzLjxleHBvcnQ+IG5vdCAgZXhwb3J0cy5tb2R1bGVOYW1lLjxleHBvcnQ+KQogICAgLypleHBvcnQgbW9kdWxlIGluc3RhbmNlIHsqLwogICAgCiAgICB2YXIgdXRpbCA9IF9fdXRpbF9fOwoKICAgIHZhciBfID0gdXRpbC5fOwogICAgdmFyIHRocnVzdCA9IF9fdGhydXN0X187CgogICAgdmFyIFRocnVzdCA9IHRocnVzdC5UaHJ1c3Q7CiAgICB2YXIgbG9nID0gX19sb2dfXzsKCiAgICB2YXIgaGFzID0gX19oYXNfXzsKCiAgICB2YXIgZmxhdGlyb25Sb3V0ZXIgPSBfX2ZsYXRpcm9uUm91dGVyX187CgogICAgdmFyIFJvdXRlciA9IGZsYXRpcm9uUm91dGVyLlJvdXRlciB8fCBmbGF0aXJvblJvdXRlcjsKICAgIAogICAgdmFyIGluc3RhbmNlID0gX19pbnN0YW5jZV9fOwoKICAgIHZhciBjb25maWcgPSBfX2NvbmZpZ19fOwoKICAgIGV4cG9ydHMuY2xhc3NOYW1lID0gJ1NpbmdsZVBhZ2VBcHBsaWNhdGlvbic7CiAgICBjb25maWc7CiAgICB2YXIgZWFjaCA9IF8uZWFjaCwgaXNTdHJpbmcgPSBfLmlzU3RyaW5nLCBpc0FycmF5ID0gXy5pc0FycmF5LCBpc0Z1bmN0aW9uID0gXy5pc0Z1bmN0aW9uLCBpc09iamVjdCA9IF8uaXNPYmplY3QsIGlzUmVnRXhwID0gXy5pc1JlZ0V4cCwgZXh0ZW5kID0gXy5leHRlbmQsIG9uY2UgPSBfLm9uY2UsIHdoZW4gPSB1dGlsLndoZW4sIGJpbmQgPSBfLmJpbmQsIGludm9rZSA9IF8uaW52b2tlLCBwbHVjayA9IF8ucGx1Y2ssIG1hcCA9IF8ubWFwLCBkZWZlciA9IF8uZGVmZXIsIHJlZHVjZSA9IF8ucmVkdWNlLCBtZW1vaXplID0gXy5tZW1vaXplLCB0b0FycmF5ID0gXy50b0FycmF5LCBmb3JtYXQgPSB1dGlsLmZvcm1hdCwgU1RBUlQgPSAnc3RhcnQnOwogICAgdmFyIGV4dHJhY3RQYXJhbXMgPSBmdW5jdGlvbiAocm91dGUpIHsKICAgICAgICB2YXIgcGFyYW1zID0gW10sIGluZGV4ID0gcm91dGUuaW5kZXhPZignOicpLCBzbGFzaEluZGV4OwogICAgICAgIHdoaWxlKGluZGV4ID4gLTEpIHsKICAgICAgICAgICAgc2xhc2hJbmRleCA9IHJvdXRlLmluZGV4T2YoJy8nLCBpbmRleCk7CiAgICAgICAgICAgIGlmKHNsYXNoSW5kZXggPT09IC0xKSB7CiAgICAgICAgICAgICAgICBzbGFzaEluZGV4ID0gcm91dGUubGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBhcmFtcy5wdXNoKHJvdXRlLnN1YnN0cmluZyhpbmRleCwgc2xhc2hJbmRleCAtIGluZGV4ICsgMSkpOwogICAgICAgICAgICByb3V0ZSA9IHJvdXRlLnN1YnN0cmluZyhzbGFzaEluZGV4KTsKICAgICAgICAgICAgaW5kZXggPSByb3V0ZS5pbmRleE9mKCc6Jyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwYXJhbXM7CiAgICB9OwogICAgdmFyIGV2ZW50RmFjdG9yeSA9IGZ1bmN0aW9uIChldmVudCwgbWVkaWF0b3IpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdGaXJpbmcgc3BhICJ7MH0iIHdpdGggW3sxfV0nLCBldmVudCwgdG9BcnJheShhcmd1bWVudHMpLmpvaW4oJywnKSkpOwogICAgICAgICAgICBtZWRpYXRvci5maXJlLmFzeW5jLmFwcGx5KG1lZGlhdG9yLCBbCiAgICAgICAgICAgICAgICBldmVudAogICAgICAgICAgICBdLmNvbmNhdCh0b0FycmF5KGFyZ3VtZW50cykpKTsKICAgICAgICB9OwogICAgfTsKICAgIC8qKgogICAgCiAgICBAZm9yIHRocnVzdC5zcGEKICAgIEBjbGFzcyB0aHJ1c3Quc3BhLlNpbmdsZVBhZ2VBcHAKICAgIEBjb25zdHJ1Y3RvcgogICAgQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgdGhydXN0IGluc3RhbmNlIGNvbmZpZ3VyYXRpb24KICAgIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZU5hbWUgVGhlIHRocnVzdCBpbnN0YW5jZSBuYW1lCiAgICBAcGFyYW0ge3RocnVzdC5tZWRpYXRvck1lZGlhdG9yfSBtZWRpYXRvciBUaGUgdGhydXN0IGluc3RhbmNlIG1lZGlhdG9yCiAgICAqKi8KICAgIHZhciBTaW5nbGVQYWdlQXBwbGljYXRpb24gPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFNpbmdsZVBhZ2VBcHBsaWNhdGlvbihjb25maWcsIGluc3RhbmNlTmFtZSwgbWVkaWF0b3IpIHsKICAgICAgICAgICAgdGhpcy5zdGFydGluZ01vZHVsZVByb21pc2UgPSBudWxsOwogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHRoYXQuYmFzZVVybCA9IGNvbmZpZy51cmwucGF0aDsKICAgICAgICAgICAgdmFyIHNwYUNvbmZpZyA9IGNvbmZpZy5zcGE7CiAgICAgICAgICAgIHRoYXQuZmlsZUV4dGVuc2lvbiA9IHNwYUNvbmZpZy5maWxlRXh0ZW5zaW9uOwogICAgICAgICAgICB2YXIgcm91dGVzID0gdGhhdC5jb25maWd1cmVSb3V0ZXMoc3BhQ29uZmlnLnJvdXRlcyksIHBhcmFtcyA9IHNwYUNvbmZpZy5wYXJhbXM7CiAgICAgICAgICAgIHZhciBldmVudEZhY3RvcnkgPSBtZW1vaXplKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBmYWxzZSAmJiBsb2cuZGVidWcoZm9ybWF0KCdGaXJpbmcgc3BhICJ7MH0iIHdpdGggW3sxfV0nLCBldmVudCwgdG9BcnJheShhcmd1bWVudHMpLmpvaW4oJywnKSkpOwogICAgICAgICAgICAgICAgICAgIG1lZGlhdG9yLmZpcmUuYXN5bmMuYXBwbHkobWVkaWF0b3IsIFsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQKICAgICAgICAgICAgICAgICAgICBdLmNvbmNhdCh0b0FycmF5KGFyZ3VtZW50cykpKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB2YXIgcm91dGVyID0gdGhhdC5yb3V0ZXIgPSBuZXcgUm91dGVyKHJvdXRlcykuY29uZmlndXJlKHsKICAgICAgICAgICAgICAgIHJlY3Vyc2U6IGZhbHNlLAogICAgICAgICAgICAgICAgc3RyaWN0OiBmYWxzZSwKICAgICAgICAgICAgICAgIGFzeW5jOiBmYWxzZSwKICAgICAgICAgICAgICAgIGh0bWw1aGlzdG9yeTogdHJ1ZSwKICAgICAgICAgICAgICAgIG5vdGZvdW5kOiBldmVudEZhY3RvcnkoJ3RocnVzdC9zcGEvcm91dGUvbm90Zm91bmQnKSwKICAgICAgICAgICAgICAgIGJlZm9yZTogZXZlbnRGYWN0b3J5KCd0aHJ1c3Qvc3BhL3JvdXRlL2JlZm9yZScpLAogICAgICAgICAgICAgICAgb246IGV2ZW50RmFjdG9yeSgndGhydXN0L3NwYS9yb3V0ZS9ydW4nKSwKICAgICAgICAgICAgICAgIGFmdGVyOiBldmVudEZhY3RvcnkoJ3RocnVzdC9zcGEvcm91dGUvYWZ0ZXInKQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgXy5lYWNoKHBhcmFtcywgZnVuY3Rpb24gKHgsIGkpIHsKICAgICAgICAgICAgICAgIHJvdXRlci5wYXJhbShpLCB4KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICBTdGFydCB0aGUgc2luZ2xlIHBhZ2UgYXBwIHJvdXRlci4KICAgICAgICAgICAgCiAgICAgICAgICAgIEBtZXRob2Qgc3RhcnQKICAgICAgICAgICAgKiovCiAgICAgICAgICAgIHRoYXQuc3RhcnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGF0LnRocnVzdCA9IGluc3RhbmNlLmdldEluc3RhbmNlKGluc3RhbmNlTmFtZSk7CiAgICAgICAgICAgICAgICB0aGF0LnJvdXRlci5pbml0KCk7CiAgICAgICAgICAgICAgICBtZWRpYXRvci5maXJlLmFzeW5jKCd0aHJ1c3Qvc3BhL3N0YXJ0Jyk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoYXQubmF2aWdhdGUgPSB0aGF0Lm5hdmlnYXRlLmJpbmQodGhhdCk7CiAgICAgICAgfQogICAgICAgIFNpbmdsZVBhZ2VBcHBsaWNhdGlvbi5wcm90b3R5cGUubmF2aWdhdGUgPSAvKioKICAgICAgICBOYXZpZ2F0ZXMgdG8gdGhlIGdpdmVuIHVybC4KICAgICAgICAKICAgICAgICBAbWV0aG9kIG5hdmlnYXRlCiAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGxvY2F0aW9uIFRoZSBsb2NhdGlvbiB0byBuYXZpZ2F0ZSB0by4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAobG9jYXRpb24pIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgdXJsID0gdXRpbC5maXh1cFVybChsb2NhdGlvbiwgdGhhdC5iYXNlVXJsKTsKICAgICAgICAgICAgdGhhdC5yb3V0ZXIuc2V0Um91dGUodXJsKTsKICAgICAgICB9OwogICAgICAgIFNpbmdsZVBhZ2VBcHBsaWNhdGlvbi5wcm90b3R5cGUuc3RhcnQgPSAvKioKICAgICAgICBTdGFydCB0aGUgc2luZ2xlIHBhZ2UgYXBwIHJvdXRlci4KICAgICAgICAKICAgICAgICBAbWV0aG9kIHN0YXJ0CiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLnRocnVzdCA9IGluc3RhbmNlLmdldEluc3RhbmNlKHRoaXMuaW5zdGFuY2VOYW1lKTsKICAgICAgICAgICAgdGhpcy5yb3V0ZXIuaW5pdCgpOwogICAgICAgICAgICB0aGlzLnRocnVzdC5tZWRpYXRvci5maXJlLmFzeW5jKCd0aHJ1c3Qvc3BhL3N0YXJ0Jyk7CiAgICAgICAgfTsKICAgICAgICBTaW5nbGVQYWdlQXBwbGljYXRpb24ucHJvdG90eXBlLmNvbmZpZ3VyZVJvdXRlcyA9IC8qKgogICAgICAgIENvbmZpZ3VyZXMgdGhlIHJvdXRlIG9iamVjdCBmb3IgdGhlIHNwYSBpbnN0YW5jZQogICAgICAgIAogICAgICAgIFJvdXRlcyBjYW4gYmUgaW4gNCBmb3JtcwogICAgICAgIAogICAgICAgIHsKICAgICAgICAnL3BhdGgvdG8vOmZvbyc6ICdwYXRoL3RvL21vZHVsZScsCiAgICAgICAgJy9wYXRoL3RvLzpiYXInOiBbJ3BhdGgvdG8vbW9kdWxlMScsICdwYXRoL3RvL21vZHVsZTInXSwKICAgICAgICAnL3BhdGgvdG8vOmZiJzogeyBwYXRoOiAncGF0aC90by9tb2R1bGUnLCBhcmdzOiBbJ2FyZ3MnLCAndG8nLCAnaGFuZCBvZmYgdG8gc3RhcnQnXSB9CiAgICAgICAgJy9wYXRoL3RvLzpmb28vOmJhcic6IGZ1bmN0aW9uKGZvbywgYmFyKXsgIGN1c3RvbSBoYW5kbGVyIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgQG1ldGhvZCBjb25maWd1cmVSb3V0ZXMKICAgICAgICBAcGFyYW0ge09iamVjdH0gcm91dGVzIE9iamVjdCBvZiByb3V0ZXMuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHJvdXRlcykgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGNvbmZpZ3VyZWRSb3V0ZXMgPSB7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIC8vIGVhY2gocm91dGVzLCBmdW5jdGlvbiAodmFsdWUsIHJvdXRlKSB7CiAgICAgICAgICAgIGZvcih2YXIgcm91dGUgaW4gcm91dGVzKSB7CiAgICAgICAgICAgICAgICBpZihfLmhhcyhyb3V0ZXMsIHJvdXRlKSkgewogICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IHJvdXRlc1tyb3V0ZV07CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlYWxSb3V0ZSA9IHV0aWwuZml4dXBVcmwocm91dGUsIHRoYXQuYmFzZVVybCk7CiAgICAgICAgICAgICAgICAgICAgaWYoaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJlZFJvdXRlc1tyZWFsUm91dGVdID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtb2R1bGVzID0gW10sIG1ldGhvZHMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaUxlbiA9IHZhbHVlLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHYgPSB2YWx1ZVt2XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlzU3RyaW5nKHYpIHx8IGlzT2JqZWN0KHYpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxlcy5wdXNoKHYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGlzRnVuY3Rpb24odikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRob2RzLnB1c2godik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vZHVsZUNhbGxiYWNrID0gdGhhdC5tb2R1bGVTdGFydENhbGxiYWNrKHJvdXRlLCBtb2R1bGVzKTsKICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kcy5wdXNoKG1vZHVsZUNhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJlZFJvdXRlc1tyZWFsUm91dGVdID0gbWV0aG9kczsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoaXNTdHJpbmcodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtb2R1bGVDYWxsYmFjayA9IHRoYXQubW9kdWxlU3RhcnRDYWxsYmFjayhyb3V0ZSwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25maWd1cmVkUm91dGVzW3JlYWxSb3V0ZV0gPSBtb2R1bGVDYWxsYmFjazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy99KTsKICAgICAgICAgICAgcmV0dXJuIGNvbmZpZ3VyZWRSb3V0ZXM7CiAgICAgICAgfTsKICAgICAgICBTaW5nbGVQYWdlQXBwbGljYXRpb24ucHJvdG90eXBlLm1vZHVsZVN0YXJ0Q2FsbGJhY2sgPSAvKioKICAgICAgICAKICAgICAgICBAbWV0aG9kIG1vZHVsZVN0YXJ0Q2FsbGJhY2sKICAgICAgICBAcHJpdmF0ZQogICAgICAgIEBwYXJhbSB7U3RyaW5nIHwgQXJyYXkgfCBPYmplY3R9IG1vZHVsZXMgU3RyaW5nIHRvIHN0YXJ0IGEgc2luZ2xlIG1vZHVsZSwgQXJyYXkgdG8gc3RhcnQgbWFueSBtb2R1bGVzLCBPYmplY3QgdG8gc3RhcnQgYSBtb2R1bGUgd2l0aCBzcGVjaWZpYyBhcmd1bWVudHMuCiAgICAgICAgKiovCiAgICAgICAgZnVuY3Rpb24gKHJvdXRlLCBtb2R1bGVzKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW10sIHBhcmFtcyA9IGV4dHJhY3RQYXJhbXMocm91dGUpLCB0aGF0ID0gdGhpcywgZmlsZUV4dGVuc2lvbiA9IHRoYXQuZmlsZUV4dGVuc2lvbjsKICAgICAgICAgICAgaWYoaXNPYmplY3QobW9kdWxlcykpIHsKICAgICAgICAgICAgICAgIGFyZ3MgPSBtb2R1bGVzLmFyZ3MgfHwgYXJnczsKICAgICAgICAgICAgICAgIG1vZHVsZXMgPSBtb2R1bGVzLnBhdGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoaXNTdHJpbmcobW9kdWxlcykpIHsKICAgICAgICAgICAgICAgIG1vZHVsZXMgPSBbCiAgICAgICAgICAgICAgICAgICAgbW9kdWxlcwogICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGFyID0gdG9BcnJheShhcmd1bWVudHMpLCB0aHJ1c3QgPSB0aGF0LnRocnVzdCwgbWFwcGVkTW9kdWxlcyA9IG1hcChtb2R1bGVzLCBmdW5jdGlvbiAobW9kdWxlUGF0aCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiByZWR1Y2UoYXIsIGZ1bmN0aW9uIChtZW1vLCBhcmcsIGkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1lbW8ucmVwbGFjZShwYXJhbXNbaV0sIGFyZy50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgICAgICB9LCBtb2R1bGVQYXRoKS5yZXBsYWNlKGZpbGVFeHRlbnNpb24sICcnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdmFyIHByb21pc2UgPSB0aHJ1c3Quc3RhcnQuYXBwbHkodGhydXN0LCBbCiAgICAgICAgICAgICAgICAgICAgbWFwcGVkTW9kdWxlcwogICAgICAgICAgICAgICAgXS5jb25jYXQoYXJncykpOwogICAgICAgICAgICAgICAgaWYoIXRoYXQudGhydXN0LnN0YXJ0ZWQpIHsKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJ1c3QucmVhZHkobWFwcGVkTW9kdWxlcywgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGF0LnN0YXJ0aW5nTW9kdWxlUHJvbWlzZSA9IHByb21pc2U7CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICBTaW5nbGVQYWdlQXBwbGljYXRpb24ucHJvdG90eXBlLmNyZWF0ZUZhY2FkZSA9IC8qKgogICAgICAgIEhhbmRzIHRoZSBuYXZpZ2F0ZSBtZXRob2Qgb2ZmIHRvIHRoZSBtb2R1bGUsIHNvIGFueSBtb2R1bGUgY2FuIHRyaWdnZXIgYSBuYXZpZ2F0aW9uIGV2ZW50LgogICAgICAgIAogICAgICAgIEBmb3IgdGhydXN0LnNwYS5TaW5nbGVQYWdlQXBwCiAgICAgICAgQG1ldGhvZCBjcmVhdGVGYWNhZGUKICAgICAgICBAcGFyYW0ge3RocnVzdC5UaHJ1c3R9IHRocnVzdCBUaGUgdGhydXN0IGluc3RhbmNlCiAgICAgICAgQHBhcmFtIHt0aHJ1c3QuTW9kdWxlfSBtb2QgVGhlIG1vZHVsZSB0byBjcmVhdGUgdGhlIGZhY2FkZSBmb3IKICAgICAgICBAcGFyYW0ge09iamVjdH0gZmFjYWRlcyBUaGUgZmFjYWRlcyBhbHJlYWR5IGFkZGVkIGZvciB0aGlzIG1vZHVsZS4KICAgICAgICAqKi8KICAgICAgICBmdW5jdGlvbiAodGhydXN0LCBtb2QsIGZhY2FkZXMpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZihtb2QubmF2aWdhdGUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignIm5hdmlnYXRlIiBpcyBhIHJlc2VydmVkIHByb3BlcnR5Jyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gQWxyZWFkeSBwcmUgYm91bmQsIHNvIHdlIG9ubHkgcGFzcyBhcm91bmQgMSBmdW5jdGlvbiBwZXIgaW5zdGFuY2UuCiAgICAgICAgICAgIG1vZC5uYXZpZ2F0ZSA9IHRoYXQubmF2aWdhdGUuYmluZCh0aGF0KTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBTaW5nbGVQYWdlQXBwbGljYXRpb24uY29uZmlnID0gY29uZmlnOwogICAgICAgIHJldHVybiBTaW5nbGVQYWdlQXBwbGljYXRpb247CiAgICB9KSgpOwogICAgZXhwb3J0cy5TaW5nbGVQYWdlQXBwbGljYXRpb24gPSBTaW5nbGVQYWdlQXBwbGljYXRpb247ICAgIAp9KQovL0Agc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcAo7CmRlZmluZSgndGhydXN0L3NwYScsIFsndGhydXN0L3NwYS9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 20:05:27 GMT",
                    "Content-Length": "231879",
                    "Date": "Sat, 08 Nov 2014 20:05:28 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}