{
    "url": "http://localhost:9999/cloudcms-components/alpaca/alpaca.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>parent.name</b> and written to <b>the 'name' property of a DOM element</b> via the following statement:<ul><li>v.name = v.name.replace(parent.preName, parent.name);</li></ul><b>Note:</b> The name of the current window is a valid attack vector for DOM-based vulnerabilities. An attacker can directly control the name of the targeted application's window by using code on their own domain to load the targeted page using either window.open() or an iframe tag, and specifying the desired window name. ",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/cloudcms-components/alpaca/alpaca.js",
                "path": "/cloudcms-components/alpaca/alpaca.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9jbG91ZGNtcy1jb21wb25lbnRzL2FscGFjYS9hbHBhY2EuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogODAxODc1DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBUaHUsIDA2IE5vdiAyMDE0IDA2OjUyOjA1IEdNVA0KTGFzdC1Nb2RpZmllZDogVGh1LCAwNiBOb3YgMjAxNCAwNjo1MjowNSBHTVQNCg0KLyohCkFscGFjYSBWZXJzaW9uIDEuMS4zCgpDb3B5cmlnaHQgMjAxNCBHaXRhbmEgU29mdHdhcmUsIEluYy4KCkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOyAKeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiAKCllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdCAKCWh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMCAKClVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUgCmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsIApXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gClNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgCmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAKCkZvciBtb3JlIGluZm9ybWF0aW9uLCBwbGVhc2UgY29udGFjdCBHaXRhbmEgU29mdHdhcmUsIEluYy4gYXQgdGhpcwphZGRyZXNzOgoKICBpbmZvQGdpdGFuYXNvZnR3YXJlLmNvbQoqLwovKioKICogVU1EIHdyYXBwZXIgZm9yIGNvbXBhdGliaWxpdHkgd2l0aCBicm93c2VyLCBOb2RlIGFuZCBBTUQuCiAqCiAqIEJhc2VkIG9uOgogKiAgIGh0dHBzOi8vZ2l0aHViLmNvbS91bWRqcy91bWQvYmxvYi9tYXN0ZXIvcmV0dXJuRXhwb3J0cy5qcwogKi8KKGZ1bmN0aW9uIChyb290LCBmYWN0b3J5KQp7CiAgICB2YXIgdW1kRW5hYmxlZCA9IHRydWU7CiAgICBpZiAocm9vdCAmJiB0eXBlb2Yocm9vdC51bWQpICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgdW1kRW5hYmxlZCA9IHJvb3QudW1kOwogICAgfQoKICAgIGlmICh1bWRFbmFibGVkICYmIHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykKICAgIHsKICAgICAgICAvLyBOb2RlLiBEb2VzIG5vdCB3b3JrIHdpdGggc3RyaWN0IENvbW1vbkpTLCBidXQKICAgICAgICAvLyBvbmx5IENvbW1vbkpTLWxpa2UgZW52aXJvbm1lbnRzIHRoYXQgc3VwcG9ydCBtb2R1bGUuZXhwb3J0cywKICAgICAgICAvLyBsaWtlIE5vZGUuCiAgICAgICAgLy9tb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkocmVxdWlyZSgnYicpKTsKICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKTsKICAgIH0KICAgIGVsc2UgaWYgKHVtZEVuYWJsZWQgJiYgdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKQogICAgewogICAgICAgIC8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS4KICAgICAgICAvL2RlZmluZShbJ2InXSwgZmFjdG9yeSk7CiAgICAgICAgZGVmaW5lKCdhbHBhY2EnLCBbJ2pxdWVyeScsICdqcXVlcnktdG1wbCcsICdqcXVlcnktdWknXSwgZmFjdG9yeSk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgLy8gQnJvd3NlciBnbG9iYWxzCiAgICAgICAgLy9yb290LnJldHVybkV4cG9ydHMgPSBmYWN0b3J5KHJvb3QuYik7CiAgICAgICAgcm9vdFsiQWxwYWNhIl0gPSBmYWN0b3J5KCk7CiAgICB9Cgp9KHRoaXMsIGZ1bmN0aW9uICgkLCB0bXBsLCBqUXVlcnlVSSwgYWNlKSB7CgogICAgLy91c2UgYiBpbiBzb21lIGZhc2hpb24uCgogICAgLy8gSnVzdCByZXR1cm4gYSB2YWx1ZSB0byBkZWZpbmUgdGhlIG1vZHVsZSBleHBvcnQuCiAgICAvLyBUaGlzIGV4YW1wbGUgcmV0dXJucyBhbiBvYmplY3QsIGJ1dCB0aGUgbW9kdWxlCiAgICAvLyBjYW4gcmV0dXJuIGEgZnVuY3Rpb24gYXMgdGhlIGV4cG9ydGVkIHZhbHVlLgogICAgLy9yZXR1cm4ge307CgogICAgLyohCkFscGFjYSBWZXJzaW9uIDEuMS4zCgpDb3B5cmlnaHQgMjAxNCBHaXRhbmEgU29mdHdhcmUsIEluYy4KCkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOyAKeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiAKCllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdCAKCWh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMCAKClVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUgCmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsIApXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gClNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgCmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAKCkZvciBtb3JlIGluZm9ybWF0aW9uLCBwbGVhc2UgY29udGFjdCBHaXRhbmEgU29mdHdhcmUsIEluYy4gYXQgdGhpcwphZGRyZXNzOgoKICBpbmZvQGdpdGFuYXNvZnR3YXJlLmNvbQoqLwovKgogQmFzZWQgb24gQmFzZS5qcyAxLjFhIChjKSAyMDA2LTIwMTAsIERlYW4gRWR3YXJkcwogVXBkYXRlZCB0byBwYXNzIEpTSGludCBhbmQgY29udmVydGVkIGludG8gYSBtb2R1bGUgYnkgS2VubmV0aCBQb3dlcnMKIExpY2Vuc2U6IGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwCgogR2l0SHViOiBodHRwczovL2dpdGh1Yi5jb20vS2VuUG93ZXJzL0Jhc2UuanMtTW9kdWxlCiAqLwovKmdsb2JhbCBkZWZpbmU6dHJ1ZSBtb2R1bGU6dHJ1ZSovCi8qanNoaW50IGVxZXFlcTp0cnVlKi8KKGZ1bmN0aW9uIChuYW1lLCBnbG9iYWwsIGRlZmluaXRpb24pIHsKLy8gICAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnKSB7Ci8vICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGRlZmluaXRpb24oKTsKLy8gICAgfSBlbHNlIGlmICh0eXBlb2YgZGVmaW5lICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgZGVmaW5lLmFtZCA9PT0gJ29iamVjdCcpIHsKLy8gICAgICAgIGRlZmluZShkZWZpbml0aW9uKTsKLy8gICAgfSBlbHNlIHsKICAgICAgICBnbG9iYWxbbmFtZV0gPSBkZWZpbml0aW9uKCk7Ci8vICAgIH0KfSkoJ0Jhc2UnLCB0aGlzLCBmdW5jdGlvbiAoKSB7CiAgICAvLyBCYXNlIE9iamVjdAogICAgdmFyIEJhc2UgPSBmdW5jdGlvbiAoKSB7fTsKCiAgICAvLyBJbXBsZW1lbnRhdGlvbgogICAgQmFzZS5leHRlbmQgPSBmdW5jdGlvbiAoX2luc3RhbmNlLCBfc3RhdGljKSB7IC8vIHN1YmNsYXNzCiAgICAgICAgdmFyIGV4dGVuZCA9IEJhc2UucHJvdG90eXBlLmV4dGVuZDsKICAgICAgICAvLyBidWlsZCB0aGUgcHJvdG90eXBlCiAgICAgICAgQmFzZS5fcHJvdG90eXBpbmcgPSB0cnVlOwogICAgICAgIHZhciBwcm90byA9IG5ldyB0aGlzKCk7CiAgICAgICAgZXh0ZW5kLmNhbGwocHJvdG8sIF9pbnN0YW5jZSk7CiAgICAgICAgcHJvdG8uYmFzZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgLy8gY2FsbCB0aGlzIG1ldGhvZCBmcm9tIGFueSBvdGhlciBtZXRob2QgdG8gaW52b2tlIHRoYXQgbWV0aG9kJ3MgYW5jZXN0b3IKICAgICAgICB9OwogICAgICAgIGRlbGV0ZSBCYXNlLl9wcm90b3R5cGluZzsKICAgICAgICAvLyBjcmVhdGUgdGhlIHdyYXBwZXIgZm9yIHRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbgogICAgICAgIC8vdmFyIGNvbnN0cnVjdG9yID0gcHJvdG8uY29uc3RydWN0b3IudmFsdWVPZigpOyAvLy1kZWFuCiAgICAgICAgdmFyIGNvbnN0cnVjdG9yID0gcHJvdG8uY29uc3RydWN0b3I7CiAgICAgICAgdmFyIGtsYXNzID0gcHJvdG8uY29uc3RydWN0b3IgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICghQmFzZS5fcHJvdG90eXBpbmcpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9jb25zdHJ1Y3RpbmcgfHwgdGhpcy5jb25zdHJ1Y3RvciA9PT0ga2xhc3MpIHsgLy8gaW5zdGFudGlhdGlvbgogICAgICAgICAgICAgICAgICAgIHRoaXMuX2NvbnN0cnVjdGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5fY29uc3RydWN0aW5nOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhcmd1bWVudHNbMF0gIT09IG51bGwpIHsgLy8gY2FzdGluZwogICAgICAgICAgICAgICAgICAgIHJldHVybiAoYXJndW1lbnRzWzBdLmV4dGVuZCB8fCBleHRlbmQpLmNhbGwoYXJndW1lbnRzWzBdLCBwcm90byk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIC8vIGJ1aWxkIHRoZSBjbGFzcyBpbnRlcmZhY2UKICAgICAgICBrbGFzcy5hbmNlc3RvciA9IHRoaXM7CiAgICAgICAga2xhc3MuZXh0ZW5kID0gdGhpcy5leHRlbmQ7CiAgICAgICAga2xhc3MuZm9yRWFjaCA9IHRoaXMuZm9yRWFjaDsKICAgICAgICBrbGFzcy5pbXBsZW1lbnQgPSB0aGlzLmltcGxlbWVudDsKICAgICAgICBrbGFzcy5wcm90b3R5cGUgPSBwcm90bzsKICAgICAgICBrbGFzcy50b1N0cmluZyA9IHRoaXMudG9TdHJpbmc7CiAgICAgICAga2xhc3MudmFsdWVPZiA9IGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgICAgIHJldHVybiAodHlwZSA9PT0gJ29iamVjdCcpID8ga2xhc3MgOiBjb25zdHJ1Y3Rvci52YWx1ZU9mKCk7CiAgICAgICAgfTsKICAgICAgICBleHRlbmQuY2FsbChrbGFzcywgX3N0YXRpYyk7CiAgICAgICAgLy8gY2xhc3MgaW5pdGlhbGl6YXRpb24KICAgICAgICBpZiAodHlwZW9mIGtsYXNzLmluaXQgPT09ICdmdW5jdGlvbicpIGtsYXNzLmluaXQoKTsKICAgICAgICByZXR1cm4ga2xhc3M7CiAgICB9OwoKICAgIEJhc2UucHJvdG90eXBlID0gewogICAgICAgIGV4dGVuZDogZnVuY3Rpb24gKHNvdXJjZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7IC8vIGV4dGVuZGluZyB3aXRoIGEgbmFtZS92YWx1ZSBwYWlyCiAgICAgICAgICAgICAgICB2YXIgYW5jZXN0b3IgPSB0aGlzW3NvdXJjZV07CiAgICAgICAgICAgICAgICBpZiAoYW5jZXN0b3IgJiYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJykgJiYgLy8gb3ZlcnJpZGluZyBhIG1ldGhvZD8KICAgICAgICAgICAgICAgICAgICAvLyB0aGUgdmFsdWVPZigpIGNvbXBhcmlzb24gaXMgdG8gYXZvaWQgY2lyY3VsYXIgcmVmZXJlbmNlcwogICAgICAgICAgICAgICAgICAgICghYW5jZXN0b3IudmFsdWVPZiB8fCBhbmNlc3Rvci52YWx1ZU9mKCkgIT09IHZhbHVlLnZhbHVlT2YoKSkgJiYgL1xiYmFzZVxiLy50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIC8vIGdldCB0aGUgdW5kZXJseWluZyBtZXRob2QKICAgICAgICAgICAgICAgICAgICB2YXIgbWV0aG9kID0gdmFsdWUudmFsdWVPZigpOwogICAgICAgICAgICAgICAgICAgIC8vIG92ZXJyaWRlCiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmV2aW91cyA9IHRoaXMuYmFzZSB8fCBCYXNlLnByb3RvdHlwZS5iYXNlOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmJhc2UgPSBhbmNlc3RvcjsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJldHVyblZhbHVlID0gbWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYmFzZSA9IHByZXZpb3VzOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmV0dXJuVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAvLyBwb2ludCB0byB0aGUgdW5kZXJseWluZyBtZXRob2QKICAgICAgICAgICAgICAgICAgICB2YWx1ZS52YWx1ZU9mID0gZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICh0eXBlID09PSAnb2JqZWN0JykgPyB2YWx1ZSA6IG1ldGhvZDsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIHZhbHVlLnRvU3RyaW5nID0gQmFzZS50b1N0cmluZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXNbc291cmNlXSA9IHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKHNvdXJjZSkgeyAvLyBleHRlbmRpbmcgd2l0aCBhbiBvYmplY3QgbGl0ZXJhbAogICAgICAgICAgICAgICAgdmFyIGV4dGVuZCA9IEJhc2UucHJvdG90eXBlLmV4dGVuZDsKICAgICAgICAgICAgICAgIC8vIGlmIHRoaXMgb2JqZWN0IGhhcyBhIGN1c3RvbWl6ZWQgZXh0ZW5kIG1ldGhvZCB0aGVuIHVzZSBpdAogICAgICAgICAgICAgICAgaWYgKCFCYXNlLl9wcm90b3R5cGluZyAmJiB0eXBlb2YgdGhpcyAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgIGV4dGVuZCA9IHRoaXMuZXh0ZW5kIHx8IGV4dGVuZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBwcm90byA9IHsKICAgICAgICAgICAgICAgICAgICB0b1NvdXJjZTogbnVsbAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIC8vIGRvIHRoZSAidG9TdHJpbmciIGFuZCBvdGhlciBtZXRob2RzIG1hbnVhbGx5CiAgICAgICAgICAgICAgICB2YXIgaGlkZGVuID0gWydjb25zdHJ1Y3RvcicsICd0b1N0cmluZycsICd2YWx1ZU9mJ107CiAgICAgICAgICAgICAgICAvLyBpZiB3ZSBhcmUgcHJvdG90eXBpbmcgdGhlbiBpbmNsdWRlIHRoZSBjb25zdHJ1Y3RvcgogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IEJhc2UuX3Byb3RvdHlwaW5nID8gMCA6IDE7IGkgPCBoaWRkZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaCA9IGhpZGRlbltpXTsKICAgICAgICAgICAgICAgICAgICBpZiAoc291cmNlW2hdICE9PSBwcm90b1toXSkKICAgICAgICAgICAgICAgICAgICAgICAgZXh0ZW5kLmNhbGwodGhpcywgaCwgc291cmNlW2hdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIGNvcHkgZWFjaCBvZiB0aGUgc291cmNlIG9iamVjdCdzIHByb3BlcnRpZXMgdG8gdGhpcyBvYmplY3QKICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBzb3VyY2UpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXByb3RvW2tleV0pIGV4dGVuZC5jYWxsKHRoaXMsIGtleSwgc291cmNlW2tleV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgIH07CgogICAgLy8gaW5pdGlhbGl6ZQogICAgQmFzZSA9IEJhc2UuZXh0ZW5kKHsKICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLmV4dGVuZChhcmd1bWVudHNbMF0pOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBhbmNlc3RvcjogT2JqZWN0LAogICAgICAgIHZlcnNpb246ICcxLjEnLAogICAgICAgIGZvckVhY2g6IGZ1bmN0aW9uIChvYmplY3QsIGJsb2NrLCBjb250ZXh0KSB7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByb3RvdHlwZVtrZXldID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBibG9jay5jYWxsKGNvbnRleHQsIG9iamVjdFtrZXldLCBrZXksIG9iamVjdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGltcGxlbWVudDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmd1bWVudHNbaV0gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICAvLyBpZiBpdCdzIGEgZnVuY3Rpb24sIGNhbGwgaXQKICAgICAgICAgICAgICAgICAgICBhcmd1bWVudHNbaV0odGhpcy5wcm90b3R5cGUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBhZGQgdGhlIGludGVyZmFjZSB1c2luZyB0aGUgZXh0ZW5kIG1ldGhvZAogICAgICAgICAgICAgICAgICAgIHRoaXMucHJvdG90eXBlLmV4dGVuZChhcmd1bWVudHNbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIFN0cmluZyh0aGlzLnZhbHVlT2YoKSk7CiAgICAgICAgfQogICAgfSk7CgogICAgLy8gUmV0dXJuIEJhc2UgaW1wbGVtZW50YXRpb24KICAgIHJldHVybiBCYXNlOwp9KTsvKgoganNvbjIuanMKIDIwMTItMTAtMDgKCiBQdWJsaWMgRG9tYWluLgoKIE5PIFdBUlJBTlRZIEVYUFJFU1NFRCBPUiBJTVBMSUVELiBVU0UgQVQgWU9VUiBPV04gUklTSy4KCiBTZWUgaHR0cDovL3d3dy5KU09OLm9yZy9qcy5odG1sCgoKIFRoaXMgY29kZSBzaG91bGQgYmUgbWluaWZpZWQgYmVmb3JlIGRlcGxveW1lbnQuCiBTZWUgaHR0cDovL2phdmFzY3JpcHQuY3JvY2tmb3JkLmNvbS9qc21pbi5odG1sCgogVVNFIFlPVVIgT1dOIENPUFkuIElUIElTIEVYVFJFTUVMWSBVTldJU0UgVE8gTE9BRCBDT0RFIEZST00gU0VSVkVSUyBZT1UgRE8KIE5PVCBDT05UUk9MLgoKCiBUaGlzIGZpbGUgY3JlYXRlcyBhIGdsb2JhbCBKU09OIG9iamVjdCBjb250YWluaW5nIHR3byBtZXRob2RzOiBzdHJpbmdpZnkKIGFuZCBwYXJzZS4KCiBKU09OLnN0cmluZ2lmeSh2YWx1ZSwgcmVwbGFjZXIsIHNwYWNlKQogdmFsdWUgICAgICAgYW55IEphdmFTY3JpcHQgdmFsdWUsIHVzdWFsbHkgYW4gb2JqZWN0IG9yIGFycmF5LgoKIHJlcGxhY2VyICAgIGFuIG9wdGlvbmFsIHBhcmFtZXRlciB0aGF0IGRldGVybWluZXMgaG93IG9iamVjdAogdmFsdWVzIGFyZSBzdHJpbmdpZmllZCBmb3Igb2JqZWN0cy4gSXQgY2FuIGJlIGEKIGZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIHN0cmluZ3MuCgogc3BhY2UgICAgICAgYW4gb3B0aW9uYWwgcGFyYW1ldGVyIHRoYXQgc3BlY2lmaWVzIHRoZSBpbmRlbnRhdGlvbgogb2YgbmVzdGVkIHN0cnVjdHVyZXMuIElmIGl0IGlzIG9taXR0ZWQsIHRoZSB0ZXh0IHdpbGwKIGJlIHBhY2tlZCB3aXRob3V0IGV4dHJhIHdoaXRlc3BhY2UuIElmIGl0IGlzIGEgbnVtYmVyLAogaXQgd2lsbCBzcGVjaWZ5IHRoZSBudW1iZXIgb2Ygc3BhY2VzIHRvIGluZGVudCBhdCBlYWNoCiBsZXZlbC4gSWYgaXQgaXMgYSBzdHJpbmcgKHN1Y2ggYXMgJ1x0JyBvciAnJm5ic3A7JyksCiBpdCBjb250YWlucyB0aGUgY2hhcmFjdGVycyB1c2VkIHRvIGluZGVudCBhdCBlYWNoIGxldmVsLgoKIFRoaXMgbWV0aG9kIHByb2R1Y2VzIGEgSlNPTiB0ZXh0IGZyb20gYSBKYXZhU2NyaXB0IHZhbHVlLgoKIFdoZW4gYW4gb2JqZWN0IHZhbHVlIGlzIGZvdW5kLCBpZiB0aGUgb2JqZWN0IGNvbnRhaW5zIGEgdG9KU09OCiBtZXRob2QsIGl0cyB0b0pTT04gbWV0aG9kIHdpbGwgYmUgY2FsbGVkIGFuZCB0aGUgcmVzdWx0IHdpbGwgYmUKIHN0cmluZ2lmaWVkLiBBIHRvSlNPTiBtZXRob2QgZG9lcyBub3Qgc2VyaWFsaXplOiBpdCByZXR1cm5zIHRoZQogdmFsdWUgcmVwcmVzZW50ZWQgYnkgdGhlIG5hbWUvdmFsdWUgcGFpciB0aGF0IHNob3VsZCBiZSBzZXJpYWxpemVkLAogb3IgdW5kZWZpbmVkIGlmIG5vdGhpbmcgc2hvdWxkIGJlIHNlcmlhbGl6ZWQuIFRoZSB0b0pTT04gbWV0aG9kCiB3aWxsIGJlIHBhc3NlZCB0aGUga2V5IGFzc29jaWF0ZWQgd2l0aCB0aGUgdmFsdWUsIGFuZCB0aGlzIHdpbGwgYmUKIGJvdW5kIHRvIHRoZSB2YWx1ZQoKIEZvciBleGFtcGxlLCB0aGlzIHdvdWxkIHNlcmlhbGl6ZSBEYXRlcyBhcyBJU08gc3RyaW5ncy4KCiBEYXRlLnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiAoa2V5KSB7CiBmdW5jdGlvbiBmKG4pIHsKIC8vIEZvcm1hdCBpbnRlZ2VycyB0byBoYXZlIGF0IGxlYXN0IHR3byBkaWdpdHMuCiByZXR1cm4gbiA8IDEwID8gJzAnICsgbiA6IG47CiB9CgogcmV0dXJuIHRoaXMuZ2V0VVRDRnVsbFllYXIoKSAgICsgJy0nICsKIGYodGhpcy5nZXRVVENNb250aCgpICsgMSkgKyAnLScgKwogZih0aGlzLmdldFVUQ0RhdGUoKSkgICAgICArICdUJyArCiBmKHRoaXMuZ2V0VVRDSG91cnMoKSkgICAgICsgJzonICsKIGYodGhpcy5nZXRVVENNaW51dGVzKCkpICAgKyAnOicgKwogZih0aGlzLmdldFVUQ1NlY29uZHMoKSkgICArICdaJzsKIH07CgogWW91IGNhbiBwcm92aWRlIGFuIG9wdGlvbmFsIHJlcGxhY2VyIG1ldGhvZC4gSXQgd2lsbCBiZSBwYXNzZWQgdGhlCiBrZXkgYW5kIHZhbHVlIG9mIGVhY2ggbWVtYmVyLCB3aXRoIHRoaXMgYm91bmQgdG8gdGhlIGNvbnRhaW5pbmcKIG9iamVjdC4gVGhlIHZhbHVlIHRoYXQgaXMgcmV0dXJuZWQgZnJvbSB5b3VyIG1ldGhvZCB3aWxsIGJlCiBzZXJpYWxpemVkLiBJZiB5b3VyIG1ldGhvZCByZXR1cm5zIHVuZGVmaW5lZCwgdGhlbiB0aGUgbWVtYmVyIHdpbGwKIGJlIGV4Y2x1ZGVkIGZyb20gdGhlIHNlcmlhbGl6YXRpb24uCgogSWYgdGhlIHJlcGxhY2VyIHBhcmFtZXRlciBpcyBhbiBhcnJheSBvZiBzdHJpbmdzLCB0aGVuIGl0IHdpbGwgYmUKIHVzZWQgdG8gc2VsZWN0IHRoZSBtZW1iZXJzIHRvIGJlIHNlcmlhbGl6ZWQuIEl0IGZpbHRlcnMgdGhlIHJlc3VsdHMKIHN1Y2ggdGhhdCBvbmx5IG1lbWJlcnMgd2l0aCBrZXlzIGxpc3RlZCBpbiB0aGUgcmVwbGFjZXIgYXJyYXkgYXJlCiBzdHJpbmdpZmllZC4KCiBWYWx1ZXMgdGhhdCBkbyBub3QgaGF2ZSBKU09OIHJlcHJlc2VudGF0aW9ucywgc3VjaCBhcyB1bmRlZmluZWQgb3IKIGZ1bmN0aW9ucywgd2lsbCBub3QgYmUgc2VyaWFsaXplZC4gU3VjaCB2YWx1ZXMgaW4gb2JqZWN0cyB3aWxsIGJlCiBkcm9wcGVkOyBpbiBhcnJheXMgdGhleSB3aWxsIGJlIHJlcGxhY2VkIHdpdGggbnVsbC4gWW91IGNhbiB1c2UKIGEgcmVwbGFjZXIgZnVuY3Rpb24gdG8gcmVwbGFjZSB0aG9zZSB3aXRoIEpTT04gdmFsdWVzLgogSlNPTi5zdHJpbmdpZnkodW5kZWZpbmVkKSByZXR1cm5zIHVuZGVmaW5lZC4KCiBUaGUgb3B0aW9uYWwgc3BhY2UgcGFyYW1ldGVyIHByb2R1Y2VzIGEgc3RyaW5naWZpY2F0aW9uIG9mIHRoZQogdmFsdWUgdGhhdCBpcyBmaWxsZWQgd2l0aCBsaW5lIGJyZWFrcyBhbmQgaW5kZW50YXRpb24gdG8gbWFrZSBpdAogZWFzaWVyIHRvIHJlYWQuCgogSWYgdGhlIHNwYWNlIHBhcmFtZXRlciBpcyBhIG5vbi1lbXB0eSBzdHJpbmcsIHRoZW4gdGhhdCBzdHJpbmcgd2lsbAogYmUgdXNlZCBmb3IgaW5kZW50YXRpb24uIElmIHRoZSBzcGFjZSBwYXJhbWV0ZXIgaXMgYSBudW1iZXIsIHRoZW4KIHRoZSBpbmRlbnRhdGlvbiB3aWxsIGJlIHRoYXQgbWFueSBzcGFjZXMuCgogRXhhbXBsZToKCiB0ZXh0ID0gSlNPTi5zdHJpbmdpZnkoWydlJywge3BsdXJpYnVzOiAndW51bSd9XSk7CiAvLyB0ZXh0IGlzICdbImUiLHsicGx1cmlidXMiOiJ1bnVtIn1dJwoKCiB0ZXh0ID0gSlNPTi5zdHJpbmdpZnkoWydlJywge3BsdXJpYnVzOiAndW51bSd9XSwgbnVsbCwgJ1x0Jyk7CiAvLyB0ZXh0IGlzICdbXG5cdCJlIixcblx0e1xuXHRcdCJwbHVyaWJ1cyI6ICJ1bnVtIlxuXHR9XG5dJwoKIHRleHQgPSBKU09OLnN0cmluZ2lmeShbbmV3IERhdGUoKV0sIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiByZXR1cm4gdGhpc1trZXldIGluc3RhbmNlb2YgRGF0ZSA/CiAnRGF0ZSgnICsgdGhpc1trZXldICsgJyknIDogdmFsdWU7CiB9KTsKIC8vIHRleHQgaXMgJ1siRGF0ZSgtLS1jdXJyZW50IHRpbWUtLS0pIl0nCgoKIEpTT04ucGFyc2UodGV4dCwgcmV2aXZlcikKIFRoaXMgbWV0aG9kIHBhcnNlcyBhIEpTT04gdGV4dCB0byBwcm9kdWNlIGFuIG9iamVjdCBvciBhcnJheS4KIEl0IGNhbiB0aHJvdyBhIFN5bnRheEVycm9yIGV4Y2VwdGlvbi4KCiBUaGUgb3B0aW9uYWwgcmV2aXZlciBwYXJhbWV0ZXIgaXMgYSBmdW5jdGlvbiB0aGF0IGNhbiBmaWx0ZXIgYW5kCiB0cmFuc2Zvcm0gdGhlIHJlc3VsdHMuIEl0IHJlY2VpdmVzIGVhY2ggb2YgdGhlIGtleXMgYW5kIHZhbHVlcywKIGFuZCBpdHMgcmV0dXJuIHZhbHVlIGlzIHVzZWQgaW5zdGVhZCBvZiB0aGUgb3JpZ2luYWwgdmFsdWUuCiBJZiBpdCByZXR1cm5zIHdoYXQgaXQgcmVjZWl2ZWQsIHRoZW4gdGhlIHN0cnVjdHVyZSBpcyBub3QgbW9kaWZpZWQuCiBJZiBpdCByZXR1cm5zIHVuZGVmaW5lZCB0aGVuIHRoZSBtZW1iZXIgaXMgZGVsZXRlZC4KCiBFeGFtcGxlOgoKIC8vIFBhcnNlIHRoZSB0ZXh0LiBWYWx1ZXMgdGhhdCBsb29rIGxpa2UgSVNPIGRhdGUgc3RyaW5ncyB3aWxsCiAvLyBiZSBjb252ZXJ0ZWQgdG8gRGF0ZSBvYmplY3RzLgoKIG15RGF0YSA9IEpTT04ucGFyc2UodGV4dCwgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKIHZhciBhOwogaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHsKIGEgPQogL14oXGR7NH0pLShcZHsyfSktKFxkezJ9KVQoXGR7Mn0pOihcZHsyfSk6KFxkezJ9KD86XC5cZCopPylaJC8uZXhlYyh2YWx1ZSk7CiBpZiAoYSkgewogcmV0dXJuIG5ldyBEYXRlKERhdGUuVVRDKCthWzFdLCArYVsyXSAtIDEsICthWzNdLCArYVs0XSwKICthWzVdLCArYVs2XSkpOwogfQogfQogcmV0dXJuIHZhbHVlOwogfSk7CgogbXlEYXRhID0gSlNPTi5wYXJzZSgnWyJEYXRlKDA5LzA5LzIwMDEpIl0nLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogdmFyIGQ7CiBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyAmJgogdmFsdWUuc2xpY2UoMCwgNSkgPT09ICdEYXRlKCcgJiYKIHZhbHVlLnNsaWNlKC0xKSA9PT0gJyknKSB7CiBkID0gbmV3IERhdGUodmFsdWUuc2xpY2UoNSwgLTEpKTsKIGlmIChkKSB7CiByZXR1cm4gZDsKIH0KIH0KIHJldHVybiB2YWx1ZTsKIH0pOwoKCiBUaGlzIGlzIGEgcmVmZXJlbmNlIGltcGxlbWVudGF0aW9uLiBZb3UgYXJlIGZyZWUgdG8gY29weSwgbW9kaWZ5LCBvcgogcmVkaXN0cmlidXRlLgogKi8KCi8qanNsaW50IGV2aWw6IHRydWUsIHJlZ2V4cDogdHJ1ZSAqLwoKLyptZW1iZXJzICIiLCAiXGIiLCAiXHQiLCAiXG4iLCAiXGYiLCAiXHIiLCAiXCIiLCBKU09OLCAiXFwiLCBhcHBseSwKIGNhbGwsIGNoYXJDb2RlQXQsIGdldFVUQ0RhdGUsIGdldFVUQ0Z1bGxZZWFyLCBnZXRVVENIb3VycywKIGdldFVUQ01pbnV0ZXMsIGdldFVUQ01vbnRoLCBnZXRVVENTZWNvbmRzLCBoYXNPd25Qcm9wZXJ0eSwgam9pbiwKIGxhc3RJbmRleCwgbGVuZ3RoLCBwYXJzZSwgcHJvdG90eXBlLCBwdXNoLCByZXBsYWNlLCBzbGljZSwgc3RyaW5naWZ5LAogdGVzdCwgdG9KU09OLCB0b1N0cmluZywgdmFsdWVPZgogKi8KCgovLyBDcmVhdGUgYSBKU09OIG9iamVjdCBvbmx5IGlmIG9uZSBkb2VzIG5vdCBhbHJlYWR5IGV4aXN0LiBXZSBjcmVhdGUgdGhlCi8vIG1ldGhvZHMgaW4gYSBjbG9zdXJlIHRvIGF2b2lkIGNyZWF0aW5nIGdsb2JhbCB2YXJpYWJsZXMuCgppZiAodHlwZW9mIEpTT04gIT09ICdvYmplY3QnKSB7CiAgICBKU09OID0ge307Cn0KCihmdW5jdGlvbiAoKSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgZnVuY3Rpb24gZihuKSB7CiAgICAgICAgLy8gRm9ybWF0IGludGVnZXJzIHRvIGhhdmUgYXQgbGVhc3QgdHdvIGRpZ2l0cy4KICAgICAgICByZXR1cm4gbiA8IDEwID8gJzAnICsgbiA6IG47CiAgICB9CgogICAgaWYgKHR5cGVvZiBEYXRlLnByb3RvdHlwZS50b0pTT04gIT09ICdmdW5jdGlvbicpIHsKCiAgICAgICAgRGF0ZS5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24gKGtleSkgewoKICAgICAgICAgICAgcmV0dXJuIGlzRmluaXRlKHRoaXMudmFsdWVPZigpKQogICAgICAgICAgICAgICAgPyB0aGlzLmdldFVUQ0Z1bGxZZWFyKCkgICAgICsgJy0nICsKICAgICAgICAgICAgICAgIGYodGhpcy5nZXRVVENNb250aCgpICsgMSkgKyAnLScgKwogICAgICAgICAgICAgICAgZih0aGlzLmdldFVUQ0RhdGUoKSkgICAgICArICdUJyArCiAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDSG91cnMoKSkgICAgICsgJzonICsKICAgICAgICAgICAgICAgIGYodGhpcy5nZXRVVENNaW51dGVzKCkpICAgKyAnOicgKwogICAgICAgICAgICAgICAgZih0aGlzLmdldFVUQ1NlY29uZHMoKSkgICArICdaJwogICAgICAgICAgICAgICAgOiBudWxsOwogICAgICAgIH07CgogICAgICAgIFN0cmluZy5wcm90b3R5cGUudG9KU09OICAgICAgPQogICAgICAgICAgICBOdW1iZXIucHJvdG90eXBlLnRvSlNPTiAgPQogICAgICAgICAgICAgICAgQm9vbGVhbi5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnZhbHVlT2YoKTsKICAgICAgICAgICAgICAgIH07CiAgICB9CgogICAgdmFyIGN4ID0gL1tcdTAwMDBcdTAwYWRcdTA2MDAtXHUwNjA0XHUwNzBmXHUxN2I0XHUxN2I1XHUyMDBjLVx1MjAwZlx1MjAyOC1cdTIwMmZcdTIwNjAtXHUyMDZmXHVmZWZmXHVmZmYwLVx1ZmZmZl0vZywKICAgICAgICBlc2NhcGFibGUgPSAvW1xcXCJceDAwLVx4MWZceDdmLVx4OWZcdTAwYWRcdTA2MDAtXHUwNjA0XHUwNzBmXHUxN2I0XHUxN2I1XHUyMDBjLVx1MjAwZlx1MjAyOC1cdTIwMmZcdTIwNjAtXHUyMDZmXHVmZWZmXHVmZmYwLVx1ZmZmZl0vZywKICAgICAgICBnYXAsCiAgICAgICAgaW5kZW50LAogICAgICAgIG1ldGEgPSB7ICAgIC8vIHRhYmxlIG9mIGNoYXJhY3RlciBzdWJzdGl0dXRpb25zCiAgICAgICAgICAgICdcYic6ICdcXGInLAogICAgICAgICAgICAnXHQnOiAnXFx0JywKICAgICAgICAgICAgJ1xuJzogJ1xcbicsCiAgICAgICAgICAgICdcZic6ICdcXGYnLAogICAgICAgICAgICAnXHInOiAnXFxyJywKICAgICAgICAgICAgJyInIDogJ1xcIicsCiAgICAgICAgICAgICdcXCc6ICdcXFxcJwogICAgICAgIH0sCiAgICAgICAgcmVwOwoKCiAgICBmdW5jdGlvbiBxdW90ZShzdHJpbmcpIHsKCi8vIElmIHRoZSBzdHJpbmcgY29udGFpbnMgbm8gY29udHJvbCBjaGFyYWN0ZXJzLCBubyBxdW90ZSBjaGFyYWN0ZXJzLCBhbmQgbm8KLy8gYmFja3NsYXNoIGNoYXJhY3RlcnMsIHRoZW4gd2UgY2FuIHNhZmVseSBzbGFwIHNvbWUgcXVvdGVzIGFyb3VuZCBpdC4KLy8gT3RoZXJ3aXNlIHdlIG11c3QgYWxzbyByZXBsYWNlIHRoZSBvZmZlbmRpbmcgY2hhcmFjdGVycyB3aXRoIHNhZmUgZXNjYXBlCi8vIHNlcXVlbmNlcy4KCiAgICAgICAgZXNjYXBhYmxlLmxhc3RJbmRleCA9IDA7CiAgICAgICAgcmV0dXJuIGVzY2FwYWJsZS50ZXN0KHN0cmluZykgPyAnIicgKyBzdHJpbmcucmVwbGFjZShlc2NhcGFibGUsIGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgIHZhciBjID0gbWV0YVthXTsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBjID09PSAnc3RyaW5nJwogICAgICAgICAgICAgICAgPyBjCiAgICAgICAgICAgICAgICA6ICdcXHUnICsgKCcwMDAwJyArIGEuY2hhckNvZGVBdCgwKS50b1N0cmluZygxNikpLnNsaWNlKC00KTsKICAgICAgICB9KSArICciJyA6ICciJyArIHN0cmluZyArICciJzsKICAgIH0KCgogICAgZnVuY3Rpb24gc3RyKGtleSwgaG9sZGVyKSB7CgovLyBQcm9kdWNlIGEgc3RyaW5nIGZyb20gaG9sZGVyW2tleV0uCgogICAgICAgIHZhciBpLCAgICAgICAgICAvLyBUaGUgbG9vcCBjb3VudGVyLgogICAgICAgICAgICBrLCAgICAgICAgICAvLyBUaGUgbWVtYmVyIGtleS4KICAgICAgICAgICAgdiwgICAgICAgICAgLy8gVGhlIG1lbWJlciB2YWx1ZS4KICAgICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgICBtaW5kID0gZ2FwLAogICAgICAgICAgICBwYXJ0aWFsLAogICAgICAgICAgICB2YWx1ZSA9IGhvbGRlcltrZXldOwoKLy8gSWYgdGhlIHZhbHVlIGhhcyBhIHRvSlNPTiBtZXRob2QsIGNhbGwgaXQgdG8gb2J0YWluIGEgcmVwbGFjZW1lbnQgdmFsdWUuCgogICAgICAgIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmCiAgICAgICAgICAgIHR5cGVvZiB2YWx1ZS50b0pTT04gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS50b0pTT04oa2V5KTsKICAgICAgICB9CgovLyBJZiB3ZSB3ZXJlIGNhbGxlZCB3aXRoIGEgcmVwbGFjZXIgZnVuY3Rpb24sIHRoZW4gY2FsbCB0aGUgcmVwbGFjZXIgdG8KLy8gb2J0YWluIGEgcmVwbGFjZW1lbnQgdmFsdWUuCgogICAgICAgIGlmICh0eXBlb2YgcmVwID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIHZhbHVlID0gcmVwLmNhbGwoaG9sZGVyLCBrZXksIHZhbHVlKTsKICAgICAgICB9CgovLyBXaGF0IGhhcHBlbnMgbmV4dCBkZXBlbmRzIG9uIHRoZSB2YWx1ZSdzIHR5cGUuCgogICAgICAgIHN3aXRjaCAodHlwZW9mIHZhbHVlKSB7CiAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgICAgICAgICByZXR1cm4gcXVvdGUodmFsdWUpOwoKICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzoKCi8vIEpTT04gbnVtYmVycyBtdXN0IGJlIGZpbml0ZS4gRW5jb2RlIG5vbi1maW5pdGUgbnVtYmVycyBhcyBudWxsLgoKICAgICAgICAgICAgICAgIHJldHVybiBpc0Zpbml0ZSh2YWx1ZSkgPyBTdHJpbmcodmFsdWUpIDogJ251bGwnOwoKICAgICAgICAgICAgY2FzZSAnYm9vbGVhbic6CiAgICAgICAgICAgIGNhc2UgJ251bGwnOgoKLy8gSWYgdGhlIHZhbHVlIGlzIGEgYm9vbGVhbiBvciBudWxsLCBjb252ZXJ0IGl0IHRvIGEgc3RyaW5nLiBOb3RlOgovLyB0eXBlb2YgbnVsbCBkb2VzIG5vdCBwcm9kdWNlICdudWxsJy4gVGhlIGNhc2UgaXMgaW5jbHVkZWQgaGVyZSBpbgovLyB0aGUgcmVtb3RlIGNoYW5jZSB0aGF0IHRoaXMgZ2V0cyBmaXhlZCBzb21lZGF5LgoKICAgICAgICAgICAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpOwoKLy8gSWYgdGhlIHR5cGUgaXMgJ29iamVjdCcsIHdlIG1pZ2h0IGJlIGRlYWxpbmcgd2l0aCBhbiBvYmplY3Qgb3IgYW4gYXJyYXkgb3IKLy8gbnVsbC4KCiAgICAgICAgICAgIGNhc2UgJ29iamVjdCc6CgovLyBEdWUgdG8gYSBzcGVjaWZpY2F0aW9uIGJsdW5kZXIgaW4gRUNNQVNjcmlwdCwgdHlwZW9mIG51bGwgaXMgJ29iamVjdCcsCi8vIHNvIHdhdGNoIG91dCBmb3IgdGhhdCBjYXNlLgoKICAgICAgICAgICAgICAgIGlmICghdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ251bGwnOwogICAgICAgICAgICAgICAgfQoKLy8gTWFrZSBhbiBhcnJheSB0byBob2xkIHRoZSBwYXJ0aWFsIHJlc3VsdHMgb2Ygc3RyaW5naWZ5aW5nIHRoaXMgb2JqZWN0IHZhbHVlLgoKICAgICAgICAgICAgICAgIGdhcCArPSBpbmRlbnQ7CiAgICAgICAgICAgICAgICBwYXJ0aWFsID0gW107CgovLyBJcyB0aGUgdmFsdWUgYW4gYXJyYXk/CgogICAgICAgICAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuYXBwbHkodmFsdWUpID09PSAnW29iamVjdCBBcnJheV0nKSB7CgovLyBUaGUgdmFsdWUgaXMgYW4gYXJyYXkuIFN0cmluZ2lmeSBldmVyeSBlbGVtZW50LiBVc2UgbnVsbCBhcyBhIHBsYWNlaG9sZGVyCi8vIGZvciBub24tSlNPTiB2YWx1ZXMuCgogICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IHZhbHVlLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFydGlhbFtpXSA9IHN0cihpLCB2YWx1ZSkgfHwgJ251bGwnOwogICAgICAgICAgICAgICAgICAgIH0KCi8vIEpvaW4gYWxsIG9mIHRoZSBlbGVtZW50cyB0b2dldGhlciwgc2VwYXJhdGVkIHdpdGggY29tbWFzLCBhbmQgd3JhcCB0aGVtIGluCi8vIGJyYWNrZXRzLgoKICAgICAgICAgICAgICAgICAgICB2ID0gcGFydGlhbC5sZW5ndGggPT09IDAKICAgICAgICAgICAgICAgICAgICAgICAgPyAnW10nCiAgICAgICAgICAgICAgICAgICAgICAgIDogZ2FwCiAgICAgICAgICAgICAgICAgICAgICAgID8gJ1tcbicgKyBnYXAgKyBwYXJ0aWFsLmpvaW4oJyxcbicgKyBnYXApICsgJ1xuJyArIG1pbmQgKyAnXScKICAgICAgICAgICAgICAgICAgICAgICAgOiAnWycgKyBwYXJ0aWFsLmpvaW4oJywnKSArICddJzsKICAgICAgICAgICAgICAgICAgICBnYXAgPSBtaW5kOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgICAgICAgICAgfQoKLy8gSWYgdGhlIHJlcGxhY2VyIGlzIGFuIGFycmF5LCB1c2UgaXQgdG8gc2VsZWN0IHRoZSBtZW1iZXJzIHRvIGJlIHN0cmluZ2lmaWVkLgoKICAgICAgICAgICAgICAgIGlmIChyZXAgJiYgdHlwZW9mIHJlcCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgICAgICBsZW5ndGggPSByZXAubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHJlcFtpXSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGsgPSByZXBbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2ID0gc3RyKGssIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydGlhbC5wdXNoKHF1b3RlKGspICsgKGdhcCA/ICc6ICcgOiAnOicpICsgdik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewoKLy8gT3RoZXJ3aXNlLCBpdGVyYXRlIHRocm91Z2ggYWxsIG9mIHRoZSBrZXlzIGluIHRoZSBvYmplY3QuCgogICAgICAgICAgICAgICAgICAgIGZvciAoayBpbiB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbHVlLCBrKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHN0cihrLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRpYWwucHVzaChxdW90ZShrKSArIChnYXAgPyAnOiAnIDogJzonKSArIHYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKLy8gSm9pbiBhbGwgb2YgdGhlIG1lbWJlciB0ZXh0cyB0b2dldGhlciwgc2VwYXJhdGVkIHdpdGggY29tbWFzLAovLyBhbmQgd3JhcCB0aGVtIGluIGJyYWNlcy4KCiAgICAgICAgICAgICAgICB2ID0gcGFydGlhbC5sZW5ndGggPT09IDAKICAgICAgICAgICAgICAgICAgICA/ICd7fScKICAgICAgICAgICAgICAgICAgICA6IGdhcAogICAgICAgICAgICAgICAgICAgID8gJ3tcbicgKyBnYXAgKyBwYXJ0aWFsLmpvaW4oJyxcbicgKyBnYXApICsgJ1xuJyArIG1pbmQgKyAnfScKICAgICAgICAgICAgICAgICAgICA6ICd7JyArIHBhcnRpYWwuam9pbignLCcpICsgJ30nOwogICAgICAgICAgICAgICAgZ2FwID0gbWluZDsKICAgICAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgIH0KICAgIH0KCi8vIElmIHRoZSBKU09OIG9iamVjdCBkb2VzIG5vdCB5ZXQgaGF2ZSBhIHN0cmluZ2lmeSBtZXRob2QsIGdpdmUgaXQgb25lLgoKICAgIGlmICh0eXBlb2YgSlNPTi5zdHJpbmdpZnkgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICBKU09OLnN0cmluZ2lmeSA9IGZ1bmN0aW9uICh2YWx1ZSwgcmVwbGFjZXIsIHNwYWNlKSB7CgovLyBUaGUgc3RyaW5naWZ5IG1ldGhvZCB0YWtlcyBhIHZhbHVlIGFuZCBhbiBvcHRpb25hbCByZXBsYWNlciwgYW5kIGFuIG9wdGlvbmFsCi8vIHNwYWNlIHBhcmFtZXRlciwgYW5kIHJldHVybnMgYSBKU09OIHRleHQuIFRoZSByZXBsYWNlciBjYW4gYmUgYSBmdW5jdGlvbgovLyB0aGF0IGNhbiByZXBsYWNlIHZhbHVlcywgb3IgYW4gYXJyYXkgb2Ygc3RyaW5ncyB0aGF0IHdpbGwgc2VsZWN0IHRoZSBrZXlzLgovLyBBIGRlZmF1bHQgcmVwbGFjZXIgbWV0aG9kIGNhbiBiZSBwcm92aWRlZC4gVXNlIG9mIHRoZSBzcGFjZSBwYXJhbWV0ZXIgY2FuCi8vIHByb2R1Y2UgdGV4dCB0aGF0IGlzIG1vcmUgZWFzaWx5IHJlYWRhYmxlLgoKICAgICAgICAgICAgdmFyIGk7CiAgICAgICAgICAgIGdhcCA9ICcnOwogICAgICAgICAgICBpbmRlbnQgPSAnJzsKCi8vIElmIHRoZSBzcGFjZSBwYXJhbWV0ZXIgaXMgYSBudW1iZXIsIG1ha2UgYW4gaW5kZW50IHN0cmluZyBjb250YWluaW5nIHRoYXQKLy8gbWFueSBzcGFjZXMuCgogICAgICAgICAgICBpZiAodHlwZW9mIHNwYWNlID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNwYWNlOyBpICs9IDEpIHsKICAgICAgICAgICAgICAgICAgICBpbmRlbnQgKz0gJyAnOwogICAgICAgICAgICAgICAgfQoKLy8gSWYgdGhlIHNwYWNlIHBhcmFtZXRlciBpcyBhIHN0cmluZywgaXQgd2lsbCBiZSB1c2VkIGFzIHRoZSBpbmRlbnQgc3RyaW5nLgoKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc3BhY2UgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICBpbmRlbnQgPSBzcGFjZTsKICAgICAgICAgICAgfQoKLy8gSWYgdGhlcmUgaXMgYSByZXBsYWNlciwgaXQgbXVzdCBiZSBhIGZ1bmN0aW9uIG9yIGFuIGFycmF5LgovLyBPdGhlcndpc2UsIHRocm93IGFuIGVycm9yLgoKICAgICAgICAgICAgcmVwID0gcmVwbGFjZXI7CiAgICAgICAgICAgIGlmIChyZXBsYWNlciAmJiB0eXBlb2YgcmVwbGFjZXIgIT09ICdmdW5jdGlvbicgJiYKICAgICAgICAgICAgICAgICh0eXBlb2YgcmVwbGFjZXIgIT09ICdvYmplY3QnIHx8CiAgICAgICAgICAgICAgICAgICAgdHlwZW9mIHJlcGxhY2VyLmxlbmd0aCAhPT0gJ251bWJlcicpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0pTT04uc3RyaW5naWZ5Jyk7CiAgICAgICAgICAgIH0KCi8vIE1ha2UgYSBmYWtlIHJvb3Qgb2JqZWN0IGNvbnRhaW5pbmcgb3VyIHZhbHVlIHVuZGVyIHRoZSBrZXkgb2YgJycuCi8vIFJldHVybiB0aGUgcmVzdWx0IG9mIHN0cmluZ2lmeWluZyB0aGUgdmFsdWUuCgogICAgICAgICAgICByZXR1cm4gc3RyKCcnLCB7Jyc6IHZhbHVlfSk7CiAgICAgICAgfTsKICAgIH0KCgovLyBJZiB0aGUgSlNPTiBvYmplY3QgZG9lcyBub3QgeWV0IGhhdmUgYSBwYXJzZSBtZXRob2QsIGdpdmUgaXQgb25lLgoKICAgIGlmICh0eXBlb2YgSlNPTi5wYXJzZSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgIEpTT04ucGFyc2UgPSBmdW5jdGlvbiAodGV4dCwgcmV2aXZlcikgewoKLy8gVGhlIHBhcnNlIG1ldGhvZCB0YWtlcyBhIHRleHQgYW5kIGFuIG9wdGlvbmFsIHJldml2ZXIgZnVuY3Rpb24sIGFuZCByZXR1cm5zCi8vIGEgSmF2YVNjcmlwdCB2YWx1ZSBpZiB0aGUgdGV4dCBpcyBhIHZhbGlkIEpTT04gdGV4dC4KCiAgICAgICAgICAgIHZhciBqOwoKICAgICAgICAgICAgZnVuY3Rpb24gd2Fsayhob2xkZXIsIGtleSkgewoKLy8gVGhlIHdhbGsgbWV0aG9kIGlzIHVzZWQgdG8gcmVjdXJzaXZlbHkgd2FsayB0aGUgcmVzdWx0aW5nIHN0cnVjdHVyZSBzbwovLyB0aGF0IG1vZGlmaWNhdGlvbnMgY2FuIGJlIG1hZGUuCgogICAgICAgICAgICAgICAgdmFyIGssIHYsIHZhbHVlID0gaG9sZGVyW2tleV07CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgICAgIGZvciAoayBpbiB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbHVlLCBrKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHdhbGsodmFsdWUsIGspOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHYgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlW2tdID0gdjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHZhbHVlW2tdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJldml2ZXIuY2FsbChob2xkZXIsIGtleSwgdmFsdWUpOwogICAgICAgICAgICB9CgoKLy8gUGFyc2luZyBoYXBwZW5zIGluIGZvdXIgc3RhZ2VzLiBJbiB0aGUgZmlyc3Qgc3RhZ2UsIHdlIHJlcGxhY2UgY2VydGFpbgovLyBVbmljb2RlIGNoYXJhY3RlcnMgd2l0aCBlc2NhcGUgc2VxdWVuY2VzLiBKYXZhU2NyaXB0IGhhbmRsZXMgbWFueSBjaGFyYWN0ZXJzCi8vIGluY29ycmVjdGx5LCBlaXRoZXIgc2lsZW50bHkgZGVsZXRpbmcgdGhlbSwgb3IgdHJlYXRpbmcgdGhlbSBhcyBsaW5lIGVuZGluZ3MuCgogICAgICAgICAgICB0ZXh0ID0gU3RyaW5nKHRleHQpOwogICAgICAgICAgICBjeC5sYXN0SW5kZXggPSAwOwogICAgICAgICAgICBpZiAoY3gudGVzdCh0ZXh0KSkgewogICAgICAgICAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZShjeCwgZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ1xcdScgKwogICAgICAgICAgICAgICAgICAgICAgICAoJzAwMDAnICsgYS5jaGFyQ29kZUF0KDApLnRvU3RyaW5nKDE2KSkuc2xpY2UoLTQpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCi8vIEluIHRoZSBzZWNvbmQgc3RhZ2UsIHdlIHJ1biB0aGUgdGV4dCBhZ2FpbnN0IHJlZ3VsYXIgZXhwcmVzc2lvbnMgdGhhdCBsb29rCi8vIGZvciBub24tSlNPTiBwYXR0ZXJucy4gV2UgYXJlIGVzcGVjaWFsbHkgY29uY2VybmVkIHdpdGggJygpJyBhbmQgJ25ldycKLy8gYmVjYXVzZSB0aGV5IGNhbiBjYXVzZSBpbnZvY2F0aW9uLCBhbmQgJz0nIGJlY2F1c2UgaXQgY2FuIGNhdXNlIG11dGF0aW9uLgovLyBCdXQganVzdCB0byBiZSBzYWZlLCB3ZSB3YW50IHRvIHJlamVjdCBhbGwgdW5leHBlY3RlZCBmb3Jtcy4KCi8vIFdlIHNwbGl0IHRoZSBzZWNvbmQgc3RhZ2UgaW50byA0IHJlZ2V4cCBvcGVyYXRpb25zIGluIG9yZGVyIHRvIHdvcmsgYXJvdW5kCi8vIGNyaXBwbGluZyBpbmVmZmljaWVuY2llcyBpbiBJRSdzIGFuZCBTYWZhcmkncyByZWdleHAgZW5naW5lcy4gRmlyc3Qgd2UKLy8gcmVwbGFjZSB0aGUgSlNPTiBiYWNrc2xhc2ggcGFpcnMgd2l0aCAnQCcgKGEgbm9uLUpTT04gY2hhcmFjdGVyKS4gU2Vjb25kLCB3ZQovLyByZXBsYWNlIGFsbCBzaW1wbGUgdmFsdWUgdG9rZW5zIHdpdGggJ10nIGNoYXJhY3RlcnMuIFRoaXJkLCB3ZSBkZWxldGUgYWxsCi8vIG9wZW4gYnJhY2tldHMgdGhhdCBmb2xsb3cgYSBjb2xvbiBvciBjb21tYSBvciB0aGF0IGJlZ2luIHRoZSB0ZXh0LiBGaW5hbGx5LAovLyB3ZSBsb29rIHRvIHNlZSB0aGF0IHRoZSByZW1haW5pbmcgY2hhcmFjdGVycyBhcmUgb25seSB3aGl0ZXNwYWNlIG9yICddJyBvcgovLyAnLCcgb3IgJzonIG9yICd7JyBvciAnfScuIElmIHRoYXQgaXMgc28sIHRoZW4gdGhlIHRleHQgaXMgc2FmZSBmb3IgZXZhbC4KCiAgICAgICAgICAgIGlmICgvXltcXSw6e31cc10qJC8KICAgICAgICAgICAgICAgIC50ZXN0KHRleHQucmVwbGFjZSgvXFwoPzpbIlxcXC9iZm5ydF18dVswLTlhLWZBLUZdezR9KS9nLCAnQCcpCiAgICAgICAgICAgICAgICAucmVwbGFjZSgvIlteIlxcXG5ccl0qInx0cnVlfGZhbHNlfG51bGx8LT9cZCsoPzpcLlxkKik/KD86W2VFXVsrXC1dP1xkKyk/L2csICddJykKICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8oPzpefDp8LCkoPzpccypcWykrL2csICcnKSkpIHsKCi8vIEluIHRoZSB0aGlyZCBzdGFnZSB3ZSB1c2UgdGhlIGV2YWwgZnVuY3Rpb24gdG8gY29tcGlsZSB0aGUgdGV4dCBpbnRvIGEKLy8gSmF2YVNjcmlwdCBzdHJ1Y3R1cmUuIFRoZSAneycgb3BlcmF0b3IgaXMgc3ViamVjdCB0byBhIHN5bnRhY3RpYyBhbWJpZ3VpdHkKLy8gaW4gSmF2YVNjcmlwdDogaXQgY2FuIGJlZ2luIGEgYmxvY2sgb3IgYW4gb2JqZWN0IGxpdGVyYWwuIFdlIHdyYXAgdGhlIHRleHQKLy8gaW4gcGFyZW5zIHRvIGVsaW1pbmF0ZSB0aGUgYW1iaWd1aXR5LgoKICAgICAgICAgICAgICAgIGogPSBldmFsKCcoJyArIHRleHQgKyAnKScpOwoKLy8gSW4gdGhlIG9wdGlvbmFsIGZvdXJ0aCBzdGFnZSwgd2UgcmVjdXJzaXZlbHkgd2FsayB0aGUgbmV3IHN0cnVjdHVyZSwgcGFzc2luZwovLyBlYWNoIG5hbWUvdmFsdWUgcGFpciB0byBhIHJldml2ZXIgZnVuY3Rpb24gZm9yIHBvc3NpYmxlIHRyYW5zZm9ybWF0aW9uLgoKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2YgcmV2aXZlciA9PT0gJ2Z1bmN0aW9uJwogICAgICAgICAgICAgICAgICAgID8gd2Fsayh7Jyc6IGp9LCAnJykKICAgICAgICAgICAgICAgICAgICA6IGo7CiAgICAgICAgICAgIH0KCi8vIElmIHRoZSB0ZXh0IGlzIG5vdCBKU09OIHBhcnNlYWJsZSwgdGhlbiBhIFN5bnRheEVycm9yIGlzIHRocm93bi4KCiAgICAgICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcignSlNPTi5wYXJzZScpOwogICAgICAgIH07CiAgICB9Cn0oKSk7LyohCiAqIEpTT05TY2hlbWEgVmFsaWRhdG9yIC0gVmFsaWRhdGVzIEphdmFTY3JpcHQgb2JqZWN0cyB1c2luZyBKU09OIFNjaGVtYXMKICogICAgKGh0dHA6Ly93d3cuanNvbi5jb20vanNvbi1zY2hlbWEtcHJvcG9zYWwvKQogKgogKiBDb3B5cmlnaHQgKGMpIDIwMDcgS3JpcyBaeXAgU2l0ZVBlbiAod3d3LnNpdGVwZW4uY29tKQogKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIChNSVQtTElDRU5TRS50eHQpIGxpY2Vuc2UuCiBUbyB1c2UgdGhlIHZhbGlkYXRvciBjYWxsIHRoZSB2YWxpZGF0ZSBmdW5jdGlvbiB3aXRoIGFuIGluc3RhbmNlIG9iamVjdCBhbmQgYW4gb3B0aW9uYWwgc2NoZW1hIG9iamVjdC4KIElmIGEgc2NoZW1hIGlzIHByb3ZpZGVkLCBpdCB3aWxsIGJlIHVzZWQgdG8gdmFsaWRhdGUuIElmIHRoZSBpbnN0YW5jZSBvYmplY3QgcmVmZXJzIHRvIGEgc2NoZW1hIChzZWxmLXZhbGlkYXRpbmcpLAogdGhhdCBzY2hlbWEgd2lsbCBiZSB1c2VkIHRvIHZhbGlkYXRlIGFuZCB0aGUgc2NoZW1hIHBhcmFtZXRlciBpcyBub3QgbmVjZXNzYXJ5IChpZiBib3RoIGV4aXN0LAogYm90aCB2YWxpZGF0aW9ucyB3aWxsIG9jY3VyKS4KIFRoZSB2YWxpZGF0ZSBtZXRob2Qgd2lsbCByZXR1cm4gYW4gYXJyYXkgb2YgdmFsaWRhdGlvbiBlcnJvcnMuIElmIHRoZXJlIGFyZSBubyBlcnJvcnMsIHRoZW4gYW4KIGVtcHR5IGxpc3Qgd2lsbCBiZSByZXR1cm5lZC4gQSB2YWxpZGF0aW9uIGVycm9yIHdpbGwgaGF2ZSB0d28gcHJvcGVydGllczoKICJwcm9wZXJ0eSIgd2hpY2ggaW5kaWNhdGVzIHdoaWNoIHByb3BlcnR5IGhhZCB0aGUgZXJyb3IKICJtZXNzYWdlIiB3aGljaCBpbmRpY2F0ZXMgd2hhdCB0aGUgZXJyb3Igd2FzCiAqLwooZnVuY3Rpb24oJCkgewoKICAgIC8qKiBAbmFtZXNwYWNlICovCiAgICBWYWxpZGF0b3IgPSB7CgogICAgICAgIC8qKgogICAgICAgICAqIFN1bW1hcnk6CiAgICAgICAgICogVG8gdXNlIHRoZSB2YWxpZGF0b3IgY2FsbCBKU09OU2NoZW1hLnZhbGlkYXRlIHdpdGggYW4gaW5zdGFuY2Ugb2JqZWN0IGFuZCBhbiBvcHRpb25hbCBzY2hlbWEgb2JqZWN0LgogICAgICAgICAqIElmIGEgc2NoZW1hIGlzIHByb3ZpZGVkLCBpdCB3aWxsIGJlIHVzZWQgdG8gdmFsaWRhdGUuIElmIHRoZSBpbnN0YW5jZSBvYmplY3QgcmVmZXJzIHRvIGEgc2NoZW1hIChzZWxmLXZhbGlkYXRpbmcpLAogICAgICAgICAqIHRoYXQgc2NoZW1hIHdpbGwgYmUgdXNlZCB0byB2YWxpZGF0ZSBhbmQgdGhlIHNjaGVtYSBwYXJhbWV0ZXIgaXMgbm90IG5lY2Vzc2FyeSAoaWYgYm90aCBleGlzdCwKICAgICAgICAgKiBib3RoIHZhbGlkYXRpb25zIHdpbGwgb2NjdXIpLgogICAgICAgICAqIFRoZSB2YWxpZGF0ZSBtZXRob2Qgd2lsbCByZXR1cm4gYW4gb2JqZWN0IHdpdGggdHdvIHByb3BlcnRpZXM6CiAgICAgICAgICogdmFsaWQ6IEEgYm9vbGVhbiBpbmRpY2F0aW5nIGlmIHRoZSBpbnN0YW5jZSBpcyB2YWxpZCBieSB0aGUgc2NoZW1hCiAgICAgICAgICogZXJyb3JzOiBBbiBhcnJheSBvZiB2YWxpZGF0aW9uIGVycm9ycy4gSWYgdGhlcmUgYXJlIG5vIGVycm9ycywgdGhlbiBhbgogICAgICAgICAqIGVtcHR5IGxpc3Qgd2lsbCBiZSByZXR1cm5lZC4gQSB2YWxpZGF0aW9uIGVycm9yIHdpbGwgaGF2ZSB0d28gcHJvcGVydGllczoKICAgICAgICAgKiBwcm9wZXJ0eTogd2hpY2ggaW5kaWNhdGVzIHdoaWNoIHByb3BlcnR5IGhhZCB0aGUgZXJyb3IKICAgICAgICAgKiBtZXNzYWdlOiB3aGljaCBpbmRpY2F0ZXMgd2hhdCB0aGUgZXJyb3Igd2FzCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0FueX0gaW5zdGFuY2UKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSByZXN1bHQgdmFsaWRhdGlvbiByZXN1bHQKICAgICAgICAgKi8KICAgICAgICB2YWxpZGF0ZTogZnVuY3Rpb24gKC8qQW55Ki9pbnN0YW5jZSwgLypPYmplY3QqL3NjaGVtYSkgewogICAgICAgICAgICByZXR1cm4gVmFsaWRhdG9yLl92YWxpZGF0ZShpbnN0YW5jZSwgc2NoZW1hLCB7Y2hhbmdpbmc6IGZhbHNlfSk7Ly8sIGNvZXJjZTogZmFsc2UsIGV4aXN0aW5nT25seTogZmFsc2V9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBTdW1tYXJ5OgogICAgICAgICAqIFRoZSBjaGVja1Byb3BlcnR5Q2hhbmdlIG1ldGhvZCB3aWxsIGNoZWNrIHRvIHNlZSBpZiBhbiB2YWx1ZSBjYW4gbGVnYWxseSBiZSBpbiBwcm9wZXJ0eSB3aXRoIHRoZSBnaXZlbiBzY2hlbWEKICAgICAgICAgKiBUaGlzIGlzIHNsaWdodGx5IGRpZmZlcmVudCB0aGFuIHRoZSB2YWxpZGF0ZSBtZXRob2QgaW4gdGhhdCBpdCB3aWxsIGZhaWwgaWYgdGhlIHNjaGVtYSBpcyByZWFkb25seSBhbmQgaXQgd2lsbAogICAgICAgICAqIG5vdCBjaGVjayBmb3Igc2VsZi12YWxpZGF0aW9uLCBpdCBpcyBhc3N1bWVkIHRoYXQgdGhlIHBhc3NlZCBpbiB2YWx1ZSBpcyBhbHJlYWR5IGludGVybmFsbHkgdmFsaWQuCiAgICAgICAgICogVGhlIGNoZWNrUHJvcGVydHlDaGFuZ2UgbWV0aG9kIHdpbGwgcmV0dXJuIHRoZSBzYW1lIG9iamVjdCB0eXBlIGFzIHZhbGlkYXRlLCBzZWUgSlNPTlNjaGVtYS52YWxpZGF0ZSBmb3IKICAgICAgICAgKiBpbmZvcm1hdGlvbi4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7QW55fSB2YWx1ZQogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkKICAgICAgICAgKi8KICAgICAgICBjaGVja1Byb3BlcnR5Q2hhbmdlIDogZnVuY3Rpb24oLypBbnkqL3ZhbHVlLCAvKk9iamVjdCovc2NoZW1hLCAvKlN0cmluZyovcHJvcGVydHkpIHsKICAgICAgICAgICAgcmV0dXJuIFZhbGlkYXRvci5fdmFsaWRhdGUodmFsdWUsIHNjaGVtYSwge2NoYW5naW5nOiBwcm9wZXJ0eSB8fCAicHJvcGVydHkifSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQGludGVybmFsCiAgICAgICAgICogQHBhcmFtIGluc3RhbmNlCiAgICAgICAgICogQHBhcmFtIHNjaGVtYQogICAgICAgICAqIEBwYXJhbSBvcHRpb25zCiAgICAgICAgICovCiAgICAgICAgX3ZhbGlkYXRlIDogZnVuY3Rpb24oLypBbnkqL2luc3RhbmNlLCAvKk9iamVjdCovc2NoZW1hLCAvKk9iamVjdCovb3B0aW9ucykgewoKICAgICAgICAgICAgaWYgKCFvcHRpb25zKSBvcHRpb25zID0ge307CiAgICAgICAgICAgIHZhciBfY2hhbmdpbmcgPSBvcHRpb25zLmNoYW5naW5nOwoKICAgICAgICAgICAgdmFyIGVycm9ycyA9IFtdOwogICAgICAgICAgICAvLyB2YWxpZGF0ZSBhIHZhbHVlIGFnYWluc3QgYSBwcm9wZXJ0eSBkZWZpbml0aW9uCiAgICAgICAgICAgIGZ1bmN0aW9uIGNoZWNrUHJvcCh2YWx1ZSwgc2NoZW1hLCBwYXRoLCBpKSB7CgogICAgICAgICAgICAgICAgdmFyIGw7CiAgICAgICAgICAgICAgICBwYXRoICs9IHBhdGggPyB0eXBlb2YgaSA9PSAnbnVtYmVyJyA/ICdbJyArIGkgKyAnXScgOiB0eXBlb2YgaSA9PSAndW5kZWZpbmVkJyA/ICcnIDogJy4nICsgaSA6IGk7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBhZGRFcnJvcihtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JzLnB1c2goe3Byb3BlcnR5OnBhdGgsbWVzc2FnZTptZXNzYWdlfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCh0eXBlb2Ygc2NoZW1hICE9ICdvYmplY3QnIHx8IHNjaGVtYSBpbnN0YW5jZW9mIEFycmF5KSAmJiAocGF0aCB8fCB0eXBlb2Ygc2NoZW1hICE9ICdmdW5jdGlvbicpICYmICEoc2NoZW1hICYmIHNjaGVtYS50eXBlKSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2NoZW1hID09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEodmFsdWUgaW5zdGFuY2VvZiBzY2hlbWEpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFcnJvcigiaXMgbm90IGFuIGluc3RhbmNlIG9mIHRoZSBjbGFzcy9jb25zdHJ1Y3RvciAiICsgc2NoZW1hLm5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzY2hlbWEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkRXJyb3IoIkludmFsaWQgc2NoZW1hL3Byb3BlcnR5IGRlZmluaXRpb24gIiArIHNjaGVtYSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKF9jaGFuZ2luZyAmJiBzY2hlbWEucmVhZG9ubHkpIHsKICAgICAgICAgICAgICAgICAgICBhZGRFcnJvcigiaXMgYSByZWFkb25seSBmaWVsZCwgaXQgY2FuIG5vdCBiZSBjaGFuZ2VkIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc2NoZW1hWydleHRlbmRzJ10pIHsgLy8gaWYgaXQgZXh0ZW5kcyBhbm90aGVyIHNjaGVtYSwgaXQgbXVzdCBwYXNzIHRoYXQgc2NoZW1hIGFzIHdlbGwKICAgICAgICAgICAgICAgICAgICBjaGVja1Byb3AodmFsdWUsIHNjaGVtYVsnZXh0ZW5kcyddLCBwYXRoLCBpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIHZhbGlkYXRlIGEgdmFsdWUgYWdhaW5zdCBhIHR5cGUgZGVmaW5pdGlvbgogICAgICAgICAgICAgICAgZnVuY3Rpb24gY2hlY2tUeXBlKHR5cGUsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09ICdzdHJpbmcnICYmIHR5cGUgIT0gJ2FueScgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAodHlwZSA9PSAnbnVsbCcgPyB2YWx1ZSAhPT0gbnVsbCA6IHR5cGVvZiB2YWx1ZSAhPSB0eXBlKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICEodmFsdWUgaW5zdGFuY2VvZiBBcnJheSAmJiB0eXBlID09ICdhcnJheScpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgISh2YWx1ZSBpbnN0YW5jZW9mIERhdGUgJiYgdHlwZSA9PSAnZGF0ZScpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgISh0eXBlID09ICdpbnRlZ2VyJyAmJiB2YWx1ZSAlIDEgPT09IDApKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtwcm9wZXJ0eTpwYXRoLG1lc3NhZ2U6KHR5cGVvZiB2YWx1ZSkgKyAiIHZhbHVlIGZvdW5kLCBidXQgYSAiICsgdHlwZSArICIgaXMgcmVxdWlyZWQifQogICAgICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdW5pb25FcnJvcnMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdHlwZS5sZW5ndGg7IGorKykgeyAvLyBhIHVuaW9uIHR5cGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoISh1bmlvbkVycm9ycyA9IGNoZWNrVHlwZSh0eXBlW2pdLCB2YWx1ZSkpLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodW5pb25FcnJvcnMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuaW9uRXJyb3JzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0eXBlID09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJpb3JFcnJvcnMgPSBlcnJvcnM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcnMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrUHJvcCh2YWx1ZSwgdHlwZSwgcGF0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGhlc2VFcnJvcnMgPSBlcnJvcnM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcnMgPSBwcmlvckVycm9yczsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGVzZUVycm9yczsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc2NoZW1hLnJlcXVpcmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZEVycm9yKCJpcyBtaXNzaW5nIGFuZCBpdCBpcyByZXF1aXJlZCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JzID0gZXJyb3JzLmNvbmNhdChjaGVja1R5cGUoc2NoZW1hLnR5cGUsIHZhbHVlKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNjaGVtYS5kaXNhbGxvdyAmJiAhY2hlY2tUeXBlKHNjaGVtYS5kaXNhbGxvdywgdmFsdWUpLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBhZGRFcnJvcigiIGRpc2FsbG93ZWQgdmFsdWUgd2FzIG1hdGNoZWQiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2NoZW1hLml0ZW1zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW1zSXNBcnJheSA9IHNjaGVtYS5pdGVtcyBpbnN0YW5jZW9mIEFycmF5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcm9wRGVmID0gc2NoZW1hLml0ZW1zOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsbCA9IHZhbHVlLmxlbmd0aDsgaSA8IGw7IGkgKz0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbXNJc0FycmF5KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcERlZiA9IHNjaGVtYS5pdGVtc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuY29lcmNlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVbaV0gPSBvcHRpb25zLmNvZXJjZSh2YWx1ZVtpXSwgcHJvcERlZik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9ycy5jb25jYXQoY2hlY2tQcm9wKHZhbHVlW2ldLCBwcm9wRGVmLCBwYXRoLCBpKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNjaGVtYS5taW5JdGVtcyAmJiB2YWx1ZS5sZW5ndGggPCBzY2hlbWEubWluSXRlbXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFcnJvcigiVGhlcmUgbXVzdCBiZSBhIG1pbmltdW0gb2YgIiArIHNjaGVtYS5taW5JdGVtcyArICIgaW4gdGhlIGFycmF5Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2NoZW1hLm1heEl0ZW1zICYmIHZhbHVlLmxlbmd0aCA+IHNjaGVtYS5tYXhJdGVtcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZEVycm9yKCJUaGVyZSBtdXN0IGJlIGEgbWF4aW11bSBvZiAiICsgc2NoZW1hLm1heEl0ZW1zICsgIiBpbiB0aGUgYXJyYXkiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzY2hlbWEucHJvcGVydGllcyB8fCBzY2hlbWEuYWRkaXRpb25hbFByb3BlcnRpZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9ycy5jb25jYXQoY2hlY2tPYmoodmFsdWUsIHNjaGVtYS5wcm9wZXJ0aWVzLCBwYXRoLCBzY2hlbWEuYWRkaXRpb25hbFByb3BlcnRpZXMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2NoZW1hLnBhdHRlcm4gJiYgdHlwZW9mIHZhbHVlID09ICdzdHJpbmcnICYmICF2YWx1ZS5tYXRjaChzY2hlbWEucGF0dGVybikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZEVycm9yKCJkb2VzIG5vdCBtYXRjaCB0aGUgcmVnZXggcGF0dGVybiAiICsgc2NoZW1hLnBhdHRlcm4pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzY2hlbWEubWF4TGVuZ3RoICYmIHR5cGVvZiB2YWx1ZSA9PSAnc3RyaW5nJyAmJiB2YWx1ZS5sZW5ndGggPiBzY2hlbWEubWF4TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFcnJvcigibWF5IG9ubHkgYmUgIiArIHNjaGVtYS5tYXhMZW5ndGggKyAiIGNoYXJhY3RlcnMgbG9uZyIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzY2hlbWEubWluTGVuZ3RoICYmIHR5cGVvZiB2YWx1ZSA9PSAnc3RyaW5nJyAmJiB2YWx1ZS5sZW5ndGggPCBzY2hlbWEubWluTGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFcnJvcigibXVzdCBiZSBhdCBsZWFzdCAiICsgc2NoZW1hLm1pbkxlbmd0aCArICIgY2hhcmFjdGVycyBsb25nIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzY2hlbWEubWluaW11bSAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiB2YWx1ZSA9PSB0eXBlb2Ygc2NoZW1hLm1pbmltdW0gJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2hlbWEubWluaW11bSA+IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFcnJvcigibXVzdCBoYXZlIGEgbWluaW11bSB2YWx1ZSBvZiAiICsgc2NoZW1hLm1pbmltdW0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2NoZW1hLm1heGltdW0gIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgdmFsdWUgPT0gdHlwZW9mIHNjaGVtYS5tYXhpbXVtICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NoZW1hLm1heGltdW0gPCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkRXJyb3IoIm11c3QgaGF2ZSBhIG1heGltdW0gdmFsdWUgb2YgIiArIHNjaGVtYS5tYXhpbXVtKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2NoZW1hWydlbnVtJ10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlbnVtZXIgPSBzY2hlbWFbJ2VudW0nXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGwgPSBlbnVtZXIubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZvdW5kOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBsOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW51bWVyW2pdID09PSB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3VuZCA9IDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZm91bmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFcnJvcigiZG9lcyBub3QgaGF2ZSBhIHZhbHVlIGluIHRoZSBlbnVtZXJhdGlvbiAiICsgZW51bWVyLmpvaW4oIiwgIikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2NoZW1hLm1heERlY2ltYWwgPT0gJ251bWJlcicgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAodmFsdWUudG9TdHJpbmcoKS5tYXRjaChuZXcgUmVnRXhwKCJcXC5bMC05XXsiICsgKHNjaGVtYS5tYXhEZWNpbWFsICsgMSkgKyAiLH0iKSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFcnJvcigibWF5IG9ubHkgaGF2ZSAiICsgc2NoZW1hLm1heERlY2ltYWwgKyAiIGRpZ2l0cyBvZiBkZWNpbWFsIHBsYWNlcyIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHZhbGlkYXRlIGFuIG9iamVjdCBhZ2FpbnN0IGEgc2NoZW1hCiAgICAgICAgICAgIGZ1bmN0aW9uIGNoZWNrT2JqKGluc3RhbmNlLCBvYmpUeXBlRGVmLCBwYXRoLCBhZGRpdGlvbmFsUHJvcCkgewoKICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqVHlwZURlZiA9PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UgIT0gJ29iamVjdCcgfHwgaW5zdGFuY2UgaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcnMucHVzaCh7cHJvcGVydHk6cGF0aCxtZXNzYWdlOiJhbiBvYmplY3QgaXMgcmVxdWlyZWQifSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIG9ialR5cGVEZWYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9ialR5cGVEZWYuaGFzT3duUHJvcGVydHkoaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IGluc3RhbmNlW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2tpcCBfbm90XyBzcGVjaWZpZWQgcHJvcGVydGllcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgJiYgb3B0aW9ucy5leGlzdGluZ09ubHkpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByb3BEZWYgPSBvYmpUeXBlRGVmW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2V0IGRlZmF1bHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkICYmIHByb3BEZWZbImRlZmF1bHQiXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gaW5zdGFuY2VbaV0gPSBwcm9wRGVmWyJkZWZhdWx0Il07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5jb2VyY2UgJiYgaSBpbiBpbnN0YW5jZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gaW5zdGFuY2VbaV0gPSBvcHRpb25zLmNvZXJjZSh2YWx1ZSwgcHJvcERlZik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGVja1Byb3AodmFsdWUsIHByb3BEZWYsIHBhdGgsIGkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9yIChpIGluIGluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLmhhc093blByb3BlcnR5KGkpICYmICEoaS5jaGFyQXQoMCkgPT0gJ18nICYmIGkuY2hhckF0KDEpID09ICdfJykgJiYgb2JqVHlwZURlZiAmJiAhb2JqVHlwZURlZltpXSAmJiBhZGRpdGlvbmFsUHJvcCA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuZmlsdGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgaW5zdGFuY2VbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9ycy5wdXNoKHtwcm9wZXJ0eTpwYXRoLG1lc3NhZ2U6KHR5cGVvZiB2YWx1ZSkgKyAiVGhlIHByb3BlcnR5ICIgKyBpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiBpcyBub3QgZGVmaW5lZCBpbiB0aGUgc2NoZW1hIGFuZCB0aGUgc2NoZW1hIGRvZXMgbm90IGFsbG93IGFkZGl0aW9uYWwgcHJvcGVydGllcyJ9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YXIgcmVxdWlyZXMgPSBvYmpUeXBlRGVmICYmIG9ialR5cGVEZWZbaV0gJiYgb2JqVHlwZURlZltpXS5yZXF1aXJlczsKICAgICAgICAgICAgICAgICAgICBpZiAocmVxdWlyZXMgJiYgIShyZXF1aXJlcyBpbiBpbnN0YW5jZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JzLnB1c2goe3Byb3BlcnR5OnBhdGgsbWVzc2FnZToidGhlIHByZXNlbmNlIG9mIHRoZSBwcm9wZXJ0eSAiICsgaSArICIgcmVxdWlyZXMgdGhhdCAiICsgcmVxdWlyZXMgKyAiIGFsc28gYmUgcHJlc2VudCJ9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBpbnN0YW5jZVtpXTsKICAgICAgICAgICAgICAgICAgICBpZiAoYWRkaXRpb25hbFByb3AgJiYgKCEob2JqVHlwZURlZiAmJiB0eXBlb2Ygb2JqVHlwZURlZiA9PSAnb2JqZWN0JykgfHwgIShpIGluIG9ialR5cGVEZWYpKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5jb2VyY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gaW5zdGFuY2VbaV0gPSBvcHRpb25zLmNvZXJjZSh2YWx1ZSwgYWRkaXRpb25hbFByb3ApOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrUHJvcCh2YWx1ZSwgYWRkaXRpb25hbFByb3AsIHBhdGgsIGkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoIV9jaGFuZ2luZyAmJiB2YWx1ZSAmJiB2YWx1ZS4kc2NoZW1hKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9ycyA9IGVycm9ycy5jb25jYXQoY2hlY2tQcm9wKHZhbHVlLCB2YWx1ZS4kc2NoZW1hLCBwYXRoLCBpKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGVycm9yczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHNjaGVtYSkgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wKGluc3RhbmNlLCBzY2hlbWEsICcnLCBfY2hhbmdpbmcgfHwgJycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghX2NoYW5naW5nICYmIGluc3RhbmNlICYmIGluc3RhbmNlLiRzY2hlbWEpIHsKICAgICAgICAgICAgICAgIGNoZWNrUHJvcChpbnN0YW5jZSwgaW5zdGFuY2UuJHNjaGVtYSwgJycsICcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4ge3ZhbGlkOiFlcnJvcnMubGVuZ3RoLGVycm9yczplcnJvcnN9OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIHN1bW1hcnk6CiAgICAgICAgICogVGhpcyBjaGVja3MgdG8gZW5zdXJlIHRoYXQgdGhlIHJlc3VsdCBpcyB2YWxpZCBhbmQgd2lsbCB0aHJvdyBhbiBhcHByb3ByaWF0ZSBlcnJvciBtZXNzYWdlIGlmIGl0IGlzIG5vdAogICAgICAgICAqIHJlc3VsdDogdGhlIHJlc3VsdCByZXR1cm5lZCBmcm9tIGNoZWNrUHJvcGVydHlDaGFuZ2Ugb3IgdmFsaWRhdGUKICAgICAgICAgKiBAcGFyYW0gcmVzdWx0CiAgICAgICAgICovCiAgICAgICAgbXVzdEJlVmFsaWQgOiBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICAgICAgaWYgKCFyZXN1bHQudmFsaWQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IocmVzdWx0LmVycm9ycy5tYXAoCiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gImZvciBwcm9wZXJ0eSAiICsgZXJyb3IucHJvcGVydHkgKyAnOiAnICsgZXJyb3IubWVzc2FnZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkuam9pbigiLCBcbiIpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgogICAgLy8gc2V0dXAgcHJpbWl0aXZlIGNsYXNzZXMgdG8gYmUgSlNPTiBTY2hlbWEgdHlwZXMKICAgIFN0cmluZy50eXBlID0gInN0cmluZyI7CiAgICBCb29sZWFuLnR5cGUgPSAiYm9vbGVhbiI7CiAgICBOdW1iZXIudHlwZSA9ICJudW1iZXIiOwogICAgSW50ZWdlciA9IHt0eXBlOiJpbnRlZ2VyIn07CiAgICBPYmplY3QudHlwZSA9ICJvYmplY3QiOwogICAgQXJyYXkudHlwZSA9ICJhcnJheSI7CiAgICBEYXRlLnR5cGUgPSAiZGF0ZSI7CgogICAgJC52YWxpZGF0b3IgPSB3aW5kb3cuVmFsaWRhdG9yID0gVmFsaWRhdG9yOwoKfSkoalF1ZXJ5KTsKLy8gRGV0ZXJtaW5lIHdoYXQgaXMgby4KLyoqCiAqIEBpZ25vcmUKICogQHBhcmFtIG8KICovCmZ1bmN0aW9uIGhvb3ppdChvKSB7CiAgICBpZiAoby5jb25zdHJ1Y3RvciA9PT0gU3RyaW5nKSB7CiAgICAgICAgcmV0dXJuICJzdHJpbmciOwogICAgICAgIAogICAgfSBlbHNlIGlmIChvLmNvbnN0cnVjdG9yID09PSBCb29sZWFuKSB7CiAgICAgICAgcmV0dXJuICJib29sZWFuIjsKCiAgICB9IGVsc2UgaWYgKG8uY29uc3RydWN0b3IgPT09IE51bWJlcikgewoKICAgICAgICBpZiAoaXNOYU4obykpIHsKICAgICAgICAgICAgcmV0dXJuICJuYW4iOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAibnVtYmVyIjsKICAgICAgICB9CgogICAgfSBlbHNlIGlmICh0eXBlb2YgbyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICByZXR1cm4gInVuZGVmaW5lZCI7CgogICAgLy8gY29uc2lkZXI6IHR5cGVvZiBudWxsID09PSBvYmplY3QKICAgIH0gZWxzZSBpZiAobyA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiAibnVsbCI7CgogICAgLy8gY29uc2lkZXI6IHR5cGVvZiBbXSA9PT0gb2JqZWN0CiAgICB9IGVsc2UgaWYgKG8gaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgIHJldHVybiAiYXJyYXkiOwogICAgCiAgICAvLyBjb25zaWRlcjogdHlwZW9mIG5ldyBEYXRlKCkgPT09IG9iamVjdAogICAgfSBlbHNlIGlmIChvIGluc3RhbmNlb2YgRGF0ZSkgewogICAgICAgIHJldHVybiAiZGF0ZSI7CgogICAgLy8gY29uc2lkZXI6IC8uLyBpbnN0YW5jZW9mIE9iamVjdDsKICAgIC8vICAgICAgICAgICAvLi8gaW5zdGFuY2VvZiBSZWdFeHA7CiAgICAvLyAgICAgICAgICB0eXBlb2YgLy4vID09PSAiZnVuY3Rpb24iOyAvLyA9PiBmYWxzZSBpbiBJRSBhbmQgT3BlcmEsCiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRydWUgaW4gRkYgYW5kIFNhZmFyaQogICAgfSBlbHNlIGlmIChvIGluc3RhbmNlb2YgUmVnRXhwKSB7CiAgICAgICAgcmV0dXJuICJyZWdleHAiOwoKICAgIH0gZWxzZSBpZiAodHlwZW9mIG8gPT09ICJvYmplY3QiKSB7CiAgICAgICAgcmV0dXJuICJvYmplY3QiOwoKICAgIH0gZWxzZSBpZiAobyBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7CiAgICAgICAgcmV0dXJuICJmdW5jdGlvbiI7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICB9Cn0KCi8vIENhbGwgdGhlIG8gcmVsYXRlZCBjYWxsYmFjayB3aXRoIHRoZSBnaXZlbiBhcmd1bWVudHMuCi8qKgogKiBAaWdub3JlCiAqIEBwYXJhbSBvCiAqIEBwYXJhbSBjYWxsYmFja3MKICogQHBhcmFtIGFyZ3MKICovCmZ1bmN0aW9uIGJpbmRDYWxsYmFja3MobywgY2FsbGJhY2tzLCBhcmdzKSB7CiAgICB2YXIgcHJvcCA9IGhvb3ppdChvKTsKICAgIGlmIChwcm9wKSB7CiAgICAgICAgaWYgKGhvb3ppdChjYWxsYmFja3NbcHJvcF0pID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiBjYWxsYmFja3NbcHJvcF0uYXBwbHkoY2FsbGJhY2tzLCBhcmdzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gY2FsbGJhY2tzW3Byb3BdOyAvLyBvciB1bmRlZmluZWQKICAgICAgICB9CiAgICB9Cn0KLy8gVGVzdCBmb3IgZXF1YWxpdHkgYW55IEphdmFTY3JpcHQgdHlwZS4KLy8gRGlzY3Vzc2lvbnMgYW5kIHJlZmVyZW5jZTogaHR0cDovL3BoaWxyYXRoZS5jb20vYXJ0aWNsZXMvZXF1aXYKLy8gVGVzdCBzdWl0ZXM6IGh0dHA6Ly9waGlscmF0aGUuY29tL3Rlc3RzL2VxdWl2Ci8vIEF1dGhvcjogUGhpbGlwcGUgUmF0aMypIDxwcmF0aGVAZ21haWwuY29tPgovKioKICogQGlnbm9yZQogKi8KdmFyIGVxdWl2ID0gZnVuY3Rpb24gKCkgewoKICAgIHZhciBpbm5lckVxdWl2OyAvLyB0aGUgcmVhbCBlcXVpdiBmdW5jdGlvbgogICAgdmFyIGNhbGxlcnMgPSBbXTsgLy8gc3RhY2sgdG8gZGVjaWRlIGJldHdlZW4gc2tpcC9hYm9ydCBmdW5jdGlvbnMKCiAgICAKICAgIHZhciBjYWxsYmFja3MgPSBmdW5jdGlvbiAoKSB7CgogICAgICAgIC8vIGZvciBzdHJpbmcsIGJvb2xlYW4sIG51bWJlciBhbmQgbnVsbAogICAgICAgIGZ1bmN0aW9uIHVzZVN0cmljdEVxdWFsaXR5KGIsIGEpIHsKICAgICAgICAgICAgaWYgKGIgaW5zdGFuY2VvZiBhLmNvbnN0cnVjdG9yIHx8IGEgaW5zdGFuY2VvZiBiLmNvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgICAgICAvLyB0byBjYXRjaCBzaG9ydCBhbm5vdGFpb24gVlMgJ25ldycgYW5ub3RhdGlvbiBvZiBhIGRlY2xhcmF0aW9uCiAgICAgICAgICAgICAgICAvLyBlLmcuIHZhciBpID0gMTsKICAgICAgICAgICAgICAgIC8vICAgICAgdmFyIGogPSBuZXcgTnVtYmVyKDEpOwogICAgICAgICAgICAgICAgcmV0dXJuIGEgPT0gYjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBhID09PSBiOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAic3RyaW5nIjogdXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICJib29sZWFuIjogdXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICJudW1iZXIiOiB1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgIm51bGwiOiB1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgInVuZGVmaW5lZCI6IHVzZVN0cmljdEVxdWFsaXR5LAoKICAgICAgICAgICAgIm5hbiI6IGZ1bmN0aW9uIChiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaXNOYU4oYik7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAiZGF0ZSI6IGZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaG9veml0KGIpID09PSAiZGF0ZSIgJiYgYS52YWx1ZU9mKCkgPT09IGIudmFsdWVPZigpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgInJlZ2V4cCI6IGZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaG9veml0KGIpID09PSAicmVnZXhwIiAmJgogICAgICAgICAgICAgICAgICAgIGEuc291cmNlID09PSBiLnNvdXJjZSAmJiAvLyB0aGUgcmVnZXggaXRzZWxmCiAgICAgICAgICAgICAgICAgICAgYS5nbG9iYWwgPT09IGIuZ2xvYmFsICYmIC8vIGFuZCBpdHMgbW9kaWZlcnMgKGdtaSkgLi4uCiAgICAgICAgICAgICAgICAgICAgYS5pZ25vcmVDYXNlID09PSBiLmlnbm9yZUNhc2UgJiYKICAgICAgICAgICAgICAgICAgICBhLm11bHRpbGluZSA9PT0gYi5tdWx0aWxpbmU7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyAtIHNraXAgd2hlbiB0aGUgcHJvcGVydHkgaXMgYSBtZXRob2Qgb2YgYW4gaW5zdGFuY2UgKE9PUCkKICAgICAgICAgICAgLy8gLSBhYm9ydCBvdGhlcndpc2UsCiAgICAgICAgICAgIC8vICAgaW5pdGlhbCA9PT0gd291bGQgaGF2ZSBjYXRjaCBpZGVudGljYWwgcmVmZXJlbmNlcyBhbnl3YXkKICAgICAgICAgICAgImZ1bmN0aW9uIjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGNhbGxlciA9IGNhbGxlcnNbY2FsbGVycy5sZW5ndGggLSAxXTsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsZXIgIT09IE9iamVjdCAmJgogICAgICAgICAgICAgICAgICAgICAgICB0eXBlb2YgY2FsbGVyICE9PSAidW5kZWZpbmVkIjsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJhcnJheSI6IGZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICB2YXIgaTsKICAgICAgICAgICAgICAgIHZhciBsZW47CgogICAgICAgICAgICAgICAgLy8gYiBjb3VsZCBiZSBhbiBvYmplY3QgbGl0ZXJhbCBoZXJlCiAgICAgICAgICAgICAgICBpZiAoICEgKGhvb3ppdChiKSA9PT0gImFycmF5IikpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbGVuID0gYS5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAobGVuICE9PSBiLmxlbmd0aCkgeyAvLyBzYWZlIGFuZCBmYXN0ZXIKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiggISBpbm5lckVxdWl2KGFbaV0sIGJbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJvYmplY3QiOiBmdW5jdGlvbiAoYiwgYSkgewogICAgICAgICAgICAgICAgdmFyIGk7CiAgICAgICAgICAgICAgICB2YXIgZXEgPSB0cnVlOyAvLyB1bmxlc3Mgd2UgY2FuIHByb292ZSBpdAogICAgICAgICAgICAgICAgdmFyIGFQcm9wZXJ0aWVzID0gW10sIGJQcm9wZXJ0aWVzID0gW107IC8vIGNvbGxlY3Rpb24gb2Ygc3RyaW5ncwoKICAgICAgICAgICAgICAgIC8vIGNvbXBhcmluZyBjb25zdHJ1Y3RvcnMgaXMgbW9yZSBzdHJpY3QgdGhhbiB1c2luZyBpbnN0YW5jZW9mCiAgICAgICAgICAgICAgICBpZiAoIGEuY29uc3RydWN0b3IgIT09IGIuY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gc3RhY2sgY29uc3RydWN0b3IgYmVmb3JlIHRyYXZlcnNpbmcgcHJvcGVydGllcwogICAgICAgICAgICAgICAgY2FsbGVycy5wdXNoKGEuY29uc3RydWN0b3IpOwoKICAgICAgICAgICAgICAgIGZvciAoaSBpbiBhKSB7IC8vIGJlIHN0cmljdDogZG9uJ3QgZW5zdXJlcyBoYXNPd25Qcm9wZXJ0eSBhbmQgZ28gZGVlcAoKICAgICAgICAgICAgICAgICAgICBhUHJvcGVydGllcy5wdXNoKGkpOyAvLyBjb2xsZWN0IGEncyBwcm9wZXJ0aWVzCgogICAgICAgICAgICAgICAgICAgIGlmICggISBpbm5lckVxdWl2KGFbaV0sIGJbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVxID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxlcnMucG9wKCk7IC8vIHVuc3RhY2ssIHdlIGFyZSBkb25lCgogICAgICAgICAgICAgICAgZm9yIChpIGluIGIpIHsKICAgICAgICAgICAgICAgICAgICBiUHJvcGVydGllcy5wdXNoKGkpOyAvLyBjb2xsZWN0IGIncyBwcm9wZXJ0aWVzCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRW5zdXJlcyBpZGVudGljYWwgcHJvcGVydGllcyBuYW1lCiAgICAgICAgICAgICAgICByZXR1cm4gZXEgJiYgaW5uZXJFcXVpdihhUHJvcGVydGllcy5zb3J0KCksIGJQcm9wZXJ0aWVzLnNvcnQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfSgpOwogICAgLyoqCiAgICAgKiBAaWdub3JlCiAgICAgKi8KICAgIGlubmVyRXF1aXYgPSBmdW5jdGlvbiAoKSB7IC8vIGNhbiB0YWtlIG11bHRpcGxlIGFyZ3VtZW50cwogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmFwcGx5KGFyZ3VtZW50cyk7CiAgICAgICAgaWYgKGFyZ3MubGVuZ3RoIDwgMikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gZW5kIHRyYW5zaXRpb24KICAgICAgICB9CgogICAgICAgIHJldHVybiAoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgaWYgKGEgPT09IGIpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBjYXRjaCB0aGUgbW9zdCB5b3UgY2FuCiAgICAgICAgICAgIH0gZWxzZSBpZiAoYSA9PT0gbnVsbCB8fCBiID09PSBudWxsIHx8IHR5cGVvZiBhID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgYiA9PT0gInVuZGVmaW5lZCIgfHwgaG9veml0KGEpICE9PSBob296aXQoYikpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsgLy8gZG9uJ3QgbG9zZSB0aW1lIHdpdGggZXJyb3IgcHJvbmUgY2FzZXMKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBiaW5kQ2FsbGJhY2tzKGEsIGNhbGxiYWNrcywgW2IsIGFdKTsKICAgICAgICAgICAgfQoKICAgICAgICAvLyBhcHBseSB0cmFuc2l0aW9uIHdpdGggKDEuLm4pIGFyZ3VtZW50cwogICAgICAgIH0pKGFyZ3NbMF0sIGFyZ3NbMV0pICYmIGFyZ3VtZW50cy5jYWxsZWUuYXBwbHkodGhpcywgYXJncy5zcGxpY2UoMSwgYXJncy5sZW5ndGggLTEpKTsKICAgIH07CgogICAgcmV0dXJuIGlubmVyRXF1aXY7Cgp9KCk7LyoKIE1hc2tlZCBJbnB1dCBwbHVnaW4gZm9yIGpRdWVyeQogQ29weXJpZ2h0IChjKSAyMDA3LTIwMTMgSm9zaCBCdXNoIChkaWdpdGFsYnVzaC5jb20pCiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgKGh0dHA6Ly9kaWdpdGFsYnVzaC5jb20vcHJvamVjdHMvbWFza2VkLWlucHV0LXBsdWdpbi8jbGljZW5zZSkKIFZlcnNpb246IDEuMy4xCiAqLwooZnVuY3Rpb24oJCkgewogICAgZnVuY3Rpb24gZ2V0UGFzdGVFdmVudCgpIHsKICAgICAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpLAogICAgICAgICAgICBuYW1lID0gJ29ucGFzdGUnOwogICAgICAgIGVsLnNldEF0dHJpYnV0ZShuYW1lLCAnJyk7CiAgICAgICAgcmV0dXJuICh0eXBlb2YgZWxbbmFtZV0gPT09ICdmdW5jdGlvbicpPydwYXN0ZSc6J2lucHV0JzsKICAgIH0KCiAgICB2YXIgcGFzdGVFdmVudE5hbWUgPSBnZXRQYXN0ZUV2ZW50KCkgKyAiLm1hc2siLAogICAgICAgIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKICAgICAgICBpUGhvbmUgPSAvaXBob25lL2kudGVzdCh1YSksCiAgICAgICAgYW5kcm9pZD0vYW5kcm9pZC9pLnRlc3QodWEpLAogICAgICAgIGNhcmV0VGltZW91dElkOwoKICAgICQubWFzayA9IHsKICAgICAgICAvL1ByZWRlZmluZWQgY2hhcmFjdGVyIGRlZmluaXRpb25zCiAgICAgICAgZGVmaW5pdGlvbnM6IHsKICAgICAgICAgICAgJzknOiAiWzAtOV0iLAogICAgICAgICAgICAnYSc6ICJbQS1aYS16XSIsCiAgICAgICAgICAgICcqJzogIltBLVphLXowLTldIgogICAgICAgIH0sCiAgICAgICAgZGF0YU5hbWU6ICJyYXdNYXNrRm4iLAogICAgICAgIHBsYWNlaG9sZGVyOiAnXycKICAgIH07CgogICAgJC5mbi5leHRlbmQoewogICAgICAgIC8vSGVscGVyIEZ1bmN0aW9uIGZvciBDYXJldCBwb3NpdGlvbmluZwogICAgICAgIGNhcmV0OiBmdW5jdGlvbihiZWdpbiwgZW5kKSB7CiAgICAgICAgICAgIHZhciByYW5nZTsKCiAgICAgICAgICAgIGlmICh0aGlzLmxlbmd0aCA9PT0gMCB8fCB0aGlzLmlzKCI6aGlkZGVuIikpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGVvZiBiZWdpbiA9PSAnbnVtYmVyJykgewogICAgICAgICAgICAgICAgZW5kID0gKHR5cGVvZiBlbmQgPT09ICdudW1iZXInKSA/IGVuZCA6IGJlZ2luOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zZXRTZWxlY3Rpb25SYW5nZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFNlbGVjdGlvblJhbmdlKGJlZ2luLCBlbmQpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5jcmVhdGVUZXh0UmFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UgPSB0aGlzLmNyZWF0ZVRleHRSYW5nZSgpOwogICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5jb2xsYXBzZSh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UubW92ZUVuZCgnY2hhcmFjdGVyJywgZW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UubW92ZVN0YXJ0KCdjaGFyYWN0ZXInLCBiZWdpbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNlbGVjdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHRoaXNbMF0uc2V0U2VsZWN0aW9uUmFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICBiZWdpbiA9IHRoaXNbMF0uc2VsZWN0aW9uU3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgZW5kID0gdGhpc1swXS5zZWxlY3Rpb25FbmQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRvY3VtZW50LnNlbGVjdGlvbiAmJiBkb2N1bWVudC5zZWxlY3Rpb24uY3JlYXRlUmFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICByYW5nZSA9IGRvY3VtZW50LnNlbGVjdGlvbi5jcmVhdGVSYW5nZSgpOwogICAgICAgICAgICAgICAgICAgIGJlZ2luID0gMCAtIHJhbmdlLmR1cGxpY2F0ZSgpLm1vdmVTdGFydCgnY2hhcmFjdGVyJywgLTEwMDAwMCk7CiAgICAgICAgICAgICAgICAgICAgZW5kID0gYmVnaW4gKyByYW5nZS50ZXh0Lmxlbmd0aDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB7IGJlZ2luOiBiZWdpbiwgZW5kOiBlbmQgfTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgdW5tYXNrOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudHJpZ2dlcigidW5tYXNrIik7CiAgICAgICAgfSwKICAgICAgICBtYXNrOiBmdW5jdGlvbihtYXNrLCBzZXR0aW5ncykgewogICAgICAgICAgICB2YXIgaW5wdXQsCiAgICAgICAgICAgICAgICBkZWZzLAogICAgICAgICAgICAgICAgdGVzdHMsCiAgICAgICAgICAgICAgICBwYXJ0aWFsUG9zaXRpb24sCiAgICAgICAgICAgICAgICBmaXJzdE5vbk1hc2tQb3MsCiAgICAgICAgICAgICAgICBsZW47CgogICAgICAgICAgICBpZiAoIW1hc2sgJiYgdGhpcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBpbnB1dCA9ICQodGhpc1swXSk7CiAgICAgICAgICAgICAgICByZXR1cm4gaW5wdXQuZGF0YSgkLm1hc2suZGF0YU5hbWUpKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0dGluZ3MgPSAkLmV4dGVuZCh7CiAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcjogJC5tYXNrLnBsYWNlaG9sZGVyLCAvLyBMb2FkIGRlZmF1bHQgcGxhY2Vob2xkZXIKICAgICAgICAgICAgICAgIGNvbXBsZXRlZDogbnVsbAogICAgICAgICAgICB9LCBzZXR0aW5ncyk7CgoKICAgICAgICAgICAgZGVmcyA9ICQubWFzay5kZWZpbml0aW9uczsKICAgICAgICAgICAgdGVzdHMgPSBbXTsKICAgICAgICAgICAgcGFydGlhbFBvc2l0aW9uID0gbGVuID0gbWFzay5sZW5ndGg7CiAgICAgICAgICAgIGZpcnN0Tm9uTWFza1BvcyA9IG51bGw7CgogICAgICAgICAgICAkLmVhY2gobWFzay5zcGxpdCgiIiksIGZ1bmN0aW9uKGksIGMpIHsKICAgICAgICAgICAgICAgIGlmIChjID09ICc/JykgewogICAgICAgICAgICAgICAgICAgIGxlbi0tOwogICAgICAgICAgICAgICAgICAgIHBhcnRpYWxQb3NpdGlvbiA9IGk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRlZnNbY10pIHsKICAgICAgICAgICAgICAgICAgICB0ZXN0cy5wdXNoKG5ldyBSZWdFeHAoZGVmc1tjXSkpOwogICAgICAgICAgICAgICAgICAgIGlmIChmaXJzdE5vbk1hc2tQb3MgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3ROb25NYXNrUG9zID0gdGVzdHMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRlc3RzLnB1c2gobnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXMudHJpZ2dlcigidW5tYXNrIikuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9ICQodGhpcyksCiAgICAgICAgICAgICAgICAgICAgYnVmZmVyID0gJC5tYXAoCiAgICAgICAgICAgICAgICAgICAgICAgIG1hc2suc3BsaXQoIiIpLAogICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbihjLCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYyAhPSAnPycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGVmc1tjXSA/IHNldHRpbmdzLnBsYWNlaG9sZGVyIDogYzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgZm9jdXNUZXh0ID0gaW5wdXQudmFsKCk7CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gc2Vla05leHQocG9zKSB7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKCsrcG9zIDwgbGVuICYmICF0ZXN0c1twb3NdKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcG9zOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHNlZWtQcmV2KHBvcykgewogICAgICAgICAgICAgICAgICAgIHdoaWxlICgtLXBvcyA+PSAwICYmICF0ZXN0c1twb3NdKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcG9zOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHNoaWZ0TChiZWdpbixlbmQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaSwKICAgICAgICAgICAgICAgICAgICAgICAgajsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGJlZ2luPDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gYmVnaW4sIGogPSBzZWVrTmV4dChlbmQpOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRlc3RzW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaiA8IGxlbiAmJiB0ZXN0c1tpXS50ZXN0KGJ1ZmZlcltqXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidWZmZXJbaV0gPSBidWZmZXJbal07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVmZmVyW2pdID0gc2V0dGluZ3MucGxhY2Vob2xkZXI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGogPSBzZWVrTmV4dChqKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB3cml0ZUJ1ZmZlcigpOwogICAgICAgICAgICAgICAgICAgIGlucHV0LmNhcmV0KE1hdGgubWF4KGZpcnN0Tm9uTWFza1BvcywgYmVnaW4pKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzaGlmdFIocG9zKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGksCiAgICAgICAgICAgICAgICAgICAgICAgIGMsCiAgICAgICAgICAgICAgICAgICAgICAgIGosCiAgICAgICAgICAgICAgICAgICAgICAgIHQ7CgogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IHBvcywgYyA9IHNldHRpbmdzLnBsYWNlaG9sZGVyOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRlc3RzW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqID0gc2Vla05leHQoaSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ID0gYnVmZmVyW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVmZmVyW2ldID0gYzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqIDwgbGVuICYmIHRlc3RzW2pdLnRlc3QodCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjID0gdDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24ga2V5ZG93bkV2ZW50KGUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgayA9IGUud2hpY2gsCiAgICAgICAgICAgICAgICAgICAgICAgIHBvcywKICAgICAgICAgICAgICAgICAgICAgICAgYmVnaW4sCiAgICAgICAgICAgICAgICAgICAgICAgIGVuZDsKCiAgICAgICAgICAgICAgICAgICAgLy9iYWNrc3BhY2UsIGRlbGV0ZSwgYW5kIGVzY2FwZSBnZXQgc3BlY2lhbCB0cmVhdG1lbnQKICAgICAgICAgICAgICAgICAgICBpZiAoayA9PT0gOCB8fCBrID09PSA0NiB8fCAoaVBob25lICYmIGsgPT09IDEyNykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zID0gaW5wdXQuY2FyZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgYmVnaW4gPSBwb3MuYmVnaW47CiAgICAgICAgICAgICAgICAgICAgICAgIGVuZCA9IHBvcy5lbmQ7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW5kIC0gYmVnaW4gPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJlZ2luPWshPT00Nj9zZWVrUHJldihiZWdpbik6KGVuZD1zZWVrTmV4dChiZWdpbi0xKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmQ9az09PTQ2P3NlZWtOZXh0KGVuZCk6ZW5kOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyQnVmZmVyKGJlZ2luLCBlbmQpOwogICAgICAgICAgICAgICAgICAgICAgICBzaGlmdEwoYmVnaW4sIGVuZCAtIDEpOwoKICAgICAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoayA9PSAyNykgey8vZXNjYXBlCiAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0LnZhbChmb2N1c1RleHQpOwogICAgICAgICAgICAgICAgICAgICAgICBpbnB1dC5jYXJldCgwLCBjaGVja1ZhbCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBrZXlwcmVzc0V2ZW50KGUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgayA9IGUud2hpY2gsCiAgICAgICAgICAgICAgICAgICAgICAgIHBvcyA9IGlucHV0LmNhcmV0KCksCiAgICAgICAgICAgICAgICAgICAgICAgIHAsCiAgICAgICAgICAgICAgICAgICAgICAgIGMsCiAgICAgICAgICAgICAgICAgICAgICAgIG5leHQ7CgogICAgICAgICAgICAgICAgICAgIGlmIChlLmN0cmxLZXkgfHwgZS5hbHRLZXkgfHwgZS5tZXRhS2V5IHx8IGsgPCAzMikgey8vSWdub3JlCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBvcy5lbmQgLSBwb3MuYmVnaW4gIT09IDApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJCdWZmZXIocG9zLmJlZ2luLCBwb3MuZW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoaWZ0TChwb3MuYmVnaW4sIHBvcy5lbmQtMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHAgPSBzZWVrTmV4dChwb3MuYmVnaW4gLSAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAgPCBsZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGMgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGspOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRlc3RzW3BdLnRlc3QoYykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGlmdFIocCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlcltwXSA9IGM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd3JpdGVCdWZmZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0ID0gc2Vla05leHQocCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGFuZHJvaWQpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCQucHJveHkoJC5mbi5jYXJldCxpbnB1dCxuZXh0KSwwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQuY2FyZXQobmV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2V0dGluZ3MuY29tcGxldGVkICYmIG5leHQgPj0gbGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldHRpbmdzLmNvbXBsZXRlZC5jYWxsKGlucHV0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjbGVhckJ1ZmZlcihzdGFydCwgZW5kKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGk7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gc3RhcnQ7IGkgPCBlbmQgJiYgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0ZXN0c1tpXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVmZmVyW2ldID0gc2V0dGluZ3MucGxhY2Vob2xkZXI7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gd3JpdGVCdWZmZXIoKSB7CiAgICAgICAgICAgICAgICAgICAgaW5wdXQudmFsKGJ1ZmZlci5qb2luKCcnKSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gY2hlY2tWYWwoYWxsb3cpIHsKICAgICAgICAgICAgICAgICAgICAvL3RyeSB0byBwbGFjZSBjaGFyYWN0ZXJzIHdoZXJlIHRoZXkgYmVsb25nCiAgICAgICAgICAgICAgICAgICAgdmFyIHRlc3QgPSBpbnB1dC52YWwoKSwKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdE1hdGNoID0gLTEsCiAgICAgICAgICAgICAgICAgICAgICAgIGksCiAgICAgICAgICAgICAgICAgICAgICAgIGM7CgogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIHBvcyA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGVzdHNbaV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlcltpXSA9IHNldHRpbmdzLnBsYWNlaG9sZGVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKHBvcysrIDwgdGVzdC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjID0gdGVzdC5jaGFyQXQocG9zIC0gMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRlc3RzW2ldLnRlc3QoYykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVmZmVyW2ldID0gYzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdE1hdGNoID0gaTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBvcyA+IHRlc3QubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYnVmZmVyW2ldID09PSB0ZXN0LmNoYXJBdChwb3MpICYmIGkgIT09IHBhcnRpYWxQb3NpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0TWF0Y2ggPSBpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChhbGxvdykgewogICAgICAgICAgICAgICAgICAgICAgICB3cml0ZUJ1ZmZlcigpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobGFzdE1hdGNoICsgMSA8IHBhcnRpYWxQb3NpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpbnB1dC52YWwoIiIpOwogICAgICAgICAgICAgICAgICAgICAgICBjbGVhckJ1ZmZlcigwLCBsZW4pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdyaXRlQnVmZmVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0LnZhbChpbnB1dC52YWwoKS5zdWJzdHJpbmcoMCwgbGFzdE1hdGNoICsgMSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gKHBhcnRpYWxQb3NpdGlvbiA/IGkgOiBmaXJzdE5vbk1hc2tQb3MpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlucHV0LmRhdGEoJC5tYXNrLmRhdGFOYW1lLGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICQubWFwKGJ1ZmZlciwgZnVuY3Rpb24oYywgaSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGVzdHNbaV0mJmMhPXNldHRpbmdzLnBsYWNlaG9sZGVyID8gYyA6IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfSkuam9pbignJyk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBpZiAoIWlucHV0LmF0dHIoInJlYWRvbmx5IikpCiAgICAgICAgICAgICAgICAgICAgaW5wdXQKICAgICAgICAgICAgICAgICAgICAgICAgLm9uZSgidW5tYXNrIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnB1dAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC51bmJpbmQoIi5tYXNrIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVtb3ZlRGF0YSgkLm1hc2suZGF0YU5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAuYmluZCgiZm9jdXMubWFzayIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGNhcmV0VGltZW91dElkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwb3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZUNhcmV0OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvY3VzVGV4dCA9IGlucHV0LnZhbCgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFVaSTogYWRkZWQgdGhpcyB0byBhbGxvdyBmb3IgdmFsKCcnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2VlOiBodHRwczovL2dpdGh1Yi5jb20vZGlnaXRhbEJ1c2gvanF1ZXJ5Lm1hc2tlZGlucHV0L2lzc3Vlcy8yOQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvY3VzVGV4dCA9PT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhckJ1ZmZlcigwLCBsZW4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdyaXRlQnVmZmVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MgPSBjaGVja1ZhbCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRU5EIFVaSQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vcG9zID0gY2hlY2tWYWwoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXJldFRpbWVvdXRJZCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3cml0ZUJ1ZmZlcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwb3MgPT0gbWFzay5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQuY2FyZXQoMCwgcG9zKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnB1dC5jYXJldChwb3MpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgLmJpbmQoImJsdXIubWFzayIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tWYWwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnB1dC52YWwoKSAhPSBmb2N1c1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQuY2hhbmdlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIC5iaW5kKCJrZXlkb3duLm1hc2siLCBrZXlkb3duRXZlbnQpCiAgICAgICAgICAgICAgICAgICAgICAgIC5iaW5kKCJrZXlwcmVzcy5tYXNrIiwga2V5cHJlc3NFdmVudCkKICAgICAgICAgICAgICAgICAgICAgICAgLmJpbmQocGFzdGVFdmVudE5hbWUsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcG9zPWNoZWNrVmFsKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0LmNhcmV0KHBvcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNldHRpbmdzLmNvbXBsZXRlZCAmJiBwb3MgPT0gaW5wdXQudmFsKCkubGVuZ3RoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXR0aW5ncy5jb21wbGV0ZWQuY2FsbChpbnB1dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBjaGVja1ZhbCgpOyAvL1BlcmZvcm0gaW5pdGlhbCBjaGVjayBmb3IgZXhpc3RpbmcgdmFsdWVzCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0pOwoKCn0pKGpRdWVyeSk7Lypqc2hpbnQgLVcwMDQgKi8gLy8gZHVwbGljYXRlIHZhcmlhYmxlcwovKmpzaGludCAtVzA4MyAqLyAvLyBpbmxpbmUgZnVuY3Rpb25zIGFyZSB1c2VkIHNhZmVseQovKioKICogQWxwYWNhIGZvcm1zIGVuZ2luZSBmb3IgalF1ZXJ5CiAqLwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2E7CgogICAgLyoqCiAgICAgKiBAbmFtZXNwYWNlIFN0YXRpYyBtZXRob2QgdG8gYnVpbGQgYW4gQWxwYWNhIGZpZWxkIGluc3RhbmNlIGJvdW5kIHRvIGEgRE9NIGVsZW1lbnQuCiAgICAgKiBAZGVzY3JpcHRpb24gPHA+VXNhZ2U6PC9wPgogICAgICogPHA+CiAgICAgKiAxOiBCaW5kcyBhIGNvbnRyb2wgdXNpbmcgdGhlIGNvbnRlbnRzIG9mICQoZWwpIG9yIGhhbmRzIGJhY2sgYSBwcmV2aW91c2x5IGJvdW5kIGNvbnRyb2w8YnIvPgogICAgICogPGNvZGU+CiAgICAgKiAgICAgPHByZT4KICAgICAqICAgICAgQWxwYWNhKGVsKQogICAgICogICAgIDwvcHJlPgogICAgICogPC9jb2RlPgogICAgICogPC9wPgogICAgICogPHA+CiAgICAgKiAyOiBCaW5kcyBhIGNvbnRyb2wgdG8gJChlbCkgdXNpbmcgdGhlIGdpdmVuIGRhdGEgKG9ubHkgZm9yIG5vbi1vYmplY3QgdHlwZXMpLjxici8+CiAgICAgKiA8Y29kZT4KICAgICAqICAgICA8cHJlPgogICAgICogICAgICBBbHBhY2EoZWwsIGRhdGEpCiAgICAgKiAgICAgPC9wcmU+CiAgICAgKiA8L2NvZGU+CiAgICAgKiA8L3A+CiAgICAgKiA8cD4KICAgICAqIDM6IEJpbmRzIGEgY29udHJvbCB0byAkKGVsKSB1c2luZyB0aGUgZ2l2ZW4gY29uZmlndXJhdGlvbiBvYmplY3QuPGJyLz4KICAgICAqIDwvcD4KICAgICAqIDxjb2RlPgogICAgICogICAgIDxwcmU+CiAgICAgKiBBbHBhY2EoZWwsewogICAgICogICAiZGF0YSIgOiB7QW55fSBmaWVsZCBkYXRhIChvcHRpb25hbCksCiAgICAgKiAgICJzY2hlbWEiOiB7T2JqZWN0fSBmaWVsZCBzY2hlbWEgKG9wdGlvbmFsKSwKICAgICAqICAgIm9wdGlvbnMiIDoge09iamVjdH0gZmllbGQgb3B0aW9ucyAob3B0aW9uYWwpLAogICAgICogICAidmlldyI6IHtPYmplY3R8U3RyaW5nfSBmaWVsZCB2aWV3IChvYmplY3Qgb3IgaWQgcmVmZXJlbmNlKSAob3B0aW9uYWwpLAogICAgICogICAicmVuZGVyIjoge0Z1bmN0aW9ufSBjYWxsYmFjayBmdW5jdGlvbiBmb3IgcmVwbGFjaW5nIGRlZmF1bHQgcmVuZGVyaW5nIG1ldGhvZCAob3B0aW9uYWwpLAogICAgICogICAicG9zdFJlbmRlciI6IHtGdW5jdGlvbn0gY2FsbGJhY2sgZnVuY3Rpb24gZm9yIHBvc3QtcmVuZGVyaW5nICAob3B0aW9uYWwpLAogICAgICogICAiZXJyb3IiOiB7RnVuY3Rpb259IGNhbGxiYWNrIGZ1bmN0aW9uIGZvciBlcnJvciBoYW5kbGluZyAgKG9wdGlvbmFsKSwKICAgICAqICAgImNvbm5lY3RvciI6IHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgZm9yIHJldHJpZXZpbmcgb3Igc3RvcmluZyBkYXRhLCBzY2hlbWEsIG9wdGlvbnMsCiAgICAgKiAgICAgICAgICAgICAgICB2aWV3IGFuZCB0ZW1wbGF0ZXMuIChvcHRpb25hbCksCiAgICAgKiB9KTsKICAgICAqICAgIDwvcHJlPgogICAgICo8L2NvZGU+CiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBhbHBhY2EgZmllbGQgaW5zdGFuY2UKICAgICAqLwogICAgQWxwYWNhID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBBbHBhY2EubWFrZUFycmF5KGFyZ3VtZW50cyk7CiAgICAgICAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIC8vIGlsbGVnYWwKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS50aHJvd0RlZmF1bHRFcnJvcigiWW91IG11c3Qgc3VwcGx5IGF0IGxlYXN0IG9uZSBhcmd1bWVudCB3aGljaCBpcyB0aGUgZWxlbWVudCBhZ2FpbnN0IHdoaWNoIHRvIGFwcGx5IHRoZSBBbHBhY2EgZ2VuZXJhdGVkIGZvcm0iKTsKICAgICAgICB9CgogICAgICAgIC8vIGVsZW1lbnQgaXMgdGhlIGZpcnN0IGFyZ3VtZW50CiAgICAgICAgdmFyIGVsID0gYXJnc1swXTsKCiAgICAgICAgLy8gb3RoZXIgYXJndW1lbnRzIHdlIG1heSB3YW50IHRvIGZpZ3VyZSBvdXQKICAgICAgICB2YXIgZGF0YSA9IG51bGw7CiAgICAgICAgdmFyIHNjaGVtYSA9IG51bGw7CiAgICAgICAgdmFyIG9wdGlvbnMgPSBudWxsOwogICAgICAgIHZhciB2aWV3ID0gbnVsbDsKICAgICAgICB2YXIgY2FsbGJhY2sgPSBudWxsOwogICAgICAgIHZhciByZW5kZXJlZENhbGxiYWNrID0gbnVsbDsKICAgICAgICB2YXIgZXJyb3JDYWxsYmFjayA9IG51bGw7CiAgICAgICAgdmFyIGNvbm5lY3RvciA9IG51bGw7CiAgICAgICAgdmFyIG5vdFRvcExldmVsID0gZmFsc2U7CiAgICAgICAgdmFyIGlzRHluYW1pY0NyZWF0aW9uID0gZmFsc2U7CiAgICAgICAgdmFyIGluaXRpYWxTZXR0aW5ncyA9IHt9OwoKICAgICAgICAvLyBpZiB0aGVzZSBvcHRpb25zIGFyZSBwcm92aWRlZCwgdGhlbiBkYXRhLCBzY2hlbWEsIG9wdGlvbnMgYW5kIHNvdXJjZSBhcmUgbG9hZGVkIHZpYSBjb25uZWN0b3IKICAgICAgICB2YXIgZGF0YVNvdXJjZSA9IG51bGw7CiAgICAgICAgdmFyIHNjaGVtYVNvdXJjZSA9IG51bGw7CiAgICAgICAgdmFyIG9wdGlvbnNTb3VyY2UgPSBudWxsOwogICAgICAgIHZhciB2aWV3U291cmNlID0gbnVsbDsKCiAgICAgICAgaWYgKGFyZ3MubGVuZ3RoID09IDEpIHsKICAgICAgICAgICAgLy8gaGFuZHMgYmFjayB0aGUgZmllbGQgaW5zdGFuY2UgdGhhdCBpcyBib3VuZCBkaXJlY3RseSB1bmRlciB0aGUgc3BlY2lmaWVkIGVsZW1lbnQKICAgICAgICAgICAgLy8gdmFyIGZpZWxkID0gQWxwYWNhKGVsKTsKICAgICAgICAgICAgdmFyIGRvbUVsZW1lbnRzID0gJChlbCkuZmluZCgiOmZpcnN0Iik7CgogICAgICAgICAgICB2YXIgZmllbGQgPSBudWxsOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRvbUVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgZG9tRWxlbWVudCA9IGRvbUVsZW1lbnRzW2ldOwogICAgICAgICAgICAgICAgdmFyIGZpZWxkSWQgPSAkKGRvbUVsZW1lbnQpLmF0dHIoImFscGFjYS1maWVsZC1pZCIpOwogICAgICAgICAgICAgICAgaWYgKGZpZWxkSWQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX2ZpZWxkID0gQWxwYWNhLmZpZWxkSW5zdGFuY2VzW2ZpZWxkSWRdOwogICAgICAgICAgICAgICAgICAgIGlmIChfZmllbGQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGQgPSBfZmllbGQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZmllbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmaWVsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIG90aGVyd2lzZSwgZ3JhYiB0aGUgZGF0YSBpbnNpZGUgdGhlIGVsZW1lbnQgYW5kIHVzZSB0aGF0IGZvciB0aGUgY29udHJvbAogICAgICAgICAgICAgICAgdmFyIGRvbURhdGEgPSAkKGVsKS5odG1sKCk7CiAgICAgICAgICAgICAgICAkKGVsKS5odG1sKCIiKTsKICAgICAgICAgICAgICAgIGRhdGEgPSBkb21EYXRhOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoYXJncy5sZW5ndGggPj0gMikgewogICAgICAgICAgICBpZiAoQWxwYWNhLmlzT2JqZWN0KGFyZ3NbMV0pKSB7CiAgICAgICAgICAgICAgICBkYXRhID0gYXJnc1sxXS5kYXRhOwogICAgICAgICAgICAgICAgc2NoZW1hID0gYXJnc1sxXS5zY2hlbWE7CiAgICAgICAgICAgICAgICBvcHRpb25zID0gYXJnc1sxXS5vcHRpb25zOwogICAgICAgICAgICAgICAgdmlldyA9IGFyZ3NbMV0udmlldzsKICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gYXJnc1sxXS5yZW5kZXI7CiAgICAgICAgICAgICAgICByZW5kZXJlZENhbGxiYWNrID0gYXJnc1sxXS5wb3N0UmVuZGVyOwogICAgICAgICAgICAgICAgZXJyb3JDYWxsYmFjayA9IGFyZ3NbMV0uZXJyb3I7CiAgICAgICAgICAgICAgICBjb25uZWN0b3IgPSBhcmdzWzFdLmNvbm5lY3RvcjsKCiAgICAgICAgICAgICAgICAvLyBzb3VyY2VzCiAgICAgICAgICAgICAgICBkYXRhU291cmNlID0gYXJnc1sxXS5kYXRhU291cmNlOwogICAgICAgICAgICAgICAgc2NoZW1hU291cmNlID0gYXJnc1sxXS5zY2hlbWFTb3VyY2U7CiAgICAgICAgICAgICAgICBvcHRpb25zU291cmNlID0gYXJnc1sxXS5vcHRpb25zU291cmNlOwogICAgICAgICAgICAgICAgdmlld1NvdXJjZSA9IGFyZ3NbMV0udmlld1NvdXJjZTsKCiAgICAgICAgICAgICAgICAvLyBvdGhlcgogICAgICAgICAgICAgICAgaWYgKGFyZ3NbMV0udWkpIHsKICAgICAgICAgICAgICAgICAgICBpbml0aWFsU2V0dGluZ3NbInVpIl0gPSBhcmdzWzFdLnVpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGFyZ3NbMV0udHlwZSkgewogICAgICAgICAgICAgICAgICAgIGluaXRpYWxTZXR0aW5nc1sidHlwZSJdID0gYXJnc1sxXS50eXBlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eShhcmdzWzFdLm5vdFRvcExldmVsKSkgewogICAgICAgICAgICAgICAgICAgIG5vdFRvcExldmVsID0gYXJnc1sxXS5ub3RUb3BMZXZlbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghQWxwYWNhLmlzRW1wdHkoYXJnc1sxXS5pc0R5bmFtaWNDcmVhdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICBpc0R5bmFtaWNDcmVhdGlvbiA9IGFyZ3NbMV0uaXNEeW5hbWljQ3JlYXRpb247CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyAiZGF0YSIgaXMgdGhlIHNlY29uZCBhcmd1bWVudAogICAgICAgICAgICAgICAgZGF0YSA9IGFyZ3NbMV07CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzRnVuY3Rpb24oZGF0YSkpIHsKICAgICAgICAgICAgICAgICAgICBkYXRhID0gZGF0YSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBpZiBubyBlcnJvciBjYWxsYmFjayBpcyBwcm92aWRlZCwgd2UgZmFsbCBiYWNrIHRvIGEgYnJvd3NlciBhbGVydAogICAgICAgIGlmIChBbHBhY2EuaXNFbXB0eShlcnJvckNhbGxiYWNrKSkgewogICAgICAgICAgICBlcnJvckNhbGxiYWNrID0gQWxwYWNhLmRlZmF1bHRFcnJvckNhbGxiYWNrOwogICAgICAgIH0KCiAgICAgICAgaWYgKEFscGFjYS5pc0VtcHR5KGNvbm5lY3RvcikpIHsKICAgICAgICAgICAgdmFyIGNvbm5lY3RvckNsYXNzID0gQWxwYWNhLmdldENvbm5lY3RvckNsYXNzKCJkZWZhdWx0Iik7CiAgICAgICAgICAgIGNvbm5lY3RvciA9IG5ldyBjb25uZWN0b3JDbGFzcygiZGVmYXVsdCIpOwogICAgICAgIH0KCiAgICAgICAgLy8gY29udGFpbmVyIGNhbiBlaXRoZXIgYmUgYSBkb20gaWQgb3IgYSBkb20gZWxlbWVudAogICAgICAgIGlmIChlbCkgewogICAgICAgICAgICBpZiAoQWxwYWNhLmlzU3RyaW5nKGVsKSkgewogICAgICAgICAgICAgICAgZWwgPSAkKCIjIiArIGVsKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gRm9yIHNlY29uZCBvciBkZWVwZXIgbGV2ZWwgb2YgZmllbGRzLCBkZWZhdWx0IGxvYWRlciBzaG91bGQgYmUgdGhlIG9uZSB0byBkbyBsb2FkQWxsCiAgICAgICAgLy8gc2luY2Ugc2NoZW1hLCBkYXRhLCBvcHRpb25zIGFuZCB2aWV3IHNob3VsZCBoYXZlIGFscmVhZHkgYmVlbiBsb2FkZWQuCiAgICAgICAgLy8gVW5sZXNzIHdlIHdhbnQgdG8gbG9hZCBpbmRpdmlkdWFsIGZpZWxkcyAob3RoZXIgdGhhbiB0aGUgdGVtcGxhdGVzKSB1c2luZyB0aGUgcHJvdmlkZWQKICAgICAgICAvLyBsb2FkZXIsIHRoaXMgc2hvdWxkIGJlIGdvb2QgZW5vdWdoLiBUaGUgYmVuZWZpdCBpcyBzYXZpbmcgdGltZSBvbiBsb2FkZXIgZm9ybWF0IGNoZWNraW5nLgoKICAgICAgICB2YXIgbG9hZEFsbENvbm5lY3RvciA9IGNvbm5lY3RvcjsKCiAgICAgICAgaWYgKG5vdFRvcExldmVsKSB7CiAgICAgICAgICAgIHZhciBsb2FkQWxsQ29ubmVjdG9yQ2xhc3MgPSBBbHBhY2EuZ2V0Q29ubmVjdG9yQ2xhc3MoImRlZmF1bHQiKTsKICAgICAgICAgICAgbG9hZEFsbENvbm5lY3RvciA9IG5ldyBsb2FkQWxsQ29ubmVjdG9yQ2xhc3MoImRlZmF1bHQiKTsKICAgICAgICB9CgogICAgICAgIC8vIHdyYXAgcmVuZGVyZWQgY2FsbGJhY2sgdG8gYWxsb3cgZm9yIFVJIHRyZWF0bWVudCAoZG9tIGZvY3VzLCBldGMpCiAgICAgICAgaWYgKCFvcHRpb25zKSB7CiAgICAgICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgICB9CiAgICAgICAgaWYgKEFscGFjYS5pc1VuZGVmaW5lZChvcHRpb25zLmZvY3VzKSkgewogICAgICAgICAgICBvcHRpb25zLmZvY3VzID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHZhciBfcmVuZGVyZWRDYWxsYmFjayA9IGZ1bmN0aW9uKGNvbnRyb2wpCiAgICAgICAgewogICAgICAgICAgICAvLyBhdXRvLXNldCB0aGUgZm9jdXM/CiAgICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuZm9jdXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5mb2N1cyA9PT0gdHJ1ZSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBpY2sgZmlyc3QgZWxlbWVudCBpbiBmb3JtCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250cm9sLmNoaWxkcmVuICYmIGNvbnRyb2wuY2hpbGRyZW4ubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnRyb2wuY2hpbGRyZW5bMF0uZmllbGQgJiYgY29udHJvbC5jaGlsZHJlblswXS5maWVsZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2wuY2hpbGRyZW5bMF0uZmllbGQuZm9jdXMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBwaWNrIGEgbmFtZWQgY29udHJvbAogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBjb250cm9sLmdldENvbnRyb2xCeVBhdGgob3B0aW9ucy5mb2N1cyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZCAmJiBjaGlsZC5maWVsZCAmJiBjaGlsZC5maWVsZC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC5maWVsZC5mb2N1cygpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgMjUwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHJlbmRlcmVkQ2FsbGJhY2spCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJlbmRlcmVkQ2FsbGJhY2soY29udHJvbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBsb2FkQWxsQ29ubmVjdG9yLmxvYWRBbGwoewogICAgICAgICAgICAiZGF0YSI6IGRhdGEsCiAgICAgICAgICAgICJzY2hlbWEiOiBzY2hlbWEsCiAgICAgICAgICAgICJvcHRpb25zIjogb3B0aW9ucywKICAgICAgICAgICAgInZpZXciOiB2aWV3LAogICAgICAgICAgICAiZGF0YVNvdXJjZSI6IGRhdGFTb3VyY2UsCiAgICAgICAgICAgICJzY2hlbWFTb3VyY2UiOiBzY2hlbWFTb3VyY2UsCiAgICAgICAgICAgICJvcHRpb25zU291cmNlIjogb3B0aW9uc1NvdXJjZSwKICAgICAgICAgICAgInZpZXdTb3VyY2UiOiB2aWV3U291cmNlCiAgICAgICAgfSwgZnVuY3Rpb24obG9hZGVkRGF0YSwgbG9hZGVkT3B0aW9ucywgbG9hZGVkU2NoZW1hLCBsb2FkZWRWaWV3KSB7CgogICAgICAgICAgICAvLyBmb3IgY2FzZXMgd2hlcmUgdGhpbmdzIGNvdWxkIG5vdCBiZSBsb2FkZWQgdmlhIHNvdXJjZSBsb2FkZXJzLCBmYWxsIGJhY2sgdG8gd2hhdCBtYXkgaGF2ZSBiZWVuIHBhc3NlZAogICAgICAgICAgICAvLyBpbiBkaXJlY3RseSBhcyB2YWx1ZXMKCiAgICAgICAgICAgIGxvYWRlZERhdGEgPSBsb2FkZWREYXRhID8gbG9hZGVkRGF0YSA6IGRhdGE7CiAgICAgICAgICAgIGxvYWRlZFNjaGVtYSA9IGxvYWRlZFNjaGVtYSA/IGxvYWRlZFNjaGVtYTogc2NoZW1hOwogICAgICAgICAgICBsb2FkZWRPcHRpb25zID0gbG9hZGVkT3B0aW9ucyA/IGxvYWRlZE9wdGlvbnMgOiBvcHRpb25zOwogICAgICAgICAgICBsb2FkZWRWaWV3ID0gbG9hZGVkVmlldyA/IGxvYWRlZFZpZXcgOiB2aWV3OwoKICAgICAgICAgICAgLy8gc29tZSBkZWZhdWx0cyBmb3IgdGhlIGNhc2Ugd2hlcmUgZGF0YSBpcyBudWxsCiAgICAgICAgICAgIC8vIGlmIHNjaGVtYSArIG9wdGlvbnMgYXJlIG5vdCBwcm92aWRlZCwgd2UgYXNzdW1lIGEgdGV4dCBmaWVsZAoKICAgICAgICAgICAgaWYgKEFscGFjYS5pc0VtcHR5KGxvYWRlZERhdGEpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkobG9hZGVkU2NoZW1hKSAmJiAoQWxwYWNhLmlzRW1wdHkobG9hZGVkT3B0aW9ucykgfHwgQWxwYWNhLmlzRW1wdHkobG9hZGVkT3B0aW9ucy50eXBlKSkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbG9hZGVkRGF0YSA9ICIiOwoKICAgICAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkobG9hZGVkT3B0aW9ucykpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBsb2FkZWRPcHRpb25zID0gInRleHQiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChvcHRpb25zICYmIEFscGFjYS5pc09iamVjdChvcHRpb25zKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRlZE9wdGlvbnMudHlwZSA9ICJ0ZXh0IjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGluaXQgYWxwYWNhCiAgICAgICAgICAgIHJldHVybiBBbHBhY2EuaW5pdChlbCwgbG9hZGVkRGF0YSwgbG9hZGVkT3B0aW9ucywgbG9hZGVkU2NoZW1hLCBsb2FkZWRWaWV3LCBpbml0aWFsU2V0dGluZ3MsIGNhbGxiYWNrLCBfcmVuZGVyZWRDYWxsYmFjaywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrLCBpc0R5bmFtaWNDcmVhdGlvbik7CgogICAgICAgIH0sIGZ1bmN0aW9uIChsb2FkRXJyb3IpIHsKICAgICAgICAgICAgZXJyb3JDYWxsYmFjayhsb2FkRXJyb3IpOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9KTsKCiAgICAgICAgLy8gaGFuZCBiYWNrIHRoZSBmaWVsZAogICAgICAgIHJldHVybiAkKGVsKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZXNwYWNlIE5hbWVzcGFjZSBmb3IgYWxsIEFscGFjYSBGaWVsZCBDbGFzcyBJbXBsZW1lbnRhdGlvbnMuCiAgICAgKi8KICAgIEFscGFjYS5GaWVsZHMgPSB7IH07CgogICAgLyoqCiAgICAgKiBAbmFtZXNwYWNlIE5hbWVzcGFjZSBmb3IgYWxsIEFscGFjYSBDb25uZWN0b3IgQ2xhc3MgSW1wbGVtZW50YXRpb25zLgogICAgICovCiAgICBBbHBhY2EuQ29ubmVjdG9ycyA9IHsgfTsKCiAgICBBbHBhY2EuRXh0ZW5kID0gJC5leHRlbmQ7CgogICAgQWxwYWNhLkNyZWF0ZSA9IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgYXJncy51bnNoaWZ0KHt9KTsKCiAgICAgICAgcmV0dXJuICQuZXh0ZW5kLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfTsKCiAgICAvLyBzdGF0aWMgbWV0aG9kcyBhbmQgcHJvcGVydGllcwogICAgQWxwYWNhLkV4dGVuZChBbHBhY2EsCiAgICAvKiogQGxlbmRzIEFscGFjYSAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIFZlcnNpb24gbnVtYmVyLgogICAgICAgICAqLwogICAgICAgIFZFUlNJT046ICIwLjEuMCIsCgogICAgICAgIC8qKgogICAgICAgICAqIE1ha2VzIGFuIGFycmF5LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtBbnl9IG5vbkFycmF5IEEgbm9uLWFycmF5IHZhcmlhYmxlLgogICAgICAgICAqIEByZXR1cm5zIHtBcnJheX0gQXJyYXkgb3V0IG9mIHRoZSBub24tYXJyYXkgdmFyaWFibGUuCiAgICAgICAgICovCiAgICAgICAgbWFrZUFycmF5IDogZnVuY3Rpb24obm9uQXJyYXkpIHsKICAgICAgICAgICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKG5vbkFycmF5KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyB3aGV0aGVyIHRoZSB0eXBlIG9mIGEgdmFyaWFibGUgaXMgZnVuY3Rpb24uCiAgICAgICAgICogQHBhcmFtIHtBbnl9IG9iaiBUaGUgdmFyaWFibGUgYmVpbmcgZXZhbHVhdGVkLgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmIHRoZSB2YXJpYWJsZSBpcyBhIGZ1bmN0aW9uLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgaXNGdW5jdGlvbjogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSA9PT0gIltvYmplY3QgRnVuY3Rpb25dIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyB3aGV0aGVyIHRoZSB0eXBlIG9mIGEgdmFyaWFibGUgaXMgc3RyaW5nLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBvYmogVGhlIHZhcmlhYmxlIGJlaW5nIGV2YWx1YXRlZC4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZiB0aGUgdmFyaWFibGUgaXMgYSBzdHJpbmcsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgKi8KICAgICAgICBpc1N0cmluZzogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgICAgIHJldHVybiAodHlwZW9mIG9iaiA9PT0gInN0cmluZyIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEZpbmRzIHdoZXRoZXIgdGhlIHR5cGUgb2YgYSB2YXJpYWJsZSBpcyBvYmplY3QuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IG9iaiBUaGUgdmFyaWFibGUgYmVpbmcgZXZhbHVhdGVkLgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmIHRoZSB2YXJpYWJsZSBpcyBhbiBvYmplY3QsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgKi8KICAgICAgICBpc09iamVjdDogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgT2JqZWN0XSc7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogRmluZHMgd2hldGhlciB0aGUgdHlwZSBvZiBhIHZhcmlhYmxlIGlzIGEgcGxhaW4sIG5vbi1wcm90b3R5cGVkIG9iamVjdC4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gb2JqIFRoZSB2YXJpYWJsZSBiZWluZyBldmFsdWF0ZWQuCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgdGhlIHZhcmlhYmxlIGlzIGEgcGxhaW4gb2JqZWN0LCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgaXNQbGFpbk9iamVjdDogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgICAgIHJldHVybiAkLmlzUGxhaW5PYmplY3Qob2JqKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyB3aGV0aGVyIHRoZSB0eXBlIG9mIGEgdmFyaWFibGUgaXMgbnVtYmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBvYmogVGhlIHZhcmlhYmxlIGJlaW5nIGV2YWx1YXRlZC4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZiB0aGUgdmFyaWFibGUgaXMgYSBudW1iZXIsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgKi8KICAgICAgICBpc051bWJlcjogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgICAgIHJldHVybiAodHlwZW9mIG9iaiA9PT0gIm51bWJlciIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEZpbmRzIHdoZXRoZXIgdGhlIHR5cGUgb2YgYSB2YXJpYWJsZSBpcyBhcnJheS4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gb2JqIFRoZSB2YXJpYWJsZSBiZWluZyBldmFsdWF0ZWQuCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgdGhlIHZhcmlhYmxlIGlzIGFuIGFycmF5LCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgaXNBcnJheTogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgICAgIHJldHVybiBvYmogaW5zdGFuY2VvZiBBcnJheTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyB3aGV0aGVyIHRoZSB0eXBlIG9mIGEgdmFyaWFibGUgaXMgYm9vbGVhbi4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gb2JqIFRoZSB2YXJpYWJsZSBiZWluZyBldmFsdWF0ZWQuCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgdGhlIHZhcmlhYmxlIGlzIGEgYm9vbGVhbiwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIGlzQm9vbGVhbjogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgICAgIHJldHVybiAodHlwZW9mIG9iaiA9PT0gImJvb2xlYW4iKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyB3aGV0aGVyIHRoZSB0eXBlIG9mIGEgdmFyaWFibGUgaXMgdW5kZWZpbmVkLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBvYmogVGhlIHZhcmlhYmxlIGJlaW5nIGV2YWx1YXRlZC4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZiB0aGUgdmFyaWFibGUgaXMgYSB1bmRlZmluZWQsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgKi8KICAgICAgICBpc1VuZGVmaW5lZDogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgICAgIHJldHVybiAodHlwZW9mIG9iaiA9PT0gInVuZGVmaW5lZCIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFN0cmlwcyBhbnkgZXhjZXNzIHdoaXRlc3BhY2UgY2hhcmFjdGVycyBmcm9tIHRoZSBnaXZlbiB0ZXh0LgogICAgICAgICAqIFJldHVybnMgdGhlIHRyaW1tZWQgc3RyaW5nLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHN0cgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybiB0cmltbWVkIHN0cmluZwogICAgICAgICAqLwogICAgICAgIHRyaW06IGZ1bmN0aW9uKHRleHQpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdHJpbW1lZCA9IHRleHQ7CgogICAgICAgICAgICBpZiAodHJpbW1lZCAmJiBBbHBhY2EuaXNTdHJpbmcodHJpbW1lZCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRyaW1tZWQgPSB0cmltbWVkLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0cmltbWVkOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFByb3ZpZGVzIGEgc2FmZSBjb252ZXJzaW9uIG9mIGFuIEhUTUwgdGV4dHVhbCBzdHJpbmcgaW50byBhIERPTSBvYmplY3QuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0geAogICAgICAgICAqIEByZXR1cm4geyp9CiAgICAgICAgICovCiAgICAgICAgc2FmZURvbVBhcnNlOiBmdW5jdGlvbih4KQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHggJiYgQWxwYWNhLmlzU3RyaW5nKHgpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBDb3JyZWN0IGZvciB0aGUgZmFjdCB0aGF0IGpRdWVyeSA5IGlzIGEgYml0IHNlbnNpdGl2ZSB3aXRoIHJlc3BlY3QgdG8gc3RyaW5nIGNoYXJhY3RlcnMKICAgICAgICAgICAgICAgIC8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTQzNDc2MTEvanF1ZXJ5LTEtOS1jbGllbnQtc2lkZS10ZW1wbGF0ZS1zeW50YXgtZXJyb3ItdW5yZWNvZ25pemVkLWV4cHJlc3Npb24KICAgICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgICAvLyBlbnN1cmUgdGhhdCBodG1sIGRvZXNuJ3Qgc3RhcnQgd2l0aCBzcGFjZXMsIGNhcnJpYWdlIHJldHVybnMgb3IgYW55dGhpbmcgZXZpbAoKICAgICAgICAgICAgICAgIHggPSBBbHBhY2EudHJpbSh4KTsKCiAgICAgICAgICAgICAgICB2YXIgY29udmVydGVkID0gbnVsbDsKICAgICAgICAgICAgICAgIHRyeQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGNvbnZlcnRlZCA9ICQoeCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaCAoZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBtYWtlIGFub3RoZXIgYXR0ZW1wdCB0byBhY2NvdW50IGZvciBzYWZldHkgaW4gc29tZSBicm93c2VycwogICAgICAgICAgICAgICAgICAgIHggPSAiPGRpdj4iICsgeCArICI8L2Rpdj4iOwoKICAgICAgICAgICAgICAgICAgICBjb252ZXJ0ZWQgPSAkKHgpLmNoaWxkcmVuKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnZlcnRlZDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHg7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogRmluZHMgd2hldGhlciBhIHZhcmlhYmxlIGlzIGVtcHR5LgogICAgICAgICAqIEBwYXJhbSB7QW55fSBvYmogVGhlIHZhcmlhYmxlIGJlaW5nIGV2YWx1YXRlZC4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZiB0aGUgdmFyaWFibGUgaXMgZW1wdHksIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgKi8KICAgICAgICBpc0VtcHR5OiBmdW5jdGlvbihvYmopIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5pc1VuZGVmaW5lZChvYmopIHx8IG9iaiA9PT0gbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBQcm9kdWNlcyBhIGNvcHkgb2YgdGhlIGdpdmVuIEpTIHZhbHVlLgogICAgICAgICAqCiAgICAgICAgICogSWYgdGhlIHZhbHVlIGlzIGEgc2ltcGxlIGFycmF5IG9yIGEgc2ltcGxlIG9iamVjdCwgdGhlbiBhIHB1cmUgY29weSBpcyBwcm9kdWNlZC4KICAgICAgICAgKgogICAgICAgICAqIElmIGl0J3MgYSBjb21wbGV4IG9iamVjdCBvciBhIGZ1bmN0aW9uLCB0aGVuIHRoZSByZWZlcmVuY2UgaXMgY29waWVkIChpLmUuIG5vdCB0cnVseSBhIGNvcHkpLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHRoaW5nCiAgICAgICAgICogQHJldHVybiB7Kn0KICAgICAgICAgKi8KICAgICAgICBjb3B5T2Y6IGZ1bmN0aW9uKHRoaW5nKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGNvcHkgPSB0aGluZzsKCiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNBcnJheSh0aGluZykpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvcHkgPSBbXTsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaW5nLmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGNvcHkucHVzaChBbHBhY2EuY29weU9mKHRoaW5nW2ldKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoQWxwYWNhLmlzT2JqZWN0KHRoaW5nKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRoaW5nIGluc3RhbmNlb2YgRGF0ZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBkYXRlCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHRoaW5nLmdldFRpbWUoKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGluZyBpbnN0YW5jZW9mIFJlZ0V4cCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyByZWd1bGFyIGV4cHJlc3Npb24KICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFJlZ0V4cCh0aGluZyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGluZy5ub2RlVHlwZSAmJiAiY2xvbmVOb2RlIiBpbiB0aGluZykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBET00gbm9kZQogICAgICAgICAgICAgICAgICAgIGNvcHkgPSB0aGluZy5jbG9uZU5vZGUodHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmICgkLmlzUGxhaW5PYmplY3QodGhpbmcpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGNvcHkgPSB7fTsKCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayBpbiB0aGluZykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGluZy5oYXNPd25Qcm9wZXJ0eShrKSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29weVtrXSA9IEFscGFjYS5jb3B5T2YodGhpbmdba10pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIG90aGVyd2lzZSwgaXQncyBzb21lIG90aGVyIGtpbmQgb2Ygb2JqZWN0IHNvIHdlIGp1c3QgZG8gYSByZWZlcmVudGlhbCBjb3B5CiAgICAgICAgICAgICAgICAgICAgLy8gaW4gb3RoZXIgd29yZHMsIG5vdCBhIGNvcHkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGNvcHk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0YWluZWQgZm9yIGxlZ2FjeSBwdXJwb3Nlcy4gIEFsaWFzIGZvciBjb3B5T2YoKS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBvYmplY3QKICAgICAgICAgKiBAcmV0dXJucyB7Kn0KICAgICAgICAgKi8KICAgICAgICBjbG9uZU9iamVjdDogZnVuY3Rpb24ob2JqZWN0KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5jb3B5T2Yob2JqZWN0KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBTcGxpY2VzIGEgc3RyaW5nLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHNvdXJjZSBTb3VyY2Ugc3RyaW5nIHRvIGJlIHNwbGljZWQuCiAgICAgICAgICogQHBhcmFtIHtJbnRlZ2VyfSBzcGxpY2VQb2ludCBTcGxpY2UgbG9jYXRpb24uCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHNwbGljZSBTdHJpbmcgdG8gYmUgc3BsaWNlZCBpbi4KICAgICAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBTcGxpY2VkIHN0cmluZwogICAgICAgICAqLwogICAgICAgIHNwbGljZUluOiBmdW5jdGlvbihzb3VyY2UsIHNwbGljZVBvaW50LCBzcGxpY2UpIHsKICAgICAgICAgICAgcmV0dXJuIHNvdXJjZS5zdWJzdHJpbmcoMCwgc3BsaWNlUG9pbnQpICsgc3BsaWNlICsgc291cmNlLnN1YnN0cmluZyhzcGxpY2VQb2ludCwgc291cmNlLmxlbmd0aCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ29tcGFjdHMgYW4gYXJyYXkuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnIgU291cmNlIGFycmF5IHRvIGJlIGNvbXBhY3RlZC4KICAgICAgICAgKiBAcmV0dXJucyB7QXJyYXl9IENvbXBhY3RlZCBhcnJheS4KICAgICAgICAgKi8KICAgICAgICBjb21wYWN0QXJyYXk6IGZ1bmN0aW9uKGFycikgewogICAgICAgICAgICB2YXIgbiA9IFtdLCBsID0gYXJyLmxlbmd0aCxpOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoIWxhbmcuaXNOdWxsKGFycltpXSkgJiYgIWxhbmcuaXNVbmRlZmluZWQoYXJyW2ldKSkgewogICAgICAgICAgICAgICAgICAgIG4ucHVzaChhcnJbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJlbW92ZXMgYWNjZW50cyBmcm9tIGEgc3RyaW5nLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHN0ciBTb3VyY2Ugc3RyaW5nLgogICAgICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IENsZWFuZWQgc3RyaW5nIHdpdGhvdXQgYWNjZW50cy4KICAgICAgICAgKi8KICAgICAgICByZW1vdmVBY2NlbnRzOiBmdW5jdGlvbihzdHIpIHsKICAgICAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKC9bw6DDocOiw6PDpMOlXS9nLCAiYSIpLnJlcGxhY2UoL1vDqMOpw6rDq10vZywgImUiKS5yZXBsYWNlKC9bw6zDrcOuw69dL2csICJpIikucmVwbGFjZSgvW8Oyw7PDtMO1w7ZdL2csICJvIikucmVwbGFjZSgvW8O5w7rDu8O8XS9nLCAidSIpLnJlcGxhY2UoL1vDvcO/XS9nLCAieSIpLnJlcGxhY2UoL1vDsV0vZywgIm4iKS5yZXBsYWNlKC9bw6ddL2csICJjIikucmVwbGFjZSgvW8WTXS9nLCAib2UiKS5yZXBsYWNlKC9bw6ZdL2csICJhZSIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHBhcmFtIGVsCiAgICAgICAgICogQHBhcmFtIGFycgogICAgICAgICAqIEBwYXJhbSBmbgogICAgICAgICAqLwogICAgICAgIGluZGV4T2Y6IGZ1bmN0aW9uKGVsLCBhcnIsIGZuKSB7CiAgICAgICAgICAgIHZhciBsID0gYXJyLmxlbmd0aCxpOwoKICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNGdW5jdGlvbihmbikpIHsKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQGlnbm9yZQogICAgICAgICAgICAgICAgICogQHBhcmFtIGVsdAogICAgICAgICAgICAgICAgICogQHBhcmFtIGFyckVsdAogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmbiA9IGZ1bmN0aW9uKGVsdCwgYXJyRWx0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsdCA9PT0gYXJyRWx0OwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKGZuLmNhbGwoe30sIGVsLCBhcnJbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIFN0YXRpYyBjb3VudGVyIGZvciBnZW5lcmF0aW5nIGEgdW5pcXVlIElELgogICAgICAgICAqLwogICAgICAgIHVuaXF1ZUlkQ291bnRlcjogMCwKCiAgICAgICAgLyoqCiAgICAgICAgICogRGVmYXVsdCBMb2NhbGUuCiAgICAgICAgICovCiAgICAgICAgZGVmYXVsdExvY2FsZTogImVuX1VTIiwKCiAgICAgICAgLyoqCiAgICAgICAgICogU2V0cyB0aGUgZGVmYXVsdCBMb2NhbGUuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbG9jYWxlIE5ldyBkZWZhdWx0IGxvY2FsZS4KICAgICAgICAgKi8KICAgICAgICBzZXREZWZhdWx0TG9jYWxlOiBmdW5jdGlvbihsb2NhbGUpIHsKICAgICAgICAgICAgdGhpcy5kZWZhdWx0TG9jYWxlID0gbG9jYWxlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEZpZWxkIFR5cGUgdG8gU2NoZW1hIFR5cGUgTWFwcGluZ3MuCiAgICAgICAgICovCiAgICAgICAgZGVmYXVsdFNjaGVtYUZpZWxkTWFwcGluZzoge30sCgogICAgICAgIC8qKgogICAgICAgICAqIFJlZ2lzdGVycyBhIGZpZWxkIHR5cGUgdG8gc2NoZW1hIGRhdGEgdHlwZSBtYXBwaW5nLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHNjaGVtYVR5cGUgU2NoZW1hIGRhdGEgdHlwZS4KICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gZmllbGRUeXBlIEZpZWxkIHR5cGUuCiAgICAgICAgICovCiAgICAgICAgcmVnaXN0ZXJEZWZhdWx0U2NoZW1hRmllbGRNYXBwaW5nOiBmdW5jdGlvbihzY2hlbWFUeXBlLCBmaWVsZFR5cGUpIHsKICAgICAgICAgICAgaWYgKHNjaGVtYVR5cGUgJiYgZmllbGRUeXBlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRlZmF1bHRTY2hlbWFGaWVsZE1hcHBpbmdbc2NoZW1hVHlwZV0gPSBmaWVsZFR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaWVsZCBUeXBlIHRvIFNjaGVtYSBGb3JtYXQgTWFwcGluZ3MuCiAgICAgICAgICovCiAgICAgICAgZGVmYXVsdEZvcm1hdEZpZWxkTWFwcGluZzoge30sCgogICAgICAgIC8qKgogICAgICAgICAqIFJlZ2lzdGVycyBhIGZpZWxkIHR5cGUgdG8gc2NoZW1hIGZvcm1hdCBtYXBwaW5nLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGZvcm1hdCBTY2hlbWEgZm9ybWF0LgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBmaWVsZFR5cGUgRmllbGQgdHlwZS4KICAgICAgICAgKi8KICAgICAgICByZWdpc3RlckRlZmF1bHRGb3JtYXRGaWVsZE1hcHBpbmc6IGZ1bmN0aW9uKGZvcm1hdCwgZmllbGRUeXBlKSB7CiAgICAgICAgICAgIGlmIChmb3JtYXQgJiYgZmllbGRUeXBlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRlZmF1bHRGb3JtYXRGaWVsZE1hcHBpbmdbZm9ybWF0XSA9IGZpZWxkVHlwZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgc2NoZW1hIHR5cGUgb2YgYSB2YXJpYWJsZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIFRoZSB2YXJpYWJsZS4KICAgICAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBTY2hlbWEgdHlwZSBvZiB0aGUgdmFyaWFibGUuCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hVHlwZTogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgLy8gbWFwIGRhdGEgdHlwZXMgdG8gZGVmYXVsdCBmaWVsZCB0eXBlcwogICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkoZGF0YSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAic3RyaW5nIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoQWxwYWNhLmlzT2JqZWN0KGRhdGEpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIm9iamVjdCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKEFscGFjYS5pc1N0cmluZyhkYXRhKSkgewogICAgICAgICAgICAgICAgcmV0dXJuICJzdHJpbmciOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNOdW1iZXIoZGF0YSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAibnVtYmVyIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoQWxwYWNhLmlzQXJyYXkoZGF0YSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiYXJyYXkiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNCb29sZWFuKGRhdGEpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gImJvb2xlYW4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIExhc3QgY2hlY2sgZm9yIGRhdGEgdGhhdCBjYXJyaWVzIGZ1bmN0aW9ucyAtLSBHaXRhbmFDb25uZWN0b3IgY2FzZS4KICAgICAgICAgICAgaWYgKHR5cGVvZiBkYXRhID09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIm9iamVjdCI7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqCiAgICAgICAgICogQWxwYWNhIFZpZXdzLgogICAgICAgICAqLwogICAgICAgIHZpZXdzOiB7fSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKgogICAgICAgICAqIFZpZXcgSUQgUHJlZml4LgogICAgICAgICAqLwogICAgICAgIHZpZXdJZFByZWZpeDogIlZJRVdfIiwKCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaWRhdGVzIGEgdmlldyBpZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBpZCBWaWV3IGlkIGJlaW5nIHZhbGlkYXRlZC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmIHRoZSB2aWV3IGlkIGlzIHZhbGlkLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgaXNWYWxpZFZpZXdJZCA6IGZ1bmN0aW9uIChpZCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLnN0YXJ0c1dpdGgoaWQsIHRoaXMudmlld0lkUHJlZml4KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBHZW5lcmF0ZXMgYSB2YWxpZCB2aWV3IGlkLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge1N0cmluZ30gQSB2YWxpZCB1bmlxdWUgdmlldyBpZC4KICAgICAgICAgKi8KICAgICAgICBnZW5lcmF0ZVZpZXdJZCA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudmlld0lkUHJlZml4ICsgdGhpcy5nZW5lcmF0ZUlkKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVnaXN0ZXJzIGEgdmlldyB3aXRoIHRoZSBmcmFtZXdvcmsuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gdmlld09iamVjdAogICAgICAgICAqLwogICAgICAgIHJlZ2lzdGVyVmlldzogZnVuY3Rpb24odmlld09iamVjdCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBpZCA9IHZpZXdPYmplY3QuaWQ7CgogICAgICAgICAgICBpZiAoIWlkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gQWxwYWNhLnRocm93RGVmYXVsdEVycm9yKCJDYW5ub3QgcmVnaXN0ZXIgdmlldyB3aXRoIG1pc3NpbmcgdmlldyBpZDogIiArIGlkKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGV4aXN0aW5nVmlldyA9IHRoaXMudmlld3NbaWRdOwogICAgICAgICAgICBpZiAoZXhpc3RpbmdWaWV3KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBBbHBhY2EubWVyZ2VPYmplY3QoZXhpc3RpbmdWaWV3LCB2aWV3T2JqZWN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMudmlld3NbaWRdID0gdmlld09iamVjdDsKICAgICAgICAgICAgfQoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBEZWZhdWx0IHZpZXcuCiAgICAgICAgICovCiAgICAgICAgZGVmYXVsdFZpZXcgOiAiVklFV19XRUJfRURJVCIsCgogICAgICAgIC8qKgogICAgICAgICAqIFNldHMgZGVmYXVsdCB2aWV3IGFzIHRoZSB2aWV3IHdpdGggYSBnaXZlbiBpZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBJZCBvZiB0aGUgdmlldyBiZWluZyBzZXQgYXMgZGVmYXVsdC4KICAgICAgICAgKi8KICAgICAgICBzZXREZWZhdWx0VmlldzogZnVuY3Rpb24odmlld0lkKSB7CiAgICAgICAgICAgIGlmICh2aWV3SWQgJiYgdGhpcy52aWV3cy5oYXNPd25Qcm9wZXJ0eSh2aWV3SWQpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRlZmF1bHRWaWV3ID0gdmlld0lkOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0cmlldmVzIGEgbm9ybWFsaXplZCB2aWV3IGJ5IHZpZXcgaWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gdmlld0lkCiAgICAgICAgICogQHJldHVybiB7Kn0KICAgICAgICAgKi8KICAgICAgICBnZXROb3JtYWxpemVkVmlldzogZnVuY3Rpb24odmlld0lkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplZFZpZXdzW3ZpZXdJZF07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVzb2x2ZXMgd2hpY2ggdmlldyBoYW5kbGVzIGEgZ2l2ZW4gdGhlbWUgYW5kIHR5cGUgb2Ygb3BlcmF0aW9uLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHVpCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUKICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IHRoZSB2aWV3IGlkCiAgICAgICAgICovCiAgICAgICAgbG9va3VwTm9ybWFsaXplZFZpZXc6IGZ1bmN0aW9uKHVpLCB0eXBlKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRoZVZpZXdJZCA9IG51bGw7CgogICAgICAgICAgICBmb3IgKHZhciB2aWV3SWQgaW4gdGhpcy5ub3JtYWxpemVkVmlld3MpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB2aWV3ID0gdGhpcy5ub3JtYWxpemVkVmlld3Nbdmlld0lkXTsKCiAgICAgICAgICAgICAgICBpZiAodmlldy51aSA9PSB1aSAmJiB2aWV3LnR5cGUgPT0gdHlwZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGVWaWV3SWQgPSB2aWV3SWQ7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGVWaWV3SWQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVnaXN0ZXJzIGEgdGVtcGxhdGUgdG8gYSB2aWV3LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHRlbXBsYXRlSWQgVGVtcGxhdGUgaWQuCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd8T2JqZWN0fSB0ZW1wbGF0ZSBFaXRoZXIgdGhlIHRleHQgb2YgdGhlIHRlbXBsYXRlIG9yIGFuIG9iamVjdCBjb250YWluaW5nIHsgInR5cGUiOiAiPHRlbXBsYXRlRW5naW5lSWRlbnRpZmllcj4iLCAidGVtcGxhdGUiOiAiPG1hcmt1cD4iIH0KICAgICAgICAgKiBAcGFyYW0gW1N0cmluZ10gdmlld0lkIHRoZSBvcHRpb25hbCB2aWV3IGlkLiAgSWYgbm9uZSBpcyBwcm92aWRlZCwgdGhlbiBhbGwgcmVnaXN0cmF0aW9ucyBhcmUgdG8gdGhlIGRlZmF1bHQgdmlldy4KICAgICAgICAgKi8KICAgICAgICByZWdpc3RlclRlbXBsYXRlOiBmdW5jdGlvbih0ZW1wbGF0ZUlkLCB0ZW1wbGF0ZSwgdmlld0lkKQogICAgICAgIHsKICAgICAgICAgICAgLy8gaWYgbm8gdmlldyBzcGVjaWZpZWQsIGZhbGwgYmFjayB0byB0aGUgYmFzZSB2aWV3IHdoaWNoIGlzICJWSUVXX0JBU0UiCiAgICAgICAgICAgIGlmICghdmlld0lkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2aWV3SWQgPSAiVklFV19CQVNFIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0aGlzLnZpZXdzW3ZpZXdJZF0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMudmlld3Nbdmlld0lkXSA9IHt9OwogICAgICAgICAgICAgICAgdGhpcy52aWV3c1t2aWV3SWRdLmlkID0gdmlld0lkOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXRoaXMudmlld3Nbdmlld0lkXS50ZW1wbGF0ZXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMudmlld3Nbdmlld0lkXS50ZW1wbGF0ZXMgPSB7fTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy52aWV3c1t2aWV3SWRdLnRlbXBsYXRlc1t0ZW1wbGF0ZUlkXSA9IHRlbXBsYXRlOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZWdpc3RlcnMgbGlzdCBvZiB0ZW1wbGF0ZXMgdG8gYSB2aWV3LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtBcnJheX0gdGVtcGxhdGVzIFRlbXBsYXRlcyBiZWluZyByZWdpc3RlcmVkCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHZpZXdJZCBJZCBvZiB0aGUgdmlldyB0aGF0IHRoZSB0ZW1wbGF0ZXMgYmVpbmcgcmVnaXN0ZXJlZCB0by4KICAgICAgICAgKi8KICAgICAgICByZWdpc3RlclRlbXBsYXRlczogZnVuY3Rpb24odGVtcGxhdGVzLCB2aWV3SWQpIHsKICAgICAgICAgICAgZm9yICh2YXIgdGVtcGxhdGVJZCBpbiB0ZW1wbGF0ZXMpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVnaXN0ZXJUZW1wbGF0ZSh0ZW1wbGF0ZUlkLCB0ZW1wbGF0ZXNbdGVtcGxhdGVJZF0sIHZpZXdJZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZWdpc3RlcnMgYSBtZXNzYWdlIHRvIGEgdmlldy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBtZXNzYWdlSWQgSWQgb2YgdGhlIG1lc3NhZ2UgYmVpbmcgcmVnaXN0ZXJlZC4KICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZSBNZXNzYWdlIHRvIGJlIHJlZ2lzdGVyZWQKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdmlld0lkIElkIG9mIHRoZSB2aWV3IHRoYXQgdGhlIG1lc3NhZ2UgYmVpbmcgcmVnaXN0ZXJlZCB0by4KICAgICAgICAgKi8KICAgICAgICByZWdpc3Rlck1lc3NhZ2U6IGZ1bmN0aW9uKG1lc3NhZ2VJZCwgbWVzc2FnZSwgdmlld0lkKQogICAgICAgIHsKICAgICAgICAgICAgLy8gaWYgbm8gdmlldyBzcGVjaWZpZWQsIGZhbGwgYmFjayB0byB0aGUgYmFzZSB2aWV3IHdoaWNoIGlzICJWSUVXX0JBU0UiCiAgICAgICAgICAgIGlmICghdmlld0lkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2aWV3SWQgPSAiVklFV19CQVNFIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0aGlzLnZpZXdzW3ZpZXdJZF0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMudmlld3Nbdmlld0lkXSA9IHt9OwogICAgICAgICAgICAgICAgdGhpcy52aWV3c1t2aWV3SWRdLmlkID0gdmlld0lkOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXRoaXMudmlld3Nbdmlld0lkXS5tZXNzYWdlcykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy52aWV3c1t2aWV3SWRdLm1lc3NhZ2VzID0ge307CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudmlld3Nbdmlld0lkXS5tZXNzYWdlc1ttZXNzYWdlSWRdID0gbWVzc2FnZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZWdpc3RlcnMgbWVzc2FnZXMgd2l0aCBhIHZpZXcuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0FycmF5fSBtZXNzYWdlcyBNZXNzYWdlcyB0byBiZSByZWdpc3RlcmVkLgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB2aWV3SWQgSWQgb2YgdGhlIHZpZXcgdGhhdCB0aGUgbWVzc2FnZXMgYmVpbmcgcmVnaXN0ZXJlZCB0by4KICAgICAgICAgKi8KICAgICAgICByZWdpc3Rlck1lc3NhZ2VzOiBmdW5jdGlvbihtZXNzYWdlcywgdmlld0lkKSB7CiAgICAgICAgICAgIGZvciAodmFyIG1lc3NhZ2VJZCBpbiBtZXNzYWdlcykgewogICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2VzLmhhc093blByb3BlcnR5KG1lc3NhZ2VJZCkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlZ2lzdGVyTWVzc2FnZShtZXNzYWdlSWQsIG1lc3NhZ2VzW21lc3NhZ2VJZF0sIHZpZXdJZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKCgoKCgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIC8vCiAgICAgICAgLy8gU1RBVElDIEhFTFBFUiBNRVRIT0RTIChDQUxMRUQgRlJPTSBXSVRISU4gVEVNUExBVEVTKQogICAgICAgIC8vCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogRGVmYXVsdCBNYXBwaW5ncyBmb3IgRmllbGQgTGV2ZWwgVGVtcGxhdGVzLgogICAgICAgICAqLwogICAgICAgIGZpZWxkVGVtcGxhdGVQb3N0Zml4OiB7CiAgICAgICAgICAgICJjb250cm9sRmllbGRNZXNzYWdlQ29udGFpbmVyIiA6ICItY29udHJvbGZpZWxkLW1lc3NhZ2UtY29udGFpbmVyIiwKICAgICAgICAgICAgImNvbnRyb2xGaWVsZExhYmVsIiA6ICItY29udHJvbGZpZWxkLWxhYmVsIiwKICAgICAgICAgICAgImNvbnRyb2xGaWVsZENvbnRhaW5lciI6Ii1jb250cm9sZmllbGQtY29udGFpbmVyIiwKICAgICAgICAgICAgImNvbnRyb2xGaWVsZEhlbHBlciI6Ii1jb250cm9sZmllbGQtaGVscGVyIiwKICAgICAgICAgICAgLyoKICAgICAgICAgICAgICJjb250cm9sRmllbGRPdXRlckVsIjoiLWNvbnRyb2xmaWVsZCIsCiAgICAgICAgICAgICAqLwogICAgICAgICAgICAiZmllbGRTZXRMZWdlbmQiIDogIi1maWVsZHNldC1sZWdlbmQiLAogICAgICAgICAgICAiZmllbGRTZXRJdGVtc0NvbnRhaW5lciI6Ii1maWVsZHNldC1pdGVtcy1jb250YWluZXIiLAogICAgICAgICAgICAiZmllbGRTZXRIZWxwZXIiOiItZmllbGRzZXQtaGVscGVyIiwKICAgICAgICAgICAgImZpZWxkU2V0T3V0ZXJFbCI6Ii1maWVsZHNldCIsCiAgICAgICAgICAgICJmb3JtQnV0dG9uc0NvbnRhaW5lciI6Ii1mb3JtLWJ1dHRvbnMtY29udGFpbmVyIiwKICAgICAgICAgICAgImZvcm1GaWVsZHNDb250YWluZXIiOiItZm9ybS1maWVsZHMtY29udGFpbmVyIgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogUHJvY2Vzc2VzIGZpZWxkIGxldmVsIHRlbXBsYXRlLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG9iamVjdCBPYmplY3QgdGhhdCB0aGUgdGVtcGxhdGUgaXMgYXBwbGllZCB0by4KICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBUZW1wbGF0ZSBpZC4KICAgICAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IHdyYXAgVHJ1ZSBpZiB3ZSB3YW50IHRoZSB0ZW1wbGF0ZSBhcyBhIHdyYXBwZXIsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IE9iamVjdCByZW5kZXJlZCBieSBmaWVsZCBsZXZlbCB0ZW1wbGF0ZS4KICAgICAgICAgKi8KICAgICAgICBmaWVsZFRlbXBsYXRlOiBmdW5jdGlvbihvYmplY3QsIG5hbWUsIHdyYXApIHsKCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICB2YXIgZmllbGQgPSBvYmplY3QuZGF0YTsKICAgICAgICAgICAgdmFyIHZpZXcgPSBvYmplY3QuZGF0YS52aWV3OwoKICAgICAgICAgICAgdmFyIGh0bWwgPSAiIjsKCiAgICAgICAgICAgIGlmICghbmFtZSkKICAgICAgICAgICAgICAgIG5hbWUgPSAiY29udHJvbEZpZWxkTGFiZWwiOwoKICAgICAgICAgICAgLy8gZGV0ZXJtaW5lIHdoaWNoIGNvbXBpbGVkIHRlbXBsYXRlIHRvIHVzZSBmb3IgdGhpcyB0ZW1wbGF0ZSBuYW1lCiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZURlc2NyaXB0b3IgPSB0aGlzLmdldFRlbXBsYXRlRGVzY3JpcHRvcih2aWV3LCBuYW1lLCBmaWVsZCk7CiAgICAgICAgICAgIGlmICh3cmFwKSB7CgogICAgICAgICAgICAgICAgLy8gZm9yIHdyYXBwaW5nLCB3ZSBnZXQgdGhlIGh0bWwgc291cmNlIGFuZCBoYW5kIGl0IGJhY2sKICAgICAgICAgICAgICAgIC8vIGZpcnN0IHdlIGFwcGx5IGFueSBhdHRyIGFuZCBjbGFzc2VzIHdlIG5lZWQKCiAgICAgICAgICAgICAgICAvLyBnZXQgdGhlIGh0bWwgc291cmNlCiAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSB0ZW1wbGF0ZURlc2NyaXB0b3IudGVtcGxhdGUudmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoJCgnLmFscGFjYScgKyB0aGlzLmZpZWxkVGVtcGxhdGVQb3N0Zml4W25hbWVdLCBBbHBhY2Euc2FmZURvbVBhcnNlKHRlbXBsYXRlKSkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZmllbGRUZW1wbGF0ZVBvc3RmaXhbbmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUgPSBBbHBhY2Euc2FmZURvbVBhcnNlKHRlbXBsYXRlKS5hZGRDbGFzcygiYWxwYWNhIiArIHRoaXMuZmllbGRUZW1wbGF0ZVBvc3RmaXhbbmFtZV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGh0bWwgPSBBbHBhY2Euc2FmZURvbVBhcnNlKHRlbXBsYXRlKS5vdXRlckhUTUwodHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBmb3Igbm9uLXdyYXBwZWQsIHdlIGV4ZWN1dGUgdGhlIHRlbXBsYXRlIHN0cmFpZ2h0IGF3YXkKCiAgICAgICAgICAgICAgICB2YXIgbGFiZWwgPSB2aWV3LnRtcGwodGVtcGxhdGVEZXNjcmlwdG9yLCBvYmplY3QuZGF0YSk7CiAgICAgICAgICAgICAgICBpZiAobGFiZWwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5maWVsZFRlbXBsYXRlUG9zdGZpeFtuYW1lXSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJCgnLmFscGFjYScgKyB0aGlzLmZpZWxkVGVtcGxhdGVQb3N0Zml4W25hbWVdLCBsYWJlbCkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbC5hZGRDbGFzcygiYWxwYWNhIiArIHRoaXMuZmllbGRUZW1wbGF0ZVBvc3RmaXhbbmFtZV0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbGFiZWwuYXR0cigiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWwuYXR0cigiaWQiLCBvYmplY3QuZGF0YS5pZCArIHRoaXMuZmllbGRUZW1wbGF0ZVBvc3RmaXhbbmFtZV0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGh0bWwgPSBsYWJlbC5vdXRlckhUTUwodHJ1ZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGh0bWwgPSAiIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGh0bWw7CiAgICAgICAgfSwKCgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIC8vCiAgICAgICAgLy8gRU5EIE9GIFNUQVRJQyBIRUxQRVIgTUVUSE9EUwogICAgICAgIC8vCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgoKCiAgICAgICAgLyoqCiAgICAgICAgICogRGVmYXVsdCBkYXRlIGZvcm1hdC4KICAgICAgICAgKi8KICAgICAgICBkZWZhdWx0RGF0ZUZvcm1hdDogIm1tL2RkL3l5IiwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVndWxhciBleHByZXNzaW9ucyBmb3IgZmllbGRzLgogICAgICAgICAqLwogICAgICAgIHJlZ2V4cHM6CiAgICAgICAgewogICAgICAgICAgICAiZW1haWwiOiAvXlthLXowLTkhXCNcJCUmJ1wqXC1cLz1cP1wrXC1cXl9gXHtcfFx9fl0rKD86XC5bYS16MC05IVwjXCQlJidcKlwtXC89XD9cK1wtXF5fYFx7XHxcfX5dKykqQCg/OlthLXowLTldKD86W2EtejAtOS1dKlthLXowLTldKT9cLikrW2Etel17Miw2fSQvaSwKICAgICAgICAgICAgInVybCI6IC9eKGh0dHB8aHR0cHMpOlwvXC9bYS16MC05XSsoW1wtXC5dezF9W2EtejAtOV0rKSpcLlthLXpdezIsNX0oXDpbMC05XXsxLDV9KT8oKFswLTldezEsNX0pP1wvLiopPyQvaSwKICAgICAgICAgICAgInBhc3N3b3JkIjogL15bMC05YS16QS1aXHgyMC1ceDdFXSokLywKICAgICAgICAgICAgImRhdGUiOiAvXigwWzEtOV18MVswMTJdKVstIC8uXSgwWzEtOV18WzEyXVswLTldfDNbMDFdKVstIC8uXVxkXGQkLywKICAgICAgICAgICAgImludGVnZXIiOiAvXihbXCtcLV0/KFsxLTldXGQqKXwwKSQvLAogICAgICAgICAgICAibnVtYmVyIjovXihbXCtcLV0/KCgoWzAtOV0rKFwuKT8pfChbMC05XSpcLlswLTldKykpKFtlRV1bKy1dP1swLTldKyk/KSkkLywKICAgICAgICAgICAgInBob25lIjovXihcRD8oXGR7M30pXEQ/XEQ/KFxkezN9KVxEPyhcZHs0fSkpPyQvLAogICAgICAgICAgICAiaXB2NCI6L14oPzoxXGQ/XGQ/fDIoPzpbMC00XVxkP3xbNjc4OV18NVswLTVdPyk/fFszLTldXGQ/fDApKD86XC4oPzoxXGQ/XGQ/fDIoPzpbMC00XVxkP3xbNjc4OV18NVswLTVdPyk/fFszLTldXGQ/fDApKXszfSQvLAogICAgICAgICAgICAiemlwY29kZS1maXZlIjogL14oXGR7NX0pPyQvLAogICAgICAgICAgICAiemlwY29kZS1uaW5lIjogL14oXGR7NX0oLVxkezR9KT8pPyQvCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogTWFwIG9mIGluc3RhbnRpYXRlZCBmaWVsZHMuCiAgICAgICAgICovCiAgICAgICAgZmllbGRJbnN0YW5jZXM6IHt9LAoKICAgICAgICAvKioKICAgICAgICAgKiBNYXBzIG9mIGZpZWxkIHR5cGVzIHRvIGZpZWxkIGNsYXNzIGltcGxlbWVudGF0aW9ucy4KICAgICAgICAgKi8KICAgICAgICBmaWVsZENsYXNzUmVnaXN0cnk6IHt9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZWdpc3RlcnMgYW4gaW1wbGVtZW50YXRpb24gY2xhc3MgZm9yIGEgdHlwZSBvZiBmaWVsZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIEZpZWxkIHR5cGUuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuRmllbGR9IGZpZWxkQ2xhc3MgRmllbGQgY2xhc3MuCiAgICAgICAgICovCiAgICAgICAgcmVnaXN0ZXJGaWVsZENsYXNzOiBmdW5jdGlvbih0eXBlLCBmaWVsZENsYXNzKSB7CiAgICAgICAgICAgIHRoaXMuZmllbGRDbGFzc1JlZ2lzdHJ5W3R5cGVdID0gZmllbGRDbGFzczsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIHRoZSBpbXBsZW1lbnRhdGlvbiBjbGFzcyBmb3IgYSB0eXBlIG9mIGZpZWxkLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUgRmllbGQgdHlwZS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtBbHBhY2EuRmllbGR9IEZpZWxkIGNsYXNzIG1hcHBlZCB0byBmaWVsZCB0eXBlLgogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkQ2xhc3M6IGZ1bmN0aW9uKHR5cGUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmllbGRDbGFzc1JlZ2lzdHJ5W3R5cGVdOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGZpZWxkIHR5cGUgaWQgZm9yIGEgZ2l2ZW4gZmllbGQgaW1wbGVtZW50YXRpb24gY2xhc3MuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5GaWVsZH0gZmllbGRDbGFzcyBGaWVsZCBjbGFzcy4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IEZpZWxkIHR5cGUgb2YgdGhlIGZpZWxkIGNsYXNzLgogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkQ2xhc3NUeXBlOiBmdW5jdGlvbihmaWVsZENsYXNzKSB7CiAgICAgICAgICAgIGZvciAodmFyIHR5cGUgaW4gdGhpcy5maWVsZENsYXNzUmVnaXN0cnkpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkQ2xhc3NSZWdpc3RyeS5oYXNPd25Qcm9wZXJ0eSh0eXBlKSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkQ2xhc3NSZWdpc3RyeVt0eXBlXSA9PSBmaWVsZENsYXNzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBNYXBzIG9mIGNvbm5lY3RvciB0eXBlcyB0byBjb25uZWN0b3IgY2xhc3MgaW1wbGVtZW50YXRpb25zLgogICAgICAgICAqLwogICAgICAgIGNvbm5lY3RvckNsYXNzUmVnaXN0cnk6IHt9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZWdpc3RlcnMgYW4gaW1wbGVtZW50YXRpb24gY2xhc3MgZm9yIGEgY29ubmVjdG9yIHR5cGUuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBjQ29ubmVjdCB0eXBlCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3JDbGFzcyBDb25uZWN0b3IgY2xhc3MuCiAgICAgICAgICovCiAgICAgICAgcmVnaXN0ZXJDb25uZWN0b3JDbGFzczogZnVuY3Rpb24odHlwZSwgY29ubmVjdG9yQ2xhc3MpIHsKICAgICAgICAgICAgdGhpcy5jb25uZWN0b3JDbGFzc1JlZ2lzdHJ5W3R5cGVdID0gY29ubmVjdG9yQ2xhc3M7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGUgaW1wbGVtZW50YXRpb24gY2xhc3MgZm9yIGEgY29ubmVjdG9yIHR5cGUuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBDb25uZWN0IHR5cGUuCiAgICAgICAgICogQHJldHVybnMge0FscGFjYS5Db25uZWN0b3J9IENvbm5lY3RvciBjbGFzcyBtYXBwZWQgdG8gY29ubmVjdCB0eXBlLgogICAgICAgICAqLwogICAgICAgIGdldENvbm5lY3RvckNsYXNzOiBmdW5jdGlvbih0eXBlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbm5lY3RvckNsYXNzUmVnaXN0cnlbdHlwZV07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVwbGFjZXMgZWFjaCBzdWJzdHJpbmcgb2YgdGhpcyBzdHJpbmcgdGhhdCBtYXRjaGVzIHRoZSBnaXZlbiByZWd1bGFyIGV4cHJlc3Npb24gd2l0aCB0aGUgZ2l2ZW4gcmVwbGFjZW1lbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdGV4dCBTb3VyY2Ugc3RyaW5nIGJlaW5nIHJlcGxhY2VkLgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSByZXBsYWNlIFJlZ3VsYXIgZXhwcmVzc2lvbiBmb3IgcmVwbGFjaW5nLgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB3aXRoX3RoaXMgUmVwbGFjZW1lbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXBsYWNlZCBzdHJpbmcuCiAgICAgICAgICovCiAgICAgICAgcmVwbGFjZUFsbDogZnVuY3Rpb24odGV4dCwgcmVwbGFjZSwgd2l0aF90aGlzKSB7CiAgICAgICAgICAgIHJldHVybiB0ZXh0LnJlcGxhY2UobmV3IFJlZ0V4cChyZXBsYWNlLCAnZycpLCB3aXRoX3RoaXMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENyZWF0ZXMgYW4gZWxlbWVudCB3aXRoIGEgZ2l2ZW4gdGFnIG5hbWUsIGRvbS9zdHlsZSBhdHRyaWJ1dGVzIGFuZCBjbGFzcyBuYW1lcy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0YWcgVGFnIG5hbWUuCiAgICAgICAgICogQHBhcmFtIHtBcnJheX0gZG9tQXR0cmlidXRlcyBET00gYXR0cmlidXRlcy4KICAgICAgICAgKiBAcGFyYW0ge0FycmF5fSBzdHlsZUF0dHJpYnV0ZXMgU3R5bGUgYXR0cmlidXRlcy4KICAgICAgICAgKiBAcGFyYW0ge0FycmF5fSBjbGFzc05hbWVzIENsYXNzIG5hbWVzLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gTmV3IGVsZW1lbnQgd2l0aCB0aGUgdGFnIG5hbWUgYW5kIGFsbCBvdGhlciBwcm92aWRlZCBhdHRyaWJ1dGVzLgogICAgICAgICAqLwogICAgICAgIGVsZW1lbnQ6IGZ1bmN0aW9uKHRhZywgZG9tQXR0cmlidXRlcywgc3R5bGVBdHRyaWJ1dGVzLCBjbGFzc05hbWVzKSB7CiAgICAgICAgICAgIHZhciBlbCA9ICQoIjwiICsgdGFnICsgIi8+Iik7CgogICAgICAgICAgICBpZiAoZG9tQXR0cmlidXRlcykgewogICAgICAgICAgICAgICAgZWwuYXR0cihkb21BdHRyaWJ1dGVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3R5bGVBdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgICAgICBlbC5jc3Moc3R5bGVBdHRyaWJ1dGVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2xhc3NOYW1lcykgewogICAgICAgICAgICAgICAgZm9yICh2YXIgY2xhc3NOYW1lIGluIGNsYXNzTmFtZXMpIHsKICAgICAgICAgICAgICAgICAgICBlbC5hZGRDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVwbGFjZXMgYSB0ZW1wbGF0ZSB3aXRoIGxpc3Qgb2YgcmVwbGFjZW1lbnRzLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHRlbXBsYXRlIFRlbXBsYXRlIGJlaW5nIHByb2Nlc3NlZC4KICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gc3Vic3RpdHV0aW9ucyBMaXN0IG9mIHN1YnN0aXR1dGlvbnMuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXBsYWNlZCB0ZW1wbGF0ZS4KICAgICAgICAgKi8KICAgICAgICBlbGVtZW50RnJvbVRlbXBsYXRlOiBmdW5jdGlvbih0ZW1wbGF0ZSwgc3Vic3RpdHV0aW9ucykgewogICAgICAgICAgICB2YXIgaHRtbCA9IHRlbXBsYXRlOwogICAgICAgICAgICBpZiAoc3Vic3RpdHV0aW9ucykgewogICAgICAgICAgICAgICAgZm9yICh2YXIgeCBpbiBzdWJzdGl0dXRpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgaHRtbCA9IEFscGFjYS5yZXBsYWNlQWxsKGh0bWwsICIkeyIgKyB4ICsgIn0iLCBzdWJzdGl0dXRpb25zW3hdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gJChodG1sKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBHZW5lcmF0ZXMgYSB1bmlxdWUgYWxwYWNhIGlkLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge1N0cmluZ30gVGhlIHVuaXF1ZSBhbHBhY2EgaWQuCiAgICAgICAgICovCiAgICAgICAgZ2VuZXJhdGVJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIEFscGFjYS51bmlxdWVJZENvdW50ZXIrKzsKICAgICAgICAgICAgcmV0dXJuICJhbHBhY2EiICsgQWxwYWNhLnVuaXF1ZUlkQ291bnRlcjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEhlbHBlciBmdW5jdGlvbiB0byBwcm92aWRlIFlBSE9PIGxhdGVyIGxpa2UgY2FwYWJpbGl0aWVzLgogICAgICAgICAqLwogICAgICAgIGxhdGVyOiBmdW5jdGlvbih3aGVuLCBvLCBmbiwgZGF0YSwgcGVyaW9kaWMpIHsKICAgICAgICAgICAgd2hlbiA9IHdoZW4gfHwgMDsKICAgICAgICAgICAgbyA9IG8gfHwge307CiAgICAgICAgICAgIHZhciBtID0gZm4sIGQgPSAkLm1ha2VBcnJheShkYXRhKSwgZiwgcjsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICBtID0gb1tmbl07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghbSkgewogICAgICAgICAgICAgICAgLy8gVGhyb3cgYW4gZXJyb3IgYWJvdXQgdGhlIG1ldGhvZAogICAgICAgICAgICAgICAgdGhyb3cgewogICAgICAgICAgICAgICAgICAgIG5hbWU6ICdUeXBlRXJyb3InLAogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICJUaGUgZnVuY3Rpb24gaXMgdW5kZWZpbmVkLiIKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAaWdub3JlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBmID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBtLmFwcGx5KG8sIGQpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgciA9IChwZXJpb2RpYykgPyBzZXRJbnRlcnZhbChmLCB3aGVuKSA6IHNldFRpbWVvdXQoZiwgd2hlbik7CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgaWQ6IHIsCiAgICAgICAgICAgICAgICBpbnRlcnZhbDogcGVyaW9kaWMsCiAgICAgICAgICAgICAgICBjYW5jZWw6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmludGVydmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwocik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyBpZiBhbiBzdHJpbmcgZW5kcyB3aXRoIGEgZ2l2ZW4gc3VmZml4LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHRleHQgVGhlIHN0cmluZyBiZWluZyBldmFsdWF0ZWQuCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHN1ZmZpeCBTdWZmaXguCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgdGhlIHN0cmluZyBlbmRzIHdpdGggdGhlIGdpdmVuIHN1ZmZpeCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIGVuZHNXaXRoIDogZnVuY3Rpb24odGV4dCwgc3VmZml4KSB7CiAgICAgICAgICAgIHJldHVybiB0ZXh0LmluZGV4T2Yoc3VmZml4LCB0ZXh0Lmxlbmd0aCAtIHN1ZmZpeC5sZW5ndGgpICE9PSAtMTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyBpZiBhbiBzdHJpbmcgc3RhcnRzIHdpdGggYSBnaXZlbiBwcmVmaXguCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdGV4dCBUaGUgc3RyaW5nIGJlaW5nIGV2YWx1YXRlZC4KICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gcHJlZml4IFByZWZpeAogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmIHRoZSBzdHJpbmcgc3RhcnRzIHdpdGggdGhlIGdpdmVuIHByZWZpeCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIHN0YXJ0c1dpdGggOiBmdW5jdGlvbih0ZXh0LCBwcmVmaXgpIHsKICAgICAgICAgICAgLy9yZXR1cm4gKHRleHQubWF0Y2goIl4iICsgcHJlZml4KSA9PSBwcmVmaXgpOwogICAgICAgICAgICByZXR1cm4gdGV4dC5zdWJzdHIoMCwgcHJlZml4Lmxlbmd0aCkgPT09IHByZWZpeDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyBpZiBhIHZhcmlhYmxlIGlzIGEgVVJJLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9iaiBUaGUgdmFyaWFibGUgYmVpbmcgZXZhbHVhdGVkLgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmIHRoZSB2YXJpYWJsZSBpcyBhIFVSSSwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIGlzVXJpIDogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EuaXNTdHJpbmcob2JqKSAmJiAoQWxwYWNhLnN0YXJ0c1dpdGgob2JqLCAiaHR0cDovLyIpIHx8CiAgICAgICAgICAgICAgICAgICAgQWxwYWNhLnN0YXJ0c1dpdGgob2JqLCAiaHR0cHM6Ly8iKSB8fAogICAgICAgICAgICAgICAgICAgIEFscGFjYS5zdGFydHNXaXRoKG9iaiwgIi8iKSB8fAogICAgICAgICAgICAgICAgICAgIEFscGFjYS5zdGFydHNXaXRoKG9iaiwgIi4vIikgfHwKICAgICAgICAgICAgICAgICAgICBBbHBhY2Euc3RhcnRzV2l0aChvYmosICIuLi8iKSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUGlja3MgYSBzdWItZWxlbWVudCBmcm9tIGFuIG9iamVjdCB1c2luZyBhIGtleXMgYXJyYXkuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IE9iamVjdCB0byBiZSB0cmF2ZXJzZWQKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ3xBcnJheX0ga2V5cyBFaXRoZXIgYW4gYXJyYXkgb2YgdG9rZW5zIG9yIGEgZG90LWRlbGltaXRlZCBzdHJpbmcgKGkuZS4gImRhdGEudXNlci5maXJzdG5hbWUiKQogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBzdWJwcm9wIE9wdGlvbmFsIHN1YnByb3BlcnR5IHRvIHRyYXZlcnNlIChpLmUuLiAiZGF0YS5wcm9wZXJ0aWVzLnVzZXIucHJvcGVydGllcy5maXJzdG5hbWUiKQogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gU3ViIGVsZW1lbnQgbWFwcGVkIHRvIHRoZSBnaXZlbiBrZXkgcGF0aAogICAgICAgICAqLwogICAgICAgIHRyYXZlcnNlT2JqZWN0IDogZnVuY3Rpb24ob2JqZWN0LCBrZXlzLCBzdWJwcm9wKSB7CiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNTdHJpbmcoa2V5cykpIHsKICAgICAgICAgICAgICAgIGtleXMgPSBrZXlzLnNwbGl0KCIuIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gbnVsbDsKICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSBvYmplY3Q7CgogICAgICAgICAgICB2YXIga2V5ID0gbnVsbDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAga2V5ID0ga2V5cy5zaGlmdCgpOwogICAgICAgICAgICAgICAgaWYgKHN1YnByb3AgJiYga2V5ID09IHN1YnByb3ApIHsKICAgICAgICAgICAgICAgICAgICBrZXkgPSBrZXlzLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc0VtcHR5KGN1cnJlbnRba2V5XSkpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudFtrZXldOwogICAgICAgICAgICAgICAgICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50ID0gY3VycmVudDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGtleXMgPSBbXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAoa2V5cy5sZW5ndGggPiAwKTsKCiAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEhlbHBlciBmdW5jdGlvbiB0aGF0IGV4ZWN1dGVzIHRoZSBnaXZlbiBmdW5jdGlvbiB1cG9uIGVhY2ggZWxlbWVudCBpbiB0aGUgYXJyYXkKICAgICAgICAgKiBUaGUgZWxlbWVudCBvZiB0aGUgYXJyYXkgYmVjb21lcyB0aGUgInRoaXMiIHZhcmlhYmxlIGluIHRoZSBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R9IGRhdGEgRWl0aGVyIGFuIGFycmF5IG9yIGFuIG9iamVjdAogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgRnVuY3Rpb24gdG8gYmUgZXhlY3V0ZWQuCiAgICAgICAgICovCiAgICAgICAgZWFjaCA6IGZ1bmN0aW9uKGRhdGEsIGZ1bmMpIHsKICAgICAgICAgICAgaWYgKEFscGFjYS5pc0FycmF5KGRhdGEpKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBmdW5jLmFwcGx5KGRhdGFbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKEFscGFjYS5pc09iamVjdChkYXRhKSkgewogICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICBmdW5jLmFwcGx5KGRhdGFba2V5XSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBNZXJnZXMganNvbiBvYmoyIGludG8gb2JqMSB1c2luZyBhIHJlY3Vyc2l2ZSBhcHByb2FjaC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmoxIERlc3RpbmF0aW9uIG9iamVjdC4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqMiBTb3VyY2Ugb2JqZWN0LgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHZhbGlkS2V5RnVuY3Rpb24gRnVuY3Rpb24gdXNlZCB0byBkZXRlcm1pbmUgd2hldGhlciB0byBpbmNsdWRlIGEgZ2l2ZW4ga2V5IG9yIG5vdC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IE1lcmdlZCBvYmplY3QuCiAgICAgICAgICovCiAgICAgICAgbWVyZ2UgOiBmdW5jdGlvbihvYmoxLCBvYmoyLCB2YWxpZEtleUZ1bmN0aW9uKSB7CiAgICAgICAgICAgIGlmICghb2JqMSkgewogICAgICAgICAgICAgICAgb2JqMSA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBvYmoyKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsaWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgIGlmICh2YWxpZEtleUZ1bmN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsaWQgPSB2YWxpZEtleUZ1bmN0aW9uKGtleSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHZhbGlkKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKEFscGFjYS5pc0VtcHR5KG9iajJba2V5XSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb2JqMVtrZXldID0gb2JqMltrZXldOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNPYmplY3Qob2JqMltrZXldKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFvYmoxW2tleV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmoxW2tleV0gPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iajFba2V5XSA9IEFscGFjYS5tZXJnZShvYmoxW2tleV0sIG9iajJba2V5XSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmoxW2tleV0gPSBvYmoyW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBvYmoxOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIE1lcmdlcyBqc29uICJzb3VyY2UiIGludG8gInRhcmdldCIgdXNpbmcgYSByZWN1cnNpdmUgYXBwcm9hY2guIFRoZSBtZXJnZSB3aWxsIGluY2x1ZGUgZW1wdHkgdmFsdWVzCiAgICAgICAgICogb2Ygb2JqMiBwcm9wZXJ0aWVzLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHRhcmdldCBUYXJnZXQgb2JqZWN0LgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzb3VyY2UgU291cmNlIG9iamVjdC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IE1lcmdlZCBvYmplY3QKICAgICAgICAgKi8KICAgICAgICBtZXJnZU9iamVjdCA6IGZ1bmN0aW9uKHRhcmdldCwgc291cmNlKSB7CgogICAgICAgICAgICBpZiAoIXRhcmdldCkgewogICAgICAgICAgICAgICAgdGFyZ2V0ID0ge307CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghc291cmNlKSB7CiAgICAgICAgICAgICAgICBzb3VyY2UgPSB7fTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5tZXJnZU9iamVjdDIoc291cmNlLCB0YXJnZXQpOwoKICAgICAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgICB9LAoKICAgICAgICBtZXJnZU9iamVjdDI6IGZ1bmN0aW9uKHNvdXJjZSwgdGFyZ2V0KQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzQXJyYXkgPSBBbHBhY2EuaXNBcnJheTsKICAgICAgICAgICAgdmFyIGlzT2JqZWN0ID0gQWxwYWNhLmlzT2JqZWN0OwogICAgICAgICAgICB2YXIgaXNVbmRlZmluZWQgPSBBbHBhY2EuaXNVbmRlZmluZWQ7CiAgICAgICAgICAgIHZhciBjb3B5T2YgPSBBbHBhY2EuY29weU9mOwoKICAgICAgICAgICAgdmFyIF9tZXJnZSA9IGZ1bmN0aW9uKHNvdXJjZSwgdGFyZ2V0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaXNBcnJheShzb3VyY2UpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KHRhcmdldCkpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBtZXJnZSBhcnJheSBlbGVtZW50cwogICAgICAgICAgICAgICAgICAgICAgICAkLmVhY2goc291cmNlLCBmdW5jdGlvbihpbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0LnB1c2goY29weU9mKHNvdXJjZVtpbmRleF0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNvbWV0aGluZyBpcyBhbHJlYWR5IGluIHRoZSB0YXJnZXQgdGhhdCBpc24ndCBhbiBBUlJBWQogICAgICAgICAgICAgICAgICAgICAgICAvLyBza2lwCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoaXNPYmplY3Qoc291cmNlKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3QodGFyZ2V0KSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG1lcmdlIG9iamVjdCBwcm9wZXJ0aWVzCiAgICAgICAgICAgICAgICAgICAgICAgICQuZWFjaChzb3VyY2UsIGZ1bmN0aW9uKGtleSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZCh0YXJnZXRba2V5XSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRba2V5XSA9IGNvcHlPZihzb3VyY2Vba2V5XSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFtrZXldID0gX21lcmdlKHNvdXJjZVtrZXldLCB0YXJnZXRba2V5XSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc29tZXRoaW5nIGlzIGFscmVhZHkgaW4gdGhlIHRhcmdldCB0aGF0IGlzbid0IGFuIE9CSkVDVAogICAgICAgICAgICAgICAgICAgICAgICAvLyBza2lwCiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBvdGhlcndpc2UsIGl0J3MgYSBzY2FsYXIsIGFsd2F5cyBvdmVyd3JpdGUKICAgICAgICAgICAgICAgICAgICB0YXJnZXQgPSBjb3B5T2Yoc291cmNlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0OwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgX21lcmdlKHNvdXJjZSwgdGFyZ2V0KTsKCiAgICAgICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogU3Vic3RpdHV0ZXMgYSBzdHJpbmcgd2l0aCBhIGxpc3Qgb2YgdG9rZW5zLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHRleHQgU291cmNlIHN0cmluZy4KICAgICAgICAgKiBAcGFyYW0gYXJncyBMaXN0IG9mIHRva2Vucy4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIFN1YnN0aXR1dGVkIHN0cmluZy4KICAgICAgICAgKi8KICAgICAgICBzdWJzdGl0dXRlVG9rZW5zIDogZnVuY3Rpb24odGV4dCwgYXJncykgewoKICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eSh0ZXh0KSkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuID0gInsiICsgaSArICJ9IjsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHggPSB0ZXh0LmluZGV4T2YodG9rZW4pOwogICAgICAgICAgICAgICAgICAgIGlmICh4ID4gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG50ID0gdGV4dC5zdWJzdHJpbmcoMCwgeCkgKyBhcmdzW2ldICsgdGV4dC5zdWJzdHJpbmcoeCArIDMpOwogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vdGV4dCA9IEFscGFjYS5yZXBsYWNlQWxsKHRleHQsIHRva2VuLCBhcmdzW2ldKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRleHQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ29tcGFyZXMgdHdvIG9iamVjdHMuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqMSBGaXJzdCBvYmplY3QuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9iajIgU2Vjb25kIG9iamVjdC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmIHR3byBvYmplY3RzIGFyZSBzYW1lLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgY29tcGFyZU9iamVjdCA6IGZ1bmN0aW9uKG9iajEsIG9iajIpIHsKICAgICAgICAgICAgcmV0dXJuIGVxdWl2KG9iajEsIG9iajIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENvbXBhcmVzIGNvbnRlbnQgb2YgdHdvIGFycmF5cy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycl8xIEZpcnN0IGFycmF5LgogICAgICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycl8yIFNlY29uZCBhcnJheS4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZiB0d28gYXJyYXlzIGhhdmUgc2FtZSBjb250ZW50LCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgY29tcGFyZUFycmF5Q29udGVudCA6IGZ1bmN0aW9uKGFycl8xLCBhcnJfMikgewogICAgICAgICAgICB2YXIgZXF1YWwgPSBhcnJfMSAmJiBhcnJfMiAmJiAoYXJyXzEubGVuZ3RoID09IGFycl8yLmxlbmd0aCk7CiAgICAgICAgICAgIGlmIChlcXVhbCkgewogICAgICAgICAgICAgICAgJC5lYWNoKGFycl8xLCBmdW5jdGlvbihmb28sIHZhbCkgewogICAgICAgICAgICAgICAgICAgIGlmICghZXF1YWwpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoJC5pbkFycmF5KHZhbCwgYXJyXzIpID09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVxdWFsID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXF1YWwgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBlcXVhbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyB3aGV0aGVyIGEgdmFyaWFibGUgaGFzIGVtcHR5IHZhbHVlIG9yIG5vdC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7QW55fSB2YWwgVmFyaWFibGUgdG8gYmUgZXZhbHVhdGVkLgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmIHRoZSB2YXJpYWJsZSBoYXMgZW1wdHkgdmFsdWUsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgKi8KICAgICAgICBpc1ZhbEVtcHR5IDogZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgIHZhciBlbXB0eSA9IGZhbHNlOwogICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkodmFsKSkgewogICAgICAgICAgICAgICAgZW1wdHkgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKEFscGFjYS5pc1N0cmluZyh2YWwpICYmIHZhbCA9PT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICBlbXB0eSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzT2JqZWN0KHZhbCkgJiYgJC5pc0VtcHR5T2JqZWN0KHZhbCkpIHsKICAgICAgICAgICAgICAgICAgICBlbXB0eSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzQXJyYXkodmFsKSAmJiB2YWwubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgZW1wdHkgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKEFscGFjYS5pc051bWJlcih2YWwpICYmIGlzTmFOKHZhbCkpIHsKICAgICAgICAgICAgICAgICAgICBlbXB0eSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVtcHR5OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICoKICAgICAgICAgKiBJbml0aWFsIGZ1bmN0aW9uIGZvciBzZXR0aW5nIHVwIGZpZWxkIGluc3RhbmNlIGFuZCBleGVjdXRpbmcgY2FsbGJhY2tzIGlmIG5lZWRlZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBlbCBDb250YWluZXIgZWxlbWVudC4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGluaXRpYWxTZXR0aW5ncyBhbnkgYWRkaXRpb25hbCBzZXR0aW5ncyBwcm92aWRlZCB0byB0aGUgdG9wLWxldmVsIEFscGFjYSBvYmplY3QKICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBSZW5kZXIgY2FsbGJhY2suCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gcmVuZGVyZWRDYWxsYmFjayBQb3N0LXJlbmRlciBjYWxsYmFjay4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5jb25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IGlzRHluYW1pY0NyZWF0aW9uIHdoZXRoZXIgdGhpcyBhbHBhY2EgZmllbGQgaXMgYmVpbmcgZHluYW1pY2FsbHkgY3JlYXRlZCAoYWZ0ZXIgZmlyc3QgcmVuZGVyKQogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0FscGFjYS5GaWVsZH0gTmV3IGZpZWxkIGluc3RhbmNlLgogICAgICAgICAqLwogICAgICAgIGluaXQ6IGZ1bmN0aW9uKGVsLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGluaXRpYWxTZXR0aW5ncywgY2FsbGJhY2ssIHJlbmRlcmVkQ2FsbGJhY2ssIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaywgaXNEeW5hbWljQ3JlYXRpb24pIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBDT01QSUxBVElPTgogICAgICAgICAgICAvLwogICAgICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAgICAgICAgIC8vIGlmIHRoZXkgcHJvdmlkZWQgYW4gaW5saW5lIHZpZXcgb2JqZWN0LCB3ZSBhc3NpZ24gYW4gaWQgYW5kIHN0b3JlIG9udG8gdmlld3MgbWFwCiAgICAgICAgICAgIC8vIHNvIHRoYXQgaXQgZ2V0cyBjb21waWxlZCBhbG9uZyB3aXRoIHRoZSByZXN0CiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNPYmplY3QodmlldykpIHsKICAgICAgICAgICAgICAgIHZhciB2aWV3SWQgPSB2aWV3LmlkOwogICAgICAgICAgICAgICAgaWYgKCF2aWV3SWQpIHsKICAgICAgICAgICAgICAgICAgICB2aWV3LmlkID0gdGhpcy5nZW5lcmF0ZVZpZXdJZCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHBhcmVudElkID0gdmlldy5wYXJlbnQ7CiAgICAgICAgICAgICAgICBpZiAoIXBhcmVudElkKSB7CiAgICAgICAgICAgICAgICAgICAgdmlldy5wYXJlbnQgPSAiVklFV19XRUJfRURJVCI7IC8vIGFzc3VtZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RlclZpZXcodmlldyk7CiAgICAgICAgICAgICAgICB2aWV3ID0gdmlldy5pZDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gY29tcGlsZSBhbGwgb2YgdGhlIHZpZXdzIGFuZCB0ZW1wbGF0ZXMKICAgICAgICAgICAgdGhpcy5jb21waWxlKGZ1bmN0aW9uKHJlcG9ydCkgewoKICAgICAgICAgICAgICAgIGlmIChyZXBvcnQuZXJyb3JzICYmIHJlcG9ydC5lcnJvcnMubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlcG9ydC5lcnJvcnMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmlld0lkID0gcmVwb3J0LmVycm9yc1tpXS52aWV3SWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZUlkID0gcmVwb3J0LmVycm9yc1tpXS50ZW1wbGF0ZUlkOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXJyID0gcmVwb3J0LmVycm9yc1tpXS5lcnI7CgogICAgICAgICAgICAgICAgICAgICAgICBBbHBhY2EubG9nRXJyb3IoIlRoZSB0ZW1wbGF0ZTogIiArIHRlbXBsYXRlSWQgKyAiIGZvciB2aWV3OiAiICsgdmlld0lkICsgIiBmYWlsZWQgdG8gY29tcGlsZSIpOwogICAgICAgICAgICAgICAgICAgICAgICBBbHBhY2EubG9nRXJyb3IoSlNPTi5zdHJpbmdpZnkoZXJyKSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gQWxwYWNhLnRocm93RXJyb3JXaXRoQ2FsbGJhY2soIlZpZXcgY29tcGlsYXRpb24gZmFpbGVkLCBjYW5ub3QgaW5pdGlhbGl6ZSBBbHBhY2EuICBQbGVhc2UgY2hlY2sgdGhlIGVycm9yIGxvZ3MuIiwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgc2VsZi5faW5pdChlbCwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBpbml0aWFsU2V0dGluZ3MsIGNhbGxiYWNrLCByZW5kZXJlZENhbGxiYWNrLCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2ssIGlzRHluYW1pY0NyZWF0aW9uKTsKICAgICAgICAgICAgfSwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgX2luaXQ6IGZ1bmN0aW9uKGVsLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGluaXRpYWxTZXR0aW5ncywgY2FsbGJhY2ssIHJlbmRlcmVkQ2FsbGJhY2ssIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaywgaXNEeW5hbWljQ3JlYXRpb24pCiAgICAgICAgewogICAgICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAgICAgLy8KICAgICAgICAgICAgLy8gVklFVyBSRVNPTFVUSU9OCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKCiAgICAgICAgICAgIC8vIG1ha2Ugc29tZSBpbnRlbGxpZ2VudCBndWVzc2VzIGFib3V0IHdoYXQgdmlldyBpZCB3ZSBtaWdodCBkZWZhdWx0IHRvIGluIGNhc2UgdGhleSB3YW50IHRvIHVzZQogICAgICAgICAgICAvLyBhdXRvLXZpZXcgc2VsZWN0aW9uLiAgV2UgZGV0ZWN0IGpxdWVyeS11aSwgYm9vdHN0cmFwIGFuZCBqcXVlcnltb2JpbGUuCiAgICAgICAgICAgIHZhciBmYWxsYmFja1VJID0gbnVsbDsKICAgICAgICAgICAgdmFyIGZhbGxiYWNrVHlwZSA9IG51bGw7CiAgICAgICAgICAgIHZhciBmYWxsYmFja1ZpZXdJZCA9IG51bGw7CgogICAgICAgICAgICAvLyBpZiBqUXVlcnkgTW9iaWxlIGlzIHByZXNlbnQsIGZhbGwgYmFjayB0byBWSUVXX01PQklMRV9FRElUIG9yIFZJRVdfTU9CSUxFX0NSRUFURQogICAgICAgICAgICBpZiAoJC5tb2JpbGUpIHsKICAgICAgICAgICAgICAgIGZhbGxiYWNrVUkgPSAibW9iaWxlIjsKICAgICAgICAgICAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgZmFsbGJhY2tUeXBlID0gImVkaXQiOwogICAgICAgICAgICAgICAgICAgIGZhbGxiYWNrVmlld0lkID0gIlZJRVdfTU9CSUxFX0VESVQiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZmFsbGJhY2tUeXBlID0gImNyZWF0ZSI7CiAgICAgICAgICAgICAgICAgICAgZmFsbGJhY2tWaWV3SWQgPSAiVklFV19NT0JJTEVfQ1JFQVRFIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaWYgVHdpdHRlciBCb290c3RyYXAgaXMgcHJlc2VudCwgZmFsbCBiYWNrIHRvIFZJRVdfQk9PVFNUUkFQX0VESVQgb3IgVklFV19CT09UU1RSQVBfQ1JFQVRFCiAgICAgICAgICAgIHZhciBib290c3RyYXBEZXRlY3RlZCA9ICh0eXBlb2YgJCgpLm1vZGFsID09ICdmdW5jdGlvbicpOwogICAgICAgICAgICBpZiAoYm9vdHN0cmFwRGV0ZWN0ZWQpIHsKICAgICAgICAgICAgICAgIGZhbGxiYWNrVUkgPSAiYm9vdHN0cmFwIjsKICAgICAgICAgICAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgZmFsbGJhY2tUeXBlID0gImVkaXQiOwogICAgICAgICAgICAgICAgICAgIGZhbGxiYWNrVmlld0lkID0gIlZJRVdfQk9PVFNUUkFQX0VESVQiOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBmYWxsYmFja1R5cGUgPSAiY3JlYXRlIjsKICAgICAgICAgICAgICAgICAgICBmYWxsYmFja1ZpZXdJZCA9ICJWSUVXX0JPT1RTVFJBUF9DUkVBVEUiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpZiBubyB2aWV3IHByb3ZpZGVkLCBidXQgdGhleSBwcm92aWRlZCAidWkiIGFuZCBvcHRpb25hbGx5ICJ0eXBlIiwgdGhlbiB3ZSB0cnkgdG8gYXV0by1zZWxlY3QgdGhlIHZpZXcKICAgICAgICAgICAgaWYgKCF2aWV3KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgdWkgPSBpbml0aWFsU2V0dGluZ3MudWk7CiAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGluaXRpYWxTZXR0aW5ncy50eXBlOwoKICAgICAgICAgICAgICAgIGlmICghdWkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFmYWxsYmFja1VJKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZhbGxiYWNrVUkgPSBBbHBhY2EuZGVmYXVsdFVJOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZmFsbGJhY2tVSSkgewogICAgICAgICAgICAgICAgICAgICAgICB1aSA9IGZhbGxiYWNrVUk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh1aSkgewogICAgICAgICAgICAgICAgICAgIGlmICghdHlwZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0eXBlID0gZmFsbGJhY2tUeXBlID8gZmFsbGJhY2tUeXBlIDogImVkaXQiOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgQWxwYWNhLmxvZ0RlYnVnKCJObyB2aWV3IHByb3ZpZGVkIGJ1dCBmb3VuZCByZXF1ZXN0IGZvciBVSTogIiArIHVpICsgIiBhbmQgdHlwZTogIiArIHR5cGUpOwoKICAgICAgICAgICAgICAgICAgICAvLyBzZWUgaWYgd2UgY2FuIGF1dG8tc2VsZWN0IGEgdmlldwogICAgICAgICAgICAgICAgICAgIHZpZXcgPSB0aGlzLmxvb2t1cE5vcm1hbGl6ZWRWaWV3KHVpLCB0eXBlKTsKICAgICAgICAgICAgICAgICAgICBpZiAodmlldykgewogICAgICAgICAgICAgICAgICAgICAgICBBbHBhY2EubG9nRGVidWcoIkZvdW5kIHZpZXc6ICIgKyB2aWV3KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBBbHBhY2EubG9nRGVidWcoIk5vIHZpZXcgZm91bmQgZm9yIFVJOiAiICsgdWkgKyAiIGFuZCB0eXBlOiAiICsgdHlwZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpZiBzdGlsbCBubyB2aWV3LCB0aGVuIGRlZmF1bHQgZmFsbGJhY2sgdG8gb3VyIGRldGVjdGVkIHZpZXcgb3IgdGhlIGRlZmF1bHQKICAgICAgICAgICAgaWYgKCF2aWV3KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBBbHBhY2EubG9nRGVidWcoIkEgdmlldyB3YXMgbm90IHNwZWNpZmllZC4iKTsKICAgICAgICAgICAgICAgIGlmIChmYWxsYmFja1ZpZXdJZCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBBbHBhY2EubG9nRGVidWcoIkZhbGxpbmcgYmFjayB0byBkZXRlY3RlZCB2aWV3OiAiICsgZmFsbGJhY2tWaWV3SWQpOwogICAgICAgICAgICAgICAgICAgIHZpZXcgPSBmYWxsYmFja1ZpZXdJZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBBbHBhY2EubG9nRGVidWcoIkZhbGxpbmcgYmFjayB0byBkZWZhdWx0IHZpZXc6ICIgKyB0aGlzLmRlZmF1bHRWaWV3KTsKICAgICAgICAgICAgICAgICAgICB2aWV3ID0gdGhpcy5kZWZhdWx0VmlldzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZGVidWdnaW5nOiBpZiB0aGUgdmlldyBpc24ndCBhdmFpbGFibGUsIHdlIHdhbnQgdG8gcmVwb3J0IGl0IHJpZ2h0IGF3YXkKICAgICAgICAgICAgaWYgKEFscGFjYS5pc1N0cmluZyh2aWV3KSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLm5vcm1hbGl6ZWRWaWV3c1t2aWV3XSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gQWxwYWNhLnRocm93RXJyb3JXaXRoQ2FsbGJhY2soIlRoZSBkZXNpcmVkIHZpZXc6ICIgKyB2aWV3ICsgIiBjb3VsZCBub3QgYmUgbG9hZGVkLiAgUGxlYXNlIG1ha2Ugc3VyZSBpdCBpcyBsb2FkZWQgYW5kIG5vdCBtaXNzcGVsbGVkLiIsIGVycm9yQ2FsbGJhY2spOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vIEZJRUxEIElOU1RBTlRJQVRJT04KICAgICAgICAgICAgLy8KICAgICAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgICAgICAvLyBURVNUIC0gc3dhcCBjb2RlCiAgICAgICAgICAgIC8vIHN3YXAgZWwgLT4gcGxhY2Vob2xkZXIKICAgICAgICAgICAgLy92YXIgdGVtcEhvbGRlciA9ICQoIjxkaXY+PC9kaXY+Iik7CiAgICAgICAgICAgIC8vJChlbCkuYmVmb3JlKHRlbXBIb2xkZXIpOwogICAgICAgICAgICAvLyQoZWwpLnJlbW92ZSgpOwoKICAgICAgICAgICAgdmFyIGZpZWxkID0gQWxwYWNhLmNyZWF0ZUZpZWxkSW5zdGFuY2UoZWwsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICAgICAgaWYgKGZpZWxkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBoaWRlIGZpZWxkIHdoaWxlIHJlbmRlcmluZwogICAgICAgICAgICAgICAgJChlbCkuYWRkQ2xhc3MoImFscGFjYS1maWVsZC1yZW5kZXJpbmciKTsKICAgICAgICAgICAgICAgICQoZWwpLmFkZENsYXNzKCJhbHBhY2EtaGlkZGVuIik7CgogICAgICAgICAgICAgICAgZmllbGQuaXNEeW5hbWljQ3JlYXRpb24gPSBpc0R5bmFtaWNDcmVhdGlvbjsKICAgICAgICAgICAgICAgIEFscGFjYS5maWVsZEluc3RhbmNlc1tmaWVsZC5nZXRJZCgpXSA9IGZpZWxkOwoKICAgICAgICAgICAgICAgIC8vIG1lY2hhbmlzbSBmb3IgbG9va2luZyB1cCBmaWVsZCBpbnN0YW5jZXMgYnkgaWQKICAgICAgICAgICAgICAgIGZpZWxkLmFsbEZpZWxkSW5zdGFuY2VzID0gZnVuY3Rpb24oKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBBbHBhY2EuZmllbGRJbnN0YW5jZXM7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIC8vIGFsbG93IGNhbGxiYWNrcyBkZWZpbmVkIHRocm91Z2ggdmlldwogICAgICAgICAgICAgICAgaWYgKEFscGFjYS5pc0VtcHR5KGNhbGxiYWNrKSkgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gZmllbGQudmlldy5yZW5kZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkocmVuZGVyZWRDYWxsYmFjaykpIHsKICAgICAgICAgICAgICAgICAgICByZW5kZXJlZENhbGxiYWNrID0gZmllbGQudmlldy5wb3N0UmVuZGVyOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuY29sbGVjdFRpbWluZykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY291bnRlcnMgPSBBbHBhY2EuQ291bnRlcnMoInJlbmRlciIpOwogICAgICAgICAgICAgICAgICAgIHZhciB0MSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBmaW4gPSBmdW5jdGlvbigpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhpcyBpcyB0aGUgdG9wLWxldmVsIGFscGFjYSBmaWVsZCwgdGhlbiB3ZSBjYWxsIGZvciB2YWxpZGF0aW9uIHN0YXRlIHRvIGJlIHJlY2FsY3VsYXRlZCBhY3Jvc3MKICAgICAgICAgICAgICAgICAgICAvLyBhbGwgY2hpbGQgZmllbGRzCiAgICAgICAgICAgICAgICAgICAgaWYgKCFmaWVsZC5wYXJlbnQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBmaW5hbCBjYWxsIHRvIHVwZGF0ZSB2YWxpZGF0aW9uIHN0YXRlCiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkLnJlZnJlc2hWYWxpZGF0aW9uU3RhdGUodHJ1ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBmb3JjZSBoaWRlSW5pdFZhbGlkYXRpb25FcnJvciB0byBmYWxzZSBmb3IgZmllbGQgYW5kIGFsbCBjaGlsZHJlbgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmllbGQudmlldy50eXBlICE9ICd2aWV3JykKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgQWxwYWNhLmZpZWxkQXBwbHlDaGlsZHJlbihmaWVsZCwgZnVuY3Rpb24oZmllbGQpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2V0IHRvIGZhbHNlIGFmdGVyIGZpcnN0IHZhbGlkYXRpb24gKGV2ZW4gaWYgaW4gQ1JFQVRFIG1vZGUsIHdlIG9ubHkgZm9yY2UgaW5pdCB2YWxpZGF0aW9uIGVycm9yIGZhbHNlIG9uIGZpcnN0IHJlbmRlcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZC5oaWRlSW5pdFZhbGlkYXRpb25FcnJvciA9IGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBURVNUIC0gc3dhcCBjb2RlCiAgICAgICAgICAgICAgICAgICAgLy8gc3dhcCBwbGFjZWhvbGRlciAtPiBlbAogICAgICAgICAgICAgICAgICAgIC8vJCh0ZW1wSG9sZGVyKS5iZWZvcmUoZWwpOwogICAgICAgICAgICAgICAgICAgIC8vJCh0ZW1wSG9sZGVyKS5yZW1vdmUoKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gcmV2ZWFsIGZpZWxkIGFmdGVyIHJlbmRlcmluZwogICAgICAgICAgICAgICAgICAgICQoZWwpLnJlbW92ZUNsYXNzKCJhbHBhY2EtZmllbGQtcmVuZGVyaW5nIik7CiAgICAgICAgICAgICAgICAgICAgJChlbCkucmVtb3ZlQ2xhc3MoImFscGFjYS1oaWRkZW4iKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKEFscGFjYS5jb2xsZWN0VGltaW5nKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHQyID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50ZXJzLmluY3JlbWVudChmaWVsZC5nZXRGaWVsZFR5cGUoKSwgKHQyLXQxKSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZW5kZXJlZENhbGxiYWNrKGZpZWxkKTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eShjYWxsYmFjaykpIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhmaWVsZCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbigpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBmaWVsZC5yZW5kZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbigpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZpZWxkLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgICBmaWVsZC5yZW5kZXJlZENhbGxiYWNrID0gcmVuZGVyZWRDYWxsYmFjazsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTk9URTogdGhpcyBjYW4gYmUgbnVsbCBpZiBhbiBlcnJvciB3YXMgdGhyb3duCiAgICAgICAgICAgIHJldHVybiBmaWVsZDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqCiAgICAgICAgICogSW50ZXJuYWwgbWV0aG9kIGZvciBjb25zdHJ1Y3RpbmcgYSBmaWVsZCBpbnN0YW5jZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBlbCBUaGUgZG9tIGVsZW1lbnQgdG8gYWN0IGFzIHRoZSBjb250YWluZXIgb2YgdGhlIGNvbnN0cnVjdGVkIGZpZWxkLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBkYXRhIFRoZSBkYXRhIHRvIGJlIGJvdW5kIGludG8gdGhlIGZpZWxkLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIFRoZSBjb25maWd1cmF0aW9uIGZvciB0aGUgZmllbGQuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBUaGUgc2NoZW1hIGZvciB0aGUgZmllbGQuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IFRoZSB2aWV3IGZvciB0aGUgZmllbGQuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuY29ubmVjdG9yfSBjb25uZWN0b3IgVGhlIGZpZWxkIGNvbm5lY3RvciB0byBiZSBib3VuZCBpbnRvIHRoZSBmaWVsZC4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0FscGFjYS5GaWVsZH0gTmV3IGZpZWxkIGluc3RhbmNlLgogICAgICAgICAqLwogICAgICAgIGNyZWF0ZUZpZWxkSW5zdGFuY2UgOiBmdW5jdGlvbihlbCwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgLy8gbWFrZSBzdXJlIG9wdGlvbnMgYW5kIHNjaGVtYSBhcmUgbm90IGVtcHR5CiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNWYWxFbXB0eShvcHRpb25zKSkgb3B0aW9ucyA9IHt9OwogICAgICAgICAgICBpZiAoQWxwYWNhLmlzVmFsRW1wdHkoc2NoZW1hKSkgc2NoZW1hID0ge307CiAgICAgICAgICAgIC8vIG9wdGlvbnMgY2FuIGJlIGEgc3RyaW5nIHRoYXQgaWRlbnRpZmllcyB0aGUga2luZCBvZiBmaWVsZCB0byBjb25zdHJ1Y3QgKGkuZS4gInRleHQiKQogICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBBbHBhY2EuaXNTdHJpbmcob3B0aW9ucykpIHsKICAgICAgICAgICAgICAgIHZhciBmaWVsZFR5cGUgPSBvcHRpb25zOwogICAgICAgICAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICAgICAgICAgICAgb3B0aW9ucy50eXBlID0gZmllbGRUeXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghb3B0aW9ucy50eXBlKSB7CiAgICAgICAgICAgICAgICAvLyBpZiBub3RoaW5nIHBhc3NlZCBpbiwgd2UgY2FuIHRyeSB0byBtYWtlIGEgZ3Vlc3MgYmFzZWQgb24gdGhlIHR5cGUgb2YgZGF0YQogICAgICAgICAgICAgICAgaWYgKCFzY2hlbWEudHlwZSkgewogICAgICAgICAgICAgICAgICAgIHNjaGVtYS50eXBlID0gQWxwYWNhLmdldFNjaGVtYVR5cGUoZGF0YSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc2NoZW1hICYmIHNjaGVtYVsiZW51bSJdKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNjaGVtYVsiZW51bSJdLmxlbmd0aCA+IDMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy50eXBlID0gInNlbGVjdCI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy50eXBlID0gInJhZGlvIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG9wdGlvbnMudHlwZSA9IEFscGFjYS5kZWZhdWx0U2NoZW1hRmllbGRNYXBwaW5nW3NjaGVtYS50eXBlXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIGNoZWNrIGlmIGl0IGhhcyBmb3JtYXQgZGVmaW5lZAogICAgICAgICAgICAgICAgaWYgKHNjaGVtYS5mb3JtYXQgJiYgQWxwYWNhLmRlZmF1bHRGb3JtYXRGaWVsZE1hcHBpbmdbc2NoZW1hLmZvcm1hdF0pIHsKICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnR5cGUgPSBBbHBhY2EuZGVmYXVsdEZvcm1hdEZpZWxkTWFwcGluZ1tzY2hlbWEuZm9ybWF0XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBmaW5kIHRoZSBmaWVsZCBjbGFzcyByZWdpc3RlcmVkIGZvciB0aGlzIGZpZWxkIHR5cGUKICAgICAgICAgICAgdmFyIGZpZWxkQ2xhc3MgPSBBbHBhY2EuZ2V0RmllbGRDbGFzcyhvcHRpb25zLnR5cGUpOwogICAgICAgICAgICBpZiAoIWZpZWxkQ2xhc3MpIHsKICAgICAgICAgICAgICAgIGVycm9yQ2FsbGJhY2soewogICAgICAgICAgICAgICAgICAgICJtZXNzYWdlIjoiVW5hYmxlIHRvIGZpbmQgZmllbGQgY2xhc3MgZm9yIHR5cGU6ICIgKyBvcHRpb25zLnR5cGUsCiAgICAgICAgICAgICAgICAgICAgInJlYXNvbiI6ICJGSUVMRF9JTlNUQU5USUFUSU9OX0VSUk9SIgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBpZiB3ZSBoYXZlIGRhdGEsIGJpbmQgaXQgaW4KICAgICAgICAgICAgcmV0dXJuIG5ldyBmaWVsZENsYXNzKGVsLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUHJvdmlkZXMgYSBiYWNrd2FyZHMtY29tcGF0aWJsZSB2ZXJzaW9uIG9mIHRoZSBmb3JtZXIgalF1ZXJ5IDEuOC4zIHBhcnNlSlNPTiBmdW5jdGlvbiAodGhpcyB3YXMgY2hhbmdlZAogICAgICAgICAqIGZvciBqUXVlcnkgMS45LjAgYW5kIGludHJvZHVjZXMgYWxsIGtpbmRzIG9mIGlzc3VlcykuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gdGV4dAogICAgICAgICAqLwogICAgICAgIHBhcnNlSlNPTjogZnVuY3Rpb24odGV4dCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICghdGV4dCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiAkLnBhcnNlSlNPTih0ZXh0KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBDb21waWxlcyBhbGwgb2YgdGhlIHZpZXdzLCBub3JtYWxpemluZyB0aGVtIGZvciB1c2UgYnkgQWxwYWNhLgogICAgICAgICAqIEFsc28gY29tcGlsZXMgYW55IHRlbXBsYXRlcyB0aGF0IHRoZSB2aWV3cyBtYXkgcmVmZXJlbmNlLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIGNiIHRoZSBjYWxsYmFjayB0aGF0IGdldHMgZmlyZWQgb25jZSBjb21waWxhdGlvbiBoYXMgZW5kZWQKICAgICAgICAgKi8KICAgICAgICBjb21waWxlOiBmdW5jdGlvbihjYiwgZXJyb3JDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIC8vIHZhciB0MSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwoKICAgICAgICAgICAgdmFyIHJlcG9ydCA9IHsKICAgICAgICAgICAgICAgICJlcnJvcnMiOiBbXSwKICAgICAgICAgICAgICAgICJjb3VudCI6IDAsCiAgICAgICAgICAgICAgICAic3VjY2Vzc0NvdW50IjogMAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIGZpbmFsQ2FsbGJhY2sgPSBmdW5jdGlvbihub3JtYWxpemVkVmlld3MpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIHZhciB0MiA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coIkNvbXBpbGF0aW9uIEV4aXRlZCB3aXRoICIgKyByZXBvcnQuZXJyb3JzLmxlbmd0aCArICIgZXJyb3JzIGluOiAiICsgKHQyLXQxKSsgIiBtcyIpOwoKICAgICAgICAgICAgICAgIGlmIChyZXBvcnQuZXJyb3JzLmxlbmd0aCA9PT0gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBzdWNjZXNzIQoKICAgICAgICAgICAgICAgICAgICAvLyBjb3B5IG91ciB2aWV3cyBpbnRvIHRoZSBub3JtYWxpemVkIHNldAogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGsgaW4gbm9ybWFsaXplZFZpZXdzKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5ub3JtYWxpemVkVmlld3Nba10gPSBub3JtYWxpemVkVmlld3Nba107CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNiKHJlcG9ydCk7CiAgICAgICAgICAgIH07CgoKCiAgICAgICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBWSUVXIFRFTVBMQVRFIENPTVBJTEFUSU9OCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICAgICAgLy8gZm9yIGFsbCBvZiB0aGUgdmlld3MgKHRoZSBvcmlnaW5hbCBvbmVzLCBub3QgdGhlIGNvbXBpbGVkIG9uZXMpLCB3YWxrIHRocm91Z2ggdGhlbSBhbmQgZmluZCBhbnkKICAgICAgICAgICAgLy8gYW5kIGFsbCB0ZW1wbGF0ZXMgdGhhdCBuZWVkIHRvIGJlIGNvbXBpbGVkCiAgICAgICAgICAgIC8vIGNvbXBpbGUgZWFjaCBhbmQgc3RvcmUgaW4gYSAiY29tcGlsZWRUZW1wbGF0ZXMiIG9iamVjdAoKICAgICAgICAgICAgdmFyIHZpZXdDb21waWxlQ2FsbGJhY2sgPSBmdW5jdGlvbihub3JtYWxpemVkVmlld3MsIGVyciwgdmlldywgY29tcGlsZWRUZW1wbGF0ZUlkLCBjYWNoZUtleSwgdG90YWxDYWxscykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHZpZXdJZCA9IHZpZXcuaWQ7CgogICAgICAgICAgICAgICAgcmVwb3J0LmNvdW50Kys7CiAgICAgICAgICAgICAgICBpZiAoZXJyKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJlcG9ydC5lcnJvcnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICJ2aWV3Ijogdmlld0lkLAogICAgICAgICAgICAgICAgICAgICAgICAidGVtcGxhdGUiOiBjb21waWxlZFRlbXBsYXRlSWQsCiAgICAgICAgICAgICAgICAgICAgICAgICJlcnIiOiBlcnIKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXBvcnQuc3VjY2Vzc0NvdW50Kys7CgogICAgICAgICAgICAgICAgICAgIC8vIG1hcmsgb250byB0aGUgdmlldyB0aGF0IHRoZSB0ZW1wbGF0ZSB3YXMgY29tcGlsZWQgZm9yIHRoaXMgdmlldwogICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgbWFwcyBbY29tcGlsZWRUZW1wbGF0ZUlkXSAtPiBbY2FjaGVLZXldCiAgICAgICAgICAgICAgICAgICAgdmlldy5jb21waWxlZFRlbXBsYXRlc1tjb21waWxlZFRlbXBsYXRlSWRdID0gY2FjaGVLZXk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHJlcG9ydC5jb3VudCA9PSB0b3RhbENhbGxzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vdmFyIHQyID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZygiQ29tcGlsYXRpb24gdG9vazogIiArICh0Mi10MSkgKyAiIG1zIik7CiAgICAgICAgICAgICAgICAgICAgZmluYWxDYWxsYmFjayhub3JtYWxpemVkVmlld3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIGNvbXBpbGVWaWV3VGVtcGxhdGUgPSBmdW5jdGlvbihub3JtYWxpemVkVmlld3MsIHZpZXcsIGNvbXBpbGVkVGVtcGxhdGVJZCwgdGVtcGxhdGUsIHRvdGFsQ2FsbHMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB2aWV3SWQgPSB2aWV3LmlkOwoKICAgICAgICAgICAgICAgIHZhciBtaWdodEJlVXJsID0gKHRlbXBsYXRlICYmIHRlbXBsYXRlLmluZGV4T2YoIi8iKSA+IC0xKTsKICAgICAgICAgICAgICAgIGlmIChtaWdodEJlVXJsKQogICAgICAgICAgICAgICAgewoKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBzdXBwb3J0IGZvciBqUXVlcnkgc2VsZWN0b3JzCiAgICAgICAgICAgICAgICAgICAgaWYgKHRlbXBsYXRlICYmICgodGVtcGxhdGUuaW5kZXhPZigiIyIpID09PSAwKSB8fCAodGVtcGxhdGUuaW5kZXhPZigiLiIpID09PSAwKSkpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgeCA9ICQodGVtcGxhdGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICQoeCkuYXR0cigidHlwZSIpOwogICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZSA9ICQoeCkuaHRtbCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IG51bGw7CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzT2JqZWN0KHRlbXBsYXRlKSkgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSB0ZW1wbGF0ZS50eXBlOwogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlID0gdGVtcGxhdGUudGVtcGxhdGU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gaWYgdHlwZSBpc24ndCByZXNvbHZlZCwgYXNzdW1lIGpxdWVyeSB0bXBsKCkKICAgICAgICAgICAgICAgIGlmICghdHlwZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gInRleHQveC1qcXVlcnktdG1wbCI7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gbG9vayB1cCB0aGUgdGVtcGxhdGUgcHJvY2Vzc29yCiAgICAgICAgICAgICAgICB2YXIgZW5naW5lID0gQWxwYWNhLlRlbXBsYXRlRW5naW5lUmVnaXN0cnkuZmluZCh0eXBlKTsKICAgICAgICAgICAgICAgIGlmICghZW5naW5lKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIEFscGFjYS5sb2dFcnJvcigiQ2Fubm90IGZpbmQgdGVtcGxhdGUgZW5naW5lIGZvciB0eXBlOiAiICsgdHlwZSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVyciA9IG5ldyBFcnJvcigiQ2Fubm90IGZpbmQgdGVtcGxhdGUgZW5naW5lIGZvciB0eXBlOiAiICsgdHlwZSk7CiAgICAgICAgICAgICAgICAgICAgdmlld0NvbXBpbGVDYWxsYmFjayhub3JtYWxpemVkVmlld3MsIGVyciwgdmlldywgY29tcGlsZWRUZW1wbGF0ZUlkLCBjYWNoZUtleSwgdG90YWxDYWxscyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gdGhlIGRlc2lyZWQgbmV3IGNhY2hlIGtleQogICAgICAgICAgICAgICAgdmFyIGNhY2hlS2V5ID0gdmlld0lkICsgIl8iICsgY29tcGlsZWRUZW1wbGF0ZUlkOwogICAgICAgICAgICAgICAgaWYgKGVuZ2luZS5pc0NhY2hlZChjYWNoZUtleSkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gYWxyZWFkeSBjb21waWxlZCwgc28gc2tpcAogICAgICAgICAgICAgICAgICAgIHZpZXdDb21waWxlQ2FsbGJhY2sobm9ybWFsaXplZFZpZXdzLCBudWxsLCB2aWV3LCBjb21waWxlZFRlbXBsYXRlSWQsIGNhY2hlS2V5LCB0b3RhbENhbGxzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBjaGVjayBpZiAidGVtcGxhdGUiIGlzIGFjdHVhbGx5IGEgcmVmZXJlbmNlIHRvIGFub3RoZXIgdGVtcGxhdGUKICAgICAgICAgICAgICAgICAgICAvLyBpZiBzbywgd2UgY2FuIHJldXNlIHRoZSBwcmV2aW91c2x5IGNvbXBpbGVkIGZlbGxvdwoKICAgICAgICAgICAgICAgICAgICB2YXIgcHJldmlvdXNseUNvbXBpbGVkVGVtcGxhdGVDYWNoZUtleSA9IHZpZXcuY29tcGlsZWRUZW1wbGF0ZXNbInZpZXctIiArIHRlbXBsYXRlXTsKICAgICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNseUNvbXBpbGVkVGVtcGxhdGVDYWNoZUtleSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgZW50cnkgaXMgcG9pbnRpbmcgdG8gYSBwcmV2aW91c2x5IGNvbXBpbGVkIHRlbXBsYXRlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZldGNoIGh0bWwgYW5kIGNvbXBpbGUgYWdhaW4KICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUgPSBBbHBhY2EuVGVtcGxhdGVDYWNoZVtwcmV2aW91c2x5Q29tcGlsZWRUZW1wbGF0ZUNhY2hlS2V5XTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGNvbXBpbGUgdGhlIHRlbXBsYXRlCiAgICAgICAgICAgICAgICAgICAgZW5naW5lLmNvbXBpbGUoY2FjaGVLZXksIHRlbXBsYXRlLCBmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmlld0NvbXBpbGVDYWxsYmFjayhub3JtYWxpemVkVmlld3MsIGVyciwgdmlldywgY29tcGlsZWRUZW1wbGF0ZUlkLCBjYWNoZUtleSwgdG90YWxDYWxscyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIGNvbXBpbGVUZW1wbGF0ZXMgPSBmdW5jdGlvbihub3JtYWxpemVkVmlld3MpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIHdhbGsgdGhyb3VnaCBhbGwgbm9ybWFsaXplZCB2aWV3cyB0aGF0IHdlJ3JlIGludGVyZXN0ZWQgaW4gYW5kIGNvbXBpbGUgdGhlIHRlbXBsYXRlcyB3aXRoaW4KICAgICAgICAgICAgICAgIHZhciBmdW5jdGlvbkFycmF5ID0gW107CiAgICAgICAgICAgICAgICBmb3IgKHZhciB2aWV3SWQgaW4gbm9ybWFsaXplZFZpZXdzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciB2aWV3ID0gbm9ybWFsaXplZFZpZXdzW3ZpZXdJZF07CiAgICAgICAgICAgICAgICAgICAgdmlldy5jb21waWxlZFRlbXBsYXRlcyA9IHt9OwoKICAgICAgICAgICAgICAgICAgICAvLyB2aWV3IHRlbXBsYXRlcwogICAgICAgICAgICAgICAgICAgIGlmICh2aWV3LnRlbXBsYXRlcykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIHRlbXBsYXRlSWQgaW4gdmlldy50ZW1wbGF0ZXMpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHZpZXcudGVtcGxhdGVzW3RlbXBsYXRlSWRdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uQXJyYXkucHVzaChmdW5jdGlvbihub3JtYWxpemVkVmlld3MsIHZpZXcsIGNvbXBpbGVkVGVtcGxhdGVJZCwgdGVtcGxhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24odG90YWxDYWxscykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlVmlld1RlbXBsYXRlKG5vcm1hbGl6ZWRWaWV3cywgdmlldywgY29tcGlsZWRUZW1wbGF0ZUlkLCB0ZW1wbGF0ZSwgdG90YWxDYWxscyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0obm9ybWFsaXplZFZpZXdzLCB2aWV3LCAidmlldy0iICsgdGVtcGxhdGVJZCwgdGVtcGxhdGUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gZmllbGQgbGV2ZWwgdGVtcGxhdGVzCiAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXcuZmllbGRzKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgcGF0aCBpbiB2aWV3LmZpZWxkcykKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXcuZmllbGRzW3BhdGhdLnRlbXBsYXRlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciB0ZW1wbGF0ZUlkIGluIHZpZXcuZmllbGRzW3BhdGhdLnRlbXBsYXRlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHZpZXcuZmllbGRzW3BhdGhdLnRlbXBsYXRlc1t0ZW1wbGF0ZUlkXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uQXJyYXkucHVzaChmdW5jdGlvbihub3JtYWxpemVkVmlld3MsIHZpZXcsIGNvbXBpbGVkVGVtcGxhdGVJZCwgdGVtcGxhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbih0b3RhbENhbGxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZVZpZXdUZW1wbGF0ZShub3JtYWxpemVkVmlld3MsIHZpZXcsIGNvbXBpbGVkVGVtcGxhdGVJZCwgdGVtcGxhdGUsIHRvdGFsQ2FsbHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfShub3JtYWxpemVkVmlld3MsIHZpZXcsICJmaWVsZC0iICsgcGF0aCArICItIiArIHRlbXBsYXRlSWQsIHRlbXBsYXRlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBsYXlvdXQgdGVtcGxhdGUKICAgICAgICAgICAgICAgICAgICBpZiAodmlldy5sYXlvdXQgJiYgdmlldy5sYXlvdXQudGVtcGxhdGUpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSB2aWV3LmxheW91dC50ZW1wbGF0ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uQXJyYXkucHVzaChmdW5jdGlvbihub3JtYWxpemVkVmlld3MsIHZpZXcsIGNvbXBpbGVkVGVtcGxhdGVJZCwgdGVtcGxhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbih0b3RhbENhbGxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZVZpZXdUZW1wbGF0ZShub3JtYWxpemVkVmlld3MsIHZpZXcsIGNvbXBpbGVkVGVtcGxhdGVJZCwgdGVtcGxhdGUsIHRvdGFsQ2FsbHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgfShub3JtYWxpemVkVmlld3MsIHZpZXcsICJsYXlvdXRUZW1wbGF0ZSIsIHRlbXBsYXRlKSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBnbG9iYWwgdGVtcGxhdGUKICAgICAgICAgICAgICAgICAgICBpZiAodmlldy5nbG9iYWxUZW1wbGF0ZSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHZpZXcuZ2xvYmFsVGVtcGxhdGU7CgogICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbkFycmF5LnB1c2goZnVuY3Rpb24obm9ybWFsaXplZFZpZXdzLCB2aWV3LCBjb21waWxlZFRlbXBsYXRlSWQsIHRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24odG90YWxDYWxscykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGVWaWV3VGVtcGxhdGUobm9ybWFsaXplZFZpZXdzLCB2aWV3LCBjb21waWxlZFRlbXBsYXRlSWQsIHRlbXBsYXRlLCB0b3RhbENhbGxzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIH0obm9ybWFsaXplZFZpZXdzLCB2aWV3LCAiZ2xvYmFsVGVtcGxhdGUiLCB0ZW1wbGF0ZSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBub3cgaW52b2tlIGFsbCBvZiB0aGUgZnVuY3Rpb25zCiAgICAgICAgICAgICAgICAvLyB0aGlzIHRlbGxzIGVhY2ggdGVtcGxhdGUgdG8gY29tcGlsZQogICAgICAgICAgICAgICAgdmFyIHRvdGFsQ2FsbHMgPSBmdW5jdGlvbkFycmF5Lmxlbmd0aDsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZnVuY3Rpb25BcnJheS5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbkFycmF5W2ldKHRvdGFsQ2FsbHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZVZpZXdzID0gZnVuY3Rpb24oKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyB0aGUgdmlld3MgdGhhdCB3ZSdyZSBnb2luZyB0byBub3JtYWxpemVkCiAgICAgICAgICAgICAgICB2YXIgbm9ybWFsaXplZFZpZXdzID0ge307CiAgICAgICAgICAgICAgICB2YXIgbm9ybWFsaXplZFZpZXdDb3VudCA9IDA7CgogICAgICAgICAgICAgICAgLy8gc29tZSBpbml0aWFsIHNlbGYtYXNzdXJhbmNlIHRvIG1ha2Ugc3VyZSB3ZSBoYXZlIHRoZSBub3JtYWxpemVkVmlld3MgbWFwIHNldCB1cAogICAgICAgICAgICAgICAgaWYgKCFBbHBhY2Eubm9ybWFsaXplZFZpZXdzKSB7CiAgICAgICAgICAgICAgICAgICAgQWxwYWNhLm5vcm1hbGl6ZWRWaWV3cyA9IHt9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2VsZi5ub3JtYWxpemVkVmlld3MgPSBBbHBhY2Eubm9ybWFsaXplZFZpZXdzOwoKICAgICAgICAgICAgICAgIC8vIHdhbGsgdGhyb3VnaCBhbGwgb2Ygb3VyIHZpZXdzCiAgICAgICAgICAgICAgICBmb3IgKHZhciB2aWV3SWQgaW4gc2VsZi52aWV3cykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGUgdmlldyBpcyBhbHJlYWR5IG5vcm1hbGl6ZWQgb24gdGhlIEFscGFjYSBnbG9iYWwsIHdlIGRvIG5vdCBib3RoZXIKICAgICAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5ub3JtYWxpemVkVmlld3Nbdmlld0lkXSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBub3JtYWxpemVkVmlldyA9IG5ldyBBbHBhY2EuTm9ybWFsaXplZFZpZXcodmlld0lkKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZWRWaWV3Lm5vcm1hbGl6ZSgpKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3JtYWxpemVkVmlld3Nbdmlld0lkXSA9IG5vcm1hbGl6ZWRWaWV3OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9ybWFsaXplZFZpZXdDb3VudCsrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEFscGFjYS50aHJvd0Vycm9yV2l0aENhbGxiYWNrKCJWaWV3IG5vcm1hbGl6YXRpb24gZmFpbGVkLCBjYW5ub3QgaW5pdGlhbGl6ZSBBbHBhY2EuICBQbGVhc2UgY2hlY2sgdGhlIGVycm9yIGxvZ3MuIiwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZWRWaWV3Q291bnQgPiAwKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGNvbXBpbGVUZW1wbGF0ZXMobm9ybWFsaXplZFZpZXdzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBmaW5hbENhbGxiYWNrKG5vcm1hbGl6ZWRWaWV3cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBub3JtYWxpemVWaWV3cygpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIExvb2tzIHVwIHRoZSBwcm9wZXIgdGVtcGxhdGUgdG8gYmUgdXNlZCB0byBoYW5kbGUgYSByZXF1ZXN0ZWQgdGVtcGxhdGUgaWQgZm9yIGEgdmlldyBhbmQgYSBmaWVsZC4KICAgICAgICAgKiBQZXJmb3JtcyBhbiBvdmVycmlkZSBsb29rdXAgdG8gZmluZCB0aGUgcHJvcGVyIHRlbXBsYXRlLgogICAgICAgICAqCiAgICAgICAgICogSGFuZHMgYmFjayBhIGRlc2NyaXB0b3Igb2YgZXZlcnl0aGluZyB0aGF0IGlzIGtub3duIGFib3V0IHRoZSByZXNvbHZlZCB0ZW1wbGF0ZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB2aWV3CiAgICAgICAgICogQHBhcmFtIHRlbXBsYXRlSWQKICAgICAgICAgKiBAcGFyYW0gZmllbGQKICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgZ2V0VGVtcGxhdGVEZXNjcmlwdG9yOiBmdW5jdGlvbih2aWV3LCB0ZW1wbGF0ZUlkLCBmaWVsZCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBkZXNjcmlwdG9yID0ge307CgogICAgICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBGSUdVUkUgT1VUIFdIRVJFIFRIRSBURU1QTEFURSBJUyBJTiBUSEUgVklFVyBDT05GSUdVUkFUSU9OIChSRVNQRUNUSU5HIEZJRUxEIE9WRVJSSURFUykKICAgICAgICAgICAgLy8KICAgICAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAgICAgICAgIHZhciBfdGVtcGxhdGU7CiAgICAgICAgICAgIHZhciBfdGVtcGxhdGVUeXBlOwoKICAgICAgICAgICAgLy8gZmlyc3QgY29uc2lkZXIgdGVtcGxhdGUgbGV2ZWwKICAgICAgICAgICAgaWYgKHZpZXcudGVtcGxhdGVzICYmIHZpZXcudGVtcGxhdGVzW3RlbXBsYXRlSWRdKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBfdGVtcGxhdGUgPSB2aWV3LnRlbXBsYXRlc1t0ZW1wbGF0ZUlkXTsKICAgICAgICAgICAgICAgIF90ZW1wbGF0ZVR5cGUgPSAidmlldyI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIG5vdyBhbGxvdyBmb3IgZmllbGQgb3ZlcnJpZGVzCiAgICAgICAgICAgIGlmIChmaWVsZCAmJiBmaWVsZC5wYXRoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgcGF0aCA9IGZpZWxkLnBhdGg7CgogICAgICAgICAgICAgICAgaWYgKHZpZXcgJiYgdmlldy5maWVsZHMgJiYgdmlldy5maWVsZHNbcGF0aF0gJiYgdmlldy5maWVsZHNbcGF0aF0udGVtcGxhdGVzICYmIHZpZXcuZmllbGRzW3BhdGhdLnRlbXBsYXRlc1t0ZW1wbGF0ZUlkXSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBfdGVtcGxhdGUgPSB2aWV3LmZpZWxkc1twYXRoXS50ZW1wbGF0ZXNbdGVtcGxhdGVJZF07CiAgICAgICAgICAgICAgICAgICAgX3RlbXBsYXRlVHlwZSA9ICJmaWVsZCI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGZpbmFsbHkgdGhlcmUgYXJlIHNvbWUgaGFyZGNvZGVkIHZhbHVlcwogICAgICAgICAgICBpZiAodGVtcGxhdGVJZCA9PSAiZ2xvYmFsVGVtcGxhdGUiKSB7CiAgICAgICAgICAgICAgICBfdGVtcGxhdGUgPSAiZ2xvYmFsVGVtcGxhdGUiOwogICAgICAgICAgICAgICAgX3RlbXBsYXRlVHlwZSA9ICJnbG9iYWwiOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGVtcGxhdGVJZCA9PSAibGF5b3V0VGVtcGxhdGUiKSB7CiAgICAgICAgICAgICAgICBfdGVtcGxhdGUgPSAibGF5b3V0VGVtcGxhdGUiOwogICAgICAgICAgICAgICAgX3RlbXBsYXRlVHlwZSA9ICJsYXlvdXQiOwogICAgICAgICAgICB9CgogICAgICAgICAgICBkZXNjcmlwdG9yLnRlbXBsYXRlID0ge307CiAgICAgICAgICAgIGRlc2NyaXB0b3IudGVtcGxhdGUuaWQgPSB0ZW1wbGF0ZUlkOwogICAgICAgICAgICBkZXNjcmlwdG9yLnRlbXBsYXRlLnR5cGUgPSBfdGVtcGxhdGVUeXBlOwogICAgICAgICAgICBkZXNjcmlwdG9yLnRlbXBsYXRlLnZhbHVlID0gX3RlbXBsYXRlOwoKCiAgICAgICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vIEVOR0lORSBQUk9QRVJUSUVTCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgICAgICB2YXIgdHlwZSA9IG51bGw7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IF90ZW1wbGF0ZTsKICAgICAgICAgICAgaWYgKEFscGFjYS5pc09iamVjdCh0ZW1wbGF0ZSkpIHsKICAgICAgICAgICAgICAgIHR5cGUgPSB0ZW1wbGF0ZS50eXBlOwogICAgICAgICAgICAgICAgdGVtcGxhdGUgPSB0ZW1wbGF0ZS50ZW1wbGF0ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaWYgdHlwZSBpc24ndCByZXNvbHZlZCwgYXNzdW1lIGpxdWVyeSB0bXBsKCkKICAgICAgICAgICAgaWYgKCF0eXBlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0eXBlID0gInRleHQveC1qcXVlcnktdG1wbCI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBlbmdpbmUgPSBBbHBhY2EuVGVtcGxhdGVFbmdpbmVSZWdpc3RyeS5maW5kKHR5cGUpOwogICAgICAgICAgICBpZiAoIWVuZ2luZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIEFscGFjYS50aHJvd0RlZmF1bHRFcnJvcigiQ2Fubm90IGZpbmQgdGVtcGxhdGUgZW5naW5lIGZvciB0eXBlOiAiICsgdHlwZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGRlc2NyaXB0b3IuZW5naW5lID0ge307CiAgICAgICAgICAgIGRlc2NyaXB0b3IuZW5naW5lLnR5cGUgPSB0eXBlOwogICAgICAgICAgICBkZXNjcmlwdG9yLmVuZ2luZS5pZCA9IGVuZ2luZS5pZDsKCgoKICAgICAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAgICAgLy8KICAgICAgICAgICAgLy8gTk9XIERFVEVSTUlORSBUSEUgQ09NUElMRUQgVEVNUExBVEUgSUQgRk9SIFRISVMgVEVNUExBVEUKICAgICAgICAgICAgLy8KICAgICAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAgICAgICAgIHZhciBjb21waWxlZFRlbXBsYXRlSWQgPSBudWxsOwogICAgICAgICAgICBpZiAoX3RlbXBsYXRlVHlwZSA9PSAidmlldyIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbXBpbGVkVGVtcGxhdGVJZCA9ICJ2aWV3LSIgKyB0ZW1wbGF0ZUlkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKF90ZW1wbGF0ZVR5cGUgPT0gImZpZWxkIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29tcGlsZWRUZW1wbGF0ZUlkID0gImZpZWxkLSIgKyBmaWVsZC5wYXRoICsgIi0iICsgdGVtcGxhdGVJZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChfdGVtcGxhdGVUeXBlID09ICJsYXlvdXQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb21waWxlZFRlbXBsYXRlSWQgPSAibGF5b3V0VGVtcGxhdGUiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKF90ZW1wbGF0ZVR5cGUgPT0gImdsb2JhbCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbXBpbGVkVGVtcGxhdGVJZCA9ICJnbG9iYWxUZW1wbGF0ZSI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGRlc2NyaXB0b3IuY29tcGlsZWRUZW1wbGF0ZUlkID0gY29tcGlsZWRUZW1wbGF0ZUlkOwoKCiAgICAgICAgICAgIC8vIGxvb2sgdXAgdGhlIGNhY2hlS2V5IGZvciB0aGlzIGNvbXBpbGVkIHRlbXBsYXRlIGlkCiAgICAgICAgICAgIC8vIHZlcmlmeSBpdCBpcyBpbiBjYWNoZQogICAgICAgICAgICB2YXIgY2FjaGVLZXkgPSB2aWV3LmNvbXBpbGVkVGVtcGxhdGVzW2NvbXBpbGVkVGVtcGxhdGVJZF07CiAgICAgICAgICAgIGlmICghY2FjaGVLZXkgfHwgIWVuZ2luZS5pc0NhY2hlZChjYWNoZUtleSkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIHdlbGwsIGl0IGlzbid0IGFjdHVhbGx5IGEgY29tcGlsZWQgdGVtcGxhdGUKICAgICAgICAgICAgICAgIC8vIHRodXMsIHdlIGNhbm5vdCBpbiB0aGUgZW5kIHByb2R1Y2UgYSBkZXNjcmlwdG9yIGZvciBpdAogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGRlc2NyaXB0b3IuY2FjaGUgPSB7fTsKICAgICAgICAgICAgZGVzY3JpcHRvci5jYWNoZS5rZXkgPSBjYWNoZUtleTsKCiAgICAgICAgICAgIHJldHVybiBkZXNjcmlwdG9yOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEV4ZWN1dGVzIGEgdGVtcGxhdGUgYW5kIHJldHVybnMgYSBET00gZWxlbWVudC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB0ZW1wbGF0ZURlc2NyaXB0b3IKICAgICAgICAgKiBAcGFyYW0gbW9kZWwKICAgICAgICAgKi8KICAgICAgICB0bXBsOiBmdW5jdGlvbih0ZW1wbGF0ZURlc2NyaXB0b3IsIG1vZGVsKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGh0bWwgPSBBbHBhY2EudG1wbEh0bWwodGVtcGxhdGVEZXNjcmlwdG9yLCBtb2RlbCk7CgogICAgICAgICAgICByZXR1cm4gQWxwYWNhLnNhZmVEb21QYXJzZShodG1sKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBFeGVjdXRlcyBhIHRlbXBsYXRlIGFuZCByZXR1cm5zIEhUTUwuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gdGVtcGxhdGVEZXNjcmlwdG9yCiAgICAgICAgICogQHBhcmFtIG1vZGVsCiAgICAgICAgICovCiAgICAgICAgdG1wbEh0bWw6IGZ1bmN0aW9uKHRlbXBsYXRlRGVzY3JpcHRvciwgbW9kZWwpCiAgICAgICAgewogICAgICAgICAgICBpZiAoIW1vZGVsKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtb2RlbCA9IHt9OwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgZW5naW5lVHlwZSA9IHRlbXBsYXRlRGVzY3JpcHRvci5lbmdpbmUudHlwZTsKICAgICAgICAgICAgdmFyIGNvbXBpbGVkVGVtcGxhdGVJZCA9IHRlbXBsYXRlRGVzY3JpcHRvci5jb21waWxlZFRlbXBsYXRlSWQ7CgogICAgICAgICAgICB2YXIgZW5naW5lID0gQWxwYWNhLlRlbXBsYXRlRW5naW5lUmVnaXN0cnkuZmluZChlbmdpbmVUeXBlKTsKICAgICAgICAgICAgaWYgKCFlbmdpbmUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBBbHBhY2EudGhyb3dEZWZhdWx0RXJyb3IoIkNhbm5vdCBmaW5kIHRlbXBsYXRlIGVuZ2luZSBmb3IgdHlwZTogIiArIGVuZ2luZVR5cGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBleGVjdXRlIHRoZSB0ZW1wbGF0ZQogICAgICAgICAgICB2YXIgY2FjaGVLZXkgPSB0ZW1wbGF0ZURlc2NyaXB0b3IuY2FjaGUua2V5OwogICAgICAgICAgICB2YXIgaHRtbCA9IGVuZ2luZS5leGVjdXRlKGNhY2hlS2V5LCBtb2RlbCwgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gQWxwYWNhLnRocm93RGVmYXVsdEVycm9yKCJUaGUgY29tcGlsZWQgdGVtcGxhdGU6ICIgKyBjb21waWxlZFRlbXBsYXRlSWQgKyAiIGZhaWxlZCB0byBleGVjdXRlOiAiICsgSlNPTi5zdHJpbmdpZnkoZXJyKSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgcmV0dXJuIGh0bWw7CiAgICAgICAgfQogICAgfSk7CgoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vCiAgICAvLyBMT0dHRVIKICAgIC8vCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgQWxwYWNhLkRFQlVHID0gMDsKICAgIEFscGFjYS5JTkZPID0gMTsKICAgIEFscGFjYS5XQVJOID0gMjsKICAgIEFscGFjYS5FUlJPUiA9IDM7CgogICAgLy8gYnkgZGVmYXVsdCwgbG9nZ2luZyBvbmx5IHNob3dzIHdhcm5pbmdzIGFuZCBhYm92ZQogICAgLy8gdG8gZGVidWcsIHNldCBBbHBhY2EubG9nTGV2ZWwgPSBBbHBhY2EuREVCVUcKICAgIEFscGFjYS5sb2dMZXZlbCA9IEFscGFjYS5XQVJOOwoKICAgIEFscGFjYS5sb2dEZWJ1ZyA9IGZ1bmN0aW9uKG9iaikgewogICAgICAgIEFscGFjYS5sb2coQWxwYWNhLkRFQlVHLCBvYmopOwogICAgfTsKICAgIEFscGFjYS5sb2dJbmZvID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgQWxwYWNhLmxvZyhBbHBhY2EuSU5GTywgb2JqKTsKICAgIH07CiAgICBBbHBhY2EubG9nV2FybiA9IGZ1bmN0aW9uKG9iaikgewogICAgICAgIEFscGFjYS5sb2coQWxwYWNhLldBUk4sIG9iaik7CiAgICB9OwogICAgQWxwYWNhLmxvZ0Vycm9yID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgQWxwYWNhLmxvZyhBbHBhY2EuRVJST1IsIG9iaik7CiAgICB9OwoKICAgIEFscGFjYS5MT0dfTUVUSE9EX01BUCA9IHsKICAgICAgICAwOiAnZGVidWcnLAogICAgICAgIDE6ICdpbmZvJywKICAgICAgICAyOiAnd2FybicsCiAgICAgICAgMzogJ2Vycm9yJwogICAgfTsKCiAgICBBbHBhY2EubG9nID0gZnVuY3Rpb24obGV2ZWwsIG9iaikgewoKICAgICAgICBpZiAoQWxwYWNhLmxvZ0xldmVsIDw9IGxldmVsKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIG1ldGhvZCA9IEFscGFjYS5MT0dfTUVUSE9EX01BUFtsZXZlbF07CgogICAgICAgICAgICBpZiAodHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnICYmIGNvbnNvbGVbbWV0aG9kXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCJkZWJ1ZyIgPT0gbWV0aG9kKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhvYmopOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoImluZm8iID09IG1ldGhvZCkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuaW5mbyhvYmopOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoIndhcm4iID09IG1ldGhvZCkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihvYmopOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoImVycm9yIiA9PSBtZXRob2QpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKG9iaik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhvYmopOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICBBbHBhY2EuY2hlY2tlZCA9IGZ1bmN0aW9uKGVsLCB2YWx1ZSkKICAgIHsKICAgICAgICByZXR1cm4gQWxwYWNhLmF0dHJQcm9wKGVsLCAiY2hlY2tlZCIsIHZhbHVlKTsKICAgIH07CgogICAgQWxwYWNhLmF0dHJQcm9wID0gZnVuY3Rpb24oZWwsIG5hbWUsIHZhbHVlKQogICAgewogICAgICAgIGlmICghKHR5cGVvZih2YWx1ZSkgPT09ICJ1bmRlZmluZWQiKSkKICAgICAgICB7CiAgICAgICAgICAgIC8vIGpRdWVyeSAxLjYrCiAgICAgICAgICAgIGlmICgkKGVsKS5wcm9wKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAkKGVsKS5wcm9wKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICQoZWwpLmF0dHIobmFtZSwgdmFsdWUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkKGVsKS5yZW1vdmVBdHRyKG5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBub3cgcmV0dXJuIHRoZSBjb3JyZWN0IHZhbHVlCgogICAgICAgIC8vIGpRdWVyeSAxLjYrCiAgICAgICAgaWYgKCQoZWwpLnByb3ApIHsKICAgICAgICAgICAgcmV0dXJuICQoZWwpLnByb3AobmFtZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gJChlbCkuYXR0cihuYW1lKTsKICAgIH07CgogICAgQWxwYWNhLmxvYWRSZWZTY2hlbWFPcHRpb25zID0gZnVuY3Rpb24odG9wRmllbGQsIHJlZmVyZW5jZUlkLCBjYWxsYmFjaykKICAgIHsKICAgICAgICBpZiAoIXJlZmVyZW5jZUlkKQogICAgICAgIHsKICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAocmVmZXJlbmNlSWQgPT0gIiMiKQogICAgICAgIHsKICAgICAgICAgICAgLy8gdGhpcyBpcyB0aGUgdXJpIG9mIHRoZSBjdXJyZW50IHNjaGVtYSBkb2N1bWVudAogICAgICAgICAgICBjYWxsYmFjayh0b3BGaWVsZC5zY2hlbWEsIHRvcEZpZWxkLm9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChyZWZlcmVuY2VJZC5pbmRleE9mKCIjLyIpID09IDApCiAgICAgICAgewogICAgICAgICAgICAvLyB0aGlzIGlzIGEgcHJvcGVydHkgcGF0aCByZWxhdGl2ZSB0byB0aGUgcm9vdCBvZiB0aGUgY3VycmVudCBzY2hlbWEKICAgICAgICAgICAgdmFyIGRlZklkID0gcmVmZXJlbmNlSWQuc3Vic3RyaW5nKDIpOwoKICAgICAgICAgICAgLy8gc3BsaXQgaW50byB0b2tlbnMKICAgICAgICAgICAgdmFyIHRva2VucyA9IGRlZklkLnNwbGl0KCIvIik7CgogICAgICAgICAgICB2YXIgZGVmU2NoZW1hID0gdG9wRmllbGQuc2NoZW1hOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRva2Vucy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHRva2VuID0gdG9rZW5zW2ldOwoKICAgICAgICAgICAgICAgIC8vIHNjaGVtYQogICAgICAgICAgICAgICAgaWYgKGRlZlNjaGVtYVt0b2tlbl0pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZGVmU2NoZW1hID0gZGVmU2NoZW1hW3Rva2VuXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKGRlZlNjaGVtYS5wcm9wZXJ0aWVzICYmIGRlZlNjaGVtYS5wcm9wZXJ0aWVzW3Rva2VuXSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkZWZTY2hlbWEgPSBkZWZTY2hlbWEucHJvcGVydGllc1t0b2tlbl07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChkZWZTY2hlbWEuZGVmaW5pdGlvbnMgJiYgZGVmU2NoZW1hLmRlZmluaXRpb25zW3Rva2VuXSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkZWZTY2hlbWEgPSBkZWZTY2hlbWEuZGVmaW5pdGlvbnNbdG9rZW5dOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGRlZlNjaGVtYSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBkZWZPcHRpb25zID0gdG9wRmllbGQub3B0aW9uczsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0b2tlbnMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IHRva2Vuc1tpXTsKCiAgICAgICAgICAgICAgICAvLyBvcHRpb25zCiAgICAgICAgICAgICAgICBpZiAoZGVmT3B0aW9uc1t0b2tlbl0pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZGVmT3B0aW9ucyA9IGRlZk9wdGlvbnNbdG9rZW5dOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoZGVmT3B0aW9ucy5maWVsZHMgJiYgZGVmT3B0aW9ucy5maWVsZHNbdG9rZW5dKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGRlZk9wdGlvbnMgPSBkZWZPcHRpb25zLmZpZWxkc1t0b2tlbl07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChkZWZPcHRpb25zLmRlZmluaXRpb25zICYmIGRlZk9wdGlvbnMuZGVmaW5pdGlvbnNbdG9rZW5dKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGRlZk9wdGlvbnMgPSBkZWZPcHRpb25zLmRlZmluaXRpb25zW3Rva2VuXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkZWZPcHRpb25zID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2FsbGJhY2soZGVmU2NoZW1hLCBkZWZPcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAocmVmZXJlbmNlSWQuaW5kZXhPZigiIyIpID09IDApCiAgICAgICAgewogICAgICAgICAgICAvLyB0aGlzIGlzIHRoZSBJRCBvZiBhIG5vZGUgaW4gdGhlIGN1cnJlbnQgc2NoZW1hIGRvY3VtZW50CgogICAgICAgICAgICAvLyB3YWxrIHRoZSBjdXJyZW50IGRvY3VtZW50IHNjaGVtYSB1bnRpbCB3ZSBmaW5kIHRoZSByZWZlcmVuY2VkIG5vZGUgKHVzaW5nIGlkIHByb3BlcnR5KQogICAgICAgICAgICB2YXIgcmVzb2x1dGlvbiA9IEFscGFjYS5yZXNvbHZlUmVmZXJlbmNlKHRvcEZpZWxkLnNjaGVtYSwgdG9wRmllbGQub3B0aW9ucywgcmVmZXJlbmNlSWQpOwogICAgICAgICAgICBpZiAocmVzb2x1dGlvbikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2FsbGJhY2socmVzb2x1dGlvbi5zY2hlbWEsIHJlc29sdXRpb24ub3B0aW9ucyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBub3RoaW5nCiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vIHRoZSByZWZlcmVuY2UgaXMgY29uc2lkZXJlZCB0byBiZSBhIFVSSSB3aXRoIG9yIHdpdGhvdXQgYSAiIyIgaW4gaXQgdG8gcG9pbnQgdG8gYSBzcGVjaWZpYyBsb2NhdGlvbiBpbgogICAgICAgICAgICAvLyB0aGUgdGFyZ2V0IHNjaGVtYQoKICAgICAgICAgICAgdmFyIHJlZmVyZW5jZVBhcnRzID0gQWxwYWNhLnBhdGhQYXJ0cyhyZWZlcmVuY2VJZCk7CgogICAgICAgICAgICB0b3BGaWVsZC5jb25uZWN0b3IubG9hZFJlZmVyZW5jZVNjaGVtYShyZWZlcmVuY2VQYXJ0cy5wYXRoLCBmdW5jdGlvbihzY2hlbWEpIHsKICAgICAgICAgICAgICAgIHRvcEZpZWxkLmNvbm5lY3Rvci5sb2FkUmVmZXJlbmNlT3B0aW9ucyhyZWZlcmVuY2VQYXJ0cy5wYXRoLCBmdW5jdGlvbihvcHRpb25zKSB7CgogICAgICAgICAgICAgICAgICAgIGlmIChyZWZlcmVuY2VQYXJ0cy5pZCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXNvbHV0aW9uID0gQWxwYWNhLnJlc29sdmVSZWZlcmVuY2Uoc2NoZW1hLCBvcHRpb25zLCByZWZlcmVuY2VQYXJ0cy5pZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXNvbHV0aW9uKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2hlbWEgPSByZXNvbHV0aW9uLnNjaGVtYTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMgPSByZXNvbHV0aW9uLm9wdGlvbnM7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHNjaGVtYSwgb3B0aW9ucyk7CgogICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soc2NoZW1hKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH07CgogICAgQWxwYWNhLkRFRkFVTFRfRVJST1JfQ0FMTEJBQ0sgPSBmdW5jdGlvbihlcnJvcikKICAgIHsKICAgICAgICBpZiAoZXJyb3IgJiYgZXJyb3IubWVzc2FnZSkKICAgICAgICB7CiAgICAgICAgICAgIC8vIGxvZyB0byBkZWJ1ZwogICAgICAgICAgICBBbHBhY2EubG9nRXJyb3IoZXJyb3IubWVzc2FnZSk7CgogICAgICAgICAgICAvLyBlcnJvciBvdXQKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbHBhY2EgY2F1Z2h0IGFuIGVycm9yIHdpdGggdGhlIGRlZmF1bHQgZXJyb3IgaGFuZGxlcjogIiArIGVycm9yLm1lc3NhZ2UpOwoKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogRGVmYXVsdCBlcnJvciBjYWxsYmFjayBoYW5kbGVyIGZvciBBbHBhY2EuCiAgICAgKgogICAgICogVGhpcyBlcnJvciBoYW5kbGVyIHdpbGwgYmUgdXNlZCBpZiBhbiAiZXJyb3IiIGFyZ3VtZW50IGlzbid0IHBhc3NlZCBpbiB0byB0aGUgY29uc3RydWN0b3IgZm9yIGFuIEFscGFjYSBmaWVsZC4KICAgICAqCiAgICAgKiBAcGFyYW0gZXJyb3IKICAgICAqLwogICAgQWxwYWNhLmRlZmF1bHRFcnJvckNhbGxiYWNrID0gQWxwYWNhLkRFRkFVTFRfRVJST1JfQ0FMTEJBQ0s7CgogICAgLyoqCiAgICAgKiBVdGlsaXR5IG1ldGhvZCB0aGF0IHRocm93cyBhIGdlbmVyYWwgZXJyb3IgYW5kIGRpc3BhdGNoZXMgdG8gdGhlIGRlZmF1bHQgZXJyb3IgaGFuZGxlci4KICAgICAqCiAgICAgKiBAcGFyYW0gbWVzc2FnZQogICAgICovCiAgICBBbHBhY2EudGhyb3dEZWZhdWx0RXJyb3IgPSBmdW5jdGlvbihtZXNzYWdlKQogICAgewogICAgICAgIGlmIChtZXNzYWdlICYmIEFscGFjYS5pc09iamVjdChtZXNzYWdlKSkKICAgICAgICB7CiAgICAgICAgICAgIG1lc3NhZ2UgPSBKU09OLnN0cmluZ2lmeShtZXNzYWdlKTsKICAgICAgICB9CgogICAgICAgIHZhciBlcnIgPSB7CiAgICAgICAgICAgICJtZXNzYWdlIjogbWVzc2FnZQogICAgICAgIH07CgogICAgICAgIEFscGFjYS5kZWZhdWx0RXJyb3JDYWxsYmFjayhlcnIpOwogICAgfTsKCiAgICAvKioKICAgICAqIFV0aWxpdHkgbWV0aG9kIHRoYXQgdGhyb3dzIGFuIGVycm9yIGJhY2sgdG8gdGhlIGdpdmVuIGNhbGxiYWNrIGhhbmRsZXIuCiAgICAgKgogICAgICogQHBhcmFtIG1lc3NhZ2UKICAgICAqIEBwYXJhbSBlcnJvckNhbGxiYWNrCiAgICAgKi8KICAgIEFscGFjYS50aHJvd0Vycm9yV2l0aENhbGxiYWNrID0gZnVuY3Rpb24obWVzc2FnZSwgZXJyb3JDYWxsYmFjaykKICAgIHsKICAgICAgICBpZiAobWVzc2FnZSAmJiBBbHBhY2EuaXNPYmplY3QobWVzc2FnZSkpCiAgICAgICAgewogICAgICAgICAgICBtZXNzYWdlID0gSlNPTi5zdHJpbmdpZnkobWVzc2FnZSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgZXJyID0gewogICAgICAgICAgICAibWVzc2FnZSI6IG1lc3NhZ2UKICAgICAgICB9OwoKICAgICAgICBpZiAoZXJyb3JDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIGVycm9yQ2FsbGJhY2soZXJyKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgQWxwYWNhLmRlZmF1bHRFcnJvckNhbGxiYWNrKGVycik7CiAgICAgICAgfQogICAgfTsKCgogICAgLyoqCiAgICAgKiBHaXZlbiBhIGJhc2UgZmllbGQsIHdhbGtzIHRoZSBzY2hlbWEsIG9wdGlvbnMgYW5kIGRhdGEgZm9yd2FyZCB1bnRpbCBpdAogICAgICogZGlzY292ZXJzIHRoZSBnaXZlbiByZWZlcmVuY2UuCiAgICAgKgogICAgICogQHBhcmFtIHNjaGVtYQogICAgICogQHBhcmFtIG9wdGlvbnMKICAgICAqIEBwYXJhbSByZWZlcmVuY2VJZAogICAgICovCiAgICBBbHBhY2EucmVzb2x2ZVJlZmVyZW5jZSA9IGZ1bmN0aW9uKHNjaGVtYSwgb3B0aW9ucywgcmVmZXJlbmNlSWQpCiAgICB7CiAgICAgICAgaWYgKHNjaGVtYS5pZCA9PSByZWZlcmVuY2VJZCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgICAgICAgaWYgKHNjaGVtYSkgewogICAgICAgICAgICAgICAgcmVzdWx0LnNjaGVtYSA9IHNjaGVtYTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9ucykgewogICAgICAgICAgICAgICAgcmVzdWx0Lm9wdGlvbnMgPSBvcHRpb25zOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAoc2NoZW1hICYmIHNjaGVtYS5wcm9wZXJ0aWVzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBwcm9wZXJ0eUlkIGluIHNjaGVtYS5wcm9wZXJ0aWVzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBzdWJTY2hlbWEgPSBzY2hlbWEucHJvcGVydGllc1twcm9wZXJ0eUlkXTsKICAgICAgICAgICAgICAgICAgICB2YXIgc3ViT3B0aW9ucyA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5maWVsZHMgJiYgb3B0aW9ucy5maWVsZHNbcHJvcGVydHlJZF0pCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBzdWJPcHRpb25zID0gb3B0aW9ucy5maWVsZHNbcHJvcGVydHlJZF07CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgeCA9IEFscGFjYS5yZXNvbHZlUmVmZXJlbmNlKHN1YlNjaGVtYSwgc3ViT3B0aW9ucywgcmVmZXJlbmNlSWQpOwogICAgICAgICAgICAgICAgICAgIGlmICh4KQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH07CgogICAgJC5hbHBhY2EgPSB3aW5kb3cuQWxwYWNhID0gQWxwYWNhOwoKICAgIC8qKgogICAgICogalF1ZXJ5IGZyaWVuZGx5IG1ldGhvZCBmb3IgYmluZGluZyBhIGZpZWxkIHRvIGEgRE9NIGVsZW1lbnQuCiAgICAgKiBAaWdub3JlCiAgICAgKi8KICAgICQuZm4uYWxwYWNhID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBBbHBhY2EubWFrZUFycmF5KGFyZ3VtZW50cyk7CgogICAgICAgIC8vIGFwcGVuZCB0aGlzIGludG8gdGhlIGZyb250IG9mIGFyZ3MKICAgICAgICB2YXIgbmV3QXJncyA9IFtdLmNvbmNhdCh0aGlzLCBhcmdzKTsKCiAgICAgICAgLy8gaGFuZCBiYWNrIHRoZSBmaWVsZCBpbnN0YW5jZQogICAgICAgIHJldHVybiBBbHBhY2EuYXBwbHkodGhpcywgbmV3QXJncyk7CiAgICB9OwoKICAgIC8qKgogICAgICogQGlnbm9yZQogICAgICogQHBhcmFtIG5vY2xvbmluZwogICAgICovCiAgICAkLmZuLm91dGVySFRNTCA9IGZ1bmN0aW9uKG5vY2xvbmluZykgewogICAgICAgIGlmIChub2Nsb25pbmcpIHsKICAgICAgICAgICAgcmV0dXJuICQoIjxkaXY+PC9kaXY+IikuYXBwZW5kKHRoaXMpLmh0bWwoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gJCgiPGRpdj48L2Rpdj4iKS5hcHBlbmQodGhpcy5jbG9uZSgpKS5odG1sKCk7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBpZ25vcmUKICAgICAqIEBwYXJhbSB0bwogICAgICovCiAgICAkLmZuLnN3YXBXaXRoID0gZnVuY3Rpb24odG8pIHsKICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgY29weV90byA9ICQodG8pLmNsb25lKCk7CiAgICAgICAgICAgIHZhciBjb3B5X2Zyb20gPSAkKHRoaXMpLmNsb25lKCk7CiAgICAgICAgICAgICQodG8pLnJlcGxhY2VXaXRoKGNvcHlfZnJvbSk7CiAgICAgICAgICAgICQodGhpcykucmVwbGFjZVdpdGgoY29weV90byk7CiAgICAgICAgfSk7CiAgICB9OwoKICAgICQuZm4uYXR0clByb3AgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgIHJldHVybiBBbHBhY2EuYXR0clByb3AoJCh0aGlzKSwgbmFtZSwgdmFsdWUpOwogICAgfTsKCiAgICAvKioKICAgICAqIFdoZW4gZG9tIGVsZW1lbnRzIGFyZSByZW1vdmVkLCB3ZSBmaXJlIHRoZSBzcGVjaWFsICJkZXN0cm95ZWQiIGV2ZW50IHRvIGFsbG93IGZvciBsYXRlIGNsZWFudXAgb2YgYW55IEFscGFjYSBjb2RlCiAgICAgKiB0aGF0IG1pZ2h0IGJlIGluLW1lbW9yeSBhbmQgbGlua2VkIHRvIHRoZSBkb20gZWxlbWVudC4KICAgICAqCiAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICovCiAgICAkLmV2ZW50LnNwZWNpYWwuZGVzdHJveWVkID0gewogICAgICAgIHJlbW92ZTogZnVuY3Rpb24obykgewogICAgICAgICAgICBpZiAoby5oYW5kbGVyKSB7CiAgICAgICAgICAgICAgICBvLmhhbmRsZXIoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgoKICAgIEFscGFjYS5Db3VudGVyc01hcCA9IHt9OwogICAgQWxwYWNhLkNvdW50ZXJzID0gZnVuY3Rpb24obmFtZSkKICAgIHsKICAgICAgICBpZiAoQWxwYWNhLkNvdW50ZXJzW25hbWVdKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5Db3VudGVyc1tuYW1lXTsKICAgICAgICB9CgogICAgICAgIC8vIGNyZWF0ZSBuZXcgY291bnRlcnMKCiAgICAgICAgdmFyIHR5cGVzID0ge307CiAgICAgICAgdmFyIGFsbCA9IHsKICAgICAgICAgICAgY291bnQ6IDAsCiAgICAgICAgICAgIHRvdGFsOiAwLAogICAgICAgICAgICBhdmc6IDAsCiAgICAgICAgICAgIHRvdWNoZXM6IDAKICAgICAgICB9OwoKICAgICAgICB2YXIgY291bnRlcnMgPSB7CgogICAgICAgICAgICBpbmNyZW1lbnQ6IGZ1bmN0aW9uKHR5cGUsIGFtb3VudCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCF0eXBlc1t0eXBlXSkgewogICAgICAgICAgICAgICAgICAgIHR5cGVzW3R5cGVdID0gewogICAgICAgICAgICAgICAgICAgICAgICBjb3VudDogMCwKICAgICAgICAgICAgICAgICAgICAgICAgdG90YWw6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIGF2ZzogMCwKICAgICAgICAgICAgICAgICAgICAgICAgdG91Y2hlczogMAogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdHlwZXNbdHlwZV0uY291bnQrKzsKICAgICAgICAgICAgICAgIHR5cGVzW3R5cGVdLnRvdGFsICs9IGFtb3VudDsKICAgICAgICAgICAgICAgIHR5cGVzW3R5cGVdLmF2ZyA9IHR5cGVzW3R5cGVdLnRvdGFsIC8gdHlwZXNbdHlwZV0uY291bnQ7CiAgICAgICAgICAgICAgICB0eXBlc1t0eXBlXS50b3VjaGVzKys7CgogICAgICAgICAgICAgICAgYWxsLmNvdW50Kys7CiAgICAgICAgICAgICAgICBhbGwudG90YWwgKz0gYW1vdW50OwogICAgICAgICAgICAgICAgYWxsLmF2ZyA9IGFsbC50b3RhbCAvIGFsbC5jb3VudDsKICAgICAgICAgICAgICAgIGFsbC50b3VjaGVzKys7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZWFkOiBmdW5jdGlvbih0eXBlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZXNbdHlwZV07CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBlYWNoOiBmdW5jdGlvbihmKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciB0eXBlIGluIHR5cGVzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGYodHlwZSwgdHlwZXNbdHlwZV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgYWxsOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhbGw7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBBbHBhY2EuQ291bnRlcnNbbmFtZV0gPSBjb3VudGVyczsKCiAgICAgICAgcmV0dXJuIGNvdW50ZXJzOwogICAgfTsKCiAgICBBbHBhY2EuY29sbGVjdFRpbWluZyA9IGZhbHNlOwoKICAgIEFscGFjYS5wYXRoUGFydHMgPSBmdW5jdGlvbihyZXNvdXJjZSkKICAgIHsKICAgICAgICBpZiAodHlwZW9mKHJlc291cmNlKSAhPSAic3RyaW5nIikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiByZXNvdXJjZTsKICAgICAgICB9CgogICAgICAgIC8vIGNvbnZlcnQgc3RyaW5nIHRvIG9iamVjdAogICAgICAgIHZhciByZXNvdXJjZVBhdGggPSByZXNvdXJjZTsKICAgICAgICB2YXIgcmVzb3VyY2VJZCA9IG51bGw7CiAgICAgICAgdmFyIGkgPSByZXNvdXJjZVBhdGguaW5kZXhPZigiIyIpOwogICAgICAgIGlmIChpID4gLTEpCiAgICAgICAgewogICAgICAgICAgICByZXNvdXJjZUlkID0gcmVzb3VyY2VQYXRoLnN1YnN0cmluZyhpICsgMSk7CiAgICAgICAgICAgIHJlc291cmNlUGF0aCA9IHJlc291cmNlUGF0aC5zdWJzdHJpbmcoMCwgaSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoQWxwYWNhLmVuZHNXaXRoKHJlc291cmNlUGF0aCwgIi8iKSkgewogICAgICAgICAgICByZXNvdXJjZVBhdGggPSByZXNvdXJjZVBhdGguc3Vic3RyaW5nKDAsIHJlc291cmNlUGF0aC5sZW5ndGggLSAxKTsKICAgICAgICB9CgogICAgICAgIHZhciBwYXJ0cyA9IHt9OwogICAgICAgIHBhcnRzLnBhdGggPSByZXNvdXJjZVBhdGg7CgogICAgICAgIGlmIChyZXNvdXJjZUlkKQogICAgICAgIHsKICAgICAgICAgICAgcGFydHMuaWQgPSByZXNvdXJjZUlkOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHBhcnRzOwogICAgfTsKCiAgICAvKioKICAgICAqIFJlc29sdmVzIGEgZmllbGQgYnkgaXRzIHByb3BlcnR5IGlkLgogICAgICoKICAgICAqIEBwYXJhbSBjb250YWluZXJGaWVsZAogICAgICogQHBhcmFtIHByb3BlcnR5SWQKICAgICAqIEByZXR1cm5zIHtudWxsfQogICAgICovCiAgICBBbHBhY2EucmVzb2x2ZUZpZWxkID0gZnVuY3Rpb24oY29udGFpbmVyRmllbGQsIHByb3BlcnR5SWRPclJlZmVyZW5jZUlkKQogICAgewogICAgICAgIHZhciByZXNvbHZlZEZpZWxkID0gbnVsbDsKCiAgICAgICAgaWYgKHR5cGVvZihwcm9wZXJ0eUlkT3JSZWZlcmVuY2VJZCkgPT0gInN0cmluZyIpCiAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcGVydHlJZE9yUmVmZXJlbmNlSWQuaW5kZXhPZigiIy8iKSA9PSAwICYmIHByb3BlcnR5SWQubGVuZ3RoID4gMikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gVE9ETzogcGF0aCBiYXNlZCBsb29rdXA/CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAocHJvcGVydHlJZE9yUmVmZXJlbmNlSWQgPT0gIiMiIHx8IHByb3BlcnR5SWRPclJlZmVyZW5jZUlkID09ICIjLyIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJlc29sdmVkRmllbGQgPSBjb250YWluZXJGaWVsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChwcm9wZXJ0eUlkT3JSZWZlcmVuY2VJZC5pbmRleE9mKCIjIikgPT0gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gcmVmZXJlbmNlIGlkIGxvb2t1cAoKICAgICAgICAgICAgICAgIC8vIGZpbmQgdGhlIHRvcCBmaWVsZAogICAgICAgICAgICAgICAgdmFyIHRvcEZpZWxkID0gY29udGFpbmVyRmllbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAodG9wRmllbGQucGFyZW50KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRvcEZpZWxkID0gdG9wRmllbGQucGFyZW50OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciByZWZlcmVuY2VJZCA9IHByb3BlcnR5SWRPclJlZmVyZW5jZUlkLnN1YnN0cmluZygxKTsKCiAgICAgICAgICAgICAgICByZXNvbHZlZEZpZWxkID0gQWxwYWNhLnJlc29sdmVGaWVsZEJ5UmVmZXJlbmNlKHRvcEZpZWxkLCByZWZlcmVuY2VJZCk7CgogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gcHJvcGVydHkgbG9va3VwCiAgICAgICAgICAgICAgICByZXNvbHZlZEZpZWxkID0gY29udGFpbmVyRmllbGQuY2hpbGRyZW5CeVByb3BlcnR5SWRbcHJvcGVydHlJZE9yUmVmZXJlbmNlSWRdOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzb2x2ZWRGaWVsZDsKICAgIH07CgogICAgLyoqCiAgICAgKiBSZXNvbHZlcyBhIGZpZWxkIGJhc2VkIG9uIGl0cyAicmVmZXJlbmNlIGlkIiByZWxhdGl2ZSB0byBhIHRvcCBsZXZlbCBmaWVsZC4gIFRoaXMgd2Fsa3MgZG93biB0aGUgZmllbGQgdHJlZSBhbmQKICAgICAqIGxvb2tzIGZvciBtYXRjaGluZyBzY2hlbWEuaWQgcmVmZXJlbmNlcyB0byBmaW5kIHRoZSBtYXRjaGluZyBmaWVsZC4KICAgICAqCiAgICAgKiBAcGFyYW0gZmllbGQKICAgICAqIEBwYXJhbSByZWZlcmVuY2VJZAogICAgICovCiAgICBBbHBhY2EucmVzb2x2ZUZpZWxkQnlSZWZlcmVuY2UgPSBmdW5jdGlvbihmaWVsZCwgcmVmZXJlbmNlSWQpCiAgICB7CiAgICAgICAgaWYgKGZpZWxkLnNjaGVtYSAmJiBmaWVsZC5zY2hlbWEuaWQgPT0gcmVmZXJlbmNlSWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmllbGQ7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmIChmaWVsZC5jaGlsZHJlbiAmJiBmaWVsZC5jaGlsZHJlbi5sZW5ndGggPiAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZpZWxkLmNoaWxkcmVuLmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpZWxkLmNoaWxkcmVuW2ldOwoKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWQgPSBBbHBhY2EucmVzb2x2ZUZpZWxkQnlSZWZlcmVuY2UoY2hpbGQsIHJlZmVyZW5jZUlkKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmVzb2x2ZWQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH07CgogICAgLyoqCiAgICAgKiBEZXRlcm1pbmVzIHdoZXRoZXIgYW55IG9mIHRoZSBlbGVtZW50cyBvZiB0aGUgZmlyc3QgYXJndW1lbnQgYXJlIGVxdWFsIHRvIHRoZSBlbGVtZW50cyBvZiB0aGUgc2Vjb25kIGFyZ3VtZW50LgogICAgICoKICAgICAqIEBwYXJhbSBmaXJzdCBlaXRoZXIgYSBzY2FsYXIgdmFsdWUgb3IgYSBjb250YWluZXIgKG9iamVjdCBvciBhcnJheSkgb2YgdmFsdWVzCiAgICAgKiBAcGFyYW0gc2Vjb25kIGVpdGhlciBhIHNjYWxhciB2YWx1ZSBvciBhIGNvbnRhaW5lciAob2JqZWN0IG9yIGFycmF5KSBvZiB2YWx1ZXMKICAgICAqIEByZXR1cm5zIHdoZXRoZXIgYXQgbGVhc3Qgb25lIG1hdGNoIGlzIGZvdW5kCiAgICAgKi8KICAgIEFscGFjYS5hbnlFcXVhbGl0eSA9IGZ1bmN0aW9uKGZpcnN0LCBzZWNvbmQpCiAgICB7CiAgICAgICAgLy8gY29weSB2YWx1ZXMgZnJvbSBmaXJzdCBpbnRvIGEgdmFsdWVzIGxvb2t1cCBtYXAKICAgICAgICB2YXIgdmFsdWVzID0ge307CiAgICAgICAgaWYgKHR5cGVvZihmaXJzdCkgPT0gIm9iamVjdCIgfHwgdHlwZW9mKGZpcnN0KSA9PSAiYXJyYXkiKQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgayBpbiBmaXJzdCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFsdWVzW2ZpcnN0W2tdXSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdmFsdWVzW2ZpcnN0XSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB2YXIgcmVzdWx0ID0gZmFsc2U7CgogICAgICAgIC8vIGNoZWNrIHZhbHVlcyBmcm9tIHNlY29uZCBhZ2FpbnN0IHRoZSBsb29rdXAgbWFwCiAgICAgICAgaWYgKHR5cGVvZihzZWNvbmQpID09ICJvYmplY3QiIHx8IHR5cGVvZihzZWNvbmQpID09ICJhcnJheSIpCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciBrIGluIHNlY29uZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHYgPSBzZWNvbmRba107CgogICAgICAgICAgICAgICAgaWYgKHZhbHVlc1t2XSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJlc3VsdCA9IHZhbHVlc1tzZWNvbmRdOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CgogICAgQWxwYWNhLnNlcmllcyA9IGZ1bmN0aW9uKGZ1bmNzLCBjYWxsYmFjaykKICAgIHsKICAgICAgICBhc3luYy5zZXJpZXMoZnVuY3MsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgIH0pOwogICAgfTsKCiAgICBBbHBhY2EucGFyYWxsZWwgPSBmdW5jdGlvbihmdW5jcywgY2FsbGJhY2spCiAgICB7CiAgICAgICAgYXN5bmMucGFyYWxsZWwoZnVuY3MsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgIH0pOwogICAgfTsKCiAgICBBbHBhY2EubmV4dFRpY2sgPSBmdW5jdGlvbihmKQogICAgewogICAgICAgIGFzeW5jLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmKCk7CiAgICAgICAgfSk7CiAgICB9OwoKICAgIC8qKgogICAgICogQ29tcGlsZXMgdGhlIHZhbGlkYXRpb24gY29udGV4dCBmb3IgdGhlIGNoYWluIG9mIGZpZWxkcyBmcm9tIHRoZSB0b3AtbW9zdCBkb3duIHRvIHRoZSBnaXZlbiBmaWVsZC4KICAgICAqIEVhY2ggdmFsaWRhdGlvbiBjb250ZXh0IGVudHJ5IGlzIGEgZmllbGQgaW4gdGhlIGNoYWluIHdoaWNoIGRlc2NyaWJlcyB0aGUgZm9sbG93aW5nOgogICAgICoKICAgICAqICAgIHsKICAgICAqICAgICAgICJmaWVsZCI6IHRoZSBmaWVsZCBpbnN0YW5jZSwKICAgICAqICAgICAgICJiZWZvcmUiOiB0aGUgYmVmb3JlIHZhbHVlIChib29sZWFuKQogICAgICogICAgICAgImFmdGVyIjogdGhlIGFmdGVyIHZhbHVlIChib29sZWFuKQogICAgICogICAgICAgInZhbGlkYXRlZCI6IChvcHRpb25hbCkgaWYgdGhlIGZpZWxkIHZhbGlkYXRlZCAoc3dpdGNoZXMgc3RhdGUgZnJvbSBpbnZhbGlkIHRvIHZhbGlkKQogICAgICogICAgICAgImludmFsaWRhdGVkIjogKG9wdGlvbmFsKSBpZiB0aGUgZmllbGQgaW52YWxpZGF0ZWQgKHN3aXRjaGVzIHN0YXRlIGZyb20gdmFsaWQgdG8gaW52YWxpZCkKICAgICAqICAgIH0KICAgICAqCiAgICAgKiBUaGlzIGhhbmRzIGJhY2sgYW4gYXJyYXkgb2YgZW50cmllcyB3aXRoIHRoZSBjaGlsZCBmaWVsZCBmaXJzdCBhbmQgY29udGludWluZyB1cCB0aGUgcGFyZW50IGNoYWluLgogICAgICogVGhlIGxhc3QgZW50cnkgaW4gdGhlIGFycmF5IGlzIHRoZSB0b3AgbW9zdCBwYXJlbnQgZmllbGQuCiAgICAgKgogICAgICogQHBhcmFtIGZpZWxkCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9CiAgICAgKi8KICAgIEFscGFjYS5jb21waWxlVmFsaWRhdGlvbkNvbnRleHQgPSBmdW5jdGlvbihmaWVsZCkKICAgIHsKICAgICAgICAvLyB3YWxrIHVwIHRoZSBwYXJlbnQgdHJlZSB1bnRpbCB3ZSBmaW5kIHRoZSB0b3AtbW9zdCBjb250cm9sCiAgICAgICAgLy8gdGhpcyBzZXJ2ZXMgYXMgb3VyIHN0YXJ0aW5nIHBvaW50IGZvciBkb3dud2FyZCB2YWxpZGF0aW9uCiAgICAgICAgdmFyIGNoYWluID0gW107CiAgICAgICAgdmFyIHBhcmVudCA9IGZpZWxkOwogICAgICAgIGRvCiAgICAgICAgewogICAgICAgICAgICBpZiAoIXBhcmVudC5pc1ZhbGlkYXRpb25QYXJ0aWNpcGFudCgpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBwYXJlbnQgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAocGFyZW50KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGFpbi5wdXNoKHBhcmVudCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChwYXJlbnQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgd2hpbGUgKHBhcmVudCk7CgogICAgICAgIC8vIHJldmVyc2Ugc28gdG9wIG1vc3QgcGFyZW50IGlzIGZpcnN0CiAgICAgICAgY2hhaW4ucmV2ZXJzZSgpOwoKICAgICAgICAvLyBjb21waWxhdGlvbiBjb250ZXh0CiAgICAgICAgdmFyIGNvbnRleHQgPSBbXTsKCiAgICAgICAgLy8gaW50ZXJuYWwgbWV0aG9kIHRoYXQgc2V0cyB2YWxpZGF0aW9uIGZvciBhIHNpbmdsZSBmaWVsZAogICAgICAgIHZhciBmID0gZnVuY3Rpb24oY2hhaW4sIGNvbnRleHQpCiAgICAgICAgewogICAgICAgICAgICBpZiAoIWNoYWluIHx8IGNoYWluLmxlbmd0aCA9PSAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBjdXJyZW50ID0gY2hhaW5bMF07CgogICAgICAgICAgICB2YXIgZW50cnkgPSB7fTsKICAgICAgICAgICAgZW50cnkuaWQgPSBjdXJyZW50LmdldElkKCk7CiAgICAgICAgICAgIGVudHJ5LmZpZWxkID0gY3VycmVudDsKICAgICAgICAgICAgZW50cnkucGF0aCA9IGN1cnJlbnQucGF0aDsKCiAgICAgICAgICAgIC8vIEJFRk9SRSBmaWVsZCB2YWxpZGF0aW9uIHN0YXR1cwogICAgICAgICAgICB2YXIgYmVmb3JlU3RhdHVzID0gY3VycmVudC5pc1ZhbGlkKCk7CiAgICAgICAgICAgIGlmIChjdXJyZW50LmlzQ29udGFpbmVyKCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGJlZm9yZVN0YXR1cyA9IGN1cnJlbnQuaXNWYWxpZCh0cnVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZW50cnkuYmVmb3JlID0gYmVmb3JlU3RhdHVzOwoKICAgICAgICAgICAgLy8gc3RlcCBkb3duIGludG8gY2hhaW4KICAgICAgICAgICAgaWYgKGNoYWluLmxlbmd0aCA+IDEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIGNvcHkgYXJyYXkKICAgICAgICAgICAgICAgIHZhciBjaGlsZENoYWluID0gY2hhaW4uc2xpY2UoMCk7CiAgICAgICAgICAgICAgICBjaGlsZENoYWluLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICBmKGNoaWxkQ2hhaW4sIGNvbnRleHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgcHJldmlvdXNseVZhbGlkYXRlZCA9IGN1cnJlbnQuX3ByZXZpb3VzbHlWYWxpZGF0ZWQ7CgogICAgICAgICAgICAvLyBub3cgcnVuIHRoZSB2YWxpZGF0aW9uIGZvciBqdXN0IHRoaXMgb25lIGZpZWxkCiAgICAgICAgICAgIGN1cnJlbnQudmFsaWRhdGUoKTsKCiAgICAgICAgICAgIC8vIGFwcGx5IGN1c3RvbSB2YWxpZGF0aW9uIChpZiBleGlzdHMpIGZvciBqdXN0IHRoaXMgb25lIGZpZWxkCiAgICAgICAgICAgIGN1cnJlbnQuX3ZhbGlkYXRlQ3VzdG9tVmFsaWRhdG9yKGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgIC8vIEFGVEVSIGZpZWxkIHZhbGlkYXRpb24gc3RhdGUKICAgICAgICAgICAgICAgIHZhciBhZnRlclN0YXR1cyA9IGN1cnJlbnQuaXNWYWxpZCgpOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQuaXNDb250YWluZXIoKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBhZnRlclN0YXR1cyA9IGN1cnJlbnQuaXNWYWxpZCh0cnVlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBlbnRyeS5hZnRlciA9IGFmdGVyU3RhdHVzOwoKICAgICAgICAgICAgICAgIC8vIGlmIHRoaXMgZmllbGQncyB2YWxpZGF0aW9uIHN0YXR1cyBmbGlwcGVkLCBmaXJlIHRyaWdnZXJzCiAgICAgICAgICAgICAgICBlbnRyeS52YWxpZGF0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGVudHJ5LmludmFsaWRhdGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAoIWJlZm9yZVN0YXR1cyAmJiBhZnRlclN0YXR1cykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBlbnRyeS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoYmVmb3JlU3RhdHVzICYmICFhZnRlclN0YXR1cykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBlbnRyeS5pbnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBzcGVjaWFsIGNhc2UgZm9yIGZpZWxkcyB0aGF0IGhhdmUgbm90IHlldCBiZWVuIHZhbGlkYXRlZAogICAgICAgICAgICAgICAgZWxzZSBpZiAoIXByZXZpb3VzbHlWYWxpZGF0ZWQgJiYgIWFmdGVyU3RhdHVzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGVudHJ5LmludmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBlbnRyeS5jb250YWluZXIgPSBjdXJyZW50LmlzQ29udGFpbmVyKCk7OwogICAgICAgICAgICAgICAgZW50cnkudmFsaWQgPSBlbnRyeS5hZnRlcjsKCiAgICAgICAgICAgICAgICBjb250ZXh0LnB1c2goZW50cnkpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBmKGNoYWluLCBjb250ZXh0KTsKCiAgICAgICAgcmV0dXJuIGNvbnRleHQ7CiAgICB9OwoKICAgIEFscGFjYS51cGRhdGVWYWxpZGF0aW9uU3RhdGVGb3JDb250ZXh0ID0gZnVuY3Rpb24oY29udGV4dCkKICAgIHsKICAgICAgICAvLyB3YWxrIHRocm91Z2ggZWFjaCBhbmQgZmxpcCBhbnkgRE9NIFVJIGJhc2VkIG9uIGVudHJ5IHN0YXRlCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb250ZXh0Lmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGVudHJ5ID0gY29udGV4dFtpXTsKICAgICAgICAgICAgdmFyIGZpZWxkID0gZW50cnkuZmllbGQ7CgogICAgICAgICAgICAvLyBjbGVhciBvdXQgcHJldmlvdXMgdmFsaWRhdGlvbiBVSSBtYXJrZXJzCiAgICAgICAgICAgIGZpZWxkLmdldFN0eWxlSW5qZWN0aW9uKCJyZW1vdmVFcnJvciIsIGZpZWxkLmdldEVsKCkpOwogICAgICAgICAgICBmaWVsZC5nZXRFbCgpLnJlbW92ZUNsYXNzKCJhbHBhY2EtZmllbGQtaW52YWxpZCBhbHBhY2EtZmllbGQtaW52YWxpZC1oaWRkZW4gYWxwYWNhLWZpZWxkLXZhbGlkIik7CgogICAgICAgICAgICB2YXIgc2hvd01lc3NhZ2VzID0gZmFsc2U7CgogICAgICAgICAgICAvLyB2YWxpZD8KICAgICAgICAgICAgaWYgKGVudHJ5LnZhbGlkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmaWVsZC5nZXRFbCgpLmFkZENsYXNzKCJhbHBhY2EtZmllbGQtdmFsaWQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIHdlIGRvbid0IG1hcmt1cCBpbnZhbGlkYXRpb24gc3RhdGUgZm9yIHJlYWRvbmx5IGZpZWxkcwogICAgICAgICAgICAgICAgaWYgKCFmaWVsZC5vcHRpb25zLnJlYWRvbmx5KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICghZmllbGQuaGlkZUluaXRWYWxpZGF0aW9uRXJyb3IpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBmaWVsZC5nZXRTdHlsZUluamVjdGlvbigiZXJyb3IiLCBmaWVsZC5nZXRFbCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGQuZ2V0RWwoKS5hZGRDbGFzcygiYWxwYWNhLWZpZWxkLWludmFsaWQiKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHNob3dNZXNzYWdlcyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkLmdldEVsKCkuYWRkQ2xhc3MoImFscGFjYS1maWVsZC1pbnZhbGlkLWhpZGRlbiIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIGZpZWxkIGlzIGludmFsaWQgYW5kIGlzIGFsc28gcmVhZC1vbmx5LCBzbyB3ZSdyZSBub3Qgc3VwcG9zZWQgdG8gaW5mb3JtIHRoZSBlbmQtdXNlcgogICAgICAgICAgICAgICAgICAgIC8vIHdpdGhpbiB0aGUgVUkgKHNpbmNlIHRoZXJlIGlzIG5vdGhpbmcgd2UgY2FuIGRvIGFib3V0IGl0KQogICAgICAgICAgICAgICAgICAgIC8vIGhlcmUsIHdlIGxvZyBhIG1lc3NhZ2UgdG8gZGVidWcgdG8gaW5mb3JtIHRoZSBkZXZlbG9wZXIKICAgICAgICAgICAgICAgICAgICBBbHBhY2EubG9nV2FybigiVGhlIGZpZWxkIChpZD0iICsgZmllbGQuZ2V0SWQoKSArICIsIHRpdGxlPSIgKyBmaWVsZC5nZXRUaXRsZSgpICsgIiwgcGF0aD0iICsgZmllbGQucGF0aCArICIpIGlzIGludmFsaWQgYW5kIGFsc28gcmVhZC1vbmx5Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFRSSUdHRVJTCiAgICAgICAgICAgIGlmIChlbnRyeS52YWxpZGF0ZWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIEFscGFjYS5sYXRlcigyNSwgdGhpcywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgZmllbGQudHJpZ2dlcigidmFsaWRhdGVkIik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChlbnRyeS5pbnZhbGlkYXRlZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgQWxwYWNhLmxhdGVyKDI1LCB0aGlzLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBmaWVsZC50cmlnZ2VyKCJpbnZhbGlkYXRlZCIpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFsbG93IGZvciB0aGUgbWVzc2FnZSB0byBjaGFuZ2UKICAgICAgICAgICAgaWYgKGZpZWxkLm9wdGlvbnMuc2hvd01lc3NhZ2VzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWZpZWxkLmluaXRpYWxpemluZykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBkb24ndCBtYXJrdXAgaW52YWxpZGF0aW9uIHN0YXRlIGZvciByZWFkb25seSBmaWVsZHMKICAgICAgICAgICAgICAgICAgICBpZiAoIWZpZWxkLm9wdGlvbnMucmVhZG9ubHkpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBtZXNzYWdlcwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbWVzc2FnZXMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgbWVzc2FnZUlkIGluIGZpZWxkLnZhbGlkYXRpb24pCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZmllbGQudmFsaWRhdGlvblttZXNzYWdlSWRdWyJzdGF0dXMiXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlcy5wdXNoKGZpZWxkLnZhbGlkYXRpb25bbWVzc2FnZUlkXVsibWVzc2FnZSJdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGQuZGlzcGxheU1lc3NhZ2UobWVzc2FnZXMsIGZpZWxkLnZhbGlkKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChzaG93TWVzc2FnZXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZpZWxkLnNob3dIaWRkZW5NZXNzYWdlcygpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIFJ1bnMgdGhlIGdpdmVuIGZ1bmN0aW9uIG92ZXIgdGhlIGZpZWxkIGFuZCBhbGwgb2YgaXRzIGNoaWxkcmVuIHJlY3Vyc2l2ZWx5LgogICAgICoKICAgICAqIEBwYXJhbSBmaWVsZAogICAgICogQHBhcmFtIGZuCiAgICAgKi8KICAgIEFscGFjYS5maWVsZEFwcGx5Q2hpbGRyZW4gPSBmdW5jdGlvbihmaWVsZCwgZm4pCiAgICB7CiAgICAgICAgdmFyIGYgPSBmdW5jdGlvbihmaWVsZCwgZm4pCiAgICAgICAgewogICAgICAgICAgICAvLyBpZiB0aGUgZmllbGQgaGFzIGNoaWxkcmVuLCBnbyBkZXB0aCBmaXJzdAogICAgICAgICAgICBpZiAoZmllbGQuY2hpbGRyZW4gJiYgZmllbGQuY2hpbGRyZW4ubGVuZ3RoID4gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmaWVsZC5jaGlsZHJlbi5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBmbihmaWVsZC5jaGlsZHJlbltpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBmKGZpZWxkLCBmbik7CiAgICB9OwoKCgoKCgoKCgoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vCiAgICAvLyBBU1lOQwogICAgLy8KICAgIC8vIEhlcmUgd2UgcHJvdmlkZSBhIHJlZHVjZWQgdmVyc2lvbiBvZiB0aGUgd29uZGVyZnVsIGFzeW5jIGxpYnJhcnkuICBUaGlzIGlzIGVudGlyZWx5IGlubGluZSBhbmQKICAgIC8vIHdpbGwgaGF2ZSBubyBiZWFyaW5nIG9uIGFueSBleHRlcm5hbCBkZXBlbmRlbmNpZXMgb24gYXN5bmMuCiAgICAvLwogICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2Nhb2xhbi9hc3luYwogICAgLy8gQ29weXJpZ2h0IChjKSAyMDEwIENhb2xhbiBNY01haG9uCiAgICAvLwogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8qZ2xvYmFsIHNldEltbWVkaWF0ZTogZmFsc2UsIHNldFRpbWVvdXQ6IGZhbHNlLCBjb25zb2xlOiBmYWxzZSAqLwogICAgKGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIGFzeW5jID0ge307CgogICAgICAgIC8vIGdsb2JhbCBvbiB0aGUgc2VydmVyLCB3aW5kb3cgaW4gdGhlIGJyb3dzZXIKICAgICAgICB2YXIgcm9vdCwgcHJldmlvdXNfYXN5bmM7CgogICAgICAgIHJvb3QgPSB0aGlzOwogICAgICAgIGlmIChyb290ICE9IG51bGwpIHsKICAgICAgICAgICAgcHJldmlvdXNfYXN5bmMgPSByb290LmFzeW5jOwogICAgICAgIH0KCiAgICAgICAgYXN5bmMubm9Db25mbGljdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcm9vdC5hc3luYyA9IHByZXZpb3VzX2FzeW5jOwogICAgICAgICAgICByZXR1cm4gYXN5bmM7CiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gb25seV9vbmNlKGZuKSB7CiAgICAgICAgICAgIHZhciBjYWxsZWQgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKGNhbGxlZCkgdGhyb3cgbmV3IEVycm9yKCJDYWxsYmFjayB3YXMgYWxyZWFkeSBjYWxsZWQuIik7CiAgICAgICAgICAgICAgICBjYWxsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgZm4uYXBwbHkocm9vdCwgYXJndW1lbnRzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8vLyBjcm9zcy1icm93c2VyIGNvbXBhdGlibGl0eSBmdW5jdGlvbnMgLy8vLwoKICAgICAgICB2YXIgX2VhY2ggPSBmdW5jdGlvbiAoYXJyLCBpdGVyYXRvcikgewogICAgICAgICAgICBpZiAoYXJyLmZvckVhY2gpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhcnIuZm9yRWFjaChpdGVyYXRvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgICAgICAgIGl0ZXJhdG9yKGFycltpXSwgaSwgYXJyKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHZhciBfbWFwID0gZnVuY3Rpb24gKGFyciwgaXRlcmF0b3IpIHsKICAgICAgICAgICAgaWYgKGFyci5tYXApIHsKICAgICAgICAgICAgICAgIHJldHVybiBhcnIubWFwKGl0ZXJhdG9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgICAgICAgICBfZWFjaChhcnIsIGZ1bmN0aW9uICh4LCBpLCBhKSB7CiAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2goaXRlcmF0b3IoeCwgaSwgYSkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIF9yZWR1Y2UgPSBmdW5jdGlvbiAoYXJyLCBpdGVyYXRvciwgbWVtbykgewogICAgICAgICAgICBpZiAoYXJyLnJlZHVjZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGFyci5yZWR1Y2UoaXRlcmF0b3IsIG1lbW8pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF9lYWNoKGFyciwgZnVuY3Rpb24gKHgsIGksIGEpIHsKICAgICAgICAgICAgICAgIG1lbW8gPSBpdGVyYXRvcihtZW1vLCB4LCBpLCBhKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBtZW1vOwogICAgICAgIH07CgogICAgICAgIHZhciBfa2V5cyA9IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgaWYgKE9iamVjdC5rZXlzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMob2JqKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIga2V5cyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBrIGluIG9iaikgewogICAgICAgICAgICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrKSkgewogICAgICAgICAgICAgICAgICAgIGtleXMucHVzaChrKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4ga2V5czsKICAgICAgICB9OwoKICAgICAgICAvLy8vIGV4cG9ydGVkIGFzeW5jIG1vZHVsZSBmdW5jdGlvbnMgLy8vLwoKICAgICAgICAvLy8vIG5leHRUaWNrIGltcGxlbWVudGF0aW9uIHdpdGggYnJvd3Nlci1jb21wYXRpYmxlIGZhbGxiYWNrIC8vLy8KICAgICAgICBpZiAodHlwZW9mIHByb2Nlc3MgPT09ICd1bmRlZmluZWQnIHx8ICEocHJvY2Vzcy5uZXh0VGljaykpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBzZXRJbW1lZGlhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIGFzeW5jLm5leHRUaWNrID0gZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gbm90IGEgZGlyZWN0IGFsaWFzIGZvciBJRTEwIGNvbXBhdGliaWxpdHkKICAgICAgICAgICAgICAgICAgICBzZXRJbW1lZGlhdGUoZm4pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGFzeW5jLnNldEltbWVkaWF0ZSA9IGFzeW5jLm5leHRUaWNrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgYXN5bmMubmV4dFRpY2sgPSBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZuLCAwKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBhc3luYy5zZXRJbW1lZGlhdGUgPSBhc3luYy5uZXh0VGljazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgYXN5bmMubmV4dFRpY2sgPSBwcm9jZXNzLm5leHRUaWNrOwogICAgICAgICAgICBpZiAodHlwZW9mIHNldEltbWVkaWF0ZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgIGFzeW5jLnNldEltbWVkaWF0ZSA9IGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgICAgIC8vIG5vdCBhIGRpcmVjdCBhbGlhcyBmb3IgSUUxMCBjb21wYXRpYmlsaXR5CiAgICAgICAgICAgICAgICAgICAgc2V0SW1tZWRpYXRlKGZuKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBhc3luYy5zZXRJbW1lZGlhdGUgPSBhc3luYy5uZXh0VGljazsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgYXN5bmMuZWFjaCA9IGZ1bmN0aW9uIChhcnIsIGl0ZXJhdG9yLCBjYWxsYmFjaykgewogICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrIHx8IGZ1bmN0aW9uICgpIHt9OwogICAgICAgICAgICBpZiAoIWFyci5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjaygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb21wbGV0ZWQgPSAwOwogICAgICAgICAgICBfZWFjaChhcnIsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICBpdGVyYXRvcih4LCBvbmx5X29uY2UoZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbiAoKSB7fTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBsZXRlZCArPSAxOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29tcGxldGVkID49IGFyci5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIGFzeW5jLmZvckVhY2ggPSBhc3luYy5lYWNoOwoKICAgICAgICBhc3luYy5lYWNoU2VyaWVzID0gZnVuY3Rpb24gKGFyciwgaXRlcmF0b3IsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgfHwgZnVuY3Rpb24gKCkge307CiAgICAgICAgICAgIGlmICghYXJyLmxlbmd0aCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbXBsZXRlZCA9IDA7CiAgICAgICAgICAgIHZhciBpdGVyYXRlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaXRlcmF0b3IoYXJyW2NvbXBsZXRlZF0sIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24gKCkge307CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZWQgKz0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBsZXRlZCA+PSBhcnIubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZXJhdGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwogICAgICAgICAgICBpdGVyYXRlKCk7CiAgICAgICAgfTsKICAgICAgICBhc3luYy5mb3JFYWNoU2VyaWVzID0gYXN5bmMuZWFjaFNlcmllczsKCiAgICAgICAgYXN5bmMuZWFjaExpbWl0ID0gZnVuY3Rpb24gKGFyciwgbGltaXQsIGl0ZXJhdG9yLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgZm4gPSBfZWFjaExpbWl0KGxpbWl0KTsKICAgICAgICAgICAgZm4uYXBwbHkobnVsbCwgW2FyciwgaXRlcmF0b3IsIGNhbGxiYWNrXSk7CiAgICAgICAgfTsKICAgICAgICBhc3luYy5mb3JFYWNoTGltaXQgPSBhc3luYy5lYWNoTGltaXQ7CgogICAgICAgIHZhciBfZWFjaExpbWl0ID0gZnVuY3Rpb24gKGxpbWl0KSB7CgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGFyciwgaXRlcmF0b3IsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrIHx8IGZ1bmN0aW9uICgpIHt9OwogICAgICAgICAgICAgICAgaWYgKCFhcnIubGVuZ3RoIHx8IGxpbWl0IDw9IDApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjb21wbGV0ZWQgPSAwOwogICAgICAgICAgICAgICAgdmFyIHN0YXJ0ZWQgPSAwOwogICAgICAgICAgICAgICAgdmFyIHJ1bm5pbmcgPSAwOwoKICAgICAgICAgICAgICAgIChmdW5jdGlvbiByZXBsZW5pc2ggKCkgewogICAgICAgICAgICAgICAgICAgIGlmIChjb21wbGV0ZWQgPj0gYXJyLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHdoaWxlIChydW5uaW5nIDwgbGltaXQgJiYgc3RhcnRlZCA8IGFyci5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRlZCArPSAxOwogICAgICAgICAgICAgICAgICAgICAgICBydW5uaW5nICs9IDE7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZXJhdG9yKGFycltzdGFydGVkIC0gMV0sIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24gKCkge307CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZWQgKz0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBydW5uaW5nIC09IDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBsZXRlZCA+PSBhcnIubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsZW5pc2goKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pKCk7CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKCgogICAgICAgIHZhciBkb1BhcmFsbGVsID0gZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICByZXR1cm4gZm4uYXBwbHkobnVsbCwgW2FzeW5jLmVhY2hdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICB2YXIgZG9QYXJhbGxlbExpbWl0ID0gZnVuY3Rpb24obGltaXQsIGZuKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICByZXR1cm4gZm4uYXBwbHkobnVsbCwgW19lYWNoTGltaXQobGltaXQpXS5jb25jYXQoYXJncykpOwogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICAgICAgdmFyIGRvU2VyaWVzID0gZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICByZXR1cm4gZm4uYXBwbHkobnVsbCwgW2FzeW5jLmVhY2hTZXJpZXNdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKCgogICAgICAgIHZhciBfYXN5bmNNYXAgPSBmdW5jdGlvbiAoZWFjaGZuLCBhcnIsIGl0ZXJhdG9yLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgICAgICAgICBhcnIgPSBfbWFwKGFyciwgZnVuY3Rpb24gKHgsIGkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB7aW5kZXg6IGksIHZhbHVlOiB4fTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGVhY2hmbihhcnIsIGZ1bmN0aW9uICh4LCBjYWxsYmFjaykgewogICAgICAgICAgICAgICAgaXRlcmF0b3IoeC52YWx1ZSwgZnVuY3Rpb24gKGVyciwgdikgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdHNbeC5pbmRleF0gPSB2OwogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyLCByZXN1bHRzKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICBhc3luYy5tYXAgPSBkb1BhcmFsbGVsKF9hc3luY01hcCk7CiAgICAgICAgYXN5bmMubWFwU2VyaWVzID0gZG9TZXJpZXMoX2FzeW5jTWFwKTsKICAgICAgICBhc3luYy5tYXBMaW1pdCA9IGZ1bmN0aW9uIChhcnIsIGxpbWl0LCBpdGVyYXRvciwgY2FsbGJhY2spIHsKICAgICAgICAgICAgcmV0dXJuIF9tYXBMaW1pdChsaW1pdCkoYXJyLCBpdGVyYXRvciwgY2FsbGJhY2spOwogICAgICAgIH07CgogICAgICAgIHZhciBfbWFwTGltaXQgPSBmdW5jdGlvbihsaW1pdCkgewogICAgICAgICAgICByZXR1cm4gZG9QYXJhbGxlbExpbWl0KGxpbWl0LCBfYXN5bmNNYXApOwogICAgICAgIH07CgogICAgICAgIC8vIHJlZHVjZSBvbmx5IGhhcyBhIHNlcmllcyB2ZXJzaW9uLCBhcyBkb2luZyByZWR1Y2UgaW4gcGFyYWxsZWwgd29uJ3QKICAgICAgICAvLyB3b3JrIGluIG1hbnkgc2l0dWF0aW9ucy4KICAgICAgICBhc3luYy5yZWR1Y2UgPSBmdW5jdGlvbiAoYXJyLCBtZW1vLCBpdGVyYXRvciwgY2FsbGJhY2spIHsKICAgICAgICAgICAgYXN5bmMuZWFjaFNlcmllcyhhcnIsIGZ1bmN0aW9uICh4LCBjYWxsYmFjaykgewogICAgICAgICAgICAgICAgaXRlcmF0b3IobWVtbywgeCwgZnVuY3Rpb24gKGVyciwgdikgewogICAgICAgICAgICAgICAgICAgIG1lbW8gPSB2OwogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyLCBtZW1vKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICAvLyBpbmplY3QgYWxpYXMKICAgICAgICBhc3luYy5pbmplY3QgPSBhc3luYy5yZWR1Y2U7CiAgICAgICAgLy8gZm9sZGwgYWxpYXMKICAgICAgICBhc3luYy5mb2xkbCA9IGFzeW5jLnJlZHVjZTsKCiAgICAgICAgYXN5bmMucmVkdWNlUmlnaHQgPSBmdW5jdGlvbiAoYXJyLCBtZW1vLCBpdGVyYXRvciwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIHJldmVyc2VkID0gX21hcChhcnIsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICByZXR1cm4geDsKICAgICAgICAgICAgfSkucmV2ZXJzZSgpOwogICAgICAgICAgICBhc3luYy5yZWR1Y2UocmV2ZXJzZWQsIG1lbW8sIGl0ZXJhdG9yLCBjYWxsYmFjayk7CiAgICAgICAgfTsKICAgICAgICAvLyBmb2xkciBhbGlhcwogICAgICAgIGFzeW5jLmZvbGRyID0gYXN5bmMucmVkdWNlUmlnaHQ7CgogICAgICAgIHZhciBfZmlsdGVyID0gZnVuY3Rpb24gKGVhY2hmbiwgYXJyLCBpdGVyYXRvciwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgICAgICAgICAgYXJyID0gX21hcChhcnIsIGZ1bmN0aW9uICh4LCBpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4ge2luZGV4OiBpLCB2YWx1ZTogeH07CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBlYWNoZm4oYXJyLCBmdW5jdGlvbiAoeCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIGl0ZXJhdG9yKHgudmFsdWUsIGZ1bmN0aW9uICh2KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKF9tYXAocmVzdWx0cy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEuaW5kZXggLSBiLmluZGV4OwogICAgICAgICAgICAgICAgfSksIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHgudmFsdWU7CiAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgYXN5bmMuZmlsdGVyID0gZG9QYXJhbGxlbChfZmlsdGVyKTsKICAgICAgICBhc3luYy5maWx0ZXJTZXJpZXMgPSBkb1NlcmllcyhfZmlsdGVyKTsKICAgICAgICAvLyBzZWxlY3QgYWxpYXMKICAgICAgICBhc3luYy5zZWxlY3QgPSBhc3luYy5maWx0ZXI7CiAgICAgICAgYXN5bmMuc2VsZWN0U2VyaWVzID0gYXN5bmMuZmlsdGVyU2VyaWVzOwoKICAgICAgICB2YXIgX3JlamVjdCA9IGZ1bmN0aW9uIChlYWNoZm4sIGFyciwgaXRlcmF0b3IsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciByZXN1bHRzID0gW107CiAgICAgICAgICAgIGFyciA9IF9tYXAoYXJyLCBmdW5jdGlvbiAoeCwgaSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHtpbmRleDogaSwgdmFsdWU6IHh9OwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZWFjaGZuKGFyciwgZnVuY3Rpb24gKHgsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBpdGVyYXRvcih4LnZhbHVlLCBmdW5jdGlvbiAodikgewogICAgICAgICAgICAgICAgICAgIGlmICghdikgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2goeCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgY2FsbGJhY2soX21hcChyZXN1bHRzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYS5pbmRleCAtIGIuaW5kZXg7CiAgICAgICAgICAgICAgICB9KSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4geC52YWx1ZTsKICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICBhc3luYy5yZWplY3QgPSBkb1BhcmFsbGVsKF9yZWplY3QpOwogICAgICAgIGFzeW5jLnJlamVjdFNlcmllcyA9IGRvU2VyaWVzKF9yZWplY3QpOwoKICAgICAgICB2YXIgX2RldGVjdCA9IGZ1bmN0aW9uIChlYWNoZm4sIGFyciwgaXRlcmF0b3IsIG1haW5fY2FsbGJhY2spIHsKICAgICAgICAgICAgZWFjaGZuKGFyciwgZnVuY3Rpb24gKHgsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBpdGVyYXRvcih4LCBmdW5jdGlvbiAocmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgICAgICAgICAgICAgICAgICBtYWluX2NhbGxiYWNrKHgpOwogICAgICAgICAgICAgICAgICAgICAgICBtYWluX2NhbGxiYWNrID0gZnVuY3Rpb24gKCkge307CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LCBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICBtYWluX2NhbGxiYWNrKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgYXN5bmMuZGV0ZWN0ID0gZG9QYXJhbGxlbChfZGV0ZWN0KTsKICAgICAgICBhc3luYy5kZXRlY3RTZXJpZXMgPSBkb1NlcmllcyhfZGV0ZWN0KTsKCiAgICAgICAgYXN5bmMuc29tZSA9IGZ1bmN0aW9uIChhcnIsIGl0ZXJhdG9yLCBtYWluX2NhbGxiYWNrKSB7CiAgICAgICAgICAgIGFzeW5jLmVhY2goYXJyLCBmdW5jdGlvbiAoeCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIGl0ZXJhdG9yKHgsIGZ1bmN0aW9uICh2KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWFpbl9jYWxsYmFjayh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgbWFpbl9jYWxsYmFjayA9IGZ1bmN0aW9uICgpIHt9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgIG1haW5fY2FsbGJhY2soZmFsc2UpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIC8vIGFueSBhbGlhcwogICAgICAgIGFzeW5jLmFueSA9IGFzeW5jLnNvbWU7CgogICAgICAgIGFzeW5jLmV2ZXJ5ID0gZnVuY3Rpb24gKGFyciwgaXRlcmF0b3IsIG1haW5fY2FsbGJhY2spIHsKICAgICAgICAgICAgYXN5bmMuZWFjaChhcnIsIGZ1bmN0aW9uICh4LCBjYWxsYmFjaykgewogICAgICAgICAgICAgICAgaXRlcmF0b3IoeCwgZnVuY3Rpb24gKHYpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWFpbl9jYWxsYmFjayhmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG1haW5fY2FsbGJhY2sgPSBmdW5jdGlvbiAoKSB7fTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LCBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICBtYWluX2NhbGxiYWNrKHRydWUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIC8vIGFsbCBhbGlhcwogICAgICAgIGFzeW5jLmFsbCA9IGFzeW5jLmV2ZXJ5OwoKICAgICAgICBhc3luYy5zb3J0QnkgPSBmdW5jdGlvbiAoYXJyLCBpdGVyYXRvciwgY2FsbGJhY2spIHsKICAgICAgICAgICAgYXN5bmMubWFwKGFyciwgZnVuY3Rpb24gKHgsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBpdGVyYXRvcih4LCBmdW5jdGlvbiAoZXJyLCBjcml0ZXJpYSkgewogICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHt2YWx1ZTogeCwgY3JpdGVyaWE6IGNyaXRlcmlhfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnIsIHJlc3VsdHMpIHsKICAgICAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBmbiA9IGZ1bmN0aW9uIChsZWZ0LCByaWdodCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYSA9IGxlZnQuY3JpdGVyaWEsIGIgPSByaWdodC5jcml0ZXJpYTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEgPCBiID8gLTEgOiBhID4gYiA/IDEgOiAwOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgX21hcChyZXN1bHRzLnNvcnQoZm4pLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4geC52YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIGFzeW5jLmF1dG8gPSBmdW5jdGlvbiAodGFza3MsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgfHwgZnVuY3Rpb24gKCkge307CiAgICAgICAgICAgIHZhciBrZXlzID0gX2tleXModGFza3MpOwogICAgICAgICAgICBpZiAoIWtleXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciByZXN1bHRzID0ge307CgogICAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gW107CiAgICAgICAgICAgIHZhciBhZGRMaXN0ZW5lciA9IGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgbGlzdGVuZXJzLnVuc2hpZnQoZm4pOwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgcmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGlzdGVuZXJzLmxlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGxpc3RlbmVyc1tpXSA9PT0gZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIHRhc2tDb21wbGV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIF9lYWNoKGxpc3RlbmVycy5zbGljZSgwKSwgZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgZm4oKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgYWRkTGlzdGVuZXIoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKF9rZXlzKHJlc3VsdHMpLmxlbmd0aCA9PT0ga2V5cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCByZXN1bHRzKTsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uICgpIHt9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIF9lYWNoKGtleXMsIGZ1bmN0aW9uIChrKSB7CiAgICAgICAgICAgICAgICB2YXIgdGFzayA9ICh0YXNrc1trXSBpbnN0YW5jZW9mIEZ1bmN0aW9uKSA/IFt0YXNrc1trXV06IHRhc2tzW2tdOwogICAgICAgICAgICAgICAgdmFyIHRhc2tDYWxsYmFjayA9IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoIDw9IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXJncyA9IGFyZ3NbMF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNhZmVSZXN1bHRzID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIF9lYWNoKF9rZXlzKHJlc3VsdHMpLCBmdW5jdGlvbihya2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlUmVzdWx0c1tya2V5XSA9IHJlc3VsdHNbcmtleV07CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBzYWZlUmVzdWx0c1trXSA9IGFyZ3M7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVyciwgc2FmZVJlc3VsdHMpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBzdG9wIHN1YnNlcXVlbnQgZXJyb3JzIGhpdHRpbmcgY2FsbGJhY2sgbXVsdGlwbGUgdGltZXMKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbiAoKSB7fTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHNba10gPSBhcmdzOwogICAgICAgICAgICAgICAgICAgICAgICBhc3luYy5zZXRJbW1lZGlhdGUodGFza0NvbXBsZXRlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgdmFyIHJlcXVpcmVzID0gdGFzay5zbGljZSgwLCBNYXRoLmFicyh0YXNrLmxlbmd0aCAtIDEpKSB8fCBbXTsKICAgICAgICAgICAgICAgIHZhciByZWFkeSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3JlZHVjZShyZXF1aXJlcywgZnVuY3Rpb24gKGEsIHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChhICYmIHJlc3VsdHMuaGFzT3duUHJvcGVydHkoeCkpOwogICAgICAgICAgICAgICAgICAgIH0sIHRydWUpICYmICFyZXN1bHRzLmhhc093blByb3BlcnR5KGspOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGlmIChyZWFkeSgpKSB7CiAgICAgICAgICAgICAgICAgICAgdGFza1t0YXNrLmxlbmd0aCAtIDFdKHRhc2tDYWxsYmFjaywgcmVzdWx0cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGlzdGVuZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWFkeSgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVMaXN0ZW5lcihsaXN0ZW5lcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrW3Rhc2subGVuZ3RoIC0gMV0odGFza0NhbGxiYWNrLCByZXN1bHRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgYWRkTGlzdGVuZXIobGlzdGVuZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBhc3luYy53YXRlcmZhbGwgPSBmdW5jdGlvbiAodGFza3MsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgfHwgZnVuY3Rpb24gKCkge307CiAgICAgICAgICAgIGlmICh0YXNrcy5jb25zdHJ1Y3RvciAhPT0gQXJyYXkpIHsKICAgICAgICAgICAgICAgIHZhciBlcnIgPSBuZXcgRXJyb3IoJ0ZpcnN0IGFyZ3VtZW50IHRvIHdhdGVyZmFsbCBtdXN0IGJlIGFuIGFycmF5IG9mIGZ1bmN0aW9ucycpOwogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCF0YXNrcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjaygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB3cmFwSXRlcmF0b3IgPSBmdW5jdGlvbiAoaXRlcmF0b3IpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uICgpIHt9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IGl0ZXJhdG9yLm5leHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaCh3cmFwSXRlcmF0b3IobmV4dCkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBhc3luYy5zZXRJbW1lZGlhdGUoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlcmF0b3IuYXBwbHkobnVsbCwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHdyYXBJdGVyYXRvcihhc3luYy5pdGVyYXRvcih0YXNrcykpKCk7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIF9wYXJhbGxlbCA9IGZ1bmN0aW9uKGVhY2hmbiwgdGFza3MsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgfHwgZnVuY3Rpb24gKCkge307CiAgICAgICAgICAgIGlmICh0YXNrcy5jb25zdHJ1Y3RvciA9PT0gQXJyYXkpIHsKICAgICAgICAgICAgICAgIGVhY2hmbi5tYXAodGFza3MsIGZ1bmN0aW9uIChmbiwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm4oZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoIDw9IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzID0gYXJnc1swXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmNhbGwobnVsbCwgZXJyLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHJlc3VsdHMgPSB7fTsKICAgICAgICAgICAgICAgIGVhY2hmbi5lYWNoKF9rZXlzKHRhc2tzKSwgZnVuY3Rpb24gKGssIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgdGFza3Nba10oZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcmdzLmxlbmd0aCA8PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzID0gYXJnc1swXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzW2tdID0gYXJnczsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnIsIHJlc3VsdHMpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBhc3luYy5wYXJhbGxlbCA9IGZ1bmN0aW9uICh0YXNrcywgY2FsbGJhY2spIHsKICAgICAgICAgICAgX3BhcmFsbGVsKHsgbWFwOiBhc3luYy5tYXAsIGVhY2g6IGFzeW5jLmVhY2ggfSwgdGFza3MsIGNhbGxiYWNrKTsKICAgICAgICB9OwoKICAgICAgICBhc3luYy5wYXJhbGxlbExpbWl0ID0gZnVuY3Rpb24odGFza3MsIGxpbWl0LCBjYWxsYmFjaykgewogICAgICAgICAgICBfcGFyYWxsZWwoeyBtYXA6IF9tYXBMaW1pdChsaW1pdCksIGVhY2g6IF9lYWNoTGltaXQobGltaXQpIH0sIHRhc2tzLCBjYWxsYmFjayk7CiAgICAgICAgfTsKCiAgICAgICAgYXN5bmMuc2VyaWVzID0gZnVuY3Rpb24gKHRhc2tzLCBjYWxsYmFjaykgewogICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrIHx8IGZ1bmN0aW9uICgpIHt9OwogICAgICAgICAgICBpZiAodGFza3MuY29uc3RydWN0b3IgPT09IEFycmF5KSB7CiAgICAgICAgICAgICAgICBhc3luYy5tYXBTZXJpZXModGFza3MsIGZ1bmN0aW9uIChmbiwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm4oZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoIDw9IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzID0gYXJnc1swXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmNhbGwobnVsbCwgZXJyLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHJlc3VsdHMgPSB7fTsKICAgICAgICAgICAgICAgIGFzeW5jLmVhY2hTZXJpZXMoX2tleXModGFza3MpLCBmdW5jdGlvbiAoaywgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICB0YXNrc1trXShmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoIDw9IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MgPSBhcmdzWzBdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHNba10gPSBhcmdzOwogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVyciwgcmVzdWx0cyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGFzeW5jLml0ZXJhdG9yID0gZnVuY3Rpb24gKHRhc2tzKSB7CiAgICAgICAgICAgIHZhciBtYWtlQ2FsbGJhY2sgPSBmdW5jdGlvbiAoaW5kZXgpIHsKICAgICAgICAgICAgICAgIHZhciBmbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGFza3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhc2tzW2luZGV4XS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4ubmV4dCgpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGZuLm5leHQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChpbmRleCA8IHRhc2tzLmxlbmd0aCAtIDEpID8gbWFrZUNhbGxiYWNrKGluZGV4ICsgMSk6IG51bGw7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gbWFrZUNhbGxiYWNrKDApOwogICAgICAgIH07CgogICAgICAgIGFzeW5jLmFwcGx5ID0gZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmbi5hcHBseSgKICAgICAgICAgICAgICAgICAgICBudWxsLCBhcmdzLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfTsKICAgICAgICB9OwoKICAgICAgICB2YXIgX2NvbmNhdCA9IGZ1bmN0aW9uIChlYWNoZm4sIGFyciwgZm4sIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciByID0gW107CiAgICAgICAgICAgIGVhY2hmbihhcnIsIGZ1bmN0aW9uICh4LCBjYikgewogICAgICAgICAgICAgICAgZm4oeCwgZnVuY3Rpb24gKGVyciwgeSkgewogICAgICAgICAgICAgICAgICAgIHIgPSByLmNvbmNhdCh5IHx8IFtdKTsKICAgICAgICAgICAgICAgICAgICBjYihlcnIpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVyciwgcik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgYXN5bmMuY29uY2F0ID0gZG9QYXJhbGxlbChfY29uY2F0KTsKICAgICAgICBhc3luYy5jb25jYXRTZXJpZXMgPSBkb1NlcmllcyhfY29uY2F0KTsKCiAgICAgICAgYXN5bmMud2hpbHN0ID0gZnVuY3Rpb24gKHRlc3QsIGl0ZXJhdG9yLCBjYWxsYmFjaykgewogICAgICAgICAgICBpZiAodGVzdCgpKSB7CiAgICAgICAgICAgICAgICBpdGVyYXRvcihmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYXN5bmMud2hpbHN0KHRlc3QsIGl0ZXJhdG9yLCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBhc3luYy5kb1doaWxzdCA9IGZ1bmN0aW9uIChpdGVyYXRvciwgdGVzdCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgaXRlcmF0b3IoZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhlcnIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRlc3QoKSkgewogICAgICAgICAgICAgICAgICAgIGFzeW5jLmRvV2hpbHN0KGl0ZXJhdG9yLCB0ZXN0LCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBhc3luYy51bnRpbCA9IGZ1bmN0aW9uICh0ZXN0LCBpdGVyYXRvciwgY2FsbGJhY2spIHsKICAgICAgICAgICAgaWYgKCF0ZXN0KCkpIHsKICAgICAgICAgICAgICAgIGl0ZXJhdG9yKGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhlcnIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBhc3luYy51bnRpbCh0ZXN0LCBpdGVyYXRvciwgY2FsbGJhY2spOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgYXN5bmMuZG9VbnRpbCA9IGZ1bmN0aW9uIChpdGVyYXRvciwgdGVzdCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgaXRlcmF0b3IoZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhlcnIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCF0ZXN0KCkpIHsKICAgICAgICAgICAgICAgICAgICBhc3luYy5kb1VudGlsKGl0ZXJhdG9yLCB0ZXN0LCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBhc3luYy5xdWV1ZSA9IGZ1bmN0aW9uICh3b3JrZXIsIGNvbmN1cnJlbmN5KSB7CiAgICAgICAgICAgIGlmIChjb25jdXJyZW5jeSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBjb25jdXJyZW5jeSA9IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gX2luc2VydChxLCBkYXRhLCBwb3MsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBpZihkYXRhLmNvbnN0cnVjdG9yICE9PSBBcnJheSkgewogICAgICAgICAgICAgICAgICAgIGRhdGEgPSBbZGF0YV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfZWFjaChkYXRhLCBmdW5jdGlvbih0YXNrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHRhc2ssCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiB0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicgPyBjYWxsYmFjayA6IG51bGwKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBpZiAocG9zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHEudGFza3MudW5zaGlmdChpdGVtKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBxLnRhc2tzLnB1c2goaXRlbSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAocS5zYXR1cmF0ZWQgJiYgcS50YXNrcy5sZW5ndGggPT09IGNvbmN1cnJlbmN5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHEuc2F0dXJhdGVkKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGFzeW5jLnNldEltbWVkaWF0ZShxLnByb2Nlc3MpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciB3b3JrZXJzID0gMDsKICAgICAgICAgICAgdmFyIHEgPSB7CiAgICAgICAgICAgICAgICB0YXNrczogW10sCiAgICAgICAgICAgICAgICBjb25jdXJyZW5jeTogY29uY3VycmVuY3ksCiAgICAgICAgICAgICAgICBzYXR1cmF0ZWQ6IG51bGwsCiAgICAgICAgICAgICAgICBlbXB0eTogbnVsbCwKICAgICAgICAgICAgICAgIGRyYWluOiBudWxsLAogICAgICAgICAgICAgICAgcHVzaDogZnVuY3Rpb24gKGRhdGEsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgX2luc2VydChxLCBkYXRhLCBmYWxzZSwgY2FsbGJhY2spOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHVuc2hpZnQ6IGZ1bmN0aW9uIChkYXRhLCBjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgIF9pbnNlcnQocSwgZGF0YSwgdHJ1ZSwgY2FsbGJhY2spOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHByb2Nlc3M6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAod29ya2VycyA8IHEuY29uY3VycmVuY3kgJiYgcS50YXNrcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRhc2sgPSBxLnRhc2tzLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChxLmVtcHR5ICYmIHEudGFza3MubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBxLmVtcHR5KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgd29ya2VycyArPSAxOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtlcnMgLT0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXNrLmNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5jYWxsYmFjay5hcHBseSh0YXNrLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHEuZHJhaW4gJiYgcS50YXNrcy5sZW5ndGggKyB3b3JrZXJzID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcS5kcmFpbigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcS5wcm9jZXNzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYiA9IG9ubHlfb25jZShuZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgd29ya2VyKHRhc2suZGF0YSwgY2IpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBsZW5ndGg6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcS50YXNrcy5sZW5ndGg7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgcnVubmluZzogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB3b3JrZXJzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gcTsKICAgICAgICB9OwoKICAgICAgICBhc3luYy5jYXJnbyA9IGZ1bmN0aW9uICh3b3JrZXIsIHBheWxvYWQpIHsKICAgICAgICAgICAgdmFyIHdvcmtpbmcgICAgID0gZmFsc2UsCiAgICAgICAgICAgICAgICB0YXNrcyAgICAgICA9IFtdOwoKICAgICAgICAgICAgdmFyIGNhcmdvID0gewogICAgICAgICAgICAgICAgdGFza3M6IHRhc2tzLAogICAgICAgICAgICAgICAgcGF5bG9hZDogcGF5bG9hZCwKICAgICAgICAgICAgICAgIHNhdHVyYXRlZDogbnVsbCwKICAgICAgICAgICAgICAgIGVtcHR5OiBudWxsLAogICAgICAgICAgICAgICAgZHJhaW46IG51bGwsCiAgICAgICAgICAgICAgICBwdXNoOiBmdW5jdGlvbiAoZGF0YSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICBpZihkYXRhLmNvbnN0cnVjdG9yICE9PSBBcnJheSkgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0gW2RhdGFdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBfZWFjaChkYXRhLCBmdW5jdGlvbih0YXNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhc2tzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogdGFzaywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiB0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicgPyBjYWxsYmFjayA6IG51bGwKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYXJnby5zYXR1cmF0ZWQgJiYgdGFza3MubGVuZ3RoID09PSBwYXlsb2FkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXJnby5zYXR1cmF0ZWQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGFzeW5jLnNldEltbWVkaWF0ZShjYXJnby5wcm9jZXNzKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBwcm9jZXNzOiBmdW5jdGlvbiBwcm9jZXNzKCkgewogICAgICAgICAgICAgICAgICAgIGlmICh3b3JraW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgaWYgKHRhc2tzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZihjYXJnby5kcmFpbikgY2FyZ28uZHJhaW4oKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdmFyIHRzID0gdHlwZW9mIHBheWxvYWQgPT09ICdudW1iZXInCiAgICAgICAgICAgICAgICAgICAgICAgID8gdGFza3Muc3BsaWNlKDAsIHBheWxvYWQpCiAgICAgICAgICAgICAgICAgICAgICAgIDogdGFza3Muc3BsaWNlKDApOwoKICAgICAgICAgICAgICAgICAgICB2YXIgZHMgPSBfbWFwKHRzLCBmdW5jdGlvbiAodGFzaykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGFzay5kYXRhOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBpZihjYXJnby5lbXB0eSkgY2FyZ28uZW1wdHkoKTsKICAgICAgICAgICAgICAgICAgICB3b3JraW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB3b3JrZXIoZHMsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd29ya2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgICAgICAgICAgICAgICAgIF9lYWNoKHRzLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEuY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmNhbGxiYWNrLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3MoKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBsZW5ndGg6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGFza3MubGVuZ3RoOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHJ1bm5pbmc6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd29ya2luZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIGNhcmdvOwogICAgICAgIH07CgogICAgICAgIHZhciBfY29uc29sZV9mbiA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgICAgIGZuLmFwcGx5KG51bGwsIGFyZ3MuY29uY2F0KFtmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY29uc29sZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnNvbGUuZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoY29uc29sZVtuYW1lXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2VhY2goYXJncywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlW25hbWVdKHgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9XSkpOwogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICAgICAgYXN5bmMubG9nID0gX2NvbnNvbGVfZm4oJ2xvZycpOwogICAgICAgIGFzeW5jLmRpciA9IF9jb25zb2xlX2ZuKCdkaXInKTsKICAgICAgICAvKmFzeW5jLmluZm8gPSBfY29uc29sZV9mbignaW5mbycpOwogICAgICAgICBhc3luYy53YXJuID0gX2NvbnNvbGVfZm4oJ3dhcm4nKTsKICAgICAgICAgYXN5bmMuZXJyb3IgPSBfY29uc29sZV9mbignZXJyb3InKTsqLwoKICAgICAgICBhc3luYy5tZW1vaXplID0gZnVuY3Rpb24gKGZuLCBoYXNoZXIpIHsKICAgICAgICAgICAgdmFyIG1lbW8gPSB7fTsKICAgICAgICAgICAgdmFyIHF1ZXVlcyA9IHt9OwogICAgICAgICAgICBoYXNoZXIgPSBoYXNoZXIgfHwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB4OwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgbWVtb2l6ZWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBhcmdzLnBvcCgpOwogICAgICAgICAgICAgICAgdmFyIGtleSA9IGhhc2hlci5hcHBseShudWxsLCBhcmdzKTsKICAgICAgICAgICAgICAgIGlmIChrZXkgaW4gbWVtbykgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmFwcGx5KG51bGwsIG1lbW9ba2V5XSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChrZXkgaW4gcXVldWVzKSB7CiAgICAgICAgICAgICAgICAgICAgcXVldWVzW2tleV0ucHVzaChjYWxsYmFjayk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBxdWV1ZXNba2V5XSA9IFtjYWxsYmFja107CiAgICAgICAgICAgICAgICAgICAgZm4uYXBwbHkobnVsbCwgYXJncy5jb25jYXQoW2Z1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWVtb1trZXldID0gYXJndW1lbnRzOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcSA9IHF1ZXVlc1trZXldOwogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgcXVldWVzW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gcS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHFbaV0uYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH1dKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIG1lbW9pemVkLm1lbW8gPSBtZW1vOwogICAgICAgICAgICBtZW1vaXplZC51bm1lbW9pemVkID0gZm47CiAgICAgICAgICAgIHJldHVybiBtZW1vaXplZDsKICAgICAgICB9OwoKICAgICAgICBhc3luYy51bm1lbW9pemUgPSBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiAoZm4udW5tZW1vaXplZCB8fCBmbikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgICAgfTsKICAgICAgICB9OwoKICAgICAgICBhc3luYy50aW1lcyA9IGZ1bmN0aW9uIChjb3VudCwgaXRlcmF0b3IsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBjb3VudGVyID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgY291bnRlci5wdXNoKGkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhc3luYy5tYXAoY291bnRlciwgaXRlcmF0b3IsIGNhbGxiYWNrKTsKICAgICAgICB9OwoKICAgICAgICBhc3luYy50aW1lc1NlcmllcyA9IGZ1bmN0aW9uIChjb3VudCwgaXRlcmF0b3IsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBjb3VudGVyID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgY291bnRlci5wdXNoKGkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhc3luYy5tYXBTZXJpZXMoY291bnRlciwgaXRlcmF0b3IsIGNhbGxiYWNrKTsKICAgICAgICB9OwoKICAgICAgICBhc3luYy5jb21wb3NlID0gZnVuY3Rpb24gKC8qIGZ1bmN0aW9ucy4uLiAqLykgewogICAgICAgICAgICB2YXIgZm5zID0gQXJyYXkucHJvdG90eXBlLnJldmVyc2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gYXJncy5wb3AoKTsKICAgICAgICAgICAgICAgIGFzeW5jLnJlZHVjZShmbnMsIGFyZ3MsIGZ1bmN0aW9uIChuZXdhcmdzLCBmbiwgY2IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm4uYXBwbHkodGhhdCwgbmV3YXJncy5jb25jYXQoW2Z1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlcnIgPSBhcmd1bWVudHNbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2IoZXJyLCBuZXh0YXJncyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH1dKSkKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChlcnIsIHJlc3VsdHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suYXBwbHkodGhhdCwgW2Vycl0uY29uY2F0KHJlc3VsdHMpKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICB9OwoKICAgICAgICB2YXIgX2FwcGx5RWFjaCA9IGZ1bmN0aW9uIChlYWNoZm4sIGZucyAvKmFyZ3MuLi4qLykgewogICAgICAgICAgICB2YXIgZ28gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBhcmdzLnBvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIGVhY2hmbihmbnMsIGZ1bmN0aW9uIChmbiwgY2IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm4uYXBwbHkodGhhdCwgYXJncy5jb25jYXQoW2NiXSkpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2spOwogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDIpIHsKICAgICAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgICAgICAgICAgICAgIHJldHVybiBnby5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBnbzsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgYXN5bmMuYXBwbHlFYWNoID0gZG9QYXJhbGxlbChfYXBwbHlFYWNoKTsKICAgICAgICBhc3luYy5hcHBseUVhY2hTZXJpZXMgPSBkb1NlcmllcyhfYXBwbHlFYWNoKTsKCiAgICAgICAgYXN5bmMuZm9yZXZlciA9IGZ1bmN0aW9uIChmbiwgY2FsbGJhY2spIHsKICAgICAgICAgICAgZnVuY3Rpb24gbmV4dChlcnIpIHsKICAgICAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZuKG5leHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHQoKTsKICAgICAgICB9OwoKICAgICAgICAvKgogICAgICAgIC8vIEFNRCAvIFJlcXVpcmVKUwogICAgICAgIGlmICh0eXBlb2YgZGVmaW5lICE9PSAndW5kZWZpbmVkJyAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgICAgIGRlZmluZShbXSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGFzeW5jOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgLy8gTm9kZS5qcwogICAgICAgIGVsc2UgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gYXN5bmM7CiAgICAgICAgfQogICAgICAgIC8vIGluY2x1ZGVkIGRpcmVjdGx5IHZpYSA8c2NyaXB0PiB0YWcKICAgICAgICBlbHNlIHsKICAgICAgICAgICAgcm9vdC5hc3luYyA9IGFzeW5jOwogICAgICAgIH0KICAgICAgICAqLwoKICAgICAgICByb290LmFzeW5jID0gYXN5bmM7CgogICAgfSgpKTsKCn0pKGpRdWVyeSk7CihmdW5jdGlvbigpCnsKICAgIEFscGFjYS5UZW1wbGF0ZUVuZ2luZVJlZ2lzdHJ5ID0gZnVuY3Rpb24oKSB7CgogICAgICAgIHZhciByZWdpc3RyeSA9IHt9OwoKICAgICAgICByZXR1cm4gewoKICAgICAgICAgICAgcmVnaXN0ZXI6IGZ1bmN0aW9uKGlkLCBlbmdpbmUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJlZ2lzdHJ5W2lkXSA9IGVuZ2luZTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGZpbmQ6IGZ1bmN0aW9uKGlkT3JUeXBlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgZW5naW5lID0gbnVsbDsKCiAgICAgICAgICAgICAgICBpZiAocmVnaXN0cnlbaWRPclR5cGVdKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGVuZ2luZSA9IHJlZ2lzdHJ5W2lkT3JUeXBlXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBpbnNwZWN0IGJ5IHR5cGUKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpZCBpbiByZWdpc3RyeSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdXBwb3J0ZWRNaW1ldHlwZXMgPSByZWdpc3RyeVtpZF0uc3VwcG9ydGVkTWltZXR5cGVzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3VwcG9ydGVkTWltZXR5cGVzLmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaWRPclR5cGUudG9Mb3dlckNhc2UoKSA9PSBzdXBwb3J0ZWRNaW1ldHlwZXNbaV0udG9Mb3dlckNhc2UoKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmUgPSByZWdpc3RyeVtpZF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGVuZ2luZTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGlkczogZnVuY3Rpb24oKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgaWRzID0gW107CgogICAgICAgICAgICAgICAgZm9yICh2YXIgaWQgaW4gcmVnaXN0cnkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWRzLnB1c2goaWQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBpZHM7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfSgpOwoKfSkoKTsKKGZ1bmN0aW9uKCQpCnsKICAgIC8vIHRlbXBsYXRlIGNhY2hlCiAgICBpZiAodHlwZW9mKEFscGFjYS5UZW1wbGF0ZUNhY2hlKSA9PSAidW5kZWZpbmVkIikgewogICAgICAgIEFscGFjYS5UZW1wbGF0ZUNhY2hlID0ge307CiAgICB9CgogICAgQWxwYWNhLkFic3RyYWN0VGVtcGxhdGVFbmdpbmUgPSBCYXNlLmV4dGVuZCgKICAgIHsKICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oaWQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmJhc2UoKTsKCiAgICAgICAgICAgIHRoaXMuaWQgPSBpZDsKCiAgICAgICAgICAgIHRoaXMuY2xlYW5NYXJrdXAgPSBmdW5jdGlvbihodG1sKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBjb252ZXJ0IHRvIGEgZG9tIGJyaWVmbHkKICAgICAgICAgICAgICAgIHZhciBkb20gPSBBbHBhY2Euc2FmZURvbVBhcnNlKGh0bWwpOwoKICAgICAgICAgICAgICAgIC8vIGlmIGlmIHN0YXJ0cyB3aXRoIGEgc2NyaXB0IHRhZywgdGhlbiB3ZSBzdHJpcCB0aGF0IG91dAogICAgICAgICAgICAgICAgaWYgKCQoZG9tKS5sZW5ndGggPT0gMSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoJChkb20pWzBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT0gInNjcmlwdCIpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBodG1sID0gJChkb20pLmh0bWwoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGh0bWw7CiAgICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ29tcGlsZXMgdGhlIGdpdmVuIHRlbXBsYXRlIChvciBVUkkgb3IgZG9tIHNlbGVjdG9yKQogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIGNhY2hlS2V5CiAgICAgICAgICogQHBhcmFtIHRlbXBsYXRlCiAgICAgICAgICogQHBhcmFtIGNhbGxiYWNrCiAgICAgICAgICovCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oY2FjaGVLZXksIHRlbXBsYXRlLCBjYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIC8vIHRoZSB2YWx1ZSBiZWluZyBjb21waWxlZCBjYW4gYmUKICAgICAgICAgICAgLy8gICBIVE1MCiAgICAgICAgICAgIC8vICAgVVJMIChodHRwLCAuLyBvciAvKQogICAgICAgICAgICAvLyAgIGRvbSBzZWxlY3RvciAoI2FiYywgLmNsYXNzbmFtZSkKICAgICAgICAgICAgLy8gICBkb20gZWxlbWVudAoKICAgICAgICAgICAgLy8gaGVyZSB3ZSB0cnkgdG8gZGV0ZXJtaW5lIHdoYXQgdHlwZSBvZiB2YWx1ZSBpdCBpcwogICAgICAgICAgICB2YXIgdHlwZSA9ICJodG1sIjsKICAgICAgICAgICAgaWYgKEFscGFjYS5pc1N0cmluZyh0ZW1wbGF0ZSkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0ZW1wbGF0ZS5pbmRleE9mKCIuLyIpID09PSAwIHx8IHRlbXBsYXRlLmluZGV4T2YoIi8iKSA9PT0gMCB8fCB0ZW1wbGF0ZS5pbmRleE9mKCIuLi8iKSA9PT0gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gInVyaSI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZW1wbGF0ZS5pbmRleE9mKCIjIikgPT09IDAgfHwgdGVtcGxhdGUuaW5kZXhPZigiLiIpID09PSAwIHx8IHRlbXBsYXRlLmluZGV4T2YoIlsiKSA9PT0gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gInNlbGVjdG9yIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIGl0J3MgYSBkb20gZWxlbWVudCwgd2UgZmxvdyB0aHJvdWdoCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIG5vdyBleHRyYWN0IGh0bWwgYW5kIGNvbXBpbGUKICAgICAgICAgICAgaWYgKHR5cGUgPT0gInNlbGVjdG9yIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc2VsZi5fY29tcGlsZShjYWNoZUtleSwgdGVtcGxhdGUsIGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0eXBlID09ICJ1cmkiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgZmlsZUV4dGVuc2lvbiA9IHNlbGYuZmlsZUV4dGVuc2lvbigpOwoKICAgICAgICAgICAgICAgIHZhciB1cmwgPSB0ZW1wbGF0ZTsKICAgICAgICAgICAgICAgIGlmICh1cmwuaW5kZXhPZigiLiIgKyBmaWxlRXh0ZW5zaW9uKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICB1cmwgKz0gIi4iICsgZmlsZUV4dGVuc2lvbjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBsb2FkIHRoZSB0ZW1wbGF0ZSB2aWEgYWpheAogICAgICAgICAgICAgICAgJC5hamF4KHsKICAgICAgICAgICAgICAgICAgICAidXJsIjogdXJsLAogICAgICAgICAgICAgICAgICAgICJkYXRhVHlwZSI6ICJodG1sIiwKICAgICAgICAgICAgICAgICAgICAic3VjY2VzcyI6IGZ1bmN0aW9uKGh0bWwpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBjbGVhbnVwIGh0bWwKICAgICAgICAgICAgICAgICAgICAgICAgaHRtbCA9IHNlbGYuY2xlYW5NYXJrdXAoaHRtbCk7CgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9jb21waWxlKGNhY2hlS2V5LCBodG1sLCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZmFpbHVyZSI6IGZ1bmN0aW9uKGh0dHApCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhodHRwLCBudWxsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0eXBlID09ICJodG1sIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGh0bWwgPSB0ZW1wbGF0ZTsKICAgICAgICAgICAgICAgIGlmIChodG1sIGluc3RhbmNlb2YgalF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgaHRtbCA9IEFscGFjYS5zYWZlRG9tUGFyc2UodGVtcGxhdGUpLm91dGVySFRNTCgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHNlbGYuX2NvbXBpbGUoY2FjaGVLZXksIGh0bWwsIGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcigiVGVtcGxhdGUgZW5naW5lIGNhbm5vdCBkZXRlcm1pbmUgaG93IHRvIGhhbmRsZSB0eXBlOiAiICsgdHlwZSkpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgX2NvbXBpbGU6IGZ1bmN0aW9uKGNhY2hlS2V5LCBodG1sLCBjYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIC8vIGZvciBudWxsIHRlbXBsYXRlcywgc2V0IHRvIGVtcHR5IHN0cmluZwogICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkoaHRtbCkpIHsKICAgICAgICAgICAgICAgIGh0bWwgPSAiIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gdHJpbSB0aGUgaHRtbAogICAgICAgICAgICBodG1sID0gQWxwYWNhLnRyaW0oaHRtbCk7CgogICAgICAgICAgICBpZiAoaHRtbC50b0xvd2VyQ2FzZSgpLmluZGV4T2YoIjxzY3JpcHQiKSA9PT0gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gYWxyZWFkeSBoYXMgc2NyaXB0IHRhZwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gYXBwbHkgc2NyaXB0IHRhZwogICAgICAgICAgICAgICAgaHRtbCA9ICI8c2NyaXB0IHR5cGU9JyIgKyB0aGlzLnN1cHBvcnRlZE1pbWV0eXBlcygpWzBdICsgIic+IiArIGh0bWwgKyAiPC9zY3JpcHQ+IjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgQWxwYWNhLmxvZ0RlYnVnKCJDb21waWxpbmcgdGVtcGxhdGU6ICIgKyB0aGlzLmlkICsgIiwgY2FjaGVLZXk6ICIgKyBjYWNoZUtleSArICIsIHRlbXBsYXRlOiAiICsgaHRtbCk7CgogICAgICAgICAgICB0aGlzLmRvQ29tcGlsZShjYWNoZUtleSwgaHRtbCwgY2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBleHRlbnNpb25fcG9pbnQKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBjYWNoZUtleQogICAgICAgICAqIEBwYXJhbSBodG1sCiAgICAgICAgICogQHBhcmFtIGNhbGxiYWNrCiAgICAgICAgICovCiAgICAgICAgZG9Db21waWxlOiBmdW5jdGlvbihjYWNoZUtleSwgaHRtbCwgY2FsbGJhY2spCiAgICAgICAgewoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAZXh0ZW5zaW9uX3BvaW50CiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gY2FjaGVLZXkKICAgICAgICAgKiBAcGFyYW0gbW9kZWwKICAgICAgICAgKiBAcGFyYW0gY2FsbGJhY2sKICAgICAgICAgKi8KICAgICAgICBleGVjdXRlOiBmdW5jdGlvbihjYWNoZUtleSwgbW9kZWwsIGNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgQWxwYWNhLmxvZ0RlYnVnKCJFeGVjdXRpbmcgdGVtcGxhdGUgZm9yIGNhY2hlIGtleTogIiArIGNhY2hlS2V5KTsKCiAgICAgICAgICAgIHZhciBkb20gPSB0aGlzLmRvRXhlY3V0ZShjYWNoZUtleSwgbW9kZWwsIGNhbGxiYWNrKTsKCiAgICAgICAgICAgIC8vIGlmIHdyYXBwZWQgaW4gc2NyaXB0IHRhZywgc3RyaXAgYXdheQogICAgICAgICAgICB2YXIgc3RyaXBfc2NyaXB0ID0gZnVuY3Rpb24oZG9tKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBpZiBpZiBzdGFydHMgd2l0aCBhIHNjcmlwdCB0YWcsIHRoZW4gd2Ugc3RyaXAgdGhhdCBvdXQKICAgICAgICAgICAgICAgIGlmICgkKGRvbSkubGVuZ3RoID09IDEpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCQoZG9tKVswXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09ICJzY3JpcHQiKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICQoZG9tKS5odG1sKCk7CgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gaHRtbDsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGRvbSA9IHN0cmlwX3NjcmlwdChkb20pOwoKICAgICAgICAgICAgcmV0dXJuIGRvbTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAZXh0ZW5zaW9uX3BvaW50CiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gY2FjaGVLZXkKICAgICAgICAgKiBAcGFyYW0gbW9kZWwKICAgICAgICAgKiBAcGFyYW0gY2FsbGJhY2sKICAgICAgICAgKi8KICAgICAgICBkb0V4ZWN1dGU6IGZ1bmN0aW9uKGNhY2hlS2V5LCBtb2RlbCwgY2FsbGJhY2spCiAgICAgICAgewoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBIYW5kcyBiYWNrIHRoZSBleHBlY3RlZCBmaWxlIGV4dGVuc2lvbiBmb3IgdGVtcGxhdGVzIGxvYWRlZCB2aWEgVVJJLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGZpbGVFeHRlbnNpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gImh0bWwiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEhhbmRzIGJhY2sgdGhlIGxpc3Qgb2YgYXNzb2NpYXRlZCBzY3JpcHQgdGFnIHR5cGVzIGZvciB0ZW1wbGF0ZXMgbG9hZGVkIGZyb20gdGhlIERPTS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge0FycmF5fQogICAgICAgICAqLwogICAgICAgIHN1cHBvcnRlZE1pbWV0eXBlczogZnVuY3Rpb24oKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIERldGVybWluZXMgd2hldGhlciBhbiBleGlzdGluZyB0ZW1wbGF0ZSBpcyBhbHJlYWR5IGluIGNhY2hlLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIGNhY2hlS2V5CiAgICAgICAgICovCiAgICAgICAgaXNDYWNoZWQ6IGZ1bmN0aW9uKGNhY2hlS2V5KQogICAgICAgIHsKCiAgICAgICAgfQoKICAgIH0pOwoKfSkoalF1ZXJ5KTsoZnVuY3Rpb24oJCkKewogICAgQWxwYWNhLkpRdWVyeVRlbXBsYXRlRW5naW5lID0gQWxwYWNhLkFic3RyYWN0VGVtcGxhdGVFbmdpbmUuZXh0ZW5kKAogICAgewogICAgICAgIGZpbGVFeHRlbnNpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gImh0bWwiOwogICAgICAgIH0sCgogICAgICAgIHN1cHBvcnRlZE1pbWV0eXBlczogZnVuY3Rpb24oKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICJ0ZXh0L3gtanF1ZXJ5LXRlbXBsYXRlIiwKICAgICAgICAgICAgICAgICJ0ZXh0L3gtanF1ZXJ5LXRtcGwiCiAgICAgICAgICAgIF07CiAgICAgICAgfSwKCiAgICAgICAgZG9Db21waWxlOiBmdW5jdGlvbihjYWNoZUtleSwgaHRtbCwgY2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0cnkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgJC50ZW1wbGF0ZShjYWNoZUtleSwgaHRtbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2F0Y2ggKGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKGUpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBBbHBhY2EuVGVtcGxhdGVDYWNoZVtjYWNoZUtleV0gPSBodG1sOwoKICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICB9LAoKICAgICAgICBkb0V4ZWN1dGU6IGZ1bmN0aW9uKGNhY2hlS2V5LCBtb2RlbCwgY2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICAvLyByZW5kZXIgdGVtcGxhdGUKICAgICAgICAgICAgdmFyIGh0bWwgPSBudWxsOwogICAgICAgICAgICB0cnkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGRvbSA9ICQudG1wbChjYWNoZUtleSwgbW9kZWwpOwoKICAgICAgICAgICAgICAgIC8vIGNvbnZlcnQgdG8gc3RyaW5nCiAgICAgICAgICAgICAgICB2YXIgX2h0bWwgPSBkb20ub3V0ZXJIVE1MKCk7CgogICAgICAgICAgICAgICAgLy8gc3RyaXAgb3V0IHRoZSBfdG1wbGl0ZW0gYXR0cmlidXRlIGlmIGl0IGlzIHN0aWNraW5nIGFyb3VuZCBhbnl3aGVyZQogICAgICAgICAgICAgICAgdmFyIGkgPSAtMTsKICAgICAgICAgICAgICAgIGRvCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaSA9IF9odG1sLmluZGV4T2YoIl90bXBsaXRlbT0iKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaSA+IC0xKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGogPSBfaHRtbC5pbmRleE9mKCIgIiwgaSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqID09IC0xKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqID0gX2h0bWwuaW5kZXhPZigiPiIsIGkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqID09IC0xKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBtYWtlIHN1cmUgd2UgZG9uJ3Qgd2FuZGVyIG9mZiBpbnRvIGFuIGluZmluaXRlIGxvb3AKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVzc2FnZSI6ICJTaG91bGQgaGF2ZSBmb3VuZCBjbG9zaW5nIHdoaXRlc3BhY2Ugb3IgJz4nIGZvciBfdG1wbGl0ZW0gYXR0cmlidXRlIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIF9odG1sID0gX2h0bWwuc3Vic3RyaW5nKDAsIGkpICsgX2h0bWwuc3Vic3RyaW5nKGopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHdoaWxlIChpID4gLTEpOwoKICAgICAgICAgICAgICAgIC8vIGNvbnZlcnQgYmFjayB0byBkb20gc2FmZWx5IChJRSBidWcgcmVzaXN0YW50KQogICAgICAgICAgICAgICAgZG9tID0gQWxwYWNhLnNhZmVEb21QYXJzZShfaHRtbCk7CgogICAgICAgICAgICAgICAgaHRtbCA9IGRvbTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXRjaCAoZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2FsbGJhY2soewogICAgICAgICAgICAgICAgICAgICJtZXNzYWdlIjogZS5tZXNzYWdlCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGh0bWw7CiAgICAgICAgfSwKCiAgICAgICAgaXNDYWNoZWQ6IGZ1bmN0aW9uKGNhY2hlS2V5KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIChBbHBhY2EuVGVtcGxhdGVDYWNoZVtjYWNoZUtleV0gPyB0cnVlIDogZmFsc2UpOwogICAgICAgIH0KCiAgICB9KTsKCiAgICAvLyBhdXRvIHJlZ2lzdGVyCiAgICBBbHBhY2EuVGVtcGxhdGVFbmdpbmVSZWdpc3RyeS5yZWdpc3RlcigidG1wbCIsIG5ldyBBbHBhY2EuSlF1ZXJ5VGVtcGxhdGVFbmdpbmUoInRtcGwiKSk7Cgp9KShqUXVlcnkpOyhmdW5jdGlvbigkKQp7CiAgICBBbHBhY2EuRUpTVGVtcGxhdGVFbmdpbmUgPSBBbHBhY2EuQWJzdHJhY3RUZW1wbGF0ZUVuZ2luZS5leHRlbmQoCiAgICB7CiAgICAgICAgZmlsZUV4dGVuc2lvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiZWpzIjsKICAgICAgICB9LAoKICAgICAgICBzdXBwb3J0ZWRNaW1ldHlwZXM6IGZ1bmN0aW9uKCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICAidGV4dC94LWVqcy10ZW1wbGF0ZSIsCiAgICAgICAgICAgICAgICAidGV4dC94LWVqcy10bXBsIgogICAgICAgICAgICBdOwogICAgICAgIH0sCgogICAgICAgIGRvQ29tcGlsZTogZnVuY3Rpb24oY2FjaGVLZXksIGh0bWwsIGNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGVqcyA9IG51bGw7CiAgICAgICAgICAgIHRyeQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlanMgPSBuZXcgRUpTKHsKICAgICAgICAgICAgICAgICAgICBuYW1lOiBjYWNoZUtleSwKICAgICAgICAgICAgICAgICAgICB0ZXh0OiBodG1sCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXRjaCAoZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2FsbGJhY2soZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIEFscGFjYS5UZW1wbGF0ZUNhY2hlW2NhY2hlS2V5XSA9IGVqczsKCiAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgfSwKCiAgICAgICAgZG9FeGVjdXRlOiBmdW5jdGlvbihjYWNoZUtleSwgbW9kZWwsIGNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGVqcyA9IEFscGFjYS5UZW1wbGF0ZUNhY2hlW2NhY2hlS2V5XTsKCiAgICAgICAgICAgIC8vIHJlbmRlciB0ZW1wbGF0ZQogICAgICAgICAgICB2YXIgaHRtbCA9IG51bGw7CiAgICAgICAgICAgIHRyeQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBodG1sID0gZWpzLnJlbmRlcihtb2RlbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2F0Y2ggKGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKGUpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBodG1sOwogICAgICAgIH0sCgogICAgICAgIGlzQ2FjaGVkOiBmdW5jdGlvbihjYWNoZUtleSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiAoQWxwYWNhLlRlbXBsYXRlQ2FjaGVbY2FjaGVLZXldID8gdHJ1ZSA6IGZhbHNlKTsKICAgICAgICB9CgogICAgfSk7CgogICAgLy8gYXV0byByZWdpc3RlcgogICAgQWxwYWNhLlRlbXBsYXRlRW5naW5lUmVnaXN0cnkucmVnaXN0ZXIoImVqcyIsIG5ldyBBbHBhY2EuRUpTVGVtcGxhdGVFbmdpbmUoImVqcyIpKTsKCn0pKGpRdWVyeSk7KGZ1bmN0aW9uKCQpCnsKICAgIEFscGFjYS5IYW5kbGViYXJzVGVtcGxhdGVFbmdpbmUgPSBBbHBhY2EuQWJzdHJhY3RUZW1wbGF0ZUVuZ2luZS5leHRlbmQoCiAgICB7CiAgICAgICAgZmlsZUV4dGVuc2lvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiaHRtbCI7CiAgICAgICAgfSwKCiAgICAgICAgc3VwcG9ydGVkTWltZXR5cGVzOiBmdW5jdGlvbigpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgInRleHQveC1oYW5kbGViYXJzLXRlbXBsYXRlIiwKICAgICAgICAgICAgICAgICJ0ZXh0L3gtaGFuZGxlYmFycy10bXBsIgogICAgICAgICAgICBdOwogICAgICAgIH0sCgogICAgICAgIGRvQ29tcGlsZTogZnVuY3Rpb24oY2FjaGVLZXksIGh0bWwsIGNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gbnVsbDsKICAgICAgICAgICAgdHJ5CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRlbXBsYXRlID0gSGFuZGxlYmFycy5jb21waWxlKGh0bWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoIChlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjYWxsYmFjayhlKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgQWxwYWNhLlRlbXBsYXRlQ2FjaGVbY2FjaGVLZXldID0gdGVtcGxhdGU7CgogICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgIH0sCgogICAgICAgIGRvRXhlY3V0ZTogZnVuY3Rpb24oY2FjaGVLZXksIG1vZGVsLCBjYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IEFscGFjYS5UZW1wbGF0ZUNhY2hlW2NhY2hlS2V5XTsKCiAgICAgICAgICAgIC8vIHJlbmRlciB0ZW1wbGF0ZQogICAgICAgICAgICB2YXIgaHRtbCA9IG51bGw7CiAgICAgICAgICAgIHRyeQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBodG1sID0gdGVtcGxhdGUobW9kZWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoIChlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjYWxsYmFjayhlKTsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gaHRtbDsKICAgICAgICB9LAoKICAgICAgICBpc0NhY2hlZDogZnVuY3Rpb24oY2FjaGVLZXkpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gKEFscGFjYS5UZW1wbGF0ZUNhY2hlW2NhY2hlS2V5XSA/IHRydWUgOiBmYWxzZSk7CiAgICAgICAgfQoKICAgIH0pOwoKICAgIC8vIGF1dG8gcmVnaXN0ZXIKICAgIEFscGFjYS5UZW1wbGF0ZUVuZ2luZVJlZ2lzdHJ5LnJlZ2lzdGVyKCJoYW5kbGViYXJzIiwgbmV3IEFscGFjYS5IYW5kbGViYXJzVGVtcGxhdGVFbmdpbmUoImhhbmRsZWJhcnMiKSk7Cgp9KShqUXVlcnkpOy8qKgogKiBEZWZpbmVzIHRoZSBiYXNlIGNsYXNzIGltcGxlbWVudGF0aW9uIGZvciB2aWV3cy4gIEFsbCB2aWV3cyBpbiBBbHBhY2EgdWx0aW1hdGVseSBleHRlbmQgdGhpcyBmb3JtLgogKiBUaGlzIHByb3ZpZGVzIHRoZSBpZGVhbCBwbGFjZSBmb3IgYW55IGdsb2JhbCBvdmVycmlkZXMgb2YgdmlldyB0ZW1wbGF0ZXMsIG1lc3NhZ2UgYnVuZGxlcyBvciBvdGhlciBzZXR0aW5ncy4KICovCihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5zdHlsZUluamVjdGlvbnMgPSB7fTsKCiAgICBBbHBhY2EucmVnaXN0ZXJWaWV3KHsKICAgICAgICAiaWQiOiAiVklFV19CQVNFIiwKICAgICAgICAidGl0bGUiOiAiQWJzdHJhY3QgYmFzZSB2aWV3IiwKICAgICAgICAiZGVzY3JpcHRpb24iOiAiRm91bmRhdGlvbiB2aWV3IHdoaWNoIHByb3ZpZGVzIGFuIGFic3RyYWN0IHZpZXcgZnJvbSB3aGljaCBhbGwgb3RoZXIgdmlld3MgZXh0ZW5kLiIsCiAgICAgICAgIm1lc3NhZ2VzIjogewogICAgICAgICAgICAiY291bnRyaWVzIjogewogICAgICAgICAgICAgICAgImFmZyI6IkFmZ2hhbmlzdGFuIiwKICAgICAgICAgICAgICAgICJhbGEiOiJBbGFuZCBJc2xhbmRzIiwKICAgICAgICAgICAgICAgICJhbGIiOiJBbGJhbmlhIiwKICAgICAgICAgICAgICAgICJkemEiOiJBbGdlcmlhIiwKICAgICAgICAgICAgICAgICJhc20iOiJBbWVyaWNhbiBTYW1vYSIsCiAgICAgICAgICAgICAgICAiYW5kIjoiQW5kb3JyYSIsCiAgICAgICAgICAgICAgICAiYWdvIjoiQW5nb2xhIiwKICAgICAgICAgICAgICAgICJhaWEiOiJBbmd1aWxsYSIsCiAgICAgICAgICAgICAgICAiYXRhIjoiQW50YXJjdGljYSIsCiAgICAgICAgICAgICAgICAiYXRnIjoiQW50aWd1YSBhbmQgQmFyYnVkYSIsCiAgICAgICAgICAgICAgICAiYXJnIjoiQXJnZW50aW5hIiwKICAgICAgICAgICAgICAgICJhcm0iOiJBcm1lbmlhIiwKICAgICAgICAgICAgICAgICJhYnciOiJBcnViYSIsCiAgICAgICAgICAgICAgICAiYXVzIjoiQXVzdHJhbGlhIiwKICAgICAgICAgICAgICAgICJhdXQiOiJBdXN0cmlhIiwKICAgICAgICAgICAgICAgICJhemUiOiJBemVyYmFpamFuIiwKICAgICAgICAgICAgICAgICJiaHMiOiJCYWhhbWFzIiwKICAgICAgICAgICAgICAgICJiaHIiOiJCYWhyYWluIiwKICAgICAgICAgICAgICAgICJiZ2QiOiJCYW5nbGFkZXNoIiwKICAgICAgICAgICAgICAgICJicmIiOiJCYXJiYWRvcyIsCiAgICAgICAgICAgICAgICAiYmxyIjoiQmVsYXJ1cyIsCiAgICAgICAgICAgICAgICAiYmVsIjoiQmVsZ2l1bSIsCiAgICAgICAgICAgICAgICAiYmx6IjoiQmVsaXplIiwKICAgICAgICAgICAgICAgICJiZW4iOiJCZW5pbiIsCiAgICAgICAgICAgICAgICAiYm11IjoiQmVybXVkYSIsCiAgICAgICAgICAgICAgICAiYnRuIjoiQmh1dGFuIiwKICAgICAgICAgICAgICAgICJib2wiOiJCb2xpdmlhIiwKICAgICAgICAgICAgICAgICJiaWgiOiJCb3NuaWEgYW5kIEhlcnplZ292aW5hIiwKICAgICAgICAgICAgICAgICJid2EiOiJCb3Rzd2FuYSIsCiAgICAgICAgICAgICAgICAiYnZ0IjoiQm91dmV0IElzbGFuZCIsCiAgICAgICAgICAgICAgICAiYnJhIjoiQnJhemlsIiwKICAgICAgICAgICAgICAgICJpb3QiOiJCcml0aXNoIEluZGlhbiBPY2VhbiBUZXJyaXRvcnkiLAogICAgICAgICAgICAgICAgImJybiI6IkJydW5laSBEYXJ1c3NhbGFtIiwKICAgICAgICAgICAgICAgICJiZ3IiOiJCdWxnYXJpYSIsCiAgICAgICAgICAgICAgICAiYmZhIjoiQnVya2luYSBGYXNvIiwKICAgICAgICAgICAgICAgICJiZGkiOiJCdXJ1bmRpIiwKICAgICAgICAgICAgICAgICJraG0iOiJDYW1ib2RpYSIsCiAgICAgICAgICAgICAgICAiY21yIjoiQ2FtZXJvb24iLAogICAgICAgICAgICAgICAgImNhbiI6IkNhbmFkYSIsCiAgICAgICAgICAgICAgICAiY3B2IjoiQ2FwZSBWZXJkZSIsCiAgICAgICAgICAgICAgICAiY3ltIjoiQ2F5bWFuIElzbGFuZHMiLAogICAgICAgICAgICAgICAgImNhZiI6IkNlbnRyYWwgQWZyaWNhbiBSZXB1YmxpYyIsCiAgICAgICAgICAgICAgICAidGNkIjoiQ2hhZCIsCiAgICAgICAgICAgICAgICAiY2hsIjoiQ2hpbGUiLAogICAgICAgICAgICAgICAgImNobiI6IkNoaW5hIiwKICAgICAgICAgICAgICAgICJjeHIiOiJDaHJpc3RtYXMgSXNsYW5kIiwKICAgICAgICAgICAgICAgICJjY2siOiJDb2NvcyAoS2VlbGluZyksIElzbGFuZHMiLAogICAgICAgICAgICAgICAgImNvbCI6IkNvbG9tYmlhIiwKICAgICAgICAgICAgICAgICJjb20iOiJDb21vcm9zIiwKICAgICAgICAgICAgICAgICJjb2ciOiJDb25nbyIsCiAgICAgICAgICAgICAgICAiY29kIjoiQ29uZ28sIHRoZSBEZW1vY3JhdGljIFJlcHVibGljIG9mIHRoZSIsCiAgICAgICAgICAgICAgICAiY29rIjoiQ29vayBJc2xhbmRzIiwKICAgICAgICAgICAgICAgICJjcmkiOiJDb3N0YSBSaWNhIiwKICAgICAgICAgICAgICAgICJocnYiOiJDcm9hdGlhIiwKICAgICAgICAgICAgICAgICJjdWIiOiJDdWJhIiwKICAgICAgICAgICAgICAgICJjeXAiOiJDeXBydXMiLAogICAgICAgICAgICAgICAgImN6ZSI6IkN6ZWNoIFJlcHVibGljIiwKICAgICAgICAgICAgICAgICJjaXYiOiJDb3RlIGQnSXZvaXJlIiwKICAgICAgICAgICAgICAgICJkbmsiOiJEZW5tYXJrIiwKICAgICAgICAgICAgICAgICJkamkiOiJEamlib3V0aSIsCiAgICAgICAgICAgICAgICAiZG1hIjoiRG9taW5pY2EiLAogICAgICAgICAgICAgICAgImRvbSI6IkRvbWluaWNhbiBSZXB1YmxpYyIsCiAgICAgICAgICAgICAgICAiZWN1IjoiRWN1YWRvciIsCiAgICAgICAgICAgICAgICAiZWd5IjoiRWd5cHQiLAogICAgICAgICAgICAgICAgInNsdiI6IkVsIFNhbHZhZG9yIiwKICAgICAgICAgICAgICAgICJnbnEiOiJFcXVhdG9yaWFsIEd1aW5lYSIsCiAgICAgICAgICAgICAgICAiZXJpIjoiRXJpdHJlYSIsCiAgICAgICAgICAgICAgICAiZXN0IjoiRXN0b25pYSIsCiAgICAgICAgICAgICAgICAiZXRoIjoiRXRoaW9waWEiLAogICAgICAgICAgICAgICAgImZsayI6IkZhbGtsYW5kIElzbGFuZHMgKE1hbHZpbmFzKSwiLAogICAgICAgICAgICAgICAgImZybyI6IkZhcm9lIElzbGFuZHMiLAogICAgICAgICAgICAgICAgImZqaSI6IkZpamkiLAogICAgICAgICAgICAgICAgImZpbiI6IkZpbmxhbmQiLAogICAgICAgICAgICAgICAgImZyYSI6IkZyYW5jZSIsCiAgICAgICAgICAgICAgICAiZ3VmIjoiRnJlbmNoIEd1aWFuYSIsCiAgICAgICAgICAgICAgICAicHlmIjoiRnJlbmNoIFBvbHluZXNpYSIsCiAgICAgICAgICAgICAgICAiYXRmIjoiRnJlbmNoIFNvdXRoZXJuIFRlcnJpdG9yaWVzIiwKICAgICAgICAgICAgICAgICJnYWIiOiJHYWJvbiIsCiAgICAgICAgICAgICAgICAiZ21iIjoiR2FtYmlhIiwKICAgICAgICAgICAgICAgICJnZW8iOiJHZW9yZ2lhIiwKICAgICAgICAgICAgICAgICJkZXUiOiJHZXJtYW55IiwKICAgICAgICAgICAgICAgICJnaGEiOiJHaGFuYSIsCiAgICAgICAgICAgICAgICAiZ2liIjoiR2licmFsdGFyIiwKICAgICAgICAgICAgICAgICJncmMiOiJHcmVlY2UiLAogICAgICAgICAgICAgICAgImdybCI6IkdyZWVubGFuZCIsCiAgICAgICAgICAgICAgICAiZ3JkIjoiR3JlbmFkYSIsCiAgICAgICAgICAgICAgICAiZ2xwIjoiR3VhZGVsb3VwZSIsCiAgICAgICAgICAgICAgICAiZ3VtIjoiR3VhbSIsCiAgICAgICAgICAgICAgICAiZ3RtIjoiR3VhdGVtYWxhIiwKICAgICAgICAgICAgICAgICJnZ3kiOiJHdWVybnNleSIsCiAgICAgICAgICAgICAgICAiZ2luIjoiR3VpbmVhIiwKICAgICAgICAgICAgICAgICJnbmIiOiJHdWluZWEtQmlzc2F1IiwKICAgICAgICAgICAgICAgICJndXkiOiJHdXlhbmEiLAogICAgICAgICAgICAgICAgImh0aSI6IkhhaXRpIiwKICAgICAgICAgICAgICAgICJobWQiOiJIZWFyZCBJc2xhbmQgYW5kIE1jRG9uYWxkIElzbGFuZHMiLAogICAgICAgICAgICAgICAgInZhdCI6IkhvbHkgU2VlIChWYXRpY2FuIENpdHkgU3RhdGUpLCIsCiAgICAgICAgICAgICAgICAiaG5kIjoiSG9uZHVyYXMiLAogICAgICAgICAgICAgICAgImhrZyI6IkhvbmcgS29uZyIsCiAgICAgICAgICAgICAgICAiaHVuIjoiSHVuZ2FyeSIsCiAgICAgICAgICAgICAgICAiaXNsIjoiSWNlbGFuZCIsCiAgICAgICAgICAgICAgICAiaW5kIjoiSW5kaWEiLAogICAgICAgICAgICAgICAgImlkbiI6IkluZG9uZXNpYSIsCiAgICAgICAgICAgICAgICAiaXJuIjoiSXJhbiwgSXNsYW1pYyBSZXB1YmxpYyBvZiIsCiAgICAgICAgICAgICAgICAiaXJxIjoiSXJhcSIsCiAgICAgICAgICAgICAgICAiaXJsIjoiSXJlbGFuZCIsCiAgICAgICAgICAgICAgICAiaW1uIjoiSXNsZSBvZiBNYW4iLAogICAgICAgICAgICAgICAgImlzciI6IklzcmFlbCIsCiAgICAgICAgICAgICAgICAiaXRhIjoiSXRhbHkiLAogICAgICAgICAgICAgICAgImphbSI6IkphbWFpY2EiLAogICAgICAgICAgICAgICAgImpwbiI6IkphcGFuIiwKICAgICAgICAgICAgICAgICJqZXkiOiJKZXJzZXkiLAogICAgICAgICAgICAgICAgImpvciI6IkpvcmRhbiIsCiAgICAgICAgICAgICAgICAia2F6IjoiS2F6YWtoc3RhbiIsCiAgICAgICAgICAgICAgICAia2VuIjoiS2VueWEiLAogICAgICAgICAgICAgICAgImtpciI6IktpcmliYXRpIiwKICAgICAgICAgICAgICAgICJwcmsiOiJLb3JlYSwgRGVtb2NyYXRpYyBQZW9wbGUncyBSZXB1YmxpYyBvZiIsCiAgICAgICAgICAgICAgICAia29yIjoiS29yZWEsIFJlcHVibGljIG9mIiwKICAgICAgICAgICAgICAgICJrd3QiOiJLdXdhaXQiLAogICAgICAgICAgICAgICAgImtneiI6Ikt5cmd5enN0YW4iLAogICAgICAgICAgICAgICAgImxhbyI6IkxhbyBQZW9wbGUncyBEZW1vY3JhdGljIFJlcHVibGljIiwKICAgICAgICAgICAgICAgICJsdmEiOiJMYXR2aWEiLAogICAgICAgICAgICAgICAgImxibiI6IkxlYmFub24iLAogICAgICAgICAgICAgICAgImxzbyI6Ikxlc290aG8iLAogICAgICAgICAgICAgICAgImxiciI6IkxpYmVyaWEiLAogICAgICAgICAgICAgICAgImxieSI6IkxpYnlhbiBBcmFiIEphbWFoaXJpeWEiLAogICAgICAgICAgICAgICAgImxpZSI6IkxpZWNodGVuc3RlaW4iLAogICAgICAgICAgICAgICAgImx0dSI6IkxpdGh1YW5pYSIsCiAgICAgICAgICAgICAgICAibHV4IjoiTHV4ZW1ib3VyZyIsCiAgICAgICAgICAgICAgICAibWFjIjoiTWFjYW8iLAogICAgICAgICAgICAgICAgIm1rZCI6Ik1hY2Vkb25pYSwgdGhlIGZvcm1lciBZdWdvc2xhdiBSZXB1YmxpYyBvZiIsCiAgICAgICAgICAgICAgICAibWRnIjoiTWFkYWdhc2NhciIsCiAgICAgICAgICAgICAgICAibXdpIjoiTWFsYXdpIiwKICAgICAgICAgICAgICAgICJteXMiOiJNYWxheXNpYSIsCiAgICAgICAgICAgICAgICAibWR2IjoiTWFsZGl2ZXMiLAogICAgICAgICAgICAgICAgIm1saSI6Ik1hbGkiLAogICAgICAgICAgICAgICAgIm1sdCI6Ik1hbHRhIiwKICAgICAgICAgICAgICAgICJtaGwiOiJNYXJzaGFsbCBJc2xhbmRzIiwKICAgICAgICAgICAgICAgICJtdHEiOiJNYXJ0aW5pcXVlIiwKICAgICAgICAgICAgICAgICJtcnQiOiJNYXVyaXRhbmlhIiwKICAgICAgICAgICAgICAgICJtdXMiOiJNYXVyaXRpdXMiLAogICAgICAgICAgICAgICAgIm15dCI6Ik1heW90dGUiLAogICAgICAgICAgICAgICAgIm1leCI6Ik1leGljbyIsCiAgICAgICAgICAgICAgICAiZnNtIjoiTWljcm9uZXNpYSwgRmVkZXJhdGVkIFN0YXRlcyBvZiIsCiAgICAgICAgICAgICAgICAibWRhIjoiTW9sZG92YSwgUmVwdWJsaWMgb2YiLAogICAgICAgICAgICAgICAgIm1jbyI6Ik1vbmFjbyIsCiAgICAgICAgICAgICAgICAibW5nIjoiTW9uZ29saWEiLAogICAgICAgICAgICAgICAgIm1uZSI6Ik1vbnRlbmVncm8iLAogICAgICAgICAgICAgICAgIm1zciI6Ik1vbnRzZXJyYXQiLAogICAgICAgICAgICAgICAgIm1hciI6Ik1vcm9jY28iLAogICAgICAgICAgICAgICAgIm1veiI6Ik1vemFtYmlxdWUiLAogICAgICAgICAgICAgICAgIm1tciI6Ik15YW5tYXIiLAogICAgICAgICAgICAgICAgIm5hbSI6Ik5hbWliaWEiLAogICAgICAgICAgICAgICAgIm5ydSI6Ik5hdXJ1IiwKICAgICAgICAgICAgICAgICJucGwiOiJOZXBhbCIsCiAgICAgICAgICAgICAgICAibmxkIjoiTmV0aGVybGFuZHMiLAogICAgICAgICAgICAgICAgImFudCI6Ik5ldGhlcmxhbmRzIEFudGlsbGVzIiwKICAgICAgICAgICAgICAgICJuY2wiOiJOZXcgQ2FsZWRvbmlhIiwKICAgICAgICAgICAgICAgICJuemwiOiJOZXcgWmVhbGFuZCIsCiAgICAgICAgICAgICAgICAibmljIjoiTmljYXJhZ3VhIiwKICAgICAgICAgICAgICAgICJuZXIiOiJOaWdlciIsCiAgICAgICAgICAgICAgICAibmdhIjoiTmlnZXJpYSIsCiAgICAgICAgICAgICAgICAibml1IjoiTml1ZSIsCiAgICAgICAgICAgICAgICAibmZrIjoiTm9yZm9sayBJc2xhbmQiLAogICAgICAgICAgICAgICAgIm1ucCI6Ik5vcnRoZXJuIE1hcmlhbmEgSXNsYW5kcyIsCiAgICAgICAgICAgICAgICAibm9yIjoiTm9yd2F5IiwKICAgICAgICAgICAgICAgICJvbW4iOiJPbWFuIiwKICAgICAgICAgICAgICAgICJwYWsiOiJQYWtpc3RhbiIsCiAgICAgICAgICAgICAgICAicGx3IjoiUGFsYXUiLAogICAgICAgICAgICAgICAgInBzZSI6IlBhbGVzdGluaWFuIFRlcnJpdG9yeSwgT2NjdXBpZWQiLAogICAgICAgICAgICAgICAgInBhbiI6IlBhbmFtYSIsCiAgICAgICAgICAgICAgICAicG5nIjoiUGFwdWEgTmV3IEd1aW5lYSIsCiAgICAgICAgICAgICAgICAicHJ5IjoiUGFyYWd1YXkiLAogICAgICAgICAgICAgICAgInBlciI6IlBlcnUiLAogICAgICAgICAgICAgICAgInBobCI6IlBoaWxpcHBpbmVzIiwKICAgICAgICAgICAgICAgICJwY24iOiJQaXRjYWlybiIsCiAgICAgICAgICAgICAgICAicG9sIjoiUG9sYW5kIiwKICAgICAgICAgICAgICAgICJwcnQiOiJQb3J0dWdhbCIsCiAgICAgICAgICAgICAgICAicHJpIjoiUHVlcnRvIFJpY28iLAogICAgICAgICAgICAgICAgInFhdCI6IlFhdGFyIiwKICAgICAgICAgICAgICAgICJyb3UiOiJSb21hbmlhIiwKICAgICAgICAgICAgICAgICJydXMiOiJSdXNzaWFuIEZlZGVyYXRpb24iLAogICAgICAgICAgICAgICAgInJ3YSI6IlJ3YW5kYSIsCiAgICAgICAgICAgICAgICAicmV1IjoiUmV1bmlvbiIsCiAgICAgICAgICAgICAgICAiYmxtIjoiU2FpbnQgQmFydGhlbGVteSIsCiAgICAgICAgICAgICAgICAic2huIjoiU2FpbnQgSGVsZW5hIiwKICAgICAgICAgICAgICAgICJrbmEiOiJTYWludCBLaXR0cyBhbmQgTmV2aXMiLAogICAgICAgICAgICAgICAgImxjYSI6IlNhaW50IEx1Y2lhIiwKICAgICAgICAgICAgICAgICJtYWYiOiJTYWludCBNYXJ0aW4gKEZyZW5jaCBwYXJ0KSIsCiAgICAgICAgICAgICAgICAic3BtIjoiU2FpbnQgUGllcnJlIGFuZCBNaXF1ZWxvbiIsCiAgICAgICAgICAgICAgICAidmN0IjoiU2FpbnQgVmluY2VudCBhbmQgdGhlIEdyZW5hZGluZXMiLAogICAgICAgICAgICAgICAgIndzbSI6IlNhbW9hIiwKICAgICAgICAgICAgICAgICJzbXIiOiJTYW4gTWFyaW5vIiwKICAgICAgICAgICAgICAgICJzdHAiOiJTYW8gVG9tZSBhbmQgUHJpbmNpcGUiLAogICAgICAgICAgICAgICAgInNhdSI6IlNhdWRpIEFyYWJpYSIsCiAgICAgICAgICAgICAgICAic2VuIjoiU2VuZWdhbCIsCiAgICAgICAgICAgICAgICAic3JiIjoiU2VyYmlhIiwKICAgICAgICAgICAgICAgICJzeWMiOiJTZXljaGVsbGVzIiwKICAgICAgICAgICAgICAgICJzbGUiOiJTaWVycmEgTGVvbmUiLAogICAgICAgICAgICAgICAgInNncCI6IlNpbmdhcG9yZSIsCiAgICAgICAgICAgICAgICAic3ZrIjoiU2xvdmFraWEiLAogICAgICAgICAgICAgICAgInN2biI6IlNsb3ZlbmlhIiwKICAgICAgICAgICAgICAgICJzbGIiOiJTb2xvbW9uIElzbGFuZHMiLAogICAgICAgICAgICAgICAgInNvbSI6IlNvbWFsaWEiLAogICAgICAgICAgICAgICAgInphZiI6IlNvdXRoIEFmcmljYSIsCiAgICAgICAgICAgICAgICAic2dzIjoiU291dGggR2VvcmdpYSBhbmQgdGhlIFNvdXRoIFNhbmR3aWNoIElzbGFuZHMiLAogICAgICAgICAgICAgICAgImVzcCI6IlNwYWluIiwKICAgICAgICAgICAgICAgICJsa2EiOiJTcmkgTGFua2EiLAogICAgICAgICAgICAgICAgInNkbiI6IlN1ZGFuIiwKICAgICAgICAgICAgICAgICJzdXIiOiJTdXJpbmFtZSIsCiAgICAgICAgICAgICAgICAic2ptIjoiU3ZhbGJhcmQgYW5kIEphbiBNYXllbiIsCiAgICAgICAgICAgICAgICAic3d6IjoiU3dhemlsYW5kIiwKICAgICAgICAgICAgICAgICJzd2UiOiJTd2VkZW4iLAogICAgICAgICAgICAgICAgImNoZSI6IlN3aXR6ZXJsYW5kIiwKICAgICAgICAgICAgICAgICJzeXIiOiJTeXJpYW4gQXJhYiBSZXB1YmxpYyIsCiAgICAgICAgICAgICAgICAidHduIjoiVGFpd2FuLCBQcm92aW5jZSBvZiBDaGluYSIsCiAgICAgICAgICAgICAgICAidGprIjoiVGFqaWtpc3RhbiIsCiAgICAgICAgICAgICAgICAidHphIjoiVGFuemFuaWEsIFVuaXRlZCBSZXB1YmxpYyBvZiIsCiAgICAgICAgICAgICAgICAidGhhIjoiVGhhaWxhbmQiLAogICAgICAgICAgICAgICAgInRscyI6IlRpbW9yLUxlc3RlIiwKICAgICAgICAgICAgICAgICJ0Z28iOiJUb2dvIiwKICAgICAgICAgICAgICAgICJ0a2wiOiJUb2tlbGF1IiwKICAgICAgICAgICAgICAgICJ0b24iOiJUb25nYSIsCiAgICAgICAgICAgICAgICAidHRvIjoiVHJpbmlkYWQgYW5kIFRvYmFnbyIsCiAgICAgICAgICAgICAgICAidHVuIjoiVHVuaXNpYSIsCiAgICAgICAgICAgICAgICAidHVyIjoiVHVya2V5IiwKICAgICAgICAgICAgICAgICJ0a20iOiJUdXJrbWVuaXN0YW4iLAogICAgICAgICAgICAgICAgInRjYSI6IlR1cmtzIGFuZCBDYWljb3MgSXNsYW5kcyIsCiAgICAgICAgICAgICAgICAidHV2IjoiVHV2YWx1IiwKICAgICAgICAgICAgICAgICJ1Z2EiOiJVZ2FuZGEiLAogICAgICAgICAgICAgICAgInVrciI6IlVrcmFpbmUiLAogICAgICAgICAgICAgICAgImFyZSI6IlVuaXRlZCBBcmFiIEVtaXJhdGVzIiwKICAgICAgICAgICAgICAgICJnYnIiOiJVbml0ZWQgS2luZ2RvbSIsCiAgICAgICAgICAgICAgICAidXNhIjoiVW5pdGVkIFN0YXRlcyIsCiAgICAgICAgICAgICAgICAidW1pIjoiVW5pdGVkIFN0YXRlcyBNaW5vciBPdXRseWluZyBJc2xhbmRzIiwKICAgICAgICAgICAgICAgICJ1cnkiOiJVcnVndWF5IiwKICAgICAgICAgICAgICAgICJ1emIiOiJVemJla2lzdGFuIiwKICAgICAgICAgICAgICAgICJ2dXQiOiJWYW51YXR1IiwKICAgICAgICAgICAgICAgICJ2ZW4iOiJWZW5lenVlbGEiLAogICAgICAgICAgICAgICAgInZubSI6IlZpZXQgTmFtIiwKICAgICAgICAgICAgICAgICJ2Z2IiOiJWaXJnaW4gSXNsYW5kcywgQnJpdGlzaCIsCiAgICAgICAgICAgICAgICAidmlyIjoiVmlyZ2luIElzbGFuZHMsIFUuUy4iLAogICAgICAgICAgICAgICAgIndsZiI6IldhbGxpcyBhbmQgRnV0dW5hIiwKICAgICAgICAgICAgICAgICJlc2giOiJXZXN0ZXJuIFNhaGFyYSIsCiAgICAgICAgICAgICAgICAieWVtIjoiWWVtZW4iLAogICAgICAgICAgICAgICAgInptYiI6IlphbWJpYSIsCiAgICAgICAgICAgICAgICAiendlIjoiWmltYmFid2UiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJlbXB0eSI6ICIiLAogICAgICAgICAgICAicmVxdWlyZWQiOiAiVGhpcyBmaWVsZCBpcyByZXF1aXJlZCIsCiAgICAgICAgICAgICJ2YWxpZCI6ICIiLAogICAgICAgICAgICAiaW52YWxpZCI6ICJUaGlzIGZpZWxkIGlzIGludmFsaWQiLAogICAgICAgICAgICAibW9udGhzIjogWyJKYW51YXJ5IiwgIkZlYnJ1YXJ5IiwgIk1hcmNoIiwgIkFwcmlsIiwgIk1heSIsICJKdW5lIiwgIkp1bHkiLCAiQXVndXN0IiwgIlNlcHRlbWJlciIsICJPY3RvYmVyIiwgIk5vdmVtYmVyIiwgIkRlY2VtYmVyIl0sCiAgICAgICAgICAgICJ0aW1lVW5pdHMiOiB7IFNFQ09ORDogInNlY29uZHMiLCBNSU5VVEU6ICJtaW51dGVzIiwgSE9VUjogImhvdXJzIiwgREFZOiAiZGF5cyIsIE1PTlRIOiAibW9udGhzIiwgWUVBUjogInllYXJzIiB9CiAgICAgICAgfQogICAgfSk7CgogICAgLyoKICAgIEFscGFjYS5FbXB0eVZpZXdUZW1wbGF0ZXMgPSB7CiAgICAgICAgJ2NvbnRyb2xGaWVsZE91dGVyRWwnOiAne3todG1sIHRoaXMuaHRtbH19JywKICAgICAgICAnY29udHJvbEZpZWxkTWVzc2FnZSc6ICcke21lc3NhZ2V9JywKICAgICAgICAnY29udHJvbEZpZWxkTGFiZWwnOiAne3tpZiBvcHRpb25zLmxhYmVsfX0ke29wdGlvbnMubGFiZWx9e3svaWZ9fScsCiAgICAgICAgJ2NvbnRyb2xGaWVsZEhlbHBlcic6ICd7e2lmIG9wdGlvbnMuaGVscGVyfX0ke29wdGlvbnMuaGVscGVyfXt7L2lmfX0nLAogICAgICAgICdjb250cm9sRmllbGRDb250YWluZXInOiAne3todG1sIHRoaXMuaHRtbH19JywKICAgICAgICAnY29udHJvbEZpZWxkJzogJ3t7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiY29udHJvbEZpZWxkT3V0ZXJFbCIsdHJ1ZSl9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJjb250cm9sRmllbGRMYWJlbCIpfX17e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImNvbnRyb2xGaWVsZENvbnRhaW5lciIsdHJ1ZSl9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJjb250cm9sRmllbGRIZWxwZXIiKX19e3svd3JhcH19e3svd3JhcH19JywKICAgICAgICAnZmllbGRTZXRPdXRlckVsJzogJ3t7aHRtbCB0aGlzLmh0bWx9fScsCiAgICAgICAgJ2ZpZWxkU2V0TWVzc2FnZSc6ICcke21lc3NhZ2V9JywKICAgICAgICAnZmllbGRTZXRMZWdlbmQnOiAne3tpZiBvcHRpb25zLmxhYmVsfX0ke29wdGlvbnMubGFiZWx9e3svaWZ9fScsCiAgICAgICAgJ2ZpZWxkU2V0SGVscGVyJzogJ3t7aWYgb3B0aW9ucy5oZWxwZXJ9fSR7b3B0aW9ucy5oZWxwZXJ9e3svaWZ9fScsCiAgICAgICAgJ2ZpZWxkU2V0SXRlbXNDb250YWluZXInOiAne3todG1sIHRoaXMuaHRtbH19JywKICAgICAgICAnZmllbGRTZXQnOiAne3t3cmFwKG51bGwsIHt9KSBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmaWVsZFNldE91dGVyRWwiLHRydWUpfX17e2h0bWwgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiZmllbGRTZXRMZWdlbmQiKX19e3t3cmFwKG51bGwsIHt9KUFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0SXRlbXNDb250YWluZXIiLHRydWUpfX17ey93cmFwfX17ey93cmFwfX0nLAogICAgICAgICdmaWVsZFNldEl0ZW1Db250YWluZXInOiAnJywKICAgICAgICAnZm9ybUZpZWxkc0NvbnRhaW5lcic6ICd7e2h0bWwgdGhpcy5odG1sfX0nLAogICAgICAgICdmb3JtQnV0dG9uc0NvbnRhaW5lcic6ICd7e2lmIG9wdGlvbnMuYnV0dG9uc319e3tlYWNoKGssdikgb3B0aW9ucy5idXR0b25zfX08YnV0dG9uIGRhdGEta2V5PSIke2t9IiBjbGFzcz0iYWxwYWNhLWZvcm0tYnV0dG9uIGFscGFjYS1mb3JtLWJ1dHRvbi0ke2t9IiB7e2VhY2goazEsdjEpIHZ9fSR7azF9PSIke3YxfSJ7ey9lYWNofX0+JHt2LnZhbHVlfTwvYnV0dG9uPnt7L2VhY2h9fXt7L2lmfX0nLAogICAgICAgICdmb3JtJzogJzxmb3JtPnt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmb3JtRmllbGRzQ29udGFpbmVyIil9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmb3JtQnV0dG9uc0NvbnRhaW5lciIpfX08L2Zvcm0+JywKICAgICAgICAnd2l6YXJkU3RlcCc6ICcnLAogICAgICAgICd3aXphcmROYXZCYXInOiAnJywKICAgICAgICAnd2l6YXJkUHJlQnV0dG9uJzogJzxidXR0b24+QmFjazwvYnV0dG9uPicsCiAgICAgICAgJ3dpemFyZE5leHRCdXR0b24nOiAnPGJ1dHRvbj5OZXh0PC9idXR0b24+JywKICAgICAgICAnd2l6YXJkRG9uZUJ1dHRvbic6ICc8YnV0dG9uPkRvbmU8L2J1dHRvbj4nLAogICAgICAgICd3aXphcmRTdGF0dXNCYXInOiAnPG9sIGlkPSIke2lkfSI+e3tlYWNoKGksdikgdGl0bGVzfX08bGkgaWQ9InN0ZXBEZXNjJHtpfSI+PGRpdj48c3Ryb25nPjxzcGFuPiR7di50aXRsZX08L3NwYW4+JHt2LmRlc2NyaXB0aW9ufTwvc3Ryb25nPjwvZGl2PjwvbGk+e3svZWFjaH19PC9vbD4nLAogICAgICAgICdhcnJheVRvb2xiYXInOiAnJywKICAgICAgICAnYXJyYXlJdGVtVG9vbGJhcic6ICcnCiAgICB9OwogICAgKi8KICAgIEFscGFjYS5FbXB0eVZpZXdUZW1wbGF0ZXMgPSB7fTsKCn0pKGpRdWVyeSk7KGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLnN0eWxlSW5qZWN0aW9ucyA9IHt9OwoKICAgIHZhciBkaXNwbGF5VGVtcGxhdGVzID0gQWxwYWNhLkNyZWF0ZShBbHBhY2EuRW1wdHlWaWV3VGVtcGxhdGVzLCB7CiAgICAgICAgImNvbnRyb2xGaWVsZCI6ICc8ZGl2IGNsYXNzPSJhbHBhY2EtZGF0YS1jb250YWluZXIiPnt7aWYgb3B0aW9ucy5sYWJlbH19PGRpdiBjbGFzcz0iYWxwYWNhLWRhdGEtbGFiZWwiPiR7b3B0aW9ucy5sYWJlbH08L2Rpdj57ey9pZn19PGRpdiBjbGFzcz0iYWxwYWNhLWRhdGEiPiZuYnNwOyR7ZGF0YX08L2Rpdj48L2Rpdj4nLAogICAgICAgICJmaWVsZFNldE91dGVyRWwiOiAnPGRpdiBjbGFzcz0idWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50Ij57e2h0bWwgdGhpcy5odG1sfX08L2Rpdj4nLAogICAgICAgICJmaWVsZFNldExlZ2VuZCI6ICd7e2lmIG9wdGlvbnMubGFiZWx9fTxkaXYgY2xhc3M9Int7aWYgb3B0aW9ucy5sYWJlbENsYXNzfX0ke29wdGlvbnMubGFiZWxDbGFzc317ey9pZn19Ij4ke29wdGlvbnMubGFiZWx9PC9kaXY+e3svaWZ9fScsCiAgICAgICAgImZpZWxkU2V0SXRlbXNDb250YWluZXIiOiAnPGRpdj57e2h0bWwgdGhpcy5odG1sfX08L2Rpdj4nLAogICAgICAgICJmaWVsZFNldCI6ICd7e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0T3V0ZXJFbCIsdHJ1ZSl9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmaWVsZFNldExlZ2VuZCIpfX17e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0SXRlbXNDb250YWluZXIiLHRydWUpfX17ey93cmFwfX17ey93cmFwfX0nLAogICAgICAgICJjb250cm9sRmllbGRDb250YWluZXIiOiAnPGRpdj57e2h0bWwgdGhpcy5odG1sfX08L2Rpdj4nCiAgICB9KTsKCiAgICB2YXIgZWRpdFRlbXBsYXRlcyA9IEFscGFjYS5DcmVhdGUoQWxwYWNhLkVtcHR5Vmlld1RlbXBsYXRlcywgewogICAgICAgIC8vIFRlbXBsYXRlcyBmb3IgY29udHJvbCBmaWVsZHMKICAgICAgICAiY29udHJvbEZpZWxkT3V0ZXJFbCI6ICc8c3Bhbj57e2h0bWwgdGhpcy5odG1sfX08L3NwYW4+JywKICAgICAgICAiY29udHJvbEZpZWxkTWVzc2FnZSI6ICc8ZGl2PjxzcGFuIGNsYXNzPSJ1aS1pY29uIHVpLWljb24tYWxlcnQiPjwvc3Bhbj48c3BhbiBjbGFzcz0iYWxwYWNhLWNvbnRyb2xmaWVsZC1tZXNzYWdlLXRleHQiPiR7bWVzc2FnZX08L3NwYW4+PC9kaXY+JywKICAgICAgICAiY29udHJvbEZpZWxkTGFiZWwiOiAne3tpZiBvcHRpb25zLmxhYmVsfX08ZGl2IGNsYXNzPSJ7e2lmIG9wdGlvbnMubGFiZWxDbGFzc319JHtvcHRpb25zLmxhYmVsQ2xhc3N9e3svaWZ9fSI+PGRpdj4ke29wdGlvbnMubGFiZWx9PC9kaXY+PC9kaXY+e3svaWZ9fScsCiAgICAgICAgImNvbnRyb2xGaWVsZEhlbHBlciI6ICd7e2lmIG9wdGlvbnMuaGVscGVyfX08ZGl2IGNsYXNzPSJ7e2lmIG9wdGlvbnMuaGVscGVyQ2xhc3N9fSR7b3B0aW9ucy5oZWxwZXJDbGFzc317ey9pZn19Ij48c3BhbiBjbGFzcz0idWktaWNvbiB1aS1pY29uLWluZm8iPjwvc3Bhbj48c3BhbiBjbGFzcz0iYWxwYWNhLWNvbnRyb2xmaWVsZC1oZWxwZXItdGV4dCI+JHtvcHRpb25zLmhlbHBlcn08L3NwYW4+PC9kaXY+e3svaWZ9fScsCiAgICAgICAgImNvbnRyb2xGaWVsZENvbnRhaW5lciI6ICc8ZGl2Pnt7aHRtbCB0aGlzLmh0bWx9fTwvZGl2PicsCiAgICAgICAgImNvbnRyb2xGaWVsZCI6ICd7e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImNvbnRyb2xGaWVsZE91dGVyRWwiLHRydWUpfX17e2h0bWwgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiY29udHJvbEZpZWxkTGFiZWwiKX19e3t3cmFwKG51bGwsIHt9KSBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJjb250cm9sRmllbGRDb250YWluZXIiLHRydWUpfX17e2h0bWwgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiY29udHJvbEZpZWxkSGVscGVyIil9fXt7L3dyYXB9fXt7L3dyYXB9fScsCiAgICAgICAgLy8gVGVtcGxhdGVzIGZvciBjb250YWluZXIgZmllbGRzCiAgICAgICAgImZpZWxkU2V0T3V0ZXJFbCI6ICc8ZmllbGRzZXQ+e3todG1sIHRoaXMuaHRtbH19PC9maWVsZHNldD4nLAogICAgICAgICJmaWVsZFNldE1lc3NhZ2UiOiAnPGRpdj48c3BhbiBjbGFzcz0idWktaWNvbiB1aS1pY29uLWFsZXJ0IiBzdHlsZT0iZmxvYXQ6IGxlZnQ7IG1hcmdpbi1yaWdodDogLjNlbTsiPjwvc3Bhbj48c3Bhbj4ke21lc3NhZ2V9PC9zcGFuPjwvZGl2PicsCiAgICAgICAgImZpZWxkU2V0TGVnZW5kIjogJ3t7aWYgb3B0aW9ucy5sYWJlbH19PGxlZ2VuZCBjbGFzcz0ie3tpZiBvcHRpb25zLmxhYmVsQ2xhc3N9fSR7b3B0aW9ucy5sYWJlbENsYXNzfXt7L2lmfX0iPiR7b3B0aW9ucy5sYWJlbH08L2xlZ2VuZD57ey9pZn19JywKICAgICAgICAiZmllbGRTZXRIZWxwZXIiOiAne3tpZiBvcHRpb25zLmhlbHBlcn19PGRpdiBjbGFzcz0ie3tpZiBvcHRpb25zLmhlbHBlckNsYXNzfX0ke29wdGlvbnMuaGVscGVyQ2xhc3N9e3svaWZ9fSI+JHtvcHRpb25zLmhlbHBlcn08L2Rpdj57ey9pZn19JywKICAgICAgICAiZmllbGRTZXRJdGVtc0NvbnRhaW5lciI6ICc8ZGl2Pnt7aHRtbCB0aGlzLmh0bWx9fTwvZGl2PicsCiAgICAgICAgImZpZWxkU2V0IjogJ3t7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiZmllbGRTZXRPdXRlckVsIix0cnVlKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0TGVnZW5kIil9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmaWVsZFNldEhlbHBlciIpfX17e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0SXRlbXNDb250YWluZXIiLHRydWUpfX17ey93cmFwfX17ey93cmFwfX0nLAogICAgICAgICJmaWVsZFNldEl0ZW1Db250YWluZXIiOiAnPGRpdj48L2Rpdj4nLAogICAgICAgIC8vIFRlbXBsYXRlcyBmb3IgZm9ybQogICAgICAgICJmb3JtRmllbGRzQ29udGFpbmVyIjogJzxkaXY+e3todG1sIHRoaXMuaHRtbH19PC9kaXY+JywKICAgICAgICAiZm9ybUJ1dHRvbnNDb250YWluZXIiOiAnPGRpdj57e2lmIG9wdGlvbnMuYnV0dG9uc319e3tlYWNoKGssdikgb3B0aW9ucy5idXR0b25zfX08YnV0dG9uIGRhdGEta2V5PSIke2t9IiBjbGFzcz0iYWxwYWNhLWZvcm0tYnV0dG9uIGFscGFjYS1mb3JtLWJ1dHRvbi0ke2t9IiB7e2VhY2goazEsdjEpIHZ9fSR7azF9PSIke3YxfSJ7ey9lYWNofX0+JHt2LnZhbHVlfTwvYnV0dG9uPnt7L2VhY2h9fXt7L2lmfX08L2Rpdj4nLAogICAgICAgICJmb3JtIjogJzxmb3JtPnt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmb3JtRmllbGRzQ29udGFpbmVyIil9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmb3JtQnV0dG9uc0NvbnRhaW5lciIpfX08L2Zvcm0+JywKICAgICAgICAvLyBUZW1wbGF0ZXMgZm9yIHdpemFyZAogICAgICAgICJ3aXphcmRTdGVwIiA6ICc8ZGl2IGNsYXNzPSJhbHBhY2EtY2xlYXIiPjwvZGl2PicsCiAgICAgICAgIndpemFyZE5hdkJhciIgOiAnPGRpdj48L2Rpdj4nLAogICAgICAgICJ3aXphcmRQcmVCdXR0b24iIDogJzxidXR0b24+QmFjazwvYnV0dG9uPicsCiAgICAgICAgIndpemFyZE5leHRCdXR0b24iIDogJzxidXR0b24+TmV4dDwvYnV0dG9uPicsCiAgICAgICAgIndpemFyZERvbmVCdXR0b24iIDogJzxidXR0b24+RG9uZTwvYnV0dG9uPicsCiAgICAgICAgIndpemFyZFN0YXR1c0JhciIgOiAnPG9sIGlkPSIke2lkfSI+e3tlYWNoKGksdikgdGl0bGVzfX08bGkgaWQ9InN0ZXBEZXNjJHtpfSI+PGRpdj48c3Ryb25nPjxzcGFuPiR7di50aXRsZX08L3NwYW4+JHt2LmRlc2NyaXB0aW9ufTwvc3Ryb25nPjwvZGl2PjwvbGk+e3svZWFjaH19PC9vbD4nCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJWaWV3KHsKICAgICAgICAiaWQiOiAiVklFV19XRUJfRElTUExBWSIsCiAgICAgICAgInBhcmVudCI6ICJWSUVXX0JBU0UiLAogICAgICAgICJ0aXRsZSI6ICJEZWZhdWx0IFdlYiBEaXNwbGF5IFZpZXciLAogICAgICAgICJkZXNjcmlwdGlvbiI6IkRlZmF1bHQgd2ViIGVkaXQgdmlldyB3aGljaCBnb2VzIHRob3VnaCBmaWVsZCBoaWVyYXJjaHkuIiwKICAgICAgICAidHlwZSI6ICJ2aWV3IiwKICAgICAgICAicGxhdGZvcm0iOiJ3ZWIiLAogICAgICAgICJkaXNwbGF5UmVhZG9ubHkiOnRydWUsCiAgICAgICAgInRlbXBsYXRlcyI6IGRpc3BsYXlUZW1wbGF0ZXMKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3RlclZpZXcoewogICAgICAgICJpZCI6IlZJRVdfV0VCX0VESVQiLAogICAgICAgICJwYXJlbnQiOiAiVklFV19CQVNFIiwKICAgICAgICAidGl0bGUiOiJEZWZhdWx0IFdlYiBFZGl0IFZpZXciLAogICAgICAgICJkZXNjcmlwdGlvbiI6IkRlZmF1bHQgd2ViIGVkaXQgdmlldyB3aGljaCBnb2VzIHRob3VnaCBmaWVsZCBoaWVyYXJjaHkuIiwKICAgICAgICAidHlwZSI6ImVkaXQiLAogICAgICAgICJwbGF0Zm9ybSI6ICJ3ZWIiLAogICAgICAgICJkaXNwbGF5UmVhZG9ubHkiOnRydWUsCiAgICAgICAgInRlbXBsYXRlcyI6IGVkaXRUZW1wbGF0ZXMKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3RlclZpZXcoewogICAgICAgICJpZCI6ICJWSUVXX1dFQl9DUkVBVEUiLAogICAgICAgICJwYXJlbnQiOiAnVklFV19XRUJfRURJVCcsCiAgICAgICAgInRpdGxlIjogIkRlZmF1bHQgV2ViIENyZWF0ZSBWaWV3IiwKICAgICAgICAiZGVzY3JpcHRpb24iOiJEZWZhdWx0IHdlYiBjcmVhdGUgdmlldyB3aGljaCBkb2Vzbid0IGJpbmQgaW5pdGlhbCBkYXRhLiIsCiAgICAgICAgInR5cGUiOiAiY3JlYXRlIiwKICAgICAgICAiZGlzcGxheVJlYWRvbmx5IjpmYWxzZQogICAgfSk7Cgp9KShqUXVlcnkpOyhmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIHZhciBkaXNwbGF5VGVtcGxhdGVzID0gQWxwYWNhLkNyZWF0ZShBbHBhY2EuRW1wdHlWaWV3VGVtcGxhdGVzLCB7CgogICAgICAgIC8vIFRlbXBsYXRlcyBmb3IgY29udHJvbCBmaWVsZHMKICAgICAgICAiY29udHJvbEZpZWxkT3V0ZXJFbCI6ICc8c3BhbiBjbGFzcz0iYWxwYWNhLXZpZXctd2ViLWxpc3QiPnt7aHRtbCB0aGlzLmh0bWx9fTwvc3Bhbj4nLAogICAgICAgICJjb250cm9sRmllbGRNZXNzYWdlIjogJzxkaXY+PHNwYW4gY2xhc3M9InVpLWljb24gdWktaWNvbi1hbGVydCI+PC9zcGFuPjxzcGFuIGNsYXNzPSJhbHBhY2EtY29udHJvbGZpZWxkLW1lc3NhZ2UtdGV4dCI+JHttZXNzYWdlfTwvc3Bhbj48L2Rpdj4nLAogICAgICAgICJjb250cm9sRmllbGRMYWJlbCI6ICd7e2lmIG9wdGlvbnMubGFiZWx9fTxsYWJlbCBmb3I9IiR7aWR9IiBjbGFzcz0ie3tpZiBvcHRpb25zLmxhYmVsQ2xhc3N9fSR7b3B0aW9ucy5sYWJlbENsYXNzfXt7L2lmfX0iPiR7b3B0aW9ucy5sYWJlbH08L2xhYmVsPnt7L2lmfX0nLAogICAgICAgICJjb250cm9sRmllbGRIZWxwZXIiOiAne3tpZiBvcHRpb25zLmhlbHBlcn19PGRpdiBjbGFzcz0ie3tpZiBvcHRpb25zLmhlbHBlckNsYXNzfX0ke29wdGlvbnMuaGVscGVyQ2xhc3N9e3svaWZ9fSI+PHNwYW4gY2xhc3M9InVpLWljb24gdWktaWNvbi1pbmZvIj48L3NwYW4+PHNwYW4gY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtaGVscGVyLXRleHQiPiR7b3B0aW9ucy5oZWxwZXJ9PC9zcGFuPjwvZGl2Pnt7L2lmfX0nLAogICAgICAgICJjb250cm9sRmllbGRDb250YWluZXIiOiAnPGRpdj57e2h0bWwgdGhpcy5odG1sfX08L2Rpdj4nLAogICAgICAgICJjb250cm9sRmllbGQiOiAne3t3cmFwKG51bGwsIHt9KSBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJjb250cm9sRmllbGRPdXRlckVsIix0cnVlKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImNvbnRyb2xGaWVsZExhYmVsIil9fXt7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiY29udHJvbEZpZWxkQ29udGFpbmVyIix0cnVlKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImNvbnRyb2xGaWVsZEhlbHBlciIpfX17ey93cmFwfX17ey93cmFwfX0nLAogICAgICAgIC8vIFRlbXBsYXRlcyBmb3IgY29udGFpbmVyIGZpZWxkcwogICAgICAgICJmaWVsZFNldE91dGVyRWwiOiAnPGZpZWxkc2V0IGNsYXNzPSJhbHBhY2Etdmlldy13ZWItbGlzdCI+e3todG1sIHRoaXMuaHRtbH19PC9maWVsZHNldD4nLAogICAgICAgICJmaWVsZFNldE1lc3NhZ2UiOiAnPGRpdj48c3BhbiBjbGFzcz0idWktaWNvbiB1aS1pY29uLWFsZXJ0IGFscGFjYS1maWVsZHNldC1tZXNzYWdlLWxpc3QtdmlldyI+PC9zcGFuPjxzcGFuPiR7bWVzc2FnZX08L3NwYW4+PC9kaXY+JywKICAgICAgICAiZmllbGRTZXRMZWdlbmQiOiAne3tpZiBvcHRpb25zLmxhYmVsfX08bGVnZW5kIGNsYXNzPSJ7e2lmIG9wdGlvbnMubGFiZWxDbGFzc319JHtvcHRpb25zLmxhYmVsQ2xhc3N9e3svaWZ9fSI+JHtvcHRpb25zLmxhYmVsfTwvbGVnZW5kPnt7L2lmfX0nLAogICAgICAgICJmaWVsZFNldEhlbHBlciI6ICd7e2lmIG9wdGlvbnMuaGVscGVyfX08ZGl2IGNsYXNzPSJ7e2lmIG9wdGlvbnMuaGVscGVyQ2xhc3N9fSR7b3B0aW9ucy5oZWxwZXJDbGFzc317ey9pZn19Ij4ke29wdGlvbnMuaGVscGVyfTwvZGl2Pnt7L2lmfX0nLAogICAgICAgICJmaWVsZFNldEl0ZW1zQ29udGFpbmVyIjogJzxvbD57e2h0bWwgdGhpcy5odG1sfX08L29sPicsCiAgICAgICAgImZpZWxkU2V0IjogJ3t7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiZmllbGRTZXRPdXRlckVsIix0cnVlKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0TGVnZW5kIil9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmaWVsZFNldEhlbHBlciIpfX17e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0SXRlbXNDb250YWluZXIiLHRydWUpfX17ey93cmFwfX17ey93cmFwfX0nLAogICAgICAgICJmaWVsZFNldEl0ZW1Db250YWluZXIiOiAnPGxpIHN0eWxlPSJsaXN0LXN0eWxlOm5vbmU7Ij48L2xpPicsCgogICAgICAgICJpdGVtTGFiZWwiIDogJ3t7aWYgb3B0aW9ucy5pdGVtTGFiZWx9fTxsYWJlbCBmb3I9IiR7aWR9IiBjbGFzcz0iYWxwYWNhLWNvbnRyb2xmaWVsZC1sYWJlbCBhbHBhY2EtY29udHJvbGZpZWxkLWxhYmVsLWxpc3QtdmlldyI+PHNwYW4gY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtaXRlbS1sYWJlbC1saXN0LXZpZXciPiR7b3B0aW9ucy5pdGVtTGFiZWx9e3tpZiBpbmRleH19IDxzcGFuIGNsYXNzPSJhbHBhY2EtaXRlbS1sYWJlbC1jb3VudGVyIj4ke2luZGV4fTwvc3Bhbj48L3NwYW4+e3svaWZ9fTwvbGFiZWw+e3svaWZ9fScKICAgIH0pOwoKICAgIHZhciBlZGl0VGVtcGxhdGVzID0gQWxwYWNhLkNyZWF0ZShBbHBhY2EuRW1wdHlWaWV3VGVtcGxhdGVzLCB7CgogICAgICAgIC8vIFRlbXBsYXRlcyBmb3IgY29udHJvbCBmaWVsZHMKICAgICAgICAiY29udHJvbEZpZWxkT3V0ZXJFbCI6ICc8c3BhbiBjbGFzcz0iYWxwYWNhLXZpZXctd2ViLWxpc3QiPnt7aHRtbCB0aGlzLmh0bWx9fTwvc3Bhbj4nLAogICAgICAgICJjb250cm9sRmllbGRNZXNzYWdlIjogJzxkaXY+PHNwYW4gY2xhc3M9InVpLWljb24gdWktaWNvbi1hbGVydCI+PC9zcGFuPjxzcGFuIGNsYXNzPSJhbHBhY2EtY29udHJvbGZpZWxkLW1lc3NhZ2UtdGV4dCI+JHttZXNzYWdlfTwvc3Bhbj48L2Rpdj4nLAogICAgICAgICJjb250cm9sRmllbGRMYWJlbCI6ICd7e2lmIG9wdGlvbnMubGFiZWx9fTxsYWJlbCBmb3I9IiR7aWR9IiBjbGFzcz0ie3tpZiBvcHRpb25zLmxhYmVsQ2xhc3N9fSR7b3B0aW9ucy5sYWJlbENsYXNzfXt7L2lmfX0iPiR7b3B0aW9ucy5sYWJlbH08L2xhYmVsPnt7L2lmfX0nLAogICAgICAgICJjb250cm9sRmllbGRIZWxwZXIiOiAne3tpZiBvcHRpb25zLmhlbHBlcn19PGRpdiBjbGFzcz0ie3tpZiBvcHRpb25zLmhlbHBlckNsYXNzfX0ke29wdGlvbnMuaGVscGVyQ2xhc3N9e3svaWZ9fSI+PHNwYW4gY2xhc3M9InVpLWljb24gdWktaWNvbi1pbmZvIj48L3NwYW4+PHNwYW4gY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtaGVscGVyLXRleHQiPiR7b3B0aW9ucy5oZWxwZXJ9PC9zcGFuPjwvZGl2Pnt7L2lmfX0nLAogICAgICAgICJjb250cm9sRmllbGRDb250YWluZXIiOiAnPGRpdj57e2h0bWwgdGhpcy5odG1sfX08L2Rpdj4nLAogICAgICAgICJjb250cm9sRmllbGQiOiAne3t3cmFwKG51bGwsIHt9KSBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJjb250cm9sRmllbGRPdXRlckVsIix0cnVlKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImNvbnRyb2xGaWVsZExhYmVsIil9fXt7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiY29udHJvbEZpZWxkQ29udGFpbmVyIix0cnVlKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImNvbnRyb2xGaWVsZEhlbHBlciIpfX17ey93cmFwfX17ey93cmFwfX0nLAogICAgICAgIC8vIFRlbXBsYXRlcyBmb3IgY29udGFpbmVyIGZpZWxkcwogICAgICAgICJmaWVsZFNldE91dGVyRWwiOiAnPGZpZWxkc2V0IGNsYXNzPSJhbHBhY2Etdmlldy13ZWItbGlzdCI+e3todG1sIHRoaXMuaHRtbH19PC9maWVsZHNldD4nLAogICAgICAgICJmaWVsZFNldE1lc3NhZ2UiOiAnPGRpdj48c3BhbiBjbGFzcz0idWktaWNvbiB1aS1pY29uLWFsZXJ0IGFscGFjYS1maWVsZHNldC1tZXNzYWdlLWxpc3QtdmlldyI+PC9zcGFuPjxzcGFuPiR7bWVzc2FnZX08L3NwYW4+PC9kaXY+JywKICAgICAgICAiZmllbGRTZXRMZWdlbmQiOiAne3tpZiBvcHRpb25zLmxhYmVsfX08bGVnZW5kIGNsYXNzPSJ7e2lmIG9wdGlvbnMubGFiZWxDbGFzc319JHtvcHRpb25zLmxhYmVsQ2xhc3N9e3svaWZ9fSI+JHtvcHRpb25zLmxhYmVsfTwvbGVnZW5kPnt7L2lmfX0nLAogICAgICAgICJmaWVsZFNldEhlbHBlciI6ICd7e2lmIG9wdGlvbnMuaGVscGVyfX08ZGl2IGNsYXNzPSJ7e2lmIG9wdGlvbnMuaGVscGVyQ2xhc3N9fSR7b3B0aW9ucy5oZWxwZXJDbGFzc317ey9pZn19Ij4ke29wdGlvbnMuaGVscGVyfTwvZGl2Pnt7L2lmfX0nLAogICAgICAgICJmaWVsZFNldEl0ZW1zQ29udGFpbmVyIjogJzxvbD57e2h0bWwgdGhpcy5odG1sfX08L29sPicsCiAgICAgICAgImZpZWxkU2V0IjogJ3t7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiZmllbGRTZXRPdXRlckVsIix0cnVlKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0TGVnZW5kIil9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmaWVsZFNldEhlbHBlciIpfX17e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0SXRlbXNDb250YWluZXIiLHRydWUpfX17ey93cmFwfX17ey93cmFwfX0nLAogICAgICAgICJmaWVsZFNldEl0ZW1Db250YWluZXIiOiAnPGxpIHN0eWxlPSJsaXN0LXN0eWxlOm5vbmU7Ij48L2xpPicsCgogICAgICAgICJpdGVtTGFiZWwiIDogJ3t7aWYgb3B0aW9ucy5pdGVtTGFiZWx9fTxsYWJlbCBmb3I9IiR7aWR9IiBjbGFzcz0iYWxwYWNhLWNvbnRyb2xmaWVsZC1sYWJlbCBhbHBhY2EtY29udHJvbGZpZWxkLWxhYmVsLWxpc3QtdmlldyI+PHNwYW4gY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtaXRlbS1sYWJlbC1saXN0LXZpZXciPiR7b3B0aW9ucy5pdGVtTGFiZWx9e3tpZiBpbmRleH19IDxzcGFuIGNsYXNzPSJhbHBhY2EtaXRlbS1sYWJlbC1jb3VudGVyIj4ke2luZGV4fTwvc3Bhbj48L3NwYW4+e3svaWZ9fTwvbGFiZWw+e3svaWZ9fScKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3RlclZpZXcoewogICAgICAgICJpZCI6ICJWSUVXX1dFQl9ESVNQTEFZX0xJU1QiLAogICAgICAgICJwYXJlbnQiOiAnVklFV19XRUJfRElTUExBWScsCiAgICAgICAgInRpdGxlIjogIldlYiBEaXNwbGF5IFZpZXcgTGlzdCBTdHlsZSIsCiAgICAgICAgImRlc2NyaXB0aW9uIjogIldlYiBkaXNwbGF5IHZpZXcgYmFzZWQgb24gbGlzdCBzdHlsZXMuIiwKICAgICAgICAibGVnZW5kU3R5bGUiOiAibGluayIsCiAgICAgICAgInRlbXBsYXRlcyI6IGRpc3BsYXlUZW1wbGF0ZXMsCiAgICAgICAgInN0eWxlcyI6IHsKICAgICAgICB9LAogICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICIvIjogewogICAgICAgICAgICAgICAgInRlbXBsYXRlcyI6IHsKICAgICAgICAgICAgICAgICAgICAvLyBUZW1wbGF0ZXMgZm9yIGNvbnRhaW5lciBmaWVsZHMKICAgICAgICAgICAgICAgICAgICAiZmllbGRTZXRJdGVtc0NvbnRhaW5lciI6ICc8b2wgY2xhc3M9ImFscGFjYS1maWVsZHNldC1pdGVtc2NvbnRhaW5lci1saXN0LXZpZXctdG9wIj57e2h0bWwgdGhpcy5odG1sfX08L29sPicsCiAgICAgICAgICAgICAgICAgICAgImZpZWxkU2V0SXRlbUNvbnRhaW5lciI6ICc8bGkgY2xhc3M9ImFscGFjYS1maWVsZHNldC1pdGVtY29udGFpbmVyLWxpc3Qtdmlldy10b3AiPjwvbGk+JwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyVmlldyh7CiAgICAgICAgImlkIjogIlZJRVdfV0VCX0VESVRfTElTVCIsCiAgICAgICAgInBhcmVudCI6ICdWSUVXX1dFQl9FRElUJywKICAgICAgICAidGl0bGUiOiAiV2ViIEVkaXQgVmlldyBMaXN0IFN0eWxlIiwKICAgICAgICAiZGVzY3JpcHRpb24iOiAiV2ViIGVkaXQgdmlldyBiYXNlZCBvbiBsaXN0IHN0eWxlcy4iLAogICAgICAgICJsZWdlbmRTdHlsZSI6ICJsaW5rIiwKICAgICAgICAidGVtcGxhdGVzIjogZWRpdFRlbXBsYXRlcywKICAgICAgICAic3R5bGVzIjogewogICAgICAgIH0sCiAgICAgICAgImZpZWxkcyI6IHsKICAgICAgICAgICAgIi8iOiB7CiAgICAgICAgICAgICAgICAidGVtcGxhdGVzIjogewogICAgICAgICAgICAgICAgICAgIC8vIFRlbXBsYXRlcyBmb3IgY29udGFpbmVyIGZpZWxkcwogICAgICAgICAgICAgICAgICAgICJmaWVsZFNldEl0ZW1zQ29udGFpbmVyIjogJzxvbCBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWl0ZW1zY29udGFpbmVyLWxpc3Qtdmlldy10b3AiPnt7aHRtbCB0aGlzLmh0bWx9fTwvb2w+JywKICAgICAgICAgICAgICAgICAgICAiZmllbGRTZXRJdGVtQ29udGFpbmVyIjogJzxsaSBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWl0ZW1jb250YWluZXItbGlzdC12aWV3LXRvcCI+PC9saT4nCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJWaWV3KHsKICAgICAgICAiaWQiOiAiVklFV19XRUJfQ1JFQVRFX0xJU1QiLAogICAgICAgICJwYXJlbnQiOiAnVklFV19XRUJfQ1JFQVRFJywKICAgICAgICAidGl0bGUiOiAiV2ViIENyZWF0ZSBWaWV3IExpc3QgU3R5bGUiLAogICAgICAgICJkZXNjcmlwdGlvbiI6ICJXZWIgY3JlYXRlIHZpZXcgYmFzZWQgb24gbGlzdCBzdHlsZXMuIiwKICAgICAgICAibGVnZW5kU3R5bGUiOiAibGluayIsCiAgICAgICAgInRlbXBsYXRlcyI6IGVkaXRUZW1wbGF0ZXMsCiAgICAgICAgInN0eWxlcyI6IHsKICAgICAgICB9LAogICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICIvIjogewogICAgICAgICAgICAgICAgInRlbXBsYXRlcyI6IHsKICAgICAgICAgICAgICAgICAgICAvLyBUZW1wbGF0ZXMgZm9yIGNvbnRhaW5lciBmaWVsZHMKICAgICAgICAgICAgICAgICAgICAiZmllbGRTZXRJdGVtc0NvbnRhaW5lciI6ICc8b2wgY2xhc3M9ImFscGFjYS1maWVsZHNldC1pdGVtc2NvbnRhaW5lci1saXN0LXZpZXctdG9wIj57e2h0bWwgdGhpcy5odG1sfX08L29sPicsCiAgICAgICAgICAgICAgICAgICAgImZpZWxkU2V0SXRlbUNvbnRhaW5lciI6ICc8bGkgY2xhc3M9ImFscGFjYS1maWVsZHNldC1pdGVtY29udGFpbmVyLWxpc3Qtdmlldy10b3AiPjwvbGk+JwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7Cgp9KShqUXVlcnkpOy8qKgogKiBqUXVlcnkgVUkgVGhlbWUgKCJqcXVlcnktdWkiKQogKgogKiBEZWZpbmVzIHRoZSBBbHBhY2EgdGhlbWUgZm9yIGpRdWVyeSBVSS4KICoKICogVGhlIHN0eWxlIGluamVjdG9yOgogKgogKiAgICBqcXVlcnktdWkKICoKICogVGhlIHZpZXdzIGFyZToKICoKICogICAgVklFV19KUVVFUllVSV9ESVNQTEFZCiAqICAgIFZJRVdfSlFVRVJZVUlfRURJVAogKiAgICBWSUVXX0pRVUVSWVVJX0NSRUFURQogKgogKiBUaGlzIHRoZW1lIGNhbiBiZSBzZWxlY3RlZCBieSBzcGVjaWZ5aW5nIHRoZSBmb2xsb3dpbmcgdmlldzoKICoKICogICAgewogKiAgICAgICAidWkiOiAianF1ZXJ5LXVpIiwKICogICAgICAgInR5cGUiOiBudWxsIHwgImNyZWF0ZSIgfCAiZWRpdCIgfCAiZGlzcGxheSIKICogICAgfQogKgogKi8KKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLnN0eWxlSW5qZWN0aW9uc1sianF1ZXJ5LXVpIl0gPSB7CiAgICAgICAgImZpZWxkIiA6IGZ1bmN0aW9uKHRhcmdldERpdikgewogICAgICAgICAgICB0YXJnZXREaXYuYWRkQ2xhc3MoJ3VpLXdpZGdldCcpOwogICAgICAgIH0sCiAgICAgICAgInJlcXVpcmVkIiA6IGZ1bmN0aW9uKHRhcmdldERpdikgewogICAgICAgICAgICAkKCc8c3BhbiBjbGFzcz0idWktaWNvbiB1aS1pY29uLXN0YXIiPjwvc3Bhbj4nKS5wcmVwZW5kVG8odGFyZ2V0RGl2KTsKICAgICAgICB9LAogICAgICAgICJlcnJvciIgOiBmdW5jdGlvbih0YXJnZXREaXYpIHsKICAgICAgICAgICAgdGFyZ2V0RGl2LmFkZENsYXNzKCd1aS1zdGF0ZS1lcnJvcicpOwogICAgICAgIH0sCiAgICAgICAgImVycm9yTWVzc2FnZSIgOiBmdW5jdGlvbih0YXJnZXREaXYpIHsKICAgICAgICAgICAgdGFyZ2V0RGl2LmFkZENsYXNzKCd1aS1zdGF0ZS1lcnJvci10ZXh0Jyk7CiAgICAgICAgfSwKICAgICAgICAicmVtb3ZlRXJyb3IiIDogZnVuY3Rpb24odGFyZ2V0RGl2KSB7CiAgICAgICAgICAgIHRhcmdldERpdi5yZW1vdmVDbGFzcygndWktc3RhdGUtZXJyb3InKTsKICAgICAgICB9LAogICAgICAgICJjb250YWluZXIiIDogZnVuY3Rpb24odGFyZ2V0RGl2KSB7CiAgICAgICAgICAgIHRhcmdldERpdi5hZGRDbGFzcygndWktd2lkZ2V0LWNvbnRlbnQnKTsKICAgICAgICB9LAogICAgICAgICJ3aXphcmRTdGF0dXNCYXIiIDogZnVuY3Rpb24odGFyZ2V0RGl2KSB7CiAgICAgICAgICAgIHRhcmdldERpdi5hZGRDbGFzcygndWktd2lkZ2V0LWhlYWRlciB1aS1jb3JuZXItYWxsJyk7CiAgICAgICAgfSwKICAgICAgICAid2l6YXJkQ3VycmVudFN0ZXAiIDogZnVuY3Rpb24odGFyZ2V0RGl2KSB7CiAgICAgICAgICAgIHRhcmdldERpdi5hZGRDbGFzcygndWktc3RhdGUtaGlnaGxpZ2h0IHVpLWNvcm5lci1hbGwnKTsKICAgICAgICB9LAogICAgICAgICJ3aXphcmRVbkN1cnJlbnRTdGVwIiA6IGZ1bmN0aW9uKHRhcmdldERpdikgewogICAgICAgICAgICB0YXJnZXREaXYucmVtb3ZlQ2xhc3MoJ3VpLXN0YXRlLWhpZ2hsaWdodCB1aS1jb3JuZXItYWxsJyk7CiAgICAgICAgfSwKICAgICAgICAiY29udGFpbmVyRXhwYW5kZWRJY29uIiA6ICJ1aS1pY29uLWNpcmNsZS1hcnJvdy1zIiwKICAgICAgICAiY29udGFpbmVyQ29sbGFwc2VkSWNvbiIgOiAidWktaWNvbi1jaXJjbGUtYXJyb3ctZSIsCiAgICAgICAgImNvbW1vbkljb24iIDogInVpLWljb24iLAogICAgICAgICJhZGRJY29uIiA6ICJ1aS1pY29uLWNpcmNsZS1wbHVzIiwKICAgICAgICAicmVtb3ZlSWNvbiIgOiAidWktaWNvbi1jaXJjbGUtbWludXMiLAogICAgICAgICJ1cEljb24iIDogInVpLWljb24tY2lyY2xlLWFycm93LW4iLAogICAgICAgICJkb3duSWNvbiIgOiAidWktaWNvbi1jaXJjbGUtYXJyb3ctcyIsCiAgICAgICAgIndpemFyZFByZUljb24iIDogInVpLWljb24tdHJpYW5nbGUtMS13IiwKICAgICAgICAid2l6YXJkTmV4dEljb24iIDogInVpLWljb24tdHJpYW5nbGUtMS1lIiwKICAgICAgICAid2l6YXJkRG9uZUljb24iIDogInVpLWljb24tdHJpYW5nbGUtMS1lIiwKICAgICAgICAiYnV0dG9uQmVhdXRpZmllciIgIDogZnVuY3Rpb24oYnV0dG9uLCBpY29uQ2xhc3MsIHdpdGhUZXh0KSB7CiAgICAgICAgICAgIGJ1dHRvbi5hZGRDbGFzcygidWktYnV0dG9uIHVpLXdpZGdldCB1aS1zdGF0ZS1kZWZhdWx0IHVpLWNvcm5lci1hbGwiKTsKICAgICAgICAgICAgaWYgKHdpdGhUZXh0KSB7CiAgICAgICAgICAgICAgICBidXR0b24uYWRkQ2xhc3MoInVpLWJ1dHRvbi10ZXh0LWljb24tcHJpbWFyeSIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYnV0dG9uLmFkZENsYXNzKCJ1aS1idXR0b24taWNvbi1vbmx5Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGJ1dHRvblRleHQgPSBidXR0b24uaHRtbCgpOwogICAgICAgICAgICBidXR0b24uYXR0cigidGl0bGUiLCBidXR0b25UZXh0KTsKICAgICAgICAgICAgYnV0dG9uLmVtcHR5KCkuYXBwZW5kKCc8c3BhbiBjbGFzcz0idWktYnV0dG9uLWljb24tcHJpbWFyeSB1aS1pY29uIGFscGFjYS1maWVsZHNldC1sZWdlbmQtYnV0dG9uICcgKyBpY29uQ2xhc3MgKyAnIj48L3NwYW4+PHNwYW4gY2xhc3M9InVpLWJ1dHRvbi10ZXh0Ij4nICsgYnV0dG9uVGV4dCArICc8L3NwYW4+Jyk7CiAgICAgICAgICAgIGJ1dHRvbi5ob3ZlcihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICghYnV0dG9uLmhhc0NsYXNzKCJhbHBhY2EtZmllbGRzZXQtYXJyYXktaXRlbS10b29sYmFyLWRpc2FibGVkIikpIHsKICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKCJ1aS1zdGF0ZS1ob3ZlciIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICghYnV0dG9uLmhhc0NsYXNzKCJhbHBhY2EtZmllbGRzZXQtYXJyYXktaXRlbS10b29sYmFyLWRpc2FibGVkIikpIHsKICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLnJlbW92ZUNsYXNzKCJ1aS1zdGF0ZS1ob3ZlciIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9OwoKICAgIEFscGFjYS5yZWdpc3RlclZpZXcoewogICAgICAgICJpZCI6ICJWSUVXX0pRVUVSWVVJX0RJU1BMQVkiLAogICAgICAgICJwYXJlbnQiOiAiVklFV19XRUJfRElTUExBWSIsCiAgICAgICAgInRpdGxlIjogIldlYiBEaXNwbGF5IFZpZXcgZm9yIGpRdWVyeSBVSSIsCiAgICAgICAgImRlc2NyaXB0aW9uIjogIldlYiBEaXNwbGF5IFZpZXcgZm9yIGpRdWVyeSBVSSIsCiAgICAgICAgInN0eWxlIjogImpxdWVyeS11aSIsCiAgICAgICAgInVpIjogImpxdWVyeS11aSIKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3RlclZpZXcoewogICAgICAgICJpZCI6ICJWSUVXX0pRVUVSWVVJX0VESVQiLAogICAgICAgICJwYXJlbnQiOiAiVklFV19XRUJfRURJVCIsCiAgICAgICAgInRpdGxlIjogIldlYiBFZGl0IFZpZXcgZm9yIGpRdWVyeSBVSSIsCiAgICAgICAgImRlc2NyaXB0aW9uIjoiV2ViIEVkaXQgVmlldyBmb3IgalF1ZXJ5IFVJIiwKICAgICAgICAic3R5bGUiOiAianF1ZXJ5LXVpIiwKICAgICAgICAidWkiOiAianF1ZXJ5LXVpIgogICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyVmlldyh7CiAgICAgICAgImlkIjogIlZJRVdfSlFVRVJZVUlfQ1JFQVRFIiwKICAgICAgICAicGFyZW50IjogJ1ZJRVdfV0VCX0NSRUFURScsCiAgICAgICAgInRpdGxlIjogIldlYiBDcmVhdGUgVmlldyBmb3IgalF1ZXJ5IFVJIiwKICAgICAgICAiZGVzY3JpcHRpb24iOiAiV2ViIENyZWF0ZSBWaWV3IGZvciBqUXVlcnkgVUkiLAogICAgICAgICJzdHlsZSI6ICJqcXVlcnktdWkiLAogICAgICAgICJ1aSI6ICJqcXVlcnktdWkiCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJWaWV3KHsKICAgICAgICAiaWQiOiAiVklFV19KUVVFUllVSV9FRElUX0xJU1QiLAogICAgICAgICJwYXJlbnQiOiAnVklFV19XRUJfRURJVF9MSVNUJywKICAgICAgICAidGl0bGUiOiAiSlF1ZXJ5IFVJIEVkaXQgVmlldyBMaXN0IFN0eWxlIiwKICAgICAgICAiZGVzY3JpcHRpb24iOiAiSlF1ZXJ5IFVJIGVkaXQgdmlldyBiYXNlZCBvbiBsaXN0IHN0eWxlcy4iLAogICAgICAgICJzdHlsZSI6ICJqcXVlcnktdWkiLAogICAgICAgICJ1aSI6ICJqcXVlcnktdWkiCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJWaWV3KHsKICAgICAgICAiaWQiOiAiVklFV19KUVVFUllVSV9DUkVBVEVfTElTVCIsCiAgICAgICAgInBhcmVudCI6ICdWSUVXX1dFQl9DUkVBVEVfTElTVCcsCiAgICAgICAgInRpdGxlIjogIkpRdWVyeSBVSSBDcmVhdGUgVmlldyBMaXN0IFN0eWxlIiwKICAgICAgICAiZGVzY3JpcHRpb24iOiAiSlF1ZXJ5IFVJIGNyZWF0ZSB2aWV3IGJhc2VkIG9uIGxpc3Qgc3R5bGVzLiIsCiAgICAgICAgInN0eWxlIjogImpxdWVyeS11aSIsCiAgICAgICAgInVpIjogImpxdWVyeS11aSIKICAgIH0pOwoKCn0pKGpRdWVyeSk7LyoqCiAqIGpRdWVyeSBNb2JpbGUgVGhlbWUgKCJtb2JpbGUiKQogKgogKiBEZWZpbmVzIHRoZSBBbHBhY2EgdGhlbWUgZm9yIGpRdWVyeSBNb2JpbGUuCiAqCiAqIFRoZSBzdHlsZSBpbmplY3RvcjoKICoKICogICAgbW9iaWxlCiAqCiAqIFRoZSB2aWV3cyBhcmU6CiAqCiAqICAgIFZJRVdfTU9CSUxFX0RJU1BMQVkKICogICAgVklFV19NT0JJTEVfRURJVAogKiAgICBWSUVXX01PQklMRV9DUkVBVEUKICoKICogVGhpcyB0aGVtZSBjYW4gYWxzbyBiZSBzZWxlY3RlZCBieSBzcGVjaWZ5aW5nIHRoZSBmb2xsb3dpbmcgdmlldzoKICoKICogICAgewogKiAgICAgICAidWkiOiAibW9iaWxlIiwKICogICAgICAgInR5cGUiOiBudWxsIHwgImNyZWF0ZSIgfCAiZWRpdCIgfCAiZGlzcGxheSIKICogICAgfQogKgogKi8oZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICB2YXIgZGlzcGxheVRlbXBsYXRlcyA9IEFscGFjYS5DcmVhdGUoQWxwYWNhLkVtcHR5Vmlld1RlbXBsYXRlcywgewoKICAgICAgICAvLyBUZW1wbGF0ZXMgZm9yIGNvbnRyb2wgZmllbGRzCiAgICAgICAgY29udHJvbEZpZWxkOiAnPHVsIGRhdGEtcm9sZT0ibGlzdHZpZXciPjxsaT57e2lmIG9wdGlvbnMubGFiZWx9fTxoND4ke29wdGlvbnMubGFiZWx9PC9oND57ey9pZn19PHA+PHN0cm9uZz4ke2RhdGF9PC9zdHJvbmc+PC9wPjwvbGk+PC91bD4nLAogICAgICAgIC8vIFRlbXBsYXRlcyBmb3IgY29udGFpbmVyIGZpZWxkcwogICAgICAgIGZpZWxkU2V0T3V0ZXJFbDogJzxmaWVsZHNldCBkYXRhLXJvbGU9ImNvbGxhcHNpYmxlIiBpZD0iJHtpZH0iIGRhdGEtY29sbGFwc2VkPSJ7e2lmIG9wdGlvbnMuY29sbGFwc2VkfX10cnVle3tlbHNlfX1mYWxzZXt7L2lmfX0iPnt7aHRtbCB0aGlzLmh0bWx9fTwvZmllbGRzZXQ+JywKICAgICAgICBmaWVsZFNldE1lc3NhZ2U6ICc8ZGl2PiogJHttZXNzYWdlfTwvZGl2PicsCiAgICAgICAgZmllbGRTZXRMZWdlbmQ6ICd7e2lmIG9wdGlvbnMubGFiZWx9fTxsZWdlbmQgZm9yPSIke2lkfSIgY2xhc3M9Int7aWYgb3B0aW9ucy5sYWJlbENsYXNzfX0ke29wdGlvbnMubGFiZWxDbGFzc317ey9pZn19Ij4ke29wdGlvbnMubGFiZWx9PC9sZWdlbmQ+e3svaWZ9fScsCiAgICAgICAgZmllbGRTZXRIZWxwZXI6ICd7e2lmIG9wdGlvbnMuaGVscGVyfX08aDMgY2xhc3M9Int7aWYgb3B0aW9ucy5oZWxwZXJDbGFzc319JHtvcHRpb25zLmhlbHBlckNsYXNzfXt7L2lmfX0iPiR7b3B0aW9ucy5oZWxwZXJ9PC9oMz57ey9pZn19JywKICAgICAgICBmaWVsZFNldEl0ZW1zQ29udGFpbmVyOiAnPGRpdiBkYXRhLXJvbGU9ImNvbnRyb2xncm91cCI+e3todG1sIHRoaXMuaHRtbH19PC9kaXY+JywKICAgICAgICBmaWVsZFNldDogJ3t7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiZmllbGRTZXRPdXRlckVsIix0cnVlKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0TGVnZW5kIil9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmaWVsZFNldEhlbHBlciIpfX17e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0SXRlbXNDb250YWluZXIiLHRydWUpfX17ey93cmFwfX17ey93cmFwfX0nLAogICAgICAgIGZpZWxkU2V0SXRlbUNvbnRhaW5lcjogJzxkaXY+PC9kaXY+JwogICAgfSk7CgogICAgdmFyIGVkaXRUZW1wbGF0ZXMgPSBBbHBhY2EuQ3JlYXRlKEFscGFjYS5FbXB0eVZpZXdUZW1wbGF0ZXMsIHsKCiAgICAgICAgLy8gVGVtcGxhdGVzIGZvciBjb250cm9sIGZpZWxkcwogICAgICAgIGNvbnRyb2xGaWVsZE91dGVyRWw6ICc8ZGl2IGRhdGEtcm9sZT0iZmllbGRjb250YWluIj57e2h0bWwgdGhpcy5odG1sfX08L2Rpdj4nLAogICAgICAgIGNvbnRyb2xGaWVsZE1lc3NhZ2U6ICc8ZGl2PiogJHttZXNzYWdlfTwvZGl2PicsCiAgICAgICAgY29udHJvbEZpZWxkTGFiZWw6ICd7e2lmIG9wdGlvbnMubGFiZWx9fTxsYWJlbCBmb3I9IiR7aWR9IiBjbGFzcz0ie3tpZiBvcHRpb25zLmxhYmVsQ2xhc3N9fSR7b3B0aW9ucy5sYWJlbENsYXNzfXt7L2lmfX0iPiR7b3B0aW9ucy5sYWJlbH08L2xhYmVsPnt7L2lmfX0nLAogICAgICAgIGNvbnRyb2xGaWVsZEhlbHBlcjogJ3t7aWYgb3B0aW9ucy5oZWxwZXJ9fTxkaXYgY2xhc3M9Int7aWYgb3B0aW9ucy5oZWxwZXJDbGFzc319JHtvcHRpb25zLmhlbHBlckNsYXNzfXt7L2lmfX0iPiR7b3B0aW9ucy5oZWxwZXJ9PC9kaXY+e3svaWZ9fScsCiAgICAgICAgY29udHJvbEZpZWxkQ29udGFpbmVyOiAnPGRpdiBkYXRhLXJlcGxhY2U9InRydWUiPnt7aHRtbCB0aGlzLmh0bWx9fTwvZGl2PicsCiAgICAgICAgY29udHJvbEZpZWxkOiAne3t3cmFwKG51bGwsIHt9KSBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJjb250cm9sRmllbGRPdXRlckVsIix0cnVlKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImNvbnRyb2xGaWVsZExhYmVsIil9fXt7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiY29udHJvbEZpZWxkQ29udGFpbmVyIix0cnVlKX19e3svd3JhcH19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImNvbnRyb2xGaWVsZEhlbHBlciIpfX17ey93cmFwfX0nLAogICAgICAgIC8vIFRlbXBsYXRlcyBmb3IgY29udGFpbmVyIGZpZWxkcwogICAgICAgIGZpZWxkU2V0T3V0ZXJFbDogJzxmaWVsZHNldCBpZD0iJHtpZH0iIGRhdGEtY29sbGFwc2VkPSJ7e2lmIG9wdGlvbnMuY29sbGFwc2VkfX10cnVle3tlbHNlfX1mYWxzZXt7L2lmfX0iPnt7aHRtbCB0aGlzLmh0bWx9fTwvZmllbGRzZXQ+JywKICAgICAgICBmaWVsZFNldE1lc3NhZ2U6ICc8ZGl2PiogJHttZXNzYWdlfTwvZGl2PicsCiAgICAgICAgZmllbGRTZXRMZWdlbmQ6ICd7e2lmIG9wdGlvbnMubGFiZWx9fTxsZWdlbmQgZm9yPSIke2lkfSIgY2xhc3M9Int7aWYgb3B0aW9ucy5sYWJlbENsYXNzfX0ke29wdGlvbnMubGFiZWxDbGFzc317ey9pZn19Ij4ke29wdGlvbnMubGFiZWx9PC9sZWdlbmQ+e3svaWZ9fScsCiAgICAgICAgZmllbGRTZXRIZWxwZXI6ICd7e2lmIG9wdGlvbnMuaGVscGVyfX08aDMgY2xhc3M9Int7aWYgb3B0aW9ucy5oZWxwZXJDbGFzc319JHtvcHRpb25zLmhlbHBlckNsYXNzfXt7L2lmfX0iPiR7b3B0aW9ucy5oZWxwZXJ9PC9oMz57ey9pZn19JywKICAgICAgICBmaWVsZFNldEl0ZW1zQ29udGFpbmVyOiAnPGRpdiBkYXRhLXJvbGU9ImNvbnRyb2xncm91cCI+e3todG1sIHRoaXMuaHRtbH19PC9kaXY+JywKICAgICAgICBmaWVsZFNldDogJ3t7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiZmllbGRTZXRPdXRlckVsIix0cnVlKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0TGVnZW5kIil9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmaWVsZFNldEhlbHBlciIpfX17e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0SXRlbXNDb250YWluZXIiLHRydWUpfX17ey93cmFwfX17ey93cmFwfX0nLAogICAgICAgIGZpZWxkU2V0SXRlbUNvbnRhaW5lcjogJzxkaXY+PC9kaXY+JywKICAgICAgICAvLyBUZW1wbGF0ZXMgZm9yIGZvcm0KICAgICAgICBmb3JtRmllbGRzQ29udGFpbmVyOiAnPGRpdiBkYXRhLXJvbGU9ImNvbnRlbnQiPnt7aHRtbCB0aGlzLmh0bWx9fTwvZGl2PicsCiAgICAgICAgLy9mb3JtQnV0dG9uc0NvbnRhaW5lcjogJzxmaWVsZHNldCBjbGFzcz0idWktZ3JpZC1hIj57e2h0bWwgdGhpcy5odG1sfX08L2ZpZWxkc2V0PicsCiAgICAgICAgLy8iZm9ybUJ1dHRvbnNDb250YWluZXIiOiAnPGRpdj57e2lmIG9wdGlvbnMuYnV0dG9uc319e3tlYWNoKGssdikgb3B0aW9ucy5idXR0b25zfX08aW5wdXQgZGF0YS1rZXk9IiR7a30iIGNsYXNzPSJhbHBhY2EtZm9ybS1idXR0b24gYWxwYWNhLWZvcm0tYnV0dG9uLSR7a30iIHt7ZWFjaChrMSx2MSkgdn19JHtrMX09IiR7djF9Int7L2VhY2h9fS8+e3svZWFjaH19e3svaWZ9fTwvZGl2PicsCiAgICAgICAgZm9ybTogJzxmb3JtPnt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmb3JtRmllbGRzQ29udGFpbmVyIil9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmb3JtQnV0dG9uc0NvbnRhaW5lciIpfX08L2Zvcm0+JywKICAgICAgICAvLyBDb250cm9scwogICAgICAgIC8vY29udHJvbEZpZWxkUmFkaW86ICc8ZmllbGRzZXQgZGF0YS1yb2xlPSJjb250cm9sZ3JvdXAiIGlkPSIke2lkfSI+e3tpZiBvcHRpb25zLmxhYmVsfX08bGVnZW5kIGZvcj0iJHtpZH0iIGNsYXNzPSJ7e2lmIG9wdGlvbnMubGFiZWxDbGFzc319JHtvcHRpb25zLmxhYmVsQ2xhc3N9e3svaWZ9fSI+JHtvcHRpb25zLmxhYmVsfTwvbGVnZW5kPnt7L2lmfX17e2VhY2ggc2VsZWN0T3B0aW9uc319PGlucHV0IHR5cGU9InJhZGlvIiB7e2lmIG9wdGlvbnMucmVhZG9ubHl9fXJlYWRvbmx5PSJyZWFkb25seSJ7ey9pZn19IG5hbWU9IiR7Zm9ybU5hbWV9IiBpZD0iJHtpZH0tJHskaW5kZXh9IiB2YWx1ZT0iJHt2YWx1ZX0iIHt7aWYgdmFsdWUgPT0gZGF0YX19Y2hlY2tlZD0iY2hlY2tlZCJ7ey9pZn19Lz48bGFiZWwgZm9yPSIke2lkfS0keyRpbmRleH0iPiR7dGV4dH08L2xhYmVsPnt7L2VhY2h9fTwvZmllbGRzZXQ+JywKICAgICAgICBjb250cm9sRmllbGRSYWRpbzogJzxmaWVsZHNldCBkYXRhLXJvbGU9ImNvbnRyb2xncm91cCIgY2xhc3M9ImFscGFjYS1yYWRpby1maWVsZHNldCIgaWQ9IiR7aWR9Ij57e2VhY2ggc2VsZWN0T3B0aW9uc319PGlucHV0IHR5cGU9InJhZGlvIiB7e2lmIG9wdGlvbnMucmVhZG9ubHl9fXJlYWRvbmx5PSJyZWFkb25seSJ7ey9pZn19IG5hbWU9IiR7bmFtZX0iIGlkPSIke2lkfS0keyRpbmRleH0iIHZhbHVlPSIke3ZhbHVlfSIge3tpZiB2YWx1ZSA9PSBkYXRhfX1jaGVja2VkPSJjaGVja2VkInt7L2lmfX0vPjxsYWJlbCBmb3I9IiR7aWR9LSR7JGluZGV4fSI+JHt0ZXh0fTwvbGFiZWw+e3svZWFjaH19PC9maWVsZHNldD4nLAogICAgICAgIGNvbnRyb2xGaWVsZENoZWNrYm94OiAnPGZpZWxkc2V0IGRhdGEtcm9sZT0iY29udHJvbGdyb3VwIiBjbGFzcz0iYWxwYWNhLXJhZGlvLWZpZWxkc2V0IiBpZD0iJHtpZH0tMCI+PGlucHV0IHR5cGU9ImNoZWNrYm94IiBpZD0iJHtpZH0tMSIgbmFtZT0iJHtpZH0tMSIge3tpZiBvcHRpb25zLnJlYWRvbmx5fX1yZWFkb25seT0icmVhZG9ubHkie3svaWZ9fSB7e2lmIG5hbWV9fW5hbWU9IiR7bmFtZX0ie3svaWZ9fSB7e2VhY2ggb3B0aW9ucy5kYXRhfX1kYXRhLSR7ZmllbGRJZH09IiR7dmFsdWV9Int7L2VhY2h9fS8+e3tpZiBvcHRpb25zLnJpZ2h0TGFiZWx9fTxsYWJlbCBmb3I9IiR7aWR9LTEiPiR7b3B0aW9ucy5yaWdodExhYmVsfTwvbGFiZWw+e3tlbHNlfX17e2lmIG9wdGlvbnMubGFiZWx9fTxsYWJlbCBmb3I9IiR7aWR9LTEiPiR7b3B0aW9ucy5sYWJlbH0/PC9sYWJlbD57ey9pZn19e3svaWZ9fTwvZmllbGRzZXQ+JywKICAgICAgICBhcnJheUl0ZW1Ub29sYmFyOiAnPGRpdiBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWFycmF5LWl0ZW0tdG9vbGJhciIgZGF0YS1yb2xlPSJjb250cm9sZ3JvdXAiIGRhdGEtdHlwZT0iaG9yaXpvbnRhbCIgZGF0YS1taW5pPSJ0cnVlIj48c3BhbiBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWFycmF5LWl0ZW0tdG9vbGJhci1hZGQiIGRhdGEtcm9sZT0iYnV0dG9uIiBkYXRhLWljb249ImFkZCIgZGF0YS1pY29ucG9zPSJub3RleHQiPkFkZDwvc3Bhbj48c3BhbiBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWFycmF5LWl0ZW0tdG9vbGJhci1yZW1vdmUiIGRhdGEtcm9sZT0iYnV0dG9uIiBkYXRhLWljb249ImRlbGV0ZSIgZGF0YS1pY29ucG9zPSJub3RleHQiPkRlbGV0ZTwvc3Bhbj48c3BhbiBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWFycmF5LWl0ZW0tdG9vbGJhci11cCIgZGF0YS1yb2xlPSJidXR0b24iIGRhdGEtaWNvbj0iYXJyb3ctdSIgZGF0YS1pY29ucG9zPSJub3RleHQiPlVwPC9zcGFuPjxzcGFuIGNsYXNzPSJhbHBhY2EtZmllbGRzZXQtYXJyYXktaXRlbS10b29sYmFyLWRvd24iIGRhdGEtcm9sZT0iYnV0dG9uIiBkYXRhLWljb249ImFycm93LWQiIGRhdGEtaWNvbnBvcz0ibm90ZXh0Ij5Eb3duPC9zcGFuPjwvZGl2PicsCiAgICAgICAgYXJyYXlUb29sYmFyOiAnPGRpdiBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWFycmF5LXRvb2xiYXIiIGRhdGEtcm9sZT0iY29udHJvbGdyb3VwIiAgZGF0YS1taW5pPSJ0cnVlIj48c3BhbiBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWFycmF5LXRvb2xiYXItaWNvbiBhbHBhY2EtZmllbGRzZXQtYXJyYXktdG9vbGJhci1hZGQiIGRhdGEtcm9sZT0iYnV0dG9uIiBkYXRhLWljb249ImFkZCIgZGF0YS1pbmxpbmU9InRydWUiIHRpdGxlPSJBZGQiPkFkZDwvc3Bhbj48L2Rpdj4nCiAgICB9KTsKCgogICAgQWxwYWNhLnN0eWxlSW5qZWN0aW9uc1sianF1ZXJ5LW1vYmlsZSJdID0gewogICAgICAgICJhcnJheSIgOiBmdW5jdGlvbihjb250YWluZXJFbGVtKSB7CiAgICAgICAgICAgIGlmIChjb250YWluZXJFbGVtKSB7CiAgICAgICAgICAgICAgICBpZiAoY29udGFpbmVyRWxlbS5maW5kKCdbZGF0YS1yb2xlPSJmaWVsZGNvbnRhaW4iXScpLmZpZWxkY29udGFpbikgewogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lckVsZW0uZmluZCgnW2RhdGEtcm9sZT0iZmllbGRjb250YWluIl0nKS5maWVsZGNvbnRhaW4oKTsKICAgICAgICAgICAgICAgICAgICBjb250YWluZXJFbGVtLmZpbmQoJ1tkYXRhLXJvbGU9ImZpZWxkY29udGFpbiJdJykuZmluZCgiW3R5cGU9J3JhZGlvJ10sIFt0eXBlPSdjaGVja2JveCddIikuY2hlY2tib3hyYWRpbygpOwogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lckVsZW0uZmluZCgnW2RhdGEtcm9sZT0iZmllbGRjb250YWluIl0nKS5maW5kKCJidXR0b24sIFtkYXRhLXJvbGU9J2J1dHRvbiddLCBbdHlwZT0nYnV0dG9uJ10sIFt0eXBlPSdzdWJtaXQnXSwgW3R5cGU9J3Jlc2V0J10sIFt0eXBlPSdpbWFnZSddIikubm90KCIudWktbm9qcyIpLmJ1dHRvbigpOwogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lckVsZW0uZmluZCgnW2RhdGEtcm9sZT0iZmllbGRjb250YWluIl0nKS5maW5kKCJpbnB1dCwgdGV4dGFyZWEiKS5ub3QoIlt0eXBlPSdyYWRpbyddLCBbdHlwZT0nY2hlY2tib3gnXSwgYnV0dG9uLCBbdHlwZT0nYnV0dG9uJ10sIFt0eXBlPSdzdWJtaXQnXSwgW3R5cGU9J3Jlc2V0J10sIFt0eXBlPSdpbWFnZSddIikudGV4dGlucHV0KCk7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyRWxlbS5maW5kKCdbZGF0YS1yb2xlPSJmaWVsZGNvbnRhaW4iXScpLmZpbmQoImlucHV0LCBzZWxlY3QiKS5maWx0ZXIoIltkYXRhLXJvbGU9J3NsaWRlciddLCBbZGF0YS10eXBlPSdyYW5nZSddIikuc2xpZGVyKCk7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyRWxlbS5maW5kKCdbZGF0YS1yb2xlPSJmaWVsZGNvbnRhaW4iXScpLmZpbmQoInNlbGVjdDpub3QoW2RhdGEtcm9sZT0nc2xpZGVyJ10pIikuc2VsZWN0bWVudSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lckVsZW0uZmluZCgnW2RhdGEtcm9sZT0iYnV0dG9uIl0nKS5idXR0b25NYXJrdXAoKTsKICAgICAgICAgICAgICAgICAgICBjb250YWluZXJFbGVtLmZpbmQoJ1tkYXRhLXJvbGU9ImNvbnRyb2xncm91cCJdJykuY29udHJvbGdyb3VwKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICBBbHBhY2EucmVnaXN0ZXJWaWV3KHsKICAgICAgICAiaWQiOiAiVklFV19NT0JJTEVfRElTUExBWSIsCiAgICAgICAgInBhcmVudCI6ICJWSUVXX1dFQl9ESVNQTEFZIiwKICAgICAgICAidGl0bGUiOiAiTW9iaWxlIERJU1BMQVkgVmlldyIsCiAgICAgICAgImRlc2NyaXB0aW9uIjogIk1vYmlsZSBkaXNwbGF5IHZpZXcgdXNpbmcgSlF1ZXJ5IE1vYmlsZSBMaWJyYXJ5IiwKICAgICAgICAidHlwZSI6ICJ2aWV3IiwKICAgICAgICAicGxhdGZvcm0iOiJtb2JpbGUiLAogICAgICAgICJzdHlsZSI6ImpxdWVyeS1tb2JpbGUiLAogICAgICAgICJ1aSI6Im1vYmlsZSIsCiAgICAgICAgImxlZ2VuZFN0eWxlIjogImxpbmsiLAogICAgICAgICJ0b29sYmFyU3R5bGUiOiAibGluayIsCiAgICAgICAgImJ1dHRvblR5cGUiOiAibGluayIsCiAgICAgICAgInRlbXBsYXRlcyI6IGRpc3BsYXlUZW1wbGF0ZXMsCiAgICAgICAgIm1lc3NhZ2VzIjogewogICAgICAgICAgICByZXF1aXJlZDogIlJlcXVpcmVkIEZpZWxkIiwKICAgICAgICAgICAgaW52YWxpZDogIkludmFsaWQgRmllbGQiCiAgICAgICAgfSwKICAgICAgICAicmVuZGVyIjogZnVuY3Rpb24oZmllbGQsIHJlbmRlcmVkQ2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIGZpZWxkLnJlbmRlcihmaWVsZC52aWV3LCBmdW5jdGlvbihmaWVsZCkgewoKICAgICAgICAgICAgICAgIHJlZnJlc2hQYWdlRm9yRmllbGQoZmllbGQuZ2V0RWwoKSk7CgogICAgICAgICAgICAgICAgaWYgKHJlbmRlcmVkQ2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICByZW5kZXJlZENhbGxiYWNrLmNhbGwoc2VsZiwgZmllbGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgfQogICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyVmlldyh7CiAgICAgICAgImlkIjogIlZJRVdfTU9CSUxFX0VESVQiLAogICAgICAgICJwYXJlbnQiOiAiVklFV19XRUJfRURJVCIsCiAgICAgICAgInRpdGxlIjogIk1vYmlsZSBFZGl0IFZpZXciLAogICAgICAgICJkZXNjcmlwdGlvbiI6ICJNb2JpbGUgZWRpdCB2aWV3IHVzaW5nIEpRdWVyeSBNb2JpbGUgTGlicmFyeSIsCiAgICAgICAgInR5cGUiOiAiZWRpdCIsCiAgICAgICAgInBsYXRmb3JtIjoibW9iaWxlIiwKICAgICAgICAic3R5bGUiOiJqcXVlcnktbW9iaWxlIiwKICAgICAgICAidWkiOiJtb2JpbGUiLAogICAgICAgICJsZWdlbmRTdHlsZSI6ICJsaW5rIiwKICAgICAgICAidG9vbGJhclN0eWxlIjogImxpbmsiLAogICAgICAgICJidXR0b25UeXBlIjogImxpbmsiLAogICAgICAgICJ0b29sYmFyU3RpY2t5IjogdHJ1ZSwKICAgICAgICAidGVtcGxhdGVzIjogZWRpdFRlbXBsYXRlcywKICAgICAgICAibWVzc2FnZXMiOiB7CiAgICAgICAgICAgIHJlcXVpcmVkOiAiUmVxdWlyZWQgRmllbGQiLAogICAgICAgICAgICBpbnZhbGlkOiAiSW52YWxpZCBGaWVsZCIKICAgICAgICB9LAogICAgICAgICJyZW5kZXIiOiBmdW5jdGlvbihmaWVsZCwgcmVuZGVyZWRDYWxsYmFjaykgewoKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgZmllbGQucmVuZGVyKGZ1bmN0aW9uKGZpZWxkKSB7CgogICAgICAgICAgICAgICAgcmVmcmVzaFBhZ2VGb3JGaWVsZChmaWVsZC5nZXRFbCgpKTsKCiAgICAgICAgICAgICAgICBpZiAocmVuZGVyZWRDYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgIHJlbmRlcmVkQ2FsbGJhY2suY2FsbChzZWxmLCBmaWVsZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICB9CiAgICB9KTsKCiAgICB2YXIgcmVmcmVzaFBhZ2VGb3JGaWVsZCA9IGZ1bmN0aW9uKGZpZWxkRWwpCiAgICB7CiAgICAgICAgLy8gZmluZCB0aGUgZGF0YS1yb2xlPSJwYWdlIiBhbmQgcmVmcmVzaCBpdAogICAgICAgIHZhciBlbCA9IGZpZWxkRWw7CiAgICAgICAgd2hpbGUgKCFBbHBhY2EuaXNFbXB0eShlbCkgJiYgZWwuYXR0cigiZGF0YS1yb2xlIikgIT09ICJwYWdlIikKICAgICAgICB7CiAgICAgICAgICAgIGVsID0gZWwucGFyZW50KCk7CiAgICAgICAgfQogICAgICAgIGlmICghQWxwYWNhLmlzRW1wdHkoZWwpKSB7CiAgICAgICAgICAgICQoZWwpLnRyaWdnZXIoJ3BhZ2VjcmVhdGUnKTsKICAgICAgICB9CiAgICB9OwoKICAgIEFscGFjYS5yZWdpc3RlclZpZXcoewogICAgICAgICJpZCI6ICJWSUVXX01PQklMRV9DUkVBVEUiLAogICAgICAgICJwYXJlbnQiOiAnVklFV19NT0JJTEVfRURJVCcsCiAgICAgICAgInRpdGxlIjogIkRlZmF1bHQgTW9iaWxlIENyZWF0ZSBWaWV3IiwKICAgICAgICAiZGVzY3JpcHRpb24iOiJEZWZhdWx0IG1vYmlsZSBjcmVhdGUgdmlldyB3aGljaCBkb2Vzbid0IGJpbmQgaW5pdGlhbCBkYXRhLiIsCiAgICAgICAgInR5cGUiOiAiY3JlYXRlIiwKICAgICAgICAiZGlzcGxheVJlYWRvbmx5IjpmYWxzZQogICAgfSk7Cgp9KShqUXVlcnkpOy8qKgogKiBUd2l0dGVyIEJvb3RzdHJhcCBUaGVtZSAoImJvb3RzdHJhcCIpCiAqCiAqIERlZmluZXMgdGhlIEFscGFjYSB0aGVtZSBmb3IgVHdpdHRlciBCb290c3RyYXAgdjMuCiAqCiAqIFRoZSBzdHlsZSBpbmplY3RvcjoKICoKICogICAgYm9vdHN0cmFwCiAqCiAqIFRoZSB2aWV3cyBhcmU6CiAqCiAqICAgIFZJRVdfQk9PVFNUUkFQX0RJU1BMQVkKICogICAgVklFV19CT09UU1RSQVBfRURJVAogKiAgICBWSUVXX0JPT1RTVFJBUF9DUkVBVEUKICoKICogVGhpcyB0aGVtZSBjYW4gYWxzbyBiZSBzZWxlY3RlZCBieSBzcGVjaWZ5aW5nIHRoZSBmb2xsb3dpbmcgdmlldzoKICoKICogICAgewogKiAgICAgICAidWkiOiAiYm9vdHN0cmFwIiwKICogICAgICAgInR5cGUiOiBudWxsIHwgImNyZWF0ZSIgfCAiZWRpdCIgfCAiZGlzcGxheSIKICogICAgfQogKgogKi8KKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgdmFyIGVkaXRUZW1wbGF0ZXMgPSBBbHBhY2EuQ3JlYXRlKEFscGFjYS5FbXB0eVZpZXdUZW1wbGF0ZXMsIHsKICAgICAgICAvLyBUZW1wbGF0ZXMgZm9yIGNvbnRyb2wgZmllbGRzCiAgICAgICAgImNvbnRyb2xGaWVsZE91dGVyRWwiOiAnPGRpdiBjbGFzcz0iZm9ybS1ncm91cCI+e3todG1sIHRoaXMuaHRtbH19PC9kaXY+JywKICAgICAgICAiY29udHJvbEZpZWxkTWVzc2FnZSI6ICc8c3BhbiBjbGFzcz0iZ2x5cGhpY29uIGdseXBoaWNvbi1leGNsYW1hdGlvbi1zaWduIj48L3NwYW4+PHNwYW4gY2xhc3M9ImhlbHAtYmxvY2sgYWxwYWNhLWNvbnRyb2xmaWVsZC1tZXNzYWdlLXRleHQiPiR7bWVzc2FnZX08L3NwYW4+JywKICAgICAgICAiY29udHJvbEZpZWxkTGFiZWwiOiAne3tpZiBvcHRpb25zLmxhYmVsfX08bGFiZWwgY2xhc3M9Int7aWYgb3B0aW9ucy5sYWJlbENsYXNzfX0ke29wdGlvbnMubGFiZWxDbGFzc317ey9pZn19IGNvbnRyb2wtbGFiZWwiIGZvcj0iJHtpZH0iPiR7b3B0aW9ucy5sYWJlbH08L2xhYmVsPnt7L2lmfX0nLAogICAgICAgICJjb250cm9sRmllbGRIZWxwZXIiOiAnPHAgY2xhc3M9Int7aWYgb3B0aW9ucy5oZWxwZXJDbGFzc319JHtvcHRpb25zLmhlbHBlckNsYXNzfXt7L2lmfX0iPnt7aWYgb3B0aW9ucy5oZWxwZXJ9fTxpIGNsYXNzPSJnbHlwaGljb24gZ2x5cGhpY29uLWluZm8tc2lnbiBhbHBhY2EtaGVscGVyLWljb24iPjwvaT4ke29wdGlvbnMuaGVscGVyfTwvcD57ey9pZn19JywKICAgICAgICAiY29udHJvbEZpZWxkQ29udGFpbmVyIjogJzxkaXY+e3todG1sIHRoaXMuaHRtbH19PC9kaXY+JywKICAgICAgICAiY29udHJvbEZpZWxkIjogJ3t7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiY29udHJvbEZpZWxkT3V0ZXJFbCIsdHJ1ZSl9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJjb250cm9sRmllbGRMYWJlbCIpfX17e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImNvbnRyb2xGaWVsZENvbnRhaW5lciIsdHJ1ZSl9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJjb250cm9sRmllbGRIZWxwZXIiKX19e3svd3JhcH19e3svd3JhcH19JywKICAgICAgICAvLyBUZW1wbGF0ZXMgZm9yIGNvbnRhaW5lciBmaWVsZHMKICAgICAgICAiZmllbGRTZXRPdXRlckVsIjogJzxmaWVsZHNldD57e2h0bWwgdGhpcy5odG1sfX08L2ZpZWxkc2V0PicsCiAgICAgICAgImZpZWxkU2V0TWVzc2FnZSI6ICc8c3BhbiBjbGFzcz0iZ2x5cGhpY29uIGdseXBoaWNvbi1leGNsYW1hdGlvbi1zaWduIj48L3NwYW4+PHNwYW4gY2xhc3M9ImhlbHAtYmxvY2sgYWxwYWNhLWNvbnRyb2xmaWVsZC1tZXNzYWdlLXRleHQiPiR7bWVzc2FnZX08L3NwYW4+JywKICAgICAgICAiZmllbGRTZXRMZWdlbmQiOiAne3tpZiBvcHRpb25zLmxhYmVsfX08bGVnZW5kIGNsYXNzPSJ7e2lmIG9wdGlvbnMubGFiZWxDbGFzc319JHtvcHRpb25zLmxhYmVsQ2xhc3N9e3svaWZ9fSI+JHtvcHRpb25zLmxhYmVsfTwvbGVnZW5kPnt7L2lmfX0nLAogICAgICAgICJmaWVsZFNldEhlbHBlciI6ICd7e2lmIG9wdGlvbnMuaGVscGVyfX08cCBjbGFzcz0ie3tpZiBvcHRpb25zLmhlbHBlckNsYXNzfX0ke29wdGlvbnMuaGVscGVyQ2xhc3N9e3svaWZ9fSI+PGkgY2xhc3M9ImdseXBoaWNvbiBnbHlwaGljb24taW5mby1zaWduIGFscGFjYS1oZWxwZXItaWNvbiI+PC9pPiR7b3B0aW9ucy5oZWxwZXJ9PC9wPnt7L2lmfX0nLAogICAgICAgICJmaWVsZFNldEl0ZW1zQ29udGFpbmVyIjogJzxkaXY+e3todG1sIHRoaXMuaHRtbH19PC9kaXY+JywKICAgICAgICAiZmllbGRTZXQiOiAne3t3cmFwKG51bGwsIHt9KSBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmaWVsZFNldE91dGVyRWwiLHRydWUpfX17e2h0bWwgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiZmllbGRTZXRMZWdlbmQiKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0SGVscGVyIil9fXt7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiZmllbGRTZXRJdGVtc0NvbnRhaW5lciIsdHJ1ZSl9fXt7L3dyYXB9fXt7L3dyYXB9fScsCiAgICAgICAgImZpZWxkU2V0SXRlbUNvbnRhaW5lciI6ICc8ZGl2PjwvZGl2PicsCiAgICAgICAgLy8gVGVtcGxhdGVzIGZvciBmb3JtCiAgICAgICAgImZvcm1GaWVsZHNDb250YWluZXIiOiAnPGRpdj57e2h0bWwgdGhpcy5odG1sfX08L2Rpdj4nLAogICAgICAgICJmb3JtQnV0dG9uc0NvbnRhaW5lciI6ICc8ZGl2Pnt7aWYgb3B0aW9ucy5idXR0b25zfX17e2VhY2goayx2KSBvcHRpb25zLmJ1dHRvbnN9fTxidXR0b24gZGF0YS1rZXk9IiR7a30iIGNsYXNzPSJhbHBhY2EtZm9ybS1idXR0b24gYWxwYWNhLWZvcm0tYnV0dG9uLSR7a30gYnRuIGJ0bi1kZWZhdWx0IiB7e2VhY2goazEsdjEpIHZ9fSR7azF9PSIke3YxfSJ7ey9lYWNofX0+JHt2LnZhbHVlfTwvYnV0dG9uPnt7L2VhY2h9fXt7L2lmfX08L2Rpdj4nLAogICAgICAgICJmb3JtIjogJzxmb3JtIHJvbGU9ImZvcm0iPnt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmb3JtRmllbGRzQ29udGFpbmVyIil9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmb3JtQnV0dG9uc0NvbnRhaW5lciIpfX08L2Zvcm0+JywKICAgICAgICAvLyBUZW1wbGF0ZXMgZm9yIHdpemFyZAogICAgICAgICJ3aXphcmRTdGVwIiA6ICc8ZGl2IGNsYXNzPSJhbHBhY2EtY2xlYXIiPjwvZGl2PicsCiAgICAgICAgIndpemFyZE5hdkJhciIgOiAnPGRpdj48L2Rpdj4nLAogICAgICAgICJ3aXphcmRQcmVCdXR0b24iIDogJzxidXR0b24+QmFjazwvYnV0dG9uPicsCiAgICAgICAgIndpemFyZE5leHRCdXR0b24iIDogJzxidXR0b24+TmV4dDwvYnV0dG9uPicsCiAgICAgICAgIndpemFyZERvbmVCdXR0b24iIDogJzxidXR0b24+RG9uZTwvYnV0dG9uPicsCiAgICAgICAgIndpemFyZFN0YXR1c0JhciIgOiAnPG9sIGlkPSIke2lkfSI+e3tlYWNoKGksdikgdGl0bGVzfX08bGkgaWQ9InN0ZXBEZXNjJHtpfSI+PGRpdj48c3Ryb25nPjxzcGFuPiR7di50aXRsZX08L3NwYW4+JHt2LmRlc2NyaXB0aW9ufTwvc3Ryb25nPjwvZGl2PjwvbGk+e3svZWFjaH19PC9vbD4nLAoKICAgICAgICAiY29udHJvbEZpZWxkQ2hlY2tib3giOiAnPGRpdiBjbGFzcz0iY2hlY2tib3giIGlkPSIke2lkfSI+e3tpZiBvcHRpb25zLnJpZ2h0TGFiZWx9fTxsYWJlbCBmb3I9IiR7aWR9X2NoZWNrYm94Ij57ey9pZn19PGlucHV0IGlkPSIke2lkfV9jaGVja2JveCIgdHlwZT0iY2hlY2tib3giIHt7aWYgb3B0aW9ucy5yZWFkb25seX19cmVhZG9ubHk9InJlYWRvbmx5Int7L2lmfX0ge3tpZiBuYW1lfX1uYW1lPSIke25hbWV9Int7L2lmfX0ge3tlYWNoKGksdikgb3B0aW9ucy5kYXRhfX1kYXRhLSR7aX09IiR7dn0ie3svZWFjaH19Lz57e2lmIG9wdGlvbnMucmlnaHRMYWJlbH19JHtvcHRpb25zLnJpZ2h0TGFiZWx9PC9sYWJlbD57ey9pZn19PC9kaXY+JywKICAgICAgICAiY29udHJvbEZpZWxkQ2hlY2tib3hNdWx0aXBsZSI6ICc8ZGl2IGlkPSIke2lkfSI+e3tlYWNoKGksbykgY2hlY2tib3hPcHRpb25zfX08ZGl2IGNsYXNzPSJjaGVja2JveCI+PGxhYmVsIGZvcj0iJHtpZH1fY2hlY2tib3hfJHtpfSI+PGlucHV0IHR5cGU9ImNoZWNrYm94IiBpZD0iJHtpZH1fY2hlY2tib3hfJHtpfSIge3tpZiBvcHRpb25zLnJlYWRvbmx5fX1yZWFkb25seT0icmVhZG9ubHkie3svaWZ9fSB7e2lmIG5hbWV9fW5hbWU9IiR7bmFtZX0ie3svaWZ9fSBkYXRhLWNoZWNrYm94LXZhbHVlPSIke28udmFsdWV9IiBkYXRhLWNoZWNrYm94LWluZGV4PSIke2l9Ii8+JHtvLnRleHR9PC9sYWJlbD48L2Rpdj57ey9lYWNofX08L2Rpdj4nLAoKICAgICAgICAiY29udHJvbEZpZWxkUmFkaW8iOiAne3tpZiAhcmVxdWlyZWQgJiYgIXJlbW92ZURlZmF1bHROb25lfX08ZGl2IGNsYXNzPSJyYWRpbyI+PGlucHV0IHR5cGU9InJhZGlvIiB7e2lmIG9wdGlvbnMucmVhZG9ubHl9fXJlYWRvbmx5PSJyZWFkb25seSJ7ey9pZn19IG5hbWU9IiR7bmFtZX0iIGlkPSIke2lkfV9yYWRpb19ub25ldmFsdWUiIHZhbHVlPSIiLz48bGFiZWwgZm9yPSIke2lkfV9yYWRpb19ub25ldmFsdWUiPk5vbmU8L2xhYmVsPjwvZGl2Pnt7L2lmfX17e2VhY2ggc2VsZWN0T3B0aW9uc319PGRpdiBjbGFzcz0icmFkaW8iPjxpbnB1dCB0eXBlPSJyYWRpbyIge3tpZiBvcHRpb25zLnJlYWRvbmx5fX1yZWFkb25seT0icmVhZG9ubHkie3svaWZ9fSBuYW1lPSIke25hbWV9IiB2YWx1ZT0iJHt2YWx1ZX0iIGlkPSIke2lkfV9yYWRpb18keyRpbmRleH0iIHt7aWYgdmFsdWUgPT0gZGF0YX19Y2hlY2tlZD0iY2hlY2tlZCJ7ey9pZn19Lz48bGFiZWwgZm9yPSIke2lkfV9yYWRpb18keyRpbmRleH0iPiR7dGV4dH08L2xhYmVsPjwvZGl2Pnt7L2VhY2h9fScsCgogICAgICAgICJpdGVtTGFiZWwiOiAne3tpZiBvcHRpb25zLml0ZW1MYWJlbH19PGRpdiBjbGFzcz0iYWxwYWNhLWNvbnRyb2xmaWVsZC1sYWJlbCI+PGRpdj4ke29wdGlvbnMuaXRlbUxhYmVsfXt7aWYgaW5kZXh9fSA8c3BhbiBjbGFzcz0iYWxwYWNhLWl0ZW0tbGFiZWwtY291bnRlciI+JHtpbmRleH08L3NwYW4+e3svaWZ9fTwvZGl2PjwvZGl2Pnt7L2lmfX0nLAogICAgICAgICJhcnJheVRvb2xiYXIiOiAnPGRpdiBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWFycmF5LXRvb2xiYXIgYnRuLWdyb3VwIj48YnV0dG9uIGNsYXNzPSJhbHBhY2EtZmllbGRzZXQtYXJyYXktdG9vbGJhci1pY29uIGFscGFjYS1maWVsZHNldC1hcnJheS10b29sYmFyLWFkZCBidG4gYnRuLWRlZmF1bHQiPiR7YWRkSXRlbUxhYmVsfTwvYnV0dG9uPjwvc3Bhbj4nLAogICAgICAgICJhcnJheUl0ZW1Ub29sYmFyIjogJzxkaXYgY2xhc3M9ImFscGFjYS1maWVsZHNldC1hcnJheS1pdGVtLXRvb2xiYXIgYnRuLWdyb3VwIGJ0bi1ncm91cC1zbSI+e3tlYWNoKGssdikgYnV0dG9uc319PGJ1dHRvbiBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWFycmF5LWl0ZW0tdG9vbGJhci1pY29uIGFscGFjYS1maWVsZHNldC1hcnJheS1pdGVtLXRvb2xiYXItJHt2LmZlYXR1cmV9IGJ0biBidG4tZGVmYXVsdCBidG4tc20iPiR7di5sYWJlbH08L2J1dHRvbj57ey9lYWNofX08L2Rpdj4nCgoKICAgIH0pOwoKICAgIHZhciBkaXNwbGF5VGVtcGxhdGVzID0gQWxwYWNhLkNyZWF0ZShlZGl0VGVtcGxhdGVzLCB7CiAgICAgICAgImZpZWxkU2V0T3V0ZXJFbCI6ICc8ZmllbGRzZXQgZGlzYWJsZWQ+e3todG1sIHRoaXMuaHRtbH19PC9maWVsZHNldD4nCiAgICB9KTsKCiAgICBBbHBhY2Euc3R5bGVJbmplY3Rpb25zWyJib290c3RyYXAiXSA9IHsKCiAgICAgICAgLyoKICAgICAgICAvLyBlcnJvciBtZXNzYWdlcwogICAgICAgICJhZGRFcnJvck1lc3NhZ2UiOiBmdW5jdGlvbih0YXJnZXREaXYsIG1lc3NhZ2UpIHsKCiAgICAgICAgICAgIC8vIGlmIGJvb3RzdHJhcCBoYXMgdGhlIHRvb2x0aXAsIHdlIGNhbiBwcmV0dHkgdXAgdGhlIG1lc3NhZ2UKICAgICAgICAgICAgaWYgKCQuZm4udG9vbHRpcCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFyZ2V0RGl2LnRvb2x0aXAoewogICAgICAgICAgICAgICAgICAgICJodG1sIjogbWVzc2FnZQogICAgICAgICAgICAgICAgfSkuY2xpY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgICJidXR0b25CZWF1dGlmaWVyIiAgOiBmdW5jdGlvbihidXR0b24sIGljb25DbGFzcywgd2l0aFRleHQpIHsKICAgICAgICAgICAgdmFyIGJ1dHRvblRleHQgPSBidXR0b24uaHRtbCgpOwogICAgICAgICAgICBidXR0b24uYXR0cigidGl0bGUiLCBidXR0b25UZXh0KTsKICAgICAgICAgICAgdmFyIGFkZGVkQnV0dG9uVGV4dCA9IHdpdGhUZXh0ID8gYnV0dG9uVGV4dCA6ICIiOwogICAgICAgICAgICBidXR0b24uZW1wdHkoKS5hcHBlbmQoJzxiIGNsYXNzPSJhbHBhY2EtZmllbGRzZXQtbGVnZW5kLWJ1dHRvbiAnICsgaWNvbkNsYXNzICsgJyI+PC9iPjxzcGFuPicgKyBhZGRlZEJ1dHRvblRleHQgKyAnPC9zcGFuPicpOwogICAgICAgIH0sCiAgICAgICAgKi8KCiAgICAgICAgImZpZWxkIiA6IGZ1bmN0aW9uKHRhcmdldERpdikgewoKICAgICAgICAgICAgLy8gdGhlIGl0ZW0gY29udGFpbmVyIGdldHMgdGhlICJmb3JtLWdyb3VwIgogICAgICAgICAgICAvL3RhcmdldERpdi5wYXJlbnQoKS5hZGRDbGFzcygnZm9ybS1ncm91cCcpOwoKICAgICAgICAgICAgLy8gYWxsIGNvbnRyb2xzIGdldCB0aGUgImZvcm0tY29udHJvbCIgY2xhc3MgaW5qZWN0ZWQKICAgICAgICAgICAgJCh0YXJnZXREaXYpLmZpbmQoImlucHV0IikuYWRkQ2xhc3MoImZvcm0tY29udHJvbCIpOwogICAgICAgICAgICAkKHRhcmdldERpdikuZmluZCgidGV4dGFyZWEiKS5hZGRDbGFzcygiZm9ybS1jb250cm9sIik7CiAgICAgICAgICAgICQodGFyZ2V0RGl2KS5maW5kKCJzZWxlY3QiKS5hZGRDbGFzcygiZm9ybS1jb250cm9sIik7CiAgICAgICAgICAgIC8vIGV4Y2VwdCBmb3IgdGhlIGZvbGxvd2luZwogICAgICAgICAgICAkKHRhcmdldERpdikuZmluZCgiaW5wdXRbdHlwZT1jaGVja2JveF0iKS5yZW1vdmVDbGFzcygiZm9ybS1jb250cm9sIik7CiAgICAgICAgICAgICQodGFyZ2V0RGl2KS5maW5kKCJpbnB1dFt0eXBlPWZpbGVdIikucmVtb3ZlQ2xhc3MoImZvcm0tY29udHJvbCIpOwogICAgICAgICAgICAkKHRhcmdldERpdikuZmluZCgiaW5wdXRbdHlwZT1yYWRpb10iKS5yZW1vdmVDbGFzcygiZm9ybS1jb250cm9sIik7CgogICAgICAgICAgICAvLyBhbnkgY2hlY2tib3ggaW5wdXRzIGdldCB0aGUgImNoZWNrYm94IiBjbGFzcyBvbiB0aGVpciBjb250YWluZXIKCiAgICAgICAgICAgIC8vIGFueSBjaGVja2JveCBpbnB1dHMgZ2V0IHRoZSAiY2hlY2tib3giIGNsYXNzIG9uIHRoZWlyIGNoZWNrYm94CiAgICAgICAgICAgIC8vIFRPRE86IHJlbW92ZSwgdGhpcyBpcyBub3cgZG9uZSBieSB0aGUgdGVtcGxhdGUgaXRzZWxmCiAgICAgICAgICAgIC8vJCh0YXJnZXREaXYpLmZpbmQoImlucHV0W3R5cGU9Y2hlY2tib3hdIikucGFyZW50KCkucGFyZW50KCkuYWRkQ2xhc3MoImNoZWNrYm94Iik7CiAgICAgICAgICAgIC8vIGFueSByYWRpbyBpbnB1dHMgZ2V0IHRoZSAicmFkaW8iIGNsYXNzIG9uIHRoZWlyIHJhZGlvCiAgICAgICAgICAgICQodGFyZ2V0RGl2KS5maW5kKCJpbnB1dFt0eXBlPXJhZGlvXSIpLnBhcmVudCgpLnBhcmVudCgpLmFkZENsYXNzKCJyYWRpbyIpOwoKICAgICAgICAgICAgLy8gaWYgZm9ybSBoYXMgImZvcm0taW5saW5lIiBjbGFzcywgdGhlbiByYWRpbyBhbmQgY2hlY2tib3ggbGFiZWxzIGdldCBpbmxpbmUgY2xhc3NlcwogICAgICAgICAgICBpZiAoJCh0YXJnZXREaXYpLnBhcmVudHMoImZvcm0iKS5oYXNDbGFzcygiZm9ybS1pbmxpbmUiKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gY2hlY2tib3hlcwogICAgICAgICAgICAgICAgJCh0YXJnZXREaXYpLmZpbmQoImlucHV0W3R5cGU9Y2hlY2tib3hdIikucGFyZW50KCkuYWRkQ2xhc3MoImNoZWNrYm94LWlubGluZSIpOwoKICAgICAgICAgICAgICAgIC8vIHJhZGlvcwogICAgICAgICAgICAgICAgJCh0YXJnZXREaXYpLmZpbmQoImlucHV0W3R5cGU9cmFkaW9dIikucGFyZW50KCkuYWRkQ2xhc3MoInJhZGlvLWlubGluZSIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUT0RPOiBmb3JtLWhvcml6b250YWw/CiAgICAgICAgfSwKCiAgICAgICAgLy8gaWNvbnMKICAgICAgICAiY29tbW9uSWNvbiIgOiAiIiwKICAgICAgICAiYWRkSWNvbiIgOiAiZ2x5cGhpY29uIGdseXBoaWNvbi1wbHVzLXNpZ24iLAogICAgICAgICJyZW1vdmVJY29uIiA6ICJnbHlwaGljb24gZ2x5cGhpY29uLW1pbnVzLXNpZ24iLAogICAgICAgICJ1cEljb24iIDogImdseXBoaWNvbiBnbHlwaGljb24tY2hldnJvbi11cCIsCiAgICAgICAgImRvd25JY29uIiA6ICJnbHlwaGljb24gZ2x5cGhpY29uLWNoZXZyb24tZG93biIsCiAgICAgICAgImNvbnRhaW5lckV4cGFuZGVkSWNvbiIgOiAiZ2x5cGhpY29uIGdseXBoaWNvbi1jaXJjbGUtYXJyb3ctZG93biIsCiAgICAgICAgImNvbnRhaW5lckNvbGxhcHNlZEljb24iIDogImdseXBoaWNvbiBnbHlwaGljb24tY2lyY2xlLWFycm93LXJpZ2h0IiwKICAgICAgICAid2l6YXJkUHJlSWNvbiIgOiAiZ2x5cGhpY29uIGdseXBoaWNvbi1jaGV2cm9uLWxlZnQiLAogICAgICAgICJ3aXphcmROZXh0SWNvbiIgOiAiZ2x5cGhpY29uIGdseXBoaWNvbi1jaGV2cm9uLXJpZ2h0IiwKICAgICAgICAid2l6YXJkRG9uZUljb24iIDogImdseXBoaWNvbiBnbHlwaGljb24tb2siLAoKCiAgICAgICAgLy8gcmVxdWlyZWQgZmllbGRzIGdldCBzdGFyIGljb24KICAgICAgICAicmVxdWlyZWQiIDogZnVuY3Rpb24odGFyZ2V0RGl2KQogICAgICAgIHsKICAgICAgICAgICAgJCgnPHNwYW4gY2xhc3M9ImdseXBoaWNvbiBnbHlwaGljb24tc3RhciI+PC9zcGFuPiZuYnNwOycpLnByZXBlbmRUbyh0YXJnZXREaXYpOwogICAgICAgIH0sCgogICAgICAgIC8vIGVycm9yIGZpZWxkcyBnZXQgdGhlICJoYXMtZXJyb3IiIGNsYXNzCiAgICAgICAgImVycm9yIiA6IGZ1bmN0aW9uKHRhcmdldERpdikgewogICAgICAgICAgICB0YXJnZXREaXYuYWRkQ2xhc3MoJ2hhcy1lcnJvcicpOwoKICAgICAgICAgICAgLyoKICAgICAgICAgICAgJCh0YXJnZXREaXYpLnBvcG92ZXIoewogICAgICAgICAgICAgICAgImh0bWwiOiB0cnVlLAogICAgICAgICAgICAgICAgInRyaWdnZXIiOiAibWFudWFsIiwKICAgICAgICAgICAgICAgICJjb250ZW50IjogImVycm9yIG1lc3NhZ2UiCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAkKHRhcmdldERpdikub24oInNob3duLmJzLnBvcG92ZXIiLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGRlYnVnZ2VyOwogICAgICAgICAgICAgICAgJCh0aGlzKS5jc3MoewogICAgICAgICAgICAgICAgICAgICJib3JkZXIiOiAiMXB4IHJlZCBzb2xpZCIsCiAgICAgICAgICAgICAgICAgICAgImNvbG9yIjogInJlZCIKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgJCh0YXJnZXREaXYpLnBvcG92ZXIoInNob3ciKTsKICAgICAgICAgICAgKi8KICAgICAgICB9LAogICAgICAgICJyZW1vdmVFcnJvciIgOiBmdW5jdGlvbih0YXJnZXREaXYpIHsKICAgICAgICAgICAgdGFyZ2V0RGl2LnJlbW92ZUNsYXNzKCdoYXMtZXJyb3InKTsKCiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICQodGFyZ2V0RGl2KS5wb3BvdmVyKCJoaWRlIik7CiAgICAgICAgICAgICovCgogICAgICAgICAgICAvKgogICAgICAgICAgICAkKHRhcmdldERpdikub24oImhpZGRlbi5icy5wb3BvdmVyIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkKHRhcmdldERpdikucG9wb3ZlcigiZGVzdHJveSIpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgKi8KICAgICAgICB9LAoKICAgICAgICAvLyBUaGUgV2l6YXJkIHN0aWxsIHJlbGllcyBvbiBqUXVlcnkgVUkKICAgICAgICAid2l6YXJkU3RhdHVzQmFyIiA6IGZ1bmN0aW9uKHRhcmdldERpdikgewogICAgICAgICAgICB0YXJnZXREaXYuYWRkQ2xhc3MoJ3VpLXdpZGdldC1oZWFkZXIgdWktY29ybmVyLWFsbCcpOwogICAgICAgIH0sCiAgICAgICAgIndpemFyZEN1cnJlbnRTdGVwIiA6IGZ1bmN0aW9uKHRhcmdldERpdikgewogICAgICAgICAgICB0YXJnZXREaXYuYWRkQ2xhc3MoJ3VpLXN0YXRlLWhpZ2hsaWdodCB1aS1jb3JuZXItYWxsJyk7CiAgICAgICAgfSwKICAgICAgICAid2l6YXJkVW5DdXJyZW50U3RlcCIgOiBmdW5jdGlvbih0YXJnZXREaXYpIHsKICAgICAgICAgICAgdGFyZ2V0RGl2LnJlbW92ZUNsYXNzKCd1aS1zdGF0ZS1oaWdobGlnaHQgdWktY29ybmVyLWFsbCcpOwogICAgICAgIH0sCgogICAgICAgICJidXR0b25CZWF1dGlmaWVyIiAgOiBmdW5jdGlvbihidXR0b24sIGljb25DbGFzcywgd2l0aFRleHQpIHsKICAgICAgICAgICAgdmFyIGJ1dHRvblRleHQgPSBidXR0b24uaHRtbCgpOwogICAgICAgICAgICBidXR0b24uYXR0cigidGl0bGUiLCBidXR0b25UZXh0KTsKICAgICAgICAgICAgYnV0dG9uLmVtcHR5KCkuYXBwZW5kKCc8YiBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWxlZ2VuZC1idXR0b24gJyArIGljb25DbGFzcyArICciPjwvYj4nKTsKICAgICAgICAgICAgdmFyIGFkZGVkQnV0dG9uVGV4dCA9IHdpdGhUZXh0ID8gYnV0dG9uVGV4dCA6IG51bGw7CiAgICAgICAgICAgIGlmIChhZGRlZEJ1dHRvblRleHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGJ1dHRvbi5hcHBlbmQoJzxzcGFuIGNsYXNzPSJhbHBhY2EtZmllbGRzZXQtbGVnZW5kLWJ1dHRvbi10ZXh0Ij4nICsgYWRkZWRCdXR0b25UZXh0ICsgJzwvc3Bhbj4nKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgogICAgdmFyIHJlbmRlckZ1bmN0aW9uID0gZnVuY3Rpb24oZmllbGQsIHJlbmRlcmVkQ2FsbGJhY2spCiAgICB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICBmaWVsZC5yZW5kZXIoZnVuY3Rpb24oZmllbGQpIHsKCiAgICAgICAgICAgIGlmIChyZW5kZXJlZENhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICByZW5kZXJlZENhbGxiYWNrLmNhbGwoc2VsZiwgZmllbGQpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9OwoKICAgIEFscGFjYS5yZWdpc3RlclZpZXcoewogICAgICAgICJpZCI6ICJWSUVXX0JPT1RTVFJBUF9ESVNQTEFZIiwKICAgICAgICAicGFyZW50IjogIlZJRVdfV0VCX0RJU1BMQVkiLAogICAgICAgICJ0aXRsZSI6ICJEaXNwbGF5IFZpZXcgZm9yIEJvb3RzdHJhcCIsCiAgICAgICAgImRlc2NyaXB0aW9uIjogIkRpc3BsYXkgVmlldyBmb3IgQm9vdHN0cmFwIiwKICAgICAgICAic3R5bGUiOiAiYm9vdHN0cmFwIiwKICAgICAgICAidWkiOiAiYm9vdHN0cmFwIiwKICAgICAgICAidGVtcGxhdGVzIjogZGlzcGxheVRlbXBsYXRlcywKICAgICAgICAicmVuZGVyIjogcmVuZGVyRnVuY3Rpb24sCiAgICAgICAgInR5cGUiOiAidmlldyIKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3RlclZpZXcoewogICAgICAgICJpZCI6ICJWSUVXX0JPT1RTVFJBUF9FRElUIiwKICAgICAgICAicGFyZW50IjogJ1ZJRVdfV0VCX0VESVQnLAogICAgICAgICJ0aXRsZSI6ICJFZGl0IFZpZXcgZm9yIEJvb3RzdHJhcCIsCiAgICAgICAgImRlc2NyaXB0aW9uIjogIkVkaXQgVmlldyBmb3IgQm9vdHN0cmFwIiwKICAgICAgICAic3R5bGUiOiAiYm9vdHN0cmFwIiwKICAgICAgICAidWkiOiAiYm9vdHN0cmFwIiwKICAgICAgICAidGVtcGxhdGVzIjogZWRpdFRlbXBsYXRlcywKICAgICAgICAicmVuZGVyIjogcmVuZGVyRnVuY3Rpb24sCiAgICAgICAgInR5cGUiOiAiZWRpdCIKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3RlclZpZXcoewogICAgICAgICJpZCI6ICJWSUVXX0JPT1RTVFJBUF9DUkVBVEUiLAogICAgICAgICJwYXJlbnQiOiAnVklFV19XRUJfQ1JFQVRFJywKICAgICAgICAidGl0bGUiOiAiQ3JlYXRlIFZpZXcgZm9yIEJvb3RzdHJhcCIsCiAgICAgICAgImRlc2NyaXB0aW9uIjoiQ3JlYXRlIFZpZXcgZm9yIEJvb3RzdHJhcCIsCiAgICAgICAgInN0eWxlIjogImJvb3RzdHJhcCIsCiAgICAgICAgInVpIjogImJvb3RzdHJhcCIsCiAgICAgICAgInRlbXBsYXRlcyI6IGVkaXRUZW1wbGF0ZXMsCiAgICAgICAgInJlbmRlciI6IHJlbmRlckZ1bmN0aW9uLAogICAgICAgICJ0eXBlIjogImNyZWF0ZSIKICAgIH0pOwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLnJlZ2lzdGVyVmlldyh7CiAgICAgICAgImlkIjogIlZJRVdfV0VCX0VESVRfVEFCTEUiLAogICAgICAgICJwYXJlbnQiOiAnVklFV19XRUJfRURJVCcsCiAgICAgICAgInRpdGxlIjogIldlYiBFZGl0IFZpZXcgVGFibGUgU3R5bGUiLAogICAgICAgICJkZXNjcmlwdGlvbiI6ICJXZWIgZWRpdCB2aWV3IGJhc2VkIG9uIHRhYmxlIHN0eWxlcy4iLAogICAgICAgICJ0eXBlIjogImVkaXQiLAogICAgICAgICJkaXNwbGF5UmVhZG9ubHkiOiB0cnVlLAogICAgICAgICJjb2xsYXBzaWJsZSI6IGZhbHNlLAogICAgICAgICJsZWdlbmRTdHlsZSI6ICJsaW5rIiwKICAgICAgICAidGVtcGxhdGVzIjogewoKICAgICAgICAgICAgLy8gVGVtcGxhdGVzIGZvciBjb250cm9sIGZpZWxkcwogICAgICAgICAgICAiY29udHJvbEZpZWxkT3V0ZXJFbCI6IG51bGwsCiAgICAgICAgICAgICJjb250cm9sRmllbGRMYWJlbCI6ICc8dGQ+e3tpZiBvcHRpb25zLmxhYmVsfX08bGFiZWwgZm9yPSIke2lkfSIgY2xhc3M9Int7aWYgb3B0aW9ucy5sYWJlbENsYXNzfX0ke29wdGlvbnMubGFiZWxDbGFzc317ey9pZn19Ij4ke29wdGlvbnMubGFiZWx9PC9sYWJlbD57ey9pZn19PC90ZD4nLAogICAgICAgICAgICAiY29udHJvbEZpZWxkQ29udGFpbmVyIjogJzx0ZCBkYXRhLWNvbnRyb2w9ImFwcGVuZCI+e3todG1sIHRoaXMuaHRtbH19PC90ZD4nLAogICAgICAgICAgICAiY29udHJvbEZpZWxkTWVzc2FnZSI6ICc8ZGl2PjxzcGFuIGNsYXNzPSJ1aS1pY29uIHVpLWljb24tYWxlcnQiPjwvc3Bhbj48c3BhbiBjbGFzcz0iYWxwYWNhLWNvbnRyb2xmaWVsZC1tZXNzYWdlLXRleHQiPiR7bWVzc2FnZX08L3NwYW4+PC9kaXY+JywKICAgICAgICAgICAgImNvbnRyb2xGaWVsZEhlbHBlciI6ICd7e2lmIG9wdGlvbnMuaGVscGVyfX08ZGl2IGNsYXNzPSJ7e2lmIG9wdGlvbnMuaGVscGVyQ2xhc3N9fSR7b3B0aW9ucy5oZWxwZXJDbGFzc317ey9pZn19Ij48c3BhbiBjbGFzcz0idWktaWNvbiB1aS1pY29uLWluZm8iPjwvc3Bhbj48c3BhbiBjbGFzcz0iYWxwYWNhLWNvbnRyb2xmaWVsZC1oZWxwZXItdGV4dCI+JHtvcHRpb25zLmhlbHBlcn08L3NwYW4+PC9kaXY+e3svaWZ9fScsCiAgICAgICAgICAgICJjb250cm9sRmllbGQiOgogICAgICAgICAgICAgICAgJ3t7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJjb250cm9sRmllbGRMYWJlbCIpfX0nICsKICAgICAgICAgICAgICAgICd7e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImNvbnRyb2xGaWVsZENvbnRhaW5lciIsdHJ1ZSl9fScgKwogICAgICAgICAgICAgICAgICAgICd7e2h0bWwgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiY29udHJvbEZpZWxkSGVscGVyIil9fScgKwogICAgICAgICAgICAgICAgJ3t7L3dyYXB9fScsCgogICAgICAgICAgICAvLyBUZW1wbGF0ZXMgZm9yIGNvbnRhaW5lciBmaWVsZHMKICAgICAgICAgICAgImZpZWxkU2V0T3V0ZXJFbCI6ICc8ZmllbGRzZXQgY2xhc3M9ImFscGFjYS12aWV3LXdlYi1lZGl0LXRhYmxlIj57e2h0bWwgdGhpcy5odG1sfX08L2ZpZWxkc2V0PicsCiAgICAgICAgICAgICJmaWVsZFNldE1lc3NhZ2UiOiAnPGRpdj48c3BhbiBjbGFzcz0idWktaWNvbiB1aS1pY29uLWFsZXJ0IGFscGFjYS1maWVsZHNldC1tZXNzYWdlLXRhYmxlLXZpZXciPjwvc3Bhbj48c3Bhbj4ke21lc3NhZ2V9PC9zcGFuPjwvZGl2PicsCiAgICAgICAgICAgICJmaWVsZFNldExlZ2VuZCI6ICd7e2lmIG9wdGlvbnMubGFiZWx9fTxsZWdlbmQgY2xhc3M9Int7aWYgb3B0aW9ucy5sYWJlbENsYXNzfX0ke29wdGlvbnMubGFiZWxDbGFzc317ey9pZn19Ij4ke29wdGlvbnMubGFiZWx9PC9sZWdlbmQ+e3svaWZ9fScsCiAgICAgICAgICAgICJmaWVsZFNldEhlbHBlciI6ICd7e2lmIG9wdGlvbnMuaGVscGVyfX08ZGl2IGNsYXNzPSJ7e2lmIG9wdGlvbnMuaGVscGVyQ2xhc3N9fSR7b3B0aW9ucy5oZWxwZXJDbGFzc317ey9pZn19Ij4ke29wdGlvbnMuaGVscGVyfTwvZGl2Pnt7L2lmfX0nLAogICAgICAgICAgICAiZmllbGRTZXRJdGVtc0NvbnRhaW5lciI6ICc8dGFibGU+PHRib2R5Pnt7aHRtbCB0aGlzLmh0bWx9fTwvdGJvZHk+PC90YWJsZT4nLAogICAgICAgICAgICAiZmllbGRTZXQiOiAne3t3cmFwKG51bGwsIHt9KSBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmaWVsZFNldE91dGVyRWwiLHRydWUpfX17e2h0bWwgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiZmllbGRTZXRMZWdlbmQiKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0SGVscGVyIil9fXt7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiZmllbGRTZXRJdGVtc0NvbnRhaW5lciIsdHJ1ZSl9fXt7L3dyYXB9fXt7L3dyYXB9fScsCiAgICAgICAgICAgICJmaWVsZFNldEl0ZW1Db250YWluZXIiOiAnPHRyPjwvdHI+JywKCiAgICAgICAgICAgICJpdGVtTGFiZWwiIDogJ3t7aWYgb3B0aW9ucy5pdGVtTGFiZWx9fTxsYWJlbCBmb3I9IiR7aWR9IiBjbGFzcz0iYWxwYWNhLWNvbnRyb2xmaWVsZC1sYWJlbCBhbHBhY2EtY29udHJvbGZpZWxkLWxhYmVsLWxpc3QtdmlldyI+PHNwYW4gY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtaXRlbS1sYWJlbC1saXN0LXZpZXciPiR7b3B0aW9ucy5pdGVtTGFiZWx9e3tpZiBpbmRleH19IDxzcGFuIGNsYXNzPSJhbHBhY2EtaXRlbS1sYWJlbC1jb3VudGVyIj4ke2luZGV4fTwvc3Bhbj48L3NwYW4+e3svaWZ9fTwvbGFiZWw+e3svaWZ9fScKICAgICAgICB9LAogICAgICAgICJzdHlsZXMiOiB7CiAgICAgICAgfSwKICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAiLyI6IHsKICAgICAgICAgICAgICAgICJ0ZW1wbGF0ZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgLy8gVGVtcGxhdGVzIGZvciBjb250YWluZXIgZmllbGRzCiAgICAgICAgICAgICAgICAgICAgImZpZWxkU2V0SXRlbXNDb250YWluZXIiOiAnPHRhYmxlIGNsYXNzPSJhbHBhY2EtZmllbGRzZXQtaXRlbXNjb250YWluZXItbGlzdC12aWV3LXRvcCI+e3todG1sIHRoaXMuaHRtbH19PC90YWJsZT4nLAogICAgICAgICAgICAgICAgICAgICJmaWVsZFNldEl0ZW1Db250YWluZXIiOiAnPHRyIGNsYXNzPSJhbHBhY2EtZmllbGRzZXQtaXRlbXNjb250YWluZXItbGlzdC12aWV3LXRvcCI+PC90cj4nCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyVmlldyh7CiAgICAgICAgImlkIjogIlZJRVdfV0VCX0NSRUFURV9UQUJMRSIsCiAgICAgICAgInBhcmVudCI6ICdWSUVXX1dFQl9FRElUX1RBQkxFJywKICAgICAgICAidGl0bGUiOiAiRGVmYXVsdCBXZWIgQ3JlYXRlIFZpZXcgVGFibGUgU3RsZSIsCiAgICAgICAgImRlc2NyaXB0aW9uIjoiRGVmYXVsdCB3ZWIgY3JlYXRlIHZpZXcgKFRhYmxlIFN0eWxlKSB3aGljaCBkb2Vzbid0IGJpbmQgaW5pdGlhbCBkYXRhLiIsCiAgICAgICAgInR5cGUiOiAiY3JlYXRlIiwKICAgICAgICAiZGlzcGxheVJlYWRvbmx5IjpmYWxzZQogICAgfSk7Cgp9KShqUXVlcnkpOyhmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5yZWdpc3RlclZpZXcoewogICAgICAgICJpZCI6ICJWSUVXX1dFQl9FRElUX1lBTUwiLAogICAgICAgICJwYXJlbnQiOiAnVklFV19XRUJfRURJVCcsCiAgICAgICAgInRpdGxlIjogIldlYiBFZGl0IFZpZXcgTGlzdCBTdHlsZSIsCiAgICAgICAgImRlc2NyaXB0aW9uIjogIldlYiBlZGl0IGxpc3Qgc3R5bGVkIHRvIGxvb2sgbGlrZSBhIFlBTUwgZWRpdG9yLiIsCiAgICAgICAgInR5cGUiOiAiZWRpdCIsCiAgICAgICAgImRpc3BsYXlSZWFkb25seSI6IHRydWUsCiAgICAgICAgImNvbGxhcHNpYmxlIjogdHJ1ZSwKICAgICAgICAibGVnZW5kU3R5bGUiOiAibGluayIsCiAgICAgICAgInRlbXBsYXRlcyI6IHsKICAgICAgICAgICAgLy8gVGVtcGxhdGVzIGZvciBjb250cm9sIGZpZWxkcwogICAgICAgICAgICAiY29udHJvbEZpZWxkT3V0ZXJFbCI6ICc8c3BhbiBjbGFzcz0iYWxwYWNhLXZpZXctd2ViLWVkaXQteWFtbCIgdGl0bGU9IiR7b3B0aW9ucy5oZWxwZXJ9Ij57e2h0bWwgdGhpcy5odG1sfX08L3NwYW4+JywKICAgICAgICAgICAgImNvbnRyb2xGaWVsZE1lc3NhZ2UiOiAnPGRpdj48c3BhbiBjbGFzcz0idWktaWNvbiB1aS1pY29uLWFsZXJ0Ij48L3NwYW4+PHNwYW4gY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtbWVzc2FnZS10ZXh0Ij4ke21lc3NhZ2V9PC9zcGFuPjwvZGl2PicsCiAgICAgICAgICAgICJjb250cm9sRmllbGRMYWJlbCI6ICd7e2lmIG9wdGlvbnMubGFiZWx9fTxsYWJlbCBmb3I9IiR7aWR9IiBjbGFzcz0ie3tpZiBvcHRpb25zLmxhYmVsQ2xhc3N9fSR7b3B0aW9ucy5sYWJlbENsYXNzfXt7L2lmfX0iPiR7b3B0aW9ucy5sYWJlbH06PC9sYWJlbD57ey9pZn19JywKICAgICAgICAgICAgImNvbnRyb2xGaWVsZEhlbHBlciI6ICc8c3BhbiBzdHlsZT0iZGlzcGxheTpub25lIiAvPicsCiAgICAgICAgICAgICJjb250cm9sRmllbGRDb250YWluZXIiOiAnPGRpdj57e2h0bWwgdGhpcy5odG1sfX08L2Rpdj4nLAogICAgICAgICAgICAiY29udHJvbEZpZWxkIjogJ3t7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiY29udHJvbEZpZWxkT3V0ZXJFbCIsdHJ1ZSl9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJjb250cm9sRmllbGRMYWJlbCIpfX17e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImNvbnRyb2xGaWVsZENvbnRhaW5lciIsdHJ1ZSl9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJjb250cm9sRmllbGRIZWxwZXIiKX19e3svd3JhcH19e3svd3JhcH19JywKICAgICAgICAgICAgLy8gVGVtcGxhdGVzIGZvciBjb250YWluZXIgZmllbGRzCiAgICAgICAgICAgICJmaWVsZFNldE91dGVyRWwiOiAnPGZpZWxkc2V0IGNsYXNzPSJhbHBhY2Etdmlldy13ZWItZWRpdC15YW1sIj57e2h0bWwgdGhpcy5odG1sfX08L2ZpZWxkc2V0PicsCiAgICAgICAgICAgICJmaWVsZFNldE1lc3NhZ2UiOiAnPGRpdj48c3BhbiBjbGFzcz0idWktaWNvbiB1aS1pY29uLWFsZXJ0IGFscGFjYS1maWVsZHNldC1tZXNzYWdlLWxpc3QtdmlldyI+PC9zcGFuPjxzcGFuPiR7bWVzc2FnZX08L3NwYW4+PC9kaXY+JywKICAgICAgICAgICAgImZpZWxkU2V0TGVnZW5kIjogJ3t7aWYgb3B0aW9ucy5sYWJlbH19PGxlZ2VuZCBjbGFzcz0ie3tpZiBvcHRpb25zLmxhYmVsQ2xhc3N9fSR7b3B0aW9ucy5sYWJlbENsYXNzfXt7L2lmfX0iPiR7b3B0aW9ucy5sYWJlbH08L2xlZ2VuZD57ey9pZn19JywKICAgICAgICAgICAgImZpZWxkU2V0SGVscGVyIjogJ3t7aWYgb3B0aW9ucy5oZWxwZXJ9fTxkaXYgY2xhc3M9Int7aWYgb3B0aW9ucy5oZWxwZXJDbGFzc319JHtvcHRpb25zLmhlbHBlckNsYXNzfXt7L2lmfX0iPiR7b3B0aW9ucy5oZWxwZXJ9PC9kaXY+e3svaWZ9fScsCiAgICAgICAgICAgICJmaWVsZFNldEl0ZW1zQ29udGFpbmVyIjogJzxvbD57e2h0bWwgdGhpcy5odG1sfX08L29sPicsCiAgICAgICAgICAgICJmaWVsZFNldCI6ICd7e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0T3V0ZXJFbCIsdHJ1ZSl9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmaWVsZFNldExlZ2VuZCIpfX17e2h0bWwgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiZmllbGRTZXRIZWxwZXIiKX19e3t3cmFwKG51bGwsIHt9KSBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmaWVsZFNldEl0ZW1zQ29udGFpbmVyIix0cnVlKX19e3svd3JhcH19e3svd3JhcH19JywKICAgICAgICAgICAgImZpZWxkU2V0SXRlbUNvbnRhaW5lciI6ICc8bGkgc3R5bGU9Imxpc3Qtc3R5bGU6bm9uZTsiPjwvbGk+JywKCiAgICAgICAgICAgICJpdGVtTGFiZWwiIDogJ3t7aWYgb3B0aW9ucy5pdGVtTGFiZWx9fTxsYWJlbCBmb3I9IiR7aWR9IiBjbGFzcz0iYWxwYWNhLWNvbnRyb2xmaWVsZC1sYWJlbCBhbHBhY2EtY29udHJvbGZpZWxkLWxhYmVsLWxpc3QtdmlldyI+PHNwYW4gY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtaXRlbS1sYWJlbC1saXN0LXZpZXciPiR7b3B0aW9ucy5pdGVtTGFiZWx9e3tpZiBpbmRleH19IDxzcGFuIGNsYXNzPSJhbHBhY2EtaXRlbS1sYWJlbC1jb3VudGVyIj4ke2luZGV4fTwvc3Bhbj48L3NwYW4+e3svaWZ9fTwvbGFiZWw+e3svaWZ9fScKCiAgICAgICAgfSwKICAgICAgICAic3R5bGVzIjogewogICAgICAgIH0sCiAgICAgICAgImZpZWxkcyI6IHsKICAgICAgICAgICAgIi8iOiB7CiAgICAgICAgICAgICAgICAidGVtcGxhdGVzIjogewogICAgICAgICAgICAgICAgICAgIC8vIFRlbXBsYXRlcyBmb3IgY29udGFpbmVyIGZpZWxkcwogICAgICAgICAgICAgICAgICAgICJmaWVsZFNldEl0ZW1zQ29udGFpbmVyIjogJzxvbCBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWl0ZW1zY29udGFpbmVyLWxpc3Qtdmlldy10b3AiPnt7aHRtbCB0aGlzLmh0bWx9fTwvb2w+JywKICAgICAgICAgICAgICAgICAgICAiZmllbGRTZXRJdGVtQ29udGFpbmVyIjogJzxsaSBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWl0ZW1jb250YWluZXItbGlzdC12aWV3LXRvcCI+PC9saT4nCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKfSkoalF1ZXJ5KTsKLypqc2hpbnQgLVcwMTQgKi8gLy8gYmFkIGxpbmUgYnJlYWtpbmcKKGZ1bmN0aW9uKCQpIHsKICAgIAogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwogICAgCiAgICBBbHBhY2EucmVnaXN0ZXJWaWV3KHsKICAgICAgICAiaWQiOiJWSUVXX1dFQl9FRElUX0lOTElORSIsCiAgICAgICAgInBhcmVudCI6IlZJRVdfV0VCX0VESVQiLAogICAgICAgICJ0aXRsZSI6IkRlZmF1bHQgV2ViIEVkaXQgd2l0aCBmaWVsZHMgaW5saW5pbmcgY2FwYWJpbGl0aWVzIiwKICAgICAgICAiZGVzY3JpcHRpb24iOiJFZGl0IHRlbXBsYXRlIHdpdGggZm9ybSBmaWVsZHMgaW5saW5pbmcgY2FwYWJpbGl0aWVzLCB2aWEgb3B0aW9ucy5pbmxpbmUgbGV2ZWwgdG8gZGlzcGxheSBzb21lIGZvcm1zIHBhcnRzIGlubGluZS4gVXNlZnVsIHRvIGRpc3BsYXkgZm9yIGV4YW1wbGUgYW4gQXJyYXlGaWVsZCBjb250YWluaW5nIE9iamVjdEZpZWxkIGl0ZW1zIGluIGEgY29tcGFjdCBtYW5uZXIuIiwKICAgICAgICAidHlwZSI6ImVkaXQiLAogICAgICAgICJwbGF0Zm9ybSI6IndlYiIsCiAgICAgICAgInN0eWxlIjoianF1ZXJ5LXVpIiwKICAgICAgICAiZGlzcGxheVJlYWRvbmx5Ijp0cnVlLAogICAgICAgICJ0ZW1wbGF0ZXMiOiB7CiAgICAgICAgICAgICJmaWVsZFNldE91dGVyRWwiOiAnPGZpZWxkc2V0IGNsYXNzPSJ7e2lmIG9wdGlvbnMuaW5saW5lfX1hbHBhY2EtaW5saW5le3svaWZ9fSI+e3todG1sIHRoaXMuaHRtbH19PC9maWVsZHNldD4nLAogICAgICAgICAgICAiZmllbGRTZXRJdGVtQ29udGFpbmVyIjogJzxkaXYgY2xhc3M9ImFscGFjYS1pbmxpbmUtaXRlbS1jb250YWluZXIiPjwvZGl2PicsICAgICAgICAgICAgCiAgICAgICAgICAgICJhcnJheUl0ZW1Ub29sYmFyIjogJzxkaXYgY2xhc3M9ImFscGFjYS1maWVsZHNldC1hcnJheS1pdGVtLXRvb2xiYXIiIGRhdGEtcm9sZT0iY29udHJvbGdyb3VwIiBkYXRhLXR5cGU9Imhvcml6b250YWwiIGRhdGEtbWluaT0idHJ1ZSI+JwogICAgICAgICAgICAgICAgKyc8c3BhbiBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWFycmF5LWl0ZW0tdG9vbGJhci1hZGQiIGRhdGEtcm9sZT0iYnV0dG9uIiBkYXRhLWljb249ImFkZCIgZGF0YS1pY29ucG9zPSJub3RleHQiPkFkZDwvc3Bhbj4nCiAgICAgICAgICAgICAgICArJzxzcGFuIGNsYXNzPSJhbHBhY2EtZmllbGRzZXQtYXJyYXktaXRlbS10b29sYmFyLXJlbW92ZSIgZGF0YS1yb2xlPSJidXR0b24iIGRhdGEtaWNvbj0iZGVsZXRlIiBkYXRhLWljb25wb3M9Im5vdGV4dCI+RGVsZXRlPC9zcGFuPicKICAgICAgICAgICAgICAgICsnPHNwYW4gY2xhc3M9ImFscGFjYS1maWVsZHNldC1hcnJheS1pdGVtLXRvb2xiYXItdXAiIGRhdGEtcm9sZT0iYnV0dG9uIiBkYXRhLWljb249ImFycm93LXUiIGRhdGEtaWNvbnBvcz0ibm90ZXh0Ij5VcDwvc3Bhbj4nCiAgICAgICAgICAgICAgICArJzxzcGFuIGNsYXNzPSJhbHBhY2EtZmllbGRzZXQtYXJyYXktaXRlbS10b29sYmFyLWRvd24iIGRhdGEtcm9sZT0iYnV0dG9uIiBkYXRhLWljb249ImFycm93LWQiIGRhdGEtaWNvbnBvcz0ibm90ZXh0Ij5Eb3duPC9zcGFuPjwvZGl2PicKICAgICAgICB9CiAgICB9KTsKfSkoalF1ZXJ5KTsvKmpzaGludCAtVzAxNCAqLyAvLyBiYWQgbGluZSBicmVha2luZwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EucmVnaXN0ZXJWaWV3KHsKICAgICAgICAiaWQiOiAiVklFV19XRUJfRURJVCIsCiAgICAgICAgInRlbXBsYXRlcyI6IHsKICAgICAgICAgICAgInR3b0NvbHVtbkxheW91dCI6JzxkaXYgY2xhc3M9ImFscGFjYS1sYXlvdXQtdHdvLWNvbHVtbi1tYXNrIj4nCiAgICAgICAgICAgICAgICAgICAgKyAne3tpZiBvcHRpb25zLmxhYmVsfX08aDM+JHtvcHRpb25zLmxhYmVsfTwvaDM+e3svaWZ9fScKICAgICAgICAgICAgICAgICAgICArICd7e2lmIG9wdGlvbnMuaGVscGVyfX08aDQ+JHtvcHRpb25zLmhlbHBlcn08L2g0Pnt7L2lmfX0nCiAgICAgICAgICAgICAgICAgICAgKyAnPGRpdiBjbGFzcz0iYWxwYWNhLWxheW91dC10d28tY29sdW1uLWxlZnQgYWxwYWNhLWxheW91dC1yZWdpb24iICBpZD0ibGVmdGNvbHVtbiI+PC9kaXY+JwogICAgICAgICAgICAgICAgICAgICsgJzxkaXYgY2xhc3M9ImFscGFjYS1sYXlvdXQtdHdvLWNvbHVtbi1yaWdodCBhbHBhY2EtbGF5b3V0LXJlZ2lvbiIgaWQ9InJpZ2h0Y29sdW1uIj48L2Rpdj4nCiAgICAgICAgICAgICAgICAgICAgKyAnPC9kaXY+JwogICAgICAgIH0KICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3RlclZpZXcoewogICAgICAgICJpZCI6ICJWSUVXX1dFQl9FRElUX0xBWU9VVF9UV09fQ09MVU1OIiwKICAgICAgICAicGFyZW50IjogIlZJRVdfV0VCX0VESVQiLAogICAgICAgICJ0aXRsZSI6ICJXZWIgRWRpdCBWaWV3IHdpdGggVHdvLUNvbHVtbiBMYXlvdXQiLAogICAgICAgICJkZXNjcmlwdGlvbiI6ICJXZWIgZWRpdCBkZWZhdWx0IHZpZXcgd2l0aCB0d28tY29sdW1uIGxheW91dC4iLAogICAgICAgICJsYXlvdXQiIDogewogICAgICAgICAgICAidGVtcGxhdGUiIDogInR3b0NvbHVtbkxheW91dCIKICAgICAgICB9CiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJWaWV3KHsKICAgICAgICAiaWQiOiAiVklFV19XRUJfRURJVF9MSVNUX0xBWU9VVF9UV09fQ09MVU1OIiwKICAgICAgICAicGFyZW50IjogIlZJRVdfV0VCX0VESVRfTElTVCIsCiAgICAgICAgInRpdGxlIjogIldlYiBMaXN0IEVkaXQgVmlldyB3aXRoIFR3by1Db2x1bW4gTGF5b3V0IiwKICAgICAgICAiZGVzY3JpcHRpb24iOiAiV2ViIGVkaXQgbGlzdCB2aWV3IHdpdGggdHdvLWNvbHVtbiBsYXlvdXQuIiwKICAgICAgICAibGF5b3V0IiA6IHsKICAgICAgICAgICAgInRlbXBsYXRlIiA6ICJ0d29Db2x1bW5MYXlvdXQiCiAgICAgICAgfQogICAgfSk7Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuTm9ybWFsaXplZFZpZXcgPSBCYXNlLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5Ob3JtYWxpemVkVmlldy5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIE9uY2UgYWxsIG9mIHRoZSBBbHBhY2Egdmlld3MgYXJlIHJlZ2lzdGVyZWQgd2l0aCB0aGUgZnJhbWV3b3JrLCBlYWNoIGlzIG5vcm1hbGl6ZWQgc28gdGhhdCBwYXJlbnQtY2hhaW4KICAgICAgICAgKiByZWZlcmVuY2VzIGFuZCBvdmVycmlkZXMgYXJlIG5vcm1hbGl6ZWQgaW50byBhIHNpbmdsZSwgZmFzdCBsb29rdXAgb2JqZWN0LgogICAgICAgICAqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBOb3JtYWxpemVkIHZpZXcuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdGhlIHZpZXcgaWQKICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24odmlld0lkKSB7CiAgICAgICAgICAgIHRoaXMuaWQgPSB2aWV3SWQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogTm9ybWFsaXphdGlvbiBvY2N1cnMgb25jZSBwZXIgdmlldyB1cG9uIHN0YXJ0dXAgb2YgQWxwYWNhLgogICAgICAgICAqLwogICAgICAgIG5vcm1hbGl6ZTogZnVuY3Rpb24oKQogICAgICAgIHsKICAgICAgICAgICAgLy8gbG9hZCB0aGUgdmlldyBvYmplY3QKICAgICAgICAgICAgdmFyIHZpZXdPYmplY3QgID0gQWxwYWNhLnZpZXdzW3RoaXMuaWRdOwogICAgICAgICAgICBpZiAoIXZpZXdPYmplY3QpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIEFscGFjYS5sb2dFcnJvcigiVmlldyBjb21waWxhdGlvbiBmYWlsZWQgLSB2aWV3IG5vdCBmb3VuZDogIiArIHRoaXMuaWQpOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBjb2xsZWN0IHRoZSBpbmhlcml0YW5jZSBjaGFpbgogICAgICAgICAgICB2YXIgY2hhaW4gPSBbXTsKICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSB2aWV3T2JqZWN0OwogICAgICAgICAgICB3aGlsZSAoY3VycmVudCkgewogICAgICAgICAgICAgICAgY2hhaW4ucHVzaChjdXJyZW50KTsKCiAgICAgICAgICAgICAgICB2YXIgcGFyZW50SWQgPSBjdXJyZW50LnBhcmVudDsKICAgICAgICAgICAgICAgIGlmIChwYXJlbnRJZCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSBBbHBhY2Eudmlld3NbY3VycmVudC5wYXJlbnRdOwogICAgICAgICAgICAgICAgICAgIGlmICghcGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEFscGFjYS5sb2dFcnJvcigiVmlldyBjb21waWxhdGlvbiBmYWlsZWQgLSBjYW5ub3QgZmluZCBwYXJlbnQgdmlldzogIiArIHBhcmVudElkICsgIiBmb3IgdmlldzogIiArIGN1cnJlbnQuaWQpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBwYXJlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHJldmVyc2UgdGhlIGNoYWluCiAgICAgICAgICAgIGNoYWluID0gY2hhaW4ucmV2ZXJzZSgpOwoKICAgICAgICAgICAgdmFyIHNldFNjYWxhciA9IGZ1bmN0aW9uKHRhcmdldCwgc291cmNlLCBwcm9wZXJ0eUlkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBzb3VyY2VbcHJvcGVydHlJZF07CgogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRWYWx1ZSA9IHRhcmdldFtwcm9wZXJ0eUlkXTsKICAgICAgICAgICAgICAgIGlmICghQWxwYWNhLmlzVW5kZWZpbmVkKGN1cnJlbnRWYWx1ZSkgJiYgIUFscGFjYS5pc1VuZGVmaW5lZCh2YWx1ZSkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgQWxwYWNhLmxvZ0RlYnVnKCJWaWV3IHByb3BlcnR5OiAiICsgcHJvcGVydHlJZCArICIgYWxyZWFkeSBoYXMgdmFsdWU6ICIgKyBjdXJyZW50VmFsdWUgKyAiIGFuZCBvdmVyd3JpdGluZyB0bzogIiArIHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc1VuZGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRbcHJvcGVydHlJZF0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHZhciBzZXRGdW5jdGlvbiA9IGZ1bmN0aW9uKHRhcmdldCwgc291cmNlLCBwcm9wZXJ0eUlkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBzb3VyY2VbcHJvcGVydHlJZF07CgogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRWYWx1ZSA9IHRhcmdldFtwcm9wZXJ0eUlkXTsKICAgICAgICAgICAgICAgIGlmICghQWxwYWNhLmlzVW5kZWZpbmVkKGN1cnJlbnRWYWx1ZSkgJiYgIUFscGFjYS5pc1VuZGVmaW5lZCh2YWx1ZSkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgQWxwYWNhLmxvZ0RlYnVnKCJWaWV3IHByb3BlcnR5OiAiICsgcHJvcGVydHlJZCArICIgYWxyZWFkeSBoYXMgZnVuY3Rpb24sIG92ZXJ3cml0aW5nIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0W3Byb3BlcnR5SWRdID0gdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgbWVyZ2VNYXAgPSBmdW5jdGlvbih0YXJnZXQsIHNvdXJjZSwgcHJvcGVydHlJZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHNvdXJjZU1hcCA9IHNvdXJjZVtwcm9wZXJ0eUlkXTsKICAgICAgICAgICAgICAgIGlmIChzb3VyY2VNYXApCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0YXJnZXRbcHJvcGVydHlJZF0pCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRbcHJvcGVydHlJZF0gPSB7fTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIEFscGFjYS5tZXJnZU9iamVjdDIoc291cmNlTWFwLCB0YXJnZXRbcHJvcGVydHlJZF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gd2FsayBmb3J3YXJkIGFuZCBhcHBseQogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoYWluLmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9IGNoYWluW2ldOwoKICAgICAgICAgICAgICAgIC8vIHNjYWxhciBwcm9wZXJ0aWVzCiAgICAgICAgICAgICAgICBzZXRTY2FsYXIodGhpcywgZWxlbWVudCwgInR5cGUiKTsKICAgICAgICAgICAgICAgIHNldFNjYWxhcih0aGlzLCBlbGVtZW50LCAiZGlzcGxheVJlYWRvbmx5Iik7CiAgICAgICAgICAgICAgICBzZXRTY2FsYXIodGhpcywgZWxlbWVudCwgInBsYXRmb3JtIik7CiAgICAgICAgICAgICAgICBzZXRTY2FsYXIodGhpcywgZWxlbWVudCwgImRldmljZSIpOwogICAgICAgICAgICAgICAgc2V0U2NhbGFyKHRoaXMsIGVsZW1lbnQsICJzdHlsZSIpOwogICAgICAgICAgICAgICAgc2V0U2NhbGFyKHRoaXMsIGVsZW1lbnQsICJ1aSIpOwogICAgICAgICAgICAgICAgc2V0U2NhbGFyKHRoaXMsIGVsZW1lbnQsICJjb2xsYXBzaWJsZSIpOwogICAgICAgICAgICAgICAgc2V0U2NhbGFyKHRoaXMsIGVsZW1lbnQsICJsZWdlbmRTdHlsZSIpOwogICAgICAgICAgICAgICAgc2V0U2NhbGFyKHRoaXMsIGVsZW1lbnQsICJ0b29sYmFyU3R5bGUiKTsKICAgICAgICAgICAgICAgIHNldFNjYWxhcih0aGlzLCBlbGVtZW50LCAiYnV0dG9uU3R5bGUiKTsKICAgICAgICAgICAgICAgIHNldFNjYWxhcih0aGlzLCBlbGVtZW50LCAidG9vbGJhclN0aWNreSIpOwogICAgICAgICAgICAgICAgc2V0U2NhbGFyKHRoaXMsIGVsZW1lbnQsICJnbG9iYWxUZW1wbGF0ZSIpOwoKICAgICAgICAgICAgICAgIC8vIGZ1bmN0aW9ucwogICAgICAgICAgICAgICAgc2V0RnVuY3Rpb24odGhpcywgZWxlbWVudCwgInJlbmRlciIpOwogICAgICAgICAgICAgICAgc2V0RnVuY3Rpb24odGhpcywgZWxlbWVudCwgInBvc3RSZW5kZXIiKTsKCiAgICAgICAgICAgICAgICAvLyBtYXBzIChtZXJnZSkKICAgICAgICAgICAgICAgIG1lcmdlTWFwKHRoaXMsIGVsZW1lbnQsICJzdHlsZXMiKTsKICAgICAgICAgICAgICAgIG1lcmdlTWFwKHRoaXMsIGVsZW1lbnQsICJ0ZW1wbGF0ZXMiKTsKICAgICAgICAgICAgICAgIG1lcmdlTWFwKHRoaXMsIGVsZW1lbnQsICJtZXNzYWdlcyIpOwogICAgICAgICAgICAgICAgbWVyZ2VNYXAodGhpcywgZWxlbWVudCwgIndpemFyZCIpOwogICAgICAgICAgICAgICAgbWVyZ2VNYXAodGhpcywgZWxlbWVudCwgImZpZWxkcyIpOwogICAgICAgICAgICAgICAgbWVyZ2VNYXAodGhpcywgZWxlbWVudCwgImxheW91dCIpOwoKICAgICAgICAgICAgICAgIC8vIGNvbXBpbGVkIHRlbXBsYXRlcwogICAgICAgICAgICAgICAgbWVyZ2VNYXAodGhpcywgZWxlbWVudCwgImNvbXBpbGVkVGVtcGxhdGVzIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIEFscGFjYS5sb2dEZWJ1ZygiVmlldyBjb21waWxhdGlvbiBjb21wbGV0ZSBmb3IgdmlldzogIiArIHRoaXMuaWQpOwogICAgICAgICAgICBBbHBhY2EubG9nRGVidWcoIkZpbmFsIHZpZXc6ICIpOwogICAgICAgICAgICBBbHBhY2EubG9nRGVidWcoSlNPTi5zdHJpbmdpZnkodGhpcywgbnVsbCwgIiAgICIpKTsKCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgIH0pOwp9KShqUXVlcnkpOy8qanNoaW50IC1XMDA0ICovIC8vIGR1cGxpY2F0ZSB2YXJpYWJsZXMKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLlJ1bnRpbWVWaWV3ID0gQmFzZS5leHRlbmQoCiAgICAvKioKICAgICAqIEBsZW5kcyBBbHBhY2EuUnVudGltZVZpZXcucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBSdW50aW1lIGltcGxlbWVudGF0aW9uIG9mIGEgdmlldyBhcyBhcHBsaWVkIHRvIGEgZmllbGQuCiAgICAgICAgICoKICAgICAgICAgKiBUaGlzIHByb3ZpZGVzIGFjY2Vzc29ycyBpbnRvIHRoZSBuZXN0ZWQgYmVoYXZpb3JzIG9mIHZpZXdzIGFuZCBhbHNvIHRha2VzIGludG8gYWNjb3VudCBmaWVsZC1sZXZlbCBhdHRyaWJ1dGVzCiAgICAgICAgICogb2YgdGhlIGN1cnJlbnRseSByZW5kZXJpbmcgZG9tIGVsZW1lbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIENsYXNzIGZvciBtYW5hZ2luZyB2aWV3IGNvbXBvbmVudHMgc3VjaCBhcyBsYXlvdXQsIHRlbXBsYXRlLCBtZXNzYWdlIGV0Yy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0aGUgdmlldyBpZAogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBmaWVsZCB0aGUgZmllbGQgY29udHJvbAogICAgICAgICAqLwogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbih2aWV3SWQsIGZpZWxkKSB7CiAgICAgICAgICAgIHRoaXMuZmllbGQgPSBmaWVsZDsKICAgICAgICAgICAgdGhpcy5zZXRWaWV3KHZpZXdJZCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogU2V0cyB0aGUgdmlldyB0aGF0IHRoaXMgcnVudGltZSB2aWV3IGFkYXB0ZXJzIHNob3VsZCBjb25zdWx0IGR1cmluZyByZW5kZXIuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdGhlIHZpZXcgaWQKICAgICAgICAgKi8KICAgICAgICBzZXRWaWV3OiBmdW5jdGlvbiAodmlld0lkKQogICAgICAgIHsKICAgICAgICAgICAgLy8gVE9ETzogc2hvdWxkIGZpZWxkIGNsYXNzZXMgZXZlciByZWFsbHkgYmUgaW5zdGFudGlhdGVkIGRpcmVjdGx5PwogICAgICAgICAgICAvLyBUT0RPOiB0aGlzIGlzIGxlZnQgaW4gdG8gc3VwcG9ydCBBbHBhY2EgZG9jcyBnZW5lcmF0aW9uIChuZWVkIHRvIGNsZWFuIHRoaXMgdXApcwogICAgICAgICAgICAvLyBpZiBhIHZpZXcgaXMgbm90IHNldCBhdCB0aGlzIHBvaW50IGl0IHByb2JhYmx5IG1lYW5zIHRoZXkgaW5zdGFudGlhdGVkIGEgZmllbGQgZGlyZWN0bHkKICAgICAgICAgICAgLy8gaW4gd2hpY2ggY2FzZSwgd2UnbGwganVzdCBwaWNrIHRoZSBkZWZhdWx0IHZpZXcKICAgICAgICAgICAgaWYgKCF2aWV3SWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuaWQgPSAiVklFV19XRUJfRURJVCI7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHRoZSBub3JtYWxpemVkIHZpZXcKICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZWRWaWV3ID0gQWxwYWNhLmdldE5vcm1hbGl6ZWRWaWV3KHZpZXdJZCk7CiAgICAgICAgICAgIGlmICghbm9ybWFsaXplZFZpZXcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIHRoaXMgc2hvdWxkIG5ldmVyIGJlIHRoZSBjYXNlCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJ1bnRpbWUgdmlldyBmb3IgdmlldyBpZDogIiArIHZpZXdJZCArICIgY291bGQgbm90IGZpbmQgYSBub3JtYWxpemVkIHZpZXciKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gY29weSBjb21waWxlZCBwcm9wZXJ0aWVzIGludG8gdGhpcyBvYmplY3QKICAgICAgICAgICAgZm9yICh2YXIgayBpbiBub3JtYWxpemVkVmlldykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZWRWaWV3Lmhhc093blByb3BlcnR5KGspKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpc1trXSA9IG5vcm1hbGl6ZWRWaWV3W2tdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB2aWV3IHdpemFyZCBzZXR0aW5ncy4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFZpZXcgd2l6YXJkIHNldHRpbmdzLgogICAgICAgICAqLwogICAgICAgIGdldFdpemFyZCA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Vmlld1BhcmFtKCJ3aXphcmQiKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBnbG9iYWwgbGF5b3V0IHRlbXBsYXRlLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge09iamVjdHxTdHJpbmd9IEdsb2JhbCBsYXlvdXQgdGVtcGxhdGUgc2V0dGluZyBvZiB0aGUgdmlldy4KICAgICAgICAgKi8KICAgICAgICBnZXRHbG9iYWxUZW1wbGF0ZURlc2NyaXB0b3IgOiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJnbG9iYWxUZW1wbGF0ZSIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgbGF5b3V0IHRlbXBsYXRlIGFuZCBiaW5kaW5ncy4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IExheW91dCB0ZW1wbGF0ZSBhbmQgYmluZGluZ3Mgc2V0dGluZyBvZiB0aGUgdmlldy4KICAgICAgICAgKi8KICAgICAgICBnZXRMYXlvdXQ6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGVtcGxhdGVEZXNjcmlwdG9yID0gdGhpcy5nZXRUZW1wbGF0ZURlc2NyaXB0b3IoImxheW91dFRlbXBsYXRlIik7CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgInRlbXBsYXRlRGVzY3JpcHRvciIgOiB0ZW1wbGF0ZURlc2NyaXB0b3IsCiAgICAgICAgICAgICAgICAiYmluZGluZ3MiIDogdGhpcy5nZXRWaWV3UGFyYW0oWyJsYXlvdXQiLCJiaW5kaW5ncyJdLCB0cnVlKQogICAgICAgICAgICB9OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgc3R5bGUgaW5qZWN0aW9uIGxpc3RzLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gc3R5bGVzIHN0eWxlIGluamVjdGlvbiBsaXN0IHNldHRpbmdzIG9mIHRoZSB2aWV3LgogICAgICAgICAqLwogICAgICAgIGdldFN0eWxlcyA6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgIHJldHVybiB0aGlzLnN0eWxlczsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBIYW5kcyBiYWNrIHRoZSBjb21waWxlZCB0ZW1wbGF0ZSBpZCBmb3IgYSBnaXZlbiB0ZW1wbGF0ZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB0ZW1wbGF0ZUlkCiAgICAgICAgICovCiAgICAgICAgZ2V0VGVtcGxhdGVEZXNjcmlwdG9yOiBmdW5jdGlvbih0ZW1wbGF0ZUlkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5nZXRUZW1wbGF0ZURlc2NyaXB0b3IodGhpcywgdGVtcGxhdGVJZCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyBtZXNzYWdlIGZvciB0aGUgZ2l2ZW4gaWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZUlkIE1lc3NhZ2UgaWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBNZXNzYWdlIG1hcHBlZCB0byB0aGUgZ2l2ZW4gaWQuCiAgICAgICAgICovCiAgICAgICAgZ2V0TWVzc2FnZSA6IGZ1bmN0aW9uIChtZXNzYWdlSWQpIHsKICAgICAgICAgICAgdmFyIG1lc3NhZ2VGb3JMb2NhbGUgPSB0aGlzLmdldFZpZXdQYXJhbShbIm1lc3NhZ2VzIixBbHBhY2EuZGVmYXVsdExvY2FsZSxtZXNzYWdlSWRdKTsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5pc0VtcHR5KG1lc3NhZ2VGb3JMb2NhbGUpID8gdGhpcy5nZXRWaWV3UGFyYW0oWyJtZXNzYWdlcyIsbWVzc2FnZUlkXSk6IG1lc3NhZ2VGb3JMb2NhbGU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0cmlldmVzIHZpZXcgcGFyYW1ldGVyIGJhc2VkIG9uIGNvbmZpZ3VyYXRpb24gSWQgb3IgSWQgYXJyYXkuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ3xBcnJheX0gY29uZmlnSWQgQ29uZmlndXJhdGlvbiBpZCBvciBhcnJheS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtBbnl9IFZpZXcgcGFyYW1ldGVyIG1hcHBlZCB0byBjb25maWd1cmF0aW9uIElkIG9yIElkIGFycmF5LgogICAgICAgICAqLwogICAgICAgIGdldFZpZXdQYXJhbTogZnVuY3Rpb24gKGNvbmZpZ0lkLCB0b3BMZXZlbE9ubHkpIHsKCiAgICAgICAgICAgIC8vIFRyeSB0aGUgZmllbGRzCiAgICAgICAgICAgIHZhciBmaWVsZFBhdGggPSB0aGlzLmZpZWxkLnBhdGg7CiAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkcyAmJiB0aGlzLmZpZWxkc1tmaWVsZFBhdGhdKSB7CiAgICAgICAgICAgICAgICB2YXIgY29uZmlnVmFsID0gdGhpcy5fZ2V0Q29uZmlnVmFsKHRoaXMuZmllbGRzW2ZpZWxkUGF0aF0sIGNvbmZpZ0lkKTsKICAgICAgICAgICAgICAgIGlmICghQWxwYWNhLmlzRW1wdHkoY29uZmlnVmFsKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjb25maWdWYWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGFycmF5IHJlbGF0ZWQgZmllbGQgcGF0aAogICAgICAgICAgICBpZiAoZmllbGRQYXRoICYmIGZpZWxkUGF0aC5pbmRleE9mKCdbJykgIT0gLTEgJiYgZmllbGRQYXRoLmluZGV4T2YoJ10nKSAhPSAtMSkgewogICAgICAgICAgICAgICAgZmllbGRQYXRoID0gZmllbGRQYXRoLnJlcGxhY2UoL1xbXGQrXF0vZywiWypdIik7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5maWVsZHMgJiYgdGhpcy5maWVsZHNbZmllbGRQYXRoXSkgewogICAgICAgICAgICAgICAgICAgIHZhciBjb25maWdWYWwgPSB0aGlzLl9nZXRDb25maWdWYWwodGhpcy5maWVsZHNbZmllbGRQYXRoXSwgY29uZmlnSWQpOwogICAgICAgICAgICAgICAgICAgIGlmICghQWxwYWNhLmlzRW1wdHkoY29uZmlnVmFsKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29uZmlnVmFsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eSh0b3BMZXZlbE9ubHkpICYmIHRvcExldmVsT25seSAmJiB0aGlzLmZpZWxkLnBhdGggIT0gIi8iKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2dldENvbmZpZ1ZhbCh0aGlzLCBjb25maWdJZCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogSW50ZXJuYWwgbWV0aG9kIGZvciBnZXR0aW5nIGNvbmZpZ3VyYXRpb24uCiAgICAgICAgICoKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtBbnl9IGNvbmZpZ1ZhbCBjb25maWd1cmF0aW9uIHZhbHVlLgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBjb25maWdJZCBjb25maWd1cmF0aW9uIGlkLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0FueX0gY29uZmlndXJhdGlvbiBtYXBwaW5nIHRvIHRoZSBnaXZlbiBpZAogICAgICAgICAqLwogICAgICAgIF9nZXRDb25maWdWYWwgOiBmdW5jdGlvbiAoY29uZmlnVmFsLCBjb25maWdJZCkgewogICAgICAgICAgICBpZiAoQWxwYWNhLmlzQXJyYXkoY29uZmlnSWQpKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvbmZpZ0lkLmxlbmd0aCAmJiAhQWxwYWNhLmlzRW1wdHkoY29uZmlnVmFsKTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uZmlnVmFsID0gY29uZmlnVmFsW2NvbmZpZ0lkW2ldXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghQWxwYWNhLmlzRW1wdHkoY29uZmlnVmFsKSkgewogICAgICAgICAgICAgICAgICAgIGNvbmZpZ1ZhbCA9IGNvbmZpZ1ZhbFtjb25maWdJZF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNvbmZpZ1ZhbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBMb2FkcyBhbiBpbmplY3RlZCBzdHlsZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBpZAogICAgICAgICAqLwogICAgICAgIGdldEluamVjdGVkU3R5bGU6IGZ1bmN0aW9uKGlkKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGluamVjdGVkU3R5bGUgPSBudWxsOwoKICAgICAgICAgICAgdmFyIGluamVjdGlvbnMgPSB7fTsKICAgICAgICAgICAgaWYgKHRoaXMuc3R5bGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBfaW5qZWN0aW9ucyA9IEFscGFjYS5zdHlsZUluamVjdGlvbnNbdGhpcy5zdHlsZV07CiAgICAgICAgICAgICAgICBpZiAoX2luamVjdGlvbnMpIHsKICAgICAgICAgICAgICAgICAgICBBbHBhY2EubWVyZ2VPYmplY3QoX2luamVjdGlvbnMsIGluamVjdGlvbnMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gaW5qZWN0ZWRTdHlsZVtpZF07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogRXhlY3V0ZXMgYSB0ZW1wbGF0ZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB2aWV3CiAgICAgICAgICogQHBhcmFtIHRlbXBsYXRlRGVzY3JpcHRvcgogICAgICAgICAqIEBwYXJhbSBtb2RlbAogICAgICAgICAqLwogICAgICAgIHRtcGw6IGZ1bmN0aW9uKHRlbXBsYXRlRGVzY3JpcHRvciwgbW9kZWwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLnRtcGwodGVtcGxhdGVEZXNjcmlwdG9yLCBtb2RlbCk7CiAgICAgICAgfQoKICAgIH0pOwp9KShqUXVlcnkpOyhmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZCA9IEJhc2UuZXh0ZW5kKAogICAgLyoqCiAgICAgKiBAbGVuZHMgQWxwYWNhLkZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBBYnN0cmFjdCBjbGFzcyB0aGF0IHNlcnZlZCBhcyBiYXNlIGZvciBhbGwgQWxwYWNhIGZpZWxkIGNsYXNzZXMgdGhhdCBwcm92aWRlIGFjdHVhbCBpbXBsZW1lbnRhdGlvbi4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdmlld0lkIHZpZXcgaWQKICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXdJZCwgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICAvLyBtYXJrIHRoYXQgd2UgYXJlIGluaXRpYWxpemluZwogICAgICAgICAgICB0aGlzLmluaXRpYWxpemluZyA9IHRydWU7CgogICAgICAgICAgICAvLyBjb250YWluZXIKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBjb250YWluZXI7CgogICAgICAgICAgICAvLyBwYXJlbnQKICAgICAgICAgICAgdGhpcy5wYXJlbnQgPSBudWxsOwoKICAgICAgICAgICAgLy8gY29uZmlnCiAgICAgICAgICAgIHRoaXMuZGF0YSA9IGRhdGE7CiAgICAgICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgICAgICAgIHRoaXMuc2NoZW1hID0gc2NoZW1hOwogICAgICAgICAgICB0aGlzLmNvbm5lY3RvciA9IGNvbm5lY3RvcjsKICAgICAgICAgICAgdGhpcy5lcnJvckNhbGxiYWNrID0gZnVuY3Rpb24oZXJyKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoZXJyb3JDYWxsYmFjaykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBlcnJvckNhbGxiYWNrKGVycik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgQWxwYWNhLmRlZmF1bHRFcnJvckNhbGxiYWNrLmNhbGwoc2VsZiwgZXJyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIGNoZWNrIGlmIHRoaXMgZmllbGQgcmVuZGVyaW5nIGlzIHNpbmdsZS1sZXZlbCBvciBub3QKICAgICAgICAgICAgdGhpcy5zaW5nbGVMZXZlbFJlbmRlcmluZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gc2V0IGEgcnVudGltZSB2aWV3CiAgICAgICAgICAgIHRoaXMudmlldyA9IG5ldyBBbHBhY2EuUnVudGltZVZpZXcodmlld0lkLCB0aGlzKTsKCiAgICAgICAgICAgIC8vIHRoaW5ncyB3ZSBjYW4gZHJhdyBvZmYgdGhlIG9wdGlvbnMKICAgICAgICAgICAgdmFyIG5vT3B0aW9ucyA9IGZhbHNlOwogICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucykgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zID0ge307CiAgICAgICAgICAgICAgICBub09wdGlvbnMgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaWQgPSB0aGlzLm9wdGlvbnMuaWQ7CiAgICAgICAgICAgIHRoaXMudHlwZSA9IHRoaXMub3B0aW9ucy50eXBlOwoKICAgICAgICAgICAgLy8gc2V0dXAgZGVmYXVsdHMKICAgICAgICAgICAgaWYgKCF0aGlzLmlkKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlkID0gQWxwYWNhLmdlbmVyYXRlSWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbm9TY2hlbWEgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKCF0aGlzLnNjaGVtYSkgewogICAgICAgICAgICAgICAgdGhpcy5zY2hlbWEgPSB7fTsKICAgICAgICAgICAgICAgIG5vU2NoZW1hID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5sYWJlbCAmJiB0aGlzLnNjaGVtYS50aXRsZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmxhYmVsID0gdGhpcy5zY2hlbWEudGl0bGU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghdGhpcy5vcHRpb25zLmhlbHBlciAmJiB0aGlzLnNjaGVtYS5kZXNjcmlwdGlvbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmhlbHBlciA9IHRoaXMuc2NoZW1hLmRlc2NyaXB0aW9uOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkodGhpcy5vcHRpb25zLnJlYWRvbmx5KSAmJiAhQWxwYWNhLmlzRW1wdHkodGhpcy5zY2hlbWEucmVhZG9ubHkpKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMucmVhZG9ubHkgPSB0aGlzLnNjaGVtYS5yZWFkb25seTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaWYgZGF0YSBpcyBlbXB0eSwgdGhlbiB3ZSBjaGVjayB3aGV0aGVyIHdlIGNhbiBmYWxsIGJhY2sgdG8gYSBkZWZhdWx0IHZhbHVlCiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNWYWxFbXB0eSh0aGlzLmRhdGEpICYmICFBbHBhY2EuaXNFbXB0eSh0aGlzLnNjaGVtYVsiZGVmYXVsdCJdKSkgewogICAgICAgICAgICAgICAgdGhpcy5kYXRhID0gdGhpcy5zY2hlbWFbImRlZmF1bHQiXTsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd2luZ0RlZmF1bHREYXRhID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZGVmYXVsdCBwYXRoCiAgICAgICAgICAgIHRoaXMucGF0aCA9ICIvIjsKCiAgICAgICAgICAgIC8vIHZhbGlkYXRpb24gc3RhdHVzCiAgICAgICAgICAgIHRoaXMudmFsaWRhdGlvbiA9IHt9OwoKICAgICAgICAgICAgLy8gZXZlbnRzCiAgICAgICAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwoKICAgICAgICAgICAgLy8gaGVscGVyIGZ1bmN0aW9uIHRvIGRldGVybWluZSBpZiB3ZSdyZSBpbiBhIGRpc3BsYXktb25seSBtb2RlCiAgICAgICAgICAgIHRoaXMuaXNEaXNwbGF5T25seSA9IGZ1bmN0aW9uKCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIChzZWxmLnZpZXcudHlwZSA9PSAidmlldyIpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gc2NoZW1hIGlkIGNsZWFudXAKICAgICAgICAgICAgaWYgKHRoaXMuc2NoZW1hICYmIHRoaXMuc2NoZW1hLmlkICYmIHRoaXMuc2NoZW1hLmlkLmluZGV4T2YoIiMiKSA9PSAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNjaGVtYS5pZCA9IHRoaXMuc2NoZW1hLmlkLnN1YnN0cmluZygxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaGFzIHRoaXMgZmllbGQgYmVlbiBwcmV2aW91c2x5IHZhbGlkYXRlZD8KICAgICAgICAgICAgdGhpcy5fcHJldmlvdXNseVZhbGlkYXRlZCA9IGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgZGVmYXVsdCBmaWVsZCB0ZW1wbGF0ZSBpZC4gSXQgd291bGQgYmUgImZpZWxkU2V0IiBmb3IgY29udGFpbmVyIGZpZWxkcyBhbmQKICAgICAgICAgKiAiY29udHJvbEZpZWxkIiBmb3Igbm9uZS1jb250YWluZXIgZmllbGRzLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge1N0cmluZ30gRGVmYXVsdCBmaWVsZCB0ZW1wbGF0ZSBpZC4KICAgICAgICAgKi8KICAgICAgICBnZXREZWZhdWx0RmllbGRUZW1wbGF0ZUlkIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gImNvbnRyb2xGaWVsZCI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogU2V0cyB1cCBkZWZhdWx0IHJlbmRpdGlvbiB0ZW1wbGF0ZSBmcm9tIHZpZXcuCiAgICAgICAgICovCiAgICAgICAgc2V0RGVmYXVsdFRlbXBsYXRlRGVzY3JpcHRvcjogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICB2YXIgdmlld1RlbXBsYXRlRGVzY3JpcHRvciA9IHRoaXMudmlldy5nZXRUZW1wbGF0ZURlc2NyaXB0b3IodGhpcy5nZXREZWZhdWx0RmllbGRUZW1wbGF0ZUlkKCkpOwogICAgICAgICAgICB2YXIgZ2xvYmFsVGVtcGxhdGVEZXNjcmlwdG9yID0gdGhpcy52aWV3LmdldEdsb2JhbFRlbXBsYXRlRGVzY3JpcHRvcigpOwogICAgICAgICAgICB2YXIgbGF5b3V0ID0gdGhpcy52aWV3LmdldExheW91dCgpOwoKICAgICAgICAgICAgLy8gd2Ugb25seSBhbGxvdyB0aGUgZ2xvYmFsIG9yIGxheW91dCB0ZW1wbGF0ZSB0byBiZSBhcHBsaWVkIHRvIHRoZSB0b3AtbW9zdCBmaWVsZAogICAgICAgICAgICB2YXIgdHJpcCA9IGZhbHNlOwogICAgICAgICAgICBpZiAoIXRoaXMucGFyZW50KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoZ2xvYmFsVGVtcGxhdGVEZXNjcmlwdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRUZW1wbGF0ZURlc2NyaXB0b3IoZ2xvYmFsVGVtcGxhdGVEZXNjcmlwdG9yKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNpbmdsZUxldmVsUmVuZGVyaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0cmlwID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKGxheW91dCAmJiBsYXlvdXQudGVtcGxhdGVEZXNjcmlwdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRUZW1wbGF0ZURlc2NyaXB0b3IobGF5b3V0LnRlbXBsYXRlRGVzY3JpcHRvcik7CiAgICAgICAgICAgICAgICAgICAgdHJpcCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghdHJpcCAmJiB2aWV3VGVtcGxhdGVEZXNjcmlwdG9yKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNldFRlbXBsYXRlRGVzY3JpcHRvcih2aWV3VGVtcGxhdGVEZXNjcmlwdG9yKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFRoaXMgbWV0aG9kIHdpbGwgYmUgY2FsbGVkIHJpZ2h0IGFmdGVyIHRoZSBmaWVsZCBpbnN0YW5jZSBpcyBjcmVhdGVkLiBJdCB3aWxsIGluaXRpYWxpemUKICAgICAgICAgKiB0aGUgZmllbGQgdG8gZ2V0IGl0IHJlYWR5IGZvciByZW5kaXRpb24uCiAgICAgICAgICovCiAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgaWYgKCF0aGlzLmluaXRpYWxpemluZykgewogICAgICAgICAgICAgICAgdGhpcy5kYXRhID0gdGhpcy5nZXRWYWx1ZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnNldERlZmF1bHRUZW1wbGF0ZURlc2NyaXB0b3IoKTsKCiAgICAgICAgICAgIC8vIEpTT04gU0NIRU1BCiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNVbmRlZmluZWQodGhpcy5zY2hlbWEucmVxdWlyZWQpKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNjaGVtYS5yZXF1aXJlZCA9IGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBWQUxJREFUSU9OCiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNVbmRlZmluZWQodGhpcy5vcHRpb25zLnZhbGlkYXRlKSkgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLnZhbGlkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gT1BUSU9OUwogICAgICAgICAgICBpZiAoQWxwYWNhLmlzVW5kZWZpbmVkKHRoaXMub3B0aW9ucy5kaXNhYmxlZCkpIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBNRVNTQUdFUwogICAgICAgICAgICBpZiAoQWxwYWNhLmlzVW5kZWZpbmVkKHRoaXMub3B0aW9ucy5zaG93TWVzc2FnZXMpKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuc2hvd01lc3NhZ2VzID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJlZ2lzdGVycyBhbiBldmVudCBsaXN0ZW5lci4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBuYW1lCiAgICAgICAgICogQHBhcmFtIGZuCiAgICAgICAgICogQHJldHVybnMgeyp9CiAgICAgICAgICovCiAgICAgICAgb246IGZ1bmN0aW9uKG5hbWUsIGZuKQogICAgICAgIHsKICAgICAgICAgICAgQWxwYWNhLmxvZ0RlYnVnKCJBZGRpbmcgbGlzdGVuZXIgZm9yIGV2ZW50OiAiICsgbmFtZSk7CiAgICAgICAgICAgIHRoaXMuX2V2ZW50c1tuYW1lXSA9IGZuOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBUcmlnZ2VycyBhbiBldmVudCBhbmQgcHJvcGFnYXRlcyB0aGUgZXZlbnQgdXAgdGhlIHBhcmVudCBjaGFpbi4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBuYW1lCiAgICAgICAgICogQHBhcmFtIGV2ZW50CiAgICAgICAgICovCiAgICAgICAgdHJpZ2dlcldpdGhQcm9wYWdhdGlvbjogZnVuY3Rpb24obmFtZSwgZXZlbnQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnRyaWdnZXIuY2FsbCh0aGlzLCBuYW1lLCBldmVudCk7CgogICAgICAgICAgICBpZiAodGhpcy5wYXJlbnQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMucGFyZW50LnRyaWdnZXJXaXRoUHJvcGFnYXRpb24uY2FsbCh0aGlzLnBhcmVudCwgbmFtZSwgZXZlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVHJpZ2dlcnMgYW4gZXZlbnQKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBuYW1lCiAgICAgICAgICogQHBhcmFtIGV2ZW50CiAgICAgICAgICoKICAgICAgICAgKiBSZW1haW5kZXIgb2YgYXJndW1lbnRzIHdpbGwgYmUgcGFzc2VkIHRvIHRoZSBldmVudCBoYW5kbGVyLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge251bGx9CiAgICAgICAgICovCiAgICAgICAgdHJpZ2dlcjogZnVuY3Rpb24obmFtZSwgZXZlbnQpCiAgICAgICAgewogICAgICAgICAgICAvLyBOT1RFOiB0aGlzID09IGNvbnRyb2wKCiAgICAgICAgICAgIHZhciBoYW5kbGVyID0gdGhpcy5fZXZlbnRzW25hbWVdOwoKICAgICAgICAgICAgdmFyIHJldCA9IG51bGw7CiAgICAgICAgICAgIGlmICh0eXBlb2YoaGFuZGxlcikgPT0gImZ1bmN0aW9uIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgQWxwYWNhLmxvZ0RlYnVnKCJGaXJpbmcgZXZlbnQ6ICIgKyBuYW1lKTsKICAgICAgICAgICAgICAgIHRyeQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldCA9IGhhbmRsZXIuY2FsbCh0aGlzLCBldmVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaCAoZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBBbHBhY2EubG9nRGVidWcoIlRoZSBldmVudCBoYW5kbGVyIGNhdWdodCBhbiBleGNlcHRpb246ICIgKyBuYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICogQmluZHMgdGhlIGRhdGEgaW50byB0aGUgZmllbGQuICBDYWxsZWQgYXQgdGhlIHZlcnkgZW5kIG9mIGNvbnN0cnVjdGlvbi4KICAgICAgICAgKi8KICAgICAgICBiaW5kRGF0YTogZnVuY3Rpb24oKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eSh0aGlzLmRhdGEpKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldFZhbHVlKHRoaXMuZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBUaGlzIGlzIHRoZSBlbnRyeSBwb2ludCBtZXRob2QgaW50byB0aGUgZmllbGQuICBJdCBpcyBjYWxsZWQgYnkgQWxwYWNhIGZvciBlYWNoIGZpZWxkIGJlaW5nIHJlbmRlcmVkLgogICAgICAgICAqCiAgICAgICAgICogUmVuZGVycyB0aGlzIGZpZWxkIGludG8gdGhlIGNvbnRhaW5lciBhbmQgY3JlYXRlcyBhIERPTSBlbGVtZW50IHdoaWNoIGlzIGJvdW5kIGludG8gdGhlIGNvbnRhaW5lci4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBWaWV3IHRvIGJlIHVzZWQgZm9yIHJlbmRlcmluZyBmaWVsZCAob3B0aW9uYWwpLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFBvc3QtUmVuZGVyIGNhbGxiYWNrIChvcHRpb25hbCkuCiAgICAgICAgICovCiAgICAgICAgcmVuZGVyOiBmdW5jdGlvbih2aWV3LCBjYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh2aWV3ICYmIChBbHBhY2EuaXNTdHJpbmcodmlldykgfHwgQWxwYWNhLmlzT2JqZWN0KHZpZXcpKSkgewogICAgICAgICAgICAgICAgdGhpcy52aWV3LnNldFZpZXcodmlldyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkoY2FsbGJhY2spICYmIEFscGFjYS5pc0Z1bmN0aW9uKHZpZXcpKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sgPSB2aWV3OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGxhc3QgdHJ5IHRvIHNlZSBpZiB3ZSBjYW4gcG9wdWxhdGUgdGhlIGxhYmVsIGZyb20gcHJvcGVydHlJZAogICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxhYmVsID09PSBudWxsICYmIHRoaXMucHJvcGVydHlJZCkgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmxhYmVsID0gdGhpcy5wcm9wZXJ0eUlkOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBtYWtlIGEgY29weSBvZiBuYW1lIGZpZWxkCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMubmFtZSkgewogICAgICAgICAgICAgICAgdGhpcy5uYW1lID0gdGhpcy5vcHRpb25zLm5hbWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHNldCBkZWZhdWx0IG5hbWUgdmFsdWUgaWYgaXQgaXMgbm90IHByb3ZpZGVkIHRocm91Z2ggb3B0aW9ucy4KICAgICAgICAgICAgaWYgKCF0aGlzLm5hbWUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIGhhcyBwYXRoPwogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFyZW50ICYmIHRoaXMucGFyZW50Lm5hbWUgJiYgdGhpcy5wYXRoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxhc3RTZWdtZW50ID0gdGhpcy5wYXRoLnN1YnN0cmluZyh0aGlzLnBhdGgubGFzdEluZGV4T2YoJy8nKSsxKTsKICAgICAgICAgICAgICAgICAgICBpZiAobGFzdFNlZ21lbnQuaW5kZXhPZigiWyIpICE9IC0xICYmIGxhc3RTZWdtZW50LmluZGV4T2YoIl0iKSAhPSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICBsYXN0U2VnbWVudCA9IGxhc3RTZWdtZW50LnN1YnN0cmluZyhsYXN0U2VnbWVudC5pbmRleE9mKCJbIikgKyAxLCBsYXN0U2VnbWVudC5pbmRleE9mKCJdIikpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAobGFzdFNlZ21lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5uYW1lID0gdGhpcy5wYXJlbnQubmFtZSArICJfIiArIGxhc3RTZWdtZW50OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm5hbWVDYWxjdWxhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhdGgpIHsKICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm5hbWUgPSB0aGlzLnBhdGgucmVwbGFjZSgvXC8vZywiIikucmVwbGFjZSgvXFsvZywiXyIpLnJlcGxhY2UoL1xdL2csIiIpOwogICAgICAgICAgICAgICAgICAgICAgIHRoaXMubmFtZUNhbGN1bGF0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zZXR1cCgpOwoKICAgICAgICAgICAgdGhpcy5fcmVuZGVyKGNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBJbnRlcm5hbCBtZXRob2QgZm9yIHByb2Nlc3NpbmcgdGhlIHJlbmRlci4KICAgICAgICAgKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgUG9zdC1yZW5kZXIgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgX3JlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIC8vIHJlbW92ZSB0aGUgcHJldmlvdXMgb3V0ZXJFbCBpZiBpdCBleGlzdHMKICAgICAgICAgICAgaWYgKHRoaXMuZ2V0RWwoKSkgewogICAgICAgICAgICAgICAgdGhpcy5nZXRFbCgpLnJlbW92ZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBjaGVjayBpZiBpdCBuZWVkcyB0byBiZSB3cmFwcGVkIGluIGEgZm9ybQogICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLnJlbmRlckZvcm0pIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5vcHRpb25zLmZvcm0pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuZm9ybSA9IHt9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmZvcm0udmlld1R5cGUgPSAvKnRoaXMudmlld1R5cGUqL3RoaXMudmlldy50eXBlOwogICAgICAgICAgICAgICAgdmFyIGZvcm0gPSB0aGlzLmZvcm07CiAgICAgICAgICAgICAgICBpZiAoIWZvcm0pIHsKICAgICAgICAgICAgICAgICAgICBmb3JtID0gbmV3IEFscGFjYS5Gb3JtKHRoaXMuY29udGFpbmVyLCB0aGlzLm9wdGlvbnMuZm9ybSwgdGhpcy52aWV3LmlkLCB0aGlzLmNvbm5lY3RvciwgdGhpcy5lcnJvckNhbGxiYWNrKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvcm0ucmVuZGVyKGZ1bmN0aW9uKGZvcm0pIHsKICAgICAgICAgICAgICAgICAgICAvLyBsb2FkIHRoZSBhcHByb3ByaWF0ZSB0ZW1wbGF0ZSBhbmQgcmVuZGVyIGl0CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuX3Byb2Nlc3NSZW5kZXIoZm9ybS5mb3JtRmllbGRzQ29udGFpbmVyLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmluZCBvdXIgZmllbGQgZG9tIGVsZW1lbnQgaW50byB0aGUgY29udGFpbmVyCiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmdldEVsKCkuYXBwZW5kVG8oZm9ybS5mb3JtRmllbGRzQ29udGFpbmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmluZCB0aGUgdG9wIGZpZWxkIHRvIHRoZSBmb3JtCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm0udG9wQ29udHJvbCA9IF90aGlzOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoX3RoaXMudmlldy50eXBlICYmIF90aGlzLnZpZXcudHlwZSAhPSAndmlldycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm0uaW5pdEV2ZW50cygpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmZvcm0gPSBmb3JtOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBhbGxvdyBhbnkgcG9zdC1yZW5kZXJpbmcgZmFjaWxpdGllcyB0byBraWNrIGluCiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnBvc3RSZW5kZXIoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2FsbGJhY2sKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjayAmJiBBbHBhY2EuaXNGdW5jdGlvbihjYWxsYmFjaykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhfdGhpcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gbG9hZCB0aGUgYXBwcm9wcmlhdGUgdGVtcGxhdGUgYW5kIHJlbmRlciBpdAogICAgICAgICAgICAgICAgdGhpcy5fcHJvY2Vzc1JlbmRlcih0aGlzLmNvbnRhaW5lciwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gYmluZCBvdXIgZmllbGQgZG9tIGVsZW1lbnQgaW50byB0aGUgY29udGFpbmVyCiAgICAgICAgICAgICAgICAgICAgX3RoaXMuZ2V0RWwoKS5hcHBlbmRUbyhfdGhpcy5jb250YWluZXIpOwogICAgICAgICAgICAgICAgICAgIC8vIGFsbG93IGFueSBwb3N0LXJlbmRlcmluZyBmYWNpbGl0aWVzIHRvIGtpY2sgaW4KICAgICAgICAgICAgICAgICAgICBfdGhpcy5wb3N0UmVuZGVyKGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2FsbGJhY2sKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrICYmIEFscGFjYS5pc0Z1bmN0aW9uKGNhbGxiYWNrKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soX3RoaXMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBOT1RFOiB0aGlzIGlzIG5vIGxvbmdlciBuZWVkZWQgc2luY2UgYWxsIHRlbXBsYXRlcyBhcmUgY29tcGlsZWQgYW5kIGNhY2hlZCBvbiBpbml0LgogICAgICAgICAqCiAgICAgICAgICogUmVzcG9uc2libGUgZm9yIGZldGNoaW5nIGFueSB0ZW1wbGF0ZXMgbmVlZGVkIHNvIGFzIHRvIHJlbmRlciB0aGUKICAgICAgICAgKiBjdXJyZW50IG1vZGUgZm9yIHRoaXMgZmllbGQuCiAgICAgICAgICoKICAgICAgICAgKiBPbmNlIGNvbXBsZXRlZCwgdGhlIG9uU3VjY2VzcyBtZXRob2QgaXMgY2FsbGVkLgogICAgICAgICAqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwYXJlbnRFbCBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gb25TdWNjZXNzIG9uU3VjY2VzcyBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBfcHJvY2Vzc1JlbmRlcjogZnVuY3Rpb24ocGFyZW50RWwsIG9uU3VjY2VzcykgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgdmFyIHRlbXBsYXRlRGVzY3JpcHRvciA9IHRoaXMuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCk7CgogICAgICAgICAgICAvLyB0aGUgZGF0YSB3ZSdsbCByZW5kZXIKICAgICAgICAgICAgdmFyIHRoZURhdGEgPSB0aGlzLmRhdGE7CiAgICAgICAgICAgIC8vIGlmIHdlJ3JlIGluIGRpc3BsYXktb25seSBtb2RlLCBhbmQgdGhlRGF0YSBpcyBhbiBvYmplY3QsIGNvbnZlcnQgdG8gc3RyaW5nCiAgICAgICAgICAgIGlmICh0aGlzLmlzRGlzcGxheU9ubHkoKSAmJiB0eXBlb2YodGhlRGF0YSkgPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgIHRoZURhdGEgPSBKU09OLnN0cmluZ2lmeSh0aGVEYXRhKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gcmVuZGVyIGZpZWxkIHRlbXBsYXRlCiAgICAgICAgICAgIGlmIChBbHBhY2EuY29sbGVjdFRpbWluZykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHQxID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciByZW5kZXJlZERvbUVsZW1lbnQgPSBfdGhpcy52aWV3LnRtcGwodGVtcGxhdGVEZXNjcmlwdG9yLCB7CiAgICAgICAgICAgICAgICAiaWQiOiB0aGlzLmdldElkKCksCiAgICAgICAgICAgICAgICAib3B0aW9ucyI6IHRoaXMub3B0aW9ucywKICAgICAgICAgICAgICAgICJzY2hlbWEiOiB0aGlzLnNjaGVtYSwKICAgICAgICAgICAgICAgICJkYXRhIjogdGhlRGF0YSwKICAgICAgICAgICAgICAgICJ2aWV3IjogdGhpcy52aWV3LAogICAgICAgICAgICAgICAgInBhdGgiOiB0aGlzLnBhdGgsCiAgICAgICAgICAgICAgICAibmFtZSI6IHRoaXMubmFtZQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChBbHBhY2EuY29sbGVjdFRpbWluZykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHQyID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CgogICAgICAgICAgICAgICAgdmFyIGNvdW50ZXJzID0gQWxwYWNhLkNvdW50ZXJzKCJ0bXBsIik7CiAgICAgICAgICAgICAgICBjb3VudGVycy5pbmNyZW1lbnQodGhpcy50eXBlLCAodDItdDEpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVE9ETzogQWxwYWNhIGN1cnJlbnRseSBhc3N1bWVzIHRoYXQgZXZlcnl0aGluZyB1bmRlciBwYXJlbnRFbCBpcyB0aGUgY29udHJvbCBpdHNlbGYKICAgICAgICAgICAgLy8gdGhlIHdvcmthcm91bmQgZm9yIFRBQkxFIHZpZXcgaXMgdW5hY2NvbW1vZGF0aW5nIHRvd2FyZCB0aGlzCiAgICAgICAgICAgIC8vIGEgY2xpY2sgb24gdGhlIGxhYmVsIGJlaGF2ZXMgbGlrZSBhIGNsaWNrIG9uIHRoZSBjZWxsCiAgICAgICAgICAgIC8vIHRoaXMgbmVlZHMgbW9yZSB3b3JrCiAgICAgICAgICAgIHJlbmRlcmVkRG9tRWxlbWVudC5hcHBlbmRUbyhwYXJlbnRFbCk7CgogICAgICAgICAgICAvLyBpZiB3ZSBnb3QgYmFjayBtdWx0aXBsZSBkb20gZWxlbWVudHMsIHRoZW4gbG9vayBmb3IgdGhlIGRvbSBlbGVtZW50IHdoZXJlICJkYXRhLWNvbnRyb2wiIGhhcyBhIHZhbHVlIG9mCiAgICAgICAgICAgIC8vICAgImFwcGVuZCIgPSBwbGFjZSB0aGUgY29udHJvbCBpbnRvIHRoaXMgZG9tIGVsZW1lbnQKICAgICAgICAgICAgdmFyIG5ld0VsID0gcmVuZGVyZWREb21FbGVtZW50OwogICAgICAgICAgICBpZiAocmVuZGVyZWREb21FbGVtZW50LnNpemUoKSA+IDEpIHsKICAgICAgICAgICAgICAgIHJlbmRlcmVkRG9tRWxlbWVudC5lYWNoKGZ1bmN0aW9uKGssdikgewogICAgICAgICAgICAgICAgICAgIGlmICgkKHRoaXMpLmF0dHIoImRhdGEtY29udHJvbCIpID09ICJhcHBlbmQiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0VsID0gJCh0aGlzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvL3RoaXMuc2V0RWwocmVuZGVyZWREb21FbGVtZW50KTsKICAgICAgICAgICAgdGhpcy5zZXRFbChuZXdFbCk7CgoKICAgICAgICAgICAgLy8vCiAgICAgICAgICAgIC8vIGluIHRoZSBjYXNlIG9mIGEgY29udHJvbCBmaWVsZCwgdGhlIHJlbmRlcmVkRG9tRWxlbWVudCBpcyB0aGUgY29udHJvbCBmaWVsZCByZW5kZXJlZCB1c2luZyB0aGUgdGVtcGxhdGUKICAgICAgICAgICAgLy8gJ3RlbXBsYXRlRGVzY3JpcHRvcicgd2hpY2ggaXMgdGhlIGNvbnRyb2xGaWVsZCB0ZW1wbGF0ZSBmcm9tIHRoZSB2aWV3CiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vIHRoaXMgcmVuZGVyZWREb21FbGVtZW50IHNlcnZpY2VzIGFzIGEgY29udGFpbmVyIGZvciB0aGUgY29udHJvbCBmaWVsZCBpdHNlbGYgd2hpY2ggd2UgY2FuIG5vdyByZW5kZXIgSU5UTwogICAgICAgICAgICAvLyB0aGUgcmVuZGVyZWREb21FbGVtZW50IGlmIHdlIHdhbnQuCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vIGhvd2V2ZXIsIGlmIHdlJ3JlIGluIERJU1BMQVlfT05MWSBtb2RlIChpLmUuIHZpZXcudHlwZSA9PSAidmlldyIpIHRoZW4gdGhlIGNvbnRyb2xGaWVsZCB3aWxsIGhhdmUgYWxyZWFkeQogICAgICAgICAgICAvLyByZW5kZXJlZCBhIHNpbXBsZSB0ZXh0dWFsIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBkYXRhCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vIHRoZXJlZm9yZSwgaWYgd2UncmUgaW4gRElTUExBWV9PTkxZIG1vZGUsIHdlIGRvIG5vdCB3YW50IHRvIHJlbmRlciB0aGUgZmllbGQgY29udHJvbCAod2hpY2ggd291bGQgYmUgc29tZXRoaW5nCiAgICAgICAgICAgIC8vIGxpa2UgYW4gSU5QVVQgZmllbGQpLiAgdGhlcmVmb3JlLCBpZiB3ZSdyZSByZW5kZXJpbmcgYSBjb250cm9sIChsaWtlIGEgdGV4dCBmaWVsZCksIHRoZW4gd2Ugc2hvdWxkIHN0b3Agbm93CiAgICAgICAgICAgIC8vIG90aGVyd2lzZSwgaWYgd2UgYXJlIGEgQ29udGFpbmVyRmllbGQsIHRoZW4gd2UgZG8gd2FudCB0byBjb250aW51ZSBzbyB0aGF0IGFueSBjaGlsZHJlbiBjYW4gcHJvY2VzcwogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBpbiBhZGRpdGlvbiwgaWYgd2UncmUgaW4gc2luZ2xlTGV2ZWxSZW5kZXJpbmcgKGluIHdoaWNoIGNhc2UgdGhlIHRvcCBtb3N0IGdsb2JhbCB0ZW1wbGF0ZSBoYXMgdGFrZW4gY2FyZQogICAgICAgICAgICAvLyBvZiByZW5kZXJpbmcgZXZlcnl0aGluZyksIHRoZW4gd2UgZG8gbm90IHdhbnQgdG8gcmVuZGVyIHRoZSBmaWVsZC4KICAgICAgICAgICAgaWYgKCF0aGlzLnNpbmdsZUxldmVsUmVuZGVyaW5nKSB7CgogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzRGlzcGxheU9ubHkoKSB8fCAoIXRoaXMuaXNDb250cm9sRmllbGQpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyRmllbGQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvblN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uU3VjY2Vzcyh0aGlzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChvblN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb25TdWNjZXNzKHRoaXMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAob25TdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgb25TdWNjZXNzKHRoaXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVuZGVycyBET00gZWxlbWVudHMgZm9yIHRoaXMgZmllbGQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gb25TdWNjZXNzIHtGdW5jdGlvbn0gb25TdWNjZXNzIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIHJlbmRlckZpZWxkOiBmdW5jdGlvbihvblN1Y2Nlc3MpIHsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBBcHBsaWVzIHN0eWxlIGluamVjdGlvbiBmdW5jdGlvbiBmb3IgdGhlIHByb3ZpZGVkIGl0ZW0ga2V5LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIGtleSBpdGVtIGtleSBmb3Igc3R5bGUgaW5qZWN0aW9uCiAgICAgICAgICogQHBhcmFtIHRhcmdldERpdiB0YXJnZXQgRElWIG9mIHN0eWxlIGluamVjdGlvbgogICAgICAgICAqLwogICAgICAgIGdldFN0eWxlSW5qZWN0aW9uOiBmdW5jdGlvbihrZXksdGFyZ2V0RGl2LCBhcmcxLCBhcmcyKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnZpZXcuc3R5bGUgJiYgQWxwYWNhLnN0eWxlSW5qZWN0aW9uc1t0aGlzLnZpZXcuc3R5bGVdICYmIEFscGFjYS5zdHlsZUluamVjdGlvbnNbdGhpcy52aWV3LnN0eWxlXVtrZXldKSB7CiAgICAgICAgICAgICAgICBBbHBhY2Euc3R5bGVJbmplY3Rpb25zW3RoaXMudmlldy5zdHlsZV1ba2V5XS5jYWxsKHRoaXMsdGFyZ2V0RGl2LCBhcmcxLCBhcmcyKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFRoaXMgbWV0aG9kIHdpbGwgYmUgY2FsbGVkIGFmdGVyIHRoZSBmaWVsZCByZW5kaXRpb24gaXMgY29tcGxldGUuIEl0IGlzIHNlcnZlZCBhcyBhIHdheSB0byBtYWtlIGZpbmFsCiAgICAgICAgICogbW9kaWZpY2F0aW9ucyB0byB0aGUgZG9tIGVsZW1lbnRzIHRoYXQgd2VyZSBwcm9kdWNlZC4KICAgICAgICAgKi8KICAgICAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbihjYWxsYmFjaykgewoKICAgICAgICAgICAgLy8gdHJ5IHRvIGF2b2lkIGFkZGluZyB1bm5lY2Vzc2FyeSBpbmplY3Rpb25zIGZvciBkaXNwbGF5IHZpZXcuCiAgICAgICAgICAgIGlmICh0aGlzLnZpZXcudHlwZSAhPSAndmlldycpIHsKCiAgICAgICAgICAgICAgICAvLyBhZGQgY2xhc3NlcwogICAgICAgICAgICAgICAgdGhpcy5nZXRTdHlsZUluamVjdGlvbignZmllbGQnLHRoaXMuZ2V0RWwoKSk7CgogICAgICAgICAgICAgICAgdGhpcy5nZXRFbCgpLmFkZENsYXNzKCJhbHBhY2EtZmllbGQiKTsKCiAgICAgICAgICAgICAgICAvLyBmb3IgZWRpdCBvciBjcmVhdGUgbW9kZQogICAgICAgICAgICAgICAgLy8gaW5qZWN0cyBJZHMKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdldEVsKCkuYXR0cigiaWQiKSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0RWwoKS5hdHRyKCJpZCIsIHRoaXMuZ2V0SWQoKSArICItZmllbGQtb3V0ZXIiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNFbXB0eSh0aGlzLmdldEVsKCkuYXR0cigiYWxwYWNhLWZpZWxkLWlkIikpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRFbCgpLmF0dHIoImFscGFjYS1maWVsZC1pZCIsIHRoaXMuZ2V0SWQoKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBvcHRpb25hbAogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2NoZW1hLnJlcXVpcmVkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRFbCgpLmFkZENsYXNzKCJhbHBhY2EtZmllbGQtcmVxdWlyZWQiKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRFbCgpLmFkZENsYXNzKCJhbHBhY2EtZmllbGQtb3B0aW9uYWwiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyByZWFkb25seQogICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5yZWFkb25seSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0RWwoKS5hZGRDbGFzcygiYWxwYWNhLWZpZWxkLXJlYWRvbmx5Iik7CiAgICAgICAgICAgICAgICAgICAgJCgnOmlucHV0JywgdGhpcy5nZXRFbCgpKS5hdHRyKCdyZWFkb25seScsICdyZWFkb25seScpOwogICAgICAgICAgICAgICAgICAgICQoJ3NlbGVjdCcsIHRoaXMuZ2V0RWwoKSkuYXR0cignZGlzYWJsZWQnLCAnZGlzYWJsZWQnKTsKICAgICAgICAgICAgICAgICAgICAkKCc6cmFkaW8nLCB0aGlzLmdldEVsKCkpLmF0dHIoJ2Rpc2FibGVkJywgJ2Rpc2FibGVkJyk7CiAgICAgICAgICAgICAgICAgICAgJCgnOmNoZWNrYm94JywgdGhpcy5nZXRFbCgpKS5hdHRyKCdkaXNhYmxlZCcsICdkaXNhYmxlZCcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGFsbG93IHNpbmdsZSBvciBtdWx0aXBsZSBmaWVsZCBjbGFzc2VzIHRvIGJlIHNwZWNpZmllZCB2aWEgdGhlICJmaWVsZENsYXNzIgogICAgICAgICAgICAgICAgLy8gb3IgImZpZWxkQ2xhc3NlcyIgb3B0aW9ucwogICAgICAgICAgICAgICAgdmFyIGFwcGx5RmllbGRDbGFzcyA9IGZ1bmN0aW9uKGVsLCB0aGluZykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpbmcpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VucyA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzQXJyYXkodGhpbmcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpbmcubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbC5hZGRDbGFzcyh0aGluZ1tpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpbmcuaW5kZXhPZigiLCIpID4gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbnMgPSB0aGluZy5zcGxpdCgiLCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB0b2tlbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuYWRkQ2xhc3ModG9rZW5zW2ldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaW5nLmluZGV4T2YoIiAiKSA+IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5zID0gdGhpbmcuc3BsaXQoIiAiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLmFkZENsYXNzKHRva2Vuc1tpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuYWRkQ2xhc3ModGhpbmcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGFwcGx5RmllbGRDbGFzcyh0aGlzLmdldEVsKCksIHRoaXMub3B0aW9uc1siZmllbGRDbGFzcyJdKTsKCiAgICAgICAgICAgICAgICAvLyBTdXBwb3J0IGZvciBjdXN0b20gc3R5bGVzIHByb3ZpZGVkIGJ5IGN1c3RvbSB2aWV3CiAgICAgICAgICAgICAgICB2YXIgY3VzdG9tU3R5bGVzID0gdGhpcy52aWV3LmdldFN0eWxlcygpOwoKICAgICAgICAgICAgICAgIGlmIChjdXN0b21TdHlsZXMpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBzdHlsZUNsYXNzIGluIGN1c3RvbVN0eWxlcykgewogICAgICAgICAgICAgICAgICAgICAgICAkKHN0eWxlQ2xhc3MsIHRoaXMuY29udGFpbmVyKS5jc3MoY3VzdG9tU3R5bGVzW3N0eWxlQ2xhc3NdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gYWRkIHJlcXVpcmVkIGZpZWxkIHN0eWxlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5sYWJlbERpdiAmJiB0aGlzLnNjaGVtYS5yZXF1aXJlZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0U3R5bGVJbmplY3Rpb24oJ3JlcXVpcmVkJyx0aGlzLmxhYmVsRGl2KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBhZnRlciByZW5kZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuZGlzYWJsZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc2FibGUoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyB3ZSBiaW5kIGRhdGEgaWYgd2UncmUgaW4gImVkaXQiIG1vZGUKICAgICAgICAgICAgICAgIC8vIHR5cGljYWxseSwgd2UgZG9uJ3QgYmluZCBkYXRhIGlmIHdlJ3JlIGluICJjcmVhdGUiIG9yIGFueSBvdGhlciBtb2RlCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aWV3LnR5cGUgJiYgdGhpcy52aWV3LnR5cGUgPT0gJ2VkaXQnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5iaW5kRGF0YSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5zaG93aW5nRGVmYXVsdERhdGEpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhpcyBjb250cm9sIGlzIHNob3dpbmcgZGVmYXVsdCBkYXRhLCB0aGVuIHdlIHJlbmRlciB0aGUgY29udHJvbCBhbnl3YXkKICAgICAgICAgICAgICAgICAgICB0aGlzLmJpbmREYXRhKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gc29tZSBsb2dnaW5nIHRvIGJlIHVzZWZ1bAogICAgICAgICAgICAgICAgaWYgKHRoaXMudmlldy50eXBlID09ICJjcmVhdGUiKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIEFscGFjYS5sb2dEZWJ1ZygiU2tpcHBpbmcgZGF0YSBiaW5kaW5nIGZvciBmaWVsZDogIiArIHRoaXMuaWQgKyAiIHNpbmNlIHZpZXcgbW9kZSBpcyAnY3JlYXRlJyIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGluaXRpYWxpemUgZG9tLWxldmVsIGV2ZW50cwogICAgICAgICAgICAgICAgaWYgKHRoaXMudmlldy50eXBlICYmIHRoaXMudmlldy50eXBlICE9ICd2aWV3JykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaW5pdEV2ZW50cygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBoaWRkZW4KICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5oaWRkZW4pIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2V0RWwoKS5oaWRlKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGZpbmlzaGVkIGluaXRpYWxpemluZwogICAgICAgICAgICB0aGlzLmluaXRpYWxpemluZyA9IGZhbHNlOwoKICAgICAgICAgICAgdmFyIGRlZmF1bHRIaWRlSW5pdFZhbGlkYXRpb25FcnJvciA9ICh0aGlzLnZpZXcudHlwZSA9PSAnY3JlYXRlJyk7CiAgICAgICAgICAgIHRoaXMuaGlkZUluaXRWYWxpZGF0aW9uRXJyb3IgPSBBbHBhY2EuaXNWYWxFbXB0eSh0aGlzLm9wdGlvbnMuaGlkZUluaXRWYWxpZGF0aW9uRXJyb3IpID8gZGVmYXVsdEhpZGVJbml0VmFsaWRhdGlvbkVycm9yIDogdGhpcy5vcHRpb25zLmhpZGVJbml0VmFsaWRhdGlvbkVycm9yOwoKICAgICAgICAgICAgLy8gZm9yIGNyZWF0ZSB2aWV3LCBoaWRlIGFsbCByZWFkb25seSBmaWVsZHMKICAgICAgICAgICAgaWYgKCF0aGlzLnZpZXcuZGlzcGxheVJlYWRvbmx5KSB7CiAgICAgICAgICAgICAgICAkKCcuYWxwYWNhLWZpZWxkLXJlYWRvbmx5JywgdGhpcy5nZXRFbCgpKS5oaWRlKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGZpZWxkIGxldmVsIHBvc3QgcmVuZGVyCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMucG9zdFJlbmRlcikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLnBvc3RSZW5kZXIuY2FsbCh0aGlzLCBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0cmlldmVzIHRoZSByZW5kZXJlZCBET00gZWxlbWVudC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFRoZSByZW5kZXJlZCBET00gZWxlbWVudC4KICAgICAgICAgKi8KICAgICAgICBnZXRFbDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm91dGVyRWw7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogU2V0cyB0aGUgb3V0ZXIgZWxlbWVudCBvZiB0aGUgRE9NIGVsZW1lbnQgdG8gYmUgcmVuZGVyZWQgYnkgdGhpcyBmaWVsZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBvdXRlckVsIE5ldyBvdXRlciBlbGVtZW50IGZvciB0aGlzIGZpZWxkLgogICAgICAgICAqLwogICAgICAgIHNldEVsOiBmdW5jdGlvbihvdXRlckVsKSB7CiAgICAgICAgICAgIHRoaXMub3V0ZXJFbCA9IG91dGVyRWw7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGUgaWQgb2YgdGhlIGZpZWxkLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMgRmllbGQgaWQuCiAgICAgICAgICovCiAgICAgICAgZ2V0SWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5pZDsKICAgICAgICB9LAoKICAgICAgICAvKiAgICAgICAgZ2V0VHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgIHJldHVybiB0aGlzLnR5cGU7CiAgICAgICAgIH0sKi8KCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGlzIGZpZWxkJ3MgcGFyZW50LgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0FscGFjYS5GaWVsZH0gRmllbGQgcGFyZW50LgogICAgICAgICAqLwogICAgICAgIGdldFBhcmVudDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcmVudDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyBpZiB0aGlzIGZpZWxkIGlzIHRvcCBsZXZlbC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmIHRoaXMgZmllbGQgaXMgdGhlIHRvcCBsZXZlbCBvbmUsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgKi8KICAgICAgICBpc1RvcExldmVsOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5pc0VtcHR5KHRoaXMucGFyZW50KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIHRoZSB2YWx1ZSBvZiB0aGlzIGZpZWxkLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0FueX0gdmFsdWUgRmllbGQgdmFsdWUuCiAgICAgICAgICovCiAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5kYXRhOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFNldHMgdGhlIHZhbHVlIG9mIHRoZSBmaWVsZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7QW55fSB2YWx1ZSBWYWx1ZSB0byBiZSBzZXQuCiAgICAgICAgICovCiAgICAgICAgc2V0VmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMuZGF0YSA9IHZhbHVlOwogICAgICAgICAgICB0aGlzLnRyaWdnZXJVcGRhdGUoKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZXNldHMgdmFsdWUgdG8gZGVmYXVsdC4KICAgICAgICAgKi8KICAgICAgICBzZXREZWZhdWx0OiBmdW5jdGlvbigpIHsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIHRoZSBmaWVsZCB0ZW1wbGF0ZSBkZXNjcmlwdG9yLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gdGVtcGxhdGUgZGVzY3JpcHRvcgogICAgICAgICAqLwogICAgICAgIGdldFRlbXBsYXRlRGVzY3JpcHRvcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnRlbXBsYXRlRGVzY3JpcHRvcjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBTZXRzIHRoZSBmaWVsZCB0ZW1wbGF0ZSBkZXNjcmlwdG9yLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHRlbXBsYXRlIGRlc2NyaXB0b3IKICAgICAgICAgKi8KICAgICAgICBzZXRUZW1wbGF0ZURlc2NyaXB0b3I6IGZ1bmN0aW9uKHRlbXBsYXRlRGVzY3JpcHRvcikgewogICAgICAgICAgICB0aGlzLnRlbXBsYXRlRGVzY3JpcHRvciA9IHRlbXBsYXRlRGVzY3JpcHRvcjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZW5kZXJzIGEgdmFsaWRhdGlvbiBzdGF0ZSBtZXNzYWdlIGJlbG93IHRoZSBmaWVsZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBtZXNzYWdlcyBWYWxpZGF0aW9uIHN0YXRlIG1lc3NhZ2VzLgogICAgICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gYmVmb3JlU3RhdHVzIFByZXZpb3VzIHZhbGlkYXRpb24gc3RhdHVzLgogICAgICAgICAqLwogICAgICAgIGRpc3BsYXlNZXNzYWdlOiBmdW5jdGlvbihtZXNzYWdlcywgYmVmb3JlU3RhdHVzKSB7CgogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgLy8gcmVtb3ZlIHRoZSBtZXNzYWdlIGVsZW1lbnQgaWYgaXQgZXhpc3RzCiAgICAgICAgICAgIF90aGlzLmdldEVsKCkuY2hpbGRyZW4oIi5hbHBhY2EtY29udHJvbGZpZWxkLW1lc3NhZ2UtZWxlbWVudCIpLnJlbW92ZSgpOwoKICAgICAgICAgICAgLy8gYWRkIG1lc3NhZ2UgYW5kIGdlbmVyYXRlIGl0CiAgICAgICAgICAgIGlmIChtZXNzYWdlcyAmJiBtZXNzYWdlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAkLmVhY2gobWVzc2FnZXMsIGZ1bmN0aW9uKGluZGV4LCBtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbWVzc2FnZVRlbXBsYXRlRGVzY3JpcHRvciA9IF90aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJjb250cm9sRmllbGRNZXNzYWdlIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlVGVtcGxhdGVEZXNjcmlwdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5tZXNzYWdlRWxlbWVudCA9IF90aGlzLnZpZXcudG1wbChtZXNzYWdlVGVtcGxhdGVEZXNjcmlwdG9yLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiBtZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmdldFN0eWxlSW5qZWN0aW9uKCdlcnJvck1lc3NhZ2UnLF90aGlzLm1lc3NhZ2VFbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfdGhpcy5oaWRlSW5pdFZhbGlkYXRpb25FcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLm1lc3NhZ2VFbGVtZW50LmFkZENsYXNzKCJhbHBhY2EtY29udHJvbGZpZWxkLW1lc3NhZ2UtaGlkZGVuIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLm1lc3NhZ2VFbGVtZW50LmFkZENsYXNzKCJhbHBhY2EtY29udHJvbGZpZWxkLW1lc3NhZ2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLm1lc3NhZ2VFbGVtZW50LmFkZENsYXNzKCJhbHBhY2EtY29udHJvbGZpZWxkLW1lc3NhZ2UtZWxlbWVudCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMubWVzc2FnZUVsZW1lbnQuYXR0cigiaWQiLCBfdGhpcy5nZXRJZCgpICsgJy1maWVsZC1tZXNzYWdlLScgKyBpbmRleCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjaGVjayB0byBzZWUgaWYgd2UgaGF2ZSBhIG1lc3NhZ2UgY29udGFpbmVyIHJlbmRlcmVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJCgnLmFscGFjYS1jb250cm9sZmllbGQtbWVzc2FnZS1jb250YWluZXInLCBfdGhpcy5nZXRFbCgpKS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5tZXNzYWdlRWxlbWVudC5hcHBlbmRUbygkKCcuYWxwYWNhLWNvbnRyb2xmaWVsZC1tZXNzYWdlLWNvbnRhaW5lcicsIF90aGlzLmdldEVsKCkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMubWVzc2FnZUVsZW1lbnQuYXBwZW5kVG8oX3RoaXMuZ2V0RWwoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmdldFN0eWxlSW5qZWN0aW9uKCdhZGRFcnJvck1lc3NhZ2UnLCBfdGhpcy5nZXRFbCgpLCBtZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEZvcmNlcyB0aGUgdmFsaWRhdGlvbiBmb3IgYSBmaWVsZCB0byBiZSByZWZyZXNoZWQgb3IgcmVkcmF3biB0byB0aGUgc2NyZWVuLgogICAgICAgICAqCiAgICAgICAgICogSWYgdG9sZCB0byBjaGVjayBjaGlsZHJlbiwgdGhlbiBhbGwgY2hpbGRyZW4gb2YgdGhlIGNvbnRhaW5lciBmaWVsZCB3aWxsIGJlIHJlZnJlc2hlZCBhcyB3ZWxsLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtCb29sZWFufSBjaGlsZHJlbiB3aGV0aGVyIHRvIHJlZnJlc2ggY2hpbGRyZW4KICAgICAgICAgKi8KICAgICAgICByZWZyZXNoVmFsaWRhdGlvblN0YXRlOiBmdW5jdGlvbihjaGlsZHJlbikKICAgICAgICB7CiAgICAgICAgICAgIGlmIChjaGlsZHJlbikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGYgPSBmdW5jdGlvbihmaWVsZCwgY29udGV4dHMpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIGZpZWxkIGhhcyBjaGlsZHJlbiwgZ28gZGVwdGggZmlyc3QKICAgICAgICAgICAgICAgICAgICBpZiAoZmllbGQuY2hpbGRyZW4gJiYgZmllbGQuY2hpbGRyZW4ubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZmllbGQuY2hpbGRyZW4ubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaWVsZC5jaGlsZHJlbltpXS5pc1ZhbGlkYXRpb25QYXJ0aWNpcGFudCgpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYoZmllbGQuY2hpbGRyZW5baV0sIGNvbnRleHRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZihjb250ZXh0cykgPT0gIm9iamVjdCIpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb21waWxlIHRoZSB2YWxpZGF0aW9uIGNvbnRleHQgZm9yIHRoaXMgZmllbGQKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSBBbHBhY2EuY29tcGlsZVZhbGlkYXRpb25Db250ZXh0KGZpZWxkKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dHMucHVzaChjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0czsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gcnVuIG9uY2UgdG8gY2F1c2UgZXZlcnl0aGluZyB0byBmbGlwIHRvIGNvcnJlY3Qgc3RhdGUKICAgICAgICAgICAgICAgIC8vZih0aGlzKTsKCiAgICAgICAgICAgICAgICAvLyBydW4gYWdhaW4gdG8gY29sbGVjdCBjb250ZXh0cyAobm90aGluZyBmbGlwcykKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0cyA9IGYodGhpcywgW10pOwoKICAgICAgICAgICAgICAgIC8vIG1lcmdlCiAgICAgICAgICAgICAgICB2YXIgbWVyZ2VkTWFwID0ge307CiAgICAgICAgICAgICAgICB2YXIgbWVyZ2VkQ29udGV4dCA9IFtdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb250ZXh0cy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IGNvbnRleHRzW2ldOwoKICAgICAgICAgICAgICAgICAgICAvLyBOT1RFOiBjb250ZXh0IGlzIGFscmVhZHkgaW4gb3JkZXIgW2NoaWxkLCBwYXJlbnQsIC4uLl0KCiAgICAgICAgICAgICAgICAgICAgdmFyIG1JbmRleCA9IG1lcmdlZENvbnRleHQubGVuZ3RoOwoKICAgICAgICAgICAgICAgICAgICAvLyB3YWxrIGZvcndhcmQKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGNvbnRleHQubGVuZ3RoOyBqKyspCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZW50cnkgPSBjb250ZXh0W2pdOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gbWVyZ2VkTWFwW2VudHJ5LmlkXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFleGlzdGluZykKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8ganVzdCBhZGQgdG8gZW5kCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3RW50cnkgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0VudHJ5LmlkID0gZW50cnkuaWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdFbnRyeS5wYXRoID0gZW50cnkucGF0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0VudHJ5LmNvbnRhaW5lciA9IGVudHJ5LmNvbnRhaW5lcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0VudHJ5LmZpZWxkID0gZW50cnkuZmllbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdFbnRyeS52YWxpZGF0ZWQgPSBlbnRyeS52YWxpZGF0ZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdFbnRyeS5pbnZhbGlkYXRlZCA9IGVudHJ5LmludmFsaWRhdGVkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3RW50cnkudmFsaWQgPSBlbnRyeS52YWxpZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lcmdlZENvbnRleHQuc3BsaWNlKG1JbmRleCwgMCwgbmV3RW50cnkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG1hcmsgaW4gbWFwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXJnZWRNYXBbbmV3RW50cnkuaWRdID0gbmV3RW50cnk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW50cnkudmFsaWRhdGVkICYmICFleGlzdGluZy5pbnZhbGlkYXRlZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZy52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLmludmFsaWRhdGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmcudmFsaWQgPSBlbnRyeS52YWxpZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW50cnkuaW52YWxpZGF0ZWQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuaW52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLnZhbGlkYXRlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLnZhbGlkID0gZW50cnkudmFsaWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gbm93IHJldmVyc2UgaXQgc28gdGhhdCBjb250ZXh0IGlzIG5vcm1hbGl6ZWQgd2l0aCBjaGlsZCBmaWVsZHMgZmlyc3QKICAgICAgICAgICAgICAgIG1lcmdlZENvbnRleHQucmV2ZXJzZSgpOwoKICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSB2YWxpZGF0aW9uIHN0YXRlCiAgICAgICAgICAgICAgICBBbHBhY2EudXBkYXRlVmFsaWRhdGlvblN0YXRlRm9yQ29udGV4dChtZXJnZWRDb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIGp1c3Qgb3Vyc2VsdmVzCgogICAgICAgICAgICAgICAgLy8gY29tcGlsZSB0aGUgdmFsaWRhdGlvbiBjb250ZXh0IGZvciB0aGUgZmllbGQKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gQWxwYWNhLmNvbXBpbGVWYWxpZGF0aW9uQ29udGV4dCh0aGlzKTsKCiAgICAgICAgICAgICAgICAvLyB1cGRhdGUgdGhlIFVJIGZvciB0aGVzZSBjb250ZXh0IGl0ZW1zCiAgICAgICAgICAgICAgICBBbHBhY2EudXBkYXRlVmFsaWRhdGlvblN0YXRlRm9yQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHNob3dIaWRkZW5NZXNzYWdlczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBoaWRkZW5EaXYgPSAkKCcuYWxwYWNhLWZpZWxkLWludmFsaWQtaGlkZGVuJywgdGhpcy5vdXRlckVsKTsKICAgICAgICAgICAgaGlkZGVuRGl2LnJlbW92ZUNsYXNzKCdhbHBhY2EtZmllbGQtaW52YWxpZC1oaWRkZW4nKTsKICAgICAgICAgICAgdGhpcy5nZXRTdHlsZUluamVjdGlvbignZXJyb3InLGhpZGRlbkRpdik7CiAgICAgICAgICAgIGhpZGRlbkRpdi5hZGRDbGFzcygnYWxwYWNhLWZpZWxkLWludmFsaWQnKTsKICAgICAgICAgICAgJCgnLmFscGFjYS1jb250cm9sZmllbGQtbWVzc2FnZS1oaWRkZW4nLCB0aGlzLm91dGVyRWwpLnJlbW92ZUNsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLW1lc3NhZ2UtaGlkZGVuJykuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtbWVzc2FnZScpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlcyB0aGlzIGZpZWxkIGFuZCByZXR1cm5zIHdoZXRoZXIgaXQgaXMgaW4gYSB2YWxpZCBzdGF0ZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBbQm9vbGVhbl0gdmFsaWRhdGVDaGlsZHJlbiB3aGV0aGVyIHRvIGNoaWxkIGNvbnRyb2xzLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgdmFsdWUgb2YgdGhpcyBmaWVsZCBpcyB2YWxpZCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIHZhbGlkYXRlOiBmdW5jdGlvbih2YWxpZGF0ZUNoaWxkcmVuKQogICAgICAgIHsKICAgICAgICAgICAgLy8gc2tpcCBvdXQgaWYgd2UgaGF2ZW4ndCB5ZXQgYm91bmQgYW55IGRhdGEgaW50byB0aGlzIGNvbnRyb2wKICAgICAgICAgICAgLy8gdGhlIGNvbnRyb2wgY2FuIHN0aWxsIGJlIGNvbnNpZGVyZWQgdG8gYmUgaW5pdGlhbGl6aW5nCiAgICAgICAgICAgIHZhciBzdGF0dXMgPSB0cnVlOwoKICAgICAgICAgICAgaWYgKCF0aGlzLmluaXRpYWxpemluZyAmJiB0aGlzLm9wdGlvbnMudmFsaWRhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIGlmIHZhbGlkYXRlQ2hpbGRyZW4sIHRoZW4gd2FsayByZWN1cnNpdmVseSBkb3duIGludG8gY2hpbGQgZWxlbWVudHMKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoaWxkcmVuICYmIHZhbGlkYXRlQ2hpbGRyZW4pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gdGhpcy5jaGlsZHJlbltpXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLmlzVmFsaWRhdGlvblBhcnRpY2lwYW50KCkpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLnZhbGlkYXRlKHZhbGlkYXRlQ2hpbGRyZW4pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGV2YWx1YXRlIG91cnNlbHZlcwogICAgICAgICAgICAgICAgc3RhdHVzID0gdGhpcy5oYW5kbGVWYWxpZGF0ZSgpOwoKICAgICAgICAgICAgICAgIC8vIHN1cHBvcnQgZm9yIHNvbWUgZGVidWdnaW5nCiAgICAgICAgICAgICAgICBpZiAoIXN0YXR1cyAmJiBBbHBhY2EubG9nTGV2ZWwgPT0gQWxwYWNhLkRFQlVHKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIG1lc3NhZ2VzCiAgICAgICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2VzID0gW107CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgbWVzc2FnZUlkIGluIHRoaXMudmFsaWRhdGlvbikKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy52YWxpZGF0aW9uW21lc3NhZ2VJZF1bInN0YXR1cyJdKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlcy5wdXNoKHRoaXMudmFsaWRhdGlvblttZXNzYWdlSWRdWyJtZXNzYWdlIl0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBBbHBhY2EubG9nRGVidWcoIlZhbGlkYXRpb24gZmFpbHVyZSBmb3IgZmllbGQgKGlkPSIgKyB0aGlzLmdldElkKCkgKyAiLCBwYXRoPSIgKyB0aGlzLnBhdGggKyAiKSwgbWVzc2FnZXM6ICIgKyBKU09OLnN0cmluZ2lmeShtZXNzYWdlcykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9wcmV2aW91c2x5VmFsaWRhdGVkID0gdHJ1ZTsKCiAgICAgICAgICAgIHJldHVybiBzdGF0dXM7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUGVyZm9ybXMgdmFsaWRhdGlvbi4KICAgICAgICAgKi8KICAgICAgICBoYW5kbGVWYWxpZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB2YWxJbmZvID0gdGhpcy52YWxpZGF0aW9uOwoKICAgICAgICAgICAgdmFyIHN0YXR1cyA9IHRoaXMuX3ZhbGlkYXRlT3B0aW9uYWwoKTsKICAgICAgICAgICAgdmFsSW5mb1sibm90T3B0aW9uYWwiXSA9IHsKICAgICAgICAgICAgICAgICJtZXNzYWdlIjogc3RhdHVzID8gIiIgOiB0aGlzLnZpZXcuZ2V0TWVzc2FnZSgibm90T3B0aW9uYWwiKSwKICAgICAgICAgICAgICAgICJzdGF0dXMiOiBzdGF0dXMKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHN0YXR1cyA9IHRoaXMuX3ZhbGlkYXRlRGlzYWxsb3coKTsKICAgICAgICAgICAgdmFsSW5mb1siZGlzYWxsb3dWYWx1ZSJdID0gewogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiBzdGF0dXMgPyAiIiA6IEFscGFjYS5zdWJzdGl0dXRlVG9rZW5zKHRoaXMudmlldy5nZXRNZXNzYWdlKCJkaXNhbGxvd1ZhbHVlIiksIFt0aGlzLnNjaGVtYVsiZGlzYWxsb3ciXS5qb2luKCcsJyldKSwKICAgICAgICAgICAgICAgICJzdGF0dXMiOiBzdGF0dXMKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiB2YWxJbmZvWyJub3RPcHRpb25hbCJdWyJzdGF0dXMiXSAmJiB2YWxJbmZvWyJkaXNhbGxvd1ZhbHVlIl1bInN0YXR1cyJdOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlcyB1c2luZyB1c2VyIHByb3ZpZGVkIHZhbGlkYXRvci4KICAgICAgICAgKi8KICAgICAgICBfdmFsaWRhdGVDdXN0b21WYWxpZGF0b3I6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy52YWxpZGF0b3IgJiYgQWxwYWNhLmlzRnVuY3Rpb24odGhpcy5vcHRpb25zLnZhbGlkYXRvcikpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy52YWxpZGF0b3IodGhpcywgZnVuY3Rpb24odmFsSW5mbykgewoKICAgICAgICAgICAgICAgICAgICAvLyBhbHdheXMgc3RvcmUgaW4gImN1c3RvbSIKICAgICAgICAgICAgICAgICAgICBfdGhpcy52YWxpZGF0aW9uWyJjdXN0b20iXSA9IHZhbEluZm87CgogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBWYWxpZGF0ZXMgYWdhaW5zdCByZXF1aXJlZCBwcm9wZXJ0eS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBGYWxzZSBpZiB0aGlzIGZpZWxkIHZhbHVlIGlzIGVtcHR5IGJ1dCByZXF1aXJlZCwgdHJ1ZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgX3ZhbGlkYXRlT3B0aW9uYWw6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5zY2hlbWEucmVxdWlyZWQgJiYgdGhpcy5pc0VtcHR5KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBDaGVja3Mgd2hldGhlciB0aGUgZmllbGQgdmFsdWUgaXMgYWxsb3dlZCBvciBub3QuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZiB0aGUgZmllbGQgdmFsdWUgaXMgYWxsb3dlZCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZURpc2FsbG93OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNWYWxFbXB0eSh0aGlzLnNjaGVtYS5kaXNhbGxvdykpIHsKICAgICAgICAgICAgICAgIHZhciB2YWwgPSB0aGlzLmdldFZhbHVlKCk7CiAgICAgICAgICAgICAgICB2YXIgZGlzYWxsb3cgPSB0aGlzLnNjaGVtYS5kaXNhbGxvdzsKICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNBcnJheShkaXNhbGxvdykpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaXNBbGxvd2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAkLmVhY2goZGlzYWxsb3csIGZ1bmN0aW9uKGluZGV4LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKEFscGFjYS5pc09iamVjdCh2YWwpIHx8IEFscGFjYS5pc0FycmF5KHZhbCkpICYmIEFscGFjYS5pc1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gQWxwYWNhLnBhcnNlSlNPTih2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFscGFjYS5jb21wYXJlT2JqZWN0KHZhbCwgdmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0FsbG93ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBpc0FsbG93ZWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICgoQWxwYWNhLmlzT2JqZWN0KHZhbCkgfHwgQWxwYWNhLmlzQXJyYXkodmFsKSkgJiYgQWxwYWNhLmlzU3RyaW5nKGRpc2FsbG93KSkgewogICAgICAgICAgICAgICAgICAgICAgICBkaXNhbGxvdyA9IEFscGFjYS5wYXJzZUpTT04oZGlzYWxsb3cpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gIUFscGFjYS5jb21wYXJlT2JqZWN0KHZhbCwgZGlzYWxsb3cpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBUcmlnZ2VycyBhbnkgZXZlbnQgaGFuZGxlcnMgdGhhdCBsaXN0ZW5zIHRvIHRoZSB1cGRhdGUgZXZlbnQgb2YgdGhpcyBmaWVsZC4KICAgICAgICAgKi8KICAgICAgICB0cmlnZ2VyVXBkYXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5nZXRFbCgpLnRyaWdnZXIoImZpZWxkdXBkYXRlIik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogRGlzYWJsZXMgdGhlIGZpZWxkLgogICAgICAgICAqLwogICAgICAgIGRpc2FibGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvLyBPVkVSUklERQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEVuYWJsZXMgdGhlIGZpZWxkLgogICAgICAgICAqLwogICAgICAgIGVuYWJsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIC8vIE9WRVJSSURFCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogRm9jdXNlcyBvbiB0aGUgZmllbGQuCiAgICAgICAgICovCiAgICAgICAgZm9jdXM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvLyBPVkVSUklERQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFB1cmdlcyBhbnkgZXZlbnQgbGlzdGVuZXJzIGFuZCByZW1vdmUgdGhpcyBmaWVsZCBmcm9tIHRoZSBET00uCiAgICAgICAgICovCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAvLyBjbGVhbiB1cCBBbHBhY2EuZmllbGRJbnN0YW5jZXMgc3RhdGljIHJlZmVyZW5jZSAodXNlZCBmb3IgY29udmVuaWVuY2UgYWNjZXNzIHRvIHByZXZpb3VzIHJlbmRlcmVkIGZpZWxkcykKICAgICAgICAgICAgaWYgKEFscGFjYSAmJiBBbHBhY2EuZmllbGRJbnN0YW5jZXMpIHsKICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuZmllbGRJbnN0YW5jZXNbdGhpcy5nZXRJZCgpXSkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBBbHBhY2EuZmllbGRJbnN0YW5jZXNbdGhpcy5nZXRJZCgpXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gY2xlYW4gdXAgRE9NCiAgICAgICAgICAgIHRoaXMuZ2V0RWwoKS5yZW1vdmUoKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBTaG93cyB0aGUgZmllbGQuCiAgICAgICAgICovCiAgICAgICAgc2hvdzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMgJiYgdGhpcy5vcHRpb25zLmhpZGRlbikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gaWYgdGhlIGhpZGRlbiBvcHRpb24gaXMgb24sIHdlJ3JlIGFsd2F5cyBoaWRkZW4KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIHNob3cgdGhlIGZpZWxkCiAgICAgICAgICAgICAgICB0aGlzLmdldEVsKCkuY3NzKHsKICAgICAgICAgICAgICAgICAgICAiZGlzcGxheSI6ICIiCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB0aGlzLm9uU2hvdygpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgb25TaG93OiBmdW5jdGlvbigpCiAgICAgICAgewoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBIaWRlcyB0aGUgZmllbGQuCiAgICAgICAgICovCiAgICAgICAgaGlkZTogZnVuY3Rpb24oKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nZXRFbCgpLmNzcyh7CiAgICAgICAgICAgICAgICAiZGlzcGxheSI6ICJub25lIgogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMub25IaWRlKCk7CiAgICAgICAgfSwKCiAgICAgICAgb25IaWRlOiBmdW5jdGlvbigpCiAgICAgICAgewoKICAgICAgICB9LAoKICAgICAgICBpc1ZhbGlkYXRpb25QYXJ0aWNpcGFudDogZnVuY3Rpb24oKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuaXNTaG93bigpOwogICAgICAgIH0sCgogICAgICAgIGlzU2hvd246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5pc1Zpc2libGUoKTsKICAgICAgICB9LAoKICAgICAgICBpc1Zpc2libGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIXRoaXMuaXNIaWRkZW4oKTsKICAgICAgICB9LAoKICAgICAgICBpc0hpZGRlbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAibm9uZSIgPT0gdGhpcy5nZXRFbCgpLmNzcygiZGlzcGxheSIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFByaW50cyB0aGUgZmllbGQuCiAgICAgICAgICovCiAgICAgICAgcHJpbnQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5jb250YWluZXIucHJpbnRBcmVhKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5wcmludEFyZWEoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFRyaWdnZXJlZCB3aGVuIHRoZSBmaWVsZCBpcyBiZWluZyByZXZlYWxlZCBhcyB0aGUgcmVzdWx0IG9mIGEgZGVwZW5kZW5jeSBvciBjb25kaXRpb25hbCBjYWxjdWxhdGlvbgogICAgICAgICAqIHRoYXQgaGFzIGRldGVybWluZWQgdGhhdCB0aGUgZmllbGQgc2hvdWxkIGJlIHNob3duLgogICAgICAgICAqLwogICAgICAgIG9uRGVwZW5kZW50UmV2ZWFsOiBmdW5jdGlvbigpCiAgICAgICAgewoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBUcmlnZ2VyZWQgd2hlbiB0aGUgZmllbGQgaXMgYmVpbmcgY29uY2VhbGVkIGFzIHRoZSByZXN1bHQgb2YgYSBkZXBlbmRlbmN5IG9yIGNvbmRpdGlvbmFsIGNhbGN1bGF0aW9uCiAgICAgICAgICogdGhhdCBoYXMgZGV0ZXJtaW5lZCB0aGF0IHRoZSBmaWVsZCBzaG91bGQgYmUgaGlkZGVuLgogICAgICAgICAqLwogICAgICAgIG9uRGVwZW5kZW50Q29uY2VhbDogZnVuY3Rpb24oKQogICAgICAgIHsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVsb2FkcyB0aGUgZmllbGQuCiAgICAgICAgICovCiAgICAgICAgcmVsb2FkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5pbml0aWFsaXppbmcgPSB0cnVlOwoKICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eSh0aGlzLmNhbGxiYWNrKSkgewogICAgICAgICAgICAgICAgdGhpcy5jYWxsYmFjayh0aGlzLCB0aGlzLnJlbmRlcmVkQ2FsbGJhY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIodGhpcy5yZW5kZXJlZENhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENsZWFycyB0aGUgZmllbGQgYW5kIHJlc2V0cyB0aGUgZmllbGQgdG8gaXRzIG9yaWdpbmFsIHZhbHVlLgogICAgICAgICAqLwogICAgICAgIGNsZWFyOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gbnVsbDsKCiAgICAgICAgICAgIGlmICh0aGlzLmRhdGEpIHsKICAgICAgICAgICAgICAgIG5ld1ZhbHVlID0gdGhpcy5kYXRhOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnNldFZhbHVlKG5ld1ZhbHVlKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyBpZiB0aGUgdmFsdWUgb2YgdGhpcyBmaWVsZCBpcyBlbXB0eS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59IFRydWUgaWYgdGhlIGZpZWxkIHZhbHVlIGlzIGVtcHR5LCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgaXNFbXB0eTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EuaXNWYWxFbXB0eSh0aGlzLmdldFZhbHVlKCkpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEZpbmRzIGlmIHRoaXMgZmllbGQgaXMgdmFsaWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufSBUcnVlIGlmIHRoZSBmaWVsZCBpcyB2YWxpZCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIGlzVmFsaWQ6IGZ1bmN0aW9uKGNoZWNrQ2hpbGRyZW4pIHsKCiAgICAgICAgICAgIGlmIChjaGVja0NoaWxkcmVuICYmIHRoaXMuY2hpbGRyZW4pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IHRoaXMuY2hpbGRyZW5baV07CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLmlzVmFsaWRhdGlvblBhcnRpY2lwYW50KCkpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNoaWxkLmlzVmFsaWQoY2hlY2tDaGlsZHJlbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCQuaXNFbXB0eU9iamVjdCh0aGlzLnZhbGlkYXRpb24pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLnZhbGlkYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMudmFsaWRhdGlvbltrZXldLnN0YXR1cykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBJbml0aWFsaXplcyBldmVudCBoYW5kbGluZy4KICAgICAgICAgKi8KICAgICAgICBpbml0RXZlbnRzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyB0cmlnZ2VyIGNvbnRyb2wgbGV2ZWwgaGFuZGxlcnMgZm9yIHRoaW5ncyB0aGF0IGhhcHBlbiB0byBpbnB1dCBlbGVtZW50CiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLmNoYW5nZShmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMub25DaGFuZ2UuY2FsbChfdGhpcywgZSk7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMudHJpZ2dlcigiY2hhbmdlIiwgZSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLmZvY3VzKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5vbkZvY3VzLmNhbGwoX3RoaXMsIGUpOwogICAgICAgICAgICAgICAgICAgIF90aGlzLnRyaWdnZXIoImZvY3VzIiwgZSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLmJsdXIoZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIF90aGlzLm9uQmx1ci5jYWxsKF90aGlzLCBlKTsKICAgICAgICAgICAgICAgICAgICBfdGhpcy50cmlnZ2VyKCJibHVyIiwgZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMuZmllbGQubW91c2VvdmVyKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5vbk1vdXNlT3Zlci5jYWxsKF90aGlzLCBlKTsKICAgICAgICAgICAgICAgICAgICBfdGhpcy50cmlnZ2VyKCJtb3VzZW92ZXIiLCBlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdGhpcy5maWVsZC5tb3VzZW91dChmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMub25Nb3VzZU91dC5jYWxsKF90aGlzLCBlKTsKICAgICAgICAgICAgICAgICAgICBfdGhpcy50cmlnZ2VyKCJtb3VzZW91dCIsIGUpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgLy8gcmVnaXN0ZXIgZ2VuZXJhbCBldmVudCBoYW5kbGVycyB0aHJvdWdoIG9wdGlvbnMKICAgICAgICAgICAgICAgICQuZWFjaCh0aGlzLm9wdGlvbnMsIGZ1bmN0aW9uKGtleSwgZnVuYykgewogICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2Euc3RhcnRzV2l0aChrZXksJ29uRmllbGQnKSAmJiBBbHBhY2EuaXNGdW5jdGlvbihmdW5jKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSBrZXkuc3Vic3RyaW5nKDcpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmZpZWxkLm9uKGV2ZW50LCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jLmNhbGwoX3RoaXMsZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ2FsbGJhY2sgZm9yIHdoZW4gdGhlIGZpZWxkIHJlY2VpdmVzIGZvY3VzLgogICAgICAgICAqCiAgICAgICAgICogRGVmYXVsdCBiZWhhdmlvciBpcyBmb3IgdGhlIGVudGlyZSBmaWVsZCB0byBoaWdobGlnaHQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gZSBkb20gZXZlbnQKICAgICAgICAgKi8KICAgICAgICBvbkZvY3VzOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHRoaXMuZ2V0RWwoKS5yZW1vdmVDbGFzcygiYWxwYWNhLWZpZWxkLWVtcHR5Iik7CiAgICAgICAgICAgIHRoaXMuZ2V0RWwoKS5hZGRDbGFzcygiYWxwYWNhLWZpZWxkLWZvY3VzZWQiKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBDYWxsYmFjayBmb3Igd2hlbiB0aGUgZmllbGQgbG9zZXMgZm9jdXMgKGJsdXJzKS4KICAgICAgICAgKgogICAgICAgICAqIERlZmF1bHQgYmVoYXZpb3IgaXMgZm9yIHRoZSBlbnRpcmUgZmllbGQgdG8gdW4taGlnaGxpZ2h0LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIGUgZG9tIGV2ZW50CiAgICAgICAgICovCiAgICAgICAgb25CbHVyOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHRoaXMuZ2V0RWwoKS5yZW1vdmVDbGFzcygiYWxwYWNhLWZpZWxkLWZvY3VzZWQiKTsKCiAgICAgICAgICAgIC8vIHVwZGF0ZSB0aGUgVUkgdmFsaWRhdGlvbiBzdGF0ZQogICAgICAgICAgICB0aGlzLnJlZnJlc2hWYWxpZGF0aW9uU3RhdGUoKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBDYWxsYmFjayBmb3Igd2hlbiB0aGUgZmllbGQncyB2YWx1ZSBjaGFuZ2VzLgogICAgICAgICAqCiAgICAgICAgICogRGVmYXVsdCBiZWhhdmlvciBpcyB0byB1cGRhdGUgdGhlIGNvbnRyb2wncyB2YWx1ZSBhbmQgbm90aWZ5LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIGUgRXZlbnQuCiAgICAgICAgICovCiAgICAgICAgb25DaGFuZ2U6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgLy8gc3RvcmUgYmFjayBpbnRvIGRhdGEgZWxlbWVudAogICAgICAgICAgICB0aGlzLmRhdGEgPSB0aGlzLmdldFZhbHVlKCk7CiAgICAgICAgICAgIHRoaXMudHJpZ2dlclVwZGF0ZSgpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENhbGxiYWNrIGZvciB3aGVuIHRoZSBtb3VzZSBtb3ZlcyBvdmVyIGEgZmllbGQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gZQogICAgICAgICAqLwogICAgICAgIG9uTW91c2VPdmVyOiBmdW5jdGlvbihlKSB7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENhbGxiYWNrIGZvciB3aGVuIHRoZSBtb3VzZSBtb3ZlcyBvdXQgb2YgdGhlIGZpZWxkLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIGUKICAgICAgICAgKi8KICAgICAgICBvbk1vdXNlT3V0OiBmdW5jdGlvbihlKSB7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEZpbmRzIGEgZmllbGQgY29udHJvbCBieSBpdHMgcGF0aC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoIEZpZWxkIGNvbnRyb2wgcGF0aC4KICAgICAgICAgKiBAcmV0dXJucyB7QWxwYWNhLkZpZWxkfSBGaWVsZCBjb250cm9sIG1hcHBlZCB0byB0aGUgcGF0aC4KICAgICAgICAgKi8KICAgICAgICBnZXRDb250cm9sQnlQYXRoOiBmdW5jdGlvbihwYXRoKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRDb250cm9sID0gdGhpczsKICAgICAgICAgICAgaWYgKHBhdGgpIHsKICAgICAgICAgICAgICAgIHZhciBwYXRoQXJyYXkgPSBwYXRoLnNwbGl0KCcvJyk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhdGhBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmICghQWxwYWNhLmlzVmFsRW1wdHkocGF0aEFycmF5W2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50Q29udHJvbCAmJiBwYXJlbnRDb250cm9sLmNoaWxkcmVuQnlQcm9wZXJ0eUlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL2NoZWNrIHRvIHNlZSBpZiB3ZSBuZWVkIHRvIGFkZCB0aGUgcHJvcGVydGllcyBmaWVsZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudENvbnRyb2wuY2hpbGRyZW5CeVByb3BlcnR5SWRbcGF0aEFycmF5W2ldXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudENvbnRyb2wgPSBwYXJlbnRDb250cm9sLmNoaWxkcmVuQnlQcm9wZXJ0eUlkW3BhdGhBcnJheVtpXV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50Q29udHJvbDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIFV0aWxpdHkgRnVuY3Rpb25zIGZvciBGb3JtIEJ1aWxkZXIKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIGZpZWxkIHR5cGUuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBGaWVsZCB0eXBlLgogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgc2NoZW1hIGRhdGEgdHlwZS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IFNjaGVtYSBkYXRhIHR5cGUuCiAgICAgICAgICovCiAgICAgICAgZ2V0VHlwZTogZnVuY3Rpb24oKSB7CgogICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyBpZiB0aGlzIGZpZWxkIGlzIGEgY29udGFpbmVyIG9mIG90aGVyIGZpZWxkcy4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmIGl0IGlzIGEgY29udGFpbmVyLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgaXNDb250YWluZXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyBmaWVsZCB0aXRsZS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IEZpZWxkIHRpdGxlLgogICAgICAgICAqLwogICAgICAgIGdldFRpdGxlOiBmdW5jdGlvbigpIHsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyBmaWVsZCBkZXNjcmlwdGlvbi4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IEZpZWxkIGRlc2NyaXB0aW9uLgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyBKU09OIHNjaGVtYSBvZiB0aGUgc2NoZW1hIHByb3BlcnRpZXMgdGhhdCBhcmUgbWFuYWdlZCBieSB0aGlzIGNsYXNzLgogICAgICAgICAqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBKU09OIHNjaGVtYSBvZiB0aGUgc2NoZW1hIHByb3BlcnRpZXMgdGhhdCBhcmUgbWFuYWdlZCBieSB0aGlzIGNsYXNzLgogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mU2NoZW1hOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHNjaGVtYU9mU2NoZW1hID0gewogICAgICAgICAgICAgICAgInRpdGxlIjogdGhpcy5nZXRUaXRsZSgpLAogICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogdGhpcy5nZXREZXNjcmlwdGlvbigpLAogICAgICAgICAgICAgICAgInR5cGUiOiAib2JqZWN0IiwKICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlRpdGxlIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlNob3J0IGRlc2NyaXB0aW9uIG9mIHRoZSBwcm9wZXJ0eS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJEZXNjcmlwdGlvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJEZXRhaWxlZCBkZXNjcmlwdGlvbiBvZiB0aGUgcHJvcGVydHkuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInJlYWRvbmx5IjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiUmVhZG9ubHkiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiUHJvcGVydHkgd2lsbCBiZSByZWFkb25seSBpZiB0cnVlLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJSZXF1aXJlZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJQcm9wZXJ0eSB2YWx1ZSBtdXN0IGJlIHNldCBpZiB0cnVlLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkRlZmF1bHQiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRGVmYXVsdCB2YWx1ZSBvZiB0aGUgcHJvcGVydHkuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYW55IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInR5cGUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJUeXBlIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkRhdGEgdHlwZSBvZiB0aGUgcHJvcGVydHkuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgInJlYWRvbmx5IjogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJEYXRhIGZvcm1hdCBvZiB0aGUgcHJvcGVydHkuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImRpc2FsbG93IjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRGlzYWxsb3dlZCBWYWx1ZXMiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiTGlzdCBvZiBkaXNhbGxvd2VkIHZhbHVlcyBmb3IgdGhlIHByb3BlcnR5LiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImFycmF5IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImRlcGVuZGVuY2llcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkRlcGVuZGVuY2llcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJMaXN0IG9mIHByb3BlcnR5IGRlcGVuZGVuY2llcy4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJhcnJheSIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmICh0aGlzLmdldFR5cGUgJiYgIUFscGFjYS5pc1ZhbEVtcHR5KHRoaXMuZ2V0VHlwZSgpKSkgewogICAgICAgICAgICAgICAgc2NoZW1hT2ZTY2hlbWEucHJvcGVydGllcy50eXBlWydkZWZhdWx0J10gPSB0aGlzLmdldFR5cGUoKTsKICAgICAgICAgICAgICAgIHNjaGVtYU9mU2NoZW1hLnByb3BlcnRpZXMudHlwZVsnZW51bSddID0gW3RoaXMuZ2V0VHlwZSgpXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2NoZW1hT2ZTY2hlbWE7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyBBbHBhY2Egb3B0aW9ucyBmb3IgdGhlIHNjaGVtYSBwcm9wZXJ0aWVzIHRoYXQgbWFuYWdlZCBieSB0aGlzIGNsYXNzLgogICAgICAgICAqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBBbHBhY2Egb3B0aW9ucyBmb3IgdGhlIHNjaGVtYSBwcm9wZXJ0aWVzIHRoYXQgYXJlIG1hbmFnZWQgYnkgdGhpcyBjbGFzcy4KICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yU2NoZW1hOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogewogICAgICAgICAgICAgICAgICAgICAgICAiaGVscGVyIjogIkZpZWxkIHNob3J0IGRlc2NyaXB0aW9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgImhlbHBlciI6ICJGaWVsZCBkZXRhaWxlZCBkZXNjcmlwdGlvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRleHRhcmVhIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInJlYWRvbmx5IjogewogICAgICAgICAgICAgICAgICAgICAgICAiaGVscGVyIjogIkZpZWxkIHdpbGwgYmUgcmVhZCBvbmx5IGlmIGNoZWNrZWQiLAogICAgICAgICAgICAgICAgICAgICAgICAicmlnaHRMYWJlbCI6ICJUaGlzIGZpZWxkIGlzIHJlYWQtb25seSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogewogICAgICAgICAgICAgICAgICAgICAgICAiaGVscGVyIjogIkZpZWxkIHZhbHVlIG11c3QgYmUgc2V0IGlmIGNoZWNrZWQiLAogICAgICAgICAgICAgICAgICAgICAgICAicmlnaHRMYWJlbCI6ICJUaGlzIGZpZWxkIGlzIHJlcXVpcmVkIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiY2hlY2tib3giCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgImhlbHBlciI6ICJGaWVsZCBkZWZhdWx0IHZhbHVlIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dGFyZWEiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAidHlwZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgImhlbHBlciI6ICJGaWVsZCBkYXRhIHR5cGUiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic2VsZWN0IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRhdGFTb3VyY2UiOiBmdW5jdGlvbihmaWVsZCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBBbHBhY2EuZGVmYXVsdEZvcm1hdEZpZWxkTWFwcGluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkLnNlbGVjdE9wdGlvbnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IGtleSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRleHQiOiBrZXkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJkaXNhbGxvdyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgImhlbHBlciI6ICJEaXNhbGxvd2VkIHZhbHVlcyBmb3IgdGhlIGZpZWxkIiwKICAgICAgICAgICAgICAgICAgICAgICAgIml0ZW1MYWJlbCI6IlZhbHVlIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYXJyYXkiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZGVwZW5kZW5jaWVzIjogewogICAgICAgICAgICAgICAgICAgICAgICAiaGVscGVyIjogIkZpZWxkIERlcGVuZGVuY2llcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJtdWx0aXBsZSI6dHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgInNpemUiOjMsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInNlbGVjdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkYXRhU291cmNlIjogZnVuY3Rpb24gKGZpZWxkLCBjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpZWxkLnBhcmVudCAmJiBmaWVsZC5wYXJlbnQuc2NoZW1hUGFyZW50ICYmIGZpZWxkLnBhcmVudC5zY2hlbWFQYXJlbnQucGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGZpZWxkLnBhcmVudC5zY2hlbWFQYXJlbnQucGFyZW50LmNoaWxkcmVuQnlQcm9wZXJ0eUlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkgIT0gZmllbGQucGFyZW50LnNjaGVtYVBhcmVudC5wcm9wZXJ0eUlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZC5zZWxlY3RPcHRpb25zLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IGtleSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGV4dCI6IGtleQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgSlNPTiBzY2hlbWEgb2YgdGhlIEFscGFjYSBvcHRpb25zIHRoYXQgYXJlIG1hbmFnZWQgYnkgdGhpcyBjbGFzcy4KICAgICAgICAgKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gSlNPTiBzY2hlbWEgb2YgdGhlIEFscGFjYSBvcHRpb25zIHRoYXQgYXJlIG1hbmFnZWQgYnkgdGhpcyBjbGFzcy4KICAgICAgICAgKi8KICAgICAgICBnZXRTY2hlbWFPZk9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgc2NoZW1hT2ZPcHRpb25zID0gewogICAgICAgICAgICAgICAgInRpdGxlIjogIk9wdGlvbnMgZm9yICIgKyB0aGlzLmdldFRpdGxlKCksCiAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiB0aGlzLmdldERlc2NyaXB0aW9uKCkgKyAiIChPcHRpb25zKSIsCiAgICAgICAgICAgICAgICAidHlwZSI6ICJvYmplY3QiLAogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgInJlbmRlckZvcm0iOiB7fSwKICAgICAgICAgICAgICAgICAgICAiZm9ybSI6e30sCiAgICAgICAgICAgICAgICAgICAgImlkIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRmllbGQgSWQiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiVW5pcXVlIGZpZWxkIGlkLiBBdXRvLWdlbmVyYXRlZCBpZiBub3QgcHJvdmlkZWQuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInR5cGUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJGaWVsZCBUeXBlIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkZpZWxkIHR5cGUuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiB0aGlzLmdldEZpZWxkVHlwZSgpLAogICAgICAgICAgICAgICAgICAgICAgICAicmVhZG9ubHkiOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAidmFsaWRhdGUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJWYWxpZGF0aW9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkZpZWxkIHZhbGlkYXRpb24gaXMgcmVxdWlyZWQgaWYgdHJ1ZS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAic2hvd01lc3NhZ2VzIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiU2hvdyBNZXNzYWdlcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJEaXNwbGF5IHZhbGlkYXRpb24gbWVzc2FnZXMgaWYgdHJ1ZS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZGlzYWJsZWQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJEaXNhYmxlZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJGaWVsZCB3aWxsIGJlIGRpc2FibGVkIGlmIHRydWUuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogZmFsc2UKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJyZWFkb25seSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlJlYWRvbmx5IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkZpZWxkIHdpbGwgYmUgcmVhZG9ubHkgaWYgdHJ1ZS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiBmYWxzZQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImhpZGRlbiI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkhpZGRlbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJGaWVsZCB3aWxsIGJlIGhpZGRlbiBpZiB0cnVlLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAibGFiZWwiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJMYWJlbCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJGaWVsZCBsYWJlbC4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiaGVscGVyIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiSGVscGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkZpZWxkIGhlbHAgbWVzc2FnZS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZmllbGRDbGFzcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkNTUyBjbGFzcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJTcGVjaWZpZXMgb25lIG9yIG1vcmUgQ1NTIGNsYXNzZXMgdGhhdCBzaG91bGQgYmUgYXBwbGllZCB0byB0aGUgZG9tIGVsZW1lbnQgZm9yIHRoaXMgZmllbGQgb25jZSBpdCBpcyByZW5kZXJlZC4gIFN1cHBvcnRzIGEgc2luZ2xlIHZhbHVlLCBjb21tYS1kZWxpbWl0ZWQgdmFsdWVzLCBzcGFjZS1kZWxpbWl0ZWQgdmFsdWVzIG9yIHZhbHVlcyBwYXNzZWQgaW4gYXMgYW4gYXJyYXkuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImhpZGVJbml0VmFsaWRhdGlvbkVycm9yIiA6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkhpZGUgSW5pdGlhbCBWYWxpZGF0aW9uIEVycm9ycyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiIgOiAiSGlkZSBpbml0aWFsIHZhbGlkYXRpb24gZXJyb3JzIGlmIHRydWUuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogZmFsc2UKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJmb2N1cyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZvY3VzIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIklmIHRydWUsIHRoZSBpbml0aWFsIGZvY3VzIGZvciB0aGUgZm9ybSB3aWxsIGJlIHNldCB0byB0aGUgZmlyc3QgY2hpbGQgZWxlbWVudCAodXN1YWxseSB0aGUgZmlyc3QgZmllbGQgaW4gdGhlIGZvcm0pLiAgSWYgYSBmaWVsZCBuYW1lIG9yIHBhdGggaXMgcHJvdmlkZWQsIHRoZW4gdGhlIHNwZWNpZmllZCBjaGlsZCBmaWVsZCB3aWxsIHJlY2VpdmUgZm9jdXMuICBGb3IgZXhhbXBsZSwgeW91IG1pZ2h0IHNldCBmb2N1cyB0byAnbmFtZScgKHNlbGVjdGluZyB0aGUgJ25hbWUnIGZpZWxkKSBvciB5b3UgbWlnaHQgc2V0IGl0IHRvICdjbGllbnQvbmFtZScgd2hpY2ggcGlja3MgdGhlICduYW1lJyBmaWVsZCBvbiB0aGUgJ2NsaWVudCcgb2JqZWN0LiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAib3B0aW9uTGFiZWxzIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRW51bWVyYXRlZCBWYWx1ZSBMYWJlbHMiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiQW4gYXJyYXkgb2Ygc3RyaW5nIGxhYmVscyBmb3IgaXRlbXMgaW4gdGhlIGVudW0gYXJyYXkiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJhcnJheSIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmICh0aGlzLmlzVG9wTGV2ZWwoKSkgewogICAgICAgICAgICAgICAgc2NoZW1hT2ZPcHRpb25zLnByb3BlcnRpZXMucmVuZGVyRm9ybSA9IHsKICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiUmVuZGVyIEZvcm0iLAogICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJSZW5kZXIgYSBGT1JNIHRhZyBhcyB0aGUgY29udGFpbmVyIGZvciB0aGUgcmVzdCBvZiBmaWVsZHMgaWYgdHJ1ZS4iLAogICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogZmFsc2UKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgc2NoZW1hT2ZPcHRpb25zLnByb3BlcnRpZXMuZm9ybSA9IHsKICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRm9ybSIsCiAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIk9wdGlvbnMgZm9yIHJlbmRlcmluZyB0aGUgRk9STSB0YWcuIiwKICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJvYmplY3QiLAogICAgICAgICAgICAgICAgICAgICJkZXBlbmRlbmNpZXMiIDogInJlbmRlckZvcm0iLAogICAgICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICAgICAiYXR0cmlidXRlcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJGb3JtIEF0dHJpYnV0ZXMiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkxpc3Qgb2YgYXR0cmlidXRlcyBmb3IgdGhlIEZPUk0gdGFnLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJvYmplY3QiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImlkIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiSWQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiVW5pcXVlIGZvcm0gaWQuIEF1dG8tZ2VuZXJhdGVkIGlmIG5vdCBwcm92aWRlZC4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiYWN0aW9uIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiQWN0aW9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkZvcm0gc3VibWlzc2lvbiBlbmRwb2ludCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZXRob2QiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJNZXRob2QiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRm9ybSBzdWJtaXNzaW9uIG1ldGhvZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJlbnVtIjpbInBvc3QiLCJnZXQiXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCgkJCQkicnVieXJhaWxzIjogewoJCQkJICAgICJ0aXRsZSI6ICJSdWJ5IE9uIFJhaWxzIiwKCQkJCSAgICAiZGVzY3JpcHRpb24iOiAiUnVieSBvbiBSYWlscyBOYW1lIFN0YW5kYXJkIiwKCQkJCSAgICAiZW51bSI6IFsidHJ1ZSIsICJmYWxzZSJdLAoJCQkJICAgICJ0eXBlIjogInN0cmluZyIKCQkJCX0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJOYW1lIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkZvcm0gbmFtZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJmb2N1cyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZvY3VzIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkZvY3VzIFNldHRpbmciLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJhbnkiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAiYnV0dG9ucyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJGb3JtIEJ1dHRvbnMiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkNvbmZpZ3VyYXRpb24gZm9yIGZvcm0tYm91bmQgYnV0dG9ucyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJvYmplY3QiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInN1Ym1pdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAib2JqZWN0IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlN1Ym1pdCBCdXR0b24iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInJlc2V0IjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJvYmplY3QiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiUmVzZXQgYnV0dG9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogZmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICJ0b2dnbGVTdWJtaXRWYWxpZFN0YXRlIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlRvZ2dsZSBTdWJtaXQgVmFsaWQgU3RhdGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlRvZ2dsZSB0aGUgdmFsaWRpdHkgc3RhdGUgb2YgdGhlIFN1Ym1pdCBidXR0b24iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlIHNjaGVtYU9mT3B0aW9ucy5wcm9wZXJ0aWVzLnJlbmRlckZvcm07CiAgICAgICAgICAgICAgICBkZWxldGUgc2NoZW1hT2ZPcHRpb25zLnByb3BlcnRpZXMuZm9ybTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHNjaGVtYU9mT3B0aW9uczsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIEFscGFjYSBvcHRpb25zIGZvciB0aGUgQWxwYWNhIG9wdGlvbnMgdGhhdCBhcmUgbWFuYWdlZCBieSB0aGlzIGNsYXNzLgogICAgICAgICAqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBBbHBhY2Egb3B0aW9ucyBmb3IgdGhlIEFscGFjYSBvcHRpb25zIHRoYXQgYXJlIG1hbmFnZWQgYnkgdGhpcyBjbGFzcy4KICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBvcHRpb25zRm9yT3B0aW9ucyA9IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogIm9iamVjdCIsCiAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICJpZCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJyZWFkb25seSI6IHRydWUKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJ0eXBlIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInZhbGlkYXRlIjogewogICAgICAgICAgICAgICAgICAgICAgICAicmlnaHRMYWJlbCI6ICJFbmZvcmNlIHZhbGlkYXRpb24iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJzaG93TWVzc2FnZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJyaWdodExhYmVsIjoiU2hvdyB2YWxpZGF0aW9uIG1lc3NhZ2VzIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiY2hlY2tib3giCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZGlzYWJsZWQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJyaWdodExhYmVsIjoiRGlzYWJsZSB0aGlzIGZpZWxkIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiY2hlY2tib3giCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiaGlkZGVuIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJyaWdodExhYmVsIjogIkhpZGUgdGhpcyBmaWVsZCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJsYWJlbCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJoZWxwZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRleHRhcmVhIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImZpZWxkQ2xhc3MiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRleHQiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiaGlkZUluaXRWYWxpZGF0aW9uRXJyb3IiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJyaWdodExhYmVsIjogIkhpZGUgaW5pdGlhbCB2YWxpZGF0aW9uIGVycm9ycyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImZvY3VzIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJyaWdodExhYmVsIjogIkF1dG8tZm9jdXMgZmlyc3QgY2hpbGQgZmllbGQiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAib3B0aW9uTGFiZWxzIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJhcnJheSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJpdGVtcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKHRoaXMuaXNUb3BMZXZlbCgpKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zRm9yT3B0aW9ucy5maWVsZHMucmVuZGVyRm9ybSA9IHsKICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIsCiAgICAgICAgICAgICAgICAgICAgInJpZ2h0TGFiZWwiOiAiWWVzIgogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIG9wdGlvbnNGb3JPcHRpb25zLmZpZWxkcy5mb3JtID0gewogICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm9iamVjdCIsCiAgICAgICAgICAgICAgICAgICAgImRlcGVuZGVuY2llcyIgOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJyZW5kZXJGb3JtIiA6IHRydWUKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJhdHRyaWJ1dGVzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAib2JqZWN0IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImlkIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInJlYWRvbmx5IjogdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImFjdGlvbiI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZXRob2QiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInNlbGVjdCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJuYW1lIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBvcHRpb25zRm9yT3B0aW9uczsKICAgICAgICB9Ly9fX0VORF9PRl9CVUlMREVSX0hFTFBFUlMKICAgIH0pOwoKICAgIC8vIFJlZ2lzdGVycyBhZGRpdGlvbmFsIG1lc3NhZ2VzCiAgICBBbHBhY2EucmVnaXN0ZXJNZXNzYWdlcyh7CiAgICAgICAgImRpc2FsbG93VmFsdWUiOiAiezB9IGFyZSBkaXNhbGxvd2VkIHZhbHVlcy4iLAogICAgICAgICJub3RPcHRpb25hbCI6ICJUaGlzIGZpZWxkIGlzIG5vdCBvcHRpb25hbC4iCiAgICB9KTsKCn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5Db250cm9sRmllbGQgPSBBbHBhY2EuRmllbGQuZXh0ZW5kKAogICAgLyoqCiAgICAgKiBAbGVuZHMgQWxwYWNhLkNvbnRyb2xGaWVsZC5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5GaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIEFic3RyYWN0IGJhc2UgY2xhc3MgZm9yIEFscGFjYSBub24tY29udGFpbmVyIEZpZWxkcy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CgogICAgICAgICAgICAvLyB0YWcgdG8gZmxhZyB0aGF0IHRoaXMgaXMgYSBjb250cm9sIGZpZWxkCiAgICAgICAgICAgIC8vIHVzZWQgYnkgRmllbGQgYmFzZSBjbGFzcyB0byBkZXRlcm1pbmUgd2hldGhlciB0byB0cmF2ZXJzZSBpbnRvIHRoaXMgZHVyaW5nIGEgZGlzcGxheS1vbmx5IHJlbmRlcmluZwogICAgICAgICAgICB0aGlzLmlzQ29udHJvbEZpZWxkID0gdHJ1ZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNzZXREZWZhdWx0CiAgICAgICAgICovCiAgICAgICAgc2V0RGVmYXVsdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBkZWZhdWx0RGF0YSA9IEFscGFjYS5pc0VtcHR5KHRoaXMuc2NoZW1hWydkZWZhdWx0J10pID8gIiIgOiB0aGlzLnNjaGVtYVsnZGVmYXVsdCddOwogICAgICAgICAgICB0aGlzLnNldFZhbHVlKGRlZmF1bHREYXRhKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNyZW5kZXJGaWVsZAogICAgICAgICAqLwogICAgICAgIHJlbmRlckZpZWxkOiBmdW5jdGlvbihvblN1Y2Nlc3MpIHsKICAgICAgICAgICAgaWYgKG9uU3VjY2VzcykgewogICAgICAgICAgICAgICAgb25TdWNjZXNzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBJbmplY3RzIEZpZWxkIEVsZW1lbnQgaW50byBpdHMgY29udGFpbmVyLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGVsZW1lbnQgRmllbGQgZWxlbWVudCB0byBiZSBpbmplY3RlZC4KICAgICAgICAgKi8KICAgICAgICBpbmplY3RGaWVsZDogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICAvLyBmaW5kIG91dCB0aGUgZmllbGQgY29udGFpbmVyCiAgICAgICAgICAgIHZhciBjb250YWluZXJFbGVtID0gJCgnLmFscGFjYS1jb250cm9sZmllbGQtY29udGFpbmVyJywgdGhpcy5vdXRlckVsKTsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lckVsZW0ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkQ29udGFpbmVyID0gY29udGFpbmVyRWxlbTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZmllbGRDb250YWluZXIgPSB0aGlzLm91dGVyRWw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gbm93IGZpZ3VyZSBvdXQgd2hlcmUgZXhhY3RseSB3ZSB3YW50IHRvIGluc2VydCBpdAogICAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9ICQoJy5hbHBhY2EtZmllbGQtY29udGFpbmVyLWZpZWxkJywgdGhpcy5maWVsZENvbnRhaW5lcik7CiAgICAgICAgICAgIGlmIChwYXJlbnROb2RlLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGlmIChwYXJlbnROb2RlLmF0dHIoJ2RhdGEtcmVwbGFjZScpID09ICd0cnVlJykgewogICAgICAgICAgICAgICAgICAgIHBhcmVudE5vZGUucmVwbGFjZVdpdGgoZWxlbWVudCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kVG8ocGFyZW50Tm9kZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5maWVsZENvbnRhaW5lci5hdHRyKCdkYXRhLXJlcGxhY2UnKSA9PSAndHJ1ZScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZpZWxkQ29udGFpbmVyLnJlcGxhY2VXaXRoKGVsZW1lbnQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnByZXBlbmRUbyh0aGlzLmZpZWxkQ29udGFpbmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI3Bvc3RSZW5kZXIKICAgICAgICAgKi8KICAgICAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbihjYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHZhciBsYWJlbERpdiA9ICQoJy5hbHBhY2EtY29udHJvbGZpZWxkLWxhYmVsJywgdGhpcy5vdXRlckVsKTsKICAgICAgICAgICAgaWYgKGxhYmVsRGl2Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgdGhpcy5sYWJlbERpdiA9IGxhYmVsRGl2OwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgaGVscGVyRGl2ID0gJCgnLmFscGFjYS1jb250cm9sZmllbGQtaGVscGVyJywgdGhpcy5vdXRlckVsKTsKICAgICAgICAgICAgaWYgKGhlbHBlckRpdi5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGVscGVyRGl2ID0gaGVscGVyRGl2OwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgLy8gYWRkIGFkZGl0aW9uYWwgY2xhc3NlcwogICAgICAgICAgICAgICAgc2VsZi5vdXRlckVsLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkJyk7CgogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlIGFnYWluc3QgZW51bSBwcm9wZXJ0eS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmIHRoZSBlbGVtZW50IHZhbHVlIGlzIHBhcnQgb2YgdGhlIGVudW0gbGlzdCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZUVudW06IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5zY2hlbWFbImVudW0iXSkgewogICAgICAgICAgICAgICAgdmFyIHZhbCA9IHRoaXMuZGF0YTsKICAgICAgICAgICAgICAgIC8qdGhpcy5nZXRWYWx1ZSgpOyovCiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuc2NoZW1hLnJlcXVpcmVkICYmIEFscGFjYS5pc1ZhbEVtcHR5KHZhbCkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgkLmluQXJyYXkodmFsLCB0aGlzLnNjaGVtYVsiZW51bSJdKSA+IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjaGFuZGxlVmFsaWRhdGUKICAgICAgICAgKi8KICAgICAgICBoYW5kbGVWYWxpZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBiYXNlU3RhdHVzID0gdGhpcy5iYXNlKCk7CgogICAgICAgICAgICB2YXIgdmFsSW5mbyA9IHRoaXMudmFsaWRhdGlvbjsKCiAgICAgICAgICAgIHZhciBzdGF0dXMgPSB0aGlzLl92YWxpZGF0ZUVudW0oKTsKICAgICAgICAgICAgdmFsSW5mb1siaW52YWxpZFZhbHVlT2ZFbnVtIl0gPSB7CiAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHN0YXR1cyA/ICIiIDogQWxwYWNhLnN1YnN0aXR1dGVUb2tlbnModGhpcy52aWV3LmdldE1lc3NhZ2UoImludmFsaWRWYWx1ZU9mRW51bSIpLCBbdGhpcy5zY2hlbWFbImVudW0iXS5qb2luKCcsJyldKSwKICAgICAgICAgICAgICAgICJzdGF0dXMiOiBzdGF0dXMKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBiYXNlU3RhdHVzICYmIHZhbEluZm9bImludmFsaWRWYWx1ZU9mRW51bSJdWyJzdGF0dXMiXTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNpbml0RXZlbnRzCiAgICAgICAgICovCiAgICAgICAgaW5pdEV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLmtleXByZXNzKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5vbktleVByZXNzLmNhbGwoX3RoaXMsIGUpOwogICAgICAgICAgICAgICAgICAgIF90aGlzLnRyaWdnZXIoImtleXByZXNzIiwgZSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLmtleXVwKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5vbktleVVwLmNhbGwoX3RoaXMsIGUpOwogICAgICAgICAgICAgICAgICAgIF90aGlzLnRyaWdnZXIoImtleXVwIiwgZSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLmtleWRvd24oZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIF90aGlzLm9uS2V5RG93bi5jYWxsKF90aGlzLCBlKTsKICAgICAgICAgICAgICAgICAgICBfdGhpcy50cmlnZ2VyKCJrZXlkb3duIiwgZSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLmNsaWNrKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5vbkNsaWNrLmNhbGwoX3RoaXMsIGUpOwogICAgICAgICAgICAgICAgICAgIF90aGlzLnRyaWdnZXIoImNsaWNrIiwgZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBDYWxsYmFjayBmb3Igd2hlbiBhIGtleSBwcmVzcyBldmVudCBpcyByZWNlaXZlZCBmb3IgdGhlIGZpZWxkIGNvbnRyb2wuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZSBrZXlwcmVzcyBldmVudAogICAgICAgICAqLwogICAgICAgIG9uS2V5UHJlc3M6IGZ1bmN0aW9uKGUpIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIC8vIGlmIHRoZSBmaWVsZCBpcyBjdXJyZW50bHkgaW52YWxpZCwgdGhlbiB3ZSBwcm92aWRlIGVhcmx5IGZlZWRiYWNrIHRvIHRoZSB1c2VyIGFzIHRvIHdoZW4gdGhleSBlbnRlcgogICAgICAgICAgICAvLyBpZiB0aGUgZmllbGQgd2FzIHZhbGlkLCB3ZSBkb24ndCByZW5kZXIgaW52YWxpZGF0aW9uIGZlZWRiYWNrIHVudGlsIHRoZXkgYmx1ciB0aGUgZmllbGQKCiAgICAgICAgICAgIC8vIHdhcyB0aGUgY29udHJvbCB2YWxpZCBwcmV2aW91c2x5PwogICAgICAgICAgICB2YXIgd2FzVmFsaWQgPSB0aGlzLmlzVmFsaWQoKTsKICAgICAgICAgICAgaWYgKCF3YXNWYWxpZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8KICAgICAgICAgICAgICAgIC8vIHdlIHVzZSBhIHRpbWVvdXQgYmVjYXVzZSBhdCB0aGlzIGV4YWN0IG1vbWVudCwgdGhlIHZhbHVlIG9mIHRoZSBjb250cm9sIGlzIHN0aWxsIHRoZSBvbGQgdmFsdWUKICAgICAgICAgICAgICAgIC8vIGpRdWVyeSByYWlzZXMgdGhlIGtleXByZXNzIGV2ZW50IGFoZWFkIG9mIHRoZSBpbnB1dCByZWNlaXZpbmcgdGhlIG5ldyBkYXRhIHdoaWNoIHdvdWxkIGluY29ycG9yYXRlCiAgICAgICAgICAgICAgICAvLyB0aGUga2V5IHRoYXQgd2FzIHByZXNzZWQKICAgICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgICAvLyB0aGlzIHRpbWVvdXQgcHJvdmlkZXMgdGhlIGJyb3dzZXIgd2l0aCBlbm91Z2ggdGltZSB0byBwbHVnIHRoZSB2YWx1ZSBpbnRvIHRoZSBpbnB1dCBjb250cm9sCiAgICAgICAgICAgICAgICAvLyB3aGljaCB0aGUgdmFsaWRhdGlvbiBsb2dpYyB1c2VzIHRvIGRldGVybWluZSB3aGV0aGVyIHRoZSBjb250cm9sIGlzIG5vdyBpbiBhIHZhbGlkIHN0YXRlCiAgICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5yZWZyZXNoVmFsaWRhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgICB9LCA1MCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ2FsbGJhY2sgZm9yIHdoZW4gYSBrZXkgZG93biBldmVudCBpcyByZWNlaXZlZCBmb3IgdGhlIGZpZWxkIGNvbnRyb2wuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZSBrZXlkb3duIGV2ZW50CiAgICAgICAgICovCiAgICAgICAgb25LZXlEb3duOiBmdW5jdGlvbihlKSB7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENhbGxiYWNrIGZvciB3aGVuIGEga2V5IHVwIGV2ZW50IGlzIHJlY2VpdmVkIGZvciB0aGUgZmllbGQgY29udHJvbC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBlIGtleXVwIGV2ZW50CiAgICAgICAgICovCiAgICAgICAgb25LZXlVcDogZnVuY3Rpb24oZSkgewoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBIYW5kbGVyIGZvciBjbGljayBldmVudC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBlIENsaWNrIGV2ZW50LgogICAgICAgICAqLwogICAgICAgIG9uQ2xpY2s6IGZ1bmN0aW9uKGUpIHsKICAgICAgICB9LC8vX19CVUlMREVSX0hFTFBFUlMKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRTY2hlbWFPZlNjaGVtYQogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mU2NoZW1hOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgImVudW0iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJFbnVtZXJhdGVkIFZhbHVlcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJMaXN0IG9mIHNwZWNpZmljIHZhbHVlcyBmb3IgdGhpcyBwcm9wZXJ0eSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImFycmF5IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRPcHRpb25zRm9yU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0ZvclNjaGVtYTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgImVudW0iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJpdGVtTGFiZWwiOiJWYWx1ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImFycmF5IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRTY2hlbWFPZk9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRTY2hlbWFPZk9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAibmFtZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZpZWxkIE5hbWUiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRmllbGQgTmFtZS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldE9wdGlvbnNGb3JPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0Zvck9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICJuYW1lIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKCiAgICAvLyBSZWdpc3RlcnMgYWRkaXRpb25hbCBtZXNzYWdlcwogICAgQWxwYWNhLnJlZ2lzdGVyTWVzc2FnZXMoewogICAgICAgICJpbnZhbGlkVmFsdWVPZkVudW0iOiAiVGhpcyBmaWVsZCBzaG91bGQgaGF2ZSBvbmUgb2YgdGhlIHZhbHVlcyBpbiB7MH0uIgogICAgfSk7Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuQ29udGFpbmVyRmllbGQgPSBBbHBhY2EuRmllbGQuZXh0ZW5kKAoKICAgICAgICAvKioKICAgICAgICAgKiBAbGVuZHMgQWxwYWNhLkNvbnRhaW5lckZpZWxkLnByb3RvdHlwZQogICAgICAgICAqLwogICAgICAgIHsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuRmllbGQKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGNsYXNzIEFic3RyYWN0IGNvbnRhaW5lciBmaWVsZCBmb3IgcGFyZW50aW5nIG9mIGNoaWxkIGZpZWxkcy4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQ3VzdG9tIGZpZWxkIGltcGxlbWVudGF0aW9uIHNob3VsZCBleHRlbmQgdGhpcyBpZiB0aGV5IGludGVuZCB0byBiZSBjb250YWluZXJzIG9mIHN1Yi1jb250cm9scyAtCiAgICAgICAgICAgICAqIGV4YW1wbGVzIGluY2x1ZGUgdHJlZSBjb250cm9scywgbGlzdCBjb250cm9scyBhbmQgbW9yZS4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNzZXR1cAogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGhpcy5iYXNlKCk7CgogICAgICAgICAgICAgICAgdmFyIGNvbGxhcHNpYmxlID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc0VtcHR5KHRoaXMudmlldy5jb2xsYXBzaWJsZSkpIHsKICAgICAgICAgICAgICAgICAgICBjb2xsYXBzaWJsZSA9IHRoaXMudmlldy5jb2xsYXBzaWJsZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc0VtcHR5KHRoaXMub3B0aW9ucy5jb2xsYXBzaWJsZSkpIHsKICAgICAgICAgICAgICAgICAgICBjb2xsYXBzaWJsZSA9IHRoaXMub3B0aW9ucy5jb2xsYXBzaWJsZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuY29sbGFwc2libGUgPSBjb2xsYXBzaWJsZTsKCiAgICAgICAgICAgICAgICB2YXIgbGVnZW5kU3R5bGUgPSAiYnV0dG9uIjsKCiAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc0VtcHR5KHRoaXMudmlldy5sZWdlbmRTdHlsZSkpIHsKICAgICAgICAgICAgICAgICAgICBsZWdlbmRTdHlsZSA9IHRoaXMudmlldy5sZWdlbmRTdHlsZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc0VtcHR5KHRoaXMub3B0aW9ucy5sZWdlbmRTdHlsZSkpIHsKICAgICAgICAgICAgICAgICAgICBsZWdlbmRTdHlsZSA9IHRoaXMub3B0aW9ucy5sZWdlbmRTdHlsZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMubGVnZW5kU3R5bGUgPSBsZWdlbmRTdHlsZTsKCiAgICAgICAgICAgICAgICAvL0xhenkgbG9hZGluZwogICAgICAgICAgICAgICAgdGhpcy5sYXp5TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eSh0aGlzLm9wdGlvbnMubGF6eUxvYWRpbmcpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sYXp5TG9hZGluZyA9IHRoaXMub3B0aW9ucy5sYXp5TG9hZGluZzsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5sYXp5TG9hZGluZykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuY29sbGFwc2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy9kZWxldGUgdGhpcy5vcHRpb25zLmxhenlMb2FkaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gaG9sZGVycyBvZiByZWZlcmVuY2VzIHRvIGNoaWxkcmVuCiAgICAgICAgICAgICAgICB0aGlzLmNoaWxkcmVuID0gW107CiAgICAgICAgICAgICAgICB0aGlzLmNoaWxkcmVuQnlJZCA9IFtdOwogICAgICAgICAgICAgICAgdGhpcy5jaGlsZHJlbkJ5UHJvcGVydHlJZCA9IFtdOwogICAgICAgICAgICAgICAgLy8gc3R5bGUgaWNvbnMKICAgICAgICAgICAgICAgIHRoaXMuZXhwYW5kZWRJY29uID0gIiI7CiAgICAgICAgICAgICAgICB0aGlzLmNvbGxhcHNlZEljb24gPSAiIjsKICAgICAgICAgICAgICAgIHRoaXMuY29tbW9uSWNvbiA9ICIiOwogICAgICAgICAgICAgICAgdGhpcy5hZGRJY29uID0gIiI7CiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUljb24gPSAiIjsKICAgICAgICAgICAgICAgIHRoaXMudXBJY29uID0gIiI7CiAgICAgICAgICAgICAgICB0aGlzLmRvd25JY29uID0gIiI7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aWV3LnN0eWxlICYmIEFscGFjYS5zdHlsZUluamVjdGlvbnNbdGhpcy52aWV3LnN0eWxlXSkgewogICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2Euc3R5bGVJbmplY3Rpb25zW3RoaXMudmlldy5zdHlsZV1bImNvbW1vbkljb24iXSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbW1vbkljb24gPSBBbHBhY2Euc3R5bGVJbmplY3Rpb25zW3RoaXMudmlldy5zdHlsZV1bImNvbW1vbkljb24iXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKEFscGFjYS5zdHlsZUluamVjdGlvbnNbdGhpcy52aWV3LnN0eWxlXVsiY29udGFpbmVyRXhwYW5kZWRJY29uIl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5leHBhbmRlZEljb24gPSBBbHBhY2Euc3R5bGVJbmplY3Rpb25zW3RoaXMudmlldy5zdHlsZV1bImNvbnRhaW5lckV4cGFuZGVkSWNvbiJdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLnN0eWxlSW5qZWN0aW9uc1t0aGlzLnZpZXcuc3R5bGVdWyJjb250YWluZXJDb2xsYXBzZWRJY29uIl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xsYXBzZWRJY29uID0gQWxwYWNhLnN0eWxlSW5qZWN0aW9uc1t0aGlzLnZpZXcuc3R5bGVdWyJjb250YWluZXJDb2xsYXBzZWRJY29uIl07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2Euc3R5bGVJbmplY3Rpb25zW3RoaXMudmlldy5zdHlsZV1bImJ1dHRvbkJlYXV0aWZpZXIiXSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmJ1dHRvbkJlYXV0aWZpZXIgPSBBbHBhY2Euc3R5bGVJbmplY3Rpb25zW3RoaXMudmlldy5zdHlsZV1bImJ1dHRvbkJlYXV0aWZpZXIiXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKEFscGFjYS5zdHlsZUluamVjdGlvbnNbdGhpcy52aWV3LnN0eWxlXVsiYWRkSWNvbiJdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkSWNvbiA9IEFscGFjYS5zdHlsZUluamVjdGlvbnNbdGhpcy52aWV3LnN0eWxlXVsiYWRkSWNvbiJdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLnN0eWxlSW5qZWN0aW9uc1t0aGlzLnZpZXcuc3R5bGVdWyJyZW1vdmVJY29uIl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVJY29uID0gQWxwYWNhLnN0eWxlSW5qZWN0aW9uc1t0aGlzLnZpZXcuc3R5bGVdWyJyZW1vdmVJY29uIl07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2Euc3R5bGVJbmplY3Rpb25zW3RoaXMudmlldy5zdHlsZV1bInVwSWNvbiJdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXBJY29uID0gQWxwYWNhLnN0eWxlSW5qZWN0aW9uc1t0aGlzLnZpZXcuc3R5bGVdWyJ1cEljb24iXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKEFscGFjYS5zdHlsZUluamVjdGlvbnNbdGhpcy52aWV3LnN0eWxlXVsiZG93bkljb24iXSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRvd25JY29uID0gQWxwYWNhLnN0eWxlSW5qZWN0aW9uc1t0aGlzLnZpZXcuc3R5bGVdWyJkb3duSWNvbiJdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXREZWZhdWx0RmllbGRUZW1wbGF0ZUlkCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBnZXREZWZhdWx0RmllbGRUZW1wbGF0ZUlkIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuICJmaWVsZFNldCI7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjc2V0RGVmYXVsdFRlbXBsYXRlRGVzY3JpcHRvcgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc2V0RGVmYXVsdFRlbXBsYXRlRGVzY3JpcHRvcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJhc2UoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBIZWxwZXIgbWV0aG9kIHRvIGFkZCBjaGlsZCBmaWVsZC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29udHJvbH0gY2hpbGQgQ2hpbGQgZmllbGQgdG8gYmUgYWRkZWQuCiAgICAgICAgICAgICAqIEBwYXJhbSB7SW50ZWdlcn0gaW5kZXggSW5kZXggb2YgdGhlIG5ldyBjaGlsZC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGFkZENoaWxkOiBmdW5jdGlvbihjaGlsZCwgaW5kZXgpIHsKICAgICAgICAgICAgICAgIGlmICghQWxwYWNhLmlzRW1wdHkoaW5kZXgpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGlsZHJlbi5zcGxpY2UoaW5kZXgsIDAsIGNoaWxkKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGlsZHJlbi5wdXNoKGNoaWxkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuY2hpbGRyZW5CeUlkW2NoaWxkLmdldElkKCldID0gY2hpbGQ7CiAgICAgICAgICAgICAgICBpZiAoY2hpbGQucHJvcGVydHlJZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2hpbGRyZW5CeVByb3BlcnR5SWRbY2hpbGQucHJvcGVydHlJZF0gPSBjaGlsZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoaWxkLnBhcmVudCA9IHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjaW5pdEV2ZW50cwogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaW5pdEV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgICAgIC8vIGlmIGNvbGxhcHNpYmxlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5sYWJlbERpdikgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuY29sbGFwc2libGUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGFiZWxEaXYuYWRkQ2xhc3MoImxlZ2VuZC1leHBhbmRlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZpZWxkU2V0RGl2LmFkZENsYXNzKCJmaWVsZHNldC1leHBhbmRlZCIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGluaXRJY29uID0gdGhpcy5leHBhbmRlZEljb247CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc0VtcHR5KHRoaXMub3B0aW9ucy5jb2xsYXBzZWQpICYmIHRoaXMub3B0aW9ucy5jb2xsYXBzZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluaXRJY29uID0gdGhpcy5jb2xsYXBzZWRJY29uOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sYWJlbERpdi5uZXh0QWxsKCIuYWxwYWNhLWZpZWxkc2V0LWhlbHBlciIpLnNsaWRlVG9nZ2xlKDUwMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxhYmVsRGl2Lm5leHRBbGwoIi5hbHBhY2EtZmllbGRzZXQtaXRlbXMtY29udGFpbmVyIikuc2xpZGVUb2dnbGUoNTAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGFiZWxEaXYubmV4dEFsbCgiLmFscGFjYS1maWVsZHNldC1hcnJheS10b29sYmFyIikuc2xpZGVUb2dnbGUoNTAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGRTZXREaXYudG9nZ2xlQ2xhc3MoImZpZWxkc2V0LWV4cGFuZGVkIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZpZWxkU2V0RGl2LnRvZ2dsZUNsYXNzKCJmaWVsZHNldC1jb2xsYXBzZWQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGFiZWxEaXYudG9nZ2xlQ2xhc3MoImxlZ2VuZC1leHBhbmRlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sYWJlbERpdi50b2dnbGVDbGFzcygibGVnZW5kLWNvbGxhcHNlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxlZ2VuZFN0eWxlID09ICdsaW5rJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnPHNwYW4gY2xhc3M9IicgKyB0aGlzLmNvbW1vbkljb24gKyAiICIgKyBpbml0SWNvbiArICcgYWxwYWNhLWZpZWxkc2V0LWxlZ2VuZC1saW5rIj48L3NwYW4+JykucHJlcGVuZFRvKHRoaXMubGFiZWxEaXYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sYWJlbERpdi5jbGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5maWVsZFNldERpdi50b2dnbGVDbGFzcygiZmllbGRzZXQtY29sbGFwc2VkIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuZmllbGRTZXREaXYudG9nZ2xlQ2xhc3MoImZpZWxkc2V0LWV4cGFuZGVkIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS50b2dnbGVDbGFzcygibGVnZW5kLWNvbGxhcHNlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykudG9nZ2xlQ2xhc3MoImxlZ2VuZC1leHBhbmRlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJy5hbHBhY2EtZmllbGRzZXQtbGVnZW5kLWxpbmsnLCB0aGlzKS50b2dnbGVDbGFzcyhfdGhpcy5jb2xsYXBzZWRJY29uKS50b2dnbGVDbGFzcyhfdGhpcy5leHBhbmRlZEljb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykubmV4dEFsbCgiLmFscGFjYS1maWVsZHNldC1oZWxwZXIiKS5zbGlkZVRvZ2dsZSg1MDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykubmV4dEFsbCgiLmFscGFjYS1maWVsZHNldC1pdGVtcy1jb250YWluZXIiKS5zbGlkZVRvZ2dsZSg1MDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykubmV4dEFsbCgiLmFscGFjYS1maWVsZHNldC1hcnJheS10b29sYmFyIikuc2xpZGVUb2dnbGUoNTAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxlZ2VuZFN0eWxlID09ICdidXR0b24nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5idXR0b25CZWF1dGlmaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5idXR0b25CZWF1dGlmaWVyLmNhbGwodGhpcywgdGhpcy5sYWJlbERpdiwgaW5pdEljb24sIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGFiZWxEaXYuY2xpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuZmllbGRTZXREaXYudG9nZ2xlQ2xhc3MoImZpZWxkc2V0LWNvbGxhcHNlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmZpZWxkU2V0RGl2LnRvZ2dsZUNsYXNzKCJmaWVsZHNldC1leHBhbmRlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykudG9nZ2xlQ2xhc3MoImxlZ2VuZC1jb2xsYXBzZWQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLnRvZ2dsZUNsYXNzKCJsZWdlbmQtZXhwYW5kZWQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcuYWxwYWNhLWZpZWxkc2V0LWxlZ2VuZC1idXR0b24nLCB0aGlzKS50b2dnbGVDbGFzcyhfdGhpcy5jb2xsYXBzZWRJY29uKS50b2dnbGVDbGFzcyhfdGhpcy5leHBhbmRlZEljb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykubmV4dEFsbCgiLmFscGFjYS1maWVsZHNldC1oZWxwZXIiKS5zbGlkZVRvZ2dsZSg1MDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykubmV4dEFsbCgiLmFscGFjYS1maWVsZHNldC1pdGVtcy1jb250YWluZXIiKS5zbGlkZVRvZ2dsZSg1MDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykubmV4dEFsbCgiLmFscGFjYS1maWVsZHNldC1hcnJheS10b29sYmFyIikuc2xpZGVUb2dnbGUoNTAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIENsZWFycyB0aGUgZmllbGQgYW5kIHJlc2V0cyB0aGUgZmllbGQgdG8gaXRzIG9yaWdpbmFsIHZhbHVlLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0gc3RvcFVwZGF0ZVRyaWdnZXIgSWYgZmFsc2UsIHRyaWdnZXJzIHRoZSB1cGRhdGUgZXZlbnQgb2YgdGhpcyBldmVudC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGNsZWFyOiBmdW5jdGlvbihzdG9wVXBkYXRlVHJpZ2dlcikgewogICAgICAgICAgICAgICAgLy8gY2xlYXIgYWxsIHRoZSBraWRkaWVzCiAgICAgICAgICAgICAgICBBbHBhY2EuZWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNsZWFyKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIHRyaWdnZXIgdXBkYXRlIGFsbCBhdCBvbmNlCiAgICAgICAgICAgICAgICBpZiAoIXN0b3BVcGRhdGVUcmlnZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyVXBkYXRlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjc2V0RGVmYXVsdAogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc2V0RGVmYXVsdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkodGhpcy5zY2hlbWFbJ2RlZmF1bHQnXSkpIHsKICAgICAgICAgICAgICAgICAgICBBbHBhY2EuZWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUodGhpcy5zY2hlbWFbJ2RlZmF1bHQnXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZGVzdHJveQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgLy8gaWYgdGhpcyBjb250YWluZXIgaXMgRE9NLXdyYXBwZWQgd2l0aCBhIGZvcm0sIHRoZW4gcmVsZWFzZSB0aGUgZm9ybQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZm9ybSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZm9ybS5kZXN0cm95KHRydWUpOyAvLyBwYXNzIGluIHRydWUgc28gdGhhdCB3ZSBkb24ndCBjYWxsIGJhY2sgcmVjdXJzaXZlbHkKICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5mb3JtOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGRlc3Ryb3kgYW55IGNoaWxkIGNvbnRyb2xzCiAgICAgICAgICAgICAgICBBbHBhY2EuZWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIGNhbGwgdXAgdG8gYmFzZSBtZXRob2QKICAgICAgICAgICAgICAgIHRoaXMuYmFzZSgpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIFJlbmRlcnMgY2hpbGQgaXRlbSBjb250YWluZXIuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7SW50ZWdlcn0gaW5zZXJ0QWZ0ZXJJZCBJbnNlcnRpb24gcG9pbnQgZm9yIHRoZSBjb250YWluZXIuCiAgICAgICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbnRyb2x9IHBhcmVudCBQYXJlbnQgZmllbGQuCiAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eUlkIENoaWxkIGl0ZW0gcHJvcGVydHkgSUQuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICByZW5kZXJJdGVtQ29udGFpbmVyOiBmdW5jdGlvbihpbnNlcnRBZnRlcklkLCBwYXJlbnQsIHByb3BlcnR5SWQpIHsKICAgICAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICAgICAgdmFyIGl0ZW1Db250YWluZXJUZW1wbGF0ZURlc2NyaXB0b3IgPSB0aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJmaWVsZFNldEl0ZW1Db250YWluZXIiKTsKICAgICAgICAgICAgICAgIGlmIChpdGVtQ29udGFpbmVyVGVtcGxhdGVEZXNjcmlwdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRhaW5lckVsZW0gPSBfdGhpcy52aWV3LnRtcGwoaXRlbUNvbnRhaW5lclRlbXBsYXRlRGVzY3JpcHRvciwge30pOwogICAgICAgICAgICAgICAgICAgIGlmIChjb250YWluZXJFbGVtLmF0dHIoJ2RhdGEtcmVwbGFjZScpID09ICd0cnVlJykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5maWVsZENvbnRhaW5lcjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zZXJ0QWZ0ZXJJZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnIycgKyBpbnNlcnRBZnRlcklkICsgJy1pdGVtLWNvbnRhaW5lcicsIHRoaXMub3V0ZXJFbCkuYWZ0ZXIoY29udGFpbmVyRWxlbSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFwcGVuZFRvQ29udGFpbmVyID0gdGhpcy5maWVsZENvbnRhaW5lcjsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYmluZGluZ3MgPSB0aGlzLnZpZXcuZ2V0TGF5b3V0KCkuYmluZGluZ3M7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYmluZGluZyA9IGJpbmRpbmdzW3Byb3BlcnR5SWRdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nICYmICQoJyMnICsgYmluZGluZywgYXBwZW5kVG9Db250YWluZXIpLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwZW5kVG9Db250YWluZXIgPSAkKCcjJyArIGJpbmRpbmcsIGFwcGVuZFRvQ29udGFpbmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXJFbGVtLmFwcGVuZFRvKGFwcGVuZFRvQ29udGFpbmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29udGFpbmVyRWxlbTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmllbGRDb250YWluZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjcmVuZGVyRmllbGQKICAgICAgICAgICAgICovCiAgICAgICAgICAgIHJlbmRlckZpZWxkOiBmdW5jdGlvbihvblN1Y2Nlc3MpIHsKCiAgICAgICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgICAgIHRoaXMuZ2V0U3R5bGVJbmplY3Rpb24oImNvbnRhaW5lciIsIHRoaXMub3V0ZXJFbCk7CgogICAgICAgICAgICAgICAgdmFyIGxhYmVsRGl2ID0gJCgnLmFscGFjYS1maWVsZHNldC1sZWdlbmQnLCB0aGlzLm91dGVyRWwpOwoKICAgICAgICAgICAgICAgIGlmIChsYWJlbERpdi5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmxhYmVsRGl2ID0gbGFiZWxEaXY7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMub3V0ZXJFbC5hZGRDbGFzcygnYWxwYWNhLWZpZWxkc2V0LW5vLWxlZ2VuZCcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBmaWVsZFNldERpdiA9ICQoJy5hbHBhY2EtZmllbGRzZXQnLCB0aGlzLm91dGVyRWwpOwoKICAgICAgICAgICAgICAgIGlmIChmaWVsZFNldERpdi5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZpZWxkU2V0RGl2ID0gZmllbGRTZXREaXY7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGRTZXREaXYgPSB0aGlzLm91dGVyRWw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIGZpZWxkQ29udGFpbmVyID0gJCgnLmFscGFjYS1maWVsZHNldC1pdGVtcy1jb250YWluZXInLCB0aGlzLm91dGVyRWwpOwogICAgICAgICAgICAgICAgaWYgKGZpZWxkQ29udGFpbmVyLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGRDb250YWluZXIgPSBmaWVsZENvbnRhaW5lcjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5maWVsZENvbnRhaW5lciA9IHRoaXMub3V0ZXJFbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgYXN5bmNIYW5kbGVyID0gZmFsc2U7CgogICAgICAgICAgICAgICAgaWYgKCF0aGlzLnNpbmdsZUxldmVsUmVuZGVyaW5nICYmICF0aGlzLmxhenlMb2FkaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgYXN5bmNIYW5kbGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlckl0ZW1zKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAob25TdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvblN1Y2Nlc3MoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmxhenlMb2FkaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubGFiZWxEaXYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXN5bmNIYW5kbGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzLmxhYmVsRGl2KS5jbGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfdGhpcy5sYXp5TG9hZGluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnJlbmRlckl0ZW1zKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5sYXp5TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob25TdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvblN1Y2Nlc3MoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCFhc3luY0hhbmRsZXIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9uU3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgICAgICBvblN1Y2Nlc3MoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogUHJvcGFnYXRlcyBzaWduYWwgZG93biB0byBhbGwgY2hpbGRyZW4uCiAgICAgICAgICAgICAqIEBvdmVycmlkZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgb25EZXBlbmRlbnRSZXZlYWw6IGZ1bmN0aW9uKCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2hpbGRyZW5baV0ub25EZXBlbmRlbnRSZXZlYWwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBQcm9wYWdhdGVzIHNpZ25hbCBkb3duIHRvIGFsbCBjaGlsZHJlbi4KICAgICAgICAgICAgICogQG92ZXJyaWRlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBvbkRlcGVuZGVudENvbmNlYWw6IGZ1bmN0aW9uKCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2hpbGRyZW5baV0ub25EZXBlbmRlbnRDb25jZWFsKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogUmVuZGVycyBhbGwgY2hpbGQgaXRlbXMgb2YgdGhpcyBmaWVsZC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIG9uU3VjY2VzcyBvblN1Y2Nlc3MgY2FsbGJhY2suCiAgICAgICAgICAgICAqLwogICAgICAgICAgICByZW5kZXJJdGVtczogZnVuY3Rpb24ob25TdWNjZXNzKSB7CiAgICAgICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2lzQ29udGFpbmVyCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBpc0NvbnRhaW5lcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRTY2hlbWFPZk9wdGlvbnMKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldFNjaGVtYU9mT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJsYXp5TG9hZGluZyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJMYXp5IExvYWRpbmciLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkNoaWxkIGZpZWxkcyB3aWxsIG9ubHkgYmUgcmVuZGVyZWQgd2hlbiB0aGUgZmllbGRzZXQgaXMgZXhwYW5kZWQgaWYgdGhpcyBvcHRpb24gaXMgc2V0IHRydWUuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiBmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAiY29sbGFwc2libGUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiQ29sbGFwc2libGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkZpZWxkIHNldCBpcyBjb2xsYXBzaWJsZSBpZiB0cnVlLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAiY29sbGFwc2VkIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkNvbGxhcHNlZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRmllbGQgc2V0IGlzIGluaXRpYWxseSBjb2xsYXBzZWQgaWYgdHJ1ZS4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICJsZWdlbmRTdHlsZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJMZWdlbmQgU3R5bGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkZpZWxkIHNldCBsZWdlbmQgc3R5bGUuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZW51bSI6WyJidXR0b24iLCJsaW5rIl0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6ICJidXR0b24iCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRPcHRpb25zRm9yT3B0aW9ucwogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZ2V0T3B0aW9uc0Zvck9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJsYXp5TG9hZGluZyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJyaWdodExhYmVsIjogIkxhenkgbG9hZGluZyBjaGlsZCBmaWVsZHMgPyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaGVscGVyIjogIkxhenkgbG9hZGluZyB3aWxsIGJlIGVuYWJsZWQgaWYgY2hlY2tlZC4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiY2hlY2tib3giCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICJjb2xsYXBzaWJsZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJyaWdodExhYmVsIjogIkZpZWxkIHNldCBjb2xsYXBzaWJsZSA/IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJoZWxwZXIiOiAiRmllbGQgc2V0IGlzIGNvbGxhcHNpYmxlIGlmIGNoZWNrZWQuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IgogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAiY29sbGFwc2VkIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInJpZ2h0TGFiZWwiOiAiRmllbGQgc2V0IGluaXRpYWxseSBjb2xsYXBzZWQgPyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRmllbGQgc2V0IGlzIGluaXRpYWxseSBjb2xsYXBzZWQgaWYgY2hlY2tlZC4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiY2hlY2tib3giCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICJsZWdlbmRTdHlsZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjoic2VsZWN0IgogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgICAgIH0pOwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkNvbm5lY3RvciA9IEJhc2UuZXh0ZW5kKAogICAgLyoqCiAgICAgKiBAbGVuZHMgQWxwYWNhLkNvbm5lY3Rvci5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGNsYXNzIENvbm5lY3RzIEFscGFjYSB0byByZW1vdGUgZGF0YSBzdG9yZXMuCgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBpZCBDb25uZWN0b3IgSUQuCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGlkKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5pZCA9IGlkOwoKICAgICAgICAgICAgLy8gaGVscGVyIGZ1bmN0aW9uIHRvIGRldGVybWluZSBpZiBhIHJlc291cmNlIGlzIGEgdXJpCiAgICAgICAgICAgIHRoaXMuaXNVcmkgPSBmdW5jdGlvbihyZXNvdXJjZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuICFBbHBhY2EuaXNFbXB0eShyZXNvdXJjZSkgJiYgQWxwYWNhLmlzVXJpKHJlc291cmNlKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHZhciBPTkVfSE9VUiA9IDM2MDAwMDA7CiAgICAgICAgICAgIHRoaXMuY2FjaGUgPSBuZXcgYWpheENhY2hlKCdVUkwnLCB0cnVlLCBPTkVfSE9VUik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogTWFrZXMgaW5pdGlhbCBjb25uZWN0aW9ucyB0byBkYXRhIHNvdXJjZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IG9uU3VjY2VzcyBvblN1Y2Nlc3MgY2FsbGJhY2suCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gb25FcnJvciBvbkVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGNvbm5lY3Q6IGZ1bmN0aW9uIChvblN1Y2Nlc3MsIG9uRXJyb3IpCiAgICAgICAgewogICAgICAgICAgICBpZiAob25TdWNjZXNzICYmIEFscGFjYS5pc0Z1bmN0aW9uKG9uU3VjY2VzcykpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9uU3VjY2VzcygpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogTG9hZHMgYSB0ZW1wbGF0ZSAoSFRNTCBvciBUZXh0KS4KICAgICAgICAgKgogICAgICAgICAqIElmIHRoZSBzb3VyY2UgaXMgYSBVUkksIHRoZW4gaXQgaXMgbG9hZGVkLgogICAgICAgICAqIElmIGl0IGlzIG5vdCBhIFVSSSwgdGhlbiB0aGUgc291cmNlIGlzIHNpbXBseSBoYW5kZWQgYmFjay4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gc291cmNlIFNvdXJjZSB0byBiZSBsb2FkZWQuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gb25TdWNjZXNzIG9uU3VjY2VzcyBjYWxsYmFjay4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBvbkVycm9yIG9uRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgbG9hZFRlbXBsYXRlIDogZnVuY3Rpb24gKHNvdXJjZSwgb25TdWNjZXNzLCBvbkVycm9yKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eShzb3VyY2UpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzVXJpKHNvdXJjZSkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkVXJpKHNvdXJjZSwgZmFsc2UsIGZ1bmN0aW9uKGxvYWRlZERhdGEpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvblN1Y2Nlc3MgJiYgQWxwYWNhLmlzRnVuY3Rpb24ob25TdWNjZXNzKSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb25TdWNjZXNzKGxvYWRlZERhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChsb2FkRXJyb3IpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbkVycm9yICYmIEFscGFjYS5pc0Z1bmN0aW9uKG9uRXJyb3IpKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkVycm9yKGxvYWRFcnJvcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBvblN1Y2Nlc3Moc291cmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9uRXJyb3IoewogICAgICAgICAgICAgICAgICAgICJtZXNzYWdlIjoiRW1wdHkgZGF0YSBzb3VyY2UuIiwKICAgICAgICAgICAgICAgICAgICAicmVhc29uIjogIlRFTVBMQVRFX0xPQURJTkdfRVJST1IiCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIExvYWRzIEpTT04gZGF0YS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gcmVzb3VyY2UgUmVzb3VyY2UgdG8gYmUgbG9hZGVkLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IG9uU3VjY2VzcyBvblN1Y2Nlc3MgY2FsbGJhY2sKICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBvbkVycm9yIG9uRXJyb3IgY2FsbGJhY2sKICAgICAgICAgKi8KICAgICAgICBsb2FkRGF0YTogZnVuY3Rpb24gKHJlc291cmNlLCBzdWNjZXNzQ2FsbGJhY2ssIGVycm9yQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faGFuZGxlTG9hZEpzb25SZXNvdXJjZShyZXNvdXJjZSwgc3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBMb2FkcyBKU09OIHNjaGVtYS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gcmVzb3VyY2UgUmVzb3VyY2UgdG8gYmUgbG9hZGVkLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IG9uU3VjY2VzcyBvblN1Y2Nlc3MgY2FsbGJhY2suCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gb25FcnJvciBvbkVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGxvYWRTY2hlbWE6IGZ1bmN0aW9uIChyZXNvdXJjZSwgc3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZUxvYWRKc29uUmVzb3VyY2UocmVzb3VyY2UsIHN1Y2Nlc3NDYWxsYmFjaywgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogTG9hZHMgSlNPTiBvcHRpb25zLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSByZXNvdXJjZSBSZXNvdXJjZSB0byBiZSBsb2FkZWQuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gb25TdWNjZXNzIG9uU3VjY2VzcyBjYWxsYmFjay4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBvbkVycm9yIG9uRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgbG9hZE9wdGlvbnM6IGZ1bmN0aW9uIChyZXNvdXJjZSwgc3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZUxvYWRKc29uUmVzb3VyY2UocmVzb3VyY2UsIHN1Y2Nlc3NDYWxsYmFjaywgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogTG9hZHMgSlNPTiB2aWV3LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSByZXNvdXJjZSBSZXNvdXJjZSB0byBiZSBsb2FkZWQuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gb25TdWNjZXNzIG9uU3VjY2VzcyBjYWxsYmFjay4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBvbkVycm9yIG9uRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgbG9hZFZpZXc6IGZ1bmN0aW9uIChyZXNvdXJjZSwgc3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZUxvYWRKc29uUmVzb3VyY2UocmVzb3VyY2UsIHN1Y2Nlc3NDYWxsYmFjaywgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogTG9hZHMgc2NoZW1hLCBmb3JtLCB2aWV3IGFuZCBkYXRhIGluIGEgc2luZ2xlIGNhbGwuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gcmVzb3VyY2VzIHJlc291cmNlcwogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IG9uU3VjY2VzcyBvblN1Y2Nlc3MgY2FsbGJhY2suCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gb25FcnJvciBvbkVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGxvYWRBbGw6IGZ1bmN0aW9uIChyZXNvdXJjZXMsIG9uU3VjY2Vzcywgb25FcnJvcikKICAgICAgICB7CiAgICAgICAgICAgIHZhciBkYXRhU291cmNlID0gcmVzb3VyY2VzLmRhdGFTb3VyY2U7CiAgICAgICAgICAgIHZhciBzY2hlbWFTb3VyY2UgPSByZXNvdXJjZXMuc2NoZW1hU291cmNlOwogICAgICAgICAgICB2YXIgb3B0aW9uc1NvdXJjZSA9IHJlc291cmNlcy5vcHRpb25zU291cmNlOwogICAgICAgICAgICB2YXIgdmlld1NvdXJjZSA9IHJlc291cmNlcy52aWV3U291cmNlOwoKICAgICAgICAgICAgLy8gd2UgYWxsb3cgInNjaGVtYSIgdG8gY29udGFpbiBhIFVSSSBhcyB3ZWxsIChiYWNrd2FyZHMtY29tcGF0aWJpbGl0eSkKICAgICAgICAgICAgaWYgKCFzY2hlbWFTb3VyY2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHNjaGVtYVNvdXJjZSA9IHJlc291cmNlcy5zY2hlbWE7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHdlIGFsbG93ICJvcHRpb25zIiB0byBjb250YWluIGEgVVJJIGFzIHdlbGwgKGJhY2t3YXJkcy1jb21wYXRpYmlsaXR5KQogICAgICAgICAgICBpZiAoIW9wdGlvbnNTb3VyY2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9wdGlvbnNTb3VyY2UgPSByZXNvdXJjZXMub3B0aW9uczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gd2UgYWxsb3cgInZpZXciIHRvIGNvbnRhaW4gYSBVUkkgYXMgd2VsbCAoYmFja3dhcmRzLWNvbXBhdGliaWxpdHkpCiAgICAgICAgICAgIGlmICghdmlld1NvdXJjZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmlld1NvdXJjZSA9IHJlc291cmNlcy52aWV3OwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgbG9hZGVkID0ge307CgogICAgICAgICAgICB2YXIgbG9hZENvdW50ZXIgPSAwOwogICAgICAgICAgICB2YXIgaW52b2NhdGlvbkNvdW50ID0gMDsKCiAgICAgICAgICAgIHZhciBzdWNjZXNzQ2FsbGJhY2sgPSBmdW5jdGlvbigpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChsb2FkQ291bnRlciA9PT0gaW52b2NhdGlvbkNvdW50KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChvblN1Y2Nlc3MgJiYgQWxwYWNhLmlzRnVuY3Rpb24ob25TdWNjZXNzKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9uU3VjY2Vzcyhsb2FkZWQuZGF0YSwgbG9hZGVkLm9wdGlvbnMsIGxvYWRlZC5zY2hlbWEsIGxvYWRlZC52aWV3KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgZXJyb3JDYWxsYmFjayA9IGZ1bmN0aW9uIChsb2FkRXJyb3IpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChvbkVycm9yICYmIEFscGFjYS5pc0Z1bmN0aW9uKG9uRXJyb3IpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG9uRXJyb3IobG9hZEVycm9yKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIGNvdW50IG91dCB0aGUgdG90YWwgIyBvZiBpbnZva2VzIHdlJ3JlIGdvaW5nIHRvIGZpcmUgb2ZmCiAgICAgICAgICAgIGlmIChkYXRhU291cmNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpbnZvY2F0aW9uQ291bnQrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2NoZW1hU291cmNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpbnZvY2F0aW9uQ291bnQrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uc1NvdXJjZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaW52b2NhdGlvbkNvdW50Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZpZXdTb3VyY2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGludm9jYXRpb25Db3VudCsrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnZvY2F0aW9uQ291bnQgPT09IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIG5vdGhpbmcgdG8gaW52b2tlLCBzbyBqdXN0IGhhbmQgYmFjawogICAgICAgICAgICAgICAgc3VjY2Vzc0NhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGZpcmUgb2ZmIGFsbCBvZiB0aGUgaW52b2tlcwogICAgICAgICAgICBpZiAoZGF0YVNvdXJjZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5sb2FkRGF0YShkYXRhU291cmNlLCBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgbG9hZGVkLmRhdGEgPSBkYXRhOwogICAgICAgICAgICAgICAgICAgIGxvYWRDb3VudGVyKys7CiAgICAgICAgICAgICAgICAgICAgc3VjY2Vzc0NhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICB9LCBlcnJvckNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2NoZW1hU291cmNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmxvYWRTY2hlbWEoc2NoZW1hU291cmNlLCBmdW5jdGlvbihzY2hlbWEpIHsKICAgICAgICAgICAgICAgICAgICBsb2FkZWQuc2NoZW1hID0gc2NoZW1hOwogICAgICAgICAgICAgICAgICAgIGxvYWRDb3VudGVyKys7CiAgICAgICAgICAgICAgICAgICAgc3VjY2Vzc0NhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICB9LCBlcnJvckNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uc1NvdXJjZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5sb2FkT3B0aW9ucyhvcHRpb25zU291cmNlLCBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgbG9hZGVkLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICAgICAgICAgICAgICAgIGxvYWRDb3VudGVyKys7CiAgICAgICAgICAgICAgICAgICAgc3VjY2Vzc0NhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICB9LCBlcnJvckNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmlld1NvdXJjZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5sb2FkVmlldyh2aWV3U291cmNlLCBmdW5jdGlvbih2aWV3KSB7CiAgICAgICAgICAgICAgICAgICAgbG9hZGVkLnZpZXcgPSB2aWV3OwogICAgICAgICAgICAgICAgICAgIGxvYWRDb3VudGVyKys7CiAgICAgICAgICAgICAgICAgICAgc3VjY2Vzc0NhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICB9LCBlcnJvckNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIExvYWRzIGEgSlNPTiB0aHJvdWdoIEFqYXggY2FsbC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB1cmkgbG9jYXRpb24gb2YgdGhlIGpzb24gZG9jdW1lbnQKICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBvblN1Y2Nlc3Mgb25TdWNjZXNzIGNhbGxiYWNrLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IG9uRXJyb3Igb25FcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBsb2FkSnNvbiA6IGZ1bmN0aW9uKHVyaSwgb25TdWNjZXNzLCBvbkVycm9yKSB7CiAgICAgICAgICAgIHRoaXMubG9hZFVyaSh1cmksIHRydWUsIG9uU3VjY2Vzcywgb25FcnJvcik7CiAgICAgICAgfSAsCgogICAgICAgIC8qKgogICAgICAgICAqIExvYWRzIGEgZ2VuZXJhbCBkb2N1bWVudCB0aHJvdWdoIEFqYXggY2FsbC4KICAgICAgICAgKgogICAgICAgICAqIFRoaXMgdXNlcyBqUXVlcnkgdG8gcGVyZm9ybSB0aGUgQWpheCBjYWxsLiAgSWYgeW91IG5lZWQgdG8gY3VzdG9taXplIGNvbm5lY3Rpdml0eSB0byB5b3VyIG93biByZW1vdGUgc2VydmVyLAogICAgICAgICAqIHRoaXMgd291bGQgYmUgdGhlIGFwcHJvcHJpYXRlIHBsYWNlIHRvIGRvIHNvLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHVyaSB1cmkgdG8gYmUgbG9hZGVkCiAgICAgICAgICogQHBhcmFtIHtCb29sZWFufSBpc0pzb24gV2hldGhlciB0aGUgZG9jdW1lbnQgaXMgYSBKU09OIG9yIG5vdC4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBvblN1Y2Nlc3Mgb25TdWNjZXNzIGNhbGxiYWNrLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IG9uRXJyb3Igb25FcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBsb2FkVXJpIDogZnVuY3Rpb24odXJpLCBpc0pzb24sIG9uU3VjY2Vzcywgb25FcnJvcikgewoKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgdmFyIGFqYXhDb25maWdzID0gewogICAgICAgICAgICAgICAgInVybCI6IHVyaSwKICAgICAgICAgICAgICAgICJ0eXBlIjogImdldCIsCiAgICAgICAgICAgICAgICAic3VjY2VzcyI6IGZ1bmN0aW9uKGpzb25Eb2N1bWVudCkgewoKICAgICAgICAgICAgICAgICAgICBzZWxmLmNhY2hlLnB1dCh1cmksIGpzb25Eb2N1bWVudCk7CgogICAgICAgICAgICAgICAgICAgIGlmIChvblN1Y2Nlc3MgJiYgQWxwYWNhLmlzRnVuY3Rpb24ob25TdWNjZXNzKSkgewogICAgICAgICAgICAgICAgICAgICAgICBvblN1Y2Nlc3MoanNvbkRvY3VtZW50KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImVycm9yIjogZnVuY3Rpb24oanFYSFIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9uRXJyb3IgJiYgQWxwYWNhLmlzRnVuY3Rpb24ob25FcnJvcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb25FcnJvcih7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVzc2FnZSI6IlVuYWJsZSB0byBsb2FkIGRhdGEgZnJvbSB1cmkgOiAiICsgdXJpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YWdlIjogIkRBVEFfTE9BRElOR19FUlJPUiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGV0YWlscyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAianFYSFIiIDoganFYSFIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRleHRTdGF0dXMiIDogdGV4dFN0YXR1cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZXJyb3JUaHJvd24iIDogZXJyb3JUaHJvd24KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKGlzSnNvbikgewogICAgICAgICAgICAgICAgYWpheENvbmZpZ3MuZGF0YVR5cGUgPSAianNvbiI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhamF4Q29uZmlncy5kYXRhVHlwZSA9ICJ0ZXh0IjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGNhY2hlZERvY3VtZW50ID0gc2VsZi5jYWNoZS5nZXQodXJpKTsKCiAgICAgICAgICAgIGlmIChjYWNoZWREb2N1bWVudCAhPT0gZmFsc2UgJiYgb25TdWNjZXNzICYmIEFscGFjYS5pc0Z1bmN0aW9uKG9uU3VjY2VzcykpIHsKICAgICAgICAgICAgICAgIG9uU3VjY2VzcyhjYWNoZWREb2N1bWVudCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkLmFqYXgoYWpheENvbmZpZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogTG9hZHMgcmVmZXJlbmNlZCBKU09OIHNjaGVtYS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gcmVzb3VyY2UgUmVzb3VyY2UgdG8gYmUgbG9hZGVkLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IG9uU3VjY2VzcyBvblN1Y2Nlc3MgY2FsbGJhY2suCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gb25FcnJvciBvbkVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGxvYWRSZWZlcmVuY2VTY2hlbWE6IGZ1bmN0aW9uIChyZXNvdXJjZSwgc3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZUxvYWRKc29uUmVzb3VyY2UocmVzb3VyY2UsIHN1Y2Nlc3NDYWxsYmFjaywgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogTG9hZHMgcmVmZXJlbmNlZCBKU09OIG9wdGlvbnMuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHJlc291cmNlIFJlc291cmNlIHRvIGJlIGxvYWRlZC4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBvblN1Y2Nlc3Mgb25TdWNjZXNzIGNhbGxiYWNrLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IG9uRXJyb3Igb25FcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBsb2FkUmVmZXJlbmNlT3B0aW9uczogZnVuY3Rpb24gKHJlc291cmNlLCBzdWNjZXNzQ2FsbGJhY2ssIGVycm9yQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faGFuZGxlTG9hZEpzb25SZXNvdXJjZShyZXNvdXJjZSwgc3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICBfaGFuZGxlTG9hZEpzb25SZXNvdXJjZTogZnVuY3Rpb24gKHJlc291cmNlLCBzdWNjZXNzQ2FsbGJhY2ssIGVycm9yQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5pc1VyaShyZXNvdXJjZSkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMubG9hZEpzb24ocmVzb3VyY2UsIGZ1bmN0aW9uKGxvYWRlZFJlc291cmNlKSB7CiAgICAgICAgICAgICAgICAgICAgc3VjY2Vzc0NhbGxiYWNrKGxvYWRlZFJlc291cmNlKTsKICAgICAgICAgICAgICAgIH0sIGVycm9yQ2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc3VjY2Vzc0NhbGxiYWNrKHJlc291cmNlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJDb25uZWN0b3JDbGFzcygiZGVmYXVsdCIsIEFscGFjYS5Db25uZWN0b3IpOwoKCgoKCgoKCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLwogICAgLy8gQUpBWCBDQUNIRQogICAgLy8KICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCgogICAgLyohCiAgICAgKiBhamF4LWNhY2hlIEphdmFTY3JpcHQgTGlicmFyeSB2MC4yLjEKICAgICAqIGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vcC9hamF4LWNhY2hlLwogICAgICoKICAgICAqIEluY2x1ZGVzIGZldyBKU09OIG1ldGhvZHMgKG9wZW4gc291cmNlKQogICAgICogaHR0cDovL3d3dy5qc29uLm9yZy9qcy5odG1sCiAgICAgKgogICAgICogRGF0ZTogMjAxMC0wOC0wMwogICAgICovCiAgICBmdW5jdGlvbiBhamF4Q2FjaGUodHlwZSwgb24sIGxpZmV0aW1lKSB7CiAgICAgICAgaWYgKG9uKSB7CiAgICAgICAgICAgIHRoaXMub24gPSB0cnVlOwogICAgICAgIH0gZWxzZQogICAgICAgICAgICB0aGlzLm9uID0gZmFsc2U7CgogICAgICAgIC8vIHNldCBkZWZhdWx0IGNhY2hlIGxpZmV0aW1lCiAgICAgICAgaWYgKGxpZmV0aW1lICE9IG51bGwpIHsKICAgICAgICAgICAgdGhpcy5kZWZhdWx0TGlmZXRpbWUgPSBsaWZldGltZTsKICAgICAgICB9CgogICAgICAgIC8vIHNldCB0eXBlCiAgICAgICAgdGhpcy50eXBlID0gdHlwZTsKCiAgICAgICAgLy8gc2V0IGNhY2hlIGZ1bmN0aW9ucyBhY2NvcmRpbmcgdG8gdHlwZQogICAgICAgIHN3aXRjaCAodGhpcy50eXBlKSB7CiAgICAgICAgICAgIGNhc2UgJ1VSTCc6CiAgICAgICAgICAgICAgICB0aGlzLnB1dCA9IHRoaXMucHV0X3VybDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdHRVQnOgogICAgICAgICAgICAgICAgdGhpcy5wdXQgPSB0aGlzLnB1dF9HRVQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgfTsKCiAgICBhamF4Q2FjaGUucHJvdG90eXBlLm9uID0gZmFsc2U7CiAgICBhamF4Q2FjaGUucHJvdG90eXBlLnR5cGU7CiAgICBhamF4Q2FjaGUucHJvdG90eXBlLmRlZmF1bHRMaWZldGltZSA9IDE4MDAwMDA7IC8vIDE4MDAwMDA9MzBtaW4sIDMwMDAwMD01bWluLCAzMDAwMD0zMHNlYwogICAgYWpheENhY2hlLnByb3RvdHlwZS5pdGVtcyA9IE9iamVjdCgpOwoKICAgIC8qKgogICAgICogQ2FjaGVzIHRoZSByZXF1ZXN0IGFuZCBpdHMgcmVzcG9uc2UuIFR5cGU6IHVybAogICAgICoKICAgICAqIEBwYXJhbSB1cmwgLSB1cmwgb2YgYWpheCByZXNwb25zZQogICAgICogQHBhcmFtIHJlc3BvbnNlIC0gYWpheCByZXNwb25zZQogICAgICogQHBhcmFtIGxpZmV0aW1lIC0gKG9wdGlvbmFsKSBzZXRzIGNhY2hlIGxpZmV0aW1lIGluIG1pbGlzZWNvbmRzCiAgICAgKiBAcmV0dXJuIHRydWUgb24gc3VjY2VzcwogICAgICovCiAgICBhamF4Q2FjaGUucHJvdG90eXBlLnB1dF91cmwgPSBmdW5jdGlvbih1cmwsIHJlc3BvbnNlLCBsaWZldGltZSkgewogICAgICAgIGlmIChsaWZldGltZSA9PSBudWxsKSBsaWZldGltZSA9IHRoaXMuZGVmYXVsdExpZmV0aW1lOwogICAgICAgIHZhciBrZXkgPSB0aGlzLm1ha2Vfa2V5KHVybCk7CiAgICAgICAgdGhpcy5pdGVtc1trZXldID0gT2JqZWN0KCk7CiAgICAgICAgdGhpcy5pdGVtc1trZXldLmtleSA9IGtleTsKICAgICAgICB0aGlzLml0ZW1zW2tleV0udXJsID0gdXJsOwogICAgICAgIHRoaXMuaXRlbXNba2V5XS5yZXNwb25zZSA9IHJlc3BvbnNlOwogICAgICAgIHRoaXMuaXRlbXNba2V5XS5leHBpcmUgPSAobmV3IERhdGUoKS5nZXRUaW1lKCkpICsgbGlmZXRpbWU7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBDYWNoZXMgdGhlIHJlcXVlc3QgYW5kIGl0cyByZXNwb25zZS4gVHlwZTogR0VUCiAgICAgKgogICAgICogQHBhcmFtIHVybCAtIHVybCBvZiBhamF4IHJlc3BvbnNlCiAgICAgKiBAcGFyYW0gZGF0YSAtIGRhdGEgcGFyYW1zIChxdWVyeSkKICAgICAqIEBwYXJhbSByZXNwb25zZSAtIGFqYXggcmVzcG9uc2UKICAgICAqIEBwYXJhbSBsaWZldGltZSAtIChvcHRpb25hbCkgc2V0cyBjYWNoZSBsaWZldGltZSBpbiBtaWxpc2Vjb25kcwogICAgICogQHJldHVybiB0cnVlIG9uIHN1Y2Nlc3MKICAgICAqLwogICAgYWpheENhY2hlLnByb3RvdHlwZS5wdXRfR0VUID0gZnVuY3Rpb24odXJsLCBkYXRhLCByZXNwb25zZSwgbGlmZXRpbWUpIHsKICAgICAgICBpZiAobGlmZXRpbWUgPT0gbnVsbCkKICAgICAgICAgICAgbGlmZXRpbWUgPSB0aGlzLmRlZmF1bHRMaWZldGltZTsKICAgICAgICB2YXIga2V5ID0gdGhpcy5tYWtlX2tleSh1cmwsIFsgZGF0YSBdKTsKICAgICAgICB0aGlzLml0ZW1zW2tleV0gPSBPYmplY3QoKTsKICAgICAgICB0aGlzLml0ZW1zW2tleV0ua2V5ID0ga2V5OwogICAgICAgIHRoaXMuaXRlbXNba2V5XS51cmwgPSB1cmw7CiAgICAgICAgdGhpcy5pdGVtc1trZXldLmRhdGEgPSBkYXRhOwogICAgICAgIHRoaXMuaXRlbXNba2V5XS5yZXNwb25zZSA9IHJlc3BvbnNlOwogICAgICAgIHRoaXMuaXRlbXNba2V5XS5leHBpcmUgPSAobmV3IERhdGUoKS5nZXRUaW1lKCkpICsgbGlmZXRpbWU7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgY2FjaGVkIGFqYXggcmVzcG9uc2UKICAgICAqCiAgICAgKiBAcGFyYW0gdXJsIC0gdXJsIG9mIGFqYXggcmVzcG9uc2UKICAgICAqIEBwYXJhbSBwYXJhbXMgLSBBcnJheSBvZiBhZGRpdGlvbmFsIHBhcmFtZXRlcnMsIHRvIG1ha2Uga2V5CiAgICAgKiBAcmV0dXJuIGFqYXggcmVzcG9uc2Ugb3IgZmFsc2UgaWYgc3VjaCBkb2VzIG5vdCBleGlzdCBvciBpcyBleHBpcmVkCiAgICAgKi8KICAgIGFqYXhDYWNoZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24odXJsLCBwYXJhbXMpIHsKICAgICAgICB2YXIga2V5ID0gdGhpcy5tYWtlX2tleSh1cmwsIHBhcmFtcyk7CgogICAgICAgIC8vIGlmIGNhY2hlIGRvZXMgbm90IGV4aXN0CiAgICAgICAgaWYgKHRoaXMuaXRlbXNba2V5XSA9PSBudWxsKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgICAgIC8vIGlmIGNhY2hlIGV4cGlyZWQKICAgICAgICBpZiAodGhpcy5pdGVtc1trZXldLmV4cGlyZSA8IChuZXcgRGF0ZSgpLmdldFRpbWUoKSkpCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKCiAgICAgICAgLy8gZXZlcnl0aGluZyBpcyBwYXNzZWQgLSBsZXRzIHJldHVybiB0aGUgcmVzcG9uc2UKICAgICAgICByZXR1cm4gdGhpcy5pdGVtc1trZXldLnJlc3BvbnNlOwogICAgfQoKICAgIC8qKgogICAgICogTWFrZSB1bmlxdWUga2V5IGZvciBlYWNoIHJlcXVlc3QgZGVwZW5kaW5nIG9uIHVybCBhbmQgYWRkaXRpb25hbCBwYXJhbWV0ZXJzCiAgICAgKgogICAgICogQHBhcmFtIHVybCAtIHVybCBvZiBhamF4IHJlc3BvbnNlCiAgICAgKiBAcGFyYW0gcGFyYW1zIC0gQXJyYXkgb2YgYWRkaXRpb25hbCBwYXJhbWV0ZXJzLCB0byBtYWtlIGtleQogICAgICogQHJldHVybiB1bmlxdWUga2V5CiAgICAgKi8KICAgIGFqYXhDYWNoZS5wcm90b3R5cGUubWFrZV9rZXkgPSBmdW5jdGlvbih1cmwsIHBhcmFtcykgewogICAgICAgIHZhciBrZXkgPSB1cmw7CiAgICAgICAgc3dpdGNoICh0aGlzLnR5cGUpIHsKICAgICAgICAgICAgY2FzZSAnVVJMJzoKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdHRVQnOgogICAgICAgICAgICAgICAga2V5ICs9IHRoaXMuc3RyaW5naWZ5KHBhcmFtc1swXSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIHJldHVybiBrZXk7CiAgICB9CgogICAgLyoqCiAgICAgKiBGbHVzaCBjYWNoZQogICAgICoKICAgICAqIEByZXR1cm4gdHJ1ZSBvbiBzdWNjZXNzCiAgICAgKi8KICAgIGFqYXhDYWNoZS5wcm90b3R5cGUuZmx1c2ggPSBmdW5jdGlvbigpIHsKICAgICAgICAvLyBmbHVzaCBhbGwgY2FjaGUKICAgICAgICBjYWNoZS5pdGVtcyA9IE9iamVjdCgpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qCiAgICAgKiBNZXRob2RzIHRvIHN0cmluZ2lmeSBKYXZhU2NyaXB0L0pTT04gb2JqZWN0cy4KICAgICAqCiAgICAgKiBUYWtlbiBmcm9tOiBodHRwOi8vd3d3Lmpzb24ub3JnL2pzLmh0bWwgdG8gYmUgbW9yZSBleGFjdCwgdGhpcyBmaWxlOgogICAgICogaHR0cDovL3d3dy5qc29uLm9yZy9qc29uMi5qcyBjb3BpZWQgb24gMjAxMC0wNy0xOQogICAgICoKICAgICAqIFRha2VuIG1ldGhvZHM6IHN0cmluZ2lmeSwgcXVvdGUgYW5kIHN0cgogICAgICoKICAgICAqIE1ldGhvZHMgYXJlIHNsaWdodGx5IG1vZGlmaWVkIHRvIGJlc3QgZml0IGFqYXgtY2FjaGUgZnVuY3Rpb25hbGl0eQogICAgICoKICAgICAqLwogICAgYWpheENhY2hlLnByb3RvdHlwZS5zdHJpbmdpZnkgPSBmdW5jdGlvbih2YWx1ZSwgcmVwbGFjZXIsIHNwYWNlKSB7CgogICAgICAgIC8vIFRoZSBzdHJpbmdpZnkgbWV0aG9kIHRha2VzIGEgdmFsdWUgYW5kIGFuIG9wdGlvbmFsIHJlcGxhY2VyLCBhbmQgYW4KICAgICAgICAvLyBvcHRpb25hbAogICAgICAgIC8vIHNwYWNlIHBhcmFtZXRlciwgYW5kIHJldHVybnMgYSBKU09OIHRleHQuIFRoZSByZXBsYWNlciBjYW4gYmUgYSBmdW5jdGlvbgogICAgICAgIC8vIHRoYXQgY2FuIHJlcGxhY2UgdmFsdWVzLCBvciBhbiBhcnJheSBvZiBzdHJpbmdzIHRoYXQgd2lsbCBzZWxlY3QgdGhlCiAgICAgICAgLy8ga2V5cy4KICAgICAgICAvLyBBIGRlZmF1bHQgcmVwbGFjZXIgbWV0aG9kIGNhbiBiZSBwcm92aWRlZC4gVXNlIG9mIHRoZSBzcGFjZSBwYXJhbWV0ZXIgY2FuCiAgICAgICAgLy8gcHJvZHVjZSB0ZXh0IHRoYXQgaXMgbW9yZSBlYXNpbHkgcmVhZGFibGUuCgogICAgICAgIHZhciBpOwogICAgICAgIGdhcCA9ICcnOwogICAgICAgIGluZGVudCA9ICcnOwoKICAgICAgICAvLyBJZiB0aGUgc3BhY2UgcGFyYW1ldGVyIGlzIGEgbnVtYmVyLCBtYWtlIGFuIGluZGVudCBzdHJpbmcgY29udGFpbmluZyB0aGF0CiAgICAgICAgLy8gbWFueSBzcGFjZXMuCgogICAgICAgIGlmICh0eXBlb2Ygc3BhY2UgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzcGFjZTsgaSArPSAxKSB7CiAgICAgICAgICAgICAgICBpbmRlbnQgKz0gJyAnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiB0aGUgc3BhY2UgcGFyYW1ldGVyIGlzIGEgc3RyaW5nLCBpdCB3aWxsIGJlIHVzZWQgYXMgdGhlIGluZGVudAogICAgICAgICAgICAvLyBzdHJpbmcuCgogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHNwYWNlID09PSAnc3RyaW5nJykgewogICAgICAgICAgICBpbmRlbnQgPSBzcGFjZTsKICAgICAgICB9CgogICAgICAgIC8vIElmIHRoZXJlIGlzIGEgcmVwbGFjZXIsIGl0IG11c3QgYmUgYSBmdW5jdGlvbiBvciBhbiBhcnJheS4KICAgICAgICAvLyBPdGhlcndpc2UsIHRocm93IGFuIGVycm9yLgoKICAgICAgICByZXAgPSByZXBsYWNlcjsKICAgICAgICBpZiAocmVwbGFjZXIKICAgICAgICAgICAgJiYgdHlwZW9mIHJlcGxhY2VyICE9PSAnZnVuY3Rpb24nCiAgICAgICAgICAgICYmICh0eXBlb2YgcmVwbGFjZXIgIT09ICdvYmplY3QnIHx8IHR5cGVvZiByZXBsYWNlci5sZW5ndGggIT09ICdudW1iZXInKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0pTT04uc3RyaW5naWZ5Jyk7CiAgICAgICAgfQoKICAgICAgICAvLyBNYWtlIGEgZmFrZSByb290IG9iamVjdCBjb250YWluaW5nIG91ciB2YWx1ZSB1bmRlciB0aGUga2V5IG9mICcnLgogICAgICAgIC8vIFJldHVybiB0aGUgcmVzdWx0IG9mIHN0cmluZ2lmeWluZyB0aGUgdmFsdWUuCgogICAgICAgIHJldHVybiB0aGlzLnN0cignJywgewogICAgICAgICAgICAnJyA6IHZhbHVlCiAgICAgICAgfSk7CiAgICB9CgogICAgYWpheENhY2hlLnByb3RvdHlwZS5xdW90ZSA9IGZ1bmN0aW9uKHN0cmluZykgewoKICAgICAgICAvLyBJZiB0aGUgc3RyaW5nIGNvbnRhaW5zIG5vIGNvbnRyb2wgY2hhcmFjdGVycywgbm8gcXVvdGUgY2hhcmFjdGVycywgYW5kIG5vCiAgICAgICAgLy8gYmFja3NsYXNoIGNoYXJhY3RlcnMsIHRoZW4gd2UgY2FuIHNhZmVseSBzbGFwIHNvbWUgcXVvdGVzIGFyb3VuZCBpdC4KICAgICAgICAvLyBPdGhlcndpc2Ugd2UgbXVzdCBhbHNvIHJlcGxhY2UgdGhlIG9mZmVuZGluZyBjaGFyYWN0ZXJzIHdpdGggc2FmZSBlc2NhcGUKICAgICAgICAvLyBzZXF1ZW5jZXMuCgogICAgICAgIHZhciBlc2NhcGFibGUgPSAvW1xcXCJceDAwLVx4MWZceDdmLVx4OWZcdTAwYWRcdTA2MDAtXHUwNjA0XHUwNzBmXHUxN2I0XHUxN2I1XHUyMDBjLVx1MjAwZlx1MjAyOC1cdTIwMmZcdTIwNjAtXHUyMDZmXHVmZWZmXHVmZmYwLVx1ZmZmZl0vZzsKCiAgICAgICAgZXNjYXBhYmxlLmxhc3RJbmRleCA9IDA7CiAgICAgICAgcmV0dXJuIGVzY2FwYWJsZS50ZXN0KHN0cmluZykgPyAnIicgKyBzdHJpbmcucmVwbGFjZShlc2NhcGFibGUsCiAgICAgICAgICAgIGZ1bmN0aW9uKGEpIHsKICAgICAgICAgICAgICAgIHZhciBjID0gbWV0YVthXTsKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2YgYyA9PT0gJ3N0cmluZycgPyBjIDogJ1xcdScgKyAoJzAwMDAnICsgYQogICAgICAgICAgICAgICAgICAgIC5jaGFyQ29kZUF0KDApLnRvU3RyaW5nKDE2KSkuc2xpY2UoLTQpOwogICAgICAgICAgICB9KSArICciJyA6ICciJyArIHN0cmluZyArICciJzsKICAgIH0KCiAgICBhamF4Q2FjaGUucHJvdG90eXBlLnN0ciA9IGZ1bmN0aW9uKGtleSwgaG9sZGVyKSB7CgogICAgICAgIC8vIFByb2R1Y2UgYSBzdHJpbmcgZnJvbSBob2xkZXJba2V5XS4KCiAgICAgICAgdmFyIGksIC8vIFRoZSBsb29wIGNvdW50ZXIuCiAgICAgICAgICAgIGssIC8vIFRoZSBtZW1iZXIga2V5LgogICAgICAgICAgICB2LCAvLyBUaGUgbWVtYmVyIHZhbHVlLgogICAgICAgICAgICBsZW5ndGgsIG1pbmQgPSBnYXAsIHBhcnRpYWwsIHZhbHVlID0gaG9sZGVyW2tleV07CgogICAgICAgIC8vIElmIHRoZSB2YWx1ZSBoYXMgYSB0b0pTT04gbWV0aG9kLCBjYWxsIGl0IHRvIG9idGFpbiBhIHJlcGxhY2VtZW50IHZhbHVlLgoKICAgICAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JwogICAgICAgICAgICAmJiB0eXBlb2YgdmFsdWUudG9KU09OID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIHZhbHVlID0gdmFsdWUudG9KU09OKGtleSk7CiAgICAgICAgfQoKICAgICAgICAvLyBJZiB3ZSB3ZXJlIGNhbGxlZCB3aXRoIGEgcmVwbGFjZXIgZnVuY3Rpb24sIHRoZW4gY2FsbCB0aGUgcmVwbGFjZXIgdG8KICAgICAgICAvLyBvYnRhaW4gYSByZXBsYWNlbWVudCB2YWx1ZS4KCiAgICAgICAgaWYgKHR5cGVvZiByZXAgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgdmFsdWUgPSByZXAuY2FsbChob2xkZXIsIGtleSwgdmFsdWUpOwogICAgICAgIH0KCiAgICAgICAgLy8gV2hhdCBoYXBwZW5zIG5leHQgZGVwZW5kcyBvbiB0aGUgdmFsdWUncyB0eXBlLgoKICAgICAgICBzd2l0Y2ggKHR5cGVvZiB2YWx1ZSkgewogICAgICAgICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucXVvdGUodmFsdWUpOwoKICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzoKCiAgICAgICAgICAgICAgICAvLyBKU09OIG51bWJlcnMgbXVzdCBiZSBmaW5pdGUuIEVuY29kZSBub24tZmluaXRlIG51bWJlcnMgYXMgbnVsbC4KCiAgICAgICAgICAgICAgICByZXR1cm4gaXNGaW5pdGUodmFsdWUpID8gU3RyaW5nKHZhbHVlKSA6ICdudWxsJzsKCiAgICAgICAgICAgIGNhc2UgJ2Jvb2xlYW4nOgogICAgICAgICAgICBjYXNlICdudWxsJzoKCiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgdmFsdWUgaXMgYSBib29sZWFuIG9yIG51bGwsIGNvbnZlcnQgaXQgdG8gYSBzdHJpbmcuIE5vdGU6CiAgICAgICAgICAgICAgICAvLyB0eXBlb2YgbnVsbCBkb2VzIG5vdCBwcm9kdWNlICdudWxsJy4gVGhlIGNhc2UgaXMgaW5jbHVkZWQgaGVyZSBpbgogICAgICAgICAgICAgICAgLy8gdGhlIHJlbW90ZSBjaGFuY2UgdGhhdCB0aGlzIGdldHMgZml4ZWQgc29tZWRheS4KCiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKTsKCiAgICAgICAgICAgIC8vIElmIHRoZSB0eXBlIGlzICdvYmplY3QnLCB3ZSBtaWdodCBiZSBkZWFsaW5nIHdpdGggYW4gb2JqZWN0IG9yIGFuCiAgICAgICAgICAgIC8vIGFycmF5IG9yCiAgICAgICAgICAgIC8vIG51bGwuCgogICAgICAgICAgICBjYXNlICdvYmplY3QnOgoKICAgICAgICAgICAgICAgIC8vIER1ZSB0byBhIHNwZWNpZmljYXRpb24gYmx1bmRlciBpbiBFQ01BU2NyaXB0LCB0eXBlb2YgbnVsbCBpcwogICAgICAgICAgICAgICAgLy8gJ29iamVjdCcsCiAgICAgICAgICAgICAgICAvLyBzbyB3YXRjaCBvdXQgZm9yIHRoYXQgY2FzZS4KCiAgICAgICAgICAgICAgICBpZiAoIXZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdudWxsJzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBNYWtlIGFuIGFycmF5IHRvIGhvbGQgdGhlIHBhcnRpYWwgcmVzdWx0cyBvZiBzdHJpbmdpZnlpbmcgdGhpcyBvYmplY3QKICAgICAgICAgICAgICAgIC8vIHZhbHVlLgoKICAgICAgICAgICAgICAgIGdhcCArPSBpbmRlbnQ7CiAgICAgICAgICAgICAgICBwYXJ0aWFsID0gW107CgogICAgICAgICAgICAgICAgLy8gSXMgdGhlIHZhbHVlIGFuIGFycmF5PwoKICAgICAgICAgICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmFwcGx5KHZhbHVlKSA9PT0gJ1tvYmplY3QgQXJyYXldJykgewoKICAgICAgICAgICAgICAgICAgICAvLyBUaGUgdmFsdWUgaXMgYW4gYXJyYXkuIFN0cmluZ2lmeSBldmVyeSBlbGVtZW50LiBVc2UgbnVsbCBhcyBhCiAgICAgICAgICAgICAgICAgICAgLy8gcGxhY2Vob2xkZXIKICAgICAgICAgICAgICAgICAgICAvLyBmb3Igbm9uLUpTT04gdmFsdWVzLgoKICAgICAgICAgICAgICAgICAgICBsZW5ndGggPSB2YWx1ZS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRpYWxbaV0gPSB0aGlzLnN0cihpLCB2YWx1ZSkgfHwgJ251bGwnOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gSm9pbiBhbGwgb2YgdGhlIGVsZW1lbnRzIHRvZ2V0aGVyLCBzZXBhcmF0ZWQgd2l0aCBjb21tYXMsIGFuZAogICAgICAgICAgICAgICAgICAgIC8vIHdyYXAgdGhlbSBpbgogICAgICAgICAgICAgICAgICAgIC8vIGJyYWNrZXRzLgoKICAgICAgICAgICAgICAgICAgICB2ID0gcGFydGlhbC5sZW5ndGggPT09IDAgPyAnW10nIDogZ2FwID8gJ1tcbicgKyBnYXAKICAgICAgICAgICAgICAgICAgICAgICAgKyBwYXJ0aWFsLmpvaW4oJyxcbicgKyBnYXApICsgJ1xuJyArIG1pbmQgKyAnXScKICAgICAgICAgICAgICAgICAgICAgICAgOiAnWycgKyBwYXJ0aWFsLmpvaW4oJywnKSArICddJzsKICAgICAgICAgICAgICAgICAgICBnYXAgPSBtaW5kOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIElmIHRoZSByZXBsYWNlciBpcyBhbiBhcnJheSwgdXNlIGl0IHRvIHNlbGVjdCB0aGUgbWVtYmVycyB0byBiZQogICAgICAgICAgICAgICAgLy8gc3RyaW5naWZpZWQuCgogICAgICAgICAgICAgICAgaWYgKHJlcCAmJiB0eXBlb2YgcmVwID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IHJlcC5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGsgPSByZXBbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgayA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHYgPSB0aGlzLnN0cihrLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRpYWwucHVzaCh0aGlzLnF1b3RlKGspICsgKGdhcCA/ICc6ICcgOiAnOicpICsgdik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgICAgICAvLyBPdGhlcndpc2UsIGl0ZXJhdGUgdGhyb3VnaCBhbGwgb2YgdGhlIGtleXMgaW4gdGhlIG9iamVjdC4KCiAgICAgICAgICAgICAgICAgICAgZm9yIChrIGluIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbCh2YWx1ZSwgaykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHYgPSB0aGlzLnN0cihrLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRpYWwucHVzaCh0aGlzLnF1b3RlKGspICsgKGdhcCA/ICc6ICcgOiAnOicpICsgdik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSm9pbiBhbGwgb2YgdGhlIG1lbWJlciB0ZXh0cyB0b2dldGhlciwgc2VwYXJhdGVkIHdpdGggY29tbWFzLAogICAgICAgICAgICAgICAgLy8gYW5kIHdyYXAgdGhlbSBpbiBicmFjZXMuCgogICAgICAgICAgICAgICAgdiA9IHBhcnRpYWwubGVuZ3RoID09PSAwID8gJ3t9JyA6IGdhcCA/ICd7XG4nICsgZ2FwCiAgICAgICAgICAgICAgICAgICAgKyBwYXJ0aWFsLmpvaW4oJyxcbicgKyBnYXApICsgJ1xuJyArIG1pbmQgKyAnfScgOiAneycgKyBwYXJ0aWFsCiAgICAgICAgICAgICAgICAgICAgLmpvaW4oJywnKSArICd9JzsKICAgICAgICAgICAgICAgIGdhcCA9IG1pbmQ7CiAgICAgICAgICAgICAgICByZXR1cm4gdjsKICAgICAgICB9CiAgICB9Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRm9ybSA9IEJhc2UuZXh0ZW5kKAogICAgLyoqCiAgICAgKiBAbGVuZHMgQWxwYWNhLkZvcm0ucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIFRoaXMgY2xhc3MgaXMgZm9yIG1hbmFnaW5nIEhUTUwgZm9ybSBjb250cm9sLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBvcHRpb25zLCB2aWV3SWQsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgLy8gY29udGFpbmVyCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gY29udGFpbmVyOwoKICAgICAgICAgICAgLy8gcGFyZW50CiAgICAgICAgICAgIHRoaXMucGFyZW50ID0gbnVsbDsKCiAgICAgICAgICAgIHRoaXMuY29ubmVjdG9yID0gY29ubmVjdG9yOwogICAgICAgICAgICB0aGlzLmVycm9yQ2FsbGJhY2sgPSBlcnJvckNhbGxiYWNrOwoKICAgICAgICAgICAgLy8gb3B0aW9ucwogICAgICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwoKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5hdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF0dHJpYnV0ZXMgPSB0aGlzLm9wdGlvbnMuYXR0cmlidXRlczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmJ1dHRvbnMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuYnV0dG9ucy5zdWJtaXQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5idXR0b25zLnN1Ym1pdC50eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5idXR0b25zLnN1Ym1pdC50eXBlID0gJ3N1Ym1pdCc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5vcHRpb25zLmJ1dHRvbnMuc3VibWl0Lm5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmJ1dHRvbnMuc3VibWl0Lm5hbWUgPSAnc3VibWl0JzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuYnV0dG9ucy5zdWJtaXQudmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmJ1dHRvbnMuc3VibWl0LnZhbHVlID0gJ1N1Ym1pdCc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5idXR0b25zLnJlc2V0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuYnV0dG9ucy5yZXNldC50eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5idXR0b25zLnJlc2V0LnR5cGUgPSAncmVzZXQnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5idXR0b25zLnJlc2V0Lm5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmJ1dHRvbnMucmVzZXQubmFtZSA9ICdyZXNldCc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5vcHRpb25zLmJ1dHRvbnMucmVzZXQudmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmJ1dHRvbnMucmVzZXQudmFsdWUgPSAnUmVzZXQnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuYXR0cmlidXRlcy5pZCkgewogICAgICAgICAgICAgICAgdGhpcy5pZCA9IHRoaXMuYXR0cmlidXRlcy5pZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuaWQgPSBBbHBhY2EuZ2VuZXJhdGVJZCgpOwogICAgICAgICAgICAgICAgdGhpcy5hdHRyaWJ1dGVzLmlkID0gdGhpcy5pZDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaWYgd2UgaGF2ZSBhIHN1Ym1pdCBidXR0b24gc3BlY2lmaWVkLCBhbmQgdG9nZ2xlU3VibWl0VmFsaWRTdGF0ZSBpc24ndCBkZWZpbmVkLCBzZXQgdG8gdHJ1ZSBieSBkZWZhdWx0CiAgICAgICAgICAgIC8vIGRvbid0IGFsbG93IHRoZSBmb3JtIHRvIHN1Ym1pdCB1bmxlc3MgdmFsaWQKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5idXR0b25zICYmIHRoaXMub3B0aW9ucy5idXR0b25zLnN1Ym1pdCAmJiBBbHBhY2EuaXNVbmRlZmluZWQodGhpcy5vcHRpb25zLnRvZ2dsZVN1Ym1pdFZhbGlkU3RhdGUpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMudG9nZ2xlU3VibWl0VmFsaWRTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudmlld1R5cGUgPSBvcHRpb25zLnZpZXdUeXBlOwoKICAgICAgICAgICAgLy8gc2V0IGEgcnVudGltZSB2aWV3CiAgICAgICAgICAgIHRoaXMudmlldyA9IG5ldyBBbHBhY2EuUnVudGltZVZpZXcodmlld0lkLCB0aGlzKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZW5kZXJzIHRoaXMgZm9ybSBpbnRvIHRoZSBjb250YWluZXIuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBvblN1Y2Nlc3Mgb25TdWNjZXNzIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIHJlbmRlcjogZnVuY3Rpb24ob25TdWNjZXNzKSB7CiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLnRlbXBsYXRlRGVzY3JpcHRvciA9IHRoaXMudmlldy5nZXRUZW1wbGF0ZURlc2NyaXB0b3IoImZvcm0iKTsKCiAgICAgICAgICAgIC8vIHJlbW92ZSB0aGUgcHJldmlvdXMgb3V0ZXJFbCBpZiBpdCBleGlzdHMKICAgICAgICAgICAgaWYgKHRoaXMub3V0ZXJFbCkgewogICAgICAgICAgICAgICAgdGhpcy5vdXRlckVsLnJlbW92ZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBsb2FkIHRoZSBhcHByb3ByaWF0ZSB0ZW1wbGF0ZSBhbmQgcmVuZGVyIGl0CiAgICAgICAgICAgIHRoaXMucHJvY2Vzc1JlbmRlcih0aGlzLmNvbnRhaW5lciwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAvLyBiaW5kIG91ciBmaWVsZCBkb20gZWxlbWVudCBpbnRvIHRoZSBjb250YWluZXIKICAgICAgICAgICAgICAgIF90aGlzLm91dGVyRWwuYXBwZW5kVG8oX3RoaXMuY29udGFpbmVyKTsKCiAgICAgICAgICAgICAgICAvLyBhZGQgZGVmYXVsdCBjbGFzcwogICAgICAgICAgICAgICAgX3RoaXMub3V0ZXJFbC5hZGRDbGFzcygiYWxwYWNhLWZvcm0iKTsKCiAgICAgICAgICAgICAgICAvLyBleGVjdXRlIGNhbGxiYWNrCiAgICAgICAgICAgICAgICBpZiAob25TdWNjZXNzKQogICAgICAgICAgICAgICAgICAgIG9uU3VjY2VzcyhfdGhpcyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIERldGVybWluZXMgd2hldGhlciB0aGUgdG9wIGNvbnRyb2wgaXMgZW50aXJlbHkgdmFsaWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJuIHsqfQogICAgICAgICAqLwogICAgICAgIGlzRm9ybVZhbGlkOiBmdW5jdGlvbigpCiAgICAgICAgewogICAgICAgICAgICAvLyByZS1jb21wdXRlIHZhbGlkYXRpb24gZm9yIHRoZSBmdWxsIGNvbnRyb2wgc2V0CiAgICAgICAgICAgIHRoaXMudG9wQ29udHJvbC52YWxpZGF0ZSh0cnVlKTsKCiAgICAgICAgICAgIHZhciB2YWxpZCA9IHRoaXMudG9wQ29udHJvbC5pc1ZhbGlkKHRydWUpOwogICAgICAgICAgICB0aGlzLnJlZnJlc2hWYWxpZGF0aW9uU3RhdGUodHJ1ZSk7CgogICAgICAgICAgICByZXR1cm4gdmFsaWQ7CiAgICAgICAgfSwKCiAgICAgICAgdmFsaWRhdGU6IGZ1bmN0aW9uKGNoaWxkcmVuKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudG9wQ29udHJvbC52YWxpZGF0ZShjaGlsZHJlbik7CiAgICAgICAgfSwKCiAgICAgICAgZW5hYmxlU3VibWl0QnV0dG9uOiBmdW5jdGlvbigpCiAgICAgICAgewogICAgICAgICAgICAkKCIuYWxwYWNhLWZvcm0tYnV0dG9uLXN1Ym1pdCIpLmF0dHJQcm9wKCJkaXNhYmxlZCIsIGZhbHNlKTsKCiAgICAgICAgICAgIGlmICgkLm1vYmlsZSkgewogICAgICAgICAgICAgICAgdHJ5IHsgJCgiLmFscGFjYS1mb3JtLWJ1dHRvbi1zdWJtaXQiKS5idXR0b24oJ3JlZnJlc2gnKTsgfSBjYXRjaCAoZSkgeyB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBkaXNhYmxlU3VibWl0QnV0dG9uOiBmdW5jdGlvbigpCiAgICAgICAgewogICAgICAgICAgICAkKCIuYWxwYWNhLWZvcm0tYnV0dG9uLXN1Ym1pdCIpLmF0dHJQcm9wKCJkaXNhYmxlZCIsIHRydWUpOwoKICAgICAgICAgICAgaWYgKCQubW9iaWxlKSB7CiAgICAgICAgICAgICAgICB0cnkgeyAkKCIuYWxwYWNhLWZvcm0tYnV0dG9uLXN1Ym1pdCIpLmJ1dHRvbigncmVmcmVzaCcpOyB9IGNhdGNoIChlKSB7IH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGFkanVzdFN1Ym1pdEJ1dHRvblN0YXRlOiBmdW5jdGlvbigpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmRpc2FibGVTdWJtaXRCdXR0b24oKTsKCiAgICAgICAgICAgIHZhciB4ID0gdGhpcy5pc0Zvcm1WYWxpZCgpOwogICAgICAgICAgICBpZiAodGhpcy5pc0Zvcm1WYWxpZCgpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmVuYWJsZVN1Ym1pdEJ1dHRvbigpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVzcG9uc2libGUgZm9yIGZldGNoaW5nIGFueSB0ZW1wbGF0ZXMgbmVlZGVkIHNvIGFzIHRvIHJlbmRlciB0aGUKICAgICAgICAgKiBjdXJyZW50IG1vZGUgZm9yIHRoaXMgZmllbGQuCiAgICAgICAgICoKICAgICAgICAgKiBPbmNlIGNvbXBsZXRlZCwgdGhlIG9uU3VjY2VzcyBtZXRob2QgaXMgY2FsbGVkLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHBhcmVudEVsIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBvblN1Y2Nlc3Mgb25TdWNjZXNzIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIHByb2Nlc3NSZW5kZXI6IGZ1bmN0aW9uKHBhcmVudEVsLCBvblN1Y2Nlc3MpIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIC8vIGxvb2t1cCB0aGUgdGVtcGxhdGUgd2Ugc2hvdWxkIHVzZSB0byByZW5kZXIKICAgICAgICAgICAgdmFyIHRlbXBsYXRlRGVzY3JpcHRvciA9IHRoaXMuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCk7CgogICAgICAgICAgICB2YXIgY29udGV4dCA9IHsKICAgICAgICAgICAgICAgIGlkOiB0aGlzLmdldElkKCksCiAgICAgICAgICAgICAgICBvcHRpb25zOiB0aGlzLm9wdGlvbnMsCiAgICAgICAgICAgICAgICB2aWV3OiB0aGlzLnZpZXcKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIHJlbmRlcmVkRG9tRWxlbWVudCA9IF90aGlzLnZpZXcudG1wbCh0ZW1wbGF0ZURlc2NyaXB0b3IsIGNvbnRleHQsIHt9KTsKICAgICAgICAgICAgcmVuZGVyZWREb21FbGVtZW50LmFwcGVuZFRvKHBhcmVudEVsKTsKCiAgICAgICAgICAgIHRoaXMub3V0ZXJFbCA9IHJlbmRlcmVkRG9tRWxlbWVudDsKCiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNFbXB0eSh0aGlzLm91dGVyRWwuYXR0cigiaWQiKSkpIHsKICAgICAgICAgICAgICAgIHRoaXMub3V0ZXJFbC5hdHRyKCJpZCIsIHRoaXMuZ2V0SWQoKSArICItZm9ybS1vdXRlciIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNFbXB0eSh0aGlzLm91dGVyRWwuYXR0cigiYWxwYWNhLWZpZWxkLWlkIikpKSB7CiAgICAgICAgICAgICAgICB0aGlzLm91dGVyRWwuYXR0cigiYWxwYWNhLWZpZWxkLWlkIiwgdGhpcy5nZXRJZCgpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZ2V0IGNvbnRhaW5lciBmb3IgZm9ybXMKICAgICAgICAgICAgaWYgKCQoJy5hbHBhY2EtZm9ybS1maWVsZHMtY29udGFpbmVyJywgdGhpcy5vdXRlckVsKSkgewogICAgICAgICAgICAgICAgdGhpcy5mb3JtRmllbGRzQ29udGFpbmVyID0gJCgnLmFscGFjYS1mb3JtLWZpZWxkcy1jb250YWluZXInLCB0aGlzLm91dGVyRWwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5mb3JtRmllbGRzQ29udGFpbmVyID0gdGhpcy5vdXRlckVsOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyB0aGUgZm9ybSBmaWVsZAogICAgICAgICAgICB0aGlzLmZpZWxkID0gJCgnZm9ybScsIHRoaXMuY29udGFpbmVyKTsKICAgICAgICAgICAgaWYgKHRoaXMuZmllbGQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIGFkZCBhbGwgcHJvdmlkZWQgYXR0cmlidXRlcwogICAgICAgICAgICAgICAgdGhpcy5maWVsZC5hdHRyKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHBvcHVsYXRlIHRoZSBidXR0b25zIGFzIHdlbGwKICAgICAgICAgICAgdGhpcy5idXR0b25zID0ge307CiAgICAgICAgICAgICQuZWFjaCgkKCcuYWxwYWNhLWZvcm0tYnV0dG9uJywgdGhpcy5jb250YWluZXIpLGZ1bmN0aW9uKGssdikgewoKICAgICAgICAgICAgICAgIC8vIFRPRE86IHRoaXMgaXMgdGVjaG5pY2FsbHkgd3Jvbmcgc2luY2Ugd2Ugb25seSB3YW50IHRvIHRyYXAgZm9yIGxlZnQtbW91c2Vkb3duLi4uCiAgICAgICAgICAgICAgICAkKHYpLm1vdXNlZG93bihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX3RoaXMgPSAkKHRoaXMpOwogICAgICAgICAgICAgICAgICAgIF90aGlzLmF0dHIoImJ1dHRvbi1wdXNoZWQiLCJ0cnVlIik7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF90aGlzLmF0dHIoImJ1dHRvbi1wdXNoZWQiKSAmJiBfdGhpcy5hdHRyKCJidXR0b24tcHVzaGVkIikgPT0gInRydWUiICkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY2xpY2soKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIDE1MCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICQodikuY2xpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5yZW1vdmVBdHRyKCJidXR0b24tcHVzaGVkIik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIF90aGlzLmJ1dHRvbnNbJCh2KS5hdHRyKCdkYXRhLWtleScpXSA9ICQodik7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgb25TdWNjZXNzKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0cmlldmUgdGhlIGZvcm0gY29udGFpbmVyLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gRm9ybSBjb250YWluZXIuCiAgICAgICAgICovCiAgICAgICAgZ2V0RWw6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5vdXRlckVsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgdGhlIGlkIG9mIHRoZSBmb3JtLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge1N0cmluZ30gRm9ybSBpZAogICAgICAgICAqLwogICAgICAgIGdldElkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuaWQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyBmb3JtIHR5cGUuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBGb3JtIHR5cGUuCiAgICAgICAgICovCiAgICAgICAgZ2V0VHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnR5cGU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGlzIGZvcm0ncyBwYXJlbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBGb3JtIHBhcmVudC4KICAgICAgICAgKi8KICAgICAgICBnZXRQYXJlbnQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJlbnQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGUgdmFsdWUgb2YgdGhlIEpTT04gcmVuZGVyZWQgYnkgdGhpcyBmb3JtLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0FueX0gVmFsdWUgb2YgdGhlIEpTT04gcmVuZGVyZWQgYnkgdGhpcyBmb3JtLgogICAgICAgICAqLwogICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudG9wQ29udHJvbC5nZXRWYWx1ZSgpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFNldHMgdGhlIHZhbHVlIG9mIHRoZSBKU09OIHRvIGJlIHJlbmRlcmVkIGJ5IHRoaXMgZm9ybS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7QW55fSB2YWx1ZSBWYWx1ZSB0byBiZSBzZXQuCiAgICAgICAgICovCiAgICAgICAgc2V0VmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMudG9wQ29udHJvbC5zZXRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogSW5pdGlhbGl6ZXMgZXZlbnRzIGhhbmRsaW5nIChGb3JtIFN1Ym1pc3Npb24pIGZvciB0aGlzIGZvcm0uCiAgICAgICAgICovCiAgICAgICAgaW5pdEV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkKSB7CiAgICAgICAgICAgICAgICB2YXIgdiA9IHRoaXMuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgICAgICQodGhpcy5maWVsZCkuc3VibWl0KHYsIGZ1bmN0aW9uKGUpIHsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLm9uU3VibWl0KGUsIF90aGlzKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBsaXN0ZW4gZm9yIGZpZWxkdXBkYXRlcyBhbmQgZGV0ZXJtaW5lIHdoZXRoZXIgdGhlIGZvcm0gaXMgdmFsaWQuCiAgICAgICAgICAgIC8vIGlmIHNvLCBlbmFibGUgdGhlIHN1Ym1pdCBidXR0b24uLi4KICAgICAgICAgICAgLy8gb3RoZXJ3aXNlLCBkaXNhYmxlIGl0CiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMudG9nZ2xlU3VibWl0VmFsaWRTdGF0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgJChfdGhpcy50b3BDb250cm9sLmdldEVsKCkpLmJpbmQoImZpZWxkdXBkYXRlIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuYWRqdXN0U3VibWl0QnV0dG9uU3RhdGUoKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHRoaXMuYWRqdXN0U3VibWl0QnV0dG9uU3RhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEhhbmRsZXMgZm9ybSBzdWJtaXQgZXZlbnRzLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGUgU3VibWl0IGV2ZW50LgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBmb3JtIHRoZSBmb3JtCiAgICAgICAgICovCiAgICAgICAgb25TdWJtaXQ6IGZ1bmN0aW9uKGUsIGZvcm0pIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3VibWl0SGFuZGxlcikgewogICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKCiAgICAgICAgICAgICAgICB2YXIgdiA9IHRoaXMuc3VibWl0SGFuZGxlcihlLCBmb3JtKTsKICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNVbmRlZmluZWQodikpIHsKICAgICAgICAgICAgICAgICAgICB2ID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIHY7CgogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVnaXN0ZXJzIGEgY3VzdG9tIHN1Ym1pdCBoYW5kbGVyLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGZ1bmMgU3VibWl0IGhhbmRsZXIgdG8gYmUgcmVnaXN0ZXJlZC4KICAgICAgICAgKi8KICAgICAgICByZWdpc3RlclN1Ym1pdEhhbmRsZXI6IGZ1bmN0aW9uIChmdW5jKSB7CiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNGdW5jdGlvbihmdW5jKSkgewogICAgICAgICAgICAgICAgdGhpcy5zdWJtaXRIYW5kbGVyID0gZnVuYzsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIERpc3BsYXlzIHZhbGlkYXRpb24gaW5mb3JtYXRpb24gb2YgYWxsIGZpZWxkcyBvZiB0aGlzIGZvcm0uCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IGNoaWxkcmVuIHdoZXRoZXIgdG8gcmVuZGVyIHZhbGlkYXRpb24gc3RhdGUgZm9yIGNoaWxkIGZpZWxkcwogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gRm9ybSB2YWxpZGF0aW9uIHN0YXRlLgogICAgICAgICAqLwogICAgICAgIHJlZnJlc2hWYWxpZGF0aW9uU3RhdGU6IGZ1bmN0aW9uKGNoaWxkcmVuKSB7CiAgICAgICAgICAgIHRoaXMudG9wQ29udHJvbC5yZWZyZXNoVmFsaWRhdGlvblN0YXRlKGNoaWxkcmVuKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBEaXNhYmxlcyB0aGlzIGZvcm0uCiAgICAgICAgICovCiAgICAgICAgZGlzYWJsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMudG9wQ29udHJvbC5kaXNhYmxlKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogRW5hYmxlcyB0aGlzIGZvcm0uCiAgICAgICAgICovCiAgICAgICAgZW5hYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy50b3BDb250cm9sLmVuYWJsZSgpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEZvY3VzZXMgb24gdGhpcyBmb3JtLgogICAgICAgICAqLwogICAgICAgIGZvY3VzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy50b3BDb250cm9sLmZvY3VzKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUHVyZ2UgYW55IGV2ZW50IGxpc3RlbmVycyBhbmQgcmVtb3ZlIHRoZSBmb3JtIGZyb20gdGhlIERPTS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBbQm9vbGVhbl0gc2tpcFBhcmVudCB3aGVuIHRydWUsIHRoZSBmb3JtIGNsZWFucyB1cCB3aXRob3V0IHRyYXZlcnNpbmcgdGhyb3VnaCBwYXJlbnQgY2hpbGQgY29udHJvbHMKICAgICAgICAgKi8KICAgICAgICBkZXN0cm95OiBmdW5jdGlvbihza2lwUGFyZW50KSB7CgogICAgICAgICAgICB0aGlzLmdldEVsKCkucmVtb3ZlKCk7CgogICAgICAgICAgICAvLyB3ZSBhbGxvdyBmb3JtLmRlc3Ryb3koKSB3aGljaCB0ZWxscyBwYXJlbnQgY29udHJvbCB0byBkZXN0cm95CiAgICAgICAgICAgIC8vIGlmIHNraXBQYXJlbnQgPT0gdHJ1ZSwgdGhlbiB3ZSBkbyBub3QgY2FsbCB1cCAoaW52b2tlZCBmcm9tIGNvbnRhaW5lcikKICAgICAgICAgICAgaWYgKCFza2lwUGFyZW50ICYmIHRoaXMucGFyZW50KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnBhcmVudC5kZXN0cm95KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBTaG93cyB0aGUgZm9ybS4KICAgICAgICAgKi8KICAgICAgICBzaG93OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5nZXRFbCgpLmNzcyh7CiAgICAgICAgICAgICAgICAiZGlzcGxheSI6ICIiCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEhpZGVzIHRoZSBmb3JtLgogICAgICAgICAqLwogICAgICAgIGhpZGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmdldEVsKCkuY3NzKHsKICAgICAgICAgICAgICAgICJkaXNwbGF5IjogIm5vbmUiCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENsZWFycyB0aGUgZm9ybSBhbmQgcmVzZXRzIHZhbHVlcyBvZiBpdHMgZmllbGRzLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHN0b3BVcGRhdGVUcmlnZ2VyIElmIGZhbHNlLCB0cmlnZ2VycyB0aGUgdXBkYXRlIGV2ZW50IG9mIHRoaXMgZXZlbnQuCiAgICAgICAgICovCiAgICAgICAgY2xlYXI6IGZ1bmN0aW9uKHN0b3BVcGRhdGVUcmlnZ2VyKSB7CiAgICAgICAgICAgIHRoaXMudG9wQ29udHJvbC5jbGVhcihzdG9wVXBkYXRlVHJpZ2dlcik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ2hlY2tzIGlmIGZvcm0gaXMgZW1wdHkuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZiB0aGUgZm9ybSBpcyBlbXB0eSwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIGlzRW1wdHk6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy50b3BDb250cm9sLmlzRW1wdHkoKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIHRoZSBmb3JtIHRlbXBsYXRlLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge09iamVjdHxTdHJpbmd9IHRlbXBsYXRlIEZvcm0gdGVtcGxhdGUuCiAgICAgICAgICovCiAgICAgICAgZ2V0VGVtcGxhdGVEZXNjcmlwdG9yOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudGVtcGxhdGVEZXNjcmlwdG9yOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFNldHMgdGhlIGZvcm0gdGVtcGxhdGUuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdGVtcGxhdGVEZXNjcmlwdG9yIFRlbXBsYXRlIHRvIGJlIHNldAogICAgICAgICAqLwogICAgICAgIHNldFRlbXBsYXRlRGVzY3JpcHRvcjogZnVuY3Rpb24odGVtcGxhdGVEZXNjcmlwdG9yKSB7CiAgICAgICAgICAgIHRoaXMudGVtcGxhdGVEZXNjcmlwdG9yID0gdGVtcGxhdGVEZXNjcmlwdG9yOwogICAgICAgIH0KCiAgICB9KTsKCn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkID0gQWxwYWNhLkNvbnRyb2xGaWVsZC5leHRlbmQoCiAgICAvKioKICAgICAqIEBsZW5kcyBBbHBhY2EuRmllbGRzLlRleHRGaWVsZC5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5Db250cm9sRmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBCYXNpYyBjb250cm9sIGZvciBnZW5lcmFsIHRleHQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI3NldHVwCiAgICAgICAgICovCiAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmJhc2UoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghdGhpcy5vcHRpb25zLnNpemUpIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5zaXplID0gNDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuY29udHJvbEZpZWxkVGVtcGxhdGVEZXNjcmlwdG9yID0gdGhpcy52aWV3LmdldFRlbXBsYXRlRGVzY3JpcHRvcigiY29udHJvbEZpZWxkVGV4dCIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2Rlc3Ryb3kKICAgICAgICAgKi8KICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgLy8gY2xlYW4gdXAgdHlwZWFoZWFkCiAgICAgICAgICAgIGlmICggdGhpcy5maWVsZCAmJiB0aGlzLmZpZWxkLnR5cGVhaGVhZCAmJiB0aGlzLm9wdGlvbnMudHlwZWFoZWFkKSB7CiAgICAgICAgICAgICAgICAkKHRoaXMuZmllbGQpLnR5cGVhaGVhZCgnZGVzdHJveScpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI3JlbmRlckZpZWxkCiAgICAgICAgICovCiAgICAgICAgcmVuZGVyRmllbGQ6IGZ1bmN0aW9uKG9uU3VjY2VzcykgewoKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIGlmICh0aGlzLmNvbnRyb2xGaWVsZFRlbXBsYXRlRGVzY3JpcHRvcikgewoKICAgICAgICAgICAgICAgIHRoaXMuZmllbGQgPSBfdGhpcy52aWV3LnRtcGwodGhpcy5jb250cm9sRmllbGRUZW1wbGF0ZURlc2NyaXB0b3IsIHsKICAgICAgICAgICAgICAgICAgICAiaWQiOiB0aGlzLmdldElkKCksCiAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiB0aGlzLm5hbWUsCiAgICAgICAgICAgICAgICAgICAgIm9wdGlvbnMiOiB0aGlzLm9wdGlvbnMKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdGhpcy5pbmplY3RGaWVsZCh0aGlzLmZpZWxkKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9uU3VjY2VzcykgewogICAgICAgICAgICAgICAgb25TdWNjZXNzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIAogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRyb2xGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBtYXNrIGl0CiAgICAgICAgICAgICAgICAgICAgaWYgKCBzZWxmLmZpZWxkICYmIHNlbGYuZmllbGQubWFzayAmJiBzZWxmLm9wdGlvbnMubWFza1N0cmluZykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGQubWFzayhzZWxmLm9wdGlvbnMubWFza1N0cmluZyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyB0eXBlYWhlYWQ/CiAgICAgICAgICAgICAgICAgICAgaWYgKCBzZWxmLmZpZWxkICYmIHNlbGYuZmllbGQudHlwZWFoZWFkICYmIHNlbGYub3B0aW9ucy50eXBlYWhlYWQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdENvbmZpZyA9IHNlbGYub3B0aW9ucy50eXBlYWhlYWQuY29uZmlnOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRDb25maWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRDb25maWcgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHREYXRhc2V0cyA9IHNlbGYub3B0aW9ucy50eXBlYWhlYWQuZGF0YXNldHM7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdERhdGFzZXRzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0RGF0YXNldHMgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0RGF0YXNldHMubmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdERhdGFzZXRzLm5hbWUgPSBzZWxmLmdldElkKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0RXZlbnRzID0gc2VsZi5vcHRpb25zLnR5cGVhaGVhZC5ldmVudHM7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdEV2ZW50cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdEV2ZW50cyA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBzdXBwb3J0IGZvciBlYWNoIGRhdGFzZXRzIChsb2NhbCwgcHJlZmV0Y2gsIHJlbW90ZSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHREYXRhc2V0cy50eXBlID09ICJsb2NhbCIgfHwgdERhdGFzZXRzLnR5cGUgPT0gInJlbW90ZSIgfHwgdERhdGFzZXRzLnR5cGUgPT0gInByZWZldGNoIikKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJsb29kSG91bmRDb25maWcgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0dW1Ub2tlbml6ZXI6IGZ1bmN0aW9uKGQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEJsb29kaG91bmQudG9rZW5pemVycy53aGl0ZXNwYWNlKGQudmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcXVlcnlUb2tlbml6ZXI6IEJsb29kaG91bmQudG9rZW5pemVycy53aGl0ZXNwYWNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0RGF0YXNldHMudHlwZSA9PSAibG9jYWwiICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbG9jYWwgPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0RGF0YXNldHMuc291cmNlLmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxvY2FsRWxlbWVudCA9IHREYXRhc2V0cy5zb3VyY2VbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YobG9jYWxFbGVtZW50KSA9PSAic3RyaW5nIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxFbGVtZW50ID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IGxvY2FsRWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWwucHVzaChsb2NhbEVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxvb2RIb3VuZENvbmZpZy5sb2NhbCA9IGxvY2FsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0RGF0YXNldHMudHlwZSA9PSAicHJlZmV0Y2giKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb29kSG91bmRDb25maWcucHJlZmV0Y2ggPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdERhdGFzZXRzLnNvdXJjZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0RGF0YXNldHMuZmlsdGVyKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxvb2RIb3VuZENvbmZpZy5wcmVmZXRjaC5maWx0ZXIgPSB0RGF0YXNldHMuZmlsdGVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodERhdGFzZXRzLnR5cGUgPT0gInJlbW90ZSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxvb2RIb3VuZENvbmZpZy5yZW1vdGUgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdERhdGFzZXRzLnNvdXJjZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0RGF0YXNldHMuZmlsdGVyKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxvb2RIb3VuZENvbmZpZy5yZW1vdGUuZmlsdGVyID0gdERhdGFzZXRzLmZpbHRlcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0RGF0YXNldHMucmVwbGFjZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb29kSG91bmRDb25maWcucmVtb3RlLnJlcGxhY2UgPSB0RGF0YXNldHMucmVwbGFjZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVuZ2luZSA9IG5ldyBCbG9vZGhvdW5kKGJsb29kSG91bmRDb25maWcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lLmluaXRpYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHREYXRhc2V0cy5zb3VyY2UgPSBlbmdpbmUudHRBZGFwdGVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb21waWxlIHRlbXBsYXRlcwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodERhdGFzZXRzLnRlbXBsYXRlcykKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayBpbiB0RGF0YXNldHMudGVtcGxhdGVzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHREYXRhc2V0cy50ZW1wbGF0ZXNba107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZih0ZW1wbGF0ZSkgPT0gInN0cmluZyIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0RGF0YXNldHMudGVtcGxhdGVzW2tdID0gSGFuZGxlYmFycy5jb21waWxlKHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHByb2Nlc3MgdHlwZWFoZWFkCiAgICAgICAgICAgICAgICAgICAgICAgICQoc2VsZi5maWVsZCkudHlwZWFoZWFkKHRDb25maWcsIHREYXRhc2V0cyk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBsaXN0ZW4gZm9yICJhdXRvY29tcGxldGVkIiBldmVudCBhbmQgc2V0IHRoZSB2YWx1ZSBvZiB0aGUgZmllbGQKICAgICAgICAgICAgICAgICAgICAgICAgJChzZWxmLmZpZWxkKS5vbigidHlwZWFoZWFkOmF1dG9jb21wbGV0ZWQiLCBmdW5jdGlvbihldmVudCwgZGF0dW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2V0VmFsdWUoZGF0dW0udmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxpc3RlbiBmb3IgInNlbGVjdGVkIiBldmVudCBhbmQgc2V0IHRoZSB2YWx1ZSBvZiB0aGUgZmllbGQKICAgICAgICAgICAgICAgICAgICAgICAgJChzZWxmLmZpZWxkKS5vbigidHlwZWFoZWFkOnNlbGVjdGVkIiwgZnVuY3Rpb24oZXZlbnQsIGRhdHVtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNldFZhbHVlKGRhdHVtLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBjdXN0b20gZXZlbnRzCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0RXZlbnRzKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodEV2ZW50cy5hdXRvY29tcGxldGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJChzZWxmLmZpZWxkKS5vbigidHlwZWFoZWFkOmF1dG9jb21wbGV0ZWQiLCBmdW5jdGlvbihldmVudCwgZGF0dW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdEV2ZW50cy5hdXRvY29tcGxldGVkKGV2ZW50LCBkYXR1bSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodEV2ZW50cy5zZWxlY3RlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoc2VsZi5maWVsZCkub24oInR5cGVhaGVhZDpzZWxlY3RlZCIsIGZ1bmN0aW9uKGV2ZW50LCBkYXR1bSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0RXZlbnRzLnNlbGVjdGVkKGV2ZW50LCBkYXR1bSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdoZW4gdGhlIGlucHV0IHZhbHVlIGNoYW5nZXMsIGNoYW5nZSB0aGUgcXVlcnkgaW4gdHlwZWFoZWFkCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgaXMgdG8ga2VlcCB0aGUgdHlwZWFoZWFkIGNvbnRyb2wgc3luYydkIHdpdGggdGhlIGFjdHVhbCBkb20gdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgLy8gb25seSBkbyB0aGlzIGlmIHRoZSBxdWVyeSBkb2Vzbid0IGFscmVhZHkgbWF0Y2gKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZpID0gJChzZWxmLmZpZWxkKTsKICAgICAgICAgICAgICAgICAgICAgICAgJChzZWxmLmZpZWxkKS5jaGFuZ2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gJCh0aGlzKS52YWwoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3VmFsdWUgPSAkKGZpKS50eXBlYWhlYWQoJ3ZhbCcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ld1ZhbHVlICE9IHZhbHVlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoZmkpLnR5cGVhaGVhZCgndmFsJywgbmV3VmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLXRleHQnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgfSk7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldFZhbHVlCiAgICAgICAgICovCiAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBudWxsOwogICAgICAgICAgICBpZiAodGhpcy5maWVsZCkgewogICAgICAgICAgICAgICAgdmFsdWUgPSB0aGlzLmZpZWxkLnZhbCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFsdWUgPSB0aGlzLmJhc2UoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjc2V0VmFsdWUKICAgICAgICAgKi8KICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKCiAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkodmFsdWUpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGQudmFsKCIiKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdXNpbmcgdHlwZWFoZWFkLCBzZXQgdXNpbmcgdHlwZWFoZWFkIGNvbnRyb2wKICAgICAgICAgICAgICAgICAgICBpZiAoIHRoaXMuZmllbGQgJiYgdGhpcy5maWVsZC50eXBlYWhlYWQgJiYgdGhpcy5vcHRpb25zLnR5cGVhaGVhZCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcy5maWVsZCkudHlwZWFoZWFkKCd2YWwnLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGQudmFsKHZhbHVlKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdXNpbmcgdHlwZWFoZWFkLCBzZXQgdXNpbmcgdHlwZWFoZWFkIGNvbnRyb2wKICAgICAgICAgICAgICAgICAgICBpZiAoIHRoaXMuZmllbGQgJiYgdGhpcy5maWVsZC50eXBlYWhlYWQgJiYgdGhpcy5vcHRpb25zLnR5cGVhaGVhZCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcy5maWVsZCkudHlwZWFoZWFkKCd2YWwnLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBiZSBzdXJlIHRvIGNhbGwgaW50byBiYXNlIG1ldGhvZAogICAgICAgICAgICB0aGlzLmJhc2UodmFsdWUpOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2hhbmRsZVZhbGlkYXRlCiAgICAgICAgICovCiAgICAgICAgaGFuZGxlVmFsaWRhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYmFzZVN0YXR1cyA9IHRoaXMuYmFzZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHZhbEluZm8gPSB0aGlzLnZhbGlkYXRpb247CgkJCQoJCQl2YXIgc3RhdHVzID0gIHRoaXMuX3ZhbGlkYXRlUGF0dGVybigpOwogICAgICAgICAgICB2YWxJbmZvWyJpbnZhbGlkUGF0dGVybiJdID0gewogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiBzdGF0dXMgPyAiIiA6IEFscGFjYS5zdWJzdGl0dXRlVG9rZW5zKHRoaXMudmlldy5nZXRNZXNzYWdlKCJpbnZhbGlkUGF0dGVybiIpLCBbdGhpcy5zY2hlbWEucGF0dGVybl0pLAogICAgICAgICAgICAgICAgInN0YXR1cyI6IHN0YXR1cwogICAgICAgICAgICB9OwogCiAgICAgICAgICAgIHN0YXR1cyA9IHRoaXMuX3ZhbGlkYXRlTWF4TGVuZ3RoKCk7CgkJCXZhbEluZm9bInN0cmluZ1Rvb0xvbmciXSA9IHsKICAgICAgICAgICAgICAgICJtZXNzYWdlIjogc3RhdHVzID8gIiIgOiBBbHBhY2Euc3Vic3RpdHV0ZVRva2Vucyh0aGlzLnZpZXcuZ2V0TWVzc2FnZSgic3RyaW5nVG9vTG9uZyIpLCBbdGhpcy5zY2hlbWEubWF4TGVuZ3RoXSksCiAgICAgICAgICAgICAgICAic3RhdHVzIjogc3RhdHVzCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBzdGF0dXMgPSB0aGlzLl92YWxpZGF0ZU1pbkxlbmd0aCgpOwoJCQl2YWxJbmZvWyJzdHJpbmdUb29TaG9ydCJdID0gewogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiBzdGF0dXMgPyAiIiA6IEFscGFjYS5zdWJzdGl0dXRlVG9rZW5zKHRoaXMudmlldy5nZXRNZXNzYWdlKCJzdHJpbmdUb29TaG9ydCIpLCBbdGhpcy5zY2hlbWEubWluTGVuZ3RoXSksCiAgICAgICAgICAgICAgICAic3RhdHVzIjogc3RhdHVzCiAgICAgICAgICAgIH07CgogICAgICAgICAgICByZXR1cm4gYmFzZVN0YXR1cyAmJiB2YWxJbmZvWyJpbnZhbGlkUGF0dGVybiJdWyJzdGF0dXMiXSAmJiB2YWxJbmZvWyJzdHJpbmdUb29Mb25nIl1bInN0YXR1cyJdICYmIHZhbEluZm9bInN0cmluZ1Rvb1Nob3J0Il1bInN0YXR1cyJdOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaWRhdGVzIGFnYWluc3QgdGhlIHNjaGVtYSBwYXR0ZXJuIHByb3BlcnR5LgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgaXQgbWF0Y2hlcyB0aGUgcGF0dGVybiwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZVBhdHRlcm46IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5zY2hlbWEucGF0dGVybikgewogICAgICAgICAgICAgICAgdmFyIHZhbCA9IHRoaXMuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgICAgIGlmICh2YWwgPT09ICIiICYmIHRoaXMub3B0aW9ucy5hbGxvd09wdGlvbmFsRW1wdHkgJiYgIXRoaXMuc2NoZW1hLnJlcXVpcmVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkodmFsKSkgewogICAgICAgICAgICAgICAgICAgIHZhbCA9ICIiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCF2YWwubWF0Y2godGhpcy5zY2hlbWEucGF0dGVybikpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaWRhdGVzIGFnYWluc3QgdGhlIHNjaGVtYSBtaW5MZW5ndGggcHJvcGVydHkuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZiBpdHMgc2l6ZSBpcyBncmVhdGVyIHRoYW4gbWluTGVuZ3RoLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgX3ZhbGlkYXRlTWluTGVuZ3RoOiBmdW5jdGlvbigpIHsKCQkJaWYgKCFBbHBhY2EuaXNFbXB0eSh0aGlzLnNjaGVtYS5taW5MZW5ndGgpKSB7CgkJCQl2YXIgdmFsID0gdGhpcy5nZXRWYWx1ZSgpOwogICAgICAgICAgICAgICAgaWYgKHZhbCA9PT0gIiIgJiYgdGhpcy5vcHRpb25zLmFsbG93T3B0aW9uYWxFbXB0eSAmJiAhdGhpcy5zY2hlbWEucmVxdWlyZWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNFbXB0eSh2YWwpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsID0gIiI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodmFsLmxlbmd0aCA8IHRoaXMuc2NoZW1hLm1pbkxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCQkJfQoJCQlyZXR1cm4gdHJ1ZTsKCQl9LAogICAgICAgIAogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlcyBhZ2FpbnN0IHRoZSBzY2hlbWEgbWF4TGVuZ3RoIHByb3BlcnR5LgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgaXRzIHNpemUgaXMgbGVzcyB0aGFuIG1heExlbmd0aCAsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgKi8KICAgICAgICBfdmFsaWRhdGVNYXhMZW5ndGg6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIUFscGFjYS5pc0VtcHR5KHRoaXMuc2NoZW1hLm1heExlbmd0aCkpIHsKCQkJCXZhciB2YWwgPSB0aGlzLmdldFZhbHVlKCk7CiAgICAgICAgICAgICAgICBpZiAodmFsID09PSAiIiAmJiB0aGlzLm9wdGlvbnMuYWxsb3dPcHRpb25hbEVtcHR5ICYmICF0aGlzLnNjaGVtYS5yZXF1aXJlZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKEFscGFjYS5pc0VtcHR5KHZhbCkpIHsKICAgICAgICAgICAgICAgICAgICB2YWwgPSAiIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh2YWwubGVuZ3RoID4gdGhpcy5zY2hlbWEubWF4TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQoJCQl9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZGlzYWJsZQogICAgICAgICAqLwogICAgICAgIGRpc2FibGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5maWVsZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5maWVsZC5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIAogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2VuYWJsZQogICAgICAgICAqLwogICAgICAgIGVuYWJsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLmRpc2FibGVkID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIAogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2ZvY3VzCiAgICAgICAgICovCiAgICAgICAgZm9jdXM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5maWVsZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5maWVsZC5mb2N1cygpOwogICAgICAgICAgICB9CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjZ2V0U2NoZW1hT2ZTY2hlbWEKICAgICAgICAgKi8KICAgICAgICBnZXRTY2hlbWFPZlNjaGVtYTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogeyAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAibWluTGVuZ3RoIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiTWluaW1hbCBMZW5ndGgiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiTWluaW1hbCBsZW5ndGggb2YgdGhlIHByb3BlcnR5IHZhbHVlLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm51bWJlciIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJtYXhMZW5ndGgiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJNYXhpbXVtIExlbmd0aCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJNYXhpbXVtIGxlbmd0aCBvZiB0aGUgcHJvcGVydHkgdmFsdWUuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibnVtYmVyIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInBhdHRlcm4iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJQYXR0ZXJuIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlJlZ3VsYXIgZXhwcmVzc2lvbiBmb3IgdGhlIHByb3BlcnR5IHZhbHVlLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2dldE9wdGlvbnNGb3JTY2hlbWEKICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yU2NoZW1hOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgImZpZWxkcyI6IHsKICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgImhlbHBlciI6ICJGaWVsZCBkZWZhdWx0IHZhbHVlIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJtaW5MZW5ndGgiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAibWF4TGVuZ3RoIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInBhdHRlcm4iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRleHQiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoJCQogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2dldFNjaGVtYU9mT3B0aW9ucwogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogeyAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAic2l6ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZpZWxkIFNpemUiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRmllbGQgc2l6ZS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJudW1iZXIiLAoJCQkJCQkiZGVmYXVsdCI6NDAKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJtYXNrU3RyaW5nIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiTWFzayBFeHByZXNzaW9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkV4cHJlc3Npb24gZm9yIHRoZSBmaWVsZCBtYXNrLiBGaWVsZCBtYXNraW5nIHdpbGwgYmUgZW5hYmxlZCBpZiBub3QgZW1wdHkuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInBsYWNlaG9sZGVyIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRmllbGQgUGxhY2Vob2xkZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRmllbGQgcGxhY2Vob2xkZXIuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInR5cGVhaGVhZCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlR5cGUgQWhlYWQiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiUHJvdmlkZXMgY29uZmlndXJhdGlvbiBmb3IgdGhlICQudHlwZWFoZWFkIHBsdWdpbiBpZiBpdCBpcyBhdmFpbGFibGUuICBGb3IgZnVsbCBjb25maWd1cmF0aW9uIG9wdGlvbnMsIHNlZTogaHR0cHM6Ly9naXRodWIuY29tL3R3aXR0ZXIvdHlwZWFoZWFkLmpzIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImFsbG93T3B0aW9uYWxFbXB0eSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkFsbG93IE9wdGlvbmFsIEVtcHR5IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkFsbG93cyB0aGlzIG5vbi1yZXF1aXJlZCBmaWVsZCB0byB2YWxpZGF0ZSB3aGVuIHRoZSB2YWx1ZSBpcyBlbXB0eSIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sICAgIAoJCQogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2dldE9wdGlvbnNGb3JPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0Zvck9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAiZmllbGRzIjogeyAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAic2l6ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJtYXNrU3RyaW5nIjogewogICAgICAgICAgICAgICAgICAgICAgICAiaGVscGVyIjogImEgLSBhbiBhbHBoYSBjaGFyYWN0ZXI7OSAtIGEgbnVtZXJpYyBjaGFyYWN0ZXI7KiAtIGFuIGFscGhhbnVtZXJpYyBjaGFyYWN0ZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInR5cGVhaGVhZCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAib2JqZWN0IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImFsbG93T3B0aW9uYWxFbXB0eSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiY2hlY2tib3giCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LCAgICAKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZ2V0VGl0bGUKICAgICAgICAgKi8KICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiU2luZ2xlLUxpbmUgVGV4dCI7CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJUZXh0IGZpZWxkIGZvciBzaW5nbGUtbGluZSB0ZXh0LiI7CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0VHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAic3RyaW5nIjsKICAgICAgICB9LAoJCQogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAidGV4dCI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICAgICAgCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJUZW1wbGF0ZSgiY29udHJvbEZpZWxkVGV4dCIsICc8aW5wdXQgdHlwZT0idGV4dCIgaWQ9IiR7aWR9IiB7e2lmIG9wdGlvbnMucGxhY2Vob2xkZXJ9fXBsYWNlaG9sZGVyPSIke29wdGlvbnMucGxhY2Vob2xkZXJ9Int7L2lmfX0ge3tpZiBvcHRpb25zLnNpemV9fXNpemU9IiR7b3B0aW9ucy5zaXplfSJ7ey9pZn19IHt7aWYgb3B0aW9ucy5yZWFkb25seX19cmVhZG9ubHk9InJlYWRvbmx5Int7L2lmfX0ge3tpZiBuYW1lfX1uYW1lPSIke25hbWV9Int7L2lmfX0ge3tlYWNoKGksdikgb3B0aW9ucy5kYXRhfX1kYXRhLSR7aX09IiR7dn0ie3svZWFjaH19Lz4nKTsKICAgIEFscGFjYS5yZWdpc3Rlck1lc3NhZ2VzKHsKICAgICAgICAiaW52YWxpZFBhdHRlcm4iOiAiVGhpcyBmaWVsZCBzaG91bGQgaGF2ZSBwYXR0ZXJuIHswfSIsCiAgICAgICAgInN0cmluZ1Rvb1Nob3J0IjogIlRoaXMgZmllbGQgc2hvdWxkIGNvbnRhaW4gYXQgbGVhc3QgezB9IG51bWJlcnMgb3IgY2hhcmFjdGVycyIsCiAgICAgICAgInN0cmluZ1Rvb0xvbmciOiAiVGhpcyBmaWVsZCBzaG91bGQgY29udGFpbiBhdCBtb3N0IHswfSBudW1iZXJzIG9yIGNoYXJhY3RlcnMiCiAgICB9KTsKICAgIEFscGFjYS5yZWdpc3RlckZpZWxkQ2xhc3MoInRleHQiLCBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCk7CiAgICBBbHBhY2EucmVnaXN0ZXJEZWZhdWx0U2NoZW1hRmllbGRNYXBwaW5nKCJzdHJpbmciLCAidGV4dCIpOwp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLlRleHRBcmVhRmllbGQgPSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZC5leHRlbmQoCiAgICAvKioKICAgICAqIEBsZW5kcyBBbHBhY2EuRmllbGRzLlRleHRBcmVhRmllbGQucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuRmllbGRzLlRleHRGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIFRleHRhcmVhIGNvbnRyb2wgZm9yIGNodW5rIG9mIHRleHQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjc2V0dXAKICAgICAgICAgKi8KICAgICAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMucm93cykgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLnJvd3MgPSA1OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5jb2xzKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuY29scyA9IDQwOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmNvbnRyb2xGaWVsZFRlbXBsYXRlRGVzY3JpcHRvciA9IHRoaXMudmlldy5nZXRUZW1wbGF0ZURlc2NyaXB0b3IoImNvbnRyb2xGaWVsZFRleHRhcmVhIik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtdGV4dGFyZWEnKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjaGFuZGxlVmFsaWRhdGUKICAgICAgICAgKi8KICAgICAgICBoYW5kbGVWYWxpZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBiYXNlU3RhdHVzID0gdGhpcy5iYXNlKCk7CgogICAgICAgICAgICB2YXIgdmFsSW5mbyA9IHRoaXMudmFsaWRhdGlvbjsKCiAgICAgICAgICAgIHZhciBzdGF0dXMgPSAgdGhpcy5fdmFsaWRhdGVXb3JkQ291bnQoKTsKICAgICAgICAgICAgdmFsSW5mb1sid29yZExpbWl0RXhjZWVkZWQiXSA9IHsKICAgICAgICAgICAgICAgICJtZXNzYWdlIjogc3RhdHVzID8gIiIgOiBBbHBhY2Euc3Vic3RpdHV0ZVRva2Vucyh0aGlzLnZpZXcuZ2V0TWVzc2FnZSgid29yZExpbWl0RXhjZWVkZWQiKSwgW3RoaXMub3B0aW9ucy53b3JkbGltaXRdKSwKICAgICAgICAgICAgICAgICJzdGF0dXMiOiBzdGF0dXMKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBiYXNlU3RhdHVzICYmIHZhbEluZm9bIndvcmRMaW1pdEV4Y2VlZGVkIl1bInN0YXR1cyJdOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlIGZvciB3b3JkIGxpbWl0LgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgdGhlIG51bWJlciBvZiB3b3JkcyBpcyBlcXVhbCB0byBvciBsZXNzIHRoYW4gdGhlIHdvcmQgbGltaXQuCiAgICAgICAgICovCiAgICAgICAgX3ZhbGlkYXRlV29yZENvdW50OiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMud29yZGxpbWl0ICYmIHRoaXMub3B0aW9ucy53b3JkbGltaXQgPiAtMSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHZhbCA9IHRoaXMuZGF0YTsKCiAgICAgICAgICAgICAgICBpZiAodmFsKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciB3b3JkY291bnQgPSB2YWwuc3BsaXQoIiAiKS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdvcmRjb3VudCA+IHRoaXMub3B0aW9ucy53b3JkbGltaXQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICpAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI3NldFZhbHVlCiAgICAgICAgICovCiAgICAgICAgc2V0VmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICQodGhpcy5maWVsZCkudmFsKHZhbHVlKTsKCiAgICAgICAgICAgIC8vIGJlIHN1cmUgdG8gY2FsbCBpbnRvIGJhc2UgbWV0aG9kCiAgICAgICAgICAgIHRoaXMuYmFzZSh2YWx1ZSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRWYWx1ZQogICAgICAgICAqLwogICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICQodGhpcy5maWVsZCkudmFsKCk7CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRTY2hlbWFPZk9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRTY2hlbWFPZk9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAicm93cyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlJvd3MiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiTnVtYmVyIG9mIHJvd3MiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJudW1iZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IDUKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJjb2xzIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiQ29sdW1ucyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJOdW1iZXIgb2YgY29sdW1ucyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm51bWJlciIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogNDAKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJ3b3JkbGltaXQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJXb3JkIExpbWl0IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkxpbWl0cyB0aGUgbnVtYmVyIG9mIHdvcmRzIGFsbG93ZWQgaW4gdGhlIHRleHQgYXJlYS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJudW1iZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IC0xCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0T3B0aW9uc0Zvck9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgInJvd3MiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiY29scyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJ3b3JkbGltaXQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFRpdGxlCiAgICAgICAgICovCiAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIk11bHRpLUxpbmUgVGV4dCI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJUZXh0YXJlYSBmaWVsZCBmb3IgbXVsdGlwbGUgbGluZSB0ZXh0LiI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRGaWVsZFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gInRleHRhcmVhIjsKICAgICAgICB9Ly9fX0VORF9PRl9CVUlMREVSX0hFTFBFUlMKCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJNZXNzYWdlcyh7CiAgICAgICAgIndvcmRMaW1pdEV4Y2VlZGVkIjogIlRoZSBtYXhpbXVtIHdvcmQgbGltaXQgb2YgezB9IGhhcyBiZWVuIGV4Y2VlZGVkLiIKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3RlclRlbXBsYXRlKCJjb250cm9sRmllbGRUZXh0YXJlYSIsICc8dGV4dGFyZWEgaWQ9IiR7aWR9IiB7e2lmIG9wdGlvbnMucGxhY2Vob2xkZXJ9fXBsYWNlaG9sZGVyPSIke29wdGlvbnMucGxhY2Vob2xkZXJ9Int7L2lmfX0ge3tpZiBvcHRpb25zLnJvd3N9fXJvd3M9IiR7b3B0aW9ucy5yb3dzfSJ7ey9pZn19IHt7aWYgb3B0aW9ucy5jb2xzfX1jb2xzPSIke29wdGlvbnMuY29sc30ie3svaWZ9fSB7e2lmIG9wdGlvbnMucmVhZG9ubHl9fXJlYWRvbmx5PSJyZWFkb25seSJ7ey9pZn19IHt7aWYgbmFtZX19bmFtZT0iJHtuYW1lfSJ7ey9pZn19IHt7ZWFjaCBvcHRpb25zLmRhdGF9fWRhdGEtJHtmaWVsZElkfT0iJHt2YWx1ZX0ie3svZWFjaH19Lz4nKTsKICAgIEFscGFjYS5yZWdpc3RlckZpZWxkQ2xhc3MoInRleHRhcmVhIiwgQWxwYWNhLkZpZWxkcy5UZXh0QXJlYUZpZWxkKTsKCn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuQ2hlY2tCb3hGaWVsZCA9IEFscGFjYS5Db250cm9sRmllbGQuZXh0ZW5kKAogICAgICAgIC8qKgogICAgICAgICAqIEBsZW5kcyBBbHBhY2EuRmllbGRzLkNoZWNrQm94RmllbGQucHJvdG90eXBlCiAgICAgICAgICovCiAgICAgICAgewogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5Db250cm9sRmllbGQKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGNsYXNzIENoZWNrYm94IGNvbnRyb2wgZm9yIEpTT04gc2NoZW1hIGJvb2xlYW4gdHlwZS4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNzZXR1cAogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICAgICAgX3RoaXMuYmFzZSgpOwoKICAgICAgICAgICAgICAgIGlmICghdGhpcy5vcHRpb25zLnJpZ2h0TGFiZWwpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMucmlnaHRMYWJlbCA9ICIiOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YoX3RoaXMub3B0aW9ucy5tdWx0aXBsZSkgPT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKF90aGlzLnNjaGVtYS50eXBlID09ICJhcnJheSIpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5vcHRpb25zLm11bHRpcGxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodHlwZW9mKF90aGlzLnNjaGVtYVsiZW51bSJdKSAhPSAidW5kZWZpbmVkIikKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLm9wdGlvbnMubXVsdGlwbGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBfdGhpcy5jaGVja2JveE9wdGlvbnMgPSBbXTsKICAgICAgICAgICAgICAgIGlmIChfdGhpcy5vcHRpb25zLm11bHRpcGxlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICQuZWFjaChfdGhpcy5nZXRFbnVtKCksIGZ1bmN0aW9uKGluZGV4LCB2YWx1ZSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRleHQgPSB2YWx1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfdGhpcy5vcHRpb25zLm9wdGlvbkxhYmVscykKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eShfdGhpcy5vcHRpb25zLm9wdGlvbkxhYmVsc1tpbmRleF0pKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQgPSBfdGhpcy5vcHRpb25zLm9wdGlvbkxhYmVsc1tpbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICghQWxwYWNhLmlzRW1wdHkoX3RoaXMub3B0aW9ucy5vcHRpb25MYWJlbHNbdmFsdWVdKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gX3RoaXMub3B0aW9ucy5vcHRpb25MYWJlbHNbdmFsdWVdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jaGVja2JveE9wdGlvbnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidmFsdWUiOiB2YWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0ZXh0IjogdGV4dAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBHZXRzIHNjaGVtYSBlbnVtIHByb3BlcnR5LgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcmV0dXJucyB7QXJyYXl8U3RyaW5nfSBGaWVsZCBzY2hlbWEgZW51bSBwcm9wZXJ0eS4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldEVudW06IGZ1bmN0aW9uKCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGFycmF5ID0gW107CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2NoZW1hICYmIHRoaXMuc2NoZW1hWyJlbnVtIl0pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXkgPSB0aGlzLnNjaGVtYVsiZW51bSJdOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBhcnJheTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBIYW5kbGVyIGZvciB0aGUgZXZlbnQgdGhhdCB0aGUgY2hlY2tib3ggaXMgY2xpY2tlZC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIGUgRXZlbnQuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBvbkNsaWNrOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlZnJlc2hWYWxpZGF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjcmVuZGVyRmllbGQKICAgICAgICAgICAgICovCiAgICAgICAgICAgIHJlbmRlckZpZWxkOiBmdW5jdGlvbihvblN1Y2Nlc3MpIHsKCiAgICAgICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgICAgIHZhciBjb250cm9sRmllbGRUZW1wbGF0ZURlc2NyaXB0b3IgPSBudWxsOwoKICAgICAgICAgICAgICAgIC8vIGVpdGhlciB1c2UgdGhlIHNpbmdsZSB0ZW1wbGF0ZSBvciB0aGUgbXVsdGlwbGUgdGVtcGxhdGUKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMubXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgICBjb250cm9sRmllbGRUZW1wbGF0ZURlc2NyaXB0b3IgPSB0aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJjb250cm9sRmllbGRDaGVja2JveE11bHRpcGxlIik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbnRyb2xGaWVsZFRlbXBsYXRlRGVzY3JpcHRvciA9IHRoaXMudmlldy5nZXRUZW1wbGF0ZURlc2NyaXB0b3IoImNvbnRyb2xGaWVsZENoZWNrYm94Iik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGNvbnRyb2xGaWVsZFRlbXBsYXRlRGVzY3JpcHRvcikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZpZWxkID0gX3RoaXMudmlldy50bXBsKGNvbnRyb2xGaWVsZFRlbXBsYXRlRGVzY3JpcHRvciwgewogICAgICAgICAgICAgICAgICAgICAgICAiaWQiOiB0aGlzLmdldElkKCksCiAgICAgICAgICAgICAgICAgICAgICAgICJuYW1lIjogdGhpcy5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAib3B0aW9ucyI6IHRoaXMub3B0aW9ucywKICAgICAgICAgICAgICAgICAgICAgICAgImNoZWNrYm94T3B0aW9ucyI6IF90aGlzLmNoZWNrYm94T3B0aW9ucwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuaW5qZWN0RmllbGQodGhpcy5maWVsZCk7CiAgICAgICAgICAgICAgICAgICAgLy90aGlzLmZpZWxkID0gJCgnaW5wdXRbaWQ9IicgKyB0aGlzLmdldElkKCkgKyAnIl0nLCB0aGlzLmZpZWxkKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gZG8gdGhpcyBsaXR0bGUgdHJpY2sgc28gdGhhdCBpZiB3ZSBoYXZlIGEgZGVmYXVsdCB2YWx1ZSwgaXQgZ2V0cyBzZXQgZHVyaW5nIGZpcnN0IHJlbmRlcgogICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgY2F1c2VzIHRoZSBjaGVja2VkIHN0YXRlIG9mIHRoZSBjb250cm9sIHRvIHVwZGF0ZQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhdGEgJiYgdHlwZW9mKHRoaXMuZGF0YSkgIT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFZhbHVlKHRoaXMuZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChvblN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICBvblN1Y2Nlc3MoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjcG9zdFJlbmRlcgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICAgICAgdGhpcy5iYXNlKGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLWNoZWNrYm94Jyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyB3aGVuZXZlciB0aGUgc3RhdGUgb2Ygb25lIG9mIG91ciBpbnB1dDpjaGVja2JveCBjb250cm9scyBpcyBjaGFuZ2VkIChlaXRoZXIgdmlhIGEgY2xpY2sgb3IgcHJvZ3JhbW1hdGljYWxseSksCiAgICAgICAgICAgICAgICAgICAgLy8gd2Ugc2lnbmFsIHRvIHRoZSB0b3AtbGV2ZWwgZmllbGQgdG8gZmlyZSB1cCBhIGNoYW5nZQogICAgICAgICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyBhbGxvd3MgdGhlIGRlcGVuZGVuY3kgc3lzdGVtIHRvIHJlY2FsY3VsYXRlIGFuZCBzdWNoCiAgICAgICAgICAgICAgICAgICAgLy8KICAgICAgICAgICAgICAgICAgICAkKHNlbGYuZmllbGQpLmZpbmQoImlucHV0OmNoZWNrYm94IikuY2hhbmdlKGZ1bmN0aW9uKGV2dCkgewogICAgICAgICAgICAgICAgICAgICAgICAkKHNlbGYuZmllbGQpLnRyaWdnZXIoImNoYW5nZSIpOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZ2V0VmFsdWUKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gbnVsbDsKCiAgICAgICAgICAgICAgICBpZiAoIXNlbGYub3B0aW9ucy5tdWx0aXBsZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBzaW5nbGUgc2NhbGFyIHZhbHVlCiAgICAgICAgICAgICAgICAgICAgdmFyIGlucHV0ID0gJChzZWxmLmZpZWxkKS5maW5kKCJpbnB1dCIpOwogICAgICAgICAgICAgICAgICAgIGlmIChpbnB1dC5sZW5ndGggPiAwKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBBbHBhY2EuY2hlY2tlZCgkKGlucHV0WzBdKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIG11bHRpcGxlIHZhbHVlcwogICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNlbGYuY2hlY2tib3hPcHRpb25zLmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlucHV0ID0gJChzZWxmLmZpZWxkKS5maW5kKCJpbnB1dFtkYXRhLWNoZWNrYm94LWluZGV4PSciICsgaSArICInXSIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmNoZWNrZWQoaW5wdXQpKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdiA9ICQoaW5wdXQpLmF0dHIoImRhdGEtY2hlY2tib3gtdmFsdWUiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKHYpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBkZXRlcm1pbmUgaG93IHdlJ3JlIGdvaW5nIHRvIGhhbmQgdGhpcyB2YWx1ZSBiYWNrCgogICAgICAgICAgICAgICAgICAgIC8vIGlmIHR5cGUgPT0gImFycmF5Iiwgd2UganVzdCBoYW5kIGJhY2sgdGhlIGFycmF5CiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdHlwZSA9PSAic3RyaW5nIiwgd2UgYnVpbGQgYSBjb21tYS1kZWxpbWl0ZWQgbGlzdAogICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLnNjaGVtYS50eXBlID09ICJhcnJheSIpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlczsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoc2VsZi5zY2hlbWEudHlwZSA9PSAic3RyaW5nIikKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWVzLmpvaW4oIiwiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI3NldFZhbHVlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24odmFsdWUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgICAgICAvLyB2YWx1ZSBjYW4gYmUgYSBib29sZWFuLCBzdHJpbmcgKCJ0cnVlIiksIHN0cmluZyAoImEsYixjIikgb3IgYW4gYXJyYXkgb2YgdmFsdWVzCgogICAgICAgICAgICAgICAgdmFyIGFwcGx5U2NhbGFyVmFsdWUgPSBmdW5jdGlvbih2YWx1ZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzU3RyaW5nKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9ICh2YWx1ZSA9PT0gInRydWUiKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9ICQoc2VsZi5maWVsZCkuZmluZCgiaW5wdXQiKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5wdXQubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIEFscGFjYS5jaGVja2VkKCQoaW5wdXRbMF0pLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICB2YXIgYXBwbHlNdWx0aVZhbHVlID0gZnVuY3Rpb24odmFsdWVzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIGFsbG93IGZvciBjb21tYS1kZWxpbWl0ZWQgc3RyaW5ncwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YodmFsdWVzKSA9PSAic3RyaW5nIikKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlcyA9IHZhbHVlcy5zcGxpdCgiLCIpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gdHJpbSB0aGluZ3MgdG8gcmVtb3ZlIGFueSBleGNlc3Mgd2hpdGUgc3BhY2UKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZhbHVlcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlc1tpXSA9IEFscGFjYS50cmltKHZhbHVlc1tpXSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyB3YWxrIHRocm91Z2ggdmFsdWVzIGFuZCBhc3NpZ24gaW50byBhcHByb3ByaWF0ZSBpbnB1dHMKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZhbHVlcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9ICQoc2VsZi5maWVsZCkuZmluZCgiaW5wdXRbZGF0YS1jaGVja2JveC12YWx1ZT0nIiArIHZhbHVlc1tpXSArICInXSIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5wdXQubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgQWxwYWNhLmNoZWNrZWQoJChpbnB1dFswXSksIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgdmFyIGFwcGxpZWQgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICBpZiAoIXNlbGYub3B0aW9ucy5tdWx0aXBsZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBzaW5nbGUgdmFsdWUgbW9kZQoKICAgICAgICAgICAgICAgICAgICAvLyBib29sZWFuCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZih2YWx1ZSkgPT0gImJvb2xlYW4iKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXBwbHlTY2FsYXJWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGxpZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0eXBlb2YodmFsdWUpID09ICJzdHJpbmciKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXBwbHlTY2FsYXJWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGxpZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBtdWx0aXBsZSB2YWx1ZSBtb2RlCgogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YodmFsdWUpID09ICJzdHJpbmciKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXBwbHlNdWx0aVZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgYXBwbGllZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKEFscGFjYS5pc0FycmF5KHZhbHVlKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGx5TXVsdGlWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGxpZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIWFwcGxpZWQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgQWxwYWNhLmxvZ0Vycm9yKCJDaGVja2JveEZpZWxkIGNhbm5vdCBzZXQgdmFsdWUgZm9yIHNjaGVtYS50eXBlPSIgKyBzZWxmLnNjaGVtYS50eXBlICsgIiBhbmQgdmFsdWU9IiArIHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBiZSBzdXJlIHRvIGNhbGwgaW50byBiYXNlIG1ldGhvZAogICAgICAgICAgICAgICAgdGhpcy5iYXNlKHZhbHVlKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBWYWxpZGF0ZSBhZ2FpbnN0IGVudW0gcHJvcGVydHkgaW4gdGhlIGNhc2UgdGhhdCB0aGUgY2hlY2tib3ggZmllbGQgaXMgaW4gbXVsdGlwbGUgbW9kZS4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgdGhlIGVsZW1lbnQgdmFsdWUgaXMgcGFydCBvZiB0aGUgZW51bSBsaXN0LCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBfdmFsaWRhdGVFbnVtOiBmdW5jdGlvbigpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgICAgICBpZiAoIXNlbGYub3B0aW9ucy5tdWx0aXBsZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgdmFsID0gc2VsZi5nZXRWYWx1ZSgpOwogICAgICAgICAgICAgICAgaWYgKCFzZWxmLnNjaGVtYS5yZXF1aXJlZCAmJiBBbHBhY2EuaXNWYWxFbXB0eSh2YWwpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGlmIHZhbCBpcyBhIHN0cmluZywgY29udmVydCB0byBhcnJheQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZih2YWwpID09ICJzdHJpbmciKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhbCA9IHZhbC5zcGxpdCgiLCIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBBbHBhY2EuYW55RXF1YWxpdHkodmFsLCBzZWxmLnNjaGVtYVsiZW51bSJdKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNkaXNhYmxlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBkaXNhYmxlOiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAkKHRoaXMuZmllbGQpLmZpbmQoImlucHV0IikuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNlbmFibGUKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGVuYWJsZTogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgJCh0aGlzLmZpZWxkKS5maW5kKCJpbnB1dCIpLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5kaXNhYmxlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB9LC8vX19CVUlMREVSX0hFTFBFUlMKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjZ2V0U2NoZW1hT2ZPcHRpb25zCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBnZXRTY2hlbWFPZk9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICAgICAicmlnaHRMYWJlbCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJPcHRpb24gTGFiZWwiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIk9wdGlvbmFsIHJpZ2h0LWhhbmQgc2lkZSBsYWJlbCBmb3Igc2luZ2xlIGNoZWNrYm94IGZpZWxkLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICJtdWx0aXBsZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJNdWx0aXBsZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiV2hldGhlciB0byByZW5kZXIgbXVsdGlwbGUgY2hlY2tib3hlcyBmb3IgbXVsdGktdmFsdWVkIHR5cGUgKHN1Y2ggYXMgYW4gYXJyYXkgb3IgYSBjb21tYS1kZWxpbWl0ZWQgc3RyaW5nKSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2dldE9wdGlvbnNGb3JPcHRpb25zCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAgICAgImZpZWxkcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInJpZ2h0TGFiZWwiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAibXVsdGlwbGUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldFRpdGxlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIkNoZWNrYm94IEZpZWxkIjsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZ2V0RGVzY3JpcHRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuICJDaGVja2JveCBGaWVsZCBmb3IgYm9vbGVhbiAodHJ1ZS9mYWxzZSksIHN0cmluZyAoJ3RydWUnLCAnZmFsc2UnIG9yIGNvbW1hLWRlbGltaXRlZCBzdHJpbmcgb2YgdmFsdWVzKSBvciBkYXRhIGFycmF5LiI7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZ2V0VHlwZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZ2V0VHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gImJvb2xlYW4iOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiY2hlY2tib3giOwogICAgICAgICAgICB9Ly9fX0VORF9PRl9CVUlMREVSX0hFTFBFUlMKCiAgICAgICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyVGVtcGxhdGUoImNvbnRyb2xGaWVsZENoZWNrYm94IiwgJzxzcGFuIGlkPSIke2lkfSI+e3tpZiBvcHRpb25zLnJpZ2h0TGFiZWx9fTxsYWJlbCBjbGFzcz0iYWxwYWNhLWNvbnRyb2xmaWVsZC1sYWJlbCIgZm9yPSIke2lkfV9jaGVja2JveCI+e3svaWZ9fTxpbnB1dCBpZD0iJHtpZH1fY2hlY2tib3giIHR5cGU9ImNoZWNrYm94IiB7e2lmIG9wdGlvbnMucmVhZG9ubHl9fXJlYWRvbmx5PSJyZWFkb25seSJ7ey9pZn19IHt7aWYgbmFtZX19bmFtZT0iJHtuYW1lfSJ7ey9pZn19IHt7ZWFjaChpLHYpIG9wdGlvbnMuZGF0YX19ZGF0YS0ke2l9PSIke3Z9Int7L2VhY2h9fS8+e3tpZiBvcHRpb25zLnJpZ2h0TGFiZWx9fSR7b3B0aW9ucy5yaWdodExhYmVsfTwvbGFiZWw+e3svaWZ9fTwvc3Bhbj4nKTsKICAgIEFscGFjYS5yZWdpc3RlclRlbXBsYXRlKCJjb250cm9sRmllbGRDaGVja2JveE11bHRpcGxlIiwgJzxzcGFuIGlkPSIke2lkfSI+e3tlYWNoKGksbykgY2hlY2tib3hPcHRpb25zfX08c3Bhbj48bGFiZWwgY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtbGFiZWwiIGZvcj0iJHtpZH1fY2hlY2tib3hfJHtpfSI+PGlucHV0IHR5cGU9ImNoZWNrYm94IiBpZD0iJHtpZH1fY2hlY2tib3hfJHtpfSIge3tpZiBvcHRpb25zLnJlYWRvbmx5fX1yZWFkb25seT0icmVhZG9ubHkie3svaWZ9fSB7e2lmIG5hbWV9fW5hbWU9IiR7bmFtZX0ie3svaWZ9fSBkYXRhLWNoZWNrYm94LXZhbHVlPSIke28udmFsdWV9IiBkYXRhLWNoZWNrYm94LWluZGV4PSIke2l9IiAvPiR7dGV4dH08L2xhYmVsPjwvc3Bhbj57ey9lYWNofX08L3NwYW4+Jyk7CgogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiY2hlY2tib3giLCBBbHBhY2EuRmllbGRzLkNoZWNrQm94RmllbGQpOwogICAgQWxwYWNhLnJlZ2lzdGVyRGVmYXVsdFNjaGVtYUZpZWxkTWFwcGluZygiYm9vbGVhbiIsICJjaGVja2JveCIpOwp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLkZpbGVGaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuRmlsZUZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBGaWxlIGNvbnRyb2wgd2l0aCBuaWNlIGN1c3RvbSBzdHlsZXMuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjc2V0dXAKICAgICAgICAgKi8KICAgICAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZSgpOyAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmNvbnRyb2xGaWVsZFRlbXBsYXRlRGVzY3JpcHRvciA9IHRoaXMudmlldy5nZXRUZW1wbGF0ZURlc2NyaXB0b3IoImNvbnRyb2xGaWVsZEZpbGUiKTsKICAgICAgICB9LAogICAgICAgICAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNzZXRWYWx1ZQogICAgICAgICAqLwogICAgICAgIHNldFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAvLyBiZSBzdXJlIHRvIGNhbGwgaW50byBiYXNlIG1ldGhvZAogICAgICAgICAgICAvLyBXZSB3b24ndCBiZSBhYmxlIHRvIGFjdHVhbGx5IHNldCB0aGUgdmFsdWUgZm9yIGZpbGUgaW5wdXQgZmllbGQgc28gd2UgdXNlIHRoZSBtYXNrIGlucHV0CiAgICAgICAgICAgIHZhciB0bXAgPSB0aGlzLmZpZWxkOwogICAgICAgICAgICB0aGlzLmZpZWxkID0gJCgnLmFscGFjYS1maWxlZmllbGQtY29udHJvbCcsdGhpcy5maWVsZENvbnRhaW5lcik7CiAgICAgICAgICAgIHRoaXMuYmFzZSh2YWx1ZSk7CgogICAgICAgICAgICAvLyBzd2l0Y2ggaXQgYmFjayB0byBhY3R1YWwgZmlsZSBpbnB1dAogICAgICAgICAgICB0aGlzLmZpZWxkID0gdG1wOwogICAgICAgIH0sCgogICAgICAgIG9uQ2hhbmdlOiBmdW5jdGlvbihlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGUpOwoKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5zZWxlY3Rpb25IYW5kbGVyKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NTZWxlY3Rpb25IYW5kbGVyKGUudGFyZ2V0LmZpbGVzKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHByb2Nlc3NTZWxlY3Rpb25IYW5kbGVyOiBmdW5jdGlvbihmaWxlcykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChmaWxlcyAmJiBmaWxlcy5sZW5ndGggPiAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBpZiB0aGUgYnJvd3NlciBzdXBwb3J0cyBIVE1MNSBGaWxlUmVhZGVyLCB3ZSBjYW4gcHVsbCBpbiB0aGUgc3RyZWFtIGZvciBwcmV2aWV3CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mKEZpbGVSZWFkZXIpICE9PSAidW5kZWZpbmVkIikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBjbGVhciBvdXQgcHJldmlvdXMgbG9hZGVkIGRhdGEKICAgICAgICAgICAgICAgICAgICB2YXIgbG9hZGVkRGF0YSA9IFtdOwogICAgICAgICAgICAgICAgICAgIHZhciBsb2FkQ291bnQgPSAwOwoKICAgICAgICAgICAgICAgICAgICB2YXIgZmlsZVJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7CiAgICAgICAgICAgICAgICAgICAgZmlsZVJlYWRlci5vbmxvYWQgPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmaWVsZCA9IHRoaXM7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihldmVudCkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRhdGFVcmkgPSBldmVudC50YXJnZXQucmVzdWx0OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRlZERhdGEucHVzaChkYXRhVXJpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRDb3VudCsrOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsb2FkQ291bnQgPT09IGZpbGVzLmxlbmd0aCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZC5vcHRpb25zLnNlbGVjdGlvbkhhbmRsZXIuY2FsbChmaWVsZCwgZmlsZXMsIGxvYWRlZERhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSkuY2FsbCh0aGlzKTsKCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmaWxlcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVSZWFkZXIucmVhZEFzRGF0YVVSTChmaWxlc1tpXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAvLyBhcHBseSBhZGRpdGlvbmFsIGNzcwogICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCJhbHBhY2EtY29udHJvbGZpZWxkLWZpbGUiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIGxpc3RlbiBmb3IgY2hhbmdlIGV2ZW50cyBvbiB0aGUgZmllbGQKICAgICAgICB9LC8vX19CVUlMREVSX0hFTFBFUlMKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjZ2V0U2NoZW1hT2ZPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgInNlbGVjdGlvbkhhbmRsZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJTZWxlY3Rpb24gSGFuZGxlciIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJGdW5jdGlvbiB0aGF0IHNob3VsZCBiZSBjYWxsZWQgd2hlbiBmaWxlcyBhcmUgc2VsZWN0ZWQuICBSZXF1aXJlcyBIVE1MNS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiBmYWxzZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjZ2V0T3B0aW9uc0Zvck9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgInNlbGVjdGlvbkhhbmRsZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCgkJLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRUaXRsZQoJCSAqLwoJCWdldFRpdGxlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICJGaWxlIEZpZWxkIjsKCQl9LAoJCQoJCS8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RGVzY3JpcHRpb24KCQkgKi8KCQlnZXREZXNjcmlwdGlvbjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAiRmllbGQgZm9yIHVwbG9hZGluZyBmaWxlcy4iOwoJCX0sCgoJCS8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RmllbGRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJmaWxlIjsKICAgICAgICB9Ly9fX0VORF9PRl9CVUlMREVSX0hFTFBFUlMKICAgIH0pOwogICAgCiAgICBBbHBhY2EucmVnaXN0ZXJUZW1wbGF0ZSgiY29udHJvbEZpZWxkRmlsZSIsICc8aW5wdXQgdHlwZT0iZmlsZSIgaWQ9IiR7aWR9IiB7e2lmIG9wdGlvbnMuc2l6ZX19c2l6ZT0iJHtvcHRpb25zLnNpemV9Int7L2lmfX0ge3tpZiBvcHRpb25zLnJlYWRvbmx5fX1yZWFkb25seT0icmVhZG9ubHkie3svaWZ9fSB7e2lmIG5hbWV9fW5hbWU9IiR7bmFtZX0ie3svaWZ9fSB7e2VhY2goaSx2KSBvcHRpb25zLmRhdGF9fWRhdGEtJHtpfT0iJHt2fSJ7ey9lYWNofX0vPicpOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiZmlsZSIsIEFscGFjYS5GaWVsZHMuRmlsZUZpZWxkKTsKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5MaXN0RmllbGQgPSBBbHBhY2EuQ29udHJvbEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuTGlzdEZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkNvbnRyb2xGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIEFic3RyYWN0IGNsYXNzIGZvciBsaXN0LXR5cGUgY29udHJvbHMuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI3NldHVwCiAgICAgICAgICovCiAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICAgICAgICBfdGhpcy5iYXNlKCk7CiAgICAgICAgICAgIF90aGlzLnNlbGVjdE9wdGlvbnMgPSBbXTsKICAgICAgICAgICAgaWYgKF90aGlzLmdldEVudW0oKSkgewogICAgICAgICAgICAgICAgJC5lYWNoKF90aGlzLmdldEVudW0oKSwgZnVuY3Rpb24oaW5kZXgsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRleHQgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoX3RoaXMub3B0aW9ucy5vcHRpb25MYWJlbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eShfdGhpcy5vcHRpb25zLm9wdGlvbkxhYmVsc1tpbmRleF0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gX3RoaXMub3B0aW9ucy5vcHRpb25MYWJlbHNbaW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFBbHBhY2EuaXNFbXB0eShfdGhpcy5vcHRpb25zLm9wdGlvbkxhYmVsc1t2YWx1ZV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gX3RoaXMub3B0aW9ucy5vcHRpb25MYWJlbHNbdmFsdWVdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIF90aGlzLnNlbGVjdE9wdGlvbnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IHZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgICAidGV4dCI6IHRleHQKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyBzY2hlbWEgZW51bSBwcm9wZXJ0eS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtBcnJheXxTdHJpbmd9IEZpZWxkIHNjaGVtYSBlbnVtIHByb3BlcnR5LgogICAgICAgICAqLwogICAgICAgIGdldEVudW06IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5zY2hlbWEgJiYgdGhpcy5zY2hlbWFbImVudW0iXSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2NoZW1hWyJlbnVtIl07CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRWYWx1ZQogICAgICAgICAqLwogICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgICAgICAgaWYgKEFscGFjYS5pc0FycmF5KHZhbCkpIHsKICAgICAgICAgICAgICAgICQuZWFjaCh2YWwsIGZ1bmN0aW9uKGluZGV4LCBpdGVtVmFsKSB7CiAgICAgICAgICAgICAgICAgICAgJC5lYWNoKF90aGlzLnNlbGVjdE9wdGlvbnMsIGZ1bmN0aW9uKGluZGV4Miwgc2VsZWN0T3B0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3RPcHRpb24udmFsdWUgPT0gaXRlbVZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsW2luZGV4XSA9IHNlbGVjdE9wdGlvbi52YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkLmVhY2godGhpcy5zZWxlY3RPcHRpb25zLCBmdW5jdGlvbihpbmRleCwgc2VsZWN0T3B0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGVjdE9wdGlvbi52YWx1ZSA9PSB2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gc2VsZWN0T3B0aW9uLnZhbHVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI3JlbmRlckZpZWxkCiAgICAgICAgICovCiAgICAgICAgcmVuZGVyRmllbGQ6IGZ1bmN0aW9uKG9uU3VjY2VzcykgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmRhdGFTb3VyY2UpIHsKICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNGdW5jdGlvbih0aGlzLm9wdGlvbnMuZGF0YVNvdXJjZSkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuZGF0YVNvdXJjZSh0aGlzLCBmdW5jdGlvbih2YWx1ZXMpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNBcnJheSh2YWx1ZXMpKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZhbHVlcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mKHZhbHVlc1tpXSkgPT0gInN0cmluZyIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5zZWxlY3RPcHRpb25zLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRleHQiOiB2YWx1ZXNbaV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidmFsdWUiOiB2YWx1ZXNbaV0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKEFscGFjYS5pc09iamVjdCh2YWx1ZXNbaV0pKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuc2VsZWN0T3B0aW9ucy5wdXNoKHZhbHVlc1tpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKEFscGFjYS5pc09iamVjdCh2YWx1ZXMpKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrIGluIHZhbHVlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5zZWxlY3RPcHRpb25zLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGV4dCI6IGssCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IHZhbHVlc1trXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5fcmVuZGVyRmllbGQob25TdWNjZXNzKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKEFscGFjYS5pc1VyaSh0aGlzLm9wdGlvbnMuZGF0YVNvdXJjZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJC5hamF4KHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdGhpcy5vcHRpb25zLmRhdGFTb3VyY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAiZ2V0IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAianNvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihqc29uRG9jdW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZHMgPSBqc29uRG9jdW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF90aGlzLm9wdGlvbnMuZHNUcmFuc2Zvcm1lciAmJiBBbHBhY2EuaXNGdW5jdGlvbihfdGhpcy5vcHRpb25zLmRzVHJhbnNmb3JtZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRzID0gX3RoaXMub3B0aW9ucy5kc1RyYW5zZm9ybWVyKGRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFscGFjYS5pc09iamVjdChkcykpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZvciBvYmplY3RzLCB3ZSB3YWxrIHRocm91Z2ggb25lIGtleSBhdCBhIHRpbWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBpbnNlcnRpb24gb3JkZXIgaXMgdGhlIG9yZGVyIG9mIHRoZSBrZXlzIGZyb20gdGhlIG1hcAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdG8gcHJlc2VydmUgb3JkZXIsIGNvbnNpZGVyIHVzaW5nIGFuIGFycmF5IGFzIGJlbG93CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkLmVhY2goZHMsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5zZWxlY3RPcHRpb25zLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidmFsdWUiOiBrZXksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0ZXh0IjogdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKEFscGFjYS5pc0FycmF5KGRzKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZm9yIGFycmF5cywgd2Ugd2FsayB0aHJvdWdoIG9uZSBpbmRleCBhdCBhIHRpbWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBpbnNlcnRpb24gb3JkZXIgaXMgZGljdGF0ZWQgYnkgdGhlIG9yZGVyIG9mIHRoZSBpbmRpY2VzIGludG8gdGhlIGFycmF5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIHByZXNlcnZlcyBvcmRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJC5lYWNoKGRzLCBmdW5jdGlvbihpbmRleCwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5zZWxlY3RPcHRpb25zLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidmFsdWUiOiB2YWx1ZS52YWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRleHQiOiB2YWx1ZS50ZXh0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuX3JlbmRlckZpZWxkKG9uU3VjY2Vzcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImVycm9yIjogZnVuY3Rpb24oanFYSFIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuZXJyb3JDYWxsYmFjayh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZXNzYWdlIjoiVW5hYmxlIHRvIGxvYWQgZGF0YSBmcm9tIHVyaSA6ICIgKyBfdGhpcy5vcHRpb25zLmRhdGFTb3VyY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzdGFnZSI6ICJEQVRBU09VUkNFX0xPQURJTkdfRVJST1IiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGV0YWlscyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJqcVhIUiIgOiBqcVhIUiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0ZXh0U3RhdHVzIiA6IHRleHRTdGF0dXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZXJyb3JUaHJvd24iIDogZXJyb3JUaHJvd24KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZHMgPSB0aGlzLm9wdGlvbnMuZGF0YVNvdXJjZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF90aGlzLm9wdGlvbnMuZHNUcmFuc2Zvcm1lciAmJiBBbHBhY2EuaXNGdW5jdGlvbihfdGhpcy5vcHRpb25zLmRzVHJhbnNmb3JtZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkcyA9IF90aGlzLm9wdGlvbnMuZHNUcmFuc2Zvcm1lcihkcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzQXJyYXkoZHMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJC5lYWNoKGRzLCBmdW5jdGlvbihpbmRleCwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuc2VsZWN0T3B0aW9ucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IHZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRleHQiOiB2YWx1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNPYmplY3QoZHMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaW5kZXggaW4gZHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuc2VsZWN0T3B0aW9ucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IGluZGV4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRleHQiOiBkc1tpbmRleF0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuX3JlbmRlckZpZWxkKG9uU3VjY2Vzcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9yZW5kZXJGaWVsZChvblN1Y2Nlc3MpOwogICAgICAgICAgICB9CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2dldFNjaGVtYU9mU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZTY2hlbWE6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAiZW51bSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkVudW1lcmF0aW9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkxpc3Qgb2YgZmllbGQgdmFsdWUgb3B0aW9ucyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImFycmF5IiwKICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjZ2V0U2NoZW1hT2ZPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgIm9wdGlvbkxhYmVscyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIk9wdGlvbiBMYWJlbHMiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiTGFiZWxzIGZvciBvcHRpb25zLiBJdCBjYW4gZWl0aGVyIGJlIGEgbWFwIG9iamVjdCBvciBhbiBhcnJheSBmaWVsZCB0aGF0IG1hcHMgbGFiZWxzIHRvIGl0ZW1zIGRlZmluZWQgYnkgZW51bSBzY2hlbWEgcHJvcGVydHkgb25lIGJ5IG9uZS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJhcnJheSIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJkYXRhU291cmNlIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiT3B0aW9uIERhdGFzb3VyY2UiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRGF0YXNvdXJjZSBmb3IgZ2VuZXJhdGluZyBsaXN0IG9mIG9wdGlvbnMuICBUaGlzIGNhbiBiZSBhIHN0cmluZyBvciBhIGZ1bmN0aW9uLiAgSWYgYSBzdHJpbmcsIGl0IGlzIGNvbnNpZGVyZWQgdG8gYmUgYSBVUkkgdG8gYSBzZXJ2aWNlIHRoYXQgcHJvZHVjZXMgYSBvYmplY3QgY29udGFpbmluZyBrZXkvdmFsdWUgcGFpcnMgb3IgYW4gYXJyYXkgb2YgZWxlbWVudHMgb2Ygc3RydWN0dXJlIHsndGV4dCc6ICcnLCAndmFsdWUnOiAnJ30uICBUaGlzIGNhbiBhbHNvIGJlIGEgZnVuY3Rpb24gdGhhdCBpcyBjYWxsZWQgdG8gcHJvZHVjZSB0aGUgc2FtZSBsaXN0LiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJyZW1vdmVEZWZhdWx0Tm9uZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlJlbW92ZSBEZWZhdWx0IE5vbmUiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiSWYgdHJ1ZSwgdGhlIGRlZmF1bHQgJ05vbmUnIG9wdGlvbiB3aWxsIG5vdCBiZSBzaG93bi4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiBmYWxzZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjZ2V0T3B0aW9uc0Zvck9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgIm9wdGlvbkxhYmVscyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgIml0ZW1MYWJlbCI6IkxhYmVsIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYXJyYXkiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZGF0YVNvdXJjZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJyZW1vdmVEZWZhdWx0Tm9uZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiY2hlY2tib3giLAogICAgICAgICAgICAgICAgICAgICAgICAicmlnaHRMYWJlbCI6ICJSZW1vdmUgRGVmYXVsdCBOb25lIgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLlJhZGlvRmllbGQgPSBBbHBhY2EuRmllbGRzLkxpc3RGaWVsZC5leHRlbmQoCiAgICAvKioKICAgICAqIEBsZW5kcyBBbHBhY2EuRmllbGRzLlJhZGlvRmllbGQucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuRmllbGRzLkxpc3RGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIFJhZGlvIGdyb3VwIGNvbnRyb2wgZm9yIGxpc3QgdHlwZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLkxpc3RGaWVsZCNzZXR1cAogICAgICAgICAqLwogICAgICAgIHNldHVwOiBmdW5jdGlvbigpewogICAgICAgICAgICB0aGlzLmJhc2UoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMubmFtZSkgewoJCQkJdGhpcy5uYW1lID0gdGhpcy5vcHRpb25zLm5hbWU7CgkJCX0KCQkJZWxzZSBpZiAoIXRoaXMubmFtZSkgewoJCQkJdGhpcy5uYW1lID0gdGhpcy5nZXRJZCgpKyItbmFtZSI7CgkJCX0KCiAgICAgICAgICAgIC8vIGVtcHR5IHNlbGVjdCBmaXJzdCB0byBmYWxzZSBieSBkZWZhdWx0CiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNVbmRlZmluZWQodGhpcy5vcHRpb25zLmVtcHR5U2VsZWN0Rmlyc3QpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuZW1wdHlTZWxlY3RGaXJzdCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZ2V0VmFsdWUKICAgICAgICAgKi8KICAgICAgICBnZXRWYWx1ZTogZnVuY3Rpb24oKXsKICAgICAgICAgICAgdmFyIHZhbCA9IHRoaXMuYmFzZSgkKCdpbnB1dDpyYWRpb1tuYW1lPScrdGhpcy5uYW1lKyddOmNoZWNrZWQnLHRoaXMuZmllbGQpLnZhbCgpKTsKICAgICAgICAgICAgJC5lYWNoKHRoaXMuc2VsZWN0T3B0aW9ucyxmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmIChTdHJpbmcodGhpc1sndmFsdWUnXSkgPT0gIHZhbCkgewogICAgICAgICAgICAgICAgICAgIHZhbCA9IHRoaXNbJ3ZhbHVlJ107CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdmFsOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjc2V0VmFsdWUKICAgICAgICAgKi8KICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24odmFsKXsKICAgICAgICAgICAgaWYgKHZhbCAhPSB0aGlzLmdldFZhbHVlKCkpIHsKICAgICAgICAgICAgICAgICQuZWFjaCgkKCdpbnB1dDpyYWRpb1tuYW1lPScrdGhpcy5uYW1lKyddJyx0aGlzLmZpZWxkKSxmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoJCh0aGlzKS52YWwoKSA9PSB2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5hdHRyKCdjaGVja2VkJywnY2hlY2tlZCcpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykucmVtb3ZlQXR0cignY2hlY2tlZCcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuZW1wdHlTZWxlY3RGaXJzdCkgewogICAgICAgICAgICAgICAgICAgIGlmICgkKCJpbnB1dDpyYWRpbzpjaGVja2VkIix0aGlzLmZpZWxkKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgJCgiaW5wdXQ6cmFkaW86Zmlyc3QiLHRoaXMuZmllbGQpLmF0dHIoImNoZWNrZWQiLCJjaGVja2VkIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuYmFzZSh2YWwpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIF9yZW5kZXJGaWVsZDogZnVuY3Rpb24ob25TdWNjZXNzKXsKCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICB2YXIgY29udHJvbEZpZWxkVGVtcGxhdGVEZXNjcmlwdG9yID0gdGhpcy52aWV3LmdldFRlbXBsYXRlRGVzY3JpcHRvcigiY29udHJvbEZpZWxkUmFkaW8iKTsKICAgICAgICAgICAgaWYgKGNvbnRyb2xGaWVsZFRlbXBsYXRlRGVzY3JpcHRvcikgewogICAgICAgICAgICAgICAgdGhpcy5maWVsZCA9IF90aGlzLnZpZXcudG1wbChjb250cm9sRmllbGRUZW1wbGF0ZURlc2NyaXB0b3IsIHsKICAgICAgICAgICAgICAgICAgICAiaWQiOiB0aGlzLmdldElkKCksCiAgICAgICAgICAgICAgICAgICAgIm9wdGlvbnMiOiB0aGlzLm9wdGlvbnMsCiAgICAgICAgICAgICAgICAgICAgInNlbGVjdE9wdGlvbnMiOiB0aGlzLnNlbGVjdE9wdGlvbnMsCiAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjp0aGlzLnNjaGVtYS5yZXF1aXJlZCwKCQkJCQkibmFtZSI6IHRoaXMubmFtZSwKICAgICAgICAgICAgICAgICAgICAiZGF0YSI6IHRoaXMuZGF0YSwKICAgICAgICAgICAgICAgICAgICAicmVtb3ZlRGVmYXVsdE5vbmUiOiB0aGlzLm9wdGlvbnMucmVtb3ZlRGVmYXVsdE5vbmUKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIGlmIGVtcHR5U2VsZWN0Rmlyc3QgYW5kIG5vdGhpbmcgY3VycmVudGx5IGNoZWNrZWQsIHRoZW4gcGljayBmaXJzdCBpdGVtIGluIHRoZSB2YWx1ZSBsaXN0CiAgICAgICAgICAgICAgICAvLyBzZXQgZGF0YSBhbmQgdmlzdWFsbHkgc2VsZWN0IGl0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmVtcHR5U2VsZWN0Rmlyc3QgJiYgdGhpcy5zZWxlY3RPcHRpb25zICYmIHRoaXMuc2VsZWN0T3B0aW9ucy5sZW5ndGggPiAwKSB7CgogICAgICAgICAgICAgICAgICAgIHRoaXMuZGF0YSA9IHRoaXMuc2VsZWN0T3B0aW9uc1swXS52YWx1ZTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCQoImlucHV0OnJhZGlvOmNoZWNrZWQiLHRoaXMuZmllbGQpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAkKCJpbnB1dDpyYWRpbzpmaXJzdCIsdGhpcy5maWVsZCkuYXR0cigiY2hlY2tlZCIsImNoZWNrZWQiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gc3RhY2sgcmFkaW8gc2VsZWN0b3JzIHZlcnRpY2FsbHkKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMudmVydGljYWwpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgJCgiLmFscGFjYS1jb250cm9sZmllbGQtcmFkaW8taXRlbSIsIHRoaXMuZmllbGQpLmNzcygiZGlzcGxheSIsICJibG9jayIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuaW5qZWN0RmllbGQodGhpcy5maWVsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChvblN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIG9uU3VjY2VzcygpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjcG9zdFJlbmRlcgogICAgICAgICAqLwogICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLXJhZGlvJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjb25DbGljawogICAgICAgICAqLwogICAgICAgIG9uQ2xpY2s6IGZ1bmN0aW9uKGUpewogICAgICAgICAgICB0aGlzLmJhc2UoZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICAgICAgICAKICAgICAgICAgICAgQWxwYWNhLmxhdGVyKDI1LCB0aGlzLCBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgdmFyIHYgPSBfdGhpcy5nZXRWYWx1ZSgpOwogICAgICAgICAgICAgICAgX3RoaXMuc2V0VmFsdWUodik7CiAgICAgICAgICAgICAgICBfdGhpcy5yZWZyZXNoVmFsaWRhdGlvblN0YXRlKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoJCQogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLkxpc3RGaWVsZCNnZXRTY2hlbWFPZk9wdGlvbnMKICAgICAgICAgKi8KCQlnZXRTY2hlbWFPZk9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLHsKCQkJCSJwcm9wZXJ0aWVzIjogewoJCQkJCSJuYW1lIjogewoJCQkJCQkidGl0bGUiOiAiRmllbGQgbmFtZSIsCgkJCQkJCSJkZXNjcmlwdGlvbiI6ICJGaWVsZCBuYW1lLiIsCgkJCQkJCSJ0eXBlIjogInN0cmluZyIKCQkJCQl9LAogICAgICAgICAgICAgICAgICAgICJlbXB0eVNlbGVjdEZpcnN0IjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRW1wdHkgU2VsZWN0IEZpcnN0IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIklmIHRoZSBkYXRhIGlzIGVtcHR5LCB0aGVuIGF1dG9tYXRpY2FsbHkgc2VsZWN0IHRoZSBmaXJzdCBpdGVtIGluIHRoZSBsaXN0LiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAidmVydGljYWwiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJQb3NpdGlvbiB0aGUgcmFkaW8gc2VsZWN0b3IgaXRlbXMgdmVydGljYWxseSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJXaGVuIHRydWUsIHRoZSByYWRpbyBzZWxlY3RvciBpdGVtcyB3aWxsIGJlIHN0YWNrZWQgdmVydGljYWxseSBhbmQgbm90IGhvcml6b250YWxseSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgfQoJCQkJfQoJCQl9KTsKICAgICAgICB9LAoKCQkvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRUaXRsZQoJCSAqLwoJCWdldFRpdGxlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICJSYWRpbyBHcm91cCBGaWVsZCI7CgkJfSwKCQkKCQkvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXREZXNjcmlwdGlvbgoJCSAqLwoJCWdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICJSYWRpbyBHcm91cCBGaWVsZCB3aXRoIGxpc3Qgb2Ygb3B0aW9ucy4iOwoJCX0sCgoJCS8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAicmFkaW8iOwogICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgICAgIAogICAgfSk7CiAgICAKICAgIEFscGFjYS5yZWdpc3RlclRlbXBsYXRlKCJjb250cm9sRmllbGRSYWRpbyIsICc8ZGl2IGlkPSIke2lkfSIgY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtcmFkaW8iPnt7aWYgIXJlcXVpcmVkICYmICFyZW1vdmVEZWZhdWx0Tm9uZX19PHNwYW4gY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtcmFkaW8taXRlbSI+PGlucHV0IHR5cGU9InJhZGlvIiB7e2lmIG9wdGlvbnMucmVhZG9ubHl9fXJlYWRvbmx5PSJyZWFkb25seSJ7ey9pZn19IG5hbWU9IiR7bmFtZX0iIGlkPSIke2lkfV9yYWRpb19ub25ldmFsdWUiIHZhbHVlPSIiLz48bGFiZWwgY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtcmFkaW8tbGFiZWwiIGZvcj0iJHtpZH1fcmFkaW9fbm9uZXZhbHVlIj5Ob25lPC9sYWJlbD48L3NwYW4+e3svaWZ9fXt7ZWFjaCBzZWxlY3RPcHRpb25zfX08c3BhbiBjbGFzcz0iYWxwYWNhLWNvbnRyb2xmaWVsZC1yYWRpby1pdGVtIj48aW5wdXQgdHlwZT0icmFkaW8iIHt7aWYgb3B0aW9ucy5yZWFkb25seX19cmVhZG9ubHk9InJlYWRvbmx5Int7L2lmfX0gbmFtZT0iJHtuYW1lfSIgdmFsdWU9IiR7dmFsdWV9IiBpZD0iJHtpZH1fcmFkaW9fJHskaW5kZXh9IiB7e2lmIHZhbHVlID09IGRhdGF9fWNoZWNrZWQ9ImNoZWNrZWQie3svaWZ9fS8+PGxhYmVsIGNsYXNzPSJhbHBhY2EtY29udHJvbGZpZWxkLXJhZGlvLWxhYmVsIiBmb3I9IiR7aWR9X3JhZGlvXyR7JGluZGV4fSI+JHt0ZXh0fTwvbGFiZWw+PC9zcGFuPnt7L2VhY2h9fTwvZGl2PicpOwoKICAgIEFscGFjYS5yZWdpc3RlckZpZWxkQ2xhc3MoInJhZGlvIiwgQWxwYWNhLkZpZWxkcy5SYWRpb0ZpZWxkKTsKICAgIAp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLlNlbGVjdEZpZWxkID0gQWxwYWNhLkZpZWxkcy5MaXN0RmllbGQuZXh0ZW5kKAogICAgLyoqCiAgICAgKiBAbGVuZHMgQWxwYWNhLkZpZWxkcy5TZWxlY3RGaWVsZC5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5GaWVsZHMuTGlzdEZpZWxkCiAgICAgICAgICoKICAgICAgICAgKiBAY2xhc3MgRHJvcGRvd24gbGlzdCBjb250cm9sIGZvciBsaXN0IHR5cGUuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5MaXN0RmllbGQjc2V0dXAKICAgICAgICAgKi8KICAgICAgICBzZXR1cDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CgogICAgICAgICAgICAvLyBlbXB0eSBzZWxlY3QgZmlyc3QgdG8gZmFsc2UgYnkgZGVmYXVsdAogICAgICAgICAgICBpZiAoQWxwYWNhLmlzVW5kZWZpbmVkKHRoaXMub3B0aW9ucy5lbXB0eVNlbGVjdEZpcnN0KSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmVtcHR5U2VsZWN0Rmlyc3QgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldFZhbHVlCiAgICAgICAgICovCiAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsID0gdGhpcy5maWVsZC52YWwoKTsKICAgICAgICAgICAgICAgIGlmICghdmFsKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhbCA9IHRoaXMuZGF0YTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5iYXNlKHZhbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNzZXRWYWx1ZQogICAgICAgICAqLwogICAgICAgIHNldFZhbHVlOiBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgaWYgKEFscGFjYS5pc0FycmF5KHZhbCkpIHsKICAgICAgICAgICAgICAgIGlmICghQWxwYWNhLmNvbXBhcmVBcnJheUNvbnRlbnQodmFsLCB0aGlzLmdldFZhbHVlKCkpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eSh2YWwpICYmIHRoaXMuZmllbGQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5maWVsZC52YWwodmFsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5iYXNlKHZhbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodmFsICE9IHRoaXMuZ2V0VmFsdWUoKSkgewogICAgICAgICAgICAgICAgICAgIGlmICghQWxwYWNhLmlzRW1wdHkodmFsKSAmJiB0aGlzLmZpZWxkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGQudmFsKHZhbCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuYmFzZSh2YWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuTGlzdEZpZWxkI2dldEVudW0KICAgICAgICAgKi8KICAgICAgICBnZXRFbnVtOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc2NoZW1hKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zY2hlbWFbImVudW0iXSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNjaGVtYVsiZW51bSJdOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnNjaGVtYVsidHlwZSJdICYmIHRoaXMuc2NoZW1hWyJ0eXBlIl0gPT0gImFycmF5IiAmJiB0aGlzLnNjaGVtYVsiaXRlbXMiXSAmJiB0aGlzLnNjaGVtYVsiaXRlbXMiXVsiZW51bSJdKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2NoZW1hWyJpdGVtcyJdWyJlbnVtIl07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIF9yZW5kZXJGaWVsZDogZnVuY3Rpb24ob25TdWNjZXNzKSB7CgogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgaWYgKHRoaXMuc2NoZW1hWyJ0eXBlIl0gJiYgdGhpcy5zY2hlbWFbInR5cGUiXSA9PSAiYXJyYXkiKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMubXVsdGlwbGUgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgY29udHJvbEZpZWxkVGVtcGxhdGVEZXNjcmlwdG9yOwogICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLm11bHRpcGxlICYmIEFscGFjYS5pc0FycmF5KHRoaXMuZGF0YSkpIHsKICAgICAgICAgICAgICAgIGNvbnRyb2xGaWVsZFRlbXBsYXRlRGVzY3JpcHRvciA9IHRoaXMudmlldy5nZXRUZW1wbGF0ZURlc2NyaXB0b3IoImNvbnRyb2xGaWVsZFNlbGVjdE11bHRpcGxlIik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb250cm9sRmllbGRUZW1wbGF0ZURlc2NyaXB0b3IgPSB0aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJjb250cm9sRmllbGRTZWxlY3QiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNvbnRyb2xGaWVsZFRlbXBsYXRlRGVzY3JpcHRvcikgewogICAgICAgICAgICAgICAgdGhpcy5maWVsZCA9IF90aGlzLnZpZXcudG1wbChjb250cm9sRmllbGRUZW1wbGF0ZURlc2NyaXB0b3IsIHsKICAgICAgICAgICAgICAgICAgICAiaWQiOiB0aGlzLmdldElkKCksCiAgICAgICAgICAgICAgICAgICAgIm9wdGlvbnMiOiB0aGlzLm9wdGlvbnMsCiAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogdGhpcy5zY2hlbWEucmVxdWlyZWQsCiAgICAgICAgICAgICAgICAgICAgInNlbGVjdE9wdGlvbnMiOiB0aGlzLnNlbGVjdE9wdGlvbnMsCiAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiB0aGlzLm5hbWUsCiAgICAgICAgICAgICAgICAgICAgImRhdGEiOiB0aGlzLmRhdGEsCiAgICAgICAgICAgICAgICAgICAgInJlbW92ZURlZmF1bHROb25lIjogdGhpcy5vcHRpb25zLnJlbW92ZURlZmF1bHROb25lCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAvLyBpZiBlbXB0eVNlbGVjdEZpcnN0IGFuZCBub3RoaW5nIGN1cnJlbnRseSBjaGVja2VkLCB0aGVuIHBpY2sgZmlyc3QgaXRlbSBpbiB0aGUgdmFsdWUgbGlzdAogICAgICAgICAgICAgICAgLy8gc2V0IGRhdGEgYW5kIHZpc3VhbGx5IHNlbGVjdCBpdAogICAgICAgICAgICAgICAgaWYgKEFscGFjYS5pc1VuZGVmaW5lZCh0aGlzLmRhdGEpICYmIHRoaXMub3B0aW9ucy5lbXB0eVNlbGVjdEZpcnN0ICYmIHRoaXMuc2VsZWN0T3B0aW9ucyAmJiB0aGlzLnNlbGVjdE9wdGlvbnMubGVuZ3RoID4gMCkgewoKICAgICAgICAgICAgICAgICAgICB0aGlzLmRhdGEgPSB0aGlzLnNlbGVjdE9wdGlvbnNbMF0udmFsdWU7CgogICAgICAgICAgICAgICAgICAgIC8vJCgic2VsZWN0Iix0aGlzLmZpZWxkKS52YWwoIjAiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLmluamVjdEZpZWxkKHRoaXMuZmllbGQpOwoKICAgICAgICAgICAgICAgIC8vIGRvIHRoaXMgbGl0dGxlIHRyaWNrIHNvIHRoYXQgaWYgd2UgaGF2ZSBhIGRlZmF1bHQgdmFsdWUsIGl0IGdldHMgc2V0IGR1cmluZyBmaXJzdCByZW5kZXIKICAgICAgICAgICAgICAgIC8vIHRoaXMgY2F1c2VzIHRoZSBzdGF0ZSBvZiB0aGUgY29udHJvbAogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGF0YSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUodGhpcy5kYXRhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9uU3VjY2VzcykgewogICAgICAgICAgICAgICAgb25TdWNjZXNzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjcG9zdFJlbmRlcgogICAgICAgICAqLwogICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLXNlbGVjdCcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaWRhdGUgYWdhaW5zdCBlbnVtIHByb3BlcnR5LgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgdGhlIGVsZW1lbnQgdmFsdWUgaXMgcGFydCBvZiB0aGUgZW51bSBsaXN0LCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgX3ZhbGlkYXRlRW51bTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnNjaGVtYVsiZW51bSJdKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsID0gdGhpcy5kYXRhOwogICAgICAgICAgICAgICAgaWYgKCF0aGlzLnNjaGVtYS5yZXF1aXJlZCAmJiBBbHBhY2EuaXNWYWxFbXB0eSh2YWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLm11bHRpcGxlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGlzVmFsaWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gW107CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICQuZWFjaCh2YWwsIGZ1bmN0aW9uKGksdikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJC5pbkFycmF5KHYsIF90aGlzLnNjaGVtYVsiZW51bSJdKSA8PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNWYWxpZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzVmFsaWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoJC5pbkFycmF5KHZhbCwgdGhpcy5zY2hlbWFbImVudW0iXSkgPiAtMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI29uQ2hhbmdlCiAgICAgICAgICovCiAgICAgICAgb25DaGFuZ2U6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGUpOwoKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIEFscGFjYS5sYXRlcigyNSwgdGhpcywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgdiA9IF90aGlzLmdldFZhbHVlKCk7CiAgICAgICAgICAgICAgICBfdGhpcy5zZXRWYWx1ZSh2KTsKICAgICAgICAgICAgICAgIF90aGlzLnJlZnJlc2hWYWxpZGF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaWRhdGVzIGlmIG51bWJlciBvZiBpdGVtcyBoYXMgYmVlbiBsZXNzIHRoYW4gbWluSXRlbXMuCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IHRydWUgaWYgbnVtYmVyIG9mIGl0ZW1zIGhhcyBiZWVuIGxlc3MgdGhhbiBtaW5JdGVtcwogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZU1pbkl0ZW1zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc2NoZW1hLml0ZW1zICYmIHRoaXMuc2NoZW1hLml0ZW1zLm1pbkl0ZW1zKSB7CiAgICAgICAgICAgICAgICBpZiAoJCgiOnNlbGVjdGVkIix0aGlzLmZpZWxkKS5sZW5ndGggPCB0aGlzLnNjaGVtYS5pdGVtcy5taW5JdGVtcykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBWYWxpZGF0ZXMgaWYgbnVtYmVyIG9mIGl0ZW1zIGhhcyBiZWVuIG92ZXIgbWF4SXRlbXMuCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IHRydWUgaWYgbnVtYmVyIG9mIGl0ZW1zIGhhcyBiZWVuIG92ZXIgbWF4SXRlbXMKICAgICAgICAgKi8KICAgICAgICBfdmFsaWRhdGVNYXhJdGVtczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnNjaGVtYS5pdGVtcyAmJiB0aGlzLnNjaGVtYS5pdGVtcy5tYXhJdGVtcykgewogICAgICAgICAgICAgICAgaWYgKCQoIjpzZWxlY3RlZCIsdGhpcy5maWVsZCkubGVuZ3RoID4gdGhpcy5zY2hlbWEuaXRlbXMubWF4SXRlbXMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udGFpbmVyRmllbGQjaGFuZGxlVmFsaWRhdGUKICAgICAgICAgKi8KICAgICAgICBoYW5kbGVWYWxpZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBiYXNlU3RhdHVzID0gdGhpcy5iYXNlKCk7CgogICAgICAgICAgICB2YXIgdmFsSW5mbyA9IHRoaXMudmFsaWRhdGlvbjsKCiAgICAgICAgICAgIHZhciBzdGF0dXMgPSB0aGlzLl92YWxpZGF0ZU1heEl0ZW1zKCk7CiAgICAgICAgICAgIHZhbEluZm9bInRvb01hbnlJdGVtcyJdID0gewogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiBzdGF0dXMgPyAiIiA6IEFscGFjYS5zdWJzdGl0dXRlVG9rZW5zKHRoaXMudmlldy5nZXRNZXNzYWdlKCJ0b29NYW55SXRlbXMiKSwgW3RoaXMuc2NoZW1hLml0ZW1zLm1heEl0ZW1zXSksCiAgICAgICAgICAgICAgICAic3RhdHVzIjogc3RhdHVzCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBzdGF0dXMgPSB0aGlzLl92YWxpZGF0ZU1pbkl0ZW1zKCk7CiAgICAgICAgICAgIHZhbEluZm9bIm5vdEVub3VnaEl0ZW1zIl0gPSB7CiAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHN0YXR1cyA/ICIiIDogQWxwYWNhLnN1YnN0aXR1dGVUb2tlbnModGhpcy52aWV3LmdldE1lc3NhZ2UoIm5vdEVub3VnaEl0ZW1zIiksIFt0aGlzLnNjaGVtYS5pdGVtcy5taW5JdGVtc10pLAogICAgICAgICAgICAgICAgInN0YXR1cyI6IHN0YXR1cwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgcmV0dXJuIGJhc2VTdGF0dXMgJiYgdmFsSW5mb1sidG9vTWFueUl0ZW1zIl1bInN0YXR1cyJdICYmIHZhbEluZm9bIm5vdEVub3VnaEl0ZW1zIl1bInN0YXR1cyJdOwogICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5MaXN0RmllbGQjZ2V0U2NoZW1hT2ZPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgIm11bHRpcGxlIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiTXVsaXRwbGUgU2VsZWN0aW9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkFsbG93IG11bHRpcGxlIHNlbGVjdGlvbiBpZiB0cnVlLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAic2l6ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkRpc3BsYXllZCBPcHRpb25zIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIk51bWJlciBvZiBvcHRpb25zIHRvIGJlIHNob3duLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm51bWJlciIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJlbXB0eVNlbGVjdEZpcnN0IjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRW1wdHkgU2VsZWN0IEZpcnN0IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIklmIHRoZSBkYXRhIGlzIGVtcHR5LCB0aGVuIGF1dG9tYXRpY2FsbHkgc2VsZWN0IHRoZSBmaXJzdCBpdGVtIGluIHRoZSBsaXN0LiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5MaXN0RmllbGQjZ2V0T3B0aW9uc0Zvck9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgIm11bHRpcGxlIjogewogICAgICAgICAgICAgICAgICAgICAgICAicmlnaHRMYWJlbCI6ICJBbGxvdyBtdWx0aXBsZSBzZWxlY3Rpb24gPyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJoZWxwZXIiOiAiQWxsb3cgbXVsdGlwbGUgc2VsZWN0aW9uIGlmIGNoZWNrZWQiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJzaXplIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZ2V0VGl0bGUKICAgICAgICAgKi8KICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiRHJvcGRvd24gU2VsZWN0IjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJEcm9wZG93biBzZWxlY3QgZmllbGQuIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRGaWVsZFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gInNlbGVjdCI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCgogICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyVGVtcGxhdGUoImNvbnRyb2xGaWVsZFNlbGVjdCIsICc8c2VsZWN0IGlkPSIke2lkfSIge3tpZiBvcHRpb25zLnJlYWRvbmx5fX1yZWFkb25seT0icmVhZG9ubHkie3svaWZ9fSB7e2lmIG9wdGlvbnMubXVsdGlwbGV9fW11bHRpcGxle3svaWZ9fSB7e2lmIG9wdGlvbnMuc2l6ZX19c2l6ZT0iJHtvcHRpb25zLnNpemV9Int7L2lmfX0ge3tpZiBuYW1lfX1uYW1lPSIke25hbWV9Int7L2lmfX0+e3tpZiAhcmVxdWlyZWQgJiYgIXJlbW92ZURlZmF1bHROb25lfX08b3B0aW9uIHZhbHVlPSIiPk5vbmU8L29wdGlvbj57ey9pZn19e3tlYWNoKGksdmFsdWUpIHNlbGVjdE9wdGlvbnN9fTxvcHRpb24gdmFsdWU9IiR7dmFsdWV9IiB7e2lmIHZhbHVlID09IGRhdGF9fXNlbGVjdGVkPSJzZWxlY3RlZCJ7ey9pZn19PiR7dGV4dH08L29wdGlvbj57ey9lYWNofX08L3NlbGVjdD4nKTsKICAgIEFscGFjYS5yZWdpc3RlclRlbXBsYXRlKCJjb250cm9sRmllbGRTZWxlY3RNdWx0aXBsZSIsICc8c2VsZWN0IGlkPSIke2lkfSIge3tpZiBvcHRpb25zLnJlYWRvbmx5fX1yZWFkb25seT0icmVhZG9ubHkie3svaWZ9fSB7e2lmIG9wdGlvbnMubXVsdGlwbGV9fW11bHRpcGxlPSJtdWx0aXBsZSJ7ey9pZn19IHt7aWYgb3B0aW9ucy5zaXplfX1zaXplPSIke29wdGlvbnMuc2l6ZX0ie3svaWZ9fSB7e2lmIG5hbWV9fW5hbWU9IiR7bmFtZX0ie3svaWZ9fT57e2lmICFyZXF1aXJlZCAmJiAhcmVtb3ZlRGVmYXVsdE5vbmV9fTxvcHRpb24gdmFsdWU9IiI+Tm9uZTwvb3B0aW9uPnt7L2lmfX17e2VhY2goaSx2YWx1ZSkgc2VsZWN0T3B0aW9uc319PG9wdGlvbiB2YWx1ZT0iJHt2YWx1ZX0iIHt7ZWFjaChqLHZhbCkgZGF0YX19e3tpZiB2YWx1ZSA9PSB2YWx9fXNlbGVjdGVkPSJzZWxlY3RlZCJ7ey9pZn19e3svZWFjaH19PiR7dGV4dH08L29wdGlvbj57ey9lYWNofX08L3NlbGVjdD4nKTsKICAgIEFscGFjYS5yZWdpc3RlckZpZWxkQ2xhc3MoInNlbGVjdCIsIEFscGFjYS5GaWVsZHMuU2VsZWN0RmllbGQpOwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5OdW1iZXJGaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuTnVtYmVyRmllbGQucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuRmllbGRzLlRleHRGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIENvbnRyb2wgZm9yIEpTT04gc2NoZW1hIG51bWJlciB0eXBlLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IGRhdGEgRmllbGQgZGF0YS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBGaWVsZCBvcHRpb25zLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBGaWVsZCB2aWV3LgogICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbm5lY3Rvcn0gY29ubmVjdG9yIEZpZWxkIGNvbm5lY3Rvci4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFZhbHVlCiAgICAgICAgICovCiAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgdGV4dFZhbHVlID0gdGhpcy5maWVsZC52YWwoKTsKICAgICAgICAgICAgaWYgKEFscGFjYS5pc1ZhbEVtcHR5KHRleHRWYWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZUZsb2F0KHRleHRWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIAogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjcG9zdFJlbmRlcgogICAgICAgICAqLwogICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLW51bWJlcicpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgkJCQkKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2hhbmRsZVZhbGlkYXRlCiAgICAgICAgICovCiAgICAgICAgaGFuZGxlVmFsaWRhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYmFzZVN0YXR1cyA9IHRoaXMuYmFzZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHZhbEluZm8gPSB0aGlzLnZhbGlkYXRpb247CgkJCQoJCQl2YXIgc3RhdHVzID0gdGhpcy5fdmFsaWRhdGVOdW1iZXIoKTsKICAgICAgICAgICAgdmFsSW5mb1sic3RyaW5nTm90QU51bWJlciJdID0gewogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiBzdGF0dXMgPyAiIiA6IHRoaXMudmlldy5nZXRNZXNzYWdlKCJzdHJpbmdOb3RBTnVtYmVyIiksCiAgICAgICAgICAgICAgICAic3RhdHVzIjogc3RhdHVzCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBzdGF0dXMgPSB0aGlzLl92YWxpZGF0ZURpdmlzaWJsZUJ5KCk7CgkJCXZhbEluZm9bInN0cmluZ0RpdmlzaWJsZUJ5Il0gPSB7CiAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHN0YXR1cyA/ICIiIDogQWxwYWNhLnN1YnN0aXR1dGVUb2tlbnModGhpcy52aWV3LmdldE1lc3NhZ2UoInN0cmluZ0RpdmlzaWJsZUJ5IiksIFt0aGlzLnNjaGVtYS5kaXZpc2libGVCeV0pLAogICAgICAgICAgICAgICAgInN0YXR1cyI6IHN0YXR1cwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgc3RhdHVzID0gdGhpcy5fdmFsaWRhdGVNYXhpbXVtKCk7CgkJCXZhbEluZm9bInN0cmluZ1ZhbHVlVG9vTGFyZ2UiXSA9IHsKICAgICAgICAgICAgICAgICJtZXNzYWdlIjogIiIsCiAgICAgICAgICAgICAgICAic3RhdHVzIjogc3RhdHVzCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmICghc3RhdHVzKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zY2hlbWEuZXhjbHVzaXZlTWF4aW11bSkgewogICAgICAgICAgICAgICAgICAgIHZhbEluZm9bInN0cmluZ1ZhbHVlVG9vTGFyZ2UiXVsibWVzc2FnZSJdID0gQWxwYWNhLnN1YnN0aXR1dGVUb2tlbnModGhpcy52aWV3LmdldE1lc3NhZ2UoInN0cmluZ1ZhbHVlVG9vTGFyZ2VFeGNsdXNpdmUiKSwgW3RoaXMuc2NoZW1hLm1heGltdW1dKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFsSW5mb1sic3RyaW5nVmFsdWVUb29MYXJnZSJdWyJtZXNzYWdlIl0gPSBBbHBhY2Euc3Vic3RpdHV0ZVRva2Vucyh0aGlzLnZpZXcuZ2V0TWVzc2FnZSgic3RyaW5nVmFsdWVUb29MYXJnZSIpLCBbdGhpcy5zY2hlbWEubWF4aW11bV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgkJCQoJCQlzdGF0dXMgPSB0aGlzLl92YWxpZGF0ZU1pbmltdW0oKTsKICAgICAgICAgICAgdmFsSW5mb1sic3RyaW5nVmFsdWVUb29TbWFsbCJdID0gewogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiAiIiwKICAgICAgICAgICAgICAgICJzdGF0dXMiOiBzdGF0dXMKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKCFzdGF0dXMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNjaGVtYS5leGNsdXNpdmVNaW5pbXVtKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsSW5mb1sic3RyaW5nVmFsdWVUb29TbWFsbCJdWyJtZXNzYWdlIl0gPSBBbHBhY2Euc3Vic3RpdHV0ZVRva2Vucyh0aGlzLnZpZXcuZ2V0TWVzc2FnZSgic3RyaW5nVmFsdWVUb29TbWFsbEV4Y2x1c2l2ZSIpLCBbdGhpcy5zY2hlbWEubWluaW11bV0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YWxJbmZvWyJzdHJpbmdWYWx1ZVRvb1NtYWxsIl1bIm1lc3NhZ2UiXSA9IEFscGFjYS5zdWJzdGl0dXRlVG9rZW5zKHRoaXMudmlldy5nZXRNZXNzYWdlKCJzdHJpbmdWYWx1ZVRvb1NtYWxsIiksIFt0aGlzLnNjaGVtYS5taW5pbXVtXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN0YXR1cyA9IHRoaXMuX3ZhbGlkYXRlTXVsdGlwbGVPZigpOwogICAgICAgICAgICB2YWxJbmZvWyJzdHJpbmdWYWx1ZU5vdE11bHRpcGxlT2YiXSA9IHsKICAgICAgICAgICAgICAgICJtZXNzYWdlIjogIiIsCiAgICAgICAgICAgICAgICAic3RhdHVzIjogc3RhdHVzCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmICghc3RhdHVzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YWxJbmZvWyJzdHJpbmdWYWx1ZU5vdE11bHRpcGxlT2YiXVsibWVzc2FnZSJdID0gQWxwYWNhLnN1YnN0aXR1dGVUb2tlbnModGhpcy52aWV3LmdldE1lc3NhZ2UoInN0cmluZ1ZhbHVlTm90TXVsdGlwbGVPZiIpLCBbdGhpcy5zY2hlbWEubXVsdGlwbGVPZl0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBoYW5kIGJhY2sgYSB0cnVlL2ZhbHNlCiAgICAgICAgICAgIHJldHVybiBiYXNlU3RhdHVzICYmIHZhbEluZm9bInN0cmluZ05vdEFOdW1iZXIiXVsic3RhdHVzIl0gJiYgdmFsSW5mb1sic3RyaW5nRGl2aXNpYmxlQnkiXVsic3RhdHVzIl0gJiYgdmFsSW5mb1sic3RyaW5nVmFsdWVUb29MYXJnZSJdWyJzdGF0dXMiXSAmJiB2YWxJbmZvWyJzdHJpbmdWYWx1ZVRvb1NtYWxsIl1bInN0YXR1cyJdICYmIHZhbEluZm9bInN0cmluZ1ZhbHVlTm90TXVsdGlwbGVPZiJdWyJzdGF0dXMiXTsKICAgICAgICB9LAogICAgICAgIAogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlcyBpZiBpdCBpcyBhIGZsb2F0IG51bWJlci4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gdHJ1ZSBpZiBpdCBpcyBhIGZsb2F0IG51bWJlcgogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZU51bWJlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB0ZXh0VmFsdWUgPSB0aGlzLmZpZWxkLnZhbCgpOwogICAgICAgICAgICAvLyBhbGxvdyBudWxsCiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNWYWxFbXB0eSh0ZXh0VmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZmxvYXRWYWx1ZSA9IHRoaXMuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIHF1aWNrIGNoZWNrIHRvIHNlZSBpZiB3aGF0IHRoZXkgZW50ZXJlZCB3YXMgYSBudW1iZXIKICAgICAgICAgICAgaWYgKGlzTmFOKGZsb2F0VmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIGNoZWNrIGlmIHZhbGlkIG51bWJlciBmb3JtYXQKICAgICAgICAgICAgaWYgKCF0ZXh0VmFsdWUubWF0Y2goQWxwYWNhLnJlZ2V4cHMubnVtYmVyKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAogICAgICAgIAogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlcyBkaXZpc2libGVCeSBjb25zdHJhaW50LgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSB0cnVlIGlmIGl0IHBhc3NlcyB0aGUgZGl2aXNpYmxlQnkgY29uc3RyYWludC4KICAgICAgICAgKi8KICAgICAgICBfdmFsaWRhdGVEaXZpc2libGVCeTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBmbG9hdFZhbHVlID0gdGhpcy5nZXRWYWx1ZSgpOwogICAgICAgICAgICBpZiAoIUFscGFjYS5pc0VtcHR5KHRoaXMuc2NoZW1hLmRpdmlzaWJsZUJ5KSkgewoKICAgICAgICAgICAgICAgIC8vIG1vZAogICAgICAgICAgICAgICAgaWYgKGZsb2F0VmFsdWUgJSB0aGlzLnNjaGVtYS5kaXZpc2libGVCeSAhPT0gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAvKioKICAgICAgICAgKiBWYWxpZGF0ZXMgbWF4aW11bSBjb25zdHJhaW50LgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSB0cnVlIGlmIGl0IHBhc3NlcyB0aGUgbWF4aW11bSBjb25zdHJhaW50LgogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZU1heGltdW06IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgZmxvYXRWYWx1ZSA9IHRoaXMuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghQWxwYWNhLmlzRW1wdHkodGhpcy5zY2hlbWEubWF4aW11bSkpIHsKICAgICAgICAgICAgICAgIGlmIChmbG9hdFZhbHVlID4gdGhpcy5zY2hlbWEubWF4aW11bSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eSh0aGlzLnNjaGVtYS5leGNsdXNpdmVNYXhpbXVtKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChmbG9hdFZhbHVlID09IHRoaXMuc2NoZW1hLm1heGltdW0gJiYgdGhpcy5zY2hlbWEuZXhjbHVzaXZlTWF4aW11bSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAogICAgICAgIAogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlcyBtYXhpbXVtIGNvbnN0cmFpbnQuCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IHRydWUgaWYgaXQgcGFzc2VzIHRoZSBtaW5pbXVtIGNvbnN0cmFpbnQuCiAgICAgICAgICovCiAgICAgICAgX3ZhbGlkYXRlTWluaW11bTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBmbG9hdFZhbHVlID0gdGhpcy5nZXRWYWx1ZSgpOwoKICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eSh0aGlzLnNjaGVtYS5taW5pbXVtKSkgewogICAgICAgICAgICAgICAgaWYgKGZsb2F0VmFsdWUgPCB0aGlzLnNjaGVtYS5taW5pbXVtKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc0VtcHR5KHRoaXMuc2NoZW1hLmV4Y2x1c2l2ZU1pbmltdW0pKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZsb2F0VmFsdWUgPT0gdGhpcy5zY2hlbWEubWluaW11bSAmJiB0aGlzLnNjaGVtYS5leGNsdXNpdmVNaW5pbXVtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlcyBtdWx0aXBsZU9mIGNvbnN0cmFpbnQuCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IHRydWUgaWYgaXQgcGFzc2VzIHRoZSBtdWx0aXBsZU9mIGNvbnN0cmFpbnQuCiAgICAgICAgICovCiAgICAgICAgX3ZhbGlkYXRlTXVsdGlwbGVPZjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBmbG9hdFZhbHVlID0gdGhpcy5nZXRWYWx1ZSgpOwoKICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eSh0aGlzLnNjaGVtYS5tdWx0aXBsZU9mKSkgewogICAgICAgICAgICAgICAgaWYgKGZsb2F0VmFsdWUgJiYgdGhpcy5zY2hlbWEubXVsdGlwbGVPZiAhPT0gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCgogICAgICAgIC8vX19CVUlMREVSX0hFTFBFUlMKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFNjaGVtYU9mU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZTY2hlbWE6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CgkJCQkicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAibXVsdGlwbGVPZiI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIk11bHRpcGxlIE9mIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlByb3BlcnR5IHZhbHVlIG11c3QgYmUgYSBtdWx0aXBsZSBvZiB0aGUgbXVsdGlwbGVPZiBzY2hlbWEgcHJvcGVydHkgc3VjaCB0aGF0IGRpdmlzaW9uIGJ5IHRoaXMgdmFsdWUgeWllbGRzIGFuIGludGVyZ2VyIChtb2QgemVybykuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibnVtYmVyIgogICAgICAgICAgICAgICAgICAgIH0sCgkJCQkJIm1pbmltdW0iOiB7CgkJCQkJCSJ0aXRsZSI6ICJNaW5pbXVtIiwKCQkJCQkJImRlc2NyaXB0aW9uIjogIk1pbmltdW0gdmFsdWUgb2YgdGhlIHByb3BlcnR5LiIsCgkJCQkJCSJ0eXBlIjogIm51bWJlciIKCQkJCQl9LAoJCQkJCSJtYXhpbXVtIjogewoJCQkJCQkidGl0bGUiOiAiTWF4aW11bSIsCgkJCQkJCSJkZXNjcmlwdGlvbiI6ICJNYXhpbXVtIHZhbHVlIG9mIHRoZSBwcm9wZXJ0eS4iLAoJCQkJCQkidHlwZSI6ICJudW1iZXIiCgkJCQkJfSwKCQkJCQkiZXhjbHVzaXZlTWluaW11bSI6IHsKCQkJCQkJInRpdGxlIjogIkV4Y2x1c2l2ZSBNaW5pbXVtIiwKCQkJCQkJImRlc2NyaXB0aW9uIjogIlByb3BlcnR5IHZhbHVlIGNhbiBub3QgZXF1YWwgdGhlIG51bWJlciBkZWZpbmVkIGJ5IHRoZSBtaW5pbXVtIHNjaGVtYSBwcm9wZXJ0eS4iLAoJCQkJCQkidHlwZSI6ICJib29sZWFuIiwKCQkJCQkJImRlZmF1bHQiOiBmYWxzZQoJCQkJCX0sCgkJCQkJImV4Y2x1c2l2ZU1heGltdW0iOiB7CgkJCQkJCSJ0aXRsZSI6ICJFeGNsdXNpdmUgTWF4aW11bSIsCgkJCQkJCSJkZXNjcmlwdGlvbiI6ICJQcm9wZXJ0eSB2YWx1ZSBjYW4gbm90IGVxdWFsIHRoZSBudW1iZXIgZGVmaW5lZCBieSB0aGUgbWF4aW11bSBzY2hlbWEgcHJvcGVydHkuIiwKCQkJCQkJInR5cGUiOiAiYm9vbGVhbiIsCgkJCQkJCSJkZWZhdWx0IjogZmFsc2UKCQkJCQl9CgkJCQl9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRPcHRpb25zU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0ZvclNjaGVtYTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKCQkJCSJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgIm11bHRpcGxlT2YiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJNdWx0aXBsZSBPZiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJUaGUgdmFsdWUgbXVzdCBiZSBhIGludGVncmFsIG11bHRpcGxlIG9mIHRoZSBwcm9wZXJ0eSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm51bWJlciIKICAgICAgICAgICAgICAgICAgICB9LAoJCQkJCSJtaW5pbXVtIjogewoJCQkJCQkidGl0bGUiOiAiTWluaW11bSIsCgkJCQkJCSJkZXNjcmlwdGlvbiI6ICJNaW5pbXVtIHZhbHVlIG9mIHRoZSBwcm9wZXJ0eSIsCgkJCQkJCSJ0eXBlIjogIm51bWJlciIKCQkJCQl9LAoJCQkJCSJtYXhpbXVtIjogewoJCQkJCQkidGl0bGUiOiAiTWF4aW11bSIsCgkJCQkJCSJkZXNjcmlwdGlvbiI6ICJNYXhpbXVtIHZhbHVlIG9mIHRoZSBwcm9wZXJ0eSIsCgkJCQkJCSJ0eXBlIjogIm51bWJlciIKCQkJCQl9LAoJCQkJCSJleGNsdXNpdmVNaW5pbXVtIjogewoJCQkJCQkicmlnaHRMYWJlbCI6ICJFeGNsdXNpdmUgbWluaW11bSA/IiwKCQkJCQkJImhlbHBlciI6ICJGaWVsZCB2YWx1ZSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBidXQgbm90IGVxdWFsIHRvIHRoaXMgbnVtYmVyIGlmIGNoZWNrZWQiLAoJCQkJCQkidHlwZSI6ICJjaGVja2JveCIKCQkJCQl9LAoJCQkJCSJleGNsdXNpdmVNYXhpbXVtIjogewoJCQkJCQkicmlnaHRMYWJlbCI6ICJFeGNsdXNpdmUgTWF4aW11bSA/IiwKCQkJCQkJImhlbHBlciI6ICJGaWVsZCB2YWx1ZSBtdXN0IGJlIGxlc3MgdGhhbiBidXQgbm90IGVxdWFsIHRvIHRoaXMgbnVtYmVyIGlmIGNoZWNrZWQiLAoJCQkJCQkidHlwZSI6ICJjaGVja2JveCIKCQkJCQl9CgkJCQl9CgkJCX0pOwoJCX0sCgoJCS8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0VGl0bGUKCQkgKi8KCQlnZXRUaXRsZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAiTnVtYmVyIEZpZWxkIjsKCQl9LAoJCQoJCS8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RGVzY3JpcHRpb24KCQkgKi8KCQlnZXREZXNjcmlwdGlvbjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAiRmllbGQgZm9yIGZsb2F0IG51bWJlcnMuIjsKCQl9LAoKCQkvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJudW1iZXIiOwogICAgICAgIH0sCgoJCS8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RmllbGRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJudW1iZXIiOwogICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgfSk7CiAgICAKICAgIC8vIEFkZGl0aW9uYWwgUmVnaXN0cmF0aW9ucwogICAgQWxwYWNhLnJlZ2lzdGVyTWVzc2FnZXMoewogICAgICAgICJzdHJpbmdWYWx1ZVRvb1NtYWxsIjogIlRoZSBtaW5pbXVtIHZhbHVlIGZvciB0aGlzIGZpZWxkIGlzIHswfSIsCiAgICAgICAgInN0cmluZ1ZhbHVlVG9vTGFyZ2UiOiAiVGhlIG1heGltdW0gdmFsdWUgZm9yIHRoaXMgZmllbGQgaXMgezB9IiwKICAgICAgICAic3RyaW5nVmFsdWVUb29TbWFsbEV4Y2x1c2l2ZSI6ICJWYWx1ZSBvZiB0aGlzIGZpZWxkIG11c3QgYmUgZ3JlYXRlciB0aGFuIHswfSIsCiAgICAgICAgInN0cmluZ1ZhbHVlVG9vTGFyZ2VFeGNsdXNpdmUiOiAiVmFsdWUgb2YgdGhpcyBmaWVsZCBtdXN0IGJlIGxlc3MgdGhhbiB7MH0iLAogICAgICAgICJzdHJpbmdEaXZpc2libGVCeSI6ICJUaGUgdmFsdWUgbXVzdCBiZSBkaXZpc2libGUgYnkgezB9IiwKICAgICAgICAic3RyaW5nTm90QU51bWJlciI6ICJUaGlzIHZhbHVlIGlzIG5vdCBhIG51bWJlci4iLAogICAgICAgICJzdHJpbmdWYWx1ZU5vdE11bHRpcGxlT2YiOiAiVGhpcyB2YWx1ZSBpcyBudSIKICAgIH0pOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygibnVtYmVyIiwgQWxwYWNhLkZpZWxkcy5OdW1iZXJGaWVsZCk7CiAgICBBbHBhY2EucmVnaXN0ZXJEZWZhdWx0U2NoZW1hRmllbGRNYXBwaW5nKCJudW1iZXIiLCAibnVtYmVyIik7Cn0pKGpRdWVyeSk7Ci8qanNoaW50IC1XMDgzICovIC8vIGlubGluZSBmdW5jdGlvbnMgYXJlIHVzZWQgc2FmZWx5CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuQXJyYXlGaWVsZCA9IEFscGFjYS5Db250YWluZXJGaWVsZC5leHRlbmQoCiAgICAvKioKICAgICAqIEBsZW5kcyBBbHBhY2EuRmllbGRzLkFycmF5RmllbGQucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuQ29udGFpbmVyRmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBEZWZhdWx0IGNvbnRyb2wgZm9yIHRoZSB0cmVhdG1lbnQgb2YgYSBKU09OIGFycmF5LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IGRhdGEgRmllbGQgZGF0YS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBGaWVsZCBvcHRpb25zLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBGaWVsZCB2aWV3LgogICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbm5lY3Rvcn0gY29ubmVjdG9yIEZpZWxkIGNvbm5lY3Rvci4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250YWluZXJGaWVsZCNzZXR1cAogICAgICAgICAqLwogICAgICAgIHNldHVwOiBmdW5jdGlvbigpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmJhc2UoKTsKCiAgICAgICAgICAgIHRoaXMub3B0aW9ucy50b29sYmFyU3R5bGUgPSBBbHBhY2EuaXNFbXB0eSh0aGlzLnZpZXcudG9vbGJhclN0eWxlKSA/ICJidXR0b24iIDogdGhpcy52aWV3LnRvb2xiYXJTdHlsZTsKCiAgICAgICAgICAgIC8vIGRldGVybWluZSB3aGV0aGVyIHdlIGFyZSB1c2luZyAicnVieSBvbiByYWlscyIgY29tcGF0aWJpbGl0eSBtb2RlCiAgICAgICAgICAgIHRoaXMub3B0aW9ucy5ydWJ5cmFpbHMgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRoaXMucGFyZW50ICYmIHRoaXMucGFyZW50Lm9wdGlvbnMgJiYgdGhpcy5wYXJlbnQub3B0aW9ucy5mb3JtICYmIHRoaXMucGFyZW50Lm9wdGlvbnMuZm9ybS5hdHRyaWJ1dGVzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc0VtcHR5KHRoaXMucGFyZW50Lm9wdGlvbnMuZm9ybS5hdHRyaWJ1dGVzLnJ1YnlyYWlscykpCiAgICAgICAgICAgICAgICB7CgkgIAkgICAgICAgICAgICB0aGlzLm9wdGlvbnMucnVieXJhaWxzID0gdHJ1ZTsKCSAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuaXRlbXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5pdGVtcyA9IHt9OwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgdG9vbGJhclN0aWNreSA9IGZhbHNlOwoKICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eSh0aGlzLnZpZXcudG9vbGJhclN0aWNreSkpIHsKICAgICAgICAgICAgICAgIHRvb2xiYXJTdGlja3kgPSB0aGlzLnZpZXcudG9vbGJhclN0aWNreTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eSh0aGlzLm9wdGlvbnMudG9vbGJhclN0aWNreSkpIHsKICAgICAgICAgICAgICAgIHRvb2xiYXJTdGlja3kgPSB0aGlzLm9wdGlvbnMudG9vbGJhclN0aWNreTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKEFscGFjYS5pc0VtcHR5KHRoaXMub3B0aW9ucy5pdGVtcy5zaG93TW92ZVVwSXRlbUJ1dHRvbikpIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5pdGVtcy5zaG93TW92ZVVwSXRlbUJ1dHRvbiA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNFbXB0eSh0aGlzLm9wdGlvbnMuaXRlbXMuc2hvd01vdmVEb3duSXRlbUJ1dHRvbikpIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5pdGVtcy5zaG93TW92ZURvd25JdGVtQnV0dG9uID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5vcHRpb25zLnRvb2xiYXJTdGlja3kgPSB0b29sYmFyU3RpY2t5OwoKICAgICAgICAgICAgLy8gRW5hYmxlIGZvcmNlUmV2YWxpZGF0aW9uIG9wdGlvbiBzbyB0aGF0IGFueSBjaGFuZ2UgaW4gY2hpbGRyZW4gd2lsbCB0cmlnZ2VyIHBhcmVudCdzIHJldmFsaWRhdGlvbi4KICAgICAgICAgICAgaWYgKHRoaXMuc2NoZW1hLml0ZW1zICYmIHRoaXMuc2NoZW1hLnVuaXF1ZUl0ZW1zKSB7CiAgICAgICAgICAgICAgICBBbHBhY2EubWVyZ2VPYmplY3QodGhpcy5vcHRpb25zLCB7CiAgICAgICAgICAgICAgICAgICAgImZvcmNlUmV2YWxpZGF0aW9uIiA6IHRydWUKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkodGhpcy5kYXRhKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghQWxwYWNhLmlzQXJyYXkodGhpcy5kYXRhKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNTdHJpbmcodGhpcy5kYXRhKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXRhID0gQWxwYWNhLnBhcnNlSlNPTih0aGlzLmRhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc0FycmF5KHRoaXMuZGF0YSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFscGFjYS5sb2dXYXJuKCJBcnJheUZpZWxkIHBhcnNlZCBkYXRhIGJ1dCBpdCB3YXMgbm90IGFuIGFycmF5OiAiICsgSlNPTi5zdHJpbmdpZnkodGhpcy5kYXRhKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGF0YSA9IFt0aGlzLmRhdGFdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFBpY2tzIGFwYXJ0IHRoZSBhcnJheSBhbmQgc2V0IG9udG8gY2hpbGQgZmllbGRzLgogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRhaW5lckZpZWxkI3NldHVwCiAgICAgICAgICovCiAgICAgICAgc2V0VmFsdWU6IGZ1bmN0aW9uKGRhdGEpIHsKCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICBpZiAoIWRhdGEgfHwgIUFscGFjYS5pc0FycmF5KGRhdGEpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHNldCBmaWVsZHMKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgY2hpbGRGaWVsZCA9IHRoaXMuY2hpbGRyZW5baV07CiAgICAgICAgICAgICAgICBpZiAoZGF0YS5sZW5ndGggPiBpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGNoaWxkRmllbGQuc2V0VmFsdWUoZGF0YVtpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVJdGVtKGNoaWxkRmllbGQuaWQpOyAvL3JlbW92ZSBjaGlsZCBpdGVtcyBpZiB0aGVyZSBhcmUgbW9yZSBjaGlsZHJlbiB0aGFuIGluIGRhdGEKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaWYgdGhlIG51bWJlciBvZiBpdGVtcyBpbiB0aGUgZGF0YSBpcyBncmVhdGVyIHRoYW4gdGhlIG51bWJlciBvZiBleGlzdGluZyBjaGlsZCBlbGVtZW50cwogICAgICAgICAgICAvLyB0aGVuIHdlIG5lZWQgdG8gYWRkIHRoZSBuZXcgZmllbGRzCgogICAgICAgICAgICBpZiAoaSA8IGRhdGEubGVuZ3RoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBfdGhpcy5yZXNvbHZlSXRlbVNjaGVtYU9wdGlvbnMoZnVuY3Rpb24oc2NoZW1hLCBvcHRpb25zKSB7CgogICAgICAgICAgICAgICAgICAgIC8vIHdhdGVyZmFsbCBmdW5jdGlvbnMKICAgICAgICAgICAgICAgICAgICB2YXIgZnVuY3MgPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGkgPCBkYXRhLmxlbmd0aCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmID0gKGZ1bmN0aW9uKGksIGRhdGEpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihjYWxsYmFjaykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5hZGRJdGVtKGksIHNjaGVtYSwgb3B0aW9ucywgZGF0YVtpXSwgbnVsbCwgZmFsc2UsIGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYnkgdGhlIHRpbWUgd2UgZ2V0IGhlcmUsIHdlIG1heSBoYXZlIGNvbnN0cnVjdGVkIGEgdmVyeSBsYXJnZSBjaGlsZCBjaGFpbiBvZgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzdWItZGVwZW5kZW5jaWVzIGFuZCBzbyB3ZSB1c2UgbmV4dFRpY2soKSBpbnN0ZWFkIG9mIGEgc3RyYWlnaHQgY2FsbGJhY2sgc28gYXMgdG8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYXZvaWQgYmxvd2luZyBvdXQgdGhlIHN0YWNrIHNpemUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQWxwYWNhLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkoaSwgZGF0YVtpXSk7CgogICAgICAgICAgICAgICAgICAgICAgICBmdW5jcy5wdXNoKGYpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIEFscGFjYS5zZXJpZXMoZnVuY3MsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBhbnl0aGluZyBvbmNlIGZpbmlzaGVkPwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250YWluZXJGaWVsZCNnZXRWYWx1ZQogICAgICAgICAqLwogICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIC8vIGlmIHdlJ3JlIGVtcHR5IGFuZCB3ZSdyZSBhbHNvIG5vdCByZXF1aXJlZCwgdGhlbiB3ZSBoYW5kIGJhY2sgdW5kZWZpbmVkCiAgICAgICAgICAgIGlmICh0aGlzLmNoaWxkcmVuLmxlbmd0aCA9PT0gMCAmJiAhdGhpcy5zY2hlbWEucmVxdWlyZWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gb3RoZXJ3aXNlLCBjb25zdHJ1Y3QgYW4gYXJyYXkgYW5kIGhhZCBpdCBiYWNrCiAgICAgICAgICAgIHZhciBvID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHYgPSB0aGlzLmNoaWxkcmVuW2ldLmdldFZhbHVlKCk7CgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZih2KSAhPT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgby5wdXNoKHYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgbnVtYmVyIG9mIGNoaWxkcmVuLgogICAgICAgICAqLwogICAgICAgIGdldFNpemU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jaGlsZHJlbi5sZW5ndGg7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVjdXJzaXZlIGZ1bmN0aW9uIGZvciBVcGRhdGUgY2hpbGQgZmllbGQgcGF0aCBhbmQgbmFtZS4KICAgICAgICAgKi8KICAgICAgICB1cGRhdGVDaGlsZHJlblBhdGhBbmROYW1lOiBmdW5jdGlvbihwYXJlbnQpIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgICAgICAgaWYgKHBhcmVudC5jaGlsZHJlbikgewogICAgICAgICAgICAgICAgJC5lYWNoKHBhcmVudC5jaGlsZHJlbiwgZnVuY3Rpb24oaSwgdikgewogICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQucHJlUGF0aCAmJiBBbHBhY2Euc3RhcnRzV2l0aCh2LnBhdGgscGFyZW50LnByZVBhdGgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHYucHJlUGF0aCA9IHYucGF0aDsKICAgICAgICAgICAgICAgICAgICAgICAgdi5wYXRoID0gdi5wYXRoLnJlcGxhY2UocGFyZW50LnByZVBhdGgscGFyZW50LnBhdGgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyByZS1jYWxjdWxhdGUgbmFtZQogICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQucHJlTmFtZSAmJiBBbHBhY2Euc3RhcnRzV2l0aCh2Lm5hbWUsIHBhcmVudC5wcmVOYW1lKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2LnByZU5hbWUgPSB2Lm5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHYubmFtZSA9IHYubmFtZS5yZXBsYWNlKHBhcmVudC5wcmVOYW1lLCBwYXJlbnQubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2LmZpZWxkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKHYuZmllbGQpLmF0dHIoJ25hbWUnLCB2Lm5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIF90aGlzLnVwZGF0ZUNoaWxkcmVuUGF0aEFuZE5hbWUodik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFVwZGF0ZSBmaWVsZCBwYXRoIGFuZCBuYW1lIHdoZW4gYW4gYXJyYXkgaXRlbSBpcyByZW1vdmVkLCBpbnNlcnRlZCBvciBzd2l0Y2hlZC4KICAgICAgICAgKi8KICAgICAgICB1cGRhdGVQYXRoQW5kTmFtZTogZnVuY3Rpb24oKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgICAgICAgaWYgKHRoaXMuY2hpbGRyZW4pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICQuZWFjaCh0aGlzLmNoaWxkcmVuLGZ1bmN0aW9uKGksdikgewogICAgICAgICAgICAgICAgICAgIHZhciBpZHggPSB2LnBhdGgubGFzdEluZGV4T2YoJy8nKTsKICAgICAgICAgICAgICAgICAgICB2YXIgbGFzdFNlZ21lbnQgPSB2LnBhdGguc3Vic3RyaW5nKGlkeCsxKTsKICAgICAgICAgICAgICAgICAgICBpZiAobGFzdFNlZ21lbnQuaW5kZXhPZigiWyIpICE9IC0xICYmIGxhc3RTZWdtZW50LmluZGV4T2YoIl0iKSAhPSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICBsYXN0U2VnbWVudCA9IGxhc3RTZWdtZW50LnN1YnN0cmluZyhsYXN0U2VnbWVudC5pbmRleE9mKCJbIikgKyAxLCBsYXN0U2VnbWVudC5pbmRleE9mKCJdIikpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAobGFzdFNlZ21lbnQgIT0gaSkgewogICAgICAgICAgICAgICAgICAgICAgICB2LnByZVBhdGggPSB2LnBhdGg7CiAgICAgICAgICAgICAgICAgICAgICAgIHYucGF0aCA9IHYucGF0aC5zdWJzdHJpbmcoMCwgaWR4KSArICIvWyIgKyBpICsgIl0iOwoKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gcmUtY2FsY3VsYXRlIG5hbWUKICAgICAgICAgICAgICAgICAgICBpZiAodi5uYW1lQ2FsY3VsYXRlZCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHYucHJlTmFtZSA9IHYubmFtZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2LnBhcmVudCAmJiB2LnBhcmVudC5uYW1lICYmIHYucGF0aCkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdi5uYW1lID0gdi5wYXJlbnQubmFtZSArICJfIiArIGk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodi5wYXRoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHYubmFtZSA9IHYucGF0aC5yZXBsYWNlKC9cLy9nLCAiIikucmVwbGFjZSgvXFsvZywgIl8iKS5yZXBsYWNlKC9cXS9nLCAiIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCgkJCSAgICAgICAgICAgIGlmICh0aGlzLnBhcmVudC5vcHRpb25zLnJ1YnlyYWlscyApCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodi5maWVsZCkuYXR0cignbmFtZScsIHYucGFyZW50Lm5hbWUpOwoJCQkgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCh2LmZpZWxkKS5hdHRyKCduYW1lJywgdi5uYW1lKTsKIAkJCSAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICghdi5wcmVQYXRoKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdi5wcmVQYXRoID0gdi5wYXRoOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBfdGhpcy51cGRhdGVDaGlsZHJlblBhdGhBbmROYW1lKHYpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBNb3ZlcyBjaGlsZCB1cCBvciBkb3duCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGZyb21JZCBJZCBvZiB0aGUgY2hpbGQgdG8gYmUgbW92ZWQuCiAgICAgICAgICogQHBhcmFtIHtCb29sZWFufSBpc1VwIHRydWUgaWYgdGhlIG1vdmluZyBpcyB1cHdhcmRzCiAgICAgICAgICovCiAgICAgICAgbW92ZUl0ZW06IGZ1bmN0aW9uKGZyb21JZCwgaXNVcCkgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICAgICAgICBpZiAodGhpcy5jaGlsZHJlbkJ5SWRbZnJvbUlkXSkgewogICAgICAgICAgICAgICAgLy8gZG8gdGhlIGxvb3AKICAgICAgICAgICAgICAgICQuZWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbihpbmRleCwgdmFsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbC5nZXRJZCgpID09IGZyb21JZCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9JbmRleDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzVXAgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvSW5kZXggPSBpbmRleCAtIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9JbmRleCA8IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0luZGV4ID0gX3RoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvSW5kZXggPSBpbmRleCArIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9JbmRleCA+PSBfdGhpcy5jaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0luZGV4ID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoX3RoaXMuY2hpbGRyZW5bdG9JbmRleF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0b0lkID0gX3RoaXMuY2hpbGRyZW5bdG9JbmRleF0uZ2V0SWQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmcm9tQ29udGFpbmVyID0gJCgnIycgKyBmcm9tSWQgKyAnLWl0ZW0tY29udGFpbmVyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9Db250YWluZXIgPSAkKCcjJyArIHRvSWQgKyAnLWl0ZW0tY29udGFpbmVyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5yZVJlbmRlckl0ZW0oX3RoaXMuY2hpbGRyZW5baW5kZXhdLCB0b0NvbnRhaW5lcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5yZVJlbmRlckl0ZW0oX3RoaXMuY2hpbGRyZW5bdG9JbmRleF0sIGZyb21Db250YWluZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRtcCA9IF90aGlzLmNoaWxkcmVuW2luZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNoaWxkcmVuW2luZGV4XSA9IF90aGlzLmNoaWxkcmVuW3RvSW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY2hpbGRyZW5bdG9JbmRleF0gPSB0bXA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy51cGRhdGVQYXRoQW5kTmFtZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZW1vdmVzIGNoaWxkCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGlkIElkIG9mIHRoZSBjaGlsZCB0byBiZSByZW1vdmVkCiAgICAgICAgICovCiAgICAgICAgcmVtb3ZlSXRlbTogZnVuY3Rpb24oaWQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3ZhbGlkYXRlRXF1YWxNaW5JdGVtcygpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNoaWxkcmVuID0gJC5ncmVwKHRoaXMuY2hpbGRyZW4sIGZ1bmN0aW9uKHZhbCwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKHZhbC5nZXRJZCgpICE9IGlkKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY2hpbGRyZW5CeUlkW2lkXTsKICAgICAgICAgICAgICAgICQoJyMnICsgaWQgKyAiLWl0ZW0tY29udGFpbmVyIiwgdGhpcy5vdXRlckVsKS5yZW1vdmUoKTsKICAgICAgICAgICAgICAgIHRoaXMucmVmcmVzaFZhbGlkYXRpb25TdGF0ZSgpOwogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVUb29sYmFySXRlbXNTdGF0dXMoKTsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlUGF0aEFuZE5hbWUoKTsKCiAgICAgICAgICAgICAgICAvLyB0cmlnZ2VyIHVwZGF0ZSBoYW5kbGVyCiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXJVcGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFVwZGF0ZXMgc3RhdHVzIG9mIHRvb2xiYXIgaXRlbXMuCiAgICAgICAgICovCiAgICAgICAgdXBkYXRlVG9vbGJhckl0ZW1zU3RhdHVzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgICAgICAgLy8gYWRkIGFjdGlvbnMgdG8gdG9vbGJhciBidXR0b25zCiAgICAgICAgICAgIGlmIChfdGhpcy5fdmFsaWRhdGVFcXVhbE1heEl0ZW1zKCkpIHsKICAgICAgICAgICAgICAgICQoJy5hbHBhY2EtZmllbGRzZXQtYXJyYXktaXRlbS10b29sYmFyLWFkZCcsIHRoaXMub3V0ZXJFbCkuZWFjaChmdW5jdGlvbihpbmRleCkgewogICAgICAgICAgICAgICAgICAgICQodGhpcykucmVtb3ZlQ2xhc3MoJ2FscGFjYS1maWVsZHNldC1hcnJheS1pdGVtLXRvb2xiYXItZGlzYWJsZWQnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJCgnLmFscGFjYS1maWVsZHNldC1hcnJheS1pdGVtLXRvb2xiYXItYWRkJywgdGhpcy5vdXRlckVsKS5lYWNoKGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcygnYWxwYWNhLWZpZWxkc2V0LWFycmF5LWl0ZW0tdG9vbGJhci1kaXNhYmxlZCcpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKF90aGlzLl92YWxpZGF0ZUVxdWFsTWluSXRlbXMoKSkgewogICAgICAgICAgICAgICAgJCgnLmFscGFjYS1maWVsZHNldC1hcnJheS1pdGVtLXRvb2xiYXItcmVtb3ZlJywgdGhpcy5vdXRlckVsKS5lYWNoKGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5yZW1vdmVDbGFzcygnYWxwYWNhLWZpZWxkc2V0LWFycmF5LWl0ZW0tdG9vbGJhci1kaXNhYmxlZCcpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkKCcuYWxwYWNhLWZpZWxkc2V0LWFycmF5LWl0ZW0tdG9vbGJhci1yZW1vdmUnLCB0aGlzLm91dGVyRWwpLmVhY2goZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKCdhbHBhY2EtZmllbGRzZXQtYXJyYXktaXRlbS10b29sYmFyLWRpc2FibGVkJyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5nZXRTaXplKCkgPT09IDApIHsKICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyQXJyYXlUb29sYmFyKHRoaXMub3V0ZXJFbCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5hcnJheVRvb2xiYXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFycmF5VG9vbGJhci5yZW1vdmUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyB1cGRhdGUgY291bnRlcgogICAgICAgICAgICAkKCcuYWxwYWNhLWl0ZW0tbGFiZWwtY291bnRlcicsIHRoaXMub3V0ZXJFbCkuZWFjaChmdW5jdGlvbihpbmRleCkgewogICAgICAgICAgICAgICAgJCh0aGlzKS5odG1sKGluZGV4ICsgMSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJlbmRlcnMgYXJyYXkgaXRlbSB0b29sYmFyLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lckVsZW0gVG9vbGJhciBjb250YWluZXIuCiAgICAgICAgICovCiAgICAgICAgcmVuZGVyVG9vbGJhcjogZnVuY3Rpb24oY29udGFpbmVyRWxlbSkgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgLy8gd2UgZG8gbm90IHJlbmRlciB0aGUgdG9vbGJhciBpbiAiZGlzcGxheSIgbW9kZQogICAgICAgICAgICBpZiAodGhpcy52aWV3ICYmIHRoaXMudmlldy50eXBlID09ICJ2aWV3IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5yZWFkb25seSkgewogICAgICAgICAgICAgICAgdmFyIGlkID0gY29udGFpbmVyRWxlbS5hdHRyKCdhbHBhY2EtaWQnKTsKICAgICAgICAgICAgICAgIHZhciBmaWVsZENvbnRyb2wgPSB0aGlzLmNoaWxkcmVuQnlJZFtpZF07CiAgICAgICAgICAgICAgICB2YXIgaXRlbVRvb2xiYXJUZW1wbGF0ZURlc2NyaXB0b3IgPSB0aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJhcnJheUl0ZW1Ub29sYmFyIik7CiAgICAgICAgICAgICAgICBpZiAoaXRlbVRvb2xiYXJUZW1wbGF0ZURlc2NyaXB0b3IpIHsKCiAgICAgICAgICAgICAgICAgICAgLy8gQmFzZSBidXR0b25zIDogYWRkICYgcmVtb3ZlCiAgICAgICAgICAgICAgICAgICAgdmFyIGJ1dHRvbnNEZWYgPSBbCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZlYXR1cmU6ICJhZGQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWNvbjogX3RoaXMuYWRkSWNvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiAoX3RoaXMub3B0aW9ucy5pdGVtcyAmJiBfdGhpcy5vcHRpb25zLml0ZW1zLmFkZEl0ZW1MYWJlbCkgPyBfdGhpcy5vcHRpb25zLml0ZW1zLmFkZEl0ZW1MYWJlbCA6ICJBZGQgSXRlbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGlja0NhbGxiYWNrOiBmdW5jdGlvbihpZCwgYXJyYXlGaWVsZCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5yZXNvbHZlSXRlbVNjaGVtYU9wdGlvbnMoZnVuY3Rpb24oc2NoZW1hLCBvcHRpb25zKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheUZpZWxkLmFkZEl0ZW0oY29udGFpbmVyRWxlbS5pbmRleCgpICsgMSwgc2NoZW1hLCBvcHRpb25zLCBudWxsLCBpZCwgdHJ1ZSwgZnVuY3Rpb24oYWRkZWRGaWVsZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXlGaWVsZC5lbnJpY2hFbGVtZW50cyhhZGRlZEZpZWxkLmdldEVsKCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmVhdHVyZTogInJlbW92ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpY29uOiBfdGhpcy5yZW1vdmVJY29uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IChfdGhpcy5vcHRpb25zLml0ZW1zICYmIF90aGlzLm9wdGlvbnMuaXRlbXMucmVtb3ZlSXRlbUxhYmVsKSA/IF90aGlzLm9wdGlvbnMuaXRlbXMucmVtb3ZlSXRlbUxhYmVsIDogIlJlbW92ZSBJdGVtIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsaWNrQ2FsbGJhY2s6IGZ1bmN0aW9uKGlkLCBhcnJheUZpZWxkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXlGaWVsZC5yZW1vdmVJdGVtKGlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIF07CgogICAgICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsIGJ1dHRvbnMgOiB1cCAmIGRvd24KICAgICAgICAgICAgICAgICAgICBpZiAoKF90aGlzLm9wdGlvbnMuaXRlbXMgJiYgX3RoaXMub3B0aW9ucy5pdGVtcy5zaG93TW92ZVVwSXRlbUJ1dHRvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uc0RlZi5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZlYXR1cmU6ICJ1cCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpY29uOiBfdGhpcy51cEljb24sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogKF90aGlzLm9wdGlvbnMuaXRlbXMgJiYgX3RoaXMub3B0aW9ucy5pdGVtcy5tb3ZlVXBJdGVtTGFiZWwpID8gX3RoaXMub3B0aW9ucy5pdGVtcy5tb3ZlVXBJdGVtTGFiZWwgOiAiTW92ZSBVcCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGlja0NhbGxiYWNrOiBmdW5jdGlvbihpZCwgYXJyYXlGaWVsZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5RmllbGQubW92ZUl0ZW0oaWQsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICgoX3RoaXMub3B0aW9ucy5pdGVtcyAmJiBfdGhpcy5vcHRpb25zLml0ZW1zLnNob3dNb3ZlRG93bkl0ZW1CdXR0b24pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbnNEZWYucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmZWF0dXJlOiAiZG93biIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpY29uOiBfdGhpcy5kb3duSWNvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiAoX3RoaXMub3B0aW9ucy5pdGVtcyAmJiBfdGhpcy5vcHRpb25zLml0ZW1zLm1vdmVEb3duSXRlbUxhYmVsKSA/IF90aGlzLm9wdGlvbnMuaXRlbXMubW92ZURvd25JdGVtTGFiZWwgOiAiTW92ZSBEb3duIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsaWNrQ2FsbGJhY2s6IGZ1bmN0aW9uKGlkLCBhcnJheUZpZWxkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXlGaWVsZC5tb3ZlSXRlbShpZCwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIEV4dHJhIGJ1dHRvbnMgOiB1c2VyLWRlZmluZWQKICAgICAgICAgICAgICAgICAgICBpZiAoX3RoaXMub3B0aW9ucy5pdGVtcyAmJiBfdGhpcy5vcHRpb25zLml0ZW1zLmV4dHJhVG9vbGJhckJ1dHRvbnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uc0RlZiA9ICQubWVyZ2UoYnV0dG9uc0RlZixfdGhpcy5vcHRpb25zLml0ZW1zLmV4dHJhVG9vbGJhckJ1dHRvbnMpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdmFyIHRvb2xiYXJFbGVtID0gX3RoaXMudmlldy50bXBsKGl0ZW1Ub29sYmFyVGVtcGxhdGVEZXNjcmlwdG9yLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJpZCI6IGlkLAogICAgICAgICAgICAgICAgICAgICAgICAiYnV0dG9ucyI6IGJ1dHRvbnNEZWYKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBpZiAodG9vbGJhckVsZW0uYXR0cigiaWQiKSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICB0b29sYmFyRWxlbS5hdHRyKCJpZCIsIGlkICsgIi1pdGVtLXRvb2xiYXIiKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIFByb2Nlc3MgYWxsIGJ1dHRvbnMKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIGJ1dHRvbnNEZWYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgKGZ1bmN0aW9uKGRlZikgeyAvLyBjbG9zdXJlIHRvIHByZXZlbnQgImRlZiIgbGVha2luZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVsID0gdG9vbGJhckVsZW0uZmluZCgnLmFscGFjYS1maWVsZHNldC1hcnJheS1pdGVtLXRvb2xiYXItJytkZWYuZmVhdHVyZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbC5jbGljayhmdW5jdGlvbihlKSB7cmV0dXJuIGRlZi5jbGlja0NhbGxiYWNrKGlkLCBfdGhpcywgZSk7fSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoX3RoaXMuYnV0dG9uQmVhdXRpZmllcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmJ1dHRvbkJlYXV0aWZpZXIuY2FsbChfdGhpcyxlbCwgZGVmLmljb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KShidXR0b25zRGVmW2ldKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMudG9vbGJhclN0aWNreSkgewogICAgICAgICAgICAgICAgICAgICAgICB0b29sYmFyRWxlbS5wcmVwZW5kVG8oY29udGFpbmVyRWxlbSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdG9vbGJhckVsZW0uaGlkZSgpLnByZXBlbmRUbyhjb250YWluZXJFbGVtKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyRWxlbS5ob3ZlcihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJy5hbHBhY2EtZmllbGRzZXQtYXJyYXktaXRlbS10b29sYmFyJywgdGhpcykuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJy5hbHBhY2EtZmllbGRzZXQtYXJyYXktaXRlbS10b29sYmFyJywgdGhpcykuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVuZGVycyBhcnJheSB0b29sYmFyLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXJFbGVtIEFycmF5IHRvb2xiYXIgY29udGFpbmVyLgogICAgICAgICAqLwogICAgICAgIHJlbmRlckFycmF5VG9vbGJhcjogZnVuY3Rpb24oY29udGFpbmVyRWxlbSkgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgLy8gd2UgZG8gbm90IHJlbmRlciB0aGUgYXJyYXkgdG9vbGJhciBpbiAiZGlzcGxheSIgbW9kZQogICAgICAgICAgICBpZiAodGhpcy52aWV3ICYmIHRoaXMudmlldy50eXBlID09ICJ2aWV3IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgaWQgPSBjb250YWluZXJFbGVtLmF0dHIoJ2FscGFjYS1pZCcpOwogICAgICAgICAgICB2YXIgaXRlbVRvb2xiYXJUZW1wbGF0ZURlc2NyaXB0b3IgPSB0aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJhcnJheVRvb2xiYXIiKTsKICAgICAgICAgICAgaWYgKGl0ZW1Ub29sYmFyVGVtcGxhdGVEZXNjcmlwdG9yKSB7CiAgICAgICAgICAgICAgICB2YXIgdG9vbGJhckVsZW0gPSBfdGhpcy52aWV3LnRtcGwoaXRlbVRvb2xiYXJUZW1wbGF0ZURlc2NyaXB0b3IsIHsKICAgICAgICAgICAgICAgICAgICAiaWQiOiBpZCwKICAgICAgICAgICAgICAgICAgICAiYWRkSXRlbUxhYmVsIjogKF90aGlzLm9wdGlvbnMuaXRlbXMgJiYgX3RoaXMub3B0aW9ucy5pdGVtcy5hZGRJdGVtTGFiZWwpID8gX3RoaXMub3B0aW9ucy5pdGVtcy5hZGRJdGVtTGFiZWwgOiAiQWRkIEl0ZW0iCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGlmICh0b29sYmFyRWxlbS5hdHRyKCJpZCIpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdG9vbGJhckVsZW0uYXR0cigiaWQiLCBpZCArICItYXJyYXktdG9vbGJhciIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGFkZCBhY3Rpb25zIHRvIHRvb2xiYXIgYnV0dG9ucwogICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy50b29sYmFyU3R5bGUgPT0gImxpbmsiKSB7CiAgICAgICAgICAgICAgICAgICAgJCgnLmFscGFjYS1maWVsZHNldC1hcnJheS10b29sYmFyLWFkZCcsIHRvb2xiYXJFbGVtKS5jbGljayhmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnJlc29sdmVJdGVtU2NoZW1hT3B0aW9ucyhmdW5jdGlvbihzY2hlbWEsIG9wdGlvbnMpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5hZGRJdGVtKDAsIHNjaGVtYSwgb3B0aW9ucywgIiIsIGlkLCB0cnVlLCBmdW5jdGlvbihhZGRlZEZpZWxkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuZW5yaWNoRWxlbWVudHMoYWRkZWRGaWVsZC5nZXRFbCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdG9vbGJhckVsZW1BZGQgPSAkKCcuYWxwYWNhLWZpZWxkc2V0LWFycmF5LXRvb2xiYXItYWRkJywgdG9vbGJhckVsZW0pOwogICAgICAgICAgICAgICAgICAgIGlmIChfdGhpcy5idXR0b25CZWF1dGlmaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmJ1dHRvbkJlYXV0aWZpZXIuY2FsbChfdGhpcywgdG9vbGJhckVsZW1BZGQsIF90aGlzLmFkZEljb24sIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0b29sYmFyRWxlbUFkZC5jbGljayhmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnJlc29sdmVJdGVtU2NoZW1hT3B0aW9ucyhmdW5jdGlvbihzY2hlbWEsIG9wdGlvbnMpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5hZGRJdGVtKDAsIHNjaGVtYSwgb3B0aW9ucywgIiIsIGlkLCB0cnVlLCBmdW5jdGlvbihhZGRlZEZpZWxkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuZW5yaWNoRWxlbWVudHMoYWRkZWRGaWVsZC5nZXRFbCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9KS53cmFwKCc8c21hbGw+PC9zbWFsbD4nKTsKCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0b29sYmFyRWxlbS5hcHBlbmRUbyhjb250YWluZXJFbGVtKTsKICAgICAgICAgICAgICAgIHRoaXMuYXJyYXlUb29sYmFyID0gdG9vbGJhckVsZW07CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZS1yZW5kZXJzIGl0ZW0uCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZmllbGRDb250cm9sIEl0ZW0gY29udHJvbCB0byBiZSByZS1yZW5kZXJlZAogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG5ld0NvbnRhaW5lciBOZXcgZmllbGQgY29udGFpbmVyLgogICAgICAgICAqLwogICAgICAgIHJlUmVuZGVySXRlbTogZnVuY3Rpb24oZmllbGRDb250cm9sLCBuZXdDb250YWluZXIpIHsKICAgICAgICAgICAgZmllbGRDb250cm9sLmNvbnRhaW5lciA9IG5ld0NvbnRhaW5lcjsKICAgICAgICAgICAgZmllbGRDb250cm9sLnJlbmRlcigpOwoKICAgICAgICAgICAgbmV3Q29udGFpbmVyLmF0dHIoImlkIiwgZmllbGRDb250cm9sLmdldElkKCkgKyAiLWl0ZW0tY29udGFpbmVyIik7CiAgICAgICAgICAgIG5ld0NvbnRhaW5lci5hdHRyKCJhbHBhY2EtaWQiLCBmaWVsZENvbnRyb2wuZ2V0SWQoKSk7CiAgICAgICAgICAgIG5ld0NvbnRhaW5lci5hZGRDbGFzcygiYWxwYWNhLWl0ZW0tY29udGFpbmVyIik7CgogICAgICAgICAgICAkKCIuYWxwYWNhLWZpZWxkc2V0LWFycmF5LWl0ZW0tdG9vbGJhciIsIG5ld0NvbnRhaW5lcikucmVtb3ZlKCk7CiAgICAgICAgICAgIHRoaXMucmVuZGVyVG9vbGJhcihuZXdDb250YWluZXIpOwogICAgICAgICAgICB0aGlzLmVucmljaEVsZW1lbnRzKG5ld0NvbnRhaW5lcik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQWRkcyBpdGVtLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGluZGV4IEluZGV4IG9mIHRoZSBpdGVtCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGl0ZW1TY2hlbWEgZmllbGQgc2NoZW1hCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGl0ZW1PcHRpb25zIGZpZWxkIG9wdGlvbnMKICAgICAgICAgKiBAcGFyYW0ge0FueX0gaXRlbURhdGEgZmllbGQgZGF0YQogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBpbnNlcnRBZnRlcklkIFdoZXJlIHRoZSBpdGVtIHdpbGwgYmUgaW5zZXJ0ZWQKICAgICAgICAgKiBAcGFyYW0gW0Jvb2xlYW5dIGlzRHluYW1pY1N1Ykl0ZW0gd2hldGhlciB0aGlzIGl0ZW0gaXMgYmVpbmcgZHluYW1pY2FsbHkgY3JlYXRlZCAoYWZ0ZXIgZmlyc3QgcmVuZGVyKQogICAgICAgICAqIEBwYXJhbSBbRnVuY3Rpb25dIHBvc3RSZW5kZXJDYWxsYmFjayBjYWxsZWQgYWZ0ZXIgdGhlIGNoaWxkIGlzIGFkZGVkCiAgICAgICAgICovCiAgICAgICAgYWRkSXRlbTogZnVuY3Rpb24oaW5kZXgsIGl0ZW1TY2hlbWEsIGl0ZW1PcHRpb25zLCBpdGVtRGF0YSwgaW5zZXJ0QWZ0ZXJJZCwgaXNEeW5hbWljU3ViSXRlbSwgcG9zdFJlbmRlckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9hZGRJdGVtKGluZGV4LCBpdGVtU2NoZW1hLCBpdGVtT3B0aW9ucywgaXRlbURhdGEsIGluc2VydEFmdGVySWQsIGlzRHluYW1pY1N1Ykl0ZW0sIHBvc3RSZW5kZXJDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogV29ya2hvcnNlIG1ldGhvZCBmb3IgYWRkSXRlbS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBpbmRleAogICAgICAgICAqIEBwYXJhbSBpdGVtU2NoZW1hCiAgICAgICAgICogQHBhcmFtIGl0ZW1PcHRpb25zCiAgICAgICAgICogQHBhcmFtIGl0ZW1EYXRhCiAgICAgICAgICogQHBhcmFtIGluc2VydEFmdGVySWQKICAgICAgICAgKiBAcGFyYW0gaXNEeW5hbWljU3ViSXRlbQogICAgICAgICAqIEBwYXJhbSBwb3N0UmVuZGVyQ2FsbGJhY2sKICAgICAgICAgKiBAcmV0dXJuIHsqfQogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgX2FkZEl0ZW06IGZ1bmN0aW9uKGluZGV4LCBpdGVtU2NoZW1hLCBpdGVtT3B0aW9ucywgaXRlbURhdGEsIGluc2VydEFmdGVySWQsIGlzRHluYW1pY1N1Ykl0ZW0sIHBvc3RSZW5kZXJDYWxsYmFjaykgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICAgICAgICBpZiAoX3RoaXMuX3ZhbGlkYXRlRXF1YWxNYXhJdGVtcygpKSB7CgogICAgICAgICAgICAgICAgaWYgKGl0ZW1PcHRpb25zID09PSBudWxsICYmIF90aGlzLm9wdGlvbnMgJiYgX3RoaXMub3B0aW9ucy5maWVsZHMgJiYgX3RoaXMub3B0aW9ucy5maWVsZHNbIml0ZW0iXSkgewogICAgICAgICAgICAgICAgICAgIGl0ZW1PcHRpb25zID0gX3RoaXMub3B0aW9ucy5maWVsZHNbIml0ZW0iXTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgY29udGFpbmVyRWxlbSA9IF90aGlzLnJlbmRlckl0ZW1Db250YWluZXIoaW5zZXJ0QWZ0ZXJJZCk7CiAgICAgICAgICAgICAgICBjb250YWluZXJFbGVtLmFscGFjYSh7CiAgICAgICAgICAgICAgICAgICAgImRhdGEiIDogaXRlbURhdGEsCiAgICAgICAgICAgICAgICAgICAgIm9wdGlvbnMiOiBpdGVtT3B0aW9ucywKICAgICAgICAgICAgICAgICAgICAic2NoZW1hIiA6IGl0ZW1TY2hlbWEsCiAgICAgICAgICAgICAgICAgICAgInZpZXciIDogdGhpcy52aWV3LmlkID8gdGhpcy52aWV3LmlkIDogdGhpcy52aWV3LAogICAgICAgICAgICAgICAgICAgICJjb25uZWN0b3IiOiB0aGlzLmNvbm5lY3RvciwKICAgICAgICAgICAgICAgICAgICAiZXJyb3IiOiBmdW5jdGlvbihlcnIpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5kZXN0cm95KCk7CgogICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5lcnJvckNhbGxiYWNrLmNhbGwoX3RoaXMsIGVycik7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAibm90VG9wTGV2ZWwiOnRydWUsCiAgICAgICAgICAgICAgICAgICAgImlzRHluYW1pY0NyZWF0aW9uIjogKGlzRHluYW1pY1N1Ykl0ZW0gfHwgdGhpcy5pc0R5bmFtaWNDcmVhdGlvbiksCiAgICAgICAgICAgICAgICAgICAgInJlbmRlciIgOiBmdW5jdGlvbihmaWVsZENvbnRyb2wsIGNiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbmRlcgogICAgICAgICAgICAgICAgICAgICAgICBmaWVsZENvbnRyb2wucGFyZW50ID0gX3RoaXM7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNldHVwIGl0ZW0gcGF0aAogICAgICAgICAgICAgICAgICAgICAgICBmaWVsZENvbnRyb2wucGF0aCA9IF90aGlzLnBhdGggKyAiWyIgKyBpbmRleCArICJdIjsKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRDb250cm9sLm5hbWVDYWxjdWxhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRDb250cm9sLnJlbmRlcihudWxsLCBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXJFbGVtLmF0dHIoImlkIiwgZmllbGRDb250cm9sLmdldElkKCkgKyAiLWl0ZW0tY29udGFpbmVyIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXJFbGVtLmF0dHIoImFscGFjYS1pZCIsIGZpZWxkQ29udHJvbC5nZXRJZCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lckVsZW0uYWRkQ2xhc3MoImFscGFjYS1pdGVtLWNvbnRhaW5lciIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVuZGVyIGl0ZW0gbGFiZWwgaWYgbmVlZGVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoX3RoaXMub3B0aW9ucyAmJiBfdGhpcy5vcHRpb25zLml0ZW1MYWJlbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpdGVtTGFiZWxUZW1wbGF0ZURlc2NyaXB0b3IgPSBfdGhpcy52aWV3LmdldFRlbXBsYXRlRGVzY3JpcHRvcigiaXRlbUxhYmVsIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW1MYWJlbEVsZW0gPSBfdGhpcy52aWV3LnRtcGwoaXRlbUxhYmVsVGVtcGxhdGVEZXNjcmlwdG9yLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJvcHRpb25zIjogX3RoaXMub3B0aW9ucywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImluZGV4IjogaW5kZXggPyBpbmRleCArIDEgOiAxLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaWQiOiBfdGhpcy5pZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1MYWJlbEVsZW0ucHJlcGVuZFRvKGNvbnRhaW5lckVsZW0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVtZW1iZXIgdGhlIGNvbnRyb2wKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmFkZENoaWxkKGZpZWxkQ29udHJvbCwgaW5kZXgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMucmVuZGVyVG9vbGJhcihjb250YWluZXJFbGVtKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnJlZnJlc2hWYWxpZGF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnVwZGF0ZVBhdGhBbmROYW1lKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdHJpZ2dlciB1cGRhdGUgb24gdGhlIHBhcmVudCBhcnJheQogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMudHJpZ2dlclVwZGF0ZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIG5vdCBlbXB0eSwgbWFyayB0aGUgImxhc3QiIGFuZCAiZmlyc3QiIGRvbSBlbGVtZW50cyBpbiB0aGUgbGlzdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQoY29udGFpbmVyRWxlbSkuc2libGluZ3MoKS5hZGRCYWNrKCkubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGNvbnRhaW5lckVsZW0pLnBhcmVudCgpLnJlbW92ZUNsYXNzKCJhbHBhY2EtZmllbGRzZXQtaXRlbXMtY29udGFpbmVyLWVtcHR5Iik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoY29udGFpbmVyRWxlbSkuc2libGluZ3MoKS5hZGRCYWNrKCkucmVtb3ZlQ2xhc3MoImFscGFjYS1pdGVtLWNvbnRhaW5lci1maXJzdCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoY29udGFpbmVyRWxlbSkuc2libGluZ3MoKS5hZGRCYWNrKCkucmVtb3ZlQ2xhc3MoImFscGFjYS1pdGVtLWNvbnRhaW5lci1sYXN0Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJChjb250YWluZXJFbGVtKS5zaWJsaW5ncygpLmFkZEJhY2soKS5maXJzdCgpLmFkZENsYXNzKCJhbHBhY2EtaXRlbS1jb250YWluZXItZmlyc3QiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGNvbnRhaW5lckVsZW0pLnNpYmxpbmdzKCkuYWRkQmFjaygpLmxhc3QoKS5hZGRDbGFzcygiYWxwYWNhLWl0ZW0tY29udGFpbmVyLWxhc3QiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzdG9yZSBrZXkgb24gZG9tIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoY29udGFpbmVyRWxlbSkuYXR0cigiZGF0YS1hbHBhY2EtaXRlbS1jb250YWluZXItaXRlbS1rZXkiLCBpbmRleCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMudXBkYXRlVG9vbGJhckl0ZW1zU3RhdHVzKF90aGlzLm91dGVyRWwpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNGdW5jdGlvbihfdGhpcy5vcHRpb25zLml0ZW1zLnBvc3RSZW5kZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMub3B0aW9ucy5pdGVtcy5wb3N0UmVuZGVyKGNvbnRhaW5lckVsZW0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJwb3N0UmVuZGVyIjogZnVuY3Rpb24oY29udHJvbCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwb3N0UmVuZGVyQ2FsbGJhY2spCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc3RSZW5kZXJDYWxsYmFjayhjb250cm9sKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vdGhpcy51cGRhdGVUb29sYmFySXRlbXNTdGF0dXModGhpcy5vdXRlckVsKTsKCiAgICAgICAgICAgICAgICByZXR1cm4gY29udGFpbmVyRWxlbTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEVucmljaGVzIHN0eWxlcyBmb3IgZHluYW1pYyBlbGVtZW50cy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXJFbGVtIEZpZWxkIGNvbnRhaW5lciBlbGVtZW50LgogICAgICAgICAqLwogICAgICAgIGVucmljaEVsZW1lbnRzOiBmdW5jdGlvbihjb250YWluZXJFbGVtKSB7CiAgICAgICAgICAgIHRoaXMuZ2V0U3R5bGVJbmplY3Rpb24oJ2FycmF5Jyxjb250YWluZXJFbGVtKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBEZXRlcm1pbmVzIHRoZSBzY2hlbWEgYW5kIG9wdGlvbnMgdG8gdXRpbGl6ZSBmb3IgaXRlbXMgd2l0aGluIHRoaXMgYXJyYXkuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gY2FsbGJhY2sKICAgICAgICAgKi8KICAgICAgICByZXNvbHZlSXRlbVNjaGVtYU9wdGlvbnM6IGZ1bmN0aW9uKGNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIHZhciBpdGVtT3B0aW9uczsKICAgICAgICAgICAgaWYgKF90aGlzLm9wdGlvbnMgJiYgX3RoaXMub3B0aW9ucy5maWVsZHMgJiYgX3RoaXMub3B0aW9ucy5maWVsZHNbIml0ZW0iXSkgewogICAgICAgICAgICAgICAgaXRlbU9wdGlvbnMgPSBfdGhpcy5vcHRpb25zLmZpZWxkc1siaXRlbSJdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpdGVtU2NoZW1hOwogICAgICAgICAgICBpZiAoX3RoaXMuc2NoZW1hICYmIF90aGlzLnNjaGVtYS5pdGVtcykgewogICAgICAgICAgICAgICAgaXRlbVNjaGVtYSA9IF90aGlzLnNjaGVtYS5pdGVtczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaGFuZGxlICRyZWYKICAgICAgICAgICAgaWYgKGl0ZW1TY2hlbWEgJiYgaXRlbVNjaGVtYVsiJHJlZiJdKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgcmVmZXJlbmNlSWQgPSBpdGVtU2NoZW1hWyIkcmVmIl07CgogICAgICAgICAgICAgICAgdmFyIHRvcEZpZWxkID0gdGhpczsKICAgICAgICAgICAgICAgIHZhciBmaWVsZENoYWluID0gW3RvcEZpZWxkXTsKICAgICAgICAgICAgICAgIHdoaWxlICh0b3BGaWVsZC5wYXJlbnQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdG9wRmllbGQgPSB0b3BGaWVsZC5wYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgZmllbGRDaGFpbi5wdXNoKHRvcEZpZWxkKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxJdGVtU2NoZW1hID0gaXRlbVNjaGVtYTsKICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbEl0ZW1PcHRpb25zID0gaXRlbU9wdGlvbnM7CgogICAgICAgICAgICAgICAgQWxwYWNhLmxvYWRSZWZTY2hlbWFPcHRpb25zKHRvcEZpZWxkLCByZWZlcmVuY2VJZCwgZnVuY3Rpb24oaXRlbVNjaGVtYSwgaXRlbU9wdGlvbnMpIHsKCiAgICAgICAgICAgICAgICAgICAgLy8gd2FsayB0aGUgZmllbGQgY2hhaW4gdG8gc2VlIGlmIHdlIGhhdmUgYW55IGNpcmN1bGFyaXR5CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlZkNvdW50ID0gMDsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZpZWxkQ2hhaW4ubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmllbGRDaGFpbltpXS5zY2hlbWEgJiYgZmllbGRDaGFpbltpXS5zY2hlbWEuaWQgPT09IHJlZmVyZW5jZUlkKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWZDb3VudCsrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgY2lyY3VsYXIgPSAocmVmQ291bnQgPiAxKTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc29sdmVkSXRlbVNjaGVtYSA9IHt9OwogICAgICAgICAgICAgICAgICAgIGlmIChvcmlnaW5hbEl0ZW1TY2hlbWEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgQWxwYWNhLm1lcmdlT2JqZWN0KHJlc29sdmVkSXRlbVNjaGVtYSwgb3JpZ2luYWxJdGVtU2NoZW1hKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW1TY2hlbWEpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBBbHBhY2EubWVyZ2VPYmplY3QocmVzb2x2ZWRJdGVtU2NoZW1hLCBpdGVtU2NoZW1hKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHJlc29sdmVkSXRlbVNjaGVtYS5pZDsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc29sdmVkSXRlbU9wdGlvbnMgPSB7fTsKICAgICAgICAgICAgICAgICAgICBpZiAob3JpZ2luYWxJdGVtT3B0aW9ucykgewogICAgICAgICAgICAgICAgICAgICAgICBBbHBhY2EubWVyZ2VPYmplY3QocmVzb2x2ZWRJdGVtT3B0aW9ucywgb3JpZ2luYWxJdGVtT3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChpdGVtT3B0aW9ucykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIEFscGFjYS5tZXJnZU9iamVjdChyZXNvbHZlZEl0ZW1PcHRpb25zLCBpdGVtT3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhyZXNvbHZlZEl0ZW1TY2hlbWEsIHJlc29sdmVkSXRlbU9wdGlvbnMsIGNpcmN1bGFyKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2FsbGJhY2soaXRlbVNjaGVtYSwgaXRlbU9wdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udGFpbmVyRmllbGQjcmVuZGVySXRlbXMKICAgICAgICAgKi8KICAgICAgICByZW5kZXJJdGVtczogZnVuY3Rpb24ob25TdWNjZXNzKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgLy8gbWFyayBmaWVsZCBjb250YWluZXIgYXMgZW1wdHkgYnkgZGVmYXVsdAogICAgICAgICAgICAvLyB0aGUgImFkZEl0ZW0iIG1ldGhvZCBiZWxvdyBnZXRzIHRoZSBvcHBvcnR1bml0eSB0byB1bnNldCB0aGlzCiAgICAgICAgICAgICQoc2VsZi5maWVsZENvbnRhaW5lcikuYWRkQ2xhc3MoImFscGFjYS1maWVsZHNldC1pdGVtcy1jb250YWluZXItZW1wdHkiKTsKCiAgICAgICAgICAgIGlmIChzZWxmLmRhdGEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIGFsbCBpdGVtcyB3aXRoaW4gdGhlIGFycmF5IGhhdmUgdGhlIHNhbWUgc2NoZW1hIGFuZCBvcHRpb25zCiAgICAgICAgICAgICAgICAvLyBzbyB3ZSBvbmx5IG5lZWQgdG8gbG9hZCB0aGlzIG9uY2UKICAgICAgICAgICAgICAgIHNlbGYucmVzb2x2ZUl0ZW1TY2hlbWFPcHRpb25zKGZ1bmN0aW9uKHNjaGVtYSwgb3B0aW9ucykgewoKICAgICAgICAgICAgICAgICAgICAvLyB3YXRlcmZhbGwgZnVuY3Rpb25zCiAgICAgICAgICAgICAgICAgICAgdmFyIGZ1bmNzID0gW107CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaW5kZXggPSAwOyBpbmRleCA8IHNlbGYuZGF0YS5sZW5ndGg7IGluZGV4KyspCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBzZWxmLmRhdGFbaW5kZXhdOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBmID0gKGZ1bmN0aW9uKGluZGV4LCB2YWx1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGNhbGxiYWNrKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuYWRkSXRlbShpbmRleCwgc2NoZW1hLCBvcHRpb25zLCB2YWx1ZSwgZmFsc2UsIGZhbHNlLCBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJ5IHRoZSB0aW1lIHdlIGdldCBoZXJlLCB3ZSBtYXkgaGF2ZSBjb25zdHJ1Y3RlZCBhIHZlcnkgbGFyZ2UgY2hpbGQgY2hhaW4gb2YKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3ViLWRlcGVuZGVuY2llcyBhbmQgc28gd2UgdXNlIG5leHRUaWNrKCkgaW5zdGVhZCBvZiBhIHN0cmFpZ2h0IGNhbGxiYWNrIHNvIGFzIHRvCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGF2b2lkIGJsb3dpbmcgb3V0IHRoZSBzdGFjayBzaXplCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFscGFjYS5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICB9KShpbmRleCwgdmFsdWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3MucHVzaChwZik7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBBbHBhY2Euc2VyaWVzKGZ1bmNzLCBmdW5jdGlvbihlcnIpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudXBkYXRlVG9vbGJhckl0ZW1zU3RhdHVzKCk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAob25TdWNjZXNzKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvblN1Y2Nlc3MoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc2VsZi51cGRhdGVUb29sYmFySXRlbXNTdGF0dXMoKTsKCiAgICAgICAgICAgICAgICBpZiAob25TdWNjZXNzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG9uU3VjY2VzcygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaWRhdGVzIGlmIHRoZSBudW1iZXIgb2YgaXRlbXMgaGFzIGJlZW4gcmVhY2hlZCB0byBtYXhJdGVtcy4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gdHJ1ZSBpZiB0aGUgbnVtYmVyIG9mIGl0ZW1zIGhhcyBiZWVuIHJlYWNoZWQgdG8gbWF4SXRlbXMKICAgICAgICAgKi8KICAgICAgICBfdmFsaWRhdGVFcXVhbE1heEl0ZW1zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc2NoZW1hLml0ZW1zICYmIHRoaXMuc2NoZW1hLml0ZW1zLm1heEl0ZW1zKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXRTaXplKCkgPj0gdGhpcy5zY2hlbWEuaXRlbXMubWF4SXRlbXMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaWRhdGVzIGlmIHRoZSBudW1iZXIgb2YgaXRlbXMgaGFzIGJlZW4gcmVhY2hlZCB0byBtaW5JdGVtcy4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gdHJ1ZSBpZiBudW1iZXIgb2YgaXRlbXMgaGFzIGJlZW4gcmVhY2hlZCB0byBtaW5JdGVtcwogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZUVxdWFsTWluSXRlbXM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5zY2hlbWEuaXRlbXMgJiYgdGhpcy5zY2hlbWEuaXRlbXMubWluSXRlbXMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdldFNpemUoKSA8PSB0aGlzLnNjaGVtYS5pdGVtcy5taW5JdGVtcykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBWYWxpZGF0ZXMgaWYgbnVtYmVyIG9mIGl0ZW1zIGhhcyBiZWVuIGxlc3MgdGhhbiBtaW5JdGVtcy4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gdHJ1ZSBpZiBudW1iZXIgb2YgaXRlbXMgaGFzIGJlZW4gbGVzcyB0aGFuIG1pbkl0ZW1zCiAgICAgICAgICovCiAgICAgICAgX3ZhbGlkYXRlTWluSXRlbXM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5zY2hlbWEuaXRlbXMgJiYgdGhpcy5zY2hlbWEuaXRlbXMubWluSXRlbXMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdldFNpemUoKSA8IHRoaXMuc2NoZW1hLml0ZW1zLm1pbkl0ZW1zKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlcyBpZiBudW1iZXIgb2YgaXRlbXMgaGFzIGJlZW4gb3ZlciBtYXhJdGVtcy4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gdHJ1ZSBpZiBudW1iZXIgb2YgaXRlbXMgaGFzIGJlZW4gb3ZlciBtYXhJdGVtcwogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZU1heEl0ZW1zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc2NoZW1hLml0ZW1zICYmIHRoaXMuc2NoZW1hLml0ZW1zLm1heEl0ZW1zKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXRTaXplKCkgPiB0aGlzLnNjaGVtYS5pdGVtcy5tYXhJdGVtcykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBWYWxpZGF0ZXMgaWYgYWxsIGl0ZW1zIGFyZSB1bmlxdWUuCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IHRydWUgaWYgYWxsIGl0ZW1zIGFyZSB1bmlxdWUuCiAgICAgICAgICovCiAgICAgICAgX3ZhbGlkYXRlVW5pcXVlSXRlbXM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5zY2hlbWEuaXRlbXMgJiYgdGhpcy5zY2hlbWEudW5pcXVlSXRlbXMpIHsKICAgICAgICAgICAgICAgIHZhciBoYXNoID0ge307CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMuY2hpbGRyZW4ubGVuZ3RoOyBpIDwgbDsgKytpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFoYXNoLmhhc093blByb3BlcnR5KHRoaXMuY2hpbGRyZW5baV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGhhc2hbdGhpcy5jaGlsZHJlbltpXV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udGFpbmVyRmllbGQjaGFuZGxlVmFsaWRhdGUKICAgICAgICAgKi8KICAgICAgICBoYW5kbGVWYWxpZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBiYXNlU3RhdHVzID0gdGhpcy5iYXNlKCk7CgogICAgICAgICAgICB2YXIgdmFsSW5mbyA9IHRoaXMudmFsaWRhdGlvbjsKCiAgICAgICAgICAgIHZhciBzdGF0dXMgPSB0aGlzLl92YWxpZGF0ZVVuaXF1ZUl0ZW1zKCk7CiAgICAgICAgICAgIHZhbEluZm9bInZhbHVlTm90VW5pcXVlIl0gPSB7CiAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHN0YXR1cyA/ICIiIDogdGhpcy52aWV3LmdldE1lc3NhZ2UoInZhbHVlTm90VW5pcXVlIiksCiAgICAgICAgICAgICAgICAic3RhdHVzIjogc3RhdHVzCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBzdGF0dXMgPSB0aGlzLl92YWxpZGF0ZU1heEl0ZW1zKCk7CiAgICAgICAgICAgIHZhbEluZm9bInRvb01hbnlJdGVtcyJdID0gewogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiBzdGF0dXMgPyAiIiA6IEFscGFjYS5zdWJzdGl0dXRlVG9rZW5zKHRoaXMudmlldy5nZXRNZXNzYWdlKCJ0b29NYW55SXRlbXMiKSwgW3RoaXMuc2NoZW1hLml0ZW1zLm1heEl0ZW1zXSksCiAgICAgICAgICAgICAgICAic3RhdHVzIjogc3RhdHVzCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBzdGF0dXMgPSB0aGlzLl92YWxpZGF0ZU1pbkl0ZW1zKCk7CiAgICAgICAgICAgIHZhbEluZm9bIm5vdEVub3VnaEl0ZW1zIl0gPSB7CiAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHN0YXR1cyA/ICIiIDogQWxwYWNhLnN1YnN0aXR1dGVUb2tlbnModGhpcy52aWV3LmdldE1lc3NhZ2UoIm5vdEVub3VnaEl0ZW1zIiksIFt0aGlzLnNjaGVtYS5pdGVtcy5taW5JdGVtc10pLAogICAgICAgICAgICAgICAgInN0YXR1cyI6IHN0YXR1cwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgcmV0dXJuIGJhc2VTdGF0dXMgJiYgdmFsSW5mb1sidmFsdWVOb3RVbmlxdWUiXVsic3RhdHVzIl0gJiYgdmFsSW5mb1sidG9vTWFueUl0ZW1zIl1bInN0YXR1cyJdICYmIHZhbEluZm9bIm5vdEVub3VnaEl0ZW1zIl1bInN0YXR1cyJdOwogICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRhaW5lckZpZWxkI2dldFNjaGVtYU9mU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZTY2hlbWE6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcHJvcGVydGllcyA9IHsKICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICJpdGVtcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkFycmF5IEl0ZW1zIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlNjaGVtYSBmb3IgYXJyYXkgaXRlbXMuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAib2JqZWN0IiwKICAgICAgICAgICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWluSXRlbXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIk1pbmltdW0gSXRlbXMiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJNaW5pbXVtIG51bWJlciBvZiBpdGVtcy4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm51bWJlciIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWF4SXRlbXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIk1heGltdW0gSXRlbXMiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJNYXhpbXVtIG51bWJlciBvZiBpdGVtcy4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm51bWJlciIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidW5pcXVlSXRlbXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkl0ZW1zIFVuaXF1ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkl0ZW0gdmFsdWVzIHNob3VsZCBiZSB1bmlxdWUgaWYgdHJ1ZS4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogZmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmICh0aGlzLmNoaWxkcmVuICYmIHRoaXMuY2hpbGRyZW5bMF0pIHsKICAgICAgICAgICAgICAgIEFscGFjYS5tZXJnZShwcm9wZXJ0aWVzLnByb3BlcnRpZXMuaXRlbXMucHJvcGVydGllcywgdGhpcy5jaGlsZHJlblswXS5nZXRTY2hlbWFPZlNjaGVtYSgpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgcHJvcGVydGllcyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250YWluZXJGaWVsZCNnZXRPcHRpb25zRm9yU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0ZvclNjaGVtYTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgIml0ZW1zIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJvYmplY3QiLAogICAgICAgICAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1pbkl0ZW1zIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1heEl0ZW1zIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInVuaXF1ZUl0ZW1zIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udGFpbmVyRmllbGQjZ2V0U2NoZW1hT2ZPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHByb3BlcnRpZXMgPSB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAidG9vbGJhclN0aWNreSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlN0aWNreSBUb29sYmFyIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkFycmF5IGl0ZW0gdG9vbGJhciB3aWxsIGJlIGF3YXlzIG9uIGlmIHRydWUuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogZmFsc2UKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJpdGVtcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkFycmF5IEl0ZW1zIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIk9wdGlvbnMgZm9yIGFycmF5IGl0ZW1zLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm9iamVjdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgImV4dHJhVG9vbGJhckJ1dHRvbnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkV4dHJhIFRvb2xiYXIgYnV0dG9ucyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkJ1dHRvbnMgdG8gYmUgYWRkZWQgbmV4dCB0byBhZGQvcmVtb3ZlL3VwL2Rvd24sIHNlZSBleGFtcGxlcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYXJyYXkiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogdW5kZWZpbmVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1vdmVVcEl0ZW1MYWJlbCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiTW92ZSBVcCBJdGVtIExhYmVsIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiVGhlIGxhYmVsIHRvIHVzZSBmb3IgdGhlIHRvb2xiYXIncyAnbW92ZSB1cCcgYnV0dG9uLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6ICJNb3ZlIFVwIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtb3ZlRG93bkl0ZW1MYWJlbCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiTW92ZSBEb3duIEl0ZW0gTGFiZWwiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJUaGUgbGFiZWwgdG8gdXNlIGZvciB0aGUgdG9vbGJhcidzICdtb3ZlIGRvd24nIGJ1dHRvbi4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiAiTW92ZSBEb3duIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJyZW1vdmVJdGVtTGFiZWwiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlJlbW92ZSBJdGVtIExhYmVsIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiVGhlIGxhYmVsIHRvIHVzZSBmb3IgdGhlIHRvb2xiYXIncyAncmVtb3ZlIGl0ZW0nIGJ1dHRvbi4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiAiUmVtb3ZlIEl0ZW0iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImFkZEl0ZW1MYWJlbCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiQWRkIEl0ZW0gTGFiZWwiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJUaGUgbGFiZWwgdG8gdXNlIGZvciB0aGUgdG9vbGJhcidzICdhZGQgaXRlbScgYnV0dG9uLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6ICJBZGQgSXRlbSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic2hvd01vdmVEb3duSXRlbUJ1dHRvbiI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiU2hvdyBNb3ZlIERvd24gSXRlbSBCdXR0b24iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJXaGV0aGVyIHRvIHNob3cgdG8gdGhlICdNb3ZlIERvd24nIGJ1dHRvbiBvbiB0aGUgdG9vbGJhci4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzaG93TW92ZVVwSXRlbUJ1dHRvbiI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiU2hvdyBNb3ZlIFVwIEl0ZW0gQnV0dG9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiV2hldGhlciB0byBzaG93IHRoZSAnTW92ZSBVcCcgYnV0dG9uIG9uIHRoZSB0b29sYmFyLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpZiAodGhpcy5jaGlsZHJlbiAmJiB0aGlzLmNoaWxkcmVuWzBdKSB7CiAgICAgICAgICAgICAgICBBbHBhY2EubWVyZ2UocHJvcGVydGllcy5wcm9wZXJ0aWVzLml0ZW1zLnByb3BlcnRpZXMsIHRoaXMuY2hpbGRyZW5bMF0uZ2V0U2NoZW1hT2ZTY2hlbWEoKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHByb3BlcnRpZXMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udGFpbmVyRmllbGQjZ2V0T3B0aW9uc0Zvck9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgInRvb2xiYXJTdGlja3kiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgIml0ZW1zIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJvYmplY3QiLAogICAgICAgICAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRhaW5lckZpZWxkI2dldFRpdGxlCiAgICAgICAgICovCiAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIkFycmF5IEZpZWxkIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250YWluZXJGaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJGaWVsZCBmb3IgbGlzdCBvZiBpdGVtcyB3aXRoIHNhbWUgZGF0YSB0eXBlIG9yIHN0cnVjdHVyZS4iOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRhaW5lckZpZWxkI2dldFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJhcnJheSI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udGFpbmVyRmllbGQjZ2V0RmlsZWRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJhcnJheSI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJUZW1wbGF0ZSgiaXRlbUxhYmVsIiwgJ3t7aWYgb3B0aW9ucy5pdGVtTGFiZWx9fTxkaXYgY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtbGFiZWwiPjxkaXY+JHtvcHRpb25zLml0ZW1MYWJlbH17e2lmIGluZGV4fX0gPHNwYW4gY2xhc3M9ImFscGFjYS1pdGVtLWxhYmVsLWNvdW50ZXIiPiR7aW5kZXh9PC9zcGFuPnt7L2lmfX08L2Rpdj48L2Rpdj57ey9pZn19Jyk7CiAgICBBbHBhY2EucmVnaXN0ZXJUZW1wbGF0ZSgiYXJyYXlUb29sYmFyIiwgJzxzcGFuIGNsYXNzPSJ1aS13aWRnZXQgdWktY29ybmVyLWFsbCBhbHBhY2EtZmllbGRzZXQtYXJyYXktdG9vbGJhciI+PGJ1dHRvbiBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWFycmF5LXRvb2xiYXItaWNvbiBhbHBhY2EtZmllbGRzZXQtYXJyYXktdG9vbGJhci1hZGQiPiR7YWRkSXRlbUxhYmVsfTwvYnV0dG9uPjwvc3Bhbj4nKTsKICAgIEFscGFjYS5yZWdpc3RlclRlbXBsYXRlKCJhcnJheUl0ZW1Ub29sYmFyIiwgJzxkaXYgY2xhc3M9InVpLXdpZGdldC1oZWFkZXIgdWktY29ybmVyLWFsbCBhbHBhY2EtZmllbGRzZXQtYXJyYXktaXRlbS10b29sYmFyIj57e2VhY2goayx2KSBidXR0b25zfX08YnV0dG9uIGNsYXNzPSJhbHBhY2EtZmllbGRzZXQtYXJyYXktaXRlbS10b29sYmFyLWljb24gYWxwYWNhLWZpZWxkc2V0LWFycmF5LWl0ZW0tdG9vbGJhci0ke3YuZmVhdHVyZX0iPiR7di5sYWJlbH08L2J1dHRvbj57ey9lYWNofX08L2Rpdj4nKTsKICAgIEFscGFjYS5yZWdpc3Rlck1lc3NhZ2VzKHsKICAgICAgICAibm90RW5vdWdoSXRlbXMiOiAiVGhlIG1pbmltdW0gbnVtYmVyIG9mIGl0ZW1zIGlzIHswfSIsCiAgICAgICAgInRvb01hbnlJdGVtcyI6ICJUaGUgbWF4aW11bSBudW1iZXIgb2YgaXRlbXMgaXMgezB9IiwKICAgICAgICAidmFsdWVOb3RVbmlxdWUiOiAiVmFsdWVzIGFyZSBub3QgdW5pcXVlIiwKICAgICAgICAibm90QW5BcnJheSI6ICJUaGlzIHZhbHVlIGlzIG5vdCBhbiBBcnJheSIKICAgIH0pOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiYXJyYXkiLCBBbHBhY2EuRmllbGRzLkFycmF5RmllbGQpOwogICAgQWxwYWNhLnJlZ2lzdGVyRGVmYXVsdFNjaGVtYUZpZWxkTWFwcGluZygiYXJyYXkiLCAiYXJyYXkiKTsKCn0pKGpRdWVyeSk7Ci8qanNoaW50IC1XMDA0ICovIC8vIGR1cGxpY2F0ZSB2YXJpYWJsZXMKLypqc2hpbnQgLVcwODMgKi8gLy8gaW5saW5lIGZ1bmN0aW9ucyBhcmUgdXNlZCBzYWZlbHkKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5PYmplY3RGaWVsZCA9IEFscGFjYS5Db250YWluZXJGaWVsZC5leHRlbmQoCiAgICAvKioKICAgICAqIEBsZW5kcyBBbHBhY2EuRmllbGRzLk9iamVjdEZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkNvbnRhaW5lckZpZWxkCiAgICAgICAgICoKICAgICAgICAgKiBAY2xhc3MgQ29udHJvbCBmb3IgSlNPTiBTY2hlbWEgb2JqZWN0IHR5cGUuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRhaW5lckZpZWxkI3NldHVwCiAgICAgICAgICovCiAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmJhc2UoKTsKCiAgICAgICAgICAgIHRoaXMud2l6YXJkUHJlSWNvbiA9ICIiOwogICAgICAgICAgICB0aGlzLndpemFyZE5leHRJY29uID0gIiI7CiAgICAgICAgICAgIHRoaXMud2l6YXJkRG9uZUljb249ICIiOwoKICAgICAgICAgICAgaWYgKHRoaXMudmlldy5zdHlsZSAmJiBBbHBhY2Euc3R5bGVJbmplY3Rpb25zW3RoaXMudmlldy5zdHlsZV0pIHsKICAgICAgICAgICAgICAgIGlmIChBbHBhY2Euc3R5bGVJbmplY3Rpb25zW3RoaXMudmlldy5zdHlsZV1bIndpemFyZFByZUljb24iXSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMud2l6YXJkUHJlSWNvbiA9IEFscGFjYS5zdHlsZUluamVjdGlvbnNbdGhpcy52aWV3LnN0eWxlXVsid2l6YXJkUHJlSWNvbiJdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKEFscGFjYS5zdHlsZUluamVjdGlvbnNbdGhpcy52aWV3LnN0eWxlXVsid2l6YXJkTmV4dEljb24iXSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMud2l6YXJkTmV4dEljb24gPSBBbHBhY2Euc3R5bGVJbmplY3Rpb25zW3RoaXMudmlldy5zdHlsZV1bIndpemFyZE5leHRJY29uIl07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLnN0eWxlSW5qZWN0aW9uc1t0aGlzLnZpZXcuc3R5bGVdWyJ3aXphcmREb25lSWNvbiJdKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy53aXphcmREb25lSWNvbiA9IEFscGFjYS5zdHlsZUluamVjdGlvbnNbdGhpcy52aWV3LnN0eWxlXVsid2l6YXJkRG9uZUljb24iXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKEFscGFjYS5pc0VtcHR5KHRoaXMuZGF0YSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuZGF0YSA9PSAiIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIUFscGFjYS5pc09iamVjdCh0aGlzLmRhdGEpKSB7CiAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc1N0cmluZyh0aGlzLmRhdGEpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRhdGEgPSBBbHBhY2EucGFyc2VKU09OKHRoaXMuZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghQWxwYWNhLmlzT2JqZWN0KHRoaXMuZGF0YSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFscGFjYS5sb2dXYXJuKCJPYmplY3RGaWVsZCBwYXJzZWQgZGF0YSBidXQgaXQgd2FzIG5vdCBhbiBvYmplY3Q6ICIgKyBKU09OLnN0cmluZ2lmeSh0aGlzLmRhdGEpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFBpY2tzIGFwYXJ0IHRoZSBkYXRhIG9iamVjdCBhbmQgc2V0IG9udG8gY2hpbGQgZmllbGRzLgogICAgICAgICAqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjc2V0VmFsdWUKICAgICAgICAgKi8KICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24oZGF0YSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGF0YSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZGF0YSA9IHt9OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpZiBub3QgYW4gb2JqZWN0IGJ5IHRoaXMgcG9pbnQsIHdlIGRvbid0IGhhbmRsZSBpdAogICAgICAgICAgICBpZiAoIUFscGFjYS5pc09iamVjdChkYXRhKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBzb3J0IGV4aXN0aW5nIGZpZWxkcyBieSBwcm9wZXJ0eSBpZAogICAgICAgICAgICB2YXIgZXhpc3RpbmdGaWVsZHNCeVByb3BlcnR5SWQgPSB7fTsKICAgICAgICAgICAgZm9yICh2YXIgZmllbGRJZCBpbiB0aGlzLmNoaWxkcmVuQnlJZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHByb3BlcnR5SWQgPSB0aGlzLmNoaWxkcmVuQnlJZFtmaWVsZElkXS5wcm9wZXJ0eUlkOwogICAgICAgICAgICAgICAgZXhpc3RpbmdGaWVsZHNCeVByb3BlcnR5SWRbcHJvcGVydHlJZF0gPSB0aGlzLmNoaWxkcmVuQnlJZFtmaWVsZElkXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gbmV3IGRhdGEgbWFwcGVkIGJ5IHByb3BlcnR5IGlkCiAgICAgICAgICAgIHZhciBuZXdEYXRhQnlQcm9wZXJ0eUlkID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGsgaW4gZGF0YSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGRhdGEuaGFzT3duUHJvcGVydHkoaykpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbmV3RGF0YUJ5UHJvcGVydHlJZFtrXSA9IGRhdGFba107CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHdhbGsgdGhyb3VnaCBuZXcgcHJvcGVydHkgaWRzCiAgICAgICAgICAgIC8vIGlmIGEgZmllbGQgZXhpc3RzLCBzZXQgdmFsdWUgb250byBpdCBhbmQgcmVtb3ZlIGZyb20gbmV3RGF0YUJ5UHJvcGVydHlJZCBhbmQgZXhpc3RpbmdGaWVsZHNCeVByb3BlcnR5SWQKICAgICAgICAgICAgLy8gaWYgYSBmaWVsZCBkb2Vzbid0IGV4aXN0LCBsZXQgaXQgcmVtYWluIGluIGxpc3QKICAgICAgICAgICAgZm9yICh2YXIgcHJvcGVydHlJZCBpbiBuZXdEYXRhQnlQcm9wZXJ0eUlkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgZmllbGQgPSBleGlzdGluZ0ZpZWxkc0J5UHJvcGVydHlJZFtwcm9wZXJ0eUlkXTsKICAgICAgICAgICAgICAgIGlmIChmaWVsZCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBmaWVsZC5zZXRWYWx1ZShuZXdEYXRhQnlQcm9wZXJ0eUlkW3Byb3BlcnR5SWRdKTsKCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGV4aXN0aW5nRmllbGRzQnlQcm9wZXJ0eUlkW3Byb3BlcnR5SWRdOwogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBuZXdEYXRhQnlQcm9wZXJ0eUlkW3Byb3BlcnR5SWRdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBhbnl0aGluZyBsZWZ0IGluIGV4aXN0aW5nRmllbGRzQnlQcm9wZXJ0eUlkIGRlc2NyaWJlcyBkYXRhIHRoYXQgaXMgbWlzc2luZywgbnVsbCBvciBlbXB0eQogICAgICAgICAgICAvLyB3ZSBudWxsIG91dCB0aG9zZSB2YWx1ZXMKICAgICAgICAgICAgZm9yICh2YXIgcHJvcGVydHlJZCBpbiBleGlzdGluZ0ZpZWxkc0J5UHJvcGVydHlJZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGZpZWxkID0gZXhpc3RpbmdGaWVsZHNCeVByb3BlcnR5SWRbcHJvcGVydHlJZF07CiAgICAgICAgICAgICAgICBmaWVsZC5zZXRWYWx1ZShudWxsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gYW55dGhpbmcgbGVmdCBpbiBuZXdEYXRhQnlQcm9wZXJ0eUlkIGlzIG5ldyBzdHVmZiB0aGF0IHdlIG5lZWQgdG8gYWRkCiAgICAgICAgICAgIC8vIHRoZSBvYmplY3QgZmllbGQgZG9lc24ndCBzdXBwb3J0IHRoaXMgc2luY2UgaXQgcnVucyBhZ2FpbnN0IGEgc2NoZW1hCiAgICAgICAgICAgIC8vIHNvIHdlIGRyb3AgdGhpcyBvZmYKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZWNvbnN0cnVjdHMgdGhlIGRhdGEgb2JqZWN0IGZyb20gdGhlIGNoaWxkIGZpZWxkcy4KICAgICAgICAgKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldFZhbHVlCiAgICAgICAgICovCiAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgLy8gaWYgd2UgZG9uJ3QgaGF2ZSBhbnkgY2hpbGRyZW4gYW5kIHdlJ3JlIG5vdCByZXF1aXJlZCwgaGFuZCBiYWNrIGVtcHR5IG9iamVjdAogICAgICAgICAgICBpZiAodGhpcy5jaGlsZHJlbi5sZW5ndGggPT09IDAgJiYgIXRoaXMuc2NoZW1hLnJlcXVpcmVkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4ge307CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIG90aGVyd2lzZSwgaGFuZCBiYWNrIGFuIG9iamVjdCB3aXRoIG91ciBjaGlsZCBwcm9wZXJ0aWVzIGluIGl0CiAgICAgICAgICAgIHZhciBvID0ge307CgogICAgICAgICAgICAvLyB3YWxrIHRocm91Z2ggYWxsIG9mIHRoZSBwcm9wZXJ0aWVzIG9iamVjdAogICAgICAgICAgICAvLyBmb3IgZWFjaCBwcm9wZXJ0eSwgd2UgaW5zZXJ0IGl0IGludG8gYSBKU09OIG9iamVjdCB0aGF0IHdlJ2xsIGhhbmQgYmFjayBhcyB0aGUgcmVzdWx0CgogICAgICAgICAgICAvLyBpZiB0aGUgcHJvcGVydHkgaGFzIGRlcGVuZGVuY2llcywgdGhlbiB3ZSBldmFsdWF0ZSB0aG9zZSBkZXBlbmRlbmNpZXMgZmlyc3QgdG8gZGV0ZXJtaW5lIHdoZXRoZXIgdGhlCiAgICAgICAgICAgIC8vIHJlc3VsdGluZyBwcm9wZXJ0eSBzaG91bGQgYmUgaW5jbHVkZWQKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewoKICAgICAgICAgICAgICAgIC8vIHRoZSBwcm9wZXJ0eSBrZXkgYW5kIHZsYXVlCiAgICAgICAgICAgICAgICB2YXIgcHJvcGVydHlJZCA9IHRoaXMuY2hpbGRyZW5baV0ucHJvcGVydHlJZDsKICAgICAgICAgICAgICAgIHZhciBmaWVsZFZhbHVlID0gdGhpcy5jaGlsZHJlbltpXS5nZXRWYWx1ZSgpOwoKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YoZmllbGRWYWx1ZSkgIT09ICJ1bmRlZmluZWQiKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRldGVybWluZUFsbERlcGVuZGVuY2llc1ZhbGlkKHByb3BlcnR5SWQpKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFzc2lnbmVkVmFsdWUgPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZihmaWVsZFZhbHVlKSA9PT0gImJvb2xlYW4iKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NpZ25lZFZhbHVlID0gKGZpZWxkVmFsdWU/IHRydWU6IGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChBbHBhY2EuaXNBcnJheShmaWVsZFZhbHVlKSB8fCBBbHBhY2EuaXNPYmplY3QoZmllbGRWYWx1ZSkpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lnbmVkVmFsdWUgPSBmaWVsZFZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGZpZWxkVmFsdWUpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lnbmVkVmFsdWUgPSBmaWVsZFZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXNzaWduZWRWYWx1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb1twcm9wZXJ0eUlkXSA9IGFzc2lnbmVkVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBvOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI3Bvc3RSZW5kZXIKICAgICAgICAgKi8KICAgICAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbihjYWxsYmFjaykgewoKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgdGhpcy5iYXNlKGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgIC8vIEdlbmVyYXRlcyB3aXphcmQgaWYgcmVxdWVzdGVkCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5pc1RvcExldmVsKCkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi52aWV3KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYud2l6YXJkQ29uZmlncyA9IHNlbGYudmlldy5nZXRXaXphcmQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYud2l6YXJkQ29uZmlncykgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNldCB1cCBkZWZhdWx0cyBmb3Igd2l6YXJkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzVW5kZWZpbmVkKHNlbGYud2l6YXJkQ29uZmlncy52YWxpZGF0aW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYud2l6YXJkQ29uZmlncy52YWxpZGF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2VsZi53aXphcmRDb25maWdzLmJ1dHRvbnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLndpemFyZENvbmZpZ3MuYnV0dG9ucyA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRvbmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2VsZi53aXphcmRDb25maWdzLmJ1dHRvbnMuZG9uZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYud2l6YXJkQ29uZmlncy5idXR0b25zLmRvbmUgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNVbmRlZmluZWQoc2VsZi53aXphcmRDb25maWdzLmJ1dHRvbnMuZG9uZS52YWxpZGF0ZU9uQ2xpY2spKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi53aXphcmRDb25maWdzLmJ1dHRvbnMuZG9uZS52YWxpZGF0ZU9uQ2xpY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHByZXYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2VsZi53aXphcmRDb25maWdzLmJ1dHRvbnMucHJldikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYud2l6YXJkQ29uZmlncy5idXR0b25zLnByZXYgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNVbmRlZmluZWQoc2VsZi53aXphcmRDb25maWdzLmJ1dHRvbnMucHJldi52YWxpZGF0ZU9uQ2xpY2spKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi53aXphcmRDb25maWdzLmJ1dHRvbnMucHJldi52YWxpZGF0ZU9uQ2xpY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5leHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2VsZi53aXphcmRDb25maWdzLmJ1dHRvbnMubmV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYud2l6YXJkQ29uZmlncy5idXR0b25zLm5leHQgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNVbmRlZmluZWQoc2VsZi53aXphcmRDb25maWdzLmJ1dHRvbnMubmV4dC52YWxpZGF0ZU9uQ2xpY2spKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi53aXphcmRDb25maWdzLmJ1dHRvbnMubmV4dC52YWxpZGF0ZU9uQ2xpY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsYXlvdXRUZW1wbGF0ZURlc2NyaXB0b3IgPSBzZWxmLnZpZXcuZ2V0TGF5b3V0KCkudGVtcGxhdGVEZXNjcmlwdG9yOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi53aXphcmRDb25maWdzICYmIHNlbGYud2l6YXJkQ29uZmlncy5yZW5kZXJXaXphcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXlvdXRUZW1wbGF0ZURlc2NyaXB0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL1dpemFyZCBiYXNlZCBvbiBsYXlvdXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLndpemFyZCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL1dpemFyZCBiYXNlZCBvbiBpbmplY3Rpb25zCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hdXRvV2l6YXJkKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udGFpbmVyRmllbGQjaGFuZGxlVmFsaWRhdGUKICAgICAgICAgKi8KICAgICAgICBoYW5kbGVWYWxpZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBiYXNlU3RhdHVzID0gdGhpcy5iYXNlKCk7CgogICAgICAgICAgICB2YXIgdmFsSW5mbyA9IHRoaXMudmFsaWRhdGlvbjsKCiAgICAgICAgICAgIHZhciBzdGF0dXMgPSB0aGlzLl92YWxpZGF0ZU1heFByb3BlcnRpZXMoKTsKICAgICAgICAgICAgdmFsSW5mb1sidG9vTWFueVByb3BlcnRpZXMiXSA9IHsKICAgICAgICAgICAgICAgICJtZXNzYWdlIjogc3RhdHVzID8gIiIgOiBBbHBhY2Euc3Vic3RpdHV0ZVRva2Vucyh0aGlzLnZpZXcuZ2V0TWVzc2FnZSgidG9vTWFueVByb3BlcnRpZXMiKSwgW3RoaXMuc2NoZW1hLm1heFByb3BlcnRpZXNdKSwKICAgICAgICAgICAgICAgICJzdGF0dXMiOiBzdGF0dXMKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHN0YXR1cyA9IHRoaXMuX3ZhbGlkYXRlTWluUHJvcGVydGllcygpOwogICAgICAgICAgICB2YWxJbmZvWyJ0b29GZXdQcm9wZXJ0aWVzIl0gPSB7CiAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHN0YXR1cyA/ICIiIDogQWxwYWNhLnN1YnN0aXR1dGVUb2tlbnModGhpcy52aWV3LmdldE1lc3NhZ2UoInRvb01hbnlJdGVtcyIpLCBbdGhpcy5zY2hlbWEuaXRlbXMubWluUHJvcGVydGllc10pLAogICAgICAgICAgICAgICAgInN0YXR1cyI6IHN0YXR1cwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgcmV0dXJuIGJhc2VTdGF0dXMgJiYgdmFsSW5mb1sidG9vTWFueVByb3BlcnRpZXMiXVsic3RhdHVzIl0gJiYgdmFsSW5mb1sidG9vRmV3UHJvcGVydGllcyJdWyJzdGF0dXMiXTsKICAgICAgICB9LC8vX19CVUlMREVSX0hFTFBFUlMKCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaWRhdGUgbWF4UHJvcGVydGllcyBzY2hlbWEgcHJvcGVydHkuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gd2hldGhlciBtYXhQcm9wZXJ0aWVzIGlzIHNhdGlzZmllZAogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZU1heFByb3BlcnRpZXM6IGZ1bmN0aW9uKCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YodGhpcy5zY2hlbWFbIm1heFByb3BlcnRpZXMiXSkgPT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgbWF4UHJvcGVydGllcyA9IHRoaXMuc2NoZW1hWyJtYXhQcm9wZXJ0aWVzIl07CgogICAgICAgICAgICAvLyBjb3VudCB0aGUgbnVtYmVyIG9mIHByb3BlcnRpZXMgdGhhdCB3ZSBjdXJyZW50bHkgaGF2ZQogICAgICAgICAgICB2YXIgcHJvcGVydHlDb3VudCA9IDA7CiAgICAgICAgICAgIGZvciAodmFyIGsgaW4gdGhpcy5kYXRhKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBwcm9wZXJ0eUNvdW50Kys7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBwcm9wZXJ0eUNvdW50IDw9IG1heFByb3BlcnRpZXM7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaWRhdGUgbWF4UHJvcGVydGllcyBzY2hlbWEgcHJvcGVydHkuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gd2hldGhlciBtYXhQcm9wZXJ0aWVzIGlzIHNhdGlzZmllZAogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZU1pblByb3BlcnRpZXM6IGZ1bmN0aW9uKCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YodGhpcy5zY2hlbWFbIm1pblByb3BlcnRpZXMiXSkgPT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgbWluUHJvcGVydGllcyA9IHRoaXMuc2NoZW1hWyJtaW5Qcm9wZXJ0aWVzIl07CgogICAgICAgICAgICAvLyBjb3VudCB0aGUgbnVtYmVyIG9mIHByb3BlcnRpZXMgdGhhdCB3ZSBjdXJyZW50bHkgaGF2ZQogICAgICAgICAgICB2YXIgcHJvcGVydHlDb3VudCA9IDA7CiAgICAgICAgICAgIGZvciAodmFyIGsgaW4gdGhpcy5kYXRhKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBwcm9wZXJ0eUNvdW50Kys7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBwcm9wZXJ0eUNvdW50ID49IG1pblByb3BlcnRpZXM7CiAgICAgICAgfSwKCiAgICAgICAgLy9fX0JVSUxERVJfSEVMUEVSUwoKCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyBjaGlsZCBpbmRleC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwcm9wZXJ0eUlkIENoaWxkIGZpZWxkIHByb3BlcnR5IElELgogICAgICAgICAqLwogICAgICAgIGdldEluZGV4OiBmdW5jdGlvbihwcm9wZXJ0eUlkKSB7CiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNFbXB0eShwcm9wZXJ0eUlkKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHBpZCA9IHRoaXMuY2hpbGRyZW5baV0ucHJvcGVydHlJZDsKICAgICAgICAgICAgICAgIGlmIChwaWQgPT0gcHJvcGVydHlJZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBEZXRlcm1pbmVzIHRoZSBzY2hlbWEgYW5kIG9wdGlvbnMgdG8gdXRpbGl6ZSBmb3Igc3ViLW9iamVjdHMgd2l0aGluIHRoaXMgb2JqZWN0LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHByb3BlcnR5SWQKICAgICAgICAgKiBAcGFyYW0gY2FsbGJhY2sKICAgICAgICAgKi8KICAgICAgICByZXNvbHZlUHJvcGVydHlTY2hlbWFPcHRpb25zOiBmdW5jdGlvbihwcm9wZXJ0eUlkLCBjYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICB2YXIgcHJvcGVydHlTY2hlbWEgPSBudWxsOwogICAgICAgICAgICBpZiAoX3RoaXMuc2NoZW1hICYmIF90aGlzLnNjaGVtYS5wcm9wZXJ0aWVzICYmIF90aGlzLnNjaGVtYS5wcm9wZXJ0aWVzW3Byb3BlcnR5SWRdKSB7CiAgICAgICAgICAgICAgICBwcm9wZXJ0eVNjaGVtYSA9IF90aGlzLnNjaGVtYS5wcm9wZXJ0aWVzW3Byb3BlcnR5SWRdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcm9wZXJ0eU9wdGlvbnMgPSB7fTsKICAgICAgICAgICAgaWYgKF90aGlzLm9wdGlvbnMgJiYgX3RoaXMub3B0aW9ucy5maWVsZHMgJiYgX3RoaXMub3B0aW9ucy5maWVsZHNbcHJvcGVydHlJZF0pIHsKICAgICAgICAgICAgICAgIHByb3BlcnR5T3B0aW9ucyA9IF90aGlzLm9wdGlvbnMuZmllbGRzW3Byb3BlcnR5SWRdOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBoYW5kbGUgJHJlZgogICAgICAgICAgICBpZiAocHJvcGVydHlTY2hlbWEgJiYgcHJvcGVydHlTY2hlbWFbIiRyZWYiXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHJlZmVyZW5jZUlkID0gcHJvcGVydHlTY2hlbWFbIiRyZWYiXTsKCiAgICAgICAgICAgICAgICB2YXIgdG9wRmllbGQgPSB0aGlzOwogICAgICAgICAgICAgICAgdmFyIGZpZWxkQ2hhaW4gPSBbdG9wRmllbGRdOwogICAgICAgICAgICAgICAgd2hpbGUgKHRvcEZpZWxkLnBhcmVudCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0b3BGaWVsZCA9IHRvcEZpZWxkLnBhcmVudDsKICAgICAgICAgICAgICAgICAgICBmaWVsZENoYWluLnB1c2godG9wRmllbGQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbFByb3BlcnR5U2NoZW1hID0gcHJvcGVydHlTY2hlbWE7CiAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxQcm9wZXJ0eU9wdGlvbnMgPSBwcm9wZXJ0eU9wdGlvbnM7CgogICAgICAgICAgICAgICAgQWxwYWNhLmxvYWRSZWZTY2hlbWFPcHRpb25zKHRvcEZpZWxkLCByZWZlcmVuY2VJZCwgZnVuY3Rpb24ocHJvcGVydHlTY2hlbWEsIHByb3BlcnR5T3B0aW9ucykgewoKICAgICAgICAgICAgICAgICAgICAvLyB3YWxrIHRoZSBmaWVsZCBjaGFpbiB0byBzZWUgaWYgd2UgaGF2ZSBhbnkgY2lyY3VsYXJpdHkKICAgICAgICAgICAgICAgICAgICB2YXIgcmVmQ291bnQgPSAwOwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZmllbGRDaGFpbi5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaWVsZENoYWluW2ldLnNjaGVtYSAmJiBmaWVsZENoYWluW2ldLnNjaGVtYS5pZCA9PT0gcmVmZXJlbmNlSWQpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZkNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHZhciBjaXJjdWxhciA9IChyZWZDb3VudCA+IDEpOwoKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWRQcm9wZXJ0eVNjaGVtYSA9IHt9OwogICAgICAgICAgICAgICAgICAgIGlmIChvcmlnaW5hbFByb3BlcnR5U2NoZW1hKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEFscGFjYS5tZXJnZU9iamVjdChyZXNvbHZlZFByb3BlcnR5U2NoZW1hLCBvcmlnaW5hbFByb3BlcnR5U2NoZW1hKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5U2NoZW1hKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgQWxwYWNhLm1lcmdlT2JqZWN0KHJlc29sdmVkUHJvcGVydHlTY2hlbWEsIHByb3BlcnR5U2NoZW1hKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8ga2VlcCBvcmlnaW5hbCBpZAogICAgICAgICAgICAgICAgICAgIGlmIChvcmlnaW5hbFByb3BlcnR5U2NoZW1hICYmIG9yaWdpbmFsUHJvcGVydHlTY2hlbWEuaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRQcm9wZXJ0eVNjaGVtYS5pZCA9IG9yaWdpbmFsUHJvcGVydHlTY2hlbWEuaWQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vZGVsZXRlIHJlc29sdmVkUHJvcGVydHlTY2hlbWEuaWQ7CgogICAgICAgICAgICAgICAgICAgIHZhciByZXNvbHZlZFByb3BlcnR5T3B0aW9ucyA9IHt9OwogICAgICAgICAgICAgICAgICAgIGlmIChvcmlnaW5hbFByb3BlcnR5T3B0aW9ucykgewogICAgICAgICAgICAgICAgICAgICAgICBBbHBhY2EubWVyZ2VPYmplY3QocmVzb2x2ZWRQcm9wZXJ0eU9wdGlvbnMsIG9yaWdpbmFsUHJvcGVydHlPcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5T3B0aW9ucykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIEFscGFjYS5tZXJnZU9iamVjdChyZXNvbHZlZFByb3BlcnR5T3B0aW9ucywgcHJvcGVydHlPcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIEFscGFjYS5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2socmVzb2x2ZWRQcm9wZXJ0eVNjaGVtYSwgcmVzb2x2ZWRQcm9wZXJ0eU9wdGlvbnMsIGNpcmN1bGFyKTsKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgLy9jYWxsYmFjayhyZXNvbHZlZFByb3BlcnR5U2NoZW1hLCByZXNvbHZlZFByb3BlcnR5T3B0aW9ucywgY2lyY3VsYXIpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBBbHBhY2EubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2socHJvcGVydHlTY2hlbWEsIHByb3BlcnR5T3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAvL2NhbGxiYWNrKHByb3BlcnR5U2NoZW1hLCBwcm9wZXJ0eU9wdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVtb3ZlcyBjaGlsZAogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGlkIHRoZSBhbHBhY2EgZmllbGQgaWQgb2YgdGhlIGZpZWxkIHRvIGJlIHJlbW92ZWQKICAgICAgICAgKi8KICAgICAgICByZW1vdmVJdGVtOiBmdW5jdGlvbihpZCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY2hpbGRyZW4gPSAkLmdyZXAodGhpcy5jaGlsZHJlbiwgZnVuY3Rpb24odmFsLCBpbmRleCkgewogICAgICAgICAgICAgICAgcmV0dXJuICh2YWwuZ2V0SWQoKSAhPSBpZCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdmFyIGNoaWxkRmllbGQgPSB0aGlzLmNoaWxkcmVuQnlJZFtpZF07CgogICAgICAgICAgICBkZWxldGUgdGhpcy5jaGlsZHJlbkJ5SWRbaWRdOwogICAgICAgICAgICBpZiAoY2hpbGRGaWVsZC5wcm9wZXJ0eUlkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5jaGlsZHJlbkJ5UHJvcGVydHlJZFtjaGlsZEZpZWxkLnByb3BlcnR5SWRdOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjaGlsZEZpZWxkLmRlc3Ryb3koKTsKCiAgICAgICAgICAgIHRoaXMucmVmcmVzaFZhbGlkYXRpb25TdGF0ZSgpOwoKICAgICAgICAgICAgLy8gdHJpZ2dlciB1cGRhdGUgaGFuZGxlcgogICAgICAgICAgICB0aGlzLnRyaWdnZXJVcGRhdGUoKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBBZGRzIGEgY2hpbGQgaXRlbS4gIFJldHVybnMgdGhlIGNvbnRhaW5lciBlbGVtZW50IHJpZ2h0IGF3YXkuICBUaGUgcG9zdFJlbmRlckNhbGxiYWNrIG1ldGhvZCBpcyBjYWxsZWQKICAgICAgICAgKiB1cG9uIGNvbXBsZXRpb24uCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHlJZCBDaGlsZCBmaWVsZCBwcm9wZXJ0eSBJRC4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gaXRlbVNjaGVtYSBzY2hlbWEKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZmllbGRPcHRpb25zIENoaWxkIGZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IHZhbHVlIENoaWxkIGZpZWxkIHZhbHVlCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGluc2VydEFmdGVySWQgTG9jYXRpb24gd2hlcmUgdGhlIGNoaWxkIGl0ZW0gd2lsbCBiZSBpbnNlcnRlZC4KICAgICAgICAgKiBAcGFyYW0gW0Jvb2xlYW5dIGlzRHluYW1pY1N1Ykl0ZW0gd2hldGhlciB0aGlzIGl0ZW0gaXMgYmVpbmcgZHluYW1pY2FsbHkgY3JlYXRlZCAoYWZ0ZXIgZmlyc3QgcmVuZGVyKQogICAgICAgICAqIEBwYXJhbSBbRnVuY3Rpb259IHBvc3RSZW5kZXJDYWxsYmFjayBjYWxsZWQgb25jZSB0aGUgaXRlbSBoYXMgYmVlbiBhZGRlZAogICAgICAgICAqLwogICAgICAgIGFkZEl0ZW06IGZ1bmN0aW9uKHByb3BlcnR5SWQsIGl0ZW1TY2hlbWEsIGl0ZW1PcHRpb25zLCBpdGVtRGF0YSwgaW5zZXJ0QWZ0ZXJJZCwgaXNEeW5hbWljU3ViSXRlbSwgcG9zdFJlbmRlckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICB2YXIgY29udGFpbmVyRWxlbSA9IF90aGlzLnJlbmRlckl0ZW1Db250YWluZXIoaW5zZXJ0QWZ0ZXJJZCwgdGhpcywgcHJvcGVydHlJZCk7CiAgICAgICAgICAgIGNvbnRhaW5lckVsZW0uYWxwYWNhKHsKICAgICAgICAgICAgICAgICJkYXRhIiA6IGl0ZW1EYXRhLAogICAgICAgICAgICAgICAgIm9wdGlvbnMiOiBpdGVtT3B0aW9ucywKICAgICAgICAgICAgICAgICJzY2hlbWEiIDogaXRlbVNjaGVtYSwKICAgICAgICAgICAgICAgICJ2aWV3IiA6IHRoaXMudmlldy5pZCA/IHRoaXMudmlldy5pZCA6IHRoaXMudmlldywKICAgICAgICAgICAgICAgICJjb25uZWN0b3IiOiB0aGlzLmNvbm5lY3RvciwKICAgICAgICAgICAgICAgICJlcnJvciI6IGZ1bmN0aW9uKGVycikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5kZXN0cm95KCk7CgogICAgICAgICAgICAgICAgICAgIF90aGlzLmVycm9yQ2FsbGJhY2suY2FsbChfdGhpcywgZXJyKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAibm90VG9wTGV2ZWwiOnRydWUsCiAgICAgICAgICAgICAgICAiaXNEeW5hbWljQ3JlYXRpb24iOiAoaXNEeW5hbWljU3ViSXRlbSB8fCB0aGlzLmlzRHluYW1pY0NyZWF0aW9uKSwKICAgICAgICAgICAgICAgICJyZW5kZXIiIDogZnVuY3Rpb24oZmllbGRDb250cm9sLCBjYikgewogICAgICAgICAgICAgICAgICAgIC8vIHJlbmRlcgogICAgICAgICAgICAgICAgICAgIGZpZWxkQ29udHJvbC5wYXJlbnQgPSBfdGhpczsKICAgICAgICAgICAgICAgICAgICAvLyBhZGQgdGhlIHByb3BlcnR5IElkCiAgICAgICAgICAgICAgICAgICAgZmllbGRDb250cm9sLnByb3BlcnR5SWQgPSBwcm9wZXJ0eUlkOwogICAgICAgICAgICAgICAgICAgIC8vIHNldHVwIGl0ZW0gcGF0aAogICAgICAgICAgICAgICAgICAgIGlmIChfdGhpcy5wYXRoICE9ICIvIikgewogICAgICAgICAgICAgICAgICAgICAgICBmaWVsZENvbnRyb2wucGF0aCA9IF90aGlzLnBhdGggKyAiLyIgKyBwcm9wZXJ0eUlkOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkQ29udHJvbC5wYXRoID0gX3RoaXMucGF0aCArIHByb3BlcnR5SWQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZpZWxkQ29udHJvbC5yZW5kZXIobnVsbCwgZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXJFbGVtLmF0dHIoImlkIiwgZmllbGRDb250cm9sLmdldElkKCkgKyAiLWl0ZW0tY29udGFpbmVyIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lckVsZW0uYXR0cigiYWxwYWNhLWlkIiwgZmllbGRDb250cm9sLmdldElkKCkpOwogICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXJFbGVtLmFkZENsYXNzKCJhbHBhY2EtZmllbGRzZXQtaXRlbS1jb250YWluZXIiKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVtZW1iZXIgdGhlIGNvbnRyb2wKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFscGFjYS5pc0VtcHR5KGluc2VydEFmdGVySWQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5hZGRDaGlsZChmaWVsZENvbnRyb2wpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gX3RoaXMuZ2V0SW5kZXgoaW5zZXJ0QWZ0ZXJJZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggIT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5hZGRDaGlsZChmaWVsZENvbnRyb2wsIGluZGV4ICsgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmFkZENoaWxkKGZpZWxkQ29udHJvbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc2VydEFmdGVySWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnJlZnJlc2hWYWxpZGF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgbm90IGVtcHR5LCBtYXJrIHRoZSAibGFzdCIgYW5kICJmaXJzdCIgZG9tIGVsZW1lbnRzIGluIHRoZSBsaXN0CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkKGNvbnRhaW5lckVsZW0pLnNpYmxpbmdzKCkuYWRkQmFjaygpLmxlbmd0aCA+IDApCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoY29udGFpbmVyRWxlbSkucGFyZW50KCkucmVtb3ZlQ2xhc3MoImFscGFjYS1maWVsZHNldC1pdGVtcy1jb250YWluZXItZW1wdHkiKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGNvbnRhaW5lckVsZW0pLnNpYmxpbmdzKCkuYWRkQmFjaygpLnJlbW92ZUNsYXNzKCJhbHBhY2EtaXRlbS1jb250YWluZXItZmlyc3QiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoY29udGFpbmVyRWxlbSkuc2libGluZ3MoKS5hZGRCYWNrKCkucmVtb3ZlQ2xhc3MoImFscGFjYS1pdGVtLWNvbnRhaW5lci1sYXN0Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGNvbnRhaW5lckVsZW0pLnNpYmxpbmdzKCkuYWRkQmFjaygpLmZpcnN0KCkuYWRkQ2xhc3MoImFscGFjYS1pdGVtLWNvbnRhaW5lci1maXJzdCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJChjb250YWluZXJFbGVtKS5zaWJsaW5ncygpLmFkZEJhY2soKS5sYXN0KCkuYWRkQ2xhc3MoImFscGFjYS1pdGVtLWNvbnRhaW5lci1sYXN0Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN0b3JlIGtleSBvbiBkb20gZWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICAkKGNvbnRhaW5lckVsZW0pLmF0dHIoImRhdGEtYWxwYWNhLWl0ZW0tY29udGFpbmVyLWl0ZW0ta2V5IiwgcHJvcGVydHlJZCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyB0cmlnZ2VyIHVwZGF0ZSBvbiB0aGUgcGFyZW50IGFycmF5CiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnRyaWdnZXJVcGRhdGUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYikKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2IoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAicG9zdFJlbmRlciI6IGZ1bmN0aW9uKGNvbnRyb2wpIHsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHBvc3RSZW5kZXJDYWxsYmFjaykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvc3RSZW5kZXJDYWxsYmFjayhjb250cm9sKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lckVsZW07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udGFpbmVyRmllbGQjcmVuZGVySXRlbXMKICAgICAgICAgKi8KICAgICAgICByZW5kZXJJdGVtczogZnVuY3Rpb24ob25TdWNjZXNzKSB7CgogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgLy8gd2Uga2VlcCBhIG1hcCBvZiBhbGwgb2YgdGhlIHByb3BlcnRpZXMgaW4gb3VyIG9yaWdpbmFsIGRhdGEgb2JqZWN0CiAgICAgICAgICAgIC8vIGFzIHdlIHJlbmRlciBlbGVtZW50cyBvdXQgb2YgdGhlIHNjaGVtYSwgd2UgcmVtb3ZlIGZyb20gdGhlIGRhdGFQcm9wZXJ0aWVzIG1hcAogICAgICAgICAgICAvLyB3aGF0ZXZlciBpcyBsZWZ0b3ZlciBhcmUgdGhlIGRhdGEgcHJvcGVydGllcyB0aGF0IHdlcmUgTk9UIHJlbmRlcmVkIGJlY2F1c2UgdGhleSB3ZXJlIG5vdCBwYXJ0CiAgICAgICAgICAgIC8vIG9mIHRoZSBzY2hlbWEKICAgICAgICAgICAgLy8gd2UgdXNlIHRoaXMgZm9yIGRlYnVnZ2luZwogICAgICAgICAgICB2YXIgZXh0cmFEYXRhUHJvcGVydGllcyA9IHt9OwogICAgICAgICAgICBmb3IgKHZhciBkYXRhS2V5IGluIF90aGlzLmRhdGEpIHsKICAgICAgICAgICAgICAgIGV4dHJhRGF0YVByb3BlcnRpZXNbZGF0YUtleV0gPSBkYXRhS2V5OwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgcHJvcGVydGllcyA9IF90aGlzLmRhdGE7CiAgICAgICAgICAgIGlmIChfdGhpcy5zY2hlbWEgJiYgX3RoaXMuc2NoZW1hLnByb3BlcnRpZXMpIHsKICAgICAgICAgICAgICAgIHByb3BlcnRpZXMgPSBfdGhpcy5zY2hlbWEucHJvcGVydGllczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGNmID0gZnVuY3Rpb24oKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgc2NoZW1hIGFuZCB0aGUgZGF0YSBsaW5lIHVwIHBlcmZlY3RseSwgdGhlbiB0aGVyZSB3aWxsIGJlIG5vIHByb3BlcnRpZXMgaW4gdGhlIGRhdGEgdGhhdCBhcmUKICAgICAgICAgICAgICAgIC8vIG5vdCBhbHNvIGluIHRoZSBzY2hlbWEsIGFuZCB0aHVzLCBleHRyYURhdGFQcm9wZXJ0aWVzIHdpbGwgYmUgZW1wdHkuCiAgICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgICAgLy8gT24gdGhlIG90aGVyIGhhbmQsIGlmIHRoZXJlIGFyZSBzb21lIHByb3BlcnRpZXMgaW4gZGF0YSB0aGF0IHdlcmUgbm90IGluIHNjaGVtYSwgdGhlbiB0aGV5IHdpbGwKICAgICAgICAgICAgICAgIC8vIHJlbWFpbiBpbiBleHRyYURhdGFQcm9wZXJ0aWVzIGFuZCB3ZSBjYW4gaW5mb3JtIGRldmVsb3BlcnMgZm9yIGRlYnVnZ2luZyBwdXJwb3NlcwogICAgICAgICAgICAgICAgLy8KICAgICAgICAgICAgICAgIHZhciBleHRyYURhdGFLZXlzID0gW107CiAgICAgICAgICAgICAgICBmb3IgKHZhciBleHRyYURhdGFLZXkgaW4gZXh0cmFEYXRhUHJvcGVydGllcykgewogICAgICAgICAgICAgICAgICAgIGV4dHJhRGF0YUtleXMucHVzaChleHRyYURhdGFLZXkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGV4dHJhRGF0YUtleXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIEFscGFjYS5sb2dEZWJ1ZygiVGhlcmUgd2VyZSAiICsgZXh0cmFEYXRhS2V5cy5sZW5ndGggKyAiIGV4dHJhIGRhdGEga2V5cyB0aGF0IHdlcmUgbm90IHBhcnQgb2YgdGhlIHNjaGVtYSAiICsgSlNPTi5zdHJpbmdpZnkoZXh0cmFEYXRhS2V5cykpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vX3RoaXMucmVmcmVzaFZhbGlkYXRpb25TdGF0ZSgpOwoKICAgICAgICAgICAgICAgIGlmIChvblN1Y2Nlc3MpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgb25TdWNjZXNzKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBlYWNoIHByb3BlcnR5IGluIHRoZSBvYmplY3QgY2FuIGhhdmUgYSBkaWZmZXJlbnQgc2NoZW1hIGFuZCBvcHRpb25zIHNvIHdlIG5lZWQgdG8gcHJvY2VzcwogICAgICAgICAgICAvLyBhc3luY2hyb25vdXNseSBhbmQgd2FpdCBmb3IgYWxsIHRvIGNvbXBsZXRlCgogICAgICAgICAgICAvLyB3cmFwIGludG8gd2F0ZXJmYWxsIGZ1bmN0aW9ucwogICAgICAgICAgICB2YXIgcHJvcGVydHlGdW5jdGlvbnMgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgcHJvcGVydHlJZCBpbiBwcm9wZXJ0aWVzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgaXRlbURhdGEgPSBudWxsOwogICAgICAgICAgICAgICAgaWYgKF90aGlzLmRhdGEpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaXRlbURhdGEgPSBfdGhpcy5kYXRhW3Byb3BlcnR5SWRdOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBwZiA9IChmdW5jdGlvbihwcm9wZXJ0eUlkLCBpdGVtRGF0YSwgZXh0cmFEYXRhUHJvcGVydGllcykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oY2FsbGJhY2spCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBvbmx5IGFsbG93IHRoaXMgaWYgd2UgaGF2ZSBkYXRhLCBvdGhlcndpc2Ugd2UgZW5kIHVwIHdpdGggY2lyY3VsYXIgcmVmZXJlbmNlCiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnJlc29sdmVQcm9wZXJ0eVNjaGVtYU9wdGlvbnMocHJvcGVydHlJZCwgZnVuY3Rpb24oc2NoZW1hLCBvcHRpb25zLCBjaXJjdWxhcikgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIG9ubHkgYWxsb3cgYWRkaXRpb24gaWYgdGhlIHJlc29sdmVkIHNjaGVtYSBpc24ndCBjaXJjdWxhcmx5IHJlZmVyZW5jZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG9yIHRoZSBzY2hlbWEgaXMgb3B0aW9uYWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaXJjdWxhcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gQWxwYWNhLnRocm93RXJyb3JXaXRoQ2FsbGJhY2soIkNpcmN1bGFyIHJlZmVyZW5jZSBkZXRlY3RlZCBmb3Igc2NoZW1hOiAiICsgc2NoZW1hLCBfdGhpcy5lcnJvckNhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXNjaGVtYSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBbHBhY2EubG9nRXJyb3IoIlVuYWJsZSB0byByZXNvbHZlIHNjaGVtYSBmb3IgcHJvcGVydHk6ICIgKyBwcm9wZXJ0eUlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5hZGRJdGVtKHByb3BlcnR5SWQsIHNjaGVtYSwgb3B0aW9ucywgaXRlbURhdGEsIG51bGwsIGZhbHNlLCBmdW5jdGlvbihhZGRlZEl0ZW1Db250cm9sKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBmcm9tIGV4dHJhRGF0YVByb3BlcnRpZXMgaGVscGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGV4dHJhRGF0YVByb3BlcnRpZXNbcHJvcGVydHlJZF07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhBTkRMRSBQUk9QRVJUWSBERVBFTkRFTkNJRVMgKElGIFRIRSBQUk9QRVJUWSBIQVMgVEhFTSkKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhpcyBwcm9wZXJ0eSBoYXMgZGVwZW5kZW5jaWVzLCBzaG93IG9yIGhpZGUgdGhpcyBhZGRlZCBpdGVtIHJpZ2h0IGF3YXkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5zaG93T3JIaWRlUHJvcGVydHlCYXNlZE9uRGVwZW5kZW5jaWVzKHByb3BlcnR5SWQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGlzIHByb3BlcnR5IGhhcyBkZXBlbmRlbmNpZXMsIGJpbmQgdXBkYXRlIGhhbmRsZXJzIHRvIGRlcGVuZGVudCBmaWVsZHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5iaW5kRGVwZW5kZW5jeUZpZWxkVXBkYXRlRXZlbnQocHJvcGVydHlJZCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoaXMgcHJvcGVydHkgaGFzIGRlcGVuZGVuY2llcywgdHJpZ2dlciB0aG9zZSB0byBlbnN1cmUgaXQgaXMgaW4gdGhlIHJpZ2h0IHN0YXRlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMucmVmcmVzaERlcGVuZGVudEZpZWxkU3RhdGVzKHByb3BlcnR5SWQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBieSB0aGUgdGltZSB3ZSBnZXQgaGVyZSwgd2UgbWF5IGhhdmUgY29uc3RydWN0ZWQgYSB2ZXJ5IGxhcmdlIGNoaWxkIGNoYWluIG9mCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3ViLWRlcGVuZGVuY2llcyBhbmQgc28gd2UgdXNlIG5leHRUaWNrKCkgaW5zdGVhZCBvZiBhIHN0cmFpZ2h0IGNhbGxiYWNrIHNvIGFzIHRvCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYXZvaWQgYmxvd2luZyBvdXQgdGhlIHN0YWNrIHNpemUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBbHBhY2EubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICB9KShwcm9wZXJ0eUlkLCBpdGVtRGF0YSwgZXh0cmFEYXRhUHJvcGVydGllcyk7CgogICAgICAgICAgICAgICAgcHJvcGVydHlGdW5jdGlvbnMucHVzaChwZik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIEFscGFjYS5zZXJpZXMocHJvcGVydHlGdW5jdGlvbnMsIGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgICAgY2YoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAvLwogICAgICAgIC8vIERFUEVOREVOQ0lFUwogICAgICAgIC8vCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICAvKioKICAgICAgICAgKiBTaG93cyBvciBoaWRlcyBhIHByb3BlcnR5J3MgZmllbGQgYmFzZWQgb24gaG93IGl0cyBkZXBlbmRlbmNpZXMgZXZhbHVhdGUuCiAgICAgICAgICogSWYgYSBwcm9wZXJ0eSBkb2Vzbid0IGhhdmUgZGVwZW5kZW5jaWVzLCB0aGlzIG5vLW9wcy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBwcm9wZXJ0eUlkCiAgICAgICAgICovCiAgICAgICAgc2hvd09ySGlkZVByb3BlcnR5QmFzZWRPbkRlcGVuZGVuY2llczogZnVuY3Rpb24ocHJvcGVydHlJZCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHZhciBpdGVtID0gdGhpcy5jaGlsZHJlbkJ5UHJvcGVydHlJZFtwcm9wZXJ0eUlkXTsKICAgICAgICAgICAgaWYgKCFpdGVtKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gQWxwYWNhLnRocm93RXJyb3JXaXRoQ2FsbGJhY2soIk1pc3NpbmcgcHJvcGVydHk6ICIgKyBwcm9wZXJ0eUlkLCBzZWxmLmVycm9yQ2FsbGJhY2spOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgdmFsaWQgPSB0aGlzLmRldGVybWluZUFsbERlcGVuZGVuY2llc1ZhbGlkKHByb3BlcnR5SWQpOwogICAgICAgICAgICBpZiAodmFsaWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGl0ZW0uc2hvdygpOwogICAgICAgICAgICAgICAgaXRlbS5vbkRlcGVuZGVudFJldmVhbCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaXRlbS5oaWRlKCk7CiAgICAgICAgICAgICAgICBpdGVtLm9uRGVwZW5kZW50Q29uY2VhbCgpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSBkZXBlbmRlbmNpZXMgZm9yIGEgcHJvcGVydHkgcGFzcy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBwcm9wZXJ0eUlkCiAgICAgICAgICovCiAgICAgICAgZGV0ZXJtaW5lQWxsRGVwZW5kZW5jaWVzVmFsaWQ6IGZ1bmN0aW9uKHByb3BlcnR5SWQpCiAgICAgICAgewogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB2YXIgaXRlbSA9IHRoaXMuY2hpbGRyZW5CeVByb3BlcnR5SWRbcHJvcGVydHlJZF07CiAgICAgICAgICAgIGlmICghaXRlbSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIEFscGFjYS50aHJvd0Vycm9yV2l0aENhbGxiYWNrKCJNaXNzaW5nIHByb3BlcnR5OiAiICsgcHJvcGVydHlJZCwgc2VsZi5lcnJvckNhbGxiYWNrKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGl0ZW1EZXBlbmRlbmNpZXMgPSBpdGVtLnNjaGVtYS5kZXBlbmRlbmNpZXM7CiAgICAgICAgICAgIGlmICghaXRlbURlcGVuZGVuY2llcykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gbm8gZGVwZW5kZW5jaWVzLCBzbyB5ZXMsIHdlIHBhc3MKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgdmFsaWQgPSB0cnVlOwogICAgICAgICAgICBpZiAoQWxwYWNhLmlzU3RyaW5nKGl0ZW1EZXBlbmRlbmNpZXMpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YWxpZCA9IHNlbGYuZGV0ZXJtaW5lU2luZ2xlRGVwZW5kZW5jeVZhbGlkKHByb3BlcnR5SWQsIGl0ZW1EZXBlbmRlbmNpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKEFscGFjYS5pc0FycmF5KGl0ZW1EZXBlbmRlbmNpZXMpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAkLmVhY2goaXRlbURlcGVuZGVuY2llcywgZnVuY3Rpb24oaW5kZXgsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsaWQgPSB2YWxpZCAmJiBzZWxmLmRldGVybWluZVNpbmdsZURlcGVuZGVuY3lWYWxpZChwcm9wZXJ0eUlkLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZhbGlkOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEJpbmRzIGZpZWxkIHVwZGF0ZXMgdG8gYW55IGZpZWxkIGRlcGVuZGVuY2llcy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBwcm9wZXJ0eUlkCiAgICAgICAgICovCiAgICAgICAgYmluZERlcGVuZGVuY3lGaWVsZFVwZGF0ZUV2ZW50OiBmdW5jdGlvbihwcm9wZXJ0eUlkKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgdmFyIGl0ZW0gPSB0aGlzLmNoaWxkcmVuQnlQcm9wZXJ0eUlkW3Byb3BlcnR5SWRdOwogICAgICAgICAgICBpZiAoIWl0ZW0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBBbHBhY2EudGhyb3dFcnJvcldpdGhDYWxsYmFjaygiTWlzc2luZyBwcm9wZXJ0eTogIiArIHByb3BlcnR5SWQsIHNlbGYuZXJyb3JDYWxsYmFjayk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBpdGVtRGVwZW5kZW5jaWVzID0gaXRlbS5zY2hlbWEuZGVwZW5kZW5jaWVzOwogICAgICAgICAgICBpZiAoIWl0ZW1EZXBlbmRlbmNpZXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIG5vIGRlcGVuZGVuY2llcywgc28gc2ltcGxlIHJldHVybgogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGhlbHBlciBmdW5jdGlvbgogICAgICAgICAgICB2YXIgYmluZEV2ZW50ID0gZnVuY3Rpb24ocHJvcGVydHlJZCwgZGVwZW5kZW5jeVByb3BlcnR5SWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIGRlcGVuZGVuY3lQcm9wZXJ0eUlkIGlzIHRoZSBpZGVudGlmaWVyIGZvciB0aGUgcHJvcGVydHkgdGhhdCB0aGUgZmllbGQgInByb3BlcnR5SWQiIGlzIGRlcGVuZGVudCBvbgoKICAgICAgICAgICAgICAgIHZhciBkZXBlbmRlbnRGaWVsZCA9IEFscGFjYS5yZXNvbHZlRmllbGQoc2VsZiwgZGVwZW5kZW5jeVByb3BlcnR5SWQpOwogICAgICAgICAgICAgICAgaWYgKGRlcGVuZGVudEZpZWxkKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGRlcGVuZGVudEZpZWxkLmdldEVsKCkuYmluZCgiZmllbGR1cGRhdGUiLCBmdW5jdGlvbihwcm9wZXJ0eUZpZWxkLCBkZXBlbmRlbmN5RmllbGQsIHByb3BlcnR5SWQsIGRlcGVuZGVuY3lQcm9wZXJ0eUlkKSB7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oZXZlbnQpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBwcm9wZXJ0eSAiZGVwZW5kZW5jeVByb3BlcnR5SWQiIGNoYW5nZWQgYW5kIGFmZmVjdHMgdGFyZ2V0IHByb3BlcnR5ICgicHJvcGVydHlJZCIpCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdXBkYXRlIFVJIHN0YXRlIGZvciB0YXJnZXQgcHJvcGVydHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2hvd09ySGlkZVByb3BlcnR5QmFzZWRPbkRlcGVuZGVuY2llcyhwcm9wZXJ0eUlkKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eUZpZWxkLnRyaWdnZXIoImZpZWxkdXBkYXRlIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIH0oaXRlbSwgZGVwZW5kZW50RmllbGQsIHByb3BlcnR5SWQsIGRlcGVuZGVuY3lQcm9wZXJ0eUlkKSk7CgogICAgICAgICAgICAgICAgICAgIC8vIHRyaWdnZXIgZmllbGQgdXBkYXRlCiAgICAgICAgICAgICAgICAgICAgZGVwZW5kZW50RmllbGQudHJpZ2dlcigiZmllbGR1cGRhdGUiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNTdHJpbmcoaXRlbURlcGVuZGVuY2llcykpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGJpbmRFdmVudChwcm9wZXJ0eUlkLCBpdGVtRGVwZW5kZW5jaWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChBbHBhY2EuaXNBcnJheShpdGVtRGVwZW5kZW5jaWVzKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgJC5lYWNoKGl0ZW1EZXBlbmRlbmNpZXMsIGZ1bmN0aW9uKGluZGV4LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGJpbmRFdmVudChwcm9wZXJ0eUlkLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHJlZnJlc2hEZXBlbmRlbnRGaWVsZFN0YXRlczogZnVuY3Rpb24ocHJvcGVydHlJZCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHZhciBwcm9wZXJ0eUZpZWxkID0gdGhpcy5jaGlsZHJlbkJ5UHJvcGVydHlJZFtwcm9wZXJ0eUlkXTsKICAgICAgICAgICAgaWYgKCFwcm9wZXJ0eUZpZWxkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gQWxwYWNhLnRocm93RXJyb3JXaXRoQ2FsbGJhY2soIk1pc3NpbmcgcHJvcGVydHk6ICIgKyBwcm9wZXJ0eUlkLCBzZWxmLmVycm9yQ2FsbGJhY2spOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgaXRlbURlcGVuZGVuY2llcyA9IHByb3BlcnR5RmllbGQuc2NoZW1hLmRlcGVuZGVuY2llczsKICAgICAgICAgICAgaWYgKCFpdGVtRGVwZW5kZW5jaWVzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBubyBkZXBlbmRlbmNpZXMsIHNvIHNpbXBsZSByZXR1cm4KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBoZWxwZXIgZnVuY3Rpb24KICAgICAgICAgICAgdmFyIHRyaWdnZXJGaWVsZFVwZGF0ZUZvclByb3BlcnR5ID0gZnVuY3Rpb24ob3RoZXJQcm9wZXJ0eUlkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgZGVwZW5kZW50RmllbGQgPSBBbHBhY2EucmVzb2x2ZUZpZWxkKHNlbGYsIG90aGVyUHJvcGVydHlJZCk7CiAgICAgICAgICAgICAgICBpZiAoZGVwZW5kZW50RmllbGQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gdHJpZ2dlciBmaWVsZCB1cGRhdGUKICAgICAgICAgICAgICAgICAgICBkZXBlbmRlbnRGaWVsZC50cmlnZ2VyKCJmaWVsZHVwZGF0ZSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKEFscGFjYS5pc1N0cmluZyhpdGVtRGVwZW5kZW5jaWVzKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdHJpZ2dlckZpZWxkVXBkYXRlRm9yUHJvcGVydHkoaXRlbURlcGVuZGVuY2llcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoQWxwYWNhLmlzQXJyYXkoaXRlbURlcGVuZGVuY2llcykpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICQuZWFjaChpdGVtRGVwZW5kZW5jaWVzLCBmdW5jdGlvbihpbmRleCwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICB0cmlnZ2VyRmllbGRVcGRhdGVGb3JQcm9wZXJ0eSh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENoZWNrcyB3aGV0aGVyIGEgc2luZ2xlIHByb3BlcnR5J3MgZGVwZW5kZW5jeSBpcyBzYXRpc2ZpZWQgb3Igbm90LgogICAgICAgICAqCiAgICAgICAgICogSW4gb3JkZXIgdG8gYmUgdmFsaWQsIHRoZSBwcm9wZXJ0eSdzIGRlcGVuZGVuY3kgbXVzdCBleGlzdCAoSlNPTiBzY2hlbWEpIGFuZCBvcHRpb25hbGx5IG11c3Qgc2F0aXNmeQogICAgICAgICAqIGFueSBkZXBlbmRlbmN5IG9wdGlvbnMgKHZhbHVlIG1hdGNoZXMgdXNpbmcgYW4gQU5EKS4gIEZpbmFsbHksIHRoZSBkZXBlbmRlbmN5IGZpZWxkIG11c3QgYmUgc2hvd2luZy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwcm9wZXJ0eUlkIEZpZWxkIHByb3BlcnR5IGlkLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBkZXBlbmRlbnRPblByb3BlcnR5SWQgUHJvcGVydHkgaWQgb2YgdGhlIGRlcGVuZGVuY3kgZmllbGQuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZiBhbGwgZGVwZW5kZW5jaWVzIGhhdmUgYmVlbiBzYXRpc2ZpZWQgYW5kIHRoZSBmaWVsZCBuZWVkcyB0byBiZSBzaG93biwKICAgICAgICAgKiBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgZGV0ZXJtaW5lU2luZ2xlRGVwZW5kZW5jeVZhbGlkOiBmdW5jdGlvbihwcm9wZXJ0eUlkLCBkZXBlbmRlbnRPblByb3BlcnR5SWQpCiAgICAgICAgewogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICAvLyBjaGVja3MgdG8gc2VlIGlmIHRoZSByZWZlcmVuY2VkICJkZXBlbmRlbnQtb24iIHByb3BlcnR5IGhhcyBhIHZhbHVlCiAgICAgICAgICAgIC8vIGJhc2ljIEpTT04tc2NoZW1hIHN1cHBvcnRzIHRoaXMgKGlmIGl0IGhhcyBBTlkgdmFsdWUsIGl0IGlzIGNvbnNpZGVyZWQgdmFsaWQKICAgICAgICAgICAgLy8gc3BlY2lhbCBjb25zaWRlcmF0aW9uIGZvciBib29sZWFuIGZhbHNlCiAgICAgICAgICAgIHZhciBkZXBlbmRlbnRPbkZpZWxkID0gQWxwYWNhLnJlc29sdmVGaWVsZChzZWxmLCBkZXBlbmRlbnRPblByb3BlcnR5SWQpOwogICAgICAgICAgICBpZiAoIWRlcGVuZGVudE9uRmllbGQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIG5vIGRlcGVuZGVudC1vbiBmaWVsZCBmb3VuZCwgcmV0dXJuIGZhbHNlCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBkZXBlbmRlbnRPbkRhdGEgPSBkZXBlbmRlbnRPbkZpZWxkLmRhdGE7CgogICAgICAgICAgICAvLyBhc3N1bWUgaXQgaXNuJ3QgdmFsaWQKICAgICAgICAgICAgdmFyIHZhbGlkID0gZmFsc2U7CgogICAgICAgICAgICAvLyBnbyBvbmUgb2YgdHdvIGRpcmVjdGlvbnMgZGVwZW5kaW5nIG9uIHdoZXRoZXIgd2UgaGF2ZSBjb25kaXRpb25hbCBkZXBlbmRlbmNpZXMgb3Igbm90CiAgICAgICAgICAgIHZhciBjb25kaXRpb25hbERlcGVuZGVuY2llcyA9IHRoaXMuY2hpbGRyZW5CeVByb3BlcnR5SWRbcHJvcGVydHlJZF0ub3B0aW9ucy5kZXBlbmRlbmNpZXM7CiAgICAgICAgICAgIGlmICghY29uZGl0aW9uYWxEZXBlbmRlbmNpZXMgfHwgY29uZGl0aW9uYWxEZXBlbmRlbmNpZXMubGVuZ3RoID09PSAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgICAgLy8gQkFTSUMgREVQRU5FTkRFTkNZIENIRUNLSU5HIChDT1JFIEpTT04gU0NIRU1BKQogICAgICAgICAgICAgICAgLy8KCiAgICAgICAgICAgICAgICAvLyBzcGVjaWFsIGNhc2U6IGlmIHRoZSBmaWVsZCBpcyBhIGJvb2xlYW4gZmllbGQgYW5kIHdlIGhhdmUgbm8gY29uZGl0aW9uYWwgZGVwZW5kZW5jeSBjaGVja2luZywKICAgICAgICAgICAgICAgIC8vIHRoZW4gd2Ugc2V0IHZhbGlkID0gZmFsc2UgaWYgdGhlIGZpZWxkIGRhdGEgaXMgYSBib29sZWFuIGZhbHNlCiAgICAgICAgICAgICAgICBpZiAoZGVwZW5kZW50T25GaWVsZC5nZXRUeXBlKCkgPT09ICJib29sZWFuIiAmJiAhdGhpcy5jaGlsZHJlbkJ5UHJvcGVydHlJZFtwcm9wZXJ0eUlkXS5vcHRpb25zLmRlcGVuZGVuY2llcyAmJiAhZGVwZW5kZW50T25EYXRhKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFsaWQgPSAhQWxwYWNhLmlzVmFsRW1wdHkoZGVwZW5kZW50T25GaWVsZC5kYXRhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgICAvLyBDT05ESVRJT05BTCBERVBFTkRFTkNZIENIRUNLSU5HIChBTFBBQ0EgRVhURU5TSU9OIFZJQSBPUFRJT05TKQogICAgICAgICAgICAgICAgLy8KCiAgICAgICAgICAgICAgICAvLyBBbHBhY2EgZXh0ZW5kcyBKU09OIHNjaGVtYSBieSBhbGxvd2luZyBkZXBlbmRlbmNpZXMgdG8gdHJpZ2dlciBvbmx5IGZvciBzcGVjaWZpYyB2YWx1ZXMgb24gdGhlCiAgICAgICAgICAgICAgICAvLyBkZXBlbmRlbnQgZmllbGRzLiAgSWYgb3B0aW9ucyBhcmUgc3BlY2lmaWVkIHRvIGRlZmluZSB0aGlzLCB3ZSB3YWxrIHRocm91Z2ggYW5kIHBlcmZvcm0gYW4KICAgICAgICAgICAgICAgIC8vIEFORCBvcGVyYXRpb24gYWNyb3NzIGFueSBmaWVsZHMKCiAgICAgICAgICAgICAgICAvLyBkbyBzb21lIGRhdGEgc2FuaXR5IGNsZWFudXAKICAgICAgICAgICAgICAgIGlmIChkZXBlbmRlbnRPbkZpZWxkLmdldFR5cGUoKSA9PT0gImJvb2xlYW4iICYmICFkZXBlbmRlbnRPbkRhdGEpIHsKICAgICAgICAgICAgICAgICAgICBkZXBlbmRlbnRPbkRhdGEgPSBmYWxzZQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBjb25kaXRpb25hbERhdGEgPSBjb25kaXRpb25hbERlcGVuZGVuY2llc1tkZXBlbmRlbnRPblByb3BlcnR5SWRdOwoKICAgICAgICAgICAgICAgIC8vIGlmIHRoZSBvcHRpb24gaXMgYSBmdW5jdGlvbiwgdGhlbiBldmFsdWF0ZSB0aGUgZnVuY3Rpb24gdG8gZGV0ZXJtaW5lIHdoZXRoZXIgdG8gc2hvdwogICAgICAgICAgICAgICAgLy8gdGhlIGZ1bmN0aW9uIGV2YWx1YXRlcyByZWdhcmRsZXNzIG9mIHdoZXRoZXIgdGhlIHNjaGVtYS1iYXNlZCBmYWxsYmFjayBkZXRlcm1pbmVkIHdlIHNob3VsZCBzaG93CiAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc0VtcHR5KGNvbmRpdGlvbmFsRGF0YSkgJiYgQWxwYWNhLmlzRnVuY3Rpb24oY29uZGl0aW9uYWxEYXRhKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YWxpZCA9IGNvbmRpdGlvbmFsRGF0YS5jYWxsKHRoaXMsIGRlcGVuZGVudE9uRGF0YSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gYXNzdW1lIHRydWUKICAgICAgICAgICAgICAgICAgICB2YWxpZCA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgIC8vIHRoZSBjb25kaXRpb25hbCBkYXRhIGlzIGFuIGFycmF5IG9mIHZhbHVlcwogICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNBcnJheShjb25kaXRpb25hbERhdGEpKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBjaGVjayBhcnJheSB2YWx1ZQogICAgICAgICAgICAgICAgICAgICAgICAvL2lmIChjb25kaXRpb25hbERlcGVuZGVuY2llc1tkZXBlbmRlbnRPblByb3BlcnR5SWRdICYmICQuaW5BcnJheShkZXBlbmRlbnRPbkRhdGEsIGNvbmRpdGlvbmFsRGVwZW5kZW5jaWVzW2RlcGVuZGVudE9uUHJvcGVydHlJZF0pID09IC0xKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmFueUVxdWFsaXR5KGRlcGVuZGVudE9uRGF0YSwgY29uZGl0aW9uYWxEYXRhKSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBjaGVjayBvYmplY3QgdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eShjb25kaXRpb25hbERhdGEpICYmICFBbHBhY2EuYW55RXF1YWxpdHkoY29uZGl0aW9uYWxEYXRhLCBkZXBlbmRlbnRPbkRhdGEpKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBORVNURUQgSElEREVOUyBERVBFTkRFTkNZIEhJREVTIChBTFBBQ0EgRVhURU5TSU9OKQogICAgICAgICAgICAvLwoKICAgICAgICAgICAgLy8gZmluYWwgY2hlY2s6IG9ubHkgc2V0IHZhbGlkIGlmIHRoZSBkZXBlbmRlbnRPblByb3BlcnR5SWQgaXMgc2hvd2luZwogICAgICAgICAgICBpZiAoZGVwZW5kZW50T25GaWVsZCAmJiBkZXBlbmRlbnRPbkZpZWxkLmlzSGlkZGVuKCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB2YWxpZDsKICAgICAgICB9LAoKCgoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8KICAgICAgICAvLyBXSVpBUkQKICAgICAgICAvLwogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCgoKICAgICAgICAvKioKICAgICAgICAgKiBSZW5kZXJzIGEgdGVtcGxhdGUtYmFzZWQgd2l6YXJkLgogICAgICAgICAqLwogICAgICAgIHdpemFyZDogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLm91dGVyRWw7CiAgICAgICAgICAgIHZhciBzdGVwcyA9ICQoJy5hbHBhY2Etd2l6YXJkLXN0ZXAnLCBlbGVtZW50KTsKICAgICAgICAgICAgdmFyIGNvdW50ID0gc3RlcHMuc2l6ZSgpOwoKICAgICAgICAgICAgdGhpcy50b3RhbFN0ZXBzID0gY291bnQ7CgogICAgICAgICAgICB2YXIgc3RlcFRpdGxlcyA9IFtdOwogICAgICAgICAgICBpZiAodGhpcy53aXphcmRDb25maWdzLnN0ZXBUaXRsZXMpIHsKICAgICAgICAgICAgICAgIHN0ZXBUaXRsZXMgPSB0aGlzLndpemFyZENvbmZpZ3Muc3RlcFRpdGxlczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFByZXBhcmUgc3RlcCB0aXRsZXMKICAgICAgICAgICAgICAgIHN0ZXBzLmVhY2goZnVuY3Rpb24oaSkgewogICAgICAgICAgICAgICAgICAgIHZhciBzdGVwVGl0bGUgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICIiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiIgogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgaWYgKCQoJy5hbHBhY2Etd2l6YXJkLXN0ZXAtdGl0bGUnLCB0aGlzKSkgewogICAgICAgICAgICAgICAgICAgICAgICBzdGVwVGl0bGUudGl0bGUgPSAkKCcuYWxwYWNhLXdpemFyZC1zdGVwLXRpdGxlJywgdGhpcykuaHRtbCgpOwogICAgICAgICAgICAgICAgICAgICAgICAkKCcuYWxwYWNhLXdpemFyZC1zdGVwLXRpdGxlJywgdGhpcykuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoJCgnLmFscGFjYS13aXphcmQtc3RlcC1kZXNjcmlwdGlvbicsIHRoaXMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0ZXBUaXRsZS5kZXNjcmlwdGlvbiA9ICQoJy5hbHBhY2Etd2l6YXJkLXN0ZXAtZGVzY3JpcHRpb24nLCB0aGlzKS5odG1sKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICQoJy5hbHBhY2Etd2l6YXJkLXN0ZXAtZGVzY3JpcHRpb24nLCB0aGlzKS5oaWRlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHN0ZXBUaXRsZXMucHVzaChzdGVwVGl0bGUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHdpemFyZFN0YXR1c0JhckVsZW1lbnQgPSB0aGlzLl9yZW5kZXJXaXphcmRTdGF0dXNCYXIoc3RlcFRpdGxlcyk7CiAgICAgICAgICAgIGlmICh3aXphcmRTdGF0dXNCYXJFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAkKGVsZW1lbnQpLmJlZm9yZSh3aXphcmRTdGF0dXNCYXJFbGVtZW50KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3RlcHMuZWFjaChmdW5jdGlvbihpKSB7CgogICAgICAgICAgICAgICAgdmFyIHdpemFyZFN0ZXBUYXJnZXRJZCA9ICQodGhpcykuYXR0cigiaWQiKTsKCiAgICAgICAgICAgICAgICB2YXIgc3RlcElkID0gJ3N0ZXAnICsgaTsKICAgICAgICAgICAgICAgIHZhciB3aXphcmRTdGVwVGVtcGxhdGVEZXNjcmlwdG9yID0gX3RoaXMudmlldy5nZXRUZW1wbGF0ZURlc2NyaXB0b3IoIndpemFyZFN0ZXAiKTsKICAgICAgICAgICAgICAgIGlmICh3aXphcmRTdGVwVGVtcGxhdGVEZXNjcmlwdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHdpemFyZFN0ZXBFbGVtZW50ID0gX3RoaXMudmlldy50bXBsKHdpemFyZFN0ZXBUZW1wbGF0ZURlc2NyaXB0b3IsIHt9KTsKICAgICAgICAgICAgICAgICAgICB3aXphcmRTdGVwRWxlbWVudC5hdHRyKCJpZCIsIHN0ZXBJZCk7CiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS53cmFwKHdpemFyZFN0ZXBFbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgbmF2QmFySWQgPSBzdGVwSWQgKyAnLW5hdi1iYXInOwogICAgICAgICAgICAgICAgdmFyIHdpemFyZE5hdkJhclRlbXBsYXRlRGVzY3JpcHRvciA9IF90aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJ3aXphcmROYXZCYXIiKTsKICAgICAgICAgICAgICAgIGlmICh3aXphcmROYXZCYXJUZW1wbGF0ZURlc2NyaXB0b3IpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgd2l6YXJkTmF2QmFyRWxlbWVudCA9IF90aGlzLnZpZXcudG1wbCh3aXphcmROYXZCYXJUZW1wbGF0ZURlc2NyaXB0b3IsIHt9KTsKICAgICAgICAgICAgICAgICAgICB3aXphcmROYXZCYXJFbGVtZW50LmF0dHIoImlkIiwgbmF2QmFySWQpOwogICAgICAgICAgICAgICAgICAgIHdpemFyZE5hdkJhckVsZW1lbnQuYWRkQ2xhc3MoJ2FscGFjYS13aXphcmQtbmF2LWJhcicpOwogICAgICAgICAgICAgICAgICAgICQodGhpcykuYXBwZW5kKHdpemFyZE5hdkJhckVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGNvbGxlY3QgYWxsIG9mIHRoZSBzdGVwQmluZGluZ3MgZm9yIHRoaXMgc3RlcAogICAgICAgICAgICAgICAgdmFyIHN0ZXBCaW5kaW5ncyA9IHt9OwogICAgICAgICAgICAgICAgdmFyIGJpbmRpbmdzID0gX3RoaXMudmlldy5nZXRMYXlvdXQoKS5iaW5kaW5nczsKICAgICAgICAgICAgICAgIGZvciAodmFyIGZpZWxkSWQgaW4gYmluZGluZ3MpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGJpbmRpbmdUYXJnZXRJZCA9IGJpbmRpbmdzW2ZpZWxkSWRdOwoKICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZ1RhcmdldElkID09IHdpemFyZFN0ZXBUYXJnZXRJZCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0ZXBCaW5kaW5nc1tmaWVsZElkXSA9IHdpemFyZFN0ZXBUYXJnZXRJZDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIHZGdW5jID0gZnVuY3Rpb24oc3RlcENvdW50LCBzdGVwQmluZGluZ3MpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbGlkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfdGhpcy53aXphcmRDb25maWdzICYmIF90aGlzLndpemFyZENvbmZpZ3MudmFsaWRhdGlvbikgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIGF1dG8td2l6YXJkLCBwcm9jZXNzIGJpbmRpbmdzIG9uZSBhdCBhIHRpbWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGVwQmluZGluZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkLmVhY2goc3RlcEJpbmRpbmdzLCBmdW5jdGlvbihwcm9wZXJ0eUlkLCBzdGVwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkID0gdmFsaWQgJiBfdGhpcy5jaGlsZHJlbkJ5UHJvcGVydHlJZFtwcm9wZXJ0eUlkXS52YWxpZGF0ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jaGlsZHJlbkJ5UHJvcGVydHlJZFtwcm9wZXJ0eUlkXS5yZWZyZXNoVmFsaWRhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsaWQ7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0oaSwgc3RlcEJpbmRpbmdzKTsKCiAgICAgICAgICAgICAgICBpZiAoaSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIF90aGlzLl9jcmVhdGVOZXh0QnV0dG9uKGksIHRydWUsIHZGdW5jKTsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5fc2VsZWN0U3RlcChpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaSA9PSBjb3VudCAtIDEpIHsKICAgICAgICAgICAgICAgICAgICAkKCIjc3RlcCIgKyBpKS5oaWRlKCk7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuX2NyZWF0ZVByZXZCdXR0b24oaSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIF90aGlzLl9jcmVhdGVEb25lQnV0dG9uKGksIHRydWUsIHZGdW5jKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJCgiI3N0ZXAiICsgaSkuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgIF90aGlzLl9jcmVhdGVQcmV2QnV0dG9uKGksIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5fY3JlYXRlTmV4dEJ1dHRvbihpLCB0cnVlLCB2RnVuYyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJlbmRlcnMgYSBjb25maWd1cmF0aW9uLWJhc2VkIHdpemFyZCB3aXRob3V0IGEgbGF5b3V0IHRlbXBsYXRlLgogICAgICAgICAqLwogICAgICAgIGF1dG9XaXphcmQ6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIHZhciB0b3RhbFN0ZXBzID0gdGhpcy53aXphcmRDb25maWdzLnN0ZXBzOwoKICAgICAgICAgICAgaWYgKCF0b3RhbFN0ZXBzKSB7CiAgICAgICAgICAgICAgICB0b3RhbFN0ZXBzID0gMTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy50b3RhbFN0ZXBzID0gdG90YWxTdGVwczsKCiAgICAgICAgICAgIHZhciBzdGVwQmluZGluZ3MgPSB0aGlzLndpemFyZENvbmZpZ3MuYmluZGluZ3M7CgogICAgICAgICAgICBpZiAoIXN0ZXBCaW5kaW5ncykgewogICAgICAgICAgICAgICAgc3RlcEJpbmRpbmdzID0ge307CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAodmFyIHByb3BlcnR5SWQgaW4gdGhpcy5jaGlsZHJlbkJ5UHJvcGVydHlJZCkgewogICAgICAgICAgICAgICAgaWYgKCFzdGVwQmluZGluZ3MuaGFzT3duUHJvcGVydHkocHJvcGVydHlJZCkpIHsKICAgICAgICAgICAgICAgICAgICBzdGVwQmluZGluZ3NbcHJvcGVydHlJZF0gPSAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRvdGFsU3RlcHM7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHN0ZXAgPSBpICsgMTsKICAgICAgICAgICAgICAgIHZhciB0bXBBcnJheSA9IFtdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgcHJvcGVydHlJZCBpbiBzdGVwQmluZGluZ3MpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RlcEJpbmRpbmdzW3Byb3BlcnR5SWRdID09IHN0ZXApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2hpbGRyZW5CeVByb3BlcnR5SWQgJiYgdGhpcy5jaGlsZHJlbkJ5UHJvcGVydHlJZFtwcm9wZXJ0eUlkXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wQXJyYXkucHVzaCgiIyIgKyB0aGlzLmNoaWxkcmVuQnlQcm9wZXJ0eUlkW3Byb3BlcnR5SWRdLmNvbnRhaW5lci5hdHRyKCdpZCcpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgc3RlcElkID0gJ3N0ZXAnICsgaTsKICAgICAgICAgICAgICAgIHZhciB3aXphcmRTdGVwVGVtcGxhdGVEZXNjcmlwdG9yID0gdGhpcy52aWV3LmdldFRlbXBsYXRlRGVzY3JpcHRvcigid2l6YXJkU3RlcCIpOwogICAgICAgICAgICAgICAgaWYgKHdpemFyZFN0ZXBUZW1wbGF0ZURlc2NyaXB0b3IpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgd2l6YXJkU3RlcEVsZW1lbnQgPSBfdGhpcy52aWV3LnRtcGwod2l6YXJkU3RlcFRlbXBsYXRlRGVzY3JpcHRvciwge30pOwogICAgICAgICAgICAgICAgICAgIHdpemFyZFN0ZXBFbGVtZW50LmF0dHIoImlkIiwgc3RlcElkKTsKICAgICAgICAgICAgICAgICAgICAkKHRtcEFycmF5LmpvaW4oJywnKSkud3JhcEFsbCh3aXphcmRTdGVwRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIG5hdkJhcklkID0gc3RlcElkICsgJy1uYXYtYmFyJzsKICAgICAgICAgICAgICAgIHZhciB3aXphcmROYXZCYXJUZW1wbGF0ZURlc2NyaXB0b3IgPSB0aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJ3aXphcmROYXZCYXIiKTsKICAgICAgICAgICAgICAgIGlmICh3aXphcmROYXZCYXJUZW1wbGF0ZURlc2NyaXB0b3IpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgd2l6YXJkTmF2QmFyRWxlbWVudCA9IF90aGlzLnZpZXcudG1wbCh3aXphcmROYXZCYXJUZW1wbGF0ZURlc2NyaXB0b3IsIHt9KTsKICAgICAgICAgICAgICAgICAgICB3aXphcmROYXZCYXJFbGVtZW50LmF0dHIoImlkIiwgbmF2QmFySWQpOwogICAgICAgICAgICAgICAgICAgIHdpemFyZE5hdkJhckVsZW1lbnQuYWRkQ2xhc3MoJ2FscGFjYS13aXphcmQtbmF2LWJhcicpOwogICAgICAgICAgICAgICAgICAgICQoJyMnICsgc3RlcElkLCB0aGlzLm91dGVyRWwpLmFwcGVuZCh3aXphcmROYXZCYXJFbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHdpemFyZFN0YXR1c0JhckVsZW1lbnQgPSB0aGlzLl9yZW5kZXJXaXphcmRTdGF0dXNCYXIodGhpcy53aXphcmRDb25maWdzLnN0ZXBUaXRsZXMpOwogICAgICAgICAgICBpZiAod2l6YXJkU3RhdHVzQmFyRWxlbWVudCkgewogICAgICAgICAgICAgICAgd2l6YXJkU3RhdHVzQmFyRWxlbWVudC5wcmVwZW5kVG8odGhpcy5maWVsZENvbnRhaW5lcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdG90YWxTdGVwczsgaSsrKSB7CgogICAgICAgICAgICAgICAgdmFyIHZGdW5jID0gZnVuY3Rpb24oc3RlcENvdW50LCBzdGVwQmluZGluZ3MpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbGlkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfdGhpcy52aWV3ICYmIF90aGlzLndpemFyZENvbmZpZ3MgJiYgX3RoaXMud2l6YXJkQ29uZmlncy52YWxpZGF0aW9uKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgYXV0by13aXphcmQsIHByb2Nlc3MgYmluZGluZ3Mgb25lIGF0IGEgdGltZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0ZXBCaW5kaW5ncykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQuZWFjaChzdGVwQmluZGluZ3MsIGZ1bmN0aW9uKHByb3BlcnR5SWQsIHN0ZXApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0ZXAgPT0gc3RlcENvdW50ICsgMSAmJiB2YWxpZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWQgPSBfdGhpcy5jaGlsZHJlbkJ5UHJvcGVydHlJZFtwcm9wZXJ0eUlkXS52YWxpZGF0ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY2hpbGRyZW5CeVByb3BlcnR5SWRbcHJvcGVydHlJZF0udmFsaWRhdGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsaWQ7CgogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9KGksIHN0ZXBCaW5kaW5ncyk7CgoKICAgICAgICAgICAgICAgIGlmIChpID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuX2NyZWF0ZU5leHRCdXR0b24oaSwgZmFsc2UsIHZGdW5jKTsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5fc2VsZWN0U3RlcChpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaSA9PSB0b3RhbFN0ZXBzIC0gMSkgewogICAgICAgICAgICAgICAgICAgICQoIiNzdGVwIiArIGkpLmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5fY3JlYXRlUHJldkJ1dHRvbihpLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuX2NyZWF0ZURvbmVCdXR0b24oaSwgdHJ1ZSwgdkZ1bmMpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkKCIjc3RlcCIgKyBpKS5oaWRlKCk7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuX2NyZWF0ZVByZXZCdXR0b24oaSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIF90aGlzLl9jcmVhdGVOZXh0QnV0dG9uKGksIGZhbHNlLCB2RnVuYyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZW5kZXJzIHdpemFyZCBzdGF0dXMgYmFyLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHN0ZXBUaXRsZXMgU3RlcCB0aXRsZXMuCiAgICAgICAgICovCiAgICAgICAgX3JlbmRlcldpemFyZFN0YXR1c0JhcjogZnVuY3Rpb24oc3RlcFRpdGxlcykgewoKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIHZhciB3aXphcmRTdGF0dXNCYXIgPSB0aGlzLndpemFyZENvbmZpZ3Muc3RhdHVzQmFyOwogICAgICAgICAgICBpZiAod2l6YXJkU3RhdHVzQmFyICYmIHN0ZXBUaXRsZXMpIHsKICAgICAgICAgICAgICAgIHZhciB3aXphcmRTdGF0dXNCYXJUZW1wbGF0ZURlc2NyaXB0b3IgPSB0aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJ3aXphcmRTdGF0dXNCYXIiKTsKICAgICAgICAgICAgICAgIGlmICh3aXphcmRTdGF0dXNCYXJUZW1wbGF0ZURlc2NyaXB0b3IpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgd2l6YXJkU3RhdHVzQmFyRWxlbWVudCA9IF90aGlzLnZpZXcudG1wbCh3aXphcmRTdGF0dXNCYXJUZW1wbGF0ZURlc2NyaXB0b3IsIHsKICAgICAgICAgICAgICAgICAgICAgICAgImlkIjogdGhpcy5nZXRJZCgpICsgIi13aXphcmQtc3RhdHVzLWJhciIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZXMiOiBzdGVwVGl0bGVzCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgd2l6YXJkU3RhdHVzQmFyRWxlbWVudC5hZGRDbGFzcygiYWxwYWNhLXdpemFyZC1zdGF0dXMtYmFyIik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRTdHlsZUluamVjdGlvbigid2l6YXJkU3RhdHVzQmFyIix3aXphcmRTdGF0dXNCYXJFbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2l6YXJkU3RhdHVzQmFyRWxlbWVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENyZWF0ZXMgYW4gInByZXYiIGJ1dHRvbi4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7SW50ZWdlcn0gaSBTdGVwIG51bWJlci4KICAgICAgICAgKiBAcGFyYW0gW2Jvb2xlYW5dIHdoZXRoZXIgdG8gYWRkIGEgY2xlYXIgZGl2IGF0IHRoZSBlbmQKICAgICAgICAgKiBAcGFyYW0gW3ZhbGlkYXRpb25GdW5jdGlvbl0gZnVuY3Rpb24gdGVzdCB3aGV0aGVyIHRoZSBidXR0b24gc2hvdWxkIGJlIGFsbG93ZWQgdG8gcHJvY2VlZAogICAgICAgICAqLwogICAgICAgIF9jcmVhdGVQcmV2QnV0dG9uOiBmdW5jdGlvbihpLCBjbGVhciwgdmFsaWRhdGlvbkZ1bmN0aW9uKSB7CgogICAgICAgICAgICAvLyBvbmx5IGFwcGx5IHZhbGlkYXRpb24gaWYgY29uZmlndXJlZCB0byBkbyBzbwogICAgICAgICAgICBpZiAodGhpcy53aXphcmRDb25maWdzLmJ1dHRvbnMgJiYgdGhpcy53aXphcmRDb25maWdzLmJ1dHRvbnMucHJldikgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLndpemFyZENvbmZpZ3MuYnV0dG9ucy5wcmV2LnZhbGlkYXRlT25DbGljaykgewogICAgICAgICAgICAgICAgICAgIHZhbGlkYXRpb25GdW5jdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBzdGVwTmFtZSA9ICJzdGVwIiArIGk7CiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICB2YXIgd2l6YXJkUHJlQnV0dG9uVGVtcGxhdGVEZXNjcmlwdG9yID0gdGhpcy52aWV3LmdldFRlbXBsYXRlRGVzY3JpcHRvcigid2l6YXJkUHJlQnV0dG9uIik7CiAgICAgICAgICAgIGlmICh3aXphcmRQcmVCdXR0b25UZW1wbGF0ZURlc2NyaXB0b3IpIHsKICAgICAgICAgICAgICAgIHZhciB3aXphcmRQcmVCdXR0b25FbGVtZW50ID0gX3RoaXMudmlldy50bXBsKHdpemFyZFByZUJ1dHRvblRlbXBsYXRlRGVzY3JpcHRvciwge30pOwogICAgICAgICAgICAgICAgd2l6YXJkUHJlQnV0dG9uRWxlbWVudC5hdHRyKCJpZCIsIHN0ZXBOYW1lICsgJy1idXR0b24tcHJlJyk7CiAgICAgICAgICAgICAgICB3aXphcmRQcmVCdXR0b25FbGVtZW50LmFkZENsYXNzKCJhbHBhY2Etd2l6YXJkLWJ1dHRvbi1wcmUiKTsKICAgICAgICAgICAgICAgIGlmIChfdGhpcy5idXR0b25CZWF1dGlmaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuYnV0dG9uQmVhdXRpZmllci5jYWxsKF90aGlzLCB3aXphcmRQcmVCdXR0b25FbGVtZW50LCB0aGlzLndpemFyZFByZUljb24sdHJ1ZSApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHdoZW4gdGhleSBjbGljayAicHJldiIsIHJ1biB2YWxpZGF0aW9uIGZ1bmN0aW9uIGZpcnN0IHRvIG1ha2Ugc3VyZSB0aGV5J3JlIGFsbG93ZWQgdG8gcHJvY2VlZAogICAgICAgICAgICAgICAgd2l6YXJkUHJlQnV0dG9uRWxlbWVudC5jbGljayhmdW5jdGlvbihzdGVwTmFtZSwgc3RlcENvdW50LCB2YWxpZGF0aW9uRnVuY3Rpb24pIHsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsaWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbGlkYXRpb25GdW5jdGlvbikKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWQgPSB2YWxpZGF0aW9uRnVuY3Rpb24oc3RlcE5hbWUsIHN0ZXBDb3VudCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWxpZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgiIyIgKyBzdGVwTmFtZSkuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgiI3N0ZXAiICsgKGkgLSAxKSkuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuX3NlbGVjdFN0ZXAoaSAtIDEpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IGZpcmUgY2xpY2sgaGFuZGxlcj8KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfdGhpcy53aXphcmRDb25maWdzLmJ1dHRvbnMucHJldiAmJiBfdGhpcy53aXphcmRDb25maWdzLmJ1dHRvbnMucHJldi5vbkNsaWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMud2l6YXJkQ29uZmlncy5idXR0b25zLnByZXYub25DbGljaygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0oc3RlcE5hbWUsIGksIHZhbGlkYXRpb25GdW5jdGlvbikpOwoKICAgICAgICAgICAgICAgICQoIiMiICsgc3RlcE5hbWUgKyAiLW5hdi1iYXIiKS5hcHBlbmQod2l6YXJkUHJlQnV0dG9uRWxlbWVudCk7CiAgICAgICAgICAgICAgICBpZiAoY2xlYXIpIHsKICAgICAgICAgICAgICAgICAgICAkKCIjIiArIHN0ZXBOYW1lICsgIi1uYXYtYmFyIikucGFyZW50KCkuYXBwZW5kKCI8ZGl2IHN0eWxlPSdjbGVhcjpib3RoJz48L2Rpdj4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBDcmVhdGVzIGEgIm5leHQiIGJ1dHRvbi4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7SW50ZWdlcn0gaSBTdGVwIG51bWJlci4KICAgICAgICAgKiBAcGFyYW0gW2Jvb2xlYW5dIHdoZXRoZXIgdG8gYWRkIGEgY2xlYXIgZGl2IGF0IHRoZSBlbmQKICAgICAgICAgKiBAcGFyYW0gW3ZhbGlkYXRpb25GdW5jdGlvbl0gZnVuY3Rpb24gdGVzdCB3aGV0aGVyIHRoZSBidXR0b24gc2hvdWxkIGJlIGFsbG93ZWQgdG8gcHJvY2VlZAogICAgICAgICAqLwogICAgICAgIF9jcmVhdGVOZXh0QnV0dG9uOiBmdW5jdGlvbihpLCBjbGVhciwgdmFsaWRhdGlvbkZ1bmN0aW9uKSB7CgogICAgICAgICAgICAvLyBvbmx5IGFwcGx5IHZhbGlkYXRpb24gaWYgY29uZmlndXJlZCB0byBkbyBzbwogICAgICAgICAgICBpZiAodGhpcy53aXphcmRDb25maWdzLmJ1dHRvbnMgJiYgdGhpcy53aXphcmRDb25maWdzLmJ1dHRvbnMubmV4dCkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLndpemFyZENvbmZpZ3MuYnV0dG9ucy5uZXh0LnZhbGlkYXRlT25DbGljaykgewogICAgICAgICAgICAgICAgICAgIHZhbGlkYXRpb25GdW5jdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBzdGVwTmFtZSA9ICJzdGVwIiArIGk7CiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICB2YXIgd2l6YXJkTmV4dEJ1dHRvblRlbXBsYXRlRGVzY3JpcHRvciA9IHRoaXMudmlldy5nZXRUZW1wbGF0ZURlc2NyaXB0b3IoIndpemFyZE5leHRCdXR0b24iKTsKICAgICAgICAgICAgaWYgKHdpemFyZE5leHRCdXR0b25UZW1wbGF0ZURlc2NyaXB0b3IpIHsKICAgICAgICAgICAgICAgIHZhciB3aXphcmROZXh0QnV0dG9uRWxlbWVudCA9IF90aGlzLnZpZXcudG1wbCh3aXphcmROZXh0QnV0dG9uVGVtcGxhdGVEZXNjcmlwdG9yLCB7fSk7CiAgICAgICAgICAgICAgICB3aXphcmROZXh0QnV0dG9uRWxlbWVudC5hdHRyKCJpZCIsIHN0ZXBOYW1lICsgJy1idXR0b24tbmV4dCcpOwogICAgICAgICAgICAgICAgd2l6YXJkTmV4dEJ1dHRvbkVsZW1lbnQuYWRkQ2xhc3MoImFscGFjYS13aXphcmQtYnV0dG9uLW5leHQiKTsKICAgICAgICAgICAgICAgIGlmIChfdGhpcy5idXR0b25CZWF1dGlmaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuYnV0dG9uQmVhdXRpZmllci5jYWxsKF90aGlzLCB3aXphcmROZXh0QnV0dG9uRWxlbWVudCwgdGhpcy53aXphcmROZXh0SWNvbix0cnVlICk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gd2hlbiB0aGV5IGNsaWNrICJuZXh0IiwgcnVuIHZhbGlkYXRpb24gZnVuY3Rpb24gZmlyc3QgdG8gbWFrZSBzdXJlIHRoZXkncmUgYWxsb3dlZCB0byBwcm9jZWVkCiAgICAgICAgICAgICAgICB3aXphcmROZXh0QnV0dG9uRWxlbWVudC5jbGljayhmdW5jdGlvbihzdGVwTmFtZSwgc3RlcENvdW50LCB2YWxpZGF0aW9uRnVuY3Rpb24pIHsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsaWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbGlkYXRpb25GdW5jdGlvbikKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWQgPSB2YWxpZGF0aW9uRnVuY3Rpb24oc3RlcE5hbWUsIHN0ZXBDb3VudCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWxpZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgiIyIgKyBzdGVwTmFtZSkuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgiI3N0ZXAiICsgKHN0ZXBDb3VudCArIDEpKS5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5fc2VsZWN0U3RlcChzdGVwQ291bnQgKyAxKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBmaXJlIGNsaWNrIGhhbmRsZXI/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoX3RoaXMud2l6YXJkQ29uZmlncy5idXR0b25zLm5leHQgJiYgX3RoaXMud2l6YXJkQ29uZmlncy5idXR0b25zLm5leHQub25DbGljaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLndpemFyZENvbmZpZ3MuYnV0dG9ucy5uZXh0Lm9uQ2xpY2soKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9KHN0ZXBOYW1lLCBpLCB2YWxpZGF0aW9uRnVuY3Rpb24pKTsKCiAgICAgICAgICAgICAgICAkKCIjIiArIHN0ZXBOYW1lICsgIi1uYXYtYmFyIikuYXBwZW5kKHdpemFyZE5leHRCdXR0b25FbGVtZW50KTsKICAgICAgICAgICAgICAgIGlmIChjbGVhcikgewogICAgICAgICAgICAgICAgICAgICQoIiMiICsgc3RlcE5hbWUgKyAiLW5hdi1iYXIiKS5wYXJlbnQoKS5hcHBlbmQoIjxkaXYgc3R5bGU9J2NsZWFyOmJvdGgnPjwvZGl2PiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ3JlYXRlcyBhICJkb25lIiBidXR0b24uCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0ludGVnZXJ9IGkgU3RlcCBudW1iZXIuCiAgICAgICAgICogQHBhcmFtIFtib29sZWFuXSB3aGV0aGVyIHRvIGFkZCBhIGNsZWFyIGRpdiBhdCB0aGUgZW5kCiAgICAgICAgICogQHBhcmFtIFt2YWxpZGF0aW9uRnVuY3Rpb25dIGZ1bmN0aW9uIHRlc3Qgd2hldGhlciB0aGUgYnV0dG9uIHNob3VsZCBiZSBhbGxvd2VkIHRvIHByb2NlZWQKICAgICAgICAgKi8KICAgICAgICBfY3JlYXRlRG9uZUJ1dHRvbjogZnVuY3Rpb24oaSwgY2xlYXIsIHZhbGlkYXRpb25GdW5jdGlvbikgewoKICAgICAgICAgICAgLy8gb25seSBhcHBseSB2YWxpZGF0aW9uIGlmIGNvbmZpZ3VyZWQgdG8gZG8gc28KICAgICAgICAgICAgaWYgKHRoaXMud2l6YXJkQ29uZmlncy5idXR0b25zICYmIHRoaXMud2l6YXJkQ29uZmlncy5idXR0b25zLmRvbmUpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy53aXphcmRDb25maWdzLmJ1dHRvbnMuZG9uZS52YWxpZGF0ZU9uQ2xpY2spIHsKICAgICAgICAgICAgICAgICAgICB2YWxpZGF0aW9uRnVuY3Rpb24gPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgc3RlcE5hbWUgPSAic3RlcCIgKyBpOwogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgdmFyIHdpemFyZERvbmVCdXR0b25UZW1wbGF0ZURlc2NyaXB0b3IgPSB0aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJ3aXphcmREb25lQnV0dG9uIik7CiAgICAgICAgICAgIGlmICh3aXphcmREb25lQnV0dG9uVGVtcGxhdGVEZXNjcmlwdG9yKSB7CiAgICAgICAgICAgICAgICB2YXIgd2l6YXJkRG9uZUJ1dHRvbkVsZW1lbnQgPSBfdGhpcy52aWV3LnRtcGwod2l6YXJkRG9uZUJ1dHRvblRlbXBsYXRlRGVzY3JpcHRvciwge30pOwogICAgICAgICAgICAgICAgd2l6YXJkRG9uZUJ1dHRvbkVsZW1lbnQuYXR0cigiaWQiLCBzdGVwTmFtZSArICctYnV0dG9uLWRvbmUnKTsKICAgICAgICAgICAgICAgIHdpemFyZERvbmVCdXR0b25FbGVtZW50LmFkZENsYXNzKCJhbHBhY2Etd2l6YXJkLWJ1dHRvbi1kb25lIik7CiAgICAgICAgICAgICAgICBpZiAoX3RoaXMuYnV0dG9uQmVhdXRpZmllcikgewogICAgICAgICAgICAgICAgICAgIF90aGlzLmJ1dHRvbkJlYXV0aWZpZXIuY2FsbChfdGhpcywgd2l6YXJkRG9uZUJ1dHRvbkVsZW1lbnQsIHRoaXMud2l6YXJkRG9uZUljb24sdHJ1ZSApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHdoZW4gdGhleSBjbGljayAiZG9uZSIsIHJ1biB2YWxpZGF0aW9uIGZ1bmN0aW9uIGZpcnN0IHRvIG1ha2Ugc3VyZSB0aGV5J3JlIGFsbG93ZWQgdG8gcHJvY2VlZAogICAgICAgICAgICAgICAgd2l6YXJkRG9uZUJ1dHRvbkVsZW1lbnQuY2xpY2soZnVuY3Rpb24oc3RlcE5hbWUsIHN0ZXBDb3VudCwgdmFsaWRhdGlvbkZ1bmN0aW9uKSB7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbGlkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWxpZGF0aW9uRnVuY3Rpb24pCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkID0gdmFsaWRhdGlvbkZ1bmN0aW9uKHN0ZXBOYW1lLCBzdGVwQ291bnQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoIiMiICsgc3RlcE5hbWUgKyAiLW5hdi1iYXIiKS5hcHBlbmQod2l6YXJkRG9uZUJ1dHRvbkVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNsZWFyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgiIyIgKyBzdGVwTmFtZSArICItbmF2LWJhciIpLnBhcmVudCgpLmFwcGVuZCgiPGRpdiBzdHlsZT0nY2xlYXI6Ym90aCc+PC9kaXY+Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogZmlyZSBjbGljayBoYW5kbGVyPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF90aGlzLndpemFyZENvbmZpZ3MuYnV0dG9ucy5kb25lICYmIF90aGlzLndpemFyZENvbmZpZ3MuYnV0dG9ucy5kb25lLm9uQ2xpY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy53aXphcmRDb25maWdzLmJ1dHRvbnMuZG9uZS5vbkNsaWNrKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfShzdGVwTmFtZSwgaSwgdmFsaWRhdGlvbkZ1bmN0aW9uKSk7CgogICAgICAgICAgICAgICAgJCgiIyIgKyBzdGVwTmFtZSArICItbmF2LWJhciIpLmFwcGVuZCh3aXphcmREb25lQnV0dG9uRWxlbWVudCk7CiAgICAgICAgICAgICAgICBpZiAoY2xlYXIpIHsKICAgICAgICAgICAgICAgICAgICAkKCIjIiArIHN0ZXBOYW1lICsgIi1uYXYtYmFyIikucGFyZW50KCkuYXBwZW5kKCI8ZGl2IHN0eWxlPSdjbGVhcjpib3RoJz48L2Rpdj4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBTZWxlY3RzIGEgd2l6YXJkIHN0ZXAuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0ludGVnZXJ9IGkgU3RlcCBudW1iZXIuCiAgICAgICAgICovCiAgICAgICAgX3NlbGVjdFN0ZXA6IGZ1bmN0aW9uKGkpIHsKICAgICAgICAgICAgdmFyIHVuQ3VycmVudFN0ZXBFbGVtID0gJCgiIyIgKyB0aGlzLmdldElkKCkgKyAiLXdpemFyZC1zdGF0dXMtYmFyIiArICIgbGkiKTsKICAgICAgICAgICAgdW5DdXJyZW50U3RlcEVsZW0ucmVtb3ZlQ2xhc3MoImN1cnJlbnQgY3VycmVudC1oYXMtbmV4dCIpOwogICAgICAgICAgICB0aGlzLmdldFN0eWxlSW5qZWN0aW9uKCJ3aXphcmRVbkN1cnJlbnRTdGVwIix1bkN1cnJlbnRTdGVwRWxlbSk7CiAgICAgICAgICAgIHZhciBjdXJyZW50U3RlcEVsZW0gPSAkKCIjc3RlcERlc2MiICsgaSk7CiAgICAgICAgICAgIGN1cnJlbnRTdGVwRWxlbS5hZGRDbGFzcygiY3VycmVudCIpOwogICAgICAgICAgICB0aGlzLmdldFN0eWxlSW5qZWN0aW9uKCJ3aXphcmRDdXJyZW50U3RlcCIsY3VycmVudFN0ZXBFbGVtKTsKICAgICAgICAgICAgaWYgKGkgPCB0aGlzLnRvdGFsU3RlcHMgLSAxKSB7CiAgICAgICAgICAgICAgICAkKCIjc3RlcERlc2MiICsgaSkuYWRkQ2xhc3MoImN1cnJlbnQtaGFzLW5leHQiKTsKICAgICAgICAgICAgfQogICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRhaW5lckZpZWxkI2dldFNjaGVtYU9mU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZTY2hlbWE6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcHJvcGVydGllcyA9IHsKICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiUHJvcGVydGllcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJMaXN0IG9mIGNoaWxkIHByb3BlcnRpZXMuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAib2JqZWN0IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgIm1heFByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm51bWJlciIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJNYXhpbXVtIE51bWJlciBQcm9wZXJ0aWVzIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlRoZSBtYXhpbXVtIG51bWJlciBvZiBwcm9wZXJ0aWVzIHRoYXQgdGhpcyBvYmplY3QgaXMgYWxsb3dlZCB0byBoYXZlIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgIm1pblByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm51bWJlciIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJNaW5pbXVtIE51bWJlciBvZiBQcm9wZXJ0aWVzIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlRoZSBtaW5pbXVtIG51bWJlciBvZiBwcm9wZXJ0aWVzIHRoYXQgdGhpcyBvYmplY3QgaXMgcmVxdWlyZWQgdG8gaGF2ZSIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgZmllbGRzUHJvcGVydGllcyA9IHByb3BlcnRpZXMucHJvcGVydGllcy5wcm9wZXJ0aWVzOwoKICAgICAgICAgICAgZmllbGRzUHJvcGVydGllcy5wcm9wZXJ0aWVzID0ge307CgogICAgICAgICAgICBpZiAodGhpcy5jaGlsZHJlbikgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHByb3BlcnR5SWQgPSB0aGlzLmNoaWxkcmVuW2ldLnByb3BlcnR5SWQ7CiAgICAgICAgICAgICAgICAgICAgZmllbGRzUHJvcGVydGllcy5wcm9wZXJ0aWVzW3Byb3BlcnR5SWRdID0gdGhpcy5jaGlsZHJlbltpXS5nZXRTY2hlbWFPZlNjaGVtYSgpOwogICAgICAgICAgICAgICAgICAgIGZpZWxkc1Byb3BlcnRpZXMucHJvcGVydGllc1twcm9wZXJ0eUlkXS50aXRsZSA9IHByb3BlcnR5SWQgKyAiIDo6ICIgKyBmaWVsZHNQcm9wZXJ0aWVzLnByb3BlcnRpZXNbcHJvcGVydHlJZF0udGl0bGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHByb3BlcnRpZXMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udGFpbmVyRmllbGQjZ2V0U2NoZW1hT2ZPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHNjaGVtYU9mT3B0aW9ucyA9IEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdmFyIHByb3BlcnRpZXMgPSB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRmllbGQgT3B0aW9ucyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJMaXN0IG9mIG9wdGlvbnMgZm9yIGNoaWxkIGZpZWxkcy4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJvYmplY3QiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIGZpZWxkc1Byb3BlcnRpZXMgPSBwcm9wZXJ0aWVzLnByb3BlcnRpZXMuZmllbGRzOwoKICAgICAgICAgICAgZmllbGRzUHJvcGVydGllcy5wcm9wZXJ0aWVzID0ge307CgogICAgICAgICAgICBpZiAodGhpcy5jaGlsZHJlbikgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHByb3BlcnR5SWQgPSB0aGlzLmNoaWxkcmVuW2ldLnByb3BlcnR5SWQ7CiAgICAgICAgICAgICAgICAgICAgZmllbGRzUHJvcGVydGllcy5wcm9wZXJ0aWVzW3Byb3BlcnR5SWRdID0gdGhpcy5jaGlsZHJlbltpXS5nZXRTY2hlbWFPZk9wdGlvbnMoKTsKICAgICAgICAgICAgICAgICAgICBmaWVsZHNQcm9wZXJ0aWVzLnByb3BlcnRpZXNbcHJvcGVydHlJZF0udGl0bGUgPSBwcm9wZXJ0eUlkICsgIiA6OiAiICsgZmllbGRzUHJvcGVydGllcy5wcm9wZXJ0aWVzW3Byb3BlcnR5SWRdLnRpdGxlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHNjaGVtYU9mT3B0aW9ucywgcHJvcGVydGllcyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZ2V0VGl0bGUKICAgICAgICAgKi8KICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiT2JqZWN0IEZpZWxkIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJPYmplY3QgZmllbGQgZm9yIGNvbnRhaW5pbmcgb3RoZXIgZmllbGRzIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0VHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAib2JqZWN0IjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRGaWVsZFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIm9iamVjdCI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCgogICAgfSk7CgogICAgLy8gQWRkaXRpb25hbCBSZWdpc3RyYXRpb25zCiAgICBBbHBhY2EucmVnaXN0ZXJNZXNzYWdlcyh7CiAgICAgICAgInRvb01hbnlQcm9wZXJ0aWVzIjogIlRoZSBtYXhpbXVtIG51bWJlciBvZiBwcm9wZXJ0aWVzICh7MH0pIGhhcyBiZWVuIGV4Y2VlZGVkLiIsCiAgICAgICAgInRvb0Zld1Byb3BlcnRpZXMiOiAiVGhlcmUgYXJlIG5vdCBlbm91Z2ggcHJvcGVydGllcyAoezB9IGFyZSByZXF1aXJlZCkiCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJGaWVsZENsYXNzKCJvYmplY3QiLCBBbHBhY2EuRmllbGRzLk9iamVjdEZpZWxkKTsKICAgIEFscGFjYS5yZWdpc3RlckRlZmF1bHRTY2hlbWFGaWVsZE1hcHBpbmcoIm9iamVjdCIsICJvYmplY3QiKTsKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5BbnlGaWVsZCA9IEFscGFjYS5Db250cm9sRmllbGQuZXh0ZW5kKAogICAgLyoqCiAgICAgKiBAbGVuZHMgQWxwYWNhLkZpZWxkcy5BbnlGaWVsZC5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5Db250cm9sRmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBCYXNpYyBmaWVsZCBjb250cm9sIGZvciBKU09OIHNjaGVtYSBhbnkgdHlwZS4gVGhpcyBjb250cm9sIHNob3VsZCBiZSB1c2VkIHdpdGggYWRkaXRpb25hbCBvcHRpb25zIHBhcmFtZXRlcgogICAgICAgICAqIGZvciBjb21ibyBmaWVsZHMuIFdpdGhvdXQgb3B0aW9ucyBwYXJhbWV0ZXIgaXQgd2lsbCBzaW1wbHkgcmVuZGVyIGEgdGV4dCBmaWVsZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjc2V0dXAKICAgICAgICAgKi8KICAgICAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgdGhpcy5jb250cm9sRmllbGRUZW1wbGF0ZURlc2NyaXB0b3IgPSB0aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJjb250cm9sRmllbGRBbnkiKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjcmVuZGVyRmllbGQKICAgICAgICAgKi8KICAgICAgICByZW5kZXJGaWVsZDogZnVuY3Rpb24ob25TdWNjZXNzKSB7CgogICAgICAgICAgICBpZiAodGhpcy5jb250cm9sRmllbGRUZW1wbGF0ZURlc2NyaXB0b3IpIHsKICAgICAgICAgICAgICAgIHRoaXMuZmllbGQgPSB0aGlzLnZpZXcudG1wbCh0aGlzLmNvbnRyb2xGaWVsZFRlbXBsYXRlRGVzY3JpcHRvciwgewogICAgICAgICAgICAgICAgICAgICJpZCI6IHRoaXMuZ2V0SWQoKSwKICAgICAgICAgICAgICAgICAgICAibmFtZSI6IHRoaXMubmFtZSwKICAgICAgICAgICAgICAgICAgICAib3B0aW9ucyI6IHRoaXMub3B0aW9ucwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLmluamVjdEZpZWxkKHRoaXMuZmllbGQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob25TdWNjZXNzKSB7CiAgICAgICAgICAgICAgICBvblN1Y2Nlc3MoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldFZhbHVlCiAgICAgICAgICovCiAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5maWVsZC52YWwoKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNzZXRWYWx1ZQogICAgICAgICAqLwogICAgICAgIHNldFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkodmFsdWUpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLnZhbCgiIik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLnZhbCh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gYmUgc3VyZSB0byBjYWxsIGludG8gYmFzZSBtZXRob2QKICAgICAgICAgICAgdGhpcy5iYXNlKHZhbHVlKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjaGFuZGxlVmFsaWRhdGUKICAgICAgICAgKi8KICAgICAgICBoYW5kbGVWYWxpZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBiYXNlU3RhdHVzID0gdGhpcy5iYXNlKCk7CiAgICAgICAgICAgIHJldHVybiBiYXNlU3RhdHVzOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2Rpc2FibGUKICAgICAgICAgKi8KICAgICAgICBkaXNhYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5maWVsZC5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZW5hYmxlCiAgICAgICAgICovCiAgICAgICAgZW5hYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5maWVsZC5kaXNhYmxlZCA9IGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2ZvY3VzCiAgICAgICAgICovCiAgICAgICAgZm9jdXM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmZpZWxkLmZvY3VzKCk7CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2dldFNjaGVtYU9mU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZTY2hlbWE6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjZ2V0T3B0aW9uc0ZvclNjaGVtYQogICAgICAgICAqLwogICAgICAgIGdldE9wdGlvbnNGb3JTY2hlbWE6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRyb2xGaWVsZCNnZXRTY2hlbWFPZk9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRTY2hlbWFPZk9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjZ2V0T3B0aW9uc0Zvck9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldFRpdGxlCiAgICAgICAgICovCiAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIkFueSBGaWVsZCI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZ2V0RGVzY3JpcHRpb24KICAgICAgICAgKi8KICAgICAgICBnZXREZXNjcmlwdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiQW55IGZpZWxkLiI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZ2V0VHlwZQogICAgICAgICAqLwogICAgICAgIGdldFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gImFueSI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZ2V0RmllbGRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJhbnkiOwogICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyVGVtcGxhdGUoImNvbnRyb2xGaWVsZEFueSIsICc8aW5wdXQgdHlwZT0idGV4dCIgaWQ9IiR7aWR9IiBzaXplPSI0MCIge3tpZiBvcHRpb25zLnJlYWRvbmx5fX1yZWFkb25seT0icmVhZG9ubHkie3svaWZ9fSB7e2lmIG5hbWV9fW5hbWU9IiR7bmFtZX0ie3svaWZ9fSB7e2VhY2goaSx2KSBvcHRpb25zLmRhdGF9fWRhdGEtJHtpfT0iJHt2fSJ7ey9lYWNofX0vPicpOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiYW55IiwgQWxwYWNhLkZpZWxkcy5BbnlGaWVsZCk7CiAgICBBbHBhY2EucmVnaXN0ZXJEZWZhdWx0U2NoZW1hRmllbGRNYXBwaW5nKCJhbnkiLCAiYW55Iik7Cn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuSGlkZGVuRmllbGQgPSBBbHBhY2EuQ29udHJvbEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuQ29udHJvbEZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkNvbnRyb2xGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIEJhc2ljIENvbnRyb2wgZm9yIEhpZGRlbiBmaWVsZAogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IGRhdGEgRmllbGQgZGF0YS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBGaWVsZCBvcHRpb25zLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBGaWVsZCB2aWV3LgogICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbm5lY3Rvcn0gY29ubmVjdG9yIEZpZWxkIGNvbm5lY3Rvci4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNzZXR1cAogICAgICAgICAqLwogICAgICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CgogICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5zaXplKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuc2l6ZSA9IDQwOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmNvbnRyb2xGaWVsZFRlbXBsYXRlRGVzY3JpcHRvciA9IHRoaXMudmlldy5nZXRUZW1wbGF0ZURlc2NyaXB0b3IoImNvbnRyb2xGaWVsZEhpZGRlbiIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRyb2xGaWVsZCNyZW5kZXJGaWVsZAogICAgICAgICAqLwogICAgICAgIHJlbmRlckZpZWxkOiBmdW5jdGlvbihvblN1Y2Nlc3MpIHsKCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICBpZiAodGhpcy5jb250cm9sRmllbGRUZW1wbGF0ZURlc2NyaXB0b3IpIHsKCiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkID0gX3RoaXMudmlldy50bXBsKHRoaXMuY29udHJvbEZpZWxkVGVtcGxhdGVEZXNjcmlwdG9yLCB7CiAgICAgICAgICAgICAgICAgICAgImlkIjogdGhpcy5nZXRJZCgpLAogICAgICAgICAgICAgICAgICAgICJuYW1lIjogdGhpcy5uYW1lLAogICAgICAgICAgICAgICAgICAgICJvcHRpb25zIjogdGhpcy5vcHRpb25zCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMuaW5qZWN0RmllbGQodGhpcy5maWVsZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvblN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIG9uU3VjY2VzcygpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI3Bvc3RSZW5kZXIKICAgICAgICAgKi8KICAgICAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbihjYWxsYmFjaykgewoKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgdGhpcy5iYXNlKGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgIGlmIChzZWxmLmZpZWxkQ29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5maWVsZENvbnRhaW5lci5hZGRDbGFzcygnYWxwYWNhLWNvbnRyb2xmaWVsZC1oaWRkZW4nKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZ2V0VmFsdWUKICAgICAgICAgKi8KICAgICAgICBnZXRWYWx1ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmZpZWxkLnZhbCgpOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjc2V0VmFsdWUKICAgICAgICAgKi8KICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgaWYgKEFscGFjYS5pc0VtcHR5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgdGhpcy5maWVsZC52YWwoIiIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5maWVsZC52YWwodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBiZSBzdXJlIHRvIGNhbGwgaW50byBiYXNlIG1ldGhvZAogICAgICAgICAgICB0aGlzLmJhc2UodmFsdWUpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldFRpdGxlCiAgICAgICAgICovCiAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIkhpZGRlbiI7CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJGaWVsZCBmb3IgYSBoaWRkZW4gSFRNTCBpbnB1dCI7CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0VHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAic3RyaW5nIjsKICAgICAgICB9LAoJCQogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiaGlkZGVuIjsKICAgICAgICB9Ly9fX0VORF9PRl9CVUlMREVSX0hFTFBFUlMKICAgICAgICAKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3RlclRlbXBsYXRlKCJjb250cm9sRmllbGRIaWRkZW4iLCAnPGlucHV0IHR5cGU9ImhpZGRlbiIgaWQ9IiR7aWR9IiB7e2lmIG5hbWV9fW5hbWU9IiR7bmFtZX0ie3svaWZ9fSB7e2VhY2goaSx2KSBvcHRpb25zLmRhdGF9fWRhdGEtJHtpfT0iJHt2fSJ7ey9lYWNofX0vPicpOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiaGlkZGVuIiwgQWxwYWNhLkZpZWxkcy5IaWRkZW5GaWVsZCk7Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKCXZhciBBbHBhY2EgPSAkLmFscGFjYTsKCglBbHBhY2EucmVnaXN0ZXJWaWV3ICh7CgkJImlkIjogIlZJRVdfQkFTRSIsCgkJIm1lc3NhZ2VzIjogewoJCQkiemhfQ04iOiB7CgkJCQlyZXF1aXJlZDogIiYjMjc0OTI7JiMyMjQ5NTsmIzI0NTE3OyYjMzkwMzU7IiwKCQkJCWludmFsaWQ6ICImIzI3NDkyOyYjMjI0OTU7JiMxOTk4MTsmIzIxNTEyOyYjMjY2ODQ7IiwKCQkJCW1vbnRoczogWyImIzE5OTY4OyYjMjYzNzY7IiwgIiYjMjAxMDg7JiMyNjM3NjsiLCAiJiMxOTk3NzsmIzI2Mzc2OyIsICImIzIyMjM1OyYjMjYzNzY7IiwgIiYjMjAxMTY7JiMyNjM3NjsiLCAiJiMyMDg0NTsmIzI2Mzc2OyIsICImIzE5OTcxOyYjMjYzNzY7IiwgIiYjMjA4NDM7JiMyNjM3NjsiLCAiJiMyMDA2MTsmIzI2Mzc2OyIsICImIzIxMzEzOyYjMjYzNzY7IiwgIiYjMjEzMTM7JiMxOTk2ODsmIzI2Mzc2OyIsICImIzIxMzEzOyYjMjAxMDg7JiMyNjM3NjsiXSwKCQkJCXRpbWVVbml0czogewoJCQkJCVNFQ09ORDogIiYjMzExODY7IiwKCQkJCQlNSU5VVEU6ICImIzIwOTk4OyIsCgkJCQkJSE9VUjogIiYjMjYxMDI7IiwKCQkJCQlEQVk6ICImIzI2MDg1OyIsCgkJCQkJTU9OVEg6ICImIzI2Mzc2OyIsCgkJCQkJWUVBUjogIiYjMjQxODA7IgoJCQkJfSwKCQkJCSJub3RPcHRpb25hbCI6ICImIzI3NDkyOyYjMjI0OTU7JiMzODc1MDsmIzIwMjE5OyYjMzY4NzM7IiwKCQkJCSJkaXNhbGxvd1ZhbHVlIjogIiYjMzg3NTA7JiMyNzg2MTsmIzM2NzU1OyYjMjA4Mzc7JiMyMTI1MzsmIzI1MzI0OyB7MH0uIiwKCQkJCSJpbnZhbGlkVmFsdWVPZkVudW0iOiAiJiMyMDgwMTsmIzM1NzY4OyYjMzY3NTU7JiMyMDgzNzsmIzIxMjUzOyYjMjUzMjQ7IHswfS4iLAoJCQkJIm5vdEVub3VnaEl0ZW1zIjogIiYjMjYzNjg7JiMyMzU2NzsmIzIwMDEwOyYjMjU5Njg7IHswfSIsCgkJCQkidG9vTWFueUl0ZW1zIjogIiYjMjYzNjg7JiMyMjgyMzsmIzIwMDEwOyYjMjU5Njg7IHswfSIsCgkJCQkidmFsdWVOb3RVbmlxdWUiOiAiJiMzNjc1NTsmIzIwODM3OyYjMjA1NDA7JiMxOTk4MTsmIzI5NDIwOyYjMjkzMDU7IiwKCQkJCSJub3RBbkFycmF5IjogIiYjMTk5ODE7JiMyNjE1OTsmIzI1OTY4OyYjMzI0NTI7IiwKCQkJCSJpbnZhbGlkRGF0ZSI6ICImIzI2MDg1OyYjMjYzOTk7JiMyNjY4NDsmIzI0MzM1OyYjMjIyNDA7JiMzNTgxMzsmIzI2MTU5OyB7MH0iLAoJCQkJImludmFsaWRFbWFpbCI6ICImIzIwMjM0OyYjMjI5Njk7JiMyMDc5OTsmIzI2Njg0OyYjMjQzMzU7JiMxOTk4MTsmIzIzNTQ1OywgZXg6IGluZm9AY2xvdWRjbXMuY29tIiwKCQkJCSJzdHJpbmdOb3RBbkludGVnZXIiOiAiJiMxOTk4MTsmIzI2MTU5OyYjMjU5NzI7JiMyNTk2ODsuIiwKCQkJCSJpbnZhbGlkSVB2NCI6ICImIzE5OTgxOyYjMjYxNTk7JiMyMTUxMjsmIzI3ODYxO0lQJiMyMjMyMDsmIzIyMzM2OywgZXg6IDE5Mi4xNjguMC4xIiwKCQkJCSJzdHJpbmdWYWx1ZVRvb1NtYWxsIjogIiYjMjYzNjg7JiMyMzU2NzsmIzIwNTQwOyYjMjYxNTk7IHswfSIsCgkJCQkic3RyaW5nVmFsdWVUb29MYXJnZSI6ICImIzI2MzY4OyYjMjI4MjM7JiMyMDU0MDsmIzI2MTU5OyB7MH0iLAoJCQkJInN0cmluZ1ZhbHVlVG9vU21hbGxFeGNsdXNpdmUiOiAiJiMyMDU0MDsmIzI0NTE3OyYjMzkwMzU7JiMyMjgyMzsmIzIwMTEwOyB7MH0iLAoJCQkJInN0cmluZ1ZhbHVlVG9vTGFyZ2VFeGNsdXNpdmUiOiAiJiMyMDU0MDsmIzI0NTE3OyYjMzkwMzU7JiMyMzU2NzsmIzIwMTEwOyB7MH0iLAoJCQkJInN0cmluZ0RpdmlzaWJsZUJ5IjogIiYjMjA1NDA7JiMyNDUxNzsmIzM5MDM1OyYjMzMwMjE7JiMzNDk4NzsgezB9ICYjMjU5NzI7JiMzODUwMDsiLAoJCQkJInN0cmluZ05vdEFOdW1iZXIiOiAiJiMxOTk4MTsmIzI2MTU5OyYjMjU5Njg7JiMyMzM4MzsuIiwKCQkJCSJpbnZhbGlkUGFzc3dvcmQiOiAiJiMzODc1MDsmIzI3ODYxOyYjMjM0OTQ7JiMzMDcyMTsiLAoJCQkJImludmFsaWRQaG9uZSI6ICImIzM4NzUwOyYjMjc4NjE7JiMzMDAwNTsmIzM1ODA1OyYjMjE0OTU7JiMzMDcyMTssIGV4OiAoMTIzKSA0NTYtOTk5OSIsCgkJCQkiaW52YWxpZFBhdHRlcm4iOiAiJiMyNzQ5MjsmIzIyNDk1OyYjMzkwMzU7JiMyNjM3NzsmIzI2Njg0OyYjMjQzMzU7IHswfSIsCgkJCQkic3RyaW5nVG9vU2hvcnQiOiAiJiMyNzQ5MjsmIzIyNDk1OyYjMzMyNjc7JiMyMzU2OTsmIzM4MjcxOyYjMjQyMzA7IHswfSIsCgkJCQkic3RyaW5nVG9vTG9uZyI6ICImIzI3NDkyOyYjMjI0OTU7JiMyNjM2ODsmIzIyODEwOyYjMzgyNzE7JiMyNDIzMDsgezB9IgoJCQkKCQkJfQogICAgICAgIH0KICAgIH0pOwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCgl2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgoJQWxwYWNhLnJlZ2lzdGVyVmlldyAoewoJCSJpZCI6ICJWSUVXX0JBU0UiLAoJCSJtZXNzYWdlcyI6IHsKCQkJImVzX0VTIjogewoJCQkJcmVxdWlyZWQ6ICJFc3RlIGNhbXBvIGVzIG9ibGlnYXRvcmlvIiwKCQkJCWludmFsaWQ6ICJFc3RlIGNhbXBvIGVzIGludsOhbGlkbyIsCgkJCQltb250aHM6IFsiRW5lcm8iLCAiRmVicmVybyIsICJNYXJ6byIsICJBYnJpbCIsICJNYXlvIiwgIkp1bmlvIiwgIkp1bGlvIiwgIkFnb3N0byIsICJTZXB0aWVtYnJlIiwgIk9jdHVicmUiLCAiTm92aWVtYnJlIiwgIkRpY2llbWJyZSJdLAoJCQkJdGltZVVuaXRzOiB7CgkJCQkJU0VDT05EOiAic2VndW5kb3MiLAoJCQkJCU1JTlVURTogIm1pbnV0b3MiLAoJCQkJCUhPVVI6ICJob3JhcyIsCgkJCQkJREFZOiAiZMOtYXMiLAoJCQkJCU1PTlRIOiAibWVzZXMiLAoJCQkJCVlFQVI6ICJhw7FvcyIKCQkJCX0sCgkJCQkibm90T3B0aW9uYWwiOiAiRXN0ZSBjYW1wbyBubyBlcyBvcGNpb25hbC4iLAoJCQkJImRpc2FsbG93VmFsdWUiOiAiezB9IHNvbiBsb3MgdmFsb3JlcyByZWNoYXphZG9zLiIsCgkJCQkiaW52YWxpZFZhbHVlT2ZFbnVtIjogIkVzdGUgY2FtcG8gZGViZSB0ZW5lciB1bm8gZGUgbG9zIHZhbG9yZXMgYWRlbnRybyB7MH0uIiwKCQkJCSJub3RFbm91Z2hJdGVtcyI6ICJFbCBuw7ptZXJvIG3DrW5pbW8gZGUgYXJ0w61jdWxvcyBlcyB7MH0iLAoJCQkJInRvb01hbnlJdGVtcyI6ICJFbCBuw7ptZXJvIG3DoXhpbW8gZGUgYXJ0w61jdWxvcyBlcyB7MH0iLAoJCQkJInZhbHVlTm90VW5pcXVlIjogIkxvcyB2YWxvcmVzIG5vIHNvbiDDum5pY29zIiwKCQkJCSJub3RBbkFycmF5IjogIkVzdGUgdmFsb3Igbm8gZXMgdW4gYXJzZW5hbCIsCgkJCQkiaW52YWxpZERhdGUiOiAiRmVjaGEgaW52w6FsaWRhIHBhcmEgZWwgZm9ybWF0byB7MH0iLAoJCQkJImludmFsaWRFbWFpbCI6ICJFbWFpbCBhZGRyZXNzIGludsOhbGlkbywgZXg6IGluZm9AY2xvdWRjbXMuY29tIiwKCQkJCSJzdHJpbmdOb3RBbkludGVnZXIiOiAiRXN0ZSB2YWxvciBubyBlcyB1biBuw7ptZXJvIGVudGVyby4iLAoJCQkJImludmFsaWRJUHY0IjogIkRpcmVjY2nDs24gaW52w6FsaWRhIElQdjQsIGV4OiAxOTIuMTY4LjAuMSIsCgkJCQkic3RyaW5nVmFsdWVUb29TbWFsbCI6ICJFbCB2YWxvciBtw61uaW1vIHBhcmEgZXN0ZSBjYW1wbyBlcyB7MH0iLAoJCQkJInN0cmluZ1ZhbHVlVG9vTGFyZ2UiOiAiRWwgdmFsb3IgbcOteGltbyBwYXJhIGVzdGUgY2FtcG8gZXMgezB9IiwKCQkJCSJzdHJpbmdWYWx1ZVRvb1NtYWxsRXhjbHVzaXZlIjogIkVsIHZhbG9yIGRlIGVzdGUgY2FtcG8gZGViZSBzZXIgbWF5b3IgcXVlIHswfSIsCgkJCQkic3RyaW5nVmFsdWVUb29MYXJnZUV4Y2x1c2l2ZSI6ICJFbCB2YWxvciBkZSBlc3RlIGNhbXBvIGRlYmUgc2VyIG1lbm9zIHF1ZSB7MH0iLAoJCQkJInN0cmluZ0RpdmlzaWJsZUJ5IjogIkVsIHZhbG9yIGRlYmUgc2VyIGRpdmlzaWJsZSBjZXJjYSB7MH0iLAoJCQkJInN0cmluZ05vdEFOdW1iZXIiOiAiRXN0ZSB2YWxvciBubyBlcyB1biBuw7ptZXJvLiIsCgkJCQkiaW52YWxpZFBhc3N3b3JkIjogIkNvbnRyYXNlw7FhIGludsOhbGlkYSIsCgkJCQkiaW52YWxpZFBob25lIjogIk7Dum1lcm8gZGUgdGVsw6lmb25vIGludsOhbGlkbywgZXg6ICgxMjMpIDQ1Ni05OTk5IiwKCQkJCSJpbnZhbGlkUGF0dGVybiI6ICJFc3RlIGNhbXBvIGRlYmUgdGVuZXIgcGF0csOzbiB7MH0iLAoJCQkJInN0cmluZ1Rvb1Nob3J0IjogIkVzdGUgY2FtcG8gZGViZSBjb250ZW5lciBwb3IgbG8gbWVub3MgezB9IG7Dum1lcm9zIG8gY2FyYWN0ZXJlcyIsCgkJCQkic3RyaW5nVG9vTG9uZyI6ICJFc3RlIGNhbXBvIGRlYmUgY29udGVuZXIgYSBsbyBtw6FzIHswfSBuw7ptZXJvcyBvIGNhcmFjdGVyZXMiCgkJCX0KICAgICAgICB9Cgl9KTsKCn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgoJdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKCUFscGFjYS5yZWdpc3RlclZpZXcgKHsKCQkiaWQiOiAiVklFV19CQVNFIiwKCQkibWVzc2FnZXMiOiB7CgkJCSJmcl9GUiI6IHsKCQkJCXJlcXVpcmVkOiAiQ2UgY2hhbXAgZXN0IHJlcXVpcyIsCgkJCQlpbnZhbGlkOiAiQ2UgY2hhbXAgZXN0IGludmFsaWRlIiwKCQkJCW1vbnRoczogWyJKYW52aWVyIiwgIkbDqXZyaWVyIiwgIk1hcnMiLCAiQXZyaWwiLCAiTWFpIiwgIkp1aW4iLCAiSnVpbGxldCIsICJBb8O7dCIsICJTZXB0ZW1icmUiLCAiT2N0b2JyZSIsICJOb3ZlbWJyZSIsICJEw6ljZW1icmUiXSwKCQkJCXRpbWVVbml0czogewoJCQkJCVNFQ09ORDogInNlY29uZGVzIiwKCQkJCQlNSU5VVEU6ICJtaW51dGVzIiwKCQkJCQlIT1VSOiAiaGV1cmVzIiwKCQkJCQlEQVk6ICJqb3VycyIsCgkJCQkJTU9OVEg6ICJtb2lzIiwKCQkJCQlZRUFSOiAiYW5uw6llcyIKCQkJCX0sCgkJCQkibm90T3B0aW9uYWwiOiAiQ2UgY2hhbXAgbidlc3QgcGFzIG9wdGlvbm5lbC4iLAoJCQkJImRpc2FsbG93VmFsdWUiOiAiezB9IHNvbnQgZGVzIHZhbGV1cnMgaW50ZXJkaXRlcy4iLAoJCQkJImludmFsaWRWYWx1ZU9mRW51bSI6ICJDZSBjaGFtcCBkb2l0IHByZW5kcmUgdW5lIGRlcyB2YWxldXJzIHN1aXZhbnRlcyA6IHswfS4iLAoJCQkJIm5vdEVub3VnaEl0ZW1zIjogIkxlIG5vbWJyZSBtaW5pbXVtIGQnw6lsw6ltZW50cyBlc3QgezB9IiwKCQkJCSJ0b29NYW55SXRlbXMiOiAiTGUgbm9tYnJlIG1heGltdW0gZCfDqWzDqW1lbnRzIGVzdCB7MH0iLAoJCQkJInZhbHVlTm90VW5pcXVlIjogIkxlcyB2YWxldXJzIHNvbnQgdW5pcXVlcyIsCgkJCQkibm90QW5BcnJheSI6ICJDZXR0ZSB2YWxldXIgbidlc3QgcGFzIHVuZSBsaXN0ZSIsCgkJCQkiaW52YWxpZERhdGUiOiAiQ2V0dGUgZGF0ZSBuZSBjb3JyZXNwb25kIHBhcyBhdSBmb3JtYXQgezB9IiwKCQkJCSJpbnZhbGlkRW1haWwiOiAiQWRyZXNzZSBkZSBjb3VycmllbCBpbnZhbGlkZSwgZXg6IGluZm9AY2xvdWRjbXMuY29tIiwKCQkJCSJzdHJpbmdOb3RBbkludGVnZXIiOiAiQ2V0dGUgdmFsZXVyIG4nZXN0IHBhcyB1biBub21icmUgZW50aWVyLiIsCgkJCQkiaW52YWxpZElQdjQiOiAiQWRyZXNzZSBJUHY0IGludmFsaWRlLCBleDogMTkyLjE2OC4wLjEiLAoJCQkJInN0cmluZ1ZhbHVlVG9vU21hbGwiOiAiTGEgdmFsZXVyIG1pbmltYWxlIHBvdXIgY2UgY2hhbXAgZXN0IHswfSIsCgkJCQkic3RyaW5nVmFsdWVUb29MYXJnZSI6ICJMYSB2YWxldXIgbWF4aW1hbGUgcG91ciBjZSBjaGFtcCBlc3QgezB9IiwKCQkJCSJzdHJpbmdWYWx1ZVRvb1NtYWxsRXhjbHVzaXZlIjogIkxhIHZhbGV1ciBkb2l0LcOqdHJlIHN1cMOpcmlldXJlIMOgIHswfSIsCgkJCQkic3RyaW5nVmFsdWVUb29MYXJnZUV4Y2x1c2l2ZSI6ICJMYSB2YWxldXIgZG9pdC3DqnRyZSBpbmbDqXJpZXVyZSDDoCB7MH0iLAoJCQkJInN0cmluZ0RpdmlzaWJsZUJ5IjogIkxhIHZhbGV1ciBkb2l0LcOqdHJlIGRpdmlzaWJsZSBwYXIgezB9IiwKCQkJCSJzdHJpbmdOb3RBTnVtYmVyIjogIkNldHRlIHZhbGV1ciBuJ2VzdCBwYXMgdW4gbm9tYnJlLiIsCgkJCQkiaW52YWxpZFBhc3N3b3JkIjogIk1vdCBkZSBwYXNzZSBpbnZhbGlkZSIsCgkJCQkiaW52YWxpZFBob25lIjogIk51bcOpcm8gZGUgdMOpbMOpcGhvbmUgaW52YWxpZGUsIGV4OiAoMTIzKSA0NTYtOTk5OSIsCgkJCQkiaW52YWxpZFBhdHRlcm4iOiAiQ2UgY2hhbXAgZG9pdCBjb3JyZXNwb25kcmUgYXUgbW90aWYgezB9IiwKICAgICAgICAgICAgICAgICJzdHJpbmdUb29TaG9ydCI6ICJDZSBjaGFtcCBkb2l0IGNvbnRlbmlyIGF1IG1vaW5zIHswfSBjYXJhY3TDqHJlcyIsCiAgICAgICAgICAgICAgICAic3RyaW5nVG9vTG9uZyI6ICJDZSBjaGFtcCBkb2l0IGNvbnRlbmlyIGF1IHBsdXMgezB9IGNhcmFjdMOocmVzIgogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKCXZhciBBbHBhY2EgPSAkLmFscGFjYTsKCglBbHBhY2EucmVnaXN0ZXJWaWV3ICh7CgkJImlkIjogIlZJRVdfQkFTRSIsCgkJIm1lc3NhZ2VzIjogewogICAgICAgICAgICAiZGVfQVQiOiB7CiAgICAgICAgICAgICAgICByZXF1aXJlZDogIkVpbmdhYmUgZXJmb3JkZXJsaWNoIiwKICAgICAgICAgICAgICAgIGludmFsaWQ6ICJFaW5nYWJlIGludmFsaWQiLAogICAgICAgICAgICAgICAgbW9udGhzOiBbIkrDpG5uZXIiLCAiRmVicnVhciIsICJNw6RyeiIsICJBcHJpbCIsICJNYWkiLCAiSnVuaSIsICJKdWxpIiwgIkF1Z3VzdCIsICJTZXB0ZW1iZXIiLCAiT2t0b2JlciIsICJOb3ZlbWJlciIsICJEZXplbWJlciJdLAogICAgICAgICAgICAgICAgdGltZVVuaXRzOiB7CiAgICAgICAgICAgICAgICAgICAgU0VDT05EOiAiU2VrdW5kZW4iLAogICAgICAgICAgICAgICAgICAgIE1JTlVURTogIk1pbnV0ZW4iLAogICAgICAgICAgICAgICAgICAgIEhPVVI6ICJTdHVuZGVuIiwKICAgICAgICAgICAgICAgICAgICBEQVk6ICJUYWdlIiwKICAgICAgICAgICAgICAgICAgICBNT05USDogIk1vbmF0ZSIsCiAgICAgICAgICAgICAgICAgICAgWUVBUjogIkphaHJlIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJub3RPcHRpb25hbCI6ICJEaWVzZXMgRmVsZCBpc3QgbmljaHQgb3B0aW9uYWwiLAogICAgICAgICAgICAgICAgImRpc2FsbG93VmFsdWUiOiAiRGllc2UgV2VydGUgc2luZCBuaWNodCBlcmxhdWJ0OiB7MH0iLAogICAgICAgICAgICAgICAgImludmFsaWRWYWx1ZU9mRW51bSI6ICJEaWVzZSBGZWxkIHNvbGx0ZSBlaW5lbiBkZXIgZm9sZ2VuZGVuIFdlcnRlIGVudGhhbHRlbjogezB9IiwKICAgICAgICAgICAgICAgICJub3RFbm91Z2hJdGVtcyI6ICJEaWUgTWluZGVzdGFuemFobCB2b24gRWxlbWVudGVuIGlzdCB7MH0iLAogICAgICAgICAgICAgICAgInRvb01hbnlJdGVtcyI6ICJEaWUgTWF4aW1hbGFuemFobCB2b24gRWxlbWVudGVuIGlzdCB7MH0iLAogICAgICAgICAgICAgICAgInZhbHVlTm90VW5pcXVlIjogIkRpZXNlIFdlcnRlIHNpbmQgbmljaHQgZWluZGV1dGlnIiwKICAgICAgICAgICAgICAgICJub3RBbkFycmF5IjogIktlaW5lIExpc3RlIHZvbiBXZXJ0ZW4iLAogICAgICAgICAgICAgICAgImludmFsaWREYXRlIjogIkZhbHNjaGVzIERhdHVtc2Zvcm1hdDogezB9IiwKICAgICAgICAgICAgICAgICJpbnZhbGlkRW1haWwiOiAiVW5nw7xsdGlnZSBlLU1haWwgQWRyZXNzZSwgei5CLjogaW5mb0BjbG91ZGNtcy5jb20iLAogICAgICAgICAgICAgICAgInN0cmluZ05vdEFuSW50ZWdlciI6ICJFaW5nYWJlIGlzdCBrZWluZSBHYW56IFphaGwuIiwKICAgICAgICAgICAgICAgICJpbnZhbGlkSVB2NCI6ICJVbmfDvGx0aWdlIElQdjQgQWRyZXNzZSwgei5CLjogMTkyLjE2OC4wLjEiLAogICAgICAgICAgICAgICAgInN0cmluZ1ZhbHVlVG9vU21hbGwiOiAiRGllIE1pbmRlc3RhbnphaGwgdm9uIFplaWNoZW4gaXN0IHswfSIsCiAgICAgICAgICAgICAgICAic3RyaW5nVmFsdWVUb29MYXJnZSI6ICJEaWUgTWF4aW1hbGFuemFobCB2b24gWmVpY2hlbiBpc3QgezB9IiwKICAgICAgICAgICAgICAgICJzdHJpbmdWYWx1ZVRvb1NtYWxsRXhjbHVzaXZlIjogIkRpZSBBbnphaGwgZGVyIFplaWNoZW4gbXVzcyBncsO2w59lciBzZWluIGFscyB7MH0iLAogICAgICAgICAgICAgICAgInN0cmluZ1ZhbHVlVG9vTGFyZ2VFeGNsdXNpdmUiOiAiRGllIEFuemFobCBkZXIgWmVpY2hlbiBtdXNzIGtsZWluZXIgc2VpbiBhbHMgezB9IiwKICAgICAgICAgICAgICAgICJzdHJpbmdEaXZpc2libGVCeSI6ICJEZXIgV2VydCBtdXNzIGR1cmNoIHswfSBkaXZpZGllcmJhciBzZWluIiwKICAgICAgICAgICAgICAgICJzdHJpbmdOb3RBTnVtYmVyIjogIkRpZSBFaW5nYWJlIGlzdCBrZWluZSBaYWhsIiwKICAgICAgICAgICAgICAgICJpbnZhbGlkUGFzc3dvcmQiOiAiVW5nw7xsdGlnZXMgUGFzc3dvcnQuIiwKICAgICAgICAgICAgICAgICJpbnZhbGlkUGhvbmUiOiAiVW5nw7xsdGlnZSBUZWxlZm9ubnVtbWVyLCB6LkIuOiAoMTIzKSA0NTYtOTk5OSIsCiAgICAgICAgICAgICAgICAiaW52YWxpZFBhdHRlcm4iOiAiRGllc2UgRmVsZCBzdGltbXQgbmljaHQgbWl0IGZvbGdlbmRlciBWb3JnYWJlIMO8YmVyZWluIHswfSIsCiAgICAgICAgICAgICAgICAic3RyaW5nVG9vU2hvcnQiOiAiRGllc2VzIEZlbGQgc29sbHRlIG1pbmRlc3RlbnMgezB9IFplaWNoZW4gZW50aGFsdGVuIiwKICAgICAgICAgICAgICAgICJzdHJpbmdUb29Mb25nIjogIkRpZXNlcyBGZWxkIHNvbGx0ZSBow7ZjaHN0ZW5zIHswfSBaZWljaGVuIGVudGhhbHRlbiIKICAgICAgICAgICAgfQoJCX0KCX0pOwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCgl2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgoJQWxwYWNhLnJlZ2lzdGVyVmlldyAoewoJCSJpZCI6ICJWSUVXX0JBU0UiLAoJCSJtZXNzYWdlcyI6IHsKICAgICAgICAgICAgInBsX1BMIjogewogICAgICAgICAgICAgICAgcmVxdWlyZWQ6ICJUbyBwb2xlIGplc3Qgd3ltYWdhbmUiLAogICAgICAgICAgICAgICAgaW52YWxpZDogIlRvIHBvbGUgamVzdCBuaWVwcmF3aWTFgm93ZSIsCiAgICAgICAgICAgICAgICBtb250aHM6IFsiU3R5Y3plxYQiLCAiTHV0eSIsICJNYXJ6ZWMiLCAiS3dpZWNpZcWEIiwgIk1haiIsICJDemVyd2llYyIsICJMaXBpZWMiLCAiU2llcnBpZcWEIiwgIldyemVzaWXFhCIsICJQYcW6ZHppZXJuaWsiLCAiTGlzdG9wYWQiLCAiR3J1ZHppZcWEIl0sCiAgICAgICAgICAgICAgICB0aW1lVW5pdHM6IHsKICAgICAgICAgICAgICAgICAgICBTRUNPTkQ6ICJzZWt1bmR5IiwKICAgICAgICAgICAgICAgICAgICBNSU5VVEU6ICJtaW51dHkiLAogICAgICAgICAgICAgICAgICAgIEhPVVI6ICJnb2R6aW55IiwKICAgICAgICAgICAgICAgICAgICBEQVk6ICJkbmkiLAogICAgICAgICAgICAgICAgICAgIE1PTlRIOiAibWllc2nEhWNlIiwKICAgICAgICAgICAgICAgICAgICBZRUFSOiAibGF0YSIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAibm90T3B0aW9uYWwiOiAiVG8gcG9sZSBuaWUgamVzdCBvcGNqb25hbG5lIiwKICAgICAgICAgICAgICAgICJkaXNhbGxvd1ZhbHVlIjogIlRhIHdhcnRvxZvEhyBuaWUgamVzdCBkb3p3b2xvbmE6IHswfSIsCiAgICAgICAgICAgICAgICAiaW52YWxpZFZhbHVlT2ZFbnVtIjogIlRvIHBvbGUgcG93aW5ubyB6YXdpZXJhxIcgamVkbsSFIHogbmFzdMSZcHVqxIVjeWNoIHdhcnRvxZtjaTogezB9IiwKICAgICAgICAgICAgICAgICJub3RFbm91Z2hJdGVtcyI6ICJNaW5pbWFsbmEgbGljemJhIGVsZW1lbnTDs3cgd3lub3NpIHswfSIsCiAgICAgICAgICAgICAgICAidG9vTWFueUl0ZW1zIjogIk1ha3N5bWFsbmEgbGljemJhIGVsZW1lbnTDs3cgd3lub3NpIHswfSIsCiAgICAgICAgICAgICAgICAidmFsdWVOb3RVbmlxdWUiOiAiVGUgd2FydG/Fm2NpIG5pZSBzxIUgdW5pa2FsbmUiLAogICAgICAgICAgICAgICAgIm5vdEFuQXJyYXkiOiAiVGEgd2FydG/Fm8SHIG5pZSBqZXN0IHRhYmxpY8SFIiwKICAgICAgICAgICAgICAgICJpbnZhbGlkRGF0ZSI6ICJOaWVwb3ByYXdueSBmb3JtYXQgZGF0eTogezB9IiwKICAgICAgICAgICAgICAgICJpbnZhbGlkRW1haWwiOiAiTmllcG9wcmF3bnkgYWRyZXMgZW1haWwsIG4ucC46IGluZm9AY2xvdWRjbXMuY29tIiwKICAgICAgICAgICAgICAgICJzdHJpbmdOb3RBbkludGVnZXIiOiAiVGEgd2FydG/Fm8SHIG5pZSBqZXN0IGxpY3pixIUgY2HFgmtvd2l0xIUiLAogICAgICAgICAgICAgICAgImludmFsaWRJUHY0IjogIk5pZXBvcHJhd255IGFkcmVzIElQdjQsIG4ucC46IDE5Mi4xNjguMC4xIiwKICAgICAgICAgICAgICAgICJzdHJpbmdWYWx1ZVRvb1NtYWxsIjogIk1pbmltYWxuYSB3YXJ0b8WbxIcgZGxhIHRlZ28gcG9sYSB3eW5vc2kgezB9IiwKICAgICAgICAgICAgICAgICJzdHJpbmdWYWx1ZVRvb0xhcmdlIjogIk1ha3N5bWFsbmEgd2FydG/Fm8SHIGRsYSB0ZWdvIHBvbGEgd3lub3NpIHswfSIsCiAgICAgICAgICAgICAgICAic3RyaW5nVmFsdWVUb29TbWFsbEV4Y2x1c2l2ZSI6ICJXYXJ0b8WbxIcgZGxhIHRlZ28gcG9sYSBtdXNpIGJ5xIcgd2nEmWtzemEgbmnFvCB7MH0iLAogICAgICAgICAgICAgICAgInN0cmluZ1ZhbHVlVG9vTGFyZ2VFeGNsdXNpdmUiOiAiV2FydG/Fm8SHIGRsYSB0ZWdvIHBvbGEgbXVzaSBiecSHIG1uaWVqc3phIG5pxbwgezB9IiwKICAgICAgICAgICAgICAgICJzdHJpbmdEaXZpc2libGVCeSI6ICJXYXJ0b8WbxIcgbXVzaSBiecSHIHBvZHppZWxuYSBwcnpleiB7MH0iLAogICAgICAgICAgICAgICAgInN0cmluZ05vdEFOdW1iZXIiOiAiV2FydG/Fm8SHIG5pZSBqZXN0IGxpY3pixIUiLAogICAgICAgICAgICAgICAgImludmFsaWRQYXNzd29yZCI6ICJOaWVwb3ByYXduZSBoYXPFgm8iLAogICAgICAgICAgICAgICAgImludmFsaWRQaG9uZSI6ICJOaWVwb3ByYXdueSBudW1lciB0ZWxlZm9udSwgbi5wLjogKDEyMykgNDU2LTk5OTkiLAogICAgICAgICAgICAgICAgImludmFsaWRQYXR0ZXJuIjogIlRvIHBvbGUgcG93aW5ubyBtaWXEhyBmb3JtYXQgezB9IiwKICAgICAgICAgICAgICAgICJzdHJpbmdUb29TaG9ydCI6ICJUbyBwb2xlIHBvd2lubm8gemF3aWVyYcSHIGNvIG5ham1uaWVqIHswfSB6bmFrw7N3IiwKICAgICAgICAgICAgICAgICJzdHJpbmdUb29Mb25nIjogIlRvIHBvbGUgcG93aW5ubyB6YXdpZXJhxIcgbmFqd3nFvGVqIHswfSB6bmFrw7N3IgogICAgICAgICAgICB9CgkJfQoJfSk7Cgp9KShqUXVlcnkpOy8qIQpBbHBhY2EgVmVyc2lvbiAxLjEuMwoKQ29weXJpZ2h0IDIwMTQgR2l0YW5hIFNvZnR3YXJlLCBJbmMuCgpMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsgCnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gCgpZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQgCglodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAgCgpVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlIApkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLCAKV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuIApTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIApsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gCgpGb3IgbW9yZSBpbmZvcm1hdGlvbiwgcGxlYXNlIGNvbnRhY3QgR2l0YW5hIFNvZnR3YXJlLCBJbmMuIGF0IHRoaXMKYWRkcmVzczoKCiAgaW5mb0BnaXRhbmFzb2Z0d2FyZS5jb20KKi8KKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5BZGRyZXNzRmllbGQgPSBBbHBhY2EuRmllbGRzLk9iamVjdEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuQWRkcmVzc0ZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkZpZWxkcy5PYmplY3RGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIEEgY29tYm8gZmllbGQgZm9yIHJlbmRlcmluZyBhIHN0YW5kYXJkIFVTIGFkZHJlc3MuIEl0IGFsc28gY29tZXMgdXAgd2l0aCBzdXBwb3J0IGZvciBHb29nbGUgTWFwCiAgICAgICAgICogd2hpY2ggd291bGQgcmVxdWlyZXMgaW5jbHVkaW5nIEdvb2dsZSBNYXAgSlMgZmlsZSBmb3IgdGhlIGZvcm0gdGhhdCB1c2VzIHRoaXMgY2xhc3MuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvcixlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5PYmplY3RGaWVsZCNzZXR1cAogICAgICAgICAqLwogICAgICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CgogICAgICAgICAgICB0aGlzLnNjaGVtYSA9IHsKICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJIb21lIEFkZHJlc3MiLAogICAgICAgICAgICAgICAgInR5cGUiOiAib2JqZWN0IiwKICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICJzdHJlZXQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJTdHJlZXQiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJhcnJheSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJpdGVtcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWF4TGVuZ3RoIjogMzAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWluSXRlbXMiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1heEl0ZW1zIjogMwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiY2l0eSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkNpdHkiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAic3RhdGUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJTdGF0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJlbnVtIjogWyJBTCIsICJBSyIsICJBUyIsICJBWiIsICJBUiIsICJDQSIsICJDTyIsICJDVCIsICJERSIsICJEQyIsICJGTSIsICJGTCIsICJHQSIsICJHVSIsICJISSIsICJJRCIsICJJTCIsICJJTiIsICJJQSIsICJLUyIsICJLWSIsICJMQSIsICJNRSIsICJNSCIsICJNRCIsICJNQSIsICJNSSIsICJNTiIsICJNUyIsICJNTyIsICJNVCIsICJORSIsICJOViIsICJOSCIsICJOSiIsICJOTSIsICJOWSIsICJOQyIsICJORCIsICJNUCIsICJPSCIsICJPSyIsICJPUiIsICJQVyIsICJQQSIsICJQUiIsICJSSSIsICJTQyIsICJTRCIsICJUTiIsICJUWCIsICJVVCIsICJWVCIsICJWSSIsICJWQSIsICJXQSIsICJXViIsICJXSSIsICJXWSJdCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiemlwIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiWmlwIENvZGUiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciLAogICAgICAgICAgICAgICAgICAgICAgICAicGF0dGVybiI6IC9eKFxkezV9KC1cZHs0fSk/KT8kLwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgQWxwYWNhLm1lcmdlKHRoaXMub3B0aW9ucywgewogICAgICAgICAgICAgICAgImZpZWxkcyI6IHsKICAgICAgICAgICAgICAgICAgICAiemlwIjogewogICAgICAgICAgICAgICAgICAgICAgICAibWFza1N0cmluZyI6ICI5OTk5OSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJzaXplIjogNQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInN0YXRlIjogewogICAgICAgICAgICAgICAgICAgICAgICAib3B0aW9uTGFiZWxzIjogWyJBTEFCQU1BIiwgIkFMQVNLQSIsICJBTUVSSUNBTlNBTU9BIiwgIkFSSVpPTkEiLCAiQVJLQU5TQVMiLCAiQ0FMSUZPUk5JQSIsICJDT0xPUkFETyIsICJDT05ORUNUSUNVVCIsICJERUxBV0FSRSIsICJESVNUUklDVE9GQ09MVU1CSUEiLCAiRkVERVJBVEVEU1RBVEVTT0ZNSUNST05FU0lBIiwgIkZMT1JJREEiLCAiR0VPUkdJQSIsICJHVUFNIiwgIkhBV0FJSSIsICJJREFITyIsICJJTExJTk9JUyIsICJJTkRJQU5BIiwgIklPV0EiLCAiS0FOU0FTIiwgIktFTlRVQ0tZIiwgIkxPVUlTSUFOQSIsICJNQUlORSIsICJNQVJTSEFMTElTTEFORFMiLCAiTUFSWUxBTkQiLCAiTUFTU0FDSFVTRVRUUyIsICJNSUNISUdBTiIsICJNSU5ORVNPVEEiLCAiTUlTU0lTU0lQUEkiLCAiTUlTU09VUkkiLCAiTU9OVEFOQSIsICJORUJSQVNLQSIsICJORVZBREEiLCAiTkVXSEFNUFNISVJFIiwgIk5FV0pFUlNFWSIsICJORVdNRVhJQ08iLCAiTkVXWU9SSyIsICJOT1JUSENBUk9MSU5BIiwgIk5PUlRIREFLT1RBIiwgIk5PUlRIRVJOTUFSSUFOQUlTTEFORFMiLCAiT0hJTyIsICJPS0xBSE9NQSIsICJPUkVHT04iLCAiUEFMQVUiLCAiUEVOTlNZTFZBTklBIiwgIlBVRVJUT1JJQ08iLCAiUkhPREVJU0xBTkQiLCAiU09VVEhDQVJPTElOQSIsICJTT1VUSERBS09UQSIsICJURU5ORVNTRUUiLCAiVEVYQVMiLCAiVVRBSCIsICJWRVJNT05UIiwgIlZJUkdJTklTTEFORFMiLCAiVklSR0lOSUEiLCAiV0FTSElOR1RPTiIsICJXRVNUVklSR0lOSUEiLCAiV0lTQ09OU0lOIiwgIldZT01JTkciXQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkodGhpcy5vcHRpb25zLmFkZHJlc3NWYWxpZGF0aW9uKSkgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmFkZHJlc3NWYWxpZGF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgYWRkcmVzcyBpbiBhIHNpbmdsZSBsaW5lIHN0cmluZy4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IEFkZHJlc3MgYXMgYSBzaW5nbGUgbGluZSBzdHJpbmcuCiAgICAgICAgICovCiAgICAgICAgZ2V0QWRkcmVzczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHRoaXMuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgaWYgKHRoaXMudmlldy50eXBlID09ICJ2aWV3IikgewogICAgICAgICAgICAgICAgdmFsdWUgPSB0aGlzLmRhdGE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFkZHJlc3MgPSAiIjsKICAgICAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUuc3RyZWV0KSB7CiAgICAgICAgICAgICAgICAgICAgJC5lYWNoKHZhbHVlLnN0cmVldCwgZnVuY3Rpb24oaW5kZXgsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZHJlc3MgKz0gdmFsdWUgKyAiICI7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodmFsdWUuY2l0eSkgewogICAgICAgICAgICAgICAgICAgIGFkZHJlc3MgKz0gdmFsdWUuY2l0eSArICIgIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh2YWx1ZS5zdGF0ZSkgewogICAgICAgICAgICAgICAgICAgIGFkZHJlc3MgKz0gdmFsdWUuc3RhdGUgKyAiICI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodmFsdWUuemlwKSB7CiAgICAgICAgICAgICAgICAgICAgYWRkcmVzcyArPSB2YWx1ZS56aXA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFkZHJlc3M7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjcmVuZGVyRmllbGQKICAgICAgICAgKi8KICAgICAgICByZW5kZXJGaWVsZDogZnVuY3Rpb24ob25TdWNjZXNzKSB7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgLy8gYXBwbHkgYWRkaXRpb25hbCBjc3MKICAgICAgICAgICAgICAgICQoc2VsZi5maWVsZENvbnRhaW5lcikuYWRkQ2xhc3MoImFscGFjYS1hZGRyZXNzZmllbGQiKTsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLmFkZHJlc3NWYWxpZGF0aW9uICYmICFzZWxmLmlzRGlzcGxheU9ubHkoKSkgewogICAgICAgICAgICAgICAgICAgICQoJzxkaXYgc3R5bGU9ImNsZWFyOmJvdGg7Ij48L2Rpdj4nKS5hcHBlbmRUbyhzZWxmLmZpZWxkQ29udGFpbmVyKTsKICAgICAgICAgICAgICAgICAgICB2YXIgbWFwQnV0dG9uID0gJCgnPGRpdiBjbGFzcz0iYWxwYWNhLWZvcm0tYnV0dG9uIj5Hb29nbGUgTWFwPC9kaXY+JykuYXBwZW5kVG8oc2VsZi5maWVsZENvbnRhaW5lcik7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hcEJ1dHRvbi5idXR0b24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWFwQnV0dG9uLmJ1dHRvbih7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiB0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBtYXBCdXR0b24uY2xpY2soCiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdvb2dsZSAmJiBnb29nbGUubWFwcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBnZW9jb2RlciA9IG5ldyBnb29nbGUubWFwcy5HZW9jb2RlcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhZGRyZXNzID0gc2VsZi5nZXRBZGRyZXNzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdlb2NvZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdlb2NvZGVyLmdlb2NvZGUoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2FkZHJlc3MnOiBhZGRyZXNzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKHJlc3VsdHMsIHN0YXR1cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXR1cyA9PSBnb29nbGUubWFwcy5HZW9jb2RlclN0YXR1cy5PSykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtYXBDYW52YXNJZCA9IHNlbGYuZ2V0SWQoKSArICItbWFwLWNhbnZhcyI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQoJyMnICsgbWFwQ2FudmFzSWQpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCI8ZGl2IGlkPSciICsgbWFwQ2FudmFzSWQgKyAiJyBjbGFzcz0nYWxwYWNhLWNvbnRyb2xmaWVsZC1hZGRyZXNzLW1hcGNhbnZhcyc+PC9kaXY+IikuYXBwZW5kVG8oc2VsZi5maWVsZENvbnRhaW5lcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtYXAgPSBuZXcgZ29vZ2xlLm1hcHMuTWFwKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHNlbGYuZ2V0SWQoKSArICItbWFwLWNhbnZhcyIpLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ6b29tIjogMTAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjZW50ZXIiOiByZXN1bHRzWzBdLmdlb21ldHJ5LmxvY2F0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWFwVHlwZUlkIjogZ29vZ2xlLm1hcHMuTWFwVHlwZUlkLlJPQURNQVAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbWFya2VyID0gbmV3IGdvb2dsZS5tYXBzLk1hcmtlcih7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcDogbWFwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogcmVzdWx0c1swXS5nZW9tZXRyeS5sb2NhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRpc3BsYXlNZXNzYWdlKCJHZW9jb2RpbmcgZmFpbGVkOiAiICsgc3RhdHVzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRpc3BsYXlNZXNzYWdlKCJHb29nbGUgTWFwIEFQSSBpcyBub3QgaW5zdGFsbGVkLiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KS53cmFwKCc8c21hbGwvPicpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLnNob3dNYXBPbkxvYWQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBtYXBCdXR0b24uY2xpY2soKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG9uU3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgIG9uU3VjY2VzcygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2lzQ29udGFpbmVyCiAgICAgICAgICovCiAgICAgICAgaXNDb250YWluZXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuT2JqZWN0RmllbGQjZ2V0U2NoZW1hT2ZPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgInZhbGlkYXRlQWRkcmVzcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkFkZHJlc3MgVmFsaWRhdGlvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJFbmFibGUgYWRkcmVzcyB2YWxpZGF0aW9uIGlmIHRydWUiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAic2hvd01hcE9uTG9hZCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIldoZXRoZXIgdG8gc2hvdyB0aGUgbWFwIHdoZW4gZmlyc3QgbG9hZGVkIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk9iamVjdEZpZWxkI2dldE9wdGlvbnNGb3JPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0Zvck9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICJ2YWxpZGF0ZUFkZHJlc3MiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJoZWxwZXIiOiAiQWRkcmVzcyB2YWxpZGF0aW9uIGlmIGNoZWNrZWQiLAogICAgICAgICAgICAgICAgICAgICAgICAicmlnaHRMYWJlbCI6ICJFbmFibGUgR29vZ2xlIE1hcCBmb3IgYWRkcmVzcyB2YWxpZGF0aW9uPyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuT2JqZWN0RmllbGQjZ2V0VGl0bGUKICAgICAgICAgKi8KICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiQWRkcmVzcyI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk9iamVjdEZpZWxkI2dldERlc2NyaXB0aW9uCiAgICAgICAgICovCiAgICAgICAgZ2V0RGVzY3JpcHRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIlN0YW5kYXJkIFVTIEFkZHJlc3Mgd2l0aCBTdHJlZXQsIENpdHksIFN0YXRlIGFuZCBaaXAuIEFsc28gY29tZXMgd2l0aCBzdXBwb3J0IGZvciBHb29nbGUgbWFwLiI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk9iamVjdEZpZWxkI2dldFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJhbnkiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5PYmplY3RGaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRGaWVsZFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gImFkZHJlc3MiOwogICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiYWRkcmVzcyIsIEFscGFjYS5GaWVsZHMuQWRkcmVzc0ZpZWxkKTsKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgcm91bmQgPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHN0cmF0ZWdpZXMgPSB7CiAgICAgICAgICAgIHVwOiAgICAgIE1hdGguY2VpbCwKICAgICAgICAgICAgZG93bjogICAgZnVuY3Rpb24oaW5wdXQpIHsgcmV0dXJuIH5+aW5wdXQ7IH0sCiAgICAgICAgICAgIG5lYXJlc3Q6IE1hdGgucm91bmQKICAgICAgICB9OwogICAgICAgIHJldHVybiBmdW5jdGlvbihzdHJhdGVneSkgewogICAgICAgICAgICByZXR1cm4gc3RyYXRlZ2llc1tzdHJhdGVneV07CiAgICAgICAgfTsKICAgIH0pKCk7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuQ3VycmVuY3lGaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuQ3VycmVuY3lGaWVsZC5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkCiAgICAgICAgICoKICAgICAgICAgKiBAY2xhc3MgQ3VycmVuY3kgQ29udHJvbAogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IGRhdGEgRmllbGQgZGF0YS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBGaWVsZCBvcHRpb25zLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBGaWVsZCB2aWV3LgogICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbm5lY3Rvcn0gY29ubmVjdG9yIEZpZWxkIGNvbm5lY3Rvci4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgICAgICAgICAgdmFyIHBmT3B0aW9uc1NjaGVtYSA9IHRoaXMuZ2V0U2NoZW1hT2ZQcmljZUZvcm1hdE9wdGlvbnMoKS5wcm9wZXJ0aWVzOwogICAgICAgICAgICBmb3IgKHZhciBpIGluIHBmT3B0aW9uc1NjaGVtYSkgewogICAgICAgICAgICAgICAgdmFyIG9wdGlvbiA9IHBmT3B0aW9uc1NjaGVtYVtpXTsKICAgICAgICAgICAgICAgIGlmICghKGkgaW4gb3B0aW9ucykpIHsKICAgICAgICAgICAgICAgICAgICBvcHRpb25zW2ldID0gb3B0aW9uWyJkZWZhdWx0Il0gfHwgdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBkYXRhID0gIiIgKyBwYXJzZUZsb2F0KGRhdGEpLnRvRml4ZWQob3B0aW9ucy5jZW50c0xpbWl0KTsKCiAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI3Bvc3RSZW5kZXIKICAgICAgICAgKi8KICAgICAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbihjYWxsYmFjaykgewoKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgdGhpcy5iYXNlKGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgICQoc2VsZi5maWVsZCkucHJpY2VGb3JtYXQoc2VsZi5vcHRpb25zKTsKCiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwoKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRWYWx1ZQogICAgICAgICAqLwogICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGZpZWxkID0gdGhpcy5maWVsZDsKICAgICAgICAgICAgdmFyIHZhbCAgID0gJChmaWVsZCkuaXMoJ2lucHV0JykgPyBmaWVsZC52YWwoKSA6IGZpZWxkLmhtdGwoKTsKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy51bm1hc2sgfHwgdGhpcy5vcHRpb25zLnJvdW5kICE9PSAibm9uZSIpIHsKICAgICAgICAgICAgICAgIHZhciB1bm1hc2tlZCA9IChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gJyc7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSBpbiB2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGN1ciA9IHZhbFtpXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc05hTihjdXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgKz0gY3VyOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGN1ciA9PT0gdGhpcy5vcHRpb25zLmNlbnRzU2VwYXJhdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgKz0gJy4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZUZsb2F0KHJlc3VsdCk7CiAgICAgICAgICAgICAgICB9KS5iaW5kKHRoaXMpKCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLnJvdW5kICE9PSAibm9uZSIpIHsKICAgICAgICAgICAgICAgICAgICB1bm1hc2tlZCA9IHJvdW5kKHRoaXMub3B0aW9ucy5yb3VuZCkodW5tYXNrZWQpOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5vcHRpb25zLnVubWFzaykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB1bm1hc2tlZFN0cmluZyA9ICIiICsgdW5tYXNrZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCB1ID0gMDsgaSA8IHZhbC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc05hTih2YWxbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2godW5tYXNrZWRTdHJpbmdbdSsrXSB8fCAwKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh2YWxbaV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQuam9pbignJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHVubWFza2VkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICAgICAgfQogICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoKICAgICAgICBnZXRTY2hlbWFPZlByaWNlRm9ybWF0T3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAiYWxsb3dOZWdhdGl2ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkFsbG93IE5lZ2F0aXZlIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkRldGVybWluZXMgaWYgbmVnYXRpdmUgbnVtYmVycyBhcmUgYWxsb3dlZC4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiBmYWxzZQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImNlbnRzTGltaXQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJDZW50cyBMaW1pdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJUaGUgbGltaXQgb2YgZnJhY3Rpb25hbCBkaWdpdHMuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibnVtYmVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiAyLAogICAgICAgICAgICAgICAgICAgICAgICAibWluaW11bSI6IDAKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJjZW50c1NlcGFyYXRvciI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkNlbnRzIFNlcGFyYXRvciIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJUaGUgc2VwYXJhdG9yIGJldHdlZW4gd2hvbGUgYW5kIGZyYWN0aW9uYWwgYW1vdW50cy4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiAiLiIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJjbGVhclByZWZpeCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkNsZWFyIFByZWZpeCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJEZXRlcm1pbmVzIGlmIHRoZSBwcmVmaXggaXMgY2xlYXJlZCBvbiBibHVyLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiY2xlYXJTdWZmaXgiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJDbGVhciBTdWZmaXgiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRGV0ZXJtaW5lcyBpZiB0aGUgc3VmZml4IGlzIGNsZWFyZWQgb24gYmx1ci4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiBmYWxzZQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImluc2VydFBsdXNTaWduIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiUGx1cyBTaWduIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkRldGVybWluZXMgaWYgYSBwbHVzIHNpZ24gc2hvdWxkIGJlIGluc2VydGVkIGZvciBwb3NpdGl2ZSB2YWx1ZXMuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogZmFsc2UKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJsaW1pdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkxpbWl0IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkEgbGltaXQgb2YgdGhlIGxlbmd0aCBvZiB0aGUgZmllbGQuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibnVtYmVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiB1bmRlZmluZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICJtaW5pbXVtIjogMAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInByZWZpeCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlByZWZpeCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJUaGUgcHJlZml4IGlmIGFueSBmb3IgdGhlIGZpZWxkLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRleHQiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6ICIkIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInJvdW5kIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiUm91bmQiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRGV0ZXJtaW5lcyBpZiB0aGUgZmllbGQgaXMgcm91bmRlZC4gKFJvdW5kaW5nIGlzIGRvbmUgd2hlbiBnZXRWYWx1ZSBpcyBjYWxsZWQgYW5kIGlzIG5vdCByZWZsZWN0ZWQgaW4gdGhlIFVJKSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJlbnVtIjogWyAidXAiLCAiZG93biIsICJuZWFyZXN0IiwgIm5vbmUiIF0sCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogIm5vbmUiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAic3VmZml4IjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiU3VmZml4IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlRoZSBzdWZmaXggaWYgYW55IGZvciB0aGUgZmllbGQuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogIiIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJ0aG91c2FuZHNTZXBhcmF0b3IiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJUaG91c2FuZHMgU2VwYXJhdG9yIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlRoZSBzZXBhcmF0b3IgYmV0d2VlbiB0aG91c2FuZHMuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiAiLCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJ1bm1hc2siOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJVbm1hc2siLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiSWYgdHJ1ZSB0aGVuIHRoZSByZXN1bHRpbmcgdmFsdWUgZm9yIHRoaXMgZmllbGQgd2lsbCBiZSB1bm1hc2tlZC4gIFRoYXQgaXMsIHRoZSByZXN1bHRpbmcgdmFsdWUgd2lsbCBiZSBhIGZsb2F0IGluc3RlYWQgb2YgYSBzdHJpbmcgKHdpdGggdGhlIHByZWZpeCwgc3VmZml4LCBldGMuIHJlbW92ZWQpLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IHRydWUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFNjaGVtYU9mT3B0aW9ucwogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHRoaXMuZ2V0U2NoZW1hT2ZQcmljZUZvcm1hdE9wdGlvbnMoKSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldE9wdGlvbnNGb3JPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0Zvck9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICJhbGxvd05lZ2F0aXZlIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJjZW50c0xpbWl0IjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJudW1iZXIiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiY2VudHNTZXBhcmF0b3IiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRleHQiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiY2xlYXJQcmVmaXgiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImNsZWFyU3VmZml4IjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJpbnNlcnRQbHVzU2lnbiI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiY2hlY2tib3giCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAibGltaXQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm51bWJlciIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJwcmVmaXgiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRleHQiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAicm91bmQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInNlbGVjdCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJzdWZmaXgiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRleHQiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAidGhvdXNhbmRzU2VwYXJhdG9yIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAidW5tYXNrIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0VGl0bGUKICAgICAgICAgKi8KICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiQ3VycmVuY3kgRmllbGQiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RGVzY3JpcHRpb24KICAgICAgICAgKi8KICAgICAgICBnZXREZXNjcmlwdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiUHJvdmlkZXMgYW4gYXV0b21hdGljYWxseSBmb3JtYXR0ZWQgYW5kIGNvbmZpZ3VyYWJsZSBpbnB1dCBmb3IgZW50ZXJpbmcgY3VycmVuY3kgYW1vdW50cy4iOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RmllbGRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJjdXJyZW5jeSI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJGaWVsZENsYXNzKCJjdXJyZW5jeSIsIEFscGFjYS5GaWVsZHMuQ3VycmVuY3lGaWVsZCk7Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLkRhdGVGaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuRGF0ZUZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBEYXRlIGNvbnRyb2wgZm9yIEpTT04gc2NoZW1hIGRhdGUgZm9ybWF0LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IGRhdGEgRmllbGQgZGF0YS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBGaWVsZCBvcHRpb25zLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBGaWVsZCB2aWV3LgogICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbm5lY3Rvcn0gY29ubmVjdG9yIEZpZWxkIGNvbm5lY3Rvci4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI3NldHVwCiAgICAgICAgICovCiAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CgogICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5kYXRlRm9ybWF0KSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuZGF0ZUZvcm1hdCA9IEFscGFjYS5kZWZhdWx0RGF0ZUZvcm1hdDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5kYXRlRm9ybWF0UmVnZXgpIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5kYXRlRm9ybWF0UmVnZXggPSBBbHBhY2EucmVnZXhwcy5kYXRlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZCAmJiAkLmRhdGVwaWNrZXIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRhdGVQaWNrZXJPcHRpb25zID0gc2VsZi5vcHRpb25zLmRhdGVwaWNrZXI7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFkYXRlUGlja2VyT3B0aW9ucykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGVQaWNrZXJPcHRpb25zID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgImNoYW5nZU1vbnRoIjogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjaGFuZ2VZZWFyIjogdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoIWRhdGVQaWNrZXJPcHRpb25zLmRhdGVGb3JtYXQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRlUGlja2VyT3B0aW9ucy5kYXRlRm9ybWF0ID0gc2VsZi5vcHRpb25zLmRhdGVGb3JtYXQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGQuZGF0ZXBpY2tlcihkYXRlUGlja2VyT3B0aW9ucyk7CgogICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLmZpZWxkQ29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtZGF0ZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwoKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjb25DaGFuZ2UKICAgICAgICAgKi8KICAgICAgICBvbkNoYW5nZTogZnVuY3Rpb24oZSkgewogICAgICAgICAgICB0aGlzLmJhc2UoKTsKICAgICAgICAgICAgdGhpcy5yZWZyZXNoVmFsaWRhdGlvblN0YXRlKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNoYW5kbGVWYWxpZGF0ZQogICAgICAgICAqLwogICAgICAgIGhhbmRsZVZhbGlkYXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGJhc2VTdGF0dXMgPSB0aGlzLmJhc2UoKTsKCiAgICAgICAgICAgIHZhciB2YWxJbmZvID0gdGhpcy52YWxpZGF0aW9uOwoKICAgICAgICAgICAgdmFyIHN0YXR1cyA9IHRoaXMuX3ZhbGlkYXRlRGF0ZUZvcm1hdCgpOwogICAgICAgICAgICB2YWxJbmZvWyJpbnZhbGlkRGF0ZSJdID0gewogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiBzdGF0dXMgPyAiIiA6IEFscGFjYS5zdWJzdGl0dXRlVG9rZW5zKHRoaXMudmlldy5nZXRNZXNzYWdlKCJpbnZhbGlkRGF0ZSIpLCBbdGhpcy5vcHRpb25zLmRhdGVGb3JtYXRdKSwKICAgICAgICAgICAgICAgICJzdGF0dXMiOiBzdGF0dXMKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBiYXNlU3RhdHVzICYmIHZhbEluZm9bImludmFsaWREYXRlIl1bInN0YXR1cyJdOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlcyBkYXRlIGZvcm1hdC4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZiBpdCBpcyBhIHZhbGlkIGRhdGUsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgKi8KICAgICAgICBfdmFsaWRhdGVEYXRlRm9ybWF0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5maWVsZC52YWwoKTsKCiAgICAgICAgICAgIGlmICgkLmRhdGVwaWNrZXIpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgJC5kYXRlcGlja2VyLnBhcnNlRGF0ZSh0aGlzLm9wdGlvbnMuZGF0ZUZvcm1hdCwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy92YWxpZGF0ZSB0aGUgZGF0ZSB3aXRob3V0IHRoZSBoZWxwIG9mIGRhdGVwaWNrZXIucGFyc2VEYXRlCiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUubWF0Y2godGhpcy5vcHRpb25zLmRhdGVGb3JtYXRSZWdleCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI3NldFZhbHVlCiAgICAgICAgICovCiAgICAgICAgc2V0VmFsdWU6IGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICAvLyBza2lwIG91dCBpZiBubyBkYXRlCiAgICAgICAgICAgIGlmICh2YWwgPT09ICIiKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJhc2UodmFsKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5iYXNlKHZhbCk7CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRTY2hlbWFPZlNjaGVtYQogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mU2NoZW1hOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgImZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJQcm9wZXJ0eSBkYXRhIGZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjoiZGF0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJlbnVtIiA6IFsiZGF0ZSJdLAogICAgICAgICAgICAgICAgICAgICAgICAicmVhZG9ubHkiOnRydWUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRPcHRpb25zRm9yU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0ZvclNjaGVtYTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgImZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRTY2hlbWFPZk9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRTY2hlbWFPZk9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAiZGF0ZUZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkRhdGUgRm9ybWF0IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkRhdGUgZm9ybWF0IiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiBBbHBhY2EuZGVmYXVsdERhdGVGb3JtYXQKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJkYXRlRm9ybWF0UmVnZXgiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJGb3JtYXQgUmVndWxhciBFeHByZXNzaW9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlJlZ3VsYXIgZXhwcmVzc2lvbiBmb3IgdmFsaWRhdGlvbiBkYXRlIGZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogQWxwYWNhLnJlZ2V4cHMuZGF0ZQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImRhdGVwaWNrZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJEYXRlIFBpY2tlciBvcHRpb25zIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIk9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gdG8gYmUgcGFzc2VkIHRvIGpRdWVyeSBVSSBEYXRlUGlja2VyIGNvbnRyb2wiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJhbnkiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0T3B0aW9uc0Zvck9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgImRhdGVGb3JtYXQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRleHQiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZGF0ZUZvcm1hdFJlZ2V4IjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImRhdGV0aW1lIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJhbnkiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFRpdGxlCiAgICAgICAgICovCiAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIkRhdGUgRmllbGQiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RGVzY3JpcHRpb24KICAgICAgICAgKi8KICAgICAgICBnZXREZXNjcmlwdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiRGF0ZSBGaWVsZC4iOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RmllbGRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJkYXRlIjsKICAgICAgICB9Ly9fX0VORF9PRl9CVUlMREVSX0hFTFBFUlMKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3Rlck1lc3NhZ2VzKHsKICAgICAgICAiaW52YWxpZERhdGUiOiAiSW52YWxpZCBkYXRlIGZvciBmb3JtYXQgezB9IgogICAgfSk7CiAgICBBbHBhY2EucmVnaXN0ZXJGaWVsZENsYXNzKCJkYXRlIiwgQWxwYWNhLkZpZWxkcy5EYXRlRmllbGQpOwogICAgQWxwYWNhLnJlZ2lzdGVyRGVmYXVsdEZvcm1hdEZpZWxkTWFwcGluZygiZGF0ZSIsICJkYXRlIik7Cn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuRGF0ZXRpbWVGaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkLmV4dGVuZCgKICAgICAgICAvKioKICAgICAgICAgKiBAbGVuZHMgQWxwYWNhLkZpZWxkcy5EYXRldGltZUZpZWxkLnByb3RvdHlwZQogICAgICAgICAqLwogICAgICAgIHsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuRmllbGRzLk9iamVjdEZpZWxkCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBjbGFzcyBBIGNvbWJvIGZpZWxkIGZvciByZW5kZXJpbmcgYSBzdGFuZGFyZCBVUyByYW5nZS4gSXQgYWxzbyBjb21lcyB1cCB3aXRoIHN1cHBvcnQgZm9yIEdvb2dsZSBNYXAKICAgICAgICAgICAgICogd2hpY2ggd291bGQgcmVxdWlyZXMgaW5jbHVkaW5nIEdvb2dsZSBNYXAgSlMgZmlsZSBmb3IgdGhlIGZvcm0gdGhhdCB1c2VzIHRoaXMgY2xhc3MuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBGaWVsZCBvcHRpb25zLgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbm5lY3Rvcn0gY29ubmVjdG9yIEZpZWxkIGNvbm5lY3Rvci4KICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNzZXR1cAogICAgICAgICAgICAgKi8KICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5PYmplY3RGaWVsZCNzZXR1cAogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGhpcy5iYXNlKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbihjYWxsYmFjaykgewoKICAgICAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLmZpZWxkKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGQuZGF0ZXRpbWVwaWNrZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGQuaG92ZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEkKHRoaXMpLmhhc0NsYXNzKCdoYXNEYXRlcGlja2VyJykpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0aW1lUGlja2VyT3B0aW9ucyA9IHNlbGYub3B0aW9ucy50aW1lcGlja2VyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRpbWVQaWNrZXJPcHRpb25zKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lUGlja2VyT3B0aW9ucyA9IHNlbGYub3B0aW9ucy50aW1lcGlja2VyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGltZVBpY2tlck9wdGlvbnMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVQaWNrZXJPcHRpb25zID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjaGFuZ2VZZWFyIjogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY2hhbmdlTW9udGgiOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykuZGF0ZXRpbWVwaWNrZXIodGltZVBpY2tlck9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLWRhdGV0aW1lJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICpAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI3NldFZhbHVlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNOdW1iZXIoKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IG5ldyBEYXRlKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gIltvYmplY3QgRGF0ZV0iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYmFzZSgodmFsdWUuZ2V0TW9udGgoKSArIDEpICsgIi8iICsgdmFsdWUuZ2V0RGF0ZSgpICsgIi8iICsgdmFsdWUuZ2V0RnVsbFllYXIoKSArICIgIiArIHZhbHVlLmdldEhvdXJzKCkgKyAiOiIgKyB2YWx1ZS5nZXRNaW51dGVzKCkpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYmFzZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJhc2UodmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0VmFsdWUKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmJhc2UoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBSZXR1cm5zIGZpZWxkIHZhbHVlIGluIGRhdGV0aW1lLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcmV0dXJucyB7RGF0ZX0gRmllbGQgdmFsdWUuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBnZXREYXRldGltZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZpZWxkLmRhdGV0aW1lcGlja2VyKCdnZXREYXRlJyk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2dldFNjaGVtYU9mT3B0aW9ucwogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZ2V0U2NoZW1hT2ZPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpbWVwaWNrZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiVGltZXBpY2tlciBvcHRpb25zIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJPcHRpb25zIHRoYXQgYXJlIHN1cHBvcnRlZCBieSB0aGUgPGEgaHJlZj0naHR0cDovL3RyZW50cmljaGFyZHNvbi5jb20vZXhhbXBsZXMvdGltZXBpY2tlci8nPmpRdWVyeSB0aW1lcGlja2VyIGFkZG9uPC9hPi4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYW55IgogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2dldE9wdGlvbnNGb3JPcHRpb25zCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAgICAgImZpZWxkcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpbWVwaWNrZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJhbnkiCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFRpdGxlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIkRhdGV0aW1lIEZpZWxkIjsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldERlc2NyaXB0aW9uCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBnZXREZXNjcmlwdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIkRhdGV0aW1lIEZpZWxkIGJhc2VkIG9uIFRyZW50IFJpY2hhcmRzb24ncyA8YSBocmVmPSdodHRwOi8vdHJlbnRyaWNoYXJkc29uLmNvbS9leGFtcGxlcy90aW1lcGlja2VyLyc+alF1ZXJ5IHRpbWVwaWNrZXIgYWRkb248L2E+LiI7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gImRhdGV0aW1lIjsKICAgICAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICAgICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiZGF0ZXRpbWUiLCBBbHBhY2EuRmllbGRzLkRhdGV0aW1lRmllbGQpOwoKICAgIC8vICJkYXRldGltZSIgaXMgbGVnYWN5IChwcmUgdjQgc2NoZW1hKQogICAgQWxwYWNhLnJlZ2lzdGVyRGVmYXVsdEZvcm1hdEZpZWxkTWFwcGluZygiZGF0ZXRpbWUiLCAiZGF0ZXRpbWUiKTsKCiAgICAvLyBvZmZpY2lhbCB2NCB1c2VzIGRhdGUtdGltZQogICAgQWxwYWNhLnJlZ2lzdGVyRGVmYXVsdEZvcm1hdEZpZWxkTWFwcGluZygiZGF0ZS10aW1lIiwgImRhdGV0aW1lIik7Cn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuRWRpdG9yRmllbGQgPSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZC5leHRlbmQoCiAgICAgICAgLyoqCiAgICAgICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuRWRpdG9yRmllbGQucHJvdG90eXBlCiAgICAgICAgICovCiAgICAgICAgewogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBjbGFzcyBUZXh0YXJlYSBjb250cm9sIGZvciBjaHVuayBvZiB0ZXh0LgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgICAgICogQHBhcmFtIHtBbnl9IGRhdGEgRmllbGQgZGF0YS4KICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBGaWVsZCB2aWV3LgogICAgICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjc2V0dXAKICAgICAgICAgICAgICovCiAgICAgICAgICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgICAgIHRoaXMuY29udHJvbEZpZWxkVGVtcGxhdGVEZXNjcmlwdG9yID0gdGhpcy52aWV3LmdldFRlbXBsYXRlRGVzY3JpcHRvcigiY29udHJvbEZpZWxkRWRpdG9yIik7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbihjYWxsYmFjaykgewoKICAgICAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLmZpZWxkQ29udGFpbmVyKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5maWVsZENvbnRhaW5lci5hZGRDbGFzcygnYWxwYWNhLWNvbnRyb2xmaWVsZC1lZGl0b3InKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNldCBmaWVsZCBjb250YWluZXIgcGFyZW50IHdpZHRoID0gMTAwJQogICAgICAgICAgICAgICAgICAgICAgICAkKHNlbGYuZmllbGRDb250YWluZXIpLnBhcmVudCgpLmNzcygid2lkdGgiLCAiMTAwJSIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQUNFIEhFSUdIVAogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYWNlSGVpZ2h0ID0gc2VsZi5vcHRpb25zLmFjZUhlaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjZUhlaWdodCkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJChzZWxmLmZpZWxkQ29udGFpbmVyKS5jc3MoImhlaWdodCIsIGFjZUhlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFDRSBXSURUSAogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYWNlV2lkdGggPSBzZWxmLm9wdGlvbnMuYWNlV2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYWNlV2lkdGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjZVdpZHRoID0gIjEwMCUiOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICQoc2VsZi5maWVsZENvbnRhaW5lcikuY3NzKCJ3aWR0aCIsIGFjZVdpZHRoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGxvY2F0ZSB3aGVyZSB3ZSB3aWxsIGluc2VydCB0aGUgZWRpdG9yCiAgICAgICAgICAgICAgICAgICAgdmFyIGVsID0gJChzZWxmLmZpZWxkQ29udGFpbmVyKS5maW5kKCIuY29udHJvbC1maWVsZC1lZGl0b3ItZWwiKVswXTsKCiAgICAgICAgICAgICAgICAgICAgLy8gYWNlIG11c3QgYmUgaW5jbHVkZWQgYWhlYWQgb2YgdGltZQogICAgICAgICAgICAgICAgICAgIGlmICghYWNlICYmIHdpbmRvdy5hY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWNlID0gd2luZG93LmFjZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICghYWNlKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgQWxwYWNhLmxvZ0Vycm9yKCJFZGl0b3IgRmllbGQgaXMgbWlzc2luZyB0aGUgJ2FjZScgQ2xvdWQgOSBFZGl0b3IiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5lZGl0b3IgPSBhY2UuZWRpdChlbCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGVtZQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYWNlVGhlbWUgPSBzZWxmLm9wdGlvbnMuYWNlVGhlbWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYWNlVGhlbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjZVRoZW1lID0gImFjZS90aGVtZS9jaHJvbWUiOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZWRpdG9yLnNldFRoZW1lKGFjZVRoZW1lKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG1vZGUKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFjZU1vZGUgPSBzZWxmLm9wdGlvbnMuYWNlTW9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFhY2VNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2VNb2RlID0gImFjZS9tb2RlL2pzb24iOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZWRpdG9yLmdldFNlc3Npb24oKS5zZXRNb2RlKGFjZU1vZGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5lZGl0b3IucmVuZGVyZXIuc2V0SFNjcm9sbEJhckFsd2F5c1Zpc2libGUoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAvL3RoaXMuZWRpdG9yLnJlbmRlcmVyLnNldFZTY3JvbGxCYXJBbHdheXNWaXNpYmxlKGZhbHNlKTsgLy8gbm90IGltcGxlbWVudGVkCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZWRpdG9yLnNldFNob3dQcmludE1hcmdpbihmYWxzZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBzZXQgZGF0YSBvbnRvIGVkaXRvcgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmVkaXRvci5zZXRWYWx1ZShzZWxmLmRhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmVkaXRvci5jbGVhclNlbGVjdGlvbigpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2xlYXIgdW5kbyBzZXNzaW9uCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZWRpdG9yLmdldFNlc3Npb24oKS5nZXRVbmRvTWFuYWdlcigpLnJlc2V0KCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBGSVQtQ09OVEVOVCB0aGUgaGVpZ2h0IG9mIHRoZSBlZGl0b3IgdG8gdGhlIGNvbnRlbnRzIGNvbnRhaW5lZCB3aXRoaW4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5hY2VGaXRDb250ZW50SGVpZ2h0KQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGVpZ2h0VXBkYXRlRnVuY3Rpb24gPSBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZpcnN0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYuZWRpdG9yLnJlbmRlcmVyLmxpbmVIZWlnaHQgPT09IDEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZWRpdG9yLnJlbmRlcmVyLmxpbmVIZWlnaHQgPSAxNjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTE1ODQwNjEvCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld0hlaWdodCA9IHNlbGYuZWRpdG9yLmdldFNlc3Npb24oKS5nZXRTY3JlZW5MZW5ndGgoKSAqIHNlbGYuZWRpdG9yLnJlbmRlcmVyLmxpbmVIZWlnaHQgKyBzZWxmLmVkaXRvci5yZW5kZXJlci5zY3JvbGxCYXIuZ2V0V2lkdGgoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJChzZWxmLmZpZWxkQ29udGFpbmVyKS5oZWlnaHQobmV3SGVpZ2h0LnRvU3RyaW5nKCkgKyAicHgiKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBjYWxsIGlzIHJlcXVpcmVkIGZvciB0aGUgZWRpdG9yIHRvIGZpeCBhbGwgb2YKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpdHMgaW5uZXIgc3RydWN0dXJlIGZvciBhZGFwdGluZyB0byBhIGNoYW5nZSBpbiBzaXplCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5lZGl0b3IucmVzaXplKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaXJzdCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5lZGl0b3IuY2xlYXJTZWxlY3Rpb24oKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgNSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTZXQgaW5pdGlhbCBzaXplIHRvIG1hdGNoIGluaXRpYWwgY29udGVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0VXBkYXRlRnVuY3Rpb24oKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXaGVuZXZlciBhIGNoYW5nZSBoYXBwZW5zIGluc2lkZSB0aGUgQUNFIGVkaXRvciwgdXBkYXRlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgc2l6ZSBhZ2FpbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5lZGl0b3IuZ2V0U2Vzc2lvbigpLm9uKCdjaGFuZ2UnLCBoZWlnaHRVcGRhdGVGdW5jdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJFQURPTkxZCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLnNjaGVtYS5yZWFkb25seSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5lZGl0b3Iuc2V0UmVhZE9ubHkodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoZSBlZGl0b3IncyBkb20gZWxlbWVudCBnZXRzIGRlc3Ryb3llZCwgbWFrZSBzdXJlIHdlIGNsZWFuIHVwIHRoZSBlZGl0b3IgaW5zdGFuY2UKICAgICAgICAgICAgICAgICAgICAgICAgLy8gbm9ybWFsbHksIHdlIGV4cGVjdCBBbHBhY2EgZmllbGRzIHRvIGJlIGRlc3Ryb3llZCBieSB0aGUgZGVzdHJveSgpIG1ldGhvZCBidXQgdGhleSBtYXkgYWxzbyBiZQogICAgICAgICAgICAgICAgICAgICAgICAvLyBjbGVhbmVkLXVwIHZpYSB0aGUgRE9NLCB0aHVzIHdlIGNoZWNrIGhlcmUuCiAgICAgICAgICAgICAgICAgICAgICAgICQoZWwpLmJpbmQoJ2Rlc3Ryb3llZCcsIGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLmVkaXRvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZWRpdG9yLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmVkaXRvciA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNkZXN0cm95CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAvLyBkZXN0cm95IHRoZSBlZGl0b3IgaW5zdGFuY2UKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVkaXRvcikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lZGl0b3IgPSBudWxsOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGNhbGwgdXAgdG8gYmFzZSBtZXRob2QKICAgICAgICAgICAgICAgIHRoaXMuYmFzZSgpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEByZXR1cm4gdGhlIEFDRSBlZGl0b3IgaW5zdGFuY2UKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldEVkaXRvcjogZnVuY3Rpb24oKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lZGl0b3I7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2hhbmRsZVZhbGlkYXRlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBoYW5kbGVWYWxpZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgYmFzZVN0YXR1cyA9IHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgICAgIHZhciB2YWxJbmZvID0gdGhpcy52YWxpZGF0aW9uOwoKICAgICAgICAgICAgICAgIHZhciB3b3JkQ291bnRTdGF0dXMgPSAgdGhpcy5fdmFsaWRhdGVXb3JkQ291bnQoKTsKICAgICAgICAgICAgICAgIHZhbEluZm9bIndvcmRMaW1pdEV4Y2VlZGVkIl0gPSB7CiAgICAgICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiB3b3JkQ291bnRTdGF0dXMgPyAiIiA6IEFscGFjYS5zdWJzdGl0dXRlVG9rZW5zKHRoaXMudmlldy5nZXRNZXNzYWdlKCJ3b3JkTGltaXRFeGNlZWRlZCIpLCBbdGhpcy5vcHRpb25zLndvcmRsaW1pdF0pLAogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiB3b3JkQ291bnRTdGF0dXMKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgdmFyIGVkaXRvckFubm90YXRpb25zU3RhdHVzID0gdGhpcy5fdmFsaWRhdGVFZGl0b3JBbm5vdGF0aW9ucygpOwogICAgICAgICAgICAgICAgdmFsSW5mb1siZWRpdG9yQW5ub3RhdGlvbnNFeGlzdCJdID0gewogICAgICAgICAgICAgICAgICAgICJtZXNzYWdlIjogZWRpdG9yQW5ub3RhdGlvbnNTdGF0dXMgPyAiIiA6IHRoaXMudmlldy5nZXRNZXNzYWdlKCJlZGl0b3JBbm5vdGF0aW9uc0V4aXN0IiksCiAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6IGVkaXRvckFubm90YXRpb25zU3RhdHVzCiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIHJldHVybiBiYXNlU3RhdHVzICYmIHZhbEluZm9bIndvcmRMaW1pdEV4Y2VlZGVkIl1bInN0YXR1cyJdICYmIHZhbEluZm9bImVkaXRvckFubm90YXRpb25zRXhpc3QiXVsic3RhdHVzIl07CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBfdmFsaWRhdGVFZGl0b3JBbm5vdGF0aW9uczogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuZWRpdG9yKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBhbm5vdGF0aW9ucyA9IHRoaXMuZWRpdG9yLmdldFNlc3Npb24oKS5nZXRBbm5vdGF0aW9ucygpOwogICAgICAgICAgICAgICAgICAgIGlmIChhbm5vdGF0aW9ucyAmJiBhbm5vdGF0aW9ucy5sZW5ndGggPiAwKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBWYWxpZGF0ZSBmb3Igd29yZCBsaW1pdC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgdGhlIG51bWJlciBvZiB3b3JkcyBpcyBlcXVhbCB0byBvciBsZXNzIHRoYW4gdGhlIHdvcmQgbGltaXQuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBfdmFsaWRhdGVXb3JkQ291bnQ6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMud29yZGxpbWl0ICYmIHRoaXMub3B0aW9ucy53b3JkbGltaXQgPiAtMSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsID0gdGhpcy5lZGl0b3IuZ2V0VmFsdWUoKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB3b3JkY291bnQgPSB2YWwuc3BsaXQoIiAiKS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3b3JkY291bnQgPiB0aGlzLm9wdGlvbnMud29yZGxpbWl0KQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogRm9yY2UgZWRpdG9yIHRvIHJlc2l6ZSB0byBlbnN1cmUgaXQgZ2V0cyBkcmF3biBjb3JyZWN0bHkuCiAgICAgICAgICAgICAqIEBvdmVycmlkZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgb25EZXBlbmRlbnRSZXZlYWw6IGZ1bmN0aW9uKCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZWRpdG9yKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZWRpdG9yLnJlc2l6ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNzZXRWYWx1ZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc2V0VmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CgogICAgICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVkaXRvcikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5zZXRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gYmUgc3VyZSB0byBjYWxsIGludG8gYmFzZSBtZXRob2QKICAgICAgICAgICAgICAgIHRoaXMuYmFzZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRWYWx1ZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IG51bGw7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuZWRpdG9yKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdGhpcy5lZGl0b3IuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0U2NoZW1hT2ZPcHRpb25zCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBnZXRTY2hlbWFPZk9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICAgICAiYWNlVGhlbWUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiQUNFIEVkaXRvciBUaGVtZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiU3BlY2lmaWVzIHRoZSB0aGVtZSB0byBzZXQgb250byB0aGUgZWRpdG9yIGluc3RhbmNlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6ICJhY2UvdGhlbWUvdHdpbGlnaHQiCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICJhY2VNb2RlIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkFDRSBFZGl0b3IgTW9kZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiU3BlY2lmaWVzIHRoZSBtb2RlIHRvIHNldCBvbnRvIHRoZSBlZGl0b3IgaW5zdGFuY2UiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogImFjZS9tb2RlL2phdmFzY3JpcHQiCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICJhY2VXaWR0aCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJBQ0UgRWRpdG9yIEhlaWdodCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiU3BlY2lmaWVzIHRoZSB3aWR0aCBvZiB0aGUgd3JhcHBpbmcgZGl2IGFyb3VuZCB0aGUgZWRpdG9yIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6ICIxMDAlIgogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAiYWNlSGVpZ2h0IjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkFDRSBFZGl0b3IgSGVpZ2h0IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJTcGVjaWZpZXMgdGhlIGhlaWdodCBvZiB0aGUgd3JhcHBpbmcgZGl2IGFyb3VuZCB0aGUgZWRpdG9yIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6ICIzMDBweCIKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgImFjZUZpdENvbnRlbnRIZWlnaHQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiQUNFIEZpdCBDb250ZW50IEhlaWdodCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiQ29uZmlndXJlcyB0aGUgQUNFIEVkaXRvciB0byBhdXRvLWZpdCBpdHMgaGVpZ2h0IHRvIHRoZSBjb250ZW50cyBvZiB0aGUgZWRpdG9yIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiBmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAid29yZGxpbWl0IjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIldvcmQgTGltaXQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkxpbWl0cyB0aGUgbnVtYmVyIG9mIHdvcmRzIGFsbG93ZWQgaW4gdGhlIHRleHQgYXJlYS4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibnVtYmVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogLTEKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0T3B0aW9uc0Zvck9wdGlvbnMKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldE9wdGlvbnNGb3JPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICAgICAiYWNlVGhlbWUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAiYWNlTW9kZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRleHQiCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICJ3b3JkbGltaXQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRUaXRsZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuICJFZGl0b3IiOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RGVzY3JpcHRpb24KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiRWRpdG9yIjsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiZWRpdG9yIjsKICAgICAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCgogICAgICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3Rlck1lc3NhZ2VzKHsKICAgICAgICAid29yZExpbWl0RXhjZWVkZWQiOiAiVGhlIG1heGltdW0gd29yZCBsaW1pdCBvZiB7MH0gaGFzIGJlZW4gZXhjZWVkZWQuIiwKICAgICAgICAiZWRpdG9yQW5ub3RhdGlvbnNFeGlzdCI6ICJUaGUgZWRpdG9yIGhhcyBlcnJvcnMgaW4gaXQgdGhhdCBtdXN0IGJlIGNvcnJlY3RlZCIKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3RlclRlbXBsYXRlKCJjb250cm9sRmllbGRFZGl0b3IiLCAnPGRpdiBpZD0iJHtpZH0iIGNsYXNzPSJjb250cm9sLWZpZWxkLWVkaXRvci1lbCI+PC9kaXY+Jyk7CiAgICBBbHBhY2EucmVnaXN0ZXJGaWVsZENsYXNzKCJlZGl0b3IiLCBBbHBhY2EuRmllbGRzLkVkaXRvckZpZWxkKTsKCn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuRW1haWxGaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuRW1haWxGaWVsZC5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkCiAgICAgICAgICoKICAgICAgICAgKiBAY2xhc3MgQ29udHJvbCBmb3IgSlNPTiBzY2hlbWEgZW1haWwgZm9ybWF0LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IGRhdGEgRmllbGQgZGF0YS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBGaWVsZCBvcHRpb25zLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBGaWVsZCB2aWV3LgogICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbm5lY3Rvcn0gY29ubmVjdG9yIEZpZWxkIGNvbm5lY3Rvci4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI3NldHVwCiAgICAgICAgICovCiAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmJhc2UoKTsKCiAgICAgICAgICAgIGlmICghdGhpcy5zY2hlbWEucGF0dGVybikgewogICAgICAgICAgICAgICAgdGhpcy5zY2hlbWEucGF0dGVybiA9IEFscGFjYS5yZWdleHBzLmVtYWlsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtZW1haWwnKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwoKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNoYW5kbGVWYWxpZGF0ZQogICAgICAgICAqLwogICAgICAgIGhhbmRsZVZhbGlkYXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGJhc2VTdGF0dXMgPSB0aGlzLmJhc2UoKTsKCiAgICAgICAgICAgIHZhciB2YWxJbmZvID0gdGhpcy52YWxpZGF0aW9uOwoKICAgICAgICAgICAgaWYgKCF2YWxJbmZvWyJpbnZhbGlkUGF0dGVybiJdWyJzdGF0dXMiXSkgewogICAgICAgICAgICAgICAgdmFsSW5mb1siaW52YWxpZFBhdHRlcm4iXVsibWVzc2FnZSJdID0gdGhpcy52aWV3LmdldE1lc3NhZ2UoImludmFsaWRFbWFpbCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gYmFzZVN0YXR1czsKICAgICAgICB9LC8vX19CVUlMREVSX0hFTFBFUlMKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFNjaGVtYU9mU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZTY2hlbWE6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcGF0dGVybiA9ICh0aGlzLnNjaGVtYSAmJiB0aGlzLnNjaGVtYS5wYXR0ZXJuKSA/IHRoaXMuc2NoZW1hLnBhdHRlcm4gOiBBbHBhY2EucmVnZXhwcy5lbWFpbDsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgInBhdHRlcm4iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJQYXR0ZXJuIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkZpZWxkIFBhdHRlcm4gaW4gUmVndWxhciBFeHByZXNzaW9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiBwYXR0ZXJuLAogICAgICAgICAgICAgICAgICAgICAgICAiZW51bSI6W3BhdHRlcm5dLAogICAgICAgICAgICAgICAgICAgICAgICAicmVhZG9ubHkiOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZm9ybWF0IjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRm9ybWF0IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlByb3BlcnR5IGRhdGEgZm9ybWF0IiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiJlbWFpbCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJlbnVtIjpbImVtYWlsIl0sCiAgICAgICAgICAgICAgICAgICAgICAgICJyZWFkb25seSI6dHJ1ZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldE9wdGlvbnNGb3JTY2hlbWEKICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yU2NoZW1hOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgImZpZWxkcyI6IHsKICAgICAgICAgICAgICAgICAgICAiZm9ybWF0IjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRUaXRsZQogICAgICAgICAqLwogICAgICAgIGdldFRpdGxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJFbWFpbCBGaWVsZCI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJFbWFpbCBGaWVsZC4iOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RmllbGRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJlbWFpbCI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJNZXNzYWdlcyh7CiAgICAgICAgImludmFsaWRFbWFpbCI6ICJJbnZhbGlkIEVtYWlsIGFkZHJlc3MgZS5nLiBpbmZvQGNsb3VkY21zLmNvbSIKICAgIH0pOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiZW1haWwiLCBBbHBhY2EuRmllbGRzLkVtYWlsRmllbGQpOwogICAgQWxwYWNhLnJlZ2lzdGVyRGVmYXVsdEZvcm1hdEZpZWxkTWFwcGluZygiZW1haWwiLCAiZW1haWwiKTsKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5JbnRlZ2VyRmllbGQgPSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuSW50ZWdlckZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkZpZWxkcy5OdW1iZXJGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIENvbnRyb2wgZm9yIGludGVnZXJzLiBJZiBqUXVlcnkgVUkgaXMgZW5hYmxlZCwgaXQgY2FuIGFsc28gYmUKICAgICAgICAgKiB0dXJuZWQgaW50byBhIHNsaWRlci4KICAgICAgICAgKjxwPgogICAgICAgICAqIFRoZSBmb2xsb3dpbmcgYWRkaXRpb25hbCBKU09OIFNjaGVtYSBwcm9wZXJ0aWVzIGFyZSBzdXBwb3J0ZWQ6CiAgICAgICAgICo8cC8+CiAgICAgICAgICo8Y29kZT4KICAgICAgICAgKiAgICAgPHByZT4KICAgICAgICAgKiB7CiAgICAgICAgICogICAgbWluaW11bToge251bWJlcn0sCiAgICAgICAgICogICAgbWF4aW11bToge251bWJlcn0sCiAgICAgICAgICogICAgbWluaW11bUNhbkVxdWFsOiB7Ym9vbGVhbn0sCiAgICAgICAgICogICAgbWF4aW11bUNhbkVxdWFsOiB7Ym9vbGVhbn0sCiAgICAgICAgICogICAgZGl2aXNpYmxlQnk6IHtudW1iZXJ9CiAgICAgICAgICogfQogICAgICAgICAqIDwvcHJlPgogICAgICAgICAqIDwvY29kZT4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2dldFZhbHVlCiAgICAgICAgICovCiAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgdGV4dFZhbHVlID0gdGhpcy5maWVsZC52YWwoKTsKICAgICAgICAgICAgaWYgKEFscGFjYS5pc1ZhbEVtcHR5KHRleHRWYWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZUludCh0ZXh0VmFsdWUsIDEwKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI29uQ2hhbmdlCiAgICAgICAgICovCiAgICAgICAgb25DaGFuZ2U6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CiAgICAgICAgICAgIGlmICh0aGlzLnNsaWRlcikgewogICAgICAgICAgICAgICAgdGhpcy5zbGlkZXIuc2xpZGVyKCJ2YWx1ZSIsIHRoaXMuZ2V0VmFsdWUoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuTnVtYmVyRmllbGQjcG9zdFJlbmRlcgogICAgICAgICAqLwogICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgdGhpcy5iYXNlKGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMuc2xpZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eShzZWxmLnNjaGVtYS5tYXhpbXVtKSAmJiAhQWxwYWNhLmlzRW1wdHkoc2VsZi5zY2hlbWEubWluaW11bSkpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLmZpZWxkKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkLmFmdGVyKCc8ZGl2IGlkPSJzbGlkZXIiPjwvZGl2PicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zbGlkZXIgPSAkKCcjc2xpZGVyJywgc2VsZi5maWVsZC5wYXJlbnQoKSkuc2xpZGVyKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogc2VsZi5nZXRWYWx1ZSgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbjogc2VsZi5zY2hlbWEubWluaW11bSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXg6IHNlbGYuc2NoZW1hLm1heGltdW0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGU6IGZ1bmN0aW9uKGV2ZW50LCB1aSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNldFZhbHVlKHVpLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5yZWZyZXNoVmFsaWRhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLWludGVnZXInKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwoKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2hhbmRsZVZhbGlkYXRlCiAgICAgICAgICovCiAgICAgICAgaGFuZGxlVmFsaWRhdGU6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgdmFyIGJhc2VTdGF0dXMgPSB0aGlzLmJhc2UoKTsKCiAgICAgICAgICAgIHZhciB2YWxJbmZvID0gdGhpcy52YWxpZGF0aW9uOwoKICAgICAgICAgICAgaWYgKCF2YWxJbmZvWyJzdHJpbmdOb3RBTnVtYmVyIl1bInN0YXR1cyJdKSB7CiAgICAgICAgICAgICAgICB2YWxJbmZvWyJzdHJpbmdOb3RBTnVtYmVyIl1bIm1lc3NhZ2UiXSA9IHRoaXMudmlldy5nZXRNZXNzYWdlKCJzdHJpbmdOb3RBbkludGVnZXIiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGJhc2VTdGF0dXM7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaWRhdGVzIGlmIGl0IGlzIGFuIGludGVnZXIuCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IHRydWUgaWYgaXQgaXMgYW4gaW50ZWdlcgogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZU51bWJlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB0ZXh0VmFsdWUgPSB0aGlzLmZpZWxkLnZhbCgpOwoKICAgICAgICAgICAgaWYgKEFscGFjYS5pc1ZhbEVtcHR5KHRleHRWYWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgZmxvYXRWYWx1ZSA9IHRoaXMuZ2V0VmFsdWUoKTsKCiAgICAgICAgICAgIC8vIHF1aWNrIGNoZWNrIHRvIHNlZSBpZiB3aGF0IHRoZXkgZW50ZXJlZCB3YXMgYSBudW1iZXIKICAgICAgICAgICAgaWYgKGlzTmFOKGZsb2F0VmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGNoZWNrIGlmIHZhbGlkIG51bWJlciBmb3JtYXQKICAgICAgICAgICAgaWYgKCF0ZXh0VmFsdWUubWF0Y2goQWxwYWNhLnJlZ2V4cHMuaW50ZWdlcikpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2dldFNjaGVtYU9mU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZTY2hlbWE6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAibWluaW11bSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIk1pbmltdW0iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiTWluaW11bSB2YWx1ZSBvZiB0aGUgcHJvcGVydHkuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJtYXhpbXVtIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiTWF4aW11bSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJNYXhpbXVtIHZhbHVlIG9mIHRoZSBwcm9wZXJ0eS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImRpdmlzaWJsZUJ5IjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRGl2aXNpYmxlIEJ5IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlByb3BlcnR5IHZhbHVlIG11c3QgYmUgZGl2aXNpYmxlIGJ5IHRoaXMgbnVtYmVyLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5OdW1iZXJGaWVsZCNnZXRPcHRpb25zRm9yU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0ZvclNjaGVtYTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgIm1pbmltdW0iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJoZWxwZXIiOiAiTWluaW11bSB2YWx1ZSBvZiB0aGUgZmllbGQuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJtYXhpbXVtIjogewogICAgICAgICAgICAgICAgICAgICAgICAiaGVscGVyIjogIk1heGltdW0gdmFsdWUgb2YgdGhlIGZpZWxkLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZGl2aXNpYmxlQnkiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJoZWxwZXIiOiAiUHJvcGVydHkgdmFsdWUgbXVzdCBiZSBkaXZpc2libGUgYnkgdGhpcyBudW1iZXIuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2dldFNjaGVtYU9mT3B0aW9ucwogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICJzbGlkZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJTbGlkZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiR2VuZXJhdGUgalF1ZXJ5IFVJIHNsaWRlciBjb250cm9sIHdpdGggdGhlIGZpZWxkIGlmIHRydWUuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogZmFsc2UKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2dldE9wdGlvbnNGb3JPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0Zvck9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICJzbGlkZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJyaWdodExhYmVsIjogIlNsaWRlciBjb250cm9sID8iLAogICAgICAgICAgICAgICAgICAgICAgICAiaGVscGVyIjogIkdlbmVyYXRlIHNsaWRlciBjb250cm9sIGlmIHNlbGVjdGVkLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2dldFRpdGxlCiAgICAgICAgICovCiAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIkludGVnZXIgRmllbGQiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5OdW1iZXJGaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJGaWVsZCBmb3IgaW50ZWdlcnMuIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuTnVtYmVyRmllbGQjZ2V0VHlwZQogICAgICAgICAqLwogICAgICAgIGdldFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gImludGVnZXIiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5OdW1iZXJGaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRGaWVsZFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gImludGVnZXIiOwogICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgfSk7CgogICAgLy8gQWRkaXRpb25hbCBSZWdpc3RyYXRpb25zCiAgICBBbHBhY2EucmVnaXN0ZXJNZXNzYWdlcyh7CiAgICAgICAgInN0cmluZ05vdEFuSW50ZWdlciI6ICJUaGlzIHZhbHVlIGlzIG5vdCBhbiBpbnRlZ2VyLiIKICAgIH0pOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiaW50ZWdlciIsIEFscGFjYS5GaWVsZHMuSW50ZWdlckZpZWxkKTsKICAgIEFscGFjYS5yZWdpc3RlckRlZmF1bHRTY2hlbWFGaWVsZE1hcHBpbmcoImludGVnZXIiLCAiaW50ZWdlciIpOwp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLklQdjRGaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuSVB2NEZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBDb250cm9sIGZvciBKU09OIHNjaGVtYSBpcC1hZGRyZXNzIGZvcm1hdC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNzZXR1cAogICAgICAgICAqLwogICAgICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIXRoaXMuc2NoZW1hLnBhdHRlcm4pIHsKICAgICAgICAgICAgICAgIHRoaXMuc2NoZW1hLnBhdHRlcm4gPSBBbHBhY2EucmVnZXhwcy5pcHY0OwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtaXB2NCcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CgogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2hhbmRsZVZhbGlkYXRlCiAgICAgICAgICovCiAgICAgICAgaGFuZGxlVmFsaWRhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYmFzZVN0YXR1cyA9IHRoaXMuYmFzZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHZhbEluZm8gPSB0aGlzLnZhbGlkYXRpb247CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIXZhbEluZm9bImludmFsaWRQYXR0ZXJuIl1bInN0YXR1cyJdKSB7CiAgICAgICAgICAgICAgICB2YWxJbmZvWyJpbnZhbGlkUGF0dGVybiJdWyJtZXNzYWdlIl0gPSB0aGlzLnZpZXcuZ2V0TWVzc2FnZSgiaW52YWxpZElQdjQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGJhc2VTdGF0dXM7CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRTY2hlbWFPZlNjaGVtYQogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mU2NoZW1hOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHBhdHRlcm4gPSAodGhpcy5zY2hlbWEgJiYgdGhpcy5zY2hlbWEucGF0dGVybik/IHRoaXMuc2NoZW1hLnBhdHRlcm4gOiBBbHBhY2EucmVnZXhwcy5pcHY0OwogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAicGF0dGVybiI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlBhdHRlcm4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRmllbGQgUGF0dGVybiBpbiBSZWd1bGFyIEV4cHJlc3Npb24iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IHBhdHRlcm4sCiAgICAgICAgICAgICAgICAgICAgICAgICJyZWFkb25seSI6IHRydWUKICAgICAgICAgICAgICAgICAgICB9LCAgICAgICAgICAgICAgICAgICAgCgkJCQkJImZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJQcm9wZXJ0eSBkYXRhIGZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJlbnVtIjogWyJpcC1hZGRyZXNzIl0sCgkJCQkJCSJkZWZhdWx0IjoiaXAtYWRkcmVzcyIsCgkJCQkJCSJyZWFkb25seSI6dHJ1ZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldE9wdGlvbnNGb3JTY2hlbWEKICAgICAgICAgKi8KCQlnZXRPcHRpb25zRm9yU2NoZW1hOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSx7CgkJCQkiZmllbGRzIjogewoJCQkJCSJmb3JtYXQiOiB7CgkJCQkJCSJ0eXBlIjogInRleHQiCgkJCQkJfQoJCQkJfQoJCQl9KTsKICAgICAgICB9LAogICAgICAgIAogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0VGl0bGUKICAgICAgICAgKi8KICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiSVAgQWRkcmVzcyBGaWVsZCI7CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldERlc2NyaXB0aW9uCiAgICAgICAgICovCiAgICAgICAgZ2V0RGVzY3JpcHRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIklQIEFkZHJlc3MgRmllbGQuIjsKICAgICAgICB9LAoKCQkvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiaXB2NCI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKICAgIAogICAgQWxwYWNhLnJlZ2lzdGVyTWVzc2FnZXMoewogICAgICAgICJpbnZhbGlkSVB2NCI6ICJJbnZhbGlkIElQdjQgYWRkcmVzcywgZS5nLiAxOTIuMTY4LjAuMSIKICAgIH0pOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiaXB2NCIsIEFscGFjYS5GaWVsZHMuSVB2NEZpZWxkKTsKICAgIEFscGFjYS5yZWdpc3RlckRlZmF1bHRGb3JtYXRGaWVsZE1hcHBpbmcoImlwLWFkZHJlc3MiLCAiaXB2NCIpOwp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLkpTT05GaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEFyZWFGaWVsZC5leHRlbmQoCiAgICAvKioKICAgICAqIEBsZW5kcyBBbHBhY2EuRmllbGRzLkpTT05GaWVsZC5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5GaWVsZHMuVGV4dEFyZWFGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIEpTT04gY29udHJvbCBmb3IgY2h1bmsgb2YgdGV4dC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udGFpbmVyRmllbGQjZ2V0VmFsdWUKICAgICAgICAgKi8KICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgaWYgKEFscGFjYS5pc09iamVjdCh2YWx1ZSkgfHwgdHlwZW9mKHZhbHVlKSA9PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgdmFsdWUgPSBKU09OLnN0cmluZ2lmeSh2YWx1ZSwgbnVsbCwgMyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5iYXNlKHZhbHVlKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250YWluZXJGaWVsZCNnZXRWYWx1ZQogICAgICAgICAqLwogICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIHZhciB2YWwgPSB0aGlzLmJhc2UoKTsKCiAgICAgICAgICAgIGlmICh2YWwgJiYgQWxwYWNhLmlzU3RyaW5nKHZhbCkpIHsKICAgICAgICAgICAgICAgIHZhbCA9IEpTT04ucGFyc2UodmFsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2hhbmRsZVZhbGlkYXRlCiAgICAgICAgICovCiAgICAgICAgaGFuZGxlVmFsaWRhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYmFzZVN0YXR1cyA9IHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgdmFyIHZhbEluZm8gPSB0aGlzLnZhbGlkYXRpb247CgoJCQl2YXIgc3RhdHVzID0gdGhpcy5fdmFsaWRhdGVKU09OKCk7CiAgICAgICAgICAgIHZhbEluZm9bInN0cmluZ05vdEFKU09OIl0gPSB7CiAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHN0YXR1cy5zdGF0dXMgPyAiIiA6IHRoaXMudmlldy5nZXRNZXNzYWdlKCJzdHJpbmdOb3RBSlNPTiIpICsiICIrIHN0YXR1cy5tZXNzYWdlLAogICAgICAgICAgICAgICAgInN0YXR1cyI6IHN0YXR1cy5zdGF0dXMKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBiYXNlU3RhdHVzICYmIHZhbEluZm9bInN0cmluZ05vdEFKU09OIl1bInN0YXR1cyJdIDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBWYWxpZGF0ZXMgaWYgaXQgaXMgYSB2YWxpZCBKU09OIG9iamVjdC4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gdHJ1ZSBpZiBpdCBpcyBhIHZhbGlkIEpTT04gb2JqZWN0CiAgICAgICAgICovCiAgICAgICAgX3ZhbGlkYXRlSlNPTjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB0ZXh0VmFsdWUgPSB0aGlzLmZpZWxkLnZhbCgpOwogICAgICAgICAgICAvLyBhbGxvdyBudWxsCiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNWYWxFbXB0eSh0ZXh0VmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiIDogdHJ1ZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gcGFyc2UgdGhlIHN0cmluZwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdmFyIG9iaiA9IEpTT04ucGFyc2UodGV4dFZhbHVlKTsKICAgICAgICAgICAgICAgIC8vIGZvcm1hdCB0aGUgc3RyaW5nIGFzIHdlbGwKICAgICAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUoSlNPTi5zdHJpbmdpZnkob2JqLCBudWxsLCAzKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiIDogdHJ1ZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiIDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgIm1lc3NhZ2UiIDogZS5tZXNzYWdlCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRBcmVhRmllbGQjcG9zdFJlbmRlcgogICAgICAgICAqLwogICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gU29tZSBhdXRvLWZvcm1hdHRpbmcgY2FwYWJpbGl0aWVzCiAgICAgICAgICAgICAgICAgICAgc2VsZi5maWVsZC5iaW5kKCdrZXlwcmVzcycsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhlLndoaWNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUud2hpY2ggPT0gMzQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGQuaW5zZXJ0QXRDYXJldCgnIicpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlLndoaWNoID09IDEyMykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5maWVsZC5pbnNlcnRBdENhcmV0KCd9Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUud2hpY2ggPT0gOTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGQuaW5zZXJ0QXRDYXJldCgnXScpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5maWVsZC5iaW5kKCdrZXlwcmVzcycsICdDdHJsK2wnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5nZXRFbCgpLnJlbW92ZUNsYXNzKCJhbHBhY2EtZmllbGQtZm9jdXNlZCIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2V0IGNsYXNzIGZyb20gc3RhdGUKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5yZWZyZXNoVmFsaWRhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5maWVsZC5hdHRyKCd0aXRsZScsJ1R5cGUgQ3RybCtMIHRvIGZvcm1hdCBhbmQgdmFsaWRhdGUgdGhlIEpTT04gc3RyaW5nLicpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChzZWxmLmZpZWxkQ29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5maWVsZENvbnRhaW5lci5hZGRDbGFzcygnYWxwYWNhLWNvbnRyb2xmaWVsZC1qc29uJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKCiAgICAgICAgICAgIH0pOwoKICAgICAgICB9LC8vX19CVUlMREVSX0hFTFBFUlMKCgkJLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRBcmVhRmllbGQjZ2V0VGl0bGUKCQkgKi8KCQlnZXRUaXRsZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAiSlNPTiBFZGl0b3IiOwoJCX0sCgoJCS8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0QXJlYUZpZWxkI2dldERlc2NyaXB0aW9uCgkJICovCgkJZ2V0RGVzY3JpcHRpb246IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gIkVkaXRvciBmb3IgSlNPTiBvYmplY3RzIHdpdGggYmFzaWMgdmFsaWRhdGlvbiBhbmQgZm9ybWF0dGluZy4iOwoJCX0sCgoJCS8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0QXJlYUZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAianNvbiI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKCiAgICAvLyBBZGRpdGlvbmFsIFJlZ2lzdHJhdGlvbnMKICAgIEFscGFjYS5yZWdpc3Rlck1lc3NhZ2VzKHsKICAgICAgICAic3RyaW5nTm90QUpTT04iOiAiVGhpcyB2YWx1ZSBpcyBub3QgYSB2YWxpZCBKU09OIHN0cmluZy4iCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJGaWVsZENsYXNzKCJqc29uIiwgQWxwYWNhLkZpZWxkcy5KU09ORmllbGQpOwoKICAgICQuZm4uaW5zZXJ0QXRDYXJldCA9IGZ1bmN0aW9uIChteVZhbHVlKSB7CgogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAvL0lFIHN1cHBvcnQKICAgICAgICAgICAgaWYgKGRvY3VtZW50LnNlbGVjdGlvbikgewoKICAgICAgICAgICAgICAgIHRoaXMuZm9jdXMoKTsKICAgICAgICAgICAgICAgIHNlbCA9IGRvY3VtZW50LnNlbGVjdGlvbi5jcmVhdGVSYW5nZSgpOwogICAgICAgICAgICAgICAgc2VsLnRleHQgPSBteVZhbHVlOwogICAgICAgICAgICAgICAgdGhpcy5mb2N1cygpOwoKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnNlbGVjdGlvblN0YXJ0IHx8IHRoaXMuc2VsZWN0aW9uU3RhcnQgPT0gJzAnKSB7CgogICAgICAgICAgICAgICAgLy9NT1pJTExBIC8gTkVUU0NBUEUgc3VwcG9ydAogICAgICAgICAgICAgICAgdmFyIHN0YXJ0UG9zID0gdGhpcy5zZWxlY3Rpb25TdGFydDsKICAgICAgICAgICAgICAgIHZhciBlbmRQb3MgPSB0aGlzLnNlbGVjdGlvbkVuZDsKICAgICAgICAgICAgICAgIHZhciBzY3JvbGxUb3AgPSB0aGlzLnNjcm9sbFRvcDsKICAgICAgICAgICAgICAgIHRoaXMudmFsdWUgPSB0aGlzLnZhbHVlLnN1YnN0cmluZygwLCBzdGFydFBvcykgKyBteVZhbHVlICsgdGhpcy52YWx1ZS5zdWJzdHJpbmcoZW5kUG9zLCB0aGlzLnZhbHVlLmxlbmd0aCk7CiAgICAgICAgICAgICAgICB0aGlzLmZvY3VzKCk7CiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGlvblN0YXJ0ID0gc3RhcnRQb3MgLyorIG15VmFsdWUubGVuZ3RoKi87CiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGlvbkVuZCA9IHN0YXJ0UG9zIC8qKyBteVZhbHVlLmxlbmd0aCovOwogICAgICAgICAgICAgICAgdGhpcy5zY3JvbGxUb3AgPSBzY3JvbGxUb3A7CgogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIHRoaXMudmFsdWUgKz0gbXlWYWx1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZm9jdXMoKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfTsKLyoKICogalF1ZXJ5IEhvdGtleXMgUGx1Z2luCiAqIENvcHlyaWdodCAyMDEwLCBKb2huIFJlc2lnCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBvciBHUEwgVmVyc2lvbiAyIGxpY2Vuc2VzLgogKgogKiBCYXNlZCB1cG9uIHRoZSBwbHVnaW4gYnkgVHp1cnkgQmFyIFlvY2hheToKICogaHR0cDovL2dpdGh1Yi5jb20vdHp1cnlieS9ob3RrZXlzCiAqCiAqIE9yaWdpbmFsIGlkZWEgYnk6CiAqIEJpbm55IFYgQSwgaHR0cDovL3d3dy5vcGVuanMuY29tL3NjcmlwdHMvZXZlbnRzL2tleWJvYXJkX3Nob3J0Y3V0cy8KKi8KICAgIGpRdWVyeS5ob3RrZXlzID0gewogICAgICAgIHZlcnNpb246ICIwLjgiLAoKICAgICAgICBzcGVjaWFsS2V5czogewogICAgICAgICAgICA4OiAiYmFja3NwYWNlIiwgOTogInRhYiIsIDEzOiAicmV0dXJuIiwgMTY6ICJzaGlmdCIsIDE3OiAiY3RybCIsIDE4OiAiYWx0IiwgMTk6ICJwYXVzZSIsCiAgICAgICAgICAgIDIwOiAiY2Fwc2xvY2siLCAyNzogImVzYyIsIDMyOiAic3BhY2UiLCAzMzogInBhZ2V1cCIsIDM0OiAicGFnZWRvd24iLCAzNTogImVuZCIsIDM2OiAiaG9tZSIsCiAgICAgICAgICAgIDM3OiAibGVmdCIsIDM4OiAidXAiLCAzOTogInJpZ2h0IiwgNDA6ICJkb3duIiwgNDU6ICJpbnNlcnQiLCA0NjogImRlbCIsCiAgICAgICAgICAgIDk2OiAiMCIsIDk3OiAiMSIsIDk4OiAiMiIsIDk5OiAiMyIsIDEwMDogIjQiLCAxMDE6ICI1IiwgMTAyOiAiNiIsIDEwMzogIjciLAogICAgICAgICAgICAxMDQ6ICI4IiwgMTA1OiAiOSIsIDEwNjogIioiLCAxMDc6ICIrIiwgMTA5OiAiLSIsIDExMDogIi4iLCAxMTEgOiAiLyIsCiAgICAgICAgICAgIDExMjogImYxIiwgMTEzOiAiZjIiLCAxMTQ6ICJmMyIsIDExNTogImY0IiwgMTE2OiAiZjUiLCAxMTc6ICJmNiIsIDExODogImY3IiwgMTE5OiAiZjgiLAogICAgICAgICAgICAxMjA6ICJmOSIsIDEyMTogImYxMCIsIDEyMjogImYxMSIsIDEyMzogImYxMiIsIDE0NDogIm51bWxvY2siLCAxNDU6ICJzY3JvbGwiLCAxOTE6ICIvIiwgMjI0OiAibWV0YSIKICAgICAgICB9LAoKICAgICAgICBzaGlmdE51bXM6IHsKICAgICAgICAgICAgImAiOiAifiIsICIxIjogIiEiLCAiMiI6ICJAIiwgIjMiOiAiIyIsICI0IjogIiQiLCAiNSI6ICIlIiwgIjYiOiAiXiIsICI3IjogIiYiLAogICAgICAgICAgICAiOCI6ICIqIiwgIjkiOiAiKCIsICIwIjogIikiLCAiLSI6ICJfIiwgIj0iOiAiKyIsICI7IjogIjogIiwgIiciOiAiXCIiLCAiLCI6ICI8IiwKICAgICAgICAgICAgIi4iOiAiPiIsICAiLyI6ICI/IiwgICJcXCI6ICJ8IgogICAgICAgIH0KICAgIH07CgogICAgZnVuY3Rpb24ga2V5SGFuZGxlciggaGFuZGxlT2JqICkgewogICAgICAgIC8vIE9ubHkgY2FyZSB3aGVuIGEgcG9zc2libGUgaW5wdXQgaGFzIGJlZW4gc3BlY2lmaWVkCiAgICAgICAgaWYgKCB0eXBlb2YgaGFuZGxlT2JqLmRhdGEgIT09ICJzdHJpbmciICkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgb3JpZ0hhbmRsZXIgPSBoYW5kbGVPYmouaGFuZGxlciwKICAgICAgICAgICAga2V5cyA9IGhhbmRsZU9iai5kYXRhLnRvTG93ZXJDYXNlKCkuc3BsaXQoIiAiKTsKCiAgICAgICAgaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CiAgICAgICAgICAgIC8vIERvbid0IGZpcmUgaW4gdGV4dC1hY2NlcHRpbmcgaW5wdXRzIHRoYXQgd2UgZGlkbid0IGRpcmVjdGx5IGJpbmQgdG8KICAgICAgICAgICAgaWYgKCB0aGlzICE9PSBldmVudC50YXJnZXQgJiYgKC90ZXh0YXJlYXxzZWxlY3QvaS50ZXN0KCBldmVudC50YXJnZXQubm9kZU5hbWUgKSB8fAogICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC50eXBlID09PSAidGV4dCIpICkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBLZXlwcmVzcyByZXByZXNlbnRzIGNoYXJhY3RlcnMsIG5vdCBzcGVjaWFsIGtleXMKICAgICAgICAgICAgdmFyIHNwZWNpYWwgPSBldmVudC50eXBlICE9PSAia2V5cHJlc3MiICYmIGpRdWVyeS5ob3RrZXlzLnNwZWNpYWxLZXlzWyBldmVudC53aGljaCBdLAogICAgICAgICAgICAgICAgY2hhcmFjdGVyID0gU3RyaW5nLmZyb21DaGFyQ29kZSggZXZlbnQud2hpY2ggKS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAgICAga2V5LCBtb2RpZiA9ICIiLCBwb3NzaWJsZSA9IHt9OwoKICAgICAgICAgICAgLy8gY2hlY2sgY29tYmluYXRpb25zIChhbHR8Y3RybHxzaGlmdCthbnl0aGluZykKICAgICAgICAgICAgaWYgKCBldmVudC5hbHRLZXkgJiYgc3BlY2lhbCAhPT0gImFsdCIgKSB7CiAgICAgICAgICAgICAgICBtb2RpZiArPSAiYWx0KyI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICggZXZlbnQuY3RybEtleSAmJiBzcGVjaWFsICE9PSAiY3RybCIgKSB7CiAgICAgICAgICAgICAgICBtb2RpZiArPSAiY3RybCsiOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUT0RPOiBOZWVkIHRvIG1ha2Ugc3VyZSB0aGlzIHdvcmtzIGNvbnNpc3RlbnRseSBhY3Jvc3MgcGxhdGZvcm1zCiAgICAgICAgICAgIGlmICggZXZlbnQubWV0YUtleSAmJiAhZXZlbnQuY3RybEtleSAmJiBzcGVjaWFsICE9PSAibWV0YSIgKSB7CiAgICAgICAgICAgICAgICBtb2RpZiArPSAibWV0YSsiOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIGV2ZW50LnNoaWZ0S2V5ICYmIHNwZWNpYWwgIT09ICJzaGlmdCIgKSB7CiAgICAgICAgICAgICAgICBtb2RpZiArPSAic2hpZnQrIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCBzcGVjaWFsICkgewogICAgICAgICAgICAgICAgcG9zc2libGVbIG1vZGlmICsgc3BlY2lhbCBdID0gdHJ1ZTsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwb3NzaWJsZVsgbW9kaWYgKyBjaGFyYWN0ZXIgXSA9IHRydWU7CiAgICAgICAgICAgICAgICBwb3NzaWJsZVsgbW9kaWYgKyBqUXVlcnkuaG90a2V5cy5zaGlmdE51bXNbIGNoYXJhY3RlciBdIF0gPSB0cnVlOwoKICAgICAgICAgICAgICAgIC8vICIkIiBjYW4gYmUgdHJpZ2dlcmVkIGFzICJTaGlmdCs0IiBvciAiU2hpZnQrJCIgb3IganVzdCAiJCIKICAgICAgICAgICAgICAgIGlmICggbW9kaWYgPT09ICJzaGlmdCsiICkgewogICAgICAgICAgICAgICAgICAgIHBvc3NpYmxlWyBqUXVlcnkuaG90a2V5cy5zaGlmdE51bXNbIGNoYXJhY3RlciBdIF0gPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKCB2YXIgaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKICAgICAgICAgICAgICAgIGlmICggcG9zc2libGVbIGtleXNbaV0gXSApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3JpZ0hhbmRsZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0KCiAgICBqUXVlcnkuZWFjaChbICJrZXlkb3duIiwgImtleXVwIiwgImtleXByZXNzIiBdLCBmdW5jdGlvbigpIHsKICAgICAgICBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdGhpcyBdID0geyBhZGQ6IGtleUhhbmRsZXIgfTsKICAgIH0pOwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5JbnRlZ2VyRmllbGQgPSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuSW50ZWdlckZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkZpZWxkcy5OdW1iZXJGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIENvbnRyb2wgZm9yIGludGVnZXJzLiBJZiBqUXVlcnkgVUkgaXMgZW5hYmxlZCwgaXQgY2FuIGFsc28gYmUKICAgICAgICAgKiB0dXJuZWQgaW50byBhIHNsaWRlci4KICAgICAgICAgKjxwPgogICAgICAgICAqIFRoZSBmb2xsb3dpbmcgYWRkaXRpb25hbCBKU09OIFNjaGVtYSBwcm9wZXJ0aWVzIGFyZSBzdXBwb3J0ZWQ6CiAgICAgICAgICo8cC8+CiAgICAgICAgICo8Y29kZT4KICAgICAgICAgKiAgICAgPHByZT4KICAgICAgICAgKiB7CiAgICAgICAgICogICAgbWluaW11bToge251bWJlcn0sCiAgICAgICAgICogICAgbWF4aW11bToge251bWJlcn0sCiAgICAgICAgICogICAgbWluaW11bUNhbkVxdWFsOiB7Ym9vbGVhbn0sCiAgICAgICAgICogICAgbWF4aW11bUNhbkVxdWFsOiB7Ym9vbGVhbn0sCiAgICAgICAgICogICAgZGl2aXNpYmxlQnk6IHtudW1iZXJ9CiAgICAgICAgICogfQogICAgICAgICAqIDwvcHJlPgogICAgICAgICAqIDwvY29kZT4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2dldFZhbHVlCiAgICAgICAgICovCiAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgdGV4dFZhbHVlID0gdGhpcy5maWVsZC52YWwoKTsKICAgICAgICAgICAgaWYgKEFscGFjYS5pc1ZhbEVtcHR5KHRleHRWYWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZUludCh0ZXh0VmFsdWUsIDEwKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI29uQ2hhbmdlCiAgICAgICAgICovCiAgICAgICAgb25DaGFuZ2U6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CiAgICAgICAgICAgIGlmICh0aGlzLnNsaWRlcikgewogICAgICAgICAgICAgICAgdGhpcy5zbGlkZXIuc2xpZGVyKCJ2YWx1ZSIsIHRoaXMuZ2V0VmFsdWUoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuTnVtYmVyRmllbGQjcG9zdFJlbmRlcgogICAgICAgICAqLwogICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgdGhpcy5iYXNlKGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMuc2xpZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eShzZWxmLnNjaGVtYS5tYXhpbXVtKSAmJiAhQWxwYWNhLmlzRW1wdHkoc2VsZi5zY2hlbWEubWluaW11bSkpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLmZpZWxkKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkLmFmdGVyKCc8ZGl2IGlkPSJzbGlkZXIiPjwvZGl2PicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zbGlkZXIgPSAkKCcjc2xpZGVyJywgc2VsZi5maWVsZC5wYXJlbnQoKSkuc2xpZGVyKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogc2VsZi5nZXRWYWx1ZSgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbjogc2VsZi5zY2hlbWEubWluaW11bSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXg6IHNlbGYuc2NoZW1hLm1heGltdW0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGU6IGZ1bmN0aW9uKGV2ZW50LCB1aSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNldFZhbHVlKHVpLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5yZWZyZXNoVmFsaWRhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLWludGVnZXInKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwoKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2hhbmRsZVZhbGlkYXRlCiAgICAgICAgICovCiAgICAgICAgaGFuZGxlVmFsaWRhdGU6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgdmFyIGJhc2VTdGF0dXMgPSB0aGlzLmJhc2UoKTsKCiAgICAgICAgICAgIHZhciB2YWxJbmZvID0gdGhpcy52YWxpZGF0aW9uOwoKICAgICAgICAgICAgaWYgKCF2YWxJbmZvWyJzdHJpbmdOb3RBTnVtYmVyIl1bInN0YXR1cyJdKSB7CiAgICAgICAgICAgICAgICB2YWxJbmZvWyJzdHJpbmdOb3RBTnVtYmVyIl1bIm1lc3NhZ2UiXSA9IHRoaXMudmlldy5nZXRNZXNzYWdlKCJzdHJpbmdOb3RBbkludGVnZXIiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGJhc2VTdGF0dXM7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaWRhdGVzIGlmIGl0IGlzIGFuIGludGVnZXIuCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IHRydWUgaWYgaXQgaXMgYW4gaW50ZWdlcgogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZU51bWJlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB0ZXh0VmFsdWUgPSB0aGlzLmZpZWxkLnZhbCgpOwoKICAgICAgICAgICAgaWYgKEFscGFjYS5pc1ZhbEVtcHR5KHRleHRWYWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgZmxvYXRWYWx1ZSA9IHRoaXMuZ2V0VmFsdWUoKTsKCiAgICAgICAgICAgIC8vIHF1aWNrIGNoZWNrIHRvIHNlZSBpZiB3aGF0IHRoZXkgZW50ZXJlZCB3YXMgYSBudW1iZXIKICAgICAgICAgICAgaWYgKGlzTmFOKGZsb2F0VmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGNoZWNrIGlmIHZhbGlkIG51bWJlciBmb3JtYXQKICAgICAgICAgICAgaWYgKCF0ZXh0VmFsdWUubWF0Y2goQWxwYWNhLnJlZ2V4cHMuaW50ZWdlcikpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2dldFNjaGVtYU9mU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZTY2hlbWE6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAibWluaW11bSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIk1pbmltdW0iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiTWluaW11bSB2YWx1ZSBvZiB0aGUgcHJvcGVydHkuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJtYXhpbXVtIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiTWF4aW11bSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJNYXhpbXVtIHZhbHVlIG9mIHRoZSBwcm9wZXJ0eS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImRpdmlzaWJsZUJ5IjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRGl2aXNpYmxlIEJ5IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlByb3BlcnR5IHZhbHVlIG11c3QgYmUgZGl2aXNpYmxlIGJ5IHRoaXMgbnVtYmVyLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5OdW1iZXJGaWVsZCNnZXRPcHRpb25zRm9yU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0ZvclNjaGVtYTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgIm1pbmltdW0iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJoZWxwZXIiOiAiTWluaW11bSB2YWx1ZSBvZiB0aGUgZmllbGQuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJtYXhpbXVtIjogewogICAgICAgICAgICAgICAgICAgICAgICAiaGVscGVyIjogIk1heGltdW0gdmFsdWUgb2YgdGhlIGZpZWxkLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZGl2aXNpYmxlQnkiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJoZWxwZXIiOiAiUHJvcGVydHkgdmFsdWUgbXVzdCBiZSBkaXZpc2libGUgYnkgdGhpcyBudW1iZXIuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2dldFNjaGVtYU9mT3B0aW9ucwogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICJzbGlkZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJTbGlkZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiR2VuZXJhdGUgalF1ZXJ5IFVJIHNsaWRlciBjb250cm9sIHdpdGggdGhlIGZpZWxkIGlmIHRydWUuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogZmFsc2UKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2dldE9wdGlvbnNGb3JPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0Zvck9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICJzbGlkZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJyaWdodExhYmVsIjogIlNsaWRlciBjb250cm9sID8iLAogICAgICAgICAgICAgICAgICAgICAgICAiaGVscGVyIjogIkdlbmVyYXRlIHNsaWRlciBjb250cm9sIGlmIHNlbGVjdGVkLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2dldFRpdGxlCiAgICAgICAgICovCiAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIkludGVnZXIgRmllbGQiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5OdW1iZXJGaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJGaWVsZCBmb3IgaW50ZWdlcnMuIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuTnVtYmVyRmllbGQjZ2V0VHlwZQogICAgICAgICAqLwogICAgICAgIGdldFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gImludGVnZXIiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5OdW1iZXJGaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRGaWVsZFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gImludGVnZXIiOwogICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgfSk7CgogICAgLy8gQWRkaXRpb25hbCBSZWdpc3RyYXRpb25zCiAgICBBbHBhY2EucmVnaXN0ZXJNZXNzYWdlcyh7CiAgICAgICAgInN0cmluZ05vdEFuSW50ZWdlciI6ICJUaGlzIHZhbHVlIGlzIG5vdCBhbiBpbnRlZ2VyLiIKICAgIH0pOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiaW50ZWdlciIsIEFscGFjYS5GaWVsZHMuSW50ZWdlckZpZWxkKTsKICAgIEFscGFjYS5yZWdpc3RlckRlZmF1bHRTY2hlbWFGaWVsZE1hcHBpbmcoImludGVnZXIiLCAiaW50ZWdlciIpOwp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLkxvd2VyQ2FzZUZpZWxkID0gQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQuZXh0ZW5kKAogICAgLyoqCiAgICAgKiBAbGVuZHMgQWxwYWNhLkZpZWxkcy5Mb3dlckNhc2VGaWVsZC5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkCiAgICAgICAgICoKICAgICAgICAgKiBAY2xhc3MgQ29udHJvbCBmb3IgbG93ZXIgY2FzZSB0ZXh0LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IGRhdGEgRmllbGQgZGF0YS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBGaWVsZCBvcHRpb25zLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBGaWVsZCB2aWV3LgogICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbm5lY3Rvcn0gY29ubmVjdG9yIEZpZWxkIGNvbm5lY3Rvci4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI3Bvc3RSZW5kZXIKICAgICAgICAgKi8KICAgICAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbihjYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtbG93ZXJjYXNlJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjc2V0VmFsdWUKICAgICAgICAgKi8KICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgIHZhciBsb3dlclZhbHVlID0gdmFsLnRvTG93ZXJDYXNlKCk7CgogICAgICAgICAgICBpZiAobG93ZXJWYWx1ZSAhPSB0aGlzLmdldFZhbHVlKCkpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFzZShsb3dlclZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRyb2xGaWVsZCNvbktleVByZXNzCiAgICAgICAgICovCiAgICAgICAgb25LZXlQcmVzczogZnVuY3Rpb24oZSkgewogICAgICAgICAgICB0aGlzLmJhc2UoZSk7CgogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgQWxwYWNhLmxhdGVyKDI1LCB0aGlzLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciB2ID0gX3RoaXMuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgICAgIF90aGlzLnNldFZhbHVlKHYpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LC8vX19CVUlMREVSX0hFTFBFUlMKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRUaXRsZQogICAgICAgICAqLwogICAgICAgIGdldFRpdGxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJMb3dlcmNhc2UgVGV4dCI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJUZXh0IGZpZWxkIGZvciBsb3dlcmNhc2UgdGV4dC4iOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RmllbGRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJsb3dlcmNhc2UiOwogICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygibG93ZXJjYXNlIiwgQWxwYWNhLkZpZWxkcy5Mb3dlckNhc2VGaWVsZCk7CiAgICBBbHBhY2EucmVnaXN0ZXJEZWZhdWx0Rm9ybWF0RmllbGRNYXBwaW5nKCJsb3dlcmNhc2UiLCAibG93ZXJjYXNlIik7Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLk1hcEZpZWxkID0gQWxwYWNhLkZpZWxkcy5BcnJheUZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuTWFwRmllbGQucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuRmllbGRzLlRleHRBcmVhRmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBKU09OIGNvbnRyb2wgZm9yIGNodW5rIG9mIHRleHQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0QXJlYUZpZWxkI3NldHVwCiAgICAgICAgICovCiAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CgogICAgICAgICAgICBBbHBhY2EubWVyZ2VPYmplY3QodGhpcy5vcHRpb25zLCB7CiAgICAgICAgICAgICAgICAiZm9yY2VSZXZhbGlkYXRpb24iIDogdHJ1ZQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNFbXB0eSh0aGlzLmRhdGEpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghQWxwYWNhLmlzQXJyYXkodGhpcy5kYXRhKSkgewoKICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNPYmplY3QodGhpcy5kYXRhKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBuZXdEYXRhID0gW107CiAgICAgICAgICAgICAgICAgICAgJC5lYWNoKHRoaXMuZGF0YSwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3VmFsdWUgPSBBbHBhY2EuY29weU9mKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgbmV3VmFsdWVbIl9rZXkiXSA9IGtleTsKICAgICAgICAgICAgICAgICAgICAgICAgbmV3RGF0YS5wdXNoKG5ld1ZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRhdGEgPSBuZXdEYXRhOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udGFpbmVyRmllbGQjZ2V0VmFsdWUKICAgICAgICAgKi8KICAgICAgICBnZXRWYWx1ZTogZnVuY3Rpb24oKQogICAgICAgIHsKICAgICAgICAgICAgLy8gaWYgd2UgZG9uJ3QgaGF2ZSBhbnkgY2hpbGRyZW4gYW5kIHdlJ3JlIG5vdCByZXF1aXJlZCwgaGFuZCBiYWNrIHVuZGVmaW5lZAogICAgICAgICAgICBpZiAodGhpcy5jaGlsZHJlbi5sZW5ndGggPT09IDAgJiYgIXRoaXMuc2NoZW1hLnJlcXVpcmVkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBvID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHYgPSB0aGlzLmNoaWxkcmVuW2ldLmdldFZhbHVlKCk7CiAgICAgICAgICAgICAgICB2YXIga2V5ID0gdlsiX2tleSJdOwogICAgICAgICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB2WyJfa2V5Il07CiAgICAgICAgICAgICAgICAgICAgb1trZXldID0gdjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbzsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2hhbmRsZVZhbGlkYXRlCiAgICAgICAgICovCiAgICAgICAgaGFuZGxlVmFsaWRhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYmFzZVN0YXR1cyA9IHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgdmFyIHZhbEluZm8gPSB0aGlzLnZhbGlkYXRpb247CgogICAgICAgICAgICB2YXIgaXNWYWxpZE1hcEtleXNOb3RFbXB0eSA9IHRoaXMuX3ZhbGlkYXRlTWFwS2V5c05vdEVtcHR5KCk7CiAgICAgICAgICAgIHZhbEluZm9bImtleU1pc3NpbmciXSA9IHsKICAgICAgICAgICAgICAgICJtZXNzYWdlIjogaXNWYWxpZE1hcEtleXNOb3RFbXB0eSA/ICIiIDogdGhpcy52aWV3LmdldE1lc3NhZ2UoImtleU1pc3NpbmciKSwKICAgICAgICAgICAgICAgICJzdGF0dXMiOiBpc1ZhbGlkTWFwS2V5c05vdEVtcHR5CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgaXNWYWxpZE1hcEtleXNVbmlxdWUgPSB0aGlzLl92YWxpZGF0ZU1hcEtleXNVbmlxdWUoKTsKICAgICAgICAgICAgdmFsSW5mb1sia2V5Tm90VW5pcXVlIl0gPSB7CiAgICAgICAgICAgICAgICAibWVzc2FnZSI6IGlzVmFsaWRNYXBLZXlzVW5pcXVlID8gIiIgOiB0aGlzLnZpZXcuZ2V0TWVzc2FnZSgia2V5Tm90VW5pcXVlIiksCiAgICAgICAgICAgICAgICAic3RhdHVzIjogaXNWYWxpZE1hcEtleXNVbmlxdWUKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBiYXNlU3RhdHVzICYmIHZhbEluZm9bImtleU1pc3NpbmciXVsic3RhdHVzIl0gJiYgdmFsSW5mb1sia2V5Tm90VW5pcXVlIl1bInN0YXR1cyJdOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlcyBpZiBrZXkgZmllbGRzIGFyZSB1bmlxdWUuCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IHRydWUgaWYga2V5cyBhcmUgdW5pcXVlCiAgICAgICAgICovCiAgICAgICAgX3ZhbGlkYXRlTWFwS2V5c05vdEVtcHR5OiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIHZhciBpc1ZhbGlkID0gdHJ1ZTsKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHYgPSB0aGlzLmNoaWxkcmVuW2ldLmdldFZhbHVlKCk7CiAgICAgICAgICAgICAgICB2YXIga2V5ID0gdlsiX2tleSJdOwoKICAgICAgICAgICAgICAgIGlmICgha2V5KSB7CiAgICAgICAgICAgICAgICAgICAgaXNWYWxpZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gaXNWYWxpZDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBWYWxpZGF0ZXMgaWYga2V5IGZpZWxkcyBhcmUgdW5pcXVlLgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSB0cnVlIGlmIGtleXMgYXJlIHVuaXF1ZQogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZU1hcEtleXNVbmlxdWU6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgdmFyIGlzVmFsaWQgPSB0cnVlOwoKICAgICAgICAgICAgdmFyIGtleXMgPSB7fTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgdiA9IHRoaXMuY2hpbGRyZW5baV0uZ2V0VmFsdWUoKTsKICAgICAgICAgICAgICAgIHZhciBrZXkgPSB2WyJfa2V5Il07CgogICAgICAgICAgICAgICAgaWYgKGtleXNba2V5XSkgewogICAgICAgICAgICAgICAgICAgIGlzVmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBrZXlzW2tleV0gPSBrZXk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBpc1ZhbGlkOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0QXJlYUZpZWxkI3Bvc3RSZW5kZXIKICAgICAgICAgKi8KICAgICAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbihjYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtbWFwJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgfSk7CgogICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoKCQkvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEFyZWFGaWVsZCNnZXRUaXRsZQoJCSAqLwoJCWdldFRpdGxlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICJNYXAgRmllbGQiOwoJCX0sCgoJCS8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0QXJlYUZpZWxkI2dldERlc2NyaXB0aW9uCgkJICovCgkJZ2V0RGVzY3JpcHRpb246IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gIkZpZWxkIGZvciBvYmplY3RzIHdpdGgga2V5L3ZhbHVlIHBhaXJzIHRoYXQgc2hhcmUgdGhlIHNhbWUgc2NoZW1hIGZvciB2YWx1ZXMuIjsKCQl9LAoKCQkvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEFyZWFGaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRGaWVsZFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIm1hcCI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJGaWVsZENsYXNzKCJtYXAiLCBBbHBhY2EuRmllbGRzLk1hcEZpZWxkKTsKCiAgICAvLyBBZGRpdGlvbmFsIFJlZ2lzdHJhdGlvbnMKICAgIEFscGFjYS5yZWdpc3Rlck1lc3NhZ2VzKHsKICAgICAgICAia2V5Tm90VW5pcXVlIjogIktleXMgb2YgbWFwIGZpZWxkIGFyZSBub3QgdW5pcXVlLiIsCiAgICAgICAgImtleU1pc3NpbmciOiAiTWFwIGNvbnRhaW5zIGFuIGVtcHR5IGtleS4iCiAgICB9KTsKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5QYXNzd29yZEZpZWxkID0gQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQuZXh0ZW5kKAogICAgLyoqCiAgICAgKiBAbGVuZHMgQWxwYWNhLkZpZWxkcy5QYXNzd29yZEZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBDb250cm9sIGZvciBKU09OIHNjaGVtYSBwYXNzd29yZCBmb3JtYXQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjc2V0dXAKICAgICAgICAgKi8KICAgICAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCF0aGlzLnNjaGVtYS5wYXR0ZXJuKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNjaGVtYS5wYXR0ZXJuID0gQWxwYWNhLnJlZ2V4cHMucGFzc3dvcmQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuY29udHJvbEZpZWxkVGVtcGxhdGVEZXNjcmlwdG9yID0gdGhpcy52aWV3LmdldFRlbXBsYXRlRGVzY3JpcHRvcigiY29udHJvbEZpZWxkUGFzc3dvcmQiKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI3Bvc3RSZW5kZXIKICAgICAgICAgKi8KICAgICAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbihjYWxsYmFjaykgewoKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgdGhpcy5iYXNlKGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgIGlmIChzZWxmLmZpZWxkQ29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5maWVsZENvbnRhaW5lci5hZGRDbGFzcygnYWxwYWNhLWNvbnRyb2xmaWVsZC1wYXNzd29yZCcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjaGFuZGxlVmFsaWRhdGUKICAgICAgICAgKi8KICAgICAgICBoYW5kbGVWYWxpZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBiYXNlU3RhdHVzID0gdGhpcy5iYXNlKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgdmFsSW5mbyA9IHRoaXMudmFsaWRhdGlvbjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghdmFsSW5mb1siaW52YWxpZFBhdHRlcm4iXVsic3RhdHVzIl0pIHsKICAgICAgICAgICAgICAgIHZhbEluZm9bImludmFsaWRQYXR0ZXJuIl1bIm1lc3NhZ2UiXSA9IHRoaXMudmlldy5nZXRNZXNzYWdlKCJpbnZhbGlkUGFzc3dvcmQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGJhc2VTdGF0dXM7CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRTY2hlbWFPZlNjaGVtYQogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mU2NoZW1hOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHBhdHRlcm4gPSAodGhpcy5zY2hlbWEgJiYgdGhpcy5zY2hlbWEucGF0dGVybik/IHRoaXMuc2NoZW1hLnBhdHRlcm4gOiAvXlswLTlhLXpBLVpceDIwLVx4N0VdKiQvOwogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAicGF0dGVybiI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlBhdHRlcm4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRmllbGQgUGF0dGVybiBpbiBSZWd1bGFyIEV4cHJlc3Npb24iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IHRoaXMuc2NoZW1hLnBhdHRlcm4sCiAgICAgICAgICAgICAgICAgICAgICAgICJlbnVtIjpbcGF0dGVybl0sCiAgICAgICAgICAgICAgICAgICAgICAgICJyZWFkb25seSI6IHRydWUKICAgICAgICAgICAgICAgICAgICB9LCAgICAgICAgICAgICAgICAgICAgCgkJCQkJImZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJQcm9wZXJ0eSBkYXRhIGZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCgkJCQkJCSJkZWZhdWx0IjoicGFzc3dvcmQiLAogICAgICAgICAgICAgICAgICAgICAgICAiZW51bSI6WyJwYXNzd29yZCJdLAoJCQkJCQkicmVhZG9ubHkiOnRydWUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRPcHRpb25zRm9yU2NoZW1hCiAgICAgICAgICovCgkJZ2V0T3B0aW9uc0ZvclNjaGVtYTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksewoJCQkJImZpZWxkcyI6IHsKCQkJCQkiZm9ybWF0IjogewoJCQkJCQkidHlwZSI6ICJ0ZXh0IgoJCQkJCX0KCQkJCX0KCQkJfSk7CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFRpdGxlCiAgICAgICAgICovCiAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIlBhc3N3b3JkIEZpZWxkIjsKICAgICAgICB9LAogICAgICAgIAogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RGVzY3JpcHRpb24KICAgICAgICAgKi8KICAgICAgICBnZXREZXNjcmlwdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiUGFzc3dvcmQgRmllbGQuIjsKICAgICAgICB9LAoKCQkvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAicGFzc3dvcmQiOwogICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyVGVtcGxhdGUoImNvbnRyb2xGaWVsZFBhc3N3b3JkIiwgJzxpbnB1dCB0eXBlPSJwYXNzd29yZCIgaWQ9IiR7aWR9IiB7e2lmIG9wdGlvbnMuc2l6ZX19c2l6ZT0iJHtvcHRpb25zLnNpemV9Int7L2lmfX0ge3tpZiBvcHRpb25zLnJlYWRvbmx5fX1yZWFkb25seT0icmVhZG9ubHkie3svaWZ9fSB7e2lmIG5hbWV9fW5hbWU9IiR7bmFtZX0ie3svaWZ9fSB7e2VhY2goaSx2KSBvcHRpb25zLmRhdGF9fWRhdGEtJHtpfT0iJHt2fSJ7ey9lYWNofX0vPicpOwogICAgQWxwYWNhLnJlZ2lzdGVyTWVzc2FnZXMoewogICAgICAgICJpbnZhbGlkUGFzc3dvcmQiOiAiSW52YWxpZCBQYXNzd29yZCIKICAgIH0pOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygicGFzc3dvcmQiLCBBbHBhY2EuRmllbGRzLlBhc3N3b3JkRmllbGQpOwogICAgQWxwYWNhLnJlZ2lzdGVyRGVmYXVsdEZvcm1hdEZpZWxkTWFwcGluZygicGFzc3dvcmQiLCAicGFzc3dvcmQiKTsKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5QZXJzb25hbE5hbWVGaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuUGVyc29uYWxOYW1lRmllbGQucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuRmllbGRzLlRleHRGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIENvbnRyb2wgZm9yIHVwcGVyIGNhc2UgdGV4dC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtcGVyc29uYWxuYW1lJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjc2V0VmFsdWUKICAgICAgICAgKi8KICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgIHZhciB1cHBlclZhbHVlID0gIiI7CgogICAgICAgICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCB2YWwubGVuZ3RoOyBpKysgKSB7CiAgICAgICAgICAgICAgICBpZiAoIGkgPT09IDAgKSB7CiAgICAgICAgICAgICAgICAgICAgdXBwZXJWYWx1ZSArPSB2YWwuY2hhckF0KGkpLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHZhbC5jaGFyQXQoaS0xKSA9PSAnICcgfHwgIHZhbC5jaGFyQXQoaS0xKSA9PSAnLScgfHwgdmFsLmNoYXJBdChpLTEpID09ICInIikgewogICAgICAgICAgICAgICAgICAgIHVwcGVyVmFsdWUgKz0gdmFsLmNoYXJBdChpKS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB1cHBlclZhbHVlICs9IHZhbC5jaGFyQXQoaSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh1cHBlclZhbHVlICE9IHRoaXMuZ2V0VmFsdWUoKSkgewogICAgICAgICAgICAgICAgdGhpcy5iYXNlKHVwcGVyVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI29uS2V5UHJlc3MKICAgICAgICAgKi8KICAgICAgICBvbktleVByZXNzOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZShlKTsKCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICBBbHBhY2EubGF0ZXIoMjUsIHRoaXMsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIHYgPSBfdGhpcy5nZXRWYWx1ZSgpOwogICAgICAgICAgICAgICAgX3RoaXMuc2V0VmFsdWUodik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFRpdGxlCiAgICAgICAgICovCiAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIlBlcnNvbmFsIE5hbWUiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RGVzY3JpcHRpb24KICAgICAgICAgKi8KICAgICAgICBnZXREZXNjcmlwdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiVGV4dCBGaWVsZCBmb3IgcGVyc29uYWwgbmFtZSB3aXRoIGNhcHRpY2FsIGxldHRlciBmb3IgZmlyc3QgbGV0dGVyICYgYWZ0ZXIgaHlwaGVuLCBzcGFjZSBvciBhcG9zdHJvcGhlLiI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRGaWVsZFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gInBlcnNvbmFsbmFtZSI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJGaWVsZENsYXNzKCJwZXJzb25hbG5hbWUiLCBBbHBhY2EuRmllbGRzLlBlcnNvbmFsTmFtZUZpZWxkKTsKCn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuUGhvbmVGaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuUGhvbmVGaWVsZC5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkCiAgICAgICAgICoKICAgICAgICAgKiBAY2xhc3MgQ29udHJvbCBmb3Igc3RhbmRhcmQgVVMgcGhvbmUgbnVtYmVycy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNzZXR1cAogICAgICAgICAqLwogICAgICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CgogICAgICAgICAgICBpZiAoIXRoaXMuc2NoZW1hLnBhdHRlcm4pIHsKICAgICAgICAgICAgICAgIHRoaXMuc2NoZW1hLnBhdHRlcm4gPSBBbHBhY2EucmVnZXhwcy5waG9uZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKEFscGFjYS5pc0VtcHR5KHRoaXMub3B0aW9ucy5tYXNrU3RyaW5nKSkgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLm1hc2tTdHJpbmcgPSAiKDk5OSkgOTk5LTk5OTkiOwogICAgICAgICAgICB9CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjcG9zdFJlbmRlcgogICAgICAgICAqLwogICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLXBob25lJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjaGFuZGxlVmFsaWRhdGUKICAgICAgICAgKi8KICAgICAgICBoYW5kbGVWYWxpZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBiYXNlU3RhdHVzID0gdGhpcy5iYXNlKCk7CgogICAgICAgICAgICB2YXIgdmFsSW5mbyA9IHRoaXMudmFsaWRhdGlvbjsKCiAgICAgICAgICAgIGlmICghdmFsSW5mb1siaW52YWxpZFBhdHRlcm4iXVsic3RhdHVzIl0pIHsKICAgICAgICAgICAgICAgIHZhbEluZm9bImludmFsaWRQYXR0ZXJuIl1bIm1lc3NhZ2UiXSA9IHRoaXMudmlldy5nZXRNZXNzYWdlKCJpbnZhbGlkUGhvbmUiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGJhc2VTdGF0dXM7CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRTY2hlbWFPZlNjaGVtYQogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mU2NoZW1hOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHBhdHRlcm4gPSAodGhpcy5zY2hlbWEgJiYgdGhpcy5zY2hlbWEucGF0dGVybikgPyB0aGlzLnNjaGVtYS5wYXR0ZXJuIDogQWxwYWNhLnJlZ2V4cHMucGhvbmU7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICJwYXR0ZXJuIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiUGF0dGVybiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJGaWVsZCBQYXR0ZXJuIGluIFJlZ3VsYXIgRXhwcmVzc2lvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogcGF0dGVybiwKICAgICAgICAgICAgICAgICAgICAgICAgImVudW0iOltwYXR0ZXJuXSwKICAgICAgICAgICAgICAgICAgICAgICAgInJlYWRvbmx5IjogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJQcm9wZXJ0eSBkYXRhIGZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjoicGhvbmUiLAogICAgICAgICAgICAgICAgICAgICAgICAiZW51bSI6WyJwaG9uZSJdLAogICAgICAgICAgICAgICAgICAgICAgICAicmVhZG9ubHkiOnRydWUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRPcHRpb25zRm9yU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0ZvclNjaGVtYTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgImZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRTY2hlbWFPZk9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRTY2hlbWFPZk9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAibWFza1N0cmluZyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZpZWxkIE1hc2sgU3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkV4cHJlc3Npb24gZm9yIGZpZWxkIG1hc2siLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6ICIoOTk5KSA5OTktOTk5OSIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0VGl0bGUKICAgICAgICAgKi8KICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiUGhvbmUgRmllbGQiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RGVzY3JpcHRpb24KICAgICAgICAgKi8KICAgICAgICBnZXREZXNjcmlwdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiUGhvbmUgRmllbGQuIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAicGhvbmUiOwogICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyTWVzc2FnZXMoewogICAgICAgICJpbnZhbGlkUGhvbmUiOiAiSW52YWxpZCBQaG9uZSBOdW1iZXIsIGUuZy4gKDEyMykgNDU2LTk5OTkiCiAgICB9KTsKICAgIEFscGFjYS5yZWdpc3RlckZpZWxkQ2xhc3MoInBob25lIiwgQWxwYWNhLkZpZWxkcy5QaG9uZUZpZWxkKTsKICAgIEFscGFjYS5yZWdpc3RlckRlZmF1bHRGb3JtYXRGaWVsZE1hcHBpbmcoInBob25lIiwgInBob25lIik7Cn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuVGFnRmllbGQgPSBBbHBhY2EuRmllbGRzLkxvd2VyQ2FzZUZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuVGFnRmllbGQucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuRmllbGRzLlRleHRGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIFRpbWUgY29udHJvbCBmb3IgSlNPTiBzY2hlbWEgdGltZSBmb3JtYXQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjc2V0dXAKICAgICAgICAgKi8KICAgICAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuc2VwYXJhdG9yKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuc2VwYXJhdG9yID0gIiwiOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtdGFnJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRWYWx1ZQogICAgICAgICAqLwogICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHZhbCA9IHRoaXMuYmFzZSgpOwogICAgICAgICAgICBpZiAodmFsID09PSAiIikgewogICAgICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWwuc3BsaXQodGhpcy5vcHRpb25zLnNlcGFyYXRvcik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNzZXRWYWx1ZQogICAgICAgICAqLwogICAgICAgIHNldFZhbHVlOiBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgaWYgKHZhbCA9PT0gIiIpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5iYXNlKHZhbC5qb2luKHRoaXMub3B0aW9ucy5zZXBhcmF0b3IpKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNvbkJsdXIKICAgICAgICAgKi8KICAgICAgICBvbkJsdXI6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGUpOwoKICAgICAgICAgICAgdmFyIHZhbHMgPSB0aGlzLmdldFZhbHVlKCk7CgogICAgICAgICAgICB2YXIgdHJpbW1lZCA9IFtdOwoKICAgICAgICAgICAgJC5lYWNoKHZhbHMsIGZ1bmN0aW9uKGksIHYpIHsKICAgICAgICAgICAgICAgIGlmICh2LnRyaW0oKSAhPT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICB0cmltbWVkLnB1c2godi50cmltKCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUodHJpbW1lZCk7CgogICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0U2NoZW1hT2ZPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgInNlcGFyYXRvciI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlNlcGFyYXRvciIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJTZXBhcmF0b3IgdXNlZCB0byBzcGxpdCB0YWdzLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjoiLCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRPcHRpb25zRm9yT3B0aW9ucwogICAgICAgICAqLwogICAgICAgIGdldE9wdGlvbnNGb3JPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgImZpZWxkcyI6IHsKICAgICAgICAgICAgICAgICAgICAic2VwYXJhdG9yIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRUaXRsZQogICAgICAgICAqLwogICAgICAgIGdldFRpdGxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJUYWcgRmllbGQiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RGVzY3JpcHRpb24KICAgICAgICAgKi8KICAgICAgICBnZXREZXNjcmlwdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiVGV4dCBmaWVsZCBmb3IgZW50ZXJpbmcgbGlzdCBvZiB0YWdzIHNlcGFyYXRlZCBieSBkZWxpbWl0ZXIuIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAidGFnIjsKICAgICAgICB9Ly9fX0VORF9PRl9CVUlMREVSX0hFTFBFUlMKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3RlckZpZWxkQ2xhc3MoInRhZyIsIEFscGFjYS5GaWVsZHMuVGFnRmllbGQpOwp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLlRpbWVGaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuVGltZUZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBUaW1lIGNvbnRyb2wgZm9yIEpTT04gc2NoZW1hIHRpbWUgZm9ybWF0LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IGRhdGEgRmllbGQgZGF0YS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBGaWVsZCBvcHRpb25zLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBGaWVsZCB2aWV3LgogICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbm5lY3Rvcn0gY29ubmVjdG9yIEZpZWxkIGNvbm5lY3Rvci4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI3NldHVwCiAgICAgICAgICovCiAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmJhc2UoKTsKCiAgICAgICAgICAgIGlmICghdGhpcy5vcHRpb25zLnRpbWVGb3JtYXQpIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy50aW1lRm9ybWF0ID0gImhoOm1tOnNzIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMudGltZUZvcm1hdFJlZ2V4KSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMudGltZUZvcm1hdFJlZ2V4ID0gL14oKFswLTFdWzAtOV0pfChbMl1bMC0zXSkpOihbMC01XVswLTldKTooWzAtNV1bMC05XSkkLzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKEFscGFjYS5pc0VtcHR5KHRoaXMub3B0aW9ucy5tYXNrU3RyaW5nKSkgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLm1hc2tTdHJpbmcgPSAiOTk6OTk6OTkiOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtdGltZScpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CgogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNvbkNoYW5nZQogICAgICAgICAqLwogICAgICAgIG9uQ2hhbmdlOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZSgpOwogICAgICAgICAgICB0aGlzLnJlZnJlc2hWYWxpZGF0aW9uU3RhdGUoKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2hhbmRsZVZhbGl0aW1lCiAgICAgICAgICovCiAgICAgICAgaGFuZGxlVmFsaWRhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYmFzZVN0YXR1cyA9IHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgdmFyIHZhbEluZm8gPSB0aGlzLnZhbGlkYXRpb247CgogICAgICAgICAgICB2YXIgc3RhdHVzID0gdGhpcy5fdmFsaWRhdGVUaW1lRm9ybWF0KCk7CiAgICAgICAgICAgIHZhbEluZm9bImludmFsaWRUaW1lIl0gPSB7CiAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHN0YXR1cyA/ICIiIDogQWxwYWNhLnN1YnN0aXR1dGVUb2tlbnModGhpcy52aWV3LmdldE1lc3NhZ2UoImludmFsaWRUaW1lIiksIFt0aGlzLm9wdGlvbnMudGltZUZvcm1hdF0pLAogICAgICAgICAgICAgICAgInN0YXR1cyI6IHN0YXR1cwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgcmV0dXJuIGJhc2VTdGF0dXMgJiYgdmFsSW5mb1siaW52YWxpZFRpbWUiXVsic3RhdHVzIl07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaXRpbWVzIHRpbWUgZm9ybWF0LgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmIGl0IGlzIGEgdmFsaWQgdGltZSwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZVRpbWVGb3JtYXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLmZpZWxkLnZhbCgpOwogICAgICAgICAgICBpZiAoIXRoaXMuc2NoZW1hLnJlcXVpcmVkICYmIChBbHBhY2EuaXNWYWxFbXB0eSh2YWx1ZSkgfHwgdmFsdWUgPT0gIl9fOl9fOl9fIikpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vdmFsaXRpbWUgdGhlIHRpbWUgd2l0aG91dCB0aGUgaGVscCBvZiB0aW1lcGlja2VyLnBhcnNlVGltZQogICAgICAgICAgICByZXR1cm4gdmFsdWUubWF0Y2godGhpcy5vcHRpb25zLnRpbWVGb3JtYXRSZWdleCk7CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjc2V0VmFsdWUKICAgICAgICAgKi8KICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgIC8vIHNraXAgb3V0IGlmIG5vIHRpbWUKICAgICAgICAgICAgaWYgKHZhbCA9PT0gIiIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFzZSh2YWwpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmJhc2UodmFsKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0U2NoZW1hT2ZTY2hlbWEKICAgICAgICAgKi8KICAgICAgICBnZXRTY2hlbWFPZlNjaGVtYTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICJmb3JtYXQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJGb3JtYXQiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiUHJvcGVydHkgZGF0YSBmb3JtYXQiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6InRpbWUiLAogICAgICAgICAgICAgICAgICAgICAgICAiZW51bSIgOiBbInRpbWUiXSwKICAgICAgICAgICAgICAgICAgICAgICAgInJlYWRvbmx5Ijp0cnVlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0T3B0aW9uc0ZvclNjaGVtYQogICAgICAgICAqLwogICAgICAgIGdldE9wdGlvbnNGb3JTY2hlbWE6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICJmb3JtYXQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRleHQiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0U2NoZW1hT2ZPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgInRpbWVGb3JtYXQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJUaW1lIEZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJUaW1lIGZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogImhoOm1tOnNzIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInRpbWVGb3JtYXRSZWdleCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZvcm1hdCBSZWd1bGFyIEV4cHJlc3Npb24iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiUmVndWxhciBleHByZXNzaW9uIGZvciB2YWxpZGF0aW9uIHRpbWUgZm9ybWF0IiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiAvXigoWzAtMV1bMC05XSl8KFsyXVswLTNdKSk6KFswLTVdWzAtOV0pOihbMC01XVswLTldKSQvCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAibWFza1N0cmluZyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiIDogIjk5Ojk5Ojk5IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldE9wdGlvbnNGb3JPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0Zvck9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICJ0aW1lRm9ybWF0IjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInRpbWVGb3JtYXRSZWdleCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0VGl0bGUKICAgICAgICAgKi8KICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiVGltZSBGaWVsZCI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJGaWVsZCBmb3IgdGltZS4iOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RmllbGRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJ0aW1lIjsKICAgICAgICB9Ly9fX0VORF9PRl9CVUlMREVSX0hFTFBFUlMKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3Rlck1lc3NhZ2VzKHsKICAgICAgICAiaW52YWxpZFRpbWUiOiAiSW52YWxpZCB0aW1lIGZvciBmb3JtYXQgezB9IgogICAgfSk7CiAgICBBbHBhY2EucmVnaXN0ZXJGaWVsZENsYXNzKCJ0aW1lIiwgQWxwYWNhLkZpZWxkcy5UaW1lRmllbGQpOwogICAgQWxwYWNhLnJlZ2lzdGVyRGVmYXVsdEZvcm1hdEZpZWxkTWFwcGluZygidGltZSIsICJ0aW1lIik7Cn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuVXBwZXJDYXNlRmllbGQgPSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZC5leHRlbmQoCiAgICAvKioKICAgICAqIEBsZW5kcyBBbHBhY2EuRmllbGRzLlVwcGVyQ2FzZUZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBDb250cm9sIGZvciB1cHBlciBjYXNlIHRleHQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjcG9zdFJlbmRlcgogICAgICAgICAqLwogICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLXVwcGVyY2FzZScpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CgogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI3NldFZhbHVlCiAgICAgICAgICovCiAgICAgICAgc2V0VmFsdWU6IGZ1bmN0aW9uKHZhbCkgewoKICAgICAgICAgICAgdmFyIHVwcGVyVmFsdWUgPSB2YWwudG9VcHBlckNhc2UoKTsKCiAgICAgICAgICAgIGlmICh1cHBlclZhbHVlICE9IHRoaXMuZ2V0VmFsdWUoKSkgewogICAgICAgICAgICAgICAgdGhpcy5iYXNlKHVwcGVyVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI29uS2V5UHJlc3MKICAgICAgICAgKi8KICAgICAgICBvbktleVByZXNzOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZShlKTsKCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICBBbHBhY2EubGF0ZXIoMjUsIHRoaXMsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIHYgPSBfdGhpcy5nZXRWYWx1ZSgpOwogICAgICAgICAgICAgICAgX3RoaXMuc2V0VmFsdWUodik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFRpdGxlCiAgICAgICAgICovCiAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIlVwcGVyY2FzZSBUZXh0IjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldERlc2NyaXB0aW9uCiAgICAgICAgICovCiAgICAgICAgZ2V0RGVzY3JpcHRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIlRleHQgZmllbGQgZm9yIHVwcGVyY2FzZSB0ZXh0LiI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRGaWVsZFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gInVwcGVyY2FzZSI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJGaWVsZENsYXNzKCJ1cHBlcmNhc2UiLCBBbHBhY2EuRmllbGRzLlVwcGVyQ2FzZUZpZWxkKTsKICAgIEFscGFjYS5yZWdpc3RlckRlZmF1bHRGb3JtYXRGaWVsZE1hcHBpbmcoInVwcGVyY2FzZSIsICJ1cHBlcmNhc2UiKTsKCn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuV3lzaXd5Z0ZpZWxkID0gQWxwYWNhLkZpZWxkcy5UZXh0QXJlYUZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuV3lzaXd5Z0ZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkZpZWxkcy5UZXh0QXJlYUZpZWxkCiAgICAgICAgICoKICAgICAgICAgKiBAY2xhc3MgV1lTSVdZRyBjb250cm9sIGZvciBjaHVuayBvZiB0ZXh0LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IGRhdGEgRmllbGQgZGF0YS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBGaWVsZCBvcHRpb25zLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBGaWVsZCB2aWV3LgogICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbm5lY3Rvcn0gY29ubmVjdG9yIEZpZWxkIGNvbm5lY3Rvci4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKCiAgICAgICAgICAgIHRoaXMuY29udHJvbHNDb25maWcgPSB7fTsKICAgICAgICAgICAgdGhpcy5jb250cm9sc0NvbmZpZy5zaW1wbGUgPSB7CiAgICAgICAgICAgICAgICAiaHRtbCI6IHsgInZpc2libGUiOiB0cnVlIH0sCiAgICAgICAgICAgICAgICAiY3JlYXRlTGluayI6IHsgInZpc2libGUiOiBmYWxzZSB9LAogICAgICAgICAgICAgICAgInVuTGluayI6IHsgInZpc2libGUiOiBmYWxzZSB9LAogICAgICAgICAgICAgICAgImgxIjogeyAidmlzaWJsZSI6IGZhbHNlIH0sCiAgICAgICAgICAgICAgICAiaDIiOiB7ICJ2aXNpYmxlIjogZmFsc2UgfSwKICAgICAgICAgICAgICAgICJoMyI6IHsgInZpc2libGUiOiBmYWxzZSB9LAogICAgICAgICAgICAgICAgImluZGVudCI6IHsgInZpc2libGUiOiBmYWxzZSB9LAogICAgICAgICAgICAgICAgImluc2VydEhvcml6b250YWxSdWxlIjogeyAidmlzaWJsZSI6IGZhbHNlIH0sCiAgICAgICAgICAgICAgICAiaW5zZXJ0SW1hZ2UiOiB7ICJ2aXNpYmxlIjogZmFsc2UgfSwKICAgICAgICAgICAgICAgICJpbnNlcnRPcmRlcmVkTGlzdCI6IHsgInZpc2libGUiOiBmYWxzZSB9LAogICAgICAgICAgICAgICAgImluc2VydFRhYmxlIjogeyAidmlzaWJsZSI6IGZhbHNlIH0sCiAgICAgICAgICAgICAgICAiaW5zZXJ0VW5vcmRlcmVkTGlzdCI6IHsgInZpc2libGUiOiBmYWxzZSB9LAogICAgICAgICAgICAgICAgImp1c3RpZnlDZW50ZXIiOiB7ICJ2aXNpYmxlIjogZmFsc2UgfSwKICAgICAgICAgICAgICAgICJqdXN0aWZ5RnVsbCI6IHsgInZpc2libGUiOiBmYWxzZSB9LAogICAgICAgICAgICAgICAgImp1c3RpZnlMZWZ0IjogeyAidmlzaWJsZSI6IGZhbHNlIH0sCiAgICAgICAgICAgICAgICAianVzdGlmeVJpZ2h0IjogeyAidmlzaWJsZSI6IGZhbHNlIH0sCiAgICAgICAgICAgICAgICAib3V0ZGVudCI6IHsgInZpc2libGUiOiBmYWxzZSB9LAogICAgICAgICAgICAgICAgInJlZG8iOiB7ICJ2aXNpYmxlIjogZmFsc2UgfSwKICAgICAgICAgICAgICAgICJyZW1vdmVGb3JtYXQiOiB7ICJ2aXNpYmxlIjogZmFsc2UgfSwKICAgICAgICAgICAgICAgICJzdWJzY3JpcHQiOiB7ICJ2aXNpYmxlIjogZmFsc2UgfSwKICAgICAgICAgICAgICAgICJzdXBlcnNjcmlwdCI6IHsgInZpc2libGUiOiBmYWxzZSB9LAogICAgICAgICAgICAgICAgInVuZG8iOiB7ICJ2aXNpYmxlIjogZmFsc2UgfSwKICAgICAgICAgICAgICAgICJjb2RlIjogeyAidmlzaWJsZSI6IGZhbHNlIH0sCiAgICAgICAgICAgICAgICAic3RyaWtlVGhyb3VnaCI6IHsgInZpc2libGUiOiBmYWxzZSB9CiAgICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRBcmVhRmllbGQjc2V0dXAKICAgICAgICAgKi8KICAgICAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgLy8gaW5zdGFudGlhdGVkIHBsdWdpbiByZWZlcmVuY2UKICAgICAgICAgICAgdGhpcy5wbHVnaW4gPSBudWxsOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRBcmVhRmllbGQjcG9zdFJlbmRlcgogICAgICAgICAqLwogICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgLy8gc2VlIGlmIHdlIGNhbiByZW5kZXIgald5c2l3eWcKICAgICAgICAgICAgICAgIGlmIChzZWxmLmZpZWxkICYmICQud3lzaXd5ZykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgd3lzaXd5Z09wdGlvbnMgPSBzZWxmLm9wdGlvbnMud3lzaXd5ZyA/IHNlbGYub3B0aW9ucy53eXNpd3lnIDoge307CgogICAgICAgICAgICAgICAgICAgIGlmICh3eXNpd3lnT3B0aW9ucy5jb250cm9scykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Yod3lzaXd5Z09wdGlvbnMuY29udHJvbHMpID09PSAic3RyaW5nIikKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd3lzaXd5Z09wdGlvbnMuY29udHJvbHMgPSBzZWxmLmNvbnRyb2xzQ29uZmlnW3d5c2l3eWdPcHRpb25zLmNvbnRyb2xzXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghd3lzaXd5Z09wdGlvbnMuY29udHJvbHMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd3lzaXd5Z09wdGlvbnMuY29udHJvbHMgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5vbkRlbWFuZCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYub3V0ZXJFbC5maW5kKCJ0ZXh0YXJlYSIpLm1vdXNlb3ZlcihmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXNlbGYucGx1Z2luKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucGx1Z2luID0gJCh0aGlzKS53eXNpd3lnKHd5c2l3eWdPcHRpb25zKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5vdXRlckVsLmZpbmQoIi53eXNpd3lnIikubW91c2VvdXQoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5wbHVnaW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucGx1Z2luLnd5c2l3eWcoJ2Rlc3Ryb3knKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5wbHVnaW4gPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucGx1Z2luID0gc2VsZi5maWVsZC53eXNpd3lnKHd5c2l3eWdPcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHNlbGYub3V0ZXJFbC5maW5kKCIud3lzaXd5ZyIpLm1vdXNlb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRhdGEgPSBfdGhpcy5nZXRWYWx1ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnJlZnJlc2hWYWxpZGF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtd3lzaXd5ZycpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICB9LC8vX19CVUlMREVSX0hFTFBFUlMKCQkKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRyb2xGaWVsZCNnZXRTY2hlbWFPZk9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRTY2hlbWFPZk9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAid3lzaXd5ZyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkVkaXRvciBvcHRpb25zIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIk9wdGlvbnMgdGhhdCBhcmUgc3VwcG9ydGVkIGJ5IHRoZSA8YSBocmVmPSdodHRwczovL2dpdGh1Yi5jb20vYWt6aGFuL2p3eXNpd3lnJz5qUXVlcnkgV1lTSVdZRyBwbHVnaW48L2E+LiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImFueSIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJvbkRlbWFuZCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIk9uIERlbWFuZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJJZiB0cnVlLCBXWVNJV1lHIGVkaXRvciB3aWxsIG9ubHkgYmUgZW5hYmxlZCB3aGVuIHRoZSBmaWVsZCBpcyBob3ZlcmVkLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRyb2xGaWVsZCNnZXRPcHRpb25zRm9yT3B0aW9ucwogICAgICAgICAqLwogICAgICAgIGdldE9wdGlvbnNGb3JPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgImZpZWxkcyI6IHsKICAgICAgICAgICAgICAgICAgICAid3lzaXd5ZyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYW55IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgIm9uRGVtYW5kIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJyaWdodExhYmVsIjogIk1ha2UgdGhlIGVkaXRvciBvbi1kZW1hbmQ/IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCgkJLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRBcmVhRmllbGQjZ2V0VGl0bGUKCQkgKi8KCQlnZXRUaXRsZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAiV3lzaXd5ZyBFZGl0b3IiOwoJCX0sCgkJCgkJLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRBcmVhRmllbGQjZ2V0RGVzY3JpcHRpb24KCQkgKi8KCQlnZXREZXNjcmlwdGlvbjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAiV3lzaXd5ZyBlZGl0b3IgZm9yIG11bHRpLWxpbmUgdGV4dCB3aGljaCBpcyBiYXNlZCBvbiBBa3poYW4gQWJkdWxpbidzIDxhIGhyZWY9J2h0dHBzOi8vZ2l0aHViLmNvbS9ha3poYW4vand5c2l3eWcnPmpRdWVyeSBXWVNJV1lHIHBsdWdpbjwvYT4uIjsKCQl9LAoKCQkvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEFyZWFGaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRGaWVsZFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gInd5c2l3eWciOwogICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgfSk7CiAgICAKICAgIEFscGFjYS5yZWdpc3RlckZpZWxkQ2xhc3MoInd5c2l3eWciLCBBbHBhY2EuRmllbGRzLld5c2l3eWdGaWVsZCk7CiAgICAKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5TdGF0ZUZpZWxkID0gQWxwYWNhLkZpZWxkcy5TZWxlY3RGaWVsZC5leHRlbmQoCiAgICAvKioKICAgICAqIEBsZW5kcyBBbHBhY2EuRmllbGRzLlN0YXRlRmllbGQucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuRmllbGRzLlRleHRGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIFN0YXRlIENvbnRyb2wKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNzZXR1cAogICAgICAgICAqLwogICAgICAgIHNldHVwOiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIC8vIGRlZmF1bHRzCiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNVbmRlZmluZWQodGhpcy5vcHRpb25zLmNhcGl0YWxpemUpKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuY2FwaXRhbGl6ZSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNVbmRlZmluZWQodGhpcy5vcHRpb25zLmluY2x1ZGVTdGF0ZXMpKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuaW5jbHVkZVN0YXRlcyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKEFscGFjYS5pc1VuZGVmaW5lZCh0aGlzLm9wdGlvbnMuaW5jbHVkZVRlcnJpdG9yaWVzKSkgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmluY2x1ZGVUZXJyaXRvcmllcyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKEFscGFjYS5pc1VuZGVmaW5lZCh0aGlzLm9wdGlvbnMuZm9ybWF0KSkgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmZvcm1hdCA9ICJuYW1lIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gdmFsaWRhdGUgc2V0dGluZ3MKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5mb3JtYXQgPT0gIm5hbWUiIHx8IHRoaXMub3B0aW9ucy5mb3JtYXQgPT0gImNvZGUiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyB2YWxpZCBmb3JtYXRzCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBBbHBhY2EubG9nRXJyb3IoIlRoZSBjb25maWd1cmVkIHN0YXRlIGZvcm1hdDogIiArIHRoaXMub3B0aW9ucy5mb3JtYXQgKyAiIGlzIG5vdCBhIGxlZ2FsIHZhbHVlIFtuYW1lLCBjb2RlXSIpOwoKICAgICAgICAgICAgICAgIC8vIGRlZmF1bHQgdG8gbmFtZSBmb3JtYXQKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5mb3JtYXQgPSAibmFtZSI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGNvbmZpZ3VyZQogICAgICAgICAgICB2YXIgaG9sZGluZ3MgPSBBbHBhY2EucmV0cmlldmVVU0hvbGRpbmdzKAogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmluY2x1ZGVTdGF0ZXMsCiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuaW5jbHVkZVRlcnJpdG9yaWVzLAogICAgICAgICAgICAgICAgKHRoaXMub3B0aW9ucy5mb3JtYXQgPT0gImNvZGUiKSwKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5jYXBpdGFsaXplKTsKCiAgICAgICAgICAgIHRoaXMuc2NoZW1hWyJlbnVtIl0gPSBob2xkaW5ncy5rZXlzOwogICAgICAgICAgICB0aGlzLm9wdGlvbnMub3B0aW9uTGFiZWxzID0gaG9sZGluZ3MudmFsdWVzOwoKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtc3RhdGUnKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwoKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNoYW5kbGVWYWxpZGF0ZQogICAgICAgICAqLwogICAgICAgIGhhbmRsZVZhbGlkYXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGJhc2VTdGF0dXMgPSB0aGlzLmJhc2UoKTsKCiAgICAgICAgICAgIC8vIG5vIGFkZGl0aW9uYWwgdmFsaWRhdGlvbgoKICAgICAgICAgICAgcmV0dXJuIGJhc2VTdGF0dXM7CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRTY2hlbWFPZk9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRTY2hlbWFPZk9wdGlvbnM6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgImZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJIb3cgdG8gcmVwcmVzZW50IHRoZSBzdGF0ZSB2YWx1ZXMgaW4gdGhlIHNlbGVjdG9yIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiAibmFtZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJlbnVtIjpbIm5hbWUiLCAiY29kZSJdLAogICAgICAgICAgICAgICAgICAgICAgICAicmVhZG9ubHkiOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiY2FwaXRhbGl6ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkNhcGl0YWxpemUiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiV2hldGhlciB0aGUgdmFsdWVzIHNob3VsZCBiZSBjYXBpdGFsaXplZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAicmVhZG9ubHkiOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiaW5jbHVkZVN0YXRlcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkluY2x1ZGUgU3RhdGVzIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIldoZXRoZXIgdG8gaW5jbHVkZSB0aGUgc3RhdGVzIG9mIHRoZSBVbml0ZWQgU3RhdGVzIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgInJlYWRvbmx5IjogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImluY2x1ZGVUZXJyaXRvcmllcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkluY2x1ZGUgVGVycml0b3JpZXMiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiV2hldGhlciB0byBpbmNsdWRlIHRoZSB0ZXJyaXRvcmllcyBvZiB0aGUgVW5pdGVkIFN0YXRlcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICJyZWFkb25seSI6IHRydWUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0T3B0aW9uc0Zvck9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgImZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJjYXBpdGFsaXplIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJpbmNsdWRlU3RhdGVzIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJpbmNsdWRlVGVycml0b3JpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRUaXRsZQogICAgICAgICAqLwogICAgICAgIGdldFRpdGxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJTdGF0ZSBGaWVsZCI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJQcm92aWRlcyBhIGRyb3Bkb3duIHNlbGVjdG9yIG9mIHN0YXRlcyBhbmQvb3IgdGVycml0b3JpZXMgaW4gdGhlIFVuaXRlZCBTdGF0ZXMsIGtleWVkIGJ5IHRoZWlyIHR3by1jaGFyYWN0ZXIgY29kZS4iOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RmllbGRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJzdGF0ZSI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJGaWVsZENsYXNzKCJzdGF0ZSIsIEFscGFjYS5GaWVsZHMuU3RhdGVGaWVsZCk7CiAgICBBbHBhY2EucmVnaXN0ZXJEZWZhdWx0Rm9ybWF0RmllbGRNYXBwaW5nKCJzdGF0ZSIsICJzdGF0ZSIpOwoKICAgIC8qKgogICAgICogSGVscGVyIGZ1bmN0aW9uIHRvIHJldHJpZXZlIHRoZSBob2xkaW5ncyBvZiBVUyBzdGF0ZXMgYW5kIHRlcnJpdG9yaWVzLgogICAgICoKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gaW5jbHVkZVN0YXRlcyB3aGV0aGVyIHRvIGluY2x1ZGUgVVMgc3RhdGVzCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IGluY2x1ZGVUZXJyaXRvcmllcyB3aGV0aGVyIHRvIGluY2x1ZGUgVVMgdGVycml0b3JpZXMKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gY29kZVZhbHVlIHdoZXRoZXIgdG8gaGFuZCBiYWNrIFVTIGhvbGRpbmcgY29kZXMgKGluc3RlYWQgb2YgbmFtZXMpCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IGNhcGl0YWxpemUgd2hldGhlciB0byBjYXBpdGFsaXplIHRoZSB2YWx1ZXMgaGFuZGVkIGJhY2sKICAgICAqCiAgICAgKiBAdHlwZSB7T2JqZWN0fSBhbiBvYmplY3QgY29udGFpbmluZyAia2V5cyIgYW5kICJ2YWx1ZXMiLCBib3RoIG9mIHdoaWNoIGFyZSBhcnJheXMuCiAgICAgKi8KICAgIEFscGFjYS5yZXRyaWV2ZVVTSG9sZGluZ3MgPSBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdmFyIGhvbGRpbmdzID0gW107CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIkFya2Fuc2FzIiwKICAgICAgICAgICAgImNvZGUiOiAiQUsiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiQWxhYmFtYSIsCiAgICAgICAgICAgICJjb2RlIjogIkFMIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIkFtZXJpY2FuIFNhbW9hIiwKICAgICAgICAgICAgImNvZGUiOiAiQVMiLAogICAgICAgICAgICAic3RhdGUiOiBmYWxzZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IHRydWUKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiQXJpem9uYSIsCiAgICAgICAgICAgICJjb2RlIjogIkFSIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIkNhbGlmb3JuaWEiLAogICAgICAgICAgICAiY29kZSI6ICJDQSIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJDb2xvcmFkbyIsCiAgICAgICAgICAgICJjb2RlIjogIkNPIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIkNvbm5lY3RpY3V0IiwKICAgICAgICAgICAgImNvZGUiOiAiQ1QiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiRGVsYXdhcmUiLAogICAgICAgICAgICAiY29kZSI6ICJERSIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJEaXN0aWN0IG9mIENvbHVtYmlhIiwKICAgICAgICAgICAgImNvZGUiOiAiREMiLAogICAgICAgICAgICAic3RhdGUiOiBmYWxzZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IHRydWUKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiRmVkZXJhdGVkIFN0YXRlcyBvZiBNaWNyb25lc2lhIiwKICAgICAgICAgICAgImNvZGUiOiAiRk0iLAogICAgICAgICAgICAic3RhdGUiOiBmYWxzZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IHRydWUKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiRmxvcmlkYSIsCiAgICAgICAgICAgICJjb2RlIjogIkZMIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIkdlb3JnaWEiLAogICAgICAgICAgICAiY29kZSI6ICJHQSIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJHdWFtIiwKICAgICAgICAgICAgImNvZGUiOiAiR1UiLAogICAgICAgICAgICAic3RhdGUiOiBmYWxzZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IHRydWUKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiR2VvcmdpYSIsCiAgICAgICAgICAgICJjb2RlIjogIkdBIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIkhhd2FpaSIsCiAgICAgICAgICAgICJjb2RlIjogIkhJIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIklkYWhvIiwKICAgICAgICAgICAgImNvZGUiOiAiSUQiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiSWxsaW5vaXMiLAogICAgICAgICAgICAiY29kZSI6ICJJTCIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJJbmRpYW5hIiwKICAgICAgICAgICAgImNvZGUiOiAiSU4iLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiSW93YSIsCiAgICAgICAgICAgICJjb2RlIjogIklBIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIkthbnNhcyIsCiAgICAgICAgICAgICJjb2RlIjogIktTIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIktlbnR1Y2t5IiwKICAgICAgICAgICAgImNvZGUiOiAiS1kiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiTG91aXNpYW5hIiwKICAgICAgICAgICAgImNvZGUiOiAiTEEiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiTWFpbmUiLAogICAgICAgICAgICAiY29kZSI6ICJNRSIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJNYXJzaGFsbCBJc2xhbmRzIiwKICAgICAgICAgICAgImNvZGUiOiAiTUgiLAogICAgICAgICAgICAic3RhdGUiOiBmYWxzZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IHRydWUKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiTWFyeWxhbmQiLAogICAgICAgICAgICAiY29kZSI6ICJNRCIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJNYXNzYWNodXNldHRzIiwKICAgICAgICAgICAgImNvZGUiOiAiTUEiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiTWljaGlnYW4iLAogICAgICAgICAgICAiY29kZSI6ICJNSSIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJNaW5uZXNvdGEiLAogICAgICAgICAgICAiY29kZSI6ICJNTiIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJNaXNzaXNzaXBwaSIsCiAgICAgICAgICAgICJjb2RlIjogIk1TIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIk1pc3NvdXJpIiwKICAgICAgICAgICAgImNvZGUiOiAiTU8iLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiTW9udGFuYSIsCiAgICAgICAgICAgICJjb2RlIjogIk1UIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIk5lYnJhc2thIiwKICAgICAgICAgICAgImNvZGUiOiAiTkUiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiTmV2YWRhIiwKICAgICAgICAgICAgImNvZGUiOiAiTlYiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiTmV3IEhhbXBzaGlyZSIsCiAgICAgICAgICAgICJjb2RlIjogIk5IIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIk5ldyBKZXJzZXkiLAogICAgICAgICAgICAiY29kZSI6ICJOSiIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJOZXcgTWV4aWNvIiwKICAgICAgICAgICAgImNvZGUiOiAiTk0iLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiTmV3IFlvcmsiLAogICAgICAgICAgICAiY29kZSI6ICJOWSIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJOb3J0aCBDYXJvbGluYSIsCiAgICAgICAgICAgICJjb2RlIjogIk5DIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIk5vcnRoIERha290YSIsCiAgICAgICAgICAgICJjb2RlIjogIk5EIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIk5vcnRoZXJuIE1hcmlhbmEgSXNsYW5kcyIsCiAgICAgICAgICAgICJjb2RlIjogIk1QIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIk9oaW8iLAogICAgICAgICAgICAiY29kZSI6ICJPSCIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJPa2xhaG9tYSIsCiAgICAgICAgICAgICJjb2RlIjogIk9LIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIk9yZWdvbiIsCiAgICAgICAgICAgICJjb2RlIjogIk9SIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIlBhbGF1IiwKICAgICAgICAgICAgImNvZGUiOiAiUFciLAogICAgICAgICAgICAic3RhdGUiOiBmYWxzZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IHRydWUKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiUGVubnN5bHZhbmlhIiwKICAgICAgICAgICAgImNvZGUiOiAiUEEiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiUHVlcnRvIFJpY28iLAogICAgICAgICAgICAiY29kZSI6ICJQUiIsCiAgICAgICAgICAgICJzdGF0ZSI6IGZhbHNlLAogICAgICAgICAgICAidGVycml0b3J5IjogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJSaG9kZSBJc2xhbmQiLAogICAgICAgICAgICAiY29kZSI6ICJSSSIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJTb3V0aCBDYXJvbGluYSIsCiAgICAgICAgICAgICJjb2RlIjogIlNDIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIlNvdXRoIERha290YSIsCiAgICAgICAgICAgICJjb2RlIjogIlNEIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIlRlbm5lc3NlZSIsCiAgICAgICAgICAgICJjb2RlIjogIlROIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIlRleGFzIiwKICAgICAgICAgICAgImNvZGUiOiAiVFgiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiVXRhaCIsCiAgICAgICAgICAgICJjb2RlIjogIlVUIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIlZlcm1vbnQiLAogICAgICAgICAgICAiY29kZSI6ICJWVCIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJWaXJnaW4gSXNsYW5kcyIsCiAgICAgICAgICAgICJjb2RlIjogIlZJIiwKICAgICAgICAgICAgInN0YXRlIjogZmFsc2UsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIlZpcmdpbmlhIiwKICAgICAgICAgICAgImNvZGUiOiAiVkEiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiV2FzaGluZ3RvbiIsCiAgICAgICAgICAgICJjb2RlIjogIldBIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIldlc3QgVmlyZ2luaWEiLAogICAgICAgICAgICAiY29kZSI6ICJXViIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJXaXNjb25zaW4iLAogICAgICAgICAgICAiY29kZSI6ICJXSSIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJXeW9taW5nIiwKICAgICAgICAgICAgImNvZGUiOiAiV1kiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGluY2x1ZGVTdGF0ZXMsIGluY2x1ZGVUZXJyaXRvcmllcywgY29kZVZhbHVlLCBjYXBpdGFsaXplKSB7CgogICAgICAgICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgICAgICAgICAgImtleXMiOiBbXSwKICAgICAgICAgICAgICAgICJ2YWx1ZXMiOiBbXQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBob2xkaW5ncy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGtlZXAgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICBpZiAoaG9sZGluZ3NbaV0uc3RhdGUgJiYgaW5jbHVkZVN0YXRlcykgewogICAgICAgICAgICAgICAgICAgIGtlZXAgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChob2xkaW5nc1tpXS50ZXJyaXRvcnkgJiYgaW5jbHVkZVRlcnJpdG9yaWVzKSB7CiAgICAgICAgICAgICAgICAgICAga2VlcCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGtlZXApIHsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IGhvbGRpbmdzW2ldLmNvZGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gaG9sZGluZ3NbaV0ubmFtZTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvZGVWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGhvbGRpbmdzW2ldLmNvZGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChjYXBpdGFsaXplKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5rZXlzLnB1c2goa2V5KTsKICAgICAgICAgICAgICAgICAgICByZXN1bHQudmFsdWVzLnB1c2godmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH07CiAgICB9KCk7Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLkNvdW50cnlGaWVsZCA9IEFscGFjYS5GaWVsZHMuU2VsZWN0RmllbGQuZXh0ZW5kKAogICAgLyoqCiAgICAgKiBAbGVuZHMgQWxwYWNhLkZpZWxkcy5Db3VudHJ5RmllbGQucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuRmllbGRzLlRleHRGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIENvdW50cnkgQ29udHJvbAogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IGRhdGEgRmllbGQgZGF0YS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBGaWVsZCBvcHRpb25zLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBGaWVsZCB2aWV3LgogICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbm5lY3Rvcn0gY29ubmVjdG9yIEZpZWxkIGNvbm5lY3Rvci4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI3NldHVwCiAgICAgICAgICovCiAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgLy8gZGVmYXVsdHMKICAgICAgICAgICAgaWYgKEFscGFjYS5pc1VuZGVmaW5lZCh0aGlzLm9wdGlvbnMuY2FwaXRhbGl6ZSkpIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5jYXBpdGFsaXplID0gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuc2NoZW1hWyJlbnVtIl0gPSBbXTsKICAgICAgICAgICAgdGhpcy5vcHRpb25zLm9wdGlvbkxhYmVscyA9IFtdOwoKICAgICAgICAgICAgdmFyIGNvdW50cmllc01hcCA9IHRoaXMudmlldy5nZXRNZXNzYWdlKCJjb3VudHJpZXMiKTsKICAgICAgICAgICAgaWYgKGNvdW50cmllc01hcCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZm9yICh2YXIgY291bnRyeUtleSBpbiBjb3VudHJpZXNNYXApCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zY2hlbWFbImVudW0iXS5wdXNoKGNvdW50cnlLZXkpOwoKICAgICAgICAgICAgICAgICAgICB2YXIgbGFiZWwgPSBjb3VudHJpZXNNYXBbY291bnRyeUtleV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5jYXBpdGFsaXplKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsID0gbGFiZWwudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLm9wdGlvbkxhYmVscy5wdXNoKGxhYmVsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtY291bnRyeScpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CgogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2hhbmRsZVZhbGlkYXRlCiAgICAgICAgICovCiAgICAgICAgaGFuZGxlVmFsaWRhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYmFzZVN0YXR1cyA9IHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgLy8gbm8gYWRkaXRpb25hbCB2YWxpZGF0aW9uCgogICAgICAgICAgICByZXR1cm4gYmFzZVN0YXR1czsKICAgICAgICB9LC8vX19CVUlMREVSX0hFTFBFUlMKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFNjaGVtYU9mT3B0aW9ucwogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mT3B0aW9uczogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAiY2FwaXRhbGl6ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkNhcGl0YWxpemUiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiV2hldGhlciB0aGUgdmFsdWVzIHNob3VsZCBiZSBjYXBpdGFsaXplZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAicmVhZG9ubHkiOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldE9wdGlvbnNGb3JPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0Zvck9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICJjYXBpdGFsaXplIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0VGl0bGUKICAgICAgICAgKi8KICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiQ291bnRyeSBGaWVsZCI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJQcm92aWRlcyBhIGRyb3Bkb3duIHNlbGVjdG9yIG9mIGNvdW50cmllcyBrZXllZCBieSB0aGVpciBJU08zIGNvZGUuICBUaGUgbmFtZXMgb2YgdGhlIGNvdW50cmllcyBhcmUgcmVhZCBmcm9tIHRoZSBJMThOIGJ1bmRsZSBmb3IgdGhlIGN1cnJlbnQgbG9jYWxlLiI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRGaWVsZFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gImNvdW50cnkiOwogICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiY291bnRyeSIsIEFscGFjYS5GaWVsZHMuQ291bnRyeUZpZWxkKTsKICAgIEFscGFjYS5yZWdpc3RlckRlZmF1bHRGb3JtYXRGaWVsZE1hcHBpbmcoImNvdW50cnkiLCAiY291bnRyeSIpOwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5aaXBjb2RlRmllbGQgPSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZC5leHRlbmQoCiAgICAvKioKICAgICAqIEBsZW5kcyBBbHBhY2EuRmllbGRzLlppcGNvZGVGaWVsZC5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkCiAgICAgICAgICoKICAgICAgICAgKiBAY2xhc3MgWmlwY29kZSBDb250cm9sCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjc2V0dXAKICAgICAgICAgKi8KICAgICAgICBzZXR1cDogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICB0aGlzLm9wdGlvbnMuZm9ybWF0ID0gKHRoaXMub3B0aW9ucy5mb3JtYXQgPyB0aGlzLm9wdGlvbnMuZm9ybWF0IDogIm5pbmUiKTsKCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuZm9ybWF0ID09ICJuaW5lIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zY2hlbWEucGF0dGVybiA9IEFscGFjYS5yZWdleHBzWyJ6aXBjb2RlLW5pbmUiXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0aGlzLm9wdGlvbnMuZm9ybWF0ID09ICJmaXZlIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zY2hlbWEucGF0dGVybiA9IEFscGFjYS5yZWdleHBzWyJ6aXBjb2RlLWZpdmUiXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIEFscGFjYS5sb2dFcnJvcigiVGhlIGNvbmZpZ3VyZWQgemlwY29kZSBmb3JtYXQ6ICIgKyB0aGlzLm9wdGlvbnMuZm9ybWF0ICsgIiBpcyBub3QgYSBsZWdhbCB2YWx1ZSBbZml2ZSwgbmluZV0iKTsKCiAgICAgICAgICAgICAgICAvLyBkZWZhdWx0IHRvIG5pbmUgZm9ybWF0CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuZm9ybWF0ID0gIm5pbmUiOwogICAgICAgICAgICAgICAgdGhpcy5zY2hlbWEucGF0dGVybiA9IEFscGFjYS5yZWdleHBzWyJ6aXBjb2RlLW5pbmUiXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gc2V0IG1hc2sgc3RyaW5nCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuZm9ybWF0ID09ICJuaW5lIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zWyJtYXNrU3RyaW5nIl0gPSAiOTk5OTktOTk5OSI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5vcHRpb25zLmZvcm1hdCA9PSAiZml2ZSIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9uc1sibWFza1N0cmluZyJdID0gIjk5OTk5IjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtemlwY29kZScpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjaGFuZGxlVmFsaWRhdGUKICAgICAgICAgKi8KICAgICAgICBoYW5kbGVWYWxpZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBiYXNlU3RhdHVzID0gdGhpcy5iYXNlKCk7CgogICAgICAgICAgICB2YXIgdmFsSW5mbyA9IHRoaXMudmFsaWRhdGlvbjsKCiAgICAgICAgICAgIGlmICghdmFsSW5mb1siaW52YWxpZFBhdHRlcm4iXVsic3RhdHVzIl0pIHsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmZvcm1hdCA9PSAibmluZSIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFsSW5mb1siaW52YWxpZFBhdHRlcm4iXVsibWVzc2FnZSJdID0gdGhpcy52aWV3LmdldE1lc3NhZ2UoImludmFsaWRaaXBjb2RlRm9ybWF0TmluZSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5vcHRpb25zLmZvcm1hdCA9PSAiZml2ZSIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFsSW5mb1siaW52YWxpZFBhdHRlcm4iXVsibWVzc2FnZSJdID0gdGhpcy52aWV3LmdldE1lc3NhZ2UoImludmFsaWRaaXBjb2RlRm9ybWF0Rml2ZSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gYmFzZVN0YXR1czsKICAgICAgICB9LC8vX19CVUlMREVSX0hFTFBFUlMKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFNjaGVtYU9mT3B0aW9ucwogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mT3B0aW9uczogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAiZm9ybWF0IjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRm9ybWF0IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkhvdyB0byByZXByZXNlbnQgdGhlIHppcGNvZGUgZmllbGQiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6ICJmaXZlIiwKICAgICAgICAgICAgICAgICAgICAgICAgImVudW0iOlsiZml2ZSIsICJuaW5lIl0sCiAgICAgICAgICAgICAgICAgICAgICAgICJyZWFkb25seSI6IHRydWUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0T3B0aW9uc0Zvck9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgImZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0VGl0bGUKICAgICAgICAgKi8KICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiWmlwY29kZSBGaWVsZCI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJQcm92aWRlcyBhIGZpdmUgb3IgbmluZS1kaWdpdGFsIFVTIHppcGNvZGUgY29udHJvbCB3aXRoIHZhbGlkYXRpb24uIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiemlwY29kZSI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJNZXNzYWdlcyh7CiAgICAgICAgImludmFsaWRaaXBjb2RlRm9ybWF0Rml2ZSI6ICJJbnZhbGlkIEZpdmUtRGlnaXQgWmlwY29kZSAoIyMjIyMpIiwKICAgICAgICAiaW52YWxpZFppcGNvZGVGb3JtYXROaW5lIjogIkludmFsaWQgTmluZS1EaWdpdCBaaXBjb2RlICgjIyMjIy0jIyMjKSIKICAgIH0pOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiemlwY29kZSIsIEFscGFjYS5GaWVsZHMuWmlwY29kZUZpZWxkKTsKICAgIEFscGFjYS5yZWdpc3RlckRlZmF1bHRGb3JtYXRGaWVsZE1hcHBpbmcoInppcGNvZGUiLCAiemlwY29kZSIpOwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5VUkxGaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuVVJMRmllbGQucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuRmllbGRzLlRleHRGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIFVSTCBDb250cm9sCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjc2V0dXAKICAgICAgICAgKi8KICAgICAgICBzZXR1cDogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICB0aGlzLnNjaGVtYS5wYXR0ZXJuID0gQWxwYWNhLnJlZ2V4cHMudXJsOwogICAgICAgICAgICB0aGlzLnNjaGVtYS5mb3JtYXQgPSAidXJpIjsKCiAgICAgICAgICAgIHRoaXMuYmFzZSgpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjcG9zdFJlbmRlcgogICAgICAgICAqLwogICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLXVybCcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CgogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2hhbmRsZVZhbGlkYXRlCiAgICAgICAgICovCiAgICAgICAgaGFuZGxlVmFsaWRhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYmFzZVN0YXR1cyA9IHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgdmFyIHZhbEluZm8gPSB0aGlzLnZhbGlkYXRpb247CgogICAgICAgICAgICBpZiAoIXZhbEluZm9bImludmFsaWRQYXR0ZXJuIl1bInN0YXR1cyJdKSB7CgogICAgICAgICAgICAgICAgdmFsSW5mb1siaW52YWxpZFBhdHRlcm4iXVsibWVzc2FnZSJdID0gdGhpcy52aWV3LmdldE1lc3NhZ2UoImludmFsaWRVUkxGb3JtYXQiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGJhc2VTdGF0dXM7CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0VGl0bGUKICAgICAgICAgKi8KICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiVVJMIEZpZWxkIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldERlc2NyaXB0aW9uCiAgICAgICAgICovCiAgICAgICAgZ2V0RGVzY3JpcHRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIlByb3ZpZGVzIGEgdGV4dCBjb250cm9sIHdpdGggdmFsaWRhdGlvbiBmb3IgYW4gaW50ZXJuZXQgd2ViIGFkZHJlc3MuIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAidXJsIjsKICAgICAgICB9Ly9fX0VORF9PRl9CVUlMREVSX0hFTFBFUlMKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3Rlck1lc3NhZ2VzKHsKICAgICAgICAiaW52YWxpZFVSTEZvcm1hdCI6ICJUaGUgVVJMIHByb3ZpZGVkIGlzIG5vdCBhIHZhbGlkIHdlYiBhZGRyZXNzLiIKICAgIH0pOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygidXJsIiwgQWxwYWNhLkZpZWxkcy5VUkxGaWVsZCk7CiAgICBBbHBhY2EucmVnaXN0ZXJEZWZhdWx0Rm9ybWF0RmllbGRNYXBwaW5nKCJ1cmwiLCAidXJsIik7Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLlVwbG9hZEZpZWxkID0gQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQuZXh0ZW5kKAogICAgLyoqCiAgICAgKiBAbGVuZHMgQWxwYWNhLkZpZWxkcy5VcGxvYWRGaWVsZC5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5GaWVsZHMuT2JqZWN0RmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBVcGxvYWQgRmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNzZXR1cAogICAgICAgICAqLwogICAgICAgIHNldHVwOiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgdGhpcy5jb250cm9sRmllbGRUZW1wbGF0ZURlc2NyaXB0b3IgPSB0aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJjb250cm9sRmllbGRVcGxvYWQiKTsKICAgICAgICAgICAgdGhpcy51cGxvYWREZXNjcmlwdG9yID0gc2VsZi52aWV3LmdldFRlbXBsYXRlRGVzY3JpcHRvcigiY29udHJvbEZpZWxkVXBsb2FkX3VwbG9hZCIpOwogICAgICAgICAgICB0aGlzLmRvd25sb2FkRGVzY3JpcHRvciA9IHNlbGYudmlldy5nZXRUZW1wbGF0ZURlc2NyaXB0b3IoImNvbnRyb2xGaWVsZFVwbG9hZF9kb3dubG9hZCIpOwoKICAgICAgICAgICAgaWYgKHR5cGVvZihzZWxmLm9wdGlvbnMubXVsdGlwbGUpID09ICJ1bmRlZmluZWQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzZWxmLm9wdGlvbnMubXVsdGlwbGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGVvZihzZWxmLm9wdGlvbnMuc2hvd1VwbG9hZFByZXZpZXcpID09ICJ1bmRlZmluZWQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzZWxmLm9wdGlvbnMuc2hvd1VwbG9hZFByZXZpZXcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRyb2xGaWVsZCNyZW5kZXJGaWVsZAogICAgICAgICAqLwogICAgICAgIHJlbmRlckZpZWxkOiBmdW5jdGlvbihvblN1Y2Nlc3MpIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBzZWxmLmZpZWxkID0gJChzZWxmLmZpZWxkKS5maW5kKCIuYWxwYWNhLWZpbGV1cGxvYWQtaW5wdXQtaGlkZGVuIik7CgogICAgICAgICAgICAgICAgaWYgKG9uU3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgIG9uU3VjY2VzcygpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjcG9zdFJlbmRlcgogICAgICAgICAqLwogICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLXVwbG9hZCcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHNlbGYuaGFuZGxlUG9zdFJlbmRlcihzZWxmLmZpZWxkQ29udGFpbmVyLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBoYW5kbGVQb3N0UmVuZGVyOiBmdW5jdGlvbihlbCwgY2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB2YXIgdXBsb2FkVGVtcGxhdGVGdW5jdGlvbiA9IGZ1bmN0aW9uKGRhdGEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBBbHBhY2EudG1wbChzZWxmLnVwbG9hZERlc2NyaXB0b3IsIHsKICAgICAgICAgICAgICAgICAgICBvOiBkYXRhCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgIHZhciBkb3dubG9hZFRlbXBsYXRlRnVuY3Rpb24gPSBmdW5jdGlvbihkYXRhKQogICAgICAgICAgICAgewogICAgICAgICAgICAgICAgIHJldHVybiBBbHBhY2EudG1wbChzZWxmLmRvd25sb2FkRGVzY3JpcHRvciwgewogICAgICAgICAgICAgICAgICAgICBvOiBkYXRhCiAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gZmlsZSB1cGxvYWQgY29uZmlnCiAgICAgICAgICAgIHZhciBmaWxlVXBsb2FkQ29uZmlnID0ge307CgogICAgICAgICAgICAvLyBkZWZhdWx0cwogICAgICAgICAgICBmaWxlVXBsb2FkQ29uZmlnWyJkYXRhVHlwZSJdID0gImpzb24iOwogICAgICAgICAgICBmaWxlVXBsb2FkQ29uZmlnWyJ1cGxvYWRUZW1wbGF0ZUlkIl0gPSBudWxsOwogICAgICAgICAgICBmaWxlVXBsb2FkQ29uZmlnWyJ1cGxvYWRUZW1wbGF0ZSJdID0gdXBsb2FkVGVtcGxhdGVGdW5jdGlvbjsKICAgICAgICAgICAgZmlsZVVwbG9hZENvbmZpZ1siZG93bmxvYWRUZW1wbGF0ZUlkIl0gPSBudWxsOwogICAgICAgICAgICBmaWxlVXBsb2FkQ29uZmlnWyJkb3dubG9hZFRlbXBsYXRlIl0gPSBkb3dubG9hZFRlbXBsYXRlRnVuY3Rpb247CiAgICAgICAgICAgIGZpbGVVcGxvYWRDb25maWdbImZpbGVzQ29udGFpbmVyIl0gPSAkKGVsKS5maW5kKCIuZmlsZXMiKTsKICAgICAgICAgICAgZmlsZVVwbG9hZENvbmZpZ1siZHJvcFpvbmUiXSA9ICQoZWwpLmZpbmQoIi5maWxldXBsb2FkLWFjdGl2ZS16b25lIik7CiAgICAgICAgICAgIGZpbGVVcGxvYWRDb25maWdbInVybCJdID0gIi8iOwogICAgICAgICAgICBmaWxlVXBsb2FkQ29uZmlnWyJtZXRob2QiXSA9ICJwb3N0IjsKICAgICAgICAgICAgZmlsZVVwbG9hZENvbmZpZ1sic2hvd1VwbG9hZFByZXZpZXciXSA9IHNlbGYub3B0aW9ucy5zaG93VXBsb2FkUHJldmlldzsKCiAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMudXBsb2FkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBrIGluIHNlbGYub3B0aW9ucy51cGxvYWQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZmlsZVVwbG9hZENvbmZpZ1trXSA9IHNlbGYub3B0aW9ucy51cGxvYWRba107CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMubXVsdGlwbGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICQoZWwpLmZpbmQoIi5hbHBhY2EtZmlsZXVwbG9hZC1pbnB1dCIpLmF0dHIoIm11bHRpcGxlIiwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAkKGVsKS5maW5kKCIuYWxwYWNhLWZpbGV1cGxvYWQtaW5wdXQiKS5hdHRyKCJuYW1lIiwgc2VsZi5uYW1lICsgIl9maWxlc1tdIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGhpZGUgdGhlIHByb2dyZXNzIGJhciBhdCBmaXJzdAogICAgICAgICAgICAkKGVsKS5maW5kKCIucHJvZ3Jlc3MiKS5jc3MoImRpc3BsYXkiLCAibm9uZSIpOwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIElmIGEgZmlsZSBpcyBiZWluZyB1cGxvYWRlZCwgc2hvdyB0aGUgcHJvZ3Jlc3MgYmFyLiAgT3RoZXJ3aXNlLCBoaWRlIGl0LgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0gZQogICAgICAgICAgICAgKiBAcGFyYW0gZGF0YQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZmlsZVVwbG9hZENvbmZpZ1sicHJvZ3Jlc3NhbGwiXSA9IGZ1bmN0aW9uIChlLCBkYXRhKSB7CgogICAgICAgICAgICAgICAgdmFyIHNob3dQcm9ncmVzc0JhciA9IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKGRhdGEubG9hZGVkIDwgZGF0YS50b3RhbCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBzaG93UHJvZ3Jlc3NCYXIgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHNob3dQcm9ncmVzc0JhcikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAkKGVsKS5maW5kKCIucHJvZ3Jlc3MiKS5jc3MoImRpc3BsYXkiLCAiYmxvY2siKTsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJvZ3Jlc3MgPSBwYXJzZUludChkYXRhLmxvYWRlZCAvIGRhdGEudG90YWwgKiAxMDAsIDEwKTsKICAgICAgICAgICAgICAgICAgICAkKCcjcHJvZ3Jlc3MgLnByb2dyZXNzLWJhcicpLmNzcygKICAgICAgICAgICAgICAgICAgICAgICAgJ3dpZHRoJywKICAgICAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3MgKyAnJScKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICQoZWwpLmZpbmQoIi5wcm9ncmVzcyIpLmNzcygiZGlzcGxheSIsICJub25lIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBhbGxvdyBmb3IgZXh0ZW5zaW9uCiAgICAgICAgICAgIHNlbGYuYXBwbHlDb25maWd1cmF0aW9uKGZpbGVVcGxvYWRDb25maWcpOwoKICAgICAgICAgICAgLy8gaW5zdGFudGlhdGUgdGhlIGNvbnRyb2wKICAgICAgICAgICAgdmFyIGZpbGVVcGxvYWQgPSBzZWxmLmZpbGVVcGxvYWQgPSAkKGVsKS5maW5kKCcuYWxwYWNhLWZpbGV1cGxvYWQtaW5wdXQnKS5maWxldXBsb2FkKGZpbGVVcGxvYWRDb25maWcpOwoKICAgICAgICAgICAgLy8gV2hlbiBmaWxlIHVwbG9hZCBvZiBhIGZpbGUgY29tcGV0ZXMsIHdlIG9mZmVyIHRoZSBjaGFuY2UgdG8gYWRqdXN0IHRoZSBkYXRhIGFoZWFkIG9mIEZpbGVVcGxvYWQKICAgICAgICAgICAgLy8gZ2V0dGluZyBpdC4gIFRoaXMgaXMgdXNlZnVsIGZvciBjYXNlcyB3aGVyZSB5b3UgY2FuJ3QgY2hhbmdlIHRoZSBzZXJ2ZXIgc2lkZSBKU09OIGJ1dCBjb3VsZCBkbwogICAgICAgICAgICAvLyBhIGxpdHRsZSBiaXQgb2YgbWFnaWMgaW4gdGhlIGNsaWVudC4KICAgICAgICAgICAgZmlsZVVwbG9hZC5iaW5kRmlyc3QoImZpbGV1cGxvYWRkb25lIiwgZnVuY3Rpb24oZSwgZGF0YSkgewoKICAgICAgICAgICAgICAgIHZhciBlbmhhbmNlRmlsZXMgPSBzZWxmLm9wdGlvbnMuZW5oYW5jZUZpbGVzOwogICAgICAgICAgICAgICAgaWYgKGVuaGFuY2VGaWxlcykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBlbmhhbmNlRmlsZXMoZmlsZVVwbG9hZENvbmZpZywgZGF0YSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5lbmhhbmNlRmlsZXMoZmlsZVVwbG9hZENvbmZpZywgZGF0YSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gY29weSBiYWNrIGRvd24gaW50byBkYXRhLmZpbGVzCiAgICAgICAgICAgICAgICBkYXRhLmZpbGVzID0gZGF0YS5yZXN1bHQuZmlsZXM7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gV2hlbiBmaWxlcyBhcmUgc3VibWl0dGVkLCB0aGUgInByb3BlcnRpZXMiIGFuZCAicGFyYW1ldGVycyIgb3B0aW9ucyBtYXAgYXJlIGVzcGVjaWFsbHkgdHJlYXRlZAogICAgICAgICAgICAvLyBhbmQgYXJlIHdyaXR0ZW4gaW50byBwcm9wZXJ0eTxpbmRleD5fXzxrZXk+IGFuZCBwYXJhbTxpbmRleD5fX2tleSBlbnRyaWVzIGluIHRoZSBmb3JtIGRhdGEuCiAgICAgICAgICAgIC8vIFRoaXMgYWxsb3dzIGZvciBtdWx0aS1wYXJ0IHJlY2VpdmVycyB0byBnZXQgdmFsdWVzIG9uIGEgcGVyLWZpbGUgYmFzaXMuCiAgICAgICAgICAgIC8vIFBsYW5zIGFyZSB0byBhbGxvdyB0b2tlbiBzdWJzdGl0dXRpb24gYW5kIG90aGVyIGNsaWVudC1zaWRlIHRyZWF0bWVudCBhaGVhZCBvZiBwb3N0aW5nLgogICAgICAgICAgICBmaWxlVXBsb2FkLmJpbmRGaXJzdCgiZmlsZXVwbG9hZHN1Ym1pdCIsIGZ1bmN0aW9uKGUsIGRhdGEpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zWyJwcm9wZXJ0aWVzIl0pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgJC5lYWNoKGRhdGEuZmlsZXMsIGZ1bmN0aW9uKGluZGV4LCBmaWxlKSB7CgogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gc2VsZi5vcHRpb25zWyJwcm9wZXJ0aWVzIl0pCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcm9wZXJ0eU5hbWUgPSAicHJvcGVydHkiICsgaW5kZXggKyAiX18iICsga2V5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByb3BlcnR5VmFsdWUgPSBzZWxmLm9wdGlvbnNbInByb3BlcnRpZXMiXVtrZXldOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRva2VuIHN1YnN0aXR1dGlvbnMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnR5VmFsdWUgPSBzZWxmLmFwcGx5VG9rZW5TdWJzdGl0dXRpb25zKHByb3BlcnR5VmFsdWUsIGluZGV4LCBmaWxlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWRhdGEuZm9ybURhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmZvcm1EYXRhID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5mb3JtRGF0YVtwcm9wZXJ0eU5hbWVdID0gcHJvcGVydHlWYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnNbInBhcmFtZXRlcnMiXSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAkLmVhY2goZGF0YS5maWxlcywgZnVuY3Rpb24oaW5kZXgsIGZpbGUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBzZWxmLm9wdGlvbnNbInBhcmFtZXRlcnMiXSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmFtTmFtZSA9ICJwYXJhbSIgKyBpbmRleCArICJfXyIgKyBrZXk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyYW1WYWx1ZSA9IHNlbGYub3B0aW9uc1sicGFyYW1ldGVycyJdW2tleV07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdG9rZW4gc3Vic3RpdHV0aW9ucwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1WYWx1ZSA9IHNlbGYuYXBwbHlUb2tlblN1YnN0aXR1dGlvbnMocGFyYW1WYWx1ZSwgaW5kZXgsIGZpbGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZGF0YS5mb3JtRGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuZm9ybURhdGEgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmZvcm1EYXRhW3BhcmFtTmFtZV0gPSBwYXJhbVZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIFdoZW4gZmlsZXMgYXJlIHVwbG9hZGVkLCB3ZSBhZGp1c3QgdGhlIHZhbHVlIG9mIHRoZSBmaWVsZC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGZpbGVVcGxvYWQuYmluZCgiZmlsZXVwbG9hZGRvbmUiLCBmdW5jdGlvbihlLCBkYXRhKSB7CgogICAgICAgICAgICAgICAgLy8gZXhpc3RpbmcKICAgICAgICAgICAgICAgIHZhciBhcnJheSA9IHNlbGYuZ2V0VmFsdWUoKTsKCiAgICAgICAgICAgICAgICB2YXIgZiA9IGZ1bmN0aW9uKGkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGkgPT0gZGF0YS5maWxlcy5sZW5ndGgpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBkb25lCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2V0VmFsdWUoYXJyYXkpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBzZWxmLmNvbnZlcnRGaWxlVG9EZXNjcmlwdG9yKGRhdGEuZmlsZXNbaV0sIGZ1bmN0aW9uKGVyciwgZGVzY3JpcHRvcikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVzY3JpcHRvcikKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkucHVzaChkZXNjcmlwdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBmKGkrMSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZigwKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBhbGxvdyBmb3IgZXh0ZW5zaW9uCiAgICAgICAgICAgIHNlbGYuYXBwbHlCaW5kaW5ncyhmaWxlVXBsb2FkLCBlbCk7CgogICAgICAgICAgICAvLyBhbGxvdyBmb3IgcHJlbG9hZGluZyBvZiBkb2N1bWVudHMKICAgICAgICAgICAgc2VsZi5wcmVsb2FkKGZpbGVVcGxvYWQsIGVsLCBmdW5jdGlvbihmaWxlcykgewoKICAgICAgICAgICAgICAgIGlmIChmaWxlcykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZm9ybSA9ICQoc2VsZi5maWVsZENvbnRhaW5lcikuZmluZCgnLmFscGFjYS1maWxldXBsb2FkLWlucHV0Jyk7CiAgICAgICAgICAgICAgICAgICAgJChmb3JtKS5maWxldXBsb2FkKCdvcHRpb24nLCAnZG9uZScpLmNhbGwoZm9ybSwgJC5FdmVudCgnZG9uZScpLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZXM6IGZpbGVzCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgc2VsZi5hZnRlclByZWxvYWQoZmlsZVVwbG9hZCwgZWwsIGZpbGVzLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBhcHBseVRva2VuU3Vic3RpdHV0aW9uczogZnVuY3Rpb24odGV4dCwgaW5kZXgsIGZpbGUpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdG9rZW5zID0gewogICAgICAgICAgICAgICAgImluZGV4IjogaW5kZXgsCiAgICAgICAgICAgICAgICAibmFtZSI6IGZpbGUubmFtZSwKICAgICAgICAgICAgICAgICJzaXplIjogZmlsZS5zaXplLAogICAgICAgICAgICAgICAgInVybCI6IGZpbGUudXJsLAogICAgICAgICAgICAgICAgInRodW1ibmFpbFVybCI6IGZpbGUudGh1bWJuYWlsVXJsCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBzdWJzdGl0dXRlIGFueSB0b2tlbnMKICAgICAgICAgICAgdmFyIHggPSAtMTsKICAgICAgICAgICAgdmFyIGIgPSAwOwogICAgICAgICAgICBkbwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB4ID0gdGV4dC5pbmRleE9mKCJ7IiwgYik7CiAgICAgICAgICAgICAgICBpZiAoeCA+IC0xKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciB5ID0gdGV4dC5pbmRleE9mKCJ9IiwgeCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHkgPiAtMSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IHRleHQuc3Vic3RyaW5nKHggKyBjYXIubGVuZ3RoLCB5KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXBsYWNlbWVudCA9IHRva2Vuc1t0b2tlbl07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXBsYWNlbWVudCkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRleHQuc3Vic3RyaW5nKDAsIHgpICsgcmVwbGFjZW1lbnQgKyB0ZXh0LnN1YnN0cmluZyh5KzEpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBiID0geSArIDE7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlKHggPiAtMSk7CgogICAgICAgICAgICByZXR1cm4gdGV4dDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZW1vdmVzIGEgZGVzY3JpcHRvciB3aXRoIHRoZSBnaXZlbiBpZCBmcm9tIHRoZSB2YWx1ZSBzZXQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gaWQKICAgICAgICAgKi8KICAgICAgICByZW1vdmVWYWx1ZTogZnVuY3Rpb24oaWQpCiAgICAgICAgewogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB2YXIgYXJyYXkgPSBzZWxmLmdldFZhbHVlKCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChhcnJheVtpXS5pZCA9PSBpZCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBhcnJheS5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNlbGYuc2V0VmFsdWUoYXJyYXkpOwogICAgICAgIH0sCgoKICAgICAgICAvKioKICAgICAgICAgKiBFeHRlbnNpb24gcG9pbnQgZm9yIGFkZGluZyBwcm9wZXJ0aWVzIGFuZCBjYWxsYmFja3MgdG8gdGhlIGZpbGUgdXBsb2FkIGNvbmZpZy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBmaWxlVXBsb2FkY29uZmlnCiAgICAgICAgICovCiAgICAgICAgYXBwbHlDb25maWd1cmF0aW9uOiBmdW5jdGlvbihmaWxlVXBsb2FkY29uZmlnKQogICAgICAgIHsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBFeHRlbnNpb24gcG9pbnQgZm9yIGJpbmRpbmcgZXZlbnQgaGFuZGxlcnMgdG8gZmlsZSB1cGxvYWQgaW5zdGFuY2UuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gZmlsZVVwbG9hZAogICAgICAgICAqLwogICAgICAgIGFwcGx5QmluZGluZ3M6IGZ1bmN0aW9uKGZpbGVVcGxvYWQpCiAgICAgICAgewogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENvbnZlcnRzIGZyb20gYSBmaWxlIHRvIGEgc3RvcmFnZSBkZXNjcmlwdG9yLgogICAgICAgICAqCiAgICAgICAgICogQSBkZXNjcmlwdG9yIGxvb2tzIGxpa2U6CiAgICAgICAgICoKICAgICAgICAgKiAgICAgIHsKICAgICAgICAgKiAgICAgICAgICAiaWQiOiAiIgogICAgICAgICAqICAgICAgICAgIC4uLgogICAgICAgICAqICAgICAgfQogICAgICAgICAqCiAgICAgICAgICogQSBkZXNjcmlwdG9yIG1heSBjb250YWluIGFkZGl0aW9uYWwgcHJvcGVydGllcyBhcyBuZWVkZWQgYnkgdGhlIHVuZGVybHlpbmcgc3RvcmFnZSBpbXBsZW1lbnRhdGlvbgogICAgICAgICAqIHNvIGFzIHRvIHJldHJpZXZlIG1ldGFkYXRhIGFib3V0IHRoZSBkZXNjcmliZWQgZmlsZS4KICAgICAgICAgKgogICAgICAgICAqIEFzc3VtcHRpb24gaXMgdGhhdCB0aGUgdW5kZXJseWluZyBwZXJzaXN0ZW5jZSBtZWNoYW5pc20gbWF5IG5lZWQgdG8gYmUgY29uc3VsdGVkLiAgVGh1cywgdGhpcyBpcyBhc3luYy4KICAgICAgICAgKgogICAgICAgICAqIEJ5IGRlZmF1bHQsIHRoZSBkZXNjcmlwdG9yIG1pbWljcyB0aGUgZmlsZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBmaWxlCiAgICAgICAgICogQHBhcmFtIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGVzY3JpcHRvcikKICAgICAgICAgKi8KICAgICAgICBjb252ZXJ0RmlsZVRvRGVzY3JpcHRvcjogZnVuY3Rpb24oZmlsZSwgY2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB2YXIgZGVzY3JpcHRvciA9IHsKICAgICAgICAgICAgICAgICJpZCI6IGZpbGUuaWQsCiAgICAgICAgICAgICAgICAibmFtZSI6IGZpbGUubmFtZSwKICAgICAgICAgICAgICAgICJzaXplIjogZmlsZS5zaXplLAogICAgICAgICAgICAgICAgInVybCI6IGZpbGUudXJsLAogICAgICAgICAgICAgICAgInRodW1ibmFpbFVybCI6ZmlsZS50aHVtYm5haWxVcmwsCiAgICAgICAgICAgICAgICAiZGVsZXRlVXJsIjogZmlsZS5kZWxldGVVcmwsCiAgICAgICAgICAgICAgICAiZGVsZXRlVHlwZSI6IGZpbGUuZGVsZXRlVHlwZQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgZGVzY3JpcHRvcik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ29udmVydHMgYSBzdG9yYWdlIGRlc2NyaXB0b3IgdG8gYSBmaWxlLgogICAgICAgICAqCiAgICAgICAgICogQSBmaWxlIGxvb2tzIGxpa2U6CiAgICAgICAgICoKICAgICAgICAgKiAgICAgIHsKICAgICAgICAgKiAgICAgICAgICAiaWQiOiAiIiwKICAgICAgICAgKiAgICAgICAgICAibmFtZSI6ICJwaWN0dXJlMS5qcGciLAogICAgICAgICAqICAgICAgICAgICJzaXplIjogOTAyNjA0LAogICAgICAgICAqICAgICAgICAgICJ1cmwiOiAiaHR0cDpcL1wvZXhhbXBsZS5vcmdcL2ZpbGVzXC9waWN0dXJlMS5qcGciLAogICAgICAgICAqICAgICAgICAgICJ0aHVtYm5haWxVcmwiOiAiaHR0cDpcL1wvZXhhbXBsZS5vcmdcL2ZpbGVzXC90aHVtYm5haWxcL3BpY3R1cmUxLmpwZyIsCiAgICAgICAgICogICAgICAgICAgImRlbGV0ZVVybCI6ICJodHRwOlwvXC9leGFtcGxlLm9yZ1wvZmlsZXNcL3BpY3R1cmUxLmpwZyIsCiAgICAgICAgICogICAgICAgICAgImRlbGV0ZVR5cGUiOiAiREVMRVRFIgogICAgICAgICAqICAgICAgfQogICAgICAgICAqCiAgICAgICAgICogU2luY2UgYW4gdW5kZXJseWluZyBzdG9yYWdlIG1lY2hhbmlzbSBtYXkgYmUgY29uc3VsdGVkLCBhbiBhc3luYyBjYWxsYmFjayBob29rIGlzIHByb3ZpZGVkLgogICAgICAgICAqCiAgICAgICAgICogQnkgZGVmYXVsdCwgdGhlIGRlc2NyaXB0b3IgbWltaWNzIHRoZSBmaWxlLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIGRlc2NyaXB0b3IKICAgICAgICAgKiBAcGFyYW0gY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBmaWxlKQogICAgICAgICAqLwogICAgICAgIGNvbnZlcnREZXNjcmlwdG9yVG9GaWxlOiBmdW5jdGlvbihkZXNjcmlwdG9yLCBjYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBmaWxlID0gewogICAgICAgICAgICAgICAgImlkIjogZGVzY3JpcHRvci5pZCwKICAgICAgICAgICAgICAgICJuYW1lIjogZGVzY3JpcHRvci5uYW1lLAogICAgICAgICAgICAgICAgInNpemUiOiBkZXNjcmlwdG9yLnNpemUsCiAgICAgICAgICAgICAgICAidXJsIjogZGVzY3JpcHRvci51cmwsCiAgICAgICAgICAgICAgICAidGh1bWJuYWlsVXJsIjpkZXNjcmlwdG9yLnRodW1ibmFpbFVybCwKICAgICAgICAgICAgICAgICJkZWxldGVVcmwiOiBkZXNjcmlwdG9yLmRlbGV0ZVVybCwKICAgICAgICAgICAgICAgICJkZWxldGVUeXBlIjogZGVzY3JpcHRvci5kZWxldGVUeXBlCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjYWxsYmFjayhudWxsLCBmaWxlKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBFeHRlbnNpb24gcG9pbnQgZm9yICJlbmhhbmNpbmciIGRhdGEgcmVjZWl2ZWQgZnJvbSB0aGUgcmVtb3RlIHNlcnZlciBhZnRlciB1cGxvYWRzIGhhdmUgYmVlbiBzdWJtaXR0ZWQuCiAgICAgICAgICogVGhpcyBwcm92aWRlcyBhIHBsYWNlIHRvIGNvbnZlcnQgdGhlIGRhdGEucm93cyBiYWNrIGludG8gdGhlIGZvcm1hdCB3aGljaCB0aGUgdXBsb2FkIGNvbnRyb2wgZXhwZWN0cy4KICAgICAgICAgKgogICAgICAgICAqIEV4cGVjdGVkIGZvcm1hdDoKICAgICAgICAgKgogICAgICAgICAqICAgIGRhdGEucmVzdWx0LnJvd3MgPSBbey4uLn1dCiAgICAgICAgICogICAgZGF0YS5yZXN1bHQuZmlsZXMgPSBbewogICAgICAgICAqICAgICAgImlkIjogIiIsCiAgICAgICAgICogICAgICAicGF0aCI6ICIiLAogICAgICAgICAqICAgICAgIm5hbWUiOiAicGljdHVyZTEuanBnIiwKICAgICAgICAgKiAgICAgICJzaXplIjogOTAyNjA0LAogICAgICAgICAqICAgICAgInVybCI6ICJodHRwOlwvXC9leGFtcGxlLm9yZ1wvZmlsZXNcL3BpY3R1cmUxLmpwZyIsCiAgICAgICAgICogICAgICAidGh1bWJuYWlsVXJsIjogImh0dHA6XC9cL2V4YW1wbGUub3JnXC9maWxlc1wvdGh1bWJuYWlsXC9waWN0dXJlMS5qcGciLAogICAgICAgICAqICAgICAgImRlbGV0ZVVybCI6ICJodHRwOlwvXC9leGFtcGxlLm9yZ1wvZmlsZXNcL3BpY3R1cmUxLmpwZyIsCiAgICAgICAgICogICAgICAiZGVsZXRlVHlwZSI6ICJERUxFVEUiKgogICAgICAgICAqICAgIH1dCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gZmlsZVVwbG9hZENvbmZpZwogICAgICAgICAqIEBwYXJhbSByb3cKICAgICAgICAgKi8KICAgICAgICBlbmhhbmNlRmlsZXM6IGZ1bmN0aW9uKGZpbGVVcGxvYWRDb25maWcsIGRhdGEpCiAgICAgICAgewogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFByZWxvYWRzIGRhdGEgZGVzY3JpcHRvcnMgaW50byBmaWxlcy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBmaWxlVXBsb2FkCiAgICAgICAgICogQHBhcmFtIGVsCiAgICAgICAgICogQHBhcmFtIGNhbGxiYWNrCiAgICAgICAgICovCiAgICAgICAgcHJlbG9hZDogZnVuY3Rpb24oZmlsZVVwbG9hZCwgZWwsIGNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgdmFyIGZpbGVzID0gW107CgogICAgICAgICAgICAvLyBub3cgcHJlbG9hZCB3aXRoIGZpbGVzIGJhc2VkIG9uIHByb3BlcnR5IHZhbHVlCiAgICAgICAgICAgIHZhciBkZXNjcmlwdG9ycyA9IHNlbGYuZ2V0VmFsdWUoKTsKCiAgICAgICAgICAgIHZhciBmID0gZnVuY3Rpb24oaSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGkgPT0gZGVzY3JpcHRvcnMubGVuZ3RoKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIGFsbCBkb25lCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZmlsZXMpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBzZWxmLmNvbnZlcnREZXNjcmlwdG9yVG9GaWxlKGRlc2NyaXB0b3JzW2ldLCBmdW5jdGlvbihlcnIsIGZpbGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZmlsZSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVzLnB1c2goZmlsZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGYoaSsxKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwogICAgICAgICAgICBmKDApOwogICAgICAgIH0sCgogICAgICAgIGFmdGVyUHJlbG9hZDogZnVuY3Rpb24oZmlsZVVwbG9hZCwgZWwsIGZpbGVzLCBjYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG92ZXJyaWRlCiAgICAgICAgICoKICAgICAgICAgKiBSZXRyaWV2ZXMgYW4gYXJyYXkgb2YgZGVzY3JpcHRvcnMuCiAgICAgICAgICovCiAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICghdGhpcy5kYXRhKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmRhdGEgPSBbXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGF0YTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAb3ZlcnJpZGUKICAgICAgICAgKgogICAgICAgICAqIFNldHMgYW4gYXJyYXkgb2YgZGVzY3JpcHRvcnMuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gZGF0YQogICAgICAgICAqLwogICAgICAgIHNldFZhbHVlOiBmdW5jdGlvbihkYXRhKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5kYXRhID0gZGF0YTsKICAgICAgICB9LAoKICAgICAgICByZWxvYWQ6IGZ1bmN0aW9uKGNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgdmFyIGRlc2NyaXB0b3JzID0gdGhpcy5nZXRWYWx1ZSgpOwoKICAgICAgICAgICAgdmFyIGZpbGVzID0gW107CgogICAgICAgICAgICB2YXIgZiA9IGZ1bmN0aW9uKGkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChpID09IGRlc2NyaXB0b3JzLmxlbmd0aCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBhbGwgZG9uZQoKICAgICAgICAgICAgICAgICAgICB2YXIgZm9ybSA9ICQoc2VsZi5maWVsZENvbnRhaW5lcikuZmluZCgnLmFscGFjYS1maWxldXBsb2FkLWlucHV0Jyk7CiAgICAgICAgICAgICAgICAgICAgJChmb3JtKS5maWxldXBsb2FkKCdvcHRpb24nLCAnZG9uZScpLmNhbGwoZm9ybSwgJC5FdmVudCgnZG9uZScpLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZXM6IGZpbGVzCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHNlbGYuY29udmVydERlc2NyaXB0b3JUb0ZpbGUoZGVzY3JpcHRvcnNbaV0sIGZ1bmN0aW9uKGVyciwgZmlsZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChmaWxlKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmlsZXMucHVzaChmaWxlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZihpKzEpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGYoMCk7CiAgICAgICAgfSwKICAgICAgICAvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRyb2xGaWVsZCNnZXRUaXRsZQogICAgICAgICAqLwogICAgICAgIGdldFRpdGxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJVcGxvYWQgRmllbGQiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRyb2xGaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJQcm92aWRlcyBhbiB1cGxvYWQgZmllbGQgd2l0aCBzdXBwb3J0IGZvciB0aHVtYm5haWwgcHJldmlldyI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2dldFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJhcnJheSI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAidXBsb2FkIjsKICAgICAgICB9Ly9fX0VORF9PRl9CVUlMREVSX0hFTFBFUlMKICAgIH0pOwoKICAgIHZhciBURU1QTEFURSA9ICcgXAogICAgICAgIDxkaXYgY2xhc3M9ImFscGFjYS1maWxldXBsb2FkLWNvbnRhaW5lciB7e2lmIGNzc0NsYXNzZXN9fSR7Y3NzQ2xhc3Nlc317ey9pZn19Ij4gXAogICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb250YWluZXItZmx1aWQiPiBcCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJyb3ciPiBcCiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29sLW1kLTEyIj4gXAogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJidG4tZ3JvdXAiPiBcCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLWRlZmF1bHQgZmlsZWlucHV0LWJ1dHRvbiI+IFwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8aSBjbGFzcz0iZ2x5cGhpY29uIGdseXBoaWNvbi11cGxvYWQiPjwvaT4gXAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJmaWxldXBsb2FkLWFkZC1idXR0b24iPkNob29zZSBmaWxlcy4uLjwvc3Bhbj4gXAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCBjbGFzcz0iYWxwYWNhLWZpbGV1cGxvYWQtaW5wdXQiIHR5cGU9ImZpbGUiIG5hbWU9IiR7bmFtZX1fZmlsZXMiPiBcCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IGNsYXNzPSJhbHBhY2EtZmlsZXVwbG9hZC1pbnB1dC1oaWRkZW4iIHR5cGU9ImhpZGRlbiIgbmFtZT0iJHtuYW1lfV9maWxlc19oaWRkZW4iPiBcCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2J1dHRvbj4gXAogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4gXAogICAgICAgICAgICAgICAgICAgIDwvZGl2PiBcCiAgICAgICAgICAgICAgICA8L2Rpdj4gXAogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icm93IGFscGFjYS1maWxldXBsb2FkLXdlbGwiPiBcCiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29sLW1kLTEyIGZpbGV1cGxvYWQtYWN0aXZlLXpvbmUiPiBcCiAgICAgICAgICAgICAgICAgICAgICAgIDx0YWJsZSBjbGFzcz0idGFibGUgdGFibGUtc3RyaXBlZCI+IFwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0Ym9keSBjbGFzcz0iZmlsZXMiPiBcCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3Rib2R5PiBcCiAgICAgICAgICAgICAgICAgICAgICAgIDwvdGFibGU+IFwKICAgICAgICAgICAgICAgICAgICAgICAgPHAgYWxpZ249ImNlbnRlciI+Q2xpY2sgdGhlIENob29zZSBidXR0b24gb3IgRHJhZyBhbmQgRHJvcCBmaWxlcyBoZXJlIHRvIHN0YXJ0Li4uPC9wPiBcCiAgICAgICAgICAgICAgICAgICAgPC9kaXY+IFwKICAgICAgICAgICAgICAgIDwvZGl2PiBcCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJyb3ciPiBcCiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29sLW1kLTEyIj4gXAogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGlkPSJwcm9ncmVzcyIgY2xhc3M9InByb2dyZXNzIj4gXAogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icHJvZ3Jlc3MtYmFyIHByb2dyZXNzLWJhci1zdWNjZXNzIj48L2Rpdj4gXAogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4gXAogICAgICAgICAgICAgICAgICAgIDwvZGl2PiBcCiAgICAgICAgICAgICAgICA8L2Rpdj4gXAogICAgICAgICAgICA8L2Rpdj4gXAogICAgICAgIDwvZGl2PiBcCiAgICAnOwoKICAgIHZhciBURU1QTEFURV9VUExPQUQgPSAnIFwKICAgICAgICA8c2NyaXB0IGlkPSJ0ZW1wbGF0ZS11cGxvYWQiIHR5cGU9InRleHQveC10bXBsIj4gXAogICAgICAgIHt7ZWFjaChpLCBmaWxlKSBvLmZpbGVzfX0gXAogICAgICAgICAgICA8dHIgY2xhc3M9InRlbXBsYXRlLXVwbG9hZCBmYWRlIj4gXAogICAgICAgICAgICAgICAge3tpZiBvLm9wdGlvbnMuc2hvd1VwbG9hZFByZXZpZXd9fSBcCiAgICAgICAgICAgICAgICA8dGQgY2xhc3M9InByZXZpZXciPiBcCiAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImZhZGUiPjwvc3Bhbj4gXAogICAgICAgICAgICAgICAgPC90ZD4gXAogICAgICAgICAgICAgICAge3tlbHNlfX0gXAogICAgICAgICAgICAgICAgPHRkPiBcCiAgICAgICAgICAgICAgICA8L3RkPiBcCiAgICAgICAgICAgICAgICB7ey9pZn19IFwKICAgICAgICAgICAgICAgIDx0ZCBjbGFzcz0ibmFtZSI+PHNwYW4+JHtmaWxlLm5hbWV9PC9zcGFuPjwvdGQ+IFwKICAgICAgICAgICAgICAgIDx0ZCBjbGFzcz0ic2l6ZSI+PHNwYW4+JHtmaWxlLnNpemV9PC9zcGFuPjwvdGQ+IFwKICAgICAgICAgICAge3tpZiBmaWxlLmVycm9yfX0gXAogICAgICAgICAgICAgICAgPHRkIGNsYXNzPSJlcnJvciIgY29sc3Bhbj0iMiI+PHNwYW4gY2xhc3M9ImxhYmVsIGxhYmVsLWltcG9ydGFudCI+RXJyb3I8L3NwYW4+ICR7ZmlsZS5lcnJvcn08L3RkPiBcCiAgICAgICAgICAgIHt7ZWxzZX19IFwKICAgICAgICAgICAgICAgIHt7aWYgby5maWxlcy52YWxpZCAmJiAhaX19IFwKICAgICAgICAgICAgICAgIDx0ZD4gXAogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InByb2dyZXNzIHByb2dyZXNzLXN1Y2Nlc3MgcHJvZ3Jlc3Mtc3RyaXBlZCBhY3RpdmUiIHJvbGU9InByb2dyZXNzYmFyIiBhcmlhLXZhbHVlbWluPSIwIiBhcmlhLXZhbHVlbWF4PSIxMDAiIGFyaWEtdmFsdWVub3c9IjAiPiBcCiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InByb2dyZXNzLWJhciIgc3R5bGU9IndpZHRoOjAlOyI+PC9kaXY+XAogICAgICAgICAgICAgICAgICAgIDwvZGl2PiBcCiAgICAgICAgICAgICAgICA8L3RkPiBcCiAgICAgICAgICAgICAgICA8dGQgY2xhc3M9InN0YXJ0Ij5cCiAgICAgICAgICAgICAgICB7e2lmICFvLm9wdGlvbnMuYXV0b1VwbG9hZH19IFwKICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXByaW1hcnkiPiBcCiAgICAgICAgICAgICAgICAgICAgICAgIDxpIGNsYXNzPSJnbHlwaGljb24gZ2x5cGhpY29uLXVwbG9hZCBnbHlwaGljb24td2hpdGUiPjwvaT4gXAogICAgICAgICAgICAgICAgICAgICAgICA8c3Bhbj5TdGFydDwvc3Bhbj4gXAogICAgICAgICAgICAgICAgICAgIDwvYnV0dG9uPiBcCiAgICAgICAgICAgICAgICB7ey9pZn19IFwKICAgICAgICAgICAgICAgIDwvdGQ+IFwKICAgICAgICAgICAgICAgIHt7ZWxzZX19IFwKICAgICAgICAgICAgICAgIDx0ZCBjb2xzcGFuPSIyIj48L3RkPiBcCiAgICAgICAgICAgICAgICA8dGQgY2xhc3M9ImNhbmNlbCI+XAogICAgICAgICAgICAgICAge3tpZiAhaX19IFwKICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXdhcm5pbmciPiBcCiAgICAgICAgICAgICAgICAgICAgICAgIDxpIGNsYXNzPSJnbHlwaGljb24gZ2x5cGhpY29uLWJhbi1jaXJjbGUgZ2x5cGhpY29uLXdoaXRlIj48L2k+IFwKICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4+Q2FuY2VsPC9zcGFuPiBcCiAgICAgICAgICAgICAgICAgICAgPC9idXR0b24+IFwKICAgICAgICAgICAgICAgIHt7L2lmfX0gXAogICAgICAgICAgICAgICAgPC90ZD4gXAogICAgICAgICAgICAgICAge3svaWZ9fSBcCiAgICAgICAgICAgIHt7L2lmfX0gXAogICAgICAgICAgICAgICAgPHRkPjwvdGQ+IFwKICAgICAgICAgICAgPC90cj4gXAogICAgICAgIHt7L2VhY2h9fSBcCiAgICAgICAgPC9zY3JpcHQ+IFwKICAgICc7CgogICAgdmFyIFRFTVBMQVRFX0RPV05MT0FEID0gJyBcCiAgICAgICAgPHNjcmlwdCBpZD0idGVtcGxhdGUtZG93bmxvYWQiIHR5cGU9InRleHQveC10bXBsIj4gXAogICAgICAgIHt7ZWFjaChpLCBmaWxlKSBvLmZpbGVzfX0gXAogICAgICAgICAgICA8dHIgY2xhc3M9InRlbXBsYXRlLWRvd25sb2FkIGZhZGUiPiBcCiAgICAgICAgICAgIHt7aWYgZmlsZS5lcnJvcn19IFwKICAgICAgICAgICAgICAgIDx0ZD48L3RkPiBcCiAgICAgICAgICAgICAgICA8dGQgY2xhc3M9Im5hbWUiPjxzcGFuPiR7ZmlsZS5uYW1lfTwvc3Bhbj48L3RkPiBcCiAgICAgICAgICAgICAgICA8dGQgY2xhc3M9InNpemUiPjxzcGFuPiR7ZmlsZS5zaXplfTwvc3Bhbj48L3RkPiBcCiAgICAgICAgICAgICAgICA8dGQgY2xhc3M9ImVycm9yIiBjb2xzcGFuPSIyIj48c3BhbiBjbGFzcz0ibGFiZWwgbGFiZWwtaW1wb3J0YW50Ij5FcnJvcjwvc3Bhbj4gJHtmaWxlLmVycm9yfTwvdGQ+IFwKICAgICAgICAgICAge3tlbHNlfX0gXAogICAgICAgICAgICAgICAgPHRkIGNsYXNzPSJwcmV2aWV3Ij4gXAogICAgICAgICAgICAgICAge3tpZiBmaWxlLnRodW1ibmFpbFVybH19IFwKICAgICAgICAgICAgICAgICAgICA8YSBocmVmPSIke2ZpbGUudXJsfSIgdGl0bGU9IiR7ZmlsZS5uYW1lfSIgZGF0YS1nYWxsZXJ5PSJnYWxsZXJ5IiBkb3dubG9hZD0iJHtmaWxlLm5hbWV9Ij4gXAogICAgICAgICAgICAgICAgICAgICAgICA8aW1nIHNyYz0iJHtmaWxlLnRodW1ibmFpbFVybH0iPiBcCiAgICAgICAgICAgICAgICAgICAgPC9hPiBcCiAgICAgICAgICAgICAgICB7ey9pZn19IFwKICAgICAgICAgICAgICAgIDwvdGQ+IFwKICAgICAgICAgICAgICAgIDx0ZCBjbGFzcz0ibmFtZSI+IFwKICAgICAgICAgICAgICAgICAgICA8YSBocmVmPSIke2ZpbGUudXJsfSIgdGl0bGU9IiR7ZmlsZS5uYW1lfSIgZGF0YS1nYWxsZXJ5PSIke2ZpbGUudGh1bWJuYWlsVXJsfWdhbGxlcnkiIGRvd25sb2FkPSIke2ZpbGUubmFtZX0iPiR7ZmlsZS5uYW1lfTwvYT4gXAogICAgICAgICAgICAgICAgPC90ZD4gXAogICAgICAgICAgICAgICAgPHRkIGNsYXNzPSJzaXplIj48c3Bhbj4ke2ZpbGUuc2l6ZX08L3NwYW4+PC90ZD4gXAogICAgICAgICAgICAgICAgPHRkIGNvbHNwYW49IjIiPjwvdGQ+IFwKICAgICAgICAgICAge3svaWZ9fSBcCiAgICAgICAgICAgICAgICA8dGQ+IFwKICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJkZWxldGUgYnRuIGJ0bi1kYW5nZXIiIGRhdGEtdHlwZT0iJHtmaWxlLmRlbGV0ZVR5cGV9IiBkYXRhLXVybD0iJHtmaWxlLmRlbGV0ZVVybH0iIHt7aWYgZmlsZS5kZWxldGVXaXRoQ3JlZGVudGlhbHN9fWRhdGEteGhyLWZpZWxkcz0ie1wid2l0aENyZWRlbnRpYWxzXCI6dHJ1ZX0iIHt7L2lmfX0+IFwKICAgICAgICAgICAgICAgICAgICAgICAgPGkgY2xhc3M9ImdseXBoaWNvbiBnbHlwaGljb24tdHJhc2ggZ2x5cGhpY29uLXdoaXRlIj48L2k+IFwKICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4+RGVsZXRlPC9zcGFuPiBcCiAgICAgICAgICAgICAgICAgICAgPC9idXR0b24+IFwKICAgICAgICAgICAgICAgIDwvdGQ+IFwKICAgICAgICAgICAgPC90cj4gXAogICAgICAgIHt7L2VhY2h9fSBcCiAgICAgICAgPC9zY3JpcHQ+IFwKICAgICc7CgogICAgQWxwYWNhLnJlZ2lzdGVyVGVtcGxhdGUoImNvbnRyb2xGaWVsZFVwbG9hZCIsIFRFTVBMQVRFKTsKICAgIEFscGFjYS5yZWdpc3RlclRlbXBsYXRlKCJjb250cm9sRmllbGRVcGxvYWRfdXBsb2FkIiwgVEVNUExBVEVfVVBMT0FEKTsKICAgIEFscGFjYS5yZWdpc3RlclRlbXBsYXRlKCJjb250cm9sRmllbGRVcGxvYWRfZG93bmxvYWQiLCBURU1QTEFURV9ET1dOTE9BRCk7CiAgICBBbHBhY2EucmVnaXN0ZXJGaWVsZENsYXNzKCJ1cGxvYWQiLCBBbHBhY2EuRmllbGRzLlVwbG9hZEZpZWxkKTsKCiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vcHJpdmF0ZS1mYWNlL2pxdWVyeS5iaW5kLWZpcnN0L2Jsb2IvbWFzdGVyL2Rldi9qcXVlcnkuYmluZC1maXJzdC5qcwogICAgLy8ganF1ZXJ5LmJpbmQtZmlyc3QuanMKICAgIChmdW5jdGlvbigkKSB7CiAgICAgICAgdmFyIHNwbGl0VmVyc2lvbiA9ICQuZm4uanF1ZXJ5LnNwbGl0KCIuIik7CiAgICAgICAgdmFyIG1ham9yID0gcGFyc2VJbnQoc3BsaXRWZXJzaW9uWzBdKTsKICAgICAgICB2YXIgbWlub3IgPSBwYXJzZUludChzcGxpdFZlcnNpb25bMV0pOwoKICAgICAgICB2YXIgSlFfTFRfMTcgPSAobWFqb3IgPCAxKSB8fCAobWFqb3IgPT0gMSAmJiBtaW5vciA8IDcpOwoKICAgICAgICBmdW5jdGlvbiBldmVudHNEYXRhKCRlbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBKUV9MVF8xNyA/ICRlbC5kYXRhKCdldmVudHMnKSA6ICQuX2RhdGEoJGVsWzBdKS5ldmVudHM7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBtb3ZlSGFuZGxlclRvVG9wKCRlbCwgZXZlbnROYW1lLCBpc0RlbGVnYXRlZCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBkYXRhID0gZXZlbnRzRGF0YSgkZWwpOwogICAgICAgICAgICB2YXIgZXZlbnRzID0gZGF0YVtldmVudE5hbWVdOwoKICAgICAgICAgICAgaWYgKCFKUV9MVF8xNykgewogICAgICAgICAgICAgICAgdmFyIGhhbmRsZXIgPSBpc0RlbGVnYXRlZCA/IGV2ZW50cy5zcGxpY2UoZXZlbnRzLmRlbGVnYXRlQ291bnQgLSAxLCAxKVswXSA6IGV2ZW50cy5wb3AoKTsKICAgICAgICAgICAgICAgIGV2ZW50cy5zcGxpY2UoaXNEZWxlZ2F0ZWQgPyAwIDogKGV2ZW50cy5kZWxlZ2F0ZUNvdW50IHx8IDApLCAwLCBoYW5kbGVyKTsKCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc0RlbGVnYXRlZCkgewogICAgICAgICAgICAgICAgZGF0YS5saXZlLnVuc2hpZnQoZGF0YS5saXZlLnBvcCgpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGV2ZW50cy51bnNoaWZ0KGV2ZW50cy5wb3AoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG1vdmVFdmVudEhhbmRsZXJzKCRlbGVtcywgZXZlbnRzU3RyaW5nLCBpc0RlbGVnYXRlKSB7CiAgICAgICAgICAgIHZhciBldmVudHMgPSBldmVudHNTdHJpbmcuc3BsaXQoL1xzKy8pOwogICAgICAgICAgICAkZWxlbXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnRzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHB1cmVFdmVudE5hbWUgPSAkLnRyaW0oZXZlbnRzW2ldKS5tYXRjaCgvW15cLl0rL2kpWzBdOwogICAgICAgICAgICAgICAgICAgIG1vdmVIYW5kbGVyVG9Ub3AoJCh0aGlzKSwgcHVyZUV2ZW50TmFtZSwgaXNEZWxlZ2F0ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgJC5mbi5iaW5kRmlyc3QgPSBmdW5jdGlvbigpCiAgICAgICAgewogICAgICAgICAgICB2YXIgYXJncyA9ICQubWFrZUFycmF5KGFyZ3VtZW50cyk7CiAgICAgICAgICAgIHZhciBldmVudHNTdHJpbmcgPSBhcmdzLnNoaWZ0KCk7CgogICAgICAgICAgICBpZiAoZXZlbnRzU3RyaW5nKSB7CiAgICAgICAgICAgICAgICAkLmZuLmJpbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIG1vdmVFdmVudEhhbmRsZXJzKHRoaXMsIGV2ZW50c1N0cmluZyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CgogICAgfSkoJCk7Cgp9KShqUXVlcnkpOwoKCiAgICByZXR1cm4gQWxwYWNhOwoKfSkpOwo=",
                "body": "LyohCkFscGFjYSBWZXJzaW9uIDEuMS4zCgpDb3B5cmlnaHQgMjAxNCBHaXRhbmEgU29mdHdhcmUsIEluYy4KCkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOyAKeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiAKCllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdCAKCWh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMCAKClVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUgCmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsIApXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gClNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgCmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAKCkZvciBtb3JlIGluZm9ybWF0aW9uLCBwbGVhc2UgY29udGFjdCBHaXRhbmEgU29mdHdhcmUsIEluYy4gYXQgdGhpcwphZGRyZXNzOgoKICBpbmZvQGdpdGFuYXNvZnR3YXJlLmNvbQoqLwovKioKICogVU1EIHdyYXBwZXIgZm9yIGNvbXBhdGliaWxpdHkgd2l0aCBicm93c2VyLCBOb2RlIGFuZCBBTUQuCiAqCiAqIEJhc2VkIG9uOgogKiAgIGh0dHBzOi8vZ2l0aHViLmNvbS91bWRqcy91bWQvYmxvYi9tYXN0ZXIvcmV0dXJuRXhwb3J0cy5qcwogKi8KKGZ1bmN0aW9uIChyb290LCBmYWN0b3J5KQp7CiAgICB2YXIgdW1kRW5hYmxlZCA9IHRydWU7CiAgICBpZiAocm9vdCAmJiB0eXBlb2Yocm9vdC51bWQpICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgdW1kRW5hYmxlZCA9IHJvb3QudW1kOwogICAgfQoKICAgIGlmICh1bWRFbmFibGVkICYmIHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykKICAgIHsKICAgICAgICAvLyBOb2RlLiBEb2VzIG5vdCB3b3JrIHdpdGggc3RyaWN0IENvbW1vbkpTLCBidXQKICAgICAgICAvLyBvbmx5IENvbW1vbkpTLWxpa2UgZW52aXJvbm1lbnRzIHRoYXQgc3VwcG9ydCBtb2R1bGUuZXhwb3J0cywKICAgICAgICAvLyBsaWtlIE5vZGUuCiAgICAgICAgLy9tb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkocmVxdWlyZSgnYicpKTsKICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKTsKICAgIH0KICAgIGVsc2UgaWYgKHVtZEVuYWJsZWQgJiYgdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKQogICAgewogICAgICAgIC8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS4KICAgICAgICAvL2RlZmluZShbJ2InXSwgZmFjdG9yeSk7CiAgICAgICAgZGVmaW5lKCdhbHBhY2EnLCBbJ2pxdWVyeScsICdqcXVlcnktdG1wbCcsICdqcXVlcnktdWknXSwgZmFjdG9yeSk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgLy8gQnJvd3NlciBnbG9iYWxzCiAgICAgICAgLy9yb290LnJldHVybkV4cG9ydHMgPSBmYWN0b3J5KHJvb3QuYik7CiAgICAgICAgcm9vdFsiQWxwYWNhIl0gPSBmYWN0b3J5KCk7CiAgICB9Cgp9KHRoaXMsIGZ1bmN0aW9uICgkLCB0bXBsLCBqUXVlcnlVSSwgYWNlKSB7CgogICAgLy91c2UgYiBpbiBzb21lIGZhc2hpb24uCgogICAgLy8gSnVzdCByZXR1cm4gYSB2YWx1ZSB0byBkZWZpbmUgdGhlIG1vZHVsZSBleHBvcnQuCiAgICAvLyBUaGlzIGV4YW1wbGUgcmV0dXJucyBhbiBvYmplY3QsIGJ1dCB0aGUgbW9kdWxlCiAgICAvLyBjYW4gcmV0dXJuIGEgZnVuY3Rpb24gYXMgdGhlIGV4cG9ydGVkIHZhbHVlLgogICAgLy9yZXR1cm4ge307CgogICAgLyohCkFscGFjYSBWZXJzaW9uIDEuMS4zCgpDb3B5cmlnaHQgMjAxNCBHaXRhbmEgU29mdHdhcmUsIEluYy4KCkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOyAKeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiAKCllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdCAKCWh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMCAKClVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUgCmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsIApXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gClNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgCmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAKCkZvciBtb3JlIGluZm9ybWF0aW9uLCBwbGVhc2UgY29udGFjdCBHaXRhbmEgU29mdHdhcmUsIEluYy4gYXQgdGhpcwphZGRyZXNzOgoKICBpbmZvQGdpdGFuYXNvZnR3YXJlLmNvbQoqLwovKgogQmFzZWQgb24gQmFzZS5qcyAxLjFhIChjKSAyMDA2LTIwMTAsIERlYW4gRWR3YXJkcwogVXBkYXRlZCB0byBwYXNzIEpTSGludCBhbmQgY29udmVydGVkIGludG8gYSBtb2R1bGUgYnkgS2VubmV0aCBQb3dlcnMKIExpY2Vuc2U6IGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwCgogR2l0SHViOiBodHRwczovL2dpdGh1Yi5jb20vS2VuUG93ZXJzL0Jhc2UuanMtTW9kdWxlCiAqLwovKmdsb2JhbCBkZWZpbmU6dHJ1ZSBtb2R1bGU6dHJ1ZSovCi8qanNoaW50IGVxZXFlcTp0cnVlKi8KKGZ1bmN0aW9uIChuYW1lLCBnbG9iYWwsIGRlZmluaXRpb24pIHsKLy8gICAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnKSB7Ci8vICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGRlZmluaXRpb24oKTsKLy8gICAgfSBlbHNlIGlmICh0eXBlb2YgZGVmaW5lICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgZGVmaW5lLmFtZCA9PT0gJ29iamVjdCcpIHsKLy8gICAgICAgIGRlZmluZShkZWZpbml0aW9uKTsKLy8gICAgfSBlbHNlIHsKICAgICAgICBnbG9iYWxbbmFtZV0gPSBkZWZpbml0aW9uKCk7Ci8vICAgIH0KfSkoJ0Jhc2UnLCB0aGlzLCBmdW5jdGlvbiAoKSB7CiAgICAvLyBCYXNlIE9iamVjdAogICAgdmFyIEJhc2UgPSBmdW5jdGlvbiAoKSB7fTsKCiAgICAvLyBJbXBsZW1lbnRhdGlvbgogICAgQmFzZS5leHRlbmQgPSBmdW5jdGlvbiAoX2luc3RhbmNlLCBfc3RhdGljKSB7IC8vIHN1YmNsYXNzCiAgICAgICAgdmFyIGV4dGVuZCA9IEJhc2UucHJvdG90eXBlLmV4dGVuZDsKICAgICAgICAvLyBidWlsZCB0aGUgcHJvdG90eXBlCiAgICAgICAgQmFzZS5fcHJvdG90eXBpbmcgPSB0cnVlOwogICAgICAgIHZhciBwcm90byA9IG5ldyB0aGlzKCk7CiAgICAgICAgZXh0ZW5kLmNhbGwocHJvdG8sIF9pbnN0YW5jZSk7CiAgICAgICAgcHJvdG8uYmFzZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgLy8gY2FsbCB0aGlzIG1ldGhvZCBmcm9tIGFueSBvdGhlciBtZXRob2QgdG8gaW52b2tlIHRoYXQgbWV0aG9kJ3MgYW5jZXN0b3IKICAgICAgICB9OwogICAgICAgIGRlbGV0ZSBCYXNlLl9wcm90b3R5cGluZzsKICAgICAgICAvLyBjcmVhdGUgdGhlIHdyYXBwZXIgZm9yIHRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbgogICAgICAgIC8vdmFyIGNvbnN0cnVjdG9yID0gcHJvdG8uY29uc3RydWN0b3IudmFsdWVPZigpOyAvLy1kZWFuCiAgICAgICAgdmFyIGNvbnN0cnVjdG9yID0gcHJvdG8uY29uc3RydWN0b3I7CiAgICAgICAgdmFyIGtsYXNzID0gcHJvdG8uY29uc3RydWN0b3IgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICghQmFzZS5fcHJvdG90eXBpbmcpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9jb25zdHJ1Y3RpbmcgfHwgdGhpcy5jb25zdHJ1Y3RvciA9PT0ga2xhc3MpIHsgLy8gaW5zdGFudGlhdGlvbgogICAgICAgICAgICAgICAgICAgIHRoaXMuX2NvbnN0cnVjdGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5fY29uc3RydWN0aW5nOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhcmd1bWVudHNbMF0gIT09IG51bGwpIHsgLy8gY2FzdGluZwogICAgICAgICAgICAgICAgICAgIHJldHVybiAoYXJndW1lbnRzWzBdLmV4dGVuZCB8fCBleHRlbmQpLmNhbGwoYXJndW1lbnRzWzBdLCBwcm90byk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIC8vIGJ1aWxkIHRoZSBjbGFzcyBpbnRlcmZhY2UKICAgICAgICBrbGFzcy5hbmNlc3RvciA9IHRoaXM7CiAgICAgICAga2xhc3MuZXh0ZW5kID0gdGhpcy5leHRlbmQ7CiAgICAgICAga2xhc3MuZm9yRWFjaCA9IHRoaXMuZm9yRWFjaDsKICAgICAgICBrbGFzcy5pbXBsZW1lbnQgPSB0aGlzLmltcGxlbWVudDsKICAgICAgICBrbGFzcy5wcm90b3R5cGUgPSBwcm90bzsKICAgICAgICBrbGFzcy50b1N0cmluZyA9IHRoaXMudG9TdHJpbmc7CiAgICAgICAga2xhc3MudmFsdWVPZiA9IGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgICAgIHJldHVybiAodHlwZSA9PT0gJ29iamVjdCcpID8ga2xhc3MgOiBjb25zdHJ1Y3Rvci52YWx1ZU9mKCk7CiAgICAgICAgfTsKICAgICAgICBleHRlbmQuY2FsbChrbGFzcywgX3N0YXRpYyk7CiAgICAgICAgLy8gY2xhc3MgaW5pdGlhbGl6YXRpb24KICAgICAgICBpZiAodHlwZW9mIGtsYXNzLmluaXQgPT09ICdmdW5jdGlvbicpIGtsYXNzLmluaXQoKTsKICAgICAgICByZXR1cm4ga2xhc3M7CiAgICB9OwoKICAgIEJhc2UucHJvdG90eXBlID0gewogICAgICAgIGV4dGVuZDogZnVuY3Rpb24gKHNvdXJjZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7IC8vIGV4dGVuZGluZyB3aXRoIGEgbmFtZS92YWx1ZSBwYWlyCiAgICAgICAgICAgICAgICB2YXIgYW5jZXN0b3IgPSB0aGlzW3NvdXJjZV07CiAgICAgICAgICAgICAgICBpZiAoYW5jZXN0b3IgJiYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJykgJiYgLy8gb3ZlcnJpZGluZyBhIG1ldGhvZD8KICAgICAgICAgICAgICAgICAgICAvLyB0aGUgdmFsdWVPZigpIGNvbXBhcmlzb24gaXMgdG8gYXZvaWQgY2lyY3VsYXIgcmVmZXJlbmNlcwogICAgICAgICAgICAgICAgICAgICghYW5jZXN0b3IudmFsdWVPZiB8fCBhbmNlc3Rvci52YWx1ZU9mKCkgIT09IHZhbHVlLnZhbHVlT2YoKSkgJiYgL1xiYmFzZVxiLy50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIC8vIGdldCB0aGUgdW5kZXJseWluZyBtZXRob2QKICAgICAgICAgICAgICAgICAgICB2YXIgbWV0aG9kID0gdmFsdWUudmFsdWVPZigpOwogICAgICAgICAgICAgICAgICAgIC8vIG92ZXJyaWRlCiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmV2aW91cyA9IHRoaXMuYmFzZSB8fCBCYXNlLnByb3RvdHlwZS5iYXNlOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmJhc2UgPSBhbmNlc3RvcjsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJldHVyblZhbHVlID0gbWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYmFzZSA9IHByZXZpb3VzOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmV0dXJuVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAvLyBwb2ludCB0byB0aGUgdW5kZXJseWluZyBtZXRob2QKICAgICAgICAgICAgICAgICAgICB2YWx1ZS52YWx1ZU9mID0gZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICh0eXBlID09PSAnb2JqZWN0JykgPyB2YWx1ZSA6IG1ldGhvZDsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIHZhbHVlLnRvU3RyaW5nID0gQmFzZS50b1N0cmluZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXNbc291cmNlXSA9IHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKHNvdXJjZSkgeyAvLyBleHRlbmRpbmcgd2l0aCBhbiBvYmplY3QgbGl0ZXJhbAogICAgICAgICAgICAgICAgdmFyIGV4dGVuZCA9IEJhc2UucHJvdG90eXBlLmV4dGVuZDsKICAgICAgICAgICAgICAgIC8vIGlmIHRoaXMgb2JqZWN0IGhhcyBhIGN1c3RvbWl6ZWQgZXh0ZW5kIG1ldGhvZCB0aGVuIHVzZSBpdAogICAgICAgICAgICAgICAgaWYgKCFCYXNlLl9wcm90b3R5cGluZyAmJiB0eXBlb2YgdGhpcyAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgIGV4dGVuZCA9IHRoaXMuZXh0ZW5kIHx8IGV4dGVuZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBwcm90byA9IHsKICAgICAgICAgICAgICAgICAgICB0b1NvdXJjZTogbnVsbAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIC8vIGRvIHRoZSAidG9TdHJpbmciIGFuZCBvdGhlciBtZXRob2RzIG1hbnVhbGx5CiAgICAgICAgICAgICAgICB2YXIgaGlkZGVuID0gWydjb25zdHJ1Y3RvcicsICd0b1N0cmluZycsICd2YWx1ZU9mJ107CiAgICAgICAgICAgICAgICAvLyBpZiB3ZSBhcmUgcHJvdG90eXBpbmcgdGhlbiBpbmNsdWRlIHRoZSBjb25zdHJ1Y3RvcgogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IEJhc2UuX3Byb3RvdHlwaW5nID8gMCA6IDE7IGkgPCBoaWRkZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaCA9IGhpZGRlbltpXTsKICAgICAgICAgICAgICAgICAgICBpZiAoc291cmNlW2hdICE9PSBwcm90b1toXSkKICAgICAgICAgICAgICAgICAgICAgICAgZXh0ZW5kLmNhbGwodGhpcywgaCwgc291cmNlW2hdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIGNvcHkgZWFjaCBvZiB0aGUgc291cmNlIG9iamVjdCdzIHByb3BlcnRpZXMgdG8gdGhpcyBvYmplY3QKICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBzb3VyY2UpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXByb3RvW2tleV0pIGV4dGVuZC5jYWxsKHRoaXMsIGtleSwgc291cmNlW2tleV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgIH07CgogICAgLy8gaW5pdGlhbGl6ZQogICAgQmFzZSA9IEJhc2UuZXh0ZW5kKHsKICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLmV4dGVuZChhcmd1bWVudHNbMF0pOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBhbmNlc3RvcjogT2JqZWN0LAogICAgICAgIHZlcnNpb246ICcxLjEnLAogICAgICAgIGZvckVhY2g6IGZ1bmN0aW9uIChvYmplY3QsIGJsb2NrLCBjb250ZXh0KSB7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByb3RvdHlwZVtrZXldID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBibG9jay5jYWxsKGNvbnRleHQsIG9iamVjdFtrZXldLCBrZXksIG9iamVjdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGltcGxlbWVudDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmd1bWVudHNbaV0gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICAvLyBpZiBpdCdzIGEgZnVuY3Rpb24sIGNhbGwgaXQKICAgICAgICAgICAgICAgICAgICBhcmd1bWVudHNbaV0odGhpcy5wcm90b3R5cGUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBhZGQgdGhlIGludGVyZmFjZSB1c2luZyB0aGUgZXh0ZW5kIG1ldGhvZAogICAgICAgICAgICAgICAgICAgIHRoaXMucHJvdG90eXBlLmV4dGVuZChhcmd1bWVudHNbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIFN0cmluZyh0aGlzLnZhbHVlT2YoKSk7CiAgICAgICAgfQogICAgfSk7CgogICAgLy8gUmV0dXJuIEJhc2UgaW1wbGVtZW50YXRpb24KICAgIHJldHVybiBCYXNlOwp9KTsvKgoganNvbjIuanMKIDIwMTItMTAtMDgKCiBQdWJsaWMgRG9tYWluLgoKIE5PIFdBUlJBTlRZIEVYUFJFU1NFRCBPUiBJTVBMSUVELiBVU0UgQVQgWU9VUiBPV04gUklTSy4KCiBTZWUgaHR0cDovL3d3dy5KU09OLm9yZy9qcy5odG1sCgoKIFRoaXMgY29kZSBzaG91bGQgYmUgbWluaWZpZWQgYmVmb3JlIGRlcGxveW1lbnQuCiBTZWUgaHR0cDovL2phdmFzY3JpcHQuY3JvY2tmb3JkLmNvbS9qc21pbi5odG1sCgogVVNFIFlPVVIgT1dOIENPUFkuIElUIElTIEVYVFJFTUVMWSBVTldJU0UgVE8gTE9BRCBDT0RFIEZST00gU0VSVkVSUyBZT1UgRE8KIE5PVCBDT05UUk9MLgoKCiBUaGlzIGZpbGUgY3JlYXRlcyBhIGdsb2JhbCBKU09OIG9iamVjdCBjb250YWluaW5nIHR3byBtZXRob2RzOiBzdHJpbmdpZnkKIGFuZCBwYXJzZS4KCiBKU09OLnN0cmluZ2lmeSh2YWx1ZSwgcmVwbGFjZXIsIHNwYWNlKQogdmFsdWUgICAgICAgYW55IEphdmFTY3JpcHQgdmFsdWUsIHVzdWFsbHkgYW4gb2JqZWN0IG9yIGFycmF5LgoKIHJlcGxhY2VyICAgIGFuIG9wdGlvbmFsIHBhcmFtZXRlciB0aGF0IGRldGVybWluZXMgaG93IG9iamVjdAogdmFsdWVzIGFyZSBzdHJpbmdpZmllZCBmb3Igb2JqZWN0cy4gSXQgY2FuIGJlIGEKIGZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIHN0cmluZ3MuCgogc3BhY2UgICAgICAgYW4gb3B0aW9uYWwgcGFyYW1ldGVyIHRoYXQgc3BlY2lmaWVzIHRoZSBpbmRlbnRhdGlvbgogb2YgbmVzdGVkIHN0cnVjdHVyZXMuIElmIGl0IGlzIG9taXR0ZWQsIHRoZSB0ZXh0IHdpbGwKIGJlIHBhY2tlZCB3aXRob3V0IGV4dHJhIHdoaXRlc3BhY2UuIElmIGl0IGlzIGEgbnVtYmVyLAogaXQgd2lsbCBzcGVjaWZ5IHRoZSBudW1iZXIgb2Ygc3BhY2VzIHRvIGluZGVudCBhdCBlYWNoCiBsZXZlbC4gSWYgaXQgaXMgYSBzdHJpbmcgKHN1Y2ggYXMgJ1x0JyBvciAnJm5ic3A7JyksCiBpdCBjb250YWlucyB0aGUgY2hhcmFjdGVycyB1c2VkIHRvIGluZGVudCBhdCBlYWNoIGxldmVsLgoKIFRoaXMgbWV0aG9kIHByb2R1Y2VzIGEgSlNPTiB0ZXh0IGZyb20gYSBKYXZhU2NyaXB0IHZhbHVlLgoKIFdoZW4gYW4gb2JqZWN0IHZhbHVlIGlzIGZvdW5kLCBpZiB0aGUgb2JqZWN0IGNvbnRhaW5zIGEgdG9KU09OCiBtZXRob2QsIGl0cyB0b0pTT04gbWV0aG9kIHdpbGwgYmUgY2FsbGVkIGFuZCB0aGUgcmVzdWx0IHdpbGwgYmUKIHN0cmluZ2lmaWVkLiBBIHRvSlNPTiBtZXRob2QgZG9lcyBub3Qgc2VyaWFsaXplOiBpdCByZXR1cm5zIHRoZQogdmFsdWUgcmVwcmVzZW50ZWQgYnkgdGhlIG5hbWUvdmFsdWUgcGFpciB0aGF0IHNob3VsZCBiZSBzZXJpYWxpemVkLAogb3IgdW5kZWZpbmVkIGlmIG5vdGhpbmcgc2hvdWxkIGJlIHNlcmlhbGl6ZWQuIFRoZSB0b0pTT04gbWV0aG9kCiB3aWxsIGJlIHBhc3NlZCB0aGUga2V5IGFzc29jaWF0ZWQgd2l0aCB0aGUgdmFsdWUsIGFuZCB0aGlzIHdpbGwgYmUKIGJvdW5kIHRvIHRoZSB2YWx1ZQoKIEZvciBleGFtcGxlLCB0aGlzIHdvdWxkIHNlcmlhbGl6ZSBEYXRlcyBhcyBJU08gc3RyaW5ncy4KCiBEYXRlLnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiAoa2V5KSB7CiBmdW5jdGlvbiBmKG4pIHsKIC8vIEZvcm1hdCBpbnRlZ2VycyB0byBoYXZlIGF0IGxlYXN0IHR3byBkaWdpdHMuCiByZXR1cm4gbiA8IDEwID8gJzAnICsgbiA6IG47CiB9CgogcmV0dXJuIHRoaXMuZ2V0VVRDRnVsbFllYXIoKSAgICsgJy0nICsKIGYodGhpcy5nZXRVVENNb250aCgpICsgMSkgKyAnLScgKwogZih0aGlzLmdldFVUQ0RhdGUoKSkgICAgICArICdUJyArCiBmKHRoaXMuZ2V0VVRDSG91cnMoKSkgICAgICsgJzonICsKIGYodGhpcy5nZXRVVENNaW51dGVzKCkpICAgKyAnOicgKwogZih0aGlzLmdldFVUQ1NlY29uZHMoKSkgICArICdaJzsKIH07CgogWW91IGNhbiBwcm92aWRlIGFuIG9wdGlvbmFsIHJlcGxhY2VyIG1ldGhvZC4gSXQgd2lsbCBiZSBwYXNzZWQgdGhlCiBrZXkgYW5kIHZhbHVlIG9mIGVhY2ggbWVtYmVyLCB3aXRoIHRoaXMgYm91bmQgdG8gdGhlIGNvbnRhaW5pbmcKIG9iamVjdC4gVGhlIHZhbHVlIHRoYXQgaXMgcmV0dXJuZWQgZnJvbSB5b3VyIG1ldGhvZCB3aWxsIGJlCiBzZXJpYWxpemVkLiBJZiB5b3VyIG1ldGhvZCByZXR1cm5zIHVuZGVmaW5lZCwgdGhlbiB0aGUgbWVtYmVyIHdpbGwKIGJlIGV4Y2x1ZGVkIGZyb20gdGhlIHNlcmlhbGl6YXRpb24uCgogSWYgdGhlIHJlcGxhY2VyIHBhcmFtZXRlciBpcyBhbiBhcnJheSBvZiBzdHJpbmdzLCB0aGVuIGl0IHdpbGwgYmUKIHVzZWQgdG8gc2VsZWN0IHRoZSBtZW1iZXJzIHRvIGJlIHNlcmlhbGl6ZWQuIEl0IGZpbHRlcnMgdGhlIHJlc3VsdHMKIHN1Y2ggdGhhdCBvbmx5IG1lbWJlcnMgd2l0aCBrZXlzIGxpc3RlZCBpbiB0aGUgcmVwbGFjZXIgYXJyYXkgYXJlCiBzdHJpbmdpZmllZC4KCiBWYWx1ZXMgdGhhdCBkbyBub3QgaGF2ZSBKU09OIHJlcHJlc2VudGF0aW9ucywgc3VjaCBhcyB1bmRlZmluZWQgb3IKIGZ1bmN0aW9ucywgd2lsbCBub3QgYmUgc2VyaWFsaXplZC4gU3VjaCB2YWx1ZXMgaW4gb2JqZWN0cyB3aWxsIGJlCiBkcm9wcGVkOyBpbiBhcnJheXMgdGhleSB3aWxsIGJlIHJlcGxhY2VkIHdpdGggbnVsbC4gWW91IGNhbiB1c2UKIGEgcmVwbGFjZXIgZnVuY3Rpb24gdG8gcmVwbGFjZSB0aG9zZSB3aXRoIEpTT04gdmFsdWVzLgogSlNPTi5zdHJpbmdpZnkodW5kZWZpbmVkKSByZXR1cm5zIHVuZGVmaW5lZC4KCiBUaGUgb3B0aW9uYWwgc3BhY2UgcGFyYW1ldGVyIHByb2R1Y2VzIGEgc3RyaW5naWZpY2F0aW9uIG9mIHRoZQogdmFsdWUgdGhhdCBpcyBmaWxsZWQgd2l0aCBsaW5lIGJyZWFrcyBhbmQgaW5kZW50YXRpb24gdG8gbWFrZSBpdAogZWFzaWVyIHRvIHJlYWQuCgogSWYgdGhlIHNwYWNlIHBhcmFtZXRlciBpcyBhIG5vbi1lbXB0eSBzdHJpbmcsIHRoZW4gdGhhdCBzdHJpbmcgd2lsbAogYmUgdXNlZCBmb3IgaW5kZW50YXRpb24uIElmIHRoZSBzcGFjZSBwYXJhbWV0ZXIgaXMgYSBudW1iZXIsIHRoZW4KIHRoZSBpbmRlbnRhdGlvbiB3aWxsIGJlIHRoYXQgbWFueSBzcGFjZXMuCgogRXhhbXBsZToKCiB0ZXh0ID0gSlNPTi5zdHJpbmdpZnkoWydlJywge3BsdXJpYnVzOiAndW51bSd9XSk7CiAvLyB0ZXh0IGlzICdbImUiLHsicGx1cmlidXMiOiJ1bnVtIn1dJwoKCiB0ZXh0ID0gSlNPTi5zdHJpbmdpZnkoWydlJywge3BsdXJpYnVzOiAndW51bSd9XSwgbnVsbCwgJ1x0Jyk7CiAvLyB0ZXh0IGlzICdbXG5cdCJlIixcblx0e1xuXHRcdCJwbHVyaWJ1cyI6ICJ1bnVtIlxuXHR9XG5dJwoKIHRleHQgPSBKU09OLnN0cmluZ2lmeShbbmV3IERhdGUoKV0sIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiByZXR1cm4gdGhpc1trZXldIGluc3RhbmNlb2YgRGF0ZSA/CiAnRGF0ZSgnICsgdGhpc1trZXldICsgJyknIDogdmFsdWU7CiB9KTsKIC8vIHRleHQgaXMgJ1siRGF0ZSgtLS1jdXJyZW50IHRpbWUtLS0pIl0nCgoKIEpTT04ucGFyc2UodGV4dCwgcmV2aXZlcikKIFRoaXMgbWV0aG9kIHBhcnNlcyBhIEpTT04gdGV4dCB0byBwcm9kdWNlIGFuIG9iamVjdCBvciBhcnJheS4KIEl0IGNhbiB0aHJvdyBhIFN5bnRheEVycm9yIGV4Y2VwdGlvbi4KCiBUaGUgb3B0aW9uYWwgcmV2aXZlciBwYXJhbWV0ZXIgaXMgYSBmdW5jdGlvbiB0aGF0IGNhbiBmaWx0ZXIgYW5kCiB0cmFuc2Zvcm0gdGhlIHJlc3VsdHMuIEl0IHJlY2VpdmVzIGVhY2ggb2YgdGhlIGtleXMgYW5kIHZhbHVlcywKIGFuZCBpdHMgcmV0dXJuIHZhbHVlIGlzIHVzZWQgaW5zdGVhZCBvZiB0aGUgb3JpZ2luYWwgdmFsdWUuCiBJZiBpdCByZXR1cm5zIHdoYXQgaXQgcmVjZWl2ZWQsIHRoZW4gdGhlIHN0cnVjdHVyZSBpcyBub3QgbW9kaWZpZWQuCiBJZiBpdCByZXR1cm5zIHVuZGVmaW5lZCB0aGVuIHRoZSBtZW1iZXIgaXMgZGVsZXRlZC4KCiBFeGFtcGxlOgoKIC8vIFBhcnNlIHRoZSB0ZXh0LiBWYWx1ZXMgdGhhdCBsb29rIGxpa2UgSVNPIGRhdGUgc3RyaW5ncyB3aWxsCiAvLyBiZSBjb252ZXJ0ZWQgdG8gRGF0ZSBvYmplY3RzLgoKIG15RGF0YSA9IEpTT04ucGFyc2UodGV4dCwgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKIHZhciBhOwogaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHsKIGEgPQogL14oXGR7NH0pLShcZHsyfSktKFxkezJ9KVQoXGR7Mn0pOihcZHsyfSk6KFxkezJ9KD86XC5cZCopPylaJC8uZXhlYyh2YWx1ZSk7CiBpZiAoYSkgewogcmV0dXJuIG5ldyBEYXRlKERhdGUuVVRDKCthWzFdLCArYVsyXSAtIDEsICthWzNdLCArYVs0XSwKICthWzVdLCArYVs2XSkpOwogfQogfQogcmV0dXJuIHZhbHVlOwogfSk7CgogbXlEYXRhID0gSlNPTi5wYXJzZSgnWyJEYXRlKDA5LzA5LzIwMDEpIl0nLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogdmFyIGQ7CiBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyAmJgogdmFsdWUuc2xpY2UoMCwgNSkgPT09ICdEYXRlKCcgJiYKIHZhbHVlLnNsaWNlKC0xKSA9PT0gJyknKSB7CiBkID0gbmV3IERhdGUodmFsdWUuc2xpY2UoNSwgLTEpKTsKIGlmIChkKSB7CiByZXR1cm4gZDsKIH0KIH0KIHJldHVybiB2YWx1ZTsKIH0pOwoKCiBUaGlzIGlzIGEgcmVmZXJlbmNlIGltcGxlbWVudGF0aW9uLiBZb3UgYXJlIGZyZWUgdG8gY29weSwgbW9kaWZ5LCBvcgogcmVkaXN0cmlidXRlLgogKi8KCi8qanNsaW50IGV2aWw6IHRydWUsIHJlZ2V4cDogdHJ1ZSAqLwoKLyptZW1iZXJzICIiLCAiXGIiLCAiXHQiLCAiXG4iLCAiXGYiLCAiXHIiLCAiXCIiLCBKU09OLCAiXFwiLCBhcHBseSwKIGNhbGwsIGNoYXJDb2RlQXQsIGdldFVUQ0RhdGUsIGdldFVUQ0Z1bGxZZWFyLCBnZXRVVENIb3VycywKIGdldFVUQ01pbnV0ZXMsIGdldFVUQ01vbnRoLCBnZXRVVENTZWNvbmRzLCBoYXNPd25Qcm9wZXJ0eSwgam9pbiwKIGxhc3RJbmRleCwgbGVuZ3RoLCBwYXJzZSwgcHJvdG90eXBlLCBwdXNoLCByZXBsYWNlLCBzbGljZSwgc3RyaW5naWZ5LAogdGVzdCwgdG9KU09OLCB0b1N0cmluZywgdmFsdWVPZgogKi8KCgovLyBDcmVhdGUgYSBKU09OIG9iamVjdCBvbmx5IGlmIG9uZSBkb2VzIG5vdCBhbHJlYWR5IGV4aXN0LiBXZSBjcmVhdGUgdGhlCi8vIG1ldGhvZHMgaW4gYSBjbG9zdXJlIHRvIGF2b2lkIGNyZWF0aW5nIGdsb2JhbCB2YXJpYWJsZXMuCgppZiAodHlwZW9mIEpTT04gIT09ICdvYmplY3QnKSB7CiAgICBKU09OID0ge307Cn0KCihmdW5jdGlvbiAoKSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgZnVuY3Rpb24gZihuKSB7CiAgICAgICAgLy8gRm9ybWF0IGludGVnZXJzIHRvIGhhdmUgYXQgbGVhc3QgdHdvIGRpZ2l0cy4KICAgICAgICByZXR1cm4gbiA8IDEwID8gJzAnICsgbiA6IG47CiAgICB9CgogICAgaWYgKHR5cGVvZiBEYXRlLnByb3RvdHlwZS50b0pTT04gIT09ICdmdW5jdGlvbicpIHsKCiAgICAgICAgRGF0ZS5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24gKGtleSkgewoKICAgICAgICAgICAgcmV0dXJuIGlzRmluaXRlKHRoaXMudmFsdWVPZigpKQogICAgICAgICAgICAgICAgPyB0aGlzLmdldFVUQ0Z1bGxZZWFyKCkgICAgICsgJy0nICsKICAgICAgICAgICAgICAgIGYodGhpcy5nZXRVVENNb250aCgpICsgMSkgKyAnLScgKwogICAgICAgICAgICAgICAgZih0aGlzLmdldFVUQ0RhdGUoKSkgICAgICArICdUJyArCiAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDSG91cnMoKSkgICAgICsgJzonICsKICAgICAgICAgICAgICAgIGYodGhpcy5nZXRVVENNaW51dGVzKCkpICAgKyAnOicgKwogICAgICAgICAgICAgICAgZih0aGlzLmdldFVUQ1NlY29uZHMoKSkgICArICdaJwogICAgICAgICAgICAgICAgOiBudWxsOwogICAgICAgIH07CgogICAgICAgIFN0cmluZy5wcm90b3R5cGUudG9KU09OICAgICAgPQogICAgICAgICAgICBOdW1iZXIucHJvdG90eXBlLnRvSlNPTiAgPQogICAgICAgICAgICAgICAgQm9vbGVhbi5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnZhbHVlT2YoKTsKICAgICAgICAgICAgICAgIH07CiAgICB9CgogICAgdmFyIGN4ID0gL1tcdTAwMDBcdTAwYWRcdTA2MDAtXHUwNjA0XHUwNzBmXHUxN2I0XHUxN2I1XHUyMDBjLVx1MjAwZlx1MjAyOC1cdTIwMmZcdTIwNjAtXHUyMDZmXHVmZWZmXHVmZmYwLVx1ZmZmZl0vZywKICAgICAgICBlc2NhcGFibGUgPSAvW1xcXCJceDAwLVx4MWZceDdmLVx4OWZcdTAwYWRcdTA2MDAtXHUwNjA0XHUwNzBmXHUxN2I0XHUxN2I1XHUyMDBjLVx1MjAwZlx1MjAyOC1cdTIwMmZcdTIwNjAtXHUyMDZmXHVmZWZmXHVmZmYwLVx1ZmZmZl0vZywKICAgICAgICBnYXAsCiAgICAgICAgaW5kZW50LAogICAgICAgIG1ldGEgPSB7ICAgIC8vIHRhYmxlIG9mIGNoYXJhY3RlciBzdWJzdGl0dXRpb25zCiAgICAgICAgICAgICdcYic6ICdcXGInLAogICAgICAgICAgICAnXHQnOiAnXFx0JywKICAgICAgICAgICAgJ1xuJzogJ1xcbicsCiAgICAgICAgICAgICdcZic6ICdcXGYnLAogICAgICAgICAgICAnXHInOiAnXFxyJywKICAgICAgICAgICAgJyInIDogJ1xcIicsCiAgICAgICAgICAgICdcXCc6ICdcXFxcJwogICAgICAgIH0sCiAgICAgICAgcmVwOwoKCiAgICBmdW5jdGlvbiBxdW90ZShzdHJpbmcpIHsKCi8vIElmIHRoZSBzdHJpbmcgY29udGFpbnMgbm8gY29udHJvbCBjaGFyYWN0ZXJzLCBubyBxdW90ZSBjaGFyYWN0ZXJzLCBhbmQgbm8KLy8gYmFja3NsYXNoIGNoYXJhY3RlcnMsIHRoZW4gd2UgY2FuIHNhZmVseSBzbGFwIHNvbWUgcXVvdGVzIGFyb3VuZCBpdC4KLy8gT3RoZXJ3aXNlIHdlIG11c3QgYWxzbyByZXBsYWNlIHRoZSBvZmZlbmRpbmcgY2hhcmFjdGVycyB3aXRoIHNhZmUgZXNjYXBlCi8vIHNlcXVlbmNlcy4KCiAgICAgICAgZXNjYXBhYmxlLmxhc3RJbmRleCA9IDA7CiAgICAgICAgcmV0dXJuIGVzY2FwYWJsZS50ZXN0KHN0cmluZykgPyAnIicgKyBzdHJpbmcucmVwbGFjZShlc2NhcGFibGUsIGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgIHZhciBjID0gbWV0YVthXTsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBjID09PSAnc3RyaW5nJwogICAgICAgICAgICAgICAgPyBjCiAgICAgICAgICAgICAgICA6ICdcXHUnICsgKCcwMDAwJyArIGEuY2hhckNvZGVBdCgwKS50b1N0cmluZygxNikpLnNsaWNlKC00KTsKICAgICAgICB9KSArICciJyA6ICciJyArIHN0cmluZyArICciJzsKICAgIH0KCgogICAgZnVuY3Rpb24gc3RyKGtleSwgaG9sZGVyKSB7CgovLyBQcm9kdWNlIGEgc3RyaW5nIGZyb20gaG9sZGVyW2tleV0uCgogICAgICAgIHZhciBpLCAgICAgICAgICAvLyBUaGUgbG9vcCBjb3VudGVyLgogICAgICAgICAgICBrLCAgICAgICAgICAvLyBUaGUgbWVtYmVyIGtleS4KICAgICAgICAgICAgdiwgICAgICAgICAgLy8gVGhlIG1lbWJlciB2YWx1ZS4KICAgICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgICBtaW5kID0gZ2FwLAogICAgICAgICAgICBwYXJ0aWFsLAogICAgICAgICAgICB2YWx1ZSA9IGhvbGRlcltrZXldOwoKLy8gSWYgdGhlIHZhbHVlIGhhcyBhIHRvSlNPTiBtZXRob2QsIGNhbGwgaXQgdG8gb2J0YWluIGEgcmVwbGFjZW1lbnQgdmFsdWUuCgogICAgICAgIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmCiAgICAgICAgICAgIHR5cGVvZiB2YWx1ZS50b0pTT04gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS50b0pTT04oa2V5KTsKICAgICAgICB9CgovLyBJZiB3ZSB3ZXJlIGNhbGxlZCB3aXRoIGEgcmVwbGFjZXIgZnVuY3Rpb24sIHRoZW4gY2FsbCB0aGUgcmVwbGFjZXIgdG8KLy8gb2J0YWluIGEgcmVwbGFjZW1lbnQgdmFsdWUuCgogICAgICAgIGlmICh0eXBlb2YgcmVwID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIHZhbHVlID0gcmVwLmNhbGwoaG9sZGVyLCBrZXksIHZhbHVlKTsKICAgICAgICB9CgovLyBXaGF0IGhhcHBlbnMgbmV4dCBkZXBlbmRzIG9uIHRoZSB2YWx1ZSdzIHR5cGUuCgogICAgICAgIHN3aXRjaCAodHlwZW9mIHZhbHVlKSB7CiAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgICAgICAgICByZXR1cm4gcXVvdGUodmFsdWUpOwoKICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzoKCi8vIEpTT04gbnVtYmVycyBtdXN0IGJlIGZpbml0ZS4gRW5jb2RlIG5vbi1maW5pdGUgbnVtYmVycyBhcyBudWxsLgoKICAgICAgICAgICAgICAgIHJldHVybiBpc0Zpbml0ZSh2YWx1ZSkgPyBTdHJpbmcodmFsdWUpIDogJ251bGwnOwoKICAgICAgICAgICAgY2FzZSAnYm9vbGVhbic6CiAgICAgICAgICAgIGNhc2UgJ251bGwnOgoKLy8gSWYgdGhlIHZhbHVlIGlzIGEgYm9vbGVhbiBvciBudWxsLCBjb252ZXJ0IGl0IHRvIGEgc3RyaW5nLiBOb3RlOgovLyB0eXBlb2YgbnVsbCBkb2VzIG5vdCBwcm9kdWNlICdudWxsJy4gVGhlIGNhc2UgaXMgaW5jbHVkZWQgaGVyZSBpbgovLyB0aGUgcmVtb3RlIGNoYW5jZSB0aGF0IHRoaXMgZ2V0cyBmaXhlZCBzb21lZGF5LgoKICAgICAgICAgICAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpOwoKLy8gSWYgdGhlIHR5cGUgaXMgJ29iamVjdCcsIHdlIG1pZ2h0IGJlIGRlYWxpbmcgd2l0aCBhbiBvYmplY3Qgb3IgYW4gYXJyYXkgb3IKLy8gbnVsbC4KCiAgICAgICAgICAgIGNhc2UgJ29iamVjdCc6CgovLyBEdWUgdG8gYSBzcGVjaWZpY2F0aW9uIGJsdW5kZXIgaW4gRUNNQVNjcmlwdCwgdHlwZW9mIG51bGwgaXMgJ29iamVjdCcsCi8vIHNvIHdhdGNoIG91dCBmb3IgdGhhdCBjYXNlLgoKICAgICAgICAgICAgICAgIGlmICghdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ251bGwnOwogICAgICAgICAgICAgICAgfQoKLy8gTWFrZSBhbiBhcnJheSB0byBob2xkIHRoZSBwYXJ0aWFsIHJlc3VsdHMgb2Ygc3RyaW5naWZ5aW5nIHRoaXMgb2JqZWN0IHZhbHVlLgoKICAgICAgICAgICAgICAgIGdhcCArPSBpbmRlbnQ7CiAgICAgICAgICAgICAgICBwYXJ0aWFsID0gW107CgovLyBJcyB0aGUgdmFsdWUgYW4gYXJyYXk/CgogICAgICAgICAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuYXBwbHkodmFsdWUpID09PSAnW29iamVjdCBBcnJheV0nKSB7CgovLyBUaGUgdmFsdWUgaXMgYW4gYXJyYXkuIFN0cmluZ2lmeSBldmVyeSBlbGVtZW50LiBVc2UgbnVsbCBhcyBhIHBsYWNlaG9sZGVyCi8vIGZvciBub24tSlNPTiB2YWx1ZXMuCgogICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IHZhbHVlLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFydGlhbFtpXSA9IHN0cihpLCB2YWx1ZSkgfHwgJ251bGwnOwogICAgICAgICAgICAgICAgICAgIH0KCi8vIEpvaW4gYWxsIG9mIHRoZSBlbGVtZW50cyB0b2dldGhlciwgc2VwYXJhdGVkIHdpdGggY29tbWFzLCBhbmQgd3JhcCB0aGVtIGluCi8vIGJyYWNrZXRzLgoKICAgICAgICAgICAgICAgICAgICB2ID0gcGFydGlhbC5sZW5ndGggPT09IDAKICAgICAgICAgICAgICAgICAgICAgICAgPyAnW10nCiAgICAgICAgICAgICAgICAgICAgICAgIDogZ2FwCiAgICAgICAgICAgICAgICAgICAgICAgID8gJ1tcbicgKyBnYXAgKyBwYXJ0aWFsLmpvaW4oJyxcbicgKyBnYXApICsgJ1xuJyArIG1pbmQgKyAnXScKICAgICAgICAgICAgICAgICAgICAgICAgOiAnWycgKyBwYXJ0aWFsLmpvaW4oJywnKSArICddJzsKICAgICAgICAgICAgICAgICAgICBnYXAgPSBtaW5kOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgICAgICAgICAgfQoKLy8gSWYgdGhlIHJlcGxhY2VyIGlzIGFuIGFycmF5LCB1c2UgaXQgdG8gc2VsZWN0IHRoZSBtZW1iZXJzIHRvIGJlIHN0cmluZ2lmaWVkLgoKICAgICAgICAgICAgICAgIGlmIChyZXAgJiYgdHlwZW9mIHJlcCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgICAgICBsZW5ndGggPSByZXAubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHJlcFtpXSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGsgPSByZXBbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2ID0gc3RyKGssIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydGlhbC5wdXNoKHF1b3RlKGspICsgKGdhcCA/ICc6ICcgOiAnOicpICsgdik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewoKLy8gT3RoZXJ3aXNlLCBpdGVyYXRlIHRocm91Z2ggYWxsIG9mIHRoZSBrZXlzIGluIHRoZSBvYmplY3QuCgogICAgICAgICAgICAgICAgICAgIGZvciAoayBpbiB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbHVlLCBrKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHN0cihrLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRpYWwucHVzaChxdW90ZShrKSArIChnYXAgPyAnOiAnIDogJzonKSArIHYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKLy8gSm9pbiBhbGwgb2YgdGhlIG1lbWJlciB0ZXh0cyB0b2dldGhlciwgc2VwYXJhdGVkIHdpdGggY29tbWFzLAovLyBhbmQgd3JhcCB0aGVtIGluIGJyYWNlcy4KCiAgICAgICAgICAgICAgICB2ID0gcGFydGlhbC5sZW5ndGggPT09IDAKICAgICAgICAgICAgICAgICAgICA/ICd7fScKICAgICAgICAgICAgICAgICAgICA6IGdhcAogICAgICAgICAgICAgICAgICAgID8gJ3tcbicgKyBnYXAgKyBwYXJ0aWFsLmpvaW4oJyxcbicgKyBnYXApICsgJ1xuJyArIG1pbmQgKyAnfScKICAgICAgICAgICAgICAgICAgICA6ICd7JyArIHBhcnRpYWwuam9pbignLCcpICsgJ30nOwogICAgICAgICAgICAgICAgZ2FwID0gbWluZDsKICAgICAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgIH0KICAgIH0KCi8vIElmIHRoZSBKU09OIG9iamVjdCBkb2VzIG5vdCB5ZXQgaGF2ZSBhIHN0cmluZ2lmeSBtZXRob2QsIGdpdmUgaXQgb25lLgoKICAgIGlmICh0eXBlb2YgSlNPTi5zdHJpbmdpZnkgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICBKU09OLnN0cmluZ2lmeSA9IGZ1bmN0aW9uICh2YWx1ZSwgcmVwbGFjZXIsIHNwYWNlKSB7CgovLyBUaGUgc3RyaW5naWZ5IG1ldGhvZCB0YWtlcyBhIHZhbHVlIGFuZCBhbiBvcHRpb25hbCByZXBsYWNlciwgYW5kIGFuIG9wdGlvbmFsCi8vIHNwYWNlIHBhcmFtZXRlciwgYW5kIHJldHVybnMgYSBKU09OIHRleHQuIFRoZSByZXBsYWNlciBjYW4gYmUgYSBmdW5jdGlvbgovLyB0aGF0IGNhbiByZXBsYWNlIHZhbHVlcywgb3IgYW4gYXJyYXkgb2Ygc3RyaW5ncyB0aGF0IHdpbGwgc2VsZWN0IHRoZSBrZXlzLgovLyBBIGRlZmF1bHQgcmVwbGFjZXIgbWV0aG9kIGNhbiBiZSBwcm92aWRlZC4gVXNlIG9mIHRoZSBzcGFjZSBwYXJhbWV0ZXIgY2FuCi8vIHByb2R1Y2UgdGV4dCB0aGF0IGlzIG1vcmUgZWFzaWx5IHJlYWRhYmxlLgoKICAgICAgICAgICAgdmFyIGk7CiAgICAgICAgICAgIGdhcCA9ICcnOwogICAgICAgICAgICBpbmRlbnQgPSAnJzsKCi8vIElmIHRoZSBzcGFjZSBwYXJhbWV0ZXIgaXMgYSBudW1iZXIsIG1ha2UgYW4gaW5kZW50IHN0cmluZyBjb250YWluaW5nIHRoYXQKLy8gbWFueSBzcGFjZXMuCgogICAgICAgICAgICBpZiAodHlwZW9mIHNwYWNlID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNwYWNlOyBpICs9IDEpIHsKICAgICAgICAgICAgICAgICAgICBpbmRlbnQgKz0gJyAnOwogICAgICAgICAgICAgICAgfQoKLy8gSWYgdGhlIHNwYWNlIHBhcmFtZXRlciBpcyBhIHN0cmluZywgaXQgd2lsbCBiZSB1c2VkIGFzIHRoZSBpbmRlbnQgc3RyaW5nLgoKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc3BhY2UgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICBpbmRlbnQgPSBzcGFjZTsKICAgICAgICAgICAgfQoKLy8gSWYgdGhlcmUgaXMgYSByZXBsYWNlciwgaXQgbXVzdCBiZSBhIGZ1bmN0aW9uIG9yIGFuIGFycmF5LgovLyBPdGhlcndpc2UsIHRocm93IGFuIGVycm9yLgoKICAgICAgICAgICAgcmVwID0gcmVwbGFjZXI7CiAgICAgICAgICAgIGlmIChyZXBsYWNlciAmJiB0eXBlb2YgcmVwbGFjZXIgIT09ICdmdW5jdGlvbicgJiYKICAgICAgICAgICAgICAgICh0eXBlb2YgcmVwbGFjZXIgIT09ICdvYmplY3QnIHx8CiAgICAgICAgICAgICAgICAgICAgdHlwZW9mIHJlcGxhY2VyLmxlbmd0aCAhPT0gJ251bWJlcicpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0pTT04uc3RyaW5naWZ5Jyk7CiAgICAgICAgICAgIH0KCi8vIE1ha2UgYSBmYWtlIHJvb3Qgb2JqZWN0IGNvbnRhaW5pbmcgb3VyIHZhbHVlIHVuZGVyIHRoZSBrZXkgb2YgJycuCi8vIFJldHVybiB0aGUgcmVzdWx0IG9mIHN0cmluZ2lmeWluZyB0aGUgdmFsdWUuCgogICAgICAgICAgICByZXR1cm4gc3RyKCcnLCB7Jyc6IHZhbHVlfSk7CiAgICAgICAgfTsKICAgIH0KCgovLyBJZiB0aGUgSlNPTiBvYmplY3QgZG9lcyBub3QgeWV0IGhhdmUgYSBwYXJzZSBtZXRob2QsIGdpdmUgaXQgb25lLgoKICAgIGlmICh0eXBlb2YgSlNPTi5wYXJzZSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgIEpTT04ucGFyc2UgPSBmdW5jdGlvbiAodGV4dCwgcmV2aXZlcikgewoKLy8gVGhlIHBhcnNlIG1ldGhvZCB0YWtlcyBhIHRleHQgYW5kIGFuIG9wdGlvbmFsIHJldml2ZXIgZnVuY3Rpb24sIGFuZCByZXR1cm5zCi8vIGEgSmF2YVNjcmlwdCB2YWx1ZSBpZiB0aGUgdGV4dCBpcyBhIHZhbGlkIEpTT04gdGV4dC4KCiAgICAgICAgICAgIHZhciBqOwoKICAgICAgICAgICAgZnVuY3Rpb24gd2Fsayhob2xkZXIsIGtleSkgewoKLy8gVGhlIHdhbGsgbWV0aG9kIGlzIHVzZWQgdG8gcmVjdXJzaXZlbHkgd2FsayB0aGUgcmVzdWx0aW5nIHN0cnVjdHVyZSBzbwovLyB0aGF0IG1vZGlmaWNhdGlvbnMgY2FuIGJlIG1hZGUuCgogICAgICAgICAgICAgICAgdmFyIGssIHYsIHZhbHVlID0gaG9sZGVyW2tleV07CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgICAgIGZvciAoayBpbiB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbHVlLCBrKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHdhbGsodmFsdWUsIGspOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHYgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlW2tdID0gdjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHZhbHVlW2tdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJldml2ZXIuY2FsbChob2xkZXIsIGtleSwgdmFsdWUpOwogICAgICAgICAgICB9CgoKLy8gUGFyc2luZyBoYXBwZW5zIGluIGZvdXIgc3RhZ2VzLiBJbiB0aGUgZmlyc3Qgc3RhZ2UsIHdlIHJlcGxhY2UgY2VydGFpbgovLyBVbmljb2RlIGNoYXJhY3RlcnMgd2l0aCBlc2NhcGUgc2VxdWVuY2VzLiBKYXZhU2NyaXB0IGhhbmRsZXMgbWFueSBjaGFyYWN0ZXJzCi8vIGluY29ycmVjdGx5LCBlaXRoZXIgc2lsZW50bHkgZGVsZXRpbmcgdGhlbSwgb3IgdHJlYXRpbmcgdGhlbSBhcyBsaW5lIGVuZGluZ3MuCgogICAgICAgICAgICB0ZXh0ID0gU3RyaW5nKHRleHQpOwogICAgICAgICAgICBjeC5sYXN0SW5kZXggPSAwOwogICAgICAgICAgICBpZiAoY3gudGVzdCh0ZXh0KSkgewogICAgICAgICAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZShjeCwgZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ1xcdScgKwogICAgICAgICAgICAgICAgICAgICAgICAoJzAwMDAnICsgYS5jaGFyQ29kZUF0KDApLnRvU3RyaW5nKDE2KSkuc2xpY2UoLTQpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCi8vIEluIHRoZSBzZWNvbmQgc3RhZ2UsIHdlIHJ1biB0aGUgdGV4dCBhZ2FpbnN0IHJlZ3VsYXIgZXhwcmVzc2lvbnMgdGhhdCBsb29rCi8vIGZvciBub24tSlNPTiBwYXR0ZXJucy4gV2UgYXJlIGVzcGVjaWFsbHkgY29uY2VybmVkIHdpdGggJygpJyBhbmQgJ25ldycKLy8gYmVjYXVzZSB0aGV5IGNhbiBjYXVzZSBpbnZvY2F0aW9uLCBhbmQgJz0nIGJlY2F1c2UgaXQgY2FuIGNhdXNlIG11dGF0aW9uLgovLyBCdXQganVzdCB0byBiZSBzYWZlLCB3ZSB3YW50IHRvIHJlamVjdCBhbGwgdW5leHBlY3RlZCBmb3Jtcy4KCi8vIFdlIHNwbGl0IHRoZSBzZWNvbmQgc3RhZ2UgaW50byA0IHJlZ2V4cCBvcGVyYXRpb25zIGluIG9yZGVyIHRvIHdvcmsgYXJvdW5kCi8vIGNyaXBwbGluZyBpbmVmZmljaWVuY2llcyBpbiBJRSdzIGFuZCBTYWZhcmkncyByZWdleHAgZW5naW5lcy4gRmlyc3Qgd2UKLy8gcmVwbGFjZSB0aGUgSlNPTiBiYWNrc2xhc2ggcGFpcnMgd2l0aCAnQCcgKGEgbm9uLUpTT04gY2hhcmFjdGVyKS4gU2Vjb25kLCB3ZQovLyByZXBsYWNlIGFsbCBzaW1wbGUgdmFsdWUgdG9rZW5zIHdpdGggJ10nIGNoYXJhY3RlcnMuIFRoaXJkLCB3ZSBkZWxldGUgYWxsCi8vIG9wZW4gYnJhY2tldHMgdGhhdCBmb2xsb3cgYSBjb2xvbiBvciBjb21tYSBvciB0aGF0IGJlZ2luIHRoZSB0ZXh0LiBGaW5hbGx5LAovLyB3ZSBsb29rIHRvIHNlZSB0aGF0IHRoZSByZW1haW5pbmcgY2hhcmFjdGVycyBhcmUgb25seSB3aGl0ZXNwYWNlIG9yICddJyBvcgovLyAnLCcgb3IgJzonIG9yICd7JyBvciAnfScuIElmIHRoYXQgaXMgc28sIHRoZW4gdGhlIHRleHQgaXMgc2FmZSBmb3IgZXZhbC4KCiAgICAgICAgICAgIGlmICgvXltcXSw6e31cc10qJC8KICAgICAgICAgICAgICAgIC50ZXN0KHRleHQucmVwbGFjZSgvXFwoPzpbIlxcXC9iZm5ydF18dVswLTlhLWZBLUZdezR9KS9nLCAnQCcpCiAgICAgICAgICAgICAgICAucmVwbGFjZSgvIlteIlxcXG5ccl0qInx0cnVlfGZhbHNlfG51bGx8LT9cZCsoPzpcLlxkKik/KD86W2VFXVsrXC1dP1xkKyk/L2csICddJykKICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8oPzpefDp8LCkoPzpccypcWykrL2csICcnKSkpIHsKCi8vIEluIHRoZSB0aGlyZCBzdGFnZSB3ZSB1c2UgdGhlIGV2YWwgZnVuY3Rpb24gdG8gY29tcGlsZSB0aGUgdGV4dCBpbnRvIGEKLy8gSmF2YVNjcmlwdCBzdHJ1Y3R1cmUuIFRoZSAneycgb3BlcmF0b3IgaXMgc3ViamVjdCB0byBhIHN5bnRhY3RpYyBhbWJpZ3VpdHkKLy8gaW4gSmF2YVNjcmlwdDogaXQgY2FuIGJlZ2luIGEgYmxvY2sgb3IgYW4gb2JqZWN0IGxpdGVyYWwuIFdlIHdyYXAgdGhlIHRleHQKLy8gaW4gcGFyZW5zIHRvIGVsaW1pbmF0ZSB0aGUgYW1iaWd1aXR5LgoKICAgICAgICAgICAgICAgIGogPSBldmFsKCcoJyArIHRleHQgKyAnKScpOwoKLy8gSW4gdGhlIG9wdGlvbmFsIGZvdXJ0aCBzdGFnZSwgd2UgcmVjdXJzaXZlbHkgd2FsayB0aGUgbmV3IHN0cnVjdHVyZSwgcGFzc2luZwovLyBlYWNoIG5hbWUvdmFsdWUgcGFpciB0byBhIHJldml2ZXIgZnVuY3Rpb24gZm9yIHBvc3NpYmxlIHRyYW5zZm9ybWF0aW9uLgoKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2YgcmV2aXZlciA9PT0gJ2Z1bmN0aW9uJwogICAgICAgICAgICAgICAgICAgID8gd2Fsayh7Jyc6IGp9LCAnJykKICAgICAgICAgICAgICAgICAgICA6IGo7CiAgICAgICAgICAgIH0KCi8vIElmIHRoZSB0ZXh0IGlzIG5vdCBKU09OIHBhcnNlYWJsZSwgdGhlbiBhIFN5bnRheEVycm9yIGlzIHRocm93bi4KCiAgICAgICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcignSlNPTi5wYXJzZScpOwogICAgICAgIH07CiAgICB9Cn0oKSk7LyohCiAqIEpTT05TY2hlbWEgVmFsaWRhdG9yIC0gVmFsaWRhdGVzIEphdmFTY3JpcHQgb2JqZWN0cyB1c2luZyBKU09OIFNjaGVtYXMKICogICAgKGh0dHA6Ly93d3cuanNvbi5jb20vanNvbi1zY2hlbWEtcHJvcG9zYWwvKQogKgogKiBDb3B5cmlnaHQgKGMpIDIwMDcgS3JpcyBaeXAgU2l0ZVBlbiAod3d3LnNpdGVwZW4uY29tKQogKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIChNSVQtTElDRU5TRS50eHQpIGxpY2Vuc2UuCiBUbyB1c2UgdGhlIHZhbGlkYXRvciBjYWxsIHRoZSB2YWxpZGF0ZSBmdW5jdGlvbiB3aXRoIGFuIGluc3RhbmNlIG9iamVjdCBhbmQgYW4gb3B0aW9uYWwgc2NoZW1hIG9iamVjdC4KIElmIGEgc2NoZW1hIGlzIHByb3ZpZGVkLCBpdCB3aWxsIGJlIHVzZWQgdG8gdmFsaWRhdGUuIElmIHRoZSBpbnN0YW5jZSBvYmplY3QgcmVmZXJzIHRvIGEgc2NoZW1hIChzZWxmLXZhbGlkYXRpbmcpLAogdGhhdCBzY2hlbWEgd2lsbCBiZSB1c2VkIHRvIHZhbGlkYXRlIGFuZCB0aGUgc2NoZW1hIHBhcmFtZXRlciBpcyBub3QgbmVjZXNzYXJ5IChpZiBib3RoIGV4aXN0LAogYm90aCB2YWxpZGF0aW9ucyB3aWxsIG9jY3VyKS4KIFRoZSB2YWxpZGF0ZSBtZXRob2Qgd2lsbCByZXR1cm4gYW4gYXJyYXkgb2YgdmFsaWRhdGlvbiBlcnJvcnMuIElmIHRoZXJlIGFyZSBubyBlcnJvcnMsIHRoZW4gYW4KIGVtcHR5IGxpc3Qgd2lsbCBiZSByZXR1cm5lZC4gQSB2YWxpZGF0aW9uIGVycm9yIHdpbGwgaGF2ZSB0d28gcHJvcGVydGllczoKICJwcm9wZXJ0eSIgd2hpY2ggaW5kaWNhdGVzIHdoaWNoIHByb3BlcnR5IGhhZCB0aGUgZXJyb3IKICJtZXNzYWdlIiB3aGljaCBpbmRpY2F0ZXMgd2hhdCB0aGUgZXJyb3Igd2FzCiAqLwooZnVuY3Rpb24oJCkgewoKICAgIC8qKiBAbmFtZXNwYWNlICovCiAgICBWYWxpZGF0b3IgPSB7CgogICAgICAgIC8qKgogICAgICAgICAqIFN1bW1hcnk6CiAgICAgICAgICogVG8gdXNlIHRoZSB2YWxpZGF0b3IgY2FsbCBKU09OU2NoZW1hLnZhbGlkYXRlIHdpdGggYW4gaW5zdGFuY2Ugb2JqZWN0IGFuZCBhbiBvcHRpb25hbCBzY2hlbWEgb2JqZWN0LgogICAgICAgICAqIElmIGEgc2NoZW1hIGlzIHByb3ZpZGVkLCBpdCB3aWxsIGJlIHVzZWQgdG8gdmFsaWRhdGUuIElmIHRoZSBpbnN0YW5jZSBvYmplY3QgcmVmZXJzIHRvIGEgc2NoZW1hIChzZWxmLXZhbGlkYXRpbmcpLAogICAgICAgICAqIHRoYXQgc2NoZW1hIHdpbGwgYmUgdXNlZCB0byB2YWxpZGF0ZSBhbmQgdGhlIHNjaGVtYSBwYXJhbWV0ZXIgaXMgbm90IG5lY2Vzc2FyeSAoaWYgYm90aCBleGlzdCwKICAgICAgICAgKiBib3RoIHZhbGlkYXRpb25zIHdpbGwgb2NjdXIpLgogICAgICAgICAqIFRoZSB2YWxpZGF0ZSBtZXRob2Qgd2lsbCByZXR1cm4gYW4gb2JqZWN0IHdpdGggdHdvIHByb3BlcnRpZXM6CiAgICAgICAgICogdmFsaWQ6IEEgYm9vbGVhbiBpbmRpY2F0aW5nIGlmIHRoZSBpbnN0YW5jZSBpcyB2YWxpZCBieSB0aGUgc2NoZW1hCiAgICAgICAgICogZXJyb3JzOiBBbiBhcnJheSBvZiB2YWxpZGF0aW9uIGVycm9ycy4gSWYgdGhlcmUgYXJlIG5vIGVycm9ycywgdGhlbiBhbgogICAgICAgICAqIGVtcHR5IGxpc3Qgd2lsbCBiZSByZXR1cm5lZC4gQSB2YWxpZGF0aW9uIGVycm9yIHdpbGwgaGF2ZSB0d28gcHJvcGVydGllczoKICAgICAgICAgKiBwcm9wZXJ0eTogd2hpY2ggaW5kaWNhdGVzIHdoaWNoIHByb3BlcnR5IGhhZCB0aGUgZXJyb3IKICAgICAgICAgKiBtZXNzYWdlOiB3aGljaCBpbmRpY2F0ZXMgd2hhdCB0aGUgZXJyb3Igd2FzCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0FueX0gaW5zdGFuY2UKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSByZXN1bHQgdmFsaWRhdGlvbiByZXN1bHQKICAgICAgICAgKi8KICAgICAgICB2YWxpZGF0ZTogZnVuY3Rpb24gKC8qQW55Ki9pbnN0YW5jZSwgLypPYmplY3QqL3NjaGVtYSkgewogICAgICAgICAgICByZXR1cm4gVmFsaWRhdG9yLl92YWxpZGF0ZShpbnN0YW5jZSwgc2NoZW1hLCB7Y2hhbmdpbmc6IGZhbHNlfSk7Ly8sIGNvZXJjZTogZmFsc2UsIGV4aXN0aW5nT25seTogZmFsc2V9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBTdW1tYXJ5OgogICAgICAgICAqIFRoZSBjaGVja1Byb3BlcnR5Q2hhbmdlIG1ldGhvZCB3aWxsIGNoZWNrIHRvIHNlZSBpZiBhbiB2YWx1ZSBjYW4gbGVnYWxseSBiZSBpbiBwcm9wZXJ0eSB3aXRoIHRoZSBnaXZlbiBzY2hlbWEKICAgICAgICAgKiBUaGlzIGlzIHNsaWdodGx5IGRpZmZlcmVudCB0aGFuIHRoZSB2YWxpZGF0ZSBtZXRob2QgaW4gdGhhdCBpdCB3aWxsIGZhaWwgaWYgdGhlIHNjaGVtYSBpcyByZWFkb25seSBhbmQgaXQgd2lsbAogICAgICAgICAqIG5vdCBjaGVjayBmb3Igc2VsZi12YWxpZGF0aW9uLCBpdCBpcyBhc3N1bWVkIHRoYXQgdGhlIHBhc3NlZCBpbiB2YWx1ZSBpcyBhbHJlYWR5IGludGVybmFsbHkgdmFsaWQuCiAgICAgICAgICogVGhlIGNoZWNrUHJvcGVydHlDaGFuZ2UgbWV0aG9kIHdpbGwgcmV0dXJuIHRoZSBzYW1lIG9iamVjdCB0eXBlIGFzIHZhbGlkYXRlLCBzZWUgSlNPTlNjaGVtYS52YWxpZGF0ZSBmb3IKICAgICAgICAgKiBpbmZvcm1hdGlvbi4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7QW55fSB2YWx1ZQogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkKICAgICAgICAgKi8KICAgICAgICBjaGVja1Byb3BlcnR5Q2hhbmdlIDogZnVuY3Rpb24oLypBbnkqL3ZhbHVlLCAvKk9iamVjdCovc2NoZW1hLCAvKlN0cmluZyovcHJvcGVydHkpIHsKICAgICAgICAgICAgcmV0dXJuIFZhbGlkYXRvci5fdmFsaWRhdGUodmFsdWUsIHNjaGVtYSwge2NoYW5naW5nOiBwcm9wZXJ0eSB8fCAicHJvcGVydHkifSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQGludGVybmFsCiAgICAgICAgICogQHBhcmFtIGluc3RhbmNlCiAgICAgICAgICogQHBhcmFtIHNjaGVtYQogICAgICAgICAqIEBwYXJhbSBvcHRpb25zCiAgICAgICAgICovCiAgICAgICAgX3ZhbGlkYXRlIDogZnVuY3Rpb24oLypBbnkqL2luc3RhbmNlLCAvKk9iamVjdCovc2NoZW1hLCAvKk9iamVjdCovb3B0aW9ucykgewoKICAgICAgICAgICAgaWYgKCFvcHRpb25zKSBvcHRpb25zID0ge307CiAgICAgICAgICAgIHZhciBfY2hhbmdpbmcgPSBvcHRpb25zLmNoYW5naW5nOwoKICAgICAgICAgICAgdmFyIGVycm9ycyA9IFtdOwogICAgICAgICAgICAvLyB2YWxpZGF0ZSBhIHZhbHVlIGFnYWluc3QgYSBwcm9wZXJ0eSBkZWZpbml0aW9uCiAgICAgICAgICAgIGZ1bmN0aW9uIGNoZWNrUHJvcCh2YWx1ZSwgc2NoZW1hLCBwYXRoLCBpKSB7CgogICAgICAgICAgICAgICAgdmFyIGw7CiAgICAgICAgICAgICAgICBwYXRoICs9IHBhdGggPyB0eXBlb2YgaSA9PSAnbnVtYmVyJyA/ICdbJyArIGkgKyAnXScgOiB0eXBlb2YgaSA9PSAndW5kZWZpbmVkJyA/ICcnIDogJy4nICsgaSA6IGk7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBhZGRFcnJvcihtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JzLnB1c2goe3Byb3BlcnR5OnBhdGgsbWVzc2FnZTptZXNzYWdlfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCh0eXBlb2Ygc2NoZW1hICE9ICdvYmplY3QnIHx8IHNjaGVtYSBpbnN0YW5jZW9mIEFycmF5KSAmJiAocGF0aCB8fCB0eXBlb2Ygc2NoZW1hICE9ICdmdW5jdGlvbicpICYmICEoc2NoZW1hICYmIHNjaGVtYS50eXBlKSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2NoZW1hID09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEodmFsdWUgaW5zdGFuY2VvZiBzY2hlbWEpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFcnJvcigiaXMgbm90IGFuIGluc3RhbmNlIG9mIHRoZSBjbGFzcy9jb25zdHJ1Y3RvciAiICsgc2NoZW1hLm5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzY2hlbWEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkRXJyb3IoIkludmFsaWQgc2NoZW1hL3Byb3BlcnR5IGRlZmluaXRpb24gIiArIHNjaGVtYSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKF9jaGFuZ2luZyAmJiBzY2hlbWEucmVhZG9ubHkpIHsKICAgICAgICAgICAgICAgICAgICBhZGRFcnJvcigiaXMgYSByZWFkb25seSBmaWVsZCwgaXQgY2FuIG5vdCBiZSBjaGFuZ2VkIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc2NoZW1hWydleHRlbmRzJ10pIHsgLy8gaWYgaXQgZXh0ZW5kcyBhbm90aGVyIHNjaGVtYSwgaXQgbXVzdCBwYXNzIHRoYXQgc2NoZW1hIGFzIHdlbGwKICAgICAgICAgICAgICAgICAgICBjaGVja1Byb3AodmFsdWUsIHNjaGVtYVsnZXh0ZW5kcyddLCBwYXRoLCBpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIHZhbGlkYXRlIGEgdmFsdWUgYWdhaW5zdCBhIHR5cGUgZGVmaW5pdGlvbgogICAgICAgICAgICAgICAgZnVuY3Rpb24gY2hlY2tUeXBlKHR5cGUsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09ICdzdHJpbmcnICYmIHR5cGUgIT0gJ2FueScgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAodHlwZSA9PSAnbnVsbCcgPyB2YWx1ZSAhPT0gbnVsbCA6IHR5cGVvZiB2YWx1ZSAhPSB0eXBlKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICEodmFsdWUgaW5zdGFuY2VvZiBBcnJheSAmJiB0eXBlID09ICdhcnJheScpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgISh2YWx1ZSBpbnN0YW5jZW9mIERhdGUgJiYgdHlwZSA9PSAnZGF0ZScpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgISh0eXBlID09ICdpbnRlZ2VyJyAmJiB2YWx1ZSAlIDEgPT09IDApKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtwcm9wZXJ0eTpwYXRoLG1lc3NhZ2U6KHR5cGVvZiB2YWx1ZSkgKyAiIHZhbHVlIGZvdW5kLCBidXQgYSAiICsgdHlwZSArICIgaXMgcmVxdWlyZWQifQogICAgICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdW5pb25FcnJvcnMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdHlwZS5sZW5ndGg7IGorKykgeyAvLyBhIHVuaW9uIHR5cGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoISh1bmlvbkVycm9ycyA9IGNoZWNrVHlwZSh0eXBlW2pdLCB2YWx1ZSkpLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodW5pb25FcnJvcnMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuaW9uRXJyb3JzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0eXBlID09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJpb3JFcnJvcnMgPSBlcnJvcnM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcnMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrUHJvcCh2YWx1ZSwgdHlwZSwgcGF0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGhlc2VFcnJvcnMgPSBlcnJvcnM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcnMgPSBwcmlvckVycm9yczsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGVzZUVycm9yczsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc2NoZW1hLnJlcXVpcmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZEVycm9yKCJpcyBtaXNzaW5nIGFuZCBpdCBpcyByZXF1aXJlZCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JzID0gZXJyb3JzLmNvbmNhdChjaGVja1R5cGUoc2NoZW1hLnR5cGUsIHZhbHVlKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNjaGVtYS5kaXNhbGxvdyAmJiAhY2hlY2tUeXBlKHNjaGVtYS5kaXNhbGxvdywgdmFsdWUpLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBhZGRFcnJvcigiIGRpc2FsbG93ZWQgdmFsdWUgd2FzIG1hdGNoZWQiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2NoZW1hLml0ZW1zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW1zSXNBcnJheSA9IHNjaGVtYS5pdGVtcyBpbnN0YW5jZW9mIEFycmF5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcm9wRGVmID0gc2NoZW1hLml0ZW1zOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsbCA9IHZhbHVlLmxlbmd0aDsgaSA8IGw7IGkgKz0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbXNJc0FycmF5KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcERlZiA9IHNjaGVtYS5pdGVtc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuY29lcmNlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVbaV0gPSBvcHRpb25zLmNvZXJjZSh2YWx1ZVtpXSwgcHJvcERlZik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9ycy5jb25jYXQoY2hlY2tQcm9wKHZhbHVlW2ldLCBwcm9wRGVmLCBwYXRoLCBpKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNjaGVtYS5taW5JdGVtcyAmJiB2YWx1ZS5sZW5ndGggPCBzY2hlbWEubWluSXRlbXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFcnJvcigiVGhlcmUgbXVzdCBiZSBhIG1pbmltdW0gb2YgIiArIHNjaGVtYS5taW5JdGVtcyArICIgaW4gdGhlIGFycmF5Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2NoZW1hLm1heEl0ZW1zICYmIHZhbHVlLmxlbmd0aCA+IHNjaGVtYS5tYXhJdGVtcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZEVycm9yKCJUaGVyZSBtdXN0IGJlIGEgbWF4aW11bSBvZiAiICsgc2NoZW1hLm1heEl0ZW1zICsgIiBpbiB0aGUgYXJyYXkiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzY2hlbWEucHJvcGVydGllcyB8fCBzY2hlbWEuYWRkaXRpb25hbFByb3BlcnRpZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9ycy5jb25jYXQoY2hlY2tPYmoodmFsdWUsIHNjaGVtYS5wcm9wZXJ0aWVzLCBwYXRoLCBzY2hlbWEuYWRkaXRpb25hbFByb3BlcnRpZXMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2NoZW1hLnBhdHRlcm4gJiYgdHlwZW9mIHZhbHVlID09ICdzdHJpbmcnICYmICF2YWx1ZS5tYXRjaChzY2hlbWEucGF0dGVybikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZEVycm9yKCJkb2VzIG5vdCBtYXRjaCB0aGUgcmVnZXggcGF0dGVybiAiICsgc2NoZW1hLnBhdHRlcm4pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzY2hlbWEubWF4TGVuZ3RoICYmIHR5cGVvZiB2YWx1ZSA9PSAnc3RyaW5nJyAmJiB2YWx1ZS5sZW5ndGggPiBzY2hlbWEubWF4TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFcnJvcigibWF5IG9ubHkgYmUgIiArIHNjaGVtYS5tYXhMZW5ndGggKyAiIGNoYXJhY3RlcnMgbG9uZyIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzY2hlbWEubWluTGVuZ3RoICYmIHR5cGVvZiB2YWx1ZSA9PSAnc3RyaW5nJyAmJiB2YWx1ZS5sZW5ndGggPCBzY2hlbWEubWluTGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFcnJvcigibXVzdCBiZSBhdCBsZWFzdCAiICsgc2NoZW1hLm1pbkxlbmd0aCArICIgY2hhcmFjdGVycyBsb25nIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzY2hlbWEubWluaW11bSAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiB2YWx1ZSA9PSB0eXBlb2Ygc2NoZW1hLm1pbmltdW0gJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2hlbWEubWluaW11bSA+IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFcnJvcigibXVzdCBoYXZlIGEgbWluaW11bSB2YWx1ZSBvZiAiICsgc2NoZW1hLm1pbmltdW0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2NoZW1hLm1heGltdW0gIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgdmFsdWUgPT0gdHlwZW9mIHNjaGVtYS5tYXhpbXVtICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NoZW1hLm1heGltdW0gPCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkRXJyb3IoIm11c3QgaGF2ZSBhIG1heGltdW0gdmFsdWUgb2YgIiArIHNjaGVtYS5tYXhpbXVtKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2NoZW1hWydlbnVtJ10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlbnVtZXIgPSBzY2hlbWFbJ2VudW0nXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGwgPSBlbnVtZXIubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZvdW5kOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBsOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW51bWVyW2pdID09PSB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3VuZCA9IDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZm91bmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFcnJvcigiZG9lcyBub3QgaGF2ZSBhIHZhbHVlIGluIHRoZSBlbnVtZXJhdGlvbiAiICsgZW51bWVyLmpvaW4oIiwgIikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2NoZW1hLm1heERlY2ltYWwgPT0gJ251bWJlcicgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAodmFsdWUudG9TdHJpbmcoKS5tYXRjaChuZXcgUmVnRXhwKCJcXC5bMC05XXsiICsgKHNjaGVtYS5tYXhEZWNpbWFsICsgMSkgKyAiLH0iKSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFcnJvcigibWF5IG9ubHkgaGF2ZSAiICsgc2NoZW1hLm1heERlY2ltYWwgKyAiIGRpZ2l0cyBvZiBkZWNpbWFsIHBsYWNlcyIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHZhbGlkYXRlIGFuIG9iamVjdCBhZ2FpbnN0IGEgc2NoZW1hCiAgICAgICAgICAgIGZ1bmN0aW9uIGNoZWNrT2JqKGluc3RhbmNlLCBvYmpUeXBlRGVmLCBwYXRoLCBhZGRpdGlvbmFsUHJvcCkgewoKICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqVHlwZURlZiA9PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UgIT0gJ29iamVjdCcgfHwgaW5zdGFuY2UgaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcnMucHVzaCh7cHJvcGVydHk6cGF0aCxtZXNzYWdlOiJhbiBvYmplY3QgaXMgcmVxdWlyZWQifSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIG9ialR5cGVEZWYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9ialR5cGVEZWYuaGFzT3duUHJvcGVydHkoaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IGluc3RhbmNlW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2tpcCBfbm90XyBzcGVjaWZpZWQgcHJvcGVydGllcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgJiYgb3B0aW9ucy5leGlzdGluZ09ubHkpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByb3BEZWYgPSBvYmpUeXBlRGVmW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2V0IGRlZmF1bHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkICYmIHByb3BEZWZbImRlZmF1bHQiXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gaW5zdGFuY2VbaV0gPSBwcm9wRGVmWyJkZWZhdWx0Il07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5jb2VyY2UgJiYgaSBpbiBpbnN0YW5jZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gaW5zdGFuY2VbaV0gPSBvcHRpb25zLmNvZXJjZSh2YWx1ZSwgcHJvcERlZik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGVja1Byb3AodmFsdWUsIHByb3BEZWYsIHBhdGgsIGkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9yIChpIGluIGluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLmhhc093blByb3BlcnR5KGkpICYmICEoaS5jaGFyQXQoMCkgPT0gJ18nICYmIGkuY2hhckF0KDEpID09ICdfJykgJiYgb2JqVHlwZURlZiAmJiAhb2JqVHlwZURlZltpXSAmJiBhZGRpdGlvbmFsUHJvcCA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuZmlsdGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgaW5zdGFuY2VbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9ycy5wdXNoKHtwcm9wZXJ0eTpwYXRoLG1lc3NhZ2U6KHR5cGVvZiB2YWx1ZSkgKyAiVGhlIHByb3BlcnR5ICIgKyBpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiBpcyBub3QgZGVmaW5lZCBpbiB0aGUgc2NoZW1hIGFuZCB0aGUgc2NoZW1hIGRvZXMgbm90IGFsbG93IGFkZGl0aW9uYWwgcHJvcGVydGllcyJ9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YXIgcmVxdWlyZXMgPSBvYmpUeXBlRGVmICYmIG9ialR5cGVEZWZbaV0gJiYgb2JqVHlwZURlZltpXS5yZXF1aXJlczsKICAgICAgICAgICAgICAgICAgICBpZiAocmVxdWlyZXMgJiYgIShyZXF1aXJlcyBpbiBpbnN0YW5jZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JzLnB1c2goe3Byb3BlcnR5OnBhdGgsbWVzc2FnZToidGhlIHByZXNlbmNlIG9mIHRoZSBwcm9wZXJ0eSAiICsgaSArICIgcmVxdWlyZXMgdGhhdCAiICsgcmVxdWlyZXMgKyAiIGFsc28gYmUgcHJlc2VudCJ9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBpbnN0YW5jZVtpXTsKICAgICAgICAgICAgICAgICAgICBpZiAoYWRkaXRpb25hbFByb3AgJiYgKCEob2JqVHlwZURlZiAmJiB0eXBlb2Ygb2JqVHlwZURlZiA9PSAnb2JqZWN0JykgfHwgIShpIGluIG9ialR5cGVEZWYpKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5jb2VyY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gaW5zdGFuY2VbaV0gPSBvcHRpb25zLmNvZXJjZSh2YWx1ZSwgYWRkaXRpb25hbFByb3ApOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrUHJvcCh2YWx1ZSwgYWRkaXRpb25hbFByb3AsIHBhdGgsIGkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoIV9jaGFuZ2luZyAmJiB2YWx1ZSAmJiB2YWx1ZS4kc2NoZW1hKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9ycyA9IGVycm9ycy5jb25jYXQoY2hlY2tQcm9wKHZhbHVlLCB2YWx1ZS4kc2NoZW1hLCBwYXRoLCBpKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGVycm9yczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHNjaGVtYSkgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wKGluc3RhbmNlLCBzY2hlbWEsICcnLCBfY2hhbmdpbmcgfHwgJycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghX2NoYW5naW5nICYmIGluc3RhbmNlICYmIGluc3RhbmNlLiRzY2hlbWEpIHsKICAgICAgICAgICAgICAgIGNoZWNrUHJvcChpbnN0YW5jZSwgaW5zdGFuY2UuJHNjaGVtYSwgJycsICcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4ge3ZhbGlkOiFlcnJvcnMubGVuZ3RoLGVycm9yczplcnJvcnN9OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIHN1bW1hcnk6CiAgICAgICAgICogVGhpcyBjaGVja3MgdG8gZW5zdXJlIHRoYXQgdGhlIHJlc3VsdCBpcyB2YWxpZCBhbmQgd2lsbCB0aHJvdyBhbiBhcHByb3ByaWF0ZSBlcnJvciBtZXNzYWdlIGlmIGl0IGlzIG5vdAogICAgICAgICAqIHJlc3VsdDogdGhlIHJlc3VsdCByZXR1cm5lZCBmcm9tIGNoZWNrUHJvcGVydHlDaGFuZ2Ugb3IgdmFsaWRhdGUKICAgICAgICAgKiBAcGFyYW0gcmVzdWx0CiAgICAgICAgICovCiAgICAgICAgbXVzdEJlVmFsaWQgOiBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICAgICAgaWYgKCFyZXN1bHQudmFsaWQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IocmVzdWx0LmVycm9ycy5tYXAoCiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gImZvciBwcm9wZXJ0eSAiICsgZXJyb3IucHJvcGVydHkgKyAnOiAnICsgZXJyb3IubWVzc2FnZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkuam9pbigiLCBcbiIpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgogICAgLy8gc2V0dXAgcHJpbWl0aXZlIGNsYXNzZXMgdG8gYmUgSlNPTiBTY2hlbWEgdHlwZXMKICAgIFN0cmluZy50eXBlID0gInN0cmluZyI7CiAgICBCb29sZWFuLnR5cGUgPSAiYm9vbGVhbiI7CiAgICBOdW1iZXIudHlwZSA9ICJudW1iZXIiOwogICAgSW50ZWdlciA9IHt0eXBlOiJpbnRlZ2VyIn07CiAgICBPYmplY3QudHlwZSA9ICJvYmplY3QiOwogICAgQXJyYXkudHlwZSA9ICJhcnJheSI7CiAgICBEYXRlLnR5cGUgPSAiZGF0ZSI7CgogICAgJC52YWxpZGF0b3IgPSB3aW5kb3cuVmFsaWRhdG9yID0gVmFsaWRhdG9yOwoKfSkoalF1ZXJ5KTsKLy8gRGV0ZXJtaW5lIHdoYXQgaXMgby4KLyoqCiAqIEBpZ25vcmUKICogQHBhcmFtIG8KICovCmZ1bmN0aW9uIGhvb3ppdChvKSB7CiAgICBpZiAoby5jb25zdHJ1Y3RvciA9PT0gU3RyaW5nKSB7CiAgICAgICAgcmV0dXJuICJzdHJpbmciOwogICAgICAgIAogICAgfSBlbHNlIGlmIChvLmNvbnN0cnVjdG9yID09PSBCb29sZWFuKSB7CiAgICAgICAgcmV0dXJuICJib29sZWFuIjsKCiAgICB9IGVsc2UgaWYgKG8uY29uc3RydWN0b3IgPT09IE51bWJlcikgewoKICAgICAgICBpZiAoaXNOYU4obykpIHsKICAgICAgICAgICAgcmV0dXJuICJuYW4iOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAibnVtYmVyIjsKICAgICAgICB9CgogICAgfSBlbHNlIGlmICh0eXBlb2YgbyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICByZXR1cm4gInVuZGVmaW5lZCI7CgogICAgLy8gY29uc2lkZXI6IHR5cGVvZiBudWxsID09PSBvYmplY3QKICAgIH0gZWxzZSBpZiAobyA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiAibnVsbCI7CgogICAgLy8gY29uc2lkZXI6IHR5cGVvZiBbXSA9PT0gb2JqZWN0CiAgICB9IGVsc2UgaWYgKG8gaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgIHJldHVybiAiYXJyYXkiOwogICAgCiAgICAvLyBjb25zaWRlcjogdHlwZW9mIG5ldyBEYXRlKCkgPT09IG9iamVjdAogICAgfSBlbHNlIGlmIChvIGluc3RhbmNlb2YgRGF0ZSkgewogICAgICAgIHJldHVybiAiZGF0ZSI7CgogICAgLy8gY29uc2lkZXI6IC8uLyBpbnN0YW5jZW9mIE9iamVjdDsKICAgIC8vICAgICAgICAgICAvLi8gaW5zdGFuY2VvZiBSZWdFeHA7CiAgICAvLyAgICAgICAgICB0eXBlb2YgLy4vID09PSAiZnVuY3Rpb24iOyAvLyA9PiBmYWxzZSBpbiBJRSBhbmQgT3BlcmEsCiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRydWUgaW4gRkYgYW5kIFNhZmFyaQogICAgfSBlbHNlIGlmIChvIGluc3RhbmNlb2YgUmVnRXhwKSB7CiAgICAgICAgcmV0dXJuICJyZWdleHAiOwoKICAgIH0gZWxzZSBpZiAodHlwZW9mIG8gPT09ICJvYmplY3QiKSB7CiAgICAgICAgcmV0dXJuICJvYmplY3QiOwoKICAgIH0gZWxzZSBpZiAobyBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7CiAgICAgICAgcmV0dXJuICJmdW5jdGlvbiI7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICB9Cn0KCi8vIENhbGwgdGhlIG8gcmVsYXRlZCBjYWxsYmFjayB3aXRoIHRoZSBnaXZlbiBhcmd1bWVudHMuCi8qKgogKiBAaWdub3JlCiAqIEBwYXJhbSBvCiAqIEBwYXJhbSBjYWxsYmFja3MKICogQHBhcmFtIGFyZ3MKICovCmZ1bmN0aW9uIGJpbmRDYWxsYmFja3MobywgY2FsbGJhY2tzLCBhcmdzKSB7CiAgICB2YXIgcHJvcCA9IGhvb3ppdChvKTsKICAgIGlmIChwcm9wKSB7CiAgICAgICAgaWYgKGhvb3ppdChjYWxsYmFja3NbcHJvcF0pID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiBjYWxsYmFja3NbcHJvcF0uYXBwbHkoY2FsbGJhY2tzLCBhcmdzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gY2FsbGJhY2tzW3Byb3BdOyAvLyBvciB1bmRlZmluZWQKICAgICAgICB9CiAgICB9Cn0KLy8gVGVzdCBmb3IgZXF1YWxpdHkgYW55IEphdmFTY3JpcHQgdHlwZS4KLy8gRGlzY3Vzc2lvbnMgYW5kIHJlZmVyZW5jZTogaHR0cDovL3BoaWxyYXRoZS5jb20vYXJ0aWNsZXMvZXF1aXYKLy8gVGVzdCBzdWl0ZXM6IGh0dHA6Ly9waGlscmF0aGUuY29tL3Rlc3RzL2VxdWl2Ci8vIEF1dGhvcjogUGhpbGlwcGUgUmF0aMypIDxwcmF0aGVAZ21haWwuY29tPgovKioKICogQGlnbm9yZQogKi8KdmFyIGVxdWl2ID0gZnVuY3Rpb24gKCkgewoKICAgIHZhciBpbm5lckVxdWl2OyAvLyB0aGUgcmVhbCBlcXVpdiBmdW5jdGlvbgogICAgdmFyIGNhbGxlcnMgPSBbXTsgLy8gc3RhY2sgdG8gZGVjaWRlIGJldHdlZW4gc2tpcC9hYm9ydCBmdW5jdGlvbnMKCiAgICAKICAgIHZhciBjYWxsYmFja3MgPSBmdW5jdGlvbiAoKSB7CgogICAgICAgIC8vIGZvciBzdHJpbmcsIGJvb2xlYW4sIG51bWJlciBhbmQgbnVsbAogICAgICAgIGZ1bmN0aW9uIHVzZVN0cmljdEVxdWFsaXR5KGIsIGEpIHsKICAgICAgICAgICAgaWYgKGIgaW5zdGFuY2VvZiBhLmNvbnN0cnVjdG9yIHx8IGEgaW5zdGFuY2VvZiBiLmNvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgICAgICAvLyB0byBjYXRjaCBzaG9ydCBhbm5vdGFpb24gVlMgJ25ldycgYW5ub3RhdGlvbiBvZiBhIGRlY2xhcmF0aW9uCiAgICAgICAgICAgICAgICAvLyBlLmcuIHZhciBpID0gMTsKICAgICAgICAgICAgICAgIC8vICAgICAgdmFyIGogPSBuZXcgTnVtYmVyKDEpOwogICAgICAgICAgICAgICAgcmV0dXJuIGEgPT0gYjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBhID09PSBiOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAic3RyaW5nIjogdXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICJib29sZWFuIjogdXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICJudW1iZXIiOiB1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgIm51bGwiOiB1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgInVuZGVmaW5lZCI6IHVzZVN0cmljdEVxdWFsaXR5LAoKICAgICAgICAgICAgIm5hbiI6IGZ1bmN0aW9uIChiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaXNOYU4oYik7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAiZGF0ZSI6IGZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaG9veml0KGIpID09PSAiZGF0ZSIgJiYgYS52YWx1ZU9mKCkgPT09IGIudmFsdWVPZigpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgInJlZ2V4cCI6IGZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaG9veml0KGIpID09PSAicmVnZXhwIiAmJgogICAgICAgICAgICAgICAgICAgIGEuc291cmNlID09PSBiLnNvdXJjZSAmJiAvLyB0aGUgcmVnZXggaXRzZWxmCiAgICAgICAgICAgICAgICAgICAgYS5nbG9iYWwgPT09IGIuZ2xvYmFsICYmIC8vIGFuZCBpdHMgbW9kaWZlcnMgKGdtaSkgLi4uCiAgICAgICAgICAgICAgICAgICAgYS5pZ25vcmVDYXNlID09PSBiLmlnbm9yZUNhc2UgJiYKICAgICAgICAgICAgICAgICAgICBhLm11bHRpbGluZSA9PT0gYi5tdWx0aWxpbmU7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyAtIHNraXAgd2hlbiB0aGUgcHJvcGVydHkgaXMgYSBtZXRob2Qgb2YgYW4gaW5zdGFuY2UgKE9PUCkKICAgICAgICAgICAgLy8gLSBhYm9ydCBvdGhlcndpc2UsCiAgICAgICAgICAgIC8vICAgaW5pdGlhbCA9PT0gd291bGQgaGF2ZSBjYXRjaCBpZGVudGljYWwgcmVmZXJlbmNlcyBhbnl3YXkKICAgICAgICAgICAgImZ1bmN0aW9uIjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGNhbGxlciA9IGNhbGxlcnNbY2FsbGVycy5sZW5ndGggLSAxXTsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsZXIgIT09IE9iamVjdCAmJgogICAgICAgICAgICAgICAgICAgICAgICB0eXBlb2YgY2FsbGVyICE9PSAidW5kZWZpbmVkIjsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJhcnJheSI6IGZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICB2YXIgaTsKICAgICAgICAgICAgICAgIHZhciBsZW47CgogICAgICAgICAgICAgICAgLy8gYiBjb3VsZCBiZSBhbiBvYmplY3QgbGl0ZXJhbCBoZXJlCiAgICAgICAgICAgICAgICBpZiAoICEgKGhvb3ppdChiKSA9PT0gImFycmF5IikpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbGVuID0gYS5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAobGVuICE9PSBiLmxlbmd0aCkgeyAvLyBzYWZlIGFuZCBmYXN0ZXIKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiggISBpbm5lckVxdWl2KGFbaV0sIGJbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJvYmplY3QiOiBmdW5jdGlvbiAoYiwgYSkgewogICAgICAgICAgICAgICAgdmFyIGk7CiAgICAgICAgICAgICAgICB2YXIgZXEgPSB0cnVlOyAvLyB1bmxlc3Mgd2UgY2FuIHByb292ZSBpdAogICAgICAgICAgICAgICAgdmFyIGFQcm9wZXJ0aWVzID0gW10sIGJQcm9wZXJ0aWVzID0gW107IC8vIGNvbGxlY3Rpb24gb2Ygc3RyaW5ncwoKICAgICAgICAgICAgICAgIC8vIGNvbXBhcmluZyBjb25zdHJ1Y3RvcnMgaXMgbW9yZSBzdHJpY3QgdGhhbiB1c2luZyBpbnN0YW5jZW9mCiAgICAgICAgICAgICAgICBpZiAoIGEuY29uc3RydWN0b3IgIT09IGIuY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gc3RhY2sgY29uc3RydWN0b3IgYmVmb3JlIHRyYXZlcnNpbmcgcHJvcGVydGllcwogICAgICAgICAgICAgICAgY2FsbGVycy5wdXNoKGEuY29uc3RydWN0b3IpOwoKICAgICAgICAgICAgICAgIGZvciAoaSBpbiBhKSB7IC8vIGJlIHN0cmljdDogZG9uJ3QgZW5zdXJlcyBoYXNPd25Qcm9wZXJ0eSBhbmQgZ28gZGVlcAoKICAgICAgICAgICAgICAgICAgICBhUHJvcGVydGllcy5wdXNoKGkpOyAvLyBjb2xsZWN0IGEncyBwcm9wZXJ0aWVzCgogICAgICAgICAgICAgICAgICAgIGlmICggISBpbm5lckVxdWl2KGFbaV0sIGJbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVxID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxlcnMucG9wKCk7IC8vIHVuc3RhY2ssIHdlIGFyZSBkb25lCgogICAgICAgICAgICAgICAgZm9yIChpIGluIGIpIHsKICAgICAgICAgICAgICAgICAgICBiUHJvcGVydGllcy5wdXNoKGkpOyAvLyBjb2xsZWN0IGIncyBwcm9wZXJ0aWVzCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRW5zdXJlcyBpZGVudGljYWwgcHJvcGVydGllcyBuYW1lCiAgICAgICAgICAgICAgICByZXR1cm4gZXEgJiYgaW5uZXJFcXVpdihhUHJvcGVydGllcy5zb3J0KCksIGJQcm9wZXJ0aWVzLnNvcnQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfSgpOwogICAgLyoqCiAgICAgKiBAaWdub3JlCiAgICAgKi8KICAgIGlubmVyRXF1aXYgPSBmdW5jdGlvbiAoKSB7IC8vIGNhbiB0YWtlIG11bHRpcGxlIGFyZ3VtZW50cwogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmFwcGx5KGFyZ3VtZW50cyk7CiAgICAgICAgaWYgKGFyZ3MubGVuZ3RoIDwgMikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gZW5kIHRyYW5zaXRpb24KICAgICAgICB9CgogICAgICAgIHJldHVybiAoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgaWYgKGEgPT09IGIpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBjYXRjaCB0aGUgbW9zdCB5b3UgY2FuCiAgICAgICAgICAgIH0gZWxzZSBpZiAoYSA9PT0gbnVsbCB8fCBiID09PSBudWxsIHx8IHR5cGVvZiBhID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgYiA9PT0gInVuZGVmaW5lZCIgfHwgaG9veml0KGEpICE9PSBob296aXQoYikpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsgLy8gZG9uJ3QgbG9zZSB0aW1lIHdpdGggZXJyb3IgcHJvbmUgY2FzZXMKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBiaW5kQ2FsbGJhY2tzKGEsIGNhbGxiYWNrcywgW2IsIGFdKTsKICAgICAgICAgICAgfQoKICAgICAgICAvLyBhcHBseSB0cmFuc2l0aW9uIHdpdGggKDEuLm4pIGFyZ3VtZW50cwogICAgICAgIH0pKGFyZ3NbMF0sIGFyZ3NbMV0pICYmIGFyZ3VtZW50cy5jYWxsZWUuYXBwbHkodGhpcywgYXJncy5zcGxpY2UoMSwgYXJncy5sZW5ndGggLTEpKTsKICAgIH07CgogICAgcmV0dXJuIGlubmVyRXF1aXY7Cgp9KCk7LyoKIE1hc2tlZCBJbnB1dCBwbHVnaW4gZm9yIGpRdWVyeQogQ29weXJpZ2h0IChjKSAyMDA3LTIwMTMgSm9zaCBCdXNoIChkaWdpdGFsYnVzaC5jb20pCiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgKGh0dHA6Ly9kaWdpdGFsYnVzaC5jb20vcHJvamVjdHMvbWFza2VkLWlucHV0LXBsdWdpbi8jbGljZW5zZSkKIFZlcnNpb246IDEuMy4xCiAqLwooZnVuY3Rpb24oJCkgewogICAgZnVuY3Rpb24gZ2V0UGFzdGVFdmVudCgpIHsKICAgICAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpLAogICAgICAgICAgICBuYW1lID0gJ29ucGFzdGUnOwogICAgICAgIGVsLnNldEF0dHJpYnV0ZShuYW1lLCAnJyk7CiAgICAgICAgcmV0dXJuICh0eXBlb2YgZWxbbmFtZV0gPT09ICdmdW5jdGlvbicpPydwYXN0ZSc6J2lucHV0JzsKICAgIH0KCiAgICB2YXIgcGFzdGVFdmVudE5hbWUgPSBnZXRQYXN0ZUV2ZW50KCkgKyAiLm1hc2siLAogICAgICAgIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKICAgICAgICBpUGhvbmUgPSAvaXBob25lL2kudGVzdCh1YSksCiAgICAgICAgYW5kcm9pZD0vYW5kcm9pZC9pLnRlc3QodWEpLAogICAgICAgIGNhcmV0VGltZW91dElkOwoKICAgICQubWFzayA9IHsKICAgICAgICAvL1ByZWRlZmluZWQgY2hhcmFjdGVyIGRlZmluaXRpb25zCiAgICAgICAgZGVmaW5pdGlvbnM6IHsKICAgICAgICAgICAgJzknOiAiWzAtOV0iLAogICAgICAgICAgICAnYSc6ICJbQS1aYS16XSIsCiAgICAgICAgICAgICcqJzogIltBLVphLXowLTldIgogICAgICAgIH0sCiAgICAgICAgZGF0YU5hbWU6ICJyYXdNYXNrRm4iLAogICAgICAgIHBsYWNlaG9sZGVyOiAnXycKICAgIH07CgogICAgJC5mbi5leHRlbmQoewogICAgICAgIC8vSGVscGVyIEZ1bmN0aW9uIGZvciBDYXJldCBwb3NpdGlvbmluZwogICAgICAgIGNhcmV0OiBmdW5jdGlvbihiZWdpbiwgZW5kKSB7CiAgICAgICAgICAgIHZhciByYW5nZTsKCiAgICAgICAgICAgIGlmICh0aGlzLmxlbmd0aCA9PT0gMCB8fCB0aGlzLmlzKCI6aGlkZGVuIikpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGVvZiBiZWdpbiA9PSAnbnVtYmVyJykgewogICAgICAgICAgICAgICAgZW5kID0gKHR5cGVvZiBlbmQgPT09ICdudW1iZXInKSA/IGVuZCA6IGJlZ2luOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zZXRTZWxlY3Rpb25SYW5nZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFNlbGVjdGlvblJhbmdlKGJlZ2luLCBlbmQpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5jcmVhdGVUZXh0UmFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UgPSB0aGlzLmNyZWF0ZVRleHRSYW5nZSgpOwogICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5jb2xsYXBzZSh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UubW92ZUVuZCgnY2hhcmFjdGVyJywgZW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UubW92ZVN0YXJ0KCdjaGFyYWN0ZXInLCBiZWdpbik7CiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNlbGVjdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHRoaXNbMF0uc2V0U2VsZWN0aW9uUmFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICBiZWdpbiA9IHRoaXNbMF0uc2VsZWN0aW9uU3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgZW5kID0gdGhpc1swXS5zZWxlY3Rpb25FbmQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRvY3VtZW50LnNlbGVjdGlvbiAmJiBkb2N1bWVudC5zZWxlY3Rpb24uY3JlYXRlUmFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICByYW5nZSA9IGRvY3VtZW50LnNlbGVjdGlvbi5jcmVhdGVSYW5nZSgpOwogICAgICAgICAgICAgICAgICAgIGJlZ2luID0gMCAtIHJhbmdlLmR1cGxpY2F0ZSgpLm1vdmVTdGFydCgnY2hhcmFjdGVyJywgLTEwMDAwMCk7CiAgICAgICAgICAgICAgICAgICAgZW5kID0gYmVnaW4gKyByYW5nZS50ZXh0Lmxlbmd0aDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB7IGJlZ2luOiBiZWdpbiwgZW5kOiBlbmQgfTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgdW5tYXNrOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudHJpZ2dlcigidW5tYXNrIik7CiAgICAgICAgfSwKICAgICAgICBtYXNrOiBmdW5jdGlvbihtYXNrLCBzZXR0aW5ncykgewogICAgICAgICAgICB2YXIgaW5wdXQsCiAgICAgICAgICAgICAgICBkZWZzLAogICAgICAgICAgICAgICAgdGVzdHMsCiAgICAgICAgICAgICAgICBwYXJ0aWFsUG9zaXRpb24sCiAgICAgICAgICAgICAgICBmaXJzdE5vbk1hc2tQb3MsCiAgICAgICAgICAgICAgICBsZW47CgogICAgICAgICAgICBpZiAoIW1hc2sgJiYgdGhpcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBpbnB1dCA9ICQodGhpc1swXSk7CiAgICAgICAgICAgICAgICByZXR1cm4gaW5wdXQuZGF0YSgkLm1hc2suZGF0YU5hbWUpKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0dGluZ3MgPSAkLmV4dGVuZCh7CiAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcjogJC5tYXNrLnBsYWNlaG9sZGVyLCAvLyBMb2FkIGRlZmF1bHQgcGxhY2Vob2xkZXIKICAgICAgICAgICAgICAgIGNvbXBsZXRlZDogbnVsbAogICAgICAgICAgICB9LCBzZXR0aW5ncyk7CgoKICAgICAgICAgICAgZGVmcyA9ICQubWFzay5kZWZpbml0aW9uczsKICAgICAgICAgICAgdGVzdHMgPSBbXTsKICAgICAgICAgICAgcGFydGlhbFBvc2l0aW9uID0gbGVuID0gbWFzay5sZW5ndGg7CiAgICAgICAgICAgIGZpcnN0Tm9uTWFza1BvcyA9IG51bGw7CgogICAgICAgICAgICAkLmVhY2gobWFzay5zcGxpdCgiIiksIGZ1bmN0aW9uKGksIGMpIHsKICAgICAgICAgICAgICAgIGlmIChjID09ICc/JykgewogICAgICAgICAgICAgICAgICAgIGxlbi0tOwogICAgICAgICAgICAgICAgICAgIHBhcnRpYWxQb3NpdGlvbiA9IGk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRlZnNbY10pIHsKICAgICAgICAgICAgICAgICAgICB0ZXN0cy5wdXNoKG5ldyBSZWdFeHAoZGVmc1tjXSkpOwogICAgICAgICAgICAgICAgICAgIGlmIChmaXJzdE5vbk1hc2tQb3MgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3ROb25NYXNrUG9zID0gdGVzdHMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRlc3RzLnB1c2gobnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXMudHJpZ2dlcigidW5tYXNrIikuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9ICQodGhpcyksCiAgICAgICAgICAgICAgICAgICAgYnVmZmVyID0gJC5tYXAoCiAgICAgICAgICAgICAgICAgICAgICAgIG1hc2suc3BsaXQoIiIpLAogICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbihjLCBpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYyAhPSAnPycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGVmc1tjXSA/IHNldHRpbmdzLnBsYWNlaG9sZGVyIDogYzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgZm9jdXNUZXh0ID0gaW5wdXQudmFsKCk7CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gc2Vla05leHQocG9zKSB7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKCsrcG9zIDwgbGVuICYmICF0ZXN0c1twb3NdKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcG9zOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHNlZWtQcmV2KHBvcykgewogICAgICAgICAgICAgICAgICAgIHdoaWxlICgtLXBvcyA+PSAwICYmICF0ZXN0c1twb3NdKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcG9zOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHNoaWZ0TChiZWdpbixlbmQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaSwKICAgICAgICAgICAgICAgICAgICAgICAgajsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGJlZ2luPDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gYmVnaW4sIGogPSBzZWVrTmV4dChlbmQpOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRlc3RzW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaiA8IGxlbiAmJiB0ZXN0c1tpXS50ZXN0KGJ1ZmZlcltqXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidWZmZXJbaV0gPSBidWZmZXJbal07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVmZmVyW2pdID0gc2V0dGluZ3MucGxhY2Vob2xkZXI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGogPSBzZWVrTmV4dChqKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB3cml0ZUJ1ZmZlcigpOwogICAgICAgICAgICAgICAgICAgIGlucHV0LmNhcmV0KE1hdGgubWF4KGZpcnN0Tm9uTWFza1BvcywgYmVnaW4pKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzaGlmdFIocG9zKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGksCiAgICAgICAgICAgICAgICAgICAgICAgIGMsCiAgICAgICAgICAgICAgICAgICAgICAgIGosCiAgICAgICAgICAgICAgICAgICAgICAgIHQ7CgogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IHBvcywgYyA9IHNldHRpbmdzLnBsYWNlaG9sZGVyOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRlc3RzW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqID0gc2Vla05leHQoaSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ID0gYnVmZmVyW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVmZmVyW2ldID0gYzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqIDwgbGVuICYmIHRlc3RzW2pdLnRlc3QodCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjID0gdDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24ga2V5ZG93bkV2ZW50KGUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgayA9IGUud2hpY2gsCiAgICAgICAgICAgICAgICAgICAgICAgIHBvcywKICAgICAgICAgICAgICAgICAgICAgICAgYmVnaW4sCiAgICAgICAgICAgICAgICAgICAgICAgIGVuZDsKCiAgICAgICAgICAgICAgICAgICAgLy9iYWNrc3BhY2UsIGRlbGV0ZSwgYW5kIGVzY2FwZSBnZXQgc3BlY2lhbCB0cmVhdG1lbnQKICAgICAgICAgICAgICAgICAgICBpZiAoayA9PT0gOCB8fCBrID09PSA0NiB8fCAoaVBob25lICYmIGsgPT09IDEyNykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zID0gaW5wdXQuY2FyZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgYmVnaW4gPSBwb3MuYmVnaW47CiAgICAgICAgICAgICAgICAgICAgICAgIGVuZCA9IHBvcy5lbmQ7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW5kIC0gYmVnaW4gPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJlZ2luPWshPT00Nj9zZWVrUHJldihiZWdpbik6KGVuZD1zZWVrTmV4dChiZWdpbi0xKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmQ9az09PTQ2P3NlZWtOZXh0KGVuZCk6ZW5kOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyQnVmZmVyKGJlZ2luLCBlbmQpOwogICAgICAgICAgICAgICAgICAgICAgICBzaGlmdEwoYmVnaW4sIGVuZCAtIDEpOwoKICAgICAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoayA9PSAyNykgey8vZXNjYXBlCiAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0LnZhbChmb2N1c1RleHQpOwogICAgICAgICAgICAgICAgICAgICAgICBpbnB1dC5jYXJldCgwLCBjaGVja1ZhbCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBrZXlwcmVzc0V2ZW50KGUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgayA9IGUud2hpY2gsCiAgICAgICAgICAgICAgICAgICAgICAgIHBvcyA9IGlucHV0LmNhcmV0KCksCiAgICAgICAgICAgICAgICAgICAgICAgIHAsCiAgICAgICAgICAgICAgICAgICAgICAgIGMsCiAgICAgICAgICAgICAgICAgICAgICAgIG5leHQ7CgogICAgICAgICAgICAgICAgICAgIGlmIChlLmN0cmxLZXkgfHwgZS5hbHRLZXkgfHwgZS5tZXRhS2V5IHx8IGsgPCAzMikgey8vSWdub3JlCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBvcy5lbmQgLSBwb3MuYmVnaW4gIT09IDApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJCdWZmZXIocG9zLmJlZ2luLCBwb3MuZW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoaWZ0TChwb3MuYmVnaW4sIHBvcy5lbmQtMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHAgPSBzZWVrTmV4dChwb3MuYmVnaW4gLSAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAgPCBsZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGMgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGspOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRlc3RzW3BdLnRlc3QoYykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGlmdFIocCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlcltwXSA9IGM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd3JpdGVCdWZmZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0ID0gc2Vla05leHQocCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGFuZHJvaWQpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCQucHJveHkoJC5mbi5jYXJldCxpbnB1dCxuZXh0KSwwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQuY2FyZXQobmV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2V0dGluZ3MuY29tcGxldGVkICYmIG5leHQgPj0gbGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldHRpbmdzLmNvbXBsZXRlZC5jYWxsKGlucHV0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjbGVhckJ1ZmZlcihzdGFydCwgZW5kKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGk7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gc3RhcnQ7IGkgPCBlbmQgJiYgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0ZXN0c1tpXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVmZmVyW2ldID0gc2V0dGluZ3MucGxhY2Vob2xkZXI7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gd3JpdGVCdWZmZXIoKSB7CiAgICAgICAgICAgICAgICAgICAgaW5wdXQudmFsKGJ1ZmZlci5qb2luKCcnKSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gY2hlY2tWYWwoYWxsb3cpIHsKICAgICAgICAgICAgICAgICAgICAvL3RyeSB0byBwbGFjZSBjaGFyYWN0ZXJzIHdoZXJlIHRoZXkgYmVsb25nCiAgICAgICAgICAgICAgICAgICAgdmFyIHRlc3QgPSBpbnB1dC52YWwoKSwKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdE1hdGNoID0gLTEsCiAgICAgICAgICAgICAgICAgICAgICAgIGksCiAgICAgICAgICAgICAgICAgICAgICAgIGM7CgogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIHBvcyA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGVzdHNbaV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlcltpXSA9IHNldHRpbmdzLnBsYWNlaG9sZGVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKHBvcysrIDwgdGVzdC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjID0gdGVzdC5jaGFyQXQocG9zIC0gMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRlc3RzW2ldLnRlc3QoYykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVmZmVyW2ldID0gYzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdE1hdGNoID0gaTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBvcyA+IHRlc3QubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYnVmZmVyW2ldID09PSB0ZXN0LmNoYXJBdChwb3MpICYmIGkgIT09IHBhcnRpYWxQb3NpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0TWF0Y2ggPSBpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChhbGxvdykgewogICAgICAgICAgICAgICAgICAgICAgICB3cml0ZUJ1ZmZlcigpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobGFzdE1hdGNoICsgMSA8IHBhcnRpYWxQb3NpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpbnB1dC52YWwoIiIpOwogICAgICAgICAgICAgICAgICAgICAgICBjbGVhckJ1ZmZlcigwLCBsZW4pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdyaXRlQnVmZmVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0LnZhbChpbnB1dC52YWwoKS5zdWJzdHJpbmcoMCwgbGFzdE1hdGNoICsgMSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gKHBhcnRpYWxQb3NpdGlvbiA/IGkgOiBmaXJzdE5vbk1hc2tQb3MpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlucHV0LmRhdGEoJC5tYXNrLmRhdGFOYW1lLGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICQubWFwKGJ1ZmZlciwgZnVuY3Rpb24oYywgaSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGVzdHNbaV0mJmMhPXNldHRpbmdzLnBsYWNlaG9sZGVyID8gYyA6IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfSkuam9pbignJyk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBpZiAoIWlucHV0LmF0dHIoInJlYWRvbmx5IikpCiAgICAgICAgICAgICAgICAgICAgaW5wdXQKICAgICAgICAgICAgICAgICAgICAgICAgLm9uZSgidW5tYXNrIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnB1dAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC51bmJpbmQoIi5tYXNrIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVtb3ZlRGF0YSgkLm1hc2suZGF0YU5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAuYmluZCgiZm9jdXMubWFzayIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGNhcmV0VGltZW91dElkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwb3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZUNhcmV0OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvY3VzVGV4dCA9IGlucHV0LnZhbCgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFVaSTogYWRkZWQgdGhpcyB0byBhbGxvdyBmb3IgdmFsKCcnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2VlOiBodHRwczovL2dpdGh1Yi5jb20vZGlnaXRhbEJ1c2gvanF1ZXJ5Lm1hc2tlZGlucHV0L2lzc3Vlcy8yOQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvY3VzVGV4dCA9PT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhckJ1ZmZlcigwLCBsZW4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdyaXRlQnVmZmVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MgPSBjaGVja1ZhbCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRU5EIFVaSQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vcG9zID0gY2hlY2tWYWwoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXJldFRpbWVvdXRJZCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3cml0ZUJ1ZmZlcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwb3MgPT0gbWFzay5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQuY2FyZXQoMCwgcG9zKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnB1dC5jYXJldChwb3MpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgLmJpbmQoImJsdXIubWFzayIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tWYWwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnB1dC52YWwoKSAhPSBmb2N1c1RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQuY2hhbmdlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIC5iaW5kKCJrZXlkb3duLm1hc2siLCBrZXlkb3duRXZlbnQpCiAgICAgICAgICAgICAgICAgICAgICAgIC5iaW5kKCJrZXlwcmVzcy5tYXNrIiwga2V5cHJlc3NFdmVudCkKICAgICAgICAgICAgICAgICAgICAgICAgLmJpbmQocGFzdGVFdmVudE5hbWUsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcG9zPWNoZWNrVmFsKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0LmNhcmV0KHBvcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNldHRpbmdzLmNvbXBsZXRlZCAmJiBwb3MgPT0gaW5wdXQudmFsKCkubGVuZ3RoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXR0aW5ncy5jb21wbGV0ZWQuY2FsbChpbnB1dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBjaGVja1ZhbCgpOyAvL1BlcmZvcm0gaW5pdGlhbCBjaGVjayBmb3IgZXhpc3RpbmcgdmFsdWVzCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0pOwoKCn0pKGpRdWVyeSk7Lypqc2hpbnQgLVcwMDQgKi8gLy8gZHVwbGljYXRlIHZhcmlhYmxlcwovKmpzaGludCAtVzA4MyAqLyAvLyBpbmxpbmUgZnVuY3Rpb25zIGFyZSB1c2VkIHNhZmVseQovKioKICogQWxwYWNhIGZvcm1zIGVuZ2luZSBmb3IgalF1ZXJ5CiAqLwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2E7CgogICAgLyoqCiAgICAgKiBAbmFtZXNwYWNlIFN0YXRpYyBtZXRob2QgdG8gYnVpbGQgYW4gQWxwYWNhIGZpZWxkIGluc3RhbmNlIGJvdW5kIHRvIGEgRE9NIGVsZW1lbnQuCiAgICAgKiBAZGVzY3JpcHRpb24gPHA+VXNhZ2U6PC9wPgogICAgICogPHA+CiAgICAgKiAxOiBCaW5kcyBhIGNvbnRyb2wgdXNpbmcgdGhlIGNvbnRlbnRzIG9mICQoZWwpIG9yIGhhbmRzIGJhY2sgYSBwcmV2aW91c2x5IGJvdW5kIGNvbnRyb2w8YnIvPgogICAgICogPGNvZGU+CiAgICAgKiAgICAgPHByZT4KICAgICAqICAgICAgQWxwYWNhKGVsKQogICAgICogICAgIDwvcHJlPgogICAgICogPC9jb2RlPgogICAgICogPC9wPgogICAgICogPHA+CiAgICAgKiAyOiBCaW5kcyBhIGNvbnRyb2wgdG8gJChlbCkgdXNpbmcgdGhlIGdpdmVuIGRhdGEgKG9ubHkgZm9yIG5vbi1vYmplY3QgdHlwZXMpLjxici8+CiAgICAgKiA8Y29kZT4KICAgICAqICAgICA8cHJlPgogICAgICogICAgICBBbHBhY2EoZWwsIGRhdGEpCiAgICAgKiAgICAgPC9wcmU+CiAgICAgKiA8L2NvZGU+CiAgICAgKiA8L3A+CiAgICAgKiA8cD4KICAgICAqIDM6IEJpbmRzIGEgY29udHJvbCB0byAkKGVsKSB1c2luZyB0aGUgZ2l2ZW4gY29uZmlndXJhdGlvbiBvYmplY3QuPGJyLz4KICAgICAqIDwvcD4KICAgICAqIDxjb2RlPgogICAgICogICAgIDxwcmU+CiAgICAgKiBBbHBhY2EoZWwsewogICAgICogICAiZGF0YSIgOiB7QW55fSBmaWVsZCBkYXRhIChvcHRpb25hbCksCiAgICAgKiAgICJzY2hlbWEiOiB7T2JqZWN0fSBmaWVsZCBzY2hlbWEgKG9wdGlvbmFsKSwKICAgICAqICAgIm9wdGlvbnMiIDoge09iamVjdH0gZmllbGQgb3B0aW9ucyAob3B0aW9uYWwpLAogICAgICogICAidmlldyI6IHtPYmplY3R8U3RyaW5nfSBmaWVsZCB2aWV3IChvYmplY3Qgb3IgaWQgcmVmZXJlbmNlKSAob3B0aW9uYWwpLAogICAgICogICAicmVuZGVyIjoge0Z1bmN0aW9ufSBjYWxsYmFjayBmdW5jdGlvbiBmb3IgcmVwbGFjaW5nIGRlZmF1bHQgcmVuZGVyaW5nIG1ldGhvZCAob3B0aW9uYWwpLAogICAgICogICAicG9zdFJlbmRlciI6IHtGdW5jdGlvbn0gY2FsbGJhY2sgZnVuY3Rpb24gZm9yIHBvc3QtcmVuZGVyaW5nICAob3B0aW9uYWwpLAogICAgICogICAiZXJyb3IiOiB7RnVuY3Rpb259IGNhbGxiYWNrIGZ1bmN0aW9uIGZvciBlcnJvciBoYW5kbGluZyAgKG9wdGlvbmFsKSwKICAgICAqICAgImNvbm5lY3RvciI6IHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgZm9yIHJldHJpZXZpbmcgb3Igc3RvcmluZyBkYXRhLCBzY2hlbWEsIG9wdGlvbnMsCiAgICAgKiAgICAgICAgICAgICAgICB2aWV3IGFuZCB0ZW1wbGF0ZXMuIChvcHRpb25hbCksCiAgICAgKiB9KTsKICAgICAqICAgIDwvcHJlPgogICAgICo8L2NvZGU+CiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBhbHBhY2EgZmllbGQgaW5zdGFuY2UKICAgICAqLwogICAgQWxwYWNhID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBBbHBhY2EubWFrZUFycmF5KGFyZ3VtZW50cyk7CiAgICAgICAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIC8vIGlsbGVnYWwKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS50aHJvd0RlZmF1bHRFcnJvcigiWW91IG11c3Qgc3VwcGx5IGF0IGxlYXN0IG9uZSBhcmd1bWVudCB3aGljaCBpcyB0aGUgZWxlbWVudCBhZ2FpbnN0IHdoaWNoIHRvIGFwcGx5IHRoZSBBbHBhY2EgZ2VuZXJhdGVkIGZvcm0iKTsKICAgICAgICB9CgogICAgICAgIC8vIGVsZW1lbnQgaXMgdGhlIGZpcnN0IGFyZ3VtZW50CiAgICAgICAgdmFyIGVsID0gYXJnc1swXTsKCiAgICAgICAgLy8gb3RoZXIgYXJndW1lbnRzIHdlIG1heSB3YW50IHRvIGZpZ3VyZSBvdXQKICAgICAgICB2YXIgZGF0YSA9IG51bGw7CiAgICAgICAgdmFyIHNjaGVtYSA9IG51bGw7CiAgICAgICAgdmFyIG9wdGlvbnMgPSBudWxsOwogICAgICAgIHZhciB2aWV3ID0gbnVsbDsKICAgICAgICB2YXIgY2FsbGJhY2sgPSBudWxsOwogICAgICAgIHZhciByZW5kZXJlZENhbGxiYWNrID0gbnVsbDsKICAgICAgICB2YXIgZXJyb3JDYWxsYmFjayA9IG51bGw7CiAgICAgICAgdmFyIGNvbm5lY3RvciA9IG51bGw7CiAgICAgICAgdmFyIG5vdFRvcExldmVsID0gZmFsc2U7CiAgICAgICAgdmFyIGlzRHluYW1pY0NyZWF0aW9uID0gZmFsc2U7CiAgICAgICAgdmFyIGluaXRpYWxTZXR0aW5ncyA9IHt9OwoKICAgICAgICAvLyBpZiB0aGVzZSBvcHRpb25zIGFyZSBwcm92aWRlZCwgdGhlbiBkYXRhLCBzY2hlbWEsIG9wdGlvbnMgYW5kIHNvdXJjZSBhcmUgbG9hZGVkIHZpYSBjb25uZWN0b3IKICAgICAgICB2YXIgZGF0YVNvdXJjZSA9IG51bGw7CiAgICAgICAgdmFyIHNjaGVtYVNvdXJjZSA9IG51bGw7CiAgICAgICAgdmFyIG9wdGlvbnNTb3VyY2UgPSBudWxsOwogICAgICAgIHZhciB2aWV3U291cmNlID0gbnVsbDsKCiAgICAgICAgaWYgKGFyZ3MubGVuZ3RoID09IDEpIHsKICAgICAgICAgICAgLy8gaGFuZHMgYmFjayB0aGUgZmllbGQgaW5zdGFuY2UgdGhhdCBpcyBib3VuZCBkaXJlY3RseSB1bmRlciB0aGUgc3BlY2lmaWVkIGVsZW1lbnQKICAgICAgICAgICAgLy8gdmFyIGZpZWxkID0gQWxwYWNhKGVsKTsKICAgICAgICAgICAgdmFyIGRvbUVsZW1lbnRzID0gJChlbCkuZmluZCgiOmZpcnN0Iik7CgogICAgICAgICAgICB2YXIgZmllbGQgPSBudWxsOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRvbUVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgZG9tRWxlbWVudCA9IGRvbUVsZW1lbnRzW2ldOwogICAgICAgICAgICAgICAgdmFyIGZpZWxkSWQgPSAkKGRvbUVsZW1lbnQpLmF0dHIoImFscGFjYS1maWVsZC1pZCIpOwogICAgICAgICAgICAgICAgaWYgKGZpZWxkSWQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX2ZpZWxkID0gQWxwYWNhLmZpZWxkSW5zdGFuY2VzW2ZpZWxkSWRdOwogICAgICAgICAgICAgICAgICAgIGlmIChfZmllbGQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGQgPSBfZmllbGQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZmllbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmaWVsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIG90aGVyd2lzZSwgZ3JhYiB0aGUgZGF0YSBpbnNpZGUgdGhlIGVsZW1lbnQgYW5kIHVzZSB0aGF0IGZvciB0aGUgY29udHJvbAogICAgICAgICAgICAgICAgdmFyIGRvbURhdGEgPSAkKGVsKS5odG1sKCk7CiAgICAgICAgICAgICAgICAkKGVsKS5odG1sKCIiKTsKICAgICAgICAgICAgICAgIGRhdGEgPSBkb21EYXRhOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoYXJncy5sZW5ndGggPj0gMikgewogICAgICAgICAgICBpZiAoQWxwYWNhLmlzT2JqZWN0KGFyZ3NbMV0pKSB7CiAgICAgICAgICAgICAgICBkYXRhID0gYXJnc1sxXS5kYXRhOwogICAgICAgICAgICAgICAgc2NoZW1hID0gYXJnc1sxXS5zY2hlbWE7CiAgICAgICAgICAgICAgICBvcHRpb25zID0gYXJnc1sxXS5vcHRpb25zOwogICAgICAgICAgICAgICAgdmlldyA9IGFyZ3NbMV0udmlldzsKICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gYXJnc1sxXS5yZW5kZXI7CiAgICAgICAgICAgICAgICByZW5kZXJlZENhbGxiYWNrID0gYXJnc1sxXS5wb3N0UmVuZGVyOwogICAgICAgICAgICAgICAgZXJyb3JDYWxsYmFjayA9IGFyZ3NbMV0uZXJyb3I7CiAgICAgICAgICAgICAgICBjb25uZWN0b3IgPSBhcmdzWzFdLmNvbm5lY3RvcjsKCiAgICAgICAgICAgICAgICAvLyBzb3VyY2VzCiAgICAgICAgICAgICAgICBkYXRhU291cmNlID0gYXJnc1sxXS5kYXRhU291cmNlOwogICAgICAgICAgICAgICAgc2NoZW1hU291cmNlID0gYXJnc1sxXS5zY2hlbWFTb3VyY2U7CiAgICAgICAgICAgICAgICBvcHRpb25zU291cmNlID0gYXJnc1sxXS5vcHRpb25zU291cmNlOwogICAgICAgICAgICAgICAgdmlld1NvdXJjZSA9IGFyZ3NbMV0udmlld1NvdXJjZTsKCiAgICAgICAgICAgICAgICAvLyBvdGhlcgogICAgICAgICAgICAgICAgaWYgKGFyZ3NbMV0udWkpIHsKICAgICAgICAgICAgICAgICAgICBpbml0aWFsU2V0dGluZ3NbInVpIl0gPSBhcmdzWzFdLnVpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGFyZ3NbMV0udHlwZSkgewogICAgICAgICAgICAgICAgICAgIGluaXRpYWxTZXR0aW5nc1sidHlwZSJdID0gYXJnc1sxXS50eXBlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eShhcmdzWzFdLm5vdFRvcExldmVsKSkgewogICAgICAgICAgICAgICAgICAgIG5vdFRvcExldmVsID0gYXJnc1sxXS5ub3RUb3BMZXZlbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghQWxwYWNhLmlzRW1wdHkoYXJnc1sxXS5pc0R5bmFtaWNDcmVhdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICBpc0R5bmFtaWNDcmVhdGlvbiA9IGFyZ3NbMV0uaXNEeW5hbWljQ3JlYXRpb247CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyAiZGF0YSIgaXMgdGhlIHNlY29uZCBhcmd1bWVudAogICAgICAgICAgICAgICAgZGF0YSA9IGFyZ3NbMV07CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzRnVuY3Rpb24oZGF0YSkpIHsKICAgICAgICAgICAgICAgICAgICBkYXRhID0gZGF0YSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBpZiBubyBlcnJvciBjYWxsYmFjayBpcyBwcm92aWRlZCwgd2UgZmFsbCBiYWNrIHRvIGEgYnJvd3NlciBhbGVydAogICAgICAgIGlmIChBbHBhY2EuaXNFbXB0eShlcnJvckNhbGxiYWNrKSkgewogICAgICAgICAgICBlcnJvckNhbGxiYWNrID0gQWxwYWNhLmRlZmF1bHRFcnJvckNhbGxiYWNrOwogICAgICAgIH0KCiAgICAgICAgaWYgKEFscGFjYS5pc0VtcHR5KGNvbm5lY3RvcikpIHsKICAgICAgICAgICAgdmFyIGNvbm5lY3RvckNsYXNzID0gQWxwYWNhLmdldENvbm5lY3RvckNsYXNzKCJkZWZhdWx0Iik7CiAgICAgICAgICAgIGNvbm5lY3RvciA9IG5ldyBjb25uZWN0b3JDbGFzcygiZGVmYXVsdCIpOwogICAgICAgIH0KCiAgICAgICAgLy8gY29udGFpbmVyIGNhbiBlaXRoZXIgYmUgYSBkb20gaWQgb3IgYSBkb20gZWxlbWVudAogICAgICAgIGlmIChlbCkgewogICAgICAgICAgICBpZiAoQWxwYWNhLmlzU3RyaW5nKGVsKSkgewogICAgICAgICAgICAgICAgZWwgPSAkKCIjIiArIGVsKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gRm9yIHNlY29uZCBvciBkZWVwZXIgbGV2ZWwgb2YgZmllbGRzLCBkZWZhdWx0IGxvYWRlciBzaG91bGQgYmUgdGhlIG9uZSB0byBkbyBsb2FkQWxsCiAgICAgICAgLy8gc2luY2Ugc2NoZW1hLCBkYXRhLCBvcHRpb25zIGFuZCB2aWV3IHNob3VsZCBoYXZlIGFscmVhZHkgYmVlbiBsb2FkZWQuCiAgICAgICAgLy8gVW5sZXNzIHdlIHdhbnQgdG8gbG9hZCBpbmRpdmlkdWFsIGZpZWxkcyAob3RoZXIgdGhhbiB0aGUgdGVtcGxhdGVzKSB1c2luZyB0aGUgcHJvdmlkZWQKICAgICAgICAvLyBsb2FkZXIsIHRoaXMgc2hvdWxkIGJlIGdvb2QgZW5vdWdoLiBUaGUgYmVuZWZpdCBpcyBzYXZpbmcgdGltZSBvbiBsb2FkZXIgZm9ybWF0IGNoZWNraW5nLgoKICAgICAgICB2YXIgbG9hZEFsbENvbm5lY3RvciA9IGNvbm5lY3RvcjsKCiAgICAgICAgaWYgKG5vdFRvcExldmVsKSB7CiAgICAgICAgICAgIHZhciBsb2FkQWxsQ29ubmVjdG9yQ2xhc3MgPSBBbHBhY2EuZ2V0Q29ubmVjdG9yQ2xhc3MoImRlZmF1bHQiKTsKICAgICAgICAgICAgbG9hZEFsbENvbm5lY3RvciA9IG5ldyBsb2FkQWxsQ29ubmVjdG9yQ2xhc3MoImRlZmF1bHQiKTsKICAgICAgICB9CgogICAgICAgIC8vIHdyYXAgcmVuZGVyZWQgY2FsbGJhY2sgdG8gYWxsb3cgZm9yIFVJIHRyZWF0bWVudCAoZG9tIGZvY3VzLCBldGMpCiAgICAgICAgaWYgKCFvcHRpb25zKSB7CiAgICAgICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgICB9CiAgICAgICAgaWYgKEFscGFjYS5pc1VuZGVmaW5lZChvcHRpb25zLmZvY3VzKSkgewogICAgICAgICAgICBvcHRpb25zLmZvY3VzID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHZhciBfcmVuZGVyZWRDYWxsYmFjayA9IGZ1bmN0aW9uKGNvbnRyb2wpCiAgICAgICAgewogICAgICAgICAgICAvLyBhdXRvLXNldCB0aGUgZm9jdXM/CiAgICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuZm9jdXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5mb2N1cyA9PT0gdHJ1ZSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBpY2sgZmlyc3QgZWxlbWVudCBpbiBmb3JtCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250cm9sLmNoaWxkcmVuICYmIGNvbnRyb2wuY2hpbGRyZW4ubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnRyb2wuY2hpbGRyZW5bMF0uZmllbGQgJiYgY29udHJvbC5jaGlsZHJlblswXS5maWVsZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2wuY2hpbGRyZW5bMF0uZmllbGQuZm9jdXMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBwaWNrIGEgbmFtZWQgY29udHJvbAogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBjb250cm9sLmdldENvbnRyb2xCeVBhdGgob3B0aW9ucy5mb2N1cyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZCAmJiBjaGlsZC5maWVsZCAmJiBjaGlsZC5maWVsZC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC5maWVsZC5mb2N1cygpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgMjUwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHJlbmRlcmVkQ2FsbGJhY2spCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJlbmRlcmVkQ2FsbGJhY2soY29udHJvbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBsb2FkQWxsQ29ubmVjdG9yLmxvYWRBbGwoewogICAgICAgICAgICAiZGF0YSI6IGRhdGEsCiAgICAgICAgICAgICJzY2hlbWEiOiBzY2hlbWEsCiAgICAgICAgICAgICJvcHRpb25zIjogb3B0aW9ucywKICAgICAgICAgICAgInZpZXciOiB2aWV3LAogICAgICAgICAgICAiZGF0YVNvdXJjZSI6IGRhdGFTb3VyY2UsCiAgICAgICAgICAgICJzY2hlbWFTb3VyY2UiOiBzY2hlbWFTb3VyY2UsCiAgICAgICAgICAgICJvcHRpb25zU291cmNlIjogb3B0aW9uc1NvdXJjZSwKICAgICAgICAgICAgInZpZXdTb3VyY2UiOiB2aWV3U291cmNlCiAgICAgICAgfSwgZnVuY3Rpb24obG9hZGVkRGF0YSwgbG9hZGVkT3B0aW9ucywgbG9hZGVkU2NoZW1hLCBsb2FkZWRWaWV3KSB7CgogICAgICAgICAgICAvLyBmb3IgY2FzZXMgd2hlcmUgdGhpbmdzIGNvdWxkIG5vdCBiZSBsb2FkZWQgdmlhIHNvdXJjZSBsb2FkZXJzLCBmYWxsIGJhY2sgdG8gd2hhdCBtYXkgaGF2ZSBiZWVuIHBhc3NlZAogICAgICAgICAgICAvLyBpbiBkaXJlY3RseSBhcyB2YWx1ZXMKCiAgICAgICAgICAgIGxvYWRlZERhdGEgPSBsb2FkZWREYXRhID8gbG9hZGVkRGF0YSA6IGRhdGE7CiAgICAgICAgICAgIGxvYWRlZFNjaGVtYSA9IGxvYWRlZFNjaGVtYSA/IGxvYWRlZFNjaGVtYTogc2NoZW1hOwogICAgICAgICAgICBsb2FkZWRPcHRpb25zID0gbG9hZGVkT3B0aW9ucyA/IGxvYWRlZE9wdGlvbnMgOiBvcHRpb25zOwogICAgICAgICAgICBsb2FkZWRWaWV3ID0gbG9hZGVkVmlldyA/IGxvYWRlZFZpZXcgOiB2aWV3OwoKICAgICAgICAgICAgLy8gc29tZSBkZWZhdWx0cyBmb3IgdGhlIGNhc2Ugd2hlcmUgZGF0YSBpcyBudWxsCiAgICAgICAgICAgIC8vIGlmIHNjaGVtYSArIG9wdGlvbnMgYXJlIG5vdCBwcm92aWRlZCwgd2UgYXNzdW1lIGEgdGV4dCBmaWVsZAoKICAgICAgICAgICAgaWYgKEFscGFjYS5pc0VtcHR5KGxvYWRlZERhdGEpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkobG9hZGVkU2NoZW1hKSAmJiAoQWxwYWNhLmlzRW1wdHkobG9hZGVkT3B0aW9ucykgfHwgQWxwYWNhLmlzRW1wdHkobG9hZGVkT3B0aW9ucy50eXBlKSkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbG9hZGVkRGF0YSA9ICIiOwoKICAgICAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkobG9hZGVkT3B0aW9ucykpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBsb2FkZWRPcHRpb25zID0gInRleHQiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChvcHRpb25zICYmIEFscGFjYS5pc09iamVjdChvcHRpb25zKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRlZE9wdGlvbnMudHlwZSA9ICJ0ZXh0IjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGluaXQgYWxwYWNhCiAgICAgICAgICAgIHJldHVybiBBbHBhY2EuaW5pdChlbCwgbG9hZGVkRGF0YSwgbG9hZGVkT3B0aW9ucywgbG9hZGVkU2NoZW1hLCBsb2FkZWRWaWV3LCBpbml0aWFsU2V0dGluZ3MsIGNhbGxiYWNrLCBfcmVuZGVyZWRDYWxsYmFjaywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrLCBpc0R5bmFtaWNDcmVhdGlvbik7CgogICAgICAgIH0sIGZ1bmN0aW9uIChsb2FkRXJyb3IpIHsKICAgICAgICAgICAgZXJyb3JDYWxsYmFjayhsb2FkRXJyb3IpOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9KTsKCiAgICAgICAgLy8gaGFuZCBiYWNrIHRoZSBmaWVsZAogICAgICAgIHJldHVybiAkKGVsKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZXNwYWNlIE5hbWVzcGFjZSBmb3IgYWxsIEFscGFjYSBGaWVsZCBDbGFzcyBJbXBsZW1lbnRhdGlvbnMuCiAgICAgKi8KICAgIEFscGFjYS5GaWVsZHMgPSB7IH07CgogICAgLyoqCiAgICAgKiBAbmFtZXNwYWNlIE5hbWVzcGFjZSBmb3IgYWxsIEFscGFjYSBDb25uZWN0b3IgQ2xhc3MgSW1wbGVtZW50YXRpb25zLgogICAgICovCiAgICBBbHBhY2EuQ29ubmVjdG9ycyA9IHsgfTsKCiAgICBBbHBhY2EuRXh0ZW5kID0gJC5leHRlbmQ7CgogICAgQWxwYWNhLkNyZWF0ZSA9IGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgYXJncy51bnNoaWZ0KHt9KTsKCiAgICAgICAgcmV0dXJuICQuZXh0ZW5kLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfTsKCiAgICAvLyBzdGF0aWMgbWV0aG9kcyBhbmQgcHJvcGVydGllcwogICAgQWxwYWNhLkV4dGVuZChBbHBhY2EsCiAgICAvKiogQGxlbmRzIEFscGFjYSAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIFZlcnNpb24gbnVtYmVyLgogICAgICAgICAqLwogICAgICAgIFZFUlNJT046ICIwLjEuMCIsCgogICAgICAgIC8qKgogICAgICAgICAqIE1ha2VzIGFuIGFycmF5LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtBbnl9IG5vbkFycmF5IEEgbm9uLWFycmF5IHZhcmlhYmxlLgogICAgICAgICAqIEByZXR1cm5zIHtBcnJheX0gQXJyYXkgb3V0IG9mIHRoZSBub24tYXJyYXkgdmFyaWFibGUuCiAgICAgICAgICovCiAgICAgICAgbWFrZUFycmF5IDogZnVuY3Rpb24obm9uQXJyYXkpIHsKICAgICAgICAgICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKG5vbkFycmF5KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyB3aGV0aGVyIHRoZSB0eXBlIG9mIGEgdmFyaWFibGUgaXMgZnVuY3Rpb24uCiAgICAgICAgICogQHBhcmFtIHtBbnl9IG9iaiBUaGUgdmFyaWFibGUgYmVpbmcgZXZhbHVhdGVkLgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmIHRoZSB2YXJpYWJsZSBpcyBhIGZ1bmN0aW9uLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgaXNGdW5jdGlvbjogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSA9PT0gIltvYmplY3QgRnVuY3Rpb25dIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyB3aGV0aGVyIHRoZSB0eXBlIG9mIGEgdmFyaWFibGUgaXMgc3RyaW5nLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBvYmogVGhlIHZhcmlhYmxlIGJlaW5nIGV2YWx1YXRlZC4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZiB0aGUgdmFyaWFibGUgaXMgYSBzdHJpbmcsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgKi8KICAgICAgICBpc1N0cmluZzogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgICAgIHJldHVybiAodHlwZW9mIG9iaiA9PT0gInN0cmluZyIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEZpbmRzIHdoZXRoZXIgdGhlIHR5cGUgb2YgYSB2YXJpYWJsZSBpcyBvYmplY3QuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IG9iaiBUaGUgdmFyaWFibGUgYmVpbmcgZXZhbHVhdGVkLgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmIHRoZSB2YXJpYWJsZSBpcyBhbiBvYmplY3QsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgKi8KICAgICAgICBpc09iamVjdDogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgT2JqZWN0XSc7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogRmluZHMgd2hldGhlciB0aGUgdHlwZSBvZiBhIHZhcmlhYmxlIGlzIGEgcGxhaW4sIG5vbi1wcm90b3R5cGVkIG9iamVjdC4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gb2JqIFRoZSB2YXJpYWJsZSBiZWluZyBldmFsdWF0ZWQuCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgdGhlIHZhcmlhYmxlIGlzIGEgcGxhaW4gb2JqZWN0LCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgaXNQbGFpbk9iamVjdDogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgICAgIHJldHVybiAkLmlzUGxhaW5PYmplY3Qob2JqKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyB3aGV0aGVyIHRoZSB0eXBlIG9mIGEgdmFyaWFibGUgaXMgbnVtYmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBvYmogVGhlIHZhcmlhYmxlIGJlaW5nIGV2YWx1YXRlZC4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZiB0aGUgdmFyaWFibGUgaXMgYSBudW1iZXIsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgKi8KICAgICAgICBpc051bWJlcjogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgICAgIHJldHVybiAodHlwZW9mIG9iaiA9PT0gIm51bWJlciIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEZpbmRzIHdoZXRoZXIgdGhlIHR5cGUgb2YgYSB2YXJpYWJsZSBpcyBhcnJheS4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gb2JqIFRoZSB2YXJpYWJsZSBiZWluZyBldmFsdWF0ZWQuCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgdGhlIHZhcmlhYmxlIGlzIGFuIGFycmF5LCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgaXNBcnJheTogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgICAgIHJldHVybiBvYmogaW5zdGFuY2VvZiBBcnJheTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyB3aGV0aGVyIHRoZSB0eXBlIG9mIGEgdmFyaWFibGUgaXMgYm9vbGVhbi4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gb2JqIFRoZSB2YXJpYWJsZSBiZWluZyBldmFsdWF0ZWQuCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgdGhlIHZhcmlhYmxlIGlzIGEgYm9vbGVhbiwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIGlzQm9vbGVhbjogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgICAgIHJldHVybiAodHlwZW9mIG9iaiA9PT0gImJvb2xlYW4iKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyB3aGV0aGVyIHRoZSB0eXBlIG9mIGEgdmFyaWFibGUgaXMgdW5kZWZpbmVkLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBvYmogVGhlIHZhcmlhYmxlIGJlaW5nIGV2YWx1YXRlZC4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZiB0aGUgdmFyaWFibGUgaXMgYSB1bmRlZmluZWQsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgKi8KICAgICAgICBpc1VuZGVmaW5lZDogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgICAgIHJldHVybiAodHlwZW9mIG9iaiA9PT0gInVuZGVmaW5lZCIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFN0cmlwcyBhbnkgZXhjZXNzIHdoaXRlc3BhY2UgY2hhcmFjdGVycyBmcm9tIHRoZSBnaXZlbiB0ZXh0LgogICAgICAgICAqIFJldHVybnMgdGhlIHRyaW1tZWQgc3RyaW5nLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHN0cgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybiB0cmltbWVkIHN0cmluZwogICAgICAgICAqLwogICAgICAgIHRyaW06IGZ1bmN0aW9uKHRleHQpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdHJpbW1lZCA9IHRleHQ7CgogICAgICAgICAgICBpZiAodHJpbW1lZCAmJiBBbHBhY2EuaXNTdHJpbmcodHJpbW1lZCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRyaW1tZWQgPSB0cmltbWVkLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0cmltbWVkOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFByb3ZpZGVzIGEgc2FmZSBjb252ZXJzaW9uIG9mIGFuIEhUTUwgdGV4dHVhbCBzdHJpbmcgaW50byBhIERPTSBvYmplY3QuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0geAogICAgICAgICAqIEByZXR1cm4geyp9CiAgICAgICAgICovCiAgICAgICAgc2FmZURvbVBhcnNlOiBmdW5jdGlvbih4KQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHggJiYgQWxwYWNhLmlzU3RyaW5nKHgpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBDb3JyZWN0IGZvciB0aGUgZmFjdCB0aGF0IGpRdWVyeSA5IGlzIGEgYml0IHNlbnNpdGl2ZSB3aXRoIHJlc3BlY3QgdG8gc3RyaW5nIGNoYXJhY3RlcnMKICAgICAgICAgICAgICAgIC8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTQzNDc2MTEvanF1ZXJ5LTEtOS1jbGllbnQtc2lkZS10ZW1wbGF0ZS1zeW50YXgtZXJyb3ItdW5yZWNvZ25pemVkLWV4cHJlc3Npb24KICAgICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgICAvLyBlbnN1cmUgdGhhdCBodG1sIGRvZXNuJ3Qgc3RhcnQgd2l0aCBzcGFjZXMsIGNhcnJpYWdlIHJldHVybnMgb3IgYW55dGhpbmcgZXZpbAoKICAgICAgICAgICAgICAgIHggPSBBbHBhY2EudHJpbSh4KTsKCiAgICAgICAgICAgICAgICB2YXIgY29udmVydGVkID0gbnVsbDsKICAgICAgICAgICAgICAgIHRyeQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGNvbnZlcnRlZCA9ICQoeCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaCAoZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBtYWtlIGFub3RoZXIgYXR0ZW1wdCB0byBhY2NvdW50IGZvciBzYWZldHkgaW4gc29tZSBicm93c2VycwogICAgICAgICAgICAgICAgICAgIHggPSAiPGRpdj4iICsgeCArICI8L2Rpdj4iOwoKICAgICAgICAgICAgICAgICAgICBjb252ZXJ0ZWQgPSAkKHgpLmNoaWxkcmVuKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnZlcnRlZDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHg7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogRmluZHMgd2hldGhlciBhIHZhcmlhYmxlIGlzIGVtcHR5LgogICAgICAgICAqIEBwYXJhbSB7QW55fSBvYmogVGhlIHZhcmlhYmxlIGJlaW5nIGV2YWx1YXRlZC4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZiB0aGUgdmFyaWFibGUgaXMgZW1wdHksIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgKi8KICAgICAgICBpc0VtcHR5OiBmdW5jdGlvbihvYmopIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5pc1VuZGVmaW5lZChvYmopIHx8IG9iaiA9PT0gbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBQcm9kdWNlcyBhIGNvcHkgb2YgdGhlIGdpdmVuIEpTIHZhbHVlLgogICAgICAgICAqCiAgICAgICAgICogSWYgdGhlIHZhbHVlIGlzIGEgc2ltcGxlIGFycmF5IG9yIGEgc2ltcGxlIG9iamVjdCwgdGhlbiBhIHB1cmUgY29weSBpcyBwcm9kdWNlZC4KICAgICAgICAgKgogICAgICAgICAqIElmIGl0J3MgYSBjb21wbGV4IG9iamVjdCBvciBhIGZ1bmN0aW9uLCB0aGVuIHRoZSByZWZlcmVuY2UgaXMgY29waWVkIChpLmUuIG5vdCB0cnVseSBhIGNvcHkpLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHRoaW5nCiAgICAgICAgICogQHJldHVybiB7Kn0KICAgICAgICAgKi8KICAgICAgICBjb3B5T2Y6IGZ1bmN0aW9uKHRoaW5nKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGNvcHkgPSB0aGluZzsKCiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNBcnJheSh0aGluZykpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvcHkgPSBbXTsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaW5nLmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGNvcHkucHVzaChBbHBhY2EuY29weU9mKHRoaW5nW2ldKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoQWxwYWNhLmlzT2JqZWN0KHRoaW5nKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRoaW5nIGluc3RhbmNlb2YgRGF0ZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBkYXRlCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHRoaW5nLmdldFRpbWUoKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGluZyBpbnN0YW5jZW9mIFJlZ0V4cCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyByZWd1bGFyIGV4cHJlc3Npb24KICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFJlZ0V4cCh0aGluZyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGluZy5ub2RlVHlwZSAmJiAiY2xvbmVOb2RlIiBpbiB0aGluZykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBET00gbm9kZQogICAgICAgICAgICAgICAgICAgIGNvcHkgPSB0aGluZy5jbG9uZU5vZGUodHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmICgkLmlzUGxhaW5PYmplY3QodGhpbmcpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGNvcHkgPSB7fTsKCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayBpbiB0aGluZykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGluZy5oYXNPd25Qcm9wZXJ0eShrKSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29weVtrXSA9IEFscGFjYS5jb3B5T2YodGhpbmdba10pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIG90aGVyd2lzZSwgaXQncyBzb21lIG90aGVyIGtpbmQgb2Ygb2JqZWN0IHNvIHdlIGp1c3QgZG8gYSByZWZlcmVudGlhbCBjb3B5CiAgICAgICAgICAgICAgICAgICAgLy8gaW4gb3RoZXIgd29yZHMsIG5vdCBhIGNvcHkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGNvcHk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0YWluZWQgZm9yIGxlZ2FjeSBwdXJwb3Nlcy4gIEFsaWFzIGZvciBjb3B5T2YoKS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBvYmplY3QKICAgICAgICAgKiBAcmV0dXJucyB7Kn0KICAgICAgICAgKi8KICAgICAgICBjbG9uZU9iamVjdDogZnVuY3Rpb24ob2JqZWN0KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5jb3B5T2Yob2JqZWN0KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBTcGxpY2VzIGEgc3RyaW5nLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHNvdXJjZSBTb3VyY2Ugc3RyaW5nIHRvIGJlIHNwbGljZWQuCiAgICAgICAgICogQHBhcmFtIHtJbnRlZ2VyfSBzcGxpY2VQb2ludCBTcGxpY2UgbG9jYXRpb24uCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHNwbGljZSBTdHJpbmcgdG8gYmUgc3BsaWNlZCBpbi4KICAgICAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBTcGxpY2VkIHN0cmluZwogICAgICAgICAqLwogICAgICAgIHNwbGljZUluOiBmdW5jdGlvbihzb3VyY2UsIHNwbGljZVBvaW50LCBzcGxpY2UpIHsKICAgICAgICAgICAgcmV0dXJuIHNvdXJjZS5zdWJzdHJpbmcoMCwgc3BsaWNlUG9pbnQpICsgc3BsaWNlICsgc291cmNlLnN1YnN0cmluZyhzcGxpY2VQb2ludCwgc291cmNlLmxlbmd0aCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ29tcGFjdHMgYW4gYXJyYXkuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnIgU291cmNlIGFycmF5IHRvIGJlIGNvbXBhY3RlZC4KICAgICAgICAgKiBAcmV0dXJucyB7QXJyYXl9IENvbXBhY3RlZCBhcnJheS4KICAgICAgICAgKi8KICAgICAgICBjb21wYWN0QXJyYXk6IGZ1bmN0aW9uKGFycikgewogICAgICAgICAgICB2YXIgbiA9IFtdLCBsID0gYXJyLmxlbmd0aCxpOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoIWxhbmcuaXNOdWxsKGFycltpXSkgJiYgIWxhbmcuaXNVbmRlZmluZWQoYXJyW2ldKSkgewogICAgICAgICAgICAgICAgICAgIG4ucHVzaChhcnJbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJlbW92ZXMgYWNjZW50cyBmcm9tIGEgc3RyaW5nLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHN0ciBTb3VyY2Ugc3RyaW5nLgogICAgICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IENsZWFuZWQgc3RyaW5nIHdpdGhvdXQgYWNjZW50cy4KICAgICAgICAgKi8KICAgICAgICByZW1vdmVBY2NlbnRzOiBmdW5jdGlvbihzdHIpIHsKICAgICAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKC9bw6DDocOiw6PDpMOlXS9nLCAiYSIpLnJlcGxhY2UoL1vDqMOpw6rDq10vZywgImUiKS5yZXBsYWNlKC9bw6zDrcOuw69dL2csICJpIikucmVwbGFjZSgvW8Oyw7PDtMO1w7ZdL2csICJvIikucmVwbGFjZSgvW8O5w7rDu8O8XS9nLCAidSIpLnJlcGxhY2UoL1vDvcO/XS9nLCAieSIpLnJlcGxhY2UoL1vDsV0vZywgIm4iKS5yZXBsYWNlKC9bw6ddL2csICJjIikucmVwbGFjZSgvW8WTXS9nLCAib2UiKS5yZXBsYWNlKC9bw6ZdL2csICJhZSIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHBhcmFtIGVsCiAgICAgICAgICogQHBhcmFtIGFycgogICAgICAgICAqIEBwYXJhbSBmbgogICAgICAgICAqLwogICAgICAgIGluZGV4T2Y6IGZ1bmN0aW9uKGVsLCBhcnIsIGZuKSB7CiAgICAgICAgICAgIHZhciBsID0gYXJyLmxlbmd0aCxpOwoKICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNGdW5jdGlvbihmbikpIHsKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQGlnbm9yZQogICAgICAgICAgICAgICAgICogQHBhcmFtIGVsdAogICAgICAgICAgICAgICAgICogQHBhcmFtIGFyckVsdAogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmbiA9IGZ1bmN0aW9uKGVsdCwgYXJyRWx0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsdCA9PT0gYXJyRWx0OwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKGZuLmNhbGwoe30sIGVsLCBhcnJbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIFN0YXRpYyBjb3VudGVyIGZvciBnZW5lcmF0aW5nIGEgdW5pcXVlIElELgogICAgICAgICAqLwogICAgICAgIHVuaXF1ZUlkQ291bnRlcjogMCwKCiAgICAgICAgLyoqCiAgICAgICAgICogRGVmYXVsdCBMb2NhbGUuCiAgICAgICAgICovCiAgICAgICAgZGVmYXVsdExvY2FsZTogImVuX1VTIiwKCiAgICAgICAgLyoqCiAgICAgICAgICogU2V0cyB0aGUgZGVmYXVsdCBMb2NhbGUuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbG9jYWxlIE5ldyBkZWZhdWx0IGxvY2FsZS4KICAgICAgICAgKi8KICAgICAgICBzZXREZWZhdWx0TG9jYWxlOiBmdW5jdGlvbihsb2NhbGUpIHsKICAgICAgICAgICAgdGhpcy5kZWZhdWx0TG9jYWxlID0gbG9jYWxlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEZpZWxkIFR5cGUgdG8gU2NoZW1hIFR5cGUgTWFwcGluZ3MuCiAgICAgICAgICovCiAgICAgICAgZGVmYXVsdFNjaGVtYUZpZWxkTWFwcGluZzoge30sCgogICAgICAgIC8qKgogICAgICAgICAqIFJlZ2lzdGVycyBhIGZpZWxkIHR5cGUgdG8gc2NoZW1hIGRhdGEgdHlwZSBtYXBwaW5nLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHNjaGVtYVR5cGUgU2NoZW1hIGRhdGEgdHlwZS4KICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gZmllbGRUeXBlIEZpZWxkIHR5cGUuCiAgICAgICAgICovCiAgICAgICAgcmVnaXN0ZXJEZWZhdWx0U2NoZW1hRmllbGRNYXBwaW5nOiBmdW5jdGlvbihzY2hlbWFUeXBlLCBmaWVsZFR5cGUpIHsKICAgICAgICAgICAgaWYgKHNjaGVtYVR5cGUgJiYgZmllbGRUeXBlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRlZmF1bHRTY2hlbWFGaWVsZE1hcHBpbmdbc2NoZW1hVHlwZV0gPSBmaWVsZFR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaWVsZCBUeXBlIHRvIFNjaGVtYSBGb3JtYXQgTWFwcGluZ3MuCiAgICAgICAgICovCiAgICAgICAgZGVmYXVsdEZvcm1hdEZpZWxkTWFwcGluZzoge30sCgogICAgICAgIC8qKgogICAgICAgICAqIFJlZ2lzdGVycyBhIGZpZWxkIHR5cGUgdG8gc2NoZW1hIGZvcm1hdCBtYXBwaW5nLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGZvcm1hdCBTY2hlbWEgZm9ybWF0LgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBmaWVsZFR5cGUgRmllbGQgdHlwZS4KICAgICAgICAgKi8KICAgICAgICByZWdpc3RlckRlZmF1bHRGb3JtYXRGaWVsZE1hcHBpbmc6IGZ1bmN0aW9uKGZvcm1hdCwgZmllbGRUeXBlKSB7CiAgICAgICAgICAgIGlmIChmb3JtYXQgJiYgZmllbGRUeXBlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRlZmF1bHRGb3JtYXRGaWVsZE1hcHBpbmdbZm9ybWF0XSA9IGZpZWxkVHlwZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgc2NoZW1hIHR5cGUgb2YgYSB2YXJpYWJsZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIFRoZSB2YXJpYWJsZS4KICAgICAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBTY2hlbWEgdHlwZSBvZiB0aGUgdmFyaWFibGUuCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hVHlwZTogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgLy8gbWFwIGRhdGEgdHlwZXMgdG8gZGVmYXVsdCBmaWVsZCB0eXBlcwogICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkoZGF0YSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAic3RyaW5nIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoQWxwYWNhLmlzT2JqZWN0KGRhdGEpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIm9iamVjdCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKEFscGFjYS5pc1N0cmluZyhkYXRhKSkgewogICAgICAgICAgICAgICAgcmV0dXJuICJzdHJpbmciOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNOdW1iZXIoZGF0YSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAibnVtYmVyIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoQWxwYWNhLmlzQXJyYXkoZGF0YSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiYXJyYXkiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNCb29sZWFuKGRhdGEpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gImJvb2xlYW4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIExhc3QgY2hlY2sgZm9yIGRhdGEgdGhhdCBjYXJyaWVzIGZ1bmN0aW9ucyAtLSBHaXRhbmFDb25uZWN0b3IgY2FzZS4KICAgICAgICAgICAgaWYgKHR5cGVvZiBkYXRhID09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIm9iamVjdCI7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqCiAgICAgICAgICogQWxwYWNhIFZpZXdzLgogICAgICAgICAqLwogICAgICAgIHZpZXdzOiB7fSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKgogICAgICAgICAqIFZpZXcgSUQgUHJlZml4LgogICAgICAgICAqLwogICAgICAgIHZpZXdJZFByZWZpeDogIlZJRVdfIiwKCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaWRhdGVzIGEgdmlldyBpZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBpZCBWaWV3IGlkIGJlaW5nIHZhbGlkYXRlZC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmIHRoZSB2aWV3IGlkIGlzIHZhbGlkLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgaXNWYWxpZFZpZXdJZCA6IGZ1bmN0aW9uIChpZCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLnN0YXJ0c1dpdGgoaWQsIHRoaXMudmlld0lkUHJlZml4KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBHZW5lcmF0ZXMgYSB2YWxpZCB2aWV3IGlkLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge1N0cmluZ30gQSB2YWxpZCB1bmlxdWUgdmlldyBpZC4KICAgICAgICAgKi8KICAgICAgICBnZW5lcmF0ZVZpZXdJZCA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudmlld0lkUHJlZml4ICsgdGhpcy5nZW5lcmF0ZUlkKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVnaXN0ZXJzIGEgdmlldyB3aXRoIHRoZSBmcmFtZXdvcmsuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gdmlld09iamVjdAogICAgICAgICAqLwogICAgICAgIHJlZ2lzdGVyVmlldzogZnVuY3Rpb24odmlld09iamVjdCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBpZCA9IHZpZXdPYmplY3QuaWQ7CgogICAgICAgICAgICBpZiAoIWlkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gQWxwYWNhLnRocm93RGVmYXVsdEVycm9yKCJDYW5ub3QgcmVnaXN0ZXIgdmlldyB3aXRoIG1pc3NpbmcgdmlldyBpZDogIiArIGlkKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGV4aXN0aW5nVmlldyA9IHRoaXMudmlld3NbaWRdOwogICAgICAgICAgICBpZiAoZXhpc3RpbmdWaWV3KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBBbHBhY2EubWVyZ2VPYmplY3QoZXhpc3RpbmdWaWV3LCB2aWV3T2JqZWN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMudmlld3NbaWRdID0gdmlld09iamVjdDsKICAgICAgICAgICAgfQoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBEZWZhdWx0IHZpZXcuCiAgICAgICAgICovCiAgICAgICAgZGVmYXVsdFZpZXcgOiAiVklFV19XRUJfRURJVCIsCgogICAgICAgIC8qKgogICAgICAgICAqIFNldHMgZGVmYXVsdCB2aWV3IGFzIHRoZSB2aWV3IHdpdGggYSBnaXZlbiBpZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBJZCBvZiB0aGUgdmlldyBiZWluZyBzZXQgYXMgZGVmYXVsdC4KICAgICAgICAgKi8KICAgICAgICBzZXREZWZhdWx0VmlldzogZnVuY3Rpb24odmlld0lkKSB7CiAgICAgICAgICAgIGlmICh2aWV3SWQgJiYgdGhpcy52aWV3cy5oYXNPd25Qcm9wZXJ0eSh2aWV3SWQpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRlZmF1bHRWaWV3ID0gdmlld0lkOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0cmlldmVzIGEgbm9ybWFsaXplZCB2aWV3IGJ5IHZpZXcgaWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gdmlld0lkCiAgICAgICAgICogQHJldHVybiB7Kn0KICAgICAgICAgKi8KICAgICAgICBnZXROb3JtYWxpemVkVmlldzogZnVuY3Rpb24odmlld0lkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplZFZpZXdzW3ZpZXdJZF07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVzb2x2ZXMgd2hpY2ggdmlldyBoYW5kbGVzIGEgZ2l2ZW4gdGhlbWUgYW5kIHR5cGUgb2Ygb3BlcmF0aW9uLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHVpCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUKICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IHRoZSB2aWV3IGlkCiAgICAgICAgICovCiAgICAgICAgbG9va3VwTm9ybWFsaXplZFZpZXc6IGZ1bmN0aW9uKHVpLCB0eXBlKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRoZVZpZXdJZCA9IG51bGw7CgogICAgICAgICAgICBmb3IgKHZhciB2aWV3SWQgaW4gdGhpcy5ub3JtYWxpemVkVmlld3MpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB2aWV3ID0gdGhpcy5ub3JtYWxpemVkVmlld3Nbdmlld0lkXTsKCiAgICAgICAgICAgICAgICBpZiAodmlldy51aSA9PSB1aSAmJiB2aWV3LnR5cGUgPT0gdHlwZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGVWaWV3SWQgPSB2aWV3SWQ7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGVWaWV3SWQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVnaXN0ZXJzIGEgdGVtcGxhdGUgdG8gYSB2aWV3LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHRlbXBsYXRlSWQgVGVtcGxhdGUgaWQuCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd8T2JqZWN0fSB0ZW1wbGF0ZSBFaXRoZXIgdGhlIHRleHQgb2YgdGhlIHRlbXBsYXRlIG9yIGFuIG9iamVjdCBjb250YWluaW5nIHsgInR5cGUiOiAiPHRlbXBsYXRlRW5naW5lSWRlbnRpZmllcj4iLCAidGVtcGxhdGUiOiAiPG1hcmt1cD4iIH0KICAgICAgICAgKiBAcGFyYW0gW1N0cmluZ10gdmlld0lkIHRoZSBvcHRpb25hbCB2aWV3IGlkLiAgSWYgbm9uZSBpcyBwcm92aWRlZCwgdGhlbiBhbGwgcmVnaXN0cmF0aW9ucyBhcmUgdG8gdGhlIGRlZmF1bHQgdmlldy4KICAgICAgICAgKi8KICAgICAgICByZWdpc3RlclRlbXBsYXRlOiBmdW5jdGlvbih0ZW1wbGF0ZUlkLCB0ZW1wbGF0ZSwgdmlld0lkKQogICAgICAgIHsKICAgICAgICAgICAgLy8gaWYgbm8gdmlldyBzcGVjaWZpZWQsIGZhbGwgYmFjayB0byB0aGUgYmFzZSB2aWV3IHdoaWNoIGlzICJWSUVXX0JBU0UiCiAgICAgICAgICAgIGlmICghdmlld0lkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2aWV3SWQgPSAiVklFV19CQVNFIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0aGlzLnZpZXdzW3ZpZXdJZF0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMudmlld3Nbdmlld0lkXSA9IHt9OwogICAgICAgICAgICAgICAgdGhpcy52aWV3c1t2aWV3SWRdLmlkID0gdmlld0lkOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXRoaXMudmlld3Nbdmlld0lkXS50ZW1wbGF0ZXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMudmlld3Nbdmlld0lkXS50ZW1wbGF0ZXMgPSB7fTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy52aWV3c1t2aWV3SWRdLnRlbXBsYXRlc1t0ZW1wbGF0ZUlkXSA9IHRlbXBsYXRlOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZWdpc3RlcnMgbGlzdCBvZiB0ZW1wbGF0ZXMgdG8gYSB2aWV3LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtBcnJheX0gdGVtcGxhdGVzIFRlbXBsYXRlcyBiZWluZyByZWdpc3RlcmVkCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHZpZXdJZCBJZCBvZiB0aGUgdmlldyB0aGF0IHRoZSB0ZW1wbGF0ZXMgYmVpbmcgcmVnaXN0ZXJlZCB0by4KICAgICAgICAgKi8KICAgICAgICByZWdpc3RlclRlbXBsYXRlczogZnVuY3Rpb24odGVtcGxhdGVzLCB2aWV3SWQpIHsKICAgICAgICAgICAgZm9yICh2YXIgdGVtcGxhdGVJZCBpbiB0ZW1wbGF0ZXMpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVnaXN0ZXJUZW1wbGF0ZSh0ZW1wbGF0ZUlkLCB0ZW1wbGF0ZXNbdGVtcGxhdGVJZF0sIHZpZXdJZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZWdpc3RlcnMgYSBtZXNzYWdlIHRvIGEgdmlldy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBtZXNzYWdlSWQgSWQgb2YgdGhlIG1lc3NhZ2UgYmVpbmcgcmVnaXN0ZXJlZC4KICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZSBNZXNzYWdlIHRvIGJlIHJlZ2lzdGVyZWQKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdmlld0lkIElkIG9mIHRoZSB2aWV3IHRoYXQgdGhlIG1lc3NhZ2UgYmVpbmcgcmVnaXN0ZXJlZCB0by4KICAgICAgICAgKi8KICAgICAgICByZWdpc3Rlck1lc3NhZ2U6IGZ1bmN0aW9uKG1lc3NhZ2VJZCwgbWVzc2FnZSwgdmlld0lkKQogICAgICAgIHsKICAgICAgICAgICAgLy8gaWYgbm8gdmlldyBzcGVjaWZpZWQsIGZhbGwgYmFjayB0byB0aGUgYmFzZSB2aWV3IHdoaWNoIGlzICJWSUVXX0JBU0UiCiAgICAgICAgICAgIGlmICghdmlld0lkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2aWV3SWQgPSAiVklFV19CQVNFIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0aGlzLnZpZXdzW3ZpZXdJZF0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMudmlld3Nbdmlld0lkXSA9IHt9OwogICAgICAgICAgICAgICAgdGhpcy52aWV3c1t2aWV3SWRdLmlkID0gdmlld0lkOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXRoaXMudmlld3Nbdmlld0lkXS5tZXNzYWdlcykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy52aWV3c1t2aWV3SWRdLm1lc3NhZ2VzID0ge307CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudmlld3Nbdmlld0lkXS5tZXNzYWdlc1ttZXNzYWdlSWRdID0gbWVzc2FnZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZWdpc3RlcnMgbWVzc2FnZXMgd2l0aCBhIHZpZXcuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0FycmF5fSBtZXNzYWdlcyBNZXNzYWdlcyB0byBiZSByZWdpc3RlcmVkLgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB2aWV3SWQgSWQgb2YgdGhlIHZpZXcgdGhhdCB0aGUgbWVzc2FnZXMgYmVpbmcgcmVnaXN0ZXJlZCB0by4KICAgICAgICAgKi8KICAgICAgICByZWdpc3Rlck1lc3NhZ2VzOiBmdW5jdGlvbihtZXNzYWdlcywgdmlld0lkKSB7CiAgICAgICAgICAgIGZvciAodmFyIG1lc3NhZ2VJZCBpbiBtZXNzYWdlcykgewogICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2VzLmhhc093blByb3BlcnR5KG1lc3NhZ2VJZCkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlZ2lzdGVyTWVzc2FnZShtZXNzYWdlSWQsIG1lc3NhZ2VzW21lc3NhZ2VJZF0sIHZpZXdJZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKCgoKCgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIC8vCiAgICAgICAgLy8gU1RBVElDIEhFTFBFUiBNRVRIT0RTIChDQUxMRUQgRlJPTSBXSVRISU4gVEVNUExBVEVTKQogICAgICAgIC8vCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogRGVmYXVsdCBNYXBwaW5ncyBmb3IgRmllbGQgTGV2ZWwgVGVtcGxhdGVzLgogICAgICAgICAqLwogICAgICAgIGZpZWxkVGVtcGxhdGVQb3N0Zml4OiB7CiAgICAgICAgICAgICJjb250cm9sRmllbGRNZXNzYWdlQ29udGFpbmVyIiA6ICItY29udHJvbGZpZWxkLW1lc3NhZ2UtY29udGFpbmVyIiwKICAgICAgICAgICAgImNvbnRyb2xGaWVsZExhYmVsIiA6ICItY29udHJvbGZpZWxkLWxhYmVsIiwKICAgICAgICAgICAgImNvbnRyb2xGaWVsZENvbnRhaW5lciI6Ii1jb250cm9sZmllbGQtY29udGFpbmVyIiwKICAgICAgICAgICAgImNvbnRyb2xGaWVsZEhlbHBlciI6Ii1jb250cm9sZmllbGQtaGVscGVyIiwKICAgICAgICAgICAgLyoKICAgICAgICAgICAgICJjb250cm9sRmllbGRPdXRlckVsIjoiLWNvbnRyb2xmaWVsZCIsCiAgICAgICAgICAgICAqLwogICAgICAgICAgICAiZmllbGRTZXRMZWdlbmQiIDogIi1maWVsZHNldC1sZWdlbmQiLAogICAgICAgICAgICAiZmllbGRTZXRJdGVtc0NvbnRhaW5lciI6Ii1maWVsZHNldC1pdGVtcy1jb250YWluZXIiLAogICAgICAgICAgICAiZmllbGRTZXRIZWxwZXIiOiItZmllbGRzZXQtaGVscGVyIiwKICAgICAgICAgICAgImZpZWxkU2V0T3V0ZXJFbCI6Ii1maWVsZHNldCIsCiAgICAgICAgICAgICJmb3JtQnV0dG9uc0NvbnRhaW5lciI6Ii1mb3JtLWJ1dHRvbnMtY29udGFpbmVyIiwKICAgICAgICAgICAgImZvcm1GaWVsZHNDb250YWluZXIiOiItZm9ybS1maWVsZHMtY29udGFpbmVyIgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogUHJvY2Vzc2VzIGZpZWxkIGxldmVsIHRlbXBsYXRlLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG9iamVjdCBPYmplY3QgdGhhdCB0aGUgdGVtcGxhdGUgaXMgYXBwbGllZCB0by4KICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBUZW1wbGF0ZSBpZC4KICAgICAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IHdyYXAgVHJ1ZSBpZiB3ZSB3YW50IHRoZSB0ZW1wbGF0ZSBhcyBhIHdyYXBwZXIsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IE9iamVjdCByZW5kZXJlZCBieSBmaWVsZCBsZXZlbCB0ZW1wbGF0ZS4KICAgICAgICAgKi8KICAgICAgICBmaWVsZFRlbXBsYXRlOiBmdW5jdGlvbihvYmplY3QsIG5hbWUsIHdyYXApIHsKCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICB2YXIgZmllbGQgPSBvYmplY3QuZGF0YTsKICAgICAgICAgICAgdmFyIHZpZXcgPSBvYmplY3QuZGF0YS52aWV3OwoKICAgICAgICAgICAgdmFyIGh0bWwgPSAiIjsKCiAgICAgICAgICAgIGlmICghbmFtZSkKICAgICAgICAgICAgICAgIG5hbWUgPSAiY29udHJvbEZpZWxkTGFiZWwiOwoKICAgICAgICAgICAgLy8gZGV0ZXJtaW5lIHdoaWNoIGNvbXBpbGVkIHRlbXBsYXRlIHRvIHVzZSBmb3IgdGhpcyB0ZW1wbGF0ZSBuYW1lCiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZURlc2NyaXB0b3IgPSB0aGlzLmdldFRlbXBsYXRlRGVzY3JpcHRvcih2aWV3LCBuYW1lLCBmaWVsZCk7CiAgICAgICAgICAgIGlmICh3cmFwKSB7CgogICAgICAgICAgICAgICAgLy8gZm9yIHdyYXBwaW5nLCB3ZSBnZXQgdGhlIGh0bWwgc291cmNlIGFuZCBoYW5kIGl0IGJhY2sKICAgICAgICAgICAgICAgIC8vIGZpcnN0IHdlIGFwcGx5IGFueSBhdHRyIGFuZCBjbGFzc2VzIHdlIG5lZWQKCiAgICAgICAgICAgICAgICAvLyBnZXQgdGhlIGh0bWwgc291cmNlCiAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSB0ZW1wbGF0ZURlc2NyaXB0b3IudGVtcGxhdGUudmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoJCgnLmFscGFjYScgKyB0aGlzLmZpZWxkVGVtcGxhdGVQb3N0Zml4W25hbWVdLCBBbHBhY2Euc2FmZURvbVBhcnNlKHRlbXBsYXRlKSkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZmllbGRUZW1wbGF0ZVBvc3RmaXhbbmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUgPSBBbHBhY2Euc2FmZURvbVBhcnNlKHRlbXBsYXRlKS5hZGRDbGFzcygiYWxwYWNhIiArIHRoaXMuZmllbGRUZW1wbGF0ZVBvc3RmaXhbbmFtZV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGh0bWwgPSBBbHBhY2Euc2FmZURvbVBhcnNlKHRlbXBsYXRlKS5vdXRlckhUTUwodHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBmb3Igbm9uLXdyYXBwZWQsIHdlIGV4ZWN1dGUgdGhlIHRlbXBsYXRlIHN0cmFpZ2h0IGF3YXkKCiAgICAgICAgICAgICAgICB2YXIgbGFiZWwgPSB2aWV3LnRtcGwodGVtcGxhdGVEZXNjcmlwdG9yLCBvYmplY3QuZGF0YSk7CiAgICAgICAgICAgICAgICBpZiAobGFiZWwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5maWVsZFRlbXBsYXRlUG9zdGZpeFtuYW1lXSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJCgnLmFscGFjYScgKyB0aGlzLmZpZWxkVGVtcGxhdGVQb3N0Zml4W25hbWVdLCBsYWJlbCkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbC5hZGRDbGFzcygiYWxwYWNhIiArIHRoaXMuZmllbGRUZW1wbGF0ZVBvc3RmaXhbbmFtZV0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbGFiZWwuYXR0cigiaWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWwuYXR0cigiaWQiLCBvYmplY3QuZGF0YS5pZCArIHRoaXMuZmllbGRUZW1wbGF0ZVBvc3RmaXhbbmFtZV0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGh0bWwgPSBsYWJlbC5vdXRlckhUTUwodHJ1ZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGh0bWwgPSAiIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGh0bWw7CiAgICAgICAgfSwKCgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIC8vCiAgICAgICAgLy8gRU5EIE9GIFNUQVRJQyBIRUxQRVIgTUVUSE9EUwogICAgICAgIC8vCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgoKCiAgICAgICAgLyoqCiAgICAgICAgICogRGVmYXVsdCBkYXRlIGZvcm1hdC4KICAgICAgICAgKi8KICAgICAgICBkZWZhdWx0RGF0ZUZvcm1hdDogIm1tL2RkL3l5IiwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVndWxhciBleHByZXNzaW9ucyBmb3IgZmllbGRzLgogICAgICAgICAqLwogICAgICAgIHJlZ2V4cHM6CiAgICAgICAgewogICAgICAgICAgICAiZW1haWwiOiAvXlthLXowLTkhXCNcJCUmJ1wqXC1cLz1cP1wrXC1cXl9gXHtcfFx9fl0rKD86XC5bYS16MC05IVwjXCQlJidcKlwtXC89XD9cK1wtXF5fYFx7XHxcfX5dKykqQCg/OlthLXowLTldKD86W2EtejAtOS1dKlthLXowLTldKT9cLikrW2Etel17Miw2fSQvaSwKICAgICAgICAgICAgInVybCI6IC9eKGh0dHB8aHR0cHMpOlwvXC9bYS16MC05XSsoW1wtXC5dezF9W2EtejAtOV0rKSpcLlthLXpdezIsNX0oXDpbMC05XXsxLDV9KT8oKFswLTldezEsNX0pP1wvLiopPyQvaSwKICAgICAgICAgICAgInBhc3N3b3JkIjogL15bMC05YS16QS1aXHgyMC1ceDdFXSokLywKICAgICAgICAgICAgImRhdGUiOiAvXigwWzEtOV18MVswMTJdKVstIC8uXSgwWzEtOV18WzEyXVswLTldfDNbMDFdKVstIC8uXVxkXGQkLywKICAgICAgICAgICAgImludGVnZXIiOiAvXihbXCtcLV0/KFsxLTldXGQqKXwwKSQvLAogICAgICAgICAgICAibnVtYmVyIjovXihbXCtcLV0/KCgoWzAtOV0rKFwuKT8pfChbMC05XSpcLlswLTldKykpKFtlRV1bKy1dP1swLTldKyk/KSkkLywKICAgICAgICAgICAgInBob25lIjovXihcRD8oXGR7M30pXEQ/XEQ/KFxkezN9KVxEPyhcZHs0fSkpPyQvLAogICAgICAgICAgICAiaXB2NCI6L14oPzoxXGQ/XGQ/fDIoPzpbMC00XVxkP3xbNjc4OV18NVswLTVdPyk/fFszLTldXGQ/fDApKD86XC4oPzoxXGQ/XGQ/fDIoPzpbMC00XVxkP3xbNjc4OV18NVswLTVdPyk/fFszLTldXGQ/fDApKXszfSQvLAogICAgICAgICAgICAiemlwY29kZS1maXZlIjogL14oXGR7NX0pPyQvLAogICAgICAgICAgICAiemlwY29kZS1uaW5lIjogL14oXGR7NX0oLVxkezR9KT8pPyQvCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogTWFwIG9mIGluc3RhbnRpYXRlZCBmaWVsZHMuCiAgICAgICAgICovCiAgICAgICAgZmllbGRJbnN0YW5jZXM6IHt9LAoKICAgICAgICAvKioKICAgICAgICAgKiBNYXBzIG9mIGZpZWxkIHR5cGVzIHRvIGZpZWxkIGNsYXNzIGltcGxlbWVudGF0aW9ucy4KICAgICAgICAgKi8KICAgICAgICBmaWVsZENsYXNzUmVnaXN0cnk6IHt9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZWdpc3RlcnMgYW4gaW1wbGVtZW50YXRpb24gY2xhc3MgZm9yIGEgdHlwZSBvZiBmaWVsZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIEZpZWxkIHR5cGUuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuRmllbGR9IGZpZWxkQ2xhc3MgRmllbGQgY2xhc3MuCiAgICAgICAgICovCiAgICAgICAgcmVnaXN0ZXJGaWVsZENsYXNzOiBmdW5jdGlvbih0eXBlLCBmaWVsZENsYXNzKSB7CiAgICAgICAgICAgIHRoaXMuZmllbGRDbGFzc1JlZ2lzdHJ5W3R5cGVdID0gZmllbGRDbGFzczsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIHRoZSBpbXBsZW1lbnRhdGlvbiBjbGFzcyBmb3IgYSB0eXBlIG9mIGZpZWxkLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUgRmllbGQgdHlwZS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtBbHBhY2EuRmllbGR9IEZpZWxkIGNsYXNzIG1hcHBlZCB0byBmaWVsZCB0eXBlLgogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkQ2xhc3M6IGZ1bmN0aW9uKHR5cGUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmllbGRDbGFzc1JlZ2lzdHJ5W3R5cGVdOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGZpZWxkIHR5cGUgaWQgZm9yIGEgZ2l2ZW4gZmllbGQgaW1wbGVtZW50YXRpb24gY2xhc3MuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5GaWVsZH0gZmllbGRDbGFzcyBGaWVsZCBjbGFzcy4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IEZpZWxkIHR5cGUgb2YgdGhlIGZpZWxkIGNsYXNzLgogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkQ2xhc3NUeXBlOiBmdW5jdGlvbihmaWVsZENsYXNzKSB7CiAgICAgICAgICAgIGZvciAodmFyIHR5cGUgaW4gdGhpcy5maWVsZENsYXNzUmVnaXN0cnkpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkQ2xhc3NSZWdpc3RyeS5oYXNPd25Qcm9wZXJ0eSh0eXBlKSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkQ2xhc3NSZWdpc3RyeVt0eXBlXSA9PSBmaWVsZENsYXNzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBNYXBzIG9mIGNvbm5lY3RvciB0eXBlcyB0byBjb25uZWN0b3IgY2xhc3MgaW1wbGVtZW50YXRpb25zLgogICAgICAgICAqLwogICAgICAgIGNvbm5lY3RvckNsYXNzUmVnaXN0cnk6IHt9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZWdpc3RlcnMgYW4gaW1wbGVtZW50YXRpb24gY2xhc3MgZm9yIGEgY29ubmVjdG9yIHR5cGUuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBjQ29ubmVjdCB0eXBlCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3JDbGFzcyBDb25uZWN0b3IgY2xhc3MuCiAgICAgICAgICovCiAgICAgICAgcmVnaXN0ZXJDb25uZWN0b3JDbGFzczogZnVuY3Rpb24odHlwZSwgY29ubmVjdG9yQ2xhc3MpIHsKICAgICAgICAgICAgdGhpcy5jb25uZWN0b3JDbGFzc1JlZ2lzdHJ5W3R5cGVdID0gY29ubmVjdG9yQ2xhc3M7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGUgaW1wbGVtZW50YXRpb24gY2xhc3MgZm9yIGEgY29ubmVjdG9yIHR5cGUuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBDb25uZWN0IHR5cGUuCiAgICAgICAgICogQHJldHVybnMge0FscGFjYS5Db25uZWN0b3J9IENvbm5lY3RvciBjbGFzcyBtYXBwZWQgdG8gY29ubmVjdCB0eXBlLgogICAgICAgICAqLwogICAgICAgIGdldENvbm5lY3RvckNsYXNzOiBmdW5jdGlvbih0eXBlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbm5lY3RvckNsYXNzUmVnaXN0cnlbdHlwZV07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVwbGFjZXMgZWFjaCBzdWJzdHJpbmcgb2YgdGhpcyBzdHJpbmcgdGhhdCBtYXRjaGVzIHRoZSBnaXZlbiByZWd1bGFyIGV4cHJlc3Npb24gd2l0aCB0aGUgZ2l2ZW4gcmVwbGFjZW1lbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdGV4dCBTb3VyY2Ugc3RyaW5nIGJlaW5nIHJlcGxhY2VkLgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSByZXBsYWNlIFJlZ3VsYXIgZXhwcmVzc2lvbiBmb3IgcmVwbGFjaW5nLgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB3aXRoX3RoaXMgUmVwbGFjZW1lbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXBsYWNlZCBzdHJpbmcuCiAgICAgICAgICovCiAgICAgICAgcmVwbGFjZUFsbDogZnVuY3Rpb24odGV4dCwgcmVwbGFjZSwgd2l0aF90aGlzKSB7CiAgICAgICAgICAgIHJldHVybiB0ZXh0LnJlcGxhY2UobmV3IFJlZ0V4cChyZXBsYWNlLCAnZycpLCB3aXRoX3RoaXMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENyZWF0ZXMgYW4gZWxlbWVudCB3aXRoIGEgZ2l2ZW4gdGFnIG5hbWUsIGRvbS9zdHlsZSBhdHRyaWJ1dGVzIGFuZCBjbGFzcyBuYW1lcy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0YWcgVGFnIG5hbWUuCiAgICAgICAgICogQHBhcmFtIHtBcnJheX0gZG9tQXR0cmlidXRlcyBET00gYXR0cmlidXRlcy4KICAgICAgICAgKiBAcGFyYW0ge0FycmF5fSBzdHlsZUF0dHJpYnV0ZXMgU3R5bGUgYXR0cmlidXRlcy4KICAgICAgICAgKiBAcGFyYW0ge0FycmF5fSBjbGFzc05hbWVzIENsYXNzIG5hbWVzLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gTmV3IGVsZW1lbnQgd2l0aCB0aGUgdGFnIG5hbWUgYW5kIGFsbCBvdGhlciBwcm92aWRlZCBhdHRyaWJ1dGVzLgogICAgICAgICAqLwogICAgICAgIGVsZW1lbnQ6IGZ1bmN0aW9uKHRhZywgZG9tQXR0cmlidXRlcywgc3R5bGVBdHRyaWJ1dGVzLCBjbGFzc05hbWVzKSB7CiAgICAgICAgICAgIHZhciBlbCA9ICQoIjwiICsgdGFnICsgIi8+Iik7CgogICAgICAgICAgICBpZiAoZG9tQXR0cmlidXRlcykgewogICAgICAgICAgICAgICAgZWwuYXR0cihkb21BdHRyaWJ1dGVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3R5bGVBdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgICAgICBlbC5jc3Moc3R5bGVBdHRyaWJ1dGVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2xhc3NOYW1lcykgewogICAgICAgICAgICAgICAgZm9yICh2YXIgY2xhc3NOYW1lIGluIGNsYXNzTmFtZXMpIHsKICAgICAgICAgICAgICAgICAgICBlbC5hZGRDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVwbGFjZXMgYSB0ZW1wbGF0ZSB3aXRoIGxpc3Qgb2YgcmVwbGFjZW1lbnRzLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHRlbXBsYXRlIFRlbXBsYXRlIGJlaW5nIHByb2Nlc3NlZC4KICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gc3Vic3RpdHV0aW9ucyBMaXN0IG9mIHN1YnN0aXR1dGlvbnMuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZXBsYWNlZCB0ZW1wbGF0ZS4KICAgICAgICAgKi8KICAgICAgICBlbGVtZW50RnJvbVRlbXBsYXRlOiBmdW5jdGlvbih0ZW1wbGF0ZSwgc3Vic3RpdHV0aW9ucykgewogICAgICAgICAgICB2YXIgaHRtbCA9IHRlbXBsYXRlOwogICAgICAgICAgICBpZiAoc3Vic3RpdHV0aW9ucykgewogICAgICAgICAgICAgICAgZm9yICh2YXIgeCBpbiBzdWJzdGl0dXRpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgaHRtbCA9IEFscGFjYS5yZXBsYWNlQWxsKGh0bWwsICIkeyIgKyB4ICsgIn0iLCBzdWJzdGl0dXRpb25zW3hdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gJChodG1sKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBHZW5lcmF0ZXMgYSB1bmlxdWUgYWxwYWNhIGlkLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge1N0cmluZ30gVGhlIHVuaXF1ZSBhbHBhY2EgaWQuCiAgICAgICAgICovCiAgICAgICAgZ2VuZXJhdGVJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIEFscGFjYS51bmlxdWVJZENvdW50ZXIrKzsKICAgICAgICAgICAgcmV0dXJuICJhbHBhY2EiICsgQWxwYWNhLnVuaXF1ZUlkQ291bnRlcjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEhlbHBlciBmdW5jdGlvbiB0byBwcm92aWRlIFlBSE9PIGxhdGVyIGxpa2UgY2FwYWJpbGl0aWVzLgogICAgICAgICAqLwogICAgICAgIGxhdGVyOiBmdW5jdGlvbih3aGVuLCBvLCBmbiwgZGF0YSwgcGVyaW9kaWMpIHsKICAgICAgICAgICAgd2hlbiA9IHdoZW4gfHwgMDsKICAgICAgICAgICAgbyA9IG8gfHwge307CiAgICAgICAgICAgIHZhciBtID0gZm4sIGQgPSAkLm1ha2VBcnJheShkYXRhKSwgZiwgcjsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICBtID0gb1tmbl07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghbSkgewogICAgICAgICAgICAgICAgLy8gVGhyb3cgYW4gZXJyb3IgYWJvdXQgdGhlIG1ldGhvZAogICAgICAgICAgICAgICAgdGhyb3cgewogICAgICAgICAgICAgICAgICAgIG5hbWU6ICdUeXBlRXJyb3InLAogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICJUaGUgZnVuY3Rpb24gaXMgdW5kZWZpbmVkLiIKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAaWdub3JlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBmID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBtLmFwcGx5KG8sIGQpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgciA9IChwZXJpb2RpYykgPyBzZXRJbnRlcnZhbChmLCB3aGVuKSA6IHNldFRpbWVvdXQoZiwgd2hlbik7CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgaWQ6IHIsCiAgICAgICAgICAgICAgICBpbnRlcnZhbDogcGVyaW9kaWMsCiAgICAgICAgICAgICAgICBjYW5jZWw6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmludGVydmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwocik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyBpZiBhbiBzdHJpbmcgZW5kcyB3aXRoIGEgZ2l2ZW4gc3VmZml4LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHRleHQgVGhlIHN0cmluZyBiZWluZyBldmFsdWF0ZWQuCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHN1ZmZpeCBTdWZmaXguCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgdGhlIHN0cmluZyBlbmRzIHdpdGggdGhlIGdpdmVuIHN1ZmZpeCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIGVuZHNXaXRoIDogZnVuY3Rpb24odGV4dCwgc3VmZml4KSB7CiAgICAgICAgICAgIHJldHVybiB0ZXh0LmluZGV4T2Yoc3VmZml4LCB0ZXh0Lmxlbmd0aCAtIHN1ZmZpeC5sZW5ndGgpICE9PSAtMTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyBpZiBhbiBzdHJpbmcgc3RhcnRzIHdpdGggYSBnaXZlbiBwcmVmaXguCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdGV4dCBUaGUgc3RyaW5nIGJlaW5nIGV2YWx1YXRlZC4KICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gcHJlZml4IFByZWZpeAogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmIHRoZSBzdHJpbmcgc3RhcnRzIHdpdGggdGhlIGdpdmVuIHByZWZpeCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIHN0YXJ0c1dpdGggOiBmdW5jdGlvbih0ZXh0LCBwcmVmaXgpIHsKICAgICAgICAgICAgLy9yZXR1cm4gKHRleHQubWF0Y2goIl4iICsgcHJlZml4KSA9PSBwcmVmaXgpOwogICAgICAgICAgICByZXR1cm4gdGV4dC5zdWJzdHIoMCwgcHJlZml4Lmxlbmd0aCkgPT09IHByZWZpeDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyBpZiBhIHZhcmlhYmxlIGlzIGEgVVJJLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9iaiBUaGUgdmFyaWFibGUgYmVpbmcgZXZhbHVhdGVkLgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmIHRoZSB2YXJpYWJsZSBpcyBhIFVSSSwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIGlzVXJpIDogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EuaXNTdHJpbmcob2JqKSAmJiAoQWxwYWNhLnN0YXJ0c1dpdGgob2JqLCAiaHR0cDovLyIpIHx8CiAgICAgICAgICAgICAgICAgICAgQWxwYWNhLnN0YXJ0c1dpdGgob2JqLCAiaHR0cHM6Ly8iKSB8fAogICAgICAgICAgICAgICAgICAgIEFscGFjYS5zdGFydHNXaXRoKG9iaiwgIi8iKSB8fAogICAgICAgICAgICAgICAgICAgIEFscGFjYS5zdGFydHNXaXRoKG9iaiwgIi4vIikgfHwKICAgICAgICAgICAgICAgICAgICBBbHBhY2Euc3RhcnRzV2l0aChvYmosICIuLi8iKSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUGlja3MgYSBzdWItZWxlbWVudCBmcm9tIGFuIG9iamVjdCB1c2luZyBhIGtleXMgYXJyYXkuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IE9iamVjdCB0byBiZSB0cmF2ZXJzZWQKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ3xBcnJheX0ga2V5cyBFaXRoZXIgYW4gYXJyYXkgb2YgdG9rZW5zIG9yIGEgZG90LWRlbGltaXRlZCBzdHJpbmcgKGkuZS4gImRhdGEudXNlci5maXJzdG5hbWUiKQogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBzdWJwcm9wIE9wdGlvbmFsIHN1YnByb3BlcnR5IHRvIHRyYXZlcnNlIChpLmUuLiAiZGF0YS5wcm9wZXJ0aWVzLnVzZXIucHJvcGVydGllcy5maXJzdG5hbWUiKQogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gU3ViIGVsZW1lbnQgbWFwcGVkIHRvIHRoZSBnaXZlbiBrZXkgcGF0aAogICAgICAgICAqLwogICAgICAgIHRyYXZlcnNlT2JqZWN0IDogZnVuY3Rpb24ob2JqZWN0LCBrZXlzLCBzdWJwcm9wKSB7CiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNTdHJpbmcoa2V5cykpIHsKICAgICAgICAgICAgICAgIGtleXMgPSBrZXlzLnNwbGl0KCIuIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gbnVsbDsKICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSBvYmplY3Q7CgogICAgICAgICAgICB2YXIga2V5ID0gbnVsbDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAga2V5ID0ga2V5cy5zaGlmdCgpOwogICAgICAgICAgICAgICAgaWYgKHN1YnByb3AgJiYga2V5ID09IHN1YnByb3ApIHsKICAgICAgICAgICAgICAgICAgICBrZXkgPSBrZXlzLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc0VtcHR5KGN1cnJlbnRba2V5XSkpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudFtrZXldOwogICAgICAgICAgICAgICAgICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50ID0gY3VycmVudDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGtleXMgPSBbXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAoa2V5cy5sZW5ndGggPiAwKTsKCiAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEhlbHBlciBmdW5jdGlvbiB0aGF0IGV4ZWN1dGVzIHRoZSBnaXZlbiBmdW5jdGlvbiB1cG9uIGVhY2ggZWxlbWVudCBpbiB0aGUgYXJyYXkKICAgICAgICAgKiBUaGUgZWxlbWVudCBvZiB0aGUgYXJyYXkgYmVjb21lcyB0aGUgInRoaXMiIHZhcmlhYmxlIGluIHRoZSBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R9IGRhdGEgRWl0aGVyIGFuIGFycmF5IG9yIGFuIG9iamVjdAogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgRnVuY3Rpb24gdG8gYmUgZXhlY3V0ZWQuCiAgICAgICAgICovCiAgICAgICAgZWFjaCA6IGZ1bmN0aW9uKGRhdGEsIGZ1bmMpIHsKICAgICAgICAgICAgaWYgKEFscGFjYS5pc0FycmF5KGRhdGEpKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBmdW5jLmFwcGx5KGRhdGFbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKEFscGFjYS5pc09iamVjdChkYXRhKSkgewogICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICBmdW5jLmFwcGx5KGRhdGFba2V5XSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBNZXJnZXMganNvbiBvYmoyIGludG8gb2JqMSB1c2luZyBhIHJlY3Vyc2l2ZSBhcHByb2FjaC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmoxIERlc3RpbmF0aW9uIG9iamVjdC4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqMiBTb3VyY2Ugb2JqZWN0LgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHZhbGlkS2V5RnVuY3Rpb24gRnVuY3Rpb24gdXNlZCB0byBkZXRlcm1pbmUgd2hldGhlciB0byBpbmNsdWRlIGEgZ2l2ZW4ga2V5IG9yIG5vdC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IE1lcmdlZCBvYmplY3QuCiAgICAgICAgICovCiAgICAgICAgbWVyZ2UgOiBmdW5jdGlvbihvYmoxLCBvYmoyLCB2YWxpZEtleUZ1bmN0aW9uKSB7CiAgICAgICAgICAgIGlmICghb2JqMSkgewogICAgICAgICAgICAgICAgb2JqMSA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBvYmoyKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsaWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgIGlmICh2YWxpZEtleUZ1bmN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsaWQgPSB2YWxpZEtleUZ1bmN0aW9uKGtleSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHZhbGlkKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKEFscGFjYS5pc0VtcHR5KG9iajJba2V5XSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb2JqMVtrZXldID0gb2JqMltrZXldOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNPYmplY3Qob2JqMltrZXldKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFvYmoxW2tleV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmoxW2tleV0gPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iajFba2V5XSA9IEFscGFjYS5tZXJnZShvYmoxW2tleV0sIG9iajJba2V5XSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmoxW2tleV0gPSBvYmoyW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBvYmoxOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIE1lcmdlcyBqc29uICJzb3VyY2UiIGludG8gInRhcmdldCIgdXNpbmcgYSByZWN1cnNpdmUgYXBwcm9hY2guIFRoZSBtZXJnZSB3aWxsIGluY2x1ZGUgZW1wdHkgdmFsdWVzCiAgICAgICAgICogb2Ygb2JqMiBwcm9wZXJ0aWVzLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHRhcmdldCBUYXJnZXQgb2JqZWN0LgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzb3VyY2UgU291cmNlIG9iamVjdC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IE1lcmdlZCBvYmplY3QKICAgICAgICAgKi8KICAgICAgICBtZXJnZU9iamVjdCA6IGZ1bmN0aW9uKHRhcmdldCwgc291cmNlKSB7CgogICAgICAgICAgICBpZiAoIXRhcmdldCkgewogICAgICAgICAgICAgICAgdGFyZ2V0ID0ge307CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghc291cmNlKSB7CiAgICAgICAgICAgICAgICBzb3VyY2UgPSB7fTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5tZXJnZU9iamVjdDIoc291cmNlLCB0YXJnZXQpOwoKICAgICAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgICB9LAoKICAgICAgICBtZXJnZU9iamVjdDI6IGZ1bmN0aW9uKHNvdXJjZSwgdGFyZ2V0KQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzQXJyYXkgPSBBbHBhY2EuaXNBcnJheTsKICAgICAgICAgICAgdmFyIGlzT2JqZWN0ID0gQWxwYWNhLmlzT2JqZWN0OwogICAgICAgICAgICB2YXIgaXNVbmRlZmluZWQgPSBBbHBhY2EuaXNVbmRlZmluZWQ7CiAgICAgICAgICAgIHZhciBjb3B5T2YgPSBBbHBhY2EuY29weU9mOwoKICAgICAgICAgICAgdmFyIF9tZXJnZSA9IGZ1bmN0aW9uKHNvdXJjZSwgdGFyZ2V0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaXNBcnJheShzb3VyY2UpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KHRhcmdldCkpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBtZXJnZSBhcnJheSBlbGVtZW50cwogICAgICAgICAgICAgICAgICAgICAgICAkLmVhY2goc291cmNlLCBmdW5jdGlvbihpbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0LnB1c2goY29weU9mKHNvdXJjZVtpbmRleF0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNvbWV0aGluZyBpcyBhbHJlYWR5IGluIHRoZSB0YXJnZXQgdGhhdCBpc24ndCBhbiBBUlJBWQogICAgICAgICAgICAgICAgICAgICAgICAvLyBza2lwCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoaXNPYmplY3Qoc291cmNlKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3QodGFyZ2V0KSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG1lcmdlIG9iamVjdCBwcm9wZXJ0aWVzCiAgICAgICAgICAgICAgICAgICAgICAgICQuZWFjaChzb3VyY2UsIGZ1bmN0aW9uKGtleSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZCh0YXJnZXRba2V5XSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRba2V5XSA9IGNvcHlPZihzb3VyY2Vba2V5XSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFtrZXldID0gX21lcmdlKHNvdXJjZVtrZXldLCB0YXJnZXRba2V5XSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc29tZXRoaW5nIGlzIGFscmVhZHkgaW4gdGhlIHRhcmdldCB0aGF0IGlzbid0IGFuIE9CSkVDVAogICAgICAgICAgICAgICAgICAgICAgICAvLyBza2lwCiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBvdGhlcndpc2UsIGl0J3MgYSBzY2FsYXIsIGFsd2F5cyBvdmVyd3JpdGUKICAgICAgICAgICAgICAgICAgICB0YXJnZXQgPSBjb3B5T2Yoc291cmNlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0OwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgX21lcmdlKHNvdXJjZSwgdGFyZ2V0KTsKCiAgICAgICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogU3Vic3RpdHV0ZXMgYSBzdHJpbmcgd2l0aCBhIGxpc3Qgb2YgdG9rZW5zLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHRleHQgU291cmNlIHN0cmluZy4KICAgICAgICAgKiBAcGFyYW0gYXJncyBMaXN0IG9mIHRva2Vucy4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIFN1YnN0aXR1dGVkIHN0cmluZy4KICAgICAgICAgKi8KICAgICAgICBzdWJzdGl0dXRlVG9rZW5zIDogZnVuY3Rpb24odGV4dCwgYXJncykgewoKICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eSh0ZXh0KSkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuID0gInsiICsgaSArICJ9IjsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHggPSB0ZXh0LmluZGV4T2YodG9rZW4pOwogICAgICAgICAgICAgICAgICAgIGlmICh4ID4gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG50ID0gdGV4dC5zdWJzdHJpbmcoMCwgeCkgKyBhcmdzW2ldICsgdGV4dC5zdWJzdHJpbmcoeCArIDMpOwogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vdGV4dCA9IEFscGFjYS5yZXBsYWNlQWxsKHRleHQsIHRva2VuLCBhcmdzW2ldKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRleHQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ29tcGFyZXMgdHdvIG9iamVjdHMuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqMSBGaXJzdCBvYmplY3QuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9iajIgU2Vjb25kIG9iamVjdC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmIHR3byBvYmplY3RzIGFyZSBzYW1lLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgY29tcGFyZU9iamVjdCA6IGZ1bmN0aW9uKG9iajEsIG9iajIpIHsKICAgICAgICAgICAgcmV0dXJuIGVxdWl2KG9iajEsIG9iajIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENvbXBhcmVzIGNvbnRlbnQgb2YgdHdvIGFycmF5cy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycl8xIEZpcnN0IGFycmF5LgogICAgICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycl8yIFNlY29uZCBhcnJheS4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZiB0d28gYXJyYXlzIGhhdmUgc2FtZSBjb250ZW50LCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgY29tcGFyZUFycmF5Q29udGVudCA6IGZ1bmN0aW9uKGFycl8xLCBhcnJfMikgewogICAgICAgICAgICB2YXIgZXF1YWwgPSBhcnJfMSAmJiBhcnJfMiAmJiAoYXJyXzEubGVuZ3RoID09IGFycl8yLmxlbmd0aCk7CiAgICAgICAgICAgIGlmIChlcXVhbCkgewogICAgICAgICAgICAgICAgJC5lYWNoKGFycl8xLCBmdW5jdGlvbihmb28sIHZhbCkgewogICAgICAgICAgICAgICAgICAgIGlmICghZXF1YWwpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoJC5pbkFycmF5KHZhbCwgYXJyXzIpID09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVxdWFsID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXF1YWwgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBlcXVhbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyB3aGV0aGVyIGEgdmFyaWFibGUgaGFzIGVtcHR5IHZhbHVlIG9yIG5vdC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7QW55fSB2YWwgVmFyaWFibGUgdG8gYmUgZXZhbHVhdGVkLgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmIHRoZSB2YXJpYWJsZSBoYXMgZW1wdHkgdmFsdWUsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgKi8KICAgICAgICBpc1ZhbEVtcHR5IDogZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgIHZhciBlbXB0eSA9IGZhbHNlOwogICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkodmFsKSkgewogICAgICAgICAgICAgICAgZW1wdHkgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKEFscGFjYS5pc1N0cmluZyh2YWwpICYmIHZhbCA9PT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICBlbXB0eSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzT2JqZWN0KHZhbCkgJiYgJC5pc0VtcHR5T2JqZWN0KHZhbCkpIHsKICAgICAgICAgICAgICAgICAgICBlbXB0eSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzQXJyYXkodmFsKSAmJiB2YWwubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgZW1wdHkgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKEFscGFjYS5pc051bWJlcih2YWwpICYmIGlzTmFOKHZhbCkpIHsKICAgICAgICAgICAgICAgICAgICBlbXB0eSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVtcHR5OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICoKICAgICAgICAgKiBJbml0aWFsIGZ1bmN0aW9uIGZvciBzZXR0aW5nIHVwIGZpZWxkIGluc3RhbmNlIGFuZCBleGVjdXRpbmcgY2FsbGJhY2tzIGlmIG5lZWRlZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBlbCBDb250YWluZXIgZWxlbWVudC4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGluaXRpYWxTZXR0aW5ncyBhbnkgYWRkaXRpb25hbCBzZXR0aW5ncyBwcm92aWRlZCB0byB0aGUgdG9wLWxldmVsIEFscGFjYSBvYmplY3QKICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBSZW5kZXIgY2FsbGJhY2suCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gcmVuZGVyZWRDYWxsYmFjayBQb3N0LXJlbmRlciBjYWxsYmFjay4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5jb25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IGlzRHluYW1pY0NyZWF0aW9uIHdoZXRoZXIgdGhpcyBhbHBhY2EgZmllbGQgaXMgYmVpbmcgZHluYW1pY2FsbHkgY3JlYXRlZCAoYWZ0ZXIgZmlyc3QgcmVuZGVyKQogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0FscGFjYS5GaWVsZH0gTmV3IGZpZWxkIGluc3RhbmNlLgogICAgICAgICAqLwogICAgICAgIGluaXQ6IGZ1bmN0aW9uKGVsLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGluaXRpYWxTZXR0aW5ncywgY2FsbGJhY2ssIHJlbmRlcmVkQ2FsbGJhY2ssIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaywgaXNEeW5hbWljQ3JlYXRpb24pIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBDT01QSUxBVElPTgogICAgICAgICAgICAvLwogICAgICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAgICAgICAgIC8vIGlmIHRoZXkgcHJvdmlkZWQgYW4gaW5saW5lIHZpZXcgb2JqZWN0LCB3ZSBhc3NpZ24gYW4gaWQgYW5kIHN0b3JlIG9udG8gdmlld3MgbWFwCiAgICAgICAgICAgIC8vIHNvIHRoYXQgaXQgZ2V0cyBjb21waWxlZCBhbG9uZyB3aXRoIHRoZSByZXN0CiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNPYmplY3QodmlldykpIHsKICAgICAgICAgICAgICAgIHZhciB2aWV3SWQgPSB2aWV3LmlkOwogICAgICAgICAgICAgICAgaWYgKCF2aWV3SWQpIHsKICAgICAgICAgICAgICAgICAgICB2aWV3LmlkID0gdGhpcy5nZW5lcmF0ZVZpZXdJZCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHBhcmVudElkID0gdmlldy5wYXJlbnQ7CiAgICAgICAgICAgICAgICBpZiAoIXBhcmVudElkKSB7CiAgICAgICAgICAgICAgICAgICAgdmlldy5wYXJlbnQgPSAiVklFV19XRUJfRURJVCI7IC8vIGFzc3VtZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RlclZpZXcodmlldyk7CiAgICAgICAgICAgICAgICB2aWV3ID0gdmlldy5pZDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gY29tcGlsZSBhbGwgb2YgdGhlIHZpZXdzIGFuZCB0ZW1wbGF0ZXMKICAgICAgICAgICAgdGhpcy5jb21waWxlKGZ1bmN0aW9uKHJlcG9ydCkgewoKICAgICAgICAgICAgICAgIGlmIChyZXBvcnQuZXJyb3JzICYmIHJlcG9ydC5lcnJvcnMubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlcG9ydC5lcnJvcnMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmlld0lkID0gcmVwb3J0LmVycm9yc1tpXS52aWV3SWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZUlkID0gcmVwb3J0LmVycm9yc1tpXS50ZW1wbGF0ZUlkOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXJyID0gcmVwb3J0LmVycm9yc1tpXS5lcnI7CgogICAgICAgICAgICAgICAgICAgICAgICBBbHBhY2EubG9nRXJyb3IoIlRoZSB0ZW1wbGF0ZTogIiArIHRlbXBsYXRlSWQgKyAiIGZvciB2aWV3OiAiICsgdmlld0lkICsgIiBmYWlsZWQgdG8gY29tcGlsZSIpOwogICAgICAgICAgICAgICAgICAgICAgICBBbHBhY2EubG9nRXJyb3IoSlNPTi5zdHJpbmdpZnkoZXJyKSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gQWxwYWNhLnRocm93RXJyb3JXaXRoQ2FsbGJhY2soIlZpZXcgY29tcGlsYXRpb24gZmFpbGVkLCBjYW5ub3QgaW5pdGlhbGl6ZSBBbHBhY2EuICBQbGVhc2UgY2hlY2sgdGhlIGVycm9yIGxvZ3MuIiwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgc2VsZi5faW5pdChlbCwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBpbml0aWFsU2V0dGluZ3MsIGNhbGxiYWNrLCByZW5kZXJlZENhbGxiYWNrLCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2ssIGlzRHluYW1pY0NyZWF0aW9uKTsKICAgICAgICAgICAgfSwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgX2luaXQ6IGZ1bmN0aW9uKGVsLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGluaXRpYWxTZXR0aW5ncywgY2FsbGJhY2ssIHJlbmRlcmVkQ2FsbGJhY2ssIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaywgaXNEeW5hbWljQ3JlYXRpb24pCiAgICAgICAgewogICAgICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAgICAgLy8KICAgICAgICAgICAgLy8gVklFVyBSRVNPTFVUSU9OCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKCiAgICAgICAgICAgIC8vIG1ha2Ugc29tZSBpbnRlbGxpZ2VudCBndWVzc2VzIGFib3V0IHdoYXQgdmlldyBpZCB3ZSBtaWdodCBkZWZhdWx0IHRvIGluIGNhc2UgdGhleSB3YW50IHRvIHVzZQogICAgICAgICAgICAvLyBhdXRvLXZpZXcgc2VsZWN0aW9uLiAgV2UgZGV0ZWN0IGpxdWVyeS11aSwgYm9vdHN0cmFwIGFuZCBqcXVlcnltb2JpbGUuCiAgICAgICAgICAgIHZhciBmYWxsYmFja1VJID0gbnVsbDsKICAgICAgICAgICAgdmFyIGZhbGxiYWNrVHlwZSA9IG51bGw7CiAgICAgICAgICAgIHZhciBmYWxsYmFja1ZpZXdJZCA9IG51bGw7CgogICAgICAgICAgICAvLyBpZiBqUXVlcnkgTW9iaWxlIGlzIHByZXNlbnQsIGZhbGwgYmFjayB0byBWSUVXX01PQklMRV9FRElUIG9yIFZJRVdfTU9CSUxFX0NSRUFURQogICAgICAgICAgICBpZiAoJC5tb2JpbGUpIHsKICAgICAgICAgICAgICAgIGZhbGxiYWNrVUkgPSAibW9iaWxlIjsKICAgICAgICAgICAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgZmFsbGJhY2tUeXBlID0gImVkaXQiOwogICAgICAgICAgICAgICAgICAgIGZhbGxiYWNrVmlld0lkID0gIlZJRVdfTU9CSUxFX0VESVQiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZmFsbGJhY2tUeXBlID0gImNyZWF0ZSI7CiAgICAgICAgICAgICAgICAgICAgZmFsbGJhY2tWaWV3SWQgPSAiVklFV19NT0JJTEVfQ1JFQVRFIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaWYgVHdpdHRlciBCb290c3RyYXAgaXMgcHJlc2VudCwgZmFsbCBiYWNrIHRvIFZJRVdfQk9PVFNUUkFQX0VESVQgb3IgVklFV19CT09UU1RSQVBfQ1JFQVRFCiAgICAgICAgICAgIHZhciBib290c3RyYXBEZXRlY3RlZCA9ICh0eXBlb2YgJCgpLm1vZGFsID09ICdmdW5jdGlvbicpOwogICAgICAgICAgICBpZiAoYm9vdHN0cmFwRGV0ZWN0ZWQpIHsKICAgICAgICAgICAgICAgIGZhbGxiYWNrVUkgPSAiYm9vdHN0cmFwIjsKICAgICAgICAgICAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgZmFsbGJhY2tUeXBlID0gImVkaXQiOwogICAgICAgICAgICAgICAgICAgIGZhbGxiYWNrVmlld0lkID0gIlZJRVdfQk9PVFNUUkFQX0VESVQiOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBmYWxsYmFja1R5cGUgPSAiY3JlYXRlIjsKICAgICAgICAgICAgICAgICAgICBmYWxsYmFja1ZpZXdJZCA9ICJWSUVXX0JPT1RTVFJBUF9DUkVBVEUiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpZiBubyB2aWV3IHByb3ZpZGVkLCBidXQgdGhleSBwcm92aWRlZCAidWkiIGFuZCBvcHRpb25hbGx5ICJ0eXBlIiwgdGhlbiB3ZSB0cnkgdG8gYXV0by1zZWxlY3QgdGhlIHZpZXcKICAgICAgICAgICAgaWYgKCF2aWV3KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgdWkgPSBpbml0aWFsU2V0dGluZ3MudWk7CiAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGluaXRpYWxTZXR0aW5ncy50eXBlOwoKICAgICAgICAgICAgICAgIGlmICghdWkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFmYWxsYmFja1VJKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZhbGxiYWNrVUkgPSBBbHBhY2EuZGVmYXVsdFVJOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZmFsbGJhY2tVSSkgewogICAgICAgICAgICAgICAgICAgICAgICB1aSA9IGZhbGxiYWNrVUk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh1aSkgewogICAgICAgICAgICAgICAgICAgIGlmICghdHlwZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0eXBlID0gZmFsbGJhY2tUeXBlID8gZmFsbGJhY2tUeXBlIDogImVkaXQiOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgQWxwYWNhLmxvZ0RlYnVnKCJObyB2aWV3IHByb3ZpZGVkIGJ1dCBmb3VuZCByZXF1ZXN0IGZvciBVSTogIiArIHVpICsgIiBhbmQgdHlwZTogIiArIHR5cGUpOwoKICAgICAgICAgICAgICAgICAgICAvLyBzZWUgaWYgd2UgY2FuIGF1dG8tc2VsZWN0IGEgdmlldwogICAgICAgICAgICAgICAgICAgIHZpZXcgPSB0aGlzLmxvb2t1cE5vcm1hbGl6ZWRWaWV3KHVpLCB0eXBlKTsKICAgICAgICAgICAgICAgICAgICBpZiAodmlldykgewogICAgICAgICAgICAgICAgICAgICAgICBBbHBhY2EubG9nRGVidWcoIkZvdW5kIHZpZXc6ICIgKyB2aWV3KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBBbHBhY2EubG9nRGVidWcoIk5vIHZpZXcgZm91bmQgZm9yIFVJOiAiICsgdWkgKyAiIGFuZCB0eXBlOiAiICsgdHlwZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpZiBzdGlsbCBubyB2aWV3LCB0aGVuIGRlZmF1bHQgZmFsbGJhY2sgdG8gb3VyIGRldGVjdGVkIHZpZXcgb3IgdGhlIGRlZmF1bHQKICAgICAgICAgICAgaWYgKCF2aWV3KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBBbHBhY2EubG9nRGVidWcoIkEgdmlldyB3YXMgbm90IHNwZWNpZmllZC4iKTsKICAgICAgICAgICAgICAgIGlmIChmYWxsYmFja1ZpZXdJZCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBBbHBhY2EubG9nRGVidWcoIkZhbGxpbmcgYmFjayB0byBkZXRlY3RlZCB2aWV3OiAiICsgZmFsbGJhY2tWaWV3SWQpOwogICAgICAgICAgICAgICAgICAgIHZpZXcgPSBmYWxsYmFja1ZpZXdJZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBBbHBhY2EubG9nRGVidWcoIkZhbGxpbmcgYmFjayB0byBkZWZhdWx0IHZpZXc6ICIgKyB0aGlzLmRlZmF1bHRWaWV3KTsKICAgICAgICAgICAgICAgICAgICB2aWV3ID0gdGhpcy5kZWZhdWx0VmlldzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZGVidWdnaW5nOiBpZiB0aGUgdmlldyBpc24ndCBhdmFpbGFibGUsIHdlIHdhbnQgdG8gcmVwb3J0IGl0IHJpZ2h0IGF3YXkKICAgICAgICAgICAgaWYgKEFscGFjYS5pc1N0cmluZyh2aWV3KSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLm5vcm1hbGl6ZWRWaWV3c1t2aWV3XSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gQWxwYWNhLnRocm93RXJyb3JXaXRoQ2FsbGJhY2soIlRoZSBkZXNpcmVkIHZpZXc6ICIgKyB2aWV3ICsgIiBjb3VsZCBub3QgYmUgbG9hZGVkLiAgUGxlYXNlIG1ha2Ugc3VyZSBpdCBpcyBsb2FkZWQgYW5kIG5vdCBtaXNzcGVsbGVkLiIsIGVycm9yQ2FsbGJhY2spOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vIEZJRUxEIElOU1RBTlRJQVRJT04KICAgICAgICAgICAgLy8KICAgICAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgICAgICAvLyBURVNUIC0gc3dhcCBjb2RlCiAgICAgICAgICAgIC8vIHN3YXAgZWwgLT4gcGxhY2Vob2xkZXIKICAgICAgICAgICAgLy92YXIgdGVtcEhvbGRlciA9ICQoIjxkaXY+PC9kaXY+Iik7CiAgICAgICAgICAgIC8vJChlbCkuYmVmb3JlKHRlbXBIb2xkZXIpOwogICAgICAgICAgICAvLyQoZWwpLnJlbW92ZSgpOwoKICAgICAgICAgICAgdmFyIGZpZWxkID0gQWxwYWNhLmNyZWF0ZUZpZWxkSW5zdGFuY2UoZWwsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICAgICAgaWYgKGZpZWxkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBoaWRlIGZpZWxkIHdoaWxlIHJlbmRlcmluZwogICAgICAgICAgICAgICAgJChlbCkuYWRkQ2xhc3MoImFscGFjYS1maWVsZC1yZW5kZXJpbmciKTsKICAgICAgICAgICAgICAgICQoZWwpLmFkZENsYXNzKCJhbHBhY2EtaGlkZGVuIik7CgogICAgICAgICAgICAgICAgZmllbGQuaXNEeW5hbWljQ3JlYXRpb24gPSBpc0R5bmFtaWNDcmVhdGlvbjsKICAgICAgICAgICAgICAgIEFscGFjYS5maWVsZEluc3RhbmNlc1tmaWVsZC5nZXRJZCgpXSA9IGZpZWxkOwoKICAgICAgICAgICAgICAgIC8vIG1lY2hhbmlzbSBmb3IgbG9va2luZyB1cCBmaWVsZCBpbnN0YW5jZXMgYnkgaWQKICAgICAgICAgICAgICAgIGZpZWxkLmFsbEZpZWxkSW5zdGFuY2VzID0gZnVuY3Rpb24oKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBBbHBhY2EuZmllbGRJbnN0YW5jZXM7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIC8vIGFsbG93IGNhbGxiYWNrcyBkZWZpbmVkIHRocm91Z2ggdmlldwogICAgICAgICAgICAgICAgaWYgKEFscGFjYS5pc0VtcHR5KGNhbGxiYWNrKSkgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gZmllbGQudmlldy5yZW5kZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkocmVuZGVyZWRDYWxsYmFjaykpIHsKICAgICAgICAgICAgICAgICAgICByZW5kZXJlZENhbGxiYWNrID0gZmllbGQudmlldy5wb3N0UmVuZGVyOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuY29sbGVjdFRpbWluZykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY291bnRlcnMgPSBBbHBhY2EuQ291bnRlcnMoInJlbmRlciIpOwogICAgICAgICAgICAgICAgICAgIHZhciB0MSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBmaW4gPSBmdW5jdGlvbigpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhpcyBpcyB0aGUgdG9wLWxldmVsIGFscGFjYSBmaWVsZCwgdGhlbiB3ZSBjYWxsIGZvciB2YWxpZGF0aW9uIHN0YXRlIHRvIGJlIHJlY2FsY3VsYXRlZCBhY3Jvc3MKICAgICAgICAgICAgICAgICAgICAvLyBhbGwgY2hpbGQgZmllbGRzCiAgICAgICAgICAgICAgICAgICAgaWYgKCFmaWVsZC5wYXJlbnQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBmaW5hbCBjYWxsIHRvIHVwZGF0ZSB2YWxpZGF0aW9uIHN0YXRlCiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkLnJlZnJlc2hWYWxpZGF0aW9uU3RhdGUodHJ1ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBmb3JjZSBoaWRlSW5pdFZhbGlkYXRpb25FcnJvciB0byBmYWxzZSBmb3IgZmllbGQgYW5kIGFsbCBjaGlsZHJlbgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmllbGQudmlldy50eXBlICE9ICd2aWV3JykKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgQWxwYWNhLmZpZWxkQXBwbHlDaGlsZHJlbihmaWVsZCwgZnVuY3Rpb24oZmllbGQpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2V0IHRvIGZhbHNlIGFmdGVyIGZpcnN0IHZhbGlkYXRpb24gKGV2ZW4gaWYgaW4gQ1JFQVRFIG1vZGUsIHdlIG9ubHkgZm9yY2UgaW5pdCB2YWxpZGF0aW9uIGVycm9yIGZhbHNlIG9uIGZpcnN0IHJlbmRlcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZC5oaWRlSW5pdFZhbGlkYXRpb25FcnJvciA9IGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBURVNUIC0gc3dhcCBjb2RlCiAgICAgICAgICAgICAgICAgICAgLy8gc3dhcCBwbGFjZWhvbGRlciAtPiBlbAogICAgICAgICAgICAgICAgICAgIC8vJCh0ZW1wSG9sZGVyKS5iZWZvcmUoZWwpOwogICAgICAgICAgICAgICAgICAgIC8vJCh0ZW1wSG9sZGVyKS5yZW1vdmUoKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gcmV2ZWFsIGZpZWxkIGFmdGVyIHJlbmRlcmluZwogICAgICAgICAgICAgICAgICAgICQoZWwpLnJlbW92ZUNsYXNzKCJhbHBhY2EtZmllbGQtcmVuZGVyaW5nIik7CiAgICAgICAgICAgICAgICAgICAgJChlbCkucmVtb3ZlQ2xhc3MoImFscGFjYS1oaWRkZW4iKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKEFscGFjYS5jb2xsZWN0VGltaW5nKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHQyID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50ZXJzLmluY3JlbWVudChmaWVsZC5nZXRGaWVsZFR5cGUoKSwgKHQyLXQxKSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZW5kZXJlZENhbGxiYWNrKGZpZWxkKTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eShjYWxsYmFjaykpIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhmaWVsZCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbigpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBmaWVsZC5yZW5kZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbigpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZpZWxkLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgICBmaWVsZC5yZW5kZXJlZENhbGxiYWNrID0gcmVuZGVyZWRDYWxsYmFjazsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTk9URTogdGhpcyBjYW4gYmUgbnVsbCBpZiBhbiBlcnJvciB3YXMgdGhyb3duCiAgICAgICAgICAgIHJldHVybiBmaWVsZDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqCiAgICAgICAgICogSW50ZXJuYWwgbWV0aG9kIGZvciBjb25zdHJ1Y3RpbmcgYSBmaWVsZCBpbnN0YW5jZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBlbCBUaGUgZG9tIGVsZW1lbnQgdG8gYWN0IGFzIHRoZSBjb250YWluZXIgb2YgdGhlIGNvbnN0cnVjdGVkIGZpZWxkLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBkYXRhIFRoZSBkYXRhIHRvIGJlIGJvdW5kIGludG8gdGhlIGZpZWxkLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIFRoZSBjb25maWd1cmF0aW9uIGZvciB0aGUgZmllbGQuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBUaGUgc2NoZW1hIGZvciB0aGUgZmllbGQuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IFRoZSB2aWV3IGZvciB0aGUgZmllbGQuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuY29ubmVjdG9yfSBjb25uZWN0b3IgVGhlIGZpZWxkIGNvbm5lY3RvciB0byBiZSBib3VuZCBpbnRvIHRoZSBmaWVsZC4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0FscGFjYS5GaWVsZH0gTmV3IGZpZWxkIGluc3RhbmNlLgogICAgICAgICAqLwogICAgICAgIGNyZWF0ZUZpZWxkSW5zdGFuY2UgOiBmdW5jdGlvbihlbCwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgLy8gbWFrZSBzdXJlIG9wdGlvbnMgYW5kIHNjaGVtYSBhcmUgbm90IGVtcHR5CiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNWYWxFbXB0eShvcHRpb25zKSkgb3B0aW9ucyA9IHt9OwogICAgICAgICAgICBpZiAoQWxwYWNhLmlzVmFsRW1wdHkoc2NoZW1hKSkgc2NoZW1hID0ge307CiAgICAgICAgICAgIC8vIG9wdGlvbnMgY2FuIGJlIGEgc3RyaW5nIHRoYXQgaWRlbnRpZmllcyB0aGUga2luZCBvZiBmaWVsZCB0byBjb25zdHJ1Y3QgKGkuZS4gInRleHQiKQogICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBBbHBhY2EuaXNTdHJpbmcob3B0aW9ucykpIHsKICAgICAgICAgICAgICAgIHZhciBmaWVsZFR5cGUgPSBvcHRpb25zOwogICAgICAgICAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICAgICAgICAgICAgb3B0aW9ucy50eXBlID0gZmllbGRUeXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghb3B0aW9ucy50eXBlKSB7CiAgICAgICAgICAgICAgICAvLyBpZiBub3RoaW5nIHBhc3NlZCBpbiwgd2UgY2FuIHRyeSB0byBtYWtlIGEgZ3Vlc3MgYmFzZWQgb24gdGhlIHR5cGUgb2YgZGF0YQogICAgICAgICAgICAgICAgaWYgKCFzY2hlbWEudHlwZSkgewogICAgICAgICAgICAgICAgICAgIHNjaGVtYS50eXBlID0gQWxwYWNhLmdldFNjaGVtYVR5cGUoZGF0YSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc2NoZW1hICYmIHNjaGVtYVsiZW51bSJdKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNjaGVtYVsiZW51bSJdLmxlbmd0aCA+IDMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy50eXBlID0gInNlbGVjdCI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy50eXBlID0gInJhZGlvIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG9wdGlvbnMudHlwZSA9IEFscGFjYS5kZWZhdWx0U2NoZW1hRmllbGRNYXBwaW5nW3NjaGVtYS50eXBlXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIGNoZWNrIGlmIGl0IGhhcyBmb3JtYXQgZGVmaW5lZAogICAgICAgICAgICAgICAgaWYgKHNjaGVtYS5mb3JtYXQgJiYgQWxwYWNhLmRlZmF1bHRGb3JtYXRGaWVsZE1hcHBpbmdbc2NoZW1hLmZvcm1hdF0pIHsKICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnR5cGUgPSBBbHBhY2EuZGVmYXVsdEZvcm1hdEZpZWxkTWFwcGluZ1tzY2hlbWEuZm9ybWF0XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBmaW5kIHRoZSBmaWVsZCBjbGFzcyByZWdpc3RlcmVkIGZvciB0aGlzIGZpZWxkIHR5cGUKICAgICAgICAgICAgdmFyIGZpZWxkQ2xhc3MgPSBBbHBhY2EuZ2V0RmllbGRDbGFzcyhvcHRpb25zLnR5cGUpOwogICAgICAgICAgICBpZiAoIWZpZWxkQ2xhc3MpIHsKICAgICAgICAgICAgICAgIGVycm9yQ2FsbGJhY2soewogICAgICAgICAgICAgICAgICAgICJtZXNzYWdlIjoiVW5hYmxlIHRvIGZpbmQgZmllbGQgY2xhc3MgZm9yIHR5cGU6ICIgKyBvcHRpb25zLnR5cGUsCiAgICAgICAgICAgICAgICAgICAgInJlYXNvbiI6ICJGSUVMRF9JTlNUQU5USUFUSU9OX0VSUk9SIgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBpZiB3ZSBoYXZlIGRhdGEsIGJpbmQgaXQgaW4KICAgICAgICAgICAgcmV0dXJuIG5ldyBmaWVsZENsYXNzKGVsLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUHJvdmlkZXMgYSBiYWNrd2FyZHMtY29tcGF0aWJsZSB2ZXJzaW9uIG9mIHRoZSBmb3JtZXIgalF1ZXJ5IDEuOC4zIHBhcnNlSlNPTiBmdW5jdGlvbiAodGhpcyB3YXMgY2hhbmdlZAogICAgICAgICAqIGZvciBqUXVlcnkgMS45LjAgYW5kIGludHJvZHVjZXMgYWxsIGtpbmRzIG9mIGlzc3VlcykuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gdGV4dAogICAgICAgICAqLwogICAgICAgIHBhcnNlSlNPTjogZnVuY3Rpb24odGV4dCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICghdGV4dCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiAkLnBhcnNlSlNPTih0ZXh0KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBDb21waWxlcyBhbGwgb2YgdGhlIHZpZXdzLCBub3JtYWxpemluZyB0aGVtIGZvciB1c2UgYnkgQWxwYWNhLgogICAgICAgICAqIEFsc28gY29tcGlsZXMgYW55IHRlbXBsYXRlcyB0aGF0IHRoZSB2aWV3cyBtYXkgcmVmZXJlbmNlLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIGNiIHRoZSBjYWxsYmFjayB0aGF0IGdldHMgZmlyZWQgb25jZSBjb21waWxhdGlvbiBoYXMgZW5kZWQKICAgICAgICAgKi8KICAgICAgICBjb21waWxlOiBmdW5jdGlvbihjYiwgZXJyb3JDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIC8vIHZhciB0MSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwoKICAgICAgICAgICAgdmFyIHJlcG9ydCA9IHsKICAgICAgICAgICAgICAgICJlcnJvcnMiOiBbXSwKICAgICAgICAgICAgICAgICJjb3VudCI6IDAsCiAgICAgICAgICAgICAgICAic3VjY2Vzc0NvdW50IjogMAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIGZpbmFsQ2FsbGJhY2sgPSBmdW5jdGlvbihub3JtYWxpemVkVmlld3MpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIHZhciB0MiA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coIkNvbXBpbGF0aW9uIEV4aXRlZCB3aXRoICIgKyByZXBvcnQuZXJyb3JzLmxlbmd0aCArICIgZXJyb3JzIGluOiAiICsgKHQyLXQxKSsgIiBtcyIpOwoKICAgICAgICAgICAgICAgIGlmIChyZXBvcnQuZXJyb3JzLmxlbmd0aCA9PT0gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBzdWNjZXNzIQoKICAgICAgICAgICAgICAgICAgICAvLyBjb3B5IG91ciB2aWV3cyBpbnRvIHRoZSBub3JtYWxpemVkIHNldAogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGsgaW4gbm9ybWFsaXplZFZpZXdzKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5ub3JtYWxpemVkVmlld3Nba10gPSBub3JtYWxpemVkVmlld3Nba107CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNiKHJlcG9ydCk7CiAgICAgICAgICAgIH07CgoKCiAgICAgICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBWSUVXIFRFTVBMQVRFIENPTVBJTEFUSU9OCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICAgICAgLy8gZm9yIGFsbCBvZiB0aGUgdmlld3MgKHRoZSBvcmlnaW5hbCBvbmVzLCBub3QgdGhlIGNvbXBpbGVkIG9uZXMpLCB3YWxrIHRocm91Z2ggdGhlbSBhbmQgZmluZCBhbnkKICAgICAgICAgICAgLy8gYW5kIGFsbCB0ZW1wbGF0ZXMgdGhhdCBuZWVkIHRvIGJlIGNvbXBpbGVkCiAgICAgICAgICAgIC8vIGNvbXBpbGUgZWFjaCBhbmQgc3RvcmUgaW4gYSAiY29tcGlsZWRUZW1wbGF0ZXMiIG9iamVjdAoKICAgICAgICAgICAgdmFyIHZpZXdDb21waWxlQ2FsbGJhY2sgPSBmdW5jdGlvbihub3JtYWxpemVkVmlld3MsIGVyciwgdmlldywgY29tcGlsZWRUZW1wbGF0ZUlkLCBjYWNoZUtleSwgdG90YWxDYWxscykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHZpZXdJZCA9IHZpZXcuaWQ7CgogICAgICAgICAgICAgICAgcmVwb3J0LmNvdW50Kys7CiAgICAgICAgICAgICAgICBpZiAoZXJyKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJlcG9ydC5lcnJvcnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICJ2aWV3Ijogdmlld0lkLAogICAgICAgICAgICAgICAgICAgICAgICAidGVtcGxhdGUiOiBjb21waWxlZFRlbXBsYXRlSWQsCiAgICAgICAgICAgICAgICAgICAgICAgICJlcnIiOiBlcnIKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXBvcnQuc3VjY2Vzc0NvdW50Kys7CgogICAgICAgICAgICAgICAgICAgIC8vIG1hcmsgb250byB0aGUgdmlldyB0aGF0IHRoZSB0ZW1wbGF0ZSB3YXMgY29tcGlsZWQgZm9yIHRoaXMgdmlldwogICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgbWFwcyBbY29tcGlsZWRUZW1wbGF0ZUlkXSAtPiBbY2FjaGVLZXldCiAgICAgICAgICAgICAgICAgICAgdmlldy5jb21waWxlZFRlbXBsYXRlc1tjb21waWxlZFRlbXBsYXRlSWRdID0gY2FjaGVLZXk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHJlcG9ydC5jb3VudCA9PSB0b3RhbENhbGxzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vdmFyIHQyID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZygiQ29tcGlsYXRpb24gdG9vazogIiArICh0Mi10MSkgKyAiIG1zIik7CiAgICAgICAgICAgICAgICAgICAgZmluYWxDYWxsYmFjayhub3JtYWxpemVkVmlld3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIGNvbXBpbGVWaWV3VGVtcGxhdGUgPSBmdW5jdGlvbihub3JtYWxpemVkVmlld3MsIHZpZXcsIGNvbXBpbGVkVGVtcGxhdGVJZCwgdGVtcGxhdGUsIHRvdGFsQ2FsbHMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB2aWV3SWQgPSB2aWV3LmlkOwoKICAgICAgICAgICAgICAgIHZhciBtaWdodEJlVXJsID0gKHRlbXBsYXRlICYmIHRlbXBsYXRlLmluZGV4T2YoIi8iKSA+IC0xKTsKICAgICAgICAgICAgICAgIGlmIChtaWdodEJlVXJsKQogICAgICAgICAgICAgICAgewoKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBzdXBwb3J0IGZvciBqUXVlcnkgc2VsZWN0b3JzCiAgICAgICAgICAgICAgICAgICAgaWYgKHRlbXBsYXRlICYmICgodGVtcGxhdGUuaW5kZXhPZigiIyIpID09PSAwKSB8fCAodGVtcGxhdGUuaW5kZXhPZigiLiIpID09PSAwKSkpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgeCA9ICQodGVtcGxhdGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICQoeCkuYXR0cigidHlwZSIpOwogICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZSA9ICQoeCkuaHRtbCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IG51bGw7CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzT2JqZWN0KHRlbXBsYXRlKSkgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSB0ZW1wbGF0ZS50eXBlOwogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlID0gdGVtcGxhdGUudGVtcGxhdGU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gaWYgdHlwZSBpc24ndCByZXNvbHZlZCwgYXNzdW1lIGpxdWVyeSB0bXBsKCkKICAgICAgICAgICAgICAgIGlmICghdHlwZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gInRleHQveC1qcXVlcnktdG1wbCI7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gbG9vayB1cCB0aGUgdGVtcGxhdGUgcHJvY2Vzc29yCiAgICAgICAgICAgICAgICB2YXIgZW5naW5lID0gQWxwYWNhLlRlbXBsYXRlRW5naW5lUmVnaXN0cnkuZmluZCh0eXBlKTsKICAgICAgICAgICAgICAgIGlmICghZW5naW5lKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIEFscGFjYS5sb2dFcnJvcigiQ2Fubm90IGZpbmQgdGVtcGxhdGUgZW5naW5lIGZvciB0eXBlOiAiICsgdHlwZSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVyciA9IG5ldyBFcnJvcigiQ2Fubm90IGZpbmQgdGVtcGxhdGUgZW5naW5lIGZvciB0eXBlOiAiICsgdHlwZSk7CiAgICAgICAgICAgICAgICAgICAgdmlld0NvbXBpbGVDYWxsYmFjayhub3JtYWxpemVkVmlld3MsIGVyciwgdmlldywgY29tcGlsZWRUZW1wbGF0ZUlkLCBjYWNoZUtleSwgdG90YWxDYWxscyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gdGhlIGRlc2lyZWQgbmV3IGNhY2hlIGtleQogICAgICAgICAgICAgICAgdmFyIGNhY2hlS2V5ID0gdmlld0lkICsgIl8iICsgY29tcGlsZWRUZW1wbGF0ZUlkOwogICAgICAgICAgICAgICAgaWYgKGVuZ2luZS5pc0NhY2hlZChjYWNoZUtleSkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gYWxyZWFkeSBjb21waWxlZCwgc28gc2tpcAogICAgICAgICAgICAgICAgICAgIHZpZXdDb21waWxlQ2FsbGJhY2sobm9ybWFsaXplZFZpZXdzLCBudWxsLCB2aWV3LCBjb21waWxlZFRlbXBsYXRlSWQsIGNhY2hlS2V5LCB0b3RhbENhbGxzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBjaGVjayBpZiAidGVtcGxhdGUiIGlzIGFjdHVhbGx5IGEgcmVmZXJlbmNlIHRvIGFub3RoZXIgdGVtcGxhdGUKICAgICAgICAgICAgICAgICAgICAvLyBpZiBzbywgd2UgY2FuIHJldXNlIHRoZSBwcmV2aW91c2x5IGNvbXBpbGVkIGZlbGxvdwoKICAgICAgICAgICAgICAgICAgICB2YXIgcHJldmlvdXNseUNvbXBpbGVkVGVtcGxhdGVDYWNoZUtleSA9IHZpZXcuY29tcGlsZWRUZW1wbGF0ZXNbInZpZXctIiArIHRlbXBsYXRlXTsKICAgICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNseUNvbXBpbGVkVGVtcGxhdGVDYWNoZUtleSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgZW50cnkgaXMgcG9pbnRpbmcgdG8gYSBwcmV2aW91c2x5IGNvbXBpbGVkIHRlbXBsYXRlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZldGNoIGh0bWwgYW5kIGNvbXBpbGUgYWdhaW4KICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUgPSBBbHBhY2EuVGVtcGxhdGVDYWNoZVtwcmV2aW91c2x5Q29tcGlsZWRUZW1wbGF0ZUNhY2hlS2V5XTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGNvbXBpbGUgdGhlIHRlbXBsYXRlCiAgICAgICAgICAgICAgICAgICAgZW5naW5lLmNvbXBpbGUoY2FjaGVLZXksIHRlbXBsYXRlLCBmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmlld0NvbXBpbGVDYWxsYmFjayhub3JtYWxpemVkVmlld3MsIGVyciwgdmlldywgY29tcGlsZWRUZW1wbGF0ZUlkLCBjYWNoZUtleSwgdG90YWxDYWxscyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIGNvbXBpbGVUZW1wbGF0ZXMgPSBmdW5jdGlvbihub3JtYWxpemVkVmlld3MpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIHdhbGsgdGhyb3VnaCBhbGwgbm9ybWFsaXplZCB2aWV3cyB0aGF0IHdlJ3JlIGludGVyZXN0ZWQgaW4gYW5kIGNvbXBpbGUgdGhlIHRlbXBsYXRlcyB3aXRoaW4KICAgICAgICAgICAgICAgIHZhciBmdW5jdGlvbkFycmF5ID0gW107CiAgICAgICAgICAgICAgICBmb3IgKHZhciB2aWV3SWQgaW4gbm9ybWFsaXplZFZpZXdzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciB2aWV3ID0gbm9ybWFsaXplZFZpZXdzW3ZpZXdJZF07CiAgICAgICAgICAgICAgICAgICAgdmlldy5jb21waWxlZFRlbXBsYXRlcyA9IHt9OwoKICAgICAgICAgICAgICAgICAgICAvLyB2aWV3IHRlbXBsYXRlcwogICAgICAgICAgICAgICAgICAgIGlmICh2aWV3LnRlbXBsYXRlcykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIHRlbXBsYXRlSWQgaW4gdmlldy50ZW1wbGF0ZXMpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHZpZXcudGVtcGxhdGVzW3RlbXBsYXRlSWRdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uQXJyYXkucHVzaChmdW5jdGlvbihub3JtYWxpemVkVmlld3MsIHZpZXcsIGNvbXBpbGVkVGVtcGxhdGVJZCwgdGVtcGxhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24odG90YWxDYWxscykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlVmlld1RlbXBsYXRlKG5vcm1hbGl6ZWRWaWV3cywgdmlldywgY29tcGlsZWRUZW1wbGF0ZUlkLCB0ZW1wbGF0ZSwgdG90YWxDYWxscyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0obm9ybWFsaXplZFZpZXdzLCB2aWV3LCAidmlldy0iICsgdGVtcGxhdGVJZCwgdGVtcGxhdGUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gZmllbGQgbGV2ZWwgdGVtcGxhdGVzCiAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXcuZmllbGRzKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgcGF0aCBpbiB2aWV3LmZpZWxkcykKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXcuZmllbGRzW3BhdGhdLnRlbXBsYXRlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciB0ZW1wbGF0ZUlkIGluIHZpZXcuZmllbGRzW3BhdGhdLnRlbXBsYXRlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHZpZXcuZmllbGRzW3BhdGhdLnRlbXBsYXRlc1t0ZW1wbGF0ZUlkXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uQXJyYXkucHVzaChmdW5jdGlvbihub3JtYWxpemVkVmlld3MsIHZpZXcsIGNvbXBpbGVkVGVtcGxhdGVJZCwgdGVtcGxhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbih0b3RhbENhbGxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZVZpZXdUZW1wbGF0ZShub3JtYWxpemVkVmlld3MsIHZpZXcsIGNvbXBpbGVkVGVtcGxhdGVJZCwgdGVtcGxhdGUsIHRvdGFsQ2FsbHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfShub3JtYWxpemVkVmlld3MsIHZpZXcsICJmaWVsZC0iICsgcGF0aCArICItIiArIHRlbXBsYXRlSWQsIHRlbXBsYXRlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBsYXlvdXQgdGVtcGxhdGUKICAgICAgICAgICAgICAgICAgICBpZiAodmlldy5sYXlvdXQgJiYgdmlldy5sYXlvdXQudGVtcGxhdGUpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSB2aWV3LmxheW91dC50ZW1wbGF0ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uQXJyYXkucHVzaChmdW5jdGlvbihub3JtYWxpemVkVmlld3MsIHZpZXcsIGNvbXBpbGVkVGVtcGxhdGVJZCwgdGVtcGxhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbih0b3RhbENhbGxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZVZpZXdUZW1wbGF0ZShub3JtYWxpemVkVmlld3MsIHZpZXcsIGNvbXBpbGVkVGVtcGxhdGVJZCwgdGVtcGxhdGUsIHRvdGFsQ2FsbHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgfShub3JtYWxpemVkVmlld3MsIHZpZXcsICJsYXlvdXRUZW1wbGF0ZSIsIHRlbXBsYXRlKSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBnbG9iYWwgdGVtcGxhdGUKICAgICAgICAgICAgICAgICAgICBpZiAodmlldy5nbG9iYWxUZW1wbGF0ZSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHZpZXcuZ2xvYmFsVGVtcGxhdGU7CgogICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbkFycmF5LnB1c2goZnVuY3Rpb24obm9ybWFsaXplZFZpZXdzLCB2aWV3LCBjb21waWxlZFRlbXBsYXRlSWQsIHRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24odG90YWxDYWxscykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGVWaWV3VGVtcGxhdGUobm9ybWFsaXplZFZpZXdzLCB2aWV3LCBjb21waWxlZFRlbXBsYXRlSWQsIHRlbXBsYXRlLCB0b3RhbENhbGxzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIH0obm9ybWFsaXplZFZpZXdzLCB2aWV3LCAiZ2xvYmFsVGVtcGxhdGUiLCB0ZW1wbGF0ZSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBub3cgaW52b2tlIGFsbCBvZiB0aGUgZnVuY3Rpb25zCiAgICAgICAgICAgICAgICAvLyB0aGlzIHRlbGxzIGVhY2ggdGVtcGxhdGUgdG8gY29tcGlsZQogICAgICAgICAgICAgICAgdmFyIHRvdGFsQ2FsbHMgPSBmdW5jdGlvbkFycmF5Lmxlbmd0aDsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZnVuY3Rpb25BcnJheS5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbkFycmF5W2ldKHRvdGFsQ2FsbHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZVZpZXdzID0gZnVuY3Rpb24oKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyB0aGUgdmlld3MgdGhhdCB3ZSdyZSBnb2luZyB0byBub3JtYWxpemVkCiAgICAgICAgICAgICAgICB2YXIgbm9ybWFsaXplZFZpZXdzID0ge307CiAgICAgICAgICAgICAgICB2YXIgbm9ybWFsaXplZFZpZXdDb3VudCA9IDA7CgogICAgICAgICAgICAgICAgLy8gc29tZSBpbml0aWFsIHNlbGYtYXNzdXJhbmNlIHRvIG1ha2Ugc3VyZSB3ZSBoYXZlIHRoZSBub3JtYWxpemVkVmlld3MgbWFwIHNldCB1cAogICAgICAgICAgICAgICAgaWYgKCFBbHBhY2Eubm9ybWFsaXplZFZpZXdzKSB7CiAgICAgICAgICAgICAgICAgICAgQWxwYWNhLm5vcm1hbGl6ZWRWaWV3cyA9IHt9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2VsZi5ub3JtYWxpemVkVmlld3MgPSBBbHBhY2Eubm9ybWFsaXplZFZpZXdzOwoKICAgICAgICAgICAgICAgIC8vIHdhbGsgdGhyb3VnaCBhbGwgb2Ygb3VyIHZpZXdzCiAgICAgICAgICAgICAgICBmb3IgKHZhciB2aWV3SWQgaW4gc2VsZi52aWV3cykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGUgdmlldyBpcyBhbHJlYWR5IG5vcm1hbGl6ZWQgb24gdGhlIEFscGFjYSBnbG9iYWwsIHdlIGRvIG5vdCBib3RoZXIKICAgICAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5ub3JtYWxpemVkVmlld3Nbdmlld0lkXSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBub3JtYWxpemVkVmlldyA9IG5ldyBBbHBhY2EuTm9ybWFsaXplZFZpZXcodmlld0lkKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZWRWaWV3Lm5vcm1hbGl6ZSgpKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3JtYWxpemVkVmlld3Nbdmlld0lkXSA9IG5vcm1hbGl6ZWRWaWV3OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9ybWFsaXplZFZpZXdDb3VudCsrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEFscGFjYS50aHJvd0Vycm9yV2l0aENhbGxiYWNrKCJWaWV3IG5vcm1hbGl6YXRpb24gZmFpbGVkLCBjYW5ub3QgaW5pdGlhbGl6ZSBBbHBhY2EuICBQbGVhc2UgY2hlY2sgdGhlIGVycm9yIGxvZ3MuIiwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZWRWaWV3Q291bnQgPiAwKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGNvbXBpbGVUZW1wbGF0ZXMobm9ybWFsaXplZFZpZXdzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBmaW5hbENhbGxiYWNrKG5vcm1hbGl6ZWRWaWV3cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBub3JtYWxpemVWaWV3cygpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIExvb2tzIHVwIHRoZSBwcm9wZXIgdGVtcGxhdGUgdG8gYmUgdXNlZCB0byBoYW5kbGUgYSByZXF1ZXN0ZWQgdGVtcGxhdGUgaWQgZm9yIGEgdmlldyBhbmQgYSBmaWVsZC4KICAgICAgICAgKiBQZXJmb3JtcyBhbiBvdmVycmlkZSBsb29rdXAgdG8gZmluZCB0aGUgcHJvcGVyIHRlbXBsYXRlLgogICAgICAgICAqCiAgICAgICAgICogSGFuZHMgYmFjayBhIGRlc2NyaXB0b3Igb2YgZXZlcnl0aGluZyB0aGF0IGlzIGtub3duIGFib3V0IHRoZSByZXNvbHZlZCB0ZW1wbGF0ZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB2aWV3CiAgICAgICAgICogQHBhcmFtIHRlbXBsYXRlSWQKICAgICAgICAgKiBAcGFyYW0gZmllbGQKICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgZ2V0VGVtcGxhdGVEZXNjcmlwdG9yOiBmdW5jdGlvbih2aWV3LCB0ZW1wbGF0ZUlkLCBmaWVsZCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBkZXNjcmlwdG9yID0ge307CgogICAgICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBGSUdVUkUgT1VUIFdIRVJFIFRIRSBURU1QTEFURSBJUyBJTiBUSEUgVklFVyBDT05GSUdVUkFUSU9OIChSRVNQRUNUSU5HIEZJRUxEIE9WRVJSSURFUykKICAgICAgICAgICAgLy8KICAgICAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAgICAgICAgIHZhciBfdGVtcGxhdGU7CiAgICAgICAgICAgIHZhciBfdGVtcGxhdGVUeXBlOwoKICAgICAgICAgICAgLy8gZmlyc3QgY29uc2lkZXIgdGVtcGxhdGUgbGV2ZWwKICAgICAgICAgICAgaWYgKHZpZXcudGVtcGxhdGVzICYmIHZpZXcudGVtcGxhdGVzW3RlbXBsYXRlSWRdKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBfdGVtcGxhdGUgPSB2aWV3LnRlbXBsYXRlc1t0ZW1wbGF0ZUlkXTsKICAgICAgICAgICAgICAgIF90ZW1wbGF0ZVR5cGUgPSAidmlldyI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIG5vdyBhbGxvdyBmb3IgZmllbGQgb3ZlcnJpZGVzCiAgICAgICAgICAgIGlmIChmaWVsZCAmJiBmaWVsZC5wYXRoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgcGF0aCA9IGZpZWxkLnBhdGg7CgogICAgICAgICAgICAgICAgaWYgKHZpZXcgJiYgdmlldy5maWVsZHMgJiYgdmlldy5maWVsZHNbcGF0aF0gJiYgdmlldy5maWVsZHNbcGF0aF0udGVtcGxhdGVzICYmIHZpZXcuZmllbGRzW3BhdGhdLnRlbXBsYXRlc1t0ZW1wbGF0ZUlkXSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBfdGVtcGxhdGUgPSB2aWV3LmZpZWxkc1twYXRoXS50ZW1wbGF0ZXNbdGVtcGxhdGVJZF07CiAgICAgICAgICAgICAgICAgICAgX3RlbXBsYXRlVHlwZSA9ICJmaWVsZCI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGZpbmFsbHkgdGhlcmUgYXJlIHNvbWUgaGFyZGNvZGVkIHZhbHVlcwogICAgICAgICAgICBpZiAodGVtcGxhdGVJZCA9PSAiZ2xvYmFsVGVtcGxhdGUiKSB7CiAgICAgICAgICAgICAgICBfdGVtcGxhdGUgPSAiZ2xvYmFsVGVtcGxhdGUiOwogICAgICAgICAgICAgICAgX3RlbXBsYXRlVHlwZSA9ICJnbG9iYWwiOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGVtcGxhdGVJZCA9PSAibGF5b3V0VGVtcGxhdGUiKSB7CiAgICAgICAgICAgICAgICBfdGVtcGxhdGUgPSAibGF5b3V0VGVtcGxhdGUiOwogICAgICAgICAgICAgICAgX3RlbXBsYXRlVHlwZSA9ICJsYXlvdXQiOwogICAgICAgICAgICB9CgogICAgICAgICAgICBkZXNjcmlwdG9yLnRlbXBsYXRlID0ge307CiAgICAgICAgICAgIGRlc2NyaXB0b3IudGVtcGxhdGUuaWQgPSB0ZW1wbGF0ZUlkOwogICAgICAgICAgICBkZXNjcmlwdG9yLnRlbXBsYXRlLnR5cGUgPSBfdGVtcGxhdGVUeXBlOwogICAgICAgICAgICBkZXNjcmlwdG9yLnRlbXBsYXRlLnZhbHVlID0gX3RlbXBsYXRlOwoKCiAgICAgICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vIEVOR0lORSBQUk9QRVJUSUVTCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgICAgICB2YXIgdHlwZSA9IG51bGw7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IF90ZW1wbGF0ZTsKICAgICAgICAgICAgaWYgKEFscGFjYS5pc09iamVjdCh0ZW1wbGF0ZSkpIHsKICAgICAgICAgICAgICAgIHR5cGUgPSB0ZW1wbGF0ZS50eXBlOwogICAgICAgICAgICAgICAgdGVtcGxhdGUgPSB0ZW1wbGF0ZS50ZW1wbGF0ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaWYgdHlwZSBpc24ndCByZXNvbHZlZCwgYXNzdW1lIGpxdWVyeSB0bXBsKCkKICAgICAgICAgICAgaWYgKCF0eXBlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0eXBlID0gInRleHQveC1qcXVlcnktdG1wbCI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBlbmdpbmUgPSBBbHBhY2EuVGVtcGxhdGVFbmdpbmVSZWdpc3RyeS5maW5kKHR5cGUpOwogICAgICAgICAgICBpZiAoIWVuZ2luZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIEFscGFjYS50aHJvd0RlZmF1bHRFcnJvcigiQ2Fubm90IGZpbmQgdGVtcGxhdGUgZW5naW5lIGZvciB0eXBlOiAiICsgdHlwZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGRlc2NyaXB0b3IuZW5naW5lID0ge307CiAgICAgICAgICAgIGRlc2NyaXB0b3IuZW5naW5lLnR5cGUgPSB0eXBlOwogICAgICAgICAgICBkZXNjcmlwdG9yLmVuZ2luZS5pZCA9IGVuZ2luZS5pZDsKCgoKICAgICAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAgICAgLy8KICAgICAgICAgICAgLy8gTk9XIERFVEVSTUlORSBUSEUgQ09NUElMRUQgVEVNUExBVEUgSUQgRk9SIFRISVMgVEVNUExBVEUKICAgICAgICAgICAgLy8KICAgICAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAgICAgICAgIHZhciBjb21waWxlZFRlbXBsYXRlSWQgPSBudWxsOwogICAgICAgICAgICBpZiAoX3RlbXBsYXRlVHlwZSA9PSAidmlldyIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbXBpbGVkVGVtcGxhdGVJZCA9ICJ2aWV3LSIgKyB0ZW1wbGF0ZUlkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKF90ZW1wbGF0ZVR5cGUgPT0gImZpZWxkIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29tcGlsZWRUZW1wbGF0ZUlkID0gImZpZWxkLSIgKyBmaWVsZC5wYXRoICsgIi0iICsgdGVtcGxhdGVJZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChfdGVtcGxhdGVUeXBlID09ICJsYXlvdXQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb21waWxlZFRlbXBsYXRlSWQgPSAibGF5b3V0VGVtcGxhdGUiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKF90ZW1wbGF0ZVR5cGUgPT0gImdsb2JhbCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbXBpbGVkVGVtcGxhdGVJZCA9ICJnbG9iYWxUZW1wbGF0ZSI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGRlc2NyaXB0b3IuY29tcGlsZWRUZW1wbGF0ZUlkID0gY29tcGlsZWRUZW1wbGF0ZUlkOwoKCiAgICAgICAgICAgIC8vIGxvb2sgdXAgdGhlIGNhY2hlS2V5IGZvciB0aGlzIGNvbXBpbGVkIHRlbXBsYXRlIGlkCiAgICAgICAgICAgIC8vIHZlcmlmeSBpdCBpcyBpbiBjYWNoZQogICAgICAgICAgICB2YXIgY2FjaGVLZXkgPSB2aWV3LmNvbXBpbGVkVGVtcGxhdGVzW2NvbXBpbGVkVGVtcGxhdGVJZF07CiAgICAgICAgICAgIGlmICghY2FjaGVLZXkgfHwgIWVuZ2luZS5pc0NhY2hlZChjYWNoZUtleSkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIHdlbGwsIGl0IGlzbid0IGFjdHVhbGx5IGEgY29tcGlsZWQgdGVtcGxhdGUKICAgICAgICAgICAgICAgIC8vIHRodXMsIHdlIGNhbm5vdCBpbiB0aGUgZW5kIHByb2R1Y2UgYSBkZXNjcmlwdG9yIGZvciBpdAogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGRlc2NyaXB0b3IuY2FjaGUgPSB7fTsKICAgICAgICAgICAgZGVzY3JpcHRvci5jYWNoZS5rZXkgPSBjYWNoZUtleTsKCiAgICAgICAgICAgIHJldHVybiBkZXNjcmlwdG9yOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEV4ZWN1dGVzIGEgdGVtcGxhdGUgYW5kIHJldHVybnMgYSBET00gZWxlbWVudC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB0ZW1wbGF0ZURlc2NyaXB0b3IKICAgICAgICAgKiBAcGFyYW0gbW9kZWwKICAgICAgICAgKi8KICAgICAgICB0bXBsOiBmdW5jdGlvbih0ZW1wbGF0ZURlc2NyaXB0b3IsIG1vZGVsKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGh0bWwgPSBBbHBhY2EudG1wbEh0bWwodGVtcGxhdGVEZXNjcmlwdG9yLCBtb2RlbCk7CgogICAgICAgICAgICByZXR1cm4gQWxwYWNhLnNhZmVEb21QYXJzZShodG1sKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBFeGVjdXRlcyBhIHRlbXBsYXRlIGFuZCByZXR1cm5zIEhUTUwuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gdGVtcGxhdGVEZXNjcmlwdG9yCiAgICAgICAgICogQHBhcmFtIG1vZGVsCiAgICAgICAgICovCiAgICAgICAgdG1wbEh0bWw6IGZ1bmN0aW9uKHRlbXBsYXRlRGVzY3JpcHRvciwgbW9kZWwpCiAgICAgICAgewogICAgICAgICAgICBpZiAoIW1vZGVsKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtb2RlbCA9IHt9OwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgZW5naW5lVHlwZSA9IHRlbXBsYXRlRGVzY3JpcHRvci5lbmdpbmUudHlwZTsKICAgICAgICAgICAgdmFyIGNvbXBpbGVkVGVtcGxhdGVJZCA9IHRlbXBsYXRlRGVzY3JpcHRvci5jb21waWxlZFRlbXBsYXRlSWQ7CgogICAgICAgICAgICB2YXIgZW5naW5lID0gQWxwYWNhLlRlbXBsYXRlRW5naW5lUmVnaXN0cnkuZmluZChlbmdpbmVUeXBlKTsKICAgICAgICAgICAgaWYgKCFlbmdpbmUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBBbHBhY2EudGhyb3dEZWZhdWx0RXJyb3IoIkNhbm5vdCBmaW5kIHRlbXBsYXRlIGVuZ2luZSBmb3IgdHlwZTogIiArIGVuZ2luZVR5cGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBleGVjdXRlIHRoZSB0ZW1wbGF0ZQogICAgICAgICAgICB2YXIgY2FjaGVLZXkgPSB0ZW1wbGF0ZURlc2NyaXB0b3IuY2FjaGUua2V5OwogICAgICAgICAgICB2YXIgaHRtbCA9IGVuZ2luZS5leGVjdXRlKGNhY2hlS2V5LCBtb2RlbCwgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gQWxwYWNhLnRocm93RGVmYXVsdEVycm9yKCJUaGUgY29tcGlsZWQgdGVtcGxhdGU6ICIgKyBjb21waWxlZFRlbXBsYXRlSWQgKyAiIGZhaWxlZCB0byBleGVjdXRlOiAiICsgSlNPTi5zdHJpbmdpZnkoZXJyKSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgcmV0dXJuIGh0bWw7CiAgICAgICAgfQogICAgfSk7CgoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vCiAgICAvLyBMT0dHRVIKICAgIC8vCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgQWxwYWNhLkRFQlVHID0gMDsKICAgIEFscGFjYS5JTkZPID0gMTsKICAgIEFscGFjYS5XQVJOID0gMjsKICAgIEFscGFjYS5FUlJPUiA9IDM7CgogICAgLy8gYnkgZGVmYXVsdCwgbG9nZ2luZyBvbmx5IHNob3dzIHdhcm5pbmdzIGFuZCBhYm92ZQogICAgLy8gdG8gZGVidWcsIHNldCBBbHBhY2EubG9nTGV2ZWwgPSBBbHBhY2EuREVCVUcKICAgIEFscGFjYS5sb2dMZXZlbCA9IEFscGFjYS5XQVJOOwoKICAgIEFscGFjYS5sb2dEZWJ1ZyA9IGZ1bmN0aW9uKG9iaikgewogICAgICAgIEFscGFjYS5sb2coQWxwYWNhLkRFQlVHLCBvYmopOwogICAgfTsKICAgIEFscGFjYS5sb2dJbmZvID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgQWxwYWNhLmxvZyhBbHBhY2EuSU5GTywgb2JqKTsKICAgIH07CiAgICBBbHBhY2EubG9nV2FybiA9IGZ1bmN0aW9uKG9iaikgewogICAgICAgIEFscGFjYS5sb2coQWxwYWNhLldBUk4sIG9iaik7CiAgICB9OwogICAgQWxwYWNhLmxvZ0Vycm9yID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgQWxwYWNhLmxvZyhBbHBhY2EuRVJST1IsIG9iaik7CiAgICB9OwoKICAgIEFscGFjYS5MT0dfTUVUSE9EX01BUCA9IHsKICAgICAgICAwOiAnZGVidWcnLAogICAgICAgIDE6ICdpbmZvJywKICAgICAgICAyOiAnd2FybicsCiAgICAgICAgMzogJ2Vycm9yJwogICAgfTsKCiAgICBBbHBhY2EubG9nID0gZnVuY3Rpb24obGV2ZWwsIG9iaikgewoKICAgICAgICBpZiAoQWxwYWNhLmxvZ0xldmVsIDw9IGxldmVsKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIG1ldGhvZCA9IEFscGFjYS5MT0dfTUVUSE9EX01BUFtsZXZlbF07CgogICAgICAgICAgICBpZiAodHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnICYmIGNvbnNvbGVbbWV0aG9kXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCJkZWJ1ZyIgPT0gbWV0aG9kKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhvYmopOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoImluZm8iID09IG1ldGhvZCkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuaW5mbyhvYmopOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoIndhcm4iID09IG1ldGhvZCkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihvYmopOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoImVycm9yIiA9PSBtZXRob2QpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKG9iaik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhvYmopOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICBBbHBhY2EuY2hlY2tlZCA9IGZ1bmN0aW9uKGVsLCB2YWx1ZSkKICAgIHsKICAgICAgICByZXR1cm4gQWxwYWNhLmF0dHJQcm9wKGVsLCAiY2hlY2tlZCIsIHZhbHVlKTsKICAgIH07CgogICAgQWxwYWNhLmF0dHJQcm9wID0gZnVuY3Rpb24oZWwsIG5hbWUsIHZhbHVlKQogICAgewogICAgICAgIGlmICghKHR5cGVvZih2YWx1ZSkgPT09ICJ1bmRlZmluZWQiKSkKICAgICAgICB7CiAgICAgICAgICAgIC8vIGpRdWVyeSAxLjYrCiAgICAgICAgICAgIGlmICgkKGVsKS5wcm9wKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAkKGVsKS5wcm9wKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICQoZWwpLmF0dHIobmFtZSwgdmFsdWUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkKGVsKS5yZW1vdmVBdHRyKG5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBub3cgcmV0dXJuIHRoZSBjb3JyZWN0IHZhbHVlCgogICAgICAgIC8vIGpRdWVyeSAxLjYrCiAgICAgICAgaWYgKCQoZWwpLnByb3ApIHsKICAgICAgICAgICAgcmV0dXJuICQoZWwpLnByb3AobmFtZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gJChlbCkuYXR0cihuYW1lKTsKICAgIH07CgogICAgQWxwYWNhLmxvYWRSZWZTY2hlbWFPcHRpb25zID0gZnVuY3Rpb24odG9wRmllbGQsIHJlZmVyZW5jZUlkLCBjYWxsYmFjaykKICAgIHsKICAgICAgICBpZiAoIXJlZmVyZW5jZUlkKQogICAgICAgIHsKICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAocmVmZXJlbmNlSWQgPT0gIiMiKQogICAgICAgIHsKICAgICAgICAgICAgLy8gdGhpcyBpcyB0aGUgdXJpIG9mIHRoZSBjdXJyZW50IHNjaGVtYSBkb2N1bWVudAogICAgICAgICAgICBjYWxsYmFjayh0b3BGaWVsZC5zY2hlbWEsIHRvcEZpZWxkLm9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChyZWZlcmVuY2VJZC5pbmRleE9mKCIjLyIpID09IDApCiAgICAgICAgewogICAgICAgICAgICAvLyB0aGlzIGlzIGEgcHJvcGVydHkgcGF0aCByZWxhdGl2ZSB0byB0aGUgcm9vdCBvZiB0aGUgY3VycmVudCBzY2hlbWEKICAgICAgICAgICAgdmFyIGRlZklkID0gcmVmZXJlbmNlSWQuc3Vic3RyaW5nKDIpOwoKICAgICAgICAgICAgLy8gc3BsaXQgaW50byB0b2tlbnMKICAgICAgICAgICAgdmFyIHRva2VucyA9IGRlZklkLnNwbGl0KCIvIik7CgogICAgICAgICAgICB2YXIgZGVmU2NoZW1hID0gdG9wRmllbGQuc2NoZW1hOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRva2Vucy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHRva2VuID0gdG9rZW5zW2ldOwoKICAgICAgICAgICAgICAgIC8vIHNjaGVtYQogICAgICAgICAgICAgICAgaWYgKGRlZlNjaGVtYVt0b2tlbl0pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZGVmU2NoZW1hID0gZGVmU2NoZW1hW3Rva2VuXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKGRlZlNjaGVtYS5wcm9wZXJ0aWVzICYmIGRlZlNjaGVtYS5wcm9wZXJ0aWVzW3Rva2VuXSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkZWZTY2hlbWEgPSBkZWZTY2hlbWEucHJvcGVydGllc1t0b2tlbl07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChkZWZTY2hlbWEuZGVmaW5pdGlvbnMgJiYgZGVmU2NoZW1hLmRlZmluaXRpb25zW3Rva2VuXSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkZWZTY2hlbWEgPSBkZWZTY2hlbWEuZGVmaW5pdGlvbnNbdG9rZW5dOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGRlZlNjaGVtYSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBkZWZPcHRpb25zID0gdG9wRmllbGQub3B0aW9uczsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0b2tlbnMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IHRva2Vuc1tpXTsKCiAgICAgICAgICAgICAgICAvLyBvcHRpb25zCiAgICAgICAgICAgICAgICBpZiAoZGVmT3B0aW9uc1t0b2tlbl0pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZGVmT3B0aW9ucyA9IGRlZk9wdGlvbnNbdG9rZW5dOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoZGVmT3B0aW9ucy5maWVsZHMgJiYgZGVmT3B0aW9ucy5maWVsZHNbdG9rZW5dKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGRlZk9wdGlvbnMgPSBkZWZPcHRpb25zLmZpZWxkc1t0b2tlbl07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChkZWZPcHRpb25zLmRlZmluaXRpb25zICYmIGRlZk9wdGlvbnMuZGVmaW5pdGlvbnNbdG9rZW5dKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGRlZk9wdGlvbnMgPSBkZWZPcHRpb25zLmRlZmluaXRpb25zW3Rva2VuXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBkZWZPcHRpb25zID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2FsbGJhY2soZGVmU2NoZW1hLCBkZWZPcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAocmVmZXJlbmNlSWQuaW5kZXhPZigiIyIpID09IDApCiAgICAgICAgewogICAgICAgICAgICAvLyB0aGlzIGlzIHRoZSBJRCBvZiBhIG5vZGUgaW4gdGhlIGN1cnJlbnQgc2NoZW1hIGRvY3VtZW50CgogICAgICAgICAgICAvLyB3YWxrIHRoZSBjdXJyZW50IGRvY3VtZW50IHNjaGVtYSB1bnRpbCB3ZSBmaW5kIHRoZSByZWZlcmVuY2VkIG5vZGUgKHVzaW5nIGlkIHByb3BlcnR5KQogICAgICAgICAgICB2YXIgcmVzb2x1dGlvbiA9IEFscGFjYS5yZXNvbHZlUmVmZXJlbmNlKHRvcEZpZWxkLnNjaGVtYSwgdG9wRmllbGQub3B0aW9ucywgcmVmZXJlbmNlSWQpOwogICAgICAgICAgICBpZiAocmVzb2x1dGlvbikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2FsbGJhY2socmVzb2x1dGlvbi5zY2hlbWEsIHJlc29sdXRpb24ub3B0aW9ucyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBub3RoaW5nCiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vIHRoZSByZWZlcmVuY2UgaXMgY29uc2lkZXJlZCB0byBiZSBhIFVSSSB3aXRoIG9yIHdpdGhvdXQgYSAiIyIgaW4gaXQgdG8gcG9pbnQgdG8gYSBzcGVjaWZpYyBsb2NhdGlvbiBpbgogICAgICAgICAgICAvLyB0aGUgdGFyZ2V0IHNjaGVtYQoKICAgICAgICAgICAgdmFyIHJlZmVyZW5jZVBhcnRzID0gQWxwYWNhLnBhdGhQYXJ0cyhyZWZlcmVuY2VJZCk7CgogICAgICAgICAgICB0b3BGaWVsZC5jb25uZWN0b3IubG9hZFJlZmVyZW5jZVNjaGVtYShyZWZlcmVuY2VQYXJ0cy5wYXRoLCBmdW5jdGlvbihzY2hlbWEpIHsKICAgICAgICAgICAgICAgIHRvcEZpZWxkLmNvbm5lY3Rvci5sb2FkUmVmZXJlbmNlT3B0aW9ucyhyZWZlcmVuY2VQYXJ0cy5wYXRoLCBmdW5jdGlvbihvcHRpb25zKSB7CgogICAgICAgICAgICAgICAgICAgIGlmIChyZWZlcmVuY2VQYXJ0cy5pZCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXNvbHV0aW9uID0gQWxwYWNhLnJlc29sdmVSZWZlcmVuY2Uoc2NoZW1hLCBvcHRpb25zLCByZWZlcmVuY2VQYXJ0cy5pZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXNvbHV0aW9uKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2hlbWEgPSByZXNvbHV0aW9uLnNjaGVtYTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMgPSByZXNvbHV0aW9uLm9wdGlvbnM7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHNjaGVtYSwgb3B0aW9ucyk7CgogICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soc2NoZW1hKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH07CgogICAgQWxwYWNhLkRFRkFVTFRfRVJST1JfQ0FMTEJBQ0sgPSBmdW5jdGlvbihlcnJvcikKICAgIHsKICAgICAgICBpZiAoZXJyb3IgJiYgZXJyb3IubWVzc2FnZSkKICAgICAgICB7CiAgICAgICAgICAgIC8vIGxvZyB0byBkZWJ1ZwogICAgICAgICAgICBBbHBhY2EubG9nRXJyb3IoZXJyb3IubWVzc2FnZSk7CgogICAgICAgICAgICAvLyBlcnJvciBvdXQKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbHBhY2EgY2F1Z2h0IGFuIGVycm9yIHdpdGggdGhlIGRlZmF1bHQgZXJyb3IgaGFuZGxlcjogIiArIGVycm9yLm1lc3NhZ2UpOwoKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogRGVmYXVsdCBlcnJvciBjYWxsYmFjayBoYW5kbGVyIGZvciBBbHBhY2EuCiAgICAgKgogICAgICogVGhpcyBlcnJvciBoYW5kbGVyIHdpbGwgYmUgdXNlZCBpZiBhbiAiZXJyb3IiIGFyZ3VtZW50IGlzbid0IHBhc3NlZCBpbiB0byB0aGUgY29uc3RydWN0b3IgZm9yIGFuIEFscGFjYSBmaWVsZC4KICAgICAqCiAgICAgKiBAcGFyYW0gZXJyb3IKICAgICAqLwogICAgQWxwYWNhLmRlZmF1bHRFcnJvckNhbGxiYWNrID0gQWxwYWNhLkRFRkFVTFRfRVJST1JfQ0FMTEJBQ0s7CgogICAgLyoqCiAgICAgKiBVdGlsaXR5IG1ldGhvZCB0aGF0IHRocm93cyBhIGdlbmVyYWwgZXJyb3IgYW5kIGRpc3BhdGNoZXMgdG8gdGhlIGRlZmF1bHQgZXJyb3IgaGFuZGxlci4KICAgICAqCiAgICAgKiBAcGFyYW0gbWVzc2FnZQogICAgICovCiAgICBBbHBhY2EudGhyb3dEZWZhdWx0RXJyb3IgPSBmdW5jdGlvbihtZXNzYWdlKQogICAgewogICAgICAgIGlmIChtZXNzYWdlICYmIEFscGFjYS5pc09iamVjdChtZXNzYWdlKSkKICAgICAgICB7CiAgICAgICAgICAgIG1lc3NhZ2UgPSBKU09OLnN0cmluZ2lmeShtZXNzYWdlKTsKICAgICAgICB9CgogICAgICAgIHZhciBlcnIgPSB7CiAgICAgICAgICAgICJtZXNzYWdlIjogbWVzc2FnZQogICAgICAgIH07CgogICAgICAgIEFscGFjYS5kZWZhdWx0RXJyb3JDYWxsYmFjayhlcnIpOwogICAgfTsKCiAgICAvKioKICAgICAqIFV0aWxpdHkgbWV0aG9kIHRoYXQgdGhyb3dzIGFuIGVycm9yIGJhY2sgdG8gdGhlIGdpdmVuIGNhbGxiYWNrIGhhbmRsZXIuCiAgICAgKgogICAgICogQHBhcmFtIG1lc3NhZ2UKICAgICAqIEBwYXJhbSBlcnJvckNhbGxiYWNrCiAgICAgKi8KICAgIEFscGFjYS50aHJvd0Vycm9yV2l0aENhbGxiYWNrID0gZnVuY3Rpb24obWVzc2FnZSwgZXJyb3JDYWxsYmFjaykKICAgIHsKICAgICAgICBpZiAobWVzc2FnZSAmJiBBbHBhY2EuaXNPYmplY3QobWVzc2FnZSkpCiAgICAgICAgewogICAgICAgICAgICBtZXNzYWdlID0gSlNPTi5zdHJpbmdpZnkobWVzc2FnZSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgZXJyID0gewogICAgICAgICAgICAibWVzc2FnZSI6IG1lc3NhZ2UKICAgICAgICB9OwoKICAgICAgICBpZiAoZXJyb3JDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIGVycm9yQ2FsbGJhY2soZXJyKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgQWxwYWNhLmRlZmF1bHRFcnJvckNhbGxiYWNrKGVycik7CiAgICAgICAgfQogICAgfTsKCgogICAgLyoqCiAgICAgKiBHaXZlbiBhIGJhc2UgZmllbGQsIHdhbGtzIHRoZSBzY2hlbWEsIG9wdGlvbnMgYW5kIGRhdGEgZm9yd2FyZCB1bnRpbCBpdAogICAgICogZGlzY292ZXJzIHRoZSBnaXZlbiByZWZlcmVuY2UuCiAgICAgKgogICAgICogQHBhcmFtIHNjaGVtYQogICAgICogQHBhcmFtIG9wdGlvbnMKICAgICAqIEBwYXJhbSByZWZlcmVuY2VJZAogICAgICovCiAgICBBbHBhY2EucmVzb2x2ZVJlZmVyZW5jZSA9IGZ1bmN0aW9uKHNjaGVtYSwgb3B0aW9ucywgcmVmZXJlbmNlSWQpCiAgICB7CiAgICAgICAgaWYgKHNjaGVtYS5pZCA9PSByZWZlcmVuY2VJZCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgICAgICAgaWYgKHNjaGVtYSkgewogICAgICAgICAgICAgICAgcmVzdWx0LnNjaGVtYSA9IHNjaGVtYTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9ucykgewogICAgICAgICAgICAgICAgcmVzdWx0Lm9wdGlvbnMgPSBvcHRpb25zOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAoc2NoZW1hICYmIHNjaGVtYS5wcm9wZXJ0aWVzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBwcm9wZXJ0eUlkIGluIHNjaGVtYS5wcm9wZXJ0aWVzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBzdWJTY2hlbWEgPSBzY2hlbWEucHJvcGVydGllc1twcm9wZXJ0eUlkXTsKICAgICAgICAgICAgICAgICAgICB2YXIgc3ViT3B0aW9ucyA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5maWVsZHMgJiYgb3B0aW9ucy5maWVsZHNbcHJvcGVydHlJZF0pCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBzdWJPcHRpb25zID0gb3B0aW9ucy5maWVsZHNbcHJvcGVydHlJZF07CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgeCA9IEFscGFjYS5yZXNvbHZlUmVmZXJlbmNlKHN1YlNjaGVtYSwgc3ViT3B0aW9ucywgcmVmZXJlbmNlSWQpOwogICAgICAgICAgICAgICAgICAgIGlmICh4KQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH07CgogICAgJC5hbHBhY2EgPSB3aW5kb3cuQWxwYWNhID0gQWxwYWNhOwoKICAgIC8qKgogICAgICogalF1ZXJ5IGZyaWVuZGx5IG1ldGhvZCBmb3IgYmluZGluZyBhIGZpZWxkIHRvIGEgRE9NIGVsZW1lbnQuCiAgICAgKiBAaWdub3JlCiAgICAgKi8KICAgICQuZm4uYWxwYWNhID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBBbHBhY2EubWFrZUFycmF5KGFyZ3VtZW50cyk7CgogICAgICAgIC8vIGFwcGVuZCB0aGlzIGludG8gdGhlIGZyb250IG9mIGFyZ3MKICAgICAgICB2YXIgbmV3QXJncyA9IFtdLmNvbmNhdCh0aGlzLCBhcmdzKTsKCiAgICAgICAgLy8gaGFuZCBiYWNrIHRoZSBmaWVsZCBpbnN0YW5jZQogICAgICAgIHJldHVybiBBbHBhY2EuYXBwbHkodGhpcywgbmV3QXJncyk7CiAgICB9OwoKICAgIC8qKgogICAgICogQGlnbm9yZQogICAgICogQHBhcmFtIG5vY2xvbmluZwogICAgICovCiAgICAkLmZuLm91dGVySFRNTCA9IGZ1bmN0aW9uKG5vY2xvbmluZykgewogICAgICAgIGlmIChub2Nsb25pbmcpIHsKICAgICAgICAgICAgcmV0dXJuICQoIjxkaXY+PC9kaXY+IikuYXBwZW5kKHRoaXMpLmh0bWwoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gJCgiPGRpdj48L2Rpdj4iKS5hcHBlbmQodGhpcy5jbG9uZSgpKS5odG1sKCk7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBpZ25vcmUKICAgICAqIEBwYXJhbSB0bwogICAgICovCiAgICAkLmZuLnN3YXBXaXRoID0gZnVuY3Rpb24odG8pIHsKICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgY29weV90byA9ICQodG8pLmNsb25lKCk7CiAgICAgICAgICAgIHZhciBjb3B5X2Zyb20gPSAkKHRoaXMpLmNsb25lKCk7CiAgICAgICAgICAgICQodG8pLnJlcGxhY2VXaXRoKGNvcHlfZnJvbSk7CiAgICAgICAgICAgICQodGhpcykucmVwbGFjZVdpdGgoY29weV90byk7CiAgICAgICAgfSk7CiAgICB9OwoKICAgICQuZm4uYXR0clByb3AgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgIHJldHVybiBBbHBhY2EuYXR0clByb3AoJCh0aGlzKSwgbmFtZSwgdmFsdWUpOwogICAgfTsKCiAgICAvKioKICAgICAqIFdoZW4gZG9tIGVsZW1lbnRzIGFyZSByZW1vdmVkLCB3ZSBmaXJlIHRoZSBzcGVjaWFsICJkZXN0cm95ZWQiIGV2ZW50IHRvIGFsbG93IGZvciBsYXRlIGNsZWFudXAgb2YgYW55IEFscGFjYSBjb2RlCiAgICAgKiB0aGF0IG1pZ2h0IGJlIGluLW1lbW9yeSBhbmQgbGlua2VkIHRvIHRoZSBkb20gZWxlbWVudC4KICAgICAqCiAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICovCiAgICAkLmV2ZW50LnNwZWNpYWwuZGVzdHJveWVkID0gewogICAgICAgIHJlbW92ZTogZnVuY3Rpb24obykgewogICAgICAgICAgICBpZiAoby5oYW5kbGVyKSB7CiAgICAgICAgICAgICAgICBvLmhhbmRsZXIoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgoKICAgIEFscGFjYS5Db3VudGVyc01hcCA9IHt9OwogICAgQWxwYWNhLkNvdW50ZXJzID0gZnVuY3Rpb24obmFtZSkKICAgIHsKICAgICAgICBpZiAoQWxwYWNhLkNvdW50ZXJzW25hbWVdKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5Db3VudGVyc1tuYW1lXTsKICAgICAgICB9CgogICAgICAgIC8vIGNyZWF0ZSBuZXcgY291bnRlcnMKCiAgICAgICAgdmFyIHR5cGVzID0ge307CiAgICAgICAgdmFyIGFsbCA9IHsKICAgICAgICAgICAgY291bnQ6IDAsCiAgICAgICAgICAgIHRvdGFsOiAwLAogICAgICAgICAgICBhdmc6IDAsCiAgICAgICAgICAgIHRvdWNoZXM6IDAKICAgICAgICB9OwoKICAgICAgICB2YXIgY291bnRlcnMgPSB7CgogICAgICAgICAgICBpbmNyZW1lbnQ6IGZ1bmN0aW9uKHR5cGUsIGFtb3VudCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCF0eXBlc1t0eXBlXSkgewogICAgICAgICAgICAgICAgICAgIHR5cGVzW3R5cGVdID0gewogICAgICAgICAgICAgICAgICAgICAgICBjb3VudDogMCwKICAgICAgICAgICAgICAgICAgICAgICAgdG90YWw6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIGF2ZzogMCwKICAgICAgICAgICAgICAgICAgICAgICAgdG91Y2hlczogMAogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdHlwZXNbdHlwZV0uY291bnQrKzsKICAgICAgICAgICAgICAgIHR5cGVzW3R5cGVdLnRvdGFsICs9IGFtb3VudDsKICAgICAgICAgICAgICAgIHR5cGVzW3R5cGVdLmF2ZyA9IHR5cGVzW3R5cGVdLnRvdGFsIC8gdHlwZXNbdHlwZV0uY291bnQ7CiAgICAgICAgICAgICAgICB0eXBlc1t0eXBlXS50b3VjaGVzKys7CgogICAgICAgICAgICAgICAgYWxsLmNvdW50Kys7CiAgICAgICAgICAgICAgICBhbGwudG90YWwgKz0gYW1vdW50OwogICAgICAgICAgICAgICAgYWxsLmF2ZyA9IGFsbC50b3RhbCAvIGFsbC5jb3VudDsKICAgICAgICAgICAgICAgIGFsbC50b3VjaGVzKys7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZWFkOiBmdW5jdGlvbih0eXBlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZXNbdHlwZV07CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBlYWNoOiBmdW5jdGlvbihmKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciB0eXBlIGluIHR5cGVzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGYodHlwZSwgdHlwZXNbdHlwZV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgYWxsOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhbGw7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBBbHBhY2EuQ291bnRlcnNbbmFtZV0gPSBjb3VudGVyczsKCiAgICAgICAgcmV0dXJuIGNvdW50ZXJzOwogICAgfTsKCiAgICBBbHBhY2EuY29sbGVjdFRpbWluZyA9IGZhbHNlOwoKICAgIEFscGFjYS5wYXRoUGFydHMgPSBmdW5jdGlvbihyZXNvdXJjZSkKICAgIHsKICAgICAgICBpZiAodHlwZW9mKHJlc291cmNlKSAhPSAic3RyaW5nIikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiByZXNvdXJjZTsKICAgICAgICB9CgogICAgICAgIC8vIGNvbnZlcnQgc3RyaW5nIHRvIG9iamVjdAogICAgICAgIHZhciByZXNvdXJjZVBhdGggPSByZXNvdXJjZTsKICAgICAgICB2YXIgcmVzb3VyY2VJZCA9IG51bGw7CiAgICAgICAgdmFyIGkgPSByZXNvdXJjZVBhdGguaW5kZXhPZigiIyIpOwogICAgICAgIGlmIChpID4gLTEpCiAgICAgICAgewogICAgICAgICAgICByZXNvdXJjZUlkID0gcmVzb3VyY2VQYXRoLnN1YnN0cmluZyhpICsgMSk7CiAgICAgICAgICAgIHJlc291cmNlUGF0aCA9IHJlc291cmNlUGF0aC5zdWJzdHJpbmcoMCwgaSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoQWxwYWNhLmVuZHNXaXRoKHJlc291cmNlUGF0aCwgIi8iKSkgewogICAgICAgICAgICByZXNvdXJjZVBhdGggPSByZXNvdXJjZVBhdGguc3Vic3RyaW5nKDAsIHJlc291cmNlUGF0aC5sZW5ndGggLSAxKTsKICAgICAgICB9CgogICAgICAgIHZhciBwYXJ0cyA9IHt9OwogICAgICAgIHBhcnRzLnBhdGggPSByZXNvdXJjZVBhdGg7CgogICAgICAgIGlmIChyZXNvdXJjZUlkKQogICAgICAgIHsKICAgICAgICAgICAgcGFydHMuaWQgPSByZXNvdXJjZUlkOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHBhcnRzOwogICAgfTsKCiAgICAvKioKICAgICAqIFJlc29sdmVzIGEgZmllbGQgYnkgaXRzIHByb3BlcnR5IGlkLgogICAgICoKICAgICAqIEBwYXJhbSBjb250YWluZXJGaWVsZAogICAgICogQHBhcmFtIHByb3BlcnR5SWQKICAgICAqIEByZXR1cm5zIHtudWxsfQogICAgICovCiAgICBBbHBhY2EucmVzb2x2ZUZpZWxkID0gZnVuY3Rpb24oY29udGFpbmVyRmllbGQsIHByb3BlcnR5SWRPclJlZmVyZW5jZUlkKQogICAgewogICAgICAgIHZhciByZXNvbHZlZEZpZWxkID0gbnVsbDsKCiAgICAgICAgaWYgKHR5cGVvZihwcm9wZXJ0eUlkT3JSZWZlcmVuY2VJZCkgPT0gInN0cmluZyIpCiAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcGVydHlJZE9yUmVmZXJlbmNlSWQuaW5kZXhPZigiIy8iKSA9PSAwICYmIHByb3BlcnR5SWQubGVuZ3RoID4gMikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gVE9ETzogcGF0aCBiYXNlZCBsb29rdXA/CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAocHJvcGVydHlJZE9yUmVmZXJlbmNlSWQgPT0gIiMiIHx8IHByb3BlcnR5SWRPclJlZmVyZW5jZUlkID09ICIjLyIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJlc29sdmVkRmllbGQgPSBjb250YWluZXJGaWVsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChwcm9wZXJ0eUlkT3JSZWZlcmVuY2VJZC5pbmRleE9mKCIjIikgPT0gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gcmVmZXJlbmNlIGlkIGxvb2t1cAoKICAgICAgICAgICAgICAgIC8vIGZpbmQgdGhlIHRvcCBmaWVsZAogICAgICAgICAgICAgICAgdmFyIHRvcEZpZWxkID0gY29udGFpbmVyRmllbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAodG9wRmllbGQucGFyZW50KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRvcEZpZWxkID0gdG9wRmllbGQucGFyZW50OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciByZWZlcmVuY2VJZCA9IHByb3BlcnR5SWRPclJlZmVyZW5jZUlkLnN1YnN0cmluZygxKTsKCiAgICAgICAgICAgICAgICByZXNvbHZlZEZpZWxkID0gQWxwYWNhLnJlc29sdmVGaWVsZEJ5UmVmZXJlbmNlKHRvcEZpZWxkLCByZWZlcmVuY2VJZCk7CgogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gcHJvcGVydHkgbG9va3VwCiAgICAgICAgICAgICAgICByZXNvbHZlZEZpZWxkID0gY29udGFpbmVyRmllbGQuY2hpbGRyZW5CeVByb3BlcnR5SWRbcHJvcGVydHlJZE9yUmVmZXJlbmNlSWRdOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzb2x2ZWRGaWVsZDsKICAgIH07CgogICAgLyoqCiAgICAgKiBSZXNvbHZlcyBhIGZpZWxkIGJhc2VkIG9uIGl0cyAicmVmZXJlbmNlIGlkIiByZWxhdGl2ZSB0byBhIHRvcCBsZXZlbCBmaWVsZC4gIFRoaXMgd2Fsa3MgZG93biB0aGUgZmllbGQgdHJlZSBhbmQKICAgICAqIGxvb2tzIGZvciBtYXRjaGluZyBzY2hlbWEuaWQgcmVmZXJlbmNlcyB0byBmaW5kIHRoZSBtYXRjaGluZyBmaWVsZC4KICAgICAqCiAgICAgKiBAcGFyYW0gZmllbGQKICAgICAqIEBwYXJhbSByZWZlcmVuY2VJZAogICAgICovCiAgICBBbHBhY2EucmVzb2x2ZUZpZWxkQnlSZWZlcmVuY2UgPSBmdW5jdGlvbihmaWVsZCwgcmVmZXJlbmNlSWQpCiAgICB7CiAgICAgICAgaWYgKGZpZWxkLnNjaGVtYSAmJiBmaWVsZC5zY2hlbWEuaWQgPT0gcmVmZXJlbmNlSWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmllbGQ7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmIChmaWVsZC5jaGlsZHJlbiAmJiBmaWVsZC5jaGlsZHJlbi5sZW5ndGggPiAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZpZWxkLmNoaWxkcmVuLmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpZWxkLmNoaWxkcmVuW2ldOwoKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWQgPSBBbHBhY2EucmVzb2x2ZUZpZWxkQnlSZWZlcmVuY2UoY2hpbGQsIHJlZmVyZW5jZUlkKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmVzb2x2ZWQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH07CgogICAgLyoqCiAgICAgKiBEZXRlcm1pbmVzIHdoZXRoZXIgYW55IG9mIHRoZSBlbGVtZW50cyBvZiB0aGUgZmlyc3QgYXJndW1lbnQgYXJlIGVxdWFsIHRvIHRoZSBlbGVtZW50cyBvZiB0aGUgc2Vjb25kIGFyZ3VtZW50LgogICAgICoKICAgICAqIEBwYXJhbSBmaXJzdCBlaXRoZXIgYSBzY2FsYXIgdmFsdWUgb3IgYSBjb250YWluZXIgKG9iamVjdCBvciBhcnJheSkgb2YgdmFsdWVzCiAgICAgKiBAcGFyYW0gc2Vjb25kIGVpdGhlciBhIHNjYWxhciB2YWx1ZSBvciBhIGNvbnRhaW5lciAob2JqZWN0IG9yIGFycmF5KSBvZiB2YWx1ZXMKICAgICAqIEByZXR1cm5zIHdoZXRoZXIgYXQgbGVhc3Qgb25lIG1hdGNoIGlzIGZvdW5kCiAgICAgKi8KICAgIEFscGFjYS5hbnlFcXVhbGl0eSA9IGZ1bmN0aW9uKGZpcnN0LCBzZWNvbmQpCiAgICB7CiAgICAgICAgLy8gY29weSB2YWx1ZXMgZnJvbSBmaXJzdCBpbnRvIGEgdmFsdWVzIGxvb2t1cCBtYXAKICAgICAgICB2YXIgdmFsdWVzID0ge307CiAgICAgICAgaWYgKHR5cGVvZihmaXJzdCkgPT0gIm9iamVjdCIgfHwgdHlwZW9mKGZpcnN0KSA9PSAiYXJyYXkiKQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgayBpbiBmaXJzdCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFsdWVzW2ZpcnN0W2tdXSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdmFsdWVzW2ZpcnN0XSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB2YXIgcmVzdWx0ID0gZmFsc2U7CgogICAgICAgIC8vIGNoZWNrIHZhbHVlcyBmcm9tIHNlY29uZCBhZ2FpbnN0IHRoZSBsb29rdXAgbWFwCiAgICAgICAgaWYgKHR5cGVvZihzZWNvbmQpID09ICJvYmplY3QiIHx8IHR5cGVvZihzZWNvbmQpID09ICJhcnJheSIpCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciBrIGluIHNlY29uZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHYgPSBzZWNvbmRba107CgogICAgICAgICAgICAgICAgaWYgKHZhbHVlc1t2XSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJlc3VsdCA9IHZhbHVlc1tzZWNvbmRdOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CgogICAgQWxwYWNhLnNlcmllcyA9IGZ1bmN0aW9uKGZ1bmNzLCBjYWxsYmFjaykKICAgIHsKICAgICAgICBhc3luYy5zZXJpZXMoZnVuY3MsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgIH0pOwogICAgfTsKCiAgICBBbHBhY2EucGFyYWxsZWwgPSBmdW5jdGlvbihmdW5jcywgY2FsbGJhY2spCiAgICB7CiAgICAgICAgYXN5bmMucGFyYWxsZWwoZnVuY3MsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgIH0pOwogICAgfTsKCiAgICBBbHBhY2EubmV4dFRpY2sgPSBmdW5jdGlvbihmKQogICAgewogICAgICAgIGFzeW5jLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmKCk7CiAgICAgICAgfSk7CiAgICB9OwoKICAgIC8qKgogICAgICogQ29tcGlsZXMgdGhlIHZhbGlkYXRpb24gY29udGV4dCBmb3IgdGhlIGNoYWluIG9mIGZpZWxkcyBmcm9tIHRoZSB0b3AtbW9zdCBkb3duIHRvIHRoZSBnaXZlbiBmaWVsZC4KICAgICAqIEVhY2ggdmFsaWRhdGlvbiBjb250ZXh0IGVudHJ5IGlzIGEgZmllbGQgaW4gdGhlIGNoYWluIHdoaWNoIGRlc2NyaWJlcyB0aGUgZm9sbG93aW5nOgogICAgICoKICAgICAqICAgIHsKICAgICAqICAgICAgICJmaWVsZCI6IHRoZSBmaWVsZCBpbnN0YW5jZSwKICAgICAqICAgICAgICJiZWZvcmUiOiB0aGUgYmVmb3JlIHZhbHVlIChib29sZWFuKQogICAgICogICAgICAgImFmdGVyIjogdGhlIGFmdGVyIHZhbHVlIChib29sZWFuKQogICAgICogICAgICAgInZhbGlkYXRlZCI6IChvcHRpb25hbCkgaWYgdGhlIGZpZWxkIHZhbGlkYXRlZCAoc3dpdGNoZXMgc3RhdGUgZnJvbSBpbnZhbGlkIHRvIHZhbGlkKQogICAgICogICAgICAgImludmFsaWRhdGVkIjogKG9wdGlvbmFsKSBpZiB0aGUgZmllbGQgaW52YWxpZGF0ZWQgKHN3aXRjaGVzIHN0YXRlIGZyb20gdmFsaWQgdG8gaW52YWxpZCkKICAgICAqICAgIH0KICAgICAqCiAgICAgKiBUaGlzIGhhbmRzIGJhY2sgYW4gYXJyYXkgb2YgZW50cmllcyB3aXRoIHRoZSBjaGlsZCBmaWVsZCBmaXJzdCBhbmQgY29udGludWluZyB1cCB0aGUgcGFyZW50IGNoYWluLgogICAgICogVGhlIGxhc3QgZW50cnkgaW4gdGhlIGFycmF5IGlzIHRoZSB0b3AgbW9zdCBwYXJlbnQgZmllbGQuCiAgICAgKgogICAgICogQHBhcmFtIGZpZWxkCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9CiAgICAgKi8KICAgIEFscGFjYS5jb21waWxlVmFsaWRhdGlvbkNvbnRleHQgPSBmdW5jdGlvbihmaWVsZCkKICAgIHsKICAgICAgICAvLyB3YWxrIHVwIHRoZSBwYXJlbnQgdHJlZSB1bnRpbCB3ZSBmaW5kIHRoZSB0b3AtbW9zdCBjb250cm9sCiAgICAgICAgLy8gdGhpcyBzZXJ2ZXMgYXMgb3VyIHN0YXJ0aW5nIHBvaW50IGZvciBkb3dud2FyZCB2YWxpZGF0aW9uCiAgICAgICAgdmFyIGNoYWluID0gW107CiAgICAgICAgdmFyIHBhcmVudCA9IGZpZWxkOwogICAgICAgIGRvCiAgICAgICAgewogICAgICAgICAgICBpZiAoIXBhcmVudC5pc1ZhbGlkYXRpb25QYXJ0aWNpcGFudCgpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBwYXJlbnQgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAocGFyZW50KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGFpbi5wdXNoKHBhcmVudCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChwYXJlbnQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgd2hpbGUgKHBhcmVudCk7CgogICAgICAgIC8vIHJldmVyc2Ugc28gdG9wIG1vc3QgcGFyZW50IGlzIGZpcnN0CiAgICAgICAgY2hhaW4ucmV2ZXJzZSgpOwoKICAgICAgICAvLyBjb21waWxhdGlvbiBjb250ZXh0CiAgICAgICAgdmFyIGNvbnRleHQgPSBbXTsKCiAgICAgICAgLy8gaW50ZXJuYWwgbWV0aG9kIHRoYXQgc2V0cyB2YWxpZGF0aW9uIGZvciBhIHNpbmdsZSBmaWVsZAogICAgICAgIHZhciBmID0gZnVuY3Rpb24oY2hhaW4sIGNvbnRleHQpCiAgICAgICAgewogICAgICAgICAgICBpZiAoIWNoYWluIHx8IGNoYWluLmxlbmd0aCA9PSAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBjdXJyZW50ID0gY2hhaW5bMF07CgogICAgICAgICAgICB2YXIgZW50cnkgPSB7fTsKICAgICAgICAgICAgZW50cnkuaWQgPSBjdXJyZW50LmdldElkKCk7CiAgICAgICAgICAgIGVudHJ5LmZpZWxkID0gY3VycmVudDsKICAgICAgICAgICAgZW50cnkucGF0aCA9IGN1cnJlbnQucGF0aDsKCiAgICAgICAgICAgIC8vIEJFRk9SRSBmaWVsZCB2YWxpZGF0aW9uIHN0YXR1cwogICAgICAgICAgICB2YXIgYmVmb3JlU3RhdHVzID0gY3VycmVudC5pc1ZhbGlkKCk7CiAgICAgICAgICAgIGlmIChjdXJyZW50LmlzQ29udGFpbmVyKCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGJlZm9yZVN0YXR1cyA9IGN1cnJlbnQuaXNWYWxpZCh0cnVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZW50cnkuYmVmb3JlID0gYmVmb3JlU3RhdHVzOwoKICAgICAgICAgICAgLy8gc3RlcCBkb3duIGludG8gY2hhaW4KICAgICAgICAgICAgaWYgKGNoYWluLmxlbmd0aCA+IDEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIGNvcHkgYXJyYXkKICAgICAgICAgICAgICAgIHZhciBjaGlsZENoYWluID0gY2hhaW4uc2xpY2UoMCk7CiAgICAgICAgICAgICAgICBjaGlsZENoYWluLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICBmKGNoaWxkQ2hhaW4sIGNvbnRleHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgcHJldmlvdXNseVZhbGlkYXRlZCA9IGN1cnJlbnQuX3ByZXZpb3VzbHlWYWxpZGF0ZWQ7CgogICAgICAgICAgICAvLyBub3cgcnVuIHRoZSB2YWxpZGF0aW9uIGZvciBqdXN0IHRoaXMgb25lIGZpZWxkCiAgICAgICAgICAgIGN1cnJlbnQudmFsaWRhdGUoKTsKCiAgICAgICAgICAgIC8vIGFwcGx5IGN1c3RvbSB2YWxpZGF0aW9uIChpZiBleGlzdHMpIGZvciBqdXN0IHRoaXMgb25lIGZpZWxkCiAgICAgICAgICAgIGN1cnJlbnQuX3ZhbGlkYXRlQ3VzdG9tVmFsaWRhdG9yKGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgIC8vIEFGVEVSIGZpZWxkIHZhbGlkYXRpb24gc3RhdGUKICAgICAgICAgICAgICAgIHZhciBhZnRlclN0YXR1cyA9IGN1cnJlbnQuaXNWYWxpZCgpOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQuaXNDb250YWluZXIoKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBhZnRlclN0YXR1cyA9IGN1cnJlbnQuaXNWYWxpZCh0cnVlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBlbnRyeS5hZnRlciA9IGFmdGVyU3RhdHVzOwoKICAgICAgICAgICAgICAgIC8vIGlmIHRoaXMgZmllbGQncyB2YWxpZGF0aW9uIHN0YXR1cyBmbGlwcGVkLCBmaXJlIHRyaWdnZXJzCiAgICAgICAgICAgICAgICBlbnRyeS52YWxpZGF0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGVudHJ5LmludmFsaWRhdGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAoIWJlZm9yZVN0YXR1cyAmJiBhZnRlclN0YXR1cykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBlbnRyeS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoYmVmb3JlU3RhdHVzICYmICFhZnRlclN0YXR1cykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBlbnRyeS5pbnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBzcGVjaWFsIGNhc2UgZm9yIGZpZWxkcyB0aGF0IGhhdmUgbm90IHlldCBiZWVuIHZhbGlkYXRlZAogICAgICAgICAgICAgICAgZWxzZSBpZiAoIXByZXZpb3VzbHlWYWxpZGF0ZWQgJiYgIWFmdGVyU3RhdHVzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGVudHJ5LmludmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBlbnRyeS5jb250YWluZXIgPSBjdXJyZW50LmlzQ29udGFpbmVyKCk7OwogICAgICAgICAgICAgICAgZW50cnkudmFsaWQgPSBlbnRyeS5hZnRlcjsKCiAgICAgICAgICAgICAgICBjb250ZXh0LnB1c2goZW50cnkpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBmKGNoYWluLCBjb250ZXh0KTsKCiAgICAgICAgcmV0dXJuIGNvbnRleHQ7CiAgICB9OwoKICAgIEFscGFjYS51cGRhdGVWYWxpZGF0aW9uU3RhdGVGb3JDb250ZXh0ID0gZnVuY3Rpb24oY29udGV4dCkKICAgIHsKICAgICAgICAvLyB3YWxrIHRocm91Z2ggZWFjaCBhbmQgZmxpcCBhbnkgRE9NIFVJIGJhc2VkIG9uIGVudHJ5IHN0YXRlCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb250ZXh0Lmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGVudHJ5ID0gY29udGV4dFtpXTsKICAgICAgICAgICAgdmFyIGZpZWxkID0gZW50cnkuZmllbGQ7CgogICAgICAgICAgICAvLyBjbGVhciBvdXQgcHJldmlvdXMgdmFsaWRhdGlvbiBVSSBtYXJrZXJzCiAgICAgICAgICAgIGZpZWxkLmdldFN0eWxlSW5qZWN0aW9uKCJyZW1vdmVFcnJvciIsIGZpZWxkLmdldEVsKCkpOwogICAgICAgICAgICBmaWVsZC5nZXRFbCgpLnJlbW92ZUNsYXNzKCJhbHBhY2EtZmllbGQtaW52YWxpZCBhbHBhY2EtZmllbGQtaW52YWxpZC1oaWRkZW4gYWxwYWNhLWZpZWxkLXZhbGlkIik7CgogICAgICAgICAgICB2YXIgc2hvd01lc3NhZ2VzID0gZmFsc2U7CgogICAgICAgICAgICAvLyB2YWxpZD8KICAgICAgICAgICAgaWYgKGVudHJ5LnZhbGlkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmaWVsZC5nZXRFbCgpLmFkZENsYXNzKCJhbHBhY2EtZmllbGQtdmFsaWQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIHdlIGRvbid0IG1hcmt1cCBpbnZhbGlkYXRpb24gc3RhdGUgZm9yIHJlYWRvbmx5IGZpZWxkcwogICAgICAgICAgICAgICAgaWYgKCFmaWVsZC5vcHRpb25zLnJlYWRvbmx5KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICghZmllbGQuaGlkZUluaXRWYWxpZGF0aW9uRXJyb3IpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBmaWVsZC5nZXRTdHlsZUluamVjdGlvbigiZXJyb3IiLCBmaWVsZC5nZXRFbCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGQuZ2V0RWwoKS5hZGRDbGFzcygiYWxwYWNhLWZpZWxkLWludmFsaWQiKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHNob3dNZXNzYWdlcyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkLmdldEVsKCkuYWRkQ2xhc3MoImFscGFjYS1maWVsZC1pbnZhbGlkLWhpZGRlbiIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIGZpZWxkIGlzIGludmFsaWQgYW5kIGlzIGFsc28gcmVhZC1vbmx5LCBzbyB3ZSdyZSBub3Qgc3VwcG9zZWQgdG8gaW5mb3JtIHRoZSBlbmQtdXNlcgogICAgICAgICAgICAgICAgICAgIC8vIHdpdGhpbiB0aGUgVUkgKHNpbmNlIHRoZXJlIGlzIG5vdGhpbmcgd2UgY2FuIGRvIGFib3V0IGl0KQogICAgICAgICAgICAgICAgICAgIC8vIGhlcmUsIHdlIGxvZyBhIG1lc3NhZ2UgdG8gZGVidWcgdG8gaW5mb3JtIHRoZSBkZXZlbG9wZXIKICAgICAgICAgICAgICAgICAgICBBbHBhY2EubG9nV2FybigiVGhlIGZpZWxkIChpZD0iICsgZmllbGQuZ2V0SWQoKSArICIsIHRpdGxlPSIgKyBmaWVsZC5nZXRUaXRsZSgpICsgIiwgcGF0aD0iICsgZmllbGQucGF0aCArICIpIGlzIGludmFsaWQgYW5kIGFsc28gcmVhZC1vbmx5Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFRSSUdHRVJTCiAgICAgICAgICAgIGlmIChlbnRyeS52YWxpZGF0ZWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIEFscGFjYS5sYXRlcigyNSwgdGhpcywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgZmllbGQudHJpZ2dlcigidmFsaWRhdGVkIik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChlbnRyeS5pbnZhbGlkYXRlZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgQWxwYWNhLmxhdGVyKDI1LCB0aGlzLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBmaWVsZC50cmlnZ2VyKCJpbnZhbGlkYXRlZCIpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFsbG93IGZvciB0aGUgbWVzc2FnZSB0byBjaGFuZ2UKICAgICAgICAgICAgaWYgKGZpZWxkLm9wdGlvbnMuc2hvd01lc3NhZ2VzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWZpZWxkLmluaXRpYWxpemluZykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBkb24ndCBtYXJrdXAgaW52YWxpZGF0aW9uIHN0YXRlIGZvciByZWFkb25seSBmaWVsZHMKICAgICAgICAgICAgICAgICAgICBpZiAoIWZpZWxkLm9wdGlvbnMucmVhZG9ubHkpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBtZXNzYWdlcwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbWVzc2FnZXMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgbWVzc2FnZUlkIGluIGZpZWxkLnZhbGlkYXRpb24pCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZmllbGQudmFsaWRhdGlvblttZXNzYWdlSWRdWyJzdGF0dXMiXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlcy5wdXNoKGZpZWxkLnZhbGlkYXRpb25bbWVzc2FnZUlkXVsibWVzc2FnZSJdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGQuZGlzcGxheU1lc3NhZ2UobWVzc2FnZXMsIGZpZWxkLnZhbGlkKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChzaG93TWVzc2FnZXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZpZWxkLnNob3dIaWRkZW5NZXNzYWdlcygpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIFJ1bnMgdGhlIGdpdmVuIGZ1bmN0aW9uIG92ZXIgdGhlIGZpZWxkIGFuZCBhbGwgb2YgaXRzIGNoaWxkcmVuIHJlY3Vyc2l2ZWx5LgogICAgICoKICAgICAqIEBwYXJhbSBmaWVsZAogICAgICogQHBhcmFtIGZuCiAgICAgKi8KICAgIEFscGFjYS5maWVsZEFwcGx5Q2hpbGRyZW4gPSBmdW5jdGlvbihmaWVsZCwgZm4pCiAgICB7CiAgICAgICAgdmFyIGYgPSBmdW5jdGlvbihmaWVsZCwgZm4pCiAgICAgICAgewogICAgICAgICAgICAvLyBpZiB0aGUgZmllbGQgaGFzIGNoaWxkcmVuLCBnbyBkZXB0aCBmaXJzdAogICAgICAgICAgICBpZiAoZmllbGQuY2hpbGRyZW4gJiYgZmllbGQuY2hpbGRyZW4ubGVuZ3RoID4gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmaWVsZC5jaGlsZHJlbi5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBmbihmaWVsZC5jaGlsZHJlbltpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBmKGZpZWxkLCBmbik7CiAgICB9OwoKCgoKCgoKCgoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vCiAgICAvLyBBU1lOQwogICAgLy8KICAgIC8vIEhlcmUgd2UgcHJvdmlkZSBhIHJlZHVjZWQgdmVyc2lvbiBvZiB0aGUgd29uZGVyZnVsIGFzeW5jIGxpYnJhcnkuICBUaGlzIGlzIGVudGlyZWx5IGlubGluZSBhbmQKICAgIC8vIHdpbGwgaGF2ZSBubyBiZWFyaW5nIG9uIGFueSBleHRlcm5hbCBkZXBlbmRlbmNpZXMgb24gYXN5bmMuCiAgICAvLwogICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2Nhb2xhbi9hc3luYwogICAgLy8gQ29weXJpZ2h0IChjKSAyMDEwIENhb2xhbiBNY01haG9uCiAgICAvLwogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8qZ2xvYmFsIHNldEltbWVkaWF0ZTogZmFsc2UsIHNldFRpbWVvdXQ6IGZhbHNlLCBjb25zb2xlOiBmYWxzZSAqLwogICAgKGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIGFzeW5jID0ge307CgogICAgICAgIC8vIGdsb2JhbCBvbiB0aGUgc2VydmVyLCB3aW5kb3cgaW4gdGhlIGJyb3dzZXIKICAgICAgICB2YXIgcm9vdCwgcHJldmlvdXNfYXN5bmM7CgogICAgICAgIHJvb3QgPSB0aGlzOwogICAgICAgIGlmIChyb290ICE9IG51bGwpIHsKICAgICAgICAgICAgcHJldmlvdXNfYXN5bmMgPSByb290LmFzeW5jOwogICAgICAgIH0KCiAgICAgICAgYXN5bmMubm9Db25mbGljdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcm9vdC5hc3luYyA9IHByZXZpb3VzX2FzeW5jOwogICAgICAgICAgICByZXR1cm4gYXN5bmM7CiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gb25seV9vbmNlKGZuKSB7CiAgICAgICAgICAgIHZhciBjYWxsZWQgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKGNhbGxlZCkgdGhyb3cgbmV3IEVycm9yKCJDYWxsYmFjayB3YXMgYWxyZWFkeSBjYWxsZWQuIik7CiAgICAgICAgICAgICAgICBjYWxsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgZm4uYXBwbHkocm9vdCwgYXJndW1lbnRzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8vLyBjcm9zcy1icm93c2VyIGNvbXBhdGlibGl0eSBmdW5jdGlvbnMgLy8vLwoKICAgICAgICB2YXIgX2VhY2ggPSBmdW5jdGlvbiAoYXJyLCBpdGVyYXRvcikgewogICAgICAgICAgICBpZiAoYXJyLmZvckVhY2gpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhcnIuZm9yRWFjaChpdGVyYXRvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgICAgICAgIGl0ZXJhdG9yKGFycltpXSwgaSwgYXJyKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHZhciBfbWFwID0gZnVuY3Rpb24gKGFyciwgaXRlcmF0b3IpIHsKICAgICAgICAgICAgaWYgKGFyci5tYXApIHsKICAgICAgICAgICAgICAgIHJldHVybiBhcnIubWFwKGl0ZXJhdG9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgICAgICAgICBfZWFjaChhcnIsIGZ1bmN0aW9uICh4LCBpLCBhKSB7CiAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2goaXRlcmF0b3IoeCwgaSwgYSkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIF9yZWR1Y2UgPSBmdW5jdGlvbiAoYXJyLCBpdGVyYXRvciwgbWVtbykgewogICAgICAgICAgICBpZiAoYXJyLnJlZHVjZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGFyci5yZWR1Y2UoaXRlcmF0b3IsIG1lbW8pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF9lYWNoKGFyciwgZnVuY3Rpb24gKHgsIGksIGEpIHsKICAgICAgICAgICAgICAgIG1lbW8gPSBpdGVyYXRvcihtZW1vLCB4LCBpLCBhKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBtZW1vOwogICAgICAgIH07CgogICAgICAgIHZhciBfa2V5cyA9IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgaWYgKE9iamVjdC5rZXlzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMob2JqKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIga2V5cyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBrIGluIG9iaikgewogICAgICAgICAgICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrKSkgewogICAgICAgICAgICAgICAgICAgIGtleXMucHVzaChrKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4ga2V5czsKICAgICAgICB9OwoKICAgICAgICAvLy8vIGV4cG9ydGVkIGFzeW5jIG1vZHVsZSBmdW5jdGlvbnMgLy8vLwoKICAgICAgICAvLy8vIG5leHRUaWNrIGltcGxlbWVudGF0aW9uIHdpdGggYnJvd3Nlci1jb21wYXRpYmxlIGZhbGxiYWNrIC8vLy8KICAgICAgICBpZiAodHlwZW9mIHByb2Nlc3MgPT09ICd1bmRlZmluZWQnIHx8ICEocHJvY2Vzcy5uZXh0VGljaykpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBzZXRJbW1lZGlhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIGFzeW5jLm5leHRUaWNrID0gZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gbm90IGEgZGlyZWN0IGFsaWFzIGZvciBJRTEwIGNvbXBhdGliaWxpdHkKICAgICAgICAgICAgICAgICAgICBzZXRJbW1lZGlhdGUoZm4pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGFzeW5jLnNldEltbWVkaWF0ZSA9IGFzeW5jLm5leHRUaWNrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgYXN5bmMubmV4dFRpY2sgPSBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZuLCAwKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBhc3luYy5zZXRJbW1lZGlhdGUgPSBhc3luYy5uZXh0VGljazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgYXN5bmMubmV4dFRpY2sgPSBwcm9jZXNzLm5leHRUaWNrOwogICAgICAgICAgICBpZiAodHlwZW9mIHNldEltbWVkaWF0ZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgIGFzeW5jLnNldEltbWVkaWF0ZSA9IGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgICAgIC8vIG5vdCBhIGRpcmVjdCBhbGlhcyBmb3IgSUUxMCBjb21wYXRpYmlsaXR5CiAgICAgICAgICAgICAgICAgICAgc2V0SW1tZWRpYXRlKGZuKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBhc3luYy5zZXRJbW1lZGlhdGUgPSBhc3luYy5uZXh0VGljazsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgYXN5bmMuZWFjaCA9IGZ1bmN0aW9uIChhcnIsIGl0ZXJhdG9yLCBjYWxsYmFjaykgewogICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrIHx8IGZ1bmN0aW9uICgpIHt9OwogICAgICAgICAgICBpZiAoIWFyci5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjaygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb21wbGV0ZWQgPSAwOwogICAgICAgICAgICBfZWFjaChhcnIsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICBpdGVyYXRvcih4LCBvbmx5X29uY2UoZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbiAoKSB7fTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBsZXRlZCArPSAxOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29tcGxldGVkID49IGFyci5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIGFzeW5jLmZvckVhY2ggPSBhc3luYy5lYWNoOwoKICAgICAgICBhc3luYy5lYWNoU2VyaWVzID0gZnVuY3Rpb24gKGFyciwgaXRlcmF0b3IsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgfHwgZnVuY3Rpb24gKCkge307CiAgICAgICAgICAgIGlmICghYXJyLmxlbmd0aCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbXBsZXRlZCA9IDA7CiAgICAgICAgICAgIHZhciBpdGVyYXRlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaXRlcmF0b3IoYXJyW2NvbXBsZXRlZF0sIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24gKCkge307CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZWQgKz0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBsZXRlZCA+PSBhcnIubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZXJhdGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwogICAgICAgICAgICBpdGVyYXRlKCk7CiAgICAgICAgfTsKICAgICAgICBhc3luYy5mb3JFYWNoU2VyaWVzID0gYXN5bmMuZWFjaFNlcmllczsKCiAgICAgICAgYXN5bmMuZWFjaExpbWl0ID0gZnVuY3Rpb24gKGFyciwgbGltaXQsIGl0ZXJhdG9yLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgZm4gPSBfZWFjaExpbWl0KGxpbWl0KTsKICAgICAgICAgICAgZm4uYXBwbHkobnVsbCwgW2FyciwgaXRlcmF0b3IsIGNhbGxiYWNrXSk7CiAgICAgICAgfTsKICAgICAgICBhc3luYy5mb3JFYWNoTGltaXQgPSBhc3luYy5lYWNoTGltaXQ7CgogICAgICAgIHZhciBfZWFjaExpbWl0ID0gZnVuY3Rpb24gKGxpbWl0KSB7CgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGFyciwgaXRlcmF0b3IsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrIHx8IGZ1bmN0aW9uICgpIHt9OwogICAgICAgICAgICAgICAgaWYgKCFhcnIubGVuZ3RoIHx8IGxpbWl0IDw9IDApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjb21wbGV0ZWQgPSAwOwogICAgICAgICAgICAgICAgdmFyIHN0YXJ0ZWQgPSAwOwogICAgICAgICAgICAgICAgdmFyIHJ1bm5pbmcgPSAwOwoKICAgICAgICAgICAgICAgIChmdW5jdGlvbiByZXBsZW5pc2ggKCkgewogICAgICAgICAgICAgICAgICAgIGlmIChjb21wbGV0ZWQgPj0gYXJyLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHdoaWxlIChydW5uaW5nIDwgbGltaXQgJiYgc3RhcnRlZCA8IGFyci5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRlZCArPSAxOwogICAgICAgICAgICAgICAgICAgICAgICBydW5uaW5nICs9IDE7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZXJhdG9yKGFycltzdGFydGVkIC0gMV0sIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24gKCkge307CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZWQgKz0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBydW5uaW5nIC09IDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBsZXRlZCA+PSBhcnIubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsZW5pc2goKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pKCk7CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKCgogICAgICAgIHZhciBkb1BhcmFsbGVsID0gZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICByZXR1cm4gZm4uYXBwbHkobnVsbCwgW2FzeW5jLmVhY2hdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICB2YXIgZG9QYXJhbGxlbExpbWl0ID0gZnVuY3Rpb24obGltaXQsIGZuKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICByZXR1cm4gZm4uYXBwbHkobnVsbCwgW19lYWNoTGltaXQobGltaXQpXS5jb25jYXQoYXJncykpOwogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICAgICAgdmFyIGRvU2VyaWVzID0gZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICByZXR1cm4gZm4uYXBwbHkobnVsbCwgW2FzeW5jLmVhY2hTZXJpZXNdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKCgogICAgICAgIHZhciBfYXN5bmNNYXAgPSBmdW5jdGlvbiAoZWFjaGZuLCBhcnIsIGl0ZXJhdG9yLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgICAgICAgICBhcnIgPSBfbWFwKGFyciwgZnVuY3Rpb24gKHgsIGkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB7aW5kZXg6IGksIHZhbHVlOiB4fTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGVhY2hmbihhcnIsIGZ1bmN0aW9uICh4LCBjYWxsYmFjaykgewogICAgICAgICAgICAgICAgaXRlcmF0b3IoeC52YWx1ZSwgZnVuY3Rpb24gKGVyciwgdikgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdHNbeC5pbmRleF0gPSB2OwogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyLCByZXN1bHRzKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICBhc3luYy5tYXAgPSBkb1BhcmFsbGVsKF9hc3luY01hcCk7CiAgICAgICAgYXN5bmMubWFwU2VyaWVzID0gZG9TZXJpZXMoX2FzeW5jTWFwKTsKICAgICAgICBhc3luYy5tYXBMaW1pdCA9IGZ1bmN0aW9uIChhcnIsIGxpbWl0LCBpdGVyYXRvciwgY2FsbGJhY2spIHsKICAgICAgICAgICAgcmV0dXJuIF9tYXBMaW1pdChsaW1pdCkoYXJyLCBpdGVyYXRvciwgY2FsbGJhY2spOwogICAgICAgIH07CgogICAgICAgIHZhciBfbWFwTGltaXQgPSBmdW5jdGlvbihsaW1pdCkgewogICAgICAgICAgICByZXR1cm4gZG9QYXJhbGxlbExpbWl0KGxpbWl0LCBfYXN5bmNNYXApOwogICAgICAgIH07CgogICAgICAgIC8vIHJlZHVjZSBvbmx5IGhhcyBhIHNlcmllcyB2ZXJzaW9uLCBhcyBkb2luZyByZWR1Y2UgaW4gcGFyYWxsZWwgd29uJ3QKICAgICAgICAvLyB3b3JrIGluIG1hbnkgc2l0dWF0aW9ucy4KICAgICAgICBhc3luYy5yZWR1Y2UgPSBmdW5jdGlvbiAoYXJyLCBtZW1vLCBpdGVyYXRvciwgY2FsbGJhY2spIHsKICAgICAgICAgICAgYXN5bmMuZWFjaFNlcmllcyhhcnIsIGZ1bmN0aW9uICh4LCBjYWxsYmFjaykgewogICAgICAgICAgICAgICAgaXRlcmF0b3IobWVtbywgeCwgZnVuY3Rpb24gKGVyciwgdikgewogICAgICAgICAgICAgICAgICAgIG1lbW8gPSB2OwogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyLCBtZW1vKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICAvLyBpbmplY3QgYWxpYXMKICAgICAgICBhc3luYy5pbmplY3QgPSBhc3luYy5yZWR1Y2U7CiAgICAgICAgLy8gZm9sZGwgYWxpYXMKICAgICAgICBhc3luYy5mb2xkbCA9IGFzeW5jLnJlZHVjZTsKCiAgICAgICAgYXN5bmMucmVkdWNlUmlnaHQgPSBmdW5jdGlvbiAoYXJyLCBtZW1vLCBpdGVyYXRvciwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIHJldmVyc2VkID0gX21hcChhcnIsIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICByZXR1cm4geDsKICAgICAgICAgICAgfSkucmV2ZXJzZSgpOwogICAgICAgICAgICBhc3luYy5yZWR1Y2UocmV2ZXJzZWQsIG1lbW8sIGl0ZXJhdG9yLCBjYWxsYmFjayk7CiAgICAgICAgfTsKICAgICAgICAvLyBmb2xkciBhbGlhcwogICAgICAgIGFzeW5jLmZvbGRyID0gYXN5bmMucmVkdWNlUmlnaHQ7CgogICAgICAgIHZhciBfZmlsdGVyID0gZnVuY3Rpb24gKGVhY2hmbiwgYXJyLCBpdGVyYXRvciwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgICAgICAgICAgYXJyID0gX21hcChhcnIsIGZ1bmN0aW9uICh4LCBpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4ge2luZGV4OiBpLCB2YWx1ZTogeH07CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBlYWNoZm4oYXJyLCBmdW5jdGlvbiAoeCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIGl0ZXJhdG9yKHgudmFsdWUsIGZ1bmN0aW9uICh2KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKF9tYXAocmVzdWx0cy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEuaW5kZXggLSBiLmluZGV4OwogICAgICAgICAgICAgICAgfSksIGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHgudmFsdWU7CiAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgYXN5bmMuZmlsdGVyID0gZG9QYXJhbGxlbChfZmlsdGVyKTsKICAgICAgICBhc3luYy5maWx0ZXJTZXJpZXMgPSBkb1NlcmllcyhfZmlsdGVyKTsKICAgICAgICAvLyBzZWxlY3QgYWxpYXMKICAgICAgICBhc3luYy5zZWxlY3QgPSBhc3luYy5maWx0ZXI7CiAgICAgICAgYXN5bmMuc2VsZWN0U2VyaWVzID0gYXN5bmMuZmlsdGVyU2VyaWVzOwoKICAgICAgICB2YXIgX3JlamVjdCA9IGZ1bmN0aW9uIChlYWNoZm4sIGFyciwgaXRlcmF0b3IsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciByZXN1bHRzID0gW107CiAgICAgICAgICAgIGFyciA9IF9tYXAoYXJyLCBmdW5jdGlvbiAoeCwgaSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHtpbmRleDogaSwgdmFsdWU6IHh9OwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZWFjaGZuKGFyciwgZnVuY3Rpb24gKHgsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBpdGVyYXRvcih4LnZhbHVlLCBmdW5jdGlvbiAodikgewogICAgICAgICAgICAgICAgICAgIGlmICghdikgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2goeCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgY2FsbGJhY2soX21hcChyZXN1bHRzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYS5pbmRleCAtIGIuaW5kZXg7CiAgICAgICAgICAgICAgICB9KSwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4geC52YWx1ZTsKICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICBhc3luYy5yZWplY3QgPSBkb1BhcmFsbGVsKF9yZWplY3QpOwogICAgICAgIGFzeW5jLnJlamVjdFNlcmllcyA9IGRvU2VyaWVzKF9yZWplY3QpOwoKICAgICAgICB2YXIgX2RldGVjdCA9IGZ1bmN0aW9uIChlYWNoZm4sIGFyciwgaXRlcmF0b3IsIG1haW5fY2FsbGJhY2spIHsKICAgICAgICAgICAgZWFjaGZuKGFyciwgZnVuY3Rpb24gKHgsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBpdGVyYXRvcih4LCBmdW5jdGlvbiAocmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgICAgICAgICAgICAgICAgICBtYWluX2NhbGxiYWNrKHgpOwogICAgICAgICAgICAgICAgICAgICAgICBtYWluX2NhbGxiYWNrID0gZnVuY3Rpb24gKCkge307CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LCBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICBtYWluX2NhbGxiYWNrKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgYXN5bmMuZGV0ZWN0ID0gZG9QYXJhbGxlbChfZGV0ZWN0KTsKICAgICAgICBhc3luYy5kZXRlY3RTZXJpZXMgPSBkb1NlcmllcyhfZGV0ZWN0KTsKCiAgICAgICAgYXN5bmMuc29tZSA9IGZ1bmN0aW9uIChhcnIsIGl0ZXJhdG9yLCBtYWluX2NhbGxiYWNrKSB7CiAgICAgICAgICAgIGFzeW5jLmVhY2goYXJyLCBmdW5jdGlvbiAoeCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIGl0ZXJhdG9yKHgsIGZ1bmN0aW9uICh2KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWFpbl9jYWxsYmFjayh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgbWFpbl9jYWxsYmFjayA9IGZ1bmN0aW9uICgpIHt9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgIG1haW5fY2FsbGJhY2soZmFsc2UpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIC8vIGFueSBhbGlhcwogICAgICAgIGFzeW5jLmFueSA9IGFzeW5jLnNvbWU7CgogICAgICAgIGFzeW5jLmV2ZXJ5ID0gZnVuY3Rpb24gKGFyciwgaXRlcmF0b3IsIG1haW5fY2FsbGJhY2spIHsKICAgICAgICAgICAgYXN5bmMuZWFjaChhcnIsIGZ1bmN0aW9uICh4LCBjYWxsYmFjaykgewogICAgICAgICAgICAgICAgaXRlcmF0b3IoeCwgZnVuY3Rpb24gKHYpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWFpbl9jYWxsYmFjayhmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG1haW5fY2FsbGJhY2sgPSBmdW5jdGlvbiAoKSB7fTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LCBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICBtYWluX2NhbGxiYWNrKHRydWUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIC8vIGFsbCBhbGlhcwogICAgICAgIGFzeW5jLmFsbCA9IGFzeW5jLmV2ZXJ5OwoKICAgICAgICBhc3luYy5zb3J0QnkgPSBmdW5jdGlvbiAoYXJyLCBpdGVyYXRvciwgY2FsbGJhY2spIHsKICAgICAgICAgICAgYXN5bmMubWFwKGFyciwgZnVuY3Rpb24gKHgsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBpdGVyYXRvcih4LCBmdW5jdGlvbiAoZXJyLCBjcml0ZXJpYSkgewogICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHt2YWx1ZTogeCwgY3JpdGVyaWE6IGNyaXRlcmlhfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnIsIHJlc3VsdHMpIHsKICAgICAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBmbiA9IGZ1bmN0aW9uIChsZWZ0LCByaWdodCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYSA9IGxlZnQuY3JpdGVyaWEsIGIgPSByaWdodC5jcml0ZXJpYTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEgPCBiID8gLTEgOiBhID4gYiA/IDEgOiAwOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgX21hcChyZXN1bHRzLnNvcnQoZm4pLCBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4geC52YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIGFzeW5jLmF1dG8gPSBmdW5jdGlvbiAodGFza3MsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgfHwgZnVuY3Rpb24gKCkge307CiAgICAgICAgICAgIHZhciBrZXlzID0gX2tleXModGFza3MpOwogICAgICAgICAgICBpZiAoIWtleXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciByZXN1bHRzID0ge307CgogICAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gW107CiAgICAgICAgICAgIHZhciBhZGRMaXN0ZW5lciA9IGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgbGlzdGVuZXJzLnVuc2hpZnQoZm4pOwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgcmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGlzdGVuZXJzLmxlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGxpc3RlbmVyc1tpXSA9PT0gZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIHRhc2tDb21wbGV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIF9lYWNoKGxpc3RlbmVycy5zbGljZSgwKSwgZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgZm4oKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgYWRkTGlzdGVuZXIoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKF9rZXlzKHJlc3VsdHMpLmxlbmd0aCA9PT0ga2V5cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCByZXN1bHRzKTsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uICgpIHt9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIF9lYWNoKGtleXMsIGZ1bmN0aW9uIChrKSB7CiAgICAgICAgICAgICAgICB2YXIgdGFzayA9ICh0YXNrc1trXSBpbnN0YW5jZW9mIEZ1bmN0aW9uKSA/IFt0YXNrc1trXV06IHRhc2tzW2tdOwogICAgICAgICAgICAgICAgdmFyIHRhc2tDYWxsYmFjayA9IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoIDw9IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXJncyA9IGFyZ3NbMF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNhZmVSZXN1bHRzID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIF9lYWNoKF9rZXlzKHJlc3VsdHMpLCBmdW5jdGlvbihya2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlUmVzdWx0c1tya2V5XSA9IHJlc3VsdHNbcmtleV07CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBzYWZlUmVzdWx0c1trXSA9IGFyZ3M7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVyciwgc2FmZVJlc3VsdHMpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBzdG9wIHN1YnNlcXVlbnQgZXJyb3JzIGhpdHRpbmcgY2FsbGJhY2sgbXVsdGlwbGUgdGltZXMKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbiAoKSB7fTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHNba10gPSBhcmdzOwogICAgICAgICAgICAgICAgICAgICAgICBhc3luYy5zZXRJbW1lZGlhdGUodGFza0NvbXBsZXRlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgdmFyIHJlcXVpcmVzID0gdGFzay5zbGljZSgwLCBNYXRoLmFicyh0YXNrLmxlbmd0aCAtIDEpKSB8fCBbXTsKICAgICAgICAgICAgICAgIHZhciByZWFkeSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3JlZHVjZShyZXF1aXJlcywgZnVuY3Rpb24gKGEsIHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChhICYmIHJlc3VsdHMuaGFzT3duUHJvcGVydHkoeCkpOwogICAgICAgICAgICAgICAgICAgIH0sIHRydWUpICYmICFyZXN1bHRzLmhhc093blByb3BlcnR5KGspOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGlmIChyZWFkeSgpKSB7CiAgICAgICAgICAgICAgICAgICAgdGFza1t0YXNrLmxlbmd0aCAtIDFdKHRhc2tDYWxsYmFjaywgcmVzdWx0cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGlzdGVuZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWFkeSgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVMaXN0ZW5lcihsaXN0ZW5lcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrW3Rhc2subGVuZ3RoIC0gMV0odGFza0NhbGxiYWNrLCByZXN1bHRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgYWRkTGlzdGVuZXIobGlzdGVuZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBhc3luYy53YXRlcmZhbGwgPSBmdW5jdGlvbiAodGFza3MsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgfHwgZnVuY3Rpb24gKCkge307CiAgICAgICAgICAgIGlmICh0YXNrcy5jb25zdHJ1Y3RvciAhPT0gQXJyYXkpIHsKICAgICAgICAgICAgICAgIHZhciBlcnIgPSBuZXcgRXJyb3IoJ0ZpcnN0IGFyZ3VtZW50IHRvIHdhdGVyZmFsbCBtdXN0IGJlIGFuIGFycmF5IG9mIGZ1bmN0aW9ucycpOwogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCF0YXNrcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjaygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB3cmFwSXRlcmF0b3IgPSBmdW5jdGlvbiAoaXRlcmF0b3IpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uICgpIHt9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IGl0ZXJhdG9yLm5leHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaCh3cmFwSXRlcmF0b3IobmV4dCkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBhc3luYy5zZXRJbW1lZGlhdGUoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlcmF0b3IuYXBwbHkobnVsbCwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHdyYXBJdGVyYXRvcihhc3luYy5pdGVyYXRvcih0YXNrcykpKCk7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIF9wYXJhbGxlbCA9IGZ1bmN0aW9uKGVhY2hmbiwgdGFza3MsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgfHwgZnVuY3Rpb24gKCkge307CiAgICAgICAgICAgIGlmICh0YXNrcy5jb25zdHJ1Y3RvciA9PT0gQXJyYXkpIHsKICAgICAgICAgICAgICAgIGVhY2hmbi5tYXAodGFza3MsIGZ1bmN0aW9uIChmbiwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm4oZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoIDw9IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzID0gYXJnc1swXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmNhbGwobnVsbCwgZXJyLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHJlc3VsdHMgPSB7fTsKICAgICAgICAgICAgICAgIGVhY2hmbi5lYWNoKF9rZXlzKHRhc2tzKSwgZnVuY3Rpb24gKGssIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgdGFza3Nba10oZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcmdzLmxlbmd0aCA8PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzID0gYXJnc1swXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzW2tdID0gYXJnczsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnIsIHJlc3VsdHMpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBhc3luYy5wYXJhbGxlbCA9IGZ1bmN0aW9uICh0YXNrcywgY2FsbGJhY2spIHsKICAgICAgICAgICAgX3BhcmFsbGVsKHsgbWFwOiBhc3luYy5tYXAsIGVhY2g6IGFzeW5jLmVhY2ggfSwgdGFza3MsIGNhbGxiYWNrKTsKICAgICAgICB9OwoKICAgICAgICBhc3luYy5wYXJhbGxlbExpbWl0ID0gZnVuY3Rpb24odGFza3MsIGxpbWl0LCBjYWxsYmFjaykgewogICAgICAgICAgICBfcGFyYWxsZWwoeyBtYXA6IF9tYXBMaW1pdChsaW1pdCksIGVhY2g6IF9lYWNoTGltaXQobGltaXQpIH0sIHRhc2tzLCBjYWxsYmFjayk7CiAgICAgICAgfTsKCiAgICAgICAgYXN5bmMuc2VyaWVzID0gZnVuY3Rpb24gKHRhc2tzLCBjYWxsYmFjaykgewogICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrIHx8IGZ1bmN0aW9uICgpIHt9OwogICAgICAgICAgICBpZiAodGFza3MuY29uc3RydWN0b3IgPT09IEFycmF5KSB7CiAgICAgICAgICAgICAgICBhc3luYy5tYXBTZXJpZXModGFza3MsIGZ1bmN0aW9uIChmbiwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm4oZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoIDw9IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzID0gYXJnc1swXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmNhbGwobnVsbCwgZXJyLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHJlc3VsdHMgPSB7fTsKICAgICAgICAgICAgICAgIGFzeW5jLmVhY2hTZXJpZXMoX2tleXModGFza3MpLCBmdW5jdGlvbiAoaywgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICB0YXNrc1trXShmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoIDw9IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MgPSBhcmdzWzBdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHNba10gPSBhcmdzOwogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVyciwgcmVzdWx0cyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGFzeW5jLml0ZXJhdG9yID0gZnVuY3Rpb24gKHRhc2tzKSB7CiAgICAgICAgICAgIHZhciBtYWtlQ2FsbGJhY2sgPSBmdW5jdGlvbiAoaW5kZXgpIHsKICAgICAgICAgICAgICAgIHZhciBmbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGFza3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhc2tzW2luZGV4XS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4ubmV4dCgpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGZuLm5leHQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChpbmRleCA8IHRhc2tzLmxlbmd0aCAtIDEpID8gbWFrZUNhbGxiYWNrKGluZGV4ICsgMSk6IG51bGw7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gbWFrZUNhbGxiYWNrKDApOwogICAgICAgIH07CgogICAgICAgIGFzeW5jLmFwcGx5ID0gZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmbi5hcHBseSgKICAgICAgICAgICAgICAgICAgICBudWxsLCBhcmdzLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfTsKICAgICAgICB9OwoKICAgICAgICB2YXIgX2NvbmNhdCA9IGZ1bmN0aW9uIChlYWNoZm4sIGFyciwgZm4sIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciByID0gW107CiAgICAgICAgICAgIGVhY2hmbihhcnIsIGZ1bmN0aW9uICh4LCBjYikgewogICAgICAgICAgICAgICAgZm4oeCwgZnVuY3Rpb24gKGVyciwgeSkgewogICAgICAgICAgICAgICAgICAgIHIgPSByLmNvbmNhdCh5IHx8IFtdKTsKICAgICAgICAgICAgICAgICAgICBjYihlcnIpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVyciwgcik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgYXN5bmMuY29uY2F0ID0gZG9QYXJhbGxlbChfY29uY2F0KTsKICAgICAgICBhc3luYy5jb25jYXRTZXJpZXMgPSBkb1NlcmllcyhfY29uY2F0KTsKCiAgICAgICAgYXN5bmMud2hpbHN0ID0gZnVuY3Rpb24gKHRlc3QsIGl0ZXJhdG9yLCBjYWxsYmFjaykgewogICAgICAgICAgICBpZiAodGVzdCgpKSB7CiAgICAgICAgICAgICAgICBpdGVyYXRvcihmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYXN5bmMud2hpbHN0KHRlc3QsIGl0ZXJhdG9yLCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBhc3luYy5kb1doaWxzdCA9IGZ1bmN0aW9uIChpdGVyYXRvciwgdGVzdCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgaXRlcmF0b3IoZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhlcnIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRlc3QoKSkgewogICAgICAgICAgICAgICAgICAgIGFzeW5jLmRvV2hpbHN0KGl0ZXJhdG9yLCB0ZXN0LCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBhc3luYy51bnRpbCA9IGZ1bmN0aW9uICh0ZXN0LCBpdGVyYXRvciwgY2FsbGJhY2spIHsKICAgICAgICAgICAgaWYgKCF0ZXN0KCkpIHsKICAgICAgICAgICAgICAgIGl0ZXJhdG9yKGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhlcnIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBhc3luYy51bnRpbCh0ZXN0LCBpdGVyYXRvciwgY2FsbGJhY2spOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgYXN5bmMuZG9VbnRpbCA9IGZ1bmN0aW9uIChpdGVyYXRvciwgdGVzdCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgaXRlcmF0b3IoZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhlcnIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCF0ZXN0KCkpIHsKICAgICAgICAgICAgICAgICAgICBhc3luYy5kb1VudGlsKGl0ZXJhdG9yLCB0ZXN0LCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBhc3luYy5xdWV1ZSA9IGZ1bmN0aW9uICh3b3JrZXIsIGNvbmN1cnJlbmN5KSB7CiAgICAgICAgICAgIGlmIChjb25jdXJyZW5jeSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBjb25jdXJyZW5jeSA9IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gX2luc2VydChxLCBkYXRhLCBwb3MsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBpZihkYXRhLmNvbnN0cnVjdG9yICE9PSBBcnJheSkgewogICAgICAgICAgICAgICAgICAgIGRhdGEgPSBbZGF0YV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfZWFjaChkYXRhLCBmdW5jdGlvbih0YXNrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHRhc2ssCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiB0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicgPyBjYWxsYmFjayA6IG51bGwKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBpZiAocG9zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHEudGFza3MudW5zaGlmdChpdGVtKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBxLnRhc2tzLnB1c2goaXRlbSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAocS5zYXR1cmF0ZWQgJiYgcS50YXNrcy5sZW5ndGggPT09IGNvbmN1cnJlbmN5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHEuc2F0dXJhdGVkKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGFzeW5jLnNldEltbWVkaWF0ZShxLnByb2Nlc3MpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciB3b3JrZXJzID0gMDsKICAgICAgICAgICAgdmFyIHEgPSB7CiAgICAgICAgICAgICAgICB0YXNrczogW10sCiAgICAgICAgICAgICAgICBjb25jdXJyZW5jeTogY29uY3VycmVuY3ksCiAgICAgICAgICAgICAgICBzYXR1cmF0ZWQ6IG51bGwsCiAgICAgICAgICAgICAgICBlbXB0eTogbnVsbCwKICAgICAgICAgICAgICAgIGRyYWluOiBudWxsLAogICAgICAgICAgICAgICAgcHVzaDogZnVuY3Rpb24gKGRhdGEsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgX2luc2VydChxLCBkYXRhLCBmYWxzZSwgY2FsbGJhY2spOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHVuc2hpZnQ6IGZ1bmN0aW9uIChkYXRhLCBjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgIF9pbnNlcnQocSwgZGF0YSwgdHJ1ZSwgY2FsbGJhY2spOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHByb2Nlc3M6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAod29ya2VycyA8IHEuY29uY3VycmVuY3kgJiYgcS50YXNrcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRhc2sgPSBxLnRhc2tzLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChxLmVtcHR5ICYmIHEudGFza3MubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBxLmVtcHR5KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgd29ya2VycyArPSAxOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtlcnMgLT0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXNrLmNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5jYWxsYmFjay5hcHBseSh0YXNrLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHEuZHJhaW4gJiYgcS50YXNrcy5sZW5ndGggKyB3b3JrZXJzID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcS5kcmFpbigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcS5wcm9jZXNzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYiA9IG9ubHlfb25jZShuZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgd29ya2VyKHRhc2suZGF0YSwgY2IpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBsZW5ndGg6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcS50YXNrcy5sZW5ndGg7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgcnVubmluZzogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB3b3JrZXJzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gcTsKICAgICAgICB9OwoKICAgICAgICBhc3luYy5jYXJnbyA9IGZ1bmN0aW9uICh3b3JrZXIsIHBheWxvYWQpIHsKICAgICAgICAgICAgdmFyIHdvcmtpbmcgICAgID0gZmFsc2UsCiAgICAgICAgICAgICAgICB0YXNrcyAgICAgICA9IFtdOwoKICAgICAgICAgICAgdmFyIGNhcmdvID0gewogICAgICAgICAgICAgICAgdGFza3M6IHRhc2tzLAogICAgICAgICAgICAgICAgcGF5bG9hZDogcGF5bG9hZCwKICAgICAgICAgICAgICAgIHNhdHVyYXRlZDogbnVsbCwKICAgICAgICAgICAgICAgIGVtcHR5OiBudWxsLAogICAgICAgICAgICAgICAgZHJhaW46IG51bGwsCiAgICAgICAgICAgICAgICBwdXNoOiBmdW5jdGlvbiAoZGF0YSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICBpZihkYXRhLmNvbnN0cnVjdG9yICE9PSBBcnJheSkgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0gW2RhdGFdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBfZWFjaChkYXRhLCBmdW5jdGlvbih0YXNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhc2tzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogdGFzaywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiB0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicgPyBjYWxsYmFjayA6IG51bGwKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYXJnby5zYXR1cmF0ZWQgJiYgdGFza3MubGVuZ3RoID09PSBwYXlsb2FkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXJnby5zYXR1cmF0ZWQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGFzeW5jLnNldEltbWVkaWF0ZShjYXJnby5wcm9jZXNzKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBwcm9jZXNzOiBmdW5jdGlvbiBwcm9jZXNzKCkgewogICAgICAgICAgICAgICAgICAgIGlmICh3b3JraW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgaWYgKHRhc2tzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZihjYXJnby5kcmFpbikgY2FyZ28uZHJhaW4oKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdmFyIHRzID0gdHlwZW9mIHBheWxvYWQgPT09ICdudW1iZXInCiAgICAgICAgICAgICAgICAgICAgICAgID8gdGFza3Muc3BsaWNlKDAsIHBheWxvYWQpCiAgICAgICAgICAgICAgICAgICAgICAgIDogdGFza3Muc3BsaWNlKDApOwoKICAgICAgICAgICAgICAgICAgICB2YXIgZHMgPSBfbWFwKHRzLCBmdW5jdGlvbiAodGFzaykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGFzay5kYXRhOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBpZihjYXJnby5lbXB0eSkgY2FyZ28uZW1wdHkoKTsKICAgICAgICAgICAgICAgICAgICB3b3JraW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB3b3JrZXIoZHMsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd29ya2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgICAgICAgICAgICAgICAgIF9lYWNoKHRzLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEuY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmNhbGxiYWNrLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3MoKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBsZW5ndGg6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGFza3MubGVuZ3RoOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHJ1bm5pbmc6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd29ya2luZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIGNhcmdvOwogICAgICAgIH07CgogICAgICAgIHZhciBfY29uc29sZV9mbiA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgICAgIGZuLmFwcGx5KG51bGwsIGFyZ3MuY29uY2F0KFtmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY29uc29sZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnNvbGUuZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoY29uc29sZVtuYW1lXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2VhY2goYXJncywgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlW25hbWVdKHgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9XSkpOwogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICAgICAgYXN5bmMubG9nID0gX2NvbnNvbGVfZm4oJ2xvZycpOwogICAgICAgIGFzeW5jLmRpciA9IF9jb25zb2xlX2ZuKCdkaXInKTsKICAgICAgICAvKmFzeW5jLmluZm8gPSBfY29uc29sZV9mbignaW5mbycpOwogICAgICAgICBhc3luYy53YXJuID0gX2NvbnNvbGVfZm4oJ3dhcm4nKTsKICAgICAgICAgYXN5bmMuZXJyb3IgPSBfY29uc29sZV9mbignZXJyb3InKTsqLwoKICAgICAgICBhc3luYy5tZW1vaXplID0gZnVuY3Rpb24gKGZuLCBoYXNoZXIpIHsKICAgICAgICAgICAgdmFyIG1lbW8gPSB7fTsKICAgICAgICAgICAgdmFyIHF1ZXVlcyA9IHt9OwogICAgICAgICAgICBoYXNoZXIgPSBoYXNoZXIgfHwgZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB4OwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgbWVtb2l6ZWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBhcmdzLnBvcCgpOwogICAgICAgICAgICAgICAgdmFyIGtleSA9IGhhc2hlci5hcHBseShudWxsLCBhcmdzKTsKICAgICAgICAgICAgICAgIGlmIChrZXkgaW4gbWVtbykgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmFwcGx5KG51bGwsIG1lbW9ba2V5XSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChrZXkgaW4gcXVldWVzKSB7CiAgICAgICAgICAgICAgICAgICAgcXVldWVzW2tleV0ucHVzaChjYWxsYmFjayk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBxdWV1ZXNba2V5XSA9IFtjYWxsYmFja107CiAgICAgICAgICAgICAgICAgICAgZm4uYXBwbHkobnVsbCwgYXJncy5jb25jYXQoW2Z1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWVtb1trZXldID0gYXJndW1lbnRzOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcSA9IHF1ZXVlc1trZXldOwogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgcXVldWVzW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gcS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHFbaV0uYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH1dKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIG1lbW9pemVkLm1lbW8gPSBtZW1vOwogICAgICAgICAgICBtZW1vaXplZC51bm1lbW9pemVkID0gZm47CiAgICAgICAgICAgIHJldHVybiBtZW1vaXplZDsKICAgICAgICB9OwoKICAgICAgICBhc3luYy51bm1lbW9pemUgPSBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiAoZm4udW5tZW1vaXplZCB8fCBmbikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgICAgfTsKICAgICAgICB9OwoKICAgICAgICBhc3luYy50aW1lcyA9IGZ1bmN0aW9uIChjb3VudCwgaXRlcmF0b3IsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBjb3VudGVyID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgY291bnRlci5wdXNoKGkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhc3luYy5tYXAoY291bnRlciwgaXRlcmF0b3IsIGNhbGxiYWNrKTsKICAgICAgICB9OwoKICAgICAgICBhc3luYy50aW1lc1NlcmllcyA9IGZ1bmN0aW9uIChjb3VudCwgaXRlcmF0b3IsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBjb3VudGVyID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgY291bnRlci5wdXNoKGkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhc3luYy5tYXBTZXJpZXMoY291bnRlciwgaXRlcmF0b3IsIGNhbGxiYWNrKTsKICAgICAgICB9OwoKICAgICAgICBhc3luYy5jb21wb3NlID0gZnVuY3Rpb24gKC8qIGZ1bmN0aW9ucy4uLiAqLykgewogICAgICAgICAgICB2YXIgZm5zID0gQXJyYXkucHJvdG90eXBlLnJldmVyc2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gYXJncy5wb3AoKTsKICAgICAgICAgICAgICAgIGFzeW5jLnJlZHVjZShmbnMsIGFyZ3MsIGZ1bmN0aW9uIChuZXdhcmdzLCBmbiwgY2IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm4uYXBwbHkodGhhdCwgbmV3YXJncy5jb25jYXQoW2Z1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlcnIgPSBhcmd1bWVudHNbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2IoZXJyLCBuZXh0YXJncyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH1dKSkKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChlcnIsIHJlc3VsdHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suYXBwbHkodGhhdCwgW2Vycl0uY29uY2F0KHJlc3VsdHMpKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICB9OwoKICAgICAgICB2YXIgX2FwcGx5RWFjaCA9IGZ1bmN0aW9uIChlYWNoZm4sIGZucyAvKmFyZ3MuLi4qLykgewogICAgICAgICAgICB2YXIgZ28gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBhcmdzLnBvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIGVhY2hmbihmbnMsIGZ1bmN0aW9uIChmbiwgY2IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm4uYXBwbHkodGhhdCwgYXJncy5jb25jYXQoW2NiXSkpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2spOwogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDIpIHsKICAgICAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgICAgICAgICAgICAgIHJldHVybiBnby5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBnbzsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgYXN5bmMuYXBwbHlFYWNoID0gZG9QYXJhbGxlbChfYXBwbHlFYWNoKTsKICAgICAgICBhc3luYy5hcHBseUVhY2hTZXJpZXMgPSBkb1NlcmllcyhfYXBwbHlFYWNoKTsKCiAgICAgICAgYXN5bmMuZm9yZXZlciA9IGZ1bmN0aW9uIChmbiwgY2FsbGJhY2spIHsKICAgICAgICAgICAgZnVuY3Rpb24gbmV4dChlcnIpIHsKICAgICAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZuKG5leHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHQoKTsKICAgICAgICB9OwoKICAgICAgICAvKgogICAgICAgIC8vIEFNRCAvIFJlcXVpcmVKUwogICAgICAgIGlmICh0eXBlb2YgZGVmaW5lICE9PSAndW5kZWZpbmVkJyAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgICAgIGRlZmluZShbXSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGFzeW5jOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgLy8gTm9kZS5qcwogICAgICAgIGVsc2UgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gYXN5bmM7CiAgICAgICAgfQogICAgICAgIC8vIGluY2x1ZGVkIGRpcmVjdGx5IHZpYSA8c2NyaXB0PiB0YWcKICAgICAgICBlbHNlIHsKICAgICAgICAgICAgcm9vdC5hc3luYyA9IGFzeW5jOwogICAgICAgIH0KICAgICAgICAqLwoKICAgICAgICByb290LmFzeW5jID0gYXN5bmM7CgogICAgfSgpKTsKCn0pKGpRdWVyeSk7CihmdW5jdGlvbigpCnsKICAgIEFscGFjYS5UZW1wbGF0ZUVuZ2luZVJlZ2lzdHJ5ID0gZnVuY3Rpb24oKSB7CgogICAgICAgIHZhciByZWdpc3RyeSA9IHt9OwoKICAgICAgICByZXR1cm4gewoKICAgICAgICAgICAgcmVnaXN0ZXI6IGZ1bmN0aW9uKGlkLCBlbmdpbmUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJlZ2lzdHJ5W2lkXSA9IGVuZ2luZTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGZpbmQ6IGZ1bmN0aW9uKGlkT3JUeXBlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgZW5naW5lID0gbnVsbDsKCiAgICAgICAgICAgICAgICBpZiAocmVnaXN0cnlbaWRPclR5cGVdKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGVuZ2luZSA9IHJlZ2lzdHJ5W2lkT3JUeXBlXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBpbnNwZWN0IGJ5IHR5cGUKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpZCBpbiByZWdpc3RyeSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdXBwb3J0ZWRNaW1ldHlwZXMgPSByZWdpc3RyeVtpZF0uc3VwcG9ydGVkTWltZXR5cGVzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3VwcG9ydGVkTWltZXR5cGVzLmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaWRPclR5cGUudG9Mb3dlckNhc2UoKSA9PSBzdXBwb3J0ZWRNaW1ldHlwZXNbaV0udG9Mb3dlckNhc2UoKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmUgPSByZWdpc3RyeVtpZF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGVuZ2luZTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGlkczogZnVuY3Rpb24oKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgaWRzID0gW107CgogICAgICAgICAgICAgICAgZm9yICh2YXIgaWQgaW4gcmVnaXN0cnkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWRzLnB1c2goaWQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBpZHM7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfSgpOwoKfSkoKTsKKGZ1bmN0aW9uKCQpCnsKICAgIC8vIHRlbXBsYXRlIGNhY2hlCiAgICBpZiAodHlwZW9mKEFscGFjYS5UZW1wbGF0ZUNhY2hlKSA9PSAidW5kZWZpbmVkIikgewogICAgICAgIEFscGFjYS5UZW1wbGF0ZUNhY2hlID0ge307CiAgICB9CgogICAgQWxwYWNhLkFic3RyYWN0VGVtcGxhdGVFbmdpbmUgPSBCYXNlLmV4dGVuZCgKICAgIHsKICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oaWQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmJhc2UoKTsKCiAgICAgICAgICAgIHRoaXMuaWQgPSBpZDsKCiAgICAgICAgICAgIHRoaXMuY2xlYW5NYXJrdXAgPSBmdW5jdGlvbihodG1sKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBjb252ZXJ0IHRvIGEgZG9tIGJyaWVmbHkKICAgICAgICAgICAgICAgIHZhciBkb20gPSBBbHBhY2Euc2FmZURvbVBhcnNlKGh0bWwpOwoKICAgICAgICAgICAgICAgIC8vIGlmIGlmIHN0YXJ0cyB3aXRoIGEgc2NyaXB0IHRhZywgdGhlbiB3ZSBzdHJpcCB0aGF0IG91dAogICAgICAgICAgICAgICAgaWYgKCQoZG9tKS5sZW5ndGggPT0gMSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoJChkb20pWzBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT0gInNjcmlwdCIpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBodG1sID0gJChkb20pLmh0bWwoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGh0bWw7CiAgICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ29tcGlsZXMgdGhlIGdpdmVuIHRlbXBsYXRlIChvciBVUkkgb3IgZG9tIHNlbGVjdG9yKQogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIGNhY2hlS2V5CiAgICAgICAgICogQHBhcmFtIHRlbXBsYXRlCiAgICAgICAgICogQHBhcmFtIGNhbGxiYWNrCiAgICAgICAgICovCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oY2FjaGVLZXksIHRlbXBsYXRlLCBjYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIC8vIHRoZSB2YWx1ZSBiZWluZyBjb21waWxlZCBjYW4gYmUKICAgICAgICAgICAgLy8gICBIVE1MCiAgICAgICAgICAgIC8vICAgVVJMIChodHRwLCAuLyBvciAvKQogICAgICAgICAgICAvLyAgIGRvbSBzZWxlY3RvciAoI2FiYywgLmNsYXNzbmFtZSkKICAgICAgICAgICAgLy8gICBkb20gZWxlbWVudAoKICAgICAgICAgICAgLy8gaGVyZSB3ZSB0cnkgdG8gZGV0ZXJtaW5lIHdoYXQgdHlwZSBvZiB2YWx1ZSBpdCBpcwogICAgICAgICAgICB2YXIgdHlwZSA9ICJodG1sIjsKICAgICAgICAgICAgaWYgKEFscGFjYS5pc1N0cmluZyh0ZW1wbGF0ZSkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0ZW1wbGF0ZS5pbmRleE9mKCIuLyIpID09PSAwIHx8IHRlbXBsYXRlLmluZGV4T2YoIi8iKSA9PT0gMCB8fCB0ZW1wbGF0ZS5pbmRleE9mKCIuLi8iKSA9PT0gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gInVyaSI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZW1wbGF0ZS5pbmRleE9mKCIjIikgPT09IDAgfHwgdGVtcGxhdGUuaW5kZXhPZigiLiIpID09PSAwIHx8IHRlbXBsYXRlLmluZGV4T2YoIlsiKSA9PT0gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gInNlbGVjdG9yIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIGl0J3MgYSBkb20gZWxlbWVudCwgd2UgZmxvdyB0aHJvdWdoCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIG5vdyBleHRyYWN0IGh0bWwgYW5kIGNvbXBpbGUKICAgICAgICAgICAgaWYgKHR5cGUgPT0gInNlbGVjdG9yIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc2VsZi5fY29tcGlsZShjYWNoZUtleSwgdGVtcGxhdGUsIGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0eXBlID09ICJ1cmkiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgZmlsZUV4dGVuc2lvbiA9IHNlbGYuZmlsZUV4dGVuc2lvbigpOwoKICAgICAgICAgICAgICAgIHZhciB1cmwgPSB0ZW1wbGF0ZTsKICAgICAgICAgICAgICAgIGlmICh1cmwuaW5kZXhPZigiLiIgKyBmaWxlRXh0ZW5zaW9uKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICB1cmwgKz0gIi4iICsgZmlsZUV4dGVuc2lvbjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBsb2FkIHRoZSB0ZW1wbGF0ZSB2aWEgYWpheAogICAgICAgICAgICAgICAgJC5hamF4KHsKICAgICAgICAgICAgICAgICAgICAidXJsIjogdXJsLAogICAgICAgICAgICAgICAgICAgICJkYXRhVHlwZSI6ICJodG1sIiwKICAgICAgICAgICAgICAgICAgICAic3VjY2VzcyI6IGZ1bmN0aW9uKGh0bWwpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBjbGVhbnVwIGh0bWwKICAgICAgICAgICAgICAgICAgICAgICAgaHRtbCA9IHNlbGYuY2xlYW5NYXJrdXAoaHRtbCk7CgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9jb21waWxlKGNhY2hlS2V5LCBodG1sLCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZmFpbHVyZSI6IGZ1bmN0aW9uKGh0dHApCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhodHRwLCBudWxsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0eXBlID09ICJodG1sIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGh0bWwgPSB0ZW1wbGF0ZTsKICAgICAgICAgICAgICAgIGlmIChodG1sIGluc3RhbmNlb2YgalF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgaHRtbCA9IEFscGFjYS5zYWZlRG9tUGFyc2UodGVtcGxhdGUpLm91dGVySFRNTCgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHNlbGYuX2NvbXBpbGUoY2FjaGVLZXksIGh0bWwsIGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcigiVGVtcGxhdGUgZW5naW5lIGNhbm5vdCBkZXRlcm1pbmUgaG93IHRvIGhhbmRsZSB0eXBlOiAiICsgdHlwZSkpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgX2NvbXBpbGU6IGZ1bmN0aW9uKGNhY2hlS2V5LCBodG1sLCBjYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIC8vIGZvciBudWxsIHRlbXBsYXRlcywgc2V0IHRvIGVtcHR5IHN0cmluZwogICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkoaHRtbCkpIHsKICAgICAgICAgICAgICAgIGh0bWwgPSAiIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gdHJpbSB0aGUgaHRtbAogICAgICAgICAgICBodG1sID0gQWxwYWNhLnRyaW0oaHRtbCk7CgogICAgICAgICAgICBpZiAoaHRtbC50b0xvd2VyQ2FzZSgpLmluZGV4T2YoIjxzY3JpcHQiKSA9PT0gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gYWxyZWFkeSBoYXMgc2NyaXB0IHRhZwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gYXBwbHkgc2NyaXB0IHRhZwogICAgICAgICAgICAgICAgaHRtbCA9ICI8c2NyaXB0IHR5cGU9JyIgKyB0aGlzLnN1cHBvcnRlZE1pbWV0eXBlcygpWzBdICsgIic+IiArIGh0bWwgKyAiPC9zY3JpcHQ+IjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgQWxwYWNhLmxvZ0RlYnVnKCJDb21waWxpbmcgdGVtcGxhdGU6ICIgKyB0aGlzLmlkICsgIiwgY2FjaGVLZXk6ICIgKyBjYWNoZUtleSArICIsIHRlbXBsYXRlOiAiICsgaHRtbCk7CgogICAgICAgICAgICB0aGlzLmRvQ29tcGlsZShjYWNoZUtleSwgaHRtbCwgY2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBleHRlbnNpb25fcG9pbnQKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBjYWNoZUtleQogICAgICAgICAqIEBwYXJhbSBodG1sCiAgICAgICAgICogQHBhcmFtIGNhbGxiYWNrCiAgICAgICAgICovCiAgICAgICAgZG9Db21waWxlOiBmdW5jdGlvbihjYWNoZUtleSwgaHRtbCwgY2FsbGJhY2spCiAgICAgICAgewoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAZXh0ZW5zaW9uX3BvaW50CiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gY2FjaGVLZXkKICAgICAgICAgKiBAcGFyYW0gbW9kZWwKICAgICAgICAgKiBAcGFyYW0gY2FsbGJhY2sKICAgICAgICAgKi8KICAgICAgICBleGVjdXRlOiBmdW5jdGlvbihjYWNoZUtleSwgbW9kZWwsIGNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgQWxwYWNhLmxvZ0RlYnVnKCJFeGVjdXRpbmcgdGVtcGxhdGUgZm9yIGNhY2hlIGtleTogIiArIGNhY2hlS2V5KTsKCiAgICAgICAgICAgIHZhciBkb20gPSB0aGlzLmRvRXhlY3V0ZShjYWNoZUtleSwgbW9kZWwsIGNhbGxiYWNrKTsKCiAgICAgICAgICAgIC8vIGlmIHdyYXBwZWQgaW4gc2NyaXB0IHRhZywgc3RyaXAgYXdheQogICAgICAgICAgICB2YXIgc3RyaXBfc2NyaXB0ID0gZnVuY3Rpb24oZG9tKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBpZiBpZiBzdGFydHMgd2l0aCBhIHNjcmlwdCB0YWcsIHRoZW4gd2Ugc3RyaXAgdGhhdCBvdXQKICAgICAgICAgICAgICAgIGlmICgkKGRvbSkubGVuZ3RoID09IDEpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCQoZG9tKVswXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09ICJzY3JpcHQiKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICQoZG9tKS5odG1sKCk7CgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gaHRtbDsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGRvbSA9IHN0cmlwX3NjcmlwdChkb20pOwoKICAgICAgICAgICAgcmV0dXJuIGRvbTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAZXh0ZW5zaW9uX3BvaW50CiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gY2FjaGVLZXkKICAgICAgICAgKiBAcGFyYW0gbW9kZWwKICAgICAgICAgKiBAcGFyYW0gY2FsbGJhY2sKICAgICAgICAgKi8KICAgICAgICBkb0V4ZWN1dGU6IGZ1bmN0aW9uKGNhY2hlS2V5LCBtb2RlbCwgY2FsbGJhY2spCiAgICAgICAgewoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBIYW5kcyBiYWNrIHRoZSBleHBlY3RlZCBmaWxlIGV4dGVuc2lvbiBmb3IgdGVtcGxhdGVzIGxvYWRlZCB2aWEgVVJJLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGZpbGVFeHRlbnNpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gImh0bWwiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEhhbmRzIGJhY2sgdGhlIGxpc3Qgb2YgYXNzb2NpYXRlZCBzY3JpcHQgdGFnIHR5cGVzIGZvciB0ZW1wbGF0ZXMgbG9hZGVkIGZyb20gdGhlIERPTS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge0FycmF5fQogICAgICAgICAqLwogICAgICAgIHN1cHBvcnRlZE1pbWV0eXBlczogZnVuY3Rpb24oKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIERldGVybWluZXMgd2hldGhlciBhbiBleGlzdGluZyB0ZW1wbGF0ZSBpcyBhbHJlYWR5IGluIGNhY2hlLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIGNhY2hlS2V5CiAgICAgICAgICovCiAgICAgICAgaXNDYWNoZWQ6IGZ1bmN0aW9uKGNhY2hlS2V5KQogICAgICAgIHsKCiAgICAgICAgfQoKICAgIH0pOwoKfSkoalF1ZXJ5KTsoZnVuY3Rpb24oJCkKewogICAgQWxwYWNhLkpRdWVyeVRlbXBsYXRlRW5naW5lID0gQWxwYWNhLkFic3RyYWN0VGVtcGxhdGVFbmdpbmUuZXh0ZW5kKAogICAgewogICAgICAgIGZpbGVFeHRlbnNpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gImh0bWwiOwogICAgICAgIH0sCgogICAgICAgIHN1cHBvcnRlZE1pbWV0eXBlczogZnVuY3Rpb24oKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICJ0ZXh0L3gtanF1ZXJ5LXRlbXBsYXRlIiwKICAgICAgICAgICAgICAgICJ0ZXh0L3gtanF1ZXJ5LXRtcGwiCiAgICAgICAgICAgIF07CiAgICAgICAgfSwKCiAgICAgICAgZG9Db21waWxlOiBmdW5jdGlvbihjYWNoZUtleSwgaHRtbCwgY2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0cnkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgJC50ZW1wbGF0ZShjYWNoZUtleSwgaHRtbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2F0Y2ggKGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKGUpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBBbHBhY2EuVGVtcGxhdGVDYWNoZVtjYWNoZUtleV0gPSBodG1sOwoKICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICB9LAoKICAgICAgICBkb0V4ZWN1dGU6IGZ1bmN0aW9uKGNhY2hlS2V5LCBtb2RlbCwgY2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICAvLyByZW5kZXIgdGVtcGxhdGUKICAgICAgICAgICAgdmFyIGh0bWwgPSBudWxsOwogICAgICAgICAgICB0cnkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGRvbSA9ICQudG1wbChjYWNoZUtleSwgbW9kZWwpOwoKICAgICAgICAgICAgICAgIC8vIGNvbnZlcnQgdG8gc3RyaW5nCiAgICAgICAgICAgICAgICB2YXIgX2h0bWwgPSBkb20ub3V0ZXJIVE1MKCk7CgogICAgICAgICAgICAgICAgLy8gc3RyaXAgb3V0IHRoZSBfdG1wbGl0ZW0gYXR0cmlidXRlIGlmIGl0IGlzIHN0aWNraW5nIGFyb3VuZCBhbnl3aGVyZQogICAgICAgICAgICAgICAgdmFyIGkgPSAtMTsKICAgICAgICAgICAgICAgIGRvCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaSA9IF9odG1sLmluZGV4T2YoIl90bXBsaXRlbT0iKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaSA+IC0xKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGogPSBfaHRtbC5pbmRleE9mKCIgIiwgaSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqID09IC0xKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqID0gX2h0bWwuaW5kZXhPZigiPiIsIGkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqID09IC0xKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBtYWtlIHN1cmUgd2UgZG9uJ3Qgd2FuZGVyIG9mZiBpbnRvIGFuIGluZmluaXRlIGxvb3AKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVzc2FnZSI6ICJTaG91bGQgaGF2ZSBmb3VuZCBjbG9zaW5nIHdoaXRlc3BhY2Ugb3IgJz4nIGZvciBfdG1wbGl0ZW0gYXR0cmlidXRlIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIF9odG1sID0gX2h0bWwuc3Vic3RyaW5nKDAsIGkpICsgX2h0bWwuc3Vic3RyaW5nKGopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHdoaWxlIChpID4gLTEpOwoKICAgICAgICAgICAgICAgIC8vIGNvbnZlcnQgYmFjayB0byBkb20gc2FmZWx5IChJRSBidWcgcmVzaXN0YW50KQogICAgICAgICAgICAgICAgZG9tID0gQWxwYWNhLnNhZmVEb21QYXJzZShfaHRtbCk7CgogICAgICAgICAgICAgICAgaHRtbCA9IGRvbTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXRjaCAoZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2FsbGJhY2soewogICAgICAgICAgICAgICAgICAgICJtZXNzYWdlIjogZS5tZXNzYWdlCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGh0bWw7CiAgICAgICAgfSwKCiAgICAgICAgaXNDYWNoZWQ6IGZ1bmN0aW9uKGNhY2hlS2V5KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIChBbHBhY2EuVGVtcGxhdGVDYWNoZVtjYWNoZUtleV0gPyB0cnVlIDogZmFsc2UpOwogICAgICAgIH0KCiAgICB9KTsKCiAgICAvLyBhdXRvIHJlZ2lzdGVyCiAgICBBbHBhY2EuVGVtcGxhdGVFbmdpbmVSZWdpc3RyeS5yZWdpc3RlcigidG1wbCIsIG5ldyBBbHBhY2EuSlF1ZXJ5VGVtcGxhdGVFbmdpbmUoInRtcGwiKSk7Cgp9KShqUXVlcnkpOyhmdW5jdGlvbigkKQp7CiAgICBBbHBhY2EuRUpTVGVtcGxhdGVFbmdpbmUgPSBBbHBhY2EuQWJzdHJhY3RUZW1wbGF0ZUVuZ2luZS5leHRlbmQoCiAgICB7CiAgICAgICAgZmlsZUV4dGVuc2lvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiZWpzIjsKICAgICAgICB9LAoKICAgICAgICBzdXBwb3J0ZWRNaW1ldHlwZXM6IGZ1bmN0aW9uKCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICAidGV4dC94LWVqcy10ZW1wbGF0ZSIsCiAgICAgICAgICAgICAgICAidGV4dC94LWVqcy10bXBsIgogICAgICAgICAgICBdOwogICAgICAgIH0sCgogICAgICAgIGRvQ29tcGlsZTogZnVuY3Rpb24oY2FjaGVLZXksIGh0bWwsIGNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGVqcyA9IG51bGw7CiAgICAgICAgICAgIHRyeQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlanMgPSBuZXcgRUpTKHsKICAgICAgICAgICAgICAgICAgICBuYW1lOiBjYWNoZUtleSwKICAgICAgICAgICAgICAgICAgICB0ZXh0OiBodG1sCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXRjaCAoZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2FsbGJhY2soZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIEFscGFjYS5UZW1wbGF0ZUNhY2hlW2NhY2hlS2V5XSA9IGVqczsKCiAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgfSwKCiAgICAgICAgZG9FeGVjdXRlOiBmdW5jdGlvbihjYWNoZUtleSwgbW9kZWwsIGNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGVqcyA9IEFscGFjYS5UZW1wbGF0ZUNhY2hlW2NhY2hlS2V5XTsKCiAgICAgICAgICAgIC8vIHJlbmRlciB0ZW1wbGF0ZQogICAgICAgICAgICB2YXIgaHRtbCA9IG51bGw7CiAgICAgICAgICAgIHRyeQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBodG1sID0gZWpzLnJlbmRlcihtb2RlbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2F0Y2ggKGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKGUpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBodG1sOwogICAgICAgIH0sCgogICAgICAgIGlzQ2FjaGVkOiBmdW5jdGlvbihjYWNoZUtleSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiAoQWxwYWNhLlRlbXBsYXRlQ2FjaGVbY2FjaGVLZXldID8gdHJ1ZSA6IGZhbHNlKTsKICAgICAgICB9CgogICAgfSk7CgogICAgLy8gYXV0byByZWdpc3RlcgogICAgQWxwYWNhLlRlbXBsYXRlRW5naW5lUmVnaXN0cnkucmVnaXN0ZXIoImVqcyIsIG5ldyBBbHBhY2EuRUpTVGVtcGxhdGVFbmdpbmUoImVqcyIpKTsKCn0pKGpRdWVyeSk7KGZ1bmN0aW9uKCQpCnsKICAgIEFscGFjYS5IYW5kbGViYXJzVGVtcGxhdGVFbmdpbmUgPSBBbHBhY2EuQWJzdHJhY3RUZW1wbGF0ZUVuZ2luZS5leHRlbmQoCiAgICB7CiAgICAgICAgZmlsZUV4dGVuc2lvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiaHRtbCI7CiAgICAgICAgfSwKCiAgICAgICAgc3VwcG9ydGVkTWltZXR5cGVzOiBmdW5jdGlvbigpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgInRleHQveC1oYW5kbGViYXJzLXRlbXBsYXRlIiwKICAgICAgICAgICAgICAgICJ0ZXh0L3gtaGFuZGxlYmFycy10bXBsIgogICAgICAgICAgICBdOwogICAgICAgIH0sCgogICAgICAgIGRvQ29tcGlsZTogZnVuY3Rpb24oY2FjaGVLZXksIGh0bWwsIGNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gbnVsbDsKICAgICAgICAgICAgdHJ5CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRlbXBsYXRlID0gSGFuZGxlYmFycy5jb21waWxlKGh0bWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoIChlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjYWxsYmFjayhlKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgQWxwYWNhLlRlbXBsYXRlQ2FjaGVbY2FjaGVLZXldID0gdGVtcGxhdGU7CgogICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgIH0sCgogICAgICAgIGRvRXhlY3V0ZTogZnVuY3Rpb24oY2FjaGVLZXksIG1vZGVsLCBjYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IEFscGFjYS5UZW1wbGF0ZUNhY2hlW2NhY2hlS2V5XTsKCiAgICAgICAgICAgIC8vIHJlbmRlciB0ZW1wbGF0ZQogICAgICAgICAgICB2YXIgaHRtbCA9IG51bGw7CiAgICAgICAgICAgIHRyeQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBodG1sID0gdGVtcGxhdGUobW9kZWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoIChlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjYWxsYmFjayhlKTsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gaHRtbDsKICAgICAgICB9LAoKICAgICAgICBpc0NhY2hlZDogZnVuY3Rpb24oY2FjaGVLZXkpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gKEFscGFjYS5UZW1wbGF0ZUNhY2hlW2NhY2hlS2V5XSA/IHRydWUgOiBmYWxzZSk7CiAgICAgICAgfQoKICAgIH0pOwoKICAgIC8vIGF1dG8gcmVnaXN0ZXIKICAgIEFscGFjYS5UZW1wbGF0ZUVuZ2luZVJlZ2lzdHJ5LnJlZ2lzdGVyKCJoYW5kbGViYXJzIiwgbmV3IEFscGFjYS5IYW5kbGViYXJzVGVtcGxhdGVFbmdpbmUoImhhbmRsZWJhcnMiKSk7Cgp9KShqUXVlcnkpOy8qKgogKiBEZWZpbmVzIHRoZSBiYXNlIGNsYXNzIGltcGxlbWVudGF0aW9uIGZvciB2aWV3cy4gIEFsbCB2aWV3cyBpbiBBbHBhY2EgdWx0aW1hdGVseSBleHRlbmQgdGhpcyBmb3JtLgogKiBUaGlzIHByb3ZpZGVzIHRoZSBpZGVhbCBwbGFjZSBmb3IgYW55IGdsb2JhbCBvdmVycmlkZXMgb2YgdmlldyB0ZW1wbGF0ZXMsIG1lc3NhZ2UgYnVuZGxlcyBvciBvdGhlciBzZXR0aW5ncy4KICovCihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5zdHlsZUluamVjdGlvbnMgPSB7fTsKCiAgICBBbHBhY2EucmVnaXN0ZXJWaWV3KHsKICAgICAgICAiaWQiOiAiVklFV19CQVNFIiwKICAgICAgICAidGl0bGUiOiAiQWJzdHJhY3QgYmFzZSB2aWV3IiwKICAgICAgICAiZGVzY3JpcHRpb24iOiAiRm91bmRhdGlvbiB2aWV3IHdoaWNoIHByb3ZpZGVzIGFuIGFic3RyYWN0IHZpZXcgZnJvbSB3aGljaCBhbGwgb3RoZXIgdmlld3MgZXh0ZW5kLiIsCiAgICAgICAgIm1lc3NhZ2VzIjogewogICAgICAgICAgICAiY291bnRyaWVzIjogewogICAgICAgICAgICAgICAgImFmZyI6IkFmZ2hhbmlzdGFuIiwKICAgICAgICAgICAgICAgICJhbGEiOiJBbGFuZCBJc2xhbmRzIiwKICAgICAgICAgICAgICAgICJhbGIiOiJBbGJhbmlhIiwKICAgICAgICAgICAgICAgICJkemEiOiJBbGdlcmlhIiwKICAgICAgICAgICAgICAgICJhc20iOiJBbWVyaWNhbiBTYW1vYSIsCiAgICAgICAgICAgICAgICAiYW5kIjoiQW5kb3JyYSIsCiAgICAgICAgICAgICAgICAiYWdvIjoiQW5nb2xhIiwKICAgICAgICAgICAgICAgICJhaWEiOiJBbmd1aWxsYSIsCiAgICAgICAgICAgICAgICAiYXRhIjoiQW50YXJjdGljYSIsCiAgICAgICAgICAgICAgICAiYXRnIjoiQW50aWd1YSBhbmQgQmFyYnVkYSIsCiAgICAgICAgICAgICAgICAiYXJnIjoiQXJnZW50aW5hIiwKICAgICAgICAgICAgICAgICJhcm0iOiJBcm1lbmlhIiwKICAgICAgICAgICAgICAgICJhYnciOiJBcnViYSIsCiAgICAgICAgICAgICAgICAiYXVzIjoiQXVzdHJhbGlhIiwKICAgICAgICAgICAgICAgICJhdXQiOiJBdXN0cmlhIiwKICAgICAgICAgICAgICAgICJhemUiOiJBemVyYmFpamFuIiwKICAgICAgICAgICAgICAgICJiaHMiOiJCYWhhbWFzIiwKICAgICAgICAgICAgICAgICJiaHIiOiJCYWhyYWluIiwKICAgICAgICAgICAgICAgICJiZ2QiOiJCYW5nbGFkZXNoIiwKICAgICAgICAgICAgICAgICJicmIiOiJCYXJiYWRvcyIsCiAgICAgICAgICAgICAgICAiYmxyIjoiQmVsYXJ1cyIsCiAgICAgICAgICAgICAgICAiYmVsIjoiQmVsZ2l1bSIsCiAgICAgICAgICAgICAgICAiYmx6IjoiQmVsaXplIiwKICAgICAgICAgICAgICAgICJiZW4iOiJCZW5pbiIsCiAgICAgICAgICAgICAgICAiYm11IjoiQmVybXVkYSIsCiAgICAgICAgICAgICAgICAiYnRuIjoiQmh1dGFuIiwKICAgICAgICAgICAgICAgICJib2wiOiJCb2xpdmlhIiwKICAgICAgICAgICAgICAgICJiaWgiOiJCb3NuaWEgYW5kIEhlcnplZ292aW5hIiwKICAgICAgICAgICAgICAgICJid2EiOiJCb3Rzd2FuYSIsCiAgICAgICAgICAgICAgICAiYnZ0IjoiQm91dmV0IElzbGFuZCIsCiAgICAgICAgICAgICAgICAiYnJhIjoiQnJhemlsIiwKICAgICAgICAgICAgICAgICJpb3QiOiJCcml0aXNoIEluZGlhbiBPY2VhbiBUZXJyaXRvcnkiLAogICAgICAgICAgICAgICAgImJybiI6IkJydW5laSBEYXJ1c3NhbGFtIiwKICAgICAgICAgICAgICAgICJiZ3IiOiJCdWxnYXJpYSIsCiAgICAgICAgICAgICAgICAiYmZhIjoiQnVya2luYSBGYXNvIiwKICAgICAgICAgICAgICAgICJiZGkiOiJCdXJ1bmRpIiwKICAgICAgICAgICAgICAgICJraG0iOiJDYW1ib2RpYSIsCiAgICAgICAgICAgICAgICAiY21yIjoiQ2FtZXJvb24iLAogICAgICAgICAgICAgICAgImNhbiI6IkNhbmFkYSIsCiAgICAgICAgICAgICAgICAiY3B2IjoiQ2FwZSBWZXJkZSIsCiAgICAgICAgICAgICAgICAiY3ltIjoiQ2F5bWFuIElzbGFuZHMiLAogICAgICAgICAgICAgICAgImNhZiI6IkNlbnRyYWwgQWZyaWNhbiBSZXB1YmxpYyIsCiAgICAgICAgICAgICAgICAidGNkIjoiQ2hhZCIsCiAgICAgICAgICAgICAgICAiY2hsIjoiQ2hpbGUiLAogICAgICAgICAgICAgICAgImNobiI6IkNoaW5hIiwKICAgICAgICAgICAgICAgICJjeHIiOiJDaHJpc3RtYXMgSXNsYW5kIiwKICAgICAgICAgICAgICAgICJjY2siOiJDb2NvcyAoS2VlbGluZyksIElzbGFuZHMiLAogICAgICAgICAgICAgICAgImNvbCI6IkNvbG9tYmlhIiwKICAgICAgICAgICAgICAgICJjb20iOiJDb21vcm9zIiwKICAgICAgICAgICAgICAgICJjb2ciOiJDb25nbyIsCiAgICAgICAgICAgICAgICAiY29kIjoiQ29uZ28sIHRoZSBEZW1vY3JhdGljIFJlcHVibGljIG9mIHRoZSIsCiAgICAgICAgICAgICAgICAiY29rIjoiQ29vayBJc2xhbmRzIiwKICAgICAgICAgICAgICAgICJjcmkiOiJDb3N0YSBSaWNhIiwKICAgICAgICAgICAgICAgICJocnYiOiJDcm9hdGlhIiwKICAgICAgICAgICAgICAgICJjdWIiOiJDdWJhIiwKICAgICAgICAgICAgICAgICJjeXAiOiJDeXBydXMiLAogICAgICAgICAgICAgICAgImN6ZSI6IkN6ZWNoIFJlcHVibGljIiwKICAgICAgICAgICAgICAgICJjaXYiOiJDb3RlIGQnSXZvaXJlIiwKICAgICAgICAgICAgICAgICJkbmsiOiJEZW5tYXJrIiwKICAgICAgICAgICAgICAgICJkamkiOiJEamlib3V0aSIsCiAgICAgICAgICAgICAgICAiZG1hIjoiRG9taW5pY2EiLAogICAgICAgICAgICAgICAgImRvbSI6IkRvbWluaWNhbiBSZXB1YmxpYyIsCiAgICAgICAgICAgICAgICAiZWN1IjoiRWN1YWRvciIsCiAgICAgICAgICAgICAgICAiZWd5IjoiRWd5cHQiLAogICAgICAgICAgICAgICAgInNsdiI6IkVsIFNhbHZhZG9yIiwKICAgICAgICAgICAgICAgICJnbnEiOiJFcXVhdG9yaWFsIEd1aW5lYSIsCiAgICAgICAgICAgICAgICAiZXJpIjoiRXJpdHJlYSIsCiAgICAgICAgICAgICAgICAiZXN0IjoiRXN0b25pYSIsCiAgICAgICAgICAgICAgICAiZXRoIjoiRXRoaW9waWEiLAogICAgICAgICAgICAgICAgImZsayI6IkZhbGtsYW5kIElzbGFuZHMgKE1hbHZpbmFzKSwiLAogICAgICAgICAgICAgICAgImZybyI6IkZhcm9lIElzbGFuZHMiLAogICAgICAgICAgICAgICAgImZqaSI6IkZpamkiLAogICAgICAgICAgICAgICAgImZpbiI6IkZpbmxhbmQiLAogICAgICAgICAgICAgICAgImZyYSI6IkZyYW5jZSIsCiAgICAgICAgICAgICAgICAiZ3VmIjoiRnJlbmNoIEd1aWFuYSIsCiAgICAgICAgICAgICAgICAicHlmIjoiRnJlbmNoIFBvbHluZXNpYSIsCiAgICAgICAgICAgICAgICAiYXRmIjoiRnJlbmNoIFNvdXRoZXJuIFRlcnJpdG9yaWVzIiwKICAgICAgICAgICAgICAgICJnYWIiOiJHYWJvbiIsCiAgICAgICAgICAgICAgICAiZ21iIjoiR2FtYmlhIiwKICAgICAgICAgICAgICAgICJnZW8iOiJHZW9yZ2lhIiwKICAgICAgICAgICAgICAgICJkZXUiOiJHZXJtYW55IiwKICAgICAgICAgICAgICAgICJnaGEiOiJHaGFuYSIsCiAgICAgICAgICAgICAgICAiZ2liIjoiR2licmFsdGFyIiwKICAgICAgICAgICAgICAgICJncmMiOiJHcmVlY2UiLAogICAgICAgICAgICAgICAgImdybCI6IkdyZWVubGFuZCIsCiAgICAgICAgICAgICAgICAiZ3JkIjoiR3JlbmFkYSIsCiAgICAgICAgICAgICAgICAiZ2xwIjoiR3VhZGVsb3VwZSIsCiAgICAgICAgICAgICAgICAiZ3VtIjoiR3VhbSIsCiAgICAgICAgICAgICAgICAiZ3RtIjoiR3VhdGVtYWxhIiwKICAgICAgICAgICAgICAgICJnZ3kiOiJHdWVybnNleSIsCiAgICAgICAgICAgICAgICAiZ2luIjoiR3VpbmVhIiwKICAgICAgICAgICAgICAgICJnbmIiOiJHdWluZWEtQmlzc2F1IiwKICAgICAgICAgICAgICAgICJndXkiOiJHdXlhbmEiLAogICAgICAgICAgICAgICAgImh0aSI6IkhhaXRpIiwKICAgICAgICAgICAgICAgICJobWQiOiJIZWFyZCBJc2xhbmQgYW5kIE1jRG9uYWxkIElzbGFuZHMiLAogICAgICAgICAgICAgICAgInZhdCI6IkhvbHkgU2VlIChWYXRpY2FuIENpdHkgU3RhdGUpLCIsCiAgICAgICAgICAgICAgICAiaG5kIjoiSG9uZHVyYXMiLAogICAgICAgICAgICAgICAgImhrZyI6IkhvbmcgS29uZyIsCiAgICAgICAgICAgICAgICAiaHVuIjoiSHVuZ2FyeSIsCiAgICAgICAgICAgICAgICAiaXNsIjoiSWNlbGFuZCIsCiAgICAgICAgICAgICAgICAiaW5kIjoiSW5kaWEiLAogICAgICAgICAgICAgICAgImlkbiI6IkluZG9uZXNpYSIsCiAgICAgICAgICAgICAgICAiaXJuIjoiSXJhbiwgSXNsYW1pYyBSZXB1YmxpYyBvZiIsCiAgICAgICAgICAgICAgICAiaXJxIjoiSXJhcSIsCiAgICAgICAgICAgICAgICAiaXJsIjoiSXJlbGFuZCIsCiAgICAgICAgICAgICAgICAiaW1uIjoiSXNsZSBvZiBNYW4iLAogICAgICAgICAgICAgICAgImlzciI6IklzcmFlbCIsCiAgICAgICAgICAgICAgICAiaXRhIjoiSXRhbHkiLAogICAgICAgICAgICAgICAgImphbSI6IkphbWFpY2EiLAogICAgICAgICAgICAgICAgImpwbiI6IkphcGFuIiwKICAgICAgICAgICAgICAgICJqZXkiOiJKZXJzZXkiLAogICAgICAgICAgICAgICAgImpvciI6IkpvcmRhbiIsCiAgICAgICAgICAgICAgICAia2F6IjoiS2F6YWtoc3RhbiIsCiAgICAgICAgICAgICAgICAia2VuIjoiS2VueWEiLAogICAgICAgICAgICAgICAgImtpciI6IktpcmliYXRpIiwKICAgICAgICAgICAgICAgICJwcmsiOiJLb3JlYSwgRGVtb2NyYXRpYyBQZW9wbGUncyBSZXB1YmxpYyBvZiIsCiAgICAgICAgICAgICAgICAia29yIjoiS29yZWEsIFJlcHVibGljIG9mIiwKICAgICAgICAgICAgICAgICJrd3QiOiJLdXdhaXQiLAogICAgICAgICAgICAgICAgImtneiI6Ikt5cmd5enN0YW4iLAogICAgICAgICAgICAgICAgImxhbyI6IkxhbyBQZW9wbGUncyBEZW1vY3JhdGljIFJlcHVibGljIiwKICAgICAgICAgICAgICAgICJsdmEiOiJMYXR2aWEiLAogICAgICAgICAgICAgICAgImxibiI6IkxlYmFub24iLAogICAgICAgICAgICAgICAgImxzbyI6Ikxlc290aG8iLAogICAgICAgICAgICAgICAgImxiciI6IkxpYmVyaWEiLAogICAgICAgICAgICAgICAgImxieSI6IkxpYnlhbiBBcmFiIEphbWFoaXJpeWEiLAogICAgICAgICAgICAgICAgImxpZSI6IkxpZWNodGVuc3RlaW4iLAogICAgICAgICAgICAgICAgImx0dSI6IkxpdGh1YW5pYSIsCiAgICAgICAgICAgICAgICAibHV4IjoiTHV4ZW1ib3VyZyIsCiAgICAgICAgICAgICAgICAibWFjIjoiTWFjYW8iLAogICAgICAgICAgICAgICAgIm1rZCI6Ik1hY2Vkb25pYSwgdGhlIGZvcm1lciBZdWdvc2xhdiBSZXB1YmxpYyBvZiIsCiAgICAgICAgICAgICAgICAibWRnIjoiTWFkYWdhc2NhciIsCiAgICAgICAgICAgICAgICAibXdpIjoiTWFsYXdpIiwKICAgICAgICAgICAgICAgICJteXMiOiJNYWxheXNpYSIsCiAgICAgICAgICAgICAgICAibWR2IjoiTWFsZGl2ZXMiLAogICAgICAgICAgICAgICAgIm1saSI6Ik1hbGkiLAogICAgICAgICAgICAgICAgIm1sdCI6Ik1hbHRhIiwKICAgICAgICAgICAgICAgICJtaGwiOiJNYXJzaGFsbCBJc2xhbmRzIiwKICAgICAgICAgICAgICAgICJtdHEiOiJNYXJ0aW5pcXVlIiwKICAgICAgICAgICAgICAgICJtcnQiOiJNYXVyaXRhbmlhIiwKICAgICAgICAgICAgICAgICJtdXMiOiJNYXVyaXRpdXMiLAogICAgICAgICAgICAgICAgIm15dCI6Ik1heW90dGUiLAogICAgICAgICAgICAgICAgIm1leCI6Ik1leGljbyIsCiAgICAgICAgICAgICAgICAiZnNtIjoiTWljcm9uZXNpYSwgRmVkZXJhdGVkIFN0YXRlcyBvZiIsCiAgICAgICAgICAgICAgICAibWRhIjoiTW9sZG92YSwgUmVwdWJsaWMgb2YiLAogICAgICAgICAgICAgICAgIm1jbyI6Ik1vbmFjbyIsCiAgICAgICAgICAgICAgICAibW5nIjoiTW9uZ29saWEiLAogICAgICAgICAgICAgICAgIm1uZSI6Ik1vbnRlbmVncm8iLAogICAgICAgICAgICAgICAgIm1zciI6Ik1vbnRzZXJyYXQiLAogICAgICAgICAgICAgICAgIm1hciI6Ik1vcm9jY28iLAogICAgICAgICAgICAgICAgIm1veiI6Ik1vemFtYmlxdWUiLAogICAgICAgICAgICAgICAgIm1tciI6Ik15YW5tYXIiLAogICAgICAgICAgICAgICAgIm5hbSI6Ik5hbWliaWEiLAogICAgICAgICAgICAgICAgIm5ydSI6Ik5hdXJ1IiwKICAgICAgICAgICAgICAgICJucGwiOiJOZXBhbCIsCiAgICAgICAgICAgICAgICAibmxkIjoiTmV0aGVybGFuZHMiLAogICAgICAgICAgICAgICAgImFudCI6Ik5ldGhlcmxhbmRzIEFudGlsbGVzIiwKICAgICAgICAgICAgICAgICJuY2wiOiJOZXcgQ2FsZWRvbmlhIiwKICAgICAgICAgICAgICAgICJuemwiOiJOZXcgWmVhbGFuZCIsCiAgICAgICAgICAgICAgICAibmljIjoiTmljYXJhZ3VhIiwKICAgICAgICAgICAgICAgICJuZXIiOiJOaWdlciIsCiAgICAgICAgICAgICAgICAibmdhIjoiTmlnZXJpYSIsCiAgICAgICAgICAgICAgICAibml1IjoiTml1ZSIsCiAgICAgICAgICAgICAgICAibmZrIjoiTm9yZm9sayBJc2xhbmQiLAogICAgICAgICAgICAgICAgIm1ucCI6Ik5vcnRoZXJuIE1hcmlhbmEgSXNsYW5kcyIsCiAgICAgICAgICAgICAgICAibm9yIjoiTm9yd2F5IiwKICAgICAgICAgICAgICAgICJvbW4iOiJPbWFuIiwKICAgICAgICAgICAgICAgICJwYWsiOiJQYWtpc3RhbiIsCiAgICAgICAgICAgICAgICAicGx3IjoiUGFsYXUiLAogICAgICAgICAgICAgICAgInBzZSI6IlBhbGVzdGluaWFuIFRlcnJpdG9yeSwgT2NjdXBpZWQiLAogICAgICAgICAgICAgICAgInBhbiI6IlBhbmFtYSIsCiAgICAgICAgICAgICAgICAicG5nIjoiUGFwdWEgTmV3IEd1aW5lYSIsCiAgICAgICAgICAgICAgICAicHJ5IjoiUGFyYWd1YXkiLAogICAgICAgICAgICAgICAgInBlciI6IlBlcnUiLAogICAgICAgICAgICAgICAgInBobCI6IlBoaWxpcHBpbmVzIiwKICAgICAgICAgICAgICAgICJwY24iOiJQaXRjYWlybiIsCiAgICAgICAgICAgICAgICAicG9sIjoiUG9sYW5kIiwKICAgICAgICAgICAgICAgICJwcnQiOiJQb3J0dWdhbCIsCiAgICAgICAgICAgICAgICAicHJpIjoiUHVlcnRvIFJpY28iLAogICAgICAgICAgICAgICAgInFhdCI6IlFhdGFyIiwKICAgICAgICAgICAgICAgICJyb3UiOiJSb21hbmlhIiwKICAgICAgICAgICAgICAgICJydXMiOiJSdXNzaWFuIEZlZGVyYXRpb24iLAogICAgICAgICAgICAgICAgInJ3YSI6IlJ3YW5kYSIsCiAgICAgICAgICAgICAgICAicmV1IjoiUmV1bmlvbiIsCiAgICAgICAgICAgICAgICAiYmxtIjoiU2FpbnQgQmFydGhlbGVteSIsCiAgICAgICAgICAgICAgICAic2huIjoiU2FpbnQgSGVsZW5hIiwKICAgICAgICAgICAgICAgICJrbmEiOiJTYWludCBLaXR0cyBhbmQgTmV2aXMiLAogICAgICAgICAgICAgICAgImxjYSI6IlNhaW50IEx1Y2lhIiwKICAgICAgICAgICAgICAgICJtYWYiOiJTYWludCBNYXJ0aW4gKEZyZW5jaCBwYXJ0KSIsCiAgICAgICAgICAgICAgICAic3BtIjoiU2FpbnQgUGllcnJlIGFuZCBNaXF1ZWxvbiIsCiAgICAgICAgICAgICAgICAidmN0IjoiU2FpbnQgVmluY2VudCBhbmQgdGhlIEdyZW5hZGluZXMiLAogICAgICAgICAgICAgICAgIndzbSI6IlNhbW9hIiwKICAgICAgICAgICAgICAgICJzbXIiOiJTYW4gTWFyaW5vIiwKICAgICAgICAgICAgICAgICJzdHAiOiJTYW8gVG9tZSBhbmQgUHJpbmNpcGUiLAogICAgICAgICAgICAgICAgInNhdSI6IlNhdWRpIEFyYWJpYSIsCiAgICAgICAgICAgICAgICAic2VuIjoiU2VuZWdhbCIsCiAgICAgICAgICAgICAgICAic3JiIjoiU2VyYmlhIiwKICAgICAgICAgICAgICAgICJzeWMiOiJTZXljaGVsbGVzIiwKICAgICAgICAgICAgICAgICJzbGUiOiJTaWVycmEgTGVvbmUiLAogICAgICAgICAgICAgICAgInNncCI6IlNpbmdhcG9yZSIsCiAgICAgICAgICAgICAgICAic3ZrIjoiU2xvdmFraWEiLAogICAgICAgICAgICAgICAgInN2biI6IlNsb3ZlbmlhIiwKICAgICAgICAgICAgICAgICJzbGIiOiJTb2xvbW9uIElzbGFuZHMiLAogICAgICAgICAgICAgICAgInNvbSI6IlNvbWFsaWEiLAogICAgICAgICAgICAgICAgInphZiI6IlNvdXRoIEFmcmljYSIsCiAgICAgICAgICAgICAgICAic2dzIjoiU291dGggR2VvcmdpYSBhbmQgdGhlIFNvdXRoIFNhbmR3aWNoIElzbGFuZHMiLAogICAgICAgICAgICAgICAgImVzcCI6IlNwYWluIiwKICAgICAgICAgICAgICAgICJsa2EiOiJTcmkgTGFua2EiLAogICAgICAgICAgICAgICAgInNkbiI6IlN1ZGFuIiwKICAgICAgICAgICAgICAgICJzdXIiOiJTdXJpbmFtZSIsCiAgICAgICAgICAgICAgICAic2ptIjoiU3ZhbGJhcmQgYW5kIEphbiBNYXllbiIsCiAgICAgICAgICAgICAgICAic3d6IjoiU3dhemlsYW5kIiwKICAgICAgICAgICAgICAgICJzd2UiOiJTd2VkZW4iLAogICAgICAgICAgICAgICAgImNoZSI6IlN3aXR6ZXJsYW5kIiwKICAgICAgICAgICAgICAgICJzeXIiOiJTeXJpYW4gQXJhYiBSZXB1YmxpYyIsCiAgICAgICAgICAgICAgICAidHduIjoiVGFpd2FuLCBQcm92aW5jZSBvZiBDaGluYSIsCiAgICAgICAgICAgICAgICAidGprIjoiVGFqaWtpc3RhbiIsCiAgICAgICAgICAgICAgICAidHphIjoiVGFuemFuaWEsIFVuaXRlZCBSZXB1YmxpYyBvZiIsCiAgICAgICAgICAgICAgICAidGhhIjoiVGhhaWxhbmQiLAogICAgICAgICAgICAgICAgInRscyI6IlRpbW9yLUxlc3RlIiwKICAgICAgICAgICAgICAgICJ0Z28iOiJUb2dvIiwKICAgICAgICAgICAgICAgICJ0a2wiOiJUb2tlbGF1IiwKICAgICAgICAgICAgICAgICJ0b24iOiJUb25nYSIsCiAgICAgICAgICAgICAgICAidHRvIjoiVHJpbmlkYWQgYW5kIFRvYmFnbyIsCiAgICAgICAgICAgICAgICAidHVuIjoiVHVuaXNpYSIsCiAgICAgICAgICAgICAgICAidHVyIjoiVHVya2V5IiwKICAgICAgICAgICAgICAgICJ0a20iOiJUdXJrbWVuaXN0YW4iLAogICAgICAgICAgICAgICAgInRjYSI6IlR1cmtzIGFuZCBDYWljb3MgSXNsYW5kcyIsCiAgICAgICAgICAgICAgICAidHV2IjoiVHV2YWx1IiwKICAgICAgICAgICAgICAgICJ1Z2EiOiJVZ2FuZGEiLAogICAgICAgICAgICAgICAgInVrciI6IlVrcmFpbmUiLAogICAgICAgICAgICAgICAgImFyZSI6IlVuaXRlZCBBcmFiIEVtaXJhdGVzIiwKICAgICAgICAgICAgICAgICJnYnIiOiJVbml0ZWQgS2luZ2RvbSIsCiAgICAgICAgICAgICAgICAidXNhIjoiVW5pdGVkIFN0YXRlcyIsCiAgICAgICAgICAgICAgICAidW1pIjoiVW5pdGVkIFN0YXRlcyBNaW5vciBPdXRseWluZyBJc2xhbmRzIiwKICAgICAgICAgICAgICAgICJ1cnkiOiJVcnVndWF5IiwKICAgICAgICAgICAgICAgICJ1emIiOiJVemJla2lzdGFuIiwKICAgICAgICAgICAgICAgICJ2dXQiOiJWYW51YXR1IiwKICAgICAgICAgICAgICAgICJ2ZW4iOiJWZW5lenVlbGEiLAogICAgICAgICAgICAgICAgInZubSI6IlZpZXQgTmFtIiwKICAgICAgICAgICAgICAgICJ2Z2IiOiJWaXJnaW4gSXNsYW5kcywgQnJpdGlzaCIsCiAgICAgICAgICAgICAgICAidmlyIjoiVmlyZ2luIElzbGFuZHMsIFUuUy4iLAogICAgICAgICAgICAgICAgIndsZiI6IldhbGxpcyBhbmQgRnV0dW5hIiwKICAgICAgICAgICAgICAgICJlc2giOiJXZXN0ZXJuIFNhaGFyYSIsCiAgICAgICAgICAgICAgICAieWVtIjoiWWVtZW4iLAogICAgICAgICAgICAgICAgInptYiI6IlphbWJpYSIsCiAgICAgICAgICAgICAgICAiendlIjoiWmltYmFid2UiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJlbXB0eSI6ICIiLAogICAgICAgICAgICAicmVxdWlyZWQiOiAiVGhpcyBmaWVsZCBpcyByZXF1aXJlZCIsCiAgICAgICAgICAgICJ2YWxpZCI6ICIiLAogICAgICAgICAgICAiaW52YWxpZCI6ICJUaGlzIGZpZWxkIGlzIGludmFsaWQiLAogICAgICAgICAgICAibW9udGhzIjogWyJKYW51YXJ5IiwgIkZlYnJ1YXJ5IiwgIk1hcmNoIiwgIkFwcmlsIiwgIk1heSIsICJKdW5lIiwgIkp1bHkiLCAiQXVndXN0IiwgIlNlcHRlbWJlciIsICJPY3RvYmVyIiwgIk5vdmVtYmVyIiwgIkRlY2VtYmVyIl0sCiAgICAgICAgICAgICJ0aW1lVW5pdHMiOiB7IFNFQ09ORDogInNlY29uZHMiLCBNSU5VVEU6ICJtaW51dGVzIiwgSE9VUjogImhvdXJzIiwgREFZOiAiZGF5cyIsIE1PTlRIOiAibW9udGhzIiwgWUVBUjogInllYXJzIiB9CiAgICAgICAgfQogICAgfSk7CgogICAgLyoKICAgIEFscGFjYS5FbXB0eVZpZXdUZW1wbGF0ZXMgPSB7CiAgICAgICAgJ2NvbnRyb2xGaWVsZE91dGVyRWwnOiAne3todG1sIHRoaXMuaHRtbH19JywKICAgICAgICAnY29udHJvbEZpZWxkTWVzc2FnZSc6ICcke21lc3NhZ2V9JywKICAgICAgICAnY29udHJvbEZpZWxkTGFiZWwnOiAne3tpZiBvcHRpb25zLmxhYmVsfX0ke29wdGlvbnMubGFiZWx9e3svaWZ9fScsCiAgICAgICAgJ2NvbnRyb2xGaWVsZEhlbHBlcic6ICd7e2lmIG9wdGlvbnMuaGVscGVyfX0ke29wdGlvbnMuaGVscGVyfXt7L2lmfX0nLAogICAgICAgICdjb250cm9sRmllbGRDb250YWluZXInOiAne3todG1sIHRoaXMuaHRtbH19JywKICAgICAgICAnY29udHJvbEZpZWxkJzogJ3t7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiY29udHJvbEZpZWxkT3V0ZXJFbCIsdHJ1ZSl9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJjb250cm9sRmllbGRMYWJlbCIpfX17e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImNvbnRyb2xGaWVsZENvbnRhaW5lciIsdHJ1ZSl9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJjb250cm9sRmllbGRIZWxwZXIiKX19e3svd3JhcH19e3svd3JhcH19JywKICAgICAgICAnZmllbGRTZXRPdXRlckVsJzogJ3t7aHRtbCB0aGlzLmh0bWx9fScsCiAgICAgICAgJ2ZpZWxkU2V0TWVzc2FnZSc6ICcke21lc3NhZ2V9JywKICAgICAgICAnZmllbGRTZXRMZWdlbmQnOiAne3tpZiBvcHRpb25zLmxhYmVsfX0ke29wdGlvbnMubGFiZWx9e3svaWZ9fScsCiAgICAgICAgJ2ZpZWxkU2V0SGVscGVyJzogJ3t7aWYgb3B0aW9ucy5oZWxwZXJ9fSR7b3B0aW9ucy5oZWxwZXJ9e3svaWZ9fScsCiAgICAgICAgJ2ZpZWxkU2V0SXRlbXNDb250YWluZXInOiAne3todG1sIHRoaXMuaHRtbH19JywKICAgICAgICAnZmllbGRTZXQnOiAne3t3cmFwKG51bGwsIHt9KSBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmaWVsZFNldE91dGVyRWwiLHRydWUpfX17e2h0bWwgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiZmllbGRTZXRMZWdlbmQiKX19e3t3cmFwKG51bGwsIHt9KUFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0SXRlbXNDb250YWluZXIiLHRydWUpfX17ey93cmFwfX17ey93cmFwfX0nLAogICAgICAgICdmaWVsZFNldEl0ZW1Db250YWluZXInOiAnJywKICAgICAgICAnZm9ybUZpZWxkc0NvbnRhaW5lcic6ICd7e2h0bWwgdGhpcy5odG1sfX0nLAogICAgICAgICdmb3JtQnV0dG9uc0NvbnRhaW5lcic6ICd7e2lmIG9wdGlvbnMuYnV0dG9uc319e3tlYWNoKGssdikgb3B0aW9ucy5idXR0b25zfX08YnV0dG9uIGRhdGEta2V5PSIke2t9IiBjbGFzcz0iYWxwYWNhLWZvcm0tYnV0dG9uIGFscGFjYS1mb3JtLWJ1dHRvbi0ke2t9IiB7e2VhY2goazEsdjEpIHZ9fSR7azF9PSIke3YxfSJ7ey9lYWNofX0+JHt2LnZhbHVlfTwvYnV0dG9uPnt7L2VhY2h9fXt7L2lmfX0nLAogICAgICAgICdmb3JtJzogJzxmb3JtPnt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmb3JtRmllbGRzQ29udGFpbmVyIil9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmb3JtQnV0dG9uc0NvbnRhaW5lciIpfX08L2Zvcm0+JywKICAgICAgICAnd2l6YXJkU3RlcCc6ICcnLAogICAgICAgICd3aXphcmROYXZCYXInOiAnJywKICAgICAgICAnd2l6YXJkUHJlQnV0dG9uJzogJzxidXR0b24+QmFjazwvYnV0dG9uPicsCiAgICAgICAgJ3dpemFyZE5leHRCdXR0b24nOiAnPGJ1dHRvbj5OZXh0PC9idXR0b24+JywKICAgICAgICAnd2l6YXJkRG9uZUJ1dHRvbic6ICc8YnV0dG9uPkRvbmU8L2J1dHRvbj4nLAogICAgICAgICd3aXphcmRTdGF0dXNCYXInOiAnPG9sIGlkPSIke2lkfSI+e3tlYWNoKGksdikgdGl0bGVzfX08bGkgaWQ9InN0ZXBEZXNjJHtpfSI+PGRpdj48c3Ryb25nPjxzcGFuPiR7di50aXRsZX08L3NwYW4+JHt2LmRlc2NyaXB0aW9ufTwvc3Ryb25nPjwvZGl2PjwvbGk+e3svZWFjaH19PC9vbD4nLAogICAgICAgICdhcnJheVRvb2xiYXInOiAnJywKICAgICAgICAnYXJyYXlJdGVtVG9vbGJhcic6ICcnCiAgICB9OwogICAgKi8KICAgIEFscGFjYS5FbXB0eVZpZXdUZW1wbGF0ZXMgPSB7fTsKCn0pKGpRdWVyeSk7KGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLnN0eWxlSW5qZWN0aW9ucyA9IHt9OwoKICAgIHZhciBkaXNwbGF5VGVtcGxhdGVzID0gQWxwYWNhLkNyZWF0ZShBbHBhY2EuRW1wdHlWaWV3VGVtcGxhdGVzLCB7CiAgICAgICAgImNvbnRyb2xGaWVsZCI6ICc8ZGl2IGNsYXNzPSJhbHBhY2EtZGF0YS1jb250YWluZXIiPnt7aWYgb3B0aW9ucy5sYWJlbH19PGRpdiBjbGFzcz0iYWxwYWNhLWRhdGEtbGFiZWwiPiR7b3B0aW9ucy5sYWJlbH08L2Rpdj57ey9pZn19PGRpdiBjbGFzcz0iYWxwYWNhLWRhdGEiPiZuYnNwOyR7ZGF0YX08L2Rpdj48L2Rpdj4nLAogICAgICAgICJmaWVsZFNldE91dGVyRWwiOiAnPGRpdiBjbGFzcz0idWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50Ij57e2h0bWwgdGhpcy5odG1sfX08L2Rpdj4nLAogICAgICAgICJmaWVsZFNldExlZ2VuZCI6ICd7e2lmIG9wdGlvbnMubGFiZWx9fTxkaXYgY2xhc3M9Int7aWYgb3B0aW9ucy5sYWJlbENsYXNzfX0ke29wdGlvbnMubGFiZWxDbGFzc317ey9pZn19Ij4ke29wdGlvbnMubGFiZWx9PC9kaXY+e3svaWZ9fScsCiAgICAgICAgImZpZWxkU2V0SXRlbXNDb250YWluZXIiOiAnPGRpdj57e2h0bWwgdGhpcy5odG1sfX08L2Rpdj4nLAogICAgICAgICJmaWVsZFNldCI6ICd7e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0T3V0ZXJFbCIsdHJ1ZSl9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmaWVsZFNldExlZ2VuZCIpfX17e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0SXRlbXNDb250YWluZXIiLHRydWUpfX17ey93cmFwfX17ey93cmFwfX0nLAogICAgICAgICJjb250cm9sRmllbGRDb250YWluZXIiOiAnPGRpdj57e2h0bWwgdGhpcy5odG1sfX08L2Rpdj4nCiAgICB9KTsKCiAgICB2YXIgZWRpdFRlbXBsYXRlcyA9IEFscGFjYS5DcmVhdGUoQWxwYWNhLkVtcHR5Vmlld1RlbXBsYXRlcywgewogICAgICAgIC8vIFRlbXBsYXRlcyBmb3IgY29udHJvbCBmaWVsZHMKICAgICAgICAiY29udHJvbEZpZWxkT3V0ZXJFbCI6ICc8c3Bhbj57e2h0bWwgdGhpcy5odG1sfX08L3NwYW4+JywKICAgICAgICAiY29udHJvbEZpZWxkTWVzc2FnZSI6ICc8ZGl2PjxzcGFuIGNsYXNzPSJ1aS1pY29uIHVpLWljb24tYWxlcnQiPjwvc3Bhbj48c3BhbiBjbGFzcz0iYWxwYWNhLWNvbnRyb2xmaWVsZC1tZXNzYWdlLXRleHQiPiR7bWVzc2FnZX08L3NwYW4+PC9kaXY+JywKICAgICAgICAiY29udHJvbEZpZWxkTGFiZWwiOiAne3tpZiBvcHRpb25zLmxhYmVsfX08ZGl2IGNsYXNzPSJ7e2lmIG9wdGlvbnMubGFiZWxDbGFzc319JHtvcHRpb25zLmxhYmVsQ2xhc3N9e3svaWZ9fSI+PGRpdj4ke29wdGlvbnMubGFiZWx9PC9kaXY+PC9kaXY+e3svaWZ9fScsCiAgICAgICAgImNvbnRyb2xGaWVsZEhlbHBlciI6ICd7e2lmIG9wdGlvbnMuaGVscGVyfX08ZGl2IGNsYXNzPSJ7e2lmIG9wdGlvbnMuaGVscGVyQ2xhc3N9fSR7b3B0aW9ucy5oZWxwZXJDbGFzc317ey9pZn19Ij48c3BhbiBjbGFzcz0idWktaWNvbiB1aS1pY29uLWluZm8iPjwvc3Bhbj48c3BhbiBjbGFzcz0iYWxwYWNhLWNvbnRyb2xmaWVsZC1oZWxwZXItdGV4dCI+JHtvcHRpb25zLmhlbHBlcn08L3NwYW4+PC9kaXY+e3svaWZ9fScsCiAgICAgICAgImNvbnRyb2xGaWVsZENvbnRhaW5lciI6ICc8ZGl2Pnt7aHRtbCB0aGlzLmh0bWx9fTwvZGl2PicsCiAgICAgICAgImNvbnRyb2xGaWVsZCI6ICd7e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImNvbnRyb2xGaWVsZE91dGVyRWwiLHRydWUpfX17e2h0bWwgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiY29udHJvbEZpZWxkTGFiZWwiKX19e3t3cmFwKG51bGwsIHt9KSBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJjb250cm9sRmllbGRDb250YWluZXIiLHRydWUpfX17e2h0bWwgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiY29udHJvbEZpZWxkSGVscGVyIil9fXt7L3dyYXB9fXt7L3dyYXB9fScsCiAgICAgICAgLy8gVGVtcGxhdGVzIGZvciBjb250YWluZXIgZmllbGRzCiAgICAgICAgImZpZWxkU2V0T3V0ZXJFbCI6ICc8ZmllbGRzZXQ+e3todG1sIHRoaXMuaHRtbH19PC9maWVsZHNldD4nLAogICAgICAgICJmaWVsZFNldE1lc3NhZ2UiOiAnPGRpdj48c3BhbiBjbGFzcz0idWktaWNvbiB1aS1pY29uLWFsZXJ0IiBzdHlsZT0iZmxvYXQ6IGxlZnQ7IG1hcmdpbi1yaWdodDogLjNlbTsiPjwvc3Bhbj48c3Bhbj4ke21lc3NhZ2V9PC9zcGFuPjwvZGl2PicsCiAgICAgICAgImZpZWxkU2V0TGVnZW5kIjogJ3t7aWYgb3B0aW9ucy5sYWJlbH19PGxlZ2VuZCBjbGFzcz0ie3tpZiBvcHRpb25zLmxhYmVsQ2xhc3N9fSR7b3B0aW9ucy5sYWJlbENsYXNzfXt7L2lmfX0iPiR7b3B0aW9ucy5sYWJlbH08L2xlZ2VuZD57ey9pZn19JywKICAgICAgICAiZmllbGRTZXRIZWxwZXIiOiAne3tpZiBvcHRpb25zLmhlbHBlcn19PGRpdiBjbGFzcz0ie3tpZiBvcHRpb25zLmhlbHBlckNsYXNzfX0ke29wdGlvbnMuaGVscGVyQ2xhc3N9e3svaWZ9fSI+JHtvcHRpb25zLmhlbHBlcn08L2Rpdj57ey9pZn19JywKICAgICAgICAiZmllbGRTZXRJdGVtc0NvbnRhaW5lciI6ICc8ZGl2Pnt7aHRtbCB0aGlzLmh0bWx9fTwvZGl2PicsCiAgICAgICAgImZpZWxkU2V0IjogJ3t7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiZmllbGRTZXRPdXRlckVsIix0cnVlKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0TGVnZW5kIil9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmaWVsZFNldEhlbHBlciIpfX17e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0SXRlbXNDb250YWluZXIiLHRydWUpfX17ey93cmFwfX17ey93cmFwfX0nLAogICAgICAgICJmaWVsZFNldEl0ZW1Db250YWluZXIiOiAnPGRpdj48L2Rpdj4nLAogICAgICAgIC8vIFRlbXBsYXRlcyBmb3IgZm9ybQogICAgICAgICJmb3JtRmllbGRzQ29udGFpbmVyIjogJzxkaXY+e3todG1sIHRoaXMuaHRtbH19PC9kaXY+JywKICAgICAgICAiZm9ybUJ1dHRvbnNDb250YWluZXIiOiAnPGRpdj57e2lmIG9wdGlvbnMuYnV0dG9uc319e3tlYWNoKGssdikgb3B0aW9ucy5idXR0b25zfX08YnV0dG9uIGRhdGEta2V5PSIke2t9IiBjbGFzcz0iYWxwYWNhLWZvcm0tYnV0dG9uIGFscGFjYS1mb3JtLWJ1dHRvbi0ke2t9IiB7e2VhY2goazEsdjEpIHZ9fSR7azF9PSIke3YxfSJ7ey9lYWNofX0+JHt2LnZhbHVlfTwvYnV0dG9uPnt7L2VhY2h9fXt7L2lmfX08L2Rpdj4nLAogICAgICAgICJmb3JtIjogJzxmb3JtPnt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmb3JtRmllbGRzQ29udGFpbmVyIil9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmb3JtQnV0dG9uc0NvbnRhaW5lciIpfX08L2Zvcm0+JywKICAgICAgICAvLyBUZW1wbGF0ZXMgZm9yIHdpemFyZAogICAgICAgICJ3aXphcmRTdGVwIiA6ICc8ZGl2IGNsYXNzPSJhbHBhY2EtY2xlYXIiPjwvZGl2PicsCiAgICAgICAgIndpemFyZE5hdkJhciIgOiAnPGRpdj48L2Rpdj4nLAogICAgICAgICJ3aXphcmRQcmVCdXR0b24iIDogJzxidXR0b24+QmFjazwvYnV0dG9uPicsCiAgICAgICAgIndpemFyZE5leHRCdXR0b24iIDogJzxidXR0b24+TmV4dDwvYnV0dG9uPicsCiAgICAgICAgIndpemFyZERvbmVCdXR0b24iIDogJzxidXR0b24+RG9uZTwvYnV0dG9uPicsCiAgICAgICAgIndpemFyZFN0YXR1c0JhciIgOiAnPG9sIGlkPSIke2lkfSI+e3tlYWNoKGksdikgdGl0bGVzfX08bGkgaWQ9InN0ZXBEZXNjJHtpfSI+PGRpdj48c3Ryb25nPjxzcGFuPiR7di50aXRsZX08L3NwYW4+JHt2LmRlc2NyaXB0aW9ufTwvc3Ryb25nPjwvZGl2PjwvbGk+e3svZWFjaH19PC9vbD4nCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJWaWV3KHsKICAgICAgICAiaWQiOiAiVklFV19XRUJfRElTUExBWSIsCiAgICAgICAgInBhcmVudCI6ICJWSUVXX0JBU0UiLAogICAgICAgICJ0aXRsZSI6ICJEZWZhdWx0IFdlYiBEaXNwbGF5IFZpZXciLAogICAgICAgICJkZXNjcmlwdGlvbiI6IkRlZmF1bHQgd2ViIGVkaXQgdmlldyB3aGljaCBnb2VzIHRob3VnaCBmaWVsZCBoaWVyYXJjaHkuIiwKICAgICAgICAidHlwZSI6ICJ2aWV3IiwKICAgICAgICAicGxhdGZvcm0iOiJ3ZWIiLAogICAgICAgICJkaXNwbGF5UmVhZG9ubHkiOnRydWUsCiAgICAgICAgInRlbXBsYXRlcyI6IGRpc3BsYXlUZW1wbGF0ZXMKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3RlclZpZXcoewogICAgICAgICJpZCI6IlZJRVdfV0VCX0VESVQiLAogICAgICAgICJwYXJlbnQiOiAiVklFV19CQVNFIiwKICAgICAgICAidGl0bGUiOiJEZWZhdWx0IFdlYiBFZGl0IFZpZXciLAogICAgICAgICJkZXNjcmlwdGlvbiI6IkRlZmF1bHQgd2ViIGVkaXQgdmlldyB3aGljaCBnb2VzIHRob3VnaCBmaWVsZCBoaWVyYXJjaHkuIiwKICAgICAgICAidHlwZSI6ImVkaXQiLAogICAgICAgICJwbGF0Zm9ybSI6ICJ3ZWIiLAogICAgICAgICJkaXNwbGF5UmVhZG9ubHkiOnRydWUsCiAgICAgICAgInRlbXBsYXRlcyI6IGVkaXRUZW1wbGF0ZXMKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3RlclZpZXcoewogICAgICAgICJpZCI6ICJWSUVXX1dFQl9DUkVBVEUiLAogICAgICAgICJwYXJlbnQiOiAnVklFV19XRUJfRURJVCcsCiAgICAgICAgInRpdGxlIjogIkRlZmF1bHQgV2ViIENyZWF0ZSBWaWV3IiwKICAgICAgICAiZGVzY3JpcHRpb24iOiJEZWZhdWx0IHdlYiBjcmVhdGUgdmlldyB3aGljaCBkb2Vzbid0IGJpbmQgaW5pdGlhbCBkYXRhLiIsCiAgICAgICAgInR5cGUiOiAiY3JlYXRlIiwKICAgICAgICAiZGlzcGxheVJlYWRvbmx5IjpmYWxzZQogICAgfSk7Cgp9KShqUXVlcnkpOyhmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIHZhciBkaXNwbGF5VGVtcGxhdGVzID0gQWxwYWNhLkNyZWF0ZShBbHBhY2EuRW1wdHlWaWV3VGVtcGxhdGVzLCB7CgogICAgICAgIC8vIFRlbXBsYXRlcyBmb3IgY29udHJvbCBmaWVsZHMKICAgICAgICAiY29udHJvbEZpZWxkT3V0ZXJFbCI6ICc8c3BhbiBjbGFzcz0iYWxwYWNhLXZpZXctd2ViLWxpc3QiPnt7aHRtbCB0aGlzLmh0bWx9fTwvc3Bhbj4nLAogICAgICAgICJjb250cm9sRmllbGRNZXNzYWdlIjogJzxkaXY+PHNwYW4gY2xhc3M9InVpLWljb24gdWktaWNvbi1hbGVydCI+PC9zcGFuPjxzcGFuIGNsYXNzPSJhbHBhY2EtY29udHJvbGZpZWxkLW1lc3NhZ2UtdGV4dCI+JHttZXNzYWdlfTwvc3Bhbj48L2Rpdj4nLAogICAgICAgICJjb250cm9sRmllbGRMYWJlbCI6ICd7e2lmIG9wdGlvbnMubGFiZWx9fTxsYWJlbCBmb3I9IiR7aWR9IiBjbGFzcz0ie3tpZiBvcHRpb25zLmxhYmVsQ2xhc3N9fSR7b3B0aW9ucy5sYWJlbENsYXNzfXt7L2lmfX0iPiR7b3B0aW9ucy5sYWJlbH08L2xhYmVsPnt7L2lmfX0nLAogICAgICAgICJjb250cm9sRmllbGRIZWxwZXIiOiAne3tpZiBvcHRpb25zLmhlbHBlcn19PGRpdiBjbGFzcz0ie3tpZiBvcHRpb25zLmhlbHBlckNsYXNzfX0ke29wdGlvbnMuaGVscGVyQ2xhc3N9e3svaWZ9fSI+PHNwYW4gY2xhc3M9InVpLWljb24gdWktaWNvbi1pbmZvIj48L3NwYW4+PHNwYW4gY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtaGVscGVyLXRleHQiPiR7b3B0aW9ucy5oZWxwZXJ9PC9zcGFuPjwvZGl2Pnt7L2lmfX0nLAogICAgICAgICJjb250cm9sRmllbGRDb250YWluZXIiOiAnPGRpdj57e2h0bWwgdGhpcy5odG1sfX08L2Rpdj4nLAogICAgICAgICJjb250cm9sRmllbGQiOiAne3t3cmFwKG51bGwsIHt9KSBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJjb250cm9sRmllbGRPdXRlckVsIix0cnVlKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImNvbnRyb2xGaWVsZExhYmVsIil9fXt7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiY29udHJvbEZpZWxkQ29udGFpbmVyIix0cnVlKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImNvbnRyb2xGaWVsZEhlbHBlciIpfX17ey93cmFwfX17ey93cmFwfX0nLAogICAgICAgIC8vIFRlbXBsYXRlcyBmb3IgY29udGFpbmVyIGZpZWxkcwogICAgICAgICJmaWVsZFNldE91dGVyRWwiOiAnPGZpZWxkc2V0IGNsYXNzPSJhbHBhY2Etdmlldy13ZWItbGlzdCI+e3todG1sIHRoaXMuaHRtbH19PC9maWVsZHNldD4nLAogICAgICAgICJmaWVsZFNldE1lc3NhZ2UiOiAnPGRpdj48c3BhbiBjbGFzcz0idWktaWNvbiB1aS1pY29uLWFsZXJ0IGFscGFjYS1maWVsZHNldC1tZXNzYWdlLWxpc3QtdmlldyI+PC9zcGFuPjxzcGFuPiR7bWVzc2FnZX08L3NwYW4+PC9kaXY+JywKICAgICAgICAiZmllbGRTZXRMZWdlbmQiOiAne3tpZiBvcHRpb25zLmxhYmVsfX08bGVnZW5kIGNsYXNzPSJ7e2lmIG9wdGlvbnMubGFiZWxDbGFzc319JHtvcHRpb25zLmxhYmVsQ2xhc3N9e3svaWZ9fSI+JHtvcHRpb25zLmxhYmVsfTwvbGVnZW5kPnt7L2lmfX0nLAogICAgICAgICJmaWVsZFNldEhlbHBlciI6ICd7e2lmIG9wdGlvbnMuaGVscGVyfX08ZGl2IGNsYXNzPSJ7e2lmIG9wdGlvbnMuaGVscGVyQ2xhc3N9fSR7b3B0aW9ucy5oZWxwZXJDbGFzc317ey9pZn19Ij4ke29wdGlvbnMuaGVscGVyfTwvZGl2Pnt7L2lmfX0nLAogICAgICAgICJmaWVsZFNldEl0ZW1zQ29udGFpbmVyIjogJzxvbD57e2h0bWwgdGhpcy5odG1sfX08L29sPicsCiAgICAgICAgImZpZWxkU2V0IjogJ3t7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiZmllbGRTZXRPdXRlckVsIix0cnVlKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0TGVnZW5kIil9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmaWVsZFNldEhlbHBlciIpfX17e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0SXRlbXNDb250YWluZXIiLHRydWUpfX17ey93cmFwfX17ey93cmFwfX0nLAogICAgICAgICJmaWVsZFNldEl0ZW1Db250YWluZXIiOiAnPGxpIHN0eWxlPSJsaXN0LXN0eWxlOm5vbmU7Ij48L2xpPicsCgogICAgICAgICJpdGVtTGFiZWwiIDogJ3t7aWYgb3B0aW9ucy5pdGVtTGFiZWx9fTxsYWJlbCBmb3I9IiR7aWR9IiBjbGFzcz0iYWxwYWNhLWNvbnRyb2xmaWVsZC1sYWJlbCBhbHBhY2EtY29udHJvbGZpZWxkLWxhYmVsLWxpc3QtdmlldyI+PHNwYW4gY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtaXRlbS1sYWJlbC1saXN0LXZpZXciPiR7b3B0aW9ucy5pdGVtTGFiZWx9e3tpZiBpbmRleH19IDxzcGFuIGNsYXNzPSJhbHBhY2EtaXRlbS1sYWJlbC1jb3VudGVyIj4ke2luZGV4fTwvc3Bhbj48L3NwYW4+e3svaWZ9fTwvbGFiZWw+e3svaWZ9fScKICAgIH0pOwoKICAgIHZhciBlZGl0VGVtcGxhdGVzID0gQWxwYWNhLkNyZWF0ZShBbHBhY2EuRW1wdHlWaWV3VGVtcGxhdGVzLCB7CgogICAgICAgIC8vIFRlbXBsYXRlcyBmb3IgY29udHJvbCBmaWVsZHMKICAgICAgICAiY29udHJvbEZpZWxkT3V0ZXJFbCI6ICc8c3BhbiBjbGFzcz0iYWxwYWNhLXZpZXctd2ViLWxpc3QiPnt7aHRtbCB0aGlzLmh0bWx9fTwvc3Bhbj4nLAogICAgICAgICJjb250cm9sRmllbGRNZXNzYWdlIjogJzxkaXY+PHNwYW4gY2xhc3M9InVpLWljb24gdWktaWNvbi1hbGVydCI+PC9zcGFuPjxzcGFuIGNsYXNzPSJhbHBhY2EtY29udHJvbGZpZWxkLW1lc3NhZ2UtdGV4dCI+JHttZXNzYWdlfTwvc3Bhbj48L2Rpdj4nLAogICAgICAgICJjb250cm9sRmllbGRMYWJlbCI6ICd7e2lmIG9wdGlvbnMubGFiZWx9fTxsYWJlbCBmb3I9IiR7aWR9IiBjbGFzcz0ie3tpZiBvcHRpb25zLmxhYmVsQ2xhc3N9fSR7b3B0aW9ucy5sYWJlbENsYXNzfXt7L2lmfX0iPiR7b3B0aW9ucy5sYWJlbH08L2xhYmVsPnt7L2lmfX0nLAogICAgICAgICJjb250cm9sRmllbGRIZWxwZXIiOiAne3tpZiBvcHRpb25zLmhlbHBlcn19PGRpdiBjbGFzcz0ie3tpZiBvcHRpb25zLmhlbHBlckNsYXNzfX0ke29wdGlvbnMuaGVscGVyQ2xhc3N9e3svaWZ9fSI+PHNwYW4gY2xhc3M9InVpLWljb24gdWktaWNvbi1pbmZvIj48L3NwYW4+PHNwYW4gY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtaGVscGVyLXRleHQiPiR7b3B0aW9ucy5oZWxwZXJ9PC9zcGFuPjwvZGl2Pnt7L2lmfX0nLAogICAgICAgICJjb250cm9sRmllbGRDb250YWluZXIiOiAnPGRpdj57e2h0bWwgdGhpcy5odG1sfX08L2Rpdj4nLAogICAgICAgICJjb250cm9sRmllbGQiOiAne3t3cmFwKG51bGwsIHt9KSBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJjb250cm9sRmllbGRPdXRlckVsIix0cnVlKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImNvbnRyb2xGaWVsZExhYmVsIil9fXt7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiY29udHJvbEZpZWxkQ29udGFpbmVyIix0cnVlKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImNvbnRyb2xGaWVsZEhlbHBlciIpfX17ey93cmFwfX17ey93cmFwfX0nLAogICAgICAgIC8vIFRlbXBsYXRlcyBmb3IgY29udGFpbmVyIGZpZWxkcwogICAgICAgICJmaWVsZFNldE91dGVyRWwiOiAnPGZpZWxkc2V0IGNsYXNzPSJhbHBhY2Etdmlldy13ZWItbGlzdCI+e3todG1sIHRoaXMuaHRtbH19PC9maWVsZHNldD4nLAogICAgICAgICJmaWVsZFNldE1lc3NhZ2UiOiAnPGRpdj48c3BhbiBjbGFzcz0idWktaWNvbiB1aS1pY29uLWFsZXJ0IGFscGFjYS1maWVsZHNldC1tZXNzYWdlLWxpc3QtdmlldyI+PC9zcGFuPjxzcGFuPiR7bWVzc2FnZX08L3NwYW4+PC9kaXY+JywKICAgICAgICAiZmllbGRTZXRMZWdlbmQiOiAne3tpZiBvcHRpb25zLmxhYmVsfX08bGVnZW5kIGNsYXNzPSJ7e2lmIG9wdGlvbnMubGFiZWxDbGFzc319JHtvcHRpb25zLmxhYmVsQ2xhc3N9e3svaWZ9fSI+JHtvcHRpb25zLmxhYmVsfTwvbGVnZW5kPnt7L2lmfX0nLAogICAgICAgICJmaWVsZFNldEhlbHBlciI6ICd7e2lmIG9wdGlvbnMuaGVscGVyfX08ZGl2IGNsYXNzPSJ7e2lmIG9wdGlvbnMuaGVscGVyQ2xhc3N9fSR7b3B0aW9ucy5oZWxwZXJDbGFzc317ey9pZn19Ij4ke29wdGlvbnMuaGVscGVyfTwvZGl2Pnt7L2lmfX0nLAogICAgICAgICJmaWVsZFNldEl0ZW1zQ29udGFpbmVyIjogJzxvbD57e2h0bWwgdGhpcy5odG1sfX08L29sPicsCiAgICAgICAgImZpZWxkU2V0IjogJ3t7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiZmllbGRTZXRPdXRlckVsIix0cnVlKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0TGVnZW5kIil9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmaWVsZFNldEhlbHBlciIpfX17e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0SXRlbXNDb250YWluZXIiLHRydWUpfX17ey93cmFwfX17ey93cmFwfX0nLAogICAgICAgICJmaWVsZFNldEl0ZW1Db250YWluZXIiOiAnPGxpIHN0eWxlPSJsaXN0LXN0eWxlOm5vbmU7Ij48L2xpPicsCgogICAgICAgICJpdGVtTGFiZWwiIDogJ3t7aWYgb3B0aW9ucy5pdGVtTGFiZWx9fTxsYWJlbCBmb3I9IiR7aWR9IiBjbGFzcz0iYWxwYWNhLWNvbnRyb2xmaWVsZC1sYWJlbCBhbHBhY2EtY29udHJvbGZpZWxkLWxhYmVsLWxpc3QtdmlldyI+PHNwYW4gY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtaXRlbS1sYWJlbC1saXN0LXZpZXciPiR7b3B0aW9ucy5pdGVtTGFiZWx9e3tpZiBpbmRleH19IDxzcGFuIGNsYXNzPSJhbHBhY2EtaXRlbS1sYWJlbC1jb3VudGVyIj4ke2luZGV4fTwvc3Bhbj48L3NwYW4+e3svaWZ9fTwvbGFiZWw+e3svaWZ9fScKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3RlclZpZXcoewogICAgICAgICJpZCI6ICJWSUVXX1dFQl9ESVNQTEFZX0xJU1QiLAogICAgICAgICJwYXJlbnQiOiAnVklFV19XRUJfRElTUExBWScsCiAgICAgICAgInRpdGxlIjogIldlYiBEaXNwbGF5IFZpZXcgTGlzdCBTdHlsZSIsCiAgICAgICAgImRlc2NyaXB0aW9uIjogIldlYiBkaXNwbGF5IHZpZXcgYmFzZWQgb24gbGlzdCBzdHlsZXMuIiwKICAgICAgICAibGVnZW5kU3R5bGUiOiAibGluayIsCiAgICAgICAgInRlbXBsYXRlcyI6IGRpc3BsYXlUZW1wbGF0ZXMsCiAgICAgICAgInN0eWxlcyI6IHsKICAgICAgICB9LAogICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICIvIjogewogICAgICAgICAgICAgICAgInRlbXBsYXRlcyI6IHsKICAgICAgICAgICAgICAgICAgICAvLyBUZW1wbGF0ZXMgZm9yIGNvbnRhaW5lciBmaWVsZHMKICAgICAgICAgICAgICAgICAgICAiZmllbGRTZXRJdGVtc0NvbnRhaW5lciI6ICc8b2wgY2xhc3M9ImFscGFjYS1maWVsZHNldC1pdGVtc2NvbnRhaW5lci1saXN0LXZpZXctdG9wIj57e2h0bWwgdGhpcy5odG1sfX08L29sPicsCiAgICAgICAgICAgICAgICAgICAgImZpZWxkU2V0SXRlbUNvbnRhaW5lciI6ICc8bGkgY2xhc3M9ImFscGFjYS1maWVsZHNldC1pdGVtY29udGFpbmVyLWxpc3Qtdmlldy10b3AiPjwvbGk+JwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyVmlldyh7CiAgICAgICAgImlkIjogIlZJRVdfV0VCX0VESVRfTElTVCIsCiAgICAgICAgInBhcmVudCI6ICdWSUVXX1dFQl9FRElUJywKICAgICAgICAidGl0bGUiOiAiV2ViIEVkaXQgVmlldyBMaXN0IFN0eWxlIiwKICAgICAgICAiZGVzY3JpcHRpb24iOiAiV2ViIGVkaXQgdmlldyBiYXNlZCBvbiBsaXN0IHN0eWxlcy4iLAogICAgICAgICJsZWdlbmRTdHlsZSI6ICJsaW5rIiwKICAgICAgICAidGVtcGxhdGVzIjogZWRpdFRlbXBsYXRlcywKICAgICAgICAic3R5bGVzIjogewogICAgICAgIH0sCiAgICAgICAgImZpZWxkcyI6IHsKICAgICAgICAgICAgIi8iOiB7CiAgICAgICAgICAgICAgICAidGVtcGxhdGVzIjogewogICAgICAgICAgICAgICAgICAgIC8vIFRlbXBsYXRlcyBmb3IgY29udGFpbmVyIGZpZWxkcwogICAgICAgICAgICAgICAgICAgICJmaWVsZFNldEl0ZW1zQ29udGFpbmVyIjogJzxvbCBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWl0ZW1zY29udGFpbmVyLWxpc3Qtdmlldy10b3AiPnt7aHRtbCB0aGlzLmh0bWx9fTwvb2w+JywKICAgICAgICAgICAgICAgICAgICAiZmllbGRTZXRJdGVtQ29udGFpbmVyIjogJzxsaSBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWl0ZW1jb250YWluZXItbGlzdC12aWV3LXRvcCI+PC9saT4nCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJWaWV3KHsKICAgICAgICAiaWQiOiAiVklFV19XRUJfQ1JFQVRFX0xJU1QiLAogICAgICAgICJwYXJlbnQiOiAnVklFV19XRUJfQ1JFQVRFJywKICAgICAgICAidGl0bGUiOiAiV2ViIENyZWF0ZSBWaWV3IExpc3QgU3R5bGUiLAogICAgICAgICJkZXNjcmlwdGlvbiI6ICJXZWIgY3JlYXRlIHZpZXcgYmFzZWQgb24gbGlzdCBzdHlsZXMuIiwKICAgICAgICAibGVnZW5kU3R5bGUiOiAibGluayIsCiAgICAgICAgInRlbXBsYXRlcyI6IGVkaXRUZW1wbGF0ZXMsCiAgICAgICAgInN0eWxlcyI6IHsKICAgICAgICB9LAogICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICIvIjogewogICAgICAgICAgICAgICAgInRlbXBsYXRlcyI6IHsKICAgICAgICAgICAgICAgICAgICAvLyBUZW1wbGF0ZXMgZm9yIGNvbnRhaW5lciBmaWVsZHMKICAgICAgICAgICAgICAgICAgICAiZmllbGRTZXRJdGVtc0NvbnRhaW5lciI6ICc8b2wgY2xhc3M9ImFscGFjYS1maWVsZHNldC1pdGVtc2NvbnRhaW5lci1saXN0LXZpZXctdG9wIj57e2h0bWwgdGhpcy5odG1sfX08L29sPicsCiAgICAgICAgICAgICAgICAgICAgImZpZWxkU2V0SXRlbUNvbnRhaW5lciI6ICc8bGkgY2xhc3M9ImFscGFjYS1maWVsZHNldC1pdGVtY29udGFpbmVyLWxpc3Qtdmlldy10b3AiPjwvbGk+JwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7Cgp9KShqUXVlcnkpOy8qKgogKiBqUXVlcnkgVUkgVGhlbWUgKCJqcXVlcnktdWkiKQogKgogKiBEZWZpbmVzIHRoZSBBbHBhY2EgdGhlbWUgZm9yIGpRdWVyeSBVSS4KICoKICogVGhlIHN0eWxlIGluamVjdG9yOgogKgogKiAgICBqcXVlcnktdWkKICoKICogVGhlIHZpZXdzIGFyZToKICoKICogICAgVklFV19KUVVFUllVSV9ESVNQTEFZCiAqICAgIFZJRVdfSlFVRVJZVUlfRURJVAogKiAgICBWSUVXX0pRVUVSWVVJX0NSRUFURQogKgogKiBUaGlzIHRoZW1lIGNhbiBiZSBzZWxlY3RlZCBieSBzcGVjaWZ5aW5nIHRoZSBmb2xsb3dpbmcgdmlldzoKICoKICogICAgewogKiAgICAgICAidWkiOiAianF1ZXJ5LXVpIiwKICogICAgICAgInR5cGUiOiBudWxsIHwgImNyZWF0ZSIgfCAiZWRpdCIgfCAiZGlzcGxheSIKICogICAgfQogKgogKi8KKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLnN0eWxlSW5qZWN0aW9uc1sianF1ZXJ5LXVpIl0gPSB7CiAgICAgICAgImZpZWxkIiA6IGZ1bmN0aW9uKHRhcmdldERpdikgewogICAgICAgICAgICB0YXJnZXREaXYuYWRkQ2xhc3MoJ3VpLXdpZGdldCcpOwogICAgICAgIH0sCiAgICAgICAgInJlcXVpcmVkIiA6IGZ1bmN0aW9uKHRhcmdldERpdikgewogICAgICAgICAgICAkKCc8c3BhbiBjbGFzcz0idWktaWNvbiB1aS1pY29uLXN0YXIiPjwvc3Bhbj4nKS5wcmVwZW5kVG8odGFyZ2V0RGl2KTsKICAgICAgICB9LAogICAgICAgICJlcnJvciIgOiBmdW5jdGlvbih0YXJnZXREaXYpIHsKICAgICAgICAgICAgdGFyZ2V0RGl2LmFkZENsYXNzKCd1aS1zdGF0ZS1lcnJvcicpOwogICAgICAgIH0sCiAgICAgICAgImVycm9yTWVzc2FnZSIgOiBmdW5jdGlvbih0YXJnZXREaXYpIHsKICAgICAgICAgICAgdGFyZ2V0RGl2LmFkZENsYXNzKCd1aS1zdGF0ZS1lcnJvci10ZXh0Jyk7CiAgICAgICAgfSwKICAgICAgICAicmVtb3ZlRXJyb3IiIDogZnVuY3Rpb24odGFyZ2V0RGl2KSB7CiAgICAgICAgICAgIHRhcmdldERpdi5yZW1vdmVDbGFzcygndWktc3RhdGUtZXJyb3InKTsKICAgICAgICB9LAogICAgICAgICJjb250YWluZXIiIDogZnVuY3Rpb24odGFyZ2V0RGl2KSB7CiAgICAgICAgICAgIHRhcmdldERpdi5hZGRDbGFzcygndWktd2lkZ2V0LWNvbnRlbnQnKTsKICAgICAgICB9LAogICAgICAgICJ3aXphcmRTdGF0dXNCYXIiIDogZnVuY3Rpb24odGFyZ2V0RGl2KSB7CiAgICAgICAgICAgIHRhcmdldERpdi5hZGRDbGFzcygndWktd2lkZ2V0LWhlYWRlciB1aS1jb3JuZXItYWxsJyk7CiAgICAgICAgfSwKICAgICAgICAid2l6YXJkQ3VycmVudFN0ZXAiIDogZnVuY3Rpb24odGFyZ2V0RGl2KSB7CiAgICAgICAgICAgIHRhcmdldERpdi5hZGRDbGFzcygndWktc3RhdGUtaGlnaGxpZ2h0IHVpLWNvcm5lci1hbGwnKTsKICAgICAgICB9LAogICAgICAgICJ3aXphcmRVbkN1cnJlbnRTdGVwIiA6IGZ1bmN0aW9uKHRhcmdldERpdikgewogICAgICAgICAgICB0YXJnZXREaXYucmVtb3ZlQ2xhc3MoJ3VpLXN0YXRlLWhpZ2hsaWdodCB1aS1jb3JuZXItYWxsJyk7CiAgICAgICAgfSwKICAgICAgICAiY29udGFpbmVyRXhwYW5kZWRJY29uIiA6ICJ1aS1pY29uLWNpcmNsZS1hcnJvdy1zIiwKICAgICAgICAiY29udGFpbmVyQ29sbGFwc2VkSWNvbiIgOiAidWktaWNvbi1jaXJjbGUtYXJyb3ctZSIsCiAgICAgICAgImNvbW1vbkljb24iIDogInVpLWljb24iLAogICAgICAgICJhZGRJY29uIiA6ICJ1aS1pY29uLWNpcmNsZS1wbHVzIiwKICAgICAgICAicmVtb3ZlSWNvbiIgOiAidWktaWNvbi1jaXJjbGUtbWludXMiLAogICAgICAgICJ1cEljb24iIDogInVpLWljb24tY2lyY2xlLWFycm93LW4iLAogICAgICAgICJkb3duSWNvbiIgOiAidWktaWNvbi1jaXJjbGUtYXJyb3ctcyIsCiAgICAgICAgIndpemFyZFByZUljb24iIDogInVpLWljb24tdHJpYW5nbGUtMS13IiwKICAgICAgICAid2l6YXJkTmV4dEljb24iIDogInVpLWljb24tdHJpYW5nbGUtMS1lIiwKICAgICAgICAid2l6YXJkRG9uZUljb24iIDogInVpLWljb24tdHJpYW5nbGUtMS1lIiwKICAgICAgICAiYnV0dG9uQmVhdXRpZmllciIgIDogZnVuY3Rpb24oYnV0dG9uLCBpY29uQ2xhc3MsIHdpdGhUZXh0KSB7CiAgICAgICAgICAgIGJ1dHRvbi5hZGRDbGFzcygidWktYnV0dG9uIHVpLXdpZGdldCB1aS1zdGF0ZS1kZWZhdWx0IHVpLWNvcm5lci1hbGwiKTsKICAgICAgICAgICAgaWYgKHdpdGhUZXh0KSB7CiAgICAgICAgICAgICAgICBidXR0b24uYWRkQ2xhc3MoInVpLWJ1dHRvbi10ZXh0LWljb24tcHJpbWFyeSIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYnV0dG9uLmFkZENsYXNzKCJ1aS1idXR0b24taWNvbi1vbmx5Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGJ1dHRvblRleHQgPSBidXR0b24uaHRtbCgpOwogICAgICAgICAgICBidXR0b24uYXR0cigidGl0bGUiLCBidXR0b25UZXh0KTsKICAgICAgICAgICAgYnV0dG9uLmVtcHR5KCkuYXBwZW5kKCc8c3BhbiBjbGFzcz0idWktYnV0dG9uLWljb24tcHJpbWFyeSB1aS1pY29uIGFscGFjYS1maWVsZHNldC1sZWdlbmQtYnV0dG9uICcgKyBpY29uQ2xhc3MgKyAnIj48L3NwYW4+PHNwYW4gY2xhc3M9InVpLWJ1dHRvbi10ZXh0Ij4nICsgYnV0dG9uVGV4dCArICc8L3NwYW4+Jyk7CiAgICAgICAgICAgIGJ1dHRvbi5ob3ZlcihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICghYnV0dG9uLmhhc0NsYXNzKCJhbHBhY2EtZmllbGRzZXQtYXJyYXktaXRlbS10b29sYmFyLWRpc2FibGVkIikpIHsKICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKCJ1aS1zdGF0ZS1ob3ZlciIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICghYnV0dG9uLmhhc0NsYXNzKCJhbHBhY2EtZmllbGRzZXQtYXJyYXktaXRlbS10b29sYmFyLWRpc2FibGVkIikpIHsKICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLnJlbW92ZUNsYXNzKCJ1aS1zdGF0ZS1ob3ZlciIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9OwoKICAgIEFscGFjYS5yZWdpc3RlclZpZXcoewogICAgICAgICJpZCI6ICJWSUVXX0pRVUVSWVVJX0RJU1BMQVkiLAogICAgICAgICJwYXJlbnQiOiAiVklFV19XRUJfRElTUExBWSIsCiAgICAgICAgInRpdGxlIjogIldlYiBEaXNwbGF5IFZpZXcgZm9yIGpRdWVyeSBVSSIsCiAgICAgICAgImRlc2NyaXB0aW9uIjogIldlYiBEaXNwbGF5IFZpZXcgZm9yIGpRdWVyeSBVSSIsCiAgICAgICAgInN0eWxlIjogImpxdWVyeS11aSIsCiAgICAgICAgInVpIjogImpxdWVyeS11aSIKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3RlclZpZXcoewogICAgICAgICJpZCI6ICJWSUVXX0pRVUVSWVVJX0VESVQiLAogICAgICAgICJwYXJlbnQiOiAiVklFV19XRUJfRURJVCIsCiAgICAgICAgInRpdGxlIjogIldlYiBFZGl0IFZpZXcgZm9yIGpRdWVyeSBVSSIsCiAgICAgICAgImRlc2NyaXB0aW9uIjoiV2ViIEVkaXQgVmlldyBmb3IgalF1ZXJ5IFVJIiwKICAgICAgICAic3R5bGUiOiAianF1ZXJ5LXVpIiwKICAgICAgICAidWkiOiAianF1ZXJ5LXVpIgogICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyVmlldyh7CiAgICAgICAgImlkIjogIlZJRVdfSlFVRVJZVUlfQ1JFQVRFIiwKICAgICAgICAicGFyZW50IjogJ1ZJRVdfV0VCX0NSRUFURScsCiAgICAgICAgInRpdGxlIjogIldlYiBDcmVhdGUgVmlldyBmb3IgalF1ZXJ5IFVJIiwKICAgICAgICAiZGVzY3JpcHRpb24iOiAiV2ViIENyZWF0ZSBWaWV3IGZvciBqUXVlcnkgVUkiLAogICAgICAgICJzdHlsZSI6ICJqcXVlcnktdWkiLAogICAgICAgICJ1aSI6ICJqcXVlcnktdWkiCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJWaWV3KHsKICAgICAgICAiaWQiOiAiVklFV19KUVVFUllVSV9FRElUX0xJU1QiLAogICAgICAgICJwYXJlbnQiOiAnVklFV19XRUJfRURJVF9MSVNUJywKICAgICAgICAidGl0bGUiOiAiSlF1ZXJ5IFVJIEVkaXQgVmlldyBMaXN0IFN0eWxlIiwKICAgICAgICAiZGVzY3JpcHRpb24iOiAiSlF1ZXJ5IFVJIGVkaXQgdmlldyBiYXNlZCBvbiBsaXN0IHN0eWxlcy4iLAogICAgICAgICJzdHlsZSI6ICJqcXVlcnktdWkiLAogICAgICAgICJ1aSI6ICJqcXVlcnktdWkiCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJWaWV3KHsKICAgICAgICAiaWQiOiAiVklFV19KUVVFUllVSV9DUkVBVEVfTElTVCIsCiAgICAgICAgInBhcmVudCI6ICdWSUVXX1dFQl9DUkVBVEVfTElTVCcsCiAgICAgICAgInRpdGxlIjogIkpRdWVyeSBVSSBDcmVhdGUgVmlldyBMaXN0IFN0eWxlIiwKICAgICAgICAiZGVzY3JpcHRpb24iOiAiSlF1ZXJ5IFVJIGNyZWF0ZSB2aWV3IGJhc2VkIG9uIGxpc3Qgc3R5bGVzLiIsCiAgICAgICAgInN0eWxlIjogImpxdWVyeS11aSIsCiAgICAgICAgInVpIjogImpxdWVyeS11aSIKICAgIH0pOwoKCn0pKGpRdWVyeSk7LyoqCiAqIGpRdWVyeSBNb2JpbGUgVGhlbWUgKCJtb2JpbGUiKQogKgogKiBEZWZpbmVzIHRoZSBBbHBhY2EgdGhlbWUgZm9yIGpRdWVyeSBNb2JpbGUuCiAqCiAqIFRoZSBzdHlsZSBpbmplY3RvcjoKICoKICogICAgbW9iaWxlCiAqCiAqIFRoZSB2aWV3cyBhcmU6CiAqCiAqICAgIFZJRVdfTU9CSUxFX0RJU1BMQVkKICogICAgVklFV19NT0JJTEVfRURJVAogKiAgICBWSUVXX01PQklMRV9DUkVBVEUKICoKICogVGhpcyB0aGVtZSBjYW4gYWxzbyBiZSBzZWxlY3RlZCBieSBzcGVjaWZ5aW5nIHRoZSBmb2xsb3dpbmcgdmlldzoKICoKICogICAgewogKiAgICAgICAidWkiOiAibW9iaWxlIiwKICogICAgICAgInR5cGUiOiBudWxsIHwgImNyZWF0ZSIgfCAiZWRpdCIgfCAiZGlzcGxheSIKICogICAgfQogKgogKi8oZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICB2YXIgZGlzcGxheVRlbXBsYXRlcyA9IEFscGFjYS5DcmVhdGUoQWxwYWNhLkVtcHR5Vmlld1RlbXBsYXRlcywgewoKICAgICAgICAvLyBUZW1wbGF0ZXMgZm9yIGNvbnRyb2wgZmllbGRzCiAgICAgICAgY29udHJvbEZpZWxkOiAnPHVsIGRhdGEtcm9sZT0ibGlzdHZpZXciPjxsaT57e2lmIG9wdGlvbnMubGFiZWx9fTxoND4ke29wdGlvbnMubGFiZWx9PC9oND57ey9pZn19PHA+PHN0cm9uZz4ke2RhdGF9PC9zdHJvbmc+PC9wPjwvbGk+PC91bD4nLAogICAgICAgIC8vIFRlbXBsYXRlcyBmb3IgY29udGFpbmVyIGZpZWxkcwogICAgICAgIGZpZWxkU2V0T3V0ZXJFbDogJzxmaWVsZHNldCBkYXRhLXJvbGU9ImNvbGxhcHNpYmxlIiBpZD0iJHtpZH0iIGRhdGEtY29sbGFwc2VkPSJ7e2lmIG9wdGlvbnMuY29sbGFwc2VkfX10cnVle3tlbHNlfX1mYWxzZXt7L2lmfX0iPnt7aHRtbCB0aGlzLmh0bWx9fTwvZmllbGRzZXQ+JywKICAgICAgICBmaWVsZFNldE1lc3NhZ2U6ICc8ZGl2PiogJHttZXNzYWdlfTwvZGl2PicsCiAgICAgICAgZmllbGRTZXRMZWdlbmQ6ICd7e2lmIG9wdGlvbnMubGFiZWx9fTxsZWdlbmQgZm9yPSIke2lkfSIgY2xhc3M9Int7aWYgb3B0aW9ucy5sYWJlbENsYXNzfX0ke29wdGlvbnMubGFiZWxDbGFzc317ey9pZn19Ij4ke29wdGlvbnMubGFiZWx9PC9sZWdlbmQ+e3svaWZ9fScsCiAgICAgICAgZmllbGRTZXRIZWxwZXI6ICd7e2lmIG9wdGlvbnMuaGVscGVyfX08aDMgY2xhc3M9Int7aWYgb3B0aW9ucy5oZWxwZXJDbGFzc319JHtvcHRpb25zLmhlbHBlckNsYXNzfXt7L2lmfX0iPiR7b3B0aW9ucy5oZWxwZXJ9PC9oMz57ey9pZn19JywKICAgICAgICBmaWVsZFNldEl0ZW1zQ29udGFpbmVyOiAnPGRpdiBkYXRhLXJvbGU9ImNvbnRyb2xncm91cCI+e3todG1sIHRoaXMuaHRtbH19PC9kaXY+JywKICAgICAgICBmaWVsZFNldDogJ3t7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiZmllbGRTZXRPdXRlckVsIix0cnVlKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0TGVnZW5kIil9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmaWVsZFNldEhlbHBlciIpfX17e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0SXRlbXNDb250YWluZXIiLHRydWUpfX17ey93cmFwfX17ey93cmFwfX0nLAogICAgICAgIGZpZWxkU2V0SXRlbUNvbnRhaW5lcjogJzxkaXY+PC9kaXY+JwogICAgfSk7CgogICAgdmFyIGVkaXRUZW1wbGF0ZXMgPSBBbHBhY2EuQ3JlYXRlKEFscGFjYS5FbXB0eVZpZXdUZW1wbGF0ZXMsIHsKCiAgICAgICAgLy8gVGVtcGxhdGVzIGZvciBjb250cm9sIGZpZWxkcwogICAgICAgIGNvbnRyb2xGaWVsZE91dGVyRWw6ICc8ZGl2IGRhdGEtcm9sZT0iZmllbGRjb250YWluIj57e2h0bWwgdGhpcy5odG1sfX08L2Rpdj4nLAogICAgICAgIGNvbnRyb2xGaWVsZE1lc3NhZ2U6ICc8ZGl2PiogJHttZXNzYWdlfTwvZGl2PicsCiAgICAgICAgY29udHJvbEZpZWxkTGFiZWw6ICd7e2lmIG9wdGlvbnMubGFiZWx9fTxsYWJlbCBmb3I9IiR7aWR9IiBjbGFzcz0ie3tpZiBvcHRpb25zLmxhYmVsQ2xhc3N9fSR7b3B0aW9ucy5sYWJlbENsYXNzfXt7L2lmfX0iPiR7b3B0aW9ucy5sYWJlbH08L2xhYmVsPnt7L2lmfX0nLAogICAgICAgIGNvbnRyb2xGaWVsZEhlbHBlcjogJ3t7aWYgb3B0aW9ucy5oZWxwZXJ9fTxkaXYgY2xhc3M9Int7aWYgb3B0aW9ucy5oZWxwZXJDbGFzc319JHtvcHRpb25zLmhlbHBlckNsYXNzfXt7L2lmfX0iPiR7b3B0aW9ucy5oZWxwZXJ9PC9kaXY+e3svaWZ9fScsCiAgICAgICAgY29udHJvbEZpZWxkQ29udGFpbmVyOiAnPGRpdiBkYXRhLXJlcGxhY2U9InRydWUiPnt7aHRtbCB0aGlzLmh0bWx9fTwvZGl2PicsCiAgICAgICAgY29udHJvbEZpZWxkOiAne3t3cmFwKG51bGwsIHt9KSBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJjb250cm9sRmllbGRPdXRlckVsIix0cnVlKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImNvbnRyb2xGaWVsZExhYmVsIil9fXt7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiY29udHJvbEZpZWxkQ29udGFpbmVyIix0cnVlKX19e3svd3JhcH19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImNvbnRyb2xGaWVsZEhlbHBlciIpfX17ey93cmFwfX0nLAogICAgICAgIC8vIFRlbXBsYXRlcyBmb3IgY29udGFpbmVyIGZpZWxkcwogICAgICAgIGZpZWxkU2V0T3V0ZXJFbDogJzxmaWVsZHNldCBpZD0iJHtpZH0iIGRhdGEtY29sbGFwc2VkPSJ7e2lmIG9wdGlvbnMuY29sbGFwc2VkfX10cnVle3tlbHNlfX1mYWxzZXt7L2lmfX0iPnt7aHRtbCB0aGlzLmh0bWx9fTwvZmllbGRzZXQ+JywKICAgICAgICBmaWVsZFNldE1lc3NhZ2U6ICc8ZGl2PiogJHttZXNzYWdlfTwvZGl2PicsCiAgICAgICAgZmllbGRTZXRMZWdlbmQ6ICd7e2lmIG9wdGlvbnMubGFiZWx9fTxsZWdlbmQgZm9yPSIke2lkfSIgY2xhc3M9Int7aWYgb3B0aW9ucy5sYWJlbENsYXNzfX0ke29wdGlvbnMubGFiZWxDbGFzc317ey9pZn19Ij4ke29wdGlvbnMubGFiZWx9PC9sZWdlbmQ+e3svaWZ9fScsCiAgICAgICAgZmllbGRTZXRIZWxwZXI6ICd7e2lmIG9wdGlvbnMuaGVscGVyfX08aDMgY2xhc3M9Int7aWYgb3B0aW9ucy5oZWxwZXJDbGFzc319JHtvcHRpb25zLmhlbHBlckNsYXNzfXt7L2lmfX0iPiR7b3B0aW9ucy5oZWxwZXJ9PC9oMz57ey9pZn19JywKICAgICAgICBmaWVsZFNldEl0ZW1zQ29udGFpbmVyOiAnPGRpdiBkYXRhLXJvbGU9ImNvbnRyb2xncm91cCI+e3todG1sIHRoaXMuaHRtbH19PC9kaXY+JywKICAgICAgICBmaWVsZFNldDogJ3t7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiZmllbGRTZXRPdXRlckVsIix0cnVlKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0TGVnZW5kIil9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmaWVsZFNldEhlbHBlciIpfX17e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0SXRlbXNDb250YWluZXIiLHRydWUpfX17ey93cmFwfX17ey93cmFwfX0nLAogICAgICAgIGZpZWxkU2V0SXRlbUNvbnRhaW5lcjogJzxkaXY+PC9kaXY+JywKICAgICAgICAvLyBUZW1wbGF0ZXMgZm9yIGZvcm0KICAgICAgICBmb3JtRmllbGRzQ29udGFpbmVyOiAnPGRpdiBkYXRhLXJvbGU9ImNvbnRlbnQiPnt7aHRtbCB0aGlzLmh0bWx9fTwvZGl2PicsCiAgICAgICAgLy9mb3JtQnV0dG9uc0NvbnRhaW5lcjogJzxmaWVsZHNldCBjbGFzcz0idWktZ3JpZC1hIj57e2h0bWwgdGhpcy5odG1sfX08L2ZpZWxkc2V0PicsCiAgICAgICAgLy8iZm9ybUJ1dHRvbnNDb250YWluZXIiOiAnPGRpdj57e2lmIG9wdGlvbnMuYnV0dG9uc319e3tlYWNoKGssdikgb3B0aW9ucy5idXR0b25zfX08aW5wdXQgZGF0YS1rZXk9IiR7a30iIGNsYXNzPSJhbHBhY2EtZm9ybS1idXR0b24gYWxwYWNhLWZvcm0tYnV0dG9uLSR7a30iIHt7ZWFjaChrMSx2MSkgdn19JHtrMX09IiR7djF9Int7L2VhY2h9fS8+e3svZWFjaH19e3svaWZ9fTwvZGl2PicsCiAgICAgICAgZm9ybTogJzxmb3JtPnt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmb3JtRmllbGRzQ29udGFpbmVyIil9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmb3JtQnV0dG9uc0NvbnRhaW5lciIpfX08L2Zvcm0+JywKICAgICAgICAvLyBDb250cm9scwogICAgICAgIC8vY29udHJvbEZpZWxkUmFkaW86ICc8ZmllbGRzZXQgZGF0YS1yb2xlPSJjb250cm9sZ3JvdXAiIGlkPSIke2lkfSI+e3tpZiBvcHRpb25zLmxhYmVsfX08bGVnZW5kIGZvcj0iJHtpZH0iIGNsYXNzPSJ7e2lmIG9wdGlvbnMubGFiZWxDbGFzc319JHtvcHRpb25zLmxhYmVsQ2xhc3N9e3svaWZ9fSI+JHtvcHRpb25zLmxhYmVsfTwvbGVnZW5kPnt7L2lmfX17e2VhY2ggc2VsZWN0T3B0aW9uc319PGlucHV0IHR5cGU9InJhZGlvIiB7e2lmIG9wdGlvbnMucmVhZG9ubHl9fXJlYWRvbmx5PSJyZWFkb25seSJ7ey9pZn19IG5hbWU9IiR7Zm9ybU5hbWV9IiBpZD0iJHtpZH0tJHskaW5kZXh9IiB2YWx1ZT0iJHt2YWx1ZX0iIHt7aWYgdmFsdWUgPT0gZGF0YX19Y2hlY2tlZD0iY2hlY2tlZCJ7ey9pZn19Lz48bGFiZWwgZm9yPSIke2lkfS0keyRpbmRleH0iPiR7dGV4dH08L2xhYmVsPnt7L2VhY2h9fTwvZmllbGRzZXQ+JywKICAgICAgICBjb250cm9sRmllbGRSYWRpbzogJzxmaWVsZHNldCBkYXRhLXJvbGU9ImNvbnRyb2xncm91cCIgY2xhc3M9ImFscGFjYS1yYWRpby1maWVsZHNldCIgaWQ9IiR7aWR9Ij57e2VhY2ggc2VsZWN0T3B0aW9uc319PGlucHV0IHR5cGU9InJhZGlvIiB7e2lmIG9wdGlvbnMucmVhZG9ubHl9fXJlYWRvbmx5PSJyZWFkb25seSJ7ey9pZn19IG5hbWU9IiR7bmFtZX0iIGlkPSIke2lkfS0keyRpbmRleH0iIHZhbHVlPSIke3ZhbHVlfSIge3tpZiB2YWx1ZSA9PSBkYXRhfX1jaGVja2VkPSJjaGVja2VkInt7L2lmfX0vPjxsYWJlbCBmb3I9IiR7aWR9LSR7JGluZGV4fSI+JHt0ZXh0fTwvbGFiZWw+e3svZWFjaH19PC9maWVsZHNldD4nLAogICAgICAgIGNvbnRyb2xGaWVsZENoZWNrYm94OiAnPGZpZWxkc2V0IGRhdGEtcm9sZT0iY29udHJvbGdyb3VwIiBjbGFzcz0iYWxwYWNhLXJhZGlvLWZpZWxkc2V0IiBpZD0iJHtpZH0tMCI+PGlucHV0IHR5cGU9ImNoZWNrYm94IiBpZD0iJHtpZH0tMSIgbmFtZT0iJHtpZH0tMSIge3tpZiBvcHRpb25zLnJlYWRvbmx5fX1yZWFkb25seT0icmVhZG9ubHkie3svaWZ9fSB7e2lmIG5hbWV9fW5hbWU9IiR7bmFtZX0ie3svaWZ9fSB7e2VhY2ggb3B0aW9ucy5kYXRhfX1kYXRhLSR7ZmllbGRJZH09IiR7dmFsdWV9Int7L2VhY2h9fS8+e3tpZiBvcHRpb25zLnJpZ2h0TGFiZWx9fTxsYWJlbCBmb3I9IiR7aWR9LTEiPiR7b3B0aW9ucy5yaWdodExhYmVsfTwvbGFiZWw+e3tlbHNlfX17e2lmIG9wdGlvbnMubGFiZWx9fTxsYWJlbCBmb3I9IiR7aWR9LTEiPiR7b3B0aW9ucy5sYWJlbH0/PC9sYWJlbD57ey9pZn19e3svaWZ9fTwvZmllbGRzZXQ+JywKICAgICAgICBhcnJheUl0ZW1Ub29sYmFyOiAnPGRpdiBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWFycmF5LWl0ZW0tdG9vbGJhciIgZGF0YS1yb2xlPSJjb250cm9sZ3JvdXAiIGRhdGEtdHlwZT0iaG9yaXpvbnRhbCIgZGF0YS1taW5pPSJ0cnVlIj48c3BhbiBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWFycmF5LWl0ZW0tdG9vbGJhci1hZGQiIGRhdGEtcm9sZT0iYnV0dG9uIiBkYXRhLWljb249ImFkZCIgZGF0YS1pY29ucG9zPSJub3RleHQiPkFkZDwvc3Bhbj48c3BhbiBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWFycmF5LWl0ZW0tdG9vbGJhci1yZW1vdmUiIGRhdGEtcm9sZT0iYnV0dG9uIiBkYXRhLWljb249ImRlbGV0ZSIgZGF0YS1pY29ucG9zPSJub3RleHQiPkRlbGV0ZTwvc3Bhbj48c3BhbiBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWFycmF5LWl0ZW0tdG9vbGJhci11cCIgZGF0YS1yb2xlPSJidXR0b24iIGRhdGEtaWNvbj0iYXJyb3ctdSIgZGF0YS1pY29ucG9zPSJub3RleHQiPlVwPC9zcGFuPjxzcGFuIGNsYXNzPSJhbHBhY2EtZmllbGRzZXQtYXJyYXktaXRlbS10b29sYmFyLWRvd24iIGRhdGEtcm9sZT0iYnV0dG9uIiBkYXRhLWljb249ImFycm93LWQiIGRhdGEtaWNvbnBvcz0ibm90ZXh0Ij5Eb3duPC9zcGFuPjwvZGl2PicsCiAgICAgICAgYXJyYXlUb29sYmFyOiAnPGRpdiBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWFycmF5LXRvb2xiYXIiIGRhdGEtcm9sZT0iY29udHJvbGdyb3VwIiAgZGF0YS1taW5pPSJ0cnVlIj48c3BhbiBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWFycmF5LXRvb2xiYXItaWNvbiBhbHBhY2EtZmllbGRzZXQtYXJyYXktdG9vbGJhci1hZGQiIGRhdGEtcm9sZT0iYnV0dG9uIiBkYXRhLWljb249ImFkZCIgZGF0YS1pbmxpbmU9InRydWUiIHRpdGxlPSJBZGQiPkFkZDwvc3Bhbj48L2Rpdj4nCiAgICB9KTsKCgogICAgQWxwYWNhLnN0eWxlSW5qZWN0aW9uc1sianF1ZXJ5LW1vYmlsZSJdID0gewogICAgICAgICJhcnJheSIgOiBmdW5jdGlvbihjb250YWluZXJFbGVtKSB7CiAgICAgICAgICAgIGlmIChjb250YWluZXJFbGVtKSB7CiAgICAgICAgICAgICAgICBpZiAoY29udGFpbmVyRWxlbS5maW5kKCdbZGF0YS1yb2xlPSJmaWVsZGNvbnRhaW4iXScpLmZpZWxkY29udGFpbikgewogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lckVsZW0uZmluZCgnW2RhdGEtcm9sZT0iZmllbGRjb250YWluIl0nKS5maWVsZGNvbnRhaW4oKTsKICAgICAgICAgICAgICAgICAgICBjb250YWluZXJFbGVtLmZpbmQoJ1tkYXRhLXJvbGU9ImZpZWxkY29udGFpbiJdJykuZmluZCgiW3R5cGU9J3JhZGlvJ10sIFt0eXBlPSdjaGVja2JveCddIikuY2hlY2tib3hyYWRpbygpOwogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lckVsZW0uZmluZCgnW2RhdGEtcm9sZT0iZmllbGRjb250YWluIl0nKS5maW5kKCJidXR0b24sIFtkYXRhLXJvbGU9J2J1dHRvbiddLCBbdHlwZT0nYnV0dG9uJ10sIFt0eXBlPSdzdWJtaXQnXSwgW3R5cGU9J3Jlc2V0J10sIFt0eXBlPSdpbWFnZSddIikubm90KCIudWktbm9qcyIpLmJ1dHRvbigpOwogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lckVsZW0uZmluZCgnW2RhdGEtcm9sZT0iZmllbGRjb250YWluIl0nKS5maW5kKCJpbnB1dCwgdGV4dGFyZWEiKS5ub3QoIlt0eXBlPSdyYWRpbyddLCBbdHlwZT0nY2hlY2tib3gnXSwgYnV0dG9uLCBbdHlwZT0nYnV0dG9uJ10sIFt0eXBlPSdzdWJtaXQnXSwgW3R5cGU9J3Jlc2V0J10sIFt0eXBlPSdpbWFnZSddIikudGV4dGlucHV0KCk7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyRWxlbS5maW5kKCdbZGF0YS1yb2xlPSJmaWVsZGNvbnRhaW4iXScpLmZpbmQoImlucHV0LCBzZWxlY3QiKS5maWx0ZXIoIltkYXRhLXJvbGU9J3NsaWRlciddLCBbZGF0YS10eXBlPSdyYW5nZSddIikuc2xpZGVyKCk7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyRWxlbS5maW5kKCdbZGF0YS1yb2xlPSJmaWVsZGNvbnRhaW4iXScpLmZpbmQoInNlbGVjdDpub3QoW2RhdGEtcm9sZT0nc2xpZGVyJ10pIikuc2VsZWN0bWVudSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lckVsZW0uZmluZCgnW2RhdGEtcm9sZT0iYnV0dG9uIl0nKS5idXR0b25NYXJrdXAoKTsKICAgICAgICAgICAgICAgICAgICBjb250YWluZXJFbGVtLmZpbmQoJ1tkYXRhLXJvbGU9ImNvbnRyb2xncm91cCJdJykuY29udHJvbGdyb3VwKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICBBbHBhY2EucmVnaXN0ZXJWaWV3KHsKICAgICAgICAiaWQiOiAiVklFV19NT0JJTEVfRElTUExBWSIsCiAgICAgICAgInBhcmVudCI6ICJWSUVXX1dFQl9ESVNQTEFZIiwKICAgICAgICAidGl0bGUiOiAiTW9iaWxlIERJU1BMQVkgVmlldyIsCiAgICAgICAgImRlc2NyaXB0aW9uIjogIk1vYmlsZSBkaXNwbGF5IHZpZXcgdXNpbmcgSlF1ZXJ5IE1vYmlsZSBMaWJyYXJ5IiwKICAgICAgICAidHlwZSI6ICJ2aWV3IiwKICAgICAgICAicGxhdGZvcm0iOiJtb2JpbGUiLAogICAgICAgICJzdHlsZSI6ImpxdWVyeS1tb2JpbGUiLAogICAgICAgICJ1aSI6Im1vYmlsZSIsCiAgICAgICAgImxlZ2VuZFN0eWxlIjogImxpbmsiLAogICAgICAgICJ0b29sYmFyU3R5bGUiOiAibGluayIsCiAgICAgICAgImJ1dHRvblR5cGUiOiAibGluayIsCiAgICAgICAgInRlbXBsYXRlcyI6IGRpc3BsYXlUZW1wbGF0ZXMsCiAgICAgICAgIm1lc3NhZ2VzIjogewogICAgICAgICAgICByZXF1aXJlZDogIlJlcXVpcmVkIEZpZWxkIiwKICAgICAgICAgICAgaW52YWxpZDogIkludmFsaWQgRmllbGQiCiAgICAgICAgfSwKICAgICAgICAicmVuZGVyIjogZnVuY3Rpb24oZmllbGQsIHJlbmRlcmVkQ2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIGZpZWxkLnJlbmRlcihmaWVsZC52aWV3LCBmdW5jdGlvbihmaWVsZCkgewoKICAgICAgICAgICAgICAgIHJlZnJlc2hQYWdlRm9yRmllbGQoZmllbGQuZ2V0RWwoKSk7CgogICAgICAgICAgICAgICAgaWYgKHJlbmRlcmVkQ2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICByZW5kZXJlZENhbGxiYWNrLmNhbGwoc2VsZiwgZmllbGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgfQogICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyVmlldyh7CiAgICAgICAgImlkIjogIlZJRVdfTU9CSUxFX0VESVQiLAogICAgICAgICJwYXJlbnQiOiAiVklFV19XRUJfRURJVCIsCiAgICAgICAgInRpdGxlIjogIk1vYmlsZSBFZGl0IFZpZXciLAogICAgICAgICJkZXNjcmlwdGlvbiI6ICJNb2JpbGUgZWRpdCB2aWV3IHVzaW5nIEpRdWVyeSBNb2JpbGUgTGlicmFyeSIsCiAgICAgICAgInR5cGUiOiAiZWRpdCIsCiAgICAgICAgInBsYXRmb3JtIjoibW9iaWxlIiwKICAgICAgICAic3R5bGUiOiJqcXVlcnktbW9iaWxlIiwKICAgICAgICAidWkiOiJtb2JpbGUiLAogICAgICAgICJsZWdlbmRTdHlsZSI6ICJsaW5rIiwKICAgICAgICAidG9vbGJhclN0eWxlIjogImxpbmsiLAogICAgICAgICJidXR0b25UeXBlIjogImxpbmsiLAogICAgICAgICJ0b29sYmFyU3RpY2t5IjogdHJ1ZSwKICAgICAgICAidGVtcGxhdGVzIjogZWRpdFRlbXBsYXRlcywKICAgICAgICAibWVzc2FnZXMiOiB7CiAgICAgICAgICAgIHJlcXVpcmVkOiAiUmVxdWlyZWQgRmllbGQiLAogICAgICAgICAgICBpbnZhbGlkOiAiSW52YWxpZCBGaWVsZCIKICAgICAgICB9LAogICAgICAgICJyZW5kZXIiOiBmdW5jdGlvbihmaWVsZCwgcmVuZGVyZWRDYWxsYmFjaykgewoKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgZmllbGQucmVuZGVyKGZ1bmN0aW9uKGZpZWxkKSB7CgogICAgICAgICAgICAgICAgcmVmcmVzaFBhZ2VGb3JGaWVsZChmaWVsZC5nZXRFbCgpKTsKCiAgICAgICAgICAgICAgICBpZiAocmVuZGVyZWRDYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgIHJlbmRlcmVkQ2FsbGJhY2suY2FsbChzZWxmLCBmaWVsZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICB9CiAgICB9KTsKCiAgICB2YXIgcmVmcmVzaFBhZ2VGb3JGaWVsZCA9IGZ1bmN0aW9uKGZpZWxkRWwpCiAgICB7CiAgICAgICAgLy8gZmluZCB0aGUgZGF0YS1yb2xlPSJwYWdlIiBhbmQgcmVmcmVzaCBpdAogICAgICAgIHZhciBlbCA9IGZpZWxkRWw7CiAgICAgICAgd2hpbGUgKCFBbHBhY2EuaXNFbXB0eShlbCkgJiYgZWwuYXR0cigiZGF0YS1yb2xlIikgIT09ICJwYWdlIikKICAgICAgICB7CiAgICAgICAgICAgIGVsID0gZWwucGFyZW50KCk7CiAgICAgICAgfQogICAgICAgIGlmICghQWxwYWNhLmlzRW1wdHkoZWwpKSB7CiAgICAgICAgICAgICQoZWwpLnRyaWdnZXIoJ3BhZ2VjcmVhdGUnKTsKICAgICAgICB9CiAgICB9OwoKICAgIEFscGFjYS5yZWdpc3RlclZpZXcoewogICAgICAgICJpZCI6ICJWSUVXX01PQklMRV9DUkVBVEUiLAogICAgICAgICJwYXJlbnQiOiAnVklFV19NT0JJTEVfRURJVCcsCiAgICAgICAgInRpdGxlIjogIkRlZmF1bHQgTW9iaWxlIENyZWF0ZSBWaWV3IiwKICAgICAgICAiZGVzY3JpcHRpb24iOiJEZWZhdWx0IG1vYmlsZSBjcmVhdGUgdmlldyB3aGljaCBkb2Vzbid0IGJpbmQgaW5pdGlhbCBkYXRhLiIsCiAgICAgICAgInR5cGUiOiAiY3JlYXRlIiwKICAgICAgICAiZGlzcGxheVJlYWRvbmx5IjpmYWxzZQogICAgfSk7Cgp9KShqUXVlcnkpOy8qKgogKiBUd2l0dGVyIEJvb3RzdHJhcCBUaGVtZSAoImJvb3RzdHJhcCIpCiAqCiAqIERlZmluZXMgdGhlIEFscGFjYSB0aGVtZSBmb3IgVHdpdHRlciBCb290c3RyYXAgdjMuCiAqCiAqIFRoZSBzdHlsZSBpbmplY3RvcjoKICoKICogICAgYm9vdHN0cmFwCiAqCiAqIFRoZSB2aWV3cyBhcmU6CiAqCiAqICAgIFZJRVdfQk9PVFNUUkFQX0RJU1BMQVkKICogICAgVklFV19CT09UU1RSQVBfRURJVAogKiAgICBWSUVXX0JPT1RTVFJBUF9DUkVBVEUKICoKICogVGhpcyB0aGVtZSBjYW4gYWxzbyBiZSBzZWxlY3RlZCBieSBzcGVjaWZ5aW5nIHRoZSBmb2xsb3dpbmcgdmlldzoKICoKICogICAgewogKiAgICAgICAidWkiOiAiYm9vdHN0cmFwIiwKICogICAgICAgInR5cGUiOiBudWxsIHwgImNyZWF0ZSIgfCAiZWRpdCIgfCAiZGlzcGxheSIKICogICAgfQogKgogKi8KKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgdmFyIGVkaXRUZW1wbGF0ZXMgPSBBbHBhY2EuQ3JlYXRlKEFscGFjYS5FbXB0eVZpZXdUZW1wbGF0ZXMsIHsKICAgICAgICAvLyBUZW1wbGF0ZXMgZm9yIGNvbnRyb2wgZmllbGRzCiAgICAgICAgImNvbnRyb2xGaWVsZE91dGVyRWwiOiAnPGRpdiBjbGFzcz0iZm9ybS1ncm91cCI+e3todG1sIHRoaXMuaHRtbH19PC9kaXY+JywKICAgICAgICAiY29udHJvbEZpZWxkTWVzc2FnZSI6ICc8c3BhbiBjbGFzcz0iZ2x5cGhpY29uIGdseXBoaWNvbi1leGNsYW1hdGlvbi1zaWduIj48L3NwYW4+PHNwYW4gY2xhc3M9ImhlbHAtYmxvY2sgYWxwYWNhLWNvbnRyb2xmaWVsZC1tZXNzYWdlLXRleHQiPiR7bWVzc2FnZX08L3NwYW4+JywKICAgICAgICAiY29udHJvbEZpZWxkTGFiZWwiOiAne3tpZiBvcHRpb25zLmxhYmVsfX08bGFiZWwgY2xhc3M9Int7aWYgb3B0aW9ucy5sYWJlbENsYXNzfX0ke29wdGlvbnMubGFiZWxDbGFzc317ey9pZn19IGNvbnRyb2wtbGFiZWwiIGZvcj0iJHtpZH0iPiR7b3B0aW9ucy5sYWJlbH08L2xhYmVsPnt7L2lmfX0nLAogICAgICAgICJjb250cm9sRmllbGRIZWxwZXIiOiAnPHAgY2xhc3M9Int7aWYgb3B0aW9ucy5oZWxwZXJDbGFzc319JHtvcHRpb25zLmhlbHBlckNsYXNzfXt7L2lmfX0iPnt7aWYgb3B0aW9ucy5oZWxwZXJ9fTxpIGNsYXNzPSJnbHlwaGljb24gZ2x5cGhpY29uLWluZm8tc2lnbiBhbHBhY2EtaGVscGVyLWljb24iPjwvaT4ke29wdGlvbnMuaGVscGVyfTwvcD57ey9pZn19JywKICAgICAgICAiY29udHJvbEZpZWxkQ29udGFpbmVyIjogJzxkaXY+e3todG1sIHRoaXMuaHRtbH19PC9kaXY+JywKICAgICAgICAiY29udHJvbEZpZWxkIjogJ3t7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiY29udHJvbEZpZWxkT3V0ZXJFbCIsdHJ1ZSl9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJjb250cm9sRmllbGRMYWJlbCIpfX17e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImNvbnRyb2xGaWVsZENvbnRhaW5lciIsdHJ1ZSl9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJjb250cm9sRmllbGRIZWxwZXIiKX19e3svd3JhcH19e3svd3JhcH19JywKICAgICAgICAvLyBUZW1wbGF0ZXMgZm9yIGNvbnRhaW5lciBmaWVsZHMKICAgICAgICAiZmllbGRTZXRPdXRlckVsIjogJzxmaWVsZHNldD57e2h0bWwgdGhpcy5odG1sfX08L2ZpZWxkc2V0PicsCiAgICAgICAgImZpZWxkU2V0TWVzc2FnZSI6ICc8c3BhbiBjbGFzcz0iZ2x5cGhpY29uIGdseXBoaWNvbi1leGNsYW1hdGlvbi1zaWduIj48L3NwYW4+PHNwYW4gY2xhc3M9ImhlbHAtYmxvY2sgYWxwYWNhLWNvbnRyb2xmaWVsZC1tZXNzYWdlLXRleHQiPiR7bWVzc2FnZX08L3NwYW4+JywKICAgICAgICAiZmllbGRTZXRMZWdlbmQiOiAne3tpZiBvcHRpb25zLmxhYmVsfX08bGVnZW5kIGNsYXNzPSJ7e2lmIG9wdGlvbnMubGFiZWxDbGFzc319JHtvcHRpb25zLmxhYmVsQ2xhc3N9e3svaWZ9fSI+JHtvcHRpb25zLmxhYmVsfTwvbGVnZW5kPnt7L2lmfX0nLAogICAgICAgICJmaWVsZFNldEhlbHBlciI6ICd7e2lmIG9wdGlvbnMuaGVscGVyfX08cCBjbGFzcz0ie3tpZiBvcHRpb25zLmhlbHBlckNsYXNzfX0ke29wdGlvbnMuaGVscGVyQ2xhc3N9e3svaWZ9fSI+PGkgY2xhc3M9ImdseXBoaWNvbiBnbHlwaGljb24taW5mby1zaWduIGFscGFjYS1oZWxwZXItaWNvbiI+PC9pPiR7b3B0aW9ucy5oZWxwZXJ9PC9wPnt7L2lmfX0nLAogICAgICAgICJmaWVsZFNldEl0ZW1zQ29udGFpbmVyIjogJzxkaXY+e3todG1sIHRoaXMuaHRtbH19PC9kaXY+JywKICAgICAgICAiZmllbGRTZXQiOiAne3t3cmFwKG51bGwsIHt9KSBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmaWVsZFNldE91dGVyRWwiLHRydWUpfX17e2h0bWwgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiZmllbGRTZXRMZWdlbmQiKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0SGVscGVyIil9fXt7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiZmllbGRTZXRJdGVtc0NvbnRhaW5lciIsdHJ1ZSl9fXt7L3dyYXB9fXt7L3dyYXB9fScsCiAgICAgICAgImZpZWxkU2V0SXRlbUNvbnRhaW5lciI6ICc8ZGl2PjwvZGl2PicsCiAgICAgICAgLy8gVGVtcGxhdGVzIGZvciBmb3JtCiAgICAgICAgImZvcm1GaWVsZHNDb250YWluZXIiOiAnPGRpdj57e2h0bWwgdGhpcy5odG1sfX08L2Rpdj4nLAogICAgICAgICJmb3JtQnV0dG9uc0NvbnRhaW5lciI6ICc8ZGl2Pnt7aWYgb3B0aW9ucy5idXR0b25zfX17e2VhY2goayx2KSBvcHRpb25zLmJ1dHRvbnN9fTxidXR0b24gZGF0YS1rZXk9IiR7a30iIGNsYXNzPSJhbHBhY2EtZm9ybS1idXR0b24gYWxwYWNhLWZvcm0tYnV0dG9uLSR7a30gYnRuIGJ0bi1kZWZhdWx0IiB7e2VhY2goazEsdjEpIHZ9fSR7azF9PSIke3YxfSJ7ey9lYWNofX0+JHt2LnZhbHVlfTwvYnV0dG9uPnt7L2VhY2h9fXt7L2lmfX08L2Rpdj4nLAogICAgICAgICJmb3JtIjogJzxmb3JtIHJvbGU9ImZvcm0iPnt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmb3JtRmllbGRzQ29udGFpbmVyIil9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmb3JtQnV0dG9uc0NvbnRhaW5lciIpfX08L2Zvcm0+JywKICAgICAgICAvLyBUZW1wbGF0ZXMgZm9yIHdpemFyZAogICAgICAgICJ3aXphcmRTdGVwIiA6ICc8ZGl2IGNsYXNzPSJhbHBhY2EtY2xlYXIiPjwvZGl2PicsCiAgICAgICAgIndpemFyZE5hdkJhciIgOiAnPGRpdj48L2Rpdj4nLAogICAgICAgICJ3aXphcmRQcmVCdXR0b24iIDogJzxidXR0b24+QmFjazwvYnV0dG9uPicsCiAgICAgICAgIndpemFyZE5leHRCdXR0b24iIDogJzxidXR0b24+TmV4dDwvYnV0dG9uPicsCiAgICAgICAgIndpemFyZERvbmVCdXR0b24iIDogJzxidXR0b24+RG9uZTwvYnV0dG9uPicsCiAgICAgICAgIndpemFyZFN0YXR1c0JhciIgOiAnPG9sIGlkPSIke2lkfSI+e3tlYWNoKGksdikgdGl0bGVzfX08bGkgaWQ9InN0ZXBEZXNjJHtpfSI+PGRpdj48c3Ryb25nPjxzcGFuPiR7di50aXRsZX08L3NwYW4+JHt2LmRlc2NyaXB0aW9ufTwvc3Ryb25nPjwvZGl2PjwvbGk+e3svZWFjaH19PC9vbD4nLAoKICAgICAgICAiY29udHJvbEZpZWxkQ2hlY2tib3giOiAnPGRpdiBjbGFzcz0iY2hlY2tib3giIGlkPSIke2lkfSI+e3tpZiBvcHRpb25zLnJpZ2h0TGFiZWx9fTxsYWJlbCBmb3I9IiR7aWR9X2NoZWNrYm94Ij57ey9pZn19PGlucHV0IGlkPSIke2lkfV9jaGVja2JveCIgdHlwZT0iY2hlY2tib3giIHt7aWYgb3B0aW9ucy5yZWFkb25seX19cmVhZG9ubHk9InJlYWRvbmx5Int7L2lmfX0ge3tpZiBuYW1lfX1uYW1lPSIke25hbWV9Int7L2lmfX0ge3tlYWNoKGksdikgb3B0aW9ucy5kYXRhfX1kYXRhLSR7aX09IiR7dn0ie3svZWFjaH19Lz57e2lmIG9wdGlvbnMucmlnaHRMYWJlbH19JHtvcHRpb25zLnJpZ2h0TGFiZWx9PC9sYWJlbD57ey9pZn19PC9kaXY+JywKICAgICAgICAiY29udHJvbEZpZWxkQ2hlY2tib3hNdWx0aXBsZSI6ICc8ZGl2IGlkPSIke2lkfSI+e3tlYWNoKGksbykgY2hlY2tib3hPcHRpb25zfX08ZGl2IGNsYXNzPSJjaGVja2JveCI+PGxhYmVsIGZvcj0iJHtpZH1fY2hlY2tib3hfJHtpfSI+PGlucHV0IHR5cGU9ImNoZWNrYm94IiBpZD0iJHtpZH1fY2hlY2tib3hfJHtpfSIge3tpZiBvcHRpb25zLnJlYWRvbmx5fX1yZWFkb25seT0icmVhZG9ubHkie3svaWZ9fSB7e2lmIG5hbWV9fW5hbWU9IiR7bmFtZX0ie3svaWZ9fSBkYXRhLWNoZWNrYm94LXZhbHVlPSIke28udmFsdWV9IiBkYXRhLWNoZWNrYm94LWluZGV4PSIke2l9Ii8+JHtvLnRleHR9PC9sYWJlbD48L2Rpdj57ey9lYWNofX08L2Rpdj4nLAoKICAgICAgICAiY29udHJvbEZpZWxkUmFkaW8iOiAne3tpZiAhcmVxdWlyZWQgJiYgIXJlbW92ZURlZmF1bHROb25lfX08ZGl2IGNsYXNzPSJyYWRpbyI+PGlucHV0IHR5cGU9InJhZGlvIiB7e2lmIG9wdGlvbnMucmVhZG9ubHl9fXJlYWRvbmx5PSJyZWFkb25seSJ7ey9pZn19IG5hbWU9IiR7bmFtZX0iIGlkPSIke2lkfV9yYWRpb19ub25ldmFsdWUiIHZhbHVlPSIiLz48bGFiZWwgZm9yPSIke2lkfV9yYWRpb19ub25ldmFsdWUiPk5vbmU8L2xhYmVsPjwvZGl2Pnt7L2lmfX17e2VhY2ggc2VsZWN0T3B0aW9uc319PGRpdiBjbGFzcz0icmFkaW8iPjxpbnB1dCB0eXBlPSJyYWRpbyIge3tpZiBvcHRpb25zLnJlYWRvbmx5fX1yZWFkb25seT0icmVhZG9ubHkie3svaWZ9fSBuYW1lPSIke25hbWV9IiB2YWx1ZT0iJHt2YWx1ZX0iIGlkPSIke2lkfV9yYWRpb18keyRpbmRleH0iIHt7aWYgdmFsdWUgPT0gZGF0YX19Y2hlY2tlZD0iY2hlY2tlZCJ7ey9pZn19Lz48bGFiZWwgZm9yPSIke2lkfV9yYWRpb18keyRpbmRleH0iPiR7dGV4dH08L2xhYmVsPjwvZGl2Pnt7L2VhY2h9fScsCgogICAgICAgICJpdGVtTGFiZWwiOiAne3tpZiBvcHRpb25zLml0ZW1MYWJlbH19PGRpdiBjbGFzcz0iYWxwYWNhLWNvbnRyb2xmaWVsZC1sYWJlbCI+PGRpdj4ke29wdGlvbnMuaXRlbUxhYmVsfXt7aWYgaW5kZXh9fSA8c3BhbiBjbGFzcz0iYWxwYWNhLWl0ZW0tbGFiZWwtY291bnRlciI+JHtpbmRleH08L3NwYW4+e3svaWZ9fTwvZGl2PjwvZGl2Pnt7L2lmfX0nLAogICAgICAgICJhcnJheVRvb2xiYXIiOiAnPGRpdiBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWFycmF5LXRvb2xiYXIgYnRuLWdyb3VwIj48YnV0dG9uIGNsYXNzPSJhbHBhY2EtZmllbGRzZXQtYXJyYXktdG9vbGJhci1pY29uIGFscGFjYS1maWVsZHNldC1hcnJheS10b29sYmFyLWFkZCBidG4gYnRuLWRlZmF1bHQiPiR7YWRkSXRlbUxhYmVsfTwvYnV0dG9uPjwvc3Bhbj4nLAogICAgICAgICJhcnJheUl0ZW1Ub29sYmFyIjogJzxkaXYgY2xhc3M9ImFscGFjYS1maWVsZHNldC1hcnJheS1pdGVtLXRvb2xiYXIgYnRuLWdyb3VwIGJ0bi1ncm91cC1zbSI+e3tlYWNoKGssdikgYnV0dG9uc319PGJ1dHRvbiBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWFycmF5LWl0ZW0tdG9vbGJhci1pY29uIGFscGFjYS1maWVsZHNldC1hcnJheS1pdGVtLXRvb2xiYXItJHt2LmZlYXR1cmV9IGJ0biBidG4tZGVmYXVsdCBidG4tc20iPiR7di5sYWJlbH08L2J1dHRvbj57ey9lYWNofX08L2Rpdj4nCgoKICAgIH0pOwoKICAgIHZhciBkaXNwbGF5VGVtcGxhdGVzID0gQWxwYWNhLkNyZWF0ZShlZGl0VGVtcGxhdGVzLCB7CiAgICAgICAgImZpZWxkU2V0T3V0ZXJFbCI6ICc8ZmllbGRzZXQgZGlzYWJsZWQ+e3todG1sIHRoaXMuaHRtbH19PC9maWVsZHNldD4nCiAgICB9KTsKCiAgICBBbHBhY2Euc3R5bGVJbmplY3Rpb25zWyJib290c3RyYXAiXSA9IHsKCiAgICAgICAgLyoKICAgICAgICAvLyBlcnJvciBtZXNzYWdlcwogICAgICAgICJhZGRFcnJvck1lc3NhZ2UiOiBmdW5jdGlvbih0YXJnZXREaXYsIG1lc3NhZ2UpIHsKCiAgICAgICAgICAgIC8vIGlmIGJvb3RzdHJhcCBoYXMgdGhlIHRvb2x0aXAsIHdlIGNhbiBwcmV0dHkgdXAgdGhlIG1lc3NhZ2UKICAgICAgICAgICAgaWYgKCQuZm4udG9vbHRpcCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFyZ2V0RGl2LnRvb2x0aXAoewogICAgICAgICAgICAgICAgICAgICJodG1sIjogbWVzc2FnZQogICAgICAgICAgICAgICAgfSkuY2xpY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgICJidXR0b25CZWF1dGlmaWVyIiAgOiBmdW5jdGlvbihidXR0b24sIGljb25DbGFzcywgd2l0aFRleHQpIHsKICAgICAgICAgICAgdmFyIGJ1dHRvblRleHQgPSBidXR0b24uaHRtbCgpOwogICAgICAgICAgICBidXR0b24uYXR0cigidGl0bGUiLCBidXR0b25UZXh0KTsKICAgICAgICAgICAgdmFyIGFkZGVkQnV0dG9uVGV4dCA9IHdpdGhUZXh0ID8gYnV0dG9uVGV4dCA6ICIiOwogICAgICAgICAgICBidXR0b24uZW1wdHkoKS5hcHBlbmQoJzxiIGNsYXNzPSJhbHBhY2EtZmllbGRzZXQtbGVnZW5kLWJ1dHRvbiAnICsgaWNvbkNsYXNzICsgJyI+PC9iPjxzcGFuPicgKyBhZGRlZEJ1dHRvblRleHQgKyAnPC9zcGFuPicpOwogICAgICAgIH0sCiAgICAgICAgKi8KCiAgICAgICAgImZpZWxkIiA6IGZ1bmN0aW9uKHRhcmdldERpdikgewoKICAgICAgICAgICAgLy8gdGhlIGl0ZW0gY29udGFpbmVyIGdldHMgdGhlICJmb3JtLWdyb3VwIgogICAgICAgICAgICAvL3RhcmdldERpdi5wYXJlbnQoKS5hZGRDbGFzcygnZm9ybS1ncm91cCcpOwoKICAgICAgICAgICAgLy8gYWxsIGNvbnRyb2xzIGdldCB0aGUgImZvcm0tY29udHJvbCIgY2xhc3MgaW5qZWN0ZWQKICAgICAgICAgICAgJCh0YXJnZXREaXYpLmZpbmQoImlucHV0IikuYWRkQ2xhc3MoImZvcm0tY29udHJvbCIpOwogICAgICAgICAgICAkKHRhcmdldERpdikuZmluZCgidGV4dGFyZWEiKS5hZGRDbGFzcygiZm9ybS1jb250cm9sIik7CiAgICAgICAgICAgICQodGFyZ2V0RGl2KS5maW5kKCJzZWxlY3QiKS5hZGRDbGFzcygiZm9ybS1jb250cm9sIik7CiAgICAgICAgICAgIC8vIGV4Y2VwdCBmb3IgdGhlIGZvbGxvd2luZwogICAgICAgICAgICAkKHRhcmdldERpdikuZmluZCgiaW5wdXRbdHlwZT1jaGVja2JveF0iKS5yZW1vdmVDbGFzcygiZm9ybS1jb250cm9sIik7CiAgICAgICAgICAgICQodGFyZ2V0RGl2KS5maW5kKCJpbnB1dFt0eXBlPWZpbGVdIikucmVtb3ZlQ2xhc3MoImZvcm0tY29udHJvbCIpOwogICAgICAgICAgICAkKHRhcmdldERpdikuZmluZCgiaW5wdXRbdHlwZT1yYWRpb10iKS5yZW1vdmVDbGFzcygiZm9ybS1jb250cm9sIik7CgogICAgICAgICAgICAvLyBhbnkgY2hlY2tib3ggaW5wdXRzIGdldCB0aGUgImNoZWNrYm94IiBjbGFzcyBvbiB0aGVpciBjb250YWluZXIKCiAgICAgICAgICAgIC8vIGFueSBjaGVja2JveCBpbnB1dHMgZ2V0IHRoZSAiY2hlY2tib3giIGNsYXNzIG9uIHRoZWlyIGNoZWNrYm94CiAgICAgICAgICAgIC8vIFRPRE86IHJlbW92ZSwgdGhpcyBpcyBub3cgZG9uZSBieSB0aGUgdGVtcGxhdGUgaXRzZWxmCiAgICAgICAgICAgIC8vJCh0YXJnZXREaXYpLmZpbmQoImlucHV0W3R5cGU9Y2hlY2tib3hdIikucGFyZW50KCkucGFyZW50KCkuYWRkQ2xhc3MoImNoZWNrYm94Iik7CiAgICAgICAgICAgIC8vIGFueSByYWRpbyBpbnB1dHMgZ2V0IHRoZSAicmFkaW8iIGNsYXNzIG9uIHRoZWlyIHJhZGlvCiAgICAgICAgICAgICQodGFyZ2V0RGl2KS5maW5kKCJpbnB1dFt0eXBlPXJhZGlvXSIpLnBhcmVudCgpLnBhcmVudCgpLmFkZENsYXNzKCJyYWRpbyIpOwoKICAgICAgICAgICAgLy8gaWYgZm9ybSBoYXMgImZvcm0taW5saW5lIiBjbGFzcywgdGhlbiByYWRpbyBhbmQgY2hlY2tib3ggbGFiZWxzIGdldCBpbmxpbmUgY2xhc3NlcwogICAgICAgICAgICBpZiAoJCh0YXJnZXREaXYpLnBhcmVudHMoImZvcm0iKS5oYXNDbGFzcygiZm9ybS1pbmxpbmUiKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gY2hlY2tib3hlcwogICAgICAgICAgICAgICAgJCh0YXJnZXREaXYpLmZpbmQoImlucHV0W3R5cGU9Y2hlY2tib3hdIikucGFyZW50KCkuYWRkQ2xhc3MoImNoZWNrYm94LWlubGluZSIpOwoKICAgICAgICAgICAgICAgIC8vIHJhZGlvcwogICAgICAgICAgICAgICAgJCh0YXJnZXREaXYpLmZpbmQoImlucHV0W3R5cGU9cmFkaW9dIikucGFyZW50KCkuYWRkQ2xhc3MoInJhZGlvLWlubGluZSIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUT0RPOiBmb3JtLWhvcml6b250YWw/CiAgICAgICAgfSwKCiAgICAgICAgLy8gaWNvbnMKICAgICAgICAiY29tbW9uSWNvbiIgOiAiIiwKICAgICAgICAiYWRkSWNvbiIgOiAiZ2x5cGhpY29uIGdseXBoaWNvbi1wbHVzLXNpZ24iLAogICAgICAgICJyZW1vdmVJY29uIiA6ICJnbHlwaGljb24gZ2x5cGhpY29uLW1pbnVzLXNpZ24iLAogICAgICAgICJ1cEljb24iIDogImdseXBoaWNvbiBnbHlwaGljb24tY2hldnJvbi11cCIsCiAgICAgICAgImRvd25JY29uIiA6ICJnbHlwaGljb24gZ2x5cGhpY29uLWNoZXZyb24tZG93biIsCiAgICAgICAgImNvbnRhaW5lckV4cGFuZGVkSWNvbiIgOiAiZ2x5cGhpY29uIGdseXBoaWNvbi1jaXJjbGUtYXJyb3ctZG93biIsCiAgICAgICAgImNvbnRhaW5lckNvbGxhcHNlZEljb24iIDogImdseXBoaWNvbiBnbHlwaGljb24tY2lyY2xlLWFycm93LXJpZ2h0IiwKICAgICAgICAid2l6YXJkUHJlSWNvbiIgOiAiZ2x5cGhpY29uIGdseXBoaWNvbi1jaGV2cm9uLWxlZnQiLAogICAgICAgICJ3aXphcmROZXh0SWNvbiIgOiAiZ2x5cGhpY29uIGdseXBoaWNvbi1jaGV2cm9uLXJpZ2h0IiwKICAgICAgICAid2l6YXJkRG9uZUljb24iIDogImdseXBoaWNvbiBnbHlwaGljb24tb2siLAoKCiAgICAgICAgLy8gcmVxdWlyZWQgZmllbGRzIGdldCBzdGFyIGljb24KICAgICAgICAicmVxdWlyZWQiIDogZnVuY3Rpb24odGFyZ2V0RGl2KQogICAgICAgIHsKICAgICAgICAgICAgJCgnPHNwYW4gY2xhc3M9ImdseXBoaWNvbiBnbHlwaGljb24tc3RhciI+PC9zcGFuPiZuYnNwOycpLnByZXBlbmRUbyh0YXJnZXREaXYpOwogICAgICAgIH0sCgogICAgICAgIC8vIGVycm9yIGZpZWxkcyBnZXQgdGhlICJoYXMtZXJyb3IiIGNsYXNzCiAgICAgICAgImVycm9yIiA6IGZ1bmN0aW9uKHRhcmdldERpdikgewogICAgICAgICAgICB0YXJnZXREaXYuYWRkQ2xhc3MoJ2hhcy1lcnJvcicpOwoKICAgICAgICAgICAgLyoKICAgICAgICAgICAgJCh0YXJnZXREaXYpLnBvcG92ZXIoewogICAgICAgICAgICAgICAgImh0bWwiOiB0cnVlLAogICAgICAgICAgICAgICAgInRyaWdnZXIiOiAibWFudWFsIiwKICAgICAgICAgICAgICAgICJjb250ZW50IjogImVycm9yIG1lc3NhZ2UiCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAkKHRhcmdldERpdikub24oInNob3duLmJzLnBvcG92ZXIiLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGRlYnVnZ2VyOwogICAgICAgICAgICAgICAgJCh0aGlzKS5jc3MoewogICAgICAgICAgICAgICAgICAgICJib3JkZXIiOiAiMXB4IHJlZCBzb2xpZCIsCiAgICAgICAgICAgICAgICAgICAgImNvbG9yIjogInJlZCIKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgJCh0YXJnZXREaXYpLnBvcG92ZXIoInNob3ciKTsKICAgICAgICAgICAgKi8KICAgICAgICB9LAogICAgICAgICJyZW1vdmVFcnJvciIgOiBmdW5jdGlvbih0YXJnZXREaXYpIHsKICAgICAgICAgICAgdGFyZ2V0RGl2LnJlbW92ZUNsYXNzKCdoYXMtZXJyb3InKTsKCiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICQodGFyZ2V0RGl2KS5wb3BvdmVyKCJoaWRlIik7CiAgICAgICAgICAgICovCgogICAgICAgICAgICAvKgogICAgICAgICAgICAkKHRhcmdldERpdikub24oImhpZGRlbi5icy5wb3BvdmVyIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkKHRhcmdldERpdikucG9wb3ZlcigiZGVzdHJveSIpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgKi8KICAgICAgICB9LAoKICAgICAgICAvLyBUaGUgV2l6YXJkIHN0aWxsIHJlbGllcyBvbiBqUXVlcnkgVUkKICAgICAgICAid2l6YXJkU3RhdHVzQmFyIiA6IGZ1bmN0aW9uKHRhcmdldERpdikgewogICAgICAgICAgICB0YXJnZXREaXYuYWRkQ2xhc3MoJ3VpLXdpZGdldC1oZWFkZXIgdWktY29ybmVyLWFsbCcpOwogICAgICAgIH0sCiAgICAgICAgIndpemFyZEN1cnJlbnRTdGVwIiA6IGZ1bmN0aW9uKHRhcmdldERpdikgewogICAgICAgICAgICB0YXJnZXREaXYuYWRkQ2xhc3MoJ3VpLXN0YXRlLWhpZ2hsaWdodCB1aS1jb3JuZXItYWxsJyk7CiAgICAgICAgfSwKICAgICAgICAid2l6YXJkVW5DdXJyZW50U3RlcCIgOiBmdW5jdGlvbih0YXJnZXREaXYpIHsKICAgICAgICAgICAgdGFyZ2V0RGl2LnJlbW92ZUNsYXNzKCd1aS1zdGF0ZS1oaWdobGlnaHQgdWktY29ybmVyLWFsbCcpOwogICAgICAgIH0sCgogICAgICAgICJidXR0b25CZWF1dGlmaWVyIiAgOiBmdW5jdGlvbihidXR0b24sIGljb25DbGFzcywgd2l0aFRleHQpIHsKICAgICAgICAgICAgdmFyIGJ1dHRvblRleHQgPSBidXR0b24uaHRtbCgpOwogICAgICAgICAgICBidXR0b24uYXR0cigidGl0bGUiLCBidXR0b25UZXh0KTsKICAgICAgICAgICAgYnV0dG9uLmVtcHR5KCkuYXBwZW5kKCc8YiBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWxlZ2VuZC1idXR0b24gJyArIGljb25DbGFzcyArICciPjwvYj4nKTsKICAgICAgICAgICAgdmFyIGFkZGVkQnV0dG9uVGV4dCA9IHdpdGhUZXh0ID8gYnV0dG9uVGV4dCA6IG51bGw7CiAgICAgICAgICAgIGlmIChhZGRlZEJ1dHRvblRleHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGJ1dHRvbi5hcHBlbmQoJzxzcGFuIGNsYXNzPSJhbHBhY2EtZmllbGRzZXQtbGVnZW5kLWJ1dHRvbi10ZXh0Ij4nICsgYWRkZWRCdXR0b25UZXh0ICsgJzwvc3Bhbj4nKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgogICAgdmFyIHJlbmRlckZ1bmN0aW9uID0gZnVuY3Rpb24oZmllbGQsIHJlbmRlcmVkQ2FsbGJhY2spCiAgICB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICBmaWVsZC5yZW5kZXIoZnVuY3Rpb24oZmllbGQpIHsKCiAgICAgICAgICAgIGlmIChyZW5kZXJlZENhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICByZW5kZXJlZENhbGxiYWNrLmNhbGwoc2VsZiwgZmllbGQpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9OwoKICAgIEFscGFjYS5yZWdpc3RlclZpZXcoewogICAgICAgICJpZCI6ICJWSUVXX0JPT1RTVFJBUF9ESVNQTEFZIiwKICAgICAgICAicGFyZW50IjogIlZJRVdfV0VCX0RJU1BMQVkiLAogICAgICAgICJ0aXRsZSI6ICJEaXNwbGF5IFZpZXcgZm9yIEJvb3RzdHJhcCIsCiAgICAgICAgImRlc2NyaXB0aW9uIjogIkRpc3BsYXkgVmlldyBmb3IgQm9vdHN0cmFwIiwKICAgICAgICAic3R5bGUiOiAiYm9vdHN0cmFwIiwKICAgICAgICAidWkiOiAiYm9vdHN0cmFwIiwKICAgICAgICAidGVtcGxhdGVzIjogZGlzcGxheVRlbXBsYXRlcywKICAgICAgICAicmVuZGVyIjogcmVuZGVyRnVuY3Rpb24sCiAgICAgICAgInR5cGUiOiAidmlldyIKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3RlclZpZXcoewogICAgICAgICJpZCI6ICJWSUVXX0JPT1RTVFJBUF9FRElUIiwKICAgICAgICAicGFyZW50IjogJ1ZJRVdfV0VCX0VESVQnLAogICAgICAgICJ0aXRsZSI6ICJFZGl0IFZpZXcgZm9yIEJvb3RzdHJhcCIsCiAgICAgICAgImRlc2NyaXB0aW9uIjogIkVkaXQgVmlldyBmb3IgQm9vdHN0cmFwIiwKICAgICAgICAic3R5bGUiOiAiYm9vdHN0cmFwIiwKICAgICAgICAidWkiOiAiYm9vdHN0cmFwIiwKICAgICAgICAidGVtcGxhdGVzIjogZWRpdFRlbXBsYXRlcywKICAgICAgICAicmVuZGVyIjogcmVuZGVyRnVuY3Rpb24sCiAgICAgICAgInR5cGUiOiAiZWRpdCIKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3RlclZpZXcoewogICAgICAgICJpZCI6ICJWSUVXX0JPT1RTVFJBUF9DUkVBVEUiLAogICAgICAgICJwYXJlbnQiOiAnVklFV19XRUJfQ1JFQVRFJywKICAgICAgICAidGl0bGUiOiAiQ3JlYXRlIFZpZXcgZm9yIEJvb3RzdHJhcCIsCiAgICAgICAgImRlc2NyaXB0aW9uIjoiQ3JlYXRlIFZpZXcgZm9yIEJvb3RzdHJhcCIsCiAgICAgICAgInN0eWxlIjogImJvb3RzdHJhcCIsCiAgICAgICAgInVpIjogImJvb3RzdHJhcCIsCiAgICAgICAgInRlbXBsYXRlcyI6IGVkaXRUZW1wbGF0ZXMsCiAgICAgICAgInJlbmRlciI6IHJlbmRlckZ1bmN0aW9uLAogICAgICAgICJ0eXBlIjogImNyZWF0ZSIKICAgIH0pOwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLnJlZ2lzdGVyVmlldyh7CiAgICAgICAgImlkIjogIlZJRVdfV0VCX0VESVRfVEFCTEUiLAogICAgICAgICJwYXJlbnQiOiAnVklFV19XRUJfRURJVCcsCiAgICAgICAgInRpdGxlIjogIldlYiBFZGl0IFZpZXcgVGFibGUgU3R5bGUiLAogICAgICAgICJkZXNjcmlwdGlvbiI6ICJXZWIgZWRpdCB2aWV3IGJhc2VkIG9uIHRhYmxlIHN0eWxlcy4iLAogICAgICAgICJ0eXBlIjogImVkaXQiLAogICAgICAgICJkaXNwbGF5UmVhZG9ubHkiOiB0cnVlLAogICAgICAgICJjb2xsYXBzaWJsZSI6IGZhbHNlLAogICAgICAgICJsZWdlbmRTdHlsZSI6ICJsaW5rIiwKICAgICAgICAidGVtcGxhdGVzIjogewoKICAgICAgICAgICAgLy8gVGVtcGxhdGVzIGZvciBjb250cm9sIGZpZWxkcwogICAgICAgICAgICAiY29udHJvbEZpZWxkT3V0ZXJFbCI6IG51bGwsCiAgICAgICAgICAgICJjb250cm9sRmllbGRMYWJlbCI6ICc8dGQ+e3tpZiBvcHRpb25zLmxhYmVsfX08bGFiZWwgZm9yPSIke2lkfSIgY2xhc3M9Int7aWYgb3B0aW9ucy5sYWJlbENsYXNzfX0ke29wdGlvbnMubGFiZWxDbGFzc317ey9pZn19Ij4ke29wdGlvbnMubGFiZWx9PC9sYWJlbD57ey9pZn19PC90ZD4nLAogICAgICAgICAgICAiY29udHJvbEZpZWxkQ29udGFpbmVyIjogJzx0ZCBkYXRhLWNvbnRyb2w9ImFwcGVuZCI+e3todG1sIHRoaXMuaHRtbH19PC90ZD4nLAogICAgICAgICAgICAiY29udHJvbEZpZWxkTWVzc2FnZSI6ICc8ZGl2PjxzcGFuIGNsYXNzPSJ1aS1pY29uIHVpLWljb24tYWxlcnQiPjwvc3Bhbj48c3BhbiBjbGFzcz0iYWxwYWNhLWNvbnRyb2xmaWVsZC1tZXNzYWdlLXRleHQiPiR7bWVzc2FnZX08L3NwYW4+PC9kaXY+JywKICAgICAgICAgICAgImNvbnRyb2xGaWVsZEhlbHBlciI6ICd7e2lmIG9wdGlvbnMuaGVscGVyfX08ZGl2IGNsYXNzPSJ7e2lmIG9wdGlvbnMuaGVscGVyQ2xhc3N9fSR7b3B0aW9ucy5oZWxwZXJDbGFzc317ey9pZn19Ij48c3BhbiBjbGFzcz0idWktaWNvbiB1aS1pY29uLWluZm8iPjwvc3Bhbj48c3BhbiBjbGFzcz0iYWxwYWNhLWNvbnRyb2xmaWVsZC1oZWxwZXItdGV4dCI+JHtvcHRpb25zLmhlbHBlcn08L3NwYW4+PC9kaXY+e3svaWZ9fScsCiAgICAgICAgICAgICJjb250cm9sRmllbGQiOgogICAgICAgICAgICAgICAgJ3t7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJjb250cm9sRmllbGRMYWJlbCIpfX0nICsKICAgICAgICAgICAgICAgICd7e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImNvbnRyb2xGaWVsZENvbnRhaW5lciIsdHJ1ZSl9fScgKwogICAgICAgICAgICAgICAgICAgICd7e2h0bWwgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiY29udHJvbEZpZWxkSGVscGVyIil9fScgKwogICAgICAgICAgICAgICAgJ3t7L3dyYXB9fScsCgogICAgICAgICAgICAvLyBUZW1wbGF0ZXMgZm9yIGNvbnRhaW5lciBmaWVsZHMKICAgICAgICAgICAgImZpZWxkU2V0T3V0ZXJFbCI6ICc8ZmllbGRzZXQgY2xhc3M9ImFscGFjYS12aWV3LXdlYi1lZGl0LXRhYmxlIj57e2h0bWwgdGhpcy5odG1sfX08L2ZpZWxkc2V0PicsCiAgICAgICAgICAgICJmaWVsZFNldE1lc3NhZ2UiOiAnPGRpdj48c3BhbiBjbGFzcz0idWktaWNvbiB1aS1pY29uLWFsZXJ0IGFscGFjYS1maWVsZHNldC1tZXNzYWdlLXRhYmxlLXZpZXciPjwvc3Bhbj48c3Bhbj4ke21lc3NhZ2V9PC9zcGFuPjwvZGl2PicsCiAgICAgICAgICAgICJmaWVsZFNldExlZ2VuZCI6ICd7e2lmIG9wdGlvbnMubGFiZWx9fTxsZWdlbmQgY2xhc3M9Int7aWYgb3B0aW9ucy5sYWJlbENsYXNzfX0ke29wdGlvbnMubGFiZWxDbGFzc317ey9pZn19Ij4ke29wdGlvbnMubGFiZWx9PC9sZWdlbmQ+e3svaWZ9fScsCiAgICAgICAgICAgICJmaWVsZFNldEhlbHBlciI6ICd7e2lmIG9wdGlvbnMuaGVscGVyfX08ZGl2IGNsYXNzPSJ7e2lmIG9wdGlvbnMuaGVscGVyQ2xhc3N9fSR7b3B0aW9ucy5oZWxwZXJDbGFzc317ey9pZn19Ij4ke29wdGlvbnMuaGVscGVyfTwvZGl2Pnt7L2lmfX0nLAogICAgICAgICAgICAiZmllbGRTZXRJdGVtc0NvbnRhaW5lciI6ICc8dGFibGU+PHRib2R5Pnt7aHRtbCB0aGlzLmh0bWx9fTwvdGJvZHk+PC90YWJsZT4nLAogICAgICAgICAgICAiZmllbGRTZXQiOiAne3t3cmFwKG51bGwsIHt9KSBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmaWVsZFNldE91dGVyRWwiLHRydWUpfX17e2h0bWwgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiZmllbGRTZXRMZWdlbmQiKX19e3todG1sIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0SGVscGVyIil9fXt7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiZmllbGRTZXRJdGVtc0NvbnRhaW5lciIsdHJ1ZSl9fXt7L3dyYXB9fXt7L3dyYXB9fScsCiAgICAgICAgICAgICJmaWVsZFNldEl0ZW1Db250YWluZXIiOiAnPHRyPjwvdHI+JywKCiAgICAgICAgICAgICJpdGVtTGFiZWwiIDogJ3t7aWYgb3B0aW9ucy5pdGVtTGFiZWx9fTxsYWJlbCBmb3I9IiR7aWR9IiBjbGFzcz0iYWxwYWNhLWNvbnRyb2xmaWVsZC1sYWJlbCBhbHBhY2EtY29udHJvbGZpZWxkLWxhYmVsLWxpc3QtdmlldyI+PHNwYW4gY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtaXRlbS1sYWJlbC1saXN0LXZpZXciPiR7b3B0aW9ucy5pdGVtTGFiZWx9e3tpZiBpbmRleH19IDxzcGFuIGNsYXNzPSJhbHBhY2EtaXRlbS1sYWJlbC1jb3VudGVyIj4ke2luZGV4fTwvc3Bhbj48L3NwYW4+e3svaWZ9fTwvbGFiZWw+e3svaWZ9fScKICAgICAgICB9LAogICAgICAgICJzdHlsZXMiOiB7CiAgICAgICAgfSwKICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAiLyI6IHsKICAgICAgICAgICAgICAgICJ0ZW1wbGF0ZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgLy8gVGVtcGxhdGVzIGZvciBjb250YWluZXIgZmllbGRzCiAgICAgICAgICAgICAgICAgICAgImZpZWxkU2V0SXRlbXNDb250YWluZXIiOiAnPHRhYmxlIGNsYXNzPSJhbHBhY2EtZmllbGRzZXQtaXRlbXNjb250YWluZXItbGlzdC12aWV3LXRvcCI+e3todG1sIHRoaXMuaHRtbH19PC90YWJsZT4nLAogICAgICAgICAgICAgICAgICAgICJmaWVsZFNldEl0ZW1Db250YWluZXIiOiAnPHRyIGNsYXNzPSJhbHBhY2EtZmllbGRzZXQtaXRlbXNjb250YWluZXItbGlzdC12aWV3LXRvcCI+PC90cj4nCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyVmlldyh7CiAgICAgICAgImlkIjogIlZJRVdfV0VCX0NSRUFURV9UQUJMRSIsCiAgICAgICAgInBhcmVudCI6ICdWSUVXX1dFQl9FRElUX1RBQkxFJywKICAgICAgICAidGl0bGUiOiAiRGVmYXVsdCBXZWIgQ3JlYXRlIFZpZXcgVGFibGUgU3RsZSIsCiAgICAgICAgImRlc2NyaXB0aW9uIjoiRGVmYXVsdCB3ZWIgY3JlYXRlIHZpZXcgKFRhYmxlIFN0eWxlKSB3aGljaCBkb2Vzbid0IGJpbmQgaW5pdGlhbCBkYXRhLiIsCiAgICAgICAgInR5cGUiOiAiY3JlYXRlIiwKICAgICAgICAiZGlzcGxheVJlYWRvbmx5IjpmYWxzZQogICAgfSk7Cgp9KShqUXVlcnkpOyhmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5yZWdpc3RlclZpZXcoewogICAgICAgICJpZCI6ICJWSUVXX1dFQl9FRElUX1lBTUwiLAogICAgICAgICJwYXJlbnQiOiAnVklFV19XRUJfRURJVCcsCiAgICAgICAgInRpdGxlIjogIldlYiBFZGl0IFZpZXcgTGlzdCBTdHlsZSIsCiAgICAgICAgImRlc2NyaXB0aW9uIjogIldlYiBlZGl0IGxpc3Qgc3R5bGVkIHRvIGxvb2sgbGlrZSBhIFlBTUwgZWRpdG9yLiIsCiAgICAgICAgInR5cGUiOiAiZWRpdCIsCiAgICAgICAgImRpc3BsYXlSZWFkb25seSI6IHRydWUsCiAgICAgICAgImNvbGxhcHNpYmxlIjogdHJ1ZSwKICAgICAgICAibGVnZW5kU3R5bGUiOiAibGluayIsCiAgICAgICAgInRlbXBsYXRlcyI6IHsKICAgICAgICAgICAgLy8gVGVtcGxhdGVzIGZvciBjb250cm9sIGZpZWxkcwogICAgICAgICAgICAiY29udHJvbEZpZWxkT3V0ZXJFbCI6ICc8c3BhbiBjbGFzcz0iYWxwYWNhLXZpZXctd2ViLWVkaXQteWFtbCIgdGl0bGU9IiR7b3B0aW9ucy5oZWxwZXJ9Ij57e2h0bWwgdGhpcy5odG1sfX08L3NwYW4+JywKICAgICAgICAgICAgImNvbnRyb2xGaWVsZE1lc3NhZ2UiOiAnPGRpdj48c3BhbiBjbGFzcz0idWktaWNvbiB1aS1pY29uLWFsZXJ0Ij48L3NwYW4+PHNwYW4gY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtbWVzc2FnZS10ZXh0Ij4ke21lc3NhZ2V9PC9zcGFuPjwvZGl2PicsCiAgICAgICAgICAgICJjb250cm9sRmllbGRMYWJlbCI6ICd7e2lmIG9wdGlvbnMubGFiZWx9fTxsYWJlbCBmb3I9IiR7aWR9IiBjbGFzcz0ie3tpZiBvcHRpb25zLmxhYmVsQ2xhc3N9fSR7b3B0aW9ucy5sYWJlbENsYXNzfXt7L2lmfX0iPiR7b3B0aW9ucy5sYWJlbH06PC9sYWJlbD57ey9pZn19JywKICAgICAgICAgICAgImNvbnRyb2xGaWVsZEhlbHBlciI6ICc8c3BhbiBzdHlsZT0iZGlzcGxheTpub25lIiAvPicsCiAgICAgICAgICAgICJjb250cm9sRmllbGRDb250YWluZXIiOiAnPGRpdj57e2h0bWwgdGhpcy5odG1sfX08L2Rpdj4nLAogICAgICAgICAgICAiY29udHJvbEZpZWxkIjogJ3t7d3JhcChudWxsLCB7fSkgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiY29udHJvbEZpZWxkT3V0ZXJFbCIsdHJ1ZSl9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJjb250cm9sRmllbGRMYWJlbCIpfX17e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImNvbnRyb2xGaWVsZENvbnRhaW5lciIsdHJ1ZSl9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJjb250cm9sRmllbGRIZWxwZXIiKX19e3svd3JhcH19e3svd3JhcH19JywKICAgICAgICAgICAgLy8gVGVtcGxhdGVzIGZvciBjb250YWluZXIgZmllbGRzCiAgICAgICAgICAgICJmaWVsZFNldE91dGVyRWwiOiAnPGZpZWxkc2V0IGNsYXNzPSJhbHBhY2Etdmlldy13ZWItZWRpdC15YW1sIj57e2h0bWwgdGhpcy5odG1sfX08L2ZpZWxkc2V0PicsCiAgICAgICAgICAgICJmaWVsZFNldE1lc3NhZ2UiOiAnPGRpdj48c3BhbiBjbGFzcz0idWktaWNvbiB1aS1pY29uLWFsZXJ0IGFscGFjYS1maWVsZHNldC1tZXNzYWdlLWxpc3QtdmlldyI+PC9zcGFuPjxzcGFuPiR7bWVzc2FnZX08L3NwYW4+PC9kaXY+JywKICAgICAgICAgICAgImZpZWxkU2V0TGVnZW5kIjogJ3t7aWYgb3B0aW9ucy5sYWJlbH19PGxlZ2VuZCBjbGFzcz0ie3tpZiBvcHRpb25zLmxhYmVsQ2xhc3N9fSR7b3B0aW9ucy5sYWJlbENsYXNzfXt7L2lmfX0iPiR7b3B0aW9ucy5sYWJlbH08L2xlZ2VuZD57ey9pZn19JywKICAgICAgICAgICAgImZpZWxkU2V0SGVscGVyIjogJ3t7aWYgb3B0aW9ucy5oZWxwZXJ9fTxkaXYgY2xhc3M9Int7aWYgb3B0aW9ucy5oZWxwZXJDbGFzc319JHtvcHRpb25zLmhlbHBlckNsYXNzfXt7L2lmfX0iPiR7b3B0aW9ucy5oZWxwZXJ9PC9kaXY+e3svaWZ9fScsCiAgICAgICAgICAgICJmaWVsZFNldEl0ZW1zQ29udGFpbmVyIjogJzxvbD57e2h0bWwgdGhpcy5odG1sfX08L29sPicsCiAgICAgICAgICAgICJmaWVsZFNldCI6ICd7e3dyYXAobnVsbCwge30pIEFscGFjYS5maWVsZFRlbXBsYXRlKHRoaXMsImZpZWxkU2V0T3V0ZXJFbCIsdHJ1ZSl9fXt7aHRtbCBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmaWVsZFNldExlZ2VuZCIpfX17e2h0bWwgQWxwYWNhLmZpZWxkVGVtcGxhdGUodGhpcywiZmllbGRTZXRIZWxwZXIiKX19e3t3cmFwKG51bGwsIHt9KSBBbHBhY2EuZmllbGRUZW1wbGF0ZSh0aGlzLCJmaWVsZFNldEl0ZW1zQ29udGFpbmVyIix0cnVlKX19e3svd3JhcH19e3svd3JhcH19JywKICAgICAgICAgICAgImZpZWxkU2V0SXRlbUNvbnRhaW5lciI6ICc8bGkgc3R5bGU9Imxpc3Qtc3R5bGU6bm9uZTsiPjwvbGk+JywKCiAgICAgICAgICAgICJpdGVtTGFiZWwiIDogJ3t7aWYgb3B0aW9ucy5pdGVtTGFiZWx9fTxsYWJlbCBmb3I9IiR7aWR9IiBjbGFzcz0iYWxwYWNhLWNvbnRyb2xmaWVsZC1sYWJlbCBhbHBhY2EtY29udHJvbGZpZWxkLWxhYmVsLWxpc3QtdmlldyI+PHNwYW4gY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtaXRlbS1sYWJlbC1saXN0LXZpZXciPiR7b3B0aW9ucy5pdGVtTGFiZWx9e3tpZiBpbmRleH19IDxzcGFuIGNsYXNzPSJhbHBhY2EtaXRlbS1sYWJlbC1jb3VudGVyIj4ke2luZGV4fTwvc3Bhbj48L3NwYW4+e3svaWZ9fTwvbGFiZWw+e3svaWZ9fScKCiAgICAgICAgfSwKICAgICAgICAic3R5bGVzIjogewogICAgICAgIH0sCiAgICAgICAgImZpZWxkcyI6IHsKICAgICAgICAgICAgIi8iOiB7CiAgICAgICAgICAgICAgICAidGVtcGxhdGVzIjogewogICAgICAgICAgICAgICAgICAgIC8vIFRlbXBsYXRlcyBmb3IgY29udGFpbmVyIGZpZWxkcwogICAgICAgICAgICAgICAgICAgICJmaWVsZFNldEl0ZW1zQ29udGFpbmVyIjogJzxvbCBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWl0ZW1zY29udGFpbmVyLWxpc3Qtdmlldy10b3AiPnt7aHRtbCB0aGlzLmh0bWx9fTwvb2w+JywKICAgICAgICAgICAgICAgICAgICAiZmllbGRTZXRJdGVtQ29udGFpbmVyIjogJzxsaSBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWl0ZW1jb250YWluZXItbGlzdC12aWV3LXRvcCI+PC9saT4nCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKfSkoalF1ZXJ5KTsKLypqc2hpbnQgLVcwMTQgKi8gLy8gYmFkIGxpbmUgYnJlYWtpbmcKKGZ1bmN0aW9uKCQpIHsKICAgIAogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwogICAgCiAgICBBbHBhY2EucmVnaXN0ZXJWaWV3KHsKICAgICAgICAiaWQiOiJWSUVXX1dFQl9FRElUX0lOTElORSIsCiAgICAgICAgInBhcmVudCI6IlZJRVdfV0VCX0VESVQiLAogICAgICAgICJ0aXRsZSI6IkRlZmF1bHQgV2ViIEVkaXQgd2l0aCBmaWVsZHMgaW5saW5pbmcgY2FwYWJpbGl0aWVzIiwKICAgICAgICAiZGVzY3JpcHRpb24iOiJFZGl0IHRlbXBsYXRlIHdpdGggZm9ybSBmaWVsZHMgaW5saW5pbmcgY2FwYWJpbGl0aWVzLCB2aWEgb3B0aW9ucy5pbmxpbmUgbGV2ZWwgdG8gZGlzcGxheSBzb21lIGZvcm1zIHBhcnRzIGlubGluZS4gVXNlZnVsIHRvIGRpc3BsYXkgZm9yIGV4YW1wbGUgYW4gQXJyYXlGaWVsZCBjb250YWluaW5nIE9iamVjdEZpZWxkIGl0ZW1zIGluIGEgY29tcGFjdCBtYW5uZXIuIiwKICAgICAgICAidHlwZSI6ImVkaXQiLAogICAgICAgICJwbGF0Zm9ybSI6IndlYiIsCiAgICAgICAgInN0eWxlIjoianF1ZXJ5LXVpIiwKICAgICAgICAiZGlzcGxheVJlYWRvbmx5Ijp0cnVlLAogICAgICAgICJ0ZW1wbGF0ZXMiOiB7CiAgICAgICAgICAgICJmaWVsZFNldE91dGVyRWwiOiAnPGZpZWxkc2V0IGNsYXNzPSJ7e2lmIG9wdGlvbnMuaW5saW5lfX1hbHBhY2EtaW5saW5le3svaWZ9fSI+e3todG1sIHRoaXMuaHRtbH19PC9maWVsZHNldD4nLAogICAgICAgICAgICAiZmllbGRTZXRJdGVtQ29udGFpbmVyIjogJzxkaXYgY2xhc3M9ImFscGFjYS1pbmxpbmUtaXRlbS1jb250YWluZXIiPjwvZGl2PicsICAgICAgICAgICAgCiAgICAgICAgICAgICJhcnJheUl0ZW1Ub29sYmFyIjogJzxkaXYgY2xhc3M9ImFscGFjYS1maWVsZHNldC1hcnJheS1pdGVtLXRvb2xiYXIiIGRhdGEtcm9sZT0iY29udHJvbGdyb3VwIiBkYXRhLXR5cGU9Imhvcml6b250YWwiIGRhdGEtbWluaT0idHJ1ZSI+JwogICAgICAgICAgICAgICAgKyc8c3BhbiBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWFycmF5LWl0ZW0tdG9vbGJhci1hZGQiIGRhdGEtcm9sZT0iYnV0dG9uIiBkYXRhLWljb249ImFkZCIgZGF0YS1pY29ucG9zPSJub3RleHQiPkFkZDwvc3Bhbj4nCiAgICAgICAgICAgICAgICArJzxzcGFuIGNsYXNzPSJhbHBhY2EtZmllbGRzZXQtYXJyYXktaXRlbS10b29sYmFyLXJlbW92ZSIgZGF0YS1yb2xlPSJidXR0b24iIGRhdGEtaWNvbj0iZGVsZXRlIiBkYXRhLWljb25wb3M9Im5vdGV4dCI+RGVsZXRlPC9zcGFuPicKICAgICAgICAgICAgICAgICsnPHNwYW4gY2xhc3M9ImFscGFjYS1maWVsZHNldC1hcnJheS1pdGVtLXRvb2xiYXItdXAiIGRhdGEtcm9sZT0iYnV0dG9uIiBkYXRhLWljb249ImFycm93LXUiIGRhdGEtaWNvbnBvcz0ibm90ZXh0Ij5VcDwvc3Bhbj4nCiAgICAgICAgICAgICAgICArJzxzcGFuIGNsYXNzPSJhbHBhY2EtZmllbGRzZXQtYXJyYXktaXRlbS10b29sYmFyLWRvd24iIGRhdGEtcm9sZT0iYnV0dG9uIiBkYXRhLWljb249ImFycm93LWQiIGRhdGEtaWNvbnBvcz0ibm90ZXh0Ij5Eb3duPC9zcGFuPjwvZGl2PicKICAgICAgICB9CiAgICB9KTsKfSkoalF1ZXJ5KTsvKmpzaGludCAtVzAxNCAqLyAvLyBiYWQgbGluZSBicmVha2luZwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EucmVnaXN0ZXJWaWV3KHsKICAgICAgICAiaWQiOiAiVklFV19XRUJfRURJVCIsCiAgICAgICAgInRlbXBsYXRlcyI6IHsKICAgICAgICAgICAgInR3b0NvbHVtbkxheW91dCI6JzxkaXYgY2xhc3M9ImFscGFjYS1sYXlvdXQtdHdvLWNvbHVtbi1tYXNrIj4nCiAgICAgICAgICAgICAgICAgICAgKyAne3tpZiBvcHRpb25zLmxhYmVsfX08aDM+JHtvcHRpb25zLmxhYmVsfTwvaDM+e3svaWZ9fScKICAgICAgICAgICAgICAgICAgICArICd7e2lmIG9wdGlvbnMuaGVscGVyfX08aDQ+JHtvcHRpb25zLmhlbHBlcn08L2g0Pnt7L2lmfX0nCiAgICAgICAgICAgICAgICAgICAgKyAnPGRpdiBjbGFzcz0iYWxwYWNhLWxheW91dC10d28tY29sdW1uLWxlZnQgYWxwYWNhLWxheW91dC1yZWdpb24iICBpZD0ibGVmdGNvbHVtbiI+PC9kaXY+JwogICAgICAgICAgICAgICAgICAgICsgJzxkaXYgY2xhc3M9ImFscGFjYS1sYXlvdXQtdHdvLWNvbHVtbi1yaWdodCBhbHBhY2EtbGF5b3V0LXJlZ2lvbiIgaWQ9InJpZ2h0Y29sdW1uIj48L2Rpdj4nCiAgICAgICAgICAgICAgICAgICAgKyAnPC9kaXY+JwogICAgICAgIH0KICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3RlclZpZXcoewogICAgICAgICJpZCI6ICJWSUVXX1dFQl9FRElUX0xBWU9VVF9UV09fQ09MVU1OIiwKICAgICAgICAicGFyZW50IjogIlZJRVdfV0VCX0VESVQiLAogICAgICAgICJ0aXRsZSI6ICJXZWIgRWRpdCBWaWV3IHdpdGggVHdvLUNvbHVtbiBMYXlvdXQiLAogICAgICAgICJkZXNjcmlwdGlvbiI6ICJXZWIgZWRpdCBkZWZhdWx0IHZpZXcgd2l0aCB0d28tY29sdW1uIGxheW91dC4iLAogICAgICAgICJsYXlvdXQiIDogewogICAgICAgICAgICAidGVtcGxhdGUiIDogInR3b0NvbHVtbkxheW91dCIKICAgICAgICB9CiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJWaWV3KHsKICAgICAgICAiaWQiOiAiVklFV19XRUJfRURJVF9MSVNUX0xBWU9VVF9UV09fQ09MVU1OIiwKICAgICAgICAicGFyZW50IjogIlZJRVdfV0VCX0VESVRfTElTVCIsCiAgICAgICAgInRpdGxlIjogIldlYiBMaXN0IEVkaXQgVmlldyB3aXRoIFR3by1Db2x1bW4gTGF5b3V0IiwKICAgICAgICAiZGVzY3JpcHRpb24iOiAiV2ViIGVkaXQgbGlzdCB2aWV3IHdpdGggdHdvLWNvbHVtbiBsYXlvdXQuIiwKICAgICAgICAibGF5b3V0IiA6IHsKICAgICAgICAgICAgInRlbXBsYXRlIiA6ICJ0d29Db2x1bW5MYXlvdXQiCiAgICAgICAgfQogICAgfSk7Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuTm9ybWFsaXplZFZpZXcgPSBCYXNlLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5Ob3JtYWxpemVkVmlldy5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIE9uY2UgYWxsIG9mIHRoZSBBbHBhY2Egdmlld3MgYXJlIHJlZ2lzdGVyZWQgd2l0aCB0aGUgZnJhbWV3b3JrLCBlYWNoIGlzIG5vcm1hbGl6ZWQgc28gdGhhdCBwYXJlbnQtY2hhaW4KICAgICAgICAgKiByZWZlcmVuY2VzIGFuZCBvdmVycmlkZXMgYXJlIG5vcm1hbGl6ZWQgaW50byBhIHNpbmdsZSwgZmFzdCBsb29rdXAgb2JqZWN0LgogICAgICAgICAqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBOb3JtYWxpemVkIHZpZXcuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdGhlIHZpZXcgaWQKICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24odmlld0lkKSB7CiAgICAgICAgICAgIHRoaXMuaWQgPSB2aWV3SWQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogTm9ybWFsaXphdGlvbiBvY2N1cnMgb25jZSBwZXIgdmlldyB1cG9uIHN0YXJ0dXAgb2YgQWxwYWNhLgogICAgICAgICAqLwogICAgICAgIG5vcm1hbGl6ZTogZnVuY3Rpb24oKQogICAgICAgIHsKICAgICAgICAgICAgLy8gbG9hZCB0aGUgdmlldyBvYmplY3QKICAgICAgICAgICAgdmFyIHZpZXdPYmplY3QgID0gQWxwYWNhLnZpZXdzW3RoaXMuaWRdOwogICAgICAgICAgICBpZiAoIXZpZXdPYmplY3QpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIEFscGFjYS5sb2dFcnJvcigiVmlldyBjb21waWxhdGlvbiBmYWlsZWQgLSB2aWV3IG5vdCBmb3VuZDogIiArIHRoaXMuaWQpOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBjb2xsZWN0IHRoZSBpbmhlcml0YW5jZSBjaGFpbgogICAgICAgICAgICB2YXIgY2hhaW4gPSBbXTsKICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSB2aWV3T2JqZWN0OwogICAgICAgICAgICB3aGlsZSAoY3VycmVudCkgewogICAgICAgICAgICAgICAgY2hhaW4ucHVzaChjdXJyZW50KTsKCiAgICAgICAgICAgICAgICB2YXIgcGFyZW50SWQgPSBjdXJyZW50LnBhcmVudDsKICAgICAgICAgICAgICAgIGlmIChwYXJlbnRJZCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSBBbHBhY2Eudmlld3NbY3VycmVudC5wYXJlbnRdOwogICAgICAgICAgICAgICAgICAgIGlmICghcGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEFscGFjYS5sb2dFcnJvcigiVmlldyBjb21waWxhdGlvbiBmYWlsZWQgLSBjYW5ub3QgZmluZCBwYXJlbnQgdmlldzogIiArIHBhcmVudElkICsgIiBmb3IgdmlldzogIiArIGN1cnJlbnQuaWQpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBwYXJlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHJldmVyc2UgdGhlIGNoYWluCiAgICAgICAgICAgIGNoYWluID0gY2hhaW4ucmV2ZXJzZSgpOwoKICAgICAgICAgICAgdmFyIHNldFNjYWxhciA9IGZ1bmN0aW9uKHRhcmdldCwgc291cmNlLCBwcm9wZXJ0eUlkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBzb3VyY2VbcHJvcGVydHlJZF07CgogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRWYWx1ZSA9IHRhcmdldFtwcm9wZXJ0eUlkXTsKICAgICAgICAgICAgICAgIGlmICghQWxwYWNhLmlzVW5kZWZpbmVkKGN1cnJlbnRWYWx1ZSkgJiYgIUFscGFjYS5pc1VuZGVmaW5lZCh2YWx1ZSkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgQWxwYWNhLmxvZ0RlYnVnKCJWaWV3IHByb3BlcnR5OiAiICsgcHJvcGVydHlJZCArICIgYWxyZWFkeSBoYXMgdmFsdWU6ICIgKyBjdXJyZW50VmFsdWUgKyAiIGFuZCBvdmVyd3JpdGluZyB0bzogIiArIHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc1VuZGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRbcHJvcGVydHlJZF0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHZhciBzZXRGdW5jdGlvbiA9IGZ1bmN0aW9uKHRhcmdldCwgc291cmNlLCBwcm9wZXJ0eUlkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBzb3VyY2VbcHJvcGVydHlJZF07CgogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRWYWx1ZSA9IHRhcmdldFtwcm9wZXJ0eUlkXTsKICAgICAgICAgICAgICAgIGlmICghQWxwYWNhLmlzVW5kZWZpbmVkKGN1cnJlbnRWYWx1ZSkgJiYgIUFscGFjYS5pc1VuZGVmaW5lZCh2YWx1ZSkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgQWxwYWNhLmxvZ0RlYnVnKCJWaWV3IHByb3BlcnR5OiAiICsgcHJvcGVydHlJZCArICIgYWxyZWFkeSBoYXMgZnVuY3Rpb24sIG92ZXJ3cml0aW5nIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0W3Byb3BlcnR5SWRdID0gdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgbWVyZ2VNYXAgPSBmdW5jdGlvbih0YXJnZXQsIHNvdXJjZSwgcHJvcGVydHlJZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHNvdXJjZU1hcCA9IHNvdXJjZVtwcm9wZXJ0eUlkXTsKICAgICAgICAgICAgICAgIGlmIChzb3VyY2VNYXApCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0YXJnZXRbcHJvcGVydHlJZF0pCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRbcHJvcGVydHlJZF0gPSB7fTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIEFscGFjYS5tZXJnZU9iamVjdDIoc291cmNlTWFwLCB0YXJnZXRbcHJvcGVydHlJZF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gd2FsayBmb3J3YXJkIGFuZCBhcHBseQogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoYWluLmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9IGNoYWluW2ldOwoKICAgICAgICAgICAgICAgIC8vIHNjYWxhciBwcm9wZXJ0aWVzCiAgICAgICAgICAgICAgICBzZXRTY2FsYXIodGhpcywgZWxlbWVudCwgInR5cGUiKTsKICAgICAgICAgICAgICAgIHNldFNjYWxhcih0aGlzLCBlbGVtZW50LCAiZGlzcGxheVJlYWRvbmx5Iik7CiAgICAgICAgICAgICAgICBzZXRTY2FsYXIodGhpcywgZWxlbWVudCwgInBsYXRmb3JtIik7CiAgICAgICAgICAgICAgICBzZXRTY2FsYXIodGhpcywgZWxlbWVudCwgImRldmljZSIpOwogICAgICAgICAgICAgICAgc2V0U2NhbGFyKHRoaXMsIGVsZW1lbnQsICJzdHlsZSIpOwogICAgICAgICAgICAgICAgc2V0U2NhbGFyKHRoaXMsIGVsZW1lbnQsICJ1aSIpOwogICAgICAgICAgICAgICAgc2V0U2NhbGFyKHRoaXMsIGVsZW1lbnQsICJjb2xsYXBzaWJsZSIpOwogICAgICAgICAgICAgICAgc2V0U2NhbGFyKHRoaXMsIGVsZW1lbnQsICJsZWdlbmRTdHlsZSIpOwogICAgICAgICAgICAgICAgc2V0U2NhbGFyKHRoaXMsIGVsZW1lbnQsICJ0b29sYmFyU3R5bGUiKTsKICAgICAgICAgICAgICAgIHNldFNjYWxhcih0aGlzLCBlbGVtZW50LCAiYnV0dG9uU3R5bGUiKTsKICAgICAgICAgICAgICAgIHNldFNjYWxhcih0aGlzLCBlbGVtZW50LCAidG9vbGJhclN0aWNreSIpOwogICAgICAgICAgICAgICAgc2V0U2NhbGFyKHRoaXMsIGVsZW1lbnQsICJnbG9iYWxUZW1wbGF0ZSIpOwoKICAgICAgICAgICAgICAgIC8vIGZ1bmN0aW9ucwogICAgICAgICAgICAgICAgc2V0RnVuY3Rpb24odGhpcywgZWxlbWVudCwgInJlbmRlciIpOwogICAgICAgICAgICAgICAgc2V0RnVuY3Rpb24odGhpcywgZWxlbWVudCwgInBvc3RSZW5kZXIiKTsKCiAgICAgICAgICAgICAgICAvLyBtYXBzIChtZXJnZSkKICAgICAgICAgICAgICAgIG1lcmdlTWFwKHRoaXMsIGVsZW1lbnQsICJzdHlsZXMiKTsKICAgICAgICAgICAgICAgIG1lcmdlTWFwKHRoaXMsIGVsZW1lbnQsICJ0ZW1wbGF0ZXMiKTsKICAgICAgICAgICAgICAgIG1lcmdlTWFwKHRoaXMsIGVsZW1lbnQsICJtZXNzYWdlcyIpOwogICAgICAgICAgICAgICAgbWVyZ2VNYXAodGhpcywgZWxlbWVudCwgIndpemFyZCIpOwogICAgICAgICAgICAgICAgbWVyZ2VNYXAodGhpcywgZWxlbWVudCwgImZpZWxkcyIpOwogICAgICAgICAgICAgICAgbWVyZ2VNYXAodGhpcywgZWxlbWVudCwgImxheW91dCIpOwoKICAgICAgICAgICAgICAgIC8vIGNvbXBpbGVkIHRlbXBsYXRlcwogICAgICAgICAgICAgICAgbWVyZ2VNYXAodGhpcywgZWxlbWVudCwgImNvbXBpbGVkVGVtcGxhdGVzIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIEFscGFjYS5sb2dEZWJ1ZygiVmlldyBjb21waWxhdGlvbiBjb21wbGV0ZSBmb3IgdmlldzogIiArIHRoaXMuaWQpOwogICAgICAgICAgICBBbHBhY2EubG9nRGVidWcoIkZpbmFsIHZpZXc6ICIpOwogICAgICAgICAgICBBbHBhY2EubG9nRGVidWcoSlNPTi5zdHJpbmdpZnkodGhpcywgbnVsbCwgIiAgICIpKTsKCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgIH0pOwp9KShqUXVlcnkpOy8qanNoaW50IC1XMDA0ICovIC8vIGR1cGxpY2F0ZSB2YXJpYWJsZXMKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLlJ1bnRpbWVWaWV3ID0gQmFzZS5leHRlbmQoCiAgICAvKioKICAgICAqIEBsZW5kcyBBbHBhY2EuUnVudGltZVZpZXcucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBSdW50aW1lIGltcGxlbWVudGF0aW9uIG9mIGEgdmlldyBhcyBhcHBsaWVkIHRvIGEgZmllbGQuCiAgICAgICAgICoKICAgICAgICAgKiBUaGlzIHByb3ZpZGVzIGFjY2Vzc29ycyBpbnRvIHRoZSBuZXN0ZWQgYmVoYXZpb3JzIG9mIHZpZXdzIGFuZCBhbHNvIHRha2VzIGludG8gYWNjb3VudCBmaWVsZC1sZXZlbCBhdHRyaWJ1dGVzCiAgICAgICAgICogb2YgdGhlIGN1cnJlbnRseSByZW5kZXJpbmcgZG9tIGVsZW1lbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIENsYXNzIGZvciBtYW5hZ2luZyB2aWV3IGNvbXBvbmVudHMgc3VjaCBhcyBsYXlvdXQsIHRlbXBsYXRlLCBtZXNzYWdlIGV0Yy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0aGUgdmlldyBpZAogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBmaWVsZCB0aGUgZmllbGQgY29udHJvbAogICAgICAgICAqLwogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbih2aWV3SWQsIGZpZWxkKSB7CiAgICAgICAgICAgIHRoaXMuZmllbGQgPSBmaWVsZDsKICAgICAgICAgICAgdGhpcy5zZXRWaWV3KHZpZXdJZCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogU2V0cyB0aGUgdmlldyB0aGF0IHRoaXMgcnVudGltZSB2aWV3IGFkYXB0ZXJzIHNob3VsZCBjb25zdWx0IGR1cmluZyByZW5kZXIuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdGhlIHZpZXcgaWQKICAgICAgICAgKi8KICAgICAgICBzZXRWaWV3OiBmdW5jdGlvbiAodmlld0lkKQogICAgICAgIHsKICAgICAgICAgICAgLy8gVE9ETzogc2hvdWxkIGZpZWxkIGNsYXNzZXMgZXZlciByZWFsbHkgYmUgaW5zdGFudGlhdGVkIGRpcmVjdGx5PwogICAgICAgICAgICAvLyBUT0RPOiB0aGlzIGlzIGxlZnQgaW4gdG8gc3VwcG9ydCBBbHBhY2EgZG9jcyBnZW5lcmF0aW9uIChuZWVkIHRvIGNsZWFuIHRoaXMgdXApcwogICAgICAgICAgICAvLyBpZiBhIHZpZXcgaXMgbm90IHNldCBhdCB0aGlzIHBvaW50IGl0IHByb2JhYmx5IG1lYW5zIHRoZXkgaW5zdGFudGlhdGVkIGEgZmllbGQgZGlyZWN0bHkKICAgICAgICAgICAgLy8gaW4gd2hpY2ggY2FzZSwgd2UnbGwganVzdCBwaWNrIHRoZSBkZWZhdWx0IHZpZXcKICAgICAgICAgICAgaWYgKCF2aWV3SWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuaWQgPSAiVklFV19XRUJfRURJVCI7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHRoZSBub3JtYWxpemVkIHZpZXcKICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZWRWaWV3ID0gQWxwYWNhLmdldE5vcm1hbGl6ZWRWaWV3KHZpZXdJZCk7CiAgICAgICAgICAgIGlmICghbm9ybWFsaXplZFZpZXcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIHRoaXMgc2hvdWxkIG5ldmVyIGJlIHRoZSBjYXNlCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJ1bnRpbWUgdmlldyBmb3IgdmlldyBpZDogIiArIHZpZXdJZCArICIgY291bGQgbm90IGZpbmQgYSBub3JtYWxpemVkIHZpZXciKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gY29weSBjb21waWxlZCBwcm9wZXJ0aWVzIGludG8gdGhpcyBvYmplY3QKICAgICAgICAgICAgZm9yICh2YXIgayBpbiBub3JtYWxpemVkVmlldykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZWRWaWV3Lmhhc093blByb3BlcnR5KGspKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpc1trXSA9IG5vcm1hbGl6ZWRWaWV3W2tdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB2aWV3IHdpemFyZCBzZXR0aW5ncy4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFZpZXcgd2l6YXJkIHNldHRpbmdzLgogICAgICAgICAqLwogICAgICAgIGdldFdpemFyZCA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Vmlld1BhcmFtKCJ3aXphcmQiKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBnbG9iYWwgbGF5b3V0IHRlbXBsYXRlLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge09iamVjdHxTdHJpbmd9IEdsb2JhbCBsYXlvdXQgdGVtcGxhdGUgc2V0dGluZyBvZiB0aGUgdmlldy4KICAgICAgICAgKi8KICAgICAgICBnZXRHbG9iYWxUZW1wbGF0ZURlc2NyaXB0b3IgOiBmdW5jdGlvbiAoKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJnbG9iYWxUZW1wbGF0ZSIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgbGF5b3V0IHRlbXBsYXRlIGFuZCBiaW5kaW5ncy4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IExheW91dCB0ZW1wbGF0ZSBhbmQgYmluZGluZ3Mgc2V0dGluZyBvZiB0aGUgdmlldy4KICAgICAgICAgKi8KICAgICAgICBnZXRMYXlvdXQ6IGZ1bmN0aW9uICgpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGVtcGxhdGVEZXNjcmlwdG9yID0gdGhpcy5nZXRUZW1wbGF0ZURlc2NyaXB0b3IoImxheW91dFRlbXBsYXRlIik7CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgInRlbXBsYXRlRGVzY3JpcHRvciIgOiB0ZW1wbGF0ZURlc2NyaXB0b3IsCiAgICAgICAgICAgICAgICAiYmluZGluZ3MiIDogdGhpcy5nZXRWaWV3UGFyYW0oWyJsYXlvdXQiLCJiaW5kaW5ncyJdLCB0cnVlKQogICAgICAgICAgICB9OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgc3R5bGUgaW5qZWN0aW9uIGxpc3RzLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gc3R5bGVzIHN0eWxlIGluamVjdGlvbiBsaXN0IHNldHRpbmdzIG9mIHRoZSB2aWV3LgogICAgICAgICAqLwogICAgICAgIGdldFN0eWxlcyA6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgIHJldHVybiB0aGlzLnN0eWxlczsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBIYW5kcyBiYWNrIHRoZSBjb21waWxlZCB0ZW1wbGF0ZSBpZCBmb3IgYSBnaXZlbiB0ZW1wbGF0ZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB0ZW1wbGF0ZUlkCiAgICAgICAgICovCiAgICAgICAgZ2V0VGVtcGxhdGVEZXNjcmlwdG9yOiBmdW5jdGlvbih0ZW1wbGF0ZUlkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5nZXRUZW1wbGF0ZURlc2NyaXB0b3IodGhpcywgdGVtcGxhdGVJZCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyBtZXNzYWdlIGZvciB0aGUgZ2l2ZW4gaWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZUlkIE1lc3NhZ2UgaWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBNZXNzYWdlIG1hcHBlZCB0byB0aGUgZ2l2ZW4gaWQuCiAgICAgICAgICovCiAgICAgICAgZ2V0TWVzc2FnZSA6IGZ1bmN0aW9uIChtZXNzYWdlSWQpIHsKICAgICAgICAgICAgdmFyIG1lc3NhZ2VGb3JMb2NhbGUgPSB0aGlzLmdldFZpZXdQYXJhbShbIm1lc3NhZ2VzIixBbHBhY2EuZGVmYXVsdExvY2FsZSxtZXNzYWdlSWRdKTsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5pc0VtcHR5KG1lc3NhZ2VGb3JMb2NhbGUpID8gdGhpcy5nZXRWaWV3UGFyYW0oWyJtZXNzYWdlcyIsbWVzc2FnZUlkXSk6IG1lc3NhZ2VGb3JMb2NhbGU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0cmlldmVzIHZpZXcgcGFyYW1ldGVyIGJhc2VkIG9uIGNvbmZpZ3VyYXRpb24gSWQgb3IgSWQgYXJyYXkuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ3xBcnJheX0gY29uZmlnSWQgQ29uZmlndXJhdGlvbiBpZCBvciBhcnJheS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtBbnl9IFZpZXcgcGFyYW1ldGVyIG1hcHBlZCB0byBjb25maWd1cmF0aW9uIElkIG9yIElkIGFycmF5LgogICAgICAgICAqLwogICAgICAgIGdldFZpZXdQYXJhbTogZnVuY3Rpb24gKGNvbmZpZ0lkLCB0b3BMZXZlbE9ubHkpIHsKCiAgICAgICAgICAgIC8vIFRyeSB0aGUgZmllbGRzCiAgICAgICAgICAgIHZhciBmaWVsZFBhdGggPSB0aGlzLmZpZWxkLnBhdGg7CiAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkcyAmJiB0aGlzLmZpZWxkc1tmaWVsZFBhdGhdKSB7CiAgICAgICAgICAgICAgICB2YXIgY29uZmlnVmFsID0gdGhpcy5fZ2V0Q29uZmlnVmFsKHRoaXMuZmllbGRzW2ZpZWxkUGF0aF0sIGNvbmZpZ0lkKTsKICAgICAgICAgICAgICAgIGlmICghQWxwYWNhLmlzRW1wdHkoY29uZmlnVmFsKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjb25maWdWYWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGFycmF5IHJlbGF0ZWQgZmllbGQgcGF0aAogICAgICAgICAgICBpZiAoZmllbGRQYXRoICYmIGZpZWxkUGF0aC5pbmRleE9mKCdbJykgIT0gLTEgJiYgZmllbGRQYXRoLmluZGV4T2YoJ10nKSAhPSAtMSkgewogICAgICAgICAgICAgICAgZmllbGRQYXRoID0gZmllbGRQYXRoLnJlcGxhY2UoL1xbXGQrXF0vZywiWypdIik7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5maWVsZHMgJiYgdGhpcy5maWVsZHNbZmllbGRQYXRoXSkgewogICAgICAgICAgICAgICAgICAgIHZhciBjb25maWdWYWwgPSB0aGlzLl9nZXRDb25maWdWYWwodGhpcy5maWVsZHNbZmllbGRQYXRoXSwgY29uZmlnSWQpOwogICAgICAgICAgICAgICAgICAgIGlmICghQWxwYWNhLmlzRW1wdHkoY29uZmlnVmFsKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29uZmlnVmFsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eSh0b3BMZXZlbE9ubHkpICYmIHRvcExldmVsT25seSAmJiB0aGlzLmZpZWxkLnBhdGggIT0gIi8iKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2dldENvbmZpZ1ZhbCh0aGlzLCBjb25maWdJZCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogSW50ZXJuYWwgbWV0aG9kIGZvciBnZXR0aW5nIGNvbmZpZ3VyYXRpb24uCiAgICAgICAgICoKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtBbnl9IGNvbmZpZ1ZhbCBjb25maWd1cmF0aW9uIHZhbHVlLgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBjb25maWdJZCBjb25maWd1cmF0aW9uIGlkLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0FueX0gY29uZmlndXJhdGlvbiBtYXBwaW5nIHRvIHRoZSBnaXZlbiBpZAogICAgICAgICAqLwogICAgICAgIF9nZXRDb25maWdWYWwgOiBmdW5jdGlvbiAoY29uZmlnVmFsLCBjb25maWdJZCkgewogICAgICAgICAgICBpZiAoQWxwYWNhLmlzQXJyYXkoY29uZmlnSWQpKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvbmZpZ0lkLmxlbmd0aCAmJiAhQWxwYWNhLmlzRW1wdHkoY29uZmlnVmFsKTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uZmlnVmFsID0gY29uZmlnVmFsW2NvbmZpZ0lkW2ldXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghQWxwYWNhLmlzRW1wdHkoY29uZmlnVmFsKSkgewogICAgICAgICAgICAgICAgICAgIGNvbmZpZ1ZhbCA9IGNvbmZpZ1ZhbFtjb25maWdJZF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNvbmZpZ1ZhbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBMb2FkcyBhbiBpbmplY3RlZCBzdHlsZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBpZAogICAgICAgICAqLwogICAgICAgIGdldEluamVjdGVkU3R5bGU6IGZ1bmN0aW9uKGlkKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGluamVjdGVkU3R5bGUgPSBudWxsOwoKICAgICAgICAgICAgdmFyIGluamVjdGlvbnMgPSB7fTsKICAgICAgICAgICAgaWYgKHRoaXMuc3R5bGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBfaW5qZWN0aW9ucyA9IEFscGFjYS5zdHlsZUluamVjdGlvbnNbdGhpcy5zdHlsZV07CiAgICAgICAgICAgICAgICBpZiAoX2luamVjdGlvbnMpIHsKICAgICAgICAgICAgICAgICAgICBBbHBhY2EubWVyZ2VPYmplY3QoX2luamVjdGlvbnMsIGluamVjdGlvbnMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gaW5qZWN0ZWRTdHlsZVtpZF07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogRXhlY3V0ZXMgYSB0ZW1wbGF0ZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB2aWV3CiAgICAgICAgICogQHBhcmFtIHRlbXBsYXRlRGVzY3JpcHRvcgogICAgICAgICAqIEBwYXJhbSBtb2RlbAogICAgICAgICAqLwogICAgICAgIHRtcGw6IGZ1bmN0aW9uKHRlbXBsYXRlRGVzY3JpcHRvciwgbW9kZWwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLnRtcGwodGVtcGxhdGVEZXNjcmlwdG9yLCBtb2RlbCk7CiAgICAgICAgfQoKICAgIH0pOwp9KShqUXVlcnkpOyhmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZCA9IEJhc2UuZXh0ZW5kKAogICAgLyoqCiAgICAgKiBAbGVuZHMgQWxwYWNhLkZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBBYnN0cmFjdCBjbGFzcyB0aGF0IHNlcnZlZCBhcyBiYXNlIGZvciBhbGwgQWxwYWNhIGZpZWxkIGNsYXNzZXMgdGhhdCBwcm92aWRlIGFjdHVhbCBpbXBsZW1lbnRhdGlvbi4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdmlld0lkIHZpZXcgaWQKICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXdJZCwgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICAvLyBtYXJrIHRoYXQgd2UgYXJlIGluaXRpYWxpemluZwogICAgICAgICAgICB0aGlzLmluaXRpYWxpemluZyA9IHRydWU7CgogICAgICAgICAgICAvLyBjb250YWluZXIKICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBjb250YWluZXI7CgogICAgICAgICAgICAvLyBwYXJlbnQKICAgICAgICAgICAgdGhpcy5wYXJlbnQgPSBudWxsOwoKICAgICAgICAgICAgLy8gY29uZmlnCiAgICAgICAgICAgIHRoaXMuZGF0YSA9IGRhdGE7CiAgICAgICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgICAgICAgIHRoaXMuc2NoZW1hID0gc2NoZW1hOwogICAgICAgICAgICB0aGlzLmNvbm5lY3RvciA9IGNvbm5lY3RvcjsKICAgICAgICAgICAgdGhpcy5lcnJvckNhbGxiYWNrID0gZnVuY3Rpb24oZXJyKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoZXJyb3JDYWxsYmFjaykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBlcnJvckNhbGxiYWNrKGVycik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgQWxwYWNhLmRlZmF1bHRFcnJvckNhbGxiYWNrLmNhbGwoc2VsZiwgZXJyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIGNoZWNrIGlmIHRoaXMgZmllbGQgcmVuZGVyaW5nIGlzIHNpbmdsZS1sZXZlbCBvciBub3QKICAgICAgICAgICAgdGhpcy5zaW5nbGVMZXZlbFJlbmRlcmluZyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gc2V0IGEgcnVudGltZSB2aWV3CiAgICAgICAgICAgIHRoaXMudmlldyA9IG5ldyBBbHBhY2EuUnVudGltZVZpZXcodmlld0lkLCB0aGlzKTsKCiAgICAgICAgICAgIC8vIHRoaW5ncyB3ZSBjYW4gZHJhdyBvZmYgdGhlIG9wdGlvbnMKICAgICAgICAgICAgdmFyIG5vT3B0aW9ucyA9IGZhbHNlOwogICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucykgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zID0ge307CiAgICAgICAgICAgICAgICBub09wdGlvbnMgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaWQgPSB0aGlzLm9wdGlvbnMuaWQ7CiAgICAgICAgICAgIHRoaXMudHlwZSA9IHRoaXMub3B0aW9ucy50eXBlOwoKICAgICAgICAgICAgLy8gc2V0dXAgZGVmYXVsdHMKICAgICAgICAgICAgaWYgKCF0aGlzLmlkKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlkID0gQWxwYWNhLmdlbmVyYXRlSWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbm9TY2hlbWEgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKCF0aGlzLnNjaGVtYSkgewogICAgICAgICAgICAgICAgdGhpcy5zY2hlbWEgPSB7fTsKICAgICAgICAgICAgICAgIG5vU2NoZW1hID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5sYWJlbCAmJiB0aGlzLnNjaGVtYS50aXRsZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmxhYmVsID0gdGhpcy5zY2hlbWEudGl0bGU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghdGhpcy5vcHRpb25zLmhlbHBlciAmJiB0aGlzLnNjaGVtYS5kZXNjcmlwdGlvbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmhlbHBlciA9IHRoaXMuc2NoZW1hLmRlc2NyaXB0aW9uOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkodGhpcy5vcHRpb25zLnJlYWRvbmx5KSAmJiAhQWxwYWNhLmlzRW1wdHkodGhpcy5zY2hlbWEucmVhZG9ubHkpKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMucmVhZG9ubHkgPSB0aGlzLnNjaGVtYS5yZWFkb25seTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaWYgZGF0YSBpcyBlbXB0eSwgdGhlbiB3ZSBjaGVjayB3aGV0aGVyIHdlIGNhbiBmYWxsIGJhY2sgdG8gYSBkZWZhdWx0IHZhbHVlCiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNWYWxFbXB0eSh0aGlzLmRhdGEpICYmICFBbHBhY2EuaXNFbXB0eSh0aGlzLnNjaGVtYVsiZGVmYXVsdCJdKSkgewogICAgICAgICAgICAgICAgdGhpcy5kYXRhID0gdGhpcy5zY2hlbWFbImRlZmF1bHQiXTsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd2luZ0RlZmF1bHREYXRhID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZGVmYXVsdCBwYXRoCiAgICAgICAgICAgIHRoaXMucGF0aCA9ICIvIjsKCiAgICAgICAgICAgIC8vIHZhbGlkYXRpb24gc3RhdHVzCiAgICAgICAgICAgIHRoaXMudmFsaWRhdGlvbiA9IHt9OwoKICAgICAgICAgICAgLy8gZXZlbnRzCiAgICAgICAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwoKICAgICAgICAgICAgLy8gaGVscGVyIGZ1bmN0aW9uIHRvIGRldGVybWluZSBpZiB3ZSdyZSBpbiBhIGRpc3BsYXktb25seSBtb2RlCiAgICAgICAgICAgIHRoaXMuaXNEaXNwbGF5T25seSA9IGZ1bmN0aW9uKCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIChzZWxmLnZpZXcudHlwZSA9PSAidmlldyIpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gc2NoZW1hIGlkIGNsZWFudXAKICAgICAgICAgICAgaWYgKHRoaXMuc2NoZW1hICYmIHRoaXMuc2NoZW1hLmlkICYmIHRoaXMuc2NoZW1hLmlkLmluZGV4T2YoIiMiKSA9PSAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNjaGVtYS5pZCA9IHRoaXMuc2NoZW1hLmlkLnN1YnN0cmluZygxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaGFzIHRoaXMgZmllbGQgYmVlbiBwcmV2aW91c2x5IHZhbGlkYXRlZD8KICAgICAgICAgICAgdGhpcy5fcHJldmlvdXNseVZhbGlkYXRlZCA9IGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgZGVmYXVsdCBmaWVsZCB0ZW1wbGF0ZSBpZC4gSXQgd291bGQgYmUgImZpZWxkU2V0IiBmb3IgY29udGFpbmVyIGZpZWxkcyBhbmQKICAgICAgICAgKiAiY29udHJvbEZpZWxkIiBmb3Igbm9uZS1jb250YWluZXIgZmllbGRzLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge1N0cmluZ30gRGVmYXVsdCBmaWVsZCB0ZW1wbGF0ZSBpZC4KICAgICAgICAgKi8KICAgICAgICBnZXREZWZhdWx0RmllbGRUZW1wbGF0ZUlkIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gImNvbnRyb2xGaWVsZCI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogU2V0cyB1cCBkZWZhdWx0IHJlbmRpdGlvbiB0ZW1wbGF0ZSBmcm9tIHZpZXcuCiAgICAgICAgICovCiAgICAgICAgc2V0RGVmYXVsdFRlbXBsYXRlRGVzY3JpcHRvcjogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICB2YXIgdmlld1RlbXBsYXRlRGVzY3JpcHRvciA9IHRoaXMudmlldy5nZXRUZW1wbGF0ZURlc2NyaXB0b3IodGhpcy5nZXREZWZhdWx0RmllbGRUZW1wbGF0ZUlkKCkpOwogICAgICAgICAgICB2YXIgZ2xvYmFsVGVtcGxhdGVEZXNjcmlwdG9yID0gdGhpcy52aWV3LmdldEdsb2JhbFRlbXBsYXRlRGVzY3JpcHRvcigpOwogICAgICAgICAgICB2YXIgbGF5b3V0ID0gdGhpcy52aWV3LmdldExheW91dCgpOwoKICAgICAgICAgICAgLy8gd2Ugb25seSBhbGxvdyB0aGUgZ2xvYmFsIG9yIGxheW91dCB0ZW1wbGF0ZSB0byBiZSBhcHBsaWVkIHRvIHRoZSB0b3AtbW9zdCBmaWVsZAogICAgICAgICAgICB2YXIgdHJpcCA9IGZhbHNlOwogICAgICAgICAgICBpZiAoIXRoaXMucGFyZW50KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoZ2xvYmFsVGVtcGxhdGVEZXNjcmlwdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRUZW1wbGF0ZURlc2NyaXB0b3IoZ2xvYmFsVGVtcGxhdGVEZXNjcmlwdG9yKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNpbmdsZUxldmVsUmVuZGVyaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0cmlwID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKGxheW91dCAmJiBsYXlvdXQudGVtcGxhdGVEZXNjcmlwdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRUZW1wbGF0ZURlc2NyaXB0b3IobGF5b3V0LnRlbXBsYXRlRGVzY3JpcHRvcik7CiAgICAgICAgICAgICAgICAgICAgdHJpcCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghdHJpcCAmJiB2aWV3VGVtcGxhdGVEZXNjcmlwdG9yKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNldFRlbXBsYXRlRGVzY3JpcHRvcih2aWV3VGVtcGxhdGVEZXNjcmlwdG9yKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFRoaXMgbWV0aG9kIHdpbGwgYmUgY2FsbGVkIHJpZ2h0IGFmdGVyIHRoZSBmaWVsZCBpbnN0YW5jZSBpcyBjcmVhdGVkLiBJdCB3aWxsIGluaXRpYWxpemUKICAgICAgICAgKiB0aGUgZmllbGQgdG8gZ2V0IGl0IHJlYWR5IGZvciByZW5kaXRpb24uCiAgICAgICAgICovCiAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgaWYgKCF0aGlzLmluaXRpYWxpemluZykgewogICAgICAgICAgICAgICAgdGhpcy5kYXRhID0gdGhpcy5nZXRWYWx1ZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnNldERlZmF1bHRUZW1wbGF0ZURlc2NyaXB0b3IoKTsKCiAgICAgICAgICAgIC8vIEpTT04gU0NIRU1BCiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNVbmRlZmluZWQodGhpcy5zY2hlbWEucmVxdWlyZWQpKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNjaGVtYS5yZXF1aXJlZCA9IGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBWQUxJREFUSU9OCiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNVbmRlZmluZWQodGhpcy5vcHRpb25zLnZhbGlkYXRlKSkgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLnZhbGlkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gT1BUSU9OUwogICAgICAgICAgICBpZiAoQWxwYWNhLmlzVW5kZWZpbmVkKHRoaXMub3B0aW9ucy5kaXNhYmxlZCkpIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBNRVNTQUdFUwogICAgICAgICAgICBpZiAoQWxwYWNhLmlzVW5kZWZpbmVkKHRoaXMub3B0aW9ucy5zaG93TWVzc2FnZXMpKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuc2hvd01lc3NhZ2VzID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJlZ2lzdGVycyBhbiBldmVudCBsaXN0ZW5lci4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBuYW1lCiAgICAgICAgICogQHBhcmFtIGZuCiAgICAgICAgICogQHJldHVybnMgeyp9CiAgICAgICAgICovCiAgICAgICAgb246IGZ1bmN0aW9uKG5hbWUsIGZuKQogICAgICAgIHsKICAgICAgICAgICAgQWxwYWNhLmxvZ0RlYnVnKCJBZGRpbmcgbGlzdGVuZXIgZm9yIGV2ZW50OiAiICsgbmFtZSk7CiAgICAgICAgICAgIHRoaXMuX2V2ZW50c1tuYW1lXSA9IGZuOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBUcmlnZ2VycyBhbiBldmVudCBhbmQgcHJvcGFnYXRlcyB0aGUgZXZlbnQgdXAgdGhlIHBhcmVudCBjaGFpbi4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBuYW1lCiAgICAgICAgICogQHBhcmFtIGV2ZW50CiAgICAgICAgICovCiAgICAgICAgdHJpZ2dlcldpdGhQcm9wYWdhdGlvbjogZnVuY3Rpb24obmFtZSwgZXZlbnQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnRyaWdnZXIuY2FsbCh0aGlzLCBuYW1lLCBldmVudCk7CgogICAgICAgICAgICBpZiAodGhpcy5wYXJlbnQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMucGFyZW50LnRyaWdnZXJXaXRoUHJvcGFnYXRpb24uY2FsbCh0aGlzLnBhcmVudCwgbmFtZSwgZXZlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVHJpZ2dlcnMgYW4gZXZlbnQKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBuYW1lCiAgICAgICAgICogQHBhcmFtIGV2ZW50CiAgICAgICAgICoKICAgICAgICAgKiBSZW1haW5kZXIgb2YgYXJndW1lbnRzIHdpbGwgYmUgcGFzc2VkIHRvIHRoZSBldmVudCBoYW5kbGVyLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge251bGx9CiAgICAgICAgICovCiAgICAgICAgdHJpZ2dlcjogZnVuY3Rpb24obmFtZSwgZXZlbnQpCiAgICAgICAgewogICAgICAgICAgICAvLyBOT1RFOiB0aGlzID09IGNvbnRyb2wKCiAgICAgICAgICAgIHZhciBoYW5kbGVyID0gdGhpcy5fZXZlbnRzW25hbWVdOwoKICAgICAgICAgICAgdmFyIHJldCA9IG51bGw7CiAgICAgICAgICAgIGlmICh0eXBlb2YoaGFuZGxlcikgPT0gImZ1bmN0aW9uIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgQWxwYWNhLmxvZ0RlYnVnKCJGaXJpbmcgZXZlbnQ6ICIgKyBuYW1lKTsKICAgICAgICAgICAgICAgIHRyeQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldCA9IGhhbmRsZXIuY2FsbCh0aGlzLCBldmVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaCAoZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBBbHBhY2EubG9nRGVidWcoIlRoZSBldmVudCBoYW5kbGVyIGNhdWdodCBhbiBleGNlcHRpb246ICIgKyBuYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICogQmluZHMgdGhlIGRhdGEgaW50byB0aGUgZmllbGQuICBDYWxsZWQgYXQgdGhlIHZlcnkgZW5kIG9mIGNvbnN0cnVjdGlvbi4KICAgICAgICAgKi8KICAgICAgICBiaW5kRGF0YTogZnVuY3Rpb24oKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eSh0aGlzLmRhdGEpKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldFZhbHVlKHRoaXMuZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBUaGlzIGlzIHRoZSBlbnRyeSBwb2ludCBtZXRob2QgaW50byB0aGUgZmllbGQuICBJdCBpcyBjYWxsZWQgYnkgQWxwYWNhIGZvciBlYWNoIGZpZWxkIGJlaW5nIHJlbmRlcmVkLgogICAgICAgICAqCiAgICAgICAgICogUmVuZGVycyB0aGlzIGZpZWxkIGludG8gdGhlIGNvbnRhaW5lciBhbmQgY3JlYXRlcyBhIERPTSBlbGVtZW50IHdoaWNoIGlzIGJvdW5kIGludG8gdGhlIGNvbnRhaW5lci4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBWaWV3IHRvIGJlIHVzZWQgZm9yIHJlbmRlcmluZyBmaWVsZCAob3B0aW9uYWwpLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFBvc3QtUmVuZGVyIGNhbGxiYWNrIChvcHRpb25hbCkuCiAgICAgICAgICovCiAgICAgICAgcmVuZGVyOiBmdW5jdGlvbih2aWV3LCBjYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh2aWV3ICYmIChBbHBhY2EuaXNTdHJpbmcodmlldykgfHwgQWxwYWNhLmlzT2JqZWN0KHZpZXcpKSkgewogICAgICAgICAgICAgICAgdGhpcy52aWV3LnNldFZpZXcodmlldyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkoY2FsbGJhY2spICYmIEFscGFjYS5pc0Z1bmN0aW9uKHZpZXcpKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sgPSB2aWV3OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGxhc3QgdHJ5IHRvIHNlZSBpZiB3ZSBjYW4gcG9wdWxhdGUgdGhlIGxhYmVsIGZyb20gcHJvcGVydHlJZAogICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxhYmVsID09PSBudWxsICYmIHRoaXMucHJvcGVydHlJZCkgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmxhYmVsID0gdGhpcy5wcm9wZXJ0eUlkOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBtYWtlIGEgY29weSBvZiBuYW1lIGZpZWxkCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMubmFtZSkgewogICAgICAgICAgICAgICAgdGhpcy5uYW1lID0gdGhpcy5vcHRpb25zLm5hbWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHNldCBkZWZhdWx0IG5hbWUgdmFsdWUgaWYgaXQgaXMgbm90IHByb3ZpZGVkIHRocm91Z2ggb3B0aW9ucy4KICAgICAgICAgICAgaWYgKCF0aGlzLm5hbWUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIGhhcyBwYXRoPwogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFyZW50ICYmIHRoaXMucGFyZW50Lm5hbWUgJiYgdGhpcy5wYXRoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxhc3RTZWdtZW50ID0gdGhpcy5wYXRoLnN1YnN0cmluZyh0aGlzLnBhdGgubGFzdEluZGV4T2YoJy8nKSsxKTsKICAgICAgICAgICAgICAgICAgICBpZiAobGFzdFNlZ21lbnQuaW5kZXhPZigiWyIpICE9IC0xICYmIGxhc3RTZWdtZW50LmluZGV4T2YoIl0iKSAhPSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICBsYXN0U2VnbWVudCA9IGxhc3RTZWdtZW50LnN1YnN0cmluZyhsYXN0U2VnbWVudC5pbmRleE9mKCJbIikgKyAxLCBsYXN0U2VnbWVudC5pbmRleE9mKCJdIikpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAobGFzdFNlZ21lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5uYW1lID0gdGhpcy5wYXJlbnQubmFtZSArICJfIiArIGxhc3RTZWdtZW50OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm5hbWVDYWxjdWxhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhdGgpIHsKICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm5hbWUgPSB0aGlzLnBhdGgucmVwbGFjZSgvXC8vZywiIikucmVwbGFjZSgvXFsvZywiXyIpLnJlcGxhY2UoL1xdL2csIiIpOwogICAgICAgICAgICAgICAgICAgICAgIHRoaXMubmFtZUNhbGN1bGF0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zZXR1cCgpOwoKICAgICAgICAgICAgdGhpcy5fcmVuZGVyKGNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBJbnRlcm5hbCBtZXRob2QgZm9yIHByb2Nlc3NpbmcgdGhlIHJlbmRlci4KICAgICAgICAgKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgUG9zdC1yZW5kZXIgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgX3JlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIC8vIHJlbW92ZSB0aGUgcHJldmlvdXMgb3V0ZXJFbCBpZiBpdCBleGlzdHMKICAgICAgICAgICAgaWYgKHRoaXMuZ2V0RWwoKSkgewogICAgICAgICAgICAgICAgdGhpcy5nZXRFbCgpLnJlbW92ZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBjaGVjayBpZiBpdCBuZWVkcyB0byBiZSB3cmFwcGVkIGluIGEgZm9ybQogICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLnJlbmRlckZvcm0pIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5vcHRpb25zLmZvcm0pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuZm9ybSA9IHt9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmZvcm0udmlld1R5cGUgPSAvKnRoaXMudmlld1R5cGUqL3RoaXMudmlldy50eXBlOwogICAgICAgICAgICAgICAgdmFyIGZvcm0gPSB0aGlzLmZvcm07CiAgICAgICAgICAgICAgICBpZiAoIWZvcm0pIHsKICAgICAgICAgICAgICAgICAgICBmb3JtID0gbmV3IEFscGFjYS5Gb3JtKHRoaXMuY29udGFpbmVyLCB0aGlzLm9wdGlvbnMuZm9ybSwgdGhpcy52aWV3LmlkLCB0aGlzLmNvbm5lY3RvciwgdGhpcy5lcnJvckNhbGxiYWNrKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvcm0ucmVuZGVyKGZ1bmN0aW9uKGZvcm0pIHsKICAgICAgICAgICAgICAgICAgICAvLyBsb2FkIHRoZSBhcHByb3ByaWF0ZSB0ZW1wbGF0ZSBhbmQgcmVuZGVyIGl0CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuX3Byb2Nlc3NSZW5kZXIoZm9ybS5mb3JtRmllbGRzQ29udGFpbmVyLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmluZCBvdXIgZmllbGQgZG9tIGVsZW1lbnQgaW50byB0aGUgY29udGFpbmVyCiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmdldEVsKCkuYXBwZW5kVG8oZm9ybS5mb3JtRmllbGRzQ29udGFpbmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmluZCB0aGUgdG9wIGZpZWxkIHRvIHRoZSBmb3JtCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm0udG9wQ29udHJvbCA9IF90aGlzOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoX3RoaXMudmlldy50eXBlICYmIF90aGlzLnZpZXcudHlwZSAhPSAndmlldycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm0uaW5pdEV2ZW50cygpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmZvcm0gPSBmb3JtOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBhbGxvdyBhbnkgcG9zdC1yZW5kZXJpbmcgZmFjaWxpdGllcyB0byBraWNrIGluCiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnBvc3RSZW5kZXIoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2FsbGJhY2sKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjayAmJiBBbHBhY2EuaXNGdW5jdGlvbihjYWxsYmFjaykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhfdGhpcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gbG9hZCB0aGUgYXBwcm9wcmlhdGUgdGVtcGxhdGUgYW5kIHJlbmRlciBpdAogICAgICAgICAgICAgICAgdGhpcy5fcHJvY2Vzc1JlbmRlcih0aGlzLmNvbnRhaW5lciwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gYmluZCBvdXIgZmllbGQgZG9tIGVsZW1lbnQgaW50byB0aGUgY29udGFpbmVyCiAgICAgICAgICAgICAgICAgICAgX3RoaXMuZ2V0RWwoKS5hcHBlbmRUbyhfdGhpcy5jb250YWluZXIpOwogICAgICAgICAgICAgICAgICAgIC8vIGFsbG93IGFueSBwb3N0LXJlbmRlcmluZyBmYWNpbGl0aWVzIHRvIGtpY2sgaW4KICAgICAgICAgICAgICAgICAgICBfdGhpcy5wb3N0UmVuZGVyKGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2FsbGJhY2sKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrICYmIEFscGFjYS5pc0Z1bmN0aW9uKGNhbGxiYWNrKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soX3RoaXMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBOT1RFOiB0aGlzIGlzIG5vIGxvbmdlciBuZWVkZWQgc2luY2UgYWxsIHRlbXBsYXRlcyBhcmUgY29tcGlsZWQgYW5kIGNhY2hlZCBvbiBpbml0LgogICAgICAgICAqCiAgICAgICAgICogUmVzcG9uc2libGUgZm9yIGZldGNoaW5nIGFueSB0ZW1wbGF0ZXMgbmVlZGVkIHNvIGFzIHRvIHJlbmRlciB0aGUKICAgICAgICAgKiBjdXJyZW50IG1vZGUgZm9yIHRoaXMgZmllbGQuCiAgICAgICAgICoKICAgICAgICAgKiBPbmNlIGNvbXBsZXRlZCwgdGhlIG9uU3VjY2VzcyBtZXRob2QgaXMgY2FsbGVkLgogICAgICAgICAqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwYXJlbnRFbCBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gb25TdWNjZXNzIG9uU3VjY2VzcyBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBfcHJvY2Vzc1JlbmRlcjogZnVuY3Rpb24ocGFyZW50RWwsIG9uU3VjY2VzcykgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgdmFyIHRlbXBsYXRlRGVzY3JpcHRvciA9IHRoaXMuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCk7CgogICAgICAgICAgICAvLyB0aGUgZGF0YSB3ZSdsbCByZW5kZXIKICAgICAgICAgICAgdmFyIHRoZURhdGEgPSB0aGlzLmRhdGE7CiAgICAgICAgICAgIC8vIGlmIHdlJ3JlIGluIGRpc3BsYXktb25seSBtb2RlLCBhbmQgdGhlRGF0YSBpcyBhbiBvYmplY3QsIGNvbnZlcnQgdG8gc3RyaW5nCiAgICAgICAgICAgIGlmICh0aGlzLmlzRGlzcGxheU9ubHkoKSAmJiB0eXBlb2YodGhlRGF0YSkgPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgIHRoZURhdGEgPSBKU09OLnN0cmluZ2lmeSh0aGVEYXRhKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gcmVuZGVyIGZpZWxkIHRlbXBsYXRlCiAgICAgICAgICAgIGlmIChBbHBhY2EuY29sbGVjdFRpbWluZykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHQxID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciByZW5kZXJlZERvbUVsZW1lbnQgPSBfdGhpcy52aWV3LnRtcGwodGVtcGxhdGVEZXNjcmlwdG9yLCB7CiAgICAgICAgICAgICAgICAiaWQiOiB0aGlzLmdldElkKCksCiAgICAgICAgICAgICAgICAib3B0aW9ucyI6IHRoaXMub3B0aW9ucywKICAgICAgICAgICAgICAgICJzY2hlbWEiOiB0aGlzLnNjaGVtYSwKICAgICAgICAgICAgICAgICJkYXRhIjogdGhlRGF0YSwKICAgICAgICAgICAgICAgICJ2aWV3IjogdGhpcy52aWV3LAogICAgICAgICAgICAgICAgInBhdGgiOiB0aGlzLnBhdGgsCiAgICAgICAgICAgICAgICAibmFtZSI6IHRoaXMubmFtZQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChBbHBhY2EuY29sbGVjdFRpbWluZykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHQyID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CgogICAgICAgICAgICAgICAgdmFyIGNvdW50ZXJzID0gQWxwYWNhLkNvdW50ZXJzKCJ0bXBsIik7CiAgICAgICAgICAgICAgICBjb3VudGVycy5pbmNyZW1lbnQodGhpcy50eXBlLCAodDItdDEpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVE9ETzogQWxwYWNhIGN1cnJlbnRseSBhc3N1bWVzIHRoYXQgZXZlcnl0aGluZyB1bmRlciBwYXJlbnRFbCBpcyB0aGUgY29udHJvbCBpdHNlbGYKICAgICAgICAgICAgLy8gdGhlIHdvcmthcm91bmQgZm9yIFRBQkxFIHZpZXcgaXMgdW5hY2NvbW1vZGF0aW5nIHRvd2FyZCB0aGlzCiAgICAgICAgICAgIC8vIGEgY2xpY2sgb24gdGhlIGxhYmVsIGJlaGF2ZXMgbGlrZSBhIGNsaWNrIG9uIHRoZSBjZWxsCiAgICAgICAgICAgIC8vIHRoaXMgbmVlZHMgbW9yZSB3b3JrCiAgICAgICAgICAgIHJlbmRlcmVkRG9tRWxlbWVudC5hcHBlbmRUbyhwYXJlbnRFbCk7CgogICAgICAgICAgICAvLyBpZiB3ZSBnb3QgYmFjayBtdWx0aXBsZSBkb20gZWxlbWVudHMsIHRoZW4gbG9vayBmb3IgdGhlIGRvbSBlbGVtZW50IHdoZXJlICJkYXRhLWNvbnRyb2wiIGhhcyBhIHZhbHVlIG9mCiAgICAgICAgICAgIC8vICAgImFwcGVuZCIgPSBwbGFjZSB0aGUgY29udHJvbCBpbnRvIHRoaXMgZG9tIGVsZW1lbnQKICAgICAgICAgICAgdmFyIG5ld0VsID0gcmVuZGVyZWREb21FbGVtZW50OwogICAgICAgICAgICBpZiAocmVuZGVyZWREb21FbGVtZW50LnNpemUoKSA+IDEpIHsKICAgICAgICAgICAgICAgIHJlbmRlcmVkRG9tRWxlbWVudC5lYWNoKGZ1bmN0aW9uKGssdikgewogICAgICAgICAgICAgICAgICAgIGlmICgkKHRoaXMpLmF0dHIoImRhdGEtY29udHJvbCIpID09ICJhcHBlbmQiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0VsID0gJCh0aGlzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvL3RoaXMuc2V0RWwocmVuZGVyZWREb21FbGVtZW50KTsKICAgICAgICAgICAgdGhpcy5zZXRFbChuZXdFbCk7CgoKICAgICAgICAgICAgLy8vCiAgICAgICAgICAgIC8vIGluIHRoZSBjYXNlIG9mIGEgY29udHJvbCBmaWVsZCwgdGhlIHJlbmRlcmVkRG9tRWxlbWVudCBpcyB0aGUgY29udHJvbCBmaWVsZCByZW5kZXJlZCB1c2luZyB0aGUgdGVtcGxhdGUKICAgICAgICAgICAgLy8gJ3RlbXBsYXRlRGVzY3JpcHRvcicgd2hpY2ggaXMgdGhlIGNvbnRyb2xGaWVsZCB0ZW1wbGF0ZSBmcm9tIHRoZSB2aWV3CiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vIHRoaXMgcmVuZGVyZWREb21FbGVtZW50IHNlcnZpY2VzIGFzIGEgY29udGFpbmVyIGZvciB0aGUgY29udHJvbCBmaWVsZCBpdHNlbGYgd2hpY2ggd2UgY2FuIG5vdyByZW5kZXIgSU5UTwogICAgICAgICAgICAvLyB0aGUgcmVuZGVyZWREb21FbGVtZW50IGlmIHdlIHdhbnQuCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vIGhvd2V2ZXIsIGlmIHdlJ3JlIGluIERJU1BMQVlfT05MWSBtb2RlIChpLmUuIHZpZXcudHlwZSA9PSAidmlldyIpIHRoZW4gdGhlIGNvbnRyb2xGaWVsZCB3aWxsIGhhdmUgYWxyZWFkeQogICAgICAgICAgICAvLyByZW5kZXJlZCBhIHNpbXBsZSB0ZXh0dWFsIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBkYXRhCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vIHRoZXJlZm9yZSwgaWYgd2UncmUgaW4gRElTUExBWV9PTkxZIG1vZGUsIHdlIGRvIG5vdCB3YW50IHRvIHJlbmRlciB0aGUgZmllbGQgY29udHJvbCAod2hpY2ggd291bGQgYmUgc29tZXRoaW5nCiAgICAgICAgICAgIC8vIGxpa2UgYW4gSU5QVVQgZmllbGQpLiAgdGhlcmVmb3JlLCBpZiB3ZSdyZSByZW5kZXJpbmcgYSBjb250cm9sIChsaWtlIGEgdGV4dCBmaWVsZCksIHRoZW4gd2Ugc2hvdWxkIHN0b3Agbm93CiAgICAgICAgICAgIC8vIG90aGVyd2lzZSwgaWYgd2UgYXJlIGEgQ29udGFpbmVyRmllbGQsIHRoZW4gd2UgZG8gd2FudCB0byBjb250aW51ZSBzbyB0aGF0IGFueSBjaGlsZHJlbiBjYW4gcHJvY2VzcwogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBpbiBhZGRpdGlvbiwgaWYgd2UncmUgaW4gc2luZ2xlTGV2ZWxSZW5kZXJpbmcgKGluIHdoaWNoIGNhc2UgdGhlIHRvcCBtb3N0IGdsb2JhbCB0ZW1wbGF0ZSBoYXMgdGFrZW4gY2FyZQogICAgICAgICAgICAvLyBvZiByZW5kZXJpbmcgZXZlcnl0aGluZyksIHRoZW4gd2UgZG8gbm90IHdhbnQgdG8gcmVuZGVyIHRoZSBmaWVsZC4KICAgICAgICAgICAgaWYgKCF0aGlzLnNpbmdsZUxldmVsUmVuZGVyaW5nKSB7CgogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzRGlzcGxheU9ubHkoKSB8fCAoIXRoaXMuaXNDb250cm9sRmllbGQpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyRmllbGQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvblN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uU3VjY2Vzcyh0aGlzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChvblN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb25TdWNjZXNzKHRoaXMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAob25TdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgb25TdWNjZXNzKHRoaXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVuZGVycyBET00gZWxlbWVudHMgZm9yIHRoaXMgZmllbGQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gb25TdWNjZXNzIHtGdW5jdGlvbn0gb25TdWNjZXNzIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIHJlbmRlckZpZWxkOiBmdW5jdGlvbihvblN1Y2Nlc3MpIHsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBBcHBsaWVzIHN0eWxlIGluamVjdGlvbiBmdW5jdGlvbiBmb3IgdGhlIHByb3ZpZGVkIGl0ZW0ga2V5LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIGtleSBpdGVtIGtleSBmb3Igc3R5bGUgaW5qZWN0aW9uCiAgICAgICAgICogQHBhcmFtIHRhcmdldERpdiB0YXJnZXQgRElWIG9mIHN0eWxlIGluamVjdGlvbgogICAgICAgICAqLwogICAgICAgIGdldFN0eWxlSW5qZWN0aW9uOiBmdW5jdGlvbihrZXksdGFyZ2V0RGl2LCBhcmcxLCBhcmcyKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnZpZXcuc3R5bGUgJiYgQWxwYWNhLnN0eWxlSW5qZWN0aW9uc1t0aGlzLnZpZXcuc3R5bGVdICYmIEFscGFjYS5zdHlsZUluamVjdGlvbnNbdGhpcy52aWV3LnN0eWxlXVtrZXldKSB7CiAgICAgICAgICAgICAgICBBbHBhY2Euc3R5bGVJbmplY3Rpb25zW3RoaXMudmlldy5zdHlsZV1ba2V5XS5jYWxsKHRoaXMsdGFyZ2V0RGl2LCBhcmcxLCBhcmcyKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFRoaXMgbWV0aG9kIHdpbGwgYmUgY2FsbGVkIGFmdGVyIHRoZSBmaWVsZCByZW5kaXRpb24gaXMgY29tcGxldGUuIEl0IGlzIHNlcnZlZCBhcyBhIHdheSB0byBtYWtlIGZpbmFsCiAgICAgICAgICogbW9kaWZpY2F0aW9ucyB0byB0aGUgZG9tIGVsZW1lbnRzIHRoYXQgd2VyZSBwcm9kdWNlZC4KICAgICAgICAgKi8KICAgICAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbihjYWxsYmFjaykgewoKICAgICAgICAgICAgLy8gdHJ5IHRvIGF2b2lkIGFkZGluZyB1bm5lY2Vzc2FyeSBpbmplY3Rpb25zIGZvciBkaXNwbGF5IHZpZXcuCiAgICAgICAgICAgIGlmICh0aGlzLnZpZXcudHlwZSAhPSAndmlldycpIHsKCiAgICAgICAgICAgICAgICAvLyBhZGQgY2xhc3NlcwogICAgICAgICAgICAgICAgdGhpcy5nZXRTdHlsZUluamVjdGlvbignZmllbGQnLHRoaXMuZ2V0RWwoKSk7CgogICAgICAgICAgICAgICAgdGhpcy5nZXRFbCgpLmFkZENsYXNzKCJhbHBhY2EtZmllbGQiKTsKCiAgICAgICAgICAgICAgICAvLyBmb3IgZWRpdCBvciBjcmVhdGUgbW9kZQogICAgICAgICAgICAgICAgLy8gaW5qZWN0cyBJZHMKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdldEVsKCkuYXR0cigiaWQiKSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0RWwoKS5hdHRyKCJpZCIsIHRoaXMuZ2V0SWQoKSArICItZmllbGQtb3V0ZXIiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNFbXB0eSh0aGlzLmdldEVsKCkuYXR0cigiYWxwYWNhLWZpZWxkLWlkIikpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRFbCgpLmF0dHIoImFscGFjYS1maWVsZC1pZCIsIHRoaXMuZ2V0SWQoKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBvcHRpb25hbAogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2NoZW1hLnJlcXVpcmVkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRFbCgpLmFkZENsYXNzKCJhbHBhY2EtZmllbGQtcmVxdWlyZWQiKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRFbCgpLmFkZENsYXNzKCJhbHBhY2EtZmllbGQtb3B0aW9uYWwiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyByZWFkb25seQogICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5yZWFkb25seSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0RWwoKS5hZGRDbGFzcygiYWxwYWNhLWZpZWxkLXJlYWRvbmx5Iik7CiAgICAgICAgICAgICAgICAgICAgJCgnOmlucHV0JywgdGhpcy5nZXRFbCgpKS5hdHRyKCdyZWFkb25seScsICdyZWFkb25seScpOwogICAgICAgICAgICAgICAgICAgICQoJ3NlbGVjdCcsIHRoaXMuZ2V0RWwoKSkuYXR0cignZGlzYWJsZWQnLCAnZGlzYWJsZWQnKTsKICAgICAgICAgICAgICAgICAgICAkKCc6cmFkaW8nLCB0aGlzLmdldEVsKCkpLmF0dHIoJ2Rpc2FibGVkJywgJ2Rpc2FibGVkJyk7CiAgICAgICAgICAgICAgICAgICAgJCgnOmNoZWNrYm94JywgdGhpcy5nZXRFbCgpKS5hdHRyKCdkaXNhYmxlZCcsICdkaXNhYmxlZCcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGFsbG93IHNpbmdsZSBvciBtdWx0aXBsZSBmaWVsZCBjbGFzc2VzIHRvIGJlIHNwZWNpZmllZCB2aWEgdGhlICJmaWVsZENsYXNzIgogICAgICAgICAgICAgICAgLy8gb3IgImZpZWxkQ2xhc3NlcyIgb3B0aW9ucwogICAgICAgICAgICAgICAgdmFyIGFwcGx5RmllbGRDbGFzcyA9IGZ1bmN0aW9uKGVsLCB0aGluZykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpbmcpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VucyA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzQXJyYXkodGhpbmcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpbmcubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbC5hZGRDbGFzcyh0aGluZ1tpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpbmcuaW5kZXhPZigiLCIpID4gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbnMgPSB0aGluZy5zcGxpdCgiLCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB0b2tlbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuYWRkQ2xhc3ModG9rZW5zW2ldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaW5nLmluZGV4T2YoIiAiKSA+IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5zID0gdGhpbmcuc3BsaXQoIiAiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLmFkZENsYXNzKHRva2Vuc1tpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuYWRkQ2xhc3ModGhpbmcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGFwcGx5RmllbGRDbGFzcyh0aGlzLmdldEVsKCksIHRoaXMub3B0aW9uc1siZmllbGRDbGFzcyJdKTsKCiAgICAgICAgICAgICAgICAvLyBTdXBwb3J0IGZvciBjdXN0b20gc3R5bGVzIHByb3ZpZGVkIGJ5IGN1c3RvbSB2aWV3CiAgICAgICAgICAgICAgICB2YXIgY3VzdG9tU3R5bGVzID0gdGhpcy52aWV3LmdldFN0eWxlcygpOwoKICAgICAgICAgICAgICAgIGlmIChjdXN0b21TdHlsZXMpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBzdHlsZUNsYXNzIGluIGN1c3RvbVN0eWxlcykgewogICAgICAgICAgICAgICAgICAgICAgICAkKHN0eWxlQ2xhc3MsIHRoaXMuY29udGFpbmVyKS5jc3MoY3VzdG9tU3R5bGVzW3N0eWxlQ2xhc3NdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gYWRkIHJlcXVpcmVkIGZpZWxkIHN0eWxlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5sYWJlbERpdiAmJiB0aGlzLnNjaGVtYS5yZXF1aXJlZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0U3R5bGVJbmplY3Rpb24oJ3JlcXVpcmVkJyx0aGlzLmxhYmVsRGl2KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBhZnRlciByZW5kZXIKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuZGlzYWJsZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc2FibGUoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyB3ZSBiaW5kIGRhdGEgaWYgd2UncmUgaW4gImVkaXQiIG1vZGUKICAgICAgICAgICAgICAgIC8vIHR5cGljYWxseSwgd2UgZG9uJ3QgYmluZCBkYXRhIGlmIHdlJ3JlIGluICJjcmVhdGUiIG9yIGFueSBvdGhlciBtb2RlCiAgICAgICAgICAgICAgICBpZiAodGhpcy52aWV3LnR5cGUgJiYgdGhpcy52aWV3LnR5cGUgPT0gJ2VkaXQnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5iaW5kRGF0YSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5zaG93aW5nRGVmYXVsdERhdGEpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhpcyBjb250cm9sIGlzIHNob3dpbmcgZGVmYXVsdCBkYXRhLCB0aGVuIHdlIHJlbmRlciB0aGUgY29udHJvbCBhbnl3YXkKICAgICAgICAgICAgICAgICAgICB0aGlzLmJpbmREYXRhKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gc29tZSBsb2dnaW5nIHRvIGJlIHVzZWZ1bAogICAgICAgICAgICAgICAgaWYgKHRoaXMudmlldy50eXBlID09ICJjcmVhdGUiKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIEFscGFjYS5sb2dEZWJ1ZygiU2tpcHBpbmcgZGF0YSBiaW5kaW5nIGZvciBmaWVsZDogIiArIHRoaXMuaWQgKyAiIHNpbmNlIHZpZXcgbW9kZSBpcyAnY3JlYXRlJyIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGluaXRpYWxpemUgZG9tLWxldmVsIGV2ZW50cwogICAgICAgICAgICAgICAgaWYgKHRoaXMudmlldy50eXBlICYmIHRoaXMudmlldy50eXBlICE9ICd2aWV3JykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaW5pdEV2ZW50cygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBoaWRkZW4KICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5oaWRkZW4pIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2V0RWwoKS5oaWRlKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGZpbmlzaGVkIGluaXRpYWxpemluZwogICAgICAgICAgICB0aGlzLmluaXRpYWxpemluZyA9IGZhbHNlOwoKICAgICAgICAgICAgdmFyIGRlZmF1bHRIaWRlSW5pdFZhbGlkYXRpb25FcnJvciA9ICh0aGlzLnZpZXcudHlwZSA9PSAnY3JlYXRlJyk7CiAgICAgICAgICAgIHRoaXMuaGlkZUluaXRWYWxpZGF0aW9uRXJyb3IgPSBBbHBhY2EuaXNWYWxFbXB0eSh0aGlzLm9wdGlvbnMuaGlkZUluaXRWYWxpZGF0aW9uRXJyb3IpID8gZGVmYXVsdEhpZGVJbml0VmFsaWRhdGlvbkVycm9yIDogdGhpcy5vcHRpb25zLmhpZGVJbml0VmFsaWRhdGlvbkVycm9yOwoKICAgICAgICAgICAgLy8gZm9yIGNyZWF0ZSB2aWV3LCBoaWRlIGFsbCByZWFkb25seSBmaWVsZHMKICAgICAgICAgICAgaWYgKCF0aGlzLnZpZXcuZGlzcGxheVJlYWRvbmx5KSB7CiAgICAgICAgICAgICAgICAkKCcuYWxwYWNhLWZpZWxkLXJlYWRvbmx5JywgdGhpcy5nZXRFbCgpKS5oaWRlKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGZpZWxkIGxldmVsIHBvc3QgcmVuZGVyCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMucG9zdFJlbmRlcikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLnBvc3RSZW5kZXIuY2FsbCh0aGlzLCBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0cmlldmVzIHRoZSByZW5kZXJlZCBET00gZWxlbWVudC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFRoZSByZW5kZXJlZCBET00gZWxlbWVudC4KICAgICAgICAgKi8KICAgICAgICBnZXRFbDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm91dGVyRWw7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogU2V0cyB0aGUgb3V0ZXIgZWxlbWVudCBvZiB0aGUgRE9NIGVsZW1lbnQgdG8gYmUgcmVuZGVyZWQgYnkgdGhpcyBmaWVsZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBvdXRlckVsIE5ldyBvdXRlciBlbGVtZW50IGZvciB0aGlzIGZpZWxkLgogICAgICAgICAqLwogICAgICAgIHNldEVsOiBmdW5jdGlvbihvdXRlckVsKSB7CiAgICAgICAgICAgIHRoaXMub3V0ZXJFbCA9IG91dGVyRWw7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGUgaWQgb2YgdGhlIGZpZWxkLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMgRmllbGQgaWQuCiAgICAgICAgICovCiAgICAgICAgZ2V0SWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5pZDsKICAgICAgICB9LAoKICAgICAgICAvKiAgICAgICAgZ2V0VHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgIHJldHVybiB0aGlzLnR5cGU7CiAgICAgICAgIH0sKi8KCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGlzIGZpZWxkJ3MgcGFyZW50LgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0FscGFjYS5GaWVsZH0gRmllbGQgcGFyZW50LgogICAgICAgICAqLwogICAgICAgIGdldFBhcmVudDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcmVudDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyBpZiB0aGlzIGZpZWxkIGlzIHRvcCBsZXZlbC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmIHRoaXMgZmllbGQgaXMgdGhlIHRvcCBsZXZlbCBvbmUsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgKi8KICAgICAgICBpc1RvcExldmVsOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5pc0VtcHR5KHRoaXMucGFyZW50KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIHRoZSB2YWx1ZSBvZiB0aGlzIGZpZWxkLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0FueX0gdmFsdWUgRmllbGQgdmFsdWUuCiAgICAgICAgICovCiAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5kYXRhOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFNldHMgdGhlIHZhbHVlIG9mIHRoZSBmaWVsZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7QW55fSB2YWx1ZSBWYWx1ZSB0byBiZSBzZXQuCiAgICAgICAgICovCiAgICAgICAgc2V0VmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMuZGF0YSA9IHZhbHVlOwogICAgICAgICAgICB0aGlzLnRyaWdnZXJVcGRhdGUoKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZXNldHMgdmFsdWUgdG8gZGVmYXVsdC4KICAgICAgICAgKi8KICAgICAgICBzZXREZWZhdWx0OiBmdW5jdGlvbigpIHsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIHRoZSBmaWVsZCB0ZW1wbGF0ZSBkZXNjcmlwdG9yLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gdGVtcGxhdGUgZGVzY3JpcHRvcgogICAgICAgICAqLwogICAgICAgIGdldFRlbXBsYXRlRGVzY3JpcHRvcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnRlbXBsYXRlRGVzY3JpcHRvcjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBTZXRzIHRoZSBmaWVsZCB0ZW1wbGF0ZSBkZXNjcmlwdG9yLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHRlbXBsYXRlIGRlc2NyaXB0b3IKICAgICAgICAgKi8KICAgICAgICBzZXRUZW1wbGF0ZURlc2NyaXB0b3I6IGZ1bmN0aW9uKHRlbXBsYXRlRGVzY3JpcHRvcikgewogICAgICAgICAgICB0aGlzLnRlbXBsYXRlRGVzY3JpcHRvciA9IHRlbXBsYXRlRGVzY3JpcHRvcjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZW5kZXJzIGEgdmFsaWRhdGlvbiBzdGF0ZSBtZXNzYWdlIGJlbG93IHRoZSBmaWVsZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBtZXNzYWdlcyBWYWxpZGF0aW9uIHN0YXRlIG1lc3NhZ2VzLgogICAgICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gYmVmb3JlU3RhdHVzIFByZXZpb3VzIHZhbGlkYXRpb24gc3RhdHVzLgogICAgICAgICAqLwogICAgICAgIGRpc3BsYXlNZXNzYWdlOiBmdW5jdGlvbihtZXNzYWdlcywgYmVmb3JlU3RhdHVzKSB7CgogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgLy8gcmVtb3ZlIHRoZSBtZXNzYWdlIGVsZW1lbnQgaWYgaXQgZXhpc3RzCiAgICAgICAgICAgIF90aGlzLmdldEVsKCkuY2hpbGRyZW4oIi5hbHBhY2EtY29udHJvbGZpZWxkLW1lc3NhZ2UtZWxlbWVudCIpLnJlbW92ZSgpOwoKICAgICAgICAgICAgLy8gYWRkIG1lc3NhZ2UgYW5kIGdlbmVyYXRlIGl0CiAgICAgICAgICAgIGlmIChtZXNzYWdlcyAmJiBtZXNzYWdlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAkLmVhY2gobWVzc2FnZXMsIGZ1bmN0aW9uKGluZGV4LCBtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbWVzc2FnZVRlbXBsYXRlRGVzY3JpcHRvciA9IF90aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJjb250cm9sRmllbGRNZXNzYWdlIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlVGVtcGxhdGVEZXNjcmlwdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5tZXNzYWdlRWxlbWVudCA9IF90aGlzLnZpZXcudG1wbChtZXNzYWdlVGVtcGxhdGVEZXNjcmlwdG9yLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiBtZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmdldFN0eWxlSW5qZWN0aW9uKCdlcnJvck1lc3NhZ2UnLF90aGlzLm1lc3NhZ2VFbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfdGhpcy5oaWRlSW5pdFZhbGlkYXRpb25FcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLm1lc3NhZ2VFbGVtZW50LmFkZENsYXNzKCJhbHBhY2EtY29udHJvbGZpZWxkLW1lc3NhZ2UtaGlkZGVuIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLm1lc3NhZ2VFbGVtZW50LmFkZENsYXNzKCJhbHBhY2EtY29udHJvbGZpZWxkLW1lc3NhZ2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLm1lc3NhZ2VFbGVtZW50LmFkZENsYXNzKCJhbHBhY2EtY29udHJvbGZpZWxkLW1lc3NhZ2UtZWxlbWVudCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMubWVzc2FnZUVsZW1lbnQuYXR0cigiaWQiLCBfdGhpcy5nZXRJZCgpICsgJy1maWVsZC1tZXNzYWdlLScgKyBpbmRleCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjaGVjayB0byBzZWUgaWYgd2UgaGF2ZSBhIG1lc3NhZ2UgY29udGFpbmVyIHJlbmRlcmVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJCgnLmFscGFjYS1jb250cm9sZmllbGQtbWVzc2FnZS1jb250YWluZXInLCBfdGhpcy5nZXRFbCgpKS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5tZXNzYWdlRWxlbWVudC5hcHBlbmRUbygkKCcuYWxwYWNhLWNvbnRyb2xmaWVsZC1tZXNzYWdlLWNvbnRhaW5lcicsIF90aGlzLmdldEVsKCkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMubWVzc2FnZUVsZW1lbnQuYXBwZW5kVG8oX3RoaXMuZ2V0RWwoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmdldFN0eWxlSW5qZWN0aW9uKCdhZGRFcnJvck1lc3NhZ2UnLCBfdGhpcy5nZXRFbCgpLCBtZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEZvcmNlcyB0aGUgdmFsaWRhdGlvbiBmb3IgYSBmaWVsZCB0byBiZSByZWZyZXNoZWQgb3IgcmVkcmF3biB0byB0aGUgc2NyZWVuLgogICAgICAgICAqCiAgICAgICAgICogSWYgdG9sZCB0byBjaGVjayBjaGlsZHJlbiwgdGhlbiBhbGwgY2hpbGRyZW4gb2YgdGhlIGNvbnRhaW5lciBmaWVsZCB3aWxsIGJlIHJlZnJlc2hlZCBhcyB3ZWxsLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtCb29sZWFufSBjaGlsZHJlbiB3aGV0aGVyIHRvIHJlZnJlc2ggY2hpbGRyZW4KICAgICAgICAgKi8KICAgICAgICByZWZyZXNoVmFsaWRhdGlvblN0YXRlOiBmdW5jdGlvbihjaGlsZHJlbikKICAgICAgICB7CiAgICAgICAgICAgIGlmIChjaGlsZHJlbikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGYgPSBmdW5jdGlvbihmaWVsZCwgY29udGV4dHMpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIGZpZWxkIGhhcyBjaGlsZHJlbiwgZ28gZGVwdGggZmlyc3QKICAgICAgICAgICAgICAgICAgICBpZiAoZmllbGQuY2hpbGRyZW4gJiYgZmllbGQuY2hpbGRyZW4ubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZmllbGQuY2hpbGRyZW4ubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaWVsZC5jaGlsZHJlbltpXS5pc1ZhbGlkYXRpb25QYXJ0aWNpcGFudCgpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYoZmllbGQuY2hpbGRyZW5baV0sIGNvbnRleHRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZihjb250ZXh0cykgPT0gIm9iamVjdCIpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb21waWxlIHRoZSB2YWxpZGF0aW9uIGNvbnRleHQgZm9yIHRoaXMgZmllbGQKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSBBbHBhY2EuY29tcGlsZVZhbGlkYXRpb25Db250ZXh0KGZpZWxkKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dHMucHVzaChjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0czsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gcnVuIG9uY2UgdG8gY2F1c2UgZXZlcnl0aGluZyB0byBmbGlwIHRvIGNvcnJlY3Qgc3RhdGUKICAgICAgICAgICAgICAgIC8vZih0aGlzKTsKCiAgICAgICAgICAgICAgICAvLyBydW4gYWdhaW4gdG8gY29sbGVjdCBjb250ZXh0cyAobm90aGluZyBmbGlwcykKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0cyA9IGYodGhpcywgW10pOwoKICAgICAgICAgICAgICAgIC8vIG1lcmdlCiAgICAgICAgICAgICAgICB2YXIgbWVyZ2VkTWFwID0ge307CiAgICAgICAgICAgICAgICB2YXIgbWVyZ2VkQ29udGV4dCA9IFtdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb250ZXh0cy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IGNvbnRleHRzW2ldOwoKICAgICAgICAgICAgICAgICAgICAvLyBOT1RFOiBjb250ZXh0IGlzIGFscmVhZHkgaW4gb3JkZXIgW2NoaWxkLCBwYXJlbnQsIC4uLl0KCiAgICAgICAgICAgICAgICAgICAgdmFyIG1JbmRleCA9IG1lcmdlZENvbnRleHQubGVuZ3RoOwoKICAgICAgICAgICAgICAgICAgICAvLyB3YWxrIGZvcndhcmQKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGNvbnRleHQubGVuZ3RoOyBqKyspCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZW50cnkgPSBjb250ZXh0W2pdOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gbWVyZ2VkTWFwW2VudHJ5LmlkXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFleGlzdGluZykKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8ganVzdCBhZGQgdG8gZW5kCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3RW50cnkgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0VudHJ5LmlkID0gZW50cnkuaWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdFbnRyeS5wYXRoID0gZW50cnkucGF0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0VudHJ5LmNvbnRhaW5lciA9IGVudHJ5LmNvbnRhaW5lcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0VudHJ5LmZpZWxkID0gZW50cnkuZmllbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdFbnRyeS52YWxpZGF0ZWQgPSBlbnRyeS52YWxpZGF0ZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdFbnRyeS5pbnZhbGlkYXRlZCA9IGVudHJ5LmludmFsaWRhdGVkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3RW50cnkudmFsaWQgPSBlbnRyeS52YWxpZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lcmdlZENvbnRleHQuc3BsaWNlKG1JbmRleCwgMCwgbmV3RW50cnkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG1hcmsgaW4gbWFwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXJnZWRNYXBbbmV3RW50cnkuaWRdID0gbmV3RW50cnk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW50cnkudmFsaWRhdGVkICYmICFleGlzdGluZy5pbnZhbGlkYXRlZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZy52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLmludmFsaWRhdGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmcudmFsaWQgPSBlbnRyeS52YWxpZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW50cnkuaW52YWxpZGF0ZWQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuaW52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLnZhbGlkYXRlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLnZhbGlkID0gZW50cnkudmFsaWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gbm93IHJldmVyc2UgaXQgc28gdGhhdCBjb250ZXh0IGlzIG5vcm1hbGl6ZWQgd2l0aCBjaGlsZCBmaWVsZHMgZmlyc3QKICAgICAgICAgICAgICAgIG1lcmdlZENvbnRleHQucmV2ZXJzZSgpOwoKICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSB2YWxpZGF0aW9uIHN0YXRlCiAgICAgICAgICAgICAgICBBbHBhY2EudXBkYXRlVmFsaWRhdGlvblN0YXRlRm9yQ29udGV4dChtZXJnZWRDb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIGp1c3Qgb3Vyc2VsdmVzCgogICAgICAgICAgICAgICAgLy8gY29tcGlsZSB0aGUgdmFsaWRhdGlvbiBjb250ZXh0IGZvciB0aGUgZmllbGQKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gQWxwYWNhLmNvbXBpbGVWYWxpZGF0aW9uQ29udGV4dCh0aGlzKTsKCiAgICAgICAgICAgICAgICAvLyB1cGRhdGUgdGhlIFVJIGZvciB0aGVzZSBjb250ZXh0IGl0ZW1zCiAgICAgICAgICAgICAgICBBbHBhY2EudXBkYXRlVmFsaWRhdGlvblN0YXRlRm9yQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHNob3dIaWRkZW5NZXNzYWdlczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBoaWRkZW5EaXYgPSAkKCcuYWxwYWNhLWZpZWxkLWludmFsaWQtaGlkZGVuJywgdGhpcy5vdXRlckVsKTsKICAgICAgICAgICAgaGlkZGVuRGl2LnJlbW92ZUNsYXNzKCdhbHBhY2EtZmllbGQtaW52YWxpZC1oaWRkZW4nKTsKICAgICAgICAgICAgdGhpcy5nZXRTdHlsZUluamVjdGlvbignZXJyb3InLGhpZGRlbkRpdik7CiAgICAgICAgICAgIGhpZGRlbkRpdi5hZGRDbGFzcygnYWxwYWNhLWZpZWxkLWludmFsaWQnKTsKICAgICAgICAgICAgJCgnLmFscGFjYS1jb250cm9sZmllbGQtbWVzc2FnZS1oaWRkZW4nLCB0aGlzLm91dGVyRWwpLnJlbW92ZUNsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLW1lc3NhZ2UtaGlkZGVuJykuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtbWVzc2FnZScpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlcyB0aGlzIGZpZWxkIGFuZCByZXR1cm5zIHdoZXRoZXIgaXQgaXMgaW4gYSB2YWxpZCBzdGF0ZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBbQm9vbGVhbl0gdmFsaWRhdGVDaGlsZHJlbiB3aGV0aGVyIHRvIGNoaWxkIGNvbnRyb2xzLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgdmFsdWUgb2YgdGhpcyBmaWVsZCBpcyB2YWxpZCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIHZhbGlkYXRlOiBmdW5jdGlvbih2YWxpZGF0ZUNoaWxkcmVuKQogICAgICAgIHsKICAgICAgICAgICAgLy8gc2tpcCBvdXQgaWYgd2UgaGF2ZW4ndCB5ZXQgYm91bmQgYW55IGRhdGEgaW50byB0aGlzIGNvbnRyb2wKICAgICAgICAgICAgLy8gdGhlIGNvbnRyb2wgY2FuIHN0aWxsIGJlIGNvbnNpZGVyZWQgdG8gYmUgaW5pdGlhbGl6aW5nCiAgICAgICAgICAgIHZhciBzdGF0dXMgPSB0cnVlOwoKICAgICAgICAgICAgaWYgKCF0aGlzLmluaXRpYWxpemluZyAmJiB0aGlzLm9wdGlvbnMudmFsaWRhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIGlmIHZhbGlkYXRlQ2hpbGRyZW4sIHRoZW4gd2FsayByZWN1cnNpdmVseSBkb3duIGludG8gY2hpbGQgZWxlbWVudHMKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoaWxkcmVuICYmIHZhbGlkYXRlQ2hpbGRyZW4pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gdGhpcy5jaGlsZHJlbltpXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLmlzVmFsaWRhdGlvblBhcnRpY2lwYW50KCkpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLnZhbGlkYXRlKHZhbGlkYXRlQ2hpbGRyZW4pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGV2YWx1YXRlIG91cnNlbHZlcwogICAgICAgICAgICAgICAgc3RhdHVzID0gdGhpcy5oYW5kbGVWYWxpZGF0ZSgpOwoKICAgICAgICAgICAgICAgIC8vIHN1cHBvcnQgZm9yIHNvbWUgZGVidWdnaW5nCiAgICAgICAgICAgICAgICBpZiAoIXN0YXR1cyAmJiBBbHBhY2EubG9nTGV2ZWwgPT0gQWxwYWNhLkRFQlVHKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIG1lc3NhZ2VzCiAgICAgICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2VzID0gW107CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgbWVzc2FnZUlkIGluIHRoaXMudmFsaWRhdGlvbikKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy52YWxpZGF0aW9uW21lc3NhZ2VJZF1bInN0YXR1cyJdKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlcy5wdXNoKHRoaXMudmFsaWRhdGlvblttZXNzYWdlSWRdWyJtZXNzYWdlIl0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBBbHBhY2EubG9nRGVidWcoIlZhbGlkYXRpb24gZmFpbHVyZSBmb3IgZmllbGQgKGlkPSIgKyB0aGlzLmdldElkKCkgKyAiLCBwYXRoPSIgKyB0aGlzLnBhdGggKyAiKSwgbWVzc2FnZXM6ICIgKyBKU09OLnN0cmluZ2lmeShtZXNzYWdlcykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9wcmV2aW91c2x5VmFsaWRhdGVkID0gdHJ1ZTsKCiAgICAgICAgICAgIHJldHVybiBzdGF0dXM7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUGVyZm9ybXMgdmFsaWRhdGlvbi4KICAgICAgICAgKi8KICAgICAgICBoYW5kbGVWYWxpZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB2YWxJbmZvID0gdGhpcy52YWxpZGF0aW9uOwoKICAgICAgICAgICAgdmFyIHN0YXR1cyA9IHRoaXMuX3ZhbGlkYXRlT3B0aW9uYWwoKTsKICAgICAgICAgICAgdmFsSW5mb1sibm90T3B0aW9uYWwiXSA9IHsKICAgICAgICAgICAgICAgICJtZXNzYWdlIjogc3RhdHVzID8gIiIgOiB0aGlzLnZpZXcuZ2V0TWVzc2FnZSgibm90T3B0aW9uYWwiKSwKICAgICAgICAgICAgICAgICJzdGF0dXMiOiBzdGF0dXMKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHN0YXR1cyA9IHRoaXMuX3ZhbGlkYXRlRGlzYWxsb3coKTsKICAgICAgICAgICAgdmFsSW5mb1siZGlzYWxsb3dWYWx1ZSJdID0gewogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiBzdGF0dXMgPyAiIiA6IEFscGFjYS5zdWJzdGl0dXRlVG9rZW5zKHRoaXMudmlldy5nZXRNZXNzYWdlKCJkaXNhbGxvd1ZhbHVlIiksIFt0aGlzLnNjaGVtYVsiZGlzYWxsb3ciXS5qb2luKCcsJyldKSwKICAgICAgICAgICAgICAgICJzdGF0dXMiOiBzdGF0dXMKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiB2YWxJbmZvWyJub3RPcHRpb25hbCJdWyJzdGF0dXMiXSAmJiB2YWxJbmZvWyJkaXNhbGxvd1ZhbHVlIl1bInN0YXR1cyJdOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlcyB1c2luZyB1c2VyIHByb3ZpZGVkIHZhbGlkYXRvci4KICAgICAgICAgKi8KICAgICAgICBfdmFsaWRhdGVDdXN0b21WYWxpZGF0b3I6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy52YWxpZGF0b3IgJiYgQWxwYWNhLmlzRnVuY3Rpb24odGhpcy5vcHRpb25zLnZhbGlkYXRvcikpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy52YWxpZGF0b3IodGhpcywgZnVuY3Rpb24odmFsSW5mbykgewoKICAgICAgICAgICAgICAgICAgICAvLyBhbHdheXMgc3RvcmUgaW4gImN1c3RvbSIKICAgICAgICAgICAgICAgICAgICBfdGhpcy52YWxpZGF0aW9uWyJjdXN0b20iXSA9IHZhbEluZm87CgogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBWYWxpZGF0ZXMgYWdhaW5zdCByZXF1aXJlZCBwcm9wZXJ0eS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBGYWxzZSBpZiB0aGlzIGZpZWxkIHZhbHVlIGlzIGVtcHR5IGJ1dCByZXF1aXJlZCwgdHJ1ZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgX3ZhbGlkYXRlT3B0aW9uYWw6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5zY2hlbWEucmVxdWlyZWQgJiYgdGhpcy5pc0VtcHR5KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBDaGVja3Mgd2hldGhlciB0aGUgZmllbGQgdmFsdWUgaXMgYWxsb3dlZCBvciBub3QuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZiB0aGUgZmllbGQgdmFsdWUgaXMgYWxsb3dlZCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZURpc2FsbG93OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNWYWxFbXB0eSh0aGlzLnNjaGVtYS5kaXNhbGxvdykpIHsKICAgICAgICAgICAgICAgIHZhciB2YWwgPSB0aGlzLmdldFZhbHVlKCk7CiAgICAgICAgICAgICAgICB2YXIgZGlzYWxsb3cgPSB0aGlzLnNjaGVtYS5kaXNhbGxvdzsKICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNBcnJheShkaXNhbGxvdykpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaXNBbGxvd2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAkLmVhY2goZGlzYWxsb3csIGZ1bmN0aW9uKGluZGV4LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKEFscGFjYS5pc09iamVjdCh2YWwpIHx8IEFscGFjYS5pc0FycmF5KHZhbCkpICYmIEFscGFjYS5pc1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gQWxwYWNhLnBhcnNlSlNPTih2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFscGFjYS5jb21wYXJlT2JqZWN0KHZhbCwgdmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0FsbG93ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBpc0FsbG93ZWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmICgoQWxwYWNhLmlzT2JqZWN0KHZhbCkgfHwgQWxwYWNhLmlzQXJyYXkodmFsKSkgJiYgQWxwYWNhLmlzU3RyaW5nKGRpc2FsbG93KSkgewogICAgICAgICAgICAgICAgICAgICAgICBkaXNhbGxvdyA9IEFscGFjYS5wYXJzZUpTT04oZGlzYWxsb3cpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gIUFscGFjYS5jb21wYXJlT2JqZWN0KHZhbCwgZGlzYWxsb3cpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBUcmlnZ2VycyBhbnkgZXZlbnQgaGFuZGxlcnMgdGhhdCBsaXN0ZW5zIHRvIHRoZSB1cGRhdGUgZXZlbnQgb2YgdGhpcyBmaWVsZC4KICAgICAgICAgKi8KICAgICAgICB0cmlnZ2VyVXBkYXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5nZXRFbCgpLnRyaWdnZXIoImZpZWxkdXBkYXRlIik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogRGlzYWJsZXMgdGhlIGZpZWxkLgogICAgICAgICAqLwogICAgICAgIGRpc2FibGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvLyBPVkVSUklERQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEVuYWJsZXMgdGhlIGZpZWxkLgogICAgICAgICAqLwogICAgICAgIGVuYWJsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIC8vIE9WRVJSSURFCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogRm9jdXNlcyBvbiB0aGUgZmllbGQuCiAgICAgICAgICovCiAgICAgICAgZm9jdXM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvLyBPVkVSUklERQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFB1cmdlcyBhbnkgZXZlbnQgbGlzdGVuZXJzIGFuZCByZW1vdmUgdGhpcyBmaWVsZCBmcm9tIHRoZSBET00uCiAgICAgICAgICovCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAvLyBjbGVhbiB1cCBBbHBhY2EuZmllbGRJbnN0YW5jZXMgc3RhdGljIHJlZmVyZW5jZSAodXNlZCBmb3IgY29udmVuaWVuY2UgYWNjZXNzIHRvIHByZXZpb3VzIHJlbmRlcmVkIGZpZWxkcykKICAgICAgICAgICAgaWYgKEFscGFjYSAmJiBBbHBhY2EuZmllbGRJbnN0YW5jZXMpIHsKICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuZmllbGRJbnN0YW5jZXNbdGhpcy5nZXRJZCgpXSkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBBbHBhY2EuZmllbGRJbnN0YW5jZXNbdGhpcy5nZXRJZCgpXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gY2xlYW4gdXAgRE9NCiAgICAgICAgICAgIHRoaXMuZ2V0RWwoKS5yZW1vdmUoKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBTaG93cyB0aGUgZmllbGQuCiAgICAgICAgICovCiAgICAgICAgc2hvdzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMgJiYgdGhpcy5vcHRpb25zLmhpZGRlbikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gaWYgdGhlIGhpZGRlbiBvcHRpb24gaXMgb24sIHdlJ3JlIGFsd2F5cyBoaWRkZW4KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIHNob3cgdGhlIGZpZWxkCiAgICAgICAgICAgICAgICB0aGlzLmdldEVsKCkuY3NzKHsKICAgICAgICAgICAgICAgICAgICAiZGlzcGxheSI6ICIiCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB0aGlzLm9uU2hvdygpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgb25TaG93OiBmdW5jdGlvbigpCiAgICAgICAgewoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBIaWRlcyB0aGUgZmllbGQuCiAgICAgICAgICovCiAgICAgICAgaGlkZTogZnVuY3Rpb24oKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nZXRFbCgpLmNzcyh7CiAgICAgICAgICAgICAgICAiZGlzcGxheSI6ICJub25lIgogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMub25IaWRlKCk7CiAgICAgICAgfSwKCiAgICAgICAgb25IaWRlOiBmdW5jdGlvbigpCiAgICAgICAgewoKICAgICAgICB9LAoKICAgICAgICBpc1ZhbGlkYXRpb25QYXJ0aWNpcGFudDogZnVuY3Rpb24oKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuaXNTaG93bigpOwogICAgICAgIH0sCgogICAgICAgIGlzU2hvd246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5pc1Zpc2libGUoKTsKICAgICAgICB9LAoKICAgICAgICBpc1Zpc2libGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIXRoaXMuaXNIaWRkZW4oKTsKICAgICAgICB9LAoKICAgICAgICBpc0hpZGRlbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAibm9uZSIgPT0gdGhpcy5nZXRFbCgpLmNzcygiZGlzcGxheSIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFByaW50cyB0aGUgZmllbGQuCiAgICAgICAgICovCiAgICAgICAgcHJpbnQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5jb250YWluZXIucHJpbnRBcmVhKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5wcmludEFyZWEoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFRyaWdnZXJlZCB3aGVuIHRoZSBmaWVsZCBpcyBiZWluZyByZXZlYWxlZCBhcyB0aGUgcmVzdWx0IG9mIGEgZGVwZW5kZW5jeSBvciBjb25kaXRpb25hbCBjYWxjdWxhdGlvbgogICAgICAgICAqIHRoYXQgaGFzIGRldGVybWluZWQgdGhhdCB0aGUgZmllbGQgc2hvdWxkIGJlIHNob3duLgogICAgICAgICAqLwogICAgICAgIG9uRGVwZW5kZW50UmV2ZWFsOiBmdW5jdGlvbigpCiAgICAgICAgewoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBUcmlnZ2VyZWQgd2hlbiB0aGUgZmllbGQgaXMgYmVpbmcgY29uY2VhbGVkIGFzIHRoZSByZXN1bHQgb2YgYSBkZXBlbmRlbmN5IG9yIGNvbmRpdGlvbmFsIGNhbGN1bGF0aW9uCiAgICAgICAgICogdGhhdCBoYXMgZGV0ZXJtaW5lZCB0aGF0IHRoZSBmaWVsZCBzaG91bGQgYmUgaGlkZGVuLgogICAgICAgICAqLwogICAgICAgIG9uRGVwZW5kZW50Q29uY2VhbDogZnVuY3Rpb24oKQogICAgICAgIHsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVsb2FkcyB0aGUgZmllbGQuCiAgICAgICAgICovCiAgICAgICAgcmVsb2FkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5pbml0aWFsaXppbmcgPSB0cnVlOwoKICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eSh0aGlzLmNhbGxiYWNrKSkgewogICAgICAgICAgICAgICAgdGhpcy5jYWxsYmFjayh0aGlzLCB0aGlzLnJlbmRlcmVkQ2FsbGJhY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIodGhpcy5yZW5kZXJlZENhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENsZWFycyB0aGUgZmllbGQgYW5kIHJlc2V0cyB0aGUgZmllbGQgdG8gaXRzIG9yaWdpbmFsIHZhbHVlLgogICAgICAgICAqLwogICAgICAgIGNsZWFyOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gbnVsbDsKCiAgICAgICAgICAgIGlmICh0aGlzLmRhdGEpIHsKICAgICAgICAgICAgICAgIG5ld1ZhbHVlID0gdGhpcy5kYXRhOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnNldFZhbHVlKG5ld1ZhbHVlKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyBpZiB0aGUgdmFsdWUgb2YgdGhpcyBmaWVsZCBpcyBlbXB0eS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59IFRydWUgaWYgdGhlIGZpZWxkIHZhbHVlIGlzIGVtcHR5LCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgaXNFbXB0eTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EuaXNWYWxFbXB0eSh0aGlzLmdldFZhbHVlKCkpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEZpbmRzIGlmIHRoaXMgZmllbGQgaXMgdmFsaWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufSBUcnVlIGlmIHRoZSBmaWVsZCBpcyB2YWxpZCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIGlzVmFsaWQ6IGZ1bmN0aW9uKGNoZWNrQ2hpbGRyZW4pIHsKCiAgICAgICAgICAgIGlmIChjaGVja0NoaWxkcmVuICYmIHRoaXMuY2hpbGRyZW4pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IHRoaXMuY2hpbGRyZW5baV07CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLmlzVmFsaWRhdGlvblBhcnRpY2lwYW50KCkpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNoaWxkLmlzVmFsaWQoY2hlY2tDaGlsZHJlbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCQuaXNFbXB0eU9iamVjdCh0aGlzLnZhbGlkYXRpb24pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLnZhbGlkYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMudmFsaWRhdGlvbltrZXldLnN0YXR1cykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBJbml0aWFsaXplcyBldmVudCBoYW5kbGluZy4KICAgICAgICAgKi8KICAgICAgICBpbml0RXZlbnRzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyB0cmlnZ2VyIGNvbnRyb2wgbGV2ZWwgaGFuZGxlcnMgZm9yIHRoaW5ncyB0aGF0IGhhcHBlbiB0byBpbnB1dCBlbGVtZW50CiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLmNoYW5nZShmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMub25DaGFuZ2UuY2FsbChfdGhpcywgZSk7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMudHJpZ2dlcigiY2hhbmdlIiwgZSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLmZvY3VzKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5vbkZvY3VzLmNhbGwoX3RoaXMsIGUpOwogICAgICAgICAgICAgICAgICAgIF90aGlzLnRyaWdnZXIoImZvY3VzIiwgZSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLmJsdXIoZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIF90aGlzLm9uQmx1ci5jYWxsKF90aGlzLCBlKTsKICAgICAgICAgICAgICAgICAgICBfdGhpcy50cmlnZ2VyKCJibHVyIiwgZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMuZmllbGQubW91c2VvdmVyKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5vbk1vdXNlT3Zlci5jYWxsKF90aGlzLCBlKTsKICAgICAgICAgICAgICAgICAgICBfdGhpcy50cmlnZ2VyKCJtb3VzZW92ZXIiLCBlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdGhpcy5maWVsZC5tb3VzZW91dChmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMub25Nb3VzZU91dC5jYWxsKF90aGlzLCBlKTsKICAgICAgICAgICAgICAgICAgICBfdGhpcy50cmlnZ2VyKCJtb3VzZW91dCIsIGUpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgLy8gcmVnaXN0ZXIgZ2VuZXJhbCBldmVudCBoYW5kbGVycyB0aHJvdWdoIG9wdGlvbnMKICAgICAgICAgICAgICAgICQuZWFjaCh0aGlzLm9wdGlvbnMsIGZ1bmN0aW9uKGtleSwgZnVuYykgewogICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2Euc3RhcnRzV2l0aChrZXksJ29uRmllbGQnKSAmJiBBbHBhY2EuaXNGdW5jdGlvbihmdW5jKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSBrZXkuc3Vic3RyaW5nKDcpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmZpZWxkLm9uKGV2ZW50LCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jLmNhbGwoX3RoaXMsZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ2FsbGJhY2sgZm9yIHdoZW4gdGhlIGZpZWxkIHJlY2VpdmVzIGZvY3VzLgogICAgICAgICAqCiAgICAgICAgICogRGVmYXVsdCBiZWhhdmlvciBpcyBmb3IgdGhlIGVudGlyZSBmaWVsZCB0byBoaWdobGlnaHQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gZSBkb20gZXZlbnQKICAgICAgICAgKi8KICAgICAgICBvbkZvY3VzOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHRoaXMuZ2V0RWwoKS5yZW1vdmVDbGFzcygiYWxwYWNhLWZpZWxkLWVtcHR5Iik7CiAgICAgICAgICAgIHRoaXMuZ2V0RWwoKS5hZGRDbGFzcygiYWxwYWNhLWZpZWxkLWZvY3VzZWQiKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBDYWxsYmFjayBmb3Igd2hlbiB0aGUgZmllbGQgbG9zZXMgZm9jdXMgKGJsdXJzKS4KICAgICAgICAgKgogICAgICAgICAqIERlZmF1bHQgYmVoYXZpb3IgaXMgZm9yIHRoZSBlbnRpcmUgZmllbGQgdG8gdW4taGlnaGxpZ2h0LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIGUgZG9tIGV2ZW50CiAgICAgICAgICovCiAgICAgICAgb25CbHVyOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHRoaXMuZ2V0RWwoKS5yZW1vdmVDbGFzcygiYWxwYWNhLWZpZWxkLWZvY3VzZWQiKTsKCiAgICAgICAgICAgIC8vIHVwZGF0ZSB0aGUgVUkgdmFsaWRhdGlvbiBzdGF0ZQogICAgICAgICAgICB0aGlzLnJlZnJlc2hWYWxpZGF0aW9uU3RhdGUoKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBDYWxsYmFjayBmb3Igd2hlbiB0aGUgZmllbGQncyB2YWx1ZSBjaGFuZ2VzLgogICAgICAgICAqCiAgICAgICAgICogRGVmYXVsdCBiZWhhdmlvciBpcyB0byB1cGRhdGUgdGhlIGNvbnRyb2wncyB2YWx1ZSBhbmQgbm90aWZ5LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIGUgRXZlbnQuCiAgICAgICAgICovCiAgICAgICAgb25DaGFuZ2U6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgLy8gc3RvcmUgYmFjayBpbnRvIGRhdGEgZWxlbWVudAogICAgICAgICAgICB0aGlzLmRhdGEgPSB0aGlzLmdldFZhbHVlKCk7CiAgICAgICAgICAgIHRoaXMudHJpZ2dlclVwZGF0ZSgpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENhbGxiYWNrIGZvciB3aGVuIHRoZSBtb3VzZSBtb3ZlcyBvdmVyIGEgZmllbGQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gZQogICAgICAgICAqLwogICAgICAgIG9uTW91c2VPdmVyOiBmdW5jdGlvbihlKSB7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENhbGxiYWNrIGZvciB3aGVuIHRoZSBtb3VzZSBtb3ZlcyBvdXQgb2YgdGhlIGZpZWxkLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIGUKICAgICAgICAgKi8KICAgICAgICBvbk1vdXNlT3V0OiBmdW5jdGlvbihlKSB7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEZpbmRzIGEgZmllbGQgY29udHJvbCBieSBpdHMgcGF0aC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoIEZpZWxkIGNvbnRyb2wgcGF0aC4KICAgICAgICAgKiBAcmV0dXJucyB7QWxwYWNhLkZpZWxkfSBGaWVsZCBjb250cm9sIG1hcHBlZCB0byB0aGUgcGF0aC4KICAgICAgICAgKi8KICAgICAgICBnZXRDb250cm9sQnlQYXRoOiBmdW5jdGlvbihwYXRoKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRDb250cm9sID0gdGhpczsKICAgICAgICAgICAgaWYgKHBhdGgpIHsKICAgICAgICAgICAgICAgIHZhciBwYXRoQXJyYXkgPSBwYXRoLnNwbGl0KCcvJyk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhdGhBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmICghQWxwYWNhLmlzVmFsRW1wdHkocGF0aEFycmF5W2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50Q29udHJvbCAmJiBwYXJlbnRDb250cm9sLmNoaWxkcmVuQnlQcm9wZXJ0eUlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL2NoZWNrIHRvIHNlZSBpZiB3ZSBuZWVkIHRvIGFkZCB0aGUgcHJvcGVydGllcyBmaWVsZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudENvbnRyb2wuY2hpbGRyZW5CeVByb3BlcnR5SWRbcGF0aEFycmF5W2ldXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudENvbnRyb2wgPSBwYXJlbnRDb250cm9sLmNoaWxkcmVuQnlQcm9wZXJ0eUlkW3BhdGhBcnJheVtpXV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50Q29udHJvbDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIFV0aWxpdHkgRnVuY3Rpb25zIGZvciBGb3JtIEJ1aWxkZXIKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIGZpZWxkIHR5cGUuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBGaWVsZCB0eXBlLgogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgc2NoZW1hIGRhdGEgdHlwZS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IFNjaGVtYSBkYXRhIHR5cGUuCiAgICAgICAgICovCiAgICAgICAgZ2V0VHlwZTogZnVuY3Rpb24oKSB7CgogICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoKICAgICAgICAvKioKICAgICAgICAgKiBGaW5kcyBpZiB0aGlzIGZpZWxkIGlzIGEgY29udGFpbmVyIG9mIG90aGVyIGZpZWxkcy4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmIGl0IGlzIGEgY29udGFpbmVyLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgaXNDb250YWluZXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyBmaWVsZCB0aXRsZS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IEZpZWxkIHRpdGxlLgogICAgICAgICAqLwogICAgICAgIGdldFRpdGxlOiBmdW5jdGlvbigpIHsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyBmaWVsZCBkZXNjcmlwdGlvbi4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IEZpZWxkIGRlc2NyaXB0aW9uLgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyBKU09OIHNjaGVtYSBvZiB0aGUgc2NoZW1hIHByb3BlcnRpZXMgdGhhdCBhcmUgbWFuYWdlZCBieSB0aGlzIGNsYXNzLgogICAgICAgICAqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBKU09OIHNjaGVtYSBvZiB0aGUgc2NoZW1hIHByb3BlcnRpZXMgdGhhdCBhcmUgbWFuYWdlZCBieSB0aGlzIGNsYXNzLgogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mU2NoZW1hOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHNjaGVtYU9mU2NoZW1hID0gewogICAgICAgICAgICAgICAgInRpdGxlIjogdGhpcy5nZXRUaXRsZSgpLAogICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogdGhpcy5nZXREZXNjcmlwdGlvbigpLAogICAgICAgICAgICAgICAgInR5cGUiOiAib2JqZWN0IiwKICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlRpdGxlIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlNob3J0IGRlc2NyaXB0aW9uIG9mIHRoZSBwcm9wZXJ0eS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJEZXNjcmlwdGlvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJEZXRhaWxlZCBkZXNjcmlwdGlvbiBvZiB0aGUgcHJvcGVydHkuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInJlYWRvbmx5IjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiUmVhZG9ubHkiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiUHJvcGVydHkgd2lsbCBiZSByZWFkb25seSBpZiB0cnVlLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJSZXF1aXJlZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJQcm9wZXJ0eSB2YWx1ZSBtdXN0IGJlIHNldCBpZiB0cnVlLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkRlZmF1bHQiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRGVmYXVsdCB2YWx1ZSBvZiB0aGUgcHJvcGVydHkuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYW55IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInR5cGUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJUeXBlIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkRhdGEgdHlwZSBvZiB0aGUgcHJvcGVydHkuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgInJlYWRvbmx5IjogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJEYXRhIGZvcm1hdCBvZiB0aGUgcHJvcGVydHkuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImRpc2FsbG93IjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRGlzYWxsb3dlZCBWYWx1ZXMiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiTGlzdCBvZiBkaXNhbGxvd2VkIHZhbHVlcyBmb3IgdGhlIHByb3BlcnR5LiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImFycmF5IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImRlcGVuZGVuY2llcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkRlcGVuZGVuY2llcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJMaXN0IG9mIHByb3BlcnR5IGRlcGVuZGVuY2llcy4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJhcnJheSIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmICh0aGlzLmdldFR5cGUgJiYgIUFscGFjYS5pc1ZhbEVtcHR5KHRoaXMuZ2V0VHlwZSgpKSkgewogICAgICAgICAgICAgICAgc2NoZW1hT2ZTY2hlbWEucHJvcGVydGllcy50eXBlWydkZWZhdWx0J10gPSB0aGlzLmdldFR5cGUoKTsKICAgICAgICAgICAgICAgIHNjaGVtYU9mU2NoZW1hLnByb3BlcnRpZXMudHlwZVsnZW51bSddID0gW3RoaXMuZ2V0VHlwZSgpXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2NoZW1hT2ZTY2hlbWE7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyBBbHBhY2Egb3B0aW9ucyBmb3IgdGhlIHNjaGVtYSBwcm9wZXJ0aWVzIHRoYXQgbWFuYWdlZCBieSB0aGlzIGNsYXNzLgogICAgICAgICAqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBBbHBhY2Egb3B0aW9ucyBmb3IgdGhlIHNjaGVtYSBwcm9wZXJ0aWVzIHRoYXQgYXJlIG1hbmFnZWQgYnkgdGhpcyBjbGFzcy4KICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yU2NoZW1hOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogewogICAgICAgICAgICAgICAgICAgICAgICAiaGVscGVyIjogIkZpZWxkIHNob3J0IGRlc2NyaXB0aW9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgImhlbHBlciI6ICJGaWVsZCBkZXRhaWxlZCBkZXNjcmlwdGlvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRleHRhcmVhIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInJlYWRvbmx5IjogewogICAgICAgICAgICAgICAgICAgICAgICAiaGVscGVyIjogIkZpZWxkIHdpbGwgYmUgcmVhZCBvbmx5IGlmIGNoZWNrZWQiLAogICAgICAgICAgICAgICAgICAgICAgICAicmlnaHRMYWJlbCI6ICJUaGlzIGZpZWxkIGlzIHJlYWQtb25seSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogewogICAgICAgICAgICAgICAgICAgICAgICAiaGVscGVyIjogIkZpZWxkIHZhbHVlIG11c3QgYmUgc2V0IGlmIGNoZWNrZWQiLAogICAgICAgICAgICAgICAgICAgICAgICAicmlnaHRMYWJlbCI6ICJUaGlzIGZpZWxkIGlzIHJlcXVpcmVkIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiY2hlY2tib3giCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgImhlbHBlciI6ICJGaWVsZCBkZWZhdWx0IHZhbHVlIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dGFyZWEiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAidHlwZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgImhlbHBlciI6ICJGaWVsZCBkYXRhIHR5cGUiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic2VsZWN0IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRhdGFTb3VyY2UiOiBmdW5jdGlvbihmaWVsZCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBBbHBhY2EuZGVmYXVsdEZvcm1hdEZpZWxkTWFwcGluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkLnNlbGVjdE9wdGlvbnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IGtleSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRleHQiOiBrZXkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJkaXNhbGxvdyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgImhlbHBlciI6ICJEaXNhbGxvd2VkIHZhbHVlcyBmb3IgdGhlIGZpZWxkIiwKICAgICAgICAgICAgICAgICAgICAgICAgIml0ZW1MYWJlbCI6IlZhbHVlIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYXJyYXkiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZGVwZW5kZW5jaWVzIjogewogICAgICAgICAgICAgICAgICAgICAgICAiaGVscGVyIjogIkZpZWxkIERlcGVuZGVuY2llcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJtdWx0aXBsZSI6dHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgInNpemUiOjMsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInNlbGVjdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkYXRhU291cmNlIjogZnVuY3Rpb24gKGZpZWxkLCBjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpZWxkLnBhcmVudCAmJiBmaWVsZC5wYXJlbnQuc2NoZW1hUGFyZW50ICYmIGZpZWxkLnBhcmVudC5zY2hlbWFQYXJlbnQucGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGZpZWxkLnBhcmVudC5zY2hlbWFQYXJlbnQucGFyZW50LmNoaWxkcmVuQnlQcm9wZXJ0eUlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkgIT0gZmllbGQucGFyZW50LnNjaGVtYVBhcmVudC5wcm9wZXJ0eUlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZC5zZWxlY3RPcHRpb25zLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IGtleSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGV4dCI6IGtleQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgSlNPTiBzY2hlbWEgb2YgdGhlIEFscGFjYSBvcHRpb25zIHRoYXQgYXJlIG1hbmFnZWQgYnkgdGhpcyBjbGFzcy4KICAgICAgICAgKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gSlNPTiBzY2hlbWEgb2YgdGhlIEFscGFjYSBvcHRpb25zIHRoYXQgYXJlIG1hbmFnZWQgYnkgdGhpcyBjbGFzcy4KICAgICAgICAgKi8KICAgICAgICBnZXRTY2hlbWFPZk9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgc2NoZW1hT2ZPcHRpb25zID0gewogICAgICAgICAgICAgICAgInRpdGxlIjogIk9wdGlvbnMgZm9yICIgKyB0aGlzLmdldFRpdGxlKCksCiAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiB0aGlzLmdldERlc2NyaXB0aW9uKCkgKyAiIChPcHRpb25zKSIsCiAgICAgICAgICAgICAgICAidHlwZSI6ICJvYmplY3QiLAogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgInJlbmRlckZvcm0iOiB7fSwKICAgICAgICAgICAgICAgICAgICAiZm9ybSI6e30sCiAgICAgICAgICAgICAgICAgICAgImlkIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRmllbGQgSWQiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiVW5pcXVlIGZpZWxkIGlkLiBBdXRvLWdlbmVyYXRlZCBpZiBub3QgcHJvdmlkZWQuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInR5cGUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJGaWVsZCBUeXBlIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkZpZWxkIHR5cGUuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiB0aGlzLmdldEZpZWxkVHlwZSgpLAogICAgICAgICAgICAgICAgICAgICAgICAicmVhZG9ubHkiOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAidmFsaWRhdGUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJWYWxpZGF0aW9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkZpZWxkIHZhbGlkYXRpb24gaXMgcmVxdWlyZWQgaWYgdHJ1ZS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAic2hvd01lc3NhZ2VzIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiU2hvdyBNZXNzYWdlcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJEaXNwbGF5IHZhbGlkYXRpb24gbWVzc2FnZXMgaWYgdHJ1ZS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZGlzYWJsZWQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJEaXNhYmxlZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJGaWVsZCB3aWxsIGJlIGRpc2FibGVkIGlmIHRydWUuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogZmFsc2UKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJyZWFkb25seSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlJlYWRvbmx5IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkZpZWxkIHdpbGwgYmUgcmVhZG9ubHkgaWYgdHJ1ZS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiBmYWxzZQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImhpZGRlbiI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkhpZGRlbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJGaWVsZCB3aWxsIGJlIGhpZGRlbiBpZiB0cnVlLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAibGFiZWwiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJMYWJlbCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJGaWVsZCBsYWJlbC4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiaGVscGVyIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiSGVscGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkZpZWxkIGhlbHAgbWVzc2FnZS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZmllbGRDbGFzcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkNTUyBjbGFzcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJTcGVjaWZpZXMgb25lIG9yIG1vcmUgQ1NTIGNsYXNzZXMgdGhhdCBzaG91bGQgYmUgYXBwbGllZCB0byB0aGUgZG9tIGVsZW1lbnQgZm9yIHRoaXMgZmllbGQgb25jZSBpdCBpcyByZW5kZXJlZC4gIFN1cHBvcnRzIGEgc2luZ2xlIHZhbHVlLCBjb21tYS1kZWxpbWl0ZWQgdmFsdWVzLCBzcGFjZS1kZWxpbWl0ZWQgdmFsdWVzIG9yIHZhbHVlcyBwYXNzZWQgaW4gYXMgYW4gYXJyYXkuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImhpZGVJbml0VmFsaWRhdGlvbkVycm9yIiA6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkhpZGUgSW5pdGlhbCBWYWxpZGF0aW9uIEVycm9ycyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiIgOiAiSGlkZSBpbml0aWFsIHZhbGlkYXRpb24gZXJyb3JzIGlmIHRydWUuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogZmFsc2UKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJmb2N1cyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZvY3VzIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIklmIHRydWUsIHRoZSBpbml0aWFsIGZvY3VzIGZvciB0aGUgZm9ybSB3aWxsIGJlIHNldCB0byB0aGUgZmlyc3QgY2hpbGQgZWxlbWVudCAodXN1YWxseSB0aGUgZmlyc3QgZmllbGQgaW4gdGhlIGZvcm0pLiAgSWYgYSBmaWVsZCBuYW1lIG9yIHBhdGggaXMgcHJvdmlkZWQsIHRoZW4gdGhlIHNwZWNpZmllZCBjaGlsZCBmaWVsZCB3aWxsIHJlY2VpdmUgZm9jdXMuICBGb3IgZXhhbXBsZSwgeW91IG1pZ2h0IHNldCBmb2N1cyB0byAnbmFtZScgKHNlbGVjdGluZyB0aGUgJ25hbWUnIGZpZWxkKSBvciB5b3UgbWlnaHQgc2V0IGl0IHRvICdjbGllbnQvbmFtZScgd2hpY2ggcGlja3MgdGhlICduYW1lJyBmaWVsZCBvbiB0aGUgJ2NsaWVudCcgb2JqZWN0LiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAib3B0aW9uTGFiZWxzIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRW51bWVyYXRlZCBWYWx1ZSBMYWJlbHMiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiQW4gYXJyYXkgb2Ygc3RyaW5nIGxhYmVscyBmb3IgaXRlbXMgaW4gdGhlIGVudW0gYXJyYXkiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJhcnJheSIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmICh0aGlzLmlzVG9wTGV2ZWwoKSkgewogICAgICAgICAgICAgICAgc2NoZW1hT2ZPcHRpb25zLnByb3BlcnRpZXMucmVuZGVyRm9ybSA9IHsKICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiUmVuZGVyIEZvcm0iLAogICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJSZW5kZXIgYSBGT1JNIHRhZyBhcyB0aGUgY29udGFpbmVyIGZvciB0aGUgcmVzdCBvZiBmaWVsZHMgaWYgdHJ1ZS4iLAogICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogZmFsc2UKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgc2NoZW1hT2ZPcHRpb25zLnByb3BlcnRpZXMuZm9ybSA9IHsKICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRm9ybSIsCiAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIk9wdGlvbnMgZm9yIHJlbmRlcmluZyB0aGUgRk9STSB0YWcuIiwKICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJvYmplY3QiLAogICAgICAgICAgICAgICAgICAgICJkZXBlbmRlbmNpZXMiIDogInJlbmRlckZvcm0iLAogICAgICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICAgICAiYXR0cmlidXRlcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJGb3JtIEF0dHJpYnV0ZXMiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkxpc3Qgb2YgYXR0cmlidXRlcyBmb3IgdGhlIEZPUk0gdGFnLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJvYmplY3QiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImlkIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiSWQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiVW5pcXVlIGZvcm0gaWQuIEF1dG8tZ2VuZXJhdGVkIGlmIG5vdCBwcm92aWRlZC4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiYWN0aW9uIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiQWN0aW9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkZvcm0gc3VibWlzc2lvbiBlbmRwb2ludCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZXRob2QiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJNZXRob2QiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRm9ybSBzdWJtaXNzaW9uIG1ldGhvZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJlbnVtIjpbInBvc3QiLCJnZXQiXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCgkJCQkicnVieXJhaWxzIjogewoJCQkJICAgICJ0aXRsZSI6ICJSdWJ5IE9uIFJhaWxzIiwKCQkJCSAgICAiZGVzY3JpcHRpb24iOiAiUnVieSBvbiBSYWlscyBOYW1lIFN0YW5kYXJkIiwKCQkJCSAgICAiZW51bSI6IFsidHJ1ZSIsICJmYWxzZSJdLAoJCQkJICAgICJ0eXBlIjogInN0cmluZyIKCQkJCX0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJOYW1lIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkZvcm0gbmFtZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJmb2N1cyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZvY3VzIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkZvY3VzIFNldHRpbmciLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJhbnkiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAiYnV0dG9ucyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJGb3JtIEJ1dHRvbnMiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkNvbmZpZ3VyYXRpb24gZm9yIGZvcm0tYm91bmQgYnV0dG9ucyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJvYmplY3QiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInN1Ym1pdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAib2JqZWN0IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlN1Ym1pdCBCdXR0b24iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInJlc2V0IjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJvYmplY3QiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiUmVzZXQgYnV0dG9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogZmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICJ0b2dnbGVTdWJtaXRWYWxpZFN0YXRlIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlRvZ2dsZSBTdWJtaXQgVmFsaWQgU3RhdGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlRvZ2dsZSB0aGUgdmFsaWRpdHkgc3RhdGUgb2YgdGhlIFN1Ym1pdCBidXR0b24iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlIHNjaGVtYU9mT3B0aW9ucy5wcm9wZXJ0aWVzLnJlbmRlckZvcm07CiAgICAgICAgICAgICAgICBkZWxldGUgc2NoZW1hT2ZPcHRpb25zLnByb3BlcnRpZXMuZm9ybTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHNjaGVtYU9mT3B0aW9uczsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIEFscGFjYSBvcHRpb25zIGZvciB0aGUgQWxwYWNhIG9wdGlvbnMgdGhhdCBhcmUgbWFuYWdlZCBieSB0aGlzIGNsYXNzLgogICAgICAgICAqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBBbHBhY2Egb3B0aW9ucyBmb3IgdGhlIEFscGFjYSBvcHRpb25zIHRoYXQgYXJlIG1hbmFnZWQgYnkgdGhpcyBjbGFzcy4KICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBvcHRpb25zRm9yT3B0aW9ucyA9IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogIm9iamVjdCIsCiAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICJpZCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJyZWFkb25seSI6IHRydWUKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJ0eXBlIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInZhbGlkYXRlIjogewogICAgICAgICAgICAgICAgICAgICAgICAicmlnaHRMYWJlbCI6ICJFbmZvcmNlIHZhbGlkYXRpb24iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJzaG93TWVzc2FnZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJyaWdodExhYmVsIjoiU2hvdyB2YWxpZGF0aW9uIG1lc3NhZ2VzIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiY2hlY2tib3giCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZGlzYWJsZWQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJyaWdodExhYmVsIjoiRGlzYWJsZSB0aGlzIGZpZWxkIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiY2hlY2tib3giCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiaGlkZGVuIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJyaWdodExhYmVsIjogIkhpZGUgdGhpcyBmaWVsZCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJsYWJlbCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJoZWxwZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRleHRhcmVhIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImZpZWxkQ2xhc3MiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRleHQiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiaGlkZUluaXRWYWxpZGF0aW9uRXJyb3IiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJyaWdodExhYmVsIjogIkhpZGUgaW5pdGlhbCB2YWxpZGF0aW9uIGVycm9ycyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImZvY3VzIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJyaWdodExhYmVsIjogIkF1dG8tZm9jdXMgZmlyc3QgY2hpbGQgZmllbGQiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAib3B0aW9uTGFiZWxzIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJhcnJheSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJpdGVtcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKHRoaXMuaXNUb3BMZXZlbCgpKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zRm9yT3B0aW9ucy5maWVsZHMucmVuZGVyRm9ybSA9IHsKICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIsCiAgICAgICAgICAgICAgICAgICAgInJpZ2h0TGFiZWwiOiAiWWVzIgogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIG9wdGlvbnNGb3JPcHRpb25zLmZpZWxkcy5mb3JtID0gewogICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm9iamVjdCIsCiAgICAgICAgICAgICAgICAgICAgImRlcGVuZGVuY2llcyIgOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJyZW5kZXJGb3JtIiA6IHRydWUKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJhdHRyaWJ1dGVzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAib2JqZWN0IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImlkIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInJlYWRvbmx5IjogdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImFjdGlvbiI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZXRob2QiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInNlbGVjdCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJuYW1lIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBvcHRpb25zRm9yT3B0aW9uczsKICAgICAgICB9Ly9fX0VORF9PRl9CVUlMREVSX0hFTFBFUlMKICAgIH0pOwoKICAgIC8vIFJlZ2lzdGVycyBhZGRpdGlvbmFsIG1lc3NhZ2VzCiAgICBBbHBhY2EucmVnaXN0ZXJNZXNzYWdlcyh7CiAgICAgICAgImRpc2FsbG93VmFsdWUiOiAiezB9IGFyZSBkaXNhbGxvd2VkIHZhbHVlcy4iLAogICAgICAgICJub3RPcHRpb25hbCI6ICJUaGlzIGZpZWxkIGlzIG5vdCBvcHRpb25hbC4iCiAgICB9KTsKCn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5Db250cm9sRmllbGQgPSBBbHBhY2EuRmllbGQuZXh0ZW5kKAogICAgLyoqCiAgICAgKiBAbGVuZHMgQWxwYWNhLkNvbnRyb2xGaWVsZC5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5GaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIEFic3RyYWN0IGJhc2UgY2xhc3MgZm9yIEFscGFjYSBub24tY29udGFpbmVyIEZpZWxkcy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CgogICAgICAgICAgICAvLyB0YWcgdG8gZmxhZyB0aGF0IHRoaXMgaXMgYSBjb250cm9sIGZpZWxkCiAgICAgICAgICAgIC8vIHVzZWQgYnkgRmllbGQgYmFzZSBjbGFzcyB0byBkZXRlcm1pbmUgd2hldGhlciB0byB0cmF2ZXJzZSBpbnRvIHRoaXMgZHVyaW5nIGEgZGlzcGxheS1vbmx5IHJlbmRlcmluZwogICAgICAgICAgICB0aGlzLmlzQ29udHJvbEZpZWxkID0gdHJ1ZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNzZXREZWZhdWx0CiAgICAgICAgICovCiAgICAgICAgc2V0RGVmYXVsdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBkZWZhdWx0RGF0YSA9IEFscGFjYS5pc0VtcHR5KHRoaXMuc2NoZW1hWydkZWZhdWx0J10pID8gIiIgOiB0aGlzLnNjaGVtYVsnZGVmYXVsdCddOwogICAgICAgICAgICB0aGlzLnNldFZhbHVlKGRlZmF1bHREYXRhKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNyZW5kZXJGaWVsZAogICAgICAgICAqLwogICAgICAgIHJlbmRlckZpZWxkOiBmdW5jdGlvbihvblN1Y2Nlc3MpIHsKICAgICAgICAgICAgaWYgKG9uU3VjY2VzcykgewogICAgICAgICAgICAgICAgb25TdWNjZXNzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBJbmplY3RzIEZpZWxkIEVsZW1lbnQgaW50byBpdHMgY29udGFpbmVyLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGVsZW1lbnQgRmllbGQgZWxlbWVudCB0byBiZSBpbmplY3RlZC4KICAgICAgICAgKi8KICAgICAgICBpbmplY3RGaWVsZDogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICAvLyBmaW5kIG91dCB0aGUgZmllbGQgY29udGFpbmVyCiAgICAgICAgICAgIHZhciBjb250YWluZXJFbGVtID0gJCgnLmFscGFjYS1jb250cm9sZmllbGQtY29udGFpbmVyJywgdGhpcy5vdXRlckVsKTsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lckVsZW0ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkQ29udGFpbmVyID0gY29udGFpbmVyRWxlbTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZmllbGRDb250YWluZXIgPSB0aGlzLm91dGVyRWw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gbm93IGZpZ3VyZSBvdXQgd2hlcmUgZXhhY3RseSB3ZSB3YW50IHRvIGluc2VydCBpdAogICAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9ICQoJy5hbHBhY2EtZmllbGQtY29udGFpbmVyLWZpZWxkJywgdGhpcy5maWVsZENvbnRhaW5lcik7CiAgICAgICAgICAgIGlmIChwYXJlbnROb2RlLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGlmIChwYXJlbnROb2RlLmF0dHIoJ2RhdGEtcmVwbGFjZScpID09ICd0cnVlJykgewogICAgICAgICAgICAgICAgICAgIHBhcmVudE5vZGUucmVwbGFjZVdpdGgoZWxlbWVudCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kVG8ocGFyZW50Tm9kZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5maWVsZENvbnRhaW5lci5hdHRyKCdkYXRhLXJlcGxhY2UnKSA9PSAndHJ1ZScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZpZWxkQ29udGFpbmVyLnJlcGxhY2VXaXRoKGVsZW1lbnQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnByZXBlbmRUbyh0aGlzLmZpZWxkQ29udGFpbmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI3Bvc3RSZW5kZXIKICAgICAgICAgKi8KICAgICAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbihjYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHZhciBsYWJlbERpdiA9ICQoJy5hbHBhY2EtY29udHJvbGZpZWxkLWxhYmVsJywgdGhpcy5vdXRlckVsKTsKICAgICAgICAgICAgaWYgKGxhYmVsRGl2Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgdGhpcy5sYWJlbERpdiA9IGxhYmVsRGl2OwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgaGVscGVyRGl2ID0gJCgnLmFscGFjYS1jb250cm9sZmllbGQtaGVscGVyJywgdGhpcy5vdXRlckVsKTsKICAgICAgICAgICAgaWYgKGhlbHBlckRpdi5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGVscGVyRGl2ID0gaGVscGVyRGl2OwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgLy8gYWRkIGFkZGl0aW9uYWwgY2xhc3NlcwogICAgICAgICAgICAgICAgc2VsZi5vdXRlckVsLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkJyk7CgogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlIGFnYWluc3QgZW51bSBwcm9wZXJ0eS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmIHRoZSBlbGVtZW50IHZhbHVlIGlzIHBhcnQgb2YgdGhlIGVudW0gbGlzdCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZUVudW06IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5zY2hlbWFbImVudW0iXSkgewogICAgICAgICAgICAgICAgdmFyIHZhbCA9IHRoaXMuZGF0YTsKICAgICAgICAgICAgICAgIC8qdGhpcy5nZXRWYWx1ZSgpOyovCiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuc2NoZW1hLnJlcXVpcmVkICYmIEFscGFjYS5pc1ZhbEVtcHR5KHZhbCkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgkLmluQXJyYXkodmFsLCB0aGlzLnNjaGVtYVsiZW51bSJdKSA+IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjaGFuZGxlVmFsaWRhdGUKICAgICAgICAgKi8KICAgICAgICBoYW5kbGVWYWxpZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBiYXNlU3RhdHVzID0gdGhpcy5iYXNlKCk7CgogICAgICAgICAgICB2YXIgdmFsSW5mbyA9IHRoaXMudmFsaWRhdGlvbjsKCiAgICAgICAgICAgIHZhciBzdGF0dXMgPSB0aGlzLl92YWxpZGF0ZUVudW0oKTsKICAgICAgICAgICAgdmFsSW5mb1siaW52YWxpZFZhbHVlT2ZFbnVtIl0gPSB7CiAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHN0YXR1cyA/ICIiIDogQWxwYWNhLnN1YnN0aXR1dGVUb2tlbnModGhpcy52aWV3LmdldE1lc3NhZ2UoImludmFsaWRWYWx1ZU9mRW51bSIpLCBbdGhpcy5zY2hlbWFbImVudW0iXS5qb2luKCcsJyldKSwKICAgICAgICAgICAgICAgICJzdGF0dXMiOiBzdGF0dXMKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBiYXNlU3RhdHVzICYmIHZhbEluZm9bImludmFsaWRWYWx1ZU9mRW51bSJdWyJzdGF0dXMiXTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNpbml0RXZlbnRzCiAgICAgICAgICovCiAgICAgICAgaW5pdEV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLmtleXByZXNzKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5vbktleVByZXNzLmNhbGwoX3RoaXMsIGUpOwogICAgICAgICAgICAgICAgICAgIF90aGlzLnRyaWdnZXIoImtleXByZXNzIiwgZSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLmtleXVwKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5vbktleVVwLmNhbGwoX3RoaXMsIGUpOwogICAgICAgICAgICAgICAgICAgIF90aGlzLnRyaWdnZXIoImtleXVwIiwgZSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLmtleWRvd24oZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIF90aGlzLm9uS2V5RG93bi5jYWxsKF90aGlzLCBlKTsKICAgICAgICAgICAgICAgICAgICBfdGhpcy50cmlnZ2VyKCJrZXlkb3duIiwgZSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLmNsaWNrKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5vbkNsaWNrLmNhbGwoX3RoaXMsIGUpOwogICAgICAgICAgICAgICAgICAgIF90aGlzLnRyaWdnZXIoImNsaWNrIiwgZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBDYWxsYmFjayBmb3Igd2hlbiBhIGtleSBwcmVzcyBldmVudCBpcyByZWNlaXZlZCBmb3IgdGhlIGZpZWxkIGNvbnRyb2wuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZSBrZXlwcmVzcyBldmVudAogICAgICAgICAqLwogICAgICAgIG9uS2V5UHJlc3M6IGZ1bmN0aW9uKGUpIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIC8vIGlmIHRoZSBmaWVsZCBpcyBjdXJyZW50bHkgaW52YWxpZCwgdGhlbiB3ZSBwcm92aWRlIGVhcmx5IGZlZWRiYWNrIHRvIHRoZSB1c2VyIGFzIHRvIHdoZW4gdGhleSBlbnRlcgogICAgICAgICAgICAvLyBpZiB0aGUgZmllbGQgd2FzIHZhbGlkLCB3ZSBkb24ndCByZW5kZXIgaW52YWxpZGF0aW9uIGZlZWRiYWNrIHVudGlsIHRoZXkgYmx1ciB0aGUgZmllbGQKCiAgICAgICAgICAgIC8vIHdhcyB0aGUgY29udHJvbCB2YWxpZCBwcmV2aW91c2x5PwogICAgICAgICAgICB2YXIgd2FzVmFsaWQgPSB0aGlzLmlzVmFsaWQoKTsKICAgICAgICAgICAgaWYgKCF3YXNWYWxpZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8KICAgICAgICAgICAgICAgIC8vIHdlIHVzZSBhIHRpbWVvdXQgYmVjYXVzZSBhdCB0aGlzIGV4YWN0IG1vbWVudCwgdGhlIHZhbHVlIG9mIHRoZSBjb250cm9sIGlzIHN0aWxsIHRoZSBvbGQgdmFsdWUKICAgICAgICAgICAgICAgIC8vIGpRdWVyeSByYWlzZXMgdGhlIGtleXByZXNzIGV2ZW50IGFoZWFkIG9mIHRoZSBpbnB1dCByZWNlaXZpbmcgdGhlIG5ldyBkYXRhIHdoaWNoIHdvdWxkIGluY29ycG9yYXRlCiAgICAgICAgICAgICAgICAvLyB0aGUga2V5IHRoYXQgd2FzIHByZXNzZWQKICAgICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgICAvLyB0aGlzIHRpbWVvdXQgcHJvdmlkZXMgdGhlIGJyb3dzZXIgd2l0aCBlbm91Z2ggdGltZSB0byBwbHVnIHRoZSB2YWx1ZSBpbnRvIHRoZSBpbnB1dCBjb250cm9sCiAgICAgICAgICAgICAgICAvLyB3aGljaCB0aGUgdmFsaWRhdGlvbiBsb2dpYyB1c2VzIHRvIGRldGVybWluZSB3aGV0aGVyIHRoZSBjb250cm9sIGlzIG5vdyBpbiBhIHZhbGlkIHN0YXRlCiAgICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5yZWZyZXNoVmFsaWRhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgICB9LCA1MCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ2FsbGJhY2sgZm9yIHdoZW4gYSBrZXkgZG93biBldmVudCBpcyByZWNlaXZlZCBmb3IgdGhlIGZpZWxkIGNvbnRyb2wuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZSBrZXlkb3duIGV2ZW50CiAgICAgICAgICovCiAgICAgICAgb25LZXlEb3duOiBmdW5jdGlvbihlKSB7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENhbGxiYWNrIGZvciB3aGVuIGEga2V5IHVwIGV2ZW50IGlzIHJlY2VpdmVkIGZvciB0aGUgZmllbGQgY29udHJvbC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBlIGtleXVwIGV2ZW50CiAgICAgICAgICovCiAgICAgICAgb25LZXlVcDogZnVuY3Rpb24oZSkgewoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBIYW5kbGVyIGZvciBjbGljayBldmVudC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBlIENsaWNrIGV2ZW50LgogICAgICAgICAqLwogICAgICAgIG9uQ2xpY2s6IGZ1bmN0aW9uKGUpIHsKICAgICAgICB9LC8vX19CVUlMREVSX0hFTFBFUlMKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRTY2hlbWFPZlNjaGVtYQogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mU2NoZW1hOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgImVudW0iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJFbnVtZXJhdGVkIFZhbHVlcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJMaXN0IG9mIHNwZWNpZmljIHZhbHVlcyBmb3IgdGhpcyBwcm9wZXJ0eSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImFycmF5IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRPcHRpb25zRm9yU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0ZvclNjaGVtYTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgImVudW0iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJpdGVtTGFiZWwiOiJWYWx1ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImFycmF5IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRTY2hlbWFPZk9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRTY2hlbWFPZk9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAibmFtZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZpZWxkIE5hbWUiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRmllbGQgTmFtZS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldE9wdGlvbnNGb3JPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0Zvck9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICJuYW1lIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKCiAgICAvLyBSZWdpc3RlcnMgYWRkaXRpb25hbCBtZXNzYWdlcwogICAgQWxwYWNhLnJlZ2lzdGVyTWVzc2FnZXMoewogICAgICAgICJpbnZhbGlkVmFsdWVPZkVudW0iOiAiVGhpcyBmaWVsZCBzaG91bGQgaGF2ZSBvbmUgb2YgdGhlIHZhbHVlcyBpbiB7MH0uIgogICAgfSk7Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuQ29udGFpbmVyRmllbGQgPSBBbHBhY2EuRmllbGQuZXh0ZW5kKAoKICAgICAgICAvKioKICAgICAgICAgKiBAbGVuZHMgQWxwYWNhLkNvbnRhaW5lckZpZWxkLnByb3RvdHlwZQogICAgICAgICAqLwogICAgICAgIHsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuRmllbGQKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGNsYXNzIEFic3RyYWN0IGNvbnRhaW5lciBmaWVsZCBmb3IgcGFyZW50aW5nIG9mIGNoaWxkIGZpZWxkcy4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQ3VzdG9tIGZpZWxkIGltcGxlbWVudGF0aW9uIHNob3VsZCBleHRlbmQgdGhpcyBpZiB0aGV5IGludGVuZCB0byBiZSBjb250YWluZXJzIG9mIHN1Yi1jb250cm9scyAtCiAgICAgICAgICAgICAqIGV4YW1wbGVzIGluY2x1ZGUgdHJlZSBjb250cm9scywgbGlzdCBjb250cm9scyBhbmQgbW9yZS4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNzZXR1cAogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGhpcy5iYXNlKCk7CgogICAgICAgICAgICAgICAgdmFyIGNvbGxhcHNpYmxlID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc0VtcHR5KHRoaXMudmlldy5jb2xsYXBzaWJsZSkpIHsKICAgICAgICAgICAgICAgICAgICBjb2xsYXBzaWJsZSA9IHRoaXMudmlldy5jb2xsYXBzaWJsZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc0VtcHR5KHRoaXMub3B0aW9ucy5jb2xsYXBzaWJsZSkpIHsKICAgICAgICAgICAgICAgICAgICBjb2xsYXBzaWJsZSA9IHRoaXMub3B0aW9ucy5jb2xsYXBzaWJsZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuY29sbGFwc2libGUgPSBjb2xsYXBzaWJsZTsKCiAgICAgICAgICAgICAgICB2YXIgbGVnZW5kU3R5bGUgPSAiYnV0dG9uIjsKCiAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc0VtcHR5KHRoaXMudmlldy5sZWdlbmRTdHlsZSkpIHsKICAgICAgICAgICAgICAgICAgICBsZWdlbmRTdHlsZSA9IHRoaXMudmlldy5sZWdlbmRTdHlsZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc0VtcHR5KHRoaXMub3B0aW9ucy5sZWdlbmRTdHlsZSkpIHsKICAgICAgICAgICAgICAgICAgICBsZWdlbmRTdHlsZSA9IHRoaXMub3B0aW9ucy5sZWdlbmRTdHlsZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMubGVnZW5kU3R5bGUgPSBsZWdlbmRTdHlsZTsKCiAgICAgICAgICAgICAgICAvL0xhenkgbG9hZGluZwogICAgICAgICAgICAgICAgdGhpcy5sYXp5TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eSh0aGlzLm9wdGlvbnMubGF6eUxvYWRpbmcpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sYXp5TG9hZGluZyA9IHRoaXMub3B0aW9ucy5sYXp5TG9hZGluZzsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5sYXp5TG9hZGluZykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuY29sbGFwc2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy9kZWxldGUgdGhpcy5vcHRpb25zLmxhenlMb2FkaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gaG9sZGVycyBvZiByZWZlcmVuY2VzIHRvIGNoaWxkcmVuCiAgICAgICAgICAgICAgICB0aGlzLmNoaWxkcmVuID0gW107CiAgICAgICAgICAgICAgICB0aGlzLmNoaWxkcmVuQnlJZCA9IFtdOwogICAgICAgICAgICAgICAgdGhpcy5jaGlsZHJlbkJ5UHJvcGVydHlJZCA9IFtdOwogICAgICAgICAgICAgICAgLy8gc3R5bGUgaWNvbnMKICAgICAgICAgICAgICAgIHRoaXMuZXhwYW5kZWRJY29uID0gIiI7CiAgICAgICAgICAgICAgICB0aGlzLmNvbGxhcHNlZEljb24gPSAiIjsKICAgICAgICAgICAgICAgIHRoaXMuY29tbW9uSWNvbiA9ICIiOwogICAgICAgICAgICAgICAgdGhpcy5hZGRJY29uID0gIiI7CiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUljb24gPSAiIjsKICAgICAgICAgICAgICAgIHRoaXMudXBJY29uID0gIiI7CiAgICAgICAgICAgICAgICB0aGlzLmRvd25JY29uID0gIiI7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aWV3LnN0eWxlICYmIEFscGFjYS5zdHlsZUluamVjdGlvbnNbdGhpcy52aWV3LnN0eWxlXSkgewogICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2Euc3R5bGVJbmplY3Rpb25zW3RoaXMudmlldy5zdHlsZV1bImNvbW1vbkljb24iXSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbW1vbkljb24gPSBBbHBhY2Euc3R5bGVJbmplY3Rpb25zW3RoaXMudmlldy5zdHlsZV1bImNvbW1vbkljb24iXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKEFscGFjYS5zdHlsZUluamVjdGlvbnNbdGhpcy52aWV3LnN0eWxlXVsiY29udGFpbmVyRXhwYW5kZWRJY29uIl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5leHBhbmRlZEljb24gPSBBbHBhY2Euc3R5bGVJbmplY3Rpb25zW3RoaXMudmlldy5zdHlsZV1bImNvbnRhaW5lckV4cGFuZGVkSWNvbiJdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLnN0eWxlSW5qZWN0aW9uc1t0aGlzLnZpZXcuc3R5bGVdWyJjb250YWluZXJDb2xsYXBzZWRJY29uIl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xsYXBzZWRJY29uID0gQWxwYWNhLnN0eWxlSW5qZWN0aW9uc1t0aGlzLnZpZXcuc3R5bGVdWyJjb250YWluZXJDb2xsYXBzZWRJY29uIl07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2Euc3R5bGVJbmplY3Rpb25zW3RoaXMudmlldy5zdHlsZV1bImJ1dHRvbkJlYXV0aWZpZXIiXSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmJ1dHRvbkJlYXV0aWZpZXIgPSBBbHBhY2Euc3R5bGVJbmplY3Rpb25zW3RoaXMudmlldy5zdHlsZV1bImJ1dHRvbkJlYXV0aWZpZXIiXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKEFscGFjYS5zdHlsZUluamVjdGlvbnNbdGhpcy52aWV3LnN0eWxlXVsiYWRkSWNvbiJdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkSWNvbiA9IEFscGFjYS5zdHlsZUluamVjdGlvbnNbdGhpcy52aWV3LnN0eWxlXVsiYWRkSWNvbiJdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLnN0eWxlSW5qZWN0aW9uc1t0aGlzLnZpZXcuc3R5bGVdWyJyZW1vdmVJY29uIl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVJY29uID0gQWxwYWNhLnN0eWxlSW5qZWN0aW9uc1t0aGlzLnZpZXcuc3R5bGVdWyJyZW1vdmVJY29uIl07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2Euc3R5bGVJbmplY3Rpb25zW3RoaXMudmlldy5zdHlsZV1bInVwSWNvbiJdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXBJY29uID0gQWxwYWNhLnN0eWxlSW5qZWN0aW9uc1t0aGlzLnZpZXcuc3R5bGVdWyJ1cEljb24iXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKEFscGFjYS5zdHlsZUluamVjdGlvbnNbdGhpcy52aWV3LnN0eWxlXVsiZG93bkljb24iXSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRvd25JY29uID0gQWxwYWNhLnN0eWxlSW5qZWN0aW9uc1t0aGlzLnZpZXcuc3R5bGVdWyJkb3duSWNvbiJdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXREZWZhdWx0RmllbGRUZW1wbGF0ZUlkCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBnZXREZWZhdWx0RmllbGRUZW1wbGF0ZUlkIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuICJmaWVsZFNldCI7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjc2V0RGVmYXVsdFRlbXBsYXRlRGVzY3JpcHRvcgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc2V0RGVmYXVsdFRlbXBsYXRlRGVzY3JpcHRvcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJhc2UoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBIZWxwZXIgbWV0aG9kIHRvIGFkZCBjaGlsZCBmaWVsZC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29udHJvbH0gY2hpbGQgQ2hpbGQgZmllbGQgdG8gYmUgYWRkZWQuCiAgICAgICAgICAgICAqIEBwYXJhbSB7SW50ZWdlcn0gaW5kZXggSW5kZXggb2YgdGhlIG5ldyBjaGlsZC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGFkZENoaWxkOiBmdW5jdGlvbihjaGlsZCwgaW5kZXgpIHsKICAgICAgICAgICAgICAgIGlmICghQWxwYWNhLmlzRW1wdHkoaW5kZXgpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGlsZHJlbi5zcGxpY2UoaW5kZXgsIDAsIGNoaWxkKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGlsZHJlbi5wdXNoKGNoaWxkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuY2hpbGRyZW5CeUlkW2NoaWxkLmdldElkKCldID0gY2hpbGQ7CiAgICAgICAgICAgICAgICBpZiAoY2hpbGQucHJvcGVydHlJZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2hpbGRyZW5CeVByb3BlcnR5SWRbY2hpbGQucHJvcGVydHlJZF0gPSBjaGlsZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoaWxkLnBhcmVudCA9IHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjaW5pdEV2ZW50cwogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaW5pdEV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgICAgIC8vIGlmIGNvbGxhcHNpYmxlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5sYWJlbERpdikgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuY29sbGFwc2libGUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGFiZWxEaXYuYWRkQ2xhc3MoImxlZ2VuZC1leHBhbmRlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZpZWxkU2V0RGl2LmFkZENsYXNzKCJmaWVsZHNldC1leHBhbmRlZCIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGluaXRJY29uID0gdGhpcy5leHBhbmRlZEljb247CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc0VtcHR5KHRoaXMub3B0aW9ucy5jb2xsYXBzZWQpICYmIHRoaXMub3B0aW9ucy5jb2xsYXBzZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluaXRJY29uID0gdGhpcy5jb2xsYXBzZWRJY29uOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sYWJlbERpdi5uZXh0QWxsKCIuYWxwYWNhLWZpZWxkc2V0LWhlbHBlciIpLnNsaWRlVG9nZ2xlKDUwMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxhYmVsRGl2Lm5leHRBbGwoIi5hbHBhY2EtZmllbGRzZXQtaXRlbXMtY29udGFpbmVyIikuc2xpZGVUb2dnbGUoNTAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGFiZWxEaXYubmV4dEFsbCgiLmFscGFjYS1maWVsZHNldC1hcnJheS10b29sYmFyIikuc2xpZGVUb2dnbGUoNTAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGRTZXREaXYudG9nZ2xlQ2xhc3MoImZpZWxkc2V0LWV4cGFuZGVkIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZpZWxkU2V0RGl2LnRvZ2dsZUNsYXNzKCJmaWVsZHNldC1jb2xsYXBzZWQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGFiZWxEaXYudG9nZ2xlQ2xhc3MoImxlZ2VuZC1leHBhbmRlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sYWJlbERpdi50b2dnbGVDbGFzcygibGVnZW5kLWNvbGxhcHNlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxlZ2VuZFN0eWxlID09ICdsaW5rJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnPHNwYW4gY2xhc3M9IicgKyB0aGlzLmNvbW1vbkljb24gKyAiICIgKyBpbml0SWNvbiArICcgYWxwYWNhLWZpZWxkc2V0LWxlZ2VuZC1saW5rIj48L3NwYW4+JykucHJlcGVuZFRvKHRoaXMubGFiZWxEaXYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sYWJlbERpdi5jbGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5maWVsZFNldERpdi50b2dnbGVDbGFzcygiZmllbGRzZXQtY29sbGFwc2VkIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuZmllbGRTZXREaXYudG9nZ2xlQ2xhc3MoImZpZWxkc2V0LWV4cGFuZGVkIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS50b2dnbGVDbGFzcygibGVnZW5kLWNvbGxhcHNlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykudG9nZ2xlQ2xhc3MoImxlZ2VuZC1leHBhbmRlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJy5hbHBhY2EtZmllbGRzZXQtbGVnZW5kLWxpbmsnLCB0aGlzKS50b2dnbGVDbGFzcyhfdGhpcy5jb2xsYXBzZWRJY29uKS50b2dnbGVDbGFzcyhfdGhpcy5leHBhbmRlZEljb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykubmV4dEFsbCgiLmFscGFjYS1maWVsZHNldC1oZWxwZXIiKS5zbGlkZVRvZ2dsZSg1MDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykubmV4dEFsbCgiLmFscGFjYS1maWVsZHNldC1pdGVtcy1jb250YWluZXIiKS5zbGlkZVRvZ2dsZSg1MDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykubmV4dEFsbCgiLmFscGFjYS1maWVsZHNldC1hcnJheS10b29sYmFyIikuc2xpZGVUb2dnbGUoNTAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxlZ2VuZFN0eWxlID09ICdidXR0b24nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5idXR0b25CZWF1dGlmaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5idXR0b25CZWF1dGlmaWVyLmNhbGwodGhpcywgdGhpcy5sYWJlbERpdiwgaW5pdEljb24sIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGFiZWxEaXYuY2xpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuZmllbGRTZXREaXYudG9nZ2xlQ2xhc3MoImZpZWxkc2V0LWNvbGxhcHNlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmZpZWxkU2V0RGl2LnRvZ2dsZUNsYXNzKCJmaWVsZHNldC1leHBhbmRlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykudG9nZ2xlQ2xhc3MoImxlZ2VuZC1jb2xsYXBzZWQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLnRvZ2dsZUNsYXNzKCJsZWdlbmQtZXhwYW5kZWQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcuYWxwYWNhLWZpZWxkc2V0LWxlZ2VuZC1idXR0b24nLCB0aGlzKS50b2dnbGVDbGFzcyhfdGhpcy5jb2xsYXBzZWRJY29uKS50b2dnbGVDbGFzcyhfdGhpcy5leHBhbmRlZEljb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykubmV4dEFsbCgiLmFscGFjYS1maWVsZHNldC1oZWxwZXIiKS5zbGlkZVRvZ2dsZSg1MDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykubmV4dEFsbCgiLmFscGFjYS1maWVsZHNldC1pdGVtcy1jb250YWluZXIiKS5zbGlkZVRvZ2dsZSg1MDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykubmV4dEFsbCgiLmFscGFjYS1maWVsZHNldC1hcnJheS10b29sYmFyIikuc2xpZGVUb2dnbGUoNTAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIENsZWFycyB0aGUgZmllbGQgYW5kIHJlc2V0cyB0aGUgZmllbGQgdG8gaXRzIG9yaWdpbmFsIHZhbHVlLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0gc3RvcFVwZGF0ZVRyaWdnZXIgSWYgZmFsc2UsIHRyaWdnZXJzIHRoZSB1cGRhdGUgZXZlbnQgb2YgdGhpcyBldmVudC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGNsZWFyOiBmdW5jdGlvbihzdG9wVXBkYXRlVHJpZ2dlcikgewogICAgICAgICAgICAgICAgLy8gY2xlYXIgYWxsIHRoZSBraWRkaWVzCiAgICAgICAgICAgICAgICBBbHBhY2EuZWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNsZWFyKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIHRyaWdnZXIgdXBkYXRlIGFsbCBhdCBvbmNlCiAgICAgICAgICAgICAgICBpZiAoIXN0b3BVcGRhdGVUcmlnZ2VyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyVXBkYXRlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjc2V0RGVmYXVsdAogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc2V0RGVmYXVsdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkodGhpcy5zY2hlbWFbJ2RlZmF1bHQnXSkpIHsKICAgICAgICAgICAgICAgICAgICBBbHBhY2EuZWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUodGhpcy5zY2hlbWFbJ2RlZmF1bHQnXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZGVzdHJveQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgLy8gaWYgdGhpcyBjb250YWluZXIgaXMgRE9NLXdyYXBwZWQgd2l0aCBhIGZvcm0sIHRoZW4gcmVsZWFzZSB0aGUgZm9ybQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZm9ybSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZm9ybS5kZXN0cm95KHRydWUpOyAvLyBwYXNzIGluIHRydWUgc28gdGhhdCB3ZSBkb24ndCBjYWxsIGJhY2sgcmVjdXJzaXZlbHkKICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5mb3JtOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGRlc3Ryb3kgYW55IGNoaWxkIGNvbnRyb2xzCiAgICAgICAgICAgICAgICBBbHBhY2EuZWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIGNhbGwgdXAgdG8gYmFzZSBtZXRob2QKICAgICAgICAgICAgICAgIHRoaXMuYmFzZSgpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIFJlbmRlcnMgY2hpbGQgaXRlbSBjb250YWluZXIuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7SW50ZWdlcn0gaW5zZXJ0QWZ0ZXJJZCBJbnNlcnRpb24gcG9pbnQgZm9yIHRoZSBjb250YWluZXIuCiAgICAgICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbnRyb2x9IHBhcmVudCBQYXJlbnQgZmllbGQuCiAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eUlkIENoaWxkIGl0ZW0gcHJvcGVydHkgSUQuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICByZW5kZXJJdGVtQ29udGFpbmVyOiBmdW5jdGlvbihpbnNlcnRBZnRlcklkLCBwYXJlbnQsIHByb3BlcnR5SWQpIHsKICAgICAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICAgICAgdmFyIGl0ZW1Db250YWluZXJUZW1wbGF0ZURlc2NyaXB0b3IgPSB0aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJmaWVsZFNldEl0ZW1Db250YWluZXIiKTsKICAgICAgICAgICAgICAgIGlmIChpdGVtQ29udGFpbmVyVGVtcGxhdGVEZXNjcmlwdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRhaW5lckVsZW0gPSBfdGhpcy52aWV3LnRtcGwoaXRlbUNvbnRhaW5lclRlbXBsYXRlRGVzY3JpcHRvciwge30pOwogICAgICAgICAgICAgICAgICAgIGlmIChjb250YWluZXJFbGVtLmF0dHIoJ2RhdGEtcmVwbGFjZScpID09ICd0cnVlJykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5maWVsZENvbnRhaW5lcjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zZXJ0QWZ0ZXJJZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnIycgKyBpbnNlcnRBZnRlcklkICsgJy1pdGVtLWNvbnRhaW5lcicsIHRoaXMub3V0ZXJFbCkuYWZ0ZXIoY29udGFpbmVyRWxlbSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFwcGVuZFRvQ29udGFpbmVyID0gdGhpcy5maWVsZENvbnRhaW5lcjsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYmluZGluZ3MgPSB0aGlzLnZpZXcuZ2V0TGF5b3V0KCkuYmluZGluZ3M7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYmluZGluZyA9IGJpbmRpbmdzW3Byb3BlcnR5SWRdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nICYmICQoJyMnICsgYmluZGluZywgYXBwZW5kVG9Db250YWluZXIpLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwZW5kVG9Db250YWluZXIgPSAkKCcjJyArIGJpbmRpbmcsIGFwcGVuZFRvQ29udGFpbmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXJFbGVtLmFwcGVuZFRvKGFwcGVuZFRvQ29udGFpbmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29udGFpbmVyRWxlbTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmllbGRDb250YWluZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjcmVuZGVyRmllbGQKICAgICAgICAgICAgICovCiAgICAgICAgICAgIHJlbmRlckZpZWxkOiBmdW5jdGlvbihvblN1Y2Nlc3MpIHsKCiAgICAgICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgICAgIHRoaXMuZ2V0U3R5bGVJbmplY3Rpb24oImNvbnRhaW5lciIsIHRoaXMub3V0ZXJFbCk7CgogICAgICAgICAgICAgICAgdmFyIGxhYmVsRGl2ID0gJCgnLmFscGFjYS1maWVsZHNldC1sZWdlbmQnLCB0aGlzLm91dGVyRWwpOwoKICAgICAgICAgICAgICAgIGlmIChsYWJlbERpdi5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmxhYmVsRGl2ID0gbGFiZWxEaXY7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMub3V0ZXJFbC5hZGRDbGFzcygnYWxwYWNhLWZpZWxkc2V0LW5vLWxlZ2VuZCcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBmaWVsZFNldERpdiA9ICQoJy5hbHBhY2EtZmllbGRzZXQnLCB0aGlzLm91dGVyRWwpOwoKICAgICAgICAgICAgICAgIGlmIChmaWVsZFNldERpdi5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZpZWxkU2V0RGl2ID0gZmllbGRTZXREaXY7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGRTZXREaXYgPSB0aGlzLm91dGVyRWw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIGZpZWxkQ29udGFpbmVyID0gJCgnLmFscGFjYS1maWVsZHNldC1pdGVtcy1jb250YWluZXInLCB0aGlzLm91dGVyRWwpOwogICAgICAgICAgICAgICAgaWYgKGZpZWxkQ29udGFpbmVyLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGRDb250YWluZXIgPSBmaWVsZENvbnRhaW5lcjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5maWVsZENvbnRhaW5lciA9IHRoaXMub3V0ZXJFbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgYXN5bmNIYW5kbGVyID0gZmFsc2U7CgogICAgICAgICAgICAgICAgaWYgKCF0aGlzLnNpbmdsZUxldmVsUmVuZGVyaW5nICYmICF0aGlzLmxhenlMb2FkaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgYXN5bmNIYW5kbGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlckl0ZW1zKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAob25TdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvblN1Y2Nlc3MoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmxhenlMb2FkaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubGFiZWxEaXYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXN5bmNIYW5kbGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzLmxhYmVsRGl2KS5jbGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfdGhpcy5sYXp5TG9hZGluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnJlbmRlckl0ZW1zKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5sYXp5TG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob25TdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvblN1Y2Nlc3MoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCFhc3luY0hhbmRsZXIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9uU3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgICAgICBvblN1Y2Nlc3MoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogUHJvcGFnYXRlcyBzaWduYWwgZG93biB0byBhbGwgY2hpbGRyZW4uCiAgICAgICAgICAgICAqIEBvdmVycmlkZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgb25EZXBlbmRlbnRSZXZlYWw6IGZ1bmN0aW9uKCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2hpbGRyZW5baV0ub25EZXBlbmRlbnRSZXZlYWwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBQcm9wYWdhdGVzIHNpZ25hbCBkb3duIHRvIGFsbCBjaGlsZHJlbi4KICAgICAgICAgICAgICogQG92ZXJyaWRlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBvbkRlcGVuZGVudENvbmNlYWw6IGZ1bmN0aW9uKCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2hpbGRyZW5baV0ub25EZXBlbmRlbnRDb25jZWFsKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogUmVuZGVycyBhbGwgY2hpbGQgaXRlbXMgb2YgdGhpcyBmaWVsZC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIG9uU3VjY2VzcyBvblN1Y2Nlc3MgY2FsbGJhY2suCiAgICAgICAgICAgICAqLwogICAgICAgICAgICByZW5kZXJJdGVtczogZnVuY3Rpb24ob25TdWNjZXNzKSB7CiAgICAgICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2lzQ29udGFpbmVyCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBpc0NvbnRhaW5lcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRTY2hlbWFPZk9wdGlvbnMKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldFNjaGVtYU9mT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJsYXp5TG9hZGluZyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJMYXp5IExvYWRpbmciLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkNoaWxkIGZpZWxkcyB3aWxsIG9ubHkgYmUgcmVuZGVyZWQgd2hlbiB0aGUgZmllbGRzZXQgaXMgZXhwYW5kZWQgaWYgdGhpcyBvcHRpb24gaXMgc2V0IHRydWUuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiBmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAiY29sbGFwc2libGUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiQ29sbGFwc2libGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkZpZWxkIHNldCBpcyBjb2xsYXBzaWJsZSBpZiB0cnVlLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAiY29sbGFwc2VkIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkNvbGxhcHNlZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRmllbGQgc2V0IGlzIGluaXRpYWxseSBjb2xsYXBzZWQgaWYgdHJ1ZS4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICJsZWdlbmRTdHlsZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJMZWdlbmQgU3R5bGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkZpZWxkIHNldCBsZWdlbmQgc3R5bGUuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZW51bSI6WyJidXR0b24iLCJsaW5rIl0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6ICJidXR0b24iCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRPcHRpb25zRm9yT3B0aW9ucwogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZ2V0T3B0aW9uc0Zvck9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJsYXp5TG9hZGluZyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJyaWdodExhYmVsIjogIkxhenkgbG9hZGluZyBjaGlsZCBmaWVsZHMgPyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaGVscGVyIjogIkxhenkgbG9hZGluZyB3aWxsIGJlIGVuYWJsZWQgaWYgY2hlY2tlZC4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiY2hlY2tib3giCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICJjb2xsYXBzaWJsZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJyaWdodExhYmVsIjogIkZpZWxkIHNldCBjb2xsYXBzaWJsZSA/IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJoZWxwZXIiOiAiRmllbGQgc2V0IGlzIGNvbGxhcHNpYmxlIGlmIGNoZWNrZWQuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IgogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAiY29sbGFwc2VkIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInJpZ2h0TGFiZWwiOiAiRmllbGQgc2V0IGluaXRpYWxseSBjb2xsYXBzZWQgPyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRmllbGQgc2V0IGlzIGluaXRpYWxseSBjb2xsYXBzZWQgaWYgY2hlY2tlZC4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiY2hlY2tib3giCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICJsZWdlbmRTdHlsZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjoic2VsZWN0IgogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgICAgIH0pOwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkNvbm5lY3RvciA9IEJhc2UuZXh0ZW5kKAogICAgLyoqCiAgICAgKiBAbGVuZHMgQWxwYWNhLkNvbm5lY3Rvci5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGNsYXNzIENvbm5lY3RzIEFscGFjYSB0byByZW1vdGUgZGF0YSBzdG9yZXMuCgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBpZCBDb25uZWN0b3IgSUQuCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGlkKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5pZCA9IGlkOwoKICAgICAgICAgICAgLy8gaGVscGVyIGZ1bmN0aW9uIHRvIGRldGVybWluZSBpZiBhIHJlc291cmNlIGlzIGEgdXJpCiAgICAgICAgICAgIHRoaXMuaXNVcmkgPSBmdW5jdGlvbihyZXNvdXJjZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuICFBbHBhY2EuaXNFbXB0eShyZXNvdXJjZSkgJiYgQWxwYWNhLmlzVXJpKHJlc291cmNlKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHZhciBPTkVfSE9VUiA9IDM2MDAwMDA7CiAgICAgICAgICAgIHRoaXMuY2FjaGUgPSBuZXcgYWpheENhY2hlKCdVUkwnLCB0cnVlLCBPTkVfSE9VUik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogTWFrZXMgaW5pdGlhbCBjb25uZWN0aW9ucyB0byBkYXRhIHNvdXJjZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IG9uU3VjY2VzcyBvblN1Y2Nlc3MgY2FsbGJhY2suCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gb25FcnJvciBvbkVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGNvbm5lY3Q6IGZ1bmN0aW9uIChvblN1Y2Nlc3MsIG9uRXJyb3IpCiAgICAgICAgewogICAgICAgICAgICBpZiAob25TdWNjZXNzICYmIEFscGFjYS5pc0Z1bmN0aW9uKG9uU3VjY2VzcykpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9uU3VjY2VzcygpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogTG9hZHMgYSB0ZW1wbGF0ZSAoSFRNTCBvciBUZXh0KS4KICAgICAgICAgKgogICAgICAgICAqIElmIHRoZSBzb3VyY2UgaXMgYSBVUkksIHRoZW4gaXQgaXMgbG9hZGVkLgogICAgICAgICAqIElmIGl0IGlzIG5vdCBhIFVSSSwgdGhlbiB0aGUgc291cmNlIGlzIHNpbXBseSBoYW5kZWQgYmFjay4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gc291cmNlIFNvdXJjZSB0byBiZSBsb2FkZWQuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gb25TdWNjZXNzIG9uU3VjY2VzcyBjYWxsYmFjay4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBvbkVycm9yIG9uRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgbG9hZFRlbXBsYXRlIDogZnVuY3Rpb24gKHNvdXJjZSwgb25TdWNjZXNzLCBvbkVycm9yKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eShzb3VyY2UpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzVXJpKHNvdXJjZSkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkVXJpKHNvdXJjZSwgZmFsc2UsIGZ1bmN0aW9uKGxvYWRlZERhdGEpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvblN1Y2Nlc3MgJiYgQWxwYWNhLmlzRnVuY3Rpb24ob25TdWNjZXNzKSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb25TdWNjZXNzKGxvYWRlZERhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChsb2FkRXJyb3IpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbkVycm9yICYmIEFscGFjYS5pc0Z1bmN0aW9uKG9uRXJyb3IpKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkVycm9yKGxvYWRFcnJvcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBvblN1Y2Nlc3Moc291cmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9uRXJyb3IoewogICAgICAgICAgICAgICAgICAgICJtZXNzYWdlIjoiRW1wdHkgZGF0YSBzb3VyY2UuIiwKICAgICAgICAgICAgICAgICAgICAicmVhc29uIjogIlRFTVBMQVRFX0xPQURJTkdfRVJST1IiCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIExvYWRzIEpTT04gZGF0YS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gcmVzb3VyY2UgUmVzb3VyY2UgdG8gYmUgbG9hZGVkLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IG9uU3VjY2VzcyBvblN1Y2Nlc3MgY2FsbGJhY2sKICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBvbkVycm9yIG9uRXJyb3IgY2FsbGJhY2sKICAgICAgICAgKi8KICAgICAgICBsb2FkRGF0YTogZnVuY3Rpb24gKHJlc291cmNlLCBzdWNjZXNzQ2FsbGJhY2ssIGVycm9yQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faGFuZGxlTG9hZEpzb25SZXNvdXJjZShyZXNvdXJjZSwgc3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBMb2FkcyBKU09OIHNjaGVtYS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gcmVzb3VyY2UgUmVzb3VyY2UgdG8gYmUgbG9hZGVkLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IG9uU3VjY2VzcyBvblN1Y2Nlc3MgY2FsbGJhY2suCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gb25FcnJvciBvbkVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGxvYWRTY2hlbWE6IGZ1bmN0aW9uIChyZXNvdXJjZSwgc3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZUxvYWRKc29uUmVzb3VyY2UocmVzb3VyY2UsIHN1Y2Nlc3NDYWxsYmFjaywgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogTG9hZHMgSlNPTiBvcHRpb25zLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSByZXNvdXJjZSBSZXNvdXJjZSB0byBiZSBsb2FkZWQuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gb25TdWNjZXNzIG9uU3VjY2VzcyBjYWxsYmFjay4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBvbkVycm9yIG9uRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgbG9hZE9wdGlvbnM6IGZ1bmN0aW9uIChyZXNvdXJjZSwgc3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZUxvYWRKc29uUmVzb3VyY2UocmVzb3VyY2UsIHN1Y2Nlc3NDYWxsYmFjaywgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogTG9hZHMgSlNPTiB2aWV3LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSByZXNvdXJjZSBSZXNvdXJjZSB0byBiZSBsb2FkZWQuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gb25TdWNjZXNzIG9uU3VjY2VzcyBjYWxsYmFjay4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBvbkVycm9yIG9uRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgbG9hZFZpZXc6IGZ1bmN0aW9uIChyZXNvdXJjZSwgc3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZUxvYWRKc29uUmVzb3VyY2UocmVzb3VyY2UsIHN1Y2Nlc3NDYWxsYmFjaywgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogTG9hZHMgc2NoZW1hLCBmb3JtLCB2aWV3IGFuZCBkYXRhIGluIGEgc2luZ2xlIGNhbGwuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gcmVzb3VyY2VzIHJlc291cmNlcwogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IG9uU3VjY2VzcyBvblN1Y2Nlc3MgY2FsbGJhY2suCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gb25FcnJvciBvbkVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGxvYWRBbGw6IGZ1bmN0aW9uIChyZXNvdXJjZXMsIG9uU3VjY2Vzcywgb25FcnJvcikKICAgICAgICB7CiAgICAgICAgICAgIHZhciBkYXRhU291cmNlID0gcmVzb3VyY2VzLmRhdGFTb3VyY2U7CiAgICAgICAgICAgIHZhciBzY2hlbWFTb3VyY2UgPSByZXNvdXJjZXMuc2NoZW1hU291cmNlOwogICAgICAgICAgICB2YXIgb3B0aW9uc1NvdXJjZSA9IHJlc291cmNlcy5vcHRpb25zU291cmNlOwogICAgICAgICAgICB2YXIgdmlld1NvdXJjZSA9IHJlc291cmNlcy52aWV3U291cmNlOwoKICAgICAgICAgICAgLy8gd2UgYWxsb3cgInNjaGVtYSIgdG8gY29udGFpbiBhIFVSSSBhcyB3ZWxsIChiYWNrd2FyZHMtY29tcGF0aWJpbGl0eSkKICAgICAgICAgICAgaWYgKCFzY2hlbWFTb3VyY2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHNjaGVtYVNvdXJjZSA9IHJlc291cmNlcy5zY2hlbWE7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHdlIGFsbG93ICJvcHRpb25zIiB0byBjb250YWluIGEgVVJJIGFzIHdlbGwgKGJhY2t3YXJkcy1jb21wYXRpYmlsaXR5KQogICAgICAgICAgICBpZiAoIW9wdGlvbnNTb3VyY2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9wdGlvbnNTb3VyY2UgPSByZXNvdXJjZXMub3B0aW9uczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gd2UgYWxsb3cgInZpZXciIHRvIGNvbnRhaW4gYSBVUkkgYXMgd2VsbCAoYmFja3dhcmRzLWNvbXBhdGliaWxpdHkpCiAgICAgICAgICAgIGlmICghdmlld1NvdXJjZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmlld1NvdXJjZSA9IHJlc291cmNlcy52aWV3OwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgbG9hZGVkID0ge307CgogICAgICAgICAgICB2YXIgbG9hZENvdW50ZXIgPSAwOwogICAgICAgICAgICB2YXIgaW52b2NhdGlvbkNvdW50ID0gMDsKCiAgICAgICAgICAgIHZhciBzdWNjZXNzQ2FsbGJhY2sgPSBmdW5jdGlvbigpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChsb2FkQ291bnRlciA9PT0gaW52b2NhdGlvbkNvdW50KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChvblN1Y2Nlc3MgJiYgQWxwYWNhLmlzRnVuY3Rpb24ob25TdWNjZXNzKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9uU3VjY2Vzcyhsb2FkZWQuZGF0YSwgbG9hZGVkLm9wdGlvbnMsIGxvYWRlZC5zY2hlbWEsIGxvYWRlZC52aWV3KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgZXJyb3JDYWxsYmFjayA9IGZ1bmN0aW9uIChsb2FkRXJyb3IpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChvbkVycm9yICYmIEFscGFjYS5pc0Z1bmN0aW9uKG9uRXJyb3IpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG9uRXJyb3IobG9hZEVycm9yKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIGNvdW50IG91dCB0aGUgdG90YWwgIyBvZiBpbnZva2VzIHdlJ3JlIGdvaW5nIHRvIGZpcmUgb2ZmCiAgICAgICAgICAgIGlmIChkYXRhU291cmNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpbnZvY2F0aW9uQ291bnQrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2NoZW1hU291cmNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpbnZvY2F0aW9uQ291bnQrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uc1NvdXJjZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaW52b2NhdGlvbkNvdW50Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZpZXdTb3VyY2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGludm9jYXRpb25Db3VudCsrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnZvY2F0aW9uQ291bnQgPT09IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIG5vdGhpbmcgdG8gaW52b2tlLCBzbyBqdXN0IGhhbmQgYmFjawogICAgICAgICAgICAgICAgc3VjY2Vzc0NhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGZpcmUgb2ZmIGFsbCBvZiB0aGUgaW52b2tlcwogICAgICAgICAgICBpZiAoZGF0YVNvdXJjZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5sb2FkRGF0YShkYXRhU291cmNlLCBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgbG9hZGVkLmRhdGEgPSBkYXRhOwogICAgICAgICAgICAgICAgICAgIGxvYWRDb3VudGVyKys7CiAgICAgICAgICAgICAgICAgICAgc3VjY2Vzc0NhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICB9LCBlcnJvckNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2NoZW1hU291cmNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmxvYWRTY2hlbWEoc2NoZW1hU291cmNlLCBmdW5jdGlvbihzY2hlbWEpIHsKICAgICAgICAgICAgICAgICAgICBsb2FkZWQuc2NoZW1hID0gc2NoZW1hOwogICAgICAgICAgICAgICAgICAgIGxvYWRDb3VudGVyKys7CiAgICAgICAgICAgICAgICAgICAgc3VjY2Vzc0NhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICB9LCBlcnJvckNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uc1NvdXJjZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5sb2FkT3B0aW9ucyhvcHRpb25zU291cmNlLCBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgbG9hZGVkLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICAgICAgICAgICAgICAgIGxvYWRDb3VudGVyKys7CiAgICAgICAgICAgICAgICAgICAgc3VjY2Vzc0NhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICB9LCBlcnJvckNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmlld1NvdXJjZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5sb2FkVmlldyh2aWV3U291cmNlLCBmdW5jdGlvbih2aWV3KSB7CiAgICAgICAgICAgICAgICAgICAgbG9hZGVkLnZpZXcgPSB2aWV3OwogICAgICAgICAgICAgICAgICAgIGxvYWRDb3VudGVyKys7CiAgICAgICAgICAgICAgICAgICAgc3VjY2Vzc0NhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICB9LCBlcnJvckNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIExvYWRzIGEgSlNPTiB0aHJvdWdoIEFqYXggY2FsbC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB1cmkgbG9jYXRpb24gb2YgdGhlIGpzb24gZG9jdW1lbnQKICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBvblN1Y2Nlc3Mgb25TdWNjZXNzIGNhbGxiYWNrLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IG9uRXJyb3Igb25FcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBsb2FkSnNvbiA6IGZ1bmN0aW9uKHVyaSwgb25TdWNjZXNzLCBvbkVycm9yKSB7CiAgICAgICAgICAgIHRoaXMubG9hZFVyaSh1cmksIHRydWUsIG9uU3VjY2Vzcywgb25FcnJvcik7CiAgICAgICAgfSAsCgogICAgICAgIC8qKgogICAgICAgICAqIExvYWRzIGEgZ2VuZXJhbCBkb2N1bWVudCB0aHJvdWdoIEFqYXggY2FsbC4KICAgICAgICAgKgogICAgICAgICAqIFRoaXMgdXNlcyBqUXVlcnkgdG8gcGVyZm9ybSB0aGUgQWpheCBjYWxsLiAgSWYgeW91IG5lZWQgdG8gY3VzdG9taXplIGNvbm5lY3Rpdml0eSB0byB5b3VyIG93biByZW1vdGUgc2VydmVyLAogICAgICAgICAqIHRoaXMgd291bGQgYmUgdGhlIGFwcHJvcHJpYXRlIHBsYWNlIHRvIGRvIHNvLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHVyaSB1cmkgdG8gYmUgbG9hZGVkCiAgICAgICAgICogQHBhcmFtIHtCb29sZWFufSBpc0pzb24gV2hldGhlciB0aGUgZG9jdW1lbnQgaXMgYSBKU09OIG9yIG5vdC4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBvblN1Y2Nlc3Mgb25TdWNjZXNzIGNhbGxiYWNrLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IG9uRXJyb3Igb25FcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBsb2FkVXJpIDogZnVuY3Rpb24odXJpLCBpc0pzb24sIG9uU3VjY2Vzcywgb25FcnJvcikgewoKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgdmFyIGFqYXhDb25maWdzID0gewogICAgICAgICAgICAgICAgInVybCI6IHVyaSwKICAgICAgICAgICAgICAgICJ0eXBlIjogImdldCIsCiAgICAgICAgICAgICAgICAic3VjY2VzcyI6IGZ1bmN0aW9uKGpzb25Eb2N1bWVudCkgewoKICAgICAgICAgICAgICAgICAgICBzZWxmLmNhY2hlLnB1dCh1cmksIGpzb25Eb2N1bWVudCk7CgogICAgICAgICAgICAgICAgICAgIGlmIChvblN1Y2Nlc3MgJiYgQWxwYWNhLmlzRnVuY3Rpb24ob25TdWNjZXNzKSkgewogICAgICAgICAgICAgICAgICAgICAgICBvblN1Y2Nlc3MoanNvbkRvY3VtZW50KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImVycm9yIjogZnVuY3Rpb24oanFYSFIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9uRXJyb3IgJiYgQWxwYWNhLmlzRnVuY3Rpb24ob25FcnJvcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb25FcnJvcih7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVzc2FnZSI6IlVuYWJsZSB0byBsb2FkIGRhdGEgZnJvbSB1cmkgOiAiICsgdXJpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YWdlIjogIkRBVEFfTE9BRElOR19FUlJPUiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGV0YWlscyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAianFYSFIiIDoganFYSFIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRleHRTdGF0dXMiIDogdGV4dFN0YXR1cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZXJyb3JUaHJvd24iIDogZXJyb3JUaHJvd24KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKGlzSnNvbikgewogICAgICAgICAgICAgICAgYWpheENvbmZpZ3MuZGF0YVR5cGUgPSAianNvbiI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhamF4Q29uZmlncy5kYXRhVHlwZSA9ICJ0ZXh0IjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGNhY2hlZERvY3VtZW50ID0gc2VsZi5jYWNoZS5nZXQodXJpKTsKCiAgICAgICAgICAgIGlmIChjYWNoZWREb2N1bWVudCAhPT0gZmFsc2UgJiYgb25TdWNjZXNzICYmIEFscGFjYS5pc0Z1bmN0aW9uKG9uU3VjY2VzcykpIHsKICAgICAgICAgICAgICAgIG9uU3VjY2VzcyhjYWNoZWREb2N1bWVudCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkLmFqYXgoYWpheENvbmZpZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogTG9hZHMgcmVmZXJlbmNlZCBKU09OIHNjaGVtYS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gcmVzb3VyY2UgUmVzb3VyY2UgdG8gYmUgbG9hZGVkLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IG9uU3VjY2VzcyBvblN1Y2Nlc3MgY2FsbGJhY2suCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gb25FcnJvciBvbkVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGxvYWRSZWZlcmVuY2VTY2hlbWE6IGZ1bmN0aW9uIChyZXNvdXJjZSwgc3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZUxvYWRKc29uUmVzb3VyY2UocmVzb3VyY2UsIHN1Y2Nlc3NDYWxsYmFjaywgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogTG9hZHMgcmVmZXJlbmNlZCBKU09OIG9wdGlvbnMuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHJlc291cmNlIFJlc291cmNlIHRvIGJlIGxvYWRlZC4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBvblN1Y2Nlc3Mgb25TdWNjZXNzIGNhbGxiYWNrLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IG9uRXJyb3Igb25FcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBsb2FkUmVmZXJlbmNlT3B0aW9uczogZnVuY3Rpb24gKHJlc291cmNlLCBzdWNjZXNzQ2FsbGJhY2ssIGVycm9yQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faGFuZGxlTG9hZEpzb25SZXNvdXJjZShyZXNvdXJjZSwgc3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICBfaGFuZGxlTG9hZEpzb25SZXNvdXJjZTogZnVuY3Rpb24gKHJlc291cmNlLCBzdWNjZXNzQ2FsbGJhY2ssIGVycm9yQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5pc1VyaShyZXNvdXJjZSkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMubG9hZEpzb24ocmVzb3VyY2UsIGZ1bmN0aW9uKGxvYWRlZFJlc291cmNlKSB7CiAgICAgICAgICAgICAgICAgICAgc3VjY2Vzc0NhbGxiYWNrKGxvYWRlZFJlc291cmNlKTsKICAgICAgICAgICAgICAgIH0sIGVycm9yQ2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc3VjY2Vzc0NhbGxiYWNrKHJlc291cmNlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJDb25uZWN0b3JDbGFzcygiZGVmYXVsdCIsIEFscGFjYS5Db25uZWN0b3IpOwoKCgoKCgoKCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLwogICAgLy8gQUpBWCBDQUNIRQogICAgLy8KICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCgogICAgLyohCiAgICAgKiBhamF4LWNhY2hlIEphdmFTY3JpcHQgTGlicmFyeSB2MC4yLjEKICAgICAqIGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vcC9hamF4LWNhY2hlLwogICAgICoKICAgICAqIEluY2x1ZGVzIGZldyBKU09OIG1ldGhvZHMgKG9wZW4gc291cmNlKQogICAgICogaHR0cDovL3d3dy5qc29uLm9yZy9qcy5odG1sCiAgICAgKgogICAgICogRGF0ZTogMjAxMC0wOC0wMwogICAgICovCiAgICBmdW5jdGlvbiBhamF4Q2FjaGUodHlwZSwgb24sIGxpZmV0aW1lKSB7CiAgICAgICAgaWYgKG9uKSB7CiAgICAgICAgICAgIHRoaXMub24gPSB0cnVlOwogICAgICAgIH0gZWxzZQogICAgICAgICAgICB0aGlzLm9uID0gZmFsc2U7CgogICAgICAgIC8vIHNldCBkZWZhdWx0IGNhY2hlIGxpZmV0aW1lCiAgICAgICAgaWYgKGxpZmV0aW1lICE9IG51bGwpIHsKICAgICAgICAgICAgdGhpcy5kZWZhdWx0TGlmZXRpbWUgPSBsaWZldGltZTsKICAgICAgICB9CgogICAgICAgIC8vIHNldCB0eXBlCiAgICAgICAgdGhpcy50eXBlID0gdHlwZTsKCiAgICAgICAgLy8gc2V0IGNhY2hlIGZ1bmN0aW9ucyBhY2NvcmRpbmcgdG8gdHlwZQogICAgICAgIHN3aXRjaCAodGhpcy50eXBlKSB7CiAgICAgICAgICAgIGNhc2UgJ1VSTCc6CiAgICAgICAgICAgICAgICB0aGlzLnB1dCA9IHRoaXMucHV0X3VybDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdHRVQnOgogICAgICAgICAgICAgICAgdGhpcy5wdXQgPSB0aGlzLnB1dF9HRVQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgfTsKCiAgICBhamF4Q2FjaGUucHJvdG90eXBlLm9uID0gZmFsc2U7CiAgICBhamF4Q2FjaGUucHJvdG90eXBlLnR5cGU7CiAgICBhamF4Q2FjaGUucHJvdG90eXBlLmRlZmF1bHRMaWZldGltZSA9IDE4MDAwMDA7IC8vIDE4MDAwMDA9MzBtaW4sIDMwMDAwMD01bWluLCAzMDAwMD0zMHNlYwogICAgYWpheENhY2hlLnByb3RvdHlwZS5pdGVtcyA9IE9iamVjdCgpOwoKICAgIC8qKgogICAgICogQ2FjaGVzIHRoZSByZXF1ZXN0IGFuZCBpdHMgcmVzcG9uc2UuIFR5cGU6IHVybAogICAgICoKICAgICAqIEBwYXJhbSB1cmwgLSB1cmwgb2YgYWpheCByZXNwb25zZQogICAgICogQHBhcmFtIHJlc3BvbnNlIC0gYWpheCByZXNwb25zZQogICAgICogQHBhcmFtIGxpZmV0aW1lIC0gKG9wdGlvbmFsKSBzZXRzIGNhY2hlIGxpZmV0aW1lIGluIG1pbGlzZWNvbmRzCiAgICAgKiBAcmV0dXJuIHRydWUgb24gc3VjY2VzcwogICAgICovCiAgICBhamF4Q2FjaGUucHJvdG90eXBlLnB1dF91cmwgPSBmdW5jdGlvbih1cmwsIHJlc3BvbnNlLCBsaWZldGltZSkgewogICAgICAgIGlmIChsaWZldGltZSA9PSBudWxsKSBsaWZldGltZSA9IHRoaXMuZGVmYXVsdExpZmV0aW1lOwogICAgICAgIHZhciBrZXkgPSB0aGlzLm1ha2Vfa2V5KHVybCk7CiAgICAgICAgdGhpcy5pdGVtc1trZXldID0gT2JqZWN0KCk7CiAgICAgICAgdGhpcy5pdGVtc1trZXldLmtleSA9IGtleTsKICAgICAgICB0aGlzLml0ZW1zW2tleV0udXJsID0gdXJsOwogICAgICAgIHRoaXMuaXRlbXNba2V5XS5yZXNwb25zZSA9IHJlc3BvbnNlOwogICAgICAgIHRoaXMuaXRlbXNba2V5XS5leHBpcmUgPSAobmV3IERhdGUoKS5nZXRUaW1lKCkpICsgbGlmZXRpbWU7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBDYWNoZXMgdGhlIHJlcXVlc3QgYW5kIGl0cyByZXNwb25zZS4gVHlwZTogR0VUCiAgICAgKgogICAgICogQHBhcmFtIHVybCAtIHVybCBvZiBhamF4IHJlc3BvbnNlCiAgICAgKiBAcGFyYW0gZGF0YSAtIGRhdGEgcGFyYW1zIChxdWVyeSkKICAgICAqIEBwYXJhbSByZXNwb25zZSAtIGFqYXggcmVzcG9uc2UKICAgICAqIEBwYXJhbSBsaWZldGltZSAtIChvcHRpb25hbCkgc2V0cyBjYWNoZSBsaWZldGltZSBpbiBtaWxpc2Vjb25kcwogICAgICogQHJldHVybiB0cnVlIG9uIHN1Y2Nlc3MKICAgICAqLwogICAgYWpheENhY2hlLnByb3RvdHlwZS5wdXRfR0VUID0gZnVuY3Rpb24odXJsLCBkYXRhLCByZXNwb25zZSwgbGlmZXRpbWUpIHsKICAgICAgICBpZiAobGlmZXRpbWUgPT0gbnVsbCkKICAgICAgICAgICAgbGlmZXRpbWUgPSB0aGlzLmRlZmF1bHRMaWZldGltZTsKICAgICAgICB2YXIga2V5ID0gdGhpcy5tYWtlX2tleSh1cmwsIFsgZGF0YSBdKTsKICAgICAgICB0aGlzLml0ZW1zW2tleV0gPSBPYmplY3QoKTsKICAgICAgICB0aGlzLml0ZW1zW2tleV0ua2V5ID0ga2V5OwogICAgICAgIHRoaXMuaXRlbXNba2V5XS51cmwgPSB1cmw7CiAgICAgICAgdGhpcy5pdGVtc1trZXldLmRhdGEgPSBkYXRhOwogICAgICAgIHRoaXMuaXRlbXNba2V5XS5yZXNwb25zZSA9IHJlc3BvbnNlOwogICAgICAgIHRoaXMuaXRlbXNba2V5XS5leHBpcmUgPSAobmV3IERhdGUoKS5nZXRUaW1lKCkpICsgbGlmZXRpbWU7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXQgY2FjaGVkIGFqYXggcmVzcG9uc2UKICAgICAqCiAgICAgKiBAcGFyYW0gdXJsIC0gdXJsIG9mIGFqYXggcmVzcG9uc2UKICAgICAqIEBwYXJhbSBwYXJhbXMgLSBBcnJheSBvZiBhZGRpdGlvbmFsIHBhcmFtZXRlcnMsIHRvIG1ha2Uga2V5CiAgICAgKiBAcmV0dXJuIGFqYXggcmVzcG9uc2Ugb3IgZmFsc2UgaWYgc3VjaCBkb2VzIG5vdCBleGlzdCBvciBpcyBleHBpcmVkCiAgICAgKi8KICAgIGFqYXhDYWNoZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24odXJsLCBwYXJhbXMpIHsKICAgICAgICB2YXIga2V5ID0gdGhpcy5tYWtlX2tleSh1cmwsIHBhcmFtcyk7CgogICAgICAgIC8vIGlmIGNhY2hlIGRvZXMgbm90IGV4aXN0CiAgICAgICAgaWYgKHRoaXMuaXRlbXNba2V5XSA9PSBudWxsKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgICAgIC8vIGlmIGNhY2hlIGV4cGlyZWQKICAgICAgICBpZiAodGhpcy5pdGVtc1trZXldLmV4cGlyZSA8IChuZXcgRGF0ZSgpLmdldFRpbWUoKSkpCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKCiAgICAgICAgLy8gZXZlcnl0aGluZyBpcyBwYXNzZWQgLSBsZXRzIHJldHVybiB0aGUgcmVzcG9uc2UKICAgICAgICByZXR1cm4gdGhpcy5pdGVtc1trZXldLnJlc3BvbnNlOwogICAgfQoKICAgIC8qKgogICAgICogTWFrZSB1bmlxdWUga2V5IGZvciBlYWNoIHJlcXVlc3QgZGVwZW5kaW5nIG9uIHVybCBhbmQgYWRkaXRpb25hbCBwYXJhbWV0ZXJzCiAgICAgKgogICAgICogQHBhcmFtIHVybCAtIHVybCBvZiBhamF4IHJlc3BvbnNlCiAgICAgKiBAcGFyYW0gcGFyYW1zIC0gQXJyYXkgb2YgYWRkaXRpb25hbCBwYXJhbWV0ZXJzLCB0byBtYWtlIGtleQogICAgICogQHJldHVybiB1bmlxdWUga2V5CiAgICAgKi8KICAgIGFqYXhDYWNoZS5wcm90b3R5cGUubWFrZV9rZXkgPSBmdW5jdGlvbih1cmwsIHBhcmFtcykgewogICAgICAgIHZhciBrZXkgPSB1cmw7CiAgICAgICAgc3dpdGNoICh0aGlzLnR5cGUpIHsKICAgICAgICAgICAgY2FzZSAnVVJMJzoKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdHRVQnOgogICAgICAgICAgICAgICAga2V5ICs9IHRoaXMuc3RyaW5naWZ5KHBhcmFtc1swXSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIHJldHVybiBrZXk7CiAgICB9CgogICAgLyoqCiAgICAgKiBGbHVzaCBjYWNoZQogICAgICoKICAgICAqIEByZXR1cm4gdHJ1ZSBvbiBzdWNjZXNzCiAgICAgKi8KICAgIGFqYXhDYWNoZS5wcm90b3R5cGUuZmx1c2ggPSBmdW5jdGlvbigpIHsKICAgICAgICAvLyBmbHVzaCBhbGwgY2FjaGUKICAgICAgICBjYWNoZS5pdGVtcyA9IE9iamVjdCgpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qCiAgICAgKiBNZXRob2RzIHRvIHN0cmluZ2lmeSBKYXZhU2NyaXB0L0pTT04gb2JqZWN0cy4KICAgICAqCiAgICAgKiBUYWtlbiBmcm9tOiBodHRwOi8vd3d3Lmpzb24ub3JnL2pzLmh0bWwgdG8gYmUgbW9yZSBleGFjdCwgdGhpcyBmaWxlOgogICAgICogaHR0cDovL3d3dy5qc29uLm9yZy9qc29uMi5qcyBjb3BpZWQgb24gMjAxMC0wNy0xOQogICAgICoKICAgICAqIFRha2VuIG1ldGhvZHM6IHN0cmluZ2lmeSwgcXVvdGUgYW5kIHN0cgogICAgICoKICAgICAqIE1ldGhvZHMgYXJlIHNsaWdodGx5IG1vZGlmaWVkIHRvIGJlc3QgZml0IGFqYXgtY2FjaGUgZnVuY3Rpb25hbGl0eQogICAgICoKICAgICAqLwogICAgYWpheENhY2hlLnByb3RvdHlwZS5zdHJpbmdpZnkgPSBmdW5jdGlvbih2YWx1ZSwgcmVwbGFjZXIsIHNwYWNlKSB7CgogICAgICAgIC8vIFRoZSBzdHJpbmdpZnkgbWV0aG9kIHRha2VzIGEgdmFsdWUgYW5kIGFuIG9wdGlvbmFsIHJlcGxhY2VyLCBhbmQgYW4KICAgICAgICAvLyBvcHRpb25hbAogICAgICAgIC8vIHNwYWNlIHBhcmFtZXRlciwgYW5kIHJldHVybnMgYSBKU09OIHRleHQuIFRoZSByZXBsYWNlciBjYW4gYmUgYSBmdW5jdGlvbgogICAgICAgIC8vIHRoYXQgY2FuIHJlcGxhY2UgdmFsdWVzLCBvciBhbiBhcnJheSBvZiBzdHJpbmdzIHRoYXQgd2lsbCBzZWxlY3QgdGhlCiAgICAgICAgLy8ga2V5cy4KICAgICAgICAvLyBBIGRlZmF1bHQgcmVwbGFjZXIgbWV0aG9kIGNhbiBiZSBwcm92aWRlZC4gVXNlIG9mIHRoZSBzcGFjZSBwYXJhbWV0ZXIgY2FuCiAgICAgICAgLy8gcHJvZHVjZSB0ZXh0IHRoYXQgaXMgbW9yZSBlYXNpbHkgcmVhZGFibGUuCgogICAgICAgIHZhciBpOwogICAgICAgIGdhcCA9ICcnOwogICAgICAgIGluZGVudCA9ICcnOwoKICAgICAgICAvLyBJZiB0aGUgc3BhY2UgcGFyYW1ldGVyIGlzIGEgbnVtYmVyLCBtYWtlIGFuIGluZGVudCBzdHJpbmcgY29udGFpbmluZyB0aGF0CiAgICAgICAgLy8gbWFueSBzcGFjZXMuCgogICAgICAgIGlmICh0eXBlb2Ygc3BhY2UgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzcGFjZTsgaSArPSAxKSB7CiAgICAgICAgICAgICAgICBpbmRlbnQgKz0gJyAnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiB0aGUgc3BhY2UgcGFyYW1ldGVyIGlzIGEgc3RyaW5nLCBpdCB3aWxsIGJlIHVzZWQgYXMgdGhlIGluZGVudAogICAgICAgICAgICAvLyBzdHJpbmcuCgogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHNwYWNlID09PSAnc3RyaW5nJykgewogICAgICAgICAgICBpbmRlbnQgPSBzcGFjZTsKICAgICAgICB9CgogICAgICAgIC8vIElmIHRoZXJlIGlzIGEgcmVwbGFjZXIsIGl0IG11c3QgYmUgYSBmdW5jdGlvbiBvciBhbiBhcnJheS4KICAgICAgICAvLyBPdGhlcndpc2UsIHRocm93IGFuIGVycm9yLgoKICAgICAgICByZXAgPSByZXBsYWNlcjsKICAgICAgICBpZiAocmVwbGFjZXIKICAgICAgICAgICAgJiYgdHlwZW9mIHJlcGxhY2VyICE9PSAnZnVuY3Rpb24nCiAgICAgICAgICAgICYmICh0eXBlb2YgcmVwbGFjZXIgIT09ICdvYmplY3QnIHx8IHR5cGVvZiByZXBsYWNlci5sZW5ndGggIT09ICdudW1iZXInKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0pTT04uc3RyaW5naWZ5Jyk7CiAgICAgICAgfQoKICAgICAgICAvLyBNYWtlIGEgZmFrZSByb290IG9iamVjdCBjb250YWluaW5nIG91ciB2YWx1ZSB1bmRlciB0aGUga2V5IG9mICcnLgogICAgICAgIC8vIFJldHVybiB0aGUgcmVzdWx0IG9mIHN0cmluZ2lmeWluZyB0aGUgdmFsdWUuCgogICAgICAgIHJldHVybiB0aGlzLnN0cignJywgewogICAgICAgICAgICAnJyA6IHZhbHVlCiAgICAgICAgfSk7CiAgICB9CgogICAgYWpheENhY2hlLnByb3RvdHlwZS5xdW90ZSA9IGZ1bmN0aW9uKHN0cmluZykgewoKICAgICAgICAvLyBJZiB0aGUgc3RyaW5nIGNvbnRhaW5zIG5vIGNvbnRyb2wgY2hhcmFjdGVycywgbm8gcXVvdGUgY2hhcmFjdGVycywgYW5kIG5vCiAgICAgICAgLy8gYmFja3NsYXNoIGNoYXJhY3RlcnMsIHRoZW4gd2UgY2FuIHNhZmVseSBzbGFwIHNvbWUgcXVvdGVzIGFyb3VuZCBpdC4KICAgICAgICAvLyBPdGhlcndpc2Ugd2UgbXVzdCBhbHNvIHJlcGxhY2UgdGhlIG9mZmVuZGluZyBjaGFyYWN0ZXJzIHdpdGggc2FmZSBlc2NhcGUKICAgICAgICAvLyBzZXF1ZW5jZXMuCgogICAgICAgIHZhciBlc2NhcGFibGUgPSAvW1xcXCJceDAwLVx4MWZceDdmLVx4OWZcdTAwYWRcdTA2MDAtXHUwNjA0XHUwNzBmXHUxN2I0XHUxN2I1XHUyMDBjLVx1MjAwZlx1MjAyOC1cdTIwMmZcdTIwNjAtXHUyMDZmXHVmZWZmXHVmZmYwLVx1ZmZmZl0vZzsKCiAgICAgICAgZXNjYXBhYmxlLmxhc3RJbmRleCA9IDA7CiAgICAgICAgcmV0dXJuIGVzY2FwYWJsZS50ZXN0KHN0cmluZykgPyAnIicgKyBzdHJpbmcucmVwbGFjZShlc2NhcGFibGUsCiAgICAgICAgICAgIGZ1bmN0aW9uKGEpIHsKICAgICAgICAgICAgICAgIHZhciBjID0gbWV0YVthXTsKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2YgYyA9PT0gJ3N0cmluZycgPyBjIDogJ1xcdScgKyAoJzAwMDAnICsgYQogICAgICAgICAgICAgICAgICAgIC5jaGFyQ29kZUF0KDApLnRvU3RyaW5nKDE2KSkuc2xpY2UoLTQpOwogICAgICAgICAgICB9KSArICciJyA6ICciJyArIHN0cmluZyArICciJzsKICAgIH0KCiAgICBhamF4Q2FjaGUucHJvdG90eXBlLnN0ciA9IGZ1bmN0aW9uKGtleSwgaG9sZGVyKSB7CgogICAgICAgIC8vIFByb2R1Y2UgYSBzdHJpbmcgZnJvbSBob2xkZXJba2V5XS4KCiAgICAgICAgdmFyIGksIC8vIFRoZSBsb29wIGNvdW50ZXIuCiAgICAgICAgICAgIGssIC8vIFRoZSBtZW1iZXIga2V5LgogICAgICAgICAgICB2LCAvLyBUaGUgbWVtYmVyIHZhbHVlLgogICAgICAgICAgICBsZW5ndGgsIG1pbmQgPSBnYXAsIHBhcnRpYWwsIHZhbHVlID0gaG9sZGVyW2tleV07CgogICAgICAgIC8vIElmIHRoZSB2YWx1ZSBoYXMgYSB0b0pTT04gbWV0aG9kLCBjYWxsIGl0IHRvIG9idGFpbiBhIHJlcGxhY2VtZW50IHZhbHVlLgoKICAgICAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JwogICAgICAgICAgICAmJiB0eXBlb2YgdmFsdWUudG9KU09OID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIHZhbHVlID0gdmFsdWUudG9KU09OKGtleSk7CiAgICAgICAgfQoKICAgICAgICAvLyBJZiB3ZSB3ZXJlIGNhbGxlZCB3aXRoIGEgcmVwbGFjZXIgZnVuY3Rpb24sIHRoZW4gY2FsbCB0aGUgcmVwbGFjZXIgdG8KICAgICAgICAvLyBvYnRhaW4gYSByZXBsYWNlbWVudCB2YWx1ZS4KCiAgICAgICAgaWYgKHR5cGVvZiByZXAgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgdmFsdWUgPSByZXAuY2FsbChob2xkZXIsIGtleSwgdmFsdWUpOwogICAgICAgIH0KCiAgICAgICAgLy8gV2hhdCBoYXBwZW5zIG5leHQgZGVwZW5kcyBvbiB0aGUgdmFsdWUncyB0eXBlLgoKICAgICAgICBzd2l0Y2ggKHR5cGVvZiB2YWx1ZSkgewogICAgICAgICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucXVvdGUodmFsdWUpOwoKICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzoKCiAgICAgICAgICAgICAgICAvLyBKU09OIG51bWJlcnMgbXVzdCBiZSBmaW5pdGUuIEVuY29kZSBub24tZmluaXRlIG51bWJlcnMgYXMgbnVsbC4KCiAgICAgICAgICAgICAgICByZXR1cm4gaXNGaW5pdGUodmFsdWUpID8gU3RyaW5nKHZhbHVlKSA6ICdudWxsJzsKCiAgICAgICAgICAgIGNhc2UgJ2Jvb2xlYW4nOgogICAgICAgICAgICBjYXNlICdudWxsJzoKCiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgdmFsdWUgaXMgYSBib29sZWFuIG9yIG51bGwsIGNvbnZlcnQgaXQgdG8gYSBzdHJpbmcuIE5vdGU6CiAgICAgICAgICAgICAgICAvLyB0eXBlb2YgbnVsbCBkb2VzIG5vdCBwcm9kdWNlICdudWxsJy4gVGhlIGNhc2UgaXMgaW5jbHVkZWQgaGVyZSBpbgogICAgICAgICAgICAgICAgLy8gdGhlIHJlbW90ZSBjaGFuY2UgdGhhdCB0aGlzIGdldHMgZml4ZWQgc29tZWRheS4KCiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKTsKCiAgICAgICAgICAgIC8vIElmIHRoZSB0eXBlIGlzICdvYmplY3QnLCB3ZSBtaWdodCBiZSBkZWFsaW5nIHdpdGggYW4gb2JqZWN0IG9yIGFuCiAgICAgICAgICAgIC8vIGFycmF5IG9yCiAgICAgICAgICAgIC8vIG51bGwuCgogICAgICAgICAgICBjYXNlICdvYmplY3QnOgoKICAgICAgICAgICAgICAgIC8vIER1ZSB0byBhIHNwZWNpZmljYXRpb24gYmx1bmRlciBpbiBFQ01BU2NyaXB0LCB0eXBlb2YgbnVsbCBpcwogICAgICAgICAgICAgICAgLy8gJ29iamVjdCcsCiAgICAgICAgICAgICAgICAvLyBzbyB3YXRjaCBvdXQgZm9yIHRoYXQgY2FzZS4KCiAgICAgICAgICAgICAgICBpZiAoIXZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdudWxsJzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBNYWtlIGFuIGFycmF5IHRvIGhvbGQgdGhlIHBhcnRpYWwgcmVzdWx0cyBvZiBzdHJpbmdpZnlpbmcgdGhpcyBvYmplY3QKICAgICAgICAgICAgICAgIC8vIHZhbHVlLgoKICAgICAgICAgICAgICAgIGdhcCArPSBpbmRlbnQ7CiAgICAgICAgICAgICAgICBwYXJ0aWFsID0gW107CgogICAgICAgICAgICAgICAgLy8gSXMgdGhlIHZhbHVlIGFuIGFycmF5PwoKICAgICAgICAgICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmFwcGx5KHZhbHVlKSA9PT0gJ1tvYmplY3QgQXJyYXldJykgewoKICAgICAgICAgICAgICAgICAgICAvLyBUaGUgdmFsdWUgaXMgYW4gYXJyYXkuIFN0cmluZ2lmeSBldmVyeSBlbGVtZW50LiBVc2UgbnVsbCBhcyBhCiAgICAgICAgICAgICAgICAgICAgLy8gcGxhY2Vob2xkZXIKICAgICAgICAgICAgICAgICAgICAvLyBmb3Igbm9uLUpTT04gdmFsdWVzLgoKICAgICAgICAgICAgICAgICAgICBsZW5ndGggPSB2YWx1ZS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRpYWxbaV0gPSB0aGlzLnN0cihpLCB2YWx1ZSkgfHwgJ251bGwnOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gSm9pbiBhbGwgb2YgdGhlIGVsZW1lbnRzIHRvZ2V0aGVyLCBzZXBhcmF0ZWQgd2l0aCBjb21tYXMsIGFuZAogICAgICAgICAgICAgICAgICAgIC8vIHdyYXAgdGhlbSBpbgogICAgICAgICAgICAgICAgICAgIC8vIGJyYWNrZXRzLgoKICAgICAgICAgICAgICAgICAgICB2ID0gcGFydGlhbC5sZW5ndGggPT09IDAgPyAnW10nIDogZ2FwID8gJ1tcbicgKyBnYXAKICAgICAgICAgICAgICAgICAgICAgICAgKyBwYXJ0aWFsLmpvaW4oJyxcbicgKyBnYXApICsgJ1xuJyArIG1pbmQgKyAnXScKICAgICAgICAgICAgICAgICAgICAgICAgOiAnWycgKyBwYXJ0aWFsLmpvaW4oJywnKSArICddJzsKICAgICAgICAgICAgICAgICAgICBnYXAgPSBtaW5kOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIElmIHRoZSByZXBsYWNlciBpcyBhbiBhcnJheSwgdXNlIGl0IHRvIHNlbGVjdCB0aGUgbWVtYmVycyB0byBiZQogICAgICAgICAgICAgICAgLy8gc3RyaW5naWZpZWQuCgogICAgICAgICAgICAgICAgaWYgKHJlcCAmJiB0eXBlb2YgcmVwID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IHJlcC5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGsgPSByZXBbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgayA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHYgPSB0aGlzLnN0cihrLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRpYWwucHVzaCh0aGlzLnF1b3RlKGspICsgKGdhcCA/ICc6ICcgOiAnOicpICsgdik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgICAgICAvLyBPdGhlcndpc2UsIGl0ZXJhdGUgdGhyb3VnaCBhbGwgb2YgdGhlIGtleXMgaW4gdGhlIG9iamVjdC4KCiAgICAgICAgICAgICAgICAgICAgZm9yIChrIGluIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbCh2YWx1ZSwgaykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHYgPSB0aGlzLnN0cihrLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRpYWwucHVzaCh0aGlzLnF1b3RlKGspICsgKGdhcCA/ICc6ICcgOiAnOicpICsgdik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSm9pbiBhbGwgb2YgdGhlIG1lbWJlciB0ZXh0cyB0b2dldGhlciwgc2VwYXJhdGVkIHdpdGggY29tbWFzLAogICAgICAgICAgICAgICAgLy8gYW5kIHdyYXAgdGhlbSBpbiBicmFjZXMuCgogICAgICAgICAgICAgICAgdiA9IHBhcnRpYWwubGVuZ3RoID09PSAwID8gJ3t9JyA6IGdhcCA/ICd7XG4nICsgZ2FwCiAgICAgICAgICAgICAgICAgICAgKyBwYXJ0aWFsLmpvaW4oJyxcbicgKyBnYXApICsgJ1xuJyArIG1pbmQgKyAnfScgOiAneycgKyBwYXJ0aWFsCiAgICAgICAgICAgICAgICAgICAgLmpvaW4oJywnKSArICd9JzsKICAgICAgICAgICAgICAgIGdhcCA9IG1pbmQ7CiAgICAgICAgICAgICAgICByZXR1cm4gdjsKICAgICAgICB9CiAgICB9Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRm9ybSA9IEJhc2UuZXh0ZW5kKAogICAgLyoqCiAgICAgKiBAbGVuZHMgQWxwYWNhLkZvcm0ucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIFRoaXMgY2xhc3MgaXMgZm9yIG1hbmFnaW5nIEhUTUwgZm9ybSBjb250cm9sLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBvcHRpb25zLCB2aWV3SWQsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgLy8gY29udGFpbmVyCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gY29udGFpbmVyOwoKICAgICAgICAgICAgLy8gcGFyZW50CiAgICAgICAgICAgIHRoaXMucGFyZW50ID0gbnVsbDsKCiAgICAgICAgICAgIHRoaXMuY29ubmVjdG9yID0gY29ubmVjdG9yOwogICAgICAgICAgICB0aGlzLmVycm9yQ2FsbGJhY2sgPSBlcnJvckNhbGxiYWNrOwoKICAgICAgICAgICAgLy8gb3B0aW9ucwogICAgICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwoKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5hdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF0dHJpYnV0ZXMgPSB0aGlzLm9wdGlvbnMuYXR0cmlidXRlczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmJ1dHRvbnMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuYnV0dG9ucy5zdWJtaXQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5idXR0b25zLnN1Ym1pdC50eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5idXR0b25zLnN1Ym1pdC50eXBlID0gJ3N1Ym1pdCc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5vcHRpb25zLmJ1dHRvbnMuc3VibWl0Lm5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmJ1dHRvbnMuc3VibWl0Lm5hbWUgPSAnc3VibWl0JzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuYnV0dG9ucy5zdWJtaXQudmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmJ1dHRvbnMuc3VibWl0LnZhbHVlID0gJ1N1Ym1pdCc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5idXR0b25zLnJlc2V0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuYnV0dG9ucy5yZXNldC50eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5idXR0b25zLnJlc2V0LnR5cGUgPSAncmVzZXQnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5idXR0b25zLnJlc2V0Lm5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmJ1dHRvbnMucmVzZXQubmFtZSA9ICdyZXNldCc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5vcHRpb25zLmJ1dHRvbnMucmVzZXQudmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmJ1dHRvbnMucmVzZXQudmFsdWUgPSAnUmVzZXQnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuYXR0cmlidXRlcy5pZCkgewogICAgICAgICAgICAgICAgdGhpcy5pZCA9IHRoaXMuYXR0cmlidXRlcy5pZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuaWQgPSBBbHBhY2EuZ2VuZXJhdGVJZCgpOwogICAgICAgICAgICAgICAgdGhpcy5hdHRyaWJ1dGVzLmlkID0gdGhpcy5pZDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaWYgd2UgaGF2ZSBhIHN1Ym1pdCBidXR0b24gc3BlY2lmaWVkLCBhbmQgdG9nZ2xlU3VibWl0VmFsaWRTdGF0ZSBpc24ndCBkZWZpbmVkLCBzZXQgdG8gdHJ1ZSBieSBkZWZhdWx0CiAgICAgICAgICAgIC8vIGRvbid0IGFsbG93IHRoZSBmb3JtIHRvIHN1Ym1pdCB1bmxlc3MgdmFsaWQKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5idXR0b25zICYmIHRoaXMub3B0aW9ucy5idXR0b25zLnN1Ym1pdCAmJiBBbHBhY2EuaXNVbmRlZmluZWQodGhpcy5vcHRpb25zLnRvZ2dsZVN1Ym1pdFZhbGlkU3RhdGUpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMudG9nZ2xlU3VibWl0VmFsaWRTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudmlld1R5cGUgPSBvcHRpb25zLnZpZXdUeXBlOwoKICAgICAgICAgICAgLy8gc2V0IGEgcnVudGltZSB2aWV3CiAgICAgICAgICAgIHRoaXMudmlldyA9IG5ldyBBbHBhY2EuUnVudGltZVZpZXcodmlld0lkLCB0aGlzKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZW5kZXJzIHRoaXMgZm9ybSBpbnRvIHRoZSBjb250YWluZXIuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBvblN1Y2Nlc3Mgb25TdWNjZXNzIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIHJlbmRlcjogZnVuY3Rpb24ob25TdWNjZXNzKSB7CiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLnRlbXBsYXRlRGVzY3JpcHRvciA9IHRoaXMudmlldy5nZXRUZW1wbGF0ZURlc2NyaXB0b3IoImZvcm0iKTsKCiAgICAgICAgICAgIC8vIHJlbW92ZSB0aGUgcHJldmlvdXMgb3V0ZXJFbCBpZiBpdCBleGlzdHMKICAgICAgICAgICAgaWYgKHRoaXMub3V0ZXJFbCkgewogICAgICAgICAgICAgICAgdGhpcy5vdXRlckVsLnJlbW92ZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBsb2FkIHRoZSBhcHByb3ByaWF0ZSB0ZW1wbGF0ZSBhbmQgcmVuZGVyIGl0CiAgICAgICAgICAgIHRoaXMucHJvY2Vzc1JlbmRlcih0aGlzLmNvbnRhaW5lciwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAvLyBiaW5kIG91ciBmaWVsZCBkb20gZWxlbWVudCBpbnRvIHRoZSBjb250YWluZXIKICAgICAgICAgICAgICAgIF90aGlzLm91dGVyRWwuYXBwZW5kVG8oX3RoaXMuY29udGFpbmVyKTsKCiAgICAgICAgICAgICAgICAvLyBhZGQgZGVmYXVsdCBjbGFzcwogICAgICAgICAgICAgICAgX3RoaXMub3V0ZXJFbC5hZGRDbGFzcygiYWxwYWNhLWZvcm0iKTsKCiAgICAgICAgICAgICAgICAvLyBleGVjdXRlIGNhbGxiYWNrCiAgICAgICAgICAgICAgICBpZiAob25TdWNjZXNzKQogICAgICAgICAgICAgICAgICAgIG9uU3VjY2VzcyhfdGhpcyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIERldGVybWluZXMgd2hldGhlciB0aGUgdG9wIGNvbnRyb2wgaXMgZW50aXJlbHkgdmFsaWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJuIHsqfQogICAgICAgICAqLwogICAgICAgIGlzRm9ybVZhbGlkOiBmdW5jdGlvbigpCiAgICAgICAgewogICAgICAgICAgICAvLyByZS1jb21wdXRlIHZhbGlkYXRpb24gZm9yIHRoZSBmdWxsIGNvbnRyb2wgc2V0CiAgICAgICAgICAgIHRoaXMudG9wQ29udHJvbC52YWxpZGF0ZSh0cnVlKTsKCiAgICAgICAgICAgIHZhciB2YWxpZCA9IHRoaXMudG9wQ29udHJvbC5pc1ZhbGlkKHRydWUpOwogICAgICAgICAgICB0aGlzLnJlZnJlc2hWYWxpZGF0aW9uU3RhdGUodHJ1ZSk7CgogICAgICAgICAgICByZXR1cm4gdmFsaWQ7CiAgICAgICAgfSwKCiAgICAgICAgdmFsaWRhdGU6IGZ1bmN0aW9uKGNoaWxkcmVuKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudG9wQ29udHJvbC52YWxpZGF0ZShjaGlsZHJlbik7CiAgICAgICAgfSwKCiAgICAgICAgZW5hYmxlU3VibWl0QnV0dG9uOiBmdW5jdGlvbigpCiAgICAgICAgewogICAgICAgICAgICAkKCIuYWxwYWNhLWZvcm0tYnV0dG9uLXN1Ym1pdCIpLmF0dHJQcm9wKCJkaXNhYmxlZCIsIGZhbHNlKTsKCiAgICAgICAgICAgIGlmICgkLm1vYmlsZSkgewogICAgICAgICAgICAgICAgdHJ5IHsgJCgiLmFscGFjYS1mb3JtLWJ1dHRvbi1zdWJtaXQiKS5idXR0b24oJ3JlZnJlc2gnKTsgfSBjYXRjaCAoZSkgeyB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBkaXNhYmxlU3VibWl0QnV0dG9uOiBmdW5jdGlvbigpCiAgICAgICAgewogICAgICAgICAgICAkKCIuYWxwYWNhLWZvcm0tYnV0dG9uLXN1Ym1pdCIpLmF0dHJQcm9wKCJkaXNhYmxlZCIsIHRydWUpOwoKICAgICAgICAgICAgaWYgKCQubW9iaWxlKSB7CiAgICAgICAgICAgICAgICB0cnkgeyAkKCIuYWxwYWNhLWZvcm0tYnV0dG9uLXN1Ym1pdCIpLmJ1dHRvbigncmVmcmVzaCcpOyB9IGNhdGNoIChlKSB7IH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGFkanVzdFN1Ym1pdEJ1dHRvblN0YXRlOiBmdW5jdGlvbigpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmRpc2FibGVTdWJtaXRCdXR0b24oKTsKCiAgICAgICAgICAgIHZhciB4ID0gdGhpcy5pc0Zvcm1WYWxpZCgpOwogICAgICAgICAgICBpZiAodGhpcy5pc0Zvcm1WYWxpZCgpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmVuYWJsZVN1Ym1pdEJ1dHRvbigpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVzcG9uc2libGUgZm9yIGZldGNoaW5nIGFueSB0ZW1wbGF0ZXMgbmVlZGVkIHNvIGFzIHRvIHJlbmRlciB0aGUKICAgICAgICAgKiBjdXJyZW50IG1vZGUgZm9yIHRoaXMgZmllbGQuCiAgICAgICAgICoKICAgICAgICAgKiBPbmNlIGNvbXBsZXRlZCwgdGhlIG9uU3VjY2VzcyBtZXRob2QgaXMgY2FsbGVkLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHBhcmVudEVsIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBvblN1Y2Nlc3Mgb25TdWNjZXNzIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIHByb2Nlc3NSZW5kZXI6IGZ1bmN0aW9uKHBhcmVudEVsLCBvblN1Y2Nlc3MpIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIC8vIGxvb2t1cCB0aGUgdGVtcGxhdGUgd2Ugc2hvdWxkIHVzZSB0byByZW5kZXIKICAgICAgICAgICAgdmFyIHRlbXBsYXRlRGVzY3JpcHRvciA9IHRoaXMuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCk7CgogICAgICAgICAgICB2YXIgY29udGV4dCA9IHsKICAgICAgICAgICAgICAgIGlkOiB0aGlzLmdldElkKCksCiAgICAgICAgICAgICAgICBvcHRpb25zOiB0aGlzLm9wdGlvbnMsCiAgICAgICAgICAgICAgICB2aWV3OiB0aGlzLnZpZXcKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIHJlbmRlcmVkRG9tRWxlbWVudCA9IF90aGlzLnZpZXcudG1wbCh0ZW1wbGF0ZURlc2NyaXB0b3IsIGNvbnRleHQsIHt9KTsKICAgICAgICAgICAgcmVuZGVyZWREb21FbGVtZW50LmFwcGVuZFRvKHBhcmVudEVsKTsKCiAgICAgICAgICAgIHRoaXMub3V0ZXJFbCA9IHJlbmRlcmVkRG9tRWxlbWVudDsKCiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNFbXB0eSh0aGlzLm91dGVyRWwuYXR0cigiaWQiKSkpIHsKICAgICAgICAgICAgICAgIHRoaXMub3V0ZXJFbC5hdHRyKCJpZCIsIHRoaXMuZ2V0SWQoKSArICItZm9ybS1vdXRlciIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNFbXB0eSh0aGlzLm91dGVyRWwuYXR0cigiYWxwYWNhLWZpZWxkLWlkIikpKSB7CiAgICAgICAgICAgICAgICB0aGlzLm91dGVyRWwuYXR0cigiYWxwYWNhLWZpZWxkLWlkIiwgdGhpcy5nZXRJZCgpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZ2V0IGNvbnRhaW5lciBmb3IgZm9ybXMKICAgICAgICAgICAgaWYgKCQoJy5hbHBhY2EtZm9ybS1maWVsZHMtY29udGFpbmVyJywgdGhpcy5vdXRlckVsKSkgewogICAgICAgICAgICAgICAgdGhpcy5mb3JtRmllbGRzQ29udGFpbmVyID0gJCgnLmFscGFjYS1mb3JtLWZpZWxkcy1jb250YWluZXInLCB0aGlzLm91dGVyRWwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5mb3JtRmllbGRzQ29udGFpbmVyID0gdGhpcy5vdXRlckVsOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyB0aGUgZm9ybSBmaWVsZAogICAgICAgICAgICB0aGlzLmZpZWxkID0gJCgnZm9ybScsIHRoaXMuY29udGFpbmVyKTsKICAgICAgICAgICAgaWYgKHRoaXMuZmllbGQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIGFkZCBhbGwgcHJvdmlkZWQgYXR0cmlidXRlcwogICAgICAgICAgICAgICAgdGhpcy5maWVsZC5hdHRyKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHBvcHVsYXRlIHRoZSBidXR0b25zIGFzIHdlbGwKICAgICAgICAgICAgdGhpcy5idXR0b25zID0ge307CiAgICAgICAgICAgICQuZWFjaCgkKCcuYWxwYWNhLWZvcm0tYnV0dG9uJywgdGhpcy5jb250YWluZXIpLGZ1bmN0aW9uKGssdikgewoKICAgICAgICAgICAgICAgIC8vIFRPRE86IHRoaXMgaXMgdGVjaG5pY2FsbHkgd3Jvbmcgc2luY2Ugd2Ugb25seSB3YW50IHRvIHRyYXAgZm9yIGxlZnQtbW91c2Vkb3duLi4uCiAgICAgICAgICAgICAgICAkKHYpLm1vdXNlZG93bihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX3RoaXMgPSAkKHRoaXMpOwogICAgICAgICAgICAgICAgICAgIF90aGlzLmF0dHIoImJ1dHRvbi1wdXNoZWQiLCJ0cnVlIik7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF90aGlzLmF0dHIoImJ1dHRvbi1wdXNoZWQiKSAmJiBfdGhpcy5hdHRyKCJidXR0b24tcHVzaGVkIikgPT0gInRydWUiICkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY2xpY2soKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIDE1MCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICQodikuY2xpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5yZW1vdmVBdHRyKCJidXR0b24tcHVzaGVkIik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIF90aGlzLmJ1dHRvbnNbJCh2KS5hdHRyKCdkYXRhLWtleScpXSA9ICQodik7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgb25TdWNjZXNzKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0cmlldmUgdGhlIGZvcm0gY29udGFpbmVyLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gRm9ybSBjb250YWluZXIuCiAgICAgICAgICovCiAgICAgICAgZ2V0RWw6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5vdXRlckVsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgdGhlIGlkIG9mIHRoZSBmb3JtLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge1N0cmluZ30gRm9ybSBpZAogICAgICAgICAqLwogICAgICAgIGdldElkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuaWQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyBmb3JtIHR5cGUuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBGb3JtIHR5cGUuCiAgICAgICAgICovCiAgICAgICAgZ2V0VHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnR5cGU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGlzIGZvcm0ncyBwYXJlbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBGb3JtIHBhcmVudC4KICAgICAgICAgKi8KICAgICAgICBnZXRQYXJlbnQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJlbnQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGUgdmFsdWUgb2YgdGhlIEpTT04gcmVuZGVyZWQgYnkgdGhpcyBmb3JtLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0FueX0gVmFsdWUgb2YgdGhlIEpTT04gcmVuZGVyZWQgYnkgdGhpcyBmb3JtLgogICAgICAgICAqLwogICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudG9wQ29udHJvbC5nZXRWYWx1ZSgpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFNldHMgdGhlIHZhbHVlIG9mIHRoZSBKU09OIHRvIGJlIHJlbmRlcmVkIGJ5IHRoaXMgZm9ybS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7QW55fSB2YWx1ZSBWYWx1ZSB0byBiZSBzZXQuCiAgICAgICAgICovCiAgICAgICAgc2V0VmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMudG9wQ29udHJvbC5zZXRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogSW5pdGlhbGl6ZXMgZXZlbnRzIGhhbmRsaW5nIChGb3JtIFN1Ym1pc3Npb24pIGZvciB0aGlzIGZvcm0uCiAgICAgICAgICovCiAgICAgICAgaW5pdEV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkKSB7CiAgICAgICAgICAgICAgICB2YXIgdiA9IHRoaXMuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgICAgICQodGhpcy5maWVsZCkuc3VibWl0KHYsIGZ1bmN0aW9uKGUpIHsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLm9uU3VibWl0KGUsIF90aGlzKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBsaXN0ZW4gZm9yIGZpZWxkdXBkYXRlcyBhbmQgZGV0ZXJtaW5lIHdoZXRoZXIgdGhlIGZvcm0gaXMgdmFsaWQuCiAgICAgICAgICAgIC8vIGlmIHNvLCBlbmFibGUgdGhlIHN1Ym1pdCBidXR0b24uLi4KICAgICAgICAgICAgLy8gb3RoZXJ3aXNlLCBkaXNhYmxlIGl0CiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMudG9nZ2xlU3VibWl0VmFsaWRTdGF0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgJChfdGhpcy50b3BDb250cm9sLmdldEVsKCkpLmJpbmQoImZpZWxkdXBkYXRlIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuYWRqdXN0U3VibWl0QnV0dG9uU3RhdGUoKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHRoaXMuYWRqdXN0U3VibWl0QnV0dG9uU3RhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEhhbmRsZXMgZm9ybSBzdWJtaXQgZXZlbnRzLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGUgU3VibWl0IGV2ZW50LgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBmb3JtIHRoZSBmb3JtCiAgICAgICAgICovCiAgICAgICAgb25TdWJtaXQ6IGZ1bmN0aW9uKGUsIGZvcm0pIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3VibWl0SGFuZGxlcikgewogICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKCiAgICAgICAgICAgICAgICB2YXIgdiA9IHRoaXMuc3VibWl0SGFuZGxlcihlLCBmb3JtKTsKICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNVbmRlZmluZWQodikpIHsKICAgICAgICAgICAgICAgICAgICB2ID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIHY7CgogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVnaXN0ZXJzIGEgY3VzdG9tIHN1Ym1pdCBoYW5kbGVyLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGZ1bmMgU3VibWl0IGhhbmRsZXIgdG8gYmUgcmVnaXN0ZXJlZC4KICAgICAgICAgKi8KICAgICAgICByZWdpc3RlclN1Ym1pdEhhbmRsZXI6IGZ1bmN0aW9uIChmdW5jKSB7CiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNGdW5jdGlvbihmdW5jKSkgewogICAgICAgICAgICAgICAgdGhpcy5zdWJtaXRIYW5kbGVyID0gZnVuYzsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIERpc3BsYXlzIHZhbGlkYXRpb24gaW5mb3JtYXRpb24gb2YgYWxsIGZpZWxkcyBvZiB0aGlzIGZvcm0uCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IGNoaWxkcmVuIHdoZXRoZXIgdG8gcmVuZGVyIHZhbGlkYXRpb24gc3RhdGUgZm9yIGNoaWxkIGZpZWxkcwogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gRm9ybSB2YWxpZGF0aW9uIHN0YXRlLgogICAgICAgICAqLwogICAgICAgIHJlZnJlc2hWYWxpZGF0aW9uU3RhdGU6IGZ1bmN0aW9uKGNoaWxkcmVuKSB7CiAgICAgICAgICAgIHRoaXMudG9wQ29udHJvbC5yZWZyZXNoVmFsaWRhdGlvblN0YXRlKGNoaWxkcmVuKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBEaXNhYmxlcyB0aGlzIGZvcm0uCiAgICAgICAgICovCiAgICAgICAgZGlzYWJsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMudG9wQ29udHJvbC5kaXNhYmxlKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogRW5hYmxlcyB0aGlzIGZvcm0uCiAgICAgICAgICovCiAgICAgICAgZW5hYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy50b3BDb250cm9sLmVuYWJsZSgpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEZvY3VzZXMgb24gdGhpcyBmb3JtLgogICAgICAgICAqLwogICAgICAgIGZvY3VzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy50b3BDb250cm9sLmZvY3VzKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUHVyZ2UgYW55IGV2ZW50IGxpc3RlbmVycyBhbmQgcmVtb3ZlIHRoZSBmb3JtIGZyb20gdGhlIERPTS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBbQm9vbGVhbl0gc2tpcFBhcmVudCB3aGVuIHRydWUsIHRoZSBmb3JtIGNsZWFucyB1cCB3aXRob3V0IHRyYXZlcnNpbmcgdGhyb3VnaCBwYXJlbnQgY2hpbGQgY29udHJvbHMKICAgICAgICAgKi8KICAgICAgICBkZXN0cm95OiBmdW5jdGlvbihza2lwUGFyZW50KSB7CgogICAgICAgICAgICB0aGlzLmdldEVsKCkucmVtb3ZlKCk7CgogICAgICAgICAgICAvLyB3ZSBhbGxvdyBmb3JtLmRlc3Ryb3koKSB3aGljaCB0ZWxscyBwYXJlbnQgY29udHJvbCB0byBkZXN0cm95CiAgICAgICAgICAgIC8vIGlmIHNraXBQYXJlbnQgPT0gdHJ1ZSwgdGhlbiB3ZSBkbyBub3QgY2FsbCB1cCAoaW52b2tlZCBmcm9tIGNvbnRhaW5lcikKICAgICAgICAgICAgaWYgKCFza2lwUGFyZW50ICYmIHRoaXMucGFyZW50KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnBhcmVudC5kZXN0cm95KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBTaG93cyB0aGUgZm9ybS4KICAgICAgICAgKi8KICAgICAgICBzaG93OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5nZXRFbCgpLmNzcyh7CiAgICAgICAgICAgICAgICAiZGlzcGxheSI6ICIiCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEhpZGVzIHRoZSBmb3JtLgogICAgICAgICAqLwogICAgICAgIGhpZGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmdldEVsKCkuY3NzKHsKICAgICAgICAgICAgICAgICJkaXNwbGF5IjogIm5vbmUiCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENsZWFycyB0aGUgZm9ybSBhbmQgcmVzZXRzIHZhbHVlcyBvZiBpdHMgZmllbGRzLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHN0b3BVcGRhdGVUcmlnZ2VyIElmIGZhbHNlLCB0cmlnZ2VycyB0aGUgdXBkYXRlIGV2ZW50IG9mIHRoaXMgZXZlbnQuCiAgICAgICAgICovCiAgICAgICAgY2xlYXI6IGZ1bmN0aW9uKHN0b3BVcGRhdGVUcmlnZ2VyKSB7CiAgICAgICAgICAgIHRoaXMudG9wQ29udHJvbC5jbGVhcihzdG9wVXBkYXRlVHJpZ2dlcik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ2hlY2tzIGlmIGZvcm0gaXMgZW1wdHkuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZiB0aGUgZm9ybSBpcyBlbXB0eSwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIGlzRW1wdHk6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy50b3BDb250cm9sLmlzRW1wdHkoKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIHRoZSBmb3JtIHRlbXBsYXRlLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge09iamVjdHxTdHJpbmd9IHRlbXBsYXRlIEZvcm0gdGVtcGxhdGUuCiAgICAgICAgICovCiAgICAgICAgZ2V0VGVtcGxhdGVEZXNjcmlwdG9yOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudGVtcGxhdGVEZXNjcmlwdG9yOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFNldHMgdGhlIGZvcm0gdGVtcGxhdGUuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdGVtcGxhdGVEZXNjcmlwdG9yIFRlbXBsYXRlIHRvIGJlIHNldAogICAgICAgICAqLwogICAgICAgIHNldFRlbXBsYXRlRGVzY3JpcHRvcjogZnVuY3Rpb24odGVtcGxhdGVEZXNjcmlwdG9yKSB7CiAgICAgICAgICAgIHRoaXMudGVtcGxhdGVEZXNjcmlwdG9yID0gdGVtcGxhdGVEZXNjcmlwdG9yOwogICAgICAgIH0KCiAgICB9KTsKCn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkID0gQWxwYWNhLkNvbnRyb2xGaWVsZC5leHRlbmQoCiAgICAvKioKICAgICAqIEBsZW5kcyBBbHBhY2EuRmllbGRzLlRleHRGaWVsZC5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5Db250cm9sRmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBCYXNpYyBjb250cm9sIGZvciBnZW5lcmFsIHRleHQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI3NldHVwCiAgICAgICAgICovCiAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmJhc2UoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghdGhpcy5vcHRpb25zLnNpemUpIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5zaXplID0gNDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuY29udHJvbEZpZWxkVGVtcGxhdGVEZXNjcmlwdG9yID0gdGhpcy52aWV3LmdldFRlbXBsYXRlRGVzY3JpcHRvcigiY29udHJvbEZpZWxkVGV4dCIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2Rlc3Ryb3kKICAgICAgICAgKi8KICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgLy8gY2xlYW4gdXAgdHlwZWFoZWFkCiAgICAgICAgICAgIGlmICggdGhpcy5maWVsZCAmJiB0aGlzLmZpZWxkLnR5cGVhaGVhZCAmJiB0aGlzLm9wdGlvbnMudHlwZWFoZWFkKSB7CiAgICAgICAgICAgICAgICAkKHRoaXMuZmllbGQpLnR5cGVhaGVhZCgnZGVzdHJveScpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI3JlbmRlckZpZWxkCiAgICAgICAgICovCiAgICAgICAgcmVuZGVyRmllbGQ6IGZ1bmN0aW9uKG9uU3VjY2VzcykgewoKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIGlmICh0aGlzLmNvbnRyb2xGaWVsZFRlbXBsYXRlRGVzY3JpcHRvcikgewoKICAgICAgICAgICAgICAgIHRoaXMuZmllbGQgPSBfdGhpcy52aWV3LnRtcGwodGhpcy5jb250cm9sRmllbGRUZW1wbGF0ZURlc2NyaXB0b3IsIHsKICAgICAgICAgICAgICAgICAgICAiaWQiOiB0aGlzLmdldElkKCksCiAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiB0aGlzLm5hbWUsCiAgICAgICAgICAgICAgICAgICAgIm9wdGlvbnMiOiB0aGlzLm9wdGlvbnMKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdGhpcy5pbmplY3RGaWVsZCh0aGlzLmZpZWxkKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9uU3VjY2VzcykgewogICAgICAgICAgICAgICAgb25TdWNjZXNzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIAogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRyb2xGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBtYXNrIGl0CiAgICAgICAgICAgICAgICAgICAgaWYgKCBzZWxmLmZpZWxkICYmIHNlbGYuZmllbGQubWFzayAmJiBzZWxmLm9wdGlvbnMubWFza1N0cmluZykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGQubWFzayhzZWxmLm9wdGlvbnMubWFza1N0cmluZyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyB0eXBlYWhlYWQ/CiAgICAgICAgICAgICAgICAgICAgaWYgKCBzZWxmLmZpZWxkICYmIHNlbGYuZmllbGQudHlwZWFoZWFkICYmIHNlbGYub3B0aW9ucy50eXBlYWhlYWQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdENvbmZpZyA9IHNlbGYub3B0aW9ucy50eXBlYWhlYWQuY29uZmlnOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRDb25maWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRDb25maWcgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHREYXRhc2V0cyA9IHNlbGYub3B0aW9ucy50eXBlYWhlYWQuZGF0YXNldHM7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdERhdGFzZXRzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0RGF0YXNldHMgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0RGF0YXNldHMubmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdERhdGFzZXRzLm5hbWUgPSBzZWxmLmdldElkKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0RXZlbnRzID0gc2VsZi5vcHRpb25zLnR5cGVhaGVhZC5ldmVudHM7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdEV2ZW50cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdEV2ZW50cyA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBzdXBwb3J0IGZvciBlYWNoIGRhdGFzZXRzIChsb2NhbCwgcHJlZmV0Y2gsIHJlbW90ZSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHREYXRhc2V0cy50eXBlID09ICJsb2NhbCIgfHwgdERhdGFzZXRzLnR5cGUgPT0gInJlbW90ZSIgfHwgdERhdGFzZXRzLnR5cGUgPT0gInByZWZldGNoIikKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJsb29kSG91bmRDb25maWcgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0dW1Ub2tlbml6ZXI6IGZ1bmN0aW9uKGQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEJsb29kaG91bmQudG9rZW5pemVycy53aGl0ZXNwYWNlKGQudmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcXVlcnlUb2tlbml6ZXI6IEJsb29kaG91bmQudG9rZW5pemVycy53aGl0ZXNwYWNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0RGF0YXNldHMudHlwZSA9PSAibG9jYWwiICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbG9jYWwgPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0RGF0YXNldHMuc291cmNlLmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxvY2FsRWxlbWVudCA9IHREYXRhc2V0cy5zb3VyY2VbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YobG9jYWxFbGVtZW50KSA9PSAic3RyaW5nIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxFbGVtZW50ID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IGxvY2FsRWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWwucHVzaChsb2NhbEVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxvb2RIb3VuZENvbmZpZy5sb2NhbCA9IGxvY2FsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0RGF0YXNldHMudHlwZSA9PSAicHJlZmV0Y2giKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb29kSG91bmRDb25maWcucHJlZmV0Y2ggPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdERhdGFzZXRzLnNvdXJjZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0RGF0YXNldHMuZmlsdGVyKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxvb2RIb3VuZENvbmZpZy5wcmVmZXRjaC5maWx0ZXIgPSB0RGF0YXNldHMuZmlsdGVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodERhdGFzZXRzLnR5cGUgPT0gInJlbW90ZSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxvb2RIb3VuZENvbmZpZy5yZW1vdGUgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdERhdGFzZXRzLnNvdXJjZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0RGF0YXNldHMuZmlsdGVyKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxvb2RIb3VuZENvbmZpZy5yZW1vdGUuZmlsdGVyID0gdERhdGFzZXRzLmZpbHRlcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0RGF0YXNldHMucmVwbGFjZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb29kSG91bmRDb25maWcucmVtb3RlLnJlcGxhY2UgPSB0RGF0YXNldHMucmVwbGFjZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVuZ2luZSA9IG5ldyBCbG9vZGhvdW5kKGJsb29kSG91bmRDb25maWcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lLmluaXRpYWxpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHREYXRhc2V0cy5zb3VyY2UgPSBlbmdpbmUudHRBZGFwdGVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb21waWxlIHRlbXBsYXRlcwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodERhdGFzZXRzLnRlbXBsYXRlcykKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayBpbiB0RGF0YXNldHMudGVtcGxhdGVzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHREYXRhc2V0cy50ZW1wbGF0ZXNba107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZih0ZW1wbGF0ZSkgPT0gInN0cmluZyIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0RGF0YXNldHMudGVtcGxhdGVzW2tdID0gSGFuZGxlYmFycy5jb21waWxlKHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHByb2Nlc3MgdHlwZWFoZWFkCiAgICAgICAgICAgICAgICAgICAgICAgICQoc2VsZi5maWVsZCkudHlwZWFoZWFkKHRDb25maWcsIHREYXRhc2V0cyk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBsaXN0ZW4gZm9yICJhdXRvY29tcGxldGVkIiBldmVudCBhbmQgc2V0IHRoZSB2YWx1ZSBvZiB0aGUgZmllbGQKICAgICAgICAgICAgICAgICAgICAgICAgJChzZWxmLmZpZWxkKS5vbigidHlwZWFoZWFkOmF1dG9jb21wbGV0ZWQiLCBmdW5jdGlvbihldmVudCwgZGF0dW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2V0VmFsdWUoZGF0dW0udmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxpc3RlbiBmb3IgInNlbGVjdGVkIiBldmVudCBhbmQgc2V0IHRoZSB2YWx1ZSBvZiB0aGUgZmllbGQKICAgICAgICAgICAgICAgICAgICAgICAgJChzZWxmLmZpZWxkKS5vbigidHlwZWFoZWFkOnNlbGVjdGVkIiwgZnVuY3Rpb24oZXZlbnQsIGRhdHVtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNldFZhbHVlKGRhdHVtLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBjdXN0b20gZXZlbnRzCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0RXZlbnRzKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodEV2ZW50cy5hdXRvY29tcGxldGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJChzZWxmLmZpZWxkKS5vbigidHlwZWFoZWFkOmF1dG9jb21wbGV0ZWQiLCBmdW5jdGlvbihldmVudCwgZGF0dW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdEV2ZW50cy5hdXRvY29tcGxldGVkKGV2ZW50LCBkYXR1bSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodEV2ZW50cy5zZWxlY3RlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoc2VsZi5maWVsZCkub24oInR5cGVhaGVhZDpzZWxlY3RlZCIsIGZ1bmN0aW9uKGV2ZW50LCBkYXR1bSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0RXZlbnRzLnNlbGVjdGVkKGV2ZW50LCBkYXR1bSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdoZW4gdGhlIGlucHV0IHZhbHVlIGNoYW5nZXMsIGNoYW5nZSB0aGUgcXVlcnkgaW4gdHlwZWFoZWFkCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgaXMgdG8ga2VlcCB0aGUgdHlwZWFoZWFkIGNvbnRyb2wgc3luYydkIHdpdGggdGhlIGFjdHVhbCBkb20gdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgLy8gb25seSBkbyB0aGlzIGlmIHRoZSBxdWVyeSBkb2Vzbid0IGFscmVhZHkgbWF0Y2gKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZpID0gJChzZWxmLmZpZWxkKTsKICAgICAgICAgICAgICAgICAgICAgICAgJChzZWxmLmZpZWxkKS5jaGFuZ2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gJCh0aGlzKS52YWwoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3VmFsdWUgPSAkKGZpKS50eXBlYWhlYWQoJ3ZhbCcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ld1ZhbHVlICE9IHZhbHVlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoZmkpLnR5cGVhaGVhZCgndmFsJywgbmV3VmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLXRleHQnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgfSk7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldFZhbHVlCiAgICAgICAgICovCiAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBudWxsOwogICAgICAgICAgICBpZiAodGhpcy5maWVsZCkgewogICAgICAgICAgICAgICAgdmFsdWUgPSB0aGlzLmZpZWxkLnZhbCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFsdWUgPSB0aGlzLmJhc2UoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjc2V0VmFsdWUKICAgICAgICAgKi8KICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKCiAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkodmFsdWUpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGQudmFsKCIiKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdXNpbmcgdHlwZWFoZWFkLCBzZXQgdXNpbmcgdHlwZWFoZWFkIGNvbnRyb2wKICAgICAgICAgICAgICAgICAgICBpZiAoIHRoaXMuZmllbGQgJiYgdGhpcy5maWVsZC50eXBlYWhlYWQgJiYgdGhpcy5vcHRpb25zLnR5cGVhaGVhZCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcy5maWVsZCkudHlwZWFoZWFkKCd2YWwnLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGQudmFsKHZhbHVlKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdXNpbmcgdHlwZWFoZWFkLCBzZXQgdXNpbmcgdHlwZWFoZWFkIGNvbnRyb2wKICAgICAgICAgICAgICAgICAgICBpZiAoIHRoaXMuZmllbGQgJiYgdGhpcy5maWVsZC50eXBlYWhlYWQgJiYgdGhpcy5vcHRpb25zLnR5cGVhaGVhZCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcy5maWVsZCkudHlwZWFoZWFkKCd2YWwnLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBiZSBzdXJlIHRvIGNhbGwgaW50byBiYXNlIG1ldGhvZAogICAgICAgICAgICB0aGlzLmJhc2UodmFsdWUpOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2hhbmRsZVZhbGlkYXRlCiAgICAgICAgICovCiAgICAgICAgaGFuZGxlVmFsaWRhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYmFzZVN0YXR1cyA9IHRoaXMuYmFzZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHZhbEluZm8gPSB0aGlzLnZhbGlkYXRpb247CgkJCQoJCQl2YXIgc3RhdHVzID0gIHRoaXMuX3ZhbGlkYXRlUGF0dGVybigpOwogICAgICAgICAgICB2YWxJbmZvWyJpbnZhbGlkUGF0dGVybiJdID0gewogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiBzdGF0dXMgPyAiIiA6IEFscGFjYS5zdWJzdGl0dXRlVG9rZW5zKHRoaXMudmlldy5nZXRNZXNzYWdlKCJpbnZhbGlkUGF0dGVybiIpLCBbdGhpcy5zY2hlbWEucGF0dGVybl0pLAogICAgICAgICAgICAgICAgInN0YXR1cyI6IHN0YXR1cwogICAgICAgICAgICB9OwogCiAgICAgICAgICAgIHN0YXR1cyA9IHRoaXMuX3ZhbGlkYXRlTWF4TGVuZ3RoKCk7CgkJCXZhbEluZm9bInN0cmluZ1Rvb0xvbmciXSA9IHsKICAgICAgICAgICAgICAgICJtZXNzYWdlIjogc3RhdHVzID8gIiIgOiBBbHBhY2Euc3Vic3RpdHV0ZVRva2Vucyh0aGlzLnZpZXcuZ2V0TWVzc2FnZSgic3RyaW5nVG9vTG9uZyIpLCBbdGhpcy5zY2hlbWEubWF4TGVuZ3RoXSksCiAgICAgICAgICAgICAgICAic3RhdHVzIjogc3RhdHVzCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBzdGF0dXMgPSB0aGlzLl92YWxpZGF0ZU1pbkxlbmd0aCgpOwoJCQl2YWxJbmZvWyJzdHJpbmdUb29TaG9ydCJdID0gewogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiBzdGF0dXMgPyAiIiA6IEFscGFjYS5zdWJzdGl0dXRlVG9rZW5zKHRoaXMudmlldy5nZXRNZXNzYWdlKCJzdHJpbmdUb29TaG9ydCIpLCBbdGhpcy5zY2hlbWEubWluTGVuZ3RoXSksCiAgICAgICAgICAgICAgICAic3RhdHVzIjogc3RhdHVzCiAgICAgICAgICAgIH07CgogICAgICAgICAgICByZXR1cm4gYmFzZVN0YXR1cyAmJiB2YWxJbmZvWyJpbnZhbGlkUGF0dGVybiJdWyJzdGF0dXMiXSAmJiB2YWxJbmZvWyJzdHJpbmdUb29Mb25nIl1bInN0YXR1cyJdICYmIHZhbEluZm9bInN0cmluZ1Rvb1Nob3J0Il1bInN0YXR1cyJdOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaWRhdGVzIGFnYWluc3QgdGhlIHNjaGVtYSBwYXR0ZXJuIHByb3BlcnR5LgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgaXQgbWF0Y2hlcyB0aGUgcGF0dGVybiwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZVBhdHRlcm46IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5zY2hlbWEucGF0dGVybikgewogICAgICAgICAgICAgICAgdmFyIHZhbCA9IHRoaXMuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgICAgIGlmICh2YWwgPT09ICIiICYmIHRoaXMub3B0aW9ucy5hbGxvd09wdGlvbmFsRW1wdHkgJiYgIXRoaXMuc2NoZW1hLnJlcXVpcmVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkodmFsKSkgewogICAgICAgICAgICAgICAgICAgIHZhbCA9ICIiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCF2YWwubWF0Y2godGhpcy5zY2hlbWEucGF0dGVybikpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaWRhdGVzIGFnYWluc3QgdGhlIHNjaGVtYSBtaW5MZW5ndGggcHJvcGVydHkuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZiBpdHMgc2l6ZSBpcyBncmVhdGVyIHRoYW4gbWluTGVuZ3RoLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgX3ZhbGlkYXRlTWluTGVuZ3RoOiBmdW5jdGlvbigpIHsKCQkJaWYgKCFBbHBhY2EuaXNFbXB0eSh0aGlzLnNjaGVtYS5taW5MZW5ndGgpKSB7CgkJCQl2YXIgdmFsID0gdGhpcy5nZXRWYWx1ZSgpOwogICAgICAgICAgICAgICAgaWYgKHZhbCA9PT0gIiIgJiYgdGhpcy5vcHRpb25zLmFsbG93T3B0aW9uYWxFbXB0eSAmJiAhdGhpcy5zY2hlbWEucmVxdWlyZWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNFbXB0eSh2YWwpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsID0gIiI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodmFsLmxlbmd0aCA8IHRoaXMuc2NoZW1hLm1pbkxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCQkJfQoJCQlyZXR1cm4gdHJ1ZTsKCQl9LAogICAgICAgIAogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlcyBhZ2FpbnN0IHRoZSBzY2hlbWEgbWF4TGVuZ3RoIHByb3BlcnR5LgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgaXRzIHNpemUgaXMgbGVzcyB0aGFuIG1heExlbmd0aCAsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgKi8KICAgICAgICBfdmFsaWRhdGVNYXhMZW5ndGg6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIUFscGFjYS5pc0VtcHR5KHRoaXMuc2NoZW1hLm1heExlbmd0aCkpIHsKCQkJCXZhciB2YWwgPSB0aGlzLmdldFZhbHVlKCk7CiAgICAgICAgICAgICAgICBpZiAodmFsID09PSAiIiAmJiB0aGlzLm9wdGlvbnMuYWxsb3dPcHRpb25hbEVtcHR5ICYmICF0aGlzLnNjaGVtYS5yZXF1aXJlZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKEFscGFjYS5pc0VtcHR5KHZhbCkpIHsKICAgICAgICAgICAgICAgICAgICB2YWwgPSAiIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh2YWwubGVuZ3RoID4gdGhpcy5zY2hlbWEubWF4TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQoJCQl9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZGlzYWJsZQogICAgICAgICAqLwogICAgICAgIGRpc2FibGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5maWVsZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5maWVsZC5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIAogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2VuYWJsZQogICAgICAgICAqLwogICAgICAgIGVuYWJsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLmRpc2FibGVkID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIAogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2ZvY3VzCiAgICAgICAgICovCiAgICAgICAgZm9jdXM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5maWVsZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5maWVsZC5mb2N1cygpOwogICAgICAgICAgICB9CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjZ2V0U2NoZW1hT2ZTY2hlbWEKICAgICAgICAgKi8KICAgICAgICBnZXRTY2hlbWFPZlNjaGVtYTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogeyAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAibWluTGVuZ3RoIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiTWluaW1hbCBMZW5ndGgiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiTWluaW1hbCBsZW5ndGggb2YgdGhlIHByb3BlcnR5IHZhbHVlLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm51bWJlciIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJtYXhMZW5ndGgiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJNYXhpbXVtIExlbmd0aCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJNYXhpbXVtIGxlbmd0aCBvZiB0aGUgcHJvcGVydHkgdmFsdWUuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibnVtYmVyIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInBhdHRlcm4iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJQYXR0ZXJuIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlJlZ3VsYXIgZXhwcmVzc2lvbiBmb3IgdGhlIHByb3BlcnR5IHZhbHVlLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2dldE9wdGlvbnNGb3JTY2hlbWEKICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yU2NoZW1hOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgImZpZWxkcyI6IHsKICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgImhlbHBlciI6ICJGaWVsZCBkZWZhdWx0IHZhbHVlIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJtaW5MZW5ndGgiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAibWF4TGVuZ3RoIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInBhdHRlcm4iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRleHQiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoJCQogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2dldFNjaGVtYU9mT3B0aW9ucwogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogeyAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAic2l6ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZpZWxkIFNpemUiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRmllbGQgc2l6ZS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJudW1iZXIiLAoJCQkJCQkiZGVmYXVsdCI6NDAKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJtYXNrU3RyaW5nIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiTWFzayBFeHByZXNzaW9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkV4cHJlc3Npb24gZm9yIHRoZSBmaWVsZCBtYXNrLiBGaWVsZCBtYXNraW5nIHdpbGwgYmUgZW5hYmxlZCBpZiBub3QgZW1wdHkuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInBsYWNlaG9sZGVyIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRmllbGQgUGxhY2Vob2xkZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRmllbGQgcGxhY2Vob2xkZXIuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInR5cGVhaGVhZCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlR5cGUgQWhlYWQiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiUHJvdmlkZXMgY29uZmlndXJhdGlvbiBmb3IgdGhlICQudHlwZWFoZWFkIHBsdWdpbiBpZiBpdCBpcyBhdmFpbGFibGUuICBGb3IgZnVsbCBjb25maWd1cmF0aW9uIG9wdGlvbnMsIHNlZTogaHR0cHM6Ly9naXRodWIuY29tL3R3aXR0ZXIvdHlwZWFoZWFkLmpzIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImFsbG93T3B0aW9uYWxFbXB0eSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkFsbG93IE9wdGlvbmFsIEVtcHR5IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkFsbG93cyB0aGlzIG5vbi1yZXF1aXJlZCBmaWVsZCB0byB2YWxpZGF0ZSB3aGVuIHRoZSB2YWx1ZSBpcyBlbXB0eSIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sICAgIAoJCQogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2dldE9wdGlvbnNGb3JPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0Zvck9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAiZmllbGRzIjogeyAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAic2l6ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJtYXNrU3RyaW5nIjogewogICAgICAgICAgICAgICAgICAgICAgICAiaGVscGVyIjogImEgLSBhbiBhbHBoYSBjaGFyYWN0ZXI7OSAtIGEgbnVtZXJpYyBjaGFyYWN0ZXI7KiAtIGFuIGFscGhhbnVtZXJpYyBjaGFyYWN0ZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInR5cGVhaGVhZCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAib2JqZWN0IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImFsbG93T3B0aW9uYWxFbXB0eSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiY2hlY2tib3giCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LCAgICAKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZ2V0VGl0bGUKICAgICAgICAgKi8KICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiU2luZ2xlLUxpbmUgVGV4dCI7CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJUZXh0IGZpZWxkIGZvciBzaW5nbGUtbGluZSB0ZXh0LiI7CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0VHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAic3RyaW5nIjsKICAgICAgICB9LAoJCQogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAidGV4dCI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICAgICAgCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJUZW1wbGF0ZSgiY29udHJvbEZpZWxkVGV4dCIsICc8aW5wdXQgdHlwZT0idGV4dCIgaWQ9IiR7aWR9IiB7e2lmIG9wdGlvbnMucGxhY2Vob2xkZXJ9fXBsYWNlaG9sZGVyPSIke29wdGlvbnMucGxhY2Vob2xkZXJ9Int7L2lmfX0ge3tpZiBvcHRpb25zLnNpemV9fXNpemU9IiR7b3B0aW9ucy5zaXplfSJ7ey9pZn19IHt7aWYgb3B0aW9ucy5yZWFkb25seX19cmVhZG9ubHk9InJlYWRvbmx5Int7L2lmfX0ge3tpZiBuYW1lfX1uYW1lPSIke25hbWV9Int7L2lmfX0ge3tlYWNoKGksdikgb3B0aW9ucy5kYXRhfX1kYXRhLSR7aX09IiR7dn0ie3svZWFjaH19Lz4nKTsKICAgIEFscGFjYS5yZWdpc3Rlck1lc3NhZ2VzKHsKICAgICAgICAiaW52YWxpZFBhdHRlcm4iOiAiVGhpcyBmaWVsZCBzaG91bGQgaGF2ZSBwYXR0ZXJuIHswfSIsCiAgICAgICAgInN0cmluZ1Rvb1Nob3J0IjogIlRoaXMgZmllbGQgc2hvdWxkIGNvbnRhaW4gYXQgbGVhc3QgezB9IG51bWJlcnMgb3IgY2hhcmFjdGVycyIsCiAgICAgICAgInN0cmluZ1Rvb0xvbmciOiAiVGhpcyBmaWVsZCBzaG91bGQgY29udGFpbiBhdCBtb3N0IHswfSBudW1iZXJzIG9yIGNoYXJhY3RlcnMiCiAgICB9KTsKICAgIEFscGFjYS5yZWdpc3RlckZpZWxkQ2xhc3MoInRleHQiLCBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCk7CiAgICBBbHBhY2EucmVnaXN0ZXJEZWZhdWx0U2NoZW1hRmllbGRNYXBwaW5nKCJzdHJpbmciLCAidGV4dCIpOwp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLlRleHRBcmVhRmllbGQgPSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZC5leHRlbmQoCiAgICAvKioKICAgICAqIEBsZW5kcyBBbHBhY2EuRmllbGRzLlRleHRBcmVhRmllbGQucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuRmllbGRzLlRleHRGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIFRleHRhcmVhIGNvbnRyb2wgZm9yIGNodW5rIG9mIHRleHQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjc2V0dXAKICAgICAgICAgKi8KICAgICAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMucm93cykgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLnJvd3MgPSA1OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5jb2xzKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuY29scyA9IDQwOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmNvbnRyb2xGaWVsZFRlbXBsYXRlRGVzY3JpcHRvciA9IHRoaXMudmlldy5nZXRUZW1wbGF0ZURlc2NyaXB0b3IoImNvbnRyb2xGaWVsZFRleHRhcmVhIik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtdGV4dGFyZWEnKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjaGFuZGxlVmFsaWRhdGUKICAgICAgICAgKi8KICAgICAgICBoYW5kbGVWYWxpZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBiYXNlU3RhdHVzID0gdGhpcy5iYXNlKCk7CgogICAgICAgICAgICB2YXIgdmFsSW5mbyA9IHRoaXMudmFsaWRhdGlvbjsKCiAgICAgICAgICAgIHZhciBzdGF0dXMgPSAgdGhpcy5fdmFsaWRhdGVXb3JkQ291bnQoKTsKICAgICAgICAgICAgdmFsSW5mb1sid29yZExpbWl0RXhjZWVkZWQiXSA9IHsKICAgICAgICAgICAgICAgICJtZXNzYWdlIjogc3RhdHVzID8gIiIgOiBBbHBhY2Euc3Vic3RpdHV0ZVRva2Vucyh0aGlzLnZpZXcuZ2V0TWVzc2FnZSgid29yZExpbWl0RXhjZWVkZWQiKSwgW3RoaXMub3B0aW9ucy53b3JkbGltaXRdKSwKICAgICAgICAgICAgICAgICJzdGF0dXMiOiBzdGF0dXMKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBiYXNlU3RhdHVzICYmIHZhbEluZm9bIndvcmRMaW1pdEV4Y2VlZGVkIl1bInN0YXR1cyJdOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlIGZvciB3b3JkIGxpbWl0LgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgdGhlIG51bWJlciBvZiB3b3JkcyBpcyBlcXVhbCB0byBvciBsZXNzIHRoYW4gdGhlIHdvcmQgbGltaXQuCiAgICAgICAgICovCiAgICAgICAgX3ZhbGlkYXRlV29yZENvdW50OiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMud29yZGxpbWl0ICYmIHRoaXMub3B0aW9ucy53b3JkbGltaXQgPiAtMSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHZhbCA9IHRoaXMuZGF0YTsKCiAgICAgICAgICAgICAgICBpZiAodmFsKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciB3b3JkY291bnQgPSB2YWwuc3BsaXQoIiAiKS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdvcmRjb3VudCA+IHRoaXMub3B0aW9ucy53b3JkbGltaXQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICpAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI3NldFZhbHVlCiAgICAgICAgICovCiAgICAgICAgc2V0VmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICQodGhpcy5maWVsZCkudmFsKHZhbHVlKTsKCiAgICAgICAgICAgIC8vIGJlIHN1cmUgdG8gY2FsbCBpbnRvIGJhc2UgbWV0aG9kCiAgICAgICAgICAgIHRoaXMuYmFzZSh2YWx1ZSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRWYWx1ZQogICAgICAgICAqLwogICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICQodGhpcy5maWVsZCkudmFsKCk7CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRTY2hlbWFPZk9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRTY2hlbWFPZk9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAicm93cyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlJvd3MiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiTnVtYmVyIG9mIHJvd3MiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJudW1iZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IDUKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJjb2xzIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiQ29sdW1ucyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJOdW1iZXIgb2YgY29sdW1ucyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm51bWJlciIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogNDAKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJ3b3JkbGltaXQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJXb3JkIExpbWl0IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkxpbWl0cyB0aGUgbnVtYmVyIG9mIHdvcmRzIGFsbG93ZWQgaW4gdGhlIHRleHQgYXJlYS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJudW1iZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IC0xCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0T3B0aW9uc0Zvck9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgInJvd3MiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiY29scyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJ3b3JkbGltaXQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFRpdGxlCiAgICAgICAgICovCiAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIk11bHRpLUxpbmUgVGV4dCI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJUZXh0YXJlYSBmaWVsZCBmb3IgbXVsdGlwbGUgbGluZSB0ZXh0LiI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRGaWVsZFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gInRleHRhcmVhIjsKICAgICAgICB9Ly9fX0VORF9PRl9CVUlMREVSX0hFTFBFUlMKCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJNZXNzYWdlcyh7CiAgICAgICAgIndvcmRMaW1pdEV4Y2VlZGVkIjogIlRoZSBtYXhpbXVtIHdvcmQgbGltaXQgb2YgezB9IGhhcyBiZWVuIGV4Y2VlZGVkLiIKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3RlclRlbXBsYXRlKCJjb250cm9sRmllbGRUZXh0YXJlYSIsICc8dGV4dGFyZWEgaWQ9IiR7aWR9IiB7e2lmIG9wdGlvbnMucGxhY2Vob2xkZXJ9fXBsYWNlaG9sZGVyPSIke29wdGlvbnMucGxhY2Vob2xkZXJ9Int7L2lmfX0ge3tpZiBvcHRpb25zLnJvd3N9fXJvd3M9IiR7b3B0aW9ucy5yb3dzfSJ7ey9pZn19IHt7aWYgb3B0aW9ucy5jb2xzfX1jb2xzPSIke29wdGlvbnMuY29sc30ie3svaWZ9fSB7e2lmIG9wdGlvbnMucmVhZG9ubHl9fXJlYWRvbmx5PSJyZWFkb25seSJ7ey9pZn19IHt7aWYgbmFtZX19bmFtZT0iJHtuYW1lfSJ7ey9pZn19IHt7ZWFjaCBvcHRpb25zLmRhdGF9fWRhdGEtJHtmaWVsZElkfT0iJHt2YWx1ZX0ie3svZWFjaH19Lz4nKTsKICAgIEFscGFjYS5yZWdpc3RlckZpZWxkQ2xhc3MoInRleHRhcmVhIiwgQWxwYWNhLkZpZWxkcy5UZXh0QXJlYUZpZWxkKTsKCn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuQ2hlY2tCb3hGaWVsZCA9IEFscGFjYS5Db250cm9sRmllbGQuZXh0ZW5kKAogICAgICAgIC8qKgogICAgICAgICAqIEBsZW5kcyBBbHBhY2EuRmllbGRzLkNoZWNrQm94RmllbGQucHJvdG90eXBlCiAgICAgICAgICovCiAgICAgICAgewogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5Db250cm9sRmllbGQKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGNsYXNzIENoZWNrYm94IGNvbnRyb2wgZm9yIEpTT04gc2NoZW1hIGJvb2xlYW4gdHlwZS4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNzZXR1cAogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICAgICAgX3RoaXMuYmFzZSgpOwoKICAgICAgICAgICAgICAgIGlmICghdGhpcy5vcHRpb25zLnJpZ2h0TGFiZWwpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMucmlnaHRMYWJlbCA9ICIiOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YoX3RoaXMub3B0aW9ucy5tdWx0aXBsZSkgPT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKF90aGlzLnNjaGVtYS50eXBlID09ICJhcnJheSIpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5vcHRpb25zLm11bHRpcGxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodHlwZW9mKF90aGlzLnNjaGVtYVsiZW51bSJdKSAhPSAidW5kZWZpbmVkIikKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLm9wdGlvbnMubXVsdGlwbGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBfdGhpcy5jaGVja2JveE9wdGlvbnMgPSBbXTsKICAgICAgICAgICAgICAgIGlmIChfdGhpcy5vcHRpb25zLm11bHRpcGxlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICQuZWFjaChfdGhpcy5nZXRFbnVtKCksIGZ1bmN0aW9uKGluZGV4LCB2YWx1ZSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRleHQgPSB2YWx1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfdGhpcy5vcHRpb25zLm9wdGlvbkxhYmVscykKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eShfdGhpcy5vcHRpb25zLm9wdGlvbkxhYmVsc1tpbmRleF0pKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQgPSBfdGhpcy5vcHRpb25zLm9wdGlvbkxhYmVsc1tpbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICghQWxwYWNhLmlzRW1wdHkoX3RoaXMub3B0aW9ucy5vcHRpb25MYWJlbHNbdmFsdWVdKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gX3RoaXMub3B0aW9ucy5vcHRpb25MYWJlbHNbdmFsdWVdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jaGVja2JveE9wdGlvbnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidmFsdWUiOiB2YWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0ZXh0IjogdGV4dAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBHZXRzIHNjaGVtYSBlbnVtIHByb3BlcnR5LgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcmV0dXJucyB7QXJyYXl8U3RyaW5nfSBGaWVsZCBzY2hlbWEgZW51bSBwcm9wZXJ0eS4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldEVudW06IGZ1bmN0aW9uKCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGFycmF5ID0gW107CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2NoZW1hICYmIHRoaXMuc2NoZW1hWyJlbnVtIl0pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXkgPSB0aGlzLnNjaGVtYVsiZW51bSJdOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBhcnJheTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBIYW5kbGVyIGZvciB0aGUgZXZlbnQgdGhhdCB0aGUgY2hlY2tib3ggaXMgY2xpY2tlZC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIGUgRXZlbnQuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBvbkNsaWNrOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlZnJlc2hWYWxpZGF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjcmVuZGVyRmllbGQKICAgICAgICAgICAgICovCiAgICAgICAgICAgIHJlbmRlckZpZWxkOiBmdW5jdGlvbihvblN1Y2Nlc3MpIHsKCiAgICAgICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgICAgIHZhciBjb250cm9sRmllbGRUZW1wbGF0ZURlc2NyaXB0b3IgPSBudWxsOwoKICAgICAgICAgICAgICAgIC8vIGVpdGhlciB1c2UgdGhlIHNpbmdsZSB0ZW1wbGF0ZSBvciB0aGUgbXVsdGlwbGUgdGVtcGxhdGUKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMubXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgICBjb250cm9sRmllbGRUZW1wbGF0ZURlc2NyaXB0b3IgPSB0aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJjb250cm9sRmllbGRDaGVja2JveE11bHRpcGxlIik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbnRyb2xGaWVsZFRlbXBsYXRlRGVzY3JpcHRvciA9IHRoaXMudmlldy5nZXRUZW1wbGF0ZURlc2NyaXB0b3IoImNvbnRyb2xGaWVsZENoZWNrYm94Iik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGNvbnRyb2xGaWVsZFRlbXBsYXRlRGVzY3JpcHRvcikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZpZWxkID0gX3RoaXMudmlldy50bXBsKGNvbnRyb2xGaWVsZFRlbXBsYXRlRGVzY3JpcHRvciwgewogICAgICAgICAgICAgICAgICAgICAgICAiaWQiOiB0aGlzLmdldElkKCksCiAgICAgICAgICAgICAgICAgICAgICAgICJuYW1lIjogdGhpcy5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAib3B0aW9ucyI6IHRoaXMub3B0aW9ucywKICAgICAgICAgICAgICAgICAgICAgICAgImNoZWNrYm94T3B0aW9ucyI6IF90aGlzLmNoZWNrYm94T3B0aW9ucwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuaW5qZWN0RmllbGQodGhpcy5maWVsZCk7CiAgICAgICAgICAgICAgICAgICAgLy90aGlzLmZpZWxkID0gJCgnaW5wdXRbaWQ9IicgKyB0aGlzLmdldElkKCkgKyAnIl0nLCB0aGlzLmZpZWxkKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gZG8gdGhpcyBsaXR0bGUgdHJpY2sgc28gdGhhdCBpZiB3ZSBoYXZlIGEgZGVmYXVsdCB2YWx1ZSwgaXQgZ2V0cyBzZXQgZHVyaW5nIGZpcnN0IHJlbmRlcgogICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgY2F1c2VzIHRoZSBjaGVja2VkIHN0YXRlIG9mIHRoZSBjb250cm9sIHRvIHVwZGF0ZQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhdGEgJiYgdHlwZW9mKHRoaXMuZGF0YSkgIT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFZhbHVlKHRoaXMuZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChvblN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICBvblN1Y2Nlc3MoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjcG9zdFJlbmRlcgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICAgICAgdGhpcy5iYXNlKGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLWNoZWNrYm94Jyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyB3aGVuZXZlciB0aGUgc3RhdGUgb2Ygb25lIG9mIG91ciBpbnB1dDpjaGVja2JveCBjb250cm9scyBpcyBjaGFuZ2VkIChlaXRoZXIgdmlhIGEgY2xpY2sgb3IgcHJvZ3JhbW1hdGljYWxseSksCiAgICAgICAgICAgICAgICAgICAgLy8gd2Ugc2lnbmFsIHRvIHRoZSB0b3AtbGV2ZWwgZmllbGQgdG8gZmlyZSB1cCBhIGNoYW5nZQogICAgICAgICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyBhbGxvd3MgdGhlIGRlcGVuZGVuY3kgc3lzdGVtIHRvIHJlY2FsY3VsYXRlIGFuZCBzdWNoCiAgICAgICAgICAgICAgICAgICAgLy8KICAgICAgICAgICAgICAgICAgICAkKHNlbGYuZmllbGQpLmZpbmQoImlucHV0OmNoZWNrYm94IikuY2hhbmdlKGZ1bmN0aW9uKGV2dCkgewogICAgICAgICAgICAgICAgICAgICAgICAkKHNlbGYuZmllbGQpLnRyaWdnZXIoImNoYW5nZSIpOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZ2V0VmFsdWUKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gbnVsbDsKCiAgICAgICAgICAgICAgICBpZiAoIXNlbGYub3B0aW9ucy5tdWx0aXBsZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBzaW5nbGUgc2NhbGFyIHZhbHVlCiAgICAgICAgICAgICAgICAgICAgdmFyIGlucHV0ID0gJChzZWxmLmZpZWxkKS5maW5kKCJpbnB1dCIpOwogICAgICAgICAgICAgICAgICAgIGlmIChpbnB1dC5sZW5ndGggPiAwKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBBbHBhY2EuY2hlY2tlZCgkKGlucHV0WzBdKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIG11bHRpcGxlIHZhbHVlcwogICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNlbGYuY2hlY2tib3hPcHRpb25zLmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlucHV0ID0gJChzZWxmLmZpZWxkKS5maW5kKCJpbnB1dFtkYXRhLWNoZWNrYm94LWluZGV4PSciICsgaSArICInXSIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmNoZWNrZWQoaW5wdXQpKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdiA9ICQoaW5wdXQpLmF0dHIoImRhdGEtY2hlY2tib3gtdmFsdWUiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKHYpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBkZXRlcm1pbmUgaG93IHdlJ3JlIGdvaW5nIHRvIGhhbmQgdGhpcyB2YWx1ZSBiYWNrCgogICAgICAgICAgICAgICAgICAgIC8vIGlmIHR5cGUgPT0gImFycmF5Iiwgd2UganVzdCBoYW5kIGJhY2sgdGhlIGFycmF5CiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdHlwZSA9PSAic3RyaW5nIiwgd2UgYnVpbGQgYSBjb21tYS1kZWxpbWl0ZWQgbGlzdAogICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLnNjaGVtYS50eXBlID09ICJhcnJheSIpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlczsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoc2VsZi5zY2hlbWEudHlwZSA9PSAic3RyaW5nIikKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWVzLmpvaW4oIiwiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI3NldFZhbHVlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24odmFsdWUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgICAgICAvLyB2YWx1ZSBjYW4gYmUgYSBib29sZWFuLCBzdHJpbmcgKCJ0cnVlIiksIHN0cmluZyAoImEsYixjIikgb3IgYW4gYXJyYXkgb2YgdmFsdWVzCgogICAgICAgICAgICAgICAgdmFyIGFwcGx5U2NhbGFyVmFsdWUgPSBmdW5jdGlvbih2YWx1ZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzU3RyaW5nKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9ICh2YWx1ZSA9PT0gInRydWUiKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9ICQoc2VsZi5maWVsZCkuZmluZCgiaW5wdXQiKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5wdXQubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIEFscGFjYS5jaGVja2VkKCQoaW5wdXRbMF0pLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICB2YXIgYXBwbHlNdWx0aVZhbHVlID0gZnVuY3Rpb24odmFsdWVzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIGFsbG93IGZvciBjb21tYS1kZWxpbWl0ZWQgc3RyaW5ncwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YodmFsdWVzKSA9PSAic3RyaW5nIikKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlcyA9IHZhbHVlcy5zcGxpdCgiLCIpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gdHJpbSB0aGluZ3MgdG8gcmVtb3ZlIGFueSBleGNlc3Mgd2hpdGUgc3BhY2UKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZhbHVlcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlc1tpXSA9IEFscGFjYS50cmltKHZhbHVlc1tpXSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyB3YWxrIHRocm91Z2ggdmFsdWVzIGFuZCBhc3NpZ24gaW50byBhcHByb3ByaWF0ZSBpbnB1dHMKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZhbHVlcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9ICQoc2VsZi5maWVsZCkuZmluZCgiaW5wdXRbZGF0YS1jaGVja2JveC12YWx1ZT0nIiArIHZhbHVlc1tpXSArICInXSIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5wdXQubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgQWxwYWNhLmNoZWNrZWQoJChpbnB1dFswXSksIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgdmFyIGFwcGxpZWQgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICBpZiAoIXNlbGYub3B0aW9ucy5tdWx0aXBsZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBzaW5nbGUgdmFsdWUgbW9kZQoKICAgICAgICAgICAgICAgICAgICAvLyBib29sZWFuCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZih2YWx1ZSkgPT0gImJvb2xlYW4iKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXBwbHlTY2FsYXJWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGxpZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0eXBlb2YodmFsdWUpID09ICJzdHJpbmciKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXBwbHlTY2FsYXJWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGxpZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBtdWx0aXBsZSB2YWx1ZSBtb2RlCgogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YodmFsdWUpID09ICJzdHJpbmciKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXBwbHlNdWx0aVZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgYXBwbGllZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKEFscGFjYS5pc0FycmF5KHZhbHVlKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGx5TXVsdGlWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGxpZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIWFwcGxpZWQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgQWxwYWNhLmxvZ0Vycm9yKCJDaGVja2JveEZpZWxkIGNhbm5vdCBzZXQgdmFsdWUgZm9yIHNjaGVtYS50eXBlPSIgKyBzZWxmLnNjaGVtYS50eXBlICsgIiBhbmQgdmFsdWU9IiArIHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBiZSBzdXJlIHRvIGNhbGwgaW50byBiYXNlIG1ldGhvZAogICAgICAgICAgICAgICAgdGhpcy5iYXNlKHZhbHVlKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBWYWxpZGF0ZSBhZ2FpbnN0IGVudW0gcHJvcGVydHkgaW4gdGhlIGNhc2UgdGhhdCB0aGUgY2hlY2tib3ggZmllbGQgaXMgaW4gbXVsdGlwbGUgbW9kZS4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgdGhlIGVsZW1lbnQgdmFsdWUgaXMgcGFydCBvZiB0aGUgZW51bSBsaXN0LCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBfdmFsaWRhdGVFbnVtOiBmdW5jdGlvbigpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgICAgICBpZiAoIXNlbGYub3B0aW9ucy5tdWx0aXBsZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgdmFsID0gc2VsZi5nZXRWYWx1ZSgpOwogICAgICAgICAgICAgICAgaWYgKCFzZWxmLnNjaGVtYS5yZXF1aXJlZCAmJiBBbHBhY2EuaXNWYWxFbXB0eSh2YWwpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGlmIHZhbCBpcyBhIHN0cmluZywgY29udmVydCB0byBhcnJheQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZih2YWwpID09ICJzdHJpbmciKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhbCA9IHZhbC5zcGxpdCgiLCIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBBbHBhY2EuYW55RXF1YWxpdHkodmFsLCBzZWxmLnNjaGVtYVsiZW51bSJdKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNkaXNhYmxlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBkaXNhYmxlOiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAkKHRoaXMuZmllbGQpLmZpbmQoImlucHV0IikuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNlbmFibGUKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGVuYWJsZTogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgJCh0aGlzLmZpZWxkKS5maW5kKCJpbnB1dCIpLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5kaXNhYmxlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB9LC8vX19CVUlMREVSX0hFTFBFUlMKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjZ2V0U2NoZW1hT2ZPcHRpb25zCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBnZXRTY2hlbWFPZk9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICAgICAicmlnaHRMYWJlbCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJPcHRpb24gTGFiZWwiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIk9wdGlvbmFsIHJpZ2h0LWhhbmQgc2lkZSBsYWJlbCBmb3Igc2luZ2xlIGNoZWNrYm94IGZpZWxkLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICJtdWx0aXBsZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJNdWx0aXBsZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiV2hldGhlciB0byByZW5kZXIgbXVsdGlwbGUgY2hlY2tib3hlcyBmb3IgbXVsdGktdmFsdWVkIHR5cGUgKHN1Y2ggYXMgYW4gYXJyYXkgb3IgYSBjb21tYS1kZWxpbWl0ZWQgc3RyaW5nKSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2dldE9wdGlvbnNGb3JPcHRpb25zCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAgICAgImZpZWxkcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInJpZ2h0TGFiZWwiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAibXVsdGlwbGUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldFRpdGxlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIkNoZWNrYm94IEZpZWxkIjsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZ2V0RGVzY3JpcHRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuICJDaGVja2JveCBGaWVsZCBmb3IgYm9vbGVhbiAodHJ1ZS9mYWxzZSksIHN0cmluZyAoJ3RydWUnLCAnZmFsc2UnIG9yIGNvbW1hLWRlbGltaXRlZCBzdHJpbmcgb2YgdmFsdWVzKSBvciBkYXRhIGFycmF5LiI7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZ2V0VHlwZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZ2V0VHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gImJvb2xlYW4iOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiY2hlY2tib3giOwogICAgICAgICAgICB9Ly9fX0VORF9PRl9CVUlMREVSX0hFTFBFUlMKCiAgICAgICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyVGVtcGxhdGUoImNvbnRyb2xGaWVsZENoZWNrYm94IiwgJzxzcGFuIGlkPSIke2lkfSI+e3tpZiBvcHRpb25zLnJpZ2h0TGFiZWx9fTxsYWJlbCBjbGFzcz0iYWxwYWNhLWNvbnRyb2xmaWVsZC1sYWJlbCIgZm9yPSIke2lkfV9jaGVja2JveCI+e3svaWZ9fTxpbnB1dCBpZD0iJHtpZH1fY2hlY2tib3giIHR5cGU9ImNoZWNrYm94IiB7e2lmIG9wdGlvbnMucmVhZG9ubHl9fXJlYWRvbmx5PSJyZWFkb25seSJ7ey9pZn19IHt7aWYgbmFtZX19bmFtZT0iJHtuYW1lfSJ7ey9pZn19IHt7ZWFjaChpLHYpIG9wdGlvbnMuZGF0YX19ZGF0YS0ke2l9PSIke3Z9Int7L2VhY2h9fS8+e3tpZiBvcHRpb25zLnJpZ2h0TGFiZWx9fSR7b3B0aW9ucy5yaWdodExhYmVsfTwvbGFiZWw+e3svaWZ9fTwvc3Bhbj4nKTsKICAgIEFscGFjYS5yZWdpc3RlclRlbXBsYXRlKCJjb250cm9sRmllbGRDaGVja2JveE11bHRpcGxlIiwgJzxzcGFuIGlkPSIke2lkfSI+e3tlYWNoKGksbykgY2hlY2tib3hPcHRpb25zfX08c3Bhbj48bGFiZWwgY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtbGFiZWwiIGZvcj0iJHtpZH1fY2hlY2tib3hfJHtpfSI+PGlucHV0IHR5cGU9ImNoZWNrYm94IiBpZD0iJHtpZH1fY2hlY2tib3hfJHtpfSIge3tpZiBvcHRpb25zLnJlYWRvbmx5fX1yZWFkb25seT0icmVhZG9ubHkie3svaWZ9fSB7e2lmIG5hbWV9fW5hbWU9IiR7bmFtZX0ie3svaWZ9fSBkYXRhLWNoZWNrYm94LXZhbHVlPSIke28udmFsdWV9IiBkYXRhLWNoZWNrYm94LWluZGV4PSIke2l9IiAvPiR7dGV4dH08L2xhYmVsPjwvc3Bhbj57ey9lYWNofX08L3NwYW4+Jyk7CgogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiY2hlY2tib3giLCBBbHBhY2EuRmllbGRzLkNoZWNrQm94RmllbGQpOwogICAgQWxwYWNhLnJlZ2lzdGVyRGVmYXVsdFNjaGVtYUZpZWxkTWFwcGluZygiYm9vbGVhbiIsICJjaGVja2JveCIpOwp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLkZpbGVGaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuRmlsZUZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBGaWxlIGNvbnRyb2wgd2l0aCBuaWNlIGN1c3RvbSBzdHlsZXMuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjc2V0dXAKICAgICAgICAgKi8KICAgICAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZSgpOyAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmNvbnRyb2xGaWVsZFRlbXBsYXRlRGVzY3JpcHRvciA9IHRoaXMudmlldy5nZXRUZW1wbGF0ZURlc2NyaXB0b3IoImNvbnRyb2xGaWVsZEZpbGUiKTsKICAgICAgICB9LAogICAgICAgICAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNzZXRWYWx1ZQogICAgICAgICAqLwogICAgICAgIHNldFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAvLyBiZSBzdXJlIHRvIGNhbGwgaW50byBiYXNlIG1ldGhvZAogICAgICAgICAgICAvLyBXZSB3b24ndCBiZSBhYmxlIHRvIGFjdHVhbGx5IHNldCB0aGUgdmFsdWUgZm9yIGZpbGUgaW5wdXQgZmllbGQgc28gd2UgdXNlIHRoZSBtYXNrIGlucHV0CiAgICAgICAgICAgIHZhciB0bXAgPSB0aGlzLmZpZWxkOwogICAgICAgICAgICB0aGlzLmZpZWxkID0gJCgnLmFscGFjYS1maWxlZmllbGQtY29udHJvbCcsdGhpcy5maWVsZENvbnRhaW5lcik7CiAgICAgICAgICAgIHRoaXMuYmFzZSh2YWx1ZSk7CgogICAgICAgICAgICAvLyBzd2l0Y2ggaXQgYmFjayB0byBhY3R1YWwgZmlsZSBpbnB1dAogICAgICAgICAgICB0aGlzLmZpZWxkID0gdG1wOwogICAgICAgIH0sCgogICAgICAgIG9uQ2hhbmdlOiBmdW5jdGlvbihlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGUpOwoKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5zZWxlY3Rpb25IYW5kbGVyKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NTZWxlY3Rpb25IYW5kbGVyKGUudGFyZ2V0LmZpbGVzKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHByb2Nlc3NTZWxlY3Rpb25IYW5kbGVyOiBmdW5jdGlvbihmaWxlcykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChmaWxlcyAmJiBmaWxlcy5sZW5ndGggPiAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBpZiB0aGUgYnJvd3NlciBzdXBwb3J0cyBIVE1MNSBGaWxlUmVhZGVyLCB3ZSBjYW4gcHVsbCBpbiB0aGUgc3RyZWFtIGZvciBwcmV2aWV3CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mKEZpbGVSZWFkZXIpICE9PSAidW5kZWZpbmVkIikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBjbGVhciBvdXQgcHJldmlvdXMgbG9hZGVkIGRhdGEKICAgICAgICAgICAgICAgICAgICB2YXIgbG9hZGVkRGF0YSA9IFtdOwogICAgICAgICAgICAgICAgICAgIHZhciBsb2FkQ291bnQgPSAwOwoKICAgICAgICAgICAgICAgICAgICB2YXIgZmlsZVJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7CiAgICAgICAgICAgICAgICAgICAgZmlsZVJlYWRlci5vbmxvYWQgPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmaWVsZCA9IHRoaXM7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihldmVudCkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRhdGFVcmkgPSBldmVudC50YXJnZXQucmVzdWx0OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRlZERhdGEucHVzaChkYXRhVXJpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRDb3VudCsrOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsb2FkQ291bnQgPT09IGZpbGVzLmxlbmd0aCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZC5vcHRpb25zLnNlbGVjdGlvbkhhbmRsZXIuY2FsbChmaWVsZCwgZmlsZXMsIGxvYWRlZERhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSkuY2FsbCh0aGlzKTsKCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmaWxlcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVSZWFkZXIucmVhZEFzRGF0YVVSTChmaWxlc1tpXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAvLyBhcHBseSBhZGRpdGlvbmFsIGNzcwogICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCJhbHBhY2EtY29udHJvbGZpZWxkLWZpbGUiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIGxpc3RlbiBmb3IgY2hhbmdlIGV2ZW50cyBvbiB0aGUgZmllbGQKICAgICAgICB9LC8vX19CVUlMREVSX0hFTFBFUlMKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjZ2V0U2NoZW1hT2ZPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgInNlbGVjdGlvbkhhbmRsZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJTZWxlY3Rpb24gSGFuZGxlciIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJGdW5jdGlvbiB0aGF0IHNob3VsZCBiZSBjYWxsZWQgd2hlbiBmaWxlcyBhcmUgc2VsZWN0ZWQuICBSZXF1aXJlcyBIVE1MNS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiBmYWxzZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjZ2V0T3B0aW9uc0Zvck9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgInNlbGVjdGlvbkhhbmRsZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCgkJLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRUaXRsZQoJCSAqLwoJCWdldFRpdGxlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICJGaWxlIEZpZWxkIjsKCQl9LAoJCQoJCS8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RGVzY3JpcHRpb24KCQkgKi8KCQlnZXREZXNjcmlwdGlvbjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAiRmllbGQgZm9yIHVwbG9hZGluZyBmaWxlcy4iOwoJCX0sCgoJCS8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RmllbGRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJmaWxlIjsKICAgICAgICB9Ly9fX0VORF9PRl9CVUlMREVSX0hFTFBFUlMKICAgIH0pOwogICAgCiAgICBBbHBhY2EucmVnaXN0ZXJUZW1wbGF0ZSgiY29udHJvbEZpZWxkRmlsZSIsICc8aW5wdXQgdHlwZT0iZmlsZSIgaWQ9IiR7aWR9IiB7e2lmIG9wdGlvbnMuc2l6ZX19c2l6ZT0iJHtvcHRpb25zLnNpemV9Int7L2lmfX0ge3tpZiBvcHRpb25zLnJlYWRvbmx5fX1yZWFkb25seT0icmVhZG9ubHkie3svaWZ9fSB7e2lmIG5hbWV9fW5hbWU9IiR7bmFtZX0ie3svaWZ9fSB7e2VhY2goaSx2KSBvcHRpb25zLmRhdGF9fWRhdGEtJHtpfT0iJHt2fSJ7ey9lYWNofX0vPicpOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiZmlsZSIsIEFscGFjYS5GaWVsZHMuRmlsZUZpZWxkKTsKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5MaXN0RmllbGQgPSBBbHBhY2EuQ29udHJvbEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuTGlzdEZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkNvbnRyb2xGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIEFic3RyYWN0IGNsYXNzIGZvciBsaXN0LXR5cGUgY29udHJvbHMuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI3NldHVwCiAgICAgICAgICovCiAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICAgICAgICBfdGhpcy5iYXNlKCk7CiAgICAgICAgICAgIF90aGlzLnNlbGVjdE9wdGlvbnMgPSBbXTsKICAgICAgICAgICAgaWYgKF90aGlzLmdldEVudW0oKSkgewogICAgICAgICAgICAgICAgJC5lYWNoKF90aGlzLmdldEVudW0oKSwgZnVuY3Rpb24oaW5kZXgsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRleHQgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoX3RoaXMub3B0aW9ucy5vcHRpb25MYWJlbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eShfdGhpcy5vcHRpb25zLm9wdGlvbkxhYmVsc1tpbmRleF0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gX3RoaXMub3B0aW9ucy5vcHRpb25MYWJlbHNbaW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFBbHBhY2EuaXNFbXB0eShfdGhpcy5vcHRpb25zLm9wdGlvbkxhYmVsc1t2YWx1ZV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gX3RoaXMub3B0aW9ucy5vcHRpb25MYWJlbHNbdmFsdWVdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIF90aGlzLnNlbGVjdE9wdGlvbnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IHZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgICAidGV4dCI6IHRleHQKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyBzY2hlbWEgZW51bSBwcm9wZXJ0eS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtBcnJheXxTdHJpbmd9IEZpZWxkIHNjaGVtYSBlbnVtIHByb3BlcnR5LgogICAgICAgICAqLwogICAgICAgIGdldEVudW06IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5zY2hlbWEgJiYgdGhpcy5zY2hlbWFbImVudW0iXSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2NoZW1hWyJlbnVtIl07CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRWYWx1ZQogICAgICAgICAqLwogICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgICAgICAgaWYgKEFscGFjYS5pc0FycmF5KHZhbCkpIHsKICAgICAgICAgICAgICAgICQuZWFjaCh2YWwsIGZ1bmN0aW9uKGluZGV4LCBpdGVtVmFsKSB7CiAgICAgICAgICAgICAgICAgICAgJC5lYWNoKF90aGlzLnNlbGVjdE9wdGlvbnMsIGZ1bmN0aW9uKGluZGV4Miwgc2VsZWN0T3B0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3RPcHRpb24udmFsdWUgPT0gaXRlbVZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsW2luZGV4XSA9IHNlbGVjdE9wdGlvbi52YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkLmVhY2godGhpcy5zZWxlY3RPcHRpb25zLCBmdW5jdGlvbihpbmRleCwgc2VsZWN0T3B0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGVjdE9wdGlvbi52YWx1ZSA9PSB2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gc2VsZWN0T3B0aW9uLnZhbHVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI3JlbmRlckZpZWxkCiAgICAgICAgICovCiAgICAgICAgcmVuZGVyRmllbGQ6IGZ1bmN0aW9uKG9uU3VjY2VzcykgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmRhdGFTb3VyY2UpIHsKICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNGdW5jdGlvbih0aGlzLm9wdGlvbnMuZGF0YVNvdXJjZSkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuZGF0YVNvdXJjZSh0aGlzLCBmdW5jdGlvbih2YWx1ZXMpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNBcnJheSh2YWx1ZXMpKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZhbHVlcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mKHZhbHVlc1tpXSkgPT0gInN0cmluZyIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5zZWxlY3RPcHRpb25zLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRleHQiOiB2YWx1ZXNbaV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidmFsdWUiOiB2YWx1ZXNbaV0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKEFscGFjYS5pc09iamVjdCh2YWx1ZXNbaV0pKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuc2VsZWN0T3B0aW9ucy5wdXNoKHZhbHVlc1tpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKEFscGFjYS5pc09iamVjdCh2YWx1ZXMpKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrIGluIHZhbHVlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5zZWxlY3RPcHRpb25zLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGV4dCI6IGssCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IHZhbHVlc1trXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5fcmVuZGVyRmllbGQob25TdWNjZXNzKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKEFscGFjYS5pc1VyaSh0aGlzLm9wdGlvbnMuZGF0YVNvdXJjZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJC5hamF4KHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdGhpcy5vcHRpb25zLmRhdGFTb3VyY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAiZ2V0IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAianNvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihqc29uRG9jdW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZHMgPSBqc29uRG9jdW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF90aGlzLm9wdGlvbnMuZHNUcmFuc2Zvcm1lciAmJiBBbHBhY2EuaXNGdW5jdGlvbihfdGhpcy5vcHRpb25zLmRzVHJhbnNmb3JtZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRzID0gX3RoaXMub3B0aW9ucy5kc1RyYW5zZm9ybWVyKGRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFscGFjYS5pc09iamVjdChkcykpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZvciBvYmplY3RzLCB3ZSB3YWxrIHRocm91Z2ggb25lIGtleSBhdCBhIHRpbWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBpbnNlcnRpb24gb3JkZXIgaXMgdGhlIG9yZGVyIG9mIHRoZSBrZXlzIGZyb20gdGhlIG1hcAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdG8gcHJlc2VydmUgb3JkZXIsIGNvbnNpZGVyIHVzaW5nIGFuIGFycmF5IGFzIGJlbG93CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkLmVhY2goZHMsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5zZWxlY3RPcHRpb25zLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidmFsdWUiOiBrZXksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0ZXh0IjogdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKEFscGFjYS5pc0FycmF5KGRzKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZm9yIGFycmF5cywgd2Ugd2FsayB0aHJvdWdoIG9uZSBpbmRleCBhdCBhIHRpbWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBpbnNlcnRpb24gb3JkZXIgaXMgZGljdGF0ZWQgYnkgdGhlIG9yZGVyIG9mIHRoZSBpbmRpY2VzIGludG8gdGhlIGFycmF5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIHByZXNlcnZlcyBvcmRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJC5lYWNoKGRzLCBmdW5jdGlvbihpbmRleCwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5zZWxlY3RPcHRpb25zLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidmFsdWUiOiB2YWx1ZS52YWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRleHQiOiB2YWx1ZS50ZXh0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuX3JlbmRlckZpZWxkKG9uU3VjY2Vzcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImVycm9yIjogZnVuY3Rpb24oanFYSFIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuZXJyb3JDYWxsYmFjayh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZXNzYWdlIjoiVW5hYmxlIHRvIGxvYWQgZGF0YSBmcm9tIHVyaSA6ICIgKyBfdGhpcy5vcHRpb25zLmRhdGFTb3VyY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzdGFnZSI6ICJEQVRBU09VUkNFX0xPQURJTkdfRVJST1IiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGV0YWlscyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJqcVhIUiIgOiBqcVhIUiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0ZXh0U3RhdHVzIiA6IHRleHRTdGF0dXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZXJyb3JUaHJvd24iIDogZXJyb3JUaHJvd24KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZHMgPSB0aGlzLm9wdGlvbnMuZGF0YVNvdXJjZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF90aGlzLm9wdGlvbnMuZHNUcmFuc2Zvcm1lciAmJiBBbHBhY2EuaXNGdW5jdGlvbihfdGhpcy5vcHRpb25zLmRzVHJhbnNmb3JtZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkcyA9IF90aGlzLm9wdGlvbnMuZHNUcmFuc2Zvcm1lcihkcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzQXJyYXkoZHMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJC5lYWNoKGRzLCBmdW5jdGlvbihpbmRleCwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuc2VsZWN0T3B0aW9ucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IHZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRleHQiOiB2YWx1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNPYmplY3QoZHMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaW5kZXggaW4gZHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuc2VsZWN0T3B0aW9ucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IGluZGV4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRleHQiOiBkc1tpbmRleF0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuX3JlbmRlckZpZWxkKG9uU3VjY2Vzcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9yZW5kZXJGaWVsZChvblN1Y2Nlc3MpOwogICAgICAgICAgICB9CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2dldFNjaGVtYU9mU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZTY2hlbWE6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAiZW51bSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkVudW1lcmF0aW9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkxpc3Qgb2YgZmllbGQgdmFsdWUgb3B0aW9ucyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImFycmF5IiwKICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjZ2V0U2NoZW1hT2ZPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgIm9wdGlvbkxhYmVscyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIk9wdGlvbiBMYWJlbHMiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiTGFiZWxzIGZvciBvcHRpb25zLiBJdCBjYW4gZWl0aGVyIGJlIGEgbWFwIG9iamVjdCBvciBhbiBhcnJheSBmaWVsZCB0aGF0IG1hcHMgbGFiZWxzIHRvIGl0ZW1zIGRlZmluZWQgYnkgZW51bSBzY2hlbWEgcHJvcGVydHkgb25lIGJ5IG9uZS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJhcnJheSIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJkYXRhU291cmNlIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiT3B0aW9uIERhdGFzb3VyY2UiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRGF0YXNvdXJjZSBmb3IgZ2VuZXJhdGluZyBsaXN0IG9mIG9wdGlvbnMuICBUaGlzIGNhbiBiZSBhIHN0cmluZyBvciBhIGZ1bmN0aW9uLiAgSWYgYSBzdHJpbmcsIGl0IGlzIGNvbnNpZGVyZWQgdG8gYmUgYSBVUkkgdG8gYSBzZXJ2aWNlIHRoYXQgcHJvZHVjZXMgYSBvYmplY3QgY29udGFpbmluZyBrZXkvdmFsdWUgcGFpcnMgb3IgYW4gYXJyYXkgb2YgZWxlbWVudHMgb2Ygc3RydWN0dXJlIHsndGV4dCc6ICcnLCAndmFsdWUnOiAnJ30uICBUaGlzIGNhbiBhbHNvIGJlIGEgZnVuY3Rpb24gdGhhdCBpcyBjYWxsZWQgdG8gcHJvZHVjZSB0aGUgc2FtZSBsaXN0LiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJyZW1vdmVEZWZhdWx0Tm9uZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlJlbW92ZSBEZWZhdWx0IE5vbmUiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiSWYgdHJ1ZSwgdGhlIGRlZmF1bHQgJ05vbmUnIG9wdGlvbiB3aWxsIG5vdCBiZSBzaG93bi4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiBmYWxzZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjZ2V0T3B0aW9uc0Zvck9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgIm9wdGlvbkxhYmVscyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgIml0ZW1MYWJlbCI6IkxhYmVsIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYXJyYXkiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZGF0YVNvdXJjZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJyZW1vdmVEZWZhdWx0Tm9uZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiY2hlY2tib3giLAogICAgICAgICAgICAgICAgICAgICAgICAicmlnaHRMYWJlbCI6ICJSZW1vdmUgRGVmYXVsdCBOb25lIgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLlJhZGlvRmllbGQgPSBBbHBhY2EuRmllbGRzLkxpc3RGaWVsZC5leHRlbmQoCiAgICAvKioKICAgICAqIEBsZW5kcyBBbHBhY2EuRmllbGRzLlJhZGlvRmllbGQucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuRmllbGRzLkxpc3RGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIFJhZGlvIGdyb3VwIGNvbnRyb2wgZm9yIGxpc3QgdHlwZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLkxpc3RGaWVsZCNzZXR1cAogICAgICAgICAqLwogICAgICAgIHNldHVwOiBmdW5jdGlvbigpewogICAgICAgICAgICB0aGlzLmJhc2UoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMubmFtZSkgewoJCQkJdGhpcy5uYW1lID0gdGhpcy5vcHRpb25zLm5hbWU7CgkJCX0KCQkJZWxzZSBpZiAoIXRoaXMubmFtZSkgewoJCQkJdGhpcy5uYW1lID0gdGhpcy5nZXRJZCgpKyItbmFtZSI7CgkJCX0KCiAgICAgICAgICAgIC8vIGVtcHR5IHNlbGVjdCBmaXJzdCB0byBmYWxzZSBieSBkZWZhdWx0CiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNVbmRlZmluZWQodGhpcy5vcHRpb25zLmVtcHR5U2VsZWN0Rmlyc3QpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuZW1wdHlTZWxlY3RGaXJzdCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZ2V0VmFsdWUKICAgICAgICAgKi8KICAgICAgICBnZXRWYWx1ZTogZnVuY3Rpb24oKXsKICAgICAgICAgICAgdmFyIHZhbCA9IHRoaXMuYmFzZSgkKCdpbnB1dDpyYWRpb1tuYW1lPScrdGhpcy5uYW1lKyddOmNoZWNrZWQnLHRoaXMuZmllbGQpLnZhbCgpKTsKICAgICAgICAgICAgJC5lYWNoKHRoaXMuc2VsZWN0T3B0aW9ucyxmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmIChTdHJpbmcodGhpc1sndmFsdWUnXSkgPT0gIHZhbCkgewogICAgICAgICAgICAgICAgICAgIHZhbCA9IHRoaXNbJ3ZhbHVlJ107CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdmFsOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjc2V0VmFsdWUKICAgICAgICAgKi8KICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24odmFsKXsKICAgICAgICAgICAgaWYgKHZhbCAhPSB0aGlzLmdldFZhbHVlKCkpIHsKICAgICAgICAgICAgICAgICQuZWFjaCgkKCdpbnB1dDpyYWRpb1tuYW1lPScrdGhpcy5uYW1lKyddJyx0aGlzLmZpZWxkKSxmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoJCh0aGlzKS52YWwoKSA9PSB2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5hdHRyKCdjaGVja2VkJywnY2hlY2tlZCcpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykucmVtb3ZlQXR0cignY2hlY2tlZCcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuZW1wdHlTZWxlY3RGaXJzdCkgewogICAgICAgICAgICAgICAgICAgIGlmICgkKCJpbnB1dDpyYWRpbzpjaGVja2VkIix0aGlzLmZpZWxkKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgJCgiaW5wdXQ6cmFkaW86Zmlyc3QiLHRoaXMuZmllbGQpLmF0dHIoImNoZWNrZWQiLCJjaGVja2VkIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuYmFzZSh2YWwpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIF9yZW5kZXJGaWVsZDogZnVuY3Rpb24ob25TdWNjZXNzKXsKCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICB2YXIgY29udHJvbEZpZWxkVGVtcGxhdGVEZXNjcmlwdG9yID0gdGhpcy52aWV3LmdldFRlbXBsYXRlRGVzY3JpcHRvcigiY29udHJvbEZpZWxkUmFkaW8iKTsKICAgICAgICAgICAgaWYgKGNvbnRyb2xGaWVsZFRlbXBsYXRlRGVzY3JpcHRvcikgewogICAgICAgICAgICAgICAgdGhpcy5maWVsZCA9IF90aGlzLnZpZXcudG1wbChjb250cm9sRmllbGRUZW1wbGF0ZURlc2NyaXB0b3IsIHsKICAgICAgICAgICAgICAgICAgICAiaWQiOiB0aGlzLmdldElkKCksCiAgICAgICAgICAgICAgICAgICAgIm9wdGlvbnMiOiB0aGlzLm9wdGlvbnMsCiAgICAgICAgICAgICAgICAgICAgInNlbGVjdE9wdGlvbnMiOiB0aGlzLnNlbGVjdE9wdGlvbnMsCiAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjp0aGlzLnNjaGVtYS5yZXF1aXJlZCwKCQkJCQkibmFtZSI6IHRoaXMubmFtZSwKICAgICAgICAgICAgICAgICAgICAiZGF0YSI6IHRoaXMuZGF0YSwKICAgICAgICAgICAgICAgICAgICAicmVtb3ZlRGVmYXVsdE5vbmUiOiB0aGlzLm9wdGlvbnMucmVtb3ZlRGVmYXVsdE5vbmUKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIGlmIGVtcHR5U2VsZWN0Rmlyc3QgYW5kIG5vdGhpbmcgY3VycmVudGx5IGNoZWNrZWQsIHRoZW4gcGljayBmaXJzdCBpdGVtIGluIHRoZSB2YWx1ZSBsaXN0CiAgICAgICAgICAgICAgICAvLyBzZXQgZGF0YSBhbmQgdmlzdWFsbHkgc2VsZWN0IGl0CiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmVtcHR5U2VsZWN0Rmlyc3QgJiYgdGhpcy5zZWxlY3RPcHRpb25zICYmIHRoaXMuc2VsZWN0T3B0aW9ucy5sZW5ndGggPiAwKSB7CgogICAgICAgICAgICAgICAgICAgIHRoaXMuZGF0YSA9IHRoaXMuc2VsZWN0T3B0aW9uc1swXS52YWx1ZTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCQoImlucHV0OnJhZGlvOmNoZWNrZWQiLHRoaXMuZmllbGQpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAkKCJpbnB1dDpyYWRpbzpmaXJzdCIsdGhpcy5maWVsZCkuYXR0cigiY2hlY2tlZCIsImNoZWNrZWQiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gc3RhY2sgcmFkaW8gc2VsZWN0b3JzIHZlcnRpY2FsbHkKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMudmVydGljYWwpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgJCgiLmFscGFjYS1jb250cm9sZmllbGQtcmFkaW8taXRlbSIsIHRoaXMuZmllbGQpLmNzcygiZGlzcGxheSIsICJibG9jayIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuaW5qZWN0RmllbGQodGhpcy5maWVsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChvblN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIG9uU3VjY2VzcygpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjcG9zdFJlbmRlcgogICAgICAgICAqLwogICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLXJhZGlvJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjb25DbGljawogICAgICAgICAqLwogICAgICAgIG9uQ2xpY2s6IGZ1bmN0aW9uKGUpewogICAgICAgICAgICB0aGlzLmJhc2UoZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICAgICAgICAKICAgICAgICAgICAgQWxwYWNhLmxhdGVyKDI1LCB0aGlzLCBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgdmFyIHYgPSBfdGhpcy5nZXRWYWx1ZSgpOwogICAgICAgICAgICAgICAgX3RoaXMuc2V0VmFsdWUodik7CiAgICAgICAgICAgICAgICBfdGhpcy5yZWZyZXNoVmFsaWRhdGlvblN0YXRlKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoJCQogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLkxpc3RGaWVsZCNnZXRTY2hlbWFPZk9wdGlvbnMKICAgICAgICAgKi8KCQlnZXRTY2hlbWFPZk9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLHsKCQkJCSJwcm9wZXJ0aWVzIjogewoJCQkJCSJuYW1lIjogewoJCQkJCQkidGl0bGUiOiAiRmllbGQgbmFtZSIsCgkJCQkJCSJkZXNjcmlwdGlvbiI6ICJGaWVsZCBuYW1lLiIsCgkJCQkJCSJ0eXBlIjogInN0cmluZyIKCQkJCQl9LAogICAgICAgICAgICAgICAgICAgICJlbXB0eVNlbGVjdEZpcnN0IjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRW1wdHkgU2VsZWN0IEZpcnN0IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIklmIHRoZSBkYXRhIGlzIGVtcHR5LCB0aGVuIGF1dG9tYXRpY2FsbHkgc2VsZWN0IHRoZSBmaXJzdCBpdGVtIGluIHRoZSBsaXN0LiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAidmVydGljYWwiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJQb3NpdGlvbiB0aGUgcmFkaW8gc2VsZWN0b3IgaXRlbXMgdmVydGljYWxseSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJXaGVuIHRydWUsIHRoZSByYWRpbyBzZWxlY3RvciBpdGVtcyB3aWxsIGJlIHN0YWNrZWQgdmVydGljYWxseSBhbmQgbm90IGhvcml6b250YWxseSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgfQoJCQkJfQoJCQl9KTsKICAgICAgICB9LAoKCQkvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRUaXRsZQoJCSAqLwoJCWdldFRpdGxlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICJSYWRpbyBHcm91cCBGaWVsZCI7CgkJfSwKCQkKCQkvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXREZXNjcmlwdGlvbgoJCSAqLwoJCWdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICJSYWRpbyBHcm91cCBGaWVsZCB3aXRoIGxpc3Qgb2Ygb3B0aW9ucy4iOwoJCX0sCgoJCS8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAicmFkaW8iOwogICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgICAgIAogICAgfSk7CiAgICAKICAgIEFscGFjYS5yZWdpc3RlclRlbXBsYXRlKCJjb250cm9sRmllbGRSYWRpbyIsICc8ZGl2IGlkPSIke2lkfSIgY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtcmFkaW8iPnt7aWYgIXJlcXVpcmVkICYmICFyZW1vdmVEZWZhdWx0Tm9uZX19PHNwYW4gY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtcmFkaW8taXRlbSI+PGlucHV0IHR5cGU9InJhZGlvIiB7e2lmIG9wdGlvbnMucmVhZG9ubHl9fXJlYWRvbmx5PSJyZWFkb25seSJ7ey9pZn19IG5hbWU9IiR7bmFtZX0iIGlkPSIke2lkfV9yYWRpb19ub25ldmFsdWUiIHZhbHVlPSIiLz48bGFiZWwgY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtcmFkaW8tbGFiZWwiIGZvcj0iJHtpZH1fcmFkaW9fbm9uZXZhbHVlIj5Ob25lPC9sYWJlbD48L3NwYW4+e3svaWZ9fXt7ZWFjaCBzZWxlY3RPcHRpb25zfX08c3BhbiBjbGFzcz0iYWxwYWNhLWNvbnRyb2xmaWVsZC1yYWRpby1pdGVtIj48aW5wdXQgdHlwZT0icmFkaW8iIHt7aWYgb3B0aW9ucy5yZWFkb25seX19cmVhZG9ubHk9InJlYWRvbmx5Int7L2lmfX0gbmFtZT0iJHtuYW1lfSIgdmFsdWU9IiR7dmFsdWV9IiBpZD0iJHtpZH1fcmFkaW9fJHskaW5kZXh9IiB7e2lmIHZhbHVlID09IGRhdGF9fWNoZWNrZWQ9ImNoZWNrZWQie3svaWZ9fS8+PGxhYmVsIGNsYXNzPSJhbHBhY2EtY29udHJvbGZpZWxkLXJhZGlvLWxhYmVsIiBmb3I9IiR7aWR9X3JhZGlvXyR7JGluZGV4fSI+JHt0ZXh0fTwvbGFiZWw+PC9zcGFuPnt7L2VhY2h9fTwvZGl2PicpOwoKICAgIEFscGFjYS5yZWdpc3RlckZpZWxkQ2xhc3MoInJhZGlvIiwgQWxwYWNhLkZpZWxkcy5SYWRpb0ZpZWxkKTsKICAgIAp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLlNlbGVjdEZpZWxkID0gQWxwYWNhLkZpZWxkcy5MaXN0RmllbGQuZXh0ZW5kKAogICAgLyoqCiAgICAgKiBAbGVuZHMgQWxwYWNhLkZpZWxkcy5TZWxlY3RGaWVsZC5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5GaWVsZHMuTGlzdEZpZWxkCiAgICAgICAgICoKICAgICAgICAgKiBAY2xhc3MgRHJvcGRvd24gbGlzdCBjb250cm9sIGZvciBsaXN0IHR5cGUuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5MaXN0RmllbGQjc2V0dXAKICAgICAgICAgKi8KICAgICAgICBzZXR1cDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CgogICAgICAgICAgICAvLyBlbXB0eSBzZWxlY3QgZmlyc3QgdG8gZmFsc2UgYnkgZGVmYXVsdAogICAgICAgICAgICBpZiAoQWxwYWNhLmlzVW5kZWZpbmVkKHRoaXMub3B0aW9ucy5lbXB0eVNlbGVjdEZpcnN0KSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmVtcHR5U2VsZWN0Rmlyc3QgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldFZhbHVlCiAgICAgICAgICovCiAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsID0gdGhpcy5maWVsZC52YWwoKTsKICAgICAgICAgICAgICAgIGlmICghdmFsKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhbCA9IHRoaXMuZGF0YTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5iYXNlKHZhbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNzZXRWYWx1ZQogICAgICAgICAqLwogICAgICAgIHNldFZhbHVlOiBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgaWYgKEFscGFjYS5pc0FycmF5KHZhbCkpIHsKICAgICAgICAgICAgICAgIGlmICghQWxwYWNhLmNvbXBhcmVBcnJheUNvbnRlbnQodmFsLCB0aGlzLmdldFZhbHVlKCkpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eSh2YWwpICYmIHRoaXMuZmllbGQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5maWVsZC52YWwodmFsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5iYXNlKHZhbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodmFsICE9IHRoaXMuZ2V0VmFsdWUoKSkgewogICAgICAgICAgICAgICAgICAgIGlmICghQWxwYWNhLmlzRW1wdHkodmFsKSAmJiB0aGlzLmZpZWxkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGQudmFsKHZhbCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuYmFzZSh2YWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuTGlzdEZpZWxkI2dldEVudW0KICAgICAgICAgKi8KICAgICAgICBnZXRFbnVtOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc2NoZW1hKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zY2hlbWFbImVudW0iXSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNjaGVtYVsiZW51bSJdOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnNjaGVtYVsidHlwZSJdICYmIHRoaXMuc2NoZW1hWyJ0eXBlIl0gPT0gImFycmF5IiAmJiB0aGlzLnNjaGVtYVsiaXRlbXMiXSAmJiB0aGlzLnNjaGVtYVsiaXRlbXMiXVsiZW51bSJdKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2NoZW1hWyJpdGVtcyJdWyJlbnVtIl07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIF9yZW5kZXJGaWVsZDogZnVuY3Rpb24ob25TdWNjZXNzKSB7CgogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgaWYgKHRoaXMuc2NoZW1hWyJ0eXBlIl0gJiYgdGhpcy5zY2hlbWFbInR5cGUiXSA9PSAiYXJyYXkiKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMubXVsdGlwbGUgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgY29udHJvbEZpZWxkVGVtcGxhdGVEZXNjcmlwdG9yOwogICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLm11bHRpcGxlICYmIEFscGFjYS5pc0FycmF5KHRoaXMuZGF0YSkpIHsKICAgICAgICAgICAgICAgIGNvbnRyb2xGaWVsZFRlbXBsYXRlRGVzY3JpcHRvciA9IHRoaXMudmlldy5nZXRUZW1wbGF0ZURlc2NyaXB0b3IoImNvbnRyb2xGaWVsZFNlbGVjdE11bHRpcGxlIik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb250cm9sRmllbGRUZW1wbGF0ZURlc2NyaXB0b3IgPSB0aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJjb250cm9sRmllbGRTZWxlY3QiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNvbnRyb2xGaWVsZFRlbXBsYXRlRGVzY3JpcHRvcikgewogICAgICAgICAgICAgICAgdGhpcy5maWVsZCA9IF90aGlzLnZpZXcudG1wbChjb250cm9sRmllbGRUZW1wbGF0ZURlc2NyaXB0b3IsIHsKICAgICAgICAgICAgICAgICAgICAiaWQiOiB0aGlzLmdldElkKCksCiAgICAgICAgICAgICAgICAgICAgIm9wdGlvbnMiOiB0aGlzLm9wdGlvbnMsCiAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogdGhpcy5zY2hlbWEucmVxdWlyZWQsCiAgICAgICAgICAgICAgICAgICAgInNlbGVjdE9wdGlvbnMiOiB0aGlzLnNlbGVjdE9wdGlvbnMsCiAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiB0aGlzLm5hbWUsCiAgICAgICAgICAgICAgICAgICAgImRhdGEiOiB0aGlzLmRhdGEsCiAgICAgICAgICAgICAgICAgICAgInJlbW92ZURlZmF1bHROb25lIjogdGhpcy5vcHRpb25zLnJlbW92ZURlZmF1bHROb25lCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAvLyBpZiBlbXB0eVNlbGVjdEZpcnN0IGFuZCBub3RoaW5nIGN1cnJlbnRseSBjaGVja2VkLCB0aGVuIHBpY2sgZmlyc3QgaXRlbSBpbiB0aGUgdmFsdWUgbGlzdAogICAgICAgICAgICAgICAgLy8gc2V0IGRhdGEgYW5kIHZpc3VhbGx5IHNlbGVjdCBpdAogICAgICAgICAgICAgICAgaWYgKEFscGFjYS5pc1VuZGVmaW5lZCh0aGlzLmRhdGEpICYmIHRoaXMub3B0aW9ucy5lbXB0eVNlbGVjdEZpcnN0ICYmIHRoaXMuc2VsZWN0T3B0aW9ucyAmJiB0aGlzLnNlbGVjdE9wdGlvbnMubGVuZ3RoID4gMCkgewoKICAgICAgICAgICAgICAgICAgICB0aGlzLmRhdGEgPSB0aGlzLnNlbGVjdE9wdGlvbnNbMF0udmFsdWU7CgogICAgICAgICAgICAgICAgICAgIC8vJCgic2VsZWN0Iix0aGlzLmZpZWxkKS52YWwoIjAiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLmluamVjdEZpZWxkKHRoaXMuZmllbGQpOwoKICAgICAgICAgICAgICAgIC8vIGRvIHRoaXMgbGl0dGxlIHRyaWNrIHNvIHRoYXQgaWYgd2UgaGF2ZSBhIGRlZmF1bHQgdmFsdWUsIGl0IGdldHMgc2V0IGR1cmluZyBmaXJzdCByZW5kZXIKICAgICAgICAgICAgICAgIC8vIHRoaXMgY2F1c2VzIHRoZSBzdGF0ZSBvZiB0aGUgY29udHJvbAogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGF0YSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUodGhpcy5kYXRhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9uU3VjY2VzcykgewogICAgICAgICAgICAgICAgb25TdWNjZXNzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjcG9zdFJlbmRlcgogICAgICAgICAqLwogICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLXNlbGVjdCcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaWRhdGUgYWdhaW5zdCBlbnVtIHByb3BlcnR5LgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgdGhlIGVsZW1lbnQgdmFsdWUgaXMgcGFydCBvZiB0aGUgZW51bSBsaXN0LCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgX3ZhbGlkYXRlRW51bTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnNjaGVtYVsiZW51bSJdKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsID0gdGhpcy5kYXRhOwogICAgICAgICAgICAgICAgaWYgKCF0aGlzLnNjaGVtYS5yZXF1aXJlZCAmJiBBbHBhY2EuaXNWYWxFbXB0eSh2YWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLm11bHRpcGxlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGlzVmFsaWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gW107CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICQuZWFjaCh2YWwsIGZ1bmN0aW9uKGksdikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJC5pbkFycmF5KHYsIF90aGlzLnNjaGVtYVsiZW51bSJdKSA8PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNWYWxpZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzVmFsaWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoJC5pbkFycmF5KHZhbCwgdGhpcy5zY2hlbWFbImVudW0iXSkgPiAtMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI29uQ2hhbmdlCiAgICAgICAgICovCiAgICAgICAgb25DaGFuZ2U6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGUpOwoKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIEFscGFjYS5sYXRlcigyNSwgdGhpcywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgdiA9IF90aGlzLmdldFZhbHVlKCk7CiAgICAgICAgICAgICAgICBfdGhpcy5zZXRWYWx1ZSh2KTsKICAgICAgICAgICAgICAgIF90aGlzLnJlZnJlc2hWYWxpZGF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaWRhdGVzIGlmIG51bWJlciBvZiBpdGVtcyBoYXMgYmVlbiBsZXNzIHRoYW4gbWluSXRlbXMuCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IHRydWUgaWYgbnVtYmVyIG9mIGl0ZW1zIGhhcyBiZWVuIGxlc3MgdGhhbiBtaW5JdGVtcwogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZU1pbkl0ZW1zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc2NoZW1hLml0ZW1zICYmIHRoaXMuc2NoZW1hLml0ZW1zLm1pbkl0ZW1zKSB7CiAgICAgICAgICAgICAgICBpZiAoJCgiOnNlbGVjdGVkIix0aGlzLmZpZWxkKS5sZW5ndGggPCB0aGlzLnNjaGVtYS5pdGVtcy5taW5JdGVtcykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBWYWxpZGF0ZXMgaWYgbnVtYmVyIG9mIGl0ZW1zIGhhcyBiZWVuIG92ZXIgbWF4SXRlbXMuCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IHRydWUgaWYgbnVtYmVyIG9mIGl0ZW1zIGhhcyBiZWVuIG92ZXIgbWF4SXRlbXMKICAgICAgICAgKi8KICAgICAgICBfdmFsaWRhdGVNYXhJdGVtczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnNjaGVtYS5pdGVtcyAmJiB0aGlzLnNjaGVtYS5pdGVtcy5tYXhJdGVtcykgewogICAgICAgICAgICAgICAgaWYgKCQoIjpzZWxlY3RlZCIsdGhpcy5maWVsZCkubGVuZ3RoID4gdGhpcy5zY2hlbWEuaXRlbXMubWF4SXRlbXMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udGFpbmVyRmllbGQjaGFuZGxlVmFsaWRhdGUKICAgICAgICAgKi8KICAgICAgICBoYW5kbGVWYWxpZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBiYXNlU3RhdHVzID0gdGhpcy5iYXNlKCk7CgogICAgICAgICAgICB2YXIgdmFsSW5mbyA9IHRoaXMudmFsaWRhdGlvbjsKCiAgICAgICAgICAgIHZhciBzdGF0dXMgPSB0aGlzLl92YWxpZGF0ZU1heEl0ZW1zKCk7CiAgICAgICAgICAgIHZhbEluZm9bInRvb01hbnlJdGVtcyJdID0gewogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiBzdGF0dXMgPyAiIiA6IEFscGFjYS5zdWJzdGl0dXRlVG9rZW5zKHRoaXMudmlldy5nZXRNZXNzYWdlKCJ0b29NYW55SXRlbXMiKSwgW3RoaXMuc2NoZW1hLml0ZW1zLm1heEl0ZW1zXSksCiAgICAgICAgICAgICAgICAic3RhdHVzIjogc3RhdHVzCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBzdGF0dXMgPSB0aGlzLl92YWxpZGF0ZU1pbkl0ZW1zKCk7CiAgICAgICAgICAgIHZhbEluZm9bIm5vdEVub3VnaEl0ZW1zIl0gPSB7CiAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHN0YXR1cyA/ICIiIDogQWxwYWNhLnN1YnN0aXR1dGVUb2tlbnModGhpcy52aWV3LmdldE1lc3NhZ2UoIm5vdEVub3VnaEl0ZW1zIiksIFt0aGlzLnNjaGVtYS5pdGVtcy5taW5JdGVtc10pLAogICAgICAgICAgICAgICAgInN0YXR1cyI6IHN0YXR1cwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgcmV0dXJuIGJhc2VTdGF0dXMgJiYgdmFsSW5mb1sidG9vTWFueUl0ZW1zIl1bInN0YXR1cyJdICYmIHZhbEluZm9bIm5vdEVub3VnaEl0ZW1zIl1bInN0YXR1cyJdOwogICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5MaXN0RmllbGQjZ2V0U2NoZW1hT2ZPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgIm11bHRpcGxlIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiTXVsaXRwbGUgU2VsZWN0aW9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkFsbG93IG11bHRpcGxlIHNlbGVjdGlvbiBpZiB0cnVlLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAic2l6ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkRpc3BsYXllZCBPcHRpb25zIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIk51bWJlciBvZiBvcHRpb25zIHRvIGJlIHNob3duLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm51bWJlciIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJlbXB0eVNlbGVjdEZpcnN0IjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRW1wdHkgU2VsZWN0IEZpcnN0IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIklmIHRoZSBkYXRhIGlzIGVtcHR5LCB0aGVuIGF1dG9tYXRpY2FsbHkgc2VsZWN0IHRoZSBmaXJzdCBpdGVtIGluIHRoZSBsaXN0LiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5MaXN0RmllbGQjZ2V0T3B0aW9uc0Zvck9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgIm11bHRpcGxlIjogewogICAgICAgICAgICAgICAgICAgICAgICAicmlnaHRMYWJlbCI6ICJBbGxvdyBtdWx0aXBsZSBzZWxlY3Rpb24gPyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJoZWxwZXIiOiAiQWxsb3cgbXVsdGlwbGUgc2VsZWN0aW9uIGlmIGNoZWNrZWQiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJzaXplIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZ2V0VGl0bGUKICAgICAgICAgKi8KICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiRHJvcGRvd24gU2VsZWN0IjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJEcm9wZG93biBzZWxlY3QgZmllbGQuIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRGaWVsZFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gInNlbGVjdCI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCgogICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyVGVtcGxhdGUoImNvbnRyb2xGaWVsZFNlbGVjdCIsICc8c2VsZWN0IGlkPSIke2lkfSIge3tpZiBvcHRpb25zLnJlYWRvbmx5fX1yZWFkb25seT0icmVhZG9ubHkie3svaWZ9fSB7e2lmIG9wdGlvbnMubXVsdGlwbGV9fW11bHRpcGxle3svaWZ9fSB7e2lmIG9wdGlvbnMuc2l6ZX19c2l6ZT0iJHtvcHRpb25zLnNpemV9Int7L2lmfX0ge3tpZiBuYW1lfX1uYW1lPSIke25hbWV9Int7L2lmfX0+e3tpZiAhcmVxdWlyZWQgJiYgIXJlbW92ZURlZmF1bHROb25lfX08b3B0aW9uIHZhbHVlPSIiPk5vbmU8L29wdGlvbj57ey9pZn19e3tlYWNoKGksdmFsdWUpIHNlbGVjdE9wdGlvbnN9fTxvcHRpb24gdmFsdWU9IiR7dmFsdWV9IiB7e2lmIHZhbHVlID09IGRhdGF9fXNlbGVjdGVkPSJzZWxlY3RlZCJ7ey9pZn19PiR7dGV4dH08L29wdGlvbj57ey9lYWNofX08L3NlbGVjdD4nKTsKICAgIEFscGFjYS5yZWdpc3RlclRlbXBsYXRlKCJjb250cm9sRmllbGRTZWxlY3RNdWx0aXBsZSIsICc8c2VsZWN0IGlkPSIke2lkfSIge3tpZiBvcHRpb25zLnJlYWRvbmx5fX1yZWFkb25seT0icmVhZG9ubHkie3svaWZ9fSB7e2lmIG9wdGlvbnMubXVsdGlwbGV9fW11bHRpcGxlPSJtdWx0aXBsZSJ7ey9pZn19IHt7aWYgb3B0aW9ucy5zaXplfX1zaXplPSIke29wdGlvbnMuc2l6ZX0ie3svaWZ9fSB7e2lmIG5hbWV9fW5hbWU9IiR7bmFtZX0ie3svaWZ9fT57e2lmICFyZXF1aXJlZCAmJiAhcmVtb3ZlRGVmYXVsdE5vbmV9fTxvcHRpb24gdmFsdWU9IiI+Tm9uZTwvb3B0aW9uPnt7L2lmfX17e2VhY2goaSx2YWx1ZSkgc2VsZWN0T3B0aW9uc319PG9wdGlvbiB2YWx1ZT0iJHt2YWx1ZX0iIHt7ZWFjaChqLHZhbCkgZGF0YX19e3tpZiB2YWx1ZSA9PSB2YWx9fXNlbGVjdGVkPSJzZWxlY3RlZCJ7ey9pZn19e3svZWFjaH19PiR7dGV4dH08L29wdGlvbj57ey9lYWNofX08L3NlbGVjdD4nKTsKICAgIEFscGFjYS5yZWdpc3RlckZpZWxkQ2xhc3MoInNlbGVjdCIsIEFscGFjYS5GaWVsZHMuU2VsZWN0RmllbGQpOwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5OdW1iZXJGaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuTnVtYmVyRmllbGQucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuRmllbGRzLlRleHRGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIENvbnRyb2wgZm9yIEpTT04gc2NoZW1hIG51bWJlciB0eXBlLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IGRhdGEgRmllbGQgZGF0YS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBGaWVsZCBvcHRpb25zLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBGaWVsZCB2aWV3LgogICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbm5lY3Rvcn0gY29ubmVjdG9yIEZpZWxkIGNvbm5lY3Rvci4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFZhbHVlCiAgICAgICAgICovCiAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgdGV4dFZhbHVlID0gdGhpcy5maWVsZC52YWwoKTsKICAgICAgICAgICAgaWYgKEFscGFjYS5pc1ZhbEVtcHR5KHRleHRWYWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZUZsb2F0KHRleHRWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIAogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjcG9zdFJlbmRlcgogICAgICAgICAqLwogICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLW51bWJlcicpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgkJCQkKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2hhbmRsZVZhbGlkYXRlCiAgICAgICAgICovCiAgICAgICAgaGFuZGxlVmFsaWRhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYmFzZVN0YXR1cyA9IHRoaXMuYmFzZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHZhbEluZm8gPSB0aGlzLnZhbGlkYXRpb247CgkJCQoJCQl2YXIgc3RhdHVzID0gdGhpcy5fdmFsaWRhdGVOdW1iZXIoKTsKICAgICAgICAgICAgdmFsSW5mb1sic3RyaW5nTm90QU51bWJlciJdID0gewogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiBzdGF0dXMgPyAiIiA6IHRoaXMudmlldy5nZXRNZXNzYWdlKCJzdHJpbmdOb3RBTnVtYmVyIiksCiAgICAgICAgICAgICAgICAic3RhdHVzIjogc3RhdHVzCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBzdGF0dXMgPSB0aGlzLl92YWxpZGF0ZURpdmlzaWJsZUJ5KCk7CgkJCXZhbEluZm9bInN0cmluZ0RpdmlzaWJsZUJ5Il0gPSB7CiAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHN0YXR1cyA/ICIiIDogQWxwYWNhLnN1YnN0aXR1dGVUb2tlbnModGhpcy52aWV3LmdldE1lc3NhZ2UoInN0cmluZ0RpdmlzaWJsZUJ5IiksIFt0aGlzLnNjaGVtYS5kaXZpc2libGVCeV0pLAogICAgICAgICAgICAgICAgInN0YXR1cyI6IHN0YXR1cwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgc3RhdHVzID0gdGhpcy5fdmFsaWRhdGVNYXhpbXVtKCk7CgkJCXZhbEluZm9bInN0cmluZ1ZhbHVlVG9vTGFyZ2UiXSA9IHsKICAgICAgICAgICAgICAgICJtZXNzYWdlIjogIiIsCiAgICAgICAgICAgICAgICAic3RhdHVzIjogc3RhdHVzCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmICghc3RhdHVzKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zY2hlbWEuZXhjbHVzaXZlTWF4aW11bSkgewogICAgICAgICAgICAgICAgICAgIHZhbEluZm9bInN0cmluZ1ZhbHVlVG9vTGFyZ2UiXVsibWVzc2FnZSJdID0gQWxwYWNhLnN1YnN0aXR1dGVUb2tlbnModGhpcy52aWV3LmdldE1lc3NhZ2UoInN0cmluZ1ZhbHVlVG9vTGFyZ2VFeGNsdXNpdmUiKSwgW3RoaXMuc2NoZW1hLm1heGltdW1dKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFsSW5mb1sic3RyaW5nVmFsdWVUb29MYXJnZSJdWyJtZXNzYWdlIl0gPSBBbHBhY2Euc3Vic3RpdHV0ZVRva2Vucyh0aGlzLnZpZXcuZ2V0TWVzc2FnZSgic3RyaW5nVmFsdWVUb29MYXJnZSIpLCBbdGhpcy5zY2hlbWEubWF4aW11bV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgkJCQoJCQlzdGF0dXMgPSB0aGlzLl92YWxpZGF0ZU1pbmltdW0oKTsKICAgICAgICAgICAgdmFsSW5mb1sic3RyaW5nVmFsdWVUb29TbWFsbCJdID0gewogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiAiIiwKICAgICAgICAgICAgICAgICJzdGF0dXMiOiBzdGF0dXMKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKCFzdGF0dXMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNjaGVtYS5leGNsdXNpdmVNaW5pbXVtKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsSW5mb1sic3RyaW5nVmFsdWVUb29TbWFsbCJdWyJtZXNzYWdlIl0gPSBBbHBhY2Euc3Vic3RpdHV0ZVRva2Vucyh0aGlzLnZpZXcuZ2V0TWVzc2FnZSgic3RyaW5nVmFsdWVUb29TbWFsbEV4Y2x1c2l2ZSIpLCBbdGhpcy5zY2hlbWEubWluaW11bV0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YWxJbmZvWyJzdHJpbmdWYWx1ZVRvb1NtYWxsIl1bIm1lc3NhZ2UiXSA9IEFscGFjYS5zdWJzdGl0dXRlVG9rZW5zKHRoaXMudmlldy5nZXRNZXNzYWdlKCJzdHJpbmdWYWx1ZVRvb1NtYWxsIiksIFt0aGlzLnNjaGVtYS5taW5pbXVtXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN0YXR1cyA9IHRoaXMuX3ZhbGlkYXRlTXVsdGlwbGVPZigpOwogICAgICAgICAgICB2YWxJbmZvWyJzdHJpbmdWYWx1ZU5vdE11bHRpcGxlT2YiXSA9IHsKICAgICAgICAgICAgICAgICJtZXNzYWdlIjogIiIsCiAgICAgICAgICAgICAgICAic3RhdHVzIjogc3RhdHVzCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmICghc3RhdHVzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YWxJbmZvWyJzdHJpbmdWYWx1ZU5vdE11bHRpcGxlT2YiXVsibWVzc2FnZSJdID0gQWxwYWNhLnN1YnN0aXR1dGVUb2tlbnModGhpcy52aWV3LmdldE1lc3NhZ2UoInN0cmluZ1ZhbHVlTm90TXVsdGlwbGVPZiIpLCBbdGhpcy5zY2hlbWEubXVsdGlwbGVPZl0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBoYW5kIGJhY2sgYSB0cnVlL2ZhbHNlCiAgICAgICAgICAgIHJldHVybiBiYXNlU3RhdHVzICYmIHZhbEluZm9bInN0cmluZ05vdEFOdW1iZXIiXVsic3RhdHVzIl0gJiYgdmFsSW5mb1sic3RyaW5nRGl2aXNpYmxlQnkiXVsic3RhdHVzIl0gJiYgdmFsSW5mb1sic3RyaW5nVmFsdWVUb29MYXJnZSJdWyJzdGF0dXMiXSAmJiB2YWxJbmZvWyJzdHJpbmdWYWx1ZVRvb1NtYWxsIl1bInN0YXR1cyJdICYmIHZhbEluZm9bInN0cmluZ1ZhbHVlTm90TXVsdGlwbGVPZiJdWyJzdGF0dXMiXTsKICAgICAgICB9LAogICAgICAgIAogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlcyBpZiBpdCBpcyBhIGZsb2F0IG51bWJlci4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gdHJ1ZSBpZiBpdCBpcyBhIGZsb2F0IG51bWJlcgogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZU51bWJlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB0ZXh0VmFsdWUgPSB0aGlzLmZpZWxkLnZhbCgpOwogICAgICAgICAgICAvLyBhbGxvdyBudWxsCiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNWYWxFbXB0eSh0ZXh0VmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZmxvYXRWYWx1ZSA9IHRoaXMuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIHF1aWNrIGNoZWNrIHRvIHNlZSBpZiB3aGF0IHRoZXkgZW50ZXJlZCB3YXMgYSBudW1iZXIKICAgICAgICAgICAgaWYgKGlzTmFOKGZsb2F0VmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIGNoZWNrIGlmIHZhbGlkIG51bWJlciBmb3JtYXQKICAgICAgICAgICAgaWYgKCF0ZXh0VmFsdWUubWF0Y2goQWxwYWNhLnJlZ2V4cHMubnVtYmVyKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAogICAgICAgIAogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlcyBkaXZpc2libGVCeSBjb25zdHJhaW50LgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSB0cnVlIGlmIGl0IHBhc3NlcyB0aGUgZGl2aXNpYmxlQnkgY29uc3RyYWludC4KICAgICAgICAgKi8KICAgICAgICBfdmFsaWRhdGVEaXZpc2libGVCeTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBmbG9hdFZhbHVlID0gdGhpcy5nZXRWYWx1ZSgpOwogICAgICAgICAgICBpZiAoIUFscGFjYS5pc0VtcHR5KHRoaXMuc2NoZW1hLmRpdmlzaWJsZUJ5KSkgewoKICAgICAgICAgICAgICAgIC8vIG1vZAogICAgICAgICAgICAgICAgaWYgKGZsb2F0VmFsdWUgJSB0aGlzLnNjaGVtYS5kaXZpc2libGVCeSAhPT0gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAvKioKICAgICAgICAgKiBWYWxpZGF0ZXMgbWF4aW11bSBjb25zdHJhaW50LgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSB0cnVlIGlmIGl0IHBhc3NlcyB0aGUgbWF4aW11bSBjb25zdHJhaW50LgogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZU1heGltdW06IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgZmxvYXRWYWx1ZSA9IHRoaXMuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghQWxwYWNhLmlzRW1wdHkodGhpcy5zY2hlbWEubWF4aW11bSkpIHsKICAgICAgICAgICAgICAgIGlmIChmbG9hdFZhbHVlID4gdGhpcy5zY2hlbWEubWF4aW11bSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eSh0aGlzLnNjaGVtYS5leGNsdXNpdmVNYXhpbXVtKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChmbG9hdFZhbHVlID09IHRoaXMuc2NoZW1hLm1heGltdW0gJiYgdGhpcy5zY2hlbWEuZXhjbHVzaXZlTWF4aW11bSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAogICAgICAgIAogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlcyBtYXhpbXVtIGNvbnN0cmFpbnQuCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IHRydWUgaWYgaXQgcGFzc2VzIHRoZSBtaW5pbXVtIGNvbnN0cmFpbnQuCiAgICAgICAgICovCiAgICAgICAgX3ZhbGlkYXRlTWluaW11bTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBmbG9hdFZhbHVlID0gdGhpcy5nZXRWYWx1ZSgpOwoKICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eSh0aGlzLnNjaGVtYS5taW5pbXVtKSkgewogICAgICAgICAgICAgICAgaWYgKGZsb2F0VmFsdWUgPCB0aGlzLnNjaGVtYS5taW5pbXVtKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc0VtcHR5KHRoaXMuc2NoZW1hLmV4Y2x1c2l2ZU1pbmltdW0pKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZsb2F0VmFsdWUgPT0gdGhpcy5zY2hlbWEubWluaW11bSAmJiB0aGlzLnNjaGVtYS5leGNsdXNpdmVNaW5pbXVtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlcyBtdWx0aXBsZU9mIGNvbnN0cmFpbnQuCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IHRydWUgaWYgaXQgcGFzc2VzIHRoZSBtdWx0aXBsZU9mIGNvbnN0cmFpbnQuCiAgICAgICAgICovCiAgICAgICAgX3ZhbGlkYXRlTXVsdGlwbGVPZjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBmbG9hdFZhbHVlID0gdGhpcy5nZXRWYWx1ZSgpOwoKICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eSh0aGlzLnNjaGVtYS5tdWx0aXBsZU9mKSkgewogICAgICAgICAgICAgICAgaWYgKGZsb2F0VmFsdWUgJiYgdGhpcy5zY2hlbWEubXVsdGlwbGVPZiAhPT0gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCgogICAgICAgIC8vX19CVUlMREVSX0hFTFBFUlMKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFNjaGVtYU9mU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZTY2hlbWE6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CgkJCQkicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAibXVsdGlwbGVPZiI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIk11bHRpcGxlIE9mIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlByb3BlcnR5IHZhbHVlIG11c3QgYmUgYSBtdWx0aXBsZSBvZiB0aGUgbXVsdGlwbGVPZiBzY2hlbWEgcHJvcGVydHkgc3VjaCB0aGF0IGRpdmlzaW9uIGJ5IHRoaXMgdmFsdWUgeWllbGRzIGFuIGludGVyZ2VyIChtb2QgemVybykuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibnVtYmVyIgogICAgICAgICAgICAgICAgICAgIH0sCgkJCQkJIm1pbmltdW0iOiB7CgkJCQkJCSJ0aXRsZSI6ICJNaW5pbXVtIiwKCQkJCQkJImRlc2NyaXB0aW9uIjogIk1pbmltdW0gdmFsdWUgb2YgdGhlIHByb3BlcnR5LiIsCgkJCQkJCSJ0eXBlIjogIm51bWJlciIKCQkJCQl9LAoJCQkJCSJtYXhpbXVtIjogewoJCQkJCQkidGl0bGUiOiAiTWF4aW11bSIsCgkJCQkJCSJkZXNjcmlwdGlvbiI6ICJNYXhpbXVtIHZhbHVlIG9mIHRoZSBwcm9wZXJ0eS4iLAoJCQkJCQkidHlwZSI6ICJudW1iZXIiCgkJCQkJfSwKCQkJCQkiZXhjbHVzaXZlTWluaW11bSI6IHsKCQkJCQkJInRpdGxlIjogIkV4Y2x1c2l2ZSBNaW5pbXVtIiwKCQkJCQkJImRlc2NyaXB0aW9uIjogIlByb3BlcnR5IHZhbHVlIGNhbiBub3QgZXF1YWwgdGhlIG51bWJlciBkZWZpbmVkIGJ5IHRoZSBtaW5pbXVtIHNjaGVtYSBwcm9wZXJ0eS4iLAoJCQkJCQkidHlwZSI6ICJib29sZWFuIiwKCQkJCQkJImRlZmF1bHQiOiBmYWxzZQoJCQkJCX0sCgkJCQkJImV4Y2x1c2l2ZU1heGltdW0iOiB7CgkJCQkJCSJ0aXRsZSI6ICJFeGNsdXNpdmUgTWF4aW11bSIsCgkJCQkJCSJkZXNjcmlwdGlvbiI6ICJQcm9wZXJ0eSB2YWx1ZSBjYW4gbm90IGVxdWFsIHRoZSBudW1iZXIgZGVmaW5lZCBieSB0aGUgbWF4aW11bSBzY2hlbWEgcHJvcGVydHkuIiwKCQkJCQkJInR5cGUiOiAiYm9vbGVhbiIsCgkJCQkJCSJkZWZhdWx0IjogZmFsc2UKCQkJCQl9CgkJCQl9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRPcHRpb25zU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0ZvclNjaGVtYTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKCQkJCSJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgIm11bHRpcGxlT2YiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJNdWx0aXBsZSBPZiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJUaGUgdmFsdWUgbXVzdCBiZSBhIGludGVncmFsIG11bHRpcGxlIG9mIHRoZSBwcm9wZXJ0eSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm51bWJlciIKICAgICAgICAgICAgICAgICAgICB9LAoJCQkJCSJtaW5pbXVtIjogewoJCQkJCQkidGl0bGUiOiAiTWluaW11bSIsCgkJCQkJCSJkZXNjcmlwdGlvbiI6ICJNaW5pbXVtIHZhbHVlIG9mIHRoZSBwcm9wZXJ0eSIsCgkJCQkJCSJ0eXBlIjogIm51bWJlciIKCQkJCQl9LAoJCQkJCSJtYXhpbXVtIjogewoJCQkJCQkidGl0bGUiOiAiTWF4aW11bSIsCgkJCQkJCSJkZXNjcmlwdGlvbiI6ICJNYXhpbXVtIHZhbHVlIG9mIHRoZSBwcm9wZXJ0eSIsCgkJCQkJCSJ0eXBlIjogIm51bWJlciIKCQkJCQl9LAoJCQkJCSJleGNsdXNpdmVNaW5pbXVtIjogewoJCQkJCQkicmlnaHRMYWJlbCI6ICJFeGNsdXNpdmUgbWluaW11bSA/IiwKCQkJCQkJImhlbHBlciI6ICJGaWVsZCB2YWx1ZSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBidXQgbm90IGVxdWFsIHRvIHRoaXMgbnVtYmVyIGlmIGNoZWNrZWQiLAoJCQkJCQkidHlwZSI6ICJjaGVja2JveCIKCQkJCQl9LAoJCQkJCSJleGNsdXNpdmVNYXhpbXVtIjogewoJCQkJCQkicmlnaHRMYWJlbCI6ICJFeGNsdXNpdmUgTWF4aW11bSA/IiwKCQkJCQkJImhlbHBlciI6ICJGaWVsZCB2YWx1ZSBtdXN0IGJlIGxlc3MgdGhhbiBidXQgbm90IGVxdWFsIHRvIHRoaXMgbnVtYmVyIGlmIGNoZWNrZWQiLAoJCQkJCQkidHlwZSI6ICJjaGVja2JveCIKCQkJCQl9CgkJCQl9CgkJCX0pOwoJCX0sCgoJCS8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0VGl0bGUKCQkgKi8KCQlnZXRUaXRsZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAiTnVtYmVyIEZpZWxkIjsKCQl9LAoJCQoJCS8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RGVzY3JpcHRpb24KCQkgKi8KCQlnZXREZXNjcmlwdGlvbjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAiRmllbGQgZm9yIGZsb2F0IG51bWJlcnMuIjsKCQl9LAoKCQkvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJudW1iZXIiOwogICAgICAgIH0sCgoJCS8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RmllbGRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJudW1iZXIiOwogICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgfSk7CiAgICAKICAgIC8vIEFkZGl0aW9uYWwgUmVnaXN0cmF0aW9ucwogICAgQWxwYWNhLnJlZ2lzdGVyTWVzc2FnZXMoewogICAgICAgICJzdHJpbmdWYWx1ZVRvb1NtYWxsIjogIlRoZSBtaW5pbXVtIHZhbHVlIGZvciB0aGlzIGZpZWxkIGlzIHswfSIsCiAgICAgICAgInN0cmluZ1ZhbHVlVG9vTGFyZ2UiOiAiVGhlIG1heGltdW0gdmFsdWUgZm9yIHRoaXMgZmllbGQgaXMgezB9IiwKICAgICAgICAic3RyaW5nVmFsdWVUb29TbWFsbEV4Y2x1c2l2ZSI6ICJWYWx1ZSBvZiB0aGlzIGZpZWxkIG11c3QgYmUgZ3JlYXRlciB0aGFuIHswfSIsCiAgICAgICAgInN0cmluZ1ZhbHVlVG9vTGFyZ2VFeGNsdXNpdmUiOiAiVmFsdWUgb2YgdGhpcyBmaWVsZCBtdXN0IGJlIGxlc3MgdGhhbiB7MH0iLAogICAgICAgICJzdHJpbmdEaXZpc2libGVCeSI6ICJUaGUgdmFsdWUgbXVzdCBiZSBkaXZpc2libGUgYnkgezB9IiwKICAgICAgICAic3RyaW5nTm90QU51bWJlciI6ICJUaGlzIHZhbHVlIGlzIG5vdCBhIG51bWJlci4iLAogICAgICAgICJzdHJpbmdWYWx1ZU5vdE11bHRpcGxlT2YiOiAiVGhpcyB2YWx1ZSBpcyBudSIKICAgIH0pOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygibnVtYmVyIiwgQWxwYWNhLkZpZWxkcy5OdW1iZXJGaWVsZCk7CiAgICBBbHBhY2EucmVnaXN0ZXJEZWZhdWx0U2NoZW1hRmllbGRNYXBwaW5nKCJudW1iZXIiLCAibnVtYmVyIik7Cn0pKGpRdWVyeSk7Ci8qanNoaW50IC1XMDgzICovIC8vIGlubGluZSBmdW5jdGlvbnMgYXJlIHVzZWQgc2FmZWx5CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuQXJyYXlGaWVsZCA9IEFscGFjYS5Db250YWluZXJGaWVsZC5leHRlbmQoCiAgICAvKioKICAgICAqIEBsZW5kcyBBbHBhY2EuRmllbGRzLkFycmF5RmllbGQucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuQ29udGFpbmVyRmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBEZWZhdWx0IGNvbnRyb2wgZm9yIHRoZSB0cmVhdG1lbnQgb2YgYSBKU09OIGFycmF5LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IGRhdGEgRmllbGQgZGF0YS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBGaWVsZCBvcHRpb25zLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBGaWVsZCB2aWV3LgogICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbm5lY3Rvcn0gY29ubmVjdG9yIEZpZWxkIGNvbm5lY3Rvci4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250YWluZXJGaWVsZCNzZXR1cAogICAgICAgICAqLwogICAgICAgIHNldHVwOiBmdW5jdGlvbigpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmJhc2UoKTsKCiAgICAgICAgICAgIHRoaXMub3B0aW9ucy50b29sYmFyU3R5bGUgPSBBbHBhY2EuaXNFbXB0eSh0aGlzLnZpZXcudG9vbGJhclN0eWxlKSA/ICJidXR0b24iIDogdGhpcy52aWV3LnRvb2xiYXJTdHlsZTsKCiAgICAgICAgICAgIC8vIGRldGVybWluZSB3aGV0aGVyIHdlIGFyZSB1c2luZyAicnVieSBvbiByYWlscyIgY29tcGF0aWJpbGl0eSBtb2RlCiAgICAgICAgICAgIHRoaXMub3B0aW9ucy5ydWJ5cmFpbHMgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRoaXMucGFyZW50ICYmIHRoaXMucGFyZW50Lm9wdGlvbnMgJiYgdGhpcy5wYXJlbnQub3B0aW9ucy5mb3JtICYmIHRoaXMucGFyZW50Lm9wdGlvbnMuZm9ybS5hdHRyaWJ1dGVzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc0VtcHR5KHRoaXMucGFyZW50Lm9wdGlvbnMuZm9ybS5hdHRyaWJ1dGVzLnJ1YnlyYWlscykpCiAgICAgICAgICAgICAgICB7CgkgIAkgICAgICAgICAgICB0aGlzLm9wdGlvbnMucnVieXJhaWxzID0gdHJ1ZTsKCSAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuaXRlbXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5pdGVtcyA9IHt9OwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgdG9vbGJhclN0aWNreSA9IGZhbHNlOwoKICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eSh0aGlzLnZpZXcudG9vbGJhclN0aWNreSkpIHsKICAgICAgICAgICAgICAgIHRvb2xiYXJTdGlja3kgPSB0aGlzLnZpZXcudG9vbGJhclN0aWNreTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eSh0aGlzLm9wdGlvbnMudG9vbGJhclN0aWNreSkpIHsKICAgICAgICAgICAgICAgIHRvb2xiYXJTdGlja3kgPSB0aGlzLm9wdGlvbnMudG9vbGJhclN0aWNreTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKEFscGFjYS5pc0VtcHR5KHRoaXMub3B0aW9ucy5pdGVtcy5zaG93TW92ZVVwSXRlbUJ1dHRvbikpIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5pdGVtcy5zaG93TW92ZVVwSXRlbUJ1dHRvbiA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNFbXB0eSh0aGlzLm9wdGlvbnMuaXRlbXMuc2hvd01vdmVEb3duSXRlbUJ1dHRvbikpIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5pdGVtcy5zaG93TW92ZURvd25JdGVtQnV0dG9uID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5vcHRpb25zLnRvb2xiYXJTdGlja3kgPSB0b29sYmFyU3RpY2t5OwoKICAgICAgICAgICAgLy8gRW5hYmxlIGZvcmNlUmV2YWxpZGF0aW9uIG9wdGlvbiBzbyB0aGF0IGFueSBjaGFuZ2UgaW4gY2hpbGRyZW4gd2lsbCB0cmlnZ2VyIHBhcmVudCdzIHJldmFsaWRhdGlvbi4KICAgICAgICAgICAgaWYgKHRoaXMuc2NoZW1hLml0ZW1zICYmIHRoaXMuc2NoZW1hLnVuaXF1ZUl0ZW1zKSB7CiAgICAgICAgICAgICAgICBBbHBhY2EubWVyZ2VPYmplY3QodGhpcy5vcHRpb25zLCB7CiAgICAgICAgICAgICAgICAgICAgImZvcmNlUmV2YWxpZGF0aW9uIiA6IHRydWUKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkodGhpcy5kYXRhKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghQWxwYWNhLmlzQXJyYXkodGhpcy5kYXRhKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNTdHJpbmcodGhpcy5kYXRhKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXRhID0gQWxwYWNhLnBhcnNlSlNPTih0aGlzLmRhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc0FycmF5KHRoaXMuZGF0YSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFscGFjYS5sb2dXYXJuKCJBcnJheUZpZWxkIHBhcnNlZCBkYXRhIGJ1dCBpdCB3YXMgbm90IGFuIGFycmF5OiAiICsgSlNPTi5zdHJpbmdpZnkodGhpcy5kYXRhKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGF0YSA9IFt0aGlzLmRhdGFdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFBpY2tzIGFwYXJ0IHRoZSBhcnJheSBhbmQgc2V0IG9udG8gY2hpbGQgZmllbGRzLgogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRhaW5lckZpZWxkI3NldHVwCiAgICAgICAgICovCiAgICAgICAgc2V0VmFsdWU6IGZ1bmN0aW9uKGRhdGEpIHsKCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICBpZiAoIWRhdGEgfHwgIUFscGFjYS5pc0FycmF5KGRhdGEpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHNldCBmaWVsZHMKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgY2hpbGRGaWVsZCA9IHRoaXMuY2hpbGRyZW5baV07CiAgICAgICAgICAgICAgICBpZiAoZGF0YS5sZW5ndGggPiBpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGNoaWxkRmllbGQuc2V0VmFsdWUoZGF0YVtpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVJdGVtKGNoaWxkRmllbGQuaWQpOyAvL3JlbW92ZSBjaGlsZCBpdGVtcyBpZiB0aGVyZSBhcmUgbW9yZSBjaGlsZHJlbiB0aGFuIGluIGRhdGEKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaWYgdGhlIG51bWJlciBvZiBpdGVtcyBpbiB0aGUgZGF0YSBpcyBncmVhdGVyIHRoYW4gdGhlIG51bWJlciBvZiBleGlzdGluZyBjaGlsZCBlbGVtZW50cwogICAgICAgICAgICAvLyB0aGVuIHdlIG5lZWQgdG8gYWRkIHRoZSBuZXcgZmllbGRzCgogICAgICAgICAgICBpZiAoaSA8IGRhdGEubGVuZ3RoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBfdGhpcy5yZXNvbHZlSXRlbVNjaGVtYU9wdGlvbnMoZnVuY3Rpb24oc2NoZW1hLCBvcHRpb25zKSB7CgogICAgICAgICAgICAgICAgICAgIC8vIHdhdGVyZmFsbCBmdW5jdGlvbnMKICAgICAgICAgICAgICAgICAgICB2YXIgZnVuY3MgPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGkgPCBkYXRhLmxlbmd0aCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmID0gKGZ1bmN0aW9uKGksIGRhdGEpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihjYWxsYmFjaykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5hZGRJdGVtKGksIHNjaGVtYSwgb3B0aW9ucywgZGF0YVtpXSwgbnVsbCwgZmFsc2UsIGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYnkgdGhlIHRpbWUgd2UgZ2V0IGhlcmUsIHdlIG1heSBoYXZlIGNvbnN0cnVjdGVkIGEgdmVyeSBsYXJnZSBjaGlsZCBjaGFpbiBvZgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzdWItZGVwZW5kZW5jaWVzIGFuZCBzbyB3ZSB1c2UgbmV4dFRpY2soKSBpbnN0ZWFkIG9mIGEgc3RyYWlnaHQgY2FsbGJhY2sgc28gYXMgdG8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYXZvaWQgYmxvd2luZyBvdXQgdGhlIHN0YWNrIHNpemUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQWxwYWNhLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkoaSwgZGF0YVtpXSk7CgogICAgICAgICAgICAgICAgICAgICAgICBmdW5jcy5wdXNoKGYpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIEFscGFjYS5zZXJpZXMoZnVuY3MsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBhbnl0aGluZyBvbmNlIGZpbmlzaGVkPwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250YWluZXJGaWVsZCNnZXRWYWx1ZQogICAgICAgICAqLwogICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIC8vIGlmIHdlJ3JlIGVtcHR5IGFuZCB3ZSdyZSBhbHNvIG5vdCByZXF1aXJlZCwgdGhlbiB3ZSBoYW5kIGJhY2sgdW5kZWZpbmVkCiAgICAgICAgICAgIGlmICh0aGlzLmNoaWxkcmVuLmxlbmd0aCA9PT0gMCAmJiAhdGhpcy5zY2hlbWEucmVxdWlyZWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gb3RoZXJ3aXNlLCBjb25zdHJ1Y3QgYW4gYXJyYXkgYW5kIGhhZCBpdCBiYWNrCiAgICAgICAgICAgIHZhciBvID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHYgPSB0aGlzLmNoaWxkcmVuW2ldLmdldFZhbHVlKCk7CgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZih2KSAhPT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgby5wdXNoKHYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgbnVtYmVyIG9mIGNoaWxkcmVuLgogICAgICAgICAqLwogICAgICAgIGdldFNpemU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jaGlsZHJlbi5sZW5ndGg7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVjdXJzaXZlIGZ1bmN0aW9uIGZvciBVcGRhdGUgY2hpbGQgZmllbGQgcGF0aCBhbmQgbmFtZS4KICAgICAgICAgKi8KICAgICAgICB1cGRhdGVDaGlsZHJlblBhdGhBbmROYW1lOiBmdW5jdGlvbihwYXJlbnQpIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgICAgICAgaWYgKHBhcmVudC5jaGlsZHJlbikgewogICAgICAgICAgICAgICAgJC5lYWNoKHBhcmVudC5jaGlsZHJlbiwgZnVuY3Rpb24oaSwgdikgewogICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQucHJlUGF0aCAmJiBBbHBhY2Euc3RhcnRzV2l0aCh2LnBhdGgscGFyZW50LnByZVBhdGgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHYucHJlUGF0aCA9IHYucGF0aDsKICAgICAgICAgICAgICAgICAgICAgICAgdi5wYXRoID0gdi5wYXRoLnJlcGxhY2UocGFyZW50LnByZVBhdGgscGFyZW50LnBhdGgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyByZS1jYWxjdWxhdGUgbmFtZQogICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQucHJlTmFtZSAmJiBBbHBhY2Euc3RhcnRzV2l0aCh2Lm5hbWUsIHBhcmVudC5wcmVOYW1lKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2LnByZU5hbWUgPSB2Lm5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHYubmFtZSA9IHYubmFtZS5yZXBsYWNlKHBhcmVudC5wcmVOYW1lLCBwYXJlbnQubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2LmZpZWxkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKHYuZmllbGQpLmF0dHIoJ25hbWUnLCB2Lm5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIF90aGlzLnVwZGF0ZUNoaWxkcmVuUGF0aEFuZE5hbWUodik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFVwZGF0ZSBmaWVsZCBwYXRoIGFuZCBuYW1lIHdoZW4gYW4gYXJyYXkgaXRlbSBpcyByZW1vdmVkLCBpbnNlcnRlZCBvciBzd2l0Y2hlZC4KICAgICAgICAgKi8KICAgICAgICB1cGRhdGVQYXRoQW5kTmFtZTogZnVuY3Rpb24oKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgICAgICAgaWYgKHRoaXMuY2hpbGRyZW4pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICQuZWFjaCh0aGlzLmNoaWxkcmVuLGZ1bmN0aW9uKGksdikgewogICAgICAgICAgICAgICAgICAgIHZhciBpZHggPSB2LnBhdGgubGFzdEluZGV4T2YoJy8nKTsKICAgICAgICAgICAgICAgICAgICB2YXIgbGFzdFNlZ21lbnQgPSB2LnBhdGguc3Vic3RyaW5nKGlkeCsxKTsKICAgICAgICAgICAgICAgICAgICBpZiAobGFzdFNlZ21lbnQuaW5kZXhPZigiWyIpICE9IC0xICYmIGxhc3RTZWdtZW50LmluZGV4T2YoIl0iKSAhPSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICBsYXN0U2VnbWVudCA9IGxhc3RTZWdtZW50LnN1YnN0cmluZyhsYXN0U2VnbWVudC5pbmRleE9mKCJbIikgKyAxLCBsYXN0U2VnbWVudC5pbmRleE9mKCJdIikpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAobGFzdFNlZ21lbnQgIT0gaSkgewogICAgICAgICAgICAgICAgICAgICAgICB2LnByZVBhdGggPSB2LnBhdGg7CiAgICAgICAgICAgICAgICAgICAgICAgIHYucGF0aCA9IHYucGF0aC5zdWJzdHJpbmcoMCwgaWR4KSArICIvWyIgKyBpICsgIl0iOwoKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gcmUtY2FsY3VsYXRlIG5hbWUKICAgICAgICAgICAgICAgICAgICBpZiAodi5uYW1lQ2FsY3VsYXRlZCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHYucHJlTmFtZSA9IHYubmFtZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2LnBhcmVudCAmJiB2LnBhcmVudC5uYW1lICYmIHYucGF0aCkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdi5uYW1lID0gdi5wYXJlbnQubmFtZSArICJfIiArIGk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodi5wYXRoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHYubmFtZSA9IHYucGF0aC5yZXBsYWNlKC9cLy9nLCAiIikucmVwbGFjZSgvXFsvZywgIl8iKS5yZXBsYWNlKC9cXS9nLCAiIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCgkJCSAgICAgICAgICAgIGlmICh0aGlzLnBhcmVudC5vcHRpb25zLnJ1YnlyYWlscyApCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodi5maWVsZCkuYXR0cignbmFtZScsIHYucGFyZW50Lm5hbWUpOwoJCQkgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCh2LmZpZWxkKS5hdHRyKCduYW1lJywgdi5uYW1lKTsKIAkJCSAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICghdi5wcmVQYXRoKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdi5wcmVQYXRoID0gdi5wYXRoOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBfdGhpcy51cGRhdGVDaGlsZHJlblBhdGhBbmROYW1lKHYpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBNb3ZlcyBjaGlsZCB1cCBvciBkb3duCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGZyb21JZCBJZCBvZiB0aGUgY2hpbGQgdG8gYmUgbW92ZWQuCiAgICAgICAgICogQHBhcmFtIHtCb29sZWFufSBpc1VwIHRydWUgaWYgdGhlIG1vdmluZyBpcyB1cHdhcmRzCiAgICAgICAgICovCiAgICAgICAgbW92ZUl0ZW06IGZ1bmN0aW9uKGZyb21JZCwgaXNVcCkgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICAgICAgICBpZiAodGhpcy5jaGlsZHJlbkJ5SWRbZnJvbUlkXSkgewogICAgICAgICAgICAgICAgLy8gZG8gdGhlIGxvb3AKICAgICAgICAgICAgICAgICQuZWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbihpbmRleCwgdmFsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbC5nZXRJZCgpID09IGZyb21JZCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9JbmRleDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzVXAgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvSW5kZXggPSBpbmRleCAtIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9JbmRleCA8IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0luZGV4ID0gX3RoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvSW5kZXggPSBpbmRleCArIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9JbmRleCA+PSBfdGhpcy5jaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0luZGV4ID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoX3RoaXMuY2hpbGRyZW5bdG9JbmRleF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0b0lkID0gX3RoaXMuY2hpbGRyZW5bdG9JbmRleF0uZ2V0SWQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmcm9tQ29udGFpbmVyID0gJCgnIycgKyBmcm9tSWQgKyAnLWl0ZW0tY29udGFpbmVyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9Db250YWluZXIgPSAkKCcjJyArIHRvSWQgKyAnLWl0ZW0tY29udGFpbmVyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5yZVJlbmRlckl0ZW0oX3RoaXMuY2hpbGRyZW5baW5kZXhdLCB0b0NvbnRhaW5lcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5yZVJlbmRlckl0ZW0oX3RoaXMuY2hpbGRyZW5bdG9JbmRleF0sIGZyb21Db250YWluZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRtcCA9IF90aGlzLmNoaWxkcmVuW2luZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNoaWxkcmVuW2luZGV4XSA9IF90aGlzLmNoaWxkcmVuW3RvSW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY2hpbGRyZW5bdG9JbmRleF0gPSB0bXA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy51cGRhdGVQYXRoQW5kTmFtZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZW1vdmVzIGNoaWxkCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGlkIElkIG9mIHRoZSBjaGlsZCB0byBiZSByZW1vdmVkCiAgICAgICAgICovCiAgICAgICAgcmVtb3ZlSXRlbTogZnVuY3Rpb24oaWQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3ZhbGlkYXRlRXF1YWxNaW5JdGVtcygpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNoaWxkcmVuID0gJC5ncmVwKHRoaXMuY2hpbGRyZW4sIGZ1bmN0aW9uKHZhbCwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKHZhbC5nZXRJZCgpICE9IGlkKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY2hpbGRyZW5CeUlkW2lkXTsKICAgICAgICAgICAgICAgICQoJyMnICsgaWQgKyAiLWl0ZW0tY29udGFpbmVyIiwgdGhpcy5vdXRlckVsKS5yZW1vdmUoKTsKICAgICAgICAgICAgICAgIHRoaXMucmVmcmVzaFZhbGlkYXRpb25TdGF0ZSgpOwogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVUb29sYmFySXRlbXNTdGF0dXMoKTsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlUGF0aEFuZE5hbWUoKTsKCiAgICAgICAgICAgICAgICAvLyB0cmlnZ2VyIHVwZGF0ZSBoYW5kbGVyCiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXJVcGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFVwZGF0ZXMgc3RhdHVzIG9mIHRvb2xiYXIgaXRlbXMuCiAgICAgICAgICovCiAgICAgICAgdXBkYXRlVG9vbGJhckl0ZW1zU3RhdHVzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgICAgICAgLy8gYWRkIGFjdGlvbnMgdG8gdG9vbGJhciBidXR0b25zCiAgICAgICAgICAgIGlmIChfdGhpcy5fdmFsaWRhdGVFcXVhbE1heEl0ZW1zKCkpIHsKICAgICAgICAgICAgICAgICQoJy5hbHBhY2EtZmllbGRzZXQtYXJyYXktaXRlbS10b29sYmFyLWFkZCcsIHRoaXMub3V0ZXJFbCkuZWFjaChmdW5jdGlvbihpbmRleCkgewogICAgICAgICAgICAgICAgICAgICQodGhpcykucmVtb3ZlQ2xhc3MoJ2FscGFjYS1maWVsZHNldC1hcnJheS1pdGVtLXRvb2xiYXItZGlzYWJsZWQnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJCgnLmFscGFjYS1maWVsZHNldC1hcnJheS1pdGVtLXRvb2xiYXItYWRkJywgdGhpcy5vdXRlckVsKS5lYWNoKGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcygnYWxwYWNhLWZpZWxkc2V0LWFycmF5LWl0ZW0tdG9vbGJhci1kaXNhYmxlZCcpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKF90aGlzLl92YWxpZGF0ZUVxdWFsTWluSXRlbXMoKSkgewogICAgICAgICAgICAgICAgJCgnLmFscGFjYS1maWVsZHNldC1hcnJheS1pdGVtLXRvb2xiYXItcmVtb3ZlJywgdGhpcy5vdXRlckVsKS5lYWNoKGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5yZW1vdmVDbGFzcygnYWxwYWNhLWZpZWxkc2V0LWFycmF5LWl0ZW0tdG9vbGJhci1kaXNhYmxlZCcpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkKCcuYWxwYWNhLWZpZWxkc2V0LWFycmF5LWl0ZW0tdG9vbGJhci1yZW1vdmUnLCB0aGlzLm91dGVyRWwpLmVhY2goZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKCdhbHBhY2EtZmllbGRzZXQtYXJyYXktaXRlbS10b29sYmFyLWRpc2FibGVkJyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5nZXRTaXplKCkgPT09IDApIHsKICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyQXJyYXlUb29sYmFyKHRoaXMub3V0ZXJFbCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5hcnJheVRvb2xiYXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFycmF5VG9vbGJhci5yZW1vdmUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyB1cGRhdGUgY291bnRlcgogICAgICAgICAgICAkKCcuYWxwYWNhLWl0ZW0tbGFiZWwtY291bnRlcicsIHRoaXMub3V0ZXJFbCkuZWFjaChmdW5jdGlvbihpbmRleCkgewogICAgICAgICAgICAgICAgJCh0aGlzKS5odG1sKGluZGV4ICsgMSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJlbmRlcnMgYXJyYXkgaXRlbSB0b29sYmFyLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lckVsZW0gVG9vbGJhciBjb250YWluZXIuCiAgICAgICAgICovCiAgICAgICAgcmVuZGVyVG9vbGJhcjogZnVuY3Rpb24oY29udGFpbmVyRWxlbSkgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgLy8gd2UgZG8gbm90IHJlbmRlciB0aGUgdG9vbGJhciBpbiAiZGlzcGxheSIgbW9kZQogICAgICAgICAgICBpZiAodGhpcy52aWV3ICYmIHRoaXMudmlldy50eXBlID09ICJ2aWV3IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5yZWFkb25seSkgewogICAgICAgICAgICAgICAgdmFyIGlkID0gY29udGFpbmVyRWxlbS5hdHRyKCdhbHBhY2EtaWQnKTsKICAgICAgICAgICAgICAgIHZhciBmaWVsZENvbnRyb2wgPSB0aGlzLmNoaWxkcmVuQnlJZFtpZF07CiAgICAgICAgICAgICAgICB2YXIgaXRlbVRvb2xiYXJUZW1wbGF0ZURlc2NyaXB0b3IgPSB0aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJhcnJheUl0ZW1Ub29sYmFyIik7CiAgICAgICAgICAgICAgICBpZiAoaXRlbVRvb2xiYXJUZW1wbGF0ZURlc2NyaXB0b3IpIHsKCiAgICAgICAgICAgICAgICAgICAgLy8gQmFzZSBidXR0b25zIDogYWRkICYgcmVtb3ZlCiAgICAgICAgICAgICAgICAgICAgdmFyIGJ1dHRvbnNEZWYgPSBbCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZlYXR1cmU6ICJhZGQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWNvbjogX3RoaXMuYWRkSWNvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiAoX3RoaXMub3B0aW9ucy5pdGVtcyAmJiBfdGhpcy5vcHRpb25zLml0ZW1zLmFkZEl0ZW1MYWJlbCkgPyBfdGhpcy5vcHRpb25zLml0ZW1zLmFkZEl0ZW1MYWJlbCA6ICJBZGQgSXRlbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGlja0NhbGxiYWNrOiBmdW5jdGlvbihpZCwgYXJyYXlGaWVsZCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5yZXNvbHZlSXRlbVNjaGVtYU9wdGlvbnMoZnVuY3Rpb24oc2NoZW1hLCBvcHRpb25zKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheUZpZWxkLmFkZEl0ZW0oY29udGFpbmVyRWxlbS5pbmRleCgpICsgMSwgc2NoZW1hLCBvcHRpb25zLCBudWxsLCBpZCwgdHJ1ZSwgZnVuY3Rpb24oYWRkZWRGaWVsZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXlGaWVsZC5lbnJpY2hFbGVtZW50cyhhZGRlZEZpZWxkLmdldEVsKCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmVhdHVyZTogInJlbW92ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpY29uOiBfdGhpcy5yZW1vdmVJY29uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IChfdGhpcy5vcHRpb25zLml0ZW1zICYmIF90aGlzLm9wdGlvbnMuaXRlbXMucmVtb3ZlSXRlbUxhYmVsKSA/IF90aGlzLm9wdGlvbnMuaXRlbXMucmVtb3ZlSXRlbUxhYmVsIDogIlJlbW92ZSBJdGVtIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsaWNrQ2FsbGJhY2s6IGZ1bmN0aW9uKGlkLCBhcnJheUZpZWxkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXlGaWVsZC5yZW1vdmVJdGVtKGlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIF07CgogICAgICAgICAgICAgICAgICAgIC8vIE9wdGlvbmFsIGJ1dHRvbnMgOiB1cCAmIGRvd24KICAgICAgICAgICAgICAgICAgICBpZiAoKF90aGlzLm9wdGlvbnMuaXRlbXMgJiYgX3RoaXMub3B0aW9ucy5pdGVtcy5zaG93TW92ZVVwSXRlbUJ1dHRvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uc0RlZi5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZlYXR1cmU6ICJ1cCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpY29uOiBfdGhpcy51cEljb24sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogKF90aGlzLm9wdGlvbnMuaXRlbXMgJiYgX3RoaXMub3B0aW9ucy5pdGVtcy5tb3ZlVXBJdGVtTGFiZWwpID8gX3RoaXMub3B0aW9ucy5pdGVtcy5tb3ZlVXBJdGVtTGFiZWwgOiAiTW92ZSBVcCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGlja0NhbGxiYWNrOiBmdW5jdGlvbihpZCwgYXJyYXlGaWVsZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5RmllbGQubW92ZUl0ZW0oaWQsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICgoX3RoaXMub3B0aW9ucy5pdGVtcyAmJiBfdGhpcy5vcHRpb25zLml0ZW1zLnNob3dNb3ZlRG93bkl0ZW1CdXR0b24pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbnNEZWYucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmZWF0dXJlOiAiZG93biIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpY29uOiBfdGhpcy5kb3duSWNvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiAoX3RoaXMub3B0aW9ucy5pdGVtcyAmJiBfdGhpcy5vcHRpb25zLml0ZW1zLm1vdmVEb3duSXRlbUxhYmVsKSA/IF90aGlzLm9wdGlvbnMuaXRlbXMubW92ZURvd25JdGVtTGFiZWwgOiAiTW92ZSBEb3duIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsaWNrQ2FsbGJhY2s6IGZ1bmN0aW9uKGlkLCBhcnJheUZpZWxkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXlGaWVsZC5tb3ZlSXRlbShpZCwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIEV4dHJhIGJ1dHRvbnMgOiB1c2VyLWRlZmluZWQKICAgICAgICAgICAgICAgICAgICBpZiAoX3RoaXMub3B0aW9ucy5pdGVtcyAmJiBfdGhpcy5vcHRpb25zLml0ZW1zLmV4dHJhVG9vbGJhckJ1dHRvbnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uc0RlZiA9ICQubWVyZ2UoYnV0dG9uc0RlZixfdGhpcy5vcHRpb25zLml0ZW1zLmV4dHJhVG9vbGJhckJ1dHRvbnMpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdmFyIHRvb2xiYXJFbGVtID0gX3RoaXMudmlldy50bXBsKGl0ZW1Ub29sYmFyVGVtcGxhdGVEZXNjcmlwdG9yLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJpZCI6IGlkLAogICAgICAgICAgICAgICAgICAgICAgICAiYnV0dG9ucyI6IGJ1dHRvbnNEZWYKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBpZiAodG9vbGJhckVsZW0uYXR0cigiaWQiKSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICB0b29sYmFyRWxlbS5hdHRyKCJpZCIsIGlkICsgIi1pdGVtLXRvb2xiYXIiKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIFByb2Nlc3MgYWxsIGJ1dHRvbnMKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIGJ1dHRvbnNEZWYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgKGZ1bmN0aW9uKGRlZikgeyAvLyBjbG9zdXJlIHRvIHByZXZlbnQgImRlZiIgbGVha2luZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVsID0gdG9vbGJhckVsZW0uZmluZCgnLmFscGFjYS1maWVsZHNldC1hcnJheS1pdGVtLXRvb2xiYXItJytkZWYuZmVhdHVyZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbC5jbGljayhmdW5jdGlvbihlKSB7cmV0dXJuIGRlZi5jbGlja0NhbGxiYWNrKGlkLCBfdGhpcywgZSk7fSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoX3RoaXMuYnV0dG9uQmVhdXRpZmllcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmJ1dHRvbkJlYXV0aWZpZXIuY2FsbChfdGhpcyxlbCwgZGVmLmljb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KShidXR0b25zRGVmW2ldKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMudG9vbGJhclN0aWNreSkgewogICAgICAgICAgICAgICAgICAgICAgICB0b29sYmFyRWxlbS5wcmVwZW5kVG8oY29udGFpbmVyRWxlbSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdG9vbGJhckVsZW0uaGlkZSgpLnByZXBlbmRUbyhjb250YWluZXJFbGVtKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyRWxlbS5ob3ZlcihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJy5hbHBhY2EtZmllbGRzZXQtYXJyYXktaXRlbS10b29sYmFyJywgdGhpcykuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJy5hbHBhY2EtZmllbGRzZXQtYXJyYXktaXRlbS10b29sYmFyJywgdGhpcykuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVuZGVycyBhcnJheSB0b29sYmFyLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXJFbGVtIEFycmF5IHRvb2xiYXIgY29udGFpbmVyLgogICAgICAgICAqLwogICAgICAgIHJlbmRlckFycmF5VG9vbGJhcjogZnVuY3Rpb24oY29udGFpbmVyRWxlbSkgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgLy8gd2UgZG8gbm90IHJlbmRlciB0aGUgYXJyYXkgdG9vbGJhciBpbiAiZGlzcGxheSIgbW9kZQogICAgICAgICAgICBpZiAodGhpcy52aWV3ICYmIHRoaXMudmlldy50eXBlID09ICJ2aWV3IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgaWQgPSBjb250YWluZXJFbGVtLmF0dHIoJ2FscGFjYS1pZCcpOwogICAgICAgICAgICB2YXIgaXRlbVRvb2xiYXJUZW1wbGF0ZURlc2NyaXB0b3IgPSB0aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJhcnJheVRvb2xiYXIiKTsKICAgICAgICAgICAgaWYgKGl0ZW1Ub29sYmFyVGVtcGxhdGVEZXNjcmlwdG9yKSB7CiAgICAgICAgICAgICAgICB2YXIgdG9vbGJhckVsZW0gPSBfdGhpcy52aWV3LnRtcGwoaXRlbVRvb2xiYXJUZW1wbGF0ZURlc2NyaXB0b3IsIHsKICAgICAgICAgICAgICAgICAgICAiaWQiOiBpZCwKICAgICAgICAgICAgICAgICAgICAiYWRkSXRlbUxhYmVsIjogKF90aGlzLm9wdGlvbnMuaXRlbXMgJiYgX3RoaXMub3B0aW9ucy5pdGVtcy5hZGRJdGVtTGFiZWwpID8gX3RoaXMub3B0aW9ucy5pdGVtcy5hZGRJdGVtTGFiZWwgOiAiQWRkIEl0ZW0iCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGlmICh0b29sYmFyRWxlbS5hdHRyKCJpZCIpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdG9vbGJhckVsZW0uYXR0cigiaWQiLCBpZCArICItYXJyYXktdG9vbGJhciIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGFkZCBhY3Rpb25zIHRvIHRvb2xiYXIgYnV0dG9ucwogICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy50b29sYmFyU3R5bGUgPT0gImxpbmsiKSB7CiAgICAgICAgICAgICAgICAgICAgJCgnLmFscGFjYS1maWVsZHNldC1hcnJheS10b29sYmFyLWFkZCcsIHRvb2xiYXJFbGVtKS5jbGljayhmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnJlc29sdmVJdGVtU2NoZW1hT3B0aW9ucyhmdW5jdGlvbihzY2hlbWEsIG9wdGlvbnMpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5hZGRJdGVtKDAsIHNjaGVtYSwgb3B0aW9ucywgIiIsIGlkLCB0cnVlLCBmdW5jdGlvbihhZGRlZEZpZWxkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuZW5yaWNoRWxlbWVudHMoYWRkZWRGaWVsZC5nZXRFbCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdG9vbGJhckVsZW1BZGQgPSAkKCcuYWxwYWNhLWZpZWxkc2V0LWFycmF5LXRvb2xiYXItYWRkJywgdG9vbGJhckVsZW0pOwogICAgICAgICAgICAgICAgICAgIGlmIChfdGhpcy5idXR0b25CZWF1dGlmaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmJ1dHRvbkJlYXV0aWZpZXIuY2FsbChfdGhpcywgdG9vbGJhckVsZW1BZGQsIF90aGlzLmFkZEljb24sIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0b29sYmFyRWxlbUFkZC5jbGljayhmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnJlc29sdmVJdGVtU2NoZW1hT3B0aW9ucyhmdW5jdGlvbihzY2hlbWEsIG9wdGlvbnMpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5hZGRJdGVtKDAsIHNjaGVtYSwgb3B0aW9ucywgIiIsIGlkLCB0cnVlLCBmdW5jdGlvbihhZGRlZEZpZWxkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuZW5yaWNoRWxlbWVudHMoYWRkZWRGaWVsZC5nZXRFbCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9KS53cmFwKCc8c21hbGw+PC9zbWFsbD4nKTsKCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0b29sYmFyRWxlbS5hcHBlbmRUbyhjb250YWluZXJFbGVtKTsKICAgICAgICAgICAgICAgIHRoaXMuYXJyYXlUb29sYmFyID0gdG9vbGJhckVsZW07CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZS1yZW5kZXJzIGl0ZW0uCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZmllbGRDb250cm9sIEl0ZW0gY29udHJvbCB0byBiZSByZS1yZW5kZXJlZAogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG5ld0NvbnRhaW5lciBOZXcgZmllbGQgY29udGFpbmVyLgogICAgICAgICAqLwogICAgICAgIHJlUmVuZGVySXRlbTogZnVuY3Rpb24oZmllbGRDb250cm9sLCBuZXdDb250YWluZXIpIHsKICAgICAgICAgICAgZmllbGRDb250cm9sLmNvbnRhaW5lciA9IG5ld0NvbnRhaW5lcjsKICAgICAgICAgICAgZmllbGRDb250cm9sLnJlbmRlcigpOwoKICAgICAgICAgICAgbmV3Q29udGFpbmVyLmF0dHIoImlkIiwgZmllbGRDb250cm9sLmdldElkKCkgKyAiLWl0ZW0tY29udGFpbmVyIik7CiAgICAgICAgICAgIG5ld0NvbnRhaW5lci5hdHRyKCJhbHBhY2EtaWQiLCBmaWVsZENvbnRyb2wuZ2V0SWQoKSk7CiAgICAgICAgICAgIG5ld0NvbnRhaW5lci5hZGRDbGFzcygiYWxwYWNhLWl0ZW0tY29udGFpbmVyIik7CgogICAgICAgICAgICAkKCIuYWxwYWNhLWZpZWxkc2V0LWFycmF5LWl0ZW0tdG9vbGJhciIsIG5ld0NvbnRhaW5lcikucmVtb3ZlKCk7CiAgICAgICAgICAgIHRoaXMucmVuZGVyVG9vbGJhcihuZXdDb250YWluZXIpOwogICAgICAgICAgICB0aGlzLmVucmljaEVsZW1lbnRzKG5ld0NvbnRhaW5lcik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQWRkcyBpdGVtLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGluZGV4IEluZGV4IG9mIHRoZSBpdGVtCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGl0ZW1TY2hlbWEgZmllbGQgc2NoZW1hCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGl0ZW1PcHRpb25zIGZpZWxkIG9wdGlvbnMKICAgICAgICAgKiBAcGFyYW0ge0FueX0gaXRlbURhdGEgZmllbGQgZGF0YQogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBpbnNlcnRBZnRlcklkIFdoZXJlIHRoZSBpdGVtIHdpbGwgYmUgaW5zZXJ0ZWQKICAgICAgICAgKiBAcGFyYW0gW0Jvb2xlYW5dIGlzRHluYW1pY1N1Ykl0ZW0gd2hldGhlciB0aGlzIGl0ZW0gaXMgYmVpbmcgZHluYW1pY2FsbHkgY3JlYXRlZCAoYWZ0ZXIgZmlyc3QgcmVuZGVyKQogICAgICAgICAqIEBwYXJhbSBbRnVuY3Rpb25dIHBvc3RSZW5kZXJDYWxsYmFjayBjYWxsZWQgYWZ0ZXIgdGhlIGNoaWxkIGlzIGFkZGVkCiAgICAgICAgICovCiAgICAgICAgYWRkSXRlbTogZnVuY3Rpb24oaW5kZXgsIGl0ZW1TY2hlbWEsIGl0ZW1PcHRpb25zLCBpdGVtRGF0YSwgaW5zZXJ0QWZ0ZXJJZCwgaXNEeW5hbWljU3ViSXRlbSwgcG9zdFJlbmRlckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9hZGRJdGVtKGluZGV4LCBpdGVtU2NoZW1hLCBpdGVtT3B0aW9ucywgaXRlbURhdGEsIGluc2VydEFmdGVySWQsIGlzRHluYW1pY1N1Ykl0ZW0sIHBvc3RSZW5kZXJDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogV29ya2hvcnNlIG1ldGhvZCBmb3IgYWRkSXRlbS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBpbmRleAogICAgICAgICAqIEBwYXJhbSBpdGVtU2NoZW1hCiAgICAgICAgICogQHBhcmFtIGl0ZW1PcHRpb25zCiAgICAgICAgICogQHBhcmFtIGl0ZW1EYXRhCiAgICAgICAgICogQHBhcmFtIGluc2VydEFmdGVySWQKICAgICAgICAgKiBAcGFyYW0gaXNEeW5hbWljU3ViSXRlbQogICAgICAgICAqIEBwYXJhbSBwb3N0UmVuZGVyQ2FsbGJhY2sKICAgICAgICAgKiBAcmV0dXJuIHsqfQogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgX2FkZEl0ZW06IGZ1bmN0aW9uKGluZGV4LCBpdGVtU2NoZW1hLCBpdGVtT3B0aW9ucywgaXRlbURhdGEsIGluc2VydEFmdGVySWQsIGlzRHluYW1pY1N1Ykl0ZW0sIHBvc3RSZW5kZXJDYWxsYmFjaykgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICAgICAgICBpZiAoX3RoaXMuX3ZhbGlkYXRlRXF1YWxNYXhJdGVtcygpKSB7CgogICAgICAgICAgICAgICAgaWYgKGl0ZW1PcHRpb25zID09PSBudWxsICYmIF90aGlzLm9wdGlvbnMgJiYgX3RoaXMub3B0aW9ucy5maWVsZHMgJiYgX3RoaXMub3B0aW9ucy5maWVsZHNbIml0ZW0iXSkgewogICAgICAgICAgICAgICAgICAgIGl0ZW1PcHRpb25zID0gX3RoaXMub3B0aW9ucy5maWVsZHNbIml0ZW0iXTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgY29udGFpbmVyRWxlbSA9IF90aGlzLnJlbmRlckl0ZW1Db250YWluZXIoaW5zZXJ0QWZ0ZXJJZCk7CiAgICAgICAgICAgICAgICBjb250YWluZXJFbGVtLmFscGFjYSh7CiAgICAgICAgICAgICAgICAgICAgImRhdGEiIDogaXRlbURhdGEsCiAgICAgICAgICAgICAgICAgICAgIm9wdGlvbnMiOiBpdGVtT3B0aW9ucywKICAgICAgICAgICAgICAgICAgICAic2NoZW1hIiA6IGl0ZW1TY2hlbWEsCiAgICAgICAgICAgICAgICAgICAgInZpZXciIDogdGhpcy52aWV3LmlkID8gdGhpcy52aWV3LmlkIDogdGhpcy52aWV3LAogICAgICAgICAgICAgICAgICAgICJjb25uZWN0b3IiOiB0aGlzLmNvbm5lY3RvciwKICAgICAgICAgICAgICAgICAgICAiZXJyb3IiOiBmdW5jdGlvbihlcnIpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5kZXN0cm95KCk7CgogICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5lcnJvckNhbGxiYWNrLmNhbGwoX3RoaXMsIGVycik7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAibm90VG9wTGV2ZWwiOnRydWUsCiAgICAgICAgICAgICAgICAgICAgImlzRHluYW1pY0NyZWF0aW9uIjogKGlzRHluYW1pY1N1Ykl0ZW0gfHwgdGhpcy5pc0R5bmFtaWNDcmVhdGlvbiksCiAgICAgICAgICAgICAgICAgICAgInJlbmRlciIgOiBmdW5jdGlvbihmaWVsZENvbnRyb2wsIGNiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbmRlcgogICAgICAgICAgICAgICAgICAgICAgICBmaWVsZENvbnRyb2wucGFyZW50ID0gX3RoaXM7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNldHVwIGl0ZW0gcGF0aAogICAgICAgICAgICAgICAgICAgICAgICBmaWVsZENvbnRyb2wucGF0aCA9IF90aGlzLnBhdGggKyAiWyIgKyBpbmRleCArICJdIjsKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRDb250cm9sLm5hbWVDYWxjdWxhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRDb250cm9sLnJlbmRlcihudWxsLCBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXJFbGVtLmF0dHIoImlkIiwgZmllbGRDb250cm9sLmdldElkKCkgKyAiLWl0ZW0tY29udGFpbmVyIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXJFbGVtLmF0dHIoImFscGFjYS1pZCIsIGZpZWxkQ29udHJvbC5nZXRJZCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lckVsZW0uYWRkQ2xhc3MoImFscGFjYS1pdGVtLWNvbnRhaW5lciIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVuZGVyIGl0ZW0gbGFiZWwgaWYgbmVlZGVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoX3RoaXMub3B0aW9ucyAmJiBfdGhpcy5vcHRpb25zLml0ZW1MYWJlbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpdGVtTGFiZWxUZW1wbGF0ZURlc2NyaXB0b3IgPSBfdGhpcy52aWV3LmdldFRlbXBsYXRlRGVzY3JpcHRvcigiaXRlbUxhYmVsIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW1MYWJlbEVsZW0gPSBfdGhpcy52aWV3LnRtcGwoaXRlbUxhYmVsVGVtcGxhdGVEZXNjcmlwdG9yLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJvcHRpb25zIjogX3RoaXMub3B0aW9ucywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImluZGV4IjogaW5kZXggPyBpbmRleCArIDEgOiAxLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaWQiOiBfdGhpcy5pZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1MYWJlbEVsZW0ucHJlcGVuZFRvKGNvbnRhaW5lckVsZW0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVtZW1iZXIgdGhlIGNvbnRyb2wKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmFkZENoaWxkKGZpZWxkQ29udHJvbCwgaW5kZXgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMucmVuZGVyVG9vbGJhcihjb250YWluZXJFbGVtKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnJlZnJlc2hWYWxpZGF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnVwZGF0ZVBhdGhBbmROYW1lKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdHJpZ2dlciB1cGRhdGUgb24gdGhlIHBhcmVudCBhcnJheQogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMudHJpZ2dlclVwZGF0ZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIG5vdCBlbXB0eSwgbWFyayB0aGUgImxhc3QiIGFuZCAiZmlyc3QiIGRvbSBlbGVtZW50cyBpbiB0aGUgbGlzdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQoY29udGFpbmVyRWxlbSkuc2libGluZ3MoKS5hZGRCYWNrKCkubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGNvbnRhaW5lckVsZW0pLnBhcmVudCgpLnJlbW92ZUNsYXNzKCJhbHBhY2EtZmllbGRzZXQtaXRlbXMtY29udGFpbmVyLWVtcHR5Iik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoY29udGFpbmVyRWxlbSkuc2libGluZ3MoKS5hZGRCYWNrKCkucmVtb3ZlQ2xhc3MoImFscGFjYS1pdGVtLWNvbnRhaW5lci1maXJzdCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoY29udGFpbmVyRWxlbSkuc2libGluZ3MoKS5hZGRCYWNrKCkucmVtb3ZlQ2xhc3MoImFscGFjYS1pdGVtLWNvbnRhaW5lci1sYXN0Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJChjb250YWluZXJFbGVtKS5zaWJsaW5ncygpLmFkZEJhY2soKS5maXJzdCgpLmFkZENsYXNzKCJhbHBhY2EtaXRlbS1jb250YWluZXItZmlyc3QiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGNvbnRhaW5lckVsZW0pLnNpYmxpbmdzKCkuYWRkQmFjaygpLmxhc3QoKS5hZGRDbGFzcygiYWxwYWNhLWl0ZW0tY29udGFpbmVyLWxhc3QiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzdG9yZSBrZXkgb24gZG9tIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoY29udGFpbmVyRWxlbSkuYXR0cigiZGF0YS1hbHBhY2EtaXRlbS1jb250YWluZXItaXRlbS1rZXkiLCBpbmRleCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMudXBkYXRlVG9vbGJhckl0ZW1zU3RhdHVzKF90aGlzLm91dGVyRWwpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNGdW5jdGlvbihfdGhpcy5vcHRpb25zLml0ZW1zLnBvc3RSZW5kZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMub3B0aW9ucy5pdGVtcy5wb3N0UmVuZGVyKGNvbnRhaW5lckVsZW0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJwb3N0UmVuZGVyIjogZnVuY3Rpb24oY29udHJvbCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwb3N0UmVuZGVyQ2FsbGJhY2spCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc3RSZW5kZXJDYWxsYmFjayhjb250cm9sKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vdGhpcy51cGRhdGVUb29sYmFySXRlbXNTdGF0dXModGhpcy5vdXRlckVsKTsKCiAgICAgICAgICAgICAgICByZXR1cm4gY29udGFpbmVyRWxlbTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEVucmljaGVzIHN0eWxlcyBmb3IgZHluYW1pYyBlbGVtZW50cy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXJFbGVtIEZpZWxkIGNvbnRhaW5lciBlbGVtZW50LgogICAgICAgICAqLwogICAgICAgIGVucmljaEVsZW1lbnRzOiBmdW5jdGlvbihjb250YWluZXJFbGVtKSB7CiAgICAgICAgICAgIHRoaXMuZ2V0U3R5bGVJbmplY3Rpb24oJ2FycmF5Jyxjb250YWluZXJFbGVtKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBEZXRlcm1pbmVzIHRoZSBzY2hlbWEgYW5kIG9wdGlvbnMgdG8gdXRpbGl6ZSBmb3IgaXRlbXMgd2l0aGluIHRoaXMgYXJyYXkuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gY2FsbGJhY2sKICAgICAgICAgKi8KICAgICAgICByZXNvbHZlSXRlbVNjaGVtYU9wdGlvbnM6IGZ1bmN0aW9uKGNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIHZhciBpdGVtT3B0aW9uczsKICAgICAgICAgICAgaWYgKF90aGlzLm9wdGlvbnMgJiYgX3RoaXMub3B0aW9ucy5maWVsZHMgJiYgX3RoaXMub3B0aW9ucy5maWVsZHNbIml0ZW0iXSkgewogICAgICAgICAgICAgICAgaXRlbU9wdGlvbnMgPSBfdGhpcy5vcHRpb25zLmZpZWxkc1siaXRlbSJdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpdGVtU2NoZW1hOwogICAgICAgICAgICBpZiAoX3RoaXMuc2NoZW1hICYmIF90aGlzLnNjaGVtYS5pdGVtcykgewogICAgICAgICAgICAgICAgaXRlbVNjaGVtYSA9IF90aGlzLnNjaGVtYS5pdGVtczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaGFuZGxlICRyZWYKICAgICAgICAgICAgaWYgKGl0ZW1TY2hlbWEgJiYgaXRlbVNjaGVtYVsiJHJlZiJdKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgcmVmZXJlbmNlSWQgPSBpdGVtU2NoZW1hWyIkcmVmIl07CgogICAgICAgICAgICAgICAgdmFyIHRvcEZpZWxkID0gdGhpczsKICAgICAgICAgICAgICAgIHZhciBmaWVsZENoYWluID0gW3RvcEZpZWxkXTsKICAgICAgICAgICAgICAgIHdoaWxlICh0b3BGaWVsZC5wYXJlbnQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdG9wRmllbGQgPSB0b3BGaWVsZC5wYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgZmllbGRDaGFpbi5wdXNoKHRvcEZpZWxkKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxJdGVtU2NoZW1hID0gaXRlbVNjaGVtYTsKICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbEl0ZW1PcHRpb25zID0gaXRlbU9wdGlvbnM7CgogICAgICAgICAgICAgICAgQWxwYWNhLmxvYWRSZWZTY2hlbWFPcHRpb25zKHRvcEZpZWxkLCByZWZlcmVuY2VJZCwgZnVuY3Rpb24oaXRlbVNjaGVtYSwgaXRlbU9wdGlvbnMpIHsKCiAgICAgICAgICAgICAgICAgICAgLy8gd2FsayB0aGUgZmllbGQgY2hhaW4gdG8gc2VlIGlmIHdlIGhhdmUgYW55IGNpcmN1bGFyaXR5CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlZkNvdW50ID0gMDsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZpZWxkQ2hhaW4ubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmllbGRDaGFpbltpXS5zY2hlbWEgJiYgZmllbGRDaGFpbltpXS5zY2hlbWEuaWQgPT09IHJlZmVyZW5jZUlkKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWZDb3VudCsrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgY2lyY3VsYXIgPSAocmVmQ291bnQgPiAxKTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc29sdmVkSXRlbVNjaGVtYSA9IHt9OwogICAgICAgICAgICAgICAgICAgIGlmIChvcmlnaW5hbEl0ZW1TY2hlbWEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgQWxwYWNhLm1lcmdlT2JqZWN0KHJlc29sdmVkSXRlbVNjaGVtYSwgb3JpZ2luYWxJdGVtU2NoZW1hKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW1TY2hlbWEpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBBbHBhY2EubWVyZ2VPYmplY3QocmVzb2x2ZWRJdGVtU2NoZW1hLCBpdGVtU2NoZW1hKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHJlc29sdmVkSXRlbVNjaGVtYS5pZDsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc29sdmVkSXRlbU9wdGlvbnMgPSB7fTsKICAgICAgICAgICAgICAgICAgICBpZiAob3JpZ2luYWxJdGVtT3B0aW9ucykgewogICAgICAgICAgICAgICAgICAgICAgICBBbHBhY2EubWVyZ2VPYmplY3QocmVzb2x2ZWRJdGVtT3B0aW9ucywgb3JpZ2luYWxJdGVtT3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChpdGVtT3B0aW9ucykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIEFscGFjYS5tZXJnZU9iamVjdChyZXNvbHZlZEl0ZW1PcHRpb25zLCBpdGVtT3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhyZXNvbHZlZEl0ZW1TY2hlbWEsIHJlc29sdmVkSXRlbU9wdGlvbnMsIGNpcmN1bGFyKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2FsbGJhY2soaXRlbVNjaGVtYSwgaXRlbU9wdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udGFpbmVyRmllbGQjcmVuZGVySXRlbXMKICAgICAgICAgKi8KICAgICAgICByZW5kZXJJdGVtczogZnVuY3Rpb24ob25TdWNjZXNzKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgLy8gbWFyayBmaWVsZCBjb250YWluZXIgYXMgZW1wdHkgYnkgZGVmYXVsdAogICAgICAgICAgICAvLyB0aGUgImFkZEl0ZW0iIG1ldGhvZCBiZWxvdyBnZXRzIHRoZSBvcHBvcnR1bml0eSB0byB1bnNldCB0aGlzCiAgICAgICAgICAgICQoc2VsZi5maWVsZENvbnRhaW5lcikuYWRkQ2xhc3MoImFscGFjYS1maWVsZHNldC1pdGVtcy1jb250YWluZXItZW1wdHkiKTsKCiAgICAgICAgICAgIGlmIChzZWxmLmRhdGEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIGFsbCBpdGVtcyB3aXRoaW4gdGhlIGFycmF5IGhhdmUgdGhlIHNhbWUgc2NoZW1hIGFuZCBvcHRpb25zCiAgICAgICAgICAgICAgICAvLyBzbyB3ZSBvbmx5IG5lZWQgdG8gbG9hZCB0aGlzIG9uY2UKICAgICAgICAgICAgICAgIHNlbGYucmVzb2x2ZUl0ZW1TY2hlbWFPcHRpb25zKGZ1bmN0aW9uKHNjaGVtYSwgb3B0aW9ucykgewoKICAgICAgICAgICAgICAgICAgICAvLyB3YXRlcmZhbGwgZnVuY3Rpb25zCiAgICAgICAgICAgICAgICAgICAgdmFyIGZ1bmNzID0gW107CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaW5kZXggPSAwOyBpbmRleCA8IHNlbGYuZGF0YS5sZW5ndGg7IGluZGV4KyspCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBzZWxmLmRhdGFbaW5kZXhdOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBmID0gKGZ1bmN0aW9uKGluZGV4LCB2YWx1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGNhbGxiYWNrKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuYWRkSXRlbShpbmRleCwgc2NoZW1hLCBvcHRpb25zLCB2YWx1ZSwgZmFsc2UsIGZhbHNlLCBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJ5IHRoZSB0aW1lIHdlIGdldCBoZXJlLCB3ZSBtYXkgaGF2ZSBjb25zdHJ1Y3RlZCBhIHZlcnkgbGFyZ2UgY2hpbGQgY2hhaW4gb2YKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3ViLWRlcGVuZGVuY2llcyBhbmQgc28gd2UgdXNlIG5leHRUaWNrKCkgaW5zdGVhZCBvZiBhIHN0cmFpZ2h0IGNhbGxiYWNrIHNvIGFzIHRvCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGF2b2lkIGJsb3dpbmcgb3V0IHRoZSBzdGFjayBzaXplCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFscGFjYS5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICB9KShpbmRleCwgdmFsdWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3MucHVzaChwZik7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBBbHBhY2Euc2VyaWVzKGZ1bmNzLCBmdW5jdGlvbihlcnIpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudXBkYXRlVG9vbGJhckl0ZW1zU3RhdHVzKCk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAob25TdWNjZXNzKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvblN1Y2Nlc3MoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc2VsZi51cGRhdGVUb29sYmFySXRlbXNTdGF0dXMoKTsKCiAgICAgICAgICAgICAgICBpZiAob25TdWNjZXNzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG9uU3VjY2VzcygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaWRhdGVzIGlmIHRoZSBudW1iZXIgb2YgaXRlbXMgaGFzIGJlZW4gcmVhY2hlZCB0byBtYXhJdGVtcy4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gdHJ1ZSBpZiB0aGUgbnVtYmVyIG9mIGl0ZW1zIGhhcyBiZWVuIHJlYWNoZWQgdG8gbWF4SXRlbXMKICAgICAgICAgKi8KICAgICAgICBfdmFsaWRhdGVFcXVhbE1heEl0ZW1zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc2NoZW1hLml0ZW1zICYmIHRoaXMuc2NoZW1hLml0ZW1zLm1heEl0ZW1zKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXRTaXplKCkgPj0gdGhpcy5zY2hlbWEuaXRlbXMubWF4SXRlbXMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaWRhdGVzIGlmIHRoZSBudW1iZXIgb2YgaXRlbXMgaGFzIGJlZW4gcmVhY2hlZCB0byBtaW5JdGVtcy4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gdHJ1ZSBpZiBudW1iZXIgb2YgaXRlbXMgaGFzIGJlZW4gcmVhY2hlZCB0byBtaW5JdGVtcwogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZUVxdWFsTWluSXRlbXM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5zY2hlbWEuaXRlbXMgJiYgdGhpcy5zY2hlbWEuaXRlbXMubWluSXRlbXMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdldFNpemUoKSA8PSB0aGlzLnNjaGVtYS5pdGVtcy5taW5JdGVtcykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBWYWxpZGF0ZXMgaWYgbnVtYmVyIG9mIGl0ZW1zIGhhcyBiZWVuIGxlc3MgdGhhbiBtaW5JdGVtcy4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gdHJ1ZSBpZiBudW1iZXIgb2YgaXRlbXMgaGFzIGJlZW4gbGVzcyB0aGFuIG1pbkl0ZW1zCiAgICAgICAgICovCiAgICAgICAgX3ZhbGlkYXRlTWluSXRlbXM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5zY2hlbWEuaXRlbXMgJiYgdGhpcy5zY2hlbWEuaXRlbXMubWluSXRlbXMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdldFNpemUoKSA8IHRoaXMuc2NoZW1hLml0ZW1zLm1pbkl0ZW1zKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlcyBpZiBudW1iZXIgb2YgaXRlbXMgaGFzIGJlZW4gb3ZlciBtYXhJdGVtcy4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gdHJ1ZSBpZiBudW1iZXIgb2YgaXRlbXMgaGFzIGJlZW4gb3ZlciBtYXhJdGVtcwogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZU1heEl0ZW1zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc2NoZW1hLml0ZW1zICYmIHRoaXMuc2NoZW1hLml0ZW1zLm1heEl0ZW1zKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXRTaXplKCkgPiB0aGlzLnNjaGVtYS5pdGVtcy5tYXhJdGVtcykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBWYWxpZGF0ZXMgaWYgYWxsIGl0ZW1zIGFyZSB1bmlxdWUuCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IHRydWUgaWYgYWxsIGl0ZW1zIGFyZSB1bmlxdWUuCiAgICAgICAgICovCiAgICAgICAgX3ZhbGlkYXRlVW5pcXVlSXRlbXM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5zY2hlbWEuaXRlbXMgJiYgdGhpcy5zY2hlbWEudW5pcXVlSXRlbXMpIHsKICAgICAgICAgICAgICAgIHZhciBoYXNoID0ge307CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMuY2hpbGRyZW4ubGVuZ3RoOyBpIDwgbDsgKytpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFoYXNoLmhhc093blByb3BlcnR5KHRoaXMuY2hpbGRyZW5baV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGhhc2hbdGhpcy5jaGlsZHJlbltpXV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udGFpbmVyRmllbGQjaGFuZGxlVmFsaWRhdGUKICAgICAgICAgKi8KICAgICAgICBoYW5kbGVWYWxpZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBiYXNlU3RhdHVzID0gdGhpcy5iYXNlKCk7CgogICAgICAgICAgICB2YXIgdmFsSW5mbyA9IHRoaXMudmFsaWRhdGlvbjsKCiAgICAgICAgICAgIHZhciBzdGF0dXMgPSB0aGlzLl92YWxpZGF0ZVVuaXF1ZUl0ZW1zKCk7CiAgICAgICAgICAgIHZhbEluZm9bInZhbHVlTm90VW5pcXVlIl0gPSB7CiAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHN0YXR1cyA/ICIiIDogdGhpcy52aWV3LmdldE1lc3NhZ2UoInZhbHVlTm90VW5pcXVlIiksCiAgICAgICAgICAgICAgICAic3RhdHVzIjogc3RhdHVzCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBzdGF0dXMgPSB0aGlzLl92YWxpZGF0ZU1heEl0ZW1zKCk7CiAgICAgICAgICAgIHZhbEluZm9bInRvb01hbnlJdGVtcyJdID0gewogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiBzdGF0dXMgPyAiIiA6IEFscGFjYS5zdWJzdGl0dXRlVG9rZW5zKHRoaXMudmlldy5nZXRNZXNzYWdlKCJ0b29NYW55SXRlbXMiKSwgW3RoaXMuc2NoZW1hLml0ZW1zLm1heEl0ZW1zXSksCiAgICAgICAgICAgICAgICAic3RhdHVzIjogc3RhdHVzCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBzdGF0dXMgPSB0aGlzLl92YWxpZGF0ZU1pbkl0ZW1zKCk7CiAgICAgICAgICAgIHZhbEluZm9bIm5vdEVub3VnaEl0ZW1zIl0gPSB7CiAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHN0YXR1cyA/ICIiIDogQWxwYWNhLnN1YnN0aXR1dGVUb2tlbnModGhpcy52aWV3LmdldE1lc3NhZ2UoIm5vdEVub3VnaEl0ZW1zIiksIFt0aGlzLnNjaGVtYS5pdGVtcy5taW5JdGVtc10pLAogICAgICAgICAgICAgICAgInN0YXR1cyI6IHN0YXR1cwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgcmV0dXJuIGJhc2VTdGF0dXMgJiYgdmFsSW5mb1sidmFsdWVOb3RVbmlxdWUiXVsic3RhdHVzIl0gJiYgdmFsSW5mb1sidG9vTWFueUl0ZW1zIl1bInN0YXR1cyJdICYmIHZhbEluZm9bIm5vdEVub3VnaEl0ZW1zIl1bInN0YXR1cyJdOwogICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRhaW5lckZpZWxkI2dldFNjaGVtYU9mU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZTY2hlbWE6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcHJvcGVydGllcyA9IHsKICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICJpdGVtcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkFycmF5IEl0ZW1zIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlNjaGVtYSBmb3IgYXJyYXkgaXRlbXMuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAib2JqZWN0IiwKICAgICAgICAgICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWluSXRlbXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIk1pbmltdW0gSXRlbXMiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJNaW5pbXVtIG51bWJlciBvZiBpdGVtcy4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm51bWJlciIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWF4SXRlbXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIk1heGltdW0gSXRlbXMiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJNYXhpbXVtIG51bWJlciBvZiBpdGVtcy4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm51bWJlciIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidW5pcXVlSXRlbXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkl0ZW1zIFVuaXF1ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkl0ZW0gdmFsdWVzIHNob3VsZCBiZSB1bmlxdWUgaWYgdHJ1ZS4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogZmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmICh0aGlzLmNoaWxkcmVuICYmIHRoaXMuY2hpbGRyZW5bMF0pIHsKICAgICAgICAgICAgICAgIEFscGFjYS5tZXJnZShwcm9wZXJ0aWVzLnByb3BlcnRpZXMuaXRlbXMucHJvcGVydGllcywgdGhpcy5jaGlsZHJlblswXS5nZXRTY2hlbWFPZlNjaGVtYSgpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgcHJvcGVydGllcyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250YWluZXJGaWVsZCNnZXRPcHRpb25zRm9yU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0ZvclNjaGVtYTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgIml0ZW1zIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJvYmplY3QiLAogICAgICAgICAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1pbkl0ZW1zIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1heEl0ZW1zIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInVuaXF1ZUl0ZW1zIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udGFpbmVyRmllbGQjZ2V0U2NoZW1hT2ZPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHByb3BlcnRpZXMgPSB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAidG9vbGJhclN0aWNreSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlN0aWNreSBUb29sYmFyIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkFycmF5IGl0ZW0gdG9vbGJhciB3aWxsIGJlIGF3YXlzIG9uIGlmIHRydWUuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogZmFsc2UKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJpdGVtcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkFycmF5IEl0ZW1zIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIk9wdGlvbnMgZm9yIGFycmF5IGl0ZW1zLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm9iamVjdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgImV4dHJhVG9vbGJhckJ1dHRvbnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkV4dHJhIFRvb2xiYXIgYnV0dG9ucyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkJ1dHRvbnMgdG8gYmUgYWRkZWQgbmV4dCB0byBhZGQvcmVtb3ZlL3VwL2Rvd24sIHNlZSBleGFtcGxlcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYXJyYXkiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogdW5kZWZpbmVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1vdmVVcEl0ZW1MYWJlbCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiTW92ZSBVcCBJdGVtIExhYmVsIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiVGhlIGxhYmVsIHRvIHVzZSBmb3IgdGhlIHRvb2xiYXIncyAnbW92ZSB1cCcgYnV0dG9uLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6ICJNb3ZlIFVwIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtb3ZlRG93bkl0ZW1MYWJlbCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiTW92ZSBEb3duIEl0ZW0gTGFiZWwiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJUaGUgbGFiZWwgdG8gdXNlIGZvciB0aGUgdG9vbGJhcidzICdtb3ZlIGRvd24nIGJ1dHRvbi4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiAiTW92ZSBEb3duIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJyZW1vdmVJdGVtTGFiZWwiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlJlbW92ZSBJdGVtIExhYmVsIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiVGhlIGxhYmVsIHRvIHVzZSBmb3IgdGhlIHRvb2xiYXIncyAncmVtb3ZlIGl0ZW0nIGJ1dHRvbi4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiAiUmVtb3ZlIEl0ZW0iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImFkZEl0ZW1MYWJlbCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiQWRkIEl0ZW0gTGFiZWwiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJUaGUgbGFiZWwgdG8gdXNlIGZvciB0aGUgdG9vbGJhcidzICdhZGQgaXRlbScgYnV0dG9uLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6ICJBZGQgSXRlbSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic2hvd01vdmVEb3duSXRlbUJ1dHRvbiI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiU2hvdyBNb3ZlIERvd24gSXRlbSBCdXR0b24iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJXaGV0aGVyIHRvIHNob3cgdG8gdGhlICdNb3ZlIERvd24nIGJ1dHRvbiBvbiB0aGUgdG9vbGJhci4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzaG93TW92ZVVwSXRlbUJ1dHRvbiI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiU2hvdyBNb3ZlIFVwIEl0ZW0gQnV0dG9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiV2hldGhlciB0byBzaG93IHRoZSAnTW92ZSBVcCcgYnV0dG9uIG9uIHRoZSB0b29sYmFyLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpZiAodGhpcy5jaGlsZHJlbiAmJiB0aGlzLmNoaWxkcmVuWzBdKSB7CiAgICAgICAgICAgICAgICBBbHBhY2EubWVyZ2UocHJvcGVydGllcy5wcm9wZXJ0aWVzLml0ZW1zLnByb3BlcnRpZXMsIHRoaXMuY2hpbGRyZW5bMF0uZ2V0U2NoZW1hT2ZTY2hlbWEoKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHByb3BlcnRpZXMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udGFpbmVyRmllbGQjZ2V0T3B0aW9uc0Zvck9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgInRvb2xiYXJTdGlja3kiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgIml0ZW1zIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJvYmplY3QiLAogICAgICAgICAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRhaW5lckZpZWxkI2dldFRpdGxlCiAgICAgICAgICovCiAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIkFycmF5IEZpZWxkIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250YWluZXJGaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJGaWVsZCBmb3IgbGlzdCBvZiBpdGVtcyB3aXRoIHNhbWUgZGF0YSB0eXBlIG9yIHN0cnVjdHVyZS4iOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRhaW5lckZpZWxkI2dldFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJhcnJheSI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udGFpbmVyRmllbGQjZ2V0RmlsZWRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJhcnJheSI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJUZW1wbGF0ZSgiaXRlbUxhYmVsIiwgJ3t7aWYgb3B0aW9ucy5pdGVtTGFiZWx9fTxkaXYgY2xhc3M9ImFscGFjYS1jb250cm9sZmllbGQtbGFiZWwiPjxkaXY+JHtvcHRpb25zLml0ZW1MYWJlbH17e2lmIGluZGV4fX0gPHNwYW4gY2xhc3M9ImFscGFjYS1pdGVtLWxhYmVsLWNvdW50ZXIiPiR7aW5kZXh9PC9zcGFuPnt7L2lmfX08L2Rpdj48L2Rpdj57ey9pZn19Jyk7CiAgICBBbHBhY2EucmVnaXN0ZXJUZW1wbGF0ZSgiYXJyYXlUb29sYmFyIiwgJzxzcGFuIGNsYXNzPSJ1aS13aWRnZXQgdWktY29ybmVyLWFsbCBhbHBhY2EtZmllbGRzZXQtYXJyYXktdG9vbGJhciI+PGJ1dHRvbiBjbGFzcz0iYWxwYWNhLWZpZWxkc2V0LWFycmF5LXRvb2xiYXItaWNvbiBhbHBhY2EtZmllbGRzZXQtYXJyYXktdG9vbGJhci1hZGQiPiR7YWRkSXRlbUxhYmVsfTwvYnV0dG9uPjwvc3Bhbj4nKTsKICAgIEFscGFjYS5yZWdpc3RlclRlbXBsYXRlKCJhcnJheUl0ZW1Ub29sYmFyIiwgJzxkaXYgY2xhc3M9InVpLXdpZGdldC1oZWFkZXIgdWktY29ybmVyLWFsbCBhbHBhY2EtZmllbGRzZXQtYXJyYXktaXRlbS10b29sYmFyIj57e2VhY2goayx2KSBidXR0b25zfX08YnV0dG9uIGNsYXNzPSJhbHBhY2EtZmllbGRzZXQtYXJyYXktaXRlbS10b29sYmFyLWljb24gYWxwYWNhLWZpZWxkc2V0LWFycmF5LWl0ZW0tdG9vbGJhci0ke3YuZmVhdHVyZX0iPiR7di5sYWJlbH08L2J1dHRvbj57ey9lYWNofX08L2Rpdj4nKTsKICAgIEFscGFjYS5yZWdpc3Rlck1lc3NhZ2VzKHsKICAgICAgICAibm90RW5vdWdoSXRlbXMiOiAiVGhlIG1pbmltdW0gbnVtYmVyIG9mIGl0ZW1zIGlzIHswfSIsCiAgICAgICAgInRvb01hbnlJdGVtcyI6ICJUaGUgbWF4aW11bSBudW1iZXIgb2YgaXRlbXMgaXMgezB9IiwKICAgICAgICAidmFsdWVOb3RVbmlxdWUiOiAiVmFsdWVzIGFyZSBub3QgdW5pcXVlIiwKICAgICAgICAibm90QW5BcnJheSI6ICJUaGlzIHZhbHVlIGlzIG5vdCBhbiBBcnJheSIKICAgIH0pOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiYXJyYXkiLCBBbHBhY2EuRmllbGRzLkFycmF5RmllbGQpOwogICAgQWxwYWNhLnJlZ2lzdGVyRGVmYXVsdFNjaGVtYUZpZWxkTWFwcGluZygiYXJyYXkiLCAiYXJyYXkiKTsKCn0pKGpRdWVyeSk7Ci8qanNoaW50IC1XMDA0ICovIC8vIGR1cGxpY2F0ZSB2YXJpYWJsZXMKLypqc2hpbnQgLVcwODMgKi8gLy8gaW5saW5lIGZ1bmN0aW9ucyBhcmUgdXNlZCBzYWZlbHkKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5PYmplY3RGaWVsZCA9IEFscGFjYS5Db250YWluZXJGaWVsZC5leHRlbmQoCiAgICAvKioKICAgICAqIEBsZW5kcyBBbHBhY2EuRmllbGRzLk9iamVjdEZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkNvbnRhaW5lckZpZWxkCiAgICAgICAgICoKICAgICAgICAgKiBAY2xhc3MgQ29udHJvbCBmb3IgSlNPTiBTY2hlbWEgb2JqZWN0IHR5cGUuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRhaW5lckZpZWxkI3NldHVwCiAgICAgICAgICovCiAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmJhc2UoKTsKCiAgICAgICAgICAgIHRoaXMud2l6YXJkUHJlSWNvbiA9ICIiOwogICAgICAgICAgICB0aGlzLndpemFyZE5leHRJY29uID0gIiI7CiAgICAgICAgICAgIHRoaXMud2l6YXJkRG9uZUljb249ICIiOwoKICAgICAgICAgICAgaWYgKHRoaXMudmlldy5zdHlsZSAmJiBBbHBhY2Euc3R5bGVJbmplY3Rpb25zW3RoaXMudmlldy5zdHlsZV0pIHsKICAgICAgICAgICAgICAgIGlmIChBbHBhY2Euc3R5bGVJbmplY3Rpb25zW3RoaXMudmlldy5zdHlsZV1bIndpemFyZFByZUljb24iXSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMud2l6YXJkUHJlSWNvbiA9IEFscGFjYS5zdHlsZUluamVjdGlvbnNbdGhpcy52aWV3LnN0eWxlXVsid2l6YXJkUHJlSWNvbiJdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKEFscGFjYS5zdHlsZUluamVjdGlvbnNbdGhpcy52aWV3LnN0eWxlXVsid2l6YXJkTmV4dEljb24iXSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMud2l6YXJkTmV4dEljb24gPSBBbHBhY2Euc3R5bGVJbmplY3Rpb25zW3RoaXMudmlldy5zdHlsZV1bIndpemFyZE5leHRJY29uIl07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLnN0eWxlSW5qZWN0aW9uc1t0aGlzLnZpZXcuc3R5bGVdWyJ3aXphcmREb25lSWNvbiJdKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy53aXphcmREb25lSWNvbiA9IEFscGFjYS5zdHlsZUluamVjdGlvbnNbdGhpcy52aWV3LnN0eWxlXVsid2l6YXJkRG9uZUljb24iXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKEFscGFjYS5pc0VtcHR5KHRoaXMuZGF0YSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuZGF0YSA9PSAiIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIUFscGFjYS5pc09iamVjdCh0aGlzLmRhdGEpKSB7CiAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc1N0cmluZyh0aGlzLmRhdGEpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRhdGEgPSBBbHBhY2EucGFyc2VKU09OKHRoaXMuZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghQWxwYWNhLmlzT2JqZWN0KHRoaXMuZGF0YSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFscGFjYS5sb2dXYXJuKCJPYmplY3RGaWVsZCBwYXJzZWQgZGF0YSBidXQgaXQgd2FzIG5vdCBhbiBvYmplY3Q6ICIgKyBKU09OLnN0cmluZ2lmeSh0aGlzLmRhdGEpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFBpY2tzIGFwYXJ0IHRoZSBkYXRhIG9iamVjdCBhbmQgc2V0IG9udG8gY2hpbGQgZmllbGRzLgogICAgICAgICAqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjc2V0VmFsdWUKICAgICAgICAgKi8KICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24oZGF0YSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGF0YSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZGF0YSA9IHt9OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpZiBub3QgYW4gb2JqZWN0IGJ5IHRoaXMgcG9pbnQsIHdlIGRvbid0IGhhbmRsZSBpdAogICAgICAgICAgICBpZiAoIUFscGFjYS5pc09iamVjdChkYXRhKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBzb3J0IGV4aXN0aW5nIGZpZWxkcyBieSBwcm9wZXJ0eSBpZAogICAgICAgICAgICB2YXIgZXhpc3RpbmdGaWVsZHNCeVByb3BlcnR5SWQgPSB7fTsKICAgICAgICAgICAgZm9yICh2YXIgZmllbGRJZCBpbiB0aGlzLmNoaWxkcmVuQnlJZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHByb3BlcnR5SWQgPSB0aGlzLmNoaWxkcmVuQnlJZFtmaWVsZElkXS5wcm9wZXJ0eUlkOwogICAgICAgICAgICAgICAgZXhpc3RpbmdGaWVsZHNCeVByb3BlcnR5SWRbcHJvcGVydHlJZF0gPSB0aGlzLmNoaWxkcmVuQnlJZFtmaWVsZElkXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gbmV3IGRhdGEgbWFwcGVkIGJ5IHByb3BlcnR5IGlkCiAgICAgICAgICAgIHZhciBuZXdEYXRhQnlQcm9wZXJ0eUlkID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGsgaW4gZGF0YSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGRhdGEuaGFzT3duUHJvcGVydHkoaykpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbmV3RGF0YUJ5UHJvcGVydHlJZFtrXSA9IGRhdGFba107CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHdhbGsgdGhyb3VnaCBuZXcgcHJvcGVydHkgaWRzCiAgICAgICAgICAgIC8vIGlmIGEgZmllbGQgZXhpc3RzLCBzZXQgdmFsdWUgb250byBpdCBhbmQgcmVtb3ZlIGZyb20gbmV3RGF0YUJ5UHJvcGVydHlJZCBhbmQgZXhpc3RpbmdGaWVsZHNCeVByb3BlcnR5SWQKICAgICAgICAgICAgLy8gaWYgYSBmaWVsZCBkb2Vzbid0IGV4aXN0LCBsZXQgaXQgcmVtYWluIGluIGxpc3QKICAgICAgICAgICAgZm9yICh2YXIgcHJvcGVydHlJZCBpbiBuZXdEYXRhQnlQcm9wZXJ0eUlkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgZmllbGQgPSBleGlzdGluZ0ZpZWxkc0J5UHJvcGVydHlJZFtwcm9wZXJ0eUlkXTsKICAgICAgICAgICAgICAgIGlmIChmaWVsZCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBmaWVsZC5zZXRWYWx1ZShuZXdEYXRhQnlQcm9wZXJ0eUlkW3Byb3BlcnR5SWRdKTsKCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGV4aXN0aW5nRmllbGRzQnlQcm9wZXJ0eUlkW3Byb3BlcnR5SWRdOwogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBuZXdEYXRhQnlQcm9wZXJ0eUlkW3Byb3BlcnR5SWRdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBhbnl0aGluZyBsZWZ0IGluIGV4aXN0aW5nRmllbGRzQnlQcm9wZXJ0eUlkIGRlc2NyaWJlcyBkYXRhIHRoYXQgaXMgbWlzc2luZywgbnVsbCBvciBlbXB0eQogICAgICAgICAgICAvLyB3ZSBudWxsIG91dCB0aG9zZSB2YWx1ZXMKICAgICAgICAgICAgZm9yICh2YXIgcHJvcGVydHlJZCBpbiBleGlzdGluZ0ZpZWxkc0J5UHJvcGVydHlJZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGZpZWxkID0gZXhpc3RpbmdGaWVsZHNCeVByb3BlcnR5SWRbcHJvcGVydHlJZF07CiAgICAgICAgICAgICAgICBmaWVsZC5zZXRWYWx1ZShudWxsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gYW55dGhpbmcgbGVmdCBpbiBuZXdEYXRhQnlQcm9wZXJ0eUlkIGlzIG5ldyBzdHVmZiB0aGF0IHdlIG5lZWQgdG8gYWRkCiAgICAgICAgICAgIC8vIHRoZSBvYmplY3QgZmllbGQgZG9lc24ndCBzdXBwb3J0IHRoaXMgc2luY2UgaXQgcnVucyBhZ2FpbnN0IGEgc2NoZW1hCiAgICAgICAgICAgIC8vIHNvIHdlIGRyb3AgdGhpcyBvZmYKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZWNvbnN0cnVjdHMgdGhlIGRhdGEgb2JqZWN0IGZyb20gdGhlIGNoaWxkIGZpZWxkcy4KICAgICAgICAgKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldFZhbHVlCiAgICAgICAgICovCiAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgLy8gaWYgd2UgZG9uJ3QgaGF2ZSBhbnkgY2hpbGRyZW4gYW5kIHdlJ3JlIG5vdCByZXF1aXJlZCwgaGFuZCBiYWNrIGVtcHR5IG9iamVjdAogICAgICAgICAgICBpZiAodGhpcy5jaGlsZHJlbi5sZW5ndGggPT09IDAgJiYgIXRoaXMuc2NoZW1hLnJlcXVpcmVkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4ge307CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIG90aGVyd2lzZSwgaGFuZCBiYWNrIGFuIG9iamVjdCB3aXRoIG91ciBjaGlsZCBwcm9wZXJ0aWVzIGluIGl0CiAgICAgICAgICAgIHZhciBvID0ge307CgogICAgICAgICAgICAvLyB3YWxrIHRocm91Z2ggYWxsIG9mIHRoZSBwcm9wZXJ0aWVzIG9iamVjdAogICAgICAgICAgICAvLyBmb3IgZWFjaCBwcm9wZXJ0eSwgd2UgaW5zZXJ0IGl0IGludG8gYSBKU09OIG9iamVjdCB0aGF0IHdlJ2xsIGhhbmQgYmFjayBhcyB0aGUgcmVzdWx0CgogICAgICAgICAgICAvLyBpZiB0aGUgcHJvcGVydHkgaGFzIGRlcGVuZGVuY2llcywgdGhlbiB3ZSBldmFsdWF0ZSB0aG9zZSBkZXBlbmRlbmNpZXMgZmlyc3QgdG8gZGV0ZXJtaW5lIHdoZXRoZXIgdGhlCiAgICAgICAgICAgIC8vIHJlc3VsdGluZyBwcm9wZXJ0eSBzaG91bGQgYmUgaW5jbHVkZWQKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewoKICAgICAgICAgICAgICAgIC8vIHRoZSBwcm9wZXJ0eSBrZXkgYW5kIHZsYXVlCiAgICAgICAgICAgICAgICB2YXIgcHJvcGVydHlJZCA9IHRoaXMuY2hpbGRyZW5baV0ucHJvcGVydHlJZDsKICAgICAgICAgICAgICAgIHZhciBmaWVsZFZhbHVlID0gdGhpcy5jaGlsZHJlbltpXS5nZXRWYWx1ZSgpOwoKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YoZmllbGRWYWx1ZSkgIT09ICJ1bmRlZmluZWQiKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRldGVybWluZUFsbERlcGVuZGVuY2llc1ZhbGlkKHByb3BlcnR5SWQpKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFzc2lnbmVkVmFsdWUgPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZihmaWVsZFZhbHVlKSA9PT0gImJvb2xlYW4iKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NpZ25lZFZhbHVlID0gKGZpZWxkVmFsdWU/IHRydWU6IGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChBbHBhY2EuaXNBcnJheShmaWVsZFZhbHVlKSB8fCBBbHBhY2EuaXNPYmplY3QoZmllbGRWYWx1ZSkpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lnbmVkVmFsdWUgPSBmaWVsZFZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGZpZWxkVmFsdWUpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lnbmVkVmFsdWUgPSBmaWVsZFZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXNzaWduZWRWYWx1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb1twcm9wZXJ0eUlkXSA9IGFzc2lnbmVkVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBvOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI3Bvc3RSZW5kZXIKICAgICAgICAgKi8KICAgICAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbihjYWxsYmFjaykgewoKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgdGhpcy5iYXNlKGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgIC8vIEdlbmVyYXRlcyB3aXphcmQgaWYgcmVxdWVzdGVkCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5pc1RvcExldmVsKCkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi52aWV3KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYud2l6YXJkQ29uZmlncyA9IHNlbGYudmlldy5nZXRXaXphcmQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYud2l6YXJkQ29uZmlncykgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNldCB1cCBkZWZhdWx0cyBmb3Igd2l6YXJkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmlzVW5kZWZpbmVkKHNlbGYud2l6YXJkQ29uZmlncy52YWxpZGF0aW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYud2l6YXJkQ29uZmlncy52YWxpZGF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2VsZi53aXphcmRDb25maWdzLmJ1dHRvbnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLndpemFyZENvbmZpZ3MuYnV0dG9ucyA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRvbmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2VsZi53aXphcmRDb25maWdzLmJ1dHRvbnMuZG9uZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYud2l6YXJkQ29uZmlncy5idXR0b25zLmRvbmUgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNVbmRlZmluZWQoc2VsZi53aXphcmRDb25maWdzLmJ1dHRvbnMuZG9uZS52YWxpZGF0ZU9uQ2xpY2spKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi53aXphcmRDb25maWdzLmJ1dHRvbnMuZG9uZS52YWxpZGF0ZU9uQ2xpY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHByZXYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2VsZi53aXphcmRDb25maWdzLmJ1dHRvbnMucHJldikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYud2l6YXJkQ29uZmlncy5idXR0b25zLnByZXYgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNVbmRlZmluZWQoc2VsZi53aXphcmRDb25maWdzLmJ1dHRvbnMucHJldi52YWxpZGF0ZU9uQ2xpY2spKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi53aXphcmRDb25maWdzLmJ1dHRvbnMucHJldi52YWxpZGF0ZU9uQ2xpY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5leHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2VsZi53aXphcmRDb25maWdzLmJ1dHRvbnMubmV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYud2l6YXJkQ29uZmlncy5idXR0b25zLm5leHQgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNVbmRlZmluZWQoc2VsZi53aXphcmRDb25maWdzLmJ1dHRvbnMubmV4dC52YWxpZGF0ZU9uQ2xpY2spKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi53aXphcmRDb25maWdzLmJ1dHRvbnMubmV4dC52YWxpZGF0ZU9uQ2xpY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsYXlvdXRUZW1wbGF0ZURlc2NyaXB0b3IgPSBzZWxmLnZpZXcuZ2V0TGF5b3V0KCkudGVtcGxhdGVEZXNjcmlwdG9yOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi53aXphcmRDb25maWdzICYmIHNlbGYud2l6YXJkQ29uZmlncy5yZW5kZXJXaXphcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXlvdXRUZW1wbGF0ZURlc2NyaXB0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL1dpemFyZCBiYXNlZCBvbiBsYXlvdXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLndpemFyZCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL1dpemFyZCBiYXNlZCBvbiBpbmplY3Rpb25zCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hdXRvV2l6YXJkKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udGFpbmVyRmllbGQjaGFuZGxlVmFsaWRhdGUKICAgICAgICAgKi8KICAgICAgICBoYW5kbGVWYWxpZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBiYXNlU3RhdHVzID0gdGhpcy5iYXNlKCk7CgogICAgICAgICAgICB2YXIgdmFsSW5mbyA9IHRoaXMudmFsaWRhdGlvbjsKCiAgICAgICAgICAgIHZhciBzdGF0dXMgPSB0aGlzLl92YWxpZGF0ZU1heFByb3BlcnRpZXMoKTsKICAgICAgICAgICAgdmFsSW5mb1sidG9vTWFueVByb3BlcnRpZXMiXSA9IHsKICAgICAgICAgICAgICAgICJtZXNzYWdlIjogc3RhdHVzID8gIiIgOiBBbHBhY2Euc3Vic3RpdHV0ZVRva2Vucyh0aGlzLnZpZXcuZ2V0TWVzc2FnZSgidG9vTWFueVByb3BlcnRpZXMiKSwgW3RoaXMuc2NoZW1hLm1heFByb3BlcnRpZXNdKSwKICAgICAgICAgICAgICAgICJzdGF0dXMiOiBzdGF0dXMKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHN0YXR1cyA9IHRoaXMuX3ZhbGlkYXRlTWluUHJvcGVydGllcygpOwogICAgICAgICAgICB2YWxJbmZvWyJ0b29GZXdQcm9wZXJ0aWVzIl0gPSB7CiAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHN0YXR1cyA/ICIiIDogQWxwYWNhLnN1YnN0aXR1dGVUb2tlbnModGhpcy52aWV3LmdldE1lc3NhZ2UoInRvb01hbnlJdGVtcyIpLCBbdGhpcy5zY2hlbWEuaXRlbXMubWluUHJvcGVydGllc10pLAogICAgICAgICAgICAgICAgInN0YXR1cyI6IHN0YXR1cwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgcmV0dXJuIGJhc2VTdGF0dXMgJiYgdmFsSW5mb1sidG9vTWFueVByb3BlcnRpZXMiXVsic3RhdHVzIl0gJiYgdmFsSW5mb1sidG9vRmV3UHJvcGVydGllcyJdWyJzdGF0dXMiXTsKICAgICAgICB9LC8vX19CVUlMREVSX0hFTFBFUlMKCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaWRhdGUgbWF4UHJvcGVydGllcyBzY2hlbWEgcHJvcGVydHkuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gd2hldGhlciBtYXhQcm9wZXJ0aWVzIGlzIHNhdGlzZmllZAogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZU1heFByb3BlcnRpZXM6IGZ1bmN0aW9uKCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YodGhpcy5zY2hlbWFbIm1heFByb3BlcnRpZXMiXSkgPT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgbWF4UHJvcGVydGllcyA9IHRoaXMuc2NoZW1hWyJtYXhQcm9wZXJ0aWVzIl07CgogICAgICAgICAgICAvLyBjb3VudCB0aGUgbnVtYmVyIG9mIHByb3BlcnRpZXMgdGhhdCB3ZSBjdXJyZW50bHkgaGF2ZQogICAgICAgICAgICB2YXIgcHJvcGVydHlDb3VudCA9IDA7CiAgICAgICAgICAgIGZvciAodmFyIGsgaW4gdGhpcy5kYXRhKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBwcm9wZXJ0eUNvdW50Kys7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBwcm9wZXJ0eUNvdW50IDw9IG1heFByb3BlcnRpZXM7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaWRhdGUgbWF4UHJvcGVydGllcyBzY2hlbWEgcHJvcGVydHkuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gd2hldGhlciBtYXhQcm9wZXJ0aWVzIGlzIHNhdGlzZmllZAogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZU1pblByb3BlcnRpZXM6IGZ1bmN0aW9uKCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YodGhpcy5zY2hlbWFbIm1pblByb3BlcnRpZXMiXSkgPT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgbWluUHJvcGVydGllcyA9IHRoaXMuc2NoZW1hWyJtaW5Qcm9wZXJ0aWVzIl07CgogICAgICAgICAgICAvLyBjb3VudCB0aGUgbnVtYmVyIG9mIHByb3BlcnRpZXMgdGhhdCB3ZSBjdXJyZW50bHkgaGF2ZQogICAgICAgICAgICB2YXIgcHJvcGVydHlDb3VudCA9IDA7CiAgICAgICAgICAgIGZvciAodmFyIGsgaW4gdGhpcy5kYXRhKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBwcm9wZXJ0eUNvdW50Kys7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBwcm9wZXJ0eUNvdW50ID49IG1pblByb3BlcnRpZXM7CiAgICAgICAgfSwKCiAgICAgICAgLy9fX0JVSUxERVJfSEVMUEVSUwoKCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyBjaGlsZCBpbmRleC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwcm9wZXJ0eUlkIENoaWxkIGZpZWxkIHByb3BlcnR5IElELgogICAgICAgICAqLwogICAgICAgIGdldEluZGV4OiBmdW5jdGlvbihwcm9wZXJ0eUlkKSB7CiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNFbXB0eShwcm9wZXJ0eUlkKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHBpZCA9IHRoaXMuY2hpbGRyZW5baV0ucHJvcGVydHlJZDsKICAgICAgICAgICAgICAgIGlmIChwaWQgPT0gcHJvcGVydHlJZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBEZXRlcm1pbmVzIHRoZSBzY2hlbWEgYW5kIG9wdGlvbnMgdG8gdXRpbGl6ZSBmb3Igc3ViLW9iamVjdHMgd2l0aGluIHRoaXMgb2JqZWN0LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHByb3BlcnR5SWQKICAgICAgICAgKiBAcGFyYW0gY2FsbGJhY2sKICAgICAgICAgKi8KICAgICAgICByZXNvbHZlUHJvcGVydHlTY2hlbWFPcHRpb25zOiBmdW5jdGlvbihwcm9wZXJ0eUlkLCBjYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICB2YXIgcHJvcGVydHlTY2hlbWEgPSBudWxsOwogICAgICAgICAgICBpZiAoX3RoaXMuc2NoZW1hICYmIF90aGlzLnNjaGVtYS5wcm9wZXJ0aWVzICYmIF90aGlzLnNjaGVtYS5wcm9wZXJ0aWVzW3Byb3BlcnR5SWRdKSB7CiAgICAgICAgICAgICAgICBwcm9wZXJ0eVNjaGVtYSA9IF90aGlzLnNjaGVtYS5wcm9wZXJ0aWVzW3Byb3BlcnR5SWRdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcm9wZXJ0eU9wdGlvbnMgPSB7fTsKICAgICAgICAgICAgaWYgKF90aGlzLm9wdGlvbnMgJiYgX3RoaXMub3B0aW9ucy5maWVsZHMgJiYgX3RoaXMub3B0aW9ucy5maWVsZHNbcHJvcGVydHlJZF0pIHsKICAgICAgICAgICAgICAgIHByb3BlcnR5T3B0aW9ucyA9IF90aGlzLm9wdGlvbnMuZmllbGRzW3Byb3BlcnR5SWRdOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBoYW5kbGUgJHJlZgogICAgICAgICAgICBpZiAocHJvcGVydHlTY2hlbWEgJiYgcHJvcGVydHlTY2hlbWFbIiRyZWYiXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHJlZmVyZW5jZUlkID0gcHJvcGVydHlTY2hlbWFbIiRyZWYiXTsKCiAgICAgICAgICAgICAgICB2YXIgdG9wRmllbGQgPSB0aGlzOwogICAgICAgICAgICAgICAgdmFyIGZpZWxkQ2hhaW4gPSBbdG9wRmllbGRdOwogICAgICAgICAgICAgICAgd2hpbGUgKHRvcEZpZWxkLnBhcmVudCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0b3BGaWVsZCA9IHRvcEZpZWxkLnBhcmVudDsKICAgICAgICAgICAgICAgICAgICBmaWVsZENoYWluLnB1c2godG9wRmllbGQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbFByb3BlcnR5U2NoZW1hID0gcHJvcGVydHlTY2hlbWE7CiAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxQcm9wZXJ0eU9wdGlvbnMgPSBwcm9wZXJ0eU9wdGlvbnM7CgogICAgICAgICAgICAgICAgQWxwYWNhLmxvYWRSZWZTY2hlbWFPcHRpb25zKHRvcEZpZWxkLCByZWZlcmVuY2VJZCwgZnVuY3Rpb24ocHJvcGVydHlTY2hlbWEsIHByb3BlcnR5T3B0aW9ucykgewoKICAgICAgICAgICAgICAgICAgICAvLyB3YWxrIHRoZSBmaWVsZCBjaGFpbiB0byBzZWUgaWYgd2UgaGF2ZSBhbnkgY2lyY3VsYXJpdHkKICAgICAgICAgICAgICAgICAgICB2YXIgcmVmQ291bnQgPSAwOwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZmllbGRDaGFpbi5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaWVsZENoYWluW2ldLnNjaGVtYSAmJiBmaWVsZENoYWluW2ldLnNjaGVtYS5pZCA9PT0gcmVmZXJlbmNlSWQpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZkNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHZhciBjaXJjdWxhciA9IChyZWZDb3VudCA+IDEpOwoKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWRQcm9wZXJ0eVNjaGVtYSA9IHt9OwogICAgICAgICAgICAgICAgICAgIGlmIChvcmlnaW5hbFByb3BlcnR5U2NoZW1hKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEFscGFjYS5tZXJnZU9iamVjdChyZXNvbHZlZFByb3BlcnR5U2NoZW1hLCBvcmlnaW5hbFByb3BlcnR5U2NoZW1hKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5U2NoZW1hKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgQWxwYWNhLm1lcmdlT2JqZWN0KHJlc29sdmVkUHJvcGVydHlTY2hlbWEsIHByb3BlcnR5U2NoZW1hKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8ga2VlcCBvcmlnaW5hbCBpZAogICAgICAgICAgICAgICAgICAgIGlmIChvcmlnaW5hbFByb3BlcnR5U2NoZW1hICYmIG9yaWdpbmFsUHJvcGVydHlTY2hlbWEuaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRQcm9wZXJ0eVNjaGVtYS5pZCA9IG9yaWdpbmFsUHJvcGVydHlTY2hlbWEuaWQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vZGVsZXRlIHJlc29sdmVkUHJvcGVydHlTY2hlbWEuaWQ7CgogICAgICAgICAgICAgICAgICAgIHZhciByZXNvbHZlZFByb3BlcnR5T3B0aW9ucyA9IHt9OwogICAgICAgICAgICAgICAgICAgIGlmIChvcmlnaW5hbFByb3BlcnR5T3B0aW9ucykgewogICAgICAgICAgICAgICAgICAgICAgICBBbHBhY2EubWVyZ2VPYmplY3QocmVzb2x2ZWRQcm9wZXJ0eU9wdGlvbnMsIG9yaWdpbmFsUHJvcGVydHlPcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5T3B0aW9ucykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIEFscGFjYS5tZXJnZU9iamVjdChyZXNvbHZlZFByb3BlcnR5T3B0aW9ucywgcHJvcGVydHlPcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIEFscGFjYS5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2socmVzb2x2ZWRQcm9wZXJ0eVNjaGVtYSwgcmVzb2x2ZWRQcm9wZXJ0eU9wdGlvbnMsIGNpcmN1bGFyKTsKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgLy9jYWxsYmFjayhyZXNvbHZlZFByb3BlcnR5U2NoZW1hLCByZXNvbHZlZFByb3BlcnR5T3B0aW9ucywgY2lyY3VsYXIpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBBbHBhY2EubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2socHJvcGVydHlTY2hlbWEsIHByb3BlcnR5T3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAvL2NhbGxiYWNrKHByb3BlcnR5U2NoZW1hLCBwcm9wZXJ0eU9wdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVtb3ZlcyBjaGlsZAogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGlkIHRoZSBhbHBhY2EgZmllbGQgaWQgb2YgdGhlIGZpZWxkIHRvIGJlIHJlbW92ZWQKICAgICAgICAgKi8KICAgICAgICByZW1vdmVJdGVtOiBmdW5jdGlvbihpZCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY2hpbGRyZW4gPSAkLmdyZXAodGhpcy5jaGlsZHJlbiwgZnVuY3Rpb24odmFsLCBpbmRleCkgewogICAgICAgICAgICAgICAgcmV0dXJuICh2YWwuZ2V0SWQoKSAhPSBpZCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdmFyIGNoaWxkRmllbGQgPSB0aGlzLmNoaWxkcmVuQnlJZFtpZF07CgogICAgICAgICAgICBkZWxldGUgdGhpcy5jaGlsZHJlbkJ5SWRbaWRdOwogICAgICAgICAgICBpZiAoY2hpbGRGaWVsZC5wcm9wZXJ0eUlkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5jaGlsZHJlbkJ5UHJvcGVydHlJZFtjaGlsZEZpZWxkLnByb3BlcnR5SWRdOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjaGlsZEZpZWxkLmRlc3Ryb3koKTsKCiAgICAgICAgICAgIHRoaXMucmVmcmVzaFZhbGlkYXRpb25TdGF0ZSgpOwoKICAgICAgICAgICAgLy8gdHJpZ2dlciB1cGRhdGUgaGFuZGxlcgogICAgICAgICAgICB0aGlzLnRyaWdnZXJVcGRhdGUoKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBBZGRzIGEgY2hpbGQgaXRlbS4gIFJldHVybnMgdGhlIGNvbnRhaW5lciBlbGVtZW50IHJpZ2h0IGF3YXkuICBUaGUgcG9zdFJlbmRlckNhbGxiYWNrIG1ldGhvZCBpcyBjYWxsZWQKICAgICAgICAgKiB1cG9uIGNvbXBsZXRpb24uCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHlJZCBDaGlsZCBmaWVsZCBwcm9wZXJ0eSBJRC4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gaXRlbVNjaGVtYSBzY2hlbWEKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZmllbGRPcHRpb25zIENoaWxkIGZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IHZhbHVlIENoaWxkIGZpZWxkIHZhbHVlCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGluc2VydEFmdGVySWQgTG9jYXRpb24gd2hlcmUgdGhlIGNoaWxkIGl0ZW0gd2lsbCBiZSBpbnNlcnRlZC4KICAgICAgICAgKiBAcGFyYW0gW0Jvb2xlYW5dIGlzRHluYW1pY1N1Ykl0ZW0gd2hldGhlciB0aGlzIGl0ZW0gaXMgYmVpbmcgZHluYW1pY2FsbHkgY3JlYXRlZCAoYWZ0ZXIgZmlyc3QgcmVuZGVyKQogICAgICAgICAqIEBwYXJhbSBbRnVuY3Rpb259IHBvc3RSZW5kZXJDYWxsYmFjayBjYWxsZWQgb25jZSB0aGUgaXRlbSBoYXMgYmVlbiBhZGRlZAogICAgICAgICAqLwogICAgICAgIGFkZEl0ZW06IGZ1bmN0aW9uKHByb3BlcnR5SWQsIGl0ZW1TY2hlbWEsIGl0ZW1PcHRpb25zLCBpdGVtRGF0YSwgaW5zZXJ0QWZ0ZXJJZCwgaXNEeW5hbWljU3ViSXRlbSwgcG9zdFJlbmRlckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICB2YXIgY29udGFpbmVyRWxlbSA9IF90aGlzLnJlbmRlckl0ZW1Db250YWluZXIoaW5zZXJ0QWZ0ZXJJZCwgdGhpcywgcHJvcGVydHlJZCk7CiAgICAgICAgICAgIGNvbnRhaW5lckVsZW0uYWxwYWNhKHsKICAgICAgICAgICAgICAgICJkYXRhIiA6IGl0ZW1EYXRhLAogICAgICAgICAgICAgICAgIm9wdGlvbnMiOiBpdGVtT3B0aW9ucywKICAgICAgICAgICAgICAgICJzY2hlbWEiIDogaXRlbVNjaGVtYSwKICAgICAgICAgICAgICAgICJ2aWV3IiA6IHRoaXMudmlldy5pZCA/IHRoaXMudmlldy5pZCA6IHRoaXMudmlldywKICAgICAgICAgICAgICAgICJjb25uZWN0b3IiOiB0aGlzLmNvbm5lY3RvciwKICAgICAgICAgICAgICAgICJlcnJvciI6IGZ1bmN0aW9uKGVycikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5kZXN0cm95KCk7CgogICAgICAgICAgICAgICAgICAgIF90aGlzLmVycm9yQ2FsbGJhY2suY2FsbChfdGhpcywgZXJyKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAibm90VG9wTGV2ZWwiOnRydWUsCiAgICAgICAgICAgICAgICAiaXNEeW5hbWljQ3JlYXRpb24iOiAoaXNEeW5hbWljU3ViSXRlbSB8fCB0aGlzLmlzRHluYW1pY0NyZWF0aW9uKSwKICAgICAgICAgICAgICAgICJyZW5kZXIiIDogZnVuY3Rpb24oZmllbGRDb250cm9sLCBjYikgewogICAgICAgICAgICAgICAgICAgIC8vIHJlbmRlcgogICAgICAgICAgICAgICAgICAgIGZpZWxkQ29udHJvbC5wYXJlbnQgPSBfdGhpczsKICAgICAgICAgICAgICAgICAgICAvLyBhZGQgdGhlIHByb3BlcnR5IElkCiAgICAgICAgICAgICAgICAgICAgZmllbGRDb250cm9sLnByb3BlcnR5SWQgPSBwcm9wZXJ0eUlkOwogICAgICAgICAgICAgICAgICAgIC8vIHNldHVwIGl0ZW0gcGF0aAogICAgICAgICAgICAgICAgICAgIGlmIChfdGhpcy5wYXRoICE9ICIvIikgewogICAgICAgICAgICAgICAgICAgICAgICBmaWVsZENvbnRyb2wucGF0aCA9IF90aGlzLnBhdGggKyAiLyIgKyBwcm9wZXJ0eUlkOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkQ29udHJvbC5wYXRoID0gX3RoaXMucGF0aCArIHByb3BlcnR5SWQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZpZWxkQ29udHJvbC5yZW5kZXIobnVsbCwgZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXJFbGVtLmF0dHIoImlkIiwgZmllbGRDb250cm9sLmdldElkKCkgKyAiLWl0ZW0tY29udGFpbmVyIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lckVsZW0uYXR0cigiYWxwYWNhLWlkIiwgZmllbGRDb250cm9sLmdldElkKCkpOwogICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXJFbGVtLmFkZENsYXNzKCJhbHBhY2EtZmllbGRzZXQtaXRlbS1jb250YWluZXIiKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVtZW1iZXIgdGhlIGNvbnRyb2wKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFscGFjYS5pc0VtcHR5KGluc2VydEFmdGVySWQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5hZGRDaGlsZChmaWVsZENvbnRyb2wpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gX3RoaXMuZ2V0SW5kZXgoaW5zZXJ0QWZ0ZXJJZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggIT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5hZGRDaGlsZChmaWVsZENvbnRyb2wsIGluZGV4ICsgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmFkZENoaWxkKGZpZWxkQ29udHJvbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc2VydEFmdGVySWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnJlZnJlc2hWYWxpZGF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgbm90IGVtcHR5LCBtYXJrIHRoZSAibGFzdCIgYW5kICJmaXJzdCIgZG9tIGVsZW1lbnRzIGluIHRoZSBsaXN0CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkKGNvbnRhaW5lckVsZW0pLnNpYmxpbmdzKCkuYWRkQmFjaygpLmxlbmd0aCA+IDApCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoY29udGFpbmVyRWxlbSkucGFyZW50KCkucmVtb3ZlQ2xhc3MoImFscGFjYS1maWVsZHNldC1pdGVtcy1jb250YWluZXItZW1wdHkiKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGNvbnRhaW5lckVsZW0pLnNpYmxpbmdzKCkuYWRkQmFjaygpLnJlbW92ZUNsYXNzKCJhbHBhY2EtaXRlbS1jb250YWluZXItZmlyc3QiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoY29udGFpbmVyRWxlbSkuc2libGluZ3MoKS5hZGRCYWNrKCkucmVtb3ZlQ2xhc3MoImFscGFjYS1pdGVtLWNvbnRhaW5lci1sYXN0Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGNvbnRhaW5lckVsZW0pLnNpYmxpbmdzKCkuYWRkQmFjaygpLmZpcnN0KCkuYWRkQ2xhc3MoImFscGFjYS1pdGVtLWNvbnRhaW5lci1maXJzdCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJChjb250YWluZXJFbGVtKS5zaWJsaW5ncygpLmFkZEJhY2soKS5sYXN0KCkuYWRkQ2xhc3MoImFscGFjYS1pdGVtLWNvbnRhaW5lci1sYXN0Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN0b3JlIGtleSBvbiBkb20gZWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICAkKGNvbnRhaW5lckVsZW0pLmF0dHIoImRhdGEtYWxwYWNhLWl0ZW0tY29udGFpbmVyLWl0ZW0ta2V5IiwgcHJvcGVydHlJZCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyB0cmlnZ2VyIHVwZGF0ZSBvbiB0aGUgcGFyZW50IGFycmF5CiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnRyaWdnZXJVcGRhdGUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYikKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2IoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAicG9zdFJlbmRlciI6IGZ1bmN0aW9uKGNvbnRyb2wpIHsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHBvc3RSZW5kZXJDYWxsYmFjaykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvc3RSZW5kZXJDYWxsYmFjayhjb250cm9sKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lckVsZW07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udGFpbmVyRmllbGQjcmVuZGVySXRlbXMKICAgICAgICAgKi8KICAgICAgICByZW5kZXJJdGVtczogZnVuY3Rpb24ob25TdWNjZXNzKSB7CgogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgLy8gd2Uga2VlcCBhIG1hcCBvZiBhbGwgb2YgdGhlIHByb3BlcnRpZXMgaW4gb3VyIG9yaWdpbmFsIGRhdGEgb2JqZWN0CiAgICAgICAgICAgIC8vIGFzIHdlIHJlbmRlciBlbGVtZW50cyBvdXQgb2YgdGhlIHNjaGVtYSwgd2UgcmVtb3ZlIGZyb20gdGhlIGRhdGFQcm9wZXJ0aWVzIG1hcAogICAgICAgICAgICAvLyB3aGF0ZXZlciBpcyBsZWZ0b3ZlciBhcmUgdGhlIGRhdGEgcHJvcGVydGllcyB0aGF0IHdlcmUgTk9UIHJlbmRlcmVkIGJlY2F1c2UgdGhleSB3ZXJlIG5vdCBwYXJ0CiAgICAgICAgICAgIC8vIG9mIHRoZSBzY2hlbWEKICAgICAgICAgICAgLy8gd2UgdXNlIHRoaXMgZm9yIGRlYnVnZ2luZwogICAgICAgICAgICB2YXIgZXh0cmFEYXRhUHJvcGVydGllcyA9IHt9OwogICAgICAgICAgICBmb3IgKHZhciBkYXRhS2V5IGluIF90aGlzLmRhdGEpIHsKICAgICAgICAgICAgICAgIGV4dHJhRGF0YVByb3BlcnRpZXNbZGF0YUtleV0gPSBkYXRhS2V5OwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgcHJvcGVydGllcyA9IF90aGlzLmRhdGE7CiAgICAgICAgICAgIGlmIChfdGhpcy5zY2hlbWEgJiYgX3RoaXMuc2NoZW1hLnByb3BlcnRpZXMpIHsKICAgICAgICAgICAgICAgIHByb3BlcnRpZXMgPSBfdGhpcy5zY2hlbWEucHJvcGVydGllczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGNmID0gZnVuY3Rpb24oKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgc2NoZW1hIGFuZCB0aGUgZGF0YSBsaW5lIHVwIHBlcmZlY3RseSwgdGhlbiB0aGVyZSB3aWxsIGJlIG5vIHByb3BlcnRpZXMgaW4gdGhlIGRhdGEgdGhhdCBhcmUKICAgICAgICAgICAgICAgIC8vIG5vdCBhbHNvIGluIHRoZSBzY2hlbWEsIGFuZCB0aHVzLCBleHRyYURhdGFQcm9wZXJ0aWVzIHdpbGwgYmUgZW1wdHkuCiAgICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgICAgLy8gT24gdGhlIG90aGVyIGhhbmQsIGlmIHRoZXJlIGFyZSBzb21lIHByb3BlcnRpZXMgaW4gZGF0YSB0aGF0IHdlcmUgbm90IGluIHNjaGVtYSwgdGhlbiB0aGV5IHdpbGwKICAgICAgICAgICAgICAgIC8vIHJlbWFpbiBpbiBleHRyYURhdGFQcm9wZXJ0aWVzIGFuZCB3ZSBjYW4gaW5mb3JtIGRldmVsb3BlcnMgZm9yIGRlYnVnZ2luZyBwdXJwb3NlcwogICAgICAgICAgICAgICAgLy8KICAgICAgICAgICAgICAgIHZhciBleHRyYURhdGFLZXlzID0gW107CiAgICAgICAgICAgICAgICBmb3IgKHZhciBleHRyYURhdGFLZXkgaW4gZXh0cmFEYXRhUHJvcGVydGllcykgewogICAgICAgICAgICAgICAgICAgIGV4dHJhRGF0YUtleXMucHVzaChleHRyYURhdGFLZXkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGV4dHJhRGF0YUtleXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIEFscGFjYS5sb2dEZWJ1ZygiVGhlcmUgd2VyZSAiICsgZXh0cmFEYXRhS2V5cy5sZW5ndGggKyAiIGV4dHJhIGRhdGEga2V5cyB0aGF0IHdlcmUgbm90IHBhcnQgb2YgdGhlIHNjaGVtYSAiICsgSlNPTi5zdHJpbmdpZnkoZXh0cmFEYXRhS2V5cykpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vX3RoaXMucmVmcmVzaFZhbGlkYXRpb25TdGF0ZSgpOwoKICAgICAgICAgICAgICAgIGlmIChvblN1Y2Nlc3MpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgb25TdWNjZXNzKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBlYWNoIHByb3BlcnR5IGluIHRoZSBvYmplY3QgY2FuIGhhdmUgYSBkaWZmZXJlbnQgc2NoZW1hIGFuZCBvcHRpb25zIHNvIHdlIG5lZWQgdG8gcHJvY2VzcwogICAgICAgICAgICAvLyBhc3luY2hyb25vdXNseSBhbmQgd2FpdCBmb3IgYWxsIHRvIGNvbXBsZXRlCgogICAgICAgICAgICAvLyB3cmFwIGludG8gd2F0ZXJmYWxsIGZ1bmN0aW9ucwogICAgICAgICAgICB2YXIgcHJvcGVydHlGdW5jdGlvbnMgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgcHJvcGVydHlJZCBpbiBwcm9wZXJ0aWVzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgaXRlbURhdGEgPSBudWxsOwogICAgICAgICAgICAgICAgaWYgKF90aGlzLmRhdGEpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaXRlbURhdGEgPSBfdGhpcy5kYXRhW3Byb3BlcnR5SWRdOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBwZiA9IChmdW5jdGlvbihwcm9wZXJ0eUlkLCBpdGVtRGF0YSwgZXh0cmFEYXRhUHJvcGVydGllcykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oY2FsbGJhY2spCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBvbmx5IGFsbG93IHRoaXMgaWYgd2UgaGF2ZSBkYXRhLCBvdGhlcndpc2Ugd2UgZW5kIHVwIHdpdGggY2lyY3VsYXIgcmVmZXJlbmNlCiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnJlc29sdmVQcm9wZXJ0eVNjaGVtYU9wdGlvbnMocHJvcGVydHlJZCwgZnVuY3Rpb24oc2NoZW1hLCBvcHRpb25zLCBjaXJjdWxhcikgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIG9ubHkgYWxsb3cgYWRkaXRpb24gaWYgdGhlIHJlc29sdmVkIHNjaGVtYSBpc24ndCBjaXJjdWxhcmx5IHJlZmVyZW5jZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG9yIHRoZSBzY2hlbWEgaXMgb3B0aW9uYWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaXJjdWxhcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gQWxwYWNhLnRocm93RXJyb3JXaXRoQ2FsbGJhY2soIkNpcmN1bGFyIHJlZmVyZW5jZSBkZXRlY3RlZCBmb3Igc2NoZW1hOiAiICsgc2NoZW1hLCBfdGhpcy5lcnJvckNhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXNjaGVtYSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBbHBhY2EubG9nRXJyb3IoIlVuYWJsZSB0byByZXNvbHZlIHNjaGVtYSBmb3IgcHJvcGVydHk6ICIgKyBwcm9wZXJ0eUlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5hZGRJdGVtKHByb3BlcnR5SWQsIHNjaGVtYSwgb3B0aW9ucywgaXRlbURhdGEsIG51bGwsIGZhbHNlLCBmdW5jdGlvbihhZGRlZEl0ZW1Db250cm9sKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBmcm9tIGV4dHJhRGF0YVByb3BlcnRpZXMgaGVscGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGV4dHJhRGF0YVByb3BlcnRpZXNbcHJvcGVydHlJZF07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhBTkRMRSBQUk9QRVJUWSBERVBFTkRFTkNJRVMgKElGIFRIRSBQUk9QRVJUWSBIQVMgVEhFTSkKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhpcyBwcm9wZXJ0eSBoYXMgZGVwZW5kZW5jaWVzLCBzaG93IG9yIGhpZGUgdGhpcyBhZGRlZCBpdGVtIHJpZ2h0IGF3YXkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5zaG93T3JIaWRlUHJvcGVydHlCYXNlZE9uRGVwZW5kZW5jaWVzKHByb3BlcnR5SWQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGlzIHByb3BlcnR5IGhhcyBkZXBlbmRlbmNpZXMsIGJpbmQgdXBkYXRlIGhhbmRsZXJzIHRvIGRlcGVuZGVudCBmaWVsZHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5iaW5kRGVwZW5kZW5jeUZpZWxkVXBkYXRlRXZlbnQocHJvcGVydHlJZCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoaXMgcHJvcGVydHkgaGFzIGRlcGVuZGVuY2llcywgdHJpZ2dlciB0aG9zZSB0byBlbnN1cmUgaXQgaXMgaW4gdGhlIHJpZ2h0IHN0YXRlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMucmVmcmVzaERlcGVuZGVudEZpZWxkU3RhdGVzKHByb3BlcnR5SWQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBieSB0aGUgdGltZSB3ZSBnZXQgaGVyZSwgd2UgbWF5IGhhdmUgY29uc3RydWN0ZWQgYSB2ZXJ5IGxhcmdlIGNoaWxkIGNoYWluIG9mCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3ViLWRlcGVuZGVuY2llcyBhbmQgc28gd2UgdXNlIG5leHRUaWNrKCkgaW5zdGVhZCBvZiBhIHN0cmFpZ2h0IGNhbGxiYWNrIHNvIGFzIHRvCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYXZvaWQgYmxvd2luZyBvdXQgdGhlIHN0YWNrIHNpemUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBbHBhY2EubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICB9KShwcm9wZXJ0eUlkLCBpdGVtRGF0YSwgZXh0cmFEYXRhUHJvcGVydGllcyk7CgogICAgICAgICAgICAgICAgcHJvcGVydHlGdW5jdGlvbnMucHVzaChwZik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIEFscGFjYS5zZXJpZXMocHJvcGVydHlGdW5jdGlvbnMsIGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgICAgY2YoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAvLwogICAgICAgIC8vIERFUEVOREVOQ0lFUwogICAgICAgIC8vCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICAvKioKICAgICAgICAgKiBTaG93cyBvciBoaWRlcyBhIHByb3BlcnR5J3MgZmllbGQgYmFzZWQgb24gaG93IGl0cyBkZXBlbmRlbmNpZXMgZXZhbHVhdGUuCiAgICAgICAgICogSWYgYSBwcm9wZXJ0eSBkb2Vzbid0IGhhdmUgZGVwZW5kZW5jaWVzLCB0aGlzIG5vLW9wcy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBwcm9wZXJ0eUlkCiAgICAgICAgICovCiAgICAgICAgc2hvd09ySGlkZVByb3BlcnR5QmFzZWRPbkRlcGVuZGVuY2llczogZnVuY3Rpb24ocHJvcGVydHlJZCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHZhciBpdGVtID0gdGhpcy5jaGlsZHJlbkJ5UHJvcGVydHlJZFtwcm9wZXJ0eUlkXTsKICAgICAgICAgICAgaWYgKCFpdGVtKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gQWxwYWNhLnRocm93RXJyb3JXaXRoQ2FsbGJhY2soIk1pc3NpbmcgcHJvcGVydHk6ICIgKyBwcm9wZXJ0eUlkLCBzZWxmLmVycm9yQ2FsbGJhY2spOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgdmFsaWQgPSB0aGlzLmRldGVybWluZUFsbERlcGVuZGVuY2llc1ZhbGlkKHByb3BlcnR5SWQpOwogICAgICAgICAgICBpZiAodmFsaWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGl0ZW0uc2hvdygpOwogICAgICAgICAgICAgICAgaXRlbS5vbkRlcGVuZGVudFJldmVhbCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaXRlbS5oaWRlKCk7CiAgICAgICAgICAgICAgICBpdGVtLm9uRGVwZW5kZW50Q29uY2VhbCgpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSBkZXBlbmRlbmNpZXMgZm9yIGEgcHJvcGVydHkgcGFzcy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBwcm9wZXJ0eUlkCiAgICAgICAgICovCiAgICAgICAgZGV0ZXJtaW5lQWxsRGVwZW5kZW5jaWVzVmFsaWQ6IGZ1bmN0aW9uKHByb3BlcnR5SWQpCiAgICAgICAgewogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB2YXIgaXRlbSA9IHRoaXMuY2hpbGRyZW5CeVByb3BlcnR5SWRbcHJvcGVydHlJZF07CiAgICAgICAgICAgIGlmICghaXRlbSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIEFscGFjYS50aHJvd0Vycm9yV2l0aENhbGxiYWNrKCJNaXNzaW5nIHByb3BlcnR5OiAiICsgcHJvcGVydHlJZCwgc2VsZi5lcnJvckNhbGxiYWNrKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGl0ZW1EZXBlbmRlbmNpZXMgPSBpdGVtLnNjaGVtYS5kZXBlbmRlbmNpZXM7CiAgICAgICAgICAgIGlmICghaXRlbURlcGVuZGVuY2llcykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gbm8gZGVwZW5kZW5jaWVzLCBzbyB5ZXMsIHdlIHBhc3MKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgdmFsaWQgPSB0cnVlOwogICAgICAgICAgICBpZiAoQWxwYWNhLmlzU3RyaW5nKGl0ZW1EZXBlbmRlbmNpZXMpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YWxpZCA9IHNlbGYuZGV0ZXJtaW5lU2luZ2xlRGVwZW5kZW5jeVZhbGlkKHByb3BlcnR5SWQsIGl0ZW1EZXBlbmRlbmNpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKEFscGFjYS5pc0FycmF5KGl0ZW1EZXBlbmRlbmNpZXMpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAkLmVhY2goaXRlbURlcGVuZGVuY2llcywgZnVuY3Rpb24oaW5kZXgsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsaWQgPSB2YWxpZCAmJiBzZWxmLmRldGVybWluZVNpbmdsZURlcGVuZGVuY3lWYWxpZChwcm9wZXJ0eUlkLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZhbGlkOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEJpbmRzIGZpZWxkIHVwZGF0ZXMgdG8gYW55IGZpZWxkIGRlcGVuZGVuY2llcy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBwcm9wZXJ0eUlkCiAgICAgICAgICovCiAgICAgICAgYmluZERlcGVuZGVuY3lGaWVsZFVwZGF0ZUV2ZW50OiBmdW5jdGlvbihwcm9wZXJ0eUlkKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgdmFyIGl0ZW0gPSB0aGlzLmNoaWxkcmVuQnlQcm9wZXJ0eUlkW3Byb3BlcnR5SWRdOwogICAgICAgICAgICBpZiAoIWl0ZW0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBBbHBhY2EudGhyb3dFcnJvcldpdGhDYWxsYmFjaygiTWlzc2luZyBwcm9wZXJ0eTogIiArIHByb3BlcnR5SWQsIHNlbGYuZXJyb3JDYWxsYmFjayk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBpdGVtRGVwZW5kZW5jaWVzID0gaXRlbS5zY2hlbWEuZGVwZW5kZW5jaWVzOwogICAgICAgICAgICBpZiAoIWl0ZW1EZXBlbmRlbmNpZXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIG5vIGRlcGVuZGVuY2llcywgc28gc2ltcGxlIHJldHVybgogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGhlbHBlciBmdW5jdGlvbgogICAgICAgICAgICB2YXIgYmluZEV2ZW50ID0gZnVuY3Rpb24ocHJvcGVydHlJZCwgZGVwZW5kZW5jeVByb3BlcnR5SWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIGRlcGVuZGVuY3lQcm9wZXJ0eUlkIGlzIHRoZSBpZGVudGlmaWVyIGZvciB0aGUgcHJvcGVydHkgdGhhdCB0aGUgZmllbGQgInByb3BlcnR5SWQiIGlzIGRlcGVuZGVudCBvbgoKICAgICAgICAgICAgICAgIHZhciBkZXBlbmRlbnRGaWVsZCA9IEFscGFjYS5yZXNvbHZlRmllbGQoc2VsZiwgZGVwZW5kZW5jeVByb3BlcnR5SWQpOwogICAgICAgICAgICAgICAgaWYgKGRlcGVuZGVudEZpZWxkKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGRlcGVuZGVudEZpZWxkLmdldEVsKCkuYmluZCgiZmllbGR1cGRhdGUiLCBmdW5jdGlvbihwcm9wZXJ0eUZpZWxkLCBkZXBlbmRlbmN5RmllbGQsIHByb3BlcnR5SWQsIGRlcGVuZGVuY3lQcm9wZXJ0eUlkKSB7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oZXZlbnQpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBwcm9wZXJ0eSAiZGVwZW5kZW5jeVByb3BlcnR5SWQiIGNoYW5nZWQgYW5kIGFmZmVjdHMgdGFyZ2V0IHByb3BlcnR5ICgicHJvcGVydHlJZCIpCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdXBkYXRlIFVJIHN0YXRlIGZvciB0YXJnZXQgcHJvcGVydHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2hvd09ySGlkZVByb3BlcnR5QmFzZWRPbkRlcGVuZGVuY2llcyhwcm9wZXJ0eUlkKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eUZpZWxkLnRyaWdnZXIoImZpZWxkdXBkYXRlIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIH0oaXRlbSwgZGVwZW5kZW50RmllbGQsIHByb3BlcnR5SWQsIGRlcGVuZGVuY3lQcm9wZXJ0eUlkKSk7CgogICAgICAgICAgICAgICAgICAgIC8vIHRyaWdnZXIgZmllbGQgdXBkYXRlCiAgICAgICAgICAgICAgICAgICAgZGVwZW5kZW50RmllbGQudHJpZ2dlcigiZmllbGR1cGRhdGUiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNTdHJpbmcoaXRlbURlcGVuZGVuY2llcykpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGJpbmRFdmVudChwcm9wZXJ0eUlkLCBpdGVtRGVwZW5kZW5jaWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChBbHBhY2EuaXNBcnJheShpdGVtRGVwZW5kZW5jaWVzKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgJC5lYWNoKGl0ZW1EZXBlbmRlbmNpZXMsIGZ1bmN0aW9uKGluZGV4LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGJpbmRFdmVudChwcm9wZXJ0eUlkLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHJlZnJlc2hEZXBlbmRlbnRGaWVsZFN0YXRlczogZnVuY3Rpb24ocHJvcGVydHlJZCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHZhciBwcm9wZXJ0eUZpZWxkID0gdGhpcy5jaGlsZHJlbkJ5UHJvcGVydHlJZFtwcm9wZXJ0eUlkXTsKICAgICAgICAgICAgaWYgKCFwcm9wZXJ0eUZpZWxkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gQWxwYWNhLnRocm93RXJyb3JXaXRoQ2FsbGJhY2soIk1pc3NpbmcgcHJvcGVydHk6ICIgKyBwcm9wZXJ0eUlkLCBzZWxmLmVycm9yQ2FsbGJhY2spOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgaXRlbURlcGVuZGVuY2llcyA9IHByb3BlcnR5RmllbGQuc2NoZW1hLmRlcGVuZGVuY2llczsKICAgICAgICAgICAgaWYgKCFpdGVtRGVwZW5kZW5jaWVzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBubyBkZXBlbmRlbmNpZXMsIHNvIHNpbXBsZSByZXR1cm4KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBoZWxwZXIgZnVuY3Rpb24KICAgICAgICAgICAgdmFyIHRyaWdnZXJGaWVsZFVwZGF0ZUZvclByb3BlcnR5ID0gZnVuY3Rpb24ob3RoZXJQcm9wZXJ0eUlkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgZGVwZW5kZW50RmllbGQgPSBBbHBhY2EucmVzb2x2ZUZpZWxkKHNlbGYsIG90aGVyUHJvcGVydHlJZCk7CiAgICAgICAgICAgICAgICBpZiAoZGVwZW5kZW50RmllbGQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gdHJpZ2dlciBmaWVsZCB1cGRhdGUKICAgICAgICAgICAgICAgICAgICBkZXBlbmRlbnRGaWVsZC50cmlnZ2VyKCJmaWVsZHVwZGF0ZSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKEFscGFjYS5pc1N0cmluZyhpdGVtRGVwZW5kZW5jaWVzKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdHJpZ2dlckZpZWxkVXBkYXRlRm9yUHJvcGVydHkoaXRlbURlcGVuZGVuY2llcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoQWxwYWNhLmlzQXJyYXkoaXRlbURlcGVuZGVuY2llcykpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICQuZWFjaChpdGVtRGVwZW5kZW5jaWVzLCBmdW5jdGlvbihpbmRleCwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICB0cmlnZ2VyRmllbGRVcGRhdGVGb3JQcm9wZXJ0eSh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENoZWNrcyB3aGV0aGVyIGEgc2luZ2xlIHByb3BlcnR5J3MgZGVwZW5kZW5jeSBpcyBzYXRpc2ZpZWQgb3Igbm90LgogICAgICAgICAqCiAgICAgICAgICogSW4gb3JkZXIgdG8gYmUgdmFsaWQsIHRoZSBwcm9wZXJ0eSdzIGRlcGVuZGVuY3kgbXVzdCBleGlzdCAoSlNPTiBzY2hlbWEpIGFuZCBvcHRpb25hbGx5IG11c3Qgc2F0aXNmeQogICAgICAgICAqIGFueSBkZXBlbmRlbmN5IG9wdGlvbnMgKHZhbHVlIG1hdGNoZXMgdXNpbmcgYW4gQU5EKS4gIEZpbmFsbHksIHRoZSBkZXBlbmRlbmN5IGZpZWxkIG11c3QgYmUgc2hvd2luZy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwcm9wZXJ0eUlkIEZpZWxkIHByb3BlcnR5IGlkLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBkZXBlbmRlbnRPblByb3BlcnR5SWQgUHJvcGVydHkgaWQgb2YgdGhlIGRlcGVuZGVuY3kgZmllbGQuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZiBhbGwgZGVwZW5kZW5jaWVzIGhhdmUgYmVlbiBzYXRpc2ZpZWQgYW5kIHRoZSBmaWVsZCBuZWVkcyB0byBiZSBzaG93biwKICAgICAgICAgKiBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgZGV0ZXJtaW5lU2luZ2xlRGVwZW5kZW5jeVZhbGlkOiBmdW5jdGlvbihwcm9wZXJ0eUlkLCBkZXBlbmRlbnRPblByb3BlcnR5SWQpCiAgICAgICAgewogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICAvLyBjaGVja3MgdG8gc2VlIGlmIHRoZSByZWZlcmVuY2VkICJkZXBlbmRlbnQtb24iIHByb3BlcnR5IGhhcyBhIHZhbHVlCiAgICAgICAgICAgIC8vIGJhc2ljIEpTT04tc2NoZW1hIHN1cHBvcnRzIHRoaXMgKGlmIGl0IGhhcyBBTlkgdmFsdWUsIGl0IGlzIGNvbnNpZGVyZWQgdmFsaWQKICAgICAgICAgICAgLy8gc3BlY2lhbCBjb25zaWRlcmF0aW9uIGZvciBib29sZWFuIGZhbHNlCiAgICAgICAgICAgIHZhciBkZXBlbmRlbnRPbkZpZWxkID0gQWxwYWNhLnJlc29sdmVGaWVsZChzZWxmLCBkZXBlbmRlbnRPblByb3BlcnR5SWQpOwogICAgICAgICAgICBpZiAoIWRlcGVuZGVudE9uRmllbGQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIG5vIGRlcGVuZGVudC1vbiBmaWVsZCBmb3VuZCwgcmV0dXJuIGZhbHNlCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBkZXBlbmRlbnRPbkRhdGEgPSBkZXBlbmRlbnRPbkZpZWxkLmRhdGE7CgogICAgICAgICAgICAvLyBhc3N1bWUgaXQgaXNuJ3QgdmFsaWQKICAgICAgICAgICAgdmFyIHZhbGlkID0gZmFsc2U7CgogICAgICAgICAgICAvLyBnbyBvbmUgb2YgdHdvIGRpcmVjdGlvbnMgZGVwZW5kaW5nIG9uIHdoZXRoZXIgd2UgaGF2ZSBjb25kaXRpb25hbCBkZXBlbmRlbmNpZXMgb3Igbm90CiAgICAgICAgICAgIHZhciBjb25kaXRpb25hbERlcGVuZGVuY2llcyA9IHRoaXMuY2hpbGRyZW5CeVByb3BlcnR5SWRbcHJvcGVydHlJZF0ub3B0aW9ucy5kZXBlbmRlbmNpZXM7CiAgICAgICAgICAgIGlmICghY29uZGl0aW9uYWxEZXBlbmRlbmNpZXMgfHwgY29uZGl0aW9uYWxEZXBlbmRlbmNpZXMubGVuZ3RoID09PSAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgICAgLy8gQkFTSUMgREVQRU5FTkRFTkNZIENIRUNLSU5HIChDT1JFIEpTT04gU0NIRU1BKQogICAgICAgICAgICAgICAgLy8KCiAgICAgICAgICAgICAgICAvLyBzcGVjaWFsIGNhc2U6IGlmIHRoZSBmaWVsZCBpcyBhIGJvb2xlYW4gZmllbGQgYW5kIHdlIGhhdmUgbm8gY29uZGl0aW9uYWwgZGVwZW5kZW5jeSBjaGVja2luZywKICAgICAgICAgICAgICAgIC8vIHRoZW4gd2Ugc2V0IHZhbGlkID0gZmFsc2UgaWYgdGhlIGZpZWxkIGRhdGEgaXMgYSBib29sZWFuIGZhbHNlCiAgICAgICAgICAgICAgICBpZiAoZGVwZW5kZW50T25GaWVsZC5nZXRUeXBlKCkgPT09ICJib29sZWFuIiAmJiAhdGhpcy5jaGlsZHJlbkJ5UHJvcGVydHlJZFtwcm9wZXJ0eUlkXS5vcHRpb25zLmRlcGVuZGVuY2llcyAmJiAhZGVwZW5kZW50T25EYXRhKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFsaWQgPSAhQWxwYWNhLmlzVmFsRW1wdHkoZGVwZW5kZW50T25GaWVsZC5kYXRhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgICAvLyBDT05ESVRJT05BTCBERVBFTkRFTkNZIENIRUNLSU5HIChBTFBBQ0EgRVhURU5TSU9OIFZJQSBPUFRJT05TKQogICAgICAgICAgICAgICAgLy8KCiAgICAgICAgICAgICAgICAvLyBBbHBhY2EgZXh0ZW5kcyBKU09OIHNjaGVtYSBieSBhbGxvd2luZyBkZXBlbmRlbmNpZXMgdG8gdHJpZ2dlciBvbmx5IGZvciBzcGVjaWZpYyB2YWx1ZXMgb24gdGhlCiAgICAgICAgICAgICAgICAvLyBkZXBlbmRlbnQgZmllbGRzLiAgSWYgb3B0aW9ucyBhcmUgc3BlY2lmaWVkIHRvIGRlZmluZSB0aGlzLCB3ZSB3YWxrIHRocm91Z2ggYW5kIHBlcmZvcm0gYW4KICAgICAgICAgICAgICAgIC8vIEFORCBvcGVyYXRpb24gYWNyb3NzIGFueSBmaWVsZHMKCiAgICAgICAgICAgICAgICAvLyBkbyBzb21lIGRhdGEgc2FuaXR5IGNsZWFudXAKICAgICAgICAgICAgICAgIGlmIChkZXBlbmRlbnRPbkZpZWxkLmdldFR5cGUoKSA9PT0gImJvb2xlYW4iICYmICFkZXBlbmRlbnRPbkRhdGEpIHsKICAgICAgICAgICAgICAgICAgICBkZXBlbmRlbnRPbkRhdGEgPSBmYWxzZQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBjb25kaXRpb25hbERhdGEgPSBjb25kaXRpb25hbERlcGVuZGVuY2llc1tkZXBlbmRlbnRPblByb3BlcnR5SWRdOwoKICAgICAgICAgICAgICAgIC8vIGlmIHRoZSBvcHRpb24gaXMgYSBmdW5jdGlvbiwgdGhlbiBldmFsdWF0ZSB0aGUgZnVuY3Rpb24gdG8gZGV0ZXJtaW5lIHdoZXRoZXIgdG8gc2hvdwogICAgICAgICAgICAgICAgLy8gdGhlIGZ1bmN0aW9uIGV2YWx1YXRlcyByZWdhcmRsZXNzIG9mIHdoZXRoZXIgdGhlIHNjaGVtYS1iYXNlZCBmYWxsYmFjayBkZXRlcm1pbmVkIHdlIHNob3VsZCBzaG93CiAgICAgICAgICAgICAgICBpZiAoIUFscGFjYS5pc0VtcHR5KGNvbmRpdGlvbmFsRGF0YSkgJiYgQWxwYWNhLmlzRnVuY3Rpb24oY29uZGl0aW9uYWxEYXRhKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YWxpZCA9IGNvbmRpdGlvbmFsRGF0YS5jYWxsKHRoaXMsIGRlcGVuZGVudE9uRGF0YSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gYXNzdW1lIHRydWUKICAgICAgICAgICAgICAgICAgICB2YWxpZCA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgIC8vIHRoZSBjb25kaXRpb25hbCBkYXRhIGlzIGFuIGFycmF5IG9mIHZhbHVlcwogICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNBcnJheShjb25kaXRpb25hbERhdGEpKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBjaGVjayBhcnJheSB2YWx1ZQogICAgICAgICAgICAgICAgICAgICAgICAvL2lmIChjb25kaXRpb25hbERlcGVuZGVuY2llc1tkZXBlbmRlbnRPblByb3BlcnR5SWRdICYmICQuaW5BcnJheShkZXBlbmRlbnRPbkRhdGEsIGNvbmRpdGlvbmFsRGVwZW5kZW5jaWVzW2RlcGVuZGVudE9uUHJvcGVydHlJZF0pID09IC0xKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoQWxwYWNhLmFueUVxdWFsaXR5KGRlcGVuZGVudE9uRGF0YSwgY29uZGl0aW9uYWxEYXRhKSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBjaGVjayBvYmplY3QgdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eShjb25kaXRpb25hbERhdGEpICYmICFBbHBhY2EuYW55RXF1YWxpdHkoY29uZGl0aW9uYWxEYXRhLCBkZXBlbmRlbnRPbkRhdGEpKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBORVNURUQgSElEREVOUyBERVBFTkRFTkNZIEhJREVTIChBTFBBQ0EgRVhURU5TSU9OKQogICAgICAgICAgICAvLwoKICAgICAgICAgICAgLy8gZmluYWwgY2hlY2s6IG9ubHkgc2V0IHZhbGlkIGlmIHRoZSBkZXBlbmRlbnRPblByb3BlcnR5SWQgaXMgc2hvd2luZwogICAgICAgICAgICBpZiAoZGVwZW5kZW50T25GaWVsZCAmJiBkZXBlbmRlbnRPbkZpZWxkLmlzSGlkZGVuKCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB2YWxpZDsKICAgICAgICB9LAoKCgoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8KICAgICAgICAvLyBXSVpBUkQKICAgICAgICAvLwogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCgoKICAgICAgICAvKioKICAgICAgICAgKiBSZW5kZXJzIGEgdGVtcGxhdGUtYmFzZWQgd2l6YXJkLgogICAgICAgICAqLwogICAgICAgIHdpemFyZDogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLm91dGVyRWw7CiAgICAgICAgICAgIHZhciBzdGVwcyA9ICQoJy5hbHBhY2Etd2l6YXJkLXN0ZXAnLCBlbGVtZW50KTsKICAgICAgICAgICAgdmFyIGNvdW50ID0gc3RlcHMuc2l6ZSgpOwoKICAgICAgICAgICAgdGhpcy50b3RhbFN0ZXBzID0gY291bnQ7CgogICAgICAgICAgICB2YXIgc3RlcFRpdGxlcyA9IFtdOwogICAgICAgICAgICBpZiAodGhpcy53aXphcmRDb25maWdzLnN0ZXBUaXRsZXMpIHsKICAgICAgICAgICAgICAgIHN0ZXBUaXRsZXMgPSB0aGlzLndpemFyZENvbmZpZ3Muc3RlcFRpdGxlczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFByZXBhcmUgc3RlcCB0aXRsZXMKICAgICAgICAgICAgICAgIHN0ZXBzLmVhY2goZnVuY3Rpb24oaSkgewogICAgICAgICAgICAgICAgICAgIHZhciBzdGVwVGl0bGUgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICIiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiIgogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgaWYgKCQoJy5hbHBhY2Etd2l6YXJkLXN0ZXAtdGl0bGUnLCB0aGlzKSkgewogICAgICAgICAgICAgICAgICAgICAgICBzdGVwVGl0bGUudGl0bGUgPSAkKCcuYWxwYWNhLXdpemFyZC1zdGVwLXRpdGxlJywgdGhpcykuaHRtbCgpOwogICAgICAgICAgICAgICAgICAgICAgICAkKCcuYWxwYWNhLXdpemFyZC1zdGVwLXRpdGxlJywgdGhpcykuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoJCgnLmFscGFjYS13aXphcmQtc3RlcC1kZXNjcmlwdGlvbicsIHRoaXMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0ZXBUaXRsZS5kZXNjcmlwdGlvbiA9ICQoJy5hbHBhY2Etd2l6YXJkLXN0ZXAtZGVzY3JpcHRpb24nLCB0aGlzKS5odG1sKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICQoJy5hbHBhY2Etd2l6YXJkLXN0ZXAtZGVzY3JpcHRpb24nLCB0aGlzKS5oaWRlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHN0ZXBUaXRsZXMucHVzaChzdGVwVGl0bGUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHdpemFyZFN0YXR1c0JhckVsZW1lbnQgPSB0aGlzLl9yZW5kZXJXaXphcmRTdGF0dXNCYXIoc3RlcFRpdGxlcyk7CiAgICAgICAgICAgIGlmICh3aXphcmRTdGF0dXNCYXJFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAkKGVsZW1lbnQpLmJlZm9yZSh3aXphcmRTdGF0dXNCYXJFbGVtZW50KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3RlcHMuZWFjaChmdW5jdGlvbihpKSB7CgogICAgICAgICAgICAgICAgdmFyIHdpemFyZFN0ZXBUYXJnZXRJZCA9ICQodGhpcykuYXR0cigiaWQiKTsKCiAgICAgICAgICAgICAgICB2YXIgc3RlcElkID0gJ3N0ZXAnICsgaTsKICAgICAgICAgICAgICAgIHZhciB3aXphcmRTdGVwVGVtcGxhdGVEZXNjcmlwdG9yID0gX3RoaXMudmlldy5nZXRUZW1wbGF0ZURlc2NyaXB0b3IoIndpemFyZFN0ZXAiKTsKICAgICAgICAgICAgICAgIGlmICh3aXphcmRTdGVwVGVtcGxhdGVEZXNjcmlwdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHdpemFyZFN0ZXBFbGVtZW50ID0gX3RoaXMudmlldy50bXBsKHdpemFyZFN0ZXBUZW1wbGF0ZURlc2NyaXB0b3IsIHt9KTsKICAgICAgICAgICAgICAgICAgICB3aXphcmRTdGVwRWxlbWVudC5hdHRyKCJpZCIsIHN0ZXBJZCk7CiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS53cmFwKHdpemFyZFN0ZXBFbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgbmF2QmFySWQgPSBzdGVwSWQgKyAnLW5hdi1iYXInOwogICAgICAgICAgICAgICAgdmFyIHdpemFyZE5hdkJhclRlbXBsYXRlRGVzY3JpcHRvciA9IF90aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJ3aXphcmROYXZCYXIiKTsKICAgICAgICAgICAgICAgIGlmICh3aXphcmROYXZCYXJUZW1wbGF0ZURlc2NyaXB0b3IpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgd2l6YXJkTmF2QmFyRWxlbWVudCA9IF90aGlzLnZpZXcudG1wbCh3aXphcmROYXZCYXJUZW1wbGF0ZURlc2NyaXB0b3IsIHt9KTsKICAgICAgICAgICAgICAgICAgICB3aXphcmROYXZCYXJFbGVtZW50LmF0dHIoImlkIiwgbmF2QmFySWQpOwogICAgICAgICAgICAgICAgICAgIHdpemFyZE5hdkJhckVsZW1lbnQuYWRkQ2xhc3MoJ2FscGFjYS13aXphcmQtbmF2LWJhcicpOwogICAgICAgICAgICAgICAgICAgICQodGhpcykuYXBwZW5kKHdpemFyZE5hdkJhckVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGNvbGxlY3QgYWxsIG9mIHRoZSBzdGVwQmluZGluZ3MgZm9yIHRoaXMgc3RlcAogICAgICAgICAgICAgICAgdmFyIHN0ZXBCaW5kaW5ncyA9IHt9OwogICAgICAgICAgICAgICAgdmFyIGJpbmRpbmdzID0gX3RoaXMudmlldy5nZXRMYXlvdXQoKS5iaW5kaW5nczsKICAgICAgICAgICAgICAgIGZvciAodmFyIGZpZWxkSWQgaW4gYmluZGluZ3MpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGJpbmRpbmdUYXJnZXRJZCA9IGJpbmRpbmdzW2ZpZWxkSWRdOwoKICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZ1RhcmdldElkID09IHdpemFyZFN0ZXBUYXJnZXRJZCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0ZXBCaW5kaW5nc1tmaWVsZElkXSA9IHdpemFyZFN0ZXBUYXJnZXRJZDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIHZGdW5jID0gZnVuY3Rpb24oc3RlcENvdW50LCBzdGVwQmluZGluZ3MpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbGlkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfdGhpcy53aXphcmRDb25maWdzICYmIF90aGlzLndpemFyZENvbmZpZ3MudmFsaWRhdGlvbikgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIGF1dG8td2l6YXJkLCBwcm9jZXNzIGJpbmRpbmdzIG9uZSBhdCBhIHRpbWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGVwQmluZGluZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkLmVhY2goc3RlcEJpbmRpbmdzLCBmdW5jdGlvbihwcm9wZXJ0eUlkLCBzdGVwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkID0gdmFsaWQgJiBfdGhpcy5jaGlsZHJlbkJ5UHJvcGVydHlJZFtwcm9wZXJ0eUlkXS52YWxpZGF0ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jaGlsZHJlbkJ5UHJvcGVydHlJZFtwcm9wZXJ0eUlkXS5yZWZyZXNoVmFsaWRhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsaWQ7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0oaSwgc3RlcEJpbmRpbmdzKTsKCiAgICAgICAgICAgICAgICBpZiAoaSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIF90aGlzLl9jcmVhdGVOZXh0QnV0dG9uKGksIHRydWUsIHZGdW5jKTsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5fc2VsZWN0U3RlcChpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaSA9PSBjb3VudCAtIDEpIHsKICAgICAgICAgICAgICAgICAgICAkKCIjc3RlcCIgKyBpKS5oaWRlKCk7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuX2NyZWF0ZVByZXZCdXR0b24oaSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIF90aGlzLl9jcmVhdGVEb25lQnV0dG9uKGksIHRydWUsIHZGdW5jKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJCgiI3N0ZXAiICsgaSkuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgIF90aGlzLl9jcmVhdGVQcmV2QnV0dG9uKGksIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5fY3JlYXRlTmV4dEJ1dHRvbihpLCB0cnVlLCB2RnVuYyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJlbmRlcnMgYSBjb25maWd1cmF0aW9uLWJhc2VkIHdpemFyZCB3aXRob3V0IGEgbGF5b3V0IHRlbXBsYXRlLgogICAgICAgICAqLwogICAgICAgIGF1dG9XaXphcmQ6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIHZhciB0b3RhbFN0ZXBzID0gdGhpcy53aXphcmRDb25maWdzLnN0ZXBzOwoKICAgICAgICAgICAgaWYgKCF0b3RhbFN0ZXBzKSB7CiAgICAgICAgICAgICAgICB0b3RhbFN0ZXBzID0gMTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy50b3RhbFN0ZXBzID0gdG90YWxTdGVwczsKCiAgICAgICAgICAgIHZhciBzdGVwQmluZGluZ3MgPSB0aGlzLndpemFyZENvbmZpZ3MuYmluZGluZ3M7CgogICAgICAgICAgICBpZiAoIXN0ZXBCaW5kaW5ncykgewogICAgICAgICAgICAgICAgc3RlcEJpbmRpbmdzID0ge307CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAodmFyIHByb3BlcnR5SWQgaW4gdGhpcy5jaGlsZHJlbkJ5UHJvcGVydHlJZCkgewogICAgICAgICAgICAgICAgaWYgKCFzdGVwQmluZGluZ3MuaGFzT3duUHJvcGVydHkocHJvcGVydHlJZCkpIHsKICAgICAgICAgICAgICAgICAgICBzdGVwQmluZGluZ3NbcHJvcGVydHlJZF0gPSAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRvdGFsU3RlcHM7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHN0ZXAgPSBpICsgMTsKICAgICAgICAgICAgICAgIHZhciB0bXBBcnJheSA9IFtdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgcHJvcGVydHlJZCBpbiBzdGVwQmluZGluZ3MpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RlcEJpbmRpbmdzW3Byb3BlcnR5SWRdID09IHN0ZXApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2hpbGRyZW5CeVByb3BlcnR5SWQgJiYgdGhpcy5jaGlsZHJlbkJ5UHJvcGVydHlJZFtwcm9wZXJ0eUlkXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wQXJyYXkucHVzaCgiIyIgKyB0aGlzLmNoaWxkcmVuQnlQcm9wZXJ0eUlkW3Byb3BlcnR5SWRdLmNvbnRhaW5lci5hdHRyKCdpZCcpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgc3RlcElkID0gJ3N0ZXAnICsgaTsKICAgICAgICAgICAgICAgIHZhciB3aXphcmRTdGVwVGVtcGxhdGVEZXNjcmlwdG9yID0gdGhpcy52aWV3LmdldFRlbXBsYXRlRGVzY3JpcHRvcigid2l6YXJkU3RlcCIpOwogICAgICAgICAgICAgICAgaWYgKHdpemFyZFN0ZXBUZW1wbGF0ZURlc2NyaXB0b3IpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgd2l6YXJkU3RlcEVsZW1lbnQgPSBfdGhpcy52aWV3LnRtcGwod2l6YXJkU3RlcFRlbXBsYXRlRGVzY3JpcHRvciwge30pOwogICAgICAgICAgICAgICAgICAgIHdpemFyZFN0ZXBFbGVtZW50LmF0dHIoImlkIiwgc3RlcElkKTsKICAgICAgICAgICAgICAgICAgICAkKHRtcEFycmF5LmpvaW4oJywnKSkud3JhcEFsbCh3aXphcmRTdGVwRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIG5hdkJhcklkID0gc3RlcElkICsgJy1uYXYtYmFyJzsKICAgICAgICAgICAgICAgIHZhciB3aXphcmROYXZCYXJUZW1wbGF0ZURlc2NyaXB0b3IgPSB0aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJ3aXphcmROYXZCYXIiKTsKICAgICAgICAgICAgICAgIGlmICh3aXphcmROYXZCYXJUZW1wbGF0ZURlc2NyaXB0b3IpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgd2l6YXJkTmF2QmFyRWxlbWVudCA9IF90aGlzLnZpZXcudG1wbCh3aXphcmROYXZCYXJUZW1wbGF0ZURlc2NyaXB0b3IsIHt9KTsKICAgICAgICAgICAgICAgICAgICB3aXphcmROYXZCYXJFbGVtZW50LmF0dHIoImlkIiwgbmF2QmFySWQpOwogICAgICAgICAgICAgICAgICAgIHdpemFyZE5hdkJhckVsZW1lbnQuYWRkQ2xhc3MoJ2FscGFjYS13aXphcmQtbmF2LWJhcicpOwogICAgICAgICAgICAgICAgICAgICQoJyMnICsgc3RlcElkLCB0aGlzLm91dGVyRWwpLmFwcGVuZCh3aXphcmROYXZCYXJFbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHdpemFyZFN0YXR1c0JhckVsZW1lbnQgPSB0aGlzLl9yZW5kZXJXaXphcmRTdGF0dXNCYXIodGhpcy53aXphcmRDb25maWdzLnN0ZXBUaXRsZXMpOwogICAgICAgICAgICBpZiAod2l6YXJkU3RhdHVzQmFyRWxlbWVudCkgewogICAgICAgICAgICAgICAgd2l6YXJkU3RhdHVzQmFyRWxlbWVudC5wcmVwZW5kVG8odGhpcy5maWVsZENvbnRhaW5lcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdG90YWxTdGVwczsgaSsrKSB7CgogICAgICAgICAgICAgICAgdmFyIHZGdW5jID0gZnVuY3Rpb24oc3RlcENvdW50LCBzdGVwQmluZGluZ3MpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbGlkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfdGhpcy52aWV3ICYmIF90aGlzLndpemFyZENvbmZpZ3MgJiYgX3RoaXMud2l6YXJkQ29uZmlncy52YWxpZGF0aW9uKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgYXV0by13aXphcmQsIHByb2Nlc3MgYmluZGluZ3Mgb25lIGF0IGEgdGltZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0ZXBCaW5kaW5ncykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQuZWFjaChzdGVwQmluZGluZ3MsIGZ1bmN0aW9uKHByb3BlcnR5SWQsIHN0ZXApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0ZXAgPT0gc3RlcENvdW50ICsgMSAmJiB2YWxpZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWQgPSBfdGhpcy5jaGlsZHJlbkJ5UHJvcGVydHlJZFtwcm9wZXJ0eUlkXS52YWxpZGF0ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY2hpbGRyZW5CeVByb3BlcnR5SWRbcHJvcGVydHlJZF0udmFsaWRhdGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsaWQ7CgogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9KGksIHN0ZXBCaW5kaW5ncyk7CgoKICAgICAgICAgICAgICAgIGlmIChpID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuX2NyZWF0ZU5leHRCdXR0b24oaSwgZmFsc2UsIHZGdW5jKTsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5fc2VsZWN0U3RlcChpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaSA9PSB0b3RhbFN0ZXBzIC0gMSkgewogICAgICAgICAgICAgICAgICAgICQoIiNzdGVwIiArIGkpLmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICBfdGhpcy5fY3JlYXRlUHJldkJ1dHRvbihpLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuX2NyZWF0ZURvbmVCdXR0b24oaSwgdHJ1ZSwgdkZ1bmMpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkKCIjc3RlcCIgKyBpKS5oaWRlKCk7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuX2NyZWF0ZVByZXZCdXR0b24oaSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIF90aGlzLl9jcmVhdGVOZXh0QnV0dG9uKGksIGZhbHNlLCB2RnVuYyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZW5kZXJzIHdpemFyZCBzdGF0dXMgYmFyLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHN0ZXBUaXRsZXMgU3RlcCB0aXRsZXMuCiAgICAgICAgICovCiAgICAgICAgX3JlbmRlcldpemFyZFN0YXR1c0JhcjogZnVuY3Rpb24oc3RlcFRpdGxlcykgewoKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIHZhciB3aXphcmRTdGF0dXNCYXIgPSB0aGlzLndpemFyZENvbmZpZ3Muc3RhdHVzQmFyOwogICAgICAgICAgICBpZiAod2l6YXJkU3RhdHVzQmFyICYmIHN0ZXBUaXRsZXMpIHsKICAgICAgICAgICAgICAgIHZhciB3aXphcmRTdGF0dXNCYXJUZW1wbGF0ZURlc2NyaXB0b3IgPSB0aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJ3aXphcmRTdGF0dXNCYXIiKTsKICAgICAgICAgICAgICAgIGlmICh3aXphcmRTdGF0dXNCYXJUZW1wbGF0ZURlc2NyaXB0b3IpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgd2l6YXJkU3RhdHVzQmFyRWxlbWVudCA9IF90aGlzLnZpZXcudG1wbCh3aXphcmRTdGF0dXNCYXJUZW1wbGF0ZURlc2NyaXB0b3IsIHsKICAgICAgICAgICAgICAgICAgICAgICAgImlkIjogdGhpcy5nZXRJZCgpICsgIi13aXphcmQtc3RhdHVzLWJhciIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZXMiOiBzdGVwVGl0bGVzCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgd2l6YXJkU3RhdHVzQmFyRWxlbWVudC5hZGRDbGFzcygiYWxwYWNhLXdpemFyZC1zdGF0dXMtYmFyIik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRTdHlsZUluamVjdGlvbigid2l6YXJkU3RhdHVzQmFyIix3aXphcmRTdGF0dXNCYXJFbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2l6YXJkU3RhdHVzQmFyRWxlbWVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENyZWF0ZXMgYW4gInByZXYiIGJ1dHRvbi4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7SW50ZWdlcn0gaSBTdGVwIG51bWJlci4KICAgICAgICAgKiBAcGFyYW0gW2Jvb2xlYW5dIHdoZXRoZXIgdG8gYWRkIGEgY2xlYXIgZGl2IGF0IHRoZSBlbmQKICAgICAgICAgKiBAcGFyYW0gW3ZhbGlkYXRpb25GdW5jdGlvbl0gZnVuY3Rpb24gdGVzdCB3aGV0aGVyIHRoZSBidXR0b24gc2hvdWxkIGJlIGFsbG93ZWQgdG8gcHJvY2VlZAogICAgICAgICAqLwogICAgICAgIF9jcmVhdGVQcmV2QnV0dG9uOiBmdW5jdGlvbihpLCBjbGVhciwgdmFsaWRhdGlvbkZ1bmN0aW9uKSB7CgogICAgICAgICAgICAvLyBvbmx5IGFwcGx5IHZhbGlkYXRpb24gaWYgY29uZmlndXJlZCB0byBkbyBzbwogICAgICAgICAgICBpZiAodGhpcy53aXphcmRDb25maWdzLmJ1dHRvbnMgJiYgdGhpcy53aXphcmRDb25maWdzLmJ1dHRvbnMucHJldikgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLndpemFyZENvbmZpZ3MuYnV0dG9ucy5wcmV2LnZhbGlkYXRlT25DbGljaykgewogICAgICAgICAgICAgICAgICAgIHZhbGlkYXRpb25GdW5jdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBzdGVwTmFtZSA9ICJzdGVwIiArIGk7CiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICB2YXIgd2l6YXJkUHJlQnV0dG9uVGVtcGxhdGVEZXNjcmlwdG9yID0gdGhpcy52aWV3LmdldFRlbXBsYXRlRGVzY3JpcHRvcigid2l6YXJkUHJlQnV0dG9uIik7CiAgICAgICAgICAgIGlmICh3aXphcmRQcmVCdXR0b25UZW1wbGF0ZURlc2NyaXB0b3IpIHsKICAgICAgICAgICAgICAgIHZhciB3aXphcmRQcmVCdXR0b25FbGVtZW50ID0gX3RoaXMudmlldy50bXBsKHdpemFyZFByZUJ1dHRvblRlbXBsYXRlRGVzY3JpcHRvciwge30pOwogICAgICAgICAgICAgICAgd2l6YXJkUHJlQnV0dG9uRWxlbWVudC5hdHRyKCJpZCIsIHN0ZXBOYW1lICsgJy1idXR0b24tcHJlJyk7CiAgICAgICAgICAgICAgICB3aXphcmRQcmVCdXR0b25FbGVtZW50LmFkZENsYXNzKCJhbHBhY2Etd2l6YXJkLWJ1dHRvbi1wcmUiKTsKICAgICAgICAgICAgICAgIGlmIChfdGhpcy5idXR0b25CZWF1dGlmaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuYnV0dG9uQmVhdXRpZmllci5jYWxsKF90aGlzLCB3aXphcmRQcmVCdXR0b25FbGVtZW50LCB0aGlzLndpemFyZFByZUljb24sdHJ1ZSApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHdoZW4gdGhleSBjbGljayAicHJldiIsIHJ1biB2YWxpZGF0aW9uIGZ1bmN0aW9uIGZpcnN0IHRvIG1ha2Ugc3VyZSB0aGV5J3JlIGFsbG93ZWQgdG8gcHJvY2VlZAogICAgICAgICAgICAgICAgd2l6YXJkUHJlQnV0dG9uRWxlbWVudC5jbGljayhmdW5jdGlvbihzdGVwTmFtZSwgc3RlcENvdW50LCB2YWxpZGF0aW9uRnVuY3Rpb24pIHsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsaWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbGlkYXRpb25GdW5jdGlvbikKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWQgPSB2YWxpZGF0aW9uRnVuY3Rpb24oc3RlcE5hbWUsIHN0ZXBDb3VudCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWxpZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgiIyIgKyBzdGVwTmFtZSkuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgiI3N0ZXAiICsgKGkgLSAxKSkuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuX3NlbGVjdFN0ZXAoaSAtIDEpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IGZpcmUgY2xpY2sgaGFuZGxlcj8KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfdGhpcy53aXphcmRDb25maWdzLmJ1dHRvbnMucHJldiAmJiBfdGhpcy53aXphcmRDb25maWdzLmJ1dHRvbnMucHJldi5vbkNsaWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMud2l6YXJkQ29uZmlncy5idXR0b25zLnByZXYub25DbGljaygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0oc3RlcE5hbWUsIGksIHZhbGlkYXRpb25GdW5jdGlvbikpOwoKICAgICAgICAgICAgICAgICQoIiMiICsgc3RlcE5hbWUgKyAiLW5hdi1iYXIiKS5hcHBlbmQod2l6YXJkUHJlQnV0dG9uRWxlbWVudCk7CiAgICAgICAgICAgICAgICBpZiAoY2xlYXIpIHsKICAgICAgICAgICAgICAgICAgICAkKCIjIiArIHN0ZXBOYW1lICsgIi1uYXYtYmFyIikucGFyZW50KCkuYXBwZW5kKCI8ZGl2IHN0eWxlPSdjbGVhcjpib3RoJz48L2Rpdj4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBDcmVhdGVzIGEgIm5leHQiIGJ1dHRvbi4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7SW50ZWdlcn0gaSBTdGVwIG51bWJlci4KICAgICAgICAgKiBAcGFyYW0gW2Jvb2xlYW5dIHdoZXRoZXIgdG8gYWRkIGEgY2xlYXIgZGl2IGF0IHRoZSBlbmQKICAgICAgICAgKiBAcGFyYW0gW3ZhbGlkYXRpb25GdW5jdGlvbl0gZnVuY3Rpb24gdGVzdCB3aGV0aGVyIHRoZSBidXR0b24gc2hvdWxkIGJlIGFsbG93ZWQgdG8gcHJvY2VlZAogICAgICAgICAqLwogICAgICAgIF9jcmVhdGVOZXh0QnV0dG9uOiBmdW5jdGlvbihpLCBjbGVhciwgdmFsaWRhdGlvbkZ1bmN0aW9uKSB7CgogICAgICAgICAgICAvLyBvbmx5IGFwcGx5IHZhbGlkYXRpb24gaWYgY29uZmlndXJlZCB0byBkbyBzbwogICAgICAgICAgICBpZiAodGhpcy53aXphcmRDb25maWdzLmJ1dHRvbnMgJiYgdGhpcy53aXphcmRDb25maWdzLmJ1dHRvbnMubmV4dCkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLndpemFyZENvbmZpZ3MuYnV0dG9ucy5uZXh0LnZhbGlkYXRlT25DbGljaykgewogICAgICAgICAgICAgICAgICAgIHZhbGlkYXRpb25GdW5jdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBzdGVwTmFtZSA9ICJzdGVwIiArIGk7CiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICB2YXIgd2l6YXJkTmV4dEJ1dHRvblRlbXBsYXRlRGVzY3JpcHRvciA9IHRoaXMudmlldy5nZXRUZW1wbGF0ZURlc2NyaXB0b3IoIndpemFyZE5leHRCdXR0b24iKTsKICAgICAgICAgICAgaWYgKHdpemFyZE5leHRCdXR0b25UZW1wbGF0ZURlc2NyaXB0b3IpIHsKICAgICAgICAgICAgICAgIHZhciB3aXphcmROZXh0QnV0dG9uRWxlbWVudCA9IF90aGlzLnZpZXcudG1wbCh3aXphcmROZXh0QnV0dG9uVGVtcGxhdGVEZXNjcmlwdG9yLCB7fSk7CiAgICAgICAgICAgICAgICB3aXphcmROZXh0QnV0dG9uRWxlbWVudC5hdHRyKCJpZCIsIHN0ZXBOYW1lICsgJy1idXR0b24tbmV4dCcpOwogICAgICAgICAgICAgICAgd2l6YXJkTmV4dEJ1dHRvbkVsZW1lbnQuYWRkQ2xhc3MoImFscGFjYS13aXphcmQtYnV0dG9uLW5leHQiKTsKICAgICAgICAgICAgICAgIGlmIChfdGhpcy5idXR0b25CZWF1dGlmaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuYnV0dG9uQmVhdXRpZmllci5jYWxsKF90aGlzLCB3aXphcmROZXh0QnV0dG9uRWxlbWVudCwgdGhpcy53aXphcmROZXh0SWNvbix0cnVlICk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gd2hlbiB0aGV5IGNsaWNrICJuZXh0IiwgcnVuIHZhbGlkYXRpb24gZnVuY3Rpb24gZmlyc3QgdG8gbWFrZSBzdXJlIHRoZXkncmUgYWxsb3dlZCB0byBwcm9jZWVkCiAgICAgICAgICAgICAgICB3aXphcmROZXh0QnV0dG9uRWxlbWVudC5jbGljayhmdW5jdGlvbihzdGVwTmFtZSwgc3RlcENvdW50LCB2YWxpZGF0aW9uRnVuY3Rpb24pIHsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsaWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbGlkYXRpb25GdW5jdGlvbikKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWQgPSB2YWxpZGF0aW9uRnVuY3Rpb24oc3RlcE5hbWUsIHN0ZXBDb3VudCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWxpZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgiIyIgKyBzdGVwTmFtZSkuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgiI3N0ZXAiICsgKHN0ZXBDb3VudCArIDEpKS5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5fc2VsZWN0U3RlcChzdGVwQ291bnQgKyAxKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBmaXJlIGNsaWNrIGhhbmRsZXI/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoX3RoaXMud2l6YXJkQ29uZmlncy5idXR0b25zLm5leHQgJiYgX3RoaXMud2l6YXJkQ29uZmlncy5idXR0b25zLm5leHQub25DbGljaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLndpemFyZENvbmZpZ3MuYnV0dG9ucy5uZXh0Lm9uQ2xpY2soKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9KHN0ZXBOYW1lLCBpLCB2YWxpZGF0aW9uRnVuY3Rpb24pKTsKCiAgICAgICAgICAgICAgICAkKCIjIiArIHN0ZXBOYW1lICsgIi1uYXYtYmFyIikuYXBwZW5kKHdpemFyZE5leHRCdXR0b25FbGVtZW50KTsKICAgICAgICAgICAgICAgIGlmIChjbGVhcikgewogICAgICAgICAgICAgICAgICAgICQoIiMiICsgc3RlcE5hbWUgKyAiLW5hdi1iYXIiKS5wYXJlbnQoKS5hcHBlbmQoIjxkaXYgc3R5bGU9J2NsZWFyOmJvdGgnPjwvZGl2PiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ3JlYXRlcyBhICJkb25lIiBidXR0b24uCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0ludGVnZXJ9IGkgU3RlcCBudW1iZXIuCiAgICAgICAgICogQHBhcmFtIFtib29sZWFuXSB3aGV0aGVyIHRvIGFkZCBhIGNsZWFyIGRpdiBhdCB0aGUgZW5kCiAgICAgICAgICogQHBhcmFtIFt2YWxpZGF0aW9uRnVuY3Rpb25dIGZ1bmN0aW9uIHRlc3Qgd2hldGhlciB0aGUgYnV0dG9uIHNob3VsZCBiZSBhbGxvd2VkIHRvIHByb2NlZWQKICAgICAgICAgKi8KICAgICAgICBfY3JlYXRlRG9uZUJ1dHRvbjogZnVuY3Rpb24oaSwgY2xlYXIsIHZhbGlkYXRpb25GdW5jdGlvbikgewoKICAgICAgICAgICAgLy8gb25seSBhcHBseSB2YWxpZGF0aW9uIGlmIGNvbmZpZ3VyZWQgdG8gZG8gc28KICAgICAgICAgICAgaWYgKHRoaXMud2l6YXJkQ29uZmlncy5idXR0b25zICYmIHRoaXMud2l6YXJkQ29uZmlncy5idXR0b25zLmRvbmUpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy53aXphcmRDb25maWdzLmJ1dHRvbnMuZG9uZS52YWxpZGF0ZU9uQ2xpY2spIHsKICAgICAgICAgICAgICAgICAgICB2YWxpZGF0aW9uRnVuY3Rpb24gPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgc3RlcE5hbWUgPSAic3RlcCIgKyBpOwogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgdmFyIHdpemFyZERvbmVCdXR0b25UZW1wbGF0ZURlc2NyaXB0b3IgPSB0aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJ3aXphcmREb25lQnV0dG9uIik7CiAgICAgICAgICAgIGlmICh3aXphcmREb25lQnV0dG9uVGVtcGxhdGVEZXNjcmlwdG9yKSB7CiAgICAgICAgICAgICAgICB2YXIgd2l6YXJkRG9uZUJ1dHRvbkVsZW1lbnQgPSBfdGhpcy52aWV3LnRtcGwod2l6YXJkRG9uZUJ1dHRvblRlbXBsYXRlRGVzY3JpcHRvciwge30pOwogICAgICAgICAgICAgICAgd2l6YXJkRG9uZUJ1dHRvbkVsZW1lbnQuYXR0cigiaWQiLCBzdGVwTmFtZSArICctYnV0dG9uLWRvbmUnKTsKICAgICAgICAgICAgICAgIHdpemFyZERvbmVCdXR0b25FbGVtZW50LmFkZENsYXNzKCJhbHBhY2Etd2l6YXJkLWJ1dHRvbi1kb25lIik7CiAgICAgICAgICAgICAgICBpZiAoX3RoaXMuYnV0dG9uQmVhdXRpZmllcikgewogICAgICAgICAgICAgICAgICAgIF90aGlzLmJ1dHRvbkJlYXV0aWZpZXIuY2FsbChfdGhpcywgd2l6YXJkRG9uZUJ1dHRvbkVsZW1lbnQsIHRoaXMud2l6YXJkRG9uZUljb24sdHJ1ZSApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHdoZW4gdGhleSBjbGljayAiZG9uZSIsIHJ1biB2YWxpZGF0aW9uIGZ1bmN0aW9uIGZpcnN0IHRvIG1ha2Ugc3VyZSB0aGV5J3JlIGFsbG93ZWQgdG8gcHJvY2VlZAogICAgICAgICAgICAgICAgd2l6YXJkRG9uZUJ1dHRvbkVsZW1lbnQuY2xpY2soZnVuY3Rpb24oc3RlcE5hbWUsIHN0ZXBDb3VudCwgdmFsaWRhdGlvbkZ1bmN0aW9uKSB7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbGlkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWxpZGF0aW9uRnVuY3Rpb24pCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkID0gdmFsaWRhdGlvbkZ1bmN0aW9uKHN0ZXBOYW1lLCBzdGVwQ291bnQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoIiMiICsgc3RlcE5hbWUgKyAiLW5hdi1iYXIiKS5hcHBlbmQod2l6YXJkRG9uZUJ1dHRvbkVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNsZWFyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgiIyIgKyBzdGVwTmFtZSArICItbmF2LWJhciIpLnBhcmVudCgpLmFwcGVuZCgiPGRpdiBzdHlsZT0nY2xlYXI6Ym90aCc+PC9kaXY+Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogZmlyZSBjbGljayBoYW5kbGVyPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF90aGlzLndpemFyZENvbmZpZ3MuYnV0dG9ucy5kb25lICYmIF90aGlzLndpemFyZENvbmZpZ3MuYnV0dG9ucy5kb25lLm9uQ2xpY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy53aXphcmRDb25maWdzLmJ1dHRvbnMuZG9uZS5vbkNsaWNrKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfShzdGVwTmFtZSwgaSwgdmFsaWRhdGlvbkZ1bmN0aW9uKSk7CgogICAgICAgICAgICAgICAgJCgiIyIgKyBzdGVwTmFtZSArICItbmF2LWJhciIpLmFwcGVuZCh3aXphcmREb25lQnV0dG9uRWxlbWVudCk7CiAgICAgICAgICAgICAgICBpZiAoY2xlYXIpIHsKICAgICAgICAgICAgICAgICAgICAkKCIjIiArIHN0ZXBOYW1lICsgIi1uYXYtYmFyIikucGFyZW50KCkuYXBwZW5kKCI8ZGl2IHN0eWxlPSdjbGVhcjpib3RoJz48L2Rpdj4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBTZWxlY3RzIGEgd2l6YXJkIHN0ZXAuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0ludGVnZXJ9IGkgU3RlcCBudW1iZXIuCiAgICAgICAgICovCiAgICAgICAgX3NlbGVjdFN0ZXA6IGZ1bmN0aW9uKGkpIHsKICAgICAgICAgICAgdmFyIHVuQ3VycmVudFN0ZXBFbGVtID0gJCgiIyIgKyB0aGlzLmdldElkKCkgKyAiLXdpemFyZC1zdGF0dXMtYmFyIiArICIgbGkiKTsKICAgICAgICAgICAgdW5DdXJyZW50U3RlcEVsZW0ucmVtb3ZlQ2xhc3MoImN1cnJlbnQgY3VycmVudC1oYXMtbmV4dCIpOwogICAgICAgICAgICB0aGlzLmdldFN0eWxlSW5qZWN0aW9uKCJ3aXphcmRVbkN1cnJlbnRTdGVwIix1bkN1cnJlbnRTdGVwRWxlbSk7CiAgICAgICAgICAgIHZhciBjdXJyZW50U3RlcEVsZW0gPSAkKCIjc3RlcERlc2MiICsgaSk7CiAgICAgICAgICAgIGN1cnJlbnRTdGVwRWxlbS5hZGRDbGFzcygiY3VycmVudCIpOwogICAgICAgICAgICB0aGlzLmdldFN0eWxlSW5qZWN0aW9uKCJ3aXphcmRDdXJyZW50U3RlcCIsY3VycmVudFN0ZXBFbGVtKTsKICAgICAgICAgICAgaWYgKGkgPCB0aGlzLnRvdGFsU3RlcHMgLSAxKSB7CiAgICAgICAgICAgICAgICAkKCIjc3RlcERlc2MiICsgaSkuYWRkQ2xhc3MoImN1cnJlbnQtaGFzLW5leHQiKTsKICAgICAgICAgICAgfQogICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRhaW5lckZpZWxkI2dldFNjaGVtYU9mU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZTY2hlbWE6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcHJvcGVydGllcyA9IHsKICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiUHJvcGVydGllcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJMaXN0IG9mIGNoaWxkIHByb3BlcnRpZXMuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAib2JqZWN0IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgIm1heFByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm51bWJlciIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJNYXhpbXVtIE51bWJlciBQcm9wZXJ0aWVzIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlRoZSBtYXhpbXVtIG51bWJlciBvZiBwcm9wZXJ0aWVzIHRoYXQgdGhpcyBvYmplY3QgaXMgYWxsb3dlZCB0byBoYXZlIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgIm1pblByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm51bWJlciIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJNaW5pbXVtIE51bWJlciBvZiBQcm9wZXJ0aWVzIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlRoZSBtaW5pbXVtIG51bWJlciBvZiBwcm9wZXJ0aWVzIHRoYXQgdGhpcyBvYmplY3QgaXMgcmVxdWlyZWQgdG8gaGF2ZSIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgZmllbGRzUHJvcGVydGllcyA9IHByb3BlcnRpZXMucHJvcGVydGllcy5wcm9wZXJ0aWVzOwoKICAgICAgICAgICAgZmllbGRzUHJvcGVydGllcy5wcm9wZXJ0aWVzID0ge307CgogICAgICAgICAgICBpZiAodGhpcy5jaGlsZHJlbikgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHByb3BlcnR5SWQgPSB0aGlzLmNoaWxkcmVuW2ldLnByb3BlcnR5SWQ7CiAgICAgICAgICAgICAgICAgICAgZmllbGRzUHJvcGVydGllcy5wcm9wZXJ0aWVzW3Byb3BlcnR5SWRdID0gdGhpcy5jaGlsZHJlbltpXS5nZXRTY2hlbWFPZlNjaGVtYSgpOwogICAgICAgICAgICAgICAgICAgIGZpZWxkc1Byb3BlcnRpZXMucHJvcGVydGllc1twcm9wZXJ0eUlkXS50aXRsZSA9IHByb3BlcnR5SWQgKyAiIDo6ICIgKyBmaWVsZHNQcm9wZXJ0aWVzLnByb3BlcnRpZXNbcHJvcGVydHlJZF0udGl0bGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHByb3BlcnRpZXMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udGFpbmVyRmllbGQjZ2V0U2NoZW1hT2ZPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHNjaGVtYU9mT3B0aW9ucyA9IEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdmFyIHByb3BlcnRpZXMgPSB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRmllbGQgT3B0aW9ucyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJMaXN0IG9mIG9wdGlvbnMgZm9yIGNoaWxkIGZpZWxkcy4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJvYmplY3QiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIGZpZWxkc1Byb3BlcnRpZXMgPSBwcm9wZXJ0aWVzLnByb3BlcnRpZXMuZmllbGRzOwoKICAgICAgICAgICAgZmllbGRzUHJvcGVydGllcy5wcm9wZXJ0aWVzID0ge307CgogICAgICAgICAgICBpZiAodGhpcy5jaGlsZHJlbikgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHByb3BlcnR5SWQgPSB0aGlzLmNoaWxkcmVuW2ldLnByb3BlcnR5SWQ7CiAgICAgICAgICAgICAgICAgICAgZmllbGRzUHJvcGVydGllcy5wcm9wZXJ0aWVzW3Byb3BlcnR5SWRdID0gdGhpcy5jaGlsZHJlbltpXS5nZXRTY2hlbWFPZk9wdGlvbnMoKTsKICAgICAgICAgICAgICAgICAgICBmaWVsZHNQcm9wZXJ0aWVzLnByb3BlcnRpZXNbcHJvcGVydHlJZF0udGl0bGUgPSBwcm9wZXJ0eUlkICsgIiA6OiAiICsgZmllbGRzUHJvcGVydGllcy5wcm9wZXJ0aWVzW3Byb3BlcnR5SWRdLnRpdGxlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHNjaGVtYU9mT3B0aW9ucywgcHJvcGVydGllcyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZ2V0VGl0bGUKICAgICAgICAgKi8KICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiT2JqZWN0IEZpZWxkIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJPYmplY3QgZmllbGQgZm9yIGNvbnRhaW5pbmcgb3RoZXIgZmllbGRzIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0VHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAib2JqZWN0IjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRGaWVsZFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIm9iamVjdCI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCgogICAgfSk7CgogICAgLy8gQWRkaXRpb25hbCBSZWdpc3RyYXRpb25zCiAgICBBbHBhY2EucmVnaXN0ZXJNZXNzYWdlcyh7CiAgICAgICAgInRvb01hbnlQcm9wZXJ0aWVzIjogIlRoZSBtYXhpbXVtIG51bWJlciBvZiBwcm9wZXJ0aWVzICh7MH0pIGhhcyBiZWVuIGV4Y2VlZGVkLiIsCiAgICAgICAgInRvb0Zld1Byb3BlcnRpZXMiOiAiVGhlcmUgYXJlIG5vdCBlbm91Z2ggcHJvcGVydGllcyAoezB9IGFyZSByZXF1aXJlZCkiCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJGaWVsZENsYXNzKCJvYmplY3QiLCBBbHBhY2EuRmllbGRzLk9iamVjdEZpZWxkKTsKICAgIEFscGFjYS5yZWdpc3RlckRlZmF1bHRTY2hlbWFGaWVsZE1hcHBpbmcoIm9iamVjdCIsICJvYmplY3QiKTsKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5BbnlGaWVsZCA9IEFscGFjYS5Db250cm9sRmllbGQuZXh0ZW5kKAogICAgLyoqCiAgICAgKiBAbGVuZHMgQWxwYWNhLkZpZWxkcy5BbnlGaWVsZC5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5Db250cm9sRmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBCYXNpYyBmaWVsZCBjb250cm9sIGZvciBKU09OIHNjaGVtYSBhbnkgdHlwZS4gVGhpcyBjb250cm9sIHNob3VsZCBiZSB1c2VkIHdpdGggYWRkaXRpb25hbCBvcHRpb25zIHBhcmFtZXRlcgogICAgICAgICAqIGZvciBjb21ibyBmaWVsZHMuIFdpdGhvdXQgb3B0aW9ucyBwYXJhbWV0ZXIgaXQgd2lsbCBzaW1wbHkgcmVuZGVyIGEgdGV4dCBmaWVsZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjc2V0dXAKICAgICAgICAgKi8KICAgICAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgdGhpcy5jb250cm9sRmllbGRUZW1wbGF0ZURlc2NyaXB0b3IgPSB0aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJjb250cm9sRmllbGRBbnkiKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjcmVuZGVyRmllbGQKICAgICAgICAgKi8KICAgICAgICByZW5kZXJGaWVsZDogZnVuY3Rpb24ob25TdWNjZXNzKSB7CgogICAgICAgICAgICBpZiAodGhpcy5jb250cm9sRmllbGRUZW1wbGF0ZURlc2NyaXB0b3IpIHsKICAgICAgICAgICAgICAgIHRoaXMuZmllbGQgPSB0aGlzLnZpZXcudG1wbCh0aGlzLmNvbnRyb2xGaWVsZFRlbXBsYXRlRGVzY3JpcHRvciwgewogICAgICAgICAgICAgICAgICAgICJpZCI6IHRoaXMuZ2V0SWQoKSwKICAgICAgICAgICAgICAgICAgICAibmFtZSI6IHRoaXMubmFtZSwKICAgICAgICAgICAgICAgICAgICAib3B0aW9ucyI6IHRoaXMub3B0aW9ucwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLmluamVjdEZpZWxkKHRoaXMuZmllbGQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob25TdWNjZXNzKSB7CiAgICAgICAgICAgICAgICBvblN1Y2Nlc3MoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldFZhbHVlCiAgICAgICAgICovCiAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5maWVsZC52YWwoKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNzZXRWYWx1ZQogICAgICAgICAqLwogICAgICAgIHNldFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkodmFsdWUpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLnZhbCgiIik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLnZhbCh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gYmUgc3VyZSB0byBjYWxsIGludG8gYmFzZSBtZXRob2QKICAgICAgICAgICAgdGhpcy5iYXNlKHZhbHVlKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjaGFuZGxlVmFsaWRhdGUKICAgICAgICAgKi8KICAgICAgICBoYW5kbGVWYWxpZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBiYXNlU3RhdHVzID0gdGhpcy5iYXNlKCk7CiAgICAgICAgICAgIHJldHVybiBiYXNlU3RhdHVzOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2Rpc2FibGUKICAgICAgICAgKi8KICAgICAgICBkaXNhYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5maWVsZC5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZW5hYmxlCiAgICAgICAgICovCiAgICAgICAgZW5hYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5maWVsZC5kaXNhYmxlZCA9IGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2ZvY3VzCiAgICAgICAgICovCiAgICAgICAgZm9jdXM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmZpZWxkLmZvY3VzKCk7CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2dldFNjaGVtYU9mU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZTY2hlbWE6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjZ2V0T3B0aW9uc0ZvclNjaGVtYQogICAgICAgICAqLwogICAgICAgIGdldE9wdGlvbnNGb3JTY2hlbWE6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRyb2xGaWVsZCNnZXRTY2hlbWFPZk9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRTY2hlbWFPZk9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250cm9sRmllbGQjZ2V0T3B0aW9uc0Zvck9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldFRpdGxlCiAgICAgICAgICovCiAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIkFueSBGaWVsZCI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZ2V0RGVzY3JpcHRpb24KICAgICAgICAgKi8KICAgICAgICBnZXREZXNjcmlwdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiQW55IGZpZWxkLiI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZ2V0VHlwZQogICAgICAgICAqLwogICAgICAgIGdldFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gImFueSI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZ2V0RmllbGRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJhbnkiOwogICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyVGVtcGxhdGUoImNvbnRyb2xGaWVsZEFueSIsICc8aW5wdXQgdHlwZT0idGV4dCIgaWQ9IiR7aWR9IiBzaXplPSI0MCIge3tpZiBvcHRpb25zLnJlYWRvbmx5fX1yZWFkb25seT0icmVhZG9ubHkie3svaWZ9fSB7e2lmIG5hbWV9fW5hbWU9IiR7bmFtZX0ie3svaWZ9fSB7e2VhY2goaSx2KSBvcHRpb25zLmRhdGF9fWRhdGEtJHtpfT0iJHt2fSJ7ey9lYWNofX0vPicpOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiYW55IiwgQWxwYWNhLkZpZWxkcy5BbnlGaWVsZCk7CiAgICBBbHBhY2EucmVnaXN0ZXJEZWZhdWx0U2NoZW1hRmllbGRNYXBwaW5nKCJhbnkiLCAiYW55Iik7Cn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuSGlkZGVuRmllbGQgPSBBbHBhY2EuQ29udHJvbEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuQ29udHJvbEZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkNvbnRyb2xGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIEJhc2ljIENvbnRyb2wgZm9yIEhpZGRlbiBmaWVsZAogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IGRhdGEgRmllbGQgZGF0YS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBGaWVsZCBvcHRpb25zLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBGaWVsZCB2aWV3LgogICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbm5lY3Rvcn0gY29ubmVjdG9yIEZpZWxkIGNvbm5lY3Rvci4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNzZXR1cAogICAgICAgICAqLwogICAgICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CgogICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5zaXplKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuc2l6ZSA9IDQwOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmNvbnRyb2xGaWVsZFRlbXBsYXRlRGVzY3JpcHRvciA9IHRoaXMudmlldy5nZXRUZW1wbGF0ZURlc2NyaXB0b3IoImNvbnRyb2xGaWVsZEhpZGRlbiIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRyb2xGaWVsZCNyZW5kZXJGaWVsZAogICAgICAgICAqLwogICAgICAgIHJlbmRlckZpZWxkOiBmdW5jdGlvbihvblN1Y2Nlc3MpIHsKCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICBpZiAodGhpcy5jb250cm9sRmllbGRUZW1wbGF0ZURlc2NyaXB0b3IpIHsKCiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkID0gX3RoaXMudmlldy50bXBsKHRoaXMuY29udHJvbEZpZWxkVGVtcGxhdGVEZXNjcmlwdG9yLCB7CiAgICAgICAgICAgICAgICAgICAgImlkIjogdGhpcy5nZXRJZCgpLAogICAgICAgICAgICAgICAgICAgICJuYW1lIjogdGhpcy5uYW1lLAogICAgICAgICAgICAgICAgICAgICJvcHRpb25zIjogdGhpcy5vcHRpb25zCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMuaW5qZWN0RmllbGQodGhpcy5maWVsZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvblN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIG9uU3VjY2VzcygpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI3Bvc3RSZW5kZXIKICAgICAgICAgKi8KICAgICAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbihjYWxsYmFjaykgewoKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgdGhpcy5iYXNlKGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgIGlmIChzZWxmLmZpZWxkQ29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5maWVsZENvbnRhaW5lci5hZGRDbGFzcygnYWxwYWNhLWNvbnRyb2xmaWVsZC1oaWRkZW4nKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjZ2V0VmFsdWUKICAgICAgICAgKi8KICAgICAgICBnZXRWYWx1ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmZpZWxkLnZhbCgpOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjc2V0VmFsdWUKICAgICAgICAgKi8KICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgaWYgKEFscGFjYS5pc0VtcHR5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgdGhpcy5maWVsZC52YWwoIiIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5maWVsZC52YWwodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBiZSBzdXJlIHRvIGNhbGwgaW50byBiYXNlIG1ldGhvZAogICAgICAgICAgICB0aGlzLmJhc2UodmFsdWUpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldFRpdGxlCiAgICAgICAgICovCiAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIkhpZGRlbiI7CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJGaWVsZCBmb3IgYSBoaWRkZW4gSFRNTCBpbnB1dCI7CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNnZXRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0VHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAic3RyaW5nIjsKICAgICAgICB9LAoJCQogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiaGlkZGVuIjsKICAgICAgICB9Ly9fX0VORF9PRl9CVUlMREVSX0hFTFBFUlMKICAgICAgICAKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3RlclRlbXBsYXRlKCJjb250cm9sRmllbGRIaWRkZW4iLCAnPGlucHV0IHR5cGU9ImhpZGRlbiIgaWQ9IiR7aWR9IiB7e2lmIG5hbWV9fW5hbWU9IiR7bmFtZX0ie3svaWZ9fSB7e2VhY2goaSx2KSBvcHRpb25zLmRhdGF9fWRhdGEtJHtpfT0iJHt2fSJ7ey9lYWNofX0vPicpOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiaGlkZGVuIiwgQWxwYWNhLkZpZWxkcy5IaWRkZW5GaWVsZCk7Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKCXZhciBBbHBhY2EgPSAkLmFscGFjYTsKCglBbHBhY2EucmVnaXN0ZXJWaWV3ICh7CgkJImlkIjogIlZJRVdfQkFTRSIsCgkJIm1lc3NhZ2VzIjogewoJCQkiemhfQ04iOiB7CgkJCQlyZXF1aXJlZDogIiYjMjc0OTI7JiMyMjQ5NTsmIzI0NTE3OyYjMzkwMzU7IiwKCQkJCWludmFsaWQ6ICImIzI3NDkyOyYjMjI0OTU7JiMxOTk4MTsmIzIxNTEyOyYjMjY2ODQ7IiwKCQkJCW1vbnRoczogWyImIzE5OTY4OyYjMjYzNzY7IiwgIiYjMjAxMDg7JiMyNjM3NjsiLCAiJiMxOTk3NzsmIzI2Mzc2OyIsICImIzIyMjM1OyYjMjYzNzY7IiwgIiYjMjAxMTY7JiMyNjM3NjsiLCAiJiMyMDg0NTsmIzI2Mzc2OyIsICImIzE5OTcxOyYjMjYzNzY7IiwgIiYjMjA4NDM7JiMyNjM3NjsiLCAiJiMyMDA2MTsmIzI2Mzc2OyIsICImIzIxMzEzOyYjMjYzNzY7IiwgIiYjMjEzMTM7JiMxOTk2ODsmIzI2Mzc2OyIsICImIzIxMzEzOyYjMjAxMDg7JiMyNjM3NjsiXSwKCQkJCXRpbWVVbml0czogewoJCQkJCVNFQ09ORDogIiYjMzExODY7IiwKCQkJCQlNSU5VVEU6ICImIzIwOTk4OyIsCgkJCQkJSE9VUjogIiYjMjYxMDI7IiwKCQkJCQlEQVk6ICImIzI2MDg1OyIsCgkJCQkJTU9OVEg6ICImIzI2Mzc2OyIsCgkJCQkJWUVBUjogIiYjMjQxODA7IgoJCQkJfSwKCQkJCSJub3RPcHRpb25hbCI6ICImIzI3NDkyOyYjMjI0OTU7JiMzODc1MDsmIzIwMjE5OyYjMzY4NzM7IiwKCQkJCSJkaXNhbGxvd1ZhbHVlIjogIiYjMzg3NTA7JiMyNzg2MTsmIzM2NzU1OyYjMjA4Mzc7JiMyMTI1MzsmIzI1MzI0OyB7MH0uIiwKCQkJCSJpbnZhbGlkVmFsdWVPZkVudW0iOiAiJiMyMDgwMTsmIzM1NzY4OyYjMzY3NTU7JiMyMDgzNzsmIzIxMjUzOyYjMjUzMjQ7IHswfS4iLAoJCQkJIm5vdEVub3VnaEl0ZW1zIjogIiYjMjYzNjg7JiMyMzU2NzsmIzIwMDEwOyYjMjU5Njg7IHswfSIsCgkJCQkidG9vTWFueUl0ZW1zIjogIiYjMjYzNjg7JiMyMjgyMzsmIzIwMDEwOyYjMjU5Njg7IHswfSIsCgkJCQkidmFsdWVOb3RVbmlxdWUiOiAiJiMzNjc1NTsmIzIwODM3OyYjMjA1NDA7JiMxOTk4MTsmIzI5NDIwOyYjMjkzMDU7IiwKCQkJCSJub3RBbkFycmF5IjogIiYjMTk5ODE7JiMyNjE1OTsmIzI1OTY4OyYjMzI0NTI7IiwKCQkJCSJpbnZhbGlkRGF0ZSI6ICImIzI2MDg1OyYjMjYzOTk7JiMyNjY4NDsmIzI0MzM1OyYjMjIyNDA7JiMzNTgxMzsmIzI2MTU5OyB7MH0iLAoJCQkJImludmFsaWRFbWFpbCI6ICImIzIwMjM0OyYjMjI5Njk7JiMyMDc5OTsmIzI2Njg0OyYjMjQzMzU7JiMxOTk4MTsmIzIzNTQ1OywgZXg6IGluZm9AY2xvdWRjbXMuY29tIiwKCQkJCSJzdHJpbmdOb3RBbkludGVnZXIiOiAiJiMxOTk4MTsmIzI2MTU5OyYjMjU5NzI7JiMyNTk2ODsuIiwKCQkJCSJpbnZhbGlkSVB2NCI6ICImIzE5OTgxOyYjMjYxNTk7JiMyMTUxMjsmIzI3ODYxO0lQJiMyMjMyMDsmIzIyMzM2OywgZXg6IDE5Mi4xNjguMC4xIiwKCQkJCSJzdHJpbmdWYWx1ZVRvb1NtYWxsIjogIiYjMjYzNjg7JiMyMzU2NzsmIzIwNTQwOyYjMjYxNTk7IHswfSIsCgkJCQkic3RyaW5nVmFsdWVUb29MYXJnZSI6ICImIzI2MzY4OyYjMjI4MjM7JiMyMDU0MDsmIzI2MTU5OyB7MH0iLAoJCQkJInN0cmluZ1ZhbHVlVG9vU21hbGxFeGNsdXNpdmUiOiAiJiMyMDU0MDsmIzI0NTE3OyYjMzkwMzU7JiMyMjgyMzsmIzIwMTEwOyB7MH0iLAoJCQkJInN0cmluZ1ZhbHVlVG9vTGFyZ2VFeGNsdXNpdmUiOiAiJiMyMDU0MDsmIzI0NTE3OyYjMzkwMzU7JiMyMzU2NzsmIzIwMTEwOyB7MH0iLAoJCQkJInN0cmluZ0RpdmlzaWJsZUJ5IjogIiYjMjA1NDA7JiMyNDUxNzsmIzM5MDM1OyYjMzMwMjE7JiMzNDk4NzsgezB9ICYjMjU5NzI7JiMzODUwMDsiLAoJCQkJInN0cmluZ05vdEFOdW1iZXIiOiAiJiMxOTk4MTsmIzI2MTU5OyYjMjU5Njg7JiMyMzM4MzsuIiwKCQkJCSJpbnZhbGlkUGFzc3dvcmQiOiAiJiMzODc1MDsmIzI3ODYxOyYjMjM0OTQ7JiMzMDcyMTsiLAoJCQkJImludmFsaWRQaG9uZSI6ICImIzM4NzUwOyYjMjc4NjE7JiMzMDAwNTsmIzM1ODA1OyYjMjE0OTU7JiMzMDcyMTssIGV4OiAoMTIzKSA0NTYtOTk5OSIsCgkJCQkiaW52YWxpZFBhdHRlcm4iOiAiJiMyNzQ5MjsmIzIyNDk1OyYjMzkwMzU7JiMyNjM3NzsmIzI2Njg0OyYjMjQzMzU7IHswfSIsCgkJCQkic3RyaW5nVG9vU2hvcnQiOiAiJiMyNzQ5MjsmIzIyNDk1OyYjMzMyNjc7JiMyMzU2OTsmIzM4MjcxOyYjMjQyMzA7IHswfSIsCgkJCQkic3RyaW5nVG9vTG9uZyI6ICImIzI3NDkyOyYjMjI0OTU7JiMyNjM2ODsmIzIyODEwOyYjMzgyNzE7JiMyNDIzMDsgezB9IgoJCQkKCQkJfQogICAgICAgIH0KICAgIH0pOwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCgl2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgoJQWxwYWNhLnJlZ2lzdGVyVmlldyAoewoJCSJpZCI6ICJWSUVXX0JBU0UiLAoJCSJtZXNzYWdlcyI6IHsKCQkJImVzX0VTIjogewoJCQkJcmVxdWlyZWQ6ICJFc3RlIGNhbXBvIGVzIG9ibGlnYXRvcmlvIiwKCQkJCWludmFsaWQ6ICJFc3RlIGNhbXBvIGVzIGludsOhbGlkbyIsCgkJCQltb250aHM6IFsiRW5lcm8iLCAiRmVicmVybyIsICJNYXJ6byIsICJBYnJpbCIsICJNYXlvIiwgIkp1bmlvIiwgIkp1bGlvIiwgIkFnb3N0byIsICJTZXB0aWVtYnJlIiwgIk9jdHVicmUiLCAiTm92aWVtYnJlIiwgIkRpY2llbWJyZSJdLAoJCQkJdGltZVVuaXRzOiB7CgkJCQkJU0VDT05EOiAic2VndW5kb3MiLAoJCQkJCU1JTlVURTogIm1pbnV0b3MiLAoJCQkJCUhPVVI6ICJob3JhcyIsCgkJCQkJREFZOiAiZMOtYXMiLAoJCQkJCU1PTlRIOiAibWVzZXMiLAoJCQkJCVlFQVI6ICJhw7FvcyIKCQkJCX0sCgkJCQkibm90T3B0aW9uYWwiOiAiRXN0ZSBjYW1wbyBubyBlcyBvcGNpb25hbC4iLAoJCQkJImRpc2FsbG93VmFsdWUiOiAiezB9IHNvbiBsb3MgdmFsb3JlcyByZWNoYXphZG9zLiIsCgkJCQkiaW52YWxpZFZhbHVlT2ZFbnVtIjogIkVzdGUgY2FtcG8gZGViZSB0ZW5lciB1bm8gZGUgbG9zIHZhbG9yZXMgYWRlbnRybyB7MH0uIiwKCQkJCSJub3RFbm91Z2hJdGVtcyI6ICJFbCBuw7ptZXJvIG3DrW5pbW8gZGUgYXJ0w61jdWxvcyBlcyB7MH0iLAoJCQkJInRvb01hbnlJdGVtcyI6ICJFbCBuw7ptZXJvIG3DoXhpbW8gZGUgYXJ0w61jdWxvcyBlcyB7MH0iLAoJCQkJInZhbHVlTm90VW5pcXVlIjogIkxvcyB2YWxvcmVzIG5vIHNvbiDDum5pY29zIiwKCQkJCSJub3RBbkFycmF5IjogIkVzdGUgdmFsb3Igbm8gZXMgdW4gYXJzZW5hbCIsCgkJCQkiaW52YWxpZERhdGUiOiAiRmVjaGEgaW52w6FsaWRhIHBhcmEgZWwgZm9ybWF0byB7MH0iLAoJCQkJImludmFsaWRFbWFpbCI6ICJFbWFpbCBhZGRyZXNzIGludsOhbGlkbywgZXg6IGluZm9AY2xvdWRjbXMuY29tIiwKCQkJCSJzdHJpbmdOb3RBbkludGVnZXIiOiAiRXN0ZSB2YWxvciBubyBlcyB1biBuw7ptZXJvIGVudGVyby4iLAoJCQkJImludmFsaWRJUHY0IjogIkRpcmVjY2nDs24gaW52w6FsaWRhIElQdjQsIGV4OiAxOTIuMTY4LjAuMSIsCgkJCQkic3RyaW5nVmFsdWVUb29TbWFsbCI6ICJFbCB2YWxvciBtw61uaW1vIHBhcmEgZXN0ZSBjYW1wbyBlcyB7MH0iLAoJCQkJInN0cmluZ1ZhbHVlVG9vTGFyZ2UiOiAiRWwgdmFsb3IgbcOteGltbyBwYXJhIGVzdGUgY2FtcG8gZXMgezB9IiwKCQkJCSJzdHJpbmdWYWx1ZVRvb1NtYWxsRXhjbHVzaXZlIjogIkVsIHZhbG9yIGRlIGVzdGUgY2FtcG8gZGViZSBzZXIgbWF5b3IgcXVlIHswfSIsCgkJCQkic3RyaW5nVmFsdWVUb29MYXJnZUV4Y2x1c2l2ZSI6ICJFbCB2YWxvciBkZSBlc3RlIGNhbXBvIGRlYmUgc2VyIG1lbm9zIHF1ZSB7MH0iLAoJCQkJInN0cmluZ0RpdmlzaWJsZUJ5IjogIkVsIHZhbG9yIGRlYmUgc2VyIGRpdmlzaWJsZSBjZXJjYSB7MH0iLAoJCQkJInN0cmluZ05vdEFOdW1iZXIiOiAiRXN0ZSB2YWxvciBubyBlcyB1biBuw7ptZXJvLiIsCgkJCQkiaW52YWxpZFBhc3N3b3JkIjogIkNvbnRyYXNlw7FhIGludsOhbGlkYSIsCgkJCQkiaW52YWxpZFBob25lIjogIk7Dum1lcm8gZGUgdGVsw6lmb25vIGludsOhbGlkbywgZXg6ICgxMjMpIDQ1Ni05OTk5IiwKCQkJCSJpbnZhbGlkUGF0dGVybiI6ICJFc3RlIGNhbXBvIGRlYmUgdGVuZXIgcGF0csOzbiB7MH0iLAoJCQkJInN0cmluZ1Rvb1Nob3J0IjogIkVzdGUgY2FtcG8gZGViZSBjb250ZW5lciBwb3IgbG8gbWVub3MgezB9IG7Dum1lcm9zIG8gY2FyYWN0ZXJlcyIsCgkJCQkic3RyaW5nVG9vTG9uZyI6ICJFc3RlIGNhbXBvIGRlYmUgY29udGVuZXIgYSBsbyBtw6FzIHswfSBuw7ptZXJvcyBvIGNhcmFjdGVyZXMiCgkJCX0KICAgICAgICB9Cgl9KTsKCn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgoJdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKCUFscGFjYS5yZWdpc3RlclZpZXcgKHsKCQkiaWQiOiAiVklFV19CQVNFIiwKCQkibWVzc2FnZXMiOiB7CgkJCSJmcl9GUiI6IHsKCQkJCXJlcXVpcmVkOiAiQ2UgY2hhbXAgZXN0IHJlcXVpcyIsCgkJCQlpbnZhbGlkOiAiQ2UgY2hhbXAgZXN0IGludmFsaWRlIiwKCQkJCW1vbnRoczogWyJKYW52aWVyIiwgIkbDqXZyaWVyIiwgIk1hcnMiLCAiQXZyaWwiLCAiTWFpIiwgIkp1aW4iLCAiSnVpbGxldCIsICJBb8O7dCIsICJTZXB0ZW1icmUiLCAiT2N0b2JyZSIsICJOb3ZlbWJyZSIsICJEw6ljZW1icmUiXSwKCQkJCXRpbWVVbml0czogewoJCQkJCVNFQ09ORDogInNlY29uZGVzIiwKCQkJCQlNSU5VVEU6ICJtaW51dGVzIiwKCQkJCQlIT1VSOiAiaGV1cmVzIiwKCQkJCQlEQVk6ICJqb3VycyIsCgkJCQkJTU9OVEg6ICJtb2lzIiwKCQkJCQlZRUFSOiAiYW5uw6llcyIKCQkJCX0sCgkJCQkibm90T3B0aW9uYWwiOiAiQ2UgY2hhbXAgbidlc3QgcGFzIG9wdGlvbm5lbC4iLAoJCQkJImRpc2FsbG93VmFsdWUiOiAiezB9IHNvbnQgZGVzIHZhbGV1cnMgaW50ZXJkaXRlcy4iLAoJCQkJImludmFsaWRWYWx1ZU9mRW51bSI6ICJDZSBjaGFtcCBkb2l0IHByZW5kcmUgdW5lIGRlcyB2YWxldXJzIHN1aXZhbnRlcyA6IHswfS4iLAoJCQkJIm5vdEVub3VnaEl0ZW1zIjogIkxlIG5vbWJyZSBtaW5pbXVtIGQnw6lsw6ltZW50cyBlc3QgezB9IiwKCQkJCSJ0b29NYW55SXRlbXMiOiAiTGUgbm9tYnJlIG1heGltdW0gZCfDqWzDqW1lbnRzIGVzdCB7MH0iLAoJCQkJInZhbHVlTm90VW5pcXVlIjogIkxlcyB2YWxldXJzIHNvbnQgdW5pcXVlcyIsCgkJCQkibm90QW5BcnJheSI6ICJDZXR0ZSB2YWxldXIgbidlc3QgcGFzIHVuZSBsaXN0ZSIsCgkJCQkiaW52YWxpZERhdGUiOiAiQ2V0dGUgZGF0ZSBuZSBjb3JyZXNwb25kIHBhcyBhdSBmb3JtYXQgezB9IiwKCQkJCSJpbnZhbGlkRW1haWwiOiAiQWRyZXNzZSBkZSBjb3VycmllbCBpbnZhbGlkZSwgZXg6IGluZm9AY2xvdWRjbXMuY29tIiwKCQkJCSJzdHJpbmdOb3RBbkludGVnZXIiOiAiQ2V0dGUgdmFsZXVyIG4nZXN0IHBhcyB1biBub21icmUgZW50aWVyLiIsCgkJCQkiaW52YWxpZElQdjQiOiAiQWRyZXNzZSBJUHY0IGludmFsaWRlLCBleDogMTkyLjE2OC4wLjEiLAoJCQkJInN0cmluZ1ZhbHVlVG9vU21hbGwiOiAiTGEgdmFsZXVyIG1pbmltYWxlIHBvdXIgY2UgY2hhbXAgZXN0IHswfSIsCgkJCQkic3RyaW5nVmFsdWVUb29MYXJnZSI6ICJMYSB2YWxldXIgbWF4aW1hbGUgcG91ciBjZSBjaGFtcCBlc3QgezB9IiwKCQkJCSJzdHJpbmdWYWx1ZVRvb1NtYWxsRXhjbHVzaXZlIjogIkxhIHZhbGV1ciBkb2l0LcOqdHJlIHN1cMOpcmlldXJlIMOgIHswfSIsCgkJCQkic3RyaW5nVmFsdWVUb29MYXJnZUV4Y2x1c2l2ZSI6ICJMYSB2YWxldXIgZG9pdC3DqnRyZSBpbmbDqXJpZXVyZSDDoCB7MH0iLAoJCQkJInN0cmluZ0RpdmlzaWJsZUJ5IjogIkxhIHZhbGV1ciBkb2l0LcOqdHJlIGRpdmlzaWJsZSBwYXIgezB9IiwKCQkJCSJzdHJpbmdOb3RBTnVtYmVyIjogIkNldHRlIHZhbGV1ciBuJ2VzdCBwYXMgdW4gbm9tYnJlLiIsCgkJCQkiaW52YWxpZFBhc3N3b3JkIjogIk1vdCBkZSBwYXNzZSBpbnZhbGlkZSIsCgkJCQkiaW52YWxpZFBob25lIjogIk51bcOpcm8gZGUgdMOpbMOpcGhvbmUgaW52YWxpZGUsIGV4OiAoMTIzKSA0NTYtOTk5OSIsCgkJCQkiaW52YWxpZFBhdHRlcm4iOiAiQ2UgY2hhbXAgZG9pdCBjb3JyZXNwb25kcmUgYXUgbW90aWYgezB9IiwKICAgICAgICAgICAgICAgICJzdHJpbmdUb29TaG9ydCI6ICJDZSBjaGFtcCBkb2l0IGNvbnRlbmlyIGF1IG1vaW5zIHswfSBjYXJhY3TDqHJlcyIsCiAgICAgICAgICAgICAgICAic3RyaW5nVG9vTG9uZyI6ICJDZSBjaGFtcCBkb2l0IGNvbnRlbmlyIGF1IHBsdXMgezB9IGNhcmFjdMOocmVzIgogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKCXZhciBBbHBhY2EgPSAkLmFscGFjYTsKCglBbHBhY2EucmVnaXN0ZXJWaWV3ICh7CgkJImlkIjogIlZJRVdfQkFTRSIsCgkJIm1lc3NhZ2VzIjogewogICAgICAgICAgICAiZGVfQVQiOiB7CiAgICAgICAgICAgICAgICByZXF1aXJlZDogIkVpbmdhYmUgZXJmb3JkZXJsaWNoIiwKICAgICAgICAgICAgICAgIGludmFsaWQ6ICJFaW5nYWJlIGludmFsaWQiLAogICAgICAgICAgICAgICAgbW9udGhzOiBbIkrDpG5uZXIiLCAiRmVicnVhciIsICJNw6RyeiIsICJBcHJpbCIsICJNYWkiLCAiSnVuaSIsICJKdWxpIiwgIkF1Z3VzdCIsICJTZXB0ZW1iZXIiLCAiT2t0b2JlciIsICJOb3ZlbWJlciIsICJEZXplbWJlciJdLAogICAgICAgICAgICAgICAgdGltZVVuaXRzOiB7CiAgICAgICAgICAgICAgICAgICAgU0VDT05EOiAiU2VrdW5kZW4iLAogICAgICAgICAgICAgICAgICAgIE1JTlVURTogIk1pbnV0ZW4iLAogICAgICAgICAgICAgICAgICAgIEhPVVI6ICJTdHVuZGVuIiwKICAgICAgICAgICAgICAgICAgICBEQVk6ICJUYWdlIiwKICAgICAgICAgICAgICAgICAgICBNT05USDogIk1vbmF0ZSIsCiAgICAgICAgICAgICAgICAgICAgWUVBUjogIkphaHJlIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJub3RPcHRpb25hbCI6ICJEaWVzZXMgRmVsZCBpc3QgbmljaHQgb3B0aW9uYWwiLAogICAgICAgICAgICAgICAgImRpc2FsbG93VmFsdWUiOiAiRGllc2UgV2VydGUgc2luZCBuaWNodCBlcmxhdWJ0OiB7MH0iLAogICAgICAgICAgICAgICAgImludmFsaWRWYWx1ZU9mRW51bSI6ICJEaWVzZSBGZWxkIHNvbGx0ZSBlaW5lbiBkZXIgZm9sZ2VuZGVuIFdlcnRlIGVudGhhbHRlbjogezB9IiwKICAgICAgICAgICAgICAgICJub3RFbm91Z2hJdGVtcyI6ICJEaWUgTWluZGVzdGFuemFobCB2b24gRWxlbWVudGVuIGlzdCB7MH0iLAogICAgICAgICAgICAgICAgInRvb01hbnlJdGVtcyI6ICJEaWUgTWF4aW1hbGFuemFobCB2b24gRWxlbWVudGVuIGlzdCB7MH0iLAogICAgICAgICAgICAgICAgInZhbHVlTm90VW5pcXVlIjogIkRpZXNlIFdlcnRlIHNpbmQgbmljaHQgZWluZGV1dGlnIiwKICAgICAgICAgICAgICAgICJub3RBbkFycmF5IjogIktlaW5lIExpc3RlIHZvbiBXZXJ0ZW4iLAogICAgICAgICAgICAgICAgImludmFsaWREYXRlIjogIkZhbHNjaGVzIERhdHVtc2Zvcm1hdDogezB9IiwKICAgICAgICAgICAgICAgICJpbnZhbGlkRW1haWwiOiAiVW5nw7xsdGlnZSBlLU1haWwgQWRyZXNzZSwgei5CLjogaW5mb0BjbG91ZGNtcy5jb20iLAogICAgICAgICAgICAgICAgInN0cmluZ05vdEFuSW50ZWdlciI6ICJFaW5nYWJlIGlzdCBrZWluZSBHYW56IFphaGwuIiwKICAgICAgICAgICAgICAgICJpbnZhbGlkSVB2NCI6ICJVbmfDvGx0aWdlIElQdjQgQWRyZXNzZSwgei5CLjogMTkyLjE2OC4wLjEiLAogICAgICAgICAgICAgICAgInN0cmluZ1ZhbHVlVG9vU21hbGwiOiAiRGllIE1pbmRlc3RhbnphaGwgdm9uIFplaWNoZW4gaXN0IHswfSIsCiAgICAgICAgICAgICAgICAic3RyaW5nVmFsdWVUb29MYXJnZSI6ICJEaWUgTWF4aW1hbGFuemFobCB2b24gWmVpY2hlbiBpc3QgezB9IiwKICAgICAgICAgICAgICAgICJzdHJpbmdWYWx1ZVRvb1NtYWxsRXhjbHVzaXZlIjogIkRpZSBBbnphaGwgZGVyIFplaWNoZW4gbXVzcyBncsO2w59lciBzZWluIGFscyB7MH0iLAogICAgICAgICAgICAgICAgInN0cmluZ1ZhbHVlVG9vTGFyZ2VFeGNsdXNpdmUiOiAiRGllIEFuemFobCBkZXIgWmVpY2hlbiBtdXNzIGtsZWluZXIgc2VpbiBhbHMgezB9IiwKICAgICAgICAgICAgICAgICJzdHJpbmdEaXZpc2libGVCeSI6ICJEZXIgV2VydCBtdXNzIGR1cmNoIHswfSBkaXZpZGllcmJhciBzZWluIiwKICAgICAgICAgICAgICAgICJzdHJpbmdOb3RBTnVtYmVyIjogIkRpZSBFaW5nYWJlIGlzdCBrZWluZSBaYWhsIiwKICAgICAgICAgICAgICAgICJpbnZhbGlkUGFzc3dvcmQiOiAiVW5nw7xsdGlnZXMgUGFzc3dvcnQuIiwKICAgICAgICAgICAgICAgICJpbnZhbGlkUGhvbmUiOiAiVW5nw7xsdGlnZSBUZWxlZm9ubnVtbWVyLCB6LkIuOiAoMTIzKSA0NTYtOTk5OSIsCiAgICAgICAgICAgICAgICAiaW52YWxpZFBhdHRlcm4iOiAiRGllc2UgRmVsZCBzdGltbXQgbmljaHQgbWl0IGZvbGdlbmRlciBWb3JnYWJlIMO8YmVyZWluIHswfSIsCiAgICAgICAgICAgICAgICAic3RyaW5nVG9vU2hvcnQiOiAiRGllc2VzIEZlbGQgc29sbHRlIG1pbmRlc3RlbnMgezB9IFplaWNoZW4gZW50aGFsdGVuIiwKICAgICAgICAgICAgICAgICJzdHJpbmdUb29Mb25nIjogIkRpZXNlcyBGZWxkIHNvbGx0ZSBow7ZjaHN0ZW5zIHswfSBaZWljaGVuIGVudGhhbHRlbiIKICAgICAgICAgICAgfQoJCX0KCX0pOwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCgl2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgoJQWxwYWNhLnJlZ2lzdGVyVmlldyAoewoJCSJpZCI6ICJWSUVXX0JBU0UiLAoJCSJtZXNzYWdlcyI6IHsKICAgICAgICAgICAgInBsX1BMIjogewogICAgICAgICAgICAgICAgcmVxdWlyZWQ6ICJUbyBwb2xlIGplc3Qgd3ltYWdhbmUiLAogICAgICAgICAgICAgICAgaW52YWxpZDogIlRvIHBvbGUgamVzdCBuaWVwcmF3aWTFgm93ZSIsCiAgICAgICAgICAgICAgICBtb250aHM6IFsiU3R5Y3plxYQiLCAiTHV0eSIsICJNYXJ6ZWMiLCAiS3dpZWNpZcWEIiwgIk1haiIsICJDemVyd2llYyIsICJMaXBpZWMiLCAiU2llcnBpZcWEIiwgIldyemVzaWXFhCIsICJQYcW6ZHppZXJuaWsiLCAiTGlzdG9wYWQiLCAiR3J1ZHppZcWEIl0sCiAgICAgICAgICAgICAgICB0aW1lVW5pdHM6IHsKICAgICAgICAgICAgICAgICAgICBTRUNPTkQ6ICJzZWt1bmR5IiwKICAgICAgICAgICAgICAgICAgICBNSU5VVEU6ICJtaW51dHkiLAogICAgICAgICAgICAgICAgICAgIEhPVVI6ICJnb2R6aW55IiwKICAgICAgICAgICAgICAgICAgICBEQVk6ICJkbmkiLAogICAgICAgICAgICAgICAgICAgIE1PTlRIOiAibWllc2nEhWNlIiwKICAgICAgICAgICAgICAgICAgICBZRUFSOiAibGF0YSIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAibm90T3B0aW9uYWwiOiAiVG8gcG9sZSBuaWUgamVzdCBvcGNqb25hbG5lIiwKICAgICAgICAgICAgICAgICJkaXNhbGxvd1ZhbHVlIjogIlRhIHdhcnRvxZvEhyBuaWUgamVzdCBkb3p3b2xvbmE6IHswfSIsCiAgICAgICAgICAgICAgICAiaW52YWxpZFZhbHVlT2ZFbnVtIjogIlRvIHBvbGUgcG93aW5ubyB6YXdpZXJhxIcgamVkbsSFIHogbmFzdMSZcHVqxIVjeWNoIHdhcnRvxZtjaTogezB9IiwKICAgICAgICAgICAgICAgICJub3RFbm91Z2hJdGVtcyI6ICJNaW5pbWFsbmEgbGljemJhIGVsZW1lbnTDs3cgd3lub3NpIHswfSIsCiAgICAgICAgICAgICAgICAidG9vTWFueUl0ZW1zIjogIk1ha3N5bWFsbmEgbGljemJhIGVsZW1lbnTDs3cgd3lub3NpIHswfSIsCiAgICAgICAgICAgICAgICAidmFsdWVOb3RVbmlxdWUiOiAiVGUgd2FydG/Fm2NpIG5pZSBzxIUgdW5pa2FsbmUiLAogICAgICAgICAgICAgICAgIm5vdEFuQXJyYXkiOiAiVGEgd2FydG/Fm8SHIG5pZSBqZXN0IHRhYmxpY8SFIiwKICAgICAgICAgICAgICAgICJpbnZhbGlkRGF0ZSI6ICJOaWVwb3ByYXdueSBmb3JtYXQgZGF0eTogezB9IiwKICAgICAgICAgICAgICAgICJpbnZhbGlkRW1haWwiOiAiTmllcG9wcmF3bnkgYWRyZXMgZW1haWwsIG4ucC46IGluZm9AY2xvdWRjbXMuY29tIiwKICAgICAgICAgICAgICAgICJzdHJpbmdOb3RBbkludGVnZXIiOiAiVGEgd2FydG/Fm8SHIG5pZSBqZXN0IGxpY3pixIUgY2HFgmtvd2l0xIUiLAogICAgICAgICAgICAgICAgImludmFsaWRJUHY0IjogIk5pZXBvcHJhd255IGFkcmVzIElQdjQsIG4ucC46IDE5Mi4xNjguMC4xIiwKICAgICAgICAgICAgICAgICJzdHJpbmdWYWx1ZVRvb1NtYWxsIjogIk1pbmltYWxuYSB3YXJ0b8WbxIcgZGxhIHRlZ28gcG9sYSB3eW5vc2kgezB9IiwKICAgICAgICAgICAgICAgICJzdHJpbmdWYWx1ZVRvb0xhcmdlIjogIk1ha3N5bWFsbmEgd2FydG/Fm8SHIGRsYSB0ZWdvIHBvbGEgd3lub3NpIHswfSIsCiAgICAgICAgICAgICAgICAic3RyaW5nVmFsdWVUb29TbWFsbEV4Y2x1c2l2ZSI6ICJXYXJ0b8WbxIcgZGxhIHRlZ28gcG9sYSBtdXNpIGJ5xIcgd2nEmWtzemEgbmnFvCB7MH0iLAogICAgICAgICAgICAgICAgInN0cmluZ1ZhbHVlVG9vTGFyZ2VFeGNsdXNpdmUiOiAiV2FydG/Fm8SHIGRsYSB0ZWdvIHBvbGEgbXVzaSBiecSHIG1uaWVqc3phIG5pxbwgezB9IiwKICAgICAgICAgICAgICAgICJzdHJpbmdEaXZpc2libGVCeSI6ICJXYXJ0b8WbxIcgbXVzaSBiecSHIHBvZHppZWxuYSBwcnpleiB7MH0iLAogICAgICAgICAgICAgICAgInN0cmluZ05vdEFOdW1iZXIiOiAiV2FydG/Fm8SHIG5pZSBqZXN0IGxpY3pixIUiLAogICAgICAgICAgICAgICAgImludmFsaWRQYXNzd29yZCI6ICJOaWVwb3ByYXduZSBoYXPFgm8iLAogICAgICAgICAgICAgICAgImludmFsaWRQaG9uZSI6ICJOaWVwb3ByYXdueSBudW1lciB0ZWxlZm9udSwgbi5wLjogKDEyMykgNDU2LTk5OTkiLAogICAgICAgICAgICAgICAgImludmFsaWRQYXR0ZXJuIjogIlRvIHBvbGUgcG93aW5ubyBtaWXEhyBmb3JtYXQgezB9IiwKICAgICAgICAgICAgICAgICJzdHJpbmdUb29TaG9ydCI6ICJUbyBwb2xlIHBvd2lubm8gemF3aWVyYcSHIGNvIG5ham1uaWVqIHswfSB6bmFrw7N3IiwKICAgICAgICAgICAgICAgICJzdHJpbmdUb29Mb25nIjogIlRvIHBvbGUgcG93aW5ubyB6YXdpZXJhxIcgbmFqd3nFvGVqIHswfSB6bmFrw7N3IgogICAgICAgICAgICB9CgkJfQoJfSk7Cgp9KShqUXVlcnkpOy8qIQpBbHBhY2EgVmVyc2lvbiAxLjEuMwoKQ29weXJpZ2h0IDIwMTQgR2l0YW5hIFNvZnR3YXJlLCBJbmMuCgpMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsgCnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gCgpZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQgCglodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAgCgpVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlIApkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLCAKV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuIApTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIApsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gCgpGb3IgbW9yZSBpbmZvcm1hdGlvbiwgcGxlYXNlIGNvbnRhY3QgR2l0YW5hIFNvZnR3YXJlLCBJbmMuIGF0IHRoaXMKYWRkcmVzczoKCiAgaW5mb0BnaXRhbmFzb2Z0d2FyZS5jb20KKi8KKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5BZGRyZXNzRmllbGQgPSBBbHBhY2EuRmllbGRzLk9iamVjdEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuQWRkcmVzc0ZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkZpZWxkcy5PYmplY3RGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIEEgY29tYm8gZmllbGQgZm9yIHJlbmRlcmluZyBhIHN0YW5kYXJkIFVTIGFkZHJlc3MuIEl0IGFsc28gY29tZXMgdXAgd2l0aCBzdXBwb3J0IGZvciBHb29nbGUgTWFwCiAgICAgICAgICogd2hpY2ggd291bGQgcmVxdWlyZXMgaW5jbHVkaW5nIEdvb2dsZSBNYXAgSlMgZmlsZSBmb3IgdGhlIGZvcm0gdGhhdCB1c2VzIHRoaXMgY2xhc3MuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvcixlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5PYmplY3RGaWVsZCNzZXR1cAogICAgICAgICAqLwogICAgICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CgogICAgICAgICAgICB0aGlzLnNjaGVtYSA9IHsKICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJIb21lIEFkZHJlc3MiLAogICAgICAgICAgICAgICAgInR5cGUiOiAib2JqZWN0IiwKICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICJzdHJlZXQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJTdHJlZXQiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJhcnJheSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJpdGVtcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWF4TGVuZ3RoIjogMzAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWluSXRlbXMiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1heEl0ZW1zIjogMwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiY2l0eSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkNpdHkiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAic3RhdGUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJTdGF0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJlbnVtIjogWyJBTCIsICJBSyIsICJBUyIsICJBWiIsICJBUiIsICJDQSIsICJDTyIsICJDVCIsICJERSIsICJEQyIsICJGTSIsICJGTCIsICJHQSIsICJHVSIsICJISSIsICJJRCIsICJJTCIsICJJTiIsICJJQSIsICJLUyIsICJLWSIsICJMQSIsICJNRSIsICJNSCIsICJNRCIsICJNQSIsICJNSSIsICJNTiIsICJNUyIsICJNTyIsICJNVCIsICJORSIsICJOViIsICJOSCIsICJOSiIsICJOTSIsICJOWSIsICJOQyIsICJORCIsICJNUCIsICJPSCIsICJPSyIsICJPUiIsICJQVyIsICJQQSIsICJQUiIsICJSSSIsICJTQyIsICJTRCIsICJUTiIsICJUWCIsICJVVCIsICJWVCIsICJWSSIsICJWQSIsICJXQSIsICJXViIsICJXSSIsICJXWSJdCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiemlwIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiWmlwIENvZGUiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciLAogICAgICAgICAgICAgICAgICAgICAgICAicGF0dGVybiI6IC9eKFxkezV9KC1cZHs0fSk/KT8kLwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgQWxwYWNhLm1lcmdlKHRoaXMub3B0aW9ucywgewogICAgICAgICAgICAgICAgImZpZWxkcyI6IHsKICAgICAgICAgICAgICAgICAgICAiemlwIjogewogICAgICAgICAgICAgICAgICAgICAgICAibWFza1N0cmluZyI6ICI5OTk5OSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJzaXplIjogNQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInN0YXRlIjogewogICAgICAgICAgICAgICAgICAgICAgICAib3B0aW9uTGFiZWxzIjogWyJBTEFCQU1BIiwgIkFMQVNLQSIsICJBTUVSSUNBTlNBTU9BIiwgIkFSSVpPTkEiLCAiQVJLQU5TQVMiLCAiQ0FMSUZPUk5JQSIsICJDT0xPUkFETyIsICJDT05ORUNUSUNVVCIsICJERUxBV0FSRSIsICJESVNUUklDVE9GQ09MVU1CSUEiLCAiRkVERVJBVEVEU1RBVEVTT0ZNSUNST05FU0lBIiwgIkZMT1JJREEiLCAiR0VPUkdJQSIsICJHVUFNIiwgIkhBV0FJSSIsICJJREFITyIsICJJTExJTk9JUyIsICJJTkRJQU5BIiwgIklPV0EiLCAiS0FOU0FTIiwgIktFTlRVQ0tZIiwgIkxPVUlTSUFOQSIsICJNQUlORSIsICJNQVJTSEFMTElTTEFORFMiLCAiTUFSWUxBTkQiLCAiTUFTU0FDSFVTRVRUUyIsICJNSUNISUdBTiIsICJNSU5ORVNPVEEiLCAiTUlTU0lTU0lQUEkiLCAiTUlTU09VUkkiLCAiTU9OVEFOQSIsICJORUJSQVNLQSIsICJORVZBREEiLCAiTkVXSEFNUFNISVJFIiwgIk5FV0pFUlNFWSIsICJORVdNRVhJQ08iLCAiTkVXWU9SSyIsICJOT1JUSENBUk9MSU5BIiwgIk5PUlRIREFLT1RBIiwgIk5PUlRIRVJOTUFSSUFOQUlTTEFORFMiLCAiT0hJTyIsICJPS0xBSE9NQSIsICJPUkVHT04iLCAiUEFMQVUiLCAiUEVOTlNZTFZBTklBIiwgIlBVRVJUT1JJQ08iLCAiUkhPREVJU0xBTkQiLCAiU09VVEhDQVJPTElOQSIsICJTT1VUSERBS09UQSIsICJURU5ORVNTRUUiLCAiVEVYQVMiLCAiVVRBSCIsICJWRVJNT05UIiwgIlZJUkdJTklTTEFORFMiLCAiVklSR0lOSUEiLCAiV0FTSElOR1RPTiIsICJXRVNUVklSR0lOSUEiLCAiV0lTQ09OU0lOIiwgIldZT01JTkciXQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAoQWxwYWNhLmlzRW1wdHkodGhpcy5vcHRpb25zLmFkZHJlc3NWYWxpZGF0aW9uKSkgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmFkZHJlc3NWYWxpZGF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgYWRkcmVzcyBpbiBhIHNpbmdsZSBsaW5lIHN0cmluZy4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IEFkZHJlc3MgYXMgYSBzaW5nbGUgbGluZSBzdHJpbmcuCiAgICAgICAgICovCiAgICAgICAgZ2V0QWRkcmVzczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHRoaXMuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgaWYgKHRoaXMudmlldy50eXBlID09ICJ2aWV3IikgewogICAgICAgICAgICAgICAgdmFsdWUgPSB0aGlzLmRhdGE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFkZHJlc3MgPSAiIjsKICAgICAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUuc3RyZWV0KSB7CiAgICAgICAgICAgICAgICAgICAgJC5lYWNoKHZhbHVlLnN0cmVldCwgZnVuY3Rpb24oaW5kZXgsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZHJlc3MgKz0gdmFsdWUgKyAiICI7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodmFsdWUuY2l0eSkgewogICAgICAgICAgICAgICAgICAgIGFkZHJlc3MgKz0gdmFsdWUuY2l0eSArICIgIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh2YWx1ZS5zdGF0ZSkgewogICAgICAgICAgICAgICAgICAgIGFkZHJlc3MgKz0gdmFsdWUuc3RhdGUgKyAiICI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodmFsdWUuemlwKSB7CiAgICAgICAgICAgICAgICAgICAgYWRkcmVzcyArPSB2YWx1ZS56aXA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFkZHJlc3M7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjcmVuZGVyRmllbGQKICAgICAgICAgKi8KICAgICAgICByZW5kZXJGaWVsZDogZnVuY3Rpb24ob25TdWNjZXNzKSB7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgLy8gYXBwbHkgYWRkaXRpb25hbCBjc3MKICAgICAgICAgICAgICAgICQoc2VsZi5maWVsZENvbnRhaW5lcikuYWRkQ2xhc3MoImFscGFjYS1hZGRyZXNzZmllbGQiKTsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLmFkZHJlc3NWYWxpZGF0aW9uICYmICFzZWxmLmlzRGlzcGxheU9ubHkoKSkgewogICAgICAgICAgICAgICAgICAgICQoJzxkaXYgc3R5bGU9ImNsZWFyOmJvdGg7Ij48L2Rpdj4nKS5hcHBlbmRUbyhzZWxmLmZpZWxkQ29udGFpbmVyKTsKICAgICAgICAgICAgICAgICAgICB2YXIgbWFwQnV0dG9uID0gJCgnPGRpdiBjbGFzcz0iYWxwYWNhLWZvcm0tYnV0dG9uIj5Hb29nbGUgTWFwPC9kaXY+JykuYXBwZW5kVG8oc2VsZi5maWVsZENvbnRhaW5lcik7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hcEJ1dHRvbi5idXR0b24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWFwQnV0dG9uLmJ1dHRvbih7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiB0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBtYXBCdXR0b24uY2xpY2soCiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdvb2dsZSAmJiBnb29nbGUubWFwcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBnZW9jb2RlciA9IG5ldyBnb29nbGUubWFwcy5HZW9jb2RlcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhZGRyZXNzID0gc2VsZi5nZXRBZGRyZXNzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdlb2NvZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdlb2NvZGVyLmdlb2NvZGUoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2FkZHJlc3MnOiBhZGRyZXNzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKHJlc3VsdHMsIHN0YXR1cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXR1cyA9PSBnb29nbGUubWFwcy5HZW9jb2RlclN0YXR1cy5PSykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtYXBDYW52YXNJZCA9IHNlbGYuZ2V0SWQoKSArICItbWFwLWNhbnZhcyI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQoJyMnICsgbWFwQ2FudmFzSWQpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCI8ZGl2IGlkPSciICsgbWFwQ2FudmFzSWQgKyAiJyBjbGFzcz0nYWxwYWNhLWNvbnRyb2xmaWVsZC1hZGRyZXNzLW1hcGNhbnZhcyc+PC9kaXY+IikuYXBwZW5kVG8oc2VsZi5maWVsZENvbnRhaW5lcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtYXAgPSBuZXcgZ29vZ2xlLm1hcHMuTWFwKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHNlbGYuZ2V0SWQoKSArICItbWFwLWNhbnZhcyIpLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ6b29tIjogMTAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjZW50ZXIiOiByZXN1bHRzWzBdLmdlb21ldHJ5LmxvY2F0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWFwVHlwZUlkIjogZ29vZ2xlLm1hcHMuTWFwVHlwZUlkLlJPQURNQVAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbWFya2VyID0gbmV3IGdvb2dsZS5tYXBzLk1hcmtlcih7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcDogbWFwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogcmVzdWx0c1swXS5nZW9tZXRyeS5sb2NhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRpc3BsYXlNZXNzYWdlKCJHZW9jb2RpbmcgZmFpbGVkOiAiICsgc3RhdHVzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRpc3BsYXlNZXNzYWdlKCJHb29nbGUgTWFwIEFQSSBpcyBub3QgaW5zdGFsbGVkLiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KS53cmFwKCc8c21hbGwvPicpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLnNob3dNYXBPbkxvYWQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBtYXBCdXR0b24uY2xpY2soKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG9uU3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgIG9uU3VjY2VzcygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI2lzQ29udGFpbmVyCiAgICAgICAgICovCiAgICAgICAgaXNDb250YWluZXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuT2JqZWN0RmllbGQjZ2V0U2NoZW1hT2ZPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgInZhbGlkYXRlQWRkcmVzcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkFkZHJlc3MgVmFsaWRhdGlvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJFbmFibGUgYWRkcmVzcyB2YWxpZGF0aW9uIGlmIHRydWUiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAic2hvd01hcE9uTG9hZCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIldoZXRoZXIgdG8gc2hvdyB0aGUgbWFwIHdoZW4gZmlyc3QgbG9hZGVkIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk9iamVjdEZpZWxkI2dldE9wdGlvbnNGb3JPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0Zvck9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICJ2YWxpZGF0ZUFkZHJlc3MiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJoZWxwZXIiOiAiQWRkcmVzcyB2YWxpZGF0aW9uIGlmIGNoZWNrZWQiLAogICAgICAgICAgICAgICAgICAgICAgICAicmlnaHRMYWJlbCI6ICJFbmFibGUgR29vZ2xlIE1hcCBmb3IgYWRkcmVzcyB2YWxpZGF0aW9uPyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuT2JqZWN0RmllbGQjZ2V0VGl0bGUKICAgICAgICAgKi8KICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiQWRkcmVzcyI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk9iamVjdEZpZWxkI2dldERlc2NyaXB0aW9uCiAgICAgICAgICovCiAgICAgICAgZ2V0RGVzY3JpcHRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIlN0YW5kYXJkIFVTIEFkZHJlc3Mgd2l0aCBTdHJlZXQsIENpdHksIFN0YXRlIGFuZCBaaXAuIEFsc28gY29tZXMgd2l0aCBzdXBwb3J0IGZvciBHb29nbGUgbWFwLiI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk9iamVjdEZpZWxkI2dldFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJhbnkiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5PYmplY3RGaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRGaWVsZFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gImFkZHJlc3MiOwogICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiYWRkcmVzcyIsIEFscGFjYS5GaWVsZHMuQWRkcmVzc0ZpZWxkKTsKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgcm91bmQgPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHN0cmF0ZWdpZXMgPSB7CiAgICAgICAgICAgIHVwOiAgICAgIE1hdGguY2VpbCwKICAgICAgICAgICAgZG93bjogICAgZnVuY3Rpb24oaW5wdXQpIHsgcmV0dXJuIH5+aW5wdXQ7IH0sCiAgICAgICAgICAgIG5lYXJlc3Q6IE1hdGgucm91bmQKICAgICAgICB9OwogICAgICAgIHJldHVybiBmdW5jdGlvbihzdHJhdGVneSkgewogICAgICAgICAgICByZXR1cm4gc3RyYXRlZ2llc1tzdHJhdGVneV07CiAgICAgICAgfTsKICAgIH0pKCk7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuQ3VycmVuY3lGaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuQ3VycmVuY3lGaWVsZC5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkCiAgICAgICAgICoKICAgICAgICAgKiBAY2xhc3MgQ3VycmVuY3kgQ29udHJvbAogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IGRhdGEgRmllbGQgZGF0YS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBGaWVsZCBvcHRpb25zLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBGaWVsZCB2aWV3LgogICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbm5lY3Rvcn0gY29ubmVjdG9yIEZpZWxkIGNvbm5lY3Rvci4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgICAgICAgICAgdmFyIHBmT3B0aW9uc1NjaGVtYSA9IHRoaXMuZ2V0U2NoZW1hT2ZQcmljZUZvcm1hdE9wdGlvbnMoKS5wcm9wZXJ0aWVzOwogICAgICAgICAgICBmb3IgKHZhciBpIGluIHBmT3B0aW9uc1NjaGVtYSkgewogICAgICAgICAgICAgICAgdmFyIG9wdGlvbiA9IHBmT3B0aW9uc1NjaGVtYVtpXTsKICAgICAgICAgICAgICAgIGlmICghKGkgaW4gb3B0aW9ucykpIHsKICAgICAgICAgICAgICAgICAgICBvcHRpb25zW2ldID0gb3B0aW9uWyJkZWZhdWx0Il0gfHwgdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBkYXRhID0gIiIgKyBwYXJzZUZsb2F0KGRhdGEpLnRvRml4ZWQob3B0aW9ucy5jZW50c0xpbWl0KTsKCiAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI3Bvc3RSZW5kZXIKICAgICAgICAgKi8KICAgICAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbihjYWxsYmFjaykgewoKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgdGhpcy5iYXNlKGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgICQoc2VsZi5maWVsZCkucHJpY2VGb3JtYXQoc2VsZi5vcHRpb25zKTsKCiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwoKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRWYWx1ZQogICAgICAgICAqLwogICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGZpZWxkID0gdGhpcy5maWVsZDsKICAgICAgICAgICAgdmFyIHZhbCAgID0gJChmaWVsZCkuaXMoJ2lucHV0JykgPyBmaWVsZC52YWwoKSA6IGZpZWxkLmhtdGwoKTsKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy51bm1hc2sgfHwgdGhpcy5vcHRpb25zLnJvdW5kICE9PSAibm9uZSIpIHsKICAgICAgICAgICAgICAgIHZhciB1bm1hc2tlZCA9IChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gJyc7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSBpbiB2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGN1ciA9IHZhbFtpXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc05hTihjdXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgKz0gY3VyOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGN1ciA9PT0gdGhpcy5vcHRpb25zLmNlbnRzU2VwYXJhdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgKz0gJy4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZUZsb2F0KHJlc3VsdCk7CiAgICAgICAgICAgICAgICB9KS5iaW5kKHRoaXMpKCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLnJvdW5kICE9PSAibm9uZSIpIHsKICAgICAgICAgICAgICAgICAgICB1bm1hc2tlZCA9IHJvdW5kKHRoaXMub3B0aW9ucy5yb3VuZCkodW5tYXNrZWQpOwogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5vcHRpb25zLnVubWFzaykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB1bm1hc2tlZFN0cmluZyA9ICIiICsgdW5tYXNrZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCB1ID0gMDsgaSA8IHZhbC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc05hTih2YWxbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2godW5tYXNrZWRTdHJpbmdbdSsrXSB8fCAwKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh2YWxbaV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQuam9pbignJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHVubWFza2VkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICAgICAgfQogICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoKICAgICAgICBnZXRTY2hlbWFPZlByaWNlRm9ybWF0T3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAiYWxsb3dOZWdhdGl2ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkFsbG93IE5lZ2F0aXZlIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkRldGVybWluZXMgaWYgbmVnYXRpdmUgbnVtYmVycyBhcmUgYWxsb3dlZC4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiBmYWxzZQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImNlbnRzTGltaXQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJDZW50cyBMaW1pdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJUaGUgbGltaXQgb2YgZnJhY3Rpb25hbCBkaWdpdHMuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibnVtYmVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiAyLAogICAgICAgICAgICAgICAgICAgICAgICAibWluaW11bSI6IDAKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJjZW50c1NlcGFyYXRvciI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkNlbnRzIFNlcGFyYXRvciIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJUaGUgc2VwYXJhdG9yIGJldHdlZW4gd2hvbGUgYW5kIGZyYWN0aW9uYWwgYW1vdW50cy4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiAiLiIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJjbGVhclByZWZpeCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkNsZWFyIFByZWZpeCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJEZXRlcm1pbmVzIGlmIHRoZSBwcmVmaXggaXMgY2xlYXJlZCBvbiBibHVyLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiY2xlYXJTdWZmaXgiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJDbGVhciBTdWZmaXgiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRGV0ZXJtaW5lcyBpZiB0aGUgc3VmZml4IGlzIGNsZWFyZWQgb24gYmx1ci4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiBmYWxzZQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImluc2VydFBsdXNTaWduIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiUGx1cyBTaWduIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkRldGVybWluZXMgaWYgYSBwbHVzIHNpZ24gc2hvdWxkIGJlIGluc2VydGVkIGZvciBwb3NpdGl2ZSB2YWx1ZXMuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogZmFsc2UKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJsaW1pdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkxpbWl0IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkEgbGltaXQgb2YgdGhlIGxlbmd0aCBvZiB0aGUgZmllbGQuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibnVtYmVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiB1bmRlZmluZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICJtaW5pbXVtIjogMAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInByZWZpeCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlByZWZpeCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJUaGUgcHJlZml4IGlmIGFueSBmb3IgdGhlIGZpZWxkLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRleHQiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6ICIkIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInJvdW5kIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiUm91bmQiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRGV0ZXJtaW5lcyBpZiB0aGUgZmllbGQgaXMgcm91bmRlZC4gKFJvdW5kaW5nIGlzIGRvbmUgd2hlbiBnZXRWYWx1ZSBpcyBjYWxsZWQgYW5kIGlzIG5vdCByZWZsZWN0ZWQgaW4gdGhlIFVJKSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJlbnVtIjogWyAidXAiLCAiZG93biIsICJuZWFyZXN0IiwgIm5vbmUiIF0sCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogIm5vbmUiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAic3VmZml4IjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiU3VmZml4IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlRoZSBzdWZmaXggaWYgYW55IGZvciB0aGUgZmllbGQuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogIiIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJ0aG91c2FuZHNTZXBhcmF0b3IiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJUaG91c2FuZHMgU2VwYXJhdG9yIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlRoZSBzZXBhcmF0b3IgYmV0d2VlbiB0aG91c2FuZHMuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiAiLCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJ1bm1hc2siOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJVbm1hc2siLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiSWYgdHJ1ZSB0aGVuIHRoZSByZXN1bHRpbmcgdmFsdWUgZm9yIHRoaXMgZmllbGQgd2lsbCBiZSB1bm1hc2tlZC4gIFRoYXQgaXMsIHRoZSByZXN1bHRpbmcgdmFsdWUgd2lsbCBiZSBhIGZsb2F0IGluc3RlYWQgb2YgYSBzdHJpbmcgKHdpdGggdGhlIHByZWZpeCwgc3VmZml4LCBldGMuIHJlbW92ZWQpLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IHRydWUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFNjaGVtYU9mT3B0aW9ucwogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHRoaXMuZ2V0U2NoZW1hT2ZQcmljZUZvcm1hdE9wdGlvbnMoKSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldE9wdGlvbnNGb3JPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0Zvck9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICJhbGxvd05lZ2F0aXZlIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJjZW50c0xpbWl0IjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJudW1iZXIiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiY2VudHNTZXBhcmF0b3IiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRleHQiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiY2xlYXJQcmVmaXgiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImNsZWFyU3VmZml4IjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJpbnNlcnRQbHVzU2lnbiI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiY2hlY2tib3giCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAibGltaXQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm51bWJlciIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJwcmVmaXgiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRleHQiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAicm91bmQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInNlbGVjdCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJzdWZmaXgiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRleHQiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAidGhvdXNhbmRzU2VwYXJhdG9yIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAidW5tYXNrIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0VGl0bGUKICAgICAgICAgKi8KICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiQ3VycmVuY3kgRmllbGQiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RGVzY3JpcHRpb24KICAgICAgICAgKi8KICAgICAgICBnZXREZXNjcmlwdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiUHJvdmlkZXMgYW4gYXV0b21hdGljYWxseSBmb3JtYXR0ZWQgYW5kIGNvbmZpZ3VyYWJsZSBpbnB1dCBmb3IgZW50ZXJpbmcgY3VycmVuY3kgYW1vdW50cy4iOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RmllbGRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJjdXJyZW5jeSI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJGaWVsZENsYXNzKCJjdXJyZW5jeSIsIEFscGFjYS5GaWVsZHMuQ3VycmVuY3lGaWVsZCk7Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLkRhdGVGaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuRGF0ZUZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBEYXRlIGNvbnRyb2wgZm9yIEpTT04gc2NoZW1hIGRhdGUgZm9ybWF0LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IGRhdGEgRmllbGQgZGF0YS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBGaWVsZCBvcHRpb25zLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBGaWVsZCB2aWV3LgogICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbm5lY3Rvcn0gY29ubmVjdG9yIEZpZWxkIGNvbm5lY3Rvci4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI3NldHVwCiAgICAgICAgICovCiAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CgogICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5kYXRlRm9ybWF0KSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuZGF0ZUZvcm1hdCA9IEFscGFjYS5kZWZhdWx0RGF0ZUZvcm1hdDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5kYXRlRm9ybWF0UmVnZXgpIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5kYXRlRm9ybWF0UmVnZXggPSBBbHBhY2EucmVnZXhwcy5kYXRlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZCAmJiAkLmRhdGVwaWNrZXIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRhdGVQaWNrZXJPcHRpb25zID0gc2VsZi5vcHRpb25zLmRhdGVwaWNrZXI7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFkYXRlUGlja2VyT3B0aW9ucykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGVQaWNrZXJPcHRpb25zID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgImNoYW5nZU1vbnRoIjogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjaGFuZ2VZZWFyIjogdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoIWRhdGVQaWNrZXJPcHRpb25zLmRhdGVGb3JtYXQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRlUGlja2VyT3B0aW9ucy5kYXRlRm9ybWF0ID0gc2VsZi5vcHRpb25zLmRhdGVGb3JtYXQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGQuZGF0ZXBpY2tlcihkYXRlUGlja2VyT3B0aW9ucyk7CgogICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLmZpZWxkQ29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtZGF0ZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwoKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGQjb25DaGFuZ2UKICAgICAgICAgKi8KICAgICAgICBvbkNoYW5nZTogZnVuY3Rpb24oZSkgewogICAgICAgICAgICB0aGlzLmJhc2UoKTsKICAgICAgICAgICAgdGhpcy5yZWZyZXNoVmFsaWRhdGlvblN0YXRlKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNoYW5kbGVWYWxpZGF0ZQogICAgICAgICAqLwogICAgICAgIGhhbmRsZVZhbGlkYXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGJhc2VTdGF0dXMgPSB0aGlzLmJhc2UoKTsKCiAgICAgICAgICAgIHZhciB2YWxJbmZvID0gdGhpcy52YWxpZGF0aW9uOwoKICAgICAgICAgICAgdmFyIHN0YXR1cyA9IHRoaXMuX3ZhbGlkYXRlRGF0ZUZvcm1hdCgpOwogICAgICAgICAgICB2YWxJbmZvWyJpbnZhbGlkRGF0ZSJdID0gewogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiBzdGF0dXMgPyAiIiA6IEFscGFjYS5zdWJzdGl0dXRlVG9rZW5zKHRoaXMudmlldy5nZXRNZXNzYWdlKCJpbnZhbGlkRGF0ZSIpLCBbdGhpcy5vcHRpb25zLmRhdGVGb3JtYXRdKSwKICAgICAgICAgICAgICAgICJzdGF0dXMiOiBzdGF0dXMKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBiYXNlU3RhdHVzICYmIHZhbEluZm9bImludmFsaWREYXRlIl1bInN0YXR1cyJdOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlcyBkYXRlIGZvcm1hdC4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZiBpdCBpcyBhIHZhbGlkIGRhdGUsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgKi8KICAgICAgICBfdmFsaWRhdGVEYXRlRm9ybWF0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5maWVsZC52YWwoKTsKCiAgICAgICAgICAgIGlmICgkLmRhdGVwaWNrZXIpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgJC5kYXRlcGlja2VyLnBhcnNlRGF0ZSh0aGlzLm9wdGlvbnMuZGF0ZUZvcm1hdCwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy92YWxpZGF0ZSB0aGUgZGF0ZSB3aXRob3V0IHRoZSBoZWxwIG9mIGRhdGVwaWNrZXIucGFyc2VEYXRlCiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUubWF0Y2godGhpcy5vcHRpb25zLmRhdGVGb3JtYXRSZWdleCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI3NldFZhbHVlCiAgICAgICAgICovCiAgICAgICAgc2V0VmFsdWU6IGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICAvLyBza2lwIG91dCBpZiBubyBkYXRlCiAgICAgICAgICAgIGlmICh2YWwgPT09ICIiKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJhc2UodmFsKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5iYXNlKHZhbCk7CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRTY2hlbWFPZlNjaGVtYQogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mU2NoZW1hOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgImZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJQcm9wZXJ0eSBkYXRhIGZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjoiZGF0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJlbnVtIiA6IFsiZGF0ZSJdLAogICAgICAgICAgICAgICAgICAgICAgICAicmVhZG9ubHkiOnRydWUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRPcHRpb25zRm9yU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0ZvclNjaGVtYTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgImZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRTY2hlbWFPZk9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRTY2hlbWFPZk9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAiZGF0ZUZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkRhdGUgRm9ybWF0IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkRhdGUgZm9ybWF0IiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiBBbHBhY2EuZGVmYXVsdERhdGVGb3JtYXQKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJkYXRlRm9ybWF0UmVnZXgiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJGb3JtYXQgUmVndWxhciBFeHByZXNzaW9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlJlZ3VsYXIgZXhwcmVzc2lvbiBmb3IgdmFsaWRhdGlvbiBkYXRlIGZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogQWxwYWNhLnJlZ2V4cHMuZGF0ZQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImRhdGVwaWNrZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJEYXRlIFBpY2tlciBvcHRpb25zIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIk9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gdG8gYmUgcGFzc2VkIHRvIGpRdWVyeSBVSSBEYXRlUGlja2VyIGNvbnRyb2wiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJhbnkiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0T3B0aW9uc0Zvck9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgImRhdGVGb3JtYXQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRleHQiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZGF0ZUZvcm1hdFJlZ2V4IjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImRhdGV0aW1lIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJhbnkiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFRpdGxlCiAgICAgICAgICovCiAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIkRhdGUgRmllbGQiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RGVzY3JpcHRpb24KICAgICAgICAgKi8KICAgICAgICBnZXREZXNjcmlwdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiRGF0ZSBGaWVsZC4iOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RmllbGRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJkYXRlIjsKICAgICAgICB9Ly9fX0VORF9PRl9CVUlMREVSX0hFTFBFUlMKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3Rlck1lc3NhZ2VzKHsKICAgICAgICAiaW52YWxpZERhdGUiOiAiSW52YWxpZCBkYXRlIGZvciBmb3JtYXQgezB9IgogICAgfSk7CiAgICBBbHBhY2EucmVnaXN0ZXJGaWVsZENsYXNzKCJkYXRlIiwgQWxwYWNhLkZpZWxkcy5EYXRlRmllbGQpOwogICAgQWxwYWNhLnJlZ2lzdGVyRGVmYXVsdEZvcm1hdEZpZWxkTWFwcGluZygiZGF0ZSIsICJkYXRlIik7Cn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuRGF0ZXRpbWVGaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkLmV4dGVuZCgKICAgICAgICAvKioKICAgICAgICAgKiBAbGVuZHMgQWxwYWNhLkZpZWxkcy5EYXRldGltZUZpZWxkLnByb3RvdHlwZQogICAgICAgICAqLwogICAgICAgIHsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuRmllbGRzLk9iamVjdEZpZWxkCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBjbGFzcyBBIGNvbWJvIGZpZWxkIGZvciByZW5kZXJpbmcgYSBzdGFuZGFyZCBVUyByYW5nZS4gSXQgYWxzbyBjb21lcyB1cCB3aXRoIHN1cHBvcnQgZm9yIEdvb2dsZSBNYXAKICAgICAgICAgICAgICogd2hpY2ggd291bGQgcmVxdWlyZXMgaW5jbHVkaW5nIEdvb2dsZSBNYXAgSlMgZmlsZSBmb3IgdGhlIGZvcm0gdGhhdCB1c2VzIHRoaXMgY2xhc3MuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBGaWVsZCBvcHRpb25zLgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbm5lY3Rvcn0gY29ubmVjdG9yIEZpZWxkIGNvbm5lY3Rvci4KICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNzZXR1cAogICAgICAgICAgICAgKi8KICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5PYmplY3RGaWVsZCNzZXR1cAogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGhpcy5iYXNlKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbihjYWxsYmFjaykgewoKICAgICAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLmZpZWxkKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGQuZGF0ZXRpbWVwaWNrZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGQuaG92ZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEkKHRoaXMpLmhhc0NsYXNzKCdoYXNEYXRlcGlja2VyJykpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0aW1lUGlja2VyT3B0aW9ucyA9IHNlbGYub3B0aW9ucy50aW1lcGlja2VyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRpbWVQaWNrZXJPcHRpb25zKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lUGlja2VyT3B0aW9ucyA9IHNlbGYub3B0aW9ucy50aW1lcGlja2VyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGltZVBpY2tlck9wdGlvbnMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVQaWNrZXJPcHRpb25zID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjaGFuZ2VZZWFyIjogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY2hhbmdlTW9udGgiOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykuZGF0ZXRpbWVwaWNrZXIodGltZVBpY2tlck9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLWRhdGV0aW1lJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICpAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI3NldFZhbHVlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNOdW1iZXIoKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IG5ldyBEYXRlKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gIltvYmplY3QgRGF0ZV0iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYmFzZSgodmFsdWUuZ2V0TW9udGgoKSArIDEpICsgIi8iICsgdmFsdWUuZ2V0RGF0ZSgpICsgIi8iICsgdmFsdWUuZ2V0RnVsbFllYXIoKSArICIgIiArIHZhbHVlLmdldEhvdXJzKCkgKyAiOiIgKyB2YWx1ZS5nZXRNaW51dGVzKCkpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYmFzZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJhc2UodmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0VmFsdWUKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmJhc2UoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBSZXR1cm5zIGZpZWxkIHZhbHVlIGluIGRhdGV0aW1lLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcmV0dXJucyB7RGF0ZX0gRmllbGQgdmFsdWUuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBnZXREYXRldGltZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZpZWxkLmRhdGV0aW1lcGlja2VyKCdnZXREYXRlJyk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2dldFNjaGVtYU9mT3B0aW9ucwogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZ2V0U2NoZW1hT2ZPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpbWVwaWNrZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiVGltZXBpY2tlciBvcHRpb25zIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJPcHRpb25zIHRoYXQgYXJlIHN1cHBvcnRlZCBieSB0aGUgPGEgaHJlZj0naHR0cDovL3RyZW50cmljaGFyZHNvbi5jb20vZXhhbXBsZXMvdGltZXBpY2tlci8nPmpRdWVyeSB0aW1lcGlja2VyIGFkZG9uPC9hPi4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYW55IgogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2dldE9wdGlvbnNGb3JPcHRpb25zCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAgICAgImZpZWxkcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpbWVwaWNrZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJhbnkiCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFRpdGxlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIkRhdGV0aW1lIEZpZWxkIjsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldERlc2NyaXB0aW9uCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBnZXREZXNjcmlwdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIkRhdGV0aW1lIEZpZWxkIGJhc2VkIG9uIFRyZW50IFJpY2hhcmRzb24ncyA8YSBocmVmPSdodHRwOi8vdHJlbnRyaWNoYXJkc29uLmNvbS9leGFtcGxlcy90aW1lcGlja2VyLyc+alF1ZXJ5IHRpbWVwaWNrZXIgYWRkb248L2E+LiI7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gImRhdGV0aW1lIjsKICAgICAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICAgICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiZGF0ZXRpbWUiLCBBbHBhY2EuRmllbGRzLkRhdGV0aW1lRmllbGQpOwoKICAgIC8vICJkYXRldGltZSIgaXMgbGVnYWN5IChwcmUgdjQgc2NoZW1hKQogICAgQWxwYWNhLnJlZ2lzdGVyRGVmYXVsdEZvcm1hdEZpZWxkTWFwcGluZygiZGF0ZXRpbWUiLCAiZGF0ZXRpbWUiKTsKCiAgICAvLyBvZmZpY2lhbCB2NCB1c2VzIGRhdGUtdGltZQogICAgQWxwYWNhLnJlZ2lzdGVyRGVmYXVsdEZvcm1hdEZpZWxkTWFwcGluZygiZGF0ZS10aW1lIiwgImRhdGV0aW1lIik7Cn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuRWRpdG9yRmllbGQgPSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZC5leHRlbmQoCiAgICAgICAgLyoqCiAgICAgICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuRWRpdG9yRmllbGQucHJvdG90eXBlCiAgICAgICAgICovCiAgICAgICAgewogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBjbGFzcyBUZXh0YXJlYSBjb250cm9sIGZvciBjaHVuayBvZiB0ZXh0LgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgICAgICogQHBhcmFtIHtBbnl9IGRhdGEgRmllbGQgZGF0YS4KICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBGaWVsZCB2aWV3LgogICAgICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjc2V0dXAKICAgICAgICAgICAgICovCiAgICAgICAgICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgICAgIHRoaXMuY29udHJvbEZpZWxkVGVtcGxhdGVEZXNjcmlwdG9yID0gdGhpcy52aWV3LmdldFRlbXBsYXRlRGVzY3JpcHRvcigiY29udHJvbEZpZWxkRWRpdG9yIik7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbihjYWxsYmFjaykgewoKICAgICAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLmZpZWxkQ29udGFpbmVyKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5maWVsZENvbnRhaW5lci5hZGRDbGFzcygnYWxwYWNhLWNvbnRyb2xmaWVsZC1lZGl0b3InKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNldCBmaWVsZCBjb250YWluZXIgcGFyZW50IHdpZHRoID0gMTAwJQogICAgICAgICAgICAgICAgICAgICAgICAkKHNlbGYuZmllbGRDb250YWluZXIpLnBhcmVudCgpLmNzcygid2lkdGgiLCAiMTAwJSIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQUNFIEhFSUdIVAogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYWNlSGVpZ2h0ID0gc2VsZi5vcHRpb25zLmFjZUhlaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjZUhlaWdodCkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJChzZWxmLmZpZWxkQ29udGFpbmVyKS5jc3MoImhlaWdodCIsIGFjZUhlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFDRSBXSURUSAogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYWNlV2lkdGggPSBzZWxmLm9wdGlvbnMuYWNlV2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYWNlV2lkdGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjZVdpZHRoID0gIjEwMCUiOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICQoc2VsZi5maWVsZENvbnRhaW5lcikuY3NzKCJ3aWR0aCIsIGFjZVdpZHRoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGxvY2F0ZSB3aGVyZSB3ZSB3aWxsIGluc2VydCB0aGUgZWRpdG9yCiAgICAgICAgICAgICAgICAgICAgdmFyIGVsID0gJChzZWxmLmZpZWxkQ29udGFpbmVyKS5maW5kKCIuY29udHJvbC1maWVsZC1lZGl0b3ItZWwiKVswXTsKCiAgICAgICAgICAgICAgICAgICAgLy8gYWNlIG11c3QgYmUgaW5jbHVkZWQgYWhlYWQgb2YgdGltZQogICAgICAgICAgICAgICAgICAgIGlmICghYWNlICYmIHdpbmRvdy5hY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWNlID0gd2luZG93LmFjZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICghYWNlKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgQWxwYWNhLmxvZ0Vycm9yKCJFZGl0b3IgRmllbGQgaXMgbWlzc2luZyB0aGUgJ2FjZScgQ2xvdWQgOSBFZGl0b3IiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5lZGl0b3IgPSBhY2UuZWRpdChlbCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGVtZQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYWNlVGhlbWUgPSBzZWxmLm9wdGlvbnMuYWNlVGhlbWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYWNlVGhlbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjZVRoZW1lID0gImFjZS90aGVtZS9jaHJvbWUiOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZWRpdG9yLnNldFRoZW1lKGFjZVRoZW1lKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG1vZGUKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFjZU1vZGUgPSBzZWxmLm9wdGlvbnMuYWNlTW9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFhY2VNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2VNb2RlID0gImFjZS9tb2RlL2pzb24iOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZWRpdG9yLmdldFNlc3Npb24oKS5zZXRNb2RlKGFjZU1vZGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5lZGl0b3IucmVuZGVyZXIuc2V0SFNjcm9sbEJhckFsd2F5c1Zpc2libGUoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAvL3RoaXMuZWRpdG9yLnJlbmRlcmVyLnNldFZTY3JvbGxCYXJBbHdheXNWaXNpYmxlKGZhbHNlKTsgLy8gbm90IGltcGxlbWVudGVkCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZWRpdG9yLnNldFNob3dQcmludE1hcmdpbihmYWxzZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBzZXQgZGF0YSBvbnRvIGVkaXRvcgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmVkaXRvci5zZXRWYWx1ZShzZWxmLmRhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmVkaXRvci5jbGVhclNlbGVjdGlvbigpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2xlYXIgdW5kbyBzZXNzaW9uCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZWRpdG9yLmdldFNlc3Npb24oKS5nZXRVbmRvTWFuYWdlcigpLnJlc2V0KCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBGSVQtQ09OVEVOVCB0aGUgaGVpZ2h0IG9mIHRoZSBlZGl0b3IgdG8gdGhlIGNvbnRlbnRzIGNvbnRhaW5lZCB3aXRoaW4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5hY2VGaXRDb250ZW50SGVpZ2h0KQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGVpZ2h0VXBkYXRlRnVuY3Rpb24gPSBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZpcnN0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYuZWRpdG9yLnJlbmRlcmVyLmxpbmVIZWlnaHQgPT09IDEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZWRpdG9yLnJlbmRlcmVyLmxpbmVIZWlnaHQgPSAxNjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTE1ODQwNjEvCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld0hlaWdodCA9IHNlbGYuZWRpdG9yLmdldFNlc3Npb24oKS5nZXRTY3JlZW5MZW5ndGgoKSAqIHNlbGYuZWRpdG9yLnJlbmRlcmVyLmxpbmVIZWlnaHQgKyBzZWxmLmVkaXRvci5yZW5kZXJlci5zY3JvbGxCYXIuZ2V0V2lkdGgoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJChzZWxmLmZpZWxkQ29udGFpbmVyKS5oZWlnaHQobmV3SGVpZ2h0LnRvU3RyaW5nKCkgKyAicHgiKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBjYWxsIGlzIHJlcXVpcmVkIGZvciB0aGUgZWRpdG9yIHRvIGZpeCBhbGwgb2YKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpdHMgaW5uZXIgc3RydWN0dXJlIGZvciBhZGFwdGluZyB0byBhIGNoYW5nZSBpbiBzaXplCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5lZGl0b3IucmVzaXplKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaXJzdCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5lZGl0b3IuY2xlYXJTZWxlY3Rpb24oKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgNSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTZXQgaW5pdGlhbCBzaXplIHRvIG1hdGNoIGluaXRpYWwgY29udGVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0VXBkYXRlRnVuY3Rpb24oKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXaGVuZXZlciBhIGNoYW5nZSBoYXBwZW5zIGluc2lkZSB0aGUgQUNFIGVkaXRvciwgdXBkYXRlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgc2l6ZSBhZ2FpbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5lZGl0b3IuZ2V0U2Vzc2lvbigpLm9uKCdjaGFuZ2UnLCBoZWlnaHRVcGRhdGVGdW5jdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJFQURPTkxZCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLnNjaGVtYS5yZWFkb25seSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5lZGl0b3Iuc2V0UmVhZE9ubHkodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoZSBlZGl0b3IncyBkb20gZWxlbWVudCBnZXRzIGRlc3Ryb3llZCwgbWFrZSBzdXJlIHdlIGNsZWFuIHVwIHRoZSBlZGl0b3IgaW5zdGFuY2UKICAgICAgICAgICAgICAgICAgICAgICAgLy8gbm9ybWFsbHksIHdlIGV4cGVjdCBBbHBhY2EgZmllbGRzIHRvIGJlIGRlc3Ryb3llZCBieSB0aGUgZGVzdHJveSgpIG1ldGhvZCBidXQgdGhleSBtYXkgYWxzbyBiZQogICAgICAgICAgICAgICAgICAgICAgICAvLyBjbGVhbmVkLXVwIHZpYSB0aGUgRE9NLCB0aHVzIHdlIGNoZWNrIGhlcmUuCiAgICAgICAgICAgICAgICAgICAgICAgICQoZWwpLmJpbmQoJ2Rlc3Ryb3llZCcsIGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLmVkaXRvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZWRpdG9yLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmVkaXRvciA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNkZXN0cm95CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAvLyBkZXN0cm95IHRoZSBlZGl0b3IgaW5zdGFuY2UKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVkaXRvcikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lZGl0b3IgPSBudWxsOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGNhbGwgdXAgdG8gYmFzZSBtZXRob2QKICAgICAgICAgICAgICAgIHRoaXMuYmFzZSgpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEByZXR1cm4gdGhlIEFDRSBlZGl0b3IgaW5zdGFuY2UKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldEVkaXRvcjogZnVuY3Rpb24oKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lZGl0b3I7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2hhbmRsZVZhbGlkYXRlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBoYW5kbGVWYWxpZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgYmFzZVN0YXR1cyA9IHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgICAgIHZhciB2YWxJbmZvID0gdGhpcy52YWxpZGF0aW9uOwoKICAgICAgICAgICAgICAgIHZhciB3b3JkQ291bnRTdGF0dXMgPSAgdGhpcy5fdmFsaWRhdGVXb3JkQ291bnQoKTsKICAgICAgICAgICAgICAgIHZhbEluZm9bIndvcmRMaW1pdEV4Y2VlZGVkIl0gPSB7CiAgICAgICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiB3b3JkQ291bnRTdGF0dXMgPyAiIiA6IEFscGFjYS5zdWJzdGl0dXRlVG9rZW5zKHRoaXMudmlldy5nZXRNZXNzYWdlKCJ3b3JkTGltaXRFeGNlZWRlZCIpLCBbdGhpcy5vcHRpb25zLndvcmRsaW1pdF0pLAogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiB3b3JkQ291bnRTdGF0dXMKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgdmFyIGVkaXRvckFubm90YXRpb25zU3RhdHVzID0gdGhpcy5fdmFsaWRhdGVFZGl0b3JBbm5vdGF0aW9ucygpOwogICAgICAgICAgICAgICAgdmFsSW5mb1siZWRpdG9yQW5ub3RhdGlvbnNFeGlzdCJdID0gewogICAgICAgICAgICAgICAgICAgICJtZXNzYWdlIjogZWRpdG9yQW5ub3RhdGlvbnNTdGF0dXMgPyAiIiA6IHRoaXMudmlldy5nZXRNZXNzYWdlKCJlZGl0b3JBbm5vdGF0aW9uc0V4aXN0IiksCiAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6IGVkaXRvckFubm90YXRpb25zU3RhdHVzCiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIHJldHVybiBiYXNlU3RhdHVzICYmIHZhbEluZm9bIndvcmRMaW1pdEV4Y2VlZGVkIl1bInN0YXR1cyJdICYmIHZhbEluZm9bImVkaXRvckFubm90YXRpb25zRXhpc3QiXVsic3RhdHVzIl07CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBfdmFsaWRhdGVFZGl0b3JBbm5vdGF0aW9uczogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuZWRpdG9yKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBhbm5vdGF0aW9ucyA9IHRoaXMuZWRpdG9yLmdldFNlc3Npb24oKS5nZXRBbm5vdGF0aW9ucygpOwogICAgICAgICAgICAgICAgICAgIGlmIChhbm5vdGF0aW9ucyAmJiBhbm5vdGF0aW9ucy5sZW5ndGggPiAwKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBWYWxpZGF0ZSBmb3Igd29yZCBsaW1pdC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWYgdGhlIG51bWJlciBvZiB3b3JkcyBpcyBlcXVhbCB0byBvciBsZXNzIHRoYW4gdGhlIHdvcmQgbGltaXQuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBfdmFsaWRhdGVXb3JkQ291bnQ6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMud29yZGxpbWl0ICYmIHRoaXMub3B0aW9ucy53b3JkbGltaXQgPiAtMSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsID0gdGhpcy5lZGl0b3IuZ2V0VmFsdWUoKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB3b3JkY291bnQgPSB2YWwuc3BsaXQoIiAiKS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3b3JkY291bnQgPiB0aGlzLm9wdGlvbnMud29yZGxpbWl0KQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogRm9yY2UgZWRpdG9yIHRvIHJlc2l6ZSB0byBlbnN1cmUgaXQgZ2V0cyBkcmF3biBjb3JyZWN0bHkuCiAgICAgICAgICAgICAqIEBvdmVycmlkZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgb25EZXBlbmRlbnRSZXZlYWw6IGZ1bmN0aW9uKCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZWRpdG9yKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZWRpdG9yLnJlc2l6ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNzZXRWYWx1ZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc2V0VmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CgogICAgICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVkaXRvcikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5zZXRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gYmUgc3VyZSB0byBjYWxsIGludG8gYmFzZSBtZXRob2QKICAgICAgICAgICAgICAgIHRoaXMuYmFzZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRWYWx1ZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IG51bGw7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuZWRpdG9yKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdGhpcy5lZGl0b3IuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0U2NoZW1hT2ZPcHRpb25zCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBnZXRTY2hlbWFPZk9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICAgICAiYWNlVGhlbWUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiQUNFIEVkaXRvciBUaGVtZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiU3BlY2lmaWVzIHRoZSB0aGVtZSB0byBzZXQgb250byB0aGUgZWRpdG9yIGluc3RhbmNlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6ICJhY2UvdGhlbWUvdHdpbGlnaHQiCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICJhY2VNb2RlIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkFDRSBFZGl0b3IgTW9kZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiU3BlY2lmaWVzIHRoZSBtb2RlIHRvIHNldCBvbnRvIHRoZSBlZGl0b3IgaW5zdGFuY2UiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogImFjZS9tb2RlL2phdmFzY3JpcHQiCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICJhY2VXaWR0aCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJBQ0UgRWRpdG9yIEhlaWdodCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiU3BlY2lmaWVzIHRoZSB3aWR0aCBvZiB0aGUgd3JhcHBpbmcgZGl2IGFyb3VuZCB0aGUgZWRpdG9yIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6ICIxMDAlIgogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAiYWNlSGVpZ2h0IjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkFDRSBFZGl0b3IgSGVpZ2h0IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJTcGVjaWZpZXMgdGhlIGhlaWdodCBvZiB0aGUgd3JhcHBpbmcgZGl2IGFyb3VuZCB0aGUgZWRpdG9yIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6ICIzMDBweCIKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgImFjZUZpdENvbnRlbnRIZWlnaHQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiQUNFIEZpdCBDb250ZW50IEhlaWdodCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiQ29uZmlndXJlcyB0aGUgQUNFIEVkaXRvciB0byBhdXRvLWZpdCBpdHMgaGVpZ2h0IHRvIHRoZSBjb250ZW50cyBvZiB0aGUgZWRpdG9yIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiBmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAid29yZGxpbWl0IjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIldvcmQgTGltaXQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkxpbWl0cyB0aGUgbnVtYmVyIG9mIHdvcmRzIGFsbG93ZWQgaW4gdGhlIHRleHQgYXJlYS4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibnVtYmVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogLTEKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0T3B0aW9uc0Zvck9wdGlvbnMKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldE9wdGlvbnNGb3JPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICAgICAiYWNlVGhlbWUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAiYWNlTW9kZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRleHQiCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICJ3b3JkbGltaXQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRUaXRsZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuICJFZGl0b3IiOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RGVzY3JpcHRpb24KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiRWRpdG9yIjsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiZWRpdG9yIjsKICAgICAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCgogICAgICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3Rlck1lc3NhZ2VzKHsKICAgICAgICAid29yZExpbWl0RXhjZWVkZWQiOiAiVGhlIG1heGltdW0gd29yZCBsaW1pdCBvZiB7MH0gaGFzIGJlZW4gZXhjZWVkZWQuIiwKICAgICAgICAiZWRpdG9yQW5ub3RhdGlvbnNFeGlzdCI6ICJUaGUgZWRpdG9yIGhhcyBlcnJvcnMgaW4gaXQgdGhhdCBtdXN0IGJlIGNvcnJlY3RlZCIKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3RlclRlbXBsYXRlKCJjb250cm9sRmllbGRFZGl0b3IiLCAnPGRpdiBpZD0iJHtpZH0iIGNsYXNzPSJjb250cm9sLWZpZWxkLWVkaXRvci1lbCI+PC9kaXY+Jyk7CiAgICBBbHBhY2EucmVnaXN0ZXJGaWVsZENsYXNzKCJlZGl0b3IiLCBBbHBhY2EuRmllbGRzLkVkaXRvckZpZWxkKTsKCn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuRW1haWxGaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuRW1haWxGaWVsZC5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkCiAgICAgICAgICoKICAgICAgICAgKiBAY2xhc3MgQ29udHJvbCBmb3IgSlNPTiBzY2hlbWEgZW1haWwgZm9ybWF0LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IGRhdGEgRmllbGQgZGF0YS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBGaWVsZCBvcHRpb25zLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBGaWVsZCB2aWV3LgogICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbm5lY3Rvcn0gY29ubmVjdG9yIEZpZWxkIGNvbm5lY3Rvci4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI3NldHVwCiAgICAgICAgICovCiAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmJhc2UoKTsKCiAgICAgICAgICAgIGlmICghdGhpcy5zY2hlbWEucGF0dGVybikgewogICAgICAgICAgICAgICAgdGhpcy5zY2hlbWEucGF0dGVybiA9IEFscGFjYS5yZWdleHBzLmVtYWlsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtZW1haWwnKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwoKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNoYW5kbGVWYWxpZGF0ZQogICAgICAgICAqLwogICAgICAgIGhhbmRsZVZhbGlkYXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGJhc2VTdGF0dXMgPSB0aGlzLmJhc2UoKTsKCiAgICAgICAgICAgIHZhciB2YWxJbmZvID0gdGhpcy52YWxpZGF0aW9uOwoKICAgICAgICAgICAgaWYgKCF2YWxJbmZvWyJpbnZhbGlkUGF0dGVybiJdWyJzdGF0dXMiXSkgewogICAgICAgICAgICAgICAgdmFsSW5mb1siaW52YWxpZFBhdHRlcm4iXVsibWVzc2FnZSJdID0gdGhpcy52aWV3LmdldE1lc3NhZ2UoImludmFsaWRFbWFpbCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gYmFzZVN0YXR1czsKICAgICAgICB9LC8vX19CVUlMREVSX0hFTFBFUlMKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFNjaGVtYU9mU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZTY2hlbWE6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcGF0dGVybiA9ICh0aGlzLnNjaGVtYSAmJiB0aGlzLnNjaGVtYS5wYXR0ZXJuKSA/IHRoaXMuc2NoZW1hLnBhdHRlcm4gOiBBbHBhY2EucmVnZXhwcy5lbWFpbDsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgInBhdHRlcm4iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJQYXR0ZXJuIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkZpZWxkIFBhdHRlcm4gaW4gUmVndWxhciBFeHByZXNzaW9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiBwYXR0ZXJuLAogICAgICAgICAgICAgICAgICAgICAgICAiZW51bSI6W3BhdHRlcm5dLAogICAgICAgICAgICAgICAgICAgICAgICAicmVhZG9ubHkiOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZm9ybWF0IjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRm9ybWF0IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlByb3BlcnR5IGRhdGEgZm9ybWF0IiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiJlbWFpbCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJlbnVtIjpbImVtYWlsIl0sCiAgICAgICAgICAgICAgICAgICAgICAgICJyZWFkb25seSI6dHJ1ZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldE9wdGlvbnNGb3JTY2hlbWEKICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yU2NoZW1hOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgImZpZWxkcyI6IHsKICAgICAgICAgICAgICAgICAgICAiZm9ybWF0IjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRUaXRsZQogICAgICAgICAqLwogICAgICAgIGdldFRpdGxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJFbWFpbCBGaWVsZCI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJFbWFpbCBGaWVsZC4iOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RmllbGRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJlbWFpbCI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJNZXNzYWdlcyh7CiAgICAgICAgImludmFsaWRFbWFpbCI6ICJJbnZhbGlkIEVtYWlsIGFkZHJlc3MgZS5nLiBpbmZvQGNsb3VkY21zLmNvbSIKICAgIH0pOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiZW1haWwiLCBBbHBhY2EuRmllbGRzLkVtYWlsRmllbGQpOwogICAgQWxwYWNhLnJlZ2lzdGVyRGVmYXVsdEZvcm1hdEZpZWxkTWFwcGluZygiZW1haWwiLCAiZW1haWwiKTsKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5JbnRlZ2VyRmllbGQgPSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuSW50ZWdlckZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkZpZWxkcy5OdW1iZXJGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIENvbnRyb2wgZm9yIGludGVnZXJzLiBJZiBqUXVlcnkgVUkgaXMgZW5hYmxlZCwgaXQgY2FuIGFsc28gYmUKICAgICAgICAgKiB0dXJuZWQgaW50byBhIHNsaWRlci4KICAgICAgICAgKjxwPgogICAgICAgICAqIFRoZSBmb2xsb3dpbmcgYWRkaXRpb25hbCBKU09OIFNjaGVtYSBwcm9wZXJ0aWVzIGFyZSBzdXBwb3J0ZWQ6CiAgICAgICAgICo8cC8+CiAgICAgICAgICo8Y29kZT4KICAgICAgICAgKiAgICAgPHByZT4KICAgICAgICAgKiB7CiAgICAgICAgICogICAgbWluaW11bToge251bWJlcn0sCiAgICAgICAgICogICAgbWF4aW11bToge251bWJlcn0sCiAgICAgICAgICogICAgbWluaW11bUNhbkVxdWFsOiB7Ym9vbGVhbn0sCiAgICAgICAgICogICAgbWF4aW11bUNhbkVxdWFsOiB7Ym9vbGVhbn0sCiAgICAgICAgICogICAgZGl2aXNpYmxlQnk6IHtudW1iZXJ9CiAgICAgICAgICogfQogICAgICAgICAqIDwvcHJlPgogICAgICAgICAqIDwvY29kZT4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2dldFZhbHVlCiAgICAgICAgICovCiAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgdGV4dFZhbHVlID0gdGhpcy5maWVsZC52YWwoKTsKICAgICAgICAgICAgaWYgKEFscGFjYS5pc1ZhbEVtcHR5KHRleHRWYWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZUludCh0ZXh0VmFsdWUsIDEwKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI29uQ2hhbmdlCiAgICAgICAgICovCiAgICAgICAgb25DaGFuZ2U6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CiAgICAgICAgICAgIGlmICh0aGlzLnNsaWRlcikgewogICAgICAgICAgICAgICAgdGhpcy5zbGlkZXIuc2xpZGVyKCJ2YWx1ZSIsIHRoaXMuZ2V0VmFsdWUoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuTnVtYmVyRmllbGQjcG9zdFJlbmRlcgogICAgICAgICAqLwogICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgdGhpcy5iYXNlKGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMuc2xpZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eShzZWxmLnNjaGVtYS5tYXhpbXVtKSAmJiAhQWxwYWNhLmlzRW1wdHkoc2VsZi5zY2hlbWEubWluaW11bSkpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLmZpZWxkKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkLmFmdGVyKCc8ZGl2IGlkPSJzbGlkZXIiPjwvZGl2PicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zbGlkZXIgPSAkKCcjc2xpZGVyJywgc2VsZi5maWVsZC5wYXJlbnQoKSkuc2xpZGVyKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogc2VsZi5nZXRWYWx1ZSgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbjogc2VsZi5zY2hlbWEubWluaW11bSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXg6IHNlbGYuc2NoZW1hLm1heGltdW0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGU6IGZ1bmN0aW9uKGV2ZW50LCB1aSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNldFZhbHVlKHVpLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5yZWZyZXNoVmFsaWRhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLWludGVnZXInKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwoKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2hhbmRsZVZhbGlkYXRlCiAgICAgICAgICovCiAgICAgICAgaGFuZGxlVmFsaWRhdGU6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgdmFyIGJhc2VTdGF0dXMgPSB0aGlzLmJhc2UoKTsKCiAgICAgICAgICAgIHZhciB2YWxJbmZvID0gdGhpcy52YWxpZGF0aW9uOwoKICAgICAgICAgICAgaWYgKCF2YWxJbmZvWyJzdHJpbmdOb3RBTnVtYmVyIl1bInN0YXR1cyJdKSB7CiAgICAgICAgICAgICAgICB2YWxJbmZvWyJzdHJpbmdOb3RBTnVtYmVyIl1bIm1lc3NhZ2UiXSA9IHRoaXMudmlldy5nZXRNZXNzYWdlKCJzdHJpbmdOb3RBbkludGVnZXIiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGJhc2VTdGF0dXM7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaWRhdGVzIGlmIGl0IGlzIGFuIGludGVnZXIuCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IHRydWUgaWYgaXQgaXMgYW4gaW50ZWdlcgogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZU51bWJlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB0ZXh0VmFsdWUgPSB0aGlzLmZpZWxkLnZhbCgpOwoKICAgICAgICAgICAgaWYgKEFscGFjYS5pc1ZhbEVtcHR5KHRleHRWYWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgZmxvYXRWYWx1ZSA9IHRoaXMuZ2V0VmFsdWUoKTsKCiAgICAgICAgICAgIC8vIHF1aWNrIGNoZWNrIHRvIHNlZSBpZiB3aGF0IHRoZXkgZW50ZXJlZCB3YXMgYSBudW1iZXIKICAgICAgICAgICAgaWYgKGlzTmFOKGZsb2F0VmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGNoZWNrIGlmIHZhbGlkIG51bWJlciBmb3JtYXQKICAgICAgICAgICAgaWYgKCF0ZXh0VmFsdWUubWF0Y2goQWxwYWNhLnJlZ2V4cHMuaW50ZWdlcikpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2dldFNjaGVtYU9mU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZTY2hlbWE6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAibWluaW11bSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIk1pbmltdW0iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiTWluaW11bSB2YWx1ZSBvZiB0aGUgcHJvcGVydHkuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJtYXhpbXVtIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiTWF4aW11bSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJNYXhpbXVtIHZhbHVlIG9mIHRoZSBwcm9wZXJ0eS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImRpdmlzaWJsZUJ5IjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRGl2aXNpYmxlIEJ5IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlByb3BlcnR5IHZhbHVlIG11c3QgYmUgZGl2aXNpYmxlIGJ5IHRoaXMgbnVtYmVyLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5OdW1iZXJGaWVsZCNnZXRPcHRpb25zRm9yU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0ZvclNjaGVtYTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgIm1pbmltdW0iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJoZWxwZXIiOiAiTWluaW11bSB2YWx1ZSBvZiB0aGUgZmllbGQuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJtYXhpbXVtIjogewogICAgICAgICAgICAgICAgICAgICAgICAiaGVscGVyIjogIk1heGltdW0gdmFsdWUgb2YgdGhlIGZpZWxkLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZGl2aXNpYmxlQnkiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJoZWxwZXIiOiAiUHJvcGVydHkgdmFsdWUgbXVzdCBiZSBkaXZpc2libGUgYnkgdGhpcyBudW1iZXIuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2dldFNjaGVtYU9mT3B0aW9ucwogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICJzbGlkZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJTbGlkZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiR2VuZXJhdGUgalF1ZXJ5IFVJIHNsaWRlciBjb250cm9sIHdpdGggdGhlIGZpZWxkIGlmIHRydWUuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogZmFsc2UKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2dldE9wdGlvbnNGb3JPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0Zvck9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICJzbGlkZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJyaWdodExhYmVsIjogIlNsaWRlciBjb250cm9sID8iLAogICAgICAgICAgICAgICAgICAgICAgICAiaGVscGVyIjogIkdlbmVyYXRlIHNsaWRlciBjb250cm9sIGlmIHNlbGVjdGVkLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2dldFRpdGxlCiAgICAgICAgICovCiAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIkludGVnZXIgRmllbGQiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5OdW1iZXJGaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJGaWVsZCBmb3IgaW50ZWdlcnMuIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuTnVtYmVyRmllbGQjZ2V0VHlwZQogICAgICAgICAqLwogICAgICAgIGdldFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gImludGVnZXIiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5OdW1iZXJGaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRGaWVsZFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gImludGVnZXIiOwogICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgfSk7CgogICAgLy8gQWRkaXRpb25hbCBSZWdpc3RyYXRpb25zCiAgICBBbHBhY2EucmVnaXN0ZXJNZXNzYWdlcyh7CiAgICAgICAgInN0cmluZ05vdEFuSW50ZWdlciI6ICJUaGlzIHZhbHVlIGlzIG5vdCBhbiBpbnRlZ2VyLiIKICAgIH0pOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiaW50ZWdlciIsIEFscGFjYS5GaWVsZHMuSW50ZWdlckZpZWxkKTsKICAgIEFscGFjYS5yZWdpc3RlckRlZmF1bHRTY2hlbWFGaWVsZE1hcHBpbmcoImludGVnZXIiLCAiaW50ZWdlciIpOwp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLklQdjRGaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuSVB2NEZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBDb250cm9sIGZvciBKU09OIHNjaGVtYSBpcC1hZGRyZXNzIGZvcm1hdC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNzZXR1cAogICAgICAgICAqLwogICAgICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIXRoaXMuc2NoZW1hLnBhdHRlcm4pIHsKICAgICAgICAgICAgICAgIHRoaXMuc2NoZW1hLnBhdHRlcm4gPSBBbHBhY2EucmVnZXhwcy5pcHY0OwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtaXB2NCcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CgogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2hhbmRsZVZhbGlkYXRlCiAgICAgICAgICovCiAgICAgICAgaGFuZGxlVmFsaWRhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYmFzZVN0YXR1cyA9IHRoaXMuYmFzZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHZhbEluZm8gPSB0aGlzLnZhbGlkYXRpb247CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIXZhbEluZm9bImludmFsaWRQYXR0ZXJuIl1bInN0YXR1cyJdKSB7CiAgICAgICAgICAgICAgICB2YWxJbmZvWyJpbnZhbGlkUGF0dGVybiJdWyJtZXNzYWdlIl0gPSB0aGlzLnZpZXcuZ2V0TWVzc2FnZSgiaW52YWxpZElQdjQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGJhc2VTdGF0dXM7CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRTY2hlbWFPZlNjaGVtYQogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mU2NoZW1hOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHBhdHRlcm4gPSAodGhpcy5zY2hlbWEgJiYgdGhpcy5zY2hlbWEucGF0dGVybik/IHRoaXMuc2NoZW1hLnBhdHRlcm4gOiBBbHBhY2EucmVnZXhwcy5pcHY0OwogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAicGF0dGVybiI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlBhdHRlcm4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRmllbGQgUGF0dGVybiBpbiBSZWd1bGFyIEV4cHJlc3Npb24iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IHBhdHRlcm4sCiAgICAgICAgICAgICAgICAgICAgICAgICJyZWFkb25seSI6IHRydWUKICAgICAgICAgICAgICAgICAgICB9LCAgICAgICAgICAgICAgICAgICAgCgkJCQkJImZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJQcm9wZXJ0eSBkYXRhIGZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJlbnVtIjogWyJpcC1hZGRyZXNzIl0sCgkJCQkJCSJkZWZhdWx0IjoiaXAtYWRkcmVzcyIsCgkJCQkJCSJyZWFkb25seSI6dHJ1ZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldE9wdGlvbnNGb3JTY2hlbWEKICAgICAgICAgKi8KCQlnZXRPcHRpb25zRm9yU2NoZW1hOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSx7CgkJCQkiZmllbGRzIjogewoJCQkJCSJmb3JtYXQiOiB7CgkJCQkJCSJ0eXBlIjogInRleHQiCgkJCQkJfQoJCQkJfQoJCQl9KTsKICAgICAgICB9LAogICAgICAgIAogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0VGl0bGUKICAgICAgICAgKi8KICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiSVAgQWRkcmVzcyBGaWVsZCI7CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldERlc2NyaXB0aW9uCiAgICAgICAgICovCiAgICAgICAgZ2V0RGVzY3JpcHRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIklQIEFkZHJlc3MgRmllbGQuIjsKICAgICAgICB9LAoKCQkvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiaXB2NCI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKICAgIAogICAgQWxwYWNhLnJlZ2lzdGVyTWVzc2FnZXMoewogICAgICAgICJpbnZhbGlkSVB2NCI6ICJJbnZhbGlkIElQdjQgYWRkcmVzcywgZS5nLiAxOTIuMTY4LjAuMSIKICAgIH0pOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiaXB2NCIsIEFscGFjYS5GaWVsZHMuSVB2NEZpZWxkKTsKICAgIEFscGFjYS5yZWdpc3RlckRlZmF1bHRGb3JtYXRGaWVsZE1hcHBpbmcoImlwLWFkZHJlc3MiLCAiaXB2NCIpOwp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLkpTT05GaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEFyZWFGaWVsZC5leHRlbmQoCiAgICAvKioKICAgICAqIEBsZW5kcyBBbHBhY2EuRmllbGRzLkpTT05GaWVsZC5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5GaWVsZHMuVGV4dEFyZWFGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIEpTT04gY29udHJvbCBmb3IgY2h1bmsgb2YgdGV4dC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udGFpbmVyRmllbGQjZ2V0VmFsdWUKICAgICAgICAgKi8KICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgaWYgKEFscGFjYS5pc09iamVjdCh2YWx1ZSkgfHwgdHlwZW9mKHZhbHVlKSA9PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgdmFsdWUgPSBKU09OLnN0cmluZ2lmeSh2YWx1ZSwgbnVsbCwgMyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5iYXNlKHZhbHVlKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5Db250YWluZXJGaWVsZCNnZXRWYWx1ZQogICAgICAgICAqLwogICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIHZhciB2YWwgPSB0aGlzLmJhc2UoKTsKCiAgICAgICAgICAgIGlmICh2YWwgJiYgQWxwYWNhLmlzU3RyaW5nKHZhbCkpIHsKICAgICAgICAgICAgICAgIHZhbCA9IEpTT04ucGFyc2UodmFsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2hhbmRsZVZhbGlkYXRlCiAgICAgICAgICovCiAgICAgICAgaGFuZGxlVmFsaWRhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYmFzZVN0YXR1cyA9IHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgdmFyIHZhbEluZm8gPSB0aGlzLnZhbGlkYXRpb247CgoJCQl2YXIgc3RhdHVzID0gdGhpcy5fdmFsaWRhdGVKU09OKCk7CiAgICAgICAgICAgIHZhbEluZm9bInN0cmluZ05vdEFKU09OIl0gPSB7CiAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHN0YXR1cy5zdGF0dXMgPyAiIiA6IHRoaXMudmlldy5nZXRNZXNzYWdlKCJzdHJpbmdOb3RBSlNPTiIpICsiICIrIHN0YXR1cy5tZXNzYWdlLAogICAgICAgICAgICAgICAgInN0YXR1cyI6IHN0YXR1cy5zdGF0dXMKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBiYXNlU3RhdHVzICYmIHZhbEluZm9bInN0cmluZ05vdEFKU09OIl1bInN0YXR1cyJdIDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBWYWxpZGF0ZXMgaWYgaXQgaXMgYSB2YWxpZCBKU09OIG9iamVjdC4KICAgICAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gdHJ1ZSBpZiBpdCBpcyBhIHZhbGlkIEpTT04gb2JqZWN0CiAgICAgICAgICovCiAgICAgICAgX3ZhbGlkYXRlSlNPTjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB0ZXh0VmFsdWUgPSB0aGlzLmZpZWxkLnZhbCgpOwogICAgICAgICAgICAvLyBhbGxvdyBudWxsCiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNWYWxFbXB0eSh0ZXh0VmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiIDogdHJ1ZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gcGFyc2UgdGhlIHN0cmluZwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdmFyIG9iaiA9IEpTT04ucGFyc2UodGV4dFZhbHVlKTsKICAgICAgICAgICAgICAgIC8vIGZvcm1hdCB0aGUgc3RyaW5nIGFzIHdlbGwKICAgICAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUoSlNPTi5zdHJpbmdpZnkob2JqLCBudWxsLCAzKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiIDogdHJ1ZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiIDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgIm1lc3NhZ2UiIDogZS5tZXNzYWdlCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRBcmVhRmllbGQjcG9zdFJlbmRlcgogICAgICAgICAqLwogICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gU29tZSBhdXRvLWZvcm1hdHRpbmcgY2FwYWJpbGl0aWVzCiAgICAgICAgICAgICAgICAgICAgc2VsZi5maWVsZC5iaW5kKCdrZXlwcmVzcycsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhlLndoaWNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUud2hpY2ggPT0gMzQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGQuaW5zZXJ0QXRDYXJldCgnIicpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlLndoaWNoID09IDEyMykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5maWVsZC5pbnNlcnRBdENhcmV0KCd9Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUud2hpY2ggPT0gOTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGQuaW5zZXJ0QXRDYXJldCgnXScpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5maWVsZC5iaW5kKCdrZXlwcmVzcycsICdDdHJsK2wnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5nZXRFbCgpLnJlbW92ZUNsYXNzKCJhbHBhY2EtZmllbGQtZm9jdXNlZCIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2V0IGNsYXNzIGZyb20gc3RhdGUKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5yZWZyZXNoVmFsaWRhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5maWVsZC5hdHRyKCd0aXRsZScsJ1R5cGUgQ3RybCtMIHRvIGZvcm1hdCBhbmQgdmFsaWRhdGUgdGhlIEpTT04gc3RyaW5nLicpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChzZWxmLmZpZWxkQ29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5maWVsZENvbnRhaW5lci5hZGRDbGFzcygnYWxwYWNhLWNvbnRyb2xmaWVsZC1qc29uJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKCiAgICAgICAgICAgIH0pOwoKICAgICAgICB9LC8vX19CVUlMREVSX0hFTFBFUlMKCgkJLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRBcmVhRmllbGQjZ2V0VGl0bGUKCQkgKi8KCQlnZXRUaXRsZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAiSlNPTiBFZGl0b3IiOwoJCX0sCgoJCS8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0QXJlYUZpZWxkI2dldERlc2NyaXB0aW9uCgkJICovCgkJZ2V0RGVzY3JpcHRpb246IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gIkVkaXRvciBmb3IgSlNPTiBvYmplY3RzIHdpdGggYmFzaWMgdmFsaWRhdGlvbiBhbmQgZm9ybWF0dGluZy4iOwoJCX0sCgoJCS8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0QXJlYUZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAianNvbiI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKCiAgICAvLyBBZGRpdGlvbmFsIFJlZ2lzdHJhdGlvbnMKICAgIEFscGFjYS5yZWdpc3Rlck1lc3NhZ2VzKHsKICAgICAgICAic3RyaW5nTm90QUpTT04iOiAiVGhpcyB2YWx1ZSBpcyBub3QgYSB2YWxpZCBKU09OIHN0cmluZy4iCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJGaWVsZENsYXNzKCJqc29uIiwgQWxwYWNhLkZpZWxkcy5KU09ORmllbGQpOwoKICAgICQuZm4uaW5zZXJ0QXRDYXJldCA9IGZ1bmN0aW9uIChteVZhbHVlKSB7CgogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAvL0lFIHN1cHBvcnQKICAgICAgICAgICAgaWYgKGRvY3VtZW50LnNlbGVjdGlvbikgewoKICAgICAgICAgICAgICAgIHRoaXMuZm9jdXMoKTsKICAgICAgICAgICAgICAgIHNlbCA9IGRvY3VtZW50LnNlbGVjdGlvbi5jcmVhdGVSYW5nZSgpOwogICAgICAgICAgICAgICAgc2VsLnRleHQgPSBteVZhbHVlOwogICAgICAgICAgICAgICAgdGhpcy5mb2N1cygpOwoKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnNlbGVjdGlvblN0YXJ0IHx8IHRoaXMuc2VsZWN0aW9uU3RhcnQgPT0gJzAnKSB7CgogICAgICAgICAgICAgICAgLy9NT1pJTExBIC8gTkVUU0NBUEUgc3VwcG9ydAogICAgICAgICAgICAgICAgdmFyIHN0YXJ0UG9zID0gdGhpcy5zZWxlY3Rpb25TdGFydDsKICAgICAgICAgICAgICAgIHZhciBlbmRQb3MgPSB0aGlzLnNlbGVjdGlvbkVuZDsKICAgICAgICAgICAgICAgIHZhciBzY3JvbGxUb3AgPSB0aGlzLnNjcm9sbFRvcDsKICAgICAgICAgICAgICAgIHRoaXMudmFsdWUgPSB0aGlzLnZhbHVlLnN1YnN0cmluZygwLCBzdGFydFBvcykgKyBteVZhbHVlICsgdGhpcy52YWx1ZS5zdWJzdHJpbmcoZW5kUG9zLCB0aGlzLnZhbHVlLmxlbmd0aCk7CiAgICAgICAgICAgICAgICB0aGlzLmZvY3VzKCk7CiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGlvblN0YXJ0ID0gc3RhcnRQb3MgLyorIG15VmFsdWUubGVuZ3RoKi87CiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGlvbkVuZCA9IHN0YXJ0UG9zIC8qKyBteVZhbHVlLmxlbmd0aCovOwogICAgICAgICAgICAgICAgdGhpcy5zY3JvbGxUb3AgPSBzY3JvbGxUb3A7CgogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIHRoaXMudmFsdWUgKz0gbXlWYWx1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZm9jdXMoKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfTsKLyoKICogalF1ZXJ5IEhvdGtleXMgUGx1Z2luCiAqIENvcHlyaWdodCAyMDEwLCBKb2huIFJlc2lnCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBvciBHUEwgVmVyc2lvbiAyIGxpY2Vuc2VzLgogKgogKiBCYXNlZCB1cG9uIHRoZSBwbHVnaW4gYnkgVHp1cnkgQmFyIFlvY2hheToKICogaHR0cDovL2dpdGh1Yi5jb20vdHp1cnlieS9ob3RrZXlzCiAqCiAqIE9yaWdpbmFsIGlkZWEgYnk6CiAqIEJpbm55IFYgQSwgaHR0cDovL3d3dy5vcGVuanMuY29tL3NjcmlwdHMvZXZlbnRzL2tleWJvYXJkX3Nob3J0Y3V0cy8KKi8KICAgIGpRdWVyeS5ob3RrZXlzID0gewogICAgICAgIHZlcnNpb246ICIwLjgiLAoKICAgICAgICBzcGVjaWFsS2V5czogewogICAgICAgICAgICA4OiAiYmFja3NwYWNlIiwgOTogInRhYiIsIDEzOiAicmV0dXJuIiwgMTY6ICJzaGlmdCIsIDE3OiAiY3RybCIsIDE4OiAiYWx0IiwgMTk6ICJwYXVzZSIsCiAgICAgICAgICAgIDIwOiAiY2Fwc2xvY2siLCAyNzogImVzYyIsIDMyOiAic3BhY2UiLCAzMzogInBhZ2V1cCIsIDM0OiAicGFnZWRvd24iLCAzNTogImVuZCIsIDM2OiAiaG9tZSIsCiAgICAgICAgICAgIDM3OiAibGVmdCIsIDM4OiAidXAiLCAzOTogInJpZ2h0IiwgNDA6ICJkb3duIiwgNDU6ICJpbnNlcnQiLCA0NjogImRlbCIsCiAgICAgICAgICAgIDk2OiAiMCIsIDk3OiAiMSIsIDk4OiAiMiIsIDk5OiAiMyIsIDEwMDogIjQiLCAxMDE6ICI1IiwgMTAyOiAiNiIsIDEwMzogIjciLAogICAgICAgICAgICAxMDQ6ICI4IiwgMTA1OiAiOSIsIDEwNjogIioiLCAxMDc6ICIrIiwgMTA5OiAiLSIsIDExMDogIi4iLCAxMTEgOiAiLyIsCiAgICAgICAgICAgIDExMjogImYxIiwgMTEzOiAiZjIiLCAxMTQ6ICJmMyIsIDExNTogImY0IiwgMTE2OiAiZjUiLCAxMTc6ICJmNiIsIDExODogImY3IiwgMTE5OiAiZjgiLAogICAgICAgICAgICAxMjA6ICJmOSIsIDEyMTogImYxMCIsIDEyMjogImYxMSIsIDEyMzogImYxMiIsIDE0NDogIm51bWxvY2siLCAxNDU6ICJzY3JvbGwiLCAxOTE6ICIvIiwgMjI0OiAibWV0YSIKICAgICAgICB9LAoKICAgICAgICBzaGlmdE51bXM6IHsKICAgICAgICAgICAgImAiOiAifiIsICIxIjogIiEiLCAiMiI6ICJAIiwgIjMiOiAiIyIsICI0IjogIiQiLCAiNSI6ICIlIiwgIjYiOiAiXiIsICI3IjogIiYiLAogICAgICAgICAgICAiOCI6ICIqIiwgIjkiOiAiKCIsICIwIjogIikiLCAiLSI6ICJfIiwgIj0iOiAiKyIsICI7IjogIjogIiwgIiciOiAiXCIiLCAiLCI6ICI8IiwKICAgICAgICAgICAgIi4iOiAiPiIsICAiLyI6ICI/IiwgICJcXCI6ICJ8IgogICAgICAgIH0KICAgIH07CgogICAgZnVuY3Rpb24ga2V5SGFuZGxlciggaGFuZGxlT2JqICkgewogICAgICAgIC8vIE9ubHkgY2FyZSB3aGVuIGEgcG9zc2libGUgaW5wdXQgaGFzIGJlZW4gc3BlY2lmaWVkCiAgICAgICAgaWYgKCB0eXBlb2YgaGFuZGxlT2JqLmRhdGEgIT09ICJzdHJpbmciICkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgb3JpZ0hhbmRsZXIgPSBoYW5kbGVPYmouaGFuZGxlciwKICAgICAgICAgICAga2V5cyA9IGhhbmRsZU9iai5kYXRhLnRvTG93ZXJDYXNlKCkuc3BsaXQoIiAiKTsKCiAgICAgICAgaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CiAgICAgICAgICAgIC8vIERvbid0IGZpcmUgaW4gdGV4dC1hY2NlcHRpbmcgaW5wdXRzIHRoYXQgd2UgZGlkbid0IGRpcmVjdGx5IGJpbmQgdG8KICAgICAgICAgICAgaWYgKCB0aGlzICE9PSBldmVudC50YXJnZXQgJiYgKC90ZXh0YXJlYXxzZWxlY3QvaS50ZXN0KCBldmVudC50YXJnZXQubm9kZU5hbWUgKSB8fAogICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC50eXBlID09PSAidGV4dCIpICkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBLZXlwcmVzcyByZXByZXNlbnRzIGNoYXJhY3RlcnMsIG5vdCBzcGVjaWFsIGtleXMKICAgICAgICAgICAgdmFyIHNwZWNpYWwgPSBldmVudC50eXBlICE9PSAia2V5cHJlc3MiICYmIGpRdWVyeS5ob3RrZXlzLnNwZWNpYWxLZXlzWyBldmVudC53aGljaCBdLAogICAgICAgICAgICAgICAgY2hhcmFjdGVyID0gU3RyaW5nLmZyb21DaGFyQ29kZSggZXZlbnQud2hpY2ggKS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAgICAga2V5LCBtb2RpZiA9ICIiLCBwb3NzaWJsZSA9IHt9OwoKICAgICAgICAgICAgLy8gY2hlY2sgY29tYmluYXRpb25zIChhbHR8Y3RybHxzaGlmdCthbnl0aGluZykKICAgICAgICAgICAgaWYgKCBldmVudC5hbHRLZXkgJiYgc3BlY2lhbCAhPT0gImFsdCIgKSB7CiAgICAgICAgICAgICAgICBtb2RpZiArPSAiYWx0KyI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICggZXZlbnQuY3RybEtleSAmJiBzcGVjaWFsICE9PSAiY3RybCIgKSB7CiAgICAgICAgICAgICAgICBtb2RpZiArPSAiY3RybCsiOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUT0RPOiBOZWVkIHRvIG1ha2Ugc3VyZSB0aGlzIHdvcmtzIGNvbnNpc3RlbnRseSBhY3Jvc3MgcGxhdGZvcm1zCiAgICAgICAgICAgIGlmICggZXZlbnQubWV0YUtleSAmJiAhZXZlbnQuY3RybEtleSAmJiBzcGVjaWFsICE9PSAibWV0YSIgKSB7CiAgICAgICAgICAgICAgICBtb2RpZiArPSAibWV0YSsiOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIGV2ZW50LnNoaWZ0S2V5ICYmIHNwZWNpYWwgIT09ICJzaGlmdCIgKSB7CiAgICAgICAgICAgICAgICBtb2RpZiArPSAic2hpZnQrIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCBzcGVjaWFsICkgewogICAgICAgICAgICAgICAgcG9zc2libGVbIG1vZGlmICsgc3BlY2lhbCBdID0gdHJ1ZTsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwb3NzaWJsZVsgbW9kaWYgKyBjaGFyYWN0ZXIgXSA9IHRydWU7CiAgICAgICAgICAgICAgICBwb3NzaWJsZVsgbW9kaWYgKyBqUXVlcnkuaG90a2V5cy5zaGlmdE51bXNbIGNoYXJhY3RlciBdIF0gPSB0cnVlOwoKICAgICAgICAgICAgICAgIC8vICIkIiBjYW4gYmUgdHJpZ2dlcmVkIGFzICJTaGlmdCs0IiBvciAiU2hpZnQrJCIgb3IganVzdCAiJCIKICAgICAgICAgICAgICAgIGlmICggbW9kaWYgPT09ICJzaGlmdCsiICkgewogICAgICAgICAgICAgICAgICAgIHBvc3NpYmxlWyBqUXVlcnkuaG90a2V5cy5zaGlmdE51bXNbIGNoYXJhY3RlciBdIF0gPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKCB2YXIgaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKICAgICAgICAgICAgICAgIGlmICggcG9zc2libGVbIGtleXNbaV0gXSApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3JpZ0hhbmRsZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0KCiAgICBqUXVlcnkuZWFjaChbICJrZXlkb3duIiwgImtleXVwIiwgImtleXByZXNzIiBdLCBmdW5jdGlvbigpIHsKICAgICAgICBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdGhpcyBdID0geyBhZGQ6IGtleUhhbmRsZXIgfTsKICAgIH0pOwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5JbnRlZ2VyRmllbGQgPSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuSW50ZWdlckZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkZpZWxkcy5OdW1iZXJGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIENvbnRyb2wgZm9yIGludGVnZXJzLiBJZiBqUXVlcnkgVUkgaXMgZW5hYmxlZCwgaXQgY2FuIGFsc28gYmUKICAgICAgICAgKiB0dXJuZWQgaW50byBhIHNsaWRlci4KICAgICAgICAgKjxwPgogICAgICAgICAqIFRoZSBmb2xsb3dpbmcgYWRkaXRpb25hbCBKU09OIFNjaGVtYSBwcm9wZXJ0aWVzIGFyZSBzdXBwb3J0ZWQ6CiAgICAgICAgICo8cC8+CiAgICAgICAgICo8Y29kZT4KICAgICAgICAgKiAgICAgPHByZT4KICAgICAgICAgKiB7CiAgICAgICAgICogICAgbWluaW11bToge251bWJlcn0sCiAgICAgICAgICogICAgbWF4aW11bToge251bWJlcn0sCiAgICAgICAgICogICAgbWluaW11bUNhbkVxdWFsOiB7Ym9vbGVhbn0sCiAgICAgICAgICogICAgbWF4aW11bUNhbkVxdWFsOiB7Ym9vbGVhbn0sCiAgICAgICAgICogICAgZGl2aXNpYmxlQnk6IHtudW1iZXJ9CiAgICAgICAgICogfQogICAgICAgICAqIDwvcHJlPgogICAgICAgICAqIDwvY29kZT4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2dldFZhbHVlCiAgICAgICAgICovCiAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgdGV4dFZhbHVlID0gdGhpcy5maWVsZC52YWwoKTsKICAgICAgICAgICAgaWYgKEFscGFjYS5pc1ZhbEVtcHR5KHRleHRWYWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZUludCh0ZXh0VmFsdWUsIDEwKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkI29uQ2hhbmdlCiAgICAgICAgICovCiAgICAgICAgb25DaGFuZ2U6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CiAgICAgICAgICAgIGlmICh0aGlzLnNsaWRlcikgewogICAgICAgICAgICAgICAgdGhpcy5zbGlkZXIuc2xpZGVyKCJ2YWx1ZSIsIHRoaXMuZ2V0VmFsdWUoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuTnVtYmVyRmllbGQjcG9zdFJlbmRlcgogICAgICAgICAqLwogICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgdGhpcy5iYXNlKGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMuc2xpZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFBbHBhY2EuaXNFbXB0eShzZWxmLnNjaGVtYS5tYXhpbXVtKSAmJiAhQWxwYWNhLmlzRW1wdHkoc2VsZi5zY2hlbWEubWluaW11bSkpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLmZpZWxkKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkLmFmdGVyKCc8ZGl2IGlkPSJzbGlkZXIiPjwvZGl2PicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zbGlkZXIgPSAkKCcjc2xpZGVyJywgc2VsZi5maWVsZC5wYXJlbnQoKSkuc2xpZGVyKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogc2VsZi5nZXRWYWx1ZSgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbjogc2VsZi5zY2hlbWEubWluaW11bSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXg6IHNlbGYuc2NoZW1hLm1heGltdW0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGU6IGZ1bmN0aW9uKGV2ZW50LCB1aSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNldFZhbHVlKHVpLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5yZWZyZXNoVmFsaWRhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLWludGVnZXInKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwoKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2hhbmRsZVZhbGlkYXRlCiAgICAgICAgICovCiAgICAgICAgaGFuZGxlVmFsaWRhdGU6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgdmFyIGJhc2VTdGF0dXMgPSB0aGlzLmJhc2UoKTsKCiAgICAgICAgICAgIHZhciB2YWxJbmZvID0gdGhpcy52YWxpZGF0aW9uOwoKICAgICAgICAgICAgaWYgKCF2YWxJbmZvWyJzdHJpbmdOb3RBTnVtYmVyIl1bInN0YXR1cyJdKSB7CiAgICAgICAgICAgICAgICB2YWxJbmZvWyJzdHJpbmdOb3RBTnVtYmVyIl1bIm1lc3NhZ2UiXSA9IHRoaXMudmlldy5nZXRNZXNzYWdlKCJzdHJpbmdOb3RBbkludGVnZXIiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGJhc2VTdGF0dXM7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaWRhdGVzIGlmIGl0IGlzIGFuIGludGVnZXIuCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IHRydWUgaWYgaXQgaXMgYW4gaW50ZWdlcgogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZU51bWJlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB0ZXh0VmFsdWUgPSB0aGlzLmZpZWxkLnZhbCgpOwoKICAgICAgICAgICAgaWYgKEFscGFjYS5pc1ZhbEVtcHR5KHRleHRWYWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgZmxvYXRWYWx1ZSA9IHRoaXMuZ2V0VmFsdWUoKTsKCiAgICAgICAgICAgIC8vIHF1aWNrIGNoZWNrIHRvIHNlZSBpZiB3aGF0IHRoZXkgZW50ZXJlZCB3YXMgYSBudW1iZXIKICAgICAgICAgICAgaWYgKGlzTmFOKGZsb2F0VmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGNoZWNrIGlmIHZhbGlkIG51bWJlciBmb3JtYXQKICAgICAgICAgICAgaWYgKCF0ZXh0VmFsdWUubWF0Y2goQWxwYWNhLnJlZ2V4cHMuaW50ZWdlcikpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2dldFNjaGVtYU9mU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZTY2hlbWE6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAibWluaW11bSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIk1pbmltdW0iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiTWluaW11bSB2YWx1ZSBvZiB0aGUgcHJvcGVydHkuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJtYXhpbXVtIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiTWF4aW11bSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJNYXhpbXVtIHZhbHVlIG9mIHRoZSBwcm9wZXJ0eS4iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImRpdmlzaWJsZUJ5IjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRGl2aXNpYmxlIEJ5IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIlByb3BlcnR5IHZhbHVlIG11c3QgYmUgZGl2aXNpYmxlIGJ5IHRoaXMgbnVtYmVyLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5OdW1iZXJGaWVsZCNnZXRPcHRpb25zRm9yU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0ZvclNjaGVtYTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgIm1pbmltdW0iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJoZWxwZXIiOiAiTWluaW11bSB2YWx1ZSBvZiB0aGUgZmllbGQuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJtYXhpbXVtIjogewogICAgICAgICAgICAgICAgICAgICAgICAiaGVscGVyIjogIk1heGltdW0gdmFsdWUgb2YgdGhlIGZpZWxkLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZGl2aXNpYmxlQnkiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJoZWxwZXIiOiAiUHJvcGVydHkgdmFsdWUgbXVzdCBiZSBkaXZpc2libGUgYnkgdGhpcyBudW1iZXIuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2dldFNjaGVtYU9mT3B0aW9ucwogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICJzbGlkZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJTbGlkZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiR2VuZXJhdGUgalF1ZXJ5IFVJIHNsaWRlciBjb250cm9sIHdpdGggdGhlIGZpZWxkIGlmIHRydWUuIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogZmFsc2UKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2dldE9wdGlvbnNGb3JPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0Zvck9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICJzbGlkZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJyaWdodExhYmVsIjogIlNsaWRlciBjb250cm9sID8iLAogICAgICAgICAgICAgICAgICAgICAgICAiaGVscGVyIjogIkdlbmVyYXRlIHNsaWRlciBjb250cm9sIGlmIHNlbGVjdGVkLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLk51bWJlckZpZWxkI2dldFRpdGxlCiAgICAgICAgICovCiAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIkludGVnZXIgRmllbGQiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5OdW1iZXJGaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJGaWVsZCBmb3IgaW50ZWdlcnMuIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuTnVtYmVyRmllbGQjZ2V0VHlwZQogICAgICAgICAqLwogICAgICAgIGdldFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gImludGVnZXIiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5OdW1iZXJGaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRGaWVsZFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gImludGVnZXIiOwogICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgfSk7CgogICAgLy8gQWRkaXRpb25hbCBSZWdpc3RyYXRpb25zCiAgICBBbHBhY2EucmVnaXN0ZXJNZXNzYWdlcyh7CiAgICAgICAgInN0cmluZ05vdEFuSW50ZWdlciI6ICJUaGlzIHZhbHVlIGlzIG5vdCBhbiBpbnRlZ2VyLiIKICAgIH0pOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiaW50ZWdlciIsIEFscGFjYS5GaWVsZHMuSW50ZWdlckZpZWxkKTsKICAgIEFscGFjYS5yZWdpc3RlckRlZmF1bHRTY2hlbWFGaWVsZE1hcHBpbmcoImludGVnZXIiLCAiaW50ZWdlciIpOwp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLkxvd2VyQ2FzZUZpZWxkID0gQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQuZXh0ZW5kKAogICAgLyoqCiAgICAgKiBAbGVuZHMgQWxwYWNhLkZpZWxkcy5Mb3dlckNhc2VGaWVsZC5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkCiAgICAgICAgICoKICAgICAgICAgKiBAY2xhc3MgQ29udHJvbCBmb3IgbG93ZXIgY2FzZSB0ZXh0LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IGRhdGEgRmllbGQgZGF0YS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBGaWVsZCBvcHRpb25zLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBGaWVsZCB2aWV3LgogICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbm5lY3Rvcn0gY29ubmVjdG9yIEZpZWxkIGNvbm5lY3Rvci4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI3Bvc3RSZW5kZXIKICAgICAgICAgKi8KICAgICAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbihjYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtbG93ZXJjYXNlJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjc2V0VmFsdWUKICAgICAgICAgKi8KICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgIHZhciBsb3dlclZhbHVlID0gdmFsLnRvTG93ZXJDYXNlKCk7CgogICAgICAgICAgICBpZiAobG93ZXJWYWx1ZSAhPSB0aGlzLmdldFZhbHVlKCkpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFzZShsb3dlclZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRyb2xGaWVsZCNvbktleVByZXNzCiAgICAgICAgICovCiAgICAgICAgb25LZXlQcmVzczogZnVuY3Rpb24oZSkgewogICAgICAgICAgICB0aGlzLmJhc2UoZSk7CgogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgQWxwYWNhLmxhdGVyKDI1LCB0aGlzLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciB2ID0gX3RoaXMuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgICAgIF90aGlzLnNldFZhbHVlKHYpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LC8vX19CVUlMREVSX0hFTFBFUlMKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRUaXRsZQogICAgICAgICAqLwogICAgICAgIGdldFRpdGxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJMb3dlcmNhc2UgVGV4dCI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJUZXh0IGZpZWxkIGZvciBsb3dlcmNhc2UgdGV4dC4iOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RmllbGRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJsb3dlcmNhc2UiOwogICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygibG93ZXJjYXNlIiwgQWxwYWNhLkZpZWxkcy5Mb3dlckNhc2VGaWVsZCk7CiAgICBBbHBhY2EucmVnaXN0ZXJEZWZhdWx0Rm9ybWF0RmllbGRNYXBwaW5nKCJsb3dlcmNhc2UiLCAibG93ZXJjYXNlIik7Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLk1hcEZpZWxkID0gQWxwYWNhLkZpZWxkcy5BcnJheUZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuTWFwRmllbGQucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuRmllbGRzLlRleHRBcmVhRmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBKU09OIGNvbnRyb2wgZm9yIGNodW5rIG9mIHRleHQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0QXJlYUZpZWxkI3NldHVwCiAgICAgICAgICovCiAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CgogICAgICAgICAgICBBbHBhY2EubWVyZ2VPYmplY3QodGhpcy5vcHRpb25zLCB7CiAgICAgICAgICAgICAgICAiZm9yY2VSZXZhbGlkYXRpb24iIDogdHJ1ZQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNFbXB0eSh0aGlzLmRhdGEpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghQWxwYWNhLmlzQXJyYXkodGhpcy5kYXRhKSkgewoKICAgICAgICAgICAgICAgIGlmIChBbHBhY2EuaXNPYmplY3QodGhpcy5kYXRhKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBuZXdEYXRhID0gW107CiAgICAgICAgICAgICAgICAgICAgJC5lYWNoKHRoaXMuZGF0YSwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3VmFsdWUgPSBBbHBhY2EuY29weU9mKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgbmV3VmFsdWVbIl9rZXkiXSA9IGtleTsKICAgICAgICAgICAgICAgICAgICAgICAgbmV3RGF0YS5wdXNoKG5ld1ZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRhdGEgPSBuZXdEYXRhOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udGFpbmVyRmllbGQjZ2V0VmFsdWUKICAgICAgICAgKi8KICAgICAgICBnZXRWYWx1ZTogZnVuY3Rpb24oKQogICAgICAgIHsKICAgICAgICAgICAgLy8gaWYgd2UgZG9uJ3QgaGF2ZSBhbnkgY2hpbGRyZW4gYW5kIHdlJ3JlIG5vdCByZXF1aXJlZCwgaGFuZCBiYWNrIHVuZGVmaW5lZAogICAgICAgICAgICBpZiAodGhpcy5jaGlsZHJlbi5sZW5ndGggPT09IDAgJiYgIXRoaXMuc2NoZW1hLnJlcXVpcmVkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBvID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHYgPSB0aGlzLmNoaWxkcmVuW2ldLmdldFZhbHVlKCk7CiAgICAgICAgICAgICAgICB2YXIga2V5ID0gdlsiX2tleSJdOwogICAgICAgICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB2WyJfa2V5Il07CiAgICAgICAgICAgICAgICAgICAgb1trZXldID0gdjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbzsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2hhbmRsZVZhbGlkYXRlCiAgICAgICAgICovCiAgICAgICAgaGFuZGxlVmFsaWRhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYmFzZVN0YXR1cyA9IHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgdmFyIHZhbEluZm8gPSB0aGlzLnZhbGlkYXRpb247CgogICAgICAgICAgICB2YXIgaXNWYWxpZE1hcEtleXNOb3RFbXB0eSA9IHRoaXMuX3ZhbGlkYXRlTWFwS2V5c05vdEVtcHR5KCk7CiAgICAgICAgICAgIHZhbEluZm9bImtleU1pc3NpbmciXSA9IHsKICAgICAgICAgICAgICAgICJtZXNzYWdlIjogaXNWYWxpZE1hcEtleXNOb3RFbXB0eSA/ICIiIDogdGhpcy52aWV3LmdldE1lc3NhZ2UoImtleU1pc3NpbmciKSwKICAgICAgICAgICAgICAgICJzdGF0dXMiOiBpc1ZhbGlkTWFwS2V5c05vdEVtcHR5CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgaXNWYWxpZE1hcEtleXNVbmlxdWUgPSB0aGlzLl92YWxpZGF0ZU1hcEtleXNVbmlxdWUoKTsKICAgICAgICAgICAgdmFsSW5mb1sia2V5Tm90VW5pcXVlIl0gPSB7CiAgICAgICAgICAgICAgICAibWVzc2FnZSI6IGlzVmFsaWRNYXBLZXlzVW5pcXVlID8gIiIgOiB0aGlzLnZpZXcuZ2V0TWVzc2FnZSgia2V5Tm90VW5pcXVlIiksCiAgICAgICAgICAgICAgICAic3RhdHVzIjogaXNWYWxpZE1hcEtleXNVbmlxdWUKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBiYXNlU3RhdHVzICYmIHZhbEluZm9bImtleU1pc3NpbmciXVsic3RhdHVzIl0gJiYgdmFsSW5mb1sia2V5Tm90VW5pcXVlIl1bInN0YXR1cyJdOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFZhbGlkYXRlcyBpZiBrZXkgZmllbGRzIGFyZSB1bmlxdWUuCiAgICAgICAgICogQHJldHVybnMge0Jvb2xlYW59IHRydWUgaWYga2V5cyBhcmUgdW5pcXVlCiAgICAgICAgICovCiAgICAgICAgX3ZhbGlkYXRlTWFwS2V5c05vdEVtcHR5OiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIHZhciBpc1ZhbGlkID0gdHJ1ZTsKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHYgPSB0aGlzLmNoaWxkcmVuW2ldLmdldFZhbHVlKCk7CiAgICAgICAgICAgICAgICB2YXIga2V5ID0gdlsiX2tleSJdOwoKICAgICAgICAgICAgICAgIGlmICgha2V5KSB7CiAgICAgICAgICAgICAgICAgICAgaXNWYWxpZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gaXNWYWxpZDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBWYWxpZGF0ZXMgaWYga2V5IGZpZWxkcyBhcmUgdW5pcXVlLgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSB0cnVlIGlmIGtleXMgYXJlIHVuaXF1ZQogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZU1hcEtleXNVbmlxdWU6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgdmFyIGlzVmFsaWQgPSB0cnVlOwoKICAgICAgICAgICAgdmFyIGtleXMgPSB7fTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgdiA9IHRoaXMuY2hpbGRyZW5baV0uZ2V0VmFsdWUoKTsKICAgICAgICAgICAgICAgIHZhciBrZXkgPSB2WyJfa2V5Il07CgogICAgICAgICAgICAgICAgaWYgKGtleXNba2V5XSkgewogICAgICAgICAgICAgICAgICAgIGlzVmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBrZXlzW2tleV0gPSBrZXk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBpc1ZhbGlkOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0QXJlYUZpZWxkI3Bvc3RSZW5kZXIKICAgICAgICAgKi8KICAgICAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbihjYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtbWFwJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgfSk7CgogICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoKCQkvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEFyZWFGaWVsZCNnZXRUaXRsZQoJCSAqLwoJCWdldFRpdGxlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICJNYXAgRmllbGQiOwoJCX0sCgoJCS8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0QXJlYUZpZWxkI2dldERlc2NyaXB0aW9uCgkJICovCgkJZ2V0RGVzY3JpcHRpb246IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gIkZpZWxkIGZvciBvYmplY3RzIHdpdGgga2V5L3ZhbHVlIHBhaXJzIHRoYXQgc2hhcmUgdGhlIHNhbWUgc2NoZW1hIGZvciB2YWx1ZXMuIjsKCQl9LAoKCQkvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEFyZWFGaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRGaWVsZFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIm1hcCI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJGaWVsZENsYXNzKCJtYXAiLCBBbHBhY2EuRmllbGRzLk1hcEZpZWxkKTsKCiAgICAvLyBBZGRpdGlvbmFsIFJlZ2lzdHJhdGlvbnMKICAgIEFscGFjYS5yZWdpc3Rlck1lc3NhZ2VzKHsKICAgICAgICAia2V5Tm90VW5pcXVlIjogIktleXMgb2YgbWFwIGZpZWxkIGFyZSBub3QgdW5pcXVlLiIsCiAgICAgICAgImtleU1pc3NpbmciOiAiTWFwIGNvbnRhaW5zIGFuIGVtcHR5IGtleS4iCiAgICB9KTsKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5QYXNzd29yZEZpZWxkID0gQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQuZXh0ZW5kKAogICAgLyoqCiAgICAgKiBAbGVuZHMgQWxwYWNhLkZpZWxkcy5QYXNzd29yZEZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBDb250cm9sIGZvciBKU09OIHNjaGVtYSBwYXNzd29yZCBmb3JtYXQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjc2V0dXAKICAgICAgICAgKi8KICAgICAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCF0aGlzLnNjaGVtYS5wYXR0ZXJuKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNjaGVtYS5wYXR0ZXJuID0gQWxwYWNhLnJlZ2V4cHMucGFzc3dvcmQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuY29udHJvbEZpZWxkVGVtcGxhdGVEZXNjcmlwdG9yID0gdGhpcy52aWV3LmdldFRlbXBsYXRlRGVzY3JpcHRvcigiY29udHJvbEZpZWxkUGFzc3dvcmQiKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI3Bvc3RSZW5kZXIKICAgICAgICAgKi8KICAgICAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbihjYWxsYmFjaykgewoKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgdGhpcy5iYXNlKGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgIGlmIChzZWxmLmZpZWxkQ29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5maWVsZENvbnRhaW5lci5hZGRDbGFzcygnYWxwYWNhLWNvbnRyb2xmaWVsZC1wYXNzd29yZCcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjaGFuZGxlVmFsaWRhdGUKICAgICAgICAgKi8KICAgICAgICBoYW5kbGVWYWxpZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBiYXNlU3RhdHVzID0gdGhpcy5iYXNlKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgdmFsSW5mbyA9IHRoaXMudmFsaWRhdGlvbjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghdmFsSW5mb1siaW52YWxpZFBhdHRlcm4iXVsic3RhdHVzIl0pIHsKICAgICAgICAgICAgICAgIHZhbEluZm9bImludmFsaWRQYXR0ZXJuIl1bIm1lc3NhZ2UiXSA9IHRoaXMudmlldy5nZXRNZXNzYWdlKCJpbnZhbGlkUGFzc3dvcmQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGJhc2VTdGF0dXM7CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRTY2hlbWFPZlNjaGVtYQogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mU2NoZW1hOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHBhdHRlcm4gPSAodGhpcy5zY2hlbWEgJiYgdGhpcy5zY2hlbWEucGF0dGVybik/IHRoaXMuc2NoZW1hLnBhdHRlcm4gOiAvXlswLTlhLXpBLVpceDIwLVx4N0VdKiQvOwogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAicGF0dGVybiI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlBhdHRlcm4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiRmllbGQgUGF0dGVybiBpbiBSZWd1bGFyIEV4cHJlc3Npb24iLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IHRoaXMuc2NoZW1hLnBhdHRlcm4sCiAgICAgICAgICAgICAgICAgICAgICAgICJlbnVtIjpbcGF0dGVybl0sCiAgICAgICAgICAgICAgICAgICAgICAgICJyZWFkb25seSI6IHRydWUKICAgICAgICAgICAgICAgICAgICB9LCAgICAgICAgICAgICAgICAgICAgCgkJCQkJImZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJQcm9wZXJ0eSBkYXRhIGZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCgkJCQkJCSJkZWZhdWx0IjoicGFzc3dvcmQiLAogICAgICAgICAgICAgICAgICAgICAgICAiZW51bSI6WyJwYXNzd29yZCJdLAoJCQkJCQkicmVhZG9ubHkiOnRydWUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRPcHRpb25zRm9yU2NoZW1hCiAgICAgICAgICovCgkJZ2V0T3B0aW9uc0ZvclNjaGVtYTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksewoJCQkJImZpZWxkcyI6IHsKCQkJCQkiZm9ybWF0IjogewoJCQkJCQkidHlwZSI6ICJ0ZXh0IgoJCQkJCX0KCQkJCX0KCQkJfSk7CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFRpdGxlCiAgICAgICAgICovCiAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIlBhc3N3b3JkIEZpZWxkIjsKICAgICAgICB9LAogICAgICAgIAogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RGVzY3JpcHRpb24KICAgICAgICAgKi8KICAgICAgICBnZXREZXNjcmlwdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiUGFzc3dvcmQgRmllbGQuIjsKICAgICAgICB9LAoKCQkvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAicGFzc3dvcmQiOwogICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyVGVtcGxhdGUoImNvbnRyb2xGaWVsZFBhc3N3b3JkIiwgJzxpbnB1dCB0eXBlPSJwYXNzd29yZCIgaWQ9IiR7aWR9IiB7e2lmIG9wdGlvbnMuc2l6ZX19c2l6ZT0iJHtvcHRpb25zLnNpemV9Int7L2lmfX0ge3tpZiBvcHRpb25zLnJlYWRvbmx5fX1yZWFkb25seT0icmVhZG9ubHkie3svaWZ9fSB7e2lmIG5hbWV9fW5hbWU9IiR7bmFtZX0ie3svaWZ9fSB7e2VhY2goaSx2KSBvcHRpb25zLmRhdGF9fWRhdGEtJHtpfT0iJHt2fSJ7ey9lYWNofX0vPicpOwogICAgQWxwYWNhLnJlZ2lzdGVyTWVzc2FnZXMoewogICAgICAgICJpbnZhbGlkUGFzc3dvcmQiOiAiSW52YWxpZCBQYXNzd29yZCIKICAgIH0pOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygicGFzc3dvcmQiLCBBbHBhY2EuRmllbGRzLlBhc3N3b3JkRmllbGQpOwogICAgQWxwYWNhLnJlZ2lzdGVyRGVmYXVsdEZvcm1hdEZpZWxkTWFwcGluZygicGFzc3dvcmQiLCAicGFzc3dvcmQiKTsKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5QZXJzb25hbE5hbWVGaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuUGVyc29uYWxOYW1lRmllbGQucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuRmllbGRzLlRleHRGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIENvbnRyb2wgZm9yIHVwcGVyIGNhc2UgdGV4dC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtcGVyc29uYWxuYW1lJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjc2V0VmFsdWUKICAgICAgICAgKi8KICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgIHZhciB1cHBlclZhbHVlID0gIiI7CgogICAgICAgICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCB2YWwubGVuZ3RoOyBpKysgKSB7CiAgICAgICAgICAgICAgICBpZiAoIGkgPT09IDAgKSB7CiAgICAgICAgICAgICAgICAgICAgdXBwZXJWYWx1ZSArPSB2YWwuY2hhckF0KGkpLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHZhbC5jaGFyQXQoaS0xKSA9PSAnICcgfHwgIHZhbC5jaGFyQXQoaS0xKSA9PSAnLScgfHwgdmFsLmNoYXJBdChpLTEpID09ICInIikgewogICAgICAgICAgICAgICAgICAgIHVwcGVyVmFsdWUgKz0gdmFsLmNoYXJBdChpKS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB1cHBlclZhbHVlICs9IHZhbC5jaGFyQXQoaSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh1cHBlclZhbHVlICE9IHRoaXMuZ2V0VmFsdWUoKSkgewogICAgICAgICAgICAgICAgdGhpcy5iYXNlKHVwcGVyVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI29uS2V5UHJlc3MKICAgICAgICAgKi8KICAgICAgICBvbktleVByZXNzOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZShlKTsKCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICBBbHBhY2EubGF0ZXIoMjUsIHRoaXMsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIHYgPSBfdGhpcy5nZXRWYWx1ZSgpOwogICAgICAgICAgICAgICAgX3RoaXMuc2V0VmFsdWUodik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFRpdGxlCiAgICAgICAgICovCiAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIlBlcnNvbmFsIE5hbWUiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RGVzY3JpcHRpb24KICAgICAgICAgKi8KICAgICAgICBnZXREZXNjcmlwdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiVGV4dCBGaWVsZCBmb3IgcGVyc29uYWwgbmFtZSB3aXRoIGNhcHRpY2FsIGxldHRlciBmb3IgZmlyc3QgbGV0dGVyICYgYWZ0ZXIgaHlwaGVuLCBzcGFjZSBvciBhcG9zdHJvcGhlLiI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRGaWVsZFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gInBlcnNvbmFsbmFtZSI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJGaWVsZENsYXNzKCJwZXJzb25hbG5hbWUiLCBBbHBhY2EuRmllbGRzLlBlcnNvbmFsTmFtZUZpZWxkKTsKCn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuUGhvbmVGaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuUGhvbmVGaWVsZC5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkCiAgICAgICAgICoKICAgICAgICAgKiBAY2xhc3MgQ29udHJvbCBmb3Igc3RhbmRhcmQgVVMgcGhvbmUgbnVtYmVycy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNzZXR1cAogICAgICAgICAqLwogICAgICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CgogICAgICAgICAgICBpZiAoIXRoaXMuc2NoZW1hLnBhdHRlcm4pIHsKICAgICAgICAgICAgICAgIHRoaXMuc2NoZW1hLnBhdHRlcm4gPSBBbHBhY2EucmVnZXhwcy5waG9uZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKEFscGFjYS5pc0VtcHR5KHRoaXMub3B0aW9ucy5tYXNrU3RyaW5nKSkgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLm1hc2tTdHJpbmcgPSAiKDk5OSkgOTk5LTk5OTkiOwogICAgICAgICAgICB9CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjcG9zdFJlbmRlcgogICAgICAgICAqLwogICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLXBob25lJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjaGFuZGxlVmFsaWRhdGUKICAgICAgICAgKi8KICAgICAgICBoYW5kbGVWYWxpZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBiYXNlU3RhdHVzID0gdGhpcy5iYXNlKCk7CgogICAgICAgICAgICB2YXIgdmFsSW5mbyA9IHRoaXMudmFsaWRhdGlvbjsKCiAgICAgICAgICAgIGlmICghdmFsSW5mb1siaW52YWxpZFBhdHRlcm4iXVsic3RhdHVzIl0pIHsKICAgICAgICAgICAgICAgIHZhbEluZm9bImludmFsaWRQYXR0ZXJuIl1bIm1lc3NhZ2UiXSA9IHRoaXMudmlldy5nZXRNZXNzYWdlKCJpbnZhbGlkUGhvbmUiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGJhc2VTdGF0dXM7CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRTY2hlbWFPZlNjaGVtYQogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mU2NoZW1hOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHBhdHRlcm4gPSAodGhpcy5zY2hlbWEgJiYgdGhpcy5zY2hlbWEucGF0dGVybikgPyB0aGlzLnNjaGVtYS5wYXR0ZXJuIDogQWxwYWNhLnJlZ2V4cHMucGhvbmU7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICJwYXR0ZXJuIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiUGF0dGVybiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJGaWVsZCBQYXR0ZXJuIGluIFJlZ3VsYXIgRXhwcmVzc2lvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogcGF0dGVybiwKICAgICAgICAgICAgICAgICAgICAgICAgImVudW0iOltwYXR0ZXJuXSwKICAgICAgICAgICAgICAgICAgICAgICAgInJlYWRvbmx5IjogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJQcm9wZXJ0eSBkYXRhIGZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjoicGhvbmUiLAogICAgICAgICAgICAgICAgICAgICAgICAiZW51bSI6WyJwaG9uZSJdLAogICAgICAgICAgICAgICAgICAgICAgICAicmVhZG9ubHkiOnRydWUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRPcHRpb25zRm9yU2NoZW1hCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0ZvclNjaGVtYTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgImZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRTY2hlbWFPZk9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRTY2hlbWFPZk9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAibWFza1N0cmluZyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZpZWxkIE1hc2sgU3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkV4cHJlc3Npb24gZm9yIGZpZWxkIG1hc2siLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6ICIoOTk5KSA5OTktOTk5OSIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0VGl0bGUKICAgICAgICAgKi8KICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiUGhvbmUgRmllbGQiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RGVzY3JpcHRpb24KICAgICAgICAgKi8KICAgICAgICBnZXREZXNjcmlwdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiUGhvbmUgRmllbGQuIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAicGhvbmUiOwogICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyTWVzc2FnZXMoewogICAgICAgICJpbnZhbGlkUGhvbmUiOiAiSW52YWxpZCBQaG9uZSBOdW1iZXIsIGUuZy4gKDEyMykgNDU2LTk5OTkiCiAgICB9KTsKICAgIEFscGFjYS5yZWdpc3RlckZpZWxkQ2xhc3MoInBob25lIiwgQWxwYWNhLkZpZWxkcy5QaG9uZUZpZWxkKTsKICAgIEFscGFjYS5yZWdpc3RlckRlZmF1bHRGb3JtYXRGaWVsZE1hcHBpbmcoInBob25lIiwgInBob25lIik7Cn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuVGFnRmllbGQgPSBBbHBhY2EuRmllbGRzLkxvd2VyQ2FzZUZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuVGFnRmllbGQucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuRmllbGRzLlRleHRGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIFRpbWUgY29udHJvbCBmb3IgSlNPTiBzY2hlbWEgdGltZSBmb3JtYXQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjc2V0dXAKICAgICAgICAgKi8KICAgICAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuc2VwYXJhdG9yKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuc2VwYXJhdG9yID0gIiwiOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtdGFnJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRWYWx1ZQogICAgICAgICAqLwogICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHZhbCA9IHRoaXMuYmFzZSgpOwogICAgICAgICAgICBpZiAodmFsID09PSAiIikgewogICAgICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWwuc3BsaXQodGhpcy5vcHRpb25zLnNlcGFyYXRvcik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNzZXRWYWx1ZQogICAgICAgICAqLwogICAgICAgIHNldFZhbHVlOiBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgaWYgKHZhbCA9PT0gIiIpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5iYXNlKHZhbC5qb2luKHRoaXMub3B0aW9ucy5zZXBhcmF0b3IpKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNvbkJsdXIKICAgICAgICAgKi8KICAgICAgICBvbkJsdXI6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGUpOwoKICAgICAgICAgICAgdmFyIHZhbHMgPSB0aGlzLmdldFZhbHVlKCk7CgogICAgICAgICAgICB2YXIgdHJpbW1lZCA9IFtdOwoKICAgICAgICAgICAgJC5lYWNoKHZhbHMsIGZ1bmN0aW9uKGksIHYpIHsKICAgICAgICAgICAgICAgIGlmICh2LnRyaW0oKSAhPT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICB0cmltbWVkLnB1c2godi50cmltKCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUodHJpbW1lZCk7CgogICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0U2NoZW1hT2ZPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgInNlcGFyYXRvciI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIlNlcGFyYXRvciIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJTZXBhcmF0b3IgdXNlZCB0byBzcGxpdCB0YWdzLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjoiLCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRPcHRpb25zRm9yT3B0aW9ucwogICAgICAgICAqLwogICAgICAgIGdldE9wdGlvbnNGb3JPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgImZpZWxkcyI6IHsKICAgICAgICAgICAgICAgICAgICAic2VwYXJhdG9yIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRUaXRsZQogICAgICAgICAqLwogICAgICAgIGdldFRpdGxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJUYWcgRmllbGQiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RGVzY3JpcHRpb24KICAgICAgICAgKi8KICAgICAgICBnZXREZXNjcmlwdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiVGV4dCBmaWVsZCBmb3IgZW50ZXJpbmcgbGlzdCBvZiB0YWdzIHNlcGFyYXRlZCBieSBkZWxpbWl0ZXIuIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAidGFnIjsKICAgICAgICB9Ly9fX0VORF9PRl9CVUlMREVSX0hFTFBFUlMKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3RlckZpZWxkQ2xhc3MoInRhZyIsIEFscGFjYS5GaWVsZHMuVGFnRmllbGQpOwp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLlRpbWVGaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuVGltZUZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBUaW1lIGNvbnRyb2wgZm9yIEpTT04gc2NoZW1hIHRpbWUgZm9ybWF0LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IGRhdGEgRmllbGQgZGF0YS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBGaWVsZCBvcHRpb25zLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBGaWVsZCB2aWV3LgogICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbm5lY3Rvcn0gY29ubmVjdG9yIEZpZWxkIGNvbm5lY3Rvci4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI3NldHVwCiAgICAgICAgICovCiAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmJhc2UoKTsKCiAgICAgICAgICAgIGlmICghdGhpcy5vcHRpb25zLnRpbWVGb3JtYXQpIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy50aW1lRm9ybWF0ID0gImhoOm1tOnNzIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMudGltZUZvcm1hdFJlZ2V4KSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMudGltZUZvcm1hdFJlZ2V4ID0gL14oKFswLTFdWzAtOV0pfChbMl1bMC0zXSkpOihbMC01XVswLTldKTooWzAtNV1bMC05XSkkLzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKEFscGFjYS5pc0VtcHR5KHRoaXMub3B0aW9ucy5tYXNrU3RyaW5nKSkgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLm1hc2tTdHJpbmcgPSAiOTk6OTk6OTkiOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtdGltZScpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CgogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZCNvbkNoYW5nZQogICAgICAgICAqLwogICAgICAgIG9uQ2hhbmdlOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZSgpOwogICAgICAgICAgICB0aGlzLnJlZnJlc2hWYWxpZGF0aW9uU3RhdGUoKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2hhbmRsZVZhbGl0aW1lCiAgICAgICAgICovCiAgICAgICAgaGFuZGxlVmFsaWRhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYmFzZVN0YXR1cyA9IHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgdmFyIHZhbEluZm8gPSB0aGlzLnZhbGlkYXRpb247CgogICAgICAgICAgICB2YXIgc3RhdHVzID0gdGhpcy5fdmFsaWRhdGVUaW1lRm9ybWF0KCk7CiAgICAgICAgICAgIHZhbEluZm9bImludmFsaWRUaW1lIl0gPSB7CiAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHN0YXR1cyA/ICIiIDogQWxwYWNhLnN1YnN0aXR1dGVUb2tlbnModGhpcy52aWV3LmdldE1lc3NhZ2UoImludmFsaWRUaW1lIiksIFt0aGlzLm9wdGlvbnMudGltZUZvcm1hdF0pLAogICAgICAgICAgICAgICAgInN0YXR1cyI6IHN0YXR1cwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgcmV0dXJuIGJhc2VTdGF0dXMgJiYgdmFsSW5mb1siaW52YWxpZFRpbWUiXVsic3RhdHVzIl07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVmFsaXRpbWVzIHRpbWUgZm9ybWF0LgogICAgICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmIGl0IGlzIGEgdmFsaWQgdGltZSwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAqLwogICAgICAgIF92YWxpZGF0ZVRpbWVGb3JtYXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLmZpZWxkLnZhbCgpOwogICAgICAgICAgICBpZiAoIXRoaXMuc2NoZW1hLnJlcXVpcmVkICYmIChBbHBhY2EuaXNWYWxFbXB0eSh2YWx1ZSkgfHwgdmFsdWUgPT0gIl9fOl9fOl9fIikpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vdmFsaXRpbWUgdGhlIHRpbWUgd2l0aG91dCB0aGUgaGVscCBvZiB0aW1lcGlja2VyLnBhcnNlVGltZQogICAgICAgICAgICByZXR1cm4gdmFsdWUubWF0Y2godGhpcy5vcHRpb25zLnRpbWVGb3JtYXRSZWdleCk7CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjc2V0VmFsdWUKICAgICAgICAgKi8KICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgIC8vIHNraXAgb3V0IGlmIG5vIHRpbWUKICAgICAgICAgICAgaWYgKHZhbCA9PT0gIiIpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFzZSh2YWwpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmJhc2UodmFsKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0U2NoZW1hT2ZTY2hlbWEKICAgICAgICAgKi8KICAgICAgICBnZXRTY2hlbWFPZlNjaGVtYTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICJmb3JtYXQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJGb3JtYXQiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiUHJvcGVydHkgZGF0YSBmb3JtYXQiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6InRpbWUiLAogICAgICAgICAgICAgICAgICAgICAgICAiZW51bSIgOiBbInRpbWUiXSwKICAgICAgICAgICAgICAgICAgICAgICAgInJlYWRvbmx5Ijp0cnVlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0T3B0aW9uc0ZvclNjaGVtYQogICAgICAgICAqLwogICAgICAgIGdldE9wdGlvbnNGb3JTY2hlbWE6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICJmb3JtYXQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRleHQiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0U2NoZW1hT2ZPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NoZW1hT2ZPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgInRpbWVGb3JtYXQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0aXRsZSI6ICJUaW1lIEZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJUaW1lIGZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogImhoOm1tOnNzIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInRpbWVGb3JtYXRSZWdleCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZvcm1hdCBSZWd1bGFyIEV4cHJlc3Npb24iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiUmVndWxhciBleHByZXNzaW9uIGZvciB2YWxpZGF0aW9uIHRpbWUgZm9ybWF0IiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiAvXigoWzAtMV1bMC05XSl8KFsyXVswLTNdKSk6KFswLTVdWzAtOV0pOihbMC01XVswLTldKSQvCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAibWFza1N0cmluZyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiIDogIjk5Ojk5Ojk5IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldE9wdGlvbnNGb3JPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0Zvck9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICJ0aW1lRm9ybWF0IjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInRpbWVGb3JtYXRSZWdleCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0VGl0bGUKICAgICAgICAgKi8KICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiVGltZSBGaWVsZCI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJGaWVsZCBmb3IgdGltZS4iOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RmllbGRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJ0aW1lIjsKICAgICAgICB9Ly9fX0VORF9PRl9CVUlMREVSX0hFTFBFUlMKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3Rlck1lc3NhZ2VzKHsKICAgICAgICAiaW52YWxpZFRpbWUiOiAiSW52YWxpZCB0aW1lIGZvciBmb3JtYXQgezB9IgogICAgfSk7CiAgICBBbHBhY2EucmVnaXN0ZXJGaWVsZENsYXNzKCJ0aW1lIiwgQWxwYWNhLkZpZWxkcy5UaW1lRmllbGQpOwogICAgQWxwYWNhLnJlZ2lzdGVyRGVmYXVsdEZvcm1hdEZpZWxkTWFwcGluZygidGltZSIsICJ0aW1lIik7Cn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuVXBwZXJDYXNlRmllbGQgPSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZC5leHRlbmQoCiAgICAvKioKICAgICAqIEBsZW5kcyBBbHBhY2EuRmllbGRzLlVwcGVyQ2FzZUZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBDb250cm9sIGZvciB1cHBlciBjYXNlIHRleHQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjcG9zdFJlbmRlcgogICAgICAgICAqLwogICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLXVwcGVyY2FzZScpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CgogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI3NldFZhbHVlCiAgICAgICAgICovCiAgICAgICAgc2V0VmFsdWU6IGZ1bmN0aW9uKHZhbCkgewoKICAgICAgICAgICAgdmFyIHVwcGVyVmFsdWUgPSB2YWwudG9VcHBlckNhc2UoKTsKCiAgICAgICAgICAgIGlmICh1cHBlclZhbHVlICE9IHRoaXMuZ2V0VmFsdWUoKSkgewogICAgICAgICAgICAgICAgdGhpcy5iYXNlKHVwcGVyVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI29uS2V5UHJlc3MKICAgICAgICAgKi8KICAgICAgICBvbktleVByZXNzOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZShlKTsKCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICBBbHBhY2EubGF0ZXIoMjUsIHRoaXMsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIHYgPSBfdGhpcy5nZXRWYWx1ZSgpOwogICAgICAgICAgICAgICAgX3RoaXMuc2V0VmFsdWUodik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sLy9fX0JVSUxERVJfSEVMUEVSUwoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFRpdGxlCiAgICAgICAgICovCiAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIlVwcGVyY2FzZSBUZXh0IjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldERlc2NyaXB0aW9uCiAgICAgICAgICovCiAgICAgICAgZ2V0RGVzY3JpcHRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIlRleHQgZmllbGQgZm9yIHVwcGVyY2FzZSB0ZXh0LiI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRGaWVsZFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gInVwcGVyY2FzZSI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJGaWVsZENsYXNzKCJ1cHBlcmNhc2UiLCBBbHBhY2EuRmllbGRzLlVwcGVyQ2FzZUZpZWxkKTsKICAgIEFscGFjYS5yZWdpc3RlckRlZmF1bHRGb3JtYXRGaWVsZE1hcHBpbmcoInVwcGVyY2FzZSIsICJ1cHBlcmNhc2UiKTsKCn0pKGpRdWVyeSk7CihmdW5jdGlvbigkKSB7CgogICAgdmFyIEFscGFjYSA9ICQuYWxwYWNhOwoKICAgIEFscGFjYS5GaWVsZHMuV3lzaXd5Z0ZpZWxkID0gQWxwYWNhLkZpZWxkcy5UZXh0QXJlYUZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuV3lzaXd5Z0ZpZWxkLnByb3RvdHlwZQogICAgICovCiAgICB7CiAgICAgICAgLyoqCiAgICAgICAgICogQGNvbnN0cnVjdHMKICAgICAgICAgKiBAYXVnbWVudHMgQWxwYWNhLkZpZWxkcy5UZXh0QXJlYUZpZWxkCiAgICAgICAgICoKICAgICAgICAgKiBAY2xhc3MgV1lTSVdZRyBjb250cm9sIGZvciBjaHVuayBvZiB0ZXh0LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IGRhdGEgRmllbGQgZGF0YS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBGaWVsZCBvcHRpb25zLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBGaWVsZCB2aWV3LgogICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbm5lY3Rvcn0gY29ubmVjdG9yIEZpZWxkIGNvbm5lY3Rvci4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKCiAgICAgICAgICAgIHRoaXMuY29udHJvbHNDb25maWcgPSB7fTsKICAgICAgICAgICAgdGhpcy5jb250cm9sc0NvbmZpZy5zaW1wbGUgPSB7CiAgICAgICAgICAgICAgICAiaHRtbCI6IHsgInZpc2libGUiOiB0cnVlIH0sCiAgICAgICAgICAgICAgICAiY3JlYXRlTGluayI6IHsgInZpc2libGUiOiBmYWxzZSB9LAogICAgICAgICAgICAgICAgInVuTGluayI6IHsgInZpc2libGUiOiBmYWxzZSB9LAogICAgICAgICAgICAgICAgImgxIjogeyAidmlzaWJsZSI6IGZhbHNlIH0sCiAgICAgICAgICAgICAgICAiaDIiOiB7ICJ2aXNpYmxlIjogZmFsc2UgfSwKICAgICAgICAgICAgICAgICJoMyI6IHsgInZpc2libGUiOiBmYWxzZSB9LAogICAgICAgICAgICAgICAgImluZGVudCI6IHsgInZpc2libGUiOiBmYWxzZSB9LAogICAgICAgICAgICAgICAgImluc2VydEhvcml6b250YWxSdWxlIjogeyAidmlzaWJsZSI6IGZhbHNlIH0sCiAgICAgICAgICAgICAgICAiaW5zZXJ0SW1hZ2UiOiB7ICJ2aXNpYmxlIjogZmFsc2UgfSwKICAgICAgICAgICAgICAgICJpbnNlcnRPcmRlcmVkTGlzdCI6IHsgInZpc2libGUiOiBmYWxzZSB9LAogICAgICAgICAgICAgICAgImluc2VydFRhYmxlIjogeyAidmlzaWJsZSI6IGZhbHNlIH0sCiAgICAgICAgICAgICAgICAiaW5zZXJ0VW5vcmRlcmVkTGlzdCI6IHsgInZpc2libGUiOiBmYWxzZSB9LAogICAgICAgICAgICAgICAgImp1c3RpZnlDZW50ZXIiOiB7ICJ2aXNpYmxlIjogZmFsc2UgfSwKICAgICAgICAgICAgICAgICJqdXN0aWZ5RnVsbCI6IHsgInZpc2libGUiOiBmYWxzZSB9LAogICAgICAgICAgICAgICAgImp1c3RpZnlMZWZ0IjogeyAidmlzaWJsZSI6IGZhbHNlIH0sCiAgICAgICAgICAgICAgICAianVzdGlmeVJpZ2h0IjogeyAidmlzaWJsZSI6IGZhbHNlIH0sCiAgICAgICAgICAgICAgICAib3V0ZGVudCI6IHsgInZpc2libGUiOiBmYWxzZSB9LAogICAgICAgICAgICAgICAgInJlZG8iOiB7ICJ2aXNpYmxlIjogZmFsc2UgfSwKICAgICAgICAgICAgICAgICJyZW1vdmVGb3JtYXQiOiB7ICJ2aXNpYmxlIjogZmFsc2UgfSwKICAgICAgICAgICAgICAgICJzdWJzY3JpcHQiOiB7ICJ2aXNpYmxlIjogZmFsc2UgfSwKICAgICAgICAgICAgICAgICJzdXBlcnNjcmlwdCI6IHsgInZpc2libGUiOiBmYWxzZSB9LAogICAgICAgICAgICAgICAgInVuZG8iOiB7ICJ2aXNpYmxlIjogZmFsc2UgfSwKICAgICAgICAgICAgICAgICJjb2RlIjogeyAidmlzaWJsZSI6IGZhbHNlIH0sCiAgICAgICAgICAgICAgICAic3RyaWtlVGhyb3VnaCI6IHsgInZpc2libGUiOiBmYWxzZSB9CiAgICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRBcmVhRmllbGQjc2V0dXAKICAgICAgICAgKi8KICAgICAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgLy8gaW5zdGFudGlhdGVkIHBsdWdpbiByZWZlcmVuY2UKICAgICAgICAgICAgdGhpcy5wbHVnaW4gPSBudWxsOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRBcmVhRmllbGQjcG9zdFJlbmRlcgogICAgICAgICAqLwogICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgLy8gc2VlIGlmIHdlIGNhbiByZW5kZXIgald5c2l3eWcKICAgICAgICAgICAgICAgIGlmIChzZWxmLmZpZWxkICYmICQud3lzaXd5ZykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgd3lzaXd5Z09wdGlvbnMgPSBzZWxmLm9wdGlvbnMud3lzaXd5ZyA/IHNlbGYub3B0aW9ucy53eXNpd3lnIDoge307CgogICAgICAgICAgICAgICAgICAgIGlmICh3eXNpd3lnT3B0aW9ucy5jb250cm9scykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Yod3lzaXd5Z09wdGlvbnMuY29udHJvbHMpID09PSAic3RyaW5nIikKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd3lzaXd5Z09wdGlvbnMuY29udHJvbHMgPSBzZWxmLmNvbnRyb2xzQ29uZmlnW3d5c2l3eWdPcHRpb25zLmNvbnRyb2xzXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghd3lzaXd5Z09wdGlvbnMuY29udHJvbHMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd3lzaXd5Z09wdGlvbnMuY29udHJvbHMgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5vbkRlbWFuZCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYub3V0ZXJFbC5maW5kKCJ0ZXh0YXJlYSIpLm1vdXNlb3ZlcihmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXNlbGYucGx1Z2luKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucGx1Z2luID0gJCh0aGlzKS53eXNpd3lnKHd5c2l3eWdPcHRpb25zKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5vdXRlckVsLmZpbmQoIi53eXNpd3lnIikubW91c2VvdXQoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5wbHVnaW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucGx1Z2luLnd5c2l3eWcoJ2Rlc3Ryb3knKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5wbHVnaW4gPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucGx1Z2luID0gc2VsZi5maWVsZC53eXNpd3lnKHd5c2l3eWdPcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHNlbGYub3V0ZXJFbC5maW5kKCIud3lzaXd5ZyIpLm1vdXNlb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRhdGEgPSBfdGhpcy5nZXRWYWx1ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnJlZnJlc2hWYWxpZGF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtd3lzaXd5ZycpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICB9LC8vX19CVUlMREVSX0hFTFBFUlMKCQkKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRyb2xGaWVsZCNnZXRTY2hlbWFPZk9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRTY2hlbWFPZk9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAid3lzaXd5ZyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkVkaXRvciBvcHRpb25zIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIk9wdGlvbnMgdGhhdCBhcmUgc3VwcG9ydGVkIGJ5IHRoZSA8YSBocmVmPSdodHRwczovL2dpdGh1Yi5jb20vYWt6aGFuL2p3eXNpd3lnJz5qUXVlcnkgV1lTSVdZRyBwbHVnaW48L2E+LiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImFueSIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJvbkRlbWFuZCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIk9uIERlbWFuZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJJZiB0cnVlLCBXWVNJV1lHIGVkaXRvciB3aWxsIG9ubHkgYmUgZW5hYmxlZCB3aGVuIHRoZSBmaWVsZCBpcyBob3ZlcmVkLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRyb2xGaWVsZCNnZXRPcHRpb25zRm9yT3B0aW9ucwogICAgICAgICAqLwogICAgICAgIGdldE9wdGlvbnNGb3JPcHRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgImZpZWxkcyI6IHsKICAgICAgICAgICAgICAgICAgICAid3lzaXd5ZyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYW55IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgIm9uRGVtYW5kIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJyaWdodExhYmVsIjogIk1ha2UgdGhlIGVkaXRvciBvbi1kZW1hbmQ/IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCgkJLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRBcmVhRmllbGQjZ2V0VGl0bGUKCQkgKi8KCQlnZXRUaXRsZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAiV3lzaXd5ZyBFZGl0b3IiOwoJCX0sCgkJCgkJLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRBcmVhRmllbGQjZ2V0RGVzY3JpcHRpb24KCQkgKi8KCQlnZXREZXNjcmlwdGlvbjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAiV3lzaXd5ZyBlZGl0b3IgZm9yIG11bHRpLWxpbmUgdGV4dCB3aGljaCBpcyBiYXNlZCBvbiBBa3poYW4gQWJkdWxpbidzIDxhIGhyZWY9J2h0dHBzOi8vZ2l0aHViLmNvbS9ha3poYW4vand5c2l3eWcnPmpRdWVyeSBXWVNJV1lHIHBsdWdpbjwvYT4uIjsKCQl9LAoKCQkvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEFyZWFGaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRGaWVsZFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gInd5c2l3eWciOwogICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgfSk7CiAgICAKICAgIEFscGFjYS5yZWdpc3RlckZpZWxkQ2xhc3MoInd5c2l3eWciLCBBbHBhY2EuRmllbGRzLld5c2l3eWdGaWVsZCk7CiAgICAKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5TdGF0ZUZpZWxkID0gQWxwYWNhLkZpZWxkcy5TZWxlY3RGaWVsZC5leHRlbmQoCiAgICAvKioKICAgICAqIEBsZW5kcyBBbHBhY2EuRmllbGRzLlN0YXRlRmllbGQucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuRmllbGRzLlRleHRGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIFN0YXRlIENvbnRyb2wKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNzZXR1cAogICAgICAgICAqLwogICAgICAgIHNldHVwOiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIC8vIGRlZmF1bHRzCiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNVbmRlZmluZWQodGhpcy5vcHRpb25zLmNhcGl0YWxpemUpKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuY2FwaXRhbGl6ZSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChBbHBhY2EuaXNVbmRlZmluZWQodGhpcy5vcHRpb25zLmluY2x1ZGVTdGF0ZXMpKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuaW5jbHVkZVN0YXRlcyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKEFscGFjYS5pc1VuZGVmaW5lZCh0aGlzLm9wdGlvbnMuaW5jbHVkZVRlcnJpdG9yaWVzKSkgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmluY2x1ZGVUZXJyaXRvcmllcyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKEFscGFjYS5pc1VuZGVmaW5lZCh0aGlzLm9wdGlvbnMuZm9ybWF0KSkgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmZvcm1hdCA9ICJuYW1lIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gdmFsaWRhdGUgc2V0dGluZ3MKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5mb3JtYXQgPT0gIm5hbWUiIHx8IHRoaXMub3B0aW9ucy5mb3JtYXQgPT0gImNvZGUiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyB2YWxpZCBmb3JtYXRzCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBBbHBhY2EubG9nRXJyb3IoIlRoZSBjb25maWd1cmVkIHN0YXRlIGZvcm1hdDogIiArIHRoaXMub3B0aW9ucy5mb3JtYXQgKyAiIGlzIG5vdCBhIGxlZ2FsIHZhbHVlIFtuYW1lLCBjb2RlXSIpOwoKICAgICAgICAgICAgICAgIC8vIGRlZmF1bHQgdG8gbmFtZSBmb3JtYXQKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5mb3JtYXQgPSAibmFtZSI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGNvbmZpZ3VyZQogICAgICAgICAgICB2YXIgaG9sZGluZ3MgPSBBbHBhY2EucmV0cmlldmVVU0hvbGRpbmdzKAogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmluY2x1ZGVTdGF0ZXMsCiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuaW5jbHVkZVRlcnJpdG9yaWVzLAogICAgICAgICAgICAgICAgKHRoaXMub3B0aW9ucy5mb3JtYXQgPT0gImNvZGUiKSwKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5jYXBpdGFsaXplKTsKCiAgICAgICAgICAgIHRoaXMuc2NoZW1hWyJlbnVtIl0gPSBob2xkaW5ncy5rZXlzOwogICAgICAgICAgICB0aGlzLm9wdGlvbnMub3B0aW9uTGFiZWxzID0gaG9sZGluZ3MudmFsdWVzOwoKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtc3RhdGUnKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwoKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNoYW5kbGVWYWxpZGF0ZQogICAgICAgICAqLwogICAgICAgIGhhbmRsZVZhbGlkYXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGJhc2VTdGF0dXMgPSB0aGlzLmJhc2UoKTsKCiAgICAgICAgICAgIC8vIG5vIGFkZGl0aW9uYWwgdmFsaWRhdGlvbgoKICAgICAgICAgICAgcmV0dXJuIGJhc2VTdGF0dXM7CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRTY2hlbWFPZk9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRTY2hlbWFPZk9wdGlvbnM6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgcmV0dXJuIEFscGFjYS5tZXJnZSh0aGlzLmJhc2UoKSwgewogICAgICAgICAgICAgICAgInByb3BlcnRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgImZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkZvcm1hdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJIb3cgdG8gcmVwcmVzZW50IHRoZSBzdGF0ZSB2YWx1ZXMgaW4gdGhlIHNlbGVjdG9yIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlZmF1bHQiOiAibmFtZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJlbnVtIjpbIm5hbWUiLCAiY29kZSJdLAogICAgICAgICAgICAgICAgICAgICAgICAicmVhZG9ubHkiOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiY2FwaXRhbGl6ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkNhcGl0YWxpemUiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiV2hldGhlciB0aGUgdmFsdWVzIHNob3VsZCBiZSBjYXBpdGFsaXplZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAicmVhZG9ubHkiOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiaW5jbHVkZVN0YXRlcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkluY2x1ZGUgU3RhdGVzIiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIldoZXRoZXIgdG8gaW5jbHVkZSB0aGUgc3RhdGVzIG9mIHRoZSBVbml0ZWQgU3RhdGVzIiwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZWZhdWx0IjogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgInJlYWRvbmx5IjogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImluY2x1ZGVUZXJyaXRvcmllcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkluY2x1ZGUgVGVycml0b3JpZXMiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiV2hldGhlciB0byBpbmNsdWRlIHRoZSB0ZXJyaXRvcmllcyBvZiB0aGUgVW5pdGVkIFN0YXRlcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICJyZWFkb25seSI6IHRydWUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0T3B0aW9uc0Zvck9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgImZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJjYXBpdGFsaXplIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJpbmNsdWRlU3RhdGVzIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJpbmNsdWRlVGVycml0b3JpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImNoZWNrYm94IgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRUaXRsZQogICAgICAgICAqLwogICAgICAgIGdldFRpdGxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJTdGF0ZSBGaWVsZCI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJQcm92aWRlcyBhIGRyb3Bkb3duIHNlbGVjdG9yIG9mIHN0YXRlcyBhbmQvb3IgdGVycml0b3JpZXMgaW4gdGhlIFVuaXRlZCBTdGF0ZXMsIGtleWVkIGJ5IHRoZWlyIHR3by1jaGFyYWN0ZXIgY29kZS4iOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0RmllbGRUeXBlCiAgICAgICAgICovCiAgICAgICAgZ2V0RmllbGRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJzdGF0ZSI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJGaWVsZENsYXNzKCJzdGF0ZSIsIEFscGFjYS5GaWVsZHMuU3RhdGVGaWVsZCk7CiAgICBBbHBhY2EucmVnaXN0ZXJEZWZhdWx0Rm9ybWF0RmllbGRNYXBwaW5nKCJzdGF0ZSIsICJzdGF0ZSIpOwoKICAgIC8qKgogICAgICogSGVscGVyIGZ1bmN0aW9uIHRvIHJldHJpZXZlIHRoZSBob2xkaW5ncyBvZiBVUyBzdGF0ZXMgYW5kIHRlcnJpdG9yaWVzLgogICAgICoKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gaW5jbHVkZVN0YXRlcyB3aGV0aGVyIHRvIGluY2x1ZGUgVVMgc3RhdGVzCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IGluY2x1ZGVUZXJyaXRvcmllcyB3aGV0aGVyIHRvIGluY2x1ZGUgVVMgdGVycml0b3JpZXMKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gY29kZVZhbHVlIHdoZXRoZXIgdG8gaGFuZCBiYWNrIFVTIGhvbGRpbmcgY29kZXMgKGluc3RlYWQgb2YgbmFtZXMpCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IGNhcGl0YWxpemUgd2hldGhlciB0byBjYXBpdGFsaXplIHRoZSB2YWx1ZXMgaGFuZGVkIGJhY2sKICAgICAqCiAgICAgKiBAdHlwZSB7T2JqZWN0fSBhbiBvYmplY3QgY29udGFpbmluZyAia2V5cyIgYW5kICJ2YWx1ZXMiLCBib3RoIG9mIHdoaWNoIGFyZSBhcnJheXMuCiAgICAgKi8KICAgIEFscGFjYS5yZXRyaWV2ZVVTSG9sZGluZ3MgPSBmdW5jdGlvbigpCiAgICB7CiAgICAgICAgdmFyIGhvbGRpbmdzID0gW107CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIkFya2Fuc2FzIiwKICAgICAgICAgICAgImNvZGUiOiAiQUsiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiQWxhYmFtYSIsCiAgICAgICAgICAgICJjb2RlIjogIkFMIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIkFtZXJpY2FuIFNhbW9hIiwKICAgICAgICAgICAgImNvZGUiOiAiQVMiLAogICAgICAgICAgICAic3RhdGUiOiBmYWxzZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IHRydWUKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiQXJpem9uYSIsCiAgICAgICAgICAgICJjb2RlIjogIkFSIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIkNhbGlmb3JuaWEiLAogICAgICAgICAgICAiY29kZSI6ICJDQSIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJDb2xvcmFkbyIsCiAgICAgICAgICAgICJjb2RlIjogIkNPIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIkNvbm5lY3RpY3V0IiwKICAgICAgICAgICAgImNvZGUiOiAiQ1QiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiRGVsYXdhcmUiLAogICAgICAgICAgICAiY29kZSI6ICJERSIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJEaXN0aWN0IG9mIENvbHVtYmlhIiwKICAgICAgICAgICAgImNvZGUiOiAiREMiLAogICAgICAgICAgICAic3RhdGUiOiBmYWxzZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IHRydWUKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiRmVkZXJhdGVkIFN0YXRlcyBvZiBNaWNyb25lc2lhIiwKICAgICAgICAgICAgImNvZGUiOiAiRk0iLAogICAgICAgICAgICAic3RhdGUiOiBmYWxzZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IHRydWUKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiRmxvcmlkYSIsCiAgICAgICAgICAgICJjb2RlIjogIkZMIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIkdlb3JnaWEiLAogICAgICAgICAgICAiY29kZSI6ICJHQSIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJHdWFtIiwKICAgICAgICAgICAgImNvZGUiOiAiR1UiLAogICAgICAgICAgICAic3RhdGUiOiBmYWxzZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IHRydWUKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiR2VvcmdpYSIsCiAgICAgICAgICAgICJjb2RlIjogIkdBIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIkhhd2FpaSIsCiAgICAgICAgICAgICJjb2RlIjogIkhJIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIklkYWhvIiwKICAgICAgICAgICAgImNvZGUiOiAiSUQiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiSWxsaW5vaXMiLAogICAgICAgICAgICAiY29kZSI6ICJJTCIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJJbmRpYW5hIiwKICAgICAgICAgICAgImNvZGUiOiAiSU4iLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiSW93YSIsCiAgICAgICAgICAgICJjb2RlIjogIklBIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIkthbnNhcyIsCiAgICAgICAgICAgICJjb2RlIjogIktTIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIktlbnR1Y2t5IiwKICAgICAgICAgICAgImNvZGUiOiAiS1kiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiTG91aXNpYW5hIiwKICAgICAgICAgICAgImNvZGUiOiAiTEEiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiTWFpbmUiLAogICAgICAgICAgICAiY29kZSI6ICJNRSIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJNYXJzaGFsbCBJc2xhbmRzIiwKICAgICAgICAgICAgImNvZGUiOiAiTUgiLAogICAgICAgICAgICAic3RhdGUiOiBmYWxzZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IHRydWUKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiTWFyeWxhbmQiLAogICAgICAgICAgICAiY29kZSI6ICJNRCIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJNYXNzYWNodXNldHRzIiwKICAgICAgICAgICAgImNvZGUiOiAiTUEiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiTWljaGlnYW4iLAogICAgICAgICAgICAiY29kZSI6ICJNSSIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJNaW5uZXNvdGEiLAogICAgICAgICAgICAiY29kZSI6ICJNTiIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJNaXNzaXNzaXBwaSIsCiAgICAgICAgICAgICJjb2RlIjogIk1TIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIk1pc3NvdXJpIiwKICAgICAgICAgICAgImNvZGUiOiAiTU8iLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiTW9udGFuYSIsCiAgICAgICAgICAgICJjb2RlIjogIk1UIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIk5lYnJhc2thIiwKICAgICAgICAgICAgImNvZGUiOiAiTkUiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiTmV2YWRhIiwKICAgICAgICAgICAgImNvZGUiOiAiTlYiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiTmV3IEhhbXBzaGlyZSIsCiAgICAgICAgICAgICJjb2RlIjogIk5IIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIk5ldyBKZXJzZXkiLAogICAgICAgICAgICAiY29kZSI6ICJOSiIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJOZXcgTWV4aWNvIiwKICAgICAgICAgICAgImNvZGUiOiAiTk0iLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiTmV3IFlvcmsiLAogICAgICAgICAgICAiY29kZSI6ICJOWSIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJOb3J0aCBDYXJvbGluYSIsCiAgICAgICAgICAgICJjb2RlIjogIk5DIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIk5vcnRoIERha290YSIsCiAgICAgICAgICAgICJjb2RlIjogIk5EIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIk5vcnRoZXJuIE1hcmlhbmEgSXNsYW5kcyIsCiAgICAgICAgICAgICJjb2RlIjogIk1QIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIk9oaW8iLAogICAgICAgICAgICAiY29kZSI6ICJPSCIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJPa2xhaG9tYSIsCiAgICAgICAgICAgICJjb2RlIjogIk9LIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIk9yZWdvbiIsCiAgICAgICAgICAgICJjb2RlIjogIk9SIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIlBhbGF1IiwKICAgICAgICAgICAgImNvZGUiOiAiUFciLAogICAgICAgICAgICAic3RhdGUiOiBmYWxzZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IHRydWUKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiUGVubnN5bHZhbmlhIiwKICAgICAgICAgICAgImNvZGUiOiAiUEEiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiUHVlcnRvIFJpY28iLAogICAgICAgICAgICAiY29kZSI6ICJQUiIsCiAgICAgICAgICAgICJzdGF0ZSI6IGZhbHNlLAogICAgICAgICAgICAidGVycml0b3J5IjogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJSaG9kZSBJc2xhbmQiLAogICAgICAgICAgICAiY29kZSI6ICJSSSIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJTb3V0aCBDYXJvbGluYSIsCiAgICAgICAgICAgICJjb2RlIjogIlNDIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIlNvdXRoIERha290YSIsCiAgICAgICAgICAgICJjb2RlIjogIlNEIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIlRlbm5lc3NlZSIsCiAgICAgICAgICAgICJjb2RlIjogIlROIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIlRleGFzIiwKICAgICAgICAgICAgImNvZGUiOiAiVFgiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiVXRhaCIsCiAgICAgICAgICAgICJjb2RlIjogIlVUIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIlZlcm1vbnQiLAogICAgICAgICAgICAiY29kZSI6ICJWVCIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJWaXJnaW4gSXNsYW5kcyIsCiAgICAgICAgICAgICJjb2RlIjogIlZJIiwKICAgICAgICAgICAgInN0YXRlIjogZmFsc2UsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIlZpcmdpbmlhIiwKICAgICAgICAgICAgImNvZGUiOiAiVkEiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBob2xkaW5ncy5wdXNoKHsKICAgICAgICAgICAgIm5hbWUiOiAiV2FzaGluZ3RvbiIsCiAgICAgICAgICAgICJjb2RlIjogIldBIiwKICAgICAgICAgICAgInN0YXRlIjogdHJ1ZSwKICAgICAgICAgICAgInRlcnJpdG9yeSI6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgaG9sZGluZ3MucHVzaCh7CiAgICAgICAgICAgICJuYW1lIjogIldlc3QgVmlyZ2luaWEiLAogICAgICAgICAgICAiY29kZSI6ICJXViIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJXaXNjb25zaW4iLAogICAgICAgICAgICAiY29kZSI6ICJXSSIsCiAgICAgICAgICAgICJzdGF0ZSI6IHRydWUsCiAgICAgICAgICAgICJ0ZXJyaXRvcnkiOiBmYWxzZQogICAgICAgIH0pOwogICAgICAgIGhvbGRpbmdzLnB1c2goewogICAgICAgICAgICAibmFtZSI6ICJXeW9taW5nIiwKICAgICAgICAgICAgImNvZGUiOiAiV1kiLAogICAgICAgICAgICAic3RhdGUiOiB0cnVlLAogICAgICAgICAgICAidGVycml0b3J5IjogZmFsc2UKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGluY2x1ZGVTdGF0ZXMsIGluY2x1ZGVUZXJyaXRvcmllcywgY29kZVZhbHVlLCBjYXBpdGFsaXplKSB7CgogICAgICAgICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgICAgICAgICAgImtleXMiOiBbXSwKICAgICAgICAgICAgICAgICJ2YWx1ZXMiOiBbXQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBob2xkaW5ncy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGtlZXAgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICBpZiAoaG9sZGluZ3NbaV0uc3RhdGUgJiYgaW5jbHVkZVN0YXRlcykgewogICAgICAgICAgICAgICAgICAgIGtlZXAgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChob2xkaW5nc1tpXS50ZXJyaXRvcnkgJiYgaW5jbHVkZVRlcnJpdG9yaWVzKSB7CiAgICAgICAgICAgICAgICAgICAga2VlcCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGtlZXApIHsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IGhvbGRpbmdzW2ldLmNvZGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gaG9sZGluZ3NbaV0ubmFtZTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvZGVWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGhvbGRpbmdzW2ldLmNvZGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChjYXBpdGFsaXplKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5rZXlzLnB1c2goa2V5KTsKICAgICAgICAgICAgICAgICAgICByZXN1bHQudmFsdWVzLnB1c2godmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH07CiAgICB9KCk7Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLkNvdW50cnlGaWVsZCA9IEFscGFjYS5GaWVsZHMuU2VsZWN0RmllbGQuZXh0ZW5kKAogICAgLyoqCiAgICAgKiBAbGVuZHMgQWxwYWNhLkZpZWxkcy5Db3VudHJ5RmllbGQucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuRmllbGRzLlRleHRGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIENvdW50cnkgQ29udHJvbAogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciBGaWVsZCBjb250YWluZXIuCiAgICAgICAgICogQHBhcmFtIHtBbnl9IGRhdGEgRmllbGQgZGF0YS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBGaWVsZCBvcHRpb25zLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY2hlbWEgRmllbGQgc2NoZW1hLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ30gdmlldyBGaWVsZCB2aWV3LgogICAgICAgICAqIEBwYXJhbSB7QWxwYWNhLkNvbm5lY3Rvcn0gY29ubmVjdG9yIEZpZWxkIGNvbm5lY3Rvci4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBlcnJvckNhbGxiYWNrIEVycm9yIGNhbGxiYWNrLgogICAgICAgICAqLwogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZShjb250YWluZXIsIGRhdGEsIG9wdGlvbnMsIHNjaGVtYSwgdmlldywgY29ubmVjdG9yLCBlcnJvckNhbGxiYWNrKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI3NldHVwCiAgICAgICAgICovCiAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgLy8gZGVmYXVsdHMKICAgICAgICAgICAgaWYgKEFscGFjYS5pc1VuZGVmaW5lZCh0aGlzLm9wdGlvbnMuY2FwaXRhbGl6ZSkpIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5jYXBpdGFsaXplID0gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuc2NoZW1hWyJlbnVtIl0gPSBbXTsKICAgICAgICAgICAgdGhpcy5vcHRpb25zLm9wdGlvbkxhYmVscyA9IFtdOwoKICAgICAgICAgICAgdmFyIGNvdW50cmllc01hcCA9IHRoaXMudmlldy5nZXRNZXNzYWdlKCJjb3VudHJpZXMiKTsKICAgICAgICAgICAgaWYgKGNvdW50cmllc01hcCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZm9yICh2YXIgY291bnRyeUtleSBpbiBjb3VudHJpZXNNYXApCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zY2hlbWFbImVudW0iXS5wdXNoKGNvdW50cnlLZXkpOwoKICAgICAgICAgICAgICAgICAgICB2YXIgbGFiZWwgPSBjb3VudHJpZXNNYXBbY291bnRyeUtleV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5jYXBpdGFsaXplKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsID0gbGFiZWwudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLm9wdGlvbkxhYmVscy5wdXNoKGxhYmVsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtY291bnRyeScpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CgogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2hhbmRsZVZhbGlkYXRlCiAgICAgICAgICovCiAgICAgICAgaGFuZGxlVmFsaWRhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYmFzZVN0YXR1cyA9IHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgLy8gbm8gYWRkaXRpb25hbCB2YWxpZGF0aW9uCgogICAgICAgICAgICByZXR1cm4gYmFzZVN0YXR1czsKICAgICAgICB9LC8vX19CVUlMREVSX0hFTFBFUlMKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFNjaGVtYU9mT3B0aW9ucwogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mT3B0aW9uczogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAiY2FwaXRhbGl6ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogIkNhcGl0YWxpemUiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiV2hldGhlciB0aGUgdmFsdWVzIHNob3VsZCBiZSBjYXBpdGFsaXplZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAicmVhZG9ubHkiOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldE9wdGlvbnNGb3JPcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZ2V0T3B0aW9uc0Zvck9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAiZmllbGRzIjogewogICAgICAgICAgICAgICAgICAgICJjYXBpdGFsaXplIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJjaGVja2JveCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0VGl0bGUKICAgICAgICAgKi8KICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiQ291bnRyeSBGaWVsZCI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJQcm92aWRlcyBhIGRyb3Bkb3duIHNlbGVjdG9yIG9mIGNvdW50cmllcyBrZXllZCBieSB0aGVpciBJU08zIGNvZGUuICBUaGUgbmFtZXMgb2YgdGhlIGNvdW50cmllcyBhcmUgcmVhZCBmcm9tIHRoZSBJMThOIGJ1bmRsZSBmb3IgdGhlIGN1cnJlbnQgbG9jYWxlLiI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXRGaWVsZFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRGaWVsZFR5cGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gImNvdW50cnkiOwogICAgICAgIH0vL19fRU5EX09GX0JVSUxERVJfSEVMUEVSUwogICAgfSk7CgogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiY291bnRyeSIsIEFscGFjYS5GaWVsZHMuQ291bnRyeUZpZWxkKTsKICAgIEFscGFjYS5yZWdpc3RlckRlZmF1bHRGb3JtYXRGaWVsZE1hcHBpbmcoImNvdW50cnkiLCAiY291bnRyeSIpOwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5aaXBjb2RlRmllbGQgPSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZC5leHRlbmQoCiAgICAvKioKICAgICAqIEBsZW5kcyBBbHBhY2EuRmllbGRzLlppcGNvZGVGaWVsZC5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkCiAgICAgICAgICoKICAgICAgICAgKiBAY2xhc3MgWmlwY29kZSBDb250cm9sCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjc2V0dXAKICAgICAgICAgKi8KICAgICAgICBzZXR1cDogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICB0aGlzLm9wdGlvbnMuZm9ybWF0ID0gKHRoaXMub3B0aW9ucy5mb3JtYXQgPyB0aGlzLm9wdGlvbnMuZm9ybWF0IDogIm5pbmUiKTsKCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuZm9ybWF0ID09ICJuaW5lIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zY2hlbWEucGF0dGVybiA9IEFscGFjYS5yZWdleHBzWyJ6aXBjb2RlLW5pbmUiXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0aGlzLm9wdGlvbnMuZm9ybWF0ID09ICJmaXZlIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zY2hlbWEucGF0dGVybiA9IEFscGFjYS5yZWdleHBzWyJ6aXBjb2RlLWZpdmUiXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIEFscGFjYS5sb2dFcnJvcigiVGhlIGNvbmZpZ3VyZWQgemlwY29kZSBmb3JtYXQ6ICIgKyB0aGlzLm9wdGlvbnMuZm9ybWF0ICsgIiBpcyBub3QgYSBsZWdhbCB2YWx1ZSBbZml2ZSwgbmluZV0iKTsKCiAgICAgICAgICAgICAgICAvLyBkZWZhdWx0IHRvIG5pbmUgZm9ybWF0CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuZm9ybWF0ID0gIm5pbmUiOwogICAgICAgICAgICAgICAgdGhpcy5zY2hlbWEucGF0dGVybiA9IEFscGFjYS5yZWdleHBzWyJ6aXBjb2RlLW5pbmUiXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gc2V0IG1hc2sgc3RyaW5nCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuZm9ybWF0ID09ICJuaW5lIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zWyJtYXNrU3RyaW5nIl0gPSAiOTk5OTktOTk5OSI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5vcHRpb25zLmZvcm1hdCA9PSAiZml2ZSIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9uc1sibWFza1N0cmluZyJdID0gIjk5OTk5IjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5iYXNlKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNwb3N0UmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24oY2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5maWVsZENvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHNlbGYuZmllbGRDb250YWluZXIuYWRkQ2xhc3MoJ2FscGFjYS1jb250cm9sZmllbGQtemlwY29kZScpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjaGFuZGxlVmFsaWRhdGUKICAgICAgICAgKi8KICAgICAgICBoYW5kbGVWYWxpZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBiYXNlU3RhdHVzID0gdGhpcy5iYXNlKCk7CgogICAgICAgICAgICB2YXIgdmFsSW5mbyA9IHRoaXMudmFsaWRhdGlvbjsKCiAgICAgICAgICAgIGlmICghdmFsSW5mb1siaW52YWxpZFBhdHRlcm4iXVsic3RhdHVzIl0pIHsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmZvcm1hdCA9PSAibmluZSIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFsSW5mb1siaW52YWxpZFBhdHRlcm4iXVsibWVzc2FnZSJdID0gdGhpcy52aWV3LmdldE1lc3NhZ2UoImludmFsaWRaaXBjb2RlRm9ybWF0TmluZSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5vcHRpb25zLmZvcm1hdCA9PSAiZml2ZSIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFsSW5mb1siaW52YWxpZFBhdHRlcm4iXVsibWVzc2FnZSJdID0gdGhpcy52aWV3LmdldE1lc3NhZ2UoImludmFsaWRaaXBjb2RlRm9ybWF0Rml2ZSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gYmFzZVN0YXR1czsKICAgICAgICB9LC8vX19CVUlMREVSX0hFTFBFUlMKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldFNjaGVtYU9mT3B0aW9ucwogICAgICAgICAqLwogICAgICAgIGdldFNjaGVtYU9mT3B0aW9uczogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICByZXR1cm4gQWxwYWNhLm1lcmdlKHRoaXMuYmFzZSgpLCB7CiAgICAgICAgICAgICAgICAicHJvcGVydGllcyI6IHsKICAgICAgICAgICAgICAgICAgICAiZm9ybWF0IjogewogICAgICAgICAgICAgICAgICAgICAgICAidGl0bGUiOiAiRm9ybWF0IiwKICAgICAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkhvdyB0byByZXByZXNlbnQgdGhlIHppcGNvZGUgZmllbGQiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJpbmciLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVmYXVsdCI6ICJmaXZlIiwKICAgICAgICAgICAgICAgICAgICAgICAgImVudW0iOlsiZml2ZSIsICJuaW5lIl0sCiAgICAgICAgICAgICAgICAgICAgICAgICJyZWFkb25seSI6IHRydWUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0T3B0aW9uc0Zvck9wdGlvbnMKICAgICAgICAgKi8KICAgICAgICBnZXRPcHRpb25zRm9yT3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBbHBhY2EubWVyZ2UodGhpcy5iYXNlKCksIHsKICAgICAgICAgICAgICAgICJmaWVsZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgImZvcm1hdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0VGl0bGUKICAgICAgICAgKi8KICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiWmlwY29kZSBGaWVsZCI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJQcm92aWRlcyBhIGZpdmUgb3IgbmluZS1kaWdpdGFsIFVTIHppcGNvZGUgY29udHJvbCB3aXRoIHZhbGlkYXRpb24uIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiemlwY29kZSI7CiAgICAgICAgfS8vX19FTkRfT0ZfQlVJTERFUl9IRUxQRVJTCiAgICB9KTsKCiAgICBBbHBhY2EucmVnaXN0ZXJNZXNzYWdlcyh7CiAgICAgICAgImludmFsaWRaaXBjb2RlRm9ybWF0Rml2ZSI6ICJJbnZhbGlkIEZpdmUtRGlnaXQgWmlwY29kZSAoIyMjIyMpIiwKICAgICAgICAiaW52YWxpZFppcGNvZGVGb3JtYXROaW5lIjogIkludmFsaWQgTmluZS1EaWdpdCBaaXBjb2RlICgjIyMjIy0jIyMjKSIKICAgIH0pOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygiemlwY29kZSIsIEFscGFjYS5GaWVsZHMuWmlwY29kZUZpZWxkKTsKICAgIEFscGFjYS5yZWdpc3RlckRlZmF1bHRGb3JtYXRGaWVsZE1hcHBpbmcoInppcGNvZGUiLCAiemlwY29kZSIpOwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCQpIHsKCiAgICB2YXIgQWxwYWNhID0gJC5hbHBhY2E7CgogICAgQWxwYWNhLkZpZWxkcy5VUkxGaWVsZCA9IEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkLmV4dGVuZCgKICAgIC8qKgogICAgICogQGxlbmRzIEFscGFjYS5GaWVsZHMuVVJMRmllbGQucHJvdG90eXBlCiAgICAgKi8KICAgIHsKICAgICAgICAvKioKICAgICAgICAgKiBAY29uc3RydWN0cwogICAgICAgICAqIEBhdWdtZW50cyBBbHBhY2EuRmllbGRzLlRleHRGaWVsZAogICAgICAgICAqCiAgICAgICAgICogQGNsYXNzIFVSTCBDb250cm9sCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyIEZpZWxkIGNvbnRhaW5lci4KICAgICAgICAgKiBAcGFyYW0ge0FueX0gZGF0YSBGaWVsZCBkYXRhLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEZpZWxkIG9wdGlvbnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjaGVtYSBGaWVsZCBzY2hlbWEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R8U3RyaW5nfSB2aWV3IEZpZWxkIHZpZXcuCiAgICAgICAgICogQHBhcmFtIHtBbHBhY2EuQ29ubmVjdG9yfSBjb25uZWN0b3IgRmllbGQgY29ubmVjdG9yLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yQ2FsbGJhY2sgRXJyb3IgY2FsbGJhY2suCiAgICAgICAgICovCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5iYXNlKGNvbnRhaW5lciwgZGF0YSwgb3B0aW9ucywgc2NoZW1hLCB2aWV3LCBjb25uZWN0b3IsIGVycm9yQ2FsbGJhY2spOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjc2V0dXAKICAgICAgICAgKi8KICAgICAgICBzZXR1cDogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICB0aGlzLnNjaGVtYS5wYXR0ZXJuID0gQWxwYWNhLnJlZ2V4cHMudXJsOwogICAgICAgICAgICB0aGlzLnNjaGVtYS5mb3JtYXQgPSAidXJpIjsKCiAgICAgICAgICAgIHRoaXMuYmFzZSgpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjcG9zdFJlbmRlcgogICAgICAgICAqLwogICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLXVybCcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CgogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2hhbmRsZVZhbGlkYXRlCiAgICAgICAgICovCiAgICAgICAgaGFuZGxlVmFsaWRhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYmFzZVN0YXR1cyA9IHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgdmFyIHZhbEluZm8gPSB0aGlzLnZhbGlkYXRpb247CgogICAgICAgICAgICBpZiAoIXZhbEluZm9bImludmFsaWRQYXR0ZXJuIl1bInN0YXR1cyJdKSB7CgogICAgICAgICAgICAgICAgdmFsSW5mb1siaW52YWxpZFBhdHRlcm4iXVsibWVzc2FnZSJdID0gdGhpcy52aWV3LmdldE1lc3NhZ2UoImludmFsaWRVUkxGb3JtYXQiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGJhc2VTdGF0dXM7CiAgICAgICAgfSwvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjZ2V0VGl0bGUKICAgICAgICAgKi8KICAgICAgICBnZXRUaXRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiVVJMIEZpZWxkIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldERlc2NyaXB0aW9uCiAgICAgICAgICovCiAgICAgICAgZ2V0RGVzY3JpcHRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIlByb3ZpZGVzIGEgdGV4dCBjb250cm9sIHdpdGggdmFsaWRhdGlvbiBmb3IgYW4gaW50ZXJuZXQgd2ViIGFkZHJlc3MuIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAc2VlIEFscGFjYS5GaWVsZHMuVGV4dEZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAidXJsIjsKICAgICAgICB9Ly9fX0VORF9PRl9CVUlMREVSX0hFTFBFUlMKICAgIH0pOwoKICAgIEFscGFjYS5yZWdpc3Rlck1lc3NhZ2VzKHsKICAgICAgICAiaW52YWxpZFVSTEZvcm1hdCI6ICJUaGUgVVJMIHByb3ZpZGVkIGlzIG5vdCBhIHZhbGlkIHdlYiBhZGRyZXNzLiIKICAgIH0pOwogICAgQWxwYWNhLnJlZ2lzdGVyRmllbGRDbGFzcygidXJsIiwgQWxwYWNhLkZpZWxkcy5VUkxGaWVsZCk7CiAgICBBbHBhY2EucmVnaXN0ZXJEZWZhdWx0Rm9ybWF0RmllbGRNYXBwaW5nKCJ1cmwiLCAidXJsIik7Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oJCkgewoKICAgIHZhciBBbHBhY2EgPSAkLmFscGFjYTsKCiAgICBBbHBhY2EuRmllbGRzLlVwbG9hZEZpZWxkID0gQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQuZXh0ZW5kKAogICAgLyoqCiAgICAgKiBAbGVuZHMgQWxwYWNhLkZpZWxkcy5VcGxvYWRGaWVsZC5wcm90b3R5cGUKICAgICAqLwogICAgewogICAgICAgIC8qKgogICAgICAgICAqIEBjb25zdHJ1Y3RzCiAgICAgICAgICogQGF1Z21lbnRzIEFscGFjYS5GaWVsZHMuT2JqZWN0RmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBjbGFzcyBVcGxvYWQgRmllbGQKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgRmllbGQgY29udGFpbmVyLgogICAgICAgICAqIEBwYXJhbSB7QW55fSBkYXRhIEZpZWxkIGRhdGEuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgRmllbGQgb3B0aW9ucy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NoZW1hIEZpZWxkIHNjaGVtYS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd9IHZpZXcgRmllbGQgdmlldy4KICAgICAgICAgKiBAcGFyYW0ge0FscGFjYS5Db25uZWN0b3J9IGNvbm5lY3RvciBGaWVsZCBjb25uZWN0b3IuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZXJyb3JDYWxsYmFjayBFcnJvciBjYWxsYmFjay4KICAgICAgICAgKi8KICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmJhc2UoY29udGFpbmVyLCBkYXRhLCBvcHRpb25zLCBzY2hlbWEsIHZpZXcsIGNvbm5lY3RvciwgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuRmllbGRzLlRleHRGaWVsZCNzZXR1cAogICAgICAgICAqLwogICAgICAgIHNldHVwOiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZSgpOwoKICAgICAgICAgICAgdGhpcy5jb250cm9sRmllbGRUZW1wbGF0ZURlc2NyaXB0b3IgPSB0aGlzLnZpZXcuZ2V0VGVtcGxhdGVEZXNjcmlwdG9yKCJjb250cm9sRmllbGRVcGxvYWQiKTsKICAgICAgICAgICAgdGhpcy51cGxvYWREZXNjcmlwdG9yID0gc2VsZi52aWV3LmdldFRlbXBsYXRlRGVzY3JpcHRvcigiY29udHJvbEZpZWxkVXBsb2FkX3VwbG9hZCIpOwogICAgICAgICAgICB0aGlzLmRvd25sb2FkRGVzY3JpcHRvciA9IHNlbGYudmlldy5nZXRUZW1wbGF0ZURlc2NyaXB0b3IoImNvbnRyb2xGaWVsZFVwbG9hZF9kb3dubG9hZCIpOwoKICAgICAgICAgICAgaWYgKHR5cGVvZihzZWxmLm9wdGlvbnMubXVsdGlwbGUpID09ICJ1bmRlZmluZWQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzZWxmLm9wdGlvbnMubXVsdGlwbGUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGVvZihzZWxmLm9wdGlvbnMuc2hvd1VwbG9hZFByZXZpZXcpID09ICJ1bmRlZmluZWQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzZWxmLm9wdGlvbnMuc2hvd1VwbG9hZFByZXZpZXcgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRyb2xGaWVsZCNyZW5kZXJGaWVsZAogICAgICAgICAqLwogICAgICAgIHJlbmRlckZpZWxkOiBmdW5jdGlvbihvblN1Y2Nlc3MpIHsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmFzZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBzZWxmLmZpZWxkID0gJChzZWxmLmZpZWxkKS5maW5kKCIuYWxwYWNhLWZpbGV1cGxvYWQtaW5wdXQtaGlkZGVuIik7CgogICAgICAgICAgICAgICAgaWYgKG9uU3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgIG9uU3VjY2VzcygpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkZpZWxkcy5UZXh0RmllbGQjcG9zdFJlbmRlcgogICAgICAgICAqLwogICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLmJhc2UoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgaWYgKHNlbGYuZmllbGRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmZpZWxkQ29udGFpbmVyLmFkZENsYXNzKCdhbHBhY2EtY29udHJvbGZpZWxkLXVwbG9hZCcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHNlbGYuaGFuZGxlUG9zdFJlbmRlcihzZWxmLmZpZWxkQ29udGFpbmVyLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBoYW5kbGVQb3N0UmVuZGVyOiBmdW5jdGlvbihlbCwgY2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB2YXIgdXBsb2FkVGVtcGxhdGVGdW5jdGlvbiA9IGZ1bmN0aW9uKGRhdGEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBBbHBhY2EudG1wbChzZWxmLnVwbG9hZERlc2NyaXB0b3IsIHsKICAgICAgICAgICAgICAgICAgICBvOiBkYXRhCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgIHZhciBkb3dubG9hZFRlbXBsYXRlRnVuY3Rpb24gPSBmdW5jdGlvbihkYXRhKQogICAgICAgICAgICAgewogICAgICAgICAgICAgICAgIHJldHVybiBBbHBhY2EudG1wbChzZWxmLmRvd25sb2FkRGVzY3JpcHRvciwgewogICAgICAgICAgICAgICAgICAgICBvOiBkYXRhCiAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gZmlsZSB1cGxvYWQgY29uZmlnCiAgICAgICAgICAgIHZhciBmaWxlVXBsb2FkQ29uZmlnID0ge307CgogICAgICAgICAgICAvLyBkZWZhdWx0cwogICAgICAgICAgICBmaWxlVXBsb2FkQ29uZmlnWyJkYXRhVHlwZSJdID0gImpzb24iOwogICAgICAgICAgICBmaWxlVXBsb2FkQ29uZmlnWyJ1cGxvYWRUZW1wbGF0ZUlkIl0gPSBudWxsOwogICAgICAgICAgICBmaWxlVXBsb2FkQ29uZmlnWyJ1cGxvYWRUZW1wbGF0ZSJdID0gdXBsb2FkVGVtcGxhdGVGdW5jdGlvbjsKICAgICAgICAgICAgZmlsZVVwbG9hZENvbmZpZ1siZG93bmxvYWRUZW1wbGF0ZUlkIl0gPSBudWxsOwogICAgICAgICAgICBmaWxlVXBsb2FkQ29uZmlnWyJkb3dubG9hZFRlbXBsYXRlIl0gPSBkb3dubG9hZFRlbXBsYXRlRnVuY3Rpb247CiAgICAgICAgICAgIGZpbGVVcGxvYWRDb25maWdbImZpbGVzQ29udGFpbmVyIl0gPSAkKGVsKS5maW5kKCIuZmlsZXMiKTsKICAgICAgICAgICAgZmlsZVVwbG9hZENvbmZpZ1siZHJvcFpvbmUiXSA9ICQoZWwpLmZpbmQoIi5maWxldXBsb2FkLWFjdGl2ZS16b25lIik7CiAgICAgICAgICAgIGZpbGVVcGxvYWRDb25maWdbInVybCJdID0gIi8iOwogICAgICAgICAgICBmaWxlVXBsb2FkQ29uZmlnWyJtZXRob2QiXSA9ICJwb3N0IjsKICAgICAgICAgICAgZmlsZVVwbG9hZENvbmZpZ1sic2hvd1VwbG9hZFByZXZpZXciXSA9IHNlbGYub3B0aW9ucy5zaG93VXBsb2FkUHJldmlldzsKCiAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMudXBsb2FkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBrIGluIHNlbGYub3B0aW9ucy51cGxvYWQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZmlsZVVwbG9hZENvbmZpZ1trXSA9IHNlbGYub3B0aW9ucy51cGxvYWRba107CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMubXVsdGlwbGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICQoZWwpLmZpbmQoIi5hbHBhY2EtZmlsZXVwbG9hZC1pbnB1dCIpLmF0dHIoIm11bHRpcGxlIiwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAkKGVsKS5maW5kKCIuYWxwYWNhLWZpbGV1cGxvYWQtaW5wdXQiKS5hdHRyKCJuYW1lIiwgc2VsZi5uYW1lICsgIl9maWxlc1tdIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGhpZGUgdGhlIHByb2dyZXNzIGJhciBhdCBmaXJzdAogICAgICAgICAgICAkKGVsKS5maW5kKCIucHJvZ3Jlc3MiKS5jc3MoImRpc3BsYXkiLCAibm9uZSIpOwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIElmIGEgZmlsZSBpcyBiZWluZyB1cGxvYWRlZCwgc2hvdyB0aGUgcHJvZ3Jlc3MgYmFyLiAgT3RoZXJ3aXNlLCBoaWRlIGl0LgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0gZQogICAgICAgICAgICAgKiBAcGFyYW0gZGF0YQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZmlsZVVwbG9hZENvbmZpZ1sicHJvZ3Jlc3NhbGwiXSA9IGZ1bmN0aW9uIChlLCBkYXRhKSB7CgogICAgICAgICAgICAgICAgdmFyIHNob3dQcm9ncmVzc0JhciA9IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKGRhdGEubG9hZGVkIDwgZGF0YS50b3RhbCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBzaG93UHJvZ3Jlc3NCYXIgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHNob3dQcm9ncmVzc0JhcikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAkKGVsKS5maW5kKCIucHJvZ3Jlc3MiKS5jc3MoImRpc3BsYXkiLCAiYmxvY2siKTsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJvZ3Jlc3MgPSBwYXJzZUludChkYXRhLmxvYWRlZCAvIGRhdGEudG90YWwgKiAxMDAsIDEwKTsKICAgICAgICAgICAgICAgICAgICAkKCcjcHJvZ3Jlc3MgLnByb2dyZXNzLWJhcicpLmNzcygKICAgICAgICAgICAgICAgICAgICAgICAgJ3dpZHRoJywKICAgICAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3MgKyAnJScKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICQoZWwpLmZpbmQoIi5wcm9ncmVzcyIpLmNzcygiZGlzcGxheSIsICJub25lIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBhbGxvdyBmb3IgZXh0ZW5zaW9uCiAgICAgICAgICAgIHNlbGYuYXBwbHlDb25maWd1cmF0aW9uKGZpbGVVcGxvYWRDb25maWcpOwoKICAgICAgICAgICAgLy8gaW5zdGFudGlhdGUgdGhlIGNvbnRyb2wKICAgICAgICAgICAgdmFyIGZpbGVVcGxvYWQgPSBzZWxmLmZpbGVVcGxvYWQgPSAkKGVsKS5maW5kKCcuYWxwYWNhLWZpbGV1cGxvYWQtaW5wdXQnKS5maWxldXBsb2FkKGZpbGVVcGxvYWRDb25maWcpOwoKICAgICAgICAgICAgLy8gV2hlbiBmaWxlIHVwbG9hZCBvZiBhIGZpbGUgY29tcGV0ZXMsIHdlIG9mZmVyIHRoZSBjaGFuY2UgdG8gYWRqdXN0IHRoZSBkYXRhIGFoZWFkIG9mIEZpbGVVcGxvYWQKICAgICAgICAgICAgLy8gZ2V0dGluZyBpdC4gIFRoaXMgaXMgdXNlZnVsIGZvciBjYXNlcyB3aGVyZSB5b3UgY2FuJ3QgY2hhbmdlIHRoZSBzZXJ2ZXIgc2lkZSBKU09OIGJ1dCBjb3VsZCBkbwogICAgICAgICAgICAvLyBhIGxpdHRsZSBiaXQgb2YgbWFnaWMgaW4gdGhlIGNsaWVudC4KICAgICAgICAgICAgZmlsZVVwbG9hZC5iaW5kRmlyc3QoImZpbGV1cGxvYWRkb25lIiwgZnVuY3Rpb24oZSwgZGF0YSkgewoKICAgICAgICAgICAgICAgIHZhciBlbmhhbmNlRmlsZXMgPSBzZWxmLm9wdGlvbnMuZW5oYW5jZUZpbGVzOwogICAgICAgICAgICAgICAgaWYgKGVuaGFuY2VGaWxlcykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBlbmhhbmNlRmlsZXMoZmlsZVVwbG9hZENvbmZpZywgZGF0YSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5lbmhhbmNlRmlsZXMoZmlsZVVwbG9hZENvbmZpZywgZGF0YSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gY29weSBiYWNrIGRvd24gaW50byBkYXRhLmZpbGVzCiAgICAgICAgICAgICAgICBkYXRhLmZpbGVzID0gZGF0YS5yZXN1bHQuZmlsZXM7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gV2hlbiBmaWxlcyBhcmUgc3VibWl0dGVkLCB0aGUgInByb3BlcnRpZXMiIGFuZCAicGFyYW1ldGVycyIgb3B0aW9ucyBtYXAgYXJlIGVzcGVjaWFsbHkgdHJlYXRlZAogICAgICAgICAgICAvLyBhbmQgYXJlIHdyaXR0ZW4gaW50byBwcm9wZXJ0eTxpbmRleD5fXzxrZXk+IGFuZCBwYXJhbTxpbmRleD5fX2tleSBlbnRyaWVzIGluIHRoZSBmb3JtIGRhdGEuCiAgICAgICAgICAgIC8vIFRoaXMgYWxsb3dzIGZvciBtdWx0aS1wYXJ0IHJlY2VpdmVycyB0byBnZXQgdmFsdWVzIG9uIGEgcGVyLWZpbGUgYmFzaXMuCiAgICAgICAgICAgIC8vIFBsYW5zIGFyZSB0byBhbGxvdyB0b2tlbiBzdWJzdGl0dXRpb24gYW5kIG90aGVyIGNsaWVudC1zaWRlIHRyZWF0bWVudCBhaGVhZCBvZiBwb3N0aW5nLgogICAgICAgICAgICBmaWxlVXBsb2FkLmJpbmRGaXJzdCgiZmlsZXVwbG9hZHN1Ym1pdCIsIGZ1bmN0aW9uKGUsIGRhdGEpIHsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zWyJwcm9wZXJ0aWVzIl0pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgJC5lYWNoKGRhdGEuZmlsZXMsIGZ1bmN0aW9uKGluZGV4LCBmaWxlKSB7CgogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gc2VsZi5vcHRpb25zWyJwcm9wZXJ0aWVzIl0pCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcm9wZXJ0eU5hbWUgPSAicHJvcGVydHkiICsgaW5kZXggKyAiX18iICsga2V5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByb3BlcnR5VmFsdWUgPSBzZWxmLm9wdGlvbnNbInByb3BlcnRpZXMiXVtrZXldOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRva2VuIHN1YnN0aXR1dGlvbnMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnR5VmFsdWUgPSBzZWxmLmFwcGx5VG9rZW5TdWJzdGl0dXRpb25zKHByb3BlcnR5VmFsdWUsIGluZGV4LCBmaWxlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWRhdGEuZm9ybURhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmZvcm1EYXRhID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5mb3JtRGF0YVtwcm9wZXJ0eU5hbWVdID0gcHJvcGVydHlWYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnNbInBhcmFtZXRlcnMiXSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAkLmVhY2goZGF0YS5maWxlcywgZnVuY3Rpb24oaW5kZXgsIGZpbGUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBzZWxmLm9wdGlvbnNbInBhcmFtZXRlcnMiXSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmFtTmFtZSA9ICJwYXJhbSIgKyBpbmRleCArICJfXyIgKyBrZXk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyYW1WYWx1ZSA9IHNlbGYub3B0aW9uc1sicGFyYW1ldGVycyJdW2tleV07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdG9rZW4gc3Vic3RpdHV0aW9ucwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1WYWx1ZSA9IHNlbGYuYXBwbHlUb2tlblN1YnN0aXR1dGlvbnMocGFyYW1WYWx1ZSwgaW5kZXgsIGZpbGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZGF0YS5mb3JtRGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuZm9ybURhdGEgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmZvcm1EYXRhW3BhcmFtTmFtZV0gPSBwYXJhbVZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIFdoZW4gZmlsZXMgYXJlIHVwbG9hZGVkLCB3ZSBhZGp1c3QgdGhlIHZhbHVlIG9mIHRoZSBmaWVsZC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGZpbGVVcGxvYWQuYmluZCgiZmlsZXVwbG9hZGRvbmUiLCBmdW5jdGlvbihlLCBkYXRhKSB7CgogICAgICAgICAgICAgICAgLy8gZXhpc3RpbmcKICAgICAgICAgICAgICAgIHZhciBhcnJheSA9IHNlbGYuZ2V0VmFsdWUoKTsKCiAgICAgICAgICAgICAgICB2YXIgZiA9IGZ1bmN0aW9uKGkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGkgPT0gZGF0YS5maWxlcy5sZW5ndGgpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBkb25lCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2V0VmFsdWUoYXJyYXkpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBzZWxmLmNvbnZlcnRGaWxlVG9EZXNjcmlwdG9yKGRhdGEuZmlsZXNbaV0sIGZ1bmN0aW9uKGVyciwgZGVzY3JpcHRvcikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVzY3JpcHRvcikKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkucHVzaChkZXNjcmlwdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBmKGkrMSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZigwKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBhbGxvdyBmb3IgZXh0ZW5zaW9uCiAgICAgICAgICAgIHNlbGYuYXBwbHlCaW5kaW5ncyhmaWxlVXBsb2FkLCBlbCk7CgogICAgICAgICAgICAvLyBhbGxvdyBmb3IgcHJlbG9hZGluZyBvZiBkb2N1bWVudHMKICAgICAgICAgICAgc2VsZi5wcmVsb2FkKGZpbGVVcGxvYWQsIGVsLCBmdW5jdGlvbihmaWxlcykgewoKICAgICAgICAgICAgICAgIGlmIChmaWxlcykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZm9ybSA9ICQoc2VsZi5maWVsZENvbnRhaW5lcikuZmluZCgnLmFscGFjYS1maWxldXBsb2FkLWlucHV0Jyk7CiAgICAgICAgICAgICAgICAgICAgJChmb3JtKS5maWxldXBsb2FkKCdvcHRpb24nLCAnZG9uZScpLmNhbGwoZm9ybSwgJC5FdmVudCgnZG9uZScpLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZXM6IGZpbGVzCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgc2VsZi5hZnRlclByZWxvYWQoZmlsZVVwbG9hZCwgZWwsIGZpbGVzLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBhcHBseVRva2VuU3Vic3RpdHV0aW9uczogZnVuY3Rpb24odGV4dCwgaW5kZXgsIGZpbGUpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdG9rZW5zID0gewogICAgICAgICAgICAgICAgImluZGV4IjogaW5kZXgsCiAgICAgICAgICAgICAgICAibmFtZSI6IGZpbGUubmFtZSwKICAgICAgICAgICAgICAgICJzaXplIjogZmlsZS5zaXplLAogICAgICAgICAgICAgICAgInVybCI6IGZpbGUudXJsLAogICAgICAgICAgICAgICAgInRodW1ibmFpbFVybCI6IGZpbGUudGh1bWJuYWlsVXJsCiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBzdWJzdGl0dXRlIGFueSB0b2tlbnMKICAgICAgICAgICAgdmFyIHggPSAtMTsKICAgICAgICAgICAgdmFyIGIgPSAwOwogICAgICAgICAgICBkbwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB4ID0gdGV4dC5pbmRleE9mKCJ7IiwgYik7CiAgICAgICAgICAgICAgICBpZiAoeCA+IC0xKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciB5ID0gdGV4dC5pbmRleE9mKCJ9IiwgeCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHkgPiAtMSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IHRleHQuc3Vic3RyaW5nKHggKyBjYXIubGVuZ3RoLCB5KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXBsYWNlbWVudCA9IHRva2Vuc1t0b2tlbl07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXBsYWNlbWVudCkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRleHQuc3Vic3RyaW5nKDAsIHgpICsgcmVwbGFjZW1lbnQgKyB0ZXh0LnN1YnN0cmluZyh5KzEpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBiID0geSArIDE7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlKHggPiAtMSk7CgogICAgICAgICAgICByZXR1cm4gdGV4dDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZW1vdmVzIGEgZGVzY3JpcHRvciB3aXRoIHRoZSBnaXZlbiBpZCBmcm9tIHRoZSB2YWx1ZSBzZXQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gaWQKICAgICAgICAgKi8KICAgICAgICByZW1vdmVWYWx1ZTogZnVuY3Rpb24oaWQpCiAgICAgICAgewogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICB2YXIgYXJyYXkgPSBzZWxmLmdldFZhbHVlKCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChhcnJheVtpXS5pZCA9PSBpZCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBhcnJheS5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNlbGYuc2V0VmFsdWUoYXJyYXkpOwogICAgICAgIH0sCgoKICAgICAgICAvKioKICAgICAgICAgKiBFeHRlbnNpb24gcG9pbnQgZm9yIGFkZGluZyBwcm9wZXJ0aWVzIGFuZCBjYWxsYmFja3MgdG8gdGhlIGZpbGUgdXBsb2FkIGNvbmZpZy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBmaWxlVXBsb2FkY29uZmlnCiAgICAgICAgICovCiAgICAgICAgYXBwbHlDb25maWd1cmF0aW9uOiBmdW5jdGlvbihmaWxlVXBsb2FkY29uZmlnKQogICAgICAgIHsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBFeHRlbnNpb24gcG9pbnQgZm9yIGJpbmRpbmcgZXZlbnQgaGFuZGxlcnMgdG8gZmlsZSB1cGxvYWQgaW5zdGFuY2UuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gZmlsZVVwbG9hZAogICAgICAgICAqLwogICAgICAgIGFwcGx5QmluZGluZ3M6IGZ1bmN0aW9uKGZpbGVVcGxvYWQpCiAgICAgICAgewogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENvbnZlcnRzIGZyb20gYSBmaWxlIHRvIGEgc3RvcmFnZSBkZXNjcmlwdG9yLgogICAgICAgICAqCiAgICAgICAgICogQSBkZXNjcmlwdG9yIGxvb2tzIGxpa2U6CiAgICAgICAgICoKICAgICAgICAgKiAgICAgIHsKICAgICAgICAgKiAgICAgICAgICAiaWQiOiAiIgogICAgICAgICAqICAgICAgICAgIC4uLgogICAgICAgICAqICAgICAgfQogICAgICAgICAqCiAgICAgICAgICogQSBkZXNjcmlwdG9yIG1heSBjb250YWluIGFkZGl0aW9uYWwgcHJvcGVydGllcyBhcyBuZWVkZWQgYnkgdGhlIHVuZGVybHlpbmcgc3RvcmFnZSBpbXBsZW1lbnRhdGlvbgogICAgICAgICAqIHNvIGFzIHRvIHJldHJpZXZlIG1ldGFkYXRhIGFib3V0IHRoZSBkZXNjcmliZWQgZmlsZS4KICAgICAgICAgKgogICAgICAgICAqIEFzc3VtcHRpb24gaXMgdGhhdCB0aGUgdW5kZXJseWluZyBwZXJzaXN0ZW5jZSBtZWNoYW5pc20gbWF5IG5lZWQgdG8gYmUgY29uc3VsdGVkLiAgVGh1cywgdGhpcyBpcyBhc3luYy4KICAgICAgICAgKgogICAgICAgICAqIEJ5IGRlZmF1bHQsIHRoZSBkZXNjcmlwdG9yIG1pbWljcyB0aGUgZmlsZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBmaWxlCiAgICAgICAgICogQHBhcmFtIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGVzY3JpcHRvcikKICAgICAgICAgKi8KICAgICAgICBjb252ZXJ0RmlsZVRvRGVzY3JpcHRvcjogZnVuY3Rpb24oZmlsZSwgY2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB2YXIgZGVzY3JpcHRvciA9IHsKICAgICAgICAgICAgICAgICJpZCI6IGZpbGUuaWQsCiAgICAgICAgICAgICAgICAibmFtZSI6IGZpbGUubmFtZSwKICAgICAgICAgICAgICAgICJzaXplIjogZmlsZS5zaXplLAogICAgICAgICAgICAgICAgInVybCI6IGZpbGUudXJsLAogICAgICAgICAgICAgICAgInRodW1ibmFpbFVybCI6ZmlsZS50aHVtYm5haWxVcmwsCiAgICAgICAgICAgICAgICAiZGVsZXRlVXJsIjogZmlsZS5kZWxldGVVcmwsCiAgICAgICAgICAgICAgICAiZGVsZXRlVHlwZSI6IGZpbGUuZGVsZXRlVHlwZQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgZGVzY3JpcHRvcik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ29udmVydHMgYSBzdG9yYWdlIGRlc2NyaXB0b3IgdG8gYSBmaWxlLgogICAgICAgICAqCiAgICAgICAgICogQSBmaWxlIGxvb2tzIGxpa2U6CiAgICAgICAgICoKICAgICAgICAgKiAgICAgIHsKICAgICAgICAgKiAgICAgICAgICAiaWQiOiAiIiwKICAgICAgICAgKiAgICAgICAgICAibmFtZSI6ICJwaWN0dXJlMS5qcGciLAogICAgICAgICAqICAgICAgICAgICJzaXplIjogOTAyNjA0LAogICAgICAgICAqICAgICAgICAgICJ1cmwiOiAiaHR0cDpcL1wvZXhhbXBsZS5vcmdcL2ZpbGVzXC9waWN0dXJlMS5qcGciLAogICAgICAgICAqICAgICAgICAgICJ0aHVtYm5haWxVcmwiOiAiaHR0cDpcL1wvZXhhbXBsZS5vcmdcL2ZpbGVzXC90aHVtYm5haWxcL3BpY3R1cmUxLmpwZyIsCiAgICAgICAgICogICAgICAgICAgImRlbGV0ZVVybCI6ICJodHRwOlwvXC9leGFtcGxlLm9yZ1wvZmlsZXNcL3BpY3R1cmUxLmpwZyIsCiAgICAgICAgICogICAgICAgICAgImRlbGV0ZVR5cGUiOiAiREVMRVRFIgogICAgICAgICAqICAgICAgfQogICAgICAgICAqCiAgICAgICAgICogU2luY2UgYW4gdW5kZXJseWluZyBzdG9yYWdlIG1lY2hhbmlzbSBtYXkgYmUgY29uc3VsdGVkLCBhbiBhc3luYyBjYWxsYmFjayBob29rIGlzIHByb3ZpZGVkLgogICAgICAgICAqCiAgICAgICAgICogQnkgZGVmYXVsdCwgdGhlIGRlc2NyaXB0b3IgbWltaWNzIHRoZSBmaWxlLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIGRlc2NyaXB0b3IKICAgICAgICAgKiBAcGFyYW0gY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBmaWxlKQogICAgICAgICAqLwogICAgICAgIGNvbnZlcnREZXNjcmlwdG9yVG9GaWxlOiBmdW5jdGlvbihkZXNjcmlwdG9yLCBjYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBmaWxlID0gewogICAgICAgICAgICAgICAgImlkIjogZGVzY3JpcHRvci5pZCwKICAgICAgICAgICAgICAgICJuYW1lIjogZGVzY3JpcHRvci5uYW1lLAogICAgICAgICAgICAgICAgInNpemUiOiBkZXNjcmlwdG9yLnNpemUsCiAgICAgICAgICAgICAgICAidXJsIjogZGVzY3JpcHRvci51cmwsCiAgICAgICAgICAgICAgICAidGh1bWJuYWlsVXJsIjpkZXNjcmlwdG9yLnRodW1ibmFpbFVybCwKICAgICAgICAgICAgICAgICJkZWxldGVVcmwiOiBkZXNjcmlwdG9yLmRlbGV0ZVVybCwKICAgICAgICAgICAgICAgICJkZWxldGVUeXBlIjogZGVzY3JpcHRvci5kZWxldGVUeXBlCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjYWxsYmFjayhudWxsLCBmaWxlKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBFeHRlbnNpb24gcG9pbnQgZm9yICJlbmhhbmNpbmciIGRhdGEgcmVjZWl2ZWQgZnJvbSB0aGUgcmVtb3RlIHNlcnZlciBhZnRlciB1cGxvYWRzIGhhdmUgYmVlbiBzdWJtaXR0ZWQuCiAgICAgICAgICogVGhpcyBwcm92aWRlcyBhIHBsYWNlIHRvIGNvbnZlcnQgdGhlIGRhdGEucm93cyBiYWNrIGludG8gdGhlIGZvcm1hdCB3aGljaCB0aGUgdXBsb2FkIGNvbnRyb2wgZXhwZWN0cy4KICAgICAgICAgKgogICAgICAgICAqIEV4cGVjdGVkIGZvcm1hdDoKICAgICAgICAgKgogICAgICAgICAqICAgIGRhdGEucmVzdWx0LnJvd3MgPSBbey4uLn1dCiAgICAgICAgICogICAgZGF0YS5yZXN1bHQuZmlsZXMgPSBbewogICAgICAgICAqICAgICAgImlkIjogIiIsCiAgICAgICAgICogICAgICAicGF0aCI6ICIiLAogICAgICAgICAqICAgICAgIm5hbWUiOiAicGljdHVyZTEuanBnIiwKICAgICAgICAgKiAgICAgICJzaXplIjogOTAyNjA0LAogICAgICAgICAqICAgICAgInVybCI6ICJodHRwOlwvXC9leGFtcGxlLm9yZ1wvZmlsZXNcL3BpY3R1cmUxLmpwZyIsCiAgICAgICAgICogICAgICAidGh1bWJuYWlsVXJsIjogImh0dHA6XC9cL2V4YW1wbGUub3JnXC9maWxlc1wvdGh1bWJuYWlsXC9waWN0dXJlMS5qcGciLAogICAgICAgICAqICAgICAgImRlbGV0ZVVybCI6ICJodHRwOlwvXC9leGFtcGxlLm9yZ1wvZmlsZXNcL3BpY3R1cmUxLmpwZyIsCiAgICAgICAgICogICAgICAiZGVsZXRlVHlwZSI6ICJERUxFVEUiKgogICAgICAgICAqICAgIH1dCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gZmlsZVVwbG9hZENvbmZpZwogICAgICAgICAqIEBwYXJhbSByb3cKICAgICAgICAgKi8KICAgICAgICBlbmhhbmNlRmlsZXM6IGZ1bmN0aW9uKGZpbGVVcGxvYWRDb25maWcsIGRhdGEpCiAgICAgICAgewogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFByZWxvYWRzIGRhdGEgZGVzY3JpcHRvcnMgaW50byBmaWxlcy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBmaWxlVXBsb2FkCiAgICAgICAgICogQHBhcmFtIGVsCiAgICAgICAgICogQHBhcmFtIGNhbGxiYWNrCiAgICAgICAgICovCiAgICAgICAgcHJlbG9hZDogZnVuY3Rpb24oZmlsZVVwbG9hZCwgZWwsIGNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgdmFyIGZpbGVzID0gW107CgogICAgICAgICAgICAvLyBub3cgcHJlbG9hZCB3aXRoIGZpbGVzIGJhc2VkIG9uIHByb3BlcnR5IHZhbHVlCiAgICAgICAgICAgIHZhciBkZXNjcmlwdG9ycyA9IHNlbGYuZ2V0VmFsdWUoKTsKCiAgICAgICAgICAgIHZhciBmID0gZnVuY3Rpb24oaSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGkgPT0gZGVzY3JpcHRvcnMubGVuZ3RoKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIGFsbCBkb25lCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZmlsZXMpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBzZWxmLmNvbnZlcnREZXNjcmlwdG9yVG9GaWxlKGRlc2NyaXB0b3JzW2ldLCBmdW5jdGlvbihlcnIsIGZpbGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZmlsZSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVzLnB1c2goZmlsZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGYoaSsxKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwogICAgICAgICAgICBmKDApOwogICAgICAgIH0sCgogICAgICAgIGFmdGVyUHJlbG9hZDogZnVuY3Rpb24oZmlsZVVwbG9hZCwgZWwsIGZpbGVzLCBjYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG92ZXJyaWRlCiAgICAgICAgICoKICAgICAgICAgKiBSZXRyaWV2ZXMgYW4gYXJyYXkgb2YgZGVzY3JpcHRvcnMuCiAgICAgICAgICovCiAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICghdGhpcy5kYXRhKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmRhdGEgPSBbXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGF0YTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAb3ZlcnJpZGUKICAgICAgICAgKgogICAgICAgICAqIFNldHMgYW4gYXJyYXkgb2YgZGVzY3JpcHRvcnMuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gZGF0YQogICAgICAgICAqLwogICAgICAgIHNldFZhbHVlOiBmdW5jdGlvbihkYXRhKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5kYXRhID0gZGF0YTsKICAgICAgICB9LAoKICAgICAgICByZWxvYWQ6IGZ1bmN0aW9uKGNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgdmFyIGRlc2NyaXB0b3JzID0gdGhpcy5nZXRWYWx1ZSgpOwoKICAgICAgICAgICAgdmFyIGZpbGVzID0gW107CgogICAgICAgICAgICB2YXIgZiA9IGZ1bmN0aW9uKGkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChpID09IGRlc2NyaXB0b3JzLmxlbmd0aCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBhbGwgZG9uZQoKICAgICAgICAgICAgICAgICAgICB2YXIgZm9ybSA9ICQoc2VsZi5maWVsZENvbnRhaW5lcikuZmluZCgnLmFscGFjYS1maWxldXBsb2FkLWlucHV0Jyk7CiAgICAgICAgICAgICAgICAgICAgJChmb3JtKS5maWxldXBsb2FkKCdvcHRpb24nLCAnZG9uZScpLmNhbGwoZm9ybSwgJC5FdmVudCgnZG9uZScpLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZXM6IGZpbGVzCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHNlbGYuY29udmVydERlc2NyaXB0b3JUb0ZpbGUoZGVzY3JpcHRvcnNbaV0sIGZ1bmN0aW9uKGVyciwgZmlsZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChmaWxlKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmlsZXMucHVzaChmaWxlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZihpKzEpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGYoMCk7CiAgICAgICAgfSwKICAgICAgICAvL19fQlVJTERFUl9IRUxQRVJTCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRyb2xGaWVsZCNnZXRUaXRsZQogICAgICAgICAqLwogICAgICAgIGdldFRpdGxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJVcGxvYWQgRmllbGQiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBzZWUgQWxwYWNhLkNvbnRyb2xGaWVsZCNnZXREZXNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIGdldERlc2NyaXB0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJQcm92aWRlcyBhbiB1cGxvYWQgZmllbGQgd2l0aCBzdXBwb3J0IGZvciB0aHVtYm5haWwgcHJldmlldyI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2dldFR5cGUKICAgICAgICAgKi8KICAgICAgICBnZXRUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJhcnJheSI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHNlZSBBbHBhY2EuQ29udHJvbEZpZWxkI2dldEZpZWxkVHlwZQogICAgICAgICAqLwogICAgICAgIGdldEZpZWxkVHlwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAidXBsb2FkIjsKICAgICAgICB9Ly9fX0VORF9PRl9CVUlMREVSX0hFTFBFUlMKICAgIH0pOwoKICAgIHZhciBURU1QTEFURSA9ICcgXAogICAgICAgIDxkaXYgY2xhc3M9ImFscGFjYS1maWxldXBsb2FkLWNvbnRhaW5lciB7e2lmIGNzc0NsYXNzZXN9fSR7Y3NzQ2xhc3Nlc317ey9pZn19Ij4gXAogICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb250YWluZXItZmx1aWQiPiBcCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJyb3ciPiBcCiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29sLW1kLTEyIj4gXAogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJidG4tZ3JvdXAiPiBcCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLWRlZmF1bHQgZmlsZWlucHV0LWJ1dHRvbiI+IFwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8aSBjbGFzcz0iZ2x5cGhpY29uIGdseXBoaWNvbi11cGxvYWQiPjwvaT4gXAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJmaWxldXBsb2FkLWFkZC1idXR0b24iPkNob29zZSBmaWxlcy4uLjwvc3Bhbj4gXAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCBjbGFzcz0iYWxwYWNhLWZpbGV1cGxvYWQtaW5wdXQiIHR5cGU9ImZpbGUiIG5hbWU9IiR7bmFtZX1fZmlsZXMiPiBcCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IGNsYXNzPSJhbHBhY2EtZmlsZXVwbG9hZC1pbnB1dC1oaWRkZW4iIHR5cGU9ImhpZGRlbiIgbmFtZT0iJHtuYW1lfV9maWxlc19oaWRkZW4iPiBcCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2J1dHRvbj4gXAogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4gXAogICAgICAgICAgICAgICAgICAgIDwvZGl2PiBcCiAgICAgICAgICAgICAgICA8L2Rpdj4gXAogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icm93IGFscGFjYS1maWxldXBsb2FkLXdlbGwiPiBcCiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29sLW1kLTEyIGZpbGV1cGxvYWQtYWN0aXZlLXpvbmUiPiBcCiAgICAgICAgICAgICAgICAgICAgICAgIDx0YWJsZSBjbGFzcz0idGFibGUgdGFibGUtc3RyaXBlZCI+IFwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0Ym9keSBjbGFzcz0iZmlsZXMiPiBcCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3Rib2R5PiBcCiAgICAgICAgICAgICAgICAgICAgICAgIDwvdGFibGU+IFwKICAgICAgICAgICAgICAgICAgICAgICAgPHAgYWxpZ249ImNlbnRlciI+Q2xpY2sgdGhlIENob29zZSBidXR0b24gb3IgRHJhZyBhbmQgRHJvcCBmaWxlcyBoZXJlIHRvIHN0YXJ0Li4uPC9wPiBcCiAgICAgICAgICAgICAgICAgICAgPC9kaXY+IFwKICAgICAgICAgICAgICAgIDwvZGl2PiBcCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJyb3ciPiBcCiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29sLW1kLTEyIj4gXAogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGlkPSJwcm9ncmVzcyIgY2xhc3M9InByb2dyZXNzIj4gXAogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icHJvZ3Jlc3MtYmFyIHByb2dyZXNzLWJhci1zdWNjZXNzIj48L2Rpdj4gXAogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4gXAogICAgICAgICAgICAgICAgICAgIDwvZGl2PiBcCiAgICAgICAgICAgICAgICA8L2Rpdj4gXAogICAgICAgICAgICA8L2Rpdj4gXAogICAgICAgIDwvZGl2PiBcCiAgICAnOwoKICAgIHZhciBURU1QTEFURV9VUExPQUQgPSAnIFwKICAgICAgICA8c2NyaXB0IGlkPSJ0ZW1wbGF0ZS11cGxvYWQiIHR5cGU9InRleHQveC10bXBsIj4gXAogICAgICAgIHt7ZWFjaChpLCBmaWxlKSBvLmZpbGVzfX0gXAogICAgICAgICAgICA8dHIgY2xhc3M9InRlbXBsYXRlLXVwbG9hZCBmYWRlIj4gXAogICAgICAgICAgICAgICAge3tpZiBvLm9wdGlvbnMuc2hvd1VwbG9hZFByZXZpZXd9fSBcCiAgICAgICAgICAgICAgICA8dGQgY2xhc3M9InByZXZpZXciPiBcCiAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImZhZGUiPjwvc3Bhbj4gXAogICAgICAgICAgICAgICAgPC90ZD4gXAogICAgICAgICAgICAgICAge3tlbHNlfX0gXAogICAgICAgICAgICAgICAgPHRkPiBcCiAgICAgICAgICAgICAgICA8L3RkPiBcCiAgICAgICAgICAgICAgICB7ey9pZn19IFwKICAgICAgICAgICAgICAgIDx0ZCBjbGFzcz0ibmFtZSI+PHNwYW4+JHtmaWxlLm5hbWV9PC9zcGFuPjwvdGQ+IFwKICAgICAgICAgICAgICAgIDx0ZCBjbGFzcz0ic2l6ZSI+PHNwYW4+JHtmaWxlLnNpemV9PC9zcGFuPjwvdGQ+IFwKICAgICAgICAgICAge3tpZiBmaWxlLmVycm9yfX0gXAogICAgICAgICAgICAgICAgPHRkIGNsYXNzPSJlcnJvciIgY29sc3Bhbj0iMiI+PHNwYW4gY2xhc3M9ImxhYmVsIGxhYmVsLWltcG9ydGFudCI+RXJyb3I8L3NwYW4+ICR7ZmlsZS5lcnJvcn08L3RkPiBcCiAgICAgICAgICAgIHt7ZWxzZX19IFwKICAgICAgICAgICAgICAgIHt7aWYgby5maWxlcy52YWxpZCAmJiAhaX19IFwKICAgICAgICAgICAgICAgIDx0ZD4gXAogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InByb2dyZXNzIHByb2dyZXNzLXN1Y2Nlc3MgcHJvZ3Jlc3Mtc3RyaXBlZCBhY3RpdmUiIHJvbGU9InByb2dyZXNzYmFyIiBhcmlhLXZhbHVlbWluPSIwIiBhcmlhLXZhbHVlbWF4PSIxMDAiIGFyaWEtdmFsdWVub3c9IjAiPiBcCiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InByb2dyZXNzLWJhciIgc3R5bGU9IndpZHRoOjAlOyI+PC9kaXY+XAogICAgICAgICAgICAgICAgICAgIDwvZGl2PiBcCiAgICAgICAgICAgICAgICA8L3RkPiBcCiAgICAgICAgICAgICAgICA8dGQgY2xhc3M9InN0YXJ0Ij5cCiAgICAgICAgICAgICAgICB7e2lmICFvLm9wdGlvbnMuYXV0b1VwbG9hZH19IFwKICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXByaW1hcnkiPiBcCiAgICAgICAgICAgICAgICAgICAgICAgIDxpIGNsYXNzPSJnbHlwaGljb24gZ2x5cGhpY29uLXVwbG9hZCBnbHlwaGljb24td2hpdGUiPjwvaT4gXAogICAgICAgICAgICAgICAgICAgICAgICA8c3Bhbj5TdGFydDwvc3Bhbj4gXAogICAgICAgICAgICAgICAgICAgIDwvYnV0dG9uPiBcCiAgICAgICAgICAgICAgICB7ey9pZn19IFwKICAgICAgICAgICAgICAgIDwvdGQ+IFwKICAgICAgICAgICAgICAgIHt7ZWxzZX19IFwKICAgICAgICAgICAgICAgIDx0ZCBjb2xzcGFuPSIyIj48L3RkPiBcCiAgICAgICAgICAgICAgICA8dGQgY2xhc3M9ImNhbmNlbCI+XAogICAgICAgICAgICAgICAge3tpZiAhaX19IFwKICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXdhcm5pbmciPiBcCiAgICAgICAgICAgICAgICAgICAgICAgIDxpIGNsYXNzPSJnbHlwaGljb24gZ2x5cGhpY29uLWJhbi1jaXJjbGUgZ2x5cGhpY29uLXdoaXRlIj48L2k+IFwKICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4+Q2FuY2VsPC9zcGFuPiBcCiAgICAgICAgICAgICAgICAgICAgPC9idXR0b24+IFwKICAgICAgICAgICAgICAgIHt7L2lmfX0gXAogICAgICAgICAgICAgICAgPC90ZD4gXAogICAgICAgICAgICAgICAge3svaWZ9fSBcCiAgICAgICAgICAgIHt7L2lmfX0gXAogICAgICAgICAgICAgICAgPHRkPjwvdGQ+IFwKICAgICAgICAgICAgPC90cj4gXAogICAgICAgIHt7L2VhY2h9fSBcCiAgICAgICAgPC9zY3JpcHQ+IFwKICAgICc7CgogICAgdmFyIFRFTVBMQVRFX0RPV05MT0FEID0gJyBcCiAgICAgICAgPHNjcmlwdCBpZD0idGVtcGxhdGUtZG93bmxvYWQiIHR5cGU9InRleHQveC10bXBsIj4gXAogICAgICAgIHt7ZWFjaChpLCBmaWxlKSBvLmZpbGVzfX0gXAogICAgICAgICAgICA8dHIgY2xhc3M9InRlbXBsYXRlLWRvd25sb2FkIGZhZGUiPiBcCiAgICAgICAgICAgIHt7aWYgZmlsZS5lcnJvcn19IFwKICAgICAgICAgICAgICAgIDx0ZD48L3RkPiBcCiAgICAgICAgICAgICAgICA8dGQgY2xhc3M9Im5hbWUiPjxzcGFuPiR7ZmlsZS5uYW1lfTwvc3Bhbj48L3RkPiBcCiAgICAgICAgICAgICAgICA8dGQgY2xhc3M9InNpemUiPjxzcGFuPiR7ZmlsZS5zaXplfTwvc3Bhbj48L3RkPiBcCiAgICAgICAgICAgICAgICA8dGQgY2xhc3M9ImVycm9yIiBjb2xzcGFuPSIyIj48c3BhbiBjbGFzcz0ibGFiZWwgbGFiZWwtaW1wb3J0YW50Ij5FcnJvcjwvc3Bhbj4gJHtmaWxlLmVycm9yfTwvdGQ+IFwKICAgICAgICAgICAge3tlbHNlfX0gXAogICAgICAgICAgICAgICAgPHRkIGNsYXNzPSJwcmV2aWV3Ij4gXAogICAgICAgICAgICAgICAge3tpZiBmaWxlLnRodW1ibmFpbFVybH19IFwKICAgICAgICAgICAgICAgICAgICA8YSBocmVmPSIke2ZpbGUudXJsfSIgdGl0bGU9IiR7ZmlsZS5uYW1lfSIgZGF0YS1nYWxsZXJ5PSJnYWxsZXJ5IiBkb3dubG9hZD0iJHtmaWxlLm5hbWV9Ij4gXAogICAgICAgICAgICAgICAgICAgICAgICA8aW1nIHNyYz0iJHtmaWxlLnRodW1ibmFpbFVybH0iPiBcCiAgICAgICAgICAgICAgICAgICAgPC9hPiBcCiAgICAgICAgICAgICAgICB7ey9pZn19IFwKICAgICAgICAgICAgICAgIDwvdGQ+IFwKICAgICAgICAgICAgICAgIDx0ZCBjbGFzcz0ibmFtZSI+IFwKICAgICAgICAgICAgICAgICAgICA8YSBocmVmPSIke2ZpbGUudXJsfSIgdGl0bGU9IiR7ZmlsZS5uYW1lfSIgZGF0YS1nYWxsZXJ5PSIke2ZpbGUudGh1bWJuYWlsVXJsfWdhbGxlcnkiIGRvd25sb2FkPSIke2ZpbGUubmFtZX0iPiR7ZmlsZS5uYW1lfTwvYT4gXAogICAgICAgICAgICAgICAgPC90ZD4gXAogICAgICAgICAgICAgICAgPHRkIGNsYXNzPSJzaXplIj48c3Bhbj4ke2ZpbGUuc2l6ZX08L3NwYW4+PC90ZD4gXAogICAgICAgICAgICAgICAgPHRkIGNvbHNwYW49IjIiPjwvdGQ+IFwKICAgICAgICAgICAge3svaWZ9fSBcCiAgICAgICAgICAgICAgICA8dGQ+IFwKICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJkZWxldGUgYnRuIGJ0bi1kYW5nZXIiIGRhdGEtdHlwZT0iJHtmaWxlLmRlbGV0ZVR5cGV9IiBkYXRhLXVybD0iJHtmaWxlLmRlbGV0ZVVybH0iIHt7aWYgZmlsZS5kZWxldGVXaXRoQ3JlZGVudGlhbHN9fWRhdGEteGhyLWZpZWxkcz0ie1wid2l0aENyZWRlbnRpYWxzXCI6dHJ1ZX0iIHt7L2lmfX0+IFwKICAgICAgICAgICAgICAgICAgICAgICAgPGkgY2xhc3M9ImdseXBoaWNvbiBnbHlwaGljb24tdHJhc2ggZ2x5cGhpY29uLXdoaXRlIj48L2k+IFwKICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4+RGVsZXRlPC9zcGFuPiBcCiAgICAgICAgICAgICAgICAgICAgPC9idXR0b24+IFwKICAgICAgICAgICAgICAgIDwvdGQ+IFwKICAgICAgICAgICAgPC90cj4gXAogICAgICAgIHt7L2VhY2h9fSBcCiAgICAgICAgPC9zY3JpcHQ+IFwKICAgICc7CgogICAgQWxwYWNhLnJlZ2lzdGVyVGVtcGxhdGUoImNvbnRyb2xGaWVsZFVwbG9hZCIsIFRFTVBMQVRFKTsKICAgIEFscGFjYS5yZWdpc3RlclRlbXBsYXRlKCJjb250cm9sRmllbGRVcGxvYWRfdXBsb2FkIiwgVEVNUExBVEVfVVBMT0FEKTsKICAgIEFscGFjYS5yZWdpc3RlclRlbXBsYXRlKCJjb250cm9sRmllbGRVcGxvYWRfZG93bmxvYWQiLCBURU1QTEFURV9ET1dOTE9BRCk7CiAgICBBbHBhY2EucmVnaXN0ZXJGaWVsZENsYXNzKCJ1cGxvYWQiLCBBbHBhY2EuRmllbGRzLlVwbG9hZEZpZWxkKTsKCiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vcHJpdmF0ZS1mYWNlL2pxdWVyeS5iaW5kLWZpcnN0L2Jsb2IvbWFzdGVyL2Rldi9qcXVlcnkuYmluZC1maXJzdC5qcwogICAgLy8ganF1ZXJ5LmJpbmQtZmlyc3QuanMKICAgIChmdW5jdGlvbigkKSB7CiAgICAgICAgdmFyIHNwbGl0VmVyc2lvbiA9ICQuZm4uanF1ZXJ5LnNwbGl0KCIuIik7CiAgICAgICAgdmFyIG1ham9yID0gcGFyc2VJbnQoc3BsaXRWZXJzaW9uWzBdKTsKICAgICAgICB2YXIgbWlub3IgPSBwYXJzZUludChzcGxpdFZlcnNpb25bMV0pOwoKICAgICAgICB2YXIgSlFfTFRfMTcgPSAobWFqb3IgPCAxKSB8fCAobWFqb3IgPT0gMSAmJiBtaW5vciA8IDcpOwoKICAgICAgICBmdW5jdGlvbiBldmVudHNEYXRhKCRlbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBKUV9MVF8xNyA/ICRlbC5kYXRhKCdldmVudHMnKSA6ICQuX2RhdGEoJGVsWzBdKS5ldmVudHM7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBtb3ZlSGFuZGxlclRvVG9wKCRlbCwgZXZlbnROYW1lLCBpc0RlbGVnYXRlZCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBkYXRhID0gZXZlbnRzRGF0YSgkZWwpOwogICAgICAgICAgICB2YXIgZXZlbnRzID0gZGF0YVtldmVudE5hbWVdOwoKICAgICAgICAgICAgaWYgKCFKUV9MVF8xNykgewogICAgICAgICAgICAgICAgdmFyIGhhbmRsZXIgPSBpc0RlbGVnYXRlZCA/IGV2ZW50cy5zcGxpY2UoZXZlbnRzLmRlbGVnYXRlQ291bnQgLSAxLCAxKVswXSA6IGV2ZW50cy5wb3AoKTsKICAgICAgICAgICAgICAgIGV2ZW50cy5zcGxpY2UoaXNEZWxlZ2F0ZWQgPyAwIDogKGV2ZW50cy5kZWxlZ2F0ZUNvdW50IHx8IDApLCAwLCBoYW5kbGVyKTsKCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc0RlbGVnYXRlZCkgewogICAgICAgICAgICAgICAgZGF0YS5saXZlLnVuc2hpZnQoZGF0YS5saXZlLnBvcCgpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGV2ZW50cy51bnNoaWZ0KGV2ZW50cy5wb3AoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG1vdmVFdmVudEhhbmRsZXJzKCRlbGVtcywgZXZlbnRzU3RyaW5nLCBpc0RlbGVnYXRlKSB7CiAgICAgICAgICAgIHZhciBldmVudHMgPSBldmVudHNTdHJpbmcuc3BsaXQoL1xzKy8pOwogICAgICAgICAgICAkZWxlbXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnRzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHB1cmVFdmVudE5hbWUgPSAkLnRyaW0oZXZlbnRzW2ldKS5tYXRjaCgvW15cLl0rL2kpWzBdOwogICAgICAgICAgICAgICAgICAgIG1vdmVIYW5kbGVyVG9Ub3AoJCh0aGlzKSwgcHVyZUV2ZW50TmFtZSwgaXNEZWxlZ2F0ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgJC5mbi5iaW5kRmlyc3QgPSBmdW5jdGlvbigpCiAgICAgICAgewogICAgICAgICAgICB2YXIgYXJncyA9ICQubWFrZUFycmF5KGFyZ3VtZW50cyk7CiAgICAgICAgICAgIHZhciBldmVudHNTdHJpbmcgPSBhcmdzLnNoaWZ0KCk7CgogICAgICAgICAgICBpZiAoZXZlbnRzU3RyaW5nKSB7CiAgICAgICAgICAgICAgICAkLmZuLmJpbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIG1vdmVFdmVudEhhbmRsZXJzKHRoaXMsIGV2ZW50c1N0cmluZyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CgogICAgfSkoJCk7Cgp9KShqUXVlcnkpOwoKCiAgICByZXR1cm4gQWxwYWNhOwoKfSkpOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 06:52:05 GMT",
                    "Content-Length": "801875",
                    "Date": "Thu, 06 Nov 2014 06:52:05 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}