{
    "url": "http://localhost:9999/x-tag/code-prism/demo/x-tag-components.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>the 'baseURI' property of a DOM element</b> and written to <b>the 'setAttribute()' function of a DOM element</b> via the following statement:<ul><li>base.setAttribute('href', document.baseURI);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/x-tag/code-prism/demo/x-tag-components.js",
                "path": "/x-tag/code-prism/demo/x-tag-components.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC94LXRhZy9jb2RlLXByaXNtL2RlbW8veC10YWctY29tcG9uZW50cy5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNjc1MjQNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFN1biwgMDkgTm92IDIwMTQgMDM6NDI6MDMgR01UDQpMYXN0LU1vZGlmaWVkOiBTdW4sIDA5IE5vdiAyMDE0IDAzOjQyOjAzIEdNVA0KDQovLyBXZSBkb24ndCB1c2UgdGhlIHBsYXRmb3JtIGJvb3RzdHJhcHBlciwgc28gZmFrZSB0aGlzIHN0dWZmLgoKd2luZG93LlBsYXRmb3JtID0ge307CnZhciBsb2dGbGFncyA9IHt9OwovKgogKiBDb3B5cmlnaHQgMjAxMiBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3ZlcmVuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCi8vIFNpZGVUYWJsZSBpcyBhIHdlYWsgbWFwIHdoZXJlIHBvc3NpYmxlLiBJZiBXZWFrTWFwIGlzIG5vdCBhdmFpbGFibGUgdGhlCi8vIGFzc29jaWF0aW9uIGlzIHN0b3JlZCBhcyBhbiBleHBhbmRvIHByb3BlcnR5Lgp2YXIgU2lkZVRhYmxlOwovLyBUT0RPKGFydik6IFdlYWtNYXAgZG9lcyBub3QgYWxsb3cgZm9yIE5vZGUgZXRjIHRvIGJlIGtleXMgaW4gRmlyZWZveAppZiAodHlwZW9mIFdlYWtNYXAgIT09ICd1bmRlZmluZWQnICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZignRmlyZWZveC8nKSA8IDApIHsKICBTaWRlVGFibGUgPSBXZWFrTWFwOwp9IGVsc2UgewogIChmdW5jdGlvbigpIHsKICAgIHZhciBkZWZpbmVQcm9wZXJ0eSA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5oYXNPd25Qcm9wZXJ0eTsKICAgIHZhciBjb3VudGVyID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgJSAxZTk7CgogICAgU2lkZVRhYmxlID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubmFtZSA9ICdfX3N0JyArIChNYXRoLnJhbmRvbSgpICogMWU5ID4+PiAwKSArIChjb3VudGVyKysgKyAnX18nKTsKICAgIH07CgogICAgU2lkZVRhYmxlLnByb3RvdHlwZSA9IHsKICAgICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgZGVmaW5lUHJvcGVydHkoa2V5LCB0aGlzLm5hbWUsIHt2YWx1ZTogdmFsdWUsIHdyaXRhYmxlOiB0cnVlfSk7CiAgICAgIH0sCiAgICAgIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgcmV0dXJuIGhhc093blByb3BlcnR5LmNhbGwoa2V5LCB0aGlzLm5hbWUpID8ga2V5W3RoaXMubmFtZV0gOiB1bmRlZmluZWQ7CiAgICAgIH0sCiAgICAgIGRlbGV0ZTogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgdGhpcy5zZXQoa2V5LCB1bmRlZmluZWQpOwogICAgICB9CiAgICB9CiAgfSkoKTsKfQoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KKGZ1bmN0aW9uKCkgewoKICAvLyBwb29yIG1hbidzIGFkYXB0ZXIgZm9yIHRlbXBsYXRlLmNvbnRlbnQgb24gdmFyaW91cyBwbGF0Zm9ybSBzY2VuYXJpb3MKICB3aW5kb3cudGVtcGxhdGVDb250ZW50ID0gd2luZG93LnRlbXBsYXRlQ29udGVudCB8fCBmdW5jdGlvbihpblRlbXBsYXRlKSB7CiAgICByZXR1cm4gaW5UZW1wbGF0ZS5jb250ZW50OwogIH07CgogIC8vIHNvIHdlIGNhbiBjYWxsIHdyYXAvdW53cmFwIHdpdGhvdXQgdGVzdGluZyBmb3IgU2hhZG93RE9NUG9seWZpbGwKCiAgd2luZG93LndyYXAgPSB3aW5kb3cudW53cmFwID0gZnVuY3Rpb24obil7CiAgICByZXR1cm4gbjsKICB9CgogIHdpbmRvdy5jcmVhdGVTaGFkb3dSb290ID0gZnVuY3Rpb24oaW5FbGVtZW50KSB7CiAgICByZXR1cm4gaW5FbGVtZW50LndlYmtpdENyZWF0ZVNoYWRvd1Jvb3QoKTsKICB9OwoKICB3aW5kb3cudGVtcGxhdGVDb250ZW50ID0gZnVuY3Rpb24oaW5UZW1wbGF0ZSkgewogICAgLy8gaWYgTURWIGV4aXN0cywgaXQgbWF5IG5lZWQgdG8gYm9vc3RyYXAgdGhpcyB0ZW1wbGF0ZSB0byByZXZlYWwgY29udGVudAogICAgaWYgKHdpbmRvdy5IVE1MVGVtcGxhdGVFbGVtZW50ICYmIEhUTUxUZW1wbGF0ZUVsZW1lbnQuYm9vdHN0cmFwKSB7CiAgICAgIEhUTUxUZW1wbGF0ZUVsZW1lbnQuYm9vdHN0cmFwKGluVGVtcGxhdGUpOwogICAgfQogICAgLy8gZmFsbGJhY2sgd2hlbiB0aGVyZSBpcyBubyBTaGFkb3cgRE9NIHBvbHlmaWxsLCBubyBNRFYgcG9seWZpbGwsIGFuZCBubwogICAgLy8gbmF0aXZlIHRlbXBsYXRlIHN1cHBvcnQKICAgIGlmICghaW5UZW1wbGF0ZS5jb250ZW50ICYmICFpblRlbXBsYXRlLl9jb250ZW50KSB7CiAgICAgIHZhciBmcmFnID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICB3aGlsZSAoaW5UZW1wbGF0ZS5maXJzdENoaWxkKSB7CiAgICAgICAgZnJhZy5hcHBlbmRDaGlsZChpblRlbXBsYXRlLmZpcnN0Q2hpbGQpOwogICAgICB9CiAgICAgIGluVGVtcGxhdGUuX2NvbnRlbnQgPSBmcmFnOwogICAgfQogICAgcmV0dXJuIGluVGVtcGxhdGUuY29udGVudCB8fCBpblRlbXBsYXRlLl9jb250ZW50OwogIH07Cgp9KSgpOwovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKKGZ1bmN0aW9uKHNjb3BlKSB7CgovLyBPbGQgdmVyc2lvbnMgb2YgaU9TIGRvIG5vdCBoYXZlIGJpbmQuCgppZiAoIUZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kKSB7CiAgRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQgPSBmdW5jdGlvbihzY29wZSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXJnczIgPSBhcmdzLnNsaWNlKCk7CiAgICAgIGFyZ3MyLnB1c2guYXBwbHkoYXJnczIsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiBzZWxmLmFwcGx5KHNjb3BlLCBhcmdzMik7CiAgICB9OwogIH07Cn0KCi8vIG5hbWVzcGFjZSBhbiBpbXBvcnQgZnJvbSBDdXN0b21FbGVtZW50cwovLyBUT0RPKHNqbWlsZXMpOiBjbGVhbiB1cCB0aGlzIGdsb2JhbApzY29wZS5taXhpbiA9IHdpbmRvdy5taXhpbjsKCn0pKHdpbmRvdy5QbGF0Zm9ybSk7Ci8vIENvcHlyaWdodCAyMDExIEdvb2dsZSBJbmMuCi8vCi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOwovLyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCi8vIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAovLwovLyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCi8vCi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKLy8gZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKLy8gV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCi8vIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKLy8gbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCgooZnVuY3Rpb24oc2NvcGUpIHsKCiAgJ3VzZSBzdHJpY3QnOwoKICAvLyBwb2x5ZmlsbCBET01Ub2tlbkxpc3QKICAvLyAqIGFkZC9yZW1vdmU6IGFsbG93IHRoZXNlIG1ldGhvZHMgdG8gdGFrZSBtdWx0aXBsZSBjbGFzc05hbWVzCiAgLy8gKiB0b2dnbGU6IGFkZCBhIDJuZCBhcmd1bWVudCB3aGljaCBmb3JjZXMgdGhlIGdpdmVuIHN0YXRlIHJhdGhlcgogIC8vICB0aGFuIHRvZ2dsaW5nLgoKICB2YXIgYWRkID0gRE9NVG9rZW5MaXN0LnByb3RvdHlwZS5hZGQ7CiAgdmFyIHJlbW92ZSA9IERPTVRva2VuTGlzdC5wcm90b3R5cGUucmVtb3ZlOwogIERPTVRva2VuTGlzdC5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24oKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICBhZGQuY2FsbCh0aGlzLCBhcmd1bWVudHNbaV0pOwogICAgfQogIH07CiAgRE9NVG9rZW5MaXN0LnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbigpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHJlbW92ZS5jYWxsKHRoaXMsIGFyZ3VtZW50c1tpXSk7CiAgICB9CiAgfTsKICBET01Ub2tlbkxpc3QucHJvdG90eXBlLnRvZ2dsZSA9IGZ1bmN0aW9uKG5hbWUsIGJvb2wpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKICAgICAgYm9vbCA9ICF0aGlzLmNvbnRhaW5zKG5hbWUpOwogICAgfQogICAgYm9vbCA/IHRoaXMuYWRkKG5hbWUpIDogdGhpcy5yZW1vdmUobmFtZSk7CiAgfTsKICBET01Ub2tlbkxpc3QucHJvdG90eXBlLnN3aXRjaCA9IGZ1bmN0aW9uKG9sZE5hbWUsIG5ld05hbWUpIHsKICAgIG9sZE5hbWUgJiYgdGhpcy5yZW1vdmUob2xkTmFtZSk7CiAgICBuZXdOYW1lICYmIHRoaXMuYWRkKG5ld05hbWUpOwogIH07CgogIC8vIG1ha2UgZm9yRWFjaCB3b3JrIG9uIE5vZGVMaXN0CgogIE5vZGVMaXN0LnByb3RvdHlwZS5mb3JFYWNoID0gZnVuY3Rpb24oY2IsIGNvbnRleHQpIHsKICAgIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKHRoaXMpLmZvckVhY2goY2IsIGNvbnRleHQpOwogIH07CgogIEhUTUxDb2xsZWN0aW9uLnByb3RvdHlwZS5mb3JFYWNoID0gZnVuY3Rpb24oY2IsIGNvbnRleHQpIHsKICAgIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKHRoaXMpLmZvckVhY2goY2IsIGNvbnRleHQpOwogIH07CgogIC8vIHBvbHlmaWxsIHBlcmZvcm1hbmNlLm5vdwoKICBpZiAoIXdpbmRvdy5wZXJmb3JtYW5jZSkgewogICAgdmFyIHN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgIC8vIG9ubHkgYXQgbWlsbGlzZWNvbmQgcHJlY2lzaW9uCiAgICB3aW5kb3cucGVyZm9ybWFuY2UgPSB7bm93OiBmdW5jdGlvbigpeyByZXR1cm4gRGF0ZS5ub3coKSAtIHN0YXJ0IH19OwogIH0KCiAgLy8gcG9seWZpbGwgZm9yIHJlcXVlc3RBbmltYXRpb25GcmFtZQoKICBpZiAoIXdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUpIHsKICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSAoZnVuY3Rpb24oKSB7CiAgICAgIHZhciBuYXRpdmVSYWYgPSB3aW5kb3cud2Via2l0UmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgd2luZG93Lm1velJlcXVlc3RBbmltYXRpb25GcmFtZTsKCiAgICAgIHJldHVybiBuYXRpdmVSYWYgPwogICAgICAgIGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICByZXR1cm4gbmF0aXZlUmFmKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBjYWxsYmFjayhwZXJmb3JtYW5jZS5ub3coKSk7CiAgICAgICAgICB9KTsKICAgICAgICB9IDoKICAgICAgICBmdW5jdGlvbiggY2FsbGJhY2sgKXsKICAgICAgICAgIHJldHVybiB3aW5kb3cuc2V0VGltZW91dChjYWxsYmFjaywgMTAwMCAvIDYwKTsKICAgICAgICB9OwogICAgfSkoKTsKICB9CgogIGlmICghd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lKSB7CiAgICB3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUgPSAoZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAgd2luZG93LndlYmtpdENhbmNlbEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgd2luZG93Lm1vekNhbmNlbEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgZnVuY3Rpb24oaWQpIHsKICAgICAgICAgIGNsZWFyVGltZW91dChpZCk7CiAgICAgICAgfTsKICAgIH0pKCk7CiAgfQoKICAvLyB1dGlsaXR5CgogIGZ1bmN0aW9uIGNyZWF0ZURPTShpblRhZ09yTm9kZSwgaW5IVE1MLCBpbkF0dHJzKSB7CiAgICB2YXIgZG9tID0gdHlwZW9mIGluVGFnT3JOb2RlID09ICdzdHJpbmcnID8KICAgICAgICBkb2N1bWVudC5jcmVhdGVFbGVtZW50KGluVGFnT3JOb2RlKSA6IGluVGFnT3JOb2RlLmNsb25lTm9kZSh0cnVlKTsKICAgIGRvbS5pbm5lckhUTUwgPSBpbkhUTUw7CiAgICBpZiAoaW5BdHRycykgewogICAgICBmb3IgKHZhciBuIGluIGluQXR0cnMpIHsKICAgICAgICBkb20uc2V0QXR0cmlidXRlKG4sIGluQXR0cnNbbl0pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZG9tOwogIH0KCiAgLy8gZXhwb3J0cwoKICBzY29wZS5jcmVhdGVET00gPSBjcmVhdGVET007Cgp9KSh3aW5kb3cuUGxhdGZvcm0pOwoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCi8vIHBvb3IgbWFuJ3MgYWRhcHRlciBmb3IgdGVtcGxhdGUuY29udGVudCBvbiB2YXJpb3VzIHBsYXRmb3JtIHNjZW5hcmlvcwp3aW5kb3cudGVtcGxhdGVDb250ZW50ID0gd2luZG93LnRlbXBsYXRlQ29udGVudCB8fCBmdW5jdGlvbihpblRlbXBsYXRlKSB7CiAgcmV0dXJuIGluVGVtcGxhdGUuY29udGVudDsKfTsKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCihmdW5jdGlvbihzY29wZSkgewoKaWYgKCFzY29wZSkgewogIHNjb3BlID0gd2luZG93LkhUTUxJbXBvcnRzID0ge2ZsYWdzOnt9fTsKfQoKdmFyIElNUE9SVF9MSU5LX1RZUEUgPSAnaW1wb3J0JzsKCi8vIGhpZ2hsYW5kZXIgb2JqZWN0IHJlcHJlc2VudHMgYSBwcmltYXJ5IGRvY3VtZW50ICh0aGUgYXJndW1lbnQgdG8gJ3BhcnNlJykKLy8gYXQgdGhlIHJvb3Qgb2YgYSB0cmVlIG9mIGRvY3VtZW50cwoKdmFyIGltcG9ydGVyID0gewogIGRvY3VtZW50czoge30sCiAgY2FjaGU6IHt9LAogIHByZWxvYWRTZWxlY3RvcnM6IFsKICAgICdsaW5rW3JlbD0nICsgSU1QT1JUX0xJTktfVFlQRSArICddJywKICAgICdzY3JpcHRbc3JjXScsCiAgICAnbGlua1tyZWw9c3R5bGVzaGVldF0nCiAgXS5qb2luKCcsJyksCiAgbG9hZDogZnVuY3Rpb24oaW5Eb2N1bWVudCwgaW5OZXh0KSB7CiAgICAvLyBjb25zdHJ1Y3QgYSBsb2FkZXIgaW5zdGFuY2UKICAgIGxvYWRlciA9IG5ldyBMb2FkZXIoaW1wb3J0ZXIubG9hZGVkLCBpbk5leHQpOwogICAgLy8gYWxpYXMgdGhlIGxvYWRlciBjYWNoZSAoZm9yIGRlYnVnZ2luZykKICAgIGxvYWRlci5jYWNoZSA9IGltcG9ydGVyLmNhY2hlOwogICAgLy8gYWRkIG5vZGVzIGZyb20gZG9jdW1lbnQgaW50byBsb2FkZXIgcXVldWUKICAgIGltcG9ydGVyLnByZWxvYWQoaW5Eb2N1bWVudCk7CiAgfSwKICBwcmVsb2FkOiBmdW5jdGlvbihpbkRvY3VtZW50KSB7CiAgICAvLyBhbGwgcHJlbG9hZGFibGUgbm9kZXMgaW4gaW5Eb2N1bWVudAogICAgdmFyIG5vZGVzID0gaW5Eb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGltcG9ydGVyLnByZWxvYWRTZWxlY3RvcnMpOwogICAgLy8gb25seSBsb2FkIGltcG9ydHMgZnJvbSB0aGUgbWFpbiBkb2N1bWVudAogICAgLy8gVE9ETyhzam1pbGVzKTogZG8gdGhpcyBieSBhbHRlcmluZyB0aGUgc2VsZWN0b3IgbGlzdCBpbnN0ZWFkCiAgICBpZiAoaW5Eb2N1bWVudCA9PT0gZG9jdW1lbnQpIHsKICAgICAgbm9kZXMgPSBBcnJheS5wcm90b3R5cGUuZmlsdGVyLmNhbGwobm9kZXMsIGZ1bmN0aW9uKG4pIHsKICAgICAgICByZXR1cm4gaXNEb2N1bWVudExpbmsobik7CiAgICAgIH0pOwogICAgfQogICAgLy8gYWRkIHRoZXNlIG5vZGVzIHRvIGxvYWRlcidzIHF1ZXVlCiAgICBsb2FkZXIuYWRkTm9kZXMobm9kZXMpOwogIH0sCiAgbG9hZGVkOiBmdW5jdGlvbihpblVybCwgaW5FbHQsIGluUmVzb3VyY2UpIHsKICAgIGlmIChpc0RvY3VtZW50TGluayhpbkVsdCkpIHsKICAgICAgdmFyIGRvY3VtZW50ID0gaW1wb3J0ZXIuZG9jdW1lbnRzW2luVXJsXTsKICAgICAgLy8gaWYgd2UndmUgbmV2ZXIgc2VlbiBhIGRvY3VtZW50IGF0IHRoaXMgdXJsCiAgICAgIGlmICghZG9jdW1lbnQpIHsKICAgICAgICAvLyBnZW5lcmF0ZSBhbiBIVE1MRG9jdW1lbnQgZnJvbSBkYXRhCiAgICAgICAgZG9jdW1lbnQgPSBtYWtlRG9jdW1lbnQoaW5SZXNvdXJjZSwgaW5VcmwpOwogICAgICAgIC8vIHJlc29sdmUgcmVzb3VyY2UgcGF0aHMgcmVsYXRpdmUgdG8gaG9zdCBkb2N1bWVudAogICAgICAgIHBhdGgucmVzb2x2ZVBhdGhzSW5IVE1MKGRvY3VtZW50KTsKICAgICAgICAvLyBjYWNoZSBkb2N1bWVudAogICAgICAgIGltcG9ydGVyLmRvY3VtZW50c1tpblVybF0gPSBkb2N1bWVudDsKICAgICAgICAvLyBhZGQgbm9kZXMgZnJvbSB0aGlzIGRvY3VtZW50IHRvIHRoZSBsb2FkZXIgcXVldWUKICAgICAgICBpbXBvcnRlci5wcmVsb2FkKGRvY3VtZW50KTsKICAgICAgfQogICAgICAvLyBzdG9yZSBkb2N1bWVudCByZXNvdXJjZQogICAgICBpbkVsdC5jb250ZW50ID0gaW5FbHQuX19yZXNvdXJjZSA9IGRvY3VtZW50OwogICAgfSBlbHNlIHsKICAgICAgaW5FbHQuX19yZXNvdXJjZSA9IGluUmVzb3VyY2U7CiAgICAgIC8vIHJlc29sdmUgc3R5bGVzaGVldCByZXNvdXJjZSBwYXRocyByZWxhdGl2ZSB0byBob3N0IGRvY3VtZW50CiAgICAgIGlmIChpc1N0eWxlc2hlZXRMaW5rKGluRWx0KSkgewogICAgICAgIHBhdGgucmVzb2x2ZVBhdGhzSW5TdHlsZXNoZWV0KGluRWx0KTsKICAgICAgfQogICAgfQogIH0KfTsKCmZ1bmN0aW9uIGlzRG9jdW1lbnRMaW5rKGluRWx0KSB7CiAgcmV0dXJuIGlzTGlua1JlbChpbkVsdCwgSU1QT1JUX0xJTktfVFlQRSk7Cn0KCmZ1bmN0aW9uIGlzU3R5bGVzaGVldExpbmsoaW5FbHQpIHsKICByZXR1cm4gaXNMaW5rUmVsKGluRWx0LCAnc3R5bGVzaGVldCcpOwp9CgpmdW5jdGlvbiBpc0xpbmtSZWwoaW5FbHQsIGluUmVsKSB7CiAgcmV0dXJuIChpbkVsdC5sb2NhbE5hbWUgPT09ICdsaW5rJyAmJiBpbkVsdC5nZXRBdHRyaWJ1dGUoJ3JlbCcpID09PSBpblJlbCk7Cn0KCmZ1bmN0aW9uIGluTWFpbkRvY3VtZW50KGluRWx0KSB7CiAgcmV0dXJuIGluRWx0Lm93bmVyRG9jdW1lbnQgPT09IGRvY3VtZW50IHx8CiAgICAvLyBUT0RPKHNqbWlsZXMpOiBTaGFkb3dET01Qb2x5ZmlsbCBpbnRydXNpb24KICAgIGluRWx0Lm93bmVyRG9jdW1lbnQuaW1wbCA9PT0gZG9jdW1lbnQ7Cn0KCmZ1bmN0aW9uIG1ha2VEb2N1bWVudChpbkhUTUwsIGluVXJsKSB7CiAgLy8gY3JlYXRlIGEgbmV3IEhUTUwgZG9jdW1lbnQKICB2YXIgZG9jID0gZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uY3JlYXRlSFRNTERvY3VtZW50KElNUE9SVF9MSU5LX1RZUEUpOwogIC8vIGNhY2hlIHRoZSBuZXcgZG9jdW1lbnQncyBzb3VyY2UgdXJsCiAgZG9jLl9VUkwgPSBpblVybDsKICAvLyBlc3RhYmxpc2ggYSByZWxhdGl2ZSBwYXRoIHZpYSA8YmFzZT4KICB2YXIgYmFzZSA9IGRvYy5jcmVhdGVFbGVtZW50KCdiYXNlJyk7CiAgYmFzZS5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCBkb2N1bWVudC5iYXNlVVJJKTsKICBkb2MuaGVhZC5hcHBlbmRDaGlsZChiYXNlKTsKICAvLyBpbnN0YWxsIGh0bWwKICBkb2MuYm9keS5pbm5lckhUTUwgPSBpbkhUTUw7CiAgcmV0dXJuIGRvYzsKfQoKdmFyIGxvYWRlcjsKCnZhciBMb2FkZXIgPSBmdW5jdGlvbihpbk9uTG9hZCwgaW5PbkNvbXBsZXRlKSB7CiAgdGhpcy5vbmxvYWQgPSBpbk9uTG9hZDsKICB0aGlzLm9uY29tcGxldGUgPSBpbk9uQ29tcGxldGU7CiAgdGhpcy5pbmZsaWdodCA9IDA7CiAgdGhpcy5wZW5kaW5nID0ge307CiAgdGhpcy5jYWNoZSA9IHt9Owp9OwoKTG9hZGVyLnByb3RvdHlwZSA9IHsKICBhZGROb2RlczogZnVuY3Rpb24oaW5Ob2RlcykgewogICAgLy8gbnVtYmVyIG9mIHRyYW5zYWN0aW9ucyB0byBjb21wbGV0ZQogICAgdGhpcy5pbmZsaWdodCArPSBpbk5vZGVzLmxlbmd0aDsKICAgIC8vIGNvbW1lbmNlIHRyYW5zYWN0aW9ucwogICAgZm9yRWFjaChpbk5vZGVzLCB0aGlzLnJlcXVpcmUsIHRoaXMpOwogICAgLy8gYW55dGhpbmcgdG8gZG8/CiAgICB0aGlzLmNoZWNrRG9uZSgpOwogIH0sCiAgcmVxdWlyZTogZnVuY3Rpb24oaW5FbHQpIHsKICAgIHZhciB1cmwgPSBwYXRoLm5vZGVVcmwoaW5FbHQpOwogICAgLy8gVE9ETyhzam1pbGVzKTogYWQtaG9jCiAgICBpbkVsdC5fX25vZGVVcmwgPSB1cmw7CiAgICAvLyBkZWR1cGxpY2F0aW9uCiAgICBpZiAoIXRoaXMuZGVkdXBlKHVybCwgaW5FbHQpKSB7CiAgICAgIC8vIGZldGNoIHRoaXMgcmVzb3VyY2UKICAgICAgdGhpcy5mZXRjaCh1cmwsIGluRWx0KTsKICAgIH0KICB9LAogIGRlZHVwZTogZnVuY3Rpb24oaW5VcmwsIGluRWx0KSB7CiAgICBpZiAodGhpcy5wZW5kaW5nW2luVXJsXSkgewogICAgICAvLyBhZGQgdG8gbGlzdCBvZiBub2RlcyB3YWl0aW5nIGZvciBpblVybAogICAgICB0aGlzLnBlbmRpbmdbaW5VcmxdLnB1c2goaW5FbHQpOwogICAgICAvLyBkb24ndCBuZWVkIGZldGNoCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgaWYgKHRoaXMuY2FjaGVbaW5VcmxdKSB7CiAgICAgIC8vIGNvbXBsZXRlIGxvYWQgdXNpbmcgY2FjaGUgZGF0YQogICAgICB0aGlzLm9ubG9hZChpblVybCwgaW5FbHQsIGxvYWRlci5jYWNoZVtpblVybF0pOwogICAgICAvLyBmaW5pc2hlZCB0aGlzIHRyYW5zYWN0aW9uCiAgICAgIHRoaXMudGFpbCgpOwogICAgICAvLyBkb24ndCBuZWVkIGZldGNoCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgLy8gZmlyc3Qgbm9kZSB3YWl0aW5nIGZvciBpblVybAogICAgdGhpcy5wZW5kaW5nW2luVXJsXSA9IFtpbkVsdF07CiAgICAvLyBuZWVkIGZldGNoIChub3QgYSBkdXBlKQogICAgcmV0dXJuIGZhbHNlOwogIH0sCiAgZmV0Y2g6IGZ1bmN0aW9uKGluVXJsLCBpbkVsdCkgewogICAgeGhyLmxvYWQoaW5VcmwsIGZ1bmN0aW9uKGVyciwgcmVzb3VyY2UpIHsKICAgICAgdGhpcy5yZWNlaXZlKGluVXJsLCBpbkVsdCwgZXJyLCByZXNvdXJjZSk7CiAgICB9LmJpbmQodGhpcykpOwogIH0sCiAgcmVjZWl2ZTogZnVuY3Rpb24oaW5VcmwsIGluRWx0LCBpbkVyciwgaW5SZXNvdXJjZSkgewogICAgaWYgKCFpbkVycikgewogICAgICBsb2FkZXIuY2FjaGVbaW5VcmxdID0gaW5SZXNvdXJjZTsKICAgIH0KICAgIGxvYWRlci5wZW5kaW5nW2luVXJsXS5mb3JFYWNoKGZ1bmN0aW9uKGUpIHsKICAgICAgaWYgKCFpbkVycikgewogICAgICAgIHRoaXMub25sb2FkKGluVXJsLCBlLCBpblJlc291cmNlKTsKICAgICAgfQogICAgICB0aGlzLnRhaWwoKTsKICAgIH0sIHRoaXMpOwogICAgbG9hZGVyLnBlbmRpbmdbaW5VcmxdID0gbnVsbDsKICB9LAogIHRhaWw6IGZ1bmN0aW9uKCkgewogICAgLS10aGlzLmluZmxpZ2h0OwogICAgdGhpcy5jaGVja0RvbmUoKTsKICB9LAogIGNoZWNrRG9uZTogZnVuY3Rpb24oKSB7CiAgICBpZiAoIXRoaXMuaW5mbGlnaHQpIHsKICAgICAgdGhpcy5vbmNvbXBsZXRlKCk7CiAgICB9CiAgfQp9OwoKdmFyIHBhdGggPSB7CiAgbm9kZVVybDogZnVuY3Rpb24oaW5Ob2RlKSB7CiAgICByZXR1cm4gcGF0aC5yZXNvbHZlVXJsKHBhdGguZ2V0RG9jdW1lbnRVcmwoZG9jdW1lbnQpLCBwYXRoLmhyZWZPclNyYyhpbk5vZGUpKTsKICB9LAogIGhyZWZPclNyYzogZnVuY3Rpb24oaW5Ob2RlKSB7CiAgICByZXR1cm4gaW5Ob2RlLmdldEF0dHJpYnV0ZSgiaHJlZiIpIHx8IGluTm9kZS5nZXRBdHRyaWJ1dGUoInNyYyIpOwogIH0sCiAgZG9jdW1lbnRVcmxGcm9tTm9kZTogZnVuY3Rpb24oaW5Ob2RlKSB7CiAgICByZXR1cm4gcGF0aC5nZXREb2N1bWVudFVybChpbk5vZGUub3duZXJEb2N1bWVudCk7CiAgfSwKICBnZXREb2N1bWVudFVybDogZnVuY3Rpb24oaW5Eb2N1bWVudCkgewogICAgdmFyIHVybCA9IGluRG9jdW1lbnQgJiYKICAgICAgICAvLyBUT0RPKHNqbWlsZXMpOiBTaGFkb3dET01Qb2x5ZmlsbCBpbnRydXNpb24KICAgICAgICAoaW5Eb2N1bWVudC5fVVJMIHx8IChpbkRvY3VtZW50LmltcGwgJiYgaW5Eb2N1bWVudC5pbXBsLl9VUkwpCiAgICAgICAgICAgIHx8IGluRG9jdW1lbnQuYmFzZVVSSSB8fCBpbkRvY3VtZW50LlVSTCkKICAgICAgICAgICAgICAgIHx8ICcnOwogICAgLy8gdGFrZSBvbmx5IHRoZSBsZWZ0IHNpZGUgaWYgdGhlcmUgaXMgYSAjCiAgICByZXR1cm4gdXJsLnNwbGl0KCcjJylbMF07CiAgfSwKICByZXNvbHZlVXJsOiBmdW5jdGlvbihpbkJhc2VVcmwsIGluVXJsLCBpblJlbGF0aXZlVG9Eb2N1bWVudCkgewogICAgaWYgKHRoaXMuaXNBYnNVcmwoaW5VcmwpKSB7CiAgICAgIHJldHVybiBpblVybDsKICAgIH0KICAgIHZhciB1cmwgPSB0aGlzLmNvbXByZXNzVXJsKHRoaXMudXJsVG9QYXRoKGluQmFzZVVybCkgKyBpblVybCk7CiAgICBpZiAoaW5SZWxhdGl2ZVRvRG9jdW1lbnQpIHsKICAgICAgdXJsID0gcGF0aC5tYWtlUmVsUGF0aChwYXRoLmdldERvY3VtZW50VXJsKGRvY3VtZW50KSwgdXJsKTsKICAgIH0KICAgIHJldHVybiB1cmw7CiAgfSwKICBpc0Fic1VybDogZnVuY3Rpb24oaW5VcmwpIHsKICAgIHJldHVybiAvKF5kYXRhOil8KF5odHRwW3NdPzopfCheXC8pLy50ZXN0KGluVXJsKTsKICB9LAogIHVybFRvUGF0aDogZnVuY3Rpb24oaW5CYXNlVXJsKSB7CiAgICB2YXIgcGFydHMgPSBpbkJhc2VVcmwuc3BsaXQoIi8iKTsKICAgIHBhcnRzLnBvcCgpOwogICAgcGFydHMucHVzaCgnJyk7CiAgICByZXR1cm4gcGFydHMuam9pbigiLyIpOwogIH0sCiAgY29tcHJlc3NVcmw6IGZ1bmN0aW9uKGluVXJsKSB7CiAgICB2YXIgcGFydHMgPSBpblVybC5zcGxpdCgiLyIpOwogICAgZm9yICh2YXIgaT0wLCBwOyBpPHBhcnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHAgPSBwYXJ0c1tpXTsKICAgICAgaWYgKHAgPT09ICIuLiIpIHsKICAgICAgICBwYXJ0cy5zcGxpY2UoaS0xLCAyKTsKICAgICAgICBpIC09IDI7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBwYXJ0cy5qb2luKCIvIik7CiAgfSwKICAvLyBtYWtlIGEgcmVsYXRpdmUgcGF0aCBmcm9tIHNvdXJjZSB0byB0YXJnZXQKICBtYWtlUmVsUGF0aDogZnVuY3Rpb24oaW5Tb3VyY2UsIGluVGFyZ2V0KSB7CiAgICB2YXIgcywgdDsKICAgIHMgPSB0aGlzLmNvbXByZXNzVXJsKGluU291cmNlKS5zcGxpdCgiLyIpOwogICAgdCA9IHRoaXMuY29tcHJlc3NVcmwoaW5UYXJnZXQpLnNwbGl0KCIvIik7CiAgICB3aGlsZSAocy5sZW5ndGggJiYgc1swXSA9PT0gdFswXSl7CiAgICAgIHMuc2hpZnQoKTsKICAgICAgdC5zaGlmdCgpOwogICAgfQogICAgZm9yKHZhciBpID0gMCwgbCA9IHMubGVuZ3RoLTE7IGkgPCBsOyBpKyspIHsKICAgICAgdC51bnNoaWZ0KCIuLiIpOwogICAgfQogICAgdmFyIHIgPSB0LmpvaW4oIi8iKTsKICAgIHJldHVybiByOwogIH0sCiAgcmVzb2x2ZVBhdGhzSW5IVE1MOiBmdW5jdGlvbihpblJvb3QpIHsKICAgIHZhciBkb2NVcmwgPSBwYXRoLmRvY3VtZW50VXJsRnJvbU5vZGUoaW5Sb290LmJvZHkpOwogICAgLy8gVE9ETyhzb3J2ZWxsKTogTURWIFBvbHlmaWxsIEludHJ1c2lvbgogICAgaWYgKHdpbmRvdy5IVE1MVGVtcGxhdGVFbGVtZW50ICYmIEhUTUxUZW1wbGF0ZUVsZW1lbnQuYm9vdHN0cmFwKSB7CiAgICAgIEhUTUxUZW1wbGF0ZUVsZW1lbnQuYm9vdHN0cmFwKGluUm9vdCk7CiAgICB9CiAgICB2YXIgbm9kZSA9IGluUm9vdC5ib2R5OwogICAgcGF0aC5fcmVzb2x2ZVBhdGhzSW5IVE1MKG5vZGUsIGRvY1VybCk7CiAgfSwKICBfcmVzb2x2ZVBhdGhzSW5IVE1MOiBmdW5jdGlvbihpblJvb3QsIGluVXJsKSB7CiAgICBwYXRoLnJlc29sdmVBdHRyaWJ1dGVzKGluUm9vdCwgaW5VcmwpOwogICAgcGF0aC5yZXNvbHZlU3R5bGVFbHRzKGluUm9vdCwgaW5VcmwpOwogICAgLy8gaGFuZGxlIHRlbXBsYXRlcywgaWYgc3VwcG9ydGVkCiAgICBpZiAod2luZG93LnRlbXBsYXRlQ29udGVudCkgewogICAgICB2YXIgdGVtcGxhdGVzID0gaW5Sb290LnF1ZXJ5U2VsZWN0b3JBbGwoJ3RlbXBsYXRlJyk7CiAgICAgIGlmICh0ZW1wbGF0ZXMpIHsKICAgICAgICBmb3JFYWNoKHRlbXBsYXRlcywgZnVuY3Rpb24odCkgewogICAgICAgICAgcGF0aC5fcmVzb2x2ZVBhdGhzSW5IVE1MKHRlbXBsYXRlQ29udGVudCh0KSwgaW5VcmwpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfSwKICByZXNvbHZlUGF0aHNJblN0eWxlc2hlZXQ6IGZ1bmN0aW9uKGluU2hlZXQpIHsKICAgIHZhciBkb2NVcmwgPSBwYXRoLm5vZGVVcmwoaW5TaGVldCk7CiAgICBpblNoZWV0Ll9fcmVzb3VyY2UgPSBwYXRoLnJlc29sdmVDc3NUZXh0KGluU2hlZXQuX19yZXNvdXJjZSwgZG9jVXJsKTsKICB9LAogIHJlc29sdmVTdHlsZUVsdHM6IGZ1bmN0aW9uKGluUm9vdCwgaW5VcmwpIHsKICAgIHZhciBzdHlsZXMgPSBpblJvb3QucXVlcnlTZWxlY3RvckFsbCgnc3R5bGUnKTsKICAgIGlmIChzdHlsZXMpIHsKICAgICAgZm9yRWFjaChzdHlsZXMsIGZ1bmN0aW9uKHN0eWxlKSB7CiAgICAgICAgc3R5bGUudGV4dENvbnRlbnQgPSBwYXRoLnJlc29sdmVDc3NUZXh0KHN0eWxlLnRleHRDb250ZW50LCBpblVybCk7CiAgICAgIH0pOwogICAgfQogIH0sCiAgcmVzb2x2ZUNzc1RleHQ6IGZ1bmN0aW9uKGluQ3NzVGV4dCwgaW5CYXNlVXJsKSB7CiAgICByZXR1cm4gaW5Dc3NUZXh0LnJlcGxhY2UoL3VybFwoW14pXSpcKS9nLCBmdW5jdGlvbihpbk1hdGNoKSB7CiAgICAgIC8vIGZpbmQgdGhlIHVybCBwYXRoLCBpZ25vcmUgcXVvdGVzIGluIHVybCBzdHJpbmcKICAgICAgdmFyIHVybFBhdGggPSBpbk1hdGNoLnJlcGxhY2UoL1siJ10vZywgIiIpLnNsaWNlKDQsIC0xKTsKICAgICAgdXJsUGF0aCA9IHBhdGgucmVzb2x2ZVVybChpbkJhc2VVcmwsIHVybFBhdGgsIHRydWUpOwogICAgICByZXR1cm4gInVybCgiICsgdXJsUGF0aCArICIpIjsKICAgIH0pOwogIH0sCiAgcmVzb2x2ZUF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGluUm9vdCwgaW5VcmwpIHsKICAgIC8vIHNlYXJjaCBmb3IgYXR0cmlidXRlcyB0aGF0IGhvc3QgdXJscwogICAgdmFyIG5vZGVzID0gaW5Sb290ICYmIGluUm9vdC5xdWVyeVNlbGVjdG9yQWxsKFVSTF9BVFRSU19TRUxFQ1RPUik7CiAgICBpZiAobm9kZXMpIHsKICAgICAgZm9yRWFjaChub2RlcywgZnVuY3Rpb24obikgewogICAgICAgIHRoaXMucmVzb2x2ZU5vZGVBdHRyaWJ1dGVzKG4sIGluVXJsKTsKICAgICAgfSwgdGhpcyk7CiAgICB9CiAgfSwKICByZXNvbHZlTm9kZUF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGluTm9kZSwgaW5VcmwpIHsKICAgIFVSTF9BVFRSUy5mb3JFYWNoKGZ1bmN0aW9uKHYpIHsKICAgICAgdmFyIGF0dHIgPSBpbk5vZGUuYXR0cmlidXRlc1t2XTsKICAgICAgaWYgKGF0dHIgJiYgYXR0ci52YWx1ZSAmJgogICAgICAgICAoYXR0ci52YWx1ZS5zZWFyY2goVVJMX1RFTVBMQVRFX1NFQVJDSCkgPCAwKSkgewogICAgICAgIHZhciB1cmxQYXRoID0gcGF0aC5yZXNvbHZlVXJsKGluVXJsLCBhdHRyLnZhbHVlLCB0cnVlKTsKICAgICAgICBhdHRyLnZhbHVlID0gdXJsUGF0aDsKICAgICAgfQogICAgfSk7CiAgfQp9OwoKdmFyIFVSTF9BVFRSUyA9IFsnaHJlZicsICdzcmMnLCAnYWN0aW9uJ107CnZhciBVUkxfQVRUUlNfU0VMRUNUT1IgPSAnWycgKyBVUkxfQVRUUlMuam9pbignXSxbJykgKyAnXSc7CnZhciBVUkxfVEVNUExBVEVfU0VBUkNIID0gJ3t7Lip9fSc7Cgp2YXIgeGhyID0gc2NvcGUueGhyIHx8IHsKICBhc3luYzogdHJ1ZSwKICBvazogZnVuY3Rpb24oaW5SZXF1ZXN0KSB7CiAgICByZXR1cm4gKGluUmVxdWVzdC5zdGF0dXMgPj0gMjAwICYmIGluUmVxdWVzdC5zdGF0dXMgPCAzMDApCiAgICAgICAgfHwgKGluUmVxdWVzdC5zdGF0dXMgPT09IDMwNCkKICAgICAgICB8fCAoaW5SZXF1ZXN0LnN0YXR1cyA9PT0gMCk7CiAgfSwKICBsb2FkOiBmdW5jdGlvbih1cmwsIG5leHQsIG5leHRDb250ZXh0KSB7CiAgICB2YXIgcmVxdWVzdCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgaWYgKHNjb3BlLmZsYWdzLmRlYnVnIHx8IHNjb3BlLmZsYWdzLmJ1c3QpIHsKICAgICAgdXJsICs9ICc/JyArIE1hdGgucmFuZG9tKCk7CiAgICB9CiAgICByZXF1ZXN0Lm9wZW4oJ0dFVCcsIHVybCwgeGhyLmFzeW5jKTsKICAgIHJlcXVlc3QuYWRkRXZlbnRMaXN0ZW5lcigncmVhZHlzdGF0ZWNoYW5nZScsIGZ1bmN0aW9uKGUpIHsKICAgICAgaWYgKHJlcXVlc3QucmVhZHlTdGF0ZSA9PT0gNCkgewogICAgICAgIG5leHQuY2FsbChuZXh0Q29udGV4dCwgIXhoci5vayhyZXF1ZXN0KSAmJiByZXF1ZXN0LAogICAgICAgICAgcmVxdWVzdC5yZXNwb25zZSwgdXJsKTsKICAgICAgfQogICAgfSk7CiAgICByZXF1ZXN0LnNlbmQoKTsKICB9Cn07Cgp2YXIgZm9yRWFjaCA9IEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwuYmluZChBcnJheS5wcm90b3R5cGUuZm9yRWFjaCk7CgovLyBleHBvcnRzCgpzY29wZS54aHIgPSB4aHI7CnNjb3BlLmltcG9ydGVyID0gaW1wb3J0ZXI7CnNjb3BlLmdldERvY3VtZW50VXJsID0gcGF0aC5nZXREb2N1bWVudFVybDsKCi8vIGJvb3RzdHJhcAoKLy8gSUUgc2hpbSBmb3IgQ3VzdG9tRXZlbnQKaWYgKHR5cGVvZiB3aW5kb3cuQ3VzdG9tRXZlbnQgIT09ICdmdW5jdGlvbicpIHsKICB3aW5kb3cuQ3VzdG9tRXZlbnQgPSBmdW5jdGlvbihpblR5cGUpIHsKICAgICB2YXIgZSA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdIVE1MRXZlbnRzJyk7CiAgICAgZS5pbml0RXZlbnQoaW5UeXBlLCB0cnVlLCB0cnVlKTsKICAgICByZXR1cm4gZTsKICB9Owp9Cgpkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgZnVuY3Rpb24oKSB7CiAgLy8gcHJlbG9hZCBkb2N1bWVudCByZXNvdXJjZSB0cmVlcwogIGltcG9ydGVyLmxvYWQoZG9jdW1lbnQsIGZ1bmN0aW9uKCkgewogICAgLy8gVE9ETyhzam1pbGVzKTogU2hhZG93RE9NIHBvbHlmaWxsIHBvbGx1dGlvbgogICAgdmFyIGRvYyA9IHdpbmRvdy5TaGFkb3dET01Qb2x5ZmlsbCA/IFNoYWRvd0RPTVBvbHlmaWxsLndyYXAoZG9jdW1lbnQpCiAgICAgICAgOiBkb2N1bWVudDsKICAgIEhUTUxJbXBvcnRzLnJlYWR5VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgLy8gc2VuZCBIVE1MSW1wb3J0c0xvYWRlZCB3aGVuIGZpbmlzaGVkCiAgICBkb2MuYm9keS5kaXNwYXRjaEV2ZW50KAogICAgICBuZXcgQ3VzdG9tRXZlbnQoJ0hUTUxJbXBvcnRzTG9hZGVkJywge2J1YmJsZXM6IHRydWV9KQogICAgKTsKICB9KTsKfSk7Cgp9KSh3aW5kb3cuSFRNTEltcG9ydHMpOwoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCmlmICghd2luZG93Lk11dGF0aW9uT2JzZXJ2ZXIpIHsKICB3aW5kb3cuTXV0YXRpb25PYnNlcnZlciA9CiAgICAgIHdpbmRvdy5XZWJLaXRNdXRhdGlvbk9ic2VydmVyIHx8CiAgICAgIHdpbmRvdy5Kc011dGF0aW9uT2JzZXJ2ZXI7CiAgaWYgKCFNdXRhdGlvbk9ic2VydmVyKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIm5vIG11dGF0aW9uIG9ic2VydmVyIHN1cHBvcnQiKTsKICB9Cn0KCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgovKioKICogSW1wbGVtZW50cyBgZG9jdW1lbnQucmVnaXN0ZXJgCiAqIEBtb2R1bGUgQ3VzdG9tRWxlbWVudHMKKi8KCi8qKgogKiBQb2x5ZmlsbGVkIGV4dGVuc2lvbnMgdG8gdGhlIGBkb2N1bWVudGAgb2JqZWN0LgogKiBAY2xhc3MgRG9jdW1lbnQKKi8KCihmdW5jdGlvbihzY29wZSkgewoKaWYgKCFzY29wZSkgewogIHNjb3BlID0gd2luZG93LkN1c3RvbUVsZW1lbnRzID0ge2ZsYWdzOnt9fTsKfQoKLy8gbmF0aXZlIGRvY3VtZW50LnJlZ2lzdGVyPwoKc2NvcGUuaGFzTmF0aXZlID0gKGRvY3VtZW50LndlYmtpdFJlZ2lzdGVyIHx8IGRvY3VtZW50LnJlZ2lzdGVyKSAmJiBzY29wZS5mbGFncy5yZWdpc3RlciA9PT0gJ25hdGl2ZSc7CmlmIChzY29wZS5oYXNOYXRpdmUpIHsKCiAgLy8gbm9ybWFsaXplCiAgZG9jdW1lbnQucmVnaXN0ZXIgPSBkb2N1bWVudC5yZWdpc3RlciB8fCBkb2N1bWVudC53ZWJraXRSZWdpc3RlcjsKCiAgdmFyIG5vcCA9IGZ1bmN0aW9uKCkge307CgogIC8vIGV4cG9ydHMKICBzY29wZS5yZWdpc3RyeSA9IHt9OwogIHNjb3BlLnVwZ3JhZGVFbGVtZW50ID0gbm9wOwoKfSBlbHNlIHsKCi8qKgogKiBSZWdpc3RlcnMgYSBjdXN0b20gdGFnIG5hbWUgd2l0aCB0aGUgZG9jdW1lbnQuCiAqCiAqIFdoZW4gYSByZWdpc3RlcmVkIGVsZW1lbnQgaXMgY3JlYXRlZCwgYSBgcmVhZHlDYWxsYmFja2AgbWV0aG9kIGlzIGNhbGxlZAogKiBpbiB0aGUgc2NvcGUgb2YgdGhlIGVsZW1lbnQuIFRoZSBgcmVhZHlDYWxsYmFja2AgbWV0aG9kIGNhbiBiZSBzcGVjaWZpZWQgb24KICogZWl0aGVyIGBpbk9wdGlvbnMucHJvdG90eXBlYCBvciBgaW5PcHRpb25zLmxpZmVjeWNsZWAgd2l0aCB0aGUgbGF0dGVyIHRha2luZwogKiBwcmVjZWRlbmNlLgogKgogKiBAbWV0aG9kIHJlZ2lzdGVyCiAqIEBwYXJhbSB7U3RyaW5nfSBpbk5hbWUgVGhlIHRhZyBuYW1lIHRvIHJlZ2lzdGVyLiBNdXN0IGluY2x1ZGUgYSBkYXNoICgnLScpLAogKiAgICBmb3IgZXhhbXBsZSAneC1jb21wb25lbnQnLgogKiBAcGFyYW0ge09iamVjdH0gaW5PcHRpb25zCiAqICAgIEBwYXJhbSB7U3RyaW5nfSBbaW5PcHRpb25zLmV4dGVuZHNdCiAqICAgICAgKF9vZmYgc3BlY18pIFRhZyBuYW1lIG9mIGFuIGVsZW1lbnQgdG8gZXh0ZW5kIChvciBibGFuayBmb3IgYSBuZXcKICogICAgICBlbGVtZW50KS4gVGhpcyBwYXJhbWV0ZXIgaXMgbm90IHBhcnQgb2YgdGhlIHNwZWNpZmljYXRpb24sIGJ1dCBpbnN0ZWFkCiAqICAgICAgaXMgYSBoaW50IGZvciB0aGUgcG9seWZpbGwgYmVjYXVzZSB0aGUgZXh0ZW5kZWUgaXMgZGlmZmljdWx0IHRvIGluZmVyLgogKiAgICAgIFJlbWVtYmVyIHRoYXQgdGhlIGlucHV0IHByb3RvdHlwZSBtdXN0IGNoYWluIHRvIHRoZSBleHRlbmRlZCBlbGVtZW50J3MKICogICAgICBwcm90b3R5cGUgKG9yIEhUTUxFbGVtZW50LnByb3RvdHlwZSkgcmVnYXJkbGVzcyBvZiB0aGUgdmFsdWUgb2YKICogICAgICBgZXh0ZW5kc2AuCiAqICAgIEBwYXJhbSB7T2JqZWN0fSBpbk9wdGlvbnMucHJvdG90eXBlIFRoZSBwcm90b3R5cGUgdG8gdXNlIGZvciB0aGUgbmV3CiAqICAgICAgZWxlbWVudC4gVGhlIHByb3RvdHlwZSBtdXN0IGluaGVyaXQgZnJvbSBIVE1MRWxlbWVudC4KICogICAgQHBhcmFtIHtPYmplY3R9IFtpbk9wdGlvbnMubGlmZWN5Y2xlXQogKiAgICAgIENhbGxiYWNrcyB0aGF0IGZpcmUgYXQgaW1wb3J0YW50IHBoYXNlcyBpbiB0aGUgbGlmZSBvZiB0aGUgY3VzdG9tCiAqICAgICAgZWxlbWVudC4KICoKICogQGV4YW1wbGUKICogICAgICBGYW5jeUJ1dHRvbiA9IGRvY3VtZW50LnJlZ2lzdGVyKCJmYW5jeS1idXR0b24iLCB7CiAqICAgICAgICBleHRlbmRzOiAnYnV0dG9uJywKICogICAgICAgIHByb3RvdHlwZTogT2JqZWN0LmNyZWF0ZShIVE1MQnV0dG9uRWxlbWVudC5wcm90b3R5cGUsIHsKICogICAgICAgICAgcmVhZHlDYWxsYmFjazogewogKiAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbigpIHsKICogICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJhIGZhbmN5LWJ1dHRvbiB3YXMgY3JlYXRlZCIsCiAqICAgICAgICAgICAgfQogKiAgICAgICAgICB9CiAqICAgICAgICB9KQogKiAgICAgIH0pOwogKiBAcmV0dXJuIHtGdW5jdGlvbn0gQ29uc3RydWN0b3IgZm9yIHRoZSBuZXdseSByZWdpc3RlcmVkIHR5cGUuCiAqLwpmdW5jdGlvbiByZWdpc3Rlcihpbk5hbWUsIGluT3B0aW9ucykgewogIC8vY29uc29sZS53YXJuKCdkb2N1bWVudC5yZWdpc3RlcigiJyArIGluTmFtZSArICciLCAnLCBpbk9wdGlvbnMsICcpJyk7CiAgLy8gY29uc3RydWN0IGEgZGVmaW50aW9uIG91dCBvZiBvcHRpb25zCiAgLy8gVE9ETyhzam1pbGVzKTogcHJvYmFibHkgc2hvdWxkIGNsb25lIGluT3B0aW9ucyBpbnN0ZWFkIG9mIG11dGF0aW5nIGl0CiAgdmFyIGRlZmluaXRpb24gPSBpbk9wdGlvbnMgfHwge307CiAgaWYgKCFpbk5hbWUpIHsKICAgIC8vIFRPRE8oc2ptaWxlcyk6IHJlcGxhY2Ugd2l0aCBtb3JlIGFwcHJvcHJpYXRlIGVycm9yIChFcmlrIGNhbiBwcm9iYWJseQogICAgLy8gb2ZmZXIgZ3VpZGFuY2UpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ05hbWUgYXJndW1lbnQgbXVzdCBub3QgYmUgZW1wdHknKTsKICB9CiAgLy8gcmVjb3JkIG5hbWUKICBkZWZpbml0aW9uLm5hbWUgPSBpbk5hbWU7CiAgLy8gbXVzdCBoYXZlIGEgcHJvdG90eXBlLCBkZWZhdWx0IHRvIGFuIGV4dGVuc2lvbiBvZiBIVE1MRWxlbWVudAogIC8vIFRPRE8oc2ptaWxlcyk6IHByb2JhYmx5IHNob3VsZCB0aHJvdyBpZiBubyBwcm90b3R5cGUsIGNoZWNrIHNwZWMKICBpZiAoIWRlZmluaXRpb24ucHJvdG90eXBlKSB7CiAgICAvLyBUT0RPKHNqbWlsZXMpOiByZXBsYWNlIHdpdGggbW9yZSBhcHByb3ByaWF0ZSBlcnJvciAoRXJpayBjYW4gcHJvYmFibHkKICAgIC8vIG9mZmVyIGd1aWRhbmNlKQogICAgdGhyb3cgbmV3IEVycm9yKCdPcHRpb25zIG1pc3NpbmcgcmVxdWlyZWQgcHJvdG90eXBlIHByb3BlcnR5Jyk7CiAgfQogIC8vIGVuc3VyZSBhIGxpZmVjeWNsZSBvYmplY3Qgc28gd2UgZG9uJ3QgaGF2ZSB0byBudWxsIHRlc3QgaXQKICBkZWZpbml0aW9uLmxpZmVjeWNsZSA9IGRlZmluaXRpb24ubGlmZWN5Y2xlIHx8IHt9OwogIC8vIGJ1aWxkIGEgbGlzdCBvZiBhbmNlc3RyYWwgY3VzdG9tIGVsZW1lbnRzIChmb3IgbmF0aXZlIGJhc2UgZGV0ZWN0aW9uKQogIC8vIFRPRE8oc2ptaWxlcyk6IHdlIHVzZWQgdG8gbmVlZCB0byBzdG9yZSB0aGlzLCBidXQgY3VycmVudCBjb2RlIG9ubHkKICAvLyB1c2VzIGl0IGluICdyZXNvbHZlVGFnTmFtZSc6IGl0IHNob3VsZCBwcm9iYWJseSBiZSBpbmxpbmVkCiAgZGVmaW5pdGlvbi5hbmNlc3RyeSA9IGFuY2VzdHJ5KGRlZmluaXRpb24uZXh0ZW5kcyk7CiAgLy8gZXh0ZW5zaW9ucyBvZiBuYXRpdmUgc3BlY2lhbGl6YXRpb25zIG9mIEhUTUxFbGVtZW50IHJlcXVpcmUgbG9jYWxOYW1lCiAgLy8gdG8gcmVtYWluIG5hdGl2ZSwgYW5kIHVzZSBzZWNvbmRhcnkgJ2lzJyBzcGVjaWZpZXIgZm9yIGV4dGVuc2lvbiB0eXBlCiAgcmVzb2x2ZVRhZ05hbWUoZGVmaW5pdGlvbik7CiAgLy8gc29tZSBwbGF0Zm9ybXMgcmVxdWlyZSBtb2RpZmljYXRpb25zIHRvIHRoZSB1c2VyLXN1cHBsaWVkIHByb3RvdHlwZQogIC8vIGNoYWluCiAgcmVzb2x2ZVByb3RvdHlwZUNoYWluKGRlZmluaXRpb24pOwogIC8vIG92ZXJyaWRlcyB0byBpbXBsZW1lbnQgYXR0cmlidXRlQ2hhbmdlZCBjYWxsYmFjawogIG92ZXJyaWRlQXR0cmlidXRlQXBpKGRlZmluaXRpb24ucHJvdG90eXBlKTsKICAvLyA3LjEuNTogUmVnaXN0ZXIgdGhlIERFRklOSVRJT04gd2l0aCBET0NVTUVOVAogIHJlZ2lzdGVyRGVmaW5pdGlvbihpbk5hbWUsIGRlZmluaXRpb24pOwogIC8vIDcuMS43LiBSdW4gY3VzdG9tIGVsZW1lbnQgY29uc3RydWN0b3IgZ2VuZXJhdGlvbiBhbGdvcml0aG0gd2l0aCBQUk9UT1RZUEUKICAvLyA3LjEuOC4gUmV0dXJuIHRoZSBvdXRwdXQgb2YgdGhlIHByZXZpb3VzIHN0ZXAuCiAgZGVmaW5pdGlvbi5jdG9yID0gZ2VuZXJhdGVDb25zdHJ1Y3RvcihkZWZpbml0aW9uKTsKICBkZWZpbml0aW9uLmN0b3IucHJvdG90eXBlID0gZGVmaW5pdGlvbi5wcm90b3R5cGU7CiAgLy8gZm9yY2Ugb3VyIC5jb25zdHJ1Y3RvciB0byBiZSBvdXIgYWN0dWFsIGNvbnN0cnVjdG9yCiAgZGVmaW5pdGlvbi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBkZWZpbml0aW9uLmN0b3I7CiAgLy8gaWYgaW5pdGlhbCBwYXJzaW5nIGlzIGNvbXBsZXRlCiAgaWYgKHNjb3BlLnJlYWR5KSB7CiAgICAvLyB1cGdyYWRlIGFueSBwcmUtZXhpc3Rpbmcgbm9kZXMgb2YgdGhpcyB0eXBlCiAgICBzY29wZS51cGdyYWRlQWxsKGRvY3VtZW50KTsKICB9CiAgcmV0dXJuIGRlZmluaXRpb24uY3RvcjsKfQoKZnVuY3Rpb24gYW5jZXN0cnkoaW5FeHRlbmRzKSB7CiAgdmFyIGV4dGVuZGVlID0gcmVnaXN0cnlbaW5FeHRlbmRzXTsKICBpZiAoZXh0ZW5kZWUpIHsKICAgIHJldHVybiBhbmNlc3RyeShleHRlbmRlZS5leHRlbmRzKS5jb25jYXQoW2V4dGVuZGVlXSk7CiAgfQogIHJldHVybiBbXTsKfQoKZnVuY3Rpb24gcmVzb2x2ZVRhZ05hbWUoaW5EZWZpbml0aW9uKSB7CiAgLy8gaWYgd2UgYXJlIGV4cGxpY2l0bHkgZXh0ZW5kaW5nIHNvbWV0aGluZywgdGhhdCB0aGluZyBpcyBvdXIKICAvLyBiYXNlVGFnLCB1bmxlc3MgaXQgcmVwcmVzZW50cyBhIGN1c3RvbSBjb21wb25lbnQKICB2YXIgYmFzZVRhZyA9IGluRGVmaW5pdGlvbi5leHRlbmRzOwogIC8vIGlmIG91ciBhbmNlc3RyeSBpbmNsdWRlcyBjdXN0b20gY29tcG9uZW50cywgd2Ugb25seSBoYXZlIGEKICAvLyBiYXNlVGFnIGlmIG9uZSBvZiB0aGVtIGRvZXMKICBmb3IgKHZhciBpPTAsIGE7IChhPWluRGVmaW5pdGlvbi5hbmNlc3RyeVtpXSk7IGkrKykgewogICAgYmFzZVRhZyA9IGEuaXMgJiYgYS50YWc7CiAgfQogIC8vIG91ciB0YWcgaXMgb3VyIGJhc2VUYWcsIGlmIGl0IGV4aXN0cywgYW5kIG90aGVyd2lzZSBqdXN0IG91ciBuYW1lCiAgaW5EZWZpbml0aW9uLnRhZyA9IGJhc2VUYWcgfHwgaW5EZWZpbml0aW9uLm5hbWU7CiAgaWYgKGJhc2VUYWcpIHsKICAgIC8vIGlmIHRoZXJlIGlzIGEgYmFzZSB0YWcsIHVzZSBzZWNvbmRhcnkgJ2lzJyBzcGVjaWZpZXIKICAgIGluRGVmaW5pdGlvbi5pcyA9IGluRGVmaW5pdGlvbi5uYW1lOwogIH0KfQoKZnVuY3Rpb24gcmVzb2x2ZVByb3RvdHlwZUNoYWluKGluRGVmaW5pdGlvbikgewogIC8vIGlmIHdlIGRvbid0IHN1cHBvcnQgX19wcm90b19fIHdlIG5lZWQgdG8gbG9jYXRlIHRoZSBuYXRpdmUgbGV2ZWwKICAvLyBwcm90b3R5cGUgZm9yIHByZWNpc2UgbWl4aW5nIGluCiAgaWYgKCFPYmplY3QuX19wcm90b19fKSB7CiAgICAvLyBkZWZhdWx0IHByb3RvdHlwZQogICAgdmFyIG5hdGl2ZSA9IEhUTUxFbGVtZW50LnByb3RvdHlwZTsKICAgIC8vIHdvcmsgb3V0IHByb3RvdHlwZSB3aGVuIHVzaW5nIHR5cGUtZXh0ZW5zaW9uCiAgICBpZiAoaW5EZWZpbml0aW9uLmlzKSB7CiAgICAgIHZhciBpbnN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChpbkRlZmluaXRpb24udGFnKTsKICAgICAgbmF0aXZlID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKGluc3QpOwogICAgfQogIH0KICAvLyBjYWNoZSB0aGlzIGluIGNhc2Ugb2YgbWl4aW4KICBpbkRlZmluaXRpb24ubmF0aXZlID0gbmF0aXZlOwp9CgovLyBTRUNUSU9OIDQKCmZ1bmN0aW9uIGluc3RhbnRpYXRlKGluRGVmaW5pdGlvbikgewogIC8vIDQuYS4xLiBDcmVhdGUgYSBuZXcgb2JqZWN0IHRoYXQgaW1wbGVtZW50cyBQUk9UT1RZUEUKICAvLyA0LmEuMi4gTGV0IEVMRU1FTlQgYnkgdGhpcyBuZXcgb2JqZWN0CiAgLy8KICAvLyB0aGUgY3VzdG9tIGVsZW1lbnQgaW5zdGFudGlhdGlvbiBhbGdvcml0aG0gbXVzdCBhbHNvIGVuc3VyZSB0aGF0IHRoZQogIC8vIG91dHB1dCBpcyBhIHZhbGlkIERPTSBlbGVtZW50IHdpdGggdGhlIHByb3BlciB3cmFwcGVyIGluIHBsYWNlLgogIC8vCiAgcmV0dXJuIHVwZ3JhZGUoZG9tQ3JlYXRlRWxlbWVudChpbkRlZmluaXRpb24udGFnKSwgaW5EZWZpbml0aW9uKTsKfQoKZnVuY3Rpb24gdXBncmFkZShpbkVsZW1lbnQsIGluRGVmaW5pdGlvbikgewogIC8vIHNvbWUgZGVmaW5pdGlvbnMgc3BlY2lmeSBhbiAnaXMnIGF0dHJpYnV0ZQogIGlmIChpbkRlZmluaXRpb24uaXMpIHsKICAgIGluRWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2lzJywgaW5EZWZpbml0aW9uLmlzKTsKICB9CiAgLy8gbWFrZSAnZWxlbWVudCcgaW1wbGVtZW50IGluRGVmaW5pdGlvbi5wcm90b3R5cGUKICBpbXBsZW1lbnQoaW5FbGVtZW50LCBpbkRlZmluaXRpb24pOwogIC8vIGZsYWcgYXMgdXBncmFkZWQKICBpbkVsZW1lbnQuX191cGdyYWRlZF9fID0gdHJ1ZTsKICAvLyB0aGVyZSBzaG91bGQgbmV2ZXIgYmUgYSBzaGFkb3cgcm9vdCBvbiBpbkVsZW1lbnQgYXQgdGhpcyBwb2ludAogIC8vIHdlIHJlcXVpcmUgY2hpbGQgbm9kZXMgYmUgdXBncmFkZWQgYmVmb3JlIHJlYWR5CiAgc2NvcGUudXBncmFkZVN1YnRyZWUoaW5FbGVtZW50KTsKICAvLyBsaWZlY3ljbGUgbWFuYWdlbWVudAogIHJlYWR5KGluRWxlbWVudCk7CiAgLy8gT1VUUFVUCiAgcmV0dXJuIGluRWxlbWVudDsKfQoKZnVuY3Rpb24gaW1wbGVtZW50KGluRWxlbWVudCwgaW5EZWZpbml0aW9uKSB7CiAgLy8gcHJvdG90eXBlIHN3aXp6bGluZyBpcyBiZXN0CiAgaWYgKE9iamVjdC5fX3Byb3RvX18pIHsKICAgIGluRWxlbWVudC5fX3Byb3RvX18gPSBpbkRlZmluaXRpb24ucHJvdG90eXBlOwogIH0gZWxzZSB7CiAgICAvLyB3aGVyZSBhYm92ZSB3ZSBjYW4gcmUtYWNxdWlyZSBpblByb3RvdHlwZSB2aWEKICAgIC8vIGdldFByb3RvdHlwZU9mKEVsZW1lbnQpLCB3ZSBjYW5ub3QgZG8gc28gd2hlbgogICAgLy8gd2UgdXNlIG1peGluLCBzbyB3ZSBpbnN0YWxsIGEgbWFnaWMgcmVmZXJlbmNlCiAgICBjdXN0b21NaXhpbihpbkVsZW1lbnQsIGluRGVmaW5pdGlvbi5wcm90b3R5cGUsIGluRGVmaW5pdGlvbi5uYXRpdmUpOwogICAgaW5FbGVtZW50Ll9fcHJvdG9fXyA9IGluRGVmaW5pdGlvbi5wcm90b3R5cGU7CiAgfQp9CgpmdW5jdGlvbiBjdXN0b21NaXhpbihpblRhcmdldCwgaW5TcmMsIGluTmF0aXZlKSB7CiAgLy8gVE9ETyhzam1pbGVzKTogJ3VzZWQnIGFsbG93cyB1cyB0byBvbmx5IGNvcHkgdGhlICd5b3VuZ2VzdCcgdmVyc2lvbiBvZgogIC8vIGFueSBwcm9wZXJ0eS4gVGhpcyBzZXQgc2hvdWxkIGJlIHByZWNhbGN1bGF0ZWQuIFdlIGFsc28gbmVlZCB0bwogIC8vIGNvbnNpZGVyIHRoaXMgZm9yIHN1cHBvcnRpbmcgJ3N1cGVyJy4KICB2YXIgdXNlZCA9IHt9OwogIC8vIHN0YXJ0IHdpdGggaW5TcmMKICB2YXIgcCA9IGluU3JjOwogIC8vIHNvbWV0aW1lcyB0aGUgZGVmYXVsdCBpcyBIVE1MVW5rbm93bkVsZW1lbnQucHJvdG90eXBlIGluc3RlYWQgb2YKICAvLyBIVE1MRWxlbWVudC5wcm90b3R5cGUsIHNvIHdlIGFkZCBhIHRlc3QKICAvLyB0aGUgaWRlYSBpcyB0byBhdm9pZCBtaXhpbmcgaW4gbmF0aXZlIHByb3RvdHlwZXMsIHNvIGFkZGluZwogIC8vIHRoZSBzZWNvbmQgdGVzdCBpcyBXTE9HCiAgd2hpbGUgKHAgIT09IGluTmF0aXZlICYmIHAgIT09IEhUTUxVbmtub3duRWxlbWVudC5wcm90b3R5cGUpIHsKICAgIHZhciBrZXlzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMocCk7CiAgICBmb3IgKHZhciBpPTAsIGs7IGs9a2V5c1tpXTsgaSsrKSB7CiAgICAgIGlmICghdXNlZFtrXSkgewogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShpblRhcmdldCwgaywKICAgICAgICAgICAgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihwLCBrKSk7CiAgICAgICAgdXNlZFtrXSA9IDE7CiAgICAgIH0KICAgIH0KICAgIHAgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YocCk7CiAgfQp9CgpmdW5jdGlvbiByZWFkeShpbkVsZW1lbnQpIHsKICAvLyBpbnZva2UgcmVhZHlDYWxsYmFjawogIGlmIChpbkVsZW1lbnQucmVhZHlDYWxsYmFjaykgewogICAgaW5FbGVtZW50LnJlYWR5Q2FsbGJhY2soKTsKICB9Cn0KCi8vIGF0dHJpYnV0ZSB3YXRjaGluZwoKZnVuY3Rpb24gb3ZlcnJpZGVBdHRyaWJ1dGVBcGkocHJvdG90eXBlKSB7CiAgLy8gb3ZlcnJpZGVzIHRvIGltcGxlbWVudCBjYWxsYmFja3MKICAvLyBUT0RPKHNqbWlsZXMpOiBzaG91bGQgc3VwcG9ydCBhY2Nlc3MgdmlhIC5hdHRyaWJ1dGVzIE5hbWVkTm9kZU1hcAogIC8vIFRPRE8oc2ptaWxlcyk6IHByZXNlcnZlcyB1c2VyIGRlZmluZWQgb3ZlcnJpZGVzLCBpZiBhbnkKICB2YXIgc2V0QXR0cmlidXRlID0gcHJvdG90eXBlLnNldEF0dHJpYnV0ZTsKICBwcm90b3R5cGUuc2V0QXR0cmlidXRlID0gZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgIGNoYW5nZUF0dHJpYnV0ZS5jYWxsKHRoaXMsIG5hbWUsIHZhbHVlLCBzZXRBdHRyaWJ1dGUpOwogIH0KICB2YXIgcmVtb3ZlQXR0cmlidXRlID0gcHJvdG90eXBlLnJlbW92ZUF0dHJpYnV0ZTsKICBwcm90b3R5cGUucmVtb3ZlQXR0cmlidXRlID0gZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgIGNoYW5nZUF0dHJpYnV0ZS5jYWxsKHRoaXMsIG5hbWUsIHZhbHVlLCByZW1vdmVBdHRyaWJ1dGUpOwogIH0KfQoKZnVuY3Rpb24gY2hhbmdlQXR0cmlidXRlKG5hbWUsIHZhbHVlLCBvcGVyYXRpb24pIHsKICB2YXIgb2xkVmFsdWUgPSB0aGlzLmdldEF0dHJpYnV0ZShuYW1lKTsKICBvcGVyYXRpb24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICBpZiAodGhpcy5hdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sKICAgICAgJiYgKHRoaXMuZ2V0QXR0cmlidXRlKG5hbWUpICE9PSBvbGRWYWx1ZSkpIHsKICAgIHRoaXMuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrKG5hbWUsIG9sZFZhbHVlKTsKICB9Cn0KCi8vIGVsZW1lbnQgcmVnaXN0cnkgKG1hcHMgdGFnIG5hbWVzIHRvIGRlZmluaXRpb25zKQoKdmFyIHJlZ2lzdHJ5ID0ge307CgpmdW5jdGlvbiByZWdpc3RlckRlZmluaXRpb24oaW5OYW1lLCBpbkRlZmluaXRpb24pIHsKICByZWdpc3RyeVtpbk5hbWVdID0gaW5EZWZpbml0aW9uOwp9CgpmdW5jdGlvbiBnZW5lcmF0ZUNvbnN0cnVjdG9yKGluRGVmaW5pdGlvbikgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBpbnN0YW50aWF0ZShpbkRlZmluaXRpb24pOwogIH07Cn0KCmZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnQoaW5UYWcpIHsKICB2YXIgZGVmaW5pdGlvbiA9IHJlZ2lzdHJ5W2luVGFnXTsKICBpZiAoZGVmaW5pdGlvbikgewogICAgcmV0dXJuIG5ldyBkZWZpbml0aW9uLmN0b3IoKTsKICB9CiAgcmV0dXJuIGRvbUNyZWF0ZUVsZW1lbnQoaW5UYWcpOwp9CgpmdW5jdGlvbiB1cGdyYWRlRWxlbWVudChpbkVsZW1lbnQpIHsKICBpZiAoIWluRWxlbWVudC5fX3VwZ3JhZGVkX18gJiYgKGluRWxlbWVudC5ub2RlVHlwZSA9PT0gTm9kZS5FTEVNRU5UX05PREUpKSB7CiAgICB2YXIgdHlwZSA9IGluRWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2lzJykgfHwgaW5FbGVtZW50LmxvY2FsTmFtZTsKICAgIHZhciBkZWZpbml0aW9uID0gcmVnaXN0cnlbdHlwZV07CiAgICByZXR1cm4gZGVmaW5pdGlvbiAmJiB1cGdyYWRlKGluRWxlbWVudCwgZGVmaW5pdGlvbik7CiAgfQp9CgpmdW5jdGlvbiBjbG9uZU5vZGUoZGVlcCkgewogIC8vIGNhbGwgb3JpZ2luYWwgY2xvbmUKICB2YXIgbiA9IGRvbUNsb25lTm9kZS5jYWxsKHRoaXMsIGRlZXApOwogIC8vIHVwZ3JhZGUgdGhlIGVsZW1lbnQgYW5kIHN1YnRyZWUKICBzY29wZS51cGdyYWRlQWxsKG4pOwogIHJldHVybiBuOwp9Ci8vIGNhcHR1cmUgbmF0aXZlIGNyZWF0ZUVsZW1lbnQgYmVmb3JlIHdlIG92ZXJyaWRlIGl0Cgp2YXIgZG9tQ3JlYXRlRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQuYmluZChkb2N1bWVudCk7CgovLyBjYXB0dXJlIG5hdGl2ZSBjbG9uZU5vZGUgYmVmb3JlIHdlIG92ZXJyaWRlIGl0Cgp2YXIgZG9tQ2xvbmVOb2RlID0gTm9kZS5wcm90b3R5cGUuY2xvbmVOb2RlOwoKLy8gZXhwb3J0cwoKZG9jdW1lbnQucmVnaXN0ZXIgPSByZWdpc3RlcjsKZG9jdW1lbnQuY3JlYXRlRWxlbWVudCA9IGNyZWF0ZUVsZW1lbnQ7IC8vIG92ZXJyaWRlCk5vZGUucHJvdG90eXBlLmNsb25lTm9kZSA9IGNsb25lTm9kZTsgLy8gb3ZlcnJpZGUKCnNjb3BlLnJlZ2lzdHJ5ID0gcmVnaXN0cnk7CgovKioKICogVXBncmFkZSBhbiBlbGVtZW50IHRvIGEgY3VzdG9tIGVsZW1lbnQuIFVwZ3JhZGluZyBhbiBlbGVtZW50CiAqIGNhdXNlcyB0aGUgY3VzdG9tIHByb3RvdHlwZSB0byBiZSBhcHBsaWVkLCBhbiBgaXNgIGF0dHJpYnV0ZQogKiB0byBiZSBhdHRhY2hlZCAoYXMgbmVlZGVkKSwgYW5kIGludm9jYXRpb24gb2YgdGhlIGByZWFkeUNhbGxiYWNrYC4KICogYHVwZ3JhZGVgIGRvZXMgbm90aGluZyBpZiB0aGUgZWxlbWVudCBpcyBhbHJlYWR5IHVwZ3JhZGVkLCBvcgogKiBpZiBpdCBtYXRjaGVzIG5vIHJlZ2lzdGVyZWQgY3VzdG9tIHRhZyBuYW1lLgogKgogKiBAbWV0aG9kIHVncHJhZGUKICogQHBhcmFtIHtFbGVtZW50fSBpbkVsZW1lbnQgVGhlIGVsZW1lbnQgdG8gdXBncmFkZS4KICogQHJldHVybiB7RWxlbWVudH0gVGhlIHVwZ3JhZGVkIGVsZW1lbnQuCiAqLwpzY29wZS51cGdyYWRlID0gdXBncmFkZUVsZW1lbnQ7Cgp9Cgp9KSh3aW5kb3cuQ3VzdG9tRWxlbWVudHMpOwoKIC8qCkNvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuClVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCmxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KKi8KCihmdW5jdGlvbihzY29wZSl7CgovKgppZiAoSFRNTEVsZW1lbnQucHJvdG90eXBlLndlYmtpdFNoYWRvd1Jvb3QpIHsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoSFRNTEVsZW1lbnQucHJvdG90eXBlLCAnc2hhZG93Um9vdCcsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLndlYmtpdFNoYWRvd1Jvb3Q7CiAgICB9CiAgfTsKfQoqLwoKLy8gd2FsayB0aGUgc3VidHJlZSByb290ZWQgYXQgbm9kZSwgYXBwbHlpbmcgJ2ZpbmQoZWxlbWVudCwgZGF0YSknIGZ1bmN0aW9uCi8vIHRvIGVhY2ggZWxlbWVudAovLyBpZiAnZmluZCcgcmV0dXJucyB0cnVlIGZvciAnZWxlbWVudCcsIGRvIG5vdCBzZWFyY2ggZWxlbWVudCdzIHN1YnRyZWUKZnVuY3Rpb24gZmluZEFsbChub2RlLCBmaW5kLCBkYXRhKSB7CiAgdmFyIGUgPSBub2RlLmZpcnN0RWxlbWVudENoaWxkOwogIGlmICghZSkgewogICAgZSA9IG5vZGUuZmlyc3RDaGlsZDsKICAgIHdoaWxlIChlICYmIGUubm9kZVR5cGUgIT09IE5vZGUuRUxFTUVOVF9OT0RFKSB7CiAgICAgIGUgPSBlLm5leHRTaWJsaW5nOwogICAgfQogIH0KICB3aGlsZSAoZSkgewogICAgaWYgKGZpbmQoZSwgZGF0YSkgIT09IHRydWUpIHsKICAgICAgZmluZEFsbChlLCBmaW5kLCBkYXRhKTsKICAgIH0KICAgIGUgPSBlLm5leHRFbGVtZW50U2libGluZzsKICB9CiAgcmV0dXJuIG51bGw7Cn0KCi8vIHdhbGsgdGhlIHN1YnRyZWUgcm9vdGVkIGF0IG5vZGUsIGluY2x1ZGluZyBkZXNjZW50IGludG8gc2hhZG93LXJvb3RzLAovLyBhcHBseWluZyAnY2InIHRvIGVhY2ggZWxlbWVudApmdW5jdGlvbiBmb3JTdWJ0cmVlKG5vZGUsIGNiKSB7CiAgLy9sb2dGbGFncy5kb20gJiYgbm9kZS5jaGlsZE5vZGVzICYmIG5vZGUuY2hpbGROb2Rlcy5sZW5ndGggJiYgY29uc29sZS5ncm91cCgnc3ViVHJlZTogJywgbm9kZSk7CiAgZmluZEFsbChub2RlLCBmdW5jdGlvbihlKSB7CiAgICBpZiAoY2IoZSkpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBpZiAoZS53ZWJraXRTaGFkb3dSb290KSB7CiAgICAgIGZvclN1YnRyZWUoZS53ZWJraXRTaGFkb3dSb290LCBjYik7CiAgICB9CiAgfSk7CiAgaWYgKG5vZGUud2Via2l0U2hhZG93Um9vdCkgewogICAgZm9yU3VidHJlZShub2RlLndlYmtpdFNoYWRvd1Jvb3QsIGNiKTsKICB9CiAgLy9sb2dGbGFncy5kb20gJiYgbm9kZS5jaGlsZE5vZGVzICYmIG5vZGUuY2hpbGROb2Rlcy5sZW5ndGggJiYgY29uc29sZS5ncm91cEVuZCgpOwp9CgovLyBtYW5hZ2UgbGlmZWN5Y2xlIG9uIGFkZGVkIG5vZGUKZnVuY3Rpb24gYWRkZWQobm9kZSkgewogIGlmICh1cGdyYWRlKG5vZGUpKSB7CiAgICBpbnNlcnRlZE5vZGUobm9kZSk7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgaW5zZXJ0ZWQobm9kZSk7Cn0KCi8vIG1hbmFnZSBsaWZlY3ljbGUgb24gYWRkZWQgbm9kZSdzIHN1YnRyZWUgb25seQpmdW5jdGlvbiBhZGRlZFN1YnRyZWUobm9kZSkgewogIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgewogICAgaWYgKGFkZGVkKGUpKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0pOwp9CgovLyBtYW5hZ2UgbGlmZWN5Y2xlIG9uIGFkZGVkIG5vZGUgYW5kIGl0J3Mgc3VidHJlZQpmdW5jdGlvbiBhZGRlZE5vZGUobm9kZSkgewogIHJldHVybiBhZGRlZChub2RlKSB8fCBhZGRlZFN1YnRyZWUobm9kZSk7Cn0KCi8vIHVwZ3JhZGUgY3VzdG9tIGVsZW1lbnRzIGF0IG5vZGUsIGlmIGFwcGxpY2FibGUKZnVuY3Rpb24gdXBncmFkZShub2RlKSB7CiAgaWYgKCFub2RlLl9fdXBncmFkZWRfXyAmJiBub2RlLm5vZGVUeXBlID09PSBOb2RlLkVMRU1FTlRfTk9ERSkgewogICAgdmFyIHR5cGUgPSBub2RlLmdldEF0dHJpYnV0ZSgnaXMnKSB8fCBub2RlLmxvY2FsTmFtZTsKICAgIHZhciBkZWZpbml0aW9uID0gc2NvcGUucmVnaXN0cnlbdHlwZV07CiAgICBpZiAoZGVmaW5pdGlvbikgewogICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cCgndXBncmFkZTonLCBub2RlLmxvY2FsTmFtZSk7CiAgICAgIHNjb3BlLnVwZ3JhZGUobm9kZSk7CiAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KfQoKZnVuY3Rpb24gaW5zZXJ0ZWROb2RlKG5vZGUpIHsKICBpbnNlcnRlZChub2RlKTsKICBpZiAoaW5Eb2N1bWVudChub2RlKSkgewogICAgZm9yU3VidHJlZShub2RlLCBmdW5jdGlvbihlKSB7CiAgICAgIGluc2VydGVkKGUpOwogICAgfSk7CiAgfQp9CgovLyBUT0RPKHNqbWlsZXMpOiBpZiB0aGVyZSBhcmUgZGVzY2VudHMgaW50byB0cmVlcyB0aGF0IGNhbiBuZXZlciBoYXZlIGluRG9jdW1lbnQoKikgdHJ1ZSwgZml4IHRoaXMKCmZ1bmN0aW9uIGluc2VydGVkKGVsZW1lbnQpIHsKICAvLyBUT0RPKHNqbWlsZXMpOiBpdCdzIHBvc3NpYmxlIHdlIHdlcmUgaW5zZXJ0ZWQgYW5kIHJlbW92ZWQgaW4gdGhlIHNwYWNlCiAgLy8gb2Ygb25lIG1pY3JvdGFzaywgaW4gd2hpY2ggY2FzZSB3ZSB3b24ndCBiZSAnaW5Eb2N1bWVudCcgaGVyZQogIC8vIEJ1dCB0aGVyZSBhcmUgb3RoZXIgY2FzZXMgd2hlcmUgd2UgYXJlIHRlc3RpbmcgZm9yIGluc2VydGVkIHdpdGhvdXQKICAvLyBzcGVjaWZpYyBrbm93bGVkZ2Ugb2YgbXV0YXRpb25zLCBhbmQgbXVzdCB0ZXN0ICdpbkRvY3VtZW50JyB0byBkZXRlcm1pbmUKICAvLyB3aGV0aGVyIHRvIGNhbGwgaW5zZXJ0ZWQKICAvLyBJZiB3ZSBjYW4gZmFjdG9yIHRoZXNlIGNhc2VzIGludG8gc2VwYXJhdGUgY29kZSBwYXRocyB3ZSBjYW4gaGF2ZQogIC8vIGJldHRlciBkaWFnbm9zdGljcy4KICAvLyBUT0RPKHNqbWlsZXMpOiB3aGVuIGxvZ2dpbmcsIGRvIHdvcmsgb24gYWxsIGN1c3RvbSBlbGVtZW50cyBzbyB3ZSBjYW4KICAvLyB0cmFjayBiZWhhdmlvciBldmVuIHdoZW4gY2FsbGJhY2tzIG5vdCBkZWZpbmVkCiAgLy9jb25zb2xlLmxvZygnaW5zZXJ0ZWQ6ICcsIGVsZW1lbnQubG9jYWxOYW1lKTsKICBpZiAoZWxlbWVudC5pbnNlcnRlZENhbGxiYWNrIHx8IChlbGVtZW50Ll9fdXBncmFkZWRfXyAmJiBsb2dGbGFncy5kb20pKSB7CiAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cCgnaW5zZXJ0ZWQ6JywgZWxlbWVudC5sb2NhbE5hbWUpOwogICAgaWYgKGluRG9jdW1lbnQoZWxlbWVudCkpIHsKICAgICAgZWxlbWVudC5fX2luc2VydGVkID0gKGVsZW1lbnQuX19pbnNlcnRlZCB8fCAwKSArIDE7CiAgICAgIC8vIGlmIHdlIGFyZSBpbiBhICdyZW1vdmVkJyBzdGF0ZSwgYmx1bnRseSBhZGp1c3QgdG8gYW4gJ2luc2VydGVkJyBzdGF0ZQogICAgICBpZiAoZWxlbWVudC5fX2luc2VydGVkIDwgMSkgewogICAgICAgIGVsZW1lbnQuX19pbnNlcnRlZCA9IDE7CiAgICAgIH0KICAgICAgLy8gaWYgd2UgYXJlICdvdmVyIGluc2VydGVkJywgc3F1ZWxjaCB0aGUgY2FsbGJhY2sKICAgICAgaWYgKGVsZW1lbnQuX19pbnNlcnRlZCA+IDEpIHsKICAgICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS53YXJuKCdpbnNlcnRlZDonLCBlbGVtZW50LmxvY2FsTmFtZSwKICAgICAgICAgICdpbnNlcnQvcmVtb3ZlIGNvdW50OicsIGVsZW1lbnQuX19pbnNlcnRlZCkKICAgICAgfSBlbHNlIGlmIChlbGVtZW50Lmluc2VydGVkQ2FsbGJhY2spIHsKICAgICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2coJ2luc2VydGVkOicsIGVsZW1lbnQubG9jYWxOYW1lKTsKICAgICAgICBlbGVtZW50Lmluc2VydGVkQ2FsbGJhY2soKTsKICAgICAgfQogICAgfQogICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsKICB9Cn0KCmZ1bmN0aW9uIHJlbW92ZWROb2RlKG5vZGUpIHsKICByZW1vdmVkKG5vZGUpOwogIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgewogICAgcmVtb3ZlZChlKTsKICB9KTsKfQoKZnVuY3Rpb24gcmVtb3ZlZChlbGVtZW50KSB7CiAgLy8gVE9ETyhzam1pbGVzKTogdGVtcG9yYXJ5OiBkbyB3b3JrIG9uIGFsbCBjdXN0b20gZWxlbWVudHMgc28gd2UgY2FuIHRyYWNrCiAgLy8gYmVoYXZpb3IgZXZlbiB3aGVuIGNhbGxiYWNrcyBub3QgZGVmaW5lZAogIGlmIChlbGVtZW50LnJlbW92ZWRDYWxsYmFjayB8fCAoZWxlbWVudC5fX3VwZ3JhZGVkX18gJiYgbG9nRmxhZ3MuZG9tKSkgewogICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKCdyZW1vdmVkOicsIGVsZW1lbnQubG9jYWxOYW1lKTsKICAgIGlmICghaW5Eb2N1bWVudChlbGVtZW50KSkgewogICAgICBlbGVtZW50Ll9faW5zZXJ0ZWQgPSAoZWxlbWVudC5fX2luc2VydGVkIHx8IDApIC0gMTsKICAgICAgLy8gaWYgd2UgYXJlIGluIGEgJ2luc2VydGVkJyBzdGF0ZSwgYmx1bnRseSBhZGp1c3QgdG8gYW4gJ3JlbW92ZWQnIHN0YXRlCiAgICAgIGlmIChlbGVtZW50Ll9faW5zZXJ0ZWQgPiAwKSB7CiAgICAgICAgZWxlbWVudC5fX2luc2VydGVkID0gMDsKICAgICAgfQogICAgICAvLyBpZiB3ZSBhcmUgJ292ZXIgcmVtb3ZlZCcsIHNxdWVsY2ggdGhlIGNhbGxiYWNrCiAgICAgIGlmIChlbGVtZW50Ll9faW5zZXJ0ZWQgPCAwKSB7CiAgICAgICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUud2FybigncmVtb3ZlZDonLCBlbGVtZW50LmxvY2FsTmFtZSwKICAgICAgICAgICAgJ2luc2VydC9yZW1vdmUgY291bnQ6JywgZWxlbWVudC5fX2luc2VydGVkKQogICAgICB9IGVsc2UgaWYgKGVsZW1lbnQucmVtb3ZlZENhbGxiYWNrKSB7CiAgICAgICAgZWxlbWVudC5yZW1vdmVkQ2FsbGJhY2soKTsKICAgICAgfQogICAgfQogIH0KfQoKZnVuY3Rpb24gaW5Eb2N1bWVudChlbGVtZW50KSB7CiAgdmFyIHAgPSBlbGVtZW50OwogIHdoaWxlIChwKSB7CiAgICBpZiAocCA9PSBlbGVtZW50Lm93bmVyRG9jdW1lbnQpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBwID0gcC5wYXJlbnROb2RlIHx8IHAuaG9zdDsKICB9Cn0KCmZ1bmN0aW9uIHdhdGNoU2hhZG93KG5vZGUpIHsKICBpZiAobm9kZS53ZWJraXRTaGFkb3dSb290ICYmICFub2RlLndlYmtpdFNoYWRvd1Jvb3QuX193YXRjaGVkKSB7CiAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2coJ3dhdGNoaW5nIHNoYWRvdy1yb290IGZvcjogJywgbm9kZS5sb2NhbE5hbWUpOwogICAgb2JzZXJ2ZShub2RlLndlYmtpdFNoYWRvd1Jvb3QpOwogICAgbm9kZS53ZWJraXRTaGFkb3dSb290Ll9fd2F0Y2hlZCA9IHRydWU7CiAgfQp9CgpmdW5jdGlvbiB3YXRjaEFsbFNoYWRvd3Mobm9kZSkgewogIHdhdGNoU2hhZG93KG5vZGUpOwogIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgewogICAgd2F0Y2hTaGFkb3cobm9kZSk7CiAgfSk7Cn0KCmZ1bmN0aW9uIGZpbHRlcihpbk5vZGUpIHsKICBzd2l0Y2ggKGluTm9kZS5sb2NhbE5hbWUpIHsKICAgIGNhc2UgJ3N0eWxlJzoKICAgIGNhc2UgJ3NjcmlwdCc6CiAgICBjYXNlICd0ZW1wbGF0ZSc6CiAgICBjYXNlIHVuZGVmaW5lZDoKICAgICAgcmV0dXJuIHRydWU7CiAgfQp9CgpmdW5jdGlvbiBoYW5kbGVyKG11dGF0aW9ucykgewogIC8vCiAgaWYgKGxvZ0ZsYWdzLmRvbSkgewogICAgdmFyIG14ID0gbXV0YXRpb25zWzBdOwogICAgaWYgKG14ICYmIG14LnR5cGUgPT09ICdjaGlsZExpc3QnICYmIG14LmFkZGVkTm9kZXMpIHsKICAgICAgICBpZiAobXguYWRkZWROb2RlcykgewogICAgICAgICAgdmFyIGQgPSBteC5hZGRlZE5vZGVzWzBdOwogICAgICAgICAgd2hpbGUgKGQgJiYgZCAhPT0gZG9jdW1lbnQgJiYgIWQuaG9zdCkgewogICAgICAgICAgICBkID0gZC5wYXJlbnROb2RlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHUgPSBkICYmIChkLlVSTCB8fCBkLl9VUkwgfHwgKGQuaG9zdCAmJiBkLmhvc3QubG9jYWxOYW1lKSkgfHwgJyc7CiAgICAgICAgICB1ID0gdS5zcGxpdCgnLz8nKS5zaGlmdCgpLnNwbGl0KCcvJykucG9wKCk7CiAgICAgICAgfQogICAgfQogICAgY29uc29sZS5ncm91cCgnbXV0YXRpb25zICglZCkgWyVzXScsIG11dGF0aW9ucy5sZW5ndGgsIHUgfHwgJycpOwogIH0KICAvLwogIG11dGF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKG14KSB7CiAgICAvL2xvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwKCdtdXRhdGlvbicpOwogICAgaWYgKG14LnR5cGUgPT09ICdjaGlsZExpc3QnKSB7CiAgICAgIGZvckVhY2gobXguYWRkZWROb2RlcywgZnVuY3Rpb24obikgewogICAgICAgIC8vbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKG4ubG9jYWxOYW1lKTsKICAgICAgICBpZiAoZmlsdGVyKG4pKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIC8vIHdhdGNoIHNoYWRvdy1yb290cyBvbiBub2RlcyB0aGF0IGhhdmUgaGFkIHRoZW0gYXR0YWNoZWQgbWFudWFsbHkKICAgICAgICAvLyBUT0RPKHNqbWlsZXMpOiByZW1vdmUgaWYgY3JlYXRlU2hhZG93Um9vdCBpcyBvdmVycmlkZGVuCiAgICAgICAgLy8gVE9ETyhzam1pbGVzKTogcmVtb3ZlZCBhcyBhbiBvcHRpbWl6YXRpb24sIG1hbnVhbCBzaGFkb3cgcm9vdHMKICAgICAgICAvLyBtdXN0IGJlIHdhdGNoZWQgZXhwbGljaXRseQogICAgICAgIC8vd2F0Y2hBbGxTaGFkb3dzKG4pOwogICAgICAgIC8vIG5vZGVzIGFkZGVkIG1heSBuZWVkIGxpZmVjeWNsZSBtYW5hZ2VtZW50CiAgICAgICAgYWRkZWROb2RlKG4pOwogICAgICB9KTsKICAgICAgLy8gcmVtb3ZlZCBub2RlcyBtYXkgbmVlZCBsaWZlY3ljbGUgbWFuYWdlbWVudAogICAgICBmb3JFYWNoKG14LnJlbW92ZWROb2RlcywgZnVuY3Rpb24obikgewogICAgICAgIC8vbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKG4ubG9jYWxOYW1lKTsKICAgICAgICBpZiAoZmlsdGVyKG4pKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHJlbW92ZWROb2RlKG4pOwogICAgICB9KTsKICAgIH0KICAgIC8vbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsKICB9KTsKICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cEVuZCgpOwp9OwoKdmFyIG9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoaGFuZGxlcik7CgpmdW5jdGlvbiB0YWtlUmVjb3JkcygpIHsKICAvLyBUT0RPKHNqbWlsZXMpOiBhc2sgUmFmIHdoeSB3ZSBoYXZlIHRvIGNhbGwgaGFuZGxlciBvdXJzZWx2ZXMKICBoYW5kbGVyKG9ic2VydmVyLnRha2VSZWNvcmRzKCkpOwp9Cgp2YXIgZm9yRWFjaCA9IEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwuYmluZChBcnJheS5wcm90b3R5cGUuZm9yRWFjaCk7CgpmdW5jdGlvbiBvYnNlcnZlKGluUm9vdCkgewogIG9ic2VydmVyLm9ic2VydmUoaW5Sb290LCB7Y2hpbGRMaXN0OiB0cnVlLCBzdWJ0cmVlOiB0cnVlfSk7Cn0KCmZ1bmN0aW9uIG9ic2VydmVEb2N1bWVudChkb2N1bWVudCkgewogIG9ic2VydmUoZG9jdW1lbnQpOwp9CgpmdW5jdGlvbiB1cGdyYWRlRG9jdW1lbnQoZG9jdW1lbnQpIHsKICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cCgndXBncmFkZURvY3VtZW50OiAnLCAoZG9jdW1lbnQuVVJMIHx8IGRvY3VtZW50Ll9VUkwgfHwgJycpLnNwbGl0KCcvJykucG9wKCkpOwogIGFkZGVkTm9kZShkb2N1bWVudCk7CiAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsKfQoKLy8gZXhwb3J0cwoKc2NvcGUud2F0Y2hTaGFkb3cgPSB3YXRjaFNoYWRvdzsKc2NvcGUud2F0Y2hBbGxTaGFkb3dzID0gd2F0Y2hBbGxTaGFkb3dzOwoKc2NvcGUudXBncmFkZUFsbCA9IGFkZGVkTm9kZTsKc2NvcGUudXBncmFkZVN1YnRyZWUgPSBhZGRlZFN1YnRyZWU7CgpzY29wZS5vYnNlcnZlRG9jdW1lbnQgPSBvYnNlcnZlRG9jdW1lbnQ7CnNjb3BlLnVwZ3JhZGVEb2N1bWVudCA9IHVwZ3JhZGVEb2N1bWVudDsKCnNjb3BlLnRha2VSZWNvcmRzID0gdGFrZVJlY29yZHM7Cgp9KSh3aW5kb3cuQ3VzdG9tRWxlbWVudHMpOwoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCihmdW5jdGlvbigpewoKdmFyIEhUTUxFbGVtZW50RWxlbWVudCA9IGZ1bmN0aW9uKGluRWxlbWVudCkgewogIGluRWxlbWVudC5yZWdpc3RlciA9IEhUTUxFbGVtZW50RWxlbWVudC5wcm90b3R5cGUucmVnaXN0ZXI7CiAgcGFyc2VFbGVtZW50RWxlbWVudChpbkVsZW1lbnQpOwogIHJldHVybiBpbkVsZW1lbnQ7Cn07CgpIVE1MRWxlbWVudEVsZW1lbnQucHJvdG90eXBlID0gewogIHJlZ2lzdGVyOiBmdW5jdGlvbihpbk1vcmUpIHsKICAgIGlmIChpbk1vcmUpIHsKICAgICAgdGhpcy5vcHRpb25zLmxpZmVjeWNsZSA9IGluTW9yZS5saWZlY3ljbGU7CiAgICAgIGlmIChpbk1vcmUucHJvdG90eXBlKSB7CiAgICAgICAgbWl4aW4odGhpcy5vcHRpb25zLnByb3RvdHlwZSwgaW5Nb3JlLnByb3RvdHlwZSk7CiAgICAgIH0KICAgIH0KICB9Cn07CgpmdW5jdGlvbiBwYXJzZUVsZW1lbnRFbGVtZW50KGluRWxlbWVudCkgewogIC8vIG9wdGlvbnMgdG8gZ2xlYW4gZnJvbSBpbkVsZW1lbnQgYXR0cmlidXRlcwogIHZhciBvcHRpb25zID0gewogICAgbmFtZTogJycsCiAgICBleHRlbmRzOiBudWxsCiAgfTsKICAvLyBnbGVhbiB0aGVtCiAgdGFrZUF0dHJpYnV0ZXMoaW5FbGVtZW50LCBvcHRpb25zKTsKICAvLyBkZWZhdWx0IGJhc2UKICB2YXIgYmFzZSA9IEhUTUxFbGVtZW50LnByb3RvdHlwZTsKICAvLyBvcHRpb25hbCBzcGVjaWZpZWQgYmFzZQogIGlmIChvcHRpb25zLmV4dGVuZHMpIHsKICAgIC8vIGJ1aWxkIGFuIGluc3RhbmNlIG9mIG9wdGlvbnMuZXh0ZW5kcwogICAgdmFyIGFyY2hldHlwZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQob3B0aW9ucy5leHRlbmRzKTsKICAgIC8vIGFjcXVpcmUgdGhlIHByb3RvdHlwZQogICAgLy8gVE9ETyhzam1pbGVzKTogX19wcm90b19fIG1heSBiZSBoaW50ZWQgYnkgdGhlIGN1c3RvbSBlbGVtZW50CiAgICAvLyBzeXN0ZW0gb24gcGxhdGZvcm1zIHRoYXQgZG9uJ3Qgc3VwcG9ydCBuYXRpdmUgX19wcm90b19fCiAgICAvLyBvbiB0aG9zZSBwbGF0Zm9ybXMgdGhlIEFQSSBpcyBtaXhlZCBpbnRvIGFyY2hldHlwZSBhbmQgdGhlCiAgICAvLyBlZmZlY3RpdmUgYmFzZSBpcyBub3QgYXJjaGV0eXBlJ3MgcmVhbCBwcm90b3R5cGUKICAgIGJhc2UgPSBhcmNoZXR5cGUuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihhcmNoZXR5cGUpOwogIH0KICAvLyBleHRlbmQgYmFzZQogIG9wdGlvbnMucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShiYXNlKTsKICAvLyBpbnN0YWxsIG9wdGlvbnMKICBpbkVsZW1lbnQub3B0aW9ucyA9IG9wdGlvbnM7CiAgLy8gbG9jYXRlIHVzZXIgc2NyaXB0CiAgdmFyIHNjcmlwdCA9IGluRWxlbWVudC5xdWVyeVNlbGVjdG9yKCdzY3JpcHQ6bm90KFt0eXBlXSksc2NyaXB0W3R5cGU9InRleHQvamF2YXNjcmlwdCJdLHNjcmlwdHMnKTsKICBpZiAoc2NyaXB0KSB7CiAgICAvLyBleGVjdXRlIHVzZXIgc2NyaXB0IGluICdpbkVsZW1lbnQnIGNvbnRleHQKICAgIGV4ZWN1dGVDb21wb25lbnRTY3JpcHQoc2NyaXB0LnRleHRDb250ZW50LCBpbkVsZW1lbnQsIG9wdGlvbnMubmFtZSk7CiAgfTsKICAvLyByZWdpc3RlciBvdXIgbmV3IGVsZW1lbnQKICB2YXIgY3RvciA9IGRvY3VtZW50LnJlZ2lzdGVyKG9wdGlvbnMubmFtZSwgb3B0aW9ucyk7CiAgaW5FbGVtZW50LmN0b3IgPSBjdG9yOwogIC8vIHN0b3JlIG9wdGlvbmFsIGNvbnN0cnVjdG9yIHJlZmVyZW5jZQogIHZhciByZWZOYW1lID0gaW5FbGVtZW50LmdldEF0dHJpYnV0ZSgnY29uc3RydWN0b3InKTsKICBpZiAocmVmTmFtZSkgewogICAgd2luZG93W3JlZk5hbWVdID0gY3RvcjsKICB9Cn0KCi8vIGVhY2ggcHJvcGVydHkgaW4gaW5EaWN0aW9uYXJ5IHRha2VzIGEgdmFsdWUKLy8gZnJvbSB0aGUgbWF0Y2hpbmcgYXR0cmlidXRlIGluIGluRWxlbWVudCwgaWYgYW55CmZ1bmN0aW9uIHRha2VBdHRyaWJ1dGVzKGluRWxlbWVudCwgaW5EaWN0aW9uYXJ5KSB7CiAgZm9yICh2YXIgbiBpbiBpbkRpY3Rpb25hcnkpIHsKICAgIHZhciBhID0gaW5FbGVtZW50LmF0dHJpYnV0ZXNbbl07CiAgICBpZiAoYSkgewogICAgICBpbkRpY3Rpb25hcnlbbl0gPSBhLnZhbHVlOwogICAgfQogIH0KfQoKLy8gaW52b2tlIGluU2NyaXB0IGluIGluQ29udGV4dCBzY29wZQpmdW5jdGlvbiBleGVjdXRlQ29tcG9uZW50U2NyaXB0KGluU2NyaXB0LCBpbkNvbnRleHQsIGluTmFtZSkgewogIC8vIHNldCAoaGlnaGxhbmRlcikgY29udGV4dAogIGNvbnRleHQgPSBpbkNvbnRleHQ7CiAgLy8gc291cmNlIGxvY2F0aW9uCiAgdmFyIG93bmVyID0gY29udGV4dC5vd25lckRvY3VtZW50OwogIHZhciB1cmwgPSAob3duZXIuX1VSTCB8fCBvd25lci5VUkwgfHwgb3duZXIuaW1wbAogICAgICAmJiAob3duZXIuaW1wbC5fVVJMIHx8IG93bmVyLmltcGwuVVJMKSk7CiAgLy8gZW5zdXJlIHRoZSBjb21wb25lbnQgaGFzIGEgdW5pcXVlIHNvdXJjZSBtYXAgc28gaXQgY2FuIGJlIGRlYnVnZ2VkCiAgLy8gaWYgdGhlIG5hbWUgbWF0Y2hlcyB0aGUgZmlsZW5hbWUgcGFydCBvZiB0aGUgb3duaW5nIGRvY3VtZW50J3MgdXJsLAogIC8vIHVzZSB0aGlzLCBvdGhlcndpc2UsIGFkZCAiOjxuYW1lPiIgdG8gdGhlIGRvY3VtZW50IHVybC4KICB2YXIgbWF0Y2ggPSB1cmwubWF0Y2goLy4qXC8oW14uXSopWy5dPy4qJC8pOwogIGlmIChtYXRjaCkgewogICAgdmFyIG5hbWUgPSBtYXRjaFsxXTsKICAgIHVybCArPSBuYW1lICE9IGluTmFtZSA/ICc6JyArIGluTmFtZSA6ICcnOwogIH0KICAvLyBjb21wb3NlIHNjcmlwdAogIHZhciBjb2RlID0gIl9fY29tcG9uZW50U2NyaXB0KCciCiAgICArIGluTmFtZQogICAgKyAiJywgZnVuY3Rpb24oKXsiCiAgICArIGluU2NyaXB0CiAgICArICJ9KTsiCiAgICArICJcbi8vQCBzb3VyY2VVUkw9IiArIHVybCArICJcbiIKICA7CiAgLy8gaW5qZWN0IHNjcmlwdAogIGV2YWwoY29kZSk7Cn0KCnZhciBjb250ZXh0OwoKLy8gZ2xvYmFsIG5lY2Vzc2FyeSBmb3Igc2NyaXB0IGluamVjdGlvbgp3aW5kb3cuX19jb21wb25lbnRTY3JpcHQgPSBmdW5jdGlvbihpbk5hbWUsIGluRnVuYykgewogIGluRnVuYy5jYWxsKGNvbnRleHQpOwp9OwoKLy8gdXRpbGl0eQoKLy8gY29weSB0b3AgbGV2ZWwgcHJvcGVydGllcyBmcm9tIHByb3BzIHRvIG9iagpmdW5jdGlvbiBtaXhpbihvYmosIHByb3BzKSB7CiAgb2JqID0gb2JqIHx8IHt9OwogIHRyeSB7CiAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhwcm9wcykuZm9yRWFjaChmdW5jdGlvbihuKSB7CiAgICAgIHZhciBwZCA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IocHJvcHMsIG4pOwogICAgICBpZiAocGQpIHsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBuLCBwZCk7CiAgICAgIH0KICAgIH0pOwogIH0gY2F0Y2goeCkgewogIH0KICByZXR1cm4gb2JqOwp9CgovLyBleHBvcnRzCgp3aW5kb3cuSFRNTEVsZW1lbnRFbGVtZW50ID0gSFRNTEVsZW1lbnRFbGVtZW50OwoKfSkoKTsKCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgooZnVuY3Rpb24oKSB7Cgp2YXIgSU1QT1JUX0xJTktfVFlQRSA9ICdpbXBvcnQnOwoKLy8gaGlnaGxhbmRlciBvYmplY3QgZm9yIHBhcnNpbmcgYSBkb2N1bWVudCB0cmVlCgp2YXIgY29tcG9uZW50UGFyc2VyID0gewogIHNlbGVjdG9yczogWwogICAgJ2xpbmtbcmVsPScgKyBJTVBPUlRfTElOS19UWVBFICsgJ10nLAogICAgJ2xpbmtbcmVsPXN0eWxlc2hlZXRdJywKICAgICdzY3JpcHRbc3JjXScsCiAgICAnc2NyaXB0Om5vdChbdHlwZV0pJywKICAgICdzY3JpcHRbdHlwZT0idGV4dC9qYXZhc2NyaXB0Il0nLAogICAgJ3N0eWxlJywKICAgICdlbGVtZW50JwogIF0sCiAgbWFwOiB7CiAgICBsaW5rOiAncGFyc2VMaW5rJywKICAgIHNjcmlwdDogJ3BhcnNlU2NyaXB0JywKICAgIGVsZW1lbnQ6ICdwYXJzZUVsZW1lbnQnLAogICAgc3R5bGU6ICdwYXJzZVN0eWxlJwogIH0sCiAgcGFyc2U6IGZ1bmN0aW9uKGluRG9jdW1lbnQpIHsKICAgIGlmICghaW5Eb2N1bWVudC5fX3BhcnNlZCkgewogICAgICAvLyBvbmx5IHBhcnNlIG9uY2UKICAgICAgaW5Eb2N1bWVudC5fX3BhcnNlZCA9IHRydWU7CiAgICAgIC8vIGFsbCBwYXJzYWJsZSBlbGVtZW50cyBpbiBpbkRvY3VtZW50IChkZXB0aC1maXJzdCBwcmUtb3JkZXIgdHJhdmVyc2FsKQogICAgICB2YXIgZWx0cyA9IGluRG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChjcC5zZWxlY3RvcnMpOwogICAgICAvLyBmb3IgZWFjaCBwYXJzYWJsZSBub2RlIHR5cGUsIGNhbGwgdGhlIG1hcHBlZCBwYXJzaW5nIG1ldGhvZAogICAgICBmb3JFYWNoKGVsdHMsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAvL2NvbnNvbGUubG9nKG1hcFtlLmxvY2FsTmFtZV0gKyAiOiIsIHBhdGgubm9kZVVybChlKSk7CiAgICAgICAgY3BbY3AubWFwW2UubG9jYWxOYW1lXV0oZSk7CiAgICAgIH0pOwogICAgICAvLyB1cGdyYWRlIGFsbCB1cGdyYWRlYWJsZSBzdGF0aWMgZWxlbWVudHMsIGFueXRoaW5nIGR5bmFtaWNhbGx5CiAgICAgIC8vIGNyZWF0ZWQgc2hvdWxkIGJlIGNhdWdodCBieSBvYnNlcnZlcgogICAgICBDdXN0b21FbGVtZW50cy51cGdyYWRlRG9jdW1lbnQoaW5Eb2N1bWVudCk7CiAgICAgIC8vIG9ic2VydmUgZG9jdW1lbnQgZm9yIGRvbSBjaGFuZ2VzCiAgICAgIEN1c3RvbUVsZW1lbnRzLm9ic2VydmVEb2N1bWVudChpbkRvY3VtZW50KTsKICAgIH0KICB9LAogIHBhcnNlTGluazogZnVuY3Rpb24oaW5MaW5rRWx0KSB7CiAgICAvLyBpbXBvcnRzCiAgICBpZiAoaXNEb2N1bWVudExpbmsoaW5MaW5rRWx0KSkgewogICAgICBpZiAoaW5MaW5rRWx0LmNvbnRlbnQpIHsKICAgICAgICBjcC5wYXJzZShpbkxpbmtFbHQuY29udGVudCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoY2FuQWRkVG9NYWluRG91bWVudChpbkxpbmtFbHQpKSB7CiAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoaW5MaW5rRWx0KTsKICAgIH0KICB9LAogIHBhcnNlU2NyaXB0OiBmdW5jdGlvbihpblNjcmlwdEVsdCkgewogICAgaWYgKGNhbkFkZFRvTWFpbkRvdW1lbnQoaW5TY3JpcHRFbHQpKSB7CiAgICAgIC8vIG90aGVyd2lzZSwgZXZhbHVhdGUgbm93CiAgICAgIHZhciBjb2RlID0gaW5TY3JpcHRFbHQuX19yZXNvdXJjZSB8fCBpblNjcmlwdEVsdC50ZXh0Q29udGVudDsKICAgICAgaWYgKGNvZGUpIHsKICAgICAgICBjb2RlICs9ICJcbi8vQCBzb3VyY2VVUkw9IiArIGluU2NyaXB0RWx0Ll9fbm9kZVVybCArICJcbiI7CiAgICAgICAgZXZhbC5jYWxsKHdpbmRvdywgY29kZSk7CiAgICAgIH0KICAgIH0KICB9LAogIHBhcnNlU3R5bGU6IGZ1bmN0aW9uKGluU3R5bGVFbHQpIHsKICAgIGlmIChjYW5BZGRUb01haW5Eb3VtZW50KGluU3R5bGVFbHQpKSB7CiAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoaW5TdHlsZUVsdCk7CiAgICB9CiAgfSwKICBwYXJzZUVsZW1lbnQ6IGZ1bmN0aW9uKGluRWxlbWVudEVsdCkgewogICAgbmV3IEhUTUxFbGVtZW50RWxlbWVudChpbkVsZW1lbnRFbHQpOwogIH0KfTsKCnZhciBjcCA9IGNvbXBvbmVudFBhcnNlcjsKCi8vIG5vZGVzIGNhbiBiZSBtb3ZlZCB0byB0aGUgbWFpbiBkb2N1bWVudAovLyBpZiB0aGV5IGFyZSBub3QgaW4gdGhlIG1haW4gZG9jdW1lbnQsIGFyZSBub3QgY2hpbGRyZW4gb2YgPGVsZW1lbnQ+Ci8vIGFuZCBhcmUgaW4gYSB0cmVlIGF0IHBhcnNlIHRpbWUuCmZ1bmN0aW9uIGNhbkFkZFRvTWFpbkRvdW1lbnQobm9kZSkgewogIHJldHVybiAhaW5NYWluRG9jdW1lbnQobm9kZSkKICAgICYmIG5vZGUucGFyZW50Tm9kZQogICAgJiYgIWlzRWxlbWVudEVsZW1lbnRDaGlsZChub2RlKTsKfQoKZnVuY3Rpb24gaW5NYWluRG9jdW1lbnQoaW5FbHQpIHsKICByZXR1cm4gaW5FbHQub3duZXJEb2N1bWVudCA9PT0gZG9jdW1lbnQgfHwKICAgIC8vIFRPRE8oc2ptaWxlcyk6IFNoYWRvd0RPTVBvbHlmaWxsIGludHJ1c2lvbgogICAgaW5FbHQub3duZXJEb2N1bWVudC5pbXBsID09PSBkb2N1bWVudDsKfQoKZnVuY3Rpb24gaXNEb2N1bWVudExpbmsoaW5FbHQpIHsKICByZXR1cm4gKGluRWx0LmxvY2FsTmFtZSA9PT0gJ2xpbmsnCiAgICAgICYmIGluRWx0LmdldEF0dHJpYnV0ZSgncmVsJykgPT09IElNUE9SVF9MSU5LX1RZUEUpOwp9CgpmdW5jdGlvbiBpc0VsZW1lbnRFbGVtZW50Q2hpbGQoaW5FbHQpIHsKICBpZiAoaW5FbHQucGFyZW50Tm9kZSAmJiBpbkVsdC5wYXJlbnROb2RlLmxvY2FsTmFtZSA9PT0gJ2VsZW1lbnQnKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9Cn0KCnZhciBmb3JFYWNoID0gQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbC5iaW5kKEFycmF5LnByb3RvdHlwZS5mb3JFYWNoKTsKCi8vIGV4cG9ydHMKCkN1c3RvbUVsZW1lbnRzLnBhcnNlciA9IGNvbXBvbmVudFBhcnNlcjsKCn0pKCk7Ci8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCihmdW5jdGlvbigpewoKLy8gYm9vdHN0cmFwIHBhcnNpbmcKCi8vIElFIHNoaW0gZm9yIEN1c3RvbUV2ZW50CmlmICh0eXBlb2Ygd2luZG93LkN1c3RvbUV2ZW50ICE9PSAnZnVuY3Rpb24nKSB7CiAgd2luZG93LkN1c3RvbUV2ZW50ID0gZnVuY3Rpb24oaW5UeXBlKSB7CiAgICAgdmFyIGUgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgnSFRNTEV2ZW50cycpOwogICAgIGUuaW5pdEV2ZW50KGluVHlwZSwgdHJ1ZSwgdHJ1ZSk7CiAgICAgcmV0dXJuIGU7CiAgfTsKfQoKZnVuY3Rpb24gYm9vdHN0cmFwKCkgewogIC8vIGdvIGFzeW5jIHNvIGNhbGwgc3RhY2sgY2FuIHVud2luZAogIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAvLyBwYXJzZSBkb2N1bWVudAogICAgQ3VzdG9tRWxlbWVudHMucGFyc2VyLnBhcnNlKGRvY3VtZW50KTsKICAgIC8vIHNldCBpbnRlcm5hbCBmbGFnCiAgICBDdXN0b21FbGVtZW50cy5yZWFkeSA9IHRydWU7CiAgICBDdXN0b21FbGVtZW50cy5yZWFkeVRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIGlmICh3aW5kb3cuSFRNTEltcG9ydHMpIHsKICAgICAgQ3VzdG9tRWxlbWVudHMuZWxhcHNlZCA9IEN1c3RvbUVsZW1lbnRzLnJlYWR5VGltZSAtIEhUTUxJbXBvcnRzLnJlYWR5VGltZTsKICAgIH0KICAgIC8vIG5vdGlmeSBzeXN0ZW0KICAgIGRvY3VtZW50LmJvZHkuZGlzcGF0Y2hFdmVudCgKICAgICAgbmV3IEN1c3RvbUV2ZW50KCdXZWJDb21wb25lbnRzUmVhZHknLCB7YnViYmxlczogdHJ1ZX0pCiAgICApOwogIH0sIDApOwp9CgovLyBUT0RPKHNqbWlsZXMpOiAnd2luZG93JyBoYXMgbm8gd3JhcHBhYmlsaXR5IHVuZGVyIFNoYWRvd0RPTSBwb2x5ZmlsbCwgc28KLy8gd2UgYXJlIGZvcmNlZCB0byBzcGxpdCBpbnRvIHR3byB2ZXJzaW9ucwoKaWYgKHdpbmRvdy5IVE1MSW1wb3J0cykgewogIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0hUTUxJbXBvcnRzTG9hZGVkJywgYm9vdHN0cmFwKTsKfSBlbHNlIHsKICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gJ2NvbXBsZXRlJyB8fCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnaW50ZXJhY3RpdmUnKSB7CiAgICBib29zdHJhcCgpOwogIH0gZWxzZSB7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGJvb3RzdHJhcCk7CiAgfQp9Cgp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KKGZ1bmN0aW9uKCkgewoKLy8gaW5qZWN0IHN0eWxlIHNoZWV0CnZhciBzdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CnN0eWxlLnRleHRDb250ZW50ID0gJ2VsZW1lbnQge2Rpc3BsYXk6IG5vbmU7fSAvKiBpbmplY3RlZCBieSBwbGF0Zm9ybS5qcyAqLyc7CnZhciBoZWFkID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaGVhZCcpOwpoZWFkLmluc2VydEJlZm9yZShzdHlsZSwgaGVhZC5maXJzdENoaWxkKTsKCmlmICh3aW5kb3cuU2hhZG93RE9NUG9seWZpbGwpIHsKCiAgZnVuY3Rpb24gbm9wKCkge307CgogIC8vIGRpc2FibGUgc2hhZG93IGRvbSB3YXRjaGluZwogIEN1c3RvbUVsZW1lbnRzLndhdGNoU2hhZG93ID0gbm9wOwogIEN1c3RvbUVsZW1lbnRzLndhdGNoQWxsU2hhZG93cyA9IG5vcDsKCiAgLy8gZW5zdXJlIHdyYXBwZWQgaW5wdXRzIGZvciB0aGVzZSBmdW5jdGlvbnMKICB2YXIgZm5zID0gWyd1cGdyYWRlQWxsJywgJ3VwZ3JhZGVTdWJ0cmVlJywgJ29ic2VydmVEb2N1bWVudCcsCiAgICAgICd1cGdyYWRlRG9jdW1lbnQnXTsKCiAgLy8gY2FjaGUgb3JpZ2luYWxzCiAgdmFyIG9yaWdpbmFsID0ge307CiAgZm5zLmZvckVhY2goZnVuY3Rpb24oZm4pIHsKICAgIG9yaWdpbmFsW2ZuXSA9IEN1c3RvbUVsZW1lbnRzW2ZuXTsKICB9KTsKCiAgLy8gb3ZlcnJpZGUKICBmbnMuZm9yRWFjaChmdW5jdGlvbihmbikgewogICAgQ3VzdG9tRWxlbWVudHNbZm5dID0gZnVuY3Rpb24oaW5Ob2RlKSB7CiAgICAgIHJldHVybiBvcmlnaW5hbFtmbl0od3JhcChpbk5vZGUpKTsKICAgIH07CiAgfSk7Cgp9Cgp9KSgpOwoKKGZ1bmN0aW9uICgpIHsKCi8qKiogVmFyaWFibGVzICoqKi8KCiAgdmFyIHdpbiA9IHdpbmRvdywKICAgIGRvYyA9IGRvY3VtZW50LAogICAgbm9vcCA9IGZ1bmN0aW9uKCl7fSwKICAgIHJlZ2V4UHNldWRvU3BsaXQgPSAvKFtcdy1dKyg/OlwoW15cKV0rXCkpPykvZywKICAgIHJlZ2V4UHNldWRvUmVwbGFjZSA9IC8oXHcqKSg/OlwoKFteXCldKilcKSk/LywKICAgIHJlZ2V4RGlnaXRzID0gLyhcZCspL2csCiAgICBrZXlwc2V1ZG8gPSB7CiAgICAgIGFjdGlvbjogZnVuY3Rpb24gKHBzZXVkbywgZXZlbnQpIHsKICAgICAgICByZXR1cm4gcHNldWRvLnZhbHVlLm1hdGNoKHJlZ2V4RGlnaXRzKS5pbmRleE9mKFN0cmluZyhldmVudC5rZXlDb2RlKSkgPiAtMSA9PSAocHNldWRvLm5hbWUgPT0gJ2tleXBhc3MnKTsKICAgICAgfQogICAgfSwKICAgIHByZWZpeCA9IChmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBzdHlsZXMgPSB3aW4uZ2V0Q29tcHV0ZWRTdHlsZShkb2MuZG9jdW1lbnRFbGVtZW50LCAnJyksCiAgICAgICAgICBwcmUgPSAoQXJyYXkucHJvdG90eXBlLnNsaWNlCiAgICAgICAgICAgIC5jYWxsKHN0eWxlcykKICAgICAgICAgICAgLmpvaW4oJycpCiAgICAgICAgICAgIC5tYXRjaCgvLShtb3p8d2Via2l0fG1zKS0vKSB8fCAoc3R5bGVzLk9MaW5rID09PSAnJyAmJiBbJycsICdvJ10pCiAgICAgICAgICApWzFdOwogICAgICByZXR1cm4gewogICAgICAgIGRvbTogcHJlID09ICdtcycgPyBwcmUudG9VcHBlckNhc2UoKSA6IHByZSwKICAgICAgICBsb3dlcmNhc2U6IHByZSwKICAgICAgICBjc3M6ICctJyArIHByZSArICctJywKICAgICAgICBqczogcHJlWzBdLnRvVXBwZXJDYXNlKCkgKyBwcmUuc3Vic3RyKDEpCiAgICAgIH07CgogICAgfSkoKSwKICAgIG1hdGNoU2VsZWN0b3IgPSBFbGVtZW50LnByb3RvdHlwZS5tYXRjaGVzU2VsZWN0b3IgfHwgRWxlbWVudC5wcm90b3R5cGVbcHJlZml4Lmxvd2VyY2FzZSArICdNYXRjaGVzU2VsZWN0b3InXTsKCi8qKiogRnVuY3Rpb25zICoqKi8KCi8vIFV0aWxpdGllcwoKICB2YXIgdHlwZU9iaiA9IHt9OwogIGZ1bmN0aW9uIHR5cGVPZihvYmopIHsKICAgIHJldHVybiB0eXBlT2JqLnRvU3RyaW5nLmNhbGwob2JqKS5tYXRjaCgvXHMoW2EtekEtWl0rKS8pWzFdLnRvTG93ZXJDYXNlKCk7CiAgfQoKICBmdW5jdGlvbiBjbG9uZShpdGVtLCB0eXBlKXsKICAgIHZhciBmbiA9IGNsb25lW3R5cGUgfHwgdHlwZU9mKGl0ZW0pXTsKICAgIHJldHVybiBmbiA/IGZuKGl0ZW0pIDogaXRlbTsKICB9CiAgICBjbG9uZS5vYmplY3QgPSBmdW5jdGlvbihzcmMpewogICAgICB2YXIgb2JqID0ge307CiAgICAgIGZvciAodmFyIGtleSBpbiBzcmMpIG9ialtrZXldID0gY2xvbmUoc3JjW2tleV0pOwogICAgICByZXR1cm4gb2JqOwogICAgfTsKICAgIGNsb25lLmFycmF5ID0gZnVuY3Rpb24oc3JjKXsKICAgICAgdmFyIGkgPSBzcmMubGVuZ3RoLCBhcnJheSA9IG5ldyBBcnJheShpKTsKICAgICAgd2hpbGUgKGktLSkgYXJyYXlbaV0gPSBjbG9uZShzcmNbaV0pOwogICAgICByZXR1cm4gYXJyYXk7CiAgICB9OwoKICB2YXIgdW5zbGljZWFibGUgPSBbJ251bWJlcicsICdib29sZWFuJywgJ3N0cmluZycsICdmdW5jdGlvbiddOwogIGZ1bmN0aW9uIHRvQXJyYXkob2JqKXsKICAgIHJldHVybiB1bnNsaWNlYWJsZS5pbmRleE9mKHR5cGVPZihvYmopKSA9PSAtMSA/CiAgICBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChvYmosIDApIDoKICAgIFtvYmpdOwogIH0KCi8vIERPTQogIHZhciBzdHIgPSAnJzsKICBmdW5jdGlvbiBxdWVyeShlbGVtZW50LCBzZWxlY3Rvcil7CiAgICByZXR1cm4gKHNlbGVjdG9yIHx8IHN0cikubGVuZ3RoID8gdG9BcnJheShlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpKSA6IFtdOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VNdXRhdGlvbnMoZWxlbWVudCwgbXV0YXRpb25zKSB7CiAgICB2YXIgZGlmZiA9IHsgYWRkZWQ6IFtdLCByZW1vdmVkOiBbXSB9OwogICAgbXV0YXRpb25zLmZvckVhY2goZnVuY3Rpb24ocmVjb3JkKXsKICAgICAgcmVjb3JkLl9tdXRhdGlvbiA9IHRydWU7CiAgICAgIGZvciAodmFyIHogaW4gZGlmZikgewogICAgICAgIHZhciB0eXBlID0gZWxlbWVudC5fcmVjb3Jkc1soeiA9PSAnYWRkZWQnKSA/ICdpbnNlcnRlZCcgOiAncmVtb3ZlZCddLAogICAgICAgICAgbm9kZXMgPSByZWNvcmRbeiArICdOb2RlcyddLCBsZW5ndGggPSBub2Rlcy5sZW5ndGg7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGggJiYgZGlmZlt6XS5pbmRleE9mKG5vZGVzW2ldKSA9PSAtMTsgaSsrKXsKICAgICAgICAgIGRpZmZbel0ucHVzaChub2Rlc1tpXSk7CiAgICAgICAgICB0eXBlLmZvckVhY2goZnVuY3Rpb24oZm4pewogICAgICAgICAgICBmbihub2Rlc1tpXSwgcmVjb3JkKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQoKLy8gTWl4aW5zCgogIGZ1bmN0aW9uIG1lcmdlT25lKHNvdXJjZSwga2V5LCBjdXJyZW50KXsKICAgIHZhciB0eXBlID0gdHlwZU9mKGN1cnJlbnQpOwogICAgaWYgKHR5cGUgPT0gJ29iamVjdCcgJiYgdHlwZU9mKHNvdXJjZVtrZXldKSA9PSAnb2JqZWN0JykgeHRhZy5tZXJnZShzb3VyY2Vba2V5XSwgY3VycmVudCk7CiAgICBlbHNlIHNvdXJjZVtrZXldID0gY2xvbmUoY3VycmVudCwgdHlwZSk7CiAgICByZXR1cm4gc291cmNlOwogIH0KCiAgZnVuY3Rpb24gbWVyZ2VNaXhpbih0eXBlLCBtaXhpbiwgb3B0aW9uKSB7CiAgICB2YXIgb3JpZ2luYWwgPSB7fTsKICAgIGZvciAodmFyIG8gaW4gb3B0aW9uKSBvcmlnaW5hbFtvLnNwbGl0KCc6JylbMF1dID0gdHJ1ZTsKICAgIGZvciAodmFyIHggaW4gbWl4aW4pIGlmICghb3JpZ2luYWxbeC5zcGxpdCgnOicpWzBdXSkgb3B0aW9uW3hdID0gbWl4aW5beF07CiAgfQoKICBmdW5jdGlvbiBhcHBseU1peGlucyh0YWcpIHsKICAgIHRhZy5taXhpbnMuZm9yRWFjaChmdW5jdGlvbiAobmFtZSkgewogICAgICB2YXIgbWl4aW4gPSB4dGFnLm1peGluc1tuYW1lXTsKICAgICAgZm9yICh2YXIgdHlwZSBpbiBtaXhpbikgewogICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgY2FzZSAnbGlmZWN5Y2xlJzogY2FzZSAnbWV0aG9kcyc6CiAgICAgICAgICAgIG1lcmdlTWl4aW4odHlwZSwgbWl4aW5bdHlwZV0sIHRhZ1t0eXBlXSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAnYWNjZXNzb3JzJzogY2FzZSAncHJvdG90eXBlJzoKICAgICAgICAgICAgZm9yICh2YXIgeiBpbiBtaXhpblt0eXBlXSkgbWVyZ2VNaXhpbih6LCBtaXhpblt0eXBlXSwgdGFnLmFjY2Vzc29ycyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAnZXZlbnRzJzoKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHJldHVybiB0YWc7CiAgfQoKLy8gRXZlbnRzCgogIGZ1bmN0aW9uIHRvdWNoRmlsdGVyKGN1c3RvbSwgZXZlbnQpIHsKICAgIGlmIChjdXN0b20ubGlzdGVuZXIudG91Y2hlZCkgcmV0dXJuIGN1c3RvbS5saXN0ZW5lci50b3VjaGVkID0gZmFsc2U7CiAgICBlbHNlIHsKICAgICAgaWYgKGV2ZW50LnR5cGUubWF0Y2goJ3RvdWNoJykpIGN1c3RvbS5saXN0ZW5lci50b3VjaGVkID0gdHJ1ZTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUZsb3dFdmVudCh0eXBlKSB7CiAgICB2YXIgZmxvdyA9IHR5cGUgPT0gJ292ZXInOwogICAgcmV0dXJuIHsKICAgICAgYmFzZTogJ092ZXJmbG93RXZlbnQnIGluIHdpbiA/ICdvdmVyZmxvd2NoYW5nZWQnIDogdHlwZSArICdmbG93JywKICAgICAgY29uZGl0aW9uOiBmdW5jdGlvbiAoY3VzdG9tLCBldmVudCkgewogICAgICAgIGV2ZW50LmZsb3cgPSB0eXBlOwogICAgICAgIHJldHVybiBldmVudC50eXBlID09ICh0eXBlICsgJ2Zsb3cnKSB8fAogICAgICAgICgoZXZlbnQub3JpZW50ID09PSAwICYmIGV2ZW50Lmhvcml6b250YWxPdmVyZmxvdyA9PSBmbG93KSB8fAogICAgICAgIChldmVudC5vcmllbnQgPT0gMSAmJiBldmVudC52ZXJ0aWNhbE92ZXJmbG93ID09IGZsb3cpIHx8CiAgICAgICAgKGV2ZW50Lm9yaWVudCA9PSAyICYmIGV2ZW50Lmhvcml6b250YWxPdmVyZmxvdyA9PSBmbG93ICYmIGV2ZW50LnZlcnRpY2FsT3ZlcmZsb3cgPT0gZmxvdykpOwogICAgICB9CiAgICB9OwogIH0KCi8vIEFjY2Vzc29ycwoKICBmdW5jdGlvbiBnZXRBcmdzKGF0dHIsIHZhbHVlKXsKICAgIHJldHVybiB7CiAgICAgIHZhbHVlOiBhdHRyLmJvb2xlYW4gPyAnJyA6IHZhbHVlLAogICAgICBtZXRob2Q6IGF0dHIuYm9vbGVhbiAmJiAodmFsdWUgPT09IGZhbHNlIHx8IHZhbHVlID09PSBudWxsKSA/ICdyZW1vdmVBdHRyaWJ1dGUnIDogJ3NldEF0dHJpYnV0ZScKICAgIH07CiAgfQoKICBmdW5jdGlvbiBzZXRBdHRyKGF0dHIsIG5hbWUsIHZhbHVlKXsKICAgIHZhciBhcmdzID0gZ2V0QXJncyhhdHRyLCB2YWx1ZSk7CiAgICB0aGlzW2FyZ3MubWV0aG9kXShuYW1lLCBhcmdzLnZhbHVlKTsKICB9CgogIGZ1bmN0aW9uIHN5bmNBdHRyKGF0dHIsIG5hbWUsIHZhbHVlKXsKICAgIHZhciBhcmdzID0gZ2V0QXJncyhhdHRyLCB2YWx1ZSksCiAgICAgICAgbm9kZXMgPSBhdHRyLnByb3BlcnR5ID8gW3RoaXMueHRhZ1thdHRyLnByb3BlcnR5XV0gOiBhdHRyLnNlbGVjdG9yID8geHRhZy5xdWVyeSh0aGlzLCBhdHRyLnNlbGVjdG9yKSA6IFtdLAogICAgICAgIGluZGV4ID0gbm9kZXMubGVuZ3RoOwogICAgd2hpbGUgKGluZGV4LS0pIG5vZGVzW2luZGV4XVthcmdzLm1ldGhvZF0obmFtZSwgYXJncy52YWx1ZSk7CiAgfQoKICBmdW5jdGlvbiB3cmFwQXR0cih0YWcsIG1ldGhvZCl7CiAgICB2YXIgb3JpZ2luYWwgPSB0YWcucHJvdG90eXBlW21ldGhvZF0gfHwgSFRNTEVsZW1lbnQucHJvdG90eXBlW21ldGhvZF07CiAgICB0YWcucHJvdG90eXBlW21ldGhvZF0gPSB7CiAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICBlbnVtYmVyYWJsZTogdHJ1ZSwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSwgc2tpcCl7CiAgICAgICAgdmFyIGF0dHIgPSB0YWcuYXR0cmlidXRlc1tuYW1lLnRvTG93ZXJDYXNlKCldOwogICAgICAgIG9yaWdpbmFsLmNhbGwodGhpcywgbmFtZSwgYXR0ciAmJiBhdHRyLmJvb2xlYW4gPyAnJyA6IHZhbHVlKTsKICAgICAgICBpZiAoYXR0cikgewogICAgICAgICAgc3luY0F0dHIuY2FsbCh0aGlzLCBhdHRyLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgICBpZiAoIWF0dHIuc2tpcCAmJiAhdGhpcy54dGFnLl9za2lwQXR0cikgewogICAgICAgICAgICBhdHRyLnNldHRlci5jYWxsKHRoaXMsIGF0dHIuYm9vbGVhbiA/IG1ldGhvZCA9PSAnc2V0QXR0cmlidXRlJyA6IHRoaXMuZ2V0QXR0cmlidXRlKG5hbWUpKTsKICAgICAgICAgIH0KICAgICAgICAgIGRlbGV0ZSB0aGlzLnh0YWcuX3NraXBBdHRyOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9CgogIGZ1bmN0aW9uIHVwZGF0ZVRlbXBsYXRlKGVsZW1lbnQsIG5hbWUsIHZhbHVlKXsKICAgIGlmIChlbGVtZW50LnRlbXBsYXRlKXsKICAgICAgZWxlbWVudC54dGFnLnRlbXBsYXRlLnVwZGF0ZUJpbmRpbmdWYWx1ZShlbGVtZW50LCBuYW1lLCB2YWx1ZSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBhdHRhY2hQcm9wZXJ0aWVzKHRhZywgcHJvcCwgeiwgYWNjZXNzb3IsIGF0dHIsIG5hbWUpewogICAgdmFyIGtleSA9IHouc3BsaXQoJzonKSwgdHlwZSA9IGtleVswXTsKICAgIGlmICh0eXBlID09ICdnZXQnKSB7CiAgICAgIGtleVswXSA9IHByb3A7CiAgICAgIHRhZy5wcm90b3R5cGVbcHJvcF0uZ2V0ID0geHRhZy5hcHBseVBzZXVkb3Moa2V5LmpvaW4oJzonKSwgYWNjZXNzb3Jbel0sIHRhZy5wc2V1ZG9zKTsKICAgIH0KICAgIGVsc2UgaWYgKHR5cGUgPT0gJ3NldCcpIHsKICAgICAga2V5WzBdID0gcHJvcDsKICAgICAgaWYgKGF0dHIpIGF0dHIuc2V0dGVyID0gYWNjZXNzb3Jbel07CiAgICAgIHRhZy5wcm90b3R5cGVbcHJvcF0uc2V0ID0geHRhZy5hcHBseVBzZXVkb3Moa2V5LmpvaW4oJzonKSwgYXR0ciA/IGZ1bmN0aW9uKHZhbHVlLCBza2lwKXsKICAgICAgICBzeW5jQXR0ci5jYWxsKHRoaXMsIGF0dHIsIG5hbWUsIHZhbHVlKTsKICAgICAgICBhY2Nlc3Nvclt6XS5jYWxsKHRoaXMsIHZhbHVlKTsKICAgICAgICBpZiAoIXNraXAgJiYgIWF0dHIuc2tpcCkgewogICAgICAgICAgdGhpcy54dGFnLl9za2lwQXR0ciA9IHRydWU7CiAgICAgICAgICBzZXRBdHRyLmNhbGwodGhpcywgYXR0ciwgbmFtZSwgdmFsdWUpOwogICAgICAgIH0KICAgICAgICB1cGRhdGVUZW1wbGF0ZSh0aGlzLCBuYW1lLCB2YWx1ZSk7CgogICAgICB9IDogYWNjZXNzb3Jbel0gPyBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgYWNjZXNzb3Jbel0uY2FsbCh0aGlzLCB2YWx1ZSk7CiAgICAgICAgdXBkYXRlVGVtcGxhdGUodGhpcywgbmFtZSwgdmFsdWUpOwogICAgICB9IDogbnVsbCwgdGFnLnBzZXVkb3MpOwogICAgfQogICAgZWxzZSB0YWcucHJvdG90eXBlW3Byb3BdW3pdID0gYWNjZXNzb3Jbel07CiAgfQoKICBmdW5jdGlvbiBwYXJzZUFjY2Vzc29yKHRhZywgcHJvcCl7CiAgICB0YWcucHJvdG90eXBlW3Byb3BdID0ge307CiAgICB2YXIgYWNjZXNzb3IgPSB0YWcuYWNjZXNzb3JzW3Byb3BdLAogICAgICAgIGF0dHIgPSBhY2Nlc3Nvci5hdHRyaWJ1dGUsCiAgICAgICAgbmFtZSA9IGF0dHIgJiYgYXR0ci5uYW1lID8gYXR0ci5uYW1lLnRvTG93ZXJDYXNlKCkgOiBwcm9wOwoKICAgIGlmIChhdHRyKSB0YWcuYXR0cmlidXRlc1tuYW1lXSA9IGF0dHI7CiAgICBmb3IgKHZhciB6IGluIGFjY2Vzc29yKSBhdHRhY2hQcm9wZXJ0aWVzKHRhZywgcHJvcCwgeiwgYWNjZXNzb3IsIGF0dHIsIG5hbWUpOwoKICAgIGlmIChhdHRyKSB7CiAgICAgIGlmICghdGFnLnByb3RvdHlwZVtwcm9wXS5nZXQpIHsKICAgICAgICB2YXIgbWV0aG9kID0gKGF0dHIuYm9vbGVhbiA/ICdoYXMnIDogJ2dldCcpICsgJ0F0dHJpYnV0ZSc7CiAgICAgICAgdGFnLnByb3RvdHlwZVtwcm9wXS5nZXQgPSBmdW5jdGlvbigpewogICAgICAgICAgcmV0dXJuIHRoaXNbbWV0aG9kXShuYW1lKTsKICAgICAgICB9OwogICAgICB9CiAgICAgIGlmICghdGFnLnByb3RvdHlwZVtwcm9wXS5zZXQpIHRhZy5wcm90b3R5cGVbcHJvcF0uc2V0ID0gZnVuY3Rpb24odmFsdWUpewogICAgICAgIHRoaXMueHRhZy5fc2tpcEF0dHIgPSB0cnVlOwogICAgICAgIHNldEF0dHIuY2FsbCh0aGlzLCBhdHRyLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgdXBkYXRlVGVtcGxhdGUodGhpcywgbmFtZSwgdmFsdWUpOwogICAgICB9OwogICAgfQogIH0KCi8qKiogWC1UYWcgT2JqZWN0IERlZmluaXRpb24gKioqLwoKICB2YXIgeHRhZyA9IHsKICAgIHRhZ3M6IHt9LAogICAgZGVmYXVsdE9wdGlvbnM6IHsKICAgICAgcHNldWRvczogW10sCiAgICAgIG1peGluczogW10sCiAgICAgIGV2ZW50czoge30sCiAgICAgIG1ldGhvZHM6IHt9LAogICAgICBhY2Nlc3NvcnM6IHsKICAgICAgICB0ZW1wbGF0ZTogewogICAgICAgICAgYXR0cmlidXRlOiB7fSwKICAgICAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpewogICAgICAgICAgICB2YXIgbGFzdCA9IHRoaXMuZ2V0QXR0cmlidXRlKCd0ZW1wbGF0ZScpOwogICAgICAgICAgICB0aGlzLnh0YWcuX19wcmV2aW91c1RlbXBsYXRlX18gPSBsYXN0OwogICAgICAgICAgICB4dGFnLmZpcmVFdmVudCh0aGlzLCAndGVtcGxhdGVjaGFuZ2UnLCB7IHRlbXBsYXRlOiB2YWx1ZSB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGxpZmVjeWNsZToge30sCiAgICAgIGF0dHJpYnV0ZXM6IHt9LAogICAgICAncHJvdG90eXBlJzogewogICAgICAgIHh0YWc6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX194dGFnX18gPyB0aGlzLl9feHRhZ19fIDogKHRoaXMuX194dGFnX18gPSB7IGRhdGE6IHt9IH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIHJlZ2lzdGVyOiBmdW5jdGlvbiAobmFtZSwgb3B0aW9ucykgewogICAgICB2YXIgZWxlbWVudCwgX25hbWU7CiAgICAgIGlmICh0eXBlb2YgbmFtZSA9PSAnc3RyaW5nJykgewogICAgICAgIF9uYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICB9IGVsc2UgaWYgKG5hbWUubm9kZU5hbWUgPT0gJ0VMRU1FTlQnKSB7CiAgICAgICAgZWxlbWVudCA9IG5hbWU7CiAgICAgICAgX25hbWUgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgnbmFtZScpLnRvTG93ZXJDYXNlKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgdGFnID0geHRhZy50YWdzW19uYW1lXSA9IGFwcGx5TWl4aW5zKHh0YWcubWVyZ2Uoe30sIHh0YWcuZGVmYXVsdE9wdGlvbnMsIG9wdGlvbnMpKTsKCiAgICAgIGZvciAodmFyIHogaW4gdGFnLmV2ZW50cykgdGFnLmV2ZW50c1t6XSA9IHh0YWcucGFyc2VFdmVudCh6LCB0YWcuZXZlbnRzW3pdKTsKICAgICAgZm9yICh6IGluIHRhZy5saWZlY3ljbGUpIHRhZy5saWZlY3ljbGVbei5zcGxpdCgnOicpWzBdXSA9IHh0YWcuYXBwbHlQc2V1ZG9zKHosIHRhZy5saWZlY3ljbGVbel0sIHRhZy5wc2V1ZG9zKTsKICAgICAgZm9yICh6IGluIHRhZy5tZXRob2RzKSB0YWcucHJvdG90eXBlW3ouc3BsaXQoJzonKVswXV0gPSB7IHZhbHVlOiB4dGFnLmFwcGx5UHNldWRvcyh6LCB0YWcubWV0aG9kc1t6XSwgdGFnLnBzZXVkb3MpLCBlbnVtZXJhYmxlOiB0cnVlIH07CiAgICAgIGZvciAoeiBpbiB0YWcuYWNjZXNzb3JzKSBwYXJzZUFjY2Vzc29yKHRhZywgeik7CgogICAgICB2YXIgcmVhZHkgPSB0YWcubGlmZWN5Y2xlLmNyZWF0ZWQgfHwgdGFnLmxpZmVjeWNsZS5yZWFkeTsKICAgICAgdGFnLnByb3RvdHlwZS5yZWFkeUNhbGxiYWNrID0gewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uKCl7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXM7CiAgICAgICAgICB2YXIgdGVtcGxhdGUgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgndGVtcGxhdGUnKTsKICAgICAgICAgIGlmICh0ZW1wbGF0ZSl7CiAgICAgICAgICAgIHh0YWcuZmlyZUV2ZW50KHRoaXMsICd0ZW1wbGF0ZWNoYW5nZScsIHsgdGVtcGxhdGU6IHRlbXBsYXRlIH0pOwogICAgICAgICAgfQogICAgICAgICAgeHRhZy5hZGRFdmVudHModGhpcywgdGFnLmV2ZW50cyk7CiAgICAgICAgICB0YWcubWl4aW5zLmZvckVhY2goZnVuY3Rpb24obWl4aW4pewogICAgICAgICAgICBpZiAoeHRhZy5taXhpbnNbbWl4aW5dLmV2ZW50cykgeHRhZy5hZGRFdmVudHMoZWxlbWVudCwgeHRhZy5taXhpbnNbbWl4aW5dLmV2ZW50cyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHZhciBvdXRwdXQgPSByZWFkeSA/IHJlYWR5LmFwcGx5KHRoaXMsIHRvQXJyYXkoYXJndW1lbnRzKSkgOiBudWxsOwogICAgICAgICAgZm9yICh2YXIgbmFtZSBpbiB0YWcuYXR0cmlidXRlcykgewogICAgICAgICAgICB2YXIgYXR0ciA9IHRhZy5hdHRyaWJ1dGVzW25hbWVdLAogICAgICAgICAgICAgICAgaGFzQXR0ciA9IHRoaXMuaGFzQXR0cmlidXRlKG5hbWUpLAogICAgICAgICAgICAgICAgdmFsdWUgPSBhdHRyLmJvb2xlYW4gPyBoYXNBdHRyIDogdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSk7CiAgICAgICAgICAgIGlmIChhdHRyLmJvb2xlYW4gfHwgaGFzQXR0cikgewogICAgICAgICAgICAgIHN5bmNBdHRyLmNhbGwodGhpcywgYXR0ciwgbmFtZSwgdmFsdWUpOwogICAgICAgICAgICAgIGlmIChhdHRyLnNldHRlcikgYXR0ci5zZXR0ZXIuY2FsbCh0aGlzLCB2YWx1ZSwgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRhZy5wc2V1ZG9zLmZvckVhY2goZnVuY3Rpb24ob2JqKXsKICAgICAgICAgICAgb2JqLm9uQWRkLmNhbGwoZWxlbWVudCwgb2JqKTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgICAgICB9CiAgICAgIH07CgogICAgICBpZiAodGFnLmxpZmVjeWNsZS5pbnNlcnRlZCkgdGFnLnByb3RvdHlwZS5pbnNlcnRlZENhbGxiYWNrID0geyB2YWx1ZTogdGFnLmxpZmVjeWNsZS5pbnNlcnRlZCwgZW51bWVyYWJsZTogdHJ1ZSB9OwogICAgICBpZiAodGFnLmxpZmVjeWNsZS5yZW1vdmVkKSB0YWcucHJvdG90eXBlLnJlbW92ZWRDYWxsYmFjayA9IHsgdmFsdWU6IHRhZy5saWZlY3ljbGUucmVtb3ZlZCwgZW51bWVyYWJsZTogdHJ1ZSB9OwogICAgICBpZiAodGFnLmxpZmVjeWNsZS5hdHRyaWJ1dGVDaGFuZ2VkKSB0YWcucHJvdG90eXBlLmF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayA9IHsgdmFsdWU6IHRhZy5saWZlY3ljbGUuYXR0cmlidXRlQ2hhbmdlZCwgZW51bWVyYWJsZTogdHJ1ZSB9OwoKICAgICAgd3JhcEF0dHIodGFnLCAnc2V0QXR0cmlidXRlJyk7CiAgICAgIHdyYXBBdHRyKHRhZywgJ3JlbW92ZUF0dHJpYnV0ZScpOwoKICAgICAgaWYgKGVsZW1lbnQpewogICAgICAgIGVsZW1lbnQucmVnaXN0ZXIoewogICAgICAgICAgJ3Byb3RvdHlwZSc6IE9iamVjdC5jcmVhdGUoT2JqZWN0LnByb3RvdHlwZSwgdGFnLnByb3RvdHlwZSkKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZG9jLnJlZ2lzdGVyKF9uYW1lLCB7CiAgICAgICAgICAnZXh0ZW5kcyc6IG9wdGlvbnNbJ2V4dGVuZHMnXSwKICAgICAgICAgICdwcm90b3R5cGUnOiBPYmplY3QuY3JlYXRlKE9iamVjdC5jcmVhdGUoKG9wdGlvbnNbJ2V4dGVuZHMnXSA/CiAgICAgICAgICAgIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQob3B0aW9uc1snZXh0ZW5kcyddKS5jb25zdHJ1Y3RvciA6CiAgICAgICAgICAgIHdpbi5IVE1MRWxlbWVudCkucHJvdG90eXBlLCB0YWcucHJvdG90eXBlKSwgdGFnLnByb3RvdHlwZSkKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKCiAgICAvKiBFeHBvc2VkIFZhcmlhYmxlcyAqLwoKICAgIG1peGluczoge30sCiAgICBwcmVmaXg6IHByZWZpeCwKICAgIHRlbXBsYXRlczoge30sCiAgICBjYXB0dXJlRXZlbnRzOiBbJ2ZvY3VzJywgJ2JsdXInXSwKICAgIGN1c3RvbUV2ZW50czogewogICAgICBvdmVyZmxvdzogY3JlYXRlRmxvd0V2ZW50KCdvdmVyJyksCiAgICAgIHVuZGVyZmxvdzogY3JlYXRlRmxvd0V2ZW50KCd1bmRlcicpLAogICAgICBhbmltYXRpb25zdGFydDogewogICAgICAgIGJhc2U6IFsKICAgICAgICAgICdhbmltYXRpb25zdGFydCcsCiAgICAgICAgICAnb0FuaW1hdGlvblN0YXJ0JywKICAgICAgICAgICdNU0FuaW1hdGlvblN0YXJ0JywKICAgICAgICAgICd3ZWJraXRBbmltYXRpb25TdGFydCcKICAgICAgICBdCiAgICAgIH0sCiAgICAgIHRyYW5zaXRpb25lbmQ6IHsKICAgICAgICBiYXNlOiBbCiAgICAgICAgICAndHJhbnNpdGlvbmVuZCcsCiAgICAgICAgICAnb1RyYW5zaXRpb25FbmQnLAogICAgICAgICAgJ01TVHJhbnNpdGlvbkVuZCcsCiAgICAgICAgICAnd2Via2l0VHJhbnNpdGlvbkVuZCcKICAgICAgICBdCiAgICAgIH0sCiAgICAgIHRhcDogewogICAgICAgIGJhc2U6IFsnY2xpY2snLCAndG91Y2hlbmQnXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0sCiAgICAgIHRhcHN0YXJ0OiB7CiAgICAgICAgYmFzZTogWydtb3VzZWRvd24nLCAndG91Y2hzdGFydCddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgdGFwZW5kOiB7CiAgICAgICAgYmFzZTogWydtb3VzZXVwJywgJ3RvdWNoZW5kJ10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICB0YXBlbnRlcjogewogICAgICAgIGJhc2U6IFsnbW91c2VvdmVyJywgJ3RvdWNoZW50ZXInXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0sCiAgICAgIHRhcGxlYXZlOiB7CiAgICAgICAgYmFzZTogWydtb3VzZW91dCcsICd0b3VjaGxlYXZlJ10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICB0YXBtb3ZlOiB7CiAgICAgICAgYmFzZTogWydtb3VzZW1vdmUnLCAndG91Y2htb3ZlJ10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9CiAgICB9LAogICAgcHNldWRvczogewogICAgICBrZXlwYXNzOiBrZXlwc2V1ZG8sCiAgICAgIGtleWZhaWw6IGtleXBzZXVkbywKICAgICAgZGVsZWdhdGU6IHsKICAgICAgICBhY3Rpb246IGZ1bmN0aW9uIChwc2V1ZG8sIGV2ZW50KSB7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gcXVlcnkodGhpcywgcHNldWRvLnZhbHVlKS5maWx0ZXIoZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIG5vZGUgPT0gZXZlbnQudGFyZ2V0IHx8IG5vZGUuY29udGFpbnMgPyBub2RlLmNvbnRhaW5zKGV2ZW50LnRhcmdldCkgOiBmYWxzZTsKICAgICAgICAgIH0pWzBdOwogICAgICAgICAgcmV0dXJuIHRhcmdldCA/IHBzZXVkby5saXN0ZW5lciA9IHBzZXVkby5saXN0ZW5lci5iaW5kKHRhcmdldCkgOiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXZlbnRhYmxlOiB7CiAgICAgICAgYWN0aW9uOiBmdW5jdGlvbiAocHNldWRvLCBldmVudCkgewogICAgICAgICAgcmV0dXJuICFldmVudC5kZWZhdWx0UHJldmVudGVkOwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICAvKiBVVElMSVRJRVMgKi8KCiAgICBjbG9uZTogY2xvbmUsCiAgICB0eXBlT2Y6IHR5cGVPZiwKICAgIHRvQXJyYXk6IHRvQXJyYXksCgogICAgd3JhcDogZnVuY3Rpb24gKG9yaWdpbmFsLCBmbikgewogICAgICByZXR1cm4gZnVuY3Rpb24oKXsKICAgICAgICB2YXIgYXJncyA9IHRvQXJyYXkoYXJndW1lbnRzKSwKICAgICAgICAgIHJldHVybmVkID0gb3JpZ2luYWwuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgcmV0dXJuIHJldHVybmVkID09PSBmYWxzZSA/IGZhbHNlIDogZm4uYXBwbHkodGhpcywgdHlwZW9mIHJldHVybmVkICE9ICd1bmRlZmluZWQnID8gdG9BcnJheShyZXR1cm5lZCkgOiBhcmdzKTsKICAgICAgfTsKICAgIH0sCgogICAgbWVyZ2U6IGZ1bmN0aW9uKHNvdXJjZSwgaywgdil7CiAgICAgIGlmICh0eXBlT2YoaykgPT0gJ3N0cmluZycpIHJldHVybiBtZXJnZU9uZShzb3VyY2UsIGssIHYpOwogICAgICBmb3IgKHZhciBpID0gMSwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewogICAgICAgIHZhciBvYmplY3QgPSBhcmd1bWVudHNbaV07CiAgICAgICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgbWVyZ2VPbmUoc291cmNlLCBrZXksIG9iamVjdFtrZXldKTsKICAgICAgfQogICAgICByZXR1cm4gc291cmNlOwogICAgfSwKCiAgICAvKiBET00gKi8KCiAgICBxdWVyeTogcXVlcnksCgogICAgc2tpcFRyYW5zaXRpb246IGZ1bmN0aW9uKGVsZW1lbnQsIGZuLCBiaW5kKXsKICAgICAgdmFyIHByb3AgPSBwcmVmaXguanMgKyAnVHJhbnNpdGlvblByb3BlcnR5JzsKICAgICAgZWxlbWVudC5zdHlsZVtwcm9wXSA9IGVsZW1lbnQuc3R5bGUudHJhbnNpdGlvblByb3BlcnR5ID0gJ25vbmUnOwogICAgICB4dGFnLnJlcXVlc3RGcmFtZShmdW5jdGlvbigpewogICAgICAgIHZhciBjYWxsYmFjazsKICAgICAgICBpZiAoZm4pIGNhbGxiYWNrID0gZm4uY2FsbChiaW5kKTsKICAgICAgICB4dGFnLnJlcXVlc3RGcmFtZShmdW5jdGlvbigpewogICAgICAgICAgZWxlbWVudC5zdHlsZVtwcm9wXSA9IGVsZW1lbnQuc3R5bGUudHJhbnNpdGlvblByb3BlcnR5ID0gJyc7CiAgICAgICAgICBpZiAoY2FsbGJhY2spIHh0YWcucmVxdWVzdEZyYW1lKGNhbGxiYWNrKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9LAoKICAgIHJlcXVlc3RGcmFtZTogKGZ1bmN0aW9uKCl7CiAgICAgIHZhciByYWYgPSB3aW4ucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgd2luW3ByZWZpeC5sb3dlcmNhc2UgKyAnUmVxdWVzdEFuaW1hdGlvbkZyYW1lJ10gfHwKICAgICAgICBmdW5jdGlvbihmbil7IHJldHVybiB3aW4uc2V0VGltZW91dChmbiwgMjApOyB9OwogICAgICByZXR1cm4gZnVuY3Rpb24oZm4pewogICAgICAgIHJldHVybiByYWYuY2FsbCh3aW4sIGZuKTsKICAgICAgfTsKICAgIH0pKCksCgogICAgbWF0Y2hTZWxlY3RvcjogZnVuY3Rpb24gKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiBtYXRjaFNlbGVjdG9yLmNhbGwoZWxlbWVudCwgc2VsZWN0b3IpOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtZW50LCBtZXRob2QsIHZhbHVlKSB7CiAgICAgIGVsZW1lbnRbbWV0aG9kXSA9IHZhbHVlOwogICAgICBpZiAod2luZG93LkN1c3RvbUVsZW1lbnRzKSBDdXN0b21FbGVtZW50cy51cGdyYWRlQWxsKGVsZW1lbnQpOwogICAgfSwKCiAgICBpbm5lckhUTUw6IGZ1bmN0aW9uKGVsLCBodG1sKXsKICAgICAgeHRhZy5zZXQoZWwsICdpbm5lckhUTUwnLCBodG1sKTsKICAgIH0sCgogICAgaGFzQ2xhc3M6IGZ1bmN0aW9uIChlbGVtZW50LCBrbGFzcykgewogICAgICByZXR1cm4gZWxlbWVudC5jbGFzc05hbWUuc3BsaXQoJyAnKS5pbmRleE9mKGtsYXNzLnRyaW0oKSk+LTE7CiAgICB9LAoKICAgIGFkZENsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwga2xhc3MpIHsKICAgICAgdmFyIGxpc3QgPSBlbGVtZW50LmNsYXNzTmFtZS50cmltKCkuc3BsaXQoJyAnKTsKICAgICAga2xhc3MudHJpbSgpLnNwbGl0KCcgJykuZm9yRWFjaChmdW5jdGlvbiAobmFtZSkgewogICAgICAgIGlmICghfmxpc3QuaW5kZXhPZihuYW1lKSkgbGlzdC5wdXNoKG5hbWUpOwogICAgICB9KTsKICAgICAgZWxlbWVudC5jbGFzc05hbWUgPSBsaXN0LmpvaW4oJyAnKS50cmltKCk7CiAgICAgIHJldHVybiBlbGVtZW50OwogICAgfSwKCiAgICByZW1vdmVDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGtsYXNzKSB7CiAgICAgIHZhciBjbGFzc2VzID0ga2xhc3MudHJpbSgpLnNwbGl0KCcgJyk7CiAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gZWxlbWVudC5jbGFzc05hbWUudHJpbSgpLnNwbGl0KCcgJykuZmlsdGVyKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgcmV0dXJuIG5hbWUgJiYgIX5jbGFzc2VzLmluZGV4T2YobmFtZSk7CiAgICAgIH0pLmpvaW4oJyAnKTsKICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICB9LAoKICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwga2xhc3MpIHsKICAgICAgcmV0dXJuIHh0YWdbeHRhZy5oYXNDbGFzcyhlbGVtZW50LCBrbGFzcykgPyAncmVtb3ZlQ2xhc3MnIDogJ2FkZENsYXNzJ10uY2FsbChudWxsLCBlbGVtZW50LCBrbGFzcyk7CgogICAgfSwKCiAgICBxdWVyeUNoaWxkcmVuOiBmdW5jdGlvbiAoZWxlbWVudCwgc2VsZWN0b3IpIHsKICAgICAgdmFyIGlkID0gZWxlbWVudC5pZCwKICAgICAgICBndWlkID0gZWxlbWVudC5pZCA9IGlkIHx8ICd4XycgKyBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKICAgICAgICBhdHRyID0gJyMnICsgZ3VpZCArICcgPiAnOwogICAgICBzZWxlY3RvciA9IGF0dHIgKyAoc2VsZWN0b3IgKyAnJykucmVwbGFjZSgnLCcsICcsJyArIGF0dHIsICdnJyk7CiAgICAgIHZhciByZXN1bHQgPSBlbGVtZW50LnBhcmVudE5vZGUucXVlcnlTZWxlY3RvckFsbChzZWxlY3Rvcik7CiAgICAgIGlmICghaWQpIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKCdpZCcpOwogICAgICByZXR1cm4gdG9BcnJheShyZXN1bHQpOwogICAgfSwKCiAgICBjcmVhdGVGcmFnbWVudDogZnVuY3Rpb24oY29udGVudCkgewogICAgICB2YXIgZnJhZyA9IGRvYy5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgIGlmIChjb250ZW50KSB7CiAgICAgICAgdmFyIGRpdiA9IGZyYWcuYXBwZW5kQ2hpbGQoZG9jLmNyZWF0ZUVsZW1lbnQoJ2RpdicpKSwKICAgICAgICAgIG5vZGVzID0gdG9BcnJheShjb250ZW50Lm5vZGVOYW1lID8gYXJndW1lbnRzIDogIShkaXYuaW5uZXJIVE1MID0gY29udGVudCkgfHwgZGl2LmNoaWxkcmVuKSwKICAgICAgICAgIGxlbmd0aCA9IG5vZGVzLmxlbmd0aCwKICAgICAgICAgIGluZGV4ID0gMDsKICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIGZyYWcuaW5zZXJ0QmVmb3JlKG5vZGVzW2luZGV4KytdLCBkaXYpOwogICAgICAgIGZyYWcucmVtb3ZlQ2hpbGQoZGl2KTsKICAgICAgfQogICAgICByZXR1cm4gZnJhZzsKICAgIH0sCgogICAgbWFuaXB1bGF0ZTogZnVuY3Rpb24oZWxlbWVudCwgZm4pewogICAgICB2YXIgbmV4dCA9IGVsZW1lbnQubmV4dFNpYmxpbmcsCiAgICAgICAgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlLAogICAgICAgIGZyYWcgPSBkb2MuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAogICAgICAgIHJldHVybmVkID0gZm4uY2FsbChmcmFnLmFwcGVuZENoaWxkKGVsZW1lbnQpLCBmcmFnKSB8fCBlbGVtZW50OwogICAgICBpZiAobmV4dCkgcGFyZW50Lmluc2VydEJlZm9yZShyZXR1cm5lZCwgbmV4dCk7CiAgICAgIGVsc2UgcGFyZW50LmFwcGVuZENoaWxkKHJldHVybmVkKTsKICAgIH0sCgogICAgLyogUFNFVURPUyAqLwoKICAgIGFwcGx5UHNldWRvczogZnVuY3Rpb24oa2V5LCBmbiwgZWxlbWVudCkgewogICAgICB2YXIgbGlzdGVuZXIgPSBmbiwKICAgICAgICAgIHBzZXVkb3MgPSB7fTsKICAgICAgaWYgKGtleS5tYXRjaCgnOicpKSB7CiAgICAgICAgdmFyIHNwbGl0ID0ga2V5Lm1hdGNoKHJlZ2V4UHNldWRvU3BsaXQpLAogICAgICAgICAgICBpID0gc3BsaXQubGVuZ3RoOwogICAgICAgIHdoaWxlICgtLWkpIHsKICAgICAgICAgIHNwbGl0W2ldLnJlcGxhY2UocmVnZXhQc2V1ZG9SZXBsYWNlLCBmdW5jdGlvbiAobWF0Y2gsIG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICgheHRhZy5wc2V1ZG9zW25hbWVdKSB0aHJvdyAicHNldWRvIG5vdCBmb3VuZDogIiArIG5hbWUgKyAiICIgKyBzcGxpdDsKICAgICAgICAgICAgdmFyIHBzZXVkbyA9IHBzZXVkb3NbaV0gPSBPYmplY3QuY3JlYXRlKHh0YWcucHNldWRvc1tuYW1lXSk7CiAgICAgICAgICAgICAgICBwc2V1ZG8ua2V5ID0ga2V5OwogICAgICAgICAgICAgICAgcHNldWRvLm5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgcHNldWRvLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIHZhciBsYXN0ID0gbGlzdGVuZXI7CiAgICAgICAgICAgIGxpc3RlbmVyID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgICB2YXIgYXJncyA9IHRvQXJyYXkoYXJndW1lbnRzKSwKICAgICAgICAgICAgICAgICAgb2JqID0gewogICAgICAgICAgICAgICAgICAgIGtleToga2V5LAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyOiBsYXN0CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgaWYgKHBzZXVkby5hY3Rpb24gJiYgcHNldWRvLmFjdGlvbi5hcHBseSh0aGlzLCBbb2JqXS5jb25jYXQoYXJncykpID09PSBmYWxzZSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIHJldHVybiBvYmoubGlzdGVuZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmIChlbGVtZW50ICYmIHBzZXVkby5vbkFkZCkgewogICAgICAgICAgICAgIGlmIChlbGVtZW50LmdldEF0dHJpYnV0ZSkgewogICAgICAgICAgICAgICAgcHNldWRvLm9uQWRkLmNhbGwoZWxlbWVudCwgcHNldWRvKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZWxlbWVudC5wdXNoKHBzZXVkbyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZm9yICh2YXIgeiBpbiBwc2V1ZG9zKSB7CiAgICAgICAgaWYgKHBzZXVkb3Nbel0ub25Db21waWxlZCkgbGlzdGVuZXIgPSBwc2V1ZG9zW3pdLm9uQ29tcGlsZWQobGlzdGVuZXIsIHBzZXVkb3Nbel0pOwogICAgICB9CiAgICAgIHJldHVybiBsaXN0ZW5lcjsKICAgIH0sCgogICAgcmVtb3ZlUHNldWRvczogZnVuY3Rpb24oZWxlbWVudCwgZXZlbnQpewogICAgICBldmVudC5fcHNldWRvcy5mb3JFYWNoKGZ1bmN0aW9uKG9iail7CiAgICAgICAgb2JqLm9uUmVtb3ZlLmNhbGwoZWxlbWVudCwgb2JqKTsKICAgICAgfSk7CiAgICB9LAoKICAvKioqIEV2ZW50cyAqKiovCgogICAgcGFyc2VFdmVudDogZnVuY3Rpb24odHlwZSwgZm4pIHsKICAgICAgdmFyIHBzZXVkb3MgPSB0eXBlLnNwbGl0KCc6JyksCiAgICAgICAga2V5ID0gcHNldWRvcy5zaGlmdCgpLAogICAgICAgIGV2ZW50ID0geHRhZy5tZXJnZSh7CiAgICAgICAgICBiYXNlOiBrZXksCiAgICAgICAgICBwc2V1ZG9zOiAnJywKICAgICAgICAgIF9wc2V1ZG9zOiBbXSwKICAgICAgICAgIG9uQWRkOiBub29wLAogICAgICAgICAgb25SZW1vdmU6IG5vb3AsCiAgICAgICAgICBjb25kaXRpb246IG5vb3AKICAgICAgICB9LCB4dGFnLmN1c3RvbUV2ZW50c1trZXldIHx8IHt9KTsKICAgICAgZXZlbnQudHlwZSA9IGtleSArIChldmVudC5wc2V1ZG9zLmxlbmd0aCA/ICc6JyArIGV2ZW50LnBzZXVkb3MgOiAnJykgKyAocHNldWRvcy5sZW5ndGggPyAnOicgKyBwc2V1ZG9zLmpvaW4oJzonKSA6ICcnKTsKICAgICAgaWYgKGZuKSB7CiAgICAgICAgdmFyIGNoYWluZWQgPSB4dGFnLmFwcGx5UHNldWRvcyhldmVudC50eXBlLCBmbiwgZXZlbnQuX3BzZXVkb3MpOwogICAgICAgIGV2ZW50Lmxpc3RlbmVyID0gZnVuY3Rpb24oKXsKICAgICAgICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMpOwogICAgICAgICAgaWYgKGV2ZW50LmNvbmRpdGlvbi5hcHBseSh0aGlzLCBbZXZlbnRdLmNvbmNhdChhcmdzKSkgPT09IGZhbHNlKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICByZXR1cm4gY2hhaW5lZC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9OwogICAgICB9CiAgICAgIHJldHVybiBldmVudDsKICAgIH0sCgogICAgYWRkRXZlbnQ6IGZ1bmN0aW9uIChlbGVtZW50LCB0eXBlLCBmbikgewogICAgICB2YXIgZXZlbnQgPSAodHlwZW9mIGZuID09ICdmdW5jdGlvbicpID8geHRhZy5wYXJzZUV2ZW50KHR5cGUsIGZuKSA6IGZuOwogICAgICBldmVudC5saXN0ZW5lci5ldmVudCA9IGV2ZW50OwogICAgICBldmVudC5fcHNldWRvcy5mb3JFYWNoKGZ1bmN0aW9uKG9iail7CiAgICAgICAgb2JqLm9uQWRkLmNhbGwoZWxlbWVudCwgb2JqKTsKICAgICAgfSk7CiAgICAgIGV2ZW50Lm9uQWRkLmNhbGwoZWxlbWVudCwgZXZlbnQsIGV2ZW50Lmxpc3RlbmVyKTsKICAgICAgdG9BcnJheShldmVudC5iYXNlKS5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKG5hbWUsIGV2ZW50Lmxpc3RlbmVyLCB4dGFnLmNhcHR1cmVFdmVudHMuaW5kZXhPZihuYW1lKSA+IC0xKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBldmVudC5saXN0ZW5lcjsKICAgIH0sCgogICAgYWRkRXZlbnRzOiBmdW5jdGlvbiAoZWxlbWVudCwgZXZlbnRzKSB7CiAgICAgIHZhciBsaXN0ZW5lcnMgPSB7fTsKICAgICAgZm9yICh2YXIgeiBpbiBldmVudHMpIHsKICAgICAgICBsaXN0ZW5lcnNbel0gPSB4dGFnLmFkZEV2ZW50KGVsZW1lbnQsIHosIGV2ZW50c1t6XSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGxpc3RlbmVyczsKICAgIH0sCgogICAgcmVtb3ZlRXZlbnQ6IGZ1bmN0aW9uIChlbGVtZW50LCB0eXBlLCBmbikgewogICAgICB2YXIgZXZlbnQgPSBmbi5ldmVudDsKICAgICAgZXZlbnQub25SZW1vdmUuY2FsbChlbGVtZW50LCBldmVudCwgZm4pOwogICAgICB4dGFnLnJlbW92ZVBzZXVkb3MoZWxlbWVudCwgZXZlbnQpOwogICAgICB0b0FycmF5KGV2ZW50LmJhc2UpLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIobmFtZSwgZm4pOwogICAgICB9KTsKICAgIH0sCgogICAgcmVtb3ZlRXZlbnRzOiBmdW5jdGlvbihlbGVtZW50LCBsaXN0ZW5lcnMpewogICAgICBmb3IgKHZhciB6IGluIGxpc3RlbmVycykgeHRhZy5yZW1vdmVFdmVudChlbGVtZW50LCB6LCBsaXN0ZW5lcnNbel0pOwogICAgfSwKCiAgICBmaXJlRXZlbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGRhdGEsIG9wdGlvbnMpewogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgdmFyIGV2ZW50ID0gZG9jLmNyZWF0ZUV2ZW50KCdFdmVudCcpOwogICAgICBldmVudC5pbml0RXZlbnQodHlwZSwgJ2J1YmJsZXMnIGluIG9wdGlvbnMgPyBvcHRpb25zLmJ1YmJsZXMgOiB0cnVlLCAnY2FuY2VsYWJsZScgaW4gb3B0aW9ucyA/IG9wdGlvbnMuY2FuY2VsYWJsZSA6IHRydWUpOwogICAgICBmb3IgKHZhciB6IGluIGRhdGEpIGV2ZW50W3pdID0gZGF0YVt6XTsKICAgICAgZWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgIH0sCgogICAgYWRkT2JzZXJ2ZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKXsKICAgICAgaWYgKCFlbGVtZW50Ll9yZWNvcmRzKSB7CiAgICAgICAgZWxlbWVudC5fcmVjb3JkcyA9IHsgaW5zZXJ0ZWQ6IFtdLCByZW1vdmVkOiBbXSB9OwogICAgICAgIGlmIChtdXRhdGlvbil7CiAgICAgICAgICBlbGVtZW50Ll9vYnNlcnZlciA9IG5ldyBtdXRhdGlvbihmdW5jdGlvbihtdXRhdGlvbnMpIHsKICAgICAgICAgICAgcGFyc2VNdXRhdGlvbnMoZWxlbWVudCwgbXV0YXRpb25zKTsKICAgICAgICAgIH0pOwogICAgICAgICAgZWxlbWVudC5fb2JzZXJ2ZXIub2JzZXJ2ZShlbGVtZW50LCB7CiAgICAgICAgICAgIHN1YnRyZWU6IHRydWUsCiAgICAgICAgICAgIGNoaWxkTGlzdDogdHJ1ZSwKICAgICAgICAgICAgYXR0cmlidXRlczogIXRydWUsCiAgICAgICAgICAgIGNoYXJhY3RlckRhdGE6IGZhbHNlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBbJ0luc2VydGVkJywgJ1JlbW92ZWQnXS5mb3JFYWNoKGZ1bmN0aW9uKHR5cGUpewogICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Ob2RlJyArIHR5cGUsIGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgICAgICAgZXZlbnQuX211dGF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZWxlbWVudC5fcmVjb3Jkc1t0eXBlLnRvTG93ZXJDYXNlKCldLmZvckVhY2goZnVuY3Rpb24oZm4pewogICAgICAgICAgICAgIGZuKGV2ZW50LnRhcmdldCwgZXZlbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sIGZhbHNlKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoZWxlbWVudC5fcmVjb3Jkc1t0eXBlXS5pbmRleE9mKGZuKSA9PSAtMSkgZWxlbWVudC5fcmVjb3Jkc1t0eXBlXS5wdXNoKGZuKTsKICAgIH0sCgogICAgcmVtb3ZlT2JzZXJ2ZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKXsKICAgICAgdmFyIG9iaiA9IGVsZW1lbnQuX3JlY29yZHM7CiAgICAgIGlmIChvYmogJiYgZm4pewogICAgICAgIG9ialt0eXBlXS5zcGxpY2Uob2JqW3R5cGVdLmluZGV4T2YoZm4pLCAxKTsKICAgICAgfQogICAgICBlbHNlewogICAgICAgIG9ialt0eXBlXSA9IFtdOwogICAgICB9CiAgICB9CgogIH07CgogIGlmICh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgZGVmaW5lKHh0YWcpOwogIGVsc2Ugd2luLnh0YWcgPSB4dGFnOwoKICBkb2MuYWRkRXZlbnRMaXN0ZW5lcignV2ViQ29tcG9uZW50c1JlYWR5JywgZnVuY3Rpb24oKXsKICAgIHh0YWcuZmlyZUV2ZW50KGRvYy5ib2R5LCAnRE9NQ29tcG9uZW50c0xvYWRlZCcpOwogIH0pOwoKfSkoKTs=",
                "body": "Ly8gV2UgZG9uJ3QgdXNlIHRoZSBwbGF0Zm9ybSBib290c3RyYXBwZXIsIHNvIGZha2UgdGhpcyBzdHVmZi4KCndpbmRvdy5QbGF0Zm9ybSA9IHt9Owp2YXIgbG9nRmxhZ3MgPSB7fTsKLyoKICogQ29weXJpZ2h0IDIwMTIgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJlbmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgovLyBTaWRlVGFibGUgaXMgYSB3ZWFrIG1hcCB3aGVyZSBwb3NzaWJsZS4gSWYgV2Vha01hcCBpcyBub3QgYXZhaWxhYmxlIHRoZQovLyBhc3NvY2lhdGlvbiBpcyBzdG9yZWQgYXMgYW4gZXhwYW5kbyBwcm9wZXJ0eS4KdmFyIFNpZGVUYWJsZTsKLy8gVE9ETyhhcnYpOiBXZWFrTWFwIGRvZXMgbm90IGFsbG93IGZvciBOb2RlIGV0YyB0byBiZSBrZXlzIGluIEZpcmVmb3gKaWYgKHR5cGVvZiBXZWFrTWFwICE9PSAndW5kZWZpbmVkJyAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoJ0ZpcmVmb3gvJykgPCAwKSB7CiAgU2lkZVRhYmxlID0gV2Vha01hcDsKfSBlbHNlIHsKICAoZnVuY3Rpb24oKSB7CiAgICB2YXIgZGVmaW5lUHJvcGVydHkgPSBPYmplY3QuZGVmaW5lUHJvcGVydHk7CiAgICB2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QuaGFzT3duUHJvcGVydHk7CiAgICB2YXIgY291bnRlciA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpICUgMWU5OwoKICAgIFNpZGVUYWJsZSA9IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLm5hbWUgPSAnX19zdCcgKyAoTWF0aC5yYW5kb20oKSAqIDFlOSA+Pj4gMCkgKyAoY291bnRlcisrICsgJ19fJyk7CiAgICB9OwoKICAgIFNpZGVUYWJsZS5wcm90b3R5cGUgPSB7CiAgICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgIGRlZmluZVByb3BlcnR5KGtleSwgdGhpcy5uYW1lLCB7dmFsdWU6IHZhbHVlLCB3cml0YWJsZTogdHJ1ZX0pOwogICAgICB9LAogICAgICBnZXQ6IGZ1bmN0aW9uKGtleSkgewogICAgICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKGtleSwgdGhpcy5uYW1lKSA/IGtleVt0aGlzLm5hbWVdIDogdW5kZWZpbmVkOwogICAgICB9LAogICAgICBkZWxldGU6IGZ1bmN0aW9uKGtleSkgewogICAgICAgIHRoaXMuc2V0KGtleSwgdW5kZWZpbmVkKTsKICAgICAgfQogICAgfQogIH0pKCk7Cn0KCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCihmdW5jdGlvbigpIHsKCiAgLy8gcG9vciBtYW4ncyBhZGFwdGVyIGZvciB0ZW1wbGF0ZS5jb250ZW50IG9uIHZhcmlvdXMgcGxhdGZvcm0gc2NlbmFyaW9zCiAgd2luZG93LnRlbXBsYXRlQ29udGVudCA9IHdpbmRvdy50ZW1wbGF0ZUNvbnRlbnQgfHwgZnVuY3Rpb24oaW5UZW1wbGF0ZSkgewogICAgcmV0dXJuIGluVGVtcGxhdGUuY29udGVudDsKICB9OwoKICAvLyBzbyB3ZSBjYW4gY2FsbCB3cmFwL3Vud3JhcCB3aXRob3V0IHRlc3RpbmcgZm9yIFNoYWRvd0RPTVBvbHlmaWxsCgogIHdpbmRvdy53cmFwID0gd2luZG93LnVud3JhcCA9IGZ1bmN0aW9uKG4pewogICAgcmV0dXJuIG47CiAgfQoKICB3aW5kb3cuY3JlYXRlU2hhZG93Um9vdCA9IGZ1bmN0aW9uKGluRWxlbWVudCkgewogICAgcmV0dXJuIGluRWxlbWVudC53ZWJraXRDcmVhdGVTaGFkb3dSb290KCk7CiAgfTsKCiAgd2luZG93LnRlbXBsYXRlQ29udGVudCA9IGZ1bmN0aW9uKGluVGVtcGxhdGUpIHsKICAgIC8vIGlmIE1EViBleGlzdHMsIGl0IG1heSBuZWVkIHRvIGJvb3N0cmFwIHRoaXMgdGVtcGxhdGUgdG8gcmV2ZWFsIGNvbnRlbnQKICAgIGlmICh3aW5kb3cuSFRNTFRlbXBsYXRlRWxlbWVudCAmJiBIVE1MVGVtcGxhdGVFbGVtZW50LmJvb3RzdHJhcCkgewogICAgICBIVE1MVGVtcGxhdGVFbGVtZW50LmJvb3RzdHJhcChpblRlbXBsYXRlKTsKICAgIH0KICAgIC8vIGZhbGxiYWNrIHdoZW4gdGhlcmUgaXMgbm8gU2hhZG93IERPTSBwb2x5ZmlsbCwgbm8gTURWIHBvbHlmaWxsLCBhbmQgbm8KICAgIC8vIG5hdGl2ZSB0ZW1wbGF0ZSBzdXBwb3J0CiAgICBpZiAoIWluVGVtcGxhdGUuY29udGVudCAmJiAhaW5UZW1wbGF0ZS5fY29udGVudCkgewogICAgICB2YXIgZnJhZyA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgd2hpbGUgKGluVGVtcGxhdGUuZmlyc3RDaGlsZCkgewogICAgICAgIGZyYWcuYXBwZW5kQ2hpbGQoaW5UZW1wbGF0ZS5maXJzdENoaWxkKTsKICAgICAgfQogICAgICBpblRlbXBsYXRlLl9jb250ZW50ID0gZnJhZzsKICAgIH0KICAgIHJldHVybiBpblRlbXBsYXRlLmNvbnRlbnQgfHwgaW5UZW1wbGF0ZS5fY29udGVudDsKICB9OwoKfSkoKTsKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCihmdW5jdGlvbihzY29wZSkgewoKLy8gT2xkIHZlcnNpb25zIG9mIGlPUyBkbyBub3QgaGF2ZSBiaW5kLgoKaWYgKCFGdW5jdGlvbi5wcm90b3R5cGUuYmluZCkgewogIEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kID0gZnVuY3Rpb24oc2NvcGUpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MyID0gYXJncy5zbGljZSgpOwogICAgICBhcmdzMi5wdXNoLmFwcGx5KGFyZ3MyLCBhcmd1bWVudHMpOwogICAgICByZXR1cm4gc2VsZi5hcHBseShzY29wZSwgYXJnczIpOwogICAgfTsKICB9Owp9CgovLyBuYW1lc3BhY2UgYW4gaW1wb3J0IGZyb20gQ3VzdG9tRWxlbWVudHMKLy8gVE9ETyhzam1pbGVzKTogY2xlYW4gdXAgdGhpcyBnbG9iYWwKc2NvcGUubWl4aW4gPSB3aW5kb3cubWl4aW47Cgp9KSh3aW5kb3cuUGxhdGZvcm0pOwovLyBDb3B5cmlnaHQgMjAxMSBHb29nbGUgSW5jLgovLwovLyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKLy8geW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLgovLyBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKLy8KLy8gICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMAovLwovLyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCi8vIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsCi8vIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgovLyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCi8vIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgoKKGZ1bmN0aW9uKHNjb3BlKSB7CgogICd1c2Ugc3RyaWN0JzsKCiAgLy8gcG9seWZpbGwgRE9NVG9rZW5MaXN0CiAgLy8gKiBhZGQvcmVtb3ZlOiBhbGxvdyB0aGVzZSBtZXRob2RzIHRvIHRha2UgbXVsdGlwbGUgY2xhc3NOYW1lcwogIC8vICogdG9nZ2xlOiBhZGQgYSAybmQgYXJndW1lbnQgd2hpY2ggZm9yY2VzIHRoZSBnaXZlbiBzdGF0ZSByYXRoZXIKICAvLyAgdGhhbiB0b2dnbGluZy4KCiAgdmFyIGFkZCA9IERPTVRva2VuTGlzdC5wcm90b3R5cGUuYWRkOwogIHZhciByZW1vdmUgPSBET01Ub2tlbkxpc3QucHJvdG90eXBlLnJlbW92ZTsKICBET01Ub2tlbkxpc3QucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uKCkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgYWRkLmNhbGwodGhpcywgYXJndW1lbnRzW2ldKTsKICAgIH0KICB9OwogIERPTVRva2VuTGlzdC5wcm90b3R5cGUucmVtb3ZlID0gZnVuY3Rpb24oKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICByZW1vdmUuY2FsbCh0aGlzLCBhcmd1bWVudHNbaV0pOwogICAgfQogIH07CiAgRE9NVG9rZW5MaXN0LnByb3RvdHlwZS50b2dnbGUgPSBmdW5jdGlvbihuYW1lLCBib29sKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CiAgICAgIGJvb2wgPSAhdGhpcy5jb250YWlucyhuYW1lKTsKICAgIH0KICAgIGJvb2wgPyB0aGlzLmFkZChuYW1lKSA6IHRoaXMucmVtb3ZlKG5hbWUpOwogIH07CiAgRE9NVG9rZW5MaXN0LnByb3RvdHlwZS5zd2l0Y2ggPSBmdW5jdGlvbihvbGROYW1lLCBuZXdOYW1lKSB7CiAgICBvbGROYW1lICYmIHRoaXMucmVtb3ZlKG9sZE5hbWUpOwogICAgbmV3TmFtZSAmJiB0aGlzLmFkZChuZXdOYW1lKTsKICB9OwoKICAvLyBtYWtlIGZvckVhY2ggd29yayBvbiBOb2RlTGlzdAoKICBOb2RlTGlzdC5wcm90b3R5cGUuZm9yRWFjaCA9IGZ1bmN0aW9uKGNiLCBjb250ZXh0KSB7CiAgICBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCh0aGlzKS5mb3JFYWNoKGNiLCBjb250ZXh0KTsKICB9OwoKICBIVE1MQ29sbGVjdGlvbi5wcm90b3R5cGUuZm9yRWFjaCA9IGZ1bmN0aW9uKGNiLCBjb250ZXh0KSB7CiAgICBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCh0aGlzKS5mb3JFYWNoKGNiLCBjb250ZXh0KTsKICB9OwoKICAvLyBwb2x5ZmlsbCBwZXJmb3JtYW5jZS5ub3cKCiAgaWYgKCF3aW5kb3cucGVyZm9ybWFuY2UpIHsKICAgIHZhciBzdGFydCA9IERhdGUubm93KCk7CiAgICAvLyBvbmx5IGF0IG1pbGxpc2Vjb25kIHByZWNpc2lvbgogICAgd2luZG93LnBlcmZvcm1hbmNlID0ge25vdzogZnVuY3Rpb24oKXsgcmV0dXJuIERhdGUubm93KCkgLSBzdGFydCB9fTsKICB9CgogIC8vIHBvbHlmaWxsIGZvciByZXF1ZXN0QW5pbWF0aW9uRnJhbWUKCiAgaWYgKCF3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKSB7CiAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gKGZ1bmN0aW9uKCkgewogICAgICB2YXIgbmF0aXZlUmFmID0gd2luZG93LndlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgIHdpbmRvdy5tb3pSZXF1ZXN0QW5pbWF0aW9uRnJhbWU7CgogICAgICByZXR1cm4gbmF0aXZlUmFmID8KICAgICAgICBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgcmV0dXJuIG5hdGl2ZVJhZihmdW5jdGlvbigpIHsKICAgICAgICAgICAgY2FsbGJhY2socGVyZm9ybWFuY2Uubm93KCkpOwogICAgICAgICAgfSk7CiAgICAgICAgfSA6CiAgICAgICAgZnVuY3Rpb24oIGNhbGxiYWNrICl7CiAgICAgICAgICByZXR1cm4gd2luZG93LnNldFRpbWVvdXQoY2FsbGJhY2ssIDEwMDAgLyA2MCk7CiAgICAgICAgfTsKICAgIH0pKCk7CiAgfQoKICBpZiAoIXdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSkgewogICAgd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lID0gKGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gIHdpbmRvdy53ZWJraXRDYW5jZWxBbmltYXRpb25GcmFtZSB8fAogICAgICAgIHdpbmRvdy5tb3pDYW5jZWxBbmltYXRpb25GcmFtZSB8fAogICAgICAgIGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQoaWQpOwogICAgICAgIH07CiAgICB9KSgpOwogIH0KCiAgLy8gdXRpbGl0eQoKICBmdW5jdGlvbiBjcmVhdGVET00oaW5UYWdPck5vZGUsIGluSFRNTCwgaW5BdHRycykgewogICAgdmFyIGRvbSA9IHR5cGVvZiBpblRhZ09yTm9kZSA9PSAnc3RyaW5nJyA/CiAgICAgICAgZG9jdW1lbnQuY3JlYXRlRWxlbWVudChpblRhZ09yTm9kZSkgOiBpblRhZ09yTm9kZS5jbG9uZU5vZGUodHJ1ZSk7CiAgICBkb20uaW5uZXJIVE1MID0gaW5IVE1MOwogICAgaWYgKGluQXR0cnMpIHsKICAgICAgZm9yICh2YXIgbiBpbiBpbkF0dHJzKSB7CiAgICAgICAgZG9tLnNldEF0dHJpYnV0ZShuLCBpbkF0dHJzW25dKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGRvbTsKICB9CgogIC8vIGV4cG9ydHMKCiAgc2NvcGUuY3JlYXRlRE9NID0gY3JlYXRlRE9NOwoKfSkod2luZG93LlBsYXRmb3JtKTsKCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgovLyBwb29yIG1hbidzIGFkYXB0ZXIgZm9yIHRlbXBsYXRlLmNvbnRlbnQgb24gdmFyaW91cyBwbGF0Zm9ybSBzY2VuYXJpb3MKd2luZG93LnRlbXBsYXRlQ29udGVudCA9IHdpbmRvdy50ZW1wbGF0ZUNvbnRlbnQgfHwgZnVuY3Rpb24oaW5UZW1wbGF0ZSkgewogIHJldHVybiBpblRlbXBsYXRlLmNvbnRlbnQ7Cn07Ci8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgooZnVuY3Rpb24oc2NvcGUpIHsKCmlmICghc2NvcGUpIHsKICBzY29wZSA9IHdpbmRvdy5IVE1MSW1wb3J0cyA9IHtmbGFnczp7fX07Cn0KCnZhciBJTVBPUlRfTElOS19UWVBFID0gJ2ltcG9ydCc7CgovLyBoaWdobGFuZGVyIG9iamVjdCByZXByZXNlbnRzIGEgcHJpbWFyeSBkb2N1bWVudCAodGhlIGFyZ3VtZW50IHRvICdwYXJzZScpCi8vIGF0IHRoZSByb290IG9mIGEgdHJlZSBvZiBkb2N1bWVudHMKCnZhciBpbXBvcnRlciA9IHsKICBkb2N1bWVudHM6IHt9LAogIGNhY2hlOiB7fSwKICBwcmVsb2FkU2VsZWN0b3JzOiBbCiAgICAnbGlua1tyZWw9JyArIElNUE9SVF9MSU5LX1RZUEUgKyAnXScsCiAgICAnc2NyaXB0W3NyY10nLAogICAgJ2xpbmtbcmVsPXN0eWxlc2hlZXRdJwogIF0uam9pbignLCcpLAogIGxvYWQ6IGZ1bmN0aW9uKGluRG9jdW1lbnQsIGluTmV4dCkgewogICAgLy8gY29uc3RydWN0IGEgbG9hZGVyIGluc3RhbmNlCiAgICBsb2FkZXIgPSBuZXcgTG9hZGVyKGltcG9ydGVyLmxvYWRlZCwgaW5OZXh0KTsKICAgIC8vIGFsaWFzIHRoZSBsb2FkZXIgY2FjaGUgKGZvciBkZWJ1Z2dpbmcpCiAgICBsb2FkZXIuY2FjaGUgPSBpbXBvcnRlci5jYWNoZTsKICAgIC8vIGFkZCBub2RlcyBmcm9tIGRvY3VtZW50IGludG8gbG9hZGVyIHF1ZXVlCiAgICBpbXBvcnRlci5wcmVsb2FkKGluRG9jdW1lbnQpOwogIH0sCiAgcHJlbG9hZDogZnVuY3Rpb24oaW5Eb2N1bWVudCkgewogICAgLy8gYWxsIHByZWxvYWRhYmxlIG5vZGVzIGluIGluRG9jdW1lbnQKICAgIHZhciBub2RlcyA9IGluRG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChpbXBvcnRlci5wcmVsb2FkU2VsZWN0b3JzKTsKICAgIC8vIG9ubHkgbG9hZCBpbXBvcnRzIGZyb20gdGhlIG1haW4gZG9jdW1lbnQKICAgIC8vIFRPRE8oc2ptaWxlcyk6IGRvIHRoaXMgYnkgYWx0ZXJpbmcgdGhlIHNlbGVjdG9yIGxpc3QgaW5zdGVhZAogICAgaWYgKGluRG9jdW1lbnQgPT09IGRvY3VtZW50KSB7CiAgICAgIG5vZGVzID0gQXJyYXkucHJvdG90eXBlLmZpbHRlci5jYWxsKG5vZGVzLCBmdW5jdGlvbihuKSB7CiAgICAgICAgcmV0dXJuIGlzRG9jdW1lbnRMaW5rKG4pOwogICAgICB9KTsKICAgIH0KICAgIC8vIGFkZCB0aGVzZSBub2RlcyB0byBsb2FkZXIncyBxdWV1ZQogICAgbG9hZGVyLmFkZE5vZGVzKG5vZGVzKTsKICB9LAogIGxvYWRlZDogZnVuY3Rpb24oaW5VcmwsIGluRWx0LCBpblJlc291cmNlKSB7CiAgICBpZiAoaXNEb2N1bWVudExpbmsoaW5FbHQpKSB7CiAgICAgIHZhciBkb2N1bWVudCA9IGltcG9ydGVyLmRvY3VtZW50c1tpblVybF07CiAgICAgIC8vIGlmIHdlJ3ZlIG5ldmVyIHNlZW4gYSBkb2N1bWVudCBhdCB0aGlzIHVybAogICAgICBpZiAoIWRvY3VtZW50KSB7CiAgICAgICAgLy8gZ2VuZXJhdGUgYW4gSFRNTERvY3VtZW50IGZyb20gZGF0YQogICAgICAgIGRvY3VtZW50ID0gbWFrZURvY3VtZW50KGluUmVzb3VyY2UsIGluVXJsKTsKICAgICAgICAvLyByZXNvbHZlIHJlc291cmNlIHBhdGhzIHJlbGF0aXZlIHRvIGhvc3QgZG9jdW1lbnQKICAgICAgICBwYXRoLnJlc29sdmVQYXRoc0luSFRNTChkb2N1bWVudCk7CiAgICAgICAgLy8gY2FjaGUgZG9jdW1lbnQKICAgICAgICBpbXBvcnRlci5kb2N1bWVudHNbaW5VcmxdID0gZG9jdW1lbnQ7CiAgICAgICAgLy8gYWRkIG5vZGVzIGZyb20gdGhpcyBkb2N1bWVudCB0byB0aGUgbG9hZGVyIHF1ZXVlCiAgICAgICAgaW1wb3J0ZXIucHJlbG9hZChkb2N1bWVudCk7CiAgICAgIH0KICAgICAgLy8gc3RvcmUgZG9jdW1lbnQgcmVzb3VyY2UKICAgICAgaW5FbHQuY29udGVudCA9IGluRWx0Ll9fcmVzb3VyY2UgPSBkb2N1bWVudDsKICAgIH0gZWxzZSB7CiAgICAgIGluRWx0Ll9fcmVzb3VyY2UgPSBpblJlc291cmNlOwogICAgICAvLyByZXNvbHZlIHN0eWxlc2hlZXQgcmVzb3VyY2UgcGF0aHMgcmVsYXRpdmUgdG8gaG9zdCBkb2N1bWVudAogICAgICBpZiAoaXNTdHlsZXNoZWV0TGluayhpbkVsdCkpIHsKICAgICAgICBwYXRoLnJlc29sdmVQYXRoc0luU3R5bGVzaGVldChpbkVsdCk7CiAgICAgIH0KICAgIH0KICB9Cn07CgpmdW5jdGlvbiBpc0RvY3VtZW50TGluayhpbkVsdCkgewogIHJldHVybiBpc0xpbmtSZWwoaW5FbHQsIElNUE9SVF9MSU5LX1RZUEUpOwp9CgpmdW5jdGlvbiBpc1N0eWxlc2hlZXRMaW5rKGluRWx0KSB7CiAgcmV0dXJuIGlzTGlua1JlbChpbkVsdCwgJ3N0eWxlc2hlZXQnKTsKfQoKZnVuY3Rpb24gaXNMaW5rUmVsKGluRWx0LCBpblJlbCkgewogIHJldHVybiAoaW5FbHQubG9jYWxOYW1lID09PSAnbGluaycgJiYgaW5FbHQuZ2V0QXR0cmlidXRlKCdyZWwnKSA9PT0gaW5SZWwpOwp9CgpmdW5jdGlvbiBpbk1haW5Eb2N1bWVudChpbkVsdCkgewogIHJldHVybiBpbkVsdC5vd25lckRvY3VtZW50ID09PSBkb2N1bWVudCB8fAogICAgLy8gVE9ETyhzam1pbGVzKTogU2hhZG93RE9NUG9seWZpbGwgaW50cnVzaW9uCiAgICBpbkVsdC5vd25lckRvY3VtZW50LmltcGwgPT09IGRvY3VtZW50Owp9CgpmdW5jdGlvbiBtYWtlRG9jdW1lbnQoaW5IVE1MLCBpblVybCkgewogIC8vIGNyZWF0ZSBhIG5ldyBIVE1MIGRvY3VtZW50CiAgdmFyIGRvYyA9IGRvY3VtZW50LmltcGxlbWVudGF0aW9uLmNyZWF0ZUhUTUxEb2N1bWVudChJTVBPUlRfTElOS19UWVBFKTsKICAvLyBjYWNoZSB0aGUgbmV3IGRvY3VtZW50J3Mgc291cmNlIHVybAogIGRvYy5fVVJMID0gaW5Vcmw7CiAgLy8gZXN0YWJsaXNoIGEgcmVsYXRpdmUgcGF0aCB2aWEgPGJhc2U+CiAgdmFyIGJhc2UgPSBkb2MuY3JlYXRlRWxlbWVudCgnYmFzZScpOwogIGJhc2Uuc2V0QXR0cmlidXRlKCdocmVmJywgZG9jdW1lbnQuYmFzZVVSSSk7CiAgZG9jLmhlYWQuYXBwZW5kQ2hpbGQoYmFzZSk7CiAgLy8gaW5zdGFsbCBodG1sCiAgZG9jLmJvZHkuaW5uZXJIVE1MID0gaW5IVE1MOwogIHJldHVybiBkb2M7Cn0KCnZhciBsb2FkZXI7Cgp2YXIgTG9hZGVyID0gZnVuY3Rpb24oaW5PbkxvYWQsIGluT25Db21wbGV0ZSkgewogIHRoaXMub25sb2FkID0gaW5PbkxvYWQ7CiAgdGhpcy5vbmNvbXBsZXRlID0gaW5PbkNvbXBsZXRlOwogIHRoaXMuaW5mbGlnaHQgPSAwOwogIHRoaXMucGVuZGluZyA9IHt9OwogIHRoaXMuY2FjaGUgPSB7fTsKfTsKCkxvYWRlci5wcm90b3R5cGUgPSB7CiAgYWRkTm9kZXM6IGZ1bmN0aW9uKGluTm9kZXMpIHsKICAgIC8vIG51bWJlciBvZiB0cmFuc2FjdGlvbnMgdG8gY29tcGxldGUKICAgIHRoaXMuaW5mbGlnaHQgKz0gaW5Ob2Rlcy5sZW5ndGg7CiAgICAvLyBjb21tZW5jZSB0cmFuc2FjdGlvbnMKICAgIGZvckVhY2goaW5Ob2RlcywgdGhpcy5yZXF1aXJlLCB0aGlzKTsKICAgIC8vIGFueXRoaW5nIHRvIGRvPwogICAgdGhpcy5jaGVja0RvbmUoKTsKICB9LAogIHJlcXVpcmU6IGZ1bmN0aW9uKGluRWx0KSB7CiAgICB2YXIgdXJsID0gcGF0aC5ub2RlVXJsKGluRWx0KTsKICAgIC8vIFRPRE8oc2ptaWxlcyk6IGFkLWhvYwogICAgaW5FbHQuX19ub2RlVXJsID0gdXJsOwogICAgLy8gZGVkdXBsaWNhdGlvbgogICAgaWYgKCF0aGlzLmRlZHVwZSh1cmwsIGluRWx0KSkgewogICAgICAvLyBmZXRjaCB0aGlzIHJlc291cmNlCiAgICAgIHRoaXMuZmV0Y2godXJsLCBpbkVsdCk7CiAgICB9CiAgfSwKICBkZWR1cGU6IGZ1bmN0aW9uKGluVXJsLCBpbkVsdCkgewogICAgaWYgKHRoaXMucGVuZGluZ1tpblVybF0pIHsKICAgICAgLy8gYWRkIHRvIGxpc3Qgb2Ygbm9kZXMgd2FpdGluZyBmb3IgaW5VcmwKICAgICAgdGhpcy5wZW5kaW5nW2luVXJsXS5wdXNoKGluRWx0KTsKICAgICAgLy8gZG9uJ3QgbmVlZCBmZXRjaAogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGlmICh0aGlzLmNhY2hlW2luVXJsXSkgewogICAgICAvLyBjb21wbGV0ZSBsb2FkIHVzaW5nIGNhY2hlIGRhdGEKICAgICAgdGhpcy5vbmxvYWQoaW5VcmwsIGluRWx0LCBsb2FkZXIuY2FjaGVbaW5VcmxdKTsKICAgICAgLy8gZmluaXNoZWQgdGhpcyB0cmFuc2FjdGlvbgogICAgICB0aGlzLnRhaWwoKTsKICAgICAgLy8gZG9uJ3QgbmVlZCBmZXRjaAogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIC8vIGZpcnN0IG5vZGUgd2FpdGluZyBmb3IgaW5VcmwKICAgIHRoaXMucGVuZGluZ1tpblVybF0gPSBbaW5FbHRdOwogICAgLy8gbmVlZCBmZXRjaCAobm90IGEgZHVwZSkKICAgIHJldHVybiBmYWxzZTsKICB9LAogIGZldGNoOiBmdW5jdGlvbihpblVybCwgaW5FbHQpIHsKICAgIHhoci5sb2FkKGluVXJsLCBmdW5jdGlvbihlcnIsIHJlc291cmNlKSB7CiAgICAgIHRoaXMucmVjZWl2ZShpblVybCwgaW5FbHQsIGVyciwgcmVzb3VyY2UpOwogICAgfS5iaW5kKHRoaXMpKTsKICB9LAogIHJlY2VpdmU6IGZ1bmN0aW9uKGluVXJsLCBpbkVsdCwgaW5FcnIsIGluUmVzb3VyY2UpIHsKICAgIGlmICghaW5FcnIpIHsKICAgICAgbG9hZGVyLmNhY2hlW2luVXJsXSA9IGluUmVzb3VyY2U7CiAgICB9CiAgICBsb2FkZXIucGVuZGluZ1tpblVybF0uZm9yRWFjaChmdW5jdGlvbihlKSB7CiAgICAgIGlmICghaW5FcnIpIHsKICAgICAgICB0aGlzLm9ubG9hZChpblVybCwgZSwgaW5SZXNvdXJjZSk7CiAgICAgIH0KICAgICAgdGhpcy50YWlsKCk7CiAgICB9LCB0aGlzKTsKICAgIGxvYWRlci5wZW5kaW5nW2luVXJsXSA9IG51bGw7CiAgfSwKICB0YWlsOiBmdW5jdGlvbigpIHsKICAgIC0tdGhpcy5pbmZsaWdodDsKICAgIHRoaXMuY2hlY2tEb25lKCk7CiAgfSwKICBjaGVja0RvbmU6IGZ1bmN0aW9uKCkgewogICAgaWYgKCF0aGlzLmluZmxpZ2h0KSB7CiAgICAgIHRoaXMub25jb21wbGV0ZSgpOwogICAgfQogIH0KfTsKCnZhciBwYXRoID0gewogIG5vZGVVcmw6IGZ1bmN0aW9uKGluTm9kZSkgewogICAgcmV0dXJuIHBhdGgucmVzb2x2ZVVybChwYXRoLmdldERvY3VtZW50VXJsKGRvY3VtZW50KSwgcGF0aC5ocmVmT3JTcmMoaW5Ob2RlKSk7CiAgfSwKICBocmVmT3JTcmM6IGZ1bmN0aW9uKGluTm9kZSkgewogICAgcmV0dXJuIGluTm9kZS5nZXRBdHRyaWJ1dGUoImhyZWYiKSB8fCBpbk5vZGUuZ2V0QXR0cmlidXRlKCJzcmMiKTsKICB9LAogIGRvY3VtZW50VXJsRnJvbU5vZGU6IGZ1bmN0aW9uKGluTm9kZSkgewogICAgcmV0dXJuIHBhdGguZ2V0RG9jdW1lbnRVcmwoaW5Ob2RlLm93bmVyRG9jdW1lbnQpOwogIH0sCiAgZ2V0RG9jdW1lbnRVcmw6IGZ1bmN0aW9uKGluRG9jdW1lbnQpIHsKICAgIHZhciB1cmwgPSBpbkRvY3VtZW50ICYmCiAgICAgICAgLy8gVE9ETyhzam1pbGVzKTogU2hhZG93RE9NUG9seWZpbGwgaW50cnVzaW9uCiAgICAgICAgKGluRG9jdW1lbnQuX1VSTCB8fCAoaW5Eb2N1bWVudC5pbXBsICYmIGluRG9jdW1lbnQuaW1wbC5fVVJMKQogICAgICAgICAgICB8fCBpbkRvY3VtZW50LmJhc2VVUkkgfHwgaW5Eb2N1bWVudC5VUkwpCiAgICAgICAgICAgICAgICB8fCAnJzsKICAgIC8vIHRha2Ugb25seSB0aGUgbGVmdCBzaWRlIGlmIHRoZXJlIGlzIGEgIwogICAgcmV0dXJuIHVybC5zcGxpdCgnIycpWzBdOwogIH0sCiAgcmVzb2x2ZVVybDogZnVuY3Rpb24oaW5CYXNlVXJsLCBpblVybCwgaW5SZWxhdGl2ZVRvRG9jdW1lbnQpIHsKICAgIGlmICh0aGlzLmlzQWJzVXJsKGluVXJsKSkgewogICAgICByZXR1cm4gaW5Vcmw7CiAgICB9CiAgICB2YXIgdXJsID0gdGhpcy5jb21wcmVzc1VybCh0aGlzLnVybFRvUGF0aChpbkJhc2VVcmwpICsgaW5VcmwpOwogICAgaWYgKGluUmVsYXRpdmVUb0RvY3VtZW50KSB7CiAgICAgIHVybCA9IHBhdGgubWFrZVJlbFBhdGgocGF0aC5nZXREb2N1bWVudFVybChkb2N1bWVudCksIHVybCk7CiAgICB9CiAgICByZXR1cm4gdXJsOwogIH0sCiAgaXNBYnNVcmw6IGZ1bmN0aW9uKGluVXJsKSB7CiAgICByZXR1cm4gLyheZGF0YTopfCheaHR0cFtzXT86KXwoXlwvKS8udGVzdChpblVybCk7CiAgfSwKICB1cmxUb1BhdGg6IGZ1bmN0aW9uKGluQmFzZVVybCkgewogICAgdmFyIHBhcnRzID0gaW5CYXNlVXJsLnNwbGl0KCIvIik7CiAgICBwYXJ0cy5wb3AoKTsKICAgIHBhcnRzLnB1c2goJycpOwogICAgcmV0dXJuIHBhcnRzLmpvaW4oIi8iKTsKICB9LAogIGNvbXByZXNzVXJsOiBmdW5jdGlvbihpblVybCkgewogICAgdmFyIHBhcnRzID0gaW5Vcmwuc3BsaXQoIi8iKTsKICAgIGZvciAodmFyIGk9MCwgcDsgaTxwYXJ0cy5sZW5ndGg7IGkrKykgewogICAgICBwID0gcGFydHNbaV07CiAgICAgIGlmIChwID09PSAiLi4iKSB7CiAgICAgICAgcGFydHMuc3BsaWNlKGktMSwgMik7CiAgICAgICAgaSAtPSAyOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcGFydHMuam9pbigiLyIpOwogIH0sCiAgLy8gbWFrZSBhIHJlbGF0aXZlIHBhdGggZnJvbSBzb3VyY2UgdG8gdGFyZ2V0CiAgbWFrZVJlbFBhdGg6IGZ1bmN0aW9uKGluU291cmNlLCBpblRhcmdldCkgewogICAgdmFyIHMsIHQ7CiAgICBzID0gdGhpcy5jb21wcmVzc1VybChpblNvdXJjZSkuc3BsaXQoIi8iKTsKICAgIHQgPSB0aGlzLmNvbXByZXNzVXJsKGluVGFyZ2V0KS5zcGxpdCgiLyIpOwogICAgd2hpbGUgKHMubGVuZ3RoICYmIHNbMF0gPT09IHRbMF0pewogICAgICBzLnNoaWZ0KCk7CiAgICAgIHQuc2hpZnQoKTsKICAgIH0KICAgIGZvcih2YXIgaSA9IDAsIGwgPSBzLmxlbmd0aC0xOyBpIDwgbDsgaSsrKSB7CiAgICAgIHQudW5zaGlmdCgiLi4iKTsKICAgIH0KICAgIHZhciByID0gdC5qb2luKCIvIik7CiAgICByZXR1cm4gcjsKICB9LAogIHJlc29sdmVQYXRoc0luSFRNTDogZnVuY3Rpb24oaW5Sb290KSB7CiAgICB2YXIgZG9jVXJsID0gcGF0aC5kb2N1bWVudFVybEZyb21Ob2RlKGluUm9vdC5ib2R5KTsKICAgIC8vIFRPRE8oc29ydmVsbCk6IE1EViBQb2x5ZmlsbCBJbnRydXNpb24KICAgIGlmICh3aW5kb3cuSFRNTFRlbXBsYXRlRWxlbWVudCAmJiBIVE1MVGVtcGxhdGVFbGVtZW50LmJvb3RzdHJhcCkgewogICAgICBIVE1MVGVtcGxhdGVFbGVtZW50LmJvb3RzdHJhcChpblJvb3QpOwogICAgfQogICAgdmFyIG5vZGUgPSBpblJvb3QuYm9keTsKICAgIHBhdGguX3Jlc29sdmVQYXRoc0luSFRNTChub2RlLCBkb2NVcmwpOwogIH0sCiAgX3Jlc29sdmVQYXRoc0luSFRNTDogZnVuY3Rpb24oaW5Sb290LCBpblVybCkgewogICAgcGF0aC5yZXNvbHZlQXR0cmlidXRlcyhpblJvb3QsIGluVXJsKTsKICAgIHBhdGgucmVzb2x2ZVN0eWxlRWx0cyhpblJvb3QsIGluVXJsKTsKICAgIC8vIGhhbmRsZSB0ZW1wbGF0ZXMsIGlmIHN1cHBvcnRlZAogICAgaWYgKHdpbmRvdy50ZW1wbGF0ZUNvbnRlbnQpIHsKICAgICAgdmFyIHRlbXBsYXRlcyA9IGluUm9vdC5xdWVyeVNlbGVjdG9yQWxsKCd0ZW1wbGF0ZScpOwogICAgICBpZiAodGVtcGxhdGVzKSB7CiAgICAgICAgZm9yRWFjaCh0ZW1wbGF0ZXMsIGZ1bmN0aW9uKHQpIHsKICAgICAgICAgIHBhdGguX3Jlc29sdmVQYXRoc0luSFRNTCh0ZW1wbGF0ZUNvbnRlbnQodCksIGluVXJsKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH0sCiAgcmVzb2x2ZVBhdGhzSW5TdHlsZXNoZWV0OiBmdW5jdGlvbihpblNoZWV0KSB7CiAgICB2YXIgZG9jVXJsID0gcGF0aC5ub2RlVXJsKGluU2hlZXQpOwogICAgaW5TaGVldC5fX3Jlc291cmNlID0gcGF0aC5yZXNvbHZlQ3NzVGV4dChpblNoZWV0Ll9fcmVzb3VyY2UsIGRvY1VybCk7CiAgfSwKICByZXNvbHZlU3R5bGVFbHRzOiBmdW5jdGlvbihpblJvb3QsIGluVXJsKSB7CiAgICB2YXIgc3R5bGVzID0gaW5Sb290LnF1ZXJ5U2VsZWN0b3JBbGwoJ3N0eWxlJyk7CiAgICBpZiAoc3R5bGVzKSB7CiAgICAgIGZvckVhY2goc3R5bGVzLCBmdW5jdGlvbihzdHlsZSkgewogICAgICAgIHN0eWxlLnRleHRDb250ZW50ID0gcGF0aC5yZXNvbHZlQ3NzVGV4dChzdHlsZS50ZXh0Q29udGVudCwgaW5VcmwpOwogICAgICB9KTsKICAgIH0KICB9LAogIHJlc29sdmVDc3NUZXh0OiBmdW5jdGlvbihpbkNzc1RleHQsIGluQmFzZVVybCkgewogICAgcmV0dXJuIGluQ3NzVGV4dC5yZXBsYWNlKC91cmxcKFteKV0qXCkvZywgZnVuY3Rpb24oaW5NYXRjaCkgewogICAgICAvLyBmaW5kIHRoZSB1cmwgcGF0aCwgaWdub3JlIHF1b3RlcyBpbiB1cmwgc3RyaW5nCiAgICAgIHZhciB1cmxQYXRoID0gaW5NYXRjaC5yZXBsYWNlKC9bIiddL2csICIiKS5zbGljZSg0LCAtMSk7CiAgICAgIHVybFBhdGggPSBwYXRoLnJlc29sdmVVcmwoaW5CYXNlVXJsLCB1cmxQYXRoLCB0cnVlKTsKICAgICAgcmV0dXJuICJ1cmwoIiArIHVybFBhdGggKyAiKSI7CiAgICB9KTsKICB9LAogIHJlc29sdmVBdHRyaWJ1dGVzOiBmdW5jdGlvbihpblJvb3QsIGluVXJsKSB7CiAgICAvLyBzZWFyY2ggZm9yIGF0dHJpYnV0ZXMgdGhhdCBob3N0IHVybHMKICAgIHZhciBub2RlcyA9IGluUm9vdCAmJiBpblJvb3QucXVlcnlTZWxlY3RvckFsbChVUkxfQVRUUlNfU0VMRUNUT1IpOwogICAgaWYgKG5vZGVzKSB7CiAgICAgIGZvckVhY2gobm9kZXMsIGZ1bmN0aW9uKG4pIHsKICAgICAgICB0aGlzLnJlc29sdmVOb2RlQXR0cmlidXRlcyhuLCBpblVybCk7CiAgICAgIH0sIHRoaXMpOwogICAgfQogIH0sCiAgcmVzb2x2ZU5vZGVBdHRyaWJ1dGVzOiBmdW5jdGlvbihpbk5vZGUsIGluVXJsKSB7CiAgICBVUkxfQVRUUlMuZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICAgIHZhciBhdHRyID0gaW5Ob2RlLmF0dHJpYnV0ZXNbdl07CiAgICAgIGlmIChhdHRyICYmIGF0dHIudmFsdWUgJiYKICAgICAgICAgKGF0dHIudmFsdWUuc2VhcmNoKFVSTF9URU1QTEFURV9TRUFSQ0gpIDwgMCkpIHsKICAgICAgICB2YXIgdXJsUGF0aCA9IHBhdGgucmVzb2x2ZVVybChpblVybCwgYXR0ci52YWx1ZSwgdHJ1ZSk7CiAgICAgICAgYXR0ci52YWx1ZSA9IHVybFBhdGg7CiAgICAgIH0KICAgIH0pOwogIH0KfTsKCnZhciBVUkxfQVRUUlMgPSBbJ2hyZWYnLCAnc3JjJywgJ2FjdGlvbiddOwp2YXIgVVJMX0FUVFJTX1NFTEVDVE9SID0gJ1snICsgVVJMX0FUVFJTLmpvaW4oJ10sWycpICsgJ10nOwp2YXIgVVJMX1RFTVBMQVRFX1NFQVJDSCA9ICd7ey4qfX0nOwoKdmFyIHhociA9IHNjb3BlLnhociB8fCB7CiAgYXN5bmM6IHRydWUsCiAgb2s6IGZ1bmN0aW9uKGluUmVxdWVzdCkgewogICAgcmV0dXJuIChpblJlcXVlc3Quc3RhdHVzID49IDIwMCAmJiBpblJlcXVlc3Quc3RhdHVzIDwgMzAwKQogICAgICAgIHx8IChpblJlcXVlc3Quc3RhdHVzID09PSAzMDQpCiAgICAgICAgfHwgKGluUmVxdWVzdC5zdGF0dXMgPT09IDApOwogIH0sCiAgbG9hZDogZnVuY3Rpb24odXJsLCBuZXh0LCBuZXh0Q29udGV4dCkgewogICAgdmFyIHJlcXVlc3QgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgIGlmIChzY29wZS5mbGFncy5kZWJ1ZyB8fCBzY29wZS5mbGFncy5idXN0KSB7CiAgICAgIHVybCArPSAnPycgKyBNYXRoLnJhbmRvbSgpOwogICAgfQogICAgcmVxdWVzdC5vcGVuKCdHRVQnLCB1cmwsIHhoci5hc3luYyk7CiAgICByZXF1ZXN0LmFkZEV2ZW50TGlzdGVuZXIoJ3JlYWR5c3RhdGVjaGFuZ2UnLCBmdW5jdGlvbihlKSB7CiAgICAgIGlmIChyZXF1ZXN0LnJlYWR5U3RhdGUgPT09IDQpIHsKICAgICAgICBuZXh0LmNhbGwobmV4dENvbnRleHQsICF4aHIub2socmVxdWVzdCkgJiYgcmVxdWVzdCwKICAgICAgICAgIHJlcXVlc3QucmVzcG9uc2UsIHVybCk7CiAgICAgIH0KICAgIH0pOwogICAgcmVxdWVzdC5zZW5kKCk7CiAgfQp9OwoKdmFyIGZvckVhY2ggPSBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsLmJpbmQoQXJyYXkucHJvdG90eXBlLmZvckVhY2gpOwoKLy8gZXhwb3J0cwoKc2NvcGUueGhyID0geGhyOwpzY29wZS5pbXBvcnRlciA9IGltcG9ydGVyOwpzY29wZS5nZXREb2N1bWVudFVybCA9IHBhdGguZ2V0RG9jdW1lbnRVcmw7CgovLyBib290c3RyYXAKCi8vIElFIHNoaW0gZm9yIEN1c3RvbUV2ZW50CmlmICh0eXBlb2Ygd2luZG93LkN1c3RvbUV2ZW50ICE9PSAnZnVuY3Rpb24nKSB7CiAgd2luZG93LkN1c3RvbUV2ZW50ID0gZnVuY3Rpb24oaW5UeXBlKSB7CiAgICAgdmFyIGUgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgnSFRNTEV2ZW50cycpOwogICAgIGUuaW5pdEV2ZW50KGluVHlwZSwgdHJ1ZSwgdHJ1ZSk7CiAgICAgcmV0dXJuIGU7CiAgfTsKfQoKZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGZ1bmN0aW9uKCkgewogIC8vIHByZWxvYWQgZG9jdW1lbnQgcmVzb3VyY2UgdHJlZXMKICBpbXBvcnRlci5sb2FkKGRvY3VtZW50LCBmdW5jdGlvbigpIHsKICAgIC8vIFRPRE8oc2ptaWxlcyk6IFNoYWRvd0RPTSBwb2x5ZmlsbCBwb2xsdXRpb24KICAgIHZhciBkb2MgPSB3aW5kb3cuU2hhZG93RE9NUG9seWZpbGwgPyBTaGFkb3dET01Qb2x5ZmlsbC53cmFwKGRvY3VtZW50KQogICAgICAgIDogZG9jdW1lbnQ7CiAgICBIVE1MSW1wb3J0cy5yZWFkeVRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIC8vIHNlbmQgSFRNTEltcG9ydHNMb2FkZWQgd2hlbiBmaW5pc2hlZAogICAgZG9jLmJvZHkuZGlzcGF0Y2hFdmVudCgKICAgICAgbmV3IEN1c3RvbUV2ZW50KCdIVE1MSW1wb3J0c0xvYWRlZCcsIHtidWJibGVzOiB0cnVlfSkKICAgICk7CiAgfSk7Cn0pOwoKfSkod2luZG93LkhUTUxJbXBvcnRzKTsKCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgppZiAoIXdpbmRvdy5NdXRhdGlvbk9ic2VydmVyKSB7CiAgd2luZG93Lk11dGF0aW9uT2JzZXJ2ZXIgPQogICAgICB3aW5kb3cuV2ViS2l0TXV0YXRpb25PYnNlcnZlciB8fAogICAgICB3aW5kb3cuSnNNdXRhdGlvbk9ic2VydmVyOwogIGlmICghTXV0YXRpb25PYnNlcnZlcikgewogICAgdGhyb3cgbmV3IEVycm9yKCJubyBtdXRhdGlvbiBvYnNlcnZlciBzdXBwb3J0Iik7CiAgfQp9CgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKLyoqCiAqIEltcGxlbWVudHMgYGRvY3VtZW50LnJlZ2lzdGVyYAogKiBAbW9kdWxlIEN1c3RvbUVsZW1lbnRzCiovCgovKioKICogUG9seWZpbGxlZCBleHRlbnNpb25zIHRvIHRoZSBgZG9jdW1lbnRgIG9iamVjdC4KICogQGNsYXNzIERvY3VtZW50CiovCgooZnVuY3Rpb24oc2NvcGUpIHsKCmlmICghc2NvcGUpIHsKICBzY29wZSA9IHdpbmRvdy5DdXN0b21FbGVtZW50cyA9IHtmbGFnczp7fX07Cn0KCi8vIG5hdGl2ZSBkb2N1bWVudC5yZWdpc3Rlcj8KCnNjb3BlLmhhc05hdGl2ZSA9IChkb2N1bWVudC53ZWJraXRSZWdpc3RlciB8fCBkb2N1bWVudC5yZWdpc3RlcikgJiYgc2NvcGUuZmxhZ3MucmVnaXN0ZXIgPT09ICduYXRpdmUnOwppZiAoc2NvcGUuaGFzTmF0aXZlKSB7CgogIC8vIG5vcm1hbGl6ZQogIGRvY3VtZW50LnJlZ2lzdGVyID0gZG9jdW1lbnQucmVnaXN0ZXIgfHwgZG9jdW1lbnQud2Via2l0UmVnaXN0ZXI7CgogIHZhciBub3AgPSBmdW5jdGlvbigpIHt9OwoKICAvLyBleHBvcnRzCiAgc2NvcGUucmVnaXN0cnkgPSB7fTsKICBzY29wZS51cGdyYWRlRWxlbWVudCA9IG5vcDsKCn0gZWxzZSB7CgovKioKICogUmVnaXN0ZXJzIGEgY3VzdG9tIHRhZyBuYW1lIHdpdGggdGhlIGRvY3VtZW50LgogKgogKiBXaGVuIGEgcmVnaXN0ZXJlZCBlbGVtZW50IGlzIGNyZWF0ZWQsIGEgYHJlYWR5Q2FsbGJhY2tgIG1ldGhvZCBpcyBjYWxsZWQKICogaW4gdGhlIHNjb3BlIG9mIHRoZSBlbGVtZW50LiBUaGUgYHJlYWR5Q2FsbGJhY2tgIG1ldGhvZCBjYW4gYmUgc3BlY2lmaWVkIG9uCiAqIGVpdGhlciBgaW5PcHRpb25zLnByb3RvdHlwZWAgb3IgYGluT3B0aW9ucy5saWZlY3ljbGVgIHdpdGggdGhlIGxhdHRlciB0YWtpbmcKICogcHJlY2VkZW5jZS4KICoKICogQG1ldGhvZCByZWdpc3RlcgogKiBAcGFyYW0ge1N0cmluZ30gaW5OYW1lIFRoZSB0YWcgbmFtZSB0byByZWdpc3Rlci4gTXVzdCBpbmNsdWRlIGEgZGFzaCAoJy0nKSwKICogICAgZm9yIGV4YW1wbGUgJ3gtY29tcG9uZW50Jy4KICogQHBhcmFtIHtPYmplY3R9IGluT3B0aW9ucwogKiAgICBAcGFyYW0ge1N0cmluZ30gW2luT3B0aW9ucy5leHRlbmRzXQogKiAgICAgIChfb2ZmIHNwZWNfKSBUYWcgbmFtZSBvZiBhbiBlbGVtZW50IHRvIGV4dGVuZCAob3IgYmxhbmsgZm9yIGEgbmV3CiAqICAgICAgZWxlbWVudCkuIFRoaXMgcGFyYW1ldGVyIGlzIG5vdCBwYXJ0IG9mIHRoZSBzcGVjaWZpY2F0aW9uLCBidXQgaW5zdGVhZAogKiAgICAgIGlzIGEgaGludCBmb3IgdGhlIHBvbHlmaWxsIGJlY2F1c2UgdGhlIGV4dGVuZGVlIGlzIGRpZmZpY3VsdCB0byBpbmZlci4KICogICAgICBSZW1lbWJlciB0aGF0IHRoZSBpbnB1dCBwcm90b3R5cGUgbXVzdCBjaGFpbiB0byB0aGUgZXh0ZW5kZWQgZWxlbWVudCdzCiAqICAgICAgcHJvdG90eXBlIChvciBIVE1MRWxlbWVudC5wcm90b3R5cGUpIHJlZ2FyZGxlc3Mgb2YgdGhlIHZhbHVlIG9mCiAqICAgICAgYGV4dGVuZHNgLgogKiAgICBAcGFyYW0ge09iamVjdH0gaW5PcHRpb25zLnByb3RvdHlwZSBUaGUgcHJvdG90eXBlIHRvIHVzZSBmb3IgdGhlIG5ldwogKiAgICAgIGVsZW1lbnQuIFRoZSBwcm90b3R5cGUgbXVzdCBpbmhlcml0IGZyb20gSFRNTEVsZW1lbnQuCiAqICAgIEBwYXJhbSB7T2JqZWN0fSBbaW5PcHRpb25zLmxpZmVjeWNsZV0KICogICAgICBDYWxsYmFja3MgdGhhdCBmaXJlIGF0IGltcG9ydGFudCBwaGFzZXMgaW4gdGhlIGxpZmUgb2YgdGhlIGN1c3RvbQogKiAgICAgIGVsZW1lbnQuCiAqCiAqIEBleGFtcGxlCiAqICAgICAgRmFuY3lCdXR0b24gPSBkb2N1bWVudC5yZWdpc3RlcigiZmFuY3ktYnV0dG9uIiwgewogKiAgICAgICAgZXh0ZW5kczogJ2J1dHRvbicsCiAqICAgICAgICBwcm90b3R5cGU6IE9iamVjdC5jcmVhdGUoSFRNTEJ1dHRvbkVsZW1lbnQucHJvdG90eXBlLCB7CiAqICAgICAgICAgIHJlYWR5Q2FsbGJhY2s6IHsKICogICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24oKSB7CiAqICAgICAgICAgICAgICBjb25zb2xlLmxvZygiYSBmYW5jeS1idXR0b24gd2FzIGNyZWF0ZWQiLAogKiAgICAgICAgICAgIH0KICogICAgICAgICAgfQogKiAgICAgICAgfSkKICogICAgICB9KTsKICogQHJldHVybiB7RnVuY3Rpb259IENvbnN0cnVjdG9yIGZvciB0aGUgbmV3bHkgcmVnaXN0ZXJlZCB0eXBlLgogKi8KZnVuY3Rpb24gcmVnaXN0ZXIoaW5OYW1lLCBpbk9wdGlvbnMpIHsKICAvL2NvbnNvbGUud2FybignZG9jdW1lbnQucmVnaXN0ZXIoIicgKyBpbk5hbWUgKyAnIiwgJywgaW5PcHRpb25zLCAnKScpOwogIC8vIGNvbnN0cnVjdCBhIGRlZmludGlvbiBvdXQgb2Ygb3B0aW9ucwogIC8vIFRPRE8oc2ptaWxlcyk6IHByb2JhYmx5IHNob3VsZCBjbG9uZSBpbk9wdGlvbnMgaW5zdGVhZCBvZiBtdXRhdGluZyBpdAogIHZhciBkZWZpbml0aW9uID0gaW5PcHRpb25zIHx8IHt9OwogIGlmICghaW5OYW1lKSB7CiAgICAvLyBUT0RPKHNqbWlsZXMpOiByZXBsYWNlIHdpdGggbW9yZSBhcHByb3ByaWF0ZSBlcnJvciAoRXJpayBjYW4gcHJvYmFibHkKICAgIC8vIG9mZmVyIGd1aWRhbmNlKQogICAgdGhyb3cgbmV3IEVycm9yKCdOYW1lIGFyZ3VtZW50IG11c3Qgbm90IGJlIGVtcHR5Jyk7CiAgfQogIC8vIHJlY29yZCBuYW1lCiAgZGVmaW5pdGlvbi5uYW1lID0gaW5OYW1lOwogIC8vIG11c3QgaGF2ZSBhIHByb3RvdHlwZSwgZGVmYXVsdCB0byBhbiBleHRlbnNpb24gb2YgSFRNTEVsZW1lbnQKICAvLyBUT0RPKHNqbWlsZXMpOiBwcm9iYWJseSBzaG91bGQgdGhyb3cgaWYgbm8gcHJvdG90eXBlLCBjaGVjayBzcGVjCiAgaWYgKCFkZWZpbml0aW9uLnByb3RvdHlwZSkgewogICAgLy8gVE9ETyhzam1pbGVzKTogcmVwbGFjZSB3aXRoIG1vcmUgYXBwcm9wcmlhdGUgZXJyb3IgKEVyaWsgY2FuIHByb2JhYmx5CiAgICAvLyBvZmZlciBndWlkYW5jZSkKICAgIHRocm93IG5ldyBFcnJvcignT3B0aW9ucyBtaXNzaW5nIHJlcXVpcmVkIHByb3RvdHlwZSBwcm9wZXJ0eScpOwogIH0KICAvLyBlbnN1cmUgYSBsaWZlY3ljbGUgb2JqZWN0IHNvIHdlIGRvbid0IGhhdmUgdG8gbnVsbCB0ZXN0IGl0CiAgZGVmaW5pdGlvbi5saWZlY3ljbGUgPSBkZWZpbml0aW9uLmxpZmVjeWNsZSB8fCB7fTsKICAvLyBidWlsZCBhIGxpc3Qgb2YgYW5jZXN0cmFsIGN1c3RvbSBlbGVtZW50cyAoZm9yIG5hdGl2ZSBiYXNlIGRldGVjdGlvbikKICAvLyBUT0RPKHNqbWlsZXMpOiB3ZSB1c2VkIHRvIG5lZWQgdG8gc3RvcmUgdGhpcywgYnV0IGN1cnJlbnQgY29kZSBvbmx5CiAgLy8gdXNlcyBpdCBpbiAncmVzb2x2ZVRhZ05hbWUnOiBpdCBzaG91bGQgcHJvYmFibHkgYmUgaW5saW5lZAogIGRlZmluaXRpb24uYW5jZXN0cnkgPSBhbmNlc3RyeShkZWZpbml0aW9uLmV4dGVuZHMpOwogIC8vIGV4dGVuc2lvbnMgb2YgbmF0aXZlIHNwZWNpYWxpemF0aW9ucyBvZiBIVE1MRWxlbWVudCByZXF1aXJlIGxvY2FsTmFtZQogIC8vIHRvIHJlbWFpbiBuYXRpdmUsIGFuZCB1c2Ugc2Vjb25kYXJ5ICdpcycgc3BlY2lmaWVyIGZvciBleHRlbnNpb24gdHlwZQogIHJlc29sdmVUYWdOYW1lKGRlZmluaXRpb24pOwogIC8vIHNvbWUgcGxhdGZvcm1zIHJlcXVpcmUgbW9kaWZpY2F0aW9ucyB0byB0aGUgdXNlci1zdXBwbGllZCBwcm90b3R5cGUKICAvLyBjaGFpbgogIHJlc29sdmVQcm90b3R5cGVDaGFpbihkZWZpbml0aW9uKTsKICAvLyBvdmVycmlkZXMgdG8gaW1wbGVtZW50IGF0dHJpYnV0ZUNoYW5nZWQgY2FsbGJhY2sKICBvdmVycmlkZUF0dHJpYnV0ZUFwaShkZWZpbml0aW9uLnByb3RvdHlwZSk7CiAgLy8gNy4xLjU6IFJlZ2lzdGVyIHRoZSBERUZJTklUSU9OIHdpdGggRE9DVU1FTlQKICByZWdpc3RlckRlZmluaXRpb24oaW5OYW1lLCBkZWZpbml0aW9uKTsKICAvLyA3LjEuNy4gUnVuIGN1c3RvbSBlbGVtZW50IGNvbnN0cnVjdG9yIGdlbmVyYXRpb24gYWxnb3JpdGhtIHdpdGggUFJPVE9UWVBFCiAgLy8gNy4xLjguIFJldHVybiB0aGUgb3V0cHV0IG9mIHRoZSBwcmV2aW91cyBzdGVwLgogIGRlZmluaXRpb24uY3RvciA9IGdlbmVyYXRlQ29uc3RydWN0b3IoZGVmaW5pdGlvbik7CiAgZGVmaW5pdGlvbi5jdG9yLnByb3RvdHlwZSA9IGRlZmluaXRpb24ucHJvdG90eXBlOwogIC8vIGZvcmNlIG91ciAuY29uc3RydWN0b3IgdG8gYmUgb3VyIGFjdHVhbCBjb25zdHJ1Y3RvcgogIGRlZmluaXRpb24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gZGVmaW5pdGlvbi5jdG9yOwogIC8vIGlmIGluaXRpYWwgcGFyc2luZyBpcyBjb21wbGV0ZQogIGlmIChzY29wZS5yZWFkeSkgewogICAgLy8gdXBncmFkZSBhbnkgcHJlLWV4aXN0aW5nIG5vZGVzIG9mIHRoaXMgdHlwZQogICAgc2NvcGUudXBncmFkZUFsbChkb2N1bWVudCk7CiAgfQogIHJldHVybiBkZWZpbml0aW9uLmN0b3I7Cn0KCmZ1bmN0aW9uIGFuY2VzdHJ5KGluRXh0ZW5kcykgewogIHZhciBleHRlbmRlZSA9IHJlZ2lzdHJ5W2luRXh0ZW5kc107CiAgaWYgKGV4dGVuZGVlKSB7CiAgICByZXR1cm4gYW5jZXN0cnkoZXh0ZW5kZWUuZXh0ZW5kcykuY29uY2F0KFtleHRlbmRlZV0pOwogIH0KICByZXR1cm4gW107Cn0KCmZ1bmN0aW9uIHJlc29sdmVUYWdOYW1lKGluRGVmaW5pdGlvbikgewogIC8vIGlmIHdlIGFyZSBleHBsaWNpdGx5IGV4dGVuZGluZyBzb21ldGhpbmcsIHRoYXQgdGhpbmcgaXMgb3VyCiAgLy8gYmFzZVRhZywgdW5sZXNzIGl0IHJlcHJlc2VudHMgYSBjdXN0b20gY29tcG9uZW50CiAgdmFyIGJhc2VUYWcgPSBpbkRlZmluaXRpb24uZXh0ZW5kczsKICAvLyBpZiBvdXIgYW5jZXN0cnkgaW5jbHVkZXMgY3VzdG9tIGNvbXBvbmVudHMsIHdlIG9ubHkgaGF2ZSBhCiAgLy8gYmFzZVRhZyBpZiBvbmUgb2YgdGhlbSBkb2VzCiAgZm9yICh2YXIgaT0wLCBhOyAoYT1pbkRlZmluaXRpb24uYW5jZXN0cnlbaV0pOyBpKyspIHsKICAgIGJhc2VUYWcgPSBhLmlzICYmIGEudGFnOwogIH0KICAvLyBvdXIgdGFnIGlzIG91ciBiYXNlVGFnLCBpZiBpdCBleGlzdHMsIGFuZCBvdGhlcndpc2UganVzdCBvdXIgbmFtZQogIGluRGVmaW5pdGlvbi50YWcgPSBiYXNlVGFnIHx8IGluRGVmaW5pdGlvbi5uYW1lOwogIGlmIChiYXNlVGFnKSB7CiAgICAvLyBpZiB0aGVyZSBpcyBhIGJhc2UgdGFnLCB1c2Ugc2Vjb25kYXJ5ICdpcycgc3BlY2lmaWVyCiAgICBpbkRlZmluaXRpb24uaXMgPSBpbkRlZmluaXRpb24ubmFtZTsKICB9Cn0KCmZ1bmN0aW9uIHJlc29sdmVQcm90b3R5cGVDaGFpbihpbkRlZmluaXRpb24pIHsKICAvLyBpZiB3ZSBkb24ndCBzdXBwb3J0IF9fcHJvdG9fXyB3ZSBuZWVkIHRvIGxvY2F0ZSB0aGUgbmF0aXZlIGxldmVsCiAgLy8gcHJvdG90eXBlIGZvciBwcmVjaXNlIG1peGluZyBpbgogIGlmICghT2JqZWN0Ll9fcHJvdG9fXykgewogICAgLy8gZGVmYXVsdCBwcm90b3R5cGUKICAgIHZhciBuYXRpdmUgPSBIVE1MRWxlbWVudC5wcm90b3R5cGU7CiAgICAvLyB3b3JrIG91dCBwcm90b3R5cGUgd2hlbiB1c2luZyB0eXBlLWV4dGVuc2lvbgogICAgaWYgKGluRGVmaW5pdGlvbi5pcykgewogICAgICB2YXIgaW5zdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoaW5EZWZpbml0aW9uLnRhZyk7CiAgICAgIG5hdGl2ZSA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihpbnN0KTsKICAgIH0KICB9CiAgLy8gY2FjaGUgdGhpcyBpbiBjYXNlIG9mIG1peGluCiAgaW5EZWZpbml0aW9uLm5hdGl2ZSA9IG5hdGl2ZTsKfQoKLy8gU0VDVElPTiA0CgpmdW5jdGlvbiBpbnN0YW50aWF0ZShpbkRlZmluaXRpb24pIHsKICAvLyA0LmEuMS4gQ3JlYXRlIGEgbmV3IG9iamVjdCB0aGF0IGltcGxlbWVudHMgUFJPVE9UWVBFCiAgLy8gNC5hLjIuIExldCBFTEVNRU5UIGJ5IHRoaXMgbmV3IG9iamVjdAogIC8vCiAgLy8gdGhlIGN1c3RvbSBlbGVtZW50IGluc3RhbnRpYXRpb24gYWxnb3JpdGhtIG11c3QgYWxzbyBlbnN1cmUgdGhhdCB0aGUKICAvLyBvdXRwdXQgaXMgYSB2YWxpZCBET00gZWxlbWVudCB3aXRoIHRoZSBwcm9wZXIgd3JhcHBlciBpbiBwbGFjZS4KICAvLwogIHJldHVybiB1cGdyYWRlKGRvbUNyZWF0ZUVsZW1lbnQoaW5EZWZpbml0aW9uLnRhZyksIGluRGVmaW5pdGlvbik7Cn0KCmZ1bmN0aW9uIHVwZ3JhZGUoaW5FbGVtZW50LCBpbkRlZmluaXRpb24pIHsKICAvLyBzb21lIGRlZmluaXRpb25zIHNwZWNpZnkgYW4gJ2lzJyBhdHRyaWJ1dGUKICBpZiAoaW5EZWZpbml0aW9uLmlzKSB7CiAgICBpbkVsZW1lbnQuc2V0QXR0cmlidXRlKCdpcycsIGluRGVmaW5pdGlvbi5pcyk7CiAgfQogIC8vIG1ha2UgJ2VsZW1lbnQnIGltcGxlbWVudCBpbkRlZmluaXRpb24ucHJvdG90eXBlCiAgaW1wbGVtZW50KGluRWxlbWVudCwgaW5EZWZpbml0aW9uKTsKICAvLyBmbGFnIGFzIHVwZ3JhZGVkCiAgaW5FbGVtZW50Ll9fdXBncmFkZWRfXyA9IHRydWU7CiAgLy8gdGhlcmUgc2hvdWxkIG5ldmVyIGJlIGEgc2hhZG93IHJvb3Qgb24gaW5FbGVtZW50IGF0IHRoaXMgcG9pbnQKICAvLyB3ZSByZXF1aXJlIGNoaWxkIG5vZGVzIGJlIHVwZ3JhZGVkIGJlZm9yZSByZWFkeQogIHNjb3BlLnVwZ3JhZGVTdWJ0cmVlKGluRWxlbWVudCk7CiAgLy8gbGlmZWN5Y2xlIG1hbmFnZW1lbnQKICByZWFkeShpbkVsZW1lbnQpOwogIC8vIE9VVFBVVAogIHJldHVybiBpbkVsZW1lbnQ7Cn0KCmZ1bmN0aW9uIGltcGxlbWVudChpbkVsZW1lbnQsIGluRGVmaW5pdGlvbikgewogIC8vIHByb3RvdHlwZSBzd2l6emxpbmcgaXMgYmVzdAogIGlmIChPYmplY3QuX19wcm90b19fKSB7CiAgICBpbkVsZW1lbnQuX19wcm90b19fID0gaW5EZWZpbml0aW9uLnByb3RvdHlwZTsKICB9IGVsc2UgewogICAgLy8gd2hlcmUgYWJvdmUgd2UgY2FuIHJlLWFjcXVpcmUgaW5Qcm90b3R5cGUgdmlhCiAgICAvLyBnZXRQcm90b3R5cGVPZihFbGVtZW50KSwgd2UgY2Fubm90IGRvIHNvIHdoZW4KICAgIC8vIHdlIHVzZSBtaXhpbiwgc28gd2UgaW5zdGFsbCBhIG1hZ2ljIHJlZmVyZW5jZQogICAgY3VzdG9tTWl4aW4oaW5FbGVtZW50LCBpbkRlZmluaXRpb24ucHJvdG90eXBlLCBpbkRlZmluaXRpb24ubmF0aXZlKTsKICAgIGluRWxlbWVudC5fX3Byb3RvX18gPSBpbkRlZmluaXRpb24ucHJvdG90eXBlOwogIH0KfQoKZnVuY3Rpb24gY3VzdG9tTWl4aW4oaW5UYXJnZXQsIGluU3JjLCBpbk5hdGl2ZSkgewogIC8vIFRPRE8oc2ptaWxlcyk6ICd1c2VkJyBhbGxvd3MgdXMgdG8gb25seSBjb3B5IHRoZSAneW91bmdlc3QnIHZlcnNpb24gb2YKICAvLyBhbnkgcHJvcGVydHkuIFRoaXMgc2V0IHNob3VsZCBiZSBwcmVjYWxjdWxhdGVkLiBXZSBhbHNvIG5lZWQgdG8KICAvLyBjb25zaWRlciB0aGlzIGZvciBzdXBwb3J0aW5nICdzdXBlcicuCiAgdmFyIHVzZWQgPSB7fTsKICAvLyBzdGFydCB3aXRoIGluU3JjCiAgdmFyIHAgPSBpblNyYzsKICAvLyBzb21ldGltZXMgdGhlIGRlZmF1bHQgaXMgSFRNTFVua25vd25FbGVtZW50LnByb3RvdHlwZSBpbnN0ZWFkIG9mCiAgLy8gSFRNTEVsZW1lbnQucHJvdG90eXBlLCBzbyB3ZSBhZGQgYSB0ZXN0CiAgLy8gdGhlIGlkZWEgaXMgdG8gYXZvaWQgbWl4aW5nIGluIG5hdGl2ZSBwcm90b3R5cGVzLCBzbyBhZGRpbmcKICAvLyB0aGUgc2Vjb25kIHRlc3QgaXMgV0xPRwogIHdoaWxlIChwICE9PSBpbk5hdGl2ZSAmJiBwICE9PSBIVE1MVW5rbm93bkVsZW1lbnQucHJvdG90eXBlKSB7CiAgICB2YXIga2V5cyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHApOwogICAgZm9yICh2YXIgaT0wLCBrOyBrPWtleXNbaV07IGkrKykgewogICAgICBpZiAoIXVzZWRba10pIHsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoaW5UYXJnZXQsIGssCiAgICAgICAgICAgIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IocCwgaykpOwogICAgICAgIHVzZWRba10gPSAxOwogICAgICB9CiAgICB9CiAgICBwID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHApOwogIH0KfQoKZnVuY3Rpb24gcmVhZHkoaW5FbGVtZW50KSB7CiAgLy8gaW52b2tlIHJlYWR5Q2FsbGJhY2sKICBpZiAoaW5FbGVtZW50LnJlYWR5Q2FsbGJhY2spIHsKICAgIGluRWxlbWVudC5yZWFkeUNhbGxiYWNrKCk7CiAgfQp9CgovLyBhdHRyaWJ1dGUgd2F0Y2hpbmcKCmZ1bmN0aW9uIG92ZXJyaWRlQXR0cmlidXRlQXBpKHByb3RvdHlwZSkgewogIC8vIG92ZXJyaWRlcyB0byBpbXBsZW1lbnQgY2FsbGJhY2tzCiAgLy8gVE9ETyhzam1pbGVzKTogc2hvdWxkIHN1cHBvcnQgYWNjZXNzIHZpYSAuYXR0cmlidXRlcyBOYW1lZE5vZGVNYXAKICAvLyBUT0RPKHNqbWlsZXMpOiBwcmVzZXJ2ZXMgdXNlciBkZWZpbmVkIG92ZXJyaWRlcywgaWYgYW55CiAgdmFyIHNldEF0dHJpYnV0ZSA9IHByb3RvdHlwZS5zZXRBdHRyaWJ1dGU7CiAgcHJvdG90eXBlLnNldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICBjaGFuZ2VBdHRyaWJ1dGUuY2FsbCh0aGlzLCBuYW1lLCB2YWx1ZSwgc2V0QXR0cmlidXRlKTsKICB9CiAgdmFyIHJlbW92ZUF0dHJpYnV0ZSA9IHByb3RvdHlwZS5yZW1vdmVBdHRyaWJ1dGU7CiAgcHJvdG90eXBlLnJlbW92ZUF0dHJpYnV0ZSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICBjaGFuZ2VBdHRyaWJ1dGUuY2FsbCh0aGlzLCBuYW1lLCB2YWx1ZSwgcmVtb3ZlQXR0cmlidXRlKTsKICB9Cn0KCmZ1bmN0aW9uIGNoYW5nZUF0dHJpYnV0ZShuYW1lLCB2YWx1ZSwgb3BlcmF0aW9uKSB7CiAgdmFyIG9sZFZhbHVlID0gdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSk7CiAgb3BlcmF0aW9uLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgaWYgKHRoaXMuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrCiAgICAgICYmICh0aGlzLmdldEF0dHJpYnV0ZShuYW1lKSAhPT0gb2xkVmFsdWUpKSB7CiAgICB0aGlzLmF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayhuYW1lLCBvbGRWYWx1ZSk7CiAgfQp9CgovLyBlbGVtZW50IHJlZ2lzdHJ5IChtYXBzIHRhZyBuYW1lcyB0byBkZWZpbml0aW9ucykKCnZhciByZWdpc3RyeSA9IHt9OwoKZnVuY3Rpb24gcmVnaXN0ZXJEZWZpbml0aW9uKGluTmFtZSwgaW5EZWZpbml0aW9uKSB7CiAgcmVnaXN0cnlbaW5OYW1lXSA9IGluRGVmaW5pdGlvbjsKfQoKZnVuY3Rpb24gZ2VuZXJhdGVDb25zdHJ1Y3RvcihpbkRlZmluaXRpb24pIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gaW5zdGFudGlhdGUoaW5EZWZpbml0aW9uKTsKICB9Owp9CgpmdW5jdGlvbiBjcmVhdGVFbGVtZW50KGluVGFnKSB7CiAgdmFyIGRlZmluaXRpb24gPSByZWdpc3RyeVtpblRhZ107CiAgaWYgKGRlZmluaXRpb24pIHsKICAgIHJldHVybiBuZXcgZGVmaW5pdGlvbi5jdG9yKCk7CiAgfQogIHJldHVybiBkb21DcmVhdGVFbGVtZW50KGluVGFnKTsKfQoKZnVuY3Rpb24gdXBncmFkZUVsZW1lbnQoaW5FbGVtZW50KSB7CiAgaWYgKCFpbkVsZW1lbnQuX191cGdyYWRlZF9fICYmIChpbkVsZW1lbnQubm9kZVR5cGUgPT09IE5vZGUuRUxFTUVOVF9OT0RFKSkgewogICAgdmFyIHR5cGUgPSBpbkVsZW1lbnQuZ2V0QXR0cmlidXRlKCdpcycpIHx8IGluRWxlbWVudC5sb2NhbE5hbWU7CiAgICB2YXIgZGVmaW5pdGlvbiA9IHJlZ2lzdHJ5W3R5cGVdOwogICAgcmV0dXJuIGRlZmluaXRpb24gJiYgdXBncmFkZShpbkVsZW1lbnQsIGRlZmluaXRpb24pOwogIH0KfQoKZnVuY3Rpb24gY2xvbmVOb2RlKGRlZXApIHsKICAvLyBjYWxsIG9yaWdpbmFsIGNsb25lCiAgdmFyIG4gPSBkb21DbG9uZU5vZGUuY2FsbCh0aGlzLCBkZWVwKTsKICAvLyB1cGdyYWRlIHRoZSBlbGVtZW50IGFuZCBzdWJ0cmVlCiAgc2NvcGUudXBncmFkZUFsbChuKTsKICByZXR1cm4gbjsKfQovLyBjYXB0dXJlIG5hdGl2ZSBjcmVhdGVFbGVtZW50IGJlZm9yZSB3ZSBvdmVycmlkZSBpdAoKdmFyIGRvbUNyZWF0ZUVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50LmJpbmQoZG9jdW1lbnQpOwoKLy8gY2FwdHVyZSBuYXRpdmUgY2xvbmVOb2RlIGJlZm9yZSB3ZSBvdmVycmlkZSBpdAoKdmFyIGRvbUNsb25lTm9kZSA9IE5vZGUucHJvdG90eXBlLmNsb25lTm9kZTsKCi8vIGV4cG9ydHMKCmRvY3VtZW50LnJlZ2lzdGVyID0gcmVnaXN0ZXI7CmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQgPSBjcmVhdGVFbGVtZW50OyAvLyBvdmVycmlkZQpOb2RlLnByb3RvdHlwZS5jbG9uZU5vZGUgPSBjbG9uZU5vZGU7IC8vIG92ZXJyaWRlCgpzY29wZS5yZWdpc3RyeSA9IHJlZ2lzdHJ5OwoKLyoqCiAqIFVwZ3JhZGUgYW4gZWxlbWVudCB0byBhIGN1c3RvbSBlbGVtZW50LiBVcGdyYWRpbmcgYW4gZWxlbWVudAogKiBjYXVzZXMgdGhlIGN1c3RvbSBwcm90b3R5cGUgdG8gYmUgYXBwbGllZCwgYW4gYGlzYCBhdHRyaWJ1dGUKICogdG8gYmUgYXR0YWNoZWQgKGFzIG5lZWRlZCksIGFuZCBpbnZvY2F0aW9uIG9mIHRoZSBgcmVhZHlDYWxsYmFja2AuCiAqIGB1cGdyYWRlYCBkb2VzIG5vdGhpbmcgaWYgdGhlIGVsZW1lbnQgaXMgYWxyZWFkeSB1cGdyYWRlZCwgb3IKICogaWYgaXQgbWF0Y2hlcyBubyByZWdpc3RlcmVkIGN1c3RvbSB0YWcgbmFtZS4KICoKICogQG1ldGhvZCB1Z3ByYWRlCiAqIEBwYXJhbSB7RWxlbWVudH0gaW5FbGVtZW50IFRoZSBlbGVtZW50IHRvIHVwZ3JhZGUuCiAqIEByZXR1cm4ge0VsZW1lbnR9IFRoZSB1cGdyYWRlZCBlbGVtZW50LgogKi8Kc2NvcGUudXBncmFkZSA9IHVwZ3JhZGVFbGVtZW50OwoKfQoKfSkod2luZG93LkN1c3RvbUVsZW1lbnRzKTsKCiAvKgpDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgpVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQpsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiovCgooZnVuY3Rpb24oc2NvcGUpewoKLyoKaWYgKEhUTUxFbGVtZW50LnByb3RvdHlwZS53ZWJraXRTaGFkb3dSb290KSB7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEhUTUxFbGVtZW50LnByb3RvdHlwZSwgJ3NoYWRvd1Jvb3QnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy53ZWJraXRTaGFkb3dSb290OwogICAgfQogIH07Cn0KKi8KCi8vIHdhbGsgdGhlIHN1YnRyZWUgcm9vdGVkIGF0IG5vZGUsIGFwcGx5aW5nICdmaW5kKGVsZW1lbnQsIGRhdGEpJyBmdW5jdGlvbgovLyB0byBlYWNoIGVsZW1lbnQKLy8gaWYgJ2ZpbmQnIHJldHVybnMgdHJ1ZSBmb3IgJ2VsZW1lbnQnLCBkbyBub3Qgc2VhcmNoIGVsZW1lbnQncyBzdWJ0cmVlCmZ1bmN0aW9uIGZpbmRBbGwobm9kZSwgZmluZCwgZGF0YSkgewogIHZhciBlID0gbm9kZS5maXJzdEVsZW1lbnRDaGlsZDsKICBpZiAoIWUpIHsKICAgIGUgPSBub2RlLmZpcnN0Q2hpbGQ7CiAgICB3aGlsZSAoZSAmJiBlLm5vZGVUeXBlICE9PSBOb2RlLkVMRU1FTlRfTk9ERSkgewogICAgICBlID0gZS5uZXh0U2libGluZzsKICAgIH0KICB9CiAgd2hpbGUgKGUpIHsKICAgIGlmIChmaW5kKGUsIGRhdGEpICE9PSB0cnVlKSB7CiAgICAgIGZpbmRBbGwoZSwgZmluZCwgZGF0YSk7CiAgICB9CiAgICBlID0gZS5uZXh0RWxlbWVudFNpYmxpbmc7CiAgfQogIHJldHVybiBudWxsOwp9CgovLyB3YWxrIHRoZSBzdWJ0cmVlIHJvb3RlZCBhdCBub2RlLCBpbmNsdWRpbmcgZGVzY2VudCBpbnRvIHNoYWRvdy1yb290cywKLy8gYXBwbHlpbmcgJ2NiJyB0byBlYWNoIGVsZW1lbnQKZnVuY3Rpb24gZm9yU3VidHJlZShub2RlLCBjYikgewogIC8vbG9nRmxhZ3MuZG9tICYmIG5vZGUuY2hpbGROb2RlcyAmJiBub2RlLmNoaWxkTm9kZXMubGVuZ3RoICYmIGNvbnNvbGUuZ3JvdXAoJ3N1YlRyZWU6ICcsIG5vZGUpOwogIGZpbmRBbGwobm9kZSwgZnVuY3Rpb24oZSkgewogICAgaWYgKGNiKGUpKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgaWYgKGUud2Via2l0U2hhZG93Um9vdCkgewogICAgICBmb3JTdWJ0cmVlKGUud2Via2l0U2hhZG93Um9vdCwgY2IpOwogICAgfQogIH0pOwogIGlmIChub2RlLndlYmtpdFNoYWRvd1Jvb3QpIHsKICAgIGZvclN1YnRyZWUobm9kZS53ZWJraXRTaGFkb3dSb290LCBjYik7CiAgfQogIC8vbG9nRmxhZ3MuZG9tICYmIG5vZGUuY2hpbGROb2RlcyAmJiBub2RlLmNoaWxkTm9kZXMubGVuZ3RoICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsKfQoKLy8gbWFuYWdlIGxpZmVjeWNsZSBvbiBhZGRlZCBub2RlCmZ1bmN0aW9uIGFkZGVkKG5vZGUpIHsKICBpZiAodXBncmFkZShub2RlKSkgewogICAgaW5zZXJ0ZWROb2RlKG5vZGUpOwogICAgcmV0dXJuIHRydWU7CiAgfQogIGluc2VydGVkKG5vZGUpOwp9CgovLyBtYW5hZ2UgbGlmZWN5Y2xlIG9uIGFkZGVkIG5vZGUncyBzdWJ0cmVlIG9ubHkKZnVuY3Rpb24gYWRkZWRTdWJ0cmVlKG5vZGUpIHsKICBmb3JTdWJ0cmVlKG5vZGUsIGZ1bmN0aW9uKGUpIHsKICAgIGlmIChhZGRlZChlKSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9KTsKfQoKLy8gbWFuYWdlIGxpZmVjeWNsZSBvbiBhZGRlZCBub2RlIGFuZCBpdCdzIHN1YnRyZWUKZnVuY3Rpb24gYWRkZWROb2RlKG5vZGUpIHsKICByZXR1cm4gYWRkZWQobm9kZSkgfHwgYWRkZWRTdWJ0cmVlKG5vZGUpOwp9CgovLyB1cGdyYWRlIGN1c3RvbSBlbGVtZW50cyBhdCBub2RlLCBpZiBhcHBsaWNhYmxlCmZ1bmN0aW9uIHVwZ3JhZGUobm9kZSkgewogIGlmICghbm9kZS5fX3VwZ3JhZGVkX18gJiYgbm9kZS5ub2RlVHlwZSA9PT0gTm9kZS5FTEVNRU5UX05PREUpIHsKICAgIHZhciB0eXBlID0gbm9kZS5nZXRBdHRyaWJ1dGUoJ2lzJykgfHwgbm9kZS5sb2NhbE5hbWU7CiAgICB2YXIgZGVmaW5pdGlvbiA9IHNjb3BlLnJlZ2lzdHJ5W3R5cGVdOwogICAgaWYgKGRlZmluaXRpb24pIHsKICAgICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXAoJ3VwZ3JhZGU6Jywgbm9kZS5sb2NhbE5hbWUpOwogICAgICBzY29wZS51cGdyYWRlKG5vZGUpOwogICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cEVuZCgpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGluc2VydGVkTm9kZShub2RlKSB7CiAgaW5zZXJ0ZWQobm9kZSk7CiAgaWYgKGluRG9jdW1lbnQobm9kZSkpIHsKICAgIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgewogICAgICBpbnNlcnRlZChlKTsKICAgIH0pOwogIH0KfQoKLy8gVE9ETyhzam1pbGVzKTogaWYgdGhlcmUgYXJlIGRlc2NlbnRzIGludG8gdHJlZXMgdGhhdCBjYW4gbmV2ZXIgaGF2ZSBpbkRvY3VtZW50KCopIHRydWUsIGZpeCB0aGlzCgpmdW5jdGlvbiBpbnNlcnRlZChlbGVtZW50KSB7CiAgLy8gVE9ETyhzam1pbGVzKTogaXQncyBwb3NzaWJsZSB3ZSB3ZXJlIGluc2VydGVkIGFuZCByZW1vdmVkIGluIHRoZSBzcGFjZQogIC8vIG9mIG9uZSBtaWNyb3Rhc2ssIGluIHdoaWNoIGNhc2Ugd2Ugd29uJ3QgYmUgJ2luRG9jdW1lbnQnIGhlcmUKICAvLyBCdXQgdGhlcmUgYXJlIG90aGVyIGNhc2VzIHdoZXJlIHdlIGFyZSB0ZXN0aW5nIGZvciBpbnNlcnRlZCB3aXRob3V0CiAgLy8gc3BlY2lmaWMga25vd2xlZGdlIG9mIG11dGF0aW9ucywgYW5kIG11c3QgdGVzdCAnaW5Eb2N1bWVudCcgdG8gZGV0ZXJtaW5lCiAgLy8gd2hldGhlciB0byBjYWxsIGluc2VydGVkCiAgLy8gSWYgd2UgY2FuIGZhY3RvciB0aGVzZSBjYXNlcyBpbnRvIHNlcGFyYXRlIGNvZGUgcGF0aHMgd2UgY2FuIGhhdmUKICAvLyBiZXR0ZXIgZGlhZ25vc3RpY3MuCiAgLy8gVE9ETyhzam1pbGVzKTogd2hlbiBsb2dnaW5nLCBkbyB3b3JrIG9uIGFsbCBjdXN0b20gZWxlbWVudHMgc28gd2UgY2FuCiAgLy8gdHJhY2sgYmVoYXZpb3IgZXZlbiB3aGVuIGNhbGxiYWNrcyBub3QgZGVmaW5lZAogIC8vY29uc29sZS5sb2coJ2luc2VydGVkOiAnLCBlbGVtZW50LmxvY2FsTmFtZSk7CiAgaWYgKGVsZW1lbnQuaW5zZXJ0ZWRDYWxsYmFjayB8fCAoZWxlbWVudC5fX3VwZ3JhZGVkX18gJiYgbG9nRmxhZ3MuZG9tKSkgewogICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXAoJ2luc2VydGVkOicsIGVsZW1lbnQubG9jYWxOYW1lKTsKICAgIGlmIChpbkRvY3VtZW50KGVsZW1lbnQpKSB7CiAgICAgIGVsZW1lbnQuX19pbnNlcnRlZCA9IChlbGVtZW50Ll9faW5zZXJ0ZWQgfHwgMCkgKyAxOwogICAgICAvLyBpZiB3ZSBhcmUgaW4gYSAncmVtb3ZlZCcgc3RhdGUsIGJsdW50bHkgYWRqdXN0IHRvIGFuICdpbnNlcnRlZCcgc3RhdGUKICAgICAgaWYgKGVsZW1lbnQuX19pbnNlcnRlZCA8IDEpIHsKICAgICAgICBlbGVtZW50Ll9faW5zZXJ0ZWQgPSAxOwogICAgICB9CiAgICAgIC8vIGlmIHdlIGFyZSAnb3ZlciBpbnNlcnRlZCcsIHNxdWVsY2ggdGhlIGNhbGxiYWNrCiAgICAgIGlmIChlbGVtZW50Ll9faW5zZXJ0ZWQgPiAxKSB7CiAgICAgICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUud2FybignaW5zZXJ0ZWQ6JywgZWxlbWVudC5sb2NhbE5hbWUsCiAgICAgICAgICAnaW5zZXJ0L3JlbW92ZSBjb3VudDonLCBlbGVtZW50Ll9faW5zZXJ0ZWQpCiAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC5pbnNlcnRlZENhbGxiYWNrKSB7CiAgICAgICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKCdpbnNlcnRlZDonLCBlbGVtZW50LmxvY2FsTmFtZSk7CiAgICAgICAgZWxlbWVudC5pbnNlcnRlZENhbGxiYWNrKCk7CiAgICAgIH0KICAgIH0KICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7CiAgfQp9CgpmdW5jdGlvbiByZW1vdmVkTm9kZShub2RlKSB7CiAgcmVtb3ZlZChub2RlKTsKICBmb3JTdWJ0cmVlKG5vZGUsIGZ1bmN0aW9uKGUpIHsKICAgIHJlbW92ZWQoZSk7CiAgfSk7Cn0KCmZ1bmN0aW9uIHJlbW92ZWQoZWxlbWVudCkgewogIC8vIFRPRE8oc2ptaWxlcyk6IHRlbXBvcmFyeTogZG8gd29yayBvbiBhbGwgY3VzdG9tIGVsZW1lbnRzIHNvIHdlIGNhbiB0cmFjawogIC8vIGJlaGF2aW9yIGV2ZW4gd2hlbiBjYWxsYmFja3Mgbm90IGRlZmluZWQKICBpZiAoZWxlbWVudC5yZW1vdmVkQ2FsbGJhY2sgfHwgKGVsZW1lbnQuX191cGdyYWRlZF9fICYmIGxvZ0ZsYWdzLmRvbSkpIHsKICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmxvZygncmVtb3ZlZDonLCBlbGVtZW50LmxvY2FsTmFtZSk7CiAgICBpZiAoIWluRG9jdW1lbnQoZWxlbWVudCkpIHsKICAgICAgZWxlbWVudC5fX2luc2VydGVkID0gKGVsZW1lbnQuX19pbnNlcnRlZCB8fCAwKSAtIDE7CiAgICAgIC8vIGlmIHdlIGFyZSBpbiBhICdpbnNlcnRlZCcgc3RhdGUsIGJsdW50bHkgYWRqdXN0IHRvIGFuICdyZW1vdmVkJyBzdGF0ZQogICAgICBpZiAoZWxlbWVudC5fX2luc2VydGVkID4gMCkgewogICAgICAgIGVsZW1lbnQuX19pbnNlcnRlZCA9IDA7CiAgICAgIH0KICAgICAgLy8gaWYgd2UgYXJlICdvdmVyIHJlbW92ZWQnLCBzcXVlbGNoIHRoZSBjYWxsYmFjawogICAgICBpZiAoZWxlbWVudC5fX2luc2VydGVkIDwgMCkgewogICAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLndhcm4oJ3JlbW92ZWQ6JywgZWxlbWVudC5sb2NhbE5hbWUsCiAgICAgICAgICAgICdpbnNlcnQvcmVtb3ZlIGNvdW50OicsIGVsZW1lbnQuX19pbnNlcnRlZCkKICAgICAgfSBlbHNlIGlmIChlbGVtZW50LnJlbW92ZWRDYWxsYmFjaykgewogICAgICAgIGVsZW1lbnQucmVtb3ZlZENhbGxiYWNrKCk7CiAgICAgIH0KICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGluRG9jdW1lbnQoZWxlbWVudCkgewogIHZhciBwID0gZWxlbWVudDsKICB3aGlsZSAocCkgewogICAgaWYgKHAgPT0gZWxlbWVudC5vd25lckRvY3VtZW50KSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcCA9IHAucGFyZW50Tm9kZSB8fCBwLmhvc3Q7CiAgfQp9CgpmdW5jdGlvbiB3YXRjaFNoYWRvdyhub2RlKSB7CiAgaWYgKG5vZGUud2Via2l0U2hhZG93Um9vdCAmJiAhbm9kZS53ZWJraXRTaGFkb3dSb290Ll9fd2F0Y2hlZCkgewogICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKCd3YXRjaGluZyBzaGFkb3ctcm9vdCBmb3I6ICcsIG5vZGUubG9jYWxOYW1lKTsKICAgIG9ic2VydmUobm9kZS53ZWJraXRTaGFkb3dSb290KTsKICAgIG5vZGUud2Via2l0U2hhZG93Um9vdC5fX3dhdGNoZWQgPSB0cnVlOwogIH0KfQoKZnVuY3Rpb24gd2F0Y2hBbGxTaGFkb3dzKG5vZGUpIHsKICB3YXRjaFNoYWRvdyhub2RlKTsKICBmb3JTdWJ0cmVlKG5vZGUsIGZ1bmN0aW9uKGUpIHsKICAgIHdhdGNoU2hhZG93KG5vZGUpOwogIH0pOwp9CgpmdW5jdGlvbiBmaWx0ZXIoaW5Ob2RlKSB7CiAgc3dpdGNoIChpbk5vZGUubG9jYWxOYW1lKSB7CiAgICBjYXNlICdzdHlsZSc6CiAgICBjYXNlICdzY3JpcHQnOgogICAgY2FzZSAndGVtcGxhdGUnOgogICAgY2FzZSB1bmRlZmluZWQ6CiAgICAgIHJldHVybiB0cnVlOwogIH0KfQoKZnVuY3Rpb24gaGFuZGxlcihtdXRhdGlvbnMpIHsKICAvLwogIGlmIChsb2dGbGFncy5kb20pIHsKICAgIHZhciBteCA9IG11dGF0aW9uc1swXTsKICAgIGlmIChteCAmJiBteC50eXBlID09PSAnY2hpbGRMaXN0JyAmJiBteC5hZGRlZE5vZGVzKSB7CiAgICAgICAgaWYgKG14LmFkZGVkTm9kZXMpIHsKICAgICAgICAgIHZhciBkID0gbXguYWRkZWROb2Rlc1swXTsKICAgICAgICAgIHdoaWxlIChkICYmIGQgIT09IGRvY3VtZW50ICYmICFkLmhvc3QpIHsKICAgICAgICAgICAgZCA9IGQucGFyZW50Tm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB1ID0gZCAmJiAoZC5VUkwgfHwgZC5fVVJMIHx8IChkLmhvc3QgJiYgZC5ob3N0LmxvY2FsTmFtZSkpIHx8ICcnOwogICAgICAgICAgdSA9IHUuc3BsaXQoJy8/Jykuc2hpZnQoKS5zcGxpdCgnLycpLnBvcCgpOwogICAgICAgIH0KICAgIH0KICAgIGNvbnNvbGUuZ3JvdXAoJ211dGF0aW9ucyAoJWQpIFslc10nLCBtdXRhdGlvbnMubGVuZ3RoLCB1IHx8ICcnKTsKICB9CiAgLy8KICBtdXRhdGlvbnMuZm9yRWFjaChmdW5jdGlvbihteCkgewogICAgLy9sb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cCgnbXV0YXRpb24nKTsKICAgIGlmIChteC50eXBlID09PSAnY2hpbGRMaXN0JykgewogICAgICBmb3JFYWNoKG14LmFkZGVkTm9kZXMsIGZ1bmN0aW9uKG4pIHsKICAgICAgICAvL2xvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmxvZyhuLmxvY2FsTmFtZSk7CiAgICAgICAgaWYgKGZpbHRlcihuKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAvLyB3YXRjaCBzaGFkb3ctcm9vdHMgb24gbm9kZXMgdGhhdCBoYXZlIGhhZCB0aGVtIGF0dGFjaGVkIG1hbnVhbGx5CiAgICAgICAgLy8gVE9ETyhzam1pbGVzKTogcmVtb3ZlIGlmIGNyZWF0ZVNoYWRvd1Jvb3QgaXMgb3ZlcnJpZGRlbgogICAgICAgIC8vIFRPRE8oc2ptaWxlcyk6IHJlbW92ZWQgYXMgYW4gb3B0aW1pemF0aW9uLCBtYW51YWwgc2hhZG93IHJvb3RzCiAgICAgICAgLy8gbXVzdCBiZSB3YXRjaGVkIGV4cGxpY2l0bHkKICAgICAgICAvL3dhdGNoQWxsU2hhZG93cyhuKTsKICAgICAgICAvLyBub2RlcyBhZGRlZCBtYXkgbmVlZCBsaWZlY3ljbGUgbWFuYWdlbWVudAogICAgICAgIGFkZGVkTm9kZShuKTsKICAgICAgfSk7CiAgICAgIC8vIHJlbW92ZWQgbm9kZXMgbWF5IG5lZWQgbGlmZWN5Y2xlIG1hbmFnZW1lbnQKICAgICAgZm9yRWFjaChteC5yZW1vdmVkTm9kZXMsIGZ1bmN0aW9uKG4pIHsKICAgICAgICAvL2xvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmxvZyhuLmxvY2FsTmFtZSk7CiAgICAgICAgaWYgKGZpbHRlcihuKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICByZW1vdmVkTm9kZShuKTsKICAgICAgfSk7CiAgICB9CiAgICAvL2xvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7CiAgfSk7CiAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsKfTsKCnZhciBvYnNlcnZlciA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKGhhbmRsZXIpOwoKZnVuY3Rpb24gdGFrZVJlY29yZHMoKSB7CiAgLy8gVE9ETyhzam1pbGVzKTogYXNrIFJhZiB3aHkgd2UgaGF2ZSB0byBjYWxsIGhhbmRsZXIgb3Vyc2VsdmVzCiAgaGFuZGxlcihvYnNlcnZlci50YWtlUmVjb3JkcygpKTsKfQoKdmFyIGZvckVhY2ggPSBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsLmJpbmQoQXJyYXkucHJvdG90eXBlLmZvckVhY2gpOwoKZnVuY3Rpb24gb2JzZXJ2ZShpblJvb3QpIHsKICBvYnNlcnZlci5vYnNlcnZlKGluUm9vdCwge2NoaWxkTGlzdDogdHJ1ZSwgc3VidHJlZTogdHJ1ZX0pOwp9CgpmdW5jdGlvbiBvYnNlcnZlRG9jdW1lbnQoZG9jdW1lbnQpIHsKICBvYnNlcnZlKGRvY3VtZW50KTsKfQoKZnVuY3Rpb24gdXBncmFkZURvY3VtZW50KGRvY3VtZW50KSB7CiAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXAoJ3VwZ3JhZGVEb2N1bWVudDogJywgKGRvY3VtZW50LlVSTCB8fCBkb2N1bWVudC5fVVJMIHx8ICcnKS5zcGxpdCgnLycpLnBvcCgpKTsKICBhZGRlZE5vZGUoZG9jdW1lbnQpOwogIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7Cn0KCi8vIGV4cG9ydHMKCnNjb3BlLndhdGNoU2hhZG93ID0gd2F0Y2hTaGFkb3c7CnNjb3BlLndhdGNoQWxsU2hhZG93cyA9IHdhdGNoQWxsU2hhZG93czsKCnNjb3BlLnVwZ3JhZGVBbGwgPSBhZGRlZE5vZGU7CnNjb3BlLnVwZ3JhZGVTdWJ0cmVlID0gYWRkZWRTdWJ0cmVlOwoKc2NvcGUub2JzZXJ2ZURvY3VtZW50ID0gb2JzZXJ2ZURvY3VtZW50OwpzY29wZS51cGdyYWRlRG9jdW1lbnQgPSB1cGdyYWRlRG9jdW1lbnQ7CgpzY29wZS50YWtlUmVjb3JkcyA9IHRha2VSZWNvcmRzOwoKfSkod2luZG93LkN1c3RvbUVsZW1lbnRzKTsKCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgooZnVuY3Rpb24oKXsKCnZhciBIVE1MRWxlbWVudEVsZW1lbnQgPSBmdW5jdGlvbihpbkVsZW1lbnQpIHsKICBpbkVsZW1lbnQucmVnaXN0ZXIgPSBIVE1MRWxlbWVudEVsZW1lbnQucHJvdG90eXBlLnJlZ2lzdGVyOwogIHBhcnNlRWxlbWVudEVsZW1lbnQoaW5FbGVtZW50KTsKICByZXR1cm4gaW5FbGVtZW50Owp9OwoKSFRNTEVsZW1lbnRFbGVtZW50LnByb3RvdHlwZSA9IHsKICByZWdpc3RlcjogZnVuY3Rpb24oaW5Nb3JlKSB7CiAgICBpZiAoaW5Nb3JlKSB7CiAgICAgIHRoaXMub3B0aW9ucy5saWZlY3ljbGUgPSBpbk1vcmUubGlmZWN5Y2xlOwogICAgICBpZiAoaW5Nb3JlLnByb3RvdHlwZSkgewogICAgICAgIG1peGluKHRoaXMub3B0aW9ucy5wcm90b3R5cGUsIGluTW9yZS5wcm90b3R5cGUpOwogICAgICB9CiAgICB9CiAgfQp9OwoKZnVuY3Rpb24gcGFyc2VFbGVtZW50RWxlbWVudChpbkVsZW1lbnQpIHsKICAvLyBvcHRpb25zIHRvIGdsZWFuIGZyb20gaW5FbGVtZW50IGF0dHJpYnV0ZXMKICB2YXIgb3B0aW9ucyA9IHsKICAgIG5hbWU6ICcnLAogICAgZXh0ZW5kczogbnVsbAogIH07CiAgLy8gZ2xlYW4gdGhlbQogIHRha2VBdHRyaWJ1dGVzKGluRWxlbWVudCwgb3B0aW9ucyk7CiAgLy8gZGVmYXVsdCBiYXNlCiAgdmFyIGJhc2UgPSBIVE1MRWxlbWVudC5wcm90b3R5cGU7CiAgLy8gb3B0aW9uYWwgc3BlY2lmaWVkIGJhc2UKICBpZiAob3B0aW9ucy5leHRlbmRzKSB7CiAgICAvLyBidWlsZCBhbiBpbnN0YW5jZSBvZiBvcHRpb25zLmV4dGVuZHMKICAgIHZhciBhcmNoZXR5cGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KG9wdGlvbnMuZXh0ZW5kcyk7CiAgICAvLyBhY3F1aXJlIHRoZSBwcm90b3R5cGUKICAgIC8vIFRPRE8oc2ptaWxlcyk6IF9fcHJvdG9fXyBtYXkgYmUgaGludGVkIGJ5IHRoZSBjdXN0b20gZWxlbWVudAogICAgLy8gc3lzdGVtIG9uIHBsYXRmb3JtcyB0aGF0IGRvbid0IHN1cHBvcnQgbmF0aXZlIF9fcHJvdG9fXwogICAgLy8gb24gdGhvc2UgcGxhdGZvcm1zIHRoZSBBUEkgaXMgbWl4ZWQgaW50byBhcmNoZXR5cGUgYW5kIHRoZQogICAgLy8gZWZmZWN0aXZlIGJhc2UgaXMgbm90IGFyY2hldHlwZSdzIHJlYWwgcHJvdG90eXBlCiAgICBiYXNlID0gYXJjaGV0eXBlLl9fcHJvdG9fXyB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoYXJjaGV0eXBlKTsKICB9CiAgLy8gZXh0ZW5kIGJhc2UKICBvcHRpb25zLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoYmFzZSk7CiAgLy8gaW5zdGFsbCBvcHRpb25zCiAgaW5FbGVtZW50Lm9wdGlvbnMgPSBvcHRpb25zOwogIC8vIGxvY2F0ZSB1c2VyIHNjcmlwdAogIHZhciBzY3JpcHQgPSBpbkVsZW1lbnQucXVlcnlTZWxlY3Rvcignc2NyaXB0Om5vdChbdHlwZV0pLHNjcmlwdFt0eXBlPSJ0ZXh0L2phdmFzY3JpcHQiXSxzY3JpcHRzJyk7CiAgaWYgKHNjcmlwdCkgewogICAgLy8gZXhlY3V0ZSB1c2VyIHNjcmlwdCBpbiAnaW5FbGVtZW50JyBjb250ZXh0CiAgICBleGVjdXRlQ29tcG9uZW50U2NyaXB0KHNjcmlwdC50ZXh0Q29udGVudCwgaW5FbGVtZW50LCBvcHRpb25zLm5hbWUpOwogIH07CiAgLy8gcmVnaXN0ZXIgb3VyIG5ldyBlbGVtZW50CiAgdmFyIGN0b3IgPSBkb2N1bWVudC5yZWdpc3RlcihvcHRpb25zLm5hbWUsIG9wdGlvbnMpOwogIGluRWxlbWVudC5jdG9yID0gY3RvcjsKICAvLyBzdG9yZSBvcHRpb25hbCBjb25zdHJ1Y3RvciByZWZlcmVuY2UKICB2YXIgcmVmTmFtZSA9IGluRWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2NvbnN0cnVjdG9yJyk7CiAgaWYgKHJlZk5hbWUpIHsKICAgIHdpbmRvd1tyZWZOYW1lXSA9IGN0b3I7CiAgfQp9CgovLyBlYWNoIHByb3BlcnR5IGluIGluRGljdGlvbmFyeSB0YWtlcyBhIHZhbHVlCi8vIGZyb20gdGhlIG1hdGNoaW5nIGF0dHJpYnV0ZSBpbiBpbkVsZW1lbnQsIGlmIGFueQpmdW5jdGlvbiB0YWtlQXR0cmlidXRlcyhpbkVsZW1lbnQsIGluRGljdGlvbmFyeSkgewogIGZvciAodmFyIG4gaW4gaW5EaWN0aW9uYXJ5KSB7CiAgICB2YXIgYSA9IGluRWxlbWVudC5hdHRyaWJ1dGVzW25dOwogICAgaWYgKGEpIHsKICAgICAgaW5EaWN0aW9uYXJ5W25dID0gYS52YWx1ZTsKICAgIH0KICB9Cn0KCi8vIGludm9rZSBpblNjcmlwdCBpbiBpbkNvbnRleHQgc2NvcGUKZnVuY3Rpb24gZXhlY3V0ZUNvbXBvbmVudFNjcmlwdChpblNjcmlwdCwgaW5Db250ZXh0LCBpbk5hbWUpIHsKICAvLyBzZXQgKGhpZ2hsYW5kZXIpIGNvbnRleHQKICBjb250ZXh0ID0gaW5Db250ZXh0OwogIC8vIHNvdXJjZSBsb2NhdGlvbgogIHZhciBvd25lciA9IGNvbnRleHQub3duZXJEb2N1bWVudDsKICB2YXIgdXJsID0gKG93bmVyLl9VUkwgfHwgb3duZXIuVVJMIHx8IG93bmVyLmltcGwKICAgICAgJiYgKG93bmVyLmltcGwuX1VSTCB8fCBvd25lci5pbXBsLlVSTCkpOwogIC8vIGVuc3VyZSB0aGUgY29tcG9uZW50IGhhcyBhIHVuaXF1ZSBzb3VyY2UgbWFwIHNvIGl0IGNhbiBiZSBkZWJ1Z2dlZAogIC8vIGlmIHRoZSBuYW1lIG1hdGNoZXMgdGhlIGZpbGVuYW1lIHBhcnQgb2YgdGhlIG93bmluZyBkb2N1bWVudCdzIHVybCwKICAvLyB1c2UgdGhpcywgb3RoZXJ3aXNlLCBhZGQgIjo8bmFtZT4iIHRvIHRoZSBkb2N1bWVudCB1cmwuCiAgdmFyIG1hdGNoID0gdXJsLm1hdGNoKC8uKlwvKFteLl0qKVsuXT8uKiQvKTsKICBpZiAobWF0Y2gpIHsKICAgIHZhciBuYW1lID0gbWF0Y2hbMV07CiAgICB1cmwgKz0gbmFtZSAhPSBpbk5hbWUgPyAnOicgKyBpbk5hbWUgOiAnJzsKICB9CiAgLy8gY29tcG9zZSBzY3JpcHQKICB2YXIgY29kZSA9ICJfX2NvbXBvbmVudFNjcmlwdCgnIgogICAgKyBpbk5hbWUKICAgICsgIicsIGZ1bmN0aW9uKCl7IgogICAgKyBpblNjcmlwdAogICAgKyAifSk7IgogICAgKyAiXG4vL0Agc291cmNlVVJMPSIgKyB1cmwgKyAiXG4iCiAgOwogIC8vIGluamVjdCBzY3JpcHQKICBldmFsKGNvZGUpOwp9Cgp2YXIgY29udGV4dDsKCi8vIGdsb2JhbCBuZWNlc3NhcnkgZm9yIHNjcmlwdCBpbmplY3Rpb24Kd2luZG93Ll9fY29tcG9uZW50U2NyaXB0ID0gZnVuY3Rpb24oaW5OYW1lLCBpbkZ1bmMpIHsKICBpbkZ1bmMuY2FsbChjb250ZXh0KTsKfTsKCi8vIHV0aWxpdHkKCi8vIGNvcHkgdG9wIGxldmVsIHByb3BlcnRpZXMgZnJvbSBwcm9wcyB0byBvYmoKZnVuY3Rpb24gbWl4aW4ob2JqLCBwcm9wcykgewogIG9iaiA9IG9iaiB8fCB7fTsKICB0cnkgewogICAgT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMocHJvcHMpLmZvckVhY2goZnVuY3Rpb24obikgewogICAgICB2YXIgcGQgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHByb3BzLCBuKTsKICAgICAgaWYgKHBkKSB7CiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwgbiwgcGQpOwogICAgICB9CiAgICB9KTsKICB9IGNhdGNoKHgpIHsKICB9CiAgcmV0dXJuIG9iajsKfQoKLy8gZXhwb3J0cwoKd2luZG93LkhUTUxFbGVtZW50RWxlbWVudCA9IEhUTUxFbGVtZW50RWxlbWVudDsKCn0pKCk7CgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKKGZ1bmN0aW9uKCkgewoKdmFyIElNUE9SVF9MSU5LX1RZUEUgPSAnaW1wb3J0JzsKCi8vIGhpZ2hsYW5kZXIgb2JqZWN0IGZvciBwYXJzaW5nIGEgZG9jdW1lbnQgdHJlZQoKdmFyIGNvbXBvbmVudFBhcnNlciA9IHsKICBzZWxlY3RvcnM6IFsKICAgICdsaW5rW3JlbD0nICsgSU1QT1JUX0xJTktfVFlQRSArICddJywKICAgICdsaW5rW3JlbD1zdHlsZXNoZWV0XScsCiAgICAnc2NyaXB0W3NyY10nLAogICAgJ3NjcmlwdDpub3QoW3R5cGVdKScsCiAgICAnc2NyaXB0W3R5cGU9InRleHQvamF2YXNjcmlwdCJdJywKICAgICdzdHlsZScsCiAgICAnZWxlbWVudCcKICBdLAogIG1hcDogewogICAgbGluazogJ3BhcnNlTGluaycsCiAgICBzY3JpcHQ6ICdwYXJzZVNjcmlwdCcsCiAgICBlbGVtZW50OiAncGFyc2VFbGVtZW50JywKICAgIHN0eWxlOiAncGFyc2VTdHlsZScKICB9LAogIHBhcnNlOiBmdW5jdGlvbihpbkRvY3VtZW50KSB7CiAgICBpZiAoIWluRG9jdW1lbnQuX19wYXJzZWQpIHsKICAgICAgLy8gb25seSBwYXJzZSBvbmNlCiAgICAgIGluRG9jdW1lbnQuX19wYXJzZWQgPSB0cnVlOwogICAgICAvLyBhbGwgcGFyc2FibGUgZWxlbWVudHMgaW4gaW5Eb2N1bWVudCAoZGVwdGgtZmlyc3QgcHJlLW9yZGVyIHRyYXZlcnNhbCkKICAgICAgdmFyIGVsdHMgPSBpbkRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoY3Auc2VsZWN0b3JzKTsKICAgICAgLy8gZm9yIGVhY2ggcGFyc2FibGUgbm9kZSB0eXBlLCBjYWxsIHRoZSBtYXBwZWQgcGFyc2luZyBtZXRob2QKICAgICAgZm9yRWFjaChlbHRzLCBmdW5jdGlvbihlKSB7CiAgICAgICAgLy9jb25zb2xlLmxvZyhtYXBbZS5sb2NhbE5hbWVdICsgIjoiLCBwYXRoLm5vZGVVcmwoZSkpOwogICAgICAgIGNwW2NwLm1hcFtlLmxvY2FsTmFtZV1dKGUpOwogICAgICB9KTsKICAgICAgLy8gdXBncmFkZSBhbGwgdXBncmFkZWFibGUgc3RhdGljIGVsZW1lbnRzLCBhbnl0aGluZyBkeW5hbWljYWxseQogICAgICAvLyBjcmVhdGVkIHNob3VsZCBiZSBjYXVnaHQgYnkgb2JzZXJ2ZXIKICAgICAgQ3VzdG9tRWxlbWVudHMudXBncmFkZURvY3VtZW50KGluRG9jdW1lbnQpOwogICAgICAvLyBvYnNlcnZlIGRvY3VtZW50IGZvciBkb20gY2hhbmdlcwogICAgICBDdXN0b21FbGVtZW50cy5vYnNlcnZlRG9jdW1lbnQoaW5Eb2N1bWVudCk7CiAgICB9CiAgfSwKICBwYXJzZUxpbms6IGZ1bmN0aW9uKGluTGlua0VsdCkgewogICAgLy8gaW1wb3J0cwogICAgaWYgKGlzRG9jdW1lbnRMaW5rKGluTGlua0VsdCkpIHsKICAgICAgaWYgKGluTGlua0VsdC5jb250ZW50KSB7CiAgICAgICAgY3AucGFyc2UoaW5MaW5rRWx0LmNvbnRlbnQpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGNhbkFkZFRvTWFpbkRvdW1lbnQoaW5MaW5rRWx0KSkgewogICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKGluTGlua0VsdCk7CiAgICB9CiAgfSwKICBwYXJzZVNjcmlwdDogZnVuY3Rpb24oaW5TY3JpcHRFbHQpIHsKICAgIGlmIChjYW5BZGRUb01haW5Eb3VtZW50KGluU2NyaXB0RWx0KSkgewogICAgICAvLyBvdGhlcndpc2UsIGV2YWx1YXRlIG5vdwogICAgICB2YXIgY29kZSA9IGluU2NyaXB0RWx0Ll9fcmVzb3VyY2UgfHwgaW5TY3JpcHRFbHQudGV4dENvbnRlbnQ7CiAgICAgIGlmIChjb2RlKSB7CiAgICAgICAgY29kZSArPSAiXG4vL0Agc291cmNlVVJMPSIgKyBpblNjcmlwdEVsdC5fX25vZGVVcmwgKyAiXG4iOwogICAgICAgIGV2YWwuY2FsbCh3aW5kb3csIGNvZGUpOwogICAgICB9CiAgICB9CiAgfSwKICBwYXJzZVN0eWxlOiBmdW5jdGlvbihpblN0eWxlRWx0KSB7CiAgICBpZiAoY2FuQWRkVG9NYWluRG91bWVudChpblN0eWxlRWx0KSkgewogICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKGluU3R5bGVFbHQpOwogICAgfQogIH0sCiAgcGFyc2VFbGVtZW50OiBmdW5jdGlvbihpbkVsZW1lbnRFbHQpIHsKICAgIG5ldyBIVE1MRWxlbWVudEVsZW1lbnQoaW5FbGVtZW50RWx0KTsKICB9Cn07Cgp2YXIgY3AgPSBjb21wb25lbnRQYXJzZXI7CgovLyBub2RlcyBjYW4gYmUgbW92ZWQgdG8gdGhlIG1haW4gZG9jdW1lbnQKLy8gaWYgdGhleSBhcmUgbm90IGluIHRoZSBtYWluIGRvY3VtZW50LCBhcmUgbm90IGNoaWxkcmVuIG9mIDxlbGVtZW50PgovLyBhbmQgYXJlIGluIGEgdHJlZSBhdCBwYXJzZSB0aW1lLgpmdW5jdGlvbiBjYW5BZGRUb01haW5Eb3VtZW50KG5vZGUpIHsKICByZXR1cm4gIWluTWFpbkRvY3VtZW50KG5vZGUpCiAgICAmJiBub2RlLnBhcmVudE5vZGUKICAgICYmICFpc0VsZW1lbnRFbGVtZW50Q2hpbGQobm9kZSk7Cn0KCmZ1bmN0aW9uIGluTWFpbkRvY3VtZW50KGluRWx0KSB7CiAgcmV0dXJuIGluRWx0Lm93bmVyRG9jdW1lbnQgPT09IGRvY3VtZW50IHx8CiAgICAvLyBUT0RPKHNqbWlsZXMpOiBTaGFkb3dET01Qb2x5ZmlsbCBpbnRydXNpb24KICAgIGluRWx0Lm93bmVyRG9jdW1lbnQuaW1wbCA9PT0gZG9jdW1lbnQ7Cn0KCmZ1bmN0aW9uIGlzRG9jdW1lbnRMaW5rKGluRWx0KSB7CiAgcmV0dXJuIChpbkVsdC5sb2NhbE5hbWUgPT09ICdsaW5rJwogICAgICAmJiBpbkVsdC5nZXRBdHRyaWJ1dGUoJ3JlbCcpID09PSBJTVBPUlRfTElOS19UWVBFKTsKfQoKZnVuY3Rpb24gaXNFbGVtZW50RWxlbWVudENoaWxkKGluRWx0KSB7CiAgaWYgKGluRWx0LnBhcmVudE5vZGUgJiYgaW5FbHQucGFyZW50Tm9kZS5sb2NhbE5hbWUgPT09ICdlbGVtZW50JykgewogICAgcmV0dXJuIHRydWU7CiAgfQp9Cgp2YXIgZm9yRWFjaCA9IEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwuYmluZChBcnJheS5wcm90b3R5cGUuZm9yRWFjaCk7CgovLyBleHBvcnRzCgpDdXN0b21FbGVtZW50cy5wYXJzZXIgPSBjb21wb25lbnRQYXJzZXI7Cgp9KSgpOwovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwooZnVuY3Rpb24oKXsKCi8vIGJvb3RzdHJhcCBwYXJzaW5nCgovLyBJRSBzaGltIGZvciBDdXN0b21FdmVudAppZiAodHlwZW9mIHdpbmRvdy5DdXN0b21FdmVudCAhPT0gJ2Z1bmN0aW9uJykgewogIHdpbmRvdy5DdXN0b21FdmVudCA9IGZ1bmN0aW9uKGluVHlwZSkgewogICAgIHZhciBlID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0hUTUxFdmVudHMnKTsKICAgICBlLmluaXRFdmVudChpblR5cGUsIHRydWUsIHRydWUpOwogICAgIHJldHVybiBlOwogIH07Cn0KCmZ1bmN0aW9uIGJvb3RzdHJhcCgpIHsKICAvLyBnbyBhc3luYyBzbyBjYWxsIHN0YWNrIGNhbiB1bndpbmQKICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgLy8gcGFyc2UgZG9jdW1lbnQKICAgIEN1c3RvbUVsZW1lbnRzLnBhcnNlci5wYXJzZShkb2N1bWVudCk7CiAgICAvLyBzZXQgaW50ZXJuYWwgZmxhZwogICAgQ3VzdG9tRWxlbWVudHMucmVhZHkgPSB0cnVlOwogICAgQ3VzdG9tRWxlbWVudHMucmVhZHlUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICBpZiAod2luZG93LkhUTUxJbXBvcnRzKSB7CiAgICAgIEN1c3RvbUVsZW1lbnRzLmVsYXBzZWQgPSBDdXN0b21FbGVtZW50cy5yZWFkeVRpbWUgLSBIVE1MSW1wb3J0cy5yZWFkeVRpbWU7CiAgICB9CiAgICAvLyBub3RpZnkgc3lzdGVtCiAgICBkb2N1bWVudC5ib2R5LmRpc3BhdGNoRXZlbnQoCiAgICAgIG5ldyBDdXN0b21FdmVudCgnV2ViQ29tcG9uZW50c1JlYWR5Jywge2J1YmJsZXM6IHRydWV9KQogICAgKTsKICB9LCAwKTsKfQoKLy8gVE9ETyhzam1pbGVzKTogJ3dpbmRvdycgaGFzIG5vIHdyYXBwYWJpbGl0eSB1bmRlciBTaGFkb3dET00gcG9seWZpbGwsIHNvCi8vIHdlIGFyZSBmb3JjZWQgdG8gc3BsaXQgaW50byB0d28gdmVyc2lvbnMKCmlmICh3aW5kb3cuSFRNTEltcG9ydHMpIHsKICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdIVE1MSW1wb3J0c0xvYWRlZCcsIGJvb3RzdHJhcCk7Cn0gZWxzZSB7CiAgaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICdjb21wbGV0ZScgfHwgZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gJ2ludGVyYWN0aXZlJykgewogICAgYm9vc3RyYXAoKTsKICB9IGVsc2UgewogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBib290c3RyYXApOwogIH0KfQoKfSkoKTsKCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCihmdW5jdGlvbigpIHsKCi8vIGluamVjdCBzdHlsZSBzaGVldAp2YXIgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdHlsZScpOwpzdHlsZS50ZXh0Q29udGVudCA9ICdlbGVtZW50IHtkaXNwbGF5OiBub25lO30gLyogaW5qZWN0ZWQgYnkgcGxhdGZvcm0uanMgKi8nOwp2YXIgaGVhZCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2hlYWQnKTsKaGVhZC5pbnNlcnRCZWZvcmUoc3R5bGUsIGhlYWQuZmlyc3RDaGlsZCk7CgppZiAod2luZG93LlNoYWRvd0RPTVBvbHlmaWxsKSB7CgogIGZ1bmN0aW9uIG5vcCgpIHt9OwoKICAvLyBkaXNhYmxlIHNoYWRvdyBkb20gd2F0Y2hpbmcKICBDdXN0b21FbGVtZW50cy53YXRjaFNoYWRvdyA9IG5vcDsKICBDdXN0b21FbGVtZW50cy53YXRjaEFsbFNoYWRvd3MgPSBub3A7CgogIC8vIGVuc3VyZSB3cmFwcGVkIGlucHV0cyBmb3IgdGhlc2UgZnVuY3Rpb25zCiAgdmFyIGZucyA9IFsndXBncmFkZUFsbCcsICd1cGdyYWRlU3VidHJlZScsICdvYnNlcnZlRG9jdW1lbnQnLAogICAgICAndXBncmFkZURvY3VtZW50J107CgogIC8vIGNhY2hlIG9yaWdpbmFscwogIHZhciBvcmlnaW5hbCA9IHt9OwogIGZucy5mb3JFYWNoKGZ1bmN0aW9uKGZuKSB7CiAgICBvcmlnaW5hbFtmbl0gPSBDdXN0b21FbGVtZW50c1tmbl07CiAgfSk7CgogIC8vIG92ZXJyaWRlCiAgZm5zLmZvckVhY2goZnVuY3Rpb24oZm4pIHsKICAgIEN1c3RvbUVsZW1lbnRzW2ZuXSA9IGZ1bmN0aW9uKGluTm9kZSkgewogICAgICByZXR1cm4gb3JpZ2luYWxbZm5dKHdyYXAoaW5Ob2RlKSk7CiAgICB9OwogIH0pOwoKfQoKfSkoKTsKCihmdW5jdGlvbiAoKSB7CgovKioqIFZhcmlhYmxlcyAqKiovCgogIHZhciB3aW4gPSB3aW5kb3csCiAgICBkb2MgPSBkb2N1bWVudCwKICAgIG5vb3AgPSBmdW5jdGlvbigpe30sCiAgICByZWdleFBzZXVkb1NwbGl0ID0gLyhbXHctXSsoPzpcKFteXCldK1wpKT8pL2csCiAgICByZWdleFBzZXVkb1JlcGxhY2UgPSAvKFx3KikoPzpcKChbXlwpXSopXCkpPy8sCiAgICByZWdleERpZ2l0cyA9IC8oXGQrKS9nLAogICAga2V5cHNldWRvID0gewogICAgICBhY3Rpb246IGZ1bmN0aW9uIChwc2V1ZG8sIGV2ZW50KSB7CiAgICAgICAgcmV0dXJuIHBzZXVkby52YWx1ZS5tYXRjaChyZWdleERpZ2l0cykuaW5kZXhPZihTdHJpbmcoZXZlbnQua2V5Q29kZSkpID4gLTEgPT0gKHBzZXVkby5uYW1lID09ICdrZXlwYXNzJyk7CiAgICAgIH0KICAgIH0sCiAgICBwcmVmaXggPSAoZnVuY3Rpb24gKCkgewogICAgICB2YXIgc3R5bGVzID0gd2luLmdldENvbXB1dGVkU3R5bGUoZG9jLmRvY3VtZW50RWxlbWVudCwgJycpLAogICAgICAgICAgcHJlID0gKEFycmF5LnByb3RvdHlwZS5zbGljZQogICAgICAgICAgICAuY2FsbChzdHlsZXMpCiAgICAgICAgICAgIC5qb2luKCcnKQogICAgICAgICAgICAubWF0Y2goLy0obW96fHdlYmtpdHxtcyktLykgfHwgKHN0eWxlcy5PTGluayA9PT0gJycgJiYgWycnLCAnbyddKQogICAgICAgICAgKVsxXTsKICAgICAgcmV0dXJuIHsKICAgICAgICBkb206IHByZSA9PSAnbXMnID8gcHJlLnRvVXBwZXJDYXNlKCkgOiBwcmUsCiAgICAgICAgbG93ZXJjYXNlOiBwcmUsCiAgICAgICAgY3NzOiAnLScgKyBwcmUgKyAnLScsCiAgICAgICAganM6IHByZVswXS50b1VwcGVyQ2FzZSgpICsgcHJlLnN1YnN0cigxKQogICAgICB9OwoKICAgIH0pKCksCiAgICBtYXRjaFNlbGVjdG9yID0gRWxlbWVudC5wcm90b3R5cGUubWF0Y2hlc1NlbGVjdG9yIHx8IEVsZW1lbnQucHJvdG90eXBlW3ByZWZpeC5sb3dlcmNhc2UgKyAnTWF0Y2hlc1NlbGVjdG9yJ107CgovKioqIEZ1bmN0aW9ucyAqKiovCgovLyBVdGlsaXRpZXMKCiAgdmFyIHR5cGVPYmogPSB7fTsKICBmdW5jdGlvbiB0eXBlT2Yob2JqKSB7CiAgICByZXR1cm4gdHlwZU9iai50b1N0cmluZy5jYWxsKG9iaikubWF0Y2goL1xzKFthLXpBLVpdKykvKVsxXS50b0xvd2VyQ2FzZSgpOwogIH0KCiAgZnVuY3Rpb24gY2xvbmUoaXRlbSwgdHlwZSl7CiAgICB2YXIgZm4gPSBjbG9uZVt0eXBlIHx8IHR5cGVPZihpdGVtKV07CiAgICByZXR1cm4gZm4gPyBmbihpdGVtKSA6IGl0ZW07CiAgfQogICAgY2xvbmUub2JqZWN0ID0gZnVuY3Rpb24oc3JjKXsKICAgICAgdmFyIG9iaiA9IHt9OwogICAgICBmb3IgKHZhciBrZXkgaW4gc3JjKSBvYmpba2V5XSA9IGNsb25lKHNyY1trZXldKTsKICAgICAgcmV0dXJuIG9iajsKICAgIH07CiAgICBjbG9uZS5hcnJheSA9IGZ1bmN0aW9uKHNyYyl7CiAgICAgIHZhciBpID0gc3JjLmxlbmd0aCwgYXJyYXkgPSBuZXcgQXJyYXkoaSk7CiAgICAgIHdoaWxlIChpLS0pIGFycmF5W2ldID0gY2xvbmUoc3JjW2ldKTsKICAgICAgcmV0dXJuIGFycmF5OwogICAgfTsKCiAgdmFyIHVuc2xpY2VhYmxlID0gWydudW1iZXInLCAnYm9vbGVhbicsICdzdHJpbmcnLCAnZnVuY3Rpb24nXTsKICBmdW5jdGlvbiB0b0FycmF5KG9iail7CiAgICByZXR1cm4gdW5zbGljZWFibGUuaW5kZXhPZih0eXBlT2Yob2JqKSkgPT0gLTEgPwogICAgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwob2JqLCAwKSA6CiAgICBbb2JqXTsKICB9CgovLyBET00KICB2YXIgc3RyID0gJyc7CiAgZnVuY3Rpb24gcXVlcnkoZWxlbWVudCwgc2VsZWN0b3IpewogICAgcmV0dXJuIChzZWxlY3RvciB8fCBzdHIpLmxlbmd0aCA/IHRvQXJyYXkoZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKSkgOiBbXTsKICB9CgogIGZ1bmN0aW9uIHBhcnNlTXV0YXRpb25zKGVsZW1lbnQsIG11dGF0aW9ucykgewogICAgdmFyIGRpZmYgPSB7IGFkZGVkOiBbXSwgcmVtb3ZlZDogW10gfTsKICAgIG11dGF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKHJlY29yZCl7CiAgICAgIHJlY29yZC5fbXV0YXRpb24gPSB0cnVlOwogICAgICBmb3IgKHZhciB6IGluIGRpZmYpIHsKICAgICAgICB2YXIgdHlwZSA9IGVsZW1lbnQuX3JlY29yZHNbKHogPT0gJ2FkZGVkJykgPyAnaW5zZXJ0ZWQnIDogJ3JlbW92ZWQnXSwKICAgICAgICAgIG5vZGVzID0gcmVjb3JkW3ogKyAnTm9kZXMnXSwgbGVuZ3RoID0gbm9kZXMubGVuZ3RoOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoICYmIGRpZmZbel0uaW5kZXhPZihub2Rlc1tpXSkgPT0gLTE7IGkrKyl7CiAgICAgICAgICBkaWZmW3pdLnB1c2gobm9kZXNbaV0pOwogICAgICAgICAgdHlwZS5mb3JFYWNoKGZ1bmN0aW9uKGZuKXsKICAgICAgICAgICAgZm4obm9kZXNbaV0sIHJlY29yZCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KCi8vIE1peGlucwoKICBmdW5jdGlvbiBtZXJnZU9uZShzb3VyY2UsIGtleSwgY3VycmVudCl7CiAgICB2YXIgdHlwZSA9IHR5cGVPZihjdXJyZW50KTsKICAgIGlmICh0eXBlID09ICdvYmplY3QnICYmIHR5cGVPZihzb3VyY2Vba2V5XSkgPT0gJ29iamVjdCcpIHh0YWcubWVyZ2Uoc291cmNlW2tleV0sIGN1cnJlbnQpOwogICAgZWxzZSBzb3VyY2Vba2V5XSA9IGNsb25lKGN1cnJlbnQsIHR5cGUpOwogICAgcmV0dXJuIHNvdXJjZTsKICB9CgogIGZ1bmN0aW9uIG1lcmdlTWl4aW4odHlwZSwgbWl4aW4sIG9wdGlvbikgewogICAgdmFyIG9yaWdpbmFsID0ge307CiAgICBmb3IgKHZhciBvIGluIG9wdGlvbikgb3JpZ2luYWxbby5zcGxpdCgnOicpWzBdXSA9IHRydWU7CiAgICBmb3IgKHZhciB4IGluIG1peGluKSBpZiAoIW9yaWdpbmFsW3guc3BsaXQoJzonKVswXV0pIG9wdGlvblt4XSA9IG1peGluW3hdOwogIH0KCiAgZnVuY3Rpb24gYXBwbHlNaXhpbnModGFnKSB7CiAgICB0YWcubWl4aW5zLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgdmFyIG1peGluID0geHRhZy5taXhpbnNbbmFtZV07CiAgICAgIGZvciAodmFyIHR5cGUgaW4gbWl4aW4pIHsKICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgIGNhc2UgJ2xpZmVjeWNsZSc6IGNhc2UgJ21ldGhvZHMnOgogICAgICAgICAgICBtZXJnZU1peGluKHR5cGUsIG1peGluW3R5cGVdLCB0YWdbdHlwZV0pOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgJ2FjY2Vzc29ycyc6IGNhc2UgJ3Byb3RvdHlwZSc6CiAgICAgICAgICAgIGZvciAodmFyIHogaW4gbWl4aW5bdHlwZV0pIG1lcmdlTWl4aW4oeiwgbWl4aW5bdHlwZV0sIHRhZy5hY2Nlc3NvcnMpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgJ2V2ZW50cyc6CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gdGFnOwogIH0KCi8vIEV2ZW50cwoKICBmdW5jdGlvbiB0b3VjaEZpbHRlcihjdXN0b20sIGV2ZW50KSB7CiAgICBpZiAoY3VzdG9tLmxpc3RlbmVyLnRvdWNoZWQpIHJldHVybiBjdXN0b20ubGlzdGVuZXIudG91Y2hlZCA9IGZhbHNlOwogICAgZWxzZSB7CiAgICAgIGlmIChldmVudC50eXBlLm1hdGNoKCd0b3VjaCcpKSBjdXN0b20ubGlzdGVuZXIudG91Y2hlZCA9IHRydWU7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVGbG93RXZlbnQodHlwZSkgewogICAgdmFyIGZsb3cgPSB0eXBlID09ICdvdmVyJzsKICAgIHJldHVybiB7CiAgICAgIGJhc2U6ICdPdmVyZmxvd0V2ZW50JyBpbiB3aW4gPyAnb3ZlcmZsb3djaGFuZ2VkJyA6IHR5cGUgKyAnZmxvdycsCiAgICAgIGNvbmRpdGlvbjogZnVuY3Rpb24gKGN1c3RvbSwgZXZlbnQpIHsKICAgICAgICBldmVudC5mbG93ID0gdHlwZTsKICAgICAgICByZXR1cm4gZXZlbnQudHlwZSA9PSAodHlwZSArICdmbG93JykgfHwKICAgICAgICAoKGV2ZW50Lm9yaWVudCA9PT0gMCAmJiBldmVudC5ob3Jpem9udGFsT3ZlcmZsb3cgPT0gZmxvdykgfHwKICAgICAgICAoZXZlbnQub3JpZW50ID09IDEgJiYgZXZlbnQudmVydGljYWxPdmVyZmxvdyA9PSBmbG93KSB8fAogICAgICAgIChldmVudC5vcmllbnQgPT0gMiAmJiBldmVudC5ob3Jpem9udGFsT3ZlcmZsb3cgPT0gZmxvdyAmJiBldmVudC52ZXJ0aWNhbE92ZXJmbG93ID09IGZsb3cpKTsKICAgICAgfQogICAgfTsKICB9CgovLyBBY2Nlc3NvcnMKCiAgZnVuY3Rpb24gZ2V0QXJncyhhdHRyLCB2YWx1ZSl7CiAgICByZXR1cm4gewogICAgICB2YWx1ZTogYXR0ci5ib29sZWFuID8gJycgOiB2YWx1ZSwKICAgICAgbWV0aG9kOiBhdHRyLmJvb2xlYW4gJiYgKHZhbHVlID09PSBmYWxzZSB8fCB2YWx1ZSA9PT0gbnVsbCkgPyAncmVtb3ZlQXR0cmlidXRlJyA6ICdzZXRBdHRyaWJ1dGUnCiAgICB9OwogIH0KCiAgZnVuY3Rpb24gc2V0QXR0cihhdHRyLCBuYW1lLCB2YWx1ZSl7CiAgICB2YXIgYXJncyA9IGdldEFyZ3MoYXR0ciwgdmFsdWUpOwogICAgdGhpc1thcmdzLm1ldGhvZF0obmFtZSwgYXJncy52YWx1ZSk7CiAgfQoKICBmdW5jdGlvbiBzeW5jQXR0cihhdHRyLCBuYW1lLCB2YWx1ZSl7CiAgICB2YXIgYXJncyA9IGdldEFyZ3MoYXR0ciwgdmFsdWUpLAogICAgICAgIG5vZGVzID0gYXR0ci5wcm9wZXJ0eSA/IFt0aGlzLnh0YWdbYXR0ci5wcm9wZXJ0eV1dIDogYXR0ci5zZWxlY3RvciA/IHh0YWcucXVlcnkodGhpcywgYXR0ci5zZWxlY3RvcikgOiBbXSwKICAgICAgICBpbmRleCA9IG5vZGVzLmxlbmd0aDsKICAgIHdoaWxlIChpbmRleC0tKSBub2Rlc1tpbmRleF1bYXJncy5tZXRob2RdKG5hbWUsIGFyZ3MudmFsdWUpOwogIH0KCiAgZnVuY3Rpb24gd3JhcEF0dHIodGFnLCBtZXRob2QpewogICAgdmFyIG9yaWdpbmFsID0gdGFnLnByb3RvdHlwZVttZXRob2RdIHx8IEhUTUxFbGVtZW50LnByb3RvdHlwZVttZXRob2RdOwogICAgdGFnLnByb3RvdHlwZVttZXRob2RdID0gewogICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgZW51bWJlcmFibGU6IHRydWUsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiAobmFtZSwgdmFsdWUsIHNraXApewogICAgICAgIHZhciBhdHRyID0gdGFnLmF0dHJpYnV0ZXNbbmFtZS50b0xvd2VyQ2FzZSgpXTsKICAgICAgICBvcmlnaW5hbC5jYWxsKHRoaXMsIG5hbWUsIGF0dHIgJiYgYXR0ci5ib29sZWFuID8gJycgOiB2YWx1ZSk7CiAgICAgICAgaWYgKGF0dHIpIHsKICAgICAgICAgIHN5bmNBdHRyLmNhbGwodGhpcywgYXR0ciwgbmFtZSwgdmFsdWUpOwogICAgICAgICAgaWYgKCFhdHRyLnNraXAgJiYgIXRoaXMueHRhZy5fc2tpcEF0dHIpIHsKICAgICAgICAgICAgYXR0ci5zZXR0ZXIuY2FsbCh0aGlzLCBhdHRyLmJvb2xlYW4gPyBtZXRob2QgPT0gJ3NldEF0dHJpYnV0ZScgOiB0aGlzLmdldEF0dHJpYnV0ZShuYW1lKSk7CiAgICAgICAgICB9CiAgICAgICAgICBkZWxldGUgdGhpcy54dGFnLl9za2lwQXR0cjsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfQoKICBmdW5jdGlvbiB1cGRhdGVUZW1wbGF0ZShlbGVtZW50LCBuYW1lLCB2YWx1ZSl7CiAgICBpZiAoZWxlbWVudC50ZW1wbGF0ZSl7CiAgICAgIGVsZW1lbnQueHRhZy50ZW1wbGF0ZS51cGRhdGVCaW5kaW5nVmFsdWUoZWxlbWVudCwgbmFtZSwgdmFsdWUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gYXR0YWNoUHJvcGVydGllcyh0YWcsIHByb3AsIHosIGFjY2Vzc29yLCBhdHRyLCBuYW1lKXsKICAgIHZhciBrZXkgPSB6LnNwbGl0KCc6JyksIHR5cGUgPSBrZXlbMF07CiAgICBpZiAodHlwZSA9PSAnZ2V0JykgewogICAgICBrZXlbMF0gPSBwcm9wOwogICAgICB0YWcucHJvdG90eXBlW3Byb3BdLmdldCA9IHh0YWcuYXBwbHlQc2V1ZG9zKGtleS5qb2luKCc6JyksIGFjY2Vzc29yW3pdLCB0YWcucHNldWRvcyk7CiAgICB9CiAgICBlbHNlIGlmICh0eXBlID09ICdzZXQnKSB7CiAgICAgIGtleVswXSA9IHByb3A7CiAgICAgIGlmIChhdHRyKSBhdHRyLnNldHRlciA9IGFjY2Vzc29yW3pdOwogICAgICB0YWcucHJvdG90eXBlW3Byb3BdLnNldCA9IHh0YWcuYXBwbHlQc2V1ZG9zKGtleS5qb2luKCc6JyksIGF0dHIgPyBmdW5jdGlvbih2YWx1ZSwgc2tpcCl7CiAgICAgICAgc3luY0F0dHIuY2FsbCh0aGlzLCBhdHRyLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgYWNjZXNzb3Jbel0uY2FsbCh0aGlzLCB2YWx1ZSk7CiAgICAgICAgaWYgKCFza2lwICYmICFhdHRyLnNraXApIHsKICAgICAgICAgIHRoaXMueHRhZy5fc2tpcEF0dHIgPSB0cnVlOwogICAgICAgICAgc2V0QXR0ci5jYWxsKHRoaXMsIGF0dHIsIG5hbWUsIHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgdXBkYXRlVGVtcGxhdGUodGhpcywgbmFtZSwgdmFsdWUpOwoKICAgICAgfSA6IGFjY2Vzc29yW3pdID8gZnVuY3Rpb24odmFsdWUpewogICAgICAgIGFjY2Vzc29yW3pdLmNhbGwodGhpcywgdmFsdWUpOwogICAgICAgIHVwZGF0ZVRlbXBsYXRlKHRoaXMsIG5hbWUsIHZhbHVlKTsKICAgICAgfSA6IG51bGwsIHRhZy5wc2V1ZG9zKTsKICAgIH0KICAgIGVsc2UgdGFnLnByb3RvdHlwZVtwcm9wXVt6XSA9IGFjY2Vzc29yW3pdOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VBY2Nlc3Nvcih0YWcsIHByb3ApewogICAgdGFnLnByb3RvdHlwZVtwcm9wXSA9IHt9OwogICAgdmFyIGFjY2Vzc29yID0gdGFnLmFjY2Vzc29yc1twcm9wXSwKICAgICAgICBhdHRyID0gYWNjZXNzb3IuYXR0cmlidXRlLAogICAgICAgIG5hbWUgPSBhdHRyICYmIGF0dHIubmFtZSA/IGF0dHIubmFtZS50b0xvd2VyQ2FzZSgpIDogcHJvcDsKCiAgICBpZiAoYXR0cikgdGFnLmF0dHJpYnV0ZXNbbmFtZV0gPSBhdHRyOwogICAgZm9yICh2YXIgeiBpbiBhY2Nlc3NvcikgYXR0YWNoUHJvcGVydGllcyh0YWcsIHByb3AsIHosIGFjY2Vzc29yLCBhdHRyLCBuYW1lKTsKCiAgICBpZiAoYXR0cikgewogICAgICBpZiAoIXRhZy5wcm90b3R5cGVbcHJvcF0uZ2V0KSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IChhdHRyLmJvb2xlYW4gPyAnaGFzJyA6ICdnZXQnKSArICdBdHRyaWJ1dGUnOwogICAgICAgIHRhZy5wcm90b3R5cGVbcHJvcF0uZ2V0ID0gZnVuY3Rpb24oKXsKICAgICAgICAgIHJldHVybiB0aGlzW21ldGhvZF0obmFtZSk7CiAgICAgICAgfTsKICAgICAgfQogICAgICBpZiAoIXRhZy5wcm90b3R5cGVbcHJvcF0uc2V0KSB0YWcucHJvdG90eXBlW3Byb3BdLnNldCA9IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICB0aGlzLnh0YWcuX3NraXBBdHRyID0gdHJ1ZTsKICAgICAgICBzZXRBdHRyLmNhbGwodGhpcywgYXR0ciwgbmFtZSwgdmFsdWUpOwogICAgICAgIHVwZGF0ZVRlbXBsYXRlKHRoaXMsIG5hbWUsIHZhbHVlKTsKICAgICAgfTsKICAgIH0KICB9CgovKioqIFgtVGFnIE9iamVjdCBEZWZpbml0aW9uICoqKi8KCiAgdmFyIHh0YWcgPSB7CiAgICB0YWdzOiB7fSwKICAgIGRlZmF1bHRPcHRpb25zOiB7CiAgICAgIHBzZXVkb3M6IFtdLAogICAgICBtaXhpbnM6IFtdLAogICAgICBldmVudHM6IHt9LAogICAgICBtZXRob2RzOiB7fSwKICAgICAgYWNjZXNzb3JzOiB7CiAgICAgICAgdGVtcGxhdGU6IHsKICAgICAgICAgIGF0dHJpYnV0ZToge30sCiAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICAgICAgdmFyIGxhc3QgPSB0aGlzLmdldEF0dHJpYnV0ZSgndGVtcGxhdGUnKTsKICAgICAgICAgICAgdGhpcy54dGFnLl9fcHJldmlvdXNUZW1wbGF0ZV9fID0gbGFzdDsKICAgICAgICAgICAgeHRhZy5maXJlRXZlbnQodGhpcywgJ3RlbXBsYXRlY2hhbmdlJywgeyB0ZW1wbGF0ZTogdmFsdWUgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBsaWZlY3ljbGU6IHt9LAogICAgICBhdHRyaWJ1dGVzOiB7fSwKICAgICAgJ3Byb3RvdHlwZSc6IHsKICAgICAgICB4dGFnOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9feHRhZ19fID8gdGhpcy5fX3h0YWdfXyA6ICh0aGlzLl9feHRhZ19fID0geyBkYXRhOiB7fSB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICByZWdpc3RlcjogZnVuY3Rpb24gKG5hbWUsIG9wdGlvbnMpIHsKICAgICAgdmFyIGVsZW1lbnQsIF9uYW1lOwogICAgICBpZiAodHlwZW9mIG5hbWUgPT0gJ3N0cmluZycpIHsKICAgICAgICBfbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgfSBlbHNlIGlmIChuYW1lLm5vZGVOYW1lID09ICdFTEVNRU5UJykgewogICAgICAgIGVsZW1lbnQgPSBuYW1lOwogICAgICAgIF9uYW1lID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ25hbWUnKS50b0xvd2VyQ2FzZSgpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHRhZyA9IHh0YWcudGFnc1tfbmFtZV0gPSBhcHBseU1peGlucyh4dGFnLm1lcmdlKHt9LCB4dGFnLmRlZmF1bHRPcHRpb25zLCBvcHRpb25zKSk7CgogICAgICBmb3IgKHZhciB6IGluIHRhZy5ldmVudHMpIHRhZy5ldmVudHNbel0gPSB4dGFnLnBhcnNlRXZlbnQoeiwgdGFnLmV2ZW50c1t6XSk7CiAgICAgIGZvciAoeiBpbiB0YWcubGlmZWN5Y2xlKSB0YWcubGlmZWN5Y2xlW3ouc3BsaXQoJzonKVswXV0gPSB4dGFnLmFwcGx5UHNldWRvcyh6LCB0YWcubGlmZWN5Y2xlW3pdLCB0YWcucHNldWRvcyk7CiAgICAgIGZvciAoeiBpbiB0YWcubWV0aG9kcykgdGFnLnByb3RvdHlwZVt6LnNwbGl0KCc6JylbMF1dID0geyB2YWx1ZTogeHRhZy5hcHBseVBzZXVkb3MoeiwgdGFnLm1ldGhvZHNbel0sIHRhZy5wc2V1ZG9zKSwgZW51bWVyYWJsZTogdHJ1ZSB9OwogICAgICBmb3IgKHogaW4gdGFnLmFjY2Vzc29ycykgcGFyc2VBY2Nlc3Nvcih0YWcsIHopOwoKICAgICAgdmFyIHJlYWR5ID0gdGFnLmxpZmVjeWNsZS5jcmVhdGVkIHx8IHRhZy5saWZlY3ljbGUucmVhZHk7CiAgICAgIHRhZy5wcm90b3R5cGUucmVhZHlDYWxsYmFjayA9IHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbigpewogICAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzOwogICAgICAgICAgdmFyIHRlbXBsYXRlID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3RlbXBsYXRlJyk7CiAgICAgICAgICBpZiAodGVtcGxhdGUpewogICAgICAgICAgICB4dGFnLmZpcmVFdmVudCh0aGlzLCAndGVtcGxhdGVjaGFuZ2UnLCB7IHRlbXBsYXRlOiB0ZW1wbGF0ZSB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHh0YWcuYWRkRXZlbnRzKHRoaXMsIHRhZy5ldmVudHMpOwogICAgICAgICAgdGFnLm1peGlucy5mb3JFYWNoKGZ1bmN0aW9uKG1peGluKXsKICAgICAgICAgICAgaWYgKHh0YWcubWl4aW5zW21peGluXS5ldmVudHMpIHh0YWcuYWRkRXZlbnRzKGVsZW1lbnQsIHh0YWcubWl4aW5zW21peGluXS5ldmVudHMpOwogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgb3V0cHV0ID0gcmVhZHkgPyByZWFkeS5hcHBseSh0aGlzLCB0b0FycmF5KGFyZ3VtZW50cykpIDogbnVsbDsKICAgICAgICAgIGZvciAodmFyIG5hbWUgaW4gdGFnLmF0dHJpYnV0ZXMpIHsKICAgICAgICAgICAgdmFyIGF0dHIgPSB0YWcuYXR0cmlidXRlc1tuYW1lXSwKICAgICAgICAgICAgICAgIGhhc0F0dHIgPSB0aGlzLmhhc0F0dHJpYnV0ZShuYW1lKSwKICAgICAgICAgICAgICAgIHZhbHVlID0gYXR0ci5ib29sZWFuID8gaGFzQXR0ciA6IHRoaXMuZ2V0QXR0cmlidXRlKG5hbWUpOwogICAgICAgICAgICBpZiAoYXR0ci5ib29sZWFuIHx8IGhhc0F0dHIpIHsKICAgICAgICAgICAgICBzeW5jQXR0ci5jYWxsKHRoaXMsIGF0dHIsIG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICBpZiAoYXR0ci5zZXR0ZXIpIGF0dHIuc2V0dGVyLmNhbGwodGhpcywgdmFsdWUsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0YWcucHNldWRvcy5mb3JFYWNoKGZ1bmN0aW9uKG9iail7CiAgICAgICAgICAgIG9iai5vbkFkZC5jYWxsKGVsZW1lbnQsIG9iaik7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgaWYgKHRhZy5saWZlY3ljbGUuaW5zZXJ0ZWQpIHRhZy5wcm90b3R5cGUuaW5zZXJ0ZWRDYWxsYmFjayA9IHsgdmFsdWU6IHRhZy5saWZlY3ljbGUuaW5zZXJ0ZWQsIGVudW1lcmFibGU6IHRydWUgfTsKICAgICAgaWYgKHRhZy5saWZlY3ljbGUucmVtb3ZlZCkgdGFnLnByb3RvdHlwZS5yZW1vdmVkQ2FsbGJhY2sgPSB7IHZhbHVlOiB0YWcubGlmZWN5Y2xlLnJlbW92ZWQsIGVudW1lcmFibGU6IHRydWUgfTsKICAgICAgaWYgKHRhZy5saWZlY3ljbGUuYXR0cmlidXRlQ2hhbmdlZCkgdGFnLnByb3RvdHlwZS5hdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sgPSB7IHZhbHVlOiB0YWcubGlmZWN5Y2xlLmF0dHJpYnV0ZUNoYW5nZWQsIGVudW1lcmFibGU6IHRydWUgfTsKCiAgICAgIHdyYXBBdHRyKHRhZywgJ3NldEF0dHJpYnV0ZScpOwogICAgICB3cmFwQXR0cih0YWcsICdyZW1vdmVBdHRyaWJ1dGUnKTsKCiAgICAgIGlmIChlbGVtZW50KXsKICAgICAgICBlbGVtZW50LnJlZ2lzdGVyKHsKICAgICAgICAgICdwcm90b3R5cGUnOiBPYmplY3QuY3JlYXRlKE9iamVjdC5wcm90b3R5cGUsIHRhZy5wcm90b3R5cGUpCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGRvYy5yZWdpc3RlcihfbmFtZSwgewogICAgICAgICAgJ2V4dGVuZHMnOiBvcHRpb25zWydleHRlbmRzJ10sCiAgICAgICAgICAncHJvdG90eXBlJzogT2JqZWN0LmNyZWF0ZShPYmplY3QuY3JlYXRlKChvcHRpb25zWydleHRlbmRzJ10gPwogICAgICAgICAgICBkb2N1bWVudC5jcmVhdGVFbGVtZW50KG9wdGlvbnNbJ2V4dGVuZHMnXSkuY29uc3RydWN0b3IgOgogICAgICAgICAgICB3aW4uSFRNTEVsZW1lbnQpLnByb3RvdHlwZSwgdGFnLnByb3RvdHlwZSksIHRhZy5wcm90b3R5cGUpCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCgogICAgLyogRXhwb3NlZCBWYXJpYWJsZXMgKi8KCiAgICBtaXhpbnM6IHt9LAogICAgcHJlZml4OiBwcmVmaXgsCiAgICB0ZW1wbGF0ZXM6IHt9LAogICAgY2FwdHVyZUV2ZW50czogWydmb2N1cycsICdibHVyJ10sCiAgICBjdXN0b21FdmVudHM6IHsKICAgICAgb3ZlcmZsb3c6IGNyZWF0ZUZsb3dFdmVudCgnb3ZlcicpLAogICAgICB1bmRlcmZsb3c6IGNyZWF0ZUZsb3dFdmVudCgndW5kZXInKSwKICAgICAgYW5pbWF0aW9uc3RhcnQ6IHsKICAgICAgICBiYXNlOiBbCiAgICAgICAgICAnYW5pbWF0aW9uc3RhcnQnLAogICAgICAgICAgJ29BbmltYXRpb25TdGFydCcsCiAgICAgICAgICAnTVNBbmltYXRpb25TdGFydCcsCiAgICAgICAgICAnd2Via2l0QW5pbWF0aW9uU3RhcnQnCiAgICAgICAgXQogICAgICB9LAogICAgICB0cmFuc2l0aW9uZW5kOiB7CiAgICAgICAgYmFzZTogWwogICAgICAgICAgJ3RyYW5zaXRpb25lbmQnLAogICAgICAgICAgJ29UcmFuc2l0aW9uRW5kJywKICAgICAgICAgICdNU1RyYW5zaXRpb25FbmQnLAogICAgICAgICAgJ3dlYmtpdFRyYW5zaXRpb25FbmQnCiAgICAgICAgXQogICAgICB9LAogICAgICB0YXA6IHsKICAgICAgICBiYXNlOiBbJ2NsaWNrJywgJ3RvdWNoZW5kJ10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICB0YXBzdGFydDogewogICAgICAgIGJhc2U6IFsnbW91c2Vkb3duJywgJ3RvdWNoc3RhcnQnXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0sCiAgICAgIHRhcGVuZDogewogICAgICAgIGJhc2U6IFsnbW91c2V1cCcsICd0b3VjaGVuZCddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgdGFwZW50ZXI6IHsKICAgICAgICBiYXNlOiBbJ21vdXNlb3ZlcicsICd0b3VjaGVudGVyJ10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICB0YXBsZWF2ZTogewogICAgICAgIGJhc2U6IFsnbW91c2VvdXQnLCAndG91Y2hsZWF2ZSddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgdGFwbW92ZTogewogICAgICAgIGJhc2U6IFsnbW91c2Vtb3ZlJywgJ3RvdWNobW92ZSddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfQogICAgfSwKICAgIHBzZXVkb3M6IHsKICAgICAga2V5cGFzczoga2V5cHNldWRvLAogICAgICBrZXlmYWlsOiBrZXlwc2V1ZG8sCiAgICAgIGRlbGVnYXRlOiB7CiAgICAgICAgYWN0aW9uOiBmdW5jdGlvbiAocHNldWRvLCBldmVudCkgewogICAgICAgICAgdmFyIHRhcmdldCA9IHF1ZXJ5KHRoaXMsIHBzZXVkby52YWx1ZSkuZmlsdGVyKGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBub2RlID09IGV2ZW50LnRhcmdldCB8fCBub2RlLmNvbnRhaW5zID8gbm9kZS5jb250YWlucyhldmVudC50YXJnZXQpIDogZmFsc2U7CiAgICAgICAgICB9KVswXTsKICAgICAgICAgIHJldHVybiB0YXJnZXQgPyBwc2V1ZG8ubGlzdGVuZXIgPSBwc2V1ZG8ubGlzdGVuZXIuYmluZCh0YXJnZXQpIDogZmFsc2U7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmV2ZW50YWJsZTogewogICAgICAgIGFjdGlvbjogZnVuY3Rpb24gKHBzZXVkbywgZXZlbnQpIHsKICAgICAgICAgIHJldHVybiAhZXZlbnQuZGVmYXVsdFByZXZlbnRlZDsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgLyogVVRJTElUSUVTICovCgogICAgY2xvbmU6IGNsb25lLAogICAgdHlwZU9mOiB0eXBlT2YsCiAgICB0b0FycmF5OiB0b0FycmF5LAoKICAgIHdyYXA6IGZ1bmN0aW9uIChvcmlnaW5hbCwgZm4pIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cyksCiAgICAgICAgICByZXR1cm5lZCA9IG9yaWdpbmFsLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIHJldHVybiByZXR1cm5lZCA9PT0gZmFsc2UgPyBmYWxzZSA6IGZuLmFwcGx5KHRoaXMsIHR5cGVvZiByZXR1cm5lZCAhPSAndW5kZWZpbmVkJyA/IHRvQXJyYXkocmV0dXJuZWQpIDogYXJncyk7CiAgICAgIH07CiAgICB9LAoKICAgIG1lcmdlOiBmdW5jdGlvbihzb3VyY2UsIGssIHYpewogICAgICBpZiAodHlwZU9mKGspID09ICdzdHJpbmcnKSByZXR1cm4gbWVyZ2VPbmUoc291cmNlLCBrLCB2KTsKICAgICAgZm9yICh2YXIgaSA9IDEsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKICAgICAgICB2YXIgb2JqZWN0ID0gYXJndW1lbnRzW2ldOwogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIG1lcmdlT25lKHNvdXJjZSwga2V5LCBvYmplY3Rba2V5XSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHNvdXJjZTsKICAgIH0sCgogICAgLyogRE9NICovCgogICAgcXVlcnk6IHF1ZXJ5LAoKICAgIHNraXBUcmFuc2l0aW9uOiBmdW5jdGlvbihlbGVtZW50LCBmbiwgYmluZCl7CiAgICAgIHZhciBwcm9wID0gcHJlZml4LmpzICsgJ1RyYW5zaXRpb25Qcm9wZXJ0eSc7CiAgICAgIGVsZW1lbnQuc3R5bGVbcHJvcF0gPSBlbGVtZW50LnN0eWxlLnRyYW5zaXRpb25Qcm9wZXJ0eSA9ICdub25lJzsKICAgICAgeHRhZy5yZXF1ZXN0RnJhbWUoZnVuY3Rpb24oKXsKICAgICAgICB2YXIgY2FsbGJhY2s7CiAgICAgICAgaWYgKGZuKSBjYWxsYmFjayA9IGZuLmNhbGwoYmluZCk7CiAgICAgICAgeHRhZy5yZXF1ZXN0RnJhbWUoZnVuY3Rpb24oKXsKICAgICAgICAgIGVsZW1lbnQuc3R5bGVbcHJvcF0gPSBlbGVtZW50LnN0eWxlLnRyYW5zaXRpb25Qcm9wZXJ0eSA9ICcnOwogICAgICAgICAgaWYgKGNhbGxiYWNrKSB4dGFnLnJlcXVlc3RGcmFtZShjYWxsYmFjayk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSwKCiAgICByZXF1ZXN0RnJhbWU6IChmdW5jdGlvbigpewogICAgICB2YXIgcmFmID0gd2luLnJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgIHdpbltwcmVmaXgubG93ZXJjYXNlICsgJ1JlcXVlc3RBbmltYXRpb25GcmFtZSddIHx8CiAgICAgICAgZnVuY3Rpb24oZm4peyByZXR1cm4gd2luLnNldFRpbWVvdXQoZm4sIDIwKTsgfTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGZuKXsKICAgICAgICByZXR1cm4gcmFmLmNhbGwod2luLCBmbik7CiAgICAgIH07CiAgICB9KSgpLAoKICAgIG1hdGNoU2VsZWN0b3I6IGZ1bmN0aW9uIChlbGVtZW50LCBzZWxlY3RvcikgewogICAgICByZXR1cm4gbWF0Y2hTZWxlY3Rvci5jYWxsKGVsZW1lbnQsIHNlbGVjdG9yKTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAoZWxlbWVudCwgbWV0aG9kLCB2YWx1ZSkgewogICAgICBlbGVtZW50W21ldGhvZF0gPSB2YWx1ZTsKICAgICAgaWYgKHdpbmRvdy5DdXN0b21FbGVtZW50cykgQ3VzdG9tRWxlbWVudHMudXBncmFkZUFsbChlbGVtZW50KTsKICAgIH0sCgogICAgaW5uZXJIVE1MOiBmdW5jdGlvbihlbCwgaHRtbCl7CiAgICAgIHh0YWcuc2V0KGVsLCAnaW5uZXJIVE1MJywgaHRtbCk7CiAgICB9LAoKICAgIGhhc0NsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwga2xhc3MpIHsKICAgICAgcmV0dXJuIGVsZW1lbnQuY2xhc3NOYW1lLnNwbGl0KCcgJykuaW5kZXhPZihrbGFzcy50cmltKCkpPi0xOwogICAgfSwKCiAgICBhZGRDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGtsYXNzKSB7CiAgICAgIHZhciBsaXN0ID0gZWxlbWVudC5jbGFzc05hbWUudHJpbSgpLnNwbGl0KCcgJyk7CiAgICAgIGtsYXNzLnRyaW0oKS5zcGxpdCgnICcpLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICBpZiAoIX5saXN0LmluZGV4T2YobmFtZSkpIGxpc3QucHVzaChuYW1lKTsKICAgICAgfSk7CiAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gbGlzdC5qb2luKCcgJykudHJpbSgpOwogICAgICByZXR1cm4gZWxlbWVudDsKICAgIH0sCgogICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uIChlbGVtZW50LCBrbGFzcykgewogICAgICB2YXIgY2xhc3NlcyA9IGtsYXNzLnRyaW0oKS5zcGxpdCgnICcpOwogICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGVsZW1lbnQuY2xhc3NOYW1lLnRyaW0oKS5zcGxpdCgnICcpLmZpbHRlcihmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHJldHVybiBuYW1lICYmICF+Y2xhc3Nlcy5pbmRleE9mKG5hbWUpOwogICAgICB9KS5qb2luKCcgJyk7CiAgICAgIHJldHVybiBlbGVtZW50OwogICAgfSwKCiAgICB0b2dnbGVDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGtsYXNzKSB7CiAgICAgIHJldHVybiB4dGFnW3h0YWcuaGFzQ2xhc3MoZWxlbWVudCwga2xhc3MpID8gJ3JlbW92ZUNsYXNzJyA6ICdhZGRDbGFzcyddLmNhbGwobnVsbCwgZWxlbWVudCwga2xhc3MpOwoKICAgIH0sCgogICAgcXVlcnlDaGlsZHJlbjogZnVuY3Rpb24gKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICAgIHZhciBpZCA9IGVsZW1lbnQuaWQsCiAgICAgICAgZ3VpZCA9IGVsZW1lbnQuaWQgPSBpZCB8fCAneF8nICsgbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAgYXR0ciA9ICcjJyArIGd1aWQgKyAnID4gJzsKICAgICAgc2VsZWN0b3IgPSBhdHRyICsgKHNlbGVjdG9yICsgJycpLnJlcGxhY2UoJywnLCAnLCcgKyBhdHRyLCAnZycpOwogICAgICB2YXIgcmVzdWx0ID0gZWxlbWVudC5wYXJlbnROb2RlLnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpOwogICAgICBpZiAoIWlkKSBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZSgnaWQnKTsKICAgICAgcmV0dXJuIHRvQXJyYXkocmVzdWx0KTsKICAgIH0sCgogICAgY3JlYXRlRnJhZ21lbnQ6IGZ1bmN0aW9uKGNvbnRlbnQpIHsKICAgICAgdmFyIGZyYWcgPSBkb2MuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICBpZiAoY29udGVudCkgewogICAgICAgIHZhciBkaXYgPSBmcmFnLmFwcGVuZENoaWxkKGRvYy5jcmVhdGVFbGVtZW50KCdkaXYnKSksCiAgICAgICAgICBub2RlcyA9IHRvQXJyYXkoY29udGVudC5ub2RlTmFtZSA/IGFyZ3VtZW50cyA6ICEoZGl2LmlubmVySFRNTCA9IGNvbnRlbnQpIHx8IGRpdi5jaGlsZHJlbiksCiAgICAgICAgICBsZW5ndGggPSBub2Rlcy5sZW5ndGgsCiAgICAgICAgICBpbmRleCA9IDA7CiAgICAgICAgd2hpbGUgKGluZGV4IDwgbGVuZ3RoKSBmcmFnLmluc2VydEJlZm9yZShub2Rlc1tpbmRleCsrXSwgZGl2KTsKICAgICAgICBmcmFnLnJlbW92ZUNoaWxkKGRpdik7CiAgICAgIH0KICAgICAgcmV0dXJuIGZyYWc7CiAgICB9LAoKICAgIG1hbmlwdWxhdGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGZuKXsKICAgICAgdmFyIG5leHQgPSBlbGVtZW50Lm5leHRTaWJsaW5nLAogICAgICAgIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZSwKICAgICAgICBmcmFnID0gZG9jLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwKICAgICAgICByZXR1cm5lZCA9IGZuLmNhbGwoZnJhZy5hcHBlbmRDaGlsZChlbGVtZW50KSwgZnJhZykgfHwgZWxlbWVudDsKICAgICAgaWYgKG5leHQpIHBhcmVudC5pbnNlcnRCZWZvcmUocmV0dXJuZWQsIG5leHQpOwogICAgICBlbHNlIHBhcmVudC5hcHBlbmRDaGlsZChyZXR1cm5lZCk7CiAgICB9LAoKICAgIC8qIFBTRVVET1MgKi8KCiAgICBhcHBseVBzZXVkb3M6IGZ1bmN0aW9uKGtleSwgZm4sIGVsZW1lbnQpIHsKICAgICAgdmFyIGxpc3RlbmVyID0gZm4sCiAgICAgICAgICBwc2V1ZG9zID0ge307CiAgICAgIGlmIChrZXkubWF0Y2goJzonKSkgewogICAgICAgIHZhciBzcGxpdCA9IGtleS5tYXRjaChyZWdleFBzZXVkb1NwbGl0KSwKICAgICAgICAgICAgaSA9IHNwbGl0Lmxlbmd0aDsKICAgICAgICB3aGlsZSAoLS1pKSB7CiAgICAgICAgICBzcGxpdFtpXS5yZXBsYWNlKHJlZ2V4UHNldWRvUmVwbGFjZSwgZnVuY3Rpb24gKG1hdGNoLCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoIXh0YWcucHNldWRvc1tuYW1lXSkgdGhyb3cgInBzZXVkbyBub3QgZm91bmQ6ICIgKyBuYW1lICsgIiAiICsgc3BsaXQ7CiAgICAgICAgICAgIHZhciBwc2V1ZG8gPSBwc2V1ZG9zW2ldID0gT2JqZWN0LmNyZWF0ZSh4dGFnLnBzZXVkb3NbbmFtZV0pOwogICAgICAgICAgICAgICAgcHNldWRvLmtleSA9IGtleTsKICAgICAgICAgICAgICAgIHBzZXVkby5uYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIHBzZXVkby52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICB2YXIgbGFzdCA9IGxpc3RlbmVyOwogICAgICAgICAgICBsaXN0ZW5lciA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cyksCiAgICAgICAgICAgICAgICAgIG9iaiA9IHsKICAgICAgICAgICAgICAgICAgICBrZXk6IGtleSwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZSwKICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcjogbGFzdAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGlmIChwc2V1ZG8uYWN0aW9uICYmIHBzZXVkby5hY3Rpb24uYXBwbHkodGhpcywgW29ial0uY29uY2F0KGFyZ3MpKSA9PT0gZmFsc2UpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICByZXR1cm4gb2JqLmxpc3RlbmVyLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAoZWxlbWVudCAmJiBwc2V1ZG8ub25BZGQpIHsKICAgICAgICAgICAgICBpZiAoZWxlbWVudC5nZXRBdHRyaWJ1dGUpIHsKICAgICAgICAgICAgICAgIHBzZXVkby5vbkFkZC5jYWxsKGVsZW1lbnQsIHBzZXVkbyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQucHVzaChwc2V1ZG8pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZvciAodmFyIHogaW4gcHNldWRvcykgewogICAgICAgIGlmIChwc2V1ZG9zW3pdLm9uQ29tcGlsZWQpIGxpc3RlbmVyID0gcHNldWRvc1t6XS5vbkNvbXBpbGVkKGxpc3RlbmVyLCBwc2V1ZG9zW3pdKTsKICAgICAgfQogICAgICByZXR1cm4gbGlzdGVuZXI7CiAgICB9LAoKICAgIHJlbW92ZVBzZXVkb3M6IGZ1bmN0aW9uKGVsZW1lbnQsIGV2ZW50KXsKICAgICAgZXZlbnQuX3BzZXVkb3MuZm9yRWFjaChmdW5jdGlvbihvYmopewogICAgICAgIG9iai5vblJlbW92ZS5jYWxsKGVsZW1lbnQsIG9iaik7CiAgICAgIH0pOwogICAgfSwKCiAgLyoqKiBFdmVudHMgKioqLwoKICAgIHBhcnNlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKSB7CiAgICAgIHZhciBwc2V1ZG9zID0gdHlwZS5zcGxpdCgnOicpLAogICAgICAgIGtleSA9IHBzZXVkb3Muc2hpZnQoKSwKICAgICAgICBldmVudCA9IHh0YWcubWVyZ2UoewogICAgICAgICAgYmFzZToga2V5LAogICAgICAgICAgcHNldWRvczogJycsCiAgICAgICAgICBfcHNldWRvczogW10sCiAgICAgICAgICBvbkFkZDogbm9vcCwKICAgICAgICAgIG9uUmVtb3ZlOiBub29wLAogICAgICAgICAgY29uZGl0aW9uOiBub29wCiAgICAgICAgfSwgeHRhZy5jdXN0b21FdmVudHNba2V5XSB8fCB7fSk7CiAgICAgIGV2ZW50LnR5cGUgPSBrZXkgKyAoZXZlbnQucHNldWRvcy5sZW5ndGggPyAnOicgKyBldmVudC5wc2V1ZG9zIDogJycpICsgKHBzZXVkb3MubGVuZ3RoID8gJzonICsgcHNldWRvcy5qb2luKCc6JykgOiAnJyk7CiAgICAgIGlmIChmbikgewogICAgICAgIHZhciBjaGFpbmVkID0geHRhZy5hcHBseVBzZXVkb3MoZXZlbnQudHlwZSwgZm4sIGV2ZW50Ll9wc2V1ZG9zKTsKICAgICAgICBldmVudC5saXN0ZW5lciA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICB2YXIgYXJncyA9IHRvQXJyYXkoYXJndW1lbnRzKTsKICAgICAgICAgIGlmIChldmVudC5jb25kaXRpb24uYXBwbHkodGhpcywgW2V2ZW50XS5jb25jYXQoYXJncykpID09PSBmYWxzZSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgcmV0dXJuIGNoYWluZWQuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgfTsKICAgICAgfQogICAgICByZXR1cm4gZXZlbnQ7CiAgICB9LAoKICAgIGFkZEV2ZW50OiBmdW5jdGlvbiAoZWxlbWVudCwgdHlwZSwgZm4pIHsKICAgICAgdmFyIGV2ZW50ID0gKHR5cGVvZiBmbiA9PSAnZnVuY3Rpb24nKSA/IHh0YWcucGFyc2VFdmVudCh0eXBlLCBmbikgOiBmbjsKICAgICAgZXZlbnQubGlzdGVuZXIuZXZlbnQgPSBldmVudDsKICAgICAgZXZlbnQuX3BzZXVkb3MuZm9yRWFjaChmdW5jdGlvbihvYmopewogICAgICAgIG9iai5vbkFkZC5jYWxsKGVsZW1lbnQsIG9iaik7CiAgICAgIH0pOwogICAgICBldmVudC5vbkFkZC5jYWxsKGVsZW1lbnQsIGV2ZW50LCBldmVudC5saXN0ZW5lcik7CiAgICAgIHRvQXJyYXkoZXZlbnQuYmFzZSkuZm9yRWFjaChmdW5jdGlvbiAobmFtZSkgewogICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihuYW1lLCBldmVudC5saXN0ZW5lciwgeHRhZy5jYXB0dXJlRXZlbnRzLmluZGV4T2YobmFtZSkgPiAtMSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gZXZlbnQubGlzdGVuZXI7CiAgICB9LAoKICAgIGFkZEV2ZW50czogZnVuY3Rpb24gKGVsZW1lbnQsIGV2ZW50cykgewogICAgICB2YXIgbGlzdGVuZXJzID0ge307CiAgICAgIGZvciAodmFyIHogaW4gZXZlbnRzKSB7CiAgICAgICAgbGlzdGVuZXJzW3pdID0geHRhZy5hZGRFdmVudChlbGVtZW50LCB6LCBldmVudHNbel0pOwogICAgICB9CiAgICAgIHJldHVybiBsaXN0ZW5lcnM7CiAgICB9LAoKICAgIHJlbW92ZUV2ZW50OiBmdW5jdGlvbiAoZWxlbWVudCwgdHlwZSwgZm4pIHsKICAgICAgdmFyIGV2ZW50ID0gZm4uZXZlbnQ7CiAgICAgIGV2ZW50Lm9uUmVtb3ZlLmNhbGwoZWxlbWVudCwgZXZlbnQsIGZuKTsKICAgICAgeHRhZy5yZW1vdmVQc2V1ZG9zKGVsZW1lbnQsIGV2ZW50KTsKICAgICAgdG9BcnJheShldmVudC5iYXNlKS5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKG5hbWUsIGZuKTsKICAgICAgfSk7CiAgICB9LAoKICAgIHJlbW92ZUV2ZW50czogZnVuY3Rpb24oZWxlbWVudCwgbGlzdGVuZXJzKXsKICAgICAgZm9yICh2YXIgeiBpbiBsaXN0ZW5lcnMpIHh0YWcucmVtb3ZlRXZlbnQoZWxlbWVudCwgeiwgbGlzdGVuZXJzW3pdKTsKICAgIH0sCgogICAgZmlyZUV2ZW50OiBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBkYXRhLCBvcHRpb25zKXsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHZhciBldmVudCA9IGRvYy5jcmVhdGVFdmVudCgnRXZlbnQnKTsKICAgICAgZXZlbnQuaW5pdEV2ZW50KHR5cGUsICdidWJibGVzJyBpbiBvcHRpb25zID8gb3B0aW9ucy5idWJibGVzIDogdHJ1ZSwgJ2NhbmNlbGFibGUnIGluIG9wdGlvbnMgPyBvcHRpb25zLmNhbmNlbGFibGUgOiB0cnVlKTsKICAgICAgZm9yICh2YXIgeiBpbiBkYXRhKSBldmVudFt6XSA9IGRhdGFbel07CiAgICAgIGVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICB9LAoKICAgIGFkZE9ic2VydmVyOiBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBmbil7CiAgICAgIGlmICghZWxlbWVudC5fcmVjb3JkcykgewogICAgICAgIGVsZW1lbnQuX3JlY29yZHMgPSB7IGluc2VydGVkOiBbXSwgcmVtb3ZlZDogW10gfTsKICAgICAgICBpZiAobXV0YXRpb24pewogICAgICAgICAgZWxlbWVudC5fb2JzZXJ2ZXIgPSBuZXcgbXV0YXRpb24oZnVuY3Rpb24obXV0YXRpb25zKSB7CiAgICAgICAgICAgIHBhcnNlTXV0YXRpb25zKGVsZW1lbnQsIG11dGF0aW9ucyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGVsZW1lbnQuX29ic2VydmVyLm9ic2VydmUoZWxlbWVudCwgewogICAgICAgICAgICBzdWJ0cmVlOiB0cnVlLAogICAgICAgICAgICBjaGlsZExpc3Q6IHRydWUsCiAgICAgICAgICAgIGF0dHJpYnV0ZXM6ICF0cnVlLAogICAgICAgICAgICBjaGFyYWN0ZXJEYXRhOiBmYWxzZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgWydJbnNlcnRlZCcsICdSZW1vdmVkJ10uZm9yRWFjaChmdW5jdGlvbih0eXBlKXsKICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NTm9kZScgKyB0eXBlLCBmdW5jdGlvbihldmVudCl7CiAgICAgICAgICAgIGV2ZW50Ll9tdXRhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIGVsZW1lbnQuX3JlY29yZHNbdHlwZS50b0xvd2VyQ2FzZSgpXS5mb3JFYWNoKGZ1bmN0aW9uKGZuKXsKICAgICAgICAgICAgICBmbihldmVudC50YXJnZXQsIGV2ZW50KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LCBmYWxzZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKGVsZW1lbnQuX3JlY29yZHNbdHlwZV0uaW5kZXhPZihmbikgPT0gLTEpIGVsZW1lbnQuX3JlY29yZHNbdHlwZV0ucHVzaChmbik7CiAgICB9LAoKICAgIHJlbW92ZU9ic2VydmVyOiBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBmbil7CiAgICAgIHZhciBvYmogPSBlbGVtZW50Ll9yZWNvcmRzOwogICAgICBpZiAob2JqICYmIGZuKXsKICAgICAgICBvYmpbdHlwZV0uc3BsaWNlKG9ialt0eXBlXS5pbmRleE9mKGZuKSwgMSk7CiAgICAgIH0KICAgICAgZWxzZXsKICAgICAgICBvYmpbdHlwZV0gPSBbXTsKICAgICAgfQogICAgfQoKICB9OwoKICBpZiAodHlwZW9mIGRlZmluZSA9PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIGRlZmluZSh4dGFnKTsKICBlbHNlIHdpbi54dGFnID0geHRhZzsKCiAgZG9jLmFkZEV2ZW50TGlzdGVuZXIoJ1dlYkNvbXBvbmVudHNSZWFkeScsIGZ1bmN0aW9uKCl7CiAgICB4dGFnLmZpcmVFdmVudChkb2MuYm9keSwgJ0RPTUNvbXBvbmVudHNMb2FkZWQnKTsKICB9KTsKCn0pKCk7",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sun, 09 Nov 2014 03:42:03 GMT",
                    "Content-Length": "67524",
                    "Date": "Sun, 09 Nov 2014 03:42:03 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}