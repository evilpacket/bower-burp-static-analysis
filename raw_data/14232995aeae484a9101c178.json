{
    "url": "http://localhost:9999/marcorinck/jquery-mobile-iscrollview/demo/source/javascripts/jquery.mobile-1.4.0-alpha.2.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.href</b> via the following statement:<ul><li>location.href = location.href.replace( /#.*/, '' ) + history_hash;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/marcorinck/jquery-mobile-iscrollview/demo/source/javascripts/jquery.mobile-1.4.0-alpha.2.js",
                "path": "/marcorinck/jquery-mobile-iscrollview/demo/source/javascripts/jquery.mobile-1.4.0-alpha.2.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9tYXJjb3JpbmNrL2pxdWVyeS1tb2JpbGUtaXNjcm9sbHZpZXcvZGVtby9zb3VyY2UvamF2YXNjcmlwdHMvanF1ZXJ5Lm1vYmlsZS0xLjQuMC1hbHBoYS4yLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNDI3MzA3DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDA2OjQ5OjQzIEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwNjo0OTo0MyBHTVQNCg0KLyohCiogalF1ZXJ5IE1vYmlsZSAxLjQuMC1hbHBoYS4yCiogR2l0IEhFQUQgaGFzaDogMWUyNzg0NGExYzBiOTEwM2EwOTQ4NDgwNjM3ZTZhNjdmNTIxMmRmZCA8PiBEYXRlOiBUaHUgQXVnIDE1IDIwMTMgMTM6NTM6NDkgVVRDCiogaHR0cDovL2pxdWVyeW1vYmlsZS5jb20KKgoqIENvcHlyaWdodCAyMDEwLCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uLCBJbmMuIGFuZCBvdGhlciBjb250cmlidXRvcnMKKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQoqCiovCgoKKGZ1bmN0aW9uICggcm9vdCwgZG9jLCBmYWN0b3J5ICkgewoJaWYgKCB0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQgKSB7CgkJLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLgoJCWRlZmluZSggWyAianF1ZXJ5IiBdLCBmdW5jdGlvbiAoICQgKSB7CgkJCWZhY3RvcnkoICQsIHJvb3QsIGRvYyApOwoJCQlyZXR1cm4gJC5tb2JpbGU7CgkJfSk7Cgl9IGVsc2UgewoJCS8vIEJyb3dzZXIgZ2xvYmFscwoJCWZhY3RvcnkoIHJvb3QualF1ZXJ5LCByb290LCBkb2MgKTsKCX0KfSggdGhpcywgZG9jdW1lbnQsIGZ1bmN0aW9uICggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7CihmdW5jdGlvbiggJCApIHsKCSQubW9iaWxlID0ge307Cn0oIGpRdWVyeSApKTsKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoKCQkvLyBWZXJzaW9uIG9mIHRoZSBqUXVlcnkgTW9iaWxlIEZyYW1ld29yawoJCXZlcnNpb246ICIxLjQuMC1hbHBoYS4yIiwKCgkJLy8gRGVwcmVjYXRlZCBhbmQgbm8gbG9uZ2VyIHVzZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQkvLyBEZWZpbmUgdGhlIHVybCBwYXJhbWV0ZXIgdXNlZCBmb3IgcmVmZXJlbmNpbmcgd2lkZ2V0LWdlbmVyYXRlZCBzdWItcGFnZXMuCgkJLy8gVHJhbnNsYXRlcyB0byBleGFtcGxlLmh0bWwmdWktcGFnZT1zdWJwYWdlSWRlbnRpZmllcgoJCS8vIGhhc2ggc2VnbWVudCBiZWZvcmUgJnVpLXBhZ2U9IGlzIHVzZWQgdG8gbWFrZSBBamF4IHJlcXVlc3QKCQlzdWJQYWdlVXJsS2V5OiAidWktcGFnZSIsCgoJCWhpZGVVcmxCYXI6IHRydWUsCgoJCS8vIEtlZXBuYXRpdmUgU2VsZWN0b3IKCQlrZWVwTmF0aXZlOiAiOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJLy8gQ2xhc3MgYXNzaWduZWQgdG8gcGFnZSBjdXJyZW50bHkgaW4gdmlldywgYW5kIGR1cmluZyB0cmFuc2l0aW9ucwoJCWFjdGl2ZVBhZ2VDbGFzczogInVpLXBhZ2UtYWN0aXZlIiwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCS8vIENsYXNzIHVzZWQgZm9yICJhY3RpdmUiIGJ1dHRvbiBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJYWN0aXZlQnRuQ2xhc3M6ICJ1aS1idG4tYWN0aXZlIiwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCS8vIENsYXNzIHVzZWQgZm9yICJmb2N1cyIgZm9ybSBlbGVtZW50IHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlmb2N1c0NsYXNzOiAidWktZm9jdXMiLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGhhbmRsZSBjbGlja3MgYW5kIGZvcm0gc3VibWlzc2lvbnMgdGhyb3VnaCBBamF4LCB3aGVuIHNhbWUtZG9tYWluCgkJYWpheEVuYWJsZWQ6IHRydWUsCgoJCS8vIEF1dG9tYXRpY2FsbHkgbG9hZCBhbmQgc2hvdyBwYWdlcyBiYXNlZCBvbiBsb2NhdGlvbi5oYXNoCgkJaGFzaExpc3RlbmluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIGRpc2FibGUgdG8gcHJldmVudCBqcXVlcnkgZnJvbSBib3RoZXJpbmcgd2l0aCBsaW5rcwoJCWxpbmtCaW5kaW5nRW5hYmxlZDogdHJ1ZSwKCgkJLy8gU2V0IGRlZmF1bHQgcGFnZSB0cmFuc2l0aW9uIC0gJ25vbmUnIGZvciBubyB0cmFuc2l0aW9ucwoJCWRlZmF1bHRQYWdlVHJhbnNpdGlvbjogImZhZGUiLAoKCQkvLyBTZXQgbWF4aW11bSB3aW5kb3cgd2lkdGggZm9yIHRyYW5zaXRpb25zIHRvIGFwcGx5IC0gJ2ZhbHNlJyBmb3Igbm8gbGltaXQKCQltYXhUcmFuc2l0aW9uV2lkdGg6IGZhbHNlLAoKCQkvLyBNaW5pbXVtIHNjcm9sbCBkaXN0YW5jZSB0aGF0IHdpbGwgYmUgcmVtZW1iZXJlZCB3aGVuIHJldHVybmluZyB0byBhIHBhZ2UKCQkvLyBEZXByZWNhdGVkIHJlbW92ZSBpbiAxLjUgCgkJbWluU2Nyb2xsQmFjazogMCwKCgkJLy8gREVQUkVDQVRFRDogdGhlIGZvbGxvd2luZyBwcm9wZXJ0eSBpcyBubyBsb25nZXIgaW4gdXNlLCBidXQgZGVmaW5lZCB1bnRpbCAyLjAgdG8gcHJldmVudCBjb25mbGljdHMKCQl0b3VjaE92ZXJmbG93RW5hYmxlZDogZmFsc2UsCgoJCS8vIFNldCBkZWZhdWx0IGRpYWxvZyB0cmFuc2l0aW9uIC0gJ25vbmUnIGZvciBubyB0cmFuc2l0aW9ucwoJCWRlZmF1bHREaWFsb2dUcmFuc2l0aW9uOiAicG9wIiwKCgkJLy8gRXJyb3IgcmVzcG9uc2UgbWVzc2FnZSAtIGFwcGVhcnMgd2hlbiBhbiBBamF4IHBhZ2UgcmVxdWVzdCBmYWlscwoJCXBhZ2VMb2FkRXJyb3JNZXNzYWdlOiAiRXJyb3IgTG9hZGluZyBQYWdlIiwKCgkJLy8gRm9yIGVycm9yIG1lc3NhZ2VzLCB3aGljaCB0aGVtZSBkb2VzIHRoZSBib3ggdXNlcz8KCQlwYWdlTG9hZEVycm9yTWVzc2FnZVRoZW1lOiAiYSIsCgoJCS8vIHJlcGxhY2UgY2FsbHMgdG8gd2luZG93Lmhpc3RvcnkuYmFjayB3aXRoIHBob25lZ2FwcyBuYXZpZ2F0aW9uIGhlbHBlcgoJCS8vIHdoZXJlIGl0IGlzIHByb3ZpZGVkIG9uIHRoZSB3aW5kb3cgb2JqZWN0CgkJcGhvbmVnYXBOYXZpZ2F0aW9uRW5hYmxlZDogZmFsc2UsCgoJCS8vYXV0b21hdGljYWxseSBpbml0aWFsaXplIHRoZSBET00gd2hlbiBpdCdzIHJlYWR5CgkJYXV0b0luaXRpYWxpemVQYWdlOiB0cnVlLAoKCQlwdXNoU3RhdGVFbmFibGVkOiB0cnVlLAoKCQkvLyBhbGxvd3MgdXNlcnMgdG8gb3B0IGluIHRvIGlnbm9yaW5nIGNvbnRlbnQgYnkgbWFya2luZyBhIHBhcmVudCBlbGVtZW50IGFzCgkJLy8gZGF0YS1pZ25vcmVkCgkJaWdub3JlQ29udGVudEVuYWJsZWQ6IGZhbHNlLAoKCQlidXR0b25NYXJrdXA6IHsKCQkJaG92ZXJEZWxheTogMjAwCgkJfSwKCgkJLy8gZGlzYWJsZSB0aGUgYWx0ZXJhdGlvbiBvZiB0aGUgZHluYW1pYyBiYXNlIHRhZyBvciBsaW5rcyBpbiB0aGUgY2FzZQoJCS8vIHRoYXQgYSBkeW5hbWljIGJhc2UgdGFnIGlzbid0IHN1cHBvcnRlZAoJCWR5bmFtaWNCYXNlRW5hYmxlZDogdHJ1ZSwKCgkJLy8gZGVmYXVsdCB0aGUgcHJvcGVydHkgdG8gcmVtb3ZlIGRlcGVuZGVuY3kgb24gYXNzaWdubWVudCBpbiBpbml0IG1vZHVsZQoJCXBhZ2VDb250YWluZXI6ICQoKQoJfSk7Cn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgl2YXIgbnNOb3JtYWxpemVEaWN0ID0ge30sCgkJb2xkRmluZCA9ICQuZmluZCwKCQlyYnJhY2UgPSAvKD86XHtbXHNcU10qXH18XFtbXHNcU10qXF0pJC8sCgkJanFtRGF0YVJFID0gLzpqcW1EYXRhXCgoW14pXSopXCkvZzsKCgkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCgkJLy8gTmFtZXNwYWNlIHVzZWQgZnJhbWV3b3JrLXdpZGUgZm9yIGRhdGEtYXR0cnMuIERlZmF1bHQgaXMgbm8gbmFtZXNwYWNlCgoJCW5zOiAiIiwKCgkJLy8gUmV0cmlldmUgYW4gYXR0cmlidXRlIGZyb20gYW4gZWxlbWVudCBhbmQgcGVyZm9ybSBzb21lIG1hc3NhZ2luZyBvZiB0aGUgdmFsdWUKCgkJZ2V0QXR0cmlidXRlOiBmdW5jdGlvbiggZWxlbWVudCwga2V5ICkgewoJCQl2YXIgZGF0YTsKCgkJCWVsZW1lbnQgPSBlbGVtZW50LmpxdWVyeSA/IGVsZW1lbnRbMF0gOiBlbGVtZW50OwoKCQkJaWYoIGVsZW1lbnQgJiYgZWxlbWVudC5nZXRBdHRyaWJ1dGUgKXsKCQkJCWRhdGEgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsga2V5ICk7CgkJCX0KCgkJCS8vIENvcGllZCBmcm9tIGNvcmUncyBzcmMvZGF0YS5qczpkYXRhQXR0cigpCgkJCS8vIENvbnZlcnQgZnJvbSBhIHN0cmluZyB0byBhIHByb3BlciBkYXRhIHR5cGUKCQkJdHJ5IHsKCQkJCWRhdGEgPSBkYXRhID09PSAidHJ1ZSIgPyB0cnVlIDoKCQkJCQlkYXRhID09PSAiZmFsc2UiID8gZmFsc2UgOgoJCQkJCWRhdGEgPT09ICJudWxsIiA/IG51bGwgOgoJCQkJCS8vIE9ubHkgY29udmVydCB0byBhIG51bWJlciBpZiBpdCBkb2Vzbid0IGNoYW5nZSB0aGUgc3RyaW5nCgkJCQkJK2RhdGEgKyAiIiA9PT0gZGF0YSA/ICtkYXRhIDoKCQkJCQlyYnJhY2UudGVzdCggZGF0YSApID8gSlNPTi5wYXJzZSggZGF0YSApIDoKCQkJCQlkYXRhOwoJCQl9IGNhdGNoKCBlcnIgKSB7fQoKCQkJcmV0dXJuIGRhdGE7CgkJfSwKCgkJLy8gRXhwb3NlIG91ciBjYWNoZSBmb3IgdGVzdGluZyBwdXJwb3Nlcy4KCQluc05vcm1hbGl6ZURpY3Q6IG5zTm9ybWFsaXplRGljdCwKCgkJLy8gVGFrZSBhIGRhdGEgYXR0cmlidXRlIHByb3BlcnR5LCBwcmVwZW5kIHRoZSBuYW1lc3BhY2UKCQkvLyBhbmQgdGhlbiBjYW1lbCBjYXNlIHRoZSBhdHRyaWJ1dGUgc3RyaW5nLiBBZGQgdGhlIHJlc3VsdAoJCS8vIHRvIG91ciBuc05vcm1hbGl6ZURpY3Qgc28gd2UgZG9uJ3QgaGF2ZSB0byBkbyB0aGlzIGFnYWluLgoJCW5zTm9ybWFsaXplOiBmdW5jdGlvbiggcHJvcCApIHsKCQkJcmV0dXJuIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdIHx8CgkJCQkoIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdID0gJC5jYW1lbENhc2UoICQubW9iaWxlLm5zICsgcHJvcCApICk7CgkJfSwKCgkJLy8gRmluZCB0aGUgY2xvc2VzdCBqYXZhc2NyaXB0IHBhZ2UgZWxlbWVudCB0byBnYXRoZXIgc2V0dGluZ3MgZGF0YSBqc3BlcmYgdGVzdAoJCS8vIGh0dHA6Ly9qc3BlcmYuY29tL3NpbmdsZS1jb21wbGV4LXNlbGVjdG9yLXZzLW1hbnktY29tcGxleC1zZWxlY3RvcnMvZWRpdAoJCS8vIHBvc3NpYmx5IG5haXZlLCBidXQgaXQgc2hvd3MgdGhhdCB0aGUgcGFyc2luZyBvdmVyaGVhZCBmb3IgKmp1c3QqIHRoZSBwYWdlIHNlbGVjdG9yIHZzCgkJLy8gdGhlIHBhZ2UgYW5kIGRpYWxvZyBzZWxlY3RvciBpcyBuZWdsaWdhYmxlLiBUaGlzIGNvdWxkIHByb2JhYmx5IGJlIHNwZWVkIHVwIGJ5CgkJLy8gZG9pbmcgYSBzaW1pbGFyIHBhcmVudCBub2RlIHRyYXZlcnNhbCB0byB0aGUgb25lIGZvdW5kIGluIHRoZSBpbmhlcml0ZWQgdGhlbWUgY29kZSBhYm92ZQoJCWNsb3Nlc3RQYWdlRGF0YTogZnVuY3Rpb24oICR0YXJnZXQgKSB7CgkJCXJldHVybiAkdGFyZ2V0CgkJCQkuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkKCQkJCS5kYXRhKCAibW9iaWxlLXBhZ2UiICk7CgkJfQoKCX0pOwoKCS8vIE1vYmlsZSB2ZXJzaW9uIG9mIGRhdGEgYW5kIHJlbW92ZURhdGEgYW5kIGhhc0RhdGEgbWV0aG9kcwoJLy8gZW5zdXJlcyBhbGwgZGF0YSBpcyBzZXQgYW5kIHJldHJpZXZlZCB1c2luZyBqUXVlcnkgTW9iaWxlJ3MgZGF0YSBuYW1lc3BhY2UKCSQuZm4uanFtRGF0YSA9IGZ1bmN0aW9uKCBwcm9wLCB2YWx1ZSApIHsKCQl2YXIgcmVzdWx0OwoJCWlmICggdHlwZW9mIHByb3AgIT09ICJ1bmRlZmluZWQiICkgewoJCQlpZiAoIHByb3AgKSB7CgkJCQlwcm9wID0gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKTsKCQkJfQoKCQkJLy8gdW5kZWZpbmVkIGlzIHBlcm1pdHRlZCBhcyBhbiBleHBsaWNpdCBpbnB1dCBmb3IgdGhlIHNlY29uZCBwYXJhbQoJCQkvLyBpbiB0aGlzIGNhc2UgaXQgcmV0dXJucyB0aGUgdmFsdWUgYW5kIGRvZXMgbm90IHNldCBpdCB0byB1bmRlZmluZWQKCQkJaWYgKCBhcmd1bWVudHMubGVuZ3RoIDwgMiB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkICl7CgkJCQlyZXN1bHQgPSB0aGlzLmRhdGEoIHByb3AgKTsKCQkJfSBlbHNlIHsKCQkJCXJlc3VsdCA9IHRoaXMuZGF0YSggcHJvcCwgdmFsdWUgKTsKCQkJfQoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmpxbURhdGEgPSBmdW5jdGlvbiggZWxlbSwgcHJvcCwgdmFsdWUgKSB7CgkJdmFyIHJlc3VsdDsKCQlpZiAoIHR5cGVvZiBwcm9wICE9PSAidW5kZWZpbmVkIiApIHsKCQkJcmVzdWx0ID0gJC5kYXRhKCBlbGVtLCBwcm9wID8gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSA6IHByb3AsIHZhbHVlICk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCSQuZm4uanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBwcm9wICkgewoJCXJldHVybiB0aGlzLnJlbW92ZURhdGEoICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5qcW1SZW1vdmVEYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AgKSB7CgkJcmV0dXJuICQucmVtb3ZlRGF0YSggZWxlbSwgJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSApOwoJfTsKCgkkLmZpbmQgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKSB7CgkJaWYgKCBzZWxlY3Rvci5pbmRleE9mKCAiOmpxbURhdGEiICkgPiAtMSApIHsKCQkJc2VsZWN0b3IgPSBzZWxlY3Rvci5yZXBsYWNlKCBqcW1EYXRhUkUsICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgIiQxXSIgKTsKCQl9CgoJCXJldHVybiBvbGRGaW5kLmNhbGwoIHRoaXMsIHNlbGVjdG9yLCBjb250ZXh0LCByZXQsIGV4dHJhICk7Cgl9OwoKCSQuZXh0ZW5kKCAkLmZpbmQsIG9sZEZpbmQgKTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qIQogKiBqUXVlcnkgVUkgQ29yZSBAVkVSU0lPTgogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2NhdGVnb3J5L3VpLWNvcmUvCiAqLwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciB1dWlkID0gMCwKCXJ1bmlxdWVJZCA9IC9edWktaWQtXGQrJC87CgovLyAkLnVpIG1pZ2h0IGV4aXN0IGZyb20gY29tcG9uZW50cyB3aXRoIG5vIGRlcGVuZGVuY2llcywgZS5nLiwgJC51aS5wb3NpdGlvbgokLnVpID0gJC51aSB8fCB7fTsKCiQuZXh0ZW5kKCAkLnVpLCB7Cgl2ZXJzaW9uOiAiQFZFUlNJT04iLAoKCWtleUNvZGU6IHsKCQlCQUNLU1BBQ0U6IDgsCgkJQ09NTUE6IDE4OCwKCQlERUxFVEU6IDQ2LAoJCURPV046IDQwLAoJCUVORDogMzUsCgkJRU5URVI6IDEzLAoJCUVTQ0FQRTogMjcsCgkJSE9NRTogMzYsCgkJTEVGVDogMzcsCgkJUEFHRV9ET1dOOiAzNCwKCQlQQUdFX1VQOiAzMywKCQlQRVJJT0Q6IDE5MCwKCQlSSUdIVDogMzksCgkJU1BBQ0U6IDMyLAoJCVRBQjogOSwKCQlVUDogMzgKCX0KfSk7CgovLyBwbHVnaW5zCiQuZm4uZXh0ZW5kKHsKCWZvY3VzOiAoZnVuY3Rpb24oIG9yaWcgKSB7CgkJcmV0dXJuIGZ1bmN0aW9uKCBkZWxheSwgZm4gKSB7CgkJCXJldHVybiB0eXBlb2YgZGVsYXkgPT09ICJudW1iZXIiID8KCQkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCQl2YXIgZWxlbSA9IHRoaXM7CgkJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkJJCggZWxlbSApLmZvY3VzKCk7CgkJCQkJCWlmICggZm4gKSB7CgkJCQkJCQlmbi5jYWxsKCBlbGVtICk7CgkJCQkJCX0KCQkJCQl9LCBkZWxheSApOwoJCQkJfSkgOgoJCQkJb3JpZy5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJfTsKCX0pKCAkLmZuLmZvY3VzICksCgoJc2Nyb2xsUGFyZW50OiBmdW5jdGlvbigpIHsKCQl2YXIgc2Nyb2xsUGFyZW50OwoJCWlmICgoJC51aS5pZSAmJiAoLyhzdGF0aWN8cmVsYXRpdmUpLykudGVzdCh0aGlzLmNzcygicG9zaXRpb24iKSkpIHx8ICgvYWJzb2x1dGUvKS50ZXN0KHRoaXMuY3NzKCJwb3NpdGlvbiIpKSkgewoJCQlzY3JvbGxQYXJlbnQgPSB0aGlzLnBhcmVudHMoKS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKC8ocmVsYXRpdmV8YWJzb2x1dGV8Zml4ZWQpLykudGVzdCgkLmNzcyh0aGlzLCJwb3NpdGlvbiIpKSAmJiAoLyhhdXRvfHNjcm9sbCkvKS50ZXN0KCQuY3NzKHRoaXMsIm92ZXJmbG93IikrJC5jc3ModGhpcywib3ZlcmZsb3cteSIpKyQuY3NzKHRoaXMsIm92ZXJmbG93LXgiKSk7CgkJCX0pLmVxKDApOwoJCX0gZWxzZSB7CgkJCXNjcm9sbFBhcmVudCA9IHRoaXMucGFyZW50cygpLmZpbHRlcihmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoLyhhdXRvfHNjcm9sbCkvKS50ZXN0KCQuY3NzKHRoaXMsIm92ZXJmbG93IikrJC5jc3ModGhpcywib3ZlcmZsb3cteSIpKyQuY3NzKHRoaXMsIm92ZXJmbG93LXgiKSk7CgkJCX0pLmVxKDApOwoJCX0KCgkJcmV0dXJuICggL2ZpeGVkLyApLnRlc3QoIHRoaXMuY3NzKCAicG9zaXRpb24iKSApIHx8ICFzY3JvbGxQYXJlbnQubGVuZ3RoID8gJCggdGhpc1sgMCBdLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQgKSA6IHNjcm9sbFBhcmVudDsKCX0sCgoJdW5pcXVlSWQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWlmICggIXRoaXMuaWQgKSB7CgkJCQl0aGlzLmlkID0gInVpLWlkLSIgKyAoKyt1dWlkKTsKCQkJfQoJCX0pOwoJfSwKCglyZW1vdmVVbmlxdWVJZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCBydW5pcXVlSWQudGVzdCggdGhpcy5pZCApICkgewoJCQkJJCggdGhpcyApLnJlbW92ZUF0dHIoICJpZCIgKTsKCQkJfQoJCX0pOwoJfQp9KTsKCi8vIHNlbGVjdG9ycwpmdW5jdGlvbiBmb2N1c2FibGUoIGVsZW1lbnQsIGlzVGFiSW5kZXhOb3ROYU4gKSB7Cgl2YXIgbWFwLCBtYXBOYW1lLCBpbWcsCgkJbm9kZU5hbWUgPSBlbGVtZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CglpZiAoICJhcmVhIiA9PT0gbm9kZU5hbWUgKSB7CgkJbWFwID0gZWxlbWVudC5wYXJlbnROb2RlOwoJCW1hcE5hbWUgPSBtYXAubmFtZTsKCQlpZiAoICFlbGVtZW50LmhyZWYgfHwgIW1hcE5hbWUgfHwgbWFwLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICJtYXAiICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCWltZyA9ICQoICJpbWdbdXNlbWFwPSMiICsgbWFwTmFtZSArICJdIiApWzBdOwoJCXJldHVybiAhIWltZyAmJiB2aXNpYmxlKCBpbWcgKTsKCX0KCXJldHVybiAoIC9pbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9ufG9iamVjdC8udGVzdCggbm9kZU5hbWUgKSA/CgkJIWVsZW1lbnQuZGlzYWJsZWQgOgoJCSJhIiA9PT0gbm9kZU5hbWUgPwoJCQllbGVtZW50LmhyZWYgfHwgaXNUYWJJbmRleE5vdE5hTiA6CgkJCWlzVGFiSW5kZXhOb3ROYU4pICYmCgkJLy8gdGhlIGVsZW1lbnQgYW5kIGFsbCBvZiBpdHMgYW5jZXN0b3JzIG11c3QgYmUgdmlzaWJsZQoJCXZpc2libGUoIGVsZW1lbnQgKTsKfQoKZnVuY3Rpb24gdmlzaWJsZSggZWxlbWVudCApIHsKCXJldHVybiAkLmV4cHIuZmlsdGVycy52aXNpYmxlKCBlbGVtZW50ICkgJiYKCQkhJCggZWxlbWVudCApLnBhcmVudHMoKS5hZGRCYWNrKCkuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5jc3MoIHRoaXMsICJ2aXNpYmlsaXR5IiApID09PSAiaGlkZGVuIjsKCQl9KS5sZW5ndGg7Cn0KCiQuZXh0ZW5kKCAkLmV4cHJbICI6IiBdLCB7CglkYXRhOiAkLmV4cHIuY3JlYXRlUHNldWRvID8KCQkkLmV4cHIuY3JlYXRlUHNldWRvKGZ1bmN0aW9uKCBkYXRhTmFtZSApIHsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJcmV0dXJuICEhJC5kYXRhKCBlbGVtLCBkYXRhTmFtZSApOwoJCQl9OwoJCX0pIDoKCQkvLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAoJCWZ1bmN0aW9uKCBlbGVtLCBpLCBtYXRjaCApIHsKCQkJcmV0dXJuICEhJC5kYXRhKCBlbGVtLCBtYXRjaFsgMyBdICk7CgkJfSwKCglmb2N1c2FibGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCXJldHVybiBmb2N1c2FibGUoIGVsZW1lbnQsICFpc05hTiggJC5hdHRyKCBlbGVtZW50LCAidGFiaW5kZXgiICkgKSApOwoJfSwKCgl0YWJiYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdmFyIHRhYkluZGV4ID0gJC5hdHRyKCBlbGVtZW50LCAidGFiaW5kZXgiICksCgkJCWlzVGFiSW5kZXhOYU4gPSBpc05hTiggdGFiSW5kZXggKTsKCQlyZXR1cm4gKCBpc1RhYkluZGV4TmFOIHx8IHRhYkluZGV4ID49IDAgKSAmJiBmb2N1c2FibGUoIGVsZW1lbnQsICFpc1RhYkluZGV4TmFOICk7Cgl9Cn0pOwoKLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKaWYgKCAhJCggIjxhPiIgKS5vdXRlcldpZHRoKCAxICkuanF1ZXJ5ICkgewoJJC5lYWNoKCBbICJXaWR0aCIsICJIZWlnaHQiIF0sIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoJCXZhciBzaWRlID0gbmFtZSA9PT0gIldpZHRoIiA/IFsgIkxlZnQiLCAiUmlnaHQiIF0gOiBbICJUb3AiLCAiQm90dG9tIiBdLAoJCQl0eXBlID0gbmFtZS50b0xvd2VyQ2FzZSgpLAoJCQlvcmlnID0gewoJCQkJaW5uZXJXaWR0aDogJC5mbi5pbm5lcldpZHRoLAoJCQkJaW5uZXJIZWlnaHQ6ICQuZm4uaW5uZXJIZWlnaHQsCgkJCQlvdXRlcldpZHRoOiAkLmZuLm91dGVyV2lkdGgsCgkJCQlvdXRlckhlaWdodDogJC5mbi5vdXRlckhlaWdodAoJCQl9OwoKCQlmdW5jdGlvbiByZWR1Y2UoIGVsZW0sIHNpemUsIGJvcmRlciwgbWFyZ2luICkgewoJCQkkLmVhY2goIHNpZGUsIGZ1bmN0aW9uKCkgewoJCQkJc2l6ZSAtPSBwYXJzZUZsb2F0KCAkLmNzcyggZWxlbSwgInBhZGRpbmciICsgdGhpcyApICkgfHwgMDsKCQkJCWlmICggYm9yZGVyICkgewoJCQkJCXNpemUgLT0gcGFyc2VGbG9hdCggJC5jc3MoIGVsZW0sICJib3JkZXIiICsgdGhpcyArICJXaWR0aCIgKSApIHx8IDA7CgkJCQl9CgkJCQlpZiAoIG1hcmdpbiApIHsKCQkJCQlzaXplIC09IHBhcnNlRmxvYXQoICQuY3NzKCBlbGVtLCAibWFyZ2luIiArIHRoaXMgKSApIHx8IDA7CgkJCQl9CgkJCX0pOwoJCQlyZXR1cm4gc2l6ZTsKCQl9CgoJCSQuZm5bICJpbm5lciIgKyBuYW1lIF0gPSBmdW5jdGlvbiggc2l6ZSApIHsKCQkJaWYgKCBzaXplID09PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gb3JpZ1sgImlubmVyIiArIG5hbWUgXS5jYWxsKCB0aGlzICk7CgkJCX0KCgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuY3NzKCB0eXBlLCByZWR1Y2UoIHRoaXMsIHNpemUgKSArICJweCIgKTsKCQkJfSk7CgkJfTsKCgkJJC5mblsgIm91dGVyIiArIG5hbWVdID0gZnVuY3Rpb24oIHNpemUsIG1hcmdpbiApIHsKCQkJaWYgKCB0eXBlb2Ygc2l6ZSAhPT0gIm51bWJlciIgKSB7CgkJCQlyZXR1cm4gb3JpZ1sgIm91dGVyIiArIG5hbWUgXS5jYWxsKCB0aGlzLCBzaXplICk7CgkJCX0KCgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzKS5jc3MoIHR5cGUsIHJlZHVjZSggdGhpcywgc2l6ZSwgdHJ1ZSwgbWFyZ2luICkgKyAicHgiICk7CgkJCX0pOwoJCX07Cgl9KTsKfQoKLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKaWYgKCAhJC5mbi5hZGRCYWNrICkgewoJJC5mbi5hZGRCYWNrID0gZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiB0aGlzLmFkZCggc2VsZWN0b3IgPT0gbnVsbCA/CgkJCXRoaXMucHJldk9iamVjdCA6IHRoaXMucHJldk9iamVjdC5maWx0ZXIoIHNlbGVjdG9yICkKCQkpOwoJfTsKfQoKLy8gc3VwcG9ydDogalF1ZXJ5IDEuNi4xLCAxLjYuMiAoaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvOTQxMykKaWYgKCAkKCAiPGE+IiApLmRhdGEoICJhLWIiLCAiYSIgKS5yZW1vdmVEYXRhKCAiYS1iIiApLmRhdGEoICJhLWIiICkgKSB7CgkkLmZuLnJlbW92ZURhdGEgPSAoZnVuY3Rpb24oIHJlbW92ZURhdGEgKSB7CgkJcmV0dXJuIGZ1bmN0aW9uKCBrZXkgKSB7CgkJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJCXJldHVybiByZW1vdmVEYXRhLmNhbGwoIHRoaXMsICQuY2FtZWxDYXNlKCBrZXkgKSApOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIHJlbW92ZURhdGEuY2FsbCggdGhpcyApOwoJCQl9CgkJfTsKCX0pKCAkLmZuLnJlbW92ZURhdGEgKTsKfQoKCgoKCi8vIGRlcHJlY2F0ZWQKJC51aS5pZSA9ICEhL21zaWUgW1x3Ll0rLy5leGVjKCBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkgKTsKCiQuc3VwcG9ydC5zZWxlY3RzdGFydCA9ICJvbnNlbGVjdHN0YXJ0IiBpbiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwokLmZuLmV4dGVuZCh7CglkaXNhYmxlU2VsZWN0aW9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5iaW5kKCAoICQuc3VwcG9ydC5zZWxlY3RzdGFydCA/ICJzZWxlY3RzdGFydCIgOiAibW91c2Vkb3duIiApICsKCQkJIi51aS1kaXNhYmxlU2VsZWN0aW9uIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfSk7Cgl9LAoKCWVuYWJsZVNlbGVjdGlvbjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMudW5iaW5kKCAiLnVpLWRpc2FibGVTZWxlY3Rpb24iICk7Cgl9LAoKCXpJbmRleDogZnVuY3Rpb24oIHpJbmRleCApIHsKCQlpZiAoIHpJbmRleCAhPT0gdW5kZWZpbmVkICkgewoJCQlyZXR1cm4gdGhpcy5jc3MoICJ6SW5kZXgiLCB6SW5kZXggKTsKCQl9CgoJCWlmICggdGhpcy5sZW5ndGggKSB7CgkJCXZhciBlbGVtID0gJCggdGhpc1sgMCBdICksIHBvc2l0aW9uLCB2YWx1ZTsKCQkJd2hpbGUgKCBlbGVtLmxlbmd0aCAmJiBlbGVtWyAwIF0gIT09IGRvY3VtZW50ICkgewoJCQkJLy8gSWdub3JlIHotaW5kZXggaWYgcG9zaXRpb24gaXMgc2V0IHRvIGEgdmFsdWUgd2hlcmUgei1pbmRleCBpcyBpZ25vcmVkIGJ5IHRoZSBicm93c2VyCgkJCQkvLyBUaGlzIG1ha2VzIGJlaGF2aW9yIG9mIHRoaXMgZnVuY3Rpb24gY29uc2lzdGVudCBhY3Jvc3MgYnJvd3NlcnMKCQkJCS8vIFdlYktpdCBhbHdheXMgcmV0dXJucyBhdXRvIGlmIHRoZSBlbGVtZW50IGlzIHBvc2l0aW9uZWQKCQkJCXBvc2l0aW9uID0gZWxlbS5jc3MoICJwb3NpdGlvbiIgKTsKCQkJCWlmICggcG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgfHwgcG9zaXRpb24gPT09ICJyZWxhdGl2ZSIgfHwgcG9zaXRpb24gPT09ICJmaXhlZCIgKSB7CgkJCQkJLy8gSUUgcmV0dXJucyAwIHdoZW4gekluZGV4IGlzIG5vdCBzcGVjaWZpZWQKCQkJCQkvLyBvdGhlciBicm93c2VycyByZXR1cm4gYSBzdHJpbmcKCQkJCQkvLyB3ZSBpZ25vcmUgdGhlIGNhc2Ugb2YgbmVzdGVkIGVsZW1lbnRzIHdpdGggYW4gZXhwbGljaXQgdmFsdWUgb2YgMAoJCQkJCS8vIDxkaXYgc3R5bGU9InotaW5kZXg6IC0xMDsiPjxkaXYgc3R5bGU9InotaW5kZXg6IDA7Ij48L2Rpdj48L2Rpdj4KCQkJCQl2YWx1ZSA9IHBhcnNlSW50KCBlbGVtLmNzcyggInpJbmRleCIgKSwgMTAgKTsKCQkJCQlpZiAoICFpc05hTiggdmFsdWUgKSAmJiB2YWx1ZSAhPT0gMCApIHsKCQkJCQkJcmV0dXJuIHZhbHVlOwoJCQkJCX0KCQkJCX0KCQkJCWVsZW0gPSBlbGVtLnBhcmVudCgpOwoJCQl9CgkJfQoKCQlyZXR1cm4gMDsKCX0KfSk7CgovLyAkLnVpLnBsdWdpbiBpcyBkZXByZWNhdGVkLiBVc2UgJC53aWRnZXQoKSBleHRlbnNpb25zIGluc3RlYWQuCiQudWkucGx1Z2luID0gewoJYWRkOiBmdW5jdGlvbiggbW9kdWxlLCBvcHRpb24sIHNldCApIHsKCQl2YXIgaSwKCQkJcHJvdG8gPSAkLnVpWyBtb2R1bGUgXS5wcm90b3R5cGU7CgkJZm9yICggaSBpbiBzZXQgKSB7CgkJCXByb3RvLnBsdWdpbnNbIGkgXSA9IHByb3RvLnBsdWdpbnNbIGkgXSB8fCBbXTsKCQkJcHJvdG8ucGx1Z2luc1sgaSBdLnB1c2goIFsgb3B0aW9uLCBzZXRbIGkgXSBdICk7CgkJfQoJfSwKCWNhbGw6IGZ1bmN0aW9uKCBpbnN0YW5jZSwgbmFtZSwgYXJncywgYWxsb3dEaXNjb25uZWN0ZWQgKSB7CgkJdmFyIGksCgkJCXNldCA9IGluc3RhbmNlLnBsdWdpbnNbIG5hbWUgXTsKCgkJaWYgKCAhc2V0ICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoICFhbGxvd0Rpc2Nvbm5lY3RlZCAmJiAoICFpbnN0YW5jZS5lbGVtZW50WyAwIF0ucGFyZW50Tm9kZSB8fCBpbnN0YW5jZS5lbGVtZW50WyAwIF0ucGFyZW50Tm9kZS5ub2RlVHlwZSA9PT0gMTEgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJZm9yICggaSA9IDA7IGkgPCBzZXQubGVuZ3RoOyBpKysgKSB7CgkJCWlmICggaW5zdGFuY2Uub3B0aW9uc1sgc2V0WyBpIF1bIDAgXSBdICkgewoJCQkJc2V0WyBpIF1bIDEgXS5hcHBseSggaW5zdGFuY2UuZWxlbWVudCwgYXJncyApOwoJCQl9CgkJfQoJfQp9OwoKfSkoIGpRdWVyeSApOwooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoJCS8vIGRlZmluZSB0aGUgd2luZG93IGFuZCB0aGUgZG9jdW1lbnQgb2JqZWN0cwoJCXdpbmRvdzogJCggd2luZG93ICksCgkJZG9jdW1lbnQ6ICQoIGRvY3VtZW50ICksCgoJCS8vIFRPRE86IFJlbW92ZSBhbmQgdXNlICQudWkua2V5Q29kZSBkaXJlY3RseQoJCWtleUNvZGU6ICQudWkua2V5Q29kZSwKCgkJLy8gUGxhY2UgdG8gc3RvcmUgdmFyaW91cyB3aWRnZXQgZXh0ZW5zaW9ucwoJCWJlaGF2aW9yczoge30sCgoJCS8vIFNjcm9sbCBwYWdlIHZlcnRpY2FsbHk6IHNjcm9sbCB0byAwIHRvIGhpZGUgaU9TIGFkZHJlc3MgYmFyLCBvciBwYXNzIGEgWSB2YWx1ZQoJCXNpbGVudFNjcm9sbDogZnVuY3Rpb24oIHlwb3MgKSB7CgkJCWlmICggJC50eXBlKCB5cG9zICkgIT09ICJudW1iZXIiICkgewoJCQkJeXBvcyA9ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsOwoJCQl9CgoJCQkvLyBwcmV2ZW50IHNjcm9sbHN0YXJ0IGFuZCBzY3JvbGxzdG9wIGV2ZW50cwoJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IGZhbHNlOwoKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCXdpbmRvdy5zY3JvbGxUbyggMCwgeXBvcyApOwoJCQkJJC5tb2JpbGUuZG9jdW1lbnQudHJpZ2dlciggInNpbGVudHNjcm9sbCIsIHsgeDogMCwgeTogeXBvcyB9KTsKCQkJfSwgMjAgKTsKCgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IHRydWU7CgkJCX0sIDE1MCApOwoJCX0sCgoJCS8vIERFUFJFQ0FURUQgaW4gMS40CgkJLy8gRmluZCB0aGUgY2xvc2VzdCBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzIG9uIGl0LiBOb3RlIHRoYXQKCQkvLyB3ZSBhcmUgbm90IHVzaW5nICQuZm4uY2xvc2VzdCgpIG9uIHB1cnBvc2UgaGVyZSBiZWNhdXNlIHRoaXMKCQkvLyBtZXRob2QgZ2V0cyBjYWxsZWQgcXVpdGUgYSBiaXQgYW5kIHdlIG5lZWQgaXQgdG8gYmUgYXMgZmFzdAoJCS8vIGFzIHBvc3NpYmxlLgoJCWdldEluaGVyaXRlZFRoZW1lOiBmdW5jdGlvbiggZWwsIGRlZmF1bHRUaGVtZSApIHsKCQkJdmFyIGUgPSBlbFsgMCBdLAoJCQkJbHRyID0gIiIsCgkJCQlyZSA9IC91aS0oYmFyfGJvZHl8b3ZlcmxheSktKFthLXpdKVxiLywKCQkJCWMsIG07CgkJCXdoaWxlICggZSApIHsKCQkJCWMgPSBlLmNsYXNzTmFtZSB8fCAiIjsKCQkJCWlmICggYyAmJiAoIG0gPSByZS5leGVjKCBjICkgKSAmJiAoIGx0ciA9IG1bIDIgXSApICkgewoJCQkJCS8vIFdlIGZvdW5kIGEgcGFyZW50IHdpdGggYSB0aGVtZSBjbGFzcwoJCQkJCS8vIG9uIGl0IHNvIGJhaWwgZnJvbSB0aGlzIGxvb3AuCgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJZSA9IGUucGFyZW50Tm9kZTsKCQkJfQoJCQkvLyBSZXR1cm4gdGhlIHRoZW1lIGxldHRlciB3ZSBmb3VuZCwgaWYgbm9uZSwgcmV0dXJuIHRoZQoJCQkvLyBzcGVjaWZpZWQgZGVmYXVsdC4KCQkJcmV0dXJuIGx0ciB8fCBkZWZhdWx0VGhlbWUgfHwgImEiOwoJCX0sCgoJCWVuaGFuY2VhYmxlOiBmdW5jdGlvbiggZWxlbWVudHMgKSB7CgkJCXJldHVybiB0aGlzLmhhdmVQYXJlbnRzKCBlbGVtZW50cywgImVuaGFuY2UiICk7CgkJfSwKCgkJaGlqYWNrYWJsZTogZnVuY3Rpb24oIGVsZW1lbnRzICkgewoJCQlyZXR1cm4gdGhpcy5oYXZlUGFyZW50cyggZWxlbWVudHMsICJhamF4IiApOwoJCX0sCgoJCWhhdmVQYXJlbnRzOiBmdW5jdGlvbiggZWxlbWVudHMsIGF0dHIgKSB7CgkJCWlmICggISQubW9iaWxlLmlnbm9yZUNvbnRlbnRFbmFibGVkICkgewoJCQkJcmV0dXJuIGVsZW1lbnRzOwoJCQl9CgoJCQl2YXIgY291bnQgPSBlbGVtZW50cy5sZW5ndGgsCgkJCQkkbmV3U2V0ID0gJCgpLAoJCQkJZSwgJGVsZW1lbnQsIGV4Y2x1ZGVkLAoJCQkJaSwgYzsKCgkJCWZvciAoIGkgPSAwOyBpIDwgY291bnQ7IGkrKyApIHsKCQkJCSRlbGVtZW50ID0gZWxlbWVudHMuZXEoIGkgKTsKCQkJCWV4Y2x1ZGVkID0gZmFsc2U7CgkJCQllID0gZWxlbWVudHNbIGkgXTsKCgkJCQl3aGlsZSAoIGUgKSB7CgkJCQkJYyA9IGUuZ2V0QXR0cmlidXRlID8gZS5nZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArIGF0dHIgKSA6ICIiOwoKCQkJCQlpZiAoIGMgPT09ICJmYWxzZSIgKSB7CgkJCQkJCWV4Y2x1ZGVkID0gdHJ1ZTsKCQkJCQkJYnJlYWs7CgkJCQkJfQoKCQkJCQllID0gZS5wYXJlbnROb2RlOwoJCQkJfQoKCQkJCWlmICggIWV4Y2x1ZGVkICkgewoJCQkJCSRuZXdTZXQgPSAkbmV3U2V0LmFkZCggJGVsZW1lbnQgKTsKCQkJCX0KCQkJfQoKCQkJcmV0dXJuICRuZXdTZXQ7CgkJfSwKCgkJZ2V0U2NyZWVuSGVpZ2h0OiBmdW5jdGlvbigpIHsKCQkJLy8gTmF0aXZlIGlubmVySGVpZ2h0IHJldHVybnMgbW9yZSBhY2N1cmF0ZSB2YWx1ZSBmb3IgdGhpcyBhY3Jvc3MgcGxhdGZvcm1zLAoJCQkvLyBqUXVlcnkgdmVyc2lvbiBpcyBoZXJlIGFzIGEgbm9ybWFsaXplZCBmYWxsYmFjayBmb3IgcGxhdGZvcm1zIGxpa2UgU3ltYmlhbgoJCQlyZXR1cm4gd2luZG93LmlubmVySGVpZ2h0IHx8ICQubW9iaWxlLndpbmRvdy5oZWlnaHQoKTsKCQl9LAoKCQkvL3NpbXBseSBzZXQgdGhlIGFjdGl2ZSBwYWdlJ3MgbWluaW11bSBoZWlnaHQgdG8gc2NyZWVuIGhlaWdodCwgZGVwZW5kaW5nIG9uIG9yaWVudGF0aW9uCgkJcmVzZXRBY3RpdmVQYWdlSGVpZ2h0OiBmdW5jdGlvbiggaGVpZ2h0ICkgewoJCQl2YXIgcGFnZSA9ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLAoJCQkJcGFnZUhlaWdodCA9IHBhZ2UuaGVpZ2h0KCksCgkJCQlwYWdlT3V0ZXJIZWlnaHQgPSBwYWdlLm91dGVySGVpZ2h0KCB0cnVlICk7CgoJCQloZWlnaHQgPSAoIHR5cGVvZiBoZWlnaHQgPT09ICJudW1iZXIiICkgPyBoZWlnaHQgOiAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKTsKCgkJCXBhZ2UuY3NzKCAibWluLWhlaWdodCIsIGhlaWdodCAtICggcGFnZU91dGVySGVpZ2h0IC0gcGFnZUhlaWdodCApICk7CgkJfQoJfSk7CgoJJC5hZGREZXBlbmRlbnRzID0gZnVuY3Rpb24oIGVsZW0sIG5ld0RlcGVuZGVudHMgKSB7CgkJdmFyICRlbGVtID0gJCggZWxlbSApLAoJCQlkZXBlbmRlbnRzID0gJGVsZW0uanFtRGF0YSggImRlcGVuZGVudHMiICkgfHwgJCgpOwoKCQkkZWxlbS5qcW1EYXRhKCAiZGVwZW5kZW50cyIsICQoIGRlcGVuZGVudHMgKS5hZGQoIG5ld0RlcGVuZGVudHMgKSApOwoJfTsKCgkvLyBwbHVnaW5zCgkkLmZuLmV4dGVuZCh7CgkJcmVtb3ZlV2l0aERlcGVuZGVudHM6IGZ1bmN0aW9uKCkgewoJCQkkLnJlbW92ZVdpdGhEZXBlbmRlbnRzKCB0aGlzICk7CgkJfSwKCgkJLy8gRW5oYW5jZSBjaGlsZCBlbGVtZW50cwoJCWVuaGFuY2VXaXRoaW46IGZ1bmN0aW9uKCkgewoJCQl2YXIgd2lkZ2V0RWxlbWVudHMsCgkJCQl0aGF0ID0gdGhpczsKCgkJCS8vIEFkZCBubyBqcyBjbGFzcyB0byBlbGVtZW50cwoJCQlpZiAoICQubW9iaWxlLm5vanMgKSB7CgkJCQkkLm1vYmlsZS5ub2pzKCB0aGlzICk7CgkJCX0KCgkJCS8vIEJpbmQgbGlua3MgZm9yIGFqYXggbmF2CgkJCWlmICggJC5tb2JpbGUubGlua3MgKSB7CgkJCQkkLm1vYmlsZS5saW5rcyggdGhpcyApOwoJCQl9CgoJCQkvLyBEZWdyYWRlIGlucHV0cyBmb3Igc3R5bGVpbmcKCQkJaWYgKCAkLm1vYmlsZS5kZWdyYWRlSW5wdXRzV2l0aGluICkgewoJCQkJJC5tb2JpbGUuZGVncmFkZUlucHV0c1dpdGhpbiggdGhpcyApOwoJCQl9CgoJCQkvLyBSdW4gYnV0dG9ubWFya3VwCgkJCWlmICggJC5mbi5idXR0b25NYXJrdXAgKSB7CgkJCQkkKCAkLmZuLmJ1dHRvbk1hcmt1cC5pbml0U2VsZWN0b3IgKS5idXR0b25NYXJrdXAoKTsKCQkJfQoKCQkJLy8gQWRkIGNsYXNzZXMgZm9yIGZpZWxkQ29udGFpbgoJCQlpZiAoICQuZm4uZmllbGRjb250YWluICkgewoJCQkJdGhpcy5maW5kKCAiOmpxbURhdGEocm9sZT0nZmllbGRjb250YWluJykiICkuanFtRW5oYW5jZWFibGUoKS5maWVsZGNvbnRhaW4oKTsKCQkJfQoKCQkJLy8gRW5oYW5jZSB3aWRnZXRzCgkJCSQuZWFjaCggJC5tb2JpbGUud2lkZ2V0cywgZnVuY3Rpb24oIG5hbWUsIGNvbnN0cnVjdG9yICkgewoKCQkJCS8vIElmIGluaXRTZWxlY3RvciBub3QgZmFsc2UgZmluZCBlbGVtZW50cwoJCQkJaWYgKCBjb25zdHJ1Y3Rvci5pbml0U2VsZWN0b3IgKSB7CgoJCQkJCS8vIEZpbHRlciBlbGVtZW50cyB0aGF0IHNob3VsZCBub3QgYmUgZW5oYW5jZWQgYmFzZWQgb24gcGFyZW50cwoJCQkJCXdpZGdldEVsZW1lbnRzID0gJC5tb2JpbGUuZW5oYW5jZWFibGUoIHRoYXQuZmluZCggY29uc3RydWN0b3IuaW5pdFNlbGVjdG9yICkgKTsKCgkJCQkJLy8gSWYgYW55IG1hdGNoaW5nIGVsZW1lbnRzIHJlbWFpbiBmaWx0ZXIgb25lcyB3aXRoIGtlZXBOYXRpdmVTZWxlY3RvcgoJCQkJCWlmICggd2lkZ2V0RWxlbWVudHMubGVuZ3RoICkgewoKCQkJCQkJLy8gJC5tb2JpbGUucGFnZS5wcm90b3R5cGUua2VlcE5hdGl2ZVNlbGVjdG9yIGlzIGRlcHJlY2F0ZWQgdGhpcyBpcyBqdXN0IGZvciBiYWNrY29tcHQKCQkJCQkJLy8gU3dpdGNoIHRvICQubW9iaWxlLmtlZXBOYXRpdmVTZWxlY3RvciBpbiAxLjUgd2hpY2ggaXMganVzdCBhIHZhbHVlIG5vdCBhIGZ1bmN0aW9uCgkJCQkJCXdpZGdldEVsZW1lbnRzID0gd2lkZ2V0RWxlbWVudHMubm90KCAkLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSApOwoJCQkJCX0KCgkJCQkJLy8gRW5oYW5jZSB3aGF0ZXZlciBpcyBsZWZ0CgkJCQkJd2lkZ2V0RWxlbWVudHNbIGNvbnN0cnVjdG9yLnByb3RvdHlwZS53aWRnZXROYW1lIF0oKTsKCQkJCX0KCQkJfSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlhZGREZXBlbmRlbnRzOiBmdW5jdGlvbiggbmV3RGVwZW5kZW50cyApIHsKCQkJJC5hZGREZXBlbmRlbnRzKCB0aGlzLCBuZXdEZXBlbmRlbnRzICk7CgkJfSwKCgkJLy8gbm90ZSB0aGF0IHRoaXMgaGVscGVyIGRvZXNuJ3QgYXR0ZW1wdCB0byBoYW5kbGUgdGhlIGNhbGxiYWNrCgkJLy8gb3Igc2V0dGluZyBvZiBhbiBodG1sIGVsZW1lbnQncyB0ZXh0LCBpdHMgb25seSBwdXJwb3NlIGlzCgkJLy8gdG8gcmV0dXJuIHRoZSBodG1sIGVuY29kZWQgdmVyc2lvbiBvZiB0aGUgdGV4dCBpbiBhbGwgY2FzZXMuICh0aHVzIHRoZSBuYW1lKQoJCWdldEVuY29kZWRUZXh0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQoICI8YT4iICkudGV4dCggdGhpcy50ZXh0KCkgKS5odG1sKCk7CgkJfSwKCgkJLy8gZmx1ZW50IGhlbHBlciBmdW5jdGlvbiBmb3IgdGhlIG1vYmlsZSBuYW1lc3BhY2VkIGVxdWl2YWxlbnQKCQlqcW1FbmhhbmNlYWJsZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5lbmhhbmNlYWJsZSggdGhpcyApOwoJCX0sCgoJCWpxbUhpamFja2FibGU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuaGlqYWNrYWJsZSggdGhpcyApOwoJCX0KCX0pOwoKCSQucmVtb3ZlV2l0aERlcGVuZGVudHMgPSBmdW5jdGlvbiggbmF0aXZlRWxlbWVudCApIHsKCQl2YXIgZWxlbWVudCA9ICQoIG5hdGl2ZUVsZW1lbnQgKTsKCgkJKCBlbGVtZW50LmpxbURhdGEoICJkZXBlbmRlbnRzIiApIHx8ICQoKSApLnJlbW92ZSgpOwoJCWVsZW1lbnQucmVtb3ZlKCk7Cgl9OwoJJC5hZGREZXBlbmRlbnRzID0gZnVuY3Rpb24oIG5hdGl2ZUVsZW1lbnQsIG5ld0RlcGVuZGVudHMgKSB7CgkJdmFyIGVsZW1lbnQgPSAkKCBuYXRpdmVFbGVtZW50ICksCgkJCWRlcGVuZGVudHMgPSBlbGVtZW50LmpxbURhdGEoICJkZXBlbmRlbnRzIiApIHx8ICQoKTsKCgkJZWxlbWVudC5qcW1EYXRhKCAiZGVwZW5kZW50cyIsICQoIGRlcGVuZGVudHMgKS5hZGQoIG5ld0RlcGVuZGVudHMgKSApOwoJfTsKCgkkLmZpbmQubWF0Y2hlcyA9IGZ1bmN0aW9uKCBleHByLCBzZXQgKSB7CgkJcmV0dXJuICQuZmluZCggZXhwciwgbnVsbCwgbnVsbCwgc2V0ICk7Cgl9OwoKCSQuZmluZC5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbiggbm9kZSwgZXhwciApIHsKCQlyZXR1cm4gJC5maW5kKCBleHByLCBudWxsLCBudWxsLCBbIG5vZGUgXSApLmxlbmd0aCA+IDA7Cgl9OwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKCi8qIQogKiBqUXVlcnkgVUkgV2lkZ2V0IEBWRVJTSU9OCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20valF1ZXJ5LndpZGdldC8KICovCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHV1aWQgPSAwLAoJc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsCglfY2xlYW5EYXRhID0gJC5jbGVhbkRhdGE7CiQuY2xlYW5EYXRhID0gZnVuY3Rpb24oIGVsZW1zICkgewoJZm9yICggdmFyIGkgPSAwLCBlbGVtOyAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJdHJ5IHsKCQkJJCggZWxlbSApLnRyaWdnZXJIYW5kbGVyKCAicmVtb3ZlIiApOwoJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzgyMzUKCQl9IGNhdGNoKCBlICkge30KCX0KCV9jbGVhbkRhdGEoIGVsZW1zICk7Cn07CgokLndpZGdldCA9IGZ1bmN0aW9uKCBuYW1lLCBiYXNlLCBwcm90b3R5cGUgKSB7Cgl2YXIgZnVsbE5hbWUsIGV4aXN0aW5nQ29uc3RydWN0b3IsIGNvbnN0cnVjdG9yLCBiYXNlUHJvdG90eXBlLAoJCS8vIHByb3hpZWRQcm90b3R5cGUgYWxsb3dzIHRoZSBwcm92aWRlZCBwcm90b3R5cGUgdG8gcmVtYWluIHVubW9kaWZpZWQKCQkvLyBzbyB0aGF0IGl0IGNhbiBiZSB1c2VkIGFzIGEgbWl4aW4gZm9yIG11bHRpcGxlIHdpZGdldHMgKCM4ODc2KQoJCXByb3hpZWRQcm90b3R5cGUgPSB7fSwKCQluYW1lc3BhY2UgPSBuYW1lLnNwbGl0KCAiLiIgKVsgMCBdOwoKCW5hbWUgPSBuYW1lLnNwbGl0KCAiLiIgKVsgMSBdOwoJZnVsbE5hbWUgPSBuYW1lc3BhY2UgKyAiLSIgKyBuYW1lOwoKCWlmICggIXByb3RvdHlwZSApIHsKCQlwcm90b3R5cGUgPSBiYXNlOwoJCWJhc2UgPSAkLldpZGdldDsKCX0KCgkvLyBjcmVhdGUgc2VsZWN0b3IgZm9yIHBsdWdpbgoJJC5leHByWyAiOiIgXVsgZnVsbE5hbWUudG9Mb3dlckNhc2UoKSBdID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuICEhJC5kYXRhKCBlbGVtLCBmdWxsTmFtZSApOwoJfTsKCgkkWyBuYW1lc3BhY2UgXSA9ICRbIG5hbWVzcGFjZSBdIHx8IHt9OwoJZXhpc3RpbmdDb25zdHJ1Y3RvciA9ICRbIG5hbWVzcGFjZSBdWyBuYW1lIF07Cgljb25zdHJ1Y3RvciA9ICRbIG5hbWVzcGFjZSBdWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQkvLyBhbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgIm5ldyIga2V5d29yZAoJCWlmICggIXRoaXMuX2NyZWF0ZVdpZGdldCApIHsKCQkJcmV0dXJuIG5ldyBjb25zdHJ1Y3Rvciggb3B0aW9ucywgZWxlbWVudCApOwoJCX0KCgkJLy8gYWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0IGluaXRpYWxpemluZyBmb3Igc2ltcGxlIGluaGVyaXRhbmNlCgkJLy8gbXVzdCB1c2UgIm5ldyIga2V5d29yZCAodGhlIGNvZGUgYWJvdmUgYWx3YXlzIHBhc3NlcyBhcmdzKQoJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJdGhpcy5fY3JlYXRlV2lkZ2V0KCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoJfTsKCS8vIGV4dGVuZCB3aXRoIHRoZSBleGlzdGluZyBjb25zdHJ1Y3RvciB0byBjYXJyeSBvdmVyIGFueSBzdGF0aWMgcHJvcGVydGllcwoJJC5leHRlbmQoIGNvbnN0cnVjdG9yLCBleGlzdGluZ0NvbnN0cnVjdG9yLCB7CgkJdmVyc2lvbjogcHJvdG90eXBlLnZlcnNpb24sCgkJLy8gY29weSB0aGUgb2JqZWN0IHVzZWQgdG8gY3JlYXRlIHRoZSBwcm90b3R5cGUgaW4gY2FzZSB3ZSBuZWVkIHRvCgkJLy8gcmVkZWZpbmUgdGhlIHdpZGdldCBsYXRlcgoJCV9wcm90bzogJC5leHRlbmQoIHt9LCBwcm90b3R5cGUgKSwKCQkvLyB0cmFjayB3aWRnZXRzIHRoYXQgaW5oZXJpdCBmcm9tIHRoaXMgd2lkZ2V0IGluIGNhc2UgdGhpcyB3aWRnZXQgaXMKCQkvLyByZWRlZmluZWQgYWZ0ZXIgYSB3aWRnZXQgaW5oZXJpdHMgZnJvbSBpdAoJCV9jaGlsZENvbnN0cnVjdG9yczogW10KCX0pOwoKCWJhc2VQcm90b3R5cGUgPSBuZXcgYmFzZSgpOwoJLy8gd2UgbmVlZCB0byBtYWtlIHRoZSBvcHRpb25zIGhhc2ggYSBwcm9wZXJ0eSBkaXJlY3RseSBvbiB0aGUgbmV3IGluc3RhbmNlCgkvLyBvdGhlcndpc2Ugd2UnbGwgbW9kaWZ5IHRoZSBvcHRpb25zIGhhc2ggb24gdGhlIHByb3RvdHlwZSB0aGF0IHdlJ3JlCgkvLyBpbmhlcml0aW5nIGZyb20KCWJhc2VQcm90b3R5cGUub3B0aW9ucyA9ICQud2lkZ2V0LmV4dGVuZCgge30sIGJhc2VQcm90b3R5cGUub3B0aW9ucyApOwoJJC5lYWNoKCBwcm90b3R5cGUsIGZ1bmN0aW9uKCBwcm9wLCB2YWx1ZSApIHsKCQlpZiAoICEkLmlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CgkJCXByb3hpZWRQcm90b3R5cGVbIHByb3AgXSA9IHZhbHVlOwoJCQlyZXR1cm47CgkJfQoJCXByb3hpZWRQcm90b3R5cGVbIHByb3AgXSA9IChmdW5jdGlvbigpIHsKCQkJdmFyIF9zdXBlciA9IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiBiYXNlLnByb3RvdHlwZVsgcHJvcCBdLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCX0sCgkJCQlfc3VwZXJBcHBseSA9IGZ1bmN0aW9uKCBhcmdzICkgewoJCQkJCXJldHVybiBiYXNlLnByb3RvdHlwZVsgcHJvcCBdLmFwcGx5KCB0aGlzLCBhcmdzICk7CgkJCQl9OwoJCQlyZXR1cm4gZnVuY3Rpb24oKSB7CgkJCQl2YXIgX19zdXBlciA9IHRoaXMuX3N1cGVyLAoJCQkJCV9fc3VwZXJBcHBseSA9IHRoaXMuX3N1cGVyQXBwbHksCgkJCQkJcmV0dXJuVmFsdWU7CgoJCQkJdGhpcy5fc3VwZXIgPSBfc3VwZXI7CgkJCQl0aGlzLl9zdXBlckFwcGx5ID0gX3N1cGVyQXBwbHk7CgoJCQkJcmV0dXJuVmFsdWUgPSB2YWx1ZS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgoJCQkJdGhpcy5fc3VwZXIgPSBfX3N1cGVyOwoJCQkJdGhpcy5fc3VwZXJBcHBseSA9IF9fc3VwZXJBcHBseTsKCgkJCQlyZXR1cm4gcmV0dXJuVmFsdWU7CgkJCX07CgkJfSkoKTsKCX0pOwoJY29uc3RydWN0b3IucHJvdG90eXBlID0gJC53aWRnZXQuZXh0ZW5kKCBiYXNlUHJvdG90eXBlLCB7CgkJLy8gVE9ETzogcmVtb3ZlIHN1cHBvcnQgZm9yIHdpZGdldEV2ZW50UHJlZml4CgkJLy8gYWx3YXlzIHVzZSB0aGUgbmFtZSArIGEgY29sb24gYXMgdGhlIHByZWZpeCwgZS5nLiwgZHJhZ2dhYmxlOnN0YXJ0CgkJLy8gZG9uJ3QgcHJlZml4IGZvciB3aWRnZXRzIHRoYXQgYXJlbid0IERPTS1iYXNlZAoJCXdpZGdldEV2ZW50UHJlZml4OiBleGlzdGluZ0NvbnN0cnVjdG9yID8gKGJhc2VQcm90b3R5cGUud2lkZ2V0RXZlbnRQcmVmaXggfHwgbmFtZSkgOiBuYW1lCgl9LCBwcm94aWVkUHJvdG90eXBlLCB7CgkJY29uc3RydWN0b3I6IGNvbnN0cnVjdG9yLAoJCW5hbWVzcGFjZTogbmFtZXNwYWNlLAoJCXdpZGdldE5hbWU6IG5hbWUsCgkJd2lkZ2V0RnVsbE5hbWU6IGZ1bGxOYW1lCgl9KTsKCgkvLyBJZiB0aGlzIHdpZGdldCBpcyBiZWluZyByZWRlZmluZWQgdGhlbiB3ZSBuZWVkIHRvIGZpbmQgYWxsIHdpZGdldHMgdGhhdAoJLy8gYXJlIGluaGVyaXRpbmcgZnJvbSBpdCBhbmQgcmVkZWZpbmUgYWxsIG9mIHRoZW0gc28gdGhhdCB0aGV5IGluaGVyaXQgZnJvbQoJLy8gdGhlIG5ldyB2ZXJzaW9uIG9mIHRoaXMgd2lkZ2V0LiBXZSdyZSBlc3NlbnRpYWxseSB0cnlpbmcgdG8gcmVwbGFjZSBvbmUKCS8vIGxldmVsIGluIHRoZSBwcm90b3R5cGUgY2hhaW4uCglpZiAoIGV4aXN0aW5nQ29uc3RydWN0b3IgKSB7CgkJJC5lYWNoKCBleGlzdGluZ0NvbnN0cnVjdG9yLl9jaGlsZENvbnN0cnVjdG9ycywgZnVuY3Rpb24oIGksIGNoaWxkICkgewoJCQl2YXIgY2hpbGRQcm90b3R5cGUgPSBjaGlsZC5wcm90b3R5cGU7CgoJCQkvLyByZWRlZmluZSB0aGUgY2hpbGQgd2lkZ2V0IHVzaW5nIHRoZSBzYW1lIHByb3RvdHlwZSB0aGF0IHdhcwoJCQkvLyBvcmlnaW5hbGx5IHVzZWQsIGJ1dCBpbmhlcml0IGZyb20gdGhlIG5ldyB2ZXJzaW9uIG9mIHRoZSBiYXNlCgkJCSQud2lkZ2V0KCBjaGlsZFByb3RvdHlwZS5uYW1lc3BhY2UgKyAiLiIgKyBjaGlsZFByb3RvdHlwZS53aWRnZXROYW1lLCBjb25zdHJ1Y3RvciwgY2hpbGQuX3Byb3RvICk7CgkJfSk7CgkJLy8gcmVtb3ZlIHRoZSBsaXN0IG9mIGV4aXN0aW5nIGNoaWxkIGNvbnN0cnVjdG9ycyBmcm9tIHRoZSBvbGQgY29uc3RydWN0b3IKCQkvLyBzbyB0aGUgb2xkIGNoaWxkIGNvbnN0cnVjdG9ycyBjYW4gYmUgZ2FyYmFnZSBjb2xsZWN0ZWQKCQlkZWxldGUgZXhpc3RpbmdDb25zdHJ1Y3Rvci5fY2hpbGRDb25zdHJ1Y3RvcnM7Cgl9IGVsc2UgewoJCWJhc2UuX2NoaWxkQ29uc3RydWN0b3JzLnB1c2goIGNvbnN0cnVjdG9yICk7Cgl9CgoJJC53aWRnZXQuYnJpZGdlKCBuYW1lLCBjb25zdHJ1Y3RvciApOwoKCXJldHVybiBjb25zdHJ1Y3RvcjsKfTsKCiQud2lkZ2V0LmV4dGVuZCA9IGZ1bmN0aW9uKCB0YXJnZXQgKSB7Cgl2YXIgaW5wdXQgPSBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSwKCQlpbnB1dEluZGV4ID0gMCwKCQlpbnB1dExlbmd0aCA9IGlucHV0Lmxlbmd0aCwKCQlrZXksCgkJdmFsdWU7Cglmb3IgKCA7IGlucHV0SW5kZXggPCBpbnB1dExlbmd0aDsgaW5wdXRJbmRleCsrICkgewoJCWZvciAoIGtleSBpbiBpbnB1dFsgaW5wdXRJbmRleCBdICkgewoJCQl2YWx1ZSA9IGlucHV0WyBpbnB1dEluZGV4IF1bIGtleSBdOwoJCQlpZiAoIGlucHV0WyBpbnB1dEluZGV4IF0uaGFzT3duUHJvcGVydHkoIGtleSApICYmIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQkvLyBDbG9uZSBvYmplY3RzCgkJCQlpZiAoICQuaXNQbGFpbk9iamVjdCggdmFsdWUgKSApIHsKCQkJCQl0YXJnZXRbIGtleSBdID0gJC5pc1BsYWluT2JqZWN0KCB0YXJnZXRbIGtleSBdICkgPwoJCQkJCQkkLndpZGdldC5leHRlbmQoIHt9LCB0YXJnZXRbIGtleSBdLCB2YWx1ZSApIDoKCQkJCQkJLy8gRG9uJ3QgZXh0ZW5kIHN0cmluZ3MsIGFycmF5cywgZXRjLiB3aXRoIG9iamVjdHMKCQkJCQkJJC53aWRnZXQuZXh0ZW5kKCB7fSwgdmFsdWUgKTsKCQkJCS8vIENvcHkgZXZlcnl0aGluZyBlbHNlIGJ5IHJlZmVyZW5jZQoJCQkJfSBlbHNlIHsKCQkJCQl0YXJnZXRbIGtleSBdID0gdmFsdWU7CgkJCQl9CgkJCX0KCQl9Cgl9CglyZXR1cm4gdGFyZ2V0Owp9OwoKJC53aWRnZXQuYnJpZGdlID0gZnVuY3Rpb24oIG5hbWUsIG9iamVjdCApIHsKCXZhciBmdWxsTmFtZSA9IG9iamVjdC5wcm90b3R5cGUud2lkZ2V0RnVsbE5hbWUgfHwgbmFtZTsKCSQuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBpc01ldGhvZENhbGwgPSB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyIsCgkJCWFyZ3MgPSBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSwKCQkJcmV0dXJuVmFsdWUgPSB0aGlzOwoKCQkvLyBhbGxvdyBtdWx0aXBsZSBoYXNoZXMgdG8gYmUgcGFzc2VkIG9uIGluaXQKCQlvcHRpb25zID0gIWlzTWV0aG9kQ2FsbCAmJiBhcmdzLmxlbmd0aCA/CgkJCSQud2lkZ2V0LmV4dGVuZC5hcHBseSggbnVsbCwgWyBvcHRpb25zIF0uY29uY2F0KGFyZ3MpICkgOgoJCQlvcHRpb25zOwoKCQlpZiAoIGlzTWV0aG9kQ2FsbCApIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIG1ldGhvZFZhbHVlLAoJCQkJCWluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSApOwoJCQkJaWYgKCBvcHRpb25zID09PSAiaW5zdGFuY2UiICkgewoJCQkJCXJldHVyblZhbHVlID0gaW5zdGFuY2U7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQkJaWYgKCAhaW5zdGFuY2UgKSB7CgkJCQkJcmV0dXJuICQuZXJyb3IoICJjYW5ub3QgY2FsbCBtZXRob2RzIG9uICIgKyBuYW1lICsgIiBwcmlvciB0byBpbml0aWFsaXphdGlvbjsgIiArCgkJCQkJCSJhdHRlbXB0ZWQgdG8gY2FsbCBtZXRob2QgJyIgKyBvcHRpb25zICsgIiciICk7CgkJCQl9CgkJCQlpZiAoICEkLmlzRnVuY3Rpb24oIGluc3RhbmNlW29wdGlvbnNdICkgfHwgb3B0aW9ucy5jaGFyQXQoIDAgKSA9PT0gIl8iICkgewoJCQkJCXJldHVybiAkLmVycm9yKCAibm8gc3VjaCBtZXRob2QgJyIgKyBvcHRpb25zICsgIicgZm9yICIgKyBuYW1lICsgIiB3aWRnZXQgaW5zdGFuY2UiICk7CgkJCQl9CgkJCQltZXRob2RWYWx1ZSA9IGluc3RhbmNlWyBvcHRpb25zIF0uYXBwbHkoIGluc3RhbmNlLCBhcmdzICk7CgkJCQlpZiAoIG1ldGhvZFZhbHVlICE9PSBpbnN0YW5jZSAmJiBtZXRob2RWYWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVyblZhbHVlID0gbWV0aG9kVmFsdWUgJiYgbWV0aG9kVmFsdWUuanF1ZXJ5ID8KCQkJCQkJcmV0dXJuVmFsdWUucHVzaFN0YWNrKCBtZXRob2RWYWx1ZS5nZXQoKSApIDoKCQkJCQkJbWV0aG9kVmFsdWU7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9KTsKCQl9IGVsc2UgewoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgaW5zdGFuY2UgPSAkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lICk7CgkJCQlpZiAoIGluc3RhbmNlICkgewoJCQkJCWluc3RhbmNlLm9wdGlvbiggb3B0aW9ucyB8fCB7fSApLl9pbml0KCk7CgkJCQl9IGVsc2UgewoJCQkJCSQuZGF0YSggdGhpcywgZnVsbE5hbWUsIG5ldyBvYmplY3QoIG9wdGlvbnMsIHRoaXMgKSApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXJldHVybiByZXR1cm5WYWx1ZTsKCX07Cn07CgokLldpZGdldCA9IGZ1bmN0aW9uKCAvKiBvcHRpb25zLCBlbGVtZW50ICovICkge307CiQuV2lkZ2V0Ll9jaGlsZENvbnN0cnVjdG9ycyA9IFtdOwoKJC5XaWRnZXQucHJvdG90eXBlID0gewoJd2lkZ2V0TmFtZTogIndpZGdldCIsCgl3aWRnZXRFdmVudFByZWZpeDogIiIsCglkZWZhdWx0RWxlbWVudDogIjxkaXY+IiwKCW9wdGlvbnM6IHsKCQlkaXNhYmxlZDogZmFsc2UsCgoJCS8vIGNhbGxiYWNrcwoJCWNyZWF0ZTogbnVsbAoJfSwKCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCWVsZW1lbnQgPSAkKCBlbGVtZW50IHx8IHRoaXMuZGVmYXVsdEVsZW1lbnQgfHwgdGhpcyApWyAwIF07CgkJdGhpcy5lbGVtZW50ID0gJCggZWxlbWVudCApOwoJCXRoaXMudXVpZCA9IHV1aWQrKzsKCQl0aGlzLmV2ZW50TmFtZXNwYWNlID0gIi4iICsgdGhpcy53aWRnZXROYW1lICsgdGhpcy51dWlkOwoJCXRoaXMub3B0aW9ucyA9ICQud2lkZ2V0LmV4dGVuZCgge30sCgkJCXRoaXMub3B0aW9ucywKCQkJdGhpcy5fZ2V0Q3JlYXRlT3B0aW9ucygpLAoJCQlvcHRpb25zICk7CgoJCXRoaXMuYmluZGluZ3MgPSAkKCk7CgkJdGhpcy5ob3ZlcmFibGUgPSAkKCk7CgkJdGhpcy5mb2N1c2FibGUgPSAkKCk7CgoJCWlmICggZWxlbWVudCAhPT0gdGhpcyApIHsKCQkJJC5kYXRhKCBlbGVtZW50LCB0aGlzLndpZGdldEZ1bGxOYW1lLCB0aGlzICk7CgkJCXRoaXMuX29uKCB0cnVlLCB0aGlzLmVsZW1lbnQsIHsKCQkJCXJlbW92ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCWlmICggZXZlbnQudGFyZ2V0ID09PSBlbGVtZW50ICkgewoJCQkJCQl0aGlzLmRlc3Ryb3koKTsKCQkJCQl9CgkJCQl9CgkJCX0pOwoJCQl0aGlzLmRvY3VtZW50ID0gJCggZWxlbWVudC5zdHlsZSA/CgkJCQkvLyBlbGVtZW50IHdpdGhpbiB0aGUgZG9jdW1lbnQKCQkJCWVsZW1lbnQub3duZXJEb2N1bWVudCA6CgkJCQkvLyBlbGVtZW50IGlzIHdpbmRvdyBvciBkb2N1bWVudAoJCQkJZWxlbWVudC5kb2N1bWVudCB8fCBlbGVtZW50ICk7CgkJCXRoaXMud2luZG93ID0gJCggdGhpcy5kb2N1bWVudFswXS5kZWZhdWx0VmlldyB8fCB0aGlzLmRvY3VtZW50WzBdLnBhcmVudFdpbmRvdyApOwoJCX0KCgkJdGhpcy5fY3JlYXRlKCk7CgkJdGhpcy5fdHJpZ2dlciggImNyZWF0ZSIsIG51bGwsIHRoaXMuX2dldENyZWF0ZUV2ZW50RGF0YSgpICk7CgkJdGhpcy5faW5pdCgpOwoJfSwKCV9nZXRDcmVhdGVPcHRpb25zOiAkLm5vb3AsCglfZ2V0Q3JlYXRlRXZlbnREYXRhOiAkLm5vb3AsCglfY3JlYXRlOiAkLm5vb3AsCglfaW5pdDogJC5ub29wLAoKCWRlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2Rlc3Ryb3koKTsKCQkvLyB3ZSBjYW4gcHJvYmFibHkgcmVtb3ZlIHRoZSB1bmJpbmQgY2FsbHMgaW4gMi4wCgkJLy8gYWxsIGV2ZW50IGJpbmRpbmdzIHNob3VsZCBnbyB0aHJvdWdoIHRoaXMuX29uKCkKCQl0aGlzLmVsZW1lbnQKCQkJLnVuYmluZCggdGhpcy5ldmVudE5hbWVzcGFjZSApCgkJCS5yZW1vdmVEYXRhKCB0aGlzLndpZGdldEZ1bGxOYW1lICkKCQkJLy8gc3VwcG9ydDoganF1ZXJ5IDwxLjYuMwoJCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC85NDEzCgkJCS5yZW1vdmVEYXRhKCAkLmNhbWVsQ2FzZSggdGhpcy53aWRnZXRGdWxsTmFtZSApICk7CgkJdGhpcy53aWRnZXQoKQoJCQkudW5iaW5kKCB0aGlzLmV2ZW50TmFtZXNwYWNlICkKCQkJLnJlbW92ZUF0dHIoICJhcmlhLWRpc2FibGVkIiApCgkJCS5yZW1vdmVDbGFzcygKCQkJCXRoaXMud2lkZ2V0RnVsbE5hbWUgKyAiLWRpc2FibGVkICIgKwoJCQkJInVpLXN0YXRlLWRpc2FibGVkIiApOwoKCQkvLyBjbGVhbiB1cCBldmVudHMgYW5kIHN0YXRlcwoJCXRoaXMuYmluZGluZ3MudW5iaW5kKCB0aGlzLmV2ZW50TmFtZXNwYWNlICk7CgkJdGhpcy5ob3ZlcmFibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQl0aGlzLmZvY3VzYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJfSwKCV9kZXN0cm95OiAkLm5vb3AsCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lbGVtZW50OwoJfSwKCglvcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXZhciBvcHRpb25zID0ga2V5LAoJCQlwYXJ0cywKCQkJY3VyT3B0aW9uLAoJCQlpOwoKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPT09IDAgKSB7CgkJCS8vIGRvbid0IHJldHVybiBhIHJlZmVyZW5jZSB0byB0aGUgaW50ZXJuYWwgaGFzaAoJCQlyZXR1cm4gJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zICk7CgkJfQoKCQlpZiAoIHR5cGVvZiBrZXkgPT09ICJzdHJpbmciICkgewoJCQkvLyBoYW5kbGUgbmVzdGVkIGtleXMsIGUuZy4sICJmb28uYmFyIiA9PiB7IGZvbzogeyBiYXI6IF9fXyB9IH0KCQkJb3B0aW9ucyA9IHt9OwoJCQlwYXJ0cyA9IGtleS5zcGxpdCggIi4iICk7CgkJCWtleSA9IHBhcnRzLnNoaWZ0KCk7CgkJCWlmICggcGFydHMubGVuZ3RoICkgewoJCQkJY3VyT3B0aW9uID0gb3B0aW9uc1sga2V5IF0gPSAkLndpZGdldC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnNbIGtleSBdICk7CgkJCQlmb3IgKCBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aCAtIDE7IGkrKyApIHsKCQkJCQljdXJPcHRpb25bIHBhcnRzWyBpIF0gXSA9IGN1ck9wdGlvblsgcGFydHNbIGkgXSBdIHx8IHt9OwoJCQkJCWN1ck9wdGlvbiA9IGN1ck9wdGlvblsgcGFydHNbIGkgXSBdOwoJCQkJfQoJCQkJa2V5ID0gcGFydHMucG9wKCk7CgkJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIGN1ck9wdGlvblsga2V5IF0gPT09IHVuZGVmaW5lZCA/IG51bGwgOiBjdXJPcHRpb25bIGtleSBdOwoJCQkJfQoJCQkJY3VyT3B0aW9uWyBrZXkgXSA9IHZhbHVlOwoJCQl9IGVsc2UgewoJCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVybiB0aGlzLm9wdGlvbnNbIGtleSBdID09PSB1bmRlZmluZWQgPyBudWxsIDogdGhpcy5vcHRpb25zWyBrZXkgXTsKCQkJCX0KCQkJCW9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgkJCX0KCQl9CgoJCXRoaXMuX3NldE9wdGlvbnMoIG9wdGlvbnMgKTsKCgkJcmV0dXJuIHRoaXM7Cgl9LAoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBrZXk7CgoJCWZvciAoIGtleSBpbiBvcHRpb25zICkgewoJCQl0aGlzLl9zZXRPcHRpb24oIGtleSwgb3B0aW9uc1sga2V5IF0gKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXRoaXMub3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7CgkJCXRoaXMud2lkZ2V0KCkKCQkJCS50b2dnbGVDbGFzcyggdGhpcy53aWRnZXRGdWxsTmFtZSArICItZGlzYWJsZWQiLCAhIXZhbHVlICk7CgkJCXRoaXMuaG92ZXJhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJCXRoaXMuZm9jdXNhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9ucyh7IGRpc2FibGVkOiBmYWxzZSB9KTsKCX0sCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9ucyh7IGRpc2FibGVkOiB0cnVlIH0pOwoJfSwKCglfb246IGZ1bmN0aW9uKCBzdXBwcmVzc0Rpc2FibGVkQ2hlY2ssIGVsZW1lbnQsIGhhbmRsZXJzICkgewoJCXZhciBkZWxlZ2F0ZUVsZW1lbnQsCgkJCWluc3RhbmNlID0gdGhpczsKCgkJLy8gbm8gc3VwcHJlc3NEaXNhYmxlZENoZWNrIGZsYWcsIHNodWZmbGUgYXJndW1lbnRzCgkJaWYgKCB0eXBlb2Ygc3VwcHJlc3NEaXNhYmxlZENoZWNrICE9PSAiYm9vbGVhbiIgKSB7CgkJCWhhbmRsZXJzID0gZWxlbWVudDsKCQkJZWxlbWVudCA9IHN1cHByZXNzRGlzYWJsZWRDaGVjazsKCQkJc3VwcHJlc3NEaXNhYmxlZENoZWNrID0gZmFsc2U7CgkJfQoKCQkvLyBubyBlbGVtZW50IGFyZ3VtZW50LCBzaHVmZmxlIGFuZCB1c2UgdGhpcy5lbGVtZW50CgkJaWYgKCAhaGFuZGxlcnMgKSB7CgkJCWhhbmRsZXJzID0gZWxlbWVudDsKCQkJZWxlbWVudCA9IHRoaXMuZWxlbWVudDsKCQkJZGVsZWdhdGVFbGVtZW50ID0gdGhpcy53aWRnZXQoKTsKCQl9IGVsc2UgewoJCQkvLyBhY2NlcHQgc2VsZWN0b3JzLCBET00gZWxlbWVudHMKCQkJZWxlbWVudCA9IGRlbGVnYXRlRWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQkJdGhpcy5iaW5kaW5ncyA9IHRoaXMuYmluZGluZ3MuYWRkKCBlbGVtZW50ICk7CgkJfQoKCQkkLmVhY2goIGhhbmRsZXJzLCBmdW5jdGlvbiggZXZlbnQsIGhhbmRsZXIgKSB7CgkJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsKCQkJCS8vIGFsbG93IHdpZGdldHMgdG8gY3VzdG9taXplIHRoZSBkaXNhYmxlZCBoYW5kbGluZwoJCQkJLy8gLSBkaXNhYmxlZCBhcyBhbiBhcnJheSBpbnN0ZWFkIG9mIGJvb2xlYW4KCQkJCS8vIC0gZGlzYWJsZWQgY2xhc3MgYXMgbWV0aG9kIGZvciBkaXNhYmxpbmcgaW5kaXZpZHVhbCBwYXJ0cwoJCQkJaWYgKCAhc3VwcHJlc3NEaXNhYmxlZENoZWNrICYmCgkJCQkJCSggaW5zdGFuY2Uub3B0aW9ucy5kaXNhYmxlZCA9PT0gdHJ1ZSB8fAoJCQkJCQkJJCggdGhpcyApLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlyZXR1cm4gKCB0eXBlb2YgaGFuZGxlciA9PT0gInN0cmluZyIgPyBpbnN0YW5jZVsgaGFuZGxlciBdIDogaGFuZGxlciApCgkJCQkJLmFwcGx5KCBpbnN0YW5jZSwgYXJndW1lbnRzICk7CgkJCX0KCgkJCS8vIGNvcHkgdGhlIGd1aWQgc28gZGlyZWN0IHVuYmluZGluZyB3b3JrcwoJCQlpZiAoIHR5cGVvZiBoYW5kbGVyICE9PSAic3RyaW5nIiApIHsKCQkJCWhhbmRsZXJQcm94eS5ndWlkID0gaGFuZGxlci5ndWlkID0KCQkJCQloYW5kbGVyLmd1aWQgfHwgaGFuZGxlclByb3h5Lmd1aWQgfHwgJC5ndWlkKys7CgkJCX0KCgkJCXZhciBtYXRjaCA9IGV2ZW50Lm1hdGNoKCAvXihcdyspXHMqKC4qKSQvICksCgkJCQlldmVudE5hbWUgPSBtYXRjaFsxXSArIGluc3RhbmNlLmV2ZW50TmFtZXNwYWNlLAoJCQkJc2VsZWN0b3IgPSBtYXRjaFsyXTsKCQkJaWYgKCBzZWxlY3RvciApIHsKCQkJCWRlbGVnYXRlRWxlbWVudC5kZWxlZ2F0ZSggc2VsZWN0b3IsIGV2ZW50TmFtZSwgaGFuZGxlclByb3h5ICk7CgkJCX0gZWxzZSB7CgkJCQllbGVtZW50LmJpbmQoIGV2ZW50TmFtZSwgaGFuZGxlclByb3h5ICk7CgkJCX0KCQl9KTsKCX0sCgoJX29mZjogZnVuY3Rpb24oIGVsZW1lbnQsIGV2ZW50TmFtZSApIHsKCQlldmVudE5hbWUgPSAoZXZlbnROYW1lIHx8ICIiKS5zcGxpdCggIiAiICkuam9pbiggdGhpcy5ldmVudE5hbWVzcGFjZSArICIgIiApICsgdGhpcy5ldmVudE5hbWVzcGFjZTsKCQllbGVtZW50LnVuYmluZCggZXZlbnROYW1lICkudW5kZWxlZ2F0ZSggZXZlbnROYW1lICk7Cgl9LAoKCV9kZWxheTogZnVuY3Rpb24oIGhhbmRsZXIsIGRlbGF5ICkgewoJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsKCQkJcmV0dXJuICggdHlwZW9mIGhhbmRsZXIgPT09ICJzdHJpbmciID8gaW5zdGFuY2VbIGhhbmRsZXIgXSA6IGhhbmRsZXIgKQoJCQkJLmFwcGx5KCBpbnN0YW5jZSwgYXJndW1lbnRzICk7CgkJfQoJCXZhciBpbnN0YW5jZSA9IHRoaXM7CgkJcmV0dXJuIHNldFRpbWVvdXQoIGhhbmRsZXJQcm94eSwgZGVsYXkgfHwgMCApOwoJfSwKCglfaG92ZXJhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl0aGlzLmhvdmVyYWJsZSA9IHRoaXMuaG92ZXJhYmxlLmFkZCggZWxlbWVudCApOwoJCXRoaXMuX29uKCBlbGVtZW50LCB7CgkJCW1vdXNlZW50ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5hZGRDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl9LAoJCQltb3VzZWxlYXZlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJfQoJCX0pOwoJfSwKCglfZm9jdXNhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl0aGlzLmZvY3VzYWJsZSA9IHRoaXMuZm9jdXNhYmxlLmFkZCggZWxlbWVudCApOwoJCXRoaXMuX29uKCBlbGVtZW50LCB7CgkJCWZvY3VzaW46IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5hZGRDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCQl9LAoJCQlmb2N1c291dDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJCX0KCQl9KTsKCX0sCgoJX3RyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBldmVudCwgZGF0YSApIHsKCQl2YXIgcHJvcCwgb3JpZywKCQkJY2FsbGJhY2sgPSB0aGlzLm9wdGlvbnNbIHR5cGUgXTsKCgkJZGF0YSA9IGRhdGEgfHwge307CgkJZXZlbnQgPSAkLkV2ZW50KCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSAoIHR5cGUgPT09IHRoaXMud2lkZ2V0RXZlbnRQcmVmaXggPwoJCQl0eXBlIDoKCQkJdGhpcy53aWRnZXRFdmVudFByZWZpeCArIHR5cGUgKS50b0xvd2VyQ2FzZSgpOwoJCS8vIHRoZSBvcmlnaW5hbCBldmVudCBtYXkgY29tZSBmcm9tIGFueSBlbGVtZW50CgkJLy8gc28gd2UgbmVlZCB0byByZXNldCB0aGUgdGFyZ2V0IG9uIHRoZSBuZXcgZXZlbnQKCQlldmVudC50YXJnZXQgPSB0aGlzLmVsZW1lbnRbIDAgXTsKCgkJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJCW9yaWcgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJCWlmICggb3JpZyApIHsKCQkJZm9yICggcHJvcCBpbiBvcmlnICkgewoJCQkJaWYgKCAhKCBwcm9wIGluIGV2ZW50ICkgKSB7CgkJCQkJZXZlbnRbIHByb3AgXSA9IG9yaWdbIHByb3AgXTsKCQkJCX0KCQkJfQoJCX0KCgkJdGhpcy5lbGVtZW50LnRyaWdnZXIoIGV2ZW50LCBkYXRhICk7CgkJcmV0dXJuICEoICQuaXNGdW5jdGlvbiggY2FsbGJhY2sgKSAmJgoJCQljYWxsYmFjay5hcHBseSggdGhpcy5lbGVtZW50WzBdLCBbIGV2ZW50IF0uY29uY2F0KCBkYXRhICkgKSA9PT0gZmFsc2UgfHwKCQkJZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKTsKCX0KfTsKCiQuZWFjaCggeyBzaG93OiAiZmFkZUluIiwgaGlkZTogImZhZGVPdXQiIH0sIGZ1bmN0aW9uKCBtZXRob2QsIGRlZmF1bHRFZmZlY3QgKSB7CgkkLldpZGdldC5wcm90b3R5cGVbICJfIiArIG1ldGhvZCBdID0gZnVuY3Rpb24oIGVsZW1lbnQsIG9wdGlvbnMsIGNhbGxiYWNrICkgewoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciICkgewoJCQlvcHRpb25zID0geyBlZmZlY3Q6IG9wdGlvbnMgfTsKCQl9CgkJdmFyIGhhc09wdGlvbnMsCgkJCWVmZmVjdE5hbWUgPSAhb3B0aW9ucyA/CgkJCQltZXRob2QgOgoJCQkJb3B0aW9ucyA9PT0gdHJ1ZSB8fCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgPwoJCQkJCWRlZmF1bHRFZmZlY3QgOgoJCQkJCW9wdGlvbnMuZWZmZWN0IHx8IGRlZmF1bHRFZmZlY3Q7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgKSB7CgkJCW9wdGlvbnMgPSB7IGR1cmF0aW9uOiBvcHRpb25zIH07CgkJfQoJCWhhc09wdGlvbnMgPSAhJC5pc0VtcHR5T2JqZWN0KCBvcHRpb25zICk7CgkJb3B0aW9ucy5jb21wbGV0ZSA9IGNhbGxiYWNrOwoJCWlmICggb3B0aW9ucy5kZWxheSApIHsKCQkJZWxlbWVudC5kZWxheSggb3B0aW9ucy5kZWxheSApOwoJCX0KCQlpZiAoIGhhc09wdGlvbnMgJiYgJC5lZmZlY3RzICYmICQuZWZmZWN0cy5lZmZlY3RbIGVmZmVjdE5hbWUgXSApIHsKCQkJZWxlbWVudFsgbWV0aG9kIF0oIG9wdGlvbnMgKTsKCQl9IGVsc2UgaWYgKCBlZmZlY3ROYW1lICE9PSBtZXRob2QgJiYgZWxlbWVudFsgZWZmZWN0TmFtZSBdICkgewoJCQllbGVtZW50WyBlZmZlY3ROYW1lIF0oIG9wdGlvbnMuZHVyYXRpb24sIG9wdGlvbnMuZWFzaW5nLCBjYWxsYmFjayApOwoJCX0gZWxzZSB7CgkJCWVsZW1lbnQucXVldWUoZnVuY3Rpb24oIG5leHQgKSB7CgkJCQkkKCB0aGlzIClbIG1ldGhvZCBdKCk7CgkJCQlpZiAoIGNhbGxiYWNrICkgewoJCQkJCWNhbGxiYWNrLmNhbGwoIGVsZW1lbnRbIDAgXSApOwoJCQkJfQoJCQkJbmV4dCgpOwoJCQl9KTsKCQl9Cgl9Owp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHJjYXBpdGFscyA9IC9bQS1aXS9nLAoJcmVwbGFjZUZ1bmN0aW9uID0gZnVuY3Rpb24oIGMgKSB7CgkJcmV0dXJuICItIiArIGMudG9Mb3dlckNhc2UoKTsKCX07CgokLmV4dGVuZCggJC5XaWRnZXQucHJvdG90eXBlLCB7CglfZ2V0Q3JlYXRlT3B0aW9uczogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbiwgdmFsdWUsCgkJCWVsZW0gPSB0aGlzLmVsZW1lbnRbIDAgXSwKCQkJb3B0aW9ucyA9IHt9OwoKCQlmb3IgKCBvcHRpb24gaW4gdGhpcy5vcHRpb25zICkgewoJCQl2YWx1ZSA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggZWxlbSwgb3B0aW9uLnJlcGxhY2UoIHJjYXBpdGFscywgcmVwbGFjZUZ1bmN0aW9uICkgKTsKCQkJaWYgKCB2YWx1ZSAhPSBudWxsICkgewoJCQkJb3B0aW9uc1sgb3B0aW9uIF0gPSB2YWx1ZTsKCQkJfQoJCX0KCgkJcmV0dXJuIG9wdGlvbnM7Cgl9LAoKCWVuaGFuY2VXaXRoaW46IGZ1bmN0aW9uKCB0YXJnZXQsIHVzZUtlZXBOYXRpdmUgKSB7CgkJdGhpcy5lbmhhbmNlKCAkKCAkWyB0aGlzLm5hbWVzcGFjZSBdWyB0aGlzLndpZGdldE5hbWUgXS5pbml0U2VsZWN0b3IsICQoIHRhcmdldCApICksIHVzZUtlZXBOYXRpdmUgKTsKCX0sCgoJZW5oYW5jZTogZnVuY3Rpb24oIHRhcmdldHMsIHVzZUtlZXBOYXRpdmUgKSB7CgkJdmFyIHBhZ2UsIGtlZXBOYXRpdmUsICR3aWRnZXRFbGVtZW50cyA9ICQoIHRhcmdldHMgKTsKCgkJLy8gaWYgaWdub3JlQ29udGVudEVuYWJsZWQgaXMgc2V0IHRvIHRydWUgdGhlIGZyYW1ld29yayBzaG91bGQKCQkvLyBvbmx5IGVuaGFuY2UgdGhlIHNlbGVjdGVkIGVsZW1lbnRzIHdoZW4gdGhleSBkbyBOT1QgaGF2ZSBhCgkJLy8gcGFyZW50IHdpdGggdGhlIGRhdGEtbmFtZXNwYWNlLWlnbm9yZSBhdHRyaWJ1dGUKCQkkd2lkZ2V0RWxlbWVudHMgPSAkLm1vYmlsZS5lbmhhbmNlYWJsZSggJHdpZGdldEVsZW1lbnRzICk7CgoJCWlmICggdXNlS2VlcE5hdGl2ZSAmJiAkd2lkZ2V0RWxlbWVudHMubGVuZ3RoICkgewoJCQkvLyBUT0RPIHJlbW92ZSBkZXBlbmRlbmN5IG9uIHRoZSBwYWdlIHdpZGdldCBmb3IgdGhlIGtlZXBOYXRpdmUuCgkJCS8vIEN1cnJlbnRseSB0aGUga2VlcE5hdGl2ZSB2YWx1ZSBpcyBkZWZpbmVkIG9uIHRoZSBwYWdlIHByb3RvdHlwZSBzbwoJCQkvLyB0aGUgbWV0aG9kIGlzIGFzIHdlbGwKCQkJcGFnZSA9ICQubW9iaWxlLmNsb3Nlc3RQYWdlRGF0YSggJHdpZGdldEVsZW1lbnRzICk7CgkJCWtlZXBOYXRpdmUgPSAoIHBhZ2UgJiYgcGFnZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSkgfHwgIiI7CgoJCQkkd2lkZ2V0RWxlbWVudHMgPSAkd2lkZ2V0RWxlbWVudHMubm90KCBrZWVwTmF0aXZlICk7CgkJfQoKCQkkd2lkZ2V0RWxlbWVudHNbIHRoaXMud2lkZ2V0TmFtZSBdKCk7Cgl9Cn0pOwoKLy9UT0RPOiBSZW1vdmUgaW4gMS41IGZvciBiYWNrY29tcGF0IG9ubHkKJC5tb2JpbGUud2lkZ2V0ID0gJC5XaWRnZXQ7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkICkgewoJLy8gREVQUkVDQVRFRAoJLy8gTk9URSBnbG9iYWwgbW9iaWxlIG9iamVjdCBzZXR0aW5ncwoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gREVQUkVDQVRFRCBTaG91bGQgdGhlIHRleHQgYmUgdmlzYmxlIGluIHRoZSBsb2FkaW5nIG1lc3NhZ2U/CgkJbG9hZGluZ01lc3NhZ2VUZXh0VmlzaWJsZTogdW5kZWZpbmVkLAoKCQkvLyBERVBSRUNBVEVEIFdoZW4gdGhlIHRleHQgaXMgdmlzaWJsZSwgd2hhdCB0aGVtZSBkb2VzIHRoZSBsb2FkaW5nIGJveCB1c2U/CgkJbG9hZGluZ01lc3NhZ2VUaGVtZTogdW5kZWZpbmVkLAoKCQkvLyBERVBSRUNBVEVEIGRlZmF1bHQgbWVzc2FnZSBzZXR0aW5nCgkJbG9hZGluZ01lc3NhZ2U6IHVuZGVmaW5lZCwKCgkJLy8gREVQUkVDQVRFRAoJCS8vIFR1cm4gb24vb2ZmIHBhZ2UgbG9hZGluZyBtZXNzYWdlLiBUaGVtZSBkb3VibGVzIGFzIGFuIG9iamVjdCBhcmd1bWVudAoJCS8vIHdpdGggdGhlIGZvbGxvd2luZyBzaGFwZTogeyB0aGVtZTogJycsIHRleHQ6ICcnLCBodG1sOiAnJywgdGV4dFZpc2libGU6ICcnIH0KCQkvLyBOT1RFIHRoYXQgdGhlICQubW9iaWxlLmxvYWRpbmcqIHNldHRpbmdzIGFuZCBwYXJhbXMgcGFzdCB0aGUgZmlyc3QgYXJlIGRlcHJlY2F0ZWQKCQlzaG93UGFnZUxvYWRpbmdNc2c6IGZ1bmN0aW9uKCB0aGVtZSwgbXNnVGV4dCwgdGV4dG9ubHkgKSB7CgkJCSQubW9iaWxlLmxvYWRpbmcoICJzaG93IiwgdGhlbWUsIG1zZ1RleHQsIHRleHRvbmx5ICk7CgkJfSwKCgkJLy8gREVQUkVDQVRFRAoJCWhpZGVQYWdlTG9hZGluZ01zZzogZnVuY3Rpb24oKSB7CgkJCSQubW9iaWxlLmxvYWRpbmcoICJoaWRlIiApOwoJCX0sCgoJCWxvYWRpbmc6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmxvYWRlcldpZGdldC5sb2FkZXIuYXBwbHkoIHRoaXMubG9hZGVyV2lkZ2V0LCBhcmd1bWVudHMgKTsKCQl9Cgl9KTsKCgkvLyBUT0RPIG1vdmUgbG9hZGVyIGNsYXNzIGRvd24gaW50byB0aGUgd2lkZ2V0IHNldHRpbmdzCgl2YXIgbG9hZGVyQ2xhc3MgPSAidWktbG9hZGVyIiwgJGh0bWwgPSAkKCAiaHRtbCIgKSwgJHdpbmRvdyA9ICQubW9iaWxlLndpbmRvdzsKCgkkLndpZGdldCggIm1vYmlsZS5sb2FkZXIiLCB7CgkJLy8gTk9URSBpZiB0aGUgZ2xvYmFsIGNvbmZpZyBzZXR0aW5ncyBhcmUgZGVmaW5lZCB0aGV5IHdpbGwgb3ZlcnJpZGUgdGhlc2UKCQkvLyAgICAgIG9wdGlvbnMKCQlvcHRpb25zOiB7CgkJCS8vIHRoZSB0aGVtZSBmb3IgdGhlIGxvYWRpbmcgbWVzc2FnZQoJCQl0aGVtZTogImEiLAoKCQkJLy8gd2hldGhlciB0aGUgdGV4dCBpbiB0aGUgbG9hZGluZyBtZXNzYWdlIGlzIHNob3duCgkJCXRleHRWaXNpYmxlOiBmYWxzZSwKCgkJCS8vIGN1c3RvbSBodG1sIGZvciB0aGUgaW5uZXIgY29udGVudCBvZiB0aGUgbG9hZGluZyBtZXNzYWdlCgkJCWh0bWw6ICIiLAoKCQkJLy8gdGhlIHRleHQgdG8gYmUgZGlzcGxheWVkIHdoZW4gdGhlIHBvcHVwIGlzIHNob3duCgkJCXRleHQ6ICJsb2FkaW5nIgoJCX0sCgoJCWRlZmF1bHRIdG1sOiAiPGRpdiBjbGFzcz0nIiArIGxvYWRlckNsYXNzICsgIic+IiArCgkJCSI8c3BhbiBjbGFzcz0ndWktaWNvbi1sb2FkaW5nJz48L3NwYW4+IiArCgkJCSI8aDE+PC9oMT4iICsKCQkJIjwvZGl2PiIsCgoJCS8vIEZvciBub24tZml4ZWQgc3VwcG9ydGluIGJyb3dzZXJzLiBQb3NpdGlvbiBhdCB5IGNlbnRlciAoaWYgc2Nyb2xsVG9wIHN1cHBvcnRlZCksIGFib3ZlIHRoZSBhY3RpdmVCdG4gKGlmIGRlZmluZWQpLCBvciBqdXN0IDEwMHB4IGZyb20gdG9wCgkJZmFrZUZpeExvYWRlcjogZnVuY3Rpb24oKSB7CgkJCXZhciBhY3RpdmVCdG4gPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApLmZpcnN0KCk7CgoJCQl0aGlzLmVsZW1lbnQKCQkJCS5jc3MoewoJCQkJCXRvcDogJC5zdXBwb3J0LnNjcm9sbFRvcCAmJiAkd2luZG93LnNjcm9sbFRvcCgpICsgJHdpbmRvdy5oZWlnaHQoKSAvIDIgfHwKCQkJCQkJYWN0aXZlQnRuLmxlbmd0aCAmJiBhY3RpdmVCdG4ub2Zmc2V0KCkudG9wIHx8IDEwMAoJCQkJfSk7CgkJfSwKCgkJLy8gY2hlY2sgcG9zaXRpb24gb2YgbG9hZGVyIHRvIHNlZSBpZiBpdCBhcHBlYXJzIHRvIGJlICJmaXhlZCIgdG8gY2VudGVyCgkJLy8gaWYgbm90LCB1c2UgYWJzIHBvc2l0aW9uaW5nCgkJY2hlY2tMb2FkZXJQb3NpdGlvbjogZnVuY3Rpb24oKSB7CgkJCXZhciBvZmZzZXQgPSB0aGlzLmVsZW1lbnQub2Zmc2V0KCksCgkJCQlzY3JvbGxUb3AgPSAkd2luZG93LnNjcm9sbFRvcCgpLAoJCQkJc2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCQlpZiAoIG9mZnNldC50b3AgPCBzY3JvbGxUb3AgfHwgKCBvZmZzZXQudG9wIC0gc2Nyb2xsVG9wICkgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1sb2FkZXItZmFrZWZpeCIgKTsKCQkJCXRoaXMuZmFrZUZpeExvYWRlcigpOwoJCQkJJHdpbmRvdwoJCQkJCS51bmJpbmQoICJzY3JvbGwiLCB0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24gKQoJCQkJCS5iaW5kKCAic2Nyb2xsIiwgJC5wcm94eSggdGhpcy5mYWtlRml4TG9hZGVyLCB0aGlzICkgKTsKCQkJfQoJCX0sCgoJCXJlc2V0SHRtbDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5odG1sKCAkKCB0aGlzLmRlZmF1bHRIdG1sICkuaHRtbCgpICk7CgkJfSwKCgkJLy8gVHVybiBvbi9vZmYgcGFnZSBsb2FkaW5nIG1lc3NhZ2UuIFRoZW1lIGRvdWJsZXMgYXMgYW4gb2JqZWN0IGFyZ3VtZW50CgkJLy8gd2l0aCB0aGUgZm9sbG93aW5nIHNoYXBlOiB7IHRoZW1lOiAnJywgdGV4dDogJycsIGh0bWw6ICcnLCB0ZXh0VmlzaWJsZTogJycgfQoJCS8vIE5PVEUgdGhhdCB0aGUgJC5tb2JpbGUubG9hZGluZyogc2V0dGluZ3MgYW5kIHBhcmFtcyBwYXN0IHRoZSBmaXJzdCBhcmUgZGVwcmVjYXRlZAoJCS8vIFRPRE8gc3dlZXQgamVzdXMgd2UgbmVlZCB0byBicmVhayBzb21lIG9mIHRoaXMgb3V0CgkJc2hvdzogZnVuY3Rpb24oIHRoZW1lLCBtc2dUZXh0LCB0ZXh0b25seSApIHsKCQkJdmFyIHRleHRWaXNpYmxlLCBtZXNzYWdlLCBsb2FkU2V0dGluZ3M7CgoJCQl0aGlzLnJlc2V0SHRtbCgpOwoKCQkJLy8gdXNlIHRoZSBwcm90b3R5cGUgb3B0aW9ucyBzbyB0aGF0IHBlb3BsZSBjYW4gc2V0IHRoZW0gZ2xvYmFsbHkgYXQKCQkJLy8gbW9iaWxlIGluaXQuIENvbnNpc3RlbmN5LCBpdCdzIHdoYXQncyBmb3IgZGlubmVyCgkJCWlmICggJC50eXBlKHRoZW1lKSA9PT0gIm9iamVjdCIgKSB7CgkJCQlsb2FkU2V0dGluZ3MgPSAkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucywgdGhlbWUgKTsKCgkJCQkvLyBwcmVmZXIgb2JqZWN0IHByb3BlcnR5IGZyb20gdGhlIHBhcmFtIHRoZW4gdGhlIG9sZCB0aGVtZSBzZXR0aW5nCgkJCQl0aGVtZSA9IGxvYWRTZXR0aW5ncy50aGVtZSB8fCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRoZW1lOwoJCQl9IGVsc2UgewoJCQkJbG9hZFNldHRpbmdzID0gdGhpcy5vcHRpb25zOwoKCQkJCS8vIGhlcmUgd2UgcHJlZmVyIHRoZSB0aGVtIHZhbHVlIHBhc3NlZCBhcyBhIHN0cmluZyBhcmd1bWVudCwgdGhlbgoJCQkJLy8gd2UgcHJlZmVyIHRoZSBnbG9iYWwgb3B0aW9uIGJlY2F1c2Ugd2UgY2FuJ3QgdXNlIHVuZGVmaW5lZCBkZWZhdWx0CgkJCQkvLyBwcm90b3R5cGUgb3B0aW9ucywgdGhlbiB0aGUgcHJvdG90eXBlIG9wdGlvbgoJCQkJdGhlbWUgPSB0aGVtZSB8fCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRoZW1lIHx8IGxvYWRTZXR0aW5ncy50aGVtZTsKCQkJfQoKCQkJLy8gc2V0IHRoZSBtZXNzYWdlIHRleHQsIHByZWZlciB0aGUgcGFyYW0sIHRoZW4gdGhlIHNldHRpbmdzIG9iamVjdAoJCQkvLyB0aGVuIGxvYWRpbmcgbWVzc2FnZQoJCQltZXNzYWdlID0gbXNnVGV4dCB8fCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZSB8fCBsb2FkU2V0dGluZ3MudGV4dDsKCgkJCS8vIHByZXBhcmUgdGhlIGRvbQoJCQkkaHRtbC5hZGRDbGFzcyggInVpLWxvYWRpbmciICk7CgoJCQlpZiAoICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlICE9PSBmYWxzZSB8fCBsb2FkU2V0dGluZ3MuaHRtbCApIHsKCQkJCS8vIGJvb2xlYW4gdmFsdWVzIHJlcXVpcmUgYSBiaXQgbW9yZSB3b3JrIDpQLCBzdXBwb3J0cyBvYmplY3QgcHJvcGVydGllcwoJCQkJLy8gYW5kIG9sZCBzZXR0aW5ncwoJCQkJaWYgKCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRleHRWaXNpYmxlICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJdGV4dFZpc2libGUgPSAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRleHRWaXNpYmxlOwoJCQkJfSBlbHNlIHsKCQkJCQl0ZXh0VmlzaWJsZSA9IGxvYWRTZXR0aW5ncy50ZXh0VmlzaWJsZTsKCQkJCX0KCgkJCQkvLyBhZGQgdGhlIHByb3BlciBjc3MgZ2l2ZW4gdGhlIG9wdGlvbnMgKHRoZW1lLCB0ZXh0LCBldGMpCgkJCQkvLyBGb3JjZSB0ZXh0IHZpc2liaWxpdHkgaWYgdGhlIHNlY29uZCBhcmd1bWVudCB3YXMgc3VwcGxpZWQsIG9yCgkJCQkvLyBpZiB0aGUgdGV4dCB3YXMgZXhwbGljaXRseSBzZXQgaW4gdGhlIG9iamVjdCBhcmdzCgkJCQl0aGlzLmVsZW1lbnQuYXR0cigiY2xhc3MiLCBsb2FkZXJDbGFzcyArCgkJCQkJIiB1aS1jb3JuZXItYWxsIHVpLWJvZHktIiArIHRoZW1lICsKCQkJCQkiIHVpLWxvYWRlci0iICsgKCB0ZXh0VmlzaWJsZSB8fCBtc2dUZXh0IHx8IHRoZW1lLnRleHQgPyAidmVyYm9zZSIgOiAiZGVmYXVsdCIgKSArCgkJCQkJKCBsb2FkU2V0dGluZ3MudGV4dG9ubHkgfHwgdGV4dG9ubHkgPyAiIHVpLWxvYWRlci10ZXh0b25seSIgOiAiIiApICk7CgoJCQkJLy8gVE9ETyB2ZXJpZnkgdGhhdCBqcXVlcnkuZm4uaHRtbCBpcyBvayB0byB1c2UgaW4gYm90aCBjYXNlcyBoZXJlCgkJCQkvLyAgICAgIHRoaXMgbWlnaHQgYmUgb3Zlcmx5IGRlZmVuc2l2ZSBpbiBwcmV2ZW50aW5nIHVua25vd2luZyB4c3MKCQkJCS8vIGlmIHRoZSBodG1sIGF0dHJpYnV0ZSBpcyBkZWZpbmVkIG9uIHRoZSBsb2FkaW5nIHNldHRpbmdzLCB1c2UgdGhhdAoJCQkJLy8gb3RoZXJ3aXNlIHVzZSB0aGUgZmFsbGJhY2tzIGZyb20gYWJvdmUKCQkJCWlmICggbG9hZFNldHRpbmdzLmh0bWwgKSB7CgkJCQkJdGhpcy5lbGVtZW50Lmh0bWwoIGxvYWRTZXR0aW5ncy5odG1sICk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiaDEiICkudGV4dCggbWVzc2FnZSApOwoJCQkJfQoKCQkJCS8vIGF0dGFjaCB0aGUgbG9hZGVyIHRvIHRoZSBET00KCQkJCXRoaXMuZWxlbWVudC5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJCS8vIGNoZWNrIHRoYXQgdGhlIGxvYWRlciBpcyB2aXNpYmxlCgkJCQl0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24oKTsKCgkJCQkvLyBvbiBzY3JvbGwgY2hlY2sgdGhlIGxvYWRlciBwb3NpdGlvbgoJCQkJJHdpbmRvdy5iaW5kKCAic2Nyb2xsIiwgJC5wcm94eSggdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uLCB0aGlzICkgKTsKCQkJfQoJCX0sCgoJCWhpZGU6IGZ1bmN0aW9uKCkgewoJCQkkaHRtbC5yZW1vdmVDbGFzcyggInVpLWxvYWRpbmciICk7CgoJCQlpZiAoICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlICkgewoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktbG9hZGVyLWZha2VmaXgiICk7CgkJCX0KCgkJCSQubW9iaWxlLndpbmRvdy51bmJpbmQoICJzY3JvbGwiLCB0aGlzLmZha2VGaXhMb2FkZXIgKTsKCQkJJC5tb2JpbGUud2luZG93LnVuYmluZCggInNjcm9sbCIsIHRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbiApOwoJCX0KCX0pOwoKCSR3aW5kb3cuYmluZCggInBhZ2Vjb250YWluZXJjcmVhdGUiLCBmdW5jdGlvbigpIHsKCQkkLm1vYmlsZS5sb2FkZXJXaWRnZXQgPSAkLm1vYmlsZS5sb2FkZXJXaWRnZXQgfHwgJCggJC5tb2JpbGUubG9hZGVyLnByb3RvdHlwZS5kZWZhdWx0SHRtbCApLmxvYWRlcigpOwoJfSk7Cn0pKGpRdWVyeSwgdGhpcyk7CgoKLy8gU2NyaXB0OiBqUXVlcnkgaGFzaGNoYW5nZSBldmVudAovLyAKLy8gKlZlcnNpb246IDEuMywgTGFzdCB1cGRhdGVkOiA3LzIxLzIwMTAqCi8vIAovLyBQcm9qZWN0IEhvbWUgLSBodHRwOi8vYmVuYWxtYW4uY29tL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlLXBsdWdpbi8KLy8gR2l0SHViICAgICAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlLwovLyBTb3VyY2UgICAgICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5qcwovLyAoTWluaWZpZWQpICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5taW4uanMgKDAuOGtiIGd6aXBwZWQpCi8vIAovLyBBYm91dDogTGljZW5zZQovLyAKLy8gQ29weXJpZ2h0IChjKSAyMDEwICJDb3dib3kiIEJlbiBBbG1hbiwKLy8gRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXMuCi8vIGh0dHA6Ly9iZW5hbG1hbi5jb20vYWJvdXQvbGljZW5zZS8KLy8gCi8vIEFib3V0OiBFeGFtcGxlcwovLyAKLy8gVGhlc2Ugd29ya2luZyBleGFtcGxlcywgY29tcGxldGUgd2l0aCBmdWxseSBjb21tZW50ZWQgY29kZSwgaWxsdXN0cmF0ZSBhIGZldwovLyB3YXlzIGluIHdoaWNoIHRoaXMgcGx1Z2luIGNhbiBiZSB1c2VkLgovLyAKLy8gaGFzaGNoYW5nZSBldmVudCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9oYXNoY2hhbmdlLwovLyBkb2N1bWVudC5kb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvZG9jdW1lbnRfZG9tYWluLwovLyAKLy8gQWJvdXQ6IFN1cHBvcnQgYW5kIFRlc3RpbmcKLy8gCi8vIEluZm9ybWF0aW9uIGFib3V0IHdoYXQgdmVyc2lvbiBvciB2ZXJzaW9ucyBvZiBqUXVlcnkgdGhpcyBwbHVnaW4gaGFzIGJlZW4KLy8gdGVzdGVkIHdpdGgsIHdoYXQgYnJvd3NlcnMgaXQgaGFzIGJlZW4gdGVzdGVkIGluLCBhbmQgd2hlcmUgdGhlIHVuaXQgdGVzdHMKLy8gcmVzaWRlIChzbyB5b3UgY2FuIHRlc3QgaXQgeW91cnNlbGYpLgovLyAKLy8galF1ZXJ5IFZlcnNpb25zIC0gMS4yLjYsIDEuMy4yLCAxLjQuMSwgMS40LjIKLy8gQnJvd3NlcnMgVGVzdGVkIC0gSW50ZXJuZXQgRXhwbG9yZXIgNi04LCBGaXJlZm94IDItNCwgQ2hyb21lIDUtNiwgU2FmYXJpIDMuMi01LAovLyAgICAgICAgICAgICAgICAgICBPcGVyYSA5LjYtMTAuNjAsIGlQaG9uZSAzLjEsIEFuZHJvaWQgMS42LTIuMiwgQmxhY2tCZXJyeSA0LjYtNS4KLy8gVW5pdCBUZXN0cyAgICAgIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL3VuaXQvCi8vIAovLyBBYm91dDogS25vd24gaXNzdWVzCi8vIAovLyBXaGlsZSB0aGlzIGpRdWVyeSBoYXNoY2hhbmdlIGV2ZW50IGltcGxlbWVudGF0aW9uIGlzIHF1aXRlIHN0YWJsZSBhbmQKLy8gcm9idXN0LCB0aGVyZSBhcmUgYSBmZXcgdW5mb3J0dW5hdGUgYnJvd3NlciBidWdzIHN1cnJvdW5kaW5nIGV4cGVjdGVkCi8vIGhhc2hjaGFuZ2UgZXZlbnQtYmFzZWQgYmVoYXZpb3JzLCBpbmRlcGVuZGVudCBvZiBhbnkgSmF2YVNjcmlwdAovLyB3aW5kb3cub25oYXNoY2hhbmdlIGFic3RyYWN0aW9uLiBTZWUgdGhlIGZvbGxvd2luZyBleGFtcGxlcyBmb3IgbW9yZQovLyBpbmZvcm1hdGlvbjoKLy8gCi8vIENocm9tZTogQmFjayBCdXR0b24gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLWNocm9tZS1iYWNrLWJ1dHRvbi8KLy8gRmlyZWZveDogUmVtb3RlIFhNTEh0dHBSZXF1ZXN0IC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1maXJlZm94LXJlbW90ZS14aHIvCi8vIFdlYktpdDogQmFjayBCdXR0b24gaW4gYW4gSWZyYW1lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy13ZWJraXQtaGFzaC1pZnJhbWUvCi8vIFNhZmFyaTogQmFjayBCdXR0b24gZnJvbSBhIGRpZmZlcmVudCBkb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLXNhZmFyaS1iYWNrLWZyb20tZGlmZi1kb21haW4vCi8vIAovLyBBbHNvIG5vdGUgdGhhdCBzaG91bGQgYSBicm93c2VyIG5hdGl2ZWx5IHN1cHBvcnQgdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UgCi8vIGV2ZW50LCBidXQgbm90IHJlcG9ydCB0aGF0IGl0IGRvZXMsIHRoZSBmYWxsYmFjayBwb2xsaW5nIGxvb3Agd2lsbCBiZSB1c2VkLgovLyAKLy8gQWJvdXQ6IFJlbGVhc2UgSGlzdG9yeQovLyAKLy8gMS4zICAgLSAoNy8yMS8yMDEwKSBSZW9yZ2FuaXplZCBJRTYvNyBJZnJhbWUgY29kZSB0byBtYWtlIGl0IG1vcmUKLy8gICAgICAgICAicmVtb3ZhYmxlIiBmb3IgbW9iaWxlLW9ubHkgZGV2ZWxvcG1lbnQuIEFkZGVkIElFNi83IGRvY3VtZW50LnRpdGxlCi8vICAgICAgICAgc3VwcG9ydC4gQXR0ZW1wdGVkIHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZSBieSB1c2luZwovLyAgICAgICAgIHRlY2huaXF1ZXMgZnJvbSBodHRwOi8vd3d3LnBhY2llbGxvZ3JvdXAuY29tL2Jsb2cvP3A9NjA0LiBBZGRlZCAKLy8gICAgICAgICBzdXBwb3J0IGZvciB0aGUgInNob3J0Y3V0IiBmb3JtYXQgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoIGZuICkgYW5kCi8vICAgICAgICAgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBsaWtlIGpRdWVyeSBwcm92aWRlcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgovLyAgICAgICAgIFJlbmFtZWQgalF1ZXJ5Lmhhc2hjaGFuZ2VEZWxheSB0byA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IGFuZAovLyAgICAgICAgIGxvd2VyZWQgaXRzIGRlZmF1bHQgdmFsdWUgdG8gNTAuIEFkZGVkIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+Ci8vICAgICAgICAgYW5kIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmM+IHByb3BlcnRpZXMgcGx1cyBkb2N1bWVudC1kb21haW4uaHRtbAovLyAgICAgICAgIGZpbGUgdG8gYWRkcmVzcyBhY2Nlc3MgZGVuaWVkIGlzc3VlcyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGluCi8vICAgICAgICAgSUU2LzcuCi8vIDEuMiAgIC0gKDIvMTEvMjAxMCkgRml4ZWQgYSBidWcgd2hlcmUgY29taW5nIGJhY2sgdG8gYSBwYWdlIHVzaW5nIHRoaXMgcGx1Z2luCi8vICAgICAgICAgZnJvbSBhIHBhZ2Ugb24gYW5vdGhlciBkb21haW4gd291bGQgY2F1c2UgYW4gZXJyb3IgaW4gU2FmYXJpIDQuIEFsc28sCi8vICAgICAgICAgSUU2LzcgSWZyYW1lIGlzIG5vdyBpbnNlcnRlZCBhZnRlciB0aGUgYm9keSAodGhpcyBhY3R1YWxseSB3b3JrcyksCi8vICAgICAgICAgd2hpY2ggcHJldmVudHMgdGhlIHBhZ2UgZnJvbSBzY3JvbGxpbmcgd2hlbiB0aGUgZXZlbnQgaXMgZmlyc3QgYm91bmQuCi8vICAgICAgICAgRXZlbnQgY2FuIGFsc28gbm93IGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBpdCB3b24ndCBiZSB1c2FibGUKLy8gICAgICAgICBiZWZvcmUgdGhlbiBpbiBJRTYvNy4KLy8gMS4xICAgLSAoMS8yMS8yMDEwKSBJbmNvcnBvcmF0ZWQgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHRlc3QgdG8gZml4IElFOCBidWcKLy8gICAgICAgICB3aGVyZSBicm93c2VyIHZlcnNpb24gaXMgaW5jb3JyZWN0bHkgcmVwb3J0ZWQgYXMgOC4wLCBkZXNwaXRlCi8vICAgICAgICAgaW5jbHVzaW9uIG9mIHRoZSBYLVVBLUNvbXBhdGlibGUgSUU9RW11bGF0ZUlFNyBtZXRhIHRhZy4KLy8gMS4wICAgLSAoMS85LzIwMTApIEluaXRpYWwgUmVsZWFzZS4gQnJva2Ugb3V0IHRoZSBqUXVlcnkgQkJRIGV2ZW50LnNwZWNpYWwKLy8gICAgICAgICB3aW5kb3cub25oYXNoY2hhbmdlIGZ1bmN0aW9uYWxpdHkgaW50byBhIHNlcGFyYXRlIHBsdWdpbiBmb3IgdXNlcnMKLy8gICAgICAgICB3aG8gd2FudCBqdXN0IHRoZSBiYXNpYyBldmVudCAmIGJhY2sgYnV0dG9uIHN1cHBvcnQsIHdpdGhvdXQgYWxsIHRoZQovLyAgICAgICAgIGV4dHJhIGF3ZXNvbWVuZXNzIHRoYXQgQkJRIHByb3ZpZGVzLiBUaGlzIHBsdWdpbiB3aWxsIGJlIGluY2x1ZGVkIGFzCi8vICAgICAgICAgcGFydCBvZiBqUXVlcnkgQkJRLCBidXQgYWxzbyBiZSBhdmFpbGFibGUgc2VwYXJhdGVseS4KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CiAgLy8gUmV1c2VkIHN0cmluZy4KICB2YXIgc3RyX2hhc2hjaGFuZ2UgPSAnaGFzaGNoYW5nZScsCiAgICAKICAgIC8vIE1ldGhvZCAvIG9iamVjdCByZWZlcmVuY2VzLgogICAgZG9jID0gZG9jdW1lbnQsCiAgICBmYWtlX29uaGFzaGNoYW5nZSwKICAgIHNwZWNpYWwgPSAkLmV2ZW50LnNwZWNpYWwsCiAgICAKICAgIC8vIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCB3aW5kb3cub25oYXNoY2hhbmdlPyBOb3RlIHRoYXQgSUU4IHJ1bm5pbmcgaW4KICAgIC8vIElFNyBjb21wYXRpYmlsaXR5IG1vZGUgcmVwb3J0cyB0cnVlIGZvciAnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3csIGV2ZW4KICAgIC8vIHRob3VnaCB0aGUgZXZlbnQgaXNuJ3Qgc3VwcG9ydGVkLCBzbyBhbHNvIHRlc3QgZG9jdW1lbnQuZG9jdW1lbnRNb2RlLgogICAgZG9jX21vZGUgPSBkb2MuZG9jdW1lbnRNb2RlLAogICAgc3VwcG9ydHNfb25oYXNoY2hhbmdlID0gJ29uJyArIHN0cl9oYXNoY2hhbmdlIGluIHdpbmRvdyAmJiAoIGRvY19tb2RlID09PSB1bmRlZmluZWQgfHwgZG9jX21vZGUgPiA3ICk7CiAgCiAgLy8gR2V0IGxvY2F0aW9uLmhhc2ggKG9yIHdoYXQgeW91J2QgZXhwZWN0IGxvY2F0aW9uLmhhc2ggdG8gYmUpIHNhbnMgYW55CiAgLy8gbGVhZGluZyAjLiBUaGFua3MgZm9yIG1ha2luZyB0aGlzIG5lY2Vzc2FyeSwgRmlyZWZveCEKICBmdW5jdGlvbiBnZXRfZnJhZ21lbnQoIHVybCApIHsKICAgIHVybCA9IHVybCB8fCBsb2NhdGlvbi5ocmVmOwogICAgcmV0dXJuICcjJyArIHVybC5yZXBsYWNlKCAvXlteI10qIz8oLiopJC8sICckMScgKTsKICB9OwogIAogIC8vIE1ldGhvZDogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UKICAvLyAKICAvLyBCaW5kIGEgaGFuZGxlciB0byB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBvciB0cmlnZ2VyIGFsbCBib3VuZAogIC8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMuIFRoaXMgYmVoYXZpb3IgaXMgY29uc2lzdGVudCB3aXRoCiAgLy8galF1ZXJ5J3MgYnVpbHQtaW4gZXZlbnQgaGFuZGxlcnMuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCBbIGhhbmRsZXIgXSApOwogIC8vIAogIC8vIEFyZ3VtZW50czoKICAvLyAKICAvLyAgaGFuZGxlciAtIChGdW5jdGlvbikgT3B0aW9uYWwgaGFuZGxlciB0byBiZSBib3VuZCB0byB0aGUgaGFzaGNoYW5nZQogIC8vICAgIGV2ZW50LiBUaGlzIGlzIGEgInNob3J0Y3V0IiBmb3IgdGhlIG1vcmUgdmVyYm9zZSBmb3JtOgogIC8vICAgIGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgaGFuZGxlciApLiBJZiBoYW5kbGVyIGlzIG9taXR0ZWQsCiAgLy8gICAgYWxsIGJvdW5kIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMgd2lsbCBiZSB0cmlnZ2VyZWQuIFRoaXMKICAvLyAgICBpcyBhIHNob3J0Y3V0IGZvciB0aGUgbW9yZSB2ZXJib3NlCiAgLy8gICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuIFRoZXNlIGZvcm1zIGFyZSBkZXNjcmliZWQgaW4KICAvLyAgICB0aGUgPGhhc2hjaGFuZ2UgZXZlbnQ+IHNlY3Rpb24uCiAgLy8gCiAgLy8gUmV0dXJuczoKICAvLyAKICAvLyAgKGpRdWVyeSkgVGhlIGluaXRpYWwgalF1ZXJ5IGNvbGxlY3Rpb24gb2YgZWxlbWVudHMuCiAgCiAgLy8gQWxsb3cgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQoZWxlbSkuaGFzaGNoYW5nZSggZm4gKSBmb3IgYmluZGluZyBhbmQKICAvLyAkKGVsZW0pLmhhc2hjaGFuZ2UoKSBmb3IgdHJpZ2dlcmluZywgbGlrZSBqUXVlcnkgZG9lcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0gPSBmdW5jdGlvbiggZm4gKSB7CiAgICByZXR1cm4gZm4gPyB0aGlzLmJpbmQoIHN0cl9oYXNoY2hhbmdlLCBmbiApIDogdGhpcy50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogIH07CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5CiAgLy8gCiAgLy8gVGhlIG51bWVyaWMgaW50ZXJ2YWwgKGluIG1pbGxpc2Vjb25kcykgYXQgd2hpY2ggdGhlIDxoYXNoY2hhbmdlIGV2ZW50PgogIC8vIHBvbGxpbmcgbG9vcCBleGVjdXRlcy4gRGVmYXVsdHMgdG8gNTAuCiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbgogIC8vIAogIC8vIElmIHlvdSdyZSBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbiB5b3VyIEphdmFTY3JpcHQsIGFuZCB5b3Ugd2FudCBoYXNoCiAgLy8gaGlzdG9yeSB0byB3b3JrIGluIElFNi83LCBub3Qgb25seSBtdXN0IHRoaXMgcHJvcGVydHkgYmUgc2V0LCBidXQgeW91IG11c3QKICAvLyBhbHNvIHNldCBkb2N1bWVudC5kb21haW4gQkVGT1JFIGpRdWVyeSBpcyBsb2FkZWQgaW50byB0aGUgcGFnZS4gVGhpcwogIC8vIHByb3BlcnR5IGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcKICAvLyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vIAogIC8vIEluIGFkZGl0aW9uLCB0aGUgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydHkgbXVzdCBiZSBzZXQgdG8gdGhlCiAgLy8gcGF0aCBvZiB0aGUgaW5jbHVkZWQgImRvY3VtZW50LWRvbWFpbi5odG1sIiBmaWxlLCB3aGljaCBjYW4gYmUgcmVuYW1lZCBvcgogIC8vIG1vZGlmaWVkIGlmIG5lY2Vzc2FyeSAobm90ZSB0aGF0IHRoZSBkb2N1bWVudC5kb21haW4gc3BlY2lmaWVkIG11c3QgYmUgdGhlCiAgLy8gc2FtZSBpbiBib3RoIHlvdXIgbWFpbiBKYXZhU2NyaXB0IGFzIHdlbGwgYXMgaW4gdGhpcyBmaWxlKS4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4gPSBkb2N1bWVudC5kb21haW47CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYwogIC8vIAogIC8vIElmLCBmb3Igc29tZSByZWFzb24sIHlvdSBuZWVkIHRvIHNwZWNpZnkgYW4gSWZyYW1lIHNyYyBmaWxlIChmb3IgZXhhbXBsZSwKICAvLyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGFzIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+KSwgeW91IGNhbgogIC8vIGRvIHNvIHVzaW5nIHRoaXMgcHJvcGVydHkuIE5vdGUgdGhhdCB3aGVuIHVzaW5nIHRoaXMgcHJvcGVydHksIGhpc3RvcnkKICAvLyB3b24ndCBiZSByZWNvcmRlZCBpbiBJRTYvNyB1bnRpbCB0aGUgSWZyYW1lIHNyYyBmaWxlIGxvYWRzLiBUaGlzIHByb3BlcnR5CiAgLy8gaXMgb25seSBhcHBsaWNhYmxlIGlmIHlvdSBhcmUgc3VwcG9ydGluZyBJRTYvNyAob3IgSUU4IG9wZXJhdGluZyBpbiAiSUU3CiAgLy8gY29tcGF0aWJpbGl0eSIgbW9kZSkuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjID0gJ3BhdGgvdG8vZmlsZS5odG1sJzsKICAKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ID0gNTA7CiAgLyoKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbiA9IG51bGw7CiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmMgPSBudWxsOwogICovCiAgCiAgLy8gRXZlbnQ6IGhhc2hjaGFuZ2UgZXZlbnQKICAvLyAKICAvLyBGaXJlZCB3aGVuIGxvY2F0aW9uLmhhc2ggY2hhbmdlcy4gSW4gYnJvd3NlcnMgdGhhdCBzdXBwb3J0IGl0LCB0aGUgbmF0aXZlCiAgLy8gSFRNTDUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBpcyB1c2VkLCBvdGhlcndpc2UgYSBwb2xsaW5nIGxvb3AgaXMKICAvLyBpbml0aWFsaXplZCwgcnVubmluZyBldmVyeSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IG1pbGxpc2Vjb25kcyB0bwogIC8vIHNlZSBpZiB0aGUgaGFzaCBoYXMgY2hhbmdlZC4gSW4gSUU2LzcgKGFuZCBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKSwgYSBoaWRkZW4gSWZyYW1lIGlzIGNyZWF0ZWQgdG8gYWxsb3cgdGhlIGJhY2sgYnV0dG9uCiAgLy8gYW5kIGhhc2gtYmFzZWQgaGlzdG9yeSB0byB3b3JrLgogIC8vIAogIC8vIFVzYWdlIGFzIGRlc2NyaWJlZCBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2U+OgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPiAKICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCk7CiAgLy8gCiAgLy8gQSBtb3JlIHZlcmJvc2UgdXNhZ2UgdGhhdCBhbGxvd3MgZm9yIGV2ZW50IG5hbWVzcGFjaW5nOgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBmdW5jdGlvbihlKSB7CiAgLy8gPiAgIHZhciBoYXNoID0gbG9jYXRpb24uaGFzaDsKICAvLyA+ICAgLi4uCiAgLy8gPiB9KTsKICAvLyA+IAogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApOwogIC8vIAogIC8vIEFkZGl0aW9uYWwgTm90ZXM6CiAgLy8gCiAgLy8gKiBUaGUgcG9sbGluZyBsb29wIGFuZCBJZnJhbWUgYXJlIG5vdCBjcmVhdGVkIHVudGlsIGF0IGxlYXN0IG9uZSBoYW5kbGVyCiAgLy8gICBpcyBhY3R1YWxseSBib3VuZCB0byB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50LgogIC8vICogSWYgeW91IG5lZWQgdGhlIGJvdW5kIGhhbmRsZXIocykgdG8gZXhlY3V0ZSBpbW1lZGlhdGVseSwgaW4gY2FzZXMgd2hlcmUKICAvLyAgIGEgbG9jYXRpb24uaGFzaCBleGlzdHMgb24gcGFnZSBsb2FkLCB2aWEgYm9va21hcmsgb3IgcGFnZSByZWZyZXNoIGZvcgogIC8vICAgZXhhbXBsZSwgdXNlIGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBvciB0aGUgbW9yZSB2ZXJib3NlIAogIC8vICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuCiAgLy8gKiBUaGUgZXZlbnQgY2FuIGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBzaW5jZSBpdCB3b24ndCBiZSB1c2FibGUKICAvLyAgIGJlZm9yZSB0aGVuIGluIElFNi83IChkdWUgdG8gdGhlIG5lY2Vzc2FyeSBJZnJhbWUpLCByZWNvbW1lbmRlZCB1c2FnZSBpcwogIC8vICAgdG8gYmluZCBpdCBpbnNpZGUgYSBET00gcmVhZHkgaGFuZGxlci4KICAKICAvLyBPdmVycmlkZSBleGlzdGluZyAkLmV2ZW50LnNwZWNpYWwuaGFzaGNoYW5nZSBtZXRob2RzIChhbGxvd2luZyB0aGlzIHBsdWdpbgogIC8vIHRvIGJlIGRlZmluZWQgYWZ0ZXIgalF1ZXJ5IEJCUSBpbiBCQlEncyBzb3VyY2UgY29kZSkuCiAgc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSA9ICQuZXh0ZW5kKCBzcGVjaWFsWyBzdHJfaGFzaGNoYW5nZSBdLCB7CiAgICAKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGZpcnN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyBib3VuZCB0byB3aW5kb3cuCiAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIAogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gY3JlYXRlIG91ciBvd24uIEFuZCB3ZSBkb24ndCB3YW50IHRvIGNhbGwgdGhpcwogICAgICAvLyB1bnRpbCB0aGUgdXNlciBiaW5kcyB0byB0aGUgZXZlbnQsIGp1c3QgaW4gY2FzZSB0aGV5IG5ldmVyIGRvLCBzaW5jZSBpdAogICAgICAvLyB3aWxsIGNyZWF0ZSBhIHBvbGxpbmcgbG9vcCBhbmQgcG9zc2libHkgZXZlbiBhIGhpZGRlbiBJZnJhbWUuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0YXJ0ICk7CiAgICB9LAogICAgCiAgICAvLyBDYWxsZWQgb25seSB3aGVuIHRoZSBsYXN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyB1bmJvdW5kIGZyb20gd2luZG93LgogICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICAvLyBJZiB3aW5kb3cub25oYXNoY2hhbmdlIGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgdGhlcmUncyBub3RoaW5nIHRvIGRvLi4KICAgICAgaWYgKCBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIHN0b3Agb3VycyAoaWYgcG9zc2libGUpLgogICAgICAkKCBmYWtlX29uaGFzaGNoYW5nZS5zdG9wICk7CiAgICB9CiAgICAKICB9KTsKICAKICAvLyBmYWtlX29uaGFzaGNoYW5nZSBkb2VzIGFsbCB0aGUgd29yayBvZiB0cmlnZ2VyaW5nIHRoZSB3aW5kb3cub25oYXNoY2hhbmdlCiAgLy8gZXZlbnQgZm9yIGJyb3dzZXJzIHRoYXQgZG9uJ3QgbmF0aXZlbHkgc3VwcG9ydCBpdCwgaW5jbHVkaW5nIGNyZWF0aW5nIGEKICAvLyBwb2xsaW5nIGxvb3AgdG8gd2F0Y2ggZm9yIGhhc2ggY2hhbmdlcyBhbmQgaW4gSUUgNi83IGNyZWF0aW5nIGEgaGlkZGVuCiAgLy8gSWZyYW1lIHRvIGVuYWJsZSBiYWNrIGFuZCBmb3J3YXJkLgogIGZha2Vfb25oYXNoY2hhbmdlID0gKGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB7fSwKICAgICAgdGltZW91dF9pZCwKICAgICAgCiAgICAgIC8vIFJlbWVtYmVyIHRoZSBpbml0aWFsIGhhc2ggc28gaXQgZG9lc24ndCBnZXQgdHJpZ2dlcmVkIGltbWVkaWF0ZWx5LgogICAgICBsYXN0X2hhc2ggPSBnZXRfZnJhZ21lbnQoKSwKICAgICAgCiAgICAgIGZuX3JldHZhbCA9IGZ1bmN0aW9uKCB2YWwgKSB7IHJldHVybiB2YWw7IH0sCiAgICAgIGhpc3Rvcnlfc2V0ID0gZm5fcmV0dmFsLAogICAgICBoaXN0b3J5X2dldCA9IGZuX3JldHZhbDsKICAgIAogICAgLy8gU3RhcnQgdGhlIHBvbGxpbmcgbG9vcC4KICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCB8fCBwb2xsKCk7CiAgICB9OwogICAgCiAgICAvLyBTdG9wIHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCAmJiBjbGVhclRpbWVvdXQoIHRpbWVvdXRfaWQgKTsKICAgICAgdGltZW91dF9pZCA9IHVuZGVmaW5lZDsKICAgIH07CiAgICAKICAgIC8vIFRoaXMgcG9sbGluZyBsb29wIGNoZWNrcyBldmVyeSAkLmZuLmhhc2hjaGFuZ2UuZGVsYXkgbWlsbGlzZWNvbmRzIHRvIHNlZQogICAgLy8gaWYgbG9jYXRpb24uaGFzaCBoYXMgY2hhbmdlZCwgYW5kIHRyaWdnZXJzIHRoZSAnaGFzaGNoYW5nZScgZXZlbnQgb24KICAgIC8vIHdpbmRvdyB3aGVuIG5lY2Vzc2FyeS4KICAgIGZ1bmN0aW9uIHBvbGwoKSB7CiAgICAgIHZhciBoYXNoID0gZ2V0X2ZyYWdtZW50KCksCiAgICAgICAgaGlzdG9yeV9oYXNoID0gaGlzdG9yeV9nZXQoIGxhc3RfaGFzaCApOwogICAgICAKICAgICAgaWYgKCBoYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgaGlzdG9yeV9zZXQoIGxhc3RfaGFzaCA9IGhhc2gsIGhpc3RvcnlfaGFzaCApOwogICAgICAgIAogICAgICAgICQod2luZG93KS50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogICAgICAgIAogICAgICB9IGVsc2UgaWYgKCBoaXN0b3J5X2hhc2ggIT09IGxhc3RfaGFzaCApIHsKICAgICAgICBsb2NhdGlvbi5ocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKCAvIy4qLywgJycgKSArIGhpc3RvcnlfaGFzaDsKICAgICAgfQogICAgICAKICAgICAgdGltZW91dF9pZCA9IHNldFRpbWVvdXQoIHBvbGwsICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZGVsYXkgKTsKICAgIH07CiAgICAKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2diBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIHdpbmRvdy5hdHRhY2hFdmVudCAmJiAhd2luZG93LmFkZEV2ZW50TGlzdGVuZXIgJiYgIXN1cHBvcnRzX29uaGFzaGNoYW5nZSAmJiAoZnVuY3Rpb24oKSB7CiAgICAgIC8vIE5vdCBvbmx5IGRvIElFNi83IG5lZWQgdGhlICJtYWdpY2FsIiBJZnJhbWUgdHJlYXRtZW50LCBidXQgc28gZG9lcyBJRTgKICAgICAgLy8gd2hlbiBydW5uaW5nIGluICJJRTcgY29tcGF0aWJpbGl0eSIgbW9kZS4KICAgICAgCiAgICAgIHZhciBpZnJhbWUsCiAgICAgICAgaWZyYW1lX3NyYzsKICAgICAgCiAgICAgIC8vIFdoZW4gdGhlIGV2ZW50IGlzIGJvdW5kIGFuZCBwb2xsaW5nIHN0YXJ0cyBpbiBJRSA2LzcsIGNyZWF0ZSBhIGhpZGRlbgogICAgICAvLyBJZnJhbWUgZm9yIGhpc3RvcnkgaGFuZGxpbmcuCiAgICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoICFpZnJhbWUgKSB7CiAgICAgICAgICBpZnJhbWVfc3JjID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmM7CiAgICAgICAgICBpZnJhbWVfc3JjID0gaWZyYW1lX3NyYyAmJiBpZnJhbWVfc3JjICsgZ2V0X2ZyYWdtZW50KCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIENyZWF0ZSBoaWRkZW4gSWZyYW1lLiBBdHRlbXB0IHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZQogICAgICAgICAgLy8gYnkgdXNpbmcgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuCiAgICAgICAgICBpZnJhbWUgPSAkKCc8aWZyYW1lIHRhYmluZGV4PSItMSIgdGl0bGU9ImVtcHR5Ii8+JykuaGlkZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBXaGVuIElmcmFtZSBoYXMgY29tcGxldGVseSBsb2FkZWQsIGluaXRpYWxpemUgdGhlIGhpc3RvcnkgYW5kCiAgICAgICAgICAgIC8vIHN0YXJ0IHBvbGxpbmcuCiAgICAgICAgICAgIC5vbmUoICdsb2FkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWZyYW1lX3NyYyB8fCBoaXN0b3J5X3NldCggZ2V0X2ZyYWdtZW50KCkgKTsKICAgICAgICAgICAgICBwb2xsKCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBMb2FkIElmcmFtZSBzcmMgaWYgc3BlY2lmaWVkLCBvdGhlcndpc2Ugbm90aGluZy4KICAgICAgICAgICAgLmF0dHIoICdzcmMnLCBpZnJhbWVfc3JjIHx8ICdqYXZhc2NyaXB0OjAnICkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGVuZCBJZnJhbWUgYWZ0ZXIgdGhlIGVuZCBvZiB0aGUgYm9keSB0byBwcmV2ZW50IHVubmVjZXNzYXJ5CiAgICAgICAgICAgIC8vIGluaXRpYWwgcGFnZSBzY3JvbGxpbmcgKHllcywgdGhpcyB3b3JrcykuCiAgICAgICAgICAgIC5pbnNlcnRBZnRlciggJ2JvZHknIClbMF0uY29udGVudFdpbmRvdzsKICAgICAgICAgIAogICAgICAgICAgLy8gV2hlbmV2ZXIgYGRvY3VtZW50LnRpdGxlYCBjaGFuZ2VzLCB1cGRhdGUgdGhlIElmcmFtZSdzIHRpdGxlIHRvCiAgICAgICAgICAvLyBwcmV0dGlmeSB0aGUgYmFjay9uZXh0IGhpc3RvcnkgbWVudSBlbnRyaWVzLiBTaW5jZSBJRSBzb21ldGltZXMKICAgICAgICAgIC8vIGVycm9ycyB3aXRoICJVbnNwZWNpZmllZCBlcnJvciIgdGhlIHZlcnkgZmlyc3QgdGltZSB0aGlzIGlzIHNldAogICAgICAgICAgLy8gKHllcywgdmVyeSB1c2VmdWwpIHdyYXAgdGhpcyB3aXRoIGEgdHJ5L2NhdGNoIGJsb2NrLgogICAgICAgICAgZG9jLm9ucHJvcGVydHljaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpZiAoIGV2ZW50LnByb3BlcnR5TmFtZSA9PT0gJ3RpdGxlJyApIHsKICAgICAgICAgICAgICAgIGlmcmFtZS5kb2N1bWVudC50aXRsZSA9IGRvYy50aXRsZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2goZSkge30KICAgICAgICAgIH07CiAgICAgICAgICAKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgICAvLyBPdmVycmlkZSB0aGUgInN0b3AiIG1ldGhvZCBzaW5jZSBhbiBJRTYvNyBJZnJhbWUgd2FzIGNyZWF0ZWQuIEV2ZW4KICAgICAgLy8gaWYgdGhlcmUgYXJlIG5vIGxvbmdlciBhbnkgYm91bmQgZXZlbnQgaGFuZGxlcnMsIHRoZSBwb2xsaW5nIGxvb3AKICAgICAgLy8gaXMgc3RpbGwgbmVjZXNzYXJ5IGZvciBiYWNrL25leHQgdG8gd29yayBhdCBhbGwhCiAgICAgIHNlbGYuc3RvcCA9IGZuX3JldHZhbDsKICAgICAgCiAgICAgIC8vIEdldCBoaXN0b3J5IGJ5IGxvb2tpbmcgYXQgdGhlIGhpZGRlbiBJZnJhbWUncyBsb2NhdGlvbi5oYXNoLgogICAgICBoaXN0b3J5X2dldCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBnZXRfZnJhZ21lbnQoIGlmcmFtZS5sb2NhdGlvbi5ocmVmICk7CiAgICAgIH07CiAgICAgIAogICAgICAvLyBTZXQgYSBuZXcgaGlzdG9yeSBpdGVtIGJ5IG9wZW5pbmcgYW5kIHRoZW4gY2xvc2luZyB0aGUgSWZyYW1lCiAgICAgIC8vIGRvY3VtZW50LCAqdGhlbiogc2V0dGluZyBpdHMgbG9jYXRpb24uaGFzaC4gSWYgZG9jdW1lbnQuZG9tYWluIGhhcwogICAgICAvLyBiZWVuIHNldCwgdXBkYXRlIHRoYXQgYXMgd2VsbC4KICAgICAgaGlzdG9yeV9zZXQgPSBmdW5jdGlvbiggaGFzaCwgaGlzdG9yeV9oYXNoICkgewogICAgICAgIHZhciBpZnJhbWVfZG9jID0gaWZyYW1lLmRvY3VtZW50LAogICAgICAgICAgZG9tYWluID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kb21haW47CiAgICAgICAgCiAgICAgICAgaWYgKCBoYXNoICE9PSBoaXN0b3J5X2hhc2ggKSB7CiAgICAgICAgICAvLyBVcGRhdGUgSWZyYW1lIHdpdGggYW55IGluaXRpYWwgYGRvY3VtZW50LnRpdGxlYCB0aGF0IG1pZ2h0IGJlIHNldC4KICAgICAgICAgIGlmcmFtZV9kb2MudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAKICAgICAgICAgIC8vIE9wZW5pbmcgdGhlIElmcmFtZSdzIGRvY3VtZW50IGFmdGVyIGl0IGhhcyBiZWVuIGNsb3NlZCBpcyB3aGF0CiAgICAgICAgICAvLyBhY3R1YWxseSBhZGRzIGEgaGlzdG9yeSBlbnRyeS4KICAgICAgICAgIGlmcmFtZV9kb2Mub3BlbigpOwogICAgICAgICAgCiAgICAgICAgICAvLyBTZXQgZG9jdW1lbnQuZG9tYWluIGZvciB0aGUgSWZyYW1lIGRvY3VtZW50IGFzIHdlbGwsIGlmIG5lY2Vzc2FyeS4KICAgICAgICAgIGRvbWFpbiAmJiBpZnJhbWVfZG9jLndyaXRlKCAnPHNjcmlwdD5kb2N1bWVudC5kb21haW49IicgKyBkb21haW4gKyAnIjwvc2NyaXB0PicgKTsKICAgICAgICAgIAogICAgICAgICAgaWZyYW1lX2RvYy5jbG9zZSgpOwogICAgICAgICAgCiAgICAgICAgICAvLyBVcGRhdGUgdGhlIElmcmFtZSdzIGhhc2gsIGZvciBncmVhdCBqdXN0aWNlLgogICAgICAgICAgaWZyYW1lLmxvY2F0aW9uLmhhc2ggPSBoYXNoOwogICAgICAgIH0KICAgICAgfTsKICAgICAgCiAgICB9KSgpOwogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eIFJFTU9WRSBJRiBOT1QgU1VQUE9SVElORyBJRTYvNy84IF5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgCiAgICByZXR1cm4gc2VsZjsKICB9KSgpOwogIAp9KShqUXVlcnksdGhpcyk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkvKiEgbWF0Y2hNZWRpYSgpIHBvbHlmaWxsIC0gVGVzdCBhIENTUyBtZWRpYSB0eXBlL3F1ZXJ5IGluIEpTLiBBdXRob3JzICYgY29weXJpZ2h0IChjKSAyMDEyOiBTY290dCBKZWhsLCBQYXVsIElyaXNoLCBOaWNob2xhcyBaYWthcy4gRHVhbCBNSVQvQlNEIGxpY2Vuc2UgKi8KCXdpbmRvdy5tYXRjaE1lZGlhID0gd2luZG93Lm1hdGNoTWVkaWEgfHwgKGZ1bmN0aW9uKCBkb2MsIHVuZGVmaW5lZCApIHsKCgkJCgoJCXZhciBib29sLAoJCQlkb2NFbGVtID0gZG9jLmRvY3VtZW50RWxlbWVudCwKCQkJcmVmTm9kZSA9IGRvY0VsZW0uZmlyc3RFbGVtZW50Q2hpbGQgfHwgZG9jRWxlbS5maXJzdENoaWxkLAoJCQkvLyBmYWtlQm9keSByZXF1aXJlZCBmb3IgPEZGNCB3aGVuIGV4ZWN1dGVkIGluIDxoZWFkPgoJCQlmYWtlQm9keSA9IGRvYy5jcmVhdGVFbGVtZW50KCAiYm9keSIgKSwKCQkJZGl2ID0gZG9jLmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgoJCWRpdi5pZCA9ICJtcS10ZXN0LTEiOwoJCWRpdi5zdHlsZS5jc3NUZXh0ID0gInBvc2l0aW9uOmFic29sdXRlO3RvcDotMTAwZW0iOwoJCWZha2VCb2R5LnN0eWxlLmJhY2tncm91bmQgPSAibm9uZSI7CgkJZmFrZUJvZHkuYXBwZW5kQ2hpbGQoZGl2KTsKCgkJcmV0dXJuIGZ1bmN0aW9uKHEpewoKCQkJZGl2LmlubmVySFRNTCA9ICImc2h5OzxzdHlsZSBtZWRpYT1cIiIgKyBxICsgIlwiPiAjbXEtdGVzdC0xIHsgd2lkdGg6IDQycHg7IH08L3N0eWxlPiI7CgoJCQlkb2NFbGVtLmluc2VydEJlZm9yZSggZmFrZUJvZHksIHJlZk5vZGUgKTsKCQkJYm9vbCA9IGRpdi5vZmZzZXRXaWR0aCA9PT0gNDI7CgkJCWRvY0VsZW0ucmVtb3ZlQ2hpbGQoIGZha2VCb2R5ICk7CgoJCQlyZXR1cm4gewoJCQkJbWF0Y2hlczogYm9vbCwKCQkJCW1lZGlhOiBxCgkJCX07CgoJCX07CgoJfSggZG9jdW1lbnQgKSk7CgoJLy8gJC5tb2JpbGUubWVkaWEgdXNlcyBtYXRjaE1lZGlhIHRvIHJldHVybiBhIGJvb2xlYW4uCgkkLm1vYmlsZS5tZWRpYSA9IGZ1bmN0aW9uKCBxICkgewoJCXJldHVybiB3aW5kb3cubWF0Y2hNZWRpYSggcSApLm1hdGNoZXM7Cgl9OwoKfSkoalF1ZXJ5KTsKCgkoZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQl2YXIgc3VwcG9ydCA9IHsKCQkJdG91Y2g6ICJvbnRvdWNoZW5kIiBpbiBkb2N1bWVudAoJCX07CgoJCSQubW9iaWxlLnN1cHBvcnQgPSAkLm1vYmlsZS5zdXBwb3J0IHx8IHt9OwoJCSQuZXh0ZW5kKCAkLnN1cHBvcnQsIHN1cHBvcnQgKTsKCQkkLmV4dGVuZCggJC5tb2JpbGUuc3VwcG9ydCwgc3VwcG9ydCApOwoJfSggalF1ZXJ5ICkpOwoKCShmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJCSQuZXh0ZW5kKCAkLnN1cHBvcnQsIHsKCQkJb3JpZW50YXRpb246ICJvcmllbnRhdGlvbiIgaW4gd2luZG93ICYmICJvbm9yaWVudGF0aW9uY2hhbmdlIiBpbiB3aW5kb3cKCQl9KTsKCX0oIGpRdWVyeSApKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gdGh4IE1vZGVybml6cgpmdW5jdGlvbiBwcm9wRXhpc3RzKCBwcm9wICkgewoJdmFyIHVjX3Byb3AgPSBwcm9wLmNoYXJBdCggMCApLnRvVXBwZXJDYXNlKCkgKyBwcm9wLnN1YnN0ciggMSApLAoJCXByb3BzID0gKCBwcm9wICsgIiAiICsgdmVuZG9ycy5qb2luKCB1Y19wcm9wICsgIiAiICkgKyB1Y19wcm9wICkuc3BsaXQoICIgIiApLAoJCXY7CgoJZm9yICggdiBpbiBwcm9wcyApIHsKCQlpZiAoIGZiQ1NTWyBwcm9wc1sgdiBdIF0gIT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQp9Cgp2YXIgZmFrZUJvZHkgPSAkKCAiPGJvZHk+IiApLnByZXBlbmRUbyggImh0bWwiICksCglmYkNTUyA9IGZha2VCb2R5WyAwIF0uc3R5bGUsCgl2ZW5kb3JzID0gWyAiV2Via2l0IiwgIk1veiIsICJPIiBdLAoJd2Vib3MgPSAicGFsbUdldFJlc291cmNlIiBpbiB3aW5kb3csIC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IHNjcm9sbFRvcAoJb3BlcmEgPSB3aW5kb3cub3BlcmEsCglvcGVyYW1pbmkgPSB3aW5kb3cub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggd2luZG93Lm9wZXJhbWluaSApID09PSAiW29iamVjdCBPcGVyYU1pbmldIiwKCWJiID0gd2luZG93LmJsYWNrYmVycnkgJiYgIXByb3BFeGlzdHMoICItd2Via2l0LXRyYW5zZm9ybSIgKSwgLy9vbmx5IHVzZWQgdG8gcnVsZSBvdXQgYm94IHNoYWRvdywgYXMgaXQncyBmaWxsZWQgb3BhcXVlIG9uIEJCIDUgYW5kIGxvd2VyCglub2tpYUxURTdfMzsKCgpmdW5jdGlvbiB2YWxpZFN0eWxlKCBwcm9wLCB2YWx1ZSwgY2hlY2tfdmVuZCApIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCXVjID0gZnVuY3Rpb24oIHR4dCApIHsKCQkJcmV0dXJuIHR4dC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgdHh0LnN1YnN0ciggMSApOwoJCX0sCgkJdmVuZF9wcmVmID0gZnVuY3Rpb24oIHZlbmQgKSB7CgkJCWlmICggdmVuZCA9PT0gIiIgKSB7CgkJCQlyZXR1cm4gIiI7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gICItIiArIHZlbmQuY2hhckF0KCAwICkudG9Mb3dlckNhc2UoKSArIHZlbmQuc3Vic3RyKCAxICkgKyAiLSI7CgkJCX0KCQl9LAoJCWNoZWNrX3N0eWxlID0gZnVuY3Rpb24oIHZlbmQgKSB7CgkJCXZhciB2ZW5kX3Byb3AgPSB2ZW5kX3ByZWYoIHZlbmQgKSArIHByb3AgKyAiOiAiICsgdmFsdWUgKyAiOyIsCgkJCQl1Y192ZW5kID0gdWMoIHZlbmQgKSwKCQkJCXByb3BTdHlsZSA9IHVjX3ZlbmQgKyAoIHVjX3ZlbmQgPT09ICIiID8gcHJvcCA6IHVjKCBwcm9wICkgKTsKCgkJCWRpdi5zZXRBdHRyaWJ1dGUoICJzdHlsZSIsIHZlbmRfcHJvcCApOwoKCQkJaWYgKCAhIWRpdi5zdHlsZVsgcHJvcFN0eWxlIF0gKSB7CgkJCQlyZXQgPSB0cnVlOwoJCQl9CgkJfSwKCQljaGVja192ZW5kcyA9IGNoZWNrX3ZlbmQgPyBjaGVja192ZW5kIDogdmVuZG9ycywKCQlpLCByZXQ7CgoJZm9yKCBpID0gMDsgaSA8IGNoZWNrX3ZlbmRzLmxlbmd0aDsgaSsrICkgewoJCWNoZWNrX3N0eWxlKCBjaGVja192ZW5kc1tpXSApOwoJfQoJcmV0dXJuICEhcmV0Owp9CgovLyBpbmxpbmUgU1ZHIHN1cHBvcnQgdGVzdApmdW5jdGlvbiBpbmxpbmVTVkcoKSB7CgkvLyBUaGFua3MgTW9kZXJuaXpyICYgRXJpayBEYWhsc3Ryb20KCXZhciB3ID0gd2luZG93LAoJCXN2ZyA9ICEhdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50TlMgJiYgISF3LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyggImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiwgInN2ZyIgKS5jcmVhdGVTVkdSZWN0ICYmICEoIHcub3BlcmEgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQ2hyb21lIiApID09PSAtMSApLAoJCXN1cHBvcnQgPSBmdW5jdGlvbiggZGF0YSApIHsKCQkJaWYgKCAhKCBkYXRhICYmIHN2ZyApICkgewoJCQkJJCggImh0bWwiICkuYWRkQ2xhc3MoICJ1aS1ub3N2ZyIgKTsKCQkJfQoJCX0sCgkJaW1nID0gbmV3IHcuSW1hZ2UoKTsKCglpbWcub25lcnJvciA9IGZ1bmN0aW9uKCkgewoJCXN1cHBvcnQoIGZhbHNlICk7Cgl9OwoJaW1nLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewoJCXN1cHBvcnQoIGltZy53aWR0aCA9PT0gMSAmJiBpbWcuaGVpZ2h0ID09PSAxICk7Cgl9OwoJaW1nLnNyYyA9ICJkYXRhOmltYWdlL2dpZjtiYXNlNjQsUjBsR09EbGhBUUFCQUlBQUFBQUFBUC8vL3l3QUFBQUFBUUFCQUFBQ0FVd0FPdz09IjsKfQoKZnVuY3Rpb24gdHJhbnNmb3JtM2RUZXN0KCkgewoJdmFyIG1xUHJvcCA9ICJ0cmFuc2Zvcm0tM2QiLAoJCS8vIEJlY2F1c2UgdGhlIGB0cmFuc2xhdGUzZGAgdGVzdCBiZWxvdyB0aHJvd3MgZmFsc2UgcG9zaXRpdmVzIGluIEFuZHJvaWQ6CgkJcmV0ID0gJC5tb2JpbGUubWVkaWEoICIoLSIgKyB2ZW5kb3JzLmpvaW4oICItIiArIG1xUHJvcCArICIpLCgtIiApICsgIi0iICsgbXFQcm9wICsgIiksKCIgKyBtcVByb3AgKyAiKSIgKSwKCQllbCwgdHJhbnNmb3JtcywgdDsKCglpZiAoIHJldCApIHsKCQlyZXR1cm4gISFyZXQ7Cgl9CgoJZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJdHJhbnNmb3JtcyA9IHsKCQkvLyBXZeKAmXJlIG9taXR0aW5nIE9wZXJhIGZvciB0aGUgdGltZSBiZWluZzsgTVMgdXNlcyB1bnByZWZpeGVkLgoJCSJNb3pUcmFuc2Zvcm0iOiAiLW1vei10cmFuc2Zvcm0iLAoJCSJ0cmFuc2Zvcm0iOiAidHJhbnNmb3JtIgoJfTsKCglmYWtlQm9keS5hcHBlbmQoIGVsICk7CgoJZm9yICggdCBpbiB0cmFuc2Zvcm1zICkgewoJCWlmICggZWwuc3R5bGVbIHQgXSAhPT0gdW5kZWZpbmVkICl7CgkJCWVsLnN0eWxlWyB0IF0gPSAidHJhbnNsYXRlM2QoIDEwMHB4LCAxcHgsIDFweCApIjsKCQkJcmV0ID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoIGVsICkuZ2V0UHJvcGVydHlWYWx1ZSggdHJhbnNmb3Jtc1sgdCBdICk7CgkJfQoJfQoJcmV0dXJuICggISFyZXQgJiYgcmV0ICE9PSAibm9uZSIgKTsKfQoKLy8gVGVzdCBmb3IgZHluYW1pYy11cGRhdGluZyBiYXNlIHRhZyBzdXBwb3J0ICggYWxsb3dzIHVzIHRvIGF2b2lkIGhyZWYsc3JjIGF0dHIgcmV3cml0aW5nICkKZnVuY3Rpb24gYmFzZVRhZ1Rlc3QoKSB7Cgl2YXIgZmF1eEJhc2UgPSBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKyBsb2NhdGlvbi5ob3N0ICsgbG9jYXRpb24ucGF0aG5hbWUgKyAidWktZGlyLyIsCgkJYmFzZSA9ICQoICJoZWFkIGJhc2UiICksCgkJZmF1eEVsZSA9IG51bGwsCgkJaHJlZiA9ICIiLAoJCWxpbmssIHJlYmFzZTsKCglpZiAoICFiYXNlLmxlbmd0aCApIHsKCQliYXNlID0gZmF1eEVsZSA9ICQoICI8YmFzZT4iLCB7ICJocmVmIjogZmF1eEJhc2UgfSkuYXBwZW5kVG8oICJoZWFkIiApOwoJfSBlbHNlIHsKCQlocmVmID0gYmFzZS5hdHRyKCAiaHJlZiIgKTsKCX0KCglsaW5rID0gJCggIjxhIGhyZWY9J3Rlc3R1cmwnIC8+IiApLnByZXBlbmRUbyggZmFrZUJvZHkgKTsKCXJlYmFzZSA9IGxpbmtbIDAgXS5ocmVmOwoJYmFzZVsgMCBdLmhyZWYgPSBocmVmIHx8IGxvY2F0aW9uLnBhdGhuYW1lOwoKCWlmICggZmF1eEVsZSApIHsKCQlmYXV4RWxlLnJlbW92ZSgpOwoJfQoJcmV0dXJuIHJlYmFzZS5pbmRleE9mKCBmYXV4QmFzZSApID09PSAwOwp9CgovLyBUaGFua3MgTW9kZXJuaXpyCmZ1bmN0aW9uIGNzc1BvaW50ZXJFdmVudHNUZXN0KCkgewoJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAieCIgKSwKCQlkb2N1bWVudEVsZW1lbnQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsCgkJZ2V0Q29tcHV0ZWRTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlLAoJCXN1cHBvcnRzOwoKCWlmICggISggInBvaW50ZXJFdmVudHMiIGluIGVsZW1lbnQuc3R5bGUgKSApIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJZWxlbWVudC5zdHlsZS5wb2ludGVyRXZlbnRzID0gImF1dG8iOwoJZWxlbWVudC5zdHlsZS5wb2ludGVyRXZlbnRzID0gIngiOwoJZG9jdW1lbnRFbGVtZW50LmFwcGVuZENoaWxkKCBlbGVtZW50ICk7CglzdXBwb3J0cyA9IGdldENvbXB1dGVkU3R5bGUgJiYKCWdldENvbXB1dGVkU3R5bGUoIGVsZW1lbnQsICIiICkucG9pbnRlckV2ZW50cyA9PT0gImF1dG8iOwoJZG9jdW1lbnRFbGVtZW50LnJlbW92ZUNoaWxkKCBlbGVtZW50ICk7CglyZXR1cm4gISFzdXBwb3J0czsKfQoKZnVuY3Rpb24gYm91bmRpbmdSZWN0KCkgewoJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CglyZXR1cm4gdHlwZW9mIGRpdi5nZXRCb3VuZGluZ0NsaWVudFJlY3QgIT09ICJ1bmRlZmluZWQiOwp9CgovLyBub24tVUEtYmFzZWQgSUUgdmVyc2lvbiBjaGVjayBieSBKYW1lcyBQYWRvbHNleSwgbW9kaWZpZWQgYnkgamRhbHRvbiAtIGZyb20gaHR0cDovL2dpc3QuZ2l0aHViLmNvbS81Mjc2ODMKLy8gYWxsb3dzIGZvciBpbmNsdXNpb24gb2YgSUUgNissIGluY2x1ZGluZyBXaW5kb3dzIE1vYmlsZSA3CiQuZXh0ZW5kKCAkLm1vYmlsZSwgeyBicm93c2VyOiB7fSB9ICk7CiQubW9iaWxlLmJyb3dzZXIub2xkSUUgPSAoZnVuY3Rpb24oKSB7Cgl2YXIgdiA9IDMsCgkJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCQlhID0gZGl2LmFsbCB8fCBbXTsKCglkbyB7CgkJZGl2LmlubmVySFRNTCA9ICI8IS0tW2lmIGd0IElFICIgKyAoICsrdiApICsgIl0+PGJyPjwhW2VuZGlmXS0tPiI7Cgl9IHdoaWxlKCBhWzBdICk7CgoJcmV0dXJuIHYgPiA0ID8gdiA6ICF2Owp9KSgpOwoKZnVuY3Rpb24gZml4ZWRQb3NpdGlvbigpIHsKCXZhciB3ID0gd2luZG93LAoJCXVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQlwbGF0Zm9ybSA9IG5hdmlnYXRvci5wbGF0Zm9ybSwKCQkvLyBSZW5kZXJpbmcgZW5naW5lIGlzIFdlYmtpdCwgYW5kIGNhcHR1cmUgbWFqb3IgdmVyc2lvbgoJCXdrbWF0Y2ggPSB1YS5tYXRjaCggL0FwcGxlV2ViS2l0XC8oWzAtOV0rKS8gKSwKCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCWZmbWF0Y2ggPSB1YS5tYXRjaCggL0Zlbm5lY1wvKFswLTldKykvICksCgkJZmZ2ZXJzaW9uID0gISFmZm1hdGNoICYmIGZmbWF0Y2hbIDEgXSwKCQlvcGVyYW1tb2JpbGVtYXRjaCA9IHVhLm1hdGNoKCAvT3BlcmEgTW9iaVwvKFswLTldKykvICksCgkJb212ZXJzaW9uID0gISFvcGVyYW1tb2JpbGVtYXRjaCAmJiBvcGVyYW1tb2JpbGVtYXRjaFsgMSBdOwoKCWlmICgKCQkvLyBpT1MgNC4zIGFuZCBvbGRlciA6IFBsYXRmb3JtIGlzIGlQaG9uZS9QYWQvVG91Y2ggYW5kIFdlYmtpdCB2ZXJzaW9uIGlzIGxlc3MgdGhhbiA1MzQgKGlvczUpCgkJKCAoIHBsYXRmb3JtLmluZGV4T2YoICJpUGhvbmUiICkgPiAtMSB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBhZCIgKSA+IC0xICB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBvZCIgKSA+IC0xICkgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzNCApIHx8CgkJLy8gT3BlcmEgTWluaQoJCSggdy5vcGVyYW1pbmkgJiYgKHt9KS50b1N0cmluZy5jYWxsKCB3Lm9wZXJhbWluaSApID09PSAiW29iamVjdCBPcGVyYU1pbmldIiApIHx8CgkJKCBvcGVyYW1tb2JpbGVtYXRjaCAmJiBvbXZlcnNpb24gPCA3NDU4ICkJfHwKCQkvL0FuZHJvaWQgbHRlIDIuMTogUGxhdGZvcm0gaXMgQW5kcm9pZCBhbmQgV2Via2l0IHZlcnNpb24gaXMgbGVzcyB0aGFuIDUzMyAoQW5kcm9pZCAyLjIpCgkJKCB1YS5pbmRleE9mKCAiQW5kcm9pZCIgKSA+IC0xICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzMgKSB8fAoJCS8vIEZpcmVmb3ggTW9iaWxlIGJlZm9yZSA2LjAgLQoJCSggZmZ2ZXJzaW9uICYmIGZmdmVyc2lvbiA8IDYgKSB8fAoJCS8vIFdlYk9TIGxlc3MgdGhhbiAzCgkJKCAicGFsbUdldFJlc291cmNlIiBpbiB3aW5kb3cgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzNCApCXx8CgkJLy8gTWVlR28KCQkoIHVhLmluZGV4T2YoICJNZWVHbyIgKSA+IC0xICYmIHVhLmluZGV4T2YoICJOb2tpYUJyb3dzZXIvOC41LjAiICkgPiAtMSApICkgewoJCXJldHVybiBmYWxzZTsKCX0KCglyZXR1cm4gdHJ1ZTsKfQoKJC5leHRlbmQoICQuc3VwcG9ydCwgewoJY3NzVHJhbnNpdGlvbnM6ICJXZWJLaXRUcmFuc2l0aW9uRXZlbnQiIGluIHdpbmRvdyB8fAoJCXZhbGlkU3R5bGUoICJ0cmFuc2l0aW9uIiwgImhlaWdodCAxMDBtcyBsaW5lYXIiLCBbICJXZWJraXQiLCAiTW96IiwgIiIgXSApICYmCgkJISQubW9iaWxlLmJyb3dzZXIub2xkSUUgJiYgIW9wZXJhLAoKCS8vIE5vdGUsIENocm9tZSBmb3IgaU9TIGhhcyBhbiBleHRyZW1lbHkgcXVpcmt5IGltcGxlbWVudGF0aW9uIG9mIHBvcHN0YXRlLgoJLy8gV2UndmUgY2hvc2VuIHRvIHRha2UgdGhlIHNob3J0ZXN0IHBhdGggdG8gYSBidWcgZml4IGhlcmUgZm9yIGlzc3VlICM1NDI2CgkvLyBTZWUgdGhlIGZvbGxvd2luZyBsaW5rIGZvciBpbmZvcm1hdGlvbiBhYm91dCB0aGUgcmVnZXggY2hvc2VuCgkvLyBodHRwczovL2RldmVsb3BlcnMuZ29vZ2xlLmNvbS9jaHJvbWUvbW9iaWxlL2RvY3MvdXNlci1hZ2VudCNjaHJvbWVfZm9yX2lvc191c2VyLWFnZW50CglwdXNoU3RhdGU6ICJwdXNoU3RhdGUiIGluIGhpc3RvcnkgJiYKCQkicmVwbGFjZVN0YXRlIiBpbiBoaXN0b3J5ICYmCgkJLy8gV2hlbiBydW5uaW5nIGluc2lkZSBhIEZGIGlmcmFtZSwgY2FsbGluZyByZXBsYWNlU3RhdGUgY2F1c2VzIGFuIGVycm9yCgkJISggd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkZpcmVmb3giICkgPj0gMCAmJiB3aW5kb3cudG9wICE9PSB3aW5kb3cgKSAmJgoJCSggd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQuc2VhcmNoKC9DcmlPUy8pID09PSAtMSApLAoKCW1lZGlhcXVlcnk6ICQubW9iaWxlLm1lZGlhKCAib25seSBhbGwiICksCgljc3NQc2V1ZG9FbGVtZW50OiAhIXByb3BFeGlzdHMoICJjb250ZW50IiApLAoJdG91Y2hPdmVyZmxvdzogISFwcm9wRXhpc3RzKCAib3ZlcmZsb3dTY3JvbGxpbmciICksCgljc3NUcmFuc2Zvcm0zZDogdHJhbnNmb3JtM2RUZXN0KCksCglib3hTaGFkb3c6ICEhcHJvcEV4aXN0cyggImJveFNoYWRvdyIgKSAmJiAhYmIsCglmaXhlZFBvc2l0aW9uOiBmaXhlZFBvc2l0aW9uKCksCglzY3JvbGxUb3A6ICgicGFnZVhPZmZzZXQiIGluIHdpbmRvdyB8fAoJCSJzY3JvbGxUb3AiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCB8fAoJCSJzY3JvbGxUb3AiIGluIGZha2VCb2R5WyAwIF0pICYmICF3ZWJvcyAmJiAhb3BlcmFtaW5pLAoKCWR5bmFtaWNCYXNlVGFnOiBiYXNlVGFnVGVzdCgpLAoJY3NzUG9pbnRlckV2ZW50czogY3NzUG9pbnRlckV2ZW50c1Rlc3QoKSwKCWJvdW5kaW5nUmVjdDogYm91bmRpbmdSZWN0KCksCglpbmxpbmVTVkc6IGlubGluZVNWRwp9KTsKCmZha2VCb2R5LnJlbW92ZSgpOwoKCi8vICQubW9iaWxlLmFqYXhCbGFja2xpc3QgaXMgdXNlZCB0byBvdmVycmlkZSBhamF4RW5hYmxlZCBvbiBwbGF0Zm9ybXMgdGhhdCBoYXZlIGtub3duIGNvbmZsaWN0cyB3aXRoIGhhc2ggaGlzdG9yeSB1cGRhdGVzIChCQjUsIFN5bWJpYW4pCi8vIG9yIHRoYXQgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoT3BlcmEgTWluaSkKLy8gTm90ZTogVGhpcyBkZXRlY3Rpb24gYmVsb3cgaXMgdXNlZCBhcyBhIGxhc3QgcmVzb3J0LgovLyBXZSByZWNvbW1lbmQgb25seSB1c2luZyB0aGVzZSBkZXRlY3Rpb24gbWV0aG9kcyB3aGVuIGFsbCBvdGhlciBtb3JlIHJlbGlhYmxlL2ZvcndhcmQtbG9va2luZyBhcHByb2FjaGVzIGFyZSBub3QgcG9zc2libGUKbm9raWFMVEU3XzMgPSAoZnVuY3Rpb24oKSB7CgoJdmFyIHVhID0gd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQ7CgoJLy9UaGUgZm9sbG93aW5nIGlzIGFuIGF0dGVtcHQgdG8gbWF0Y2ggTm9raWEgYnJvd3NlcnMgdGhhdCBhcmUgcnVubmluZyBTeW1iaWFuL3M2MCwgd2l0aCB3ZWJraXQsIHZlcnNpb24gNy4zIG9yIG9sZGVyCglyZXR1cm4gdWEuaW5kZXhPZiggIk5va2lhIiApID4gLTEgJiYKCQkJKCB1YS5pbmRleE9mKCAiU3ltYmlhbi8zIiApID4gLTEgfHwgdWEuaW5kZXhPZiggIlNlcmllczYwLzUiICkgPiAtMSApICYmCgkJCXVhLmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xICYmCgkJCXVhLm1hdGNoKCAvKEJyb3dzZXJOR3xOb2tpYUJyb3dzZXIpXC83XC5bMC0zXS8gKTsKfSkoKTsKCi8vIFN1cHBvcnQgY29uZGl0aW9ucyB0aGF0IG11c3QgYmUgbWV0IGluIG9yZGVyIHRvIHByb2NlZWQKLy8gZGVmYXVsdCBlbmhhbmNlZCBxdWFsaWZpY2F0aW9ucyBhcmUgbWVkaWEgcXVlcnkgc3VwcG9ydCBPUiBJRSA3KwoKJC5tb2JpbGUuZ3JhZGVBID0gZnVuY3Rpb24oKSB7CglyZXR1cm4gKCAoICQuc3VwcG9ydC5tZWRpYXF1ZXJ5ICYmICQuc3VwcG9ydC5jc3NQc2V1ZG9FbGVtZW50ICkgfHwgJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSAmJiAkLm1vYmlsZS5icm93c2VyLm9sZElFID49IDggKSAmJiAoICQuc3VwcG9ydC5ib3VuZGluZ1JlY3QgfHwgJC5mbi5qcXVlcnkubWF0Y2goLzFcLlswLTcrXVwuWzAtOStdPy8pICE9PSBudWxsICk7Cn07CgokLm1vYmlsZS5hamF4QmxhY2tsaXN0ID0KCQkJLy8gQmxhY2tCZXJyeSBicm93c2VycywgcHJlLXdlYmtpdAoJCQl3aW5kb3cuYmxhY2tiZXJyeSAmJiAhd2luZG93LldlYktpdFBvaW50IHx8CgkJCS8vIE9wZXJhIE1pbmkKCQkJb3BlcmFtaW5pIHx8CgkJCS8vIFN5bWJpYW4gd2Via2l0cyBwcmUgNy4zCgkJCW5va2lhTFRFN18zOwoKLy8gTGFzdGx5LCB0aGlzIHdvcmthcm91bmQgaXMgdGhlIG9ubHkgd2F5IHdlJ3ZlIGZvdW5kIHNvIGZhciB0byBnZXQgcHJlIDcuMyBTeW1iaWFuIHdlYmtpdCBkZXZpY2VzCi8vIHRvIHJlbmRlciB0aGUgc3R5bGVzaGVldHMgd2hlbiB0aGV5J3JlIHJlZmVyZW5jZWQgYmVmb3JlIHRoaXMgc2NyaXB0LCBhcyB3ZSdkIHJlY29tbWVuZCBkb2luZy4KLy8gVGhpcyBzaW1wbHkgcmVhcHBlbmRzIHRoZSBDU1MgaW4gcGxhY2UsIHdoaWNoIGZvciBzb21lIHJlYXNvbiBtYWtlcyBpdCBhcHBseQppZiAoIG5va2lhTFRFN18zICkgewoJJChmdW5jdGlvbigpIHsKCQkkKCAiaGVhZCBsaW5rW3JlbD0nc3R5bGVzaGVldCddIiApLmF0dHIoICJyZWwiLCAiYWx0ZXJuYXRlIHN0eWxlc2hlZXQiICkuYXR0ciggInJlbCIsICJzdHlsZXNoZWV0IiApOwoJfSk7Cn0KCi8vIEZvciBydWxpbmcgb3V0IHNoYWRvd3MgdmlhIGNzcwppZiAoICEkLnN1cHBvcnQuYm94U2hhZG93ICkgewoJJCggImh0bWwiICkuYWRkQ2xhc3MoICJ1aS1ub2JveHNoYWRvdyIgKTsKfQoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyICR3aW4gPSAkLm1vYmlsZS53aW5kb3csIHNlbGYsCgkJZHVtbXlGblRvSW5pdE5hdmlnYXRlID0gZnVuY3Rpb24oKSB7CgkJfTsKCgkkLmV2ZW50LnNwZWNpYWwuYmVmb3JlbmF2aWdhdGUgPSB7CgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkkd2luLm9uKCAibmF2aWdhdGUiLCBkdW1teUZuVG9Jbml0TmF2aWdhdGUgKTsKCQl9LAoKCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCSR3aW4ub2ZmKCAibmF2aWdhdGUiLCBkdW1teUZuVG9Jbml0TmF2aWdhdGUgKTsKCQl9Cgl9OwoKCSQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZSA9IHNlbGYgPSB7CgkJYm91bmQ6IGZhbHNlLAoKCQlwdXNoU3RhdGVFbmFibGVkOiB0cnVlLAoKCQlvcmlnaW5hbEV2ZW50TmFtZTogdW5kZWZpbmVkLAoKCQkvLyBJZiBwdXNoc3RhdGUgc3VwcG9ydCBpcyBwcmVzZW50IGFuZCBwdXNoIHN0YXRlIHN1cHBvcnQgaXMgZGVmaW5lZCB0bwoJCS8vIGJlIHRydWUgb24gdGhlIG1vYmlsZSBuYW1lc3BhY2UuCgkJaXNQdXNoU3RhdGVFbmFibGVkOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQuc3VwcG9ydC5wdXNoU3RhdGUgJiYKCQkJCSQubW9iaWxlLnB1c2hTdGF0ZUVuYWJsZWQgPT09IHRydWUgJiYKCQkJCXRoaXMuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpOwoJCX0sCgoJCS8vICEhIGFzc3VtZXMgbW9iaWxlIG5hbWVzcGFjZSBpcyBwcmVzZW50CgkJaXNIYXNoQ2hhbmdlRW5hYmxlZDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCA9PT0gdHJ1ZTsKCQl9LAoKCQkvLyBUT0RPIGEgbG90IG9mIGR1cGxpY2F0aW9uIGJldHdlZW4gcG9wc3RhdGUgYW5kIGhhc2hjaGFuZ2UKCQlwb3BzdGF0ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgbmV3RXZlbnQgPSBuZXcgJC5FdmVudCggIm5hdmlnYXRlIiApLAoJCQkJYmVmb3JlTmF2aWdhdGUgPSBuZXcgJC5FdmVudCggImJlZm9yZW5hdmlnYXRlIiApLAoJCQkJc3RhdGUgPSBldmVudC5vcmlnaW5hbEV2ZW50LnN0YXRlIHx8IHt9OwoKCQkJYmVmb3JlTmF2aWdhdGUub3JpZ2luYWxFdmVudCA9IGV2ZW50OwoJCQkkd2luLnRyaWdnZXIoIGJlZm9yZU5hdmlnYXRlICk7CgoJCQlpZiAoIGJlZm9yZU5hdmlnYXRlLmlzRGVmYXVsdFByZXZlbnRlZCgpICl7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggZXZlbnQuaGlzdG9yeVN0YXRlICl7CgkJCQkkLmV4dGVuZChzdGF0ZSwgZXZlbnQuaGlzdG9yeVN0YXRlKTsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHRoZSBvcmlnaW5hbCBldmVudCBpcyB0cmFja2VkIGZvciB0aGUgZW5kCgkJCS8vIHVzZXIgdG8gaW5zcGVjdCBpbmNhc2UgdGhleSB3YW50IHRvIGRvIHNvbWV0aGluZyBzcGVjaWFsCgkJCW5ld0V2ZW50Lm9yaWdpbmFsRXZlbnQgPSBldmVudDsKCgkJCS8vIE5PVEUgd2UgbGV0IHRoZSBjdXJyZW50IHN0YWNrIHVud2luZCBiZWNhdXNlIGFueSBhc3NpZ25tZW50IHRvCgkJCS8vICAgICAgbG9jYXRpb24uaGFzaCB3aWxsIHN0b3AgdGhlIHdvcmxkIGFuZCBydW4gdGhpcyBldmVudCBoYW5kbGVyLiBCeQoJCQkvLyAgICAgIGRvaW5nIHRoaXMgd2UgY3JlYXRlIGEgc2ltaWxhciBiZWhhdmlvciB0byBoYXNoY2hhbmdlIG9uIGhhc2gKCQkJLy8gICAgICBhc3NpZ25tZW50CgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkkd2luLnRyaWdnZXIoIG5ld0V2ZW50LCB7CgkJCQkJc3RhdGU6IHN0YXRlCgkJCQl9KTsKCQkJfSwgMCk7CgkJfSwKCgkJaGFzaGNoYW5nZTogZnVuY3Rpb24oIGV2ZW50IC8qLCBkYXRhICovICkgewoJCQl2YXIgbmV3RXZlbnQgPSBuZXcgJC5FdmVudCggIm5hdmlnYXRlIiApLAoJCQkJYmVmb3JlTmF2aWdhdGUgPSBuZXcgJC5FdmVudCggImJlZm9yZW5hdmlnYXRlIiApOwoKCQkJYmVmb3JlTmF2aWdhdGUub3JpZ2luYWxFdmVudCA9IGV2ZW50OwoJCQkkd2luLnRyaWdnZXIoIGJlZm9yZU5hdmlnYXRlICk7CgoJCQlpZiAoIGJlZm9yZU5hdmlnYXRlLmlzRGVmYXVsdFByZXZlbnRlZCgpICl7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB0aGUgb3JpZ2luYWwgZXZlbnQgaXMgdHJhY2tlZCBmb3IgdGhlIGVuZAoJCQkvLyB1c2VyIHRvIGluc3BlY3QgaW5jYXNlIHRoZXkgd2FudCB0byBkbyBzb21ldGhpbmcgc3BlY2lhbAoJCQluZXdFdmVudC5vcmlnaW5hbEV2ZW50ID0gZXZlbnQ7CgoJCQkvLyBUcmlnZ2VyIHRoZSBoYXNoY2hhbmdlIHdpdGggc3RhdGUgcHJvdmlkZWQgYnkgdGhlIHVzZXIKCQkJLy8gdGhhdCBhbHRlcmVkIHRoZSBoYXNoCgkJCSR3aW4udHJpZ2dlciggbmV3RXZlbnQsIHsKCQkJCS8vIFVzZXJzIHRoYXQgd2FudCB0byBmdWxseSBub3JtYWxpemUgdGhlIHR3byBldmVudHMKCQkJCS8vIHdpbGwgbmVlZCB0byBkbyBoaXN0b3J5IG1hbmFnZW1lbnQgZG93biB0aGUgc3RhY2sgYW5kCgkJCQkvLyBhZGQgdGhlIHN0YXRlIHRvIHRoZSBldmVudCBiZWZvcmUgdGhpcyBiaW5kaW5nIGlzIGZpcmVkCgkJCQkvLyBUT0RPIGNvbnNpZGVyIGFsbG93aW5nIGZvciB0aGUgZXhwbGljaXQgYWRkaXRpb24gb2YgY2FsbGJhY2tzCgkJCQkvLyAgICAgIHRvIGJlIGZpcmVkIGJlZm9yZSB0aGlzIHZhbHVlIGlzIHNldCB0byBhdm9pZCBldmVudCB0aW1pbmcgaXNzdWVzCgkJCQlzdGF0ZTogZXZlbnQuaGFzaGNoYW5nZVN0YXRlIHx8IHt9CgkJCX0pOwoJCX0sCgoJCS8vIFRPRE8gV2UgcmVhbGx5IG9ubHkgd2FudCB0byBzZXQgdGhpcyB1cCBvbmNlCgkJLy8gICAgICBidXQgSSdtIG5vdCBjbGVhciBpZiB0aGVyZSdzIGEgYmV0ZXIgd2F5IHRvIGFjaGlldmUKCQkvLyAgICAgIHRoaXMgd2l0aCB0aGUgalF1ZXJ5IHNwZWNpYWwgZXZlbnQgc3RydWN0dXJlCgkJc2V0dXA6IGZ1bmN0aW9uKCAvKiBkYXRhLCBuYW1lc3BhY2VzICovICkgewoJCQlpZiAoIHNlbGYuYm91bmQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXNlbGYuYm91bmQgPSB0cnVlOwoKCQkJaWYgKCBzZWxmLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJc2VsZi5vcmlnaW5hbEV2ZW50TmFtZSA9ICJwb3BzdGF0ZSI7CgkJCQkkd2luLmJpbmQoICJwb3BzdGF0ZS5uYXZpZ2F0ZSIsIHNlbGYucG9wc3RhdGUgKTsKCQkJfSBlbHNlIGlmICggc2VsZi5pc0hhc2hDaGFuZ2VFbmFibGVkKCkgKXsKCQkJCXNlbGYub3JpZ2luYWxFdmVudE5hbWUgPSAiaGFzaGNoYW5nZSI7CgkJCQkkd2luLmJpbmQoICJoYXNoY2hhbmdlLm5hdmlnYXRlIiwgc2VsZi5oYXNoY2hhbmdlICk7CgkJCX0KCQl9Cgl9Owp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJCXZhciBwYXRoLCAkYmFzZSwgZGlhbG9nSGFzaEtleSA9ICImdWktc3RhdGU9ZGlhbG9nIjsKCgkJJC5tb2JpbGUucGF0aCA9IHBhdGggPSB7CgkJCXVpU3RhdGVLZXk6ICImdWktc3RhdGUiLAoKCQkJLy8gVGhpcyBzY2FyeSBsb29raW5nIHJlZ3VsYXIgZXhwcmVzc2lvbiBwYXJzZXMgYW4gYWJzb2x1dGUgVVJMIG9yIGl0cyByZWxhdGl2ZQoJCQkvLyB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgYW5kIGhhc2gpLCBpbnRvIHRoZSB2YXJpb3VzCgkJCS8vIGNvbXBvbmVudHMgKHByb3RvY29sLCBob3N0LCBwYXRoLCBxdWVyeSwgZnJhZ21lbnQsIGV0YyB0aGF0IG1ha2UgdXAgdGhlCgkJCS8vIFVSTCBhcyB3ZWxsIGFzIHNvbWUgb3RoZXIgY29tbW9ubHkgdXNlZCBzdWItcGFydHMuIFdoZW4gdXNlZCB3aXRoIFJlZ0V4cC5leGVjKCkKCQkJLy8gb3IgU3RyaW5nLm1hdGNoLCBpdCBwYXJzZXMgdGhlIFVSTCBpbnRvIGEgcmVzdWx0cyBhcnJheSB0aGF0IGxvb2tzIGxpa2UgdGhpczoKCQkJLy8KCQkJLy8gICAgIFswXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkI21zZy1jb250ZW50CgkJCS8vICAgICBbMV06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveD9tc2c9MTIzNCZ0eXBlPXVucmVhZAoJCQkvLyAgICAgWzJdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3gKCQkJLy8gICAgIFszXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzRdOiBodHRwOgoJCQkvLyAgICAgWzVdOiAvLwoJCQkvLyAgICAgWzZdOiBqYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgIFs3XTogamJsYXM6cGFzc3dvcmQKCQkJLy8gICAgIFs4XTogamJsYXMKCQkJLy8gICAgIFs5XTogcGFzc3dvcmQKCQkJLy8gICAgWzEwXTogbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgIFsxMV06IG15Y29tcGFueS5jb20KCQkJLy8gICAgWzEyXTogODA4MAoJCQkvLyAgICBbMTNdOiAvbWFpbC9pbmJveAoJCQkvLyAgICBbMTRdOiAvbWFpbC8KCQkJLy8gICAgWzE1XTogaW5ib3gKCQkJLy8gICAgWzE2XTogP21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgIFsxN106ICNtc2ctY29udGVudAoJCQkvLwoJCQl1cmxQYXJzZVJFOiAvXlxzKigoKChbXjpcLyNcP10rOik/KD86KFwvXC8pKCg/OigoW146QFwvI1w/XSspKD86XDooW146QFwvI1w/XSspKT8pQCk/KChbXjpcLyNcP1xdXFtdK3xcW1teXC9cXUAjP10rXF0pKD86XDooWzAtOV0rKSk/KSk/KT8pPygoXC8/KD86W15cL1w/I10rXC8rKSopKFteXD8jXSopKSk/KFw/W14jXSspPykoIy4qKT8vLAoKCQkJLy8gQWJzdHJhY3Rpb24gdG8gYWRkcmVzcyB4c3MgKElzc3VlICM0Nzg3KSBieSByZW1vdmluZyB0aGUgYXV0aG9yaXR5IGluCgkJCS8vIGJyb3dzZXJzIHRoYXQgYXV0bwlkZWNvZGUgaXQuIEFsbCByZWZlcmVuY2VzIHRvIGxvY2F0aW9uLmhyZWYgc2hvdWxkIGJlCgkJCS8vIHJlcGxhY2VkIHdpdGggYSBjYWxsIHRvIHRoaXMgbWV0aG9kIHNvIHRoYXQgaXQgY2FuIGJlIGRlYWx0IHdpdGggcHJvcGVybHkgaGVyZQoJCQlnZXRMb2NhdGlvbjogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1cmkgPSB1cmwgPyB0aGlzLnBhcnNlVXJsKCB1cmwgKSA6IGxvY2F0aW9uLAoJCQkJCWhhc2ggPSB0aGlzLnBhcnNlVXJsKCB1cmwgfHwgbG9jYXRpb24uaHJlZiApLmhhc2g7CgoJCQkJLy8gbWltaWMgdGhlIGJyb3dzZXIgd2l0aCBhbiBlbXB0eSBzdHJpbmcgd2hlbiB0aGUgaGFzaCBpcyBlbXB0eQoJCQkJaGFzaCA9IGhhc2ggPT09ICIjIiA/ICIiIDogaGFzaDsKCgkJCQkvLyBNYWtlIHN1cmUgdG8gcGFyc2UgdGhlIHVybCBvciB0aGUgbG9jYXRpb24gb2JqZWN0IGZvciB0aGUgaGFzaCBiZWNhdXNlIHVzaW5nIGxvY2F0aW9uLmhhc2gKCQkJCS8vIGlzIGF1dG9kZWNvZGVkIGluIGZpcmVmb3gsIHRoZSByZXN0IG9mIHRoZSB1cmwgc2hvdWxkIGJlIGZyb20gdGhlIG9iamVjdCAobG9jYXRpb24gdW5sZXNzCgkJCQkvLyB3ZSdyZSB0ZXN0aW5nKSB0byBhdm9pZCB0aGUgaW5jbHVzaW9uIG9mIHRoZSBhdXRob3JpdHkKCQkJCXJldHVybiB1cmkucHJvdG9jb2wgKyAiLy8iICsgdXJpLmhvc3QgKyB1cmkucGF0aG5hbWUgKyB1cmkuc2VhcmNoICsgaGFzaDsKCQkJfSwKCgkJCXBhcnNlTG9jYXRpb246IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHRoaXMucGFyc2VVcmwoIHRoaXMuZ2V0TG9jYXRpb24oKSApOwoJCQl9LAoKCQkJLy9QYXJzZSBhIFVSTCBpbnRvIGEgc3RydWN0dXJlIHRoYXQgYWxsb3dzIGVhc3kgYWNjZXNzIHRvCgkJCS8vYWxsIG9mIHRoZSBVUkwgY29tcG9uZW50cyBieSBuYW1lLgoJCQlwYXJzZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIElmIHdlJ3JlIHBhc3NlZCBhbiBvYmplY3QsIHdlJ2xsIGFzc3VtZSB0aGF0IGl0IGlzCgkJCQkvLyBhIHBhcnNlZCB1cmwgb2JqZWN0IGFuZCBqdXN0IHJldHVybiBpdCBiYWNrIHRvIHRoZSBjYWxsZXIuCgkJCQlpZiAoICQudHlwZSggdXJsICkgPT09ICJvYmplY3QiICkgewoJCQkJCXJldHVybiB1cmw7CgkJCQl9CgoJCQkJdmFyIG1hdGNoZXMgPSBwYXRoLnVybFBhcnNlUkUuZXhlYyggdXJsIHx8ICIiICkgfHwgW107CgoJCQkJCS8vIENyZWF0ZSBhbiBvYmplY3QgdGhhdCBhbGxvd3MgdGhlIGNhbGxlciB0byBhY2Nlc3MgdGhlIHN1Yi1tYXRjaGVzCgkJCQkJLy8gYnkgbmFtZS4gTm90ZSB0aGF0IElFIHJldHVybnMgYW4gZW1wdHkgc3RyaW5nIGluc3RlYWQgb2YgdW5kZWZpbmVkLAoJCQkJCS8vIGxpa2UgYWxsIG90aGVyIGJyb3dzZXJzIGRvLCBzbyB3ZSBub3JtYWxpemUgZXZlcnl0aGluZyBzbyBpdHMgY29uc2lzdGVudAoJCQkJCS8vIG5vIG1hdHRlciB3aGF0IGJyb3dzZXIgd2UncmUgcnVubmluZyBvbi4KCQkJCQlyZXR1cm4gewoJCQkJCQlocmVmOiAgICAgICAgIG1hdGNoZXNbICAwIF0gfHwgIiIsCgkJCQkJCWhyZWZOb0hhc2g6ICAgbWF0Y2hlc1sgIDEgXSB8fCAiIiwKCQkJCQkJaHJlZk5vU2VhcmNoOiBtYXRjaGVzWyAgMiBdIHx8ICIiLAoJCQkJCQlkb21haW46ICAgICAgIG1hdGNoZXNbICAzIF0gfHwgIiIsCgkJCQkJCXByb3RvY29sOiAgICAgbWF0Y2hlc1sgIDQgXSB8fCAiIiwKCQkJCQkJZG91YmxlU2xhc2g6ICBtYXRjaGVzWyAgNSBdIHx8ICIiLAoJCQkJCQlhdXRob3JpdHk6ICAgIG1hdGNoZXNbICA2IF0gfHwgIiIsCgkJCQkJCXVzZXJuYW1lOiAgICAgbWF0Y2hlc1sgIDggXSB8fCAiIiwKCQkJCQkJcGFzc3dvcmQ6ICAgICBtYXRjaGVzWyAgOSBdIHx8ICIiLAoJCQkJCQlob3N0OiAgICAgICAgIG1hdGNoZXNbIDEwIF0gfHwgIiIsCgkJCQkJCWhvc3RuYW1lOiAgICAgbWF0Y2hlc1sgMTEgXSB8fCAiIiwKCQkJCQkJcG9ydDogICAgICAgICBtYXRjaGVzWyAxMiBdIHx8ICIiLAoJCQkJCQlwYXRobmFtZTogICAgIG1hdGNoZXNbIDEzIF0gfHwgIiIsCgkJCQkJCWRpcmVjdG9yeTogICAgbWF0Y2hlc1sgMTQgXSB8fCAiIiwKCQkJCQkJZmlsZW5hbWU6ICAgICBtYXRjaGVzWyAxNSBdIHx8ICIiLAoJCQkJCQlzZWFyY2g6ICAgICAgIG1hdGNoZXNbIDE2IF0gfHwgIiIsCgkJCQkJCWhhc2g6ICAgICAgICAgbWF0Y2hlc1sgMTcgXSB8fCAiIgoJCQkJCX07CgkJCX0sCgoJCQkvL1R1cm4gcmVsUGF0aCBpbnRvIGFuIGFzYm9sdXRlIHBhdGguIGFic1BhdGggaXMKCQkJLy9hbiBvcHRpb25hbCBhYnNvbHV0ZSBwYXRoIHdoaWNoIGRlc2NyaWJlcyB3aGF0CgkJCS8vcmVsUGF0aCBpcyByZWxhdGl2ZSB0by4KCQkJbWFrZVBhdGhBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFBhdGgsIGFic1BhdGggKSB7CgkJCQl2YXIgYWJzU3RhY2ssCgkJCQkJcmVsU3RhY2ssCgkJCQkJaSwgZDsKCgkJCQlpZiAoIHJlbFBhdGggJiYgcmVsUGF0aC5jaGFyQXQoIDAgKSA9PT0gIi8iICkgewoJCQkJCXJldHVybiByZWxQYXRoOwoJCQkJfQoKCQkJCXJlbFBhdGggPSByZWxQYXRoIHx8ICIiOwoJCQkJYWJzUGF0aCA9IGFic1BhdGggPyBhYnNQYXRoLnJlcGxhY2UoIC9eXC98KFwvW15cL10qfFteXC9dKykkL2csICIiICkgOiAiIjsKCgkJCQlhYnNTdGFjayA9IGFic1BhdGggPyBhYnNQYXRoLnNwbGl0KCAiLyIgKSA6IFtdOwoJCQkJcmVsU3RhY2sgPSByZWxQYXRoLnNwbGl0KCAiLyIgKTsKCgkJCQlmb3IgKCBpID0gMDsgaSA8IHJlbFN0YWNrLmxlbmd0aDsgaSsrICkgewoJCQkJCWQgPSByZWxTdGFja1sgaSBdOwoJCQkJCXN3aXRjaCAoIGQgKSB7CgkJCQkJCWNhc2UgIi4iOgoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgIi4uIjoKCQkJCQkJCWlmICggYWJzU3RhY2subGVuZ3RoICkgewoJCQkJCQkJCWFic1N0YWNrLnBvcCgpOwoJCQkJCQkJfQoJCQkJCQkJYnJlYWs7CgkJCQkJCWRlZmF1bHQ6CgkJCQkJCQlhYnNTdGFjay5wdXNoKCBkICk7CgkJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gIi8iICsgYWJzU3RhY2suam9pbiggIi8iICk7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBpZiBib3RoIHVybHMgaGF2ZSB0aGUgc2FtZSBkb21haW4uCgkJCWlzU2FtZURvbWFpbjogZnVuY3Rpb24oIGFic1VybDEsIGFic1VybDIgKSB7CgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggYWJzVXJsMSApLmRvbWFpbiA9PT0gcGF0aC5wYXJzZVVybCggYWJzVXJsMiApLmRvbWFpbjsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGZvciBhbnkgcmVsYXRpdmUgdmFyaWFudC4KCQkJaXNSZWxhdGl2ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIEFsbCByZWxhdGl2ZSBVcmwgdmFyaWFudHMgaGF2ZSBvbmUgdGhpbmcgaW4gY29tbW9uLCBubyBwcm90b2NvbC4KCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCA9PT0gIiI7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW4gYWJzb2x1dGUgdXJsLgoJCQlpc0Fic29sdXRlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIHVybCApLnByb3RvY29sICE9PSAiIjsKCQkJfSwKCgkJCS8vVHVybiB0aGUgc3BlY2lmaWVkIHJlYWx0aXZlIFVSTCBpbnRvIGFuIGFic29sdXRlIG9uZS4gVGhpcyBmdW5jdGlvbgoJCQkvL2NhbiBoYW5kbGUgYWxsIHJlbGF0aXZlIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBmcmFnbWVudCkuCgkJCW1ha2VVcmxBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFVybCwgYWJzVXJsICkgewoJCQkJaWYgKCAhcGF0aC5pc1JlbGF0aXZlVXJsKCByZWxVcmwgKSApIHsKCQkJCQlyZXR1cm4gcmVsVXJsOwoJCQkJfQoKCQkJCWlmICggYWJzVXJsID09PSB1bmRlZmluZWQgKSB7CgkJCQkJYWJzVXJsID0gdGhpcy5kb2N1bWVudEJhc2U7CgkJCQl9CgoJCQkJdmFyIHJlbE9iaiA9IHBhdGgucGFyc2VVcmwoIHJlbFVybCApLAoJCQkJCWFic09iaiA9IHBhdGgucGFyc2VVcmwoIGFic1VybCApLAoJCQkJCXByb3RvY29sID0gcmVsT2JqLnByb3RvY29sIHx8IGFic09iai5wcm90b2NvbCwKCQkJCQlkb3VibGVTbGFzaCA9IHJlbE9iai5wcm90b2NvbCA/IHJlbE9iai5kb3VibGVTbGFzaCA6ICggcmVsT2JqLmRvdWJsZVNsYXNoIHx8IGFic09iai5kb3VibGVTbGFzaCApLAoJCQkJCWF1dGhvcml0eSA9IHJlbE9iai5hdXRob3JpdHkgfHwgYWJzT2JqLmF1dGhvcml0eSwKCQkJCQloYXNQYXRoID0gcmVsT2JqLnBhdGhuYW1lICE9PSAiIiwKCQkJCQlwYXRobmFtZSA9IHBhdGgubWFrZVBhdGhBYnNvbHV0ZSggcmVsT2JqLnBhdGhuYW1lIHx8IGFic09iai5maWxlbmFtZSwgYWJzT2JqLnBhdGhuYW1lICksCgkJCQkJc2VhcmNoID0gcmVsT2JqLnNlYXJjaCB8fCAoICFoYXNQYXRoICYmIGFic09iai5zZWFyY2ggKSB8fCAiIiwKCQkJCQloYXNoID0gcmVsT2JqLmhhc2g7CgoJCQkJcmV0dXJuIHByb3RvY29sICsgZG91YmxlU2xhc2ggKyBhdXRob3JpdHkgKyBwYXRobmFtZSArIHNlYXJjaCArIGhhc2g7CgkJCX0sCgoJCQkvL0FkZCBzZWFyY2ggKGFrYSBxdWVyeSkgcGFyYW1zIHRvIHRoZSBzcGVjaWZpZWQgdXJsLgoJCQlhZGRTZWFyY2hQYXJhbXM6IGZ1bmN0aW9uKCB1cmwsIHBhcmFtcyApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggdXJsICksCgkJCQkJcCA9ICggdHlwZW9mIHBhcmFtcyA9PT0gIm9iamVjdCIgKSA/ICQucGFyYW0oIHBhcmFtcyApIDogcGFyYW1zLAoJCQkJCXMgPSB1LnNlYXJjaCB8fCAiPyI7CgkJCQlyZXR1cm4gdS5ocmVmTm9TZWFyY2ggKyBzICsgKCBzLmNoYXJBdCggcy5sZW5ndGggLSAxICkgIT09ICI/IiA/ICImIiA6ICIiICkgKyBwICsgKCB1Lmhhc2ggfHwgIiIgKTsKCQkJfSwKCgkJCWNvbnZlcnRVcmxUb0RhdGFVcmw6IGZ1bmN0aW9uKCBhYnNVcmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIGFic1VybCApOwoJCQkJaWYgKCBwYXRoLmlzRW1iZWRkZWRQYWdlKCB1ICkgKSB7CgkJCQkJLy8gRm9yIGVtYmVkZGVkIHBhZ2VzLCByZW1vdmUgdGhlIGRpYWxvZyBoYXNoIGtleSBhcyBpbiBnZXRGaWxlUGF0aCgpLAoJCQkJCS8vIGFuZCByZW1vdmUgb3RoZXJ3aXNlIHRoZSBEYXRhIFVybCB3b24ndCBtYXRjaCB0aGUgaWQgb2YgdGhlIGVtYmVkZGVkIFBhZ2UuCgkJCQkJcmV0dXJuIHUuaGFzaAoJCQkJCQkuc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXQoJCQkJCQkucmVwbGFjZSggL14jLywgIiIgKQoJCQkJCQkucmVwbGFjZSggL1w/LiokLywgIiIgKTsKCQkJCX0gZWxzZSBpZiAoIHBhdGguaXNTYW1lRG9tYWluKCB1LCB0aGlzLmRvY3VtZW50QmFzZSApICkgewoJCQkJCXJldHVybiB1LmhyZWZOb0hhc2gucmVwbGFjZSggdGhpcy5kb2N1bWVudEJhc2UuZG9tYWluLCAiIiApLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCQl9CgoJCQkJcmV0dXJuIHdpbmRvdy5kZWNvZGVVUklDb21wb25lbnQoYWJzVXJsKTsKCQkJfSwKCgkJCS8vZ2V0IHBhdGggZnJvbSBjdXJyZW50IGhhc2gsIG9yIGZyb20gYSBmaWxlIHBhdGgKCQkJZ2V0OiBmdW5jdGlvbiggbmV3UGF0aCApIHsKCQkJCWlmICggbmV3UGF0aCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCW5ld1BhdGggPSBwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoJCQkJfQoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBuZXdQYXRoICkucmVwbGFjZSggL1teXC9dKlwuW15cLypdKyQvLCAiIiApOwoJCQl9LAoKCQkJLy9zZXQgbG9jYXRpb24gaGFzaCB0byBwYXRoCgkJCXNldDogZnVuY3Rpb24oIHBhdGggKSB7CgkJCQlsb2NhdGlvbi5oYXNoID0gcGF0aDsKCQkJfSwKCgkJCS8vdGVzdCBpZiBhIGdpdmVuIHVybCAoc3RyaW5nKSBpcyBhIHBhdGgKCQkJLy9OT1RFIG1pZ2h0IGJlIGV4Y2VwdGlvbmFsbHkgbmFpdmUKCQkJaXNQYXRoOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuICggL1wvLyApLnRlc3QoIHVybCApOwoJCQl9LAoKCQkJLy9yZXR1cm4gYSB1cmwgcGF0aCB3aXRoIHRoZSB3aW5kb3cncyBsb2NhdGlvbiBwcm90b2NvbC9ob3N0bmFtZS9wYXRobmFtZSByZW1vdmVkCgkJCWNsZWFuOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCB0aGlzLmRvY3VtZW50QmFzZS5kb21haW4sICIiICk7CgkJCX0sCgoJCQkvL2p1c3QgcmV0dXJuIHRoZSB1cmwgd2l0aG91dCBhbiBpbml0aWFsICMKCQkJc3RyaXBIYXNoOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCAvXiMvLCAiIiApOwoJCQl9LAoKCQkJc3RyaXBRdWVyeVBhcmFtczogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggL1w/LiokLywgIiIgKTsKCQkJfSwKCgkJCS8vcmVtb3ZlIHRoZSBwcmVjZWRpbmcgaGFzaCwgYW55IHF1ZXJ5IHBhcmFtcywgYW5kIGRpYWxvZyBub3RhdGlvbnMKCQkJY2xlYW5IYXNoOiBmdW5jdGlvbiggaGFzaCApIHsKCQkJCXJldHVybiBwYXRoLnN0cmlwSGFzaCggaGFzaC5yZXBsYWNlKCAvXD8uKiQvLCAiIiApLnJlcGxhY2UoIGRpYWxvZ0hhc2hLZXksICIiICkgKTsKCQkJfSwKCgkJCWlzSGFzaFZhbGlkOiBmdW5jdGlvbiggaGFzaCApIHsKCQkJCXJldHVybiAoIC9eI1teI10rJC8gKS50ZXN0KCBoYXNoICk7CgkJCX0sCgoJCQkvL2NoZWNrIHdoZXRoZXIgYSB1cmwgaXMgcmVmZXJlbmNpbmcgdGhlIHNhbWUgZG9tYWluLCBvciBhbiBleHRlcm5hbCBkb21haW4gb3IgZGlmZmVyZW50IHByb3RvY29sCgkJCS8vY291bGQgYmUgbWFpbHRvLCBldGMKCQkJaXNFeHRlcm5hbDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgkJCQlyZXR1cm4gdS5wcm90b2NvbCAmJiB1LmRvbWFpbiAhPT0gdGhpcy5kb2N1bWVudFVybC5kb21haW4gPyB0cnVlIDogZmFsc2U7CgkJCX0sCgoJCQloYXNQcm90b2NvbDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiAoIC9eKDo/XHcrOikvICkudGVzdCggdXJsICk7CgkJCX0sCgoJCQlpc0VtYmVkZGVkUGFnZTogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgoJCQkJLy9pZiB0aGUgcGF0aCBpcyBhYnNvbHV0ZSwgdGhlbiB3ZSBuZWVkIHRvIGNvbXBhcmUgdGhlIHVybCBhZ2FpbnN0CgkJCQkvL2JvdGggdGhlIHRoaXMuZG9jdW1lbnRVcmwgYW5kIHRoZSBkb2N1bWVudEJhc2UuIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcwoJCQkJLy9pcyB0aGF0IGxpbmtzIGVtYmVkZGVkIHdpdGhpbiBleHRlcm5hbCBkb2N1bWVudHMgd2lsbCByZWZlciB0byB0aGUKCQkJCS8vYXBwbGljYXRpb24gZG9jdW1lbnQsIHdoZXJlYXMgbGlua3MgZW1iZWRkZWQgd2l0aGluIHRoZSBhcHBsaWNhdGlvbgoJCQkJLy9kb2N1bWVudCB3aWxsIGJlIHJlc29sdmVkIGFnYWluc3QgdGhlIGRvY3VtZW50IGJhc2UuCgkJCQlpZiAoIHUucHJvdG9jb2wgIT09ICIiICkgewoJCQkJCXJldHVybiAoICF0aGlzLmlzUGF0aCh1Lmhhc2gpICYmIHUuaGFzaCAmJiAoIHUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudFVybC5ocmVmTm9IYXNoIHx8ICggdGhpcy5kb2N1bWVudEJhc2VEaWZmZXJzICYmIHUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApICkgKTsKCQkJCX0KCQkJCXJldHVybiAoIC9eIy8gKS50ZXN0KCB1LmhyZWYgKTsKCQkJfSwKCgkJCXNxdWFzaDogZnVuY3Rpb24oIHVybCwgcmVzb2x1dGlvblVybCApIHsKCQkJCXZhciBocmVmLCBjbGVhbmVkVXJsLCBzZWFyY2gsIHN0YXRlSW5kZXgsCgkJCQkJaXNQYXRoID0gdGhpcy5pc1BhdGgoIHVybCApLAoJCQkJCXVyaSA9IHRoaXMucGFyc2VVcmwoIHVybCApLAoJCQkJCXByZXNlcnZlZEhhc2ggPSB1cmkuaGFzaCwKCQkJCQl1aVN0YXRlID0gIiI7CgoJCQkJLy8gcHJvZHVjZSBhIHVybCBhZ2FpbnN0IHdoaWNoIHdlIGNhbiByZXNvbGUgdGhlIHByb3ZpZGVkIHBhdGgKCQkJCXJlc29sdXRpb25VcmwgPSByZXNvbHV0aW9uVXJsIHx8IChwYXRoLmlzUGF0aCh1cmwpID8gcGF0aC5nZXRMb2NhdGlvbigpIDogcGF0aC5nZXREb2N1bWVudFVybCgpKTsKCgkJCQkvLyBJZiB0aGUgdXJsIGlzIGFueXRoaW5nIGJ1dCBhIHNpbXBsZSBzdHJpbmcsIHJlbW92ZSBhbnkgcHJlY2VkaW5nIGhhc2gKCQkJCS8vIGVnICNmb28vYmFyIC0+IGZvby9iYXIKCQkJCS8vICAgICNmb28gLT4gI2ZvbwoJCQkJY2xlYW5lZFVybCA9IGlzUGF0aCA/IHBhdGguc3RyaXBIYXNoKCB1cmwgKSA6IHVybDsKCgkJCQkvLyBJZiB0aGUgdXJsIGlzIGEgZnVsbCB1cmwgd2l0aCBhIGhhc2ggY2hlY2sgaWYgdGhlIHBhcnNlZCBoYXNoIGlzIGEgcGF0aAoJCQkJLy8gaWYgaXQgaXMsIHN0cmlwIHRoZSAjLCBhbmQgdXNlIGl0IG90aGVyd2lzZSBjb250aW51ZSB3aXRob3V0IGNoYW5nZQoJCQkJY2xlYW5lZFVybCA9IHBhdGguaXNQYXRoKCB1cmkuaGFzaCApID8gcGF0aC5zdHJpcEhhc2goIHVyaS5oYXNoICkgOiBjbGVhbmVkVXJsOwoKCQkJCS8vIFNwbGl0IHRoZSBVSSBTdGF0ZSBrZXlzIG9mZiB0aGUgaHJlZgoJCQkJc3RhdGVJbmRleCA9IGNsZWFuZWRVcmwuaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICk7CgoJCQkJLy8gc3RvcmUgdGhlIHVpIHN0YXRlIGtleXMgZm9yIHVzZQoJCQkJaWYgKCBzdGF0ZUluZGV4ID4gLTEgKXsKCQkJCQl1aVN0YXRlID0gY2xlYW5lZFVybC5zbGljZSggc3RhdGVJbmRleCApOwoJCQkJCWNsZWFuZWRVcmwgPSBjbGVhbmVkVXJsLnNsaWNlKCAwLCBzdGF0ZUluZGV4ICk7CgkJCQl9CgoJCQkJLy8gbWFrZSB0aGUgY2xlYW5lZFVybCBhYnNvbHV0ZSByZWxhdGl2ZSB0byB0aGUgcmVzb2x1dGlvbiB1cmwKCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggY2xlYW5lZFVybCwgcmVzb2x1dGlvblVybCApOwoKCQkJCS8vIGdyYWIgdGhlIHNlYXJjaCBmcm9tIHRoZSByZXNvbHZlZCB1cmwgc2luY2UgcGFyc2luZyBmcm9tCgkJCQkvLyB0aGUgcGFzc2VkIHVybCBtYXkgbm90IHlpZWxkIHRoZSBjb3JyZWN0IHJlc3VsdAoJCQkJc2VhcmNoID0gdGhpcy5wYXJzZVVybCggaHJlZiApLnNlYXJjaDsKCgkJCQkvLyBUT0RPIGFsbCB0aGlzIGNyYXAgaXMgdGVycmlibGUsIGNsZWFuIGl0IHVwCgkJCQlpZiAoIGlzUGF0aCApIHsKCQkJCQkvLyByZWplY3QgdGhlIGhhc2ggaWYgaXQncyBhIHBhdGggb3IgaXQncyBqdXN0IGEgZGlhbG9nIGtleQoJCQkJCWlmICggcGF0aC5pc1BhdGgoIHByZXNlcnZlZEhhc2ggKSB8fCBwcmVzZXJ2ZWRIYXNoLnJlcGxhY2UoIiMiLCAiIikuaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICkgPT09IDApIHsKCQkJCQkJcHJlc2VydmVkSGFzaCA9ICIiOwoJCQkJCX0KCgkJCQkJLy8gQXBwZW5kIHRoZSBVSSBTdGF0ZSBrZXlzIHdoZXJlIGl0IGV4aXN0cyBhbmQgaXQncyBiZWVuIHJlbW92ZWQKCQkJCQkvLyBmcm9tIHRoZSB1cmwKCQkJCQlpZiAoIHVpU3RhdGUgJiYgcHJlc2VydmVkSGFzaC5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKSA9PT0gLTEpewoJCQkJCQlwcmVzZXJ2ZWRIYXNoICs9IHVpU3RhdGU7CgkJCQkJfQoKCQkJCQkvLyBtYWtlIHN1cmUgdGhhdCBwb3VuZCBpcyBvbiB0aGUgZnJvbnQgb2YgdGhlIGhhc2gKCQkJCQlpZiAoIHByZXNlcnZlZEhhc2guaW5kZXhPZiggIiMiICkgPT09IC0xICYmIHByZXNlcnZlZEhhc2ggIT09ICIiICl7CgkJCQkJCXByZXNlcnZlZEhhc2ggPSAiIyIgKyBwcmVzZXJ2ZWRIYXNoOwoJCQkJCX0KCgkJCQkJLy8gcmVjb25zdHJ1Y3QgZWFjaCBvZiB0aGUgcGllY2VzIHdpdGggdGhlIG5ldyBzZWFyY2ggc3RyaW5nIGFuZCBoYXNoCgkJCQkJaHJlZiA9IHBhdGgucGFyc2VVcmwoIGhyZWYgKTsKCQkJCQlocmVmID0gaHJlZi5wcm90b2NvbCArICIvLyIgKyBocmVmLmhvc3QgKyBocmVmLnBhdGhuYW1lICsgc2VhcmNoICsgcHJlc2VydmVkSGFzaDsKCQkJCX0gZWxzZSB7CgkJCQkJaHJlZiArPSBocmVmLmluZGV4T2YoICIjIiApID4gLTEgPyB1aVN0YXRlIDogIiMiICsgdWlTdGF0ZTsKCQkJCX0KCgkJCQlyZXR1cm4gaHJlZjsKCQkJfSwKCgkJCWlzUHJlc2VydmFibGVIYXNoOiBmdW5jdGlvbiggaGFzaCApIHsKCQkJCXJldHVybiBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKS5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKSA9PT0gMDsKCQkJfSwKCgkJCS8vIEVzY2FwZSB3ZWlyZCBjaGFyYWN0ZXJzIGluIHRoZSBoYXNoIGlmIGl0IGlzIHRvIGJlIHVzZWQgYXMgYSBzZWxlY3RvcgoJCQloYXNoVG9TZWxlY3RvcjogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQl2YXIgaGFzSGFzaCA9ICggaGFzaC5zdWJzdHJpbmcoIDAsIDEgKSA9PT0gIiMiICk7CgkJCQlpZiAoIGhhc0hhc2ggKSB7CgkJCQkJaGFzaCA9IGhhc2guc3Vic3RyaW5nKCAxICk7CgkJCQl9CgkJCQlyZXR1cm4gKCBoYXNIYXNoID8gIiMiIDogIiIgKSArIGhhc2gucmVwbGFjZSggLyhbISIjJCUmJygpKissLi86Ozw9Pj9AW1xdXmB7fH1+XSkvZywgIlxcJDEiICk7CgkJCX0KCQl9OwoKCQlwYXRoLmRvY3VtZW50VXJsID0gcGF0aC5wYXJzZUxvY2F0aW9uKCk7CgoJCSRiYXNlID0gJCggImhlYWQiICkuZmluZCggImJhc2UiICk7CgoJCXBhdGguZG9jdW1lbnRCYXNlID0gJGJhc2UubGVuZ3RoID8KCQkJcGF0aC5wYXJzZVVybCggcGF0aC5tYWtlVXJsQWJzb2x1dGUoICRiYXNlLmF0dHIoICJocmVmIiApLCBwYXRoLmRvY3VtZW50VXJsLmhyZWYgKSApIDoKCQkJcGF0aC5kb2N1bWVudFVybDsKCgkJcGF0aC5kb2N1bWVudEJhc2VEaWZmZXJzID0gKHBhdGguZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCAhPT0gcGF0aC5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCk7CgoJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCB1cmwKCQlwYXRoLmdldERvY3VtZW50VXJsID0gZnVuY3Rpb24oIGFzUGFyc2VkT2JqZWN0ICkgewoJCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIHBhdGguZG9jdW1lbnRVcmwgKSA6IHBhdGguZG9jdW1lbnRVcmwuaHJlZjsKCQl9OwoKCQkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgYmFzZSB1cmwKCQlwYXRoLmdldERvY3VtZW50QmFzZSA9IGZ1bmN0aW9uKCBhc1BhcnNlZE9iamVjdCApIHsKCQkJcmV0dXJuIGFzUGFyc2VkT2JqZWN0ID8gJC5leHRlbmQoIHt9LCBwYXRoLmRvY3VtZW50QmFzZSApIDogcGF0aC5kb2N1bWVudEJhc2UuaHJlZjsKCQl9Owp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJJC5tb2JpbGUuSGlzdG9yeSA9IGZ1bmN0aW9uKCBzdGFjaywgaW5kZXggKSB7CgkJdGhpcy5zdGFjayA9IHN0YWNrIHx8IFtdOwoJCXRoaXMuYWN0aXZlSW5kZXggPSBpbmRleCB8fCAwOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5IaXN0b3J5LnByb3RvdHlwZSwgewoJCWdldEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IF07CgkJfSwKCgkJZ2V0TGFzdDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLnByZXZpb3VzSW5kZXggXTsKCQl9LAoKCQlnZXROZXh0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMuYWN0aXZlSW5kZXggKyAxIF07CgkJfSwKCgkJZ2V0UHJldjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IC0gMSBdOwoJCX0sCgoJCS8vIGFkZE5ldyBpcyB1c2VkIHdoZW5ldmVyIGEgbmV3IHBhZ2UgaXMgYWRkZWQKCQlhZGQ6IGZ1bmN0aW9uKCB1cmwsIGRhdGEgKXsKCQkJZGF0YSA9IGRhdGEgfHwge307CgoJCQkvL2lmIHRoZXJlJ3MgZm9yd2FyZCBoaXN0b3J5LCB3aXBlIGl0CgkJCWlmICggdGhpcy5nZXROZXh0KCkgKSB7CgkJCQl0aGlzLmNsZWFyRm9yd2FyZCgpOwoJCQl9CgoJCQkvLyBpZiB0aGUgaGFzaCBpcyBpbmNsdWRlZCBpbiB0aGUgZGF0YSBtYWtlIHN1cmUgdGhlIHNoYXBlCgkJCS8vIGlzIGNvbnNpc3RlbnQgZm9yIGNvbXBhcmlzb24KCQkJaWYgKCBkYXRhLmhhc2ggJiYgZGF0YS5oYXNoLmluZGV4T2YoICIjIiApID09PSAtMSkgewoJCQkJZGF0YS5oYXNoID0gIiMiICsgZGF0YS5oYXNoOwoJCQl9CgoJCQlkYXRhLnVybCA9IHVybDsKCQkJdGhpcy5zdGFjay5wdXNoKCBkYXRhICk7CgkJCXRoaXMuYWN0aXZlSW5kZXggPSB0aGlzLnN0YWNrLmxlbmd0aCAtIDE7CgkJfSwKCgkJLy93aXBlIHVybHMgYWhlYWQgb2YgYWN0aXZlIGluZGV4CgkJY2xlYXJGb3J3YXJkOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5zdGFjayA9IHRoaXMuc3RhY2suc2xpY2UoIDAsIHRoaXMuYWN0aXZlSW5kZXggKyAxICk7CgkJfSwKCgkJZmluZDogZnVuY3Rpb24oIHVybCwgc3RhY2ssIGVhcmx5UmV0dXJuICkgewoJCQlzdGFjayA9IHN0YWNrIHx8IHRoaXMuc3RhY2s7CgoJCQl2YXIgZW50cnksIGksIGxlbmd0aCA9IHN0YWNrLmxlbmd0aCwgaW5kZXg7CgoJCQlmb3IgKCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQkJZW50cnkgPSBzdGFja1tpXTsKCgkJCQlpZiAoIGRlY29kZVVSSUNvbXBvbmVudCh1cmwpID09PSBkZWNvZGVVUklDb21wb25lbnQoZW50cnkudXJsKSB8fAoJCQkJCWRlY29kZVVSSUNvbXBvbmVudCh1cmwpID09PSBkZWNvZGVVUklDb21wb25lbnQoZW50cnkuaGFzaCkgKSB7CgkJCQkJaW5kZXggPSBpOwoKCQkJCQlpZiAoIGVhcmx5UmV0dXJuICkgewoJCQkJCQlyZXR1cm4gaW5kZXg7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gaW5kZXg7CgkJfSwKCgkJY2xvc2VzdDogZnVuY3Rpb24oIHVybCApIHsKCQkJdmFyIGNsb3Nlc3QsIGEgPSB0aGlzLmFjdGl2ZUluZGV4OwoKCQkJLy8gRmlyc3QsIHRha2UgdGhlIHNsaWNlIG9mIHRoZSBoaXN0b3J5IHN0YWNrIGJlZm9yZSB0aGUgY3VycmVudCBpbmRleCBhbmQgc2VhcmNoCgkJCS8vIGZvciBhIHVybCBtYXRjaC4gSWYgb25lIGlzIGZvdW5kLCB3ZSdsbCBhdm9pZCBhdm9pZCBsb29raW5nIHRocm91Z2ggZm9yd2FyZCBoaXN0b3J5CgkJCS8vIE5PVEUgdGhlIHByZWZlcmVuY2UgZm9yIGJhY2t3YXJkIGhpc3RvcnkgbW92ZW1lbnQgaXMgZHJpdmVuIGJ5IHRoZSBmYWN0IHRoYXQKCQkJLy8gICAgICBtb3N0IG1vYmlsZSBicm93c2VycyBvbmx5IGhhdmUgYSBkZWRpY2F0ZWQgYmFjayBidXR0b24sIGFuZCB1c2VycyByYXJlbHkgdXNlCgkJCS8vICAgICAgdGhlIGZvcndhcmQgYnV0dG9uIGluIGRlc2t0b3AgYnJvd3NlciBhbnlob3cKCQkJY2xvc2VzdCA9IHRoaXMuZmluZCggdXJsLCB0aGlzLnN0YWNrLnNsaWNlKDAsIGEpICk7CgoJCQkvLyBJZiBub3RoaW5nIHdhcyBmb3VuZCBpbiBiYWNrd2FyZCBoaXN0b3J5IGNoZWNrIGZvcndhcmQuIFRoZSBgdHJ1ZWAKCQkJLy8gdmFsdWUgcGFzc2VkIGFzIHRoZSB0aGlyZCBwYXJhbWV0ZXIgY2F1c2VzIHRoZSBmaW5kIG1ldGhvZCB0byBicmVhawoJCQkvLyBvbiB0aGUgZmlyc3QgbWF0Y2ggaW4gdGhlIGZvcndhcmQgaGlzdG9yeSBzbGljZS4gVGhlIHN0YXJ0aW5nIGluZGV4CgkJCS8vIG9mIHRoZSBzbGljZSBtdXN0IHRoZW4gYmUgYWRkZWQgdG8gdGhlIHJlc3VsdCB0byBnZXQgdGhlIGVsZW1lbnQgaW5kZXgKCQkJLy8gaW4gdGhlIG9yaWdpbmFsIGhpc3Rvcnkgc3RhY2sgOiggOigKCQkJLy8KCQkJLy8gVE9ETyB0aGlzIGlzIGh5cGVyIGNvbmZ1c2luZyBhbmQgc2hvdWxkIGJlIGNsZWFuZWQgdXAgKHVnaCBzbyBiYWQpCgkJCWlmICggY2xvc2VzdCA9PT0gdW5kZWZpbmVkICkgewoJCQkJY2xvc2VzdCA9IHRoaXMuZmluZCggdXJsLCB0aGlzLnN0YWNrLnNsaWNlKGEpLCB0cnVlICk7CgkJCQljbG9zZXN0ID0gY2xvc2VzdCA9PT0gdW5kZWZpbmVkID8gY2xvc2VzdCA6IGNsb3Nlc3QgKyBhOwoJCQl9CgoJCQlyZXR1cm4gY2xvc2VzdDsKCQl9LAoKCQlkaXJlY3Q6IGZ1bmN0aW9uKCBvcHRzICkgewoJCQl2YXIgbmV3QWN0aXZlSW5kZXggPSB0aGlzLmNsb3Nlc3QoIG9wdHMudXJsICksIGEgPSB0aGlzLmFjdGl2ZUluZGV4OwoKCQkJLy8gc2F2ZSBuZXcgcGFnZSBpbmRleCwgbnVsbCBjaGVjayB0byBwcmV2ZW50IGZhbHNleSAwIHJlc3VsdAoJCQkvLyByZWNvcmQgdGhlIHByZXZpb3VzIGluZGV4IGZvciByZWZlcmVuY2UKCQkJaWYgKCBuZXdBY3RpdmVJbmRleCAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5hY3RpdmVJbmRleCA9IG5ld0FjdGl2ZUluZGV4OwoJCQkJdGhpcy5wcmV2aW91c0luZGV4ID0gYTsKCQkJfQoKCQkJLy8gaW52b2tlIGNhbGxiYWNrcyB3aGVyZSBhcHByb3ByaWF0ZQoJCQkvLwoJCQkvLyBUT0RPIHRoaXMgaXMgYWxzbyBjb252b2x1dGVkIGFuZCBjb25mdXNpbmcKCQkJaWYgKCBuZXdBY3RpdmVJbmRleCA8IGEgKSB7CgkJCQkoIG9wdHMucHJlc2VudCB8fCBvcHRzLmJhY2sgfHwgJC5ub29wICkoIHRoaXMuZ2V0QWN0aXZlKCksICJiYWNrIiApOwoJCQl9IGVsc2UgaWYgKCBuZXdBY3RpdmVJbmRleCA+IGEgKSB7CgkJCQkoIG9wdHMucHJlc2VudCB8fCBvcHRzLmZvcndhcmQgfHwgJC5ub29wICkoIHRoaXMuZ2V0QWN0aXZlKCksICJmb3J3YXJkIiApOwoJCQl9IGVsc2UgaWYgKCBuZXdBY3RpdmVJbmRleCA9PT0gdW5kZWZpbmVkICYmIG9wdHMubWlzc2luZyApewoJCQkJb3B0cy5taXNzaW5nKCB0aGlzLmdldEFjdGl2ZSgpICk7CgkJCX0KCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyIHBhdGggPSAkLm1vYmlsZS5wYXRoLAoJCWluaXRpYWxIcmVmID0gbG9jYXRpb24uaHJlZjsKCgkkLm1vYmlsZS5OYXZpZ2F0b3IgPSBmdW5jdGlvbiggaGlzdG9yeSApIHsKCQl0aGlzLmhpc3RvcnkgPSBoaXN0b3J5OwoJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgPSB0cnVlOwoKCQkkLm1vYmlsZS53aW5kb3cuYmluZCh7CgkJCSJwb3BzdGF0ZS5oaXN0b3J5IjogJC5wcm94eSggdGhpcy5wb3BzdGF0ZSwgdGhpcyApLAoJCQkiaGFzaGNoYW5nZS5oaXN0b3J5IjogJC5wcm94eSggdGhpcy5oYXNoY2hhbmdlLCB0aGlzICkKCQl9KTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuTmF2aWdhdG9yLnByb3RvdHlwZSwgewoJCXNxdWFzaDogZnVuY3Rpb24oIHVybCwgZGF0YSApIHsKCQkJdmFyIHN0YXRlLCBocmVmLCBoYXNoID0gcGF0aC5pc1BhdGgodXJsKSA/IHBhdGguc3RyaXBIYXNoKHVybCkgOiB1cmw7CgoJCQlocmVmID0gcGF0aC5zcXVhc2goIHVybCApOwoKCQkJLy8gbWFrZSBzdXJlIHRvIHByb3ZpZGUgdGhpcyBpbmZvcm1hdGlvbiB3aGVuIGl0IGlzbid0IGV4cGxpY2l0bHkgc2V0IGluIHRoZQoJCQkvLyBkYXRhIG9iamVjdCB0aGF0IHdhcyBwYXNzZWQgdG8gdGhlIHNxdWFzaCBtZXRob2QKCQkJc3RhdGUgPSAkLmV4dGVuZCh7CgkJCQloYXNoOiBoYXNoLAoJCQkJdXJsOiBocmVmCgkJCX0sIGRhdGEpOwoKCQkJLy8gcmVwbGFjZSB0aGUgY3VycmVudCB1cmwgd2l0aCB0aGUgbmV3IGhyZWYgYW5kIHN0b3JlIHRoZSBzdGF0ZQoJCQkvLyBOb3RlIHRoYXQgaW4gc29tZSBjYXNlcyB3ZSBtaWdodCBiZSByZXBsYWNpbmcgYW4gdXJsIHdpdGggdGhlCgkJCS8vIHNhbWUgdXJsLiBXZSBkbyB0aGlzIGFueXdheXMgYmVjYXVzZSB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGF0CgkJCS8vIGFsbCBvZiBvdXIgaGlzdG9yeSBlbnRyaWVzIGhhdmUgYSBzdGF0ZSBvYmplY3QgYXNzb2NpYXRlZCB3aXRoCgkJCS8vIHRoZW0uIFRoaXMgYWxsb3dzIHVzIHRvIHdvcmsgYXJvdW5kIHRoZSBjYXNlIHdoZXJlICQubW9iaWxlLmJhY2soKQoJCQkvLyBpcyBjYWxsZWQgdG8gdHJhbnNpdGlvbiBmcm9tIGFuIGV4dGVybmFsIHBhZ2UgdG8gYW4gZW1iZWRkZWQgcGFnZS4KCQkJLy8gSW4gdGhhdCBwYXJ0aWN1bGFyIGNhc2UsIGEgaGFzaGNoYW5nZSBldmVudCBpcyAqTk9UKiBnZW5lcmF0ZWQgYnkgdGhlIGJyb3dzZXIuCgkJCS8vIEVuc3VyaW5nIGVhY2ggaGlzdG9yeSBlbnRyeSBoYXMgYSBzdGF0ZSBvYmplY3QgbWVhbnMgdGhhdCBvblBvcFN0YXRlKCkKCQkJLy8gd2lsbCBhbHdheXMgdHJpZ2dlciBvdXIgaGFzaGNoYW5nZSBjYWxsYmFjayBldmVuIHdoZW4gYSBoYXNoY2hhbmdlIGV2ZW50CgkJCS8vIGlzIG5vdCBmaXJlZC4KCQkJd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKCBzdGF0ZSwgc3RhdGUudGl0bGUgfHwgZG9jdW1lbnQudGl0bGUsIGhyZWYgKTsKCgkJCXJldHVybiBzdGF0ZTsKCQl9LAoKCQloYXNoOiBmdW5jdGlvbiggdXJsLCBocmVmICkgewoJCQl2YXIgcGFyc2VkLCBsb2MsIGhhc2gsIHJlc29sdmVkOwoKCQkJLy8gR3JhYiB0aGUgaGFzaCBmb3IgcmVjb3JkaW5nLiBJZiB0aGUgcGFzc2VkIHVybCBpcyBhIHBhdGgKCQkJLy8gd2UgdXNlZCB0aGUgcGFyc2VkIHZlcnNpb24gb2YgdGhlIHNxdWFzaGVkIHVybCB0byByZWNvbnN0cnVjdCwKCQkJLy8gb3RoZXJ3aXNlIHdlIGFzc3VtZSBpdCdzIGEgaGFzaCBhbmQgc3RvcmUgaXQgZGlyZWN0bHkKCQkJcGFyc2VkID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgkJCWxvYyA9IHBhdGgucGFyc2VMb2NhdGlvbigpOwoKCQkJaWYgKCBsb2MucGF0aG5hbWUgKyBsb2Muc2VhcmNoID09PSBwYXJzZWQucGF0aG5hbWUgKyBwYXJzZWQuc2VhcmNoICkgewoJCQkJLy8gSWYgdGhlIHBhdGhuYW1lIGFuZCBzZWFyY2ggb2YgdGhlIHBhc3NlZCB1cmwgaXMgaWRlbnRpY2FsIHRvIHRoZSBjdXJyZW50IGxvYwoJCQkJLy8gdGhlbiB3ZSBtdXN0IHVzZSB0aGUgaGFzaC4gT3RoZXJ3aXNlIHRoZXJlIHdpbGwgYmUgbm8gZXZlbnQKCQkJCS8vIGVnLCB1cmwgPSAiL2Zvby9iYXI/YmF6I2JhbmciLCBsb2NhdGlvbi5ocmVmID0gImh0dHA6Ly9leGFtcGxlLmNvbS9mb28vYmFyP2JheiIKCQkJCWhhc2ggPSBwYXJzZWQuaGFzaCA/IHBhcnNlZC5oYXNoIDogcGFyc2VkLnBhdGhuYW1lICsgcGFyc2VkLnNlYXJjaDsKCQkJfSBlbHNlIGlmICggcGF0aC5pc1BhdGgodXJsKSApIHsKCQkJCXJlc29sdmVkID0gcGF0aC5wYXJzZVVybCggaHJlZiApOwoJCQkJLy8gSWYgdGhlIHBhc3NlZCB1cmwgaXMgYSBwYXRoLCBtYWtlIGl0IGRvbWFpbiByZWxhdGl2ZSBhbmQgcmVtb3ZlIGFueSB0cmFpbGluZyBoYXNoCgkJCQloYXNoID0gcmVzb2x2ZWQucGF0aG5hbWUgKyByZXNvbHZlZC5zZWFyY2ggKyAocGF0aC5pc1ByZXNlcnZhYmxlSGFzaCggcmVzb2x2ZWQuaGFzaCApPyByZXNvbHZlZC5oYXNoLnJlcGxhY2UoICIjIiwgIiIgKSA6ICIiKTsKCQkJfSBlbHNlIHsKCQkJCWhhc2ggPSB1cmw7CgkJCX0KCgkJCXJldHVybiBoYXNoOwoJCX0sCgoJCS8vIFRPRE8gcmVjb25zaWRlciBuYW1lCgkJZ286IGZ1bmN0aW9uKCB1cmwsIGRhdGEsIG5vRXZlbnRzICkgewoJCQl2YXIgc3RhdGUsIGhyZWYsIGhhc2gsIHBvcHN0YXRlRXZlbnQsCgkJCQlpc1BvcFN0YXRlRXZlbnQgPSAkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCk7CgoJCQkvLyBHZXQgdGhlIHVybCBhcyBpdCB3b3VsZCBsb29rIHNxdWFzaGVkIG9uIHRvIHRoZSBjdXJyZW50IHJlc29sdXRpb24gdXJsCgkJCWhyZWYgPSBwYXRoLnNxdWFzaCggdXJsICk7CgoJCQkvLyBzb3J0IG91dCB3aGF0IHRoZSBoYXNoIHNvdWxkIGJlIGZyb20gdGhlIHVybAoJCQloYXNoID0gdGhpcy5oYXNoKCB1cmwsIGhyZWYgKTsKCgkJCS8vIEhlcmUgd2UgcHJldmVudCB0aGUgbmV4dCBoYXNoIGNoYW5nZSBvciBwb3BzdGF0ZSBldmVudCBmcm9tIGRvaW5nIGFueQoJCQkvLyBoaXN0b3J5IG1hbmFnZW1lbnQuIEluIHRoZSBjYXNlIG9mIGhhc2hjaGFuZ2Ugd2UgZG9uJ3Qgc3dhbGxvdyBpdAoJCQkvLyBpZiB0aGVyZSB3aWxsIGJlIG5vIGhhc2hjaGFuZ2UgZmlyZWQgKHNpbmNlIHRoYXQgd29uJ3QgcmVzZXQgdGhlIHZhbHVlKQoJCQkvLyBhbmQgd2lsbCBzd2FsbG93IHRoZSBmb2xsb3dpbmcgaGFzaGNoYW5nZQoJCQlpZiAoIG5vRXZlbnRzICYmIGhhc2ggIT09IHBhdGguc3RyaXBIYXNoKHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gpICkgewoJCQkJdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgPSBub0V2ZW50czsKCQkJfQoKCQkJLy8gSU1QT1JUQU5UIGluIHRoZSBjYXNlIHdoZXJlIHBvcHN0YXRlIGlzIHN1cHBvcnRlZCB0aGUgZXZlbnQgd2lsbCBiZSB0cmlnZ2VyZWQKCQkJLy8gICAgICBkaXJlY3RseSwgc3RvcHBpbmcgZnVydGhlciBleGVjdXRpb24gLSBpZSwgaW50ZXJ1cHRpbmcgdGhlIGZsb3cgb2YgdGhpcwoJCQkvLyAgICAgIG1ldGhvZCBjYWxsIHRvIGZpcmUgYmluZGluZ3MgYXQgdGhpcyBleHByZXNzaW9uLiBCZWxvdyB0aGUgbmF2aWdhdGUgbWV0aG9kCgkJCS8vICAgICAgdGhlcmUgaXMgYSBiaW5kaW5nIHRvIGNhdGNoIHRoaXMgZXZlbnQgYW5kIHN0b3AgaXRzIHByb3BhZ2F0aW9uLgoJCQkvLwoJCQkvLyAgICAgIFdlIHRoZW4gdHJpZ2dlciBhIG5ldyBwb3BzdGF0ZSBldmVudCBvbiB0aGUgd2luZG93IHdpdGggYSBudWxsIHN0YXRlCgkJCS8vICAgICAgc28gdGhhdCB0aGUgbmF2aWdhdGUgZXZlbnRzIGNhbiBjb25jbHVkZSB0aGVpciB3b3JrIHByb3Blcmx5CgkJCS8vCgkJCS8vIGlmIHRoZSB1cmwgaXMgYSBwYXRoIHdlIHdhbnQgdG8gcHJlc2VydmUgdGhlIHF1ZXJ5IHBhcmFtcyB0aGF0IGFyZSBhdmFpbGFibGUgb24KCQkJLy8gdGhlIGN1cnJlbnQgdXJsLgoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSB0cnVlOwoJCQl3aW5kb3cubG9jYXRpb24uaGFzaCA9IGhhc2g7CgoJCQkvLyBJZiBwb3BzdGF0ZSBpcyBlbmFibGVkIGFuZCB0aGUgYnJvd3NlciB0cmlnZ2VycyBgcG9wc3RhdGVgIGV2ZW50cyB3aGVuIHRoZSBoYXNoCgkJCS8vIGlzIHNldCAodGhpcyBvZnRlbiBoYXBwZW5zIGltbWVkaWF0ZWx5IGluIGJyb3dzZXJzIGxpa2UgQ2hyb21lKSwgdGhlbiB0aGUKCQkJLy8gdGhpcyBmbGFnIHdpbGwgYmUgc2V0IHRvIGZhbHNlIGFscmVhZHkuIElmIGl0J3MgYSBicm93c2VyIHRoYXQgZG9lcyBub3QgdHJpZ2dlcgoJCQkvLyBhIGBwb3BzdGF0ZWAgb24gaGFzaCBhc3NpZ25lbWVudCBvciBgcmVwbGFjZVN0YXRlYCB0aGVuIHdlIG5lZWQgYXZvaWQgdGhlIGJyYW5jaAoJCQkvLyB0aGF0IHN3YWxsb3dzIHRoZSBldmVudCBjcmVhdGVkIGJ5IHRoZSBwb3BzdGF0ZSBnZW5lcmF0ZWQgYnkgdGhlIGhhc2ggYXNzaWdubWVudAoJCQkvLyBBdCB0aGUgdGltZSBvZiB0aGlzIHdyaXRpbmcgdGhpcyBoYXBwZW5zIHdpdGggT3BlcmEgMTIgYW5kIHNvbWUgdmVyc2lvbiBvZiBJRQoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCgkJCXN0YXRlID0gJC5leHRlbmQoewoJCQkJdXJsOiBocmVmLAoJCQkJaGFzaDogaGFzaCwKCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZQoJCQl9LCBkYXRhKTsKCgkJCWlmICggaXNQb3BTdGF0ZUV2ZW50ICkgewoJCQkJcG9wc3RhdGVFdmVudCA9IG5ldyAkLkV2ZW50KCAicG9wc3RhdGUiICk7CgkJCQlwb3BzdGF0ZUV2ZW50Lm9yaWdpbmFsRXZlbnQgPSB7CgkJCQkJdHlwZTogInBvcHN0YXRlIiwKCQkJCQlzdGF0ZTogbnVsbAoJCQkJfTsKCgkJCQl0aGlzLnNxdWFzaCggdXJsLCBzdGF0ZSApOwoKCQkJCS8vIFRyaWdnZXIgYSBuZXcgZmF1eCBwb3BzdGF0ZSBldmVudCB0byByZXBsYWNlIHRoZSBvbmUgdGhhdCB3ZQoJCQkJLy8gY2F1Z2h0IHRoYXQgd2FzIHRyaWdnZXJlZCBieSB0aGUgaGFzaCBzZXR0aW5nIGFib3ZlLgoJCQkJaWYgKCAhbm9FdmVudHMgKSB7CgkJCQkJdGhpcy5pZ25vcmVQb3BTdGF0ZSA9IHRydWU7CgkJCQkJJC5tb2JpbGUud2luZG93LnRyaWdnZXIoIHBvcHN0YXRlRXZlbnQgKTsKCQkJCX0KCQkJfQoKCQkJLy8gcmVjb3JkIHRoZSBoaXN0b3J5IGVudHJ5IHNvIHRoYXQgdGhlIGluZm9ybWF0aW9uIGNhbiBiZSBpbmNsdWRlZAoJCQkvLyBpbiBoYXNoY2hhbmdlIGV2ZW50IGRyaXZlbiBuYXZpZ2F0ZSBldmVudHMgaW4gYSBzaW1pbGFyIGZhc2hpb24gdG8KCQkJLy8gdGhlIHN0YXRlIHRoYXQncyBwcm92aWRlZCBieSBwb3BzdGF0ZQoJCQl0aGlzLmhpc3RvcnkuYWRkKCBzdGF0ZS51cmwsIHN0YXRlICk7CgkJfSwKCgoJCS8vIFRoaXMgYmluZGluZyBpcyBpbnRlbmRlZCB0byBjYXRjaCB0aGUgcG9wc3RhdGUgZXZlbnRzIHRoYXQgYXJlIGZpcmVkCgkJLy8gd2hlbiBleGVjdXRpb24gb2YgdGhlIGAkLm5hdmlnYXRlYCBtZXRob2Qgc3RvcHMgYXQgd2luZG93LmxvY2F0aW9uLmhhc2ggPSB1cmw7CgkJLy8gYW5kIGNvbXBsZXRlbHkgcHJldmVudCB0aGVtIGZyb20gcHJvcGFnYXRpbmcuIFRoZSBwb3BzdGF0ZSBldmVudCB3aWxsIHRoZW4gYmUKCQkvLyByZXRyaWdnZXJlZCBhZnRlciBleGVjdXRpb24gcmVzdW1lcwoJCS8vCgkJLy8gVE9ETyBncmFiIHRoZSBvcmlnaW5hbCBldmVudCBoZXJlIGFuZCB1c2UgaXQgZm9yIHRoZSBzeW50aGV0aWMgZXZlbnQgaW4gdGhlCgkJLy8gICAgICBzZWNvbmQgaGFsZiBvZiB0aGUgbmF2aWdhdGUgZXhlY3V0aW9uIHRoYXQgd2lsbCBmb2xsb3cgdGhpcyBiaW5kaW5nCgkJcG9wc3RhdGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGhhc2gsIHN0YXRlOwoKCQkJLy8gUGFydGx5IHRvIHN1cHBvcnQgb3VyIHRlc3Qgc3VpdGUgd2hpY2ggbWFudWFsbHkgYWx0ZXJzIHRoZSBzdXBwb3J0CgkJCS8vIHZhbHVlIHRvIHRlc3QgaGFzaGNoYW5nZS4gUGFydGx5IHRvIHByZXZlbnQgYWxsIGFyb3VuZCB3ZWlyZG5lc3MKCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICl7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIHRoaXMgaXMgdGhlIHBvcHN0YXRlIHRyaWdnZXJlZCBieSB0aGUgYWN0dWFsIGFsdGVyYXRpb24gb2YgdGhlIGhhc2gKCQkJLy8gcHJldmVudCBpdCBjb21wbGV0ZWx5LiBIaXN0b3J5IGlzIHRyYWNrZWQgbWFudWFsbHkKCQkJaWYgKCB0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgKSB7CgkJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBpZiB0aGlzIGlzIHRoZSBwb3BzdGF0ZSB0cmlnZ2VyZWQgYWZ0ZXIgdGhlIGByZXBsYWNlU3RhdGVgIGNhbGwgaW4gdGhlIGdvCgkJCS8vIG1ldGhvZCwgdGhlbiBzaW1wbHkgaWdub3JlIGl0LiBUaGUgaGlzdG9yeSBlbnRyeSBoYXMgYWxyZWFkeSBiZWVuIGNhcHR1cmVkCgkJCWlmICggdGhpcy5pZ25vcmVQb3BTdGF0ZSApIHsKCQkJCXRoaXMuaWdub3JlUG9wU3RhdGUgPSBmYWxzZTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gc3RhdGUsIGFuZCB0aGUgaGlzdG9yeSBzdGFjayBsZW5ndGggaXMgb25lIHdlcmUKCQkJLy8gcHJvYmFibHkgZ2V0dGluZyB0aGUgcGFnZSBsb2FkIHBvcHN0YXRlIGZpcmVkIGJ5IGJyb3dzZXJzIGxpa2UgY2hyb21lCgkJCS8vIGF2b2lkIGl0IGFuZCBzZXQgdGhlIG9uZSB0aW1lIGZsYWcgdG8gZmFsc2UuCgkJCS8vIFRPRE86IERvIHdlIHJlYWxseSBuZWVkIGFsbCB0aGVzZSBjb25kaXRpb25zPyBDb21wYXJpbmcgbG9jYXRpb24gaHJlZnMKCQkJLy8gc2hvdWxkIGJlIHN1ZmZpY2llbnQuCgkJCWlmICggIWV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgJiYKCQkJCXRoaXMuaGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDEgJiYKCQkJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgKSB7CgkJCQl0aGlzLmlnbm9yZUluaXRpYWxIYXNoQ2hhbmdlID0gZmFsc2U7CgoJCQkJaWYgKCBsb2NhdGlvbi5ocmVmID09PSBpbml0aWFsSHJlZiApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJLy8gYWNjb3VudCBmb3IgZGlyZWN0IG1hbmlwdWxhdGlvbiBvZiB0aGUgaGFzaC4gVGhhdCBpcywgd2Ugd2lsbCByZWNlaXZlIGEgcG9wc3RhdGUKCQkJLy8gd2hlbiB0aGUgaGFzaCBpcyBjaGFuZ2VkIGJ5IGFzc2lnbm1lbnQsIGFuZCBpdCB3b24ndCBoYXZlIGEgc3RhdGUgYXNzb2NpYXRlZC4gV2UKCQkJLy8gdGhlbiBuZWVkIHRvIHNxdWFzaCB0aGUgaGFzaC4gU2VlIGJlbG93IGZvciBoYW5kbGluZyBvZiBoYXNoIGFzc2lnbm1lbnQgdGhhdAoJCQkvLyBtYXRjaGVzIGFuIGV4aXN0aW5nIGhpc3RvcnkgZW50cnkKCQkJLy8gVE9ETyBpdCBtaWdodCBiZSBiZXR0ZXIgdG8gb25seSBhZGQgdG8gdGhlIGhpc3Rvcnkgc3RhY2sKCQkJLy8gICAgICB3aGVuIHRoZSBoYXNoIGlzIGFkamFjZW50IHRvIHRoZSBhY3RpdmUgaGlzdG9yeSBlbnRyeQoJCQloYXNoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQkJaWYgKCAhZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSAmJiBoYXNoICkgewoJCQkJLy8gc3F1YXNoIHRoZSBoYXNoIHRoYXQncyBiZWVuIGFzc2lnbmVkIG9uIHRoZSBVUkwgd2l0aCByZXBsYWNlU3RhdGUKCQkJCS8vIGFsc28gZ3JhYiB0aGUgcmVzdWx0aW5nIHN0YXRlIG9iamVjdCBmb3Igc3RvcmFnZQoJCQkJc3RhdGUgPSB0aGlzLnNxdWFzaCggaGFzaCApOwoKCQkJCS8vIHJlY29yZCB0aGUgbmV3IGhhc2ggYXMgYW4gYWRkaXRpb25hbCBoaXN0b3J5IGVudHJ5CgkJCQkvLyB0byBtYXRjaCB0aGUgYnJvd3NlcidzIHRyZWF0bWVudCBvZiBoYXNoIGFzc2lnbm1lbnQKCQkJCXRoaXMuaGlzdG9yeS5hZGQoIHN0YXRlLnVybCwgc3RhdGUgKTsKCgkJCQkvLyBwYXNzIHRoZSBuZXdseSBjcmVhdGVkIHN0YXRlIGluZm9ybWF0aW9uCgkJCQkvLyBhbG9uZyB3aXRoIHRoZSBldmVudAoJCQkJZXZlbnQuaGlzdG9yeVN0YXRlID0gc3RhdGU7CgoJCQkJLy8gZG8gbm90IGFsdGVyIGhpc3RvcnksIHdlJ3ZlIGFkZGVkIGEgbmV3IGhpc3RvcnkgZW50cnkKCQkJCS8vIHNvIHdlIGtub3cgd2hlcmUgd2UgYXJlCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIGFsbCBlbHNlIGZhaWxzIHRoaXMgaXMgYSBwb3BzdGF0ZSB0aGF0IGNvbWVzIGZyb20gdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b25zCgkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHN0YXRlIG9mIG91ciBoaXN0b3J5IHN0YWNrIHByb3Blcmx5LCBhbmQgcmVjb3JkIHRoZSBkaXJlY3Rpb25hbGl0eQoJCQl0aGlzLmhpc3RvcnkuZGlyZWN0KHsKCQkJCXVybDogKGV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgfHwge30pLnVybCB8fCBoYXNoLAoKCQkJCS8vIFdoZW4gdGhlIHVybCBpcyBlaXRoZXIgZm9yd2FyZCBvciBiYWNrd2FyZCBpbiBoaXN0b3J5IGluY2x1ZGUgdGhlIGVudHJ5CgkJCQkvLyBhcyBkYXRhIG9uIHRoZSBldmVudCBvYmplY3QgZm9yIG1lcmdpbmcgYXMgZGF0YSBpbiB0aGUgbmF2aWdhdGUgZXZlbnQKCQkJCXByZXNlbnQ6IGZ1bmN0aW9uKCBoaXN0b3J5RW50cnksIGRpcmVjdGlvbiApIHsKCQkJCQkvLyBtYWtlIHN1cmUgdG8gY3JlYXRlIGEgbmV3IG9iamVjdCB0byBwYXNzIGRvd24gYXMgdGhlIG5hdmlnYXRlIGV2ZW50IGRhdGEKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUgPSAkLmV4dGVuZCh7fSwgaGlzdG9yeUVudHJ5KTsKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUuZGlyZWN0aW9uID0gZGlyZWN0aW9uOwoJCQkJfQoJCQl9KTsKCQl9LAoKCQkvLyBOT1RFIG11c3QgYmluZCBiZWZvcmUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50IGhhc2hjaGFuZ2UgYmluZGluZyBvdGhlcndpc2UgdGhlCgkJLy8gICAgICBuYXZpZ2F0aW9uIGRhdGEgd29uJ3QgYmUgYXR0YWNoZWQgdG8gdGhlIGhhc2hjaGFuZ2UgZXZlbnQgaW4gdGltZSBmb3IgdGhvc2UKCQkvLyAgICAgIGJpbmRpbmdzIHRvIGF0dGFjaCBpdCB0byB0aGUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50CgkJLy8gVE9ETyBhZGQgYSBjaGVjayBoZXJlIHRoYXQgYGhhc2hjaGFuZ2UubmF2aWdhdGVgIGlzIGJvdW5kIGFscmVhZHkgb3RoZXJ3aXNlIGl0J3MKCQkvLyAgICAgIGJyb2tlbiAoZXhjZXB0aW9uPykKCQloYXNoY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBoaXN0b3J5LCBoYXNoOwoKCQkJLy8gSWYgaGFzaGNoYW5nZSBsaXN0ZW5pbmcgaXMgZXhwbGljaXRseSBkaXNhYmxlZCBvciBwdXNoc3RhdGUgaXMgc3VwcG9ydGVkCgkJCS8vIGF2b2lkIG1ha2luZyB1c2Ugb2YgdGhlIGhhc2hjaGFuZ2UgaGFuZGxlci4KCQkJaWYgKCEkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpIHx8CgkJCQkkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIE9uIG9jY2FzaW9uIGV4cGxpY2l0bHkgd2FudCB0byBwcmV2ZW50IHRoZSBuZXh0IGhhc2ggZnJvbSBwcm9wb2dhdGluZyBiZWNhdXNlIHdlIG9ubHkKCQkJLy8gd2l0aCB0byBhbHRlciB0aGUgdXJsIHRvIHJlcHJlc2VudCB0aGUgbmV3IHN0YXRlIGRvIHNvIGhlcmUKCQkJaWYgKCB0aGlzLnByZXZlbnROZXh0SGFzaENoYW5nZSApewoJCQkJdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgPSBmYWxzZTsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQloaXN0b3J5ID0gdGhpcy5oaXN0b3J5OwoJCQloYXNoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCgkJCS8vIElmIHRoaXMgaXMgYSBoYXNoY2hhbmdlIGNhdXNlZCBieSB0aGUgYmFjayBvciBmb3J3YXJkIGJ1dHRvbgoJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSBzdGF0ZSBvZiBvdXIgaGlzdG9yeSBzdGFjayBwcm9wZXJseQoJCQl0aGlzLmhpc3RvcnkuZGlyZWN0KHsKCQkJCXVybDogaGFzaCwKCgkJCQkvLyBXaGVuIHRoZSB1cmwgaXMgZWl0aGVyIGZvcndhcmQgb3IgYmFja3dhcmQgaW4gaGlzdG9yeSBpbmNsdWRlIHRoZSBlbnRyeQoJCQkJLy8gYXMgZGF0YSBvbiB0aGUgZXZlbnQgb2JqZWN0IGZvciBtZXJnaW5nIGFzIGRhdGEgaW4gdGhlIG5hdmlnYXRlIGV2ZW50CgkJCQlwcmVzZW50OiBmdW5jdGlvbiggaGlzdG9yeUVudHJ5LCBkaXJlY3Rpb24gKSB7CgkJCQkJLy8gbWFrZSBzdXJlIHRvIGNyZWF0ZSBhIG5ldyBvYmplY3QgdG8gcGFzcyBkb3duIGFzIHRoZSBuYXZpZ2F0ZSBldmVudCBkYXRhCgkJCQkJZXZlbnQuaGFzaGNoYW5nZVN0YXRlID0gJC5leHRlbmQoe30sIGhpc3RvcnlFbnRyeSk7CgkJCQkJZXZlbnQuaGFzaGNoYW5nZVN0YXRlLmRpcmVjdGlvbiA9IGRpcmVjdGlvbjsKCQkJCX0sCgoJCQkJLy8gV2hlbiB3ZSBkb24ndCBmaW5kIGEgaGFzaCBpbiBvdXIgaGlzdG9yeSBjbGVhcmx5IHdlJ3JlIGFpbWluZyB0byBnbyB0aGVyZQoJCQkJLy8gcmVjb3JkIHRoZSBlbnRyeSBhcyBuZXcgZm9yIGZ1dHVyZSB0cmF2ZXJzYWwKCQkJCS8vCgkJCQkvLyBOT1RFIGl0J3Mgbm90IGVudGlyZWx5IGNsZWFyIHRoYXQgdGhpcyBpcyB0aGUgcmlnaHQgdGhpbmcgdG8gZG8gZ2l2ZW4gdGhhdCB3ZQoJCQkJLy8gICAgICBjYW4ndCBrbm93IHRoZSB1c2VycyBpbnRlbnRpb24uIEl0IG1pZ2h0IGJlIGJldHRlciB0byBleHBsaWNpdGx5IF9ub3RfCgkJCQkvLyAgICAgIHN1cHBvcnQgbG9jYXRpb24uaGFzaCBhc3NpZ25tZW50IGluIHByZWZlcmVuY2UgdG8gJC5uYXZpZ2F0ZSBjYWxscwoJCQkJLy8gVE9ETyBmaXJzdCBhcmcgdG8gYWRkIHNob3VsZCBiZSB0aGUgaHJlZiwgYnV0IGl0IGNhdXNlcyBpc3N1ZXMgaW4gaWRlbnRpZnlpbmcKCQkJCS8vICAgICAgZW1iZWRlZCBwYWdlcwoJCQkJbWlzc2luZzogZnVuY3Rpb24oKSB7CgkJCQkJaGlzdG9yeS5hZGQoIGhhc2gsIHsKCQkJCQkJaGFzaDogaGFzaCwKCQkJCQkJdGl0bGU6IGRvY3VtZW50LnRpdGxlCgkJCQkJfSk7CgkJCQl9CgkJCX0pOwoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJLy8gVE9ETyBjb25zaWRlciBxdWV1ZWluZyBuYXZpZ2F0aW9uIGFjdGl2aXR5IHVudGlsIHByZXZpb3VzIGFjdGl2aXRpZXMgaGF2ZSBjb21wbGV0ZWQKCS8vICAgICAgc28gdGhhdCBlbmQgdXNlcnMgZG9uJ3QgaGF2ZSB0byB0aGluayBhYm91dCBpdC4gUHVudGluZyBmb3Igbm93CgkvLyBUT0RPICEhIG1vdmUgdGhlIGV2ZW50IGJpbmRpbmdzIGludG8gY2FsbGJhY2tzIG9uIHRoZSBuYXZpZ2F0ZSBldmVudAoJJC5tb2JpbGUubmF2aWdhdGUgPSBmdW5jdGlvbiggdXJsLCBkYXRhLCBub0V2ZW50cyApIHsKCQkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3IuZ28oIHVybCwgZGF0YSwgbm9FdmVudHMgKTsKCX07CgoJLy8gZXhwb3NlIHRoZSBoaXN0b3J5IG9uIHRoZSBuYXZpZ2F0ZSBtZXRob2QgaW4gYW50aWNpcGF0aW9uIG9mIGZ1bGwgaW50ZWdyYXRpb24gd2l0aAoJLy8gZXhpc3RpbmcgbmF2aWdhdGlvbiBmdW5jdGlvbmFsdHkgdGhhdCBpcyB0aWdodGx5IGNvdXBsZWQgdG8gdGhlIGhpc3RvcnkgaW5mb3JtYXRpb24KCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkgPSBuZXcgJC5tb2JpbGUuSGlzdG9yeSgpOwoKCS8vIGluc3RhbnRpYXRlIGFuIGluc3RhbmNlIG9mIHRoZSBuYXZpZ2F0b3IgZm9yIHVzZSB3aXRoaW4gdGhlICQubmF2aWdhdGUgbWV0aG9kCgkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3IgPSBuZXcgJC5tb2JpbGUuTmF2aWdhdG9yKCAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5ICk7CgoJdmFyIGxvYyA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpOwoJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hZGQoIGxvYy5ocmVmLCB7aGFzaDogbG9jLmhhc2h9ICk7Cn0pKCBqUXVlcnkgKTsKCgovLyBUaGlzIHBsdWdpbiBpcyBhbiBleHBlcmltZW50IGZvciBhYnN0cmFjdGluZyBhd2F5IHRoZSB0b3VjaCBhbmQgbW91c2UKLy8gZXZlbnRzIHNvIHRoYXQgZGV2ZWxvcGVycyBkb24ndCBoYXZlIHRvIHdvcnJ5IGFib3V0IHdoaWNoIG1ldGhvZCBvZiBpbnB1dAovLyB0aGUgZGV2aWNlIHRoZWlyIGRvY3VtZW50IGlzIGxvYWRlZCBvbiBzdXBwb3J0cy4KLy8KLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBhbGxvdyB0aGUgZGV2ZWxvcGVyIHRvIHJlZ2lzdGVyIGxpc3RlbmVycyBmb3IgdGhlCi8vIGJhc2ljIG1vdXNlIGV2ZW50cywgc3VjaCBhcyBtb3VzZWRvd24sIG1vdXNlbW92ZSwgbW91c2V1cCwgYW5kIGNsaWNrLAovLyBhbmQgdGhlIHBsdWdpbiB3aWxsIHRha2UgY2FyZSBvZiByZWdpc3RlcmluZyB0aGUgY29ycmVjdCBsaXN0ZW5lcnMKLy8gYmVoaW5kIHRoZSBzY2VuZXMgdG8gaW52b2tlIHRoZSBsaXN0ZW5lciBhdCB0aGUgZmFzdGVzdCBwb3NzaWJsZSB0aW1lCi8vIGZvciB0aGF0IGRldmljZSwgd2hpbGUgc3RpbGwgcmV0YWluaW5nIHRoZSBvcmRlciBvZiBldmVudCBmaXJpbmcgaW4KLy8gdGhlIHRyYWRpdGlvbmFsIG1vdXNlIGVudmlyb25tZW50LCBzaG91bGQgbXVsdGlwbGUgaGFuZGxlcnMgYmUgcmVnaXN0ZXJlZAovLyBvbiB0aGUgc2FtZSBlbGVtZW50IGZvciBkaWZmZXJlbnQgZXZlbnRzLgovLwovLyBUaGUgY3VycmVudCB2ZXJzaW9uIGV4cG9zZXMgdGhlIGZvbGxvd2luZyB2aXJ0dWFsIGV2ZW50cyB0byBqUXVlcnkgYmluZCBtZXRob2RzOgovLyAidm1vdXNlb3ZlciB2bW91c2Vkb3duIHZtb3VzZW1vdmUgdm1vdXNldXAgdmNsaWNrIHZtb3VzZW91dCB2bW91c2VjYW5jZWwiCgooZnVuY3Rpb24oICQsIHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCApIHsKCnZhciBkYXRhUHJvcGVydHlOYW1lID0gInZpcnR1YWxNb3VzZUJpbmRpbmdzIiwKCXRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lID0gInZpcnR1YWxUb3VjaElEIiwKCXZpcnR1YWxFdmVudE5hbWVzID0gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIi5zcGxpdCggIiAiICksCgl0b3VjaEV2ZW50UHJvcHMgPSAiY2xpZW50WCBjbGllbnRZIHBhZ2VYIHBhZ2VZIHNjcmVlblggc2NyZWVuWSIuc3BsaXQoICIgIiApLAoJbW91c2VIb29rUHJvcHMgPSAkLmV2ZW50Lm1vdXNlSG9va3MgPyAkLmV2ZW50Lm1vdXNlSG9va3MucHJvcHMgOiBbXSwKCW1vdXNlRXZlbnRQcm9wcyA9ICQuZXZlbnQucHJvcHMuY29uY2F0KCBtb3VzZUhvb2tQcm9wcyApLAoJYWN0aXZlRG9jSGFuZGxlcnMgPSB7fSwKCXJlc2V0VGltZXJJRCA9IDAsCglzdGFydFggPSAwLAoJc3RhcnRZID0gMCwKCWRpZFNjcm9sbCA9IGZhbHNlLAoJY2xpY2tCbG9ja0xpc3QgPSBbXSwKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlLAoJYmxvY2tUb3VjaFRyaWdnZXJzID0gZmFsc2UsCglldmVudENhcHR1cmVTdXBwb3J0ZWQgPSAiYWRkRXZlbnRMaXN0ZW5lciIgaW4gZG9jdW1lbnQsCgkkZG9jdW1lbnQgPSAkKCBkb2N1bWVudCApLAoJbmV4dFRvdWNoSUQgPSAxLAoJbGFzdFRvdWNoSUQgPSAwLCB0aHJlc2hvbGQsCglpOwoKJC52bW91c2UgPSB7Cgltb3ZlRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJY2xpY2tEaXN0YW5jZVRocmVzaG9sZDogMTAsCglyZXNldFRpbWVyRHVyYXRpb246IDE1MDAKfTsKCmZ1bmN0aW9uIGdldE5hdGl2ZUV2ZW50KCBldmVudCApIHsKCgl3aGlsZSAoIGV2ZW50ICYmIHR5cGVvZiBldmVudC5vcmlnaW5hbEV2ZW50ICE9PSAidW5kZWZpbmVkIiApIHsKCQlldmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7Cgl9CglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGNyZWF0ZVZpcnR1YWxFdmVudCggZXZlbnQsIGV2ZW50VHlwZSApIHsKCgl2YXIgdCA9IGV2ZW50LnR5cGUsCgkJb2UsIHByb3BzLCBuZSwgcHJvcCwgY3QsIHRvdWNoLCBpLCBqLCBsZW47CgoJZXZlbnQgPSAkLkV2ZW50KCBldmVudCApOwoJZXZlbnQudHlwZSA9IGV2ZW50VHlwZTsKCglvZSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7Cglwcm9wcyA9ICQuZXZlbnQucHJvcHM7CgoJLy8gYWRkcmVzc2VzIHNlcGFyYXRpb24gb2YgJC5ldmVudC5wcm9wcyBpbiB0byAkLmV2ZW50Lm1vdXNlSG9vay5wcm9wcyBhbmQgSXNzdWUgMzI4MAoJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zMjgwCglpZiAoIHQuc2VhcmNoKCAvXihtb3VzZXxjbGljaykvICkgPiAtMSApIHsKCQlwcm9wcyA9IG1vdXNlRXZlbnRQcm9wczsKCX0KCgkvLyBjb3B5IG9yaWdpbmFsIGV2ZW50IHByb3BlcnRpZXMgb3ZlciB0byB0aGUgbmV3IGV2ZW50CgkvLyB0aGlzIHdvdWxkIGhhcHBlbiBpZiB3ZSBjb3VsZCBjYWxsICQuZXZlbnQuZml4IGluc3RlYWQgb2YgJC5FdmVudAoJLy8gYnV0IHdlIGRvbid0IGhhdmUgYSB3YXkgdG8gZm9yY2UgYW4gZXZlbnQgdG8gYmUgZml4ZWQgbXVsdGlwbGUgdGltZXMKCWlmICggb2UgKSB7CgkJZm9yICggaSA9IHByb3BzLmxlbmd0aCwgcHJvcDsgaTsgKSB7CgkJCXByb3AgPSBwcm9wc1sgLS1pIF07CgkJCWV2ZW50WyBwcm9wIF0gPSBvZVsgcHJvcCBdOwoJCX0KCX0KCgkvLyBtYWtlIHN1cmUgdGhhdCBpZiB0aGUgbW91c2UgYW5kIGNsaWNrIHZpcnR1YWwgZXZlbnRzIGFyZSBnZW5lcmF0ZWQKCS8vIHdpdGhvdXQgYSAud2hpY2ggb25lIGlzIGRlZmluZWQKCWlmICggdC5zZWFyY2goL21vdXNlKGRvd258dXApfGNsaWNrLykgPiAtMSAmJiAhZXZlbnQud2hpY2ggKSB7CgkJZXZlbnQud2hpY2ggPSAxOwoJfQoKCWlmICggdC5zZWFyY2goL150b3VjaC8pICE9PSAtMSApIHsKCQluZSA9IGdldE5hdGl2ZUV2ZW50KCBvZSApOwoJCXQgPSBuZS50b3VjaGVzOwoJCWN0ID0gbmUuY2hhbmdlZFRvdWNoZXM7CgkJdG91Y2ggPSAoIHQgJiYgdC5sZW5ndGggKSA/IHRbMF0gOiAoICggY3QgJiYgY3QubGVuZ3RoICkgPyBjdFsgMCBdIDogdW5kZWZpbmVkICk7CgoJCWlmICggdG91Y2ggKSB7CgkJCWZvciAoIGogPSAwLCBsZW4gPSB0b3VjaEV2ZW50UHJvcHMubGVuZ3RoOyBqIDwgbGVuOyBqKyspIHsKCQkJCXByb3AgPSB0b3VjaEV2ZW50UHJvcHNbIGogXTsKCQkJCWV2ZW50WyBwcm9wIF0gPSB0b3VjaFsgcHJvcCBdOwoJCQl9CgkJfQoJfQoKCXJldHVybiBldmVudDsKfQoKZnVuY3Rpb24gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZWxlbWVudCApIHsKCgl2YXIgZmxhZ3MgPSB7fSwKCQliLCBrOwoKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlmb3IgKCAgayBpbiBiICkgewoJCQlpZiAoIGJbIGsgXSApIHsKCQkJCWZsYWdzWyBrIF0gPSBmbGFncy5oYXNWaXJ0dWFsQmluZGluZyA9IHRydWU7CgkJCX0KCQl9CgkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCX0KCXJldHVybiBmbGFnczsKfQoKZnVuY3Rpb24gZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGVsZW1lbnQsIGV2ZW50VHlwZSApIHsKCXZhciBiOwoJd2hpbGUgKCBlbGVtZW50ICkgewoKCQliID0gJC5kYXRhKCBlbGVtZW50LCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCWlmICggYiAmJiAoICFldmVudFR5cGUgfHwgYlsgZXZlbnRUeXBlIF0gKSApIHsKCQkJcmV0dXJuIGVsZW1lbnQ7CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gbnVsbDsKfQoKZnVuY3Rpb24gZW5hYmxlVG91Y2hCaW5kaW5ncygpIHsKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlOwp9CgpmdW5jdGlvbiBkaXNhYmxlVG91Y2hCaW5kaW5ncygpIHsKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IHRydWU7Cn0KCmZ1bmN0aW9uIGVuYWJsZU1vdXNlQmluZGluZ3MoKSB7CglsYXN0VG91Y2hJRCA9IDA7CgljbGlja0Jsb2NrTGlzdC5sZW5ndGggPSAwOwoJYmxvY2tNb3VzZVRyaWdnZXJzID0gZmFsc2U7CgoJLy8gV2hlbiBtb3VzZSBiaW5kaW5ncyBhcmUgZW5hYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZGlzYWJsZWQuCglkaXNhYmxlVG91Y2hCaW5kaW5ncygpOwp9CgpmdW5jdGlvbiBkaXNhYmxlTW91c2VCaW5kaW5ncygpIHsKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGRpc2FibGVkLCBvdXIKCS8vIHRvdWNoIGJpbmRpbmdzIGFyZSBlbmFibGVkLgoJZW5hYmxlVG91Y2hCaW5kaW5ncygpOwp9CgpmdW5jdGlvbiBzdGFydFJlc2V0VGltZXIoKSB7CgljbGVhclJlc2V0VGltZXIoKTsKCXJlc2V0VGltZXJJRCA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCXJlc2V0VGltZXJJRCA9IDA7CgkJZW5hYmxlTW91c2VCaW5kaW5ncygpOwoJfSwgJC52bW91c2UucmVzZXRUaW1lckR1cmF0aW9uICk7Cn0KCmZ1bmN0aW9uIGNsZWFyUmVzZXRUaW1lcigpIHsKCWlmICggcmVzZXRUaW1lcklEICkgewoJCWNsZWFyVGltZW91dCggcmVzZXRUaW1lcklEICk7CgkJcmVzZXRUaW1lcklEID0gMDsKCX0KfQoKZnVuY3Rpb24gdHJpZ2dlclZpcnR1YWxFdmVudCggZXZlbnRUeXBlLCBldmVudCwgZmxhZ3MgKSB7Cgl2YXIgdmU7CgoJaWYgKCAoIGZsYWdzICYmIGZsYWdzWyBldmVudFR5cGUgXSApIHx8CgkJCQkoICFmbGFncyAmJiBnZXRDbG9zZXN0RWxlbWVudFdpdGhWaXJ0dWFsQmluZGluZyggZXZlbnQudGFyZ2V0LCBldmVudFR5cGUgKSApICkgewoKCQl2ZSA9IGNyZWF0ZVZpcnR1YWxFdmVudCggZXZlbnQsIGV2ZW50VHlwZSApOwoKCQkkKCBldmVudC50YXJnZXQpLnRyaWdnZXIoIHZlICk7Cgl9CgoJcmV0dXJuIHZlOwp9CgpmdW5jdGlvbiBtb3VzZUV2ZW50Q2FsbGJhY2soIGV2ZW50ICkgewoJdmFyIHRvdWNoSUQgPSAkLmRhdGEoIGV2ZW50LnRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgKSwKCQl2ZTsKCglpZiAoICFibG9ja01vdXNlVHJpZ2dlcnMgJiYgKCAhbGFzdFRvdWNoSUQgfHwgbGFzdFRvdWNoSUQgIT09IHRvdWNoSUQgKSApIHsKCQl2ZSA9IHRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2IiArIGV2ZW50LnR5cGUsIGV2ZW50ICk7CgkJaWYgKCB2ZSApIHsKCQkJaWYgKCB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQkJaWYgKCB2ZS5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCX0KCQkJaWYgKCB2ZS5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCX0KCQl9Cgl9Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoU3RhcnQoIGV2ZW50ICkgewoKCXZhciB0b3VjaGVzID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlcywKCQl0YXJnZXQsIGZsYWdzLCB0OwoKCWlmICggdG91Y2hlcyAmJiB0b3VjaGVzLmxlbmd0aCA9PT0gMSApIHsKCgkJdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwoJCWZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggdGFyZ2V0ICk7CgoJCWlmICggZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgKSB7CgoJCQlsYXN0VG91Y2hJRCA9IG5leHRUb3VjaElEKys7CgkJCSQuZGF0YSggdGFyZ2V0LCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSwgbGFzdFRvdWNoSUQgKTsKCgkJCWNsZWFyUmVzZXRUaW1lcigpOwoKCQkJZGlzYWJsZU1vdXNlQmluZGluZ3MoKTsKCQkJZGlkU2Nyb2xsID0gZmFsc2U7CgoJCQl0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdOwoJCQlzdGFydFggPSB0LnBhZ2VYOwoJCQlzdGFydFkgPSB0LnBhZ2VZOwoKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW92ZXIiLCBldmVudCwgZmxhZ3MgKTsKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWRvd24iLCBldmVudCwgZmxhZ3MgKTsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIGhhbmRsZVNjcm9sbCggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJaWYgKCAhZGlkU2Nyb2xsICkgewoJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VjYW5jZWwiLCBldmVudCwgZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICkgKTsKCX0KCglkaWRTY3JvbGwgPSB0cnVlOwoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoTW92ZSggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzWyAwIF0sCgkJZGlkQ2FuY2VsID0gZGlkU2Nyb2xsLAoJCW1vdmVUaHJlc2hvbGQgPSAkLnZtb3VzZS5tb3ZlRGlzdGFuY2VUaHJlc2hvbGQsCgkJZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKTsKCgkJZGlkU2Nyb2xsID0gZGlkU2Nyb2xsIHx8CgkJCSggTWF0aC5hYnMoIHQucGFnZVggLSBzdGFydFggKSA+IG1vdmVUaHJlc2hvbGQgfHwKCQkJCU1hdGguYWJzKCB0LnBhZ2VZIC0gc3RhcnRZICkgPiBtb3ZlVGhyZXNob2xkICk7CgoKCWlmICggZGlkU2Nyb2xsICYmICFkaWRDYW5jZWwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBmbGFncyApOwoJfQoKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vtb3ZlIiwgZXZlbnQsIGZsYWdzICk7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7CgoJdmFyIGZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICksCgkJdmUsIHQ7Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNldXAiLCBldmVudCwgZmxhZ3MgKTsKCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidmNsaWNrIiwgZXZlbnQsIGZsYWdzICk7CgkJaWYgKCB2ZSAmJiB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJLy8gVGhlIHRhcmdldCBvZiB0aGUgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IHRoZSB0b3VjaGVuZAoJCQkvLyBldmVudCBkb24ndCBuZWNlc3NhcmlseSBtYXRjaCB0aGUgdGFyZ2V0IHVzZWQgZHVyaW5nIHRoZQoJCQkvLyB0b3VjaC4gVGhpcyBtZWFucyB3ZSBuZWVkIHRvIHJlbHkgb24gY29vcmRpbmF0ZXMgZm9yIGJsb2NraW5nCgkJCS8vIGFueSBjbGljayB0aGF0IGlzIGdlbmVyYXRlZC4KCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLmNoYW5nZWRUb3VjaGVzWyAwIF07CgkJCWNsaWNrQmxvY2tMaXN0LnB1c2goewoJCQkJdG91Y2hJRDogbGFzdFRvdWNoSUQsCgkJCQl4OiB0LmNsaWVudFgsCgkJCQl5OiB0LmNsaWVudFkKCQkJfSk7CgoJCQkvLyBQcmV2ZW50IGFueSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgZnJvbSB0cmlnZ2VyaW5nCgkJCS8vIHZpcnR1YWwgZXZlbnQgbm90aWZpY2F0aW9ucy4KCQkJYmxvY2tNb3VzZVRyaWdnZXJzID0gdHJ1ZTsKCQl9Cgl9Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3V0IiwgZXZlbnQsIGZsYWdzKTsKCWRpZFNjcm9sbCA9IGZhbHNlOwoKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYXNWaXJ0dWFsQmluZGluZ3MoIGVsZSApIHsKCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggZWxlLCBkYXRhUHJvcGVydHlOYW1lICksCgkJazsKCglpZiAoIGJpbmRpbmdzICkgewoJCWZvciAoIGsgaW4gYmluZGluZ3MgKSB7CgkJCWlmICggYmluZGluZ3NbIGsgXSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoJfQoJcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBkdW1teU1vdXNlSGFuZGxlcigpIHt9CgpmdW5jdGlvbiBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIGV2ZW50VHlwZSApIHsKCXZhciByZWFsVHlwZSA9IGV2ZW50VHlwZS5zdWJzdHIoIDEgKTsKCglyZXR1cm4gewoJCXNldHVwOiBmdW5jdGlvbigvKiBkYXRhLCBuYW1lc3BhY2UgKi8pIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGZvciB0aGlzIGVsZW1lbnQsCgkJCS8vIGFkZCBhIGJpbmRpbmdzIG9iamVjdCB0byBpdHMgZGF0YS4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lLCB7fSApOwoJCQl9CgoJCQkvLyBJZiBzZXR1cCBpcyBjYWxsZWQsIHdlIGtub3cgaXQgaXMgdGhlIGZpcnN0IGJpbmRpbmcgZm9yIHRoaXMKCQkJLy8gZXZlbnRUeXBlLCBzbyBpbml0aWFsaXplIHRoZSBjb3VudCBmb3IgdGhlIGV2ZW50VHlwZSB0byB6ZXJvLgoJCQl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gdHJ1ZTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgZXZlbnQgZm9yIHRoaXMgdHlwZSwKCQkJLy8gcmVnaXN0ZXIgYSBnbG9iYWwgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQlhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSB8fCAwICkgKyAxOwoKCQkJaWYgKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPT09IDEgKSB7CgkJCQkkZG9jdW1lbnQuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQkvLyBTb21lIGJyb3dzZXJzLCBsaWtlIE9wZXJhIE1pbmksIHdvbid0IGRpc3BhdGNoIG1vdXNlL2NsaWNrIGV2ZW50cwoJCQkvLyBmb3IgZWxlbWVudHMgdW5sZXNzIHRoZXkgYWN0dWFsbHkgaGF2ZSBoYW5kbGVycyByZWdpc3RlcmVkIG9uIHRoZW0uCgkJCS8vIFRvIGdldCBhcm91bmQgdGhpcywgd2UgcmVnaXN0ZXIgZHVtbXkgaGFuZGxlcnMgb24gdGhlIGVsZW1lbnRzLgoKCQkJJCggdGhpcyApLmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gRm9yIG5vdywgaWYgZXZlbnQgY2FwdHVyZSBpcyBub3Qgc3VwcG9ydGVkLCB3ZSByZWx5IG9uIG1vdXNlIGhhbmRsZXJzLgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhlIGRvY3VtZW50LAoJCQkJLy8gcmVnaXN0ZXIgb3VyIHRvdWNoc3RhcnQgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQkJYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gfHwgMCkgKyAxOwoKCQkJCWlmICggYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID09PSAxICkgewoJCQkJCSRkb2N1bWVudC5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoKCQkJCQkJLy8gT24gdG91Y2ggcGxhdGZvcm1zLCB0b3VjaGluZyB0aGUgc2NyZWVuIGFuZCB0aGVuIGRyYWdnaW5nIHlvdXIgZmluZ2VyCgkJCQkJCS8vIGNhdXNlcyB0aGUgd2luZG93IGNvbnRlbnQgdG8gc2Nyb2xsIGFmdGVyIHNvbWUgZGlzdGFuY2UgdGhyZXNob2xkIGlzCgkJCQkJCS8vIGV4Y2VlZGVkLiBPbiB0aGVzZSBwbGF0Zm9ybXMsIGEgc2Nyb2xsIHByZXZlbnRzIGEgY2xpY2sgZXZlbnQgZnJvbSBiZWluZwoJCQkJCQkvLyBkaXNwYXRjaGVkLCBhbmQgb24gc29tZSBwbGF0Zm9ybXMsIGV2ZW4gdGhlIHRvdWNoZW5kIGlzIHN1cHByZXNzZWQuIFRvCgkJCQkJCS8vIG1pbWljIHRoZSBzdXBwcmVzc2lvbiBvZiB0aGUgY2xpY2sgZXZlbnQsIHdlIG5lZWQgdG8gd2F0Y2ggZm9yIGEgc2Nyb2xsCgkJCQkJCS8vIGV2ZW50LiBVbmZvcnR1bmF0ZWx5LCBzb21lIHBsYXRmb3JtcyBsaWtlIGlPUyBkb24ndCBkaXNwYXRjaCBzY3JvbGwKCQkJCQkJLy8gZXZlbnRzIHVudGlsICpBRlRFUiogdGhlIHVzZXIgbGlmdHMgdGhlaXIgZmluZ2VyICh0b3VjaGVuZCkuIFRoaXMgbWVhbnMKCQkJCQkJLy8gd2UgbmVlZCB0byB3YXRjaCBib3RoIHNjcm9sbCBhbmQgdG91Y2htb3ZlIGV2ZW50cyB0byBmaWd1cmUgb3V0IHdoZXRoZXIKCQkJCQkJLy8gb3Igbm90IGEgc2Nyb2xsIGhhcHBlbmVucyBiZWZvcmUgdGhlIHRvdWNoZW5kIGV2ZW50IGlzIGZpcmVkLgoKCQkJCQkJLmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkuYmluZCggInNjcm9sbCIsIGhhbmRsZVNjcm9sbCApOwoJCQkJfQoJCQl9CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKC8qIGRhdGEsIG5hbWVzcGFjZSAqLykgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgYmluZGluZyBmb3IgdGhpcyBldmVudFR5cGUsCgkJCS8vIHJlbW92ZSBpdHMgZ2xvYmFsIGhhbmRsZXIgZnJvbSB0aGUgZG9jdW1lbnQuCgoJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXTsKCgkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSApIHsKCQkJCSRkb2N1bWVudC51bmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBpbiBleGlzdGVuY2UsCgkJCQkvLyByZW1vdmUgb3VyIGRvY3VtZW50IHRvdWNoc3RhcnQgbGlzdGVuZXIuCgoJCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF07CgoJCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdICkgewoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS51bmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkudW5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgkJCQkJCS51bmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJCS8vIHRlYXJkb3duIG1heSBiZSBjYWxsZWQgd2hlbiBhbiBlbGVtZW50IHdhcwoJCQkvLyByZW1vdmVkIGZyb20gdGhlIERPTS4gSWYgdGhpcyBpcyB0aGUgY2FzZSwKCQkJLy8galF1ZXJ5IGNvcmUgbWF5IGhhdmUgYWxyZWFkeSBzdHJpcHBlZCB0aGUgZWxlbWVudAoJCQkvLyBvZiBhbnkgZGF0YSBiaW5kaW5ncyBzbyB3ZSBuZWVkIHRvIGNoZWNrIGl0IGJlZm9yZQoJCQkvLyB1c2luZyBpdC4KCQkJaWYgKCBiaW5kaW5ncyApIHsKCQkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IGZhbHNlOwoJCQl9CgoJCQkvLyBVbnJlZ2lzdGVyIHRoZSBkdW1teSBldmVudCBoYW5kbGVyLgoKCQkJJHRoaXMudW5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIG9uIHRoZQoJCQkvLyBlbGVtZW50LCByZW1vdmUgdGhlIGJpbmRpbmcgZGF0YSBmcm9tIHRoZSBlbGVtZW50LgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkdGhpcy5yZW1vdmVEYXRhKCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCX0KCQl9Cgl9Owp9CgovLyBFeHBvc2Ugb3VyIGN1c3RvbSBldmVudHMgdG8gdGhlIGpRdWVyeSBiaW5kL3VuYmluZCBtZWNoYW5pc20uCgpmb3IgKCBpID0gMDsgaSA8IHZpcnR1YWxFdmVudE5hbWVzLmxlbmd0aDsgaSsrICkgewoJJC5ldmVudC5zcGVjaWFsWyB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdIF0gPSBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gKTsKfQoKLy8gQWRkIGEgY2FwdHVyZSBjbGljayBoYW5kbGVyIHRvIGJsb2NrIGNsaWNrcy4KLy8gTm90ZSB0aGF0IHdlIHJlcXVpcmUgZXZlbnQgY2FwdHVyZSBzdXBwb3J0IGZvciB0aGlzIHNvIGlmIHRoZSBkZXZpY2UKLy8gZG9lc24ndCBzdXBwb3J0IGl0LCB3ZSBwdW50IGZvciBub3cgYW5kIHJlbHkgc29sZWx5IG9uIG1vdXNlIGV2ZW50cy4KaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7Cglkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQl2YXIgY250ID0gY2xpY2tCbG9ja0xpc3QubGVuZ3RoLAoJCQl0YXJnZXQgPSBlLnRhcmdldCwKCQkJeCwgeSwgZWxlLCBpLCBvLCB0b3VjaElEOwoKCQlpZiAoIGNudCApIHsKCQkJeCA9IGUuY2xpZW50WDsKCQkJeSA9IGUuY2xpZW50WTsKCQkJdGhyZXNob2xkID0gJC52bW91c2UuY2xpY2tEaXN0YW5jZVRocmVzaG9sZDsKCgkJCS8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gcnVuIHRocm91Z2ggdGhlIGNsaWNrQmxvY2tMaXN0IHRvIHNlZSBpZgoJCQkvLyB0aGUgY3VycmVudCBjbGljayBldmVudCBpcyBpbiB0aGUgcHJveGltaXR5IG9mIG9uZSBvZiBvdXIKCQkJLy8gdmNsaWNrIGV2ZW50cyB0aGF0IGhhZCBwcmV2ZW50RGVmYXVsdCgpIGNhbGxlZCBvbiBpdC4gSWYgd2UgZmluZAoJCQkvLyBvbmUsIHRoZW4gd2UgYmxvY2sgdGhlIGNsaWNrLgoJCQkvLwoJCQkvLyBXaHkgZG8gd2UgaGF2ZSB0byByZWx5IG9uIHByb3hpbWl0eT8KCQkJLy8KCQkJLy8gQmVjYXVzZSB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaCBldmVudCB0aGF0IHRyaWdnZXJlZCB0aGUgdmNsaWNrCgkJCS8vIGNhbiBiZSBkaWZmZXJlbnQgZnJvbSB0aGUgdGFyZ2V0IG9mIHRoZSBjbGljayBldmVudCBzeW50aGVzaXplZAoJCQkvLyBieSB0aGUgYnJvd3Nlci4gVGhlIHRhcmdldCBvZiBhIG1vdXNlL2NsaWNrIGV2ZW50IHRoYXQgaXMgc3ludGVoc2l6ZWQKCQkJLy8gZnJvbSBhIHRvdWNoIGV2ZW50IHNlZW1zIHRvIGJlIGltcGxlbWVudGF0aW9uIHNwZWNpZmljLiBGb3IgZXhhbXBsZSwKCQkJLy8gc29tZSBicm93c2VycyB3aWxsIGZpcmUgbW91c2UvY2xpY2sgZXZlbnRzIGZvciBhIGxpbmsgdGhhdCBpcyBuZWFyCgkJCS8vIGEgdG91Y2ggZXZlbnQsIGV2ZW4gdGhvdWdoIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoc3RhcnQvdG91Y2hlbmQgZXZlbnQKCQkJLy8gc2F5cyB0aGUgdXNlciB0b3VjaGVkIG91dHNpZGUgdGhlIGxpbmsuIEFsc28sIGl0IHNlZW1zIHRoYXQgd2l0aCBtb3N0CgkJCS8vIGJyb3dzZXJzLCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayBldmVudCBpcyBub3QgY2FsY3VsYXRlZCB1bnRpbCB0aGUKCQkJLy8gdGltZSBpdCBpcyBkaXNwYXRjaGVkLCBzbyBpZiB5b3UgcmVwbGFjZSBhbiBlbGVtZW50IHRoYXQgeW91IHRvdWNoZWQKCQkJLy8gd2l0aCBhbm90aGVyIGVsZW1lbnQsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIHdpbGwgYmUgdGhlIG5ldwoJCQkvLyBlbGVtZW50IHVuZGVybmVhdGggdGhhdCBwb2ludC4KCQkJLy8KCQkJLy8gQXNpZGUgZnJvbSBwcm94aW1pdHksIHdlIGFsc28gY2hlY2sgdG8gc2VlIGlmIHRoZSB0YXJnZXQgYW5kIGFueQoJCQkvLyBvZiBpdHMgYW5jZXN0b3JzIHdlcmUgdGhlIG9uZXMgdGhhdCBibG9ja2VkIGEgY2xpY2suIFRoaXMgaXMgbmVjZXNzYXJ5CgkJCS8vIGJlY2F1c2Ugb2YgdGhlIHN0cmFuZ2UgbW91c2UvY2xpY2sgdGFyZ2V0IGNhbGN1bGF0aW9uIGRvbmUgaW4gdGhlCgkJCS8vIEFuZHJvaWQgMi4xIGJyb3dzZXIsIHdoZXJlIGlmIHlvdSBjbGljayBvbiBhbiBlbGVtZW50LCBhbmQgdGhlcmUgaXMgYQoJCQkvLyBtb3VzZS9jbGljayBoYW5kbGVyIG9uIG9uZSBvZiBpdHMgYW5jZXN0b3JzLCB0aGUgdGFyZ2V0IHdpbGwgYmUgdGhlCgkJCS8vIGlubmVybW9zdCBjaGlsZCBvZiB0aGUgdG91Y2hlZCBlbGVtZW50LCBldmVuIGlmIHRoYXQgY2hpbGQgaXMgbm8gd2hlcmUKCQkJLy8gbmVhciB0aGUgcG9pbnQgb2YgdG91Y2guCgoJCQllbGUgPSB0YXJnZXQ7CgoJCQl3aGlsZSAoIGVsZSApIHsKCQkJCWZvciAoIGkgPSAwOyBpIDwgY250OyBpKysgKSB7CgkJCQkJbyA9IGNsaWNrQmxvY2tMaXN0WyBpIF07CgkJCQkJdG91Y2hJRCA9IDA7CgoJCQkJCWlmICggKCBlbGUgPT09IHRhcmdldCAmJiBNYXRoLmFicyggby54IC0geCApIDwgdGhyZXNob2xkICYmIE1hdGguYWJzKCBvLnkgLSB5ICkgPCB0aHJlc2hvbGQgKSB8fAoJCQkJCQkJCSQuZGF0YSggZWxlLCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSApID09PSBvLnRvdWNoSUQgKSB7CgkJCQkJCS8vIFhYWDogV2UgbWF5IHdhbnQgdG8gY29uc2lkZXIgcmVtb3ZpbmcgbWF0Y2hlcyBmcm9tIHRoZSBibG9jayBsaXN0CgkJCQkJCS8vICAgICAgaW5zdGVhZCBvZiB3YWl0aW5nIGZvciB0aGUgcmVzZXQgdGltZXIgdG8gZmlyZS4KCQkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJfQoJCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJCX0KCQl9Cgl9LCB0cnVlKTsKfQp9KSggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhciAkZG9jdW1lbnQgPSAkKCBkb2N1bWVudCApLAoJCXN1cHBvcnRUb3VjaCA9ICQubW9iaWxlLnN1cHBvcnQudG91Y2gsCgkJc2Nyb2xsRXZlbnQgPSAidG91Y2htb3ZlIHNjcm9sbCIsCgkJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgkJdG91Y2hTdG9wRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hlbmQiIDogIm1vdXNldXAiLAoJCXRvdWNoTW92ZUV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNobW92ZSIgOiAibW91c2Vtb3ZlIjsKCgkvLyBzZXR1cCBuZXcgZXZlbnQgc2hvcnRjdXRzCgkkLmVhY2goICggInRvdWNoc3RhcnQgdG91Y2htb3ZlIHRvdWNoZW5kICIgKwoJCSJ0YXAgdGFwaG9sZCAiICsKCQkic3dpcGUgc3dpcGVsZWZ0IHN3aXBlcmlnaHQgIiArCgkJInNjcm9sbHN0YXJ0IHNjcm9sbHN0b3AiICkuc3BsaXQoICIgIiApLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgkJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCQlyZXR1cm4gZm4gPyB0aGlzLmJpbmQoIG5hbWUsIGZuICkgOiB0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCQl9OwoKCQkvLyBqUXVlcnkgPCAxLjgKCQlpZiAoICQuYXR0ckZuICkgewoJCQkkLmF0dHJGblsgbmFtZSBdID0gdHJ1ZTsKCQl9Cgl9KTsKCglmdW5jdGlvbiB0cmlnZ2VyQ3VzdG9tRXZlbnQoIG9iaiwgZXZlbnRUeXBlLCBldmVudCApIHsKCQl2YXIgb3JpZ2luYWxUeXBlID0gZXZlbnQudHlwZTsKCQlldmVudC50eXBlID0gZXZlbnRUeXBlOwoJCSQuZXZlbnQuZGlzcGF0Y2guY2FsbCggb2JqLCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSBvcmlnaW5hbFR5cGU7Cgl9CgoJLy8gYWxzbyBoYW5kbGVzIHNjcm9sbHN0b3AKCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydCA9IHsKCgkJZW5hYmxlZDogdHJ1ZSwKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKSwKCQkJCXNjcm9sbGluZywKCQkJCXRpbWVyOwoKCQkJZnVuY3Rpb24gdHJpZ2dlciggZXZlbnQsIHN0YXRlICkgewoJCQkJc2Nyb2xsaW5nID0gc3RhdGU7CgkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsIHNjcm9sbGluZyA/ICJzY3JvbGxzdGFydCIgOiAic2Nyb2xsc3RvcCIsIGV2ZW50ICk7CgkJCX0KCgkJCS8vIGlQaG9uZSB0cmlnZ2VycyBzY3JvbGwgYWZ0ZXIgYSBzbWFsbCBkZWxheTsgdXNlIHRvdWNobW92ZSBpbnN0ZWFkCgkJCSR0aGlzLmJpbmQoIHNjcm9sbEV2ZW50LCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICggIXNjcm9sbGluZyApIHsKCQkJCQl0cmlnZ2VyKCBldmVudCwgdHJ1ZSApOwoJCQkJfQoKCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCXRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlciggZXZlbnQsIGZhbHNlICk7CgkJCQl9LCA1MCApOwoJCQl9KTsKCQl9LAoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJJCggdGhpcyApLnVuYmluZCggc2Nyb2xsRXZlbnQgKTsKCQl9Cgl9OwoKCS8vIGFsc28gaGFuZGxlcyB0YXBob2xkCgkkLmV2ZW50LnNwZWNpYWwudGFwID0gewoJCXRhcGhvbGRUaHJlc2hvbGQ6IDc1MCwKCQllbWl0VGFwT25UYXBob2xkOiB0cnVlLAoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICksCgkJCQlpc1RhcGhvbGQgPSBmYWxzZTsKCgkJCSR0aGlzLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaXNUYXBob2xkID0gZmFsc2U7CgkJCQlpZiAoIGV2ZW50LndoaWNoICYmIGV2ZW50LndoaWNoICE9PSAxICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQl2YXIgb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQl0aW1lcjsKCgkJCQlmdW5jdGlvbiBjbGVhclRhcFRpbWVyKCkgewoJCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCX0KCgkJCQlmdW5jdGlvbiBjbGVhclRhcEhhbmRsZXJzKCkgewoJCQkJCWNsZWFyVGFwVGltZXIoKTsKCgkJCQkJJHRoaXMudW5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICkKCQkJCQkJLnVuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApOwoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgkJCQl9CgoJCQkJZnVuY3Rpb24gY2xpY2tIYW5kbGVyKCBldmVudCApIHsKCQkJCQljbGVhclRhcEhhbmRsZXJzKCk7CgoJCQkJCS8vIE9OTFkgdHJpZ2dlciBhICd0YXAnIGV2ZW50IGlmIHRoZSBzdGFydCB0YXJnZXQgaXMKCQkJCQkvLyB0aGUgc2FtZSBhcyB0aGUgc3RvcCB0YXJnZXQuCgkJCQkJaWYgKCAhaXNUYXBob2xkICYmIG9yaWdUYXJnZXQgPT09IGV2ZW50LnRhcmdldCApIHsKCQkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwIiwgZXZlbnQgKTsKCQkJCQl9IGVsc2UgaWYgKCBpc1RhcGhvbGQgKSB7CgkJCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCX0KCQkJCX0KCgkJCQkkdGhpcy5iaW5kKCAidm1vdXNldXAiLCBjbGVhclRhcFRpbWVyICkKCQkJCQkuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApOwoJCQkJJGRvY3VtZW50LmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgoJCQkJdGltZXIgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQlpZiAoICEkLmV2ZW50LnNwZWNpYWwudGFwLmVtaXRUYXBPblRhcGhvbGQgKSB7CgkJCQkJCWlzVGFwaG9sZCA9IHRydWU7CgkJCQkJfQoJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcGhvbGQiLCAkLkV2ZW50KCAidGFwaG9sZCIsIHsgdGFyZ2V0OiBvcmlnVGFyZ2V0IH0gKSApOwoJCQkJfSwgJC5ldmVudC5zcGVjaWFsLnRhcC50YXBob2xkVGhyZXNob2xkICk7CgkJCX0pOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkudW5iaW5kKCAidm1vdXNlZG93biIgKS51bmJpbmQoICJ2Y2xpY2siICkudW5iaW5kKCAidm1vdXNldXAiICk7CgkJCSRkb2N1bWVudC51bmJpbmQoICJ2bW91c2VjYW5jZWwiICk7CgkJfQoJfTsKCgkvLyBhbHNvIGhhbmRsZXMgc3dpcGVsZWZ0LCBzd2lwZXJpZ2h0CgkkLmV2ZW50LnNwZWNpYWwuc3dpcGUgPSB7CgkJc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZDogMzAsIC8vIE1vcmUgdGhhbiB0aGlzIGhvcml6b250YWwgZGlzcGxhY2VtZW50LCBhbmQgd2Ugd2lsbCBzdXBwcmVzcyBzY3JvbGxpbmcuCgoJCWR1cmF0aW9uVGhyZXNob2xkOiAxMDAwLCAvLyBNb3JlIHRpbWUgdGhhbiB0aGlzLCBhbmQgaXQgaXNuJ3QgYSBzd2lwZS4KCgkJaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkOiAxMCwgIC8vIFN3aXBlIGhvcml6b250YWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbW9yZSB0aGFuIHRoaXMuCgoJCXZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQ6IDc1LCAgLy8gU3dpcGUgdmVydGljYWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbGVzcyB0aGFuIHRoaXMuCgoJCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50OwoJCQlyZXR1cm4gewoJCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJCWNvb3JkczogWyBkYXRhLnBhZ2VYLCBkYXRhLnBhZ2VZIF0sCgkJCQkJCW9yaWdpbjogJCggZXZlbnQudGFyZ2V0ICkKCQkJCQl9OwoJCX0sCgoJCXN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGRhdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgPwoJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1sgMCBdIDogZXZlbnQ7CgkJCXJldHVybiB7CgkJCQkJCXRpbWU6ICggbmV3IERhdGUoKSApLmdldFRpbWUoKSwKCQkJCQkJY29vcmRzOiBbIGRhdGEucGFnZVgsIGRhdGEucGFnZVkgXQoJCQkJCX07CgkJfSwKCgkJaGFuZGxlU3dpcGU6IGZ1bmN0aW9uKCBzdGFydCwgc3RvcCwgdGhpc09iamVjdCwgb3JpZ1RhcmdldCApIHsKCQkJaWYgKCBzdG9wLnRpbWUgLSBzdGFydC50aW1lIDwgJC5ldmVudC5zcGVjaWFsLnN3aXBlLmR1cmF0aW9uVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAwIF0gLSBzdG9wLmNvb3Jkc1sgMCBdICkgPiAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAxIF0gLSBzdG9wLmNvb3Jkc1sgMSBdICkgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUudmVydGljYWxEaXN0YW5jZVRocmVzaG9sZCApIHsKCQkJCXZhciBkaXJlY3Rpb24gPSBzdGFydC5jb29yZHNbMF0gPiBzdG9wLmNvb3Jkc1sgMCBdID8gInN3aXBlbGVmdCIgOiAic3dpcGVyaWdodCI7CgoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAic3dpcGUiLCAkLkV2ZW50KCAic3dpcGUiLCB7IHRhcmdldDogb3JpZ1RhcmdldCwgc3dpcGVzdGFydDogc3RhcnQsIHN3aXBlc3RvcDogc3RvcCB9KSApOwoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCBkaXJlY3Rpb24sJC5FdmVudCggZGlyZWN0aW9uLCB7IHRhcmdldDogb3JpZ1RhcmdldCwgc3dpcGVzdGFydDogc3RhcnQsIHN3aXBlc3RvcDogc3RvcCB9ICkgKTsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJCXJldHVybiBmYWxzZTsKCgkJfSwKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKTsKCgkJCSR0aGlzLmJpbmQoIHRvdWNoU3RhcnRFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdmFyIHN0b3AsCgkJCQkJc3RhcnQgPSAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuc3RhcnQoIGV2ZW50ICksCgkJCQkJb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQllbWl0dGVkID0gZmFsc2U7CgoJCQkJZnVuY3Rpb24gbW92ZUhhbmRsZXIoIGV2ZW50ICkgewoJCQkJCWlmICggIXN0YXJ0ICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQlzdG9wID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnN0b3AoIGV2ZW50ICk7CgkJCQkJaWYgKCAhZW1pdHRlZCApewoJCQkJCQllbWl0dGVkID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLmhhbmRsZVN3aXBlKCBzdGFydCwgc3RvcCwgdGhpc09iamVjdCwgb3JpZ1RhcmdldCApOwoJCQkJCX0KCQkJCQkvLyBwcmV2ZW50IHNjcm9sbGluZwoJCQkJCWlmICggTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMCBdIC0gc3RvcC5jb29yZHNbIDAgXSApID4gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnNjcm9sbFN1cHJlc3Npb25UaHJlc2hvbGQgKSB7CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfQoJCQkJfQoKCQkJCSR0aGlzLmJpbmQoIHRvdWNoTW92ZUV2ZW50LCBtb3ZlSGFuZGxlciApCgkJCQkJLm9uZSggdG91Y2hTdG9wRXZlbnQsIGZ1bmN0aW9uKCkgewoJCQkJCQllbWl0dGVkID0gdHJ1ZTsKCQkJCX0pOwoJCQl9KTsKCQl9LAoKCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS51bmJpbmQoIHRvdWNoU3RhcnRFdmVudCApLnVuYmluZCggdG91Y2hNb3ZlRXZlbnQgKS51bmJpbmQoIHRvdWNoU3RvcEV2ZW50ICk7CgkJfQoJfTsKCSQuZWFjaCh7CgkJc2Nyb2xsc3RvcDogInNjcm9sbHN0YXJ0IiwKCQl0YXBob2xkOiAidGFwIiwKCQlzd2lwZWxlZnQ6ICJzd2lwZSIsCgkJc3dpcGVyaWdodDogInN3aXBlIgoJfSwgZnVuY3Rpb24oIGV2ZW50LCBzb3VyY2VFdmVudCApIHsKCgkJJC5ldmVudC5zcGVjaWFsWyBldmVudCBdID0gewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmluZCggc291cmNlRXZlbnQsICQubm9vcCApOwoJCQl9LAoJCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkudW5iaW5kKCBzb3VyY2VFdmVudCApOwoJCQl9CgkJfTsKCX0pOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKCgkvLyB0aHJvdHRsZWQgcmVzaXplIGV2ZW50CgkoZnVuY3Rpb24oICQgKSB7CgkJJC5ldmVudC5zcGVjaWFsLnRocm90dGxlZHJlc2l6ZSA9IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmJpbmQoICJyZXNpemUiLCBoYW5kbGVyICk7CgkJCX0sCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS51bmJpbmQoICJyZXNpemUiLCBoYW5kbGVyICk7CgkJCX0KCQl9OwoKCQl2YXIgdGhyb3R0bGUgPSAyNTAsCgkJCWhhbmRsZXIgPSBmdW5jdGlvbigpIHsKCQkJCWN1cnIgPSAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCk7CgkJCQlkaWZmID0gY3VyciAtIGxhc3RDYWxsOwoKCQkJCWlmICggZGlmZiA+PSB0aHJvdHRsZSApIHsKCgkJCQkJbGFzdENhbGwgPSBjdXJyOwoJCQkJCSQoIHRoaXMgKS50cmlnZ2VyKCAidGhyb3R0bGVkcmVzaXplIiApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCWlmICggaGVsZENhbGwgKSB7CgkJCQkJCWNsZWFyVGltZW91dCggaGVsZENhbGwgKTsKCQkJCQl9CgoJCQkJCS8vIFByb21pc2UgYSBoZWxkIGNhbGwgd2lsbCBzdGlsbCBleGVjdXRlCgkJCQkJaGVsZENhbGwgPSBzZXRUaW1lb3V0KCBoYW5kbGVyLCB0aHJvdHRsZSAtIGRpZmYgKTsKCQkJCX0KCQkJfSwKCQkJbGFzdENhbGwgPSAwLAoJCQloZWxkQ2FsbCwKCQkJY3VyciwKCQkJZGlmZjsKCX0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoJdmFyIHdpbiA9ICQoIHdpbmRvdyApLAoJCWV2ZW50X25hbWUgPSAib3JpZW50YXRpb25jaGFuZ2UiLAoJCWdldF9vcmllbnRhdGlvbiwKCQlsYXN0X29yaWVudGF0aW9uLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCwKCQlwb3J0cmFpdF9tYXAgPSB7ICIwIjogdHJ1ZSwgIjE4MCI6IHRydWUgfSwKCQl3dywgd2gsIGxhbmRzY2FwZV90aHJlc2hvbGQ7CgoJLy8gSXQgc2VlbXMgdGhhdCBzb21lIGRldmljZS9icm93c2VyIHZlbmRvcnMgdXNlIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZXMgMCBhbmQgMTgwIHRvCgkvLyBkZW5vdGUgdGhlICJkZWZhdWx0IiBvcmllbnRhdGlvbi4gRm9yIGlPUyBkZXZpY2VzLCBhbmQgbW9zdCBvdGhlciBzbWFydC1waG9uZXMgdGVzdGVkLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgYWx3YXlzICJwb3J0cmFpdCIsIGJ1dCBpbiBzb21lIEFuZHJvaWQgYW5kIFJJTSBiYXNlZCB0YWJsZXRzLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgImxhbmRzY2FwZSIuIFRoZSBmb2xsb3dpbmcgY29kZSBhdHRlbXB0cyB0byB1c2UgdGhlIHdpbmRvdwoJLy8gZGltZW5zaW9ucyB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24gaXMsIGFuZCB0aGVuIG1ha2VzIGFkanVzdG1lbnRzCgkvLyB0byB0aGUgdG8gdGhlIHBvcnRyYWl0X21hcCBpZiBuZWNlc3NhcnksIHNvIHRoYXQgd2UgY2FuIHByb3Blcmx5IGRlY29kZSB0aGUKCS8vIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZSB3aGVuZXZlciBnZXRfb3JpZW50YXRpb24oKSBpcyBjYWxsZWQuCgkvLwoJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIGEgbWVkaWEgcXVlcnkgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBvcmllbnRhdGlvbiB0aGUgYnJvd3NlcgoJLy8gdGhpbmtzIGl0IGlzIGluOgoJLy8KCS8vICAgICBpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSA9ICQubW9iaWxlLm1lZGlhKCJhbGwgYW5kIChvcmllbnRhdGlvbjogbGFuZHNjYXBlKSIpOwoJLy8KCS8vIGJ1dCB0aGVyZSB3YXMgYW4gaVBob25lL2lQb2QgVG91Y2ggYnVnIGJlZ2lubmluZyB3aXRoIGlPUyA0LjIsIHVwIHRocm91Z2ggaU9TIDUuMSwKCS8vIHdoZXJlIHRoZSBicm93c2VyICpBTFdBWVMqIGFwcGxpZWQgdGhlIGxhbmRzY2FwZSBtZWRpYSBxdWVyeS4gVGhpcyBidWcgZG9lcyBub3QKCS8vIGhhcHBlbiBvbiBpUGFkLgoKCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICkgewoKCQkvLyBDaGVjayB0aGUgd2luZG93IHdpZHRoIGFuZCBoZWlnaHQgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uCgkJLy8gb2YgdGhlIGRldmljZSBpcyBhdCB0aGlzIG1vbWVudC4gTm90ZSB0aGF0IHdlJ3ZlIGluaXRpYWxpemVkIHRoZSBwb3J0cmFpdCBtYXAKCQkvLyB2YWx1ZXMgdG8gMCBhbmQgMTgwLCAqQU5EKiB3ZSBwdXJwb3NlbHkgY2hlY2sgZm9yIGxhbmRzY2FwZSBzbyB0aGF0IGlmIHdlIGd1ZXNzCgkJLy8gd3JvbmcsICwgd2UgZGVmYXVsdCB0byB0aGUgYXNzdW1wdGlvbiB0aGF0IHBvcnRyYWl0IGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uLgoJCS8vIFdlIHVzZSBhIHRocmVzaG9sZCBjaGVjayBiZWxvdyBiZWNhdXNlIG9uIHNvbWUgcGxhdGZvcm1zIGxpa2UgaU9TLCB0aGUgaVBob25lCgkJLy8gZm9ybS1mYWN0b3IgY2FuIHJlcG9ydCBhIGxhcmdlciB3aWR0aCB0aGFuIGhlaWdodCBpZiB0aGUgdXNlciB0dXJucyBvbiB0aGUKCQkvLyBkZXZlbG9wZXIgY29uc29sZS4gVGhlIGFjdHVhbCB0aHJlc2hvbGQgdmFsdWUgaXMgc29tZXdoYXQgYXJiaXRyYXJ5LCB3ZSBqdXN0CgkJLy8gbmVlZCB0byBtYWtlIHN1cmUgaXQgaXMgbGFyZ2UgZW5vdWdoIHRvIGV4Y2x1ZGUgdGhlIGRldmVsb3BlciBjb25zb2xlIGNhc2UuCgoJCXd3ID0gd2luZG93LmlubmVyV2lkdGggfHwgd2luLndpZHRoKCk7CgkJd2ggPSB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgd2luLmhlaWdodCgpOwoJCWxhbmRzY2FwZV90aHJlc2hvbGQgPSA1MDsKCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgPSB3dyA+IHdoICYmICggd3cgLSB3aCApID4gbGFuZHNjYXBlX3RocmVzaG9sZDsKCgoJCS8vIE5vdyBjaGVjayB0byBzZWUgaWYgdGhlIGN1cnJlbnQgd2luZG93Lm9yaWVudGF0aW9uIGlzIDAgb3IgMTgwLgoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgoJCS8vIElmIHRoZSBpbml0aWFsIG9yaWVudGF0aW9uIGlzIGxhbmRzY2FwZSwgYnV0IHdpbmRvdy5vcmllbnRhdGlvbiByZXBvcnRzIDAgb3IgMTgwLCAqT1IqCgkJLy8gaWYgdGhlIGluaXRpYWwgb3JpZW50YXRpb24gaXMgcG9ydHJhaXQsIGJ1dCB3aW5kb3cub3JpZW50YXRpb24gcmVwb3J0cyA5MCBvciAtOTAsIHdlCgkJLy8gbmVlZCB0byBmbGlwIG91ciBwb3J0cmFpdF9tYXAgdmFsdWVzIGJlY2F1c2UgbGFuZHNjYXBlIGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uIGZvcgoJCS8vIHRoaXMgZGV2aWNlL2Jyb3dzZXIuCgkJaWYgKCAoIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmIGluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCApIHx8ICggIWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmICFpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgKSApIHsKCQkJcG9ydHJhaXRfbWFwID0geyAiLTkwIjogdHJ1ZSwgIjkwIjogdHJ1ZSB9OwoJCX0KCX0KCgkkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UgPSAkLmV4dGVuZCgge30sICQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZSwgewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQgalF1ZXJ5CgkJCS8vIHdpbGwgYmluZCB0byB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICEkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UuZGlzYWJsZWQgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiB0byBhdm9pZCBpbml0aWFsIGRvdWJsZS10cmlnZ2VyaW5nLgoJCQlsYXN0X29yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkvLyBCZWNhdXNlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudCBkb2Vzbid0IGV4aXN0LCBzaW11bGF0ZSB0aGUKCQkJLy8gZXZlbnQgYnkgdGVzdGluZyB3aW5kb3cgZGltZW5zaW9ucyBvbiByZXNpemUuCgkJCXdpbi5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB0aGUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQKCQkJLy8galF1ZXJ5IHdpbGwgdW5iaW5kIHRoZSBldmVudCB1c2luZyBET00gbWV0aG9kcy4KCQkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gJiYgISQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5kaXNhYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgdW5iaW5kIHRoZQoJCQkvLyByZXNpemUgZXZlbnQgaGFuZGxlci4KCQkJd2luLnVuYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCWFkZDogZnVuY3Rpb24oIGhhbmRsZU9iaiApIHsKCQkJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgYm91bmQgZXZlbnQgaGFuZGxlci4KCQkJdmFyIG9sZF9oYW5kbGVyID0gaGFuZGxlT2JqLmhhbmRsZXI7CgoKCQkJaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBNb2RpZnkgZXZlbnQgb2JqZWN0LCBhZGRpbmcgdGhlIC5vcmllbnRhdGlvbiBwcm9wZXJ0eS4KCQkJCWV2ZW50Lm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkJLy8gQ2FsbCB0aGUgb3JpZ2luYWxseS1ib3VuZCBldmVudCBoYW5kbGVyIGFuZCByZXR1cm4gaXRzIHJlc3VsdC4KCQkJCXJldHVybiBvbGRfaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoJfSk7CgoJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoaXMgaGFuZGxlciB3aWxsIGJlIGJvdW5kIHRvCgkvLyB0aGUgd2luZG93IHJlc2l6ZSBldmVudCB0byBzaW11bGF0ZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQuCglmdW5jdGlvbiBoYW5kbGVyKCkgewoJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbi4KCQl2YXIgb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJaWYgKCBvcmllbnRhdGlvbiAhPT0gbGFzdF9vcmllbnRhdGlvbiApIHsKCQkJLy8gVGhlIG9yaWVudGF0aW9uIGhhcyBjaGFuZ2VkLCBzbyB0cmlnZ2VyIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCQkJbGFzdF9vcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uOwoJCQl3aW4udHJpZ2dlciggZXZlbnRfbmFtZSApOwoJCX0KCX0KCgkvLyBHZXQgdGhlIGN1cnJlbnQgcGFnZSBvcmllbnRhdGlvbi4gVGhpcyBtZXRob2QgaXMgZXhwb3NlZCBwdWJsaWNseSwgc2hvdWxkIGl0CgkvLyBiZSBuZWVkZWQsIGFzIGpRdWVyeS5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uKCkKCSQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXZhciBpc1BvcnRyYWl0ID0gdHJ1ZSwgZWxlbSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCgkJLy8gcHJlZmVyIHdpbmRvdyBvcmllbnRhdGlvbiB0byB0aGUgY2FsY3VsYXRpb24gYmFzZWQgb24gc2NyZWVuc2l6ZSBhcwoJCS8vIHRoZSBhY3R1YWwgc2NyZWVuIHJlc2l6ZSB0YWtlcyBwbGFjZSBiZWZvcmUgb3IgYWZ0ZXIgdGhlIG9yaWVudGF0aW9uIGNoYW5nZSBldmVudAoJCS8vIGhhcyBiZWVuIGZpcmVkIGRlcGVuZGluZyBvbiBpbXBsZW1lbnRhdGlvbiAoZWcgYW5kcm9pZCAyLjMgaXMgYmVmb3JlLCBpcGhvbmUgYWZ0ZXIpLgoJCS8vIE1vcmUgdGVzdGluZyBpcyByZXF1aXJlZCB0byBkZXRlcm1pbmUgaWYgYSBtb3JlIHJlbGlhYmxlIG1ldGhvZCBvZiBkZXRlcm1pbmluZyB0aGUgbmV3IHNjcmVlbnNpemUKCQkvLyBpcyBwb3NzaWJsZSB3aGVuIG9yaWVudGF0aW9uY2hhbmdlIGlzIGZpcmVkLiAoZWcsIHVzZSBtZWRpYSBxdWVyaWVzICsgZWxlbWVudCArIG9wYWNpdHkpCgkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgkJCS8vIGlmIHRoZSB3aW5kb3cgb3JpZW50YXRpb24gcmVnaXN0ZXJzIGFzIDAgb3IgMTgwIGRlZ3JlZXMgcmVwb3J0CgkJCS8vIHBvcnRyYWl0LCBvdGhlcndpc2UgbGFuZHNjYXBlCgkJCWlzUG9ydHJhaXQgPSBwb3J0cmFpdF9tYXBbIHdpbmRvdy5vcmllbnRhdGlvbiBdOwoJCX0gZWxzZSB7CgkJCWlzUG9ydHJhaXQgPSBlbGVtICYmIGVsZW0uY2xpZW50V2lkdGggLyBlbGVtLmNsaWVudEhlaWdodCA8IDEuMTsKCQl9CgoJCXJldHVybiBpc1BvcnRyYWl0ID8gInBvcnRyYWl0IiA6ICJsYW5kc2NhcGUiOwoJfTsKCgkkLmZuWyBldmVudF9uYW1lIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBldmVudF9uYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBldmVudF9uYW1lICk7Cgl9OwoKCS8vIGpRdWVyeSA8IDEuOAoJaWYgKCAkLmF0dHJGbiApIHsKCQkkLmF0dHJGblsgZXZlbnRfbmFtZSBdID0gdHJ1ZTsKCX0KCn0oIGpRdWVyeSwgdGhpcyApKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CiQubW9iaWxlLndpZGdldHMgPSB7fTsKCnZhciBvcmlnaW5hbFdpZGdldCA9ICQud2lkZ2V0OwoKJC53aWRnZXQgPSAoZnVuY3Rpb24oIG9yaWcgKSB7CglyZXR1cm4gZnVuY3Rpb24oKSB7CgkJdmFyIGNvbnN0cnVjdG9yID0gb3JpZy5hcHBseSggdGhpcywgYXJndW1lbnRzICksCgkJCW5hbWUgPSBjb25zdHJ1Y3Rvci5wcm90b3R5cGUud2lkZ2V0TmFtZTsKCgkJY29uc3RydWN0b3IuaW5pdFNlbGVjdG9yID0gKCAoIGNvbnN0cnVjdG9yLnByb3RvdHlwZS5pbml0U2VsZWN0b3IgIT09IHVuZGVmaW5lZCApID8KCQkJY29uc3RydWN0b3IucHJvdG90eXBlLmluaXRTZWxlY3RvciA6ICI6anFtRGF0YShyb2xlPSciICsgbmFtZSArICInKSIgKTsKCgkJJC5tb2JpbGUud2lkZ2V0c1sgbmFtZSBdID0gY29uc3RydWN0b3I7CgoJCXJldHVybiBjb25zdHJ1Y3RvcjsKCX07Cn0pKCAkLndpZGdldCApOwoKLy8gTWFrZSBzdXJlICQud2lkZ2V0IHN0aWxsIGhhcyBicmlkZ2UgYW5kIGV4dGVuZCBtZXRob2RzCiQuZXh0ZW5kKCAkLndpZGdldCwgb3JpZ2luYWxXaWRnZXQgKTsKCi8vIEZvciBiYWNrY29tcGF0IHJlbW92ZSBpbiAxLjUKJC5tb2JpbGUuZG9jdW1lbnQub24oICJjcmVhdGUiLCBmdW5jdGlvbiggZXZlbnQgKXsKCSQoIGV2ZW50LnRhcmdldCApLmVuaGFuY2VXaXRoaW4oKTsKfSk7CgokLndpZGdldCggIm1vYmlsZS5wYWdlIiwgewoJb3B0aW9uczogewoJCXRoZW1lOiAiYSIsCgkJZG9tQ2FjaGU6IGZhbHNlLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJa2VlcE5hdGl2ZURlZmF1bHQ6ICQubW9iaWxlLmtlZXBOYXRpdmUsCgkJY29udGVudFRoZW1lOiBudWxsLAoJCWVuaGFuY2VkOiBmYWxzZQoJfSwKCgkvLyBERVBSRUNBVEVEIGZvciA+IDEuNAoJLy8gVE9ETyByZW1vdmUgYXQgMS41CglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbigpIHsKCQkkLldpZGdldC5wcm90b3R5cGUuX2NyZWF0ZVdpZGdldC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJdGhpcy5fdHJpZ2dlciggImluaXQiICk7Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCS8vIElmIGZhbHNlIGlzIHJldHVybmVkIGJ5IHRoZSBjYWxsYmFja3MgZG8gbm90IGNyZWF0ZSB0aGUgcGFnZQoJCWlmICggdGhpcy5fdHJpZ2dlciggImJlZm9yZWNyZWF0ZSIgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgkJdGhpcy5fb24oIHRoaXMuZWxlbWVudCwgewoJCQlwYWdlYmVmb3JlaGlkZTogInJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQiLAoJCQlwYWdlYmVmb3Jlc2hvdzogIl9oYW5kbGVQYWdlQmVmb3JlU2hvdyIKCQl9KTsKCgkJdGhpcy5lbGVtZW50LmVuaGFuY2VXaXRoaW4oKTsKCQkvLyBEaWFsb2cgd2lkZ2V0IGlzIGRlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSB0aGlzIGluIDEuNQoJCWlmKCAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMuZWxlbWVudFswXSwgInJvbGUiICkgPT09ICJkaWFsb2ciICYmICQubW9iaWxlLmRpYWxvZyApewoJCQl0aGlzLmVsZW1lbnQuZGlhbG9nKCk7CgkJfQoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24gKCl7CgkJdmFyIGF0dHJQcmVmaXggPSAiZGF0YS0iICsgJC5tb2JpbGUubnMsCgkJCXNlbGYgPSB0aGlzOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5yb2xlICkgewoJCQl0aGlzLmVsZW1lbnQuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGUiLCB0aGlzLm9wdGlvbnMucm9sZSApOwoJCX0KCgkJdGhpcy5lbGVtZW50CgkJCS5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1wYWdlIHVpLXBhZ2UtdGhlbWUtIiArIHRoaXMub3B0aW9ucy50aGVtZSApOwoKCQkvLyBNYW5pcHVsYXRpb24gb2YgY29udGVudCBvcyBEZXByZWNhdGVkIGFzIG9mIDEuNCByZW1vdmUgaW4gMS41CgkJdGhpcy5lbGVtZW50LmZpbmQoICJbIiArIGF0dHJQcmVmaXggKyAicm9sZT0nY29udGVudCddIiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQl0aGVtZSA9IHRoaXMuZ2V0QXR0cmlidXRlKCBhdHRyUHJlZml4ICsgInRoZW1lIiApIHx8IHVuZGVmaW5lZDsKCQkJCXNlbGYub3B0aW9ucy5jb250ZW50VGhlbWUgPSB0aGVtZSB8fCBzZWxmLm9wdGlvbnMuY29udGVudFRoZW1lIHx8ICggc2VsZi5vcHRpb25zLmRpYWxvZyAmJiBzZWxmLm9wdGlvbnMudGhlbWUgKSB8fCAoIHNlbGYuZWxlbWVudC5qcW1EYXRhKCJyb2xlIikgPT09ICJkaWFsb2ciICYmICBzZWxmLm9wdGlvbnMudGhlbWUgKTsKCQkJCSR0aGlzLmFkZENsYXNzKCAidWktY29udGVudCIgKTsKCQkJCWlmICggc2VsZi5vcHRpb25zLmNvbnRlbnRUaGVtZSApIHsKCQkJCQkkdGhpcy5hZGRDbGFzcyggInVpLWJvZHktIiArICggc2VsZi5vcHRpb25zLmNvbnRlbnRUaGVtZSApICk7CgkJCQl9CgkJCQkvLyBBZGQgQVJJQSByb2xlCgkJCQkkdGhpcy5hdHRyKCAicm9sZSIsICJtYWluIiApLmFkZENsYXNzKCAidWktY29udGVudCIgKTsKCQl9KTsKCX0sCgoJYmluZFJlbW92ZTogZnVuY3Rpb24oIGNhbGxiYWNrICkgewoJCXZhciBwYWdlID0gdGhpcy5lbGVtZW50OwoKCQkvLyB3aGVuIGRvbSBjYWNoaW5nIGlzIG5vdCBlbmFibGVkIG9yIHRoZSBwYWdlIGlzIGVtYmVkZGVkIGJpbmQgdG8gcmVtb3ZlIHRoZSBwYWdlIG9uIGhpZGUKCQlpZiAoICFwYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5vcHRpb25zLmRvbUNhY2hlICYmCgkJCXBhZ2UuaXMoICI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiICkgKSB7CgoJCQkvLyBUT0RPIHVzZSBfb24gLSB0aGF0IGlzLCBzb3J0IG91dCB3aHkgaXQgZG9lc24ndCB3b3JrIGluIHRoaXMgY2FzZQoJCQlwYWdlLmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiLCBjYWxsYmFjayB8fCBmdW5jdGlvbigvKiBlICovKSB7CgkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQkJcHJFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZXJlbW92ZSIgKTsKCgkJCQkkdGhpcy50cmlnZ2VyKCBwckV2ZW50ICk7CgoJCQkJaWYgKCAhcHJFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQkkdGhpcy5yZW1vdmVXaXRoRGVwZW5kZW50cygpOwoJCQkJfQoJCQl9KTsKCQl9Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggbyApIHsKCQlpZiAoIG8udGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktYm9keS0iICsgdGhpcy5vcHRpb25zLnRoZW1lICkuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyBvLnRoZW1lICk7CgkJfQoKCQlpZiAoIG8uY29udGVudFRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5maW5kKCAiW2RhdGEtIiArICQubW9iaWxlLm5zICsgIj0nY29udGVudCddIiApLnJlbW92ZUNsYXNzKCAidWktYm9keS0iICsgdGhpcy5vcHRpb25zLmNvbnRlbnRUaGVtZSApCgkJCQkuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyBvLmNvbnRlbnRUaGVtZSApOwoJCX0KCX0sCgoJX2hhbmRsZVBhZ2VCZWZvcmVTaG93OiBmdW5jdGlvbigvKiBlICovKSB7CgkJdGhpcy5zZXRDb250YWluZXJCYWNrZ3JvdW5kKCk7Cgl9LAoJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJcmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZDogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmNsb3Nlc3QoICI6bW9iaWxlLWNvbnRlbnQiICkuY29udGVudCh7ICJ0aGVtZSI6ICJub25lIiB9KTsKCX0sCgkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkvLyBzZXQgdGhlIHBhZ2UgY29udGFpbmVyIGJhY2tncm91bmQgdG8gdGhlIHBhZ2UgdGhlbWUKCXNldENvbnRhaW5lckJhY2tncm91bmQ6IGZ1bmN0aW9uKCB0aGVtZSApIHsKCQl0aGlzLmVsZW1lbnQucGFyZW50KCkuY29udGVudCggeyAidGhlbWUiOiB0aGVtZSB8fCB0aGlzLm9wdGlvbnMudGhlbWUgfSApOwoJfSwKCS8vIERlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCWtlZXBOYXRpdmVTZWxlY3RvcjogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWtlZXBOYXRpdmVEZWZpbmVkID0gb3B0aW9ucy5rZWVwTmF0aXZlICYmICQudHJpbSggb3B0aW9ucy5rZWVwTmF0aXZlICk7CgoJCWlmICgga2VlcE5hdGl2ZURlZmluZWQgJiYgb3B0aW9ucy5rZWVwTmF0aXZlICE9PSBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0ICkgewoJCQlyZXR1cm4gW29wdGlvbnMua2VlcE5hdGl2ZSwgb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdF0uam9pbiggIiwgIiApOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHQ7Cgl9Cn0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS5jb250ZW50IiwgewoJCW9wdGlvbnM6IHsKCQkJdGhlbWU6ICJhIgoJCX0sCgoJCWluaXRTZWxlY3RvcjogZmFsc2UsCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJHdpbmRvdyA9ICQoIHdpbmRvdyApOwoKCQkJdGhpcy5zZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7CgoJCQkvLyBUT0RPIGNvbnNpZGVyIG1vdmluZyB0aGUgbmF2aWdhdGlvbiBoYW5kbGVyIE9VVCBvZiB3aWRnZXQgaW50bwoJCQkvLyAgICAgIHNvbWUgb3RoZXIgb2JqZWN0IGFzIGdsdWUgYmV0d2VlbiB0aGUgbmF2aWdhdGUgZXZlbnQgYW5kIHRoZQoJCQkvLyAgICAgIGNvbnRlbnQgd2lkZ2V0IGxvYWQgYW5kIGNoYW5nZSBtZXRob2RzCgkJCXRoaXMuX29uKCAkd2luZG93LCB7IG5hdmlnYXRlOiAiX2ZpbHRlck5hdmlnYXRlRXZlbnRzIiB9KTsKCgkJCXRoaXMuX29uKCAkd2luZG93LCB7CgkJCQkvLyBkaXNhYmxlIGFuIHNjcm9sbCBzZXR0aW5nIHdoZW4gYSBoYXNoY2hhbmdlIGhhcyBiZWVuIGZpcmVkLAoJCQkJLy8gdGhpcyBvbmx5IHdvcmtzIGJlY2F1c2UgdGhlIHJlY29yZGluZyBvZiB0aGUgc2Nyb2xsIHBvc2l0aW9uCgkJCQkvLyBpcyBkZWxheWVkIGZvciAxMDBtcyBhZnRlciB0aGUgYnJvd3NlciBtaWdodCBoYXZlIGNoYW5nZWQgdGhlCgkJCQkvLyBwb3NpdGlvbiBiZWNhdXNlIG9mIHRoZSBoYXNoY2hhbmdlCgkJCQluYXZpZ2F0ZTogIl9kaXNhYmxlUmVjb3JkU2Nyb2xsIiwKCgkJCQkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgZm9yIHRoZSBmaXJzdCBwYWdlLCAicGFnZWNoYW5nZSIgd29uJ3QgYmUKCQkJCS8vIGZpcmVkIGluIHRoYXQgY2FzZQoJCQkJc2Nyb2xsc3RvcDogIl9kZWxheWVkUmVjb3JkU2Nyb2xsIgoJCQl9KTsKCgkJCS8vIFRPRE8gbW92ZSBmcm9tIHBhZ2UqIGV2ZW50cyB0byBjb250ZW50KiBldmVudHMKCQkJdGhpcy5fb24oeyBwYWdlY2hhbmdlOiAiX2FmdGVyQ29udGVudENoYW5nZSIgfSk7CgoJCQkvLyBoYW5kbGUgaW5pdGlhbCBoYXNoY2hhbmdlIGZyb20gY2hyb21lIDooCgkJCSR3aW5kb3cub25lKCAibmF2aWdhdGUiLCAkLnByb3h5KGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5zZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7CgkJCX0sIHRoaXMpKTsKCQl9LAoKCQlfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKXsKCQkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgJiYgb3B0aW9ucy50aGVtZSAhPT0gIm5vbmUiICkgewoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktb3ZlcmxheS0iICsgdGhpcy5vcHRpb25zLnRoZW1lICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyBvcHRpb25zLnRoZW1lICk7CgkJCX0gZWxzZSBpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLW92ZXJsYXktIiArIHRoaXMub3B0aW9ucy50aGVtZSApOwoJCQl9CgoJCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJCX0sCgoJCV9kaXNhYmxlUmVjb3JkU2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5zZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IGZhbHNlOwoJCX0sCgoJCV9lbmFibGVSZWNvcmRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCQl9LAoKCQkvLyBUT0RPIGNvbnNpZGVyIHRoZSBuYW1lIGhlcmUsIHNpbmNlIGl0J3MgcHVycG9zZSBzcGVjaWZpYwoJCV9hZnRlckNvbnRlbnRDaGFuZ2U6ICBmdW5jdGlvbigpIHsKCQkJLy8gb25jZSB0aGUgcGFnZSBoYXMgY2hhbmdlZCwgcmUtZW5hYmxlIHRoZSBzY3JvbGwgcmVjb3JkaW5nCgkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoKCQkJLy8gcmVtb3ZlIGFueSBiaW5kaW5nIHRoYXQgcHJldmlvdXNseSBleGlzdGVkIG9uIHRoZSBnZXQgc2Nyb2xsCgkJCS8vIHdoaWNoIG1heSBvciBtYXkgbm90IGJlIGRpZmZlcmVudCB0aGFuIHRoZSBzY3JvbGwgZWxlbWVudAoJCQkvLyBkZXRlcm1pbmVkIGZvciB0aGlzIHBhZ2UgcHJldmlvdXNseQoJCQl0aGlzLl9vZmYoICR3aW5kb3csICJzY3JvbGxzdG9wIiApOwoKCQkJLy8gZGV0ZXJtaW5lIGFuZCBiaW5kIHRvIHRoZSBjdXJyZW50IHNjb2xsIGVsZW1lbnQgd2hpY2ggbWF5IGJlIHRoZQoJCQkvLyB3aW5kb3cgb3IgaW4gdGhlIGNhc2Ugb2YgdG91Y2ggb3ZlcmZsb3cgdGhlIGVsZW1lbnQgdG91Y2ggb3ZlcmZsb3cKCQkJdGhpcy5fb24oICR3aW5kb3csIHsgc2Nyb2xsc3RvcDogIl9kZWxheWVkUmVjb3JkU2Nyb2xsIiB9KTsKCQl9LAoKCQlfcmVjb3JkU2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJLy8gdGhpcyBiYXJyaWVyIHByZXZlbnRzIHNldHRpbmcgdGhlIHNjcm9sbCB2YWx1ZSBiYXNlZCBvbgoJCQkvLyB0aGUgYnJvd3NlciBzY3JvbGxpbmcgdGhlIHdpbmRvdyBiYXNlZCBvbiBhIGhhc2hjaGFuZ2UKCQkJaWYgKCAhdGhpcy5zZXRMYXN0U2Nyb2xsRW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGFjdGl2ZSA9IHRoaXMuX2dldEFjdGl2ZUhpc3RvcnkoKSwKCQkJCWN1cnJlbnRTY3JvbGwsIG1pblNjcm9sbCwgZGVmYXVsdFNjcm9sbDsKCgkJCWlmICggYWN0aXZlICkgewoJCQkJY3VycmVudFNjcm9sbCA9IHRoaXMuX2dldFNjcm9sbCgpOwoJCQkJbWluU2Nyb2xsID0gdGhpcy5fZ2V0TWluU2Nyb2xsKCk7CgkJCQlkZWZhdWx0U2Nyb2xsID0gdGhpcy5fZ2V0RGVmYXVsdFNjcm9sbCgpOwoKCQkJCS8vIFNldCBhY3RpdmUgcGFnZSdzIGxhc3RTY3JvbGwgcHJvcC4gSWYgdGhlIGxvY2F0aW9uIHdlJ3JlCgkJCQkvLyBzY3JvbGxpbmcgdG8gaXMgbGVzcyB0aGFuIG1pblNjcm9sbEJhY2ssIGxldCBpdCBnby4KCQkJCWFjdGl2ZS5sYXN0U2Nyb2xsID0gY3VycmVudFNjcm9sbCA8IG1pblNjcm9sbCA/IGRlZmF1bHRTY3JvbGwgOiBjdXJyZW50U2Nyb2xsOwoJCQl9CgkJfSwKCgkJX2RlbGF5ZWRSZWNvcmRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQlzZXRUaW1lb3V0KCAkLnByb3h5KHRoaXMsICJfcmVjb3JkU2Nyb2xsIiksIDEwMCApOwoJCX0sCgoJCV9nZXRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJHdpbmRvdy5zY3JvbGxUb3AoKTsKCQl9LAoKCQlfZ2V0TWluU2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLm1pblNjcm9sbEJhY2s7CgkJfSwKCgkJX2dldERlZmF1bHRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJfSwKCgkJX2ZpbHRlck5hdmlnYXRlRXZlbnRzOiBmdW5jdGlvbiggZSwgZGF0YSApIHsKCQkJdmFyIHVybDsKCgkJCWlmICggZS5vcmlnaW5hbEV2ZW50ICYmIGUub3JpZ2luYWxFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdXJsID0gZS5vcmlnaW5hbEV2ZW50LnR5cGUuaW5kZXhPZiggImhhc2hjaGFuZ2UiICkgPiAtMSA/IGRhdGEuc3RhdGUuaGFzaCA6IGRhdGEuc3RhdGUudXJsOwoKCQkJaWYgKCAhdXJsICkgewoJCQkJdXJsID0gdGhpcy5fZ2V0SGFzaCgpOwoJCQl9CgoJCQlpZiAoICF1cmwgfHwgdXJsID09PSAiIyIgfHwgdXJsLmluZGV4T2YoICIjIiArICQubW9iaWxlLnBhdGgudWlTdGF0ZUtleSApID09PSAwICl7CgkJCQl1cmwgPSBsb2NhdGlvbi5ocmVmOwoJCQl9CgoJCQl0aGlzLl9oYW5kbGVOYXZpZ2F0ZSggdXJsLCBkYXRhLnN0YXRlICk7CgkJfSwKCgkJX2dldEhhc2g6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQl9LAoKCQkvLyBUT0RPIGFjdGl2ZSBwYWdlIHNob3VsZCBiZSBtYW5hZ2VkIGJ5IHRoZSBjb250YWluZXIgKGllLCBpdCBzaG91bGQgYmUgYSBwcm9wZXJ0eSkKCQlfZ2V0QWN0aXZlQ29udGVudDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5hY3RpdmVQYWdlOwoJCX0sCgoJCS8vIFRPRE8gdGhlIGZpcnN0IHBhZ2Ugc2hvdWxkIGJlIGEgcHJvcGVydHkgc2V0IGR1cmluZyBjcmVhdCB1c2luZyB0aGUgbG9naWMKCQkvLyAgICAgIHRoYXQgY3VycmVudGx5IHJlc2lkZXMgaW4gaW5pdAoJCV9nZXRJbml0aWFsQ29udGVudDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5maXJzdFBhZ2U7CgkJfSwKCgkJLy8gVE9ETyBlYWNoIGNvbnRlbnQgY29udGFpbmVyIHNob3VsZCBoYXZlIGEgaGlzdG9yeSBvYmplY3QKCQlfZ2V0SGlzdG9yeTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB1cmxIaXN0b3J5OwoJCX0sCgoJCS8vIFRPRE8gdXNlIF9nZXRIaXN0b3J5CgkJX2dldEFjdGl2ZUhpc3Rvcnk6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKTsKCQl9LAoKCQkvLyBUT0RPIHRoZSBkb2N1bWVudCBiYXNlIHNob3VsZCBiZSBkZXRlcm1pbmVkIGF0IGNyZWF0aW9uCgkJX2dldERvY3VtZW50QmFzZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiBkb2N1bWVudEJhc2U7CgkJfSwKCgkJX2JhY2s6IGZ1bmN0aW9uKCkgewoJCQkkLm1vYmlsZS5iYWNrKCk7CgkJfSwKCgkJX2ZvcndhcmQ6IGZ1bmN0aW9uKCkgewoJCQl3aW5kb3cuaGlzdG9yeS5mb3J3YXJkKCk7CgkJfSwKCgkJLy8gVE9ETyByZW5hbWUgX2hhbmRsZURlc3RpbmF0aW9uCgkJX2hhbmRsZURlc3RpbmF0aW9uOiBmdW5jdGlvbiggdG8gKSB7CgkJCXZhciBoaXN0b3J5LCBkb2N1bWVudEJhc2U7CgoJCQkvLyBjbGVhbiB0aGUgaGFzaCBmb3IgY29tcGFyaXNvbiBpZiBpdCdzIGEgdXJsCgkJCWlmICggJC50eXBlKHRvKSA9PT0gInN0cmluZyIgKSB7CgkJCQl0byA9IHBhdGguc3RyaXBIYXNoKHRvKTsKCQkJfQoKCQkJaWYgKCB0byApIHsKCQkJCWhpc3RvcnkgPSB0aGlzLl9nZXRIaXN0b3J5KCksCgkJCQlkb2N1bWVudEJhc2UgPSB0aGlzLl9nZXREb2N1bWVudEJhc2UoKTsKCgkJCQkvLyBBdCB0aGlzIHBvaW50LCAndG8nIGNhbiBiZSBvbmUgb2YgMyB0aGluZ3MsIGEgY2FjaGVkIHBhZ2UKCQkJCS8vIGVsZW1lbnQgZnJvbSBhIGhpc3Rvcnkgc3RhY2sgZW50cnksIGFuIGlkLCBvciBzaXRlLXJlbGF0aXZlIC8KCQkJCS8vIGFic29sdXRlIFVSTC4gSWYgJ3RvJyBpcyBhbiBpZCwgd2UgbmVlZCB0byByZXNvbHZlIGl0IGFnYWluc3QKCQkJCS8vIHRoZSBkb2N1bWVudEJhc2UsIG5vdCB0aGUgbG9jYXRpb24uaHJlZiwgc2luY2UgdGhlIGhhc2hjaGFuZ2UKCQkJCS8vIGNvdWxkJ3ZlIGJlZW4gdGhlIHJlc3VsdCBvZiBhIGZvcndhcmQvYmFja3dhcmQgbmF2aWdhdGlvbgoJCQkJLy8gdGhhdCBjcm9zc2VzIGZyb20gYW4gZXh0ZXJuYWwgcGFnZS9kaWFsb2cgdG8gYW4gaW50ZXJuYWwKCQkJCS8vIHBhZ2UvZGlhbG9nLgoJCQkJLy8KCQkJCS8vIFRPRE8gbW92ZSBjaGVjayB0byBoaXN0b3J5IG9iamVjdCBvciBwYXRoIG9iamVjdD8KCQkJCXRvID0gIXBhdGguaXNQYXRoKCB0byApID8gKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgdG8sIGRvY3VtZW50QmFzZSApICkgOiB0bzsKCgkJCQkvLyBJZiB3ZSdyZSBhYm91dCB0byBnbyB0byBhbiBpbml0aWFsIFVSTCB0aGF0IGNvbnRhaW5zIGEKCQkJCS8vIHJlZmVyZW5jZSB0byBhIG5vbi1leGlzdGVudCBpbnRlcm5hbCBwYWdlLCBnbyB0byB0aGUgZmlyc3QKCQkJCS8vIHBhZ2UgaW5zdGVhZC4gV2Uga25vdyB0aGF0IHRoZSBpbml0aWFsIGhhc2ggcmVmZXJzIHRvIGEKCQkJCS8vIG5vbi1leGlzdGVudCBwYWdlLCBiZWNhdXNlIHRoZSBpbml0aWFsIGhhc2ggZGlkIG5vdCBlbmQKCQkJCS8vIHVwIGluIHRoZSBpbml0aWFsIGhpc3RvcnkgZW50cnkKCQkJCS8vIFRPRE8gbW92ZSBjaGVjayB0byBoaXN0b3J5IG9iamVjdD8KCQkJCWlmICggdG8gPT09IHBhdGgubWFrZVVybEFic29sdXRlKCAiIyIgKyBoaXN0b3J5LmluaXRpYWxEc3QsIGRvY3VtZW50QmFzZSApICYmCgkJCQkJaGlzdG9yeS5zdGFjay5sZW5ndGggJiYKCQkJCQloaXN0b3J5LnN0YWNrWzBdLnVybCAhPT0gaGlzdG9yeS5pbml0aWFsRHN0LnJlcGxhY2UoIGRpYWxvZ0hhc2hLZXksICIiICkgKSB7CgkJCQkJdG8gPSB0aGlzLl9nZXRJbml0aWFsQ29udGVudCgpOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gdG8gfHwgdGhpcy5fZ2V0SW5pdGlhbENvbnRlbnQoKTsKCQl9LAoKCQlfaGFuZGxlRGlhbG9nOiBmdW5jdGlvbiggY2hhbmdlUGFnZU9wdGlvbnMsIGRhdGEgKSB7CgkJCXZhciB0bywgYWN0aXZlLCBhY3RpdmVDb250ZW50ID0gdGhpcy5fZ2V0QWN0aXZlQ29udGVudCgpOwoKCQkJLy8gSWYgY3VycmVudCBhY3RpdmUgcGFnZSBpcyBub3QgYSBkaWFsb2cgc2tpcCB0aGUgZGlhbG9nIGFuZCBjb250aW51ZQoJCQkvLyBpbiB0aGUgc2FtZSBkaXJlY3Rpb24KCQkJaWYgKCBhY3RpdmVDb250ZW50ICYmICFhY3RpdmVDb250ZW50Lmhhc0NsYXNzKCAidWktZGlhbG9nIiApICkgewoJCQkJLy8gZGV0ZXJtaW5lIGlmIHdlJ3JlIGhlYWRpbmcgZm9yd2FyZCBvciBiYWNrd2FyZCBhbmQgY29udGludWUKCQkJCS8vIGFjY29yZGluZ2x5IHBhc3QgdGhlIGN1cnJlbnQgZGlhbG9nCgkJCQlpZiAoIGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIgKSB7CgkJCQkJdGhpcy5fYmFjaygpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLl9mb3J3YXJkKCk7CgkJCQl9CgoJCQkJLy8gcHJldmVudCBjaGFuZ2VQYWdlIGNhbGwKCQkJCXJldHVybiBmYWxzZTsKCQkJfSBlbHNlIHsKCQkJCS8vIGlmIHRoZSBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIGEgZGlhbG9nIGFuZCB3ZSdyZSBuYXZpZ2F0aW5nCgkJCQkvLyB0byBhIGRpYWxvZyB1c2UgdGhlIGRpYWxvZyBvYmplY3RlZCBzYXZlZCBpbiB0aGUgc3RhY2sKCQkJCXRvID0gZGF0YS5wYWdlVXJsOwoJCQkJYWN0aXZlID0gdGhpcy5fZ2V0QWN0aXZlSGlzdG9yeSgpOwoKCQkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHJvbGUsIHRyYW5zaXRpb24gYW5kIHJldmVyc2FsCgkJCQkvLyBhcyBtb3N0IG9mIHRoaXMgaXMgbG9zdCBieSB0aGUgZG9tQ2FjaGUgY2xlYW5pbmcKCQkJCSQuZXh0ZW5kKCBjaGFuZ2VQYWdlT3B0aW9ucywgewoJCQkJCXJvbGU6IGFjdGl2ZS5yb2xlLAoJCQkJCXRyYW5zaXRpb246IGFjdGl2ZS50cmFuc2l0aW9uLAoJCQkJCXJldmVyc2U6IGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIKCQkJCX0pOwoJCQl9CgoJCQlyZXR1cm4gdG87CgkJfSwKCgkJX2hhbmRsZU5hdmlnYXRlOiBmdW5jdGlvbiggdXJsLCBkYXRhICkgewoJCQkvL2ZpbmQgZmlyc3QgcGFnZSB2aWEgaGFzaAoJCQkvLyBUT0RPIHN0cmlwaW5nIHRoZSBoYXNoIHR3aWNlIHdpdGggaGFuZGxlVXJsCgkJCXZhciB0byA9IHBhdGguc3RyaXBIYXNoKHVybCksIGhpc3RvcnkgPSB0aGlzLl9nZXRIaXN0b3J5KCksCgoJCQkJLy8gdHJhbnNpdGlvbiBpcyBmYWxzZSBpZiBpdCdzIHRoZSBmaXJzdCBwYWdlLCB1bmRlZmluZWQKCQkJCS8vIG90aGVyd2lzZSAoYW5kIG1heSBiZSBvdmVycmlkZGVuIGJ5IGRlZmF1bHQpCgkJCQl0cmFuc2l0aW9uID0gaGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDAgPyAibm9uZSIgOiB1bmRlZmluZWQsCgoJCQkJLy8gZGVmYXVsdCBvcHRpb25zIGZvciB0aGUgY2hhbmdQYWdlIGNhbGxzIG1hZGUgYWZ0ZXIgZXhhbWluaW5nCgkJCQkvLyB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgcGFnZSBhbmQgdGhlIGhhc2gsIE5PVEUgdGhhdCB0aGUKCQkJCS8vIHRyYW5zaXRpb24gaXMgZGVyaXZlZCBmcm9tIHRoZSBwcmV2aW91cyBoaXN0b3J5IGVudHJ5CgkJCQljaGFuZ2VQYWdlT3B0aW9ucyA9IHsKCQkJCQljaGFuZ2VIYXNoOiBmYWxzZSwKCQkJCQlmcm9tSGFzaENoYW5nZTogdHJ1ZSwKCQkJCQlyZXZlcnNlOiBkYXRhLmRpcmVjdGlvbiA9PT0gImJhY2siCgkJCQl9OwoKCQkJJC5leHRlbmQoIGNoYW5nZVBhZ2VPcHRpb25zLCBkYXRhLCB7CgkJCQl0cmFuc2l0aW9uOiAoaGlzdG9yeS5nZXRMYXN0KCkgfHwge30pLnRyYW5zaXRpb24gfHwgdHJhbnNpdGlvbgoJCQl9KTsKCgkJCS8vIFRPRE8gbW92ZSB0byBfaGFuZGxlRGVzdGluYXRpb24gPwoJCQkvLyBJZiB0aGlzIGlzbid0IHRoZSBmaXJzdCBwYWdlLCBpZiB0aGUgY3VycmVudCB1cmwgaXMgYSBkaWFsb2cgaGFzaAoJCQkvLyBrZXksIGFuZCB0aGUgaW5pdGlhbCBkZXN0aW5hdGlvbiBpc24ndCBlcXVhbCB0byB0aGUgY3VycmVudCB0YXJnZXQKCQkJLy8gcGFnZSwgdXNlIHRoZSBzcGVjaWFsIGRpYWxvZyBoYW5kbGluZwoJCQlpZiAoIGhpc3RvcnkuYWN0aXZlSW5kZXggPiAwICYmCgkJCQl0by5pbmRleE9mKCBkaWFsb2dIYXNoS2V5ICkgPiAtMSAmJgoJCQkJaGlzdG9yeS5pbml0aWFsRHN0ICE9PSB0byApIHsKCgkJCQl0byA9IHRoaXMuX2hhbmRsZURpYWxvZyggY2hhbmdlUGFnZU9wdGlvbnMsIGRhdGEgKTsKCgkJCQlpZiAoIHRvID09PSBmYWxzZSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCgkJCXRoaXMuX2NoYW5nZUNvbnRlbnQoIHRoaXMuX2hhbmRsZURlc3RpbmF0aW9uKHRvKSwgY2hhbmdlUGFnZU9wdGlvbnMgKTsKCQl9LAoKCQlfY2hhbmdlQ29udGVudDogZnVuY3Rpb24oIHRvLCBvcHRzICkgewoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCB0bywgb3B0cyApOwoJCX0sCgoJCV9nZXRCYXNlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIGJhc2U7CgkJfSwKCgkJX2dldEJhc2VXaXRoRGVmYXVsdDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiBmaW5kQmFzZVdpdGhEZWZhdWx0KCk7CgkJfSwKCgkJX2dldE5zOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLm5zOwoJCX0sCgoJCV9lbmhhbmNlOiBmdW5jdGlvbiggY29udGVudCwgcm9sZSApIHsKCQkJLy8gVE9ETyBjb25zaWRlciBzdXBwb3J0aW5nIGEgY3VzdG9tIGNhbGxiYWNrLCBhbmQgcGFzc2luZyBpbgoJCQkvLyB0aGUgc2V0dGluZ3Mgd2hpY2ggaW5jbHVkZXMgdGhlIHJvbGUKCQkJcmV0dXJuIGNvbnRlbnQucGFnZSh7IHJvbGU6IHJvbGUgfSk7CgkJfSwKCgkJX2luY2x1ZGU6IGZ1bmN0aW9uKCBwYWdlLCBzZXR0aW5ncyApIHsKCQkJLy8gYXBwZW5kIHRvIHBhZ2UgYW5kIGVuaGFuY2UKCQkJcGFnZS5hcHBlbmRUbyggdGhpcy5lbGVtZW50ICk7CgoJCQkvLyB1c2UgdGhlIHBhZ2Ugd2lkZ2V0IHRvIGVuaGFuY2UKCQkJdGhpcy5fZW5oYW5jZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkJLy8gcmVtb3ZlIHBhZ2Ugb24gaGlkZQoJCQlwYWdlLnBhZ2UoICJiaW5kUmVtb3ZlIiApOwoJCX0sCgoJCV9maW5kOiBmdW5jdGlvbiggYWJzVXJsICkgewoJCQkvLyBUT0RPIGNvbnNpZGVyIHN1cHBvcnRpbmcgYSBjdXN0b20gY2FsbGJhY2sKCQkJdmFyIGZpbGVVcmwgPSB0aGlzLl9jcmVhdGVGaWxlVXJsKCBhYnNVcmwgKSwKCQkJCWRhdGFVcmwgPSB0aGlzLl9jcmVhdGVEYXRhVXJsKCBhYnNVcmwgKSwKCQkJCXBhZ2UsIGluaXRpYWxDb250ZW50ID0gdGhpcy5fZ2V0SW5pdGlhbENvbnRlbnQoKTsKCgkJCS8vIENoZWNrIHRvIHNlZSBpZiB0aGUgcGFnZSBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgRE9NLgoJCQkvLyBOT1RFIGRvIF9ub3RfIHVzZSB0aGUgOmpxbURhdGEgcHN1ZWRvIHNlbGVjdG9yIGJlY2F1c2UgcGFyZW50aGVzaXMKCQkJLy8gICAgICBhcmUgYSB2YWxpZCB1cmwgY2hhciBhbmQgaXQgYnJlYWtzIG9uIHRoZSBmaXJzdCBvY2N1cmVuY2UKCQkJcGFnZSA9IHRoaXMuZWxlbWVudAoJCQkJLmNoaWxkcmVuKCAiW2RhdGEtIiArIHRoaXMuX2dldE5zKCkgKyJ1cmw9JyIgKyBkYXRhVXJsICsgIiddIiApOwoKCQkJLy8gSWYgd2UgZmFpbGVkIHRvIGZpbmQgdGhlIHBhZ2UsIGNoZWNrIHRvIHNlZSBpZiB0aGUgdXJsIGlzIGEKCQkJLy8gcmVmZXJlbmNlIHRvIGFuIGVtYmVkZGVkIHBhZ2UuIElmIHNvLCBpdCBtYXkgaGF2ZSBiZWVuIGR5bmFtaWNhbGx5CgkJCS8vIGluamVjdGVkIGJ5IGEgZGV2ZWxvcGVyLCBpbiB3aGljaCBjYXNlIGl0IHdvdWxkIGJlIGxhY2tpbmcgYQoJCQkvLyBkYXRhLXVybCBhdHRyaWJ1dGUgYW5kIGluIG5lZWQgb2YgZW5oYW5jZW1lbnQuCgkJCWlmICggcGFnZS5sZW5ndGggPT09IDAgJiYgZGF0YVVybCAmJiAhcGF0aC5pc1BhdGgoIGRhdGFVcmwgKSApIHsKCQkJCXBhZ2UgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oIHBhdGguaGFzaFRvU2VsZWN0b3IoIiMiICsgZGF0YVVybCkgKQoJCQkJCS5hdHRyKCAiZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJ1cmwiLCBkYXRhVXJsICkKCQkJCQkuanFtRGF0YSggInVybCIsIGRhdGFVcmwgKTsKCQkJfQoKCgkJCS8vIElmIHdlIGZhaWxlZCB0byBmaW5kIGEgcGFnZSBpbiB0aGUgRE9NLCBjaGVjayB0aGUgVVJMIHRvIHNlZSBpZiBpdAoJCQkvLyByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIGFwcGxpY2F0aW9uLiBBbHNvIENoZWNrIHRvIG1ha2Ugc3VyZQoJCQkvLyBvdXIgY2FjaGVkLWZpcnN0LXBhZ2UgaXMgYWN0dWFsbHkgaW4gdGhlIERPTS4gU29tZSB1c2VyIGRlcGxveWVkCgkJCS8vIGFwcHMgYXJlIHBydW5pbmcgdGhlIGZpcnN0IHBhZ2UgZnJvbSB0aGUgRE9NIGZvciB2YXJpb3VzIHJlYXNvbnMsCgkJCS8vIHdlIGNoZWNrIGZvciB0aGlzIGNhc2UgaGVyZSBiZWNhdXNlIHdlIGRvbid0IHdhbnQgYSBmaXJzdC1wYWdlIHdpdGgKCQkJLy8gYW4gaWQgZmFsbGluZyB0aHJvdWdoIHRvIHRoZSBub24tZXhpc3RlbnQgZW1iZWRkZWQgcGFnZSBlcnJvciBjYXNlLgoJCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICYmCgkJCQlwYXRoLmlzRmlyc3RQYWdlVXJsKGZpbGVVcmwpICYmCgkJCQlpbml0aWFsQ29udGVudCAmJgoJCQkJaW5pdGlhbENvbnRlbnQucGFyZW50KCkubGVuZ3RoICkgewoJCQkJcGFnZSA9ICQoIGluaXRpYWxDb250ZW50ICk7CgkJCX0KCgkJCXJldHVybiBwYWdlOwoJCX0sCgoJCV9nZXRMb2FkZXI6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUubG9hZGVyV2lkZ2V0OwoJCX0sCgoJCV9zaG93TG9hZGluZzogZnVuY3Rpb24oIGRlbGF5LCB0aGVtZSwgbXNnLCB0ZXh0b25seSApIHsKCQkJLy8gVGhpcyBjb25maWd1cmFibGUgdGltZW91dCBhbGxvd3MgY2FjaGVkIHBhZ2VzIGEgYnJpZWYKCQkJLy8gZGVsYXkgdG8gbG9hZCB3aXRob3V0IHNob3dpbmcgYSBtZXNzYWdlCgkJCXRoaXMuX2xvYWRNc2cgPSBzZXRUaW1lb3V0KCQucHJveHkoZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl9nZXRMb2FkZXIoKS5sb2FkZXIoICJzaG93IiwgdGhlbWUsIG1zZywgdGV4dG9ubHkgKTsKCQkJfSwgdGhpcyksIGRlbGF5ICk7CgkJfSwKCgkJX2hpZGVMb2FkaW5nOiBmdW5jdGlvbigpIHsKCQkJLy8gU3RvcCBtZXNzYWdlIHNob3cgdGltZXIKCQkJY2xlYXJUaW1lb3V0KCB0aGlzLl9sb2FkTXNnICk7CgoJCQkvLyBIaWRlIGxvYWRpbmcgbWVzc2FnZQoJCQl0aGlzLl9nZXRMb2FkZXIoKS5sb2FkZXIoICJoaWRlIiApOwoJCX0sCgoJCV9zaG93RXJyb3I6IGZ1bmN0aW9uKCkgewoJCQkvLyBtYWtlIHN1cmUgdG8gcmVtb3ZlIHRoZSBjdXJyZW50IGxvYWRpbmcgbWVzc2FnZQoJCQl0aGlzLl9oaWRlTG9hZGluZygpOwoKCQkJLy8gc2hvdyB0aGUgZXJyb3IgbWVzc2FnZQoJCQl0aGlzLl9zaG93TG9hZGluZyggMCwgJC5tb2JpbGUucGFnZUxvYWRFcnJvck1lc3NhZ2VUaGVtZSwgJC5tb2JpbGUucGFnZUxvYWRFcnJvck1lc3NhZ2UsIHRydWUgKTsKCgkJCS8vIGhpZGUgdGhlIGVycm9yIG1lc3NhZ2UgYWZ0ZXIgYSBkZWxheQoJCQkvLyBUT0RPIGNvbmZpZ3VyYXRpb24KCQkJc2V0VGltZW91dCggJC5wcm94eSh0aGlzLCAiX2hpZGVMb2FkaW5nIiksIDE1MDAgKTsKCQl9LAoKCQlfcGFyc2U6IGZ1bmN0aW9uKCBodG1sLCBmaWxlVXJsICkgewoJCQkvLyBUT0RPIGNvbnNpZGVyIGFsbG93aW5nIGN1c3RvbWl6YXRpb24gb2YgdGhpcyBtZXRob2QuIEl0J3MgdmVyeSBKUU0gc3BlY2lmaWMKCQkJdmFyIHBhZ2UsIGFsbCA9ICQoICI8ZGl2PjwvZGl2PiIgKTsKCgkJCS8vd29ya2Fyb3VuZCB0byBhbGxvdyBzY3JpcHRzIHRvIGV4ZWN1dGUgd2hlbiBpbmNsdWRlZCBpbiBwYWdlIGRpdnMKCQkJYWxsLmdldCggMCApLmlubmVySFRNTCA9IGh0bWw7CgoJCQlwYWdlID0gYWxsLmZpbmQoICI6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLmZpcnN0KCk7CgoJCQkvL2lmIHBhZ2UgZWxlbSBjb3VsZG4ndCBiZSBmb3VuZCwgY3JlYXRlIG9uZSBhbmQgaW5zZXJ0IHRoZSBib2R5IGVsZW1lbnQncyBjb250ZW50cwoJCQlpZiAoICFwYWdlLmxlbmd0aCApIHsKCQkJCXBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInJvbGU9J3BhZ2UnPiIgKwoJCQkJCSggaHRtbC5zcGxpdCggLzxcLz9ib2R5W14+XSo+L2dtaSApWzFdIHx8ICIiICkgKwoJCQkJCSI8L2Rpdj4iICk7CgkJCX0KCgkJCS8vIFRPRE8gdGFnaW5nIGEgcGFnZSB3aXRoIGV4dGVybmFsIHRvIG1ha2Ugc3VyZSB0aGF0IGVtYmVkZGVkIHBhZ2VzIGFyZW4ndAoJCQkvLyByZW1vdmVkIGJ5IHRoZSB2YXJpb3VzIHBhZ2UgaGFuZGxpbmcgY29kZSBpcyBiYWQuIEhhdmluZyBwYWdlIGhhbmRsaW5nIGNvZGUKCQkJLy8gaW4gbWFueSBwbGFjZXMgaXMgYmFkLiBTb2x1dGlvbnMgcG9zdCAxLjAKCQkJcGFnZS5hdHRyKCAiZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJ1cmwiLCBwYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoZmlsZVVybCkgKQoJCQkJLmF0dHIoICJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgImV4dGVybmFsLXBhZ2UiLCB0cnVlICk7CgoJCQlyZXR1cm4gcGFnZTsKCQl9LAoKCQlfc2V0TG9hZGVkVGl0bGU6IGZ1bmN0aW9uKCBwYWdlLCBodG1sICkgewoJCQkvL3BhZ2UgdGl0bGUgcmVnZXhwCgkJCXZhciBuZXdQYWdlVGl0bGUgPSBodG1sLm1hdGNoKCAvPHRpdGxlW14+XSo+KFtePF0qKS8gKSAmJiBSZWdFeHAuJDE7CgoJCQlpZiAoIG5ld1BhZ2VUaXRsZSAmJiAhcGFnZS5qcW1EYXRhKCJ0aXRsZSIpICkgewoJCQkJbmV3UGFnZVRpdGxlID0gJCggIjxkaXY+IiArIG5ld1BhZ2VUaXRsZSArICI8L2Rpdj4iICkudGV4dCgpOwoJCQkJcGFnZS5qcW1EYXRhKCAidGl0bGUiLCBuZXdQYWdlVGl0bGUgKTsKCQkJfQoJCX0sCgoJCV9pc1Jld3JpdGFibGVCYXNlVGFnOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmR5bmFtaWNCYXNlRW5hYmxlZCAmJiAhJC5zdXBwb3J0LmR5bmFtaWNCYXNlVGFnOwoJCX0sCgoJCV9jcmVhdGVEYXRhVXJsOiBmdW5jdGlvbiggYWJzb2x1dGVVcmwgKSB7CgkJCXJldHVybiBwYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoIGFic29sdXRlVXJsICk7CgkJfSwKCgkJX2NyZWF0ZUZpbGVVcmw6IGZ1bmN0aW9uKCBhYnNvbHV0ZVVybCApIHsKCQkJcmV0dXJuIHBhdGguZ2V0RmlsZVBhdGgoIGFic29sdXRlVXJsICk7CgkJfSwKCgkJX3RyaWdnZXJXaXRoRGVwcmVjYXRlZDogZnVuY3Rpb24oIG5hbWUsIGRhdGEsIHBhZ2UgKSB7CgkJCXZhciBkZXByZWNhdGVkRXZlbnQgPSAkLkV2ZW50KCAicGFnZSIgKyBuYW1lICksCgkJCQluZXdFdmVudCA9ICQuRXZlbnQoIHRoaXMud2lkZ2V0TmFtZSArIG5hbWUgKTsKCgkJCS8vIERFUFJFQ0FURUQKCQkJLy8gdHJpZ2dlciB0aGUgb2xkIGRlcHJlY2F0ZWQgZXZlbnQgb24gdGhlIHBhZ2UgaWYgaXQncyBwcm92aWRlZAoJCQkocGFnZSB8fCB0aGlzLmVsZW1lbnQpLnRyaWdnZXIoIGRlcHJlY2F0ZWRFdmVudCwgZGF0YSApOwoKCQkJLy8gdXNlIHRoZSB3aWRnZXQgdHJpZ2dlciBtZXRob2QgZm9yIHRoZSBuZXcgY29udGVudCogZXZlbnQKCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoIG5ld0V2ZW50LCBkYXRhICk7CgoJCQlyZXR1cm4gewoJCQkJZGVwcmVjYXRlZEV2ZW50OiBkZXByZWNhdGVkRXZlbnQsCgkJCQlldmVudDogbmV3RXZlbnQKCQkJfTsKCQl9LAoKCQkvLyBUT0RPIGl0IHdvdWxkIGJlIG5pY2UgdG8gc3BsaXQgdGhpcyB1cCBtb3JlIGJ1dCBldmVyeXRoaW5nIGFwcGVhcnMgdG8gYmUgIm9uZSBvZmYiCgkJLy8gICAgICBvciByZXF1aXJlIG9yZGVyaW5nIHN1Y2ggdGhhdCBvdGhlciBiaXRzIGFyZSBzcHJpbmtsZWQgaW4gYmV0d2VlbiBwYXJ0cyB0aGF0CgkJLy8gICAgICBjb3VsZCBiZSBhYnN0cmFjdGVkIG91dCBhcyBhIGdyb3VwCgkJX2xvYWRTdWNjZXNzOiBmdW5jdGlvbiggYWJzVXJsLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MsIGRlZmVycmVkICkgewoJCQl2YXIgZmlsZVVybCA9IHRoaXMuX2NyZWF0ZUZpbGVVcmwoIGFic1VybCApLAoJCQkJZGF0YVVybCA9IHRoaXMuX2NyZWF0ZURhdGFVcmwoIGFic1VybCApOwoKCQkJcmV0dXJuICQucHJveHkoZnVuY3Rpb24oIGh0bWwsIHRleHRTdGF0dXMsIHhociApIHsKCQkJCS8vcHJlLXBhcnNlIGh0bWwgdG8gY2hlY2sgZm9yIGEgZGF0YS11cmwsCgkJCQkvL3VzZSBpdCBhcyB0aGUgbmV3IGZpbGVVcmwsIGJhc2UgcGF0aCwgZXRjCgkJCQl2YXIgY29udGVudCwKCgkJCQkJLy8gVE9ETyBoYW5kbGUgZGlhbG9ncyBhZ2FpbgoJCQkJCXBhZ2VFbGVtUmVnZXggPSBuZXcgUmVnRXhwKCAiKDxbXj5dK1xcYmRhdGEtIiArIHRoaXMuX2dldE5zKCkgKyAicm9sZT1bXCInXT9wYWdlW1wiJ10/W14+XSo+KSIgKSwKCgkJCQkJZGF0YVVybFJlZ2V4ID0gbmV3IFJlZ0V4cCggIlxcYmRhdGEtIiArIHRoaXMuX2dldE5zKCkgKyAidXJsPVtcIiddPyhbXlwiJz5dKilbXCInXT8iICk7CgoJCQkJLy8gZGF0YS11cmwgbXVzdCBiZSBwcm92aWRlZCBmb3IgdGhlIGJhc2UgdGFnIHNvIHJlc291cmNlIHJlcXVlc3RzCgkJCQkvLyBjYW4gYmUgZGlyZWN0ZWQgdG8gdGhlIGNvcnJlY3QgdXJsLiBsb2FkaW5nIGludG8gYSB0ZW1wcm9yYXJ5CgkJCQkvLyBlbGVtZW50IG1ha2VzIHRoZXNlIHJlcXVlc3RzIGltbWVkaWF0ZWx5CgkJCQlpZiAoIHBhZ2VFbGVtUmVnZXgudGVzdCggaHRtbCApICYmCgkJCQkJUmVnRXhwLiQxICYmCgkJCQkJZGF0YVVybFJlZ2V4LnRlc3QoIFJlZ0V4cC4kMSApICYmCgkJCQkJUmVnRXhwLiQxICkgewoJCQkJCWZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCAkKCI8ZGl2PiIgKyBSZWdFeHAuJDEgKyAiPC9kaXY+IikudGV4dCgpICk7CgkJCQl9CgoJCQkJLy9kb250IHVwZGF0ZSB0aGUgYmFzZSB0YWcgaWYgd2UgYXJlIHByZWZldGNoaW5nCgkJCQlpZiAoIHNldHRpbmdzLnByZWZldGNoID09PSB1bmRlZmluZWQgKXsKCQkJCQl0aGlzLl9nZXRCYXNlKCkuc2V0KCBmaWxlVXJsICk7CgkJCQl9CgoJCQkJY29udGVudCA9IHRoaXMuX3BhcnNlKCBodG1sLCBmaWxlVXJsICk7CgoJCQkJdGhpcy5fc2V0TG9hZGVkVGl0bGUoIGNvbnRlbnQsIGh0bWwgKTsKCgkJCQkvLyByZXdyaXRlIHNyYyBhbmQgaHJlZiBhdHRycyB0byB1c2UgYSBiYXNlIHVybCBpZiB0aGUgYmFzZSB0YWcgd29uJ3Qgd29yawoJCQkJaWYgKCB0aGlzLl9pc1Jld3JpdGFibGVCYXNlVGFnKCkgJiYgY29udGVudCApIHsKCQkJCQl0aGlzLl9nZXRCYXNlKCkucmV3cml0ZSggZmlsZVVybCwgY29udGVudCApOwoJCQkJfQoKCQkJCXRoaXMuX2luY2x1ZGUoIGNvbnRlbnQsIHNldHRpbmdzICk7CgoJCQkJLy8gRW5oYW5jaW5nIHRoZSBjb250ZW50IG1heSByZXN1bHQgaW4gbmV3IGRpYWxvZ3Mvc3ViIGNvbnRlbnQgYmVpbmcgaW5zZXJ0ZWQKCQkJCS8vIGludG8gdGhlIERPTS4gSWYgdGhlIG9yaWdpbmFsIGFic1VybCByZWZlcnMgdG8gYSBzdWItY29udGVudCwgdGhhdCBpcyB0aGUKCQkJCS8vIHJlYWwgY29udGVudCB3ZSBhcmUgaW50ZXJlc3RlZCBpbi4KCQkJCWlmICggYWJzVXJsLmluZGV4T2YoICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSA+IC0xICkgewoJCQkJCWNvbnRlbnQgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICJbZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArInVybD0nIiArIGRhdGFVcmwgKyAiJ10iICk7CgkJCQl9CgoJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgkJCQkJdGhpcy5faGlkZUxvYWRpbmcoKTsKCQkJCX0KCgkJCQkvLyBBZGQgdGhlIGNvbnRlbnQgcmVmZXJlbmNlIGFuZCB4aHIgdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgoJCQkJLy8gREVQUkVDQVRFRAoJCQkJdHJpZ2dlckRhdGEucGFnZSA9IGNvbnRlbnQ7CgoJCQkJdHJpZ2dlckRhdGEuY29udGVudCA9IGNvbnRlbnQ7CgoJCQkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHRoZSBjb250ZW50IGxvYWRlZCBzdWNjZXNzZnVsbHkuCgkJCQl0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJsb2FkIiwgdHJpZ2dlckRhdGEgKTsKCgkJCQlkZWZlcnJlZC5yZXNvbHZlKCBhYnNVcmwsIHNldHRpbmdzLCBjb250ZW50ICk7CgkJCX0sIHRoaXMpOwoJCX0sCgoJCV9sb2FkRGVmYXVsdHM6IHsKCQkJdHlwZTogImdldCIsCgkJCWRhdGE6IHVuZGVmaW5lZCwKCgkJCS8vIERFUFJFQ0FURUQKCQkJcmVsb2FkUGFnZTogZmFsc2UsCgoJCQlyZWxvYWQ6IGZhbHNlLAoKCQkJLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCQlyb2xlOiB1bmRlZmluZWQsCgoJCQlzaG93TG9hZE1zZzogZmFsc2UsCgoJCQkvLyBUaGlzIGRlbGF5IGFsbG93cyBsb2FkcyB0aGF0IHB1bGwgZnJvbSBicm93c2VyIGNhY2hlIHRvCgkJCS8vIG9jY3VyIHdpdGhvdXQgc2hvd2luZyB0aGUgbG9hZGluZyBtZXNzYWdlLgoJCQlsb2FkTXNnRGVsYXk6IDUwCgkJfSwKCgkJbG9hZDogZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsKCQkJLy8gVGhpcyBmdW5jdGlvbiB1c2VzIGRlZmVycmVkIG5vdGlmaWNhdGlvbnMgdG8gbGV0IGNhbGxlcnMKCQkJLy8ga25vdyB3aGVuIHRoZSBjb250ZW50IGlzIGRvbmUgbG9hZGluZywgb3IgaWYgYW4gZXJyb3IgaGFzIG9jY3VycmVkLgoJCQl2YXIgZGVmZXJyZWQgPSBvcHRpb25zLmRlZmVycmVkIHx8ICQuRGVmZXJyZWQoKSwKCgkJCQkvLyBUaGUgZGVmYXVsdCBsb2FkIG9wdGlvbnMgd2l0aCBvdmVycmlkZXMgc3BlY2lmaWVkIGJ5IHRoZSBjYWxsZXIuCgkJCQlzZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgdGhpcy5fbG9hZERlZmF1bHRzLCBvcHRpb25zICksCgoJCQkJLy8gVGhlIERPTSBlbGVtZW50IGZvciB0aGUgY29udGVudCBhZnRlciBpdCBoYXMgYmVlbiBsb2FkZWQuCgkJCQljb250ZW50ID0gbnVsbCwKCgkJCQkvLyBUaGUgYWJzb2x1dGUgdmVyc2lvbiBvZiB0aGUgVVJMIHBhc3NlZCBpbnRvIHRoZSBmdW5jdGlvbi4gVGhpcwoJCQkJLy8gdmVyc2lvbiBvZiB0aGUgVVJMIG1heSBjb250YWluIGRpYWxvZy9zdWJjb250ZW50IHBhcmFtcyBpbiBpdC4KCQkJCWFic1VybCA9IHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIHRoaXMuX2dldEJhc2VXaXRoRGVmYXVsdCgpICksCgkJCQlmaWxlVXJsLCBkYXRhVXJsLCBwYmxFdmVudCwgdHJpZ2dlckRhdGE7CgoJCQkvLyBERVBSRUNBVEVEIHJlbG9hZFBhZ2UKCQkJc2V0dGluZ3MucmVsb2FkID0gc2V0dGluZ3MucmVsb2FkUGFnZTsKCgkJCS8vIElmIHRoZSBjYWxsZXIgcHJvdmlkZWQgZGF0YSwgYW5kIHdlJ3JlIHVzaW5nICJnZXQiIHJlcXVlc3QsCgkJCS8vIGFwcGVuZCB0aGUgZGF0YSB0byB0aGUgVVJMLgoJCQlpZiAoIHNldHRpbmdzLmRhdGEgJiYgc2V0dGluZ3MudHlwZSA9PT0gImdldCIgKSB7CgkJCQlhYnNVcmwgPSBwYXRoLmFkZFNlYXJjaFBhcmFtcyggYWJzVXJsLCBzZXR0aW5ncy5kYXRhICk7CgkJCQlzZXR0aW5ncy5kYXRhID0gdW5kZWZpbmVkOwoJCQl9CgoJCQkvLyBJZiB0aGUgY2FsbGVyIGlzIHVzaW5nIGEgInBvc3QiIHJlcXVlc3QsIHJlbG9hZCBtdXN0IGJlIHRydWUKCQkJaWYgKCBzZXR0aW5ncy5kYXRhICYmIHNldHRpbmdzLnR5cGUgPT09ICJwb3N0IiApIHsKCQkJCXNldHRpbmdzLnJlbG9hZCA9IHRydWU7CgkJCX0KCgkJCS8vIFRoZSBhYnNvbHV0ZSB2ZXJzaW9uIG9mIHRoZSBVUkwgbWludXMgYW55IGRpYWxvZy9zdWJjb250ZW50IHBhcmFtcy4KCQkJLy8gSW4gb3RoZXJ3b3JkcyB0aGUgcmVhbCBVUkwgb2YgdGhlIGNvbnRlbnQgdG8gYmUgbG9hZGVkLgoJCQlmaWxlVXJsID0gdGhpcy5fY3JlYXRlRmlsZVVybCggYWJzVXJsICk7CgoJCQkvLyBUaGUgdmVyc2lvbiBvZiB0aGUgVXJsIGFjdHVhbGx5IHN0b3JlZCBpbiB0aGUgZGF0YS11cmwgYXR0cmlidXRlIG9mCgkJCS8vIHRoZSBjb250ZW50LiBGb3IgZW1iZWRkZWQgY29udGVudCwgaXQgaXMganVzdCB0aGUgaWQgb2YgdGhlIHBhZ2UuIEZvciBjb250ZW50CgkJCS8vIHdpdGhpbiB0aGUgc2FtZSBkb21haW4gYXMgdGhlIGRvY3VtZW50IGJhc2UsIGl0IGlzIHRoZSBzaXRlIHJlbGF0aXZlCgkJCS8vIHBhdGguIEZvciBjcm9zcy1kb21haW4gY29udGVudCAoUGhvbmUgR2FwIG9ubHkpIHRoZSBlbnRpcmUgYWJzb2x1dGUgVXJsCgkJCS8vIHVzZWQgdG8gbG9hZCB0aGUgY29udGVudC4KCQkJZGF0YVVybCA9IHRoaXMuX2NyZWF0ZURhdGFVcmwoIGFic1VybCApOwoKCQkJY29udGVudCA9IHRoaXMuX2ZpbmQoIGFic1VybCApOwoKCQkJLy8gSWYgaXQgaXNuJ3QgYSByZWZlcmVuY2UgdG8gdGhlIGZpcnN0IGNvbnRlbnQgYW5kIHJlZmVycyB0byBtaXNzaW5nIGVtYmVkZGVkIGNvbnRlbnQKCQkJLy8gcmVqZWN0IHRoZSBkZWZlcnJlZCBhbmQgcmV0dXJuCgkJCWlmICggY29udGVudC5sZW5ndGggPT09IDAgJiYKCQkJCXBhdGguaXNFbWJlZGRlZFBhZ2UoZmlsZVVybCkgJiYKCQkJCSFwYXRoLmlzRmlyc3RQYWdlVXJsKGZpbGVVcmwpICkgewoJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIHNldHRpbmdzICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFJlc2V0IGJhc2UgdG8gdGhlIGRlZmF1bHQgZG9jdW1lbnQgYmFzZQoJCQkvLyBUT0RPIGZpZ3VyZSBvdXQgd2h5IHdlIGRvZSB0aGlzCgkJCXRoaXMuX2dldEJhc2UoKS5yZXNldCgpOwoKCQkJLy8gSWYgdGhlIGNvbnRlbnQgd2UgYXJlIGludGVyZXN0ZWQgaW4gaXMgYWxyZWFkeSBpbiB0aGUgRE9NLAoJCQkvLyBhbmQgdGhlIGNhbGxlciBkaWQgbm90IGluZGljYXRlIHRoYXQgd2Ugc2hvdWxkIGZvcmNlIGEKCQkJLy8gcmVsb2FkIG9mIHRoZSBmaWxlLCB3ZSBhcmUgZG9uZS4gUmVzb2x2ZSB0aGUgZGVmZXJycmVkIHNvIHRoYXQKCQkJLy8gdXNlcnMgY2FuIGJpbmQgdG8gLmRvbmUgb24gdGhlIHByb21pc2UKCQkJaWYgKCBjb250ZW50Lmxlbmd0aCAmJiAhc2V0dGluZ3MucmVsb2FkICkgewoJCQkJdGhpcy5fZW5oYW5jZSggY29udGVudCwgc2V0dGluZ3Mucm9sZSApOwoJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBzZXR0aW5ncywgY29udGVudCApOwoKCQkJCS8vaWYgd2UgYXJlIHJlbG9hZGluZyB0aGUgY29udGVudCBtYWtlIHN1cmUgd2UgdXBkYXRlCgkJCQkvLyB0aGUgYmFzZSBpZiBpdHMgbm90IGEgcHJlZmV0Y2gKCQkJCWlmICggIXNldHRpbmdzLnByZWZldGNoICl7CgkJCQkJdGhpcy5fZ2V0QmFzZSgpLnNldCh1cmwpOwoJCQkJfQoKCQkJCXJldHVybjsKCQkJfQoKCQkJdHJpZ2dlckRhdGEgPSB7CgkJCQl1cmw6IHVybCwKCQkJCWFic1VybDogYWJzVXJsLAoJCQkJZGF0YVVybDogZGF0YVVybCwKCQkJCWRlZmVycmVkOiBkZWZlcnJlZCwKCQkJCW9wdGlvbnM6IHNldHRpbmdzCgkJCX07CgoJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gbG9hZCBhIGNvbnRlbnQuCgkJCXBibEV2ZW50ID0gdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAiYmVmb3JlbG9hZCIsIHRyaWdnZXJEYXRhICk7CgoJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJaWYgKCBwYmxFdmVudC5kZXByZWNhdGVkRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgfHwKCQkJCSBwYmxFdmVudC5ldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCQkJCXRoaXMuX3Nob3dMb2FkaW5nKCBzZXR0aW5ncy5sb2FkTXNnRGVsYXkgKTsKCQkJfQoKCQkJLy8gUmVzZXQgYmFzZSB0byB0aGUgZGVmYXVsdCBkb2N1bWVudCBiYXNlLgoJCQkvLyBvbmx5IHJlc2V0IGlmIHdlIGFyZSBub3QgcHJlZmV0Y2hpbmcKCQkJaWYgKCBzZXR0aW5ncy5wcmVmZXRjaCA9PT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fZ2V0QmFzZSgpLnJlc2V0KCk7CgkJCX0KCgkJCWlmICggISgkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgfHwKCQkJCXBhdGguaXNTYW1lRG9tYWluKGRvY3VtZW50VXJsLCBhYnNVcmwpKSApIHsKCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBzZXR0aW5ncyApOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBMb2FkIHRoZSBuZXcgY29udGVudC4KCQkJJC5hamF4KHsKCQkJCXVybDogZmlsZVVybCwKCQkJCXR5cGU6IHNldHRpbmdzLnR5cGUsCgkJCQlkYXRhOiBzZXR0aW5ncy5kYXRhLAoJCQkJY29udGVudFR5cGU6IHNldHRpbmdzLmNvbnRlbnRUeXBlLAoJCQkJZGF0YVR5cGU6ICJodG1sIiwKCQkJCXN1Y2Nlc3M6IHRoaXMuX2xvYWRTdWNjZXNzKCBhYnNVcmwsIHRyaWdnZXJEYXRhLCBzZXR0aW5ncywgZGVmZXJyZWQgKSwKCQkJCWVycm9yOiB0aGlzLl9sb2FkRXJyb3IoIGFic1VybCwgdHJpZ2dlckRhdGEsIHNldHRpbmdzLCBkZWZlcnJlZCApCgkJCX0pOwoJCX0sCgoJCV9sb2FkRXJyb3I6IGZ1bmN0aW9uKCBhYnNVcmwsIHRyaWdnZXJEYXRhLCBzZXR0aW5ncywgZGVmZXJyZWQgKSB7CgkJCXJldHVybiAkLnByb3h5KGZ1bmN0aW9uKCB4aHIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duICkgewoJCQkJLy9zZXQgYmFzZSBiYWNrIHRvIGN1cnJlbnQgcGF0aAoJCQkJdGhpcy5fZ2V0QmFzZSgpLnNldCggcGF0aC5nZXQoKSApOwoKCQkJCS8vIEFkZCBlcnJvciBpbmZvIHRvIG91ciB0cmlnZ2VyRGF0YS4KCQkJCXRyaWdnZXJEYXRhLnhociA9IHhocjsKCQkJCXRyaWdnZXJEYXRhLnRleHRTdGF0dXMgPSB0ZXh0U3RhdHVzOwoJCQkJdHJpZ2dlckRhdGEuZXJyb3JUaHJvd24gPSBlcnJvclRocm93bjsKCgkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgdGhlIHBhZ2UgbG9hZCBmYWlsZWQuCgkJCQl2YXIgcGxmRXZlbnQgPSB0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJsb2FkZmFpbGVkIiwgdHJpZ2dlckRhdGEgKTsKCgkJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJCS8vIE5vdGUgdGhhdCBpdCBpcyB0aGUgcmVzcG9uc2liaWxpdHkgb2YgdGhlIGxpc3RlbmVyL2hhbmRsZXIKCQkJCS8vIHRoYXQgY2FsbGVkIHByZXZlbnREZWZhdWx0KCksIHRvIHJlc29sdmUvcmVqZWN0IHRoZQoJCQkJLy8gZGVmZXJyZWQgb2JqZWN0IHdpdGhpbiB0aGUgdHJpZ2dlckRhdGEuCgkJCQlpZiAoIHBsZkV2ZW50LmRlcHJlY2F0ZWRFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSB8fAoJCQkJCXBsZkV2ZW50LmV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQkvLyBSZW1vdmUgbG9hZGluZyBtZXNzYWdlLgoJCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCQkJCQl0aGlzLl9zaG93RXJyb3IoKTsKCQkJCX0KCgkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgc2V0dGluZ3MgKTsKCQkJfSwgdGhpcyk7CgkJfSwKCgkJX2dldFRyYW5zaXRpb25IYW5kbGVyOiBmdW5jdGlvbiggdHJhbnNpdGlvbiApIHsKCQkJdHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uKCB0cmFuc2l0aW9uICk7CgoJCQkvL2ZpbmQgdGhlIHRyYW5zaXRpb24gaGFuZGxlciBmb3IgdGhlIHNwZWNpZmllZCB0cmFuc2l0aW9uLiBJZiB0aGVyZQoJCQkvL2lzbid0IG9uZSBpbiBvdXIgdHJhbnNpdGlvbkhhbmRsZXJzIGRpY3Rpb25hcnksIHVzZSB0aGUgZGVmYXVsdCBvbmUuCgkJCS8vY2FsbCB0aGUgaGFuZGxlciBpbW1lZGlhdGVseSB0byBraWNrLW9mZiB0aGUgdHJhbnNpdGlvbi4KCQkJcmV0dXJuICQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVyc1sgdHJhbnNpdGlvbiBdIHx8ICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlcjsKCQl9LAoKCQkvLyBUT0RPIG1vdmUgaW50byB0cmFuc2l0aW9uIGhhbmRsZXJzPwoJCV90cmlnZ2VyQ3NzVHJhbnNpdGlvbkV2ZW50czogZnVuY3Rpb24oIHRvLCBmcm9tLCBwcmVmaXggKSB7CgkJCXByZWZpeCA9IHByZWZpeCB8fCAiIjsKCgkJCS8vIFRPRE8gZGVjaWRlIGlmIHRoZXNlIGV2ZW50cyBzaG91bGQgaW4gZmFjdCBiZSB0cmlnZ2VyZWQgb24gdGhlIGNvbnRhaW5lcgoJCQlpZiAoIGZyb20gKSB7CgkJCQkvL3RyaWdnZXIgYmVmb3JlIHNob3cvaGlkZSBldmVudHMKCQkJCS8vIFRPRE8gZGVwcmVjYXRlIG5leHRQYWdlIGluIGZhdm9yIG9mIG5leHQKCQkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggcHJlZml4ICsgImhpZGUiLCB7bmV4dFBhZ2U6IHRvfSwgZnJvbSApOwoJCQl9CgoJCQkvLyBUT0RPIGRlcHJlY2F0ZSBwcmV2UGFnZSBpbiBmYXZvciBvZiBwcmV2aW91cwoJCQl0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoIHByZWZpeCArICJzaG93Iiwge3ByZXZQYWdlOiBmcm9tIHx8ICQoICIiICl9LCB0byApOwoJCX0sCgoJCS8vIFRPRE8gbWFrZSBwcml2YXRlIG9uY2UgY2hhbmdlIGhhcyBiZWVuIGRlZmluZWQgaW4gdGhlIHdpZGdldAoJCV9jc3NUcmFuc2l0aW9uOiBmdW5jdGlvbiggdG8sIGZyb20sIG9wdGlvbnMgKSB7CgkJCXZhciB0cmFuc2l0aW9uID0gb3B0aW9ucy50cmFuc2l0aW9uLAoJCQkJcmV2ZXJzZSA9IG9wdGlvbnMucmV2ZXJzZSwKCQkJCWRlZmVycmVkID0gb3B0aW9ucy5kZWZlcnJlZCwKCQkJCVRyYW5zaXRpb25IYW5kbGVyLAoJCQkJcHJvbWlzZTsKCgkJCXRoaXMuX3RyaWdnZXJDc3NUcmFuc2l0aW9uRXZlbnRzKCB0bywgZnJvbSwgImJlZm9yZSIgKTsKCgkJCS8vIFRPRE8gcHV0IHRoaXMgaW4gYSBiaW5kaW5nIHRvIGV2ZW50cyAqb3V0c2lkZSogdGhlIHdpZGdldAoJCQl0aGlzLl9oaWRlTG9hZGluZygpOwoKCQkJVHJhbnNpdGlvbkhhbmRsZXIgPSB0aGlzLl9nZXRUcmFuc2l0aW9uSGFuZGxlciggdHJhbnNpdGlvbiApOwoKCQkJcHJvbWlzZSA9IChuZXcgVHJhbnNpdGlvbkhhbmRsZXIoIHRyYW5zaXRpb24sIHJldmVyc2UsIHRvLCBmcm9tICkpLnRyYW5zaXRpb24oKTsKCgkJCS8vIFRPRE8gdGVtcG9yYXJ5IGFjY29tb2RhdGlvbiBvZiBhcmd1bWVudCBkZWZlcnJlZAoJCQlwcm9taXNlLmRvbmUoZnVuY3Rpb24oKSB7CgkJCQlkZWZlcnJlZC5yZXNvbHZlLmFwcGx5KGRlZmVycmVkLCBhcmd1bWVudHMpOwoJCQl9KTsKCgkJCXByb21pc2UuZG9uZSgkLnByb3h5KGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fdHJpZ2dlckNzc1RyYW5zaXRpb25FdmVudHMoIHRvLCBmcm9tICk7CgkJCX0sIHRoaXMpKTsKCQl9LAoKCQlfcmVsZWFzZVRyYW5zaXRpb25Mb2NrOiBmdW5jdGlvbigpIHsKCQkJLy9yZWxlYXNlIHRyYW5zaXRpb24gbG9jayBzbyBuYXZpZ2F0aW9uIGlzIGZyZWUgYWdhaW4KCQkJcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpOwoJCX0sCgoJCV9yZW1vdmVBY3RpdmVMaW5rQ2xhc3M6IGZ1bmN0aW9uKCBmb3JjZSApIHsKCQkJLy9jbGVhciBvdXQgdGhlIGFjdGl2ZSBidXR0b24gc3RhdGUKCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCBmb3JjZSApOwoJCX0sCgoJCV9sb2FkVXJsOiBmdW5jdGlvbiggdG8sIHRyaWdnZXJEYXRhLCBzZXR0aW5ncyApIHsKCQkJLy8gcHJlc2VydmUgdGhlIG9yaWdpbmFsIHRhcmdldCBhcyB0aGUgZGF0YVVybCB2YWx1ZSB3aWxsIGJlCgkJCS8vIHNpbXBsaWZpZWQgZWcsIHJlbW92aW5nIHVpLXN0YXRlLCBhbmQgcmVtb3ZpbmcgcXVlcnkgcGFyYW1zCgkJCS8vIGZyb20gdGhlIGhhc2ggdGhpcyBpcyBzbyB0aGF0IHVzZXJzIHdobyB3YW50IHRvIHVzZSBxdWVyeQoJCQkvLyBwYXJhbXMgaGF2ZSBhY2Nlc3MgdG8gdGhlbSBpbiB0aGUgZXZlbnQgYmluZGluZ3MgZm9yIHRoZSBwYWdlCgkJCS8vIGxpZmUgY3ljbGUgU2VlIGlzc3VlICM1MDg1CgkJCXNldHRpbmdzLnRhcmdldCA9IHRvOwoJCQlzZXR0aW5ncy5kZWZlcnJlZCA9ICQuRGVmZXJyZWQoKTsKCgkJCXRoaXMubG9hZCggdG8sIHNldHRpbmdzICk7CgoJCQlzZXR0aW5ncy5kZWZlcnJlZC5kb25lKCQucHJveHkoZnVuY3Rpb24oIHVybCwgb3B0aW9ucywgY29udGVudCApIHsKCQkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCgkJCQkvLyBzdG9yZSB0aGUgb3JpZ2luYWwgYWJzb2x1dGUgdXJsIHNvIHRoYXQgaXQgY2FuIGJlIHByb3ZpZGVkCgkJCQkvLyB0byBldmVudHMgaW4gdGhlIHRyaWdnZXJEYXRhIG9mIHRoZSBzdWJzZXF1ZW50IGNoYW5nZVBhZ2UgY2FsbAoJCQkJb3B0aW9ucy5hYnNVcmwgPSB0cmlnZ2VyRGF0YS5hYnNVcmw7CgoJCQkJdGhpcy50cmFuc2l0aW9uKCBjb250ZW50LCB0cmlnZ2VyRGF0YSwgb3B0aW9ucyApOwoJCQl9LCB0aGlzKSk7CgoJCQlzZXR0aW5ncy5kZWZlcnJlZC5mYWlsKCQucHJveHkoZnVuY3Rpb24oLyogdXJsLCBvcHRpb25zICovKSB7CgkJCQl0aGlzLl9yZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsKCQkJCXRoaXMuX3JlbGVhc2VUcmFuc2l0aW9uTG9jaygpOwoJCQkJdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAiY2hhbmdlZmFpbGVkIiwgdHJpZ2dlckRhdGEgKTsKCQkJfSwgdGhpcykpOwoJCX0sCgoJCV90cmlnZ2VyUGFnZUJlZm9yZUNoYW5nZTogZnVuY3Rpb24oIHRvLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MgKSB7CgkJCXZhciBwYmNFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWJlZm9yZWNoYW5nZSIgKTsKCgkJCSQuZXh0ZW5kKHRyaWdnZXJEYXRhLCB7IHRvUGFnZTogdG8sIG9wdGlvbnM6IHNldHRpbmdzIH0pOwoKCQkJLy8gTk9URTogcHJlc2VydmUgdGhlIG9yaWdpbmFsIHRhcmdldCBhcyB0aGUgZGF0YVVybCB2YWx1ZSB3aWxsIGJlCgkJCS8vIHNpbXBsaWZpZWQgZWcsIHJlbW92aW5nIHVpLXN0YXRlLCBhbmQgcmVtb3ZpbmcgcXVlcnkgcGFyYW1zIGZyb20KCQkJLy8gdGhlIGhhc2ggdGhpcyBpcyBzbyB0aGF0IHVzZXJzIHdobyB3YW50IHRvIHVzZSBxdWVyeSBwYXJhbXMgaGF2ZQoJCQkvLyBhY2Nlc3MgdG8gdGhlbSBpbiB0aGUgZXZlbnQgYmluZGluZ3MgZm9yIHRoZSBwYWdlIGxpZmUgY3ljbGUKCQkJLy8gU2VlIGlzc3VlICM1MDg1CgkJCWlmICggJC50eXBlKHRvKSA9PT0gInN0cmluZyIgKSB7CgkJCQkvLyBpZiB0aGUgdG9QYWdlIGlzIGEgc3RyaW5nIHNpbXBseSBjb252ZXJ0IGl0CgkJCQl0cmlnZ2VyRGF0YS5hYnNVcmwgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdG8sIGZpbmRCYXNlV2l0aERlZmF1bHQoKSApOwoJCQl9IGVsc2UgewoJCQkJLy8gaWYgdGhlIHRvUGFnZSBpcyBhIGpRdWVyeSBvYmplY3QgZ3JhYiB0aGUgYWJzb2x1dGUgdXJsIHN0b3JlZAoJCQkJLy8gaW4gdGhlIGxvYWRQYWdlIGNhbGxiYWNrIHdoZXJlIGl0IGV4aXN0cwoJCQkJdHJpZ2dlckRhdGEuYWJzVXJsID0gc2V0dGluZ3MuYWJzVXJsOwoJCQl9CgoJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gY2hhbmdlIHRoZSBjdXJyZW50IHBhZ2UuCgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBwYmNFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCQlpZiAoIHBiY0V2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQlyZXR1cm4gdHJ1ZTsKCQl9LAoKCQljaGFuZ2U6IGZ1bmN0aW9uKCB0bywgb3B0aW9ucyApIHsKCQkJLy8gSWYgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBhIHRyYW5zaXRpb24sIHF1ZXVlIHRoZSBjdXJyZW50IHJlcXVlc3QuCgkJCS8vIFdlJ2xsIGNhbGwgY2hhbmdlUGFnZSgpIG9uY2Ugd2UncmUgZG9uZSB3aXRoIHRoZSBjdXJyZW50IHRyYW5zaXRpb24KCQkJLy8gdG8gc2VydmljZSB0aGUgcmVxdWVzdC4KCQkJaWYgKCBpc1BhZ2VUcmFuc2l0aW9uaW5nICkgewoJCQkJcGFnZVRyYW5zaXRpb25RdWV1ZS51bnNoaWZ0KCBhcmd1bWVudHMgKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIHNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5jaGFuZ2VQYWdlLmRlZmF1bHRzLCBvcHRpb25zICksCgkJCQl0cmlnZ2VyRGF0YSA9IHt9OwoKCQkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBmcm9tUGFnZS4KCQkJc2V0dGluZ3MuZnJvbVBhZ2UgPSBzZXR0aW5ncy5mcm9tUGFnZSB8fCAkLm1vYmlsZS5hY3RpdmVQYWdlOwoKCQkJLy8gaWYgdGhlIHBhZ2UgYmVmb3JlY2hhbmdlIGRlZmF1bHQgaXMgcHJldmVudGVkIHJldHVybiBlYXJseQoJCQlpZiAoICF0aGlzLl90cmlnZ2VyUGFnZUJlZm9yZUNoYW5nZSh0bywgdHJpZ2dlckRhdGEsIHNldHRpbmdzKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gV2UgYWxsb3cgInBhZ2ViZWZvcmVjaGFuZ2UiIG9ic2VydmVycyB0byBtb2RpZnkgdGhlIHRvIGluCgkJCS8vIHRoZSB0cmlnZ2VyIGRhdGEgdG8gYWxsb3cgZm9yIHJlZGlyZWN0cy4gTWFrZSBzdXJlIG91ciB0byBpcwoJCQkvLyB1cGRhdGVkLiBXZSBhbHNvIG5lZWQgdG8gcmUtZXZhbHVhdGUgd2hldGhlciBpdCBpcyBhIHN0cmluZywKCQkJLy8gYmVjYXVzZSBhbiBvYmplY3QgY2FuIGFsc28gYmUgcmVwbGFjZWQgYnkgYSBzdHJpbmcKCQkJdG8gPSB0cmlnZ2VyRGF0YS50b1BhZ2U7CgoJCQkvLyBJZiB0aGUgY2FsbGVyIHBhc3NlZCB1cyBhIHVybCwgY2FsbCBsb2FkUGFnZSgpCgkJCS8vIHRvIG1ha2Ugc3VyZSBpdCBpcyBsb2FkZWQgaW50byB0aGUgRE9NLiBXZSdsbCBsaXN0ZW4KCQkJLy8gdG8gdGhlIHByb21pc2Ugb2JqZWN0IGl0IHJldHVybnMgc28gd2Uga25vdyB3aGVuCgkJCS8vIGl0IGlzIGRvbmUgbG9hZGluZyBvciBpZiBhbiBlcnJvciBvY3VycmVkLgoJCQlpZiAoICQudHlwZSh0bykgPT09ICJzdHJpbmciICkgewoJCQkJLy8gU2V0IHRoZSBpc1BhZ2VUcmFuc2l0aW9uaW5nIGZsYWcgdG8gcHJldmVudCBhbnkgcmVxdWVzdHMgZnJvbQoJCQkJLy8gZW50ZXJpbmcgdGhpcyBtZXRob2Qgd2hpbGUgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBsb2FkaW5nIGEgcGFnZQoJCQkJLy8gb3IgdHJhbnNpdGlvbmluZy4KCQkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSB0cnVlOwoKCQkJCXRoaXMuX2xvYWRVcmwoIHRvLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMudHJhbnNpdGlvbiggdG8sIHRyaWdnZXJEYXRhLCBzZXR0aW5ncyApOwoJCQl9CgkJfSwKCgkJdHJhbnNpdGlvbjogZnVuY3Rpb24oIHRvUGFnZSwgdHJpZ2dlckRhdGEsIHNldHRpbmdzICkgewoJCQl2YXIgZnJvbVBhZ2UsIHVybCwgcGFnZVVybCwgZmlsZVVybCwKCQkJCWFjdGl2ZSwgYWN0aXZlSXNJbml0aWFsUGFnZSwKCQkJCWhpc3RvcnlEaXIsIHBhZ2VUaXRsZSwgaXNEaWFsb2csCgkJCQlhbHJlYWR5VGhlcmUsIG5ld1BhZ2VUaXRsZSwKCQkJCXBhcmFtcywJY3NzVHJhbnNpdGlvbkRlZmVycmVkLAoJCQkJYmVmb3JlVHJhbnNpdGlvbjsKCgkJCS8vIElmIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgYSB0cmFuc2l0aW9uLCBxdWV1ZSB0aGUgY3VycmVudCByZXF1ZXN0LgoJCQkvLyBXZSdsbCBjYWxsIGNoYW5nZVBhZ2UoKSBvbmNlIHdlJ3JlIGRvbmUgd2l0aCB0aGUgY3VycmVudCB0cmFuc2l0aW9uCgkJCS8vIHRvIHNlcnZpY2UgdGhlIHJlcXVlc3QuCgkJCWlmICggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJCS8vIG1ha2Ugc3VyZSB0byBvbmx5IHF1ZXVlIHRoZSB0byBhbmQgc2V0dGluZ3MgdmFsdWVzIHNvIHRoZSBhcmd1bWVudHMKCQkJCS8vIHdvcmsgd2l0aCBhIGNhbGwgdG8gdGhlIGNoYW5nZSBtZXRob2QKCQkJCXBhZ2VUcmFuc2l0aW9uUXVldWUudW5zaGlmdCggW3RvUGFnZSwgc2V0dGluZ3NdICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIERFUFJFQ0FURUQgLSB0aGlzIGNhbGwgb25seSwgaW4gZmF2b3Igb2YgdGhlIGJlZm9yZSB0cmFuc2l0aW9uCgkJCS8vIGlmIHRoZSBwYWdlIGJlZm9yZWNoYW5nZSBkZWZhdWx0IGlzIHByZXZlbnRlZCByZXR1cm4gZWFybHkKCQkJaWYgKCAhdGhpcy5fdHJpZ2dlclBhZ2VCZWZvcmVDaGFuZ2UodG9QYWdlLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBpZiB0aGUgKGNvbnRlbnR8cGFnZSliZWZvcmV0cmFuc2l0aW9uIGRlZmF1bHQgaXMgcHJldmVudGVkIHJldHVybiBlYXJseQoJCQkvLyBOb3RlLCB3ZSBoYXZlIHRvIGNoZWNrIGZvciBib3RoIHRoZSBkZXByZWNhdGVkIGFuZCBuZXcgZXZlbnRzCgkJCWJlZm9yZVRyYW5zaXRpb24gPSB0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJiZWZvcmV0cmFuc2l0aW9uIiwgdHJpZ2dlckRhdGEgKTsKCQkJaWYgKGJlZm9yZVRyYW5zaXRpb24uZGVwcmVjYXRlZEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8CgkJCQliZWZvcmVUcmFuc2l0aW9uLmV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBTZXQgdGhlIGlzUGFnZVRyYW5zaXRpb25pbmcgZmxhZyB0byBwcmV2ZW50IGFueSByZXF1ZXN0cyBmcm9tCgkJCS8vIGVudGVyaW5nIHRoaXMgbWV0aG9kIHdoaWxlIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgbG9hZGluZyBhIHBhZ2UKCQkJLy8gb3IgdHJhbnNpdGlvbmluZy4KCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IHRydWU7CgoJCQkvLyBJZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGZpcnN0LXBhZ2Ugb2YgdGhlIGFwcGxpY2F0aW9uLCB3ZSBuZWVkIHRvIG1ha2UKCQkJLy8gc3VyZSBzZXR0aW5ncy5kYXRhVXJsIGlzIHNldCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgdXJsLiBUaGlzIGFsbG93cwoJCQkvLyB1cyB0byBhdm9pZCBnZW5lcmF0aW5nIGEgZG9jdW1lbnQgdXJsIHdpdGggYW4gaWQgaGFzaCBpbiB0aGUgY2FzZSB3aGVyZSB0aGUKCQkJLy8gZmlyc3QtcGFnZSBvZiB0aGUgZG9jdW1lbnQgaGFzIGFuIGlkIGF0dHJpYnV0ZSBzcGVjaWZpZWQuCgkJCWlmICggdG9QYWdlWyAwIF0gPT09ICQubW9iaWxlLmZpcnN0UGFnZVsgMCBdICYmICFzZXR0aW5ncy5kYXRhVXJsICkgewoJCQkJc2V0dGluZ3MuZGF0YVVybCA9IGRvY3VtZW50VXJsLmhyZWZOb0hhc2g7CgkJCX0KCgkJCS8vIFRoZSBjYWxsZXIgcGFzc2VkIHVzIGEgcmVhbCBwYWdlIERPTSBlbGVtZW50LiBVcGRhdGUgb3VyCgkJCS8vIGludGVybmFsIHN0YXRlIGFuZCB0aGVuIHRyaWdnZXIgYSB0cmFuc2l0aW9uIHRvIHRoZSBwYWdlLgoJCQlmcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlOwoJCQl1cmwgPSAoIHNldHRpbmdzLmRhdGFVcmwgJiYgcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKHNldHRpbmdzLmRhdGFVcmwpICkgfHwKCQkJCXRvUGFnZS5qcW1EYXRhKCAidXJsIiApOwoKCQkJLy8gVGhlIHBhZ2VVcmwgdmFyIGlzIHVzdWFsbHkgdGhlIHNhbWUgYXMgdXJsLCBleGNlcHQgd2hlbiB1cmwgaXMgb2JzY3VyZWQKCQkJLy8gYXMgYSBkaWFsb2cgdXJsLiBwYWdlVXJsIGFsd2F5cyBjb250YWlucyB0aGUgZmlsZSBwYXRoCgkJCXBhZ2VVcmwgPSB1cmw7CgkJCWZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCB1cmwgKTsKCQkJYWN0aXZlID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKTsKCQkJYWN0aXZlSXNJbml0aWFsUGFnZSA9IHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDA7CgkJCWhpc3RvcnlEaXIgPSAwOwoJCQlwYWdlVGl0bGUgPSBkb2N1bWVudC50aXRsZTsKCQkJaXNEaWFsb2cgPSAoIHNldHRpbmdzLnJvbGUgPT09ICJkaWFsb2ciIHx8IHRvUGFnZS5qcW1EYXRhKCAicm9sZSIgKSA9PT0gImRpYWxvZyIgKSAmJiB0b1BhZ2UuanFtRGF0YSggImRpYWxvZyIgKSAhPT0gdHJ1ZTsKCgkJCS8vIEJ5IGRlZmF1bHQsIHdlIHByZXZlbnQgY2hhbmdlUGFnZSByZXF1ZXN0cyB3aGVuIHRoZSBmcm9tUGFnZSBhbmQgdG9QYWdlCgkJCS8vIGFyZSB0aGUgc2FtZSBlbGVtZW50LCBidXQgZm9sa3MgdGhhdCBnZW5lcmF0ZSBjb250ZW50IG1hbnVhbGx5L2R5bmFtaWNhbGx5CgkJCS8vIGFuZCByZXVzZSBwYWdlcyB3YW50IHRvIGJlIGFibGUgdG8gdHJhbnNpdGlvbiB0byB0aGUgc2FtZSBwYWdlLiBUbyBhbGxvdwoJCQkvLyB0aGlzLCB0aGV5IHdpbGwgbmVlZCB0byBjaGFuZ2UgdGhlIGRlZmF1bHQgdmFsdWUgb2YgYWxsb3dTYW1lUGFnZVRyYW5zaXRpb24KCQkJLy8gdG8gdHJ1ZSwgKk9SKiwgcGFzcyBpdCBpbiBhcyBhbiBvcHRpb24gd2hlbiB0aGV5IG1hbnVhbGx5IGNhbGwgY2hhbmdlUGFnZSgpLgoJCQkvLyBJdCBzaG91bGQgYmUgbm90ZWQgdGhhdCBvdXIgZGVmYXVsdCB0cmFuc2l0aW9uIGFuaW1hdGlvbnMgYXNzdW1lIHRoYXQgdGhlCgkJCS8vIGZvcm1QYWdlIGFuZCB0b1BhZ2UgYXJlIGRpZmZlcmVudCBlbGVtZW50cywgc28gdGhleSBtYXkgYmVoYXZlIHVuZXhwZWN0ZWRseS4KCQkJLy8gSXQgaXMgdXAgdG8gdGhlIGRldmVsb3BlciB0aGF0IHR1cm5zIG9uIHRoZSBhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbmEgb3B0aW9uCgkJCS8vIHRvIGVpdGhlciB0dXJuIG9mZiB0cmFuc2l0aW9uIGFuaW1hdGlvbnMsIG9yIG1ha2Ugc3VyZSB0aGF0IGFuIGFwcHJvcHJpYXRlCgkJCS8vIGFuaW1hdGlvbiB0cmFuc2l0aW9uIGlzIHVzZWQuCgkJCWlmICggZnJvbVBhZ2UgJiYgZnJvbVBhZ2VbMF0gPT09IHRvUGFnZVswXSAmJiAhc2V0dGluZ3MuYWxsb3dTYW1lUGFnZVRyYW5zaXRpb24gKSB7CgkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJCQl0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJ0cmFuc2l0aW9uIiwgdHJpZ2dlckRhdGEgKTsKCQkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAicGFnZWNoYW5nZSIsIHRyaWdnZXJEYXRhICk7CgoJCQkJLy8gRXZlbiBpZiB0aGVyZSBpcyBubyBwYWdlIGNoYW5nZSB0byBiZSBkb25lLCB3ZSBzaG91bGQga2VlcCB0aGUgdXJsSGlzdG9yeQoJCQkJLy8gaW4gc3luYyB3aXRoIHRoZSBoYXNoIGNoYW5nZXMKCQkJCWlmICggc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCQkJdXJsSGlzdG9yeS5kaXJlY3QoeyB1cmw6IHVybCB9KTsKCQkJCX0KCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoZSBwYWdlIHdlIGFyZSBnaXZlbiBoYXMgYWxyZWFkeSBiZWVuIGVuaGFuY2VkLgoJCQl0b1BhZ2UucGFnZSh7IHJvbGU6IHNldHRpbmdzLnJvbGUgfSk7CgoJCQkvLyBJZiB0aGUgY2hhbmdlUGFnZSByZXF1ZXN0IHdhcyBzZW50IGZyb20gYSBoYXNoQ2hhbmdlIGV2ZW50LCBjaGVjayB0byBzZWUgaWYgdGhlCgkJCS8vIHBhZ2UgaXMgYWxyZWFkeSB3aXRoaW4gdGhlIHVybEhpc3Rvcnkgc3RhY2suIElmIHNvLCB3ZSdsbCBhc3N1bWUgdGhlIHVzZXIgaGl0CgkJCS8vIHRoZSBmb3J3YXJkL2JhY2sgYnV0dG9uIGFuZCB3aWxsIHRyeSB0byBtYXRjaCB0aGUgdHJhbnNpdGlvbiBhY2NvcmRpbmdseS4KCQkJaWYgKCBzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJCWhpc3RvcnlEaXIgPSBzZXR0aW5ncy5kaXJlY3Rpb24gPT09ICJiYWNrIiA/IC0xIDogMTsKCQkJfQoKCQkJLy8gS2lsbCB0aGUga2V5Ym9hcmQuCgkJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBzdG9wIGNyYXdsaW5nIHRoZSBlbnRpcmUgZG9jdW1lbnQgdG8ga2lsbCBmb2N1cy4gSW5zdGVhZCwKCQkJLy8gICAgICAgICAgICB3ZSBzaG91bGQgYmUgdHJhY2tpbmcgZm9jdXMgd2l0aCBhIGRlbGVnYXRlKCkgaGFuZGxlciBzbyB3ZSBhbHJlYWR5IGhhdmUKCQkJLy8gICAgICAgICAgICB0aGUgZWxlbWVudCBpbiBoYW5kIGF0IHRoaXMgcG9pbnQuCgkJCS8vIFdyYXAgdGhpcyBpbiBhIHRyeS9jYXRjaCBibG9jayBzaW5jZSBJRTkgdGhyb3cgIlVuc3BlY2lmaWVkIGVycm9yIiBpZiBkb2N1bWVudC5hY3RpdmVFbGVtZW50CgkJCS8vIGlzIHVuZGVmaW5lZCB3aGVuIHdlIGFyZSBpbiBhbiBJRnJhbWUuCgkJCXRyeSB7CgkJCQlpZiAoIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgJiYgZG9jdW1lbnQuYWN0aXZlRWxlbWVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAiYm9keSIgKSB7CgkJCQkJJCggZG9jdW1lbnQuYWN0aXZlRWxlbWVudCApLmJsdXIoKTsKCQkJCX0gZWxzZSB7CgkJCQkJJCggImlucHV0OmZvY3VzLCB0ZXh0YXJlYTpmb2N1cywgc2VsZWN0OmZvY3VzIiApLmJsdXIoKTsKCQkJCX0KCQkJfSBjYXRjaCggZSApIHt9CgoJCQkvLyBSZWNvcmQgd2hldGhlciB3ZSBhcmUgYXQgYSBwbGFjZSBpbiBoaXN0b3J5IHdoZXJlIGEgZGlhbG9nIHVzZWQgdG8gYmUgLSBpZiBzbywgZG8gbm90IGFkZCBhIG5ldyBoaXN0b3J5IGVudHJ5IGFuZCBkbyBub3QgY2hhbmdlIHRoZSBoYXNoIGVpdGhlcgoJCQlhbHJlYWR5VGhlcmUgPSBmYWxzZTsKCgkJCS8vIElmIHdlJ3JlIGRpc3BsYXlpbmcgdGhlIHBhZ2UgYXMgYSBkaWFsb2csIHdlIGRvbid0IHdhbnQgdGhlIHVybAoJCQkvLyBmb3IgdGhlIGRpYWxvZyBjb250ZW50IHRvIGJlIHVzZWQgaW4gdGhlIGhhc2guIEluc3RlYWQsIHdlIHdhbnQKCQkJLy8gdG8gYXBwZW5kIHRoZSBkaWFsb2dIYXNoS2V5IHRvIHRoZSB1cmwgb2YgdGhlIGN1cnJlbnQgcGFnZS4KCQkJaWYgKCBpc0RpYWxvZyAmJiBhY3RpdmUgKSB7CgkJCQkvLyBvbiB0aGUgaW5pdGlhbCBwYWdlIGxvYWQgYWN0aXZlLnVybCBpcyB1bmRlZmluZWQgYW5kIGluIHRoYXQgY2FzZSBzaG91bGQKCQkJCS8vIGJlIGFuIGVtcHR5IHN0cmluZy4gTW92aW5nIHRoZSB1bmRlZmluZWQgLT4gZW1wdHkgc3RyaW5nIGJhY2sgaW50bwoJCQkJLy8gdXJsSGlzdG9yeS5hZGROZXcgc2VlbWVkIGltcHJ1ZGVudCBnaXZlbiB1bmRlZmluZWQgYmV0dGVyIHJlcHJlc2VudHMKCQkJCS8vIHRoZSB1cmwgc3RhdGUKCgkJCQkvLyBJZiB3ZSBhcmUgYXQgYSBwbGFjZSBpbiBoaXN0b3J5IHRoYXQgb25jZSBiZWxvbmdlZCB0byBhIGRpYWxvZywgcmV1c2UKCQkJCS8vIHRoaXMgc3RhdGUgd2l0aG91dCBhZGRpbmcgdG8gdXJsSGlzdG9yeSBhbmQgd2l0aG91dCBtb2RpZnlpbmcgdGhlIGhhc2guCgkJCQkvLyBIb3dldmVyLCBpZiBhIGRpYWxvZyBpcyBhbHJlYWR5IGRpc3BsYXllZCBhdCB0aGlzIHBvaW50LCBhbmQgd2UncmUKCQkJCS8vIGFib3V0IHRvIGRpc3BsYXkgYW5vdGhlciBkaWFsb2csIHRoZW4gd2UgbXVzdCBhZGQgYW5vdGhlciBoYXNoIGFuZAoJCQkJLy8gaGlzdG9yeSBlbnRyeSBvbiB0b3Agc28gdGhhdCBvbmUgbWF5IG5hdmlnYXRlIGJhY2sgdG8gdGhlIG9yaWdpbmFsIGRpYWxvZwoJCQkJaWYgKCBhY3RpdmUudXJsICYmCgkJCQkJIGFjdGl2ZS51cmwuaW5kZXhPZiggZGlhbG9nSGFzaEtleSApID4gLTEgJiYKCQkJCQkgJC5tb2JpbGUuYWN0aXZlUGFnZSAmJgoJCQkJCSAhJC5tb2JpbGUuYWN0aXZlUGFnZS5oYXNDbGFzcyggInVpLWRpYWxvZyIgKSAmJgoJCQkJCSB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCApIHsKCQkJCQlzZXR0aW5ncy5jaGFuZ2VIYXNoID0gZmFsc2U7CgkJCQkJYWxyZWFkeVRoZXJlID0gdHJ1ZTsKCQkJCX0KCgkJCQkvLyBOb3JtYWxseSwgd2UgdGFjayBvbiBhIGRpYWxvZyBoYXNoIGtleSwgYnV0IGlmIHRoaXMgaXMgdGhlIGxvY2F0aW9uIG9mIGEgc3RhbGUgZGlhbG9nLAoJCQkJLy8gd2UgcmV1c2UgdGhlIFVSTCBmcm9tIHRoZSBlbnRyeQoJCQkJdXJsID0gKCBhY3RpdmUudXJsIHx8ICIiICk7CgoJCQkJLy8gYWNjb3VudCBmb3IgYWJzb2x1dGUgdXJscyBpbnN0ZWFkIG9mIGp1c3QgcmVsYXRpdmUgdXJscyB1c2UgYXMgaGFzaGVzCgkJCQlpZiAoICFhbHJlYWR5VGhlcmUgJiYgdXJsLmluZGV4T2YoIiMiKSA+IC0xICkgewoJCQkJCXVybCArPSBkaWFsb2dIYXNoS2V5OwoJCQkJfSBlbHNlIHsKCQkJCQl1cmwgKz0gIiMiICsgZGlhbG9nSGFzaEtleTsKCQkJCX0KCgkJCQkvLyB0YWNrIG9uIGFub3RoZXIgZGlhbG9nSGFzaEtleSBpZiB0aGlzIGlzIHRoZSBzYW1lIGFzIHRoZSBpbml0aWFsIGhhc2gKCQkJCS8vIHRoaXMgbWFrZXMgc3VyZSB0aGF0IGEgaGlzdG9yeSBlbnRyeSBpcyBjcmVhdGVkIGZvciB0aGlzIGRpYWxvZwoJCQkJaWYgKCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID09PSAwICYmIHVybCA9PT0gdXJsSGlzdG9yeS5pbml0aWFsRHN0ICkgewoJCQkJCXVybCArPSBkaWFsb2dIYXNoS2V5OwoJCQkJfQoJCQl9CgoJCQkvLyBpZiB0aXRsZSBlbGVtZW50IHdhc24ndCBmb3VuZCwgdHJ5IHRoZSBwYWdlIGRpdiBkYXRhIGF0dHIgdG9vCgkJCS8vIElmIHRoaXMgaXMgYSBkZWVwLWxpbmsgb3IgYSByZWxvYWQgKCBhY3RpdmUgPT09IHVuZGVmaW5lZCApIHRoZW4ganVzdCB1c2UgcGFnZVRpdGxlCgkJCW5ld1BhZ2VUaXRsZSA9ICggIWFjdGl2ZSApPyBwYWdlVGl0bGUgOiB0b1BhZ2UuanFtRGF0YSggInRpdGxlIiApIHx8IHRvUGFnZS5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLmZpbmQoICIudWktdGl0bGUiICkudGV4dCgpOwoJCQlpZiAoICEhbmV3UGFnZVRpdGxlICYmIHBhZ2VUaXRsZSA9PT0gZG9jdW1lbnQudGl0bGUgKSB7CgkJCQlwYWdlVGl0bGUgPSBuZXdQYWdlVGl0bGU7CgkJCX0KCQkJaWYgKCAhdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJCXRvUGFnZS5qcW1EYXRhKCAidGl0bGUiLCBwYWdlVGl0bGUgKTsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSB0cmFuc2l0aW9uIGRlZmluZWQuCgkJCXNldHRpbmdzLnRyYW5zaXRpb24gPSBzZXR0aW5ncy50cmFuc2l0aW9uIHx8CgkJCQkoICggaGlzdG9yeURpciAmJiAhYWN0aXZlSXNJbml0aWFsUGFnZSApID8gYWN0aXZlLnRyYW5zaXRpb24gOiB1bmRlZmluZWQgKSB8fAoJCQkJKCBpc0RpYWxvZyA/ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uIDogJC5tb2JpbGUuZGVmYXVsdFBhZ2VUcmFuc2l0aW9uICk7CgoJCQkvL2FkZCBwYWdlIHRvIGhpc3Rvcnkgc3RhY2sgaWYgaXQncyBub3QgYmFjayBvciBmb3J3YXJkCgkJCWlmICggIWhpc3RvcnlEaXIgJiYgYWxyZWFkeVRoZXJlICkgewoJCQkJdXJsSGlzdG9yeS5nZXRBY3RpdmUoKS5wYWdlVXJsID0gcGFnZVVybDsKCQkJfQoKCQkJLy8gU2V0IHRoZSBsb2NhdGlvbiBoYXNoLgoJCQlpZiAoIHVybCAmJiAhc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgoJCQkJLy8gcmVidWlsZGluZyB0aGUgaGFzaCBoZXJlIHNpbmNlIHdlIGxvb3NlIGl0IGVhcmxpZXIgb24KCQkJCS8vIFRPRE8gcHJlc2VydmUgdGhlIG9yaWdpbmFsbHkgcGFzc2VkIGluIHBhdGgKCQkJCWlmICggIXBhdGguaXNQYXRoKCB1cmwgKSAmJiB1cmwuaW5kZXhPZiggIiMiICkgPCAwICkgewoJCQkJCXVybCA9ICIjIiArIHVybDsKCQkJCX0KCgkJCQkvLyBUT0RPIHRoZSBwcm9wZXJ0eSBuYW1lcyBoZXJlIGFyZSBqdXN0IHNpbGx5CgkJCQlwYXJhbXMgPSB7CgkJCQkJdHJhbnNpdGlvbjogc2V0dGluZ3MudHJhbnNpdGlvbiwKCQkJCQl0aXRsZTogcGFnZVRpdGxlLAoJCQkJCXBhZ2VVcmw6IHBhZ2VVcmwsCgkJCQkJcm9sZTogc2V0dGluZ3Mucm9sZQoJCQkJfTsKCgkJCQlpZiAoIHNldHRpbmdzLmNoYW5nZUhhc2ggIT09IGZhbHNlICYmICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICkgewoJCQkJCSQubW9iaWxlLm5hdmlnYXRlKCB1cmwsIHBhcmFtcywgdHJ1ZSk7CgkJCQl9IGVsc2UgaWYgKCB0b1BhZ2VbIDAgXSAhPT0gJC5tb2JpbGUuZmlyc3RQYWdlWyAwIF0gKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hZGQoIHVybCwgcGFyYW1zICk7CgkJCQl9CgkJCX0KCgkJCS8vc2V0IHBhZ2UgdGl0bGUKCQkJZG9jdW1lbnQudGl0bGUgPSBwYWdlVGl0bGU7CgoJCQkvL3NldCAidG9QYWdlIiBhcyBhY3RpdmVQYWdlCgkJCSQubW9iaWxlLmFjdGl2ZVBhZ2UgPSB0b1BhZ2U7CgoJCQkvLyBJZiB3ZSdyZSBuYXZpZ2F0aW5nIGJhY2sgaW4gdGhlIFVSTCBoaXN0b3J5LCBzZXQgcmV2ZXJzZSBhY2NvcmRpbmdseS4KCQkJc2V0dGluZ3MucmV2ZXJzZSA9IHNldHRpbmdzLnJldmVyc2UgfHwgaGlzdG9yeURpciA8IDA7CgoJCQljc3NUcmFuc2l0aW9uRGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgoJCQl0aGlzLl9jc3NUcmFuc2l0aW9uKHRvUGFnZSwgZnJvbVBhZ2UsIHsKCQkJCXRyYW5zaXRpb246IHNldHRpbmdzLnRyYW5zaXRpb24sCgkJCQlyZXZlcnNlOiBzZXR0aW5ncy5yZXZlcnNlLAoJCQkJZGVmZXJyZWQ6IGNzc1RyYW5zaXRpb25EZWZlcnJlZAoJCQl9KTsKCgkJCWNzc1RyYW5zaXRpb25EZWZlcnJlZC5kb25lKCQucHJveHkoZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20sIGFscmVhZHlGb2N1c2VkICkgewoJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCk7CgoJCQkJLy9pZiB0aGVyZSdzIGEgZHVwbGljYXRlQ2FjaGVkUGFnZSwgcmVtb3ZlIGl0IGZyb20gdGhlIERPTSBub3cgdGhhdCBpdCdzIGhpZGRlbgoJCQkJaWYgKCBzZXR0aW5ncy5kdXBsaWNhdGVDYWNoZWRQYWdlICkgewoJCQkJCXNldHRpbmdzLmR1cGxpY2F0ZUNhY2hlZFBhZ2UucmVtb3ZlKCk7CgkJCQl9CgoJCQkJLy8gZGVzcGl0ZSB2aXNpYmlsaXR5OiBoaWRkZW4gYWRkcmVzc2VzIGlzc3VlICMyOTY1CgkJCQkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzI5NjUKCQkJCWlmICggIWFscmVhZHlGb2N1c2VkICkgewoJCQkJCSQubW9iaWxlLmZvY3VzUGFnZSggdG9QYWdlICk7CgkJCQl9CgoJCQkJcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpOwoJCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJwYWdlY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCQkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggInRyYW5zaXRpb24iLCB0cmlnZ2VyRGF0YSApOwoJCQl9LCB0aGlzKSk7CgkJfQoJCS8vIFRPRE8gcmVzZXRBY3RpdmVQYWdlSGVpZ2h0CgkJLy8gVE9ETyBjaGFuZ2VQYWdlCgl9KTsKCgkkLm1vYmlsZS5sb2FkUGFnZSA9IGZ1bmN0aW9uKCB1cmwsIG9wdHMgKSB7CgkJdmFyIGNvbnRhaW5lcjsKCgkJb3B0cyA9IG9wdHMgfHwge307CgkJY29udGFpbmVyID0gKCBvcHRzLnBhZ2VDb250YWluZXIgfHwgJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkvLyBjcmVhdGUgdGhlIGRlZmVycmVkIHRoYXQgd2lsbCBiZSBzdXBwbGllZCB0byBsb2FkUGFnZSBjYWxsZXJzCgkJLy8gYW5kIHJlc29sdmVkIGJ5IHRoZSBjb250ZW50IHdpZGdldCdzIGxvYWQgbWV0aG9kCgkJb3B0cy5kZWZlcnJlZCA9ICQuRGVmZXJyZWQoKTsKCgkJLy8gUHJlZmVycmluZyB0byBhbGxvdyBleGNlcHRpb25zIGZvciB1bmluaXRpYWxpemVkIG9wdHMucGFnZUNvbnRhaW5lcgoJCS8vIHdpZGdldHMgc28gd2Uga25vdyBpZiB3ZSBuZWVkIHRvIGZvcmNlIGluaXQgaGVyZSBmb3IgdXNlcnMKCQljb250YWluZXIuY29udGVudCggImxvYWQiLCB1cmwsIG9wdHMgKTsKCgkJLy8gcHJvdmlkZSB0aGUgZGVmZXJyZWQKCQlyZXR1cm4gb3B0cy5kZWZlcnJlZC5wcm9taXNlKCk7Cgl9OwoKCS8vZGVmaW5lIHZhcnMgZm9yIGludGVyYWwgdXNlCgl2YXIgJHdpbmRvdyA9ICQubW9iaWxlLndpbmRvdywKCQkkaGVhZCA9ICQoICJoZWFkIiApLAoKCQkvLyBOT1RFOiBwYXRoIGV4dGVuc2lvbnMgZGVwZW5kZW50IG9uIGNvcmUgYXR0cmlidXRlcy4gTW92ZWQgaGVyZSB0byByZW1vdmUgZGVwcyBmcm9tCgkJLy8gICAgICAgJC5tb2JpbGUucGF0aCBkZWZpbml0aW9uCgkJcGF0aCA9ICQuZXh0ZW5kKCQubW9iaWxlLnBhdGgsIHsKCgkJCS8vcmV0dXJuIHRoZSBzdWJzdHJpbmcgb2YgYSBmaWxlcGF0aCBiZWZvcmUgdGhlIHN1Yi1wYWdlIGtleSwgZm9yIG1ha2luZyBhIHNlcnZlciByZXF1ZXN0CgkJCWdldEZpbGVQYXRoOiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCXZhciBzcGxpdGtleSA9ICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXk7CgkJCQlyZXR1cm4gcGF0aCAmJiBwYXRoLnNwbGl0KCBzcGxpdGtleSApWzBdLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCX0sCgoJCQkvL2NoZWNrIGlmIHRoZSBzcGVjaWZpZWQgdXJsIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgbWFpbiBhcHBsaWNhdGlvbiBkb2N1bWVudC4KCQkJaXNGaXJzdFBhZ2VVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBXZSBvbmx5IGRlYWwgd2l0aCBhYnNvbHV0ZSBwYXRocy4KCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgdGhpcy5kb2N1bWVudEJhc2UgKSApLAoKCQkJCQkvLyBEb2VzIHRoZSB1cmwgaGF2ZSB0aGUgc2FtZSBwYXRoIGFzIHRoZSBkb2N1bWVudD8KCQkJCQlzYW1lUGF0aCA9IHUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudFVybC5ocmVmTm9IYXNoIHx8ICggdGhpcy5kb2N1bWVudEJhc2VEaWZmZXJzICYmIHUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApLAoKCQkJCQkvLyBHZXQgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCQlmcCA9ICQubW9iaWxlLmZpcnN0UGFnZSwKCgoKCQkJCQkvLyBHZXQgdGhlIGlkIG9mIHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQgaWYgaXQgaGFzIG9uZS4KCQkJCQlmcElkID0gZnAgJiYgZnBbMF0gPyBmcFswXS5pZCA6IHVuZGVmaW5lZDsKCgkJCQkvLyBUaGUgdXJsIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpZiB0aGUgcGF0aCBtYXRjaGVzIHRoZSBkb2N1bWVudCBhbmQKCQkJCS8vIGl0IGVpdGhlciBoYXMgbm8gaGFzaCB2YWx1ZSwgb3IgdGhlIGhhc2ggaXMgZXhhY3RseSBlcXVhbCB0byB0aGUgaWQgb2YgdGhlCgkJCQkvLyBmaXJzdCBwYWdlIGVsZW1lbnQuCgkJCQlyZXR1cm4gc2FtZVBhdGggJiYgKCAhdS5oYXNoIHx8IHUuaGFzaCA9PT0gIiMiIHx8ICggZnBJZCAmJiB1Lmhhc2gucmVwbGFjZSggL14jLywgIiIgKSA9PT0gZnBJZCApICk7CgkJCX0sCgoJCQkvLyBTb21lIGVtYmVkZGVkIGJyb3dzZXJzLCBsaWtlIHRoZSB3ZWIgdmlldyBpbiBQaG9uZSBHYXAsIGFsbG93IGNyb3NzLWRvbWFpbiBYSFIKCQkJLy8gcmVxdWVzdHMgaWYgdGhlIGRvY3VtZW50IGRvaW5nIHRoZSByZXF1ZXN0IHdhcyBsb2FkZWQgdmlhIHRoZSBmaWxlOi8vIHByb3RvY29sLgoJCQkvLyBUaGlzIGlzIHVzdWFsbHkgdG8gYWxsb3cgdGhlIGFwcGxpY2F0aW9uIHRvICJwaG9uZSBob21lIiBhbmQgZmV0Y2ggYXBwIHNwZWNpZmljCgkJCS8vIGRhdGEuIFdlIG5vcm1hbGx5IGxldCB0aGUgYnJvd3NlciBoYW5kbGUgZXh0ZXJuYWwvY3Jvc3MtZG9tYWluIHVybHMsIGJ1dCBpZiB0aGUKCQkJLy8gYWxsb3dDcm9zc0RvbWFpblBhZ2VzIG9wdGlvbiBpcyB0cnVlLCB3ZSB3aWxsIGFsbG93IGNyb3NzLWRvbWFpbiBodHRwL2h0dHBzCgkJCS8vIHJlcXVlc3RzIHRvIGdvIHRocm91Z2ggb3VyIHBhZ2UgbG9hZGluZyBsb2dpYy4KCQkJaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3Q6IGZ1bmN0aW9uKCBkb2NVcmwsIHJlcVVybCApIHsKCQkJCXJldHVybiAkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgJiYKCQkJCQkoZG9jVXJsLnByb3RvY29sID09PSAiZmlsZToiIHx8IGRvY1VybC5wcm90b2NvbCA9PT0gImNvbnRlbnQ6IikgJiYKCQkJCQlyZXFVcmwuc2VhcmNoKCAvXmh0dHBzPzovICkgIT09IC0xOwoJCQl9CgkJfSksCgoJCS8vIHVzZWQgdG8gdHJhY2sgbGFzdCB2Y2xpY2tlZCBlbGVtZW50IHRvIG1ha2Ugc3VyZSBpdHMgdmFsdWUgaXMgYWRkZWQgdG8gZm9ybSBkYXRhCgkJJGxhc3RWQ2xpY2tlZCA9IG51bGwsCgoJCS8vd2lsbCBiZSBkZWZpbmVkIHdoZW4gYSBsaW5rIGlzIGNsaWNrZWQgYW5kIGdpdmVuIGFuIGFjdGl2ZSBjbGFzcwoJCSRhY3RpdmVDbGlja2VkTGluayA9IG51bGwsCgoJCS8vIHJlc29sdmVkIG9uIGRvbXJlYWR5CgkJZG9tcmVhZHlEZWZlcnJlZCA9ICQuRGVmZXJyZWQoKSwKCgkJLy91cmxIaXN0b3J5IGlzIHB1cmVseSBoZXJlIHRvIG1ha2UgZ3Vlc3NlcyBhdCB3aGV0aGVyIHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9uIHdhcyBjbGlja2VkCgkJLy9hbmQgcHJvdmlkZSBhbiBhcHByb3ByaWF0ZSB0cmFuc2l0aW9uCgkJdXJsSGlzdG9yeSA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnksCgoJCS8vcXVldWUgdG8gaG9sZCBzaW11bHRhbmlvdXMgcGFnZSB0cmFuc2l0aW9ucwoJCXBhZ2VUcmFuc2l0aW9uUXVldWUgPSBbXSwKCgkJLy9pbmRpY2F0ZXMgd2hldGhlciBvciBub3QgcGFnZSBpcyBpbiBwcm9jZXNzIG9mIHRyYW5zaXRpb25pbmcKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2UsCgoJCS8vbm9uc2Vuc2UgaGFzaCBjaGFuZ2Uga2V5IGZvciBkaWFsb2dzLCBzbyB0aGV5IGNyZWF0ZSBhIGhpc3RvcnkgZW50cnkKCQlkaWFsb2dIYXNoS2V5ID0gIiZ1aS1zdGF0ZT1kaWFsb2ciLAoKCQkvL2V4aXN0aW5nIGJhc2UgdGFnPwoJCSRiYXNlID0gJGhlYWQuY2hpbGRyZW4oICJiYXNlIiApLAoKCQkvL3R1Y2sgYXdheSB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgVVJMIG1pbnVzIGFueSBmcmFnbWVudC4KCQlkb2N1bWVudFVybCA9IHBhdGguZG9jdW1lbnRVcmwsCgoJCS8vaWYgdGhlIGRvY3VtZW50IGhhcyBhbiBlbWJlZGRlZCBiYXNlIHRhZywgZG9jdW1lbnRCYXNlIGlzIHNldCB0byBpdHMKCQkvL2luaXRpYWwgdmFsdWUuIElmIGEgYmFzZSB0YWcgZG9lcyBub3QgZXhpc3QsIHRoZW4gd2UgZGVmYXVsdCB0byB0aGUgZG9jdW1lbnRVcmwuCgkJZG9jdW1lbnRCYXNlID0gcGF0aC5kb2N1bWVudEJhc2UsCgoJCS8vIGJhc2UgZWxlbWVudCBtYW5hZ2VtZW50LCBkZWZpbmVkIGRlcGVuZGluZyBvbiBkeW5hbWljIGJhc2UgdGFnIHN1cHBvcnQKCQkvLyBUT0RPIG1vdmUgdG8gZXh0ZXJuYWwgd2lkZ2V0CgkJYmFzZSA9IHsKCQkJLy9kZWZpbmUgYmFzZSBlbGVtZW50LCBmb3IgdXNlIGluIHJvdXRpbmcgYXNzZXQgdXJscyB0aGF0IGFyZSByZWZlcmVuY2VkIGluIEFqYXgtcmVxdWVzdGVkIG1hcmt1cAoJCQllbGVtZW50OiAoICRiYXNlLmxlbmd0aCA/ICRiYXNlIDogJCggIjxiYXNlPiIsIHsgaHJlZjogZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggfSApLnByZXBlbmRUbyggJGhlYWQgKSApLAoKCQkJbGlua1NlbGVjdG9yOiAiW3NyY10sIGxpbmtbaHJlZl0sIGFbcmVsPSdleHRlcm5hbCddLCA6anFtRGF0YShhamF4PSdmYWxzZScpLCBhW3RhcmdldF0iLAoKCQkJLy9zZXQgdGhlIGdlbmVyYXRlZCBCQVNFIGVsZW1lbnQncyBocmVmIGF0dHJpYnV0ZSB0byBhIG5ldyBwYWdlJ3MgYmFzZSBwYXRoCgkJCXNldDogZnVuY3Rpb24oIGhyZWYgKSB7CgkJCQkvLyB3ZSBzaG91bGQgZG8gbm90aGluZyBpZiB0aGUgdXNlciB3YW50cyB0byBtYW5hZ2UgdGhlaXIgdXJsIGJhc2UgbWFudWFsbHkKCQkJCWlmICggISQubW9iaWxlLmR5bmFtaWNCYXNlRW5hYmxlZCApewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQkvLyB3ZSBzaG91bGQgdXNlIHRoZSBiYXNlIHRhZyBpZiB3ZSBjYW4gbWFuaXB1bGF0ZSBpdCBkeW5hbWljYWxseQoJCQkJaWYgKCAkLnN1cHBvcnQuZHluYW1pY0Jhc2VUYWcgKXsKCQkJCQliYXNlLmVsZW1lbnQuYXR0ciggImhyZWYiLCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgZG9jdW1lbnRCYXNlICkgKTsKCQkJCX0KCQkJfSwKCgkJCXJld3JpdGU6IGZ1bmN0aW9uKCBocmVmLCBwYWdlICkgewoJCQkJdmFyIG5ld1BhdGggPSBwYXRoLmdldCggaHJlZiApOwoKCQkJCXBhZ2UuZmluZCggYmFzZS5saW5rU2VsZWN0b3IgKS5lYWNoKGZ1bmN0aW9uKCBpLCBsaW5rICkgewoJCQkJCXZhciB0aGlzQXR0ciA9ICQoIGxpbmsgKS5pcyggIltocmVmXSIgKSA/ICJocmVmIiA6ICQoIGxpbmsgKS5pcyggIltzcmNdIiApID8gInNyYyIgOiAiYWN0aW9uIiwKCQkJCQl0aGlzVXJsID0gJCggbGluayApLmF0dHIoIHRoaXNBdHRyICk7CgoJCQkJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBmaXggdGhpcyBzbyB0aGF0IGl0IHJlbW92ZXMgdGhlIGRvY3VtZW50CgkJCQkJLy8gICAgICAgICAgICBiYXNlIFVSTCwgYW5kIHRoZW4gcHJlcGVuZHMgd2l0aCB0aGUgbmV3IHBhZ2UgVVJMLgoJCQkJCS8vaWYgZnVsbCBwYXRoIGV4aXN0cyBhbmQgaXMgc2FtZSwgY2hvcCBpdCAtIGhlbHBzIElFIG91dAoJCQkJCXRoaXNVcmwgPSB0aGlzVXJsLnJlcGxhY2UoIGxvY2F0aW9uLnByb3RvY29sICsgIi8vIiArIGxvY2F0aW9uLmhvc3QgKyBsb2NhdGlvbi5wYXRobmFtZSwgIiIgKTsKCgkJCQkJaWYgKCAhL14oXHcrOnwjfFwvKS8udGVzdCggdGhpc1VybCApICkgewoJCQkJCQkkKCBsaW5rICkuYXR0ciggdGhpc0F0dHIsIG5ld1BhdGggKyB0aGlzVXJsICk7CgkJCQkJfQoJCQkJfSk7CgkJCX0sCgoJCQkvL3NldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgYXR0cmlidXRlIHRvIGEgbmV3IHBhZ2UncyBiYXNlIHBhdGgKCQkJcmVzZXQ6IGZ1bmN0aW9uKC8qIGhyZWYgKi8pIHsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsIGRvY3VtZW50QmFzZS5ocmVmTm9TZWFyY2ggKTsKCQkJfQoJCX07CgoJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IHVybAoJJC5tb2JpbGUuZ2V0RG9jdW1lbnRVcmwgPSBwYXRoLmdldERvY3VtZW50VXJsOwoKCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCBiYXNlIHVybAoJJC5tb2JpbGUuZ2V0RG9jdW1lbnRCYXNlID0gcGF0aC5nZXREb2N1bWVudEJhc2U7CgoJLyogaW50ZXJuYWwgdXRpbGl0eSBmdW5jdGlvbnMgKi8KCgkvLyBOT1RFIElzc3VlICM0OTUwIEFuZHJvaWQgcGhvbmVnYXAgZG9lc24ndCBuYXZpZ2F0ZSBiYWNrIHByb3Blcmx5CgkvLyAgICAgIHdoZW4gYSBmdWxsIHBhZ2UgcmVmcmVzaCBoYXMgdGFrZW4gcGxhY2UuIEl0IGFwcGVhcnMgdGhhdCBoYXNoY2hhbmdlCgkvLyAgICAgIGFuZCByZXBsYWNlc3RhdGUgaGlzdG9yeSBhbHRlcmF0aW9ucyB3b3JrIGZpbmUgYnV0IHdlIG5lZWQgdG8gc3VwcG9ydAoJLy8gICAgICBib3RoIGZvcm1zIG9mIGhpc3RvcnkgdHJhdmVyc2FsIGluIG91ciBjb2RlIHRoYXQgdXNlcyBiYWNrd2FyZCBoaXN0b3J5CgkvLyAgICAgIG1vdmVtZW50CgkkLm1vYmlsZS5iYWNrID0gZnVuY3Rpb24oKSB7CgkJdmFyIG5hdiA9IHdpbmRvdy5uYXZpZ2F0b3I7CgoJCS8vIGlmIHRoZSBzZXR0aW5nIGlzIG9uIGFuZCB0aGUgbmF2aWdhdG9yIG9iamVjdCBpcwoJCS8vIGF2YWlsYWJsZSB1c2UgdGhlIHBob25lZ2FwIG5hdmlnYXRpb24gY2FwYWJpbGl0eQoJCWlmICggdGhpcy5waG9uZWdhcE5hdmlnYXRpb25FbmFibGVkICYmCgkJCW5hdiAmJgoJCQluYXYuYXBwICYmCgkJCW5hdi5hcHAuYmFja0hpc3RvcnkgKXsKCQkJbmF2LmFwcC5iYWNrSGlzdG9yeSgpOwoJCX0gZWxzZSB7CgkJCXdpbmRvdy5oaXN0b3J5LmJhY2soKTsKCQl9Cgl9OwoKCS8vZGlyZWN0IGZvY3VzIHRvIHRoZSBwYWdlIHRpdGxlLCBvciBvdGhlcndpc2UgZmlyc3QgZm9jdXNhYmxlIGVsZW1lbnQKCSQubW9iaWxlLmZvY3VzUGFnZSA9IGZ1bmN0aW9uICggcGFnZSApIHsKCQl2YXIgYXV0b2ZvY3VzID0gcGFnZS5maW5kKCAiW2F1dG9mb2N1c10iICksCgkJCXBhZ2VUaXRsZSA9IHBhZ2UuZmluZCggIi51aS10aXRsZTplcSgwKSIgKTsKCgkJaWYgKCBhdXRvZm9jdXMubGVuZ3RoICkgewoJCQlhdXRvZm9jdXMuZm9jdXMoKTsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBwYWdlVGl0bGUubGVuZ3RoICkgewoJCQlwYWdlVGl0bGUuZm9jdXMoKTsKCQl9IGVsc2V7CgkJCXBhZ2UuZm9jdXMoKTsKCQl9Cgl9OwoKCS8vcmVtb3ZlIGFjdGl2ZSBjbGFzc2VzIGFmdGVyIHBhZ2UgdHJhbnNpdGlvbiBvciBlcnJvcgoJZnVuY3Rpb24gcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCBmb3JjZVJlbW92YWwgKSB7CgkJaWYgKCAhISRhY3RpdmVDbGlja2VkTGluayAmJiAoICEkYWN0aXZlQ2xpY2tlZExpbmsuY2xvc2VzdCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICkubGVuZ3RoIHx8IGZvcmNlUmVtb3ZhbCApICkgewoJCQkkYWN0aXZlQ2xpY2tlZExpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfQoJCSRhY3RpdmVDbGlja2VkTGluayA9IG51bGw7Cgl9CgoJZnVuY3Rpb24gcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpIHsKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJaWYgKCBwYWdlVHJhbnNpdGlvblF1ZXVlLmxlbmd0aCA+IDAgKSB7CgkJCSQubW9iaWxlLmNoYW5nZVBhZ2UuYXBwbHkoIG51bGwsIHBhZ2VUcmFuc2l0aW9uUXVldWUucG9wKCkgKTsKCQl9Cgl9CgoJLy8gTm8tb3AgaW1wbGVtZW50YXRpb24gb2YgdHJhbnNpdGlvbiBkZWdyYWRhdGlvbgoJJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gPSAkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiB8fCBmdW5jdGlvbiggdHJhbnNpdGlvbiApIHsKCQlyZXR1cm4gdHJhbnNpdGlvbjsKCX07CgoJLy8gZGV0ZXJtaW5lIHRoZSBjdXJyZW50IGJhc2UgdXJsCglmdW5jdGlvbiBmaW5kQmFzZVdpdGhEZWZhdWx0KCkgewoJCXZhciBjbG9zZXN0QmFzZSA9ICggJC5tb2JpbGUuYWN0aXZlUGFnZSAmJiBnZXRDbG9zZXN0QmFzZVVybCggJC5tb2JpbGUuYWN0aXZlUGFnZSApICk7CgkJcmV0dXJuIGNsb3Nlc3RCYXNlIHx8IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoOwoJfQoKCS8qIGV4cG9zZWQgJC5tb2JpbGUgbWV0aG9kcyAqLwoKCS8vYW5pbWF0aW9uIGNvbXBsZXRlIGNhbGxiYWNrCgkkLmZuLmFuaW1hdGlvbkNvbXBsZXRlID0gZnVuY3Rpb24oIGNhbGxiYWNrICkgewoJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zaXRpb25zICkgewoJCQlyZXR1cm4gJCggdGhpcyApLm9uZSggIndlYmtpdEFuaW1hdGlvbkVuZCBhbmltYXRpb25lbmQiLCBjYWxsYmFjayApOwoJCX0KCQllbHNlewoJCQkvLyBkZWZlciBleGVjdXRpb24gZm9yIGNvbnNpc3RlbmN5IGJldHdlZW4gd2Via2l0L25vbiB3ZWJraXQKCQkJc2V0VGltZW91dCggY2FsbGJhY2ssIDAgKTsKCQkJcmV0dXJuICQoIHRoaXMgKTsKCQl9Cgl9OwoKCS8vZXhwb3NlIHBhdGggb2JqZWN0IG9uICQubW9iaWxlCgkkLm1vYmlsZS5wYXRoID0gcGF0aDsKCgkvL2V4cG9zZSBiYXNlIG9iamVjdCBvbiAkLm1vYmlsZQoJJC5tb2JpbGUuYmFzZSA9IGJhc2U7CgoJLy9oaXN0b3J5IHN0YWNrCgkkLm1vYmlsZS51cmxIaXN0b3J5ID0gdXJsSGlzdG9yeTsKCgkkLm1vYmlsZS5kaWFsb2dIYXNoS2V5ID0gZGlhbG9nSGFzaEtleTsKCgkvL2VuYWJsZSBjcm9zcy1kb21haW4gcGFnZSBzdXBwb3J0CgkkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgPSBmYWxzZTsKCgkkLm1vYmlsZS5jaGFuZ2VQYWdlID0gZnVuY3Rpb24oIHRvLCBvcHRpb25zICkgewoJCSQubW9iaWxlLnBhZ2VDb250YWluZXIuY29udGVudCggImNoYW5nZSIsIHRvLCBvcHRpb25zICk7Cgl9OwoKCSQubW9iaWxlLmNoYW5nZVBhZ2UuZGVmYXVsdHMgPSB7CgkJdHJhbnNpdGlvbjogdW5kZWZpbmVkLAoJCXJldmVyc2U6IGZhbHNlLAoJCWNoYW5nZUhhc2g6IHRydWUsCgkJZnJvbUhhc2hDaGFuZ2U6IGZhbHNlLAoJCXJvbGU6IHVuZGVmaW5lZCwgLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCWR1cGxpY2F0ZUNhY2hlZFBhZ2U6IHVuZGVmaW5lZCwKCQlwYWdlQ29udGFpbmVyOiB1bmRlZmluZWQsCgkJc2hvd0xvYWRNc2c6IHRydWUsIC8vbG9hZGluZyBtZXNzYWdlIHNob3dzIGJ5IGRlZmF1bHQgd2hlbiBwYWdlcyBhcmUgYmVpbmcgZmV0Y2hlZCBkdXJpbmcgY2hhbmdlUGFnZQoJCWRhdGFVcmw6IHVuZGVmaW5lZCwKCQlmcm9tUGFnZTogdW5kZWZpbmVkLAoJCWFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uOiBmYWxzZQoJfTsKCgkvKiBFdmVudCBCaW5kaW5ncyAtIGhhc2hjaGFuZ2UsIHN1Ym1pdCwgYW5kIGNsaWNrICovCglmdW5jdGlvbiBmaW5kQ2xvc2VzdExpbmsoIGVsZSApCXsKCQl3aGlsZSAoIGVsZSApIHsKCQkJLy8gTG9vayBmb3IgdGhlIGNsb3Nlc3QgZWxlbWVudCB3aXRoIGEgbm9kZU5hbWUgb2YgImEiLgoJCQkvLyBOb3RlIHRoYXQgd2UgYXJlIGNoZWNraW5nIGlmIHdlIGhhdmUgYSB2YWxpZCBub2RlTmFtZQoJCQkvLyBiZWZvcmUgYXR0ZW1wdGluZyB0byBhY2Nlc3MgaXQuIFRoaXMgaXMgYmVjYXVzZSB0aGUKCQkJLy8gbm9kZSB3ZSBnZXQgY2FsbGVkIHdpdGggY291bGQgaGF2ZSBvcmlnaW5hdGVkIGZyb20gd2l0aGluCgkJCS8vIGFuIGVtYmVkZGVkIFNWRyBkb2N1bWVudCB3aGVyZSBzb21lIHN5bWJvbCBpbnN0YW5jZSBlbGVtZW50cwoJCQkvLyBkb24ndCBoYXZlIG5vZGVOYW1lIGRlZmluZWQgb24gdGhlbSwgb3Igc3RyaW5ncyBhcmUgb2YgdHlwZQoJCQkvLyBTVkdBbmltYXRlZFN0cmluZy4KCQkJaWYgKCAoIHR5cGVvZiBlbGUubm9kZU5hbWUgPT09ICJzdHJpbmciICkgJiYgZWxlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJhIiApIHsKCQkJCWJyZWFrOwoJCQl9CgkJCWVsZSA9IGVsZS5wYXJlbnROb2RlOwoJCX0KCQlyZXR1cm4gZWxlOwoJfQoKCS8vIFRoZSBiYXNlIFVSTCBmb3IgYW55IGdpdmVuIGVsZW1lbnQgZGVwZW5kcyBvbiB0aGUgcGFnZSBpdCByZXNpZGVzIGluLgoJZnVuY3Rpb24gZ2V0Q2xvc2VzdEJhc2VVcmwoIGVsZSApCXsKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhZ2UgYW5kIGV4dHJhY3Qgb3V0IGl0cyB1cmwuCgkJdmFyIHVybCA9ICQoIGVsZSApLmNsb3Nlc3QoICIudWktcGFnZSIgKS5qcW1EYXRhKCAidXJsIiApLAoJCQliYXNlID0gZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgoJCWlmICggISQubW9iaWxlLmR5bmFtaWNCYXNlRW5hYmxlZCB8fCAhdXJsIHx8ICFwYXRoLmlzUGF0aCggdXJsICkgKSB7CgkJCXVybCA9IGJhc2U7CgkJfQoKCQlyZXR1cm4gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgYmFzZSApOwoJfQoKCS8vVGhlIGZvbGxvd2luZyBldmVudCBiaW5kaW5ncyBzaG91bGQgYmUgYm91bmQgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgYmVlbiB0cmlnZ2VyZWQKCS8vdGhlIGZvbGxvd2luZyBkZWZlcnJlZCBpcyByZXNvbHZlZCBpbiB0aGUgaW5pdCBmaWxlCgkkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkID0gJC5EZWZlcnJlZCgpOwoJJC5tb2JpbGUuX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMgPSBmdW5jdGlvbigpIHsKCQl2YXIgZ2V0QWpheEZvcm1EYXRhID0gZnVuY3Rpb24oICRmb3JtLCBjYWxjdWxhdGVPbmx5ICkgewoJCQl2YXIgdXJsLCByZXQgPSB0cnVlLCBmb3JtRGF0YSwgdmNsaWNrZWROYW1lLCBtZXRob2Q7CgkJCWlmICggISQubW9iaWxlLmFqYXhFbmFibGVkIHx8CgkJCQkJLy8gdGVzdCB0aGF0IHRoZSBmb3JtIGlzLCBpdHNlbGYsIGFqYXggZmFsc2UKCQkJCQkkZm9ybS5pcyggIjpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiICkgfHwKCQkJCQkvLyB0ZXN0IHRoYXQgJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgaXMgc2V0IGFuZAoJCQkJCS8vIHRoZSBmb3JtIG9yIG9uZSBvZiBpdCdzIHBhcmVudHMgaXMgYWpheD1mYWxzZQoJCQkJCSEkZm9ybS5qcW1IaWphY2thYmxlKCkubGVuZ3RoIHx8CgkJCQkJJGZvcm0uYXR0ciggInRhcmdldCIgKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJdXJsID0gKCAkbGFzdFZDbGlja2VkICYmICRsYXN0VkNsaWNrZWQuYXR0ciggImZvcm1hY3Rpb24iICkgKSB8fAoJCQkJJGZvcm0uYXR0ciggImFjdGlvbiIgKTsKCQkJbWV0aG9kID0gKCAkZm9ybS5hdHRyKCAibWV0aG9kIiApIHx8ICJnZXQiICkudG9Mb3dlckNhc2UoKTsKCgkJCS8vIElmIG5vIGFjdGlvbiBpcyBzcGVjaWZpZWQsIGJyb3dzZXJzIGRlZmF1bHQgdG8gdXNpbmcgdGhlCgkJCS8vIFVSTCBvZiB0aGUgZG9jdW1lbnQgY29udGFpbmluZyB0aGUgZm9ybS4gU2luY2Ugd2UgZHluYW1pY2FsbHkKCQkJLy8gcHVsbCBpbiBwYWdlcyBmcm9tIGV4dGVybmFsIGRvY3VtZW50cywgdGhlIGZvcm0gc2hvdWxkIHN1Ym1pdAoJCQkvLyB0byB0aGUgVVJMIGZvciB0aGUgc291cmNlIGRvY3VtZW50IG9mIHRoZSBwYWdlIGNvbnRhaW5pbmcKCQkJLy8gdGhlIGZvcm0uCgkJCWlmICggIXVybCApIHsKCQkJCS8vIEdldCB0aGUgQGRhdGEtdXJsIGZvciB0aGUgcGFnZSBjb250YWluaW5nIHRoZSBmb3JtLgoJCQkJdXJsID0gZ2V0Q2xvc2VzdEJhc2VVcmwoICRmb3JtICk7CgoJCQkJLy8gTk9URTogSWYgdGhlIG1ldGhvZCBpcyAiZ2V0Iiwgd2UgbmVlZCB0byBzdHJpcCBvZmYgdGhlIHF1ZXJ5IHN0cmluZwoJCQkJLy8gYmVjYXVzZSBpdCB3aWxsIGdldCByZXBsYWNlZCB3aXRoIHRoZSBuZXcgZm9ybSBkYXRhLiBTZWUgaXNzdWUgIzU3MTAuCgkJCQlpZiAoIG1ldGhvZCA9PT0gImdldCIgKSB7CgkJCQkJdXJsID0gcGF0aC5wYXJzZVVybCggdXJsICkuaHJlZk5vU2VhcmNoOwoJCQkJfQoKCQkJCWlmICggdXJsID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApIHsKCQkJCQkvLyBUaGUgdXJsIHdlIGdvdCBiYWNrIG1hdGNoZXMgdGhlIGRvY3VtZW50IGJhc2UsCgkJCQkJLy8gd2hpY2ggbWVhbnMgdGhlIHBhZ2UgbXVzdCBiZSBhbiBpbnRlcm5hbC9lbWJlZGRlZCBwYWdlLAoJCQkJCS8vIHNvIGRlZmF1bHQgdG8gdXNpbmcgdGhlIGFjdHVhbCBkb2N1bWVudCB1cmwgYXMgYSBicm93c2VyCgkJCQkJLy8gd291bGQuCgkJCQkJdXJsID0gZG9jdW1lbnRVcmwuaHJlZk5vU2VhcmNoOwoJCQkJfQoJCQl9CgoJCQl1cmwgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggIHVybCwgZ2V0Q2xvc2VzdEJhc2VVcmwoICRmb3JtICkgKTsKCgkJCWlmICggKCBwYXRoLmlzRXh0ZXJuYWwoIHVybCApICYmICFwYXRoLmlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0KCBkb2N1bWVudFVybCwgdXJsICkgKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJaWYgKCAhY2FsY3VsYXRlT25seSApIHsKCQkJCWZvcm1EYXRhID0gJGZvcm0uc2VyaWFsaXplQXJyYXkoKTsKCgkJCQlpZiAoICRsYXN0VkNsaWNrZWQgJiYgJGxhc3RWQ2xpY2tlZFsgMCBdLmZvcm0gPT09ICRmb3JtWyAwIF0gKSB7CgkJCQkJdmNsaWNrZWROYW1lID0gJGxhc3RWQ2xpY2tlZC5hdHRyKCAibmFtZSIgKTsKCQkJCQlpZiAoIHZjbGlja2VkTmFtZSApIHsKCQkJCQkJLy8gTWFrZSBzdXJlIHRoZSBsYXN0IGNsaWNrZWQgZWxlbWVudCBpcyBpbmNsdWRlZCBpbiB0aGUgZm9ybQoJCQkJCQkkLmVhY2goIGZvcm1EYXRhLCBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJCQkJCWlmICggdmFsdWUubmFtZSA9PT0gdmNsaWNrZWROYW1lICkgewoJCQkJCQkJCS8vIFVuc2V0IHZjbGlja2VkTmFtZSAtIHdlJ3ZlIGZvdW5kIGl0IGluIHRoZSBzZXJpYWxpemVkIGRhdGEgYWxyZWFkeQoJCQkJCQkJCXZjbGlja2VkTmFtZSA9ICIiOwoJCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCX0KCQkJCQkJfSk7CgkJCQkJCWlmICggdmNsaWNrZWROYW1lICkgewoJCQkJCQkJZm9ybURhdGEucHVzaCggeyBuYW1lOiB2Y2xpY2tlZE5hbWUsIHZhbHVlOiAkbGFzdFZDbGlja2VkLmF0dHIoICJ2YWx1ZSIgKSB9ICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgoJCQkJcmV0ID0gewoJCQkJCXVybDogdXJsLAoJCQkJCW9wdGlvbnM6IHsKCQkJCQkJdHlwZToJCW1ldGhvZCwKCQkJCQkJZGF0YToJCSQucGFyYW0oIGZvcm1EYXRhICksCgkJCQkJCXRyYW5zaXRpb246CSRmb3JtLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJCQlyZXZlcnNlOgkkZm9ybS5qcW1EYXRhKCAiZGlyZWN0aW9uIiApID09PSAicmV2ZXJzZSIsCgkJCQkJCXJlbG9hZFBhZ2U6CXRydWUKCQkJCQl9CgkJCQl9OwoJCQl9CgoJCQlyZXR1cm4gcmV0OwoJCX07CgoJCS8vYmluZCB0byBmb3JtIHN1Ym1pdCBldmVudHMsIGhhbmRsZSB3aXRoIEFqYXgKCQkkLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggImZvcm0iLCAic3VibWl0IiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZm9ybURhdGE7CgoJCQlpZiAoICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCWZvcm1EYXRhID0gZ2V0QWpheEZvcm1EYXRhKCAkKCB0aGlzICkgKTsKCQkJCWlmICggZm9ybURhdGEgKSB7CgkJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggZm9ybURhdGEudXJsLCBmb3JtRGF0YS5vcHRpb25zICk7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCX0KCQkJfQoJCX0pOwoKCQkvL2FkZCBhY3RpdmUgc3RhdGUgb24gdmNsaWNrCgkJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyICRidG4sIGJ0bkVscywgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0LCBuZWVkQ2xvc2VzdCA9IGZhbHNlOwoJCQkvLyBpZiB0aGlzIGlzbid0IGEgbGVmdCBjbGljayB3ZSBkb24ndCBjYXJlLiBJdHMgaW1wb3J0YW50IHRvIG5vdGUKCQkJLy8gdGhhdCB3aGVuIHRoZSB2aXJ0dWFsIGV2ZW50IGlzIGdlbmVyYXRlZCBpdCB3aWxsIGNyZWF0ZSB0aGUgd2hpY2ggYXR0cgoJCQlpZiAoIGV2ZW50LndoaWNoID4gMSB8fCAhJC5tb2JpbGUubGlua0JpbmRpbmdFbmFibGVkICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBSZWNvcmQgdGhhdCB0aGlzIGVsZW1lbnQgd2FzIGNsaWNrZWQsIGluIGNhc2Ugd2UgbmVlZCBpdCBmb3IgY29ycmVjdAoJCQkvLyBmb3JtIHN1Ym1pc3Npb24gZHVyaW5nIHRoZSAic3VibWl0IiBoYW5kbGVyIGFib3ZlCgkJCSRsYXN0VkNsaWNrZWQgPSAkKCB0YXJnZXQgKTsKCgkJCS8vIFRyeSB0byBmaW5kIGEgdGFyZ2V0IGVsZW1lbnQgdG8gd2hpY2ggdGhlIGFjdGl2ZSBjbGFzcyB3aWxsIGJlIGFwcGxpZWQKCQkJaWYgKCAkLmRhdGEoIHRhcmdldCwgIm1vYmlsZS1idXR0b24iICkgKSB7CgkJCQkvLyBJZiB0aGUgZm9ybSB3aWxsIG5vdCBiZSBzdWJtaXR0ZWQgdmlhIEFKQVgsIGRvIG5vdCBhZGQgYWN0aXZlIGNsYXNzCgkJCQlpZiAoICFnZXRBamF4Rm9ybURhdGEoICQoIHRhcmdldCApLmNsb3Nlc3QoICJmb3JtIiApLCB0cnVlICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJLy8gV2Ugd2lsbCBhcHBseSB0aGUgYWN0aXZlIHN0YXRlIHRvIHRoaXMgYnV0dG9uIHdpZGdldCAtIHRoZSBwYXJlbnQKCQkJCS8vIG9mIHRoZSBpbnB1dCB0aGF0IHdhcyBjbGlja2VkIHdpbGwgaGF2ZSB0aGUgYXNzb2NpYXRlZCBkYXRhCgkJCQlpZiAoIHRhcmdldC5wYXJlbnROb2RlICkgewoJCQkJCXRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJdGFyZ2V0ID0gZmluZENsb3Nlc3RMaW5rKCB0YXJnZXQgKTsKCQkJCWlmICggISggdGFyZ2V0ICYmIHBhdGgucGFyc2VVcmwoIHRhcmdldC5nZXRBdHRyaWJ1dGUoICJocmVmIiApIHx8ICIjIiApLmhhc2ggIT09ICIjIiApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQkvLyBUT0RPIHRlYWNoICQubW9iaWxlLmhpamFja2FibGUgdG8gb3BlcmF0ZSBvbiByYXcgZG9tIGVsZW1lbnRzIHNvIHRoZQoJCQkJLy8gbGluayB3cmFwcGluZyBjYW4gYmUgYXZvaWRlZAoJCQkJaWYgKCAhJCggdGFyZ2V0ICkuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCgkJCS8vIEF2b2lkIGNhbGxpbmcgLmNsb3Nlc3QgYnkgdXNpbmcgdGhlIGRhdGEgc2V0IGR1cmluZyAuYnV0dG9uTWFya3VwKCkKCQkJLy8gTGlzdCBpdGVtcyBoYXZlIHRoZSBidXR0b24gZGF0YSBpbiB0aGUgcGFyZW50IG9mIHRoZSBlbGVtZW50IGNsaWNrZWQKCQkJaWYgKCAhIX50YXJnZXQuY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1saW5rLWluaGVyaXQiICkgKSB7CgkJCQlpZiAoIHRhcmdldC5wYXJlbnROb2RlICkgewoJCQkJCWJ0bkVscyA9ICQuZGF0YSggdGFyZ2V0LnBhcmVudE5vZGUsICJidXR0b25FbGVtZW50cyIgKTsKCQkJCX0KCQkJLy8gT3RoZXJ3aXNlLCBsb29rIGZvciB0aGUgZGF0YSBvbiB0aGUgdGFyZ2V0IGl0c2VsZgoJCQl9IGVsc2UgewoJCQkJYnRuRWxzID0gJC5kYXRhKCB0YXJnZXQsICJidXR0b25FbGVtZW50cyIgKTsKCQkJfQoJCQkvLyBJZiBmb3VuZCwgZ3JhYiB0aGUgYnV0dG9uJ3Mgb3V0ZXIgZWxlbWVudAoJCQlpZiAoIGJ0bkVscyApIHsKCQkJCXRhcmdldCA9IGJ0bkVscy5vdXRlcjsKCQkJfSBlbHNlIHsKCQkJCW5lZWRDbG9zZXN0ID0gdHJ1ZTsKCQkJfQoKCQkJJGJ0biA9ICQoIHRhcmdldCApOwoJCQkvLyBJZiB0aGUgb3V0ZXIgZWxlbWVudCB3YXNuJ3QgZm91bmQgYnkgdGhlIG91ciBoZXVyaXN0aWNzLCB1c2UgLmNsb3Nlc3QoKQoJCQlpZiAoIG5lZWRDbG9zZXN0ICkgewoJCQkJJGJ0biA9ICRidG4uY2xvc2VzdCggIi51aS1idG4iICk7CgkJCX0KCgkJCWlmICggJGJ0bi5sZW5ndGggPiAwICYmICEkYnRuLmhhc0NsYXNzKCAidWktZGlzYWJsZWQiICkgKSB7CgkJCQlyZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsKCQkJCSRhY3RpdmVDbGlja2VkTGluayA9ICRidG47CgkJCQkkYWN0aXZlQ2xpY2tlZExpbmsuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0KCQl9KTsKCgkJLy8gY2xpY2sgcm91dGluZyAtIGRpcmVjdCB0byBIVFRQIG9yIEFqYXgsIGFjY29yZGluZ2x5CgkJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoICEkLm1vYmlsZS5saW5rQmluZGluZ0VuYWJsZWQgfHwgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBsaW5rID0gZmluZENsb3Nlc3RMaW5rKCBldmVudC50YXJnZXQgKSwKCQkJCSRsaW5rID0gJCggbGluayApLAoJCQkJaHR0cENsZWFudXAsCgkJCQliYXNlVXJsLCBocmVmLAoJCQkJdXNlRGVmYXVsdFVybEhhbmRsaW5nLCBpc0V4dGVybmFsLAoJCQkJdHJhbnNpdGlvbiwgcmV2ZXJzZSwgcm9sZTsKCgkJCS8vIElmIHRoZXJlIGlzIG5vIGxpbmsgYXNzb2NpYXRlZCB3aXRoIHRoZSBjbGljayBvciBpdHMgbm90IGEgbGVmdAoJCQkvLyBjbGljayB3ZSB3YW50IHRvIGlnbm9yZSB0aGUgY2xpY2sKCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUgbGluayB3cmFwcGluZwoJCQkvLyBjYW4gYmUgYXZvaWRlZAoJCQlpZiAoICFsaW5rIHx8IGV2ZW50LndoaWNoID4gMSB8fCAhJGxpbmsuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy9yZW1vdmUgYWN0aXZlIGxpbmsgY2xhc3MgaWYgZXh0ZXJuYWwgKHRoZW4gaXQgd29uJ3QgYmUgdGhlcmUgaWYgeW91IGNvbWUgYmFjaykKCQkJaHR0cENsZWFudXAgPSBmdW5jdGlvbigpIHsKCQkJCXdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyByZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsgfSwgMjAwICk7CgkJCX07CgoJCQkvL2lmIHRoZXJlJ3MgYSBkYXRhLXJlbD1iYWNrIGF0dHIsIGdvIGJhY2sgaW4gaGlzdG9yeQoJCQlpZiAoICRsaW5rLmlzKCAiOmpxbURhdGEocmVsPSdiYWNrJykiICkgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCWJhc2VVcmwgPSBnZXRDbG9zZXN0QmFzZVVybCggJGxpbmsgKTsKCgkJCS8vZ2V0IGhyZWYsIGlmIGRlZmluZWQsIG90aGVyd2lzZSBkZWZhdWx0IHRvIGVtcHR5IGhhc2gKCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCAkbGluay5hdHRyKCAiaHJlZiIgKSB8fCAiIyIsIGJhc2VVcmwgKTsKCgkJCS8vaWYgYWpheCBpcyBkaXNhYmxlZCwgZXhpdCBlYXJseQoJCQlpZiAoICEkLm1vYmlsZS5hamF4RW5hYmxlZCAmJiAhcGF0aC5pc0VtYmVkZGVkUGFnZSggaHJlZiApICkgewoJCQkJaHR0cENsZWFudXAoKTsKCQkJCS8vdXNlIGRlZmF1bHQgY2xpY2sgaGFuZGxpbmcKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gWFhYX2pibGFzOiBJZGVhbGx5IGxpbmtzIHRvIGFwcGxpY2F0aW9uIHBhZ2VzIHNob3VsZCBiZSBzcGVjaWZpZWQgYXMKCQkJLy8gICAgICAgICAgICBhbiB1cmwgdG8gdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHdpdGggYSBoYXNoIHRoYXQgaXMgZWl0aGVyCgkJCS8vICAgICAgICAgICAgdGhlIHNpdGUgcmVsYXRpdmUgcGF0aCBvciBpZCB0byB0aGUgcGFnZS4gQnV0IHNvbWUgb2YgdGhlCgkJCS8vICAgICAgICAgICAgaW50ZXJuYWwgY29kZSB0aGF0IGR5bmFtaWNhbGx5IGdlbmVyYXRlcyBzdWItcGFnZXMgZm9yIG5lc3RlZAoJCQkvLyAgICAgICAgICAgIGxpc3RzIGFuZCBzZWxlY3QgZGlhbG9ncywganVzdCB3cml0ZSBhIGhhc2ggaW4gdGhlIGxpbmsgdGhleQoJCQkvLyAgICAgICAgICAgIGNyZWF0ZS4gVGhpcyBtZWFucyB0aGUgYWN0dWFsIFVSTCBwYXRoIGlzIGJhc2VkIG9uIHdoYXRldmVyCgkJCS8vICAgICAgICAgICAgdGhlIGN1cnJlbnQgdmFsdWUgb2YgdGhlIGJhc2UgdGFnIGlzIGF0IHRoZSB0aW1lIHRoaXMgY29kZQoJCQkvLyAgICAgICAgICAgIGlzIGNhbGxlZC4gRm9yIG5vdyB3ZSBhcmUganVzdCBhc3N1bWluZyB0aGF0IGFueSB1cmwgd2l0aCBhCgkJCS8vICAgICAgICAgICAgaGFzaCBpbiBpdCBpcyBhbiBhcHBsaWNhdGlvbiBwYWdlIHJlZmVyZW5jZS4KCQkJaWYgKCBocmVmLnNlYXJjaCggIiMiICkgIT09IC0xICkgewoJCQkJaHJlZiA9IGhyZWYucmVwbGFjZSggL1teI10qIy8sICIiICk7CgkJCQlpZiAoICFocmVmICkgewoJCQkJCS8vbGluayB3YXMgYW4gZW1wdHkgaGFzaCBtZWFudCBwdXJlbHkKCQkJCQkvL2ZvciBpbnRlcmFjdGlvbiwgc28gd2UgaWdub3JlIGl0LgoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfSBlbHNlIGlmICggcGF0aC5pc1BhdGgoIGhyZWYgKSApIHsKCQkJCQkvL3dlIGhhdmUgYXBhdGggc28gbWFrZSBpdCB0aGUgaHJlZiB3ZSB3YW50IHRvIGxvYWQuCgkJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCBocmVmLCBiYXNlVXJsICk7CgkJCQl9IGVsc2UgewoJCQkJCS8vd2UgaGF2ZSBhIHNpbXBsZSBpZCBzbyB1c2UgdGhlIGRvY3VtZW50VXJsIGFzIGl0cyBiYXNlLgoJCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgaHJlZiwgZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCApOwoJCQkJfQoJCQl9CgoJCQkvLyBTaG91bGQgd2UgaGFuZGxlIHRoaXMgbGluaywgb3IgbGV0IHRoZSBicm93c2VyIGRlYWwgd2l0aCBpdD8KCQkJdXNlRGVmYXVsdFVybEhhbmRsaW5nID0gJGxpbmsuaXMoICJbcmVsPSdleHRlcm5hbCddIiApIHx8ICRsaW5rLmlzKCAiOmpxbURhdGEoYWpheD0nZmFsc2UnKSIgKSB8fCAkbGluay5pcyggIlt0YXJnZXRdIiApOwoKCQkJLy8gU29tZSBlbWJlZGRlZCBicm93c2VycywgbGlrZSB0aGUgd2ViIHZpZXcgaW4gUGhvbmUgR2FwLCBhbGxvdyBjcm9zcy1kb21haW4gWEhSCgkJCS8vIHJlcXVlc3RzIGlmIHRoZSBkb2N1bWVudCBkb2luZyB0aGUgcmVxdWVzdCB3YXMgbG9hZGVkIHZpYSB0aGUgZmlsZTovLyBwcm90b2NvbC4KCQkJLy8gVGhpcyBpcyB1c3VhbGx5IHRvIGFsbG93IHRoZSBhcHBsaWNhdGlvbiB0byAicGhvbmUgaG9tZSIgYW5kIGZldGNoIGFwcCBzcGVjaWZpYwoJCQkvLyBkYXRhLiBXZSBub3JtYWxseSBsZXQgdGhlIGJyb3dzZXIgaGFuZGxlIGV4dGVybmFsL2Nyb3NzLWRvbWFpbiB1cmxzLCBidXQgaWYgdGhlCgkJCS8vIGFsbG93Q3Jvc3NEb21haW5QYWdlcyBvcHRpb24gaXMgdHJ1ZSwgd2Ugd2lsbCBhbGxvdyBjcm9zcy1kb21haW4gaHR0cC9odHRwcwoJCQkvLyByZXF1ZXN0cyB0byBnbyB0aHJvdWdoIG91ciBwYWdlIGxvYWRpbmcgbG9naWMuCgoJCQkvL2NoZWNrIGZvciBwcm90b2NvbCBvciByZWwgYW5kIGl0cyBub3QgYW4gZW1iZWRkZWQgcGFnZQoJCQkvL1RPRE8gb3ZlcmxhcCBpbiBsb2dpYyBmcm9tIGlzRXh0ZXJuYWwsIHJlbD1leHRlcm5hbCBjaGVjayBzaG91bGQgYmUKCQkJLy8gICAgIG1vdmVkIGludG8gbW9yZSBjb21wcmVoZW5zaXZlIGlzRXh0ZXJuYWxMaW5rCgkJCWlzRXh0ZXJuYWwgPSB1c2VEZWZhdWx0VXJsSGFuZGxpbmcgfHwgKCBwYXRoLmlzRXh0ZXJuYWwoIGhyZWYgKSAmJiAhcGF0aC5pc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdCggZG9jdW1lbnRVcmwsIGhyZWYgKSApOwoKCQkJaWYgKCBpc0V4dGVybmFsICkgewoJCQkJaHR0cENsZWFudXAoKTsKCQkJCS8vdXNlIGRlZmF1bHQgY2xpY2sgaGFuZGxpbmcKCQkJCXJldHVybjsKCQkJfQoKCQkJLy91c2UgYWpheAoJCQl0cmFuc2l0aW9uID0gJGxpbmsuanFtRGF0YSggInRyYW5zaXRpb24iICk7CgkJCXJldmVyc2UgPSAkbGluay5qcW1EYXRhKCAiZGlyZWN0aW9uIiApID09PSAicmV2ZXJzZSIgfHwKCQkJCQkJLy8gZGVwcmVjYXRlZCAtIHJlbW92ZSBieSAxLjAKCQkJCQkJJGxpbmsuanFtRGF0YSggImJhY2siICk7CgoJCQkvL3RoaXMgbWF5IG5lZWQgdG8gYmUgbW9yZSBzcGVjaWZpYyBhcyB3ZSB1c2UgZGF0YS1yZWwgbW9yZQoJCQlyb2xlID0gJGxpbmsuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbCIgKSB8fCB1bmRlZmluZWQ7CgoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBocmVmLCB7IHRyYW5zaXRpb246IHRyYW5zaXRpb24sIHJldmVyc2U6IHJldmVyc2UsIHJvbGU6IHJvbGUsIGxpbms6ICRsaW5rIH0gKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9KTsKCgkJLy9wcmVmZXRjaCBwYWdlcyB3aGVuIGFuY2hvcnMgd2l0aCBkYXRhLXByZWZldGNoIGFyZSBlbmNvdW50ZXJlZAoJCSQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAiLnVpLXBhZ2UiLCAicGFnZXNob3cucHJlZmV0Y2giLCBmdW5jdGlvbigpIHsKCQkJdmFyIHVybHMgPSBbXTsKCQkJJCggdGhpcyApLmZpbmQoICJhOmpxbURhdGEocHJlZmV0Y2gpIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgJGxpbmsgPSAkKCB0aGlzICksCgkJCQkJdXJsID0gJGxpbmsuYXR0ciggImhyZWYiICk7CgoJCQkJaWYgKCB1cmwgJiYgJC5pbkFycmF5KCB1cmwsIHVybHMgKSA9PT0gLTEgKSB7CgkJCQkJdXJscy5wdXNoKCB1cmwgKTsKCgkJCQkJJC5tb2JpbGUubG9hZFBhZ2UoIHVybCwgeyByb2xlOiAkbGluay5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIiApLHByZWZldGNoOiB0cnVlIH0gKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgoJCS8vIFRPRE8gZW5zdXJlIHRoYXQgdGhlIG5hdmlnYXRlIGJpbmRpbmcgaW4gdGhlIGNvbnRlbnQgd2lkZ2V0IGhhcHBlbnMgYXQgdGhlIHJpZ2h0IHRpbWUKCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLmNvbnRlbnQoKTsKCgkJLy9zZXQgcGFnZSBtaW4taGVpZ2h0cyB0byBiZSBkZXZpY2Ugc3BlY2lmaWMKCQkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZXNob3ciLCAkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCQkkLm1vYmlsZS53aW5kb3cuYmluZCggInRocm90dGxlZHJlc2l6ZSIsICQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCApOwoKCX07Ly9uYXZyZWFkeURlZmVycmVkIGRvbmUgY2FsbGJhY2sKCgkkKCBmdW5jdGlvbigpIHsgZG9tcmVhZHlEZWZlcnJlZC5yZXNvbHZlKCk7IH0gKTsKCgkkLndoZW4oIGRvbXJlYWR5RGVmZXJyZWQsICQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQgKS5kb25lKCBmdW5jdGlvbigpIHsgJC5tb2JpbGUuX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMoKTsgfSApOwp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCgkvLyBUT0RPIHJlbW92ZSBkaXJlY3QgcmVmZXJlbmNlcyB0byAkLm1vYmlsZSBhbmQgcHJvcGVydGllcywgd2Ugc2hvdWxkCgkvLyAgICAgIGZhdm9yIGluamVjdGlvbiB3aXRoIHBhcmFtcyB0byB0aGUgY29uc3RydWN0b3IKCSQubW9iaWxlLlRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQl0aGlzLmluaXQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5UcmFuc2l0aW9uLnByb3RvdHlwZSwgewoJCXRvUHJlQ2xhc3M6ICIgdWktcGFnZS1wcmUtaW4iLAoKCQlpbml0OiBmdW5jdGlvbiggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSApIHsKCQkJJC5leHRlbmQodGhpcywgewoJCQkJbmFtZTogbmFtZSwKCQkJCXJldmVyc2U6IHJldmVyc2UsCgkJCQkkdG86ICR0bywKCQkJCSRmcm9tOiAkZnJvbSwKCQkJCWRlZmVycmVkOiBuZXcgJC5EZWZlcnJlZCgpCgkJCX0pOwoJCX0sCgoJCWNsZWFuRnJvbTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuJGZyb20KCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICsgIiBvdXQgaW4gcmV2ZXJzZSAiICsgdGhpcy5uYW1lICkKCQkJCS5oZWlnaHQoICIiICk7CgkJfSwKCgkJLy8gTk9URSBvdmVycmlkZGVuIGJ5IGNoaWxkIG9iamVjdCBwcm90b3R5cGVzLCBub29wJ2QgaGVyZSBhcyBkZWZhdWx0cwoJCWJlZm9yZURvbmVJbjogZnVuY3Rpb24oKSB7fSwKCQliZWZvcmVEb25lT3V0OiBmdW5jdGlvbigpIHt9LAoJCWJlZm9yZVN0YXJ0T3V0OiBmdW5jdGlvbigpIHt9LAoKCQlkb25lSW46IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmJlZm9yZURvbmVJbigpOwoKCQkJdGhpcy4kdG8ucmVtb3ZlQ2xhc3MoICJvdXQgaW4gcmV2ZXJzZSAiICsgdGhpcy5uYW1lICkuaGVpZ2h0KCAiIiApOwoKCQkJdGhpcy50b2dnbGVWaWV3cG9ydENsYXNzKCk7CgoJCQkvLyBJbiBzb21lIGJyb3dzZXJzIChpT1M1KSwgM0QgdHJhbnNpdGlvbnMgYmxvY2sgdGhlIGFiaWxpdHkgdG8gc2Nyb2xsIHRvIHRoZSBkZXNpcmVkIGxvY2F0aW9uIGR1cmluZyB0cmFuc2l0aW9uCgkJCS8vIFRoaXMgZW5zdXJlcyB3ZSBqdW1wIHRvIHRoYXQgc3BvdCBhZnRlciB0aGUgZmFjdCwgaWYgd2UgYXJlbid0IHRoZXJlIGFscmVhZHkuCgkJCWlmICggJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpICE9PSB0aGlzLnRvU2Nyb2xsICkgewoJCQkJdGhpcy5zY3JvbGxQYWdlKCk7CgkJCX0KCgkJCXRoaXMuZGVmZXJyZWQucmVzb2x2ZSggdGhpcy5uYW1lLCB0aGlzLnJldmVyc2UsIHRoaXMuJHRvLCB0aGlzLiRmcm9tLCB0cnVlICk7CgkJfSwKCgkJZG9uZU91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKSB7CgkJCXRoaXMuYmVmb3JlRG9uZU91dCgpOwoJCQl0aGlzLnN0YXJ0SW4oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKTsKCQl9LAoKCQloaWRlSW46IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQkJLy8gUHJldmVudCBmbGlja2VyaW5nIGluIHBob25lZ2FwIGNvbnRhaW5lcjogc2VlIGNvbW1lbnRzIGF0ICM0MDI0IHJlZ2FyZGluZyBpT1MKCQkJdGhpcy4kdG8uY3NzKCAiei1pbmRleCIsIC0xMCApOwoJCQljYWxsYmFjay5jYWxsKCB0aGlzICk7CgkJCXRoaXMuJHRvLmNzcyggInotaW5kZXgiLCAiIiApOwoJCX0sCgoJCXNjcm9sbFBhZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBCeSB1c2luZyBzY3JvbGxUbyBpbnN0ZWFkIG9mIHNpbGVudFNjcm9sbCwgd2UgY2FuIGtlZXAgdGhpbmdzIGJldHRlciBpbiBvcmRlcgoJCQkvLyBKdXN0IHRvIGJlIHByZWNhdXRpb3MsIGRpc2FibGUgc2Nyb2xsc3RhcnQgbGlzdGVuaW5nIGxpa2Ugc2lsZW50U2Nyb2xsIHdvdWxkCgkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgkJCS8vaWYgd2UgYXJlIGhpZGluZyB0aGUgdXJsIGJhciBvciB0aGUgcGFnZSB3YXMgcHJldmlvdXNseSBzY3JvbGxlZCBzY3JvbGwgdG8gaGlkZSBvciByZXR1cm4gdG8gcG9zaXRpb24KCQkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyIHx8IHRoaXMudG9TY3JvbGwgIT09ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsICkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB0aGlzLnRvU2Nyb2xsICk7CgkJCX0KCgkJCS8vIHJlZW5hYmxlIHNjcm9sbHN0YXJ0IGxpc3RlbmluZyBsaWtlIHNpbGVudFNjcm9sbCB3b3VsZAoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJfSwgMTUwICk7CgkJfSwKCgkJc3RhcnRJbjogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKSB7CgkJCXRoaXMuaGlkZUluKGZ1bmN0aW9uKCkgewoJCQkJdGhpcy4kdG8uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArIHRoaXMudG9QcmVDbGFzcyApOwoKCQkJCS8vIFNlbmQgZm9jdXMgdG8gcGFnZSBhcyBpdCBpcyBub3cgZGlzcGxheTogYmxvY2sKCQkJCWlmKCAhcHJldmVudEZvY3VzICl7CgkJCQkJJC5tb2JpbGUuZm9jdXNQYWdlKCB0aGlzLiR0byApOwoJCQkJfQoKCQkJCS8vIFNldCB0byBwYWdlIGhlaWdodAoJCQkJdGhpcy4kdG8uaGVpZ2h0KCBzY3JlZW5IZWlnaHQgKyB0aGlzLnRvU2Nyb2xsICk7CgogICAgICAgICAgICAgICAgaWYgKCAhbm9uZSApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbFBhZ2UoKTsKICAgICAgICAgICAgICAgIH0KCQkJfSk7CgoJCQlpZiAoICFub25lICkgewoJCQkJdGhpcy4kdG8uYW5pbWF0aW9uQ29tcGxldGUoICQucHJveHkoZnVuY3Rpb24oKSB7CgkJCQkJdGhpcy5kb25lSW4oKTsKCQkJCX0sIHRoaXMgKSk7CgkJCX0KCgkJCXRoaXMuJHRvCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMudG9QcmVDbGFzcyApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgaW4gIiArIHJldmVyc2VDbGFzcyApOwoKCQkJaWYgKCBub25lICkgewoJCQkJdGhpcy5kb25lSW4oKTsKCQkJfQoKCQl9LAoKCQlzdGFydE91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICkgewoJCQl0aGlzLmJlZm9yZVN0YXJ0T3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApOwoKCQkJLy8gU2V0IHRoZSBmcm9tIHBhZ2UncyBoZWlnaHQgYW5kIHN0YXJ0IGl0IHRyYW5zaXRpb25pbmcgb3V0CgkJCS8vIE5vdGU6IHNldHRpbmcgYW4gZXhwbGljaXQgaGVpZ2h0IGhlbHBzIGVsaW1pbmF0ZSB0aWxpbmcgaW4gdGhlIHRyYW5zaXRpb25zCgkJCXRoaXMuJGZyb20KCQkJCS5oZWlnaHQoIHNjcmVlbkhlaWdodCArICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgb3V0IiArIHJldmVyc2VDbGFzcyApOwoJCX0sCgoKCQl0b2dnbGVWaWV3cG9ydENsYXNzOiBmdW5jdGlvbigpIHsKCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci50b2dnbGVDbGFzcyggInVpLW1vYmlsZS12aWV3cG9ydC10cmFuc2l0aW9uaW5nIHZpZXdwb3J0LSIgKyB0aGlzLm5hbWUgKTsKCQl9LAoKCQl0cmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKCQkJLy8gTk9URSBtYW55IG9mIHRoZXNlIGNvdWxkIGJlIGNhbGN1bGF0ZWQvcmVjb3JkZWQgaW4gdGhlIGNvbnN0cnVjdG9yLCBpdCdzIG15CgkJCS8vICAgICAgb3BpbmlvbiB0aGF0IGJpbmRpbmcgdGhlbSBhcyBsYXRlIGFzIHBvc3NpYmxlIGhhcyB2YWx1ZSB3aXRoIHJlZ2FyZHMgdG8KCQkJLy8gICAgICBiZXR0ZXIgdHJhbnNpdGlvbnMgd2l0aCBmZXdlciBidWdzLiBJZSwgaXQncyBub3QgZ3VhcmFudGVlZCB0aGF0IHRoZQoJCQkvLyAgICAgIG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQgYW5kIHRyYW5zaXRpb24gd2lsbCBiZSBydW4gaW1tZWRpYXRlbHkgYWZ0ZXIgYXMKCQkJLy8gICAgICBpdCBpcyB0b2RheS4gU28gd2Ugd2FpdCB1bnRpbCB0cmFuc2l0aW9uIGlzIGludm9rZWQgdG8gZ2F0aGVyIHRoZSBmb2xsb3dpbmcKCQkJdmFyIHJldmVyc2VDbGFzcyA9IHRoaXMucmV2ZXJzZSA/ICIgcmV2ZXJzZSIgOiAiIiwKCQkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpLAoJCQkJbWF4VHJhbnNpdGlvbk92ZXJyaWRlID0gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoICE9PSBmYWxzZSAmJiAkLm1vYmlsZS53aW5kb3cud2lkdGgoKSA+ICQubW9iaWxlLm1heFRyYW5zaXRpb25XaWR0aCwKCQkJCW5vbmUgPSAhJC5zdXBwb3J0LmNzc1RyYW5zaXRpb25zIHx8IG1heFRyYW5zaXRpb25PdmVycmlkZSB8fCAhdGhpcy5uYW1lIHx8IHRoaXMubmFtZSA9PT0gIm5vbmUiIHx8IE1hdGgubWF4KCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCksIHRoaXMudG9TY3JvbGwgKSA+ICQubW9iaWxlLmdldE1heFNjcm9sbEZvclRyYW5zaXRpb24oKTsKCgkJCXRoaXMudG9TY3JvbGwgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpLmxhc3RTY3JvbGwgfHwgJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJCXRoaXMudG9nZ2xlVmlld3BvcnRDbGFzcygpOwoKCQkJaWYgKCB0aGlzLiRmcm9tICYmICFub25lICkgewoJCQkJdGhpcy5zdGFydE91dCggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZG9uZU91dCggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUsIHRydWUgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZGVmZXJyZWQucHJvbWlzZSgpOwoJCX0KCX0pOwp9KSggalF1ZXJ5LCB0aGlzICk7CgoKKGZ1bmN0aW9uKCAkICkgewoKCSQubW9iaWxlLlNlcmlhbFRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQl0aGlzLmluaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuU2VyaWFsVHJhbnNpdGlvbi5wcm90b3R5cGUsICQubW9iaWxlLlRyYW5zaXRpb24ucHJvdG90eXBlLCB7CgkJc2VxdWVudGlhbDogdHJ1ZSwKCgkJYmVmb3JlRG9uZU91dDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy4kZnJvbSApIHsKCQkJCXRoaXMuY2xlYW5Gcm9tKCk7CgkJCX0KCQl9LAoKCQliZWZvcmVTdGFydE91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICkgewoJCQl0aGlzLiRmcm9tLmFuaW1hdGlvbkNvbXBsZXRlKCQucHJveHkoZnVuY3Rpb24oKSB7CgkJCQl0aGlzLmRvbmVPdXQoIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICk7CgkJCX0sIHRoaXMgKSk7CgkJfQoJfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkICkgewoKCSQubW9iaWxlLkNvbmN1cnJlbnRUcmFuc2l0aW9uID0gZnVuY3Rpb24oKSB7CgkJdGhpcy5pbml0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cgl9OwoKCSQuZXh0ZW5kKCQubW9iaWxlLkNvbmN1cnJlbnRUcmFuc2l0aW9uLnByb3RvdHlwZSwgJC5tb2JpbGUuVHJhbnNpdGlvbi5wcm90b3R5cGUsIHsKCQlzZXF1ZW50aWFsOiBmYWxzZSwKCgkJYmVmb3JlRG9uZUluOiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLiRmcm9tICkgewoJCQkJdGhpcy5jbGVhbkZyb20oKTsKCQkJfQoJCX0sCgoJCWJlZm9yZVN0YXJ0T3V0OiBmdW5jdGlvbiggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKSB7CgkJCXRoaXMuZG9uZU91dCggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKTsKCQl9Cgl9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQgKSB7CgoJLy8gZ2VuZXJhdGUgdGhlIGhhbmRsZXJzIGZyb20gdGhlIGFib3ZlCgl2YXIgZGVmYXVsdEdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCkgKiAzOwoJfTsKCgkvL3RyYW5zaXRpb24gaGFuZGxlciBkaWN0aW9uYXJ5IGZvciAzcmQgcGFydHkgdHJhbnNpdGlvbnMKCSQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycyA9IHsKCQkic2VxdWVudGlhbCI6ICQubW9iaWxlLlNlcmlhbFRyYW5zaXRpb24sCgkJInNpbXVsdGFuZW91cyI6ICQubW9iaWxlLkNvbmN1cnJlbnRUcmFuc2l0aW9uCgl9OwoKCS8vIE1ha2Ugb3VyIHRyYW5zaXRpb24gaGFuZGxlciB0aGUgcHVibGljIGRlZmF1bHQuCgkkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIgPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2VxdWVudGlhbDsKCgkkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzID0ge307CgoJLy8gSWYgdHJhbnNpdGlvbiBpcyBkZWZpbmVkLCBjaGVjayBpZiBjc3MgM0QgdHJhbnNmb3JtcyBhcmUgc3VwcG9ydGVkLCBhbmQgaWYgbm90LCBpZiBhIGZhbGxiYWNrIGlzIHNwZWNpZmllZAoJJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gPSBmdW5jdGlvbiggdHJhbnNpdGlvbiApIHsKCQlpZiAoIHRyYW5zaXRpb24gJiYgISQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF0gKSB7CgkJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF07CgkJfQoKCQlyZXR1cm4gdHJhbnNpdGlvbjsKCX07CgoJLy8gU2V0IHRoZSBnZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uIHRvIGRlZmF1bHQgaWYgbm8gaW1wbGVtZW50YXRpb24gd2FzIHNldCBieSB1c2VyCgkkLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uID0gJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB8fCBkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbjsKCn0pKCBqUXVlcnkgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgZmxpcCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MuZmxpcCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbG93IGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbG93ID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHBvcCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MucG9wID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gVXNlIHRoZSBzaW11bHRhbmVvdXMgdHJhbnNpdGlvbnMgaGFuZGxlciBmb3Igc2xpZGUgdHJhbnNpdGlvbnMKJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzLnNsaWRlID0gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzLnNpbXVsdGFuZW91czsKCi8vIFNldCB0aGUgc2xpZGUgdHJhbnNpdGlvbnMncyBmYWxsYmFjayB0byAiZmFkZSIKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZSA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZWRvd24gaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlZG93biA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZWZhZGUgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgovLyBTZXQgdGhlIHNsaWRlIHRyYW5zaXRpb25zJ3MgZmFsbGJhY2sgdG8gImZhZGUiCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGVmYWRlID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRldXAgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRldXAgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgdHVybiBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MudHVybiA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUuZGVncmFkZUlucHV0cyA9IHsKCWNvbG9yOiBmYWxzZSwKCWRhdGU6IGZhbHNlLAoJZGF0ZXRpbWU6IGZhbHNlLAoJImRhdGV0aW1lLWxvY2FsIjogZmFsc2UsCgllbWFpbDogZmFsc2UsCgltb250aDogZmFsc2UsCgludW1iZXI6IGZhbHNlLAoJcmFuZ2U6ICJudW1iZXIiLAoJc2VhcmNoOiAidGV4dCIsCgl0ZWw6IGZhbHNlLAoJdGltZTogZmFsc2UsCgl1cmw6IGZhbHNlLAoJd2VlazogZmFsc2UKfTsKLy8gQmFja2NvbXBhdCByZW1vdmUgaW4gMS41CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuZGVncmFkZUlucHV0cyA9ICQubW9iaWxlLmRlZ3JhZGVJbnB1dHM7CgovLyBBdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRlZ3JhZGVJbnB1dHNXaXRoaW4gPSBmdW5jdGlvbiggdGFyZ2V0ICkgewoKCXRhcmdldCA9ICQoIHRhcmdldCApOwoKCS8vIERlZ3JhZGUgaW5wdXRzIHRvIGF2b2lkIHBvb3JseSBpbXBsZW1lbnRlZCBuYXRpdmUgZnVuY3Rpb25hbGl0eQoJdGFyZ2V0LmZpbmQoICJpbnB1dCIgKS5ub3QoICQubW9iaWxlLnBhZ2UucHJvdG90eXBlLmtlZXBOYXRpdmVTZWxlY3RvcigpICkuZWFjaChmdW5jdGlvbigpIHsKCQl2YXIgZWxlbWVudCA9ICQoIHRoaXMgKSwKCQkJdHlwZSA9IHRoaXMuZ2V0QXR0cmlidXRlKCAidHlwZSIgKSwKCQkJb3B0VHlwZSA9ICQubW9iaWxlLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSB8fCAidGV4dCIsCgkJCWh0bWwsIGhhc1R5cGUsIGZpbmRzdHIsIHJlcHN0cjsKCgkJaWYgKCAkLm1vYmlsZS5kZWdyYWRlSW5wdXRzWyB0eXBlIF0gKSB7CgkJCWh0bWwgPSAkKCAiPGRpdj4iICkuaHRtbCggZWxlbWVudC5jbG9uZSgpICkuaHRtbCgpOwoJCQkvLyBJbiBJRSBicm93c2VycywgdGhlIHR5cGUgc29tZXRpbWVzIGRvZXNuJ3QgZXhpc3QgaW4gdGhlIGNsb25lZCBtYXJrdXAsIHNvIHdlIHJlcGxhY2UgdGhlIGNsb3NpbmcgdGFnIGluc3RlYWQKCQkJaGFzVHlwZSA9IGh0bWwuaW5kZXhPZiggIiB0eXBlPSIgKSA+IC0xOwoJCQlmaW5kc3RyID0gaGFzVHlwZSA/IC9ccyt0eXBlPVsiJ10/XHcrWyciXT8vIDogL1wvPz4vOwoJCQlyZXBzdHIgPSAiIHR5cGU9XCIiICsgb3B0VHlwZSArICJcIiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0eXBlPVwiIiArIHR5cGUgKyAiXCIiICsgKCBoYXNUeXBlID8gIiIgOiAiPiIgKTsKCgkJCWVsZW1lbnQucmVwbGFjZVdpdGgoIGh0bWwucmVwbGFjZSggZmluZHN0ciwgcmVwc3RyICkgKTsKCQl9Cgl9KTsKCn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUucGFnZSIsICQubW9iaWxlLnBhZ2UsIHsKCW9wdGlvbnM6IHsKCgkJLy8gQWNjZXB0cyBsZWZ0LCByaWdodCBhbmQgbm9uZQoJCWNsb3NlQnRuOiAibGVmdCIsCgkJY2xvc2VCdG5UZXh0OiAiQ2xvc2UiLAoJCW92ZXJsYXlUaGVtZTogImEiLAoJCWNvcm5lcnM6IHRydWUsCgkJZGlhbG9nOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoJCWlmKCB0aGlzLm9wdGlvbnMuZGlhbG9nICl7CgoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJX2lzQ2xvc2VhYmxlOiBmYWxzZSwKCQkJCV9pbm5lcjogdGhpcy5lbGVtZW50LmNoaWxkcmVuKCksCgkJCQlfaGVhZGVyQ2xvc2VCdXR0b246IG51bGwKCQkJfSk7CgoJCQlpZiggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJCXRoaXMuX3NldENsb3NlQnRuKCB0aGlzLm9wdGlvbnMuY2xvc2VCdG4gKTsKCQkJfQoJCX0KCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCS8vIENsYXNzIHRoZSBtYXJrdXAgZm9yIGRpYWxvZyBzdHlsaW5nIGFuZCB3cmFwIGludGVyaW9yCgkJaWYoIHRoaXMub3B0aW9ucy5kaWFsb2cgKXsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktZGlhbG9nIiApCgkJCQkud3JhcElubmVyKCAkKCAiPGRpdi8+IiwgewoKCQkJCQkvLyBBUklBIHJvbGUKCQkJCQkicm9sZSIgOiAiZGlhbG9nIiwKCQkJCQkiY2xhc3MiIDogInVpLWRpYWxvZy1jb250YWluIHVpLW92ZXJsYXktc2hhZG93IiArCgkJCQkJCSggdGhpcy5vcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIgKQoJCQkJfSkpOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBjbG9zZUJ1dHRvbkxvY2F0aW9uLCBjbG9zZUJ1dHRvblRleHQsCgkJCWN1cnJlbnRPcHRzID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9pbm5lci50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCAhIW9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLm92ZXJsYXlUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoICQubW9iaWxlLmFjdGl2ZVBhZ2VbIDAgXSA9PT0gdGhpcy5lbGVtZW50WyAwIF0gKSB7CgkJCQljdXJyZW50T3B0cy5vdmVybGF5VGhlbWUgPSBvcHRpb25zLm92ZXJsYXlUaGVtZTsKCQkJCXRoaXMuX2hhbmRsZVBhZ2VCZWZvcmVTaG93KCk7CgkJCX0KCQl9CgoJCWlmICggb3B0aW9ucy5jbG9zZUJ0blRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJY2xvc2VCdXR0b25Mb2NhdGlvbiA9IGN1cnJlbnRPcHRzLmNsb3NlQnRuOwoJCQljbG9zZUJ1dHRvblRleHQgPSBvcHRpb25zLmNsb3NlQnRuVGV4dDsKCQl9CgoJCWlmICggb3B0aW9ucy5jbG9zZUJ0biAhPT0gdW5kZWZpbmVkICkgewoJCQljbG9zZUJ1dHRvbkxvY2F0aW9uID0gb3B0aW9ucy5jbG9zZUJ0bjsKCQl9CgoJCWlmICggY2xvc2VCdXR0b25Mb2NhdGlvbiApIHsKCQkJdGhpcy5fc2V0Q2xvc2VCdG4oIGNsb3NlQnV0dG9uTG9jYXRpb24sIGNsb3NlQnV0dG9uVGV4dCApOwoJCX0KCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0sCgoJX2hhbmRsZVBhZ2VCZWZvcmVTaG93OiBmdW5jdGlvbiAoKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICkgewoJCQl0aGlzLnJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQoKTsKCQkJdGhpcy5zZXRDb250YWluZXJCYWNrZ3JvdW5kKCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5fc3VwZXIoKTsKCQl9Cgl9LAoKCV9zZXRDbG9zZUJ0bjogZnVuY3Rpb24oIGxvY2F0aW9uLCB0ZXh0ICkgewoJCXZhciBkc3QsCgkJCWJ0biA9IHRoaXMuX2hlYWRlckNsb3NlQnV0dG9uOwoKCQkvLyBTYW5pdGl6ZSB2YWx1ZQoJCWxvY2F0aW9uID0gImxlZnQiID09PSBsb2NhdGlvbiA/ICJsZWZ0IiA6ICJyaWdodCIgPT09IGxvY2F0aW9uID8gInJpZ2h0IiA6ICJub25lIjsKCgkJaWYgKCAibm9uZSIgPT09IGxvY2F0aW9uICkgewoJCQlpZiAoIGJ0biApIHsKCQkJCWJ0bi5yZW1vdmUoKTsKCQkJCWJ0biA9IG51bGw7CgkJCX0KCQl9IGVsc2UgaWYgKCBidG4gKSB7CgkJCWJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi1sZWZ0IHVpLWJ0bi1yaWdodCIgKS5hZGRDbGFzcyggInVpLWJ0bi0iICsgbG9jYXRpb24gKTsKCQkJaWYgKCB0ZXh0ICkgewoJCQkJYnRuLnRleHQoIHRleHQgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCWRzdCA9IHRoaXMuX2lubmVyLmZpbmQoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKS5maXJzdCgpOwoJCQlidG4gPSAkKCAiPGE+PC9hPiIsIHsKCQkJCQkicm9sZSI6ICJidXR0b24iLAoJCQkJCSJocmVmIjogIiMiLAoJCQkJCSJjbGFzcyI6ICJ1aS1idG4gdWktY29ybmVyLWFsbCB1aS1pY29uLWRlbGV0ZSB1aS1idG4taWNvbi1ub3RleHQgdWktYnRuLSIgKyBsb2NhdGlvbgoJCQkJfSkKCQkJCS50ZXh0KCB0ZXh0IHx8IHRoaXMub3B0aW9ucy5jbG9zZUJ0blRleHQgfHwgIiIgKQoJCQkJLnByZXBlbmRUbyggZHN0ICk7CgkJCXRoaXMuX29uKCBidG4sIHsgY2xpY2s6ICJjbG9zZSIgfSApOwoJCX0KCgkJdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24gPSBidG47Cgl9LAoKCS8vIENsb3NlIG1ldGhvZCBnb2VzIGJhY2sgaW4gaGlzdG9yeQoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCXZhciBpZHgsIGRzdCwgaGlzdCA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnk7CgoJCQlpZiAoICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICYmIGhpc3QuYWN0aXZlSW5kZXggPiAwICkgewoJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQl9IGVsc2UgewoJCQkJaWR4ID0gTWF0aC5tYXgoIDAsIGhpc3QuYWN0aXZlSW5kZXggLSAxICk7CgkJCQlkc3QgPSBoaXN0LnN0YWNrWyBpZHggXS5wYWdlVXJsIHx8IGhpc3Quc3RhY2tbIGlkeCBdLnVybDsKCQkJCWhpc3QucHJldmlvdXNJbmRleCA9IGhpc3QuYWN0aXZlSW5kZXg7CgkJCQloaXN0LmFjdGl2ZUluZGV4ID0gaWR4OwoJCQkJaWYgKCAhJC5tb2JpbGUucGF0aC5pc1BhdGgoIGRzdCApICkgewoJCQkJCWRzdCA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCAiIyIgKyBkc3QgKTsKCQkJCX0KCgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBkc3QsIHsgZGlyZWN0aW9uOiAiYmFjayIsIGNoYW5nZUhhc2g6IGZhbHNlLCBmcm9tSGFzaENoYW5nZTogdHJ1ZSB9ICk7CgkJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuZGlhbG9nIiwgewoJb3B0aW9uczogewoKCQkvLyBBY2NlcHRzIGxlZnQsIHJpZ2h0IGFuZCBub25lCgkJY2xvc2VCdG46ICJsZWZ0IiwKCQljbG9zZUJ0blRleHQ6ICJDbG9zZSIsCgkJb3ZlcmxheVRoZW1lOiAiYSIsCgkJY29ybmVyczogdHJ1ZQoJfSwKCgkvLyBPdmVycmlkZSB0aGUgdGhlbWUgc2V0IGJ5IHRoZSBwYWdlIHBsdWdpbiBvbiBwYWdlc2hvdwoJX2hhbmRsZVBhZ2VCZWZvcmVTaG93OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9pc0Nsb3NlYWJsZSA9IHRydWU7CgkJaWYgKCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICkgewoJCQl0aGlzLmVsZW1lbnQKCQkJCS5wYWdlKCAicmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCIgKQoJCQkJLnBhZ2UoICJzZXRDb250YWluZXJCYWNrZ3JvdW5kIiwgdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoJCX0KCX0sCgoJX2hhbmRsZVBhZ2VCZWZvcmVIaWRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9pc0Nsb3NlYWJsZSA9IGZhbHNlOwoJfSwKCgkvLyBjbGljayBhbmQgc3VibWl0IGV2ZW50czoKCS8vIC0gY2xpY2tzIGFuZCBzdWJtaXRzIHNob3VsZCB1c2UgdGhlIGNsb3NpbmcgdHJhbnNpdGlvbiB0aGF0IHRoZSBkaWFsb2cKCS8vICAgb3BlbmVkIHdpdGggdW5sZXNzIGEgZGF0YS10cmFuc2l0aW9uIGlzIHNwZWNpZmllZCBvbiB0aGUgbGluay9mb3JtCgkvLyAtIGlmIHRoZSBjbGljayB3YXMgb24gdGhlIGNsb3NlIGJ1dHRvbiwgb3IgdGhlIGxpbmsgaGFzIGEgZGF0YS1yZWw9ImJhY2siCgkvLyAgIGl0J2xsIGdvIGJhY2sgaW4gaGlzdG9yeSBuYXR1cmFsbHkKCV9oYW5kbGVWQ2xpY2tTdWJtaXQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgYXR0cnMsCgkJCSR0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCBldmVudC50eXBlID09PSAidmNsaWNrIiA/ICJhIiA6ICJmb3JtIiApOwoKCQlpZiAoICR0YXJnZXQubGVuZ3RoICYmICEkdGFyZ2V0LmpxbURhdGEoICJ0cmFuc2l0aW9uIiApICkgewoJCQlhdHRycyA9IHt9OwoJCQlhdHRyc1sgImRhdGEtIiArICQubW9iaWxlLm5zICsgInRyYW5zaXRpb24iIF0gPQoJCQkJKCAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpIHx8IHt9IClbICJ0cmFuc2l0aW9uIiBdIHx8CgkJCQkkLm1vYmlsZS5kZWZhdWx0RGlhbG9nVHJhbnNpdGlvbjsKCQkJYXR0cnNbICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJkaXJlY3Rpb24iIF0gPSAicmV2ZXJzZSI7CgkJCSR0YXJnZXQuYXR0ciggYXR0cnMgKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQlvcHRzID0gdGhpcy5vcHRpb25zOwoKCQkvLyBDbGFzcyB0aGUgbWFya3VwIGZvciBkaWFsb2cgc3R5bGluZyBhbmQgd3JhcCBpbnRlcmlvcgoJCWVsZW0uYWRkQ2xhc3MoICJ1aS1kaWFsb2ciICkKCQkJLndyYXBJbm5lciggJCggIjxkaXYvPiIsIHsKCgkJCQkvLyBBUklBIHJvbGUKCQkJCSJyb2xlIiA6ICJkaWFsb2ciLAoJCQkJImNsYXNzIiA6ICJ1aS1kaWFsb2ctY29udGFpbiB1aS1vdmVybGF5LXNoYWRvdyIgKwoJCQkJCSggISFvcHRzLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIgKQoJCQl9KSk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9pc0Nsb3NlYWJsZTogZmFsc2UsCgkJCV9pbm5lcjogZWxlbS5jaGlsZHJlbigpLAoJCQlfaGVhZGVyQ2xvc2VCdXR0b246IG51bGwKCQl9KTsKCgkJdGhpcy5fb24oIGVsZW0sIHsKCQkJdmNsaWNrOiAiX2hhbmRsZVZDbGlja1N1Ym1pdCIsCgkJCXN1Ym1pdDogIl9oYW5kbGVWQ2xpY2tTdWJtaXQiLAoJCQlwYWdlYmVmb3Jlc2hvdzogIl9oYW5kbGVQYWdlQmVmb3JlU2hvdyIsCgkJCXBhZ2ViZWZvcmVoaWRlOiAiX2hhbmRsZVBhZ2VCZWZvcmVIaWRlIgoJCX0pOwoKCQl0aGlzLl9zZXRDbG9zZUJ0biggb3B0cy5jbG9zZUJ0biApOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGNsb3NlQnV0dG9uTG9jYXRpb24sIGNsb3NlQnV0dG9uVGV4dCwKCQkJY3VycmVudE9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX2lubmVyLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsICEhb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMub3ZlcmxheVRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggJC5tb2JpbGUuYWN0aXZlUGFnZVsgMCBdID09PSB0aGlzLmVsZW1lbnRbIDAgXSApIHsKCQkJCWN1cnJlbnRPcHRzLm92ZXJsYXlUaGVtZSA9IG9wdGlvbnMub3ZlcmxheVRoZW1lOwoJCQkJdGhpcy5faGFuZGxlUGFnZUJlZm9yZVNob3coKTsKCQkJfQoJCX0KCgkJaWYgKCBvcHRpb25zLmNsb3NlQnRuVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQljbG9zZUJ1dHRvbkxvY2F0aW9uID0gY3VycmVudE9wdHMuY2xvc2VCdG47CgkJCWNsb3NlQnV0dG9uVGV4dCA9IG9wdGlvbnMuY2xvc2VCdG5UZXh0OwoJCX0KCgkJaWYgKCBvcHRpb25zLmNsb3NlQnRuICE9PSB1bmRlZmluZWQgKSB7CgkJCWNsb3NlQnV0dG9uTG9jYXRpb24gPSBvcHRpb25zLmNsb3NlQnRuOwoJCX0KCgkJaWYgKCBjbG9zZUJ1dHRvbkxvY2F0aW9uICkgewoJCQl0aGlzLl9zZXRDbG9zZUJ0biggY2xvc2VCdXR0b25Mb2NhdGlvbiwgY2xvc2VCdXR0b25UZXh0ICk7CgkJfQoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfc2V0Q2xvc2VCdG46IGZ1bmN0aW9uKCBsb2NhdGlvbiwgdGV4dCApIHsKCQl2YXIgZHN0LAoJCQlidG4gPSB0aGlzLl9oZWFkZXJDbG9zZUJ1dHRvbjsKCgkJLy8gU2FuaXRpemUgdmFsdWUKCQlsb2NhdGlvbiA9ICJsZWZ0IiA9PT0gbG9jYXRpb24gPyAibGVmdCIgOiAicmlnaHQiID09PSBsb2NhdGlvbiA/ICJyaWdodCIgOiAibm9uZSI7CgoJCWlmICggIm5vbmUiID09PSBsb2NhdGlvbiApIHsKCQkJaWYgKCBidG4gKSB7CgkJCQlidG4ucmVtb3ZlKCk7CgkJCQlidG4gPSBudWxsOwoJCQl9CgkJfSBlbHNlIGlmICggYnRuICkgewoJCQlidG4ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tbGVmdCB1aS1idG4tcmlnaHQiICkuYWRkQ2xhc3MoICJ1aS1idG4tIiArIGxvY2F0aW9uICk7CgkJCWlmICggdGV4dCApIHsKCQkJCWJ0bi50ZXh0KCB0ZXh0ICk7CgkJCX0KCQl9IGVsc2UgewoJCQlkc3QgPSB0aGlzLl9pbm5lci5maW5kKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkuZmlyc3QoKTsKCQkJYnRuID0gJCggIjxhPjwvYT4iLCB7CgkJCQkJInJvbGUiOiAiYnV0dG9uIiwKCQkJCQkiaHJlZiI6ICIjIiwKCQkJCQkiY2xhc3MiOiAidWktYnRuIHVpLWNvcm5lci1hbGwgdWktaWNvbi1kZWxldGUgdWktYnRuLWljb24tbm90ZXh0IHVpLWJ0bi0iICsgbG9jYXRpb24KCQkJCX0pCgkJCQkudGV4dCggdGV4dCB8fCB0aGlzLm9wdGlvbnMuY2xvc2VCdG5UZXh0IHx8ICIiICkKCQkJCS5wcmVwZW5kVG8oIGRzdCApOwoJCQl0aGlzLl9vbiggYnRuLCB7IGNsaWNrOiAiY2xvc2UiIH0gKTsKCQl9CgoJCXRoaXMuX2hlYWRlckNsb3NlQnV0dG9uID0gYnRuOwoJfSwKCgkvLyBDbG9zZSBtZXRob2QgZ29lcyBiYWNrIGluIGhpc3RvcnkKCWNsb3NlOiBmdW5jdGlvbigpIHsKCQl2YXIgaWR4LCBkc3QsIGhpc3QgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5OwoKCQlpZiAoIHRoaXMuX2lzQ2xvc2VhYmxlICkgewoJCQl0aGlzLl9pc0Nsb3NlYWJsZSA9IGZhbHNlOwoJCQkvLyBJZiB0aGUgaGFzaCBsaXN0ZW5pbmcgaXMgZW5hYmxlZCBhbmQgdGhlcmUgaXMgYXQgbGVhc3Qgb25lIHByZWNlZGluZyBoaXN0b3J5CgkJCS8vIGVudHJ5IGl0J3Mgb2sgdG8gZ28gYmFjay4gSW5pdGlhbCBwYWdlcyB3aXRoIHRoZSBkaWFsb2cgaGFzaCBzdGF0ZSBhcmUgYW4gZXhhbXBsZQoJCQkvLyB3aGVyZSB0aGUgc3RhY2sgY2hlY2sgaXMgbmVjZXNzYXJ5CgkJCWlmICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgJiYgaGlzdC5hY3RpdmVJbmRleCA+IDAgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCX0gZWxzZSB7CgkJCQlpZHggPSBNYXRoLm1heCggMCwgaGlzdC5hY3RpdmVJbmRleCAtIDEgKTsKCQkJCWRzdCA9IGhpc3Quc3RhY2tbIGlkeCBdLnBhZ2VVcmwgfHwgaGlzdC5zdGFja1sgaWR4IF0udXJsOwoJCQkJaGlzdC5wcmV2aW91c0luZGV4ID0gaGlzdC5hY3RpdmVJbmRleDsKCQkJCWhpc3QuYWN0aXZlSW5kZXggPSBpZHg7CgkJCQlpZiAoICEkLm1vYmlsZS5wYXRoLmlzUGF0aCggZHN0ICkgKSB7CgkJCQkJZHN0ID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGRzdCApOwoJCQkJfQoKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGRzdCwgeyBkaXJlY3Rpb246ICJiYWNrIiwgY2hhbmdlSGFzaDogZmFsc2UsIGZyb21IYXNoQ2hhbmdlOiB0cnVlIH0gKTsKCQkJfQoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHJJbml0aWFsTGV0dGVyID0gLyhbQS1aXSkvZzsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbGxhcHNpYmxlIiwgewoJb3B0aW9uczogewoJCWVuaGFuY2VkOiBmYWxzZSwKCQlleHBhbmRDdWVUZXh0OiBudWxsLAoJCWNvbGxhcHNlQ3VlVGV4dDogbnVsbCwKCQljb2xsYXBzZWQ6IHRydWUsCgkJaGVhZGluZzogImgxLGgyLGgzLGg0LGg1LGg2LGxlZ2VuZCIsCgkJY29sbGFwc2VkSWNvbjogbnVsbCwKCQlleHBhbmRlZEljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQl0aGVtZTogbnVsbCwKCQljb250ZW50VGhlbWU6IG51bGwsCgkJaW5zZXQ6IG51bGwsCgkJY29ybmVyczogbnVsbCwKCQltaW5pOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQl1aSA9IHsKCQkJCWFjY29yZGlvbjogZWxlbQoJCQkJCS5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiICsKCQkJCQkJKCAkLm1vYmlsZS5jb2xsYXBzaWJsZXNldCA/ICIsIDptb2JpbGUtY29sbGFwc2libGVzZXQiIDogIiIgKSApCgkJCQkJLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0IiApCgkJCX07CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV91aTogdWkKCQl9KTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXVpLmhlYWRpbmcgPSAkKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmciLCB0aGlzLmVsZW1lbnRbIDAgXSApOwoJCQl1aS5jb250ZW50ID0gdWkuaGVhZGluZy5uZXh0KCk7CgkJCXVpLmFuY2hvciA9ICQoICJhIiwgdWkuaGVhZGluZ1sgMCBdICkuZmlyc3QoKTsKCQkJdWkuc3RhdHVzID0gdWkuYW5jaG9yLmNoaWxkcmVuKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzIiApOwoJCX0gZWxzZSB7CgkJCXRoaXMuX2VuaGFuY2UoIGVsZW0sIHVpICk7CgkJfQoKCQl0aGlzLl9vbiggdWkuaGVhZGluZywgewoJCQkidGFwIjogZnVuY3Rpb24oKSB7CgkJCQl1aS5oZWFkaW5nLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0sCgoJCQkiY2xpY2siOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggIXVpLmhlYWRpbmcuaGFzQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIgKSApOwoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJfSk7Cgl9LAoKCS8vIEFkanVzdCB0aGUga2V5cyBpbnNpZGUgb3B0aW9ucyBmb3IgaW5oZXJpdGVkIHZhbHVlcwoJX2dldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBrZXksCgkJCWFjY29yZGlvbiA9IHRoaXMuX3VpLmFjY29yZGlvbiwKCQkJYWNjb3JkaW9uV2lkZ2V0ID0gdGhpcy5fdWkuYWNjb3JkaW9uV2lkZ2V0OwoKCQkvLyBDb3B5IG9wdGlvbnMKCQlvcHRpb25zID0gJC5leHRlbmQoIHt9LCBvcHRpb25zICk7CgoJCWlmICggYWNjb3JkaW9uLmxlbmd0aCAmJiAhYWNjb3JkaW9uV2lkZ2V0ICkgewoJCQl0aGlzLl91aS5hY2NvcmRpb25XaWRnZXQgPQoJCQlhY2NvcmRpb25XaWRnZXQgPSBhY2NvcmRpb24uZGF0YSggIm1vYmlsZS1jb2xsYXBzaWJsZXNldCIgKTsKCQl9CgoJCWZvciAoIGtleSBpbiBvcHRpb25zICkgewoKCQkJLy8gUmV0cmlldmUgdGhlIG9wdGlvbiB2YWx1ZSBmaXJzdCBmcm9tIHRoZSBvcHRpb25zIG9iamVjdCBwYXNzZWQgaW4gYW5kLCBpZgoJCQkvLyBudWxsLCBmcm9tIHRoZSBwYXJlbnQgYWNjb3JkaW9uIG9yLCBpZiB0aGF0J3MgbnVsbCB0b28sIG9yIGlmIHRoZXJlJ3Mgbm8KCQkJLy8gcGFyZW50IGFjY29yZGlvbiwgdGhlbiBmcm9tIHRoZSBkZWZhdWx0cy4KCQkJb3B0aW9uc1sga2V5IF0gPQoJCQkJKCBvcHRpb25zWyBrZXkgXSAhPSBudWxsICkgPyBvcHRpb25zWyBrZXkgXSA6CgkJCQkoIGFjY29yZGlvbldpZGdldCApID8gYWNjb3JkaW9uV2lkZ2V0Lm9wdGlvbnNbIGtleSBdIDoKCQkJCWFjY29yZGlvbi5sZW5ndGggPyAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIGFjY29yZGlvblsgMCBdLAoJCQkJCWtleS5yZXBsYWNlKCBySW5pdGlhbExldHRlciwgIi0kMSIgKS50b0xvd2VyQ2FzZSgpICk6CgkJCQludWxsOwoKCQkJaWYgKCBudWxsID09IG9wdGlvbnNbIGtleSBdICkgewoJCQkJb3B0aW9uc1sga2V5IF0gPSAkLm1vYmlsZS5jb2xsYXBzaWJsZS5kZWZhdWx0c1sga2V5IF07CgkJCX0KCQl9CgoJCXJldHVybiBvcHRpb25zOwoJfSwKCglfdGhlbWVDbGFzc0Zyb21PcHRpb246IGZ1bmN0aW9uKCBwcmVmaXgsIHZhbHVlICkgewoJCXJldHVybiAoIHZhbHVlID8gKCB2YWx1ZSA9PT0gIm5vbmUiID8gIiIgOiBwcmVmaXggKyB2YWx1ZSApIDogIiIgKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCBlbGVtLCB1aSApIHsKCQl2YXIgaWNvbmNsYXNzLAoJCQlvcHRzID0gdGhpcy5fZ2V0T3B0aW9ucyggdGhpcy5vcHRpb25zICksCgkJCWNvbnRlbnRUaGVtZUNsYXNzID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMuY29udGVudFRoZW1lICk7CgoJCWVsZW0uYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSAiICsKCQkJKCBvcHRzLmluc2V0ID8gInVpLWNvbGxhcHNpYmxlLWluc2V0ICIgOiAiIiApICsKCQkJKCBvcHRzLmluc2V0ICYmIG9wdHMuY29ybmVycyA/ICJ1aS1jb3JuZXItYWxsICIgOiAiIiApICsKCQkJKCBjb250ZW50VGhlbWVDbGFzcyA/ICJ1aS1jb2xsYXBzaWJsZS10aGVtZWQtY29udGVudCAiIDogIiIgKSApOwoJCXVpLm9yaWdpbmFsSGVhZGluZyA9IGVsZW0uY2hpbGRyZW4oIHRoaXMub3B0aW9ucy5oZWFkaW5nICkuZmlyc3QoKSwKCQl1aS5jb250ZW50ID0gZWxlbQoJCQkud3JhcElubmVyKCAiPGRpdiAiICsKCQkJCSJjbGFzcz0ndWktY29sbGFwc2libGUtY29udGVudCAiICsKCQkJCWNvbnRlbnRUaGVtZUNsYXNzICsgIic+PC9kaXY+IiApCgkJCS5jaGlsZHJlbiggIi51aS1jb2xsYXBzaWJsZS1jb250ZW50IiApLAoJCXVpLmhlYWRpbmcgPSB1aS5vcmlnaW5hbEhlYWRpbmc7CgoJCS8vIFJlcGxhY2UgY29sbGFwc2libGVIZWFkaW5nIGlmIGl0J3MgYSBsZWdlbmQKCQlpZiAoIHVpLmhlYWRpbmcuaXMoICJsZWdlbmQiICkgKSB7CgkJCXVpLmhlYWRpbmcgPSAkKCAiPGRpdiByb2xlPSdoZWFkaW5nJz4iKyB1aS5oZWFkaW5nLmh0bWwoKSArIjwvZGl2PiIgKTsKCQkJdWkucGxhY2Vob2xkZXIgPSAkKCAiPGRpdj48IS0tIHBsYWNlaG9sZGVyIGZvciBsZWdlbmQgLS0+PC9kaXY+IiApLmluc2VydEJlZm9yZSggdWkub3JpZ2luYWxIZWFkaW5nICk7CgkJCXVpLm9yaWdpbmFsSGVhZGluZy5yZW1vdmUoKTsKCQl9CgoJCWljb25jbGFzcyA9ICggb3B0cy5jb2xsYXBzZWQgPyAoIG9wdHMuY29sbGFwc2VkSWNvbiA/ICJ1aS1pY29uLSIgKyBvcHRzLmNvbGxhcHNlZEljb24gOiAiIiApOgoJCQkoIG9wdHMuZXhwYW5kZWRJY29uID8gInVpLWljb24tIiArIG9wdHMuZXhwYW5kZWRJY29uIDogIiIgKSApOwoKCQl1aS5zdGF0dXMgPSAkKCAiPHNwYW4gY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzJz48L3NwYW4+IiApOwoJCXVpLmFuY2hvciA9IHVpLmhlYWRpbmcKCQkJLmRldGFjaCgpCgkJCS8vbW9kaWZ5IG1hcmt1cCAmIGF0dHJpYnV0ZXMKCQkJLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZyIgKQoJCQkuYXBwZW5kKCB1aS5zdGF0dXMgKQoJCQkud3JhcElubmVyKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctdG9nZ2xlJz48L2E+IiApCgkJCS5maW5kKCAiYSIgKQoJCQkJLmZpcnN0KCkKCQkJCS5hZGRDbGFzcyggInVpLWJ0biAiICsKCQkJCQkoIGljb25jbGFzcyA/IGljb25jbGFzcyArICIgIiA6ICIiICkgKwoJCQkJCSggaWNvbmNsYXNzID8gKCAidWktYnRuLWljb24tIiArCgkJCQkJCSggb3B0cy5pY29ucG9zID09PSAicmlnaHQiID8gInJpZ2h0IiA6ICJsZWZ0IiApICkgKwoJCQkJCQkiICIgOiAiIiApICsKCQkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJ0bi0iLCBvcHRzLnRoZW1lICkgKyAiICIgKwoJCQkJCSggb3B0cy5taW5pID8gInVpLW1pbmkgIiA6ICIiICkgKTsKCgkJLy9kcm9wIGhlYWRpbmcgaW4gYmVmb3JlIGNvbnRlbnQKCQl1aS5oZWFkaW5nLmluc2VydEJlZm9yZSggdWkuY29udGVudCApOwoKCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggdGhpcy5vcHRpb25zLmNvbGxhcHNlZCApOwoKCQlyZXR1cm4gdWk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBrZXksIG9wdGlvbnMgPSB7fTsKCgkJZm9yICgga2V5IGluICQubW9iaWxlLmNvbGxhcHNpYmxlLmRlZmF1bHRzICkgewoJCQlvcHRpb25zWyBrZXkgXSA9IHRoaXMub3B0aW9uc1sga2V5IF07CgkJfQoKCQl0aGlzLl9zZXRPcHRpb25zKCBvcHRpb25zICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNDb2xsYXBzZWQsIG5ld1RoZW1lLCBvbGRUaGVtZSwKCQkJZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJY3VycmVudE9wdHMgPSB0aGlzLm9wdGlvbnMsCgkJCXVpID0gdGhpcy5fdWksCgkJCWFuY2hvciA9IHVpLmFuY2hvciwKCQkJc3RhdHVzID0gdWkuc3RhdHVzLAoJCQlvcHRzID0gdGhpcy5fZ2V0T3B0aW9ucyggb3B0aW9ucyApOwoKCQkvLyBGaXJzdCBhbmQgZm9yZW1vc3Qgd2UgbmVlZCB0byBtYWtlIHN1cmUgdGhlIGNvbGxhcHNpYmxlIGlzIGluIHRoZSBwcm9wZXIKCQkvLyBzdGF0ZSwgaW4gY2FzZSBzb21lYm9keSBkZWNpZGVkIHRvIGNoYW5nZSB0aGUgY29sbGFwc2VkIG9wdGlvbiBhdCB0aGUKCQkvLyBzYW1lIHRpbWUgYXMgYW5vdGhlciBvcHRpb24KCQlpZiAoIG9wdGlvbnMuY29sbGFwc2VkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX2hhbmRsZUV4cGFuZENvbGxhcHNlKCBvcHRpb25zLmNvbGxhcHNlZCApOwoJCX0KCgkJaXNDb2xsYXBzZWQgPSBlbGVtLmhhc0NsYXNzKCAidWktY29sbGFwc2libGUtY29sYXBzZWQiICk7CgoJCS8vIE9ubHkgb3B0aW9ucyByZWZlcnJpbmcgdG8gdGhlIGN1cnJlbnQgc3RhdGUgbmVlZCB0byBiZSBhcHBsaWVkIHJpZ2h0IGF3YXkKCQkvLyBJdCBpcyBlbm91Z2ggdG8gc3RvcmUgb3B0aW9ucyBjb3ZlcmluZyB0aGUgYWx0ZXJuYXRlIGluIHRoaXMub3B0aW9ucy4KCQlpZiAoIGlzQ29sbGFwc2VkICkgewoJCQlpZiAoIG9wdHMuZXhwYW5kQ3VlVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQkJc3RhdHVzLnRleHQoIG9wdHMuZXhwYW5kQ3VlVGV4dCApOwoJCQl9CgkJCWlmICggb3B0cy5jb2xsYXBzZWRJY29uICE9PSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIGN1cnJlbnRPcHRzLmNvbGxhcHNlZEljb24gKSB7CgkJCQkJYW5jaG9yLnJlbW92ZUNsYXNzKCAidWktaWNvbi0iICsgY3VycmVudE9wdHMuY29sbGFwc2VkSWNvbiApOwoJCQkJfQoJCQkJaWYgKCBvcHRzLmNvbGxhcHNlZEljb24gKSB7CgkJCQkJYW5jaG9yLmFkZENsYXNzKCAidWktaWNvbi0iICsgb3B0cy5jb2xsYXBzZWRJY29uICk7CgkJCQl9CgkJCX0KCQl9IGVsc2UgewoJCQlpZiAoIG9wdHMuY29sbGFwc2VDdWVUZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQlzdGF0dXMudGV4dCggb3B0cy5jb2xsYXBzZUN1ZVRleHQgKTsKCQkJfQoJCQlpZiAoIG9wdHMuZXhwYW5kZWRJY29uICE9PSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIGN1cnJlbnRPcHRzLmV4cGFuZGVkSWNvbiApIHsKCQkJCQlhbmNob3IucmVtb3ZlQ2xhc3MoICJ1aS1pY29uLSIgKyBjdXJyZW50T3B0cy5leHBhbmRlZFdJY29uICk7CgkJCQl9CgkJCQlpZiAoIG9wdHMuZXhwYW5kZWRJY29uICkgewoJCQkJCWFuY2hvci5hZGRDbGFzcyggInVpLWljb24tIiArIG9wdHMuZXhwYW5kZWRJY29uICk7CgkJCQl9CgkJCX0KCQl9CgoJCWlmICggb3B0cy5pY29ucG9zICE9PSB1bmRlZmluZWQgKSB7CgkJCWFuY2hvci5yZW1vdmVDbGFzcyggInVpLWJ0bi1pY29uLSIgKyAoIGN1cnJlbnRPcHRzLmljb25Qb3MgPT09ICJyaWdodCIgPyAicmlnaHQiIDogImxlZnQiICkgKTsKCQkJYW5jaG9yLmFkZENsYXNzKCAidWktYnRuLWljb24tIiArICggb3B0cy5pY29uUG9zID09PSAicmlnaHQiID8gInJpZ2h0IiA6ICJsZWZ0IiApICk7CgkJfQoKCQlpZiAoIG9wdHMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJb2xkVGhlbWUgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJ0bi0iLCBjdXJyZW50T3B0cy50aGVtZSApOwoJCQluZXdUaGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYnRuLSIsIG9wdHMudGhlbWUgKTsKCQkJYW5jaG9yLnJlbW92ZUNsYXNzKCBvbGRUaGVtZSApLmFkZENsYXNzKCBuZXdUaGVtZSApOwoJCX0KCgkJaWYgKCBvcHRzLmNvbnRlbnRUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlvbGRUaGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBjdXJyZW50T3B0cy50aGVtZSApOwoJCQluZXdUaGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBvcHRzLnRoZW1lICk7CgkJCXVpLmNvbnRlbnQucmVtb3ZlQ2xhc3MoIG9sZFRoZW1lICkuYWRkQ2xhc3MoIG5ld1RoZW1lICk7CgkJfQoKCQkvLyBJdCBpcyBpbXBvcnRhbnQgdG8gYXBwbHkgImluc2V0IiBiZWZvcmUgY29ybmVycywgYmVjYXVzZSB0aGUgbmV3IHZhbHVlIG9mCgkJLy8gImluc2V0IiBjYW4gYWZmZWN0IHdoZXRoZXIgd2UgZGlzcGxheSBjb3JuZXJzIG9yIG5vdC4gTm90ZSB0aGF0IHNldHRpbmcKCQkvLyB0aGUgImluc2V0IiBvcHRpb24gdG8gZmFsc2UgZG9lcyBub3QgY2F1c2UgYSBjaGFuZ2UgaW4gdGhlIHZhbHVlIG9mCgkJLy8gdGhpcy5vcHRpb25zLmNvcm5lcnMgLSBpdCBtZXJlbHkgY2F1c2VzIGEgY2hhbmdlIGluIHRoZSBpbnRlcnByZXRhdGlvbiBvZgoJCS8vIHRoZSB2YWx1ZSBvZiB0aGUgImNvcm5lcnMiIG9wdGlvbi4KCQlpZiAoIG9wdHMuaW5zZXQgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWluc2V0Iiwgb3B0cy5pbnNldCApOwoJCQljdXJyZW50T3B0cy5pbnNldCA9IG9wdHMuaW5zZXQ7CgkJCWlmICggIW9wdHMuaW5zZXQgKSB7CgkJCQlvcHRzLmNvcm5lcnMgPSBmYWxzZTsKCQkJfQoJCX0KCgkJaWYgKCBvcHRzLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBjdXJyZW50T3B0cy5pbnNldCAmJiBvcHRzLmNvcm5lcnMgKTsKCQl9CgoJCWlmICggb3B0cy5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCWFuY2hvci50b2dnbGVDbGFzcyggInVpLW1pbmkiLCBvcHRzLm1pbmkgKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9LAoKCV9oYW5kbGVFeHBhbmRDb2xsYXBzZTogZnVuY3Rpb24oIGlzQ29sbGFwc2UgKSB7CgkJdmFyIG9wdHMgPSB0aGlzLl9nZXRPcHRpb25zKCB0aGlzLm9wdGlvbnMgKSwKCQkJdWkgPSB0aGlzLl91aTsKCgkJdWkuc3RhdHVzLnRleHQoIGlzQ29sbGFwc2UgPyBvcHRzLmV4cGFuZEN1ZVRleHQgOiBvcHRzLmNvbGxhcHNlQ3VlVGV4dCApOwoJCXVpLmhlYWRpbmcKCQkJLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICkKCQkJLmZpbmQoICJhIiApLmZpcnN0KCkKCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgb3B0cy5leHBhbmRlZEljb24sICFpc0NvbGxhcHNlICkKCgkJCS8vIGxvZ2ljIG9yIGNhdXNlIHNhbWUgaWNvbiBmb3IgZXhwYW5kZWQvY29sbGFwc2VkIHN0YXRlIHdvdWxkIHJlbW92ZSB0aGUgdWktaWNvbi1jbGFzcwoJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLSIgKyBvcHRzLmNvbGxhcHNlZEljb24sICggaXNDb2xsYXBzZSB8fCBvcHRzLmV4cGFuZGVkSWNvbiA9PT0gb3B0cy5jb2xsYXBzZWRJY29uICkgKQoJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgoJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKTsKCQl1aS5jb250ZW50CgkJCS50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbnRlbnQtY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApCgkJCS5hdHRyKCAiYXJpYS1oaWRkZW4iLCBpc0NvbGxhcHNlICkKCQkJLnRyaWdnZXIoICJ1cGRhdGVsYXlvdXQiICk7CgkJdGhpcy5vcHRpb25zLmNvbGxhcHNlZCA9IGlzQ29sbGFwc2U7CgkJdGhpcy5fdHJpZ2dlciggaXNDb2xsYXBzZSA/ICJjb2xsYXBzZSIgOiAiZXhwYW5kIiApOwoJfSwKCglleHBhbmQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2hhbmRsZUV4cGFuZENvbGxhcHNlKCBmYWxzZSApOwoJfSwKCgljb2xsYXBzZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5faGFuZGxlRXhwYW5kQ29sbGFwc2UoIHRydWUgKTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciB1aSA9IHRoaXMuX3VpLAoJCQlvcHRzID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG9wdHMuZW5oYW5jZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggdWkucGxhY2Vob2xkZXIgKSB7CgkJCXVpLm9yaWdpbmFsSGVhZGluZy5pbnNlcnRCZWZvcmUoIHVpLnBsYWNlaG9sZGVyICk7CgkJCXVpLnBsYWNlaG9sZGVyLnJlbW92ZSgpOwoJCQl1aS5oZWFkaW5nLnJlbW92ZSgpOwoJCX0gZWxzZSB7CgkJCXVpLnN0YXR1cy5yZW1vdmUoKTsKCQkJdWkuaGVhZGluZwoJCQkJLnJlbW92ZUNsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZyB1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIgKQoJCQkJLmNoaWxkcmVuKCkKCQkJCQkuY29udGVudHMoKQoJCQkJCQkudW53cmFwKCk7CgkJfQoKCQl1aS5hbmNob3IuY29udGVudHMoKS51bndyYXAoKTsKCQl1aS5jb250ZW50LmNvbnRlbnRzKCkudW53cmFwKCk7CgkJdGhpcy5lbGVtZW50CgkJCS5yZW1vdmVDbGFzcyggInVpLWNvbGxhcHNpYmxlIHVpLWNvbGxhcHNpYmxlLWNvbGxhcHNlZCAiICsKCQkJCSJ1aS1jb2xsYXBzaWJsZS10aGVtZWQtY29udGVudCB1aS1jb2xsYXBzaWJsZS1pbnNldCB1aS1jb3JuZXItYWxsIiApOwoJfQp9KTsKCi8vIERlZmF1bHRzIHRvIGJlIHVzZWQgYnkgYWxsIGluc3RhbmNlcyBvZiBjb2xsYXBzaWJsZSBpZiBwZXItaW5zdGFuY2UgdmFsdWVzCi8vIGFyZSB1bnNldCBvciBpZiBub3RoaW5nIGlzIHNwZWNpZmllZCBieSB3YXkgb2YgaW5oZXJpdGFuY2UgZnJvbSBhbiBhY2NvcmRpb24uCi8vIE5vdGUgdGhhdCB0aGlzIGhhc2ggZG9lcyBub3QgY29udGFpbiBvcHRpb25zICJjb2xsYXBzZWQiIG9yICJoZWFkaW5nIiwKLy8gYmVjYXVzZSB0aG9zZSBhcmUgbm90IGluaGVyaXRhYmxlLgokLm1vYmlsZS5jb2xsYXBzaWJsZS5kZWZhdWx0cyA9IHsKCWV4cGFuZEN1ZVRleHQ6ICIgY2xpY2sgdG8gZXhwYW5kIGNvbnRlbnRzIiwKCWNvbGxhcHNlQ3VlVGV4dDogIiBjbGljayB0byBjb2xsYXBzZSBjb250ZW50cyIsCgljb2xsYXBzZWRJY29uOiAicGx1cyIsCgljb250ZW50VGhlbWU6ICJpbmhlcml0IiwKCWV4cGFuZGVkSWNvbjogIm1pbnVzIiwKCWljb25wb3M6ICJsZWZ0IiwKCWluc2V0OiB0cnVlLAoJY29ybmVyczogdHJ1ZSwKCW1pbmk6IGZhbHNlCn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzID0gewoJX2dldFZpc2libGVzOiBmdW5jdGlvbiggJGVscywgY3JlYXRlICkgewoJCXZhciB2aXNpYmxlczsKCgkJaWYgKCBjcmVhdGUgKSB7CgkJCXZpc2libGVzID0gJGVscy5ub3QoICIudWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9IGVsc2UgewoJCQl2aXNpYmxlcyA9ICRlbHMuZmlsdGVyKCAiOnZpc2libGUiICk7CgkJCWlmICggdmlzaWJsZXMubGVuZ3RoID09PSAwICkgewoJCQkJdmlzaWJsZXMgPSAkZWxzLm5vdCggIi51aS1zY3JlZW4taGlkZGVuIiApOwoJCQl9CgkJfQoKCQlyZXR1cm4gdmlzaWJsZXM7Cgl9LAoKCV9hZGRGaXJzdExhc3RDbGFzc2VzOiBmdW5jdGlvbiggJGVscywgJHZpc2libGVzLCBjcmVhdGUgKSB7CgkJJGVscy5yZW1vdmVDbGFzcyggInVpLWZpcnN0LWNoaWxkIHVpLWxhc3QtY2hpbGQiICk7CgkJJHZpc2libGVzLmVxKCAwICkuYWRkQ2xhc3MoICJ1aS1maXJzdC1jaGlsZCIgKS5lbmQoKS5sYXN0KCkuYWRkQ2xhc3MoICJ1aS1sYXN0LWNoaWxkIiApOwoJCWlmICggIWNyZWF0ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJ1cGRhdGVsYXlvdXQiICk7CgkJfQoJfSwKCglfcmVtb3ZlRmlyc3RMYXN0Q2xhc3NlczogZnVuY3Rpb24oICRlbHMgKSB7CgkJJGVscy5yZW1vdmVDbGFzcyggInVpLWZpcnN0LWNoaWxkIHVpLWxhc3QtY2hpbGQiICk7Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBjaGlsZENvbGxhcHNpYmxlc1NlbGVjdG9yID0gIjptb2JpbGUtY29sbGFwc2libGUsICIgKyAkLm1vYmlsZS5jb2xsYXBzaWJsZS5pbml0U2VsZWN0b3I7CgokLndpZGdldCggIm1vYmlsZS5jb2xsYXBzaWJsZXNldCIsICQuZXh0ZW5kKCB7Cglpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSIsCgoJb3B0aW9uczogJC5leHRlbmQoIHsKCQllbmhhbmNlZDogZmFsc2UsCgl9LCAkLm1vYmlsZS5jb2xsYXBzaWJsZS5kZWZhdWx0cyApLAoKCV9oYW5kbGVDb2xsYXBzaWJsZUV4cGFuZDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBjbG9zZXN0Q29sbGFwc2libGUgPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLWNvbGxhcHNpYmxlIiApOwoKCQlpZiAoIGNsb3Nlc3RDb2xsYXBzaWJsZS5wYXJlbnQoKS5pcyggIjptb2JpbGUtY29sbGFwc2libGVzZXQsIDpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpIiApICkgewoJCQljbG9zZXN0Q29sbGFwc2libGUKCQkJCS5zaWJsaW5ncyggIi51aS1jb2xsYXBzaWJsZTpub3QoLnVpLWNvbGxhcHNpYmxlLWNvbGxhcHNlZCkiICkKCQkJCS5jb2xsYXBzaWJsZSggImNvbGxhcHNlIiApOwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9jbGFzc2VzOiAiIgoJCX0pOwoKCQlpZiAoICFvcHRzLmVuaGFuY2VkICkgewoJCQllbGVtLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0ICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ncm91cC10aGVtZS0iLCBvcHRzLnRoZW1lICkgKyAiICIgKwoJCQkJKCBvcHRzLmNvcm5lcnMgJiYgb3B0cy5pbnNldCA/ICJ1aS1jb3JuZXItYWxsICIgOiAiIiApICk7CgkJCXRoaXMuZWxlbWVudC5maW5kKCAkLm1vYmlsZS5jb2xsYXBzaWJsZS5pbml0U2VsZWN0b3IgKS5jb2xsYXBzaWJsZSgpOwoJCX0KCgkJdGhpcy5fb24oIGVsZW0sIHsgY29sbGFwc2libGVleHBhbmQ6ICJfaGFuZGxlQ29sbGFwc2libGVFeHBhbmQiIH0gKTsKCX0sCgoJX3RoZW1lQ2xhc3NGcm9tT3B0aW9uOiBmdW5jdGlvbiggcHJlZml4LCB2YWx1ZSApIHsKCQlyZXR1cm4gKCB2YWx1ZSA/ICggdmFsdWUgPT09ICJub25lIiA/ICIiIDogcHJlZml4ICsgdmFsdWUgKSA6ICIiICk7Cgl9LAoKCV9pbml0OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9yZWZyZXNoKCB0cnVlICk7CgoJCS8vIEJlY2F1c2UgdGhlIGNvcm5lcnMgYXJlIGhhbmRsZWQgYnkgdGhlIGNvbGxhcHNpYmxlIGl0c2VsZiBhbmQgdGhlIGRlZmF1bHQgc3RhdGUgaXMgY29sbGFwc2VkCgkJLy8gVGhhdCB3YXMgY2F1c2luZyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQxMTYKCQl0aGlzLmVsZW1lbnQKCQkJLmNoaWxkcmVuKCBjaGlsZENvbGxhcHNpYmxlc1NlbGVjdG9yICkKCQkJLmZpbHRlciggIjpqcW1EYXRhKGNvbGxhcHNlZD0nZmFsc2UnKSIgKQoJCQkuY29sbGFwc2libGUoICJleHBhbmQiICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgcmV0LAoJCQllbGVtID0gdGhpcy5lbGVtZW50LAoJCQl0aGVtZUNsYXNzID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ncm91cC10aGVtZS0iLCBvcHRpb25zLnRoZW1lICk7CgoJCWlmICggdGhlbWVDbGFzcyApIHsKCQkJZWxlbQoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWdyb3VwLXRoZW1lLSIsIHRoaXMub3B0aW9ucy50aGVtZSApICkKCQkJCS5hZGRDbGFzcyggdGhlbWVDbGFzcyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBvcHRpb25zLmNvcm5lcnMgKTsKCQl9CgoJCXJldCA9IHRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgkJdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiOm1vYmlsZS1jb2xsYXBzaWJsZSIgKS5jb2xsYXBzaWJsZSggInJlZnJlc2giICk7CgkJcmV0dXJuIHJldDsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciBlbCA9IHRoaXMuZWxlbWVudDsKCgkJdGhpcy5fcmVtb3ZlRmlyc3RMYXN0Q2xhc3NlcyggZWwuY2hpbGRyZW4oIGNoaWxkQ29sbGFwc2libGVzU2VsZWN0b3IgKSApOwoJCWVsCgkJCS5yZW1vdmVDbGFzcyggInVpLWNvbGxhcHNpYmxlLXNldCB1aS1jb3JuZXItYWxsICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ncm91cC10aGVtZSIsIHRoaXMub3B0aW9ucy50aGVtZSApICkKCQkJLmNoaWxkcmVuKCAiOm1vYmlsZS1jb2xsYXBzaWJsZSIgKQoJCQkuY29sbGFwc2libGUoICJkZXN0cm95IiApOwoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl2YXIgY29sbGFwc2libGVzSW5TZXQgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oIGNoaWxkQ29sbGFwc2libGVzU2VsZWN0b3IgKTsKCgkJJC5tb2JpbGUuY29sbGFwc2libGUucHJvdG90eXBlLmVuaGFuY2UoIGNvbGxhcHNpYmxlc0luU2V0Lm5vdCggIi51aS1jb2xsYXBzaWJsZSIgKSApOwoKCQl0aGlzLl9hZGRGaXJzdExhc3RDbGFzc2VzKCBjb2xsYXBzaWJsZXNJblNldCwgdGhpcy5fZ2V0VmlzaWJsZXMoIGNvbGxhcHNpYmxlc0luU2V0LCBjcmVhdGUgKSwgY3JlYXRlICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlZnJlc2goIGZhbHNlICk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzICkgKTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gRGVwcmVjYXRlZCBpbiAxLjQKJC5mbi5maWVsZGNvbnRhaW4gPSBmdW5jdGlvbigvKiBvcHRpb25zICovKSB7CglyZXR1cm4gdGhpcy5hZGRDbGFzcyggInVpLWZpZWxkLWNvbnRhaW4iICk7Cn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZm4uZ3JpZCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlvID0gJC5leHRlbmQoewoJCQkJZ3JpZDogbnVsbAoJCQl9LCBvcHRpb25zICksCgkJCSRraWRzID0gJHRoaXMuY2hpbGRyZW4oKSwKCQkJZ3JpZENvbHMgPSB7IHNvbG86MSwgYToyLCBiOjMsIGM6NCwgZDo1IH0sCgkJCWdyaWQgPSBvLmdyaWQsCgkJCWl0ZXJhdG9yLAoJCQlsZXR0ZXI7CgoJCQlpZiAoICFncmlkICkgewoJCQkJaWYgKCAka2lkcy5sZW5ndGggPD0gNSApIHsKCQkJCQlmb3IgKCBsZXR0ZXIgaW4gZ3JpZENvbHMgKSB7CgkJCQkJCWlmICggZ3JpZENvbHNbIGxldHRlciBdID09PSAka2lkcy5sZW5ndGggKSB7CgkJCQkJCQlncmlkID0gbGV0dGVyOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlncmlkID0gImEiOwoJCQkJCSR0aGlzLmFkZENsYXNzKCAidWktZ3JpZC1kdW8iICk7CgkJCQl9CgkJCX0KCQkJaXRlcmF0b3IgPSBncmlkQ29sc1tncmlkXTsKCgkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ncmlkLSIgKyBncmlkICk7CgoJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMSkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1hIiApOwoKCQlpZiAoIGl0ZXJhdG9yID4gMSApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibisyKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWIiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiAyICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzMpIiApLmFkZENsYXNzKCAidWktYmxvY2stYyIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDMgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rNCkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1kIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gNCApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibis1KSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWUiICk7CgkJfQoJfSk7Cn07Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUubmF2YmFyIiwgewoJb3B0aW9uczogewoJCWljb25wb3M6ICJ0b3AiLAoJCWdyaWQ6IG51bGwKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciAkbmF2YmFyID0gdGhpcy5lbGVtZW50LAoJCQkkbmF2YnRucyA9ICRuYXZiYXIuZmluZCggImEiICksCgkJCWljb25wb3MgPSAkbmF2YnRucy5maWx0ZXIoICI6anFtRGF0YShpY29uKSIgKS5sZW5ndGggPyB0aGlzLm9wdGlvbnMuaWNvbnBvcyA6IHVuZGVmaW5lZDsKCgkJJG5hdmJhci5hZGRDbGFzcyggInVpLW5hdmJhciIgKQoJCQkuYXR0ciggInJvbGUiLCAibmF2aWdhdGlvbiIgKQoJCQkuZmluZCggInVsIiApCgkJCS5qcW1FbmhhbmNlYWJsZSgpCgkJCS5ncmlkKHsgZ3JpZDogdGhpcy5vcHRpb25zLmdyaWQgfSk7CgoJCSRuYXZidG5zCgkJCS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCXZhciBpY29uID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAiaWNvbiIgKSwKCQkJCQl0aGVtZSA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggdGhpcywgInRoZW1lIiApLAoJCQkJCWNsYXNzZXMgPSAidWktYnRuIjsKCgkJCQlpZiAoIHRoZW1lICkgewoJCQkJCWNsYXNzZXMgKz0gIiB1aS1idG4tIiArIHRoZW1lOwoJCQkJfQoJCQkJaWYgKCBpY29uICkgewoJCQkJCWNsYXNzZXMgKz0gIiB1aS1pY29uLSIgKyBpY29uICsgIiB1aS1idG4taWNvbi0iICsgaWNvbnBvczsKCQkJCX0KCQkJCSQoIHRoaXMgKS5hZGRDbGFzcyggY2xhc3NlcyApOwoJCQl9KTsKCgkJJG5hdmJhci5kZWxlZ2F0ZSggImEiLCAidmNsaWNrIiwgZnVuY3Rpb24oIC8qIGV2ZW50ICovICkgewoJCQl2YXIgYWN0aXZlQnRuOwoKCQkJaWYgKCAhJCggdGhpcyApLmlzKCAiLnVpLWRpc2FibGVkLCAudWktYnRuLWFjdGl2ZSIgKSApIHsKCQkJCSRuYXZidG5zLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJJCggdGhpcyApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoKCQkJCS8vIFRoZSBjb2RlIGJlbG93IGlzIGEgd29ya2Fyb3VuZCB0byBmaXggIzExODEKCQkJCWFjdGl2ZUJ0biA9ICQoIHRoaXMgKTsKCgkJCQkkKCBkb2N1bWVudCApLm9uZSggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJYWN0aXZlQnRuLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJfSk7CgkJCX0KCQl9KTsKCgkJLy8gQnV0dG9ucyBpbiB0aGUgbmF2YmFyIHdpdGggdWktc3RhdGUtcGVyc2lzdCBjbGFzcyBzaG91bGQgcmVnYWluIHRoZWlyIGFjdGl2ZSBzdGF0ZSBiZWZvcmUgcGFnZSBzaG93CgkJJG5hdmJhci5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuYmluZCggInBhZ2ViZWZvcmVzaG93IiwgZnVuY3Rpb24oKSB7CgkJCSRuYXZidG5zLmZpbHRlciggIi51aS1zdGF0ZS1wZXJzaXN0IiApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0pOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIGdldEF0dHIgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGU7CgokLndpZGdldCggIm1vYmlsZS5saXN0dmlldyIsICQuZXh0ZW5kKCB7CgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWNvdW50VGhlbWU6IG51bGwsIC8qIERlcHJlY2F0ZWQgaW4gMS40ICovCgkJZGl2aWRlclRoZW1lOiBudWxsLAoJCWljb246ICJjYXJhdC1yIiwKCQlzcGxpdEljb246ICJjYXJhdC1yIiwKCQlzcGxpdFRoZW1lOiBudWxsLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWluc2V0OiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgdCA9IHRoaXMsCgkJCWxpc3R2aWV3Q2xhc3NlcyA9ICIiOwoKCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLmluc2V0ID8gIiB1aS1saXN0dmlldy1pbnNldCIgOiAiIjsKCgkJaWYgKCAhIXQub3B0aW9ucy5pbnNldCApIHsKCQkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiOwoJCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLnNoYWRvdyA/ICIgdWktc2hhZG93IiA6ICIiOwoJCX0KCgkJLy8gY3JlYXRlIGxpc3R2aWV3IG1hcmt1cAoJCXQuZWxlbWVudC5hZGRDbGFzcyggIiB1aS1saXN0dmlldyIgKyBsaXN0dmlld0NsYXNzZXMgKTsKCgkJdC5yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCS8vIFRPRE86IFJlbW92ZSBpbiAxLjUKCV9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lOiBmdW5jdGlvbiggZWxlLCBuZXh0UHJvcCwgbGNOYW1lLCB1Y05hbWUgKSB7CgkJdmFyIGRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJldHVybiBlbGU7CgkJCX0KCQkJZWxlID0gZWxlWyBuZXh0UHJvcCBdOwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0sCgkvLyBUT0RPOiBSZW1vdmUgaW4gMS41CglfYWRkVGh1bWJDbGFzc2VzOiBmdW5jdGlvbiggY29udGFpbmVycyApIHsKCQl2YXIgaSwgaW1nLCBsZW4gPSBjb250YWluZXJzLmxlbmd0aDsKCQlmb3IgKCBpID0gMDsgaSA8IGxlbjsgaSsrICkgewoJCQlpbWcgPSAkKCB0aGlzLl9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lKCBjb250YWluZXJzWyBpIF0uZmlyc3RDaGlsZCwgIm5leHRTaWJsaW5nIiwgImltZyIsICJJTUciICkgKTsKCQkJaWYgKCBpbWcubGVuZ3RoICkgewoJCQkJJCggdGhpcy5fZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZSggaW1nWyAwIF0ucGFyZW50Tm9kZSwgInBhcmVudE5vZGUiLCAibGkiLCAiTEkiICkgKS5hZGRDbGFzcyggaW1nLmhhc0NsYXNzKCAidWktbGktaWNvbiIgKSA/ICJ1aS1saS1oYXMtaWNvbiIgOiAidWktbGktaGFzLXRodW1iIiApOwoJCQl9CgkJfQoJfSwKCglfZ2V0Q2hpbGRyZW5CeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIGxjTmFtZSwgdWNOYW1lICkgewoJCXZhciByZXN1bHRzID0gW10sCgkJCWRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQllbGUgPSBlbGUuZmlyc3RDaGlsZDsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJlc3VsdHMucHVzaCggZWxlICk7CgkJCX0KCQkJZWxlID0gZWxlLm5leHRTaWJsaW5nOwoJCX0KCQlyZXR1cm4gJCggcmVzdWx0cyApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciBidXR0b25DbGFzcywgcG9zLCBudW1saSwgaXRlbSwgaXRlbUNsYXNzLCBpdGVtVGhlbWUsIGl0ZW1JY29uLCBpY29uLCBhLAoJCQlpc0RpdmlkZXIsIHN0YXJ0Q291bnQsIG5ld1N0YXJ0Q291bnQsIHZhbHVlLCBsYXN0LCBzcGxpdHRoZW1lLCBzcGxpdFRoZW1lQ2xhc3MsIHNwbGl0aWNvbiwKCQkJYWx0QnV0dG9uQ2xhc3MsIGRpdmlkZXJUaGVtZSwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJJGxpc3QgPSB0aGlzLmVsZW1lbnQsCgkJCWxpID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoICRsaXN0WyAwIF0sICJsaSIsICJMSSIgKSwKCQkJb2wgPSAhISQubm9kZU5hbWUoICRsaXN0WyAwIF0sICJvbCIgKSwKCQkJc3RhcnQgPSAkbGlzdC5hdHRyKCAic3RhcnQiICksCgkJCWl0ZW1DbGFzc0RpY3QgPSB7fSwKCQkJY291bnRCdWJibGVzID0gJGxpc3QuZmluZCggIi51aS1saS1jb3VudCIgKSwKCQkJY291bnRUaGVtZSA9IGdldEF0dHIoICRsaXN0WyAwIF0sICJjb3VudHRoZW1lIiApIHx8IHRoaXMub3B0aW9ucy5jb3VudFRoZW1lLAoJCQljb3VudFRoZW1lQ2xhc3MgPSBjb3VudFRoZW1lID8gInVpLWJvZHktIiArIGNvdW50VGhlbWUgOiAidWktYm9keS1pbmhlcml0IjsKCgkJaWYgKCBvLnRoZW1lICkgewoJCQkkbGlzdC5hZGRDbGFzcyggInVpLWdyb3VwLXRoZW1lLSIgKyBvLnRoZW1lICk7CgkJfQoKCQkvLyBDaGVjayBpZiBhIHN0YXJ0IGF0dHJpYnV0ZSBoYXMgYmVlbiBzZXQgd2hpbGUgdGFraW5nIGEgdmFsdWUgb2YgMCBpbnRvIGFjY291bnQKCQlpZiAoIG9sICYmICggc3RhcnQgfHwgc3RhcnQgPT09IDAgKSApIHsKCQkJc3RhcnRDb3VudCA9IHBhcnNlSW50KCBzdGFydCwgMTAgKSAtIDE7CgkJCSRsaXN0LmNzcyggImNvdW50ZXItcmVzZXQiLCAibGlzdG51bWJlcmluZyAiICsgc3RhcnRDb3VudCApOwoJCX0KCgkJZm9yICggcG9zID0gMCwgbnVtbGkgPSBsaS5sZW5ndGg7IHBvcyA8IG51bWxpOyBwb3MrKyApIHsKCQkJaXRlbSA9IGxpLmVxKCBwb3MgKTsKCQkJaXRlbUNsYXNzID0gIiI7CgoJCQlpZiAoIGNyZWF0ZSB8fCBpdGVtWyAwIF0uY2xhc3NOYW1lLnNlYXJjaCggL1xidWktbGktc3RhdGljXGJ8XGJ1aS1saS1kaXZpZGVyXGIvICkgPCAwICkgewoJCQkJYSA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCBpdGVtWyAwIF0sICJhIiwgIkEiICk7CgkJCQlpc0RpdmlkZXIgPSAoIGdldEF0dHIoIGl0ZW1bIDAgXSwgInJvbGUiICkgPT09ICJsaXN0LWRpdmlkZXIiICk7CgkJCQl2YWx1ZSA9IGl0ZW0uYXR0ciggInZhbHVlIiApOwoJCQkJaXRlbVRoZW1lID0gZ2V0QXR0ciggaXRlbVsgMCBdLCAidGhlbWUiICk7CgoJCQkJaWYgKCBhLmxlbmd0aCAmJiBhWyAwIF0uY2xhc3NOYW1lLnNlYXJjaCggL1xidWktYnRuXGIvICkgPCAwICYmICFpc0RpdmlkZXIgKSB7CgkJCQkJaXRlbUljb24gPSBnZXRBdHRyKCBpdGVtWyAwIF0sICJpY29uIiApOwoJCQkJCWljb24gPSAoIGl0ZW1JY29uID09PSBmYWxzZSApID8gZmFsc2UgOiAoIGl0ZW1JY29uIHx8IG8uaWNvbiApOwoKCQkJCQkvLyBUT0RPOiBSZW1vdmUgaW4gMS41IHRvZ2V0aGVyIHdpdGggbGlua3MuanMgKGxpbmtzLmpzIC8gLnVpLWxpbmsgZGVwcmVjYXRlZCBpbiAxLjQpCgkJCQkJYS5yZW1vdmVDbGFzcyggInVpLWxpbmsiICk7CgoJCQkJCWJ1dHRvbkNsYXNzID0gInVpLWJ0biI7CgoJCQkJCWlmICggaXRlbVRoZW1lICkgewoJCQkJCQlidXR0b25DbGFzcyArPSAiIHVpLWJ0bi0iICsgaXRlbVRoZW1lOwoJCQkJCX0KCgkJCQkJaWYgKCBhLmxlbmd0aCA+IDEgKSB7CgkJCQkJCWl0ZW1DbGFzcyA9ICJ1aS1saS1oYXMtYWx0IjsKCgkJCQkJCWxhc3QgPSBhLmxhc3QoKTsKCQkJCQkJc3BsaXR0aGVtZSA9IGdldEF0dHIoIGxhc3RbIDAgXSwgInRoZW1lIiApIHx8IG8uc3BsaXRUaGVtZSB8fCBnZXRBdHRyKCBpdGVtWyAwIF0sICJ0aGVtZSIsIHRydWUgKTsKCQkJCQkJc3BsaXRUaGVtZUNsYXNzID0gc3BsaXR0aGVtZSA/ICIgdWktYnRuLSIgKyBzcGxpdHRoZW1lIDogIiI7CgkJCQkJCXNwbGl0aWNvbiA9IGdldEF0dHIoIGxhc3RbIDAgXSwgImljb24iICkgfHwgZ2V0QXR0ciggaXRlbVsgMCBdLCAiaWNvbiIgKSB8fCBvLnNwbGl0SWNvbjsKCQkJCQkJYWx0QnV0dG9uQ2xhc3MgPSAidWktYnRuIHVpLWJ0bi1pY29uLW5vdGV4dCB1aS1pY29uLSIgKyBzcGxpdGljb24gKyBzcGxpdFRoZW1lQ2xhc3M7CgoJCQkJCQlsYXN0CgkJCQkJCQkuYXR0ciggInRpdGxlIiwgJC50cmltKCBsYXN0LmdldEVuY29kZWRUZXh0KCkgKSApCgkJCQkJCQkuYWRkQ2xhc3MoIGFsdEJ1dHRvbkNsYXNzICkKCQkJCQkJCS5lbXB0eSgpOwoJCQkJCX0gZWxzZSBpZiAoIGljb24gKSB7CgkJCQkJCWJ1dHRvbkNsYXNzICs9ICIgdWktYnRuLWljb24tcmlnaHQgdWktaWNvbi0iICsgaWNvbjsKCQkJCQl9CgoJCQkJCWEuZmlyc3QoKS5hZGRDbGFzcyggYnV0dG9uQ2xhc3MgKTsKCQkJCX0gZWxzZSBpZiAoIGlzRGl2aWRlciApIHsKCQkJCQlkaXZpZGVyVGhlbWUgPSAoIGdldEF0dHIoIGl0ZW1bIDAgXSwgInRoZW1lIiApIHx8IG8uZGl2aWRlclRoZW1lIHx8IG8udGhlbWUgKTsKCgkJCQkJaXRlbUNsYXNzID0gInVpLWxpLWRpdmlkZXIgdWktYmFyLSIgKyAoIGRpdmlkZXJUaGVtZSA/IGRpdmlkZXJUaGVtZSA6ICJpbmhlcml0IiApOwoKCQkJCQlpdGVtLmF0dHIoICJyb2xlIiwgImhlYWRpbmciICk7CgkJCQl9IGVsc2UgaWYgKCBhLmxlbmd0aCA8PSAwICkgewoJCQkJCWl0ZW1DbGFzcyA9ICJ1aS1saS1zdGF0aWMgdWktYm9keS0iICsgKCBpdGVtVGhlbWUgPyBpdGVtVGhlbWUgOiAiaW5oZXJpdCIgKTsKCQkJCX0KCQkJCWlmICggb2wgJiYgdmFsdWUgKSB7CgkJCQkJbmV3U3RhcnRDb3VudCA9IHBhcnNlSW50KCB2YWx1ZSAsIDEwICkgLSAxOwoKCQkJCQlpdGVtLmNzcyggImNvdW50ZXItcmVzZXQiLCAibGlzdG51bWJlcmluZyAiICsgbmV3U3RhcnRDb3VudCApOwoJCQkJfQoJCQl9CgoJCQkvLyBJbnN0ZWFkIG9mIHNldHRpbmcgaXRlbSBjbGFzcyBkaXJlY3RseSBvbiB0aGUgbGlzdCBpdGVtCgkJCS8vIGF0IHRoaXMgcG9pbnQgaW4gdGltZSwgcHVzaCB0aGUgaXRlbSBpbnRvIGEgZGljdGlvbmFyeQoJCQkvLyB0aGF0IHRlbGxzIHVzIHdoYXQgY2xhc3MgdG8gc2V0IG9uIGl0IHNvIHdlIGNhbiBkbyB0aGlzIGFmdGVyIHRoaXMKCQkJLy8gcHJvY2Vzc2luZyBsb29wIGlzIGZpbmlzaGVkLgoKCQkJaWYgKCAhaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKSB7CgkJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSA9IFtdOwoJCQl9CgoJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXS5wdXNoKCBpdGVtWyAwIF0gKTsKCQl9CgoJCS8vIFNldCB0aGUgYXBwcm9wcmlhdGUgbGlzdHZpZXcgaXRlbSBjbGFzc2VzIG9uIGVhY2ggbGlzdCBpdGVtLgoJCS8vIFRoZSBtYWluIHJlYXNvbiB3ZSBkaWRuJ3QgZG8gdGhpcwoJCS8vIGluIHRoZSBmb3ItbG9vcCBhYm92ZSBpcyBiZWNhdXNlIHdlIGNhbiBlbGltaW5hdGUgcGVyLWl0ZW0gZnVuY3Rpb24gb3ZlcmhlYWQKCQkvLyBieSBjYWxsaW5nIGFkZENsYXNzKCkgYW5kIGNoaWxkcmVuKCkgb25jZSBvciB0d2ljZSBhZnRlcndhcmRzLiBUaGlzCgkJLy8gY2FuIGdpdmUgdXMgYSBzaWduaWZpY2FudCBib29zdCBvbiBwbGF0Zm9ybXMgbGlrZSBXUDcuNS4KCgkJZm9yICggaXRlbUNsYXNzIGluIGl0ZW1DbGFzc0RpY3QgKSB7CgkJCSQoIGl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdICkuYWRkQ2xhc3MoIGl0ZW1DbGFzcyApOwoJCX0KCgkJY291bnRCdWJibGVzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktbGktaGFzLWNvdW50IiApOwoJCX0pOwoJCWlmICggY291bnRUaGVtZUNsYXNzICkgewoJCQljb3VudEJ1YmJsZXMuYWRkQ2xhc3MoIGNvdW50VGhlbWVDbGFzcyApOwoJCX0KCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQuIEZyb20gMS41IHlvdSBoYXZlIHRvIGFkZCBjbGFzcyB1aS1saS1oYXMtdGh1bWIgb3IgdWktbGktaGFzLWljb24gdG8gdGhlIExJLgoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggbGkgKTsKCQl0aGlzLl9hZGRUaHVtYkNsYXNzZXMoIGxpLmZpbmQoICIudWktYnRuIiApICk7CgoJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGxpLCB0aGlzLl9nZXRWaXNpYmxlcyggbGksIGNyZWF0ZSApLCBjcmVhdGUgKTsKCQkvLyBhdXRvZGl2aWRlcnMgYmluZHMgdG8gdGhpcyB0byByZWRyYXcgZGl2aWRlcnMgYWZ0ZXIgdGhlIGxpc3R2aWV3IHJlZnJlc2gKCQl0aGlzLl90cmlnZ2VyKCAiYWZ0ZXJyZWZyZXNoIiApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIFRPRE8gcmVuYW1lIGZpbHRlckNhbGxiYWNrL2RlcHJlY2F0ZSBhbmQgZGVmYXVsdCB0byB0aGUgaXRlbSBpdHNlbGYgYXMgdGhlIGZpcnN0IGFyZ3VtZW50CnZhciBkZWZhdWx0RmlsdGVyQ2FsbGJhY2sgPSBmdW5jdGlvbiggaW5kZXgsIHNlYXJjaFZhbHVlICkgewoJcmV0dXJuICggKCAiIiArICggJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAiZmlsdGVydGV4dCIgKSB8fCAkKCB0aGlzICkudGV4dCgpICkgKQoJCS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoIHNlYXJjaFZhbHVlICkgPT09IC0xICk7Cn07CgokLndpZGdldCggIm1vYmlsZS5maWx0ZXJhYmxlIiwgewoKCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKGZpbHRlcj0ndHJ1ZScpIiwKCglvcHRpb25zOiB7CgkJZmlsdGVyUmV2ZWFsOiBmYWxzZSwKCQlmaWx0ZXJDYWxsYmFjazogZGVmYXVsdEZpbHRlckNhbGxiYWNrLAoJCWVuaGFuY2VkOiBmYWxzZSwKCQlpbnB1dDogbnVsbCwKCQljaGlsZHJlbjogIj4gbGksID4gb3B0aW9uLCBvcHRncm91cCBvcHRpb25zLCB0Ym9keSB0ciwgLnVpLWNvbnRyb2xncm91cC1jb250cm9scyAudWktYnRuIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3NlYXJjaDogbnVsbCwKCQkJX3RpbWVyOiAwCgkJfSk7CgoJCXRoaXMuX3NldElucHV0KCBvcHRzLmlucHV0ICk7CgkJaWYgKCAhb3B0cy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fZmlsdGVySXRlbXMoICggKCB0aGlzLl9zZWFyY2ggJiYgdGhpcy5fc2VhcmNoLnZhbCgpICkgfHwgIiIgKS50b0xvd2VyQ2FzZSgpICk7CgkJfQoJfSwKCglfb25LZXlVcDogZnVuY3Rpb24oKSB7CgkJdmFyIHZhbCwgbGFzdHZhbCwKCQkJc2VhcmNoID0gdGhpcy5fc2VhcmNoOwoKCQlpZiAoIHNlYXJjaCApIHsKCQkJdmFsID0gc2VhcmNoLnZhbCgpLnRvTG93ZXJDYXNlKCksCgkJCWxhc3R2YWwgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHNlYXJjaFsgMCBdLCAibGFzdHZhbCIgKSArICIiOwoKCQkJaWYgKCBsYXN0dmFsICYmIGxhc3R2YWwgPT09IHZhbCApIHsKCQkJCS8vIEV4ZWN1dGUgdGhlIGhhbmRsZXIgb25seSBvbmNlIHBlciB2YWx1ZSBjaGFuZ2UKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCB0aGlzLl90aW1lciApIHsKCQkJCXdpbmRvdy5jbGVhclRpbWVvdXQoIHRoaXMuX3RpbWVyICk7CgkJCQl0aGlzLl90aW1lciA9IDA7CgkJCX0KCgkJCXRoaXMuX3RpbWVyID0gdGhpcy5fZGVsYXkoIGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fdHJpZ2dlciggImJlZm9yZWZpbHRlciIsICJiZWZvcmVmaWx0ZXIiLCB7IGlucHV0OiBzZWFyY2ggfSApOwoKCQkJCS8vIENoYW5nZSB2YWwgYXMgbGFzdHZhbCBmb3IgbmV4dCBleGVjdXRpb24KCQkJCXNlYXJjaFsgMCBdLnNldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgImxhc3R2YWwiLCB2YWwgKTsKCgkJCQl0aGlzLl9maWx0ZXJJdGVtcyggdmFsICk7CgkJCQl0aGlzLl90aW1lciA9IDA7CgkJCX0sIDI1MCApOwoJCX0KCX0sCgoJX2dldEZpbHRlcmFibGVJdGVtczogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCWNoaWxkcmVuID0gdGhpcy5vcHRpb25zLmNoaWxkcmVuLAoJCQlpdGVtcyA9ICFjaGlsZHJlbiA/IHsgbGVuZ3RoOiAwIH06CgkJCQkkLmlzRnVuY3Rpb24oIGNoaWxkcmVuICkgPyBjaGlsZHJlbigpOgoJCQkJY2hpbGRyZW4ubm9kZU5hbWUgPyAkKCBjaGlsZHJlbiApOgoJCQkJY2hpbGRyZW4uanF1ZXJ5ID8gY2hpbGRyZW46CgkJCQl0aGlzLmVsZW1lbnQuZmluZCggY2hpbGRyZW4gKTsKCgkJaWYgKCBpdGVtcy5sZW5ndGggPT09IDAgKSB7CgkJCWl0ZW1zID0gZWxlbS5jaGlsZHJlbigpOwoJCX0KCgkJcmV0dXJuIGl0ZW1zOwoJfSwKCglfZmlsdGVySXRlbXM6IGZ1bmN0aW9uKCB2YWwgKSB7CgkJdmFyIGlkeCwgY2FsbGJhY2ssIGxlbmd0aCwgZHN0LAoJCQlzaG93ID0gW10sCgkJCWhpZGUgPSBbXSwKCQkJb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJZmlsdGVySXRlbXMgPSB0aGlzLl9nZXRGaWx0ZXJhYmxlSXRlbXMoKTsKCgkJaWYgKCB2YWwgIT0gbnVsbCApIHsKCQkJY2FsbGJhY2sgPSBvcHRzLmZpbHRlckNhbGxiYWNrIHx8IGRlZmF1bHRGaWx0ZXJDYWxsYmFjazsKCQkJbGVuZ3RoID0gZmlsdGVySXRlbXMubGVuZ3RoOwoKCQkJLy8gUGFydGl0aW9uIHRoZSBpdGVtcyBpbnRvIHRob3NlIHRvIGJlIGhpZGRlbiBhbmQgdGhvc2UgdG8gYmUgc2hvd24KCQkJZm9yICggaWR4ID0gMCA7IGlkeCA8IGxlbmd0aCA7IGlkeCsrICkgewoJCQkJZHN0ID0gKCBjYWxsYmFjay5jYWxsKCBmaWx0ZXJJdGVtc1sgaWR4IF0sIGlkeCwgdmFsICkgKSA/IGhpZGUgOiBzaG93OwoJCQkJZHN0LnB1c2goIGZpbHRlckl0ZW1zWyBpZHggXSApOwoJCQl9CgkJfQoKCQkvLyBJZiBub3RoaW5nIGlzIGhpZGRlbiwgdGhlbiB0aGUgZGVjaXNpb24gd2hldGhlciB0byBoaWRlIG9yIHNob3cgdGhlIGl0ZW1zCgkJLy8gaXMgYmFzZWQgb24gdGhlICJmaWx0ZXJSZXZlYWwiIG9wdGlvbi4KCQlpZiAoIGhpZGUubGVuZ3RoID09PSAwICkgewoJCQlmaWx0ZXJJdGVtc1sgb3B0cy5maWx0ZXJSZXZlYWwgPyAiYWRkQ2xhc3MiIDogInJlbW92ZUNsYXNzIiBdKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9IGVsc2UgewoJCQkkKCBoaWRlICkuYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCQkkKCBzaG93ICkucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0KCgkJdGhpcy5fcmVmcmVzaENoaWxkV2lkZ2V0KCk7Cgl9LAoKCS8vIFRoZSBEZWZhdWx0IGltcGxlbWVudGF0aW9uIG9mIF9yZWZyZXNoQ2hpbGRXaWRnZXQgYXR0ZW1wdHMgdG8gY2FsbAoJLy8gcmVmcmVzaCBvbiBjb2xsYXBzaWJsZXNldCwgY29udHJvbGdyb3VwLCBzZWxlY3RtZW51LCBvciBsaXN0dmlldwoJX3JlZnJlc2hDaGlsZFdpZGdldDogZnVuY3Rpb24oKSB7CgkJdmFyIHdpZGdldCwgaWR4LAoJCQlyZWNvZ25pemVkV2lkZ2V0cyA9IFsgImNvbGxhcHNpYmxlc2V0IiwgInNlbGVjdG1lbnUiLCAiY29udHJvbGdyb3VwIiwgImxpc3R2aWV3IiBdOwoKCQlmb3IgKCBpZHggPSByZWNvZ25pemVkV2lkZ2V0cy5sZW5ndGggLSAxIDsgaWR4ID4gLTEgOyBpZHgtLSApIHsKCQkJd2lkZ2V0ID0gcmVjb2duaXplZFdpZGdldHNbIGlkeCBdOwoJCQlpZiAoICQubW9iaWxlWyB3aWRnZXQgXSApIHsKCQkJCXdpZGdldCA9IHRoaXMuZWxlbWVudC5kYXRhKCAibW9iaWxlLSIgKyB3aWRnZXQgKTsKCQkJCWlmICggd2lkZ2V0ICYmICQuaXNGdW5jdGlvbiggd2lkZ2V0LnJlZnJlc2ggKSApIHsKCQkJCQl3aWRnZXQucmVmcmVzaCgpOwoJCQkJfQoJCQl9CgkJfQoJfSwKCgkvLyBUT0RPOiBXaGVuIHRoZSBpbnB1dCBpcyBub3QgaW50ZXJuYWwsIGRvIG5vdCBldmVuIHN0b3JlIGl0IGluIHRoaXMuX3NlYXJjaAoJX3NldElucHV0OiBmdW5jdGlvbiAoIHNlbGVjdG9yICkgewoJCXZhciBzZWFyY2ggPSB0aGlzLl9zZWFyY2g7CgoJCS8vIFN0b3AgYSBwZW5kaW5nIGZpbHRlciBvcGVyYXRpb24KCQlpZiAoIHRoaXMuX3RpbWVyICkgewoJCQl3aW5kb3cuY2xlYXJUaW1lb3V0KCB0aGlzLl90aW1lciApOwoJCQl0aGlzLl90aW1lciA9IDA7CgkJfQoKCQlpZiAoIHNlYXJjaCApIHsKCQkJdGhpcy5fb2ZmKCBzZWFyY2gsICJrZXl1cCBjaGFuZ2UgaW5wdXQiICk7CgkJCXNlYXJjaCA9IG51bGw7CgkJfQoKCQlpZiAoIHNlbGVjdG9yICkgewoJCQlzZWFyY2ggPSBzZWxlY3Rvci5qcXVlcnkgPyBzZWxlY3RvcjoKCQkJCXNlbGVjdG9yLm5vZGVOYW1lID8gJCggc2VsZWN0b3IgKToKCQkJCXRoaXMuZG9jdW1lbnQuZmluZCggc2VsZWN0b3IgKTsKCgkJCXRoaXMuX29uKCBzZWFyY2gsIHsKCQkJCWtleXVwOiAiX29uS2V5VXAiLAoJCQkJY2hhbmdlOiAiX29uS2V5VXAiLAoJCQkJaW5wdXQ6ICJfb25LZXlVcCIKCQkJfSk7CgkJfQoKCQl0aGlzLl9zZWFyY2ggPSBzZWFyY2g7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgcmVmaWx0ZXIgPSAhKCAoIG9wdGlvbnMuZmlsdGVyUmV2ZWFsID09PSB1bmRlZmluZWQgKSAmJgoJCQkJKCBvcHRpb25zLmZpbHRlckNhbGxiYWNrID09PSB1bmRlZmluZWQgKSAmJgoJCQkJKCBvcHRpb25zLmNoaWxkcmVuID09PSB1bmRlZmluZWQgKSApOwoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoKCQlpZiAoIG9wdGlvbnMuaW5wdXQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0SW5wdXQoIG9wdGlvbnMuaW5wdXQgKTsKCQkJcmVmaWx0ZXIgPSB0cnVlOwoJCX0KCgkJaWYgKCByZWZpbHRlciApIHsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJfQoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdHMgPSB0aGlzLm9wdGlvbnMsCgkJCWl0ZW1zID0gdGhpcy5fZ2V0RmlsdGVyYWJsZUl0ZW1zKCk7CgoJCWlmICggb3B0cy5lbmhhbmNlZCApIHsKCQkJaXRlbXMudG9nZ2xlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiwgb3B0cy5maWx0ZXJSZXZlYWwgKTsKCQl9IGVsc2UgewoJCQlpdGVtcy5yZW1vdmVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfQoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuX3RpbWVyICkgewoJCQl3aW5kb3cuY2xlYXJUaW1lb3V0KCB0aGlzLl90aW1lciApOwoJCQl0aGlzLl90aW1lciA9IDA7CgkJfQoJCXRoaXMuX2ZpbHRlckl0ZW1zKCAoICggdGhpcy5fc2VhcmNoICYmIHRoaXMuX3NlYXJjaC52YWwoKSApIHx8ICIiICkudG9Mb3dlckNhc2UoKSApOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gQ3JlYXRlIGEgZnVuY3Rpb24gdGhhdCB3aWxsIHJlcGxhY2UgdGhlIF9zZXRPcHRpb25zIGZ1bmN0aW9uIG9mIGEgd2lkZ2V0LAovLyBhbmQgd2lsbCBwYXNzIHRoZSBvcHRpb25zIG9uIHRvIHRoZSBpbnB1dCBvZiB0aGUgZmlsdGVyYWJsZS4KdmFyIHJlcGxhY2VTZXRPcHRpb25zID0gZnVuY3Rpb24oIHNlbGYsIG9yaWcgKSB7CgkJcmV0dXJuIGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCQlvcmlnLmNhbGwoIHRoaXMsIG9wdGlvbnMgKTsKCQkJc2VsZi5fc3luY1RleHRJbnB1dE9wdGlvbnMoIG9wdGlvbnMgKTsKCQl9OwoJfSwKCXJEaXZpZGVyTGlzdEl0ZW0gPSAvKF58XHMpdWktbGktZGl2aWRlcihcc3wkKS8sCglvcmlnRGVmYXVsdEZpbHRlckNhbGxiYWNrID0gJC5tb2JpbGUuZmlsdGVyYWJsZS5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJDYWxsYmFjazsKCi8vIE92ZXJyaWRlIHRoZSBkZWZhdWx0IGZpbHRlciBjYWxsYmFjayB3aXRoIG9uZSB0aGF0IGRvZXMgbm90IGhpZGUgbGlzdCBkaXZpZGVycwokLm1vYmlsZS5maWx0ZXJhYmxlLnByb3RvdHlwZS5vcHRpb25zLmZpbHRlckNhbGxiYWNrID0gZnVuY3Rpb24oIGluZGV4LCBzZWFyY2hWYWx1ZSApIHsKCXJldHVybiAhdGhpcy5jbGFzc05hbWUubWF0Y2goIHJEaXZpZGVyTGlzdEl0ZW0gKSAmJgoJCW9yaWdEZWZhdWx0RmlsdGVyQ2FsbGJhY2suY2FsbCggdGhpcywgaW5kZXgsIHNlYXJjaFZhbHVlICk7Cn07CgokLndpZGdldCggIm1vYmlsZS5maWx0ZXJhYmxlIiwgJC5tb2JpbGUuZmlsdGVyYWJsZSwgewoJb3B0aW9uczogewoJCWZpbHRlclBsYWNlaG9sZGVyOiAiRmlsdGVyIGl0ZW1zLi4uIiwKCQlmaWx0ZXJUaGVtZTogbnVsbAoJfSwKCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGlkeCwgd2lkZ2V0TmFtZSwKCQkJZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJcmVjb2duaXplZFdpZGdldHMgPSBbICJjb2xsYXBzaWJsZXNldCIsICJzZWxlY3RtZW51IiwgImNvbnRyb2xncm91cCIsICJsaXN0dmlldyIgXSwKCQkJY3JlYXRlSGFuZGxlcnMgPSB7fTsKCgkJdGhpcy5fc3VwZXIoKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3dpZGdldDogbnVsbAoJCX0pOwoKCQlmb3IgKCBpZHggPSByZWNvZ25pemVkV2lkZ2V0cy5sZW5ndGggLSAxIDsgaWR4ID4gLTEgOyBpZHgtLSApIHsKCQkJd2lkZ2V0TmFtZSA9IHJlY29nbml6ZWRXaWRnZXRzWyBpZHggXTsKCQkJaWYgKCAkLm1vYmlsZVsgd2lkZ2V0TmFtZSBdICkgewoJCQkJaWYgKCB0aGlzLl9zZXRXaWRnZXQoIGVsZW0uZGF0YSggIm1vYmlsZS0iICsgd2lkZ2V0TmFtZSApICkgKSB7CgkJCQkJYnJlYWs7CgkJCQl9IGVsc2UgewoJCQkJCWNyZWF0ZUhhbmRsZXJzWyB3aWRnZXROYW1lICsgImNyZWF0ZSIgXSA9ICJfaGFuZGxlQ3JlYXRlIjsKCQkJCX0KCQkJfQoJCX0KCgkJaWYgKCAhdGhpcy5fd2lkZ2V0ICkgewoJCQl0aGlzLl9vbiggZWxlbSwgY3JlYXRlSGFuZGxlcnMgKTsKCQl9Cgl9LAoKCV9oYW5kbGVDcmVhdGU6IGZ1bmN0aW9uKCBldnQgKSB7CgkJdGhpcy5fc2V0V2lkZ2V0KCB0aGlzLmVsZW1lbnQuZGF0YSggIm1vYmlsZS0iICsgZXZ0LnR5cGUuc3Vic3RyaW5nKCAwLCBldnQudHlwZS5sZW5ndGggLSA2ICkgKSApOwoJfSwKCglfc2V0V2lkZ2V0OiBmdW5jdGlvbiggd2lkZ2V0ICkgewoJCWlmICggIXRoaXMuX3dpZGdldCAmJiB3aWRnZXQgKSB7CgkJCXRoaXMuX3dpZGdldCA9IHdpZGdldDsKCQkJdGhpcy5fd2lkZ2V0Ll9zZXRPcHRpb25zID0gcmVwbGFjZVNldE9wdGlvbnMoIHRoaXMsIHRoaXMuX3dpZGdldC5fc2V0T3B0aW9ucyApOwoJCX0KCgkJaWYgKCAhIXRoaXMuX3dpZGdldCApIHsKCQkJdGhpcy5fc3luY1RleHRJbnB1dE9wdGlvbnMoIHRoaXMuX3dpZGdldC5vcHRpb25zICk7CgkJfQoKCQlyZXR1cm4gISF0aGlzLl93aWRnZXQ7Cgl9LAoKCV9pc1NlYXJjaEludGVybmFsOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gKCB0aGlzLl9zZWFyY2ggJiYgdGhpcy5fc2VhcmNoLmpxbURhdGEoICJ1aS1maWx0ZXJhYmxlLSIgKyB0aGlzLnV1aWQgKyAiLWludGVybmFsIiApICk7Cgl9LAoKCV9zZXRJbnB1dDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXZhciBvcHRzID0gdGhpcy5vcHRpb25zLAoJCQl1cGRhdGVQbGFjZWhvbGRlciA9IHRydWUsCgkJCXRleHRpbnB1dE9wdHMgPSB7fTsKCgkJaWYgKCAhc2VsZWN0b3IgKSB7CgkJCWlmICggdGhpcy5faXNTZWFyY2hJbnRlcm5hbCgpICkgewoKCQkJCS8vIElnbm9yZSB0aGUgY2FsbCB0byBzZXQgYSBuZXcgaW5wdXQgaWYgdGhlIHNlbGVjdG9yIGdvZXMgdG8gZmFsc3kgYW5kCgkJCQkvLyB0aGUgY3VycmVudCB0ZXh0aW5wdXQgaXMgYWxyZWFkeSBvZiB0aGUgaW50ZXJuYWxseSBnZW5lcmF0ZWQgdmFyaWV0eS4KCQkJCXJldHVybjsKCQkJfSBlbHNlIHsKCgkJCQkvLyBHZW5lcmF0aW5nIGEgbmV3IHRleHRpbnB1dCB3aWRnZXQuIE5vIG5lZWQgdG8gc2V0IHRoZSBwbGFjZWhvbGRlcgoJCQkJLy8gZnVydGhlciBkb3duIHRoZSBmdW5jdGlvbi4KCQkJCXVwZGF0ZVBsYWNlaG9sZGVyID0gZmFsc2U7CgkJCQlzZWxlY3RvciA9ICQoICI8aW5wdXQgIiArCgkJCQkJImRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGU9J3NlYXJjaCcgIiArCgkJCQkJInBsYWNlaG9sZGVyPSciICsgb3B0cy5maWx0ZXJQbGFjZWhvbGRlciArICInPjwvaW5wdXQ+IiApCgkJCQkJLmpxbURhdGEoICJ1aS1maWx0ZXJhYmxlLSIgKyB0aGlzLnV1aWQgKyAiLWludGVybmFsIiwgdHJ1ZSApOwoJCQkJJCggIjxmb3JtIGNsYXNzPSd1aS1maWx0ZXJhYmxlJz48L2Zvcm0+IiApCgkJCQkJLmFwcGVuZCggc2VsZWN0b3IgKQoJCQkJCS5zdWJtaXQoIGZ1bmN0aW9uKCBldnQgKSB7CgkJCQkJCWV2dC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQlzZWxlY3Rvci5ibHVyKCk7CgkJCQkJfSkKCQkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLmVsZW1lbnQgKTsKCQkJCWlmICggJC5tb2JpbGUudGV4dGlucHV0ICkgewoJCQkJCWlmICggdGhpcy5vcHRpb25zLmZpbHRlclRoZW1lICE9IG51bGwgKSB7CgkJCQkJCXRleHRpbnB1dE9wdHNbICJ0aGVtZSIgXSA9IG9wdHMuZmlsdGVyVGhlbWU7CgkJCQkJfQoKCQkJCQlzZWxlY3Rvci50ZXh0aW5wdXQoIHRleHRpbnB1dE9wdHMgKTsKCQkJCX0KCQkJfQoJCX0KCgkJdGhpcy5fc3VwZXIoIHNlbGVjdG9yICk7CgoJCWlmICggdGhpcy5fc2VhcmNoICYmIHVwZGF0ZVBsYWNlaG9sZGVyICkgewoJCQl0aGlzLl9zZWFyY2guYXR0ciggInBsYWNlaG9sZGVyIiwgdGhpcy5vcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyICk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIHJldCA9IHRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCS8vIE5lZWQgdG8gc2V0IHRoZSBmaWx0ZXJQbGFjZWhvbGRlciBhZnRlciBoYXZpbmcgZXN0YWJsaXNoZWQgdGhlIHNlYXJjaCBpbnB1dAoJCWlmICggb3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlciAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoIHRoaXMuX3NlYXJjaCApIHsKCQkJCXRoaXMuX3NlYXJjaC5hdHRyKCAicGxhY2Vob2xkZXIiLCBvcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyICk7CgkJCX0KCQl9CgoJCWlmICggb3B0aW9ucy5maWx0ZXJUaGVtZSAhPT0gdW5kZWZpbmVkICYmIHRoaXMuX3NlYXJjaCAmJiAkLm1vYmlsZS50ZXh0aW5wdXQgKSB7CgkJCXRoaXMuX3NlYXJjaC50ZXh0aW5wdXQoICJvcHRpb24iLCAidGhlbWUiLCBvcHRpb25zLmZpbHRlclRoZW1lICk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLl9pc1NlYXJjaEludGVybmFsKCkgKSB7CgkJCXRoaXMuX3NlYXJjaC5yZW1vdmUoKTsKCQl9CgkJdGhpcy5fc3VwZXIoKTsKCX0sCgoJX3N5bmNUZXh0SW5wdXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaWR4LAoJCQl0ZXh0aW5wdXRPcHRpb25zID0ge307CgoJCS8vIFdlIG9ubHkgc3luYyBvcHRpb25zIGlmIHRoZSBmaWx0ZXJhYmxlJ3MgdGV4dGlucHV0IGlzIG9mIHRoZSBpbnRlcm5hbGx5CgkJLy8gZ2VuZXJhdGVkIHZhcmlldHksIHJhdGhlciB0aGFuIG9uZSBzcGVjaWZpZWQgYnkgdGhlIHVzZXIuCgkJaWYgKCB0aGlzLl9pc1NlYXJjaEludGVybmFsKCkgJiYgJC5tb2JpbGUudGV4dGlucHV0ICkgewoKCQkJLy8gQXBwbHkgb25seSB0aGUgb3B0aW9ucyB1bmRlcnN0b29kIGJ5IHRleHRpbnB1dAoJCQlmb3IgKCBpZHggaW4gJC5tb2JpbGUudGV4dGlucHV0LnByb3RvdHlwZS5vcHRpb25zICkgewoJCQkJaWYgKCBvcHRpb25zWyBpZHggXSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCWlmICggaWR4ID09PSAidGhlbWUiICYmIHRoaXMub3B0aW9ucy5maWx0ZXJUaGVtZSAhPSBudWxsICkgewoJCQkJCQl0ZXh0aW5wdXRPcHRpb25zWyBpZHggXSA9IHRoaXMub3B0aW9ucy5maWx0ZXJUaGVtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0ZXh0aW5wdXRPcHRpb25zWyBpZHggXSA9IG9wdGlvbnNbIGlkeCBdOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQl0aGlzLl9zZWFyY2gudGV4dGlucHV0KCAib3B0aW9uIiwgdGV4dGlucHV0T3B0aW9ucyApOwoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCmZ1bmN0aW9uIGRlZmF1bHRBdXRvZGl2aWRlcnNTZWxlY3RvciggZWx0ICkgewoJLy8gbG9vayBmb3IgdGhlIHRleHQgaW4gdGhlIGdpdmVuIGVsZW1lbnQKCXZhciB0ZXh0ID0gJC50cmltKCBlbHQudGV4dCgpICkgfHwgbnVsbDsKCglpZiAoICF0ZXh0ICkgewoJCXJldHVybiBudWxsOwoJfQoKCS8vIGNyZWF0ZSB0aGUgdGV4dCBmb3IgdGhlIGRpdmlkZXIgKGZpcnN0IHVwcGVyY2FzZWQgbGV0dGVyKQoJdGV4dCA9IHRleHQuc2xpY2UoIDAsIDEgKS50b1VwcGVyQ2FzZSgpOwoKCXJldHVybiB0ZXh0Owp9CgokLndpZGdldCggIm1vYmlsZS5saXN0dmlldyIsICQubW9iaWxlLmxpc3R2aWV3LCB7CglvcHRpb25zOiB7CgkJYXV0b2RpdmlkZXJzOiBmYWxzZSwKCQlhdXRvZGl2aWRlcnNTZWxlY3RvcjogZGVmYXVsdEF1dG9kaXZpZGVyc1NlbGVjdG9yCgl9LAoKCV9hZnRlckxpc3R2aWV3UmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIGVsID0gdGhpcy5lbGVtZW50OwoJCXRoaXMuX29mZiggZWwsICJsaXN0dmlld2FmdGVycmVmcmVzaCIgKTsKCQl0aGlzLl9yZXBsYWNlRGl2aWRlcnMoKTsKCQl0aGlzLnJlZnJlc2goKTsKCQl0aGlzLl9vbiggZWwsIHsgbGlzdHZpZXdhZnRlcnJlZnJlc2g6ICJfYWZ0ZXJMaXN0dmlld1JlZnJlc2giIH0gKTsKCX0sCgoJX3JlcGxhY2VEaXZpZGVyczogZnVuY3Rpb24oKSB7CgkJdmFyIGksIGxpcywgbGksIGRpdmlkZXJUZXh0LAoJCQlsYXN0RGl2aWRlclRleHQgPSBudWxsLAoJCQlsaXN0ID0gdGhpcy5lbGVtZW50LAoJCQlkaXZpZGVyOwoKCQlsaXN0LmZpbmQoICJsaTpqcW1EYXRhKHJvbGU9J2xpc3QtZGl2aWRlcicpIiApLnJlbW92ZSgpOwoKCQlsaXMgPSBsaXN0LmZpbmQoICJsaSIgKTsKCgkJZm9yICggaSA9IDA7IGkgPCBsaXMubGVuZ3RoIDsgaSsrICkgewoJCQlsaSA9IGxpc1sgaSBdOwoJCQlkaXZpZGVyVGV4dCA9IHRoaXMub3B0aW9ucy5hdXRvZGl2aWRlcnNTZWxlY3RvciggJCggbGkgKSApOwoKCQkJaWYgKCBkaXZpZGVyVGV4dCAmJiBsYXN0RGl2aWRlclRleHQgIT09IGRpdmlkZXJUZXh0ICkgewoJCQkJZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJsaSIgKTsKCQkJCWRpdmlkZXIuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBkaXZpZGVyVGV4dCApICk7CgkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGUiLCAibGlzdC1kaXZpZGVyIiApOwoJCQkJbGkucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoIGRpdmlkZXIsIGxpICk7CgkJCX0KCgkJCWxhc3REaXZpZGVyVGV4dCA9IGRpdmlkZXJUZXh0OwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCgkJaWYgKCAhdGhpcy5vcHRpb25zLmF1dG9kaXZpZGVycyApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fYWZ0ZXJMaXN0dmlld1JlZnJlc2goKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciByZGl2aWRlciA9IC8oXnxccyl1aS1saS1kaXZpZGVyKCR8XHMpLywKCXJoaWRkZW4gPSAvKF58XHMpdWktc2NyZWVuLWhpZGRlbigkfFxzKS87CgokLndpZGdldCggIm1vYmlsZS5saXN0dmlldyIsICQubW9iaWxlLmxpc3R2aWV3LCB7CglvcHRpb25zOiB7CgkJaGlkZWRpdmlkZXJzOiB0cnVlCgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBpdGVtcywgaWR4LCBpdGVtLCBoaWRlRGl2aWRlciA9IHRydWU7CgoJCXRoaXMuX3N1cGVyQXBwbHkoIGFyZ3VtZW50cyApOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5oaWRlZGl2aWRlcnMgKSB7CgkJCWl0ZW1zID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoIHRoaXMuZWxlbWVudFsgMCBdLCAibGkiLCAiTEkiICk7CgkJCWZvciAoIGlkeCA9IGl0ZW1zLmxlbmd0aCAtIDEgOyBpZHggPiAtMSA7IGlkeC0tICkgewoJCQkJaXRlbSA9IGl0ZW1zWyBpZHggXTsKCQkJCWlmICggaXRlbS5jbGFzc05hbWUubWF0Y2goIHJkaXZpZGVyICkgKSB7CgkJCQkJaWYgKCBoaWRlRGl2aWRlciApIHsKCQkJCQkJaXRlbS5jbGFzc05hbWUgPSBpdGVtLmNsYXNzTmFtZSArICIgdWktc2NyZWVuLWhpZGRlbiI7CgkJCQkJfQoJCQkJCWhpZGVEaXZpZGVyID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJaWYgKCAhaXRlbS5jbGFzc05hbWUubWF0Y2goIHJoaWRkZW4gKSApIHsKCQkJCQkJaGlkZURpdmlkZXIgPSBmYWxzZTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5ub2pzID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCSQoICI6anFtRGF0YShyb2xlPSdub2pzJykiLCB0YXJnZXQgKS5hZGRDbGFzcyggInVpLW5vanMiICk7Cn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgPSB7CglfaGFuZGxlRm9ybVJlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LmNsb3Nlc3QoICJmb3JtIiApLCB7CgkJCXJlc2V0OiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuX2RlbGF5KCAiX3Jlc2V0IiApOwoJCQl9CgkJfSk7Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CgovKgoqICJjaGVja2JveHJhZGlvIiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY2hlY2tib3hyYWRpbyIsICQuZXh0ZW5kKCB7CgoJaW5pdFNlbGVjdG9yOiAiaW5wdXQ6bm90KCA6anFtRGF0YShyb2xlPSdmbGlwc3dpdGNoJyApIClbdHlwZT0nY2hlY2tib3gnXSxpbnB1dFt0eXBlPSdyYWRpbyddOm5vdCggOmpxbURhdGEocm9sZT0nZmxpcHN3aXRjaCcgKSkiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogImluaGVyaXQiLAoJCW1pbmk6IGZhbHNlLAoJCXdyYXBwZXJDbGFzczogbnVsbCwKCQllbmhhbmNlZDogZmFsc2UsCgkJaWNvbnBvczogImxlZnQiCgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJaW5oZXJpdEF0dHIgPSBmdW5jdGlvbiggaW5wdXQsIGRhdGFBdHRyICkgewoJCQkJcmV0dXJuIGlucHV0LmpxbURhdGEoIGRhdGFBdHRyICkgfHwKCQkJCQlpbnB1dC5jbG9zZXN0KCAiZm9ybSwgZmllbGRzZXQiICkuanFtRGF0YSggZGF0YUF0dHIgKTsKCQkJfSwKCQkJLy8gTk9URTogV2luZG93cyBQaG9uZSBjb3VsZCBub3QgZmluZCB0aGUgbGFiZWwgdGhyb3VnaCBhIHNlbGVjdG9yCgkJCS8vIGZpbHRlciB3b3JrcyB0aG91Z2guCgkJCXBhcmVudExhYmVsID0gaW5wdXQuY2xvc2VzdCggImxhYmVsIiApLAoJCQlsYWJlbCA9IHBhcmVudExhYmVsLmxlbmd0aCA/IHBhcmVudExhYmVsIDoKCQkJCWlucHV0CgkJCQkJLmNsb3Nlc3QoICJmb3JtLCBmaWVsZHNldCwgOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKQoJCQkJCS5maW5kKCAibGFiZWwiICkKCQkJCQkuZmlsdGVyKCAiW2Zvcj0nIiArICQubW9iaWxlLnBhdGguaGFzaFRvU2VsZWN0b3IoIGlucHV0WzBdLmlkICkgKyAiJ10iICkKCQkJCQkuZmlyc3QoKSwKCQkJaW5wdXR0eXBlID0gaW5wdXRbMF0udHlwZSwKCQkJY2hlY2tlZFN0YXRlID0gaW5wdXR0eXBlICsgIi1vbiIsCgkJCXVuY2hlY2tlZFN0YXRlID0gaW5wdXR0eXBlICsgIi1vZmYiLAoJCQljaGVja2VkQ2xhc3MgPSAidWktIiArIGNoZWNrZWRTdGF0ZSwKCQkJdW5jaGVja2VkQ2xhc3MgPSAidWktIiArIHVuY2hlY2tlZFN0YXRlOwoKCQlpZiAoIGlucHV0dHlwZSAhPT0gImNoZWNrYm94IiAmJiBpbnB1dHR5cGUgIT09ICJyYWRpbyIgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggdGhpcy5lbGVtZW50WzBdLmRpc2FibGVkICl7CgkJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IHRydWU7CgkJfQoKCQlvLmljb25wb3MgPSBpbmhlcml0QXR0ciggaW5wdXQsICJpY29ucG9zIiApIHx8IGxhYmVsLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29ucG9zIiApIHx8IG8uaWNvbnBvcywKCgkJLy8gRXN0YWJsaXNoIG9wdGlvbnMKCQlvLm1pbmkgPSBpbmhlcml0QXR0ciggaW5wdXQsICJtaW5pIiApIHx8IG8ubWluaTsKCgkJLy8gRXhwb3NlIGZvciBvdGhlciBtZXRob2RzCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJaW5wdXQ6IGlucHV0LAoJCQlsYWJlbDogbGFiZWwsCgkJCXBhcmVudExhYmVsOiBwYXJlbnRMYWJlbCwKCQkJaW5wdXR0eXBlOiBpbnB1dHR5cGUsCgkJCWNoZWNrZWRDbGFzczogY2hlY2tlZENsYXNzLAoJCQl1bmNoZWNrZWRDbGFzczogdW5jaGVja2VkQ2xhc3MsCgkJCWNoZWNrZWRpY29uOiBjaGVja2VkU3RhdGUsCgkJCXVuY2hlY2tlZGljb246IHVuY2hlY2tlZFN0YXRlCgkJfSk7CgoJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgkJdGhpcy5fb24oIGxhYmVsLCB7CgkJCXZtb3VzZW92ZXI6ICJfaGFuZGxlTGFiZWxWTW91c2VPdmVyIiwKCQkJdmNsaWNrOiAiX2hhbmRsZUxhYmVsVkNsaWNrIgoJCX0pOwoKCQl0aGlzLl9vbiggaW5wdXQsIHsKCQkJdm1vdXNlZG93bjogIl9jYWNoZVZhbHMiLAoJCQl2Y2xpY2s6ICJfaGFuZGxlSW5wdXRWQ2xpY2siLAoJCQlmb2N1czogIl9oYW5kbGVJbnB1dEZvY3VzIiwKCQkJYmx1cjogIl9oYW5kbGVJbnB1dEJsdXIiCgkJfSk7CgoJCXRoaXMuX2hhbmRsZUZvcm1SZXNldCgpOwoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5sYWJlbC5hZGRDbGFzcyggInVpLWJ0biB1aS1jb3JuZXItYWxsIik7CgoJCWlmKCB0aGlzLnBhcmVudExhYmVsLmxlbmd0aCA+IDAgKXsKCQkJdGhpcy5pbnB1dC5hZGQoIHRoaXMubGFiZWwgKS53cmFwQWxsKCB0aGlzLl93cmFwcGVyKCkgKTsKCQl9IGVsc2UgewoJCQkvL3RoaXMuZWxlbWVudC5yZXBsYWNlV2l0aCggdGhpcy5pbnB1dC5hZGQoIHRoaXMubGFiZWwgKS53cmFwQWxsKCB0aGlzLl93cmFwcGVyKCkgKSApOwoJCQl0aGlzLmVsZW1lbnQud3JhcCggdGhpcy5fd3JhcHBlcigpICk7CgkJCXRoaXMuZWxlbWVudC5wYXJlbnQoKS5wcmVwZW5kKCB0aGlzLmxhYmVsICk7CgkJfQoJCQoJCS8vIFdyYXAgdGhlIGlucHV0ICsgbGFiZWwgaW4gYSBkaXYKCQkKCQl0aGlzLl9zZXRPcHRpb25zKHsKCQkJInRoZW1lIjogdGhpcy5vcHRpb25zLnRoZW1lLAoJCQkiaWNvbnBvcyI6IHRoaXMub3B0aW9ucy5pY29ucG9zLAoJCQkibWluaSI6IHRoaXMub3B0aW9ucy5taW5pCgkJfSk7CgoJfSwKCglfd3JhcHBlcjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2IGNsYXNzPSciICArICggdGhpcy5vcHRpb25zLndyYXBwZXJDbGFzcyA/IHRoaXMub3B0aW9ucy53cmFwcGVyQ2xhc3MgOiAiIiApICsgIiB1aS0iICsgdGhpcy5pbnB1dHR5cGUgKyAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCA/ICIgdWktZGlzYWJsZWQiIDogIiIgKSArICInID4iICk7Cgl9LAoKCV9oYW5kbGVJbnB1dEZvY3VzOiBmdW5jdGlvbigpIHsKCQl0aGlzLmxhYmVsLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7Cgl9LAoKCV9oYW5kbGVJbnB1dEJsdXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMubGFiZWwucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCX0sCgoJX2hhbmRsZUlucHV0VkNsaWNrOiBmdW5jdGlvbigpIHsKCQl2YXIgJHRoaXMgPSB0aGlzLmVsZW1lbnQ7CgoJCS8vIEFkZHMgY2hlY2tlZCBhdHRyaWJ1dGUgdG8gY2hlY2tlZCBpbnB1dCB3aGVuIGtleWJvYXJkIGlzIHVzZWQKCQlpZiAoICR0aGlzLmlzKCAiOmNoZWNrZWQiICkgKSB7CgoJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIHRydWUpOwoJCQl0aGlzLl9nZXRJbnB1dFNldCgpLm5vdCggJHRoaXMgKS5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJfSBlbHNlIHsKCQkJJHRoaXMucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCX0KCgkJdGhpcy5fdXBkYXRlQWxsKCk7Cgl9LAoKCV9oYW5kbGVMYWJlbFZNb3VzZU92ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIHRoaXMubGFiZWwucGFyZW50KCkuaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKSApIHsKCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJfQoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3NldE9wdGlvbnMoewoJCQkiZGlzYWJsZWQiOiBmYWxzZQoJCX0pOwoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXRPcHRpb25zKHsKCQkJImRpc2FibGVkIjogdHJ1ZQoJCX0pOwoJfSwKCglfaGFuZGxlTGFiZWxWQ2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgaW5wdXQgPSB0aGlzLmVsZW1lbnQ7CgoJCWlmICggaW5wdXQuaXMoICI6ZGlzYWJsZWQiICkgKSB7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX2NhY2hlVmFscygpOwoKCQlpbnB1dC5wcm9wKCAiY2hlY2tlZCIsIHRoaXMuaW5wdXR0eXBlID09PSAicmFkaW8iICYmIHRydWUgfHwgIWlucHV0LnByb3AoICJjaGVja2VkIiApICk7CgoJCS8vIHRyaWdnZXIgY2xpY2sgaGFuZGxlcidzIGJvdW5kIGRpcmVjdGx5IHRvIHRoZSBpbnB1dCBhcyBhIHN1YnN0aXR1dGUgZm9yCgkJLy8gaG93IGxhYmVsIGNsaWNrcyBiZWhhdmUgbm9ybWFsbHkgaW4gdGhlIGJyb3dzZXJzCgkJLy8gVE9ETzogaXQgd291bGQgYmUgbmljZSB0byBsZXQgdGhlIGJyb3dzZXIncyBoYW5kbGUgdGhlIGNsaWNrcyBhbmQgcGFzcyB0aGVtCgkJLy8gICAgICAgdGhyb3VnaCB0byB0aGUgYXNzb2NpYXRlIGlucHV0LiB3ZSBjYW4gc3dhbGxvdyB0aGF0IGNsaWNrIGF0IHRoZSBwYXJlbnQKCQkvLyAgICAgICB3cmFwcGVyIGVsZW1lbnQgbGV2ZWwKCQlpbnB1dC50cmlnZ2VySGFuZGxlciggImNsaWNrIiApOwoKCQkvLyBJbnB1dCBzZXQgZm9yIGNvbW1vbiByYWRpbyBidXR0b25zIHdpbGwgY29udGFpbiBhbGwgdGhlIHJhZGlvCgkJLy8gYnV0dG9ucywgYnV0IHdpbGwgbm90IGZvciBjaGVja2JveGVzLiBjbGVhcmluZyB0aGUgY2hlY2tlZCBzdGF0dXMKCQkvLyBvZiBvdGhlciByYWRpb3MgZW5zdXJlcyB0aGUgYWN0aXZlIGJ1dHRvbiBzdGF0ZSBpcyBhcHBsaWVkIHByb3Blcmx5CgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5ub3QoIGlucHV0ICkucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoKCQl0aGlzLl91cGRhdGVBbGwoKTsKCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCV9jYWNoZVZhbHM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2dldElucHV0U2V0KCkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5hdHRyKCJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJjYWNoZVZhbCIsIHRoaXMuY2hlY2tlZCApOwoJCX0pOwoJfSwKCgkvL3JldHVybnMgZWl0aGVyIGEgc2V0IG9mIHJhZGlvcyB3aXRoIHRoZSBzYW1lIG5hbWUgYXR0cmlidXRlLCBvciBhIHNpbmdsZSBjaGVja2JveAoJX2dldElucHV0U2V0OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuaW5wdXR0eXBlID09PSAiY2hlY2tib3giICkgewoJCQlyZXR1cm4gdGhpcy5lbGVtZW50OwoJCX0KCgkJcmV0dXJuIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSwgOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKQoJCQkuZmluZCggImlucHV0W25hbWU9JyIgKyB0aGlzLmVsZW1lbnRbIDAgXS5uYW1lICsgIiddW3R5cGU9JyIgKyB0aGlzLmlucHV0dHlwZSArICInXSIgKTsKCX0sCgoJX3VwZGF0ZUFsbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQlpZiAoIHRoaXMuY2hlY2tlZCB8fCBzZWxmLmlucHV0dHlwZSA9PT0gImNoZWNrYm94IiApIHsKCQkJCSR0aGlzLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCX0KCQl9KQoJCS5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCX0sCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIGlucHV0ID0gdGhpcy5lbGVtZW50WyAwIF0sCgkJCWFjdGl2ZSA9ICIgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzLAoJCQloYXNJY29uID0gKCB0aGlzLmVsZW1lbnQucGFyZW50cyggIi51aS1jb250cm9sZ3JvdXAtaG9yaXpvbnRhbCIgKS5sZW5ndGggPT09IDAgKSwKCQkJY2hlY2tlZENsYXNzID0gdGhpcy5jaGVja2VkQ2xhc3MgKyAoIGhhc0ljb24gPyAiIiA6IGFjdGl2ZSApLAoJCQlsYWJlbCA9IHRoaXMubGFiZWw7CgoJCWxhYmVsCgkJCS50b2dnbGVDbGFzcyggInVpLWljb24tIiArIHRoaXMuY2hlY2tlZGljb24sIGlucHV0LmNoZWNrZWQgKQoJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLSIgKyB0aGlzLnVuY2hlY2tlZGljb24sICFpbnB1dC5jaGVja2VkICk7CgkJaWYgKCBpbnB1dC5jaGVja2VkICkgewoJCQlsYWJlbC5yZW1vdmVDbGFzcyggdGhpcy51bmNoZWNrZWRDbGFzcyArIGFjdGl2ZSApLmFkZENsYXNzKCBjaGVja2VkQ2xhc3MgKTsKCQl9IGVsc2UgewoJCQlsYWJlbC5yZW1vdmVDbGFzcyggY2hlY2tlZENsYXNzICkuYWRkQ2xhc3MoIHRoaXMudW5jaGVja2VkQ2xhc3MgKTsKCQl9Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMubGFiZWwucGFyZW50KCk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5pbnB1dC5wcm9wKCAiZGlzYWJsZWQiLCAhIW9wdGlvbnMuZGlzYWJsZWQgKTsKCQkJdGhpcy53aWRnZXQoKS50b2dnbGVDbGFzcyggInVpLWRpc2FibGVkIiwgISFvcHRpb25zLmRpc2FibGVkICk7CgkJfQoJCWlmICggb3B0aW9ucy5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMubGFiZWwucGFyZW50KCkudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgISFvcHRpb25zLm1pbmkgKTsKCQl9CgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMubGFiZWwucmVtb3ZlQ2xhc3MoICJ1aS1idG4tIiArIHRoaXMub3B0aW9ucy50aGVtZSApLmFkZENsYXNzKCAidWktYnRuLSIgKyBvcHRpb25zLnRoZW1lICk7CgkJfQoJCWlmICggb3B0aW9ucy53cmFwcGVyQ2xhc3MgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy53aWRnZXQoKS5yZW1vdmVDbGFzcyggdGhpcy5vcHRpb25zLndyYXBwZXJDbGFzcyApLmFkZENsYXNzKCBvcHRpb25zLndyYXBwZXJDbGFzcyApOwoJCX0KCQlpZiAoIG9wdGlvbnMuaWNvbnBvcyAhPT0gdW5kZWZpbmVkICYmICggdGhpcy5lbGVtZW50LnBhcmVudHMoICJbZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZT0naG9yaXpvbnRhbCddIiApLmxlbmd0aCA9PT0gMCApICkgewoJCQl0aGlzLmxhYmVsLnJlbW92ZUNsYXNzKCAidWktYnRuLWljb24tIiArIHRoaXMub3B0aW9ucy5pY29ucG9zICkuYWRkQ2xhc3MoICJ1aS1idG4taWNvbi0iICsgb3B0aW9ucy5pY29ucG9zICk7CgkJfSBlbHNlIGlmICggdGhpcy5lbGVtZW50LnBhcmVudHMoICJbZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZT0naG9yaXpvbnRhbCddIiApLmxlbmd0aCAhPT0gMCApewoJCQl0aGlzLmxhYmVsLnJlbW92ZUNsYXNzKCAidWktYnRuLWljb24tIiArIHRoaXMub3B0aW9ucy5pY29ucG9zICk7CgkJfQoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9Cgp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ICkgKTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuYnV0dG9uIiwgewoKCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J2J1dHRvbiddLCBpbnB1dFt0eXBlPSdzdWJtaXQnXSwgaW5wdXRbdHlwZT0ncmVzZXQnXSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWljb246IG51bGwsCgkJaWNvbnBvczogImxlZnQiLAoJCWljb25zaGFkb3c6IGZhbHNlLCAvKiBUT0RPOiBEZXByZWNhdGVkIGluIDEuNCwgcmVtb3ZlIGluIDEuNS4gKi8KCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpbmxpbmU6IG51bGwsCgkJbWluaTogbnVsbCwKCQl3cmFwcGVyQ2xhc3M6IG51bGwsCgkJZW5oYW5jZWQ6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQlpZiAoIHRoaXMuZWxlbWVudC5pcyggIjpkaXNhYmxlZCIgKSApIHsKCQkJdGhpcy5vcHRpb25zLmRpc2FibGVkID0gdHJ1ZTsKCQl9CgoJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJd3JhcHBlcjogdGhpcy5lbGVtZW50LnBhcmVudCgpCgkJfSk7CgoJCXRoaXMuX29uKCB7CgkJCWZvY3VzOiBmdW5jdGlvbigpIHsKCQkJCXRoaXMud2lkZ2V0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSwKCgkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy53aWRnZXQoKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9CgkJfSk7CgkJCgkJdGhpcy5yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQud3JhcCggdGhpcy5fYnV0dG9uKCkgKTsKCX0sCgoJX2J1dHRvbjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoIjxkaXYgY2xhc3M9J3VpLWJ0biB1aS1pbnB1dC1idG4iICsKCQkJKCB0aGlzLm9wdGlvbnMud3JhcHBlckNsYXNzID8gIiAiICsgdGhpcy5vcHRpb25zLndyYXBwZXJDbGFzcyA6ICIiICkgKwoJCQkoIHRoaXMub3B0aW9ucy50aGVtZSA/ICIgdWktYnRuLSIgKyB0aGlzLm9wdGlvbnMudGhlbWUgOiAiIiApICsKCQkJKCB0aGlzLm9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiApICsKCQkJKCB0aGlzLm9wdGlvbnMuc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiIgKSArCgkJCSggdGhpcy5vcHRpb25zLmlubGluZSA/ICIgdWktYnRuLWlubGluZSIgOiAiIiApICsKCQkJKCB0aGlzLm9wdGlvbnMubWluaSA/ICIgdWktbWluaSIgOiAiIiApICsKCQkJKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgPyAiIHVpLWRpc2FibGVkIiA6ICIiICkgKwoJCQkoICggdGhpcy5vcHRpb25zLmljb25wb3MgJiYgdGhpcy5vcHRpb25zLmljb24gKSA/ICIgdWktYnRuLWljb24tIiArIHRoaXMub3B0aW9ucy5pY29ucG9zIDogKCB0aGlzLm9wdGlvbnMuaWNvbiA/ICIgdWktYnRuLWljb24tbGVmdCIgOiAiIiApICkgKwoJCQkoIHRoaXMub3B0aW9ucy5pY29uID8gIiB1aS1pY29uLSIgKyB0aGlzLm9wdGlvbnMuaWNvbiA6ICIiICkgKwoJCQkiJyA+IiArIHRoaXMuZWxlbWVudC52YWwoKSArICI8L2Rpdj4iKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy53cmFwcGVyOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5pbnNlcnRCZWZvcmUoIHRoaXMuYnV0dG9uICk7CgkJCXRoaXMuYnV0dG9uLnJlbW92ZSgpOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMud2lkZ2V0KCkucmVtb3ZlQ2xhc3MoIHRoaXMub3B0aW9ucy50aGVtZSApLmFkZENsYXNzKCAidWktYnRuLSIgKyBvcHRpb25zLnRoZW1lICk7CgkJfQoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMud2lkZ2V0KCkudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoJCWlmICggb3B0aW9ucy5zaGFkb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy53aWRnZXQoKS50b2dnbGVDbGFzcyggInVpLXNoYWRvdyIsIG9wdGlvbnMuc2hhZG93ICk7CgkJfQoJCWlmICggb3B0aW9ucy5pbmxpbmUgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy53aWRnZXQoKS50b2dnbGVDbGFzcyggInVpLWJ0bi1pbmxpbmUiLCBvcHRpb25zLmlubGluZSApOwoJCX0KCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLndpZGdldCgpLnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIG9wdGlvbnMubWluaSApOwoJCX0KCQlpZiAoIG9wdGlvbnMuaWNvbnBvcyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLndpZGdldCgpLnJlbW92ZUNsYXNzKCAidWktYnRuLWljb24tIiArIG9wdGlvbnMuaWNvbnBvcyApOwoJCX0KCQlpZiAoIG9wdGlvbnMuaWNvbiAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoICF0aGlzLm9wdGlvbnMuaWNvbnBvcyAmJiAhb3B0aW9ucy5pY29ucG9zICkgewoJCQkJdGhpcy53aWRnZXQudG9nZ2xlQ2xhc3MoICJ1aS1idG4taWNvbi1sZWZ0Iiwgb3B0aW9ucy5pY29uICk7CgkJCX0KCQkJdGhpcy53aWRnZXQoKS5yZW1vdmVDbGFzcyggInVpLWljb24tIiArIHRoaXMub3B0aW9ucy5pY29uICkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLSIgKyBvcHRpb25zLmljb24sIG9wdGlvbnMuaWNvbiApOwoJCX0KCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5pY29uICYmIHRoaXMub3B0aW9ucy5pY29ucG9zID09PSAibm90ZXh0IiAmJiB0aGlzLmVsZW1lbnQuYXR0ciggInRpdGxlIiApICkgewoJCQl0aGlzLmVsZW1lbnQuYXR0ciggInRpdGxlIiwgdGhpcy5lbGVtZW50LnZhbCgpICk7CgkJfQoJCWlmICggIWNyZWF0ZSApIHsKCQkJdmFyIG9yaWdpbmFsRWxlbWVudCA9IHRoaXMuZWxlbWVudC5kZXRhY2goKTsKCQkJJCggdGhpcy53cmFwcGVyICkudGV4dCggdGhpcy5lbGVtZW50LnZhbCgpICkuYXBwZW5kKCBvcmlnaW5hbEVsZW1lbnQgKTsKCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkICkgewoJdmFyCW1ldGEgPSAkKCAibWV0YVtuYW1lPXZpZXdwb3J0XSIgKSwKCQlpbml0aWFsQ29udGVudCA9IG1ldGEuYXR0ciggImNvbnRlbnQiICksCgkJZGlzYWJsZWRab29tID0gaW5pdGlhbENvbnRlbnQgKyAiLG1heGltdW0tc2NhbGU9MSwgdXNlci1zY2FsYWJsZT1ubyIsCgkJZW5hYmxlZFpvb20gPSBpbml0aWFsQ29udGVudCArICIsbWF4aW11bS1zY2FsZT0xMCwgdXNlci1zY2FsYWJsZT15ZXMiLAoJCWRpc2FibGVkSW5pdGlhbGx5ID0gLyh1c2VyLXNjYWxhYmxlW1xzXSo9W1xzXSpubyl8KG1heGltdW0tc2NhbGVbXHNdKj1bXHNdKjEpWyQsXHNdLy50ZXN0KCBpbml0aWFsQ29udGVudCApOwoKCSQubW9iaWxlLnpvb20gPSAkLmV4dGVuZCgge30sIHsKCQllbmFibGVkOiAhZGlzYWJsZWRJbml0aWFsbHksCgkJbG9ja2VkOiBmYWxzZSwKCQlkaXNhYmxlOiBmdW5jdGlvbiggbG9jayApIHsKCQkJaWYgKCAhZGlzYWJsZWRJbml0aWFsbHkgJiYgISQubW9iaWxlLnpvb20ubG9ja2VkICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGRpc2FibGVkWm9vbSApOwoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gZmFsc2U7CgkJCQkkLm1vYmlsZS56b29tLmxvY2tlZCA9IGxvY2sgfHwgZmFsc2U7CgkJCX0KCQl9LAoJCWVuYWJsZTogZnVuY3Rpb24oIHVubG9jayApIHsKCQkJaWYgKCAhZGlzYWJsZWRJbml0aWFsbHkgJiYgKCAhJC5tb2JpbGUuem9vbS5sb2NrZWQgfHwgdW5sb2NrID09PSB0cnVlICkgKSB7CgkJCQltZXRhLmF0dHIoICJjb250ZW50IiwgZW5hYmxlZFpvb20gKTsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IHRydWU7CgkJCQkkLm1vYmlsZS56b29tLmxvY2tlZCA9IGZhbHNlOwoJCQl9CgkJfSwKCQlyZXN0b3JlOiBmdW5jdGlvbigpIHsKCQkJaWYgKCAhZGlzYWJsZWRJbml0aWFsbHkgKSB7CgkJCQltZXRhLmF0dHIoICJjb250ZW50IiwgaW5pdGlhbENvbnRlbnQgKTsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IHRydWU7CgkJCX0KCQl9Cgl9KTsKCn0oIGpRdWVyeSApKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUudGV4dGlucHV0IiwgewoJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ndGV4dCddLCBpbnB1dFt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJyksIGlucHV0W3R5cGU9J251bWJlciddLCA6anFtRGF0YSh0eXBlPSdudW1iZXInKSwgaW5wdXRbdHlwZT0ncGFzc3dvcmQnXSwgaW5wdXRbdHlwZT0nZW1haWwnXSwgaW5wdXRbdHlwZT0ndXJsJ10sIGlucHV0W3R5cGU9J3RlbCddLCB0ZXh0YXJlYSwgaW5wdXRbdHlwZT0ndGltZSddLCBpbnB1dFt0eXBlPSdkYXRlJ10sIGlucHV0W3R5cGU9J21vbnRoJ10sIGlucHV0W3R5cGU9J3dlZWsnXSwgaW5wdXRbdHlwZT0nZGF0ZXRpbWUnXSwgaW5wdXRbdHlwZT0nZGF0ZXRpbWUtbG9jYWwnXSwgaW5wdXRbdHlwZT0nY29sb3InXSwgaW5wdXQ6bm90KFt0eXBlXSksIGlucHV0W3R5cGU9J2ZpbGUnXSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWNvcm5lcnM6IHRydWUsCgkJbWluaTogZmFsc2UsCgkJLy8gVGhpcyBvcHRpb24gZGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MgZGV2aWNlcy4KCQlwcmV2ZW50Rm9jdXNab29tOiAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSwKCQl3cmFwcGVyQ2xhc3M6ICIiLAoJCWVuaGFuY2VkOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyIG8gPSB0aGlzLm9wdGlvbnMsCgkJCWlzU2VhcmNoID0gdGhpcy5lbGVtZW50LmlzKCAiW3R5cGU9J3NlYXJjaCddLCA6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSIgKSwKCQkJaXNUZXh0YXJlYSA9IHRoaXMuZWxlbWVudFsgMCBdLnRhZ05hbWUgPT09ICJURVhUQVJFQSIsCgkJCWlucHV0TmVlZHNXcmFwID0gKCh0aGlzLmVsZW1lbnQuaXMoICJpbnB1dCIgKSB8fCB0aGlzLmVsZW1lbnQuaXMoICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInR5cGU9J3NlYXJjaCddIiApICkgJiYgIXRoaXMuZWxlbWVudC5pcyggIltkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAidHlwZT0ncmFuZ2UnXSIgKSk7CgkJCQoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCXRoZW1lY2xhc3M6ICJ1aS1ib2R5LSIgKyAoICggby50aGVtZSA9PT0gbnVsbCApID8gImluaGVyaXQiIDogby50aGVtZSApLAoJCQlpc1NlYXJjaDogaXNTZWFyY2gsCgkJCWlzVGV4dGFyZWE6IGlzVGV4dGFyZWEsCgkJCWlucHV0TmVlZHNXcmFwOiBpbnB1dE5lZWRzV3JhcAoJCX0pOwoKCQl0aGlzLl9hdXRvQ29ycmVjdCgpOwoKCQlpZiAoIHRoaXMuZWxlbWVudFsgMCBdLmRpc2FibGVkICkgewoJCQl0aGlzLm9wdGlvbnMuZGlzYWJsZWQgPSB0cnVlOwoJCX0KCgkJaWYgKCAhby5lbmhhbmNlZCApIHsKCQkJdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgkJdGhpcy5fb24oIHsKCQkJImZvY3VzIjogIl9oYW5kbGVGb2N1cyIsCgkJCSJibHVyIjogIl9oYW5kbGVCbHVyIgoJCX0pOwoKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5zZXRPcHRpb25zKHsKCQkJImRpc2FibGVkIiA6IHRoaXMuZWxlbWVudC5pcyggIjpkaXNhYmxlZCIgKQoJCX0pOwoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24oKSB7CgoJCWlmICggdGhpcy5pc1RleHRhcmVhICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1pbnB1dC10ZXh0IiApOwoJCX0KCgkJaWYgKCB0aGlzLmVsZW1lbnQuaXMoICJ0ZXh0YXJlYSwgW2RhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJ0eXBlPSdyYW5nZSddIiApICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1zaGFkb3ctaW5zZXQiICk7CgkJCXRoaXMuX3NldE9wdGlvbnMoIHRoaXMub3B0aW9ucyApOwoJCX0KCgkJLy8ic2VhcmNoIiBhbmQgInRleHQiIGlucHV0IHdpZGdldHMKCQlpZiAoIHRoaXMuaW5wdXROZWVkc1dyYXAgKSB7CgkJCXRoaXMuZWxlbWVudC53cmFwKCB0aGlzLl93cmFwKCkgKTsKCQl9CgoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAoIHRoaXMuaW5wdXROZWVkc1dyYXAgKSA/IHRoaXMuZWxlbWVudC5wYXJlbnQoKSA6IHRoaXMuZWxlbWVudDsKCX0sCgoJX3dyYXA6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRzID0gdGhpcy5vcHRpb25zOwoKCQlyZXR1cm4gJCggIjxkaXYgY2xhc3M9JyIgKwoJCQkoIHRoaXMuaXNTZWFyY2ggPyAidWktaW5wdXQtc2VhcmNoICIgOiAidWktaW5wdXQtdGV4dCAiICkgKwoJCQkidWktYm9keS0iICsgKCAoIG9wdHMudGhlbWUgPT09IG51bGwgKSA/ICJpbmhlcml0IiA6IG9wdHMudGhlbWUgKSArICIgIiArCgkJCSggb3B0cy5jb3JuZXJzID8gInVpLWNvcm5lci1hbGwgIiA6ICIiICkgKwoJCQkoIG9wdHMubWluaSA/ICJ1aS1taW5pICIgOiAiIiApICsKCQkJKCBvcHRzLmRpc2FibGVkID8gInVpLXN0YXRlLWRpc2FibGVkICIgOiAiIiApICsKCQkJKCBvcHRzLndyYXBwZXJDbGFzcyAhPT0gIiIgPyBvcHRzLndyYXBwZXJDbGFzcyArICIgIiA6ICIiICkgKwoJCQkidWktc2hhZG93LWluc2V0Jz48L2Rpdj4iICk7Cgl9LAoKCV9hdXRvQ29ycmVjdDogZnVuY3Rpb24oKSB7CgkJLy8gWFhYOiBUZW1wb3Jhcnkgd29ya2Fyb3VuZCBmb3IgaXNzdWUgNzg1IChBcHBsZSBidWcgODkxMDU4OSkuCgkJLy8gICAgICBUdXJuIG9mZiBhdXRvY29ycmVjdCBhbmQgYXV0b2NvbXBsZXRlIG9uIG5vbi1pT1MgNSBkZXZpY2VzCgkJLy8gICAgICBzaW5jZSB0aGUgcG9wdXAgdGhleSB1c2UgY2FuJ3QgYmUgZGlzbWlzc2VkIGJ5IHRoZSB1c2VyLiBOb3RlCgkJLy8gICAgICB0aGF0IHdlIHRlc3QgZm9yIHRoZSBwcmVzZW5jZSBvZiB0aGUgZmVhdHVyZSBieSBsb29raW5nIGZvcgoJCS8vICAgICAgdGhlIGF1dG9jb3JyZWN0IHByb3BlcnR5IG9uIHRoZSBpbnB1dCBlbGVtZW50LiBXZSBjdXJyZW50bHkKCQkvLyAgICAgIGhhdmUgbm8gdGVzdCBmb3IgaU9TIDUgb3IgbmV3ZXIgc28gd2UncmUgdGVtcG9yYXJpbHkgdXNpbmcKCQkvLyAgICAgIHRoZSB0b3VjaE92ZXJmbG93IHN1cHBvcnQgZmxhZyBmb3IgalFNIDEuMC4gWWVzLCBJIGZlZWwgZGlydHkuIC0gamJsYXMKCQlpZiAoIHR5cGVvZiB0aGlzLmVsZW1lbnRbMF0uYXV0b2NvcnJlY3QgIT09ICJ1bmRlZmluZWQiICYmICEkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyApIHsKCQkJLy8gU2V0IHRoZSBhdHRyaWJ1dGUgaW5zdGVhZCBvZiB0aGUgcHJvcGVydHkganVzdCBpbiBjYXNlIHRoZXJlCgkJCS8vIGlzIGNvZGUgdGhhdCBhdHRlbXB0cyB0byBtYWtlIG1vZGlmaWNhdGlvbnMgdmlhIEhUTUwuCgkJCXRoaXMuZWxlbWVudFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29ycmVjdCIsICJvZmYiICk7CgkJCXRoaXMuZWxlbWVudFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29tcGxldGUiLCAib2ZmIiApOwoJCX0KCX0sCgoJX2hhbmRsZUJsdXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCWlmICggdGhpcy5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJfQoJfSwKCglfaGFuZGxlRm9jdXM6IGZ1bmN0aW9uKCkgewoJCS8vIEluIG1hbnkgc2l0dWF0aW9ucywgaU9TIHdpbGwgem9vbSBpbnRvIHRoZSBpbnB1dCB1cG9uIHRhcCwgdGhpcyBwcmV2ZW50cyB0aGF0IGZyb20gaGFwcGVuaW5nCgkJaWYgKCB0aGlzLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJfQoJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24gKCBvcHRpb25zICkgewoJCXZhciB0aGVtZWNsYXNzLAoJCQlvdXRlciA9IHRoaXMud2lkZ2V0KCk7CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGVtZWNsYXNzID0gInVpLWJvZHktIiArICggKCBvcHRpb25zLnRoZW1lID09PSBudWxsICkgPyAiaW5oZXJpdCIgOiBvcHRpb25zLnRoZW1lICk7CgkJCW91dGVyLnJlbW92ZUNsYXNzKCB0aGlzLnRoZW1lY2xhc3MgKS5hZGRDbGFzcyggdGhlbWVjbGFzcyApOwoJCQl0aGlzLnRoZW1lY2xhc3MgPSB0aGVtZWNsYXNzOwoJCX0KCgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJb3V0ZXIudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLW1pbmkiLCBvcHRpb25zLm1pbmkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgISFvcHRpb25zLmRpc2FibGVkICk7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktZGlzYWJsZWQiLCAhIW9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoIHRoaXMuaW5wdXROZWVkc1dyYXAgKSB7CgkJCXRoaXMuZWxlbWVudC51bndyYXAoKTsKCQl9CgkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktaW5wdXQtdGV4dCAiICsgdGhpcy50aGVtZWNsYXNzICsgIiB1aS1jb3JuZXItYWxsIHVpLW1pbmkgdWktZGlzYWJsZWQiICk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5zbGlkZXIiLCAkLmV4dGVuZCggewoJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ncmFuZ2UnXSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSwgOmpxbURhdGEocm9sZT0nc2xpZGVyJykiLAoKCXdpZGdldEV2ZW50UHJlZml4OiAic2xpZGUiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQl0cmFja1RoZW1lOiBudWxsLAoJCWNvcm5lcnM6IHRydWUsCgkJbWluaTogZmFsc2UsCgkJaGlnaGxpZ2h0OiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJLy8gVE9ETzogRWFjaCBvZiB0aGVzZSBzaG91bGQgaGF2ZSBjb21tZW50cyBleHBsYWluIHdoYXQgdGhleSdyZSBmb3IKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWNvbnRyb2wgPSB0aGlzLmVsZW1lbnQsCgkJCXRyYWNrVGhlbWUgPSB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSB8fCAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIGNvbnRyb2xbIDAgXSwgInRoZW1lIiApLAoJCQl0cmFja1RoZW1lQ2xhc3MgPSB0cmFja1RoZW1lID8gIiB1aS1iYXItIiArIHRyYWNrVGhlbWUgOiAiIHVpLWJhci1pbmhlcml0IiwKCQkJY29ybmVyQ2xhc3MgPSAoIHRoaXMub3B0aW9ucy5jb3JuZXJzIHx8IGNvbnRyb2wuanFtRGF0YSggImNvcm5lcnMiICkgKSA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiwKCQkJbWluaUNsYXNzID0gKCB0aGlzLm9wdGlvbnMubWluaSB8fCBjb250cm9sLmpxbURhdGEoICJtaW5pIiApICkgPyAiIHVpLW1pbmkiIDogIiIsCgkJCWNUeXBlID0gY29udHJvbFsgMCBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCWlzVG9nZ2xlU3dpdGNoID0gKCBjVHlwZSA9PT0gInNlbGVjdCIgKSwKCQkJaXNSYW5nZXNsaWRlciA9IGNvbnRyb2wucGFyZW50KCkuaXMoICI6anFtRGF0YShyb2xlPSdyYW5nZXNsaWRlcicpIiApLAoJCQlzZWxlY3RDbGFzcyA9ICggaXNUb2dnbGVTd2l0Y2ggKSA/ICJ1aS1zbGlkZXItc3dpdGNoIiA6ICIiLAoJCQljb250cm9sSUQgPSBjb250cm9sLmF0dHIoICJpZCIgKSwKCQkJJGxhYmVsID0gJCggIltmb3I9JyIgKyBjb250cm9sSUQgKyAiJ10iICksCgkJCWxhYmVsSUQgPSAkbGFiZWwuYXR0ciggImlkIiApIHx8IGNvbnRyb2xJRCArICItbGFiZWwiLAoJCQltaW4gPSAhaXNUb2dnbGVTd2l0Y2ggPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDAsCgkJCW1heCA9ICAhaXNUb2dnbGVTd2l0Y2ggPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5sZW5ndGgtMSwKCQkJc3RlcCA9IHdpbmRvdy5wYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApIHx8IDEgKSwKCQkJZG9tSGFuZGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICksCgkJCWhhbmRsZSA9ICQoIGRvbUhhbmRsZSApLAoJCQlkb21TbGlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCQlzbGlkZXIgPSAkKCBkb21TbGlkZXIgKSwKCQkJdmFsdWViZyA9IHRoaXMub3B0aW9ucy5oaWdobGlnaHQgJiYgIWlzVG9nZ2xlU3dpdGNoID8gKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGJnID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJCWJnLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItYmcgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzOwoJCQkJcmV0dXJuICQoIGJnICkucHJlcGVuZFRvKCBzbGlkZXIgKTsKCQkJfSkoKSA6IGZhbHNlLAoJCQlvcHRpb25zLAoJCQl3cmFwcGVyLAoJCQlqLCBsZW5ndGgsCgkJCWksIG9wdGlvbnNDb3VudCwgb3JpZ1RhYkluZGV4LAoJCQlzaWRlLCBhY3RpdmVDbGFzcywgc2xpZGVySW1nOwoKCQkkbGFiZWwuYXR0ciggImlkIiwgbGFiZWxJRCApOwoJCXRoaXMuaXNUb2dnbGVTd2l0Y2ggPSBpc1RvZ2dsZVN3aXRjaDsKCgkJZG9tSGFuZGxlLnNldEF0dHJpYnV0ZSggImhyZWYiLCAiIyIgKTsKCQlkb21TbGlkZXIuc2V0QXR0cmlidXRlKCAicm9sZSIsICJhcHBsaWNhdGlvbiIgKTsKCQlkb21TbGlkZXIuY2xhc3NOYW1lID0gWyB0aGlzLmlzVG9nZ2xlU3dpdGNoID8gInVpLXNsaWRlciB1aS1zbGlkZXItdHJhY2sgdWktc2hhZG93LWluc2V0ICIgOiAidWktc2xpZGVyLXRyYWNrIHVpLXNoYWRvdy1pbnNldCAiLCBzZWxlY3RDbGFzcywgdHJhY2tUaGVtZUNsYXNzLCBjb3JuZXJDbGFzcywgbWluaUNsYXNzIF0uam9pbiggIiIgKTsKCQlkb21IYW5kbGUuY2xhc3NOYW1lID0gInVpLXNsaWRlci1oYW5kbGUiOwoJCWRvbVNsaWRlci5hcHBlbmRDaGlsZCggZG9tSGFuZGxlICk7CgoJCWhhbmRsZS5hdHRyKHsKCQkJInJvbGUiOiAic2xpZGVyIiwKCQkJImFyaWEtdmFsdWVtaW4iOiBtaW4sCgkJCSJhcmlhLXZhbHVlbWF4IjogbWF4LAoJCQkiYXJpYS12YWx1ZW5vdyI6IHRoaXMuX3ZhbHVlKCksCgkJCSJhcmlhLXZhbHVldGV4dCI6IHRoaXMuX3ZhbHVlKCksCgkJCSJ0aXRsZSI6IHRoaXMuX3ZhbHVlKCksCgkJCSJhcmlhLWxhYmVsbGVkYnkiOiBsYWJlbElECgkJfSk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCXNsaWRlcjogc2xpZGVyLAoJCQloYW5kbGU6IGhhbmRsZSwKCQkJY29udHJvbDogY29udHJvbCwKCQkJdHlwZTogY1R5cGUsCgkJCXN0ZXA6IHN0ZXAsCgkJCW1heDogbWF4LAoJCQltaW46IG1pbiwKCQkJdmFsdWViZzogdmFsdWViZywKCQkJaXNSYW5nZXNsaWRlcjogaXNSYW5nZXNsaWRlciwKCQkJZHJhZ2dpbmc6IGZhbHNlLAoJCQliZWZvcmVTdGFydDogbnVsbCwKCQkJdXNlck1vZGlmaWVkOiBmYWxzZSwKCQkJbW91c2VNb3ZlZDogZmFsc2UKCQl9KTsKCgkJaWYgKCBpc1RvZ2dsZVN3aXRjaCApIHsKCQkJLy8gVE9ETzogcmVzdG9yZSBvcmlnaW5hbCB0YWJpbmRleCAoaWYgYW55KSBpbiBhIGRlc3Ryb3kgbWV0aG9kCgkJCW9yaWdUYWJJbmRleCA9IGNvbnRyb2wuYXR0ciggInRhYmluZGV4IiApOwoJCQlpZiAoIG9yaWdUYWJJbmRleCApIHsKCQkJCWhhbmRsZS5hdHRyKCAidGFiaW5kZXgiLCBvcmlnVGFiSW5kZXggKTsKCQkJfQoJCQljb250cm9sLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKS5mb2N1cyhmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5ibHVyKCk7CgkJCQloYW5kbGUuZm9jdXMoKTsKCQkJfSk7CgoJCQl3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJd3JhcHBlci5jbGFzc05hbWUgPSAidWktc2xpZGVyLWlubmVyb2Zmc2V0IjsKCgkJCWZvciAoIGogPSAwLCBsZW5ndGggPSBkb21TbGlkZXIuY2hpbGROb2Rlcy5sZW5ndGg7IGogPCBsZW5ndGg7IGorKyApIHsKCQkJCXdyYXBwZXIuYXBwZW5kQ2hpbGQoIGRvbVNsaWRlci5jaGlsZE5vZGVzW2pdICk7CgkJCX0KCgkJCWRvbVNsaWRlci5hcHBlbmRDaGlsZCggd3JhcHBlciApOwoKCQkJLy8gc2xpZGVyLndyYXBJbm5lciggIjxkaXYgY2xhc3M9J3VpLXNsaWRlci1pbm5lcm9mZnNldCc+PC9kaXY+IiApOwoKCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCWhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgoJCQlvcHRpb25zID0gY29udHJvbC5maW5kKCAib3B0aW9uIiApOwoKCQkJZm9yICggaSA9IDAsIG9wdGlvbnNDb3VudCA9IG9wdGlvbnMubGVuZ3RoOyBpIDwgb3B0aW9uc0NvdW50OyBpKysgKSB7CgkJCQlzaWRlID0gIWkgPyAiYiIgOiAiYSI7CgkJCQlhY3RpdmVDbGFzcyA9ICFpID8gIiIgOiAiICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzczsKCQkJCXNsaWRlckltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApOwoKCQkJCXNsaWRlckltZy5jbGFzc05hbWUgPSBbICJ1aS1zbGlkZXItbGFiZWwgdWktc2xpZGVyLWxhYmVsLSIsIHNpZGUsIGFjdGl2ZUNsYXNzIF0uam9pbiggIiIgKTsKCQkJCXNsaWRlckltZy5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgImltZyIgKTsKCQkJCXNsaWRlckltZy5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIG9wdGlvbnNbaV0uaW5uZXJIVE1MICkgKTsKCQkJCSQoIHNsaWRlckltZyApLnByZXBlbmRUbyggc2xpZGVyICk7CgkJCX0KCgkJCXNlbGYuX2xhYmVscyA9ICQoICIudWktc2xpZGVyLWxhYmVsIiwgc2xpZGVyICk7CgoJCX0KCgkJLy8gbW9uaXRvciB0aGUgaW5wdXQgZm9yIHVwZGF0ZWQgdmFsdWVzCgkJY29udHJvbC5hZGRDbGFzcyggaXNUb2dnbGVTd2l0Y2ggPyAidWktc2xpZGVyLXN3aXRjaCIgOiAidWktc2xpZGVyLWlucHV0IiApOwoKCQl0aGlzLl9vbiggY29udHJvbCwgewoJCQkiY2hhbmdlIjogIl9jb250cm9sQ2hhbmdlIiwKCQkJImtleXVwIjogIl9jb250cm9sS2V5dXAiLAoJCQkiYmx1ciI6ICJfY29udHJvbEJsdXIiLAoJCQkidm1vdXNldXAiOiAiX2NvbnRyb2xWTW91c2VVcCIKCQl9KTsKCgkJc2xpZGVyLmJpbmQoICJ2bW91c2Vkb3duIiwgJC5wcm94eSggdGhpcy5fc2xpZGVyVk1vdXNlRG93biwgdGhpcyApICkKCQkJLmJpbmQoICJ2Y2xpY2siLCBmYWxzZSApOwoKCQkvLyBXZSBoYXZlIHRvIGluc3RhbnRpYXRlIGEgbmV3IGZ1bmN0aW9uIG9iamVjdCBmb3IgdGhlIHVuYmluZCB0byB3b3JrIHByb3Blcmx5CgkJLy8gc2luY2UgdGhlIG1ldGhvZCBpdHNlbGYgaXMgZGVmaW5lZCBpbiB0aGUgcHJvdG90eXBlIChjYXVzaW5nIGl0IHRvIHVuYmluZCBldmVyeXRoaW5nKQoJCXRoaXMuX29uKCBkb2N1bWVudCwgeyAidm1vdXNlbW92ZSI6ICJfcHJldmVudERvY3VtZW50RHJhZyIgfSk7CgkJdGhpcy5fb24oIHNsaWRlci5hZGQoIGRvY3VtZW50ICksIHsgInZtb3VzZXVwIjogIl9zbGlkZXJWTW91c2VVcCIgfSk7CgoJCXNsaWRlci5pbnNlcnRBZnRlciggY29udHJvbCApOwoKCQkvLyB3cmFwIGluIGEgZGl2IGZvciBzdHlsaW5nIHB1cnBvc2VzCgkJaWYgKCAhaXNUb2dnbGVTd2l0Y2ggJiYgIWlzUmFuZ2VzbGlkZXIgKSB7CgkJCXdyYXBwZXIgPSB0aGlzLm9wdGlvbnMubWluaSA/ICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXIgdWktbWluaSc+IiA6ICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXInPiI7CgoJCQljb250cm9sLmFkZCggc2xpZGVyICkud3JhcEFsbCggd3JhcHBlciApOwoJCX0KCgkJLy8gYmluZCB0aGUgaGFuZGxlIGV2ZW50IGNhbGxiYWNrcyBhbmQgc2V0IHRoZSBjb250ZXh0IHRvIHRoZSB3aWRnZXQgaW5zdGFuY2UKCQl0aGlzLl9vbiggdGhpcy5oYW5kbGUsIHsKCQkJInZtb3VzZWRvd24iOiAiX2hhbmRsZVZNb3VzZURvd24iLAoJCQkia2V5ZG93biI6ICJfaGFuZGxlS2V5ZG93biIsCgkJCSJrZXl1cCI6ICJfaGFuZGxlS2V5dXAiCgkJfSk7CgoJCXRoaXMuaGFuZGxlLmJpbmQoICJ2Y2xpY2siLCBmYWxzZSApOwoKCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCgkJdGhpcy5yZWZyZXNoKCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgdHJ1ZSApOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldFRoZW1lKCBvcHRpb25zLnRoZW1lICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMudHJhY2tUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRUcmFja1RoZW1lKCBvcHRpb25zLnRyYWNrVGhlbWUgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldENvcm5lcnMoIG9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0TWluaSggb3B0aW9ucy5taW5pICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuaGlnaGxpZ2h0ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldEhpZ2hsaWdodCggb3B0aW9ucy5oaWdobGlnaHQgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXREaXNhYmxlZCggb3B0aW9ucy5kaXNhYmxlZCApOwoJCX0KCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfY29udHJvbENoYW5nZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCS8vIGlmIHRoZSB1c2VyIGRyYWdnZWQgdGhlIGhhbmRsZSwgdGhlICJjaGFuZ2UiIGV2ZW50IHdhcyB0cmlnZ2VyZWQgZnJvbSBpbnNpZGUgcmVmcmVzaCgpOyBkb24ndCBjYWxsIHJlZnJlc2goKSBhZ2FpbgoJCWlmICggdGhpcy5fdHJpZ2dlciggImNvbnRyb2xjaGFuZ2UiLCBldmVudCApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlpZiAoICF0aGlzLm1vdXNlTW92ZWQgKSB7CgkJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSwgdHJ1ZSApOwoJCX0KCX0sCgoJX2NvbnRyb2xLZXl1cDogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsgLy8gbmVjZXNzYXJ5PwoJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSwgdHJ1ZSwgdHJ1ZSApOwoJfSwKCglfY29udHJvbEJsdXI6IGZ1bmN0aW9uKC8qIGV2ZW50ICovKSB7CgkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpLCB0cnVlICk7Cgl9LAoKCS8vIGl0IGFwcGVhcnMgdGhlIGNsaWNraW5nIHRoZSB1cCBhbmQgZG93biBidXR0b25zIGluIGNocm9tZSBvbgoJLy8gcmFuZ2UvbnVtYmVyIGlucHV0cyBkb2Vzbid0IHRyaWdnZXIgYSBjaGFuZ2UgdW50aWwgdGhlIGZpZWxkIGlzCgkvLyBibHVycmVkLiBIZXJlIHdlIGNoZWNrIHRoaWYgdGhlIHZhbHVlIGhhcyBjaGFuZ2VkIGFuZCByZWZyZXNoCglfY29udHJvbFZNb3VzZVVwOiBmdW5jdGlvbigvKiBldmVudCAqLykgewoJCXRoaXMuX2NoZWNrZWRSZWZyZXNoKCk7Cgl9LAoKCS8vIE5PVEUgZm9yY2UgZm9jdXMgb24gaGFuZGxlCglfaGFuZGxlVk1vdXNlRG93bjogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKCQl0aGlzLmhhbmRsZS5mb2N1cygpOwoJfSwKCglfaGFuZGxlS2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBpbmRleCA9IHRoaXMuX3ZhbHVlKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEluIGFsbCBjYXNlcyBwcmV2ZW50IHRoZSBkZWZhdWx0IGFuZCBtYXJrIHRoZSBoYW5kbGUgYXMgYWN0aXZlCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5FTkQ6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX1VQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5SSUdIVDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5MRUZUOgoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCQlpZiAoICF0aGlzLl9rZXlTbGlkaW5nICkgewoJCQkJCXRoaXMuX2tleVNsaWRpbmcgPSB0cnVlOwoJCQkJCXRoaXMuaGFuZGxlLmFkZENsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOyAvKiBUT0RPOiBXZSBkb24ndCB1c2UgdGhpcyBjbGFzcyBmb3Igc3R5bGluZy4gRG8gd2UgbmVlZCB0byBhZGQgaXQ/ICovCgkJCQl9CgoJCQkJYnJlYWs7CgkJfQoKCQkvLyBtb3ZlIHRoZSBzbGlkZXIgYWNjb3JkaW5nIHRvIHRoZSBrZXlwcmVzcwoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLm1pbiApOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5FTkQ6CgkJCQl0aGlzLnJlZnJlc2goIHRoaXMubWF4ICk7CgkJCQlicmVhazsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUOgoJCQkJdGhpcy5yZWZyZXNoKCBpbmRleCArIHRoaXMuc3RlcCApOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX0RPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuTEVGVDoKCQkJCXRoaXMucmVmcmVzaCggaW5kZXggLSB0aGlzLnN0ZXAgKTsKCQkJCWJyZWFrOwoJCX0KCX0sIC8vIHJlbW92ZSBhY3RpdmUgbWFyawoKCV9oYW5kbGVLZXl1cDogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKCQlpZiAoIHRoaXMuX2tleVNsaWRpbmcgKSB7CgkJCXRoaXMuX2tleVNsaWRpbmcgPSBmYWxzZTsKCQkJdGhpcy5oYW5kbGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7IC8qIFNlZSBjb21tZW50IGFib3ZlLiAqLwoJCX0KCX0sCgoJX3NsaWRlclZNb3VzZURvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQkvLyBOT1RFOiB3ZSBkb24ndCBkbyB0aGlzIGluIHJlZnJlc2ggYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvCgkJLy8gICAgICAgc3VwcG9ydCBwcm9ncmFtbWF0aWMgYWx0ZXJhdGlvbiBvZiBkaXNhYmxlZCBpbnB1dHMKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCAhKCBldmVudC53aGljaCA9PT0gMSB8fCBldmVudC53aGljaCA9PT0gMCB8fCBldmVudC53aGljaCA9PT0gdW5kZWZpbmVkICkgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3Jlc3RhcnQiLCBldmVudCApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQl0aGlzLmRyYWdnaW5nID0gdHJ1ZTsKCQl0aGlzLnVzZXJNb2RpZmllZCA9IGZhbHNlOwoJCXRoaXMubW91c2VNb3ZlZCA9IGZhbHNlOwoKCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCXRoaXMuYmVmb3JlU3RhcnQgPSB0aGlzLmVsZW1lbnRbMF0uc2VsZWN0ZWRJbmRleDsKCQl9CgoJCXRoaXMucmVmcmVzaCggZXZlbnQgKTsKCQl0aGlzLl90cmlnZ2VyKCAic3RhcnQiICk7CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglfc2xpZGVyVk1vdXNlVXA6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5kcmFnZ2luZyApIHsKCQkJdGhpcy5kcmFnZ2luZyA9IGZhbHNlOwoKCQkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCQl0aGlzLmhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgoJCQkJaWYgKCB0aGlzLm1vdXNlTW92ZWQgKSB7CgkJCQkJLy8gdGhpcyBpcyBhIGRyYWcsIGNoYW5nZSB0aGUgdmFsdWUgb25seSBpZiB1c2VyIGRyYWdnZWQgZW5vdWdoCgkJCQkJaWYgKCB0aGlzLnVzZXJNb2RpZmllZCApIHsKCQkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ID09PSAwID8gMSA6IDAgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0aGlzLnJlZnJlc2goIHRoaXMuYmVmb3JlU3RhcnQgKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMgaXMganVzdCBhIGNsaWNrLCBjaGFuZ2UgdGhlIHZhbHVlCgkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ID09PSAwID8gMSA6IDAgKTsKCQkJCX0KCQkJfQoKCQkJdGhpcy5tb3VzZU1vdmVkID0gZmFsc2U7CgkJCXRoaXMuX3RyaWdnZXIoICJzdG9wIiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSwKCglfcHJldmVudERvY3VtZW50RHJhZzogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvLyBOT1RFOiB3ZSBkb24ndCBkbyB0aGlzIGluIHJlZnJlc2ggYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvCgkJCS8vICAgICAgIHN1cHBvcnQgcHJvZ3JhbW1hdGljIGFsdGVyYXRpb24gb2YgZGlzYWJsZWQgaW5wdXRzCgkJCWlmICggdGhpcy5fdHJpZ2dlciggImRyYWciLCBldmVudCApID09PSBmYWxzZSkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCWlmICggdGhpcy5kcmFnZ2luZyAmJiAhdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoKCQkJCS8vIHRoaXMubW91c2VNb3ZlZCBtdXN0IGJlIHVwZGF0ZWQgYmVmb3JlIHJlZnJlc2goKSBiZWNhdXNlIGl0IHdpbGwgYmUgdXNlZCBpbiB0aGUgY29udHJvbCAiY2hhbmdlIiBldmVudAoJCQkJdGhpcy5tb3VzZU1vdmVkID0gdHJ1ZTsKCgkJCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgaW4gc3luYyB3aXRoIHRoZSBtb3VzZQoJCQkJCXRoaXMuaGFuZGxlLnJlbW92ZUNsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCQkJCX0KCgkJCQl0aGlzLnJlZnJlc2goIGV2ZW50ICk7CgoJCQkJLy8gb25seSBhZnRlciByZWZyZXNoKCkgeW91IGNhbiBjYWxjdWxhdGUgdGhpcy51c2VyTW9kaWZpZWQKCQkJCXRoaXMudXNlck1vZGlmaWVkID0gdGhpcy5iZWZvcmVTdGFydCAhPT0gdGhpcy5lbGVtZW50WzBdLnNlbGVjdGVkSW5kZXg7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9LAoKCV9jaGVja2VkUmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLnZhbHVlICE9PSB0aGlzLl92YWx1ZSgpICkgewoJCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCkgKTsKCQl9Cgl9LAoKCV92YWx1ZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICB0aGlzLmlzVG9nZ2xlU3dpdGNoID8gdGhpcy5lbGVtZW50WzBdLnNlbGVjdGVkSW5kZXggOiBwYXJzZUZsb2F0KCB0aGlzLmVsZW1lbnQudmFsKCkgKSA7Cgl9LAoKCglfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVmcmVzaCggdW5kZWZpbmVkLCBmYWxzZSwgdHJ1ZSApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbiggdmFsLCBpc2Zyb21Db250cm9sLCBwcmV2ZW50SW5wdXRVcGRhdGUgKSB7CgkJLy8gTk9URTogd2UgZG9uJ3QgcmV0dXJuIGhlcmUgYmVjYXVzZSB3ZSB3YW50IHRvIHN1cHBvcnQgcHJvZ3JhbW1hdGljCgkJLy8gICAgICAgYWx0ZXJhdGlvbiBvZiB0aGUgaW5wdXQgdmFsdWUsIHdoaWNoIHNob3VsZCBzdGlsbCB1cGRhdGUgdGhlIHNsaWRlcgoKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCXBhcmVudFRoZW1lID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLmVsZW1lbnRbIDAgXSwgInRoZW1lIiApLAoJCQl0aGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSB8fCBwYXJlbnRUaGVtZSwKCQkJdGhlbWVDbGFzcyA9ICB0aGVtZSA/ICIgdWktYnRuLSIgKyB0aGVtZSA6ICIiLAoJCQl0cmFja1RoZW1lID0gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgfHwgcGFyZW50VGhlbWUsCgkJCXRyYWNrVGhlbWVDbGFzcyA9IHRyYWNrVGhlbWUgPyAiIHVpLWJhci0iICsgdHJhY2tUaGVtZSA6ICIgdWktYmFyLWluaGVyaXQiLAoJCQljb3JuZXJDbGFzcyA9IHRoaXMub3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiLAoJCQltaW5pQ2xhc3MgPSB0aGlzLm9wdGlvbnMubWluaSA/ICIgdWktbWluaSIgOiAiIiwKCQkJbGVmdCwgd2lkdGgsIGRhdGEsIHRvbCwKCQkJcHhTdGVwLCBwZXJjZW50LAoJCQljb250cm9sLCBpc0lucHV0LCBvcHRpb25FbGVtZW50cywgbWluLCBtYXgsIHN0ZXAsCgkJCW5ld3ZhbCwgdmFsTW9kU3RlcCwgYWxpZ25WYWx1ZSwgcGVyY2VudFBlclN0ZXAsCgkJCWhhbmRsZVBlcmNlbnQsIGFQZXJjZW50LCBiUGVyY2VudCwKCQkJdmFsdWVDaGFuZ2VkOwoKCQlzZWxmLnNsaWRlclswXS5jbGFzc05hbWUgPSBbIHRoaXMuaXNUb2dnbGVTd2l0Y2ggPyAidWktc2xpZGVyIHVpLXNsaWRlci1zd2l0Y2ggdWktc2xpZGVyLXRyYWNrIHVpLXNoYWRvdy1pbnNldCIgOiAidWktc2xpZGVyLXRyYWNrIHVpLXNoYWRvdy1pbnNldCIsIHRyYWNrVGhlbWVDbGFzcywgY29ybmVyQ2xhc3MsIG1pbmlDbGFzcyBdLmpvaW4oICIiICk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIgKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoKCQkvLyBzZXQgdGhlIHN0b3JlZCB2YWx1ZSBmb3IgY29tcGFyaXNvbiBsYXRlcgoJCXRoaXMudmFsdWUgPSB0aGlzLl92YWx1ZSgpOwoJCWlmICggdGhpcy5vcHRpb25zLmhpZ2hsaWdodCAmJiAhdGhpcy5pc1RvZ2dsZVN3aXRjaCAmJiB0aGlzLnNsaWRlci5maW5kKCAiLnVpLXNsaWRlci1iZyIgKS5sZW5ndGggPT09IDAgKSB7CgkJCXRoaXMudmFsdWViZyA9IChmdW5jdGlvbigpIHsKCQkJCXZhciBiZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgkJCQliZy5jbGFzc05hbWUgPSAidWktc2xpZGVyLWJnICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzczsKCQkJCXJldHVybiAkKCBiZyApLnByZXBlbmRUbyggc2VsZi5zbGlkZXIgKTsKCQkJfSkoKTsKCQl9CgkJdGhpcy5oYW5kbGUuYWRkQ2xhc3MoICJ1aS1idG4iICsgdGhlbWVDbGFzcyArICIgdWktc2hhZG93IiApOwoKCQljb250cm9sID0gdGhpcy5lbGVtZW50OwoJCWlzSW5wdXQgPSAhdGhpcy5pc1RvZ2dsZVN3aXRjaDsKCQlvcHRpb25FbGVtZW50cyA9IGlzSW5wdXQgPyBbXSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKTsKCQltaW4gPSAgaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1pbiIgKSApIDogMDsKCQltYXggPSBpc0lucHV0ID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWF4IiApICkgOiBvcHRpb25FbGVtZW50cy5sZW5ndGggLSAxOwoJCXN0ZXAgPSAoIGlzSW5wdXQgJiYgcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSApID4gMCApID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSApIDogMTsKCgkJaWYgKCB0eXBlb2YgdmFsID09PSAib2JqZWN0IiApIHsKCQkJZGF0YSA9IHZhbDsKCQkJLy8gYSBzbGlnaHQgdG9sZXJhbmNlIGhlbHBlZCBnZXQgdG8gdGhlIGVuZHMgb2YgdGhlIHNsaWRlcgoJCQl0b2wgPSA4OwoKCQkJbGVmdCA9IHRoaXMuc2xpZGVyLm9mZnNldCgpLmxlZnQ7CgkJCXdpZHRoID0gdGhpcy5zbGlkZXIud2lkdGgoKTsKCQkJcHhTdGVwID0gd2lkdGgvKChtYXgtbWluKS9zdGVwKTsKCQkJaWYgKCAhdGhpcy5kcmFnZ2luZyB8fAoJCQkJCWRhdGEucGFnZVggPCBsZWZ0IC0gdG9sIHx8CgkJCQkJZGF0YS5wYWdlWCA+IGxlZnQgKyB3aWR0aCArIHRvbCApIHsKCQkJCXJldHVybjsKCQkJfQoJCQlpZiAoIHB4U3RlcCA+IDEgKSB7CgkJCQlwZXJjZW50ID0gKCAoIGRhdGEucGFnZVggLSBsZWZ0ICkgLyB3aWR0aCApICogMTAwOwoJCQl9IGVsc2UgewoJCQkJcGVyY2VudCA9IE1hdGgucm91bmQoICggKCBkYXRhLnBhZ2VYIC0gbGVmdCApIC8gd2lkdGggKSAqIDEwMCApOwoJCQl9CgkJfSBlbHNlIHsKCQkJaWYgKCB2YWwgPT0gbnVsbCApIHsKCQkJCXZhbCA9IGlzSW5wdXQgPyBwYXJzZUZsb2F0KCBjb250cm9sLnZhbCgpIHx8IDAgKSA6IGNvbnRyb2xbMF0uc2VsZWN0ZWRJbmRleDsKCQkJfQoJCQlwZXJjZW50ID0gKCBwYXJzZUZsb2F0KCB2YWwgKSAtIG1pbiApIC8gKCBtYXggLSBtaW4gKSAqIDEwMDsKCQl9CgoJCWlmICggaXNOYU4oIHBlcmNlbnQgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJbmV3dmFsID0gKCBwZXJjZW50IC8gMTAwICkgKiAoIG1heCAtIG1pbiApICsgbWluOwoKCQkvL2Zyb20galF1ZXJ5IFVJIHNsaWRlciwgdGhlIGZvbGxvd2luZyBzb3VyY2Ugd2lsbCByb3VuZCB0byB0aGUgbmVhcmVzdCBzdGVwCgkJdmFsTW9kU3RlcCA9ICggbmV3dmFsIC0gbWluICkgJSBzdGVwOwoJCWFsaWduVmFsdWUgPSBuZXd2YWwgLSB2YWxNb2RTdGVwOwoKCQlpZiAoIE1hdGguYWJzKCB2YWxNb2RTdGVwICkgKiAyID49IHN0ZXAgKSB7CgkJCWFsaWduVmFsdWUgKz0gKCB2YWxNb2RTdGVwID4gMCApID8gc3RlcCA6ICggLXN0ZXAgKTsKCQl9CgoJCXBlcmNlbnRQZXJTdGVwID0gMTAwLygobWF4LW1pbikvc3RlcCk7CgkJLy8gU2luY2UgSmF2YVNjcmlwdCBoYXMgcHJvYmxlbXMgd2l0aCBsYXJnZSBmbG9hdHMsIHJvdW5kCgkJLy8gdGhlIGZpbmFsIHZhbHVlIHRvIDUgZGlnaXRzIGFmdGVyIHRoZSBkZWNpbWFsIHBvaW50IChzZWUgalF1ZXJ5VUk6ICM0MTI0KQoJCW5ld3ZhbCA9IHBhcnNlRmxvYXQoIGFsaWduVmFsdWUudG9GaXhlZCg1KSApOwoKCQlpZiAoIHR5cGVvZiBweFN0ZXAgPT09ICJ1bmRlZmluZWQiICkgewoJCQlweFN0ZXAgPSB3aWR0aCAvICggKG1heC1taW4pIC8gc3RlcCApOwoJCX0KCQlpZiAoIHB4U3RlcCA+IDEgJiYgaXNJbnB1dCApIHsKCQkJcGVyY2VudCA9ICggbmV3dmFsIC0gbWluICkgKiBwZXJjZW50UGVyU3RlcCAqICggMSAvIHN0ZXAgKTsKCQl9CgkJaWYgKCBwZXJjZW50IDwgMCApIHsKCQkJcGVyY2VudCA9IDA7CgkJfQoKCQlpZiAoIHBlcmNlbnQgPiAxMDAgKSB7CgkJCXBlcmNlbnQgPSAxMDA7CgkJfQoKCQlpZiAoIG5ld3ZhbCA8IG1pbiApIHsKCQkJbmV3dmFsID0gbWluOwoJCX0KCgkJaWYgKCBuZXd2YWwgPiBtYXggKSB7CgkJCW5ld3ZhbCA9IG1heDsKCQl9CgoJCXRoaXMuaGFuZGxlLmNzcyggImxlZnQiLCBwZXJjZW50ICsgIiUiICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggImFyaWEtdmFsdWVub3ciLCBpc0lucHV0ID8gbmV3dmFsIDogb3B0aW9uRWxlbWVudHMuZXEoIG5ld3ZhbCApLmF0dHIoICJ2YWx1ZSIgKSApOwoKCQl0aGlzLmhhbmRsZVswXS5zZXRBdHRyaWJ1dGUoICJhcmlhLXZhbHVldGV4dCIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuZ2V0RW5jb2RlZFRleHQoKSApOwoKCQl0aGlzLmhhbmRsZVswXS5zZXRBdHRyaWJ1dGUoICJ0aXRsZSIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuZ2V0RW5jb2RlZFRleHQoKSApOwoKCQlpZiAoIHRoaXMudmFsdWViZyApIHsKCQkJdGhpcy52YWx1ZWJnLmNzcyggIndpZHRoIiwgcGVyY2VudCArICIlIiApOwoJCX0KCgkJLy8gZHJhZyB0aGUgbGFiZWwgd2lkdGhzCgkJaWYgKCB0aGlzLl9sYWJlbHMgKSB7CgkJCWhhbmRsZVBlcmNlbnQgPSB0aGlzLmhhbmRsZS53aWR0aCgpIC8gdGhpcy5zbGlkZXIud2lkdGgoKSAqIDEwMDsKCQkJYVBlcmNlbnQgPSBwZXJjZW50ICYmIGhhbmRsZVBlcmNlbnQgKyAoIDEwMCAtIGhhbmRsZVBlcmNlbnQgKSAqIHBlcmNlbnQgLyAxMDA7CgkJCWJQZXJjZW50ID0gcGVyY2VudCA9PT0gMTAwID8gMCA6IE1hdGgubWluKCBoYW5kbGVQZXJjZW50ICsgMTAwIC0gYVBlcmNlbnQsIDEwMCApOwoKCQkJdGhpcy5fbGFiZWxzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgYWIgPSAkKCB0aGlzICkuaGFzQ2xhc3MoICJ1aS1zbGlkZXItbGFiZWwtYSIgKTsKCQkJCSQoIHRoaXMgKS53aWR0aCggKCBhYiA/IGFQZXJjZW50IDogYlBlcmNlbnQgICkgKyAiJSIgKTsKCQkJfSk7CgkJfQoKCQlpZiAoICFwcmV2ZW50SW5wdXRVcGRhdGUgKSB7CgkJCXZhbHVlQ2hhbmdlZCA9IGZhbHNlOwoKCQkJLy8gdXBkYXRlIGNvbnRyb2wicyB2YWx1ZQoJCQlpZiAoIGlzSW5wdXQgKSB7CgkJCQl2YWx1ZUNoYW5nZWQgPSBjb250cm9sLnZhbCgpICE9PSBuZXd2YWw7CgkJCQljb250cm9sLnZhbCggbmV3dmFsICk7CgkJCX0gZWxzZSB7CgkJCQl2YWx1ZUNoYW5nZWQgPSBjb250cm9sWyAwIF0uc2VsZWN0ZWRJbmRleCAhPT0gbmV3dmFsOwoJCQkJY29udHJvbFsgMCBdLnNlbGVjdGVkSW5kZXggPSBuZXd2YWw7CgkJCX0KCQkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3JlY2hhbmdlIiwgdmFsICkgPT09IGZhbHNlKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCWlmICggIWlzZnJvbUNvbnRyb2wgJiYgdmFsdWVDaGFuZ2VkICkgewoJCQkJY29udHJvbC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfQoJfSwKCglfc2V0SGlnaGxpZ2h0OiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFsdWUgPSAhIXZhbHVlOwoJCWlmICggdmFsdWUgKSB7CgkJCXRoaXMub3B0aW9ucy5oaWdobGlnaHQgPSAhIXZhbHVlOwoJCQl0aGlzLnJlZnJlc2goKTsKCQl9IGVsc2UgaWYgKCB0aGlzLnZhbHVlYmcgKSB7CgkJCXRoaXMudmFsdWViZy5yZW1vdmUoKTsKCQkJdGhpcy52YWx1ZWJnID0gZmFsc2U7CgkJfQoJfSwKCglfc2V0VGhlbWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLmhhbmRsZQoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1idG4tIiArIHRoaXMub3B0aW9ucy50aGVtZSApCgkJCS5hZGRDbGFzcyggInVpLWJ0bi0iICsgdmFsdWUgKTsKCgkJdmFyIGN1cnJlbnRUaGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSA/IHRoaXMub3B0aW9ucy50aGVtZSA6ICJpbmhlcml0IiwKCQkJbmV3VGhlbWUgPSB2YWx1ZSA/IHZhbHVlIDogImluaGVyaXQiOwoKCQl0aGlzLmNvbnRyb2wKCQkJLnJlbW92ZUNsYXNzKCAidWktYm9keS0iICsgY3VycmVudFRoZW1lICkKCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgbmV3VGhlbWUgKTsKCX0sCgoJX3NldFRyYWNrVGhlbWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YXIgY3VycmVudFRyYWNrVGhlbWUgPSB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSA/IHRoaXMub3B0aW9ucy50cmFja1RoZW1lIDogImluaGVyaXQiLAoJCQluZXdUcmFja1RoZW1lID0gdmFsdWUgPyB2YWx1ZSA6ICJpbmhlcml0IjsKCgkJdGhpcy5zbGlkZXIKCQkJLnJlbW92ZUNsYXNzKCAidWktYm9keS0iICsgY3VycmVudFRyYWNrVGhlbWUgKQoJCQkuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyBuZXdUcmFja1RoZW1lICk7Cgl9LAoKCV9zZXRNaW5pOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFsdWUgPSAhIXZhbHVlOwoJCWlmICggIXRoaXMuaXNUb2dnbGVTd2l0Y2ggJiYgIXRoaXMuaXNSYW5nZXNsaWRlciApIHsKCQkJdGhpcy5zbGlkZXIucGFyZW50KCkudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgdmFsdWUgKTsKCQkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIHZhbHVlICk7CgkJfQoJCXRoaXMuc2xpZGVyLnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIHZhbHVlICk7Cgl9LAoKCV9zZXRDb3JuZXJzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5zbGlkZXIudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgdmFsdWUgKTsKCgkJaWYgKCAhdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJdGhpcy5jb250cm9sLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIHZhbHVlICk7CgkJfQoJfSwKCglfc2V0RGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YWx1ZSA9ICEhdmFsdWU7CgkJdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIsIHZhbHVlICk7CgkJdGhpcy5zbGlkZXIudG9nZ2xlQ2xhc3MoICJ1aS1kaXNhYmxlZCIsIHZhbHVlICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJfQoKfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmZsaXBzd2l0Y2giLCAkLmV4dGVuZCh7CgoJb3B0aW9uczogewoJCW9uVGV4dDogIk9uIiwKCQlvZmZUZXh0OiAiT2ZmIiwKCQl0aGVtZTogbnVsbCwKCQllbmhhbmNlZDogZmFsc2UsCgkJd3JhcHBlckNsYXNzOiBudWxsLAoJCW1pbmk6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCQl0aGlzLl9lbmhhbmNlKCk7CgkJCX0gZWxzZSB7CgkJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJCWZsaXBzd2l0Y2g6IHRoaXMuZWxlbWVudC5wYXJlbnQoKSwKCQkJCQlvbjogdGhpcy5lbGVtZW50LmZpbmQoICIudWktZmxpcHN3aXRjaC1vbiIgKS5lcSggMCApLAoJCQkJCW9mZjogdGhpcy5lbGVtZW50LmZpbmQoICIudWktZmxpcHN3aXRjaC1vZmYiICkuZXEoMCksCgkJCQkJdHlwZTogdGhpcy5lbGVtZW50LmdldCggMCApLnRhZ05hbWUKCQkJCX0pOwoJCQl9CgoJCQlpZiggdGhpcy5lbGVtZW50LmlzKCAiOmRpc2FibGVkIiApICl7CgkJCQl0aGlzLl9zZXRPcHRpb25zKHsKCQkJCQkiZGlzYWJsZWQiOiB0cnVlCgkJCQl9KTsKCQkJfQoKCQkJdGhpcy5fb24oIHRoaXMuZmxpcHN3aXRjaCwgewoJCQkJImNsaWNrIjogIl90b2dnbGUiLAoJCQkJInN3aXBlbGVmdCI6ICJfbGVmdCIsCgkJCQkic3dpcGVyaWdodCI6ICJfcmlnaHQiCgkJCX0pOwoKCQkJdGhpcy5fb24oIHRoaXMub24sIHsKCQkJCSJrZXlkb3duIjogIl9rZXlkb3duIgoJCQl9KTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5mbGlwc3dpdGNoOwoJfSwKCglfbGVmdDogZnVuY3Rpb24oKSB7CgkJdGhpcy5mbGlwc3dpdGNoLnJlbW92ZUNsYXNzKCAidWktZmxpcHN3aXRjaC1hY3RpdmUiICk7CgkJaWYgKCB0aGlzLnR5cGUgPT09ICJTRUxFQ1QiICkgewoJCQl0aGlzLmVsZW1lbnQuZ2V0KCAwICkuc2VsZWN0ZWRJbmRleCA9IDA7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbGVtZW50LnByb3AoICJjaGVja2VkIiwgdHJ1ZSApOwoJCX0KCQl0aGlzLl90cmlnZ2VyKCAiY2hhbmdlIiApOwoJfSwKCglfcmlnaHQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZmxpcHN3aXRjaC5hZGRDbGFzcyggInVpLWZsaXBzd2l0Y2gtYWN0aXZlIiApOwoJCWlmICggdGhpcy50eXBlID09PSAiU0VMRUNUIiApIHsKCQkJdGhpcy5lbGVtZW50LmdldCggMCApLnNlbGVjdGVkSW5kZXggPSAxOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWxlbWVudC5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJfQoJCXRoaXMuX3RyaWdnZXIoICJjaGFuZ2UiICk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl2YXIgZmxpcHN3aXRjaCA9ICQoICI8ZGl2PiIgKSwKCQkJdGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUgPyB0aGlzLm9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIsCgkJCW9uID0gJCggIjxzcGFuIHRhYmluZGV4PScxJz48L3NwYW4+IiApLAoJCQlvZmYgPSAkKCAiPHNwYW4+PC9zcGFuPiIgKSwKCQkJdHlwZSA9IHRoaXMuZWxlbWVudC5nZXQoIDAgKS50YWdOYW1lLAoJCQlvblRleHQgPSAoIHR5cGUgPT09ICJJTlBVVCIgKSA/IHRoaXMub3B0aW9ucy5vblRleHQgOiB0aGlzLmVsZW1lbnQuZmluZCggIm9wdGlvbiIgKS5lcSggMSApLnRleHQoKSwKCQkJb2ZmVGV4dCA9ICggdHlwZSA9PT0gIklOUFVUIiApID8gdGhpcy5vcHRpb25zLm9mZlRleHQgOiB0aGlzLmVsZW1lbnQuZmluZCggIm9wdGlvbiIgKS5lcSggMCApLnRleHQoKTsKCgkJCW9uLmFkZENsYXNzKCAidWktZmxpcHN3aXRjaC1vbiB1aS1idG4gdWktc2hhZG93IHVpLWJ0bi1pbmhlcml0IiApLnRleHQoIG9uVGV4dCApOwoJCQlvZmYuYWRkQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLW9mZiIgKS50ZXh0KCBvZmZUZXh0ICk7CgkJCQoJCQlmbGlwc3dpdGNoLmFkZENsYXNzKCAidWktZmxpcHN3aXRjaCB1aS1zaGFkb3ctaW5zZXQgdWktY29ybmVyLWFsbCB1aS1iYXItIiArIHRoZW1lICsgIiAiICsgKCB0aGlzLm9wdGlvbnMud3JhcHBlckNsYXNzID8gdGhpcy5vcHRpb25zLndyYXBwZXJDbGFzcyA6ICIiICkgKyAiICIgKyAoICggdGhpcy5lbGVtZW50LmlzKCAiOmNoZWNrZWQiICkgfHwgdGhpcy5lbGVtZW50LmZpbmQoIm9wdGlvbiIpLmVxKDEpLmlzKCI6c2VsZWN0ZWQiKSApID8gInVpLWZsaXBzd2l0Y2gtYWN0aXZlIiA6ICIiICkgKyAoIHRoaXMuZWxlbWVudC5pcygiOmRpc2FibGVkIikgPyAiIHVpLXN0YXRlLWRpc2FibGVkIjogIiIpICsgKCB0aGlzLm9wdGlvbnMubWluaSA/ICIgdWktbWluaSI6ICIiICkgKS5hcHBlbmQoIG9uLCBvZmYgKTsKCQkJCgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLWZsaXBzd2l0Y2gtaW5wdXQiICk7CgkJCXRoaXMuZWxlbWVudC5hZnRlciggZmxpcHN3aXRjaCApLmFwcGVuZFRvKCBmbGlwc3dpdGNoICk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCWZsaXBzd2l0Y2g6IGZsaXBzd2l0Y2gsCgkJCW9uOiBvbiwKCQkJb2ZmOiBvZmYsCgkJCXR5cGU6IHR5cGUKCQl9KTsKCX0sCgoJX2NoYW5nZTogZnVuY3Rpb24oKSB7CgkJdmFyIGRpcmVjdGlvbjsKCQkKCQlpZiAoIHRoaXMudHlwZSA9PT0gIlNFTEVDVCIgKSB7CgkJCWRpcmVjdGlvbiA9ICggdGhpcy5lbGVtZW50LmdldCggMCApLnNlbGVjdGVkSW5kZXggPiAwICk/ICJfcmlnaHQiOiAiX2xlZnQiOwoJCX0gZWxzZSB7CgkJCWRpcmVjdGlvbiA9IHRoaXMuZWxlbWVudC5pcyggIjpjaGVja2VkIiApPyAiX3JpZ2h0IjogIl9sZWZ0IjsKCQl9CgkJdGhpc1sgZGlyZWN0aW9uIF0oKTsKCX0sCgoJX3RvZ2dsZTogZnVuY3Rpb24oKSB7CgkJdmFyIGRpcmVjdGlvbiA9IHRoaXMuZmxpcHN3aXRjaC5oYXNDbGFzcyggInVpLWZsaXBzd2l0Y2gtYWN0aXZlIiApID8gIl9sZWZ0IiA6ICJfcmlnaHQiOwoJCQoJCXRoaXNbZGlyZWN0aW9uXSgpOwoJfSwKCglfa2V5ZG93bjogZnVuY3Rpb24oIGUgKSB7CgkJaWYgKCBlLndoaWNoID09PSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQgKSB7CgkJCXRoaXMuX2xlZnQoKTsKCQl9IGVsc2UgaWYgKCBlLndoaWNoID09PSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUICkgewoJCQl0aGlzLl9yaWdodCgpOwoJCX0gZWxzZSBpZiAoIGUud2hpY2ggPT09ICQubW9iaWxlLmtleUNvZGUuU1BBQ0UgKSB7CgkJCXRoaXMuX3RvZ2dsZSgpOwoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXZhciBjdXJyZW50VGhlbWUgPSBvcHRpb25zLnRoZW1lID8gb3B0aW9ucy50aGVtZSA6ICJpbmhlcml0IiwKCQkJCW5ld1RoZW1lID0gb3B0aW9ucy50aGVtZSA/IG9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCI7CgoJCQl0aGlzLndpZGdldCgpCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1iYXItIiArIGN1cnJlbnRUaGVtZSApCgkJCQkuYWRkQ2xhc3MoICJ1aS1iYXItIiArIG5ld1RoZW1lICk7CgkJfQoJCWlmICggb3B0aW9ucy5vblRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5vbi50ZXh0KCBvcHRpb25zLm9uVGV4dCApOwoJCX0KCQlpZiAoIG9wdGlvbnMub2ZmVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLm9mZi50ZXh0KCBvcHRpb25zLm9mZlRleHQgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMud2lkZ2V0KCkudG9nZ2xlQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIsIG9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9CgkJaWYoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLndpZGdldCgpLnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIG9wdGlvbnMubWluaSApOwoJCX0KCQkKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5vbi5yZW1vdmUoKTsKCQl0aGlzLm9mZi5yZW1vdmUoKTsKCQl0aGlzLmVsZW1lbnQudW53cmFwKCk7CgkJdGhpcy5mbGlwc3dpdGNoLnJlbW92ZSgpOwoJCXRoaXMucmVtb3ZlQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLWlucHV0IiApOwoJfQoKfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCSQud2lkZ2V0KCAibW9iaWxlLnJhbmdlc2xpZGVyIiwgJC5leHRlbmQoIHsKCgkJb3B0aW9uczogewoJCQl0aGVtZTogbnVsbCwKCQkJdHJhY2tUaGVtZTogbnVsbCwKCQkJY29ybmVyczogdHJ1ZSwKCQkJbWluaTogZmFsc2UsCgkJCWhpZ2hsaWdodDogdHJ1ZQoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQllbENsYXNzID0gdGhpcy5vcHRpb25zLm1pbmkgPyAidWktcmFuZ2VzbGlkZXIgdWktbWluaSIgOiAidWktcmFuZ2VzbGlkZXIiLAoJCQlfaW5wdXRGaXJzdCA9ICRlbC5maW5kKCAiaW5wdXQiICkuZmlyc3QoKSwKCQkJX2lucHV0TGFzdCA9ICRlbC5maW5kKCAiaW5wdXQiICkubGFzdCgpLAoJCQlfbGFiZWwgPSAkZWwuZmluZCggImxhYmVsIiApLmZpcnN0KCksCgkJCV9zbGlkZXJGaXJzdCA9ICQuZGF0YSggX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5zbGlkZXIsCgkJCV9zbGlkZXJMYXN0ID0gJC5kYXRhKCBfaW5wdXRMYXN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuc2xpZGVyLAoJCQlmaXJzdEhhbmRsZSA9ICQuZGF0YSggX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUsCgkJCV9zbGlkZXJzID0gJCggIjxkaXYgY2xhc3M9J3VpLXJhbmdlc2xpZGVyLXNsaWRlcnMnIC8+IiApLmFwcGVuZFRvKCAkZWwgKTsKCgkJCV9pbnB1dEZpcnN0LmFkZENsYXNzKCAidWktcmFuZ2VzbGlkZXItZmlyc3QiICk7CgkJCV9pbnB1dExhc3QuYWRkQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1sYXN0IiApOwoJCQkkZWwuYWRkQ2xhc3MoIGVsQ2xhc3MgKTsKCgkJCV9zbGlkZXJGaXJzdC5hcHBlbmRUbyggX3NsaWRlcnMgKTsKCQkJX3NsaWRlckxhc3QuYXBwZW5kVG8oIF9zbGlkZXJzICk7CgkJCV9sYWJlbC5pbnNlcnRCZWZvcmUoICRlbCApOwoJCQlmaXJzdEhhbmRsZS5wcmVwZW5kVG8oIF9zbGlkZXJMYXN0ICk7CgoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJX2lucHV0Rmlyc3Q6IF9pbnB1dEZpcnN0LAoJCQkJX2lucHV0TGFzdDogX2lucHV0TGFzdCwKCQkJCV9zbGlkZXJGaXJzdDogX3NsaWRlckZpcnN0LAoJCQkJX3NsaWRlckxhc3Q6IF9zbGlkZXJMYXN0LAoJCQkJX2xhYmVsOiBfbGFiZWwsCgkJCQlfdGFyZ2V0VmFsOiBudWxsLAoJCQkJX3NsaWRlclRhcmdldDogZmFsc2UsCgkJCQlfc2xpZGVyczogX3NsaWRlcnMsCgkJCQlfcHJveHk6IGZhbHNlCgkJCX0pOwoKCQkJdGhpcy5yZWZyZXNoKCk7CgkJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQuZmluZCggImlucHV0LnVpLXNsaWRlci1pbnB1dCIgKSwgewoJCQkJInNsaWRlYmVmb3Jlc3RhcnQiOiAiX3NsaWRlYmVmb3Jlc3RhcnQiLAoJCQkJInNsaWRlc3RvcCI6ICJfc2xpZGVzdG9wIiwKCQkJCSJzbGlkZWRyYWciOiAiX3NsaWRlZHJhZyIsCgkJCQkic2xpZGViZWZvcmVjaGFuZ2UiOiAiX2NoYW5nZSIsCgkJCQkiYmx1ciI6ICJfY2hhbmdlIiwKCQkJCSJrZXl1cCI6ICJfY2hhbmdlIgoJCQl9KTsKCQkJdGhpcy5fb24oewoJCQkJIm1vdXNlZG93biI6Il9jaGFuZ2UiCgkJCX0pOwoJCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LmNsb3Nlc3QoICJmb3JtIiApLCB7CgkJCQkicmVzZXQiOiJfaGFuZGxlUmVzZXQiCgkJCX0pOwoJCQl0aGlzLl9vbiggZmlyc3RIYW5kbGUsIHsKCQkJCSJ2bW91c2Vkb3duIjogIl9kcmFnRmlyc3RIYW5kbGUiCgkJCX0pOwoJCX0sCgkJX2hhbmRsZVJlc2V0OiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkvL3dlIG11c3Qgd2FpdCBmb3IgdGhlIHN0YWNrIHRvIHVud2luZCBiZWZvcmUgdXBkYXRlaW5nIG90aGVyIHdpc2Ugc2xpZGVycyB3aWxsIG5vdCBoYXZlIHVwZGF0ZWQgeWV0CgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJCX0sMCk7CgkJfSwKCgkJX2RyYWdGaXJzdEhhbmRsZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvL2lmIHRoZSBmaXJzdCBoYW5kbGUgaXMgZHJhZ2dlZCBzZW5kIHRoZSBldmVudCB0byB0aGUgZmlyc3Qgc2xpZGVyCgkJCSQuZGF0YSggdGhpcy5faW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmRyYWdnaW5nID0gdHJ1ZTsKCQkJJC5kYXRhKCB0aGlzLl9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkucmVmcmVzaCggZXZlbnQgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0sCgoJCV9zbGlkZWRyYWc6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZpcnN0ID0gJCggZXZlbnQudGFyZ2V0ICkuaXMoIHRoaXMuX2lucHV0Rmlyc3QgKSwKCQkJCW90aGVyU2xpZGVyID0gKCBmaXJzdCApID8gdGhpcy5faW5wdXRMYXN0IDogdGhpcy5faW5wdXRGaXJzdDsKCgkJCXRoaXMuX3NsaWRlclRhcmdldCA9IGZhbHNlOwoJCQkvL2lmIHRoZSBkcmFnIHdhcyBpbml0aWF0ZWQgb24gYW4gZXh0cmVtZSBhbmQgdGhlIG90aGVyIGhhbmRsZSBpcyBmb2N1c2VkIHNlbmQgdGhlIGV2ZW50cyB0bwoJCQkvL3RoZSBjbG9zZXN0IGhhbmRsZQoJCQlpZiAoICggdGhpcy5fcHJveHkgPT09ICJmaXJzdCIgJiYgZmlyc3QgKSB8fCAoIHRoaXMuX3Byb3h5ID09PSAibGFzdCIgJiYgIWZpcnN0ICkgKSB7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuZHJhZ2dpbmcgPSB0cnVlOwoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLnJlZnJlc2goIGV2ZW50ICk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9LAoKCQlfc2xpZGVzdG9wOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmlzKCB0aGlzLl9pbnB1dEZpcnN0ICk7CgoJCQl0aGlzLl9wcm94eSA9IGZhbHNlOwoJCQkvL3RoaXMgc3RvcHMgZHJhZ2dpbmcgb2YgdGhlIGhhbmRsZSBhbmQgYnJpbmdzIHRoZSBhY3RpdmUgdHJhY2sgdG8gdGhlIGZyb250CgkJCS8vdGhpcyBtYWtlcyBjbGlja3Mgb24gdGhlIHRyYWNrIGdvIHRoZSB0aGUgbGFzdCBoYW5kbGUgdXNlZAoJCQl0aGlzLmVsZW1lbnQuZmluZCggImlucHV0IiApLnRyaWdnZXIoICJ2bW91c2V1cCIgKTsKCQkJdGhpcy5fc2xpZGVyRmlyc3QuY3NzKCAiei1pbmRleCIsIGZpcnN0ID8gMSA6ICIiICk7CgkJfSwKCgkJX3NsaWRlYmVmb3Jlc3RhcnQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdGhpcy5fc2xpZGVyVGFyZ2V0ID0gZmFsc2U7CgkJCS8vaWYgdGhlIHRyYWNrIGlzIHRoZSB0YXJnZXQgcmVtZW1iZXIgdGhpcyBhbmQgdGhlIG9yaWdpbmFsIHZhbHVlCgkJCWlmICggJCggZXZlbnQub3JpZ2luYWxFdmVudC50YXJnZXQgKS5oYXNDbGFzcyggInVpLXNsaWRlci10cmFjayIgKSApIHsKCQkJCXRoaXMuX3NsaWRlclRhcmdldCA9IHRydWU7CgkJCQl0aGlzLl90YXJnZXRWYWwgPSAkKCBldmVudC50YXJnZXQgKS52YWwoKTsKCQkJfQoJCX0sCgoJCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl9zZXRUaGVtZSggb3B0aW9ucy50aGVtZSApOwoJCQl9CgoJCQlpZiAoIG9wdGlvbnMudHJhY2tUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fc2V0VHJhY2tUaGVtZSggb3B0aW9ucy50cmFja1RoZW1lICk7CgkJCX0KCgkJCWlmICggb3B0aW9ucy5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl9zZXRNaW5pKCBvcHRpb25zLm1pbmkgKTsKCQkJfQoKCQkJaWYgKCBvcHRpb25zLmhpZ2hsaWdodCAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fc2V0SGlnaGxpZ2h0KCBvcHRpb25zLmhpZ2hsaWdodCApOwoJCQl9CgkJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0sCgoJCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJbyA9IHRoaXMub3B0aW9uczsKCgkJCSRlbC5maW5kKCAiaW5wdXQiICkuc2xpZGVyKHsKCQkJCXRoZW1lOiBvLnRoZW1lLAoJCQkJdHJhY2tUaGVtZTogby50cmFja1RoZW1lLAoJCQkJZGlzYWJsZWQ6IG8uZGlzYWJsZWQsCgkJCQljb3JuZXJzOiBvLmNvcm5lcnMsCgkJCQltaW5pOiBvLm1pbmksCgkJCQloaWdobGlnaHQ6IG8uaGlnaGxpZ2h0CgkJCX0pLnNsaWRlciggInJlZnJlc2giICk7CgkJCXRoaXMuX3VwZGF0ZUhpZ2hsaWdodCgpOwoJCX0sCgoJCV9jaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCBldmVudC50eXBlID09PSAia2V5dXAiICkgewoJCQkJdGhpcy5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW1pbiA9IHBhcnNlRmxvYXQoIHRoaXMuX2lucHV0Rmlyc3QudmFsKCksIDEwICksCgkJCQltYXggPSBwYXJzZUZsb2F0KCB0aGlzLl9pbnB1dExhc3QudmFsKCksIDEwICksCgkJCQlmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmhhc0NsYXNzKCAidWktcmFuZ2VzbGlkZXItZmlyc3QiICksCgkJCQl0aGlzU2xpZGVyID0gZmlyc3QgPyB0aGlzLl9pbnB1dEZpcnN0IDogdGhpcy5faW5wdXRMYXN0LAoJCQkJb3RoZXJTbGlkZXIgPSBmaXJzdCA/IHRoaXMuX2lucHV0TGFzdCA6IHRoaXMuX2lucHV0Rmlyc3Q7CgoKCQkJaWYgKCAoIHRoaXMuX2lucHV0Rmlyc3QudmFsKCkgPiB0aGlzLl9pbnB1dExhc3QudmFsKCkgJiYgZXZlbnQudHlwZSA9PT0gIm1vdXNlZG93biIgJiYgISQoZXZlbnQudGFyZ2V0KS5oYXNDbGFzcygidWktc2xpZGVyLWhhbmRsZSIpKSApewoJCQkJdGhpc1NsaWRlci5ibHVyKCk7CgkJCX0gZWxzZSBpZiAoIGV2ZW50LnR5cGUgPT09ICJtb3VzZWRvd24iICl7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCBtaW4gPiBtYXggJiYgIXRoaXMuX3NsaWRlclRhcmdldCApIHsKCQkJCS8vdGhpcyBwcmV2ZW50cyBtaW4gZnJvbSBiZWluZyBncmVhdGVyIHRoZW4gbWF4CgkJCQl0aGlzU2xpZGVyLnZhbCggZmlyc3QgPyBtYXg6IG1pbiApLnNsaWRlciggInJlZnJlc2giICk7CgkJCQl0aGlzLl90cmlnZ2VyKCAibm9ybWFsaXplIiApOwoJCQl9IGVsc2UgaWYgKCBtaW4gPiBtYXggKSB7CgkJCQkvL3RoaXMgbWFrZXMgaXQgc28gY2xpY2tzIG9uIHRoZSB0YXJnZXQgb24gZWl0aGVyIGV4dHJlbWUgZ28gdG8gdGhlIGNsb3Nlc3QgaGFuZGxlCgkJCQl0aGlzU2xpZGVyLnZhbCggdGhpcy5fdGFyZ2V0VmFsICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCgkJCQkvL1lvdSBtdXN0IHdhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgc28gZmlyc3Qgc2xpZGVyIGlzIHVwZGF0ZWQgYmVmb3JlIHVwZGF0aW5nIHNlY29uZAoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJb3RoZXJTbGlkZXIudmFsKCBmaXJzdCA/IG1pbjogbWF4ICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCQkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmZvY3VzKCk7CgkJCQkJc2VsZi5fc2xpZGVyRmlyc3QuY3NzKCAiei1pbmRleCIsIGZpcnN0ID8gIiIgOiAxICk7CgkJCQkJc2VsZi5fdHJpZ2dlciggIm5vcm1hbGl6ZSIgKTsKCQkJCX0sIDAgKTsKCQkJCXRoaXMuX3Byb3h5ID0gKCBmaXJzdCApID8gImZpcnN0IiA6ICJsYXN0IjsKCQkJfQoJCQkvL2ZpeGVzIGlzc3VlIHdoZXJlIHdoZW4gYm90aCBfc2xpZGVycyBhcmUgYXQgbWluIHRoZXkgY2Fubm90IGJlIGFkanVzdGVkCgkJCWlmICggbWluID09PSBtYXggKSB7CgkJCQkkLmRhdGEoIHRoaXNTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsIDEgKTsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsIDAgKTsKCQkJfSBlbHNlIHsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsICIiICk7CgkJCQkkLmRhdGEoIHRoaXNTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsICIiICk7CgkJCX0KCgkJCXRoaXMuX3VwZGF0ZUhpZ2hsaWdodCgpOwoKCQkJaWYgKCBtaW4gPj0gbWF4ICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCgkJX3VwZGF0ZUhpZ2hsaWdodDogZnVuY3Rpb24oKSB7CgkJCXZhciBtaW4gPSBwYXJzZUludCggJC5kYXRhKCB0aGlzLl9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmdldCgwKS5zdHlsZS5sZWZ0LCAxMCApLAoJCQkJbWF4ID0gcGFyc2VJbnQoICQuZGF0YSggdGhpcy5faW5wdXRMYXN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmdldCgwKS5zdHlsZS5sZWZ0LCAxMCApLAoJCQkJd2lkdGggPSAobWF4IC0gbWluKTsKCgkJCXRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXNsaWRlci1iZyIgKS5jc3MoewoJCQkJIm1hcmdpbi1sZWZ0IjogbWluICsgIiUiLAoJCQkJIndpZHRoIjogd2lkdGggKyAiJSIKCQkJfSk7CgkJfSwKCgkJX3NldFRoZW1lOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX2lucHV0Rmlyc3Quc2xpZGVyKCAib3B0aW9uIiwgInRoZW1lIiwgdmFsdWUgKTsKCQkJdGhpcy5faW5wdXRMYXN0LnNsaWRlciggIm9wdGlvbiIsICJ0aGVtZSIsIHZhbHVlICk7CgkJfSwKCgkJX3NldFRyYWNrVGhlbWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5faW5wdXRGaXJzdC5zbGlkZXIoICJvcHRpb24iLCAidHJhY2tUaGVtZSIsIHZhbHVlICk7CgkJCXRoaXMuX2lucHV0TGFzdC5zbGlkZXIoICJvcHRpb24iLCAidHJhY2tUaGVtZSIsIHZhbHVlICk7CgkJfSwKCgkJX3NldE1pbmk6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5faW5wdXRGaXJzdC5zbGlkZXIoICJvcHRpb24iLCAibWluaSIsIHZhbHVlICk7CgkJCXRoaXMuX2lucHV0TGFzdC5zbGlkZXIoICJvcHRpb24iLCAibWluaSIsIHZhbHVlICk7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLW1pbmkiLCAhIXZhbHVlICk7CgkJfSwKCgkJX3NldEhpZ2hsaWdodDogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9pbnB1dEZpcnN0LnNsaWRlciggIm9wdGlvbiIsICJoaWdobGlnaHQiLCB2YWx1ZSApOwoJCQl0aGlzLl9pbnB1dExhc3Quc2xpZGVyKCAib3B0aW9uIiwgImhpZ2hsaWdodCIsIHZhbHVlICk7CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9sYWJlbC5wcmVwZW5kVG8oIHRoaXMuZWxlbWVudCApOwoJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1yYW5nZXNsaWRlciB1aS1taW5pIiApOwoJCQl0aGlzLl9pbnB1dEZpcnN0LmFmdGVyKCB0aGlzLl9zbGlkZXJGaXJzdCApOwoJCQl0aGlzLl9pbnB1dExhc3QuYWZ0ZXIoIHRoaXMuX3NsaWRlckxhc3QgKTsKCQkJdGhpcy5fc2xpZGVycy5yZW1vdmUoKTsKCQkJdGhpcy5lbGVtZW50LmZpbmQoICJpbnB1dCIgKS5yZW1vdmVDbGFzcyggInVpLXJhbmdlc2xpZGVyLWZpcnN0IHVpLXJhbmdlc2xpZGVyLWxhc3QiICkuc2xpZGVyKCAiZGVzdHJveSIgKTsKCQl9CgoJfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS50ZXh0aW5wdXQiLCAkLm1vYmlsZS50ZXh0aW5wdXQsIHsKCQlvcHRpb25zOiB7CgkJCWNsZWFyQnRuOiBmYWxzZSwKCQkJY2xlYXJCdG5UZXh0OiAiQ2xlYXIgdGV4dCIKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCgkJCWlmICggISF0aGlzLm9wdGlvbnMuY2xlYXJCdG4gfHwgdGhpcy5pc1NlYXJjaCApewoJCQkJdGhpcy5fYWRkQ2xlYXJCdG4oKTsKCQkJfQoJCX0sCgoJCWNsZWFyQnV0dG9uOiBmdW5jdGlvbigpIHsKCgkJCXJldHVybiAkKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWlucHV0LWNsZWFyIHVpLWJ0biB1aS1pY29uLWRlbGV0ZSB1aS1idG4taWNvbi1ub3RleHQgdWktY29ybmVyLWFsbCIgKwogICAgIicgdGl0bGU9JyIgKyB0aGlzLm9wdGlvbnMuY2xlYXJCdG5UZXh0ICsgIic+IiArIHRoaXMub3B0aW9ucy5jbGVhckJ0blRleHQgKyAiPC9hPiIgKTsKCgkJfSwKCgkJX2NsZWFyQnRuQ2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdGhpcy5lbGVtZW50LnZhbCggIiIgKQoJCQkJCS5mb2N1cygpCgkJCQkJLnRyaWdnZXIoICJjaGFuZ2UiICk7CgoJCQl0aGlzLl9jbGVhckJ0bi5hZGRDbGFzcyggInVpLWlucHV0LWNsZWFyLWhpZGRlbiIgKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9LAoKCQlfYWRkQ2xlYXJCdG46IGZ1bmN0aW9uKCkgewoKCQkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQkJdGhpcy5fZW5oYW5jZUNsZWFyKCk7CgkJCX0KCgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlfY2xlYXJCdG46IHRoaXMud2lkZ2V0KCkuZmluZCgiYS51aS1pbnB1dC1jbGVhciIpCgkJCX0pOwoKCQkJdGhpcy5fYmluZENsZWFyRXZlbnRzKCk7CgoJCQl0aGlzLl90b2dnbGVDbGVhcigpOwoKCQl9LAoKCQlfZW5oYW5jZUNsZWFyOiBmdW5jdGlvbigpIHsKCgkJCXRoaXMuY2xlYXJCdXR0b24oKS5hcHBlbmRUbyggdGhpcy53aWRnZXQoKSApOwoJCQl0aGlzLndpZGdldCgpLmFkZENsYXNzKCAidWktaW5wdXQtaGFzLWNsZWFyIiApOwoKCQl9LAoKCQlfYmluZENsZWFyRXZlbnRzOiBmdW5jdGlvbigpIHsKCgkJCXRoaXMuX29uKCB0aGlzLl9jbGVhckJ0biwgewoJCQkJImNsaWNrIjogIl9jbGVhckJ0bkNsaWNrIgoJCQl9KTsKCgkJCXRoaXMuX29uKHsKCQkJCSJrZXl1cCI6ICJfdG9nZ2xlQ2xlYXIiLAoJCQkJImNoYW5nZSI6ICJfdG9nZ2xlQ2xlYXIiLAoJCQkJImlucHV0IjogIl90b2dnbGVDbGVhciIsCgkJCQkiZm9jdXMiOiAiX3RvZ2dsZUNsZWFyIiwKCQkJCSJibHVyIjogIl90b2dnbGVDbGVhciIsCgkJCQkiY3V0IjogIl90b2dnbGVDbGVhciIsCgkJCQkicGFzdGUiOiAiX3RvZ2dsZUNsZWFyIgoKCQkJfSk7CgoJCX0sCgoJCV91bmJpbmRDbGVhcjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX29mZiggdGhpcy5fY2xlYXJCdG4sICJjbGljayIpOwoJCQl0aGlzLl9vZmYoIHRoaXMuZWxlbWVudCwgImtleXVwIGNoYW5nZSBpbnB1dCBmb2N1cyBibHVyIGN1dCBwYXN0ZSIgKTsKCQl9LAoKCQlfc2V0T3B0aW9uczpmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJCWlmICggb3B0aW9ucy5jbGVhcmJ0biAhPT0gdW5kZWZpbmVkICYmICF0aGlzLmVsZW1lbnQuaXMoICJ0ZXh0YXJlYSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSIgKSApIHsKCQkJCWlmICggb3B0aW9ucy5jbGVhckJ0biApewoJCQkJCXRoaXMuX2FkZENsZWFyQnRuKCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuX2Rlc3Ryb3lDbGVhcigpOwoJCQkJfQoJCQl9CgoJCQlpZiAoIG9wdGlvbnMuY2xlYXJCdG5UZXh0ICE9PSB1bmRlZmluZWQgJiYgdGhpcy5fY2xlYXJCdG4gIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX2NsZWFyQnRuLnRleHQoIG9wdGlvbnMuY2xlYXJCdG5UZXh0ICk7CgkJCX0KCQl9LAoKCQlfdG9nZ2xlQ2xlYXI6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9kZWxheSggIl90b2dnbGVDbGVhckNsYXNzIiwgMCApOwoJCX0sCgoJCV90b2dnbGVDbGVhckNsYXNzOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fY2xlYXJCdG4udG9nZ2xlQ2xhc3MoICJ1aS1pbnB1dC1jbGVhci1oaWRkZW4iLCAhdGhpcy5lbGVtZW50LnZhbCgpICk7CgkJfSwKCgkJX2Rlc3Ryb3lDbGVhcjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWlucHV0LWhhcy1jbGVhciIgKTsKCQkJdGhpcy5fdW5iaW5kQ2xlYXIoKS5fY2xlYXJCdG4ucmVtb3ZlKCk7CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQl0aGlzLl9kZXN0cm95Q2xlYXIoKTsKCQl9CgoJfSk7CgoKfSkoIGpRdWVyeSApOwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS50ZXh0aW5wdXQiLCAkLm1vYmlsZS50ZXh0aW5wdXQsIHsKCQlvcHRpb25zOiB7CgkJCWF1dG9ncm93OnRydWUsCgkJCWtleXVwVGltZW91dEJ1ZmZlcjogMTAwCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgoJCQlpZiAoIHRoaXMub3B0aW9ucy5hdXRvZ3JvdyAmJiB0aGlzLmlzVGV4dGFyZWEgKSB7CgkJCQl0aGlzLl9hdXRvZ3JvdygpOwoJCQl9CgkJfSwKCgkJX2F1dG9ncm93OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fb24oewoJCQkJImtleXVwIjogIl90aW1lb3V0IiwKCQkJCSJjaGFuZ2UiOiAiX3RpbWVvdXQiLAoJCQkJImlucHV0IjogIl90aW1lb3V0IiwKCQkJCSJwYXN0ZSI6ICJfdGltZW91dCIsCgkJCX0pOwoKCQkJLy8gSXNzdWUgNTA5OiB0aGUgYnJvd3NlciBpcyBub3QgcHJvdmlkaW5nIHNjcm9sbEhlaWdodCBwcm9wZXJseSB1bnRpbCB0aGUgc3R5bGVzIGxvYWQKCQkJaWYgKCAkLnRyaW0oIHRoaXMuZWxlbWVudC52YWwoKSApICkgewoJCQkJLy8gYmluZCB0byB0aGUgd2luZG93IGxvYWQgdG8gbWFrZSBzdXJlIHRoZSBoZWlnaHQgaXMgY2FsY3VsYXRlZCBiYXNlZCBvbiBCT1RICgkJCQkvLyB0aGUgRE9NIGFuZCBDU1MKCQkJCS8vIGJpbmRpbmcgdG8gcGFnZWNoYW5nZSBoZXJlIGVuc3VyZXMgdGhhdCBmb3IgcGFnZXMgbG9hZGVkIHZpYQoJCQkJLy8gYWpheCB0aGUgaGVpZ2h0IGlzIHJlY2FsY3VsYXRlZCB3aXRob3V0IHVzZXIgaW5wdXQKCQkJCXRoaXMuX29uKCB0cnVlLCAkLm1vYmlsZS53aW5kb3csIHsKCQkJCQkibG9hZCI6ICJfdGltZW91dCIsCgkJCQkJInBhZ2VjaGFuZ2UiOiAiX3RpbWVvdXQiCgkJCQl9KTsKCQkJfQoJCX0sCgoJCV91bmJpbmRBdXRvZ3JvdzogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX29mZiggdGhpcy5lbGVtZW50LCAia2V5dXAgY2hhbmdlIGlucHV0IHBhc3RlIiApOwoJCQl0aGlzLl9vZmYoICQubW9iaWxlLndpbmRvdywgImxvYWQgcGFnZWNoYW5nZSIgKTsKCQl9LAoKCQlrZXl1cFRpbWVvdXQ6bnVsbCwKCgkJX3RpbWVvdXQ6IGZ1bmN0aW9uKCkgewoJCQljbGVhclRpbWVvdXQoIHRoaXMua2V5dXBUaW1lb3V0ICk7CgkJCXRoaXMua2V5dXBUaW1lb3V0ID0gdGhpcy5fZGVsYXkoICJfdXBkYXRlSGVpZ2h0IiwgdGhpcy5vcHRpb25zLmtleXVwVGltZW91dEJ1ZmZlciApOwoJCX0sCgoJCV91cGRhdGVIZWlnaHQ6ZnVuY3Rpb24oKSB7CgoJCQl0aGlzLmVsZW1lbnQuY3NzKCAiaGVpZ2h0IiwgIjBweCIgKTsKCgkJCXZhciBwYWRkaW5nVG9wLCBwYWRkaW5nQm90dG9tLCBwYWRkaW5nSGVpZ2h0LAoJCQkJc2Nyb2xsSGVpZ2h0ID0gdGhpcy5lbGVtZW50WyAwIF0uc2Nyb2xsSGVpZ2h0LAoJCQkJY2xpZW50SGVpZ2h0ID0gdGhpcy5lbGVtZW50WyAwIF0uY2xpZW50SGVpZ2h0LAoJCQkJYm9yZGVyVG9wID0gcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LmNzcyggImJvcmRlci10b3Atd2lkdGgiICkgKSwKCQkJCWJvcmRlckJvdHRvbSA9IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC5jc3MoICJib3JkZXItYm90dG9tLXdpZHRoIiApICksCgkJCQlib3JkZXJIZWlnaHQgPSBib3JkZXJUb3AgKyBib3JkZXJCb3R0b20sCgkJCQloZWlnaHQgPSBzY3JvbGxIZWlnaHQgKyBib3JkZXJIZWlnaHQgKyAxNTsKCgkJCS8vIElzc3VlIDYxNzk6IFBhZGRpbmcgaXMgbm90IGluY2x1ZGVkIGluIHNjcm9sbEhlaWdodCBhbmQKCQkJLy8gY2xpZW50SGVpZ2h0IGJ5IEZpcmVmb3ggaWYgbm8gc2Nyb2xsYmFyIGlzIHZpc2libGUuIEJlY2F1c2UKCQkJLy8gdGV4dGFyZWFzIHVzZSB0aGUgYm9yZGVyLWJveCBib3gtc2l6aW5nIG1vZGVsLCBwYWRkaW5nIHNob3VsZCBiZQoJCQkvLyBpbmNsdWRlZCBpbiB0aGUgbmV3IChhc3NpZ25lZCkgaGVpZ2h0LiBCZWNhdXNlIHRoZSBoZWlnaHQgaXMgc2V0CgkJCS8vIHRvIDAsIGNsaWVudEhlaWdodCA9PSAwIGluIEZpcmVmb3guIFRoZXJlZm9yZSwgd2UgY2FuIHVzZSB0aGlzIHRvCgkJCS8vIGNoZWNrIGlmIHBhZGRpbmcgbXVzdCBiZSBhZGRlZC4KCQkJaWYgKCBjbGllbnRIZWlnaHQgPT09IDAgKSB7CgkJCQlwYWRkaW5nVG9wID0gcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LmNzcyggInBhZGRpbmctdG9wIiApICk7CgkJCQlwYWRkaW5nQm90dG9tID0gcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LmNzcyggInBhZGRpbmctYm90dG9tIiApICk7CgkJCQlwYWRkaW5nSGVpZ2h0ID0gcGFkZGluZ1RvcCArIHBhZGRpbmdCb3R0b207CgoJCQkJaGVpZ2h0ICs9IHBhZGRpbmdIZWlnaHQ7CgkJCX0KCgkJCXRoaXMuZWxlbWVudC5jc3MoICJoZWlnaHQiLCBoZWlnaHQgKyAicHgiICk7CgkJfSwKCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICl7CgoJCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoKCQkJaWYgKCBvcHRpb25zLmF1dG9ncm93ICE9PSB1bmRlZmluZWQgJiYgdGhpcy5pc1RleHRhcmVhICl7CgkJCQlpZiAoIG9wdGlvbnMuYXV0b2dyb3cgKXsKCQkJCQl0aGlzLl9hdXRvZ3JvdygpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLl91bmJpbmRBdXRvZ3JvdygpOwoJCQkJfQoJCQl9CgkJfQoKCX0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnNlbGVjdG1lbnUiLCAkLmV4dGVuZCggewoJaW5pdFNlbGVjdG9yOiAic2VsZWN0Om5vdCggOmpxbURhdGEocm9sZT0nc2xpZGVyJykpOm5vdCggOmpxbURhdGEocm9sZT0nZmxpcHN3aXRjaCcpICkiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQlkaXNhYmxlZDogZmFsc2UsCgkJaWNvbjogImNhcmF0LWQiLAoJCWljb25wb3M6ICJyaWdodCIsCgkJaW5saW5lOiBmYWxzZSwKCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpY29uc2hhZG93OiBmYWxzZSwgLyogVE9ETzogRGVwcmVjYXRlZCBpbiAxLjQsIHJlbW92ZSBpbiAxLjUuICovCgkJb3ZlcmxheVRoZW1lOiBudWxsLAoJCWRpdmlkZXJUaGVtZTogbnVsbCwKCQloaWRlUGxhY2Vob2xkZXJNZW51SXRlbXM6IHRydWUsCgkJY2xvc2VUZXh0OiAiQ2xvc2UiLAoJCW5hdGl2ZU1lbnU6IHRydWUsCgkJLy8gVGhpcyBvcHRpb24gZGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MgZGV2aWNlcy4KCQlwcmV2ZW50Rm9jdXNab29tOiAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSwKCQltaW5pOiBmYWxzZQoJfSwKCglfYnV0dG9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJCggIjxkaXYvPiIgKTsKCX0sCgoJX3NldERpc2FibGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHZhbHVlICk7CgkJdGhpcy5idXR0b24uYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHZhbHVlICk7Cgl9LAoKCV9mb2N1c0J1dHRvbiA6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCXNlbGYuYnV0dG9uLmZvY3VzKCk7CgkJfSwgNDApOwoJfSwKCglfc2VsZWN0T3B0aW9uczogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuc2VsZWN0LmZpbmQoICJvcHRpb24iICk7Cgl9LAoKCS8vIHNldHVwIGl0ZW1zIHRoYXQgYXJlIGdlbmVyYWxseSBuZWNlc3NhcnkgZm9yIHNlbGVjdCBtZW51IGV4dGVuc2lvbgoJX3ByZUV4dGVuc2lvbjogZnVuY3Rpb24oKSB7CgkJdmFyIGlubGluZSA9IHRoaXMub3B0aW9ucy5pbmxpbmUgfHwgdGhpcy5lbGVtZW50LmpxbURhdGEoICJpbmxpbmUiICksCgkJCW1pbmkgPSB0aGlzLm9wdGlvbnMubWluaSB8fCB0aGlzLmVsZW1lbnQuanFtRGF0YSggIm1pbmkiICksCgkJCWNsYXNzZXMgPSAiIjsKCQkvLyBUT0RPOiBQb3N0IDEuMS0tb25jZSB3ZSBoYXZlIHRpbWUgdG8gdGVzdCB0aG9yb3VnaGx5LS1hbnkgY2xhc3NlcyBtYW51YWxseSBhcHBsaWVkIHRvIHRoZSBvcmlnaW5hbCBlbGVtZW50IHNob3VsZCBiZSBjYXJyaWVkIG92ZXIgdG8gdGhlIGVuaGFuY2VkIGVsZW1lbnQsIHdpdGggYW4gYC1lbmhhbmNlZGAgc3VmZml4LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTc3CgkJLyogaWYgKCAkZWxbMF0uY2xhc3NOYW1lLmxlbmd0aCApIHsKCQkJY2xhc3NlcyA9ICRlbFswXS5jbGFzc05hbWU7CgkJfSAqLwoJCWlmICggISF+dGhpcy5lbGVtZW50WzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLWxlZnQiICkgKSB7CgkJCWNsYXNzZXMgPSAiIHVpLWJ0bi1sZWZ0IjsKCQl9CgoJCWlmICggICEhfnRoaXMuZWxlbWVudFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1yaWdodCIgKSApIHsKCQkJY2xhc3NlcyA9ICIgdWktYnRuLXJpZ2h0IjsKCQl9CgoJCWlmICggaW5saW5lICkgewoJCQljbGFzc2VzICs9ICIgdWktYnRuLWlubGluZSI7CgkJfQoJCWlmICggbWluaSApIHsKCQkJY2xhc3NlcyArPSAiIHVpLW1pbmkiOwoJCX0KCgkJdGhpcy5zZWxlY3QgPSB0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1idG4tbGVmdCB1aS1idG4tcmlnaHQiICkud3JhcCggIjxkaXYgY2xhc3M9J3VpLXNlbGVjdCIgKyBjbGFzc2VzICsgIic+IiApOwoJCXRoaXMuc2VsZWN0SWQgID0gdGhpcy5zZWxlY3QuYXR0ciggImlkIiApIHx8ICggInNlbGVjdC0iICsgdGhpcy51dWlkICk7CgkJdGhpcy5idXR0b25JZCA9IHRoaXMuc2VsZWN0SWQgKyAiLWJ1dHRvbiI7CgkJdGhpcy5sYWJlbCA9ICQoICJsYWJlbFtmb3I9JyIrIHRoaXMuc2VsZWN0SWQgKyInXSIgKTsKCQl0aGlzLmlzTXVsdGlwbGUgPSB0aGlzLnNlbGVjdFsgMCBdLm11bHRpcGxlOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIHdyYXBwZXIgPSB0aGlzLmVsZW1lbnQucGFyZW50cyggIi51aS1zZWxlY3QiICk7CgkJaWYgKCB3cmFwcGVyLmxlbmd0aCA+IDAgKSB7CgkJCWlmICggd3JhcHBlci5pcyggIi51aS1idG4tbGVmdCwgLnVpLWJ0bi1yaWdodCIgKSApIHsKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggd3JhcHBlci5oYXNDbGFzcyggInVpLWJ0bi1sZWZ0IiApID8gInVpLWJ0bi1sZWZ0IiA6ICJ1aS1idG4tcmlnaHQiICk7CgkJCX0KCQkJdGhpcy5lbGVtZW50Lmluc2VydEFmdGVyKCB3cmFwcGVyICk7CgkJCXdyYXBwZXIucmVtb3ZlKCk7CgkJfQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9wcmVFeHRlbnNpb24oKTsKCgkJdGhpcy5idXR0b24gPSB0aGlzLl9idXR0b24oKTsKCgkJdmFyIHNlbGYgPSB0aGlzLAoKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCgkJCWljb25wb3MgPSBvcHRpb25zLmljb24gPyAoIG9wdGlvbnMuaWNvbnBvcyB8fCB0aGlzLnNlbGVjdC5qcW1EYXRhKCAiaWNvbnBvcyIgKSApIDogZmFsc2UsCgoJCQlidXR0b24gPSB0aGlzLmJ1dHRvbgoJCQkJLmluc2VydEJlZm9yZSggdGhpcy5zZWxlY3QgKQoJCQkJLmF0dHIoICJpZCIsIHRoaXMuYnV0dG9uSWQgKQoJCQkJLmFkZENsYXNzKCAidWktYnRuIiArCgkJCQkJKCBvcHRpb25zLmljb24gPyAoICIgdWktaWNvbi0iICsgb3B0aW9ucy5pY29uICsgIiB1aS1idG4taWNvbi0iICsgaWNvbnBvcyArCgkJCQkJKCBvcHRpb25zLmljb25zaGFkb3cgPyAiIHVpLXNoYWRvdy1pY29uIiA6ICIiICkgKSA6CSIiICkgKyAvKiBUT0RPOiBSZW1vdmUgaW4gMS41LiAqLwoJCQkJCSggb3B0aW9ucy50aGVtZSA/ICIgdWktYnRuLSIgKyBvcHRpb25zLnRoZW1lIDogIiIgKSArCgkJCQkJKCBvcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIgKSArCgkJCQkJKCBvcHRpb25zLnNoYWRvdyA/ICIgdWktc2hhZG93IiA6ICIiICkgKTsKCgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgoJCS8vIE9wZXJhIGRvZXMgbm90IHByb3Blcmx5IHN1cHBvcnQgb3BhY2l0eSBvbiBzZWxlY3QgZWxlbWVudHMKCQkvLyBJbiBNaW5pLCBpdCBoaWRlcyB0aGUgZWxlbWVudCwgYnV0IG5vdCBpdHMgdGV4dAoJCS8vIE9uIHRoZSBkZXNrdG9wLGl0IHNlZW1zIHRvIGRvIHRoZSBvcHBvc2l0ZQoJCS8vIGZvciB0aGVzZSByZWFzb25zLCB1c2luZyB0aGUgbmF0aXZlTWVudSBvcHRpb24gcmVzdWx0cyBpbiBhIGZ1bGwgbmF0aXZlIHNlbGVjdCBpbiBPcGVyYQoJCWlmICggb3B0aW9ucy5uYXRpdmVNZW51ICYmIHdpbmRvdy5vcGVyYSAmJiB3aW5kb3cub3BlcmEudmVyc2lvbiApIHsKCQkJYnV0dG9uLmFkZENsYXNzKCAidWktc2VsZWN0LW5hdGl2ZW9ubHkiICk7CgkJfQoKCQkvLyBBZGQgY291bnRlciBmb3IgbXVsdGkgc2VsZWN0cwoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQl0aGlzLmJ1dHRvbkNvdW50ID0gJCggIjxzcGFuPiIgKQoJCQkJLmFkZENsYXNzKCAidWktbGktY291bnQgdWktYm9keS1pbmhlcml0IiApCgkJCQkuaGlkZSgpCgkJCQkuYXBwZW5kVG8oIGJ1dHRvbi5hZGRDbGFzcyggInVpLWxpLWhhcy1jb3VudCIgKSApOwoJCX0KCgkJLy8gRGlzYWJsZSBpZiBzcGVjaWZpZWQKCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIgKSkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCS8vIEV2ZW50cyBvbiBuYXRpdmUgc2VsZWN0CgkJdGhpcy5zZWxlY3QuY2hhbmdlKGZ1bmN0aW9uKCkgewoJCQlzZWxmLnJlZnJlc2goKTsKCgkJCWlmICggISFvcHRpb25zLm5hdGl2ZU1lbnUgKSB7CgkJCQl0aGlzLmJsdXIoKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCgkJdGhpcy5idWlsZCgpOwoJfSwKCglidWlsZDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLnNlbGVjdAoJCQkuYXBwZW5kVG8oIHNlbGYuYnV0dG9uICkKCQkJLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBBZGQgYWN0aXZlIGNsYXNzIHRvIGJ1dHRvbgoJCQkJc2VsZi5idXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJmb2N1cyB2bW91c2VvdmVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3ZlciIgKTsKCQkJfSkKCQkJLmJpbmQoICJ2bW91c2Vtb3ZlIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBSZW1vdmUgYWN0aXZlIGNsYXNzIG9uIHNjcm9sbC90b3VjaG1vdmUKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImNoYW5nZSBibHVyIHZtb3VzZW91dCIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24udHJpZ2dlciggInZtb3VzZW91dCIgKQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSk7CgoJCS8vIEluIG1hbnkgc2l0dWF0aW9ucywgaU9TIHdpbGwgem9vbSBpbnRvIHRoZSBzZWxlY3QgdXBvbiB0YXAsIHRoaXMgcHJldmVudHMgdGhhdCBmcm9tIGhhcHBlbmluZwoJCXNlbGYuYnV0dG9uLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCQlzZWxmLmxhYmVsLmJpbmQoICJjbGljayBmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7CgkJc2VsZi5zZWxlY3QuYmluZCggImZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCQlzZWxmLmJ1dHRvbi5iaW5kKCAibW91c2V1cCIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQkJfSwgMCApOwoJCQl9CgkJfSk7CgkJc2VsZi5zZWxlY3QuYmluZCggImJsdXIiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCgl9LAoKCXNlbGVjdGVkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZCIgKTsKCX0sCgoJc2VsZWN0ZWRJbmRpY2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXJldHVybiB0aGlzLnNlbGVjdGVkKCkubWFwKGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gc2VsZi5fc2VsZWN0T3B0aW9ucygpLmluZGV4KCB0aGlzICk7CgkJfSkuZ2V0KCk7Cgl9LAoKCXNldEJ1dHRvblRleHQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJc2VsZWN0ZWQgPSB0aGlzLnNlbGVjdGVkKCksCgkJCXRleHQgPSB0aGlzLnBsYWNlaG9sZGVyLAoJCQlzcGFuID0gJCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgKTsKCgkJdGhpcy5idXR0b24uY2hpbGRyZW4oICJzcGFuIiApLm5vdCggIi51aS1saS1jb3VudCIgKS5yZW1vdmUoKS5lbmQoKS5lbmQoKS5wcmVwZW5kKCAoZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZWN0ZWQubGVuZ3RoICkgewoJCQkJdGV4dCA9IHNlbGVjdGVkLm1hcChmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gJCggdGhpcyApLnRleHQoKTsKCQkJCX0pLmdldCgpLmpvaW4oICIsICIgKTsKCQkJfSBlbHNlIHsKCQkJCXRleHQgPSBzZWxmLnBsYWNlaG9sZGVyOwoJCQl9CgoJCQlpZiAoIHRleHQgKSB7CgkJCQlzcGFuLnRleHQoIHRleHQgKTsKCQkJfSBlbHNlIHsKCQkJCXNwYW4uaHRtbCggIiZuYnNwOyIgKTsKCQkJfQoKCQkJLy8gVE9ETyBwb3NzaWJseSBhZ2dyZWdhdGUgbXVsdGlwbGUgc2VsZWN0IG9wdGlvbiBjbGFzc2VzCgkJCXJldHVybiBzcGFuCgkJCQkuYWRkQ2xhc3MoIHNlbGYuc2VsZWN0LmF0dHIoICJjbGFzcyIgKSApCgkJCQkuYWRkQ2xhc3MoIHNlbGVjdGVkLmF0dHIoICJjbGFzcyIgKSApCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0pKCkpOwoJfSwKCglzZXRCdXR0b25Db3VudDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpOwoKCQkvLyBtdWx0aXBsZSBjb3VudCBpbnNpZGUgYnV0dG9uCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnRbIHNlbGVjdGVkLmxlbmd0aCA+IDEgPyAic2hvdyIgOiAiaGlkZSIgXSgpLnRleHQoIHNlbGVjdGVkLmxlbmd0aCApOwoJCX0KCX0sCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgkJdGhpcy5zZXRCdXR0b25Db3VudCgpOwoJfSwKCgkvLyBvcGVuIGFuZCBjbG9zZSBwcmVzZXJ2ZWQgaW4gbmF0aXZlIHNlbGVjdHMKCS8vIHRvIHNpbXBsaWZ5IHVzZXJzIGNvZGUgd2hlbiBsb29waW5nIG92ZXIgc2VsZWN0cwoJb3BlbjogJC5ub29wLAoJY2xvc2U6ICQubm9vcCwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXREaXNhYmxlZCggdHJ1ZSApOwoJCXRoaXMuYnV0dG9uLmFkZENsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmxpbmtzID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCgkvL2xpbmtzIHdpdGhpbiBjb250ZW50IGFyZWFzLCB0ZXN0cyBpbmNsdWRlZCB3aXRoIHBhZ2UKCSQoIHRhcmdldCApCgkJLmZpbmQoICJhIiApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkuZmlsdGVyKCAiOmpxbURhdGEocmVsPSdwb3B1cCcpW2hyZWZdW2hyZWYhPScnXSIgKQoJCS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJLy8gQWNjZXNzaWJpbGl0eSBpbmZvIGZvciBwb3B1cHMKCQkJdmFyIGUgPSB0aGlzLAoJCQkJaHJlZiA9ICQoIHRoaXMgKS5hdHRyKCAiaHJlZiIgKSwKCQkJCXNlbCA9ICQubW9iaWxlLnBhdGguaGFzaFRvU2VsZWN0b3IoIGhyZWYgKSwKCQkJCWlkcmVmID0gaHJlZi5zdWJzdHJpbmcoIDEgKTsKCgkJCWUuc2V0QXR0cmlidXRlKCAiYXJpYS1oYXNwb3B1cCIsIHRydWUgKTsKCQkJZS5zZXRBdHRyaWJ1dGUoICJhcmlhLW93bnMiLCBpZHJlZiApOwoJCQllLnNldEF0dHJpYnV0ZSggImFyaWEtZXhwYW5kZWQiLCBmYWxzZSApOwoJCQkkKCBkb2N1bWVudCApCgkJCQkub24oICJwb3B1cGFmdGVyb3BlbiIsIHNlbCwgZnVuY3Rpb24oKSB7CgkJCQkJZS5zZXRBdHRyaWJ1dGUoICJhcmlhLWV4cGFuZGVkIiwgdHJ1ZSApOwoJCQkJfSkKCQkJCS5vbiggInBvcHVwYWZ0ZXJjbG9zZSIsIHNlbCwgZnVuY3Rpb24oKSB7CgkJCQkJZS5zZXRBdHRyaWJ1dGUoICJhcmlhLWV4cGFuZGVkIiwgZmFsc2UgKTsKCQkJCX0pOwoJCX0pCgkJLmVuZCgpCgkJLm5vdCggIi51aS1idG4sIDpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIiApCgkJLmFkZENsYXNzKCAidWktbGluayIgKTsKCn07Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgpmdW5jdGlvbiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggd2luZG93U2l6ZSwgc2VnbWVudFNpemUsIG9mZnNldCwgZGVzaXJlZCApIHsKCXZhciByZXR1cm5WYWx1ZSA9IGRlc2lyZWQ7CgoJaWYgKCB3aW5kb3dTaXplIDwgc2VnbWVudFNpemUgKSB7CgkJLy8gQ2VudGVyIHNlZ21lbnQgaWYgaXQncyBiaWdnZXIgdGhhbiB0aGUgd2luZG93CgkJcmV0dXJuVmFsdWUgPSBvZmZzZXQgKyAoIHdpbmRvd1NpemUgLSBzZWdtZW50U2l6ZSApIC8gMjsKCX0gZWxzZSB7CgkJLy8gT3RoZXJ3aXNlIGNlbnRlciBpdCBhdCB0aGUgZGVzaXJlZCBjb29yZGluYXRlIHdoaWxlIGtlZXBpbmcgaXQgY29tcGxldGVseSBpbnNpZGUgdGhlIHdpbmRvdwoJCXJldHVyblZhbHVlID0gTWF0aC5taW4oIE1hdGgubWF4KCBvZmZzZXQsIGRlc2lyZWQgLSBzZWdtZW50U2l6ZSAvIDIgKSwgb2Zmc2V0ICsgd2luZG93U2l6ZSAtIHNlZ21lbnRTaXplICk7Cgl9CgoJcmV0dXJuIHJldHVyblZhbHVlOwp9CgpmdW5jdGlvbiBnZXRXaW5kb3dDb29yZGluYXRlcygpIHsKCXZhciB0aGVXaW5kb3cgPSAkLm1vYmlsZS53aW5kb3c7CgoJcmV0dXJuIHsKCQl4OiB0aGVXaW5kb3cuc2Nyb2xsTGVmdCgpLAoJCXk6IHRoZVdpbmRvdy5zY3JvbGxUb3AoKSwKCQljeDogKCB3aW5kb3cuaW5uZXJXaWR0aCB8fCB0aGVXaW5kb3cud2lkdGgoKSApLAoJCWN5OiAoIHdpbmRvdy5pbm5lckhlaWdodCB8fCB0aGVXaW5kb3cuaGVpZ2h0KCkgKQoJfTsKfQoKJC53aWRnZXQoICJtb2JpbGUucG9wdXAiLCB7CglvcHRpb25zOiB7CgkJd3JhcHBlckNsYXNzOiBudWxsLAoJCXRoZW1lOiBudWxsLAoJCW92ZXJsYXlUaGVtZTogbnVsbCwKCQlzaGFkb3c6IHRydWUsCgkJY29ybmVyczogdHJ1ZSwKCQl0cmFuc2l0aW9uOiAibm9uZSIsCgkJcG9zaXRpb25UbzogIm9yaWdpbiIsCgkJdG9sZXJhbmNlOiBudWxsLAoJCWNsb3NlTGlua1NlbGVjdG9yOiAiYTpqcW1EYXRhKHJlbD0nYmFjaycpIiwKCQljbG9zZUxpbmtFdmVudHM6ICJjbGljay5wb3B1cCIsCgkJbmF2aWdhdGVFdmVudHM6ICJuYXZpZ2F0ZS5wb3B1cCIsCgkJY2xvc2VFdmVudHM6ICJuYXZpZ2F0ZS5wb3B1cCBwYWdlYmVmb3JlY2hhbmdlLnBvcHVwIiwKCQlkaXNtaXNzaWJsZTogdHJ1ZSwKCQllbmhhbmNlZDogZmFsc2UsCgoJCS8vIE5PVEUgV2luZG93cyBQaG9uZSA3IGhhcyBhIHNjcm9sbCBwb3NpdGlvbiBjYWNoaW5nIGlzc3VlIHRoYXQKCQkvLyAgICAgIHJlcXVpcmVzIHVzIHRvIGRpc2FibGUgcG9wdXAgaGlzdG9yeSBtYW5hZ2VtZW50IGJ5IGRlZmF1bHQKCQkvLyAgICAgIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDc4NAoJCS8vCgkJLy8gTk9URSB0aGlzIG9wdGlvbiBpcyBtb2RpZmllZCBpbiBfY3JlYXRlIQoJCWhpc3Rvcnk6ICEkLm1vYmlsZS5icm93c2VyLm9sZElFCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGVFbGVtZW50ID0gdGhpcy5lbGVtZW50LAoJCQlteUlkID0gdGhlRWxlbWVudC5hdHRyKCAiaWQiICksCgkJCWN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQkvLyBXZSBuZWVkIHRvIGFkanVzdCB0aGUgaGlzdG9yeSBvcHRpb24gdG8gYmUgZmFsc2UgaWYgdGhlcmUncyBubyBBSkFYIG5hdi4KCQkvLyBXZSBjYW4ndCBkbyBpdCBpbiB0aGUgb3B0aW9uIGRlY2xhcmF0aW9ucyBiZWNhdXNlIHRob3NlIGFyZSBydW4gYmVmb3JlCgkJLy8gaXQgaXMgZGV0ZXJtaW5lZCB3aGV0aGVyIHRoZXJlIHNoYWxsIGJlIEFKQVggbmF2LgoJCWN1cnJlbnRPcHRpb25zLmhpc3RvcnkgPSBjdXJyZW50T3B0aW9ucy5oaXN0b3J5ICYmICQubW9iaWxlLmFqYXhFbmFibGVkICYmICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkOwoKCQkvLyBEZWZpbmUgaW5zdGFuY2UgdmFyaWFibGVzCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3Njcm9sbFRvcDogMCwKCQkJX3BhZ2U6IHRoZUVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLAoJCQlfdWk6IG51bGwsCgkJCV9mYWxsYmFja1RyYW5zaXRpb246ICIiLAoJCQlfY3VycmVudFRyYW5zaXRpb246IGZhbHNlLAoJCQlfcHJlcmVxdWlzaXRlczogbnVsbCwKCQkJX2lzT3BlbjogZmFsc2UsCgkJCV90b2xlcmFuY2U6IG51bGwsCgkJCV9yZXNpemVEYXRhOiBudWxsLAoJCQlfaWdub3JlUmVzaXplVG86IDAsCgkJCV9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3M6IGZhbHNlCgkJfSk7CgoJCWlmICggdGhpcy5fcGFnZS5sZW5ndGggPT09IDAgKSB7CgkJCXRoaXMuX3BhZ2UgPSAkKCAiYm9keSIgKTsKCQl9CgoJCWlmICggY3VycmVudE9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX3VpID0gewoJCQkJY29udGFpbmVyOiB0aGVFbGVtZW50LnBhcmVudCgpLAoJCQkJc2NyZWVuOiB0aGVFbGVtZW50LnBhcmVudCgpLnByZXYoKSwKCQkJCXBsYWNlaG9sZGVyOiAkKCB0aGlzLmRvY3VtZW50WyAwIF0uZ2V0RWxlbWVudEJ5SWQoIG15SWQgKyAiLXBsYWNlaG9sZGVyIiApICkKCQkJfTsKCQl9IGVsc2UgewoJCQl0aGlzLl91aSA9IHRoaXMuX2VuaGFuY2UoIHRoZUVsZW1lbnQsIG15SWQgKTsKCQkJdGhpcwoJCQkJLl9hcHBseVRyYW5zaXRpb24oIGN1cnJlbnRPcHRpb25zLnRyYW5zaXRpb24gKQoJCQkJLl9zZXRUb2xlcmFuY2UoIGN1cnJlbnRPcHRpb25zLnRvbGVyYW5jZSApOwoJCX0KCQl0aGlzLl91aS5mb2N1c0VsZW1lbnQgPSB0aGlzLl91aS5jb250YWluZXI7CgoJCS8vIEV2ZW50IGhhbmRsZXJzCgkJdGhpcy5fb24oIHRoaXMuX3VpLnNjcmVlbiwgeyAidmNsaWNrIjogIl9lYXRFdmVudEFuZENsb3NlIiB9ICk7CgkJdGhpcy5fb24oICQubW9iaWxlLndpbmRvdywgewoJCQlvcmllbnRhdGlvbmNoYW5nZTogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dPcmllbnRhdGlvbmNoYW5nZSIgKSwKCQkJcmVzaXplOiAkLnByb3h5KCB0aGlzLCAiX2hhbmRsZVdpbmRvd1Jlc2l6ZSIgKSwKCQkJa2V5dXA6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93S2V5VXAiICkKCQl9KTsKCQl0aGlzLl9vbiggJC5tb2JpbGUuZG9jdW1lbnQsIHsgImZvY3VzaW4iOiAiX2hhbmRsZURvY3VtZW50Rm9jdXNJbiIgfSApOwoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24oIHRoZUVsZW1lbnQsIG15SWQgKSB7CgkJdmFyIGN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQl3cmFwcGVyQ2xhc3MgPSBjdXJyZW50T3B0aW9ucy53cmFwcGVyQ2xhc3MsCgkJCXVpID0gewoJCQkJc2NyZWVuOiAkKCAiPGRpdiBjbGFzcz0ndWktc2NyZWVuLWhpZGRlbiB1aS1wb3B1cC1zY3JlZW4gIiArCgkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLW92ZXJsYXktIiwgY3VycmVudE9wdGlvbnMub3ZlcmxheVRoZW1lICkgKyAiJz48L2Rpdj4iICksCgkJCQlwbGFjZWhvbGRlcjogJCggIjxkaXYgc3R5bGU9J2Rpc3BsYXk6IG5vbmU7Jz48IS0tIHBsYWNlaG9sZGVyIC0tPjwvZGl2PiIgKSwKCQkJCWNvbnRhaW5lcjogJCggIjxkaXYgY2xhc3M9J3VpLXBvcHVwLWNvbnRhaW5lciB1aS1wb3B1cC1oaWRkZW4gdWktcG9wdXAtdHJ1bmNhdGUiICsKCQkJCQkoIHdyYXBwZXJDbGFzcyA/ICggIiAiICsgd3JhcHBlckNsYXNzICkgOiAiIiApICsgIic+PC9kaXY+IiApCgkJCX0sCgkJCWZyYWdtZW50ID0gdGhpcy5kb2N1bWVudFsgMCBdLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKCgkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIHVpLnNjcmVlblsgMCBdICk7CgkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIHVpLmNvbnRhaW5lclsgMCBdICk7CgoJCWlmICggbXlJZCApIHsKCQkJdWkuc2NyZWVuLmF0dHIoICJpZCIsIG15SWQgKyAiLXNjcmVlbiIgKTsKCQkJdWkuY29udGFpbmVyLmF0dHIoICJpZCIsIG15SWQgKyAiLXBvcHVwIiApOwoJCQl1aS5wbGFjZWhvbGRlcgoJCQkJLmF0dHIoICJpZCIsIG15SWQgKyAiLXBsYWNlaG9sZGVyIiApCgkJCQkuaHRtbCggIjwhLS0gcGxhY2Vob2xkZXIgZm9yICIgKyBteUlkICsgIiAtLT4iICk7CgkJfQoKCQkvLyBBcHBseSB0aGUgcHJvdG8KCQl0aGlzLl9wYWdlWyAwIF0uYXBwZW5kQ2hpbGQoIGZyYWdtZW50ICk7CgkJLy8gTGVhdmUgYSBwbGFjZWhvbGRlciB3aGVyZSB0aGUgZWxlbWVudCB1c2VkIHRvIGJlCgkJdWkucGxhY2Vob2xkZXIuaW5zZXJ0QWZ0ZXIoIHRoZUVsZW1lbnQgKTsKCQl0aGVFbGVtZW50CgkJCS5kZXRhY2goKQoJCQkuYWRkQ2xhc3MoICJ1aS1wb3B1cCAiICsKCQkJCXRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBjdXJyZW50T3B0aW9ucy50aGVtZSApICsgIiAiICsKCQkJCSggY3VycmVudE9wdGlvbnMuc2hhZG93ID8gInVpLW92ZXJsYXktc2hhZG93ICIgOiAiIiApICsKCQkJCSggY3VycmVudE9wdGlvbnMuY29ybmVycyA/ICJ1aS1jb3JuZXItYWxsICIgOiAiIiApICkKCQkJLmFwcGVuZFRvKCB1aS5jb250YWluZXIgKTsKCgkJcmV0dXJuIHVpOwoJfSwKCglfZWF0RXZlbnRBbmRDbG9zZTogZnVuY3Rpb24oIHRoZUV2ZW50ICkgewoJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJdGhlRXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzbWlzc2libGUgKSB7CgkJCXRoaXMuY2xvc2UoKTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCgkvLyBNYWtlIHN1cmUgdGhlIHNjcmVlbiBzaXplIGlzIGluY3JlYXNlZCBiZXlvbmQgdGhlIHBhZ2UgaGVpZ2h0IGlmIHRoZSBwb3B1cCdzIGNhdXNlcyB0aGUgZG9jdW1lbnQgdG8gaW5jcmVhc2UgaW4gaGVpZ2h0CglfcmVzaXplU2NyZWVuOiBmdW5jdGlvbigpIHsKCQl2YXIgcG9wdXBIZWlnaHQgPSB0aGlzLl91aS5jb250YWluZXIub3V0ZXJIZWlnaHQoIHRydWUgKTsKCgkJdGhpcy5fdWkuc2NyZWVuLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCQlpZiAoIHBvcHVwSGVpZ2h0ID4gdGhpcy5fdWkuc2NyZWVuLmhlaWdodCgpICkgewoJCQl0aGlzLl91aS5zY3JlZW4uaGVpZ2h0KCBwb3B1cEhlaWdodCApOwoJCX0KCX0sCgoJX2hhbmRsZVdpbmRvd0tleVVwOiBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gJiYgdGhlRXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5FU0NBUEUgKSB7CgkJCXJldHVybiB0aGlzLl9lYXRFdmVudEFuZENsb3NlKCB0aGVFdmVudCApOwoJCX0KCX0sCgoJX2V4cGVjdFJlc2l6ZUV2ZW50OiBmdW5jdGlvbigpIHsKCQl2YXIgd2luZG93Q29vcmRpbmF0ZXMgPSBnZXRXaW5kb3dDb29yZGluYXRlcygpOwoKCQlpZiAoIHRoaXMuX3Jlc2l6ZURhdGEgKSB7CgkJCWlmICggd2luZG93Q29vcmRpbmF0ZXMueCA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5kb3dDb29yZGluYXRlcy54ICYmCgkJCQl3aW5kb3dDb29yZGluYXRlcy55ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbmRvd0Nvb3JkaW5hdGVzLnkgJiYKCQkJCXdpbmRvd0Nvb3JkaW5hdGVzLmN4ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbmRvd0Nvb3JkaW5hdGVzLmN4ICYmCgkJCQl3aW5kb3dDb29yZGluYXRlcy5jeSA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5kb3dDb29yZGluYXRlcy5jeSApIHsKCQkJCS8vIHRpbWVvdXQgbm90IHJlZnJlc2hlZAoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9IGVsc2UgewoJCQkJLy8gY2xlYXIgZXhpc3RpbmcgdGltZW91dCAtIGl0IHdpbGwgYmUgcmVmcmVzaGVkIGJlbG93CgkJCQljbGVhclRpbWVvdXQoIHRoaXMuX3Jlc2l6ZURhdGEudGltZW91dElkICk7CgkJCX0KCQl9CgoJCXRoaXMuX3Jlc2l6ZURhdGEgPSB7CgkJCXRpbWVvdXRJZDogdGhpcy5fZGVsYXkoICJfcmVzaXplVGltZW91dCIsIDIwMCApLAoJCQl3aW5kb3dDb29yZGluYXRlczogd2luZG93Q29vcmRpbmF0ZXMKCQl9OwoKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJX3Jlc2l6ZVRpbWVvdXQ6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQlpZiAoICF0aGlzLl9leHBlY3RSZXNpemVFdmVudCgpICkgewoJCQkJaWYgKCB0aGlzLl91aS5jb250YWluZXIuaGFzQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICkgKSB7CgkJCQkJLy8gZWZmZWN0aXZlbHkgcmFwaWQtb3BlbiB0aGUgcG9wdXAgd2hpbGUgbGVhdmluZyB0aGUgc2NyZWVuIGludGFjdAoJCQkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLWhpZGRlbiB1aS1wb3B1cC10cnVuY2F0ZSIgKTsKCQkJCQl0aGlzLnJlcG9zaXRpb24oIHsgcG9zaXRpb25UbzogIndpbmRvdyIgfSApOwoJCQkJCXRoaXMuX2lnbm9yZVJlc2l6ZUV2ZW50cygpOwoJCQkJfQoKCQkJCXRoaXMuX3Jlc2l6ZVNjcmVlbigpOwoJCQkJdGhpcy5fcmVzaXplRGF0YSA9IG51bGw7CgkJCQl0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgPSBmYWxzZTsKCQkJfQoJCX0gZWxzZSB7CgkJCXRoaXMuX3Jlc2l6ZURhdGEgPSBudWxsOwoJCQl0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgPSBmYWxzZTsKCQl9Cgl9LAoKCV9zdG9wSWdub3JpbmdSZXNpemVFdmVudHM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2lnbm9yZVJlc2l6ZVRvID0gMDsKCX0sCgoJX2lnbm9yZVJlc2l6ZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLl9pZ25vcmVSZXNpemVUbyApIHsKCQkJY2xlYXJUaW1lb3V0KCB0aGlzLl9pZ25vcmVSZXNpemVUbyApOwoJCX0KCQl0aGlzLl9pZ25vcmVSZXNpemVUbyA9IHRoaXMuX2RlbGF5KCAiX3N0b3BJZ25vcmluZ1Jlc2l6ZUV2ZW50cyIsIDEwMDAgKTsKCX0sCgoJX2hhbmRsZVdpbmRvd1Jlc2l6ZTogZnVuY3Rpb24oLyogdGhlRXZlbnQgKi8pIHsKCQlpZiAoIHRoaXMuX2lzT3BlbiAmJiB0aGlzLl9pZ25vcmVSZXNpemVUbyA9PT0gMCApIHsKCQkJaWYgKCAoIHRoaXMuX2V4cGVjdFJlc2l6ZUV2ZW50KCkgfHwgdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzICkgJiYKCQkJCSF0aGlzLl91aS5jb250YWluZXIuaGFzQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICkgKSB7CgkJCQkvLyBlZmZlY3RpdmVseSByYXBpZC1jbG9zZSB0aGUgcG9wdXAgd2hpbGUgbGVhdmluZyB0aGUgc2NyZWVuIGludGFjdAoJCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkJLmFkZENsYXNzKCAidWktcG9wdXAtaGlkZGVuIHVpLXBvcHVwLXRydW5jYXRlIiApCgkJCQkJLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCQkJfQoJCX0KCX0sCgoJX2hhbmRsZVdpbmRvd09yaWVudGF0aW9uY2hhbmdlOiBmdW5jdGlvbigvKiB0aGVFdmVudCAqLykgewoJCWlmICggIXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyAmJiB0aGlzLl9pc09wZW4gJiYgdGhpcy5faWdub3JlUmVzaXplVG8gPT09IDAgKSB7CgkJCXRoaXMuX2V4cGVjdFJlc2l6ZUV2ZW50KCk7CgkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IHRydWU7CgkJfQoJfSwKCgkvLyBXaGVuIHRoZSBwb3B1cCBpcyBvcGVuLCBhdHRlbXB0aW5nIHRvIGZvY3VzIG9uIGFuIGVsZW1lbnQgdGhhdCBpcyBub3QgYQoJLy8gY2hpbGQgb2YgdGhlIHBvcHVwIHdpbGwgcmVkaXJlY3QgZm9jdXMgdG8gdGhlIHBvcHVwCglfaGFuZGxlRG9jdW1lbnRGb2N1c0luOiBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJdmFyIHRhcmdldCwKCQkJdGFyZ2V0RWxlbWVudCA9IHRoZUV2ZW50LnRhcmdldCwKCQkJdWkgPSB0aGlzLl91aTsKCgkJaWYgKCAhdGhpcy5faXNPcGVuICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHRhcmdldEVsZW1lbnQgIT09IHVpLmNvbnRhaW5lclsgMCBdICkgewoJCQl0YXJnZXQgPSAkKCB0YXJnZXRFbGVtZW50ICk7CgkJCWlmICggMCA9PT0gdGFyZ2V0LnBhcmVudHMoKS5maWx0ZXIoIHVpLmNvbnRhaW5lclsgMCBdICkubGVuZ3RoICkgewoJCQkJJCggdGhpcy5kb2N1bWVudFsgMCBdLmFjdGl2ZUVsZW1lbnQgKS5vbmUoICJmb2N1cyIsIGZ1bmN0aW9uKC8qIHRoZUV2ZW50ICovKSB7CgkJCQkJdGFyZ2V0LmJsdXIoKTsKCQkJCX0pOwoJCQkJdWkuZm9jdXNFbGVtZW50LmZvY3VzKCk7CgkJCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJdGhlRXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gZWxzZSBpZiAoIHVpLmZvY3VzRWxlbWVudFsgMCBdID09PSB1aS5jb250YWluZXJbIDAgXSApIHsKCQkJCXVpLmZvY3VzRWxlbWVudCA9IHRhcmdldDsKCQkJfQoJCX0KCgkJdGhpcy5faWdub3JlUmVzaXplRXZlbnRzKCk7Cgl9LAoKCV90aGVtZUNsYXNzRnJvbU9wdGlvbjogZnVuY3Rpb24oIHByZWZpeCwgdmFsdWUgKSB7CgkJcmV0dXJuICggdmFsdWUgPyAoIHZhbHVlID09PSAibm9uZSIgPyAiIiA6ICggcHJlZml4ICsgdmFsdWUgKSApIDogKCBwcmVmaXggKyAiaW5oZXJpdCIgKSApOwoJfSwKCglfYXBwbHlUcmFuc2l0aW9uOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJaWYgKCB2YWx1ZSApIHsKCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gKTsKCQkJaWYgKCB2YWx1ZSAhPT0gIm5vbmUiICkgewoJCQkJdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24oIHZhbHVlICk7CgkJCQlpZiAoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiA9PT0gIm5vbmUiICkgewoJCQkJCXRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiA9ICIiOwoJCQkJfQoJCQkJdGhpcy5fdWkuY29udGFpbmVyLmFkZENsYXNzKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggbmV3T3B0aW9ucyApIHsKCQl2YXIgY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCXRoZUVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsCgkJCXNjcmVlbiA9IHRoaXMuX3VpLnNjcmVlbjsKCgkJaWYgKCBuZXdPcHRpb25zLndyYXBwZXJDbGFzcyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCS5yZW1vdmVDbGFzcyggY3VycmVudE9wdGlvbnMud3JhcHBlckNsYXNzICkKCQkJCS5hZGRDbGFzcyggbmV3T3B0aW9ucy53cmFwcGVyQ2xhc3MgKTsKCQl9CgoJCWlmICggbmV3T3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGVFbGVtZW50CgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBjdXJyZW50T3B0aW9ucy50aGVtZSApICkKCQkJCS5hZGRDbGFzcyggdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG5ld09wdGlvbnMudGhlbWUgKSApOwoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLm92ZXJsYXlUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlzY3JlZW4KCQkJCS5yZW1vdmVDbGFzcyggdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1vdmVybGF5LSIsIGN1cnJlbnRPcHRpb25zLm92ZXJsYXlUaGVtZSApICkKCQkJCS5hZGRDbGFzcyggdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1vdmVybGF5LSIsIG5ld09wdGlvbnMub3ZlcmxheVRoZW1lICkgKTsKCgkJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQkJc2NyZWVuLmFkZENsYXNzKCAiaW4iICk7CgkJCX0KCQl9CgoJCWlmICggbmV3T3B0aW9ucy5zaGFkb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhlRWxlbWVudC50b2dnbGVDbGFzcyggInVpLW92ZXJsYXktc2hhZG93IiwgbmV3T3B0aW9ucy5zaGFkb3cgKTsKCQl9CgoJCWlmICggbmV3T3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoZUVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgbmV3T3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMudHJhbnNpdGlvbiAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoICF0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiApIHsKCQkJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggbmV3T3B0aW9ucy50cmFuc2l0aW9uICk7CgkJCX0KCQl9CgoJCWlmICggbmV3T3B0aW9ucy50b2xlcmFuY2UgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0VG9sZXJhbmNlKCBuZXdPcHRpb25zLnRvbGVyYW5jZSApOwoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggbmV3T3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCXRoaXMuY2xvc2UoKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX3N1cGVyKCBuZXdPcHRpb25zICk7Cgl9LAoKCV9zZXRUb2xlcmFuY2U6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YXIgdG9sID0geyB0OiAzMCwgcjogMTUsIGI6IDMwLCBsOiAxNSB9LAoJCQlhcjsKCgkJaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQlhciA9IFN0cmluZyggdmFsdWUgKS5zcGxpdCggIiwiICk7CgoJCQkkLmVhY2goIGFyLCBmdW5jdGlvbiggaWR4LCB2YWwgKSB7IGFyWyBpZHggXSA9IHBhcnNlSW50KCB2YWwsIDEwICk7IH0gKTsKCgkJCXN3aXRjaCggYXIubGVuZ3RoICkgewoJCQkJLy8gQWxsIHZhbHVlcyBhcmUgdG8gYmUgdGhlIHNhbWUKCQkJCWNhc2UgMToKCQkJCQlpZiAoICFpc05hTiggYXJbIDAgXSApICkgewoJCQkJCQl0b2wudCA9IHRvbC5yID0gdG9sLmIgPSB0b2wubCA9IGFyWyAwIF07CgkJCQkJfQoJCQkJCWJyZWFrOwoKCQkJCS8vIFRoZSBmaXJzdCB2YWx1ZSBkZW5vdGVzIHRvcC9ib3R0b20gdG9sZXJhbmNlLCBhbmQgdGhlIHNlY29uZCB2YWx1ZSBkZW5vdGVzIGxlZnQvcmlnaHQgdG9sZXJhbmNlCgkJCQljYXNlIDI6CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAwIF0gKSApIHsKCQkJCQkJdG9sLnQgPSB0b2wuYiA9IGFyWyAwIF07CgkJCQkJfQoJCQkJCWlmICggIWlzTmFOKCBhclsgMSBdICkgKSB7CgkJCQkJCXRvbC5sID0gdG9sLnIgPSBhclsgMSBdOwoJCQkJCX0KCQkJCQlicmVhazsKCgkJCQkvLyBUaGUgYXJyYXkgY29udGFpbnMgdmFsdWVzIGluIHRoZSBvcmRlciB0b3AsIHJpZ2h0LCBib3R0b20sIGxlZnQKCQkJCWNhc2UgNDoKCQkJCQlpZiAoICFpc05hTiggYXJbIDAgXSApICkgewoJCQkJCQl0b2wudCA9IGFyWyAwIF07CgkJCQkJfQoJCQkJCWlmICggIWlzTmFOKCBhclsgMSBdICkgKSB7CgkJCQkJCXRvbC5yID0gYXJbIDEgXTsKCQkJCQl9CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAyIF0gKSApIHsKCQkJCQkJdG9sLmIgPSBhclsgMiBdOwoJCQkJCX0KCQkJCQlpZiAoICFpc05hTiggYXJbIDMgXSApICkgewoJCQkJCQl0b2wubCA9IGFyWyAzIF07CgkJCQkJfQoJCQkJCWJyZWFrOwoKCQkJCWRlZmF1bHQ6CgkJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCXRoaXMuX3RvbGVyYW5jZSA9IHRvbDsKCQlyZXR1cm4gdGhpczsKCX0sCgoJX2NsYW1wUG9wdXBXaWR0aDogZnVuY3Rpb24oIGluZm9Pbmx5ICkgewoJCXZhciBtZW51U2l6ZSwKCQkJd2luZG93Q29vcmRpbmF0ZXMgPSBnZXRXaW5kb3dDb29yZGluYXRlcygpLAoJCQkvLyByZWN0YW5nbGUgd2l0aGluIHdoaWNoIHRoZSBwb3B1cCBtdXN0IGZpdAoJCQlyZWN0YW5nbGUgPSB7CgkJCQl4OiB0aGlzLl90b2xlcmFuY2UubCwKCQkJCXk6IHdpbmRvd0Nvb3JkaW5hdGVzLnkgKyB0aGlzLl90b2xlcmFuY2UudCwKCQkJCWN4OiB3aW5kb3dDb29yZGluYXRlcy5jeCAtIHRoaXMuX3RvbGVyYW5jZS5sIC0gdGhpcy5fdG9sZXJhbmNlLnIsCgkJCQljeTogd2luZG93Q29vcmRpbmF0ZXMuY3kgLSB0aGlzLl90b2xlcmFuY2UudCAtIHRoaXMuX3RvbGVyYW5jZS5iCgkJCX07CgoJCWlmICggIWluZm9Pbmx5ICkgewoJCQkvLyBDbGFtcCB0aGUgd2lkdGggb2YgdGhlIG1lbnUgYmVmb3JlIGdyYWJiaW5nIGl0cyBzaXplCgkJCXRoaXMuX3VpLmNvbnRhaW5lci5jc3MoICJtYXgtd2lkdGgiLCByZWN0YW5nbGUuY3ggKTsKCQl9CgoJCW1lbnVTaXplID0gewoJCQljeDogdGhpcy5fdWkuY29udGFpbmVyLm91dGVyV2lkdGgoIHRydWUgKSwKCQkJY3k6IHRoaXMuX3VpLmNvbnRhaW5lci5vdXRlckhlaWdodCggdHJ1ZSApCgkJfTsKCgkJcmV0dXJuIHsgcmM6IHJlY3RhbmdsZSwgbWVudVNpemU6IG1lbnVTaXplIH07Cgl9LAoKCV9jYWxjdWxhdGVGaW5hbExvY2F0aW9uOiBmdW5jdGlvbiggZGVzaXJlZCwgY2xhbXBJbmZvICkgewoJCXZhciByZXR1cm5WYWx1ZSwKCQkJcmVjdGFuZ2xlID0gY2xhbXBJbmZvLnJjLAoJCQltZW51U2l6ZSA9IGNsYW1wSW5mby5tZW51U2l6ZTsKCgoJCS8vIENlbnRlciB0aGUgbWVudSBvdmVyIHRoZSBkZXNpcmVkIGNvb3JkaW5hdGVzLCB3aGlsZSBub3QgZ29pbmcgb3V0c2lkZQoJCS8vIHRoZSB3aW5kb3cgdG9sZXJhbmNlcy4gVGhpcyB3aWxsIGNlbnRlciB3cnQuIHRoZSB3aW5kb3cgaWYgdGhlIHBvcHVwIGlzCgkJLy8gdG9vIGxhcmdlLgoJCXJldHVyblZhbHVlID0gewoJCQlsZWZ0OiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggcmVjdGFuZ2xlLmN4LCBtZW51U2l6ZS5jeCwgcmVjdGFuZ2xlLngsIGRlc2lyZWQueCApLAoJCQl0b3A6IGZpdFNlZ21lbnRJbnNpZGVTZWdtZW50KCByZWN0YW5nbGUuY3ksIG1lbnVTaXplLmN5LCByZWN0YW5nbGUueSwgZGVzaXJlZC55ICkKCQl9OwoKCQkvLyBNYWtlIHN1cmUgdGhlIHRvcCBvZiB0aGUgbWVudSBpcyB2aXNpYmxlCgkJcmV0dXJuVmFsdWUudG9wID0gTWF0aC5tYXgoIDAsIHJldHVyblZhbHVlLnRvcCApOwoKCQkvLyBJZiB0aGUgaGVpZ2h0IG9mIHRoZSBtZW51IGlzIHNtYWxsZXIgdGhhbiB0aGUgaGVpZ2h0IG9mIHRoZSBkb2N1bWVudAoJCS8vIGFsaWduIHRoZSBib3R0b20gd2l0aCB0aGUgYm90dG9tIG9mIHRoZSBkb2N1bWVudAoKCQlyZXR1cm5WYWx1ZS50b3AgLT0gTWF0aC5taW4oIHJldHVyblZhbHVlLnRvcCwKCQkJTWF0aC5tYXgoIDAsIHJldHVyblZhbHVlLnRvcCArIG1lbnVTaXplLmN5IC0gJC5tb2JpbGUuZG9jdW1lbnQuaGVpZ2h0KCkgKSApOwoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9LAoKCS8vIFRyeSBhbmQgY2VudGVyIHRoZSBvdmVybGF5IG92ZXIgdGhlIGdpdmVuIGNvb3JkaW5hdGVzCglfcGxhY2VtZW50Q29vcmRzOiBmdW5jdGlvbiggZGVzaXJlZCApIHsKCQlyZXR1cm4gdGhpcy5fY2FsY3VsYXRlRmluYWxMb2NhdGlvbiggZGVzaXJlZCwgdGhpcy5fY2xhbXBQb3B1cFdpZHRoKCkgKTsKCX0sCgoJX2NyZWF0ZVByZXJlcXVpc2l0ZXM6IGZ1bmN0aW9uKCBzY3JlZW5QcmVyZXF1aXNpdGUsIGNvbnRhaW5lclByZXJlcXVpc2l0ZSwgd2hlbkRvbmUgKSB7CgkJdmFyIHByZXJlcXVpc2l0ZXMsCgkJCXNlbGYgPSB0aGlzOwoKCQkvLyBJdCBpcyBpbXBvcnRhbnQgdG8gbWFpbnRhaW4gYm90aCB0aGUgbG9jYWwgdmFyaWFibGUgcHJlcmVxdWlzaXRlcyBhbmQKCQkvLyBzZWxmLl9wcmVyZXF1aXNpdGVzLiBUaGUgbG9jYWwgdmFyaWFibGUgcmVtYWlucyBpbiB0aGUgY2xvc3VyZSBvZiB0aGUKCQkvLyBmdW5jdGlvbnMgd2hpY2ggY2FsbCB0aGUgY2FsbGJhY2tzIHBhc3NlZCBpbi4gVGhlIGNvbXBhcmlzb24gYmV0d2VlbiB0aGUKCQkvLyBsb2NhbCB2YXJpYWJsZSBhbmQgc2VsZi5fcHJlcmVxdWlzaXRlcyBpcyBuZWNlc3NhcnksIGJlY2F1c2Ugb25jZSBhCgkJLy8gZnVuY3Rpb24gaGFzIGJlZW4gcGFzc2VkIHRvIC5hbmltYXRpb25Db21wbGV0ZSgpIGl0IHdpbGwgYmUgY2FsbGVkIG5leHQKCQkvLyB0aW1lIGFuIGFuaW1hdGlvbiBjb21wbGV0ZXMsIGV2ZW4gaWYgdGhhdCdzIG5vdCB0aGUgYW5pbWF0aW9uIHdob3NlIGVuZAoJCS8vIHRoZSBmdW5jdGlvbiB3YXMgc3VwcG9zZWQgdG8gY2F0Y2ggKGZvciBleGFtcGxlLCBpZiBhbiBhYm9ydCBoYXBwZW5zCgkJLy8gZHVyaW5nIHRoZSBvcGVuaW5nIGFuaW1hdGlvbiwgdGhlIC5hbmltYXRpb25Db21wbGV0ZSBoYW5kbGVyIGlzIG5vdAoJCS8vIGNhbGxlZCBmb3IgdGhhdCBhbmltYXRpb24gYW55bW9yZSwgYnV0IHRoZSBoYW5kbGVyIHJlbWFpbnMgYXR0YWNoZWQsIHNvCgkJLy8gaXQgaXMgY2FsbGVkIHRoZSBuZXh0IHRpbWUgdGhlIHBvcHVwIGlzIG9wZW5lZCAtIG1ha2luZyBpdCBzdGFsZS4KCQkvLyBDb21wYXJpbmcgdGhlIGxvY2FsIHZhcmlhYmxlIHByZXJlcXVpc2l0ZXMgdG8gdGhlIHdpZGdldC1sZXZlbCB2YXJpYWJsZQoJCS8vIHNlbGYuX3ByZXJlcXVpc2l0ZXMgZW5zdXJlcyB0aGF0IGNhbGxiYWNrcyB0cmlnZ2VyZWQgYnkgYSBzdGFsZQoJCS8vIC5hbmltYXRpb25Db21wbGV0ZSB3aWxsIGJlIGlnbm9yZWQuCgoJCXByZXJlcXVpc2l0ZXMgPSB7CgkJCXNjcmVlbjogJC5EZWZlcnJlZCgpLAoJCQljb250YWluZXI6ICQuRGVmZXJyZWQoKQoJCX07CgoJCXByZXJlcXVpc2l0ZXMuc2NyZWVuLnRoZW4oIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHByZXJlcXVpc2l0ZXMgPT09IHNlbGYuX3ByZXJlcXVpc2l0ZXMgKSB7CgkJCQlzY3JlZW5QcmVyZXF1aXNpdGUoKTsKCQkJfQoJCX0pOwoKCQlwcmVyZXF1aXNpdGVzLmNvbnRhaW5lci50aGVuKCBmdW5jdGlvbigpIHsKCQkJaWYgKCBwcmVyZXF1aXNpdGVzID09PSBzZWxmLl9wcmVyZXF1aXNpdGVzICkgewoJCQkJY29udGFpbmVyUHJlcmVxdWlzaXRlKCk7CgkJCX0KCQl9KTsKCgkJJC53aGVuKCBwcmVyZXF1aXNpdGVzLnNjcmVlbiwgcHJlcmVxdWlzaXRlcy5jb250YWluZXIgKS5kb25lKCBmdW5jdGlvbigpIHsKCQkJaWYgKCBwcmVyZXF1aXNpdGVzID09PSBzZWxmLl9wcmVyZXF1aXNpdGVzICkgewoJCQkJc2VsZi5fcHJlcmVxdWlzaXRlcyA9IG51bGw7CgkJCQl3aGVuRG9uZSgpOwoJCQl9CgkJfSk7CgoJCXNlbGYuX3ByZXJlcXVpc2l0ZXMgPSBwcmVyZXF1aXNpdGVzOwoJfSwKCglfYW5pbWF0ZTogZnVuY3Rpb24oIGFyZ3MgKSB7CgkJLy8gTk9URSBiZWZvcmUgcmVtb3ZpbmcgdGhlIGRlZmF1bHQgYW5pbWF0aW9uIG9mIHRoZSBzY3JlZW4KCQkvLyAgICAgIHRoaXMgaGFkIGFuIGFuaW1hdGUgY2FsbGJhY2sgdGhhdCB3b3VsZCByZXNvbHZlIHRoZSBkZWZlcnJlZAoJCS8vICAgICAgbm93IHRoZSBkZWZlcnJlZCBpcyByZXNvbHZlZCBpbW1lZGlhdGVseQoJCS8vIFRPRE8gcmVtb3ZlIHRoZSBkZXBlbmRlbmN5IG9uIHRoZSBzY3JlZW4gZGVmZXJyZWQKCQl0aGlzLl91aS5zY3JlZW4KCQkJLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKQoJCQkuYWRkQ2xhc3MoIGFyZ3Muc2NyZWVuQ2xhc3NUb0FkZCApOwoKCQlhcmdzLnByZXJlcXVpc2l0ZXMuc2NyZWVuLnJlc29sdmUoKTsKCgkJaWYgKCBhcmdzLnRyYW5zaXRpb24gJiYgYXJncy50cmFuc2l0aW9uICE9PSAibm9uZSIgKSB7CgkJCWlmICggYXJncy5hcHBseVRyYW5zaXRpb24gKSB7CgkJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIGFyZ3MudHJhbnNpdGlvbiApOwoJCQl9CgkJCWlmICggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICkgewoJCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKCAkLnByb3h5KCBhcmdzLnByZXJlcXVpc2l0ZXMuY29udGFpbmVyLCAicmVzb2x2ZSIgKSApCgkJCQkJLmFkZENsYXNzKCBhcmdzLmNvbnRhaW5lckNsYXNzVG9BZGQgKQoJCQkJCS5yZW1vdmVDbGFzcyggYXJncy5jbGFzc1RvUmVtb3ZlICk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKTsKCQlhcmdzLnByZXJlcXVpc2l0ZXMuY29udGFpbmVyLnJlc29sdmUoKTsKCX0sCgoJLy8gVGhlIGRlc2lyZWQgY29vcmRpbmF0ZXMgcGFzc2VkIGluIHdpbGwgYmUgcmV0dXJuZWQgdW50b3VjaGVkIGlmIG5vIHJlZmVyZW5jZSBlbGVtZW50IGNhbiBiZSBpZGVudGlmaWVkIHZpYQoJLy8gZGVzaXJlZFBvc2l0aW9uLnBvc2l0aW9uVG8uIE5ldmVydGhlbGVzcywgdGhpcyBmdW5jdGlvbiBlbnN1cmVzIHRoYXQgaXRzIHJldHVybiB2YWx1ZSBhbHdheXMgY29udGFpbnMgdmFsaWQKCS8vIHggYW5kIHkgY29vcmRpbmF0ZXMgYnkgc3BlY2lmeWluZyB0aGUgY2VudGVyIG1pZGRsZSBvZiB0aGUgd2luZG93IGlmIHRoZSBjb29yZGluYXRlcyBhcmUgYWJzZW50LgoJLy8gb3B0aW9uczogeyB4OiBjb29yZGluYXRlLCB5OiBjb29yZGluYXRlLCBwb3NpdGlvblRvOiBzdHJpbmc6ICJvcmlnaW4iLCAid2luZG93Iiwgb3IgalF1ZXJ5IHNlbGVjdG9yCglfZGVzaXJlZENvb3JkczogZnVuY3Rpb24oIG9wZW5PcHRpb25zICkgewoJCXZhciBvZmZzZXQsCgkJCWRzdCA9IG51bGwsCgkJCXdpbmRvd0Nvb3JkaW5hdGVzID0gZ2V0V2luZG93Q29vcmRpbmF0ZXMoKSwKCQkJeCA9IG9wZW5PcHRpb25zLngsCgkJCXkgPSBvcGVuT3B0aW9ucy55LAoJCQlwVG8gPSBvcGVuT3B0aW9ucy5wb3NpdGlvblRvOwoKCQkvLyBFc3RhYmxpc2ggd2hpY2ggZWxlbWVudCB3aWxsIHNlcnZlIGFzIHRoZSByZWZlcmVuY2UKCQlpZiAoIHBUbyAmJiBwVG8gIT09ICJvcmlnaW4iICkgewoJCQlpZiAoIHBUbyA9PT0gIndpbmRvdyIgKSB7CgkJCQl4ID0gd2luZG93Q29vcmRpbmF0ZXMuY3ggLyAyICsgd2luZG93Q29vcmRpbmF0ZXMueDsKCQkJCXkgPSB3aW5kb3dDb29yZGluYXRlcy5jeSAvIDIgKyB3aW5kb3dDb29yZGluYXRlcy55OwoJCQl9IGVsc2UgewoJCQkJdHJ5IHsKCQkJCQlkc3QgPSAkKCBwVG8gKTsKCQkJCX0gY2F0Y2goIGVyciApIHsKCQkJCQlkc3QgPSBudWxsOwoJCQkJfQoJCQkJaWYgKCBkc3QgKSB7CgkJCQkJZHN0LmZpbHRlciggIjp2aXNpYmxlIiApOwoJCQkJCWlmICggZHN0Lmxlbmd0aCA9PT0gMCApIHsKCQkJCQkJZHN0ID0gbnVsbDsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCS8vIElmIGFuIGVsZW1lbnQgd2FzIGZvdW5kLCBjZW50ZXIgb3ZlciBpdAoJCWlmICggZHN0ICkgewoJCQlvZmZzZXQgPSBkc3Qub2Zmc2V0KCk7CgkJCXggPSBvZmZzZXQubGVmdCArIGRzdC5vdXRlcldpZHRoKCkgLyAyOwoJCQl5ID0gb2Zmc2V0LnRvcCArIGRzdC5vdXRlckhlaWdodCgpIC8gMjsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB4IGFuZCB5IGFyZSB2YWxpZCBudW1iZXJzIC0gY2VudGVyIG92ZXIgdGhlIHdpbmRvdwoJCWlmICggJC50eXBlKCB4ICkgIT09ICJudW1iZXIiIHx8IGlzTmFOKCB4ICkgKSB7CgkJCXggPSB3aW5kb3dDb29yZGluYXRlcy5jeCAvIDIgKyB3aW5kb3dDb29yZGluYXRlcy54OwoJCX0KCQlpZiAoICQudHlwZSggeSApICE9PSAibnVtYmVyIiB8fCBpc05hTiggeSApICkgewoJCQl5ID0gd2luZG93Q29vcmRpbmF0ZXMuY3kgLyAyICsgd2luZG93Q29vcmRpbmF0ZXMueTsKCQl9CgoJCXJldHVybiB7IHg6IHgsIHk6IHkgfTsKCX0sCgoJX3JlcG9zaXRpb246IGZ1bmN0aW9uKCBvcGVuT3B0aW9ucyApIHsKCQkvLyBXZSBvbmx5IGNhcmUgYWJvdXQgcG9zaXRpb24tcmVsYXRlZCBwYXJhbWV0ZXJzIGZvciByZXBvc2l0aW9uaW5nCgkJb3Blbk9wdGlvbnMgPSB7CgkJCXg6IG9wZW5PcHRpb25zLngsCgkJCXk6IG9wZW5PcHRpb25zLnksCgkJCXBvc2l0aW9uVG86IG9wZW5PcHRpb25zLnBvc2l0aW9uVG8KCQl9OwoJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVwb3NpdGlvbiIsIHVuZGVmaW5lZCwgb3Blbk9wdGlvbnMgKTsKCQl0aGlzLl91aS5jb250YWluZXIub2Zmc2V0KCB0aGlzLl9wbGFjZW1lbnRDb29yZHMoIHRoaXMuX2Rlc2lyZWRDb29yZHMoIG9wZW5PcHRpb25zICkgKSApOwoJfSwKCglyZXBvc2l0aW9uOiBmdW5jdGlvbiggb3Blbk9wdGlvbnMgKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCXRoaXMuX3JlcG9zaXRpb24oIG9wZW5PcHRpb25zICk7CgkJfQoJfSwKCglfb3BlblByZXJlcXVpc2l0ZXNDb21wbGV0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fdWkuY29udGFpbmVyLmFkZENsYXNzKCAidWktcG9wdXAtYWN0aXZlIiApOwoJCXRoaXMuX2lzT3BlbiA9IHRydWU7CgkJdGhpcy5fcmVzaXplU2NyZWVuKCk7CgkJdGhpcy5fdWkuY29udGFpbmVyLmF0dHIoICJ0YWJpbmRleCIsICIwIiApLmZvY3VzKCk7CgkJdGhpcy5faWdub3JlUmVzaXplRXZlbnRzKCk7CgkJdGhpcy5fdHJpZ2dlciggImFmdGVyb3BlbiIgKTsKCX0sCgoJX29wZW46IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBvcGVuT3B0aW9ucyA9ICQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zLCBvcHRpb25zICksCgkJCS8vIFRPRE8gbW92ZSBibGFja2xpc3QgdG8gcHJpdmF0ZSBtZXRob2QKCQkJYW5kcm9pZEJsYWNrbGlzdCA9ICggZnVuY3Rpb24oKSB7CgkJCQl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCQkJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJCQkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XC5dKykvICksCgkJCQkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQkJCQlhbmRyb2lkbWF0Y2ggPSB1YS5tYXRjaCggL0FuZHJvaWQgKFxkKyg/OlwuXGQrKSkvICksCgkJCQkJYW5kdmVyc2lvbiA9ICEhYW5kcm9pZG1hdGNoICYmIGFuZHJvaWRtYXRjaFsgMSBdLAoJCQkJCWNocm9tZW1hdGNoID0gdWEuaW5kZXhPZiggIkNocm9tZSIgKSA+IC0xOwoKCQkJCS8vIFBsYXRmb3JtIGlzIEFuZHJvaWQsIFdlYktpdCB2ZXJzaW9uIGlzIGdyZWF0ZXIgdGhhbiA1MzQuMTMgKCBBbmRyb2lkIDMuMi4xICkgYW5kIG5vdCBDaHJvbWUuCgkJCQlpZiAoIGFuZHJvaWRtYXRjaCAhPT0gbnVsbCAmJiBhbmR2ZXJzaW9uID09PSAiNC4wIiAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uID4gNTM0LjEzICYmICFjaHJvbWVtYXRjaCApIHsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0KCQkJCXJldHVybiBmYWxzZTsKCQkJfSgpKTsKCgkJLy8gQ291bnQgZG93biB0byB0cmlnZ2VyaW5nICJwb3B1cGFmdGVyb3BlbiIgLSB3ZSBoYXZlIHR3byBwcmVyZXF1aXNpdGVzOgoJCS8vIDEuIFRoZSBwb3B1cCB3aW5kb3cgYW5pbWF0aW9uIGNvbXBsZXRlcyAoY29udGFpbmVyKCkpCgkJLy8gMi4gVGhlIHNjcmVlbiBvcGFjaXR5IGFuaW1hdGlvbiBjb21wbGV0ZXMgKHNjcmVlbigpKQoJCXRoaXMuX2NyZWF0ZVByZXJlcXVpc2l0ZXMoCgkJCSQubm9vcCwKCQkJJC5ub29wLAoJCQkkLnByb3h5KCB0aGlzLCAiX29wZW5QcmVyZXF1aXNpdGVzQ29tcGxldGUiICkgKTsKCgkJdGhpcy5fY3VycmVudFRyYW5zaXRpb24gPSBvcGVuT3B0aW9ucy50cmFuc2l0aW9uOwoJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggb3Blbk9wdGlvbnMudHJhbnNpdGlvbiApOwoKCQl0aGlzLl91aS5zY3JlZW4ucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLXRydW5jYXRlIiApOwoKCQkvLyBHaXZlIGFwcGxpY2F0aW9ucyBhIGNoYW5jZSB0byBtb2RpZnkgdGhlIGNvbnRlbnRzIG9mIHRoZSBjb250YWluZXIgYmVmb3JlIGl0IGFwcGVhcnMKCQl0aGlzLl9yZXBvc2l0aW9uKCBvcGVuT3B0aW9ucyApOwoKCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICk7CgoJCWlmICggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSAmJiBhbmRyb2lkQmxhY2tsaXN0ICkgewoJCQkvKiBUT0RPOiBUaGUgbmF0aXZlIGJyb3dzZXIgb24gQW5kcm9pZCA0LjAuWCAoIkljZSBDcmVhbSBTYW5kd2ljaCIpIHN1ZmZlcnMgZnJvbSBhbiBpc3N1ZSB3aGVyZSB0aGUgcG9wdXAgb3ZlcmxheSBhcHBlYXJzIHRvIGJlIHotaW5kZXhlZCBhYm92ZSB0aGUgcG9wdXAgaXRzZWxmIHdoZW4gY2VydGFpbiBvdGhlciBzdHlsZXMgZXhpc3Qgb24gdGhlIHNhbWUgcGFnZSAtLSBuYW1lbHksIGFueSBlbGVtZW50IHNldCB0byBgcG9zaXRpb246IGZpeGVkYCBhbmQgY2VydGFpbiB0eXBlcyBvZiBpbnB1dC4gVGhlc2UgaXNzdWVzIGFyZSByZW1pbmlzY2VudCBvZiBwcmV2aW91c2x5IHVuY292ZXJlZCBidWdzIGluIG9sZGVyIHZlcnNpb25zIG9mIEFuZHJvaWQncyBuYXRpdmUgYnJvd3NlcjogaHR0cHM6Ly9naXRodWIuY29tL3Njb3R0amVobC9EZXZpY2UtQnVncy9pc3N1ZXMvMwoJCQlUaGlzIGZpeCBjbG9zZXMgdGhlIGZvbGxvd2luZyBidWdzICggSSB1c2UgImNsb3NlcyIgd2l0aCByZWx1Y3RhbmNlLCBhbmQgc3RyZXNzIHRoYXQgdGhpcyBpc3N1ZSBzaG91bGQgYmUgcmV2aXNpdGVkIGFzIHNvb24gYXMgcG9zc2libGUgKToKCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODE2CgkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDg0NAoJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4NzQKCQkJKi8KCgkJCS8vIFRPRE8gc29ydCBvdXQgd2h5IHRoaXMuX3BhZ2UgaXNuJ3Qgd29ya2luZwoJCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLmFkZENsYXNzKCAidWktcG9wdXAtb3BlbiIgKTsKCQl9CgkJdGhpcy5fYW5pbWF0ZSh7CgkJCWFkZGl0aW9uYWxDb25kaXRpb246IHRydWUsCgkJCXRyYW5zaXRpb246IG9wZW5PcHRpb25zLnRyYW5zaXRpb24sCgkJCWNsYXNzVG9SZW1vdmU6ICIiLAoJCQlzY3JlZW5DbGFzc1RvQWRkOiAiaW4iLAoJCQljb250YWluZXJDbGFzc1RvQWRkOiAiaW4iLAoJCQlhcHBseVRyYW5zaXRpb246IGZhbHNlLAoJCQlwcmVyZXF1aXNpdGVzOiB0aGlzLl9wcmVyZXF1aXNpdGVzCgkJfSk7Cgl9LAoKCV9jbG9zZVByZXJlcXVpc2l0ZVNjcmVlbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fdWkuc2NyZWVuCgkJCS5yZW1vdmVDbGFzcyggIm91dCIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJfSwKCglfY2xvc2VQcmVyZXF1aXNpdGVDb250YWluZXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkucmVtb3ZlQ2xhc3MoICJyZXZlcnNlIG91dCIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4gdWktcG9wdXAtdHJ1bmNhdGUiICkKCQkJLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCX0sCgoJX2Nsb3NlUHJlcmVxdWlzaXRlc0RvbmU6IGZ1bmN0aW9uKCkgewoJCXZhciBjb250YWluZXIgPSB0aGlzLl91aS5jb250YWluZXI7CgoJCWNvbnRhaW5lci5yZW1vdmVBdHRyKCAidGFiaW5kZXgiICk7CgoJCS8vIHJlbW92ZSB0aGUgZ2xvYmFsIG11dGV4IGZvciBwb3B1cHMKCQkkLm1vYmlsZS5wb3B1cC5hY3RpdmUgPSB1bmRlZmluZWQ7CgoJCS8vIEJsdXIgZWxlbWVudHMgaW5zaWRlIHRoZSBjb250YWluZXIsIGluY2x1ZGluZyB0aGUgY29udGFpbmVyCgkJJCggIjpmb2N1cyIsIGNvbnRhaW5lclsgMCBdICkuYWRkKCBjb250YWluZXJbIDAgXSApLmJsdXIoKTsKCgkJLy8gYWxlcnQgdXNlcnMgdGhhdCB0aGUgcG9wdXAgaXMgY2xvc2VkCgkJdGhpcy5fdHJpZ2dlciggImFmdGVyY2xvc2UiICk7Cgl9LAoKCV9jbG9zZTogZnVuY3Rpb24oIGltbWVkaWF0ZSApIHsKCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1hY3RpdmUiICk7CgkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggInVpLXBvcHVwLW9wZW4iICk7CgoJCXRoaXMuX2lzT3BlbiA9IGZhbHNlOwoKCQkvLyBDb3VudCBkb3duIHRvIHRyaWdnZXJpbmcgInBvcHVwYWZ0ZXJjbG9zZSIgLSB3ZSBoYXZlIHR3byBwcmVyZXF1aXNpdGVzOgoJCS8vIDEuIFRoZSBwb3B1cCB3aW5kb3cgcmV2ZXJzZSBhbmltYXRpb24gY29tcGxldGVzIChjb250YWluZXIoKSkKCQkvLyAyLiBUaGUgc2NyZWVuIG9wYWNpdHkgYW5pbWF0aW9uIGNvbXBsZXRlcyAoc2NyZWVuKCkpCgkJdGhpcy5fY3JlYXRlUHJlcmVxdWlzaXRlcygKCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcXVpc2l0ZVNjcmVlbiIgKSwKCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcXVpc2l0ZUNvbnRhaW5lciIgKSwKCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcXVpc2l0ZXNEb25lIiApICk7CgoJCXRoaXMuX2FuaW1hdGUoIHsKCQkJYWRkaXRpb25hbENvbmRpdGlvbjogdGhpcy5fdWkuc2NyZWVuLmhhc0NsYXNzKCAiaW4iICksCgkJCXRyYW5zaXRpb246ICggaW1tZWRpYXRlID8gIm5vbmUiIDogKCB0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiApICksCgkJCWNsYXNzVG9SZW1vdmU6ICJpbiIsCgkJCXNjcmVlbkNsYXNzVG9BZGQ6ICJvdXQiLAoJCQljb250YWluZXJDbGFzc1RvQWRkOiAicmV2ZXJzZSBvdXQiLAoJCQlhcHBseVRyYW5zaXRpb246IHRydWUsCgkJCXByZXJlcXVpc2l0ZXM6IHRoaXMuX3ByZXJlcXVpc2l0ZXMKCQl9KTsKCX0sCgoJX3VuZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIFB1dCB0aGUgZWxlbWVudCBiYWNrIHRvIHdoZXJlIHRoZSBwbGFjZWhvbGRlciB3YXMgYW5kIHJlbW92ZSB0aGUgInVpLXBvcHVwIiBjbGFzcwoJCXRoaXMuX3NldE9wdGlvbnMoIHsgdGhlbWU6ICQubW9iaWxlLnBvcHVwLnByb3RvdHlwZS5vcHRpb25zLnRoZW1lIH0gKTsKCQl0aGlzLmVsZW1lbnQKCQkJLy8gQ2Fubm90IGRpcmVjdGx5IGluc2VydEFmdGVyKCkgLSB3ZSBuZWVkIHRvIGRldGFjaCgpIGZpcnN0LCBiZWNhdXNlCgkJCS8vIGluc2VydEFmdGVyKCkgd2lsbCBkbyBub3RoaW5nIGlmIHRoZSBwYXlsb2FkIGRpdiB3YXMgbm90IGF0dGFjaGVkCgkJCS8vIHRvIHRoZSBET00gYXQgdGhlIHRpbWUgdGhlIHdpZGdldCB3YXMgY3JlYXRlZCwgYW5kIHNvIHRoZSBwYXlsb2FkCgkJCS8vIHdpbGwgcmVtYWluIGluc2lkZSB0aGUgY29udGFpbmVyIGV2ZW4gYWZ0ZXIgd2UgY2FsbCBpbnNlcnRBZnRlcigpLgoJCQkvLyBJZiB0aGF0IGhhcHBlbnMgYW5kIHdlIHJlbW92ZSB0aGUgY29udGFpbmVyIGEgZmV3IGxpbmVzIGJlbG93LCB3ZQoJCQkvLyB3aWxsIGNhdXNlIGFuIGluZmluaXRlIHJlY3Vyc2lvbiAtICM1MjQ0CgkJCS5kZXRhY2goKQoJCQkuaW5zZXJ0QWZ0ZXIoIHRoaXMuX3VpLnBsYWNlaG9sZGVyICkKCQkJLnJlbW92ZUNsYXNzKCAidWktcG9wdXAgdWktb3ZlcmxheS1zaGFkb3cgdWktY29ybmVyLWFsbCB1aS1ib2R5LWluaGVyaXQiICk7CgkJdGhpcy5fdWkuc2NyZWVuLnJlbW92ZSgpOwoJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmUoKTsKCQl0aGlzLl91aS5wbGFjZWhvbGRlci5yZW1vdmUoKTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggJC5tb2JpbGUucG9wdXAuYWN0aXZlID09PSB0aGlzICkgewoJCQl0aGlzLmVsZW1lbnQub25lKCAicG9wdXBhZnRlcmNsb3NlIiwgJC5wcm94eSggdGhpcywgIl91bmVuaGFuY2UiICkgKTsKCQkJdGhpcy5jbG9zZSgpOwoJCX0gZWxzZSB7CgkJCXRoaXMuX3VuZW5oYW5jZSgpOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9jbG9zZVBvcHVwOiBmdW5jdGlvbiggdGhlRXZlbnQsIGRhdGEgKSB7CgkJdmFyIHBhcnNlZERzdCwgdG9VcmwsCgkJCWN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlpbW1lZGlhdGUgPSBmYWxzZTsKCgkJaWYgKCAoIHRoZUV2ZW50ICYmIHRoZUV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgfHwgJC5tb2JpbGUucG9wdXAuYWN0aXZlICE9PSB0aGlzICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyByZXN0b3JlIGxvY2F0aW9uIG9uIHNjcmVlbgoJCXdpbmRvdy5zY3JvbGxUbyggMCwgdGhpcy5fc2Nyb2xsVG9wICk7CgoJCWlmICggdGhlRXZlbnQgJiYgdGhlRXZlbnQudHlwZSA9PT0gInBhZ2ViZWZvcmVjaGFuZ2UiICYmIGRhdGEgKSB7CgkJCS8vIERldGVybWluZSB3aGV0aGVyIHdlIG5lZWQgdG8gcmFwaWQtY2xvc2UgdGhlIHBvcHVwLCBvciB3aGV0aGVyIHdlIGNhbgoJCQkvLyB0YWtlIHRoZSB0aW1lIHRvIHJ1biB0aGUgY2xvc2luZyB0cmFuc2l0aW9uCgkJCWlmICggdHlwZW9mIGRhdGEudG9QYWdlID09PSAic3RyaW5nIiApIHsKCQkJCXBhcnNlZERzdCA9IGRhdGEudG9QYWdlOwoJCQl9IGVsc2UgewoJCQkJcGFyc2VkRHN0ID0gZGF0YS50b1BhZ2UuanFtRGF0YSggInVybCIgKTsKCQkJfQoJCQlwYXJzZWREc3QgPSAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCBwYXJzZWREc3QgKTsKCQkJdG9VcmwgPSBwYXJzZWREc3QucGF0aG5hbWUgKyBwYXJzZWREc3Quc2VhcmNoICsgcGFyc2VkRHN0Lmhhc2g7CgoJCQlpZiAoIHRoaXMuX215VXJsICE9PSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggdG9VcmwgKSApIHsKCQkJCS8vIEdvaW5nIHRvIGEgZGlmZmVyZW50IHBhZ2UgLSBjbG9zZSBpbW1lZGlhdGVseQoJCQkJaW1tZWRpYXRlID0gdHJ1ZTsKCQkJfSBlbHNlIHsKCQkJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQl9CgoJCS8vIHJlbW92ZSBuYXYgYmluZGluZ3MKCQkkLm1vYmlsZS53aW5kb3cub2ZmKCBjdXJyZW50T3B0aW9ucy5jbG9zZUV2ZW50cyApOwoJCS8vIHVuYmluZCBjbGljayBoYW5kbGVycyBhZGRlZCB3aGVuIGhpc3RvcnkgaXMgZGlzYWJsZWQKCQl0aGlzLmVsZW1lbnQudW5kZWxlZ2F0ZSggY3VycmVudE9wdGlvbnMuY2xvc2VMaW5rU2VsZWN0b3IsIGN1cnJlbnRPcHRpb25zLmNsb3NlTGlua0V2ZW50cyApOwoKCQl0aGlzLl9jbG9zZSggaW1tZWRpYXRlICk7Cgl9LAoKCS8vIGFueSBuYXZpZ2F0aW9uIGV2ZW50IGFmdGVyIGEgcG9wdXAgaXMgb3BlbmVkIHNob3VsZCBjbG9zZSB0aGUgcG9wdXAKCS8vIE5PVEUgdGhlIHBhZ2ViZWZvcmVjaGFuZ2UgaXMgYm91bmQgdG8gY2F0Y2ggbmF2aWdhdGlvbiBldmVudHMgdGhhdCBkb24ndAoJLy8gICAgICBhbHRlciB0aGUgdXJsIChlZywgZGlhbG9ncyBmcm9tIHBvcHVwcykKCV9iaW5kQ29udGFpbmVyQ2xvc2U6IGZ1bmN0aW9uKCkgewoJCSQubW9iaWxlLndpbmRvdwoJCQkub24oIHRoaXMub3B0aW9ucy5jbG9zZUV2ZW50cywgJC5wcm94eSggdGhpcywgIl9jbG9zZVBvcHVwIiApICk7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3VpLmNvbnRhaW5lcjsKCX0sCgoJLy8gVE9ETyBubyBjbGVhciBkZWxpbmlhdGlvbiBvZiB3aGF0IHNob3VsZCBiZSBoZXJlIGFuZAoJLy8gd2hhdCBzaG91bGQgYmUgaW4gX29wZW4uIFNlZW1zIHRvIGJlICJ2aXN1YWwiIHZzICJoaXN0b3J5IiBmb3Igbm93CglvcGVuOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgdXJsLCBoYXNoa2V5LCBhY3RpdmVQYWdlLCBjdXJyZW50SXNEaWFsb2csIGhhc0hhc2gsIHVybEhpc3RvcnksCgkJCXNlbGYgPSB0aGlzLAoJCQljdXJyZW50T3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCgkJLy8gbWFrZSBzdXJlIG9wZW4gaXMgaWRlbXBvdGVudAoJCWlmICggJC5tb2JpbGUucG9wdXAuYWN0aXZlIHx8IGN1cnJlbnRPcHRpb25zLmRpc2FibGVkICkgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCS8vIHNldCB0aGUgZ2xvYmFsIHBvcHVwIG11dGV4CgkJJC5tb2JpbGUucG9wdXAuYWN0aXZlID0gdGhpczsKCQl0aGlzLl9zY3JvbGxUb3AgPSAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCk7CgoJCS8vIGlmIGhpc3RvcnkgYWx0ZXJhdGlvbiBpcyBkaXNhYmxlZCBjbG9zZSBvbiBuYXZpZ2F0ZSBldmVudHMKCQkvLyBhbmQgbGVhdmUgdGhlIHVybCBhcyBpcwoJCWlmICggISggY3VycmVudE9wdGlvbnMuaGlzdG9yeSApICkgewoJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoKCQkJLy8gV2hlbiBoaXN0b3kgaXMgZGlzYWJsZWQgd2UgaGF2ZSB0byBncmFiIHRoZSBkYXRhLXJlbAoJCQkvLyBiYWNrIGxpbmsgY2xpY2tzIHNvIHdlIGNhbiBjbG9zZSB0aGUgcG9wdXAgaW5zdGVhZCBvZgoJCQkvLyByZWx5aW5nIG9uIGhpc3RvcnkgdG8gZG8gaXQgZm9yIHVzCgkJCXNlbGYuZWxlbWVudAoJCQkJLmRlbGVnYXRlKCBjdXJyZW50T3B0aW9ucy5jbG9zZUxpbmtTZWxlY3RvciwgY3VycmVudE9wdGlvbnMuY2xvc2VMaW5rRXZlbnRzLCBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9KTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gY2FjaGUgc29tZSB2YWx1ZXMgZm9yIG1pbi9yZWFkYWJpbGl0eQoJCXVybEhpc3RvcnkgPSAkLm1vYmlsZS51cmxIaXN0b3J5OwoJCWhhc2hrZXkgPSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5OwoJCWFjdGl2ZVBhZ2UgPSAkLm1vYmlsZS5hY3RpdmVQYWdlOwoJCWN1cnJlbnRJc0RpYWxvZyA9ICggYWN0aXZlUGFnZSA/IGFjdGl2ZVBhZ2UuaGFzQ2xhc3MoICJ1aS1kaWFsb2ciICkgOiBmYWxzZSApOwoJCXRoaXMuX215VXJsID0gdXJsID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKS51cmw7CgkJaGFzSGFzaCA9ICggdXJsLmluZGV4T2YoIGhhc2hrZXkgKSA+IC0xICkgJiYgIWN1cnJlbnRJc0RpYWxvZyAmJiAoIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPiAwICk7CgoJCWlmICggaGFzSGFzaCApIHsKCQkJc2VsZi5fb3Blbiggb3B0aW9ucyApOwoJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQkvLyBpZiB0aGUgY3VycmVudCB1cmwgaGFzIG5vIGRpYWxvZyBoYXNoIGtleSBwcm9jZWVkIGFzIG5vcm1hbAoJCS8vIG90aGVyd2lzZSwgaWYgdGhlIHBhZ2UgaXMgYSBkaWFsb2cgc2ltcGx5IHRhY2sgb24gdGhlIGhhc2gga2V5CgkJaWYgKCB1cmwuaW5kZXhPZiggaGFzaGtleSApID09PSAtMSAmJiAhY3VycmVudElzRGlhbG9nICl7CgkJCXVybCA9IHVybCArICh1cmwuaW5kZXhPZiggIiMiICkgPiAtMSA/IGhhc2hrZXkgOiAiIyIgKyBoYXNoa2V5KTsKCQl9IGVsc2UgewoJCQl1cmwgPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoICsgaGFzaGtleTsKCQl9CgoJCS8vIFRhY2sgb24gYW4gZXh0cmEgaGFzaGtleSBpZiB0aGlzIGlzIHRoZSBmaXJzdCBwYWdlIGFuZCB3ZSd2ZSBqdXN0IHJlY29uc3RydWN0ZWQgdGhlIGluaXRpYWwgaGFzaAoJCWlmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCAmJiB1cmwgPT09IHVybEhpc3RvcnkuaW5pdGlhbERzdCApIHsKCQkJdXJsICs9IGhhc2hrZXk7CgkJfQoKCQkvLyBzd2FsbG93IHRoZSB0aGUgaW5pdGlhbCBuYXZpZ2F0aW9uIGV2ZW50LCBhbmQgYmluZCBmb3IgdGhlIG5leHQKCQkkLm1vYmlsZS53aW5kb3cub25lKCAiYmVmb3JlbmF2aWdhdGUiLCBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJc2VsZi5fYmluZENvbnRhaW5lckNsb3NlKCk7CgkJfSk7CgoJCXRoaXMudXJsQWx0ZXJlZCA9IHRydWU7CgkJJC5tb2JpbGUubmF2aWdhdGUoIHVybCwgeyByb2xlOiAiZGlhbG9nIiB9ICk7CgoJCXJldHVybiB0aGlzOwoJfSwKCgljbG9zZTogZnVuY3Rpb24oKSB7CgkJLy8gbWFrZSBzdXJlIGNsb3NlIGlzIGlkZW1wb3RlbnQKCQlpZiAoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSAhPT0gdGhpcyApIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQl0aGlzLl9zY3JvbGxUb3AgPSAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLmhpc3RvcnkgJiYgdGhpcy51cmxBbHRlcmVkICkgewoJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCXRoaXMudXJsQWx0ZXJlZCA9IGZhbHNlOwoJCX0gZWxzZSB7CgkJCS8vIHNpbXVsYXRlIHRoZSBuYXYgYmluZGluZ3MgaGF2aW5nIGZpcmVkCgkJCXRoaXMuX2Nsb3NlUG9wdXAoKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQp9KTsKCgovLyBUT0RPIHRoaXMgY2FuIGJlIG1vdmVkIGluc2lkZSB0aGUgd2lkZ2V0CiQubW9iaWxlLnBvcHVwLmhhbmRsZUxpbmsgPSBmdW5jdGlvbiggJGxpbmsgKSB7Cgl2YXIgY2xvc2VzdFBhZ2UgPSAkbGluay5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApLAoJCXBhdGggPSAkLm1vYmlsZS5wYXRoLAoJCXNjb3BlID0gKCAoIGNsb3Nlc3RQYWdlLmxlbmd0aCA9PT0gMCApID8gJCggImJvZHkiICkgOiBjbG9zZXN0UGFnZSApLAoJCS8vIE5PVEUgbWFrZSBzdXJlIHRvIGdldCBvbmx5IHRoZSBoYXNoLCBpZTcgKHdwNykgcmV0dXJucyB0aGUgYWJzb2x1dGUgaHJlZgoJCS8vICAgICAgaW4gdGhpcyBjYXNlIHJ1aW5pbmcgdGhlIGVsZW1lbnQgc2VsZWN0aW9uCgkJcG9wdXAgPSAkKCBwYXRoLmhhc2hUb1NlbGVjdG9yKCBwYXRoLnBhcnNlVXJsKCAkbGluay5hdHRyKCAiaHJlZiIgKSApLmhhc2ggKSwgc2NvcGVbIDAgXSApLAoJCW9mZnNldDsKCglpZiAoIHBvcHVwLmRhdGEoICJtb2JpbGUtcG9wdXAiICkgKSB7CgkJb2Zmc2V0ID0gJGxpbmsub2Zmc2V0KCk7CgkJcG9wdXAucG9wdXAoICJvcGVuIiwgewoJCQl4OiBvZmZzZXQubGVmdCArICRsaW5rLm91dGVyV2lkdGgoKSAvIDIsCgkJCXk6IG9mZnNldC50b3AgKyAkbGluay5vdXRlckhlaWdodCgpIC8gMiwKCQkJdHJhbnNpdGlvbjogJGxpbmsuanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCXBvc2l0aW9uVG86ICRsaW5rLmpxbURhdGEoICJwb3NpdGlvbi10byIgKQoJCX0pOwoJfQoKCS8vcmVtb3ZlIGFmdGVyIGRlbGF5CglzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkkbGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCX0sIDMwMCApOwp9OwoKLy8gVE9ETyBtb3ZlIGluc2lkZSBfY3JlYXRlCiQubW9iaWxlLmRvY3VtZW50Lm9uKCAicGFnZWJlZm9yZWNoYW5nZSIsIGZ1bmN0aW9uKCB0aGVFdmVudCwgZGF0YSApIHsKCWlmICggZGF0YS5vcHRpb25zLnJvbGUgPT09ICJwb3B1cCIgKSB7CgkJJC5tb2JpbGUucG9wdXAuaGFuZGxlTGluayggZGF0YS5vcHRpb25zLmxpbmsgKTsKCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCi8qCiogY3VzdG9tICJzZWxlY3RtZW51IiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHVuZm9jdXNhYmxlSXRlbVNlbGVjdG9yID0gIi51aS1kaXNhYmxlZCwudWktbGktZGl2aWRlciwudWktc2NyZWVuLWhpZGRlbiw6anFtRGF0YShyb2xlPSdwbGFjZWhvbGRlcicpIiwKCWdvVG9BZGphY2VudEl0ZW0gPSBmdW5jdGlvbiggaXRlbSwgdGFyZ2V0LCBkaXJlY3Rpb24gKSB7CgkJdmFyIGFkamFjZW50ID0gaXRlbVsgZGlyZWN0aW9uICsgIkFsbCIgXSgpCgkJCS5ub3QoIHVuZm9jdXNhYmxlSXRlbVNlbGVjdG9yICkKCQkJLmZpcnN0KCk7CgoJCS8vIGlmIHRoZXJlJ3MgYSBwcmV2aW91cyBvcHRpb24sIGZvY3VzIGl0CgkJaWYgKCBhZGphY2VudC5sZW5ndGggKSB7CgkJCXRhcmdldAoJCQkJLmJsdXIoKQoJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCgkJCWFkamFjZW50LmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQl9Cgl9OwoKJC53aWRnZXQoICJtb2JpbGUuc2VsZWN0bWVudSIsICQubW9iaWxlLnNlbGVjdG1lbnUsIHsKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBvID0gdGhpcy5vcHRpb25zOwoKCQkvLyBDdXN0b20gc2VsZWN0cyBjYW5ub3QgZXhpc3QgaW5zaWRlIHBvcHVwcywgc28gcmV2ZXJ0IHRoZSAibmF0aXZlTWVudSIKCQkvLyBvcHRpb24gdG8gdHJ1ZSBpZiBhIHBhcmVudCBpcyBhIHBvcHVwCgkJby5uYXRpdmVNZW51ID0gby5uYXRpdmVNZW51IHx8ICggdGhpcy5lbGVtZW50LnBhcmVudHMoICI6anFtRGF0YShyb2xlPSdwb3B1cCcpLDptb2JpbGUtcG9wdXAiICkubGVuZ3RoID4gMCApOwoKCQlyZXR1cm4gdGhpcy5fc3VwZXIoKTsKCX0sCgoJX2hhbmRsZVNlbGVjdEZvY3VzOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYmx1cigpOwoJCXRoaXMuYnV0dG9uLmZvY3VzKCk7Cgl9LAoKCV9oYW5kbGVCdXR0b25WY2xpY2tLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5pc09wZW4gKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmIChldmVudC50eXBlID09PSAidmNsaWNrIiB8fAoJCQkJZXZlbnQua2V5Q29kZSAmJiAoZXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5FTlRFUiB8fCBldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLlNQQUNFKSkgewoKCQkJdGhpcy5fZGVjaWRlRm9ybWF0KCk7CgkJCWlmICggdGhpcy5tZW51VHlwZSA9PT0gIm92ZXJsYXkiICkgewoJCQkJdGhpcy5idXR0b24uYXR0ciggImhyZWYiLCAiIyIgKyB0aGlzLnBvcHVwSWQgKS5hdHRyKCAiZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInJlbCIsICJwb3B1cCIgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuYnV0dG9uLmF0dHIoICJocmVmIiwgIiMiICsgdGhpcy5kaWFsb2dJZCApLmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAicmVsIiwgImRpYWxvZyIgKTsKCQkJfQoJCQl0aGlzLmlzT3BlbiA9IHRydWU7CgkJCS8vIERvIG5vdCBwcmV2ZW50IGRlZmF1bHQsIHNvIHRoZSBuYXZpZ2F0aW9uIG1heSBoYXZlIGEgY2hhbmNlIHRvIGFjdHVhbGx5IG9wZW4gdGhlIGNob3NlbiBmb3JtYXQKCQl9Cgl9LAoKCV9oYW5kbGVMaXN0Rm9jdXM6IGZ1bmN0aW9uKCBlICkgewoJCXZhciBwYXJhbXMgPSAoIGUudHlwZSA9PT0gImZvY3VzaW4iICkgPwoJCQl7IHRhYmluZGV4OiAiMCIsIGV2ZW50OiAidm1vdXNlb3ZlciIgfToKCQkJeyB0YWJpbmRleDogIi0xIiwgZXZlbnQ6ICJ2bW91c2VvdXQiIH07CgoJCSQoIGUudGFyZ2V0ICkKCQkJLmF0dHIoICJ0YWJpbmRleCIsIHBhcmFtcy50YWJpbmRleCApCgkJCS50cmlnZ2VyKCBwYXJhbXMuZXZlbnQgKTsKCX0sCgoJX2hhbmRsZUxpc3RLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLAoJCQlsaSA9IHRhcmdldC5jbG9zZXN0KCAibGkiICk7CgoJCS8vIHN3aXRjaCBsb2dpYyBiYXNlZCBvbiB3aGljaCBrZXkgd2FzIHByZXNzZWQKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQkvLyB1cCBvciBsZWZ0IGFycm93IGtleXMKCQljYXNlIDM4OgoJCQlnb1RvQWRqYWNlbnRJdGVtKCBsaSwgdGFyZ2V0LCAicHJldiIgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCQkvLyBkb3duIG9yIHJpZ2h0IGFycm93IGtleXMKCQljYXNlIDQwOgoJCQlnb1RvQWRqYWNlbnRJdGVtKCBsaSwgdGFyZ2V0LCAibmV4dCIgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCQkvLyBJZiBlbnRlciBvciBzcGFjZSBpcyBwcmVzc2VkLCB0cmlnZ2VyIGNsaWNrCgkJY2FzZSAxMzoKCQljYXNlIDMyOgoJCQl0YXJnZXQudHJpZ2dlciggImNsaWNrIiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSwKCglfaGFuZGxlTWVudVBhZ2VIaWRlOiBmdW5jdGlvbigpIHsKCQkvLyBUT0RPIGNlbnRyYWxpemUgcGFnZSByZW1vdmFsIGJpbmRpbmcgLyBoYW5kbGluZyBpbiB0aGUgcGFnZSBwbHVnaW4uCgkJLy8gU3VnZ2VzdGlvbiBmcm9tIEBqYmxhcyB0byBkbyByZWZjb3VudGluZwoJCS8vCgkJLy8gVE9ETyBleHRyZW1lbHkgY29uZnVzaW5nIGRlcGVuZGVuY3kgb24gdGhlIG9wZW4gbWV0aG9kIHdoZXJlIHRoZSBwYWdlaGlkZS5yZW1vdmUKCQkvLyBiaW5kaW5ncyBhcmUgc3RyaXBwZWQgdG8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBkaXNhcHBlYXJpbmcuIFRoZSB3YXkKCQkvLyB3ZSdyZSBrZWVwaW5nIHBhZ2VzIGluIHRoZSBET00gcmlnaHQgbm93IHN1Y2tzCgkJLy8KCQkvLyByZWJpbmQgdGhlIHBhZ2UgcmVtb3ZlIHRoYXQgd2FzIHVuYm91bmQgaW4gdGhlIG9wZW4gZnVuY3Rpb24KCQkvLyB0byBhbGxvdyBmb3IgdGhlIHBhcmVudCBwYWdlIHJlbW92YWwgZnJvbSBhY3Rpb25zIG90aGVyIHRoYW4gdGhlIHVzZQoJCS8vIG9mIGEgZGlhbG9nIHNpemVkIGN1c3RvbSBzZWxlY3QKCQkvLwoJCS8vIGRvaW5nIHRoaXMgaGVyZSBwcm92aWRlcyBmb3IgdGhlIGJhY2sgYnV0dG9uIG9uIHRoZSBjdXN0b20gc2VsZWN0IGRpYWxvZwoJCXRoaXMudGhpc1BhZ2UucGFnZSggImJpbmRSZW1vdmUiICk7Cgl9LAoKCV9oYW5kbGVIZWFkZXJDbG9zZUNsaWNrOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMubWVudVR5cGUgPT09ICJvdmVybGF5IiApIHsKCQkJdGhpcy5jbG9zZSgpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSwKCglidWlsZDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdElkLCBwb3B1cElkLCBkaWFsb2dJZCwgbGFiZWwsIHRoaXNQYWdlLCBpc011bHRpcGxlLCBtZW51SWQsIHRoZW1lQXR0ciwgb3ZlcmxheVRoZW1lQXR0ciwKCQkJZGl2aWRlclRoZW1lQXR0ciwgbWVudVBhZ2UsIGxpc3Rib3gsIGxpc3QsIGhlYWRlciwgaGVhZGVyVGl0bGUsIG1lbnVQYWdlQ29udGVudCwgbWVudVBhZ2VDbG9zZSwgaGVhZGVyQ2xvc2UsIHNlbGYsCgkJCW8gPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggby5uYXRpdmVNZW51ICkgewoJCQlyZXR1cm4gdGhpcy5fc3VwZXIoKTsKCQl9CgoJCXNlbGYgPSB0aGlzOwoJCXNlbGVjdElkID0gdGhpcy5zZWxlY3RJZDsKCQlwb3B1cElkID0gc2VsZWN0SWQgKyAiLWxpc3Rib3giOwoJCWRpYWxvZ0lkID0gc2VsZWN0SWQgKyAiLWRpYWxvZyI7CgkJbGFiZWwgPSB0aGlzLmxhYmVsOwoJCXRoaXNQYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQlpc011bHRpcGxlID0gdGhpcy5lbGVtZW50WyAwIF0ubXVsdGlwbGU7CgkJbWVudUlkID0gc2VsZWN0SWQgKyAiLW1lbnUiOwoJCXRoZW1lQXR0ciA9IG8udGhlbWUgPyAoICIgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWU9JyIgKyBvLnRoZW1lICsgIiciICkgOiAiIjsKCQlvdmVybGF5VGhlbWVBdHRyID0gby5vdmVybGF5VGhlbWUgPyAoICIgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWU9JyIgKyBvLm92ZXJsYXlUaGVtZSArICInIiApIDogIiI7CgkJZGl2aWRlclRoZW1lQXR0ciA9ICggby5kaXZpZGVyVGhlbWUgJiYgaXNNdWx0aXBsZSApID8gKCAiIGRhdGEtIiArICQubW9iaWxlLm5zICsgImRpdmlkZXItdGhlbWU9JyIgKyBvLmRpdmlkZXJUaGVtZSArICInIiApIDogIiI7CgkJbWVudVBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdkaWFsb2cnIGNsYXNzPSd1aS1zZWxlY3RtZW51JyBpZD0nIiArIGRpYWxvZ0lkICsgIiciICsgdGhlbWVBdHRyICsgb3ZlcmxheVRoZW1lQXR0ciArICI+IiArCgkJCSI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2hlYWRlcic+IiArCgkJCSI8ZGl2IGNsYXNzPSd1aS10aXRsZSc+IiArIGxhYmVsLmdldEVuY29kZWRUZXh0KCkgKyAiPC9kaXY+IisKCQkJIjwvZGl2PiIrCgkJCSI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2NvbnRlbnQnPjwvZGl2PiIrCgkJCSI8L2Rpdj4iICk7CgkJbGlzdGJveCA9ICQoICI8ZGl2IGlkPSciICsgcG9wdXBJZCArICInIGNsYXNzPSd1aS1zZWxlY3RtZW51Jz4iICkuaW5zZXJ0QWZ0ZXIoIHRoaXMuc2VsZWN0ICkucG9wdXAoeyB0aGVtZTogby5vdmVybGF5VGhlbWUgfSk7CgkJbGlzdCA9ICQoICI8dWwgY2xhc3M9J3VpLXNlbGVjdG1lbnUtbGlzdCcgaWQ9JyIgKyBtZW51SWQgKyAiJyByb2xlPSdsaXN0Ym94JyBhcmlhLWxhYmVsbGVkYnk9JyIgKyB0aGlzLmJ1dHRvbklkICsgIiciICsgdGhlbWVBdHRyICsgZGl2aWRlclRoZW1lQXR0ciArICI+IiApLmFwcGVuZFRvKCBsaXN0Ym94ICk7CgkJaGVhZGVyID0gJCggIjxkaXYgY2xhc3M9J3VpLWhlYWRlciB1aS1iYXItIiArICggby50aGVtZSA/IG8udGhlbWUgOiAiaW5oZXJpdCIgKSArICInPiIgKS5wcmVwZW5kVG8oIGxpc3Rib3ggKTsKCQloZWFkZXJUaXRsZSA9ICQoICI8aDEgY2xhc3M9J3VpLXRpdGxlJz4iICkuYXBwZW5kVG8oIGhlYWRlciApOwoKCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJaGVhZGVyQ2xvc2UgPSAkKCAiPGE+IiwgewoJCQkJInJvbGUiOiAiYnV0dG9uIiwKCQkJCSJ0ZXh0Ijogby5jbG9zZVRleHQsCgkJCQkiaHJlZiI6ICIjIiwKCQkJCSJjbGFzcyI6ICJ1aS1idG4gdWktY29ybmVyLWFsbCB1aS1idG4tbGVmdCB1aS1idG4taWNvbi1ub3RleHQgdWktaWNvbi1kZWxldGUiCgkJCX0pLmFwcGVuZFRvKCBoZWFkZXIgKTsKCQl9CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCXNlbGVjdElkOiBzZWxlY3RJZCwKCQkJbWVudUlkOiBtZW51SWQsCgkJCXBvcHVwSWQ6IHBvcHVwSWQsCgkJCWRpYWxvZ0lkOiBkaWFsb2dJZCwKCQkJdGhpc1BhZ2U6IHRoaXNQYWdlLAoJCQltZW51UGFnZTogbWVudVBhZ2UsCgkJCWxhYmVsOiBsYWJlbCwKCQkJaXNNdWx0aXBsZTogaXNNdWx0aXBsZSwKCQkJdGhlbWU6IG8udGhlbWUsCgkJCWxpc3Rib3g6IGxpc3Rib3gsCgkJCWxpc3Q6IGxpc3QsCgkJCWhlYWRlcjogaGVhZGVyLAoJCQloZWFkZXJUaXRsZTogaGVhZGVyVGl0bGUsCgkJCWhlYWRlckNsb3NlOiBoZWFkZXJDbG9zZSwKCQkJbWVudVBhZ2VDb250ZW50OiBtZW51UGFnZUNvbnRlbnQsCgkJCW1lbnVQYWdlQ2xvc2U6IG1lbnVQYWdlQ2xvc2UsCgkJCXBsYWNlaG9sZGVyOiAiIgoJCX0pOwoKCQkvLyBDcmVhdGUgbGlzdCBmcm9tIHNlbGVjdCwgdXBkYXRlIHN0YXRlCgkJdGhpcy5yZWZyZXNoKCk7CgoJCWlmICggdGhpcy5fb3JpZ1RhYkluZGV4ID09PSB1bmRlZmluZWQgKSB7CgkJCS8vIE1hcCB1bmRlZmluZWQgdG8gZmFsc2UsIGJlY2F1c2UgdGhpcy5fb3JpZ1RhYkluZGV4ID09PSB1bmRlZmluZWQKCQkJLy8gaW5kaWNhdGVzIHRoYXQgd2UgaGF2ZSBub3QgeWV0IGNoZWNrZWQgd2hldGhlciB0aGUgc2VsZWN0IGhhcwoJCQkvLyBvcmlnaW5hbGx5IGhhZCBhIHRhYmluZGV4IGF0dHJpYnV0ZSwgd2hlcmVhcyBmYWxzZSBpbmRpY2F0ZXMgdGhhdAoJCQkvLyB3ZSBoYXZlIGNoZWNrZWQgdGhlIHNlbGVjdCBmb3Igc3VjaCBhbiBhdHRyaWJ1dGUsIGFuZCBoYXZlIGZvdW5kCgkJCS8vIG5vbmUgcHJlc2VudC4KCQkJdGhpcy5fb3JpZ1RhYkluZGV4ID0gKCB0aGlzLnNlbGVjdFsgMCBdLmdldEF0dHJpYnV0ZSggInRhYmluZGV4IiApID09PSBudWxsICkgPyBmYWxzZSA6IHRoaXMuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIgKTsKCQl9CgkJdGhpcy5zZWxlY3QuYXR0ciggInRhYmluZGV4IiwgIi0xIiApOwoJCXRoaXMuX29uKCB0aGlzLnNlbGVjdCwgeyBmb2N1cyA6ICJfaGFuZGxlU2VsZWN0Rm9jdXMiIH0gKTsKCgkJLy8gQnV0dG9uIGV2ZW50cwoJCXRoaXMuX29uKCB0aGlzLmJ1dHRvbiwgewoJCQl2Y2xpY2sgOiAiX2hhbmRsZUJ1dHRvblZjbGlja0tleWRvd24iLAoJCQlrZXlkb3duIDogIl9oYW5kbGVCdXR0b25WY2xpY2tLZXlkb3duIgoJCX0pOwoKCQkvLyBFdmVudHMgZm9yIGxpc3QgaXRlbXMKCQl0aGlzLmxpc3QuYXR0ciggInJvbGUiLCAibGlzdGJveCIgKTsKCQl0aGlzLl9vbiggdGhpcy5saXN0LCB7CgkJCWZvY3VzaW4gOiAiX2hhbmRsZUxpc3RGb2N1cyIsCgkJCWZvY3Vzb3V0IDogIl9oYW5kbGVMaXN0Rm9jdXMiLAoJCQlrZXlkb3duOiAiX2hhbmRsZUxpc3RLZXlkb3duIgoJCX0pOwoJCXRoaXMubGlzdAoJCQkuZGVsZWdhdGUoICJsaTpub3QoLnVpLWRpc2FibGVkLCAudWktbGktZGl2aWRlcikiLCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJLy8gaW5kZXggb2Ygb3B0aW9uIHRhZyB0byBiZSBzZWxlY3RlZAoJCQkJdmFyIG9sZEluZGV4ID0gc2VsZi5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4LAoJCQkJCW5ld0luZGV4ID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAib3B0aW9uLWluZGV4IiApLAoJCQkJCW9wdGlvbiA9IHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5lcSggbmV3SW5kZXggKVsgMCBdOwoKCQkJCS8vIHRvZ2dsZSBzZWxlY3RlZCBzdGF0dXMgb24gdGhlIHRhZyBmb3IgbXVsdGkgc2VsZWN0cwoJCQkJb3B0aW9uLnNlbGVjdGVkID0gc2VsZi5pc011bHRpcGxlID8gIW9wdGlvbi5zZWxlY3RlZCA6IHRydWU7CgoJCQkJLy8gdG9nZ2xlIGNoZWNrYm94IGNsYXNzIGZvciBtdWx0aXBsZSBzZWxlY3RzCgkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkkKCB0aGlzICkuZmluZCggImEiICkKCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vbiIsIG9wdGlvbi5zZWxlY3RlZCApCgkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb2ZmIiwgIW9wdGlvbi5zZWxlY3RlZCApOwoJCQkJfQoKCQkJCS8vIHRyaWdnZXIgY2hhbmdlIGlmIHZhbHVlIGNoYW5nZWQKCQkJCWlmICggc2VsZi5pc011bHRpcGxlIHx8IG9sZEluZGV4ICE9PSBuZXdJbmRleCApIHsKCQkJCQlzZWxmLnNlbGVjdC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQkJfQoKCQkJCS8vIGhpZGUgY3VzdG9tIHNlbGVjdCBmb3Igc2luZ2xlIHNlbGVjdHMgb25seSAtIG90aGVyd2lzZSBmb2N1cyBjbGlja2VkIGl0ZW0KCQkJCS8vIFdlIG5lZWQgdG8gZ3JhYiB0aGUgY2xpY2tlZCBpdGVtIHRoZSBoYXJkIHdheSwgYmVjYXVzZSB0aGUgbGlzdCBtYXkgaGF2ZSBiZWVuIHJlYnVpbHQKCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKS5lcSggbmV3SW5kZXggKQoJCQkJCQkuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfQoKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0pOwoKCQkvLyBidXR0b24gcmVmb2N1cyBlbnN1cmVzIHByb3BlciBoZWlnaHQgY2FsY3VsYXRpb24KCQkvLyBieSByZW1vdmluZyB0aGUgaW5saW5lIHN0eWxlIGFuZCBlbnN1cmluZyBwYWdlIGluY2x1c2lvbgoJCXRoaXMuX29uKCB0aGlzLm1lbnVQYWdlLCB7IHBhZ2VoaWRlOiAiX2hhbmRsZU1lbnVQYWdlSGlkZSIgfSApOwoKCQkvLyBFdmVudHMgb24gdGhlIHBvcHVwCgkJdGhpcy5fb24oIHRoaXMubGlzdGJveCwgeyBwb3B1cGFmdGVyY2xvc2U6ICJjbG9zZSIgfSApOwoKCQkvLyBDbG9zZSBidXR0b24gb24gc21hbGwgb3ZlcmxheXMKCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5fb24oIHRoaXMuaGVhZGVyQ2xvc2UsIHsgY2xpY2s6ICJfaGFuZGxlSGVhZGVyQ2xvc2VDbGljayIgfSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9pc1JlYnVpbGRSZXF1aXJlZDogZnVuY3Rpb24oKSB7CgkJdmFyIGxpc3QgPSB0aGlzLmxpc3QuZmluZCggImxpIiApLAoJCQlvcHRpb25zID0gdGhpcy5fc2VsZWN0T3B0aW9ucygpLm5vdCggIi51aS1zY3JlZW4taGlkZGVuIiApOwoKCQkvLyBUT0RPIGV4Y2VlZGluZ2x5IG5haXZlIG1ldGhvZCB0byBkZXRlcm1pbmUgZGlmZmVyZW5jZQoJCS8vIGlnbm9yZXMgdmFsdWUgY2hhbmdlcyBldGMgaW4gZmF2b3Igb2YgYSBmb3JjZWRSZWJ1aWxkCgkJLy8gZnJvbSB0aGUgdXNlciBpbiB0aGUgcmVmcmVzaCBtZXRob2QKCQlyZXR1cm4gb3B0aW9ucy50ZXh0KCkgIT09IGxpc3QudGV4dCgpOwoJfSwKCglzZWxlY3RlZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NlbGVjdE9wdGlvbnMoKS5maWx0ZXIoICI6c2VsZWN0ZWQ6bm90KCA6anFtRGF0YShwbGFjZWhvbGRlcj0ndHJ1ZScpICkiICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBmb3JjZSApIHsKCQl2YXIgc2VsZiwgaW5kaWNlczsKCgkJaWYgKCB0aGlzLm9wdGlvbnMubmF0aXZlTWVudSApIHsKCQkJcmV0dXJuIHRoaXMuX3N1cGVyKCBmb3JjZSApOwoJCX0KCgkJc2VsZiA9IHRoaXM7CgkJaWYgKCBmb3JjZSB8fCB0aGlzLl9pc1JlYnVpbGRSZXF1aXJlZCgpICkgewoJCQlzZWxmLl9idWlsZExpc3QoKTsKCQl9CgoJCWluZGljZXMgPSB0aGlzLnNlbGVjdGVkSW5kaWNlcygpOwoKCQlzZWxmLnNldEJ1dHRvblRleHQoKTsKCQlzZWxmLnNldEJ1dHRvbkNvdW50KCk7CgoJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKQoJCQkuZmluZCggImEiICkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkuZW5kKCkKCQkJLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgZmFsc2UgKQoJCQkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJCQlpZiAoICQuaW5BcnJheSggaSwgaW5kaWNlcyApID4gLTEgKSB7CgkJCQkJdmFyIGl0ZW0gPSAkKCB0aGlzICk7CgoJCQkJCS8vIEFyaWEgc2VsZWN0ZWQgYXR0cgoJCQkJCWl0ZW0uYXR0ciggImFyaWEtc2VsZWN0ZWQiLCB0cnVlICk7CgoJCQkJCS8vIE11bHRpcGxlIHNlbGVjdHM6IGFkZCB0aGUgIm9uIiBjaGVja2JveCBzdGF0ZSB0byB0aGUgaWNvbgoJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQlpdGVtLmZpbmQoICJhIiApLnJlbW92ZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vZmYiICkuYWRkQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9uIiApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWlmICggaXRlbS5oYXNDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICkgKSB7CgkJCQkJCQlpdGVtLm5leHQoKS5maW5kKCAiYSIgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWl0ZW0uZmluZCggImEiICkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0pOwoJfSwKCgljbG9zZTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgIXRoaXMuaXNPcGVuICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCWlmICggc2VsZi5tZW51VHlwZSA9PT0gInBhZ2UiICkgewoJCQlzZWxmLm1lbnVQYWdlLmRpYWxvZyggImNsb3NlIiApOwoJCQlzZWxmLmxpc3QuYXBwZW5kVG8oIHNlbGYubGlzdGJveCApOwoJCX0gZWxzZSB7CgkJCXNlbGYubGlzdGJveC5wb3B1cCggImNsb3NlIiApOwoJCX0KCgkJc2VsZi5fZm9jdXNCdXR0b24oKTsKCQkvLyBhbGxvdyB0aGUgZGlhbG9nIHRvIGJlIGNsb3NlZCBhZ2FpbgoJCXNlbGYuaXNPcGVuID0gZmFsc2U7Cgl9LAoKCW9wZW46IGZ1bmN0aW9uKCkgewoJCXRoaXMuYnV0dG9uLmNsaWNrKCk7Cgl9LAoKCV9mb2N1c01lbnVJdGVtOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0b3IgPSB0aGlzLmxpc3QuZmluZCggImEuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJaWYgKCBzZWxlY3Rvci5sZW5ndGggPT09IDAgKSB7CgkJCXNlbGVjdG9yID0gdGhpcy5saXN0LmZpbmQoICJsaTpub3QoIiArIHVuZm9jdXNhYmxlSXRlbVNlbGVjdG9yICsgIikgYS51aS1idG4iICk7CgkJfQoJCXNlbGVjdG9yLmZpcnN0KCkuZm9jdXMoKTsKCX0sCgoJX2RlY2lkZUZvcm1hdDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQkkd2luZG93ID0gJC5tb2JpbGUud2luZG93LAoJCQlzZWxmTGlzdFBhcmVudCA9IHNlbGYubGlzdC5wYXJlbnQoKSwKCQkJbWVudUhlaWdodCA9IHNlbGZMaXN0UGFyZW50Lm91dGVySGVpZ2h0KCksCgkJCXNjcm9sbFRvcCA9ICR3aW5kb3cuc2Nyb2xsVG9wKCksCgkJCWJ0bk9mZnNldCA9IHNlbGYuYnV0dG9uLm9mZnNldCgpLnRvcCwKCQkJc2NyZWVuSGVpZ2h0ID0gJHdpbmRvdy5oZWlnaHQoKTsKCgkJaWYgKCBtZW51SGVpZ2h0ID4gc2NyZWVuSGVpZ2h0IC0gODAgfHwgISQuc3VwcG9ydC5zY3JvbGxUb3AgKSB7CgoJCQlzZWxmLm1lbnVQYWdlLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICkucGFnZSgpOwoJCQlzZWxmLm1lbnVQYWdlQ29udGVudCA9IHNlbGYubWVudVBhZ2UuZmluZCggIi51aS1jb250ZW50IiApOwoJCQlzZWxmLm1lbnVQYWdlQ2xvc2UgPSBzZWxmLm1lbnVQYWdlLmZpbmQoICIudWktaGVhZGVyIGEiICk7CgoJCQkvLyBwcmV2ZW50IHRoZSBwYXJlbnQgcGFnZSBmcm9tIGJlaW5nIHJlbW92ZWQgZnJvbSB0aGUgRE9NLAoJCQkvLyBvdGhlcndpc2UgdGhlIHJlc3VsdHMgb2Ygc2VsZWN0aW5nIGEgbGlzdCBpdGVtIGluIHRoZSBkaWFsb2cKCQkJLy8gZmFsbCBpbnRvIGEgYmxhY2sgaG9sZQoJCQlzZWxmLnRoaXNQYWdlLnVuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIgKTsKCgkJCS8vZm9yIFdlYk9TL09wZXJhIE1pbmkgKHNldCBsYXN0c2Nyb2xsIHVzaW5nIGJ1dHRvbiBvZmZzZXQpCgkJCWlmICggc2Nyb2xsVG9wID09PSAwICYmIGJ0bk9mZnNldCA+IHNjcmVlbkhlaWdodCApIHsKCQkJCXNlbGYudGhpc1BhZ2Uub25lKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuanFtRGF0YSggImxhc3RTY3JvbGwiLCBidG5PZmZzZXQgKTsKCQkJCX0pOwoJCQl9CgoJCQlzZWxmLm1lbnVQYWdlLm9uZSggewoJCQkJcGFnZXNob3c6ICQucHJveHkoIHRoaXMsICJfZm9jdXNNZW51SXRlbSIgKSwKCQkJCXBhZ2VoaWRlOiAkLnByb3h5KCB0aGlzLCAiY2xvc2UiICkKCQkJfSk7CgoJCQlzZWxmLm1lbnVUeXBlID0gInBhZ2UiOwoJCQlzZWxmLm1lbnVQYWdlQ29udGVudC5hcHBlbmQoIHNlbGYubGlzdCApOwoJCQlzZWxmLm1lbnVQYWdlLmZpbmQoICJkaXYgLnVpLXRpdGxlIiApLnRleHQoIHNlbGYubGFiZWwudGV4dCgpICk7CgkJfSBlbHNlIHsKCQkJc2VsZi5tZW51VHlwZSA9ICJvdmVybGF5IjsKCgkJCXNlbGYubGlzdGJveC5vbmUoIHsgcG9wdXBhZnRlcm9wZW46ICQucHJveHkoIHRoaXMsICJfZm9jdXNNZW51SXRlbSIgKSB9ICk7CgkJfQoJfSwKCglfYnVpbGRMaXN0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCXBsYWNlaG9sZGVyID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJbmVlZFBsYWNlaG9sZGVyID0gdHJ1ZSwKCQkJZGF0YUljb24gPSB0aGlzLmlzTXVsdGlwbGUgPyAiY2hlY2tib3gtb2ZmIiA6ICJmYWxzZSIsCgkJCSRvcHRpb25zLCBudW1PcHRpb25zLCBzZWxlY3QsCgkJCWRhdGFQcmVmaXggPSAiZGF0YS0iICsgJC5tb2JpbGUubnMsCgkJCWRhdGFJbmRleEF0dHIgPSBkYXRhUHJlZml4ICsgIm9wdGlvbi1pbmRleCIsCgkJCWRhdGFJY29uQXR0ciA9IGRhdGFQcmVmaXggKyAiaWNvbiIsCgkJCWRhdGFSb2xlQXR0ciA9IGRhdGFQcmVmaXggKyAicm9sZSIsCgkJCWRhdGFQbGFjZWhvbGRlckF0dHIgPSBkYXRhUHJlZml4ICsgInBsYWNlaG9sZGVyIiwKCQkJZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCgkJCWlzUGxhY2Vob2xkZXJJdGVtID0gZmFsc2UsCgkJCW9wdEdyb3VwLAoJCQlpLAoJCQlvcHRpb24sICRvcHRpb24sIHBhcmVudCwgdGV4dCwgYW5jaG9yLCBjbGFzc2VzLAoJCQlvcHRMYWJlbCwgZGl2aWRlciwgaXRlbTsKCgkJc2VsZi5saXN0LmVtcHR5KCkuZmlsdGVyKCAiLnVpLWxpc3R2aWV3IiApLmxpc3R2aWV3KCAiZGVzdHJveSIgKTsKCQkkb3B0aW9ucyA9IHRoaXMuX3NlbGVjdE9wdGlvbnMoKTsKCQludW1PcHRpb25zID0gJG9wdGlvbnMubGVuZ3RoOwoJCXNlbGVjdCA9IHRoaXMuc2VsZWN0WyAwIF07CgoJCWZvciAoIGkgPSAwOyBpIDwgbnVtT3B0aW9ucztpKyssIGlzUGxhY2Vob2xkZXJJdGVtID0gZmFsc2UpIHsKCQkJb3B0aW9uID0gJG9wdGlvbnNbaV07CgkJCSRvcHRpb24gPSAkKCBvcHRpb24gKTsKCgkJCS8vIERvIG5vdCBjcmVhdGUgb3B0aW9ucyBiYXNlZCBvbiB1aS1zY3JlZW4taGlkZGVuIHNlbGVjdCBvcHRpb25zCgkJCWlmICggJG9wdGlvbi5oYXNDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICkgKSB7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJcGFyZW50ID0gb3B0aW9uLnBhcmVudE5vZGU7CgkJCXRleHQgPSAkb3B0aW9uLnRleHQoKTsKCQkJYW5jaG9yICA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJhIiApOwoJCQljbGFzc2VzID0gW107CgoJCQlhbmNob3Iuc2V0QXR0cmlidXRlKCAiaHJlZiIsICIjIiApOwoJCQlhbmNob3IuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCB0ZXh0ICkgKTsKCgkJCS8vIEFyZSB3ZSBpbnNpZGUgYW4gb3B0Z3JvdXA/CgkJCWlmICggcGFyZW50ICE9PSBzZWxlY3QgJiYgcGFyZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJvcHRncm91cCIgKSB7CgkJCQlvcHRMYWJlbCA9IHBhcmVudC5nZXRBdHRyaWJ1dGUoICJsYWJlbCIgKTsKCQkJCWlmICggb3B0TGFiZWwgIT09IG9wdEdyb3VwICkgewoJCQkJCWRpdmlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAibGkiICk7CgkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoIGRhdGFSb2xlQXR0ciwgImxpc3QtZGl2aWRlciIgKTsKCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggInJvbGUiLCAib3B0aW9uIiApOwoJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAidGFiaW5kZXgiLCAiLTEiICk7CgkJCQkJZGl2aWRlci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIG9wdExhYmVsICkgKTsKCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggZGl2aWRlciApOwoJCQkJCW9wdEdyb3VwID0gb3B0TGFiZWw7CgkJCQl9CgkJCX0KCgkJCWlmICggbmVlZFBsYWNlaG9sZGVyICYmICggIW9wdGlvbi5nZXRBdHRyaWJ1dGUoICJ2YWx1ZSIgKSB8fCB0ZXh0Lmxlbmd0aCA9PT0gMCB8fCAkb3B0aW9uLmpxbURhdGEoICJwbGFjZWhvbGRlciIgKSApICkgewoJCQkJbmVlZFBsYWNlaG9sZGVyID0gZmFsc2U7CgkJCQlpc1BsYWNlaG9sZGVySXRlbSA9IHRydWU7CgoJCQkJLy8gSWYgd2UgaGF2ZSBpZGVudGlmaWVkIGEgcGxhY2Vob2xkZXIsIHJlY29yZCB0aGUgZmFjdCB0aGF0IGl0IHdhcwoJCQkJLy8gdXMgd2hvIGhhdmUgYWRkZWQgdGhlIHBsYWNlaG9sZGVyIHRvIHRoZSBvcHRpb24gYW5kIG1hcmsgaXQKCQkJCS8vIHJldHJvYWN0aXZlbHkgaW4gdGhlIHNlbGVjdCBhcyB3ZWxsCgkJCQlpZiAoIG51bGwgPT09IG9wdGlvbi5nZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIgKSApIHsKCQkJCQl0aGlzLl9yZW1vdmVQbGFjZWhvbGRlckF0dHIgPSB0cnVlOwoJCQkJfQoJCQkJb3B0aW9uLnNldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciwgdHJ1ZSApOwoJCQkJaWYgKCBvLmhpZGVQbGFjZWhvbGRlck1lbnVJdGVtcyApIHsKCQkJCQljbGFzc2VzLnB1c2goICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCQkJfQoJCQkJaWYgKCBwbGFjZWhvbGRlciAhPT0gdGV4dCApIHsKCQkJCQlwbGFjZWhvbGRlciA9IHNlbGYucGxhY2Vob2xkZXIgPSB0ZXh0OwoJCQkJfQoJCQl9CgoJCQlpdGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImxpIiApOwoJCQlpZiAoIG9wdGlvbi5kaXNhYmxlZCApIHsKCQkJCWNsYXNzZXMucHVzaCggInVpLWRpc2FibGVkIiApOwoJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCQl9CgkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhSW5kZXhBdHRyLCBpICk7CgkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhSWNvbkF0dHIsIGRhdGFJY29uICk7CgkJCWlmICggaXNQbGFjZWhvbGRlckl0ZW0gKSB7CgkJCQlpdGVtLnNldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciwgdHJ1ZSApOwoJCQl9CgkJCWl0ZW0uY2xhc3NOYW1lID0gY2xhc3Nlcy5qb2luKCAiICIgKTsKCQkJaXRlbS5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgIm9wdGlvbiIgKTsKCQkJYW5jaG9yLnNldEF0dHJpYnV0ZSggInRhYmluZGV4IiwgIi0xIiApOwoJCQlpdGVtLmFwcGVuZENoaWxkKCBhbmNob3IgKTsKCQkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGl0ZW0gKTsKCQl9CgoJCXNlbGYubGlzdFswXS5hcHBlbmRDaGlsZCggZnJhZ21lbnQgKTsKCgkJLy8gSGlkZSBoZWFkZXIgaWYgaXQncyBub3QgYSBtdWx0aXNlbGVjdCBhbmQgdGhlcmUncyBubyBwbGFjZWhvbGRlcgoJCWlmICggIXRoaXMuaXNNdWx0aXBsZSAmJiAhcGxhY2Vob2xkZXIubGVuZ3RoICkgewoJCQl0aGlzLmhlYWRlci5hZGRDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5oZWFkZXJUaXRsZS50ZXh0KCB0aGlzLnBsYWNlaG9sZGVyICk7CgkJfQoKCQkvLyBOb3cgcG9wdWxhdGVkLCBjcmVhdGUgbGlzdHZpZXcKCQlzZWxmLmxpc3QubGlzdHZpZXcoKTsKCX0sCgoJX2J1dHRvbjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMub3B0aW9ucy5uYXRpdmVNZW51ID8KCQkJdGhpcy5fc3VwZXIoKSA6CgkJCSQoICI8YT4iLCB7CgkJCQkiaHJlZiI6ICIjIiwKCQkJCSJyb2xlIjogImJ1dHRvbiIsCgkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJImlkIjogdGhpcy5idXR0b25JZCwKCQkJCSJhcmlhLWhhc3BvcHVwIjogInRydWUiLAoKCQkJCS8vIFRPRE8gdmFsdWUgaXMgdW5kZWZpbmVkIGF0IGNyZWF0aW9uCgkJCQkiYXJpYS1vd25zIjogdGhpcy5tZW51SWQKCQkJfSk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCgkJaWYgKCAhdGhpcy5vcHRpb25zLm5hdGl2ZU1lbnUgKSB7CgkJCXRoaXMuY2xvc2UoKTsKCgkJCS8vIFJlc3RvcmUgdGhlIHRhYmluZGV4IGF0dHJpYnV0ZSB0byBpdHMgb3JpZ2luYWwgdmFsdWUKCQkJaWYgKCB0aGlzLl9vcmlnVGFiSW5kZXggIT09IHVuZGVmaW5lZCApIHsKCQkJCWlmICggdGhpcy5fb3JpZ1RhYkluZGV4ICE9PSBmYWxzZSApIHsKCQkJCQl0aGlzLnNlbGVjdC5hdHRyKCAidGFiaW5kZXgiLCB0aGlzLl9vcmlnVGFiSW5kZXggKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5zZWxlY3QucmVtb3ZlQXR0ciggInRhYmluZGV4IiApOwoJCQkJfQoJCQl9CgoJCQkvLyBSZW1vdmUgdGhlIHBsYWNlaG9sZGVyIGF0dHJpYnV0ZSBpZiB3ZSB3ZXJlIHRoZSBvbmVzIHRvIGFkZCBpdAoJCQlpZiAoIHRoaXMuX3JlbW92ZVBsYWNlaG9sZGVyQXR0ciApIHsKCQkJCXRoaXMuX3NlbGVjdE9wdGlvbnMoKS5yZW1vdmVBdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicGxhY2Vob2xkZXIiICk7CgkJCX0KCgkJCS8vIFJlbW92ZSB0aGUgcG9wdXAKCQkJdGhpcy5saXN0Ym94LnJlbW92ZSgpOwoKCQkJLy8gUmVtb3ZlIHRoZSBkaWFsb2cKCQkJdGhpcy5tZW51UGFnZS5yZW1vdmUoKTsKCQl9CgoJCS8vIENoYWluIHVwCgkJdGhpcy5fc3VwZXIoKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoKLy8gR2VuZXJhbCBwb2xpY3k6IERvIG5vdCBhY2Nlc3MgZGF0YS0qIGF0dHJpYnV0ZXMgZXhjZXB0IGR1cmluZyBlbmhhbmNlbWVudC4KLy8gSW4gYWxsIG90aGVyIGNhc2VzIHdlIGRldGVybWluZSB0aGUgc3RhdGUgb2YgdGhlIGJ1dHRvbiBleGNsdXNpdmVseSBmcm9tIGl0cwovLyBjbGFzc05hbWUuIFRoYXQncyB3aHkgb3B0aW9uc1RvQ2xhc3NlcyBleHBlY3RzIGEgZnVsbCBjb21wbGVtZW50IG9mIG9wdGlvbnMsCi8vIGFuZCB0aGUgalF1ZXJ5IHBsdWdpbiBjb21wbGV0ZXMgdGhlIHNldCBvZiBvcHRpb25zIGZyb20gdGhlIGRlZmF1bHQgdmFsdWVzLgoKLy8gTWFwIGNsYXNzZXMgdG8gYnV0dG9uTWFya3VwIGJvb2xlYW4gb3B0aW9ucyAtIHVzZWQgaW4gY2xhc3NOYW1lVG9PcHRpb25zKCkKdmFyIHJldmVyc2VCb29sT3B0aW9uTWFwID0gewoJCSJ1aS1zaGFkb3ciIDogInNoYWRvdyIsCgkJInVpLWNvcm5lci1hbGwiIDogImNvcm5lcnMiLAoJCSJ1aS1idG4taW5saW5lIiA6ICJpbmxpbmUiLAoJCSJ1aS1zaGFkb3ctaWNvbiIgOiAiaWNvbnNoYWRvdyIsIC8qIFRPRE86IFJlbW92ZSBpbiAxLjUgKi8KCQkidWktbWluaSIgOiAibWluaSIKCX0sCglnZXRBdHRyRml4ZWQgPSBmdW5jdGlvbigpIHsKCQl2YXIgcmV0ID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCgkJcmV0dXJuICggcmV0ID09IG51bGwgPyB1bmRlZmluZWQgOiByZXQgKTsKCX0sCgljYXBpdGFsTGV0dGVyc1JFID0gL1tBLVpdL2c7CgovLyBvcHRpb25zVG9DbGFzc2VzOgovLyBAb3B0aW9uczogQSBjb21wbGV0ZSBzZXQgb2Ygb3B0aW9ucyB0byBjb252ZXJ0IHRvIGNsYXNzIG5hbWVzLgovLyBAZXhpc3RpbmdDbGFzc2VzOiBleHRyYSBjbGFzc2VzIHRvIGFkZCB0byB0aGUgcmVzdWx0Ci8vCi8vIENvbnZlcnRzIEBvcHRpb25zIHRvIGJ1dHRvbk1hcmt1cCBjbGFzc2VzIGFuZCByZXR1cm5zIHRoZSByZXN1bHQgYXMgYW4gYXJyYXkKLy8gdGhhdCBjYW4gYmUgY29udmVydGVkIHRvIGFuIGVsZW1lbnQncyBjbGFzc05hbWUgd2l0aCAuam9pbiggIiAiICkuIEFsbAovLyBwb3NzaWJsZSBvcHRpb25zIG11c3QgYmUgc2V0IGluc2lkZSBAb3B0aW9ucy4gVXNlICQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzCi8vIHRvIGdldCBhIGNvbXBsZXRlIHNldCBhbmQgdXNlICQuZXh0ZW5kIHRvIG92ZXJyaWRlIHlvdXIgY2hvaWNlIG9mIG9wdGlvbnMKLy8gZnJvbSB0aGF0IHNldC4KZnVuY3Rpb24gb3B0aW9uc1RvQ2xhc3Nlcyggb3B0aW9ucywgZXhpc3RpbmdDbGFzc2VzICkgewoJdmFyIGNsYXNzZXMgPSBleGlzdGluZ0NsYXNzZXMgPyBleGlzdGluZ0NsYXNzZXMgOiBbXTsKCgkvLyBBZGQgY2xhc3NlcyB0byB0aGUgYXJyYXkgLSBmaXJzdCB1aS1idG4KCWNsYXNzZXMucHVzaCggInVpLWJ0biIgKTsKCgkvLyBJZiB0aGVyZSBpcyBhIHRoZW1lCglpZiAoIG9wdGlvbnMudGhlbWUgKSB7CgkJY2xhc3Nlcy5wdXNoKCAidWktYnRuLSIgKyBvcHRpb25zLnRoZW1lICk7Cgl9CgoJLy8gSWYgdGhlcmUncyBhbiBpY29uLCBhZGQgdGhlIGljb24tcmVsYXRlZCBjbGFzc2VzCglpZiAoIG9wdGlvbnMuaWNvbiApIHsKCQljbGFzc2VzID0gY2xhc3Nlcy5jb25jYXQoWwoJCQkidWktaWNvbi0iICsgb3B0aW9ucy5pY29uLAoJCQkidWktYnRuLWljb24tIiArIG9wdGlvbnMuaWNvbnBvcwoJCV0pOwoJCWlmICggb3B0aW9ucy5pY29uc2hhZG93ICkgewoJCQljbGFzc2VzLnB1c2goICJ1aS1zaGFkb3ctaWNvbiIgKTsgLyogVE9ETzogUmVtb3ZlIGluIDEuNSAqLwoJCX0KCX0KCgkvLyBBZGQgdGhlIGFwcHJvcHJpYXRlIGNsYXNzIGZvciBlYWNoIGJvb2xlYW4gb3B0aW9uCglpZiAoIG9wdGlvbnMuaW5saW5lICkgewoJCWNsYXNzZXMucHVzaCggInVpLWJ0bi1pbmxpbmUiICk7Cgl9CglpZiAoIG9wdGlvbnMuc2hhZG93ICkgewoJCWNsYXNzZXMucHVzaCggInVpLXNoYWRvdyIgKTsKCX0KCWlmICggb3B0aW9ucy5jb3JuZXJzICkgewoJCWNsYXNzZXMucHVzaCggInVpLWNvcm5lci1hbGwiICk7Cgl9CglpZiAoIG9wdGlvbnMubWluaSApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1taW5pIiApOwoJfQoKCS8vIENyZWF0ZSBhIHN0cmluZyBmcm9tIHRoZSBhcnJheSBhbmQgcmV0dXJuIGl0CglyZXR1cm4gY2xhc3NlczsKfQoKLy8gY2xhc3NOYW1lVG9PcHRpb25zOgovLyBAY2xhc3NlczogQSBzdHJpbmcgY29udGFpbmluZyBhIC5jbGFzc05hbWUtc3R5bGUgc3BhY2Utc2VwYXJhdGVkIGNsYXNzIGxpc3QKLy8KLy8gTG9vcHMgb3ZlciBAY2xhc3NlcyBhbmQgY2FsY3VsYXRlcyBhbiBvcHRpb25zIG9iamVjdCBiYXNlZCBvbiB0aGUKLy8gYnV0dG9uTWFya3VwLXJlbGF0ZWQgY2xhc3NlcyBpdCBmaW5kcy4gSXQgcmVjb3JkcyB1bnJlY29nbml6ZWQgY2xhc3NlcyBpbiBhbgovLyBhcnJheS4KLy8KLy8gUmV0dXJuczogQW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGZvbGxvd2luZyBpdGVtczoKLy8KLy8gIm9wdGlvbnMiOiBidXR0b25NYXJrdXAgb3B0aW9ucyBmb3VuZCB0byBiZSBwcmVzZW50IGJlY2F1c2Ugb2YgdGhlCi8vIHByZXNlbmNlL2Fic2VuY2Ugb2YgY29ycmVzcG9uZGluZyBjbGFzc2VzCi8vCi8vICJ1bmtub3duQ2xhc3NlcyI6IGEgc3RyaW5nIGNvbnRhaW5pbmcgYWxsIHRoZSBub24tYnV0dG9uTWFya3VwLXJlbGF0ZWQKLy8gY2xhc3NlcyBmb3VuZCBpbiBAY2xhc3NlcwovLwovLyAiYWxyZWFkeUVuaGFuY2VkIjogQSBib29sZWFuIGluZGljYXRpbmcgd2hldGhlciB0aGUgdWktYnRuIGNsYXNzIHdhcyBhbW9uZwovLyB0aG9zZSBmb3VuZCB0byBiZSBwcmVzZW50CmZ1bmN0aW9uIGNsYXNzTmFtZVRvT3B0aW9ucyggY2xhc3NlcyApIHsKCXZhciBpZHgsIG1hcCwgdW5rbm93bkNsYXNzLAoJCWFscmVhZHlFbmhhbmNlZCA9IGZhbHNlLAoJCW5vSWNvbiA9IHRydWUsCgkJbyA9IHsKCQkJaWNvbjogIiIsCgkJCWlubGluZTogZmFsc2UsCgkJCXNoYWRvdzogZmFsc2UsCgkJCWNvcm5lcnM6IGZhbHNlLAoJCQlpY29uc2hhZG93OiBmYWxzZSwKCQkJbWluaTogZmFsc2UKCQl9LAoJCXVua25vd25DbGFzc2VzID0gW107CgoJY2xhc3NlcyA9IGNsYXNzZXMuc3BsaXQoICIgIiApOwoKCS8vIExvb3Agb3ZlciB0aGUgY2xhc3NlcwoJZm9yICggaWR4ID0gMCA7IGlkeCA8IGNsYXNzZXMubGVuZ3RoIDsgaWR4KysgKSB7CgoJCS8vIEFzc3VtZSBpdCdzIGFuIHVucmVjb2duaXplZCBjbGFzcwoJCXVua25vd25DbGFzcyA9IHRydWU7CgoJCS8vIFJlY29nbml6ZSBib29sZWFuIG9wdGlvbnMgZnJvbSB0aGUgcHJlc2VuY2Ugb2YgY2xhc3NlcwoJCW1hcCA9IHJldmVyc2VCb29sT3B0aW9uTWFwWyBjbGFzc2VzWyBpZHggXSBdOwoJCWlmICggbWFwICE9PSB1bmRlZmluZWQgKSB7CgkJCXVua25vd25DbGFzcyA9IGZhbHNlOwoJCQlvWyBtYXAgXSA9IHRydWU7CgoJCS8vIFJlY29nbml6ZSB0aGUgcHJlc2VuY2Ugb2YgYW4gaWNvbiBhbmQgZXN0YWJsaXNoIHRoZSBpY29uIHBvc2l0aW9uCgkJfSBlbHNlIGlmICggY2xhc3Nlc1sgaWR4IF0uaW5kZXhPZiggInVpLWJ0bi1pY29uLSIgKSA9PT0gMCApIHsKCQkJdW5rbm93bkNsYXNzID0gZmFsc2U7CgkJCW5vSWNvbiA9IGZhbHNlOwoJCQlvLmljb25wb3MgPSBjbGFzc2VzWyBpZHggXS5zdWJzdHJpbmcoIDEyICk7CgoJCS8vIEVzdGFibGlzaCB3aGljaCBpY29uIGlzIHByZXNlbnQKCQl9IGVsc2UgaWYgKCBjbGFzc2VzWyBpZHggXS5pbmRleE9mKCAidWktaWNvbi0iICkgPT09IDAgKSB7CgkJCXVua25vd25DbGFzcyA9IGZhbHNlOwoJCQlvLmljb24gPSBjbGFzc2VzWyBpZHggXS5zdWJzdHJpbmcoIDggKTsKCgkJLy8gRXN0YWJsaXNoIHRoZSB0aGVtZSAtIHRoaXMgcmVjb2duaXplcyBvbmUtbGV0dGVyIHRoZW1lIHN3YXRjaCBuYW1lcwoJCX0gZWxzZSBpZiAoIGNsYXNzZXNbIGlkeCBdLmluZGV4T2YoICJ1aS1idG4tIiApID09PSAwICYmIGNsYXNzZXNbIGlkeCBdLmxlbmd0aCA9PT0gOCApIHsKCQkJdW5rbm93bkNsYXNzID0gZmFsc2U7CgkJCW8udGhlbWUgPSBjbGFzc2VzWyBpZHggXS5zdWJzdHJpbmcoIDcgKTsKCgkJLy8gUmVjb2duaXplIHRoYXQgdGhpcyBlbGVtZW50IGhhcyBhbHJlYWR5IGJlZW4gYnV0dG9uTWFya3VwLWVuaGFuY2VkCgkJfSBlbHNlIGlmICggY2xhc3Nlc1sgaWR4IF0gPT09ICJ1aS1idG4iICkgewoJCQl1bmtub3duQ2xhc3MgPSBmYWxzZTsKCQkJYWxyZWFkeUVuaGFuY2VkID0gdHJ1ZTsKCQl9CgoJCS8vIElmIHRoaXMgY2xhc3MgaGFzIG5vdCBiZWVuIHJlY29nbml6ZWQsIGFkZCBpdCB0byB0aGUgbGlzdAoJCWlmICggdW5rbm93bkNsYXNzICkgewoJCQl1bmtub3duQ2xhc3Nlcy5wdXNoKCBjbGFzc2VzWyBpZHggXSApOwoJCX0KCX0KCgkvLyBJZiBhICJ1aS1idG4taWNvbi0qIiBpY29uIHBvc2l0aW9uIGNsYXNzIGlzIGFic2VudCB0aGVyZSBjYW5ub3QgYmUgYW4gaWNvbgoJaWYgKCBub0ljb24gKSB7CgkJby5pY29uID0gIiI7Cgl9CgoJcmV0dXJuIHsKCQlvcHRpb25zOiBvLAoJCXVua25vd25DbGFzc2VzOiB1bmtub3duQ2xhc3NlcywKCQlhbHJlYWR5RW5oYW5jZWQ6IGFscmVhZHlFbmhhbmNlZAoJfTsKfQoKZnVuY3Rpb24gY2FtZWxDYXNlMkh5cGhlbmF0ZWQoIGMgKSB7CglyZXR1cm4gIi0iICsgYy50b0xvd2VyQ2FzZSgpOwp9CgovLyAkLmZuLmJ1dHRvbk1hcmt1cDoKLy8gRE9NOiBnZXRzL3NldHMgLmNsYXNzTmFtZQovLwovLyBAb3B0aW9uczogb3B0aW9ucyB0byBhcHBseSB0byB0aGUgZWxlbWVudHMgaW4gdGhlIGpRdWVyeSBvYmplY3QKLy8gQG92ZXJ3cml0ZUNsYXNzZXM6IGJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIHRvIGhvbm91ciBleGlzdGluZyBjbGFzc2VzCi8vCi8vIENhbGN1bGF0ZXMgdGhlIGNsYXNzZXMgdG8gYXBwbHkgdG8gdGhlIGVsZW1lbnRzIGluIHRoZSBqUXVlcnkgb2JqZWN0IGJhc2VkIG9uCi8vIHRoZSBvcHRpb25zIHBhc3NlZCBpbi4gSWYgQG92ZXJ3cml0ZUNsYXNzZXMgaXMgdHJ1ZSwgaXQgc2V0cyB0aGUgY2xhc3NOYW1lCi8vIHByb3BlcnR5IG9mIGVhY2ggZWxlbWVudCBpbiB0aGUgalF1ZXJ5IG9iamVjdCB0byB0aGUgYnV0dG9uTWFya3VwIGNsYXNzZXMKLy8gaXQgY2FsY3VsYXRlcyBiYXNlZCBvbiB0aGUgb3B0aW9ucyBwYXNzZWQgaW4uCi8vCi8vIElmIHlvdSB3aXNoIHRvIHByZXNlcnZlIGFueSBjbGFzc2VzIHRoYXQgYXJlIGFscmVhZHkgcHJlc2VudCBvbiB0aGUgZWxlbWVudHMKLy8gaW5zaWRlIHRoZSBqUXVlcnkgb2JqZWN0LCBpbmNsdWRpbmcgYnV0dG9uTWFya3VwLXJlbGF0ZWQgY2xhc3NlcyB0aGF0IHdlcmUKLy8gYWRkZWQgYnkgYSBwcmV2aW91cyBjYWxsIHRvICQuZm4uYnV0dG9uTWFya3VwKCkgb3IgZHVyaW5nIHBhZ2UgZW5oYW5jZW1lbnQKLy8gdGhlbiB5b3Ugc2hvdWxkIG9taXQgQG92ZXJ3cml0ZUNsYXNzZXMgb3Igc2V0IGl0IHRvIGZhbHNlLgokLmZuLmJ1dHRvbk1hcmt1cCA9IGZ1bmN0aW9uKCBvcHRpb25zLCBvdmVyd3JpdGVDbGFzc2VzICkgewoJdmFyIGlkeCwgZGF0YSwgZWwsIHJldHJpZXZlZE9wdGlvbnMsIG9wdGlvbktleSwKCQlkZWZhdWx0cyA9ICQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzOwoKCWZvciAoIGlkeCA9IDAgOyBpZHggPCB0aGlzLmxlbmd0aCA7IGlkeCsrICkgewoJCWVsID0gdGhpc1sgaWR4IF07CgkJZGF0YSA9IG92ZXJ3cml0ZUNsYXNzZXMgPwoKCQkJLy8gQXNzdW1lIHRoaXMgZWxlbWVudCBpcyBub3QgZW5oYW5jZWQgYW5kIGlnbm9yZSBpdHMgY2xhc3NlcwoJCQl7IGFscmVhZHlFbmhhbmNlZDogZmFsc2UsIHVua25vd25DbGFzc2VzOiBbXSB9IDoKCgkJCS8vIE90aGVyd2lzZSBhbmFseXplIGV4aXN0aW5nIGNsYXNzZXMgdG8gZXN0YWJsaXNoIGV4aXN0aW5nIG9wdGlvbnMgYW5kCgkJCS8vIGNsYXNzZXMKCQkJY2xhc3NOYW1lVG9PcHRpb25zKCBlbC5jbGFzc05hbWUgKTsKCgkJcmV0cmlldmVkT3B0aW9ucyA9ICQuZXh0ZW5kKCB7fSwKCgkJCS8vIElmIHRoZSBlbGVtZW50IGFscmVhZHkgaGFzIHRoZSBjbGFzcyB1aS1idG4sIHRoZW4gd2UgYXNzdW1lIHRoYXQKCQkJLy8gaXQgaGFzIHBhc3NlZCB0aHJvdWdoIGJ1dHRvbk1hcmt1cCBiZWZvcmUgLSBvdGhlcndpc2UsIHRoZSBvcHRpb25zCgkJCS8vIHJldHVybmVkIGJ5IGNsYXNzTmFtZVRvT3B0aW9ucyBkbyBub3QgY29ycmVjdGx5IHJlZmxlY3QgdGhlIHN0YXRlIG9mCgkJCS8vIHRoZSBlbGVtZW50CgkJCSggZGF0YS5hbHJlYWR5RW5oYW5jZWQgPyBkYXRhLm9wdGlvbnMgOiB7fSApLAoKCQkJLy8gRmluYWxseSwgYXBwbHkgdGhlIG9wdGlvbnMgcGFzc2VkIGluCgkJCW9wdGlvbnMgKTsKCgkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgY2FsbCBvbiB0aGlzIGVsZW1lbnQsIHJldHJpZXZlIHJlbWFpbmluZyBvcHRpb25zCgkJLy8gZnJvbSB0aGUgZGF0YS1hdHRyaWJ1dGVzCgkJaWYgKCAhZGF0YS5hbHJlYWR5RW5oYW5jZWQgKSB7CgkJCWZvciAoIG9wdGlvbktleSBpbiBkZWZhdWx0cyApIHsKCQkJCWlmICggcmV0cmlldmVkT3B0aW9uc1sgb3B0aW9uS2V5IF0gPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXRyaWV2ZWRPcHRpb25zWyBvcHRpb25LZXkgXSA9IGdldEF0dHJGaXhlZCggZWwsCgkJCQkJCW9wdGlvbktleS5yZXBsYWNlKCBjYXBpdGFsTGV0dGVyc1JFLCBjYW1lbENhc2UySHlwaGVuYXRlZCApCgkJCQkJKTsKCQkJCX0KCQkJfQoJCX0KCgkJZWwuY2xhc3NOYW1lID0gb3B0aW9uc1RvQ2xhc3NlcygKCgkJCS8vIE1lcmdlIGFsbCB0aGUgb3B0aW9ucyBhbmQgYXBwbHkgdGhlbSBhcyBjbGFzc2VzCgkJCSQuZXh0ZW5kKCB7fSwKCgkJCQkvLyBUaGUgZGVmYXVsdHMgZm9ybSB0aGUgYmFzaXMKCQkJCWRlZmF1bHRzLAoKCQkJCS8vIEFkZCB0aGUgY29tcHV0ZWQgb3B0aW9ucwoJCQkJcmV0cmlldmVkT3B0aW9ucwoJCQkpLAoKCQkJLy8gLi4uIGFuZCByZS1hcHBseSBhbnkgdW5yZWNvZ25pemVkIGNsYXNzZXMgdGhhdCB3ZXJlIGZvdW5kCgkJCWRhdGEudW5rbm93bkNsYXNzZXMgKS5qb2luKCAiICIgKTsKCQllbC5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgImJ1dHRvbiIgKTsKCX0KCglyZXR1cm4gdGhpczsKfTsKCi8vIGJ1dHRvbk1hcmt1cCBkZWZhdWx0cy4gVGhpcyBtdXN0IGJlIGEgY29tcGxldGUgc2V0LCBpLmUuLCBhIHZhbHVlIG11c3QgYmUKLy8gZ2l2ZW4gaGVyZSBmb3IgYWxsIHJlY29nbml6ZWQgb3B0aW9ucwokLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0cyA9IHsKCWljb246ICIiLAoJaWNvbnBvczogImxlZnQiLAoJdGhlbWU6IG51bGwsCglpbmxpbmU6IGZhbHNlLAoJc2hhZG93OiB0cnVlLAoJY29ybmVyczogdHJ1ZSwKCWljb25zaGFkb3c6IGZhbHNlLCAvKiBUT0RPOiBSZW1vdmUgaW4gMS41LiBPcHRpb24gZGVwcmVjYXRlZCBpbiAxLjQuICovCgltaW5pOiBmYWxzZQp9OwoKJC5leHRlbmQoICQuZm4uYnV0dG9uTWFya3VwLCB7Cglpbml0U2VsZWN0b3I6ICJhOmpxbURhdGEocm9sZT0nYnV0dG9uJyksIC51aS1iYXIgPiBhLCAudWktYmFyID4gOmpxbURhdGEocm9sZT0nY29udHJvbGdyb3VwJykgPiBhLCBidXR0b24iCn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29udHJvbGdyb3VwIiwgJC5leHRlbmQoIHsKCW9wdGlvbnM6IHsKCQllbmhhbmNlZDogZmFsc2UsCgkJdGhlbWU6IG51bGwsCgkJc2hhZG93OiBmYWxzZSwKCQljb3JuZXJzOiB0cnVlLAoJCWV4Y2x1ZGVJbnZpc2libGU6IHRydWUsCgkJdHlwZTogInZlcnRpY2FsIiwKCQltaW5pOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJLy8gUnVuIGJ1dHRvbm1hcmt1cAoJCWlmKCAkLm1vYmlsZS5lbmhhbmNlV2l0aEJ1dHRvbk1hcmt1cCApewoJCQl0aGlzLmVsZW1lbnQuZmluZCggJC5tb2JpbGUuZW5oYW5jZVdpdGhCdXR0b25NYXJrdXAuaW5pdFNlbGVjdG9yICkuZWFjaCggJC5tb2JpbGUuZW5oYW5jZVdpdGhCdXR0b25NYXJrdXAgKTsKCQl9CgkJLy8gRW5oYW5jZSBjaGlsZCB3aWRnZXRzCgkJJC5lYWNoKCB0aGlzLl9jaGlsZFdpZGdldHMsICQucHJveHkoIGZ1bmN0aW9uKCBudW1iZXIsIHdpZGdldE5hbWUgKSB7CgkJCWlmKCAkLm1vYmlsZVsgd2lkZ2V0TmFtZSBdICkgewoJCQkJdGhpcy5lbGVtZW50LmZpbmQoICQubW9iaWxlWyB3aWRnZXROYW1lIF0uaW5pdFNlbGVjdG9yIClbIHdpZGdldE5hbWUgXSgpOwoJCQl9CgkJfSwgdGhpcyApKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3VpOiBudWxsLAoJCQlfaW5pdGlhbFJlZnJlc2g6IHRydWUKCQl9KTsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQl0aGlzLl91aSA9IHsKCQkJCWdyb3VwTGVnZW5kOiBlbGVtLmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1sYWJlbCIgKS5jaGlsZHJlbigpLAoJCQkJY2hpbGRXcmFwcGVyOiBlbGVtLmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1jb250cm9scyIgKQoJCQl9OwoJCX0gZWxzZSB7CgkJCXRoaXMuX3VpID0gdGhpcy5fZW5oYW5jZSgpOwoJCX0KCQkKCX0sCgoJX2NoaWxkV2lkZ2V0czogWyAiY2hlY2tib3hyYWRpbyIsICJzZWxlY3RtZW51IiwgImJ1dHRvbiIgXSwKCglfdGhlbWVDbGFzc0Zyb21PcHRpb246IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlyZXR1cm4gKCB2YWx1ZSA/ICggdmFsdWUgPT09ICJub25lIiA/ICIiIDogInVpLWdyb3VwLXRoZW1lLSIgKyB2YWx1ZSApIDogIiIgKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQlvcHRzID0gdGhpcy5vcHRpb25zLAoJCQl1aSA9IHsKCQkJCWdyb3VwTGVnZW5kOiBlbGVtLmNoaWxkcmVuKCAibGVnZW5kIiApLAoJCQkJY2hpbGRXcmFwcGVyOiBlbGVtCgkJCQkJLmFkZENsYXNzKCAidWktY29udHJvbGdyb3VwICIgKwoJCQkJCQkidWktY29udHJvbGdyb3VwLSIgKwoJCQkJCQkJKCBvcHRzLnR5cGUgPT09ICJob3Jpem9udGFsIiA/ICJob3Jpem9udGFsIiA6ICJ2ZXJ0aWNhbCIgKSArICIgIiArCgkJCQkJCXRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCBvcHRzLnRoZW1lICkgKyAiICIgKwoJCQkJCQkoIG9wdHMuY29ybmVycyA/ICJ1aS1jb3JuZXItYWxsICIgOiAiIiApICsKCQkJCQkJKCBvcHRzLm1pbmkgPyAidWktbWluaSAiIDogIiIgKSApCgkJCQkJLndyYXBJbm5lciggIjxkaXYgIiArCgkJCQkJCSJjbGFzcz0ndWktY29udHJvbGdyb3VwLWNvbnRyb2xzICIgKwoJCQkJCQkJKCBvcHRzLnNoYWRvdyA9PT0gdHJ1ZSA/ICJ1aS1zaGFkb3ciIDogIiIgKSArICInPjwvZGl2PiIgKQoJCQkJCS5jaGlsZHJlbigpCgkJCX07CgoJCWlmICggdWkuZ3JvdXBMZWdlbmQubGVuZ3RoID4gMCApIHsKCQkJJCggIjxkaXYgcm9sZT0naGVhZGluZycgY2xhc3M9J3VpLWNvbnRyb2xncm91cC1sYWJlbCc+PC9kaXY+IiApCgkJCQkuYXBwZW5kKCB1aS5ncm91cExlZ2VuZCApCgkJCQkucHJlcGVuZFRvKCBlbGVtICk7CgkJfQoKCQlyZXR1cm4gdWk7Cgl9LAoKCV9pbml0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBjYWxsUmVmcmVzaCwKCQkJZWxlbSA9IHRoaXMuZWxlbWVudDsKCgkJLy8gTXVzdCBoYXZlIG9uZSBvZiBob3Jpem9udGFsIG9yIHZlcnRpY2FsCgkJaWYgKCBvcHRpb25zLnR5cGUgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbQoJCQkJLnJlbW92ZUNsYXNzKCAidWktY29udHJvbGdyb3VwLWhvcml6b250YWwgdWktY29udHJvbGdyb3VwLXZlcnRpY2FsIiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1jb250cm9sZ3JvdXAtIiArICggb3B0aW9ucy50eXBlID09PSAiaG9yaXpvbnRhbCIgPyAiaG9yaXpvbnRhbCIgOiAidmVydGljYWwiICkgKTsKCQkJY2FsbFJlZnJlc2ggPSB0cnVlOwoJCX0KCgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCWVsZW0KCQkJCS5yZW1vdmVDbGFzcyggdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oIHRoaXMub3B0aW9ucy50aGVtZSApICkKCQkJCS5hZGRDbGFzcyggdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oIG9wdGlvbnMudGhlbWUgKSApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBvcHRpb25zLmNvcm5lcnMgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCWVsZW0udG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgb3B0aW9ucy5taW5pICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuc2hhZG93ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3VpLmNoaWxkV3JhcHBlci50b2dnbGVDbGFzcyggInVpLXNoYWRvdyIsIG9wdGlvbnMuc2hhZG93ICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuZXhjbHVkZUludmlzaWJsZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLm9wdGlvbnMuZXhjbHVkZUludmlzaWJsZSA9IG9wdGlvbnMuZXhjbHVkZUludmlzaWJsZTsKCQkJY2FsbFJlZnJlc2ggPSB0cnVlOwoJCX0KCgkJaWYgKCBjYWxsUmVmcmVzaCApIHsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJfQoKCQlyZXR1cm4gdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0sCgoJY29udGFpbmVyOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fdWkuY2hpbGRXcmFwcGVyOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gdGhpcy5jb250YWluZXIoKSwKCQkJZWxzID0gJGVsLmZpbmQoICIudWktYnRuIiApLm5vdCggIi51aS1zbGlkZXItaGFuZGxlIiApLAoJCQljcmVhdGUgPSB0aGlzLl9pbml0aWFsUmVmcmVzaDsKCQlpZiAoICQubW9iaWxlLmNoZWNrYm94cmFkaW8gKSB7CgkJCSRlbC5maW5kKCAiOm1vYmlsZS1jaGVja2JveHJhZGlvIiApLmNoZWNrYm94cmFkaW8oICJyZWZyZXNoIiApOwoJCX0KCQl0aGlzLl9hZGRGaXJzdExhc3RDbGFzc2VzKCBlbHMsCgkJCXRoaXMub3B0aW9ucy5leGNsdWRlSW52aXNpYmxlID8gdGhpcy5fZ2V0VmlzaWJsZXMoIGVscywgY3JlYXRlICkgOiBlbHMsCgkJCWNyZWF0ZSApOwoJCXRoaXMuX2luaXRpYWxSZWZyZXNoID0gZmFsc2U7Cgl9LAoKCS8vIENhdmVhdDogSWYgdGhlIGxlZ2VuZCBpcyBub3QgdGhlIGZpcnN0IGNoaWxkIG9mIHRoZSBjb250cm9sZ3JvdXAgYXQgZW5oYW5jZQoJLy8gdGltZSwgaXQgd2lsbCBiZSBhZnRlciBfZGVzdHJveSgpLgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciB1aSwgYnV0dG9ucywKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXVpID0gdGhpcy5fdWk7CgkJYnV0dG9ucyA9IHRoaXMuZWxlbWVudAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb250cm9sZ3JvdXAgIiArCgkJCQkidWktY29udHJvbGdyb3VwLWhvcml6b250YWwgdWktY29udHJvbGdyb3VwLXZlcnRpY2FsIHVpLWNvcm5lci1hbGwgdWktbWluaSAiICsKCQkJCXRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCBvcHRzLnRoZW1lICkgKQoJCQkuZmluZCggIi51aS1idG4iICkKCQkJLm5vdCggIi51aS1zbGlkZXItaGFuZGxlIiApOwoKCQl0aGlzLl9yZW1vdmVGaXJzdExhc3RDbGFzc2VzKCBidXR0b25zICk7CgoJCXVpLmdyb3VwTGVnZW5kLnVud3JhcCgpOwoJCXVpLmNoaWxkV3JhcHBlci5jaGlsZHJlbigpLnVud3JhcCgpOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyApICk7Cgp9KShqUXVlcnkpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoKCSQud2lkZ2V0KCAibW9iaWxlLnRvb2xiYXIiLCB7CgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nZm9vdGVyJyksIDpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiwKCgkJb3B0aW9uczogewoJCQl0aGVtZTogbnVsbCwKCQkJYWRkQmFja0J0bjogZmFsc2UsCgkJCWJhY2tCdG5UaGVtZTogbnVsbCwKCQkJYmFja0J0blRleHQ6ICJCYWNrIgoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbGVmdGJ0biwgcmlnaHRidG4sIGJhY2tCdG4sCgkJCQlyb2xlID0gIHRoaXMuZWxlbWVudC5pcyggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApID8gImhlYWRlciIgOiAiZm9vdGVyIiwKCQkJCXBhZ2UgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICl7CgkJCQlwYWdlID0gZmFsc2U7CgkJCQl0aGlzLl9vbiggJC5tb2JpbGUuZG9jdW1lbnQsIHsKCQkJCQkicGFnZXNob3ciOiAicmVmcmVzaCIKCQkJCX0pOwoJCQl9CgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlyb2xlOiByb2xlLAoJCQkJcGFnZTogcGFnZSwKCQkJCWxlZnRidG46IGxlZnRidG4sCgkJCQlyaWdodGJ0bjogcmlnaHRidG4sCgkJCQliYWNrQnRuOiBiYWNrQnRuCgkJCX0pOwoJCQl0aGlzLmVsZW1lbnQuYXR0ciggInJvbGUiLCByb2xlID09PSAiaGVhZGVyIiA/ICJiYW5uZXIiIDogImNvbnRlbnRpbmZvIiApLmFkZENsYXNzKCAidWktIiArIHJvbGUgKTsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJCXRoaXMuX3NldE9wdGlvbnMoIHRoaXMub3B0aW9ucyApOwoJCX0sCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvICkgewoJCQlpZiAoIG8uYWRkQmFja0J0biAhPT0gdW5kZWZpbmVkICkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuYWRkQmFja0J0biAmJgoJCQkJCXRoaXMucm9sZSA9PT0gImhlYWRlciIgJiYKCQkJCQkkKCAiLnVpLXBhZ2UiICkubGVuZ3RoID4gMSAmJgoJCQkJCXRoaXMucGFnZVsgMCBdLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIgKSAhPT0gJC5tb2JpbGUucGF0aC5zdHJpcEhhc2goIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJCSF0aGlzLmxlZnRidG4gKSB7CgkJCQkJCXRoaXMuX2FkZEJhY2tCdXR0b24oKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5lbGVtZW50LmZpbmQoICIudWktdG9vbGJhci1iYWNrLWJ0biIgKS5yZW1vdmUoKTsKCQkJCX0KCQkJfQoJCQlpZiAoIG8uYmFja0J0blRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLmVsZW1lbnQKCQkJCQkuZmluZCggIi51aS10b29sYmFyLWJhY2stYnRuIiApCgkJCQkJLmFkZENsYXNzKCAidWktYnRuIHVpLWJ0bi0iICsgby5iYWNrQnRuVGhlbWUgKTsKCQkJfQoJCQlpZiAoIG8uYmFja0J0blRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXRvb2xiYXItYmFjay1idG4gLnVpLWJ0bi10ZXh0IiApLnRleHQoIG8uYmFja0J0blRleHQgKTsKCQkJfQoJCQlpZiAoIG8udGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXZhciBjdXJyZW50VGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUgPyB0aGlzLm9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIsCgkJCQkJbmV3VGhlbWUgPSBvLnRoZW1lID8gby50aGVtZSA6ICJpbmhlcml0IjsKCgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1iYXItIiArIGN1cnJlbnRUaGVtZSApLmFkZENsYXNzKCAidWktYmFyLSIgKyBuZXdUaGVtZSApOwoJCQl9CgoJCQl0aGlzLl9zdXBlciggbyApOwoJCX0sCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy5yb2xlID09PSAiaGVhZGVyIiApIHsKCQkJCXRoaXMuX2FkZEhlYWRlckJ1dHRvbkNsYXNzZXMoKTsKCQkJfQoJCQlpZiAoICF0aGlzLnBhZ2UgKSB7CgkJCQkkKCAiW2RhdGEtIisgJC5tb2JpbGUubnMgKyJyb2xlPSdwYWdlJ10iICkuY3NzKHsicG9zaXRpb24iOiJyZWxhdGl2ZSJ9KTsKCQkJCWlmICggdGhpcy5yb2xlID09PSAiZm9vdGVyIiApIHsKCQkJCQl0aGlzLmVsZW1lbnQuYXBwZW5kVG8oICJib2R5IiApOwoJCQkJfQoJCQl9CgkJCXRoaXMuX2FkZEhlYWRpbmdDbGFzc2VzKCk7CgkJCXRoaXMuX2J0bk1hcmt1cCgpOwoJCX0sCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQuIEFzIGZyb20gMS41IGRhdGEtcm9sZT0iYnV0dG9uIiBoYXMgdG8gYmUgcHJlc2VudCBpbiB0aGUgbWFya3VwLgoJCV9idG5NYXJrdXA6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICJhIiApLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlIiwgImJ1dHRvbiIgKTsKCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJjcmVhdGUiICk7CgkJfSwKCQlfYWRkSGVhZGVyQnV0dG9uQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJCXZhciAkaGVhZGVyYW5jaG9ycyA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbiggImEsIGJ1dHRvbiIgKTsKCQkJdGhpcy5sZWZ0YnRuID0gJGhlYWRlcmFuY2hvcnMuaGFzQ2xhc3MoICJ1aS1idG4tbGVmdCIgKTsKCQkJdGhpcy5yaWdodGJ0biA9ICRoZWFkZXJhbmNob3JzLmhhc0NsYXNzKCAidWktYnRuLXJpZ2h0IiApOwoKCQkJdGhpcy5sZWZ0YnRuID0gdGhpcy5sZWZ0YnRuIHx8ICRoZWFkZXJhbmNob3JzLmVxKCAwICkubm90KCAiLnVpLWJ0bi1yaWdodCIgKS5hZGRDbGFzcyggInVpLWJ0bi1sZWZ0IiApLmxlbmd0aDsKCgkJCXRoaXMucmlnaHRidG4gPSB0aGlzLnJpZ2h0YnRuIHx8ICRoZWFkZXJhbmNob3JzLmVxKCAxICkuYWRkQ2xhc3MoICJ1aS1idG4tcmlnaHQiICkubGVuZ3RoOwoKCQl9LAoJCV9hZGRCYWNrQnV0dG9uOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5iYWNrQnRuID0gJCggIjxhIHJvbGU9J2J1dHRvbicgaHJlZj0namF2YXNjcmlwdDp2b2lkKDApOycgY2xhc3M9J3VpLWJ0bi1sZWZ0IHVpLXRvb2xiYXItYmFjay1idG4nIGRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbD0nYmFjaycgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbj0nY2FyYXQtbCc+IiArIHRoaXMub3B0aW9ucy5iYWNrQnRuVGV4dCArICI8L2E+IiApCgkJCQkJLy8gSWYgdGhlbWUgaXMgcHJvdmlkZWQsIG92ZXJyaWRlIGRlZmF1bHQgaW5oZXJpdGFuY2UKCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lIiwgdGhpcy5vcHRpb25zLmJhY2tCdG5UaGVtZSB8fCB0aGlzLm9wdGlvbnMudGhlbWUgKQoJCQkJCS5wcmVwZW5kVG8oIHRoaXMuZWxlbWVudCApOwoJCX0sCgkJX2FkZEhlYWRpbmdDbGFzc2VzOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiaDEsIGgyLCBoMywgaDQsIGg1LCBoNiIgKQoJCQkJLmFkZENsYXNzKCAidWktdGl0bGUiICkKCQkJCS8vIFJlZ2FyZGxlc3Mgb2YgaCBlbGVtZW50IG51bWJlciBpbiBzcmMsIGl0IGJlY29tZXMgaDEgZm9yIHRoZSBlbmhhbmNlZCBwYWdlCgkJCQkuYXR0cih7CgkJCQkJInJvbGUiOiAiaGVhZGluZyIsCgkJCQkJImFyaWEtbGV2ZWwiOiAiMSIKCQkJCX0pOwoJCX0KCX0pOwoJCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCgkkLndpZGdldCggIm1vYmlsZS50b29sYmFyIiwgJC5tb2JpbGUudG9vbGJhciwgewoJCW9wdGlvbnM6IHsKCQkJcG9zaXRpb246bnVsbCwKCQkJdmlzaWJsZU9uUGFnZVNob3c6IHRydWUsCgkJCWRpc2FibGVQYWdlWm9vbTogdHJ1ZSwKCQkJdHJhbnNpdGlvbjogInNsaWRlIiwgLy9jYW4gYmUgbm9uZSwgZmFkZSwgc2xpZGUgKHNsaWRlIG1hcHMgdG8gc2xpZGV1cCBvciBzbGlkZWRvd24pCgkJCWZ1bGxzY3JlZW46IGZhbHNlLAoJCQl0YXBUb2dnbGU6IHRydWUsCgkJCXRhcFRvZ2dsZUJsYWNrbGlzdDogImEsIGJ1dHRvbiwgaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEsIC51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQsIC51aS1wb3B1cCwgLnVpLXBhbmVsLCAudWktcGFuZWwtZGlzbWlzcy1vcGVuIiwKCQkJaGlkZUR1cmluZ0ZvY3VzOiAiaW5wdXQsIHRleHRhcmVhLCBzZWxlY3QiLAoJCQl1cGRhdGVQYWdlUGFkZGluZzogdHJ1ZSwKCQkJdHJhY2tQZXJzaXN0ZW50VG9vbGJhcnM6IHRydWUsCgoJCQkvLyBCcm93c2VyIGRldGVjdGlvbiEgV2VlZWUsIGhlcmUgd2UgZ28uLi4KCQkJLy8gVW5mb3J0dW5hdGVseSwgcG9zaXRpb246Zml4ZWQgaXMgY29zdGx5LCBub3QgdG8gbWVudGlvbiBwcm9iYWJseSBpbXBvc3NpYmxlLCB0byBmZWF0dXJlLWRldGVjdCBhY2N1cmF0ZWx5LgoJCQkvLyBTb21lIHRlc3RzIGV4aXN0LCBidXQgdGhleSBjdXJyZW50bHkgcmV0dXJuIGZhbHNlIHJlc3VsdHMgaW4gY3JpdGljYWwgZGV2aWNlcyBhbmQgYnJvd3NlcnMsIHdoaWNoIGNvdWxkIGxlYWQgdG8gYSBicm9rZW4gZXhwZXJpZW5jZS4KCQkJLy8gVGVzdGluZyBmaXhlZCBwb3NpdGlvbmluZyBpcyBhbHNvIHByZXR0eSBvYnRydXNpdmUgdG8gcGFnZSBsb2FkLCByZXF1aXJpbmcgaW5qZWN0ZWQgZWxlbWVudHMgYW5kIHNjcm9sbGluZyB0aGUgd2luZG93CgkJCS8vIFRoZSBmb2xsb3dpbmcgZnVuY3Rpb24gc2VydmVzIHRvIHJ1bGUgb3V0IHNvbWUgcG9wdWxhciBicm93c2VycyB3aXRoIGtub3duIGZpeGVkLXBvc2l0aW9uaW5nIGlzc3VlcwoJCQkvLyBUaGlzIGlzIGEgcGx1Z2luIG9wdGlvbiBsaWtlIGFueSBvdGhlciwgc28gZmVlbCBmcmVlIHRvIGltcHJvdmUgb3Igb3ZlcndyaXRlIGl0CgkJCXN1cHBvcnRCbGFja2xpc3Q6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICEkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbjsKCQkJfQoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQlpZiAoIHRoaXMub3B0aW9ucy5wb3NpdGlvbiA9PT0gImZpeGVkIiAmJiAhdGhpcy5vcHRpb25zLnN1cHBvcnRCbGFja2xpc3QoKSApewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktIisgdGhpcy5yb2xlICsiLWZpeGVkIiApOwoJCQkJdGhpcy51cGRhdGVQYWdlUGFkZGluZygpOwoJCQkJdGhpcy5fYWRkVHJhbnNpdGlvbkNsYXNzKCk7CgkJCQl0aGlzLl9iaW5kUGFnZUV2ZW50cygpOwoJCQkJdGhpcy5fYmluZFRvZ2dsZUhhbmRsZXJzKCk7CgkJCQl0aGlzLl9zZXRPcHRpb25zKCB0aGlzLm9wdGlvbnMgKTsKCQkJfQoJCX0sCgoJCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggbyApewoJCQlpZiAoIHRoaXMub3B0aW9ucy5wb3NpdGlvbiA9PT0gImZpeGVkIiAmJiAhdGhpcy5vcHRpb25zLnN1cHBvcnRCbGFja2xpc3QoKSApewoJCQkJdmFyICRwYWdlID0gKCAhIXRoaXMucGFnZSApPyB0aGlzLnBhZ2U6ICggJCgiLnVpLXBhZ2UtYWN0aXZlIikubGVuZ3RoID4gMCApPyAkKCIudWktcGFnZS1hY3RpdmUiKTogJCgiLnVpLXBhZ2UiKS5lcSgwKTsKCgkJCQlpZiAoIG8uZnVsbHNjcmVlbiAhPT0gdW5kZWZpbmVkKXsKCQkJCQlpZiAoIG8uZnVsbHNjcmVlbiApIHsKCQkJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktIisgdGhpcy5yb2xlICsiLWZ1bGxzY3JlZW4iICk7CgkJCQkJCSRwYWdlLmFkZENsYXNzKCAidWktcGFnZS0iICsgdGhpcy5yb2xlICsgIi1mdWxsc2NyZWVuIiApOwoJCQkJCX0KCQkJCQkvLyBJZiBub3QgZnVsbHNjcmVlbiwgYWRkIGNsYXNzIHRvIHBhZ2UgdG8gc2V0IHRvcCBvciBib3R0b20gcGFkZGluZwoJCQkJCWVsc2UgewoJCQkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS0iKyB0aGlzLnJvbGUgKyItZnVsbHNjcmVlbiIgKTsKCQkJCQkJJHBhZ2UucmVtb3ZlQ2xhc3MoICJ1aS1wYWdlLSIgKyB0aGlzLnJvbGUgKyAiLWZ1bGxzY3JlZW4iICkuYWRkQ2xhc3MoICJ1aS1wYWdlLSIgKyB0aGlzLnJvbGUrICItZml4ZWQiICk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJCXRoaXMuX3N1cGVyKG8pOwoJCX0sCgoJCV9hZGRUcmFuc2l0aW9uQ2xhc3M6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdGNsYXNzID0gdGhpcy5vcHRpb25zLnRyYW5zaXRpb247CgoJCQlpZiAoIHRjbGFzcyAmJiB0Y2xhc3MgIT09ICJub25lIiApIHsKCQkJCS8vIHVzZSBhcHByb3ByaWF0ZSBzbGlkZSBmb3IgaGVhZGVyIG9yIGZvb3RlcgoJCQkJaWYgKCB0Y2xhc3MgPT09ICJzbGlkZSIgKSB7CgkJCQkJdGNsYXNzID0gdGhpcy5lbGVtZW50Lmhhc0NsYXNzKCAidWktaGVhZGVyIiApID8gInNsaWRlZG93biIgOiAic2xpZGV1cCI7CgkJCQl9CgoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0Y2xhc3MgKTsKCQkJfQoJCX0sCgoJCV9iaW5kUGFnZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJCXZhciBwYWdlID0gKCAhIXRoaXMucGFnZSApPyB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApOiAkLm1vYmlsZS5kb2N1bWVudDsKCQkJLy9wYWdlIGV2ZW50IGJpbmRpbmdzCgkJCS8vIEZpeGVkIHRvb2xiYXJzIHJlcXVpcmUgcGFnZSB6b29tIHRvIGJlIGRpc2FibGVkLCBvdGhlcndpc2UgdXNhYmlsaXR5IGlzc3VlcyBjcm9wIHVwCgkJCS8vIFRoaXMgbWV0aG9kIGlzIG1lYW50IHRvIGRpc2FibGUgem9vbSB3aGlsZSBhIGZpeGVkLXBvc2l0aW9uZWQgdG9vbGJhciBwYWdlIGlzIHZpc2libGUKCQkJdGhpcy5fb24oIHBhZ2UgLCB7CgkJCQkicGFnZWJlZm9yZXNob3ciOiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IiwKCQkJCSJ3ZWJraXRBbmltYXRpb25TdGFydCI6Il9oYW5kbGVBbmltYXRpb25TdGFydCIsCgkJCQkiYW5pbWF0aW9uc3RhcnQiOiJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInVwZGF0ZWxheW91dCI6ICJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInBhZ2VzaG93IjogIl9oYW5kbGVQYWdlU2hvdyIsCgkJCQkicGFnZWJlZm9yZWhpZGUiOiAiX2hhbmRsZVBhZ2VCZWZvcmVIaWRlIgoJCQl9KTsKCQl9LAoKCQlfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCApIHsKCQkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7CgkJCWlmICggby5kaXNhYmxlUGFnZVpvb20gKSB7CgkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCQlpZiAoICFvLnZpc2libGVPblBhZ2VTaG93ICkgewoJCQkJdGhpcy5oaWRlKCB0cnVlICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlQW5pbWF0aW9uU3RhcnQ6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHRoaXMub3B0aW9ucy51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCXRoaXMudXBkYXRlUGFnZVBhZGRpbmcoICggISF0aGlzLnBhZ2UgKT8gdGhpcy5wYWdlOiAiLnVpLXBhZ2UtYWN0aXZlIiApOwoJCQl9CgkJfSwKCgkJX2hhbmRsZVBhZ2VTaG93OiBmdW5jdGlvbigpIHsKCQkJdGhpcy51cGRhdGVQYWdlUGFkZGluZyggKCAhIXRoaXMucGFnZSApPyB0aGlzLnBhZ2U6ICIudWktcGFnZS1hY3RpdmUiICk7CgkJCWlmICggdGhpcy5vcHRpb25zLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJdGhpcy5fb24oICQubW9iaWxlLndpbmRvdywgeyAidGhyb3R0bGVkcmVzaXplIjogInVwZGF0ZVBhZ2VQYWRkaW5nIiB9ICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlUGFnZUJlZm9yZUhpZGU6IGZ1bmN0aW9uKCBlLCB1aSApIHsKCQkJdmFyIG8gPSB0aGlzLm9wdGlvbnMsCgkJCQl0aGlzRm9vdGVyLCB0aGlzSGVhZGVyLCBuZXh0Rm9vdGVyLCBuZXh0SGVhZGVyOwoKCgkJCWlmICggby5kaXNhYmxlUGFnZVpvb20gKSB7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQl9CgkJCWlmICggby51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCXRoaXMuX29mZiggJC5tb2JpbGUud2luZG93LCAidGhyb3R0bGVkcmVzaXplIiApOwoJCQl9CgoJCQlpZiAoIG8udHJhY2tQZXJzaXN0ZW50VG9vbGJhcnMgKSB7CgkJCQl0aGlzRm9vdGVyID0gJCggIi51aS1mb290ZXItZml4ZWQ6anFtRGF0YShpZCkiLCB0aGlzLnBhZ2UgKTsKCQkJCXRoaXNIZWFkZXIgPSAkKCAiLnVpLWhlYWRlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMucGFnZSApOwoJCQkJbmV4dEZvb3RlciA9IHRoaXNGb290ZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktZm9vdGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzRm9vdGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpOwoJCQkJbmV4dEhlYWRlciA9IHRoaXNIZWFkZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzSGVhZGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpOwoKCQkJCWlmICggbmV4dEZvb3Rlci5sZW5ndGggfHwgbmV4dEhlYWRlci5sZW5ndGggKSB7CgoJCQkJCW5leHRGb290ZXIuYWRkKCBuZXh0SGVhZGVyICkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCQkJdWkubmV4dFBhZ2Uub25lKCAicGFnZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCQkJbmV4dEhlYWRlci5wcmVwZW5kVG8oIHRoaXMgKTsKCQkJCQkJbmV4dEZvb3Rlci5hcHBlbmRUbyggdGhpcyApOwoJCQkJCX0pOwoJCQkJfQoJCQl9CgkJfSwKCgkJX3Zpc2libGU6IHRydWUsCgoJCS8vIFRoaXMgd2lsbCBzZXQgdGhlIGNvbnRlbnQgZWxlbWVudCdzIHRvcCBvciBib3R0b20gcGFkZGluZyBlcXVhbCB0byB0aGUgdG9vbGJhcidzIGhlaWdodAoJCXVwZGF0ZVBhZ2VQYWRkaW5nOiBmdW5jdGlvbiggdGJQYWdlICkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gKCB0aGlzLnJvbGUgPT09ImhlYWRlciIgKSwKCQkJCXBvcyA9IHBhcnNlRmxvYXQoICRlbC5jc3MoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSApOwoKCQkJLy8gVGhpcyBiZWhhdmlvciBvbmx5IGFwcGxpZXMgdG8gImZpeGVkIiwgbm90ICJmdWxsc2NyZWVuIgoJCQlpZiAoIHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICkgeyByZXR1cm47IH0KCQkJLy8gdGJQYWdlIGFyZ3VtZW50IGNhbiBiZSBhIFBhZ2Ugb2JqZWN0IG9yIGFuIGV2ZW50LCBpZiBjb21pbmcgZnJvbSB0aHJvdHRsZWQgcmVzaXplLgoJCQl0YlBhZ2UgPSAoIHRiUGFnZSAmJiB0YlBhZ2UudHlwZSA9PT0gdW5kZWZpbmVkICYmIHRiUGFnZSApIHx8IHRoaXMucGFnZSB8fCAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCQl0YlBhZ2UgPSAoICEhdGhpcy5wYWdlICk/IHRoaXMucGFnZTogIi51aS1wYWdlLWFjdGl2ZSI7CgkJCSQoIHRiUGFnZSApLmNzcyggInBhZGRpbmctIiArICggaGVhZGVyID8gInRvcCIgOiAiYm90dG9tIiApLCAkZWwub3V0ZXJIZWlnaHQoKSArIHBvcyApOwoJCX0sCgoJCV91c2VUcmFuc2l0aW9uOiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgJHdpbiA9ICQubW9iaWxlLndpbmRvdywKCQkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCXNjcm9sbCA9ICR3aW4uc2Nyb2xsVG9wKCksCgkJCQllbEhlaWdodCA9ICRlbC5oZWlnaHQoKSwKCQkJCXBIZWlnaHQgPSAoICEhdGhpcy5wYWdlICk/ICRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuaGVpZ2h0KCk6JCgiLnVpLXBhZ2UtYWN0aXZlIikuaGVpZ2h0KCksCgkJCQl2aWV3cG9ydEhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQkJcmV0dXJuICFub3RyYW5zaXRpb24gJiYKCQkJCSggdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gJiYgdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gIT09ICJub25lIiAmJgoJCQkJKAoJCQkJCSggdGhpcy5yb2xlID09PSAiaGVhZGVyIiAmJiAhdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gJiYgc2Nyb2xsID4gZWxIZWlnaHQgKSB8fAoJCQkJCSggdGhpcy5yb2xlID09PSAiZm9vdGVyIiAmJiAhdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gJiYgc2Nyb2xsICsgdmlld3BvcnRIZWlnaHQgPCBwSGVpZ2h0IC0gZWxIZWlnaHQgKQoJCQkJKSB8fCB0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbgoJCQkJKTsKCQl9LAoKCQlzaG93OiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgaGlkZUNsYXNzID0gInVpLWZpeGVkLWhpZGRlbiIsCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQ7CgoJCQlpZiAoIHRoaXMuX3VzZVRyYW5zaXRpb24oIG5vdHJhbnNpdGlvbiApICkgewoJCQkJJGVsCgkJCQkJLnJlbW92ZUNsYXNzKCAib3V0ICIgKyBoaWRlQ2xhc3MgKQoJCQkJCS5hZGRDbGFzcyggImluIiApCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKGZ1bmN0aW9uICgpIHsKCQkJCQkJJGVsLnJlbW92ZUNsYXNzKCAiaW4iICk7CgkJCQkJfSk7CgkJCX0KCQkJZWxzZSB7CgkJCQkkZWwucmVtb3ZlQ2xhc3MoIGhpZGVDbGFzcyApOwoJCQl9CgkJCXRoaXMuX3Zpc2libGUgPSB0cnVlOwoJCX0sCgoJCWhpZGU6IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKSB7CgkJCXZhciBoaWRlQ2xhc3MgPSAidWktZml4ZWQtaGlkZGVuIiwKCQkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCS8vIGlmIGl0J3MgYSBzbGlkZSB0cmFuc2l0aW9uLCBvdXIgbmV3IHRyYW5zaXRpb25zIG5lZWQgdGhlIHJldmVyc2UgY2xhc3MgYXMgd2VsbCB0byBzbGlkZSBvdXR3YXJkCgkJCQlvdXRjbGFzcyA9ICJvdXQiICsgKCB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiA9PT0gInNsaWRlIiA/ICIgcmV2ZXJzZSIgOiAiIiApOwoKCQkJaWYgKCB0aGlzLl91c2VUcmFuc2l0aW9uKCBub3RyYW5zaXRpb24gKSApIHsKCQkJCSRlbAoJCQkJCS5hZGRDbGFzcyggb3V0Y2xhc3MgKQoJCQkJCS5yZW1vdmVDbGFzcyggImluIiApCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKGZ1bmN0aW9uKCkgewoJCQkJCQkkZWwuYWRkQ2xhc3MoIGhpZGVDbGFzcyApLnJlbW92ZUNsYXNzKCBvdXRjbGFzcyApOwoJCQkJCX0pOwoJCQl9CgkJCWVsc2UgewoJCQkJJGVsLmFkZENsYXNzKCBoaWRlQ2xhc3MgKS5yZW1vdmVDbGFzcyggb3V0Y2xhc3MgKTsKCQkJfQoJCQl0aGlzLl92aXNpYmxlID0gZmFsc2U7CgkJfSwKCgkJdG9nZ2xlOiBmdW5jdGlvbigpIHsKCQkJdGhpc1sgdGhpcy5fdmlzaWJsZSA/ICJoaWRlIiA6ICJzaG93IiBdKCk7CgkJfSwKCgkJX2JpbmRUb2dnbGVIYW5kbGVyczogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgkJCQlkZWxheVNob3csIGRlbGF5SGlkZSwKCQkJCWlzVmlzaWJsZSA9IHRydWUsCgkJCQlwYWdlID0gKCAhIXRoaXMucGFnZSApPyB0aGlzLnBhZ2U6ICQoIi51aS1wYWdlIik7CgoJCQkvLyB0YXAgdG9nZ2xlCgkJCXBhZ2UKCQkJCS5iaW5kKCAidmNsaWNrIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJaWYgKCBvLnRhcFRvZ2dsZSAmJiAhJCggZS50YXJnZXQgKS5jbG9zZXN0KCBvLnRhcFRvZ2dsZUJsYWNrbGlzdCApLmxlbmd0aCApIHsKCQkJCQkJc2VsZi50b2dnbGUoKTsKCQkJCQl9CgkJCQl9KQoJCQkJLmJpbmQoICJmb2N1c2luIGZvY3Vzb3V0IiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJLy90aGlzIGhpZGVzIHRoZSB0b29sYmFycyBvbiBhIGtleWJvYXJkIHBvcCB0byBnaXZlIG1vcmUgc2NyZWVuIHJvb20gYW5kIHByZXZlbnQgaW9zIGJ1ZyB3aGljaAoJCQkJCS8vcG9zaXRpb25zIGZpeGVkIHRvb2xiYXJzIGluIHRoZSBtaWRkbGUgb2YgdGhlIHNjcmVlbiBvbiBwb3AgaWYgdGhlIGlucHV0IGlzIG5lYXIgdGhlIHRvcCBvcgoJCQkJCS8vYm90dG9tIG9mIHRoZSBzY3JlZW4gYWRkcmVzc2VzIGlzc3VlcyAjNDQxMCBGb290ZXIgbmF2YmFyIG1vdmVzIHVwIHdoZW4gY2xpY2tpbmcgb24gYSB0ZXh0Ym94IGluIGFuIEFuZHJvaWQgZW52aXJvbm1lbnQKCQkJCQkvL2FuZCBpc3N1ZSAjNDExMyBIZWFkZXIgYW5kIGZvb3RlciBjaGFuZ2UgdGhlaXIgcG9zaXRpb24gYWZ0ZXIga2V5Ym9hcmQgcG9wdXAgLSBpT1MKCQkJCQkvL2FuZCBpc3N1ZSAjNDQxMCBGb290ZXIgbmF2YmFyIG1vdmVzIHVwIHdoZW4gY2xpY2tpbmcgb24gYSB0ZXh0Ym94IGluIGFuIEFuZHJvaWQgZW52aXJvbm1lbnQKCQkJCQlpZiAoIHNjcmVlbi53aWR0aCA8IDEwMjUgJiYgJCggZS50YXJnZXQgKS5pcyggby5oaWRlRHVyaW5nRm9jdXMgKSAmJiAhJCggZS50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLWhlYWRlci1maXhlZCwgLnVpLWZvb3Rlci1maXhlZCIgKS5sZW5ndGggKSB7CgkJCQkJCS8vRml4IGZvciBpc3N1ZSAjNDcyNCBNb3ZpbmcgdGhyb3VnaCBmb3JtIGluIE1vYmlsZSBTYWZhcmkgd2l0aCAiTmV4dCIgYW5kICJQcmV2aW91cyIgc3lzdGVtCgkJCQkJCS8vY29udHJvbHMgY2F1c2VzIGZpeGVkIHBvc2l0aW9uLCB0YXAtdG9nZ2xlIGZhbHNlIEhlYWRlciB0byByZXZlYWwgaXRzZWxmCgkJCQkJCS8vIGlzVmlzaWJsZSBpbnN0ZWFkIG9mIHNlbGYuX3Zpc2libGUgYmVjYXVzZSB0aGUgZm9jdXNpbiBhbmQgZm9jdXNvdXQgZXZlbnRzIGZpcmUgdHdpY2UgYXQgdGhlIHNhbWUgdGltZQoJCQkJCQkvLyBBbHNvIHVzZSBhIGRlbGF5IGZvciBoaWRpbmcgdGhlIHRvb2xiYXJzIGJlY2F1c2Ugb24gQW5kcm9pZCBuYXRpdmUgYnJvd3NlciBmb2N1c2luIGlzIGRpcmVjbHR5IGZvbGxvd2VkCgkJCQkJCS8vIGJ5IGEgZm9jdXNvdXQgd2hlbiBhIG5hdGl2ZSBzZWxlY3RzIG9wZW5zIGFuZCB0aGUgb3RoZXIgd2F5IGFyb3VuZCB3aGVuIGl0IGNsb3Nlcy4KCQkJCQkJaWYgKCBlLnR5cGUgPT09ICJmb2N1c291dCIgJiYgIWlzVmlzaWJsZSApIHsKCQkJCQkJCWlzVmlzaWJsZSA9IHRydWU7CgkJCQkJCQkvL3dhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgYW5kIHNlZSBpZiB3ZSBoYXZlIGp1bXBlZCB0byBhbm90aGVyIGlucHV0CgkJCQkJCQljbGVhclRpbWVvdXQoIGRlbGF5SGlkZSApOwoJCQkJCQkJZGVsYXlTaG93ID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJCQkJc2VsZi5zaG93KCk7CgkJCQkJCQl9LCAwICk7CgkJCQkJCX0gZWxzZSBpZiAoIGUudHlwZSA9PT0gImZvY3VzaW4iICYmICEhaXNWaXNpYmxlICkgewoJCQkJCQkJLy9pZiB3ZSBoYXZlIGp1bXBlZCB0byBhbm90aGVyIGlucHV0IGNsZWFyIHRoZSB0aW1lIG91dCB0byBjYW5jZWwgdGhlIHNob3cuCgkJCQkJCQljbGVhclRpbWVvdXQoIGRlbGF5U2hvdyApOwoJCQkJCQkJaXNWaXNpYmxlID0gZmFsc2U7CgkJCQkJCQlkZWxheUhpZGUgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCQlzZWxmLmhpZGUoKTsKCQkJCQkJCX0sIDAgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0pOwoJCX0sCgoJCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCWhlYWRlciA9ICRlbC5oYXNDbGFzcyggInVpLWhlYWRlciIgKTsKCgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuY3NzKCAicGFkZGluZy0iICsgKCBoZWFkZXIgPyAidG9wIiA6ICJib3R0b20iICksICIiICk7CgkJCSRlbC5yZW1vdmVDbGFzcyggInVpLWhlYWRlci1maXhlZCB1aS1mb290ZXItZml4ZWQgdWktaGVhZGVyLWZ1bGxzY3JlZW4gdWktZm9vdGVyLWZ1bGxzY3JlZW4gaW4gb3V0IGZhZGUgc2xpZGVkb3duIHNsaWRldXAgdWktZml4ZWQtaGlkZGVuIiApOwoJCQkkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApLnJlbW92ZUNsYXNzKCAidWktcGFnZS1oZWFkZXItZml4ZWQgdWktcGFnZS1mb290ZXItZml4ZWQgdWktcGFnZS1oZWFkZXItZnVsbHNjcmVlbiB1aS1wYWdlLWZvb3Rlci1mdWxsc2NyZWVuIiApOwoJCX0KCgl9KTsKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkkLndpZGdldCggIm1vYmlsZS50b29sYmFyIiwgJC5tb2JpbGUudG9vbGJhciwgewoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCQkJdGhpcy5fd29ya2Fyb3VuZHMoKTsKCQl9LAoKCQkvL2NoZWNrIHRoZSBicm93c2VyIGFuZCB2ZXJzaW9uIGFuZCBydW4gbmVlZGVkIHdvcmthcm91bmRzCgkJX3dvcmthcm91bmRzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQkJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0sCgkJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJCXdrbWF0Y2ggPSB1YS5tYXRjaCggL0FwcGxlV2ViS2l0XC8oWzAtOV0rKS8gKSwKCQkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQkJb3MgPSBudWxsLAoJCQlzZWxmID0gdGhpczsKCQkJLy9zZXQgdGhlIG9zIHdlIGFyZSB3b3JraW5nIGluIGlmIGl0IGRvc2VudCBtYXRjaCBvbmUgd2l0aCB3b3JrYXJvdW5kcyByZXR1cm4KCQkJaWYgKCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBob25lIiApID4gLTEgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQYWQiICkgPiAtMSAgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQb2QiICkgPiAtMSApIHsKCQkJCW9zID0gImlvcyI7CgkJCX0gZWxzZSBpZiAoIHVhLmluZGV4T2YoICJBbmRyb2lkIiApID4gLTEgKSB7CgkJCQlvcyA9ICJhbmRyb2lkIjsKCQkJfSBlbHNlIHsKCQkJCXJldHVybjsKCQkJfQoJCQkvL2NoZWNrIG9zIHZlcnNpb24gaWYgaXQgZG9zZW50IG1hdGNoIG9uZSB3aXRoIHdvcmthcm91bmRzIHJldHVybgoJCQlpZiAoIG9zID09PSAiaW9zIiApIHsKCQkJCS8vaU9TICB3b3JrYXJvdW5kcwoJCQkJc2VsZi5fYmluZFNjcm9sbFdvcmthcm91bmQoKTsKCQkJfSBlbHNlIGlmICggb3MgPT09ICJhbmRyb2lkIiAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTM0ICkgewoJCQkJLy9BbmRyb2lkIDIuMyBydW4gYWxsIEFuZHJvaWQgMi4zIHdvcmthcm91bmQKCQkJCXNlbGYuX2JpbmRTY3JvbGxXb3JrYXJvdW5kKCk7CgkJCQlzZWxmLl9iaW5kTGlzdFRodW1iV29ya2Fyb3VuZCgpOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuOwoJCQl9CgkJfSwKCgkJLy9VdGlsaXR5IGNsYXNzIGZvciBjaGVja2luZyBoZWFkZXIgYW5kIGZvb3RlciBwb3NpdGlvbnMgcmVsYXRpdmUgdG8gdmlld3BvcnQKCQlfdmlld3BvcnRPZmZzZXQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gJGVsLmhhc0NsYXNzKCAidWktaGVhZGVyIiApLAoJCQkJb2Zmc2V0ID0gTWF0aC5hYnMoICRlbC5vZmZzZXQoKS50b3AgLSAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCkgKTsKCQkJaWYgKCAhaGVhZGVyICkgewoJCQkJb2Zmc2V0ID0gTWF0aC5yb3VuZCggb2Zmc2V0IC0gJC5tb2JpbGUud2luZG93LmhlaWdodCgpICsgJGVsLm91dGVySGVpZ2h0KCkgKSAtIDYwOwoJCQl9CgkJCXJldHVybiBvZmZzZXQ7CgkJfSwKCgkJLy9iaW5kIGV2ZW50cyBmb3IgX3RyaWdnZXJSZWRyYXcoKSBmdW5jdGlvbgoJCV9iaW5kU2Nyb2xsV29ya2Fyb3VuZDogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJLy9iaW5kIHRvIHNjcm9sbHN0b3AgYW5kIGNoZWNrIGlmIHRoZSB0b29sYmFycyBhcmUgY29ycmVjdGx5IHBvc2l0aW9uZWQKCQkJdGhpcy5fb24oICQubW9iaWxlLndpbmRvdywgeyBzY3JvbGxzdG9wOiBmdW5jdGlvbigpIHsKCQkJCXZhciB2aWV3cG9ydE9mZnNldCA9IHNlbGYuX3ZpZXdwb3J0T2Zmc2V0KCk7CgkJCQkvL2NoZWNrIGlmIHRoZSBoZWFkZXIgaXMgdmlzaWJsZSBhbmQgaWYgaXRzIGluIHRoZSByaWdodCBwbGFjZQoJCQkJaWYgKCB2aWV3cG9ydE9mZnNldCA+IDIgJiYgc2VsZi5fdmlzaWJsZSApIHsKCQkJCQlzZWxmLl90cmlnZ2VyUmVkcmF3KCk7CgkJCQl9CgkJCX19KTsKCQl9LAoKCQkvL3RoaXMgYWRkcmVzc2VzIGlzc3VlICM0MjUwIFBlcnNpc3RlbnQgZm9vdGVyIGluc3RhYmlsaXR5IGluIHYxLjEgd2l0aCBsb25nIHNlbGVjdCBsaXN0cyBpbiBBbmRyb2lkIDIuMy4zCgkJLy9hbmQgaXNzdWUgIzM3NDggQW5kcm9pZCAyLng6IFBhZ2UgdHJhbnNpdGlvbnMgYnJva2VuIHdoZW4gZml4ZWQgdG9vbGJhcnMgdXNlZAoJCS8vdGhlIGFic29sdXRlbHkgcG9zaXRpb25lZCB0aHVtYm5haWwgaW4gYSBsaXN0IHZpZXcgY2F1c2VzIHByb2JsZW1zIHdpdGggZml4ZWQgcG9zaXRpb24gYnV0dG9ucyBhYm92ZSBpbiBhIG5hdiBiYXIKCQkvL3NldHRpbmcgdGhlIGxpJ3MgdG8gLXdlYmtpdC10cmFuc2Zvcm06dHJhbnNsYXRlM2QoMCwwLDApOyBzb2x2ZXMgdGhpcyBwcm9ibGVtIHRvIGF2b2lkZSBwb3RlbnRpYWwgaXNzdWVzIGluIG90aGVyCgkJLy9wbGF0Zm9ybXMgd2Ugc2NvcGUgdGhpcyB3aXRoIHRoZSBjbGFzcyB1aS1hbmRyb2lkLTJ4LWZpeAoJCV9iaW5kTGlzdFRodW1iV29ya2Fyb3VuZDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuYWRkQ2xhc3MoICJ1aS1hbmRyb2lkLTJ4LWZpeGVkIiApOwoJCX0sCgkJLy90aGlzIGFkZHJlc3NlcyBpc3N1ZXMgIzQzMzcgRml4ZWQgaGVhZGVyIHByb2JsZW0gYWZ0ZXIgc2Nyb2xsaW5nIGNvbnRlbnQgb24gaU9TIGFuZCBBbmRyb2lkCgkJLy9hbmQgZGV2aWNlIGJ1Z3MgcHJvamVjdCBpc3N1ZSAjMSBGb3JtIGVsZW1lbnRzIGNhbiBsb3NlIGNsaWNrIGhpdCBhcmVhIGluIHBvc2l0aW9uOiBmaXhlZCBjb250YWluZXJzLgoJCS8vdGhpcyBhbHNvIGFkZHJlc3NlcyBub3Qgb24gZml4ZWQgdG9vbGJhcnMgcGFnZSBpbiBkb2NzCgkJLy9hZGRpbmcgMXB4IG9mIHBhZGRpbmcgdG8gdGhlIGJvdHRvbSB0aGVuIHJlbW92aW5nIGl0IGNhdXNlcyBhICJyZWRyYXciCgkJLy93aGljaCBwb3NpdGlvbnMgdGhlIHRvb2xiYXJzIGNvcnJlY3RseSAodGhleSB3aWxsIGFsd2F5cyBiZSB2aXN1YWxseSBjb3JyZWN0KQoJCV90cmlnZ2VyUmVkcmF3OiBmdW5jdGlvbigpIHsKCQkJdmFyIHBhZGRpbmdCb3R0b20gPSBwYXJzZUZsb2F0KCAkKCAiLnVpLXBhZ2UtYWN0aXZlIiApLmNzcyggInBhZGRpbmctYm90dG9tIiApICk7CgkJCS8vdHJpZ2dlciBwYWdlIHJlZHJhdyB0byBmaXggaW5jb3JyZWN0bHkgcG9zaXRpb25lZCBmaXhlZCBlbGVtZW50cwoJCQkkKCAiLnVpLXBhZ2UtYWN0aXZlIiApLmNzcyggInBhZGRpbmctYm90dG9tIiwgKCBwYWRkaW5nQm90dG9tICsgMSApICsgInB4IiApOwoJCQkvL2lmIHRoZSBwYWRkaW5nIGlzIHJlc2V0IHdpdGggb3V0IGEgdGltZW91dCB0aGUgcmVwb3NpdGlvbiB3aWxsIG5vdCBvY2N1cmUuCgkJCS8vdGhpcyBpcyBpbmRlcGVuZGFudCBvZiBKUU0gdGhlIGJyb3dzZXIgc2VlbXMgdG8gbmVlZCB0aGUgdGltZSB0byByZWFjdC4KCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkkKCAiLnVpLXBhZ2UtYWN0aXZlIiApLmNzcyggInBhZGRpbmctYm90dG9tIiwgcGFkZGluZ0JvdHRvbSArICJweCIgKTsKCQkJfSwgMCApOwoJCX0sCgoJCWRlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQkvL1JlbW92ZSB0aGUgY2xhc3Mgd2UgYWRkZWQgdG8gdGhlIHBhZ2UgcHJldmlvdXNseSBpbiBhbmRyb2lkIDIueAoJCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlLWFjdGl2ZSIgKS5yZW1vdmVDbGFzcyggInVpLWFuZHJvaWQtMngtZml4IiApOwoJCX0KCX0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5wYW5lbCIsIHsKCW9wdGlvbnM6IHsKCQljbGFzc2VzOiB7CgkJCXBhbmVsOiAidWktcGFuZWwiLAoJCQlwYW5lbE9wZW46ICJ1aS1wYW5lbC1vcGVuIiwKCQkJcGFuZWxDbG9zZWQ6ICJ1aS1wYW5lbC1jbG9zZWQiLAoJCQlwYW5lbEZpeGVkOiAidWktcGFuZWwtZml4ZWQiLAoJCQlwYW5lbElubmVyOiAidWktcGFuZWwtaW5uZXIiLAoJCQltb2RhbDogInVpLXBhbmVsLWRpc21pc3MiLAoJCQltb2RhbE9wZW46ICJ1aS1wYW5lbC1kaXNtaXNzLW9wZW4iLAoJCQlwYWdlQ29udGFpbmVyOiAidWktcGFuZWwtcGFnZS1jb250YWluZXIiLAoJCQlwYWdlV3JhcHBlcjogInVpLXBhbmVsLXdyYXBwZXIiLAoJCQlwYWdlRml4ZWRUb29sYmFyOiAidWktcGFuZWwtZml4ZWQtdG9vbGJhciIsCgkJCXBhZ2VDb250ZW50UHJlZml4OiAidWktcGFuZWwtcGFnZS1jb250ZW50IiwgLyogVXNlZCBmb3Igd3JhcHBlciBhbmQgZml4ZWQgdG9vbGJhcnMgcG9zaXRpb24sIGRpc3BsYXkgYW5kIG9wZW4gY2xhc3Nlcy4gKi8KCQkJYW5pbWF0ZTogInVpLXBhbmVsLWFuaW1hdGUiCgkJfSwKCQlhbmltYXRlOiB0cnVlLAoJCXRoZW1lOiAiYSIsCgkJcG9zaXRpb246ICJsZWZ0IiwKCQlkaXNtaXNzaWJsZTogdHJ1ZSwKCQlkaXNwbGF5OiAicmV2ZWFsIiwgLy9hY2NlcHRzIHJldmVhbCwgcHVzaCwgb3ZlcmxheQoJCXN3aXBlQ2xvc2U6IHRydWUsCgkJcG9zaXRpb25GaXhlZDogZmFsc2UKCX0sCgoJX3BhbmVsSUQ6IG51bGwsCglfY2xvc2VMaW5rOiBudWxsLAoJX3BhcmVudFBhZ2U6IG51bGwsCglfcGFnZTogbnVsbCwKCV9tb2RhbDogbnVsbCwKCV9wYW5lbElubmVyOiBudWxsLAoJX3dyYXBwZXI6IG51bGwsCglfZml4ZWRUb29sYmFyczogbnVsbCwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWwgPSB0aGlzLmVsZW1lbnQsCgkJCXBhcmVudFBhZ2UgPSBlbC5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApOwoKCQkvLyBleHBvc2Ugc29tZSBwcml2YXRlIHByb3BzIHRvIG90aGVyIG1ldGhvZHMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfcGFuZWxJRDogZWwuYXR0ciggImlkIiApLAoJCQlfY2xvc2VMaW5rOiBlbC5maW5kKCAiOmpxbURhdGEocmVsPSdjbG9zZScpIiApLAoJCQlfcGFyZW50UGFnZTogKCBwYXJlbnRQYWdlLmxlbmd0aCA+IDAgKSA/IHBhcmVudFBhZ2UgOiBmYWxzZSwKCQkJX3BhZ2U6IHRoaXMuX2dldFBhZ2UsCgkJCV9wYW5lbElubmVyOiB0aGlzLl9nZXRQYW5lbElubmVyKCksCgkJCV93cmFwcGVyOiB0aGlzLl9nZXRXcmFwcGVyLAoJCQlfZml4ZWRUb29sYmFyczogdGhpcy5fZ2V0Rml4ZWRUb29sYmFycwoJCX0pOwoJCQoJCXRoaXMuX2FkZFBhbmVsQ2xhc3NlcygpOwoKCQkvLyBpZiBhbmltYXRpbmcsIGFkZCB0aGUgY2xhc3MgdG8gZG8gc28KCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIXRoaXMub3B0aW9ucy5hbmltYXRlICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLmFuaW1hdGUgKTsKCQl9CgoJCXRoaXMuX2JpbmRVcGRhdGVMYXlvdXQoKTsKCQl0aGlzLl9iaW5kQ2xvc2VFdmVudHMoKTsKCQl0aGlzLl9iaW5kTGlua0xpc3RlbmVycygpOwoJCXRoaXMuX2JpbmRQYWdlRXZlbnRzKCk7CgoJCWlmICggISF0aGlzLm9wdGlvbnMuZGlzbWlzc2libGUgKSB7CgkJCXRoaXMuX2NyZWF0ZU1vZGFsKCk7CgkJfQoKCQl0aGlzLl9iaW5kU3dpcGVFdmVudHMoKTsKCX0sCgkKCV9nZXRQYW5lbElubmVyOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFuZWxJbm5lciA9IHRoaXMuZWxlbWVudC5maW5kKCAiLiIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbElubmVyICk7CgkJCgkJaWYgKCBwYW5lbElubmVyLmxlbmd0aCA9PT0gMCApIHsKCQkJcGFuZWxJbm5lciA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbigpLndyYXBBbGwoICI8ZGl2IGNsYXNzPSciICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxJbm5lciArICInIC8+IiApLnBhcmVudCgpOwoJCX0KCQkKCQlyZXR1cm4gcGFuZWxJbm5lcjsKCX0sCgkKCV9jcmVhdGVNb2RhbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQl0YXJnZXQgPSBzZWxmLl9wYXJlbnRQYWdlID8gc2VsZi5fcGFyZW50UGFnZS5wYXJlbnQoKSA6IHNlbGYuZWxlbWVudC5wYXJlbnQoKTsKCgkJc2VsZi5fbW9kYWwgPSAkKCAiPGRpdiBjbGFzcz0nIiArIHNlbGYub3B0aW9ucy5jbGFzc2VzLm1vZGFsICsgIicgZGF0YS1wYW5lbGlkPSciICsgc2VsZi5fcGFuZWxJRCArICInPjwvZGl2PiIgKQoJCQkub24oICJtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuY2xvc2UoKTsKCQkJfSkKCQkJLmFwcGVuZFRvKCB0YXJnZXQgKTsKCX0sCgkKCV9nZXRQYWdlOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFnZSA9IHRoaXMuX3BhcmVudFBhZ2UgPyB0aGlzLl9wYXJlbnRQYWdlIDogJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICk7CgkJCgkJcmV0dXJuIHBhZ2U7Cgl9LAoJCglfZ2V0V3JhcHBlcjogZnVuY3Rpb24oKSB7CgkJdmFyIHdyYXBwZXIgPSB0aGlzLl9wYWdlKCkuZmluZCggIi4iICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFnZVdyYXBwZXIgKSwKCQkJYW5pbWF0ZUNsYXNzID0gKCAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISF0aGlzLm9wdGlvbnMuYW5pbWF0ZSApID8gIiAiICsgdGhpcy5vcHRpb25zLmNsYXNzZXMuYW5pbWF0ZSA6ICIiOwoKCQlpZiAoIHdyYXBwZXIubGVuZ3RoID09PSAwICkgewoJCQl3cmFwcGVyID0gdGhpcy5fcGFnZSgpLmNoaWxkcmVuKCAiLnVpLWhlYWRlcjpub3QoOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykpLCAudWktY29udGVudDpub3QoOmpxbURhdGEocm9sZT0ncG9wdXAnKSksIC51aS1mb290ZXI6bm90KDpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpKSIgKQoJCQkJLndyYXBBbGwoICI8ZGl2IGNsYXNzPSciICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFnZVdyYXBwZXIgKyBhbmltYXRlQ2xhc3MgKyAiJyAvPjwvZGl2PiIgKQoJCQkJLnBhcmVudCgpOwoJCX0KCgkJcmV0dXJuIHdyYXBwZXI7Cgl9LAoJCglfZ2V0Rml4ZWRUb29sYmFyczogZnVuY3Rpb24oKSB7CgkJdmFyIGV4dEZpeGVkVG9vbGJhcnMgPSAkKCAiYm9keSIgKS5jaGlsZHJlbiggIi51aS1oZWFkZXI6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSwgLnVpLWZvb3RlcjpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpIiApLAoJCQlpbnRGaXhlZFRvb2xiYXJzID0gdGhpcy5fcGFnZSgpLmZpbmQoICIudWktaGVhZGVyOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJyksIC51aS1mb290ZXI6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSIgKSwKCQkJZml4ZWRUb29sYmFycyA9IGV4dEZpeGVkVG9vbGJhcnMuYWRkKCBpbnRGaXhlZFRvb2xiYXJzICkuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhZ2VGaXhlZFRvb2xiYXIgKTsKCgkJcmV0dXJuIGZpeGVkVG9vbGJhcnM7Cgl9LAoKCV9nZXRQb3NEaXNwbGF5Q2xhc3NlczogZnVuY3Rpb24oIHByZWZpeCApIHsKCQlyZXR1cm4gcHJlZml4ICsgIi1wb3NpdGlvbi0iICsgdGhpcy5vcHRpb25zLnBvc2l0aW9uICsgIiAiICsgcHJlZml4ICsgIi1kaXNwbGF5LSIgKyB0aGlzLm9wdGlvbnMuZGlzcGxheTsKCX0sCgoJX2dldFBhbmVsQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJdmFyIHBhbmVsQ2xhc3NlcyA9IHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsICsKCQkJIiAiICsgdGhpcy5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsICkgKwoJCQkiICIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbENsb3NlZDsKCgkJaWYgKCB0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCXBhbmVsQ2xhc3NlcyArPSAiIHVpLWJvZHktIiArIHRoaXMub3B0aW9ucy50aGVtZTsKCQl9CgkJaWYgKCAhIXRoaXMub3B0aW9ucy5wb3NpdGlvbkZpeGVkICkgewoJCQlwYW5lbENsYXNzZXMgKz0gIiAiICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxGaXhlZDsKCQl9CgkJcmV0dXJuIHBhbmVsQ2xhc3NlczsKCX0sCgoJX2FkZFBhbmVsQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLl9nZXRQYW5lbENsYXNzZXMoKSApOwoJfSwKCglfYmluZENsb3NlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXNlbGYuX2Nsb3NlTGluay5vbiggImNsaWNrLnBhbmVsIiAsIGZ1bmN0aW9uKCBlICkgewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCXNlbGYuY2xvc2UoKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0pOwoJCXNlbGYuZWxlbWVudC5vbiggImNsaWNrLnBhbmVsIiAsICJhOmpxbURhdGEoYWpheD0nZmFsc2UnKSIsIGZ1bmN0aW9uKC8qIGUgKi8pIHsKCQkJc2VsZi5jbG9zZSgpOwoJCX0pOwoJfSwKCglfcG9zaXRpb25QYW5lbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlwYW5lbElubmVySGVpZ2h0ID0gc2VsZi5fcGFuZWxJbm5lci5vdXRlckhlaWdodCgpLAoJCQlleHBhbmQgPSBwYW5lbElubmVySGVpZ2h0ID4gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCWlmICggZXhwYW5kIHx8ICFzZWxmLm9wdGlvbnMucG9zaXRpb25GaXhlZCApIHsKCQkJaWYgKCBleHBhbmQgKSB7CgkJCQlzZWxmLl91bmZpeFBhbmVsKCk7CgkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoIHBhbmVsSW5uZXJIZWlnaHQgKTsKCQkJfQoJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsICk7CgkJfSBlbHNlIHsKCQkJc2VsZi5fZml4UGFuZWwoKTsKCQl9Cgl9LAoKCV9iaW5kRml4TGlzdGVuZXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29uKCAkKCB3aW5kb3cgKSwgeyAidGhyb3R0bGVkcmVzaXplIjogIl9wb3NpdGlvblBhbmVsIiB9KTsKCX0sCgoJX3VuYmluZEZpeExpc3RlbmVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vZmYoICQoIHdpbmRvdyApLCAidGhyb3R0bGVkcmVzaXplIiApOwoJfSwKCglfdW5maXhQYW5lbDogZnVuY3Rpb24oKSB7CgkJaWYgKCAhIXRoaXMub3B0aW9ucy5wb3NpdGlvbkZpeGVkICYmICQuc3VwcG9ydC5maXhlZFBvc2l0aW9uICkgewoJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsRml4ZWQgKTsKCQl9Cgl9LAoKCV9maXhQYW5lbDogZnVuY3Rpb24oKSB7CgkJaWYgKCAhIXRoaXMub3B0aW9ucy5wb3NpdGlvbkZpeGVkICYmICQuc3VwcG9ydC5maXhlZFBvc2l0aW9uICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsRml4ZWQgKTsKCQl9Cgl9LAoKCV9iaW5kVXBkYXRlTGF5b3V0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXNlbGYuZWxlbWVudC5vbiggInVwZGF0ZWxheW91dCIsIGZ1bmN0aW9uKC8qIGUgKi8pIHsKCQkJaWYgKCBzZWxmLl9vcGVuICkgewoJCQkJc2VsZi5fcG9zaXRpb25QYW5lbCgpOwoJCQl9CgkJfSk7Cgl9LAoKCV9iaW5kTGlua0xpc3RlbmVyczogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb24oICJhIiwgewoJCQkiY2xpY2siOiAiX2hhbmRsZUNsaWNrIgoJCX0pOwoJCQoJfSwKCglfaGFuZGxlQ2xpY2s6IGZ1bmN0aW9uKCBlICl7CgkJaWYgKCAgZS5jdXJyZW50VGFyZ2V0LmhyZWYuc3BsaXQoICIjIiApWyAxIF0gPT09IHRoaXMuX3BhbmVsSUQgJiYgdGhpcy5fcGFuZWxJRCAhPT0gdW5kZWZpbmVkICkgewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCXZhciBsaW5rID0gJCggZS50YXJnZXQgKTsKCQkJaWYgKCBsaW5rLmhhc0NsYXNzKCAidWktYnRuIiApICkgewoJCQkJbGluay5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCXRoaXMuZWxlbWVudC5vbmUoICJwYW5lbG9wZW4gcGFuZWxjbG9zZSIsIGZ1bmN0aW9uKCkgewoJCQkJCWxpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQl9KTsKCQkJfQoJCQl0aGlzLnRvZ2dsZSgpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSwKCglfYmluZFN3aXBlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWFyZWEgPSBzZWxmLl9tb2RhbCA/IHNlbGYuZWxlbWVudC5hZGQoIHNlbGYuX21vZGFsICkgOiBzZWxmLmVsZW1lbnQ7CgoJCS8vIG9uIHN3aXBlLCBjbG9zZSB0aGUgcGFuZWwKCQlpZiAoICEhc2VsZi5vcHRpb25zLnN3aXBlQ2xvc2UgKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnBvc2l0aW9uID09PSAibGVmdCIgKSB7CgkJCQlhcmVhLm9uKCAic3dpcGVsZWZ0LnBhbmVsIiwgZnVuY3Rpb24oLyogZSAqLykgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJYXJlYS5vbiggInN3aXBlcmlnaHQucGFuZWwiLCBmdW5jdGlvbigvKiBlICovKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfSk7CgkJCX0KCQl9Cgl9LAoKCV9iaW5kUGFnZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQkkLm1vYmlsZS5kb2N1bWVudAoJCQkvLyBDbG9zZSB0aGUgcGFuZWwgaWYgYW5vdGhlciBwYW5lbCBvbiB0aGUgcGFnZSBvcGVucwoJCQkub24oICJwYW5lbGJlZm9yZW9wZW4iLCBmdW5jdGlvbiggZSApIHsKCQkJCWlmICggc2VsZi5fb3BlbiAmJiBlLnRhcmdldCAhPT0gc2VsZi5lbGVtZW50WyAwIF0gKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfQoJCQl9KQoJCQkvLyBPbiBlc2NhcGUsIGNsb3NlPyBtaWdodCBuZWVkIHRvIGhhdmUgYSB0YXJnZXQgY2hlY2sgdG9vLi4uCgkJCS5vbiggImtleXVwLnBhbmVsIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIGUua2V5Q29kZSA9PT0gMjcgJiYgc2VsZi5fb3BlbiApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9CgkJCX0pOwoJCQkKCQkvLyBDbGVhbiB1cCBvcGVuIHBhbmVscyBhZnRlciBwYWdlIGhpZGUKCQlpZiAoIHNlbGYuX3BhcmVudFBhZ2UgKSB7CgkJCSQubW9iaWxlLmRvY3VtZW50Lm9uKCAicGFnZWhpZGUiLCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSggdHJ1ZSApOwoJCQkJfQoJCQl9KTsKCQl9IGVsc2UgewoJCQkkLm1vYmlsZS5kb2N1bWVudC5vbiggInBhZ2ViZWZvcmVoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSggdHJ1ZSApOwoJCQkJfQoJCQl9KTsKCQl9Cgl9LAoKCS8vIHN0YXRlIHN0b3JhZ2Ugb2Ygb3BlbiBvciBjbG9zZWQKCV9vcGVuOiBmYWxzZSwKCV9wYWdlQ29udGVudE9wZW5DbGFzc2VzOiBudWxsLAoJX21vZGFsT3BlbkNsYXNzZXM6IG51bGwsCgoJb3BlbjogZnVuY3Rpb24oIGltbWVkaWF0ZSApIHsKCQlpZiAoICF0aGlzLl9vcGVuICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJCgkJCQlfb3BlblBhbmVsID0gZnVuY3Rpb24oKSB7CgkJCQkJJC5tb2JpbGUuZG9jdW1lbnQub2ZmKCAicGFuZWxjbG9zZSIgKTsKCQkJCQlzZWxmLl9wYWdlKCkuanFtRGF0YSggInBhbmVsIiwgIm9wZW4iICk7CgkJCQkJCgkJCQkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgJiYgby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3dyYXBwZXIoKS5hZGRDbGFzcyggby5jbGFzc2VzLmFuaW1hdGUgKTsKCQkJCQkJc2VsZi5fZml4ZWRUb29sYmFycygpLmFkZENsYXNzKCBvLmNsYXNzZXMuYW5pbWF0ZSApOwoJCQkJCX0KCgkJCQkJaWYgKCAhaW1tZWRpYXRlICYmICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIW8uYW5pbWF0ZSApIHsKCQkJCQkJJC5tb2JpbGUuZG9jdW1lbnQub24oIHNlbGYuX3RyYW5zaXRpb25FbmRFdmVudHMsIGNvbXBsZXRlICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJc2V0VGltZW91dCggY29tcGxldGUsIDAgKTsKCQkJCQl9CgoJCQkJCWlmICggby50aGVtZSAmJiBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZSgpLnBhcmVudCgpCgkJCQkJCQkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi10aGVtZWQgIiArIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi0iICsgby50aGVtZSApOwoJCQkJCX0KCgkJCQkJc2VsZi5lbGVtZW50CgkJCQkJCS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhbmVsQ2xvc2VkICkKCQkJCQkJLmFkZENsYXNzKCBvLmNsYXNzZXMucGFuZWxPcGVuICk7CgoJCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCgkJCQkJc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyA9IHNlbGYuX2dldFBvc0Rpc3BsYXlDbGFzc2VzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKTsKCQkJCQkKCQkJCQlpZiAoIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl9wYWdlKCkucGFyZW50KCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICk7CgkJCQkJCXNlbGYuX3dyYXBwZXIoKS5hZGRDbGFzcyggc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkuYWRkQ2xhc3MoIHNlbGYuX3BhZ2VDb250ZW50T3BlbkNsYXNzZXMgKTsKCQkJCQl9CgoJCQkJCXNlbGYuX21vZGFsT3BlbkNsYXNzZXMgPSBzZWxmLl9nZXRQb3NEaXNwbGF5Q2xhc3Nlcyggby5jbGFzc2VzLm1vZGFsICkgKyAiICIgKyBvLmNsYXNzZXMubW9kYWxPcGVuOwoJCQkJCWlmICggc2VsZi5fbW9kYWwgKSB7CgkJCQkJCXNlbGYuX21vZGFsLmFkZENsYXNzKCBzZWxmLl9tb2RhbE9wZW5DbGFzc2VzICk7CgkJCQkJfQoJCQkJfSwKCQkJCWNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJCQkJJC5tb2JpbGUuZG9jdW1lbnQub2ZmKCBzZWxmLl90cmFuc2l0aW9uRW5kRXZlbnRzLCBjb21wbGV0ZSApOwoJCQkJCQoJCQkJCWlmICggby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3dyYXBwZXIoKS5hZGRDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250ZW50UHJlZml4ICsgIi1vcGVuIiApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCQkJCQl9CgoJCQkJCXNlbGYuX2JpbmRGaXhMaXN0ZW5lcigpOwoKCQkJCQlzZWxmLl90cmlnZ2VyKCAib3BlbiIgKTsKCQkJCX07CgoJCQlzZWxmLl90cmlnZ2VyKCAiYmVmb3Jlb3BlbiIgKTsKCQkJCgkJCWlmICggc2VsZi5fcGFnZSgpLmpxbURhdGEoICJwYW5lbCIgKSA9PT0gIm9wZW4iICkgewoJCQkJJC5tb2JpbGUuZG9jdW1lbnQub24oICJwYW5lbGNsb3NlIiwgZnVuY3Rpb24oKSB7CgkJCQkJX29wZW5QYW5lbCgpOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlfb3BlblBhbmVsKCk7CgkJCX0KCgkJCXNlbGYuX29wZW4gPSB0cnVlOwoJCX0KCX0sCgoJY2xvc2U6IGZ1bmN0aW9uKCBpbW1lZGlhdGUgKSB7CgkJaWYgKCB0aGlzLl9vcGVuICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gdGhpcy5vcHRpb25zLAoJCQkJCgkJCQlfY2xvc2VQYW5lbCA9IGZ1bmN0aW9uKCkgewoJCQkJCWlmICggIWltbWVkaWF0ZSAmJiAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgKSB7CgkJCQkJCSQubW9iaWxlLmRvY3VtZW50Lm9uKCBzZWxmLl90cmFuc2l0aW9uRW5kRXZlbnRzLCBjb21wbGV0ZSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXNldFRpbWVvdXQoIGNvbXBsZXRlLCAwICk7CgkJCQkJfQoKCQkJCQlzZWxmLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbE9wZW4gKTsKCQkJCQkKCQkJCQlpZiAoIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyKCkucmVtb3ZlQ2xhc3MoIHNlbGYuX3BhZ2VDb250ZW50T3BlbkNsYXNzZXMgKTsKCQkJCQkJc2VsZi5fZml4ZWRUb29sYmFycygpLnJlbW92ZUNsYXNzKCBzZWxmLl9wYWdlQ29udGVudE9wZW5DbGFzc2VzICk7CgkJCQkJfQoJCQkJCQoJCQkJCWlmICggc2VsZi5fbW9kYWwgKSB7CgkJCQkJCXNlbGYuX21vZGFsLnJlbW92ZUNsYXNzKCBzZWxmLl9tb2RhbE9wZW5DbGFzc2VzICk7CgkJCQkJfQoJCQkJfSwKCQkJCWNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJCQkJJC5tb2JpbGUuZG9jdW1lbnQub2ZmKCBzZWxmLl90cmFuc2l0aW9uRW5kRXZlbnRzLCBjb21wbGV0ZSApOwoJCQkJCQoJCQkJCWlmICggby50aGVtZSAmJiBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZSgpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciArICItdGhlbWVkICIgKyBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciArICItIiArIG8udGhlbWUgKTsKCQkJCQl9CgkJCQkJCQoJCQkJCXNlbGYuZWxlbWVudC5hZGRDbGFzcyggby5jbGFzc2VzLnBhbmVsQ2xvc2VkICk7CgoJCQkJCWlmICggby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3BhZ2UoKS5wYXJlbnQoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKTsKCQkJCQkJc2VsZi5fd3JhcHBlcigpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKyAiLW9wZW4iICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250ZW50UHJlZml4ICsgIi1vcGVuIiApOwoJCQkJCX0KCgkJCQkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgJiYgby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3dyYXBwZXIoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLmFuaW1hdGUgKTsKCQkJCQkJc2VsZi5fZml4ZWRUb29sYmFycygpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMuYW5pbWF0ZSApOwoJCQkJCX0KCgkJCQkJc2VsZi5fZml4UGFuZWwoKTsKCQkJCQlzZWxmLl91bmJpbmRGaXhMaXN0ZW5lcigpOwoJCQkJCSQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCgpOwoKCQkJCQlzZWxmLl9wYWdlKCkuanFtUmVtb3ZlRGF0YSggInBhbmVsIiApOwoJCQkJCQoJCQkJCXNlbGYuX3RyaWdnZXIoICJjbG9zZSIgKTsKCQkJCX07CgoJCQlzZWxmLl90cmlnZ2VyKCAiYmVmb3JlY2xvc2UiICk7CgoJCQlfY2xvc2VQYW5lbCgpOwoKCQkJc2VsZi5fb3BlbiA9IGZhbHNlOwoJCX0KCX0sCgoJdG9nZ2xlOiBmdW5jdGlvbigpIHsKCQl0aGlzWyB0aGlzLl9vcGVuID8gImNsb3NlIiA6ICJvcGVuIiBdKCk7Cgl9LAoKCV90cmFuc2l0aW9uRW5kRXZlbnRzOiAid2Via2l0VHJhbnNpdGlvbkVuZCBvVHJhbnNpdGlvbkVuZCBvdHJhbnNpdGlvbmVuZCB0cmFuc2l0aW9uZW5kIG1zVHJhbnNpdGlvbkVuZCIsCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciBvID0gdGhpcy5vcHRpb25zLAoJCQltdWx0aXBsZVBhbmVscyA9ICggJCggImJvZHkgPiA6bW9iaWxlLXBhbmVsIiApLmxlbmd0aCArICQubW9iaWxlLmFjdGl2ZVBhZ2UuZmluZCggIjptb2JpbGUtcGFuZWwiICkubGVuZ3RoICkgPiAxOwoKCQlpZiAoIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkvLyBEZXN0cm95IHRoZSB3cmFwcGVyIGV2ZW4gaWYgdGhlcmUgYXJlIHN0aWxsIG90aGVyIHBhbmVscywgYmVjYXVzZSB3ZSBkb24ndCBrbm93IGlmIHRoZXkgdXNlIGEgd3JhcHBlcgoJCQl0aGlzLl93cmFwcGVyKCkuY2hpbGRyZW4oKS51bndyYXAoKTsKCgkJCWlmICggdGhpcy5fb3BlbiApIHsKCQkJCQoJCQkJdGhpcy5fZml4ZWRUb29sYmFycygpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKyAiLW9wZW4iICk7CgkJCQkKCQkJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICkgewoJCQkJCXRoaXMuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLmFuaW1hdGUgKTsKCQkJCX0KCQkJCQoJCQkJdGhpcy5fcGFnZSgpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciApOwoJCQkJCgkJCQlpZiAoIG8udGhlbWUgKSB7CgkJCQkJdGhpcy5fcGFnZSgpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciArICItdGhlbWVkICIgKyBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciArICItIiArIG8udGhlbWUgKTsKCQkJCX0KCQkJfQoJCX0KCgkJaWYgKCAhbXVsdGlwbGVQYW5lbHMgKSB7CgoJCQkkLm1vYmlsZS5kb2N1bWVudC5vZmYoICJwYW5lbG9wZW4gcGFuZWxjbG9zZSIgKTsKCQkJCgkJCWlmICggdGhpcy5fb3BlbiApIHsKCQkJCSQubW9iaWxlLmRvY3VtZW50Lm9mZiggdGhpcy5fdHJhbnNpdGlvbkVuZEV2ZW50cyApOwoJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCk7CgkJCX0KCQl9CgkJCgkJaWYgKCB0aGlzLl9vcGVuICkgewoJCQl0aGlzLl9wYWdlKCkuanFtUmVtb3ZlRGF0YSggInBhbmVsIiApOwoJCX0KCQkKCQl0aGlzLl9wYW5lbElubmVyLmNoaWxkcmVuKCkudW53cmFwKCk7CgoJCXRoaXMuZWxlbWVudAoJCQkucmVtb3ZlQ2xhc3MoIFsgdGhpcy5fZ2V0UGFuZWxDbGFzc2VzKCksIG8uY2xhc3Nlcy5wYW5lbE9wZW4sIG8uY2xhc3Nlcy5hbmltYXRlIF0uam9pbiggIiAiICkgKQoJCQkub2ZmKCAic3dpcGVsZWZ0LnBhbmVsIHN3aXBlcmlnaHQucGFuZWwiICkKCQkJLm9mZiggInBhbmVsYmVmb3Jlb3BlbiIgKQoJCQkub2ZmKCAicGFuZWxoaWRlIiApCgkJCS5vZmYoICJrZXl1cC5wYW5lbCIgKQoJCQkub2ZmKCAidXBkYXRlbGF5b3V0IiApCgkJCS5vZmYoIHRoaXMuX3RyYW5zaXRpb25FbmRFdmVudHMgKTsKCgkJdGhpcy5fY2xvc2VMaW5rLm9mZiggImNsaWNrLnBhbmVsIiApOwoKCQlpZiAoIHRoaXMuX21vZGFsICkgewoJCQl0aGlzLl9tb2RhbC5yZW1vdmUoKTsKCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50YWJsZSIsIHsKCW9wdGlvbnM6IHsKCQljbGFzc2VzOiB7CgkJCXRhYmxlOiAidWktdGFibGUiCgkJfSwKCQllbmhhbmNlZDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnRhYmxlICk7CgkJfQoKCQkvLyBleHRlbmQgaGVyZSwgYXNzaWduIG9uIHJlZnJlc2ggPiBfc2V0SGVhZGVycwoJCSQuZXh0ZW5kKCB0aGlzLCB7CgoJCQkvLyBFeHBvc2UgaGVhZGVycyBhbmQgYWxsSGVhZGVycyBwcm9wZXJ0aWVzIG9uIHRoZSB3aWRnZXQKCQkJLy8gaGVhZGVycyByZWZlcmVuY2VzIHRoZSBUSHMgd2l0aGluIHRoZSBmaXJzdCBUUiBpbiB0aGUgdGFibGUKCQkJaGVhZGVyczogdW5kZWZpbmVkLAoKCQkJLy8gYWxsSGVhZGVycyByZWZlcmVuY2VzIGhlYWRlcnMsIHBsdXMgYWxsIFRIcyBpbiB0aGUgdGhlYWQsIHdoaWNoIG1heQoJCQkvLyBpbmNsdWRlIHNldmVyYWwgcm93cywgb3Igbm90CgkJCWFsbEhlYWRlcnM6IHVuZGVmaW5lZAoJCX0pOwoKCQl0aGlzLl9yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCV9zZXRIZWFkZXJzOiBmdW5jdGlvbigpIHsKCQl2YXIgdHJzID0gdGhpcy5lbGVtZW50LmZpbmQoICJ0aGVhZCB0ciIgKTsKCgkJdGhpcy5oZWFkZXJzID0gdGhpcy5lbGVtZW50LmZpbmQoICJ0cjplcSgwKSIgKS5jaGlsZHJlbigpOwoJCXRoaXMuYWxsSGVhZGVycyA9IHRoaXMuaGVhZGVycy5hZGQoIHRycy5jaGlsZHJlbigpICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJcmVidWlsZDogJC5ub29wLAoKCV9yZWZyZXNoOiBmdW5jdGlvbiggLyogY3JlYXRlICovICkgewoJCXZhciB0YWJsZSA9IHRoaXMuZWxlbWVudCwKCQkJdHJzID0gdGFibGUuZmluZCggInRoZWFkIHRyIiApOwoKCQkvLyB1cGRhdGluZyBoZWFkZXJzIG9uIHJlZnJlc2ggKGZpeGVzICM1ODgwKQoJCXRoaXMuX3NldEhlYWRlcnMoKTsKCgkJLy8gSXRlcmF0ZSBvdmVyIHRoZSB0cnMKCQl0cnMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciBjb2x1bW5Db3VudCA9IDA7CgoJCQkvLyBJdGVyYXRlIG92ZXIgdGhlIGNoaWxkcmVuIG9mIHRoZSB0cgoJCQkkKCB0aGlzICkuY2hpbGRyZW4oKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCXZhciBzcGFuID0gcGFyc2VJbnQoIHRoaXMuZ2V0QXR0cmlidXRlKCAiY29sc3BhbiIgKSwgMTAgKSwKCQkJCQlzZWxlY3RvciA9ICI6bnRoLWNoaWxkKCIgKyAoIGNvbHVtbkNvdW50ICsgMSApICsgIikiLAoJCQkJCWo7CgoJCQkJdGhpcy5zZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJjb2xzdGFydCIsIGNvbHVtbkNvdW50ICsgMSApOwoKCQkJCWlmICggc3BhbiApIHsKCQkJCQlmb3IoIGogPSAwOyBqIDwgc3BhbiAtIDE7IGorKyApIHsKCQkJCQkJY29sdW1uQ291bnQrKzsKCQkJCQkJc2VsZWN0b3IgKz0gIiwgOm50aC1jaGlsZCgiICsgKCBjb2x1bW5Db3VudCArIDEgKSArICIpIjsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gU3RvcmUgImNlbGxzIiBkYXRhIG9uIGhlYWRlciBhcyBhIHJlZmVyZW5jZSB0byBhbGwgY2VsbHMgaW4gdGhlIAoJCQkJLy8gc2FtZSBjb2x1bW4gYXMgdGhpcyBUSAoJCQkJJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIsIHRhYmxlLmZpbmQoICJ0ciIgKS5ub3QoIHRycy5lcSggMCApICkubm90KCB0aGlzICkuY2hpbGRyZW4oIHNlbGVjdG9yICkgKTsKCgkJCQljb2x1bW5Db3VudCsrOwoJCQl9KTsKCQl9KTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50YWJsZSIsICQubW9iaWxlLnRhYmxlLCB7CglvcHRpb25zOiB7CgkJbW9kZTogImNvbHVtbnRvZ2dsZSIsCgkJY29sdW1uQnRuVGhlbWU6IG51bGwsCgkJY29sdW1uUG9wdXBUaGVtZTogbnVsbCwKCQljb2x1bW5CdG5UZXh0OiAiQ29sdW1ucy4uLiIsCgkJY2xhc3NlczogJC5leHRlbmQoICQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNsYXNzZXMsIHsKCQkJcG9wdXA6ICJ1aS10YWJsZS1jb2x1bW50b2dnbGUtcG9wdXAiLAoJCQljb2x1bW5CdG46ICJ1aS10YWJsZS1jb2x1bW50b2dnbGUtYnRuIiwKCQkJcHJpb3JpdHlQcmVmaXg6ICJ1aS10YWJsZS1wcmlvcml0eS0iLAoJCQljb2x1bW5Ub2dnbGVUYWJsZTogInVpLXRhYmxlLWNvbHVtbnRvZ2dsZSIKCQl9KQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQlpZiggdGhpcy5vcHRpb25zLm1vZGUgIT09ICJjb2x1bW50b2dnbGUiICkgewoJCQlyZXR1cm47CgkJfQoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfbWVudTogbnVsbAoJCX0pOwoKCQlpZiggdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9tZW51ID0gdGhpcy5kb2N1bWVudC5maW5kKCB0aGlzLl9pZCgpICsgIi1wb3B1cCIgKS5jaGlsZHJlbigpLmZpcnN0KCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5fbWVudSA9IHRoaXMuX2VuaGFuY2VDb2xUb2dnbGUoKTsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5jb2x1bW5Ub2dnbGVUYWJsZSApOwoJCX0KCgkJdGhpcy5fc2V0dXBFdmVudHMoKTsKCgkJdGhpcy5fc2V0VG9nZ2xlU3RhdGUoKTsKCX0sCgoJX2lkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gKCB0aGlzLmVsZW1lbnQuYXR0ciggImlkIiApIHx8ICggdGhpcy53aWRnZXROYW1lICsgdGhpcy51dWlkICkgKTsKCX0sCgoJX3NldHVwRXZlbnRzOiBmdW5jdGlvbigpIHsKCQkvL05PVEU6IGlucHV0cyBhcmUgYm91bmQgaW4gYmluZFRvZ2dsZXMsCgkJLy8gc28gaXQgY2FuIGJlIGNhbGxlZCBvbiByZWZyZXNoLCB0b28KCgkJLy8gdXBkYXRlIGNvbHVtbiB0b2dnbGVzIG9uIHJlc2l6ZQoJCXRoaXMuX29uKCAkLm1vYmlsZS53aW5kb3csIHsKCQkJdGhyb3R0bGVkcmVzaXplOiAiX3NldFRvZ2dsZVN0YXRlIgoJCX0pOwoJfSwKCglfYmluZFRvZ2dsZXM6IGZ1bmN0aW9uKCBtZW51ICkgewoJCXZhciBpbnB1dHMgPSBtZW51LmZpbmQoICJpbnB1dCIgKTsKCgkJdGhpcy5fb24oIGlucHV0cywgewoJCQljaGFuZ2U6ICJfbWVudUlucHV0Q2hhbmdlIgoJCX0pOwoJfSwKCglfYWRkVG9nZ2xlczogZnVuY3Rpb24oIG1lbnUsIGtlZXAgKSB7CgkJdmFyIG9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIGFsbG93IHVwZGF0ZSBvZiBtZW51IG9uIHJlZnJlc2ggKGZpeGVzICM1ODgwKQoJCWlmICggIWtlZXAgKSB7CgkJCW1lbnUuZW1wdHkoKTsKCQl9CgoJCS8vIGNyZWF0ZSB0aGUgaGlkZS9zaG93IHRvZ2dsZXMKCQl0aGlzLmhlYWRlcnMubm90KCAidGQiICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciBoZWFkZXIgPSAkKCB0aGlzICksCgkJCQlwcmlvcml0eSA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggdGhpcywgInByaW9yaXR5IiApLAoJCQkJY2VsbHMgPSBoZWFkZXIuYWRkKCBoZWFkZXIuanFtRGF0YSggImNlbGxzIiApICk7CgoJCQlpZiggcHJpb3JpdHkgKSB7CgkJCQljZWxscy5hZGRDbGFzcyggb3B0cy5jbGFzc2VzLnByaW9yaXR5UHJlZml4ICsgcHJpb3JpdHkgKTsKCgkJCQlpZiAoICFrZWVwICkgewoJCQkJCSQoIjxsYWJlbD48aW5wdXQgdHlwZT0nY2hlY2tib3gnIGNoZWNrZWQgLz4iICsKCQkJCQkJKCBoZWFkZXIuY2hpbGRyZW4oICJhYmJyIiApLmZpcnN0KCkuYXR0ciggInRpdGxlIiApIHx8CgkJCQkJCQloZWFkZXIudGV4dCgpICkgKwoJCQkJCQkiPC9sYWJlbD4iICkKCQkJCQkJLmFwcGVuZFRvKCBtZW51ICkKCQkJCQkJLmNoaWxkcmVuKCAwICkKCQkJCQkJLmpxbURhdGEoICJjZWxscyIsIGNlbGxzICkKCQkJCQkJLmNoZWNrYm94cmFkaW8oIHsKCQkJCQkJCXRoZW1lOiBvcHRzLmNvbHVtblBvcHVwVGhlbWUKCQkJCQkJfSk7CgkJCQl9CgkJCX0KCQl9KTsKCgkJLy8gc2V0IGJpbmRpbmdzIGhlcmUKCQlpZiAoICFrZWVwICkgewoJCQl0aGlzLl9iaW5kVG9nZ2xlcyggbWVudSApOwoJCX0KCX0sCgoJX21lbnVJbnB1dENoYW5nZTogZnVuY3Rpb24oIGV2dCApIHsKCQl2YXIgaW5wdXQgPSAkKCBldnQudGFyZ2V0ICksCgkJCWNoZWNrZWQgPSBpbnB1dFsgMCBdLmNoZWNrZWQ7CgoJCWlucHV0LmpxbURhdGEoICJjZWxscyIgKQoJCQkudG9nZ2xlQ2xhc3MoICJ1aS10YWJsZS1jZWxsLWhpZGRlbiIsICFjaGVja2VkICkKCQkJLnRvZ2dsZUNsYXNzKCAidWktdGFibGUtY2VsbC12aXNpYmxlIiwgY2hlY2tlZCApOwoKCQlpZiAoIGlucHV0WyAwIF0uZ2V0QXR0cmlidXRlKCAibG9ja2VkIiApICkgewoJCQlpbnB1dC5yZW1vdmVBdHRyKCAibG9ja2VkIiApOwoKCQkJdGhpcy5fdW5sb2NrQ2VsbHMoIGlucHV0LmpxbURhdGEoICJjZWxscyIgKSApOwoJCX0gZWxzZSB7CgkJCWlucHV0LmF0dHIoICJsb2NrZWQiLCB0cnVlICk7CgkJfQoJfSwKCglfdW5sb2NrQ2VsbHM6IGZ1bmN0aW9uKCBjZWxscyApIHsKCQkvLyBhbGxvdyBoaWRlL3Nob3cgdmlhIENTUyBvbmx5ID0gcmVtb3ZlIGFsbCB0b2dnbGUtbG9ja3MKCQljZWxscy5yZW1vdmVDbGFzcyggInVpLXRhYmxlLWNlbGwtaGlkZGVuIHVpLXRhYmxlLWNlbGwtdmlzaWJsZSIpOwoJfSwKCglfZW5oYW5jZUNvbFRvZ2dsZTogZnVuY3Rpb24oKSB7CgkJdmFyIGlkICwgbWVudUJ1dHRvbiwgcG9wdXAsIG1lbnUsCgkJCXRhYmxlID0gdGhpcy5lbGVtZW50LAoJCQlvcHRzID0gdGhpcy5vcHRpb25zLAoJCQlucyA9ICQubW9iaWxlLm5zLAoJCQlmcmFnbWVudCA9ICQubW9iaWxlLmRvY3VtZW50WyAwIF0uY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoKCQlpZCA9IHRoaXMuX2lkKCkgKyAiLXBvcHVwIjsKCQltZW51QnV0dG9uID0gJCggIjxhIHJvbGU9J2J1dHRvbicgaHJlZj0nIyIgKyBpZCArICInICIgKwoJCQkiY2xhc3M9JyIgKyBvcHRzLmNsYXNzZXMuY29sdW1uQnRuICsgIiB1aS1idG4gdWktYnRuLSIgKyAoIG9wdHMuY29sdW1uQnRuVGhlbWUgfHwgImEiICkgKyAiIHVpLWNvcm5lci1hbGwgdWktc2hhZG93IHVpLW1pbmknICIgKwoJCQkiZGF0YS0iICsgbnMgKyAicmVsPSdwb3B1cCcgIiArCgkJCSJkYXRhLSIgKyBucyArICJtaW5pPSd0cnVlJz4iICsgb3B0cy5jb2x1bW5CdG5UZXh0ICsgIjwvYT4iICk7CgkJcG9wdXAgPSAkKCAiPGRpdiBkYXRhLSIgKyBucyArICJyb2xlPSdwb3B1cCcgZGF0YS0iICsgbnMgKyAicm9sZT0nZmllbGRjb250YWluJyBjbGFzcz0nIiArIG9wdHMuY2xhc3Nlcy5wb3B1cCArICInIGlkPSciICsgaWQgKyAiJz48L2Rpdj4iICk7CgkJbWVudSA9ICQoICI8ZmllbGRzZXQgZGF0YS0iICsgbnMgKyAicm9sZT0nY29udHJvbGdyb3VwJz48L2ZpZWxkc2V0PiIgKTsKCgkJLy8gc2V0IGV4dGVuc2lvbiBoZXJlLCBzZW5kICJmYWxzZSIgdG8gdHJpZ2dlciBidWlsZC9yZWJ1aWxkCgkJdGhpcy5fYWRkVG9nZ2xlcyggbWVudSwgZmFsc2UgKTsKCgkJbWVudS5hcHBlbmRUbyggcG9wdXAgKTsKCgkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIHBvcHVwWyAwIF0gKTsKCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggbWVudUJ1dHRvblsgMCBdICk7CgkJdGFibGUuYmVmb3JlKCBmcmFnbWVudCApOwoKCQlwb3B1cC5wb3B1cCgpLmVuaGFuY2VXaXRoaW4oKTsKCgkJcmV0dXJuIG1lbnU7Cgl9LAoKCXJlYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLm1vZGUgPT09ICJjb2x1bW50b2dnbGUiICkgewoJCQkvLyBOT1RFOiByZWJ1aWxkIHBhc3NlcyAiZmFsc2UiLCB3aGlsZSByZWZyZXNoIHBhc3NlcyAidW5kZWZpbmVkIgoJCQkvLyBib3RoIHJlZnJlc2ggdGhlIHRhYmxlLCBidXQgaW5zaWRlIGFkZFRvZ2dsZXMsICFmYWxzZSB3aWxsIGJlIHRydWUsCgkJCS8vIHNvIGEgcmVidWlsZCBjYWxsIGNhbiBiZSBpbmRlbnRpZmllZAoJCQl0aGlzLl9yZWZyZXNoKCBmYWxzZSApOwoJCX0KCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdGhpcy5fc3VwZXIoIGNyZWF0ZSApOwoKCQlpZiAoICFjcmVhdGUgJiYgdGhpcy5vcHRpb25zLm1vZGUgPT09ICJjb2x1bW50b2dnbGUiICkgewoJCQkvLyBjb2x1bW5zIG5vdCBiZWluZyByZXBsYWNlZCBtdXN0IGJlIGNsZWFyZWQgZnJvbSBpbnB1dCB0b2dnbGUtbG9ja3MKCQkJdGhpcy5fdW5sb2NrQ2VsbHMoIHRoaXMuYWxsSGVhZGVycyApOwoKCQkJLy8gdXBkYXRlIGNvbHVtbnRvZ2dsZXMgYW5kIGNlbGxzCgkJCXRoaXMuX2FkZFRvZ2dsZXMoIHRoaXMuX21lbnUsIGNyZWF0ZSApOwoKCQkJLy8gY2hlY2svdW5jaGVjawoJCQl0aGlzLl9zZXRUb2dnbGVTdGF0ZSgpOwoJCX0KCX0sCgoJX3NldFRvZ2dsZVN0YXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9tZW51LmZpbmQoICJpbnB1dCIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGNoZWNrYm94ID0gJCggdGhpcyApOwoKCQkJdGhpcy5jaGVja2VkID0gY2hlY2tib3guanFtRGF0YSggImNlbGxzIiApLmVxKCAwICkuY3NzKCAiZGlzcGxheSIgKSA9PT0gInRhYmxlLWNlbGwiOwoJCQljaGVja2JveC5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCQl9KTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50YWJsZSIsICQubW9iaWxlLnRhYmxlLCB7CglvcHRpb25zOiB7CgkJbW9kZTogInJlZmxvdyIsCgkJY2xhc3NlczogJC5leHRlbmQoICQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNsYXNzZXMsIHsKCQkJcmVmbG93VGFibGU6ICJ1aS10YWJsZS1yZWZsb3ciLAoJCQljZWxsTGFiZWxzOiAidWktdGFibGUtY2VsbC1sYWJlbCIKCQl9KQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQkvLyBJZiBpdCdzIG5vdCByZWZsb3cgbW9kZSwgcmV0dXJuIGhlcmUuCgkJaWYoIHRoaXMub3B0aW9ucy5tb2RlICE9PSAicmVmbG93IiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMucmVmbG93VGFibGUgKTsKCgkJCXRoaXMuX3VwZGF0ZVJlZmxvdygpOwoJCX0KCX0sCgoJcmVidWlsZDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMubW9kZSA9PT0gInJlZmxvdyIgKSB7CgkJCXRoaXMuX3JlZnJlc2goIGZhbHNlICk7CgkJfQoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl0aGlzLl9zdXBlciggY3JlYXRlICk7CgkJaWYgKCAhY3JlYXRlICYmIHRoaXMub3B0aW9ucy5tb2RlID09PSAicmVmbG93IiApIHsKCQkJdGhpcy5fdXBkYXRlUmVmbG93KCApOwoJCX0KCX0sCgoJX3VwZGF0ZVJlZmxvdzogZnVuY3Rpb24oKSB7CgkJdmFyIHRhYmxlID0gdGhpcywKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJLy8gZ2V0IGhlYWRlcnMgaW4gcmV2ZXJzZSBvcmRlciBzbyB0aGF0IHRvcC1sZXZlbCBoZWFkZXJzIGFyZSBhcHBlbmRlZCBsYXN0CgkJJCggdGFibGUuYWxsSGVhZGVycy5nZXQoKS5yZXZlcnNlKCkgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGNlbGxzID0gJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKSwKCQkJCWNvbHN0YXJ0ID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAiY29sc3RhcnQiICksCgkJCQloaWVyYXJjaHlDbGFzcyA9IGNlbGxzLm5vdCggdGhpcyApLmZpbHRlciggInRoZWFkIHRoIiApLmxlbmd0aCAmJiAiIHVpLXRhYmxlLWNlbGwtbGFiZWwtdG9wIiwKCQkJCXRleHQgPSAkKCB0aGlzICkudGV4dCgpLAoJCQkJaXRlcmF0aW9uLCBmaWx0ZXI7CgoJCQkJaWYgKCB0ZXh0ICE9PSAiIiAgKSB7CgoJCQkJCWlmKCBoaWVyYXJjaHlDbGFzcyApIHsKCQkJCQkJaXRlcmF0aW9uID0gcGFyc2VJbnQoIHRoaXMuZ2V0QXR0cmlidXRlKCAiY29sc3BhbiIgKSwgMTAgKTsKCQkJCQkJZmlsdGVyID0gIiI7CgoJCQkJCQlpZiAoIGl0ZXJhdGlvbiApewoJCQkJCQkJZmlsdGVyID0gInRkOm50aC1jaGlsZCgiKyBpdGVyYXRpb24gKyJuICsgIiArICggY29sc3RhcnQgKSArIikiOwoJCQkJCQl9CgoJCQkJCQl0YWJsZS5fYWRkTGFiZWxzKCBjZWxscy5maWx0ZXIoIGZpbHRlciApLCBvcHRzLmNsYXNzZXMuY2VsbExhYmVscyArIGhpZXJhcmNoeUNsYXNzLCB0ZXh0ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGFibGUuX2FkZExhYmVscyggY2VsbHMsIG9wdHMuY2xhc3Nlcy5jZWxsTGFiZWxzLCB0ZXh0ICk7CgkJCQkJfQoKCQkJCX0KCQl9KTsKCX0sCgoJX2FkZExhYmVsczogZnVuY3Rpb24oIGNlbGxzLCBsYWJlbCwgdGV4dCApIHsKCQkvLyAubm90IGZpeGVzICM2MDA2CgkJY2VsbHMubm90KCAiOmhhcyhiLiIgKyBsYWJlbCArICIpIiApLnByZXBlbmQoICI8YiBjbGFzcz0nIiArIGxhYmVsICsgIic+IiArIHRleHQgKyAiPC9iPiIgICk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKLyohCiAqIGpRdWVyeSBVSSBUYWJzIEBWRVJTSU9OCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vdGFicy8KICoKICogRGVwZW5kczoKICoJanF1ZXJ5LnVpLmNvcmUuanMKICoJanF1ZXJ5LnVpLndpZGdldC5qcwogKi8KKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgdGFiSWQgPSAwLAoJcmhhc2ggPSAvIy4qJC87CgpmdW5jdGlvbiBnZXROZXh0VGFiSWQoKSB7CglyZXR1cm4gKyt0YWJJZDsKfQoKZnVuY3Rpb24gaXNMb2NhbCggYW5jaG9yICkgewoJcmV0dXJuIGFuY2hvci5oYXNoLmxlbmd0aCA+IDEgJiYKCQlkZWNvZGVVUklDb21wb25lbnQoIGFuY2hvci5ocmVmLnJlcGxhY2UoIHJoYXNoLCAiIiApICkgPT09CgkJCWRlY29kZVVSSUNvbXBvbmVudCggbG9jYXRpb24uaHJlZi5yZXBsYWNlKCByaGFzaCwgIiIgKSApOwp9CgokLndpZGdldCggInVpLnRhYnMiLCB7Cgl2ZXJzaW9uOiAiQFZFUlNJT04iLAoJZGVsYXk6IDMwMCwKCW9wdGlvbnM6IHsKCQlhY3RpdmU6IG51bGwsCgkJY29sbGFwc2libGU6IGZhbHNlLAoJCWV2ZW50OiAiY2xpY2siLAoJCWhlaWdodFN0eWxlOiAiY29udGVudCIsCgkJaGlkZTogbnVsbCwKCQlzaG93OiBudWxsLAoKCQkvLyBjYWxsYmFja3MKCQlhY3RpdmF0ZTogbnVsbCwKCQliZWZvcmVBY3RpdmF0ZTogbnVsbCwKCQliZWZvcmVMb2FkOiBudWxsLAoJCWxvYWQ6IG51bGwKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQl0aGlzLnJ1bm5pbmcgPSBmYWxzZTsKCgkJdGhpcy5lbGVtZW50CgkJCS5hZGRDbGFzcyggInVpLXRhYnMgdWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1hbGwiICkKCQkJLnRvZ2dsZUNsYXNzKCAidWktdGFicy1jb2xsYXBzaWJsZSIsIG9wdGlvbnMuY29sbGFwc2libGUgKQoJCQkvLyBQcmV2ZW50IHVzZXJzIGZyb20gZm9jdXNpbmcgZGlzYWJsZWQgdGFicyB2aWEgY2xpY2sKCQkJLmRlbGVnYXRlKCAiLnVpLXRhYnMtbmF2ID4gbGkiLCAibW91c2Vkb3duIiArIHRoaXMuZXZlbnROYW1lc3BhY2UsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggJCggdGhpcyApLmlzKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0pCgkJCS8vIHN1cHBvcnQ6IElFIDw5CgkJCS8vIFByZXZlbnRpbmcgdGhlIGRlZmF1bHQgYWN0aW9uIGluIG1vdXNlZG93biBkb2Vzbid0IHByZXZlbnQgSUUKCQkJLy8gZnJvbSBmb2N1c2luZyB0aGUgZWxlbWVudCwgc28gaWYgdGhlIGFuY2hvciBnZXRzIGZvY3VzZWQsIGJsdXIuCgkJCS8vIFdlIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgZm9jdXNpbmcgdGhlIHByZXZpb3VzbHkgZm9jdXNlZAoJCQkvLyBlbGVtZW50IHNpbmNlIGNsaWNraW5nIG9uIGEgbm9uLWZvY3VzYWJsZSBlbGVtZW50IHNob3VsZCBmb2N1cwoJCQkvLyB0aGUgYm9keSBhbnl3YXkuCgkJCS5kZWxlZ2F0ZSggIi51aS10YWJzLWFuY2hvciIsICJmb2N1cyIgKyB0aGlzLmV2ZW50TmFtZXNwYWNlLCBmdW5jdGlvbigpIHsKCQkJCWlmICggJCggdGhpcyApLmNsb3Nlc3QoICJsaSIgKS5pcyggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSApIHsKCQkJCQl0aGlzLmJsdXIoKTsKCQkJCX0KCQkJfSk7CgoJCXRoaXMuX3Byb2Nlc3NUYWJzKCk7CgkJb3B0aW9ucy5hY3RpdmUgPSB0aGlzLl9pbml0aWFsQWN0aXZlKCk7CgoJCS8vIFRha2UgZGlzYWJsaW5nIHRhYnMgdmlhIGNsYXNzIGF0dHJpYnV0ZSBmcm9tIEhUTUwKCQkvLyBpbnRvIGFjY291bnQgYW5kIHVwZGF0ZSBvcHRpb24gcHJvcGVybHkuCgkJaWYgKCAkLmlzQXJyYXkoIG9wdGlvbnMuZGlzYWJsZWQgKSApIHsKCQkJb3B0aW9ucy5kaXNhYmxlZCA9ICQudW5pcXVlKCBvcHRpb25zLmRpc2FibGVkLmNvbmNhdCgKCQkJCSQubWFwKCB0aGlzLnRhYnMuZmlsdGVyKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApLCBmdW5jdGlvbiggbGkgKSB7CgkJCQkJcmV0dXJuIHRoYXQudGFicy5pbmRleCggbGkgKTsKCQkJCX0pCgkJCSkgKS5zb3J0KCk7CgkJfQoKCQkvLyBjaGVjayBmb3IgbGVuZ3RoIGF2b2lkcyBlcnJvciB3aGVuIGluaXRpYWxpemluZyBlbXB0eSBsaXN0CgkJaWYgKCB0aGlzLm9wdGlvbnMuYWN0aXZlICE9PSBmYWxzZSAmJiB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQl0aGlzLmFjdGl2ZSA9IHRoaXMuX2ZpbmRBY3RpdmUoIG9wdGlvbnMuYWN0aXZlICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5hY3RpdmUgPSAkKCk7CgkJfQoKCQl0aGlzLl9yZWZyZXNoKCk7CgoJCWlmICggdGhpcy5hY3RpdmUubGVuZ3RoICkgewoJCQl0aGlzLmxvYWQoIG9wdGlvbnMuYWN0aXZlICk7CgkJfQoJfSwKCglfaW5pdGlhbEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGFjdGl2ZSA9IHRoaXMub3B0aW9ucy5hY3RpdmUsCgkJCWNvbGxhcHNpYmxlID0gdGhpcy5vcHRpb25zLmNvbGxhcHNpYmxlLAoJCQlsb2NhdGlvbkhhc2ggPSBsb2NhdGlvbi5oYXNoLnN1YnN0cmluZyggMSApOwoKCQlpZiAoIGFjdGl2ZSA9PT0gbnVsbCApIHsKCQkJLy8gY2hlY2sgdGhlIGZyYWdtZW50IGlkZW50aWZpZXIgaW4gdGhlIFVSTAoJCQlpZiAoIGxvY2F0aW9uSGFzaCApIHsKCQkJCXRoaXMudGFicy5lYWNoKGZ1bmN0aW9uKCBpLCB0YWIgKSB7CgkJCQkJaWYgKCAkKCB0YWIgKS5hdHRyKCAiYXJpYS1jb250cm9scyIgKSA9PT0gbG9jYXRpb25IYXNoICkgewoJCQkJCQlhY3RpdmUgPSBpOwoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCgkJCS8vIGNoZWNrIGZvciBhIHRhYiBtYXJrZWQgYWN0aXZlIHZpYSBhIGNsYXNzCgkJCWlmICggYWN0aXZlID09PSBudWxsICkgewoJCQkJYWN0aXZlID0gdGhpcy50YWJzLmluZGV4KCB0aGlzLnRhYnMuZmlsdGVyKCAiLnVpLXRhYnMtYWN0aXZlIiApICk7CgkJCX0KCgkJCS8vIG5vIGFjdGl2ZSB0YWIsIHNldCB0byBmYWxzZQoJCQlpZiAoIGFjdGl2ZSA9PT0gbnVsbCB8fCBhY3RpdmUgPT09IC0xICkgewoJCQkJYWN0aXZlID0gdGhpcy50YWJzLmxlbmd0aCA/IDAgOiBmYWxzZTsKCQkJfQoJCX0KCgkJLy8gaGFuZGxlIG51bWJlcnM6IG5lZ2F0aXZlLCBvdXQgb2YgcmFuZ2UKCQlpZiAoIGFjdGl2ZSAhPT0gZmFsc2UgKSB7CgkJCWFjdGl2ZSA9IHRoaXMudGFicy5pbmRleCggdGhpcy50YWJzLmVxKCBhY3RpdmUgKSApOwoJCQlpZiAoIGFjdGl2ZSA9PT0gLTEgKSB7CgkJCQlhY3RpdmUgPSBjb2xsYXBzaWJsZSA/IGZhbHNlIDogMDsKCQkJfQoJCX0KCgkJLy8gZG9uJ3QgYWxsb3cgY29sbGFwc2libGU6IGZhbHNlIGFuZCBhY3RpdmU6IGZhbHNlCgkJaWYgKCAhY29sbGFwc2libGUgJiYgYWN0aXZlID09PSBmYWxzZSAmJiB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQlhY3RpdmUgPSAwOwoJCX0KCgkJcmV0dXJuIGFjdGl2ZTsKCX0sCgoJX2dldENyZWF0ZUV2ZW50RGF0YTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHsKCQkJdGFiOiB0aGlzLmFjdGl2ZSwKCQkJcGFuZWw6ICF0aGlzLmFjdGl2ZS5sZW5ndGggPyAkKCkgOiB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGhpcy5hY3RpdmUgKQoJCX07Cgl9LAoKCV90YWJLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGZvY3VzZWRUYWIgPSAkKCB0aGlzLmRvY3VtZW50WzBdLmFjdGl2ZUVsZW1lbnQgKS5jbG9zZXN0KCAibGkiICksCgkJCXNlbGVjdGVkSW5kZXggPSB0aGlzLnRhYnMuaW5kZXgoIGZvY3VzZWRUYWIgKSwKCQkJZ29pbmdGb3J3YXJkID0gdHJ1ZTsKCgkJaWYgKCB0aGlzLl9oYW5kbGVQYWdlTmF2KCBldmVudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQljYXNlICQudWkua2V5Q29kZS5SSUdIVDoKCQkJY2FzZSAkLnVpLmtleUNvZGUuRE9XTjoKCQkJCXNlbGVjdGVkSW5kZXgrKzsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5VUDoKCQkJY2FzZSAkLnVpLmtleUNvZGUuTEVGVDoKCQkJCWdvaW5nRm9yd2FyZCA9IGZhbHNlOwoJCQkJc2VsZWN0ZWRJbmRleC0tOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC51aS5rZXlDb2RlLkVORDoKCQkJCXNlbGVjdGVkSW5kZXggPSB0aGlzLmFuY2hvcnMubGVuZ3RoIC0gMTsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5IT01FOgoJCQkJc2VsZWN0ZWRJbmRleCA9IDA7CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuU1BBQ0U6CgkJCQkvLyBBY3RpdmF0ZSBvbmx5LCBubyBjb2xsYXBzaW5nCgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJY2xlYXJUaW1lb3V0KCB0aGlzLmFjdGl2YXRpbmcgKTsKCQkJCXRoaXMuX2FjdGl2YXRlKCBzZWxlY3RlZEluZGV4ICk7CgkJCQlyZXR1cm47CgkJCWNhc2UgJC51aS5rZXlDb2RlLkVOVEVSOgoJCQkJLy8gVG9nZ2xlIChjYW5jZWwgZGVsYXllZCBhY3RpdmF0aW9uLCBhbGxvdyBjb2xsYXBzaW5nKQoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWNsZWFyVGltZW91dCggdGhpcy5hY3RpdmF0aW5nICk7CgkJCQkvLyBEZXRlcm1pbmUgaWYgd2Ugc2hvdWxkIGNvbGxhcHNlIG9yIGFjdGl2YXRlCgkJCQl0aGlzLl9hY3RpdmF0ZSggc2VsZWN0ZWRJbmRleCA9PT0gdGhpcy5vcHRpb25zLmFjdGl2ZSA/IGZhbHNlIDogc2VsZWN0ZWRJbmRleCApOwoJCQkJcmV0dXJuOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuOwoJCX0KCgkJLy8gRm9jdXMgdGhlIGFwcHJvcHJpYXRlIHRhYiwgYmFzZWQgb24gd2hpY2gga2V5IHdhcyBwcmVzc2VkCgkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQljbGVhclRpbWVvdXQoIHRoaXMuYWN0aXZhdGluZyApOwoJCXNlbGVjdGVkSW5kZXggPSB0aGlzLl9mb2N1c05leHRUYWIoIHNlbGVjdGVkSW5kZXgsIGdvaW5nRm9yd2FyZCApOwoKCQkvLyBOYXZpZ2F0aW5nIHdpdGggY29udHJvbCBrZXkgd2lsbCBwcmV2ZW50IGF1dG9tYXRpYyBhY3RpdmF0aW9uCgkJaWYgKCAhZXZlbnQuY3RybEtleSApIHsKCQkJLy8gVXBkYXRlIGFyaWEtc2VsZWN0ZWQgaW1tZWRpYXRlbHkgc28gdGhhdCBBVCB0aGluayB0aGUgdGFiIGlzIGFscmVhZHkgc2VsZWN0ZWQuCgkJCS8vIE90aGVyd2lzZSBBVCBtYXkgY29uZnVzZSB0aGUgdXNlciBieSBzdGF0aW5nIHRoYXQgdGhleSBuZWVkIHRvIGFjdGl2YXRlIHRoZSB0YWIsCgkJCS8vIGJ1dCB0aGUgdGFiIHdpbGwgYWxyZWFkeSBiZSBhY3RpdmF0ZWQgYnkgdGhlIHRpbWUgdGhlIGFubm91bmNlbWVudCBmaW5pc2hlcy4KCQkJZm9jdXNlZFRhYi5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsICJmYWxzZSIgKTsKCQkJdGhpcy50YWJzLmVxKCBzZWxlY3RlZEluZGV4ICkuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCAidHJ1ZSIgKTsKCgkJCXRoaXMuYWN0aXZhdGluZyA9IHRoaXMuX2RlbGF5KGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5vcHRpb24oICJhY3RpdmUiLCBzZWxlY3RlZEluZGV4ICk7CgkJCX0sIHRoaXMuZGVsYXkgKTsKCQl9Cgl9LAoKCV9wYW5lbEtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIHRoaXMuX2hhbmRsZVBhZ2VOYXYoIGV2ZW50ICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEN0cmwrdXAgbW92ZXMgZm9jdXMgdG8gdGhlIGN1cnJlbnQgdGFiCgkJaWYgKCBldmVudC5jdHJsS2V5ICYmIGV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5VUCApIHsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJdGhpcy5hY3RpdmUuZm9jdXMoKTsKCQl9Cgl9LAoKCS8vIEFsdCtwYWdlIHVwL2Rvd24gbW92ZXMgZm9jdXMgdG8gdGhlIHByZXZpb3VzL25leHQgdGFiIChhbmQgYWN0aXZhdGVzKQoJX2hhbmRsZVBhZ2VOYXY6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIGV2ZW50LmFsdEtleSAmJiBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuUEFHRV9VUCApIHsKCQkJdGhpcy5fYWN0aXZhdGUoIHRoaXMuX2ZvY3VzTmV4dFRhYiggdGhpcy5vcHRpb25zLmFjdGl2ZSAtIDEsIGZhbHNlICkgKTsKCQkJcmV0dXJuIHRydWU7CgkJfQoJCWlmICggZXZlbnQuYWx0S2V5ICYmIGV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5QQUdFX0RPV04gKSB7CgkJCXRoaXMuX2FjdGl2YXRlKCB0aGlzLl9mb2N1c05leHRUYWIoIHRoaXMub3B0aW9ucy5hY3RpdmUgKyAxLCB0cnVlICkgKTsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfSwKCglfZmluZE5leHRUYWI6IGZ1bmN0aW9uKCBpbmRleCwgZ29pbmdGb3J3YXJkICkgewoJCXZhciBsYXN0VGFiSW5kZXggPSB0aGlzLnRhYnMubGVuZ3RoIC0gMTsKCgkJZnVuY3Rpb24gY29uc3RyYWluKCkgewoJCQlpZiAoIGluZGV4ID4gbGFzdFRhYkluZGV4ICkgewoJCQkJaW5kZXggPSAwOwoJCQl9CgkJCWlmICggaW5kZXggPCAwICkgewoJCQkJaW5kZXggPSBsYXN0VGFiSW5kZXg7CgkJCX0KCQkJcmV0dXJuIGluZGV4OwoJCX0KCgkJd2hpbGUgKCAkLmluQXJyYXkoIGNvbnN0cmFpbigpLCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSAhPT0gLTEgKSB7CgkJCWluZGV4ID0gZ29pbmdGb3J3YXJkID8gaW5kZXggKyAxIDogaW5kZXggLSAxOwoJCX0KCgkJcmV0dXJuIGluZGV4OwoJfSwKCglfZm9jdXNOZXh0VGFiOiBmdW5jdGlvbiggaW5kZXgsIGdvaW5nRm9yd2FyZCApIHsKCQlpbmRleCA9IHRoaXMuX2ZpbmROZXh0VGFiKCBpbmRleCwgZ29pbmdGb3J3YXJkICk7CgkJdGhpcy50YWJzLmVxKCBpbmRleCApLmZvY3VzKCk7CgkJcmV0dXJuIGluZGV4OwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQlpZiAoIGtleSA9PT0gImFjdGl2ZSIgKSB7CgkJCS8vIF9hY3RpdmF0ZSgpIHdpbGwgaGFuZGxlIGludmFsaWQgdmFsdWVzIGFuZCB1cGRhdGUgdGhpcy5vcHRpb25zCgkJCXRoaXMuX2FjdGl2YXRlKCB2YWx1ZSApOwoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJLy8gZG9uJ3QgdXNlIHRoZSB3aWRnZXQgZmFjdG9yeSdzIGRpc2FibGVkIGhhbmRsaW5nCgkJCXRoaXMuX3NldHVwRGlzYWJsZWQoIHZhbHVlICk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlKTsKCgkJaWYgKCBrZXkgPT09ICJjb2xsYXBzaWJsZSIgKSB7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLXRhYnMtY29sbGFwc2libGUiLCB2YWx1ZSApOwoJCQkvLyBTZXR0aW5nIGNvbGxhcHNpYmxlOiBmYWxzZSB3aGlsZSBjb2xsYXBzZWQ7IG9wZW4gZmlyc3QgcGFuZWwKCQkJaWYgKCAhdmFsdWUgJiYgdGhpcy5vcHRpb25zLmFjdGl2ZSA9PT0gZmFsc2UgKSB7CgkJCQl0aGlzLl9hY3RpdmF0ZSggMCApOwoJCQl9CgkJfQoKCQlpZiAoIGtleSA9PT0gImV2ZW50IiApIHsKCQkJdGhpcy5fc2V0dXBFdmVudHMoIHZhbHVlICk7CgkJfQoKCQlpZiAoIGtleSA9PT0gImhlaWdodFN0eWxlIiApIHsKCQkJdGhpcy5fc2V0dXBIZWlnaHRTdHlsZSggdmFsdWUgKTsKCQl9Cgl9LAoKCV90YWJJZDogZnVuY3Rpb24oIHRhYiApIHsKCQlyZXR1cm4gdGFiLmF0dHIoICJhcmlhLWNvbnRyb2xzIiApIHx8ICJ1aS10YWJzLSIgKyBnZXROZXh0VGFiSWQoKTsKCX0sCgoJX3Nhbml0aXplU2VsZWN0b3I6IGZ1bmN0aW9uKCBoYXNoICkgewoJCXJldHVybiBoYXNoID8gaGFzaC5yZXBsYWNlKCAvWyEiJCUmJygpKissLlwvOjs8PT4/QFxbXF1cXmB7fH1+XS9nLCAiXFwkJiIgKSA6ICIiOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJbGlzID0gdGhpcy50YWJsaXN0LmNoaWxkcmVuKCAiOmhhcyhhW2hyZWZdKSIgKTsKCgkJLy8gZ2V0IGRpc2FibGVkIHRhYnMgZnJvbSBjbGFzcyBhdHRyaWJ1dGUgZnJvbSBIVE1MCgkJLy8gdGhpcyB3aWxsIGdldCBjb252ZXJ0ZWQgdG8gYSBib29sZWFuIGlmIG5lZWRlZCBpbiBfcmVmcmVzaCgpCgkJb3B0aW9ucy5kaXNhYmxlZCA9ICQubWFwKCBsaXMuZmlsdGVyKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApLCBmdW5jdGlvbiggdGFiICkgewoJCQlyZXR1cm4gbGlzLmluZGV4KCB0YWIgKTsKCQl9KTsKCgkJdGhpcy5fcHJvY2Vzc1RhYnMoKTsKCgkJLy8gd2FzIGNvbGxhcHNlZCBvciBubyB0YWJzCgkJaWYgKCBvcHRpb25zLmFjdGl2ZSA9PT0gZmFsc2UgfHwgIXRoaXMuYW5jaG9ycy5sZW5ndGggKSB7CgkJCW9wdGlvbnMuYWN0aXZlID0gZmFsc2U7CgkJCXRoaXMuYWN0aXZlID0gJCgpOwoJCS8vIHdhcyBhY3RpdmUsIGJ1dCBhY3RpdmUgdGFiIGlzIGdvbmUKCQl9IGVsc2UgaWYgKCB0aGlzLmFjdGl2ZS5sZW5ndGggJiYgISQuY29udGFpbnMoIHRoaXMudGFibGlzdFsgMCBdLCB0aGlzLmFjdGl2ZVsgMCBdICkgKSB7CgkJCS8vIGFsbCByZW1haW5pbmcgdGFicyBhcmUgZGlzYWJsZWQKCQkJaWYgKCB0aGlzLnRhYnMubGVuZ3RoID09PSBvcHRpb25zLmRpc2FibGVkLmxlbmd0aCApIHsKCQkJCW9wdGlvbnMuYWN0aXZlID0gZmFsc2U7CgkJCQl0aGlzLmFjdGl2ZSA9ICQoKTsKCQkJLy8gYWN0aXZhdGUgcHJldmlvdXMgdGFiCgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9hY3RpdmF0ZSggdGhpcy5fZmluZE5leHRUYWIoIE1hdGgubWF4KCAwLCBvcHRpb25zLmFjdGl2ZSAtIDEgKSwgZmFsc2UgKSApOwoJCQl9CgkJLy8gd2FzIGFjdGl2ZSwgYWN0aXZlIHRhYiBzdGlsbCBleGlzdHMKCQl9IGVsc2UgewoJCQkvLyBtYWtlIHN1cmUgYWN0aXZlIGluZGV4IGlzIGNvcnJlY3QKCQkJb3B0aW9ucy5hY3RpdmUgPSB0aGlzLnRhYnMuaW5kZXgoIHRoaXMuYWN0aXZlICk7CgkJfQoKCQl0aGlzLl9yZWZyZXNoKCk7Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXR1cERpc2FibGVkKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKTsKCQl0aGlzLl9zZXR1cEV2ZW50cyggdGhpcy5vcHRpb25zLmV2ZW50ICk7CgkJdGhpcy5fc2V0dXBIZWlnaHRTdHlsZSggdGhpcy5vcHRpb25zLmhlaWdodFN0eWxlICk7CgoJCXRoaXMudGFicy5ub3QoIHRoaXMuYWN0aXZlICkuYXR0cih7CgkJCSJhcmlhLXNlbGVjdGVkIjogImZhbHNlIiwKCQkJdGFiSW5kZXg6IC0xCgkJfSk7CgkJdGhpcy5wYW5lbHMubm90KCB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGhpcy5hY3RpdmUgKSApCgkJCS5oaWRlKCkKCQkJLmF0dHIoewoJCQkJImFyaWEtZXhwYW5kZWQiOiAiZmFsc2UiLAoJCQkJImFyaWEtaGlkZGVuIjogInRydWUiCgkJCX0pOwoKCQkvLyBNYWtlIHN1cmUgb25lIHRhYiBpcyBpbiB0aGUgdGFiIG9yZGVyCgkJaWYgKCAhdGhpcy5hY3RpdmUubGVuZ3RoICkgewoJCQl0aGlzLnRhYnMuZXEoIDAgKS5hdHRyKCAidGFiSW5kZXgiLCAwICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5hY3RpdmUKCQkJCS5hZGRDbGFzcyggInVpLXRhYnMtYWN0aXZlIHVpLXN0YXRlLWFjdGl2ZSIgKQoJCQkJLmF0dHIoewoJCQkJCSJhcmlhLXNlbGVjdGVkIjogInRydWUiLAoJCQkJCXRhYkluZGV4OiAwCgkJCQl9KTsKCQkJdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIHRoaXMuYWN0aXZlICkKCQkJCS5zaG93KCkKCQkJCS5hdHRyKHsKCQkJCQkiYXJpYS1leHBhbmRlZCI6ICJ0cnVlIiwKCQkJCQkiYXJpYS1oaWRkZW4iOiAiZmFsc2UiCgkJCQl9KTsKCQl9Cgl9LAoKCV9wcm9jZXNzVGFiczogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzOwoKCQl0aGlzLnRhYmxpc3QgPSB0aGlzLl9nZXRMaXN0KCkKCQkJLmFkZENsYXNzKCAidWktdGFicy1uYXYgdWktaGVscGVyLXJlc2V0IHVpLWhlbHBlci1jbGVhcmZpeCB1aS13aWRnZXQtaGVhZGVyIHVpLWNvcm5lci1hbGwiICkKCQkJLmF0dHIoICJyb2xlIiwgInRhYmxpc3QiICk7CgoJCXRoaXMudGFicyA9IHRoaXMudGFibGlzdC5maW5kKCAiPiBsaTpoYXMoYVtocmVmXSkiICkKCQkJLmFkZENsYXNzKCAidWktc3RhdGUtZGVmYXVsdCB1aS1jb3JuZXItdG9wIiApCgkJCS5hdHRyKHsKCQkJCXJvbGU6ICJ0YWIiLAoJCQkJdGFiSW5kZXg6IC0xCgkJCX0pOwoKCQl0aGlzLmFuY2hvcnMgPSB0aGlzLnRhYnMubWFwKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICQoICJhIiwgdGhpcyApWyAwIF07CgkJCX0pCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtYW5jaG9yIiApCgkJCS5hdHRyKHsKCQkJCXJvbGU6ICJwcmVzZW50YXRpb24iLAoJCQkJdGFiSW5kZXg6IC0xCgkJCX0pOwoKCQl0aGlzLnBhbmVscyA9ICQoKTsKCgkJdGhpcy5hbmNob3JzLmVhY2goZnVuY3Rpb24oIGksIGFuY2hvciApIHsKCQkJdmFyIHNlbGVjdG9yLCBwYW5lbCwgcGFuZWxJZCwKCQkJCWFuY2hvcklkID0gJCggYW5jaG9yICkudW5pcXVlSWQoKS5hdHRyKCAiaWQiICksCgkJCQl0YWIgPSAkKCBhbmNob3IgKS5jbG9zZXN0KCAibGkiICksCgkJCQlvcmlnaW5hbEFyaWFDb250cm9scyA9IHRhYi5hdHRyKCAiYXJpYS1jb250cm9scyIgKTsKCgkJCS8vIGlubGluZSB0YWIKCQkJaWYgKCBpc0xvY2FsKCBhbmNob3IgKSApIHsKCQkJCXNlbGVjdG9yID0gYW5jaG9yLmhhc2g7CgkJCQlwYW5lbCA9IHRoYXQuZWxlbWVudC5maW5kKCB0aGF0Ll9zYW5pdGl6ZVNlbGVjdG9yKCBzZWxlY3RvciApICk7CgkJCS8vIHJlbW90ZSB0YWIKCQkJfSBlbHNlIHsKCQkJCXBhbmVsSWQgPSB0aGF0Ll90YWJJZCggdGFiICk7CgkJCQlzZWxlY3RvciA9ICIjIiArIHBhbmVsSWQ7CgkJCQlwYW5lbCA9IHRoYXQuZWxlbWVudC5maW5kKCBzZWxlY3RvciApOwoJCQkJaWYgKCAhcGFuZWwubGVuZ3RoICkgewoJCQkJCXBhbmVsID0gdGhhdC5fY3JlYXRlUGFuZWwoIHBhbmVsSWQgKTsKCQkJCQlwYW5lbC5pbnNlcnRBZnRlciggdGhhdC5wYW5lbHNbIGkgLSAxIF0gfHwgdGhhdC50YWJsaXN0ICk7CgkJCQl9CgkJCQlwYW5lbC5hdHRyKCAiYXJpYS1saXZlIiwgInBvbGl0ZSIgKTsKCQkJfQoKCQkJaWYgKCBwYW5lbC5sZW5ndGgpIHsKCQkJCXRoYXQucGFuZWxzID0gdGhhdC5wYW5lbHMuYWRkKCBwYW5lbCApOwoJCQl9CgkJCWlmICggb3JpZ2luYWxBcmlhQ29udHJvbHMgKSB7CgkJCQl0YWIuZGF0YSggInVpLXRhYnMtYXJpYS1jb250cm9scyIsIG9yaWdpbmFsQXJpYUNvbnRyb2xzICk7CgkJCX0KCQkJdGFiLmF0dHIoewoJCQkJImFyaWEtY29udHJvbHMiOiBzZWxlY3Rvci5zdWJzdHJpbmcoIDEgKSwKCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBhbmNob3JJZAoJCQl9KTsKCQkJcGFuZWwuYXR0ciggImFyaWEtbGFiZWxsZWRieSIsIGFuY2hvcklkICk7CgkJfSk7CgoJCXRoaXMucGFuZWxzCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtcGFuZWwgdWktd2lkZ2V0LWNvbnRlbnQgdWktY29ybmVyLWJvdHRvbSIgKQoJCQkuYXR0ciggInJvbGUiLCAidGFicGFuZWwiICk7Cgl9LAoKCS8vIGFsbG93IG92ZXJyaWRpbmcgaG93IHRvIGZpbmQgdGhlIGxpc3QgZm9yIHJhcmUgdXNhZ2Ugc2NlbmFyaW9zICgjNzcxNSkKCV9nZXRMaXN0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lbGVtZW50LmZpbmQoICJvbCx1bCIgKS5lcSggMCApOwoJfSwKCglfY3JlYXRlUGFuZWw6IGZ1bmN0aW9uKCBpZCApIHsKCQlyZXR1cm4gJCggIjxkaXY+IiApCgkJCS5hdHRyKCAiaWQiLCBpZCApCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtcGFuZWwgdWktd2lkZ2V0LWNvbnRlbnQgdWktY29ybmVyLWJvdHRvbSIgKQoJCQkuZGF0YSggInVpLXRhYnMtZGVzdHJveSIsIHRydWUgKTsKCX0sCgoJX3NldHVwRGlzYWJsZWQ6IGZ1bmN0aW9uKCBkaXNhYmxlZCApIHsKCQlpZiAoICQuaXNBcnJheSggZGlzYWJsZWQgKSApIHsKCQkJaWYgKCAhZGlzYWJsZWQubGVuZ3RoICkgewoJCQkJZGlzYWJsZWQgPSBmYWxzZTsKCQkJfSBlbHNlIGlmICggZGlzYWJsZWQubGVuZ3RoID09PSB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQkJZGlzYWJsZWQgPSB0cnVlOwoJCQl9CgkJfQoKCQkvLyBkaXNhYmxlIHRhYnMKCQlmb3IgKCB2YXIgaSA9IDAsIGxpOyAoIGxpID0gdGhpcy50YWJzWyBpIF0gKTsgaSsrICkgewoJCQlpZiAoIGRpc2FibGVkID09PSB0cnVlIHx8ICQuaW5BcnJheSggaSwgZGlzYWJsZWQgKSAhPT0gLTEgKSB7CgkJCQkkKCBsaSApCgkJCQkJLmFkZENsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkKCQkJCQkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCAidHJ1ZSIgKTsKCQkJfSBlbHNlIHsKCQkJCSQoIGxpICkKCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1kaXNhYmxlZCIgKTsKCQkJfQoJCX0KCgkJdGhpcy5vcHRpb25zLmRpc2FibGVkID0gZGlzYWJsZWQ7Cgl9LAoKCV9zZXR1cEV2ZW50czogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBldmVudHMgPSB7CgkJCWNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJfTsKCQlpZiAoIGV2ZW50ICkgewoJCQkkLmVhY2goIGV2ZW50LnNwbGl0KCIgIiksIGZ1bmN0aW9uKCBpbmRleCwgZXZlbnROYW1lICkgewoJCQkJZXZlbnRzWyBldmVudE5hbWUgXSA9ICJfZXZlbnRIYW5kbGVyIjsKCQkJfSk7CgkJfQoKCQl0aGlzLl9vZmYoIHRoaXMuYW5jaG9ycy5hZGQoIHRoaXMudGFicyApLmFkZCggdGhpcy5wYW5lbHMgKSApOwoJCXRoaXMuX29uKCB0aGlzLmFuY2hvcnMsIGV2ZW50cyApOwoJCXRoaXMuX29uKCB0aGlzLnRhYnMsIHsga2V5ZG93bjogIl90YWJLZXlkb3duIiB9ICk7CgkJdGhpcy5fb24oIHRoaXMucGFuZWxzLCB7IGtleWRvd246ICJfcGFuZWxLZXlkb3duIiB9ICk7CgoJCXRoaXMuX2ZvY3VzYWJsZSggdGhpcy50YWJzICk7CgkJdGhpcy5faG92ZXJhYmxlKCB0aGlzLnRhYnMgKTsKCX0sCgoJX3NldHVwSGVpZ2h0U3R5bGU6IGZ1bmN0aW9uKCBoZWlnaHRTdHlsZSApIHsKCQl2YXIgbWF4SGVpZ2h0LAoJCQlwYXJlbnQgPSB0aGlzLmVsZW1lbnQucGFyZW50KCk7CgoJCWlmICggaGVpZ2h0U3R5bGUgPT09ICJmaWxsIiApIHsKCQkJbWF4SGVpZ2h0ID0gcGFyZW50LmhlaWdodCgpOwoJCQltYXhIZWlnaHQgLT0gdGhpcy5lbGVtZW50Lm91dGVySGVpZ2h0KCkgLSB0aGlzLmVsZW1lbnQuaGVpZ2h0KCk7CgoJCQl0aGlzLmVsZW1lbnQuc2libGluZ3MoICI6dmlzaWJsZSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGVsZW0gPSAkKCB0aGlzICksCgkJCQkJcG9zaXRpb24gPSBlbGVtLmNzcyggInBvc2l0aW9uIiApOwoKCQkJCWlmICggcG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgfHwgcG9zaXRpb24gPT09ICJmaXhlZCIgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJbWF4SGVpZ2h0IC09IGVsZW0ub3V0ZXJIZWlnaHQoIHRydWUgKTsKCQkJfSk7CgoJCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oKS5ub3QoIHRoaXMucGFuZWxzICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCW1heEhlaWdodCAtPSAkKCB0aGlzICkub3V0ZXJIZWlnaHQoIHRydWUgKTsKCQkJfSk7CgoJCQl0aGlzLnBhbmVscy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmhlaWdodCggTWF0aC5tYXgoIDAsIG1heEhlaWdodCAtCgkJCQkJJCggdGhpcyApLmlubmVySGVpZ2h0KCkgKyAkKCB0aGlzICkuaGVpZ2h0KCkgKSApOwoJCQl9KQoJCQkuY3NzKCAib3ZlcmZsb3ciLCAiYXV0byIgKTsKCQl9IGVsc2UgaWYgKCBoZWlnaHRTdHlsZSA9PT0gImF1dG8iICkgewoJCQltYXhIZWlnaHQgPSAwOwoJCQl0aGlzLnBhbmVscy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJbWF4SGVpZ2h0ID0gTWF0aC5tYXgoIG1heEhlaWdodCwgJCggdGhpcyApLmhlaWdodCggIiIgKS5oZWlnaHQoKSApOwoJCQl9KS5oZWlnaHQoIG1heEhlaWdodCApOwoJCX0KCX0sCgoJX2V2ZW50SGFuZGxlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlhY3RpdmUgPSB0aGlzLmFjdGl2ZSwKCQkJYW5jaG9yID0gJCggZXZlbnQuY3VycmVudFRhcmdldCApLAoJCQl0YWIgPSBhbmNob3IuY2xvc2VzdCggImxpIiApLAoJCQljbGlja2VkSXNBY3RpdmUgPSB0YWJbIDAgXSA9PT0gYWN0aXZlWyAwIF0sCgkJCWNvbGxhcHNpbmcgPSBjbGlja2VkSXNBY3RpdmUgJiYgb3B0aW9ucy5jb2xsYXBzaWJsZSwKCQkJdG9TaG93ID0gY29sbGFwc2luZyA/ICQoKSA6IHRoaXMuX2dldFBhbmVsRm9yVGFiKCB0YWIgKSwKCQkJdG9IaWRlID0gIWFjdGl2ZS5sZW5ndGggPyAkKCkgOiB0aGlzLl9nZXRQYW5lbEZvclRhYiggYWN0aXZlICksCgkJCWV2ZW50RGF0YSA9IHsKCQkJCW9sZFRhYjogYWN0aXZlLAoJCQkJb2xkUGFuZWw6IHRvSGlkZSwKCQkJCW5ld1RhYjogY29sbGFwc2luZyA/ICQoKSA6IHRhYiwKCQkJCW5ld1BhbmVsOiB0b1Nob3cKCQkJfTsKCgkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJaWYgKCB0YWIuaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKSB8fAoJCQkJLy8gdGFiIGlzIGFscmVhZHkgbG9hZGluZwoJCQkJdGFiLmhhc0NsYXNzKCAidWktdGFicy1sb2FkaW5nIiApIHx8CgkJCQkvLyBjYW4ndCBzd2l0Y2ggZHVybmluZyBhbiBhbmltYXRpb24KCQkJCXRoaXMucnVubmluZyB8fAoJCQkJLy8gY2xpY2sgb24gYWN0aXZlIGhlYWRlciwgYnV0IG5vdCBjb2xsYXBzaWJsZQoJCQkJKCBjbGlja2VkSXNBY3RpdmUgJiYgIW9wdGlvbnMuY29sbGFwc2libGUgKSB8fAoJCQkJLy8gYWxsb3cgY2FuY2VsaW5nIGFjdGl2YXRpb24KCQkJCSggdGhpcy5fdHJpZ2dlciggImJlZm9yZUFjdGl2YXRlIiwgZXZlbnQsIGV2ZW50RGF0YSApID09PSBmYWxzZSApICkgewoJCQlyZXR1cm47CgkJfQoKCQlvcHRpb25zLmFjdGl2ZSA9IGNvbGxhcHNpbmcgPyBmYWxzZSA6IHRoaXMudGFicy5pbmRleCggdGFiICk7CgoJCXRoaXMuYWN0aXZlID0gY2xpY2tlZElzQWN0aXZlID8gJCgpIDogdGFiOwoJCWlmICggdGhpcy54aHIgKSB7CgkJCXRoaXMueGhyLmFib3J0KCk7CgkJfQoKCQlpZiAoICF0b0hpZGUubGVuZ3RoICYmICF0b1Nob3cubGVuZ3RoICkgewoJCQkkLmVycm9yKCAialF1ZXJ5IFVJIFRhYnM6IE1pc21hdGNoaW5nIGZyYWdtZW50IGlkZW50aWZpZXIuIiApOwoJCX0KCgkJaWYgKCB0b1Nob3cubGVuZ3RoICkgewoJCQl0aGlzLmxvYWQoIHRoaXMudGFicy5pbmRleCggdGFiICksIGV2ZW50ICk7CgkJfQoJCXRoaXMuX3RvZ2dsZSggZXZlbnQsIGV2ZW50RGF0YSApOwoJfSwKCgkvLyBoYW5kbGVzIHNob3cvaGlkZSBmb3Igc2VsZWN0aW5nIHRhYnMKCV90b2dnbGU6IGZ1bmN0aW9uKCBldmVudCwgZXZlbnREYXRhICkgewoJCXZhciB0aGF0ID0gdGhpcywKCQkJdG9TaG93ID0gZXZlbnREYXRhLm5ld1BhbmVsLAoJCQl0b0hpZGUgPSBldmVudERhdGEub2xkUGFuZWw7CgoJCXRoaXMucnVubmluZyA9IHRydWU7CgoJCWZ1bmN0aW9uIGNvbXBsZXRlKCkgewoJCQl0aGF0LnJ1bm5pbmcgPSBmYWxzZTsKCQkJdGhhdC5fdHJpZ2dlciggImFjdGl2YXRlIiwgZXZlbnQsIGV2ZW50RGF0YSApOwoJCX0KCgkJZnVuY3Rpb24gc2hvdygpIHsKCQkJZXZlbnREYXRhLm5ld1RhYi5jbG9zZXN0KCAibGkiICkuYWRkQ2xhc3MoICJ1aS10YWJzLWFjdGl2ZSB1aS1zdGF0ZS1hY3RpdmUiICk7CgoJCQlpZiAoIHRvU2hvdy5sZW5ndGggJiYgdGhhdC5vcHRpb25zLnNob3cgKSB7CgkJCQl0aGF0Ll9zaG93KCB0b1Nob3csIHRoYXQub3B0aW9ucy5zaG93LCBjb21wbGV0ZSApOwoJCQl9IGVsc2UgewoJCQkJdG9TaG93LnNob3coKTsKCQkJCWNvbXBsZXRlKCk7CgkJCX0KCQl9CgoJCS8vIHN0YXJ0IG91dCBieSBoaWRpbmcsIHRoZW4gc2hvd2luZywgdGhlbiBjb21wbGV0aW5nCgkJaWYgKCB0b0hpZGUubGVuZ3RoICYmIHRoaXMub3B0aW9ucy5oaWRlICkgewoJCQl0aGlzLl9oaWRlKCB0b0hpZGUsIHRoaXMub3B0aW9ucy5oaWRlLCBmdW5jdGlvbigpIHsKCQkJCWV2ZW50RGF0YS5vbGRUYWIuY2xvc2VzdCggImxpIiApLnJlbW92ZUNsYXNzKCAidWktdGFicy1hY3RpdmUgdWktc3RhdGUtYWN0aXZlIiApOwoJCQkJc2hvdygpOwoJCQl9KTsKCQl9IGVsc2UgewoJCQlldmVudERhdGEub2xkVGFiLmNsb3Nlc3QoICJsaSIgKS5yZW1vdmVDbGFzcyggInVpLXRhYnMtYWN0aXZlIHVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJdG9IaWRlLmhpZGUoKTsKCQkJc2hvdygpOwoJCX0KCgkJdG9IaWRlLmF0dHIoewoJCQkiYXJpYS1leHBhbmRlZCI6ICJmYWxzZSIsCgkJCSJhcmlhLWhpZGRlbiI6ICJ0cnVlIgoJCX0pOwoJCWV2ZW50RGF0YS5vbGRUYWIuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCAiZmFsc2UiICk7CgkJLy8gSWYgd2UncmUgc3dpdGNoaW5nIHRhYnMsIHJlbW92ZSB0aGUgb2xkIHRhYiBmcm9tIHRoZSB0YWIgb3JkZXIuCgkJLy8gSWYgd2UncmUgb3BlbmluZyBmcm9tIGNvbGxhcHNlZCBzdGF0ZSwgcmVtb3ZlIHRoZSBwcmV2aW91cyB0YWIgZnJvbSB0aGUgdGFiIG9yZGVyLgoJCS8vIElmIHdlJ3JlIGNvbGxhcHNpbmcsIHRoZW4ga2VlcCB0aGUgY29sbGFwc2luZyB0YWIgaW4gdGhlIHRhYiBvcmRlci4KCQlpZiAoIHRvU2hvdy5sZW5ndGggJiYgdG9IaWRlLmxlbmd0aCApIHsKCQkJZXZlbnREYXRhLm9sZFRhYi5hdHRyKCAidGFiSW5kZXgiLCAtMSApOwoJCX0gZWxzZSBpZiAoIHRvU2hvdy5sZW5ndGggKSB7CgkJCXRoaXMudGFicy5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gJCggdGhpcyApLmF0dHIoICJ0YWJJbmRleCIgKSA9PT0gMDsKCQkJfSkKCQkJLmF0dHIoICJ0YWJJbmRleCIsIC0xICk7CgkJfQoKCQl0b1Nob3cuYXR0cih7CgkJCSJhcmlhLWV4cGFuZGVkIjogInRydWUiLAoJCQkiYXJpYS1oaWRkZW4iOiAiZmFsc2UiCgkJfSk7CgkJZXZlbnREYXRhLm5ld1RhYi5hdHRyKHsKCQkJImFyaWEtc2VsZWN0ZWQiOiAidHJ1ZSIsCgkJCXRhYkluZGV4OiAwCgkJfSk7Cgl9LAoKCV9hY3RpdmF0ZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXZhciBhbmNob3IsCgkJCWFjdGl2ZSA9IHRoaXMuX2ZpbmRBY3RpdmUoIGluZGV4ICk7CgoJCS8vIHRyeWluZyB0byBhY3RpdmF0ZSB0aGUgYWxyZWFkeSBhY3RpdmUgcGFuZWwKCQlpZiAoIGFjdGl2ZVsgMCBdID09PSB0aGlzLmFjdGl2ZVsgMCBdICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyB0cnlpbmcgdG8gY29sbGFwc2UsIHNpbXVsYXRlIGEgY2xpY2sgb24gdGhlIGN1cnJlbnQgYWN0aXZlIGhlYWRlcgoJCWlmICggIWFjdGl2ZS5sZW5ndGggKSB7CgkJCWFjdGl2ZSA9IHRoaXMuYWN0aXZlOwoJCX0KCgkJYW5jaG9yID0gYWN0aXZlLmZpbmQoICIudWktdGFicy1hbmNob3IiIClbIDAgXTsKCQl0aGlzLl9ldmVudEhhbmRsZXIoewoJCQl0YXJnZXQ6IGFuY2hvciwKCQkJY3VycmVudFRhcmdldDogYW5jaG9yLAoJCQlwcmV2ZW50RGVmYXVsdDogJC5ub29wCgkJfSk7Cgl9LAoKCV9maW5kQWN0aXZlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJcmV0dXJuIGluZGV4ID09PSBmYWxzZSA/ICQoKSA6IHRoaXMudGFicy5lcSggaW5kZXggKTsKCX0sCgoJX2dldEluZGV4OiBmdW5jdGlvbiggaW5kZXggKSB7CgkJLy8gbWV0YS1mdW5jdGlvbiB0byBnaXZlIHVzZXJzIG9wdGlvbiB0byBwcm92aWRlIGEgaHJlZiBzdHJpbmcgaW5zdGVhZCBvZiBhIG51bWVyaWNhbCBpbmRleC4KCQlpZiAoIHR5cGVvZiBpbmRleCA9PT0gInN0cmluZyIgKSB7CgkJCWluZGV4ID0gdGhpcy5hbmNob3JzLmluZGV4KCB0aGlzLmFuY2hvcnMuZmlsdGVyKCAiW2hyZWYkPSciICsgaW5kZXggKyAiJ10iICkgKTsKCQl9CgoJCXJldHVybiBpbmRleDsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy54aHIgKSB7CgkJCXRoaXMueGhyLmFib3J0KCk7CgkJfQoKCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS10YWJzIHVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCB1aS1jb3JuZXItYWxsIHVpLXRhYnMtY29sbGFwc2libGUiICk7CgoJCXRoaXMudGFibGlzdAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS10YWJzLW5hdiB1aS1oZWxwZXItcmVzZXQgdWktaGVscGVyLWNsZWFyZml4IHVpLXdpZGdldC1oZWFkZXIgdWktY29ybmVyLWFsbCIgKQoJCQkucmVtb3ZlQXR0ciggInJvbGUiICk7CgoJCXRoaXMuYW5jaG9ycwoJCQkucmVtb3ZlQ2xhc3MoICJ1aS10YWJzLWFuY2hvciIgKQoJCQkucmVtb3ZlQXR0ciggInJvbGUiICkKCQkJLnJlbW92ZUF0dHIoICJ0YWJJbmRleCIgKQoJCQkucmVtb3ZlVW5pcXVlSWQoKTsKCgkJdGhpcy50YWJzLmFkZCggdGhpcy5wYW5lbHMgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoICQuZGF0YSggdGhpcywgInVpLXRhYnMtZGVzdHJveSIgKSApIHsKCQkJCSQoIHRoaXMgKS5yZW1vdmUoKTsKCQkJfSBlbHNlIHsKCQkJCSQoIHRoaXMgKQoJCQkJCS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWRlZmF1bHQgdWktc3RhdGUtYWN0aXZlIHVpLXN0YXRlLWRpc2FibGVkICIgKwoJCQkJCQkidWktY29ybmVyLXRvcCB1aS1jb3JuZXItYm90dG9tIHVpLXdpZGdldC1jb250ZW50IHVpLXRhYnMtYWN0aXZlIHVpLXRhYnMtcGFuZWwiICkKCQkJCQkucmVtb3ZlQXR0ciggInRhYkluZGV4IiApCgkJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWxpdmUiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtYnVzeSIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1zZWxlY3RlZCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1sYWJlbGxlZGJ5IiApCgkJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWhpZGRlbiIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1leHBhbmRlZCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAicm9sZSIgKTsKCQkJfQoJCX0pOwoKCQl0aGlzLnRhYnMuZWFjaChmdW5jdGlvbigpIHsKCQkJdmFyIGxpID0gJCggdGhpcyApLAoJCQkJcHJldiA9IGxpLmRhdGEoICJ1aS10YWJzLWFyaWEtY29udHJvbHMiICk7CgkJCWlmICggcHJldiApIHsKCQkJCWxpCgkJCQkJLmF0dHIoICJhcmlhLWNvbnRyb2xzIiwgcHJldiApCgkJCQkJLnJlbW92ZURhdGEoICJ1aS10YWJzLWFyaWEtY29udHJvbHMiICk7CgkJCX0gZWxzZSB7CgkJCQlsaS5yZW1vdmVBdHRyKCAiYXJpYS1jb250cm9scyIgKTsKCQkJfQoJCX0pOwoKCQl0aGlzLnBhbmVscy5zaG93KCk7CgoJCWlmICggdGhpcy5vcHRpb25zLmhlaWdodFN0eWxlICE9PSAiY29udGVudCIgKSB7CgkJCXRoaXMucGFuZWxzLmNzcyggImhlaWdodCIsICIiICk7CgkJfQoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQl2YXIgZGlzYWJsZWQgPSB0aGlzLm9wdGlvbnMuZGlzYWJsZWQ7CgkJaWYgKCBkaXNhYmxlZCA9PT0gZmFsc2UgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggaW5kZXggPT09IHVuZGVmaW5lZCApIHsKCQkJZGlzYWJsZWQgPSBmYWxzZTsKCQl9IGVsc2UgewoJCQlpbmRleCA9IHRoaXMuX2dldEluZGV4KCBpbmRleCApOwoJCQlpZiAoICQuaXNBcnJheSggZGlzYWJsZWQgKSApIHsKCQkJCWRpc2FibGVkID0gJC5tYXAoIGRpc2FibGVkLCBmdW5jdGlvbiggbnVtICkgewoJCQkJCXJldHVybiBudW0gIT09IGluZGV4ID8gbnVtIDogbnVsbDsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJZGlzYWJsZWQgPSAkLm1hcCggdGhpcy50YWJzLCBmdW5jdGlvbiggbGksIG51bSApIHsKCQkJCQlyZXR1cm4gbnVtICE9PSBpbmRleCA/IG51bSA6IG51bGw7CgkJCQl9KTsKCQkJfQoJCX0KCQl0aGlzLl9zZXR1cERpc2FibGVkKCBkaXNhYmxlZCApOwoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJdmFyIGRpc2FibGVkID0gdGhpcy5vcHRpb25zLmRpc2FibGVkOwoJCWlmICggZGlzYWJsZWQgPT09IHRydWUgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggaW5kZXggPT09IHVuZGVmaW5lZCApIHsKCQkJZGlzYWJsZWQgPSB0cnVlOwoJCX0gZWxzZSB7CgkJCWluZGV4ID0gdGhpcy5fZ2V0SW5kZXgoIGluZGV4ICk7CgkJCWlmICggJC5pbkFycmF5KCBpbmRleCwgZGlzYWJsZWQgKSAhPT0gLTEgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCAkLmlzQXJyYXkoIGRpc2FibGVkICkgKSB7CgkJCQlkaXNhYmxlZCA9ICQubWVyZ2UoIFsgaW5kZXggXSwgZGlzYWJsZWQgKS5zb3J0KCk7CgkJCX0gZWxzZSB7CgkJCQlkaXNhYmxlZCA9IFsgaW5kZXggXTsKCQkJfQoJCX0KCQl0aGlzLl9zZXR1cERpc2FibGVkKCBkaXNhYmxlZCApOwoJfSwKCglsb2FkOiBmdW5jdGlvbiggaW5kZXgsIGV2ZW50ICkgewoJCWluZGV4ID0gdGhpcy5fZ2V0SW5kZXgoIGluZGV4ICk7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQl0YWIgPSB0aGlzLnRhYnMuZXEoIGluZGV4ICksCgkJCWFuY2hvciA9IHRhYi5maW5kKCAiLnVpLXRhYnMtYW5jaG9yIiApLAoJCQlwYW5lbCA9IHRoaXMuX2dldFBhbmVsRm9yVGFiKCB0YWIgKSwKCQkJZXZlbnREYXRhID0gewoJCQkJdGFiOiB0YWIsCgkJCQlwYW5lbDogcGFuZWwKCQkJfTsKCgkJLy8gbm90IHJlbW90ZQoJCWlmICggaXNMb2NhbCggYW5jaG9yWyAwIF0gKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy54aHIgPSAkLmFqYXgoIHRoaXMuX2FqYXhTZXR0aW5ncyggYW5jaG9yLCBldmVudCwgZXZlbnREYXRhICkgKTsKCgkJLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKCQkvLyBqUXVlcnkgPDEuOCByZXR1cm5zIGZhbHNlIGlmIHRoZSByZXF1ZXN0IGlzIGNhbmNlbGVkIGluIGJlZm9yZVNlbmQsCgkJLy8gYnV0IGFzIG9mIDEuOCwgJC5hamF4KCkgYWx3YXlzIHJldHVybnMgYSBqcVhIUiBvYmplY3QuCgkJaWYgKCB0aGlzLnhociAmJiB0aGlzLnhoci5zdGF0dXNUZXh0ICE9PSAiY2FuY2VsZWQiICkgewoJCQl0YWIuYWRkQ2xhc3MoICJ1aS10YWJzLWxvYWRpbmciICk7CgkJCXBhbmVsLmF0dHIoICJhcmlhLWJ1c3kiLCAidHJ1ZSIgKTsKCgkJCXRoaXMueGhyCgkJCQkuc3VjY2VzcyhmdW5jdGlvbiggcmVzcG9uc2UgKSB7CgkJCQkJLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKCQkJCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMTc3OAoJCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJCXBhbmVsLmh0bWwoIHJlc3BvbnNlICk7CgkJCQkJCXRoYXQuX3RyaWdnZXIoICJsb2FkIiwgZXZlbnQsIGV2ZW50RGF0YSApOwoJCQkJCX0sIDEgKTsKCQkJCX0pCgkJCQkuY29tcGxldGUoZnVuY3Rpb24oIGpxWEhSLCBzdGF0dXMgKSB7CgkJCQkJLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKCQkJCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMTc3OAoJCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJCWlmICggc3RhdHVzID09PSAiYWJvcnQiICkgewoJCQkJCQkJdGhhdC5wYW5lbHMuc3RvcCggZmFsc2UsIHRydWUgKTsKCQkJCQkJfQoKCQkJCQkJdGFiLnJlbW92ZUNsYXNzKCAidWktdGFicy1sb2FkaW5nIiApOwoJCQkJCQlwYW5lbC5yZW1vdmVBdHRyKCAiYXJpYS1idXN5IiApOwoKCQkJCQkJaWYgKCBqcVhIUiA9PT0gdGhhdC54aHIgKSB7CgkJCQkJCQlkZWxldGUgdGhhdC54aHI7CgkJCQkJCX0KCQkJCQl9LCAxICk7CgkJCQl9KTsKCQl9Cgl9LAoKCV9hamF4U2V0dGluZ3M6IGZ1bmN0aW9uKCBhbmNob3IsIGV2ZW50LCBldmVudERhdGEgKSB7CgkJdmFyIHRoYXQgPSB0aGlzOwoJCXJldHVybiB7CgkJCXVybDogYW5jaG9yLmF0dHIoICJocmVmIiApLAoJCQliZWZvcmVTZW5kOiBmdW5jdGlvbigganFYSFIsIHNldHRpbmdzICkgewoJCQkJcmV0dXJuIHRoYXQuX3RyaWdnZXIoICJiZWZvcmVMb2FkIiwgZXZlbnQsCgkJCQkJJC5leHRlbmQoIHsganFYSFIgOiBqcVhIUiwgYWpheFNldHRpbmdzOiBzZXR0aW5ncyB9LCBldmVudERhdGEgKSApOwoJCQl9CgkJfTsKCX0sCgoJX2dldFBhbmVsRm9yVGFiOiBmdW5jdGlvbiggdGFiICkgewoJCXZhciBpZCA9ICQoIHRhYiApLmF0dHIoICJhcmlhLWNvbnRyb2xzIiApOwoJCXJldHVybiB0aGlzLmVsZW1lbnQuZmluZCggdGhpcy5fc2FuaXRpemVTZWxlY3RvciggIiMiICsgaWQgKSApOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdyApIHsKCgkkLm1vYmlsZS5pb3NvcmllbnRhdGlvbmZpeEVuYWJsZWQgPSB0cnVlOwoKCS8vIFRoaXMgZml4IGFkZHJlc3NlcyBhbiBpT1MgYnVnLCBzbyByZXR1cm4gZWFybHkgaWYgdGhlIFVBIGNsYWltcyBpdCdzIHNvbWV0aGluZyBlbHNlLgoJdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQl6b29tLAoJCWV2dCwgeCwgeSwgeiwgYWlnOwoJaWYgKCAhKCAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgL09TIFsxLTVdX1swLTlfXSogbGlrZSBNYWMgT1MgWC9pLnRlc3QoIHVhICkgJiYgdWEuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEgKSApewoJCSQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCA9IGZhbHNlOwoJCXJldHVybjsKCX0KCgl6b29tID0gJC5tb2JpbGUuem9vbTsKCglmdW5jdGlvbiBjaGVja1RpbHQoIGUgKSB7CgkJZXZ0ID0gZS5vcmlnaW5hbEV2ZW50OwoJCWFpZyA9IGV2dC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5OwoKCQl4ID0gTWF0aC5hYnMoIGFpZy54ICk7CgkJeSA9IE1hdGguYWJzKCBhaWcueSApOwoJCXogPSBNYXRoLmFicyggYWlnLnogKTsKCgkJLy8gSWYgcG9ydHJhaXQgb3JpZW50YXRpb24gYW5kIGluIG9uZSBvZiB0aGUgZGFuZ2VyIHpvbmVzCgkJaWYgKCAhd2luZG93Lm9yaWVudGF0aW9uICYmICggeCA+IDcgfHwgKCAoIHogPiA2ICYmIHkgPCA4IHx8IHogPCA4ICYmIHkgPiA2ICkgJiYgeCA+IDUgKSApICkgewoJCQkJaWYgKCB6b29tLmVuYWJsZWQgKSB7CgkJCQkJem9vbS5kaXNhYmxlKCk7CgkJCQl9CgkJfQllbHNlIGlmICggIXpvb20uZW5hYmxlZCApIHsKCQkJCXpvb20uZW5hYmxlKCk7CgkJfQoJfQoKCSQubW9iaWxlLmRvY3VtZW50Lm9uKCAibW9iaWxlaW5pdCIsIGZ1bmN0aW9uKCkgewoJCWlmICggJC5tb2JpbGUuaW9zb3JpZW50YXRpb25maXhFbmFibGVkICl7CgkJCSQubW9iaWxlLndpbmRvdwoJCQkJLmJpbmQoICJvcmllbnRhdGlvbmNoYW5nZS5pb3NvcmllbnRhdGlvbmZpeCIsIHpvb20uZW5hYmxlICkKCQkJCS5iaW5kKCAiZGV2aWNlbW90aW9uLmlvc29yaWVudGF0aW9uZml4IiwgY2hlY2tUaWx0ICk7CgkJfQoJfSk7Cgp9KCBqUXVlcnksIHRoaXMgKSk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyCSRodG1sID0gJCggImh0bWwiICksCgkJJHdpbmRvdyA9ICQubW9iaWxlLndpbmRvdzsKCgkvL3JlbW92ZSBpbml0aWFsIGJ1aWxkIGNsYXNzIChvbmx5IHByZXNlbnQgb24gZmlyc3QgcGFnZXNob3cpCglmdW5jdGlvbiBoaWRlUmVuZGVyaW5nQ2xhc3MoKSB7CgkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1tb2JpbGUtcmVuZGVyaW5nIiApOwoJfQoKCS8vIHRyaWdnZXIgbW9iaWxlaW5pdCBldmVudCAtIHVzZWZ1bCBob29rIGZvciBjb25maWd1cmluZyAkLm1vYmlsZSBzZXR0aW5ncyBiZWZvcmUgdGhleSdyZSB1c2VkCgkkKCB3aW5kb3cuZG9jdW1lbnQgKS50cmlnZ2VyKCAibW9iaWxlaW5pdCIgKTsKCgkvLyBzdXBwb3J0IGNvbmRpdGlvbnMKCS8vIGlmIGRldmljZSBzdXBwb3J0IGNvbmRpdGlvbihzKSBhcmVuJ3QgbWV0LCBsZWF2ZSB0aGluZ3MgYXMgdGhleSBhcmUgLT4gYSBiYXNpYywgdXNhYmxlIGV4cGVyaWVuY2UsCgkvLyBvdGhlcndpc2UsIHByb2NlZWQgd2l0aCB0aGUgZW5oYW5jZW1lbnRzCglpZiAoICEkLm1vYmlsZS5ncmFkZUEoKSApIHsKCQlyZXR1cm47Cgl9CgoJLy8gb3ZlcnJpZGUgYWpheEVuYWJsZWQgb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBrbm93biBjb25mbGljdHMgd2l0aCBoYXNoIGhpc3RvcnkgdXBkYXRlcwoJLy8gb3IgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoQkI1LCBPcGVyYSBNaW5pKQoJaWYgKCAkLm1vYmlsZS5hamF4QmxhY2tsaXN0ICkgewoJCSQubW9iaWxlLmFqYXhFbmFibGVkID0gZmFsc2U7Cgl9CgoJLy8gQWRkIG1vYmlsZSwgaW5pdGlhbCBsb2FkICJyZW5kZXJpbmciIGNsYXNzZXMgdG8gZG9jRWwKCSRodG1sLmFkZENsYXNzKCAidWktbW9iaWxlIHVpLW1vYmlsZS1yZW5kZXJpbmciICk7CgoJLy8gVGhpcyBpcyBhIGZhbGxiYWNrLiBJZiBhbnl0aGluZyBnb2VzIHdyb25nIChKUyBlcnJvcnMsIGV0YyksIG9yIGV2ZW50cyBkb24ndCBmaXJlLAoJLy8gdGhpcyBlbnN1cmVzIHRoZSByZW5kZXJpbmcgY2xhc3MgaXMgcmVtb3ZlZCBhZnRlciA1IHNlY29uZHMsIHNvIGNvbnRlbnQgaXMgdmlzaWJsZSBhbmQgYWNjZXNzaWJsZQoJc2V0VGltZW91dCggaGlkZVJlbmRlcmluZ0NsYXNzLCA1MDAwICk7CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gZmluZCBhbmQgZW5oYW5jZSB0aGUgcGFnZXMgaW4gdGhlIGRvbSBhbmQgdHJhbnNpdGlvbiB0byB0aGUgZmlyc3QgcGFnZS4KCQlpbml0aWFsaXplUGFnZTogZnVuY3Rpb24oKSB7CgkJCS8vIGZpbmQgcHJlc2VudCBwYWdlcwoJCQl2YXIgcGF0aCA9ICQubW9iaWxlLnBhdGgsCgkJCQkkcGFnZXMgPSAkKCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKSwKCQkJCWhhc2ggPSBwYXRoLnN0cmlwSGFzaCggcGF0aC5zdHJpcFF1ZXJ5UGFyYW1zKHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gpICksCgkJCQloYXNoUGFnZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBoYXNoICk7CgoJCQkvLyBpZiBubyBwYWdlcyBhcmUgZm91bmQsIGNyZWF0ZSBvbmUgd2l0aCBib2R5J3MgaW5uZXIgaHRtbAoJCQlpZiAoICEkcGFnZXMubGVuZ3RoICkgewoJCQkJJHBhZ2VzID0gJCggImJvZHkiICkud3JhcElubmVyKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJz48L2Rpdj4iICkuY2hpbGRyZW4oIDAgKTsKCQkJfQoKCQkJLy8gYWRkIGRpYWxvZ3MsIHNldCBkYXRhLXVybCBhdHRycwoJCQkkcGFnZXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCQkvLyB1bmxlc3MgdGhlIGRhdGEgdXJsIGlzIGFscmVhZHkgc2V0IHNldCBpdCB0byB0aGUgcGF0aG5hbWUKCQkJCWlmICggISR0aGlzWyAwIF0uZ2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiApICkgewoJCQkJCSR0aGlzLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiLCAkdGhpcy5hdHRyKCAiaWQiICkgfHwgbG9jYXRpb24ucGF0aG5hbWUgKyBsb2NhdGlvbi5zZWFyY2ggKTsKCQkJCX0KCQkJfSk7CgoJCQkvLyBkZWZpbmUgZmlyc3QgcGFnZSBpbiBkb20gY2FzZSBvbmUgYmFja3Mgb3V0IHRvIHRoZSBkaXJlY3Rvcnkgcm9vdCAobm90IGFsd2F5cyB0aGUgZmlyc3QgcGFnZSB2aXNpdGVkLCBidXQgZGVmaW5lZCBhcyBmYWxsYmFjaykKCQkJJC5tb2JpbGUuZmlyc3RQYWdlID0gJHBhZ2VzLmZpcnN0KCk7CgoJCQkvLyBkZWZpbmUgcGFnZSBjb250YWluZXIKCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lciA9ICQubW9iaWxlLmZpcnN0UGFnZQoJCQkJLnBhcmVudCgpCgkJCQkuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtdmlld3BvcnQiICkKCQkJCS5jb250ZW50KCk7CgoJCQkvLyBpbml0aWFsaXplIG5hdmlnYXRpb24gZXZlbnRzIG5vdywgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgb2NjdXJyZWQgYW5kIHRoZSBwYWdlIGNvbnRhaW5lcgoJCQkvLyBoYXMgYmVlbiBjcmVhdGVkIGJ1dCBiZWZvcmUgdGhlIHJlc3Qgb2YgdGhlIGxpYnJhcnkgaXMgYWxlcnRlZCB0byB0aGF0IGZhY3QKCQkJJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZC5yZXNvbHZlKCk7CgoJCQkvLyBhbGVydCBsaXN0ZW5lcnMgdGhhdCB0aGUgcGFnZWNvbnRhaW5lciBoYXMgYmVlbiBkZXRlcm1pbmVkIGZvciBiaW5kaW5nCgkJCS8vIHRvIGV2ZW50cyB0cmlnZ2VyZWQgb24gaXQKCQkJJHdpbmRvdy50cmlnZ2VyKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIgKTsKCgkJCS8vIGN1ZSBwYWdlIGxvYWRpbmcgbWVzc2FnZQoJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coKTsKCgkJCS8vcmVtb3ZlIGluaXRpYWwgYnVpbGQgY2xhc3MgKG9ubHkgcHJlc2VudCBvbiBmaXJzdCBwYWdlc2hvdykKCQkJaGlkZVJlbmRlcmluZ0NsYXNzKCk7CgoJCQkvLyBpZiBoYXNoY2hhbmdlIGxpc3RlbmluZyBpcyBkaXNhYmxlZCwgdGhlcmUncyBubyBoYXNoIGRlZXBsaW5rLAoJCQkvLyB0aGUgaGFzaCBpcyBub3QgdmFsaWQgKGNvbnRhaW5zIG1vcmUgdGhhbiBvbmUgIyBvciBkb2VzIG5vdCBzdGFydCB3aXRoICMpCgkJCS8vIG9yIHRoZXJlIGlzIG5vIHBhZ2Ugd2l0aCB0aGF0IGhhc2gsIGNoYW5nZSB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgRE9NCgkJCS8vIFJlbWVtYmVyLCBob3dldmVyLCB0aGF0IHRoZSBoYXNoIGNhbiBhbHNvIGJlIGEgcGF0aCEKCQkJaWYgKCAhICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgJiYKCQkJCSQubW9iaWxlLnBhdGguaXNIYXNoVmFsaWQoIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJKCAkKCBoYXNoUGFnZSApLmlzKCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApIHx8CgkJCQkJJC5tb2JpbGUucGF0aC5pc1BhdGgoIGhhc2ggKSB8fAoJCQkJCWhhc2ggPT09ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgKSApICkgewoKCQkJCS8vIFN0b3JlIHRoZSBpbml0aWFsIGRlc3RpbmF0aW9uCgkJCQlpZiAoICQubW9iaWxlLnBhdGguaXNIYXNoVmFsaWQoIGxvY2F0aW9uLmhhc2ggKSApIHsKCQkJCQkkLm1vYmlsZS51cmxIaXN0b3J5LmluaXRpYWxEc3QgPSBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKTsKCQkJCX0KCgkJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IGluaXRpYWwgcG9wc3RhdGUgc3RhdGUgaWYgaXQgZXhpc3RzCgkJCQkvLyBzbyB0aGF0IG5hdmlnYXRpb24gYmFjayB0byB0aGUgaW5pdGlhbCBwYWdlIHdvcmtzIHByb3Blcmx5CgkJCQlpZiAoICQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3Iuc3F1YXNoKCBwYXRoLnBhcnNlTG9jYXRpb24oKS5ocmVmICk7CgkJCQl9CgoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggJC5tb2JpbGUuZmlyc3RQYWdlLCB7CgkJCQkJdHJhbnNpdGlvbjogIm5vbmUiLAoJCQkJCXJldmVyc2U6IHRydWUsCgkJCQkJY2hhbmdlSGFzaDogZmFsc2UsCgkJCQkJZnJvbUhhc2hDaGFuZ2U6IHRydWUKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJLy8gdHJpZ2dlciBoYXNoY2hhbmdlIG9yIG5hdmlnYXRlIHRvIHNxdWFzaCBhbmQgcmVjb3JkIHRoZSBjb3JyZWN0CgkJCQkvLyBoaXN0b3J5IGVudHJ5IGZvciBhbiBpbml0aWFsIGhhc2ggcGF0aAoJCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJCSR3aW5kb3cudHJpZ2dlciggImhhc2hjaGFuZ2UiLCBbdHJ1ZV0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gVE9ETyBmaWd1cmUgb3V0IGhvdyB0byBzaW1wbGlmeSB0aGlzIGludGVyYWN0aW9uIHdpdGggdGhlIGluaXRpYWwgaGlzdG9yeSBlbnRyeQoJCQkJCS8vIGF0IHRoZSBib3R0b20ganMvbmF2aWdhdGUvbmF2aWdhdGUuanMKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LnN0YWNrID0gW107CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUoICQubW9iaWxlLnBhdGguaXNQYXRoKCBsb2NhdGlvbi5oYXNoICkgPyBsb2NhdGlvbi5oYXNoIDogbG9jYXRpb24uaHJlZiApOwoJCQkJfQoJCQl9CgkJfQoJfSk7CgoJJChmdW5jdGlvbigpIHsKCQkvL1J1biBpbmxpbmVTVkcgc3VwcG9ydCB0ZXN0CgkJJC5zdXBwb3J0LmlubGluZVNWRygpOwoJCQoJCS8vIGNoZWNrIHdoaWNoIHNjcm9sbFRvcCB2YWx1ZSBzaG91bGQgYmUgdXNlZCBieSBzY3JvbGxpbmcgdG8gMSBpbW1lZGlhdGVseSBhdCBkb21yZWFkeQoJCS8vIHRoZW4gY2hlY2sgd2hhdCB0aGUgc2Nyb2xsIHRvcCBpcy4gQW5kcm9pZCB3aWxsIHJlcG9ydCAwLi4uIG90aGVycyAxCgkJLy8gbm90ZSB0aGF0IHRoaXMgaW5pdGlhbCBzY3JvbGwgd29uJ3QgaGlkZSB0aGUgYWRkcmVzcyBiYXIuIEl0J3MganVzdCBmb3IgdGhlIGNoZWNrLgoJCQoJCS8vIGhpZGUgaU9TIGJyb3dzZXIgY2hyb21lIG9uIGxvYWQgaWYgaGlkZVVybEJhciBpcyB0cnVlIHRoaXMgaXMgdG8gdHJ5IGFuZCBkbyBpdCBhcyBzb29uIGFzIHBvc3NpYmxlCgkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyICkgewoJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIDEgKTsKCQl9CgoJCS8vIGlmIGRlZmF1bHRIb21lU2Nyb2xsIGhhc24ndCBiZWVuIHNldCB5ZXQsIHNlZSBpZiBzY3JvbGxUb3AgaXMgMQoJCS8vIGl0IHNob3VsZCBiZSAxIGluIG1vc3QgYnJvd3NlcnMsIGJ1dCBhbmRyb2lkIHRyZWF0cyAxIGFzIDAgKGZvciBoaWRpbmcgYWRkciBiYXIpCgkJLy8gc28gaWYgaXQncyAxLCB1c2UgMCBmcm9tIG5vdyBvbgoJCSQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsID0gKCAhJC5zdXBwb3J0LnNjcm9sbFRvcCB8fCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCkgPT09IDEgKSA/IDAgOiAxOwoKCQkvL2RvbS1yZWFkeSBpbml0cwoJCWlmICggJC5tb2JpbGUuYXV0b0luaXRpYWxpemVQYWdlICkgewoJCQkkLm1vYmlsZS5pbml0aWFsaXplUGFnZSgpOwoJCX0KCgkJLy8gd2luZG93IGxvYWQgZXZlbnQKCQkvLyBoaWRlIGlPUyBicm93c2VyIGNocm9tZSBvbiBsb2FkIGlmIGhpZGVVcmxCYXIgaXMgdHJ1ZSB0aGlzIGlzIGFzIGZhbGwgYmFjayBpbmNhc2Ugd2Ugd2VyZSB0b28gZWFybHkgYmVmb3JlCgkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyICkgewoJCQkkd2luZG93LmxvYWQoICQubW9iaWxlLnNpbGVudFNjcm9sbCApOwoJCX0KCgkJaWYgKCAhJC5zdXBwb3J0LmNzc1BvaW50ZXJFdmVudHMgKSB7CgkJCS8vIElFIGFuZCBPcGVyYSBkb24ndCBzdXBwb3J0IENTUyBwb2ludGVyLWV2ZW50czogbm9uZSB0aGF0IHdlIHVzZSB0byBkaXNhYmxlIGxpbmstYmFzZWQgYnV0dG9ucwoJCQkvLyBieSBhZGRpbmcgdGhlICd1aS1kaXNhYmxlZCcgY2xhc3MgdG8gdGhlbS4gVXNpbmcgYSBKYXZhU2NyaXB0IHdvcmthcm91bmQgZm9yIHRob3NlIGJyb3dzZXIuCgkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzU1OAoKCQkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICIudWktZGlzYWJsZWQiLCAidmNsaWNrIiwKCQkJCWZ1bmN0aW9uKCBlICkgewoJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQllLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJfQoJCQkpOwoJCX0KCX0pOwp9KCBqUXVlcnksIHRoaXMgKSk7CgoKfSkpOwo=",
                "body": "LyohCiogalF1ZXJ5IE1vYmlsZSAxLjQuMC1hbHBoYS4yCiogR2l0IEhFQUQgaGFzaDogMWUyNzg0NGExYzBiOTEwM2EwOTQ4NDgwNjM3ZTZhNjdmNTIxMmRmZCA8PiBEYXRlOiBUaHUgQXVnIDE1IDIwMTMgMTM6NTM6NDkgVVRDCiogaHR0cDovL2pxdWVyeW1vYmlsZS5jb20KKgoqIENvcHlyaWdodCAyMDEwLCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uLCBJbmMuIGFuZCBvdGhlciBjb250cmlidXRvcnMKKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQoqCiovCgoKKGZ1bmN0aW9uICggcm9vdCwgZG9jLCBmYWN0b3J5ICkgewoJaWYgKCB0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQgKSB7CgkJLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLgoJCWRlZmluZSggWyAianF1ZXJ5IiBdLCBmdW5jdGlvbiAoICQgKSB7CgkJCWZhY3RvcnkoICQsIHJvb3QsIGRvYyApOwoJCQlyZXR1cm4gJC5tb2JpbGU7CgkJfSk7Cgl9IGVsc2UgewoJCS8vIEJyb3dzZXIgZ2xvYmFscwoJCWZhY3RvcnkoIHJvb3QualF1ZXJ5LCByb290LCBkb2MgKTsKCX0KfSggdGhpcywgZG9jdW1lbnQsIGZ1bmN0aW9uICggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7CihmdW5jdGlvbiggJCApIHsKCSQubW9iaWxlID0ge307Cn0oIGpRdWVyeSApKTsKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoKCQkvLyBWZXJzaW9uIG9mIHRoZSBqUXVlcnkgTW9iaWxlIEZyYW1ld29yawoJCXZlcnNpb246ICIxLjQuMC1hbHBoYS4yIiwKCgkJLy8gRGVwcmVjYXRlZCBhbmQgbm8gbG9uZ2VyIHVzZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQkvLyBEZWZpbmUgdGhlIHVybCBwYXJhbWV0ZXIgdXNlZCBmb3IgcmVmZXJlbmNpbmcgd2lkZ2V0LWdlbmVyYXRlZCBzdWItcGFnZXMuCgkJLy8gVHJhbnNsYXRlcyB0byBleGFtcGxlLmh0bWwmdWktcGFnZT1zdWJwYWdlSWRlbnRpZmllcgoJCS8vIGhhc2ggc2VnbWVudCBiZWZvcmUgJnVpLXBhZ2U9IGlzIHVzZWQgdG8gbWFrZSBBamF4IHJlcXVlc3QKCQlzdWJQYWdlVXJsS2V5OiAidWktcGFnZSIsCgoJCWhpZGVVcmxCYXI6IHRydWUsCgoJCS8vIEtlZXBuYXRpdmUgU2VsZWN0b3IKCQlrZWVwTmF0aXZlOiAiOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJLy8gQ2xhc3MgYXNzaWduZWQgdG8gcGFnZSBjdXJyZW50bHkgaW4gdmlldywgYW5kIGR1cmluZyB0cmFuc2l0aW9ucwoJCWFjdGl2ZVBhZ2VDbGFzczogInVpLXBhZ2UtYWN0aXZlIiwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCS8vIENsYXNzIHVzZWQgZm9yICJhY3RpdmUiIGJ1dHRvbiBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJYWN0aXZlQnRuQ2xhc3M6ICJ1aS1idG4tYWN0aXZlIiwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCS8vIENsYXNzIHVzZWQgZm9yICJmb2N1cyIgZm9ybSBlbGVtZW50IHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlmb2N1c0NsYXNzOiAidWktZm9jdXMiLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGhhbmRsZSBjbGlja3MgYW5kIGZvcm0gc3VibWlzc2lvbnMgdGhyb3VnaCBBamF4LCB3aGVuIHNhbWUtZG9tYWluCgkJYWpheEVuYWJsZWQ6IHRydWUsCgoJCS8vIEF1dG9tYXRpY2FsbHkgbG9hZCBhbmQgc2hvdyBwYWdlcyBiYXNlZCBvbiBsb2NhdGlvbi5oYXNoCgkJaGFzaExpc3RlbmluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIGRpc2FibGUgdG8gcHJldmVudCBqcXVlcnkgZnJvbSBib3RoZXJpbmcgd2l0aCBsaW5rcwoJCWxpbmtCaW5kaW5nRW5hYmxlZDogdHJ1ZSwKCgkJLy8gU2V0IGRlZmF1bHQgcGFnZSB0cmFuc2l0aW9uIC0gJ25vbmUnIGZvciBubyB0cmFuc2l0aW9ucwoJCWRlZmF1bHRQYWdlVHJhbnNpdGlvbjogImZhZGUiLAoKCQkvLyBTZXQgbWF4aW11bSB3aW5kb3cgd2lkdGggZm9yIHRyYW5zaXRpb25zIHRvIGFwcGx5IC0gJ2ZhbHNlJyBmb3Igbm8gbGltaXQKCQltYXhUcmFuc2l0aW9uV2lkdGg6IGZhbHNlLAoKCQkvLyBNaW5pbXVtIHNjcm9sbCBkaXN0YW5jZSB0aGF0IHdpbGwgYmUgcmVtZW1iZXJlZCB3aGVuIHJldHVybmluZyB0byBhIHBhZ2UKCQkvLyBEZXByZWNhdGVkIHJlbW92ZSBpbiAxLjUgCgkJbWluU2Nyb2xsQmFjazogMCwKCgkJLy8gREVQUkVDQVRFRDogdGhlIGZvbGxvd2luZyBwcm9wZXJ0eSBpcyBubyBsb25nZXIgaW4gdXNlLCBidXQgZGVmaW5lZCB1bnRpbCAyLjAgdG8gcHJldmVudCBjb25mbGljdHMKCQl0b3VjaE92ZXJmbG93RW5hYmxlZDogZmFsc2UsCgoJCS8vIFNldCBkZWZhdWx0IGRpYWxvZyB0cmFuc2l0aW9uIC0gJ25vbmUnIGZvciBubyB0cmFuc2l0aW9ucwoJCWRlZmF1bHREaWFsb2dUcmFuc2l0aW9uOiAicG9wIiwKCgkJLy8gRXJyb3IgcmVzcG9uc2UgbWVzc2FnZSAtIGFwcGVhcnMgd2hlbiBhbiBBamF4IHBhZ2UgcmVxdWVzdCBmYWlscwoJCXBhZ2VMb2FkRXJyb3JNZXNzYWdlOiAiRXJyb3IgTG9hZGluZyBQYWdlIiwKCgkJLy8gRm9yIGVycm9yIG1lc3NhZ2VzLCB3aGljaCB0aGVtZSBkb2VzIHRoZSBib3ggdXNlcz8KCQlwYWdlTG9hZEVycm9yTWVzc2FnZVRoZW1lOiAiYSIsCgoJCS8vIHJlcGxhY2UgY2FsbHMgdG8gd2luZG93Lmhpc3RvcnkuYmFjayB3aXRoIHBob25lZ2FwcyBuYXZpZ2F0aW9uIGhlbHBlcgoJCS8vIHdoZXJlIGl0IGlzIHByb3ZpZGVkIG9uIHRoZSB3aW5kb3cgb2JqZWN0CgkJcGhvbmVnYXBOYXZpZ2F0aW9uRW5hYmxlZDogZmFsc2UsCgoJCS8vYXV0b21hdGljYWxseSBpbml0aWFsaXplIHRoZSBET00gd2hlbiBpdCdzIHJlYWR5CgkJYXV0b0luaXRpYWxpemVQYWdlOiB0cnVlLAoKCQlwdXNoU3RhdGVFbmFibGVkOiB0cnVlLAoKCQkvLyBhbGxvd3MgdXNlcnMgdG8gb3B0IGluIHRvIGlnbm9yaW5nIGNvbnRlbnQgYnkgbWFya2luZyBhIHBhcmVudCBlbGVtZW50IGFzCgkJLy8gZGF0YS1pZ25vcmVkCgkJaWdub3JlQ29udGVudEVuYWJsZWQ6IGZhbHNlLAoKCQlidXR0b25NYXJrdXA6IHsKCQkJaG92ZXJEZWxheTogMjAwCgkJfSwKCgkJLy8gZGlzYWJsZSB0aGUgYWx0ZXJhdGlvbiBvZiB0aGUgZHluYW1pYyBiYXNlIHRhZyBvciBsaW5rcyBpbiB0aGUgY2FzZQoJCS8vIHRoYXQgYSBkeW5hbWljIGJhc2UgdGFnIGlzbid0IHN1cHBvcnRlZAoJCWR5bmFtaWNCYXNlRW5hYmxlZDogdHJ1ZSwKCgkJLy8gZGVmYXVsdCB0aGUgcHJvcGVydHkgdG8gcmVtb3ZlIGRlcGVuZGVuY3kgb24gYXNzaWdubWVudCBpbiBpbml0IG1vZHVsZQoJCXBhZ2VDb250YWluZXI6ICQoKQoJfSk7Cn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgl2YXIgbnNOb3JtYWxpemVEaWN0ID0ge30sCgkJb2xkRmluZCA9ICQuZmluZCwKCQlyYnJhY2UgPSAvKD86XHtbXHNcU10qXH18XFtbXHNcU10qXF0pJC8sCgkJanFtRGF0YVJFID0gLzpqcW1EYXRhXCgoW14pXSopXCkvZzsKCgkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCgkJLy8gTmFtZXNwYWNlIHVzZWQgZnJhbWV3b3JrLXdpZGUgZm9yIGRhdGEtYXR0cnMuIERlZmF1bHQgaXMgbm8gbmFtZXNwYWNlCgoJCW5zOiAiIiwKCgkJLy8gUmV0cmlldmUgYW4gYXR0cmlidXRlIGZyb20gYW4gZWxlbWVudCBhbmQgcGVyZm9ybSBzb21lIG1hc3NhZ2luZyBvZiB0aGUgdmFsdWUKCgkJZ2V0QXR0cmlidXRlOiBmdW5jdGlvbiggZWxlbWVudCwga2V5ICkgewoJCQl2YXIgZGF0YTsKCgkJCWVsZW1lbnQgPSBlbGVtZW50LmpxdWVyeSA/IGVsZW1lbnRbMF0gOiBlbGVtZW50OwoKCQkJaWYoIGVsZW1lbnQgJiYgZWxlbWVudC5nZXRBdHRyaWJ1dGUgKXsKCQkJCWRhdGEgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsga2V5ICk7CgkJCX0KCgkJCS8vIENvcGllZCBmcm9tIGNvcmUncyBzcmMvZGF0YS5qczpkYXRhQXR0cigpCgkJCS8vIENvbnZlcnQgZnJvbSBhIHN0cmluZyB0byBhIHByb3BlciBkYXRhIHR5cGUKCQkJdHJ5IHsKCQkJCWRhdGEgPSBkYXRhID09PSAidHJ1ZSIgPyB0cnVlIDoKCQkJCQlkYXRhID09PSAiZmFsc2UiID8gZmFsc2UgOgoJCQkJCWRhdGEgPT09ICJudWxsIiA/IG51bGwgOgoJCQkJCS8vIE9ubHkgY29udmVydCB0byBhIG51bWJlciBpZiBpdCBkb2Vzbid0IGNoYW5nZSB0aGUgc3RyaW5nCgkJCQkJK2RhdGEgKyAiIiA9PT0gZGF0YSA/ICtkYXRhIDoKCQkJCQlyYnJhY2UudGVzdCggZGF0YSApID8gSlNPTi5wYXJzZSggZGF0YSApIDoKCQkJCQlkYXRhOwoJCQl9IGNhdGNoKCBlcnIgKSB7fQoKCQkJcmV0dXJuIGRhdGE7CgkJfSwKCgkJLy8gRXhwb3NlIG91ciBjYWNoZSBmb3IgdGVzdGluZyBwdXJwb3Nlcy4KCQluc05vcm1hbGl6ZURpY3Q6IG5zTm9ybWFsaXplRGljdCwKCgkJLy8gVGFrZSBhIGRhdGEgYXR0cmlidXRlIHByb3BlcnR5LCBwcmVwZW5kIHRoZSBuYW1lc3BhY2UKCQkvLyBhbmQgdGhlbiBjYW1lbCBjYXNlIHRoZSBhdHRyaWJ1dGUgc3RyaW5nLiBBZGQgdGhlIHJlc3VsdAoJCS8vIHRvIG91ciBuc05vcm1hbGl6ZURpY3Qgc28gd2UgZG9uJ3QgaGF2ZSB0byBkbyB0aGlzIGFnYWluLgoJCW5zTm9ybWFsaXplOiBmdW5jdGlvbiggcHJvcCApIHsKCQkJcmV0dXJuIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdIHx8CgkJCQkoIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdID0gJC5jYW1lbENhc2UoICQubW9iaWxlLm5zICsgcHJvcCApICk7CgkJfSwKCgkJLy8gRmluZCB0aGUgY2xvc2VzdCBqYXZhc2NyaXB0IHBhZ2UgZWxlbWVudCB0byBnYXRoZXIgc2V0dGluZ3MgZGF0YSBqc3BlcmYgdGVzdAoJCS8vIGh0dHA6Ly9qc3BlcmYuY29tL3NpbmdsZS1jb21wbGV4LXNlbGVjdG9yLXZzLW1hbnktY29tcGxleC1zZWxlY3RvcnMvZWRpdAoJCS8vIHBvc3NpYmx5IG5haXZlLCBidXQgaXQgc2hvd3MgdGhhdCB0aGUgcGFyc2luZyBvdmVyaGVhZCBmb3IgKmp1c3QqIHRoZSBwYWdlIHNlbGVjdG9yIHZzCgkJLy8gdGhlIHBhZ2UgYW5kIGRpYWxvZyBzZWxlY3RvciBpcyBuZWdsaWdhYmxlLiBUaGlzIGNvdWxkIHByb2JhYmx5IGJlIHNwZWVkIHVwIGJ5CgkJLy8gZG9pbmcgYSBzaW1pbGFyIHBhcmVudCBub2RlIHRyYXZlcnNhbCB0byB0aGUgb25lIGZvdW5kIGluIHRoZSBpbmhlcml0ZWQgdGhlbWUgY29kZSBhYm92ZQoJCWNsb3Nlc3RQYWdlRGF0YTogZnVuY3Rpb24oICR0YXJnZXQgKSB7CgkJCXJldHVybiAkdGFyZ2V0CgkJCQkuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkKCQkJCS5kYXRhKCAibW9iaWxlLXBhZ2UiICk7CgkJfQoKCX0pOwoKCS8vIE1vYmlsZSB2ZXJzaW9uIG9mIGRhdGEgYW5kIHJlbW92ZURhdGEgYW5kIGhhc0RhdGEgbWV0aG9kcwoJLy8gZW5zdXJlcyBhbGwgZGF0YSBpcyBzZXQgYW5kIHJldHJpZXZlZCB1c2luZyBqUXVlcnkgTW9iaWxlJ3MgZGF0YSBuYW1lc3BhY2UKCSQuZm4uanFtRGF0YSA9IGZ1bmN0aW9uKCBwcm9wLCB2YWx1ZSApIHsKCQl2YXIgcmVzdWx0OwoJCWlmICggdHlwZW9mIHByb3AgIT09ICJ1bmRlZmluZWQiICkgewoJCQlpZiAoIHByb3AgKSB7CgkJCQlwcm9wID0gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKTsKCQkJfQoKCQkJLy8gdW5kZWZpbmVkIGlzIHBlcm1pdHRlZCBhcyBhbiBleHBsaWNpdCBpbnB1dCBmb3IgdGhlIHNlY29uZCBwYXJhbQoJCQkvLyBpbiB0aGlzIGNhc2UgaXQgcmV0dXJucyB0aGUgdmFsdWUgYW5kIGRvZXMgbm90IHNldCBpdCB0byB1bmRlZmluZWQKCQkJaWYgKCBhcmd1bWVudHMubGVuZ3RoIDwgMiB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkICl7CgkJCQlyZXN1bHQgPSB0aGlzLmRhdGEoIHByb3AgKTsKCQkJfSBlbHNlIHsKCQkJCXJlc3VsdCA9IHRoaXMuZGF0YSggcHJvcCwgdmFsdWUgKTsKCQkJfQoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmpxbURhdGEgPSBmdW5jdGlvbiggZWxlbSwgcHJvcCwgdmFsdWUgKSB7CgkJdmFyIHJlc3VsdDsKCQlpZiAoIHR5cGVvZiBwcm9wICE9PSAidW5kZWZpbmVkIiApIHsKCQkJcmVzdWx0ID0gJC5kYXRhKCBlbGVtLCBwcm9wID8gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSA6IHByb3AsIHZhbHVlICk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCSQuZm4uanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBwcm9wICkgewoJCXJldHVybiB0aGlzLnJlbW92ZURhdGEoICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5qcW1SZW1vdmVEYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AgKSB7CgkJcmV0dXJuICQucmVtb3ZlRGF0YSggZWxlbSwgJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSApOwoJfTsKCgkkLmZpbmQgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKSB7CgkJaWYgKCBzZWxlY3Rvci5pbmRleE9mKCAiOmpxbURhdGEiICkgPiAtMSApIHsKCQkJc2VsZWN0b3IgPSBzZWxlY3Rvci5yZXBsYWNlKCBqcW1EYXRhUkUsICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgIiQxXSIgKTsKCQl9CgoJCXJldHVybiBvbGRGaW5kLmNhbGwoIHRoaXMsIHNlbGVjdG9yLCBjb250ZXh0LCByZXQsIGV4dHJhICk7Cgl9OwoKCSQuZXh0ZW5kKCAkLmZpbmQsIG9sZEZpbmQgKTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qIQogKiBqUXVlcnkgVUkgQ29yZSBAVkVSU0lPTgogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2NhdGVnb3J5L3VpLWNvcmUvCiAqLwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciB1dWlkID0gMCwKCXJ1bmlxdWVJZCA9IC9edWktaWQtXGQrJC87CgovLyAkLnVpIG1pZ2h0IGV4aXN0IGZyb20gY29tcG9uZW50cyB3aXRoIG5vIGRlcGVuZGVuY2llcywgZS5nLiwgJC51aS5wb3NpdGlvbgokLnVpID0gJC51aSB8fCB7fTsKCiQuZXh0ZW5kKCAkLnVpLCB7Cgl2ZXJzaW9uOiAiQFZFUlNJT04iLAoKCWtleUNvZGU6IHsKCQlCQUNLU1BBQ0U6IDgsCgkJQ09NTUE6IDE4OCwKCQlERUxFVEU6IDQ2LAoJCURPV046IDQwLAoJCUVORDogMzUsCgkJRU5URVI6IDEzLAoJCUVTQ0FQRTogMjcsCgkJSE9NRTogMzYsCgkJTEVGVDogMzcsCgkJUEFHRV9ET1dOOiAzNCwKCQlQQUdFX1VQOiAzMywKCQlQRVJJT0Q6IDE5MCwKCQlSSUdIVDogMzksCgkJU1BBQ0U6IDMyLAoJCVRBQjogOSwKCQlVUDogMzgKCX0KfSk7CgovLyBwbHVnaW5zCiQuZm4uZXh0ZW5kKHsKCWZvY3VzOiAoZnVuY3Rpb24oIG9yaWcgKSB7CgkJcmV0dXJuIGZ1bmN0aW9uKCBkZWxheSwgZm4gKSB7CgkJCXJldHVybiB0eXBlb2YgZGVsYXkgPT09ICJudW1iZXIiID8KCQkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCQl2YXIgZWxlbSA9IHRoaXM7CgkJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkJJCggZWxlbSApLmZvY3VzKCk7CgkJCQkJCWlmICggZm4gKSB7CgkJCQkJCQlmbi5jYWxsKCBlbGVtICk7CgkJCQkJCX0KCQkJCQl9LCBkZWxheSApOwoJCQkJfSkgOgoJCQkJb3JpZy5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJfTsKCX0pKCAkLmZuLmZvY3VzICksCgoJc2Nyb2xsUGFyZW50OiBmdW5jdGlvbigpIHsKCQl2YXIgc2Nyb2xsUGFyZW50OwoJCWlmICgoJC51aS5pZSAmJiAoLyhzdGF0aWN8cmVsYXRpdmUpLykudGVzdCh0aGlzLmNzcygicG9zaXRpb24iKSkpIHx8ICgvYWJzb2x1dGUvKS50ZXN0KHRoaXMuY3NzKCJwb3NpdGlvbiIpKSkgewoJCQlzY3JvbGxQYXJlbnQgPSB0aGlzLnBhcmVudHMoKS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKC8ocmVsYXRpdmV8YWJzb2x1dGV8Zml4ZWQpLykudGVzdCgkLmNzcyh0aGlzLCJwb3NpdGlvbiIpKSAmJiAoLyhhdXRvfHNjcm9sbCkvKS50ZXN0KCQuY3NzKHRoaXMsIm92ZXJmbG93IikrJC5jc3ModGhpcywib3ZlcmZsb3cteSIpKyQuY3NzKHRoaXMsIm92ZXJmbG93LXgiKSk7CgkJCX0pLmVxKDApOwoJCX0gZWxzZSB7CgkJCXNjcm9sbFBhcmVudCA9IHRoaXMucGFyZW50cygpLmZpbHRlcihmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoLyhhdXRvfHNjcm9sbCkvKS50ZXN0KCQuY3NzKHRoaXMsIm92ZXJmbG93IikrJC5jc3ModGhpcywib3ZlcmZsb3cteSIpKyQuY3NzKHRoaXMsIm92ZXJmbG93LXgiKSk7CgkJCX0pLmVxKDApOwoJCX0KCgkJcmV0dXJuICggL2ZpeGVkLyApLnRlc3QoIHRoaXMuY3NzKCAicG9zaXRpb24iKSApIHx8ICFzY3JvbGxQYXJlbnQubGVuZ3RoID8gJCggdGhpc1sgMCBdLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQgKSA6IHNjcm9sbFBhcmVudDsKCX0sCgoJdW5pcXVlSWQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWlmICggIXRoaXMuaWQgKSB7CgkJCQl0aGlzLmlkID0gInVpLWlkLSIgKyAoKyt1dWlkKTsKCQkJfQoJCX0pOwoJfSwKCglyZW1vdmVVbmlxdWVJZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCBydW5pcXVlSWQudGVzdCggdGhpcy5pZCApICkgewoJCQkJJCggdGhpcyApLnJlbW92ZUF0dHIoICJpZCIgKTsKCQkJfQoJCX0pOwoJfQp9KTsKCi8vIHNlbGVjdG9ycwpmdW5jdGlvbiBmb2N1c2FibGUoIGVsZW1lbnQsIGlzVGFiSW5kZXhOb3ROYU4gKSB7Cgl2YXIgbWFwLCBtYXBOYW1lLCBpbWcsCgkJbm9kZU5hbWUgPSBlbGVtZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CglpZiAoICJhcmVhIiA9PT0gbm9kZU5hbWUgKSB7CgkJbWFwID0gZWxlbWVudC5wYXJlbnROb2RlOwoJCW1hcE5hbWUgPSBtYXAubmFtZTsKCQlpZiAoICFlbGVtZW50LmhyZWYgfHwgIW1hcE5hbWUgfHwgbWFwLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICJtYXAiICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCWltZyA9ICQoICJpbWdbdXNlbWFwPSMiICsgbWFwTmFtZSArICJdIiApWzBdOwoJCXJldHVybiAhIWltZyAmJiB2aXNpYmxlKCBpbWcgKTsKCX0KCXJldHVybiAoIC9pbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9ufG9iamVjdC8udGVzdCggbm9kZU5hbWUgKSA/CgkJIWVsZW1lbnQuZGlzYWJsZWQgOgoJCSJhIiA9PT0gbm9kZU5hbWUgPwoJCQllbGVtZW50LmhyZWYgfHwgaXNUYWJJbmRleE5vdE5hTiA6CgkJCWlzVGFiSW5kZXhOb3ROYU4pICYmCgkJLy8gdGhlIGVsZW1lbnQgYW5kIGFsbCBvZiBpdHMgYW5jZXN0b3JzIG11c3QgYmUgdmlzaWJsZQoJCXZpc2libGUoIGVsZW1lbnQgKTsKfQoKZnVuY3Rpb24gdmlzaWJsZSggZWxlbWVudCApIHsKCXJldHVybiAkLmV4cHIuZmlsdGVycy52aXNpYmxlKCBlbGVtZW50ICkgJiYKCQkhJCggZWxlbWVudCApLnBhcmVudHMoKS5hZGRCYWNrKCkuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5jc3MoIHRoaXMsICJ2aXNpYmlsaXR5IiApID09PSAiaGlkZGVuIjsKCQl9KS5sZW5ndGg7Cn0KCiQuZXh0ZW5kKCAkLmV4cHJbICI6IiBdLCB7CglkYXRhOiAkLmV4cHIuY3JlYXRlUHNldWRvID8KCQkkLmV4cHIuY3JlYXRlUHNldWRvKGZ1bmN0aW9uKCBkYXRhTmFtZSApIHsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJcmV0dXJuICEhJC5kYXRhKCBlbGVtLCBkYXRhTmFtZSApOwoJCQl9OwoJCX0pIDoKCQkvLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAoJCWZ1bmN0aW9uKCBlbGVtLCBpLCBtYXRjaCApIHsKCQkJcmV0dXJuICEhJC5kYXRhKCBlbGVtLCBtYXRjaFsgMyBdICk7CgkJfSwKCglmb2N1c2FibGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCXJldHVybiBmb2N1c2FibGUoIGVsZW1lbnQsICFpc05hTiggJC5hdHRyKCBlbGVtZW50LCAidGFiaW5kZXgiICkgKSApOwoJfSwKCgl0YWJiYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdmFyIHRhYkluZGV4ID0gJC5hdHRyKCBlbGVtZW50LCAidGFiaW5kZXgiICksCgkJCWlzVGFiSW5kZXhOYU4gPSBpc05hTiggdGFiSW5kZXggKTsKCQlyZXR1cm4gKCBpc1RhYkluZGV4TmFOIHx8IHRhYkluZGV4ID49IDAgKSAmJiBmb2N1c2FibGUoIGVsZW1lbnQsICFpc1RhYkluZGV4TmFOICk7Cgl9Cn0pOwoKLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKaWYgKCAhJCggIjxhPiIgKS5vdXRlcldpZHRoKCAxICkuanF1ZXJ5ICkgewoJJC5lYWNoKCBbICJXaWR0aCIsICJIZWlnaHQiIF0sIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoJCXZhciBzaWRlID0gbmFtZSA9PT0gIldpZHRoIiA/IFsgIkxlZnQiLCAiUmlnaHQiIF0gOiBbICJUb3AiLCAiQm90dG9tIiBdLAoJCQl0eXBlID0gbmFtZS50b0xvd2VyQ2FzZSgpLAoJCQlvcmlnID0gewoJCQkJaW5uZXJXaWR0aDogJC5mbi5pbm5lcldpZHRoLAoJCQkJaW5uZXJIZWlnaHQ6ICQuZm4uaW5uZXJIZWlnaHQsCgkJCQlvdXRlcldpZHRoOiAkLmZuLm91dGVyV2lkdGgsCgkJCQlvdXRlckhlaWdodDogJC5mbi5vdXRlckhlaWdodAoJCQl9OwoKCQlmdW5jdGlvbiByZWR1Y2UoIGVsZW0sIHNpemUsIGJvcmRlciwgbWFyZ2luICkgewoJCQkkLmVhY2goIHNpZGUsIGZ1bmN0aW9uKCkgewoJCQkJc2l6ZSAtPSBwYXJzZUZsb2F0KCAkLmNzcyggZWxlbSwgInBhZGRpbmciICsgdGhpcyApICkgfHwgMDsKCQkJCWlmICggYm9yZGVyICkgewoJCQkJCXNpemUgLT0gcGFyc2VGbG9hdCggJC5jc3MoIGVsZW0sICJib3JkZXIiICsgdGhpcyArICJXaWR0aCIgKSApIHx8IDA7CgkJCQl9CgkJCQlpZiAoIG1hcmdpbiApIHsKCQkJCQlzaXplIC09IHBhcnNlRmxvYXQoICQuY3NzKCBlbGVtLCAibWFyZ2luIiArIHRoaXMgKSApIHx8IDA7CgkJCQl9CgkJCX0pOwoJCQlyZXR1cm4gc2l6ZTsKCQl9CgoJCSQuZm5bICJpbm5lciIgKyBuYW1lIF0gPSBmdW5jdGlvbiggc2l6ZSApIHsKCQkJaWYgKCBzaXplID09PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gb3JpZ1sgImlubmVyIiArIG5hbWUgXS5jYWxsKCB0aGlzICk7CgkJCX0KCgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuY3NzKCB0eXBlLCByZWR1Y2UoIHRoaXMsIHNpemUgKSArICJweCIgKTsKCQkJfSk7CgkJfTsKCgkJJC5mblsgIm91dGVyIiArIG5hbWVdID0gZnVuY3Rpb24oIHNpemUsIG1hcmdpbiApIHsKCQkJaWYgKCB0eXBlb2Ygc2l6ZSAhPT0gIm51bWJlciIgKSB7CgkJCQlyZXR1cm4gb3JpZ1sgIm91dGVyIiArIG5hbWUgXS5jYWxsKCB0aGlzLCBzaXplICk7CgkJCX0KCgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzKS5jc3MoIHR5cGUsIHJlZHVjZSggdGhpcywgc2l6ZSwgdHJ1ZSwgbWFyZ2luICkgKyAicHgiICk7CgkJCX0pOwoJCX07Cgl9KTsKfQoKLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKaWYgKCAhJC5mbi5hZGRCYWNrICkgewoJJC5mbi5hZGRCYWNrID0gZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiB0aGlzLmFkZCggc2VsZWN0b3IgPT0gbnVsbCA/CgkJCXRoaXMucHJldk9iamVjdCA6IHRoaXMucHJldk9iamVjdC5maWx0ZXIoIHNlbGVjdG9yICkKCQkpOwoJfTsKfQoKLy8gc3VwcG9ydDogalF1ZXJ5IDEuNi4xLCAxLjYuMiAoaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvOTQxMykKaWYgKCAkKCAiPGE+IiApLmRhdGEoICJhLWIiLCAiYSIgKS5yZW1vdmVEYXRhKCAiYS1iIiApLmRhdGEoICJhLWIiICkgKSB7CgkkLmZuLnJlbW92ZURhdGEgPSAoZnVuY3Rpb24oIHJlbW92ZURhdGEgKSB7CgkJcmV0dXJuIGZ1bmN0aW9uKCBrZXkgKSB7CgkJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJCXJldHVybiByZW1vdmVEYXRhLmNhbGwoIHRoaXMsICQuY2FtZWxDYXNlKCBrZXkgKSApOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIHJlbW92ZURhdGEuY2FsbCggdGhpcyApOwoJCQl9CgkJfTsKCX0pKCAkLmZuLnJlbW92ZURhdGEgKTsKfQoKCgoKCi8vIGRlcHJlY2F0ZWQKJC51aS5pZSA9ICEhL21zaWUgW1x3Ll0rLy5leGVjKCBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkgKTsKCiQuc3VwcG9ydC5zZWxlY3RzdGFydCA9ICJvbnNlbGVjdHN0YXJ0IiBpbiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwokLmZuLmV4dGVuZCh7CglkaXNhYmxlU2VsZWN0aW9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5iaW5kKCAoICQuc3VwcG9ydC5zZWxlY3RzdGFydCA/ICJzZWxlY3RzdGFydCIgOiAibW91c2Vkb3duIiApICsKCQkJIi51aS1kaXNhYmxlU2VsZWN0aW9uIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfSk7Cgl9LAoKCWVuYWJsZVNlbGVjdGlvbjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMudW5iaW5kKCAiLnVpLWRpc2FibGVTZWxlY3Rpb24iICk7Cgl9LAoKCXpJbmRleDogZnVuY3Rpb24oIHpJbmRleCApIHsKCQlpZiAoIHpJbmRleCAhPT0gdW5kZWZpbmVkICkgewoJCQlyZXR1cm4gdGhpcy5jc3MoICJ6SW5kZXgiLCB6SW5kZXggKTsKCQl9CgoJCWlmICggdGhpcy5sZW5ndGggKSB7CgkJCXZhciBlbGVtID0gJCggdGhpc1sgMCBdICksIHBvc2l0aW9uLCB2YWx1ZTsKCQkJd2hpbGUgKCBlbGVtLmxlbmd0aCAmJiBlbGVtWyAwIF0gIT09IGRvY3VtZW50ICkgewoJCQkJLy8gSWdub3JlIHotaW5kZXggaWYgcG9zaXRpb24gaXMgc2V0IHRvIGEgdmFsdWUgd2hlcmUgei1pbmRleCBpcyBpZ25vcmVkIGJ5IHRoZSBicm93c2VyCgkJCQkvLyBUaGlzIG1ha2VzIGJlaGF2aW9yIG9mIHRoaXMgZnVuY3Rpb24gY29uc2lzdGVudCBhY3Jvc3MgYnJvd3NlcnMKCQkJCS8vIFdlYktpdCBhbHdheXMgcmV0dXJucyBhdXRvIGlmIHRoZSBlbGVtZW50IGlzIHBvc2l0aW9uZWQKCQkJCXBvc2l0aW9uID0gZWxlbS5jc3MoICJwb3NpdGlvbiIgKTsKCQkJCWlmICggcG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgfHwgcG9zaXRpb24gPT09ICJyZWxhdGl2ZSIgfHwgcG9zaXRpb24gPT09ICJmaXhlZCIgKSB7CgkJCQkJLy8gSUUgcmV0dXJucyAwIHdoZW4gekluZGV4IGlzIG5vdCBzcGVjaWZpZWQKCQkJCQkvLyBvdGhlciBicm93c2VycyByZXR1cm4gYSBzdHJpbmcKCQkJCQkvLyB3ZSBpZ25vcmUgdGhlIGNhc2Ugb2YgbmVzdGVkIGVsZW1lbnRzIHdpdGggYW4gZXhwbGljaXQgdmFsdWUgb2YgMAoJCQkJCS8vIDxkaXYgc3R5bGU9InotaW5kZXg6IC0xMDsiPjxkaXYgc3R5bGU9InotaW5kZXg6IDA7Ij48L2Rpdj48L2Rpdj4KCQkJCQl2YWx1ZSA9IHBhcnNlSW50KCBlbGVtLmNzcyggInpJbmRleCIgKSwgMTAgKTsKCQkJCQlpZiAoICFpc05hTiggdmFsdWUgKSAmJiB2YWx1ZSAhPT0gMCApIHsKCQkJCQkJcmV0dXJuIHZhbHVlOwoJCQkJCX0KCQkJCX0KCQkJCWVsZW0gPSBlbGVtLnBhcmVudCgpOwoJCQl9CgkJfQoKCQlyZXR1cm4gMDsKCX0KfSk7CgovLyAkLnVpLnBsdWdpbiBpcyBkZXByZWNhdGVkLiBVc2UgJC53aWRnZXQoKSBleHRlbnNpb25zIGluc3RlYWQuCiQudWkucGx1Z2luID0gewoJYWRkOiBmdW5jdGlvbiggbW9kdWxlLCBvcHRpb24sIHNldCApIHsKCQl2YXIgaSwKCQkJcHJvdG8gPSAkLnVpWyBtb2R1bGUgXS5wcm90b3R5cGU7CgkJZm9yICggaSBpbiBzZXQgKSB7CgkJCXByb3RvLnBsdWdpbnNbIGkgXSA9IHByb3RvLnBsdWdpbnNbIGkgXSB8fCBbXTsKCQkJcHJvdG8ucGx1Z2luc1sgaSBdLnB1c2goIFsgb3B0aW9uLCBzZXRbIGkgXSBdICk7CgkJfQoJfSwKCWNhbGw6IGZ1bmN0aW9uKCBpbnN0YW5jZSwgbmFtZSwgYXJncywgYWxsb3dEaXNjb25uZWN0ZWQgKSB7CgkJdmFyIGksCgkJCXNldCA9IGluc3RhbmNlLnBsdWdpbnNbIG5hbWUgXTsKCgkJaWYgKCAhc2V0ICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoICFhbGxvd0Rpc2Nvbm5lY3RlZCAmJiAoICFpbnN0YW5jZS5lbGVtZW50WyAwIF0ucGFyZW50Tm9kZSB8fCBpbnN0YW5jZS5lbGVtZW50WyAwIF0ucGFyZW50Tm9kZS5ub2RlVHlwZSA9PT0gMTEgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJZm9yICggaSA9IDA7IGkgPCBzZXQubGVuZ3RoOyBpKysgKSB7CgkJCWlmICggaW5zdGFuY2Uub3B0aW9uc1sgc2V0WyBpIF1bIDAgXSBdICkgewoJCQkJc2V0WyBpIF1bIDEgXS5hcHBseSggaW5zdGFuY2UuZWxlbWVudCwgYXJncyApOwoJCQl9CgkJfQoJfQp9OwoKfSkoIGpRdWVyeSApOwooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoJCS8vIGRlZmluZSB0aGUgd2luZG93IGFuZCB0aGUgZG9jdW1lbnQgb2JqZWN0cwoJCXdpbmRvdzogJCggd2luZG93ICksCgkJZG9jdW1lbnQ6ICQoIGRvY3VtZW50ICksCgoJCS8vIFRPRE86IFJlbW92ZSBhbmQgdXNlICQudWkua2V5Q29kZSBkaXJlY3RseQoJCWtleUNvZGU6ICQudWkua2V5Q29kZSwKCgkJLy8gUGxhY2UgdG8gc3RvcmUgdmFyaW91cyB3aWRnZXQgZXh0ZW5zaW9ucwoJCWJlaGF2aW9yczoge30sCgoJCS8vIFNjcm9sbCBwYWdlIHZlcnRpY2FsbHk6IHNjcm9sbCB0byAwIHRvIGhpZGUgaU9TIGFkZHJlc3MgYmFyLCBvciBwYXNzIGEgWSB2YWx1ZQoJCXNpbGVudFNjcm9sbDogZnVuY3Rpb24oIHlwb3MgKSB7CgkJCWlmICggJC50eXBlKCB5cG9zICkgIT09ICJudW1iZXIiICkgewoJCQkJeXBvcyA9ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsOwoJCQl9CgoJCQkvLyBwcmV2ZW50IHNjcm9sbHN0YXJ0IGFuZCBzY3JvbGxzdG9wIGV2ZW50cwoJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IGZhbHNlOwoKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCXdpbmRvdy5zY3JvbGxUbyggMCwgeXBvcyApOwoJCQkJJC5tb2JpbGUuZG9jdW1lbnQudHJpZ2dlciggInNpbGVudHNjcm9sbCIsIHsgeDogMCwgeTogeXBvcyB9KTsKCQkJfSwgMjAgKTsKCgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IHRydWU7CgkJCX0sIDE1MCApOwoJCX0sCgoJCS8vIERFUFJFQ0FURUQgaW4gMS40CgkJLy8gRmluZCB0aGUgY2xvc2VzdCBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzIG9uIGl0LiBOb3RlIHRoYXQKCQkvLyB3ZSBhcmUgbm90IHVzaW5nICQuZm4uY2xvc2VzdCgpIG9uIHB1cnBvc2UgaGVyZSBiZWNhdXNlIHRoaXMKCQkvLyBtZXRob2QgZ2V0cyBjYWxsZWQgcXVpdGUgYSBiaXQgYW5kIHdlIG5lZWQgaXQgdG8gYmUgYXMgZmFzdAoJCS8vIGFzIHBvc3NpYmxlLgoJCWdldEluaGVyaXRlZFRoZW1lOiBmdW5jdGlvbiggZWwsIGRlZmF1bHRUaGVtZSApIHsKCQkJdmFyIGUgPSBlbFsgMCBdLAoJCQkJbHRyID0gIiIsCgkJCQlyZSA9IC91aS0oYmFyfGJvZHl8b3ZlcmxheSktKFthLXpdKVxiLywKCQkJCWMsIG07CgkJCXdoaWxlICggZSApIHsKCQkJCWMgPSBlLmNsYXNzTmFtZSB8fCAiIjsKCQkJCWlmICggYyAmJiAoIG0gPSByZS5leGVjKCBjICkgKSAmJiAoIGx0ciA9IG1bIDIgXSApICkgewoJCQkJCS8vIFdlIGZvdW5kIGEgcGFyZW50IHdpdGggYSB0aGVtZSBjbGFzcwoJCQkJCS8vIG9uIGl0IHNvIGJhaWwgZnJvbSB0aGlzIGxvb3AuCgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJZSA9IGUucGFyZW50Tm9kZTsKCQkJfQoJCQkvLyBSZXR1cm4gdGhlIHRoZW1lIGxldHRlciB3ZSBmb3VuZCwgaWYgbm9uZSwgcmV0dXJuIHRoZQoJCQkvLyBzcGVjaWZpZWQgZGVmYXVsdC4KCQkJcmV0dXJuIGx0ciB8fCBkZWZhdWx0VGhlbWUgfHwgImEiOwoJCX0sCgoJCWVuaGFuY2VhYmxlOiBmdW5jdGlvbiggZWxlbWVudHMgKSB7CgkJCXJldHVybiB0aGlzLmhhdmVQYXJlbnRzKCBlbGVtZW50cywgImVuaGFuY2UiICk7CgkJfSwKCgkJaGlqYWNrYWJsZTogZnVuY3Rpb24oIGVsZW1lbnRzICkgewoJCQlyZXR1cm4gdGhpcy5oYXZlUGFyZW50cyggZWxlbWVudHMsICJhamF4IiApOwoJCX0sCgoJCWhhdmVQYXJlbnRzOiBmdW5jdGlvbiggZWxlbWVudHMsIGF0dHIgKSB7CgkJCWlmICggISQubW9iaWxlLmlnbm9yZUNvbnRlbnRFbmFibGVkICkgewoJCQkJcmV0dXJuIGVsZW1lbnRzOwoJCQl9CgoJCQl2YXIgY291bnQgPSBlbGVtZW50cy5sZW5ndGgsCgkJCQkkbmV3U2V0ID0gJCgpLAoJCQkJZSwgJGVsZW1lbnQsIGV4Y2x1ZGVkLAoJCQkJaSwgYzsKCgkJCWZvciAoIGkgPSAwOyBpIDwgY291bnQ7IGkrKyApIHsKCQkJCSRlbGVtZW50ID0gZWxlbWVudHMuZXEoIGkgKTsKCQkJCWV4Y2x1ZGVkID0gZmFsc2U7CgkJCQllID0gZWxlbWVudHNbIGkgXTsKCgkJCQl3aGlsZSAoIGUgKSB7CgkJCQkJYyA9IGUuZ2V0QXR0cmlidXRlID8gZS5nZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArIGF0dHIgKSA6ICIiOwoKCQkJCQlpZiAoIGMgPT09ICJmYWxzZSIgKSB7CgkJCQkJCWV4Y2x1ZGVkID0gdHJ1ZTsKCQkJCQkJYnJlYWs7CgkJCQkJfQoKCQkJCQllID0gZS5wYXJlbnROb2RlOwoJCQkJfQoKCQkJCWlmICggIWV4Y2x1ZGVkICkgewoJCQkJCSRuZXdTZXQgPSAkbmV3U2V0LmFkZCggJGVsZW1lbnQgKTsKCQkJCX0KCQkJfQoKCQkJcmV0dXJuICRuZXdTZXQ7CgkJfSwKCgkJZ2V0U2NyZWVuSGVpZ2h0OiBmdW5jdGlvbigpIHsKCQkJLy8gTmF0aXZlIGlubmVySGVpZ2h0IHJldHVybnMgbW9yZSBhY2N1cmF0ZSB2YWx1ZSBmb3IgdGhpcyBhY3Jvc3MgcGxhdGZvcm1zLAoJCQkvLyBqUXVlcnkgdmVyc2lvbiBpcyBoZXJlIGFzIGEgbm9ybWFsaXplZCBmYWxsYmFjayBmb3IgcGxhdGZvcm1zIGxpa2UgU3ltYmlhbgoJCQlyZXR1cm4gd2luZG93LmlubmVySGVpZ2h0IHx8ICQubW9iaWxlLndpbmRvdy5oZWlnaHQoKTsKCQl9LAoKCQkvL3NpbXBseSBzZXQgdGhlIGFjdGl2ZSBwYWdlJ3MgbWluaW11bSBoZWlnaHQgdG8gc2NyZWVuIGhlaWdodCwgZGVwZW5kaW5nIG9uIG9yaWVudGF0aW9uCgkJcmVzZXRBY3RpdmVQYWdlSGVpZ2h0OiBmdW5jdGlvbiggaGVpZ2h0ICkgewoJCQl2YXIgcGFnZSA9ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLAoJCQkJcGFnZUhlaWdodCA9IHBhZ2UuaGVpZ2h0KCksCgkJCQlwYWdlT3V0ZXJIZWlnaHQgPSBwYWdlLm91dGVySGVpZ2h0KCB0cnVlICk7CgoJCQloZWlnaHQgPSAoIHR5cGVvZiBoZWlnaHQgPT09ICJudW1iZXIiICkgPyBoZWlnaHQgOiAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKTsKCgkJCXBhZ2UuY3NzKCAibWluLWhlaWdodCIsIGhlaWdodCAtICggcGFnZU91dGVySGVpZ2h0IC0gcGFnZUhlaWdodCApICk7CgkJfQoJfSk7CgoJJC5hZGREZXBlbmRlbnRzID0gZnVuY3Rpb24oIGVsZW0sIG5ld0RlcGVuZGVudHMgKSB7CgkJdmFyICRlbGVtID0gJCggZWxlbSApLAoJCQlkZXBlbmRlbnRzID0gJGVsZW0uanFtRGF0YSggImRlcGVuZGVudHMiICkgfHwgJCgpOwoKCQkkZWxlbS5qcW1EYXRhKCAiZGVwZW5kZW50cyIsICQoIGRlcGVuZGVudHMgKS5hZGQoIG5ld0RlcGVuZGVudHMgKSApOwoJfTsKCgkvLyBwbHVnaW5zCgkkLmZuLmV4dGVuZCh7CgkJcmVtb3ZlV2l0aERlcGVuZGVudHM6IGZ1bmN0aW9uKCkgewoJCQkkLnJlbW92ZVdpdGhEZXBlbmRlbnRzKCB0aGlzICk7CgkJfSwKCgkJLy8gRW5oYW5jZSBjaGlsZCBlbGVtZW50cwoJCWVuaGFuY2VXaXRoaW46IGZ1bmN0aW9uKCkgewoJCQl2YXIgd2lkZ2V0RWxlbWVudHMsCgkJCQl0aGF0ID0gdGhpczsKCgkJCS8vIEFkZCBubyBqcyBjbGFzcyB0byBlbGVtZW50cwoJCQlpZiAoICQubW9iaWxlLm5vanMgKSB7CgkJCQkkLm1vYmlsZS5ub2pzKCB0aGlzICk7CgkJCX0KCgkJCS8vIEJpbmQgbGlua3MgZm9yIGFqYXggbmF2CgkJCWlmICggJC5tb2JpbGUubGlua3MgKSB7CgkJCQkkLm1vYmlsZS5saW5rcyggdGhpcyApOwoJCQl9CgoJCQkvLyBEZWdyYWRlIGlucHV0cyBmb3Igc3R5bGVpbmcKCQkJaWYgKCAkLm1vYmlsZS5kZWdyYWRlSW5wdXRzV2l0aGluICkgewoJCQkJJC5tb2JpbGUuZGVncmFkZUlucHV0c1dpdGhpbiggdGhpcyApOwoJCQl9CgoJCQkvLyBSdW4gYnV0dG9ubWFya3VwCgkJCWlmICggJC5mbi5idXR0b25NYXJrdXAgKSB7CgkJCQkkKCAkLmZuLmJ1dHRvbk1hcmt1cC5pbml0U2VsZWN0b3IgKS5idXR0b25NYXJrdXAoKTsKCQkJfQoKCQkJLy8gQWRkIGNsYXNzZXMgZm9yIGZpZWxkQ29udGFpbgoJCQlpZiAoICQuZm4uZmllbGRjb250YWluICkgewoJCQkJdGhpcy5maW5kKCAiOmpxbURhdGEocm9sZT0nZmllbGRjb250YWluJykiICkuanFtRW5oYW5jZWFibGUoKS5maWVsZGNvbnRhaW4oKTsKCQkJfQoKCQkJLy8gRW5oYW5jZSB3aWRnZXRzCgkJCSQuZWFjaCggJC5tb2JpbGUud2lkZ2V0cywgZnVuY3Rpb24oIG5hbWUsIGNvbnN0cnVjdG9yICkgewoKCQkJCS8vIElmIGluaXRTZWxlY3RvciBub3QgZmFsc2UgZmluZCBlbGVtZW50cwoJCQkJaWYgKCBjb25zdHJ1Y3Rvci5pbml0U2VsZWN0b3IgKSB7CgoJCQkJCS8vIEZpbHRlciBlbGVtZW50cyB0aGF0IHNob3VsZCBub3QgYmUgZW5oYW5jZWQgYmFzZWQgb24gcGFyZW50cwoJCQkJCXdpZGdldEVsZW1lbnRzID0gJC5tb2JpbGUuZW5oYW5jZWFibGUoIHRoYXQuZmluZCggY29uc3RydWN0b3IuaW5pdFNlbGVjdG9yICkgKTsKCgkJCQkJLy8gSWYgYW55IG1hdGNoaW5nIGVsZW1lbnRzIHJlbWFpbiBmaWx0ZXIgb25lcyB3aXRoIGtlZXBOYXRpdmVTZWxlY3RvcgoJCQkJCWlmICggd2lkZ2V0RWxlbWVudHMubGVuZ3RoICkgewoKCQkJCQkJLy8gJC5tb2JpbGUucGFnZS5wcm90b3R5cGUua2VlcE5hdGl2ZVNlbGVjdG9yIGlzIGRlcHJlY2F0ZWQgdGhpcyBpcyBqdXN0IGZvciBiYWNrY29tcHQKCQkJCQkJLy8gU3dpdGNoIHRvICQubW9iaWxlLmtlZXBOYXRpdmVTZWxlY3RvciBpbiAxLjUgd2hpY2ggaXMganVzdCBhIHZhbHVlIG5vdCBhIGZ1bmN0aW9uCgkJCQkJCXdpZGdldEVsZW1lbnRzID0gd2lkZ2V0RWxlbWVudHMubm90KCAkLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSApOwoJCQkJCX0KCgkJCQkJLy8gRW5oYW5jZSB3aGF0ZXZlciBpcyBsZWZ0CgkJCQkJd2lkZ2V0RWxlbWVudHNbIGNvbnN0cnVjdG9yLnByb3RvdHlwZS53aWRnZXROYW1lIF0oKTsKCQkJCX0KCQkJfSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlhZGREZXBlbmRlbnRzOiBmdW5jdGlvbiggbmV3RGVwZW5kZW50cyApIHsKCQkJJC5hZGREZXBlbmRlbnRzKCB0aGlzLCBuZXdEZXBlbmRlbnRzICk7CgkJfSwKCgkJLy8gbm90ZSB0aGF0IHRoaXMgaGVscGVyIGRvZXNuJ3QgYXR0ZW1wdCB0byBoYW5kbGUgdGhlIGNhbGxiYWNrCgkJLy8gb3Igc2V0dGluZyBvZiBhbiBodG1sIGVsZW1lbnQncyB0ZXh0LCBpdHMgb25seSBwdXJwb3NlIGlzCgkJLy8gdG8gcmV0dXJuIHRoZSBodG1sIGVuY29kZWQgdmVyc2lvbiBvZiB0aGUgdGV4dCBpbiBhbGwgY2FzZXMuICh0aHVzIHRoZSBuYW1lKQoJCWdldEVuY29kZWRUZXh0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQoICI8YT4iICkudGV4dCggdGhpcy50ZXh0KCkgKS5odG1sKCk7CgkJfSwKCgkJLy8gZmx1ZW50IGhlbHBlciBmdW5jdGlvbiBmb3IgdGhlIG1vYmlsZSBuYW1lc3BhY2VkIGVxdWl2YWxlbnQKCQlqcW1FbmhhbmNlYWJsZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5lbmhhbmNlYWJsZSggdGhpcyApOwoJCX0sCgoJCWpxbUhpamFja2FibGU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuaGlqYWNrYWJsZSggdGhpcyApOwoJCX0KCX0pOwoKCSQucmVtb3ZlV2l0aERlcGVuZGVudHMgPSBmdW5jdGlvbiggbmF0aXZlRWxlbWVudCApIHsKCQl2YXIgZWxlbWVudCA9ICQoIG5hdGl2ZUVsZW1lbnQgKTsKCgkJKCBlbGVtZW50LmpxbURhdGEoICJkZXBlbmRlbnRzIiApIHx8ICQoKSApLnJlbW92ZSgpOwoJCWVsZW1lbnQucmVtb3ZlKCk7Cgl9OwoJJC5hZGREZXBlbmRlbnRzID0gZnVuY3Rpb24oIG5hdGl2ZUVsZW1lbnQsIG5ld0RlcGVuZGVudHMgKSB7CgkJdmFyIGVsZW1lbnQgPSAkKCBuYXRpdmVFbGVtZW50ICksCgkJCWRlcGVuZGVudHMgPSBlbGVtZW50LmpxbURhdGEoICJkZXBlbmRlbnRzIiApIHx8ICQoKTsKCgkJZWxlbWVudC5qcW1EYXRhKCAiZGVwZW5kZW50cyIsICQoIGRlcGVuZGVudHMgKS5hZGQoIG5ld0RlcGVuZGVudHMgKSApOwoJfTsKCgkkLmZpbmQubWF0Y2hlcyA9IGZ1bmN0aW9uKCBleHByLCBzZXQgKSB7CgkJcmV0dXJuICQuZmluZCggZXhwciwgbnVsbCwgbnVsbCwgc2V0ICk7Cgl9OwoKCSQuZmluZC5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbiggbm9kZSwgZXhwciApIHsKCQlyZXR1cm4gJC5maW5kKCBleHByLCBudWxsLCBudWxsLCBbIG5vZGUgXSApLmxlbmd0aCA+IDA7Cgl9OwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKCi8qIQogKiBqUXVlcnkgVUkgV2lkZ2V0IEBWRVJTSU9OCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20valF1ZXJ5LndpZGdldC8KICovCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHV1aWQgPSAwLAoJc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsCglfY2xlYW5EYXRhID0gJC5jbGVhbkRhdGE7CiQuY2xlYW5EYXRhID0gZnVuY3Rpb24oIGVsZW1zICkgewoJZm9yICggdmFyIGkgPSAwLCBlbGVtOyAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJdHJ5IHsKCQkJJCggZWxlbSApLnRyaWdnZXJIYW5kbGVyKCAicmVtb3ZlIiApOwoJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzgyMzUKCQl9IGNhdGNoKCBlICkge30KCX0KCV9jbGVhbkRhdGEoIGVsZW1zICk7Cn07CgokLndpZGdldCA9IGZ1bmN0aW9uKCBuYW1lLCBiYXNlLCBwcm90b3R5cGUgKSB7Cgl2YXIgZnVsbE5hbWUsIGV4aXN0aW5nQ29uc3RydWN0b3IsIGNvbnN0cnVjdG9yLCBiYXNlUHJvdG90eXBlLAoJCS8vIHByb3hpZWRQcm90b3R5cGUgYWxsb3dzIHRoZSBwcm92aWRlZCBwcm90b3R5cGUgdG8gcmVtYWluIHVubW9kaWZpZWQKCQkvLyBzbyB0aGF0IGl0IGNhbiBiZSB1c2VkIGFzIGEgbWl4aW4gZm9yIG11bHRpcGxlIHdpZGdldHMgKCM4ODc2KQoJCXByb3hpZWRQcm90b3R5cGUgPSB7fSwKCQluYW1lc3BhY2UgPSBuYW1lLnNwbGl0KCAiLiIgKVsgMCBdOwoKCW5hbWUgPSBuYW1lLnNwbGl0KCAiLiIgKVsgMSBdOwoJZnVsbE5hbWUgPSBuYW1lc3BhY2UgKyAiLSIgKyBuYW1lOwoKCWlmICggIXByb3RvdHlwZSApIHsKCQlwcm90b3R5cGUgPSBiYXNlOwoJCWJhc2UgPSAkLldpZGdldDsKCX0KCgkvLyBjcmVhdGUgc2VsZWN0b3IgZm9yIHBsdWdpbgoJJC5leHByWyAiOiIgXVsgZnVsbE5hbWUudG9Mb3dlckNhc2UoKSBdID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuICEhJC5kYXRhKCBlbGVtLCBmdWxsTmFtZSApOwoJfTsKCgkkWyBuYW1lc3BhY2UgXSA9ICRbIG5hbWVzcGFjZSBdIHx8IHt9OwoJZXhpc3RpbmdDb25zdHJ1Y3RvciA9ICRbIG5hbWVzcGFjZSBdWyBuYW1lIF07Cgljb25zdHJ1Y3RvciA9ICRbIG5hbWVzcGFjZSBdWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQkvLyBhbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgIm5ldyIga2V5d29yZAoJCWlmICggIXRoaXMuX2NyZWF0ZVdpZGdldCApIHsKCQkJcmV0dXJuIG5ldyBjb25zdHJ1Y3Rvciggb3B0aW9ucywgZWxlbWVudCApOwoJCX0KCgkJLy8gYWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0IGluaXRpYWxpemluZyBmb3Igc2ltcGxlIGluaGVyaXRhbmNlCgkJLy8gbXVzdCB1c2UgIm5ldyIga2V5d29yZCAodGhlIGNvZGUgYWJvdmUgYWx3YXlzIHBhc3NlcyBhcmdzKQoJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJdGhpcy5fY3JlYXRlV2lkZ2V0KCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoJfTsKCS8vIGV4dGVuZCB3aXRoIHRoZSBleGlzdGluZyBjb25zdHJ1Y3RvciB0byBjYXJyeSBvdmVyIGFueSBzdGF0aWMgcHJvcGVydGllcwoJJC5leHRlbmQoIGNvbnN0cnVjdG9yLCBleGlzdGluZ0NvbnN0cnVjdG9yLCB7CgkJdmVyc2lvbjogcHJvdG90eXBlLnZlcnNpb24sCgkJLy8gY29weSB0aGUgb2JqZWN0IHVzZWQgdG8gY3JlYXRlIHRoZSBwcm90b3R5cGUgaW4gY2FzZSB3ZSBuZWVkIHRvCgkJLy8gcmVkZWZpbmUgdGhlIHdpZGdldCBsYXRlcgoJCV9wcm90bzogJC5leHRlbmQoIHt9LCBwcm90b3R5cGUgKSwKCQkvLyB0cmFjayB3aWRnZXRzIHRoYXQgaW5oZXJpdCBmcm9tIHRoaXMgd2lkZ2V0IGluIGNhc2UgdGhpcyB3aWRnZXQgaXMKCQkvLyByZWRlZmluZWQgYWZ0ZXIgYSB3aWRnZXQgaW5oZXJpdHMgZnJvbSBpdAoJCV9jaGlsZENvbnN0cnVjdG9yczogW10KCX0pOwoKCWJhc2VQcm90b3R5cGUgPSBuZXcgYmFzZSgpOwoJLy8gd2UgbmVlZCB0byBtYWtlIHRoZSBvcHRpb25zIGhhc2ggYSBwcm9wZXJ0eSBkaXJlY3RseSBvbiB0aGUgbmV3IGluc3RhbmNlCgkvLyBvdGhlcndpc2Ugd2UnbGwgbW9kaWZ5IHRoZSBvcHRpb25zIGhhc2ggb24gdGhlIHByb3RvdHlwZSB0aGF0IHdlJ3JlCgkvLyBpbmhlcml0aW5nIGZyb20KCWJhc2VQcm90b3R5cGUub3B0aW9ucyA9ICQud2lkZ2V0LmV4dGVuZCgge30sIGJhc2VQcm90b3R5cGUub3B0aW9ucyApOwoJJC5lYWNoKCBwcm90b3R5cGUsIGZ1bmN0aW9uKCBwcm9wLCB2YWx1ZSApIHsKCQlpZiAoICEkLmlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CgkJCXByb3hpZWRQcm90b3R5cGVbIHByb3AgXSA9IHZhbHVlOwoJCQlyZXR1cm47CgkJfQoJCXByb3hpZWRQcm90b3R5cGVbIHByb3AgXSA9IChmdW5jdGlvbigpIHsKCQkJdmFyIF9zdXBlciA9IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiBiYXNlLnByb3RvdHlwZVsgcHJvcCBdLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCX0sCgkJCQlfc3VwZXJBcHBseSA9IGZ1bmN0aW9uKCBhcmdzICkgewoJCQkJCXJldHVybiBiYXNlLnByb3RvdHlwZVsgcHJvcCBdLmFwcGx5KCB0aGlzLCBhcmdzICk7CgkJCQl9OwoJCQlyZXR1cm4gZnVuY3Rpb24oKSB7CgkJCQl2YXIgX19zdXBlciA9IHRoaXMuX3N1cGVyLAoJCQkJCV9fc3VwZXJBcHBseSA9IHRoaXMuX3N1cGVyQXBwbHksCgkJCQkJcmV0dXJuVmFsdWU7CgoJCQkJdGhpcy5fc3VwZXIgPSBfc3VwZXI7CgkJCQl0aGlzLl9zdXBlckFwcGx5ID0gX3N1cGVyQXBwbHk7CgoJCQkJcmV0dXJuVmFsdWUgPSB2YWx1ZS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgoJCQkJdGhpcy5fc3VwZXIgPSBfX3N1cGVyOwoJCQkJdGhpcy5fc3VwZXJBcHBseSA9IF9fc3VwZXJBcHBseTsKCgkJCQlyZXR1cm4gcmV0dXJuVmFsdWU7CgkJCX07CgkJfSkoKTsKCX0pOwoJY29uc3RydWN0b3IucHJvdG90eXBlID0gJC53aWRnZXQuZXh0ZW5kKCBiYXNlUHJvdG90eXBlLCB7CgkJLy8gVE9ETzogcmVtb3ZlIHN1cHBvcnQgZm9yIHdpZGdldEV2ZW50UHJlZml4CgkJLy8gYWx3YXlzIHVzZSB0aGUgbmFtZSArIGEgY29sb24gYXMgdGhlIHByZWZpeCwgZS5nLiwgZHJhZ2dhYmxlOnN0YXJ0CgkJLy8gZG9uJ3QgcHJlZml4IGZvciB3aWRnZXRzIHRoYXQgYXJlbid0IERPTS1iYXNlZAoJCXdpZGdldEV2ZW50UHJlZml4OiBleGlzdGluZ0NvbnN0cnVjdG9yID8gKGJhc2VQcm90b3R5cGUud2lkZ2V0RXZlbnRQcmVmaXggfHwgbmFtZSkgOiBuYW1lCgl9LCBwcm94aWVkUHJvdG90eXBlLCB7CgkJY29uc3RydWN0b3I6IGNvbnN0cnVjdG9yLAoJCW5hbWVzcGFjZTogbmFtZXNwYWNlLAoJCXdpZGdldE5hbWU6IG5hbWUsCgkJd2lkZ2V0RnVsbE5hbWU6IGZ1bGxOYW1lCgl9KTsKCgkvLyBJZiB0aGlzIHdpZGdldCBpcyBiZWluZyByZWRlZmluZWQgdGhlbiB3ZSBuZWVkIHRvIGZpbmQgYWxsIHdpZGdldHMgdGhhdAoJLy8gYXJlIGluaGVyaXRpbmcgZnJvbSBpdCBhbmQgcmVkZWZpbmUgYWxsIG9mIHRoZW0gc28gdGhhdCB0aGV5IGluaGVyaXQgZnJvbQoJLy8gdGhlIG5ldyB2ZXJzaW9uIG9mIHRoaXMgd2lkZ2V0LiBXZSdyZSBlc3NlbnRpYWxseSB0cnlpbmcgdG8gcmVwbGFjZSBvbmUKCS8vIGxldmVsIGluIHRoZSBwcm90b3R5cGUgY2hhaW4uCglpZiAoIGV4aXN0aW5nQ29uc3RydWN0b3IgKSB7CgkJJC5lYWNoKCBleGlzdGluZ0NvbnN0cnVjdG9yLl9jaGlsZENvbnN0cnVjdG9ycywgZnVuY3Rpb24oIGksIGNoaWxkICkgewoJCQl2YXIgY2hpbGRQcm90b3R5cGUgPSBjaGlsZC5wcm90b3R5cGU7CgoJCQkvLyByZWRlZmluZSB0aGUgY2hpbGQgd2lkZ2V0IHVzaW5nIHRoZSBzYW1lIHByb3RvdHlwZSB0aGF0IHdhcwoJCQkvLyBvcmlnaW5hbGx5IHVzZWQsIGJ1dCBpbmhlcml0IGZyb20gdGhlIG5ldyB2ZXJzaW9uIG9mIHRoZSBiYXNlCgkJCSQud2lkZ2V0KCBjaGlsZFByb3RvdHlwZS5uYW1lc3BhY2UgKyAiLiIgKyBjaGlsZFByb3RvdHlwZS53aWRnZXROYW1lLCBjb25zdHJ1Y3RvciwgY2hpbGQuX3Byb3RvICk7CgkJfSk7CgkJLy8gcmVtb3ZlIHRoZSBsaXN0IG9mIGV4aXN0aW5nIGNoaWxkIGNvbnN0cnVjdG9ycyBmcm9tIHRoZSBvbGQgY29uc3RydWN0b3IKCQkvLyBzbyB0aGUgb2xkIGNoaWxkIGNvbnN0cnVjdG9ycyBjYW4gYmUgZ2FyYmFnZSBjb2xsZWN0ZWQKCQlkZWxldGUgZXhpc3RpbmdDb25zdHJ1Y3Rvci5fY2hpbGRDb25zdHJ1Y3RvcnM7Cgl9IGVsc2UgewoJCWJhc2UuX2NoaWxkQ29uc3RydWN0b3JzLnB1c2goIGNvbnN0cnVjdG9yICk7Cgl9CgoJJC53aWRnZXQuYnJpZGdlKCBuYW1lLCBjb25zdHJ1Y3RvciApOwoKCXJldHVybiBjb25zdHJ1Y3RvcjsKfTsKCiQud2lkZ2V0LmV4dGVuZCA9IGZ1bmN0aW9uKCB0YXJnZXQgKSB7Cgl2YXIgaW5wdXQgPSBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSwKCQlpbnB1dEluZGV4ID0gMCwKCQlpbnB1dExlbmd0aCA9IGlucHV0Lmxlbmd0aCwKCQlrZXksCgkJdmFsdWU7Cglmb3IgKCA7IGlucHV0SW5kZXggPCBpbnB1dExlbmd0aDsgaW5wdXRJbmRleCsrICkgewoJCWZvciAoIGtleSBpbiBpbnB1dFsgaW5wdXRJbmRleCBdICkgewoJCQl2YWx1ZSA9IGlucHV0WyBpbnB1dEluZGV4IF1bIGtleSBdOwoJCQlpZiAoIGlucHV0WyBpbnB1dEluZGV4IF0uaGFzT3duUHJvcGVydHkoIGtleSApICYmIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQkvLyBDbG9uZSBvYmplY3RzCgkJCQlpZiAoICQuaXNQbGFpbk9iamVjdCggdmFsdWUgKSApIHsKCQkJCQl0YXJnZXRbIGtleSBdID0gJC5pc1BsYWluT2JqZWN0KCB0YXJnZXRbIGtleSBdICkgPwoJCQkJCQkkLndpZGdldC5leHRlbmQoIHt9LCB0YXJnZXRbIGtleSBdLCB2YWx1ZSApIDoKCQkJCQkJLy8gRG9uJ3QgZXh0ZW5kIHN0cmluZ3MsIGFycmF5cywgZXRjLiB3aXRoIG9iamVjdHMKCQkJCQkJJC53aWRnZXQuZXh0ZW5kKCB7fSwgdmFsdWUgKTsKCQkJCS8vIENvcHkgZXZlcnl0aGluZyBlbHNlIGJ5IHJlZmVyZW5jZQoJCQkJfSBlbHNlIHsKCQkJCQl0YXJnZXRbIGtleSBdID0gdmFsdWU7CgkJCQl9CgkJCX0KCQl9Cgl9CglyZXR1cm4gdGFyZ2V0Owp9OwoKJC53aWRnZXQuYnJpZGdlID0gZnVuY3Rpb24oIG5hbWUsIG9iamVjdCApIHsKCXZhciBmdWxsTmFtZSA9IG9iamVjdC5wcm90b3R5cGUud2lkZ2V0RnVsbE5hbWUgfHwgbmFtZTsKCSQuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBpc01ldGhvZENhbGwgPSB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyIsCgkJCWFyZ3MgPSBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSwKCQkJcmV0dXJuVmFsdWUgPSB0aGlzOwoKCQkvLyBhbGxvdyBtdWx0aXBsZSBoYXNoZXMgdG8gYmUgcGFzc2VkIG9uIGluaXQKCQlvcHRpb25zID0gIWlzTWV0aG9kQ2FsbCAmJiBhcmdzLmxlbmd0aCA/CgkJCSQud2lkZ2V0LmV4dGVuZC5hcHBseSggbnVsbCwgWyBvcHRpb25zIF0uY29uY2F0KGFyZ3MpICkgOgoJCQlvcHRpb25zOwoKCQlpZiAoIGlzTWV0aG9kQ2FsbCApIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIG1ldGhvZFZhbHVlLAoJCQkJCWluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSApOwoJCQkJaWYgKCBvcHRpb25zID09PSAiaW5zdGFuY2UiICkgewoJCQkJCXJldHVyblZhbHVlID0gaW5zdGFuY2U7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQkJaWYgKCAhaW5zdGFuY2UgKSB7CgkJCQkJcmV0dXJuICQuZXJyb3IoICJjYW5ub3QgY2FsbCBtZXRob2RzIG9uICIgKyBuYW1lICsgIiBwcmlvciB0byBpbml0aWFsaXphdGlvbjsgIiArCgkJCQkJCSJhdHRlbXB0ZWQgdG8gY2FsbCBtZXRob2QgJyIgKyBvcHRpb25zICsgIiciICk7CgkJCQl9CgkJCQlpZiAoICEkLmlzRnVuY3Rpb24oIGluc3RhbmNlW29wdGlvbnNdICkgfHwgb3B0aW9ucy5jaGFyQXQoIDAgKSA9PT0gIl8iICkgewoJCQkJCXJldHVybiAkLmVycm9yKCAibm8gc3VjaCBtZXRob2QgJyIgKyBvcHRpb25zICsgIicgZm9yICIgKyBuYW1lICsgIiB3aWRnZXQgaW5zdGFuY2UiICk7CgkJCQl9CgkJCQltZXRob2RWYWx1ZSA9IGluc3RhbmNlWyBvcHRpb25zIF0uYXBwbHkoIGluc3RhbmNlLCBhcmdzICk7CgkJCQlpZiAoIG1ldGhvZFZhbHVlICE9PSBpbnN0YW5jZSAmJiBtZXRob2RWYWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVyblZhbHVlID0gbWV0aG9kVmFsdWUgJiYgbWV0aG9kVmFsdWUuanF1ZXJ5ID8KCQkJCQkJcmV0dXJuVmFsdWUucHVzaFN0YWNrKCBtZXRob2RWYWx1ZS5nZXQoKSApIDoKCQkJCQkJbWV0aG9kVmFsdWU7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9KTsKCQl9IGVsc2UgewoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgaW5zdGFuY2UgPSAkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lICk7CgkJCQlpZiAoIGluc3RhbmNlICkgewoJCQkJCWluc3RhbmNlLm9wdGlvbiggb3B0aW9ucyB8fCB7fSApLl9pbml0KCk7CgkJCQl9IGVsc2UgewoJCQkJCSQuZGF0YSggdGhpcywgZnVsbE5hbWUsIG5ldyBvYmplY3QoIG9wdGlvbnMsIHRoaXMgKSApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXJldHVybiByZXR1cm5WYWx1ZTsKCX07Cn07CgokLldpZGdldCA9IGZ1bmN0aW9uKCAvKiBvcHRpb25zLCBlbGVtZW50ICovICkge307CiQuV2lkZ2V0Ll9jaGlsZENvbnN0cnVjdG9ycyA9IFtdOwoKJC5XaWRnZXQucHJvdG90eXBlID0gewoJd2lkZ2V0TmFtZTogIndpZGdldCIsCgl3aWRnZXRFdmVudFByZWZpeDogIiIsCglkZWZhdWx0RWxlbWVudDogIjxkaXY+IiwKCW9wdGlvbnM6IHsKCQlkaXNhYmxlZDogZmFsc2UsCgoJCS8vIGNhbGxiYWNrcwoJCWNyZWF0ZTogbnVsbAoJfSwKCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCWVsZW1lbnQgPSAkKCBlbGVtZW50IHx8IHRoaXMuZGVmYXVsdEVsZW1lbnQgfHwgdGhpcyApWyAwIF07CgkJdGhpcy5lbGVtZW50ID0gJCggZWxlbWVudCApOwoJCXRoaXMudXVpZCA9IHV1aWQrKzsKCQl0aGlzLmV2ZW50TmFtZXNwYWNlID0gIi4iICsgdGhpcy53aWRnZXROYW1lICsgdGhpcy51dWlkOwoJCXRoaXMub3B0aW9ucyA9ICQud2lkZ2V0LmV4dGVuZCgge30sCgkJCXRoaXMub3B0aW9ucywKCQkJdGhpcy5fZ2V0Q3JlYXRlT3B0aW9ucygpLAoJCQlvcHRpb25zICk7CgoJCXRoaXMuYmluZGluZ3MgPSAkKCk7CgkJdGhpcy5ob3ZlcmFibGUgPSAkKCk7CgkJdGhpcy5mb2N1c2FibGUgPSAkKCk7CgoJCWlmICggZWxlbWVudCAhPT0gdGhpcyApIHsKCQkJJC5kYXRhKCBlbGVtZW50LCB0aGlzLndpZGdldEZ1bGxOYW1lLCB0aGlzICk7CgkJCXRoaXMuX29uKCB0cnVlLCB0aGlzLmVsZW1lbnQsIHsKCQkJCXJlbW92ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCWlmICggZXZlbnQudGFyZ2V0ID09PSBlbGVtZW50ICkgewoJCQkJCQl0aGlzLmRlc3Ryb3koKTsKCQkJCQl9CgkJCQl9CgkJCX0pOwoJCQl0aGlzLmRvY3VtZW50ID0gJCggZWxlbWVudC5zdHlsZSA/CgkJCQkvLyBlbGVtZW50IHdpdGhpbiB0aGUgZG9jdW1lbnQKCQkJCWVsZW1lbnQub3duZXJEb2N1bWVudCA6CgkJCQkvLyBlbGVtZW50IGlzIHdpbmRvdyBvciBkb2N1bWVudAoJCQkJZWxlbWVudC5kb2N1bWVudCB8fCBlbGVtZW50ICk7CgkJCXRoaXMud2luZG93ID0gJCggdGhpcy5kb2N1bWVudFswXS5kZWZhdWx0VmlldyB8fCB0aGlzLmRvY3VtZW50WzBdLnBhcmVudFdpbmRvdyApOwoJCX0KCgkJdGhpcy5fY3JlYXRlKCk7CgkJdGhpcy5fdHJpZ2dlciggImNyZWF0ZSIsIG51bGwsIHRoaXMuX2dldENyZWF0ZUV2ZW50RGF0YSgpICk7CgkJdGhpcy5faW5pdCgpOwoJfSwKCV9nZXRDcmVhdGVPcHRpb25zOiAkLm5vb3AsCglfZ2V0Q3JlYXRlRXZlbnREYXRhOiAkLm5vb3AsCglfY3JlYXRlOiAkLm5vb3AsCglfaW5pdDogJC5ub29wLAoKCWRlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2Rlc3Ryb3koKTsKCQkvLyB3ZSBjYW4gcHJvYmFibHkgcmVtb3ZlIHRoZSB1bmJpbmQgY2FsbHMgaW4gMi4wCgkJLy8gYWxsIGV2ZW50IGJpbmRpbmdzIHNob3VsZCBnbyB0aHJvdWdoIHRoaXMuX29uKCkKCQl0aGlzLmVsZW1lbnQKCQkJLnVuYmluZCggdGhpcy5ldmVudE5hbWVzcGFjZSApCgkJCS5yZW1vdmVEYXRhKCB0aGlzLndpZGdldEZ1bGxOYW1lICkKCQkJLy8gc3VwcG9ydDoganF1ZXJ5IDwxLjYuMwoJCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC85NDEzCgkJCS5yZW1vdmVEYXRhKCAkLmNhbWVsQ2FzZSggdGhpcy53aWRnZXRGdWxsTmFtZSApICk7CgkJdGhpcy53aWRnZXQoKQoJCQkudW5iaW5kKCB0aGlzLmV2ZW50TmFtZXNwYWNlICkKCQkJLnJlbW92ZUF0dHIoICJhcmlhLWRpc2FibGVkIiApCgkJCS5yZW1vdmVDbGFzcygKCQkJCXRoaXMud2lkZ2V0RnVsbE5hbWUgKyAiLWRpc2FibGVkICIgKwoJCQkJInVpLXN0YXRlLWRpc2FibGVkIiApOwoKCQkvLyBjbGVhbiB1cCBldmVudHMgYW5kIHN0YXRlcwoJCXRoaXMuYmluZGluZ3MudW5iaW5kKCB0aGlzLmV2ZW50TmFtZXNwYWNlICk7CgkJdGhpcy5ob3ZlcmFibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQl0aGlzLmZvY3VzYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJfSwKCV9kZXN0cm95OiAkLm5vb3AsCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lbGVtZW50OwoJfSwKCglvcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXZhciBvcHRpb25zID0ga2V5LAoJCQlwYXJ0cywKCQkJY3VyT3B0aW9uLAoJCQlpOwoKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPT09IDAgKSB7CgkJCS8vIGRvbid0IHJldHVybiBhIHJlZmVyZW5jZSB0byB0aGUgaW50ZXJuYWwgaGFzaAoJCQlyZXR1cm4gJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zICk7CgkJfQoKCQlpZiAoIHR5cGVvZiBrZXkgPT09ICJzdHJpbmciICkgewoJCQkvLyBoYW5kbGUgbmVzdGVkIGtleXMsIGUuZy4sICJmb28uYmFyIiA9PiB7IGZvbzogeyBiYXI6IF9fXyB9IH0KCQkJb3B0aW9ucyA9IHt9OwoJCQlwYXJ0cyA9IGtleS5zcGxpdCggIi4iICk7CgkJCWtleSA9IHBhcnRzLnNoaWZ0KCk7CgkJCWlmICggcGFydHMubGVuZ3RoICkgewoJCQkJY3VyT3B0aW9uID0gb3B0aW9uc1sga2V5IF0gPSAkLndpZGdldC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnNbIGtleSBdICk7CgkJCQlmb3IgKCBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aCAtIDE7IGkrKyApIHsKCQkJCQljdXJPcHRpb25bIHBhcnRzWyBpIF0gXSA9IGN1ck9wdGlvblsgcGFydHNbIGkgXSBdIHx8IHt9OwoJCQkJCWN1ck9wdGlvbiA9IGN1ck9wdGlvblsgcGFydHNbIGkgXSBdOwoJCQkJfQoJCQkJa2V5ID0gcGFydHMucG9wKCk7CgkJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIGN1ck9wdGlvblsga2V5IF0gPT09IHVuZGVmaW5lZCA/IG51bGwgOiBjdXJPcHRpb25bIGtleSBdOwoJCQkJfQoJCQkJY3VyT3B0aW9uWyBrZXkgXSA9IHZhbHVlOwoJCQl9IGVsc2UgewoJCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVybiB0aGlzLm9wdGlvbnNbIGtleSBdID09PSB1bmRlZmluZWQgPyBudWxsIDogdGhpcy5vcHRpb25zWyBrZXkgXTsKCQkJCX0KCQkJCW9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgkJCX0KCQl9CgoJCXRoaXMuX3NldE9wdGlvbnMoIG9wdGlvbnMgKTsKCgkJcmV0dXJuIHRoaXM7Cgl9LAoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBrZXk7CgoJCWZvciAoIGtleSBpbiBvcHRpb25zICkgewoJCQl0aGlzLl9zZXRPcHRpb24oIGtleSwgb3B0aW9uc1sga2V5IF0gKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXRoaXMub3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7CgkJCXRoaXMud2lkZ2V0KCkKCQkJCS50b2dnbGVDbGFzcyggdGhpcy53aWRnZXRGdWxsTmFtZSArICItZGlzYWJsZWQiLCAhIXZhbHVlICk7CgkJCXRoaXMuaG92ZXJhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJCXRoaXMuZm9jdXNhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9ucyh7IGRpc2FibGVkOiBmYWxzZSB9KTsKCX0sCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9ucyh7IGRpc2FibGVkOiB0cnVlIH0pOwoJfSwKCglfb246IGZ1bmN0aW9uKCBzdXBwcmVzc0Rpc2FibGVkQ2hlY2ssIGVsZW1lbnQsIGhhbmRsZXJzICkgewoJCXZhciBkZWxlZ2F0ZUVsZW1lbnQsCgkJCWluc3RhbmNlID0gdGhpczsKCgkJLy8gbm8gc3VwcHJlc3NEaXNhYmxlZENoZWNrIGZsYWcsIHNodWZmbGUgYXJndW1lbnRzCgkJaWYgKCB0eXBlb2Ygc3VwcHJlc3NEaXNhYmxlZENoZWNrICE9PSAiYm9vbGVhbiIgKSB7CgkJCWhhbmRsZXJzID0gZWxlbWVudDsKCQkJZWxlbWVudCA9IHN1cHByZXNzRGlzYWJsZWRDaGVjazsKCQkJc3VwcHJlc3NEaXNhYmxlZENoZWNrID0gZmFsc2U7CgkJfQoKCQkvLyBubyBlbGVtZW50IGFyZ3VtZW50LCBzaHVmZmxlIGFuZCB1c2UgdGhpcy5lbGVtZW50CgkJaWYgKCAhaGFuZGxlcnMgKSB7CgkJCWhhbmRsZXJzID0gZWxlbWVudDsKCQkJZWxlbWVudCA9IHRoaXMuZWxlbWVudDsKCQkJZGVsZWdhdGVFbGVtZW50ID0gdGhpcy53aWRnZXQoKTsKCQl9IGVsc2UgewoJCQkvLyBhY2NlcHQgc2VsZWN0b3JzLCBET00gZWxlbWVudHMKCQkJZWxlbWVudCA9IGRlbGVnYXRlRWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQkJdGhpcy5iaW5kaW5ncyA9IHRoaXMuYmluZGluZ3MuYWRkKCBlbGVtZW50ICk7CgkJfQoKCQkkLmVhY2goIGhhbmRsZXJzLCBmdW5jdGlvbiggZXZlbnQsIGhhbmRsZXIgKSB7CgkJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsKCQkJCS8vIGFsbG93IHdpZGdldHMgdG8gY3VzdG9taXplIHRoZSBkaXNhYmxlZCBoYW5kbGluZwoJCQkJLy8gLSBkaXNhYmxlZCBhcyBhbiBhcnJheSBpbnN0ZWFkIG9mIGJvb2xlYW4KCQkJCS8vIC0gZGlzYWJsZWQgY2xhc3MgYXMgbWV0aG9kIGZvciBkaXNhYmxpbmcgaW5kaXZpZHVhbCBwYXJ0cwoJCQkJaWYgKCAhc3VwcHJlc3NEaXNhYmxlZENoZWNrICYmCgkJCQkJCSggaW5zdGFuY2Uub3B0aW9ucy5kaXNhYmxlZCA9PT0gdHJ1ZSB8fAoJCQkJCQkJJCggdGhpcyApLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlyZXR1cm4gKCB0eXBlb2YgaGFuZGxlciA9PT0gInN0cmluZyIgPyBpbnN0YW5jZVsgaGFuZGxlciBdIDogaGFuZGxlciApCgkJCQkJLmFwcGx5KCBpbnN0YW5jZSwgYXJndW1lbnRzICk7CgkJCX0KCgkJCS8vIGNvcHkgdGhlIGd1aWQgc28gZGlyZWN0IHVuYmluZGluZyB3b3JrcwoJCQlpZiAoIHR5cGVvZiBoYW5kbGVyICE9PSAic3RyaW5nIiApIHsKCQkJCWhhbmRsZXJQcm94eS5ndWlkID0gaGFuZGxlci5ndWlkID0KCQkJCQloYW5kbGVyLmd1aWQgfHwgaGFuZGxlclByb3h5Lmd1aWQgfHwgJC5ndWlkKys7CgkJCX0KCgkJCXZhciBtYXRjaCA9IGV2ZW50Lm1hdGNoKCAvXihcdyspXHMqKC4qKSQvICksCgkJCQlldmVudE5hbWUgPSBtYXRjaFsxXSArIGluc3RhbmNlLmV2ZW50TmFtZXNwYWNlLAoJCQkJc2VsZWN0b3IgPSBtYXRjaFsyXTsKCQkJaWYgKCBzZWxlY3RvciApIHsKCQkJCWRlbGVnYXRlRWxlbWVudC5kZWxlZ2F0ZSggc2VsZWN0b3IsIGV2ZW50TmFtZSwgaGFuZGxlclByb3h5ICk7CgkJCX0gZWxzZSB7CgkJCQllbGVtZW50LmJpbmQoIGV2ZW50TmFtZSwgaGFuZGxlclByb3h5ICk7CgkJCX0KCQl9KTsKCX0sCgoJX29mZjogZnVuY3Rpb24oIGVsZW1lbnQsIGV2ZW50TmFtZSApIHsKCQlldmVudE5hbWUgPSAoZXZlbnROYW1lIHx8ICIiKS5zcGxpdCggIiAiICkuam9pbiggdGhpcy5ldmVudE5hbWVzcGFjZSArICIgIiApICsgdGhpcy5ldmVudE5hbWVzcGFjZTsKCQllbGVtZW50LnVuYmluZCggZXZlbnROYW1lICkudW5kZWxlZ2F0ZSggZXZlbnROYW1lICk7Cgl9LAoKCV9kZWxheTogZnVuY3Rpb24oIGhhbmRsZXIsIGRlbGF5ICkgewoJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsKCQkJcmV0dXJuICggdHlwZW9mIGhhbmRsZXIgPT09ICJzdHJpbmciID8gaW5zdGFuY2VbIGhhbmRsZXIgXSA6IGhhbmRsZXIgKQoJCQkJLmFwcGx5KCBpbnN0YW5jZSwgYXJndW1lbnRzICk7CgkJfQoJCXZhciBpbnN0YW5jZSA9IHRoaXM7CgkJcmV0dXJuIHNldFRpbWVvdXQoIGhhbmRsZXJQcm94eSwgZGVsYXkgfHwgMCApOwoJfSwKCglfaG92ZXJhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl0aGlzLmhvdmVyYWJsZSA9IHRoaXMuaG92ZXJhYmxlLmFkZCggZWxlbWVudCApOwoJCXRoaXMuX29uKCBlbGVtZW50LCB7CgkJCW1vdXNlZW50ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5hZGRDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl9LAoJCQltb3VzZWxlYXZlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJfQoJCX0pOwoJfSwKCglfZm9jdXNhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl0aGlzLmZvY3VzYWJsZSA9IHRoaXMuZm9jdXNhYmxlLmFkZCggZWxlbWVudCApOwoJCXRoaXMuX29uKCBlbGVtZW50LCB7CgkJCWZvY3VzaW46IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5hZGRDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCQl9LAoJCQlmb2N1c291dDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJCX0KCQl9KTsKCX0sCgoJX3RyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBldmVudCwgZGF0YSApIHsKCQl2YXIgcHJvcCwgb3JpZywKCQkJY2FsbGJhY2sgPSB0aGlzLm9wdGlvbnNbIHR5cGUgXTsKCgkJZGF0YSA9IGRhdGEgfHwge307CgkJZXZlbnQgPSAkLkV2ZW50KCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSAoIHR5cGUgPT09IHRoaXMud2lkZ2V0RXZlbnRQcmVmaXggPwoJCQl0eXBlIDoKCQkJdGhpcy53aWRnZXRFdmVudFByZWZpeCArIHR5cGUgKS50b0xvd2VyQ2FzZSgpOwoJCS8vIHRoZSBvcmlnaW5hbCBldmVudCBtYXkgY29tZSBmcm9tIGFueSBlbGVtZW50CgkJLy8gc28gd2UgbmVlZCB0byByZXNldCB0aGUgdGFyZ2V0IG9uIHRoZSBuZXcgZXZlbnQKCQlldmVudC50YXJnZXQgPSB0aGlzLmVsZW1lbnRbIDAgXTsKCgkJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJCW9yaWcgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJCWlmICggb3JpZyApIHsKCQkJZm9yICggcHJvcCBpbiBvcmlnICkgewoJCQkJaWYgKCAhKCBwcm9wIGluIGV2ZW50ICkgKSB7CgkJCQkJZXZlbnRbIHByb3AgXSA9IG9yaWdbIHByb3AgXTsKCQkJCX0KCQkJfQoJCX0KCgkJdGhpcy5lbGVtZW50LnRyaWdnZXIoIGV2ZW50LCBkYXRhICk7CgkJcmV0dXJuICEoICQuaXNGdW5jdGlvbiggY2FsbGJhY2sgKSAmJgoJCQljYWxsYmFjay5hcHBseSggdGhpcy5lbGVtZW50WzBdLCBbIGV2ZW50IF0uY29uY2F0KCBkYXRhICkgKSA9PT0gZmFsc2UgfHwKCQkJZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKTsKCX0KfTsKCiQuZWFjaCggeyBzaG93OiAiZmFkZUluIiwgaGlkZTogImZhZGVPdXQiIH0sIGZ1bmN0aW9uKCBtZXRob2QsIGRlZmF1bHRFZmZlY3QgKSB7CgkkLldpZGdldC5wcm90b3R5cGVbICJfIiArIG1ldGhvZCBdID0gZnVuY3Rpb24oIGVsZW1lbnQsIG9wdGlvbnMsIGNhbGxiYWNrICkgewoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciICkgewoJCQlvcHRpb25zID0geyBlZmZlY3Q6IG9wdGlvbnMgfTsKCQl9CgkJdmFyIGhhc09wdGlvbnMsCgkJCWVmZmVjdE5hbWUgPSAhb3B0aW9ucyA/CgkJCQltZXRob2QgOgoJCQkJb3B0aW9ucyA9PT0gdHJ1ZSB8fCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgPwoJCQkJCWRlZmF1bHRFZmZlY3QgOgoJCQkJCW9wdGlvbnMuZWZmZWN0IHx8IGRlZmF1bHRFZmZlY3Q7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgKSB7CgkJCW9wdGlvbnMgPSB7IGR1cmF0aW9uOiBvcHRpb25zIH07CgkJfQoJCWhhc09wdGlvbnMgPSAhJC5pc0VtcHR5T2JqZWN0KCBvcHRpb25zICk7CgkJb3B0aW9ucy5jb21wbGV0ZSA9IGNhbGxiYWNrOwoJCWlmICggb3B0aW9ucy5kZWxheSApIHsKCQkJZWxlbWVudC5kZWxheSggb3B0aW9ucy5kZWxheSApOwoJCX0KCQlpZiAoIGhhc09wdGlvbnMgJiYgJC5lZmZlY3RzICYmICQuZWZmZWN0cy5lZmZlY3RbIGVmZmVjdE5hbWUgXSApIHsKCQkJZWxlbWVudFsgbWV0aG9kIF0oIG9wdGlvbnMgKTsKCQl9IGVsc2UgaWYgKCBlZmZlY3ROYW1lICE9PSBtZXRob2QgJiYgZWxlbWVudFsgZWZmZWN0TmFtZSBdICkgewoJCQllbGVtZW50WyBlZmZlY3ROYW1lIF0oIG9wdGlvbnMuZHVyYXRpb24sIG9wdGlvbnMuZWFzaW5nLCBjYWxsYmFjayApOwoJCX0gZWxzZSB7CgkJCWVsZW1lbnQucXVldWUoZnVuY3Rpb24oIG5leHQgKSB7CgkJCQkkKCB0aGlzIClbIG1ldGhvZCBdKCk7CgkJCQlpZiAoIGNhbGxiYWNrICkgewoJCQkJCWNhbGxiYWNrLmNhbGwoIGVsZW1lbnRbIDAgXSApOwoJCQkJfQoJCQkJbmV4dCgpOwoJCQl9KTsKCQl9Cgl9Owp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHJjYXBpdGFscyA9IC9bQS1aXS9nLAoJcmVwbGFjZUZ1bmN0aW9uID0gZnVuY3Rpb24oIGMgKSB7CgkJcmV0dXJuICItIiArIGMudG9Mb3dlckNhc2UoKTsKCX07CgokLmV4dGVuZCggJC5XaWRnZXQucHJvdG90eXBlLCB7CglfZ2V0Q3JlYXRlT3B0aW9uczogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbiwgdmFsdWUsCgkJCWVsZW0gPSB0aGlzLmVsZW1lbnRbIDAgXSwKCQkJb3B0aW9ucyA9IHt9OwoKCQlmb3IgKCBvcHRpb24gaW4gdGhpcy5vcHRpb25zICkgewoJCQl2YWx1ZSA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggZWxlbSwgb3B0aW9uLnJlcGxhY2UoIHJjYXBpdGFscywgcmVwbGFjZUZ1bmN0aW9uICkgKTsKCQkJaWYgKCB2YWx1ZSAhPSBudWxsICkgewoJCQkJb3B0aW9uc1sgb3B0aW9uIF0gPSB2YWx1ZTsKCQkJfQoJCX0KCgkJcmV0dXJuIG9wdGlvbnM7Cgl9LAoKCWVuaGFuY2VXaXRoaW46IGZ1bmN0aW9uKCB0YXJnZXQsIHVzZUtlZXBOYXRpdmUgKSB7CgkJdGhpcy5lbmhhbmNlKCAkKCAkWyB0aGlzLm5hbWVzcGFjZSBdWyB0aGlzLndpZGdldE5hbWUgXS5pbml0U2VsZWN0b3IsICQoIHRhcmdldCApICksIHVzZUtlZXBOYXRpdmUgKTsKCX0sCgoJZW5oYW5jZTogZnVuY3Rpb24oIHRhcmdldHMsIHVzZUtlZXBOYXRpdmUgKSB7CgkJdmFyIHBhZ2UsIGtlZXBOYXRpdmUsICR3aWRnZXRFbGVtZW50cyA9ICQoIHRhcmdldHMgKTsKCgkJLy8gaWYgaWdub3JlQ29udGVudEVuYWJsZWQgaXMgc2V0IHRvIHRydWUgdGhlIGZyYW1ld29yayBzaG91bGQKCQkvLyBvbmx5IGVuaGFuY2UgdGhlIHNlbGVjdGVkIGVsZW1lbnRzIHdoZW4gdGhleSBkbyBOT1QgaGF2ZSBhCgkJLy8gcGFyZW50IHdpdGggdGhlIGRhdGEtbmFtZXNwYWNlLWlnbm9yZSBhdHRyaWJ1dGUKCQkkd2lkZ2V0RWxlbWVudHMgPSAkLm1vYmlsZS5lbmhhbmNlYWJsZSggJHdpZGdldEVsZW1lbnRzICk7CgoJCWlmICggdXNlS2VlcE5hdGl2ZSAmJiAkd2lkZ2V0RWxlbWVudHMubGVuZ3RoICkgewoJCQkvLyBUT0RPIHJlbW92ZSBkZXBlbmRlbmN5IG9uIHRoZSBwYWdlIHdpZGdldCBmb3IgdGhlIGtlZXBOYXRpdmUuCgkJCS8vIEN1cnJlbnRseSB0aGUga2VlcE5hdGl2ZSB2YWx1ZSBpcyBkZWZpbmVkIG9uIHRoZSBwYWdlIHByb3RvdHlwZSBzbwoJCQkvLyB0aGUgbWV0aG9kIGlzIGFzIHdlbGwKCQkJcGFnZSA9ICQubW9iaWxlLmNsb3Nlc3RQYWdlRGF0YSggJHdpZGdldEVsZW1lbnRzICk7CgkJCWtlZXBOYXRpdmUgPSAoIHBhZ2UgJiYgcGFnZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSkgfHwgIiI7CgoJCQkkd2lkZ2V0RWxlbWVudHMgPSAkd2lkZ2V0RWxlbWVudHMubm90KCBrZWVwTmF0aXZlICk7CgkJfQoKCQkkd2lkZ2V0RWxlbWVudHNbIHRoaXMud2lkZ2V0TmFtZSBdKCk7Cgl9Cn0pOwoKLy9UT0RPOiBSZW1vdmUgaW4gMS41IGZvciBiYWNrY29tcGF0IG9ubHkKJC5tb2JpbGUud2lkZ2V0ID0gJC5XaWRnZXQ7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkICkgewoJLy8gREVQUkVDQVRFRAoJLy8gTk9URSBnbG9iYWwgbW9iaWxlIG9iamVjdCBzZXR0aW5ncwoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gREVQUkVDQVRFRCBTaG91bGQgdGhlIHRleHQgYmUgdmlzYmxlIGluIHRoZSBsb2FkaW5nIG1lc3NhZ2U/CgkJbG9hZGluZ01lc3NhZ2VUZXh0VmlzaWJsZTogdW5kZWZpbmVkLAoKCQkvLyBERVBSRUNBVEVEIFdoZW4gdGhlIHRleHQgaXMgdmlzaWJsZSwgd2hhdCB0aGVtZSBkb2VzIHRoZSBsb2FkaW5nIGJveCB1c2U/CgkJbG9hZGluZ01lc3NhZ2VUaGVtZTogdW5kZWZpbmVkLAoKCQkvLyBERVBSRUNBVEVEIGRlZmF1bHQgbWVzc2FnZSBzZXR0aW5nCgkJbG9hZGluZ01lc3NhZ2U6IHVuZGVmaW5lZCwKCgkJLy8gREVQUkVDQVRFRAoJCS8vIFR1cm4gb24vb2ZmIHBhZ2UgbG9hZGluZyBtZXNzYWdlLiBUaGVtZSBkb3VibGVzIGFzIGFuIG9iamVjdCBhcmd1bWVudAoJCS8vIHdpdGggdGhlIGZvbGxvd2luZyBzaGFwZTogeyB0aGVtZTogJycsIHRleHQ6ICcnLCBodG1sOiAnJywgdGV4dFZpc2libGU6ICcnIH0KCQkvLyBOT1RFIHRoYXQgdGhlICQubW9iaWxlLmxvYWRpbmcqIHNldHRpbmdzIGFuZCBwYXJhbXMgcGFzdCB0aGUgZmlyc3QgYXJlIGRlcHJlY2F0ZWQKCQlzaG93UGFnZUxvYWRpbmdNc2c6IGZ1bmN0aW9uKCB0aGVtZSwgbXNnVGV4dCwgdGV4dG9ubHkgKSB7CgkJCSQubW9iaWxlLmxvYWRpbmcoICJzaG93IiwgdGhlbWUsIG1zZ1RleHQsIHRleHRvbmx5ICk7CgkJfSwKCgkJLy8gREVQUkVDQVRFRAoJCWhpZGVQYWdlTG9hZGluZ01zZzogZnVuY3Rpb24oKSB7CgkJCSQubW9iaWxlLmxvYWRpbmcoICJoaWRlIiApOwoJCX0sCgoJCWxvYWRpbmc6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmxvYWRlcldpZGdldC5sb2FkZXIuYXBwbHkoIHRoaXMubG9hZGVyV2lkZ2V0LCBhcmd1bWVudHMgKTsKCQl9Cgl9KTsKCgkvLyBUT0RPIG1vdmUgbG9hZGVyIGNsYXNzIGRvd24gaW50byB0aGUgd2lkZ2V0IHNldHRpbmdzCgl2YXIgbG9hZGVyQ2xhc3MgPSAidWktbG9hZGVyIiwgJGh0bWwgPSAkKCAiaHRtbCIgKSwgJHdpbmRvdyA9ICQubW9iaWxlLndpbmRvdzsKCgkkLndpZGdldCggIm1vYmlsZS5sb2FkZXIiLCB7CgkJLy8gTk9URSBpZiB0aGUgZ2xvYmFsIGNvbmZpZyBzZXR0aW5ncyBhcmUgZGVmaW5lZCB0aGV5IHdpbGwgb3ZlcnJpZGUgdGhlc2UKCQkvLyAgICAgIG9wdGlvbnMKCQlvcHRpb25zOiB7CgkJCS8vIHRoZSB0aGVtZSBmb3IgdGhlIGxvYWRpbmcgbWVzc2FnZQoJCQl0aGVtZTogImEiLAoKCQkJLy8gd2hldGhlciB0aGUgdGV4dCBpbiB0aGUgbG9hZGluZyBtZXNzYWdlIGlzIHNob3duCgkJCXRleHRWaXNpYmxlOiBmYWxzZSwKCgkJCS8vIGN1c3RvbSBodG1sIGZvciB0aGUgaW5uZXIgY29udGVudCBvZiB0aGUgbG9hZGluZyBtZXNzYWdlCgkJCWh0bWw6ICIiLAoKCQkJLy8gdGhlIHRleHQgdG8gYmUgZGlzcGxheWVkIHdoZW4gdGhlIHBvcHVwIGlzIHNob3duCgkJCXRleHQ6ICJsb2FkaW5nIgoJCX0sCgoJCWRlZmF1bHRIdG1sOiAiPGRpdiBjbGFzcz0nIiArIGxvYWRlckNsYXNzICsgIic+IiArCgkJCSI8c3BhbiBjbGFzcz0ndWktaWNvbi1sb2FkaW5nJz48L3NwYW4+IiArCgkJCSI8aDE+PC9oMT4iICsKCQkJIjwvZGl2PiIsCgoJCS8vIEZvciBub24tZml4ZWQgc3VwcG9ydGluIGJyb3dzZXJzLiBQb3NpdGlvbiBhdCB5IGNlbnRlciAoaWYgc2Nyb2xsVG9wIHN1cHBvcnRlZCksIGFib3ZlIHRoZSBhY3RpdmVCdG4gKGlmIGRlZmluZWQpLCBvciBqdXN0IDEwMHB4IGZyb20gdG9wCgkJZmFrZUZpeExvYWRlcjogZnVuY3Rpb24oKSB7CgkJCXZhciBhY3RpdmVCdG4gPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApLmZpcnN0KCk7CgoJCQl0aGlzLmVsZW1lbnQKCQkJCS5jc3MoewoJCQkJCXRvcDogJC5zdXBwb3J0LnNjcm9sbFRvcCAmJiAkd2luZG93LnNjcm9sbFRvcCgpICsgJHdpbmRvdy5oZWlnaHQoKSAvIDIgfHwKCQkJCQkJYWN0aXZlQnRuLmxlbmd0aCAmJiBhY3RpdmVCdG4ub2Zmc2V0KCkudG9wIHx8IDEwMAoJCQkJfSk7CgkJfSwKCgkJLy8gY2hlY2sgcG9zaXRpb24gb2YgbG9hZGVyIHRvIHNlZSBpZiBpdCBhcHBlYXJzIHRvIGJlICJmaXhlZCIgdG8gY2VudGVyCgkJLy8gaWYgbm90LCB1c2UgYWJzIHBvc2l0aW9uaW5nCgkJY2hlY2tMb2FkZXJQb3NpdGlvbjogZnVuY3Rpb24oKSB7CgkJCXZhciBvZmZzZXQgPSB0aGlzLmVsZW1lbnQub2Zmc2V0KCksCgkJCQlzY3JvbGxUb3AgPSAkd2luZG93LnNjcm9sbFRvcCgpLAoJCQkJc2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCQlpZiAoIG9mZnNldC50b3AgPCBzY3JvbGxUb3AgfHwgKCBvZmZzZXQudG9wIC0gc2Nyb2xsVG9wICkgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1sb2FkZXItZmFrZWZpeCIgKTsKCQkJCXRoaXMuZmFrZUZpeExvYWRlcigpOwoJCQkJJHdpbmRvdwoJCQkJCS51bmJpbmQoICJzY3JvbGwiLCB0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24gKQoJCQkJCS5iaW5kKCAic2Nyb2xsIiwgJC5wcm94eSggdGhpcy5mYWtlRml4TG9hZGVyLCB0aGlzICkgKTsKCQkJfQoJCX0sCgoJCXJlc2V0SHRtbDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5odG1sKCAkKCB0aGlzLmRlZmF1bHRIdG1sICkuaHRtbCgpICk7CgkJfSwKCgkJLy8gVHVybiBvbi9vZmYgcGFnZSBsb2FkaW5nIG1lc3NhZ2UuIFRoZW1lIGRvdWJsZXMgYXMgYW4gb2JqZWN0IGFyZ3VtZW50CgkJLy8gd2l0aCB0aGUgZm9sbG93aW5nIHNoYXBlOiB7IHRoZW1lOiAnJywgdGV4dDogJycsIGh0bWw6ICcnLCB0ZXh0VmlzaWJsZTogJycgfQoJCS8vIE5PVEUgdGhhdCB0aGUgJC5tb2JpbGUubG9hZGluZyogc2V0dGluZ3MgYW5kIHBhcmFtcyBwYXN0IHRoZSBmaXJzdCBhcmUgZGVwcmVjYXRlZAoJCS8vIFRPRE8gc3dlZXQgamVzdXMgd2UgbmVlZCB0byBicmVhayBzb21lIG9mIHRoaXMgb3V0CgkJc2hvdzogZnVuY3Rpb24oIHRoZW1lLCBtc2dUZXh0LCB0ZXh0b25seSApIHsKCQkJdmFyIHRleHRWaXNpYmxlLCBtZXNzYWdlLCBsb2FkU2V0dGluZ3M7CgoJCQl0aGlzLnJlc2V0SHRtbCgpOwoKCQkJLy8gdXNlIHRoZSBwcm90b3R5cGUgb3B0aW9ucyBzbyB0aGF0IHBlb3BsZSBjYW4gc2V0IHRoZW0gZ2xvYmFsbHkgYXQKCQkJLy8gbW9iaWxlIGluaXQuIENvbnNpc3RlbmN5LCBpdCdzIHdoYXQncyBmb3IgZGlubmVyCgkJCWlmICggJC50eXBlKHRoZW1lKSA9PT0gIm9iamVjdCIgKSB7CgkJCQlsb2FkU2V0dGluZ3MgPSAkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucywgdGhlbWUgKTsKCgkJCQkvLyBwcmVmZXIgb2JqZWN0IHByb3BlcnR5IGZyb20gdGhlIHBhcmFtIHRoZW4gdGhlIG9sZCB0aGVtZSBzZXR0aW5nCgkJCQl0aGVtZSA9IGxvYWRTZXR0aW5ncy50aGVtZSB8fCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRoZW1lOwoJCQl9IGVsc2UgewoJCQkJbG9hZFNldHRpbmdzID0gdGhpcy5vcHRpb25zOwoKCQkJCS8vIGhlcmUgd2UgcHJlZmVyIHRoZSB0aGVtIHZhbHVlIHBhc3NlZCBhcyBhIHN0cmluZyBhcmd1bWVudCwgdGhlbgoJCQkJLy8gd2UgcHJlZmVyIHRoZSBnbG9iYWwgb3B0aW9uIGJlY2F1c2Ugd2UgY2FuJ3QgdXNlIHVuZGVmaW5lZCBkZWZhdWx0CgkJCQkvLyBwcm90b3R5cGUgb3B0aW9ucywgdGhlbiB0aGUgcHJvdG90eXBlIG9wdGlvbgoJCQkJdGhlbWUgPSB0aGVtZSB8fCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRoZW1lIHx8IGxvYWRTZXR0aW5ncy50aGVtZTsKCQkJfQoKCQkJLy8gc2V0IHRoZSBtZXNzYWdlIHRleHQsIHByZWZlciB0aGUgcGFyYW0sIHRoZW4gdGhlIHNldHRpbmdzIG9iamVjdAoJCQkvLyB0aGVuIGxvYWRpbmcgbWVzc2FnZQoJCQltZXNzYWdlID0gbXNnVGV4dCB8fCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZSB8fCBsb2FkU2V0dGluZ3MudGV4dDsKCgkJCS8vIHByZXBhcmUgdGhlIGRvbQoJCQkkaHRtbC5hZGRDbGFzcyggInVpLWxvYWRpbmciICk7CgoJCQlpZiAoICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlICE9PSBmYWxzZSB8fCBsb2FkU2V0dGluZ3MuaHRtbCApIHsKCQkJCS8vIGJvb2xlYW4gdmFsdWVzIHJlcXVpcmUgYSBiaXQgbW9yZSB3b3JrIDpQLCBzdXBwb3J0cyBvYmplY3QgcHJvcGVydGllcwoJCQkJLy8gYW5kIG9sZCBzZXR0aW5ncwoJCQkJaWYgKCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRleHRWaXNpYmxlICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJdGV4dFZpc2libGUgPSAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRleHRWaXNpYmxlOwoJCQkJfSBlbHNlIHsKCQkJCQl0ZXh0VmlzaWJsZSA9IGxvYWRTZXR0aW5ncy50ZXh0VmlzaWJsZTsKCQkJCX0KCgkJCQkvLyBhZGQgdGhlIHByb3BlciBjc3MgZ2l2ZW4gdGhlIG9wdGlvbnMgKHRoZW1lLCB0ZXh0LCBldGMpCgkJCQkvLyBGb3JjZSB0ZXh0IHZpc2liaWxpdHkgaWYgdGhlIHNlY29uZCBhcmd1bWVudCB3YXMgc3VwcGxpZWQsIG9yCgkJCQkvLyBpZiB0aGUgdGV4dCB3YXMgZXhwbGljaXRseSBzZXQgaW4gdGhlIG9iamVjdCBhcmdzCgkJCQl0aGlzLmVsZW1lbnQuYXR0cigiY2xhc3MiLCBsb2FkZXJDbGFzcyArCgkJCQkJIiB1aS1jb3JuZXItYWxsIHVpLWJvZHktIiArIHRoZW1lICsKCQkJCQkiIHVpLWxvYWRlci0iICsgKCB0ZXh0VmlzaWJsZSB8fCBtc2dUZXh0IHx8IHRoZW1lLnRleHQgPyAidmVyYm9zZSIgOiAiZGVmYXVsdCIgKSArCgkJCQkJKCBsb2FkU2V0dGluZ3MudGV4dG9ubHkgfHwgdGV4dG9ubHkgPyAiIHVpLWxvYWRlci10ZXh0b25seSIgOiAiIiApICk7CgoJCQkJLy8gVE9ETyB2ZXJpZnkgdGhhdCBqcXVlcnkuZm4uaHRtbCBpcyBvayB0byB1c2UgaW4gYm90aCBjYXNlcyBoZXJlCgkJCQkvLyAgICAgIHRoaXMgbWlnaHQgYmUgb3Zlcmx5IGRlZmVuc2l2ZSBpbiBwcmV2ZW50aW5nIHVua25vd2luZyB4c3MKCQkJCS8vIGlmIHRoZSBodG1sIGF0dHJpYnV0ZSBpcyBkZWZpbmVkIG9uIHRoZSBsb2FkaW5nIHNldHRpbmdzLCB1c2UgdGhhdAoJCQkJLy8gb3RoZXJ3aXNlIHVzZSB0aGUgZmFsbGJhY2tzIGZyb20gYWJvdmUKCQkJCWlmICggbG9hZFNldHRpbmdzLmh0bWwgKSB7CgkJCQkJdGhpcy5lbGVtZW50Lmh0bWwoIGxvYWRTZXR0aW5ncy5odG1sICk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiaDEiICkudGV4dCggbWVzc2FnZSApOwoJCQkJfQoKCQkJCS8vIGF0dGFjaCB0aGUgbG9hZGVyIHRvIHRoZSBET00KCQkJCXRoaXMuZWxlbWVudC5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJCS8vIGNoZWNrIHRoYXQgdGhlIGxvYWRlciBpcyB2aXNpYmxlCgkJCQl0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24oKTsKCgkJCQkvLyBvbiBzY3JvbGwgY2hlY2sgdGhlIGxvYWRlciBwb3NpdGlvbgoJCQkJJHdpbmRvdy5iaW5kKCAic2Nyb2xsIiwgJC5wcm94eSggdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uLCB0aGlzICkgKTsKCQkJfQoJCX0sCgoJCWhpZGU6IGZ1bmN0aW9uKCkgewoJCQkkaHRtbC5yZW1vdmVDbGFzcyggInVpLWxvYWRpbmciICk7CgoJCQlpZiAoICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlICkgewoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktbG9hZGVyLWZha2VmaXgiICk7CgkJCX0KCgkJCSQubW9iaWxlLndpbmRvdy51bmJpbmQoICJzY3JvbGwiLCB0aGlzLmZha2VGaXhMb2FkZXIgKTsKCQkJJC5tb2JpbGUud2luZG93LnVuYmluZCggInNjcm9sbCIsIHRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbiApOwoJCX0KCX0pOwoKCSR3aW5kb3cuYmluZCggInBhZ2Vjb250YWluZXJjcmVhdGUiLCBmdW5jdGlvbigpIHsKCQkkLm1vYmlsZS5sb2FkZXJXaWRnZXQgPSAkLm1vYmlsZS5sb2FkZXJXaWRnZXQgfHwgJCggJC5tb2JpbGUubG9hZGVyLnByb3RvdHlwZS5kZWZhdWx0SHRtbCApLmxvYWRlcigpOwoJfSk7Cn0pKGpRdWVyeSwgdGhpcyk7CgoKLy8gU2NyaXB0OiBqUXVlcnkgaGFzaGNoYW5nZSBldmVudAovLyAKLy8gKlZlcnNpb246IDEuMywgTGFzdCB1cGRhdGVkOiA3LzIxLzIwMTAqCi8vIAovLyBQcm9qZWN0IEhvbWUgLSBodHRwOi8vYmVuYWxtYW4uY29tL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlLXBsdWdpbi8KLy8gR2l0SHViICAgICAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlLwovLyBTb3VyY2UgICAgICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5qcwovLyAoTWluaWZpZWQpICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5taW4uanMgKDAuOGtiIGd6aXBwZWQpCi8vIAovLyBBYm91dDogTGljZW5zZQovLyAKLy8gQ29weXJpZ2h0IChjKSAyMDEwICJDb3dib3kiIEJlbiBBbG1hbiwKLy8gRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXMuCi8vIGh0dHA6Ly9iZW5hbG1hbi5jb20vYWJvdXQvbGljZW5zZS8KLy8gCi8vIEFib3V0OiBFeGFtcGxlcwovLyAKLy8gVGhlc2Ugd29ya2luZyBleGFtcGxlcywgY29tcGxldGUgd2l0aCBmdWxseSBjb21tZW50ZWQgY29kZSwgaWxsdXN0cmF0ZSBhIGZldwovLyB3YXlzIGluIHdoaWNoIHRoaXMgcGx1Z2luIGNhbiBiZSB1c2VkLgovLyAKLy8gaGFzaGNoYW5nZSBldmVudCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9oYXNoY2hhbmdlLwovLyBkb2N1bWVudC5kb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvZG9jdW1lbnRfZG9tYWluLwovLyAKLy8gQWJvdXQ6IFN1cHBvcnQgYW5kIFRlc3RpbmcKLy8gCi8vIEluZm9ybWF0aW9uIGFib3V0IHdoYXQgdmVyc2lvbiBvciB2ZXJzaW9ucyBvZiBqUXVlcnkgdGhpcyBwbHVnaW4gaGFzIGJlZW4KLy8gdGVzdGVkIHdpdGgsIHdoYXQgYnJvd3NlcnMgaXQgaGFzIGJlZW4gdGVzdGVkIGluLCBhbmQgd2hlcmUgdGhlIHVuaXQgdGVzdHMKLy8gcmVzaWRlIChzbyB5b3UgY2FuIHRlc3QgaXQgeW91cnNlbGYpLgovLyAKLy8galF1ZXJ5IFZlcnNpb25zIC0gMS4yLjYsIDEuMy4yLCAxLjQuMSwgMS40LjIKLy8gQnJvd3NlcnMgVGVzdGVkIC0gSW50ZXJuZXQgRXhwbG9yZXIgNi04LCBGaXJlZm94IDItNCwgQ2hyb21lIDUtNiwgU2FmYXJpIDMuMi01LAovLyAgICAgICAgICAgICAgICAgICBPcGVyYSA5LjYtMTAuNjAsIGlQaG9uZSAzLjEsIEFuZHJvaWQgMS42LTIuMiwgQmxhY2tCZXJyeSA0LjYtNS4KLy8gVW5pdCBUZXN0cyAgICAgIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL3VuaXQvCi8vIAovLyBBYm91dDogS25vd24gaXNzdWVzCi8vIAovLyBXaGlsZSB0aGlzIGpRdWVyeSBoYXNoY2hhbmdlIGV2ZW50IGltcGxlbWVudGF0aW9uIGlzIHF1aXRlIHN0YWJsZSBhbmQKLy8gcm9idXN0LCB0aGVyZSBhcmUgYSBmZXcgdW5mb3J0dW5hdGUgYnJvd3NlciBidWdzIHN1cnJvdW5kaW5nIGV4cGVjdGVkCi8vIGhhc2hjaGFuZ2UgZXZlbnQtYmFzZWQgYmVoYXZpb3JzLCBpbmRlcGVuZGVudCBvZiBhbnkgSmF2YVNjcmlwdAovLyB3aW5kb3cub25oYXNoY2hhbmdlIGFic3RyYWN0aW9uLiBTZWUgdGhlIGZvbGxvd2luZyBleGFtcGxlcyBmb3IgbW9yZQovLyBpbmZvcm1hdGlvbjoKLy8gCi8vIENocm9tZTogQmFjayBCdXR0b24gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLWNocm9tZS1iYWNrLWJ1dHRvbi8KLy8gRmlyZWZveDogUmVtb3RlIFhNTEh0dHBSZXF1ZXN0IC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1maXJlZm94LXJlbW90ZS14aHIvCi8vIFdlYktpdDogQmFjayBCdXR0b24gaW4gYW4gSWZyYW1lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy13ZWJraXQtaGFzaC1pZnJhbWUvCi8vIFNhZmFyaTogQmFjayBCdXR0b24gZnJvbSBhIGRpZmZlcmVudCBkb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLXNhZmFyaS1iYWNrLWZyb20tZGlmZi1kb21haW4vCi8vIAovLyBBbHNvIG5vdGUgdGhhdCBzaG91bGQgYSBicm93c2VyIG5hdGl2ZWx5IHN1cHBvcnQgdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UgCi8vIGV2ZW50LCBidXQgbm90IHJlcG9ydCB0aGF0IGl0IGRvZXMsIHRoZSBmYWxsYmFjayBwb2xsaW5nIGxvb3Agd2lsbCBiZSB1c2VkLgovLyAKLy8gQWJvdXQ6IFJlbGVhc2UgSGlzdG9yeQovLyAKLy8gMS4zICAgLSAoNy8yMS8yMDEwKSBSZW9yZ2FuaXplZCBJRTYvNyBJZnJhbWUgY29kZSB0byBtYWtlIGl0IG1vcmUKLy8gICAgICAgICAicmVtb3ZhYmxlIiBmb3IgbW9iaWxlLW9ubHkgZGV2ZWxvcG1lbnQuIEFkZGVkIElFNi83IGRvY3VtZW50LnRpdGxlCi8vICAgICAgICAgc3VwcG9ydC4gQXR0ZW1wdGVkIHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZSBieSB1c2luZwovLyAgICAgICAgIHRlY2huaXF1ZXMgZnJvbSBodHRwOi8vd3d3LnBhY2llbGxvZ3JvdXAuY29tL2Jsb2cvP3A9NjA0LiBBZGRlZCAKLy8gICAgICAgICBzdXBwb3J0IGZvciB0aGUgInNob3J0Y3V0IiBmb3JtYXQgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoIGZuICkgYW5kCi8vICAgICAgICAgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBsaWtlIGpRdWVyeSBwcm92aWRlcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgovLyAgICAgICAgIFJlbmFtZWQgalF1ZXJ5Lmhhc2hjaGFuZ2VEZWxheSB0byA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IGFuZAovLyAgICAgICAgIGxvd2VyZWQgaXRzIGRlZmF1bHQgdmFsdWUgdG8gNTAuIEFkZGVkIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+Ci8vICAgICAgICAgYW5kIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmM+IHByb3BlcnRpZXMgcGx1cyBkb2N1bWVudC1kb21haW4uaHRtbAovLyAgICAgICAgIGZpbGUgdG8gYWRkcmVzcyBhY2Nlc3MgZGVuaWVkIGlzc3VlcyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGluCi8vICAgICAgICAgSUU2LzcuCi8vIDEuMiAgIC0gKDIvMTEvMjAxMCkgRml4ZWQgYSBidWcgd2hlcmUgY29taW5nIGJhY2sgdG8gYSBwYWdlIHVzaW5nIHRoaXMgcGx1Z2luCi8vICAgICAgICAgZnJvbSBhIHBhZ2Ugb24gYW5vdGhlciBkb21haW4gd291bGQgY2F1c2UgYW4gZXJyb3IgaW4gU2FmYXJpIDQuIEFsc28sCi8vICAgICAgICAgSUU2LzcgSWZyYW1lIGlzIG5vdyBpbnNlcnRlZCBhZnRlciB0aGUgYm9keSAodGhpcyBhY3R1YWxseSB3b3JrcyksCi8vICAgICAgICAgd2hpY2ggcHJldmVudHMgdGhlIHBhZ2UgZnJvbSBzY3JvbGxpbmcgd2hlbiB0aGUgZXZlbnQgaXMgZmlyc3QgYm91bmQuCi8vICAgICAgICAgRXZlbnQgY2FuIGFsc28gbm93IGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBpdCB3b24ndCBiZSB1c2FibGUKLy8gICAgICAgICBiZWZvcmUgdGhlbiBpbiBJRTYvNy4KLy8gMS4xICAgLSAoMS8yMS8yMDEwKSBJbmNvcnBvcmF0ZWQgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHRlc3QgdG8gZml4IElFOCBidWcKLy8gICAgICAgICB3aGVyZSBicm93c2VyIHZlcnNpb24gaXMgaW5jb3JyZWN0bHkgcmVwb3J0ZWQgYXMgOC4wLCBkZXNwaXRlCi8vICAgICAgICAgaW5jbHVzaW9uIG9mIHRoZSBYLVVBLUNvbXBhdGlibGUgSUU9RW11bGF0ZUlFNyBtZXRhIHRhZy4KLy8gMS4wICAgLSAoMS85LzIwMTApIEluaXRpYWwgUmVsZWFzZS4gQnJva2Ugb3V0IHRoZSBqUXVlcnkgQkJRIGV2ZW50LnNwZWNpYWwKLy8gICAgICAgICB3aW5kb3cub25oYXNoY2hhbmdlIGZ1bmN0aW9uYWxpdHkgaW50byBhIHNlcGFyYXRlIHBsdWdpbiBmb3IgdXNlcnMKLy8gICAgICAgICB3aG8gd2FudCBqdXN0IHRoZSBiYXNpYyBldmVudCAmIGJhY2sgYnV0dG9uIHN1cHBvcnQsIHdpdGhvdXQgYWxsIHRoZQovLyAgICAgICAgIGV4dHJhIGF3ZXNvbWVuZXNzIHRoYXQgQkJRIHByb3ZpZGVzLiBUaGlzIHBsdWdpbiB3aWxsIGJlIGluY2x1ZGVkIGFzCi8vICAgICAgICAgcGFydCBvZiBqUXVlcnkgQkJRLCBidXQgYWxzbyBiZSBhdmFpbGFibGUgc2VwYXJhdGVseS4KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CiAgLy8gUmV1c2VkIHN0cmluZy4KICB2YXIgc3RyX2hhc2hjaGFuZ2UgPSAnaGFzaGNoYW5nZScsCiAgICAKICAgIC8vIE1ldGhvZCAvIG9iamVjdCByZWZlcmVuY2VzLgogICAgZG9jID0gZG9jdW1lbnQsCiAgICBmYWtlX29uaGFzaGNoYW5nZSwKICAgIHNwZWNpYWwgPSAkLmV2ZW50LnNwZWNpYWwsCiAgICAKICAgIC8vIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCB3aW5kb3cub25oYXNoY2hhbmdlPyBOb3RlIHRoYXQgSUU4IHJ1bm5pbmcgaW4KICAgIC8vIElFNyBjb21wYXRpYmlsaXR5IG1vZGUgcmVwb3J0cyB0cnVlIGZvciAnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3csIGV2ZW4KICAgIC8vIHRob3VnaCB0aGUgZXZlbnQgaXNuJ3Qgc3VwcG9ydGVkLCBzbyBhbHNvIHRlc3QgZG9jdW1lbnQuZG9jdW1lbnRNb2RlLgogICAgZG9jX21vZGUgPSBkb2MuZG9jdW1lbnRNb2RlLAogICAgc3VwcG9ydHNfb25oYXNoY2hhbmdlID0gJ29uJyArIHN0cl9oYXNoY2hhbmdlIGluIHdpbmRvdyAmJiAoIGRvY19tb2RlID09PSB1bmRlZmluZWQgfHwgZG9jX21vZGUgPiA3ICk7CiAgCiAgLy8gR2V0IGxvY2F0aW9uLmhhc2ggKG9yIHdoYXQgeW91J2QgZXhwZWN0IGxvY2F0aW9uLmhhc2ggdG8gYmUpIHNhbnMgYW55CiAgLy8gbGVhZGluZyAjLiBUaGFua3MgZm9yIG1ha2luZyB0aGlzIG5lY2Vzc2FyeSwgRmlyZWZveCEKICBmdW5jdGlvbiBnZXRfZnJhZ21lbnQoIHVybCApIHsKICAgIHVybCA9IHVybCB8fCBsb2NhdGlvbi5ocmVmOwogICAgcmV0dXJuICcjJyArIHVybC5yZXBsYWNlKCAvXlteI10qIz8oLiopJC8sICckMScgKTsKICB9OwogIAogIC8vIE1ldGhvZDogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UKICAvLyAKICAvLyBCaW5kIGEgaGFuZGxlciB0byB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBvciB0cmlnZ2VyIGFsbCBib3VuZAogIC8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMuIFRoaXMgYmVoYXZpb3IgaXMgY29uc2lzdGVudCB3aXRoCiAgLy8galF1ZXJ5J3MgYnVpbHQtaW4gZXZlbnQgaGFuZGxlcnMuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCBbIGhhbmRsZXIgXSApOwogIC8vIAogIC8vIEFyZ3VtZW50czoKICAvLyAKICAvLyAgaGFuZGxlciAtIChGdW5jdGlvbikgT3B0aW9uYWwgaGFuZGxlciB0byBiZSBib3VuZCB0byB0aGUgaGFzaGNoYW5nZQogIC8vICAgIGV2ZW50LiBUaGlzIGlzIGEgInNob3J0Y3V0IiBmb3IgdGhlIG1vcmUgdmVyYm9zZSBmb3JtOgogIC8vICAgIGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgaGFuZGxlciApLiBJZiBoYW5kbGVyIGlzIG9taXR0ZWQsCiAgLy8gICAgYWxsIGJvdW5kIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMgd2lsbCBiZSB0cmlnZ2VyZWQuIFRoaXMKICAvLyAgICBpcyBhIHNob3J0Y3V0IGZvciB0aGUgbW9yZSB2ZXJib3NlCiAgLy8gICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuIFRoZXNlIGZvcm1zIGFyZSBkZXNjcmliZWQgaW4KICAvLyAgICB0aGUgPGhhc2hjaGFuZ2UgZXZlbnQ+IHNlY3Rpb24uCiAgLy8gCiAgLy8gUmV0dXJuczoKICAvLyAKICAvLyAgKGpRdWVyeSkgVGhlIGluaXRpYWwgalF1ZXJ5IGNvbGxlY3Rpb24gb2YgZWxlbWVudHMuCiAgCiAgLy8gQWxsb3cgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQoZWxlbSkuaGFzaGNoYW5nZSggZm4gKSBmb3IgYmluZGluZyBhbmQKICAvLyAkKGVsZW0pLmhhc2hjaGFuZ2UoKSBmb3IgdHJpZ2dlcmluZywgbGlrZSBqUXVlcnkgZG9lcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0gPSBmdW5jdGlvbiggZm4gKSB7CiAgICByZXR1cm4gZm4gPyB0aGlzLmJpbmQoIHN0cl9oYXNoY2hhbmdlLCBmbiApIDogdGhpcy50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogIH07CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5CiAgLy8gCiAgLy8gVGhlIG51bWVyaWMgaW50ZXJ2YWwgKGluIG1pbGxpc2Vjb25kcykgYXQgd2hpY2ggdGhlIDxoYXNoY2hhbmdlIGV2ZW50PgogIC8vIHBvbGxpbmcgbG9vcCBleGVjdXRlcy4gRGVmYXVsdHMgdG8gNTAuCiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbgogIC8vIAogIC8vIElmIHlvdSdyZSBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbiB5b3VyIEphdmFTY3JpcHQsIGFuZCB5b3Ugd2FudCBoYXNoCiAgLy8gaGlzdG9yeSB0byB3b3JrIGluIElFNi83LCBub3Qgb25seSBtdXN0IHRoaXMgcHJvcGVydHkgYmUgc2V0LCBidXQgeW91IG11c3QKICAvLyBhbHNvIHNldCBkb2N1bWVudC5kb21haW4gQkVGT1JFIGpRdWVyeSBpcyBsb2FkZWQgaW50byB0aGUgcGFnZS4gVGhpcwogIC8vIHByb3BlcnR5IGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcKICAvLyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vIAogIC8vIEluIGFkZGl0aW9uLCB0aGUgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydHkgbXVzdCBiZSBzZXQgdG8gdGhlCiAgLy8gcGF0aCBvZiB0aGUgaW5jbHVkZWQgImRvY3VtZW50LWRvbWFpbi5odG1sIiBmaWxlLCB3aGljaCBjYW4gYmUgcmVuYW1lZCBvcgogIC8vIG1vZGlmaWVkIGlmIG5lY2Vzc2FyeSAobm90ZSB0aGF0IHRoZSBkb2N1bWVudC5kb21haW4gc3BlY2lmaWVkIG11c3QgYmUgdGhlCiAgLy8gc2FtZSBpbiBib3RoIHlvdXIgbWFpbiBKYXZhU2NyaXB0IGFzIHdlbGwgYXMgaW4gdGhpcyBmaWxlKS4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4gPSBkb2N1bWVudC5kb21haW47CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYwogIC8vIAogIC8vIElmLCBmb3Igc29tZSByZWFzb24sIHlvdSBuZWVkIHRvIHNwZWNpZnkgYW4gSWZyYW1lIHNyYyBmaWxlIChmb3IgZXhhbXBsZSwKICAvLyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGFzIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+KSwgeW91IGNhbgogIC8vIGRvIHNvIHVzaW5nIHRoaXMgcHJvcGVydHkuIE5vdGUgdGhhdCB3aGVuIHVzaW5nIHRoaXMgcHJvcGVydHksIGhpc3RvcnkKICAvLyB3b24ndCBiZSByZWNvcmRlZCBpbiBJRTYvNyB1bnRpbCB0aGUgSWZyYW1lIHNyYyBmaWxlIGxvYWRzLiBUaGlzIHByb3BlcnR5CiAgLy8gaXMgb25seSBhcHBsaWNhYmxlIGlmIHlvdSBhcmUgc3VwcG9ydGluZyBJRTYvNyAob3IgSUU4IG9wZXJhdGluZyBpbiAiSUU3CiAgLy8gY29tcGF0aWJpbGl0eSIgbW9kZSkuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjID0gJ3BhdGgvdG8vZmlsZS5odG1sJzsKICAKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ID0gNTA7CiAgLyoKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbiA9IG51bGw7CiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmMgPSBudWxsOwogICovCiAgCiAgLy8gRXZlbnQ6IGhhc2hjaGFuZ2UgZXZlbnQKICAvLyAKICAvLyBGaXJlZCB3aGVuIGxvY2F0aW9uLmhhc2ggY2hhbmdlcy4gSW4gYnJvd3NlcnMgdGhhdCBzdXBwb3J0IGl0LCB0aGUgbmF0aXZlCiAgLy8gSFRNTDUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBpcyB1c2VkLCBvdGhlcndpc2UgYSBwb2xsaW5nIGxvb3AgaXMKICAvLyBpbml0aWFsaXplZCwgcnVubmluZyBldmVyeSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IG1pbGxpc2Vjb25kcyB0bwogIC8vIHNlZSBpZiB0aGUgaGFzaCBoYXMgY2hhbmdlZC4gSW4gSUU2LzcgKGFuZCBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKSwgYSBoaWRkZW4gSWZyYW1lIGlzIGNyZWF0ZWQgdG8gYWxsb3cgdGhlIGJhY2sgYnV0dG9uCiAgLy8gYW5kIGhhc2gtYmFzZWQgaGlzdG9yeSB0byB3b3JrLgogIC8vIAogIC8vIFVzYWdlIGFzIGRlc2NyaWJlZCBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2U+OgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPiAKICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCk7CiAgLy8gCiAgLy8gQSBtb3JlIHZlcmJvc2UgdXNhZ2UgdGhhdCBhbGxvd3MgZm9yIGV2ZW50IG5hbWVzcGFjaW5nOgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBmdW5jdGlvbihlKSB7CiAgLy8gPiAgIHZhciBoYXNoID0gbG9jYXRpb24uaGFzaDsKICAvLyA+ICAgLi4uCiAgLy8gPiB9KTsKICAvLyA+IAogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApOwogIC8vIAogIC8vIEFkZGl0aW9uYWwgTm90ZXM6CiAgLy8gCiAgLy8gKiBUaGUgcG9sbGluZyBsb29wIGFuZCBJZnJhbWUgYXJlIG5vdCBjcmVhdGVkIHVudGlsIGF0IGxlYXN0IG9uZSBoYW5kbGVyCiAgLy8gICBpcyBhY3R1YWxseSBib3VuZCB0byB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50LgogIC8vICogSWYgeW91IG5lZWQgdGhlIGJvdW5kIGhhbmRsZXIocykgdG8gZXhlY3V0ZSBpbW1lZGlhdGVseSwgaW4gY2FzZXMgd2hlcmUKICAvLyAgIGEgbG9jYXRpb24uaGFzaCBleGlzdHMgb24gcGFnZSBsb2FkLCB2aWEgYm9va21hcmsgb3IgcGFnZSByZWZyZXNoIGZvcgogIC8vICAgZXhhbXBsZSwgdXNlIGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBvciB0aGUgbW9yZSB2ZXJib3NlIAogIC8vICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuCiAgLy8gKiBUaGUgZXZlbnQgY2FuIGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBzaW5jZSBpdCB3b24ndCBiZSB1c2FibGUKICAvLyAgIGJlZm9yZSB0aGVuIGluIElFNi83IChkdWUgdG8gdGhlIG5lY2Vzc2FyeSBJZnJhbWUpLCByZWNvbW1lbmRlZCB1c2FnZSBpcwogIC8vICAgdG8gYmluZCBpdCBpbnNpZGUgYSBET00gcmVhZHkgaGFuZGxlci4KICAKICAvLyBPdmVycmlkZSBleGlzdGluZyAkLmV2ZW50LnNwZWNpYWwuaGFzaGNoYW5nZSBtZXRob2RzIChhbGxvd2luZyB0aGlzIHBsdWdpbgogIC8vIHRvIGJlIGRlZmluZWQgYWZ0ZXIgalF1ZXJ5IEJCUSBpbiBCQlEncyBzb3VyY2UgY29kZSkuCiAgc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSA9ICQuZXh0ZW5kKCBzcGVjaWFsWyBzdHJfaGFzaGNoYW5nZSBdLCB7CiAgICAKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGZpcnN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyBib3VuZCB0byB3aW5kb3cuCiAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIAogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gY3JlYXRlIG91ciBvd24uIEFuZCB3ZSBkb24ndCB3YW50IHRvIGNhbGwgdGhpcwogICAgICAvLyB1bnRpbCB0aGUgdXNlciBiaW5kcyB0byB0aGUgZXZlbnQsIGp1c3QgaW4gY2FzZSB0aGV5IG5ldmVyIGRvLCBzaW5jZSBpdAogICAgICAvLyB3aWxsIGNyZWF0ZSBhIHBvbGxpbmcgbG9vcCBhbmQgcG9zc2libHkgZXZlbiBhIGhpZGRlbiBJZnJhbWUuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0YXJ0ICk7CiAgICB9LAogICAgCiAgICAvLyBDYWxsZWQgb25seSB3aGVuIHRoZSBsYXN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyB1bmJvdW5kIGZyb20gd2luZG93LgogICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICAvLyBJZiB3aW5kb3cub25oYXNoY2hhbmdlIGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgdGhlcmUncyBub3RoaW5nIHRvIGRvLi4KICAgICAgaWYgKCBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIHN0b3Agb3VycyAoaWYgcG9zc2libGUpLgogICAgICAkKCBmYWtlX29uaGFzaGNoYW5nZS5zdG9wICk7CiAgICB9CiAgICAKICB9KTsKICAKICAvLyBmYWtlX29uaGFzaGNoYW5nZSBkb2VzIGFsbCB0aGUgd29yayBvZiB0cmlnZ2VyaW5nIHRoZSB3aW5kb3cub25oYXNoY2hhbmdlCiAgLy8gZXZlbnQgZm9yIGJyb3dzZXJzIHRoYXQgZG9uJ3QgbmF0aXZlbHkgc3VwcG9ydCBpdCwgaW5jbHVkaW5nIGNyZWF0aW5nIGEKICAvLyBwb2xsaW5nIGxvb3AgdG8gd2F0Y2ggZm9yIGhhc2ggY2hhbmdlcyBhbmQgaW4gSUUgNi83IGNyZWF0aW5nIGEgaGlkZGVuCiAgLy8gSWZyYW1lIHRvIGVuYWJsZSBiYWNrIGFuZCBmb3J3YXJkLgogIGZha2Vfb25oYXNoY2hhbmdlID0gKGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB7fSwKICAgICAgdGltZW91dF9pZCwKICAgICAgCiAgICAgIC8vIFJlbWVtYmVyIHRoZSBpbml0aWFsIGhhc2ggc28gaXQgZG9lc24ndCBnZXQgdHJpZ2dlcmVkIGltbWVkaWF0ZWx5LgogICAgICBsYXN0X2hhc2ggPSBnZXRfZnJhZ21lbnQoKSwKICAgICAgCiAgICAgIGZuX3JldHZhbCA9IGZ1bmN0aW9uKCB2YWwgKSB7IHJldHVybiB2YWw7IH0sCiAgICAgIGhpc3Rvcnlfc2V0ID0gZm5fcmV0dmFsLAogICAgICBoaXN0b3J5X2dldCA9IGZuX3JldHZhbDsKICAgIAogICAgLy8gU3RhcnQgdGhlIHBvbGxpbmcgbG9vcC4KICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCB8fCBwb2xsKCk7CiAgICB9OwogICAgCiAgICAvLyBTdG9wIHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCAmJiBjbGVhclRpbWVvdXQoIHRpbWVvdXRfaWQgKTsKICAgICAgdGltZW91dF9pZCA9IHVuZGVmaW5lZDsKICAgIH07CiAgICAKICAgIC8vIFRoaXMgcG9sbGluZyBsb29wIGNoZWNrcyBldmVyeSAkLmZuLmhhc2hjaGFuZ2UuZGVsYXkgbWlsbGlzZWNvbmRzIHRvIHNlZQogICAgLy8gaWYgbG9jYXRpb24uaGFzaCBoYXMgY2hhbmdlZCwgYW5kIHRyaWdnZXJzIHRoZSAnaGFzaGNoYW5nZScgZXZlbnQgb24KICAgIC8vIHdpbmRvdyB3aGVuIG5lY2Vzc2FyeS4KICAgIGZ1bmN0aW9uIHBvbGwoKSB7CiAgICAgIHZhciBoYXNoID0gZ2V0X2ZyYWdtZW50KCksCiAgICAgICAgaGlzdG9yeV9oYXNoID0gaGlzdG9yeV9nZXQoIGxhc3RfaGFzaCApOwogICAgICAKICAgICAgaWYgKCBoYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgaGlzdG9yeV9zZXQoIGxhc3RfaGFzaCA9IGhhc2gsIGhpc3RvcnlfaGFzaCApOwogICAgICAgIAogICAgICAgICQod2luZG93KS50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogICAgICAgIAogICAgICB9IGVsc2UgaWYgKCBoaXN0b3J5X2hhc2ggIT09IGxhc3RfaGFzaCApIHsKICAgICAgICBsb2NhdGlvbi5ocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKCAvIy4qLywgJycgKSArIGhpc3RvcnlfaGFzaDsKICAgICAgfQogICAgICAKICAgICAgdGltZW91dF9pZCA9IHNldFRpbWVvdXQoIHBvbGwsICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZGVsYXkgKTsKICAgIH07CiAgICAKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2diBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIHdpbmRvdy5hdHRhY2hFdmVudCAmJiAhd2luZG93LmFkZEV2ZW50TGlzdGVuZXIgJiYgIXN1cHBvcnRzX29uaGFzaGNoYW5nZSAmJiAoZnVuY3Rpb24oKSB7CiAgICAgIC8vIE5vdCBvbmx5IGRvIElFNi83IG5lZWQgdGhlICJtYWdpY2FsIiBJZnJhbWUgdHJlYXRtZW50LCBidXQgc28gZG9lcyBJRTgKICAgICAgLy8gd2hlbiBydW5uaW5nIGluICJJRTcgY29tcGF0aWJpbGl0eSIgbW9kZS4KICAgICAgCiAgICAgIHZhciBpZnJhbWUsCiAgICAgICAgaWZyYW1lX3NyYzsKICAgICAgCiAgICAgIC8vIFdoZW4gdGhlIGV2ZW50IGlzIGJvdW5kIGFuZCBwb2xsaW5nIHN0YXJ0cyBpbiBJRSA2LzcsIGNyZWF0ZSBhIGhpZGRlbgogICAgICAvLyBJZnJhbWUgZm9yIGhpc3RvcnkgaGFuZGxpbmcuCiAgICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoICFpZnJhbWUgKSB7CiAgICAgICAgICBpZnJhbWVfc3JjID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmM7CiAgICAgICAgICBpZnJhbWVfc3JjID0gaWZyYW1lX3NyYyAmJiBpZnJhbWVfc3JjICsgZ2V0X2ZyYWdtZW50KCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIENyZWF0ZSBoaWRkZW4gSWZyYW1lLiBBdHRlbXB0IHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZQogICAgICAgICAgLy8gYnkgdXNpbmcgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuCiAgICAgICAgICBpZnJhbWUgPSAkKCc8aWZyYW1lIHRhYmluZGV4PSItMSIgdGl0bGU9ImVtcHR5Ii8+JykuaGlkZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBXaGVuIElmcmFtZSBoYXMgY29tcGxldGVseSBsb2FkZWQsIGluaXRpYWxpemUgdGhlIGhpc3RvcnkgYW5kCiAgICAgICAgICAgIC8vIHN0YXJ0IHBvbGxpbmcuCiAgICAgICAgICAgIC5vbmUoICdsb2FkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWZyYW1lX3NyYyB8fCBoaXN0b3J5X3NldCggZ2V0X2ZyYWdtZW50KCkgKTsKICAgICAgICAgICAgICBwb2xsKCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBMb2FkIElmcmFtZSBzcmMgaWYgc3BlY2lmaWVkLCBvdGhlcndpc2Ugbm90aGluZy4KICAgICAgICAgICAgLmF0dHIoICdzcmMnLCBpZnJhbWVfc3JjIHx8ICdqYXZhc2NyaXB0OjAnICkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGVuZCBJZnJhbWUgYWZ0ZXIgdGhlIGVuZCBvZiB0aGUgYm9keSB0byBwcmV2ZW50IHVubmVjZXNzYXJ5CiAgICAgICAgICAgIC8vIGluaXRpYWwgcGFnZSBzY3JvbGxpbmcgKHllcywgdGhpcyB3b3JrcykuCiAgICAgICAgICAgIC5pbnNlcnRBZnRlciggJ2JvZHknIClbMF0uY29udGVudFdpbmRvdzsKICAgICAgICAgIAogICAgICAgICAgLy8gV2hlbmV2ZXIgYGRvY3VtZW50LnRpdGxlYCBjaGFuZ2VzLCB1cGRhdGUgdGhlIElmcmFtZSdzIHRpdGxlIHRvCiAgICAgICAgICAvLyBwcmV0dGlmeSB0aGUgYmFjay9uZXh0IGhpc3RvcnkgbWVudSBlbnRyaWVzLiBTaW5jZSBJRSBzb21ldGltZXMKICAgICAgICAgIC8vIGVycm9ycyB3aXRoICJVbnNwZWNpZmllZCBlcnJvciIgdGhlIHZlcnkgZmlyc3QgdGltZSB0aGlzIGlzIHNldAogICAgICAgICAgLy8gKHllcywgdmVyeSB1c2VmdWwpIHdyYXAgdGhpcyB3aXRoIGEgdHJ5L2NhdGNoIGJsb2NrLgogICAgICAgICAgZG9jLm9ucHJvcGVydHljaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpZiAoIGV2ZW50LnByb3BlcnR5TmFtZSA9PT0gJ3RpdGxlJyApIHsKICAgICAgICAgICAgICAgIGlmcmFtZS5kb2N1bWVudC50aXRsZSA9IGRvYy50aXRsZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2goZSkge30KICAgICAgICAgIH07CiAgICAgICAgICAKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgICAvLyBPdmVycmlkZSB0aGUgInN0b3AiIG1ldGhvZCBzaW5jZSBhbiBJRTYvNyBJZnJhbWUgd2FzIGNyZWF0ZWQuIEV2ZW4KICAgICAgLy8gaWYgdGhlcmUgYXJlIG5vIGxvbmdlciBhbnkgYm91bmQgZXZlbnQgaGFuZGxlcnMsIHRoZSBwb2xsaW5nIGxvb3AKICAgICAgLy8gaXMgc3RpbGwgbmVjZXNzYXJ5IGZvciBiYWNrL25leHQgdG8gd29yayBhdCBhbGwhCiAgICAgIHNlbGYuc3RvcCA9IGZuX3JldHZhbDsKICAgICAgCiAgICAgIC8vIEdldCBoaXN0b3J5IGJ5IGxvb2tpbmcgYXQgdGhlIGhpZGRlbiBJZnJhbWUncyBsb2NhdGlvbi5oYXNoLgogICAgICBoaXN0b3J5X2dldCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBnZXRfZnJhZ21lbnQoIGlmcmFtZS5sb2NhdGlvbi5ocmVmICk7CiAgICAgIH07CiAgICAgIAogICAgICAvLyBTZXQgYSBuZXcgaGlzdG9yeSBpdGVtIGJ5IG9wZW5pbmcgYW5kIHRoZW4gY2xvc2luZyB0aGUgSWZyYW1lCiAgICAgIC8vIGRvY3VtZW50LCAqdGhlbiogc2V0dGluZyBpdHMgbG9jYXRpb24uaGFzaC4gSWYgZG9jdW1lbnQuZG9tYWluIGhhcwogICAgICAvLyBiZWVuIHNldCwgdXBkYXRlIHRoYXQgYXMgd2VsbC4KICAgICAgaGlzdG9yeV9zZXQgPSBmdW5jdGlvbiggaGFzaCwgaGlzdG9yeV9oYXNoICkgewogICAgICAgIHZhciBpZnJhbWVfZG9jID0gaWZyYW1lLmRvY3VtZW50LAogICAgICAgICAgZG9tYWluID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kb21haW47CiAgICAgICAgCiAgICAgICAgaWYgKCBoYXNoICE9PSBoaXN0b3J5X2hhc2ggKSB7CiAgICAgICAgICAvLyBVcGRhdGUgSWZyYW1lIHdpdGggYW55IGluaXRpYWwgYGRvY3VtZW50LnRpdGxlYCB0aGF0IG1pZ2h0IGJlIHNldC4KICAgICAgICAgIGlmcmFtZV9kb2MudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAKICAgICAgICAgIC8vIE9wZW5pbmcgdGhlIElmcmFtZSdzIGRvY3VtZW50IGFmdGVyIGl0IGhhcyBiZWVuIGNsb3NlZCBpcyB3aGF0CiAgICAgICAgICAvLyBhY3R1YWxseSBhZGRzIGEgaGlzdG9yeSBlbnRyeS4KICAgICAgICAgIGlmcmFtZV9kb2Mub3BlbigpOwogICAgICAgICAgCiAgICAgICAgICAvLyBTZXQgZG9jdW1lbnQuZG9tYWluIGZvciB0aGUgSWZyYW1lIGRvY3VtZW50IGFzIHdlbGwsIGlmIG5lY2Vzc2FyeS4KICAgICAgICAgIGRvbWFpbiAmJiBpZnJhbWVfZG9jLndyaXRlKCAnPHNjcmlwdD5kb2N1bWVudC5kb21haW49IicgKyBkb21haW4gKyAnIjwvc2NyaXB0PicgKTsKICAgICAgICAgIAogICAgICAgICAgaWZyYW1lX2RvYy5jbG9zZSgpOwogICAgICAgICAgCiAgICAgICAgICAvLyBVcGRhdGUgdGhlIElmcmFtZSdzIGhhc2gsIGZvciBncmVhdCBqdXN0aWNlLgogICAgICAgICAgaWZyYW1lLmxvY2F0aW9uLmhhc2ggPSBoYXNoOwogICAgICAgIH0KICAgICAgfTsKICAgICAgCiAgICB9KSgpOwogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eIFJFTU9WRSBJRiBOT1QgU1VQUE9SVElORyBJRTYvNy84IF5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgCiAgICByZXR1cm4gc2VsZjsKICB9KSgpOwogIAp9KShqUXVlcnksdGhpcyk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkvKiEgbWF0Y2hNZWRpYSgpIHBvbHlmaWxsIC0gVGVzdCBhIENTUyBtZWRpYSB0eXBlL3F1ZXJ5IGluIEpTLiBBdXRob3JzICYgY29weXJpZ2h0IChjKSAyMDEyOiBTY290dCBKZWhsLCBQYXVsIElyaXNoLCBOaWNob2xhcyBaYWthcy4gRHVhbCBNSVQvQlNEIGxpY2Vuc2UgKi8KCXdpbmRvdy5tYXRjaE1lZGlhID0gd2luZG93Lm1hdGNoTWVkaWEgfHwgKGZ1bmN0aW9uKCBkb2MsIHVuZGVmaW5lZCApIHsKCgkJCgoJCXZhciBib29sLAoJCQlkb2NFbGVtID0gZG9jLmRvY3VtZW50RWxlbWVudCwKCQkJcmVmTm9kZSA9IGRvY0VsZW0uZmlyc3RFbGVtZW50Q2hpbGQgfHwgZG9jRWxlbS5maXJzdENoaWxkLAoJCQkvLyBmYWtlQm9keSByZXF1aXJlZCBmb3IgPEZGNCB3aGVuIGV4ZWN1dGVkIGluIDxoZWFkPgoJCQlmYWtlQm9keSA9IGRvYy5jcmVhdGVFbGVtZW50KCAiYm9keSIgKSwKCQkJZGl2ID0gZG9jLmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgoJCWRpdi5pZCA9ICJtcS10ZXN0LTEiOwoJCWRpdi5zdHlsZS5jc3NUZXh0ID0gInBvc2l0aW9uOmFic29sdXRlO3RvcDotMTAwZW0iOwoJCWZha2VCb2R5LnN0eWxlLmJhY2tncm91bmQgPSAibm9uZSI7CgkJZmFrZUJvZHkuYXBwZW5kQ2hpbGQoZGl2KTsKCgkJcmV0dXJuIGZ1bmN0aW9uKHEpewoKCQkJZGl2LmlubmVySFRNTCA9ICImc2h5OzxzdHlsZSBtZWRpYT1cIiIgKyBxICsgIlwiPiAjbXEtdGVzdC0xIHsgd2lkdGg6IDQycHg7IH08L3N0eWxlPiI7CgoJCQlkb2NFbGVtLmluc2VydEJlZm9yZSggZmFrZUJvZHksIHJlZk5vZGUgKTsKCQkJYm9vbCA9IGRpdi5vZmZzZXRXaWR0aCA9PT0gNDI7CgkJCWRvY0VsZW0ucmVtb3ZlQ2hpbGQoIGZha2VCb2R5ICk7CgoJCQlyZXR1cm4gewoJCQkJbWF0Y2hlczogYm9vbCwKCQkJCW1lZGlhOiBxCgkJCX07CgoJCX07CgoJfSggZG9jdW1lbnQgKSk7CgoJLy8gJC5tb2JpbGUubWVkaWEgdXNlcyBtYXRjaE1lZGlhIHRvIHJldHVybiBhIGJvb2xlYW4uCgkkLm1vYmlsZS5tZWRpYSA9IGZ1bmN0aW9uKCBxICkgewoJCXJldHVybiB3aW5kb3cubWF0Y2hNZWRpYSggcSApLm1hdGNoZXM7Cgl9OwoKfSkoalF1ZXJ5KTsKCgkoZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQl2YXIgc3VwcG9ydCA9IHsKCQkJdG91Y2g6ICJvbnRvdWNoZW5kIiBpbiBkb2N1bWVudAoJCX07CgoJCSQubW9iaWxlLnN1cHBvcnQgPSAkLm1vYmlsZS5zdXBwb3J0IHx8IHt9OwoJCSQuZXh0ZW5kKCAkLnN1cHBvcnQsIHN1cHBvcnQgKTsKCQkkLmV4dGVuZCggJC5tb2JpbGUuc3VwcG9ydCwgc3VwcG9ydCApOwoJfSggalF1ZXJ5ICkpOwoKCShmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJCSQuZXh0ZW5kKCAkLnN1cHBvcnQsIHsKCQkJb3JpZW50YXRpb246ICJvcmllbnRhdGlvbiIgaW4gd2luZG93ICYmICJvbm9yaWVudGF0aW9uY2hhbmdlIiBpbiB3aW5kb3cKCQl9KTsKCX0oIGpRdWVyeSApKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gdGh4IE1vZGVybml6cgpmdW5jdGlvbiBwcm9wRXhpc3RzKCBwcm9wICkgewoJdmFyIHVjX3Byb3AgPSBwcm9wLmNoYXJBdCggMCApLnRvVXBwZXJDYXNlKCkgKyBwcm9wLnN1YnN0ciggMSApLAoJCXByb3BzID0gKCBwcm9wICsgIiAiICsgdmVuZG9ycy5qb2luKCB1Y19wcm9wICsgIiAiICkgKyB1Y19wcm9wICkuc3BsaXQoICIgIiApLAoJCXY7CgoJZm9yICggdiBpbiBwcm9wcyApIHsKCQlpZiAoIGZiQ1NTWyBwcm9wc1sgdiBdIF0gIT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQp9Cgp2YXIgZmFrZUJvZHkgPSAkKCAiPGJvZHk+IiApLnByZXBlbmRUbyggImh0bWwiICksCglmYkNTUyA9IGZha2VCb2R5WyAwIF0uc3R5bGUsCgl2ZW5kb3JzID0gWyAiV2Via2l0IiwgIk1veiIsICJPIiBdLAoJd2Vib3MgPSAicGFsbUdldFJlc291cmNlIiBpbiB3aW5kb3csIC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IHNjcm9sbFRvcAoJb3BlcmEgPSB3aW5kb3cub3BlcmEsCglvcGVyYW1pbmkgPSB3aW5kb3cub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggd2luZG93Lm9wZXJhbWluaSApID09PSAiW29iamVjdCBPcGVyYU1pbmldIiwKCWJiID0gd2luZG93LmJsYWNrYmVycnkgJiYgIXByb3BFeGlzdHMoICItd2Via2l0LXRyYW5zZm9ybSIgKSwgLy9vbmx5IHVzZWQgdG8gcnVsZSBvdXQgYm94IHNoYWRvdywgYXMgaXQncyBmaWxsZWQgb3BhcXVlIG9uIEJCIDUgYW5kIGxvd2VyCglub2tpYUxURTdfMzsKCgpmdW5jdGlvbiB2YWxpZFN0eWxlKCBwcm9wLCB2YWx1ZSwgY2hlY2tfdmVuZCApIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCXVjID0gZnVuY3Rpb24oIHR4dCApIHsKCQkJcmV0dXJuIHR4dC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgdHh0LnN1YnN0ciggMSApOwoJCX0sCgkJdmVuZF9wcmVmID0gZnVuY3Rpb24oIHZlbmQgKSB7CgkJCWlmICggdmVuZCA9PT0gIiIgKSB7CgkJCQlyZXR1cm4gIiI7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gICItIiArIHZlbmQuY2hhckF0KCAwICkudG9Mb3dlckNhc2UoKSArIHZlbmQuc3Vic3RyKCAxICkgKyAiLSI7CgkJCX0KCQl9LAoJCWNoZWNrX3N0eWxlID0gZnVuY3Rpb24oIHZlbmQgKSB7CgkJCXZhciB2ZW5kX3Byb3AgPSB2ZW5kX3ByZWYoIHZlbmQgKSArIHByb3AgKyAiOiAiICsgdmFsdWUgKyAiOyIsCgkJCQl1Y192ZW5kID0gdWMoIHZlbmQgKSwKCQkJCXByb3BTdHlsZSA9IHVjX3ZlbmQgKyAoIHVjX3ZlbmQgPT09ICIiID8gcHJvcCA6IHVjKCBwcm9wICkgKTsKCgkJCWRpdi5zZXRBdHRyaWJ1dGUoICJzdHlsZSIsIHZlbmRfcHJvcCApOwoKCQkJaWYgKCAhIWRpdi5zdHlsZVsgcHJvcFN0eWxlIF0gKSB7CgkJCQlyZXQgPSB0cnVlOwoJCQl9CgkJfSwKCQljaGVja192ZW5kcyA9IGNoZWNrX3ZlbmQgPyBjaGVja192ZW5kIDogdmVuZG9ycywKCQlpLCByZXQ7CgoJZm9yKCBpID0gMDsgaSA8IGNoZWNrX3ZlbmRzLmxlbmd0aDsgaSsrICkgewoJCWNoZWNrX3N0eWxlKCBjaGVja192ZW5kc1tpXSApOwoJfQoJcmV0dXJuICEhcmV0Owp9CgovLyBpbmxpbmUgU1ZHIHN1cHBvcnQgdGVzdApmdW5jdGlvbiBpbmxpbmVTVkcoKSB7CgkvLyBUaGFua3MgTW9kZXJuaXpyICYgRXJpayBEYWhsc3Ryb20KCXZhciB3ID0gd2luZG93LAoJCXN2ZyA9ICEhdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50TlMgJiYgISF3LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyggImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiwgInN2ZyIgKS5jcmVhdGVTVkdSZWN0ICYmICEoIHcub3BlcmEgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQ2hyb21lIiApID09PSAtMSApLAoJCXN1cHBvcnQgPSBmdW5jdGlvbiggZGF0YSApIHsKCQkJaWYgKCAhKCBkYXRhICYmIHN2ZyApICkgewoJCQkJJCggImh0bWwiICkuYWRkQ2xhc3MoICJ1aS1ub3N2ZyIgKTsKCQkJfQoJCX0sCgkJaW1nID0gbmV3IHcuSW1hZ2UoKTsKCglpbWcub25lcnJvciA9IGZ1bmN0aW9uKCkgewoJCXN1cHBvcnQoIGZhbHNlICk7Cgl9OwoJaW1nLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewoJCXN1cHBvcnQoIGltZy53aWR0aCA9PT0gMSAmJiBpbWcuaGVpZ2h0ID09PSAxICk7Cgl9OwoJaW1nLnNyYyA9ICJkYXRhOmltYWdlL2dpZjtiYXNlNjQsUjBsR09EbGhBUUFCQUlBQUFBQUFBUC8vL3l3QUFBQUFBUUFCQUFBQ0FVd0FPdz09IjsKfQoKZnVuY3Rpb24gdHJhbnNmb3JtM2RUZXN0KCkgewoJdmFyIG1xUHJvcCA9ICJ0cmFuc2Zvcm0tM2QiLAoJCS8vIEJlY2F1c2UgdGhlIGB0cmFuc2xhdGUzZGAgdGVzdCBiZWxvdyB0aHJvd3MgZmFsc2UgcG9zaXRpdmVzIGluIEFuZHJvaWQ6CgkJcmV0ID0gJC5tb2JpbGUubWVkaWEoICIoLSIgKyB2ZW5kb3JzLmpvaW4oICItIiArIG1xUHJvcCArICIpLCgtIiApICsgIi0iICsgbXFQcm9wICsgIiksKCIgKyBtcVByb3AgKyAiKSIgKSwKCQllbCwgdHJhbnNmb3JtcywgdDsKCglpZiAoIHJldCApIHsKCQlyZXR1cm4gISFyZXQ7Cgl9CgoJZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJdHJhbnNmb3JtcyA9IHsKCQkvLyBXZeKAmXJlIG9taXR0aW5nIE9wZXJhIGZvciB0aGUgdGltZSBiZWluZzsgTVMgdXNlcyB1bnByZWZpeGVkLgoJCSJNb3pUcmFuc2Zvcm0iOiAiLW1vei10cmFuc2Zvcm0iLAoJCSJ0cmFuc2Zvcm0iOiAidHJhbnNmb3JtIgoJfTsKCglmYWtlQm9keS5hcHBlbmQoIGVsICk7CgoJZm9yICggdCBpbiB0cmFuc2Zvcm1zICkgewoJCWlmICggZWwuc3R5bGVbIHQgXSAhPT0gdW5kZWZpbmVkICl7CgkJCWVsLnN0eWxlWyB0IF0gPSAidHJhbnNsYXRlM2QoIDEwMHB4LCAxcHgsIDFweCApIjsKCQkJcmV0ID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoIGVsICkuZ2V0UHJvcGVydHlWYWx1ZSggdHJhbnNmb3Jtc1sgdCBdICk7CgkJfQoJfQoJcmV0dXJuICggISFyZXQgJiYgcmV0ICE9PSAibm9uZSIgKTsKfQoKLy8gVGVzdCBmb3IgZHluYW1pYy11cGRhdGluZyBiYXNlIHRhZyBzdXBwb3J0ICggYWxsb3dzIHVzIHRvIGF2b2lkIGhyZWYsc3JjIGF0dHIgcmV3cml0aW5nICkKZnVuY3Rpb24gYmFzZVRhZ1Rlc3QoKSB7Cgl2YXIgZmF1eEJhc2UgPSBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKyBsb2NhdGlvbi5ob3N0ICsgbG9jYXRpb24ucGF0aG5hbWUgKyAidWktZGlyLyIsCgkJYmFzZSA9ICQoICJoZWFkIGJhc2UiICksCgkJZmF1eEVsZSA9IG51bGwsCgkJaHJlZiA9ICIiLAoJCWxpbmssIHJlYmFzZTsKCglpZiAoICFiYXNlLmxlbmd0aCApIHsKCQliYXNlID0gZmF1eEVsZSA9ICQoICI8YmFzZT4iLCB7ICJocmVmIjogZmF1eEJhc2UgfSkuYXBwZW5kVG8oICJoZWFkIiApOwoJfSBlbHNlIHsKCQlocmVmID0gYmFzZS5hdHRyKCAiaHJlZiIgKTsKCX0KCglsaW5rID0gJCggIjxhIGhyZWY9J3Rlc3R1cmwnIC8+IiApLnByZXBlbmRUbyggZmFrZUJvZHkgKTsKCXJlYmFzZSA9IGxpbmtbIDAgXS5ocmVmOwoJYmFzZVsgMCBdLmhyZWYgPSBocmVmIHx8IGxvY2F0aW9uLnBhdGhuYW1lOwoKCWlmICggZmF1eEVsZSApIHsKCQlmYXV4RWxlLnJlbW92ZSgpOwoJfQoJcmV0dXJuIHJlYmFzZS5pbmRleE9mKCBmYXV4QmFzZSApID09PSAwOwp9CgovLyBUaGFua3MgTW9kZXJuaXpyCmZ1bmN0aW9uIGNzc1BvaW50ZXJFdmVudHNUZXN0KCkgewoJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAieCIgKSwKCQlkb2N1bWVudEVsZW1lbnQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsCgkJZ2V0Q29tcHV0ZWRTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlLAoJCXN1cHBvcnRzOwoKCWlmICggISggInBvaW50ZXJFdmVudHMiIGluIGVsZW1lbnQuc3R5bGUgKSApIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJZWxlbWVudC5zdHlsZS5wb2ludGVyRXZlbnRzID0gImF1dG8iOwoJZWxlbWVudC5zdHlsZS5wb2ludGVyRXZlbnRzID0gIngiOwoJZG9jdW1lbnRFbGVtZW50LmFwcGVuZENoaWxkKCBlbGVtZW50ICk7CglzdXBwb3J0cyA9IGdldENvbXB1dGVkU3R5bGUgJiYKCWdldENvbXB1dGVkU3R5bGUoIGVsZW1lbnQsICIiICkucG9pbnRlckV2ZW50cyA9PT0gImF1dG8iOwoJZG9jdW1lbnRFbGVtZW50LnJlbW92ZUNoaWxkKCBlbGVtZW50ICk7CglyZXR1cm4gISFzdXBwb3J0czsKfQoKZnVuY3Rpb24gYm91bmRpbmdSZWN0KCkgewoJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CglyZXR1cm4gdHlwZW9mIGRpdi5nZXRCb3VuZGluZ0NsaWVudFJlY3QgIT09ICJ1bmRlZmluZWQiOwp9CgovLyBub24tVUEtYmFzZWQgSUUgdmVyc2lvbiBjaGVjayBieSBKYW1lcyBQYWRvbHNleSwgbW9kaWZpZWQgYnkgamRhbHRvbiAtIGZyb20gaHR0cDovL2dpc3QuZ2l0aHViLmNvbS81Mjc2ODMKLy8gYWxsb3dzIGZvciBpbmNsdXNpb24gb2YgSUUgNissIGluY2x1ZGluZyBXaW5kb3dzIE1vYmlsZSA3CiQuZXh0ZW5kKCAkLm1vYmlsZSwgeyBicm93c2VyOiB7fSB9ICk7CiQubW9iaWxlLmJyb3dzZXIub2xkSUUgPSAoZnVuY3Rpb24oKSB7Cgl2YXIgdiA9IDMsCgkJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCQlhID0gZGl2LmFsbCB8fCBbXTsKCglkbyB7CgkJZGl2LmlubmVySFRNTCA9ICI8IS0tW2lmIGd0IElFICIgKyAoICsrdiApICsgIl0+PGJyPjwhW2VuZGlmXS0tPiI7Cgl9IHdoaWxlKCBhWzBdICk7CgoJcmV0dXJuIHYgPiA0ID8gdiA6ICF2Owp9KSgpOwoKZnVuY3Rpb24gZml4ZWRQb3NpdGlvbigpIHsKCXZhciB3ID0gd2luZG93LAoJCXVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQlwbGF0Zm9ybSA9IG5hdmlnYXRvci5wbGF0Zm9ybSwKCQkvLyBSZW5kZXJpbmcgZW5naW5lIGlzIFdlYmtpdCwgYW5kIGNhcHR1cmUgbWFqb3IgdmVyc2lvbgoJCXdrbWF0Y2ggPSB1YS5tYXRjaCggL0FwcGxlV2ViS2l0XC8oWzAtOV0rKS8gKSwKCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCWZmbWF0Y2ggPSB1YS5tYXRjaCggL0Zlbm5lY1wvKFswLTldKykvICksCgkJZmZ2ZXJzaW9uID0gISFmZm1hdGNoICYmIGZmbWF0Y2hbIDEgXSwKCQlvcGVyYW1tb2JpbGVtYXRjaCA9IHVhLm1hdGNoKCAvT3BlcmEgTW9iaVwvKFswLTldKykvICksCgkJb212ZXJzaW9uID0gISFvcGVyYW1tb2JpbGVtYXRjaCAmJiBvcGVyYW1tb2JpbGVtYXRjaFsgMSBdOwoKCWlmICgKCQkvLyBpT1MgNC4zIGFuZCBvbGRlciA6IFBsYXRmb3JtIGlzIGlQaG9uZS9QYWQvVG91Y2ggYW5kIFdlYmtpdCB2ZXJzaW9uIGlzIGxlc3MgdGhhbiA1MzQgKGlvczUpCgkJKCAoIHBsYXRmb3JtLmluZGV4T2YoICJpUGhvbmUiICkgPiAtMSB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBhZCIgKSA+IC0xICB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBvZCIgKSA+IC0xICkgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzNCApIHx8CgkJLy8gT3BlcmEgTWluaQoJCSggdy5vcGVyYW1pbmkgJiYgKHt9KS50b1N0cmluZy5jYWxsKCB3Lm9wZXJhbWluaSApID09PSAiW29iamVjdCBPcGVyYU1pbmldIiApIHx8CgkJKCBvcGVyYW1tb2JpbGVtYXRjaCAmJiBvbXZlcnNpb24gPCA3NDU4ICkJfHwKCQkvL0FuZHJvaWQgbHRlIDIuMTogUGxhdGZvcm0gaXMgQW5kcm9pZCBhbmQgV2Via2l0IHZlcnNpb24gaXMgbGVzcyB0aGFuIDUzMyAoQW5kcm9pZCAyLjIpCgkJKCB1YS5pbmRleE9mKCAiQW5kcm9pZCIgKSA+IC0xICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzMgKSB8fAoJCS8vIEZpcmVmb3ggTW9iaWxlIGJlZm9yZSA2LjAgLQoJCSggZmZ2ZXJzaW9uICYmIGZmdmVyc2lvbiA8IDYgKSB8fAoJCS8vIFdlYk9TIGxlc3MgdGhhbiAzCgkJKCAicGFsbUdldFJlc291cmNlIiBpbiB3aW5kb3cgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzNCApCXx8CgkJLy8gTWVlR28KCQkoIHVhLmluZGV4T2YoICJNZWVHbyIgKSA+IC0xICYmIHVhLmluZGV4T2YoICJOb2tpYUJyb3dzZXIvOC41LjAiICkgPiAtMSApICkgewoJCXJldHVybiBmYWxzZTsKCX0KCglyZXR1cm4gdHJ1ZTsKfQoKJC5leHRlbmQoICQuc3VwcG9ydCwgewoJY3NzVHJhbnNpdGlvbnM6ICJXZWJLaXRUcmFuc2l0aW9uRXZlbnQiIGluIHdpbmRvdyB8fAoJCXZhbGlkU3R5bGUoICJ0cmFuc2l0aW9uIiwgImhlaWdodCAxMDBtcyBsaW5lYXIiLCBbICJXZWJraXQiLCAiTW96IiwgIiIgXSApICYmCgkJISQubW9iaWxlLmJyb3dzZXIub2xkSUUgJiYgIW9wZXJhLAoKCS8vIE5vdGUsIENocm9tZSBmb3IgaU9TIGhhcyBhbiBleHRyZW1lbHkgcXVpcmt5IGltcGxlbWVudGF0aW9uIG9mIHBvcHN0YXRlLgoJLy8gV2UndmUgY2hvc2VuIHRvIHRha2UgdGhlIHNob3J0ZXN0IHBhdGggdG8gYSBidWcgZml4IGhlcmUgZm9yIGlzc3VlICM1NDI2CgkvLyBTZWUgdGhlIGZvbGxvd2luZyBsaW5rIGZvciBpbmZvcm1hdGlvbiBhYm91dCB0aGUgcmVnZXggY2hvc2VuCgkvLyBodHRwczovL2RldmVsb3BlcnMuZ29vZ2xlLmNvbS9jaHJvbWUvbW9iaWxlL2RvY3MvdXNlci1hZ2VudCNjaHJvbWVfZm9yX2lvc191c2VyLWFnZW50CglwdXNoU3RhdGU6ICJwdXNoU3RhdGUiIGluIGhpc3RvcnkgJiYKCQkicmVwbGFjZVN0YXRlIiBpbiBoaXN0b3J5ICYmCgkJLy8gV2hlbiBydW5uaW5nIGluc2lkZSBhIEZGIGlmcmFtZSwgY2FsbGluZyByZXBsYWNlU3RhdGUgY2F1c2VzIGFuIGVycm9yCgkJISggd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkZpcmVmb3giICkgPj0gMCAmJiB3aW5kb3cudG9wICE9PSB3aW5kb3cgKSAmJgoJCSggd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQuc2VhcmNoKC9DcmlPUy8pID09PSAtMSApLAoKCW1lZGlhcXVlcnk6ICQubW9iaWxlLm1lZGlhKCAib25seSBhbGwiICksCgljc3NQc2V1ZG9FbGVtZW50OiAhIXByb3BFeGlzdHMoICJjb250ZW50IiApLAoJdG91Y2hPdmVyZmxvdzogISFwcm9wRXhpc3RzKCAib3ZlcmZsb3dTY3JvbGxpbmciICksCgljc3NUcmFuc2Zvcm0zZDogdHJhbnNmb3JtM2RUZXN0KCksCglib3hTaGFkb3c6ICEhcHJvcEV4aXN0cyggImJveFNoYWRvdyIgKSAmJiAhYmIsCglmaXhlZFBvc2l0aW9uOiBmaXhlZFBvc2l0aW9uKCksCglzY3JvbGxUb3A6ICgicGFnZVhPZmZzZXQiIGluIHdpbmRvdyB8fAoJCSJzY3JvbGxUb3AiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCB8fAoJCSJzY3JvbGxUb3AiIGluIGZha2VCb2R5WyAwIF0pICYmICF3ZWJvcyAmJiAhb3BlcmFtaW5pLAoKCWR5bmFtaWNCYXNlVGFnOiBiYXNlVGFnVGVzdCgpLAoJY3NzUG9pbnRlckV2ZW50czogY3NzUG9pbnRlckV2ZW50c1Rlc3QoKSwKCWJvdW5kaW5nUmVjdDogYm91bmRpbmdSZWN0KCksCglpbmxpbmVTVkc6IGlubGluZVNWRwp9KTsKCmZha2VCb2R5LnJlbW92ZSgpOwoKCi8vICQubW9iaWxlLmFqYXhCbGFja2xpc3QgaXMgdXNlZCB0byBvdmVycmlkZSBhamF4RW5hYmxlZCBvbiBwbGF0Zm9ybXMgdGhhdCBoYXZlIGtub3duIGNvbmZsaWN0cyB3aXRoIGhhc2ggaGlzdG9yeSB1cGRhdGVzIChCQjUsIFN5bWJpYW4pCi8vIG9yIHRoYXQgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoT3BlcmEgTWluaSkKLy8gTm90ZTogVGhpcyBkZXRlY3Rpb24gYmVsb3cgaXMgdXNlZCBhcyBhIGxhc3QgcmVzb3J0LgovLyBXZSByZWNvbW1lbmQgb25seSB1c2luZyB0aGVzZSBkZXRlY3Rpb24gbWV0aG9kcyB3aGVuIGFsbCBvdGhlciBtb3JlIHJlbGlhYmxlL2ZvcndhcmQtbG9va2luZyBhcHByb2FjaGVzIGFyZSBub3QgcG9zc2libGUKbm9raWFMVEU3XzMgPSAoZnVuY3Rpb24oKSB7CgoJdmFyIHVhID0gd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQ7CgoJLy9UaGUgZm9sbG93aW5nIGlzIGFuIGF0dGVtcHQgdG8gbWF0Y2ggTm9raWEgYnJvd3NlcnMgdGhhdCBhcmUgcnVubmluZyBTeW1iaWFuL3M2MCwgd2l0aCB3ZWJraXQsIHZlcnNpb24gNy4zIG9yIG9sZGVyCglyZXR1cm4gdWEuaW5kZXhPZiggIk5va2lhIiApID4gLTEgJiYKCQkJKCB1YS5pbmRleE9mKCAiU3ltYmlhbi8zIiApID4gLTEgfHwgdWEuaW5kZXhPZiggIlNlcmllczYwLzUiICkgPiAtMSApICYmCgkJCXVhLmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xICYmCgkJCXVhLm1hdGNoKCAvKEJyb3dzZXJOR3xOb2tpYUJyb3dzZXIpXC83XC5bMC0zXS8gKTsKfSkoKTsKCi8vIFN1cHBvcnQgY29uZGl0aW9ucyB0aGF0IG11c3QgYmUgbWV0IGluIG9yZGVyIHRvIHByb2NlZWQKLy8gZGVmYXVsdCBlbmhhbmNlZCBxdWFsaWZpY2F0aW9ucyBhcmUgbWVkaWEgcXVlcnkgc3VwcG9ydCBPUiBJRSA3KwoKJC5tb2JpbGUuZ3JhZGVBID0gZnVuY3Rpb24oKSB7CglyZXR1cm4gKCAoICQuc3VwcG9ydC5tZWRpYXF1ZXJ5ICYmICQuc3VwcG9ydC5jc3NQc2V1ZG9FbGVtZW50ICkgfHwgJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSAmJiAkLm1vYmlsZS5icm93c2VyLm9sZElFID49IDggKSAmJiAoICQuc3VwcG9ydC5ib3VuZGluZ1JlY3QgfHwgJC5mbi5qcXVlcnkubWF0Y2goLzFcLlswLTcrXVwuWzAtOStdPy8pICE9PSBudWxsICk7Cn07CgokLm1vYmlsZS5hamF4QmxhY2tsaXN0ID0KCQkJLy8gQmxhY2tCZXJyeSBicm93c2VycywgcHJlLXdlYmtpdAoJCQl3aW5kb3cuYmxhY2tiZXJyeSAmJiAhd2luZG93LldlYktpdFBvaW50IHx8CgkJCS8vIE9wZXJhIE1pbmkKCQkJb3BlcmFtaW5pIHx8CgkJCS8vIFN5bWJpYW4gd2Via2l0cyBwcmUgNy4zCgkJCW5va2lhTFRFN18zOwoKLy8gTGFzdGx5LCB0aGlzIHdvcmthcm91bmQgaXMgdGhlIG9ubHkgd2F5IHdlJ3ZlIGZvdW5kIHNvIGZhciB0byBnZXQgcHJlIDcuMyBTeW1iaWFuIHdlYmtpdCBkZXZpY2VzCi8vIHRvIHJlbmRlciB0aGUgc3R5bGVzaGVldHMgd2hlbiB0aGV5J3JlIHJlZmVyZW5jZWQgYmVmb3JlIHRoaXMgc2NyaXB0LCBhcyB3ZSdkIHJlY29tbWVuZCBkb2luZy4KLy8gVGhpcyBzaW1wbHkgcmVhcHBlbmRzIHRoZSBDU1MgaW4gcGxhY2UsIHdoaWNoIGZvciBzb21lIHJlYXNvbiBtYWtlcyBpdCBhcHBseQppZiAoIG5va2lhTFRFN18zICkgewoJJChmdW5jdGlvbigpIHsKCQkkKCAiaGVhZCBsaW5rW3JlbD0nc3R5bGVzaGVldCddIiApLmF0dHIoICJyZWwiLCAiYWx0ZXJuYXRlIHN0eWxlc2hlZXQiICkuYXR0ciggInJlbCIsICJzdHlsZXNoZWV0IiApOwoJfSk7Cn0KCi8vIEZvciBydWxpbmcgb3V0IHNoYWRvd3MgdmlhIGNzcwppZiAoICEkLnN1cHBvcnQuYm94U2hhZG93ICkgewoJJCggImh0bWwiICkuYWRkQ2xhc3MoICJ1aS1ub2JveHNoYWRvdyIgKTsKfQoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyICR3aW4gPSAkLm1vYmlsZS53aW5kb3csIHNlbGYsCgkJZHVtbXlGblRvSW5pdE5hdmlnYXRlID0gZnVuY3Rpb24oKSB7CgkJfTsKCgkkLmV2ZW50LnNwZWNpYWwuYmVmb3JlbmF2aWdhdGUgPSB7CgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkkd2luLm9uKCAibmF2aWdhdGUiLCBkdW1teUZuVG9Jbml0TmF2aWdhdGUgKTsKCQl9LAoKCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCSR3aW4ub2ZmKCAibmF2aWdhdGUiLCBkdW1teUZuVG9Jbml0TmF2aWdhdGUgKTsKCQl9Cgl9OwoKCSQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZSA9IHNlbGYgPSB7CgkJYm91bmQ6IGZhbHNlLAoKCQlwdXNoU3RhdGVFbmFibGVkOiB0cnVlLAoKCQlvcmlnaW5hbEV2ZW50TmFtZTogdW5kZWZpbmVkLAoKCQkvLyBJZiBwdXNoc3RhdGUgc3VwcG9ydCBpcyBwcmVzZW50IGFuZCBwdXNoIHN0YXRlIHN1cHBvcnQgaXMgZGVmaW5lZCB0bwoJCS8vIGJlIHRydWUgb24gdGhlIG1vYmlsZSBuYW1lc3BhY2UuCgkJaXNQdXNoU3RhdGVFbmFibGVkOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQuc3VwcG9ydC5wdXNoU3RhdGUgJiYKCQkJCSQubW9iaWxlLnB1c2hTdGF0ZUVuYWJsZWQgPT09IHRydWUgJiYKCQkJCXRoaXMuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpOwoJCX0sCgoJCS8vICEhIGFzc3VtZXMgbW9iaWxlIG5hbWVzcGFjZSBpcyBwcmVzZW50CgkJaXNIYXNoQ2hhbmdlRW5hYmxlZDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCA9PT0gdHJ1ZTsKCQl9LAoKCQkvLyBUT0RPIGEgbG90IG9mIGR1cGxpY2F0aW9uIGJldHdlZW4gcG9wc3RhdGUgYW5kIGhhc2hjaGFuZ2UKCQlwb3BzdGF0ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgbmV3RXZlbnQgPSBuZXcgJC5FdmVudCggIm5hdmlnYXRlIiApLAoJCQkJYmVmb3JlTmF2aWdhdGUgPSBuZXcgJC5FdmVudCggImJlZm9yZW5hdmlnYXRlIiApLAoJCQkJc3RhdGUgPSBldmVudC5vcmlnaW5hbEV2ZW50LnN0YXRlIHx8IHt9OwoKCQkJYmVmb3JlTmF2aWdhdGUub3JpZ2luYWxFdmVudCA9IGV2ZW50OwoJCQkkd2luLnRyaWdnZXIoIGJlZm9yZU5hdmlnYXRlICk7CgoJCQlpZiAoIGJlZm9yZU5hdmlnYXRlLmlzRGVmYXVsdFByZXZlbnRlZCgpICl7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggZXZlbnQuaGlzdG9yeVN0YXRlICl7CgkJCQkkLmV4dGVuZChzdGF0ZSwgZXZlbnQuaGlzdG9yeVN0YXRlKTsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHRoZSBvcmlnaW5hbCBldmVudCBpcyB0cmFja2VkIGZvciB0aGUgZW5kCgkJCS8vIHVzZXIgdG8gaW5zcGVjdCBpbmNhc2UgdGhleSB3YW50IHRvIGRvIHNvbWV0aGluZyBzcGVjaWFsCgkJCW5ld0V2ZW50Lm9yaWdpbmFsRXZlbnQgPSBldmVudDsKCgkJCS8vIE5PVEUgd2UgbGV0IHRoZSBjdXJyZW50IHN0YWNrIHVud2luZCBiZWNhdXNlIGFueSBhc3NpZ25tZW50IHRvCgkJCS8vICAgICAgbG9jYXRpb24uaGFzaCB3aWxsIHN0b3AgdGhlIHdvcmxkIGFuZCBydW4gdGhpcyBldmVudCBoYW5kbGVyLiBCeQoJCQkvLyAgICAgIGRvaW5nIHRoaXMgd2UgY3JlYXRlIGEgc2ltaWxhciBiZWhhdmlvciB0byBoYXNoY2hhbmdlIG9uIGhhc2gKCQkJLy8gICAgICBhc3NpZ25tZW50CgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkkd2luLnRyaWdnZXIoIG5ld0V2ZW50LCB7CgkJCQkJc3RhdGU6IHN0YXRlCgkJCQl9KTsKCQkJfSwgMCk7CgkJfSwKCgkJaGFzaGNoYW5nZTogZnVuY3Rpb24oIGV2ZW50IC8qLCBkYXRhICovICkgewoJCQl2YXIgbmV3RXZlbnQgPSBuZXcgJC5FdmVudCggIm5hdmlnYXRlIiApLAoJCQkJYmVmb3JlTmF2aWdhdGUgPSBuZXcgJC5FdmVudCggImJlZm9yZW5hdmlnYXRlIiApOwoKCQkJYmVmb3JlTmF2aWdhdGUub3JpZ2luYWxFdmVudCA9IGV2ZW50OwoJCQkkd2luLnRyaWdnZXIoIGJlZm9yZU5hdmlnYXRlICk7CgoJCQlpZiAoIGJlZm9yZU5hdmlnYXRlLmlzRGVmYXVsdFByZXZlbnRlZCgpICl7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB0aGUgb3JpZ2luYWwgZXZlbnQgaXMgdHJhY2tlZCBmb3IgdGhlIGVuZAoJCQkvLyB1c2VyIHRvIGluc3BlY3QgaW5jYXNlIHRoZXkgd2FudCB0byBkbyBzb21ldGhpbmcgc3BlY2lhbAoJCQluZXdFdmVudC5vcmlnaW5hbEV2ZW50ID0gZXZlbnQ7CgoJCQkvLyBUcmlnZ2VyIHRoZSBoYXNoY2hhbmdlIHdpdGggc3RhdGUgcHJvdmlkZWQgYnkgdGhlIHVzZXIKCQkJLy8gdGhhdCBhbHRlcmVkIHRoZSBoYXNoCgkJCSR3aW4udHJpZ2dlciggbmV3RXZlbnQsIHsKCQkJCS8vIFVzZXJzIHRoYXQgd2FudCB0byBmdWxseSBub3JtYWxpemUgdGhlIHR3byBldmVudHMKCQkJCS8vIHdpbGwgbmVlZCB0byBkbyBoaXN0b3J5IG1hbmFnZW1lbnQgZG93biB0aGUgc3RhY2sgYW5kCgkJCQkvLyBhZGQgdGhlIHN0YXRlIHRvIHRoZSBldmVudCBiZWZvcmUgdGhpcyBiaW5kaW5nIGlzIGZpcmVkCgkJCQkvLyBUT0RPIGNvbnNpZGVyIGFsbG93aW5nIGZvciB0aGUgZXhwbGljaXQgYWRkaXRpb24gb2YgY2FsbGJhY2tzCgkJCQkvLyAgICAgIHRvIGJlIGZpcmVkIGJlZm9yZSB0aGlzIHZhbHVlIGlzIHNldCB0byBhdm9pZCBldmVudCB0aW1pbmcgaXNzdWVzCgkJCQlzdGF0ZTogZXZlbnQuaGFzaGNoYW5nZVN0YXRlIHx8IHt9CgkJCX0pOwoJCX0sCgoJCS8vIFRPRE8gV2UgcmVhbGx5IG9ubHkgd2FudCB0byBzZXQgdGhpcyB1cCBvbmNlCgkJLy8gICAgICBidXQgSSdtIG5vdCBjbGVhciBpZiB0aGVyZSdzIGEgYmV0ZXIgd2F5IHRvIGFjaGlldmUKCQkvLyAgICAgIHRoaXMgd2l0aCB0aGUgalF1ZXJ5IHNwZWNpYWwgZXZlbnQgc3RydWN0dXJlCgkJc2V0dXA6IGZ1bmN0aW9uKCAvKiBkYXRhLCBuYW1lc3BhY2VzICovICkgewoJCQlpZiAoIHNlbGYuYm91bmQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXNlbGYuYm91bmQgPSB0cnVlOwoKCQkJaWYgKCBzZWxmLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJc2VsZi5vcmlnaW5hbEV2ZW50TmFtZSA9ICJwb3BzdGF0ZSI7CgkJCQkkd2luLmJpbmQoICJwb3BzdGF0ZS5uYXZpZ2F0ZSIsIHNlbGYucG9wc3RhdGUgKTsKCQkJfSBlbHNlIGlmICggc2VsZi5pc0hhc2hDaGFuZ2VFbmFibGVkKCkgKXsKCQkJCXNlbGYub3JpZ2luYWxFdmVudE5hbWUgPSAiaGFzaGNoYW5nZSI7CgkJCQkkd2luLmJpbmQoICJoYXNoY2hhbmdlLm5hdmlnYXRlIiwgc2VsZi5oYXNoY2hhbmdlICk7CgkJCX0KCQl9Cgl9Owp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJCXZhciBwYXRoLCAkYmFzZSwgZGlhbG9nSGFzaEtleSA9ICImdWktc3RhdGU9ZGlhbG9nIjsKCgkJJC5tb2JpbGUucGF0aCA9IHBhdGggPSB7CgkJCXVpU3RhdGVLZXk6ICImdWktc3RhdGUiLAoKCQkJLy8gVGhpcyBzY2FyeSBsb29raW5nIHJlZ3VsYXIgZXhwcmVzc2lvbiBwYXJzZXMgYW4gYWJzb2x1dGUgVVJMIG9yIGl0cyByZWxhdGl2ZQoJCQkvLyB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgYW5kIGhhc2gpLCBpbnRvIHRoZSB2YXJpb3VzCgkJCS8vIGNvbXBvbmVudHMgKHByb3RvY29sLCBob3N0LCBwYXRoLCBxdWVyeSwgZnJhZ21lbnQsIGV0YyB0aGF0IG1ha2UgdXAgdGhlCgkJCS8vIFVSTCBhcyB3ZWxsIGFzIHNvbWUgb3RoZXIgY29tbW9ubHkgdXNlZCBzdWItcGFydHMuIFdoZW4gdXNlZCB3aXRoIFJlZ0V4cC5leGVjKCkKCQkJLy8gb3IgU3RyaW5nLm1hdGNoLCBpdCBwYXJzZXMgdGhlIFVSTCBpbnRvIGEgcmVzdWx0cyBhcnJheSB0aGF0IGxvb2tzIGxpa2UgdGhpczoKCQkJLy8KCQkJLy8gICAgIFswXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkI21zZy1jb250ZW50CgkJCS8vICAgICBbMV06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveD9tc2c9MTIzNCZ0eXBlPXVucmVhZAoJCQkvLyAgICAgWzJdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3gKCQkJLy8gICAgIFszXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzRdOiBodHRwOgoJCQkvLyAgICAgWzVdOiAvLwoJCQkvLyAgICAgWzZdOiBqYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgIFs3XTogamJsYXM6cGFzc3dvcmQKCQkJLy8gICAgIFs4XTogamJsYXMKCQkJLy8gICAgIFs5XTogcGFzc3dvcmQKCQkJLy8gICAgWzEwXTogbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgIFsxMV06IG15Y29tcGFueS5jb20KCQkJLy8gICAgWzEyXTogODA4MAoJCQkvLyAgICBbMTNdOiAvbWFpbC9pbmJveAoJCQkvLyAgICBbMTRdOiAvbWFpbC8KCQkJLy8gICAgWzE1XTogaW5ib3gKCQkJLy8gICAgWzE2XTogP21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgIFsxN106ICNtc2ctY29udGVudAoJCQkvLwoJCQl1cmxQYXJzZVJFOiAvXlxzKigoKChbXjpcLyNcP10rOik/KD86KFwvXC8pKCg/OigoW146QFwvI1w/XSspKD86XDooW146QFwvI1w/XSspKT8pQCk/KChbXjpcLyNcP1xdXFtdK3xcW1teXC9cXUAjP10rXF0pKD86XDooWzAtOV0rKSk/KSk/KT8pPygoXC8/KD86W15cL1w/I10rXC8rKSopKFteXD8jXSopKSk/KFw/W14jXSspPykoIy4qKT8vLAoKCQkJLy8gQWJzdHJhY3Rpb24gdG8gYWRkcmVzcyB4c3MgKElzc3VlICM0Nzg3KSBieSByZW1vdmluZyB0aGUgYXV0aG9yaXR5IGluCgkJCS8vIGJyb3dzZXJzIHRoYXQgYXV0bwlkZWNvZGUgaXQuIEFsbCByZWZlcmVuY2VzIHRvIGxvY2F0aW9uLmhyZWYgc2hvdWxkIGJlCgkJCS8vIHJlcGxhY2VkIHdpdGggYSBjYWxsIHRvIHRoaXMgbWV0aG9kIHNvIHRoYXQgaXQgY2FuIGJlIGRlYWx0IHdpdGggcHJvcGVybHkgaGVyZQoJCQlnZXRMb2NhdGlvbjogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1cmkgPSB1cmwgPyB0aGlzLnBhcnNlVXJsKCB1cmwgKSA6IGxvY2F0aW9uLAoJCQkJCWhhc2ggPSB0aGlzLnBhcnNlVXJsKCB1cmwgfHwgbG9jYXRpb24uaHJlZiApLmhhc2g7CgoJCQkJLy8gbWltaWMgdGhlIGJyb3dzZXIgd2l0aCBhbiBlbXB0eSBzdHJpbmcgd2hlbiB0aGUgaGFzaCBpcyBlbXB0eQoJCQkJaGFzaCA9IGhhc2ggPT09ICIjIiA/ICIiIDogaGFzaDsKCgkJCQkvLyBNYWtlIHN1cmUgdG8gcGFyc2UgdGhlIHVybCBvciB0aGUgbG9jYXRpb24gb2JqZWN0IGZvciB0aGUgaGFzaCBiZWNhdXNlIHVzaW5nIGxvY2F0aW9uLmhhc2gKCQkJCS8vIGlzIGF1dG9kZWNvZGVkIGluIGZpcmVmb3gsIHRoZSByZXN0IG9mIHRoZSB1cmwgc2hvdWxkIGJlIGZyb20gdGhlIG9iamVjdCAobG9jYXRpb24gdW5sZXNzCgkJCQkvLyB3ZSdyZSB0ZXN0aW5nKSB0byBhdm9pZCB0aGUgaW5jbHVzaW9uIG9mIHRoZSBhdXRob3JpdHkKCQkJCXJldHVybiB1cmkucHJvdG9jb2wgKyAiLy8iICsgdXJpLmhvc3QgKyB1cmkucGF0aG5hbWUgKyB1cmkuc2VhcmNoICsgaGFzaDsKCQkJfSwKCgkJCXBhcnNlTG9jYXRpb246IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHRoaXMucGFyc2VVcmwoIHRoaXMuZ2V0TG9jYXRpb24oKSApOwoJCQl9LAoKCQkJLy9QYXJzZSBhIFVSTCBpbnRvIGEgc3RydWN0dXJlIHRoYXQgYWxsb3dzIGVhc3kgYWNjZXNzIHRvCgkJCS8vYWxsIG9mIHRoZSBVUkwgY29tcG9uZW50cyBieSBuYW1lLgoJCQlwYXJzZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIElmIHdlJ3JlIHBhc3NlZCBhbiBvYmplY3QsIHdlJ2xsIGFzc3VtZSB0aGF0IGl0IGlzCgkJCQkvLyBhIHBhcnNlZCB1cmwgb2JqZWN0IGFuZCBqdXN0IHJldHVybiBpdCBiYWNrIHRvIHRoZSBjYWxsZXIuCgkJCQlpZiAoICQudHlwZSggdXJsICkgPT09ICJvYmplY3QiICkgewoJCQkJCXJldHVybiB1cmw7CgkJCQl9CgoJCQkJdmFyIG1hdGNoZXMgPSBwYXRoLnVybFBhcnNlUkUuZXhlYyggdXJsIHx8ICIiICkgfHwgW107CgoJCQkJCS8vIENyZWF0ZSBhbiBvYmplY3QgdGhhdCBhbGxvd3MgdGhlIGNhbGxlciB0byBhY2Nlc3MgdGhlIHN1Yi1tYXRjaGVzCgkJCQkJLy8gYnkgbmFtZS4gTm90ZSB0aGF0IElFIHJldHVybnMgYW4gZW1wdHkgc3RyaW5nIGluc3RlYWQgb2YgdW5kZWZpbmVkLAoJCQkJCS8vIGxpa2UgYWxsIG90aGVyIGJyb3dzZXJzIGRvLCBzbyB3ZSBub3JtYWxpemUgZXZlcnl0aGluZyBzbyBpdHMgY29uc2lzdGVudAoJCQkJCS8vIG5vIG1hdHRlciB3aGF0IGJyb3dzZXIgd2UncmUgcnVubmluZyBvbi4KCQkJCQlyZXR1cm4gewoJCQkJCQlocmVmOiAgICAgICAgIG1hdGNoZXNbICAwIF0gfHwgIiIsCgkJCQkJCWhyZWZOb0hhc2g6ICAgbWF0Y2hlc1sgIDEgXSB8fCAiIiwKCQkJCQkJaHJlZk5vU2VhcmNoOiBtYXRjaGVzWyAgMiBdIHx8ICIiLAoJCQkJCQlkb21haW46ICAgICAgIG1hdGNoZXNbICAzIF0gfHwgIiIsCgkJCQkJCXByb3RvY29sOiAgICAgbWF0Y2hlc1sgIDQgXSB8fCAiIiwKCQkJCQkJZG91YmxlU2xhc2g6ICBtYXRjaGVzWyAgNSBdIHx8ICIiLAoJCQkJCQlhdXRob3JpdHk6ICAgIG1hdGNoZXNbICA2IF0gfHwgIiIsCgkJCQkJCXVzZXJuYW1lOiAgICAgbWF0Y2hlc1sgIDggXSB8fCAiIiwKCQkJCQkJcGFzc3dvcmQ6ICAgICBtYXRjaGVzWyAgOSBdIHx8ICIiLAoJCQkJCQlob3N0OiAgICAgICAgIG1hdGNoZXNbIDEwIF0gfHwgIiIsCgkJCQkJCWhvc3RuYW1lOiAgICAgbWF0Y2hlc1sgMTEgXSB8fCAiIiwKCQkJCQkJcG9ydDogICAgICAgICBtYXRjaGVzWyAxMiBdIHx8ICIiLAoJCQkJCQlwYXRobmFtZTogICAgIG1hdGNoZXNbIDEzIF0gfHwgIiIsCgkJCQkJCWRpcmVjdG9yeTogICAgbWF0Y2hlc1sgMTQgXSB8fCAiIiwKCQkJCQkJZmlsZW5hbWU6ICAgICBtYXRjaGVzWyAxNSBdIHx8ICIiLAoJCQkJCQlzZWFyY2g6ICAgICAgIG1hdGNoZXNbIDE2IF0gfHwgIiIsCgkJCQkJCWhhc2g6ICAgICAgICAgbWF0Y2hlc1sgMTcgXSB8fCAiIgoJCQkJCX07CgkJCX0sCgoJCQkvL1R1cm4gcmVsUGF0aCBpbnRvIGFuIGFzYm9sdXRlIHBhdGguIGFic1BhdGggaXMKCQkJLy9hbiBvcHRpb25hbCBhYnNvbHV0ZSBwYXRoIHdoaWNoIGRlc2NyaWJlcyB3aGF0CgkJCS8vcmVsUGF0aCBpcyByZWxhdGl2ZSB0by4KCQkJbWFrZVBhdGhBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFBhdGgsIGFic1BhdGggKSB7CgkJCQl2YXIgYWJzU3RhY2ssCgkJCQkJcmVsU3RhY2ssCgkJCQkJaSwgZDsKCgkJCQlpZiAoIHJlbFBhdGggJiYgcmVsUGF0aC5jaGFyQXQoIDAgKSA9PT0gIi8iICkgewoJCQkJCXJldHVybiByZWxQYXRoOwoJCQkJfQoKCQkJCXJlbFBhdGggPSByZWxQYXRoIHx8ICIiOwoJCQkJYWJzUGF0aCA9IGFic1BhdGggPyBhYnNQYXRoLnJlcGxhY2UoIC9eXC98KFwvW15cL10qfFteXC9dKykkL2csICIiICkgOiAiIjsKCgkJCQlhYnNTdGFjayA9IGFic1BhdGggPyBhYnNQYXRoLnNwbGl0KCAiLyIgKSA6IFtdOwoJCQkJcmVsU3RhY2sgPSByZWxQYXRoLnNwbGl0KCAiLyIgKTsKCgkJCQlmb3IgKCBpID0gMDsgaSA8IHJlbFN0YWNrLmxlbmd0aDsgaSsrICkgewoJCQkJCWQgPSByZWxTdGFja1sgaSBdOwoJCQkJCXN3aXRjaCAoIGQgKSB7CgkJCQkJCWNhc2UgIi4iOgoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgIi4uIjoKCQkJCQkJCWlmICggYWJzU3RhY2subGVuZ3RoICkgewoJCQkJCQkJCWFic1N0YWNrLnBvcCgpOwoJCQkJCQkJfQoJCQkJCQkJYnJlYWs7CgkJCQkJCWRlZmF1bHQ6CgkJCQkJCQlhYnNTdGFjay5wdXNoKCBkICk7CgkJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gIi8iICsgYWJzU3RhY2suam9pbiggIi8iICk7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBpZiBib3RoIHVybHMgaGF2ZSB0aGUgc2FtZSBkb21haW4uCgkJCWlzU2FtZURvbWFpbjogZnVuY3Rpb24oIGFic1VybDEsIGFic1VybDIgKSB7CgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggYWJzVXJsMSApLmRvbWFpbiA9PT0gcGF0aC5wYXJzZVVybCggYWJzVXJsMiApLmRvbWFpbjsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGZvciBhbnkgcmVsYXRpdmUgdmFyaWFudC4KCQkJaXNSZWxhdGl2ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIEFsbCByZWxhdGl2ZSBVcmwgdmFyaWFudHMgaGF2ZSBvbmUgdGhpbmcgaW4gY29tbW9uLCBubyBwcm90b2NvbC4KCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCA9PT0gIiI7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW4gYWJzb2x1dGUgdXJsLgoJCQlpc0Fic29sdXRlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIHVybCApLnByb3RvY29sICE9PSAiIjsKCQkJfSwKCgkJCS8vVHVybiB0aGUgc3BlY2lmaWVkIHJlYWx0aXZlIFVSTCBpbnRvIGFuIGFic29sdXRlIG9uZS4gVGhpcyBmdW5jdGlvbgoJCQkvL2NhbiBoYW5kbGUgYWxsIHJlbGF0aXZlIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBmcmFnbWVudCkuCgkJCW1ha2VVcmxBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFVybCwgYWJzVXJsICkgewoJCQkJaWYgKCAhcGF0aC5pc1JlbGF0aXZlVXJsKCByZWxVcmwgKSApIHsKCQkJCQlyZXR1cm4gcmVsVXJsOwoJCQkJfQoKCQkJCWlmICggYWJzVXJsID09PSB1bmRlZmluZWQgKSB7CgkJCQkJYWJzVXJsID0gdGhpcy5kb2N1bWVudEJhc2U7CgkJCQl9CgoJCQkJdmFyIHJlbE9iaiA9IHBhdGgucGFyc2VVcmwoIHJlbFVybCApLAoJCQkJCWFic09iaiA9IHBhdGgucGFyc2VVcmwoIGFic1VybCApLAoJCQkJCXByb3RvY29sID0gcmVsT2JqLnByb3RvY29sIHx8IGFic09iai5wcm90b2NvbCwKCQkJCQlkb3VibGVTbGFzaCA9IHJlbE9iai5wcm90b2NvbCA/IHJlbE9iai5kb3VibGVTbGFzaCA6ICggcmVsT2JqLmRvdWJsZVNsYXNoIHx8IGFic09iai5kb3VibGVTbGFzaCApLAoJCQkJCWF1dGhvcml0eSA9IHJlbE9iai5hdXRob3JpdHkgfHwgYWJzT2JqLmF1dGhvcml0eSwKCQkJCQloYXNQYXRoID0gcmVsT2JqLnBhdGhuYW1lICE9PSAiIiwKCQkJCQlwYXRobmFtZSA9IHBhdGgubWFrZVBhdGhBYnNvbHV0ZSggcmVsT2JqLnBhdGhuYW1lIHx8IGFic09iai5maWxlbmFtZSwgYWJzT2JqLnBhdGhuYW1lICksCgkJCQkJc2VhcmNoID0gcmVsT2JqLnNlYXJjaCB8fCAoICFoYXNQYXRoICYmIGFic09iai5zZWFyY2ggKSB8fCAiIiwKCQkJCQloYXNoID0gcmVsT2JqLmhhc2g7CgoJCQkJcmV0dXJuIHByb3RvY29sICsgZG91YmxlU2xhc2ggKyBhdXRob3JpdHkgKyBwYXRobmFtZSArIHNlYXJjaCArIGhhc2g7CgkJCX0sCgoJCQkvL0FkZCBzZWFyY2ggKGFrYSBxdWVyeSkgcGFyYW1zIHRvIHRoZSBzcGVjaWZpZWQgdXJsLgoJCQlhZGRTZWFyY2hQYXJhbXM6IGZ1bmN0aW9uKCB1cmwsIHBhcmFtcyApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggdXJsICksCgkJCQkJcCA9ICggdHlwZW9mIHBhcmFtcyA9PT0gIm9iamVjdCIgKSA/ICQucGFyYW0oIHBhcmFtcyApIDogcGFyYW1zLAoJCQkJCXMgPSB1LnNlYXJjaCB8fCAiPyI7CgkJCQlyZXR1cm4gdS5ocmVmTm9TZWFyY2ggKyBzICsgKCBzLmNoYXJBdCggcy5sZW5ndGggLSAxICkgIT09ICI/IiA/ICImIiA6ICIiICkgKyBwICsgKCB1Lmhhc2ggfHwgIiIgKTsKCQkJfSwKCgkJCWNvbnZlcnRVcmxUb0RhdGFVcmw6IGZ1bmN0aW9uKCBhYnNVcmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIGFic1VybCApOwoJCQkJaWYgKCBwYXRoLmlzRW1iZWRkZWRQYWdlKCB1ICkgKSB7CgkJCQkJLy8gRm9yIGVtYmVkZGVkIHBhZ2VzLCByZW1vdmUgdGhlIGRpYWxvZyBoYXNoIGtleSBhcyBpbiBnZXRGaWxlUGF0aCgpLAoJCQkJCS8vIGFuZCByZW1vdmUgb3RoZXJ3aXNlIHRoZSBEYXRhIFVybCB3b24ndCBtYXRjaCB0aGUgaWQgb2YgdGhlIGVtYmVkZGVkIFBhZ2UuCgkJCQkJcmV0dXJuIHUuaGFzaAoJCQkJCQkuc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXQoJCQkJCQkucmVwbGFjZSggL14jLywgIiIgKQoJCQkJCQkucmVwbGFjZSggL1w/LiokLywgIiIgKTsKCQkJCX0gZWxzZSBpZiAoIHBhdGguaXNTYW1lRG9tYWluKCB1LCB0aGlzLmRvY3VtZW50QmFzZSApICkgewoJCQkJCXJldHVybiB1LmhyZWZOb0hhc2gucmVwbGFjZSggdGhpcy5kb2N1bWVudEJhc2UuZG9tYWluLCAiIiApLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCQl9CgoJCQkJcmV0dXJuIHdpbmRvdy5kZWNvZGVVUklDb21wb25lbnQoYWJzVXJsKTsKCQkJfSwKCgkJCS8vZ2V0IHBhdGggZnJvbSBjdXJyZW50IGhhc2gsIG9yIGZyb20gYSBmaWxlIHBhdGgKCQkJZ2V0OiBmdW5jdGlvbiggbmV3UGF0aCApIHsKCQkJCWlmICggbmV3UGF0aCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCW5ld1BhdGggPSBwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoJCQkJfQoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBuZXdQYXRoICkucmVwbGFjZSggL1teXC9dKlwuW15cLypdKyQvLCAiIiApOwoJCQl9LAoKCQkJLy9zZXQgbG9jYXRpb24gaGFzaCB0byBwYXRoCgkJCXNldDogZnVuY3Rpb24oIHBhdGggKSB7CgkJCQlsb2NhdGlvbi5oYXNoID0gcGF0aDsKCQkJfSwKCgkJCS8vdGVzdCBpZiBhIGdpdmVuIHVybCAoc3RyaW5nKSBpcyBhIHBhdGgKCQkJLy9OT1RFIG1pZ2h0IGJlIGV4Y2VwdGlvbmFsbHkgbmFpdmUKCQkJaXNQYXRoOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuICggL1wvLyApLnRlc3QoIHVybCApOwoJCQl9LAoKCQkJLy9yZXR1cm4gYSB1cmwgcGF0aCB3aXRoIHRoZSB3aW5kb3cncyBsb2NhdGlvbiBwcm90b2NvbC9ob3N0bmFtZS9wYXRobmFtZSByZW1vdmVkCgkJCWNsZWFuOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCB0aGlzLmRvY3VtZW50QmFzZS5kb21haW4sICIiICk7CgkJCX0sCgoJCQkvL2p1c3QgcmV0dXJuIHRoZSB1cmwgd2l0aG91dCBhbiBpbml0aWFsICMKCQkJc3RyaXBIYXNoOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCAvXiMvLCAiIiApOwoJCQl9LAoKCQkJc3RyaXBRdWVyeVBhcmFtczogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggL1w/LiokLywgIiIgKTsKCQkJfSwKCgkJCS8vcmVtb3ZlIHRoZSBwcmVjZWRpbmcgaGFzaCwgYW55IHF1ZXJ5IHBhcmFtcywgYW5kIGRpYWxvZyBub3RhdGlvbnMKCQkJY2xlYW5IYXNoOiBmdW5jdGlvbiggaGFzaCApIHsKCQkJCXJldHVybiBwYXRoLnN0cmlwSGFzaCggaGFzaC5yZXBsYWNlKCAvXD8uKiQvLCAiIiApLnJlcGxhY2UoIGRpYWxvZ0hhc2hLZXksICIiICkgKTsKCQkJfSwKCgkJCWlzSGFzaFZhbGlkOiBmdW5jdGlvbiggaGFzaCApIHsKCQkJCXJldHVybiAoIC9eI1teI10rJC8gKS50ZXN0KCBoYXNoICk7CgkJCX0sCgoJCQkvL2NoZWNrIHdoZXRoZXIgYSB1cmwgaXMgcmVmZXJlbmNpbmcgdGhlIHNhbWUgZG9tYWluLCBvciBhbiBleHRlcm5hbCBkb21haW4gb3IgZGlmZmVyZW50IHByb3RvY29sCgkJCS8vY291bGQgYmUgbWFpbHRvLCBldGMKCQkJaXNFeHRlcm5hbDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgkJCQlyZXR1cm4gdS5wcm90b2NvbCAmJiB1LmRvbWFpbiAhPT0gdGhpcy5kb2N1bWVudFVybC5kb21haW4gPyB0cnVlIDogZmFsc2U7CgkJCX0sCgoJCQloYXNQcm90b2NvbDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiAoIC9eKDo/XHcrOikvICkudGVzdCggdXJsICk7CgkJCX0sCgoJCQlpc0VtYmVkZGVkUGFnZTogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgoJCQkJLy9pZiB0aGUgcGF0aCBpcyBhYnNvbHV0ZSwgdGhlbiB3ZSBuZWVkIHRvIGNvbXBhcmUgdGhlIHVybCBhZ2FpbnN0CgkJCQkvL2JvdGggdGhlIHRoaXMuZG9jdW1lbnRVcmwgYW5kIHRoZSBkb2N1bWVudEJhc2UuIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcwoJCQkJLy9pcyB0aGF0IGxpbmtzIGVtYmVkZGVkIHdpdGhpbiBleHRlcm5hbCBkb2N1bWVudHMgd2lsbCByZWZlciB0byB0aGUKCQkJCS8vYXBwbGljYXRpb24gZG9jdW1lbnQsIHdoZXJlYXMgbGlua3MgZW1iZWRkZWQgd2l0aGluIHRoZSBhcHBsaWNhdGlvbgoJCQkJLy9kb2N1bWVudCB3aWxsIGJlIHJlc29sdmVkIGFnYWluc3QgdGhlIGRvY3VtZW50IGJhc2UuCgkJCQlpZiAoIHUucHJvdG9jb2wgIT09ICIiICkgewoJCQkJCXJldHVybiAoICF0aGlzLmlzUGF0aCh1Lmhhc2gpICYmIHUuaGFzaCAmJiAoIHUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudFVybC5ocmVmTm9IYXNoIHx8ICggdGhpcy5kb2N1bWVudEJhc2VEaWZmZXJzICYmIHUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApICkgKTsKCQkJCX0KCQkJCXJldHVybiAoIC9eIy8gKS50ZXN0KCB1LmhyZWYgKTsKCQkJfSwKCgkJCXNxdWFzaDogZnVuY3Rpb24oIHVybCwgcmVzb2x1dGlvblVybCApIHsKCQkJCXZhciBocmVmLCBjbGVhbmVkVXJsLCBzZWFyY2gsIHN0YXRlSW5kZXgsCgkJCQkJaXNQYXRoID0gdGhpcy5pc1BhdGgoIHVybCApLAoJCQkJCXVyaSA9IHRoaXMucGFyc2VVcmwoIHVybCApLAoJCQkJCXByZXNlcnZlZEhhc2ggPSB1cmkuaGFzaCwKCQkJCQl1aVN0YXRlID0gIiI7CgoJCQkJLy8gcHJvZHVjZSBhIHVybCBhZ2FpbnN0IHdoaWNoIHdlIGNhbiByZXNvbGUgdGhlIHByb3ZpZGVkIHBhdGgKCQkJCXJlc29sdXRpb25VcmwgPSByZXNvbHV0aW9uVXJsIHx8IChwYXRoLmlzUGF0aCh1cmwpID8gcGF0aC5nZXRMb2NhdGlvbigpIDogcGF0aC5nZXREb2N1bWVudFVybCgpKTsKCgkJCQkvLyBJZiB0aGUgdXJsIGlzIGFueXRoaW5nIGJ1dCBhIHNpbXBsZSBzdHJpbmcsIHJlbW92ZSBhbnkgcHJlY2VkaW5nIGhhc2gKCQkJCS8vIGVnICNmb28vYmFyIC0+IGZvby9iYXIKCQkJCS8vICAgICNmb28gLT4gI2ZvbwoJCQkJY2xlYW5lZFVybCA9IGlzUGF0aCA/IHBhdGguc3RyaXBIYXNoKCB1cmwgKSA6IHVybDsKCgkJCQkvLyBJZiB0aGUgdXJsIGlzIGEgZnVsbCB1cmwgd2l0aCBhIGhhc2ggY2hlY2sgaWYgdGhlIHBhcnNlZCBoYXNoIGlzIGEgcGF0aAoJCQkJLy8gaWYgaXQgaXMsIHN0cmlwIHRoZSAjLCBhbmQgdXNlIGl0IG90aGVyd2lzZSBjb250aW51ZSB3aXRob3V0IGNoYW5nZQoJCQkJY2xlYW5lZFVybCA9IHBhdGguaXNQYXRoKCB1cmkuaGFzaCApID8gcGF0aC5zdHJpcEhhc2goIHVyaS5oYXNoICkgOiBjbGVhbmVkVXJsOwoKCQkJCS8vIFNwbGl0IHRoZSBVSSBTdGF0ZSBrZXlzIG9mZiB0aGUgaHJlZgoJCQkJc3RhdGVJbmRleCA9IGNsZWFuZWRVcmwuaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICk7CgoJCQkJLy8gc3RvcmUgdGhlIHVpIHN0YXRlIGtleXMgZm9yIHVzZQoJCQkJaWYgKCBzdGF0ZUluZGV4ID4gLTEgKXsKCQkJCQl1aVN0YXRlID0gY2xlYW5lZFVybC5zbGljZSggc3RhdGVJbmRleCApOwoJCQkJCWNsZWFuZWRVcmwgPSBjbGVhbmVkVXJsLnNsaWNlKCAwLCBzdGF0ZUluZGV4ICk7CgkJCQl9CgoJCQkJLy8gbWFrZSB0aGUgY2xlYW5lZFVybCBhYnNvbHV0ZSByZWxhdGl2ZSB0byB0aGUgcmVzb2x1dGlvbiB1cmwKCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggY2xlYW5lZFVybCwgcmVzb2x1dGlvblVybCApOwoKCQkJCS8vIGdyYWIgdGhlIHNlYXJjaCBmcm9tIHRoZSByZXNvbHZlZCB1cmwgc2luY2UgcGFyc2luZyBmcm9tCgkJCQkvLyB0aGUgcGFzc2VkIHVybCBtYXkgbm90IHlpZWxkIHRoZSBjb3JyZWN0IHJlc3VsdAoJCQkJc2VhcmNoID0gdGhpcy5wYXJzZVVybCggaHJlZiApLnNlYXJjaDsKCgkJCQkvLyBUT0RPIGFsbCB0aGlzIGNyYXAgaXMgdGVycmlibGUsIGNsZWFuIGl0IHVwCgkJCQlpZiAoIGlzUGF0aCApIHsKCQkJCQkvLyByZWplY3QgdGhlIGhhc2ggaWYgaXQncyBhIHBhdGggb3IgaXQncyBqdXN0IGEgZGlhbG9nIGtleQoJCQkJCWlmICggcGF0aC5pc1BhdGgoIHByZXNlcnZlZEhhc2ggKSB8fCBwcmVzZXJ2ZWRIYXNoLnJlcGxhY2UoIiMiLCAiIikuaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICkgPT09IDApIHsKCQkJCQkJcHJlc2VydmVkSGFzaCA9ICIiOwoJCQkJCX0KCgkJCQkJLy8gQXBwZW5kIHRoZSBVSSBTdGF0ZSBrZXlzIHdoZXJlIGl0IGV4aXN0cyBhbmQgaXQncyBiZWVuIHJlbW92ZWQKCQkJCQkvLyBmcm9tIHRoZSB1cmwKCQkJCQlpZiAoIHVpU3RhdGUgJiYgcHJlc2VydmVkSGFzaC5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKSA9PT0gLTEpewoJCQkJCQlwcmVzZXJ2ZWRIYXNoICs9IHVpU3RhdGU7CgkJCQkJfQoKCQkJCQkvLyBtYWtlIHN1cmUgdGhhdCBwb3VuZCBpcyBvbiB0aGUgZnJvbnQgb2YgdGhlIGhhc2gKCQkJCQlpZiAoIHByZXNlcnZlZEhhc2guaW5kZXhPZiggIiMiICkgPT09IC0xICYmIHByZXNlcnZlZEhhc2ggIT09ICIiICl7CgkJCQkJCXByZXNlcnZlZEhhc2ggPSAiIyIgKyBwcmVzZXJ2ZWRIYXNoOwoJCQkJCX0KCgkJCQkJLy8gcmVjb25zdHJ1Y3QgZWFjaCBvZiB0aGUgcGllY2VzIHdpdGggdGhlIG5ldyBzZWFyY2ggc3RyaW5nIGFuZCBoYXNoCgkJCQkJaHJlZiA9IHBhdGgucGFyc2VVcmwoIGhyZWYgKTsKCQkJCQlocmVmID0gaHJlZi5wcm90b2NvbCArICIvLyIgKyBocmVmLmhvc3QgKyBocmVmLnBhdGhuYW1lICsgc2VhcmNoICsgcHJlc2VydmVkSGFzaDsKCQkJCX0gZWxzZSB7CgkJCQkJaHJlZiArPSBocmVmLmluZGV4T2YoICIjIiApID4gLTEgPyB1aVN0YXRlIDogIiMiICsgdWlTdGF0ZTsKCQkJCX0KCgkJCQlyZXR1cm4gaHJlZjsKCQkJfSwKCgkJCWlzUHJlc2VydmFibGVIYXNoOiBmdW5jdGlvbiggaGFzaCApIHsKCQkJCXJldHVybiBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKS5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKSA9PT0gMDsKCQkJfSwKCgkJCS8vIEVzY2FwZSB3ZWlyZCBjaGFyYWN0ZXJzIGluIHRoZSBoYXNoIGlmIGl0IGlzIHRvIGJlIHVzZWQgYXMgYSBzZWxlY3RvcgoJCQloYXNoVG9TZWxlY3RvcjogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQl2YXIgaGFzSGFzaCA9ICggaGFzaC5zdWJzdHJpbmcoIDAsIDEgKSA9PT0gIiMiICk7CgkJCQlpZiAoIGhhc0hhc2ggKSB7CgkJCQkJaGFzaCA9IGhhc2guc3Vic3RyaW5nKCAxICk7CgkJCQl9CgkJCQlyZXR1cm4gKCBoYXNIYXNoID8gIiMiIDogIiIgKSArIGhhc2gucmVwbGFjZSggLyhbISIjJCUmJygpKissLi86Ozw9Pj9AW1xdXmB7fH1+XSkvZywgIlxcJDEiICk7CgkJCX0KCQl9OwoKCQlwYXRoLmRvY3VtZW50VXJsID0gcGF0aC5wYXJzZUxvY2F0aW9uKCk7CgoJCSRiYXNlID0gJCggImhlYWQiICkuZmluZCggImJhc2UiICk7CgoJCXBhdGguZG9jdW1lbnRCYXNlID0gJGJhc2UubGVuZ3RoID8KCQkJcGF0aC5wYXJzZVVybCggcGF0aC5tYWtlVXJsQWJzb2x1dGUoICRiYXNlLmF0dHIoICJocmVmIiApLCBwYXRoLmRvY3VtZW50VXJsLmhyZWYgKSApIDoKCQkJcGF0aC5kb2N1bWVudFVybDsKCgkJcGF0aC5kb2N1bWVudEJhc2VEaWZmZXJzID0gKHBhdGguZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCAhPT0gcGF0aC5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCk7CgoJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCB1cmwKCQlwYXRoLmdldERvY3VtZW50VXJsID0gZnVuY3Rpb24oIGFzUGFyc2VkT2JqZWN0ICkgewoJCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIHBhdGguZG9jdW1lbnRVcmwgKSA6IHBhdGguZG9jdW1lbnRVcmwuaHJlZjsKCQl9OwoKCQkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgYmFzZSB1cmwKCQlwYXRoLmdldERvY3VtZW50QmFzZSA9IGZ1bmN0aW9uKCBhc1BhcnNlZE9iamVjdCApIHsKCQkJcmV0dXJuIGFzUGFyc2VkT2JqZWN0ID8gJC5leHRlbmQoIHt9LCBwYXRoLmRvY3VtZW50QmFzZSApIDogcGF0aC5kb2N1bWVudEJhc2UuaHJlZjsKCQl9Owp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJJC5tb2JpbGUuSGlzdG9yeSA9IGZ1bmN0aW9uKCBzdGFjaywgaW5kZXggKSB7CgkJdGhpcy5zdGFjayA9IHN0YWNrIHx8IFtdOwoJCXRoaXMuYWN0aXZlSW5kZXggPSBpbmRleCB8fCAwOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5IaXN0b3J5LnByb3RvdHlwZSwgewoJCWdldEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IF07CgkJfSwKCgkJZ2V0TGFzdDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLnByZXZpb3VzSW5kZXggXTsKCQl9LAoKCQlnZXROZXh0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMuYWN0aXZlSW5kZXggKyAxIF07CgkJfSwKCgkJZ2V0UHJldjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IC0gMSBdOwoJCX0sCgoJCS8vIGFkZE5ldyBpcyB1c2VkIHdoZW5ldmVyIGEgbmV3IHBhZ2UgaXMgYWRkZWQKCQlhZGQ6IGZ1bmN0aW9uKCB1cmwsIGRhdGEgKXsKCQkJZGF0YSA9IGRhdGEgfHwge307CgoJCQkvL2lmIHRoZXJlJ3MgZm9yd2FyZCBoaXN0b3J5LCB3aXBlIGl0CgkJCWlmICggdGhpcy5nZXROZXh0KCkgKSB7CgkJCQl0aGlzLmNsZWFyRm9yd2FyZCgpOwoJCQl9CgoJCQkvLyBpZiB0aGUgaGFzaCBpcyBpbmNsdWRlZCBpbiB0aGUgZGF0YSBtYWtlIHN1cmUgdGhlIHNoYXBlCgkJCS8vIGlzIGNvbnNpc3RlbnQgZm9yIGNvbXBhcmlzb24KCQkJaWYgKCBkYXRhLmhhc2ggJiYgZGF0YS5oYXNoLmluZGV4T2YoICIjIiApID09PSAtMSkgewoJCQkJZGF0YS5oYXNoID0gIiMiICsgZGF0YS5oYXNoOwoJCQl9CgoJCQlkYXRhLnVybCA9IHVybDsKCQkJdGhpcy5zdGFjay5wdXNoKCBkYXRhICk7CgkJCXRoaXMuYWN0aXZlSW5kZXggPSB0aGlzLnN0YWNrLmxlbmd0aCAtIDE7CgkJfSwKCgkJLy93aXBlIHVybHMgYWhlYWQgb2YgYWN0aXZlIGluZGV4CgkJY2xlYXJGb3J3YXJkOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5zdGFjayA9IHRoaXMuc3RhY2suc2xpY2UoIDAsIHRoaXMuYWN0aXZlSW5kZXggKyAxICk7CgkJfSwKCgkJZmluZDogZnVuY3Rpb24oIHVybCwgc3RhY2ssIGVhcmx5UmV0dXJuICkgewoJCQlzdGFjayA9IHN0YWNrIHx8IHRoaXMuc3RhY2s7CgoJCQl2YXIgZW50cnksIGksIGxlbmd0aCA9IHN0YWNrLmxlbmd0aCwgaW5kZXg7CgoJCQlmb3IgKCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQkJZW50cnkgPSBzdGFja1tpXTsKCgkJCQlpZiAoIGRlY29kZVVSSUNvbXBvbmVudCh1cmwpID09PSBkZWNvZGVVUklDb21wb25lbnQoZW50cnkudXJsKSB8fAoJCQkJCWRlY29kZVVSSUNvbXBvbmVudCh1cmwpID09PSBkZWNvZGVVUklDb21wb25lbnQoZW50cnkuaGFzaCkgKSB7CgkJCQkJaW5kZXggPSBpOwoKCQkJCQlpZiAoIGVhcmx5UmV0dXJuICkgewoJCQkJCQlyZXR1cm4gaW5kZXg7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gaW5kZXg7CgkJfSwKCgkJY2xvc2VzdDogZnVuY3Rpb24oIHVybCApIHsKCQkJdmFyIGNsb3Nlc3QsIGEgPSB0aGlzLmFjdGl2ZUluZGV4OwoKCQkJLy8gRmlyc3QsIHRha2UgdGhlIHNsaWNlIG9mIHRoZSBoaXN0b3J5IHN0YWNrIGJlZm9yZSB0aGUgY3VycmVudCBpbmRleCBhbmQgc2VhcmNoCgkJCS8vIGZvciBhIHVybCBtYXRjaC4gSWYgb25lIGlzIGZvdW5kLCB3ZSdsbCBhdm9pZCBhdm9pZCBsb29raW5nIHRocm91Z2ggZm9yd2FyZCBoaXN0b3J5CgkJCS8vIE5PVEUgdGhlIHByZWZlcmVuY2UgZm9yIGJhY2t3YXJkIGhpc3RvcnkgbW92ZW1lbnQgaXMgZHJpdmVuIGJ5IHRoZSBmYWN0IHRoYXQKCQkJLy8gICAgICBtb3N0IG1vYmlsZSBicm93c2VycyBvbmx5IGhhdmUgYSBkZWRpY2F0ZWQgYmFjayBidXR0b24sIGFuZCB1c2VycyByYXJlbHkgdXNlCgkJCS8vICAgICAgdGhlIGZvcndhcmQgYnV0dG9uIGluIGRlc2t0b3AgYnJvd3NlciBhbnlob3cKCQkJY2xvc2VzdCA9IHRoaXMuZmluZCggdXJsLCB0aGlzLnN0YWNrLnNsaWNlKDAsIGEpICk7CgoJCQkvLyBJZiBub3RoaW5nIHdhcyBmb3VuZCBpbiBiYWNrd2FyZCBoaXN0b3J5IGNoZWNrIGZvcndhcmQuIFRoZSBgdHJ1ZWAKCQkJLy8gdmFsdWUgcGFzc2VkIGFzIHRoZSB0aGlyZCBwYXJhbWV0ZXIgY2F1c2VzIHRoZSBmaW5kIG1ldGhvZCB0byBicmVhawoJCQkvLyBvbiB0aGUgZmlyc3QgbWF0Y2ggaW4gdGhlIGZvcndhcmQgaGlzdG9yeSBzbGljZS4gVGhlIHN0YXJ0aW5nIGluZGV4CgkJCS8vIG9mIHRoZSBzbGljZSBtdXN0IHRoZW4gYmUgYWRkZWQgdG8gdGhlIHJlc3VsdCB0byBnZXQgdGhlIGVsZW1lbnQgaW5kZXgKCQkJLy8gaW4gdGhlIG9yaWdpbmFsIGhpc3Rvcnkgc3RhY2sgOiggOigKCQkJLy8KCQkJLy8gVE9ETyB0aGlzIGlzIGh5cGVyIGNvbmZ1c2luZyBhbmQgc2hvdWxkIGJlIGNsZWFuZWQgdXAgKHVnaCBzbyBiYWQpCgkJCWlmICggY2xvc2VzdCA9PT0gdW5kZWZpbmVkICkgewoJCQkJY2xvc2VzdCA9IHRoaXMuZmluZCggdXJsLCB0aGlzLnN0YWNrLnNsaWNlKGEpLCB0cnVlICk7CgkJCQljbG9zZXN0ID0gY2xvc2VzdCA9PT0gdW5kZWZpbmVkID8gY2xvc2VzdCA6IGNsb3Nlc3QgKyBhOwoJCQl9CgoJCQlyZXR1cm4gY2xvc2VzdDsKCQl9LAoKCQlkaXJlY3Q6IGZ1bmN0aW9uKCBvcHRzICkgewoJCQl2YXIgbmV3QWN0aXZlSW5kZXggPSB0aGlzLmNsb3Nlc3QoIG9wdHMudXJsICksIGEgPSB0aGlzLmFjdGl2ZUluZGV4OwoKCQkJLy8gc2F2ZSBuZXcgcGFnZSBpbmRleCwgbnVsbCBjaGVjayB0byBwcmV2ZW50IGZhbHNleSAwIHJlc3VsdAoJCQkvLyByZWNvcmQgdGhlIHByZXZpb3VzIGluZGV4IGZvciByZWZlcmVuY2UKCQkJaWYgKCBuZXdBY3RpdmVJbmRleCAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5hY3RpdmVJbmRleCA9IG5ld0FjdGl2ZUluZGV4OwoJCQkJdGhpcy5wcmV2aW91c0luZGV4ID0gYTsKCQkJfQoKCQkJLy8gaW52b2tlIGNhbGxiYWNrcyB3aGVyZSBhcHByb3ByaWF0ZQoJCQkvLwoJCQkvLyBUT0RPIHRoaXMgaXMgYWxzbyBjb252b2x1dGVkIGFuZCBjb25mdXNpbmcKCQkJaWYgKCBuZXdBY3RpdmVJbmRleCA8IGEgKSB7CgkJCQkoIG9wdHMucHJlc2VudCB8fCBvcHRzLmJhY2sgfHwgJC5ub29wICkoIHRoaXMuZ2V0QWN0aXZlKCksICJiYWNrIiApOwoJCQl9IGVsc2UgaWYgKCBuZXdBY3RpdmVJbmRleCA+IGEgKSB7CgkJCQkoIG9wdHMucHJlc2VudCB8fCBvcHRzLmZvcndhcmQgfHwgJC5ub29wICkoIHRoaXMuZ2V0QWN0aXZlKCksICJmb3J3YXJkIiApOwoJCQl9IGVsc2UgaWYgKCBuZXdBY3RpdmVJbmRleCA9PT0gdW5kZWZpbmVkICYmIG9wdHMubWlzc2luZyApewoJCQkJb3B0cy5taXNzaW5nKCB0aGlzLmdldEFjdGl2ZSgpICk7CgkJCX0KCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyIHBhdGggPSAkLm1vYmlsZS5wYXRoLAoJCWluaXRpYWxIcmVmID0gbG9jYXRpb24uaHJlZjsKCgkkLm1vYmlsZS5OYXZpZ2F0b3IgPSBmdW5jdGlvbiggaGlzdG9yeSApIHsKCQl0aGlzLmhpc3RvcnkgPSBoaXN0b3J5OwoJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgPSB0cnVlOwoKCQkkLm1vYmlsZS53aW5kb3cuYmluZCh7CgkJCSJwb3BzdGF0ZS5oaXN0b3J5IjogJC5wcm94eSggdGhpcy5wb3BzdGF0ZSwgdGhpcyApLAoJCQkiaGFzaGNoYW5nZS5oaXN0b3J5IjogJC5wcm94eSggdGhpcy5oYXNoY2hhbmdlLCB0aGlzICkKCQl9KTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuTmF2aWdhdG9yLnByb3RvdHlwZSwgewoJCXNxdWFzaDogZnVuY3Rpb24oIHVybCwgZGF0YSApIHsKCQkJdmFyIHN0YXRlLCBocmVmLCBoYXNoID0gcGF0aC5pc1BhdGgodXJsKSA/IHBhdGguc3RyaXBIYXNoKHVybCkgOiB1cmw7CgoJCQlocmVmID0gcGF0aC5zcXVhc2goIHVybCApOwoKCQkJLy8gbWFrZSBzdXJlIHRvIHByb3ZpZGUgdGhpcyBpbmZvcm1hdGlvbiB3aGVuIGl0IGlzbid0IGV4cGxpY2l0bHkgc2V0IGluIHRoZQoJCQkvLyBkYXRhIG9iamVjdCB0aGF0IHdhcyBwYXNzZWQgdG8gdGhlIHNxdWFzaCBtZXRob2QKCQkJc3RhdGUgPSAkLmV4dGVuZCh7CgkJCQloYXNoOiBoYXNoLAoJCQkJdXJsOiBocmVmCgkJCX0sIGRhdGEpOwoKCQkJLy8gcmVwbGFjZSB0aGUgY3VycmVudCB1cmwgd2l0aCB0aGUgbmV3IGhyZWYgYW5kIHN0b3JlIHRoZSBzdGF0ZQoJCQkvLyBOb3RlIHRoYXQgaW4gc29tZSBjYXNlcyB3ZSBtaWdodCBiZSByZXBsYWNpbmcgYW4gdXJsIHdpdGggdGhlCgkJCS8vIHNhbWUgdXJsLiBXZSBkbyB0aGlzIGFueXdheXMgYmVjYXVzZSB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGF0CgkJCS8vIGFsbCBvZiBvdXIgaGlzdG9yeSBlbnRyaWVzIGhhdmUgYSBzdGF0ZSBvYmplY3QgYXNzb2NpYXRlZCB3aXRoCgkJCS8vIHRoZW0uIFRoaXMgYWxsb3dzIHVzIHRvIHdvcmsgYXJvdW5kIHRoZSBjYXNlIHdoZXJlICQubW9iaWxlLmJhY2soKQoJCQkvLyBpcyBjYWxsZWQgdG8gdHJhbnNpdGlvbiBmcm9tIGFuIGV4dGVybmFsIHBhZ2UgdG8gYW4gZW1iZWRkZWQgcGFnZS4KCQkJLy8gSW4gdGhhdCBwYXJ0aWN1bGFyIGNhc2UsIGEgaGFzaGNoYW5nZSBldmVudCBpcyAqTk9UKiBnZW5lcmF0ZWQgYnkgdGhlIGJyb3dzZXIuCgkJCS8vIEVuc3VyaW5nIGVhY2ggaGlzdG9yeSBlbnRyeSBoYXMgYSBzdGF0ZSBvYmplY3QgbWVhbnMgdGhhdCBvblBvcFN0YXRlKCkKCQkJLy8gd2lsbCBhbHdheXMgdHJpZ2dlciBvdXIgaGFzaGNoYW5nZSBjYWxsYmFjayBldmVuIHdoZW4gYSBoYXNoY2hhbmdlIGV2ZW50CgkJCS8vIGlzIG5vdCBmaXJlZC4KCQkJd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKCBzdGF0ZSwgc3RhdGUudGl0bGUgfHwgZG9jdW1lbnQudGl0bGUsIGhyZWYgKTsKCgkJCXJldHVybiBzdGF0ZTsKCQl9LAoKCQloYXNoOiBmdW5jdGlvbiggdXJsLCBocmVmICkgewoJCQl2YXIgcGFyc2VkLCBsb2MsIGhhc2gsIHJlc29sdmVkOwoKCQkJLy8gR3JhYiB0aGUgaGFzaCBmb3IgcmVjb3JkaW5nLiBJZiB0aGUgcGFzc2VkIHVybCBpcyBhIHBhdGgKCQkJLy8gd2UgdXNlZCB0aGUgcGFyc2VkIHZlcnNpb24gb2YgdGhlIHNxdWFzaGVkIHVybCB0byByZWNvbnN0cnVjdCwKCQkJLy8gb3RoZXJ3aXNlIHdlIGFzc3VtZSBpdCdzIGEgaGFzaCBhbmQgc3RvcmUgaXQgZGlyZWN0bHkKCQkJcGFyc2VkID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgkJCWxvYyA9IHBhdGgucGFyc2VMb2NhdGlvbigpOwoKCQkJaWYgKCBsb2MucGF0aG5hbWUgKyBsb2Muc2VhcmNoID09PSBwYXJzZWQucGF0aG5hbWUgKyBwYXJzZWQuc2VhcmNoICkgewoJCQkJLy8gSWYgdGhlIHBhdGhuYW1lIGFuZCBzZWFyY2ggb2YgdGhlIHBhc3NlZCB1cmwgaXMgaWRlbnRpY2FsIHRvIHRoZSBjdXJyZW50IGxvYwoJCQkJLy8gdGhlbiB3ZSBtdXN0IHVzZSB0aGUgaGFzaC4gT3RoZXJ3aXNlIHRoZXJlIHdpbGwgYmUgbm8gZXZlbnQKCQkJCS8vIGVnLCB1cmwgPSAiL2Zvby9iYXI/YmF6I2JhbmciLCBsb2NhdGlvbi5ocmVmID0gImh0dHA6Ly9leGFtcGxlLmNvbS9mb28vYmFyP2JheiIKCQkJCWhhc2ggPSBwYXJzZWQuaGFzaCA/IHBhcnNlZC5oYXNoIDogcGFyc2VkLnBhdGhuYW1lICsgcGFyc2VkLnNlYXJjaDsKCQkJfSBlbHNlIGlmICggcGF0aC5pc1BhdGgodXJsKSApIHsKCQkJCXJlc29sdmVkID0gcGF0aC5wYXJzZVVybCggaHJlZiApOwoJCQkJLy8gSWYgdGhlIHBhc3NlZCB1cmwgaXMgYSBwYXRoLCBtYWtlIGl0IGRvbWFpbiByZWxhdGl2ZSBhbmQgcmVtb3ZlIGFueSB0cmFpbGluZyBoYXNoCgkJCQloYXNoID0gcmVzb2x2ZWQucGF0aG5hbWUgKyByZXNvbHZlZC5zZWFyY2ggKyAocGF0aC5pc1ByZXNlcnZhYmxlSGFzaCggcmVzb2x2ZWQuaGFzaCApPyByZXNvbHZlZC5oYXNoLnJlcGxhY2UoICIjIiwgIiIgKSA6ICIiKTsKCQkJfSBlbHNlIHsKCQkJCWhhc2ggPSB1cmw7CgkJCX0KCgkJCXJldHVybiBoYXNoOwoJCX0sCgoJCS8vIFRPRE8gcmVjb25zaWRlciBuYW1lCgkJZ286IGZ1bmN0aW9uKCB1cmwsIGRhdGEsIG5vRXZlbnRzICkgewoJCQl2YXIgc3RhdGUsIGhyZWYsIGhhc2gsIHBvcHN0YXRlRXZlbnQsCgkJCQlpc1BvcFN0YXRlRXZlbnQgPSAkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCk7CgoJCQkvLyBHZXQgdGhlIHVybCBhcyBpdCB3b3VsZCBsb29rIHNxdWFzaGVkIG9uIHRvIHRoZSBjdXJyZW50IHJlc29sdXRpb24gdXJsCgkJCWhyZWYgPSBwYXRoLnNxdWFzaCggdXJsICk7CgoJCQkvLyBzb3J0IG91dCB3aGF0IHRoZSBoYXNoIHNvdWxkIGJlIGZyb20gdGhlIHVybAoJCQloYXNoID0gdGhpcy5oYXNoKCB1cmwsIGhyZWYgKTsKCgkJCS8vIEhlcmUgd2UgcHJldmVudCB0aGUgbmV4dCBoYXNoIGNoYW5nZSBvciBwb3BzdGF0ZSBldmVudCBmcm9tIGRvaW5nIGFueQoJCQkvLyBoaXN0b3J5IG1hbmFnZW1lbnQuIEluIHRoZSBjYXNlIG9mIGhhc2hjaGFuZ2Ugd2UgZG9uJ3Qgc3dhbGxvdyBpdAoJCQkvLyBpZiB0aGVyZSB3aWxsIGJlIG5vIGhhc2hjaGFuZ2UgZmlyZWQgKHNpbmNlIHRoYXQgd29uJ3QgcmVzZXQgdGhlIHZhbHVlKQoJCQkvLyBhbmQgd2lsbCBzd2FsbG93IHRoZSBmb2xsb3dpbmcgaGFzaGNoYW5nZQoJCQlpZiAoIG5vRXZlbnRzICYmIGhhc2ggIT09IHBhdGguc3RyaXBIYXNoKHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gpICkgewoJCQkJdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgPSBub0V2ZW50czsKCQkJfQoKCQkJLy8gSU1QT1JUQU5UIGluIHRoZSBjYXNlIHdoZXJlIHBvcHN0YXRlIGlzIHN1cHBvcnRlZCB0aGUgZXZlbnQgd2lsbCBiZSB0cmlnZ2VyZWQKCQkJLy8gICAgICBkaXJlY3RseSwgc3RvcHBpbmcgZnVydGhlciBleGVjdXRpb24gLSBpZSwgaW50ZXJ1cHRpbmcgdGhlIGZsb3cgb2YgdGhpcwoJCQkvLyAgICAgIG1ldGhvZCBjYWxsIHRvIGZpcmUgYmluZGluZ3MgYXQgdGhpcyBleHByZXNzaW9uLiBCZWxvdyB0aGUgbmF2aWdhdGUgbWV0aG9kCgkJCS8vICAgICAgdGhlcmUgaXMgYSBiaW5kaW5nIHRvIGNhdGNoIHRoaXMgZXZlbnQgYW5kIHN0b3AgaXRzIHByb3BhZ2F0aW9uLgoJCQkvLwoJCQkvLyAgICAgIFdlIHRoZW4gdHJpZ2dlciBhIG5ldyBwb3BzdGF0ZSBldmVudCBvbiB0aGUgd2luZG93IHdpdGggYSBudWxsIHN0YXRlCgkJCS8vICAgICAgc28gdGhhdCB0aGUgbmF2aWdhdGUgZXZlbnRzIGNhbiBjb25jbHVkZSB0aGVpciB3b3JrIHByb3Blcmx5CgkJCS8vCgkJCS8vIGlmIHRoZSB1cmwgaXMgYSBwYXRoIHdlIHdhbnQgdG8gcHJlc2VydmUgdGhlIHF1ZXJ5IHBhcmFtcyB0aGF0IGFyZSBhdmFpbGFibGUgb24KCQkJLy8gdGhlIGN1cnJlbnQgdXJsLgoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSB0cnVlOwoJCQl3aW5kb3cubG9jYXRpb24uaGFzaCA9IGhhc2g7CgoJCQkvLyBJZiBwb3BzdGF0ZSBpcyBlbmFibGVkIGFuZCB0aGUgYnJvd3NlciB0cmlnZ2VycyBgcG9wc3RhdGVgIGV2ZW50cyB3aGVuIHRoZSBoYXNoCgkJCS8vIGlzIHNldCAodGhpcyBvZnRlbiBoYXBwZW5zIGltbWVkaWF0ZWx5IGluIGJyb3dzZXJzIGxpa2UgQ2hyb21lKSwgdGhlbiB0aGUKCQkJLy8gdGhpcyBmbGFnIHdpbGwgYmUgc2V0IHRvIGZhbHNlIGFscmVhZHkuIElmIGl0J3MgYSBicm93c2VyIHRoYXQgZG9lcyBub3QgdHJpZ2dlcgoJCQkvLyBhIGBwb3BzdGF0ZWAgb24gaGFzaCBhc3NpZ25lbWVudCBvciBgcmVwbGFjZVN0YXRlYCB0aGVuIHdlIG5lZWQgYXZvaWQgdGhlIGJyYW5jaAoJCQkvLyB0aGF0IHN3YWxsb3dzIHRoZSBldmVudCBjcmVhdGVkIGJ5IHRoZSBwb3BzdGF0ZSBnZW5lcmF0ZWQgYnkgdGhlIGhhc2ggYXNzaWdubWVudAoJCQkvLyBBdCB0aGUgdGltZSBvZiB0aGlzIHdyaXRpbmcgdGhpcyBoYXBwZW5zIHdpdGggT3BlcmEgMTIgYW5kIHNvbWUgdmVyc2lvbiBvZiBJRQoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCgkJCXN0YXRlID0gJC5leHRlbmQoewoJCQkJdXJsOiBocmVmLAoJCQkJaGFzaDogaGFzaCwKCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZQoJCQl9LCBkYXRhKTsKCgkJCWlmICggaXNQb3BTdGF0ZUV2ZW50ICkgewoJCQkJcG9wc3RhdGVFdmVudCA9IG5ldyAkLkV2ZW50KCAicG9wc3RhdGUiICk7CgkJCQlwb3BzdGF0ZUV2ZW50Lm9yaWdpbmFsRXZlbnQgPSB7CgkJCQkJdHlwZTogInBvcHN0YXRlIiwKCQkJCQlzdGF0ZTogbnVsbAoJCQkJfTsKCgkJCQl0aGlzLnNxdWFzaCggdXJsLCBzdGF0ZSApOwoKCQkJCS8vIFRyaWdnZXIgYSBuZXcgZmF1eCBwb3BzdGF0ZSBldmVudCB0byByZXBsYWNlIHRoZSBvbmUgdGhhdCB3ZQoJCQkJLy8gY2F1Z2h0IHRoYXQgd2FzIHRyaWdnZXJlZCBieSB0aGUgaGFzaCBzZXR0aW5nIGFib3ZlLgoJCQkJaWYgKCAhbm9FdmVudHMgKSB7CgkJCQkJdGhpcy5pZ25vcmVQb3BTdGF0ZSA9IHRydWU7CgkJCQkJJC5tb2JpbGUud2luZG93LnRyaWdnZXIoIHBvcHN0YXRlRXZlbnQgKTsKCQkJCX0KCQkJfQoKCQkJLy8gcmVjb3JkIHRoZSBoaXN0b3J5IGVudHJ5IHNvIHRoYXQgdGhlIGluZm9ybWF0aW9uIGNhbiBiZSBpbmNsdWRlZAoJCQkvLyBpbiBoYXNoY2hhbmdlIGV2ZW50IGRyaXZlbiBuYXZpZ2F0ZSBldmVudHMgaW4gYSBzaW1pbGFyIGZhc2hpb24gdG8KCQkJLy8gdGhlIHN0YXRlIHRoYXQncyBwcm92aWRlZCBieSBwb3BzdGF0ZQoJCQl0aGlzLmhpc3RvcnkuYWRkKCBzdGF0ZS51cmwsIHN0YXRlICk7CgkJfSwKCgoJCS8vIFRoaXMgYmluZGluZyBpcyBpbnRlbmRlZCB0byBjYXRjaCB0aGUgcG9wc3RhdGUgZXZlbnRzIHRoYXQgYXJlIGZpcmVkCgkJLy8gd2hlbiBleGVjdXRpb24gb2YgdGhlIGAkLm5hdmlnYXRlYCBtZXRob2Qgc3RvcHMgYXQgd2luZG93LmxvY2F0aW9uLmhhc2ggPSB1cmw7CgkJLy8gYW5kIGNvbXBsZXRlbHkgcHJldmVudCB0aGVtIGZyb20gcHJvcGFnYXRpbmcuIFRoZSBwb3BzdGF0ZSBldmVudCB3aWxsIHRoZW4gYmUKCQkvLyByZXRyaWdnZXJlZCBhZnRlciBleGVjdXRpb24gcmVzdW1lcwoJCS8vCgkJLy8gVE9ETyBncmFiIHRoZSBvcmlnaW5hbCBldmVudCBoZXJlIGFuZCB1c2UgaXQgZm9yIHRoZSBzeW50aGV0aWMgZXZlbnQgaW4gdGhlCgkJLy8gICAgICBzZWNvbmQgaGFsZiBvZiB0aGUgbmF2aWdhdGUgZXhlY3V0aW9uIHRoYXQgd2lsbCBmb2xsb3cgdGhpcyBiaW5kaW5nCgkJcG9wc3RhdGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGhhc2gsIHN0YXRlOwoKCQkJLy8gUGFydGx5IHRvIHN1cHBvcnQgb3VyIHRlc3Qgc3VpdGUgd2hpY2ggbWFudWFsbHkgYWx0ZXJzIHRoZSBzdXBwb3J0CgkJCS8vIHZhbHVlIHRvIHRlc3QgaGFzaGNoYW5nZS4gUGFydGx5IHRvIHByZXZlbnQgYWxsIGFyb3VuZCB3ZWlyZG5lc3MKCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICl7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIHRoaXMgaXMgdGhlIHBvcHN0YXRlIHRyaWdnZXJlZCBieSB0aGUgYWN0dWFsIGFsdGVyYXRpb24gb2YgdGhlIGhhc2gKCQkJLy8gcHJldmVudCBpdCBjb21wbGV0ZWx5LiBIaXN0b3J5IGlzIHRyYWNrZWQgbWFudWFsbHkKCQkJaWYgKCB0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgKSB7CgkJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBpZiB0aGlzIGlzIHRoZSBwb3BzdGF0ZSB0cmlnZ2VyZWQgYWZ0ZXIgdGhlIGByZXBsYWNlU3RhdGVgIGNhbGwgaW4gdGhlIGdvCgkJCS8vIG1ldGhvZCwgdGhlbiBzaW1wbHkgaWdub3JlIGl0LiBUaGUgaGlzdG9yeSBlbnRyeSBoYXMgYWxyZWFkeSBiZWVuIGNhcHR1cmVkCgkJCWlmICggdGhpcy5pZ25vcmVQb3BTdGF0ZSApIHsKCQkJCXRoaXMuaWdub3JlUG9wU3RhdGUgPSBmYWxzZTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gc3RhdGUsIGFuZCB0aGUgaGlzdG9yeSBzdGFjayBsZW5ndGggaXMgb25lIHdlcmUKCQkJLy8gcHJvYmFibHkgZ2V0dGluZyB0aGUgcGFnZSBsb2FkIHBvcHN0YXRlIGZpcmVkIGJ5IGJyb3dzZXJzIGxpa2UgY2hyb21lCgkJCS8vIGF2b2lkIGl0IGFuZCBzZXQgdGhlIG9uZSB0aW1lIGZsYWcgdG8gZmFsc2UuCgkJCS8vIFRPRE86IERvIHdlIHJlYWxseSBuZWVkIGFsbCB0aGVzZSBjb25kaXRpb25zPyBDb21wYXJpbmcgbG9jYXRpb24gaHJlZnMKCQkJLy8gc2hvdWxkIGJlIHN1ZmZpY2llbnQuCgkJCWlmICggIWV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgJiYKCQkJCXRoaXMuaGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDEgJiYKCQkJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgKSB7CgkJCQl0aGlzLmlnbm9yZUluaXRpYWxIYXNoQ2hhbmdlID0gZmFsc2U7CgoJCQkJaWYgKCBsb2NhdGlvbi5ocmVmID09PSBpbml0aWFsSHJlZiApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJLy8gYWNjb3VudCBmb3IgZGlyZWN0IG1hbmlwdWxhdGlvbiBvZiB0aGUgaGFzaC4gVGhhdCBpcywgd2Ugd2lsbCByZWNlaXZlIGEgcG9wc3RhdGUKCQkJLy8gd2hlbiB0aGUgaGFzaCBpcyBjaGFuZ2VkIGJ5IGFzc2lnbm1lbnQsIGFuZCBpdCB3b24ndCBoYXZlIGEgc3RhdGUgYXNzb2NpYXRlZC4gV2UKCQkJLy8gdGhlbiBuZWVkIHRvIHNxdWFzaCB0aGUgaGFzaC4gU2VlIGJlbG93IGZvciBoYW5kbGluZyBvZiBoYXNoIGFzc2lnbm1lbnQgdGhhdAoJCQkvLyBtYXRjaGVzIGFuIGV4aXN0aW5nIGhpc3RvcnkgZW50cnkKCQkJLy8gVE9ETyBpdCBtaWdodCBiZSBiZXR0ZXIgdG8gb25seSBhZGQgdG8gdGhlIGhpc3Rvcnkgc3RhY2sKCQkJLy8gICAgICB3aGVuIHRoZSBoYXNoIGlzIGFkamFjZW50IHRvIHRoZSBhY3RpdmUgaGlzdG9yeSBlbnRyeQoJCQloYXNoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQkJaWYgKCAhZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSAmJiBoYXNoICkgewoJCQkJLy8gc3F1YXNoIHRoZSBoYXNoIHRoYXQncyBiZWVuIGFzc2lnbmVkIG9uIHRoZSBVUkwgd2l0aCByZXBsYWNlU3RhdGUKCQkJCS8vIGFsc28gZ3JhYiB0aGUgcmVzdWx0aW5nIHN0YXRlIG9iamVjdCBmb3Igc3RvcmFnZQoJCQkJc3RhdGUgPSB0aGlzLnNxdWFzaCggaGFzaCApOwoKCQkJCS8vIHJlY29yZCB0aGUgbmV3IGhhc2ggYXMgYW4gYWRkaXRpb25hbCBoaXN0b3J5IGVudHJ5CgkJCQkvLyB0byBtYXRjaCB0aGUgYnJvd3NlcidzIHRyZWF0bWVudCBvZiBoYXNoIGFzc2lnbm1lbnQKCQkJCXRoaXMuaGlzdG9yeS5hZGQoIHN0YXRlLnVybCwgc3RhdGUgKTsKCgkJCQkvLyBwYXNzIHRoZSBuZXdseSBjcmVhdGVkIHN0YXRlIGluZm9ybWF0aW9uCgkJCQkvLyBhbG9uZyB3aXRoIHRoZSBldmVudAoJCQkJZXZlbnQuaGlzdG9yeVN0YXRlID0gc3RhdGU7CgoJCQkJLy8gZG8gbm90IGFsdGVyIGhpc3RvcnksIHdlJ3ZlIGFkZGVkIGEgbmV3IGhpc3RvcnkgZW50cnkKCQkJCS8vIHNvIHdlIGtub3cgd2hlcmUgd2UgYXJlCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIGFsbCBlbHNlIGZhaWxzIHRoaXMgaXMgYSBwb3BzdGF0ZSB0aGF0IGNvbWVzIGZyb20gdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b25zCgkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHN0YXRlIG9mIG91ciBoaXN0b3J5IHN0YWNrIHByb3Blcmx5LCBhbmQgcmVjb3JkIHRoZSBkaXJlY3Rpb25hbGl0eQoJCQl0aGlzLmhpc3RvcnkuZGlyZWN0KHsKCQkJCXVybDogKGV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgfHwge30pLnVybCB8fCBoYXNoLAoKCQkJCS8vIFdoZW4gdGhlIHVybCBpcyBlaXRoZXIgZm9yd2FyZCBvciBiYWNrd2FyZCBpbiBoaXN0b3J5IGluY2x1ZGUgdGhlIGVudHJ5CgkJCQkvLyBhcyBkYXRhIG9uIHRoZSBldmVudCBvYmplY3QgZm9yIG1lcmdpbmcgYXMgZGF0YSBpbiB0aGUgbmF2aWdhdGUgZXZlbnQKCQkJCXByZXNlbnQ6IGZ1bmN0aW9uKCBoaXN0b3J5RW50cnksIGRpcmVjdGlvbiApIHsKCQkJCQkvLyBtYWtlIHN1cmUgdG8gY3JlYXRlIGEgbmV3IG9iamVjdCB0byBwYXNzIGRvd24gYXMgdGhlIG5hdmlnYXRlIGV2ZW50IGRhdGEKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUgPSAkLmV4dGVuZCh7fSwgaGlzdG9yeUVudHJ5KTsKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUuZGlyZWN0aW9uID0gZGlyZWN0aW9uOwoJCQkJfQoJCQl9KTsKCQl9LAoKCQkvLyBOT1RFIG11c3QgYmluZCBiZWZvcmUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50IGhhc2hjaGFuZ2UgYmluZGluZyBvdGhlcndpc2UgdGhlCgkJLy8gICAgICBuYXZpZ2F0aW9uIGRhdGEgd29uJ3QgYmUgYXR0YWNoZWQgdG8gdGhlIGhhc2hjaGFuZ2UgZXZlbnQgaW4gdGltZSBmb3IgdGhvc2UKCQkvLyAgICAgIGJpbmRpbmdzIHRvIGF0dGFjaCBpdCB0byB0aGUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50CgkJLy8gVE9ETyBhZGQgYSBjaGVjayBoZXJlIHRoYXQgYGhhc2hjaGFuZ2UubmF2aWdhdGVgIGlzIGJvdW5kIGFscmVhZHkgb3RoZXJ3aXNlIGl0J3MKCQkvLyAgICAgIGJyb2tlbiAoZXhjZXB0aW9uPykKCQloYXNoY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBoaXN0b3J5LCBoYXNoOwoKCQkJLy8gSWYgaGFzaGNoYW5nZSBsaXN0ZW5pbmcgaXMgZXhwbGljaXRseSBkaXNhYmxlZCBvciBwdXNoc3RhdGUgaXMgc3VwcG9ydGVkCgkJCS8vIGF2b2lkIG1ha2luZyB1c2Ugb2YgdGhlIGhhc2hjaGFuZ2UgaGFuZGxlci4KCQkJaWYgKCEkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpIHx8CgkJCQkkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIE9uIG9jY2FzaW9uIGV4cGxpY2l0bHkgd2FudCB0byBwcmV2ZW50IHRoZSBuZXh0IGhhc2ggZnJvbSBwcm9wb2dhdGluZyBiZWNhdXNlIHdlIG9ubHkKCQkJLy8gd2l0aCB0byBhbHRlciB0aGUgdXJsIHRvIHJlcHJlc2VudCB0aGUgbmV3IHN0YXRlIGRvIHNvIGhlcmUKCQkJaWYgKCB0aGlzLnByZXZlbnROZXh0SGFzaENoYW5nZSApewoJCQkJdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgPSBmYWxzZTsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQloaXN0b3J5ID0gdGhpcy5oaXN0b3J5OwoJCQloYXNoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCgkJCS8vIElmIHRoaXMgaXMgYSBoYXNoY2hhbmdlIGNhdXNlZCBieSB0aGUgYmFjayBvciBmb3J3YXJkIGJ1dHRvbgoJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSBzdGF0ZSBvZiBvdXIgaGlzdG9yeSBzdGFjayBwcm9wZXJseQoJCQl0aGlzLmhpc3RvcnkuZGlyZWN0KHsKCQkJCXVybDogaGFzaCwKCgkJCQkvLyBXaGVuIHRoZSB1cmwgaXMgZWl0aGVyIGZvcndhcmQgb3IgYmFja3dhcmQgaW4gaGlzdG9yeSBpbmNsdWRlIHRoZSBlbnRyeQoJCQkJLy8gYXMgZGF0YSBvbiB0aGUgZXZlbnQgb2JqZWN0IGZvciBtZXJnaW5nIGFzIGRhdGEgaW4gdGhlIG5hdmlnYXRlIGV2ZW50CgkJCQlwcmVzZW50OiBmdW5jdGlvbiggaGlzdG9yeUVudHJ5LCBkaXJlY3Rpb24gKSB7CgkJCQkJLy8gbWFrZSBzdXJlIHRvIGNyZWF0ZSBhIG5ldyBvYmplY3QgdG8gcGFzcyBkb3duIGFzIHRoZSBuYXZpZ2F0ZSBldmVudCBkYXRhCgkJCQkJZXZlbnQuaGFzaGNoYW5nZVN0YXRlID0gJC5leHRlbmQoe30sIGhpc3RvcnlFbnRyeSk7CgkJCQkJZXZlbnQuaGFzaGNoYW5nZVN0YXRlLmRpcmVjdGlvbiA9IGRpcmVjdGlvbjsKCQkJCX0sCgoJCQkJLy8gV2hlbiB3ZSBkb24ndCBmaW5kIGEgaGFzaCBpbiBvdXIgaGlzdG9yeSBjbGVhcmx5IHdlJ3JlIGFpbWluZyB0byBnbyB0aGVyZQoJCQkJLy8gcmVjb3JkIHRoZSBlbnRyeSBhcyBuZXcgZm9yIGZ1dHVyZSB0cmF2ZXJzYWwKCQkJCS8vCgkJCQkvLyBOT1RFIGl0J3Mgbm90IGVudGlyZWx5IGNsZWFyIHRoYXQgdGhpcyBpcyB0aGUgcmlnaHQgdGhpbmcgdG8gZG8gZ2l2ZW4gdGhhdCB3ZQoJCQkJLy8gICAgICBjYW4ndCBrbm93IHRoZSB1c2VycyBpbnRlbnRpb24uIEl0IG1pZ2h0IGJlIGJldHRlciB0byBleHBsaWNpdGx5IF9ub3RfCgkJCQkvLyAgICAgIHN1cHBvcnQgbG9jYXRpb24uaGFzaCBhc3NpZ25tZW50IGluIHByZWZlcmVuY2UgdG8gJC5uYXZpZ2F0ZSBjYWxscwoJCQkJLy8gVE9ETyBmaXJzdCBhcmcgdG8gYWRkIHNob3VsZCBiZSB0aGUgaHJlZiwgYnV0IGl0IGNhdXNlcyBpc3N1ZXMgaW4gaWRlbnRpZnlpbmcKCQkJCS8vICAgICAgZW1iZWRlZCBwYWdlcwoJCQkJbWlzc2luZzogZnVuY3Rpb24oKSB7CgkJCQkJaGlzdG9yeS5hZGQoIGhhc2gsIHsKCQkJCQkJaGFzaDogaGFzaCwKCQkJCQkJdGl0bGU6IGRvY3VtZW50LnRpdGxlCgkJCQkJfSk7CgkJCQl9CgkJCX0pOwoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJLy8gVE9ETyBjb25zaWRlciBxdWV1ZWluZyBuYXZpZ2F0aW9uIGFjdGl2aXR5IHVudGlsIHByZXZpb3VzIGFjdGl2aXRpZXMgaGF2ZSBjb21wbGV0ZWQKCS8vICAgICAgc28gdGhhdCBlbmQgdXNlcnMgZG9uJ3QgaGF2ZSB0byB0aGluayBhYm91dCBpdC4gUHVudGluZyBmb3Igbm93CgkvLyBUT0RPICEhIG1vdmUgdGhlIGV2ZW50IGJpbmRpbmdzIGludG8gY2FsbGJhY2tzIG9uIHRoZSBuYXZpZ2F0ZSBldmVudAoJJC5tb2JpbGUubmF2aWdhdGUgPSBmdW5jdGlvbiggdXJsLCBkYXRhLCBub0V2ZW50cyApIHsKCQkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3IuZ28oIHVybCwgZGF0YSwgbm9FdmVudHMgKTsKCX07CgoJLy8gZXhwb3NlIHRoZSBoaXN0b3J5IG9uIHRoZSBuYXZpZ2F0ZSBtZXRob2QgaW4gYW50aWNpcGF0aW9uIG9mIGZ1bGwgaW50ZWdyYXRpb24gd2l0aAoJLy8gZXhpc3RpbmcgbmF2aWdhdGlvbiBmdW5jdGlvbmFsdHkgdGhhdCBpcyB0aWdodGx5IGNvdXBsZWQgdG8gdGhlIGhpc3RvcnkgaW5mb3JtYXRpb24KCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkgPSBuZXcgJC5tb2JpbGUuSGlzdG9yeSgpOwoKCS8vIGluc3RhbnRpYXRlIGFuIGluc3RhbmNlIG9mIHRoZSBuYXZpZ2F0b3IgZm9yIHVzZSB3aXRoaW4gdGhlICQubmF2aWdhdGUgbWV0aG9kCgkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3IgPSBuZXcgJC5tb2JpbGUuTmF2aWdhdG9yKCAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5ICk7CgoJdmFyIGxvYyA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpOwoJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hZGQoIGxvYy5ocmVmLCB7aGFzaDogbG9jLmhhc2h9ICk7Cn0pKCBqUXVlcnkgKTsKCgovLyBUaGlzIHBsdWdpbiBpcyBhbiBleHBlcmltZW50IGZvciBhYnN0cmFjdGluZyBhd2F5IHRoZSB0b3VjaCBhbmQgbW91c2UKLy8gZXZlbnRzIHNvIHRoYXQgZGV2ZWxvcGVycyBkb24ndCBoYXZlIHRvIHdvcnJ5IGFib3V0IHdoaWNoIG1ldGhvZCBvZiBpbnB1dAovLyB0aGUgZGV2aWNlIHRoZWlyIGRvY3VtZW50IGlzIGxvYWRlZCBvbiBzdXBwb3J0cy4KLy8KLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBhbGxvdyB0aGUgZGV2ZWxvcGVyIHRvIHJlZ2lzdGVyIGxpc3RlbmVycyBmb3IgdGhlCi8vIGJhc2ljIG1vdXNlIGV2ZW50cywgc3VjaCBhcyBtb3VzZWRvd24sIG1vdXNlbW92ZSwgbW91c2V1cCwgYW5kIGNsaWNrLAovLyBhbmQgdGhlIHBsdWdpbiB3aWxsIHRha2UgY2FyZSBvZiByZWdpc3RlcmluZyB0aGUgY29ycmVjdCBsaXN0ZW5lcnMKLy8gYmVoaW5kIHRoZSBzY2VuZXMgdG8gaW52b2tlIHRoZSBsaXN0ZW5lciBhdCB0aGUgZmFzdGVzdCBwb3NzaWJsZSB0aW1lCi8vIGZvciB0aGF0IGRldmljZSwgd2hpbGUgc3RpbGwgcmV0YWluaW5nIHRoZSBvcmRlciBvZiBldmVudCBmaXJpbmcgaW4KLy8gdGhlIHRyYWRpdGlvbmFsIG1vdXNlIGVudmlyb25tZW50LCBzaG91bGQgbXVsdGlwbGUgaGFuZGxlcnMgYmUgcmVnaXN0ZXJlZAovLyBvbiB0aGUgc2FtZSBlbGVtZW50IGZvciBkaWZmZXJlbnQgZXZlbnRzLgovLwovLyBUaGUgY3VycmVudCB2ZXJzaW9uIGV4cG9zZXMgdGhlIGZvbGxvd2luZyB2aXJ0dWFsIGV2ZW50cyB0byBqUXVlcnkgYmluZCBtZXRob2RzOgovLyAidm1vdXNlb3ZlciB2bW91c2Vkb3duIHZtb3VzZW1vdmUgdm1vdXNldXAgdmNsaWNrIHZtb3VzZW91dCB2bW91c2VjYW5jZWwiCgooZnVuY3Rpb24oICQsIHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCApIHsKCnZhciBkYXRhUHJvcGVydHlOYW1lID0gInZpcnR1YWxNb3VzZUJpbmRpbmdzIiwKCXRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lID0gInZpcnR1YWxUb3VjaElEIiwKCXZpcnR1YWxFdmVudE5hbWVzID0gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIi5zcGxpdCggIiAiICksCgl0b3VjaEV2ZW50UHJvcHMgPSAiY2xpZW50WCBjbGllbnRZIHBhZ2VYIHBhZ2VZIHNjcmVlblggc2NyZWVuWSIuc3BsaXQoICIgIiApLAoJbW91c2VIb29rUHJvcHMgPSAkLmV2ZW50Lm1vdXNlSG9va3MgPyAkLmV2ZW50Lm1vdXNlSG9va3MucHJvcHMgOiBbXSwKCW1vdXNlRXZlbnRQcm9wcyA9ICQuZXZlbnQucHJvcHMuY29uY2F0KCBtb3VzZUhvb2tQcm9wcyApLAoJYWN0aXZlRG9jSGFuZGxlcnMgPSB7fSwKCXJlc2V0VGltZXJJRCA9IDAsCglzdGFydFggPSAwLAoJc3RhcnRZID0gMCwKCWRpZFNjcm9sbCA9IGZhbHNlLAoJY2xpY2tCbG9ja0xpc3QgPSBbXSwKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlLAoJYmxvY2tUb3VjaFRyaWdnZXJzID0gZmFsc2UsCglldmVudENhcHR1cmVTdXBwb3J0ZWQgPSAiYWRkRXZlbnRMaXN0ZW5lciIgaW4gZG9jdW1lbnQsCgkkZG9jdW1lbnQgPSAkKCBkb2N1bWVudCApLAoJbmV4dFRvdWNoSUQgPSAxLAoJbGFzdFRvdWNoSUQgPSAwLCB0aHJlc2hvbGQsCglpOwoKJC52bW91c2UgPSB7Cgltb3ZlRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJY2xpY2tEaXN0YW5jZVRocmVzaG9sZDogMTAsCglyZXNldFRpbWVyRHVyYXRpb246IDE1MDAKfTsKCmZ1bmN0aW9uIGdldE5hdGl2ZUV2ZW50KCBldmVudCApIHsKCgl3aGlsZSAoIGV2ZW50ICYmIHR5cGVvZiBldmVudC5vcmlnaW5hbEV2ZW50ICE9PSAidW5kZWZpbmVkIiApIHsKCQlldmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7Cgl9CglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGNyZWF0ZVZpcnR1YWxFdmVudCggZXZlbnQsIGV2ZW50VHlwZSApIHsKCgl2YXIgdCA9IGV2ZW50LnR5cGUsCgkJb2UsIHByb3BzLCBuZSwgcHJvcCwgY3QsIHRvdWNoLCBpLCBqLCBsZW47CgoJZXZlbnQgPSAkLkV2ZW50KCBldmVudCApOwoJZXZlbnQudHlwZSA9IGV2ZW50VHlwZTsKCglvZSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7Cglwcm9wcyA9ICQuZXZlbnQucHJvcHM7CgoJLy8gYWRkcmVzc2VzIHNlcGFyYXRpb24gb2YgJC5ldmVudC5wcm9wcyBpbiB0byAkLmV2ZW50Lm1vdXNlSG9vay5wcm9wcyBhbmQgSXNzdWUgMzI4MAoJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zMjgwCglpZiAoIHQuc2VhcmNoKCAvXihtb3VzZXxjbGljaykvICkgPiAtMSApIHsKCQlwcm9wcyA9IG1vdXNlRXZlbnRQcm9wczsKCX0KCgkvLyBjb3B5IG9yaWdpbmFsIGV2ZW50IHByb3BlcnRpZXMgb3ZlciB0byB0aGUgbmV3IGV2ZW50CgkvLyB0aGlzIHdvdWxkIGhhcHBlbiBpZiB3ZSBjb3VsZCBjYWxsICQuZXZlbnQuZml4IGluc3RlYWQgb2YgJC5FdmVudAoJLy8gYnV0IHdlIGRvbid0IGhhdmUgYSB3YXkgdG8gZm9yY2UgYW4gZXZlbnQgdG8gYmUgZml4ZWQgbXVsdGlwbGUgdGltZXMKCWlmICggb2UgKSB7CgkJZm9yICggaSA9IHByb3BzLmxlbmd0aCwgcHJvcDsgaTsgKSB7CgkJCXByb3AgPSBwcm9wc1sgLS1pIF07CgkJCWV2ZW50WyBwcm9wIF0gPSBvZVsgcHJvcCBdOwoJCX0KCX0KCgkvLyBtYWtlIHN1cmUgdGhhdCBpZiB0aGUgbW91c2UgYW5kIGNsaWNrIHZpcnR1YWwgZXZlbnRzIGFyZSBnZW5lcmF0ZWQKCS8vIHdpdGhvdXQgYSAud2hpY2ggb25lIGlzIGRlZmluZWQKCWlmICggdC5zZWFyY2goL21vdXNlKGRvd258dXApfGNsaWNrLykgPiAtMSAmJiAhZXZlbnQud2hpY2ggKSB7CgkJZXZlbnQud2hpY2ggPSAxOwoJfQoKCWlmICggdC5zZWFyY2goL150b3VjaC8pICE9PSAtMSApIHsKCQluZSA9IGdldE5hdGl2ZUV2ZW50KCBvZSApOwoJCXQgPSBuZS50b3VjaGVzOwoJCWN0ID0gbmUuY2hhbmdlZFRvdWNoZXM7CgkJdG91Y2ggPSAoIHQgJiYgdC5sZW5ndGggKSA/IHRbMF0gOiAoICggY3QgJiYgY3QubGVuZ3RoICkgPyBjdFsgMCBdIDogdW5kZWZpbmVkICk7CgoJCWlmICggdG91Y2ggKSB7CgkJCWZvciAoIGogPSAwLCBsZW4gPSB0b3VjaEV2ZW50UHJvcHMubGVuZ3RoOyBqIDwgbGVuOyBqKyspIHsKCQkJCXByb3AgPSB0b3VjaEV2ZW50UHJvcHNbIGogXTsKCQkJCWV2ZW50WyBwcm9wIF0gPSB0b3VjaFsgcHJvcCBdOwoJCQl9CgkJfQoJfQoKCXJldHVybiBldmVudDsKfQoKZnVuY3Rpb24gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZWxlbWVudCApIHsKCgl2YXIgZmxhZ3MgPSB7fSwKCQliLCBrOwoKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlmb3IgKCAgayBpbiBiICkgewoJCQlpZiAoIGJbIGsgXSApIHsKCQkJCWZsYWdzWyBrIF0gPSBmbGFncy5oYXNWaXJ0dWFsQmluZGluZyA9IHRydWU7CgkJCX0KCQl9CgkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCX0KCXJldHVybiBmbGFnczsKfQoKZnVuY3Rpb24gZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGVsZW1lbnQsIGV2ZW50VHlwZSApIHsKCXZhciBiOwoJd2hpbGUgKCBlbGVtZW50ICkgewoKCQliID0gJC5kYXRhKCBlbGVtZW50LCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCWlmICggYiAmJiAoICFldmVudFR5cGUgfHwgYlsgZXZlbnRUeXBlIF0gKSApIHsKCQkJcmV0dXJuIGVsZW1lbnQ7CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gbnVsbDsKfQoKZnVuY3Rpb24gZW5hYmxlVG91Y2hCaW5kaW5ncygpIHsKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlOwp9CgpmdW5jdGlvbiBkaXNhYmxlVG91Y2hCaW5kaW5ncygpIHsKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IHRydWU7Cn0KCmZ1bmN0aW9uIGVuYWJsZU1vdXNlQmluZGluZ3MoKSB7CglsYXN0VG91Y2hJRCA9IDA7CgljbGlja0Jsb2NrTGlzdC5sZW5ndGggPSAwOwoJYmxvY2tNb3VzZVRyaWdnZXJzID0gZmFsc2U7CgoJLy8gV2hlbiBtb3VzZSBiaW5kaW5ncyBhcmUgZW5hYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZGlzYWJsZWQuCglkaXNhYmxlVG91Y2hCaW5kaW5ncygpOwp9CgpmdW5jdGlvbiBkaXNhYmxlTW91c2VCaW5kaW5ncygpIHsKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGRpc2FibGVkLCBvdXIKCS8vIHRvdWNoIGJpbmRpbmdzIGFyZSBlbmFibGVkLgoJZW5hYmxlVG91Y2hCaW5kaW5ncygpOwp9CgpmdW5jdGlvbiBzdGFydFJlc2V0VGltZXIoKSB7CgljbGVhclJlc2V0VGltZXIoKTsKCXJlc2V0VGltZXJJRCA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCXJlc2V0VGltZXJJRCA9IDA7CgkJZW5hYmxlTW91c2VCaW5kaW5ncygpOwoJfSwgJC52bW91c2UucmVzZXRUaW1lckR1cmF0aW9uICk7Cn0KCmZ1bmN0aW9uIGNsZWFyUmVzZXRUaW1lcigpIHsKCWlmICggcmVzZXRUaW1lcklEICkgewoJCWNsZWFyVGltZW91dCggcmVzZXRUaW1lcklEICk7CgkJcmVzZXRUaW1lcklEID0gMDsKCX0KfQoKZnVuY3Rpb24gdHJpZ2dlclZpcnR1YWxFdmVudCggZXZlbnRUeXBlLCBldmVudCwgZmxhZ3MgKSB7Cgl2YXIgdmU7CgoJaWYgKCAoIGZsYWdzICYmIGZsYWdzWyBldmVudFR5cGUgXSApIHx8CgkJCQkoICFmbGFncyAmJiBnZXRDbG9zZXN0RWxlbWVudFdpdGhWaXJ0dWFsQmluZGluZyggZXZlbnQudGFyZ2V0LCBldmVudFR5cGUgKSApICkgewoKCQl2ZSA9IGNyZWF0ZVZpcnR1YWxFdmVudCggZXZlbnQsIGV2ZW50VHlwZSApOwoKCQkkKCBldmVudC50YXJnZXQpLnRyaWdnZXIoIHZlICk7Cgl9CgoJcmV0dXJuIHZlOwp9CgpmdW5jdGlvbiBtb3VzZUV2ZW50Q2FsbGJhY2soIGV2ZW50ICkgewoJdmFyIHRvdWNoSUQgPSAkLmRhdGEoIGV2ZW50LnRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgKSwKCQl2ZTsKCglpZiAoICFibG9ja01vdXNlVHJpZ2dlcnMgJiYgKCAhbGFzdFRvdWNoSUQgfHwgbGFzdFRvdWNoSUQgIT09IHRvdWNoSUQgKSApIHsKCQl2ZSA9IHRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2IiArIGV2ZW50LnR5cGUsIGV2ZW50ICk7CgkJaWYgKCB2ZSApIHsKCQkJaWYgKCB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQkJaWYgKCB2ZS5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCX0KCQkJaWYgKCB2ZS5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCX0KCQl9Cgl9Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoU3RhcnQoIGV2ZW50ICkgewoKCXZhciB0b3VjaGVzID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlcywKCQl0YXJnZXQsIGZsYWdzLCB0OwoKCWlmICggdG91Y2hlcyAmJiB0b3VjaGVzLmxlbmd0aCA9PT0gMSApIHsKCgkJdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwoJCWZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggdGFyZ2V0ICk7CgoJCWlmICggZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgKSB7CgoJCQlsYXN0VG91Y2hJRCA9IG5leHRUb3VjaElEKys7CgkJCSQuZGF0YSggdGFyZ2V0LCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSwgbGFzdFRvdWNoSUQgKTsKCgkJCWNsZWFyUmVzZXRUaW1lcigpOwoKCQkJZGlzYWJsZU1vdXNlQmluZGluZ3MoKTsKCQkJZGlkU2Nyb2xsID0gZmFsc2U7CgoJCQl0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdOwoJCQlzdGFydFggPSB0LnBhZ2VYOwoJCQlzdGFydFkgPSB0LnBhZ2VZOwoKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW92ZXIiLCBldmVudCwgZmxhZ3MgKTsKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWRvd24iLCBldmVudCwgZmxhZ3MgKTsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIGhhbmRsZVNjcm9sbCggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJaWYgKCAhZGlkU2Nyb2xsICkgewoJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VjYW5jZWwiLCBldmVudCwgZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICkgKTsKCX0KCglkaWRTY3JvbGwgPSB0cnVlOwoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoTW92ZSggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzWyAwIF0sCgkJZGlkQ2FuY2VsID0gZGlkU2Nyb2xsLAoJCW1vdmVUaHJlc2hvbGQgPSAkLnZtb3VzZS5tb3ZlRGlzdGFuY2VUaHJlc2hvbGQsCgkJZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKTsKCgkJZGlkU2Nyb2xsID0gZGlkU2Nyb2xsIHx8CgkJCSggTWF0aC5hYnMoIHQucGFnZVggLSBzdGFydFggKSA+IG1vdmVUaHJlc2hvbGQgfHwKCQkJCU1hdGguYWJzKCB0LnBhZ2VZIC0gc3RhcnRZICkgPiBtb3ZlVGhyZXNob2xkICk7CgoKCWlmICggZGlkU2Nyb2xsICYmICFkaWRDYW5jZWwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBmbGFncyApOwoJfQoKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vtb3ZlIiwgZXZlbnQsIGZsYWdzICk7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7CgoJdmFyIGZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICksCgkJdmUsIHQ7Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNldXAiLCBldmVudCwgZmxhZ3MgKTsKCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidmNsaWNrIiwgZXZlbnQsIGZsYWdzICk7CgkJaWYgKCB2ZSAmJiB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJLy8gVGhlIHRhcmdldCBvZiB0aGUgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IHRoZSB0b3VjaGVuZAoJCQkvLyBldmVudCBkb24ndCBuZWNlc3NhcmlseSBtYXRjaCB0aGUgdGFyZ2V0IHVzZWQgZHVyaW5nIHRoZQoJCQkvLyB0b3VjaC4gVGhpcyBtZWFucyB3ZSBuZWVkIHRvIHJlbHkgb24gY29vcmRpbmF0ZXMgZm9yIGJsb2NraW5nCgkJCS8vIGFueSBjbGljayB0aGF0IGlzIGdlbmVyYXRlZC4KCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLmNoYW5nZWRUb3VjaGVzWyAwIF07CgkJCWNsaWNrQmxvY2tMaXN0LnB1c2goewoJCQkJdG91Y2hJRDogbGFzdFRvdWNoSUQsCgkJCQl4OiB0LmNsaWVudFgsCgkJCQl5OiB0LmNsaWVudFkKCQkJfSk7CgoJCQkvLyBQcmV2ZW50IGFueSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgZnJvbSB0cmlnZ2VyaW5nCgkJCS8vIHZpcnR1YWwgZXZlbnQgbm90aWZpY2F0aW9ucy4KCQkJYmxvY2tNb3VzZVRyaWdnZXJzID0gdHJ1ZTsKCQl9Cgl9Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3V0IiwgZXZlbnQsIGZsYWdzKTsKCWRpZFNjcm9sbCA9IGZhbHNlOwoKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYXNWaXJ0dWFsQmluZGluZ3MoIGVsZSApIHsKCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggZWxlLCBkYXRhUHJvcGVydHlOYW1lICksCgkJazsKCglpZiAoIGJpbmRpbmdzICkgewoJCWZvciAoIGsgaW4gYmluZGluZ3MgKSB7CgkJCWlmICggYmluZGluZ3NbIGsgXSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoJfQoJcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBkdW1teU1vdXNlSGFuZGxlcigpIHt9CgpmdW5jdGlvbiBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIGV2ZW50VHlwZSApIHsKCXZhciByZWFsVHlwZSA9IGV2ZW50VHlwZS5zdWJzdHIoIDEgKTsKCglyZXR1cm4gewoJCXNldHVwOiBmdW5jdGlvbigvKiBkYXRhLCBuYW1lc3BhY2UgKi8pIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGZvciB0aGlzIGVsZW1lbnQsCgkJCS8vIGFkZCBhIGJpbmRpbmdzIG9iamVjdCB0byBpdHMgZGF0YS4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lLCB7fSApOwoJCQl9CgoJCQkvLyBJZiBzZXR1cCBpcyBjYWxsZWQsIHdlIGtub3cgaXQgaXMgdGhlIGZpcnN0IGJpbmRpbmcgZm9yIHRoaXMKCQkJLy8gZXZlbnRUeXBlLCBzbyBpbml0aWFsaXplIHRoZSBjb3VudCBmb3IgdGhlIGV2ZW50VHlwZSB0byB6ZXJvLgoJCQl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gdHJ1ZTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgZXZlbnQgZm9yIHRoaXMgdHlwZSwKCQkJLy8gcmVnaXN0ZXIgYSBnbG9iYWwgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQlhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSB8fCAwICkgKyAxOwoKCQkJaWYgKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPT09IDEgKSB7CgkJCQkkZG9jdW1lbnQuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQkvLyBTb21lIGJyb3dzZXJzLCBsaWtlIE9wZXJhIE1pbmksIHdvbid0IGRpc3BhdGNoIG1vdXNlL2NsaWNrIGV2ZW50cwoJCQkvLyBmb3IgZWxlbWVudHMgdW5sZXNzIHRoZXkgYWN0dWFsbHkgaGF2ZSBoYW5kbGVycyByZWdpc3RlcmVkIG9uIHRoZW0uCgkJCS8vIFRvIGdldCBhcm91bmQgdGhpcywgd2UgcmVnaXN0ZXIgZHVtbXkgaGFuZGxlcnMgb24gdGhlIGVsZW1lbnRzLgoKCQkJJCggdGhpcyApLmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gRm9yIG5vdywgaWYgZXZlbnQgY2FwdHVyZSBpcyBub3Qgc3VwcG9ydGVkLCB3ZSByZWx5IG9uIG1vdXNlIGhhbmRsZXJzLgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhlIGRvY3VtZW50LAoJCQkJLy8gcmVnaXN0ZXIgb3VyIHRvdWNoc3RhcnQgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQkJYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gfHwgMCkgKyAxOwoKCQkJCWlmICggYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID09PSAxICkgewoJCQkJCSRkb2N1bWVudC5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoKCQkJCQkJLy8gT24gdG91Y2ggcGxhdGZvcm1zLCB0b3VjaGluZyB0aGUgc2NyZWVuIGFuZCB0aGVuIGRyYWdnaW5nIHlvdXIgZmluZ2VyCgkJCQkJCS8vIGNhdXNlcyB0aGUgd2luZG93IGNvbnRlbnQgdG8gc2Nyb2xsIGFmdGVyIHNvbWUgZGlzdGFuY2UgdGhyZXNob2xkIGlzCgkJCQkJCS8vIGV4Y2VlZGVkLiBPbiB0aGVzZSBwbGF0Zm9ybXMsIGEgc2Nyb2xsIHByZXZlbnRzIGEgY2xpY2sgZXZlbnQgZnJvbSBiZWluZwoJCQkJCQkvLyBkaXNwYXRjaGVkLCBhbmQgb24gc29tZSBwbGF0Zm9ybXMsIGV2ZW4gdGhlIHRvdWNoZW5kIGlzIHN1cHByZXNzZWQuIFRvCgkJCQkJCS8vIG1pbWljIHRoZSBzdXBwcmVzc2lvbiBvZiB0aGUgY2xpY2sgZXZlbnQsIHdlIG5lZWQgdG8gd2F0Y2ggZm9yIGEgc2Nyb2xsCgkJCQkJCS8vIGV2ZW50LiBVbmZvcnR1bmF0ZWx5LCBzb21lIHBsYXRmb3JtcyBsaWtlIGlPUyBkb24ndCBkaXNwYXRjaCBzY3JvbGwKCQkJCQkJLy8gZXZlbnRzIHVudGlsICpBRlRFUiogdGhlIHVzZXIgbGlmdHMgdGhlaXIgZmluZ2VyICh0b3VjaGVuZCkuIFRoaXMgbWVhbnMKCQkJCQkJLy8gd2UgbmVlZCB0byB3YXRjaCBib3RoIHNjcm9sbCBhbmQgdG91Y2htb3ZlIGV2ZW50cyB0byBmaWd1cmUgb3V0IHdoZXRoZXIKCQkJCQkJLy8gb3Igbm90IGEgc2Nyb2xsIGhhcHBlbmVucyBiZWZvcmUgdGhlIHRvdWNoZW5kIGV2ZW50IGlzIGZpcmVkLgoKCQkJCQkJLmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkuYmluZCggInNjcm9sbCIsIGhhbmRsZVNjcm9sbCApOwoJCQkJfQoJCQl9CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKC8qIGRhdGEsIG5hbWVzcGFjZSAqLykgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgYmluZGluZyBmb3IgdGhpcyBldmVudFR5cGUsCgkJCS8vIHJlbW92ZSBpdHMgZ2xvYmFsIGhhbmRsZXIgZnJvbSB0aGUgZG9jdW1lbnQuCgoJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXTsKCgkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSApIHsKCQkJCSRkb2N1bWVudC51bmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBpbiBleGlzdGVuY2UsCgkJCQkvLyByZW1vdmUgb3VyIGRvY3VtZW50IHRvdWNoc3RhcnQgbGlzdGVuZXIuCgoJCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF07CgoJCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdICkgewoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS51bmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkudW5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgkJCQkJCS51bmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJCS8vIHRlYXJkb3duIG1heSBiZSBjYWxsZWQgd2hlbiBhbiBlbGVtZW50IHdhcwoJCQkvLyByZW1vdmVkIGZyb20gdGhlIERPTS4gSWYgdGhpcyBpcyB0aGUgY2FzZSwKCQkJLy8galF1ZXJ5IGNvcmUgbWF5IGhhdmUgYWxyZWFkeSBzdHJpcHBlZCB0aGUgZWxlbWVudAoJCQkvLyBvZiBhbnkgZGF0YSBiaW5kaW5ncyBzbyB3ZSBuZWVkIHRvIGNoZWNrIGl0IGJlZm9yZQoJCQkvLyB1c2luZyBpdC4KCQkJaWYgKCBiaW5kaW5ncyApIHsKCQkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IGZhbHNlOwoJCQl9CgoJCQkvLyBVbnJlZ2lzdGVyIHRoZSBkdW1teSBldmVudCBoYW5kbGVyLgoKCQkJJHRoaXMudW5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIG9uIHRoZQoJCQkvLyBlbGVtZW50LCByZW1vdmUgdGhlIGJpbmRpbmcgZGF0YSBmcm9tIHRoZSBlbGVtZW50LgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkdGhpcy5yZW1vdmVEYXRhKCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCX0KCQl9Cgl9Owp9CgovLyBFeHBvc2Ugb3VyIGN1c3RvbSBldmVudHMgdG8gdGhlIGpRdWVyeSBiaW5kL3VuYmluZCBtZWNoYW5pc20uCgpmb3IgKCBpID0gMDsgaSA8IHZpcnR1YWxFdmVudE5hbWVzLmxlbmd0aDsgaSsrICkgewoJJC5ldmVudC5zcGVjaWFsWyB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdIF0gPSBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gKTsKfQoKLy8gQWRkIGEgY2FwdHVyZSBjbGljayBoYW5kbGVyIHRvIGJsb2NrIGNsaWNrcy4KLy8gTm90ZSB0aGF0IHdlIHJlcXVpcmUgZXZlbnQgY2FwdHVyZSBzdXBwb3J0IGZvciB0aGlzIHNvIGlmIHRoZSBkZXZpY2UKLy8gZG9lc24ndCBzdXBwb3J0IGl0LCB3ZSBwdW50IGZvciBub3cgYW5kIHJlbHkgc29sZWx5IG9uIG1vdXNlIGV2ZW50cy4KaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7Cglkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQl2YXIgY250ID0gY2xpY2tCbG9ja0xpc3QubGVuZ3RoLAoJCQl0YXJnZXQgPSBlLnRhcmdldCwKCQkJeCwgeSwgZWxlLCBpLCBvLCB0b3VjaElEOwoKCQlpZiAoIGNudCApIHsKCQkJeCA9IGUuY2xpZW50WDsKCQkJeSA9IGUuY2xpZW50WTsKCQkJdGhyZXNob2xkID0gJC52bW91c2UuY2xpY2tEaXN0YW5jZVRocmVzaG9sZDsKCgkJCS8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gcnVuIHRocm91Z2ggdGhlIGNsaWNrQmxvY2tMaXN0IHRvIHNlZSBpZgoJCQkvLyB0aGUgY3VycmVudCBjbGljayBldmVudCBpcyBpbiB0aGUgcHJveGltaXR5IG9mIG9uZSBvZiBvdXIKCQkJLy8gdmNsaWNrIGV2ZW50cyB0aGF0IGhhZCBwcmV2ZW50RGVmYXVsdCgpIGNhbGxlZCBvbiBpdC4gSWYgd2UgZmluZAoJCQkvLyBvbmUsIHRoZW4gd2UgYmxvY2sgdGhlIGNsaWNrLgoJCQkvLwoJCQkvLyBXaHkgZG8gd2UgaGF2ZSB0byByZWx5IG9uIHByb3hpbWl0eT8KCQkJLy8KCQkJLy8gQmVjYXVzZSB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaCBldmVudCB0aGF0IHRyaWdnZXJlZCB0aGUgdmNsaWNrCgkJCS8vIGNhbiBiZSBkaWZmZXJlbnQgZnJvbSB0aGUgdGFyZ2V0IG9mIHRoZSBjbGljayBldmVudCBzeW50aGVzaXplZAoJCQkvLyBieSB0aGUgYnJvd3Nlci4gVGhlIHRhcmdldCBvZiBhIG1vdXNlL2NsaWNrIGV2ZW50IHRoYXQgaXMgc3ludGVoc2l6ZWQKCQkJLy8gZnJvbSBhIHRvdWNoIGV2ZW50IHNlZW1zIHRvIGJlIGltcGxlbWVudGF0aW9uIHNwZWNpZmljLiBGb3IgZXhhbXBsZSwKCQkJLy8gc29tZSBicm93c2VycyB3aWxsIGZpcmUgbW91c2UvY2xpY2sgZXZlbnRzIGZvciBhIGxpbmsgdGhhdCBpcyBuZWFyCgkJCS8vIGEgdG91Y2ggZXZlbnQsIGV2ZW4gdGhvdWdoIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoc3RhcnQvdG91Y2hlbmQgZXZlbnQKCQkJLy8gc2F5cyB0aGUgdXNlciB0b3VjaGVkIG91dHNpZGUgdGhlIGxpbmsuIEFsc28sIGl0IHNlZW1zIHRoYXQgd2l0aCBtb3N0CgkJCS8vIGJyb3dzZXJzLCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayBldmVudCBpcyBub3QgY2FsY3VsYXRlZCB1bnRpbCB0aGUKCQkJLy8gdGltZSBpdCBpcyBkaXNwYXRjaGVkLCBzbyBpZiB5b3UgcmVwbGFjZSBhbiBlbGVtZW50IHRoYXQgeW91IHRvdWNoZWQKCQkJLy8gd2l0aCBhbm90aGVyIGVsZW1lbnQsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIHdpbGwgYmUgdGhlIG5ldwoJCQkvLyBlbGVtZW50IHVuZGVybmVhdGggdGhhdCBwb2ludC4KCQkJLy8KCQkJLy8gQXNpZGUgZnJvbSBwcm94aW1pdHksIHdlIGFsc28gY2hlY2sgdG8gc2VlIGlmIHRoZSB0YXJnZXQgYW5kIGFueQoJCQkvLyBvZiBpdHMgYW5jZXN0b3JzIHdlcmUgdGhlIG9uZXMgdGhhdCBibG9ja2VkIGEgY2xpY2suIFRoaXMgaXMgbmVjZXNzYXJ5CgkJCS8vIGJlY2F1c2Ugb2YgdGhlIHN0cmFuZ2UgbW91c2UvY2xpY2sgdGFyZ2V0IGNhbGN1bGF0aW9uIGRvbmUgaW4gdGhlCgkJCS8vIEFuZHJvaWQgMi4xIGJyb3dzZXIsIHdoZXJlIGlmIHlvdSBjbGljayBvbiBhbiBlbGVtZW50LCBhbmQgdGhlcmUgaXMgYQoJCQkvLyBtb3VzZS9jbGljayBoYW5kbGVyIG9uIG9uZSBvZiBpdHMgYW5jZXN0b3JzLCB0aGUgdGFyZ2V0IHdpbGwgYmUgdGhlCgkJCS8vIGlubmVybW9zdCBjaGlsZCBvZiB0aGUgdG91Y2hlZCBlbGVtZW50LCBldmVuIGlmIHRoYXQgY2hpbGQgaXMgbm8gd2hlcmUKCQkJLy8gbmVhciB0aGUgcG9pbnQgb2YgdG91Y2guCgoJCQllbGUgPSB0YXJnZXQ7CgoJCQl3aGlsZSAoIGVsZSApIHsKCQkJCWZvciAoIGkgPSAwOyBpIDwgY250OyBpKysgKSB7CgkJCQkJbyA9IGNsaWNrQmxvY2tMaXN0WyBpIF07CgkJCQkJdG91Y2hJRCA9IDA7CgoJCQkJCWlmICggKCBlbGUgPT09IHRhcmdldCAmJiBNYXRoLmFicyggby54IC0geCApIDwgdGhyZXNob2xkICYmIE1hdGguYWJzKCBvLnkgLSB5ICkgPCB0aHJlc2hvbGQgKSB8fAoJCQkJCQkJCSQuZGF0YSggZWxlLCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSApID09PSBvLnRvdWNoSUQgKSB7CgkJCQkJCS8vIFhYWDogV2UgbWF5IHdhbnQgdG8gY29uc2lkZXIgcmVtb3ZpbmcgbWF0Y2hlcyBmcm9tIHRoZSBibG9jayBsaXN0CgkJCQkJCS8vICAgICAgaW5zdGVhZCBvZiB3YWl0aW5nIGZvciB0aGUgcmVzZXQgdGltZXIgdG8gZmlyZS4KCQkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJfQoJCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJCX0KCQl9Cgl9LCB0cnVlKTsKfQp9KSggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhciAkZG9jdW1lbnQgPSAkKCBkb2N1bWVudCApLAoJCXN1cHBvcnRUb3VjaCA9ICQubW9iaWxlLnN1cHBvcnQudG91Y2gsCgkJc2Nyb2xsRXZlbnQgPSAidG91Y2htb3ZlIHNjcm9sbCIsCgkJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgkJdG91Y2hTdG9wRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hlbmQiIDogIm1vdXNldXAiLAoJCXRvdWNoTW92ZUV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNobW92ZSIgOiAibW91c2Vtb3ZlIjsKCgkvLyBzZXR1cCBuZXcgZXZlbnQgc2hvcnRjdXRzCgkkLmVhY2goICggInRvdWNoc3RhcnQgdG91Y2htb3ZlIHRvdWNoZW5kICIgKwoJCSJ0YXAgdGFwaG9sZCAiICsKCQkic3dpcGUgc3dpcGVsZWZ0IHN3aXBlcmlnaHQgIiArCgkJInNjcm9sbHN0YXJ0IHNjcm9sbHN0b3AiICkuc3BsaXQoICIgIiApLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgkJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCQlyZXR1cm4gZm4gPyB0aGlzLmJpbmQoIG5hbWUsIGZuICkgOiB0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCQl9OwoKCQkvLyBqUXVlcnkgPCAxLjgKCQlpZiAoICQuYXR0ckZuICkgewoJCQkkLmF0dHJGblsgbmFtZSBdID0gdHJ1ZTsKCQl9Cgl9KTsKCglmdW5jdGlvbiB0cmlnZ2VyQ3VzdG9tRXZlbnQoIG9iaiwgZXZlbnRUeXBlLCBldmVudCApIHsKCQl2YXIgb3JpZ2luYWxUeXBlID0gZXZlbnQudHlwZTsKCQlldmVudC50eXBlID0gZXZlbnRUeXBlOwoJCSQuZXZlbnQuZGlzcGF0Y2guY2FsbCggb2JqLCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSBvcmlnaW5hbFR5cGU7Cgl9CgoJLy8gYWxzbyBoYW5kbGVzIHNjcm9sbHN0b3AKCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydCA9IHsKCgkJZW5hYmxlZDogdHJ1ZSwKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKSwKCQkJCXNjcm9sbGluZywKCQkJCXRpbWVyOwoKCQkJZnVuY3Rpb24gdHJpZ2dlciggZXZlbnQsIHN0YXRlICkgewoJCQkJc2Nyb2xsaW5nID0gc3RhdGU7CgkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsIHNjcm9sbGluZyA/ICJzY3JvbGxzdGFydCIgOiAic2Nyb2xsc3RvcCIsIGV2ZW50ICk7CgkJCX0KCgkJCS8vIGlQaG9uZSB0cmlnZ2VycyBzY3JvbGwgYWZ0ZXIgYSBzbWFsbCBkZWxheTsgdXNlIHRvdWNobW92ZSBpbnN0ZWFkCgkJCSR0aGlzLmJpbmQoIHNjcm9sbEV2ZW50LCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICggIXNjcm9sbGluZyApIHsKCQkJCQl0cmlnZ2VyKCBldmVudCwgdHJ1ZSApOwoJCQkJfQoKCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCXRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlciggZXZlbnQsIGZhbHNlICk7CgkJCQl9LCA1MCApOwoJCQl9KTsKCQl9LAoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJJCggdGhpcyApLnVuYmluZCggc2Nyb2xsRXZlbnQgKTsKCQl9Cgl9OwoKCS8vIGFsc28gaGFuZGxlcyB0YXBob2xkCgkkLmV2ZW50LnNwZWNpYWwudGFwID0gewoJCXRhcGhvbGRUaHJlc2hvbGQ6IDc1MCwKCQllbWl0VGFwT25UYXBob2xkOiB0cnVlLAoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICksCgkJCQlpc1RhcGhvbGQgPSBmYWxzZTsKCgkJCSR0aGlzLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaXNUYXBob2xkID0gZmFsc2U7CgkJCQlpZiAoIGV2ZW50LndoaWNoICYmIGV2ZW50LndoaWNoICE9PSAxICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQl2YXIgb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQl0aW1lcjsKCgkJCQlmdW5jdGlvbiBjbGVhclRhcFRpbWVyKCkgewoJCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCX0KCgkJCQlmdW5jdGlvbiBjbGVhclRhcEhhbmRsZXJzKCkgewoJCQkJCWNsZWFyVGFwVGltZXIoKTsKCgkJCQkJJHRoaXMudW5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICkKCQkJCQkJLnVuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApOwoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgkJCQl9CgoJCQkJZnVuY3Rpb24gY2xpY2tIYW5kbGVyKCBldmVudCApIHsKCQkJCQljbGVhclRhcEhhbmRsZXJzKCk7CgoJCQkJCS8vIE9OTFkgdHJpZ2dlciBhICd0YXAnIGV2ZW50IGlmIHRoZSBzdGFydCB0YXJnZXQgaXMKCQkJCQkvLyB0aGUgc2FtZSBhcyB0aGUgc3RvcCB0YXJnZXQuCgkJCQkJaWYgKCAhaXNUYXBob2xkICYmIG9yaWdUYXJnZXQgPT09IGV2ZW50LnRhcmdldCApIHsKCQkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwIiwgZXZlbnQgKTsKCQkJCQl9IGVsc2UgaWYgKCBpc1RhcGhvbGQgKSB7CgkJCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCX0KCQkJCX0KCgkJCQkkdGhpcy5iaW5kKCAidm1vdXNldXAiLCBjbGVhclRhcFRpbWVyICkKCQkJCQkuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApOwoJCQkJJGRvY3VtZW50LmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgoJCQkJdGltZXIgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQlpZiAoICEkLmV2ZW50LnNwZWNpYWwudGFwLmVtaXRUYXBPblRhcGhvbGQgKSB7CgkJCQkJCWlzVGFwaG9sZCA9IHRydWU7CgkJCQkJfQoJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcGhvbGQiLCAkLkV2ZW50KCAidGFwaG9sZCIsIHsgdGFyZ2V0OiBvcmlnVGFyZ2V0IH0gKSApOwoJCQkJfSwgJC5ldmVudC5zcGVjaWFsLnRhcC50YXBob2xkVGhyZXNob2xkICk7CgkJCX0pOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkudW5iaW5kKCAidm1vdXNlZG93biIgKS51bmJpbmQoICJ2Y2xpY2siICkudW5iaW5kKCAidm1vdXNldXAiICk7CgkJCSRkb2N1bWVudC51bmJpbmQoICJ2bW91c2VjYW5jZWwiICk7CgkJfQoJfTsKCgkvLyBhbHNvIGhhbmRsZXMgc3dpcGVsZWZ0LCBzd2lwZXJpZ2h0CgkkLmV2ZW50LnNwZWNpYWwuc3dpcGUgPSB7CgkJc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZDogMzAsIC8vIE1vcmUgdGhhbiB0aGlzIGhvcml6b250YWwgZGlzcGxhY2VtZW50LCBhbmQgd2Ugd2lsbCBzdXBwcmVzcyBzY3JvbGxpbmcuCgoJCWR1cmF0aW9uVGhyZXNob2xkOiAxMDAwLCAvLyBNb3JlIHRpbWUgdGhhbiB0aGlzLCBhbmQgaXQgaXNuJ3QgYSBzd2lwZS4KCgkJaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkOiAxMCwgIC8vIFN3aXBlIGhvcml6b250YWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbW9yZSB0aGFuIHRoaXMuCgoJCXZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQ6IDc1LCAgLy8gU3dpcGUgdmVydGljYWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbGVzcyB0aGFuIHRoaXMuCgoJCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50OwoJCQlyZXR1cm4gewoJCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJCWNvb3JkczogWyBkYXRhLnBhZ2VYLCBkYXRhLnBhZ2VZIF0sCgkJCQkJCW9yaWdpbjogJCggZXZlbnQudGFyZ2V0ICkKCQkJCQl9OwoJCX0sCgoJCXN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGRhdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgPwoJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1sgMCBdIDogZXZlbnQ7CgkJCXJldHVybiB7CgkJCQkJCXRpbWU6ICggbmV3IERhdGUoKSApLmdldFRpbWUoKSwKCQkJCQkJY29vcmRzOiBbIGRhdGEucGFnZVgsIGRhdGEucGFnZVkgXQoJCQkJCX07CgkJfSwKCgkJaGFuZGxlU3dpcGU6IGZ1bmN0aW9uKCBzdGFydCwgc3RvcCwgdGhpc09iamVjdCwgb3JpZ1RhcmdldCApIHsKCQkJaWYgKCBzdG9wLnRpbWUgLSBzdGFydC50aW1lIDwgJC5ldmVudC5zcGVjaWFsLnN3aXBlLmR1cmF0aW9uVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAwIF0gLSBzdG9wLmNvb3Jkc1sgMCBdICkgPiAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAxIF0gLSBzdG9wLmNvb3Jkc1sgMSBdICkgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUudmVydGljYWxEaXN0YW5jZVRocmVzaG9sZCApIHsKCQkJCXZhciBkaXJlY3Rpb24gPSBzdGFydC5jb29yZHNbMF0gPiBzdG9wLmNvb3Jkc1sgMCBdID8gInN3aXBlbGVmdCIgOiAic3dpcGVyaWdodCI7CgoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAic3dpcGUiLCAkLkV2ZW50KCAic3dpcGUiLCB7IHRhcmdldDogb3JpZ1RhcmdldCwgc3dpcGVzdGFydDogc3RhcnQsIHN3aXBlc3RvcDogc3RvcCB9KSApOwoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCBkaXJlY3Rpb24sJC5FdmVudCggZGlyZWN0aW9uLCB7IHRhcmdldDogb3JpZ1RhcmdldCwgc3dpcGVzdGFydDogc3RhcnQsIHN3aXBlc3RvcDogc3RvcCB9ICkgKTsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJCXJldHVybiBmYWxzZTsKCgkJfSwKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKTsKCgkJCSR0aGlzLmJpbmQoIHRvdWNoU3RhcnRFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdmFyIHN0b3AsCgkJCQkJc3RhcnQgPSAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuc3RhcnQoIGV2ZW50ICksCgkJCQkJb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQllbWl0dGVkID0gZmFsc2U7CgoJCQkJZnVuY3Rpb24gbW92ZUhhbmRsZXIoIGV2ZW50ICkgewoJCQkJCWlmICggIXN0YXJ0ICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQlzdG9wID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnN0b3AoIGV2ZW50ICk7CgkJCQkJaWYgKCAhZW1pdHRlZCApewoJCQkJCQllbWl0dGVkID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLmhhbmRsZVN3aXBlKCBzdGFydCwgc3RvcCwgdGhpc09iamVjdCwgb3JpZ1RhcmdldCApOwoJCQkJCX0KCQkJCQkvLyBwcmV2ZW50IHNjcm9sbGluZwoJCQkJCWlmICggTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMCBdIC0gc3RvcC5jb29yZHNbIDAgXSApID4gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnNjcm9sbFN1cHJlc3Npb25UaHJlc2hvbGQgKSB7CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfQoJCQkJfQoKCQkJCSR0aGlzLmJpbmQoIHRvdWNoTW92ZUV2ZW50LCBtb3ZlSGFuZGxlciApCgkJCQkJLm9uZSggdG91Y2hTdG9wRXZlbnQsIGZ1bmN0aW9uKCkgewoJCQkJCQllbWl0dGVkID0gdHJ1ZTsKCQkJCX0pOwoJCQl9KTsKCQl9LAoKCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS51bmJpbmQoIHRvdWNoU3RhcnRFdmVudCApLnVuYmluZCggdG91Y2hNb3ZlRXZlbnQgKS51bmJpbmQoIHRvdWNoU3RvcEV2ZW50ICk7CgkJfQoJfTsKCSQuZWFjaCh7CgkJc2Nyb2xsc3RvcDogInNjcm9sbHN0YXJ0IiwKCQl0YXBob2xkOiAidGFwIiwKCQlzd2lwZWxlZnQ6ICJzd2lwZSIsCgkJc3dpcGVyaWdodDogInN3aXBlIgoJfSwgZnVuY3Rpb24oIGV2ZW50LCBzb3VyY2VFdmVudCApIHsKCgkJJC5ldmVudC5zcGVjaWFsWyBldmVudCBdID0gewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmluZCggc291cmNlRXZlbnQsICQubm9vcCApOwoJCQl9LAoJCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkudW5iaW5kKCBzb3VyY2VFdmVudCApOwoJCQl9CgkJfTsKCX0pOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKCgkvLyB0aHJvdHRsZWQgcmVzaXplIGV2ZW50CgkoZnVuY3Rpb24oICQgKSB7CgkJJC5ldmVudC5zcGVjaWFsLnRocm90dGxlZHJlc2l6ZSA9IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmJpbmQoICJyZXNpemUiLCBoYW5kbGVyICk7CgkJCX0sCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS51bmJpbmQoICJyZXNpemUiLCBoYW5kbGVyICk7CgkJCX0KCQl9OwoKCQl2YXIgdGhyb3R0bGUgPSAyNTAsCgkJCWhhbmRsZXIgPSBmdW5jdGlvbigpIHsKCQkJCWN1cnIgPSAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCk7CgkJCQlkaWZmID0gY3VyciAtIGxhc3RDYWxsOwoKCQkJCWlmICggZGlmZiA+PSB0aHJvdHRsZSApIHsKCgkJCQkJbGFzdENhbGwgPSBjdXJyOwoJCQkJCSQoIHRoaXMgKS50cmlnZ2VyKCAidGhyb3R0bGVkcmVzaXplIiApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCWlmICggaGVsZENhbGwgKSB7CgkJCQkJCWNsZWFyVGltZW91dCggaGVsZENhbGwgKTsKCQkJCQl9CgoJCQkJCS8vIFByb21pc2UgYSBoZWxkIGNhbGwgd2lsbCBzdGlsbCBleGVjdXRlCgkJCQkJaGVsZENhbGwgPSBzZXRUaW1lb3V0KCBoYW5kbGVyLCB0aHJvdHRsZSAtIGRpZmYgKTsKCQkJCX0KCQkJfSwKCQkJbGFzdENhbGwgPSAwLAoJCQloZWxkQ2FsbCwKCQkJY3VyciwKCQkJZGlmZjsKCX0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoJdmFyIHdpbiA9ICQoIHdpbmRvdyApLAoJCWV2ZW50X25hbWUgPSAib3JpZW50YXRpb25jaGFuZ2UiLAoJCWdldF9vcmllbnRhdGlvbiwKCQlsYXN0X29yaWVudGF0aW9uLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCwKCQlwb3J0cmFpdF9tYXAgPSB7ICIwIjogdHJ1ZSwgIjE4MCI6IHRydWUgfSwKCQl3dywgd2gsIGxhbmRzY2FwZV90aHJlc2hvbGQ7CgoJLy8gSXQgc2VlbXMgdGhhdCBzb21lIGRldmljZS9icm93c2VyIHZlbmRvcnMgdXNlIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZXMgMCBhbmQgMTgwIHRvCgkvLyBkZW5vdGUgdGhlICJkZWZhdWx0IiBvcmllbnRhdGlvbi4gRm9yIGlPUyBkZXZpY2VzLCBhbmQgbW9zdCBvdGhlciBzbWFydC1waG9uZXMgdGVzdGVkLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgYWx3YXlzICJwb3J0cmFpdCIsIGJ1dCBpbiBzb21lIEFuZHJvaWQgYW5kIFJJTSBiYXNlZCB0YWJsZXRzLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgImxhbmRzY2FwZSIuIFRoZSBmb2xsb3dpbmcgY29kZSBhdHRlbXB0cyB0byB1c2UgdGhlIHdpbmRvdwoJLy8gZGltZW5zaW9ucyB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24gaXMsIGFuZCB0aGVuIG1ha2VzIGFkanVzdG1lbnRzCgkvLyB0byB0aGUgdG8gdGhlIHBvcnRyYWl0X21hcCBpZiBuZWNlc3NhcnksIHNvIHRoYXQgd2UgY2FuIHByb3Blcmx5IGRlY29kZSB0aGUKCS8vIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZSB3aGVuZXZlciBnZXRfb3JpZW50YXRpb24oKSBpcyBjYWxsZWQuCgkvLwoJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIGEgbWVkaWEgcXVlcnkgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBvcmllbnRhdGlvbiB0aGUgYnJvd3NlcgoJLy8gdGhpbmtzIGl0IGlzIGluOgoJLy8KCS8vICAgICBpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSA9ICQubW9iaWxlLm1lZGlhKCJhbGwgYW5kIChvcmllbnRhdGlvbjogbGFuZHNjYXBlKSIpOwoJLy8KCS8vIGJ1dCB0aGVyZSB3YXMgYW4gaVBob25lL2lQb2QgVG91Y2ggYnVnIGJlZ2lubmluZyB3aXRoIGlPUyA0LjIsIHVwIHRocm91Z2ggaU9TIDUuMSwKCS8vIHdoZXJlIHRoZSBicm93c2VyICpBTFdBWVMqIGFwcGxpZWQgdGhlIGxhbmRzY2FwZSBtZWRpYSBxdWVyeS4gVGhpcyBidWcgZG9lcyBub3QKCS8vIGhhcHBlbiBvbiBpUGFkLgoKCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICkgewoKCQkvLyBDaGVjayB0aGUgd2luZG93IHdpZHRoIGFuZCBoZWlnaHQgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uCgkJLy8gb2YgdGhlIGRldmljZSBpcyBhdCB0aGlzIG1vbWVudC4gTm90ZSB0aGF0IHdlJ3ZlIGluaXRpYWxpemVkIHRoZSBwb3J0cmFpdCBtYXAKCQkvLyB2YWx1ZXMgdG8gMCBhbmQgMTgwLCAqQU5EKiB3ZSBwdXJwb3NlbHkgY2hlY2sgZm9yIGxhbmRzY2FwZSBzbyB0aGF0IGlmIHdlIGd1ZXNzCgkJLy8gd3JvbmcsICwgd2UgZGVmYXVsdCB0byB0aGUgYXNzdW1wdGlvbiB0aGF0IHBvcnRyYWl0IGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uLgoJCS8vIFdlIHVzZSBhIHRocmVzaG9sZCBjaGVjayBiZWxvdyBiZWNhdXNlIG9uIHNvbWUgcGxhdGZvcm1zIGxpa2UgaU9TLCB0aGUgaVBob25lCgkJLy8gZm9ybS1mYWN0b3IgY2FuIHJlcG9ydCBhIGxhcmdlciB3aWR0aCB0aGFuIGhlaWdodCBpZiB0aGUgdXNlciB0dXJucyBvbiB0aGUKCQkvLyBkZXZlbG9wZXIgY29uc29sZS4gVGhlIGFjdHVhbCB0aHJlc2hvbGQgdmFsdWUgaXMgc29tZXdoYXQgYXJiaXRyYXJ5LCB3ZSBqdXN0CgkJLy8gbmVlZCB0byBtYWtlIHN1cmUgaXQgaXMgbGFyZ2UgZW5vdWdoIHRvIGV4Y2x1ZGUgdGhlIGRldmVsb3BlciBjb25zb2xlIGNhc2UuCgoJCXd3ID0gd2luZG93LmlubmVyV2lkdGggfHwgd2luLndpZHRoKCk7CgkJd2ggPSB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgd2luLmhlaWdodCgpOwoJCWxhbmRzY2FwZV90aHJlc2hvbGQgPSA1MDsKCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgPSB3dyA+IHdoICYmICggd3cgLSB3aCApID4gbGFuZHNjYXBlX3RocmVzaG9sZDsKCgoJCS8vIE5vdyBjaGVjayB0byBzZWUgaWYgdGhlIGN1cnJlbnQgd2luZG93Lm9yaWVudGF0aW9uIGlzIDAgb3IgMTgwLgoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgoJCS8vIElmIHRoZSBpbml0aWFsIG9yaWVudGF0aW9uIGlzIGxhbmRzY2FwZSwgYnV0IHdpbmRvdy5vcmllbnRhdGlvbiByZXBvcnRzIDAgb3IgMTgwLCAqT1IqCgkJLy8gaWYgdGhlIGluaXRpYWwgb3JpZW50YXRpb24gaXMgcG9ydHJhaXQsIGJ1dCB3aW5kb3cub3JpZW50YXRpb24gcmVwb3J0cyA5MCBvciAtOTAsIHdlCgkJLy8gbmVlZCB0byBmbGlwIG91ciBwb3J0cmFpdF9tYXAgdmFsdWVzIGJlY2F1c2UgbGFuZHNjYXBlIGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uIGZvcgoJCS8vIHRoaXMgZGV2aWNlL2Jyb3dzZXIuCgkJaWYgKCAoIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmIGluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCApIHx8ICggIWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmICFpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgKSApIHsKCQkJcG9ydHJhaXRfbWFwID0geyAiLTkwIjogdHJ1ZSwgIjkwIjogdHJ1ZSB9OwoJCX0KCX0KCgkkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UgPSAkLmV4dGVuZCgge30sICQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZSwgewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQgalF1ZXJ5CgkJCS8vIHdpbGwgYmluZCB0byB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICEkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UuZGlzYWJsZWQgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiB0byBhdm9pZCBpbml0aWFsIGRvdWJsZS10cmlnZ2VyaW5nLgoJCQlsYXN0X29yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkvLyBCZWNhdXNlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudCBkb2Vzbid0IGV4aXN0LCBzaW11bGF0ZSB0aGUKCQkJLy8gZXZlbnQgYnkgdGVzdGluZyB3aW5kb3cgZGltZW5zaW9ucyBvbiByZXNpemUuCgkJCXdpbi5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB0aGUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQKCQkJLy8galF1ZXJ5IHdpbGwgdW5iaW5kIHRoZSBldmVudCB1c2luZyBET00gbWV0aG9kcy4KCQkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gJiYgISQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5kaXNhYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgdW5iaW5kIHRoZQoJCQkvLyByZXNpemUgZXZlbnQgaGFuZGxlci4KCQkJd2luLnVuYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCWFkZDogZnVuY3Rpb24oIGhhbmRsZU9iaiApIHsKCQkJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgYm91bmQgZXZlbnQgaGFuZGxlci4KCQkJdmFyIG9sZF9oYW5kbGVyID0gaGFuZGxlT2JqLmhhbmRsZXI7CgoKCQkJaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBNb2RpZnkgZXZlbnQgb2JqZWN0LCBhZGRpbmcgdGhlIC5vcmllbnRhdGlvbiBwcm9wZXJ0eS4KCQkJCWV2ZW50Lm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkJLy8gQ2FsbCB0aGUgb3JpZ2luYWxseS1ib3VuZCBldmVudCBoYW5kbGVyIGFuZCByZXR1cm4gaXRzIHJlc3VsdC4KCQkJCXJldHVybiBvbGRfaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoJfSk7CgoJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoaXMgaGFuZGxlciB3aWxsIGJlIGJvdW5kIHRvCgkvLyB0aGUgd2luZG93IHJlc2l6ZSBldmVudCB0byBzaW11bGF0ZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQuCglmdW5jdGlvbiBoYW5kbGVyKCkgewoJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbi4KCQl2YXIgb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJaWYgKCBvcmllbnRhdGlvbiAhPT0gbGFzdF9vcmllbnRhdGlvbiApIHsKCQkJLy8gVGhlIG9yaWVudGF0aW9uIGhhcyBjaGFuZ2VkLCBzbyB0cmlnZ2VyIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCQkJbGFzdF9vcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uOwoJCQl3aW4udHJpZ2dlciggZXZlbnRfbmFtZSApOwoJCX0KCX0KCgkvLyBHZXQgdGhlIGN1cnJlbnQgcGFnZSBvcmllbnRhdGlvbi4gVGhpcyBtZXRob2QgaXMgZXhwb3NlZCBwdWJsaWNseSwgc2hvdWxkIGl0CgkvLyBiZSBuZWVkZWQsIGFzIGpRdWVyeS5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uKCkKCSQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXZhciBpc1BvcnRyYWl0ID0gdHJ1ZSwgZWxlbSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCgkJLy8gcHJlZmVyIHdpbmRvdyBvcmllbnRhdGlvbiB0byB0aGUgY2FsY3VsYXRpb24gYmFzZWQgb24gc2NyZWVuc2l6ZSBhcwoJCS8vIHRoZSBhY3R1YWwgc2NyZWVuIHJlc2l6ZSB0YWtlcyBwbGFjZSBiZWZvcmUgb3IgYWZ0ZXIgdGhlIG9yaWVudGF0aW9uIGNoYW5nZSBldmVudAoJCS8vIGhhcyBiZWVuIGZpcmVkIGRlcGVuZGluZyBvbiBpbXBsZW1lbnRhdGlvbiAoZWcgYW5kcm9pZCAyLjMgaXMgYmVmb3JlLCBpcGhvbmUgYWZ0ZXIpLgoJCS8vIE1vcmUgdGVzdGluZyBpcyByZXF1aXJlZCB0byBkZXRlcm1pbmUgaWYgYSBtb3JlIHJlbGlhYmxlIG1ldGhvZCBvZiBkZXRlcm1pbmluZyB0aGUgbmV3IHNjcmVlbnNpemUKCQkvLyBpcyBwb3NzaWJsZSB3aGVuIG9yaWVudGF0aW9uY2hhbmdlIGlzIGZpcmVkLiAoZWcsIHVzZSBtZWRpYSBxdWVyaWVzICsgZWxlbWVudCArIG9wYWNpdHkpCgkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgkJCS8vIGlmIHRoZSB3aW5kb3cgb3JpZW50YXRpb24gcmVnaXN0ZXJzIGFzIDAgb3IgMTgwIGRlZ3JlZXMgcmVwb3J0CgkJCS8vIHBvcnRyYWl0LCBvdGhlcndpc2UgbGFuZHNjYXBlCgkJCWlzUG9ydHJhaXQgPSBwb3J0cmFpdF9tYXBbIHdpbmRvdy5vcmllbnRhdGlvbiBdOwoJCX0gZWxzZSB7CgkJCWlzUG9ydHJhaXQgPSBlbGVtICYmIGVsZW0uY2xpZW50V2lkdGggLyBlbGVtLmNsaWVudEhlaWdodCA8IDEuMTsKCQl9CgoJCXJldHVybiBpc1BvcnRyYWl0ID8gInBvcnRyYWl0IiA6ICJsYW5kc2NhcGUiOwoJfTsKCgkkLmZuWyBldmVudF9uYW1lIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBldmVudF9uYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBldmVudF9uYW1lICk7Cgl9OwoKCS8vIGpRdWVyeSA8IDEuOAoJaWYgKCAkLmF0dHJGbiApIHsKCQkkLmF0dHJGblsgZXZlbnRfbmFtZSBdID0gdHJ1ZTsKCX0KCn0oIGpRdWVyeSwgdGhpcyApKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CiQubW9iaWxlLndpZGdldHMgPSB7fTsKCnZhciBvcmlnaW5hbFdpZGdldCA9ICQud2lkZ2V0OwoKJC53aWRnZXQgPSAoZnVuY3Rpb24oIG9yaWcgKSB7CglyZXR1cm4gZnVuY3Rpb24oKSB7CgkJdmFyIGNvbnN0cnVjdG9yID0gb3JpZy5hcHBseSggdGhpcywgYXJndW1lbnRzICksCgkJCW5hbWUgPSBjb25zdHJ1Y3Rvci5wcm90b3R5cGUud2lkZ2V0TmFtZTsKCgkJY29uc3RydWN0b3IuaW5pdFNlbGVjdG9yID0gKCAoIGNvbnN0cnVjdG9yLnByb3RvdHlwZS5pbml0U2VsZWN0b3IgIT09IHVuZGVmaW5lZCApID8KCQkJY29uc3RydWN0b3IucHJvdG90eXBlLmluaXRTZWxlY3RvciA6ICI6anFtRGF0YShyb2xlPSciICsgbmFtZSArICInKSIgKTsKCgkJJC5tb2JpbGUud2lkZ2V0c1sgbmFtZSBdID0gY29uc3RydWN0b3I7CgoJCXJldHVybiBjb25zdHJ1Y3RvcjsKCX07Cn0pKCAkLndpZGdldCApOwoKLy8gTWFrZSBzdXJlICQud2lkZ2V0IHN0aWxsIGhhcyBicmlkZ2UgYW5kIGV4dGVuZCBtZXRob2RzCiQuZXh0ZW5kKCAkLndpZGdldCwgb3JpZ2luYWxXaWRnZXQgKTsKCi8vIEZvciBiYWNrY29tcGF0IHJlbW92ZSBpbiAxLjUKJC5tb2JpbGUuZG9jdW1lbnQub24oICJjcmVhdGUiLCBmdW5jdGlvbiggZXZlbnQgKXsKCSQoIGV2ZW50LnRhcmdldCApLmVuaGFuY2VXaXRoaW4oKTsKfSk7CgokLndpZGdldCggIm1vYmlsZS5wYWdlIiwgewoJb3B0aW9uczogewoJCXRoZW1lOiAiYSIsCgkJZG9tQ2FjaGU6IGZhbHNlLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJa2VlcE5hdGl2ZURlZmF1bHQ6ICQubW9iaWxlLmtlZXBOYXRpdmUsCgkJY29udGVudFRoZW1lOiBudWxsLAoJCWVuaGFuY2VkOiBmYWxzZQoJfSwKCgkvLyBERVBSRUNBVEVEIGZvciA+IDEuNAoJLy8gVE9ETyByZW1vdmUgYXQgMS41CglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbigpIHsKCQkkLldpZGdldC5wcm90b3R5cGUuX2NyZWF0ZVdpZGdldC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJdGhpcy5fdHJpZ2dlciggImluaXQiICk7Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCS8vIElmIGZhbHNlIGlzIHJldHVybmVkIGJ5IHRoZSBjYWxsYmFja3MgZG8gbm90IGNyZWF0ZSB0aGUgcGFnZQoJCWlmICggdGhpcy5fdHJpZ2dlciggImJlZm9yZWNyZWF0ZSIgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgkJdGhpcy5fb24oIHRoaXMuZWxlbWVudCwgewoJCQlwYWdlYmVmb3JlaGlkZTogInJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQiLAoJCQlwYWdlYmVmb3Jlc2hvdzogIl9oYW5kbGVQYWdlQmVmb3JlU2hvdyIKCQl9KTsKCgkJdGhpcy5lbGVtZW50LmVuaGFuY2VXaXRoaW4oKTsKCQkvLyBEaWFsb2cgd2lkZ2V0IGlzIGRlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSB0aGlzIGluIDEuNQoJCWlmKCAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMuZWxlbWVudFswXSwgInJvbGUiICkgPT09ICJkaWFsb2ciICYmICQubW9iaWxlLmRpYWxvZyApewoJCQl0aGlzLmVsZW1lbnQuZGlhbG9nKCk7CgkJfQoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24gKCl7CgkJdmFyIGF0dHJQcmVmaXggPSAiZGF0YS0iICsgJC5tb2JpbGUubnMsCgkJCXNlbGYgPSB0aGlzOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5yb2xlICkgewoJCQl0aGlzLmVsZW1lbnQuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGUiLCB0aGlzLm9wdGlvbnMucm9sZSApOwoJCX0KCgkJdGhpcy5lbGVtZW50CgkJCS5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1wYWdlIHVpLXBhZ2UtdGhlbWUtIiArIHRoaXMub3B0aW9ucy50aGVtZSApOwoKCQkvLyBNYW5pcHVsYXRpb24gb2YgY29udGVudCBvcyBEZXByZWNhdGVkIGFzIG9mIDEuNCByZW1vdmUgaW4gMS41CgkJdGhpcy5lbGVtZW50LmZpbmQoICJbIiArIGF0dHJQcmVmaXggKyAicm9sZT0nY29udGVudCddIiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQl0aGVtZSA9IHRoaXMuZ2V0QXR0cmlidXRlKCBhdHRyUHJlZml4ICsgInRoZW1lIiApIHx8IHVuZGVmaW5lZDsKCQkJCXNlbGYub3B0aW9ucy5jb250ZW50VGhlbWUgPSB0aGVtZSB8fCBzZWxmLm9wdGlvbnMuY29udGVudFRoZW1lIHx8ICggc2VsZi5vcHRpb25zLmRpYWxvZyAmJiBzZWxmLm9wdGlvbnMudGhlbWUgKSB8fCAoIHNlbGYuZWxlbWVudC5qcW1EYXRhKCJyb2xlIikgPT09ICJkaWFsb2ciICYmICBzZWxmLm9wdGlvbnMudGhlbWUgKTsKCQkJCSR0aGlzLmFkZENsYXNzKCAidWktY29udGVudCIgKTsKCQkJCWlmICggc2VsZi5vcHRpb25zLmNvbnRlbnRUaGVtZSApIHsKCQkJCQkkdGhpcy5hZGRDbGFzcyggInVpLWJvZHktIiArICggc2VsZi5vcHRpb25zLmNvbnRlbnRUaGVtZSApICk7CgkJCQl9CgkJCQkvLyBBZGQgQVJJQSByb2xlCgkJCQkkdGhpcy5hdHRyKCAicm9sZSIsICJtYWluIiApLmFkZENsYXNzKCAidWktY29udGVudCIgKTsKCQl9KTsKCX0sCgoJYmluZFJlbW92ZTogZnVuY3Rpb24oIGNhbGxiYWNrICkgewoJCXZhciBwYWdlID0gdGhpcy5lbGVtZW50OwoKCQkvLyB3aGVuIGRvbSBjYWNoaW5nIGlzIG5vdCBlbmFibGVkIG9yIHRoZSBwYWdlIGlzIGVtYmVkZGVkIGJpbmQgdG8gcmVtb3ZlIHRoZSBwYWdlIG9uIGhpZGUKCQlpZiAoICFwYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5vcHRpb25zLmRvbUNhY2hlICYmCgkJCXBhZ2UuaXMoICI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiICkgKSB7CgoJCQkvLyBUT0RPIHVzZSBfb24gLSB0aGF0IGlzLCBzb3J0IG91dCB3aHkgaXQgZG9lc24ndCB3b3JrIGluIHRoaXMgY2FzZQoJCQlwYWdlLmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiLCBjYWxsYmFjayB8fCBmdW5jdGlvbigvKiBlICovKSB7CgkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQkJcHJFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZXJlbW92ZSIgKTsKCgkJCQkkdGhpcy50cmlnZ2VyKCBwckV2ZW50ICk7CgoJCQkJaWYgKCAhcHJFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQkkdGhpcy5yZW1vdmVXaXRoRGVwZW5kZW50cygpOwoJCQkJfQoJCQl9KTsKCQl9Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggbyApIHsKCQlpZiAoIG8udGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktYm9keS0iICsgdGhpcy5vcHRpb25zLnRoZW1lICkuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyBvLnRoZW1lICk7CgkJfQoKCQlpZiAoIG8uY29udGVudFRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5maW5kKCAiW2RhdGEtIiArICQubW9iaWxlLm5zICsgIj0nY29udGVudCddIiApLnJlbW92ZUNsYXNzKCAidWktYm9keS0iICsgdGhpcy5vcHRpb25zLmNvbnRlbnRUaGVtZSApCgkJCQkuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyBvLmNvbnRlbnRUaGVtZSApOwoJCX0KCX0sCgoJX2hhbmRsZVBhZ2VCZWZvcmVTaG93OiBmdW5jdGlvbigvKiBlICovKSB7CgkJdGhpcy5zZXRDb250YWluZXJCYWNrZ3JvdW5kKCk7Cgl9LAoJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJcmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZDogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmNsb3Nlc3QoICI6bW9iaWxlLWNvbnRlbnQiICkuY29udGVudCh7ICJ0aGVtZSI6ICJub25lIiB9KTsKCX0sCgkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkvLyBzZXQgdGhlIHBhZ2UgY29udGFpbmVyIGJhY2tncm91bmQgdG8gdGhlIHBhZ2UgdGhlbWUKCXNldENvbnRhaW5lckJhY2tncm91bmQ6IGZ1bmN0aW9uKCB0aGVtZSApIHsKCQl0aGlzLmVsZW1lbnQucGFyZW50KCkuY29udGVudCggeyAidGhlbWUiOiB0aGVtZSB8fCB0aGlzLm9wdGlvbnMudGhlbWUgfSApOwoJfSwKCS8vIERlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCWtlZXBOYXRpdmVTZWxlY3RvcjogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWtlZXBOYXRpdmVEZWZpbmVkID0gb3B0aW9ucy5rZWVwTmF0aXZlICYmICQudHJpbSggb3B0aW9ucy5rZWVwTmF0aXZlICk7CgoJCWlmICgga2VlcE5hdGl2ZURlZmluZWQgJiYgb3B0aW9ucy5rZWVwTmF0aXZlICE9PSBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0ICkgewoJCQlyZXR1cm4gW29wdGlvbnMua2VlcE5hdGl2ZSwgb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdF0uam9pbiggIiwgIiApOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHQ7Cgl9Cn0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS5jb250ZW50IiwgewoJCW9wdGlvbnM6IHsKCQkJdGhlbWU6ICJhIgoJCX0sCgoJCWluaXRTZWxlY3RvcjogZmFsc2UsCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJHdpbmRvdyA9ICQoIHdpbmRvdyApOwoKCQkJdGhpcy5zZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7CgoJCQkvLyBUT0RPIGNvbnNpZGVyIG1vdmluZyB0aGUgbmF2aWdhdGlvbiBoYW5kbGVyIE9VVCBvZiB3aWRnZXQgaW50bwoJCQkvLyAgICAgIHNvbWUgb3RoZXIgb2JqZWN0IGFzIGdsdWUgYmV0d2VlbiB0aGUgbmF2aWdhdGUgZXZlbnQgYW5kIHRoZQoJCQkvLyAgICAgIGNvbnRlbnQgd2lkZ2V0IGxvYWQgYW5kIGNoYW5nZSBtZXRob2RzCgkJCXRoaXMuX29uKCAkd2luZG93LCB7IG5hdmlnYXRlOiAiX2ZpbHRlck5hdmlnYXRlRXZlbnRzIiB9KTsKCgkJCXRoaXMuX29uKCAkd2luZG93LCB7CgkJCQkvLyBkaXNhYmxlIGFuIHNjcm9sbCBzZXR0aW5nIHdoZW4gYSBoYXNoY2hhbmdlIGhhcyBiZWVuIGZpcmVkLAoJCQkJLy8gdGhpcyBvbmx5IHdvcmtzIGJlY2F1c2UgdGhlIHJlY29yZGluZyBvZiB0aGUgc2Nyb2xsIHBvc2l0aW9uCgkJCQkvLyBpcyBkZWxheWVkIGZvciAxMDBtcyBhZnRlciB0aGUgYnJvd3NlciBtaWdodCBoYXZlIGNoYW5nZWQgdGhlCgkJCQkvLyBwb3NpdGlvbiBiZWNhdXNlIG9mIHRoZSBoYXNoY2hhbmdlCgkJCQluYXZpZ2F0ZTogIl9kaXNhYmxlUmVjb3JkU2Nyb2xsIiwKCgkJCQkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgZm9yIHRoZSBmaXJzdCBwYWdlLCAicGFnZWNoYW5nZSIgd29uJ3QgYmUKCQkJCS8vIGZpcmVkIGluIHRoYXQgY2FzZQoJCQkJc2Nyb2xsc3RvcDogIl9kZWxheWVkUmVjb3JkU2Nyb2xsIgoJCQl9KTsKCgkJCS8vIFRPRE8gbW92ZSBmcm9tIHBhZ2UqIGV2ZW50cyB0byBjb250ZW50KiBldmVudHMKCQkJdGhpcy5fb24oeyBwYWdlY2hhbmdlOiAiX2FmdGVyQ29udGVudENoYW5nZSIgfSk7CgoJCQkvLyBoYW5kbGUgaW5pdGlhbCBoYXNoY2hhbmdlIGZyb20gY2hyb21lIDooCgkJCSR3aW5kb3cub25lKCAibmF2aWdhdGUiLCAkLnByb3h5KGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5zZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7CgkJCX0sIHRoaXMpKTsKCQl9LAoKCQlfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKXsKCQkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgJiYgb3B0aW9ucy50aGVtZSAhPT0gIm5vbmUiICkgewoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktb3ZlcmxheS0iICsgdGhpcy5vcHRpb25zLnRoZW1lICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyBvcHRpb25zLnRoZW1lICk7CgkJCX0gZWxzZSBpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLW92ZXJsYXktIiArIHRoaXMub3B0aW9ucy50aGVtZSApOwoJCQl9CgoJCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJCX0sCgoJCV9kaXNhYmxlUmVjb3JkU2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5zZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IGZhbHNlOwoJCX0sCgoJCV9lbmFibGVSZWNvcmRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCQl9LAoKCQkvLyBUT0RPIGNvbnNpZGVyIHRoZSBuYW1lIGhlcmUsIHNpbmNlIGl0J3MgcHVycG9zZSBzcGVjaWZpYwoJCV9hZnRlckNvbnRlbnRDaGFuZ2U6ICBmdW5jdGlvbigpIHsKCQkJLy8gb25jZSB0aGUgcGFnZSBoYXMgY2hhbmdlZCwgcmUtZW5hYmxlIHRoZSBzY3JvbGwgcmVjb3JkaW5nCgkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoKCQkJLy8gcmVtb3ZlIGFueSBiaW5kaW5nIHRoYXQgcHJldmlvdXNseSBleGlzdGVkIG9uIHRoZSBnZXQgc2Nyb2xsCgkJCS8vIHdoaWNoIG1heSBvciBtYXkgbm90IGJlIGRpZmZlcmVudCB0aGFuIHRoZSBzY3JvbGwgZWxlbWVudAoJCQkvLyBkZXRlcm1pbmVkIGZvciB0aGlzIHBhZ2UgcHJldmlvdXNseQoJCQl0aGlzLl9vZmYoICR3aW5kb3csICJzY3JvbGxzdG9wIiApOwoKCQkJLy8gZGV0ZXJtaW5lIGFuZCBiaW5kIHRvIHRoZSBjdXJyZW50IHNjb2xsIGVsZW1lbnQgd2hpY2ggbWF5IGJlIHRoZQoJCQkvLyB3aW5kb3cgb3IgaW4gdGhlIGNhc2Ugb2YgdG91Y2ggb3ZlcmZsb3cgdGhlIGVsZW1lbnQgdG91Y2ggb3ZlcmZsb3cKCQkJdGhpcy5fb24oICR3aW5kb3csIHsgc2Nyb2xsc3RvcDogIl9kZWxheWVkUmVjb3JkU2Nyb2xsIiB9KTsKCQl9LAoKCQlfcmVjb3JkU2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJLy8gdGhpcyBiYXJyaWVyIHByZXZlbnRzIHNldHRpbmcgdGhlIHNjcm9sbCB2YWx1ZSBiYXNlZCBvbgoJCQkvLyB0aGUgYnJvd3NlciBzY3JvbGxpbmcgdGhlIHdpbmRvdyBiYXNlZCBvbiBhIGhhc2hjaGFuZ2UKCQkJaWYgKCAhdGhpcy5zZXRMYXN0U2Nyb2xsRW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGFjdGl2ZSA9IHRoaXMuX2dldEFjdGl2ZUhpc3RvcnkoKSwKCQkJCWN1cnJlbnRTY3JvbGwsIG1pblNjcm9sbCwgZGVmYXVsdFNjcm9sbDsKCgkJCWlmICggYWN0aXZlICkgewoJCQkJY3VycmVudFNjcm9sbCA9IHRoaXMuX2dldFNjcm9sbCgpOwoJCQkJbWluU2Nyb2xsID0gdGhpcy5fZ2V0TWluU2Nyb2xsKCk7CgkJCQlkZWZhdWx0U2Nyb2xsID0gdGhpcy5fZ2V0RGVmYXVsdFNjcm9sbCgpOwoKCQkJCS8vIFNldCBhY3RpdmUgcGFnZSdzIGxhc3RTY3JvbGwgcHJvcC4gSWYgdGhlIGxvY2F0aW9uIHdlJ3JlCgkJCQkvLyBzY3JvbGxpbmcgdG8gaXMgbGVzcyB0aGFuIG1pblNjcm9sbEJhY2ssIGxldCBpdCBnby4KCQkJCWFjdGl2ZS5sYXN0U2Nyb2xsID0gY3VycmVudFNjcm9sbCA8IG1pblNjcm9sbCA/IGRlZmF1bHRTY3JvbGwgOiBjdXJyZW50U2Nyb2xsOwoJCQl9CgkJfSwKCgkJX2RlbGF5ZWRSZWNvcmRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQlzZXRUaW1lb3V0KCAkLnByb3h5KHRoaXMsICJfcmVjb3JkU2Nyb2xsIiksIDEwMCApOwoJCX0sCgoJCV9nZXRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJHdpbmRvdy5zY3JvbGxUb3AoKTsKCQl9LAoKCQlfZ2V0TWluU2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLm1pblNjcm9sbEJhY2s7CgkJfSwKCgkJX2dldERlZmF1bHRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJfSwKCgkJX2ZpbHRlck5hdmlnYXRlRXZlbnRzOiBmdW5jdGlvbiggZSwgZGF0YSApIHsKCQkJdmFyIHVybDsKCgkJCWlmICggZS5vcmlnaW5hbEV2ZW50ICYmIGUub3JpZ2luYWxFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdXJsID0gZS5vcmlnaW5hbEV2ZW50LnR5cGUuaW5kZXhPZiggImhhc2hjaGFuZ2UiICkgPiAtMSA/IGRhdGEuc3RhdGUuaGFzaCA6IGRhdGEuc3RhdGUudXJsOwoKCQkJaWYgKCAhdXJsICkgewoJCQkJdXJsID0gdGhpcy5fZ2V0SGFzaCgpOwoJCQl9CgoJCQlpZiAoICF1cmwgfHwgdXJsID09PSAiIyIgfHwgdXJsLmluZGV4T2YoICIjIiArICQubW9iaWxlLnBhdGgudWlTdGF0ZUtleSApID09PSAwICl7CgkJCQl1cmwgPSBsb2NhdGlvbi5ocmVmOwoJCQl9CgoJCQl0aGlzLl9oYW5kbGVOYXZpZ2F0ZSggdXJsLCBkYXRhLnN0YXRlICk7CgkJfSwKCgkJX2dldEhhc2g6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQl9LAoKCQkvLyBUT0RPIGFjdGl2ZSBwYWdlIHNob3VsZCBiZSBtYW5hZ2VkIGJ5IHRoZSBjb250YWluZXIgKGllLCBpdCBzaG91bGQgYmUgYSBwcm9wZXJ0eSkKCQlfZ2V0QWN0aXZlQ29udGVudDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5hY3RpdmVQYWdlOwoJCX0sCgoJCS8vIFRPRE8gdGhlIGZpcnN0IHBhZ2Ugc2hvdWxkIGJlIGEgcHJvcGVydHkgc2V0IGR1cmluZyBjcmVhdCB1c2luZyB0aGUgbG9naWMKCQkvLyAgICAgIHRoYXQgY3VycmVudGx5IHJlc2lkZXMgaW4gaW5pdAoJCV9nZXRJbml0aWFsQ29udGVudDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5maXJzdFBhZ2U7CgkJfSwKCgkJLy8gVE9ETyBlYWNoIGNvbnRlbnQgY29udGFpbmVyIHNob3VsZCBoYXZlIGEgaGlzdG9yeSBvYmplY3QKCQlfZ2V0SGlzdG9yeTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB1cmxIaXN0b3J5OwoJCX0sCgoJCS8vIFRPRE8gdXNlIF9nZXRIaXN0b3J5CgkJX2dldEFjdGl2ZUhpc3Rvcnk6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKTsKCQl9LAoKCQkvLyBUT0RPIHRoZSBkb2N1bWVudCBiYXNlIHNob3VsZCBiZSBkZXRlcm1pbmVkIGF0IGNyZWF0aW9uCgkJX2dldERvY3VtZW50QmFzZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiBkb2N1bWVudEJhc2U7CgkJfSwKCgkJX2JhY2s6IGZ1bmN0aW9uKCkgewoJCQkkLm1vYmlsZS5iYWNrKCk7CgkJfSwKCgkJX2ZvcndhcmQ6IGZ1bmN0aW9uKCkgewoJCQl3aW5kb3cuaGlzdG9yeS5mb3J3YXJkKCk7CgkJfSwKCgkJLy8gVE9ETyByZW5hbWUgX2hhbmRsZURlc3RpbmF0aW9uCgkJX2hhbmRsZURlc3RpbmF0aW9uOiBmdW5jdGlvbiggdG8gKSB7CgkJCXZhciBoaXN0b3J5LCBkb2N1bWVudEJhc2U7CgoJCQkvLyBjbGVhbiB0aGUgaGFzaCBmb3IgY29tcGFyaXNvbiBpZiBpdCdzIGEgdXJsCgkJCWlmICggJC50eXBlKHRvKSA9PT0gInN0cmluZyIgKSB7CgkJCQl0byA9IHBhdGguc3RyaXBIYXNoKHRvKTsKCQkJfQoKCQkJaWYgKCB0byApIHsKCQkJCWhpc3RvcnkgPSB0aGlzLl9nZXRIaXN0b3J5KCksCgkJCQlkb2N1bWVudEJhc2UgPSB0aGlzLl9nZXREb2N1bWVudEJhc2UoKTsKCgkJCQkvLyBBdCB0aGlzIHBvaW50LCAndG8nIGNhbiBiZSBvbmUgb2YgMyB0aGluZ3MsIGEgY2FjaGVkIHBhZ2UKCQkJCS8vIGVsZW1lbnQgZnJvbSBhIGhpc3Rvcnkgc3RhY2sgZW50cnksIGFuIGlkLCBvciBzaXRlLXJlbGF0aXZlIC8KCQkJCS8vIGFic29sdXRlIFVSTC4gSWYgJ3RvJyBpcyBhbiBpZCwgd2UgbmVlZCB0byByZXNvbHZlIGl0IGFnYWluc3QKCQkJCS8vIHRoZSBkb2N1bWVudEJhc2UsIG5vdCB0aGUgbG9jYXRpb24uaHJlZiwgc2luY2UgdGhlIGhhc2hjaGFuZ2UKCQkJCS8vIGNvdWxkJ3ZlIGJlZW4gdGhlIHJlc3VsdCBvZiBhIGZvcndhcmQvYmFja3dhcmQgbmF2aWdhdGlvbgoJCQkJLy8gdGhhdCBjcm9zc2VzIGZyb20gYW4gZXh0ZXJuYWwgcGFnZS9kaWFsb2cgdG8gYW4gaW50ZXJuYWwKCQkJCS8vIHBhZ2UvZGlhbG9nLgoJCQkJLy8KCQkJCS8vIFRPRE8gbW92ZSBjaGVjayB0byBoaXN0b3J5IG9iamVjdCBvciBwYXRoIG9iamVjdD8KCQkJCXRvID0gIXBhdGguaXNQYXRoKCB0byApID8gKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgdG8sIGRvY3VtZW50QmFzZSApICkgOiB0bzsKCgkJCQkvLyBJZiB3ZSdyZSBhYm91dCB0byBnbyB0byBhbiBpbml0aWFsIFVSTCB0aGF0IGNvbnRhaW5zIGEKCQkJCS8vIHJlZmVyZW5jZSB0byBhIG5vbi1leGlzdGVudCBpbnRlcm5hbCBwYWdlLCBnbyB0byB0aGUgZmlyc3QKCQkJCS8vIHBhZ2UgaW5zdGVhZC4gV2Uga25vdyB0aGF0IHRoZSBpbml0aWFsIGhhc2ggcmVmZXJzIHRvIGEKCQkJCS8vIG5vbi1leGlzdGVudCBwYWdlLCBiZWNhdXNlIHRoZSBpbml0aWFsIGhhc2ggZGlkIG5vdCBlbmQKCQkJCS8vIHVwIGluIHRoZSBpbml0aWFsIGhpc3RvcnkgZW50cnkKCQkJCS8vIFRPRE8gbW92ZSBjaGVjayB0byBoaXN0b3J5IG9iamVjdD8KCQkJCWlmICggdG8gPT09IHBhdGgubWFrZVVybEFic29sdXRlKCAiIyIgKyBoaXN0b3J5LmluaXRpYWxEc3QsIGRvY3VtZW50QmFzZSApICYmCgkJCQkJaGlzdG9yeS5zdGFjay5sZW5ndGggJiYKCQkJCQloaXN0b3J5LnN0YWNrWzBdLnVybCAhPT0gaGlzdG9yeS5pbml0aWFsRHN0LnJlcGxhY2UoIGRpYWxvZ0hhc2hLZXksICIiICkgKSB7CgkJCQkJdG8gPSB0aGlzLl9nZXRJbml0aWFsQ29udGVudCgpOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gdG8gfHwgdGhpcy5fZ2V0SW5pdGlhbENvbnRlbnQoKTsKCQl9LAoKCQlfaGFuZGxlRGlhbG9nOiBmdW5jdGlvbiggY2hhbmdlUGFnZU9wdGlvbnMsIGRhdGEgKSB7CgkJCXZhciB0bywgYWN0aXZlLCBhY3RpdmVDb250ZW50ID0gdGhpcy5fZ2V0QWN0aXZlQ29udGVudCgpOwoKCQkJLy8gSWYgY3VycmVudCBhY3RpdmUgcGFnZSBpcyBub3QgYSBkaWFsb2cgc2tpcCB0aGUgZGlhbG9nIGFuZCBjb250aW51ZQoJCQkvLyBpbiB0aGUgc2FtZSBkaXJlY3Rpb24KCQkJaWYgKCBhY3RpdmVDb250ZW50ICYmICFhY3RpdmVDb250ZW50Lmhhc0NsYXNzKCAidWktZGlhbG9nIiApICkgewoJCQkJLy8gZGV0ZXJtaW5lIGlmIHdlJ3JlIGhlYWRpbmcgZm9yd2FyZCBvciBiYWNrd2FyZCBhbmQgY29udGludWUKCQkJCS8vIGFjY29yZGluZ2x5IHBhc3QgdGhlIGN1cnJlbnQgZGlhbG9nCgkJCQlpZiAoIGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIgKSB7CgkJCQkJdGhpcy5fYmFjaygpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLl9mb3J3YXJkKCk7CgkJCQl9CgoJCQkJLy8gcHJldmVudCBjaGFuZ2VQYWdlIGNhbGwKCQkJCXJldHVybiBmYWxzZTsKCQkJfSBlbHNlIHsKCQkJCS8vIGlmIHRoZSBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIGEgZGlhbG9nIGFuZCB3ZSdyZSBuYXZpZ2F0aW5nCgkJCQkvLyB0byBhIGRpYWxvZyB1c2UgdGhlIGRpYWxvZyBvYmplY3RlZCBzYXZlZCBpbiB0aGUgc3RhY2sKCQkJCXRvID0gZGF0YS5wYWdlVXJsOwoJCQkJYWN0aXZlID0gdGhpcy5fZ2V0QWN0aXZlSGlzdG9yeSgpOwoKCQkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHJvbGUsIHRyYW5zaXRpb24gYW5kIHJldmVyc2FsCgkJCQkvLyBhcyBtb3N0IG9mIHRoaXMgaXMgbG9zdCBieSB0aGUgZG9tQ2FjaGUgY2xlYW5pbmcKCQkJCSQuZXh0ZW5kKCBjaGFuZ2VQYWdlT3B0aW9ucywgewoJCQkJCXJvbGU6IGFjdGl2ZS5yb2xlLAoJCQkJCXRyYW5zaXRpb246IGFjdGl2ZS50cmFuc2l0aW9uLAoJCQkJCXJldmVyc2U6IGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIKCQkJCX0pOwoJCQl9CgoJCQlyZXR1cm4gdG87CgkJfSwKCgkJX2hhbmRsZU5hdmlnYXRlOiBmdW5jdGlvbiggdXJsLCBkYXRhICkgewoJCQkvL2ZpbmQgZmlyc3QgcGFnZSB2aWEgaGFzaAoJCQkvLyBUT0RPIHN0cmlwaW5nIHRoZSBoYXNoIHR3aWNlIHdpdGggaGFuZGxlVXJsCgkJCXZhciB0byA9IHBhdGguc3RyaXBIYXNoKHVybCksIGhpc3RvcnkgPSB0aGlzLl9nZXRIaXN0b3J5KCksCgoJCQkJLy8gdHJhbnNpdGlvbiBpcyBmYWxzZSBpZiBpdCdzIHRoZSBmaXJzdCBwYWdlLCB1bmRlZmluZWQKCQkJCS8vIG90aGVyd2lzZSAoYW5kIG1heSBiZSBvdmVycmlkZGVuIGJ5IGRlZmF1bHQpCgkJCQl0cmFuc2l0aW9uID0gaGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDAgPyAibm9uZSIgOiB1bmRlZmluZWQsCgoJCQkJLy8gZGVmYXVsdCBvcHRpb25zIGZvciB0aGUgY2hhbmdQYWdlIGNhbGxzIG1hZGUgYWZ0ZXIgZXhhbWluaW5nCgkJCQkvLyB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgcGFnZSBhbmQgdGhlIGhhc2gsIE5PVEUgdGhhdCB0aGUKCQkJCS8vIHRyYW5zaXRpb24gaXMgZGVyaXZlZCBmcm9tIHRoZSBwcmV2aW91cyBoaXN0b3J5IGVudHJ5CgkJCQljaGFuZ2VQYWdlT3B0aW9ucyA9IHsKCQkJCQljaGFuZ2VIYXNoOiBmYWxzZSwKCQkJCQlmcm9tSGFzaENoYW5nZTogdHJ1ZSwKCQkJCQlyZXZlcnNlOiBkYXRhLmRpcmVjdGlvbiA9PT0gImJhY2siCgkJCQl9OwoKCQkJJC5leHRlbmQoIGNoYW5nZVBhZ2VPcHRpb25zLCBkYXRhLCB7CgkJCQl0cmFuc2l0aW9uOiAoaGlzdG9yeS5nZXRMYXN0KCkgfHwge30pLnRyYW5zaXRpb24gfHwgdHJhbnNpdGlvbgoJCQl9KTsKCgkJCS8vIFRPRE8gbW92ZSB0byBfaGFuZGxlRGVzdGluYXRpb24gPwoJCQkvLyBJZiB0aGlzIGlzbid0IHRoZSBmaXJzdCBwYWdlLCBpZiB0aGUgY3VycmVudCB1cmwgaXMgYSBkaWFsb2cgaGFzaAoJCQkvLyBrZXksIGFuZCB0aGUgaW5pdGlhbCBkZXN0aW5hdGlvbiBpc24ndCBlcXVhbCB0byB0aGUgY3VycmVudCB0YXJnZXQKCQkJLy8gcGFnZSwgdXNlIHRoZSBzcGVjaWFsIGRpYWxvZyBoYW5kbGluZwoJCQlpZiAoIGhpc3RvcnkuYWN0aXZlSW5kZXggPiAwICYmCgkJCQl0by5pbmRleE9mKCBkaWFsb2dIYXNoS2V5ICkgPiAtMSAmJgoJCQkJaGlzdG9yeS5pbml0aWFsRHN0ICE9PSB0byApIHsKCgkJCQl0byA9IHRoaXMuX2hhbmRsZURpYWxvZyggY2hhbmdlUGFnZU9wdGlvbnMsIGRhdGEgKTsKCgkJCQlpZiAoIHRvID09PSBmYWxzZSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCgkJCXRoaXMuX2NoYW5nZUNvbnRlbnQoIHRoaXMuX2hhbmRsZURlc3RpbmF0aW9uKHRvKSwgY2hhbmdlUGFnZU9wdGlvbnMgKTsKCQl9LAoKCQlfY2hhbmdlQ29udGVudDogZnVuY3Rpb24oIHRvLCBvcHRzICkgewoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCB0bywgb3B0cyApOwoJCX0sCgoJCV9nZXRCYXNlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIGJhc2U7CgkJfSwKCgkJX2dldEJhc2VXaXRoRGVmYXVsdDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiBmaW5kQmFzZVdpdGhEZWZhdWx0KCk7CgkJfSwKCgkJX2dldE5zOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLm5zOwoJCX0sCgoJCV9lbmhhbmNlOiBmdW5jdGlvbiggY29udGVudCwgcm9sZSApIHsKCQkJLy8gVE9ETyBjb25zaWRlciBzdXBwb3J0aW5nIGEgY3VzdG9tIGNhbGxiYWNrLCBhbmQgcGFzc2luZyBpbgoJCQkvLyB0aGUgc2V0dGluZ3Mgd2hpY2ggaW5jbHVkZXMgdGhlIHJvbGUKCQkJcmV0dXJuIGNvbnRlbnQucGFnZSh7IHJvbGU6IHJvbGUgfSk7CgkJfSwKCgkJX2luY2x1ZGU6IGZ1bmN0aW9uKCBwYWdlLCBzZXR0aW5ncyApIHsKCQkJLy8gYXBwZW5kIHRvIHBhZ2UgYW5kIGVuaGFuY2UKCQkJcGFnZS5hcHBlbmRUbyggdGhpcy5lbGVtZW50ICk7CgoJCQkvLyB1c2UgdGhlIHBhZ2Ugd2lkZ2V0IHRvIGVuaGFuY2UKCQkJdGhpcy5fZW5oYW5jZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkJLy8gcmVtb3ZlIHBhZ2Ugb24gaGlkZQoJCQlwYWdlLnBhZ2UoICJiaW5kUmVtb3ZlIiApOwoJCX0sCgoJCV9maW5kOiBmdW5jdGlvbiggYWJzVXJsICkgewoJCQkvLyBUT0RPIGNvbnNpZGVyIHN1cHBvcnRpbmcgYSBjdXN0b20gY2FsbGJhY2sKCQkJdmFyIGZpbGVVcmwgPSB0aGlzLl9jcmVhdGVGaWxlVXJsKCBhYnNVcmwgKSwKCQkJCWRhdGFVcmwgPSB0aGlzLl9jcmVhdGVEYXRhVXJsKCBhYnNVcmwgKSwKCQkJCXBhZ2UsIGluaXRpYWxDb250ZW50ID0gdGhpcy5fZ2V0SW5pdGlhbENvbnRlbnQoKTsKCgkJCS8vIENoZWNrIHRvIHNlZSBpZiB0aGUgcGFnZSBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgRE9NLgoJCQkvLyBOT1RFIGRvIF9ub3RfIHVzZSB0aGUgOmpxbURhdGEgcHN1ZWRvIHNlbGVjdG9yIGJlY2F1c2UgcGFyZW50aGVzaXMKCQkJLy8gICAgICBhcmUgYSB2YWxpZCB1cmwgY2hhciBhbmQgaXQgYnJlYWtzIG9uIHRoZSBmaXJzdCBvY2N1cmVuY2UKCQkJcGFnZSA9IHRoaXMuZWxlbWVudAoJCQkJLmNoaWxkcmVuKCAiW2RhdGEtIiArIHRoaXMuX2dldE5zKCkgKyJ1cmw9JyIgKyBkYXRhVXJsICsgIiddIiApOwoKCQkJLy8gSWYgd2UgZmFpbGVkIHRvIGZpbmQgdGhlIHBhZ2UsIGNoZWNrIHRvIHNlZSBpZiB0aGUgdXJsIGlzIGEKCQkJLy8gcmVmZXJlbmNlIHRvIGFuIGVtYmVkZGVkIHBhZ2UuIElmIHNvLCBpdCBtYXkgaGF2ZSBiZWVuIGR5bmFtaWNhbGx5CgkJCS8vIGluamVjdGVkIGJ5IGEgZGV2ZWxvcGVyLCBpbiB3aGljaCBjYXNlIGl0IHdvdWxkIGJlIGxhY2tpbmcgYQoJCQkvLyBkYXRhLXVybCBhdHRyaWJ1dGUgYW5kIGluIG5lZWQgb2YgZW5oYW5jZW1lbnQuCgkJCWlmICggcGFnZS5sZW5ndGggPT09IDAgJiYgZGF0YVVybCAmJiAhcGF0aC5pc1BhdGgoIGRhdGFVcmwgKSApIHsKCQkJCXBhZ2UgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oIHBhdGguaGFzaFRvU2VsZWN0b3IoIiMiICsgZGF0YVVybCkgKQoJCQkJCS5hdHRyKCAiZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJ1cmwiLCBkYXRhVXJsICkKCQkJCQkuanFtRGF0YSggInVybCIsIGRhdGFVcmwgKTsKCQkJfQoKCgkJCS8vIElmIHdlIGZhaWxlZCB0byBmaW5kIGEgcGFnZSBpbiB0aGUgRE9NLCBjaGVjayB0aGUgVVJMIHRvIHNlZSBpZiBpdAoJCQkvLyByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIGFwcGxpY2F0aW9uLiBBbHNvIENoZWNrIHRvIG1ha2Ugc3VyZQoJCQkvLyBvdXIgY2FjaGVkLWZpcnN0LXBhZ2UgaXMgYWN0dWFsbHkgaW4gdGhlIERPTS4gU29tZSB1c2VyIGRlcGxveWVkCgkJCS8vIGFwcHMgYXJlIHBydW5pbmcgdGhlIGZpcnN0IHBhZ2UgZnJvbSB0aGUgRE9NIGZvciB2YXJpb3VzIHJlYXNvbnMsCgkJCS8vIHdlIGNoZWNrIGZvciB0aGlzIGNhc2UgaGVyZSBiZWNhdXNlIHdlIGRvbid0IHdhbnQgYSBmaXJzdC1wYWdlIHdpdGgKCQkJLy8gYW4gaWQgZmFsbGluZyB0aHJvdWdoIHRvIHRoZSBub24tZXhpc3RlbnQgZW1iZWRkZWQgcGFnZSBlcnJvciBjYXNlLgoJCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICYmCgkJCQlwYXRoLmlzRmlyc3RQYWdlVXJsKGZpbGVVcmwpICYmCgkJCQlpbml0aWFsQ29udGVudCAmJgoJCQkJaW5pdGlhbENvbnRlbnQucGFyZW50KCkubGVuZ3RoICkgewoJCQkJcGFnZSA9ICQoIGluaXRpYWxDb250ZW50ICk7CgkJCX0KCgkJCXJldHVybiBwYWdlOwoJCX0sCgoJCV9nZXRMb2FkZXI6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUubG9hZGVyV2lkZ2V0OwoJCX0sCgoJCV9zaG93TG9hZGluZzogZnVuY3Rpb24oIGRlbGF5LCB0aGVtZSwgbXNnLCB0ZXh0b25seSApIHsKCQkJLy8gVGhpcyBjb25maWd1cmFibGUgdGltZW91dCBhbGxvd3MgY2FjaGVkIHBhZ2VzIGEgYnJpZWYKCQkJLy8gZGVsYXkgdG8gbG9hZCB3aXRob3V0IHNob3dpbmcgYSBtZXNzYWdlCgkJCXRoaXMuX2xvYWRNc2cgPSBzZXRUaW1lb3V0KCQucHJveHkoZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl9nZXRMb2FkZXIoKS5sb2FkZXIoICJzaG93IiwgdGhlbWUsIG1zZywgdGV4dG9ubHkgKTsKCQkJfSwgdGhpcyksIGRlbGF5ICk7CgkJfSwKCgkJX2hpZGVMb2FkaW5nOiBmdW5jdGlvbigpIHsKCQkJLy8gU3RvcCBtZXNzYWdlIHNob3cgdGltZXIKCQkJY2xlYXJUaW1lb3V0KCB0aGlzLl9sb2FkTXNnICk7CgoJCQkvLyBIaWRlIGxvYWRpbmcgbWVzc2FnZQoJCQl0aGlzLl9nZXRMb2FkZXIoKS5sb2FkZXIoICJoaWRlIiApOwoJCX0sCgoJCV9zaG93RXJyb3I6IGZ1bmN0aW9uKCkgewoJCQkvLyBtYWtlIHN1cmUgdG8gcmVtb3ZlIHRoZSBjdXJyZW50IGxvYWRpbmcgbWVzc2FnZQoJCQl0aGlzLl9oaWRlTG9hZGluZygpOwoKCQkJLy8gc2hvdyB0aGUgZXJyb3IgbWVzc2FnZQoJCQl0aGlzLl9zaG93TG9hZGluZyggMCwgJC5tb2JpbGUucGFnZUxvYWRFcnJvck1lc3NhZ2VUaGVtZSwgJC5tb2JpbGUucGFnZUxvYWRFcnJvck1lc3NhZ2UsIHRydWUgKTsKCgkJCS8vIGhpZGUgdGhlIGVycm9yIG1lc3NhZ2UgYWZ0ZXIgYSBkZWxheQoJCQkvLyBUT0RPIGNvbmZpZ3VyYXRpb24KCQkJc2V0VGltZW91dCggJC5wcm94eSh0aGlzLCAiX2hpZGVMb2FkaW5nIiksIDE1MDAgKTsKCQl9LAoKCQlfcGFyc2U6IGZ1bmN0aW9uKCBodG1sLCBmaWxlVXJsICkgewoJCQkvLyBUT0RPIGNvbnNpZGVyIGFsbG93aW5nIGN1c3RvbWl6YXRpb24gb2YgdGhpcyBtZXRob2QuIEl0J3MgdmVyeSBKUU0gc3BlY2lmaWMKCQkJdmFyIHBhZ2UsIGFsbCA9ICQoICI8ZGl2PjwvZGl2PiIgKTsKCgkJCS8vd29ya2Fyb3VuZCB0byBhbGxvdyBzY3JpcHRzIHRvIGV4ZWN1dGUgd2hlbiBpbmNsdWRlZCBpbiBwYWdlIGRpdnMKCQkJYWxsLmdldCggMCApLmlubmVySFRNTCA9IGh0bWw7CgoJCQlwYWdlID0gYWxsLmZpbmQoICI6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLmZpcnN0KCk7CgoJCQkvL2lmIHBhZ2UgZWxlbSBjb3VsZG4ndCBiZSBmb3VuZCwgY3JlYXRlIG9uZSBhbmQgaW5zZXJ0IHRoZSBib2R5IGVsZW1lbnQncyBjb250ZW50cwoJCQlpZiAoICFwYWdlLmxlbmd0aCApIHsKCQkJCXBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInJvbGU9J3BhZ2UnPiIgKwoJCQkJCSggaHRtbC5zcGxpdCggLzxcLz9ib2R5W14+XSo+L2dtaSApWzFdIHx8ICIiICkgKwoJCQkJCSI8L2Rpdj4iICk7CgkJCX0KCgkJCS8vIFRPRE8gdGFnaW5nIGEgcGFnZSB3aXRoIGV4dGVybmFsIHRvIG1ha2Ugc3VyZSB0aGF0IGVtYmVkZGVkIHBhZ2VzIGFyZW4ndAoJCQkvLyByZW1vdmVkIGJ5IHRoZSB2YXJpb3VzIHBhZ2UgaGFuZGxpbmcgY29kZSBpcyBiYWQuIEhhdmluZyBwYWdlIGhhbmRsaW5nIGNvZGUKCQkJLy8gaW4gbWFueSBwbGFjZXMgaXMgYmFkLiBTb2x1dGlvbnMgcG9zdCAxLjAKCQkJcGFnZS5hdHRyKCAiZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJ1cmwiLCBwYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoZmlsZVVybCkgKQoJCQkJLmF0dHIoICJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgImV4dGVybmFsLXBhZ2UiLCB0cnVlICk7CgoJCQlyZXR1cm4gcGFnZTsKCQl9LAoKCQlfc2V0TG9hZGVkVGl0bGU6IGZ1bmN0aW9uKCBwYWdlLCBodG1sICkgewoJCQkvL3BhZ2UgdGl0bGUgcmVnZXhwCgkJCXZhciBuZXdQYWdlVGl0bGUgPSBodG1sLm1hdGNoKCAvPHRpdGxlW14+XSo+KFtePF0qKS8gKSAmJiBSZWdFeHAuJDE7CgoJCQlpZiAoIG5ld1BhZ2VUaXRsZSAmJiAhcGFnZS5qcW1EYXRhKCJ0aXRsZSIpICkgewoJCQkJbmV3UGFnZVRpdGxlID0gJCggIjxkaXY+IiArIG5ld1BhZ2VUaXRsZSArICI8L2Rpdj4iICkudGV4dCgpOwoJCQkJcGFnZS5qcW1EYXRhKCAidGl0bGUiLCBuZXdQYWdlVGl0bGUgKTsKCQkJfQoJCX0sCgoJCV9pc1Jld3JpdGFibGVCYXNlVGFnOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmR5bmFtaWNCYXNlRW5hYmxlZCAmJiAhJC5zdXBwb3J0LmR5bmFtaWNCYXNlVGFnOwoJCX0sCgoJCV9jcmVhdGVEYXRhVXJsOiBmdW5jdGlvbiggYWJzb2x1dGVVcmwgKSB7CgkJCXJldHVybiBwYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoIGFic29sdXRlVXJsICk7CgkJfSwKCgkJX2NyZWF0ZUZpbGVVcmw6IGZ1bmN0aW9uKCBhYnNvbHV0ZVVybCApIHsKCQkJcmV0dXJuIHBhdGguZ2V0RmlsZVBhdGgoIGFic29sdXRlVXJsICk7CgkJfSwKCgkJX3RyaWdnZXJXaXRoRGVwcmVjYXRlZDogZnVuY3Rpb24oIG5hbWUsIGRhdGEsIHBhZ2UgKSB7CgkJCXZhciBkZXByZWNhdGVkRXZlbnQgPSAkLkV2ZW50KCAicGFnZSIgKyBuYW1lICksCgkJCQluZXdFdmVudCA9ICQuRXZlbnQoIHRoaXMud2lkZ2V0TmFtZSArIG5hbWUgKTsKCgkJCS8vIERFUFJFQ0FURUQKCQkJLy8gdHJpZ2dlciB0aGUgb2xkIGRlcHJlY2F0ZWQgZXZlbnQgb24gdGhlIHBhZ2UgaWYgaXQncyBwcm92aWRlZAoJCQkocGFnZSB8fCB0aGlzLmVsZW1lbnQpLnRyaWdnZXIoIGRlcHJlY2F0ZWRFdmVudCwgZGF0YSApOwoKCQkJLy8gdXNlIHRoZSB3aWRnZXQgdHJpZ2dlciBtZXRob2QgZm9yIHRoZSBuZXcgY29udGVudCogZXZlbnQKCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoIG5ld0V2ZW50LCBkYXRhICk7CgoJCQlyZXR1cm4gewoJCQkJZGVwcmVjYXRlZEV2ZW50OiBkZXByZWNhdGVkRXZlbnQsCgkJCQlldmVudDogbmV3RXZlbnQKCQkJfTsKCQl9LAoKCQkvLyBUT0RPIGl0IHdvdWxkIGJlIG5pY2UgdG8gc3BsaXQgdGhpcyB1cCBtb3JlIGJ1dCBldmVyeXRoaW5nIGFwcGVhcnMgdG8gYmUgIm9uZSBvZmYiCgkJLy8gICAgICBvciByZXF1aXJlIG9yZGVyaW5nIHN1Y2ggdGhhdCBvdGhlciBiaXRzIGFyZSBzcHJpbmtsZWQgaW4gYmV0d2VlbiBwYXJ0cyB0aGF0CgkJLy8gICAgICBjb3VsZCBiZSBhYnN0cmFjdGVkIG91dCBhcyBhIGdyb3VwCgkJX2xvYWRTdWNjZXNzOiBmdW5jdGlvbiggYWJzVXJsLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MsIGRlZmVycmVkICkgewoJCQl2YXIgZmlsZVVybCA9IHRoaXMuX2NyZWF0ZUZpbGVVcmwoIGFic1VybCApLAoJCQkJZGF0YVVybCA9IHRoaXMuX2NyZWF0ZURhdGFVcmwoIGFic1VybCApOwoKCQkJcmV0dXJuICQucHJveHkoZnVuY3Rpb24oIGh0bWwsIHRleHRTdGF0dXMsIHhociApIHsKCQkJCS8vcHJlLXBhcnNlIGh0bWwgdG8gY2hlY2sgZm9yIGEgZGF0YS11cmwsCgkJCQkvL3VzZSBpdCBhcyB0aGUgbmV3IGZpbGVVcmwsIGJhc2UgcGF0aCwgZXRjCgkJCQl2YXIgY29udGVudCwKCgkJCQkJLy8gVE9ETyBoYW5kbGUgZGlhbG9ncyBhZ2FpbgoJCQkJCXBhZ2VFbGVtUmVnZXggPSBuZXcgUmVnRXhwKCAiKDxbXj5dK1xcYmRhdGEtIiArIHRoaXMuX2dldE5zKCkgKyAicm9sZT1bXCInXT9wYWdlW1wiJ10/W14+XSo+KSIgKSwKCgkJCQkJZGF0YVVybFJlZ2V4ID0gbmV3IFJlZ0V4cCggIlxcYmRhdGEtIiArIHRoaXMuX2dldE5zKCkgKyAidXJsPVtcIiddPyhbXlwiJz5dKilbXCInXT8iICk7CgoJCQkJLy8gZGF0YS11cmwgbXVzdCBiZSBwcm92aWRlZCBmb3IgdGhlIGJhc2UgdGFnIHNvIHJlc291cmNlIHJlcXVlc3RzCgkJCQkvLyBjYW4gYmUgZGlyZWN0ZWQgdG8gdGhlIGNvcnJlY3QgdXJsLiBsb2FkaW5nIGludG8gYSB0ZW1wcm9yYXJ5CgkJCQkvLyBlbGVtZW50IG1ha2VzIHRoZXNlIHJlcXVlc3RzIGltbWVkaWF0ZWx5CgkJCQlpZiAoIHBhZ2VFbGVtUmVnZXgudGVzdCggaHRtbCApICYmCgkJCQkJUmVnRXhwLiQxICYmCgkJCQkJZGF0YVVybFJlZ2V4LnRlc3QoIFJlZ0V4cC4kMSApICYmCgkJCQkJUmVnRXhwLiQxICkgewoJCQkJCWZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCAkKCI8ZGl2PiIgKyBSZWdFeHAuJDEgKyAiPC9kaXY+IikudGV4dCgpICk7CgkJCQl9CgoJCQkJLy9kb250IHVwZGF0ZSB0aGUgYmFzZSB0YWcgaWYgd2UgYXJlIHByZWZldGNoaW5nCgkJCQlpZiAoIHNldHRpbmdzLnByZWZldGNoID09PSB1bmRlZmluZWQgKXsKCQkJCQl0aGlzLl9nZXRCYXNlKCkuc2V0KCBmaWxlVXJsICk7CgkJCQl9CgoJCQkJY29udGVudCA9IHRoaXMuX3BhcnNlKCBodG1sLCBmaWxlVXJsICk7CgoJCQkJdGhpcy5fc2V0TG9hZGVkVGl0bGUoIGNvbnRlbnQsIGh0bWwgKTsKCgkJCQkvLyByZXdyaXRlIHNyYyBhbmQgaHJlZiBhdHRycyB0byB1c2UgYSBiYXNlIHVybCBpZiB0aGUgYmFzZSB0YWcgd29uJ3Qgd29yawoJCQkJaWYgKCB0aGlzLl9pc1Jld3JpdGFibGVCYXNlVGFnKCkgJiYgY29udGVudCApIHsKCQkJCQl0aGlzLl9nZXRCYXNlKCkucmV3cml0ZSggZmlsZVVybCwgY29udGVudCApOwoJCQkJfQoKCQkJCXRoaXMuX2luY2x1ZGUoIGNvbnRlbnQsIHNldHRpbmdzICk7CgoJCQkJLy8gRW5oYW5jaW5nIHRoZSBjb250ZW50IG1heSByZXN1bHQgaW4gbmV3IGRpYWxvZ3Mvc3ViIGNvbnRlbnQgYmVpbmcgaW5zZXJ0ZWQKCQkJCS8vIGludG8gdGhlIERPTS4gSWYgdGhlIG9yaWdpbmFsIGFic1VybCByZWZlcnMgdG8gYSBzdWItY29udGVudCwgdGhhdCBpcyB0aGUKCQkJCS8vIHJlYWwgY29udGVudCB3ZSBhcmUgaW50ZXJlc3RlZCBpbi4KCQkJCWlmICggYWJzVXJsLmluZGV4T2YoICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSA+IC0xICkgewoJCQkJCWNvbnRlbnQgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICJbZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArInVybD0nIiArIGRhdGFVcmwgKyAiJ10iICk7CgkJCQl9CgoJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgkJCQkJdGhpcy5faGlkZUxvYWRpbmcoKTsKCQkJCX0KCgkJCQkvLyBBZGQgdGhlIGNvbnRlbnQgcmVmZXJlbmNlIGFuZCB4aHIgdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgoJCQkJLy8gREVQUkVDQVRFRAoJCQkJdHJpZ2dlckRhdGEucGFnZSA9IGNvbnRlbnQ7CgoJCQkJdHJpZ2dlckRhdGEuY29udGVudCA9IGNvbnRlbnQ7CgoJCQkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHRoZSBjb250ZW50IGxvYWRlZCBzdWNjZXNzZnVsbHkuCgkJCQl0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJsb2FkIiwgdHJpZ2dlckRhdGEgKTsKCgkJCQlkZWZlcnJlZC5yZXNvbHZlKCBhYnNVcmwsIHNldHRpbmdzLCBjb250ZW50ICk7CgkJCX0sIHRoaXMpOwoJCX0sCgoJCV9sb2FkRGVmYXVsdHM6IHsKCQkJdHlwZTogImdldCIsCgkJCWRhdGE6IHVuZGVmaW5lZCwKCgkJCS8vIERFUFJFQ0FURUQKCQkJcmVsb2FkUGFnZTogZmFsc2UsCgoJCQlyZWxvYWQ6IGZhbHNlLAoKCQkJLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCQlyb2xlOiB1bmRlZmluZWQsCgoJCQlzaG93TG9hZE1zZzogZmFsc2UsCgoJCQkvLyBUaGlzIGRlbGF5IGFsbG93cyBsb2FkcyB0aGF0IHB1bGwgZnJvbSBicm93c2VyIGNhY2hlIHRvCgkJCS8vIG9jY3VyIHdpdGhvdXQgc2hvd2luZyB0aGUgbG9hZGluZyBtZXNzYWdlLgoJCQlsb2FkTXNnRGVsYXk6IDUwCgkJfSwKCgkJbG9hZDogZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsKCQkJLy8gVGhpcyBmdW5jdGlvbiB1c2VzIGRlZmVycmVkIG5vdGlmaWNhdGlvbnMgdG8gbGV0IGNhbGxlcnMKCQkJLy8ga25vdyB3aGVuIHRoZSBjb250ZW50IGlzIGRvbmUgbG9hZGluZywgb3IgaWYgYW4gZXJyb3IgaGFzIG9jY3VycmVkLgoJCQl2YXIgZGVmZXJyZWQgPSBvcHRpb25zLmRlZmVycmVkIHx8ICQuRGVmZXJyZWQoKSwKCgkJCQkvLyBUaGUgZGVmYXVsdCBsb2FkIG9wdGlvbnMgd2l0aCBvdmVycmlkZXMgc3BlY2lmaWVkIGJ5IHRoZSBjYWxsZXIuCgkJCQlzZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgdGhpcy5fbG9hZERlZmF1bHRzLCBvcHRpb25zICksCgoJCQkJLy8gVGhlIERPTSBlbGVtZW50IGZvciB0aGUgY29udGVudCBhZnRlciBpdCBoYXMgYmVlbiBsb2FkZWQuCgkJCQljb250ZW50ID0gbnVsbCwKCgkJCQkvLyBUaGUgYWJzb2x1dGUgdmVyc2lvbiBvZiB0aGUgVVJMIHBhc3NlZCBpbnRvIHRoZSBmdW5jdGlvbi4gVGhpcwoJCQkJLy8gdmVyc2lvbiBvZiB0aGUgVVJMIG1heSBjb250YWluIGRpYWxvZy9zdWJjb250ZW50IHBhcmFtcyBpbiBpdC4KCQkJCWFic1VybCA9IHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIHRoaXMuX2dldEJhc2VXaXRoRGVmYXVsdCgpICksCgkJCQlmaWxlVXJsLCBkYXRhVXJsLCBwYmxFdmVudCwgdHJpZ2dlckRhdGE7CgoJCQkvLyBERVBSRUNBVEVEIHJlbG9hZFBhZ2UKCQkJc2V0dGluZ3MucmVsb2FkID0gc2V0dGluZ3MucmVsb2FkUGFnZTsKCgkJCS8vIElmIHRoZSBjYWxsZXIgcHJvdmlkZWQgZGF0YSwgYW5kIHdlJ3JlIHVzaW5nICJnZXQiIHJlcXVlc3QsCgkJCS8vIGFwcGVuZCB0aGUgZGF0YSB0byB0aGUgVVJMLgoJCQlpZiAoIHNldHRpbmdzLmRhdGEgJiYgc2V0dGluZ3MudHlwZSA9PT0gImdldCIgKSB7CgkJCQlhYnNVcmwgPSBwYXRoLmFkZFNlYXJjaFBhcmFtcyggYWJzVXJsLCBzZXR0aW5ncy5kYXRhICk7CgkJCQlzZXR0aW5ncy5kYXRhID0gdW5kZWZpbmVkOwoJCQl9CgoJCQkvLyBJZiB0aGUgY2FsbGVyIGlzIHVzaW5nIGEgInBvc3QiIHJlcXVlc3QsIHJlbG9hZCBtdXN0IGJlIHRydWUKCQkJaWYgKCBzZXR0aW5ncy5kYXRhICYmIHNldHRpbmdzLnR5cGUgPT09ICJwb3N0IiApIHsKCQkJCXNldHRpbmdzLnJlbG9hZCA9IHRydWU7CgkJCX0KCgkJCS8vIFRoZSBhYnNvbHV0ZSB2ZXJzaW9uIG9mIHRoZSBVUkwgbWludXMgYW55IGRpYWxvZy9zdWJjb250ZW50IHBhcmFtcy4KCQkJLy8gSW4gb3RoZXJ3b3JkcyB0aGUgcmVhbCBVUkwgb2YgdGhlIGNvbnRlbnQgdG8gYmUgbG9hZGVkLgoJCQlmaWxlVXJsID0gdGhpcy5fY3JlYXRlRmlsZVVybCggYWJzVXJsICk7CgoJCQkvLyBUaGUgdmVyc2lvbiBvZiB0aGUgVXJsIGFjdHVhbGx5IHN0b3JlZCBpbiB0aGUgZGF0YS11cmwgYXR0cmlidXRlIG9mCgkJCS8vIHRoZSBjb250ZW50LiBGb3IgZW1iZWRkZWQgY29udGVudCwgaXQgaXMganVzdCB0aGUgaWQgb2YgdGhlIHBhZ2UuIEZvciBjb250ZW50CgkJCS8vIHdpdGhpbiB0aGUgc2FtZSBkb21haW4gYXMgdGhlIGRvY3VtZW50IGJhc2UsIGl0IGlzIHRoZSBzaXRlIHJlbGF0aXZlCgkJCS8vIHBhdGguIEZvciBjcm9zcy1kb21haW4gY29udGVudCAoUGhvbmUgR2FwIG9ubHkpIHRoZSBlbnRpcmUgYWJzb2x1dGUgVXJsCgkJCS8vIHVzZWQgdG8gbG9hZCB0aGUgY29udGVudC4KCQkJZGF0YVVybCA9IHRoaXMuX2NyZWF0ZURhdGFVcmwoIGFic1VybCApOwoKCQkJY29udGVudCA9IHRoaXMuX2ZpbmQoIGFic1VybCApOwoKCQkJLy8gSWYgaXQgaXNuJ3QgYSByZWZlcmVuY2UgdG8gdGhlIGZpcnN0IGNvbnRlbnQgYW5kIHJlZmVycyB0byBtaXNzaW5nIGVtYmVkZGVkIGNvbnRlbnQKCQkJLy8gcmVqZWN0IHRoZSBkZWZlcnJlZCBhbmQgcmV0dXJuCgkJCWlmICggY29udGVudC5sZW5ndGggPT09IDAgJiYKCQkJCXBhdGguaXNFbWJlZGRlZFBhZ2UoZmlsZVVybCkgJiYKCQkJCSFwYXRoLmlzRmlyc3RQYWdlVXJsKGZpbGVVcmwpICkgewoJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIHNldHRpbmdzICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFJlc2V0IGJhc2UgdG8gdGhlIGRlZmF1bHQgZG9jdW1lbnQgYmFzZQoJCQkvLyBUT0RPIGZpZ3VyZSBvdXQgd2h5IHdlIGRvZSB0aGlzCgkJCXRoaXMuX2dldEJhc2UoKS5yZXNldCgpOwoKCQkJLy8gSWYgdGhlIGNvbnRlbnQgd2UgYXJlIGludGVyZXN0ZWQgaW4gaXMgYWxyZWFkeSBpbiB0aGUgRE9NLAoJCQkvLyBhbmQgdGhlIGNhbGxlciBkaWQgbm90IGluZGljYXRlIHRoYXQgd2Ugc2hvdWxkIGZvcmNlIGEKCQkJLy8gcmVsb2FkIG9mIHRoZSBmaWxlLCB3ZSBhcmUgZG9uZS4gUmVzb2x2ZSB0aGUgZGVmZXJycmVkIHNvIHRoYXQKCQkJLy8gdXNlcnMgY2FuIGJpbmQgdG8gLmRvbmUgb24gdGhlIHByb21pc2UKCQkJaWYgKCBjb250ZW50Lmxlbmd0aCAmJiAhc2V0dGluZ3MucmVsb2FkICkgewoJCQkJdGhpcy5fZW5oYW5jZSggY29udGVudCwgc2V0dGluZ3Mucm9sZSApOwoJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBzZXR0aW5ncywgY29udGVudCApOwoKCQkJCS8vaWYgd2UgYXJlIHJlbG9hZGluZyB0aGUgY29udGVudCBtYWtlIHN1cmUgd2UgdXBkYXRlCgkJCQkvLyB0aGUgYmFzZSBpZiBpdHMgbm90IGEgcHJlZmV0Y2gKCQkJCWlmICggIXNldHRpbmdzLnByZWZldGNoICl7CgkJCQkJdGhpcy5fZ2V0QmFzZSgpLnNldCh1cmwpOwoJCQkJfQoKCQkJCXJldHVybjsKCQkJfQoKCQkJdHJpZ2dlckRhdGEgPSB7CgkJCQl1cmw6IHVybCwKCQkJCWFic1VybDogYWJzVXJsLAoJCQkJZGF0YVVybDogZGF0YVVybCwKCQkJCWRlZmVycmVkOiBkZWZlcnJlZCwKCQkJCW9wdGlvbnM6IHNldHRpbmdzCgkJCX07CgoJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gbG9hZCBhIGNvbnRlbnQuCgkJCXBibEV2ZW50ID0gdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAiYmVmb3JlbG9hZCIsIHRyaWdnZXJEYXRhICk7CgoJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJaWYgKCBwYmxFdmVudC5kZXByZWNhdGVkRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgfHwKCQkJCSBwYmxFdmVudC5ldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCQkJCXRoaXMuX3Nob3dMb2FkaW5nKCBzZXR0aW5ncy5sb2FkTXNnRGVsYXkgKTsKCQkJfQoKCQkJLy8gUmVzZXQgYmFzZSB0byB0aGUgZGVmYXVsdCBkb2N1bWVudCBiYXNlLgoJCQkvLyBvbmx5IHJlc2V0IGlmIHdlIGFyZSBub3QgcHJlZmV0Y2hpbmcKCQkJaWYgKCBzZXR0aW5ncy5wcmVmZXRjaCA9PT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fZ2V0QmFzZSgpLnJlc2V0KCk7CgkJCX0KCgkJCWlmICggISgkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgfHwKCQkJCXBhdGguaXNTYW1lRG9tYWluKGRvY3VtZW50VXJsLCBhYnNVcmwpKSApIHsKCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBzZXR0aW5ncyApOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBMb2FkIHRoZSBuZXcgY29udGVudC4KCQkJJC5hamF4KHsKCQkJCXVybDogZmlsZVVybCwKCQkJCXR5cGU6IHNldHRpbmdzLnR5cGUsCgkJCQlkYXRhOiBzZXR0aW5ncy5kYXRhLAoJCQkJY29udGVudFR5cGU6IHNldHRpbmdzLmNvbnRlbnRUeXBlLAoJCQkJZGF0YVR5cGU6ICJodG1sIiwKCQkJCXN1Y2Nlc3M6IHRoaXMuX2xvYWRTdWNjZXNzKCBhYnNVcmwsIHRyaWdnZXJEYXRhLCBzZXR0aW5ncywgZGVmZXJyZWQgKSwKCQkJCWVycm9yOiB0aGlzLl9sb2FkRXJyb3IoIGFic1VybCwgdHJpZ2dlckRhdGEsIHNldHRpbmdzLCBkZWZlcnJlZCApCgkJCX0pOwoJCX0sCgoJCV9sb2FkRXJyb3I6IGZ1bmN0aW9uKCBhYnNVcmwsIHRyaWdnZXJEYXRhLCBzZXR0aW5ncywgZGVmZXJyZWQgKSB7CgkJCXJldHVybiAkLnByb3h5KGZ1bmN0aW9uKCB4aHIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duICkgewoJCQkJLy9zZXQgYmFzZSBiYWNrIHRvIGN1cnJlbnQgcGF0aAoJCQkJdGhpcy5fZ2V0QmFzZSgpLnNldCggcGF0aC5nZXQoKSApOwoKCQkJCS8vIEFkZCBlcnJvciBpbmZvIHRvIG91ciB0cmlnZ2VyRGF0YS4KCQkJCXRyaWdnZXJEYXRhLnhociA9IHhocjsKCQkJCXRyaWdnZXJEYXRhLnRleHRTdGF0dXMgPSB0ZXh0U3RhdHVzOwoJCQkJdHJpZ2dlckRhdGEuZXJyb3JUaHJvd24gPSBlcnJvclRocm93bjsKCgkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgdGhlIHBhZ2UgbG9hZCBmYWlsZWQuCgkJCQl2YXIgcGxmRXZlbnQgPSB0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJsb2FkZmFpbGVkIiwgdHJpZ2dlckRhdGEgKTsKCgkJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJCS8vIE5vdGUgdGhhdCBpdCBpcyB0aGUgcmVzcG9uc2liaWxpdHkgb2YgdGhlIGxpc3RlbmVyL2hhbmRsZXIKCQkJCS8vIHRoYXQgY2FsbGVkIHByZXZlbnREZWZhdWx0KCksIHRvIHJlc29sdmUvcmVqZWN0IHRoZQoJCQkJLy8gZGVmZXJyZWQgb2JqZWN0IHdpdGhpbiB0aGUgdHJpZ2dlckRhdGEuCgkJCQlpZiAoIHBsZkV2ZW50LmRlcHJlY2F0ZWRFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSB8fAoJCQkJCXBsZkV2ZW50LmV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQkvLyBSZW1vdmUgbG9hZGluZyBtZXNzYWdlLgoJCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCQkJCQl0aGlzLl9zaG93RXJyb3IoKTsKCQkJCX0KCgkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgc2V0dGluZ3MgKTsKCQkJfSwgdGhpcyk7CgkJfSwKCgkJX2dldFRyYW5zaXRpb25IYW5kbGVyOiBmdW5jdGlvbiggdHJhbnNpdGlvbiApIHsKCQkJdHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uKCB0cmFuc2l0aW9uICk7CgoJCQkvL2ZpbmQgdGhlIHRyYW5zaXRpb24gaGFuZGxlciBmb3IgdGhlIHNwZWNpZmllZCB0cmFuc2l0aW9uLiBJZiB0aGVyZQoJCQkvL2lzbid0IG9uZSBpbiBvdXIgdHJhbnNpdGlvbkhhbmRsZXJzIGRpY3Rpb25hcnksIHVzZSB0aGUgZGVmYXVsdCBvbmUuCgkJCS8vY2FsbCB0aGUgaGFuZGxlciBpbW1lZGlhdGVseSB0byBraWNrLW9mZiB0aGUgdHJhbnNpdGlvbi4KCQkJcmV0dXJuICQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVyc1sgdHJhbnNpdGlvbiBdIHx8ICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlcjsKCQl9LAoKCQkvLyBUT0RPIG1vdmUgaW50byB0cmFuc2l0aW9uIGhhbmRsZXJzPwoJCV90cmlnZ2VyQ3NzVHJhbnNpdGlvbkV2ZW50czogZnVuY3Rpb24oIHRvLCBmcm9tLCBwcmVmaXggKSB7CgkJCXByZWZpeCA9IHByZWZpeCB8fCAiIjsKCgkJCS8vIFRPRE8gZGVjaWRlIGlmIHRoZXNlIGV2ZW50cyBzaG91bGQgaW4gZmFjdCBiZSB0cmlnZ2VyZWQgb24gdGhlIGNvbnRhaW5lcgoJCQlpZiAoIGZyb20gKSB7CgkJCQkvL3RyaWdnZXIgYmVmb3JlIHNob3cvaGlkZSBldmVudHMKCQkJCS8vIFRPRE8gZGVwcmVjYXRlIG5leHRQYWdlIGluIGZhdm9yIG9mIG5leHQKCQkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggcHJlZml4ICsgImhpZGUiLCB7bmV4dFBhZ2U6IHRvfSwgZnJvbSApOwoJCQl9CgoJCQkvLyBUT0RPIGRlcHJlY2F0ZSBwcmV2UGFnZSBpbiBmYXZvciBvZiBwcmV2aW91cwoJCQl0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoIHByZWZpeCArICJzaG93Iiwge3ByZXZQYWdlOiBmcm9tIHx8ICQoICIiICl9LCB0byApOwoJCX0sCgoJCS8vIFRPRE8gbWFrZSBwcml2YXRlIG9uY2UgY2hhbmdlIGhhcyBiZWVuIGRlZmluZWQgaW4gdGhlIHdpZGdldAoJCV9jc3NUcmFuc2l0aW9uOiBmdW5jdGlvbiggdG8sIGZyb20sIG9wdGlvbnMgKSB7CgkJCXZhciB0cmFuc2l0aW9uID0gb3B0aW9ucy50cmFuc2l0aW9uLAoJCQkJcmV2ZXJzZSA9IG9wdGlvbnMucmV2ZXJzZSwKCQkJCWRlZmVycmVkID0gb3B0aW9ucy5kZWZlcnJlZCwKCQkJCVRyYW5zaXRpb25IYW5kbGVyLAoJCQkJcHJvbWlzZTsKCgkJCXRoaXMuX3RyaWdnZXJDc3NUcmFuc2l0aW9uRXZlbnRzKCB0bywgZnJvbSwgImJlZm9yZSIgKTsKCgkJCS8vIFRPRE8gcHV0IHRoaXMgaW4gYSBiaW5kaW5nIHRvIGV2ZW50cyAqb3V0c2lkZSogdGhlIHdpZGdldAoJCQl0aGlzLl9oaWRlTG9hZGluZygpOwoKCQkJVHJhbnNpdGlvbkhhbmRsZXIgPSB0aGlzLl9nZXRUcmFuc2l0aW9uSGFuZGxlciggdHJhbnNpdGlvbiApOwoKCQkJcHJvbWlzZSA9IChuZXcgVHJhbnNpdGlvbkhhbmRsZXIoIHRyYW5zaXRpb24sIHJldmVyc2UsIHRvLCBmcm9tICkpLnRyYW5zaXRpb24oKTsKCgkJCS8vIFRPRE8gdGVtcG9yYXJ5IGFjY29tb2RhdGlvbiBvZiBhcmd1bWVudCBkZWZlcnJlZAoJCQlwcm9taXNlLmRvbmUoZnVuY3Rpb24oKSB7CgkJCQlkZWZlcnJlZC5yZXNvbHZlLmFwcGx5KGRlZmVycmVkLCBhcmd1bWVudHMpOwoJCQl9KTsKCgkJCXByb21pc2UuZG9uZSgkLnByb3h5KGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fdHJpZ2dlckNzc1RyYW5zaXRpb25FdmVudHMoIHRvLCBmcm9tICk7CgkJCX0sIHRoaXMpKTsKCQl9LAoKCQlfcmVsZWFzZVRyYW5zaXRpb25Mb2NrOiBmdW5jdGlvbigpIHsKCQkJLy9yZWxlYXNlIHRyYW5zaXRpb24gbG9jayBzbyBuYXZpZ2F0aW9uIGlzIGZyZWUgYWdhaW4KCQkJcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpOwoJCX0sCgoJCV9yZW1vdmVBY3RpdmVMaW5rQ2xhc3M6IGZ1bmN0aW9uKCBmb3JjZSApIHsKCQkJLy9jbGVhciBvdXQgdGhlIGFjdGl2ZSBidXR0b24gc3RhdGUKCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCBmb3JjZSApOwoJCX0sCgoJCV9sb2FkVXJsOiBmdW5jdGlvbiggdG8sIHRyaWdnZXJEYXRhLCBzZXR0aW5ncyApIHsKCQkJLy8gcHJlc2VydmUgdGhlIG9yaWdpbmFsIHRhcmdldCBhcyB0aGUgZGF0YVVybCB2YWx1ZSB3aWxsIGJlCgkJCS8vIHNpbXBsaWZpZWQgZWcsIHJlbW92aW5nIHVpLXN0YXRlLCBhbmQgcmVtb3ZpbmcgcXVlcnkgcGFyYW1zCgkJCS8vIGZyb20gdGhlIGhhc2ggdGhpcyBpcyBzbyB0aGF0IHVzZXJzIHdobyB3YW50IHRvIHVzZSBxdWVyeQoJCQkvLyBwYXJhbXMgaGF2ZSBhY2Nlc3MgdG8gdGhlbSBpbiB0aGUgZXZlbnQgYmluZGluZ3MgZm9yIHRoZSBwYWdlCgkJCS8vIGxpZmUgY3ljbGUgU2VlIGlzc3VlICM1MDg1CgkJCXNldHRpbmdzLnRhcmdldCA9IHRvOwoJCQlzZXR0aW5ncy5kZWZlcnJlZCA9ICQuRGVmZXJyZWQoKTsKCgkJCXRoaXMubG9hZCggdG8sIHNldHRpbmdzICk7CgoJCQlzZXR0aW5ncy5kZWZlcnJlZC5kb25lKCQucHJveHkoZnVuY3Rpb24oIHVybCwgb3B0aW9ucywgY29udGVudCApIHsKCQkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCgkJCQkvLyBzdG9yZSB0aGUgb3JpZ2luYWwgYWJzb2x1dGUgdXJsIHNvIHRoYXQgaXQgY2FuIGJlIHByb3ZpZGVkCgkJCQkvLyB0byBldmVudHMgaW4gdGhlIHRyaWdnZXJEYXRhIG9mIHRoZSBzdWJzZXF1ZW50IGNoYW5nZVBhZ2UgY2FsbAoJCQkJb3B0aW9ucy5hYnNVcmwgPSB0cmlnZ2VyRGF0YS5hYnNVcmw7CgoJCQkJdGhpcy50cmFuc2l0aW9uKCBjb250ZW50LCB0cmlnZ2VyRGF0YSwgb3B0aW9ucyApOwoJCQl9LCB0aGlzKSk7CgoJCQlzZXR0aW5ncy5kZWZlcnJlZC5mYWlsKCQucHJveHkoZnVuY3Rpb24oLyogdXJsLCBvcHRpb25zICovKSB7CgkJCQl0aGlzLl9yZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsKCQkJCXRoaXMuX3JlbGVhc2VUcmFuc2l0aW9uTG9jaygpOwoJCQkJdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAiY2hhbmdlZmFpbGVkIiwgdHJpZ2dlckRhdGEgKTsKCQkJfSwgdGhpcykpOwoJCX0sCgoJCV90cmlnZ2VyUGFnZUJlZm9yZUNoYW5nZTogZnVuY3Rpb24oIHRvLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MgKSB7CgkJCXZhciBwYmNFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWJlZm9yZWNoYW5nZSIgKTsKCgkJCSQuZXh0ZW5kKHRyaWdnZXJEYXRhLCB7IHRvUGFnZTogdG8sIG9wdGlvbnM6IHNldHRpbmdzIH0pOwoKCQkJLy8gTk9URTogcHJlc2VydmUgdGhlIG9yaWdpbmFsIHRhcmdldCBhcyB0aGUgZGF0YVVybCB2YWx1ZSB3aWxsIGJlCgkJCS8vIHNpbXBsaWZpZWQgZWcsIHJlbW92aW5nIHVpLXN0YXRlLCBhbmQgcmVtb3ZpbmcgcXVlcnkgcGFyYW1zIGZyb20KCQkJLy8gdGhlIGhhc2ggdGhpcyBpcyBzbyB0aGF0IHVzZXJzIHdobyB3YW50IHRvIHVzZSBxdWVyeSBwYXJhbXMgaGF2ZQoJCQkvLyBhY2Nlc3MgdG8gdGhlbSBpbiB0aGUgZXZlbnQgYmluZGluZ3MgZm9yIHRoZSBwYWdlIGxpZmUgY3ljbGUKCQkJLy8gU2VlIGlzc3VlICM1MDg1CgkJCWlmICggJC50eXBlKHRvKSA9PT0gInN0cmluZyIgKSB7CgkJCQkvLyBpZiB0aGUgdG9QYWdlIGlzIGEgc3RyaW5nIHNpbXBseSBjb252ZXJ0IGl0CgkJCQl0cmlnZ2VyRGF0YS5hYnNVcmwgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdG8sIGZpbmRCYXNlV2l0aERlZmF1bHQoKSApOwoJCQl9IGVsc2UgewoJCQkJLy8gaWYgdGhlIHRvUGFnZSBpcyBhIGpRdWVyeSBvYmplY3QgZ3JhYiB0aGUgYWJzb2x1dGUgdXJsIHN0b3JlZAoJCQkJLy8gaW4gdGhlIGxvYWRQYWdlIGNhbGxiYWNrIHdoZXJlIGl0IGV4aXN0cwoJCQkJdHJpZ2dlckRhdGEuYWJzVXJsID0gc2V0dGluZ3MuYWJzVXJsOwoJCQl9CgoJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gY2hhbmdlIHRoZSBjdXJyZW50IHBhZ2UuCgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBwYmNFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCQlpZiAoIHBiY0V2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQlyZXR1cm4gdHJ1ZTsKCQl9LAoKCQljaGFuZ2U6IGZ1bmN0aW9uKCB0bywgb3B0aW9ucyApIHsKCQkJLy8gSWYgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBhIHRyYW5zaXRpb24sIHF1ZXVlIHRoZSBjdXJyZW50IHJlcXVlc3QuCgkJCS8vIFdlJ2xsIGNhbGwgY2hhbmdlUGFnZSgpIG9uY2Ugd2UncmUgZG9uZSB3aXRoIHRoZSBjdXJyZW50IHRyYW5zaXRpb24KCQkJLy8gdG8gc2VydmljZSB0aGUgcmVxdWVzdC4KCQkJaWYgKCBpc1BhZ2VUcmFuc2l0aW9uaW5nICkgewoJCQkJcGFnZVRyYW5zaXRpb25RdWV1ZS51bnNoaWZ0KCBhcmd1bWVudHMgKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIHNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5jaGFuZ2VQYWdlLmRlZmF1bHRzLCBvcHRpb25zICksCgkJCQl0cmlnZ2VyRGF0YSA9IHt9OwoKCQkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBmcm9tUGFnZS4KCQkJc2V0dGluZ3MuZnJvbVBhZ2UgPSBzZXR0aW5ncy5mcm9tUGFnZSB8fCAkLm1vYmlsZS5hY3RpdmVQYWdlOwoKCQkJLy8gaWYgdGhlIHBhZ2UgYmVmb3JlY2hhbmdlIGRlZmF1bHQgaXMgcHJldmVudGVkIHJldHVybiBlYXJseQoJCQlpZiAoICF0aGlzLl90cmlnZ2VyUGFnZUJlZm9yZUNoYW5nZSh0bywgdHJpZ2dlckRhdGEsIHNldHRpbmdzKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gV2UgYWxsb3cgInBhZ2ViZWZvcmVjaGFuZ2UiIG9ic2VydmVycyB0byBtb2RpZnkgdGhlIHRvIGluCgkJCS8vIHRoZSB0cmlnZ2VyIGRhdGEgdG8gYWxsb3cgZm9yIHJlZGlyZWN0cy4gTWFrZSBzdXJlIG91ciB0byBpcwoJCQkvLyB1cGRhdGVkLiBXZSBhbHNvIG5lZWQgdG8gcmUtZXZhbHVhdGUgd2hldGhlciBpdCBpcyBhIHN0cmluZywKCQkJLy8gYmVjYXVzZSBhbiBvYmplY3QgY2FuIGFsc28gYmUgcmVwbGFjZWQgYnkgYSBzdHJpbmcKCQkJdG8gPSB0cmlnZ2VyRGF0YS50b1BhZ2U7CgoJCQkvLyBJZiB0aGUgY2FsbGVyIHBhc3NlZCB1cyBhIHVybCwgY2FsbCBsb2FkUGFnZSgpCgkJCS8vIHRvIG1ha2Ugc3VyZSBpdCBpcyBsb2FkZWQgaW50byB0aGUgRE9NLiBXZSdsbCBsaXN0ZW4KCQkJLy8gdG8gdGhlIHByb21pc2Ugb2JqZWN0IGl0IHJldHVybnMgc28gd2Uga25vdyB3aGVuCgkJCS8vIGl0IGlzIGRvbmUgbG9hZGluZyBvciBpZiBhbiBlcnJvciBvY3VycmVkLgoJCQlpZiAoICQudHlwZSh0bykgPT09ICJzdHJpbmciICkgewoJCQkJLy8gU2V0IHRoZSBpc1BhZ2VUcmFuc2l0aW9uaW5nIGZsYWcgdG8gcHJldmVudCBhbnkgcmVxdWVzdHMgZnJvbQoJCQkJLy8gZW50ZXJpbmcgdGhpcyBtZXRob2Qgd2hpbGUgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBsb2FkaW5nIGEgcGFnZQoJCQkJLy8gb3IgdHJhbnNpdGlvbmluZy4KCQkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSB0cnVlOwoKCQkJCXRoaXMuX2xvYWRVcmwoIHRvLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMudHJhbnNpdGlvbiggdG8sIHRyaWdnZXJEYXRhLCBzZXR0aW5ncyApOwoJCQl9CgkJfSwKCgkJdHJhbnNpdGlvbjogZnVuY3Rpb24oIHRvUGFnZSwgdHJpZ2dlckRhdGEsIHNldHRpbmdzICkgewoJCQl2YXIgZnJvbVBhZ2UsIHVybCwgcGFnZVVybCwgZmlsZVVybCwKCQkJCWFjdGl2ZSwgYWN0aXZlSXNJbml0aWFsUGFnZSwKCQkJCWhpc3RvcnlEaXIsIHBhZ2VUaXRsZSwgaXNEaWFsb2csCgkJCQlhbHJlYWR5VGhlcmUsIG5ld1BhZ2VUaXRsZSwKCQkJCXBhcmFtcywJY3NzVHJhbnNpdGlvbkRlZmVycmVkLAoJCQkJYmVmb3JlVHJhbnNpdGlvbjsKCgkJCS8vIElmIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgYSB0cmFuc2l0aW9uLCBxdWV1ZSB0aGUgY3VycmVudCByZXF1ZXN0LgoJCQkvLyBXZSdsbCBjYWxsIGNoYW5nZVBhZ2UoKSBvbmNlIHdlJ3JlIGRvbmUgd2l0aCB0aGUgY3VycmVudCB0cmFuc2l0aW9uCgkJCS8vIHRvIHNlcnZpY2UgdGhlIHJlcXVlc3QuCgkJCWlmICggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJCS8vIG1ha2Ugc3VyZSB0byBvbmx5IHF1ZXVlIHRoZSB0byBhbmQgc2V0dGluZ3MgdmFsdWVzIHNvIHRoZSBhcmd1bWVudHMKCQkJCS8vIHdvcmsgd2l0aCBhIGNhbGwgdG8gdGhlIGNoYW5nZSBtZXRob2QKCQkJCXBhZ2VUcmFuc2l0aW9uUXVldWUudW5zaGlmdCggW3RvUGFnZSwgc2V0dGluZ3NdICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIERFUFJFQ0FURUQgLSB0aGlzIGNhbGwgb25seSwgaW4gZmF2b3Igb2YgdGhlIGJlZm9yZSB0cmFuc2l0aW9uCgkJCS8vIGlmIHRoZSBwYWdlIGJlZm9yZWNoYW5nZSBkZWZhdWx0IGlzIHByZXZlbnRlZCByZXR1cm4gZWFybHkKCQkJaWYgKCAhdGhpcy5fdHJpZ2dlclBhZ2VCZWZvcmVDaGFuZ2UodG9QYWdlLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBpZiB0aGUgKGNvbnRlbnR8cGFnZSliZWZvcmV0cmFuc2l0aW9uIGRlZmF1bHQgaXMgcHJldmVudGVkIHJldHVybiBlYXJseQoJCQkvLyBOb3RlLCB3ZSBoYXZlIHRvIGNoZWNrIGZvciBib3RoIHRoZSBkZXByZWNhdGVkIGFuZCBuZXcgZXZlbnRzCgkJCWJlZm9yZVRyYW5zaXRpb24gPSB0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJiZWZvcmV0cmFuc2l0aW9uIiwgdHJpZ2dlckRhdGEgKTsKCQkJaWYgKGJlZm9yZVRyYW5zaXRpb24uZGVwcmVjYXRlZEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8CgkJCQliZWZvcmVUcmFuc2l0aW9uLmV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBTZXQgdGhlIGlzUGFnZVRyYW5zaXRpb25pbmcgZmxhZyB0byBwcmV2ZW50IGFueSByZXF1ZXN0cyBmcm9tCgkJCS8vIGVudGVyaW5nIHRoaXMgbWV0aG9kIHdoaWxlIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgbG9hZGluZyBhIHBhZ2UKCQkJLy8gb3IgdHJhbnNpdGlvbmluZy4KCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IHRydWU7CgoJCQkvLyBJZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGZpcnN0LXBhZ2Ugb2YgdGhlIGFwcGxpY2F0aW9uLCB3ZSBuZWVkIHRvIG1ha2UKCQkJLy8gc3VyZSBzZXR0aW5ncy5kYXRhVXJsIGlzIHNldCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgdXJsLiBUaGlzIGFsbG93cwoJCQkvLyB1cyB0byBhdm9pZCBnZW5lcmF0aW5nIGEgZG9jdW1lbnQgdXJsIHdpdGggYW4gaWQgaGFzaCBpbiB0aGUgY2FzZSB3aGVyZSB0aGUKCQkJLy8gZmlyc3QtcGFnZSBvZiB0aGUgZG9jdW1lbnQgaGFzIGFuIGlkIGF0dHJpYnV0ZSBzcGVjaWZpZWQuCgkJCWlmICggdG9QYWdlWyAwIF0gPT09ICQubW9iaWxlLmZpcnN0UGFnZVsgMCBdICYmICFzZXR0aW5ncy5kYXRhVXJsICkgewoJCQkJc2V0dGluZ3MuZGF0YVVybCA9IGRvY3VtZW50VXJsLmhyZWZOb0hhc2g7CgkJCX0KCgkJCS8vIFRoZSBjYWxsZXIgcGFzc2VkIHVzIGEgcmVhbCBwYWdlIERPTSBlbGVtZW50LiBVcGRhdGUgb3VyCgkJCS8vIGludGVybmFsIHN0YXRlIGFuZCB0aGVuIHRyaWdnZXIgYSB0cmFuc2l0aW9uIHRvIHRoZSBwYWdlLgoJCQlmcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlOwoJCQl1cmwgPSAoIHNldHRpbmdzLmRhdGFVcmwgJiYgcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKHNldHRpbmdzLmRhdGFVcmwpICkgfHwKCQkJCXRvUGFnZS5qcW1EYXRhKCAidXJsIiApOwoKCQkJLy8gVGhlIHBhZ2VVcmwgdmFyIGlzIHVzdWFsbHkgdGhlIHNhbWUgYXMgdXJsLCBleGNlcHQgd2hlbiB1cmwgaXMgb2JzY3VyZWQKCQkJLy8gYXMgYSBkaWFsb2cgdXJsLiBwYWdlVXJsIGFsd2F5cyBjb250YWlucyB0aGUgZmlsZSBwYXRoCgkJCXBhZ2VVcmwgPSB1cmw7CgkJCWZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCB1cmwgKTsKCQkJYWN0aXZlID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKTsKCQkJYWN0aXZlSXNJbml0aWFsUGFnZSA9IHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDA7CgkJCWhpc3RvcnlEaXIgPSAwOwoJCQlwYWdlVGl0bGUgPSBkb2N1bWVudC50aXRsZTsKCQkJaXNEaWFsb2cgPSAoIHNldHRpbmdzLnJvbGUgPT09ICJkaWFsb2ciIHx8IHRvUGFnZS5qcW1EYXRhKCAicm9sZSIgKSA9PT0gImRpYWxvZyIgKSAmJiB0b1BhZ2UuanFtRGF0YSggImRpYWxvZyIgKSAhPT0gdHJ1ZTsKCgkJCS8vIEJ5IGRlZmF1bHQsIHdlIHByZXZlbnQgY2hhbmdlUGFnZSByZXF1ZXN0cyB3aGVuIHRoZSBmcm9tUGFnZSBhbmQgdG9QYWdlCgkJCS8vIGFyZSB0aGUgc2FtZSBlbGVtZW50LCBidXQgZm9sa3MgdGhhdCBnZW5lcmF0ZSBjb250ZW50IG1hbnVhbGx5L2R5bmFtaWNhbGx5CgkJCS8vIGFuZCByZXVzZSBwYWdlcyB3YW50IHRvIGJlIGFibGUgdG8gdHJhbnNpdGlvbiB0byB0aGUgc2FtZSBwYWdlLiBUbyBhbGxvdwoJCQkvLyB0aGlzLCB0aGV5IHdpbGwgbmVlZCB0byBjaGFuZ2UgdGhlIGRlZmF1bHQgdmFsdWUgb2YgYWxsb3dTYW1lUGFnZVRyYW5zaXRpb24KCQkJLy8gdG8gdHJ1ZSwgKk9SKiwgcGFzcyBpdCBpbiBhcyBhbiBvcHRpb24gd2hlbiB0aGV5IG1hbnVhbGx5IGNhbGwgY2hhbmdlUGFnZSgpLgoJCQkvLyBJdCBzaG91bGQgYmUgbm90ZWQgdGhhdCBvdXIgZGVmYXVsdCB0cmFuc2l0aW9uIGFuaW1hdGlvbnMgYXNzdW1lIHRoYXQgdGhlCgkJCS8vIGZvcm1QYWdlIGFuZCB0b1BhZ2UgYXJlIGRpZmZlcmVudCBlbGVtZW50cywgc28gdGhleSBtYXkgYmVoYXZlIHVuZXhwZWN0ZWRseS4KCQkJLy8gSXQgaXMgdXAgdG8gdGhlIGRldmVsb3BlciB0aGF0IHR1cm5zIG9uIHRoZSBhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbmEgb3B0aW9uCgkJCS8vIHRvIGVpdGhlciB0dXJuIG9mZiB0cmFuc2l0aW9uIGFuaW1hdGlvbnMsIG9yIG1ha2Ugc3VyZSB0aGF0IGFuIGFwcHJvcHJpYXRlCgkJCS8vIGFuaW1hdGlvbiB0cmFuc2l0aW9uIGlzIHVzZWQuCgkJCWlmICggZnJvbVBhZ2UgJiYgZnJvbVBhZ2VbMF0gPT09IHRvUGFnZVswXSAmJiAhc2V0dGluZ3MuYWxsb3dTYW1lUGFnZVRyYW5zaXRpb24gKSB7CgkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJCQl0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJ0cmFuc2l0aW9uIiwgdHJpZ2dlckRhdGEgKTsKCQkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAicGFnZWNoYW5nZSIsIHRyaWdnZXJEYXRhICk7CgoJCQkJLy8gRXZlbiBpZiB0aGVyZSBpcyBubyBwYWdlIGNoYW5nZSB0byBiZSBkb25lLCB3ZSBzaG91bGQga2VlcCB0aGUgdXJsSGlzdG9yeQoJCQkJLy8gaW4gc3luYyB3aXRoIHRoZSBoYXNoIGNoYW5nZXMKCQkJCWlmICggc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCQkJdXJsSGlzdG9yeS5kaXJlY3QoeyB1cmw6IHVybCB9KTsKCQkJCX0KCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoZSBwYWdlIHdlIGFyZSBnaXZlbiBoYXMgYWxyZWFkeSBiZWVuIGVuaGFuY2VkLgoJCQl0b1BhZ2UucGFnZSh7IHJvbGU6IHNldHRpbmdzLnJvbGUgfSk7CgoJCQkvLyBJZiB0aGUgY2hhbmdlUGFnZSByZXF1ZXN0IHdhcyBzZW50IGZyb20gYSBoYXNoQ2hhbmdlIGV2ZW50LCBjaGVjayB0byBzZWUgaWYgdGhlCgkJCS8vIHBhZ2UgaXMgYWxyZWFkeSB3aXRoaW4gdGhlIHVybEhpc3Rvcnkgc3RhY2suIElmIHNvLCB3ZSdsbCBhc3N1bWUgdGhlIHVzZXIgaGl0CgkJCS8vIHRoZSBmb3J3YXJkL2JhY2sgYnV0dG9uIGFuZCB3aWxsIHRyeSB0byBtYXRjaCB0aGUgdHJhbnNpdGlvbiBhY2NvcmRpbmdseS4KCQkJaWYgKCBzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJCWhpc3RvcnlEaXIgPSBzZXR0aW5ncy5kaXJlY3Rpb24gPT09ICJiYWNrIiA/IC0xIDogMTsKCQkJfQoKCQkJLy8gS2lsbCB0aGUga2V5Ym9hcmQuCgkJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBzdG9wIGNyYXdsaW5nIHRoZSBlbnRpcmUgZG9jdW1lbnQgdG8ga2lsbCBmb2N1cy4gSW5zdGVhZCwKCQkJLy8gICAgICAgICAgICB3ZSBzaG91bGQgYmUgdHJhY2tpbmcgZm9jdXMgd2l0aCBhIGRlbGVnYXRlKCkgaGFuZGxlciBzbyB3ZSBhbHJlYWR5IGhhdmUKCQkJLy8gICAgICAgICAgICB0aGUgZWxlbWVudCBpbiBoYW5kIGF0IHRoaXMgcG9pbnQuCgkJCS8vIFdyYXAgdGhpcyBpbiBhIHRyeS9jYXRjaCBibG9jayBzaW5jZSBJRTkgdGhyb3cgIlVuc3BlY2lmaWVkIGVycm9yIiBpZiBkb2N1bWVudC5hY3RpdmVFbGVtZW50CgkJCS8vIGlzIHVuZGVmaW5lZCB3aGVuIHdlIGFyZSBpbiBhbiBJRnJhbWUuCgkJCXRyeSB7CgkJCQlpZiAoIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgJiYgZG9jdW1lbnQuYWN0aXZlRWxlbWVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAiYm9keSIgKSB7CgkJCQkJJCggZG9jdW1lbnQuYWN0aXZlRWxlbWVudCApLmJsdXIoKTsKCQkJCX0gZWxzZSB7CgkJCQkJJCggImlucHV0OmZvY3VzLCB0ZXh0YXJlYTpmb2N1cywgc2VsZWN0OmZvY3VzIiApLmJsdXIoKTsKCQkJCX0KCQkJfSBjYXRjaCggZSApIHt9CgoJCQkvLyBSZWNvcmQgd2hldGhlciB3ZSBhcmUgYXQgYSBwbGFjZSBpbiBoaXN0b3J5IHdoZXJlIGEgZGlhbG9nIHVzZWQgdG8gYmUgLSBpZiBzbywgZG8gbm90IGFkZCBhIG5ldyBoaXN0b3J5IGVudHJ5IGFuZCBkbyBub3QgY2hhbmdlIHRoZSBoYXNoIGVpdGhlcgoJCQlhbHJlYWR5VGhlcmUgPSBmYWxzZTsKCgkJCS8vIElmIHdlJ3JlIGRpc3BsYXlpbmcgdGhlIHBhZ2UgYXMgYSBkaWFsb2csIHdlIGRvbid0IHdhbnQgdGhlIHVybAoJCQkvLyBmb3IgdGhlIGRpYWxvZyBjb250ZW50IHRvIGJlIHVzZWQgaW4gdGhlIGhhc2guIEluc3RlYWQsIHdlIHdhbnQKCQkJLy8gdG8gYXBwZW5kIHRoZSBkaWFsb2dIYXNoS2V5IHRvIHRoZSB1cmwgb2YgdGhlIGN1cnJlbnQgcGFnZS4KCQkJaWYgKCBpc0RpYWxvZyAmJiBhY3RpdmUgKSB7CgkJCQkvLyBvbiB0aGUgaW5pdGlhbCBwYWdlIGxvYWQgYWN0aXZlLnVybCBpcyB1bmRlZmluZWQgYW5kIGluIHRoYXQgY2FzZSBzaG91bGQKCQkJCS8vIGJlIGFuIGVtcHR5IHN0cmluZy4gTW92aW5nIHRoZSB1bmRlZmluZWQgLT4gZW1wdHkgc3RyaW5nIGJhY2sgaW50bwoJCQkJLy8gdXJsSGlzdG9yeS5hZGROZXcgc2VlbWVkIGltcHJ1ZGVudCBnaXZlbiB1bmRlZmluZWQgYmV0dGVyIHJlcHJlc2VudHMKCQkJCS8vIHRoZSB1cmwgc3RhdGUKCgkJCQkvLyBJZiB3ZSBhcmUgYXQgYSBwbGFjZSBpbiBoaXN0b3J5IHRoYXQgb25jZSBiZWxvbmdlZCB0byBhIGRpYWxvZywgcmV1c2UKCQkJCS8vIHRoaXMgc3RhdGUgd2l0aG91dCBhZGRpbmcgdG8gdXJsSGlzdG9yeSBhbmQgd2l0aG91dCBtb2RpZnlpbmcgdGhlIGhhc2guCgkJCQkvLyBIb3dldmVyLCBpZiBhIGRpYWxvZyBpcyBhbHJlYWR5IGRpc3BsYXllZCBhdCB0aGlzIHBvaW50LCBhbmQgd2UncmUKCQkJCS8vIGFib3V0IHRvIGRpc3BsYXkgYW5vdGhlciBkaWFsb2csIHRoZW4gd2UgbXVzdCBhZGQgYW5vdGhlciBoYXNoIGFuZAoJCQkJLy8gaGlzdG9yeSBlbnRyeSBvbiB0b3Agc28gdGhhdCBvbmUgbWF5IG5hdmlnYXRlIGJhY2sgdG8gdGhlIG9yaWdpbmFsIGRpYWxvZwoJCQkJaWYgKCBhY3RpdmUudXJsICYmCgkJCQkJIGFjdGl2ZS51cmwuaW5kZXhPZiggZGlhbG9nSGFzaEtleSApID4gLTEgJiYKCQkJCQkgJC5tb2JpbGUuYWN0aXZlUGFnZSAmJgoJCQkJCSAhJC5tb2JpbGUuYWN0aXZlUGFnZS5oYXNDbGFzcyggInVpLWRpYWxvZyIgKSAmJgoJCQkJCSB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCApIHsKCQkJCQlzZXR0aW5ncy5jaGFuZ2VIYXNoID0gZmFsc2U7CgkJCQkJYWxyZWFkeVRoZXJlID0gdHJ1ZTsKCQkJCX0KCgkJCQkvLyBOb3JtYWxseSwgd2UgdGFjayBvbiBhIGRpYWxvZyBoYXNoIGtleSwgYnV0IGlmIHRoaXMgaXMgdGhlIGxvY2F0aW9uIG9mIGEgc3RhbGUgZGlhbG9nLAoJCQkJLy8gd2UgcmV1c2UgdGhlIFVSTCBmcm9tIHRoZSBlbnRyeQoJCQkJdXJsID0gKCBhY3RpdmUudXJsIHx8ICIiICk7CgoJCQkJLy8gYWNjb3VudCBmb3IgYWJzb2x1dGUgdXJscyBpbnN0ZWFkIG9mIGp1c3QgcmVsYXRpdmUgdXJscyB1c2UgYXMgaGFzaGVzCgkJCQlpZiAoICFhbHJlYWR5VGhlcmUgJiYgdXJsLmluZGV4T2YoIiMiKSA+IC0xICkgewoJCQkJCXVybCArPSBkaWFsb2dIYXNoS2V5OwoJCQkJfSBlbHNlIHsKCQkJCQl1cmwgKz0gIiMiICsgZGlhbG9nSGFzaEtleTsKCQkJCX0KCgkJCQkvLyB0YWNrIG9uIGFub3RoZXIgZGlhbG9nSGFzaEtleSBpZiB0aGlzIGlzIHRoZSBzYW1lIGFzIHRoZSBpbml0aWFsIGhhc2gKCQkJCS8vIHRoaXMgbWFrZXMgc3VyZSB0aGF0IGEgaGlzdG9yeSBlbnRyeSBpcyBjcmVhdGVkIGZvciB0aGlzIGRpYWxvZwoJCQkJaWYgKCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID09PSAwICYmIHVybCA9PT0gdXJsSGlzdG9yeS5pbml0aWFsRHN0ICkgewoJCQkJCXVybCArPSBkaWFsb2dIYXNoS2V5OwoJCQkJfQoJCQl9CgoJCQkvLyBpZiB0aXRsZSBlbGVtZW50IHdhc24ndCBmb3VuZCwgdHJ5IHRoZSBwYWdlIGRpdiBkYXRhIGF0dHIgdG9vCgkJCS8vIElmIHRoaXMgaXMgYSBkZWVwLWxpbmsgb3IgYSByZWxvYWQgKCBhY3RpdmUgPT09IHVuZGVmaW5lZCApIHRoZW4ganVzdCB1c2UgcGFnZVRpdGxlCgkJCW5ld1BhZ2VUaXRsZSA9ICggIWFjdGl2ZSApPyBwYWdlVGl0bGUgOiB0b1BhZ2UuanFtRGF0YSggInRpdGxlIiApIHx8IHRvUGFnZS5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLmZpbmQoICIudWktdGl0bGUiICkudGV4dCgpOwoJCQlpZiAoICEhbmV3UGFnZVRpdGxlICYmIHBhZ2VUaXRsZSA9PT0gZG9jdW1lbnQudGl0bGUgKSB7CgkJCQlwYWdlVGl0bGUgPSBuZXdQYWdlVGl0bGU7CgkJCX0KCQkJaWYgKCAhdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJCXRvUGFnZS5qcW1EYXRhKCAidGl0bGUiLCBwYWdlVGl0bGUgKTsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSB0cmFuc2l0aW9uIGRlZmluZWQuCgkJCXNldHRpbmdzLnRyYW5zaXRpb24gPSBzZXR0aW5ncy50cmFuc2l0aW9uIHx8CgkJCQkoICggaGlzdG9yeURpciAmJiAhYWN0aXZlSXNJbml0aWFsUGFnZSApID8gYWN0aXZlLnRyYW5zaXRpb24gOiB1bmRlZmluZWQgKSB8fAoJCQkJKCBpc0RpYWxvZyA/ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uIDogJC5tb2JpbGUuZGVmYXVsdFBhZ2VUcmFuc2l0aW9uICk7CgoJCQkvL2FkZCBwYWdlIHRvIGhpc3Rvcnkgc3RhY2sgaWYgaXQncyBub3QgYmFjayBvciBmb3J3YXJkCgkJCWlmICggIWhpc3RvcnlEaXIgJiYgYWxyZWFkeVRoZXJlICkgewoJCQkJdXJsSGlzdG9yeS5nZXRBY3RpdmUoKS5wYWdlVXJsID0gcGFnZVVybDsKCQkJfQoKCQkJLy8gU2V0IHRoZSBsb2NhdGlvbiBoYXNoLgoJCQlpZiAoIHVybCAmJiAhc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgoJCQkJLy8gcmVidWlsZGluZyB0aGUgaGFzaCBoZXJlIHNpbmNlIHdlIGxvb3NlIGl0IGVhcmxpZXIgb24KCQkJCS8vIFRPRE8gcHJlc2VydmUgdGhlIG9yaWdpbmFsbHkgcGFzc2VkIGluIHBhdGgKCQkJCWlmICggIXBhdGguaXNQYXRoKCB1cmwgKSAmJiB1cmwuaW5kZXhPZiggIiMiICkgPCAwICkgewoJCQkJCXVybCA9ICIjIiArIHVybDsKCQkJCX0KCgkJCQkvLyBUT0RPIHRoZSBwcm9wZXJ0eSBuYW1lcyBoZXJlIGFyZSBqdXN0IHNpbGx5CgkJCQlwYXJhbXMgPSB7CgkJCQkJdHJhbnNpdGlvbjogc2V0dGluZ3MudHJhbnNpdGlvbiwKCQkJCQl0aXRsZTogcGFnZVRpdGxlLAoJCQkJCXBhZ2VVcmw6IHBhZ2VVcmwsCgkJCQkJcm9sZTogc2V0dGluZ3Mucm9sZQoJCQkJfTsKCgkJCQlpZiAoIHNldHRpbmdzLmNoYW5nZUhhc2ggIT09IGZhbHNlICYmICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICkgewoJCQkJCSQubW9iaWxlLm5hdmlnYXRlKCB1cmwsIHBhcmFtcywgdHJ1ZSk7CgkJCQl9IGVsc2UgaWYgKCB0b1BhZ2VbIDAgXSAhPT0gJC5tb2JpbGUuZmlyc3RQYWdlWyAwIF0gKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hZGQoIHVybCwgcGFyYW1zICk7CgkJCQl9CgkJCX0KCgkJCS8vc2V0IHBhZ2UgdGl0bGUKCQkJZG9jdW1lbnQudGl0bGUgPSBwYWdlVGl0bGU7CgoJCQkvL3NldCAidG9QYWdlIiBhcyBhY3RpdmVQYWdlCgkJCSQubW9iaWxlLmFjdGl2ZVBhZ2UgPSB0b1BhZ2U7CgoJCQkvLyBJZiB3ZSdyZSBuYXZpZ2F0aW5nIGJhY2sgaW4gdGhlIFVSTCBoaXN0b3J5LCBzZXQgcmV2ZXJzZSBhY2NvcmRpbmdseS4KCQkJc2V0dGluZ3MucmV2ZXJzZSA9IHNldHRpbmdzLnJldmVyc2UgfHwgaGlzdG9yeURpciA8IDA7CgoJCQljc3NUcmFuc2l0aW9uRGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgoJCQl0aGlzLl9jc3NUcmFuc2l0aW9uKHRvUGFnZSwgZnJvbVBhZ2UsIHsKCQkJCXRyYW5zaXRpb246IHNldHRpbmdzLnRyYW5zaXRpb24sCgkJCQlyZXZlcnNlOiBzZXR0aW5ncy5yZXZlcnNlLAoJCQkJZGVmZXJyZWQ6IGNzc1RyYW5zaXRpb25EZWZlcnJlZAoJCQl9KTsKCgkJCWNzc1RyYW5zaXRpb25EZWZlcnJlZC5kb25lKCQucHJveHkoZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20sIGFscmVhZHlGb2N1c2VkICkgewoJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCk7CgoJCQkJLy9pZiB0aGVyZSdzIGEgZHVwbGljYXRlQ2FjaGVkUGFnZSwgcmVtb3ZlIGl0IGZyb20gdGhlIERPTSBub3cgdGhhdCBpdCdzIGhpZGRlbgoJCQkJaWYgKCBzZXR0aW5ncy5kdXBsaWNhdGVDYWNoZWRQYWdlICkgewoJCQkJCXNldHRpbmdzLmR1cGxpY2F0ZUNhY2hlZFBhZ2UucmVtb3ZlKCk7CgkJCQl9CgoJCQkJLy8gZGVzcGl0ZSB2aXNpYmlsaXR5OiBoaWRkZW4gYWRkcmVzc2VzIGlzc3VlICMyOTY1CgkJCQkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzI5NjUKCQkJCWlmICggIWFscmVhZHlGb2N1c2VkICkgewoJCQkJCSQubW9iaWxlLmZvY3VzUGFnZSggdG9QYWdlICk7CgkJCQl9CgoJCQkJcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpOwoJCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJwYWdlY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCQkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggInRyYW5zaXRpb24iLCB0cmlnZ2VyRGF0YSApOwoJCQl9LCB0aGlzKSk7CgkJfQoJCS8vIFRPRE8gcmVzZXRBY3RpdmVQYWdlSGVpZ2h0CgkJLy8gVE9ETyBjaGFuZ2VQYWdlCgl9KTsKCgkkLm1vYmlsZS5sb2FkUGFnZSA9IGZ1bmN0aW9uKCB1cmwsIG9wdHMgKSB7CgkJdmFyIGNvbnRhaW5lcjsKCgkJb3B0cyA9IG9wdHMgfHwge307CgkJY29udGFpbmVyID0gKCBvcHRzLnBhZ2VDb250YWluZXIgfHwgJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkvLyBjcmVhdGUgdGhlIGRlZmVycmVkIHRoYXQgd2lsbCBiZSBzdXBwbGllZCB0byBsb2FkUGFnZSBjYWxsZXJzCgkJLy8gYW5kIHJlc29sdmVkIGJ5IHRoZSBjb250ZW50IHdpZGdldCdzIGxvYWQgbWV0aG9kCgkJb3B0cy5kZWZlcnJlZCA9ICQuRGVmZXJyZWQoKTsKCgkJLy8gUHJlZmVycmluZyB0byBhbGxvdyBleGNlcHRpb25zIGZvciB1bmluaXRpYWxpemVkIG9wdHMucGFnZUNvbnRhaW5lcgoJCS8vIHdpZGdldHMgc28gd2Uga25vdyBpZiB3ZSBuZWVkIHRvIGZvcmNlIGluaXQgaGVyZSBmb3IgdXNlcnMKCQljb250YWluZXIuY29udGVudCggImxvYWQiLCB1cmwsIG9wdHMgKTsKCgkJLy8gcHJvdmlkZSB0aGUgZGVmZXJyZWQKCQlyZXR1cm4gb3B0cy5kZWZlcnJlZC5wcm9taXNlKCk7Cgl9OwoKCS8vZGVmaW5lIHZhcnMgZm9yIGludGVyYWwgdXNlCgl2YXIgJHdpbmRvdyA9ICQubW9iaWxlLndpbmRvdywKCQkkaGVhZCA9ICQoICJoZWFkIiApLAoKCQkvLyBOT1RFOiBwYXRoIGV4dGVuc2lvbnMgZGVwZW5kZW50IG9uIGNvcmUgYXR0cmlidXRlcy4gTW92ZWQgaGVyZSB0byByZW1vdmUgZGVwcyBmcm9tCgkJLy8gICAgICAgJC5tb2JpbGUucGF0aCBkZWZpbml0aW9uCgkJcGF0aCA9ICQuZXh0ZW5kKCQubW9iaWxlLnBhdGgsIHsKCgkJCS8vcmV0dXJuIHRoZSBzdWJzdHJpbmcgb2YgYSBmaWxlcGF0aCBiZWZvcmUgdGhlIHN1Yi1wYWdlIGtleSwgZm9yIG1ha2luZyBhIHNlcnZlciByZXF1ZXN0CgkJCWdldEZpbGVQYXRoOiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCXZhciBzcGxpdGtleSA9ICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXk7CgkJCQlyZXR1cm4gcGF0aCAmJiBwYXRoLnNwbGl0KCBzcGxpdGtleSApWzBdLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCX0sCgoJCQkvL2NoZWNrIGlmIHRoZSBzcGVjaWZpZWQgdXJsIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgbWFpbiBhcHBsaWNhdGlvbiBkb2N1bWVudC4KCQkJaXNGaXJzdFBhZ2VVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBXZSBvbmx5IGRlYWwgd2l0aCBhYnNvbHV0ZSBwYXRocy4KCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgdGhpcy5kb2N1bWVudEJhc2UgKSApLAoKCQkJCQkvLyBEb2VzIHRoZSB1cmwgaGF2ZSB0aGUgc2FtZSBwYXRoIGFzIHRoZSBkb2N1bWVudD8KCQkJCQlzYW1lUGF0aCA9IHUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudFVybC5ocmVmTm9IYXNoIHx8ICggdGhpcy5kb2N1bWVudEJhc2VEaWZmZXJzICYmIHUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApLAoKCQkJCQkvLyBHZXQgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCQlmcCA9ICQubW9iaWxlLmZpcnN0UGFnZSwKCgoKCQkJCQkvLyBHZXQgdGhlIGlkIG9mIHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQgaWYgaXQgaGFzIG9uZS4KCQkJCQlmcElkID0gZnAgJiYgZnBbMF0gPyBmcFswXS5pZCA6IHVuZGVmaW5lZDsKCgkJCQkvLyBUaGUgdXJsIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpZiB0aGUgcGF0aCBtYXRjaGVzIHRoZSBkb2N1bWVudCBhbmQKCQkJCS8vIGl0IGVpdGhlciBoYXMgbm8gaGFzaCB2YWx1ZSwgb3IgdGhlIGhhc2ggaXMgZXhhY3RseSBlcXVhbCB0byB0aGUgaWQgb2YgdGhlCgkJCQkvLyBmaXJzdCBwYWdlIGVsZW1lbnQuCgkJCQlyZXR1cm4gc2FtZVBhdGggJiYgKCAhdS5oYXNoIHx8IHUuaGFzaCA9PT0gIiMiIHx8ICggZnBJZCAmJiB1Lmhhc2gucmVwbGFjZSggL14jLywgIiIgKSA9PT0gZnBJZCApICk7CgkJCX0sCgoJCQkvLyBTb21lIGVtYmVkZGVkIGJyb3dzZXJzLCBsaWtlIHRoZSB3ZWIgdmlldyBpbiBQaG9uZSBHYXAsIGFsbG93IGNyb3NzLWRvbWFpbiBYSFIKCQkJLy8gcmVxdWVzdHMgaWYgdGhlIGRvY3VtZW50IGRvaW5nIHRoZSByZXF1ZXN0IHdhcyBsb2FkZWQgdmlhIHRoZSBmaWxlOi8vIHByb3RvY29sLgoJCQkvLyBUaGlzIGlzIHVzdWFsbHkgdG8gYWxsb3cgdGhlIGFwcGxpY2F0aW9uIHRvICJwaG9uZSBob21lIiBhbmQgZmV0Y2ggYXBwIHNwZWNpZmljCgkJCS8vIGRhdGEuIFdlIG5vcm1hbGx5IGxldCB0aGUgYnJvd3NlciBoYW5kbGUgZXh0ZXJuYWwvY3Jvc3MtZG9tYWluIHVybHMsIGJ1dCBpZiB0aGUKCQkJLy8gYWxsb3dDcm9zc0RvbWFpblBhZ2VzIG9wdGlvbiBpcyB0cnVlLCB3ZSB3aWxsIGFsbG93IGNyb3NzLWRvbWFpbiBodHRwL2h0dHBzCgkJCS8vIHJlcXVlc3RzIHRvIGdvIHRocm91Z2ggb3VyIHBhZ2UgbG9hZGluZyBsb2dpYy4KCQkJaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3Q6IGZ1bmN0aW9uKCBkb2NVcmwsIHJlcVVybCApIHsKCQkJCXJldHVybiAkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgJiYKCQkJCQkoZG9jVXJsLnByb3RvY29sID09PSAiZmlsZToiIHx8IGRvY1VybC5wcm90b2NvbCA9PT0gImNvbnRlbnQ6IikgJiYKCQkJCQlyZXFVcmwuc2VhcmNoKCAvXmh0dHBzPzovICkgIT09IC0xOwoJCQl9CgkJfSksCgoJCS8vIHVzZWQgdG8gdHJhY2sgbGFzdCB2Y2xpY2tlZCBlbGVtZW50IHRvIG1ha2Ugc3VyZSBpdHMgdmFsdWUgaXMgYWRkZWQgdG8gZm9ybSBkYXRhCgkJJGxhc3RWQ2xpY2tlZCA9IG51bGwsCgoJCS8vd2lsbCBiZSBkZWZpbmVkIHdoZW4gYSBsaW5rIGlzIGNsaWNrZWQgYW5kIGdpdmVuIGFuIGFjdGl2ZSBjbGFzcwoJCSRhY3RpdmVDbGlja2VkTGluayA9IG51bGwsCgoJCS8vIHJlc29sdmVkIG9uIGRvbXJlYWR5CgkJZG9tcmVhZHlEZWZlcnJlZCA9ICQuRGVmZXJyZWQoKSwKCgkJLy91cmxIaXN0b3J5IGlzIHB1cmVseSBoZXJlIHRvIG1ha2UgZ3Vlc3NlcyBhdCB3aGV0aGVyIHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9uIHdhcyBjbGlja2VkCgkJLy9hbmQgcHJvdmlkZSBhbiBhcHByb3ByaWF0ZSB0cmFuc2l0aW9uCgkJdXJsSGlzdG9yeSA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnksCgoJCS8vcXVldWUgdG8gaG9sZCBzaW11bHRhbmlvdXMgcGFnZSB0cmFuc2l0aW9ucwoJCXBhZ2VUcmFuc2l0aW9uUXVldWUgPSBbXSwKCgkJLy9pbmRpY2F0ZXMgd2hldGhlciBvciBub3QgcGFnZSBpcyBpbiBwcm9jZXNzIG9mIHRyYW5zaXRpb25pbmcKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2UsCgoJCS8vbm9uc2Vuc2UgaGFzaCBjaGFuZ2Uga2V5IGZvciBkaWFsb2dzLCBzbyB0aGV5IGNyZWF0ZSBhIGhpc3RvcnkgZW50cnkKCQlkaWFsb2dIYXNoS2V5ID0gIiZ1aS1zdGF0ZT1kaWFsb2ciLAoKCQkvL2V4aXN0aW5nIGJhc2UgdGFnPwoJCSRiYXNlID0gJGhlYWQuY2hpbGRyZW4oICJiYXNlIiApLAoKCQkvL3R1Y2sgYXdheSB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgVVJMIG1pbnVzIGFueSBmcmFnbWVudC4KCQlkb2N1bWVudFVybCA9IHBhdGguZG9jdW1lbnRVcmwsCgoJCS8vaWYgdGhlIGRvY3VtZW50IGhhcyBhbiBlbWJlZGRlZCBiYXNlIHRhZywgZG9jdW1lbnRCYXNlIGlzIHNldCB0byBpdHMKCQkvL2luaXRpYWwgdmFsdWUuIElmIGEgYmFzZSB0YWcgZG9lcyBub3QgZXhpc3QsIHRoZW4gd2UgZGVmYXVsdCB0byB0aGUgZG9jdW1lbnRVcmwuCgkJZG9jdW1lbnRCYXNlID0gcGF0aC5kb2N1bWVudEJhc2UsCgoJCS8vIGJhc2UgZWxlbWVudCBtYW5hZ2VtZW50LCBkZWZpbmVkIGRlcGVuZGluZyBvbiBkeW5hbWljIGJhc2UgdGFnIHN1cHBvcnQKCQkvLyBUT0RPIG1vdmUgdG8gZXh0ZXJuYWwgd2lkZ2V0CgkJYmFzZSA9IHsKCQkJLy9kZWZpbmUgYmFzZSBlbGVtZW50LCBmb3IgdXNlIGluIHJvdXRpbmcgYXNzZXQgdXJscyB0aGF0IGFyZSByZWZlcmVuY2VkIGluIEFqYXgtcmVxdWVzdGVkIG1hcmt1cAoJCQllbGVtZW50OiAoICRiYXNlLmxlbmd0aCA/ICRiYXNlIDogJCggIjxiYXNlPiIsIHsgaHJlZjogZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggfSApLnByZXBlbmRUbyggJGhlYWQgKSApLAoKCQkJbGlua1NlbGVjdG9yOiAiW3NyY10sIGxpbmtbaHJlZl0sIGFbcmVsPSdleHRlcm5hbCddLCA6anFtRGF0YShhamF4PSdmYWxzZScpLCBhW3RhcmdldF0iLAoKCQkJLy9zZXQgdGhlIGdlbmVyYXRlZCBCQVNFIGVsZW1lbnQncyBocmVmIGF0dHJpYnV0ZSB0byBhIG5ldyBwYWdlJ3MgYmFzZSBwYXRoCgkJCXNldDogZnVuY3Rpb24oIGhyZWYgKSB7CgkJCQkvLyB3ZSBzaG91bGQgZG8gbm90aGluZyBpZiB0aGUgdXNlciB3YW50cyB0byBtYW5hZ2UgdGhlaXIgdXJsIGJhc2UgbWFudWFsbHkKCQkJCWlmICggISQubW9iaWxlLmR5bmFtaWNCYXNlRW5hYmxlZCApewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQkvLyB3ZSBzaG91bGQgdXNlIHRoZSBiYXNlIHRhZyBpZiB3ZSBjYW4gbWFuaXB1bGF0ZSBpdCBkeW5hbWljYWxseQoJCQkJaWYgKCAkLnN1cHBvcnQuZHluYW1pY0Jhc2VUYWcgKXsKCQkJCQliYXNlLmVsZW1lbnQuYXR0ciggImhyZWYiLCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgZG9jdW1lbnRCYXNlICkgKTsKCQkJCX0KCQkJfSwKCgkJCXJld3JpdGU6IGZ1bmN0aW9uKCBocmVmLCBwYWdlICkgewoJCQkJdmFyIG5ld1BhdGggPSBwYXRoLmdldCggaHJlZiApOwoKCQkJCXBhZ2UuZmluZCggYmFzZS5saW5rU2VsZWN0b3IgKS5lYWNoKGZ1bmN0aW9uKCBpLCBsaW5rICkgewoJCQkJCXZhciB0aGlzQXR0ciA9ICQoIGxpbmsgKS5pcyggIltocmVmXSIgKSA/ICJocmVmIiA6ICQoIGxpbmsgKS5pcyggIltzcmNdIiApID8gInNyYyIgOiAiYWN0aW9uIiwKCQkJCQl0aGlzVXJsID0gJCggbGluayApLmF0dHIoIHRoaXNBdHRyICk7CgoJCQkJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBmaXggdGhpcyBzbyB0aGF0IGl0IHJlbW92ZXMgdGhlIGRvY3VtZW50CgkJCQkJLy8gICAgICAgICAgICBiYXNlIFVSTCwgYW5kIHRoZW4gcHJlcGVuZHMgd2l0aCB0aGUgbmV3IHBhZ2UgVVJMLgoJCQkJCS8vaWYgZnVsbCBwYXRoIGV4aXN0cyBhbmQgaXMgc2FtZSwgY2hvcCBpdCAtIGhlbHBzIElFIG91dAoJCQkJCXRoaXNVcmwgPSB0aGlzVXJsLnJlcGxhY2UoIGxvY2F0aW9uLnByb3RvY29sICsgIi8vIiArIGxvY2F0aW9uLmhvc3QgKyBsb2NhdGlvbi5wYXRobmFtZSwgIiIgKTsKCgkJCQkJaWYgKCAhL14oXHcrOnwjfFwvKS8udGVzdCggdGhpc1VybCApICkgewoJCQkJCQkkKCBsaW5rICkuYXR0ciggdGhpc0F0dHIsIG5ld1BhdGggKyB0aGlzVXJsICk7CgkJCQkJfQoJCQkJfSk7CgkJCX0sCgoJCQkvL3NldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgYXR0cmlidXRlIHRvIGEgbmV3IHBhZ2UncyBiYXNlIHBhdGgKCQkJcmVzZXQ6IGZ1bmN0aW9uKC8qIGhyZWYgKi8pIHsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsIGRvY3VtZW50QmFzZS5ocmVmTm9TZWFyY2ggKTsKCQkJfQoJCX07CgoJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IHVybAoJJC5tb2JpbGUuZ2V0RG9jdW1lbnRVcmwgPSBwYXRoLmdldERvY3VtZW50VXJsOwoKCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCBiYXNlIHVybAoJJC5tb2JpbGUuZ2V0RG9jdW1lbnRCYXNlID0gcGF0aC5nZXREb2N1bWVudEJhc2U7CgoJLyogaW50ZXJuYWwgdXRpbGl0eSBmdW5jdGlvbnMgKi8KCgkvLyBOT1RFIElzc3VlICM0OTUwIEFuZHJvaWQgcGhvbmVnYXAgZG9lc24ndCBuYXZpZ2F0ZSBiYWNrIHByb3Blcmx5CgkvLyAgICAgIHdoZW4gYSBmdWxsIHBhZ2UgcmVmcmVzaCBoYXMgdGFrZW4gcGxhY2UuIEl0IGFwcGVhcnMgdGhhdCBoYXNoY2hhbmdlCgkvLyAgICAgIGFuZCByZXBsYWNlc3RhdGUgaGlzdG9yeSBhbHRlcmF0aW9ucyB3b3JrIGZpbmUgYnV0IHdlIG5lZWQgdG8gc3VwcG9ydAoJLy8gICAgICBib3RoIGZvcm1zIG9mIGhpc3RvcnkgdHJhdmVyc2FsIGluIG91ciBjb2RlIHRoYXQgdXNlcyBiYWNrd2FyZCBoaXN0b3J5CgkvLyAgICAgIG1vdmVtZW50CgkkLm1vYmlsZS5iYWNrID0gZnVuY3Rpb24oKSB7CgkJdmFyIG5hdiA9IHdpbmRvdy5uYXZpZ2F0b3I7CgoJCS8vIGlmIHRoZSBzZXR0aW5nIGlzIG9uIGFuZCB0aGUgbmF2aWdhdG9yIG9iamVjdCBpcwoJCS8vIGF2YWlsYWJsZSB1c2UgdGhlIHBob25lZ2FwIG5hdmlnYXRpb24gY2FwYWJpbGl0eQoJCWlmICggdGhpcy5waG9uZWdhcE5hdmlnYXRpb25FbmFibGVkICYmCgkJCW5hdiAmJgoJCQluYXYuYXBwICYmCgkJCW5hdi5hcHAuYmFja0hpc3RvcnkgKXsKCQkJbmF2LmFwcC5iYWNrSGlzdG9yeSgpOwoJCX0gZWxzZSB7CgkJCXdpbmRvdy5oaXN0b3J5LmJhY2soKTsKCQl9Cgl9OwoKCS8vZGlyZWN0IGZvY3VzIHRvIHRoZSBwYWdlIHRpdGxlLCBvciBvdGhlcndpc2UgZmlyc3QgZm9jdXNhYmxlIGVsZW1lbnQKCSQubW9iaWxlLmZvY3VzUGFnZSA9IGZ1bmN0aW9uICggcGFnZSApIHsKCQl2YXIgYXV0b2ZvY3VzID0gcGFnZS5maW5kKCAiW2F1dG9mb2N1c10iICksCgkJCXBhZ2VUaXRsZSA9IHBhZ2UuZmluZCggIi51aS10aXRsZTplcSgwKSIgKTsKCgkJaWYgKCBhdXRvZm9jdXMubGVuZ3RoICkgewoJCQlhdXRvZm9jdXMuZm9jdXMoKTsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBwYWdlVGl0bGUubGVuZ3RoICkgewoJCQlwYWdlVGl0bGUuZm9jdXMoKTsKCQl9IGVsc2V7CgkJCXBhZ2UuZm9jdXMoKTsKCQl9Cgl9OwoKCS8vcmVtb3ZlIGFjdGl2ZSBjbGFzc2VzIGFmdGVyIHBhZ2UgdHJhbnNpdGlvbiBvciBlcnJvcgoJZnVuY3Rpb24gcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCBmb3JjZVJlbW92YWwgKSB7CgkJaWYgKCAhISRhY3RpdmVDbGlja2VkTGluayAmJiAoICEkYWN0aXZlQ2xpY2tlZExpbmsuY2xvc2VzdCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICkubGVuZ3RoIHx8IGZvcmNlUmVtb3ZhbCApICkgewoJCQkkYWN0aXZlQ2xpY2tlZExpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfQoJCSRhY3RpdmVDbGlja2VkTGluayA9IG51bGw7Cgl9CgoJZnVuY3Rpb24gcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpIHsKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJaWYgKCBwYWdlVHJhbnNpdGlvblF1ZXVlLmxlbmd0aCA+IDAgKSB7CgkJCSQubW9iaWxlLmNoYW5nZVBhZ2UuYXBwbHkoIG51bGwsIHBhZ2VUcmFuc2l0aW9uUXVldWUucG9wKCkgKTsKCQl9Cgl9CgoJLy8gTm8tb3AgaW1wbGVtZW50YXRpb24gb2YgdHJhbnNpdGlvbiBkZWdyYWRhdGlvbgoJJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gPSAkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiB8fCBmdW5jdGlvbiggdHJhbnNpdGlvbiApIHsKCQlyZXR1cm4gdHJhbnNpdGlvbjsKCX07CgoJLy8gZGV0ZXJtaW5lIHRoZSBjdXJyZW50IGJhc2UgdXJsCglmdW5jdGlvbiBmaW5kQmFzZVdpdGhEZWZhdWx0KCkgewoJCXZhciBjbG9zZXN0QmFzZSA9ICggJC5tb2JpbGUuYWN0aXZlUGFnZSAmJiBnZXRDbG9zZXN0QmFzZVVybCggJC5tb2JpbGUuYWN0aXZlUGFnZSApICk7CgkJcmV0dXJuIGNsb3Nlc3RCYXNlIHx8IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoOwoJfQoKCS8qIGV4cG9zZWQgJC5tb2JpbGUgbWV0aG9kcyAqLwoKCS8vYW5pbWF0aW9uIGNvbXBsZXRlIGNhbGxiYWNrCgkkLmZuLmFuaW1hdGlvbkNvbXBsZXRlID0gZnVuY3Rpb24oIGNhbGxiYWNrICkgewoJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zaXRpb25zICkgewoJCQlyZXR1cm4gJCggdGhpcyApLm9uZSggIndlYmtpdEFuaW1hdGlvbkVuZCBhbmltYXRpb25lbmQiLCBjYWxsYmFjayApOwoJCX0KCQllbHNlewoJCQkvLyBkZWZlciBleGVjdXRpb24gZm9yIGNvbnNpc3RlbmN5IGJldHdlZW4gd2Via2l0L25vbiB3ZWJraXQKCQkJc2V0VGltZW91dCggY2FsbGJhY2ssIDAgKTsKCQkJcmV0dXJuICQoIHRoaXMgKTsKCQl9Cgl9OwoKCS8vZXhwb3NlIHBhdGggb2JqZWN0IG9uICQubW9iaWxlCgkkLm1vYmlsZS5wYXRoID0gcGF0aDsKCgkvL2V4cG9zZSBiYXNlIG9iamVjdCBvbiAkLm1vYmlsZQoJJC5tb2JpbGUuYmFzZSA9IGJhc2U7CgoJLy9oaXN0b3J5IHN0YWNrCgkkLm1vYmlsZS51cmxIaXN0b3J5ID0gdXJsSGlzdG9yeTsKCgkkLm1vYmlsZS5kaWFsb2dIYXNoS2V5ID0gZGlhbG9nSGFzaEtleTsKCgkvL2VuYWJsZSBjcm9zcy1kb21haW4gcGFnZSBzdXBwb3J0CgkkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgPSBmYWxzZTsKCgkkLm1vYmlsZS5jaGFuZ2VQYWdlID0gZnVuY3Rpb24oIHRvLCBvcHRpb25zICkgewoJCSQubW9iaWxlLnBhZ2VDb250YWluZXIuY29udGVudCggImNoYW5nZSIsIHRvLCBvcHRpb25zICk7Cgl9OwoKCSQubW9iaWxlLmNoYW5nZVBhZ2UuZGVmYXVsdHMgPSB7CgkJdHJhbnNpdGlvbjogdW5kZWZpbmVkLAoJCXJldmVyc2U6IGZhbHNlLAoJCWNoYW5nZUhhc2g6IHRydWUsCgkJZnJvbUhhc2hDaGFuZ2U6IGZhbHNlLAoJCXJvbGU6IHVuZGVmaW5lZCwgLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCWR1cGxpY2F0ZUNhY2hlZFBhZ2U6IHVuZGVmaW5lZCwKCQlwYWdlQ29udGFpbmVyOiB1bmRlZmluZWQsCgkJc2hvd0xvYWRNc2c6IHRydWUsIC8vbG9hZGluZyBtZXNzYWdlIHNob3dzIGJ5IGRlZmF1bHQgd2hlbiBwYWdlcyBhcmUgYmVpbmcgZmV0Y2hlZCBkdXJpbmcgY2hhbmdlUGFnZQoJCWRhdGFVcmw6IHVuZGVmaW5lZCwKCQlmcm9tUGFnZTogdW5kZWZpbmVkLAoJCWFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uOiBmYWxzZQoJfTsKCgkvKiBFdmVudCBCaW5kaW5ncyAtIGhhc2hjaGFuZ2UsIHN1Ym1pdCwgYW5kIGNsaWNrICovCglmdW5jdGlvbiBmaW5kQ2xvc2VzdExpbmsoIGVsZSApCXsKCQl3aGlsZSAoIGVsZSApIHsKCQkJLy8gTG9vayBmb3IgdGhlIGNsb3Nlc3QgZWxlbWVudCB3aXRoIGEgbm9kZU5hbWUgb2YgImEiLgoJCQkvLyBOb3RlIHRoYXQgd2UgYXJlIGNoZWNraW5nIGlmIHdlIGhhdmUgYSB2YWxpZCBub2RlTmFtZQoJCQkvLyBiZWZvcmUgYXR0ZW1wdGluZyB0byBhY2Nlc3MgaXQuIFRoaXMgaXMgYmVjYXVzZSB0aGUKCQkJLy8gbm9kZSB3ZSBnZXQgY2FsbGVkIHdpdGggY291bGQgaGF2ZSBvcmlnaW5hdGVkIGZyb20gd2l0aGluCgkJCS8vIGFuIGVtYmVkZGVkIFNWRyBkb2N1bWVudCB3aGVyZSBzb21lIHN5bWJvbCBpbnN0YW5jZSBlbGVtZW50cwoJCQkvLyBkb24ndCBoYXZlIG5vZGVOYW1lIGRlZmluZWQgb24gdGhlbSwgb3Igc3RyaW5ncyBhcmUgb2YgdHlwZQoJCQkvLyBTVkdBbmltYXRlZFN0cmluZy4KCQkJaWYgKCAoIHR5cGVvZiBlbGUubm9kZU5hbWUgPT09ICJzdHJpbmciICkgJiYgZWxlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJhIiApIHsKCQkJCWJyZWFrOwoJCQl9CgkJCWVsZSA9IGVsZS5wYXJlbnROb2RlOwoJCX0KCQlyZXR1cm4gZWxlOwoJfQoKCS8vIFRoZSBiYXNlIFVSTCBmb3IgYW55IGdpdmVuIGVsZW1lbnQgZGVwZW5kcyBvbiB0aGUgcGFnZSBpdCByZXNpZGVzIGluLgoJZnVuY3Rpb24gZ2V0Q2xvc2VzdEJhc2VVcmwoIGVsZSApCXsKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhZ2UgYW5kIGV4dHJhY3Qgb3V0IGl0cyB1cmwuCgkJdmFyIHVybCA9ICQoIGVsZSApLmNsb3Nlc3QoICIudWktcGFnZSIgKS5qcW1EYXRhKCAidXJsIiApLAoJCQliYXNlID0gZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgoJCWlmICggISQubW9iaWxlLmR5bmFtaWNCYXNlRW5hYmxlZCB8fCAhdXJsIHx8ICFwYXRoLmlzUGF0aCggdXJsICkgKSB7CgkJCXVybCA9IGJhc2U7CgkJfQoKCQlyZXR1cm4gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgYmFzZSApOwoJfQoKCS8vVGhlIGZvbGxvd2luZyBldmVudCBiaW5kaW5ncyBzaG91bGQgYmUgYm91bmQgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgYmVlbiB0cmlnZ2VyZWQKCS8vdGhlIGZvbGxvd2luZyBkZWZlcnJlZCBpcyByZXNvbHZlZCBpbiB0aGUgaW5pdCBmaWxlCgkkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkID0gJC5EZWZlcnJlZCgpOwoJJC5tb2JpbGUuX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMgPSBmdW5jdGlvbigpIHsKCQl2YXIgZ2V0QWpheEZvcm1EYXRhID0gZnVuY3Rpb24oICRmb3JtLCBjYWxjdWxhdGVPbmx5ICkgewoJCQl2YXIgdXJsLCByZXQgPSB0cnVlLCBmb3JtRGF0YSwgdmNsaWNrZWROYW1lLCBtZXRob2Q7CgkJCWlmICggISQubW9iaWxlLmFqYXhFbmFibGVkIHx8CgkJCQkJLy8gdGVzdCB0aGF0IHRoZSBmb3JtIGlzLCBpdHNlbGYsIGFqYXggZmFsc2UKCQkJCQkkZm9ybS5pcyggIjpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiICkgfHwKCQkJCQkvLyB0ZXN0IHRoYXQgJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgaXMgc2V0IGFuZAoJCQkJCS8vIHRoZSBmb3JtIG9yIG9uZSBvZiBpdCdzIHBhcmVudHMgaXMgYWpheD1mYWxzZQoJCQkJCSEkZm9ybS5qcW1IaWphY2thYmxlKCkubGVuZ3RoIHx8CgkJCQkJJGZvcm0uYXR0ciggInRhcmdldCIgKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJdXJsID0gKCAkbGFzdFZDbGlja2VkICYmICRsYXN0VkNsaWNrZWQuYXR0ciggImZvcm1hY3Rpb24iICkgKSB8fAoJCQkJJGZvcm0uYXR0ciggImFjdGlvbiIgKTsKCQkJbWV0aG9kID0gKCAkZm9ybS5hdHRyKCAibWV0aG9kIiApIHx8ICJnZXQiICkudG9Mb3dlckNhc2UoKTsKCgkJCS8vIElmIG5vIGFjdGlvbiBpcyBzcGVjaWZpZWQsIGJyb3dzZXJzIGRlZmF1bHQgdG8gdXNpbmcgdGhlCgkJCS8vIFVSTCBvZiB0aGUgZG9jdW1lbnQgY29udGFpbmluZyB0aGUgZm9ybS4gU2luY2Ugd2UgZHluYW1pY2FsbHkKCQkJLy8gcHVsbCBpbiBwYWdlcyBmcm9tIGV4dGVybmFsIGRvY3VtZW50cywgdGhlIGZvcm0gc2hvdWxkIHN1Ym1pdAoJCQkvLyB0byB0aGUgVVJMIGZvciB0aGUgc291cmNlIGRvY3VtZW50IG9mIHRoZSBwYWdlIGNvbnRhaW5pbmcKCQkJLy8gdGhlIGZvcm0uCgkJCWlmICggIXVybCApIHsKCQkJCS8vIEdldCB0aGUgQGRhdGEtdXJsIGZvciB0aGUgcGFnZSBjb250YWluaW5nIHRoZSBmb3JtLgoJCQkJdXJsID0gZ2V0Q2xvc2VzdEJhc2VVcmwoICRmb3JtICk7CgoJCQkJLy8gTk9URTogSWYgdGhlIG1ldGhvZCBpcyAiZ2V0Iiwgd2UgbmVlZCB0byBzdHJpcCBvZmYgdGhlIHF1ZXJ5IHN0cmluZwoJCQkJLy8gYmVjYXVzZSBpdCB3aWxsIGdldCByZXBsYWNlZCB3aXRoIHRoZSBuZXcgZm9ybSBkYXRhLiBTZWUgaXNzdWUgIzU3MTAuCgkJCQlpZiAoIG1ldGhvZCA9PT0gImdldCIgKSB7CgkJCQkJdXJsID0gcGF0aC5wYXJzZVVybCggdXJsICkuaHJlZk5vU2VhcmNoOwoJCQkJfQoKCQkJCWlmICggdXJsID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApIHsKCQkJCQkvLyBUaGUgdXJsIHdlIGdvdCBiYWNrIG1hdGNoZXMgdGhlIGRvY3VtZW50IGJhc2UsCgkJCQkJLy8gd2hpY2ggbWVhbnMgdGhlIHBhZ2UgbXVzdCBiZSBhbiBpbnRlcm5hbC9lbWJlZGRlZCBwYWdlLAoJCQkJCS8vIHNvIGRlZmF1bHQgdG8gdXNpbmcgdGhlIGFjdHVhbCBkb2N1bWVudCB1cmwgYXMgYSBicm93c2VyCgkJCQkJLy8gd291bGQuCgkJCQkJdXJsID0gZG9jdW1lbnRVcmwuaHJlZk5vU2VhcmNoOwoJCQkJfQoJCQl9CgoJCQl1cmwgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggIHVybCwgZ2V0Q2xvc2VzdEJhc2VVcmwoICRmb3JtICkgKTsKCgkJCWlmICggKCBwYXRoLmlzRXh0ZXJuYWwoIHVybCApICYmICFwYXRoLmlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0KCBkb2N1bWVudFVybCwgdXJsICkgKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJaWYgKCAhY2FsY3VsYXRlT25seSApIHsKCQkJCWZvcm1EYXRhID0gJGZvcm0uc2VyaWFsaXplQXJyYXkoKTsKCgkJCQlpZiAoICRsYXN0VkNsaWNrZWQgJiYgJGxhc3RWQ2xpY2tlZFsgMCBdLmZvcm0gPT09ICRmb3JtWyAwIF0gKSB7CgkJCQkJdmNsaWNrZWROYW1lID0gJGxhc3RWQ2xpY2tlZC5hdHRyKCAibmFtZSIgKTsKCQkJCQlpZiAoIHZjbGlja2VkTmFtZSApIHsKCQkJCQkJLy8gTWFrZSBzdXJlIHRoZSBsYXN0IGNsaWNrZWQgZWxlbWVudCBpcyBpbmNsdWRlZCBpbiB0aGUgZm9ybQoJCQkJCQkkLmVhY2goIGZvcm1EYXRhLCBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJCQkJCWlmICggdmFsdWUubmFtZSA9PT0gdmNsaWNrZWROYW1lICkgewoJCQkJCQkJCS8vIFVuc2V0IHZjbGlja2VkTmFtZSAtIHdlJ3ZlIGZvdW5kIGl0IGluIHRoZSBzZXJpYWxpemVkIGRhdGEgYWxyZWFkeQoJCQkJCQkJCXZjbGlja2VkTmFtZSA9ICIiOwoJCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCX0KCQkJCQkJfSk7CgkJCQkJCWlmICggdmNsaWNrZWROYW1lICkgewoJCQkJCQkJZm9ybURhdGEucHVzaCggeyBuYW1lOiB2Y2xpY2tlZE5hbWUsIHZhbHVlOiAkbGFzdFZDbGlja2VkLmF0dHIoICJ2YWx1ZSIgKSB9ICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgoJCQkJcmV0ID0gewoJCQkJCXVybDogdXJsLAoJCQkJCW9wdGlvbnM6IHsKCQkJCQkJdHlwZToJCW1ldGhvZCwKCQkJCQkJZGF0YToJCSQucGFyYW0oIGZvcm1EYXRhICksCgkJCQkJCXRyYW5zaXRpb246CSRmb3JtLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJCQlyZXZlcnNlOgkkZm9ybS5qcW1EYXRhKCAiZGlyZWN0aW9uIiApID09PSAicmV2ZXJzZSIsCgkJCQkJCXJlbG9hZFBhZ2U6CXRydWUKCQkJCQl9CgkJCQl9OwoJCQl9CgoJCQlyZXR1cm4gcmV0OwoJCX07CgoJCS8vYmluZCB0byBmb3JtIHN1Ym1pdCBldmVudHMsIGhhbmRsZSB3aXRoIEFqYXgKCQkkLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggImZvcm0iLCAic3VibWl0IiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZm9ybURhdGE7CgoJCQlpZiAoICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCWZvcm1EYXRhID0gZ2V0QWpheEZvcm1EYXRhKCAkKCB0aGlzICkgKTsKCQkJCWlmICggZm9ybURhdGEgKSB7CgkJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggZm9ybURhdGEudXJsLCBmb3JtRGF0YS5vcHRpb25zICk7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCX0KCQkJfQoJCX0pOwoKCQkvL2FkZCBhY3RpdmUgc3RhdGUgb24gdmNsaWNrCgkJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyICRidG4sIGJ0bkVscywgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0LCBuZWVkQ2xvc2VzdCA9IGZhbHNlOwoJCQkvLyBpZiB0aGlzIGlzbid0IGEgbGVmdCBjbGljayB3ZSBkb24ndCBjYXJlLiBJdHMgaW1wb3J0YW50IHRvIG5vdGUKCQkJLy8gdGhhdCB3aGVuIHRoZSB2aXJ0dWFsIGV2ZW50IGlzIGdlbmVyYXRlZCBpdCB3aWxsIGNyZWF0ZSB0aGUgd2hpY2ggYXR0cgoJCQlpZiAoIGV2ZW50LndoaWNoID4gMSB8fCAhJC5tb2JpbGUubGlua0JpbmRpbmdFbmFibGVkICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBSZWNvcmQgdGhhdCB0aGlzIGVsZW1lbnQgd2FzIGNsaWNrZWQsIGluIGNhc2Ugd2UgbmVlZCBpdCBmb3IgY29ycmVjdAoJCQkvLyBmb3JtIHN1Ym1pc3Npb24gZHVyaW5nIHRoZSAic3VibWl0IiBoYW5kbGVyIGFib3ZlCgkJCSRsYXN0VkNsaWNrZWQgPSAkKCB0YXJnZXQgKTsKCgkJCS8vIFRyeSB0byBmaW5kIGEgdGFyZ2V0IGVsZW1lbnQgdG8gd2hpY2ggdGhlIGFjdGl2ZSBjbGFzcyB3aWxsIGJlIGFwcGxpZWQKCQkJaWYgKCAkLmRhdGEoIHRhcmdldCwgIm1vYmlsZS1idXR0b24iICkgKSB7CgkJCQkvLyBJZiB0aGUgZm9ybSB3aWxsIG5vdCBiZSBzdWJtaXR0ZWQgdmlhIEFKQVgsIGRvIG5vdCBhZGQgYWN0aXZlIGNsYXNzCgkJCQlpZiAoICFnZXRBamF4Rm9ybURhdGEoICQoIHRhcmdldCApLmNsb3Nlc3QoICJmb3JtIiApLCB0cnVlICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJLy8gV2Ugd2lsbCBhcHBseSB0aGUgYWN0aXZlIHN0YXRlIHRvIHRoaXMgYnV0dG9uIHdpZGdldCAtIHRoZSBwYXJlbnQKCQkJCS8vIG9mIHRoZSBpbnB1dCB0aGF0IHdhcyBjbGlja2VkIHdpbGwgaGF2ZSB0aGUgYXNzb2NpYXRlZCBkYXRhCgkJCQlpZiAoIHRhcmdldC5wYXJlbnROb2RlICkgewoJCQkJCXRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJdGFyZ2V0ID0gZmluZENsb3Nlc3RMaW5rKCB0YXJnZXQgKTsKCQkJCWlmICggISggdGFyZ2V0ICYmIHBhdGgucGFyc2VVcmwoIHRhcmdldC5nZXRBdHRyaWJ1dGUoICJocmVmIiApIHx8ICIjIiApLmhhc2ggIT09ICIjIiApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQkvLyBUT0RPIHRlYWNoICQubW9iaWxlLmhpamFja2FibGUgdG8gb3BlcmF0ZSBvbiByYXcgZG9tIGVsZW1lbnRzIHNvIHRoZQoJCQkJLy8gbGluayB3cmFwcGluZyBjYW4gYmUgYXZvaWRlZAoJCQkJaWYgKCAhJCggdGFyZ2V0ICkuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCgkJCS8vIEF2b2lkIGNhbGxpbmcgLmNsb3Nlc3QgYnkgdXNpbmcgdGhlIGRhdGEgc2V0IGR1cmluZyAuYnV0dG9uTWFya3VwKCkKCQkJLy8gTGlzdCBpdGVtcyBoYXZlIHRoZSBidXR0b24gZGF0YSBpbiB0aGUgcGFyZW50IG9mIHRoZSBlbGVtZW50IGNsaWNrZWQKCQkJaWYgKCAhIX50YXJnZXQuY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1saW5rLWluaGVyaXQiICkgKSB7CgkJCQlpZiAoIHRhcmdldC5wYXJlbnROb2RlICkgewoJCQkJCWJ0bkVscyA9ICQuZGF0YSggdGFyZ2V0LnBhcmVudE5vZGUsICJidXR0b25FbGVtZW50cyIgKTsKCQkJCX0KCQkJLy8gT3RoZXJ3aXNlLCBsb29rIGZvciB0aGUgZGF0YSBvbiB0aGUgdGFyZ2V0IGl0c2VsZgoJCQl9IGVsc2UgewoJCQkJYnRuRWxzID0gJC5kYXRhKCB0YXJnZXQsICJidXR0b25FbGVtZW50cyIgKTsKCQkJfQoJCQkvLyBJZiBmb3VuZCwgZ3JhYiB0aGUgYnV0dG9uJ3Mgb3V0ZXIgZWxlbWVudAoJCQlpZiAoIGJ0bkVscyApIHsKCQkJCXRhcmdldCA9IGJ0bkVscy5vdXRlcjsKCQkJfSBlbHNlIHsKCQkJCW5lZWRDbG9zZXN0ID0gdHJ1ZTsKCQkJfQoKCQkJJGJ0biA9ICQoIHRhcmdldCApOwoJCQkvLyBJZiB0aGUgb3V0ZXIgZWxlbWVudCB3YXNuJ3QgZm91bmQgYnkgdGhlIG91ciBoZXVyaXN0aWNzLCB1c2UgLmNsb3Nlc3QoKQoJCQlpZiAoIG5lZWRDbG9zZXN0ICkgewoJCQkJJGJ0biA9ICRidG4uY2xvc2VzdCggIi51aS1idG4iICk7CgkJCX0KCgkJCWlmICggJGJ0bi5sZW5ndGggPiAwICYmICEkYnRuLmhhc0NsYXNzKCAidWktZGlzYWJsZWQiICkgKSB7CgkJCQlyZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsKCQkJCSRhY3RpdmVDbGlja2VkTGluayA9ICRidG47CgkJCQkkYWN0aXZlQ2xpY2tlZExpbmsuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0KCQl9KTsKCgkJLy8gY2xpY2sgcm91dGluZyAtIGRpcmVjdCB0byBIVFRQIG9yIEFqYXgsIGFjY29yZGluZ2x5CgkJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoICEkLm1vYmlsZS5saW5rQmluZGluZ0VuYWJsZWQgfHwgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBsaW5rID0gZmluZENsb3Nlc3RMaW5rKCBldmVudC50YXJnZXQgKSwKCQkJCSRsaW5rID0gJCggbGluayApLAoJCQkJaHR0cENsZWFudXAsCgkJCQliYXNlVXJsLCBocmVmLAoJCQkJdXNlRGVmYXVsdFVybEhhbmRsaW5nLCBpc0V4dGVybmFsLAoJCQkJdHJhbnNpdGlvbiwgcmV2ZXJzZSwgcm9sZTsKCgkJCS8vIElmIHRoZXJlIGlzIG5vIGxpbmsgYXNzb2NpYXRlZCB3aXRoIHRoZSBjbGljayBvciBpdHMgbm90IGEgbGVmdAoJCQkvLyBjbGljayB3ZSB3YW50IHRvIGlnbm9yZSB0aGUgY2xpY2sKCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUgbGluayB3cmFwcGluZwoJCQkvLyBjYW4gYmUgYXZvaWRlZAoJCQlpZiAoICFsaW5rIHx8IGV2ZW50LndoaWNoID4gMSB8fCAhJGxpbmsuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy9yZW1vdmUgYWN0aXZlIGxpbmsgY2xhc3MgaWYgZXh0ZXJuYWwgKHRoZW4gaXQgd29uJ3QgYmUgdGhlcmUgaWYgeW91IGNvbWUgYmFjaykKCQkJaHR0cENsZWFudXAgPSBmdW5jdGlvbigpIHsKCQkJCXdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyByZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsgfSwgMjAwICk7CgkJCX07CgoJCQkvL2lmIHRoZXJlJ3MgYSBkYXRhLXJlbD1iYWNrIGF0dHIsIGdvIGJhY2sgaW4gaGlzdG9yeQoJCQlpZiAoICRsaW5rLmlzKCAiOmpxbURhdGEocmVsPSdiYWNrJykiICkgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCWJhc2VVcmwgPSBnZXRDbG9zZXN0QmFzZVVybCggJGxpbmsgKTsKCgkJCS8vZ2V0IGhyZWYsIGlmIGRlZmluZWQsIG90aGVyd2lzZSBkZWZhdWx0IHRvIGVtcHR5IGhhc2gKCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCAkbGluay5hdHRyKCAiaHJlZiIgKSB8fCAiIyIsIGJhc2VVcmwgKTsKCgkJCS8vaWYgYWpheCBpcyBkaXNhYmxlZCwgZXhpdCBlYXJseQoJCQlpZiAoICEkLm1vYmlsZS5hamF4RW5hYmxlZCAmJiAhcGF0aC5pc0VtYmVkZGVkUGFnZSggaHJlZiApICkgewoJCQkJaHR0cENsZWFudXAoKTsKCQkJCS8vdXNlIGRlZmF1bHQgY2xpY2sgaGFuZGxpbmcKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gWFhYX2pibGFzOiBJZGVhbGx5IGxpbmtzIHRvIGFwcGxpY2F0aW9uIHBhZ2VzIHNob3VsZCBiZSBzcGVjaWZpZWQgYXMKCQkJLy8gICAgICAgICAgICBhbiB1cmwgdG8gdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHdpdGggYSBoYXNoIHRoYXQgaXMgZWl0aGVyCgkJCS8vICAgICAgICAgICAgdGhlIHNpdGUgcmVsYXRpdmUgcGF0aCBvciBpZCB0byB0aGUgcGFnZS4gQnV0IHNvbWUgb2YgdGhlCgkJCS8vICAgICAgICAgICAgaW50ZXJuYWwgY29kZSB0aGF0IGR5bmFtaWNhbGx5IGdlbmVyYXRlcyBzdWItcGFnZXMgZm9yIG5lc3RlZAoJCQkvLyAgICAgICAgICAgIGxpc3RzIGFuZCBzZWxlY3QgZGlhbG9ncywganVzdCB3cml0ZSBhIGhhc2ggaW4gdGhlIGxpbmsgdGhleQoJCQkvLyAgICAgICAgICAgIGNyZWF0ZS4gVGhpcyBtZWFucyB0aGUgYWN0dWFsIFVSTCBwYXRoIGlzIGJhc2VkIG9uIHdoYXRldmVyCgkJCS8vICAgICAgICAgICAgdGhlIGN1cnJlbnQgdmFsdWUgb2YgdGhlIGJhc2UgdGFnIGlzIGF0IHRoZSB0aW1lIHRoaXMgY29kZQoJCQkvLyAgICAgICAgICAgIGlzIGNhbGxlZC4gRm9yIG5vdyB3ZSBhcmUganVzdCBhc3N1bWluZyB0aGF0IGFueSB1cmwgd2l0aCBhCgkJCS8vICAgICAgICAgICAgaGFzaCBpbiBpdCBpcyBhbiBhcHBsaWNhdGlvbiBwYWdlIHJlZmVyZW5jZS4KCQkJaWYgKCBocmVmLnNlYXJjaCggIiMiICkgIT09IC0xICkgewoJCQkJaHJlZiA9IGhyZWYucmVwbGFjZSggL1teI10qIy8sICIiICk7CgkJCQlpZiAoICFocmVmICkgewoJCQkJCS8vbGluayB3YXMgYW4gZW1wdHkgaGFzaCBtZWFudCBwdXJlbHkKCQkJCQkvL2ZvciBpbnRlcmFjdGlvbiwgc28gd2UgaWdub3JlIGl0LgoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfSBlbHNlIGlmICggcGF0aC5pc1BhdGgoIGhyZWYgKSApIHsKCQkJCQkvL3dlIGhhdmUgYXBhdGggc28gbWFrZSBpdCB0aGUgaHJlZiB3ZSB3YW50IHRvIGxvYWQuCgkJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCBocmVmLCBiYXNlVXJsICk7CgkJCQl9IGVsc2UgewoJCQkJCS8vd2UgaGF2ZSBhIHNpbXBsZSBpZCBzbyB1c2UgdGhlIGRvY3VtZW50VXJsIGFzIGl0cyBiYXNlLgoJCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgaHJlZiwgZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCApOwoJCQkJfQoJCQl9CgoJCQkvLyBTaG91bGQgd2UgaGFuZGxlIHRoaXMgbGluaywgb3IgbGV0IHRoZSBicm93c2VyIGRlYWwgd2l0aCBpdD8KCQkJdXNlRGVmYXVsdFVybEhhbmRsaW5nID0gJGxpbmsuaXMoICJbcmVsPSdleHRlcm5hbCddIiApIHx8ICRsaW5rLmlzKCAiOmpxbURhdGEoYWpheD0nZmFsc2UnKSIgKSB8fCAkbGluay5pcyggIlt0YXJnZXRdIiApOwoKCQkJLy8gU29tZSBlbWJlZGRlZCBicm93c2VycywgbGlrZSB0aGUgd2ViIHZpZXcgaW4gUGhvbmUgR2FwLCBhbGxvdyBjcm9zcy1kb21haW4gWEhSCgkJCS8vIHJlcXVlc3RzIGlmIHRoZSBkb2N1bWVudCBkb2luZyB0aGUgcmVxdWVzdCB3YXMgbG9hZGVkIHZpYSB0aGUgZmlsZTovLyBwcm90b2NvbC4KCQkJLy8gVGhpcyBpcyB1c3VhbGx5IHRvIGFsbG93IHRoZSBhcHBsaWNhdGlvbiB0byAicGhvbmUgaG9tZSIgYW5kIGZldGNoIGFwcCBzcGVjaWZpYwoJCQkvLyBkYXRhLiBXZSBub3JtYWxseSBsZXQgdGhlIGJyb3dzZXIgaGFuZGxlIGV4dGVybmFsL2Nyb3NzLWRvbWFpbiB1cmxzLCBidXQgaWYgdGhlCgkJCS8vIGFsbG93Q3Jvc3NEb21haW5QYWdlcyBvcHRpb24gaXMgdHJ1ZSwgd2Ugd2lsbCBhbGxvdyBjcm9zcy1kb21haW4gaHR0cC9odHRwcwoJCQkvLyByZXF1ZXN0cyB0byBnbyB0aHJvdWdoIG91ciBwYWdlIGxvYWRpbmcgbG9naWMuCgoJCQkvL2NoZWNrIGZvciBwcm90b2NvbCBvciByZWwgYW5kIGl0cyBub3QgYW4gZW1iZWRkZWQgcGFnZQoJCQkvL1RPRE8gb3ZlcmxhcCBpbiBsb2dpYyBmcm9tIGlzRXh0ZXJuYWwsIHJlbD1leHRlcm5hbCBjaGVjayBzaG91bGQgYmUKCQkJLy8gICAgIG1vdmVkIGludG8gbW9yZSBjb21wcmVoZW5zaXZlIGlzRXh0ZXJuYWxMaW5rCgkJCWlzRXh0ZXJuYWwgPSB1c2VEZWZhdWx0VXJsSGFuZGxpbmcgfHwgKCBwYXRoLmlzRXh0ZXJuYWwoIGhyZWYgKSAmJiAhcGF0aC5pc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdCggZG9jdW1lbnRVcmwsIGhyZWYgKSApOwoKCQkJaWYgKCBpc0V4dGVybmFsICkgewoJCQkJaHR0cENsZWFudXAoKTsKCQkJCS8vdXNlIGRlZmF1bHQgY2xpY2sgaGFuZGxpbmcKCQkJCXJldHVybjsKCQkJfQoKCQkJLy91c2UgYWpheAoJCQl0cmFuc2l0aW9uID0gJGxpbmsuanFtRGF0YSggInRyYW5zaXRpb24iICk7CgkJCXJldmVyc2UgPSAkbGluay5qcW1EYXRhKCAiZGlyZWN0aW9uIiApID09PSAicmV2ZXJzZSIgfHwKCQkJCQkJLy8gZGVwcmVjYXRlZCAtIHJlbW92ZSBieSAxLjAKCQkJCQkJJGxpbmsuanFtRGF0YSggImJhY2siICk7CgoJCQkvL3RoaXMgbWF5IG5lZWQgdG8gYmUgbW9yZSBzcGVjaWZpYyBhcyB3ZSB1c2UgZGF0YS1yZWwgbW9yZQoJCQlyb2xlID0gJGxpbmsuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbCIgKSB8fCB1bmRlZmluZWQ7CgoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBocmVmLCB7IHRyYW5zaXRpb246IHRyYW5zaXRpb24sIHJldmVyc2U6IHJldmVyc2UsIHJvbGU6IHJvbGUsIGxpbms6ICRsaW5rIH0gKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9KTsKCgkJLy9wcmVmZXRjaCBwYWdlcyB3aGVuIGFuY2hvcnMgd2l0aCBkYXRhLXByZWZldGNoIGFyZSBlbmNvdW50ZXJlZAoJCSQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAiLnVpLXBhZ2UiLCAicGFnZXNob3cucHJlZmV0Y2giLCBmdW5jdGlvbigpIHsKCQkJdmFyIHVybHMgPSBbXTsKCQkJJCggdGhpcyApLmZpbmQoICJhOmpxbURhdGEocHJlZmV0Y2gpIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgJGxpbmsgPSAkKCB0aGlzICksCgkJCQkJdXJsID0gJGxpbmsuYXR0ciggImhyZWYiICk7CgoJCQkJaWYgKCB1cmwgJiYgJC5pbkFycmF5KCB1cmwsIHVybHMgKSA9PT0gLTEgKSB7CgkJCQkJdXJscy5wdXNoKCB1cmwgKTsKCgkJCQkJJC5tb2JpbGUubG9hZFBhZ2UoIHVybCwgeyByb2xlOiAkbGluay5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIiApLHByZWZldGNoOiB0cnVlIH0gKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgoJCS8vIFRPRE8gZW5zdXJlIHRoYXQgdGhlIG5hdmlnYXRlIGJpbmRpbmcgaW4gdGhlIGNvbnRlbnQgd2lkZ2V0IGhhcHBlbnMgYXQgdGhlIHJpZ2h0IHRpbWUKCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLmNvbnRlbnQoKTsKCgkJLy9zZXQgcGFnZSBtaW4taGVpZ2h0cyB0byBiZSBkZXZpY2Ugc3BlY2lmaWMKCQkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZXNob3ciLCAkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCQkkLm1vYmlsZS53aW5kb3cuYmluZCggInRocm90dGxlZHJlc2l6ZSIsICQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCApOwoKCX07Ly9uYXZyZWFkeURlZmVycmVkIGRvbmUgY2FsbGJhY2sKCgkkKCBmdW5jdGlvbigpIHsgZG9tcmVhZHlEZWZlcnJlZC5yZXNvbHZlKCk7IH0gKTsKCgkkLndoZW4oIGRvbXJlYWR5RGVmZXJyZWQsICQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQgKS5kb25lKCBmdW5jdGlvbigpIHsgJC5tb2JpbGUuX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMoKTsgfSApOwp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCgkvLyBUT0RPIHJlbW92ZSBkaXJlY3QgcmVmZXJlbmNlcyB0byAkLm1vYmlsZSBhbmQgcHJvcGVydGllcywgd2Ugc2hvdWxkCgkvLyAgICAgIGZhdm9yIGluamVjdGlvbiB3aXRoIHBhcmFtcyB0byB0aGUgY29uc3RydWN0b3IKCSQubW9iaWxlLlRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQl0aGlzLmluaXQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5UcmFuc2l0aW9uLnByb3RvdHlwZSwgewoJCXRvUHJlQ2xhc3M6ICIgdWktcGFnZS1wcmUtaW4iLAoKCQlpbml0OiBmdW5jdGlvbiggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSApIHsKCQkJJC5leHRlbmQodGhpcywgewoJCQkJbmFtZTogbmFtZSwKCQkJCXJldmVyc2U6IHJldmVyc2UsCgkJCQkkdG86ICR0bywKCQkJCSRmcm9tOiAkZnJvbSwKCQkJCWRlZmVycmVkOiBuZXcgJC5EZWZlcnJlZCgpCgkJCX0pOwoJCX0sCgoJCWNsZWFuRnJvbTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuJGZyb20KCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICsgIiBvdXQgaW4gcmV2ZXJzZSAiICsgdGhpcy5uYW1lICkKCQkJCS5oZWlnaHQoICIiICk7CgkJfSwKCgkJLy8gTk9URSBvdmVycmlkZGVuIGJ5IGNoaWxkIG9iamVjdCBwcm90b3R5cGVzLCBub29wJ2QgaGVyZSBhcyBkZWZhdWx0cwoJCWJlZm9yZURvbmVJbjogZnVuY3Rpb24oKSB7fSwKCQliZWZvcmVEb25lT3V0OiBmdW5jdGlvbigpIHt9LAoJCWJlZm9yZVN0YXJ0T3V0OiBmdW5jdGlvbigpIHt9LAoKCQlkb25lSW46IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmJlZm9yZURvbmVJbigpOwoKCQkJdGhpcy4kdG8ucmVtb3ZlQ2xhc3MoICJvdXQgaW4gcmV2ZXJzZSAiICsgdGhpcy5uYW1lICkuaGVpZ2h0KCAiIiApOwoKCQkJdGhpcy50b2dnbGVWaWV3cG9ydENsYXNzKCk7CgoJCQkvLyBJbiBzb21lIGJyb3dzZXJzIChpT1M1KSwgM0QgdHJhbnNpdGlvbnMgYmxvY2sgdGhlIGFiaWxpdHkgdG8gc2Nyb2xsIHRvIHRoZSBkZXNpcmVkIGxvY2F0aW9uIGR1cmluZyB0cmFuc2l0aW9uCgkJCS8vIFRoaXMgZW5zdXJlcyB3ZSBqdW1wIHRvIHRoYXQgc3BvdCBhZnRlciB0aGUgZmFjdCwgaWYgd2UgYXJlbid0IHRoZXJlIGFscmVhZHkuCgkJCWlmICggJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpICE9PSB0aGlzLnRvU2Nyb2xsICkgewoJCQkJdGhpcy5zY3JvbGxQYWdlKCk7CgkJCX0KCgkJCXRoaXMuZGVmZXJyZWQucmVzb2x2ZSggdGhpcy5uYW1lLCB0aGlzLnJldmVyc2UsIHRoaXMuJHRvLCB0aGlzLiRmcm9tLCB0cnVlICk7CgkJfSwKCgkJZG9uZU91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKSB7CgkJCXRoaXMuYmVmb3JlRG9uZU91dCgpOwoJCQl0aGlzLnN0YXJ0SW4oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKTsKCQl9LAoKCQloaWRlSW46IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQkJLy8gUHJldmVudCBmbGlja2VyaW5nIGluIHBob25lZ2FwIGNvbnRhaW5lcjogc2VlIGNvbW1lbnRzIGF0ICM0MDI0IHJlZ2FyZGluZyBpT1MKCQkJdGhpcy4kdG8uY3NzKCAiei1pbmRleCIsIC0xMCApOwoJCQljYWxsYmFjay5jYWxsKCB0aGlzICk7CgkJCXRoaXMuJHRvLmNzcyggInotaW5kZXgiLCAiIiApOwoJCX0sCgoJCXNjcm9sbFBhZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBCeSB1c2luZyBzY3JvbGxUbyBpbnN0ZWFkIG9mIHNpbGVudFNjcm9sbCwgd2UgY2FuIGtlZXAgdGhpbmdzIGJldHRlciBpbiBvcmRlcgoJCQkvLyBKdXN0IHRvIGJlIHByZWNhdXRpb3MsIGRpc2FibGUgc2Nyb2xsc3RhcnQgbGlzdGVuaW5nIGxpa2Ugc2lsZW50U2Nyb2xsIHdvdWxkCgkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgkJCS8vaWYgd2UgYXJlIGhpZGluZyB0aGUgdXJsIGJhciBvciB0aGUgcGFnZSB3YXMgcHJldmlvdXNseSBzY3JvbGxlZCBzY3JvbGwgdG8gaGlkZSBvciByZXR1cm4gdG8gcG9zaXRpb24KCQkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyIHx8IHRoaXMudG9TY3JvbGwgIT09ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsICkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB0aGlzLnRvU2Nyb2xsICk7CgkJCX0KCgkJCS8vIHJlZW5hYmxlIHNjcm9sbHN0YXJ0IGxpc3RlbmluZyBsaWtlIHNpbGVudFNjcm9sbCB3b3VsZAoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJfSwgMTUwICk7CgkJfSwKCgkJc3RhcnRJbjogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKSB7CgkJCXRoaXMuaGlkZUluKGZ1bmN0aW9uKCkgewoJCQkJdGhpcy4kdG8uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArIHRoaXMudG9QcmVDbGFzcyApOwoKCQkJCS8vIFNlbmQgZm9jdXMgdG8gcGFnZSBhcyBpdCBpcyBub3cgZGlzcGxheTogYmxvY2sKCQkJCWlmKCAhcHJldmVudEZvY3VzICl7CgkJCQkJJC5tb2JpbGUuZm9jdXNQYWdlKCB0aGlzLiR0byApOwoJCQkJfQoKCQkJCS8vIFNldCB0byBwYWdlIGhlaWdodAoJCQkJdGhpcy4kdG8uaGVpZ2h0KCBzY3JlZW5IZWlnaHQgKyB0aGlzLnRvU2Nyb2xsICk7CgogICAgICAgICAgICAgICAgaWYgKCAhbm9uZSApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbFBhZ2UoKTsKICAgICAgICAgICAgICAgIH0KCQkJfSk7CgoJCQlpZiAoICFub25lICkgewoJCQkJdGhpcy4kdG8uYW5pbWF0aW9uQ29tcGxldGUoICQucHJveHkoZnVuY3Rpb24oKSB7CgkJCQkJdGhpcy5kb25lSW4oKTsKCQkJCX0sIHRoaXMgKSk7CgkJCX0KCgkJCXRoaXMuJHRvCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMudG9QcmVDbGFzcyApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgaW4gIiArIHJldmVyc2VDbGFzcyApOwoKCQkJaWYgKCBub25lICkgewoJCQkJdGhpcy5kb25lSW4oKTsKCQkJfQoKCQl9LAoKCQlzdGFydE91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICkgewoJCQl0aGlzLmJlZm9yZVN0YXJ0T3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApOwoKCQkJLy8gU2V0IHRoZSBmcm9tIHBhZ2UncyBoZWlnaHQgYW5kIHN0YXJ0IGl0IHRyYW5zaXRpb25pbmcgb3V0CgkJCS8vIE5vdGU6IHNldHRpbmcgYW4gZXhwbGljaXQgaGVpZ2h0IGhlbHBzIGVsaW1pbmF0ZSB0aWxpbmcgaW4gdGhlIHRyYW5zaXRpb25zCgkJCXRoaXMuJGZyb20KCQkJCS5oZWlnaHQoIHNjcmVlbkhlaWdodCArICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgb3V0IiArIHJldmVyc2VDbGFzcyApOwoJCX0sCgoKCQl0b2dnbGVWaWV3cG9ydENsYXNzOiBmdW5jdGlvbigpIHsKCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci50b2dnbGVDbGFzcyggInVpLW1vYmlsZS12aWV3cG9ydC10cmFuc2l0aW9uaW5nIHZpZXdwb3J0LSIgKyB0aGlzLm5hbWUgKTsKCQl9LAoKCQl0cmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKCQkJLy8gTk9URSBtYW55IG9mIHRoZXNlIGNvdWxkIGJlIGNhbGN1bGF0ZWQvcmVjb3JkZWQgaW4gdGhlIGNvbnN0cnVjdG9yLCBpdCdzIG15CgkJCS8vICAgICAgb3BpbmlvbiB0aGF0IGJpbmRpbmcgdGhlbSBhcyBsYXRlIGFzIHBvc3NpYmxlIGhhcyB2YWx1ZSB3aXRoIHJlZ2FyZHMgdG8KCQkJLy8gICAgICBiZXR0ZXIgdHJhbnNpdGlvbnMgd2l0aCBmZXdlciBidWdzLiBJZSwgaXQncyBub3QgZ3VhcmFudGVlZCB0aGF0IHRoZQoJCQkvLyAgICAgIG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQgYW5kIHRyYW5zaXRpb24gd2lsbCBiZSBydW4gaW1tZWRpYXRlbHkgYWZ0ZXIgYXMKCQkJLy8gICAgICBpdCBpcyB0b2RheS4gU28gd2Ugd2FpdCB1bnRpbCB0cmFuc2l0aW9uIGlzIGludm9rZWQgdG8gZ2F0aGVyIHRoZSBmb2xsb3dpbmcKCQkJdmFyIHJldmVyc2VDbGFzcyA9IHRoaXMucmV2ZXJzZSA/ICIgcmV2ZXJzZSIgOiAiIiwKCQkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpLAoJCQkJbWF4VHJhbnNpdGlvbk92ZXJyaWRlID0gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoICE9PSBmYWxzZSAmJiAkLm1vYmlsZS53aW5kb3cud2lkdGgoKSA+ICQubW9iaWxlLm1heFRyYW5zaXRpb25XaWR0aCwKCQkJCW5vbmUgPSAhJC5zdXBwb3J0LmNzc1RyYW5zaXRpb25zIHx8IG1heFRyYW5zaXRpb25PdmVycmlkZSB8fCAhdGhpcy5uYW1lIHx8IHRoaXMubmFtZSA9PT0gIm5vbmUiIHx8IE1hdGgubWF4KCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCksIHRoaXMudG9TY3JvbGwgKSA+ICQubW9iaWxlLmdldE1heFNjcm9sbEZvclRyYW5zaXRpb24oKTsKCgkJCXRoaXMudG9TY3JvbGwgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpLmxhc3RTY3JvbGwgfHwgJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJCXRoaXMudG9nZ2xlVmlld3BvcnRDbGFzcygpOwoKCQkJaWYgKCB0aGlzLiRmcm9tICYmICFub25lICkgewoJCQkJdGhpcy5zdGFydE91dCggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZG9uZU91dCggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUsIHRydWUgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZGVmZXJyZWQucHJvbWlzZSgpOwoJCX0KCX0pOwp9KSggalF1ZXJ5LCB0aGlzICk7CgoKKGZ1bmN0aW9uKCAkICkgewoKCSQubW9iaWxlLlNlcmlhbFRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQl0aGlzLmluaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuU2VyaWFsVHJhbnNpdGlvbi5wcm90b3R5cGUsICQubW9iaWxlLlRyYW5zaXRpb24ucHJvdG90eXBlLCB7CgkJc2VxdWVudGlhbDogdHJ1ZSwKCgkJYmVmb3JlRG9uZU91dDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy4kZnJvbSApIHsKCQkJCXRoaXMuY2xlYW5Gcm9tKCk7CgkJCX0KCQl9LAoKCQliZWZvcmVTdGFydE91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICkgewoJCQl0aGlzLiRmcm9tLmFuaW1hdGlvbkNvbXBsZXRlKCQucHJveHkoZnVuY3Rpb24oKSB7CgkJCQl0aGlzLmRvbmVPdXQoIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICk7CgkJCX0sIHRoaXMgKSk7CgkJfQoJfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkICkgewoKCSQubW9iaWxlLkNvbmN1cnJlbnRUcmFuc2l0aW9uID0gZnVuY3Rpb24oKSB7CgkJdGhpcy5pbml0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cgl9OwoKCSQuZXh0ZW5kKCQubW9iaWxlLkNvbmN1cnJlbnRUcmFuc2l0aW9uLnByb3RvdHlwZSwgJC5tb2JpbGUuVHJhbnNpdGlvbi5wcm90b3R5cGUsIHsKCQlzZXF1ZW50aWFsOiBmYWxzZSwKCgkJYmVmb3JlRG9uZUluOiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLiRmcm9tICkgewoJCQkJdGhpcy5jbGVhbkZyb20oKTsKCQkJfQoJCX0sCgoJCWJlZm9yZVN0YXJ0T3V0OiBmdW5jdGlvbiggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKSB7CgkJCXRoaXMuZG9uZU91dCggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKTsKCQl9Cgl9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQgKSB7CgoJLy8gZ2VuZXJhdGUgdGhlIGhhbmRsZXJzIGZyb20gdGhlIGFib3ZlCgl2YXIgZGVmYXVsdEdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCkgKiAzOwoJfTsKCgkvL3RyYW5zaXRpb24gaGFuZGxlciBkaWN0aW9uYXJ5IGZvciAzcmQgcGFydHkgdHJhbnNpdGlvbnMKCSQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycyA9IHsKCQkic2VxdWVudGlhbCI6ICQubW9iaWxlLlNlcmlhbFRyYW5zaXRpb24sCgkJInNpbXVsdGFuZW91cyI6ICQubW9iaWxlLkNvbmN1cnJlbnRUcmFuc2l0aW9uCgl9OwoKCS8vIE1ha2Ugb3VyIHRyYW5zaXRpb24gaGFuZGxlciB0aGUgcHVibGljIGRlZmF1bHQuCgkkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIgPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2VxdWVudGlhbDsKCgkkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzID0ge307CgoJLy8gSWYgdHJhbnNpdGlvbiBpcyBkZWZpbmVkLCBjaGVjayBpZiBjc3MgM0QgdHJhbnNmb3JtcyBhcmUgc3VwcG9ydGVkLCBhbmQgaWYgbm90LCBpZiBhIGZhbGxiYWNrIGlzIHNwZWNpZmllZAoJJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gPSBmdW5jdGlvbiggdHJhbnNpdGlvbiApIHsKCQlpZiAoIHRyYW5zaXRpb24gJiYgISQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF0gKSB7CgkJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF07CgkJfQoKCQlyZXR1cm4gdHJhbnNpdGlvbjsKCX07CgoJLy8gU2V0IHRoZSBnZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uIHRvIGRlZmF1bHQgaWYgbm8gaW1wbGVtZW50YXRpb24gd2FzIHNldCBieSB1c2VyCgkkLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uID0gJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB8fCBkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbjsKCn0pKCBqUXVlcnkgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgZmxpcCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MuZmxpcCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbG93IGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbG93ID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHBvcCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MucG9wID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gVXNlIHRoZSBzaW11bHRhbmVvdXMgdHJhbnNpdGlvbnMgaGFuZGxlciBmb3Igc2xpZGUgdHJhbnNpdGlvbnMKJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzLnNsaWRlID0gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzLnNpbXVsdGFuZW91czsKCi8vIFNldCB0aGUgc2xpZGUgdHJhbnNpdGlvbnMncyBmYWxsYmFjayB0byAiZmFkZSIKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZSA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZWRvd24gaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlZG93biA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZWZhZGUgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgovLyBTZXQgdGhlIHNsaWRlIHRyYW5zaXRpb25zJ3MgZmFsbGJhY2sgdG8gImZhZGUiCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGVmYWRlID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRldXAgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRldXAgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgdHVybiBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MudHVybiA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUuZGVncmFkZUlucHV0cyA9IHsKCWNvbG9yOiBmYWxzZSwKCWRhdGU6IGZhbHNlLAoJZGF0ZXRpbWU6IGZhbHNlLAoJImRhdGV0aW1lLWxvY2FsIjogZmFsc2UsCgllbWFpbDogZmFsc2UsCgltb250aDogZmFsc2UsCgludW1iZXI6IGZhbHNlLAoJcmFuZ2U6ICJudW1iZXIiLAoJc2VhcmNoOiAidGV4dCIsCgl0ZWw6IGZhbHNlLAoJdGltZTogZmFsc2UsCgl1cmw6IGZhbHNlLAoJd2VlazogZmFsc2UKfTsKLy8gQmFja2NvbXBhdCByZW1vdmUgaW4gMS41CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuZGVncmFkZUlucHV0cyA9ICQubW9iaWxlLmRlZ3JhZGVJbnB1dHM7CgovLyBBdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRlZ3JhZGVJbnB1dHNXaXRoaW4gPSBmdW5jdGlvbiggdGFyZ2V0ICkgewoKCXRhcmdldCA9ICQoIHRhcmdldCApOwoKCS8vIERlZ3JhZGUgaW5wdXRzIHRvIGF2b2lkIHBvb3JseSBpbXBsZW1lbnRlZCBuYXRpdmUgZnVuY3Rpb25hbGl0eQoJdGFyZ2V0LmZpbmQoICJpbnB1dCIgKS5ub3QoICQubW9iaWxlLnBhZ2UucHJvdG90eXBlLmtlZXBOYXRpdmVTZWxlY3RvcigpICkuZWFjaChmdW5jdGlvbigpIHsKCQl2YXIgZWxlbWVudCA9ICQoIHRoaXMgKSwKCQkJdHlwZSA9IHRoaXMuZ2V0QXR0cmlidXRlKCAidHlwZSIgKSwKCQkJb3B0VHlwZSA9ICQubW9iaWxlLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSB8fCAidGV4dCIsCgkJCWh0bWwsIGhhc1R5cGUsIGZpbmRzdHIsIHJlcHN0cjsKCgkJaWYgKCAkLm1vYmlsZS5kZWdyYWRlSW5wdXRzWyB0eXBlIF0gKSB7CgkJCWh0bWwgPSAkKCAiPGRpdj4iICkuaHRtbCggZWxlbWVudC5jbG9uZSgpICkuaHRtbCgpOwoJCQkvLyBJbiBJRSBicm93c2VycywgdGhlIHR5cGUgc29tZXRpbWVzIGRvZXNuJ3QgZXhpc3QgaW4gdGhlIGNsb25lZCBtYXJrdXAsIHNvIHdlIHJlcGxhY2UgdGhlIGNsb3NpbmcgdGFnIGluc3RlYWQKCQkJaGFzVHlwZSA9IGh0bWwuaW5kZXhPZiggIiB0eXBlPSIgKSA+IC0xOwoJCQlmaW5kc3RyID0gaGFzVHlwZSA/IC9ccyt0eXBlPVsiJ10/XHcrWyciXT8vIDogL1wvPz4vOwoJCQlyZXBzdHIgPSAiIHR5cGU9XCIiICsgb3B0VHlwZSArICJcIiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0eXBlPVwiIiArIHR5cGUgKyAiXCIiICsgKCBoYXNUeXBlID8gIiIgOiAiPiIgKTsKCgkJCWVsZW1lbnQucmVwbGFjZVdpdGgoIGh0bWwucmVwbGFjZSggZmluZHN0ciwgcmVwc3RyICkgKTsKCQl9Cgl9KTsKCn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUucGFnZSIsICQubW9iaWxlLnBhZ2UsIHsKCW9wdGlvbnM6IHsKCgkJLy8gQWNjZXB0cyBsZWZ0LCByaWdodCBhbmQgbm9uZQoJCWNsb3NlQnRuOiAibGVmdCIsCgkJY2xvc2VCdG5UZXh0OiAiQ2xvc2UiLAoJCW92ZXJsYXlUaGVtZTogImEiLAoJCWNvcm5lcnM6IHRydWUsCgkJZGlhbG9nOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoJCWlmKCB0aGlzLm9wdGlvbnMuZGlhbG9nICl7CgoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJX2lzQ2xvc2VhYmxlOiBmYWxzZSwKCQkJCV9pbm5lcjogdGhpcy5lbGVtZW50LmNoaWxkcmVuKCksCgkJCQlfaGVhZGVyQ2xvc2VCdXR0b246IG51bGwKCQkJfSk7CgoJCQlpZiggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJCXRoaXMuX3NldENsb3NlQnRuKCB0aGlzLm9wdGlvbnMuY2xvc2VCdG4gKTsKCQkJfQoJCX0KCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCS8vIENsYXNzIHRoZSBtYXJrdXAgZm9yIGRpYWxvZyBzdHlsaW5nIGFuZCB3cmFwIGludGVyaW9yCgkJaWYoIHRoaXMub3B0aW9ucy5kaWFsb2cgKXsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktZGlhbG9nIiApCgkJCQkud3JhcElubmVyKCAkKCAiPGRpdi8+IiwgewoKCQkJCQkvLyBBUklBIHJvbGUKCQkJCQkicm9sZSIgOiAiZGlhbG9nIiwKCQkJCQkiY2xhc3MiIDogInVpLWRpYWxvZy1jb250YWluIHVpLW92ZXJsYXktc2hhZG93IiArCgkJCQkJCSggdGhpcy5vcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIgKQoJCQkJfSkpOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBjbG9zZUJ1dHRvbkxvY2F0aW9uLCBjbG9zZUJ1dHRvblRleHQsCgkJCWN1cnJlbnRPcHRzID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9pbm5lci50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCAhIW9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLm92ZXJsYXlUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoICQubW9iaWxlLmFjdGl2ZVBhZ2VbIDAgXSA9PT0gdGhpcy5lbGVtZW50WyAwIF0gKSB7CgkJCQljdXJyZW50T3B0cy5vdmVybGF5VGhlbWUgPSBvcHRpb25zLm92ZXJsYXlUaGVtZTsKCQkJCXRoaXMuX2hhbmRsZVBhZ2VCZWZvcmVTaG93KCk7CgkJCX0KCQl9CgoJCWlmICggb3B0aW9ucy5jbG9zZUJ0blRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJY2xvc2VCdXR0b25Mb2NhdGlvbiA9IGN1cnJlbnRPcHRzLmNsb3NlQnRuOwoJCQljbG9zZUJ1dHRvblRleHQgPSBvcHRpb25zLmNsb3NlQnRuVGV4dDsKCQl9CgoJCWlmICggb3B0aW9ucy5jbG9zZUJ0biAhPT0gdW5kZWZpbmVkICkgewoJCQljbG9zZUJ1dHRvbkxvY2F0aW9uID0gb3B0aW9ucy5jbG9zZUJ0bjsKCQl9CgoJCWlmICggY2xvc2VCdXR0b25Mb2NhdGlvbiApIHsKCQkJdGhpcy5fc2V0Q2xvc2VCdG4oIGNsb3NlQnV0dG9uTG9jYXRpb24sIGNsb3NlQnV0dG9uVGV4dCApOwoJCX0KCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0sCgoJX2hhbmRsZVBhZ2VCZWZvcmVTaG93OiBmdW5jdGlvbiAoKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICkgewoJCQl0aGlzLnJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQoKTsKCQkJdGhpcy5zZXRDb250YWluZXJCYWNrZ3JvdW5kKCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5fc3VwZXIoKTsKCQl9Cgl9LAoKCV9zZXRDbG9zZUJ0bjogZnVuY3Rpb24oIGxvY2F0aW9uLCB0ZXh0ICkgewoJCXZhciBkc3QsCgkJCWJ0biA9IHRoaXMuX2hlYWRlckNsb3NlQnV0dG9uOwoKCQkvLyBTYW5pdGl6ZSB2YWx1ZQoJCWxvY2F0aW9uID0gImxlZnQiID09PSBsb2NhdGlvbiA/ICJsZWZ0IiA6ICJyaWdodCIgPT09IGxvY2F0aW9uID8gInJpZ2h0IiA6ICJub25lIjsKCgkJaWYgKCAibm9uZSIgPT09IGxvY2F0aW9uICkgewoJCQlpZiAoIGJ0biApIHsKCQkJCWJ0bi5yZW1vdmUoKTsKCQkJCWJ0biA9IG51bGw7CgkJCX0KCQl9IGVsc2UgaWYgKCBidG4gKSB7CgkJCWJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi1sZWZ0IHVpLWJ0bi1yaWdodCIgKS5hZGRDbGFzcyggInVpLWJ0bi0iICsgbG9jYXRpb24gKTsKCQkJaWYgKCB0ZXh0ICkgewoJCQkJYnRuLnRleHQoIHRleHQgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCWRzdCA9IHRoaXMuX2lubmVyLmZpbmQoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKS5maXJzdCgpOwoJCQlidG4gPSAkKCAiPGE+PC9hPiIsIHsKCQkJCQkicm9sZSI6ICJidXR0b24iLAoJCQkJCSJocmVmIjogIiMiLAoJCQkJCSJjbGFzcyI6ICJ1aS1idG4gdWktY29ybmVyLWFsbCB1aS1pY29uLWRlbGV0ZSB1aS1idG4taWNvbi1ub3RleHQgdWktYnRuLSIgKyBsb2NhdGlvbgoJCQkJfSkKCQkJCS50ZXh0KCB0ZXh0IHx8IHRoaXMub3B0aW9ucy5jbG9zZUJ0blRleHQgfHwgIiIgKQoJCQkJLnByZXBlbmRUbyggZHN0ICk7CgkJCXRoaXMuX29uKCBidG4sIHsgY2xpY2s6ICJjbG9zZSIgfSApOwoJCX0KCgkJdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24gPSBidG47Cgl9LAoKCS8vIENsb3NlIG1ldGhvZCBnb2VzIGJhY2sgaW4gaGlzdG9yeQoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCXZhciBpZHgsIGRzdCwgaGlzdCA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnk7CgoJCQlpZiAoICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICYmIGhpc3QuYWN0aXZlSW5kZXggPiAwICkgewoJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQl9IGVsc2UgewoJCQkJaWR4ID0gTWF0aC5tYXgoIDAsIGhpc3QuYWN0aXZlSW5kZXggLSAxICk7CgkJCQlkc3QgPSBoaXN0LnN0YWNrWyBpZHggXS5wYWdlVXJsIHx8IGhpc3Quc3RhY2tbIGlkeCBdLnVybDsKCQkJCWhpc3QucHJldmlvdXNJbmRleCA9IGhpc3QuYWN0aXZlSW5kZXg7CgkJCQloaXN0LmFjdGl2ZUluZGV4ID0gaWR4OwoJCQkJaWYgKCAhJC5tb2JpbGUucGF0aC5pc1BhdGgoIGRzdCApICkgewoJCQkJCWRzdCA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCAiIyIgKyBkc3QgKTsKCQkJCX0KCgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBkc3QsIHsgZGlyZWN0aW9uOiAiYmFjayIsIGNoYW5nZUhhc2g6IGZhbHNlLCBmcm9tSGFzaENoYW5nZTogdHJ1ZSB9ICk7CgkJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuZGlhbG9nIiwgewoJb3B0aW9uczogewoKCQkvLyBBY2NlcHRzIGxlZnQsIHJpZ2h0IGFuZCBub25lCgkJY2xvc2VCdG46ICJsZWZ0IiwKCQljbG9zZUJ0blRleHQ6ICJDbG9zZSIsCgkJb3ZlcmxheVRoZW1lOiAiYSIsCgkJY29ybmVyczogdHJ1ZQoJfSwKCgkvLyBPdmVycmlkZSB0aGUgdGhlbWUgc2V0IGJ5IHRoZSBwYWdlIHBsdWdpbiBvbiBwYWdlc2hvdwoJX2hhbmRsZVBhZ2VCZWZvcmVTaG93OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9pc0Nsb3NlYWJsZSA9IHRydWU7CgkJaWYgKCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICkgewoJCQl0aGlzLmVsZW1lbnQKCQkJCS5wYWdlKCAicmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCIgKQoJCQkJLnBhZ2UoICJzZXRDb250YWluZXJCYWNrZ3JvdW5kIiwgdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoJCX0KCX0sCgoJX2hhbmRsZVBhZ2VCZWZvcmVIaWRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9pc0Nsb3NlYWJsZSA9IGZhbHNlOwoJfSwKCgkvLyBjbGljayBhbmQgc3VibWl0IGV2ZW50czoKCS8vIC0gY2xpY2tzIGFuZCBzdWJtaXRzIHNob3VsZCB1c2UgdGhlIGNsb3NpbmcgdHJhbnNpdGlvbiB0aGF0IHRoZSBkaWFsb2cKCS8vICAgb3BlbmVkIHdpdGggdW5sZXNzIGEgZGF0YS10cmFuc2l0aW9uIGlzIHNwZWNpZmllZCBvbiB0aGUgbGluay9mb3JtCgkvLyAtIGlmIHRoZSBjbGljayB3YXMgb24gdGhlIGNsb3NlIGJ1dHRvbiwgb3IgdGhlIGxpbmsgaGFzIGEgZGF0YS1yZWw9ImJhY2siCgkvLyAgIGl0J2xsIGdvIGJhY2sgaW4gaGlzdG9yeSBuYXR1cmFsbHkKCV9oYW5kbGVWQ2xpY2tTdWJtaXQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgYXR0cnMsCgkJCSR0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCBldmVudC50eXBlID09PSAidmNsaWNrIiA/ICJhIiA6ICJmb3JtIiApOwoKCQlpZiAoICR0YXJnZXQubGVuZ3RoICYmICEkdGFyZ2V0LmpxbURhdGEoICJ0cmFuc2l0aW9uIiApICkgewoJCQlhdHRycyA9IHt9OwoJCQlhdHRyc1sgImRhdGEtIiArICQubW9iaWxlLm5zICsgInRyYW5zaXRpb24iIF0gPQoJCQkJKCAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpIHx8IHt9IClbICJ0cmFuc2l0aW9uIiBdIHx8CgkJCQkkLm1vYmlsZS5kZWZhdWx0RGlhbG9nVHJhbnNpdGlvbjsKCQkJYXR0cnNbICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJkaXJlY3Rpb24iIF0gPSAicmV2ZXJzZSI7CgkJCSR0YXJnZXQuYXR0ciggYXR0cnMgKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQlvcHRzID0gdGhpcy5vcHRpb25zOwoKCQkvLyBDbGFzcyB0aGUgbWFya3VwIGZvciBkaWFsb2cgc3R5bGluZyBhbmQgd3JhcCBpbnRlcmlvcgoJCWVsZW0uYWRkQ2xhc3MoICJ1aS1kaWFsb2ciICkKCQkJLndyYXBJbm5lciggJCggIjxkaXYvPiIsIHsKCgkJCQkvLyBBUklBIHJvbGUKCQkJCSJyb2xlIiA6ICJkaWFsb2ciLAoJCQkJImNsYXNzIiA6ICJ1aS1kaWFsb2ctY29udGFpbiB1aS1vdmVybGF5LXNoYWRvdyIgKwoJCQkJCSggISFvcHRzLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIgKQoJCQl9KSk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9pc0Nsb3NlYWJsZTogZmFsc2UsCgkJCV9pbm5lcjogZWxlbS5jaGlsZHJlbigpLAoJCQlfaGVhZGVyQ2xvc2VCdXR0b246IG51bGwKCQl9KTsKCgkJdGhpcy5fb24oIGVsZW0sIHsKCQkJdmNsaWNrOiAiX2hhbmRsZVZDbGlja1N1Ym1pdCIsCgkJCXN1Ym1pdDogIl9oYW5kbGVWQ2xpY2tTdWJtaXQiLAoJCQlwYWdlYmVmb3Jlc2hvdzogIl9oYW5kbGVQYWdlQmVmb3JlU2hvdyIsCgkJCXBhZ2ViZWZvcmVoaWRlOiAiX2hhbmRsZVBhZ2VCZWZvcmVIaWRlIgoJCX0pOwoKCQl0aGlzLl9zZXRDbG9zZUJ0biggb3B0cy5jbG9zZUJ0biApOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGNsb3NlQnV0dG9uTG9jYXRpb24sIGNsb3NlQnV0dG9uVGV4dCwKCQkJY3VycmVudE9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX2lubmVyLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsICEhb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMub3ZlcmxheVRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggJC5tb2JpbGUuYWN0aXZlUGFnZVsgMCBdID09PSB0aGlzLmVsZW1lbnRbIDAgXSApIHsKCQkJCWN1cnJlbnRPcHRzLm92ZXJsYXlUaGVtZSA9IG9wdGlvbnMub3ZlcmxheVRoZW1lOwoJCQkJdGhpcy5faGFuZGxlUGFnZUJlZm9yZVNob3coKTsKCQkJfQoJCX0KCgkJaWYgKCBvcHRpb25zLmNsb3NlQnRuVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQljbG9zZUJ1dHRvbkxvY2F0aW9uID0gY3VycmVudE9wdHMuY2xvc2VCdG47CgkJCWNsb3NlQnV0dG9uVGV4dCA9IG9wdGlvbnMuY2xvc2VCdG5UZXh0OwoJCX0KCgkJaWYgKCBvcHRpb25zLmNsb3NlQnRuICE9PSB1bmRlZmluZWQgKSB7CgkJCWNsb3NlQnV0dG9uTG9jYXRpb24gPSBvcHRpb25zLmNsb3NlQnRuOwoJCX0KCgkJaWYgKCBjbG9zZUJ1dHRvbkxvY2F0aW9uICkgewoJCQl0aGlzLl9zZXRDbG9zZUJ0biggY2xvc2VCdXR0b25Mb2NhdGlvbiwgY2xvc2VCdXR0b25UZXh0ICk7CgkJfQoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfc2V0Q2xvc2VCdG46IGZ1bmN0aW9uKCBsb2NhdGlvbiwgdGV4dCApIHsKCQl2YXIgZHN0LAoJCQlidG4gPSB0aGlzLl9oZWFkZXJDbG9zZUJ1dHRvbjsKCgkJLy8gU2FuaXRpemUgdmFsdWUKCQlsb2NhdGlvbiA9ICJsZWZ0IiA9PT0gbG9jYXRpb24gPyAibGVmdCIgOiAicmlnaHQiID09PSBsb2NhdGlvbiA/ICJyaWdodCIgOiAibm9uZSI7CgoJCWlmICggIm5vbmUiID09PSBsb2NhdGlvbiApIHsKCQkJaWYgKCBidG4gKSB7CgkJCQlidG4ucmVtb3ZlKCk7CgkJCQlidG4gPSBudWxsOwoJCQl9CgkJfSBlbHNlIGlmICggYnRuICkgewoJCQlidG4ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tbGVmdCB1aS1idG4tcmlnaHQiICkuYWRkQ2xhc3MoICJ1aS1idG4tIiArIGxvY2F0aW9uICk7CgkJCWlmICggdGV4dCApIHsKCQkJCWJ0bi50ZXh0KCB0ZXh0ICk7CgkJCX0KCQl9IGVsc2UgewoJCQlkc3QgPSB0aGlzLl9pbm5lci5maW5kKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkuZmlyc3QoKTsKCQkJYnRuID0gJCggIjxhPjwvYT4iLCB7CgkJCQkJInJvbGUiOiAiYnV0dG9uIiwKCQkJCQkiaHJlZiI6ICIjIiwKCQkJCQkiY2xhc3MiOiAidWktYnRuIHVpLWNvcm5lci1hbGwgdWktaWNvbi1kZWxldGUgdWktYnRuLWljb24tbm90ZXh0IHVpLWJ0bi0iICsgbG9jYXRpb24KCQkJCX0pCgkJCQkudGV4dCggdGV4dCB8fCB0aGlzLm9wdGlvbnMuY2xvc2VCdG5UZXh0IHx8ICIiICkKCQkJCS5wcmVwZW5kVG8oIGRzdCApOwoJCQl0aGlzLl9vbiggYnRuLCB7IGNsaWNrOiAiY2xvc2UiIH0gKTsKCQl9CgoJCXRoaXMuX2hlYWRlckNsb3NlQnV0dG9uID0gYnRuOwoJfSwKCgkvLyBDbG9zZSBtZXRob2QgZ29lcyBiYWNrIGluIGhpc3RvcnkKCWNsb3NlOiBmdW5jdGlvbigpIHsKCQl2YXIgaWR4LCBkc3QsIGhpc3QgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5OwoKCQlpZiAoIHRoaXMuX2lzQ2xvc2VhYmxlICkgewoJCQl0aGlzLl9pc0Nsb3NlYWJsZSA9IGZhbHNlOwoJCQkvLyBJZiB0aGUgaGFzaCBsaXN0ZW5pbmcgaXMgZW5hYmxlZCBhbmQgdGhlcmUgaXMgYXQgbGVhc3Qgb25lIHByZWNlZGluZyBoaXN0b3J5CgkJCS8vIGVudHJ5IGl0J3Mgb2sgdG8gZ28gYmFjay4gSW5pdGlhbCBwYWdlcyB3aXRoIHRoZSBkaWFsb2cgaGFzaCBzdGF0ZSBhcmUgYW4gZXhhbXBsZQoJCQkvLyB3aGVyZSB0aGUgc3RhY2sgY2hlY2sgaXMgbmVjZXNzYXJ5CgkJCWlmICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgJiYgaGlzdC5hY3RpdmVJbmRleCA+IDAgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCX0gZWxzZSB7CgkJCQlpZHggPSBNYXRoLm1heCggMCwgaGlzdC5hY3RpdmVJbmRleCAtIDEgKTsKCQkJCWRzdCA9IGhpc3Quc3RhY2tbIGlkeCBdLnBhZ2VVcmwgfHwgaGlzdC5zdGFja1sgaWR4IF0udXJsOwoJCQkJaGlzdC5wcmV2aW91c0luZGV4ID0gaGlzdC5hY3RpdmVJbmRleDsKCQkJCWhpc3QuYWN0aXZlSW5kZXggPSBpZHg7CgkJCQlpZiAoICEkLm1vYmlsZS5wYXRoLmlzUGF0aCggZHN0ICkgKSB7CgkJCQkJZHN0ID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGRzdCApOwoJCQkJfQoKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGRzdCwgeyBkaXJlY3Rpb246ICJiYWNrIiwgY2hhbmdlSGFzaDogZmFsc2UsIGZyb21IYXNoQ2hhbmdlOiB0cnVlIH0gKTsKCQkJfQoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHJJbml0aWFsTGV0dGVyID0gLyhbQS1aXSkvZzsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbGxhcHNpYmxlIiwgewoJb3B0aW9uczogewoJCWVuaGFuY2VkOiBmYWxzZSwKCQlleHBhbmRDdWVUZXh0OiBudWxsLAoJCWNvbGxhcHNlQ3VlVGV4dDogbnVsbCwKCQljb2xsYXBzZWQ6IHRydWUsCgkJaGVhZGluZzogImgxLGgyLGgzLGg0LGg1LGg2LGxlZ2VuZCIsCgkJY29sbGFwc2VkSWNvbjogbnVsbCwKCQlleHBhbmRlZEljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQl0aGVtZTogbnVsbCwKCQljb250ZW50VGhlbWU6IG51bGwsCgkJaW5zZXQ6IG51bGwsCgkJY29ybmVyczogbnVsbCwKCQltaW5pOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQl1aSA9IHsKCQkJCWFjY29yZGlvbjogZWxlbQoJCQkJCS5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiICsKCQkJCQkJKCAkLm1vYmlsZS5jb2xsYXBzaWJsZXNldCA/ICIsIDptb2JpbGUtY29sbGFwc2libGVzZXQiIDogIiIgKSApCgkJCQkJLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0IiApCgkJCX07CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV91aTogdWkKCQl9KTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXVpLmhlYWRpbmcgPSAkKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmciLCB0aGlzLmVsZW1lbnRbIDAgXSApOwoJCQl1aS5jb250ZW50ID0gdWkuaGVhZGluZy5uZXh0KCk7CgkJCXVpLmFuY2hvciA9ICQoICJhIiwgdWkuaGVhZGluZ1sgMCBdICkuZmlyc3QoKTsKCQkJdWkuc3RhdHVzID0gdWkuYW5jaG9yLmNoaWxkcmVuKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzIiApOwoJCX0gZWxzZSB7CgkJCXRoaXMuX2VuaGFuY2UoIGVsZW0sIHVpICk7CgkJfQoKCQl0aGlzLl9vbiggdWkuaGVhZGluZywgewoJCQkidGFwIjogZnVuY3Rpb24oKSB7CgkJCQl1aS5oZWFkaW5nLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0sCgoJCQkiY2xpY2siOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggIXVpLmhlYWRpbmcuaGFzQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIgKSApOwoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJfSk7Cgl9LAoKCS8vIEFkanVzdCB0aGUga2V5cyBpbnNpZGUgb3B0aW9ucyBmb3IgaW5oZXJpdGVkIHZhbHVlcwoJX2dldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBrZXksCgkJCWFjY29yZGlvbiA9IHRoaXMuX3VpLmFjY29yZGlvbiwKCQkJYWNjb3JkaW9uV2lkZ2V0ID0gdGhpcy5fdWkuYWNjb3JkaW9uV2lkZ2V0OwoKCQkvLyBDb3B5IG9wdGlvbnMKCQlvcHRpb25zID0gJC5leHRlbmQoIHt9LCBvcHRpb25zICk7CgoJCWlmICggYWNjb3JkaW9uLmxlbmd0aCAmJiAhYWNjb3JkaW9uV2lkZ2V0ICkgewoJCQl0aGlzLl91aS5hY2NvcmRpb25XaWRnZXQgPQoJCQlhY2NvcmRpb25XaWRnZXQgPSBhY2NvcmRpb24uZGF0YSggIm1vYmlsZS1jb2xsYXBzaWJsZXNldCIgKTsKCQl9CgoJCWZvciAoIGtleSBpbiBvcHRpb25zICkgewoKCQkJLy8gUmV0cmlldmUgdGhlIG9wdGlvbiB2YWx1ZSBmaXJzdCBmcm9tIHRoZSBvcHRpb25zIG9iamVjdCBwYXNzZWQgaW4gYW5kLCBpZgoJCQkvLyBudWxsLCBmcm9tIHRoZSBwYXJlbnQgYWNjb3JkaW9uIG9yLCBpZiB0aGF0J3MgbnVsbCB0b28sIG9yIGlmIHRoZXJlJ3Mgbm8KCQkJLy8gcGFyZW50IGFjY29yZGlvbiwgdGhlbiBmcm9tIHRoZSBkZWZhdWx0cy4KCQkJb3B0aW9uc1sga2V5IF0gPQoJCQkJKCBvcHRpb25zWyBrZXkgXSAhPSBudWxsICkgPyBvcHRpb25zWyBrZXkgXSA6CgkJCQkoIGFjY29yZGlvbldpZGdldCApID8gYWNjb3JkaW9uV2lkZ2V0Lm9wdGlvbnNbIGtleSBdIDoKCQkJCWFjY29yZGlvbi5sZW5ndGggPyAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIGFjY29yZGlvblsgMCBdLAoJCQkJCWtleS5yZXBsYWNlKCBySW5pdGlhbExldHRlciwgIi0kMSIgKS50b0xvd2VyQ2FzZSgpICk6CgkJCQludWxsOwoKCQkJaWYgKCBudWxsID09IG9wdGlvbnNbIGtleSBdICkgewoJCQkJb3B0aW9uc1sga2V5IF0gPSAkLm1vYmlsZS5jb2xsYXBzaWJsZS5kZWZhdWx0c1sga2V5IF07CgkJCX0KCQl9CgoJCXJldHVybiBvcHRpb25zOwoJfSwKCglfdGhlbWVDbGFzc0Zyb21PcHRpb246IGZ1bmN0aW9uKCBwcmVmaXgsIHZhbHVlICkgewoJCXJldHVybiAoIHZhbHVlID8gKCB2YWx1ZSA9PT0gIm5vbmUiID8gIiIgOiBwcmVmaXggKyB2YWx1ZSApIDogIiIgKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCBlbGVtLCB1aSApIHsKCQl2YXIgaWNvbmNsYXNzLAoJCQlvcHRzID0gdGhpcy5fZ2V0T3B0aW9ucyggdGhpcy5vcHRpb25zICksCgkJCWNvbnRlbnRUaGVtZUNsYXNzID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMuY29udGVudFRoZW1lICk7CgoJCWVsZW0uYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSAiICsKCQkJKCBvcHRzLmluc2V0ID8gInVpLWNvbGxhcHNpYmxlLWluc2V0ICIgOiAiIiApICsKCQkJKCBvcHRzLmluc2V0ICYmIG9wdHMuY29ybmVycyA/ICJ1aS1jb3JuZXItYWxsICIgOiAiIiApICsKCQkJKCBjb250ZW50VGhlbWVDbGFzcyA/ICJ1aS1jb2xsYXBzaWJsZS10aGVtZWQtY29udGVudCAiIDogIiIgKSApOwoJCXVpLm9yaWdpbmFsSGVhZGluZyA9IGVsZW0uY2hpbGRyZW4oIHRoaXMub3B0aW9ucy5oZWFkaW5nICkuZmlyc3QoKSwKCQl1aS5jb250ZW50ID0gZWxlbQoJCQkud3JhcElubmVyKCAiPGRpdiAiICsKCQkJCSJjbGFzcz0ndWktY29sbGFwc2libGUtY29udGVudCAiICsKCQkJCWNvbnRlbnRUaGVtZUNsYXNzICsgIic+PC9kaXY+IiApCgkJCS5jaGlsZHJlbiggIi51aS1jb2xsYXBzaWJsZS1jb250ZW50IiApLAoJCXVpLmhlYWRpbmcgPSB1aS5vcmlnaW5hbEhlYWRpbmc7CgoJCS8vIFJlcGxhY2UgY29sbGFwc2libGVIZWFkaW5nIGlmIGl0J3MgYSBsZWdlbmQKCQlpZiAoIHVpLmhlYWRpbmcuaXMoICJsZWdlbmQiICkgKSB7CgkJCXVpLmhlYWRpbmcgPSAkKCAiPGRpdiByb2xlPSdoZWFkaW5nJz4iKyB1aS5oZWFkaW5nLmh0bWwoKSArIjwvZGl2PiIgKTsKCQkJdWkucGxhY2Vob2xkZXIgPSAkKCAiPGRpdj48IS0tIHBsYWNlaG9sZGVyIGZvciBsZWdlbmQgLS0+PC9kaXY+IiApLmluc2VydEJlZm9yZSggdWkub3JpZ2luYWxIZWFkaW5nICk7CgkJCXVpLm9yaWdpbmFsSGVhZGluZy5yZW1vdmUoKTsKCQl9CgoJCWljb25jbGFzcyA9ICggb3B0cy5jb2xsYXBzZWQgPyAoIG9wdHMuY29sbGFwc2VkSWNvbiA/ICJ1aS1pY29uLSIgKyBvcHRzLmNvbGxhcHNlZEljb24gOiAiIiApOgoJCQkoIG9wdHMuZXhwYW5kZWRJY29uID8gInVpLWljb24tIiArIG9wdHMuZXhwYW5kZWRJY29uIDogIiIgKSApOwoKCQl1aS5zdGF0dXMgPSAkKCAiPHNwYW4gY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzJz48L3NwYW4+IiApOwoJCXVpLmFuY2hvciA9IHVpLmhlYWRpbmcKCQkJLmRldGFjaCgpCgkJCS8vbW9kaWZ5IG1hcmt1cCAmIGF0dHJpYnV0ZXMKCQkJLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZyIgKQoJCQkuYXBwZW5kKCB1aS5zdGF0dXMgKQoJCQkud3JhcElubmVyKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctdG9nZ2xlJz48L2E+IiApCgkJCS5maW5kKCAiYSIgKQoJCQkJLmZpcnN0KCkKCQkJCS5hZGRDbGFzcyggInVpLWJ0biAiICsKCQkJCQkoIGljb25jbGFzcyA/IGljb25jbGFzcyArICIgIiA6ICIiICkgKwoJCQkJCSggaWNvbmNsYXNzID8gKCAidWktYnRuLWljb24tIiArCgkJCQkJCSggb3B0cy5pY29ucG9zID09PSAicmlnaHQiID8gInJpZ2h0IiA6ICJsZWZ0IiApICkgKwoJCQkJCQkiICIgOiAiIiApICsKCQkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJ0bi0iLCBvcHRzLnRoZW1lICkgKyAiICIgKwoJCQkJCSggb3B0cy5taW5pID8gInVpLW1pbmkgIiA6ICIiICkgKTsKCgkJLy9kcm9wIGhlYWRpbmcgaW4gYmVmb3JlIGNvbnRlbnQKCQl1aS5oZWFkaW5nLmluc2VydEJlZm9yZSggdWkuY29udGVudCApOwoKCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggdGhpcy5vcHRpb25zLmNvbGxhcHNlZCApOwoKCQlyZXR1cm4gdWk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBrZXksIG9wdGlvbnMgPSB7fTsKCgkJZm9yICgga2V5IGluICQubW9iaWxlLmNvbGxhcHNpYmxlLmRlZmF1bHRzICkgewoJCQlvcHRpb25zWyBrZXkgXSA9IHRoaXMub3B0aW9uc1sga2V5IF07CgkJfQoKCQl0aGlzLl9zZXRPcHRpb25zKCBvcHRpb25zICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNDb2xsYXBzZWQsIG5ld1RoZW1lLCBvbGRUaGVtZSwKCQkJZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJY3VycmVudE9wdHMgPSB0aGlzLm9wdGlvbnMsCgkJCXVpID0gdGhpcy5fdWksCgkJCWFuY2hvciA9IHVpLmFuY2hvciwKCQkJc3RhdHVzID0gdWkuc3RhdHVzLAoJCQlvcHRzID0gdGhpcy5fZ2V0T3B0aW9ucyggb3B0aW9ucyApOwoKCQkvLyBGaXJzdCBhbmQgZm9yZW1vc3Qgd2UgbmVlZCB0byBtYWtlIHN1cmUgdGhlIGNvbGxhcHNpYmxlIGlzIGluIHRoZSBwcm9wZXIKCQkvLyBzdGF0ZSwgaW4gY2FzZSBzb21lYm9keSBkZWNpZGVkIHRvIGNoYW5nZSB0aGUgY29sbGFwc2VkIG9wdGlvbiBhdCB0aGUKCQkvLyBzYW1lIHRpbWUgYXMgYW5vdGhlciBvcHRpb24KCQlpZiAoIG9wdGlvbnMuY29sbGFwc2VkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX2hhbmRsZUV4cGFuZENvbGxhcHNlKCBvcHRpb25zLmNvbGxhcHNlZCApOwoJCX0KCgkJaXNDb2xsYXBzZWQgPSBlbGVtLmhhc0NsYXNzKCAidWktY29sbGFwc2libGUtY29sYXBzZWQiICk7CgoJCS8vIE9ubHkgb3B0aW9ucyByZWZlcnJpbmcgdG8gdGhlIGN1cnJlbnQgc3RhdGUgbmVlZCB0byBiZSBhcHBsaWVkIHJpZ2h0IGF3YXkKCQkvLyBJdCBpcyBlbm91Z2ggdG8gc3RvcmUgb3B0aW9ucyBjb3ZlcmluZyB0aGUgYWx0ZXJuYXRlIGluIHRoaXMub3B0aW9ucy4KCQlpZiAoIGlzQ29sbGFwc2VkICkgewoJCQlpZiAoIG9wdHMuZXhwYW5kQ3VlVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQkJc3RhdHVzLnRleHQoIG9wdHMuZXhwYW5kQ3VlVGV4dCApOwoJCQl9CgkJCWlmICggb3B0cy5jb2xsYXBzZWRJY29uICE9PSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIGN1cnJlbnRPcHRzLmNvbGxhcHNlZEljb24gKSB7CgkJCQkJYW5jaG9yLnJlbW92ZUNsYXNzKCAidWktaWNvbi0iICsgY3VycmVudE9wdHMuY29sbGFwc2VkSWNvbiApOwoJCQkJfQoJCQkJaWYgKCBvcHRzLmNvbGxhcHNlZEljb24gKSB7CgkJCQkJYW5jaG9yLmFkZENsYXNzKCAidWktaWNvbi0iICsgb3B0cy5jb2xsYXBzZWRJY29uICk7CgkJCQl9CgkJCX0KCQl9IGVsc2UgewoJCQlpZiAoIG9wdHMuY29sbGFwc2VDdWVUZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQlzdGF0dXMudGV4dCggb3B0cy5jb2xsYXBzZUN1ZVRleHQgKTsKCQkJfQoJCQlpZiAoIG9wdHMuZXhwYW5kZWRJY29uICE9PSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIGN1cnJlbnRPcHRzLmV4cGFuZGVkSWNvbiApIHsKCQkJCQlhbmNob3IucmVtb3ZlQ2xhc3MoICJ1aS1pY29uLSIgKyBjdXJyZW50T3B0cy5leHBhbmRlZFdJY29uICk7CgkJCQl9CgkJCQlpZiAoIG9wdHMuZXhwYW5kZWRJY29uICkgewoJCQkJCWFuY2hvci5hZGRDbGFzcyggInVpLWljb24tIiArIG9wdHMuZXhwYW5kZWRJY29uICk7CgkJCQl9CgkJCX0KCQl9CgoJCWlmICggb3B0cy5pY29ucG9zICE9PSB1bmRlZmluZWQgKSB7CgkJCWFuY2hvci5yZW1vdmVDbGFzcyggInVpLWJ0bi1pY29uLSIgKyAoIGN1cnJlbnRPcHRzLmljb25Qb3MgPT09ICJyaWdodCIgPyAicmlnaHQiIDogImxlZnQiICkgKTsKCQkJYW5jaG9yLmFkZENsYXNzKCAidWktYnRuLWljb24tIiArICggb3B0cy5pY29uUG9zID09PSAicmlnaHQiID8gInJpZ2h0IiA6ICJsZWZ0IiApICk7CgkJfQoKCQlpZiAoIG9wdHMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJb2xkVGhlbWUgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJ0bi0iLCBjdXJyZW50T3B0cy50aGVtZSApOwoJCQluZXdUaGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYnRuLSIsIG9wdHMudGhlbWUgKTsKCQkJYW5jaG9yLnJlbW92ZUNsYXNzKCBvbGRUaGVtZSApLmFkZENsYXNzKCBuZXdUaGVtZSApOwoJCX0KCgkJaWYgKCBvcHRzLmNvbnRlbnRUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlvbGRUaGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBjdXJyZW50T3B0cy50aGVtZSApOwoJCQluZXdUaGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBvcHRzLnRoZW1lICk7CgkJCXVpLmNvbnRlbnQucmVtb3ZlQ2xhc3MoIG9sZFRoZW1lICkuYWRkQ2xhc3MoIG5ld1RoZW1lICk7CgkJfQoKCQkvLyBJdCBpcyBpbXBvcnRhbnQgdG8gYXBwbHkgImluc2V0IiBiZWZvcmUgY29ybmVycywgYmVjYXVzZSB0aGUgbmV3IHZhbHVlIG9mCgkJLy8gImluc2V0IiBjYW4gYWZmZWN0IHdoZXRoZXIgd2UgZGlzcGxheSBjb3JuZXJzIG9yIG5vdC4gTm90ZSB0aGF0IHNldHRpbmcKCQkvLyB0aGUgImluc2V0IiBvcHRpb24gdG8gZmFsc2UgZG9lcyBub3QgY2F1c2UgYSBjaGFuZ2UgaW4gdGhlIHZhbHVlIG9mCgkJLy8gdGhpcy5vcHRpb25zLmNvcm5lcnMgLSBpdCBtZXJlbHkgY2F1c2VzIGEgY2hhbmdlIGluIHRoZSBpbnRlcnByZXRhdGlvbiBvZgoJCS8vIHRoZSB2YWx1ZSBvZiB0aGUgImNvcm5lcnMiIG9wdGlvbi4KCQlpZiAoIG9wdHMuaW5zZXQgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWluc2V0Iiwgb3B0cy5pbnNldCApOwoJCQljdXJyZW50T3B0cy5pbnNldCA9IG9wdHMuaW5zZXQ7CgkJCWlmICggIW9wdHMuaW5zZXQgKSB7CgkJCQlvcHRzLmNvcm5lcnMgPSBmYWxzZTsKCQkJfQoJCX0KCgkJaWYgKCBvcHRzLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBjdXJyZW50T3B0cy5pbnNldCAmJiBvcHRzLmNvcm5lcnMgKTsKCQl9CgoJCWlmICggb3B0cy5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCWFuY2hvci50b2dnbGVDbGFzcyggInVpLW1pbmkiLCBvcHRzLm1pbmkgKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9LAoKCV9oYW5kbGVFeHBhbmRDb2xsYXBzZTogZnVuY3Rpb24oIGlzQ29sbGFwc2UgKSB7CgkJdmFyIG9wdHMgPSB0aGlzLl9nZXRPcHRpb25zKCB0aGlzLm9wdGlvbnMgKSwKCQkJdWkgPSB0aGlzLl91aTsKCgkJdWkuc3RhdHVzLnRleHQoIGlzQ29sbGFwc2UgPyBvcHRzLmV4cGFuZEN1ZVRleHQgOiBvcHRzLmNvbGxhcHNlQ3VlVGV4dCApOwoJCXVpLmhlYWRpbmcKCQkJLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICkKCQkJLmZpbmQoICJhIiApLmZpcnN0KCkKCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgb3B0cy5leHBhbmRlZEljb24sICFpc0NvbGxhcHNlICkKCgkJCS8vIGxvZ2ljIG9yIGNhdXNlIHNhbWUgaWNvbiBmb3IgZXhwYW5kZWQvY29sbGFwc2VkIHN0YXRlIHdvdWxkIHJlbW92ZSB0aGUgdWktaWNvbi1jbGFzcwoJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLSIgKyBvcHRzLmNvbGxhcHNlZEljb24sICggaXNDb2xsYXBzZSB8fCBvcHRzLmV4cGFuZGVkSWNvbiA9PT0gb3B0cy5jb2xsYXBzZWRJY29uICkgKQoJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgoJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKTsKCQl1aS5jb250ZW50CgkJCS50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbnRlbnQtY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApCgkJCS5hdHRyKCAiYXJpYS1oaWRkZW4iLCBpc0NvbGxhcHNlICkKCQkJLnRyaWdnZXIoICJ1cGRhdGVsYXlvdXQiICk7CgkJdGhpcy5vcHRpb25zLmNvbGxhcHNlZCA9IGlzQ29sbGFwc2U7CgkJdGhpcy5fdHJpZ2dlciggaXNDb2xsYXBzZSA/ICJjb2xsYXBzZSIgOiAiZXhwYW5kIiApOwoJfSwKCglleHBhbmQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2hhbmRsZUV4cGFuZENvbGxhcHNlKCBmYWxzZSApOwoJfSwKCgljb2xsYXBzZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5faGFuZGxlRXhwYW5kQ29sbGFwc2UoIHRydWUgKTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciB1aSA9IHRoaXMuX3VpLAoJCQlvcHRzID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG9wdHMuZW5oYW5jZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggdWkucGxhY2Vob2xkZXIgKSB7CgkJCXVpLm9yaWdpbmFsSGVhZGluZy5pbnNlcnRCZWZvcmUoIHVpLnBsYWNlaG9sZGVyICk7CgkJCXVpLnBsYWNlaG9sZGVyLnJlbW92ZSgpOwoJCQl1aS5oZWFkaW5nLnJlbW92ZSgpOwoJCX0gZWxzZSB7CgkJCXVpLnN0YXR1cy5yZW1vdmUoKTsKCQkJdWkuaGVhZGluZwoJCQkJLnJlbW92ZUNsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZyB1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIgKQoJCQkJLmNoaWxkcmVuKCkKCQkJCQkuY29udGVudHMoKQoJCQkJCQkudW53cmFwKCk7CgkJfQoKCQl1aS5hbmNob3IuY29udGVudHMoKS51bndyYXAoKTsKCQl1aS5jb250ZW50LmNvbnRlbnRzKCkudW53cmFwKCk7CgkJdGhpcy5lbGVtZW50CgkJCS5yZW1vdmVDbGFzcyggInVpLWNvbGxhcHNpYmxlIHVpLWNvbGxhcHNpYmxlLWNvbGxhcHNlZCAiICsKCQkJCSJ1aS1jb2xsYXBzaWJsZS10aGVtZWQtY29udGVudCB1aS1jb2xsYXBzaWJsZS1pbnNldCB1aS1jb3JuZXItYWxsIiApOwoJfQp9KTsKCi8vIERlZmF1bHRzIHRvIGJlIHVzZWQgYnkgYWxsIGluc3RhbmNlcyBvZiBjb2xsYXBzaWJsZSBpZiBwZXItaW5zdGFuY2UgdmFsdWVzCi8vIGFyZSB1bnNldCBvciBpZiBub3RoaW5nIGlzIHNwZWNpZmllZCBieSB3YXkgb2YgaW5oZXJpdGFuY2UgZnJvbSBhbiBhY2NvcmRpb24uCi8vIE5vdGUgdGhhdCB0aGlzIGhhc2ggZG9lcyBub3QgY29udGFpbiBvcHRpb25zICJjb2xsYXBzZWQiIG9yICJoZWFkaW5nIiwKLy8gYmVjYXVzZSB0aG9zZSBhcmUgbm90IGluaGVyaXRhYmxlLgokLm1vYmlsZS5jb2xsYXBzaWJsZS5kZWZhdWx0cyA9IHsKCWV4cGFuZEN1ZVRleHQ6ICIgY2xpY2sgdG8gZXhwYW5kIGNvbnRlbnRzIiwKCWNvbGxhcHNlQ3VlVGV4dDogIiBjbGljayB0byBjb2xsYXBzZSBjb250ZW50cyIsCgljb2xsYXBzZWRJY29uOiAicGx1cyIsCgljb250ZW50VGhlbWU6ICJpbmhlcml0IiwKCWV4cGFuZGVkSWNvbjogIm1pbnVzIiwKCWljb25wb3M6ICJsZWZ0IiwKCWluc2V0OiB0cnVlLAoJY29ybmVyczogdHJ1ZSwKCW1pbmk6IGZhbHNlCn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzID0gewoJX2dldFZpc2libGVzOiBmdW5jdGlvbiggJGVscywgY3JlYXRlICkgewoJCXZhciB2aXNpYmxlczsKCgkJaWYgKCBjcmVhdGUgKSB7CgkJCXZpc2libGVzID0gJGVscy5ub3QoICIudWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9IGVsc2UgewoJCQl2aXNpYmxlcyA9ICRlbHMuZmlsdGVyKCAiOnZpc2libGUiICk7CgkJCWlmICggdmlzaWJsZXMubGVuZ3RoID09PSAwICkgewoJCQkJdmlzaWJsZXMgPSAkZWxzLm5vdCggIi51aS1zY3JlZW4taGlkZGVuIiApOwoJCQl9CgkJfQoKCQlyZXR1cm4gdmlzaWJsZXM7Cgl9LAoKCV9hZGRGaXJzdExhc3RDbGFzc2VzOiBmdW5jdGlvbiggJGVscywgJHZpc2libGVzLCBjcmVhdGUgKSB7CgkJJGVscy5yZW1vdmVDbGFzcyggInVpLWZpcnN0LWNoaWxkIHVpLWxhc3QtY2hpbGQiICk7CgkJJHZpc2libGVzLmVxKCAwICkuYWRkQ2xhc3MoICJ1aS1maXJzdC1jaGlsZCIgKS5lbmQoKS5sYXN0KCkuYWRkQ2xhc3MoICJ1aS1sYXN0LWNoaWxkIiApOwoJCWlmICggIWNyZWF0ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJ1cGRhdGVsYXlvdXQiICk7CgkJfQoJfSwKCglfcmVtb3ZlRmlyc3RMYXN0Q2xhc3NlczogZnVuY3Rpb24oICRlbHMgKSB7CgkJJGVscy5yZW1vdmVDbGFzcyggInVpLWZpcnN0LWNoaWxkIHVpLWxhc3QtY2hpbGQiICk7Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBjaGlsZENvbGxhcHNpYmxlc1NlbGVjdG9yID0gIjptb2JpbGUtY29sbGFwc2libGUsICIgKyAkLm1vYmlsZS5jb2xsYXBzaWJsZS5pbml0U2VsZWN0b3I7CgokLndpZGdldCggIm1vYmlsZS5jb2xsYXBzaWJsZXNldCIsICQuZXh0ZW5kKCB7Cglpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSIsCgoJb3B0aW9uczogJC5leHRlbmQoIHsKCQllbmhhbmNlZDogZmFsc2UsCgl9LCAkLm1vYmlsZS5jb2xsYXBzaWJsZS5kZWZhdWx0cyApLAoKCV9oYW5kbGVDb2xsYXBzaWJsZUV4cGFuZDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBjbG9zZXN0Q29sbGFwc2libGUgPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLWNvbGxhcHNpYmxlIiApOwoKCQlpZiAoIGNsb3Nlc3RDb2xsYXBzaWJsZS5wYXJlbnQoKS5pcyggIjptb2JpbGUtY29sbGFwc2libGVzZXQsIDpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpIiApICkgewoJCQljbG9zZXN0Q29sbGFwc2libGUKCQkJCS5zaWJsaW5ncyggIi51aS1jb2xsYXBzaWJsZTpub3QoLnVpLWNvbGxhcHNpYmxlLWNvbGxhcHNlZCkiICkKCQkJCS5jb2xsYXBzaWJsZSggImNvbGxhcHNlIiApOwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9jbGFzc2VzOiAiIgoJCX0pOwoKCQlpZiAoICFvcHRzLmVuaGFuY2VkICkgewoJCQllbGVtLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0ICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ncm91cC10aGVtZS0iLCBvcHRzLnRoZW1lICkgKyAiICIgKwoJCQkJKCBvcHRzLmNvcm5lcnMgJiYgb3B0cy5pbnNldCA/ICJ1aS1jb3JuZXItYWxsICIgOiAiIiApICk7CgkJCXRoaXMuZWxlbWVudC5maW5kKCAkLm1vYmlsZS5jb2xsYXBzaWJsZS5pbml0U2VsZWN0b3IgKS5jb2xsYXBzaWJsZSgpOwoJCX0KCgkJdGhpcy5fb24oIGVsZW0sIHsgY29sbGFwc2libGVleHBhbmQ6ICJfaGFuZGxlQ29sbGFwc2libGVFeHBhbmQiIH0gKTsKCX0sCgoJX3RoZW1lQ2xhc3NGcm9tT3B0aW9uOiBmdW5jdGlvbiggcHJlZml4LCB2YWx1ZSApIHsKCQlyZXR1cm4gKCB2YWx1ZSA/ICggdmFsdWUgPT09ICJub25lIiA/ICIiIDogcHJlZml4ICsgdmFsdWUgKSA6ICIiICk7Cgl9LAoKCV9pbml0OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9yZWZyZXNoKCB0cnVlICk7CgoJCS8vIEJlY2F1c2UgdGhlIGNvcm5lcnMgYXJlIGhhbmRsZWQgYnkgdGhlIGNvbGxhcHNpYmxlIGl0c2VsZiBhbmQgdGhlIGRlZmF1bHQgc3RhdGUgaXMgY29sbGFwc2VkCgkJLy8gVGhhdCB3YXMgY2F1c2luZyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQxMTYKCQl0aGlzLmVsZW1lbnQKCQkJLmNoaWxkcmVuKCBjaGlsZENvbGxhcHNpYmxlc1NlbGVjdG9yICkKCQkJLmZpbHRlciggIjpqcW1EYXRhKGNvbGxhcHNlZD0nZmFsc2UnKSIgKQoJCQkuY29sbGFwc2libGUoICJleHBhbmQiICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgcmV0LAoJCQllbGVtID0gdGhpcy5lbGVtZW50LAoJCQl0aGVtZUNsYXNzID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ncm91cC10aGVtZS0iLCBvcHRpb25zLnRoZW1lICk7CgoJCWlmICggdGhlbWVDbGFzcyApIHsKCQkJZWxlbQoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWdyb3VwLXRoZW1lLSIsIHRoaXMub3B0aW9ucy50aGVtZSApICkKCQkJCS5hZGRDbGFzcyggdGhlbWVDbGFzcyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBvcHRpb25zLmNvcm5lcnMgKTsKCQl9CgoJCXJldCA9IHRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgkJdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiOm1vYmlsZS1jb2xsYXBzaWJsZSIgKS5jb2xsYXBzaWJsZSggInJlZnJlc2giICk7CgkJcmV0dXJuIHJldDsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciBlbCA9IHRoaXMuZWxlbWVudDsKCgkJdGhpcy5fcmVtb3ZlRmlyc3RMYXN0Q2xhc3NlcyggZWwuY2hpbGRyZW4oIGNoaWxkQ29sbGFwc2libGVzU2VsZWN0b3IgKSApOwoJCWVsCgkJCS5yZW1vdmVDbGFzcyggInVpLWNvbGxhcHNpYmxlLXNldCB1aS1jb3JuZXItYWxsICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ncm91cC10aGVtZSIsIHRoaXMub3B0aW9ucy50aGVtZSApICkKCQkJLmNoaWxkcmVuKCAiOm1vYmlsZS1jb2xsYXBzaWJsZSIgKQoJCQkuY29sbGFwc2libGUoICJkZXN0cm95IiApOwoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl2YXIgY29sbGFwc2libGVzSW5TZXQgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oIGNoaWxkQ29sbGFwc2libGVzU2VsZWN0b3IgKTsKCgkJJC5tb2JpbGUuY29sbGFwc2libGUucHJvdG90eXBlLmVuaGFuY2UoIGNvbGxhcHNpYmxlc0luU2V0Lm5vdCggIi51aS1jb2xsYXBzaWJsZSIgKSApOwoKCQl0aGlzLl9hZGRGaXJzdExhc3RDbGFzc2VzKCBjb2xsYXBzaWJsZXNJblNldCwgdGhpcy5fZ2V0VmlzaWJsZXMoIGNvbGxhcHNpYmxlc0luU2V0LCBjcmVhdGUgKSwgY3JlYXRlICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlZnJlc2goIGZhbHNlICk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzICkgKTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gRGVwcmVjYXRlZCBpbiAxLjQKJC5mbi5maWVsZGNvbnRhaW4gPSBmdW5jdGlvbigvKiBvcHRpb25zICovKSB7CglyZXR1cm4gdGhpcy5hZGRDbGFzcyggInVpLWZpZWxkLWNvbnRhaW4iICk7Cn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZm4uZ3JpZCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlvID0gJC5leHRlbmQoewoJCQkJZ3JpZDogbnVsbAoJCQl9LCBvcHRpb25zICksCgkJCSRraWRzID0gJHRoaXMuY2hpbGRyZW4oKSwKCQkJZ3JpZENvbHMgPSB7IHNvbG86MSwgYToyLCBiOjMsIGM6NCwgZDo1IH0sCgkJCWdyaWQgPSBvLmdyaWQsCgkJCWl0ZXJhdG9yLAoJCQlsZXR0ZXI7CgoJCQlpZiAoICFncmlkICkgewoJCQkJaWYgKCAka2lkcy5sZW5ndGggPD0gNSApIHsKCQkJCQlmb3IgKCBsZXR0ZXIgaW4gZ3JpZENvbHMgKSB7CgkJCQkJCWlmICggZ3JpZENvbHNbIGxldHRlciBdID09PSAka2lkcy5sZW5ndGggKSB7CgkJCQkJCQlncmlkID0gbGV0dGVyOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlncmlkID0gImEiOwoJCQkJCSR0aGlzLmFkZENsYXNzKCAidWktZ3JpZC1kdW8iICk7CgkJCQl9CgkJCX0KCQkJaXRlcmF0b3IgPSBncmlkQ29sc1tncmlkXTsKCgkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ncmlkLSIgKyBncmlkICk7CgoJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMSkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1hIiApOwoKCQlpZiAoIGl0ZXJhdG9yID4gMSApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibisyKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWIiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiAyICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzMpIiApLmFkZENsYXNzKCAidWktYmxvY2stYyIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDMgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rNCkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1kIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gNCApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibis1KSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWUiICk7CgkJfQoJfSk7Cn07Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUubmF2YmFyIiwgewoJb3B0aW9uczogewoJCWljb25wb3M6ICJ0b3AiLAoJCWdyaWQ6IG51bGwKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciAkbmF2YmFyID0gdGhpcy5lbGVtZW50LAoJCQkkbmF2YnRucyA9ICRuYXZiYXIuZmluZCggImEiICksCgkJCWljb25wb3MgPSAkbmF2YnRucy5maWx0ZXIoICI6anFtRGF0YShpY29uKSIgKS5sZW5ndGggPyB0aGlzLm9wdGlvbnMuaWNvbnBvcyA6IHVuZGVmaW5lZDsKCgkJJG5hdmJhci5hZGRDbGFzcyggInVpLW5hdmJhciIgKQoJCQkuYXR0ciggInJvbGUiLCAibmF2aWdhdGlvbiIgKQoJCQkuZmluZCggInVsIiApCgkJCS5qcW1FbmhhbmNlYWJsZSgpCgkJCS5ncmlkKHsgZ3JpZDogdGhpcy5vcHRpb25zLmdyaWQgfSk7CgoJCSRuYXZidG5zCgkJCS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCXZhciBpY29uID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAiaWNvbiIgKSwKCQkJCQl0aGVtZSA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggdGhpcywgInRoZW1lIiApLAoJCQkJCWNsYXNzZXMgPSAidWktYnRuIjsKCgkJCQlpZiAoIHRoZW1lICkgewoJCQkJCWNsYXNzZXMgKz0gIiB1aS1idG4tIiArIHRoZW1lOwoJCQkJfQoJCQkJaWYgKCBpY29uICkgewoJCQkJCWNsYXNzZXMgKz0gIiB1aS1pY29uLSIgKyBpY29uICsgIiB1aS1idG4taWNvbi0iICsgaWNvbnBvczsKCQkJCX0KCQkJCSQoIHRoaXMgKS5hZGRDbGFzcyggY2xhc3NlcyApOwoJCQl9KTsKCgkJJG5hdmJhci5kZWxlZ2F0ZSggImEiLCAidmNsaWNrIiwgZnVuY3Rpb24oIC8qIGV2ZW50ICovICkgewoJCQl2YXIgYWN0aXZlQnRuOwoKCQkJaWYgKCAhJCggdGhpcyApLmlzKCAiLnVpLWRpc2FibGVkLCAudWktYnRuLWFjdGl2ZSIgKSApIHsKCQkJCSRuYXZidG5zLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJJCggdGhpcyApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoKCQkJCS8vIFRoZSBjb2RlIGJlbG93IGlzIGEgd29ya2Fyb3VuZCB0byBmaXggIzExODEKCQkJCWFjdGl2ZUJ0biA9ICQoIHRoaXMgKTsKCgkJCQkkKCBkb2N1bWVudCApLm9uZSggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJYWN0aXZlQnRuLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJfSk7CgkJCX0KCQl9KTsKCgkJLy8gQnV0dG9ucyBpbiB0aGUgbmF2YmFyIHdpdGggdWktc3RhdGUtcGVyc2lzdCBjbGFzcyBzaG91bGQgcmVnYWluIHRoZWlyIGFjdGl2ZSBzdGF0ZSBiZWZvcmUgcGFnZSBzaG93CgkJJG5hdmJhci5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuYmluZCggInBhZ2ViZWZvcmVzaG93IiwgZnVuY3Rpb24oKSB7CgkJCSRuYXZidG5zLmZpbHRlciggIi51aS1zdGF0ZS1wZXJzaXN0IiApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0pOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIGdldEF0dHIgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGU7CgokLndpZGdldCggIm1vYmlsZS5saXN0dmlldyIsICQuZXh0ZW5kKCB7CgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWNvdW50VGhlbWU6IG51bGwsIC8qIERlcHJlY2F0ZWQgaW4gMS40ICovCgkJZGl2aWRlclRoZW1lOiBudWxsLAoJCWljb246ICJjYXJhdC1yIiwKCQlzcGxpdEljb246ICJjYXJhdC1yIiwKCQlzcGxpdFRoZW1lOiBudWxsLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWluc2V0OiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgdCA9IHRoaXMsCgkJCWxpc3R2aWV3Q2xhc3NlcyA9ICIiOwoKCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLmluc2V0ID8gIiB1aS1saXN0dmlldy1pbnNldCIgOiAiIjsKCgkJaWYgKCAhIXQub3B0aW9ucy5pbnNldCApIHsKCQkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiOwoJCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLnNoYWRvdyA/ICIgdWktc2hhZG93IiA6ICIiOwoJCX0KCgkJLy8gY3JlYXRlIGxpc3R2aWV3IG1hcmt1cAoJCXQuZWxlbWVudC5hZGRDbGFzcyggIiB1aS1saXN0dmlldyIgKyBsaXN0dmlld0NsYXNzZXMgKTsKCgkJdC5yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCS8vIFRPRE86IFJlbW92ZSBpbiAxLjUKCV9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lOiBmdW5jdGlvbiggZWxlLCBuZXh0UHJvcCwgbGNOYW1lLCB1Y05hbWUgKSB7CgkJdmFyIGRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJldHVybiBlbGU7CgkJCX0KCQkJZWxlID0gZWxlWyBuZXh0UHJvcCBdOwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0sCgkvLyBUT0RPOiBSZW1vdmUgaW4gMS41CglfYWRkVGh1bWJDbGFzc2VzOiBmdW5jdGlvbiggY29udGFpbmVycyApIHsKCQl2YXIgaSwgaW1nLCBsZW4gPSBjb250YWluZXJzLmxlbmd0aDsKCQlmb3IgKCBpID0gMDsgaSA8IGxlbjsgaSsrICkgewoJCQlpbWcgPSAkKCB0aGlzLl9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lKCBjb250YWluZXJzWyBpIF0uZmlyc3RDaGlsZCwgIm5leHRTaWJsaW5nIiwgImltZyIsICJJTUciICkgKTsKCQkJaWYgKCBpbWcubGVuZ3RoICkgewoJCQkJJCggdGhpcy5fZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZSggaW1nWyAwIF0ucGFyZW50Tm9kZSwgInBhcmVudE5vZGUiLCAibGkiLCAiTEkiICkgKS5hZGRDbGFzcyggaW1nLmhhc0NsYXNzKCAidWktbGktaWNvbiIgKSA/ICJ1aS1saS1oYXMtaWNvbiIgOiAidWktbGktaGFzLXRodW1iIiApOwoJCQl9CgkJfQoJfSwKCglfZ2V0Q2hpbGRyZW5CeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIGxjTmFtZSwgdWNOYW1lICkgewoJCXZhciByZXN1bHRzID0gW10sCgkJCWRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQllbGUgPSBlbGUuZmlyc3RDaGlsZDsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJlc3VsdHMucHVzaCggZWxlICk7CgkJCX0KCQkJZWxlID0gZWxlLm5leHRTaWJsaW5nOwoJCX0KCQlyZXR1cm4gJCggcmVzdWx0cyApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciBidXR0b25DbGFzcywgcG9zLCBudW1saSwgaXRlbSwgaXRlbUNsYXNzLCBpdGVtVGhlbWUsIGl0ZW1JY29uLCBpY29uLCBhLAoJCQlpc0RpdmlkZXIsIHN0YXJ0Q291bnQsIG5ld1N0YXJ0Q291bnQsIHZhbHVlLCBsYXN0LCBzcGxpdHRoZW1lLCBzcGxpdFRoZW1lQ2xhc3MsIHNwbGl0aWNvbiwKCQkJYWx0QnV0dG9uQ2xhc3MsIGRpdmlkZXJUaGVtZSwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJJGxpc3QgPSB0aGlzLmVsZW1lbnQsCgkJCWxpID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoICRsaXN0WyAwIF0sICJsaSIsICJMSSIgKSwKCQkJb2wgPSAhISQubm9kZU5hbWUoICRsaXN0WyAwIF0sICJvbCIgKSwKCQkJc3RhcnQgPSAkbGlzdC5hdHRyKCAic3RhcnQiICksCgkJCWl0ZW1DbGFzc0RpY3QgPSB7fSwKCQkJY291bnRCdWJibGVzID0gJGxpc3QuZmluZCggIi51aS1saS1jb3VudCIgKSwKCQkJY291bnRUaGVtZSA9IGdldEF0dHIoICRsaXN0WyAwIF0sICJjb3VudHRoZW1lIiApIHx8IHRoaXMub3B0aW9ucy5jb3VudFRoZW1lLAoJCQljb3VudFRoZW1lQ2xhc3MgPSBjb3VudFRoZW1lID8gInVpLWJvZHktIiArIGNvdW50VGhlbWUgOiAidWktYm9keS1pbmhlcml0IjsKCgkJaWYgKCBvLnRoZW1lICkgewoJCQkkbGlzdC5hZGRDbGFzcyggInVpLWdyb3VwLXRoZW1lLSIgKyBvLnRoZW1lICk7CgkJfQoKCQkvLyBDaGVjayBpZiBhIHN0YXJ0IGF0dHJpYnV0ZSBoYXMgYmVlbiBzZXQgd2hpbGUgdGFraW5nIGEgdmFsdWUgb2YgMCBpbnRvIGFjY291bnQKCQlpZiAoIG9sICYmICggc3RhcnQgfHwgc3RhcnQgPT09IDAgKSApIHsKCQkJc3RhcnRDb3VudCA9IHBhcnNlSW50KCBzdGFydCwgMTAgKSAtIDE7CgkJCSRsaXN0LmNzcyggImNvdW50ZXItcmVzZXQiLCAibGlzdG51bWJlcmluZyAiICsgc3RhcnRDb3VudCApOwoJCX0KCgkJZm9yICggcG9zID0gMCwgbnVtbGkgPSBsaS5sZW5ndGg7IHBvcyA8IG51bWxpOyBwb3MrKyApIHsKCQkJaXRlbSA9IGxpLmVxKCBwb3MgKTsKCQkJaXRlbUNsYXNzID0gIiI7CgoJCQlpZiAoIGNyZWF0ZSB8fCBpdGVtWyAwIF0uY2xhc3NOYW1lLnNlYXJjaCggL1xidWktbGktc3RhdGljXGJ8XGJ1aS1saS1kaXZpZGVyXGIvICkgPCAwICkgewoJCQkJYSA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCBpdGVtWyAwIF0sICJhIiwgIkEiICk7CgkJCQlpc0RpdmlkZXIgPSAoIGdldEF0dHIoIGl0ZW1bIDAgXSwgInJvbGUiICkgPT09ICJsaXN0LWRpdmlkZXIiICk7CgkJCQl2YWx1ZSA9IGl0ZW0uYXR0ciggInZhbHVlIiApOwoJCQkJaXRlbVRoZW1lID0gZ2V0QXR0ciggaXRlbVsgMCBdLCAidGhlbWUiICk7CgoJCQkJaWYgKCBhLmxlbmd0aCAmJiBhWyAwIF0uY2xhc3NOYW1lLnNlYXJjaCggL1xidWktYnRuXGIvICkgPCAwICYmICFpc0RpdmlkZXIgKSB7CgkJCQkJaXRlbUljb24gPSBnZXRBdHRyKCBpdGVtWyAwIF0sICJpY29uIiApOwoJCQkJCWljb24gPSAoIGl0ZW1JY29uID09PSBmYWxzZSApID8gZmFsc2UgOiAoIGl0ZW1JY29uIHx8IG8uaWNvbiApOwoKCQkJCQkvLyBUT0RPOiBSZW1vdmUgaW4gMS41IHRvZ2V0aGVyIHdpdGggbGlua3MuanMgKGxpbmtzLmpzIC8gLnVpLWxpbmsgZGVwcmVjYXRlZCBpbiAxLjQpCgkJCQkJYS5yZW1vdmVDbGFzcyggInVpLWxpbmsiICk7CgoJCQkJCWJ1dHRvbkNsYXNzID0gInVpLWJ0biI7CgoJCQkJCWlmICggaXRlbVRoZW1lICkgewoJCQkJCQlidXR0b25DbGFzcyArPSAiIHVpLWJ0bi0iICsgaXRlbVRoZW1lOwoJCQkJCX0KCgkJCQkJaWYgKCBhLmxlbmd0aCA+IDEgKSB7CgkJCQkJCWl0ZW1DbGFzcyA9ICJ1aS1saS1oYXMtYWx0IjsKCgkJCQkJCWxhc3QgPSBhLmxhc3QoKTsKCQkJCQkJc3BsaXR0aGVtZSA9IGdldEF0dHIoIGxhc3RbIDAgXSwgInRoZW1lIiApIHx8IG8uc3BsaXRUaGVtZSB8fCBnZXRBdHRyKCBpdGVtWyAwIF0sICJ0aGVtZSIsIHRydWUgKTsKCQkJCQkJc3BsaXRUaGVtZUNsYXNzID0gc3BsaXR0aGVtZSA/ICIgdWktYnRuLSIgKyBzcGxpdHRoZW1lIDogIiI7CgkJCQkJCXNwbGl0aWNvbiA9IGdldEF0dHIoIGxhc3RbIDAgXSwgImljb24iICkgfHwgZ2V0QXR0ciggaXRlbVsgMCBdLCAiaWNvbiIgKSB8fCBvLnNwbGl0SWNvbjsKCQkJCQkJYWx0QnV0dG9uQ2xhc3MgPSAidWktYnRuIHVpLWJ0bi1pY29uLW5vdGV4dCB1aS1pY29uLSIgKyBzcGxpdGljb24gKyBzcGxpdFRoZW1lQ2xhc3M7CgoJCQkJCQlsYXN0CgkJCQkJCQkuYXR0ciggInRpdGxlIiwgJC50cmltKCBsYXN0LmdldEVuY29kZWRUZXh0KCkgKSApCgkJCQkJCQkuYWRkQ2xhc3MoIGFsdEJ1dHRvbkNsYXNzICkKCQkJCQkJCS5lbXB0eSgpOwoJCQkJCX0gZWxzZSBpZiAoIGljb24gKSB7CgkJCQkJCWJ1dHRvbkNsYXNzICs9ICIgdWktYnRuLWljb24tcmlnaHQgdWktaWNvbi0iICsgaWNvbjsKCQkJCQl9CgoJCQkJCWEuZmlyc3QoKS5hZGRDbGFzcyggYnV0dG9uQ2xhc3MgKTsKCQkJCX0gZWxzZSBpZiAoIGlzRGl2aWRlciApIHsKCQkJCQlkaXZpZGVyVGhlbWUgPSAoIGdldEF0dHIoIGl0ZW1bIDAgXSwgInRoZW1lIiApIHx8IG8uZGl2aWRlclRoZW1lIHx8IG8udGhlbWUgKTsKCgkJCQkJaXRlbUNsYXNzID0gInVpLWxpLWRpdmlkZXIgdWktYmFyLSIgKyAoIGRpdmlkZXJUaGVtZSA/IGRpdmlkZXJUaGVtZSA6ICJpbmhlcml0IiApOwoKCQkJCQlpdGVtLmF0dHIoICJyb2xlIiwgImhlYWRpbmciICk7CgkJCQl9IGVsc2UgaWYgKCBhLmxlbmd0aCA8PSAwICkgewoJCQkJCWl0ZW1DbGFzcyA9ICJ1aS1saS1zdGF0aWMgdWktYm9keS0iICsgKCBpdGVtVGhlbWUgPyBpdGVtVGhlbWUgOiAiaW5oZXJpdCIgKTsKCQkJCX0KCQkJCWlmICggb2wgJiYgdmFsdWUgKSB7CgkJCQkJbmV3U3RhcnRDb3VudCA9IHBhcnNlSW50KCB2YWx1ZSAsIDEwICkgLSAxOwoKCQkJCQlpdGVtLmNzcyggImNvdW50ZXItcmVzZXQiLCAibGlzdG51bWJlcmluZyAiICsgbmV3U3RhcnRDb3VudCApOwoJCQkJfQoJCQl9CgoJCQkvLyBJbnN0ZWFkIG9mIHNldHRpbmcgaXRlbSBjbGFzcyBkaXJlY3RseSBvbiB0aGUgbGlzdCBpdGVtCgkJCS8vIGF0IHRoaXMgcG9pbnQgaW4gdGltZSwgcHVzaCB0aGUgaXRlbSBpbnRvIGEgZGljdGlvbmFyeQoJCQkvLyB0aGF0IHRlbGxzIHVzIHdoYXQgY2xhc3MgdG8gc2V0IG9uIGl0IHNvIHdlIGNhbiBkbyB0aGlzIGFmdGVyIHRoaXMKCQkJLy8gcHJvY2Vzc2luZyBsb29wIGlzIGZpbmlzaGVkLgoKCQkJaWYgKCAhaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKSB7CgkJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSA9IFtdOwoJCQl9CgoJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXS5wdXNoKCBpdGVtWyAwIF0gKTsKCQl9CgoJCS8vIFNldCB0aGUgYXBwcm9wcmlhdGUgbGlzdHZpZXcgaXRlbSBjbGFzc2VzIG9uIGVhY2ggbGlzdCBpdGVtLgoJCS8vIFRoZSBtYWluIHJlYXNvbiB3ZSBkaWRuJ3QgZG8gdGhpcwoJCS8vIGluIHRoZSBmb3ItbG9vcCBhYm92ZSBpcyBiZWNhdXNlIHdlIGNhbiBlbGltaW5hdGUgcGVyLWl0ZW0gZnVuY3Rpb24gb3ZlcmhlYWQKCQkvLyBieSBjYWxsaW5nIGFkZENsYXNzKCkgYW5kIGNoaWxkcmVuKCkgb25jZSBvciB0d2ljZSBhZnRlcndhcmRzLiBUaGlzCgkJLy8gY2FuIGdpdmUgdXMgYSBzaWduaWZpY2FudCBib29zdCBvbiBwbGF0Zm9ybXMgbGlrZSBXUDcuNS4KCgkJZm9yICggaXRlbUNsYXNzIGluIGl0ZW1DbGFzc0RpY3QgKSB7CgkJCSQoIGl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdICkuYWRkQ2xhc3MoIGl0ZW1DbGFzcyApOwoJCX0KCgkJY291bnRCdWJibGVzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktbGktaGFzLWNvdW50IiApOwoJCX0pOwoJCWlmICggY291bnRUaGVtZUNsYXNzICkgewoJCQljb3VudEJ1YmJsZXMuYWRkQ2xhc3MoIGNvdW50VGhlbWVDbGFzcyApOwoJCX0KCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQuIEZyb20gMS41IHlvdSBoYXZlIHRvIGFkZCBjbGFzcyB1aS1saS1oYXMtdGh1bWIgb3IgdWktbGktaGFzLWljb24gdG8gdGhlIExJLgoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggbGkgKTsKCQl0aGlzLl9hZGRUaHVtYkNsYXNzZXMoIGxpLmZpbmQoICIudWktYnRuIiApICk7CgoJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGxpLCB0aGlzLl9nZXRWaXNpYmxlcyggbGksIGNyZWF0ZSApLCBjcmVhdGUgKTsKCQkvLyBhdXRvZGl2aWRlcnMgYmluZHMgdG8gdGhpcyB0byByZWRyYXcgZGl2aWRlcnMgYWZ0ZXIgdGhlIGxpc3R2aWV3IHJlZnJlc2gKCQl0aGlzLl90cmlnZ2VyKCAiYWZ0ZXJyZWZyZXNoIiApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIFRPRE8gcmVuYW1lIGZpbHRlckNhbGxiYWNrL2RlcHJlY2F0ZSBhbmQgZGVmYXVsdCB0byB0aGUgaXRlbSBpdHNlbGYgYXMgdGhlIGZpcnN0IGFyZ3VtZW50CnZhciBkZWZhdWx0RmlsdGVyQ2FsbGJhY2sgPSBmdW5jdGlvbiggaW5kZXgsIHNlYXJjaFZhbHVlICkgewoJcmV0dXJuICggKCAiIiArICggJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAiZmlsdGVydGV4dCIgKSB8fCAkKCB0aGlzICkudGV4dCgpICkgKQoJCS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoIHNlYXJjaFZhbHVlICkgPT09IC0xICk7Cn07CgokLndpZGdldCggIm1vYmlsZS5maWx0ZXJhYmxlIiwgewoKCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKGZpbHRlcj0ndHJ1ZScpIiwKCglvcHRpb25zOiB7CgkJZmlsdGVyUmV2ZWFsOiBmYWxzZSwKCQlmaWx0ZXJDYWxsYmFjazogZGVmYXVsdEZpbHRlckNhbGxiYWNrLAoJCWVuaGFuY2VkOiBmYWxzZSwKCQlpbnB1dDogbnVsbCwKCQljaGlsZHJlbjogIj4gbGksID4gb3B0aW9uLCBvcHRncm91cCBvcHRpb25zLCB0Ym9keSB0ciwgLnVpLWNvbnRyb2xncm91cC1jb250cm9scyAudWktYnRuIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3NlYXJjaDogbnVsbCwKCQkJX3RpbWVyOiAwCgkJfSk7CgoJCXRoaXMuX3NldElucHV0KCBvcHRzLmlucHV0ICk7CgkJaWYgKCAhb3B0cy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fZmlsdGVySXRlbXMoICggKCB0aGlzLl9zZWFyY2ggJiYgdGhpcy5fc2VhcmNoLnZhbCgpICkgfHwgIiIgKS50b0xvd2VyQ2FzZSgpICk7CgkJfQoJfSwKCglfb25LZXlVcDogZnVuY3Rpb24oKSB7CgkJdmFyIHZhbCwgbGFzdHZhbCwKCQkJc2VhcmNoID0gdGhpcy5fc2VhcmNoOwoKCQlpZiAoIHNlYXJjaCApIHsKCQkJdmFsID0gc2VhcmNoLnZhbCgpLnRvTG93ZXJDYXNlKCksCgkJCWxhc3R2YWwgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHNlYXJjaFsgMCBdLCAibGFzdHZhbCIgKSArICIiOwoKCQkJaWYgKCBsYXN0dmFsICYmIGxhc3R2YWwgPT09IHZhbCApIHsKCQkJCS8vIEV4ZWN1dGUgdGhlIGhhbmRsZXIgb25seSBvbmNlIHBlciB2YWx1ZSBjaGFuZ2UKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCB0aGlzLl90aW1lciApIHsKCQkJCXdpbmRvdy5jbGVhclRpbWVvdXQoIHRoaXMuX3RpbWVyICk7CgkJCQl0aGlzLl90aW1lciA9IDA7CgkJCX0KCgkJCXRoaXMuX3RpbWVyID0gdGhpcy5fZGVsYXkoIGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fdHJpZ2dlciggImJlZm9yZWZpbHRlciIsICJiZWZvcmVmaWx0ZXIiLCB7IGlucHV0OiBzZWFyY2ggfSApOwoKCQkJCS8vIENoYW5nZSB2YWwgYXMgbGFzdHZhbCBmb3IgbmV4dCBleGVjdXRpb24KCQkJCXNlYXJjaFsgMCBdLnNldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgImxhc3R2YWwiLCB2YWwgKTsKCgkJCQl0aGlzLl9maWx0ZXJJdGVtcyggdmFsICk7CgkJCQl0aGlzLl90aW1lciA9IDA7CgkJCX0sIDI1MCApOwoJCX0KCX0sCgoJX2dldEZpbHRlcmFibGVJdGVtczogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCWNoaWxkcmVuID0gdGhpcy5vcHRpb25zLmNoaWxkcmVuLAoJCQlpdGVtcyA9ICFjaGlsZHJlbiA/IHsgbGVuZ3RoOiAwIH06CgkJCQkkLmlzRnVuY3Rpb24oIGNoaWxkcmVuICkgPyBjaGlsZHJlbigpOgoJCQkJY2hpbGRyZW4ubm9kZU5hbWUgPyAkKCBjaGlsZHJlbiApOgoJCQkJY2hpbGRyZW4uanF1ZXJ5ID8gY2hpbGRyZW46CgkJCQl0aGlzLmVsZW1lbnQuZmluZCggY2hpbGRyZW4gKTsKCgkJaWYgKCBpdGVtcy5sZW5ndGggPT09IDAgKSB7CgkJCWl0ZW1zID0gZWxlbS5jaGlsZHJlbigpOwoJCX0KCgkJcmV0dXJuIGl0ZW1zOwoJfSwKCglfZmlsdGVySXRlbXM6IGZ1bmN0aW9uKCB2YWwgKSB7CgkJdmFyIGlkeCwgY2FsbGJhY2ssIGxlbmd0aCwgZHN0LAoJCQlzaG93ID0gW10sCgkJCWhpZGUgPSBbXSwKCQkJb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJZmlsdGVySXRlbXMgPSB0aGlzLl9nZXRGaWx0ZXJhYmxlSXRlbXMoKTsKCgkJaWYgKCB2YWwgIT0gbnVsbCApIHsKCQkJY2FsbGJhY2sgPSBvcHRzLmZpbHRlckNhbGxiYWNrIHx8IGRlZmF1bHRGaWx0ZXJDYWxsYmFjazsKCQkJbGVuZ3RoID0gZmlsdGVySXRlbXMubGVuZ3RoOwoKCQkJLy8gUGFydGl0aW9uIHRoZSBpdGVtcyBpbnRvIHRob3NlIHRvIGJlIGhpZGRlbiBhbmQgdGhvc2UgdG8gYmUgc2hvd24KCQkJZm9yICggaWR4ID0gMCA7IGlkeCA8IGxlbmd0aCA7IGlkeCsrICkgewoJCQkJZHN0ID0gKCBjYWxsYmFjay5jYWxsKCBmaWx0ZXJJdGVtc1sgaWR4IF0sIGlkeCwgdmFsICkgKSA/IGhpZGUgOiBzaG93OwoJCQkJZHN0LnB1c2goIGZpbHRlckl0ZW1zWyBpZHggXSApOwoJCQl9CgkJfQoKCQkvLyBJZiBub3RoaW5nIGlzIGhpZGRlbiwgdGhlbiB0aGUgZGVjaXNpb24gd2hldGhlciB0byBoaWRlIG9yIHNob3cgdGhlIGl0ZW1zCgkJLy8gaXMgYmFzZWQgb24gdGhlICJmaWx0ZXJSZXZlYWwiIG9wdGlvbi4KCQlpZiAoIGhpZGUubGVuZ3RoID09PSAwICkgewoJCQlmaWx0ZXJJdGVtc1sgb3B0cy5maWx0ZXJSZXZlYWwgPyAiYWRkQ2xhc3MiIDogInJlbW92ZUNsYXNzIiBdKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9IGVsc2UgewoJCQkkKCBoaWRlICkuYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCQkkKCBzaG93ICkucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0KCgkJdGhpcy5fcmVmcmVzaENoaWxkV2lkZ2V0KCk7Cgl9LAoKCS8vIFRoZSBEZWZhdWx0IGltcGxlbWVudGF0aW9uIG9mIF9yZWZyZXNoQ2hpbGRXaWRnZXQgYXR0ZW1wdHMgdG8gY2FsbAoJLy8gcmVmcmVzaCBvbiBjb2xsYXBzaWJsZXNldCwgY29udHJvbGdyb3VwLCBzZWxlY3RtZW51LCBvciBsaXN0dmlldwoJX3JlZnJlc2hDaGlsZFdpZGdldDogZnVuY3Rpb24oKSB7CgkJdmFyIHdpZGdldCwgaWR4LAoJCQlyZWNvZ25pemVkV2lkZ2V0cyA9IFsgImNvbGxhcHNpYmxlc2V0IiwgInNlbGVjdG1lbnUiLCAiY29udHJvbGdyb3VwIiwgImxpc3R2aWV3IiBdOwoKCQlmb3IgKCBpZHggPSByZWNvZ25pemVkV2lkZ2V0cy5sZW5ndGggLSAxIDsgaWR4ID4gLTEgOyBpZHgtLSApIHsKCQkJd2lkZ2V0ID0gcmVjb2duaXplZFdpZGdldHNbIGlkeCBdOwoJCQlpZiAoICQubW9iaWxlWyB3aWRnZXQgXSApIHsKCQkJCXdpZGdldCA9IHRoaXMuZWxlbWVudC5kYXRhKCAibW9iaWxlLSIgKyB3aWRnZXQgKTsKCQkJCWlmICggd2lkZ2V0ICYmICQuaXNGdW5jdGlvbiggd2lkZ2V0LnJlZnJlc2ggKSApIHsKCQkJCQl3aWRnZXQucmVmcmVzaCgpOwoJCQkJfQoJCQl9CgkJfQoJfSwKCgkvLyBUT0RPOiBXaGVuIHRoZSBpbnB1dCBpcyBub3QgaW50ZXJuYWwsIGRvIG5vdCBldmVuIHN0b3JlIGl0IGluIHRoaXMuX3NlYXJjaAoJX3NldElucHV0OiBmdW5jdGlvbiAoIHNlbGVjdG9yICkgewoJCXZhciBzZWFyY2ggPSB0aGlzLl9zZWFyY2g7CgoJCS8vIFN0b3AgYSBwZW5kaW5nIGZpbHRlciBvcGVyYXRpb24KCQlpZiAoIHRoaXMuX3RpbWVyICkgewoJCQl3aW5kb3cuY2xlYXJUaW1lb3V0KCB0aGlzLl90aW1lciApOwoJCQl0aGlzLl90aW1lciA9IDA7CgkJfQoKCQlpZiAoIHNlYXJjaCApIHsKCQkJdGhpcy5fb2ZmKCBzZWFyY2gsICJrZXl1cCBjaGFuZ2UgaW5wdXQiICk7CgkJCXNlYXJjaCA9IG51bGw7CgkJfQoKCQlpZiAoIHNlbGVjdG9yICkgewoJCQlzZWFyY2ggPSBzZWxlY3Rvci5qcXVlcnkgPyBzZWxlY3RvcjoKCQkJCXNlbGVjdG9yLm5vZGVOYW1lID8gJCggc2VsZWN0b3IgKToKCQkJCXRoaXMuZG9jdW1lbnQuZmluZCggc2VsZWN0b3IgKTsKCgkJCXRoaXMuX29uKCBzZWFyY2gsIHsKCQkJCWtleXVwOiAiX29uS2V5VXAiLAoJCQkJY2hhbmdlOiAiX29uS2V5VXAiLAoJCQkJaW5wdXQ6ICJfb25LZXlVcCIKCQkJfSk7CgkJfQoKCQl0aGlzLl9zZWFyY2ggPSBzZWFyY2g7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgcmVmaWx0ZXIgPSAhKCAoIG9wdGlvbnMuZmlsdGVyUmV2ZWFsID09PSB1bmRlZmluZWQgKSAmJgoJCQkJKCBvcHRpb25zLmZpbHRlckNhbGxiYWNrID09PSB1bmRlZmluZWQgKSAmJgoJCQkJKCBvcHRpb25zLmNoaWxkcmVuID09PSB1bmRlZmluZWQgKSApOwoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoKCQlpZiAoIG9wdGlvbnMuaW5wdXQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0SW5wdXQoIG9wdGlvbnMuaW5wdXQgKTsKCQkJcmVmaWx0ZXIgPSB0cnVlOwoJCX0KCgkJaWYgKCByZWZpbHRlciApIHsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJfQoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdHMgPSB0aGlzLm9wdGlvbnMsCgkJCWl0ZW1zID0gdGhpcy5fZ2V0RmlsdGVyYWJsZUl0ZW1zKCk7CgoJCWlmICggb3B0cy5lbmhhbmNlZCApIHsKCQkJaXRlbXMudG9nZ2xlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiwgb3B0cy5maWx0ZXJSZXZlYWwgKTsKCQl9IGVsc2UgewoJCQlpdGVtcy5yZW1vdmVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfQoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuX3RpbWVyICkgewoJCQl3aW5kb3cuY2xlYXJUaW1lb3V0KCB0aGlzLl90aW1lciApOwoJCQl0aGlzLl90aW1lciA9IDA7CgkJfQoJCXRoaXMuX2ZpbHRlckl0ZW1zKCAoICggdGhpcy5fc2VhcmNoICYmIHRoaXMuX3NlYXJjaC52YWwoKSApIHx8ICIiICkudG9Mb3dlckNhc2UoKSApOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gQ3JlYXRlIGEgZnVuY3Rpb24gdGhhdCB3aWxsIHJlcGxhY2UgdGhlIF9zZXRPcHRpb25zIGZ1bmN0aW9uIG9mIGEgd2lkZ2V0LAovLyBhbmQgd2lsbCBwYXNzIHRoZSBvcHRpb25zIG9uIHRvIHRoZSBpbnB1dCBvZiB0aGUgZmlsdGVyYWJsZS4KdmFyIHJlcGxhY2VTZXRPcHRpb25zID0gZnVuY3Rpb24oIHNlbGYsIG9yaWcgKSB7CgkJcmV0dXJuIGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCQlvcmlnLmNhbGwoIHRoaXMsIG9wdGlvbnMgKTsKCQkJc2VsZi5fc3luY1RleHRJbnB1dE9wdGlvbnMoIG9wdGlvbnMgKTsKCQl9OwoJfSwKCXJEaXZpZGVyTGlzdEl0ZW0gPSAvKF58XHMpdWktbGktZGl2aWRlcihcc3wkKS8sCglvcmlnRGVmYXVsdEZpbHRlckNhbGxiYWNrID0gJC5tb2JpbGUuZmlsdGVyYWJsZS5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJDYWxsYmFjazsKCi8vIE92ZXJyaWRlIHRoZSBkZWZhdWx0IGZpbHRlciBjYWxsYmFjayB3aXRoIG9uZSB0aGF0IGRvZXMgbm90IGhpZGUgbGlzdCBkaXZpZGVycwokLm1vYmlsZS5maWx0ZXJhYmxlLnByb3RvdHlwZS5vcHRpb25zLmZpbHRlckNhbGxiYWNrID0gZnVuY3Rpb24oIGluZGV4LCBzZWFyY2hWYWx1ZSApIHsKCXJldHVybiAhdGhpcy5jbGFzc05hbWUubWF0Y2goIHJEaXZpZGVyTGlzdEl0ZW0gKSAmJgoJCW9yaWdEZWZhdWx0RmlsdGVyQ2FsbGJhY2suY2FsbCggdGhpcywgaW5kZXgsIHNlYXJjaFZhbHVlICk7Cn07CgokLndpZGdldCggIm1vYmlsZS5maWx0ZXJhYmxlIiwgJC5tb2JpbGUuZmlsdGVyYWJsZSwgewoJb3B0aW9uczogewoJCWZpbHRlclBsYWNlaG9sZGVyOiAiRmlsdGVyIGl0ZW1zLi4uIiwKCQlmaWx0ZXJUaGVtZTogbnVsbAoJfSwKCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGlkeCwgd2lkZ2V0TmFtZSwKCQkJZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJcmVjb2duaXplZFdpZGdldHMgPSBbICJjb2xsYXBzaWJsZXNldCIsICJzZWxlY3RtZW51IiwgImNvbnRyb2xncm91cCIsICJsaXN0dmlldyIgXSwKCQkJY3JlYXRlSGFuZGxlcnMgPSB7fTsKCgkJdGhpcy5fc3VwZXIoKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3dpZGdldDogbnVsbAoJCX0pOwoKCQlmb3IgKCBpZHggPSByZWNvZ25pemVkV2lkZ2V0cy5sZW5ndGggLSAxIDsgaWR4ID4gLTEgOyBpZHgtLSApIHsKCQkJd2lkZ2V0TmFtZSA9IHJlY29nbml6ZWRXaWRnZXRzWyBpZHggXTsKCQkJaWYgKCAkLm1vYmlsZVsgd2lkZ2V0TmFtZSBdICkgewoJCQkJaWYgKCB0aGlzLl9zZXRXaWRnZXQoIGVsZW0uZGF0YSggIm1vYmlsZS0iICsgd2lkZ2V0TmFtZSApICkgKSB7CgkJCQkJYnJlYWs7CgkJCQl9IGVsc2UgewoJCQkJCWNyZWF0ZUhhbmRsZXJzWyB3aWRnZXROYW1lICsgImNyZWF0ZSIgXSA9ICJfaGFuZGxlQ3JlYXRlIjsKCQkJCX0KCQkJfQoJCX0KCgkJaWYgKCAhdGhpcy5fd2lkZ2V0ICkgewoJCQl0aGlzLl9vbiggZWxlbSwgY3JlYXRlSGFuZGxlcnMgKTsKCQl9Cgl9LAoKCV9oYW5kbGVDcmVhdGU6IGZ1bmN0aW9uKCBldnQgKSB7CgkJdGhpcy5fc2V0V2lkZ2V0KCB0aGlzLmVsZW1lbnQuZGF0YSggIm1vYmlsZS0iICsgZXZ0LnR5cGUuc3Vic3RyaW5nKCAwLCBldnQudHlwZS5sZW5ndGggLSA2ICkgKSApOwoJfSwKCglfc2V0V2lkZ2V0OiBmdW5jdGlvbiggd2lkZ2V0ICkgewoJCWlmICggIXRoaXMuX3dpZGdldCAmJiB3aWRnZXQgKSB7CgkJCXRoaXMuX3dpZGdldCA9IHdpZGdldDsKCQkJdGhpcy5fd2lkZ2V0Ll9zZXRPcHRpb25zID0gcmVwbGFjZVNldE9wdGlvbnMoIHRoaXMsIHRoaXMuX3dpZGdldC5fc2V0T3B0aW9ucyApOwoJCX0KCgkJaWYgKCAhIXRoaXMuX3dpZGdldCApIHsKCQkJdGhpcy5fc3luY1RleHRJbnB1dE9wdGlvbnMoIHRoaXMuX3dpZGdldC5vcHRpb25zICk7CgkJfQoKCQlyZXR1cm4gISF0aGlzLl93aWRnZXQ7Cgl9LAoKCV9pc1NlYXJjaEludGVybmFsOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gKCB0aGlzLl9zZWFyY2ggJiYgdGhpcy5fc2VhcmNoLmpxbURhdGEoICJ1aS1maWx0ZXJhYmxlLSIgKyB0aGlzLnV1aWQgKyAiLWludGVybmFsIiApICk7Cgl9LAoKCV9zZXRJbnB1dDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXZhciBvcHRzID0gdGhpcy5vcHRpb25zLAoJCQl1cGRhdGVQbGFjZWhvbGRlciA9IHRydWUsCgkJCXRleHRpbnB1dE9wdHMgPSB7fTsKCgkJaWYgKCAhc2VsZWN0b3IgKSB7CgkJCWlmICggdGhpcy5faXNTZWFyY2hJbnRlcm5hbCgpICkgewoKCQkJCS8vIElnbm9yZSB0aGUgY2FsbCB0byBzZXQgYSBuZXcgaW5wdXQgaWYgdGhlIHNlbGVjdG9yIGdvZXMgdG8gZmFsc3kgYW5kCgkJCQkvLyB0aGUgY3VycmVudCB0ZXh0aW5wdXQgaXMgYWxyZWFkeSBvZiB0aGUgaW50ZXJuYWxseSBnZW5lcmF0ZWQgdmFyaWV0eS4KCQkJCXJldHVybjsKCQkJfSBlbHNlIHsKCgkJCQkvLyBHZW5lcmF0aW5nIGEgbmV3IHRleHRpbnB1dCB3aWRnZXQuIE5vIG5lZWQgdG8gc2V0IHRoZSBwbGFjZWhvbGRlcgoJCQkJLy8gZnVydGhlciBkb3duIHRoZSBmdW5jdGlvbi4KCQkJCXVwZGF0ZVBsYWNlaG9sZGVyID0gZmFsc2U7CgkJCQlzZWxlY3RvciA9ICQoICI8aW5wdXQgIiArCgkJCQkJImRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGU9J3NlYXJjaCcgIiArCgkJCQkJInBsYWNlaG9sZGVyPSciICsgb3B0cy5maWx0ZXJQbGFjZWhvbGRlciArICInPjwvaW5wdXQ+IiApCgkJCQkJLmpxbURhdGEoICJ1aS1maWx0ZXJhYmxlLSIgKyB0aGlzLnV1aWQgKyAiLWludGVybmFsIiwgdHJ1ZSApOwoJCQkJJCggIjxmb3JtIGNsYXNzPSd1aS1maWx0ZXJhYmxlJz48L2Zvcm0+IiApCgkJCQkJLmFwcGVuZCggc2VsZWN0b3IgKQoJCQkJCS5zdWJtaXQoIGZ1bmN0aW9uKCBldnQgKSB7CgkJCQkJCWV2dC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQlzZWxlY3Rvci5ibHVyKCk7CgkJCQkJfSkKCQkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLmVsZW1lbnQgKTsKCQkJCWlmICggJC5tb2JpbGUudGV4dGlucHV0ICkgewoJCQkJCWlmICggdGhpcy5vcHRpb25zLmZpbHRlclRoZW1lICE9IG51bGwgKSB7CgkJCQkJCXRleHRpbnB1dE9wdHNbICJ0aGVtZSIgXSA9IG9wdHMuZmlsdGVyVGhlbWU7CgkJCQkJfQoKCQkJCQlzZWxlY3Rvci50ZXh0aW5wdXQoIHRleHRpbnB1dE9wdHMgKTsKCQkJCX0KCQkJfQoJCX0KCgkJdGhpcy5fc3VwZXIoIHNlbGVjdG9yICk7CgoJCWlmICggdGhpcy5fc2VhcmNoICYmIHVwZGF0ZVBsYWNlaG9sZGVyICkgewoJCQl0aGlzLl9zZWFyY2guYXR0ciggInBsYWNlaG9sZGVyIiwgdGhpcy5vcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyICk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIHJldCA9IHRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCS8vIE5lZWQgdG8gc2V0IHRoZSBmaWx0ZXJQbGFjZWhvbGRlciBhZnRlciBoYXZpbmcgZXN0YWJsaXNoZWQgdGhlIHNlYXJjaCBpbnB1dAoJCWlmICggb3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlciAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoIHRoaXMuX3NlYXJjaCApIHsKCQkJCXRoaXMuX3NlYXJjaC5hdHRyKCAicGxhY2Vob2xkZXIiLCBvcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyICk7CgkJCX0KCQl9CgoJCWlmICggb3B0aW9ucy5maWx0ZXJUaGVtZSAhPT0gdW5kZWZpbmVkICYmIHRoaXMuX3NlYXJjaCAmJiAkLm1vYmlsZS50ZXh0aW5wdXQgKSB7CgkJCXRoaXMuX3NlYXJjaC50ZXh0aW5wdXQoICJvcHRpb24iLCAidGhlbWUiLCBvcHRpb25zLmZpbHRlclRoZW1lICk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLl9pc1NlYXJjaEludGVybmFsKCkgKSB7CgkJCXRoaXMuX3NlYXJjaC5yZW1vdmUoKTsKCQl9CgkJdGhpcy5fc3VwZXIoKTsKCX0sCgoJX3N5bmNUZXh0SW5wdXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaWR4LAoJCQl0ZXh0aW5wdXRPcHRpb25zID0ge307CgoJCS8vIFdlIG9ubHkgc3luYyBvcHRpb25zIGlmIHRoZSBmaWx0ZXJhYmxlJ3MgdGV4dGlucHV0IGlzIG9mIHRoZSBpbnRlcm5hbGx5CgkJLy8gZ2VuZXJhdGVkIHZhcmlldHksIHJhdGhlciB0aGFuIG9uZSBzcGVjaWZpZWQgYnkgdGhlIHVzZXIuCgkJaWYgKCB0aGlzLl9pc1NlYXJjaEludGVybmFsKCkgJiYgJC5tb2JpbGUudGV4dGlucHV0ICkgewoKCQkJLy8gQXBwbHkgb25seSB0aGUgb3B0aW9ucyB1bmRlcnN0b29kIGJ5IHRleHRpbnB1dAoJCQlmb3IgKCBpZHggaW4gJC5tb2JpbGUudGV4dGlucHV0LnByb3RvdHlwZS5vcHRpb25zICkgewoJCQkJaWYgKCBvcHRpb25zWyBpZHggXSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCWlmICggaWR4ID09PSAidGhlbWUiICYmIHRoaXMub3B0aW9ucy5maWx0ZXJUaGVtZSAhPSBudWxsICkgewoJCQkJCQl0ZXh0aW5wdXRPcHRpb25zWyBpZHggXSA9IHRoaXMub3B0aW9ucy5maWx0ZXJUaGVtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0ZXh0aW5wdXRPcHRpb25zWyBpZHggXSA9IG9wdGlvbnNbIGlkeCBdOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQl0aGlzLl9zZWFyY2gudGV4dGlucHV0KCAib3B0aW9uIiwgdGV4dGlucHV0T3B0aW9ucyApOwoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCmZ1bmN0aW9uIGRlZmF1bHRBdXRvZGl2aWRlcnNTZWxlY3RvciggZWx0ICkgewoJLy8gbG9vayBmb3IgdGhlIHRleHQgaW4gdGhlIGdpdmVuIGVsZW1lbnQKCXZhciB0ZXh0ID0gJC50cmltKCBlbHQudGV4dCgpICkgfHwgbnVsbDsKCglpZiAoICF0ZXh0ICkgewoJCXJldHVybiBudWxsOwoJfQoKCS8vIGNyZWF0ZSB0aGUgdGV4dCBmb3IgdGhlIGRpdmlkZXIgKGZpcnN0IHVwcGVyY2FzZWQgbGV0dGVyKQoJdGV4dCA9IHRleHQuc2xpY2UoIDAsIDEgKS50b1VwcGVyQ2FzZSgpOwoKCXJldHVybiB0ZXh0Owp9CgokLndpZGdldCggIm1vYmlsZS5saXN0dmlldyIsICQubW9iaWxlLmxpc3R2aWV3LCB7CglvcHRpb25zOiB7CgkJYXV0b2RpdmlkZXJzOiBmYWxzZSwKCQlhdXRvZGl2aWRlcnNTZWxlY3RvcjogZGVmYXVsdEF1dG9kaXZpZGVyc1NlbGVjdG9yCgl9LAoKCV9hZnRlckxpc3R2aWV3UmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIGVsID0gdGhpcy5lbGVtZW50OwoJCXRoaXMuX29mZiggZWwsICJsaXN0dmlld2FmdGVycmVmcmVzaCIgKTsKCQl0aGlzLl9yZXBsYWNlRGl2aWRlcnMoKTsKCQl0aGlzLnJlZnJlc2goKTsKCQl0aGlzLl9vbiggZWwsIHsgbGlzdHZpZXdhZnRlcnJlZnJlc2g6ICJfYWZ0ZXJMaXN0dmlld1JlZnJlc2giIH0gKTsKCX0sCgoJX3JlcGxhY2VEaXZpZGVyczogZnVuY3Rpb24oKSB7CgkJdmFyIGksIGxpcywgbGksIGRpdmlkZXJUZXh0LAoJCQlsYXN0RGl2aWRlclRleHQgPSBudWxsLAoJCQlsaXN0ID0gdGhpcy5lbGVtZW50LAoJCQlkaXZpZGVyOwoKCQlsaXN0LmZpbmQoICJsaTpqcW1EYXRhKHJvbGU9J2xpc3QtZGl2aWRlcicpIiApLnJlbW92ZSgpOwoKCQlsaXMgPSBsaXN0LmZpbmQoICJsaSIgKTsKCgkJZm9yICggaSA9IDA7IGkgPCBsaXMubGVuZ3RoIDsgaSsrICkgewoJCQlsaSA9IGxpc1sgaSBdOwoJCQlkaXZpZGVyVGV4dCA9IHRoaXMub3B0aW9ucy5hdXRvZGl2aWRlcnNTZWxlY3RvciggJCggbGkgKSApOwoKCQkJaWYgKCBkaXZpZGVyVGV4dCAmJiBsYXN0RGl2aWRlclRleHQgIT09IGRpdmlkZXJUZXh0ICkgewoJCQkJZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJsaSIgKTsKCQkJCWRpdmlkZXIuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBkaXZpZGVyVGV4dCApICk7CgkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGUiLCAibGlzdC1kaXZpZGVyIiApOwoJCQkJbGkucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoIGRpdmlkZXIsIGxpICk7CgkJCX0KCgkJCWxhc3REaXZpZGVyVGV4dCA9IGRpdmlkZXJUZXh0OwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCgkJaWYgKCAhdGhpcy5vcHRpb25zLmF1dG9kaXZpZGVycyApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fYWZ0ZXJMaXN0dmlld1JlZnJlc2goKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciByZGl2aWRlciA9IC8oXnxccyl1aS1saS1kaXZpZGVyKCR8XHMpLywKCXJoaWRkZW4gPSAvKF58XHMpdWktc2NyZWVuLWhpZGRlbigkfFxzKS87CgokLndpZGdldCggIm1vYmlsZS5saXN0dmlldyIsICQubW9iaWxlLmxpc3R2aWV3LCB7CglvcHRpb25zOiB7CgkJaGlkZWRpdmlkZXJzOiB0cnVlCgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBpdGVtcywgaWR4LCBpdGVtLCBoaWRlRGl2aWRlciA9IHRydWU7CgoJCXRoaXMuX3N1cGVyQXBwbHkoIGFyZ3VtZW50cyApOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5oaWRlZGl2aWRlcnMgKSB7CgkJCWl0ZW1zID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoIHRoaXMuZWxlbWVudFsgMCBdLCAibGkiLCAiTEkiICk7CgkJCWZvciAoIGlkeCA9IGl0ZW1zLmxlbmd0aCAtIDEgOyBpZHggPiAtMSA7IGlkeC0tICkgewoJCQkJaXRlbSA9IGl0ZW1zWyBpZHggXTsKCQkJCWlmICggaXRlbS5jbGFzc05hbWUubWF0Y2goIHJkaXZpZGVyICkgKSB7CgkJCQkJaWYgKCBoaWRlRGl2aWRlciApIHsKCQkJCQkJaXRlbS5jbGFzc05hbWUgPSBpdGVtLmNsYXNzTmFtZSArICIgdWktc2NyZWVuLWhpZGRlbiI7CgkJCQkJfQoJCQkJCWhpZGVEaXZpZGVyID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJaWYgKCAhaXRlbS5jbGFzc05hbWUubWF0Y2goIHJoaWRkZW4gKSApIHsKCQkJCQkJaGlkZURpdmlkZXIgPSBmYWxzZTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5ub2pzID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCSQoICI6anFtRGF0YShyb2xlPSdub2pzJykiLCB0YXJnZXQgKS5hZGRDbGFzcyggInVpLW5vanMiICk7Cn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgPSB7CglfaGFuZGxlRm9ybVJlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LmNsb3Nlc3QoICJmb3JtIiApLCB7CgkJCXJlc2V0OiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuX2RlbGF5KCAiX3Jlc2V0IiApOwoJCQl9CgkJfSk7Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CgovKgoqICJjaGVja2JveHJhZGlvIiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY2hlY2tib3hyYWRpbyIsICQuZXh0ZW5kKCB7CgoJaW5pdFNlbGVjdG9yOiAiaW5wdXQ6bm90KCA6anFtRGF0YShyb2xlPSdmbGlwc3dpdGNoJyApIClbdHlwZT0nY2hlY2tib3gnXSxpbnB1dFt0eXBlPSdyYWRpbyddOm5vdCggOmpxbURhdGEocm9sZT0nZmxpcHN3aXRjaCcgKSkiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogImluaGVyaXQiLAoJCW1pbmk6IGZhbHNlLAoJCXdyYXBwZXJDbGFzczogbnVsbCwKCQllbmhhbmNlZDogZmFsc2UsCgkJaWNvbnBvczogImxlZnQiCgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJaW5oZXJpdEF0dHIgPSBmdW5jdGlvbiggaW5wdXQsIGRhdGFBdHRyICkgewoJCQkJcmV0dXJuIGlucHV0LmpxbURhdGEoIGRhdGFBdHRyICkgfHwKCQkJCQlpbnB1dC5jbG9zZXN0KCAiZm9ybSwgZmllbGRzZXQiICkuanFtRGF0YSggZGF0YUF0dHIgKTsKCQkJfSwKCQkJLy8gTk9URTogV2luZG93cyBQaG9uZSBjb3VsZCBub3QgZmluZCB0aGUgbGFiZWwgdGhyb3VnaCBhIHNlbGVjdG9yCgkJCS8vIGZpbHRlciB3b3JrcyB0aG91Z2guCgkJCXBhcmVudExhYmVsID0gaW5wdXQuY2xvc2VzdCggImxhYmVsIiApLAoJCQlsYWJlbCA9IHBhcmVudExhYmVsLmxlbmd0aCA/IHBhcmVudExhYmVsIDoKCQkJCWlucHV0CgkJCQkJLmNsb3Nlc3QoICJmb3JtLCBmaWVsZHNldCwgOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKQoJCQkJCS5maW5kKCAibGFiZWwiICkKCQkJCQkuZmlsdGVyKCAiW2Zvcj0nIiArICQubW9iaWxlLnBhdGguaGFzaFRvU2VsZWN0b3IoIGlucHV0WzBdLmlkICkgKyAiJ10iICkKCQkJCQkuZmlyc3QoKSwKCQkJaW5wdXR0eXBlID0gaW5wdXRbMF0udHlwZSwKCQkJY2hlY2tlZFN0YXRlID0gaW5wdXR0eXBlICsgIi1vbiIsCgkJCXVuY2hlY2tlZFN0YXRlID0gaW5wdXR0eXBlICsgIi1vZmYiLAoJCQljaGVja2VkQ2xhc3MgPSAidWktIiArIGNoZWNrZWRTdGF0ZSwKCQkJdW5jaGVja2VkQ2xhc3MgPSAidWktIiArIHVuY2hlY2tlZFN0YXRlOwoKCQlpZiAoIGlucHV0dHlwZSAhPT0gImNoZWNrYm94IiAmJiBpbnB1dHR5cGUgIT09ICJyYWRpbyIgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggdGhpcy5lbGVtZW50WzBdLmRpc2FibGVkICl7CgkJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IHRydWU7CgkJfQoKCQlvLmljb25wb3MgPSBpbmhlcml0QXR0ciggaW5wdXQsICJpY29ucG9zIiApIHx8IGxhYmVsLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29ucG9zIiApIHx8IG8uaWNvbnBvcywKCgkJLy8gRXN0YWJsaXNoIG9wdGlvbnMKCQlvLm1pbmkgPSBpbmhlcml0QXR0ciggaW5wdXQsICJtaW5pIiApIHx8IG8ubWluaTsKCgkJLy8gRXhwb3NlIGZvciBvdGhlciBtZXRob2RzCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJaW5wdXQ6IGlucHV0LAoJCQlsYWJlbDogbGFiZWwsCgkJCXBhcmVudExhYmVsOiBwYXJlbnRMYWJlbCwKCQkJaW5wdXR0eXBlOiBpbnB1dHR5cGUsCgkJCWNoZWNrZWRDbGFzczogY2hlY2tlZENsYXNzLAoJCQl1bmNoZWNrZWRDbGFzczogdW5jaGVja2VkQ2xhc3MsCgkJCWNoZWNrZWRpY29uOiBjaGVja2VkU3RhdGUsCgkJCXVuY2hlY2tlZGljb246IHVuY2hlY2tlZFN0YXRlCgkJfSk7CgoJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgkJdGhpcy5fb24oIGxhYmVsLCB7CgkJCXZtb3VzZW92ZXI6ICJfaGFuZGxlTGFiZWxWTW91c2VPdmVyIiwKCQkJdmNsaWNrOiAiX2hhbmRsZUxhYmVsVkNsaWNrIgoJCX0pOwoKCQl0aGlzLl9vbiggaW5wdXQsIHsKCQkJdm1vdXNlZG93bjogIl9jYWNoZVZhbHMiLAoJCQl2Y2xpY2s6ICJfaGFuZGxlSW5wdXRWQ2xpY2siLAoJCQlmb2N1czogIl9oYW5kbGVJbnB1dEZvY3VzIiwKCQkJYmx1cjogIl9oYW5kbGVJbnB1dEJsdXIiCgkJfSk7CgoJCXRoaXMuX2hhbmRsZUZvcm1SZXNldCgpOwoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5sYWJlbC5hZGRDbGFzcyggInVpLWJ0biB1aS1jb3JuZXItYWxsIik7CgoJCWlmKCB0aGlzLnBhcmVudExhYmVsLmxlbmd0aCA+IDAgKXsKCQkJdGhpcy5pbnB1dC5hZGQoIHRoaXMubGFiZWwgKS53cmFwQWxsKCB0aGlzLl93cmFwcGVyKCkgKTsKCQl9IGVsc2UgewoJCQkvL3RoaXMuZWxlbWVudC5yZXBsYWNlV2l0aCggdGhpcy5pbnB1dC5hZGQoIHRoaXMubGFiZWwgKS53cmFwQWxsKCB0aGlzLl93cmFwcGVyKCkgKSApOwoJCQl0aGlzLmVsZW1lbnQud3JhcCggdGhpcy5fd3JhcHBlcigpICk7CgkJCXRoaXMuZWxlbWVudC5wYXJlbnQoKS5wcmVwZW5kKCB0aGlzLmxhYmVsICk7CgkJfQoJCQoJCS8vIFdyYXAgdGhlIGlucHV0ICsgbGFiZWwgaW4gYSBkaXYKCQkKCQl0aGlzLl9zZXRPcHRpb25zKHsKCQkJInRoZW1lIjogdGhpcy5vcHRpb25zLnRoZW1lLAoJCQkiaWNvbnBvcyI6IHRoaXMub3B0aW9ucy5pY29ucG9zLAoJCQkibWluaSI6IHRoaXMub3B0aW9ucy5taW5pCgkJfSk7CgoJfSwKCglfd3JhcHBlcjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2IGNsYXNzPSciICArICggdGhpcy5vcHRpb25zLndyYXBwZXJDbGFzcyA/IHRoaXMub3B0aW9ucy53cmFwcGVyQ2xhc3MgOiAiIiApICsgIiB1aS0iICsgdGhpcy5pbnB1dHR5cGUgKyAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCA/ICIgdWktZGlzYWJsZWQiIDogIiIgKSArICInID4iICk7Cgl9LAoKCV9oYW5kbGVJbnB1dEZvY3VzOiBmdW5jdGlvbigpIHsKCQl0aGlzLmxhYmVsLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7Cgl9LAoKCV9oYW5kbGVJbnB1dEJsdXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMubGFiZWwucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCX0sCgoJX2hhbmRsZUlucHV0VkNsaWNrOiBmdW5jdGlvbigpIHsKCQl2YXIgJHRoaXMgPSB0aGlzLmVsZW1lbnQ7CgoJCS8vIEFkZHMgY2hlY2tlZCBhdHRyaWJ1dGUgdG8gY2hlY2tlZCBpbnB1dCB3aGVuIGtleWJvYXJkIGlzIHVzZWQKCQlpZiAoICR0aGlzLmlzKCAiOmNoZWNrZWQiICkgKSB7CgoJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIHRydWUpOwoJCQl0aGlzLl9nZXRJbnB1dFNldCgpLm5vdCggJHRoaXMgKS5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJfSBlbHNlIHsKCQkJJHRoaXMucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCX0KCgkJdGhpcy5fdXBkYXRlQWxsKCk7Cgl9LAoKCV9oYW5kbGVMYWJlbFZNb3VzZU92ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIHRoaXMubGFiZWwucGFyZW50KCkuaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKSApIHsKCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJfQoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3NldE9wdGlvbnMoewoJCQkiZGlzYWJsZWQiOiBmYWxzZQoJCX0pOwoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXRPcHRpb25zKHsKCQkJImRpc2FibGVkIjogdHJ1ZQoJCX0pOwoJfSwKCglfaGFuZGxlTGFiZWxWQ2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgaW5wdXQgPSB0aGlzLmVsZW1lbnQ7CgoJCWlmICggaW5wdXQuaXMoICI6ZGlzYWJsZWQiICkgKSB7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX2NhY2hlVmFscygpOwoKCQlpbnB1dC5wcm9wKCAiY2hlY2tlZCIsIHRoaXMuaW5wdXR0eXBlID09PSAicmFkaW8iICYmIHRydWUgfHwgIWlucHV0LnByb3AoICJjaGVja2VkIiApICk7CgoJCS8vIHRyaWdnZXIgY2xpY2sgaGFuZGxlcidzIGJvdW5kIGRpcmVjdGx5IHRvIHRoZSBpbnB1dCBhcyBhIHN1YnN0aXR1dGUgZm9yCgkJLy8gaG93IGxhYmVsIGNsaWNrcyBiZWhhdmUgbm9ybWFsbHkgaW4gdGhlIGJyb3dzZXJzCgkJLy8gVE9ETzogaXQgd291bGQgYmUgbmljZSB0byBsZXQgdGhlIGJyb3dzZXIncyBoYW5kbGUgdGhlIGNsaWNrcyBhbmQgcGFzcyB0aGVtCgkJLy8gICAgICAgdGhyb3VnaCB0byB0aGUgYXNzb2NpYXRlIGlucHV0LiB3ZSBjYW4gc3dhbGxvdyB0aGF0IGNsaWNrIGF0IHRoZSBwYXJlbnQKCQkvLyAgICAgICB3cmFwcGVyIGVsZW1lbnQgbGV2ZWwKCQlpbnB1dC50cmlnZ2VySGFuZGxlciggImNsaWNrIiApOwoKCQkvLyBJbnB1dCBzZXQgZm9yIGNvbW1vbiByYWRpbyBidXR0b25zIHdpbGwgY29udGFpbiBhbGwgdGhlIHJhZGlvCgkJLy8gYnV0dG9ucywgYnV0IHdpbGwgbm90IGZvciBjaGVja2JveGVzLiBjbGVhcmluZyB0aGUgY2hlY2tlZCBzdGF0dXMKCQkvLyBvZiBvdGhlciByYWRpb3MgZW5zdXJlcyB0aGUgYWN0aXZlIGJ1dHRvbiBzdGF0ZSBpcyBhcHBsaWVkIHByb3Blcmx5CgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5ub3QoIGlucHV0ICkucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoKCQl0aGlzLl91cGRhdGVBbGwoKTsKCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCV9jYWNoZVZhbHM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2dldElucHV0U2V0KCkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5hdHRyKCJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJjYWNoZVZhbCIsIHRoaXMuY2hlY2tlZCApOwoJCX0pOwoJfSwKCgkvL3JldHVybnMgZWl0aGVyIGEgc2V0IG9mIHJhZGlvcyB3aXRoIHRoZSBzYW1lIG5hbWUgYXR0cmlidXRlLCBvciBhIHNpbmdsZSBjaGVja2JveAoJX2dldElucHV0U2V0OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuaW5wdXR0eXBlID09PSAiY2hlY2tib3giICkgewoJCQlyZXR1cm4gdGhpcy5lbGVtZW50OwoJCX0KCgkJcmV0dXJuIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSwgOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKQoJCQkuZmluZCggImlucHV0W25hbWU9JyIgKyB0aGlzLmVsZW1lbnRbIDAgXS5uYW1lICsgIiddW3R5cGU9JyIgKyB0aGlzLmlucHV0dHlwZSArICInXSIgKTsKCX0sCgoJX3VwZGF0ZUFsbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQlpZiAoIHRoaXMuY2hlY2tlZCB8fCBzZWxmLmlucHV0dHlwZSA9PT0gImNoZWNrYm94IiApIHsKCQkJCSR0aGlzLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCX0KCQl9KQoJCS5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCX0sCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIGlucHV0ID0gdGhpcy5lbGVtZW50WyAwIF0sCgkJCWFjdGl2ZSA9ICIgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzLAoJCQloYXNJY29uID0gKCB0aGlzLmVsZW1lbnQucGFyZW50cyggIi51aS1jb250cm9sZ3JvdXAtaG9yaXpvbnRhbCIgKS5sZW5ndGggPT09IDAgKSwKCQkJY2hlY2tlZENsYXNzID0gdGhpcy5jaGVja2VkQ2xhc3MgKyAoIGhhc0ljb24gPyAiIiA6IGFjdGl2ZSApLAoJCQlsYWJlbCA9IHRoaXMubGFiZWw7CgoJCWxhYmVsCgkJCS50b2dnbGVDbGFzcyggInVpLWljb24tIiArIHRoaXMuY2hlY2tlZGljb24sIGlucHV0LmNoZWNrZWQgKQoJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLSIgKyB0aGlzLnVuY2hlY2tlZGljb24sICFpbnB1dC5jaGVja2VkICk7CgkJaWYgKCBpbnB1dC5jaGVja2VkICkgewoJCQlsYWJlbC5yZW1vdmVDbGFzcyggdGhpcy51bmNoZWNrZWRDbGFzcyArIGFjdGl2ZSApLmFkZENsYXNzKCBjaGVja2VkQ2xhc3MgKTsKCQl9IGVsc2UgewoJCQlsYWJlbC5yZW1vdmVDbGFzcyggY2hlY2tlZENsYXNzICkuYWRkQ2xhc3MoIHRoaXMudW5jaGVja2VkQ2xhc3MgKTsKCQl9Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMubGFiZWwucGFyZW50KCk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5pbnB1dC5wcm9wKCAiZGlzYWJsZWQiLCAhIW9wdGlvbnMuZGlzYWJsZWQgKTsKCQkJdGhpcy53aWRnZXQoKS50b2dnbGVDbGFzcyggInVpLWRpc2FibGVkIiwgISFvcHRpb25zLmRpc2FibGVkICk7CgkJfQoJCWlmICggb3B0aW9ucy5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMubGFiZWwucGFyZW50KCkudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgISFvcHRpb25zLm1pbmkgKTsKCQl9CgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMubGFiZWwucmVtb3ZlQ2xhc3MoICJ1aS1idG4tIiArIHRoaXMub3B0aW9ucy50aGVtZSApLmFkZENsYXNzKCAidWktYnRuLSIgKyBvcHRpb25zLnRoZW1lICk7CgkJfQoJCWlmICggb3B0aW9ucy53cmFwcGVyQ2xhc3MgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy53aWRnZXQoKS5yZW1vdmVDbGFzcyggdGhpcy5vcHRpb25zLndyYXBwZXJDbGFzcyApLmFkZENsYXNzKCBvcHRpb25zLndyYXBwZXJDbGFzcyApOwoJCX0KCQlpZiAoIG9wdGlvbnMuaWNvbnBvcyAhPT0gdW5kZWZpbmVkICYmICggdGhpcy5lbGVtZW50LnBhcmVudHMoICJbZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZT0naG9yaXpvbnRhbCddIiApLmxlbmd0aCA9PT0gMCApICkgewoJCQl0aGlzLmxhYmVsLnJlbW92ZUNsYXNzKCAidWktYnRuLWljb24tIiArIHRoaXMub3B0aW9ucy5pY29ucG9zICkuYWRkQ2xhc3MoICJ1aS1idG4taWNvbi0iICsgb3B0aW9ucy5pY29ucG9zICk7CgkJfSBlbHNlIGlmICggdGhpcy5lbGVtZW50LnBhcmVudHMoICJbZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZT0naG9yaXpvbnRhbCddIiApLmxlbmd0aCAhPT0gMCApewoJCQl0aGlzLmxhYmVsLnJlbW92ZUNsYXNzKCAidWktYnRuLWljb24tIiArIHRoaXMub3B0aW9ucy5pY29ucG9zICk7CgkJfQoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9Cgp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ICkgKTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuYnV0dG9uIiwgewoKCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J2J1dHRvbiddLCBpbnB1dFt0eXBlPSdzdWJtaXQnXSwgaW5wdXRbdHlwZT0ncmVzZXQnXSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWljb246IG51bGwsCgkJaWNvbnBvczogImxlZnQiLAoJCWljb25zaGFkb3c6IGZhbHNlLCAvKiBUT0RPOiBEZXByZWNhdGVkIGluIDEuNCwgcmVtb3ZlIGluIDEuNS4gKi8KCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpbmxpbmU6IG51bGwsCgkJbWluaTogbnVsbCwKCQl3cmFwcGVyQ2xhc3M6IG51bGwsCgkJZW5oYW5jZWQ6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQlpZiAoIHRoaXMuZWxlbWVudC5pcyggIjpkaXNhYmxlZCIgKSApIHsKCQkJdGhpcy5vcHRpb25zLmRpc2FibGVkID0gdHJ1ZTsKCQl9CgoJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJd3JhcHBlcjogdGhpcy5lbGVtZW50LnBhcmVudCgpCgkJfSk7CgoJCXRoaXMuX29uKCB7CgkJCWZvY3VzOiBmdW5jdGlvbigpIHsKCQkJCXRoaXMud2lkZ2V0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSwKCgkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy53aWRnZXQoKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9CgkJfSk7CgkJCgkJdGhpcy5yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQud3JhcCggdGhpcy5fYnV0dG9uKCkgKTsKCX0sCgoJX2J1dHRvbjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoIjxkaXYgY2xhc3M9J3VpLWJ0biB1aS1pbnB1dC1idG4iICsKCQkJKCB0aGlzLm9wdGlvbnMud3JhcHBlckNsYXNzID8gIiAiICsgdGhpcy5vcHRpb25zLndyYXBwZXJDbGFzcyA6ICIiICkgKwoJCQkoIHRoaXMub3B0aW9ucy50aGVtZSA/ICIgdWktYnRuLSIgKyB0aGlzLm9wdGlvbnMudGhlbWUgOiAiIiApICsKCQkJKCB0aGlzLm9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiApICsKCQkJKCB0aGlzLm9wdGlvbnMuc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiIgKSArCgkJCSggdGhpcy5vcHRpb25zLmlubGluZSA/ICIgdWktYnRuLWlubGluZSIgOiAiIiApICsKCQkJKCB0aGlzLm9wdGlvbnMubWluaSA/ICIgdWktbWluaSIgOiAiIiApICsKCQkJKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgPyAiIHVpLWRpc2FibGVkIiA6ICIiICkgKwoJCQkoICggdGhpcy5vcHRpb25zLmljb25wb3MgJiYgdGhpcy5vcHRpb25zLmljb24gKSA/ICIgdWktYnRuLWljb24tIiArIHRoaXMub3B0aW9ucy5pY29ucG9zIDogKCB0aGlzLm9wdGlvbnMuaWNvbiA/ICIgdWktYnRuLWljb24tbGVmdCIgOiAiIiApICkgKwoJCQkoIHRoaXMub3B0aW9ucy5pY29uID8gIiB1aS1pY29uLSIgKyB0aGlzLm9wdGlvbnMuaWNvbiA6ICIiICkgKwoJCQkiJyA+IiArIHRoaXMuZWxlbWVudC52YWwoKSArICI8L2Rpdj4iKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy53cmFwcGVyOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5pbnNlcnRCZWZvcmUoIHRoaXMuYnV0dG9uICk7CgkJCXRoaXMuYnV0dG9uLnJlbW92ZSgpOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMud2lkZ2V0KCkucmVtb3ZlQ2xhc3MoIHRoaXMub3B0aW9ucy50aGVtZSApLmFkZENsYXNzKCAidWktYnRuLSIgKyBvcHRpb25zLnRoZW1lICk7CgkJfQoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMud2lkZ2V0KCkudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoJCWlmICggb3B0aW9ucy5zaGFkb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy53aWRnZXQoKS50b2dnbGVDbGFzcyggInVpLXNoYWRvdyIsIG9wdGlvbnMuc2hhZG93ICk7CgkJfQoJCWlmICggb3B0aW9ucy5pbmxpbmUgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy53aWRnZXQoKS50b2dnbGVDbGFzcyggInVpLWJ0bi1pbmxpbmUiLCBvcHRpb25zLmlubGluZSApOwoJCX0KCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLndpZGdldCgpLnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIG9wdGlvbnMubWluaSApOwoJCX0KCQlpZiAoIG9wdGlvbnMuaWNvbnBvcyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLndpZGdldCgpLnJlbW92ZUNsYXNzKCAidWktYnRuLWljb24tIiArIG9wdGlvbnMuaWNvbnBvcyApOwoJCX0KCQlpZiAoIG9wdGlvbnMuaWNvbiAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoICF0aGlzLm9wdGlvbnMuaWNvbnBvcyAmJiAhb3B0aW9ucy5pY29ucG9zICkgewoJCQkJdGhpcy53aWRnZXQudG9nZ2xlQ2xhc3MoICJ1aS1idG4taWNvbi1sZWZ0Iiwgb3B0aW9ucy5pY29uICk7CgkJCX0KCQkJdGhpcy53aWRnZXQoKS5yZW1vdmVDbGFzcyggInVpLWljb24tIiArIHRoaXMub3B0aW9ucy5pY29uICkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLSIgKyBvcHRpb25zLmljb24sIG9wdGlvbnMuaWNvbiApOwoJCX0KCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5pY29uICYmIHRoaXMub3B0aW9ucy5pY29ucG9zID09PSAibm90ZXh0IiAmJiB0aGlzLmVsZW1lbnQuYXR0ciggInRpdGxlIiApICkgewoJCQl0aGlzLmVsZW1lbnQuYXR0ciggInRpdGxlIiwgdGhpcy5lbGVtZW50LnZhbCgpICk7CgkJfQoJCWlmICggIWNyZWF0ZSApIHsKCQkJdmFyIG9yaWdpbmFsRWxlbWVudCA9IHRoaXMuZWxlbWVudC5kZXRhY2goKTsKCQkJJCggdGhpcy53cmFwcGVyICkudGV4dCggdGhpcy5lbGVtZW50LnZhbCgpICkuYXBwZW5kKCBvcmlnaW5hbEVsZW1lbnQgKTsKCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkICkgewoJdmFyCW1ldGEgPSAkKCAibWV0YVtuYW1lPXZpZXdwb3J0XSIgKSwKCQlpbml0aWFsQ29udGVudCA9IG1ldGEuYXR0ciggImNvbnRlbnQiICksCgkJZGlzYWJsZWRab29tID0gaW5pdGlhbENvbnRlbnQgKyAiLG1heGltdW0tc2NhbGU9MSwgdXNlci1zY2FsYWJsZT1ubyIsCgkJZW5hYmxlZFpvb20gPSBpbml0aWFsQ29udGVudCArICIsbWF4aW11bS1zY2FsZT0xMCwgdXNlci1zY2FsYWJsZT15ZXMiLAoJCWRpc2FibGVkSW5pdGlhbGx5ID0gLyh1c2VyLXNjYWxhYmxlW1xzXSo9W1xzXSpubyl8KG1heGltdW0tc2NhbGVbXHNdKj1bXHNdKjEpWyQsXHNdLy50ZXN0KCBpbml0aWFsQ29udGVudCApOwoKCSQubW9iaWxlLnpvb20gPSAkLmV4dGVuZCgge30sIHsKCQllbmFibGVkOiAhZGlzYWJsZWRJbml0aWFsbHksCgkJbG9ja2VkOiBmYWxzZSwKCQlkaXNhYmxlOiBmdW5jdGlvbiggbG9jayApIHsKCQkJaWYgKCAhZGlzYWJsZWRJbml0aWFsbHkgJiYgISQubW9iaWxlLnpvb20ubG9ja2VkICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGRpc2FibGVkWm9vbSApOwoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gZmFsc2U7CgkJCQkkLm1vYmlsZS56b29tLmxvY2tlZCA9IGxvY2sgfHwgZmFsc2U7CgkJCX0KCQl9LAoJCWVuYWJsZTogZnVuY3Rpb24oIHVubG9jayApIHsKCQkJaWYgKCAhZGlzYWJsZWRJbml0aWFsbHkgJiYgKCAhJC5tb2JpbGUuem9vbS5sb2NrZWQgfHwgdW5sb2NrID09PSB0cnVlICkgKSB7CgkJCQltZXRhLmF0dHIoICJjb250ZW50IiwgZW5hYmxlZFpvb20gKTsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IHRydWU7CgkJCQkkLm1vYmlsZS56b29tLmxvY2tlZCA9IGZhbHNlOwoJCQl9CgkJfSwKCQlyZXN0b3JlOiBmdW5jdGlvbigpIHsKCQkJaWYgKCAhZGlzYWJsZWRJbml0aWFsbHkgKSB7CgkJCQltZXRhLmF0dHIoICJjb250ZW50IiwgaW5pdGlhbENvbnRlbnQgKTsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IHRydWU7CgkJCX0KCQl9Cgl9KTsKCn0oIGpRdWVyeSApKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUudGV4dGlucHV0IiwgewoJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ndGV4dCddLCBpbnB1dFt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJyksIGlucHV0W3R5cGU9J251bWJlciddLCA6anFtRGF0YSh0eXBlPSdudW1iZXInKSwgaW5wdXRbdHlwZT0ncGFzc3dvcmQnXSwgaW5wdXRbdHlwZT0nZW1haWwnXSwgaW5wdXRbdHlwZT0ndXJsJ10sIGlucHV0W3R5cGU9J3RlbCddLCB0ZXh0YXJlYSwgaW5wdXRbdHlwZT0ndGltZSddLCBpbnB1dFt0eXBlPSdkYXRlJ10sIGlucHV0W3R5cGU9J21vbnRoJ10sIGlucHV0W3R5cGU9J3dlZWsnXSwgaW5wdXRbdHlwZT0nZGF0ZXRpbWUnXSwgaW5wdXRbdHlwZT0nZGF0ZXRpbWUtbG9jYWwnXSwgaW5wdXRbdHlwZT0nY29sb3InXSwgaW5wdXQ6bm90KFt0eXBlXSksIGlucHV0W3R5cGU9J2ZpbGUnXSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWNvcm5lcnM6IHRydWUsCgkJbWluaTogZmFsc2UsCgkJLy8gVGhpcyBvcHRpb24gZGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MgZGV2aWNlcy4KCQlwcmV2ZW50Rm9jdXNab29tOiAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSwKCQl3cmFwcGVyQ2xhc3M6ICIiLAoJCWVuaGFuY2VkOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyIG8gPSB0aGlzLm9wdGlvbnMsCgkJCWlzU2VhcmNoID0gdGhpcy5lbGVtZW50LmlzKCAiW3R5cGU9J3NlYXJjaCddLCA6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSIgKSwKCQkJaXNUZXh0YXJlYSA9IHRoaXMuZWxlbWVudFsgMCBdLnRhZ05hbWUgPT09ICJURVhUQVJFQSIsCgkJCWlucHV0TmVlZHNXcmFwID0gKCh0aGlzLmVsZW1lbnQuaXMoICJpbnB1dCIgKSB8fCB0aGlzLmVsZW1lbnQuaXMoICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInR5cGU9J3NlYXJjaCddIiApICkgJiYgIXRoaXMuZWxlbWVudC5pcyggIltkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAidHlwZT0ncmFuZ2UnXSIgKSk7CgkJCQoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCXRoZW1lY2xhc3M6ICJ1aS1ib2R5LSIgKyAoICggby50aGVtZSA9PT0gbnVsbCApID8gImluaGVyaXQiIDogby50aGVtZSApLAoJCQlpc1NlYXJjaDogaXNTZWFyY2gsCgkJCWlzVGV4dGFyZWE6IGlzVGV4dGFyZWEsCgkJCWlucHV0TmVlZHNXcmFwOiBpbnB1dE5lZWRzV3JhcAoJCX0pOwoKCQl0aGlzLl9hdXRvQ29ycmVjdCgpOwoKCQlpZiAoIHRoaXMuZWxlbWVudFsgMCBdLmRpc2FibGVkICkgewoJCQl0aGlzLm9wdGlvbnMuZGlzYWJsZWQgPSB0cnVlOwoJCX0KCgkJaWYgKCAhby5lbmhhbmNlZCApIHsKCQkJdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgkJdGhpcy5fb24oIHsKCQkJImZvY3VzIjogIl9oYW5kbGVGb2N1cyIsCgkJCSJibHVyIjogIl9oYW5kbGVCbHVyIgoJCX0pOwoKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5zZXRPcHRpb25zKHsKCQkJImRpc2FibGVkIiA6IHRoaXMuZWxlbWVudC5pcyggIjpkaXNhYmxlZCIgKQoJCX0pOwoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24oKSB7CgoJCWlmICggdGhpcy5pc1RleHRhcmVhICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1pbnB1dC10ZXh0IiApOwoJCX0KCgkJaWYgKCB0aGlzLmVsZW1lbnQuaXMoICJ0ZXh0YXJlYSwgW2RhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJ0eXBlPSdyYW5nZSddIiApICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1zaGFkb3ctaW5zZXQiICk7CgkJCXRoaXMuX3NldE9wdGlvbnMoIHRoaXMub3B0aW9ucyApOwoJCX0KCgkJLy8ic2VhcmNoIiBhbmQgInRleHQiIGlucHV0IHdpZGdldHMKCQlpZiAoIHRoaXMuaW5wdXROZWVkc1dyYXAgKSB7CgkJCXRoaXMuZWxlbWVudC53cmFwKCB0aGlzLl93cmFwKCkgKTsKCQl9CgoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAoIHRoaXMuaW5wdXROZWVkc1dyYXAgKSA/IHRoaXMuZWxlbWVudC5wYXJlbnQoKSA6IHRoaXMuZWxlbWVudDsKCX0sCgoJX3dyYXA6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRzID0gdGhpcy5vcHRpb25zOwoKCQlyZXR1cm4gJCggIjxkaXYgY2xhc3M9JyIgKwoJCQkoIHRoaXMuaXNTZWFyY2ggPyAidWktaW5wdXQtc2VhcmNoICIgOiAidWktaW5wdXQtdGV4dCAiICkgKwoJCQkidWktYm9keS0iICsgKCAoIG9wdHMudGhlbWUgPT09IG51bGwgKSA/ICJpbmhlcml0IiA6IG9wdHMudGhlbWUgKSArICIgIiArCgkJCSggb3B0cy5jb3JuZXJzID8gInVpLWNvcm5lci1hbGwgIiA6ICIiICkgKwoJCQkoIG9wdHMubWluaSA/ICJ1aS1taW5pICIgOiAiIiApICsKCQkJKCBvcHRzLmRpc2FibGVkID8gInVpLXN0YXRlLWRpc2FibGVkICIgOiAiIiApICsKCQkJKCBvcHRzLndyYXBwZXJDbGFzcyAhPT0gIiIgPyBvcHRzLndyYXBwZXJDbGFzcyArICIgIiA6ICIiICkgKwoJCQkidWktc2hhZG93LWluc2V0Jz48L2Rpdj4iICk7Cgl9LAoKCV9hdXRvQ29ycmVjdDogZnVuY3Rpb24oKSB7CgkJLy8gWFhYOiBUZW1wb3Jhcnkgd29ya2Fyb3VuZCBmb3IgaXNzdWUgNzg1IChBcHBsZSBidWcgODkxMDU4OSkuCgkJLy8gICAgICBUdXJuIG9mZiBhdXRvY29ycmVjdCBhbmQgYXV0b2NvbXBsZXRlIG9uIG5vbi1pT1MgNSBkZXZpY2VzCgkJLy8gICAgICBzaW5jZSB0aGUgcG9wdXAgdGhleSB1c2UgY2FuJ3QgYmUgZGlzbWlzc2VkIGJ5IHRoZSB1c2VyLiBOb3RlCgkJLy8gICAgICB0aGF0IHdlIHRlc3QgZm9yIHRoZSBwcmVzZW5jZSBvZiB0aGUgZmVhdHVyZSBieSBsb29raW5nIGZvcgoJCS8vICAgICAgdGhlIGF1dG9jb3JyZWN0IHByb3BlcnR5IG9uIHRoZSBpbnB1dCBlbGVtZW50LiBXZSBjdXJyZW50bHkKCQkvLyAgICAgIGhhdmUgbm8gdGVzdCBmb3IgaU9TIDUgb3IgbmV3ZXIgc28gd2UncmUgdGVtcG9yYXJpbHkgdXNpbmcKCQkvLyAgICAgIHRoZSB0b3VjaE92ZXJmbG93IHN1cHBvcnQgZmxhZyBmb3IgalFNIDEuMC4gWWVzLCBJIGZlZWwgZGlydHkuIC0gamJsYXMKCQlpZiAoIHR5cGVvZiB0aGlzLmVsZW1lbnRbMF0uYXV0b2NvcnJlY3QgIT09ICJ1bmRlZmluZWQiICYmICEkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyApIHsKCQkJLy8gU2V0IHRoZSBhdHRyaWJ1dGUgaW5zdGVhZCBvZiB0aGUgcHJvcGVydHkganVzdCBpbiBjYXNlIHRoZXJlCgkJCS8vIGlzIGNvZGUgdGhhdCBhdHRlbXB0cyB0byBtYWtlIG1vZGlmaWNhdGlvbnMgdmlhIEhUTUwuCgkJCXRoaXMuZWxlbWVudFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29ycmVjdCIsICJvZmYiICk7CgkJCXRoaXMuZWxlbWVudFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29tcGxldGUiLCAib2ZmIiApOwoJCX0KCX0sCgoJX2hhbmRsZUJsdXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCWlmICggdGhpcy5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJfQoJfSwKCglfaGFuZGxlRm9jdXM6IGZ1bmN0aW9uKCkgewoJCS8vIEluIG1hbnkgc2l0dWF0aW9ucywgaU9TIHdpbGwgem9vbSBpbnRvIHRoZSBpbnB1dCB1cG9uIHRhcCwgdGhpcyBwcmV2ZW50cyB0aGF0IGZyb20gaGFwcGVuaW5nCgkJaWYgKCB0aGlzLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJfQoJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24gKCBvcHRpb25zICkgewoJCXZhciB0aGVtZWNsYXNzLAoJCQlvdXRlciA9IHRoaXMud2lkZ2V0KCk7CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGVtZWNsYXNzID0gInVpLWJvZHktIiArICggKCBvcHRpb25zLnRoZW1lID09PSBudWxsICkgPyAiaW5oZXJpdCIgOiBvcHRpb25zLnRoZW1lICk7CgkJCW91dGVyLnJlbW92ZUNsYXNzKCB0aGlzLnRoZW1lY2xhc3MgKS5hZGRDbGFzcyggdGhlbWVjbGFzcyApOwoJCQl0aGlzLnRoZW1lY2xhc3MgPSB0aGVtZWNsYXNzOwoJCX0KCgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJb3V0ZXIudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLW1pbmkiLCBvcHRpb25zLm1pbmkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgISFvcHRpb25zLmRpc2FibGVkICk7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktZGlzYWJsZWQiLCAhIW9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoIHRoaXMuaW5wdXROZWVkc1dyYXAgKSB7CgkJCXRoaXMuZWxlbWVudC51bndyYXAoKTsKCQl9CgkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktaW5wdXQtdGV4dCAiICsgdGhpcy50aGVtZWNsYXNzICsgIiB1aS1jb3JuZXItYWxsIHVpLW1pbmkgdWktZGlzYWJsZWQiICk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5zbGlkZXIiLCAkLmV4dGVuZCggewoJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ncmFuZ2UnXSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSwgOmpxbURhdGEocm9sZT0nc2xpZGVyJykiLAoKCXdpZGdldEV2ZW50UHJlZml4OiAic2xpZGUiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQl0cmFja1RoZW1lOiBudWxsLAoJCWNvcm5lcnM6IHRydWUsCgkJbWluaTogZmFsc2UsCgkJaGlnaGxpZ2h0OiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJLy8gVE9ETzogRWFjaCBvZiB0aGVzZSBzaG91bGQgaGF2ZSBjb21tZW50cyBleHBsYWluIHdoYXQgdGhleSdyZSBmb3IKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWNvbnRyb2wgPSB0aGlzLmVsZW1lbnQsCgkJCXRyYWNrVGhlbWUgPSB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSB8fCAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIGNvbnRyb2xbIDAgXSwgInRoZW1lIiApLAoJCQl0cmFja1RoZW1lQ2xhc3MgPSB0cmFja1RoZW1lID8gIiB1aS1iYXItIiArIHRyYWNrVGhlbWUgOiAiIHVpLWJhci1pbmhlcml0IiwKCQkJY29ybmVyQ2xhc3MgPSAoIHRoaXMub3B0aW9ucy5jb3JuZXJzIHx8IGNvbnRyb2wuanFtRGF0YSggImNvcm5lcnMiICkgKSA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiwKCQkJbWluaUNsYXNzID0gKCB0aGlzLm9wdGlvbnMubWluaSB8fCBjb250cm9sLmpxbURhdGEoICJtaW5pIiApICkgPyAiIHVpLW1pbmkiIDogIiIsCgkJCWNUeXBlID0gY29udHJvbFsgMCBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCWlzVG9nZ2xlU3dpdGNoID0gKCBjVHlwZSA9PT0gInNlbGVjdCIgKSwKCQkJaXNSYW5nZXNsaWRlciA9IGNvbnRyb2wucGFyZW50KCkuaXMoICI6anFtRGF0YShyb2xlPSdyYW5nZXNsaWRlcicpIiApLAoJCQlzZWxlY3RDbGFzcyA9ICggaXNUb2dnbGVTd2l0Y2ggKSA/ICJ1aS1zbGlkZXItc3dpdGNoIiA6ICIiLAoJCQljb250cm9sSUQgPSBjb250cm9sLmF0dHIoICJpZCIgKSwKCQkJJGxhYmVsID0gJCggIltmb3I9JyIgKyBjb250cm9sSUQgKyAiJ10iICksCgkJCWxhYmVsSUQgPSAkbGFiZWwuYXR0ciggImlkIiApIHx8IGNvbnRyb2xJRCArICItbGFiZWwiLAoJCQltaW4gPSAhaXNUb2dnbGVTd2l0Y2ggPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDAsCgkJCW1heCA9ICAhaXNUb2dnbGVTd2l0Y2ggPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5sZW5ndGgtMSwKCQkJc3RlcCA9IHdpbmRvdy5wYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApIHx8IDEgKSwKCQkJZG9tSGFuZGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICksCgkJCWhhbmRsZSA9ICQoIGRvbUhhbmRsZSApLAoJCQlkb21TbGlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCQlzbGlkZXIgPSAkKCBkb21TbGlkZXIgKSwKCQkJdmFsdWViZyA9IHRoaXMub3B0aW9ucy5oaWdobGlnaHQgJiYgIWlzVG9nZ2xlU3dpdGNoID8gKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGJnID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJCWJnLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItYmcgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzOwoJCQkJcmV0dXJuICQoIGJnICkucHJlcGVuZFRvKCBzbGlkZXIgKTsKCQkJfSkoKSA6IGZhbHNlLAoJCQlvcHRpb25zLAoJCQl3cmFwcGVyLAoJCQlqLCBsZW5ndGgsCgkJCWksIG9wdGlvbnNDb3VudCwgb3JpZ1RhYkluZGV4LAoJCQlzaWRlLCBhY3RpdmVDbGFzcywgc2xpZGVySW1nOwoKCQkkbGFiZWwuYXR0ciggImlkIiwgbGFiZWxJRCApOwoJCXRoaXMuaXNUb2dnbGVTd2l0Y2ggPSBpc1RvZ2dsZVN3aXRjaDsKCgkJZG9tSGFuZGxlLnNldEF0dHJpYnV0ZSggImhyZWYiLCAiIyIgKTsKCQlkb21TbGlkZXIuc2V0QXR0cmlidXRlKCAicm9sZSIsICJhcHBsaWNhdGlvbiIgKTsKCQlkb21TbGlkZXIuY2xhc3NOYW1lID0gWyB0aGlzLmlzVG9nZ2xlU3dpdGNoID8gInVpLXNsaWRlciB1aS1zbGlkZXItdHJhY2sgdWktc2hhZG93LWluc2V0ICIgOiAidWktc2xpZGVyLXRyYWNrIHVpLXNoYWRvdy1pbnNldCAiLCBzZWxlY3RDbGFzcywgdHJhY2tUaGVtZUNsYXNzLCBjb3JuZXJDbGFzcywgbWluaUNsYXNzIF0uam9pbiggIiIgKTsKCQlkb21IYW5kbGUuY2xhc3NOYW1lID0gInVpLXNsaWRlci1oYW5kbGUiOwoJCWRvbVNsaWRlci5hcHBlbmRDaGlsZCggZG9tSGFuZGxlICk7CgoJCWhhbmRsZS5hdHRyKHsKCQkJInJvbGUiOiAic2xpZGVyIiwKCQkJImFyaWEtdmFsdWVtaW4iOiBtaW4sCgkJCSJhcmlhLXZhbHVlbWF4IjogbWF4LAoJCQkiYXJpYS12YWx1ZW5vdyI6IHRoaXMuX3ZhbHVlKCksCgkJCSJhcmlhLXZhbHVldGV4dCI6IHRoaXMuX3ZhbHVlKCksCgkJCSJ0aXRsZSI6IHRoaXMuX3ZhbHVlKCksCgkJCSJhcmlhLWxhYmVsbGVkYnkiOiBsYWJlbElECgkJfSk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCXNsaWRlcjogc2xpZGVyLAoJCQloYW5kbGU6IGhhbmRsZSwKCQkJY29udHJvbDogY29udHJvbCwKCQkJdHlwZTogY1R5cGUsCgkJCXN0ZXA6IHN0ZXAsCgkJCW1heDogbWF4LAoJCQltaW46IG1pbiwKCQkJdmFsdWViZzogdmFsdWViZywKCQkJaXNSYW5nZXNsaWRlcjogaXNSYW5nZXNsaWRlciwKCQkJZHJhZ2dpbmc6IGZhbHNlLAoJCQliZWZvcmVTdGFydDogbnVsbCwKCQkJdXNlck1vZGlmaWVkOiBmYWxzZSwKCQkJbW91c2VNb3ZlZDogZmFsc2UKCQl9KTsKCgkJaWYgKCBpc1RvZ2dsZVN3aXRjaCApIHsKCQkJLy8gVE9ETzogcmVzdG9yZSBvcmlnaW5hbCB0YWJpbmRleCAoaWYgYW55KSBpbiBhIGRlc3Ryb3kgbWV0aG9kCgkJCW9yaWdUYWJJbmRleCA9IGNvbnRyb2wuYXR0ciggInRhYmluZGV4IiApOwoJCQlpZiAoIG9yaWdUYWJJbmRleCApIHsKCQkJCWhhbmRsZS5hdHRyKCAidGFiaW5kZXgiLCBvcmlnVGFiSW5kZXggKTsKCQkJfQoJCQljb250cm9sLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKS5mb2N1cyhmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5ibHVyKCk7CgkJCQloYW5kbGUuZm9jdXMoKTsKCQkJfSk7CgoJCQl3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJd3JhcHBlci5jbGFzc05hbWUgPSAidWktc2xpZGVyLWlubmVyb2Zmc2V0IjsKCgkJCWZvciAoIGogPSAwLCBsZW5ndGggPSBkb21TbGlkZXIuY2hpbGROb2Rlcy5sZW5ndGg7IGogPCBsZW5ndGg7IGorKyApIHsKCQkJCXdyYXBwZXIuYXBwZW5kQ2hpbGQoIGRvbVNsaWRlci5jaGlsZE5vZGVzW2pdICk7CgkJCX0KCgkJCWRvbVNsaWRlci5hcHBlbmRDaGlsZCggd3JhcHBlciApOwoKCQkJLy8gc2xpZGVyLndyYXBJbm5lciggIjxkaXYgY2xhc3M9J3VpLXNsaWRlci1pbm5lcm9mZnNldCc+PC9kaXY+IiApOwoKCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCWhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgoJCQlvcHRpb25zID0gY29udHJvbC5maW5kKCAib3B0aW9uIiApOwoKCQkJZm9yICggaSA9IDAsIG9wdGlvbnNDb3VudCA9IG9wdGlvbnMubGVuZ3RoOyBpIDwgb3B0aW9uc0NvdW50OyBpKysgKSB7CgkJCQlzaWRlID0gIWkgPyAiYiIgOiAiYSI7CgkJCQlhY3RpdmVDbGFzcyA9ICFpID8gIiIgOiAiICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzczsKCQkJCXNsaWRlckltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApOwoKCQkJCXNsaWRlckltZy5jbGFzc05hbWUgPSBbICJ1aS1zbGlkZXItbGFiZWwgdWktc2xpZGVyLWxhYmVsLSIsIHNpZGUsIGFjdGl2ZUNsYXNzIF0uam9pbiggIiIgKTsKCQkJCXNsaWRlckltZy5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgImltZyIgKTsKCQkJCXNsaWRlckltZy5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIG9wdGlvbnNbaV0uaW5uZXJIVE1MICkgKTsKCQkJCSQoIHNsaWRlckltZyApLnByZXBlbmRUbyggc2xpZGVyICk7CgkJCX0KCgkJCXNlbGYuX2xhYmVscyA9ICQoICIudWktc2xpZGVyLWxhYmVsIiwgc2xpZGVyICk7CgoJCX0KCgkJLy8gbW9uaXRvciB0aGUgaW5wdXQgZm9yIHVwZGF0ZWQgdmFsdWVzCgkJY29udHJvbC5hZGRDbGFzcyggaXNUb2dnbGVTd2l0Y2ggPyAidWktc2xpZGVyLXN3aXRjaCIgOiAidWktc2xpZGVyLWlucHV0IiApOwoKCQl0aGlzLl9vbiggY29udHJvbCwgewoJCQkiY2hhbmdlIjogIl9jb250cm9sQ2hhbmdlIiwKCQkJImtleXVwIjogIl9jb250cm9sS2V5dXAiLAoJCQkiYmx1ciI6ICJfY29udHJvbEJsdXIiLAoJCQkidm1vdXNldXAiOiAiX2NvbnRyb2xWTW91c2VVcCIKCQl9KTsKCgkJc2xpZGVyLmJpbmQoICJ2bW91c2Vkb3duIiwgJC5wcm94eSggdGhpcy5fc2xpZGVyVk1vdXNlRG93biwgdGhpcyApICkKCQkJLmJpbmQoICJ2Y2xpY2siLCBmYWxzZSApOwoKCQkvLyBXZSBoYXZlIHRvIGluc3RhbnRpYXRlIGEgbmV3IGZ1bmN0aW9uIG9iamVjdCBmb3IgdGhlIHVuYmluZCB0byB3b3JrIHByb3Blcmx5CgkJLy8gc2luY2UgdGhlIG1ldGhvZCBpdHNlbGYgaXMgZGVmaW5lZCBpbiB0aGUgcHJvdG90eXBlIChjYXVzaW5nIGl0IHRvIHVuYmluZCBldmVyeXRoaW5nKQoJCXRoaXMuX29uKCBkb2N1bWVudCwgeyAidm1vdXNlbW92ZSI6ICJfcHJldmVudERvY3VtZW50RHJhZyIgfSk7CgkJdGhpcy5fb24oIHNsaWRlci5hZGQoIGRvY3VtZW50ICksIHsgInZtb3VzZXVwIjogIl9zbGlkZXJWTW91c2VVcCIgfSk7CgoJCXNsaWRlci5pbnNlcnRBZnRlciggY29udHJvbCApOwoKCQkvLyB3cmFwIGluIGEgZGl2IGZvciBzdHlsaW5nIHB1cnBvc2VzCgkJaWYgKCAhaXNUb2dnbGVTd2l0Y2ggJiYgIWlzUmFuZ2VzbGlkZXIgKSB7CgkJCXdyYXBwZXIgPSB0aGlzLm9wdGlvbnMubWluaSA/ICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXIgdWktbWluaSc+IiA6ICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXInPiI7CgoJCQljb250cm9sLmFkZCggc2xpZGVyICkud3JhcEFsbCggd3JhcHBlciApOwoJCX0KCgkJLy8gYmluZCB0aGUgaGFuZGxlIGV2ZW50IGNhbGxiYWNrcyBhbmQgc2V0IHRoZSBjb250ZXh0IHRvIHRoZSB3aWRnZXQgaW5zdGFuY2UKCQl0aGlzLl9vbiggdGhpcy5oYW5kbGUsIHsKCQkJInZtb3VzZWRvd24iOiAiX2hhbmRsZVZNb3VzZURvd24iLAoJCQkia2V5ZG93biI6ICJfaGFuZGxlS2V5ZG93biIsCgkJCSJrZXl1cCI6ICJfaGFuZGxlS2V5dXAiCgkJfSk7CgoJCXRoaXMuaGFuZGxlLmJpbmQoICJ2Y2xpY2siLCBmYWxzZSApOwoKCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCgkJdGhpcy5yZWZyZXNoKCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgdHJ1ZSApOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldFRoZW1lKCBvcHRpb25zLnRoZW1lICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMudHJhY2tUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRUcmFja1RoZW1lKCBvcHRpb25zLnRyYWNrVGhlbWUgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldENvcm5lcnMoIG9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0TWluaSggb3B0aW9ucy5taW5pICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuaGlnaGxpZ2h0ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldEhpZ2hsaWdodCggb3B0aW9ucy5oaWdobGlnaHQgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXREaXNhYmxlZCggb3B0aW9ucy5kaXNhYmxlZCApOwoJCX0KCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfY29udHJvbENoYW5nZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCS8vIGlmIHRoZSB1c2VyIGRyYWdnZWQgdGhlIGhhbmRsZSwgdGhlICJjaGFuZ2UiIGV2ZW50IHdhcyB0cmlnZ2VyZWQgZnJvbSBpbnNpZGUgcmVmcmVzaCgpOyBkb24ndCBjYWxsIHJlZnJlc2goKSBhZ2FpbgoJCWlmICggdGhpcy5fdHJpZ2dlciggImNvbnRyb2xjaGFuZ2UiLCBldmVudCApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlpZiAoICF0aGlzLm1vdXNlTW92ZWQgKSB7CgkJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSwgdHJ1ZSApOwoJCX0KCX0sCgoJX2NvbnRyb2xLZXl1cDogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsgLy8gbmVjZXNzYXJ5PwoJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSwgdHJ1ZSwgdHJ1ZSApOwoJfSwKCglfY29udHJvbEJsdXI6IGZ1bmN0aW9uKC8qIGV2ZW50ICovKSB7CgkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpLCB0cnVlICk7Cgl9LAoKCS8vIGl0IGFwcGVhcnMgdGhlIGNsaWNraW5nIHRoZSB1cCBhbmQgZG93biBidXR0b25zIGluIGNocm9tZSBvbgoJLy8gcmFuZ2UvbnVtYmVyIGlucHV0cyBkb2Vzbid0IHRyaWdnZXIgYSBjaGFuZ2UgdW50aWwgdGhlIGZpZWxkIGlzCgkvLyBibHVycmVkLiBIZXJlIHdlIGNoZWNrIHRoaWYgdGhlIHZhbHVlIGhhcyBjaGFuZ2VkIGFuZCByZWZyZXNoCglfY29udHJvbFZNb3VzZVVwOiBmdW5jdGlvbigvKiBldmVudCAqLykgewoJCXRoaXMuX2NoZWNrZWRSZWZyZXNoKCk7Cgl9LAoKCS8vIE5PVEUgZm9yY2UgZm9jdXMgb24gaGFuZGxlCglfaGFuZGxlVk1vdXNlRG93bjogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKCQl0aGlzLmhhbmRsZS5mb2N1cygpOwoJfSwKCglfaGFuZGxlS2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBpbmRleCA9IHRoaXMuX3ZhbHVlKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEluIGFsbCBjYXNlcyBwcmV2ZW50IHRoZSBkZWZhdWx0IGFuZCBtYXJrIHRoZSBoYW5kbGUgYXMgYWN0aXZlCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5FTkQ6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX1VQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5SSUdIVDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5MRUZUOgoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCQlpZiAoICF0aGlzLl9rZXlTbGlkaW5nICkgewoJCQkJCXRoaXMuX2tleVNsaWRpbmcgPSB0cnVlOwoJCQkJCXRoaXMuaGFuZGxlLmFkZENsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOyAvKiBUT0RPOiBXZSBkb24ndCB1c2UgdGhpcyBjbGFzcyBmb3Igc3R5bGluZy4gRG8gd2UgbmVlZCB0byBhZGQgaXQ/ICovCgkJCQl9CgoJCQkJYnJlYWs7CgkJfQoKCQkvLyBtb3ZlIHRoZSBzbGlkZXIgYWNjb3JkaW5nIHRvIHRoZSBrZXlwcmVzcwoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLm1pbiApOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5FTkQ6CgkJCQl0aGlzLnJlZnJlc2goIHRoaXMubWF4ICk7CgkJCQlicmVhazsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUOgoJCQkJdGhpcy5yZWZyZXNoKCBpbmRleCArIHRoaXMuc3RlcCApOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX0RPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuTEVGVDoKCQkJCXRoaXMucmVmcmVzaCggaW5kZXggLSB0aGlzLnN0ZXAgKTsKCQkJCWJyZWFrOwoJCX0KCX0sIC8vIHJlbW92ZSBhY3RpdmUgbWFyawoKCV9oYW5kbGVLZXl1cDogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKCQlpZiAoIHRoaXMuX2tleVNsaWRpbmcgKSB7CgkJCXRoaXMuX2tleVNsaWRpbmcgPSBmYWxzZTsKCQkJdGhpcy5oYW5kbGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7IC8qIFNlZSBjb21tZW50IGFib3ZlLiAqLwoJCX0KCX0sCgoJX3NsaWRlclZNb3VzZURvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQkvLyBOT1RFOiB3ZSBkb24ndCBkbyB0aGlzIGluIHJlZnJlc2ggYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvCgkJLy8gICAgICAgc3VwcG9ydCBwcm9ncmFtbWF0aWMgYWx0ZXJhdGlvbiBvZiBkaXNhYmxlZCBpbnB1dHMKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCAhKCBldmVudC53aGljaCA9PT0gMSB8fCBldmVudC53aGljaCA9PT0gMCB8fCBldmVudC53aGljaCA9PT0gdW5kZWZpbmVkICkgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3Jlc3RhcnQiLCBldmVudCApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQl0aGlzLmRyYWdnaW5nID0gdHJ1ZTsKCQl0aGlzLnVzZXJNb2RpZmllZCA9IGZhbHNlOwoJCXRoaXMubW91c2VNb3ZlZCA9IGZhbHNlOwoKCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCXRoaXMuYmVmb3JlU3RhcnQgPSB0aGlzLmVsZW1lbnRbMF0uc2VsZWN0ZWRJbmRleDsKCQl9CgoJCXRoaXMucmVmcmVzaCggZXZlbnQgKTsKCQl0aGlzLl90cmlnZ2VyKCAic3RhcnQiICk7CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglfc2xpZGVyVk1vdXNlVXA6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5kcmFnZ2luZyApIHsKCQkJdGhpcy5kcmFnZ2luZyA9IGZhbHNlOwoKCQkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCQl0aGlzLmhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgoJCQkJaWYgKCB0aGlzLm1vdXNlTW92ZWQgKSB7CgkJCQkJLy8gdGhpcyBpcyBhIGRyYWcsIGNoYW5nZSB0aGUgdmFsdWUgb25seSBpZiB1c2VyIGRyYWdnZWQgZW5vdWdoCgkJCQkJaWYgKCB0aGlzLnVzZXJNb2RpZmllZCApIHsKCQkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ID09PSAwID8gMSA6IDAgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0aGlzLnJlZnJlc2goIHRoaXMuYmVmb3JlU3RhcnQgKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMgaXMganVzdCBhIGNsaWNrLCBjaGFuZ2UgdGhlIHZhbHVlCgkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ID09PSAwID8gMSA6IDAgKTsKCQkJCX0KCQkJfQoKCQkJdGhpcy5tb3VzZU1vdmVkID0gZmFsc2U7CgkJCXRoaXMuX3RyaWdnZXIoICJzdG9wIiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSwKCglfcHJldmVudERvY3VtZW50RHJhZzogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvLyBOT1RFOiB3ZSBkb24ndCBkbyB0aGlzIGluIHJlZnJlc2ggYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvCgkJCS8vICAgICAgIHN1cHBvcnQgcHJvZ3JhbW1hdGljIGFsdGVyYXRpb24gb2YgZGlzYWJsZWQgaW5wdXRzCgkJCWlmICggdGhpcy5fdHJpZ2dlciggImRyYWciLCBldmVudCApID09PSBmYWxzZSkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCWlmICggdGhpcy5kcmFnZ2luZyAmJiAhdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoKCQkJCS8vIHRoaXMubW91c2VNb3ZlZCBtdXN0IGJlIHVwZGF0ZWQgYmVmb3JlIHJlZnJlc2goKSBiZWNhdXNlIGl0IHdpbGwgYmUgdXNlZCBpbiB0aGUgY29udHJvbCAiY2hhbmdlIiBldmVudAoJCQkJdGhpcy5tb3VzZU1vdmVkID0gdHJ1ZTsKCgkJCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgaW4gc3luYyB3aXRoIHRoZSBtb3VzZQoJCQkJCXRoaXMuaGFuZGxlLnJlbW92ZUNsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCQkJCX0KCgkJCQl0aGlzLnJlZnJlc2goIGV2ZW50ICk7CgoJCQkJLy8gb25seSBhZnRlciByZWZyZXNoKCkgeW91IGNhbiBjYWxjdWxhdGUgdGhpcy51c2VyTW9kaWZpZWQKCQkJCXRoaXMudXNlck1vZGlmaWVkID0gdGhpcy5iZWZvcmVTdGFydCAhPT0gdGhpcy5lbGVtZW50WzBdLnNlbGVjdGVkSW5kZXg7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9LAoKCV9jaGVja2VkUmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLnZhbHVlICE9PSB0aGlzLl92YWx1ZSgpICkgewoJCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCkgKTsKCQl9Cgl9LAoKCV92YWx1ZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICB0aGlzLmlzVG9nZ2xlU3dpdGNoID8gdGhpcy5lbGVtZW50WzBdLnNlbGVjdGVkSW5kZXggOiBwYXJzZUZsb2F0KCB0aGlzLmVsZW1lbnQudmFsKCkgKSA7Cgl9LAoKCglfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVmcmVzaCggdW5kZWZpbmVkLCBmYWxzZSwgdHJ1ZSApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbiggdmFsLCBpc2Zyb21Db250cm9sLCBwcmV2ZW50SW5wdXRVcGRhdGUgKSB7CgkJLy8gTk9URTogd2UgZG9uJ3QgcmV0dXJuIGhlcmUgYmVjYXVzZSB3ZSB3YW50IHRvIHN1cHBvcnQgcHJvZ3JhbW1hdGljCgkJLy8gICAgICAgYWx0ZXJhdGlvbiBvZiB0aGUgaW5wdXQgdmFsdWUsIHdoaWNoIHNob3VsZCBzdGlsbCB1cGRhdGUgdGhlIHNsaWRlcgoKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCXBhcmVudFRoZW1lID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLmVsZW1lbnRbIDAgXSwgInRoZW1lIiApLAoJCQl0aGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSB8fCBwYXJlbnRUaGVtZSwKCQkJdGhlbWVDbGFzcyA9ICB0aGVtZSA/ICIgdWktYnRuLSIgKyB0aGVtZSA6ICIiLAoJCQl0cmFja1RoZW1lID0gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgfHwgcGFyZW50VGhlbWUsCgkJCXRyYWNrVGhlbWVDbGFzcyA9IHRyYWNrVGhlbWUgPyAiIHVpLWJhci0iICsgdHJhY2tUaGVtZSA6ICIgdWktYmFyLWluaGVyaXQiLAoJCQljb3JuZXJDbGFzcyA9IHRoaXMub3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiLAoJCQltaW5pQ2xhc3MgPSB0aGlzLm9wdGlvbnMubWluaSA/ICIgdWktbWluaSIgOiAiIiwKCQkJbGVmdCwgd2lkdGgsIGRhdGEsIHRvbCwKCQkJcHhTdGVwLCBwZXJjZW50LAoJCQljb250cm9sLCBpc0lucHV0LCBvcHRpb25FbGVtZW50cywgbWluLCBtYXgsIHN0ZXAsCgkJCW5ld3ZhbCwgdmFsTW9kU3RlcCwgYWxpZ25WYWx1ZSwgcGVyY2VudFBlclN0ZXAsCgkJCWhhbmRsZVBlcmNlbnQsIGFQZXJjZW50LCBiUGVyY2VudCwKCQkJdmFsdWVDaGFuZ2VkOwoKCQlzZWxmLnNsaWRlclswXS5jbGFzc05hbWUgPSBbIHRoaXMuaXNUb2dnbGVTd2l0Y2ggPyAidWktc2xpZGVyIHVpLXNsaWRlci1zd2l0Y2ggdWktc2xpZGVyLXRyYWNrIHVpLXNoYWRvdy1pbnNldCIgOiAidWktc2xpZGVyLXRyYWNrIHVpLXNoYWRvdy1pbnNldCIsIHRyYWNrVGhlbWVDbGFzcywgY29ybmVyQ2xhc3MsIG1pbmlDbGFzcyBdLmpvaW4oICIiICk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIgKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoKCQkvLyBzZXQgdGhlIHN0b3JlZCB2YWx1ZSBmb3IgY29tcGFyaXNvbiBsYXRlcgoJCXRoaXMudmFsdWUgPSB0aGlzLl92YWx1ZSgpOwoJCWlmICggdGhpcy5vcHRpb25zLmhpZ2hsaWdodCAmJiAhdGhpcy5pc1RvZ2dsZVN3aXRjaCAmJiB0aGlzLnNsaWRlci5maW5kKCAiLnVpLXNsaWRlci1iZyIgKS5sZW5ndGggPT09IDAgKSB7CgkJCXRoaXMudmFsdWViZyA9IChmdW5jdGlvbigpIHsKCQkJCXZhciBiZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgkJCQliZy5jbGFzc05hbWUgPSAidWktc2xpZGVyLWJnICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzczsKCQkJCXJldHVybiAkKCBiZyApLnByZXBlbmRUbyggc2VsZi5zbGlkZXIgKTsKCQkJfSkoKTsKCQl9CgkJdGhpcy5oYW5kbGUuYWRkQ2xhc3MoICJ1aS1idG4iICsgdGhlbWVDbGFzcyArICIgdWktc2hhZG93IiApOwoKCQljb250cm9sID0gdGhpcy5lbGVtZW50OwoJCWlzSW5wdXQgPSAhdGhpcy5pc1RvZ2dsZVN3aXRjaDsKCQlvcHRpb25FbGVtZW50cyA9IGlzSW5wdXQgPyBbXSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKTsKCQltaW4gPSAgaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1pbiIgKSApIDogMDsKCQltYXggPSBpc0lucHV0ID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWF4IiApICkgOiBvcHRpb25FbGVtZW50cy5sZW5ndGggLSAxOwoJCXN0ZXAgPSAoIGlzSW5wdXQgJiYgcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSApID4gMCApID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSApIDogMTsKCgkJaWYgKCB0eXBlb2YgdmFsID09PSAib2JqZWN0IiApIHsKCQkJZGF0YSA9IHZhbDsKCQkJLy8gYSBzbGlnaHQgdG9sZXJhbmNlIGhlbHBlZCBnZXQgdG8gdGhlIGVuZHMgb2YgdGhlIHNsaWRlcgoJCQl0b2wgPSA4OwoKCQkJbGVmdCA9IHRoaXMuc2xpZGVyLm9mZnNldCgpLmxlZnQ7CgkJCXdpZHRoID0gdGhpcy5zbGlkZXIud2lkdGgoKTsKCQkJcHhTdGVwID0gd2lkdGgvKChtYXgtbWluKS9zdGVwKTsKCQkJaWYgKCAhdGhpcy5kcmFnZ2luZyB8fAoJCQkJCWRhdGEucGFnZVggPCBsZWZ0IC0gdG9sIHx8CgkJCQkJZGF0YS5wYWdlWCA+IGxlZnQgKyB3aWR0aCArIHRvbCApIHsKCQkJCXJldHVybjsKCQkJfQoJCQlpZiAoIHB4U3RlcCA+IDEgKSB7CgkJCQlwZXJjZW50ID0gKCAoIGRhdGEucGFnZVggLSBsZWZ0ICkgLyB3aWR0aCApICogMTAwOwoJCQl9IGVsc2UgewoJCQkJcGVyY2VudCA9IE1hdGgucm91bmQoICggKCBkYXRhLnBhZ2VYIC0gbGVmdCApIC8gd2lkdGggKSAqIDEwMCApOwoJCQl9CgkJfSBlbHNlIHsKCQkJaWYgKCB2YWwgPT0gbnVsbCApIHsKCQkJCXZhbCA9IGlzSW5wdXQgPyBwYXJzZUZsb2F0KCBjb250cm9sLnZhbCgpIHx8IDAgKSA6IGNvbnRyb2xbMF0uc2VsZWN0ZWRJbmRleDsKCQkJfQoJCQlwZXJjZW50ID0gKCBwYXJzZUZsb2F0KCB2YWwgKSAtIG1pbiApIC8gKCBtYXggLSBtaW4gKSAqIDEwMDsKCQl9CgoJCWlmICggaXNOYU4oIHBlcmNlbnQgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJbmV3dmFsID0gKCBwZXJjZW50IC8gMTAwICkgKiAoIG1heCAtIG1pbiApICsgbWluOwoKCQkvL2Zyb20galF1ZXJ5IFVJIHNsaWRlciwgdGhlIGZvbGxvd2luZyBzb3VyY2Ugd2lsbCByb3VuZCB0byB0aGUgbmVhcmVzdCBzdGVwCgkJdmFsTW9kU3RlcCA9ICggbmV3dmFsIC0gbWluICkgJSBzdGVwOwoJCWFsaWduVmFsdWUgPSBuZXd2YWwgLSB2YWxNb2RTdGVwOwoKCQlpZiAoIE1hdGguYWJzKCB2YWxNb2RTdGVwICkgKiAyID49IHN0ZXAgKSB7CgkJCWFsaWduVmFsdWUgKz0gKCB2YWxNb2RTdGVwID4gMCApID8gc3RlcCA6ICggLXN0ZXAgKTsKCQl9CgoJCXBlcmNlbnRQZXJTdGVwID0gMTAwLygobWF4LW1pbikvc3RlcCk7CgkJLy8gU2luY2UgSmF2YVNjcmlwdCBoYXMgcHJvYmxlbXMgd2l0aCBsYXJnZSBmbG9hdHMsIHJvdW5kCgkJLy8gdGhlIGZpbmFsIHZhbHVlIHRvIDUgZGlnaXRzIGFmdGVyIHRoZSBkZWNpbWFsIHBvaW50IChzZWUgalF1ZXJ5VUk6ICM0MTI0KQoJCW5ld3ZhbCA9IHBhcnNlRmxvYXQoIGFsaWduVmFsdWUudG9GaXhlZCg1KSApOwoKCQlpZiAoIHR5cGVvZiBweFN0ZXAgPT09ICJ1bmRlZmluZWQiICkgewoJCQlweFN0ZXAgPSB3aWR0aCAvICggKG1heC1taW4pIC8gc3RlcCApOwoJCX0KCQlpZiAoIHB4U3RlcCA+IDEgJiYgaXNJbnB1dCApIHsKCQkJcGVyY2VudCA9ICggbmV3dmFsIC0gbWluICkgKiBwZXJjZW50UGVyU3RlcCAqICggMSAvIHN0ZXAgKTsKCQl9CgkJaWYgKCBwZXJjZW50IDwgMCApIHsKCQkJcGVyY2VudCA9IDA7CgkJfQoKCQlpZiAoIHBlcmNlbnQgPiAxMDAgKSB7CgkJCXBlcmNlbnQgPSAxMDA7CgkJfQoKCQlpZiAoIG5ld3ZhbCA8IG1pbiApIHsKCQkJbmV3dmFsID0gbWluOwoJCX0KCgkJaWYgKCBuZXd2YWwgPiBtYXggKSB7CgkJCW5ld3ZhbCA9IG1heDsKCQl9CgoJCXRoaXMuaGFuZGxlLmNzcyggImxlZnQiLCBwZXJjZW50ICsgIiUiICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggImFyaWEtdmFsdWVub3ciLCBpc0lucHV0ID8gbmV3dmFsIDogb3B0aW9uRWxlbWVudHMuZXEoIG5ld3ZhbCApLmF0dHIoICJ2YWx1ZSIgKSApOwoKCQl0aGlzLmhhbmRsZVswXS5zZXRBdHRyaWJ1dGUoICJhcmlhLXZhbHVldGV4dCIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuZ2V0RW5jb2RlZFRleHQoKSApOwoKCQl0aGlzLmhhbmRsZVswXS5zZXRBdHRyaWJ1dGUoICJ0aXRsZSIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuZ2V0RW5jb2RlZFRleHQoKSApOwoKCQlpZiAoIHRoaXMudmFsdWViZyApIHsKCQkJdGhpcy52YWx1ZWJnLmNzcyggIndpZHRoIiwgcGVyY2VudCArICIlIiApOwoJCX0KCgkJLy8gZHJhZyB0aGUgbGFiZWwgd2lkdGhzCgkJaWYgKCB0aGlzLl9sYWJlbHMgKSB7CgkJCWhhbmRsZVBlcmNlbnQgPSB0aGlzLmhhbmRsZS53aWR0aCgpIC8gdGhpcy5zbGlkZXIud2lkdGgoKSAqIDEwMDsKCQkJYVBlcmNlbnQgPSBwZXJjZW50ICYmIGhhbmRsZVBlcmNlbnQgKyAoIDEwMCAtIGhhbmRsZVBlcmNlbnQgKSAqIHBlcmNlbnQgLyAxMDA7CgkJCWJQZXJjZW50ID0gcGVyY2VudCA9PT0gMTAwID8gMCA6IE1hdGgubWluKCBoYW5kbGVQZXJjZW50ICsgMTAwIC0gYVBlcmNlbnQsIDEwMCApOwoKCQkJdGhpcy5fbGFiZWxzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgYWIgPSAkKCB0aGlzICkuaGFzQ2xhc3MoICJ1aS1zbGlkZXItbGFiZWwtYSIgKTsKCQkJCSQoIHRoaXMgKS53aWR0aCggKCBhYiA/IGFQZXJjZW50IDogYlBlcmNlbnQgICkgKyAiJSIgKTsKCQkJfSk7CgkJfQoKCQlpZiAoICFwcmV2ZW50SW5wdXRVcGRhdGUgKSB7CgkJCXZhbHVlQ2hhbmdlZCA9IGZhbHNlOwoKCQkJLy8gdXBkYXRlIGNvbnRyb2wicyB2YWx1ZQoJCQlpZiAoIGlzSW5wdXQgKSB7CgkJCQl2YWx1ZUNoYW5nZWQgPSBjb250cm9sLnZhbCgpICE9PSBuZXd2YWw7CgkJCQljb250cm9sLnZhbCggbmV3dmFsICk7CgkJCX0gZWxzZSB7CgkJCQl2YWx1ZUNoYW5nZWQgPSBjb250cm9sWyAwIF0uc2VsZWN0ZWRJbmRleCAhPT0gbmV3dmFsOwoJCQkJY29udHJvbFsgMCBdLnNlbGVjdGVkSW5kZXggPSBuZXd2YWw7CgkJCX0KCQkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3JlY2hhbmdlIiwgdmFsICkgPT09IGZhbHNlKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCWlmICggIWlzZnJvbUNvbnRyb2wgJiYgdmFsdWVDaGFuZ2VkICkgewoJCQkJY29udHJvbC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfQoJfSwKCglfc2V0SGlnaGxpZ2h0OiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFsdWUgPSAhIXZhbHVlOwoJCWlmICggdmFsdWUgKSB7CgkJCXRoaXMub3B0aW9ucy5oaWdobGlnaHQgPSAhIXZhbHVlOwoJCQl0aGlzLnJlZnJlc2goKTsKCQl9IGVsc2UgaWYgKCB0aGlzLnZhbHVlYmcgKSB7CgkJCXRoaXMudmFsdWViZy5yZW1vdmUoKTsKCQkJdGhpcy52YWx1ZWJnID0gZmFsc2U7CgkJfQoJfSwKCglfc2V0VGhlbWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLmhhbmRsZQoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1idG4tIiArIHRoaXMub3B0aW9ucy50aGVtZSApCgkJCS5hZGRDbGFzcyggInVpLWJ0bi0iICsgdmFsdWUgKTsKCgkJdmFyIGN1cnJlbnRUaGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSA/IHRoaXMub3B0aW9ucy50aGVtZSA6ICJpbmhlcml0IiwKCQkJbmV3VGhlbWUgPSB2YWx1ZSA/IHZhbHVlIDogImluaGVyaXQiOwoKCQl0aGlzLmNvbnRyb2wKCQkJLnJlbW92ZUNsYXNzKCAidWktYm9keS0iICsgY3VycmVudFRoZW1lICkKCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgbmV3VGhlbWUgKTsKCX0sCgoJX3NldFRyYWNrVGhlbWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YXIgY3VycmVudFRyYWNrVGhlbWUgPSB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSA/IHRoaXMub3B0aW9ucy50cmFja1RoZW1lIDogImluaGVyaXQiLAoJCQluZXdUcmFja1RoZW1lID0gdmFsdWUgPyB2YWx1ZSA6ICJpbmhlcml0IjsKCgkJdGhpcy5zbGlkZXIKCQkJLnJlbW92ZUNsYXNzKCAidWktYm9keS0iICsgY3VycmVudFRyYWNrVGhlbWUgKQoJCQkuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyBuZXdUcmFja1RoZW1lICk7Cgl9LAoKCV9zZXRNaW5pOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFsdWUgPSAhIXZhbHVlOwoJCWlmICggIXRoaXMuaXNUb2dnbGVTd2l0Y2ggJiYgIXRoaXMuaXNSYW5nZXNsaWRlciApIHsKCQkJdGhpcy5zbGlkZXIucGFyZW50KCkudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgdmFsdWUgKTsKCQkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIHZhbHVlICk7CgkJfQoJCXRoaXMuc2xpZGVyLnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIHZhbHVlICk7Cgl9LAoKCV9zZXRDb3JuZXJzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5zbGlkZXIudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgdmFsdWUgKTsKCgkJaWYgKCAhdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJdGhpcy5jb250cm9sLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIHZhbHVlICk7CgkJfQoJfSwKCglfc2V0RGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YWx1ZSA9ICEhdmFsdWU7CgkJdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIsIHZhbHVlICk7CgkJdGhpcy5zbGlkZXIudG9nZ2xlQ2xhc3MoICJ1aS1kaXNhYmxlZCIsIHZhbHVlICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJfQoKfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmZsaXBzd2l0Y2giLCAkLmV4dGVuZCh7CgoJb3B0aW9uczogewoJCW9uVGV4dDogIk9uIiwKCQlvZmZUZXh0OiAiT2ZmIiwKCQl0aGVtZTogbnVsbCwKCQllbmhhbmNlZDogZmFsc2UsCgkJd3JhcHBlckNsYXNzOiBudWxsLAoJCW1pbmk6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCQl0aGlzLl9lbmhhbmNlKCk7CgkJCX0gZWxzZSB7CgkJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJCWZsaXBzd2l0Y2g6IHRoaXMuZWxlbWVudC5wYXJlbnQoKSwKCQkJCQlvbjogdGhpcy5lbGVtZW50LmZpbmQoICIudWktZmxpcHN3aXRjaC1vbiIgKS5lcSggMCApLAoJCQkJCW9mZjogdGhpcy5lbGVtZW50LmZpbmQoICIudWktZmxpcHN3aXRjaC1vZmYiICkuZXEoMCksCgkJCQkJdHlwZTogdGhpcy5lbGVtZW50LmdldCggMCApLnRhZ05hbWUKCQkJCX0pOwoJCQl9CgoJCQlpZiggdGhpcy5lbGVtZW50LmlzKCAiOmRpc2FibGVkIiApICl7CgkJCQl0aGlzLl9zZXRPcHRpb25zKHsKCQkJCQkiZGlzYWJsZWQiOiB0cnVlCgkJCQl9KTsKCQkJfQoKCQkJdGhpcy5fb24oIHRoaXMuZmxpcHN3aXRjaCwgewoJCQkJImNsaWNrIjogIl90b2dnbGUiLAoJCQkJInN3aXBlbGVmdCI6ICJfbGVmdCIsCgkJCQkic3dpcGVyaWdodCI6ICJfcmlnaHQiCgkJCX0pOwoKCQkJdGhpcy5fb24oIHRoaXMub24sIHsKCQkJCSJrZXlkb3duIjogIl9rZXlkb3duIgoJCQl9KTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5mbGlwc3dpdGNoOwoJfSwKCglfbGVmdDogZnVuY3Rpb24oKSB7CgkJdGhpcy5mbGlwc3dpdGNoLnJlbW92ZUNsYXNzKCAidWktZmxpcHN3aXRjaC1hY3RpdmUiICk7CgkJaWYgKCB0aGlzLnR5cGUgPT09ICJTRUxFQ1QiICkgewoJCQl0aGlzLmVsZW1lbnQuZ2V0KCAwICkuc2VsZWN0ZWRJbmRleCA9IDA7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbGVtZW50LnByb3AoICJjaGVja2VkIiwgdHJ1ZSApOwoJCX0KCQl0aGlzLl90cmlnZ2VyKCAiY2hhbmdlIiApOwoJfSwKCglfcmlnaHQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZmxpcHN3aXRjaC5hZGRDbGFzcyggInVpLWZsaXBzd2l0Y2gtYWN0aXZlIiApOwoJCWlmICggdGhpcy50eXBlID09PSAiU0VMRUNUIiApIHsKCQkJdGhpcy5lbGVtZW50LmdldCggMCApLnNlbGVjdGVkSW5kZXggPSAxOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWxlbWVudC5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJfQoJCXRoaXMuX3RyaWdnZXIoICJjaGFuZ2UiICk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl2YXIgZmxpcHN3aXRjaCA9ICQoICI8ZGl2PiIgKSwKCQkJdGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUgPyB0aGlzLm9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIsCgkJCW9uID0gJCggIjxzcGFuIHRhYmluZGV4PScxJz48L3NwYW4+IiApLAoJCQlvZmYgPSAkKCAiPHNwYW4+PC9zcGFuPiIgKSwKCQkJdHlwZSA9IHRoaXMuZWxlbWVudC5nZXQoIDAgKS50YWdOYW1lLAoJCQlvblRleHQgPSAoIHR5cGUgPT09ICJJTlBVVCIgKSA/IHRoaXMub3B0aW9ucy5vblRleHQgOiB0aGlzLmVsZW1lbnQuZmluZCggIm9wdGlvbiIgKS5lcSggMSApLnRleHQoKSwKCQkJb2ZmVGV4dCA9ICggdHlwZSA9PT0gIklOUFVUIiApID8gdGhpcy5vcHRpb25zLm9mZlRleHQgOiB0aGlzLmVsZW1lbnQuZmluZCggIm9wdGlvbiIgKS5lcSggMCApLnRleHQoKTsKCgkJCW9uLmFkZENsYXNzKCAidWktZmxpcHN3aXRjaC1vbiB1aS1idG4gdWktc2hhZG93IHVpLWJ0bi1pbmhlcml0IiApLnRleHQoIG9uVGV4dCApOwoJCQlvZmYuYWRkQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLW9mZiIgKS50ZXh0KCBvZmZUZXh0ICk7CgkJCQoJCQlmbGlwc3dpdGNoLmFkZENsYXNzKCAidWktZmxpcHN3aXRjaCB1aS1zaGFkb3ctaW5zZXQgdWktY29ybmVyLWFsbCB1aS1iYXItIiArIHRoZW1lICsgIiAiICsgKCB0aGlzLm9wdGlvbnMud3JhcHBlckNsYXNzID8gdGhpcy5vcHRpb25zLndyYXBwZXJDbGFzcyA6ICIiICkgKyAiICIgKyAoICggdGhpcy5lbGVtZW50LmlzKCAiOmNoZWNrZWQiICkgfHwgdGhpcy5lbGVtZW50LmZpbmQoIm9wdGlvbiIpLmVxKDEpLmlzKCI6c2VsZWN0ZWQiKSApID8gInVpLWZsaXBzd2l0Y2gtYWN0aXZlIiA6ICIiICkgKyAoIHRoaXMuZWxlbWVudC5pcygiOmRpc2FibGVkIikgPyAiIHVpLXN0YXRlLWRpc2FibGVkIjogIiIpICsgKCB0aGlzLm9wdGlvbnMubWluaSA/ICIgdWktbWluaSI6ICIiICkgKS5hcHBlbmQoIG9uLCBvZmYgKTsKCQkJCgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLWZsaXBzd2l0Y2gtaW5wdXQiICk7CgkJCXRoaXMuZWxlbWVudC5hZnRlciggZmxpcHN3aXRjaCApLmFwcGVuZFRvKCBmbGlwc3dpdGNoICk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCWZsaXBzd2l0Y2g6IGZsaXBzd2l0Y2gsCgkJCW9uOiBvbiwKCQkJb2ZmOiBvZmYsCgkJCXR5cGU6IHR5cGUKCQl9KTsKCX0sCgoJX2NoYW5nZTogZnVuY3Rpb24oKSB7CgkJdmFyIGRpcmVjdGlvbjsKCQkKCQlpZiAoIHRoaXMudHlwZSA9PT0gIlNFTEVDVCIgKSB7CgkJCWRpcmVjdGlvbiA9ICggdGhpcy5lbGVtZW50LmdldCggMCApLnNlbGVjdGVkSW5kZXggPiAwICk/ICJfcmlnaHQiOiAiX2xlZnQiOwoJCX0gZWxzZSB7CgkJCWRpcmVjdGlvbiA9IHRoaXMuZWxlbWVudC5pcyggIjpjaGVja2VkIiApPyAiX3JpZ2h0IjogIl9sZWZ0IjsKCQl9CgkJdGhpc1sgZGlyZWN0aW9uIF0oKTsKCX0sCgoJX3RvZ2dsZTogZnVuY3Rpb24oKSB7CgkJdmFyIGRpcmVjdGlvbiA9IHRoaXMuZmxpcHN3aXRjaC5oYXNDbGFzcyggInVpLWZsaXBzd2l0Y2gtYWN0aXZlIiApID8gIl9sZWZ0IiA6ICJfcmlnaHQiOwoJCQoJCXRoaXNbZGlyZWN0aW9uXSgpOwoJfSwKCglfa2V5ZG93bjogZnVuY3Rpb24oIGUgKSB7CgkJaWYgKCBlLndoaWNoID09PSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQgKSB7CgkJCXRoaXMuX2xlZnQoKTsKCQl9IGVsc2UgaWYgKCBlLndoaWNoID09PSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUICkgewoJCQl0aGlzLl9yaWdodCgpOwoJCX0gZWxzZSBpZiAoIGUud2hpY2ggPT09ICQubW9iaWxlLmtleUNvZGUuU1BBQ0UgKSB7CgkJCXRoaXMuX3RvZ2dsZSgpOwoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXZhciBjdXJyZW50VGhlbWUgPSBvcHRpb25zLnRoZW1lID8gb3B0aW9ucy50aGVtZSA6ICJpbmhlcml0IiwKCQkJCW5ld1RoZW1lID0gb3B0aW9ucy50aGVtZSA/IG9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCI7CgoJCQl0aGlzLndpZGdldCgpCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1iYXItIiArIGN1cnJlbnRUaGVtZSApCgkJCQkuYWRkQ2xhc3MoICJ1aS1iYXItIiArIG5ld1RoZW1lICk7CgkJfQoJCWlmICggb3B0aW9ucy5vblRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5vbi50ZXh0KCBvcHRpb25zLm9uVGV4dCApOwoJCX0KCQlpZiAoIG9wdGlvbnMub2ZmVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLm9mZi50ZXh0KCBvcHRpb25zLm9mZlRleHQgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMud2lkZ2V0KCkudG9nZ2xlQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIsIG9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9CgkJaWYoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLndpZGdldCgpLnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIG9wdGlvbnMubWluaSApOwoJCX0KCQkKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5vbi5yZW1vdmUoKTsKCQl0aGlzLm9mZi5yZW1vdmUoKTsKCQl0aGlzLmVsZW1lbnQudW53cmFwKCk7CgkJdGhpcy5mbGlwc3dpdGNoLnJlbW92ZSgpOwoJCXRoaXMucmVtb3ZlQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLWlucHV0IiApOwoJfQoKfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCSQud2lkZ2V0KCAibW9iaWxlLnJhbmdlc2xpZGVyIiwgJC5leHRlbmQoIHsKCgkJb3B0aW9uczogewoJCQl0aGVtZTogbnVsbCwKCQkJdHJhY2tUaGVtZTogbnVsbCwKCQkJY29ybmVyczogdHJ1ZSwKCQkJbWluaTogZmFsc2UsCgkJCWhpZ2hsaWdodDogdHJ1ZQoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQllbENsYXNzID0gdGhpcy5vcHRpb25zLm1pbmkgPyAidWktcmFuZ2VzbGlkZXIgdWktbWluaSIgOiAidWktcmFuZ2VzbGlkZXIiLAoJCQlfaW5wdXRGaXJzdCA9ICRlbC5maW5kKCAiaW5wdXQiICkuZmlyc3QoKSwKCQkJX2lucHV0TGFzdCA9ICRlbC5maW5kKCAiaW5wdXQiICkubGFzdCgpLAoJCQlfbGFiZWwgPSAkZWwuZmluZCggImxhYmVsIiApLmZpcnN0KCksCgkJCV9zbGlkZXJGaXJzdCA9ICQuZGF0YSggX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5zbGlkZXIsCgkJCV9zbGlkZXJMYXN0ID0gJC5kYXRhKCBfaW5wdXRMYXN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuc2xpZGVyLAoJCQlmaXJzdEhhbmRsZSA9ICQuZGF0YSggX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUsCgkJCV9zbGlkZXJzID0gJCggIjxkaXYgY2xhc3M9J3VpLXJhbmdlc2xpZGVyLXNsaWRlcnMnIC8+IiApLmFwcGVuZFRvKCAkZWwgKTsKCgkJCV9pbnB1dEZpcnN0LmFkZENsYXNzKCAidWktcmFuZ2VzbGlkZXItZmlyc3QiICk7CgkJCV9pbnB1dExhc3QuYWRkQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1sYXN0IiApOwoJCQkkZWwuYWRkQ2xhc3MoIGVsQ2xhc3MgKTsKCgkJCV9zbGlkZXJGaXJzdC5hcHBlbmRUbyggX3NsaWRlcnMgKTsKCQkJX3NsaWRlckxhc3QuYXBwZW5kVG8oIF9zbGlkZXJzICk7CgkJCV9sYWJlbC5pbnNlcnRCZWZvcmUoICRlbCApOwoJCQlmaXJzdEhhbmRsZS5wcmVwZW5kVG8oIF9zbGlkZXJMYXN0ICk7CgoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJX2lucHV0Rmlyc3Q6IF9pbnB1dEZpcnN0LAoJCQkJX2lucHV0TGFzdDogX2lucHV0TGFzdCwKCQkJCV9zbGlkZXJGaXJzdDogX3NsaWRlckZpcnN0LAoJCQkJX3NsaWRlckxhc3Q6IF9zbGlkZXJMYXN0LAoJCQkJX2xhYmVsOiBfbGFiZWwsCgkJCQlfdGFyZ2V0VmFsOiBudWxsLAoJCQkJX3NsaWRlclRhcmdldDogZmFsc2UsCgkJCQlfc2xpZGVyczogX3NsaWRlcnMsCgkJCQlfcHJveHk6IGZhbHNlCgkJCX0pOwoKCQkJdGhpcy5yZWZyZXNoKCk7CgkJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQuZmluZCggImlucHV0LnVpLXNsaWRlci1pbnB1dCIgKSwgewoJCQkJInNsaWRlYmVmb3Jlc3RhcnQiOiAiX3NsaWRlYmVmb3Jlc3RhcnQiLAoJCQkJInNsaWRlc3RvcCI6ICJfc2xpZGVzdG9wIiwKCQkJCSJzbGlkZWRyYWciOiAiX3NsaWRlZHJhZyIsCgkJCQkic2xpZGViZWZvcmVjaGFuZ2UiOiAiX2NoYW5nZSIsCgkJCQkiYmx1ciI6ICJfY2hhbmdlIiwKCQkJCSJrZXl1cCI6ICJfY2hhbmdlIgoJCQl9KTsKCQkJdGhpcy5fb24oewoJCQkJIm1vdXNlZG93biI6Il9jaGFuZ2UiCgkJCX0pOwoJCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LmNsb3Nlc3QoICJmb3JtIiApLCB7CgkJCQkicmVzZXQiOiJfaGFuZGxlUmVzZXQiCgkJCX0pOwoJCQl0aGlzLl9vbiggZmlyc3RIYW5kbGUsIHsKCQkJCSJ2bW91c2Vkb3duIjogIl9kcmFnRmlyc3RIYW5kbGUiCgkJCX0pOwoJCX0sCgkJX2hhbmRsZVJlc2V0OiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkvL3dlIG11c3Qgd2FpdCBmb3IgdGhlIHN0YWNrIHRvIHVud2luZCBiZWZvcmUgdXBkYXRlaW5nIG90aGVyIHdpc2Ugc2xpZGVycyB3aWxsIG5vdCBoYXZlIHVwZGF0ZWQgeWV0CgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJCX0sMCk7CgkJfSwKCgkJX2RyYWdGaXJzdEhhbmRsZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvL2lmIHRoZSBmaXJzdCBoYW5kbGUgaXMgZHJhZ2dlZCBzZW5kIHRoZSBldmVudCB0byB0aGUgZmlyc3Qgc2xpZGVyCgkJCSQuZGF0YSggdGhpcy5faW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmRyYWdnaW5nID0gdHJ1ZTsKCQkJJC5kYXRhKCB0aGlzLl9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkucmVmcmVzaCggZXZlbnQgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0sCgoJCV9zbGlkZWRyYWc6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZpcnN0ID0gJCggZXZlbnQudGFyZ2V0ICkuaXMoIHRoaXMuX2lucHV0Rmlyc3QgKSwKCQkJCW90aGVyU2xpZGVyID0gKCBmaXJzdCApID8gdGhpcy5faW5wdXRMYXN0IDogdGhpcy5faW5wdXRGaXJzdDsKCgkJCXRoaXMuX3NsaWRlclRhcmdldCA9IGZhbHNlOwoJCQkvL2lmIHRoZSBkcmFnIHdhcyBpbml0aWF0ZWQgb24gYW4gZXh0cmVtZSBhbmQgdGhlIG90aGVyIGhhbmRsZSBpcyBmb2N1c2VkIHNlbmQgdGhlIGV2ZW50cyB0bwoJCQkvL3RoZSBjbG9zZXN0IGhhbmRsZQoJCQlpZiAoICggdGhpcy5fcHJveHkgPT09ICJmaXJzdCIgJiYgZmlyc3QgKSB8fCAoIHRoaXMuX3Byb3h5ID09PSAibGFzdCIgJiYgIWZpcnN0ICkgKSB7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuZHJhZ2dpbmcgPSB0cnVlOwoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLnJlZnJlc2goIGV2ZW50ICk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9LAoKCQlfc2xpZGVzdG9wOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmlzKCB0aGlzLl9pbnB1dEZpcnN0ICk7CgoJCQl0aGlzLl9wcm94eSA9IGZhbHNlOwoJCQkvL3RoaXMgc3RvcHMgZHJhZ2dpbmcgb2YgdGhlIGhhbmRsZSBhbmQgYnJpbmdzIHRoZSBhY3RpdmUgdHJhY2sgdG8gdGhlIGZyb250CgkJCS8vdGhpcyBtYWtlcyBjbGlja3Mgb24gdGhlIHRyYWNrIGdvIHRoZSB0aGUgbGFzdCBoYW5kbGUgdXNlZAoJCQl0aGlzLmVsZW1lbnQuZmluZCggImlucHV0IiApLnRyaWdnZXIoICJ2bW91c2V1cCIgKTsKCQkJdGhpcy5fc2xpZGVyRmlyc3QuY3NzKCAiei1pbmRleCIsIGZpcnN0ID8gMSA6ICIiICk7CgkJfSwKCgkJX3NsaWRlYmVmb3Jlc3RhcnQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdGhpcy5fc2xpZGVyVGFyZ2V0ID0gZmFsc2U7CgkJCS8vaWYgdGhlIHRyYWNrIGlzIHRoZSB0YXJnZXQgcmVtZW1iZXIgdGhpcyBhbmQgdGhlIG9yaWdpbmFsIHZhbHVlCgkJCWlmICggJCggZXZlbnQub3JpZ2luYWxFdmVudC50YXJnZXQgKS5oYXNDbGFzcyggInVpLXNsaWRlci10cmFjayIgKSApIHsKCQkJCXRoaXMuX3NsaWRlclRhcmdldCA9IHRydWU7CgkJCQl0aGlzLl90YXJnZXRWYWwgPSAkKCBldmVudC50YXJnZXQgKS52YWwoKTsKCQkJfQoJCX0sCgoJCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl9zZXRUaGVtZSggb3B0aW9ucy50aGVtZSApOwoJCQl9CgoJCQlpZiAoIG9wdGlvbnMudHJhY2tUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fc2V0VHJhY2tUaGVtZSggb3B0aW9ucy50cmFja1RoZW1lICk7CgkJCX0KCgkJCWlmICggb3B0aW9ucy5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl9zZXRNaW5pKCBvcHRpb25zLm1pbmkgKTsKCQkJfQoKCQkJaWYgKCBvcHRpb25zLmhpZ2hsaWdodCAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fc2V0SGlnaGxpZ2h0KCBvcHRpb25zLmhpZ2hsaWdodCApOwoJCQl9CgkJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0sCgoJCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJbyA9IHRoaXMub3B0aW9uczsKCgkJCSRlbC5maW5kKCAiaW5wdXQiICkuc2xpZGVyKHsKCQkJCXRoZW1lOiBvLnRoZW1lLAoJCQkJdHJhY2tUaGVtZTogby50cmFja1RoZW1lLAoJCQkJZGlzYWJsZWQ6IG8uZGlzYWJsZWQsCgkJCQljb3JuZXJzOiBvLmNvcm5lcnMsCgkJCQltaW5pOiBvLm1pbmksCgkJCQloaWdobGlnaHQ6IG8uaGlnaGxpZ2h0CgkJCX0pLnNsaWRlciggInJlZnJlc2giICk7CgkJCXRoaXMuX3VwZGF0ZUhpZ2hsaWdodCgpOwoJCX0sCgoJCV9jaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCBldmVudC50eXBlID09PSAia2V5dXAiICkgewoJCQkJdGhpcy5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW1pbiA9IHBhcnNlRmxvYXQoIHRoaXMuX2lucHV0Rmlyc3QudmFsKCksIDEwICksCgkJCQltYXggPSBwYXJzZUZsb2F0KCB0aGlzLl9pbnB1dExhc3QudmFsKCksIDEwICksCgkJCQlmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmhhc0NsYXNzKCAidWktcmFuZ2VzbGlkZXItZmlyc3QiICksCgkJCQl0aGlzU2xpZGVyID0gZmlyc3QgPyB0aGlzLl9pbnB1dEZpcnN0IDogdGhpcy5faW5wdXRMYXN0LAoJCQkJb3RoZXJTbGlkZXIgPSBmaXJzdCA/IHRoaXMuX2lucHV0TGFzdCA6IHRoaXMuX2lucHV0Rmlyc3Q7CgoKCQkJaWYgKCAoIHRoaXMuX2lucHV0Rmlyc3QudmFsKCkgPiB0aGlzLl9pbnB1dExhc3QudmFsKCkgJiYgZXZlbnQudHlwZSA9PT0gIm1vdXNlZG93biIgJiYgISQoZXZlbnQudGFyZ2V0KS5oYXNDbGFzcygidWktc2xpZGVyLWhhbmRsZSIpKSApewoJCQkJdGhpc1NsaWRlci5ibHVyKCk7CgkJCX0gZWxzZSBpZiAoIGV2ZW50LnR5cGUgPT09ICJtb3VzZWRvd24iICl7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCBtaW4gPiBtYXggJiYgIXRoaXMuX3NsaWRlclRhcmdldCApIHsKCQkJCS8vdGhpcyBwcmV2ZW50cyBtaW4gZnJvbSBiZWluZyBncmVhdGVyIHRoZW4gbWF4CgkJCQl0aGlzU2xpZGVyLnZhbCggZmlyc3QgPyBtYXg6IG1pbiApLnNsaWRlciggInJlZnJlc2giICk7CgkJCQl0aGlzLl90cmlnZ2VyKCAibm9ybWFsaXplIiApOwoJCQl9IGVsc2UgaWYgKCBtaW4gPiBtYXggKSB7CgkJCQkvL3RoaXMgbWFrZXMgaXQgc28gY2xpY2tzIG9uIHRoZSB0YXJnZXQgb24gZWl0aGVyIGV4dHJlbWUgZ28gdG8gdGhlIGNsb3Nlc3QgaGFuZGxlCgkJCQl0aGlzU2xpZGVyLnZhbCggdGhpcy5fdGFyZ2V0VmFsICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCgkJCQkvL1lvdSBtdXN0IHdhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgc28gZmlyc3Qgc2xpZGVyIGlzIHVwZGF0ZWQgYmVmb3JlIHVwZGF0aW5nIHNlY29uZAoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJb3RoZXJTbGlkZXIudmFsKCBmaXJzdCA/IG1pbjogbWF4ICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCQkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmZvY3VzKCk7CgkJCQkJc2VsZi5fc2xpZGVyRmlyc3QuY3NzKCAiei1pbmRleCIsIGZpcnN0ID8gIiIgOiAxICk7CgkJCQkJc2VsZi5fdHJpZ2dlciggIm5vcm1hbGl6ZSIgKTsKCQkJCX0sIDAgKTsKCQkJCXRoaXMuX3Byb3h5ID0gKCBmaXJzdCApID8gImZpcnN0IiA6ICJsYXN0IjsKCQkJfQoJCQkvL2ZpeGVzIGlzc3VlIHdoZXJlIHdoZW4gYm90aCBfc2xpZGVycyBhcmUgYXQgbWluIHRoZXkgY2Fubm90IGJlIGFkanVzdGVkCgkJCWlmICggbWluID09PSBtYXggKSB7CgkJCQkkLmRhdGEoIHRoaXNTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsIDEgKTsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsIDAgKTsKCQkJfSBlbHNlIHsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsICIiICk7CgkJCQkkLmRhdGEoIHRoaXNTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsICIiICk7CgkJCX0KCgkJCXRoaXMuX3VwZGF0ZUhpZ2hsaWdodCgpOwoKCQkJaWYgKCBtaW4gPj0gbWF4ICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCgkJX3VwZGF0ZUhpZ2hsaWdodDogZnVuY3Rpb24oKSB7CgkJCXZhciBtaW4gPSBwYXJzZUludCggJC5kYXRhKCB0aGlzLl9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmdldCgwKS5zdHlsZS5sZWZ0LCAxMCApLAoJCQkJbWF4ID0gcGFyc2VJbnQoICQuZGF0YSggdGhpcy5faW5wdXRMYXN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmdldCgwKS5zdHlsZS5sZWZ0LCAxMCApLAoJCQkJd2lkdGggPSAobWF4IC0gbWluKTsKCgkJCXRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXNsaWRlci1iZyIgKS5jc3MoewoJCQkJIm1hcmdpbi1sZWZ0IjogbWluICsgIiUiLAoJCQkJIndpZHRoIjogd2lkdGggKyAiJSIKCQkJfSk7CgkJfSwKCgkJX3NldFRoZW1lOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX2lucHV0Rmlyc3Quc2xpZGVyKCAib3B0aW9uIiwgInRoZW1lIiwgdmFsdWUgKTsKCQkJdGhpcy5faW5wdXRMYXN0LnNsaWRlciggIm9wdGlvbiIsICJ0aGVtZSIsIHZhbHVlICk7CgkJfSwKCgkJX3NldFRyYWNrVGhlbWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5faW5wdXRGaXJzdC5zbGlkZXIoICJvcHRpb24iLCAidHJhY2tUaGVtZSIsIHZhbHVlICk7CgkJCXRoaXMuX2lucHV0TGFzdC5zbGlkZXIoICJvcHRpb24iLCAidHJhY2tUaGVtZSIsIHZhbHVlICk7CgkJfSwKCgkJX3NldE1pbmk6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5faW5wdXRGaXJzdC5zbGlkZXIoICJvcHRpb24iLCAibWluaSIsIHZhbHVlICk7CgkJCXRoaXMuX2lucHV0TGFzdC5zbGlkZXIoICJvcHRpb24iLCAibWluaSIsIHZhbHVlICk7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLW1pbmkiLCAhIXZhbHVlICk7CgkJfSwKCgkJX3NldEhpZ2hsaWdodDogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9pbnB1dEZpcnN0LnNsaWRlciggIm9wdGlvbiIsICJoaWdobGlnaHQiLCB2YWx1ZSApOwoJCQl0aGlzLl9pbnB1dExhc3Quc2xpZGVyKCAib3B0aW9uIiwgImhpZ2hsaWdodCIsIHZhbHVlICk7CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9sYWJlbC5wcmVwZW5kVG8oIHRoaXMuZWxlbWVudCApOwoJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1yYW5nZXNsaWRlciB1aS1taW5pIiApOwoJCQl0aGlzLl9pbnB1dEZpcnN0LmFmdGVyKCB0aGlzLl9zbGlkZXJGaXJzdCApOwoJCQl0aGlzLl9pbnB1dExhc3QuYWZ0ZXIoIHRoaXMuX3NsaWRlckxhc3QgKTsKCQkJdGhpcy5fc2xpZGVycy5yZW1vdmUoKTsKCQkJdGhpcy5lbGVtZW50LmZpbmQoICJpbnB1dCIgKS5yZW1vdmVDbGFzcyggInVpLXJhbmdlc2xpZGVyLWZpcnN0IHVpLXJhbmdlc2xpZGVyLWxhc3QiICkuc2xpZGVyKCAiZGVzdHJveSIgKTsKCQl9CgoJfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS50ZXh0aW5wdXQiLCAkLm1vYmlsZS50ZXh0aW5wdXQsIHsKCQlvcHRpb25zOiB7CgkJCWNsZWFyQnRuOiBmYWxzZSwKCQkJY2xlYXJCdG5UZXh0OiAiQ2xlYXIgdGV4dCIKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCgkJCWlmICggISF0aGlzLm9wdGlvbnMuY2xlYXJCdG4gfHwgdGhpcy5pc1NlYXJjaCApewoJCQkJdGhpcy5fYWRkQ2xlYXJCdG4oKTsKCQkJfQoJCX0sCgoJCWNsZWFyQnV0dG9uOiBmdW5jdGlvbigpIHsKCgkJCXJldHVybiAkKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWlucHV0LWNsZWFyIHVpLWJ0biB1aS1pY29uLWRlbGV0ZSB1aS1idG4taWNvbi1ub3RleHQgdWktY29ybmVyLWFsbCIgKwogICAgIicgdGl0bGU9JyIgKyB0aGlzLm9wdGlvbnMuY2xlYXJCdG5UZXh0ICsgIic+IiArIHRoaXMub3B0aW9ucy5jbGVhckJ0blRleHQgKyAiPC9hPiIgKTsKCgkJfSwKCgkJX2NsZWFyQnRuQ2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdGhpcy5lbGVtZW50LnZhbCggIiIgKQoJCQkJCS5mb2N1cygpCgkJCQkJLnRyaWdnZXIoICJjaGFuZ2UiICk7CgoJCQl0aGlzLl9jbGVhckJ0bi5hZGRDbGFzcyggInVpLWlucHV0LWNsZWFyLWhpZGRlbiIgKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9LAoKCQlfYWRkQ2xlYXJCdG46IGZ1bmN0aW9uKCkgewoKCQkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQkJdGhpcy5fZW5oYW5jZUNsZWFyKCk7CgkJCX0KCgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlfY2xlYXJCdG46IHRoaXMud2lkZ2V0KCkuZmluZCgiYS51aS1pbnB1dC1jbGVhciIpCgkJCX0pOwoKCQkJdGhpcy5fYmluZENsZWFyRXZlbnRzKCk7CgoJCQl0aGlzLl90b2dnbGVDbGVhcigpOwoKCQl9LAoKCQlfZW5oYW5jZUNsZWFyOiBmdW5jdGlvbigpIHsKCgkJCXRoaXMuY2xlYXJCdXR0b24oKS5hcHBlbmRUbyggdGhpcy53aWRnZXQoKSApOwoJCQl0aGlzLndpZGdldCgpLmFkZENsYXNzKCAidWktaW5wdXQtaGFzLWNsZWFyIiApOwoKCQl9LAoKCQlfYmluZENsZWFyRXZlbnRzOiBmdW5jdGlvbigpIHsKCgkJCXRoaXMuX29uKCB0aGlzLl9jbGVhckJ0biwgewoJCQkJImNsaWNrIjogIl9jbGVhckJ0bkNsaWNrIgoJCQl9KTsKCgkJCXRoaXMuX29uKHsKCQkJCSJrZXl1cCI6ICJfdG9nZ2xlQ2xlYXIiLAoJCQkJImNoYW5nZSI6ICJfdG9nZ2xlQ2xlYXIiLAoJCQkJImlucHV0IjogIl90b2dnbGVDbGVhciIsCgkJCQkiZm9jdXMiOiAiX3RvZ2dsZUNsZWFyIiwKCQkJCSJibHVyIjogIl90b2dnbGVDbGVhciIsCgkJCQkiY3V0IjogIl90b2dnbGVDbGVhciIsCgkJCQkicGFzdGUiOiAiX3RvZ2dsZUNsZWFyIgoKCQkJfSk7CgoJCX0sCgoJCV91bmJpbmRDbGVhcjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX29mZiggdGhpcy5fY2xlYXJCdG4sICJjbGljayIpOwoJCQl0aGlzLl9vZmYoIHRoaXMuZWxlbWVudCwgImtleXVwIGNoYW5nZSBpbnB1dCBmb2N1cyBibHVyIGN1dCBwYXN0ZSIgKTsKCQl9LAoKCQlfc2V0T3B0aW9uczpmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJCWlmICggb3B0aW9ucy5jbGVhcmJ0biAhPT0gdW5kZWZpbmVkICYmICF0aGlzLmVsZW1lbnQuaXMoICJ0ZXh0YXJlYSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSIgKSApIHsKCQkJCWlmICggb3B0aW9ucy5jbGVhckJ0biApewoJCQkJCXRoaXMuX2FkZENsZWFyQnRuKCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuX2Rlc3Ryb3lDbGVhcigpOwoJCQkJfQoJCQl9CgoJCQlpZiAoIG9wdGlvbnMuY2xlYXJCdG5UZXh0ICE9PSB1bmRlZmluZWQgJiYgdGhpcy5fY2xlYXJCdG4gIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX2NsZWFyQnRuLnRleHQoIG9wdGlvbnMuY2xlYXJCdG5UZXh0ICk7CgkJCX0KCQl9LAoKCQlfdG9nZ2xlQ2xlYXI6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9kZWxheSggIl90b2dnbGVDbGVhckNsYXNzIiwgMCApOwoJCX0sCgoJCV90b2dnbGVDbGVhckNsYXNzOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fY2xlYXJCdG4udG9nZ2xlQ2xhc3MoICJ1aS1pbnB1dC1jbGVhci1oaWRkZW4iLCAhdGhpcy5lbGVtZW50LnZhbCgpICk7CgkJfSwKCgkJX2Rlc3Ryb3lDbGVhcjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWlucHV0LWhhcy1jbGVhciIgKTsKCQkJdGhpcy5fdW5iaW5kQ2xlYXIoKS5fY2xlYXJCdG4ucmVtb3ZlKCk7CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQl0aGlzLl9kZXN0cm95Q2xlYXIoKTsKCQl9CgoJfSk7CgoKfSkoIGpRdWVyeSApOwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS50ZXh0aW5wdXQiLCAkLm1vYmlsZS50ZXh0aW5wdXQsIHsKCQlvcHRpb25zOiB7CgkJCWF1dG9ncm93OnRydWUsCgkJCWtleXVwVGltZW91dEJ1ZmZlcjogMTAwCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgoJCQlpZiAoIHRoaXMub3B0aW9ucy5hdXRvZ3JvdyAmJiB0aGlzLmlzVGV4dGFyZWEgKSB7CgkJCQl0aGlzLl9hdXRvZ3JvdygpOwoJCQl9CgkJfSwKCgkJX2F1dG9ncm93OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fb24oewoJCQkJImtleXVwIjogIl90aW1lb3V0IiwKCQkJCSJjaGFuZ2UiOiAiX3RpbWVvdXQiLAoJCQkJImlucHV0IjogIl90aW1lb3V0IiwKCQkJCSJwYXN0ZSI6ICJfdGltZW91dCIsCgkJCX0pOwoKCQkJLy8gSXNzdWUgNTA5OiB0aGUgYnJvd3NlciBpcyBub3QgcHJvdmlkaW5nIHNjcm9sbEhlaWdodCBwcm9wZXJseSB1bnRpbCB0aGUgc3R5bGVzIGxvYWQKCQkJaWYgKCAkLnRyaW0oIHRoaXMuZWxlbWVudC52YWwoKSApICkgewoJCQkJLy8gYmluZCB0byB0aGUgd2luZG93IGxvYWQgdG8gbWFrZSBzdXJlIHRoZSBoZWlnaHQgaXMgY2FsY3VsYXRlZCBiYXNlZCBvbiBCT1RICgkJCQkvLyB0aGUgRE9NIGFuZCBDU1MKCQkJCS8vIGJpbmRpbmcgdG8gcGFnZWNoYW5nZSBoZXJlIGVuc3VyZXMgdGhhdCBmb3IgcGFnZXMgbG9hZGVkIHZpYQoJCQkJLy8gYWpheCB0aGUgaGVpZ2h0IGlzIHJlY2FsY3VsYXRlZCB3aXRob3V0IHVzZXIgaW5wdXQKCQkJCXRoaXMuX29uKCB0cnVlLCAkLm1vYmlsZS53aW5kb3csIHsKCQkJCQkibG9hZCI6ICJfdGltZW91dCIsCgkJCQkJInBhZ2VjaGFuZ2UiOiAiX3RpbWVvdXQiCgkJCQl9KTsKCQkJfQoJCX0sCgoJCV91bmJpbmRBdXRvZ3JvdzogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX29mZiggdGhpcy5lbGVtZW50LCAia2V5dXAgY2hhbmdlIGlucHV0IHBhc3RlIiApOwoJCQl0aGlzLl9vZmYoICQubW9iaWxlLndpbmRvdywgImxvYWQgcGFnZWNoYW5nZSIgKTsKCQl9LAoKCQlrZXl1cFRpbWVvdXQ6bnVsbCwKCgkJX3RpbWVvdXQ6IGZ1bmN0aW9uKCkgewoJCQljbGVhclRpbWVvdXQoIHRoaXMua2V5dXBUaW1lb3V0ICk7CgkJCXRoaXMua2V5dXBUaW1lb3V0ID0gdGhpcy5fZGVsYXkoICJfdXBkYXRlSGVpZ2h0IiwgdGhpcy5vcHRpb25zLmtleXVwVGltZW91dEJ1ZmZlciApOwoJCX0sCgoJCV91cGRhdGVIZWlnaHQ6ZnVuY3Rpb24oKSB7CgoJCQl0aGlzLmVsZW1lbnQuY3NzKCAiaGVpZ2h0IiwgIjBweCIgKTsKCgkJCXZhciBwYWRkaW5nVG9wLCBwYWRkaW5nQm90dG9tLCBwYWRkaW5nSGVpZ2h0LAoJCQkJc2Nyb2xsSGVpZ2h0ID0gdGhpcy5lbGVtZW50WyAwIF0uc2Nyb2xsSGVpZ2h0LAoJCQkJY2xpZW50SGVpZ2h0ID0gdGhpcy5lbGVtZW50WyAwIF0uY2xpZW50SGVpZ2h0LAoJCQkJYm9yZGVyVG9wID0gcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LmNzcyggImJvcmRlci10b3Atd2lkdGgiICkgKSwKCQkJCWJvcmRlckJvdHRvbSA9IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC5jc3MoICJib3JkZXItYm90dG9tLXdpZHRoIiApICksCgkJCQlib3JkZXJIZWlnaHQgPSBib3JkZXJUb3AgKyBib3JkZXJCb3R0b20sCgkJCQloZWlnaHQgPSBzY3JvbGxIZWlnaHQgKyBib3JkZXJIZWlnaHQgKyAxNTsKCgkJCS8vIElzc3VlIDYxNzk6IFBhZGRpbmcgaXMgbm90IGluY2x1ZGVkIGluIHNjcm9sbEhlaWdodCBhbmQKCQkJLy8gY2xpZW50SGVpZ2h0IGJ5IEZpcmVmb3ggaWYgbm8gc2Nyb2xsYmFyIGlzIHZpc2libGUuIEJlY2F1c2UKCQkJLy8gdGV4dGFyZWFzIHVzZSB0aGUgYm9yZGVyLWJveCBib3gtc2l6aW5nIG1vZGVsLCBwYWRkaW5nIHNob3VsZCBiZQoJCQkvLyBpbmNsdWRlZCBpbiB0aGUgbmV3IChhc3NpZ25lZCkgaGVpZ2h0LiBCZWNhdXNlIHRoZSBoZWlnaHQgaXMgc2V0CgkJCS8vIHRvIDAsIGNsaWVudEhlaWdodCA9PSAwIGluIEZpcmVmb3guIFRoZXJlZm9yZSwgd2UgY2FuIHVzZSB0aGlzIHRvCgkJCS8vIGNoZWNrIGlmIHBhZGRpbmcgbXVzdCBiZSBhZGRlZC4KCQkJaWYgKCBjbGllbnRIZWlnaHQgPT09IDAgKSB7CgkJCQlwYWRkaW5nVG9wID0gcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LmNzcyggInBhZGRpbmctdG9wIiApICk7CgkJCQlwYWRkaW5nQm90dG9tID0gcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LmNzcyggInBhZGRpbmctYm90dG9tIiApICk7CgkJCQlwYWRkaW5nSGVpZ2h0ID0gcGFkZGluZ1RvcCArIHBhZGRpbmdCb3R0b207CgoJCQkJaGVpZ2h0ICs9IHBhZGRpbmdIZWlnaHQ7CgkJCX0KCgkJCXRoaXMuZWxlbWVudC5jc3MoICJoZWlnaHQiLCBoZWlnaHQgKyAicHgiICk7CgkJfSwKCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICl7CgoJCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoKCQkJaWYgKCBvcHRpb25zLmF1dG9ncm93ICE9PSB1bmRlZmluZWQgJiYgdGhpcy5pc1RleHRhcmVhICl7CgkJCQlpZiAoIG9wdGlvbnMuYXV0b2dyb3cgKXsKCQkJCQl0aGlzLl9hdXRvZ3JvdygpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLl91bmJpbmRBdXRvZ3JvdygpOwoJCQkJfQoJCQl9CgkJfQoKCX0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnNlbGVjdG1lbnUiLCAkLmV4dGVuZCggewoJaW5pdFNlbGVjdG9yOiAic2VsZWN0Om5vdCggOmpxbURhdGEocm9sZT0nc2xpZGVyJykpOm5vdCggOmpxbURhdGEocm9sZT0nZmxpcHN3aXRjaCcpICkiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQlkaXNhYmxlZDogZmFsc2UsCgkJaWNvbjogImNhcmF0LWQiLAoJCWljb25wb3M6ICJyaWdodCIsCgkJaW5saW5lOiBmYWxzZSwKCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpY29uc2hhZG93OiBmYWxzZSwgLyogVE9ETzogRGVwcmVjYXRlZCBpbiAxLjQsIHJlbW92ZSBpbiAxLjUuICovCgkJb3ZlcmxheVRoZW1lOiBudWxsLAoJCWRpdmlkZXJUaGVtZTogbnVsbCwKCQloaWRlUGxhY2Vob2xkZXJNZW51SXRlbXM6IHRydWUsCgkJY2xvc2VUZXh0OiAiQ2xvc2UiLAoJCW5hdGl2ZU1lbnU6IHRydWUsCgkJLy8gVGhpcyBvcHRpb24gZGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MgZGV2aWNlcy4KCQlwcmV2ZW50Rm9jdXNab29tOiAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSwKCQltaW5pOiBmYWxzZQoJfSwKCglfYnV0dG9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJCggIjxkaXYvPiIgKTsKCX0sCgoJX3NldERpc2FibGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHZhbHVlICk7CgkJdGhpcy5idXR0b24uYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHZhbHVlICk7Cgl9LAoKCV9mb2N1c0J1dHRvbiA6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCXNlbGYuYnV0dG9uLmZvY3VzKCk7CgkJfSwgNDApOwoJfSwKCglfc2VsZWN0T3B0aW9uczogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuc2VsZWN0LmZpbmQoICJvcHRpb24iICk7Cgl9LAoKCS8vIHNldHVwIGl0ZW1zIHRoYXQgYXJlIGdlbmVyYWxseSBuZWNlc3NhcnkgZm9yIHNlbGVjdCBtZW51IGV4dGVuc2lvbgoJX3ByZUV4dGVuc2lvbjogZnVuY3Rpb24oKSB7CgkJdmFyIGlubGluZSA9IHRoaXMub3B0aW9ucy5pbmxpbmUgfHwgdGhpcy5lbGVtZW50LmpxbURhdGEoICJpbmxpbmUiICksCgkJCW1pbmkgPSB0aGlzLm9wdGlvbnMubWluaSB8fCB0aGlzLmVsZW1lbnQuanFtRGF0YSggIm1pbmkiICksCgkJCWNsYXNzZXMgPSAiIjsKCQkvLyBUT0RPOiBQb3N0IDEuMS0tb25jZSB3ZSBoYXZlIHRpbWUgdG8gdGVzdCB0aG9yb3VnaGx5LS1hbnkgY2xhc3NlcyBtYW51YWxseSBhcHBsaWVkIHRvIHRoZSBvcmlnaW5hbCBlbGVtZW50IHNob3VsZCBiZSBjYXJyaWVkIG92ZXIgdG8gdGhlIGVuaGFuY2VkIGVsZW1lbnQsIHdpdGggYW4gYC1lbmhhbmNlZGAgc3VmZml4LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTc3CgkJLyogaWYgKCAkZWxbMF0uY2xhc3NOYW1lLmxlbmd0aCApIHsKCQkJY2xhc3NlcyA9ICRlbFswXS5jbGFzc05hbWU7CgkJfSAqLwoJCWlmICggISF+dGhpcy5lbGVtZW50WzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLWxlZnQiICkgKSB7CgkJCWNsYXNzZXMgPSAiIHVpLWJ0bi1sZWZ0IjsKCQl9CgoJCWlmICggICEhfnRoaXMuZWxlbWVudFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1yaWdodCIgKSApIHsKCQkJY2xhc3NlcyA9ICIgdWktYnRuLXJpZ2h0IjsKCQl9CgoJCWlmICggaW5saW5lICkgewoJCQljbGFzc2VzICs9ICIgdWktYnRuLWlubGluZSI7CgkJfQoJCWlmICggbWluaSApIHsKCQkJY2xhc3NlcyArPSAiIHVpLW1pbmkiOwoJCX0KCgkJdGhpcy5zZWxlY3QgPSB0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1idG4tbGVmdCB1aS1idG4tcmlnaHQiICkud3JhcCggIjxkaXYgY2xhc3M9J3VpLXNlbGVjdCIgKyBjbGFzc2VzICsgIic+IiApOwoJCXRoaXMuc2VsZWN0SWQgID0gdGhpcy5zZWxlY3QuYXR0ciggImlkIiApIHx8ICggInNlbGVjdC0iICsgdGhpcy51dWlkICk7CgkJdGhpcy5idXR0b25JZCA9IHRoaXMuc2VsZWN0SWQgKyAiLWJ1dHRvbiI7CgkJdGhpcy5sYWJlbCA9ICQoICJsYWJlbFtmb3I9JyIrIHRoaXMuc2VsZWN0SWQgKyInXSIgKTsKCQl0aGlzLmlzTXVsdGlwbGUgPSB0aGlzLnNlbGVjdFsgMCBdLm11bHRpcGxlOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIHdyYXBwZXIgPSB0aGlzLmVsZW1lbnQucGFyZW50cyggIi51aS1zZWxlY3QiICk7CgkJaWYgKCB3cmFwcGVyLmxlbmd0aCA+IDAgKSB7CgkJCWlmICggd3JhcHBlci5pcyggIi51aS1idG4tbGVmdCwgLnVpLWJ0bi1yaWdodCIgKSApIHsKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggd3JhcHBlci5oYXNDbGFzcyggInVpLWJ0bi1sZWZ0IiApID8gInVpLWJ0bi1sZWZ0IiA6ICJ1aS1idG4tcmlnaHQiICk7CgkJCX0KCQkJdGhpcy5lbGVtZW50Lmluc2VydEFmdGVyKCB3cmFwcGVyICk7CgkJCXdyYXBwZXIucmVtb3ZlKCk7CgkJfQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9wcmVFeHRlbnNpb24oKTsKCgkJdGhpcy5idXR0b24gPSB0aGlzLl9idXR0b24oKTsKCgkJdmFyIHNlbGYgPSB0aGlzLAoKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCgkJCWljb25wb3MgPSBvcHRpb25zLmljb24gPyAoIG9wdGlvbnMuaWNvbnBvcyB8fCB0aGlzLnNlbGVjdC5qcW1EYXRhKCAiaWNvbnBvcyIgKSApIDogZmFsc2UsCgoJCQlidXR0b24gPSB0aGlzLmJ1dHRvbgoJCQkJLmluc2VydEJlZm9yZSggdGhpcy5zZWxlY3QgKQoJCQkJLmF0dHIoICJpZCIsIHRoaXMuYnV0dG9uSWQgKQoJCQkJLmFkZENsYXNzKCAidWktYnRuIiArCgkJCQkJKCBvcHRpb25zLmljb24gPyAoICIgdWktaWNvbi0iICsgb3B0aW9ucy5pY29uICsgIiB1aS1idG4taWNvbi0iICsgaWNvbnBvcyArCgkJCQkJKCBvcHRpb25zLmljb25zaGFkb3cgPyAiIHVpLXNoYWRvdy1pY29uIiA6ICIiICkgKSA6CSIiICkgKyAvKiBUT0RPOiBSZW1vdmUgaW4gMS41LiAqLwoJCQkJCSggb3B0aW9ucy50aGVtZSA/ICIgdWktYnRuLSIgKyBvcHRpb25zLnRoZW1lIDogIiIgKSArCgkJCQkJKCBvcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIgKSArCgkJCQkJKCBvcHRpb25zLnNoYWRvdyA/ICIgdWktc2hhZG93IiA6ICIiICkgKTsKCgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgoJCS8vIE9wZXJhIGRvZXMgbm90IHByb3Blcmx5IHN1cHBvcnQgb3BhY2l0eSBvbiBzZWxlY3QgZWxlbWVudHMKCQkvLyBJbiBNaW5pLCBpdCBoaWRlcyB0aGUgZWxlbWVudCwgYnV0IG5vdCBpdHMgdGV4dAoJCS8vIE9uIHRoZSBkZXNrdG9wLGl0IHNlZW1zIHRvIGRvIHRoZSBvcHBvc2l0ZQoJCS8vIGZvciB0aGVzZSByZWFzb25zLCB1c2luZyB0aGUgbmF0aXZlTWVudSBvcHRpb24gcmVzdWx0cyBpbiBhIGZ1bGwgbmF0aXZlIHNlbGVjdCBpbiBPcGVyYQoJCWlmICggb3B0aW9ucy5uYXRpdmVNZW51ICYmIHdpbmRvdy5vcGVyYSAmJiB3aW5kb3cub3BlcmEudmVyc2lvbiApIHsKCQkJYnV0dG9uLmFkZENsYXNzKCAidWktc2VsZWN0LW5hdGl2ZW9ubHkiICk7CgkJfQoKCQkvLyBBZGQgY291bnRlciBmb3IgbXVsdGkgc2VsZWN0cwoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQl0aGlzLmJ1dHRvbkNvdW50ID0gJCggIjxzcGFuPiIgKQoJCQkJLmFkZENsYXNzKCAidWktbGktY291bnQgdWktYm9keS1pbmhlcml0IiApCgkJCQkuaGlkZSgpCgkJCQkuYXBwZW5kVG8oIGJ1dHRvbi5hZGRDbGFzcyggInVpLWxpLWhhcy1jb3VudCIgKSApOwoJCX0KCgkJLy8gRGlzYWJsZSBpZiBzcGVjaWZpZWQKCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIgKSkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCS8vIEV2ZW50cyBvbiBuYXRpdmUgc2VsZWN0CgkJdGhpcy5zZWxlY3QuY2hhbmdlKGZ1bmN0aW9uKCkgewoJCQlzZWxmLnJlZnJlc2goKTsKCgkJCWlmICggISFvcHRpb25zLm5hdGl2ZU1lbnUgKSB7CgkJCQl0aGlzLmJsdXIoKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCgkJdGhpcy5idWlsZCgpOwoJfSwKCglidWlsZDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLnNlbGVjdAoJCQkuYXBwZW5kVG8oIHNlbGYuYnV0dG9uICkKCQkJLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBBZGQgYWN0aXZlIGNsYXNzIHRvIGJ1dHRvbgoJCQkJc2VsZi5idXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJmb2N1cyB2bW91c2VvdmVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3ZlciIgKTsKCQkJfSkKCQkJLmJpbmQoICJ2bW91c2Vtb3ZlIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBSZW1vdmUgYWN0aXZlIGNsYXNzIG9uIHNjcm9sbC90b3VjaG1vdmUKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImNoYW5nZSBibHVyIHZtb3VzZW91dCIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24udHJpZ2dlciggInZtb3VzZW91dCIgKQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSk7CgoJCS8vIEluIG1hbnkgc2l0dWF0aW9ucywgaU9TIHdpbGwgem9vbSBpbnRvIHRoZSBzZWxlY3QgdXBvbiB0YXAsIHRoaXMgcHJldmVudHMgdGhhdCBmcm9tIGhhcHBlbmluZwoJCXNlbGYuYnV0dG9uLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCQlzZWxmLmxhYmVsLmJpbmQoICJjbGljayBmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7CgkJc2VsZi5zZWxlY3QuYmluZCggImZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCQlzZWxmLmJ1dHRvbi5iaW5kKCAibW91c2V1cCIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQkJfSwgMCApOwoJCQl9CgkJfSk7CgkJc2VsZi5zZWxlY3QuYmluZCggImJsdXIiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCgl9LAoKCXNlbGVjdGVkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZCIgKTsKCX0sCgoJc2VsZWN0ZWRJbmRpY2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXJldHVybiB0aGlzLnNlbGVjdGVkKCkubWFwKGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gc2VsZi5fc2VsZWN0T3B0aW9ucygpLmluZGV4KCB0aGlzICk7CgkJfSkuZ2V0KCk7Cgl9LAoKCXNldEJ1dHRvblRleHQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJc2VsZWN0ZWQgPSB0aGlzLnNlbGVjdGVkKCksCgkJCXRleHQgPSB0aGlzLnBsYWNlaG9sZGVyLAoJCQlzcGFuID0gJCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgKTsKCgkJdGhpcy5idXR0b24uY2hpbGRyZW4oICJzcGFuIiApLm5vdCggIi51aS1saS1jb3VudCIgKS5yZW1vdmUoKS5lbmQoKS5lbmQoKS5wcmVwZW5kKCAoZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZWN0ZWQubGVuZ3RoICkgewoJCQkJdGV4dCA9IHNlbGVjdGVkLm1hcChmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gJCggdGhpcyApLnRleHQoKTsKCQkJCX0pLmdldCgpLmpvaW4oICIsICIgKTsKCQkJfSBlbHNlIHsKCQkJCXRleHQgPSBzZWxmLnBsYWNlaG9sZGVyOwoJCQl9CgoJCQlpZiAoIHRleHQgKSB7CgkJCQlzcGFuLnRleHQoIHRleHQgKTsKCQkJfSBlbHNlIHsKCQkJCXNwYW4uaHRtbCggIiZuYnNwOyIgKTsKCQkJfQoKCQkJLy8gVE9ETyBwb3NzaWJseSBhZ2dyZWdhdGUgbXVsdGlwbGUgc2VsZWN0IG9wdGlvbiBjbGFzc2VzCgkJCXJldHVybiBzcGFuCgkJCQkuYWRkQ2xhc3MoIHNlbGYuc2VsZWN0LmF0dHIoICJjbGFzcyIgKSApCgkJCQkuYWRkQ2xhc3MoIHNlbGVjdGVkLmF0dHIoICJjbGFzcyIgKSApCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0pKCkpOwoJfSwKCglzZXRCdXR0b25Db3VudDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpOwoKCQkvLyBtdWx0aXBsZSBjb3VudCBpbnNpZGUgYnV0dG9uCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnRbIHNlbGVjdGVkLmxlbmd0aCA+IDEgPyAic2hvdyIgOiAiaGlkZSIgXSgpLnRleHQoIHNlbGVjdGVkLmxlbmd0aCApOwoJCX0KCX0sCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgkJdGhpcy5zZXRCdXR0b25Db3VudCgpOwoJfSwKCgkvLyBvcGVuIGFuZCBjbG9zZSBwcmVzZXJ2ZWQgaW4gbmF0aXZlIHNlbGVjdHMKCS8vIHRvIHNpbXBsaWZ5IHVzZXJzIGNvZGUgd2hlbiBsb29waW5nIG92ZXIgc2VsZWN0cwoJb3BlbjogJC5ub29wLAoJY2xvc2U6ICQubm9vcCwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXREaXNhYmxlZCggdHJ1ZSApOwoJCXRoaXMuYnV0dG9uLmFkZENsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmxpbmtzID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCgkvL2xpbmtzIHdpdGhpbiBjb250ZW50IGFyZWFzLCB0ZXN0cyBpbmNsdWRlZCB3aXRoIHBhZ2UKCSQoIHRhcmdldCApCgkJLmZpbmQoICJhIiApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkuZmlsdGVyKCAiOmpxbURhdGEocmVsPSdwb3B1cCcpW2hyZWZdW2hyZWYhPScnXSIgKQoJCS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJLy8gQWNjZXNzaWJpbGl0eSBpbmZvIGZvciBwb3B1cHMKCQkJdmFyIGUgPSB0aGlzLAoJCQkJaHJlZiA9ICQoIHRoaXMgKS5hdHRyKCAiaHJlZiIgKSwKCQkJCXNlbCA9ICQubW9iaWxlLnBhdGguaGFzaFRvU2VsZWN0b3IoIGhyZWYgKSwKCQkJCWlkcmVmID0gaHJlZi5zdWJzdHJpbmcoIDEgKTsKCgkJCWUuc2V0QXR0cmlidXRlKCAiYXJpYS1oYXNwb3B1cCIsIHRydWUgKTsKCQkJZS5zZXRBdHRyaWJ1dGUoICJhcmlhLW93bnMiLCBpZHJlZiApOwoJCQllLnNldEF0dHJpYnV0ZSggImFyaWEtZXhwYW5kZWQiLCBmYWxzZSApOwoJCQkkKCBkb2N1bWVudCApCgkJCQkub24oICJwb3B1cGFmdGVyb3BlbiIsIHNlbCwgZnVuY3Rpb24oKSB7CgkJCQkJZS5zZXRBdHRyaWJ1dGUoICJhcmlhLWV4cGFuZGVkIiwgdHJ1ZSApOwoJCQkJfSkKCQkJCS5vbiggInBvcHVwYWZ0ZXJjbG9zZSIsIHNlbCwgZnVuY3Rpb24oKSB7CgkJCQkJZS5zZXRBdHRyaWJ1dGUoICJhcmlhLWV4cGFuZGVkIiwgZmFsc2UgKTsKCQkJCX0pOwoJCX0pCgkJLmVuZCgpCgkJLm5vdCggIi51aS1idG4sIDpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIiApCgkJLmFkZENsYXNzKCAidWktbGluayIgKTsKCn07Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgpmdW5jdGlvbiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggd2luZG93U2l6ZSwgc2VnbWVudFNpemUsIG9mZnNldCwgZGVzaXJlZCApIHsKCXZhciByZXR1cm5WYWx1ZSA9IGRlc2lyZWQ7CgoJaWYgKCB3aW5kb3dTaXplIDwgc2VnbWVudFNpemUgKSB7CgkJLy8gQ2VudGVyIHNlZ21lbnQgaWYgaXQncyBiaWdnZXIgdGhhbiB0aGUgd2luZG93CgkJcmV0dXJuVmFsdWUgPSBvZmZzZXQgKyAoIHdpbmRvd1NpemUgLSBzZWdtZW50U2l6ZSApIC8gMjsKCX0gZWxzZSB7CgkJLy8gT3RoZXJ3aXNlIGNlbnRlciBpdCBhdCB0aGUgZGVzaXJlZCBjb29yZGluYXRlIHdoaWxlIGtlZXBpbmcgaXQgY29tcGxldGVseSBpbnNpZGUgdGhlIHdpbmRvdwoJCXJldHVyblZhbHVlID0gTWF0aC5taW4oIE1hdGgubWF4KCBvZmZzZXQsIGRlc2lyZWQgLSBzZWdtZW50U2l6ZSAvIDIgKSwgb2Zmc2V0ICsgd2luZG93U2l6ZSAtIHNlZ21lbnRTaXplICk7Cgl9CgoJcmV0dXJuIHJldHVyblZhbHVlOwp9CgpmdW5jdGlvbiBnZXRXaW5kb3dDb29yZGluYXRlcygpIHsKCXZhciB0aGVXaW5kb3cgPSAkLm1vYmlsZS53aW5kb3c7CgoJcmV0dXJuIHsKCQl4OiB0aGVXaW5kb3cuc2Nyb2xsTGVmdCgpLAoJCXk6IHRoZVdpbmRvdy5zY3JvbGxUb3AoKSwKCQljeDogKCB3aW5kb3cuaW5uZXJXaWR0aCB8fCB0aGVXaW5kb3cud2lkdGgoKSApLAoJCWN5OiAoIHdpbmRvdy5pbm5lckhlaWdodCB8fCB0aGVXaW5kb3cuaGVpZ2h0KCkgKQoJfTsKfQoKJC53aWRnZXQoICJtb2JpbGUucG9wdXAiLCB7CglvcHRpb25zOiB7CgkJd3JhcHBlckNsYXNzOiBudWxsLAoJCXRoZW1lOiBudWxsLAoJCW92ZXJsYXlUaGVtZTogbnVsbCwKCQlzaGFkb3c6IHRydWUsCgkJY29ybmVyczogdHJ1ZSwKCQl0cmFuc2l0aW9uOiAibm9uZSIsCgkJcG9zaXRpb25UbzogIm9yaWdpbiIsCgkJdG9sZXJhbmNlOiBudWxsLAoJCWNsb3NlTGlua1NlbGVjdG9yOiAiYTpqcW1EYXRhKHJlbD0nYmFjaycpIiwKCQljbG9zZUxpbmtFdmVudHM6ICJjbGljay5wb3B1cCIsCgkJbmF2aWdhdGVFdmVudHM6ICJuYXZpZ2F0ZS5wb3B1cCIsCgkJY2xvc2VFdmVudHM6ICJuYXZpZ2F0ZS5wb3B1cCBwYWdlYmVmb3JlY2hhbmdlLnBvcHVwIiwKCQlkaXNtaXNzaWJsZTogdHJ1ZSwKCQllbmhhbmNlZDogZmFsc2UsCgoJCS8vIE5PVEUgV2luZG93cyBQaG9uZSA3IGhhcyBhIHNjcm9sbCBwb3NpdGlvbiBjYWNoaW5nIGlzc3VlIHRoYXQKCQkvLyAgICAgIHJlcXVpcmVzIHVzIHRvIGRpc2FibGUgcG9wdXAgaGlzdG9yeSBtYW5hZ2VtZW50IGJ5IGRlZmF1bHQKCQkvLyAgICAgIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDc4NAoJCS8vCgkJLy8gTk9URSB0aGlzIG9wdGlvbiBpcyBtb2RpZmllZCBpbiBfY3JlYXRlIQoJCWhpc3Rvcnk6ICEkLm1vYmlsZS5icm93c2VyLm9sZElFCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGVFbGVtZW50ID0gdGhpcy5lbGVtZW50LAoJCQlteUlkID0gdGhlRWxlbWVudC5hdHRyKCAiaWQiICksCgkJCWN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQkvLyBXZSBuZWVkIHRvIGFkanVzdCB0aGUgaGlzdG9yeSBvcHRpb24gdG8gYmUgZmFsc2UgaWYgdGhlcmUncyBubyBBSkFYIG5hdi4KCQkvLyBXZSBjYW4ndCBkbyBpdCBpbiB0aGUgb3B0aW9uIGRlY2xhcmF0aW9ucyBiZWNhdXNlIHRob3NlIGFyZSBydW4gYmVmb3JlCgkJLy8gaXQgaXMgZGV0ZXJtaW5lZCB3aGV0aGVyIHRoZXJlIHNoYWxsIGJlIEFKQVggbmF2LgoJCWN1cnJlbnRPcHRpb25zLmhpc3RvcnkgPSBjdXJyZW50T3B0aW9ucy5oaXN0b3J5ICYmICQubW9iaWxlLmFqYXhFbmFibGVkICYmICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkOwoKCQkvLyBEZWZpbmUgaW5zdGFuY2UgdmFyaWFibGVzCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3Njcm9sbFRvcDogMCwKCQkJX3BhZ2U6IHRoZUVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLAoJCQlfdWk6IG51bGwsCgkJCV9mYWxsYmFja1RyYW5zaXRpb246ICIiLAoJCQlfY3VycmVudFRyYW5zaXRpb246IGZhbHNlLAoJCQlfcHJlcmVxdWlzaXRlczogbnVsbCwKCQkJX2lzT3BlbjogZmFsc2UsCgkJCV90b2xlcmFuY2U6IG51bGwsCgkJCV9yZXNpemVEYXRhOiBudWxsLAoJCQlfaWdub3JlUmVzaXplVG86IDAsCgkJCV9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3M6IGZhbHNlCgkJfSk7CgoJCWlmICggdGhpcy5fcGFnZS5sZW5ndGggPT09IDAgKSB7CgkJCXRoaXMuX3BhZ2UgPSAkKCAiYm9keSIgKTsKCQl9CgoJCWlmICggY3VycmVudE9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX3VpID0gewoJCQkJY29udGFpbmVyOiB0aGVFbGVtZW50LnBhcmVudCgpLAoJCQkJc2NyZWVuOiB0aGVFbGVtZW50LnBhcmVudCgpLnByZXYoKSwKCQkJCXBsYWNlaG9sZGVyOiAkKCB0aGlzLmRvY3VtZW50WyAwIF0uZ2V0RWxlbWVudEJ5SWQoIG15SWQgKyAiLXBsYWNlaG9sZGVyIiApICkKCQkJfTsKCQl9IGVsc2UgewoJCQl0aGlzLl91aSA9IHRoaXMuX2VuaGFuY2UoIHRoZUVsZW1lbnQsIG15SWQgKTsKCQkJdGhpcwoJCQkJLl9hcHBseVRyYW5zaXRpb24oIGN1cnJlbnRPcHRpb25zLnRyYW5zaXRpb24gKQoJCQkJLl9zZXRUb2xlcmFuY2UoIGN1cnJlbnRPcHRpb25zLnRvbGVyYW5jZSApOwoJCX0KCQl0aGlzLl91aS5mb2N1c0VsZW1lbnQgPSB0aGlzLl91aS5jb250YWluZXI7CgoJCS8vIEV2ZW50IGhhbmRsZXJzCgkJdGhpcy5fb24oIHRoaXMuX3VpLnNjcmVlbiwgeyAidmNsaWNrIjogIl9lYXRFdmVudEFuZENsb3NlIiB9ICk7CgkJdGhpcy5fb24oICQubW9iaWxlLndpbmRvdywgewoJCQlvcmllbnRhdGlvbmNoYW5nZTogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dPcmllbnRhdGlvbmNoYW5nZSIgKSwKCQkJcmVzaXplOiAkLnByb3h5KCB0aGlzLCAiX2hhbmRsZVdpbmRvd1Jlc2l6ZSIgKSwKCQkJa2V5dXA6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93S2V5VXAiICkKCQl9KTsKCQl0aGlzLl9vbiggJC5tb2JpbGUuZG9jdW1lbnQsIHsgImZvY3VzaW4iOiAiX2hhbmRsZURvY3VtZW50Rm9jdXNJbiIgfSApOwoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24oIHRoZUVsZW1lbnQsIG15SWQgKSB7CgkJdmFyIGN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQl3cmFwcGVyQ2xhc3MgPSBjdXJyZW50T3B0aW9ucy53cmFwcGVyQ2xhc3MsCgkJCXVpID0gewoJCQkJc2NyZWVuOiAkKCAiPGRpdiBjbGFzcz0ndWktc2NyZWVuLWhpZGRlbiB1aS1wb3B1cC1zY3JlZW4gIiArCgkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLW92ZXJsYXktIiwgY3VycmVudE9wdGlvbnMub3ZlcmxheVRoZW1lICkgKyAiJz48L2Rpdj4iICksCgkJCQlwbGFjZWhvbGRlcjogJCggIjxkaXYgc3R5bGU9J2Rpc3BsYXk6IG5vbmU7Jz48IS0tIHBsYWNlaG9sZGVyIC0tPjwvZGl2PiIgKSwKCQkJCWNvbnRhaW5lcjogJCggIjxkaXYgY2xhc3M9J3VpLXBvcHVwLWNvbnRhaW5lciB1aS1wb3B1cC1oaWRkZW4gdWktcG9wdXAtdHJ1bmNhdGUiICsKCQkJCQkoIHdyYXBwZXJDbGFzcyA/ICggIiAiICsgd3JhcHBlckNsYXNzICkgOiAiIiApICsgIic+PC9kaXY+IiApCgkJCX0sCgkJCWZyYWdtZW50ID0gdGhpcy5kb2N1bWVudFsgMCBdLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKCgkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIHVpLnNjcmVlblsgMCBdICk7CgkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIHVpLmNvbnRhaW5lclsgMCBdICk7CgoJCWlmICggbXlJZCApIHsKCQkJdWkuc2NyZWVuLmF0dHIoICJpZCIsIG15SWQgKyAiLXNjcmVlbiIgKTsKCQkJdWkuY29udGFpbmVyLmF0dHIoICJpZCIsIG15SWQgKyAiLXBvcHVwIiApOwoJCQl1aS5wbGFjZWhvbGRlcgoJCQkJLmF0dHIoICJpZCIsIG15SWQgKyAiLXBsYWNlaG9sZGVyIiApCgkJCQkuaHRtbCggIjwhLS0gcGxhY2Vob2xkZXIgZm9yICIgKyBteUlkICsgIiAtLT4iICk7CgkJfQoKCQkvLyBBcHBseSB0aGUgcHJvdG8KCQl0aGlzLl9wYWdlWyAwIF0uYXBwZW5kQ2hpbGQoIGZyYWdtZW50ICk7CgkJLy8gTGVhdmUgYSBwbGFjZWhvbGRlciB3aGVyZSB0aGUgZWxlbWVudCB1c2VkIHRvIGJlCgkJdWkucGxhY2Vob2xkZXIuaW5zZXJ0QWZ0ZXIoIHRoZUVsZW1lbnQgKTsKCQl0aGVFbGVtZW50CgkJCS5kZXRhY2goKQoJCQkuYWRkQ2xhc3MoICJ1aS1wb3B1cCAiICsKCQkJCXRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBjdXJyZW50T3B0aW9ucy50aGVtZSApICsgIiAiICsKCQkJCSggY3VycmVudE9wdGlvbnMuc2hhZG93ID8gInVpLW92ZXJsYXktc2hhZG93ICIgOiAiIiApICsKCQkJCSggY3VycmVudE9wdGlvbnMuY29ybmVycyA/ICJ1aS1jb3JuZXItYWxsICIgOiAiIiApICkKCQkJLmFwcGVuZFRvKCB1aS5jb250YWluZXIgKTsKCgkJcmV0dXJuIHVpOwoJfSwKCglfZWF0RXZlbnRBbmRDbG9zZTogZnVuY3Rpb24oIHRoZUV2ZW50ICkgewoJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJdGhlRXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzbWlzc2libGUgKSB7CgkJCXRoaXMuY2xvc2UoKTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCgkvLyBNYWtlIHN1cmUgdGhlIHNjcmVlbiBzaXplIGlzIGluY3JlYXNlZCBiZXlvbmQgdGhlIHBhZ2UgaGVpZ2h0IGlmIHRoZSBwb3B1cCdzIGNhdXNlcyB0aGUgZG9jdW1lbnQgdG8gaW5jcmVhc2UgaW4gaGVpZ2h0CglfcmVzaXplU2NyZWVuOiBmdW5jdGlvbigpIHsKCQl2YXIgcG9wdXBIZWlnaHQgPSB0aGlzLl91aS5jb250YWluZXIub3V0ZXJIZWlnaHQoIHRydWUgKTsKCgkJdGhpcy5fdWkuc2NyZWVuLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCQlpZiAoIHBvcHVwSGVpZ2h0ID4gdGhpcy5fdWkuc2NyZWVuLmhlaWdodCgpICkgewoJCQl0aGlzLl91aS5zY3JlZW4uaGVpZ2h0KCBwb3B1cEhlaWdodCApOwoJCX0KCX0sCgoJX2hhbmRsZVdpbmRvd0tleVVwOiBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gJiYgdGhlRXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5FU0NBUEUgKSB7CgkJCXJldHVybiB0aGlzLl9lYXRFdmVudEFuZENsb3NlKCB0aGVFdmVudCApOwoJCX0KCX0sCgoJX2V4cGVjdFJlc2l6ZUV2ZW50OiBmdW5jdGlvbigpIHsKCQl2YXIgd2luZG93Q29vcmRpbmF0ZXMgPSBnZXRXaW5kb3dDb29yZGluYXRlcygpOwoKCQlpZiAoIHRoaXMuX3Jlc2l6ZURhdGEgKSB7CgkJCWlmICggd2luZG93Q29vcmRpbmF0ZXMueCA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5kb3dDb29yZGluYXRlcy54ICYmCgkJCQl3aW5kb3dDb29yZGluYXRlcy55ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbmRvd0Nvb3JkaW5hdGVzLnkgJiYKCQkJCXdpbmRvd0Nvb3JkaW5hdGVzLmN4ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbmRvd0Nvb3JkaW5hdGVzLmN4ICYmCgkJCQl3aW5kb3dDb29yZGluYXRlcy5jeSA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5kb3dDb29yZGluYXRlcy5jeSApIHsKCQkJCS8vIHRpbWVvdXQgbm90IHJlZnJlc2hlZAoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9IGVsc2UgewoJCQkJLy8gY2xlYXIgZXhpc3RpbmcgdGltZW91dCAtIGl0IHdpbGwgYmUgcmVmcmVzaGVkIGJlbG93CgkJCQljbGVhclRpbWVvdXQoIHRoaXMuX3Jlc2l6ZURhdGEudGltZW91dElkICk7CgkJCX0KCQl9CgoJCXRoaXMuX3Jlc2l6ZURhdGEgPSB7CgkJCXRpbWVvdXRJZDogdGhpcy5fZGVsYXkoICJfcmVzaXplVGltZW91dCIsIDIwMCApLAoJCQl3aW5kb3dDb29yZGluYXRlczogd2luZG93Q29vcmRpbmF0ZXMKCQl9OwoKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJX3Jlc2l6ZVRpbWVvdXQ6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQlpZiAoICF0aGlzLl9leHBlY3RSZXNpemVFdmVudCgpICkgewoJCQkJaWYgKCB0aGlzLl91aS5jb250YWluZXIuaGFzQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICkgKSB7CgkJCQkJLy8gZWZmZWN0aXZlbHkgcmFwaWQtb3BlbiB0aGUgcG9wdXAgd2hpbGUgbGVhdmluZyB0aGUgc2NyZWVuIGludGFjdAoJCQkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLWhpZGRlbiB1aS1wb3B1cC10cnVuY2F0ZSIgKTsKCQkJCQl0aGlzLnJlcG9zaXRpb24oIHsgcG9zaXRpb25UbzogIndpbmRvdyIgfSApOwoJCQkJCXRoaXMuX2lnbm9yZVJlc2l6ZUV2ZW50cygpOwoJCQkJfQoKCQkJCXRoaXMuX3Jlc2l6ZVNjcmVlbigpOwoJCQkJdGhpcy5fcmVzaXplRGF0YSA9IG51bGw7CgkJCQl0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgPSBmYWxzZTsKCQkJfQoJCX0gZWxzZSB7CgkJCXRoaXMuX3Jlc2l6ZURhdGEgPSBudWxsOwoJCQl0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgPSBmYWxzZTsKCQl9Cgl9LAoKCV9zdG9wSWdub3JpbmdSZXNpemVFdmVudHM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2lnbm9yZVJlc2l6ZVRvID0gMDsKCX0sCgoJX2lnbm9yZVJlc2l6ZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLl9pZ25vcmVSZXNpemVUbyApIHsKCQkJY2xlYXJUaW1lb3V0KCB0aGlzLl9pZ25vcmVSZXNpemVUbyApOwoJCX0KCQl0aGlzLl9pZ25vcmVSZXNpemVUbyA9IHRoaXMuX2RlbGF5KCAiX3N0b3BJZ25vcmluZ1Jlc2l6ZUV2ZW50cyIsIDEwMDAgKTsKCX0sCgoJX2hhbmRsZVdpbmRvd1Jlc2l6ZTogZnVuY3Rpb24oLyogdGhlRXZlbnQgKi8pIHsKCQlpZiAoIHRoaXMuX2lzT3BlbiAmJiB0aGlzLl9pZ25vcmVSZXNpemVUbyA9PT0gMCApIHsKCQkJaWYgKCAoIHRoaXMuX2V4cGVjdFJlc2l6ZUV2ZW50KCkgfHwgdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzICkgJiYKCQkJCSF0aGlzLl91aS5jb250YWluZXIuaGFzQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICkgKSB7CgkJCQkvLyBlZmZlY3RpdmVseSByYXBpZC1jbG9zZSB0aGUgcG9wdXAgd2hpbGUgbGVhdmluZyB0aGUgc2NyZWVuIGludGFjdAoJCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkJLmFkZENsYXNzKCAidWktcG9wdXAtaGlkZGVuIHVpLXBvcHVwLXRydW5jYXRlIiApCgkJCQkJLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCQkJfQoJCX0KCX0sCgoJX2hhbmRsZVdpbmRvd09yaWVudGF0aW9uY2hhbmdlOiBmdW5jdGlvbigvKiB0aGVFdmVudCAqLykgewoJCWlmICggIXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyAmJiB0aGlzLl9pc09wZW4gJiYgdGhpcy5faWdub3JlUmVzaXplVG8gPT09IDAgKSB7CgkJCXRoaXMuX2V4cGVjdFJlc2l6ZUV2ZW50KCk7CgkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IHRydWU7CgkJfQoJfSwKCgkvLyBXaGVuIHRoZSBwb3B1cCBpcyBvcGVuLCBhdHRlbXB0aW5nIHRvIGZvY3VzIG9uIGFuIGVsZW1lbnQgdGhhdCBpcyBub3QgYQoJLy8gY2hpbGQgb2YgdGhlIHBvcHVwIHdpbGwgcmVkaXJlY3QgZm9jdXMgdG8gdGhlIHBvcHVwCglfaGFuZGxlRG9jdW1lbnRGb2N1c0luOiBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJdmFyIHRhcmdldCwKCQkJdGFyZ2V0RWxlbWVudCA9IHRoZUV2ZW50LnRhcmdldCwKCQkJdWkgPSB0aGlzLl91aTsKCgkJaWYgKCAhdGhpcy5faXNPcGVuICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHRhcmdldEVsZW1lbnQgIT09IHVpLmNvbnRhaW5lclsgMCBdICkgewoJCQl0YXJnZXQgPSAkKCB0YXJnZXRFbGVtZW50ICk7CgkJCWlmICggMCA9PT0gdGFyZ2V0LnBhcmVudHMoKS5maWx0ZXIoIHVpLmNvbnRhaW5lclsgMCBdICkubGVuZ3RoICkgewoJCQkJJCggdGhpcy5kb2N1bWVudFsgMCBdLmFjdGl2ZUVsZW1lbnQgKS5vbmUoICJmb2N1cyIsIGZ1bmN0aW9uKC8qIHRoZUV2ZW50ICovKSB7CgkJCQkJdGFyZ2V0LmJsdXIoKTsKCQkJCX0pOwoJCQkJdWkuZm9jdXNFbGVtZW50LmZvY3VzKCk7CgkJCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJdGhlRXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gZWxzZSBpZiAoIHVpLmZvY3VzRWxlbWVudFsgMCBdID09PSB1aS5jb250YWluZXJbIDAgXSApIHsKCQkJCXVpLmZvY3VzRWxlbWVudCA9IHRhcmdldDsKCQkJfQoJCX0KCgkJdGhpcy5faWdub3JlUmVzaXplRXZlbnRzKCk7Cgl9LAoKCV90aGVtZUNsYXNzRnJvbU9wdGlvbjogZnVuY3Rpb24oIHByZWZpeCwgdmFsdWUgKSB7CgkJcmV0dXJuICggdmFsdWUgPyAoIHZhbHVlID09PSAibm9uZSIgPyAiIiA6ICggcHJlZml4ICsgdmFsdWUgKSApIDogKCBwcmVmaXggKyAiaW5oZXJpdCIgKSApOwoJfSwKCglfYXBwbHlUcmFuc2l0aW9uOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJaWYgKCB2YWx1ZSApIHsKCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gKTsKCQkJaWYgKCB2YWx1ZSAhPT0gIm5vbmUiICkgewoJCQkJdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24oIHZhbHVlICk7CgkJCQlpZiAoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiA9PT0gIm5vbmUiICkgewoJCQkJCXRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiA9ICIiOwoJCQkJfQoJCQkJdGhpcy5fdWkuY29udGFpbmVyLmFkZENsYXNzKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggbmV3T3B0aW9ucyApIHsKCQl2YXIgY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCXRoZUVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsCgkJCXNjcmVlbiA9IHRoaXMuX3VpLnNjcmVlbjsKCgkJaWYgKCBuZXdPcHRpb25zLndyYXBwZXJDbGFzcyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCS5yZW1vdmVDbGFzcyggY3VycmVudE9wdGlvbnMud3JhcHBlckNsYXNzICkKCQkJCS5hZGRDbGFzcyggbmV3T3B0aW9ucy53cmFwcGVyQ2xhc3MgKTsKCQl9CgoJCWlmICggbmV3T3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGVFbGVtZW50CgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBjdXJyZW50T3B0aW9ucy50aGVtZSApICkKCQkJCS5hZGRDbGFzcyggdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG5ld09wdGlvbnMudGhlbWUgKSApOwoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLm92ZXJsYXlUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlzY3JlZW4KCQkJCS5yZW1vdmVDbGFzcyggdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1vdmVybGF5LSIsIGN1cnJlbnRPcHRpb25zLm92ZXJsYXlUaGVtZSApICkKCQkJCS5hZGRDbGFzcyggdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1vdmVybGF5LSIsIG5ld09wdGlvbnMub3ZlcmxheVRoZW1lICkgKTsKCgkJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQkJc2NyZWVuLmFkZENsYXNzKCAiaW4iICk7CgkJCX0KCQl9CgoJCWlmICggbmV3T3B0aW9ucy5zaGFkb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhlRWxlbWVudC50b2dnbGVDbGFzcyggInVpLW92ZXJsYXktc2hhZG93IiwgbmV3T3B0aW9ucy5zaGFkb3cgKTsKCQl9CgoJCWlmICggbmV3T3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoZUVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgbmV3T3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMudHJhbnNpdGlvbiAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoICF0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiApIHsKCQkJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggbmV3T3B0aW9ucy50cmFuc2l0aW9uICk7CgkJCX0KCQl9CgoJCWlmICggbmV3T3B0aW9ucy50b2xlcmFuY2UgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0VG9sZXJhbmNlKCBuZXdPcHRpb25zLnRvbGVyYW5jZSApOwoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggbmV3T3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCXRoaXMuY2xvc2UoKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX3N1cGVyKCBuZXdPcHRpb25zICk7Cgl9LAoKCV9zZXRUb2xlcmFuY2U6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YXIgdG9sID0geyB0OiAzMCwgcjogMTUsIGI6IDMwLCBsOiAxNSB9LAoJCQlhcjsKCgkJaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQlhciA9IFN0cmluZyggdmFsdWUgKS5zcGxpdCggIiwiICk7CgoJCQkkLmVhY2goIGFyLCBmdW5jdGlvbiggaWR4LCB2YWwgKSB7IGFyWyBpZHggXSA9IHBhcnNlSW50KCB2YWwsIDEwICk7IH0gKTsKCgkJCXN3aXRjaCggYXIubGVuZ3RoICkgewoJCQkJLy8gQWxsIHZhbHVlcyBhcmUgdG8gYmUgdGhlIHNhbWUKCQkJCWNhc2UgMToKCQkJCQlpZiAoICFpc05hTiggYXJbIDAgXSApICkgewoJCQkJCQl0b2wudCA9IHRvbC5yID0gdG9sLmIgPSB0b2wubCA9IGFyWyAwIF07CgkJCQkJfQoJCQkJCWJyZWFrOwoKCQkJCS8vIFRoZSBmaXJzdCB2YWx1ZSBkZW5vdGVzIHRvcC9ib3R0b20gdG9sZXJhbmNlLCBhbmQgdGhlIHNlY29uZCB2YWx1ZSBkZW5vdGVzIGxlZnQvcmlnaHQgdG9sZXJhbmNlCgkJCQljYXNlIDI6CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAwIF0gKSApIHsKCQkJCQkJdG9sLnQgPSB0b2wuYiA9IGFyWyAwIF07CgkJCQkJfQoJCQkJCWlmICggIWlzTmFOKCBhclsgMSBdICkgKSB7CgkJCQkJCXRvbC5sID0gdG9sLnIgPSBhclsgMSBdOwoJCQkJCX0KCQkJCQlicmVhazsKCgkJCQkvLyBUaGUgYXJyYXkgY29udGFpbnMgdmFsdWVzIGluIHRoZSBvcmRlciB0b3AsIHJpZ2h0LCBib3R0b20sIGxlZnQKCQkJCWNhc2UgNDoKCQkJCQlpZiAoICFpc05hTiggYXJbIDAgXSApICkgewoJCQkJCQl0b2wudCA9IGFyWyAwIF07CgkJCQkJfQoJCQkJCWlmICggIWlzTmFOKCBhclsgMSBdICkgKSB7CgkJCQkJCXRvbC5yID0gYXJbIDEgXTsKCQkJCQl9CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAyIF0gKSApIHsKCQkJCQkJdG9sLmIgPSBhclsgMiBdOwoJCQkJCX0KCQkJCQlpZiAoICFpc05hTiggYXJbIDMgXSApICkgewoJCQkJCQl0b2wubCA9IGFyWyAzIF07CgkJCQkJfQoJCQkJCWJyZWFrOwoKCQkJCWRlZmF1bHQ6CgkJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCXRoaXMuX3RvbGVyYW5jZSA9IHRvbDsKCQlyZXR1cm4gdGhpczsKCX0sCgoJX2NsYW1wUG9wdXBXaWR0aDogZnVuY3Rpb24oIGluZm9Pbmx5ICkgewoJCXZhciBtZW51U2l6ZSwKCQkJd2luZG93Q29vcmRpbmF0ZXMgPSBnZXRXaW5kb3dDb29yZGluYXRlcygpLAoJCQkvLyByZWN0YW5nbGUgd2l0aGluIHdoaWNoIHRoZSBwb3B1cCBtdXN0IGZpdAoJCQlyZWN0YW5nbGUgPSB7CgkJCQl4OiB0aGlzLl90b2xlcmFuY2UubCwKCQkJCXk6IHdpbmRvd0Nvb3JkaW5hdGVzLnkgKyB0aGlzLl90b2xlcmFuY2UudCwKCQkJCWN4OiB3aW5kb3dDb29yZGluYXRlcy5jeCAtIHRoaXMuX3RvbGVyYW5jZS5sIC0gdGhpcy5fdG9sZXJhbmNlLnIsCgkJCQljeTogd2luZG93Q29vcmRpbmF0ZXMuY3kgLSB0aGlzLl90b2xlcmFuY2UudCAtIHRoaXMuX3RvbGVyYW5jZS5iCgkJCX07CgoJCWlmICggIWluZm9Pbmx5ICkgewoJCQkvLyBDbGFtcCB0aGUgd2lkdGggb2YgdGhlIG1lbnUgYmVmb3JlIGdyYWJiaW5nIGl0cyBzaXplCgkJCXRoaXMuX3VpLmNvbnRhaW5lci5jc3MoICJtYXgtd2lkdGgiLCByZWN0YW5nbGUuY3ggKTsKCQl9CgoJCW1lbnVTaXplID0gewoJCQljeDogdGhpcy5fdWkuY29udGFpbmVyLm91dGVyV2lkdGgoIHRydWUgKSwKCQkJY3k6IHRoaXMuX3VpLmNvbnRhaW5lci5vdXRlckhlaWdodCggdHJ1ZSApCgkJfTsKCgkJcmV0dXJuIHsgcmM6IHJlY3RhbmdsZSwgbWVudVNpemU6IG1lbnVTaXplIH07Cgl9LAoKCV9jYWxjdWxhdGVGaW5hbExvY2F0aW9uOiBmdW5jdGlvbiggZGVzaXJlZCwgY2xhbXBJbmZvICkgewoJCXZhciByZXR1cm5WYWx1ZSwKCQkJcmVjdGFuZ2xlID0gY2xhbXBJbmZvLnJjLAoJCQltZW51U2l6ZSA9IGNsYW1wSW5mby5tZW51U2l6ZTsKCgoJCS8vIENlbnRlciB0aGUgbWVudSBvdmVyIHRoZSBkZXNpcmVkIGNvb3JkaW5hdGVzLCB3aGlsZSBub3QgZ29pbmcgb3V0c2lkZQoJCS8vIHRoZSB3aW5kb3cgdG9sZXJhbmNlcy4gVGhpcyB3aWxsIGNlbnRlciB3cnQuIHRoZSB3aW5kb3cgaWYgdGhlIHBvcHVwIGlzCgkJLy8gdG9vIGxhcmdlLgoJCXJldHVyblZhbHVlID0gewoJCQlsZWZ0OiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggcmVjdGFuZ2xlLmN4LCBtZW51U2l6ZS5jeCwgcmVjdGFuZ2xlLngsIGRlc2lyZWQueCApLAoJCQl0b3A6IGZpdFNlZ21lbnRJbnNpZGVTZWdtZW50KCByZWN0YW5nbGUuY3ksIG1lbnVTaXplLmN5LCByZWN0YW5nbGUueSwgZGVzaXJlZC55ICkKCQl9OwoKCQkvLyBNYWtlIHN1cmUgdGhlIHRvcCBvZiB0aGUgbWVudSBpcyB2aXNpYmxlCgkJcmV0dXJuVmFsdWUudG9wID0gTWF0aC5tYXgoIDAsIHJldHVyblZhbHVlLnRvcCApOwoKCQkvLyBJZiB0aGUgaGVpZ2h0IG9mIHRoZSBtZW51IGlzIHNtYWxsZXIgdGhhbiB0aGUgaGVpZ2h0IG9mIHRoZSBkb2N1bWVudAoJCS8vIGFsaWduIHRoZSBib3R0b20gd2l0aCB0aGUgYm90dG9tIG9mIHRoZSBkb2N1bWVudAoKCQlyZXR1cm5WYWx1ZS50b3AgLT0gTWF0aC5taW4oIHJldHVyblZhbHVlLnRvcCwKCQkJTWF0aC5tYXgoIDAsIHJldHVyblZhbHVlLnRvcCArIG1lbnVTaXplLmN5IC0gJC5tb2JpbGUuZG9jdW1lbnQuaGVpZ2h0KCkgKSApOwoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9LAoKCS8vIFRyeSBhbmQgY2VudGVyIHRoZSBvdmVybGF5IG92ZXIgdGhlIGdpdmVuIGNvb3JkaW5hdGVzCglfcGxhY2VtZW50Q29vcmRzOiBmdW5jdGlvbiggZGVzaXJlZCApIHsKCQlyZXR1cm4gdGhpcy5fY2FsY3VsYXRlRmluYWxMb2NhdGlvbiggZGVzaXJlZCwgdGhpcy5fY2xhbXBQb3B1cFdpZHRoKCkgKTsKCX0sCgoJX2NyZWF0ZVByZXJlcXVpc2l0ZXM6IGZ1bmN0aW9uKCBzY3JlZW5QcmVyZXF1aXNpdGUsIGNvbnRhaW5lclByZXJlcXVpc2l0ZSwgd2hlbkRvbmUgKSB7CgkJdmFyIHByZXJlcXVpc2l0ZXMsCgkJCXNlbGYgPSB0aGlzOwoKCQkvLyBJdCBpcyBpbXBvcnRhbnQgdG8gbWFpbnRhaW4gYm90aCB0aGUgbG9jYWwgdmFyaWFibGUgcHJlcmVxdWlzaXRlcyBhbmQKCQkvLyBzZWxmLl9wcmVyZXF1aXNpdGVzLiBUaGUgbG9jYWwgdmFyaWFibGUgcmVtYWlucyBpbiB0aGUgY2xvc3VyZSBvZiB0aGUKCQkvLyBmdW5jdGlvbnMgd2hpY2ggY2FsbCB0aGUgY2FsbGJhY2tzIHBhc3NlZCBpbi4gVGhlIGNvbXBhcmlzb24gYmV0d2VlbiB0aGUKCQkvLyBsb2NhbCB2YXJpYWJsZSBhbmQgc2VsZi5fcHJlcmVxdWlzaXRlcyBpcyBuZWNlc3NhcnksIGJlY2F1c2Ugb25jZSBhCgkJLy8gZnVuY3Rpb24gaGFzIGJlZW4gcGFzc2VkIHRvIC5hbmltYXRpb25Db21wbGV0ZSgpIGl0IHdpbGwgYmUgY2FsbGVkIG5leHQKCQkvLyB0aW1lIGFuIGFuaW1hdGlvbiBjb21wbGV0ZXMsIGV2ZW4gaWYgdGhhdCdzIG5vdCB0aGUgYW5pbWF0aW9uIHdob3NlIGVuZAoJCS8vIHRoZSBmdW5jdGlvbiB3YXMgc3VwcG9zZWQgdG8gY2F0Y2ggKGZvciBleGFtcGxlLCBpZiBhbiBhYm9ydCBoYXBwZW5zCgkJLy8gZHVyaW5nIHRoZSBvcGVuaW5nIGFuaW1hdGlvbiwgdGhlIC5hbmltYXRpb25Db21wbGV0ZSBoYW5kbGVyIGlzIG5vdAoJCS8vIGNhbGxlZCBmb3IgdGhhdCBhbmltYXRpb24gYW55bW9yZSwgYnV0IHRoZSBoYW5kbGVyIHJlbWFpbnMgYXR0YWNoZWQsIHNvCgkJLy8gaXQgaXMgY2FsbGVkIHRoZSBuZXh0IHRpbWUgdGhlIHBvcHVwIGlzIG9wZW5lZCAtIG1ha2luZyBpdCBzdGFsZS4KCQkvLyBDb21wYXJpbmcgdGhlIGxvY2FsIHZhcmlhYmxlIHByZXJlcXVpc2l0ZXMgdG8gdGhlIHdpZGdldC1sZXZlbCB2YXJpYWJsZQoJCS8vIHNlbGYuX3ByZXJlcXVpc2l0ZXMgZW5zdXJlcyB0aGF0IGNhbGxiYWNrcyB0cmlnZ2VyZWQgYnkgYSBzdGFsZQoJCS8vIC5hbmltYXRpb25Db21wbGV0ZSB3aWxsIGJlIGlnbm9yZWQuCgoJCXByZXJlcXVpc2l0ZXMgPSB7CgkJCXNjcmVlbjogJC5EZWZlcnJlZCgpLAoJCQljb250YWluZXI6ICQuRGVmZXJyZWQoKQoJCX07CgoJCXByZXJlcXVpc2l0ZXMuc2NyZWVuLnRoZW4oIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHByZXJlcXVpc2l0ZXMgPT09IHNlbGYuX3ByZXJlcXVpc2l0ZXMgKSB7CgkJCQlzY3JlZW5QcmVyZXF1aXNpdGUoKTsKCQkJfQoJCX0pOwoKCQlwcmVyZXF1aXNpdGVzLmNvbnRhaW5lci50aGVuKCBmdW5jdGlvbigpIHsKCQkJaWYgKCBwcmVyZXF1aXNpdGVzID09PSBzZWxmLl9wcmVyZXF1aXNpdGVzICkgewoJCQkJY29udGFpbmVyUHJlcmVxdWlzaXRlKCk7CgkJCX0KCQl9KTsKCgkJJC53aGVuKCBwcmVyZXF1aXNpdGVzLnNjcmVlbiwgcHJlcmVxdWlzaXRlcy5jb250YWluZXIgKS5kb25lKCBmdW5jdGlvbigpIHsKCQkJaWYgKCBwcmVyZXF1aXNpdGVzID09PSBzZWxmLl9wcmVyZXF1aXNpdGVzICkgewoJCQkJc2VsZi5fcHJlcmVxdWlzaXRlcyA9IG51bGw7CgkJCQl3aGVuRG9uZSgpOwoJCQl9CgkJfSk7CgoJCXNlbGYuX3ByZXJlcXVpc2l0ZXMgPSBwcmVyZXF1aXNpdGVzOwoJfSwKCglfYW5pbWF0ZTogZnVuY3Rpb24oIGFyZ3MgKSB7CgkJLy8gTk9URSBiZWZvcmUgcmVtb3ZpbmcgdGhlIGRlZmF1bHQgYW5pbWF0aW9uIG9mIHRoZSBzY3JlZW4KCQkvLyAgICAgIHRoaXMgaGFkIGFuIGFuaW1hdGUgY2FsbGJhY2sgdGhhdCB3b3VsZCByZXNvbHZlIHRoZSBkZWZlcnJlZAoJCS8vICAgICAgbm93IHRoZSBkZWZlcnJlZCBpcyByZXNvbHZlZCBpbW1lZGlhdGVseQoJCS8vIFRPRE8gcmVtb3ZlIHRoZSBkZXBlbmRlbmN5IG9uIHRoZSBzY3JlZW4gZGVmZXJyZWQKCQl0aGlzLl91aS5zY3JlZW4KCQkJLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKQoJCQkuYWRkQ2xhc3MoIGFyZ3Muc2NyZWVuQ2xhc3NUb0FkZCApOwoKCQlhcmdzLnByZXJlcXVpc2l0ZXMuc2NyZWVuLnJlc29sdmUoKTsKCgkJaWYgKCBhcmdzLnRyYW5zaXRpb24gJiYgYXJncy50cmFuc2l0aW9uICE9PSAibm9uZSIgKSB7CgkJCWlmICggYXJncy5hcHBseVRyYW5zaXRpb24gKSB7CgkJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIGFyZ3MudHJhbnNpdGlvbiApOwoJCQl9CgkJCWlmICggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICkgewoJCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKCAkLnByb3h5KCBhcmdzLnByZXJlcXVpc2l0ZXMuY29udGFpbmVyLCAicmVzb2x2ZSIgKSApCgkJCQkJLmFkZENsYXNzKCBhcmdzLmNvbnRhaW5lckNsYXNzVG9BZGQgKQoJCQkJCS5yZW1vdmVDbGFzcyggYXJncy5jbGFzc1RvUmVtb3ZlICk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKTsKCQlhcmdzLnByZXJlcXVpc2l0ZXMuY29udGFpbmVyLnJlc29sdmUoKTsKCX0sCgoJLy8gVGhlIGRlc2lyZWQgY29vcmRpbmF0ZXMgcGFzc2VkIGluIHdpbGwgYmUgcmV0dXJuZWQgdW50b3VjaGVkIGlmIG5vIHJlZmVyZW5jZSBlbGVtZW50IGNhbiBiZSBpZGVudGlmaWVkIHZpYQoJLy8gZGVzaXJlZFBvc2l0aW9uLnBvc2l0aW9uVG8uIE5ldmVydGhlbGVzcywgdGhpcyBmdW5jdGlvbiBlbnN1cmVzIHRoYXQgaXRzIHJldHVybiB2YWx1ZSBhbHdheXMgY29udGFpbnMgdmFsaWQKCS8vIHggYW5kIHkgY29vcmRpbmF0ZXMgYnkgc3BlY2lmeWluZyB0aGUgY2VudGVyIG1pZGRsZSBvZiB0aGUgd2luZG93IGlmIHRoZSBjb29yZGluYXRlcyBhcmUgYWJzZW50LgoJLy8gb3B0aW9uczogeyB4OiBjb29yZGluYXRlLCB5OiBjb29yZGluYXRlLCBwb3NpdGlvblRvOiBzdHJpbmc6ICJvcmlnaW4iLCAid2luZG93Iiwgb3IgalF1ZXJ5IHNlbGVjdG9yCglfZGVzaXJlZENvb3JkczogZnVuY3Rpb24oIG9wZW5PcHRpb25zICkgewoJCXZhciBvZmZzZXQsCgkJCWRzdCA9IG51bGwsCgkJCXdpbmRvd0Nvb3JkaW5hdGVzID0gZ2V0V2luZG93Q29vcmRpbmF0ZXMoKSwKCQkJeCA9IG9wZW5PcHRpb25zLngsCgkJCXkgPSBvcGVuT3B0aW9ucy55LAoJCQlwVG8gPSBvcGVuT3B0aW9ucy5wb3NpdGlvblRvOwoKCQkvLyBFc3RhYmxpc2ggd2hpY2ggZWxlbWVudCB3aWxsIHNlcnZlIGFzIHRoZSByZWZlcmVuY2UKCQlpZiAoIHBUbyAmJiBwVG8gIT09ICJvcmlnaW4iICkgewoJCQlpZiAoIHBUbyA9PT0gIndpbmRvdyIgKSB7CgkJCQl4ID0gd2luZG93Q29vcmRpbmF0ZXMuY3ggLyAyICsgd2luZG93Q29vcmRpbmF0ZXMueDsKCQkJCXkgPSB3aW5kb3dDb29yZGluYXRlcy5jeSAvIDIgKyB3aW5kb3dDb29yZGluYXRlcy55OwoJCQl9IGVsc2UgewoJCQkJdHJ5IHsKCQkJCQlkc3QgPSAkKCBwVG8gKTsKCQkJCX0gY2F0Y2goIGVyciApIHsKCQkJCQlkc3QgPSBudWxsOwoJCQkJfQoJCQkJaWYgKCBkc3QgKSB7CgkJCQkJZHN0LmZpbHRlciggIjp2aXNpYmxlIiApOwoJCQkJCWlmICggZHN0Lmxlbmd0aCA9PT0gMCApIHsKCQkJCQkJZHN0ID0gbnVsbDsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCS8vIElmIGFuIGVsZW1lbnQgd2FzIGZvdW5kLCBjZW50ZXIgb3ZlciBpdAoJCWlmICggZHN0ICkgewoJCQlvZmZzZXQgPSBkc3Qub2Zmc2V0KCk7CgkJCXggPSBvZmZzZXQubGVmdCArIGRzdC5vdXRlcldpZHRoKCkgLyAyOwoJCQl5ID0gb2Zmc2V0LnRvcCArIGRzdC5vdXRlckhlaWdodCgpIC8gMjsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB4IGFuZCB5IGFyZSB2YWxpZCBudW1iZXJzIC0gY2VudGVyIG92ZXIgdGhlIHdpbmRvdwoJCWlmICggJC50eXBlKCB4ICkgIT09ICJudW1iZXIiIHx8IGlzTmFOKCB4ICkgKSB7CgkJCXggPSB3aW5kb3dDb29yZGluYXRlcy5jeCAvIDIgKyB3aW5kb3dDb29yZGluYXRlcy54OwoJCX0KCQlpZiAoICQudHlwZSggeSApICE9PSAibnVtYmVyIiB8fCBpc05hTiggeSApICkgewoJCQl5ID0gd2luZG93Q29vcmRpbmF0ZXMuY3kgLyAyICsgd2luZG93Q29vcmRpbmF0ZXMueTsKCQl9CgoJCXJldHVybiB7IHg6IHgsIHk6IHkgfTsKCX0sCgoJX3JlcG9zaXRpb246IGZ1bmN0aW9uKCBvcGVuT3B0aW9ucyApIHsKCQkvLyBXZSBvbmx5IGNhcmUgYWJvdXQgcG9zaXRpb24tcmVsYXRlZCBwYXJhbWV0ZXJzIGZvciByZXBvc2l0aW9uaW5nCgkJb3Blbk9wdGlvbnMgPSB7CgkJCXg6IG9wZW5PcHRpb25zLngsCgkJCXk6IG9wZW5PcHRpb25zLnksCgkJCXBvc2l0aW9uVG86IG9wZW5PcHRpb25zLnBvc2l0aW9uVG8KCQl9OwoJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVwb3NpdGlvbiIsIHVuZGVmaW5lZCwgb3Blbk9wdGlvbnMgKTsKCQl0aGlzLl91aS5jb250YWluZXIub2Zmc2V0KCB0aGlzLl9wbGFjZW1lbnRDb29yZHMoIHRoaXMuX2Rlc2lyZWRDb29yZHMoIG9wZW5PcHRpb25zICkgKSApOwoJfSwKCglyZXBvc2l0aW9uOiBmdW5jdGlvbiggb3Blbk9wdGlvbnMgKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCXRoaXMuX3JlcG9zaXRpb24oIG9wZW5PcHRpb25zICk7CgkJfQoJfSwKCglfb3BlblByZXJlcXVpc2l0ZXNDb21wbGV0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fdWkuY29udGFpbmVyLmFkZENsYXNzKCAidWktcG9wdXAtYWN0aXZlIiApOwoJCXRoaXMuX2lzT3BlbiA9IHRydWU7CgkJdGhpcy5fcmVzaXplU2NyZWVuKCk7CgkJdGhpcy5fdWkuY29udGFpbmVyLmF0dHIoICJ0YWJpbmRleCIsICIwIiApLmZvY3VzKCk7CgkJdGhpcy5faWdub3JlUmVzaXplRXZlbnRzKCk7CgkJdGhpcy5fdHJpZ2dlciggImFmdGVyb3BlbiIgKTsKCX0sCgoJX29wZW46IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBvcGVuT3B0aW9ucyA9ICQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zLCBvcHRpb25zICksCgkJCS8vIFRPRE8gbW92ZSBibGFja2xpc3QgdG8gcHJpdmF0ZSBtZXRob2QKCQkJYW5kcm9pZEJsYWNrbGlzdCA9ICggZnVuY3Rpb24oKSB7CgkJCQl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCQkJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJCQkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XC5dKykvICksCgkJCQkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQkJCQlhbmRyb2lkbWF0Y2ggPSB1YS5tYXRjaCggL0FuZHJvaWQgKFxkKyg/OlwuXGQrKSkvICksCgkJCQkJYW5kdmVyc2lvbiA9ICEhYW5kcm9pZG1hdGNoICYmIGFuZHJvaWRtYXRjaFsgMSBdLAoJCQkJCWNocm9tZW1hdGNoID0gdWEuaW5kZXhPZiggIkNocm9tZSIgKSA+IC0xOwoKCQkJCS8vIFBsYXRmb3JtIGlzIEFuZHJvaWQsIFdlYktpdCB2ZXJzaW9uIGlzIGdyZWF0ZXIgdGhhbiA1MzQuMTMgKCBBbmRyb2lkIDMuMi4xICkgYW5kIG5vdCBDaHJvbWUuCgkJCQlpZiAoIGFuZHJvaWRtYXRjaCAhPT0gbnVsbCAmJiBhbmR2ZXJzaW9uID09PSAiNC4wIiAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uID4gNTM0LjEzICYmICFjaHJvbWVtYXRjaCApIHsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0KCQkJCXJldHVybiBmYWxzZTsKCQkJfSgpKTsKCgkJLy8gQ291bnQgZG93biB0byB0cmlnZ2VyaW5nICJwb3B1cGFmdGVyb3BlbiIgLSB3ZSBoYXZlIHR3byBwcmVyZXF1aXNpdGVzOgoJCS8vIDEuIFRoZSBwb3B1cCB3aW5kb3cgYW5pbWF0aW9uIGNvbXBsZXRlcyAoY29udGFpbmVyKCkpCgkJLy8gMi4gVGhlIHNjcmVlbiBvcGFjaXR5IGFuaW1hdGlvbiBjb21wbGV0ZXMgKHNjcmVlbigpKQoJCXRoaXMuX2NyZWF0ZVByZXJlcXVpc2l0ZXMoCgkJCSQubm9vcCwKCQkJJC5ub29wLAoJCQkkLnByb3h5KCB0aGlzLCAiX29wZW5QcmVyZXF1aXNpdGVzQ29tcGxldGUiICkgKTsKCgkJdGhpcy5fY3VycmVudFRyYW5zaXRpb24gPSBvcGVuT3B0aW9ucy50cmFuc2l0aW9uOwoJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggb3Blbk9wdGlvbnMudHJhbnNpdGlvbiApOwoKCQl0aGlzLl91aS5zY3JlZW4ucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLXRydW5jYXRlIiApOwoKCQkvLyBHaXZlIGFwcGxpY2F0aW9ucyBhIGNoYW5jZSB0byBtb2RpZnkgdGhlIGNvbnRlbnRzIG9mIHRoZSBjb250YWluZXIgYmVmb3JlIGl0IGFwcGVhcnMKCQl0aGlzLl9yZXBvc2l0aW9uKCBvcGVuT3B0aW9ucyApOwoKCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICk7CgoJCWlmICggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSAmJiBhbmRyb2lkQmxhY2tsaXN0ICkgewoJCQkvKiBUT0RPOiBUaGUgbmF0aXZlIGJyb3dzZXIgb24gQW5kcm9pZCA0LjAuWCAoIkljZSBDcmVhbSBTYW5kd2ljaCIpIHN1ZmZlcnMgZnJvbSBhbiBpc3N1ZSB3aGVyZSB0aGUgcG9wdXAgb3ZlcmxheSBhcHBlYXJzIHRvIGJlIHotaW5kZXhlZCBhYm92ZSB0aGUgcG9wdXAgaXRzZWxmIHdoZW4gY2VydGFpbiBvdGhlciBzdHlsZXMgZXhpc3Qgb24gdGhlIHNhbWUgcGFnZSAtLSBuYW1lbHksIGFueSBlbGVtZW50IHNldCB0byBgcG9zaXRpb246IGZpeGVkYCBhbmQgY2VydGFpbiB0eXBlcyBvZiBpbnB1dC4gVGhlc2UgaXNzdWVzIGFyZSByZW1pbmlzY2VudCBvZiBwcmV2aW91c2x5IHVuY292ZXJlZCBidWdzIGluIG9sZGVyIHZlcnNpb25zIG9mIEFuZHJvaWQncyBuYXRpdmUgYnJvd3NlcjogaHR0cHM6Ly9naXRodWIuY29tL3Njb3R0amVobC9EZXZpY2UtQnVncy9pc3N1ZXMvMwoJCQlUaGlzIGZpeCBjbG9zZXMgdGhlIGZvbGxvd2luZyBidWdzICggSSB1c2UgImNsb3NlcyIgd2l0aCByZWx1Y3RhbmNlLCBhbmQgc3RyZXNzIHRoYXQgdGhpcyBpc3N1ZSBzaG91bGQgYmUgcmV2aXNpdGVkIGFzIHNvb24gYXMgcG9zc2libGUgKToKCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODE2CgkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDg0NAoJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4NzQKCQkJKi8KCgkJCS8vIFRPRE8gc29ydCBvdXQgd2h5IHRoaXMuX3BhZ2UgaXNuJ3Qgd29ya2luZwoJCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLmFkZENsYXNzKCAidWktcG9wdXAtb3BlbiIgKTsKCQl9CgkJdGhpcy5fYW5pbWF0ZSh7CgkJCWFkZGl0aW9uYWxDb25kaXRpb246IHRydWUsCgkJCXRyYW5zaXRpb246IG9wZW5PcHRpb25zLnRyYW5zaXRpb24sCgkJCWNsYXNzVG9SZW1vdmU6ICIiLAoJCQlzY3JlZW5DbGFzc1RvQWRkOiAiaW4iLAoJCQljb250YWluZXJDbGFzc1RvQWRkOiAiaW4iLAoJCQlhcHBseVRyYW5zaXRpb246IGZhbHNlLAoJCQlwcmVyZXF1aXNpdGVzOiB0aGlzLl9wcmVyZXF1aXNpdGVzCgkJfSk7Cgl9LAoKCV9jbG9zZVByZXJlcXVpc2l0ZVNjcmVlbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fdWkuc2NyZWVuCgkJCS5yZW1vdmVDbGFzcyggIm91dCIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJfSwKCglfY2xvc2VQcmVyZXF1aXNpdGVDb250YWluZXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkucmVtb3ZlQ2xhc3MoICJyZXZlcnNlIG91dCIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4gdWktcG9wdXAtdHJ1bmNhdGUiICkKCQkJLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCX0sCgoJX2Nsb3NlUHJlcmVxdWlzaXRlc0RvbmU6IGZ1bmN0aW9uKCkgewoJCXZhciBjb250YWluZXIgPSB0aGlzLl91aS5jb250YWluZXI7CgoJCWNvbnRhaW5lci5yZW1vdmVBdHRyKCAidGFiaW5kZXgiICk7CgoJCS8vIHJlbW92ZSB0aGUgZ2xvYmFsIG11dGV4IGZvciBwb3B1cHMKCQkkLm1vYmlsZS5wb3B1cC5hY3RpdmUgPSB1bmRlZmluZWQ7CgoJCS8vIEJsdXIgZWxlbWVudHMgaW5zaWRlIHRoZSBjb250YWluZXIsIGluY2x1ZGluZyB0aGUgY29udGFpbmVyCgkJJCggIjpmb2N1cyIsIGNvbnRhaW5lclsgMCBdICkuYWRkKCBjb250YWluZXJbIDAgXSApLmJsdXIoKTsKCgkJLy8gYWxlcnQgdXNlcnMgdGhhdCB0aGUgcG9wdXAgaXMgY2xvc2VkCgkJdGhpcy5fdHJpZ2dlciggImFmdGVyY2xvc2UiICk7Cgl9LAoKCV9jbG9zZTogZnVuY3Rpb24oIGltbWVkaWF0ZSApIHsKCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1hY3RpdmUiICk7CgkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggInVpLXBvcHVwLW9wZW4iICk7CgoJCXRoaXMuX2lzT3BlbiA9IGZhbHNlOwoKCQkvLyBDb3VudCBkb3duIHRvIHRyaWdnZXJpbmcgInBvcHVwYWZ0ZXJjbG9zZSIgLSB3ZSBoYXZlIHR3byBwcmVyZXF1aXNpdGVzOgoJCS8vIDEuIFRoZSBwb3B1cCB3aW5kb3cgcmV2ZXJzZSBhbmltYXRpb24gY29tcGxldGVzIChjb250YWluZXIoKSkKCQkvLyAyLiBUaGUgc2NyZWVuIG9wYWNpdHkgYW5pbWF0aW9uIGNvbXBsZXRlcyAoc2NyZWVuKCkpCgkJdGhpcy5fY3JlYXRlUHJlcmVxdWlzaXRlcygKCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcXVpc2l0ZVNjcmVlbiIgKSwKCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcXVpc2l0ZUNvbnRhaW5lciIgKSwKCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcXVpc2l0ZXNEb25lIiApICk7CgoJCXRoaXMuX2FuaW1hdGUoIHsKCQkJYWRkaXRpb25hbENvbmRpdGlvbjogdGhpcy5fdWkuc2NyZWVuLmhhc0NsYXNzKCAiaW4iICksCgkJCXRyYW5zaXRpb246ICggaW1tZWRpYXRlID8gIm5vbmUiIDogKCB0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiApICksCgkJCWNsYXNzVG9SZW1vdmU6ICJpbiIsCgkJCXNjcmVlbkNsYXNzVG9BZGQ6ICJvdXQiLAoJCQljb250YWluZXJDbGFzc1RvQWRkOiAicmV2ZXJzZSBvdXQiLAoJCQlhcHBseVRyYW5zaXRpb246IHRydWUsCgkJCXByZXJlcXVpc2l0ZXM6IHRoaXMuX3ByZXJlcXVpc2l0ZXMKCQl9KTsKCX0sCgoJX3VuZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIFB1dCB0aGUgZWxlbWVudCBiYWNrIHRvIHdoZXJlIHRoZSBwbGFjZWhvbGRlciB3YXMgYW5kIHJlbW92ZSB0aGUgInVpLXBvcHVwIiBjbGFzcwoJCXRoaXMuX3NldE9wdGlvbnMoIHsgdGhlbWU6ICQubW9iaWxlLnBvcHVwLnByb3RvdHlwZS5vcHRpb25zLnRoZW1lIH0gKTsKCQl0aGlzLmVsZW1lbnQKCQkJLy8gQ2Fubm90IGRpcmVjdGx5IGluc2VydEFmdGVyKCkgLSB3ZSBuZWVkIHRvIGRldGFjaCgpIGZpcnN0LCBiZWNhdXNlCgkJCS8vIGluc2VydEFmdGVyKCkgd2lsbCBkbyBub3RoaW5nIGlmIHRoZSBwYXlsb2FkIGRpdiB3YXMgbm90IGF0dGFjaGVkCgkJCS8vIHRvIHRoZSBET00gYXQgdGhlIHRpbWUgdGhlIHdpZGdldCB3YXMgY3JlYXRlZCwgYW5kIHNvIHRoZSBwYXlsb2FkCgkJCS8vIHdpbGwgcmVtYWluIGluc2lkZSB0aGUgY29udGFpbmVyIGV2ZW4gYWZ0ZXIgd2UgY2FsbCBpbnNlcnRBZnRlcigpLgoJCQkvLyBJZiB0aGF0IGhhcHBlbnMgYW5kIHdlIHJlbW92ZSB0aGUgY29udGFpbmVyIGEgZmV3IGxpbmVzIGJlbG93LCB3ZQoJCQkvLyB3aWxsIGNhdXNlIGFuIGluZmluaXRlIHJlY3Vyc2lvbiAtICM1MjQ0CgkJCS5kZXRhY2goKQoJCQkuaW5zZXJ0QWZ0ZXIoIHRoaXMuX3VpLnBsYWNlaG9sZGVyICkKCQkJLnJlbW92ZUNsYXNzKCAidWktcG9wdXAgdWktb3ZlcmxheS1zaGFkb3cgdWktY29ybmVyLWFsbCB1aS1ib2R5LWluaGVyaXQiICk7CgkJdGhpcy5fdWkuc2NyZWVuLnJlbW92ZSgpOwoJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmUoKTsKCQl0aGlzLl91aS5wbGFjZWhvbGRlci5yZW1vdmUoKTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggJC5tb2JpbGUucG9wdXAuYWN0aXZlID09PSB0aGlzICkgewoJCQl0aGlzLmVsZW1lbnQub25lKCAicG9wdXBhZnRlcmNsb3NlIiwgJC5wcm94eSggdGhpcywgIl91bmVuaGFuY2UiICkgKTsKCQkJdGhpcy5jbG9zZSgpOwoJCX0gZWxzZSB7CgkJCXRoaXMuX3VuZW5oYW5jZSgpOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9jbG9zZVBvcHVwOiBmdW5jdGlvbiggdGhlRXZlbnQsIGRhdGEgKSB7CgkJdmFyIHBhcnNlZERzdCwgdG9VcmwsCgkJCWN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlpbW1lZGlhdGUgPSBmYWxzZTsKCgkJaWYgKCAoIHRoZUV2ZW50ICYmIHRoZUV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgfHwgJC5tb2JpbGUucG9wdXAuYWN0aXZlICE9PSB0aGlzICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyByZXN0b3JlIGxvY2F0aW9uIG9uIHNjcmVlbgoJCXdpbmRvdy5zY3JvbGxUbyggMCwgdGhpcy5fc2Nyb2xsVG9wICk7CgoJCWlmICggdGhlRXZlbnQgJiYgdGhlRXZlbnQudHlwZSA9PT0gInBhZ2ViZWZvcmVjaGFuZ2UiICYmIGRhdGEgKSB7CgkJCS8vIERldGVybWluZSB3aGV0aGVyIHdlIG5lZWQgdG8gcmFwaWQtY2xvc2UgdGhlIHBvcHVwLCBvciB3aGV0aGVyIHdlIGNhbgoJCQkvLyB0YWtlIHRoZSB0aW1lIHRvIHJ1biB0aGUgY2xvc2luZyB0cmFuc2l0aW9uCgkJCWlmICggdHlwZW9mIGRhdGEudG9QYWdlID09PSAic3RyaW5nIiApIHsKCQkJCXBhcnNlZERzdCA9IGRhdGEudG9QYWdlOwoJCQl9IGVsc2UgewoJCQkJcGFyc2VkRHN0ID0gZGF0YS50b1BhZ2UuanFtRGF0YSggInVybCIgKTsKCQkJfQoJCQlwYXJzZWREc3QgPSAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCBwYXJzZWREc3QgKTsKCQkJdG9VcmwgPSBwYXJzZWREc3QucGF0aG5hbWUgKyBwYXJzZWREc3Quc2VhcmNoICsgcGFyc2VkRHN0Lmhhc2g7CgoJCQlpZiAoIHRoaXMuX215VXJsICE9PSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggdG9VcmwgKSApIHsKCQkJCS8vIEdvaW5nIHRvIGEgZGlmZmVyZW50IHBhZ2UgLSBjbG9zZSBpbW1lZGlhdGVseQoJCQkJaW1tZWRpYXRlID0gdHJ1ZTsKCQkJfSBlbHNlIHsKCQkJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQl9CgoJCS8vIHJlbW92ZSBuYXYgYmluZGluZ3MKCQkkLm1vYmlsZS53aW5kb3cub2ZmKCBjdXJyZW50T3B0aW9ucy5jbG9zZUV2ZW50cyApOwoJCS8vIHVuYmluZCBjbGljayBoYW5kbGVycyBhZGRlZCB3aGVuIGhpc3RvcnkgaXMgZGlzYWJsZWQKCQl0aGlzLmVsZW1lbnQudW5kZWxlZ2F0ZSggY3VycmVudE9wdGlvbnMuY2xvc2VMaW5rU2VsZWN0b3IsIGN1cnJlbnRPcHRpb25zLmNsb3NlTGlua0V2ZW50cyApOwoKCQl0aGlzLl9jbG9zZSggaW1tZWRpYXRlICk7Cgl9LAoKCS8vIGFueSBuYXZpZ2F0aW9uIGV2ZW50IGFmdGVyIGEgcG9wdXAgaXMgb3BlbmVkIHNob3VsZCBjbG9zZSB0aGUgcG9wdXAKCS8vIE5PVEUgdGhlIHBhZ2ViZWZvcmVjaGFuZ2UgaXMgYm91bmQgdG8gY2F0Y2ggbmF2aWdhdGlvbiBldmVudHMgdGhhdCBkb24ndAoJLy8gICAgICBhbHRlciB0aGUgdXJsIChlZywgZGlhbG9ncyBmcm9tIHBvcHVwcykKCV9iaW5kQ29udGFpbmVyQ2xvc2U6IGZ1bmN0aW9uKCkgewoJCSQubW9iaWxlLndpbmRvdwoJCQkub24oIHRoaXMub3B0aW9ucy5jbG9zZUV2ZW50cywgJC5wcm94eSggdGhpcywgIl9jbG9zZVBvcHVwIiApICk7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3VpLmNvbnRhaW5lcjsKCX0sCgoJLy8gVE9ETyBubyBjbGVhciBkZWxpbmlhdGlvbiBvZiB3aGF0IHNob3VsZCBiZSBoZXJlIGFuZAoJLy8gd2hhdCBzaG91bGQgYmUgaW4gX29wZW4uIFNlZW1zIHRvIGJlICJ2aXN1YWwiIHZzICJoaXN0b3J5IiBmb3Igbm93CglvcGVuOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgdXJsLCBoYXNoa2V5LCBhY3RpdmVQYWdlLCBjdXJyZW50SXNEaWFsb2csIGhhc0hhc2gsIHVybEhpc3RvcnksCgkJCXNlbGYgPSB0aGlzLAoJCQljdXJyZW50T3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCgkJLy8gbWFrZSBzdXJlIG9wZW4gaXMgaWRlbXBvdGVudAoJCWlmICggJC5tb2JpbGUucG9wdXAuYWN0aXZlIHx8IGN1cnJlbnRPcHRpb25zLmRpc2FibGVkICkgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCS8vIHNldCB0aGUgZ2xvYmFsIHBvcHVwIG11dGV4CgkJJC5tb2JpbGUucG9wdXAuYWN0aXZlID0gdGhpczsKCQl0aGlzLl9zY3JvbGxUb3AgPSAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCk7CgoJCS8vIGlmIGhpc3RvcnkgYWx0ZXJhdGlvbiBpcyBkaXNhYmxlZCBjbG9zZSBvbiBuYXZpZ2F0ZSBldmVudHMKCQkvLyBhbmQgbGVhdmUgdGhlIHVybCBhcyBpcwoJCWlmICggISggY3VycmVudE9wdGlvbnMuaGlzdG9yeSApICkgewoJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoKCQkJLy8gV2hlbiBoaXN0b3kgaXMgZGlzYWJsZWQgd2UgaGF2ZSB0byBncmFiIHRoZSBkYXRhLXJlbAoJCQkvLyBiYWNrIGxpbmsgY2xpY2tzIHNvIHdlIGNhbiBjbG9zZSB0aGUgcG9wdXAgaW5zdGVhZCBvZgoJCQkvLyByZWx5aW5nIG9uIGhpc3RvcnkgdG8gZG8gaXQgZm9yIHVzCgkJCXNlbGYuZWxlbWVudAoJCQkJLmRlbGVnYXRlKCBjdXJyZW50T3B0aW9ucy5jbG9zZUxpbmtTZWxlY3RvciwgY3VycmVudE9wdGlvbnMuY2xvc2VMaW5rRXZlbnRzLCBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9KTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gY2FjaGUgc29tZSB2YWx1ZXMgZm9yIG1pbi9yZWFkYWJpbGl0eQoJCXVybEhpc3RvcnkgPSAkLm1vYmlsZS51cmxIaXN0b3J5OwoJCWhhc2hrZXkgPSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5OwoJCWFjdGl2ZVBhZ2UgPSAkLm1vYmlsZS5hY3RpdmVQYWdlOwoJCWN1cnJlbnRJc0RpYWxvZyA9ICggYWN0aXZlUGFnZSA/IGFjdGl2ZVBhZ2UuaGFzQ2xhc3MoICJ1aS1kaWFsb2ciICkgOiBmYWxzZSApOwoJCXRoaXMuX215VXJsID0gdXJsID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKS51cmw7CgkJaGFzSGFzaCA9ICggdXJsLmluZGV4T2YoIGhhc2hrZXkgKSA+IC0xICkgJiYgIWN1cnJlbnRJc0RpYWxvZyAmJiAoIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPiAwICk7CgoJCWlmICggaGFzSGFzaCApIHsKCQkJc2VsZi5fb3Blbiggb3B0aW9ucyApOwoJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQkvLyBpZiB0aGUgY3VycmVudCB1cmwgaGFzIG5vIGRpYWxvZyBoYXNoIGtleSBwcm9jZWVkIGFzIG5vcm1hbAoJCS8vIG90aGVyd2lzZSwgaWYgdGhlIHBhZ2UgaXMgYSBkaWFsb2cgc2ltcGx5IHRhY2sgb24gdGhlIGhhc2gga2V5CgkJaWYgKCB1cmwuaW5kZXhPZiggaGFzaGtleSApID09PSAtMSAmJiAhY3VycmVudElzRGlhbG9nICl7CgkJCXVybCA9IHVybCArICh1cmwuaW5kZXhPZiggIiMiICkgPiAtMSA/IGhhc2hrZXkgOiAiIyIgKyBoYXNoa2V5KTsKCQl9IGVsc2UgewoJCQl1cmwgPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoICsgaGFzaGtleTsKCQl9CgoJCS8vIFRhY2sgb24gYW4gZXh0cmEgaGFzaGtleSBpZiB0aGlzIGlzIHRoZSBmaXJzdCBwYWdlIGFuZCB3ZSd2ZSBqdXN0IHJlY29uc3RydWN0ZWQgdGhlIGluaXRpYWwgaGFzaAoJCWlmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCAmJiB1cmwgPT09IHVybEhpc3RvcnkuaW5pdGlhbERzdCApIHsKCQkJdXJsICs9IGhhc2hrZXk7CgkJfQoKCQkvLyBzd2FsbG93IHRoZSB0aGUgaW5pdGlhbCBuYXZpZ2F0aW9uIGV2ZW50LCBhbmQgYmluZCBmb3IgdGhlIG5leHQKCQkkLm1vYmlsZS53aW5kb3cub25lKCAiYmVmb3JlbmF2aWdhdGUiLCBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJc2VsZi5fYmluZENvbnRhaW5lckNsb3NlKCk7CgkJfSk7CgoJCXRoaXMudXJsQWx0ZXJlZCA9IHRydWU7CgkJJC5tb2JpbGUubmF2aWdhdGUoIHVybCwgeyByb2xlOiAiZGlhbG9nIiB9ICk7CgoJCXJldHVybiB0aGlzOwoJfSwKCgljbG9zZTogZnVuY3Rpb24oKSB7CgkJLy8gbWFrZSBzdXJlIGNsb3NlIGlzIGlkZW1wb3RlbnQKCQlpZiAoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSAhPT0gdGhpcyApIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQl0aGlzLl9zY3JvbGxUb3AgPSAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLmhpc3RvcnkgJiYgdGhpcy51cmxBbHRlcmVkICkgewoJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCXRoaXMudXJsQWx0ZXJlZCA9IGZhbHNlOwoJCX0gZWxzZSB7CgkJCS8vIHNpbXVsYXRlIHRoZSBuYXYgYmluZGluZ3MgaGF2aW5nIGZpcmVkCgkJCXRoaXMuX2Nsb3NlUG9wdXAoKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQp9KTsKCgovLyBUT0RPIHRoaXMgY2FuIGJlIG1vdmVkIGluc2lkZSB0aGUgd2lkZ2V0CiQubW9iaWxlLnBvcHVwLmhhbmRsZUxpbmsgPSBmdW5jdGlvbiggJGxpbmsgKSB7Cgl2YXIgY2xvc2VzdFBhZ2UgPSAkbGluay5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApLAoJCXBhdGggPSAkLm1vYmlsZS5wYXRoLAoJCXNjb3BlID0gKCAoIGNsb3Nlc3RQYWdlLmxlbmd0aCA9PT0gMCApID8gJCggImJvZHkiICkgOiBjbG9zZXN0UGFnZSApLAoJCS8vIE5PVEUgbWFrZSBzdXJlIHRvIGdldCBvbmx5IHRoZSBoYXNoLCBpZTcgKHdwNykgcmV0dXJucyB0aGUgYWJzb2x1dGUgaHJlZgoJCS8vICAgICAgaW4gdGhpcyBjYXNlIHJ1aW5pbmcgdGhlIGVsZW1lbnQgc2VsZWN0aW9uCgkJcG9wdXAgPSAkKCBwYXRoLmhhc2hUb1NlbGVjdG9yKCBwYXRoLnBhcnNlVXJsKCAkbGluay5hdHRyKCAiaHJlZiIgKSApLmhhc2ggKSwgc2NvcGVbIDAgXSApLAoJCW9mZnNldDsKCglpZiAoIHBvcHVwLmRhdGEoICJtb2JpbGUtcG9wdXAiICkgKSB7CgkJb2Zmc2V0ID0gJGxpbmsub2Zmc2V0KCk7CgkJcG9wdXAucG9wdXAoICJvcGVuIiwgewoJCQl4OiBvZmZzZXQubGVmdCArICRsaW5rLm91dGVyV2lkdGgoKSAvIDIsCgkJCXk6IG9mZnNldC50b3AgKyAkbGluay5vdXRlckhlaWdodCgpIC8gMiwKCQkJdHJhbnNpdGlvbjogJGxpbmsuanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCXBvc2l0aW9uVG86ICRsaW5rLmpxbURhdGEoICJwb3NpdGlvbi10byIgKQoJCX0pOwoJfQoKCS8vcmVtb3ZlIGFmdGVyIGRlbGF5CglzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkkbGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCX0sIDMwMCApOwp9OwoKLy8gVE9ETyBtb3ZlIGluc2lkZSBfY3JlYXRlCiQubW9iaWxlLmRvY3VtZW50Lm9uKCAicGFnZWJlZm9yZWNoYW5nZSIsIGZ1bmN0aW9uKCB0aGVFdmVudCwgZGF0YSApIHsKCWlmICggZGF0YS5vcHRpb25zLnJvbGUgPT09ICJwb3B1cCIgKSB7CgkJJC5tb2JpbGUucG9wdXAuaGFuZGxlTGluayggZGF0YS5vcHRpb25zLmxpbmsgKTsKCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCi8qCiogY3VzdG9tICJzZWxlY3RtZW51IiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHVuZm9jdXNhYmxlSXRlbVNlbGVjdG9yID0gIi51aS1kaXNhYmxlZCwudWktbGktZGl2aWRlciwudWktc2NyZWVuLWhpZGRlbiw6anFtRGF0YShyb2xlPSdwbGFjZWhvbGRlcicpIiwKCWdvVG9BZGphY2VudEl0ZW0gPSBmdW5jdGlvbiggaXRlbSwgdGFyZ2V0LCBkaXJlY3Rpb24gKSB7CgkJdmFyIGFkamFjZW50ID0gaXRlbVsgZGlyZWN0aW9uICsgIkFsbCIgXSgpCgkJCS5ub3QoIHVuZm9jdXNhYmxlSXRlbVNlbGVjdG9yICkKCQkJLmZpcnN0KCk7CgoJCS8vIGlmIHRoZXJlJ3MgYSBwcmV2aW91cyBvcHRpb24sIGZvY3VzIGl0CgkJaWYgKCBhZGphY2VudC5sZW5ndGggKSB7CgkJCXRhcmdldAoJCQkJLmJsdXIoKQoJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCgkJCWFkamFjZW50LmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQl9Cgl9OwoKJC53aWRnZXQoICJtb2JpbGUuc2VsZWN0bWVudSIsICQubW9iaWxlLnNlbGVjdG1lbnUsIHsKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBvID0gdGhpcy5vcHRpb25zOwoKCQkvLyBDdXN0b20gc2VsZWN0cyBjYW5ub3QgZXhpc3QgaW5zaWRlIHBvcHVwcywgc28gcmV2ZXJ0IHRoZSAibmF0aXZlTWVudSIKCQkvLyBvcHRpb24gdG8gdHJ1ZSBpZiBhIHBhcmVudCBpcyBhIHBvcHVwCgkJby5uYXRpdmVNZW51ID0gby5uYXRpdmVNZW51IHx8ICggdGhpcy5lbGVtZW50LnBhcmVudHMoICI6anFtRGF0YShyb2xlPSdwb3B1cCcpLDptb2JpbGUtcG9wdXAiICkubGVuZ3RoID4gMCApOwoKCQlyZXR1cm4gdGhpcy5fc3VwZXIoKTsKCX0sCgoJX2hhbmRsZVNlbGVjdEZvY3VzOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYmx1cigpOwoJCXRoaXMuYnV0dG9uLmZvY3VzKCk7Cgl9LAoKCV9oYW5kbGVCdXR0b25WY2xpY2tLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5pc09wZW4gKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmIChldmVudC50eXBlID09PSAidmNsaWNrIiB8fAoJCQkJZXZlbnQua2V5Q29kZSAmJiAoZXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5FTlRFUiB8fCBldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLlNQQUNFKSkgewoKCQkJdGhpcy5fZGVjaWRlRm9ybWF0KCk7CgkJCWlmICggdGhpcy5tZW51VHlwZSA9PT0gIm92ZXJsYXkiICkgewoJCQkJdGhpcy5idXR0b24uYXR0ciggImhyZWYiLCAiIyIgKyB0aGlzLnBvcHVwSWQgKS5hdHRyKCAiZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInJlbCIsICJwb3B1cCIgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuYnV0dG9uLmF0dHIoICJocmVmIiwgIiMiICsgdGhpcy5kaWFsb2dJZCApLmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAicmVsIiwgImRpYWxvZyIgKTsKCQkJfQoJCQl0aGlzLmlzT3BlbiA9IHRydWU7CgkJCS8vIERvIG5vdCBwcmV2ZW50IGRlZmF1bHQsIHNvIHRoZSBuYXZpZ2F0aW9uIG1heSBoYXZlIGEgY2hhbmNlIHRvIGFjdHVhbGx5IG9wZW4gdGhlIGNob3NlbiBmb3JtYXQKCQl9Cgl9LAoKCV9oYW5kbGVMaXN0Rm9jdXM6IGZ1bmN0aW9uKCBlICkgewoJCXZhciBwYXJhbXMgPSAoIGUudHlwZSA9PT0gImZvY3VzaW4iICkgPwoJCQl7IHRhYmluZGV4OiAiMCIsIGV2ZW50OiAidm1vdXNlb3ZlciIgfToKCQkJeyB0YWJpbmRleDogIi0xIiwgZXZlbnQ6ICJ2bW91c2VvdXQiIH07CgoJCSQoIGUudGFyZ2V0ICkKCQkJLmF0dHIoICJ0YWJpbmRleCIsIHBhcmFtcy50YWJpbmRleCApCgkJCS50cmlnZ2VyKCBwYXJhbXMuZXZlbnQgKTsKCX0sCgoJX2hhbmRsZUxpc3RLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLAoJCQlsaSA9IHRhcmdldC5jbG9zZXN0KCAibGkiICk7CgoJCS8vIHN3aXRjaCBsb2dpYyBiYXNlZCBvbiB3aGljaCBrZXkgd2FzIHByZXNzZWQKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQkvLyB1cCBvciBsZWZ0IGFycm93IGtleXMKCQljYXNlIDM4OgoJCQlnb1RvQWRqYWNlbnRJdGVtKCBsaSwgdGFyZ2V0LCAicHJldiIgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCQkvLyBkb3duIG9yIHJpZ2h0IGFycm93IGtleXMKCQljYXNlIDQwOgoJCQlnb1RvQWRqYWNlbnRJdGVtKCBsaSwgdGFyZ2V0LCAibmV4dCIgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCQkvLyBJZiBlbnRlciBvciBzcGFjZSBpcyBwcmVzc2VkLCB0cmlnZ2VyIGNsaWNrCgkJY2FzZSAxMzoKCQljYXNlIDMyOgoJCQl0YXJnZXQudHJpZ2dlciggImNsaWNrIiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSwKCglfaGFuZGxlTWVudVBhZ2VIaWRlOiBmdW5jdGlvbigpIHsKCQkvLyBUT0RPIGNlbnRyYWxpemUgcGFnZSByZW1vdmFsIGJpbmRpbmcgLyBoYW5kbGluZyBpbiB0aGUgcGFnZSBwbHVnaW4uCgkJLy8gU3VnZ2VzdGlvbiBmcm9tIEBqYmxhcyB0byBkbyByZWZjb3VudGluZwoJCS8vCgkJLy8gVE9ETyBleHRyZW1lbHkgY29uZnVzaW5nIGRlcGVuZGVuY3kgb24gdGhlIG9wZW4gbWV0aG9kIHdoZXJlIHRoZSBwYWdlaGlkZS5yZW1vdmUKCQkvLyBiaW5kaW5ncyBhcmUgc3RyaXBwZWQgdG8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBkaXNhcHBlYXJpbmcuIFRoZSB3YXkKCQkvLyB3ZSdyZSBrZWVwaW5nIHBhZ2VzIGluIHRoZSBET00gcmlnaHQgbm93IHN1Y2tzCgkJLy8KCQkvLyByZWJpbmQgdGhlIHBhZ2UgcmVtb3ZlIHRoYXQgd2FzIHVuYm91bmQgaW4gdGhlIG9wZW4gZnVuY3Rpb24KCQkvLyB0byBhbGxvdyBmb3IgdGhlIHBhcmVudCBwYWdlIHJlbW92YWwgZnJvbSBhY3Rpb25zIG90aGVyIHRoYW4gdGhlIHVzZQoJCS8vIG9mIGEgZGlhbG9nIHNpemVkIGN1c3RvbSBzZWxlY3QKCQkvLwoJCS8vIGRvaW5nIHRoaXMgaGVyZSBwcm92aWRlcyBmb3IgdGhlIGJhY2sgYnV0dG9uIG9uIHRoZSBjdXN0b20gc2VsZWN0IGRpYWxvZwoJCXRoaXMudGhpc1BhZ2UucGFnZSggImJpbmRSZW1vdmUiICk7Cgl9LAoKCV9oYW5kbGVIZWFkZXJDbG9zZUNsaWNrOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMubWVudVR5cGUgPT09ICJvdmVybGF5IiApIHsKCQkJdGhpcy5jbG9zZSgpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSwKCglidWlsZDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdElkLCBwb3B1cElkLCBkaWFsb2dJZCwgbGFiZWwsIHRoaXNQYWdlLCBpc011bHRpcGxlLCBtZW51SWQsIHRoZW1lQXR0ciwgb3ZlcmxheVRoZW1lQXR0ciwKCQkJZGl2aWRlclRoZW1lQXR0ciwgbWVudVBhZ2UsIGxpc3Rib3gsIGxpc3QsIGhlYWRlciwgaGVhZGVyVGl0bGUsIG1lbnVQYWdlQ29udGVudCwgbWVudVBhZ2VDbG9zZSwgaGVhZGVyQ2xvc2UsIHNlbGYsCgkJCW8gPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggby5uYXRpdmVNZW51ICkgewoJCQlyZXR1cm4gdGhpcy5fc3VwZXIoKTsKCQl9CgoJCXNlbGYgPSB0aGlzOwoJCXNlbGVjdElkID0gdGhpcy5zZWxlY3RJZDsKCQlwb3B1cElkID0gc2VsZWN0SWQgKyAiLWxpc3Rib3giOwoJCWRpYWxvZ0lkID0gc2VsZWN0SWQgKyAiLWRpYWxvZyI7CgkJbGFiZWwgPSB0aGlzLmxhYmVsOwoJCXRoaXNQYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQlpc011bHRpcGxlID0gdGhpcy5lbGVtZW50WyAwIF0ubXVsdGlwbGU7CgkJbWVudUlkID0gc2VsZWN0SWQgKyAiLW1lbnUiOwoJCXRoZW1lQXR0ciA9IG8udGhlbWUgPyAoICIgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWU9JyIgKyBvLnRoZW1lICsgIiciICkgOiAiIjsKCQlvdmVybGF5VGhlbWVBdHRyID0gby5vdmVybGF5VGhlbWUgPyAoICIgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWU9JyIgKyBvLm92ZXJsYXlUaGVtZSArICInIiApIDogIiI7CgkJZGl2aWRlclRoZW1lQXR0ciA9ICggby5kaXZpZGVyVGhlbWUgJiYgaXNNdWx0aXBsZSApID8gKCAiIGRhdGEtIiArICQubW9iaWxlLm5zICsgImRpdmlkZXItdGhlbWU9JyIgKyBvLmRpdmlkZXJUaGVtZSArICInIiApIDogIiI7CgkJbWVudVBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdkaWFsb2cnIGNsYXNzPSd1aS1zZWxlY3RtZW51JyBpZD0nIiArIGRpYWxvZ0lkICsgIiciICsgdGhlbWVBdHRyICsgb3ZlcmxheVRoZW1lQXR0ciArICI+IiArCgkJCSI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2hlYWRlcic+IiArCgkJCSI8ZGl2IGNsYXNzPSd1aS10aXRsZSc+IiArIGxhYmVsLmdldEVuY29kZWRUZXh0KCkgKyAiPC9kaXY+IisKCQkJIjwvZGl2PiIrCgkJCSI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2NvbnRlbnQnPjwvZGl2PiIrCgkJCSI8L2Rpdj4iICk7CgkJbGlzdGJveCA9ICQoICI8ZGl2IGlkPSciICsgcG9wdXBJZCArICInIGNsYXNzPSd1aS1zZWxlY3RtZW51Jz4iICkuaW5zZXJ0QWZ0ZXIoIHRoaXMuc2VsZWN0ICkucG9wdXAoeyB0aGVtZTogby5vdmVybGF5VGhlbWUgfSk7CgkJbGlzdCA9ICQoICI8dWwgY2xhc3M9J3VpLXNlbGVjdG1lbnUtbGlzdCcgaWQ9JyIgKyBtZW51SWQgKyAiJyByb2xlPSdsaXN0Ym94JyBhcmlhLWxhYmVsbGVkYnk9JyIgKyB0aGlzLmJ1dHRvbklkICsgIiciICsgdGhlbWVBdHRyICsgZGl2aWRlclRoZW1lQXR0ciArICI+IiApLmFwcGVuZFRvKCBsaXN0Ym94ICk7CgkJaGVhZGVyID0gJCggIjxkaXYgY2xhc3M9J3VpLWhlYWRlciB1aS1iYXItIiArICggby50aGVtZSA/IG8udGhlbWUgOiAiaW5oZXJpdCIgKSArICInPiIgKS5wcmVwZW5kVG8oIGxpc3Rib3ggKTsKCQloZWFkZXJUaXRsZSA9ICQoICI8aDEgY2xhc3M9J3VpLXRpdGxlJz4iICkuYXBwZW5kVG8oIGhlYWRlciApOwoKCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJaGVhZGVyQ2xvc2UgPSAkKCAiPGE+IiwgewoJCQkJInJvbGUiOiAiYnV0dG9uIiwKCQkJCSJ0ZXh0Ijogby5jbG9zZVRleHQsCgkJCQkiaHJlZiI6ICIjIiwKCQkJCSJjbGFzcyI6ICJ1aS1idG4gdWktY29ybmVyLWFsbCB1aS1idG4tbGVmdCB1aS1idG4taWNvbi1ub3RleHQgdWktaWNvbi1kZWxldGUiCgkJCX0pLmFwcGVuZFRvKCBoZWFkZXIgKTsKCQl9CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCXNlbGVjdElkOiBzZWxlY3RJZCwKCQkJbWVudUlkOiBtZW51SWQsCgkJCXBvcHVwSWQ6IHBvcHVwSWQsCgkJCWRpYWxvZ0lkOiBkaWFsb2dJZCwKCQkJdGhpc1BhZ2U6IHRoaXNQYWdlLAoJCQltZW51UGFnZTogbWVudVBhZ2UsCgkJCWxhYmVsOiBsYWJlbCwKCQkJaXNNdWx0aXBsZTogaXNNdWx0aXBsZSwKCQkJdGhlbWU6IG8udGhlbWUsCgkJCWxpc3Rib3g6IGxpc3Rib3gsCgkJCWxpc3Q6IGxpc3QsCgkJCWhlYWRlcjogaGVhZGVyLAoJCQloZWFkZXJUaXRsZTogaGVhZGVyVGl0bGUsCgkJCWhlYWRlckNsb3NlOiBoZWFkZXJDbG9zZSwKCQkJbWVudVBhZ2VDb250ZW50OiBtZW51UGFnZUNvbnRlbnQsCgkJCW1lbnVQYWdlQ2xvc2U6IG1lbnVQYWdlQ2xvc2UsCgkJCXBsYWNlaG9sZGVyOiAiIgoJCX0pOwoKCQkvLyBDcmVhdGUgbGlzdCBmcm9tIHNlbGVjdCwgdXBkYXRlIHN0YXRlCgkJdGhpcy5yZWZyZXNoKCk7CgoJCWlmICggdGhpcy5fb3JpZ1RhYkluZGV4ID09PSB1bmRlZmluZWQgKSB7CgkJCS8vIE1hcCB1bmRlZmluZWQgdG8gZmFsc2UsIGJlY2F1c2UgdGhpcy5fb3JpZ1RhYkluZGV4ID09PSB1bmRlZmluZWQKCQkJLy8gaW5kaWNhdGVzIHRoYXQgd2UgaGF2ZSBub3QgeWV0IGNoZWNrZWQgd2hldGhlciB0aGUgc2VsZWN0IGhhcwoJCQkvLyBvcmlnaW5hbGx5IGhhZCBhIHRhYmluZGV4IGF0dHJpYnV0ZSwgd2hlcmVhcyBmYWxzZSBpbmRpY2F0ZXMgdGhhdAoJCQkvLyB3ZSBoYXZlIGNoZWNrZWQgdGhlIHNlbGVjdCBmb3Igc3VjaCBhbiBhdHRyaWJ1dGUsIGFuZCBoYXZlIGZvdW5kCgkJCS8vIG5vbmUgcHJlc2VudC4KCQkJdGhpcy5fb3JpZ1RhYkluZGV4ID0gKCB0aGlzLnNlbGVjdFsgMCBdLmdldEF0dHJpYnV0ZSggInRhYmluZGV4IiApID09PSBudWxsICkgPyBmYWxzZSA6IHRoaXMuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIgKTsKCQl9CgkJdGhpcy5zZWxlY3QuYXR0ciggInRhYmluZGV4IiwgIi0xIiApOwoJCXRoaXMuX29uKCB0aGlzLnNlbGVjdCwgeyBmb2N1cyA6ICJfaGFuZGxlU2VsZWN0Rm9jdXMiIH0gKTsKCgkJLy8gQnV0dG9uIGV2ZW50cwoJCXRoaXMuX29uKCB0aGlzLmJ1dHRvbiwgewoJCQl2Y2xpY2sgOiAiX2hhbmRsZUJ1dHRvblZjbGlja0tleWRvd24iLAoJCQlrZXlkb3duIDogIl9oYW5kbGVCdXR0b25WY2xpY2tLZXlkb3duIgoJCX0pOwoKCQkvLyBFdmVudHMgZm9yIGxpc3QgaXRlbXMKCQl0aGlzLmxpc3QuYXR0ciggInJvbGUiLCAibGlzdGJveCIgKTsKCQl0aGlzLl9vbiggdGhpcy5saXN0LCB7CgkJCWZvY3VzaW4gOiAiX2hhbmRsZUxpc3RGb2N1cyIsCgkJCWZvY3Vzb3V0IDogIl9oYW5kbGVMaXN0Rm9jdXMiLAoJCQlrZXlkb3duOiAiX2hhbmRsZUxpc3RLZXlkb3duIgoJCX0pOwoJCXRoaXMubGlzdAoJCQkuZGVsZWdhdGUoICJsaTpub3QoLnVpLWRpc2FibGVkLCAudWktbGktZGl2aWRlcikiLCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJLy8gaW5kZXggb2Ygb3B0aW9uIHRhZyB0byBiZSBzZWxlY3RlZAoJCQkJdmFyIG9sZEluZGV4ID0gc2VsZi5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4LAoJCQkJCW5ld0luZGV4ID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAib3B0aW9uLWluZGV4IiApLAoJCQkJCW9wdGlvbiA9IHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5lcSggbmV3SW5kZXggKVsgMCBdOwoKCQkJCS8vIHRvZ2dsZSBzZWxlY3RlZCBzdGF0dXMgb24gdGhlIHRhZyBmb3IgbXVsdGkgc2VsZWN0cwoJCQkJb3B0aW9uLnNlbGVjdGVkID0gc2VsZi5pc011bHRpcGxlID8gIW9wdGlvbi5zZWxlY3RlZCA6IHRydWU7CgoJCQkJLy8gdG9nZ2xlIGNoZWNrYm94IGNsYXNzIGZvciBtdWx0aXBsZSBzZWxlY3RzCgkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkkKCB0aGlzICkuZmluZCggImEiICkKCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vbiIsIG9wdGlvbi5zZWxlY3RlZCApCgkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb2ZmIiwgIW9wdGlvbi5zZWxlY3RlZCApOwoJCQkJfQoKCQkJCS8vIHRyaWdnZXIgY2hhbmdlIGlmIHZhbHVlIGNoYW5nZWQKCQkJCWlmICggc2VsZi5pc011bHRpcGxlIHx8IG9sZEluZGV4ICE9PSBuZXdJbmRleCApIHsKCQkJCQlzZWxmLnNlbGVjdC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQkJfQoKCQkJCS8vIGhpZGUgY3VzdG9tIHNlbGVjdCBmb3Igc2luZ2xlIHNlbGVjdHMgb25seSAtIG90aGVyd2lzZSBmb2N1cyBjbGlja2VkIGl0ZW0KCQkJCS8vIFdlIG5lZWQgdG8gZ3JhYiB0aGUgY2xpY2tlZCBpdGVtIHRoZSBoYXJkIHdheSwgYmVjYXVzZSB0aGUgbGlzdCBtYXkgaGF2ZSBiZWVuIHJlYnVpbHQKCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKS5lcSggbmV3SW5kZXggKQoJCQkJCQkuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfQoKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0pOwoKCQkvLyBidXR0b24gcmVmb2N1cyBlbnN1cmVzIHByb3BlciBoZWlnaHQgY2FsY3VsYXRpb24KCQkvLyBieSByZW1vdmluZyB0aGUgaW5saW5lIHN0eWxlIGFuZCBlbnN1cmluZyBwYWdlIGluY2x1c2lvbgoJCXRoaXMuX29uKCB0aGlzLm1lbnVQYWdlLCB7IHBhZ2VoaWRlOiAiX2hhbmRsZU1lbnVQYWdlSGlkZSIgfSApOwoKCQkvLyBFdmVudHMgb24gdGhlIHBvcHVwCgkJdGhpcy5fb24oIHRoaXMubGlzdGJveCwgeyBwb3B1cGFmdGVyY2xvc2U6ICJjbG9zZSIgfSApOwoKCQkvLyBDbG9zZSBidXR0b24gb24gc21hbGwgb3ZlcmxheXMKCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5fb24oIHRoaXMuaGVhZGVyQ2xvc2UsIHsgY2xpY2s6ICJfaGFuZGxlSGVhZGVyQ2xvc2VDbGljayIgfSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9pc1JlYnVpbGRSZXF1aXJlZDogZnVuY3Rpb24oKSB7CgkJdmFyIGxpc3QgPSB0aGlzLmxpc3QuZmluZCggImxpIiApLAoJCQlvcHRpb25zID0gdGhpcy5fc2VsZWN0T3B0aW9ucygpLm5vdCggIi51aS1zY3JlZW4taGlkZGVuIiApOwoKCQkvLyBUT0RPIGV4Y2VlZGluZ2x5IG5haXZlIG1ldGhvZCB0byBkZXRlcm1pbmUgZGlmZmVyZW5jZQoJCS8vIGlnbm9yZXMgdmFsdWUgY2hhbmdlcyBldGMgaW4gZmF2b3Igb2YgYSBmb3JjZWRSZWJ1aWxkCgkJLy8gZnJvbSB0aGUgdXNlciBpbiB0aGUgcmVmcmVzaCBtZXRob2QKCQlyZXR1cm4gb3B0aW9ucy50ZXh0KCkgIT09IGxpc3QudGV4dCgpOwoJfSwKCglzZWxlY3RlZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NlbGVjdE9wdGlvbnMoKS5maWx0ZXIoICI6c2VsZWN0ZWQ6bm90KCA6anFtRGF0YShwbGFjZWhvbGRlcj0ndHJ1ZScpICkiICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBmb3JjZSApIHsKCQl2YXIgc2VsZiwgaW5kaWNlczsKCgkJaWYgKCB0aGlzLm9wdGlvbnMubmF0aXZlTWVudSApIHsKCQkJcmV0dXJuIHRoaXMuX3N1cGVyKCBmb3JjZSApOwoJCX0KCgkJc2VsZiA9IHRoaXM7CgkJaWYgKCBmb3JjZSB8fCB0aGlzLl9pc1JlYnVpbGRSZXF1aXJlZCgpICkgewoJCQlzZWxmLl9idWlsZExpc3QoKTsKCQl9CgoJCWluZGljZXMgPSB0aGlzLnNlbGVjdGVkSW5kaWNlcygpOwoKCQlzZWxmLnNldEJ1dHRvblRleHQoKTsKCQlzZWxmLnNldEJ1dHRvbkNvdW50KCk7CgoJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKQoJCQkuZmluZCggImEiICkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkuZW5kKCkKCQkJLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgZmFsc2UgKQoJCQkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJCQlpZiAoICQuaW5BcnJheSggaSwgaW5kaWNlcyApID4gLTEgKSB7CgkJCQkJdmFyIGl0ZW0gPSAkKCB0aGlzICk7CgoJCQkJCS8vIEFyaWEgc2VsZWN0ZWQgYXR0cgoJCQkJCWl0ZW0uYXR0ciggImFyaWEtc2VsZWN0ZWQiLCB0cnVlICk7CgoJCQkJCS8vIE11bHRpcGxlIHNlbGVjdHM6IGFkZCB0aGUgIm9uIiBjaGVja2JveCBzdGF0ZSB0byB0aGUgaWNvbgoJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQlpdGVtLmZpbmQoICJhIiApLnJlbW92ZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vZmYiICkuYWRkQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9uIiApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWlmICggaXRlbS5oYXNDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICkgKSB7CgkJCQkJCQlpdGVtLm5leHQoKS5maW5kKCAiYSIgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWl0ZW0uZmluZCggImEiICkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0pOwoJfSwKCgljbG9zZTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgIXRoaXMuaXNPcGVuICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCWlmICggc2VsZi5tZW51VHlwZSA9PT0gInBhZ2UiICkgewoJCQlzZWxmLm1lbnVQYWdlLmRpYWxvZyggImNsb3NlIiApOwoJCQlzZWxmLmxpc3QuYXBwZW5kVG8oIHNlbGYubGlzdGJveCApOwoJCX0gZWxzZSB7CgkJCXNlbGYubGlzdGJveC5wb3B1cCggImNsb3NlIiApOwoJCX0KCgkJc2VsZi5fZm9jdXNCdXR0b24oKTsKCQkvLyBhbGxvdyB0aGUgZGlhbG9nIHRvIGJlIGNsb3NlZCBhZ2FpbgoJCXNlbGYuaXNPcGVuID0gZmFsc2U7Cgl9LAoKCW9wZW46IGZ1bmN0aW9uKCkgewoJCXRoaXMuYnV0dG9uLmNsaWNrKCk7Cgl9LAoKCV9mb2N1c01lbnVJdGVtOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0b3IgPSB0aGlzLmxpc3QuZmluZCggImEuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJaWYgKCBzZWxlY3Rvci5sZW5ndGggPT09IDAgKSB7CgkJCXNlbGVjdG9yID0gdGhpcy5saXN0LmZpbmQoICJsaTpub3QoIiArIHVuZm9jdXNhYmxlSXRlbVNlbGVjdG9yICsgIikgYS51aS1idG4iICk7CgkJfQoJCXNlbGVjdG9yLmZpcnN0KCkuZm9jdXMoKTsKCX0sCgoJX2RlY2lkZUZvcm1hdDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQkkd2luZG93ID0gJC5tb2JpbGUud2luZG93LAoJCQlzZWxmTGlzdFBhcmVudCA9IHNlbGYubGlzdC5wYXJlbnQoKSwKCQkJbWVudUhlaWdodCA9IHNlbGZMaXN0UGFyZW50Lm91dGVySGVpZ2h0KCksCgkJCXNjcm9sbFRvcCA9ICR3aW5kb3cuc2Nyb2xsVG9wKCksCgkJCWJ0bk9mZnNldCA9IHNlbGYuYnV0dG9uLm9mZnNldCgpLnRvcCwKCQkJc2NyZWVuSGVpZ2h0ID0gJHdpbmRvdy5oZWlnaHQoKTsKCgkJaWYgKCBtZW51SGVpZ2h0ID4gc2NyZWVuSGVpZ2h0IC0gODAgfHwgISQuc3VwcG9ydC5zY3JvbGxUb3AgKSB7CgoJCQlzZWxmLm1lbnVQYWdlLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICkucGFnZSgpOwoJCQlzZWxmLm1lbnVQYWdlQ29udGVudCA9IHNlbGYubWVudVBhZ2UuZmluZCggIi51aS1jb250ZW50IiApOwoJCQlzZWxmLm1lbnVQYWdlQ2xvc2UgPSBzZWxmLm1lbnVQYWdlLmZpbmQoICIudWktaGVhZGVyIGEiICk7CgoJCQkvLyBwcmV2ZW50IHRoZSBwYXJlbnQgcGFnZSBmcm9tIGJlaW5nIHJlbW92ZWQgZnJvbSB0aGUgRE9NLAoJCQkvLyBvdGhlcndpc2UgdGhlIHJlc3VsdHMgb2Ygc2VsZWN0aW5nIGEgbGlzdCBpdGVtIGluIHRoZSBkaWFsb2cKCQkJLy8gZmFsbCBpbnRvIGEgYmxhY2sgaG9sZQoJCQlzZWxmLnRoaXNQYWdlLnVuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIgKTsKCgkJCS8vZm9yIFdlYk9TL09wZXJhIE1pbmkgKHNldCBsYXN0c2Nyb2xsIHVzaW5nIGJ1dHRvbiBvZmZzZXQpCgkJCWlmICggc2Nyb2xsVG9wID09PSAwICYmIGJ0bk9mZnNldCA+IHNjcmVlbkhlaWdodCApIHsKCQkJCXNlbGYudGhpc1BhZ2Uub25lKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuanFtRGF0YSggImxhc3RTY3JvbGwiLCBidG5PZmZzZXQgKTsKCQkJCX0pOwoJCQl9CgoJCQlzZWxmLm1lbnVQYWdlLm9uZSggewoJCQkJcGFnZXNob3c6ICQucHJveHkoIHRoaXMsICJfZm9jdXNNZW51SXRlbSIgKSwKCQkJCXBhZ2VoaWRlOiAkLnByb3h5KCB0aGlzLCAiY2xvc2UiICkKCQkJfSk7CgoJCQlzZWxmLm1lbnVUeXBlID0gInBhZ2UiOwoJCQlzZWxmLm1lbnVQYWdlQ29udGVudC5hcHBlbmQoIHNlbGYubGlzdCApOwoJCQlzZWxmLm1lbnVQYWdlLmZpbmQoICJkaXYgLnVpLXRpdGxlIiApLnRleHQoIHNlbGYubGFiZWwudGV4dCgpICk7CgkJfSBlbHNlIHsKCQkJc2VsZi5tZW51VHlwZSA9ICJvdmVybGF5IjsKCgkJCXNlbGYubGlzdGJveC5vbmUoIHsgcG9wdXBhZnRlcm9wZW46ICQucHJveHkoIHRoaXMsICJfZm9jdXNNZW51SXRlbSIgKSB9ICk7CgkJfQoJfSwKCglfYnVpbGRMaXN0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCXBsYWNlaG9sZGVyID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJbmVlZFBsYWNlaG9sZGVyID0gdHJ1ZSwKCQkJZGF0YUljb24gPSB0aGlzLmlzTXVsdGlwbGUgPyAiY2hlY2tib3gtb2ZmIiA6ICJmYWxzZSIsCgkJCSRvcHRpb25zLCBudW1PcHRpb25zLCBzZWxlY3QsCgkJCWRhdGFQcmVmaXggPSAiZGF0YS0iICsgJC5tb2JpbGUubnMsCgkJCWRhdGFJbmRleEF0dHIgPSBkYXRhUHJlZml4ICsgIm9wdGlvbi1pbmRleCIsCgkJCWRhdGFJY29uQXR0ciA9IGRhdGFQcmVmaXggKyAiaWNvbiIsCgkJCWRhdGFSb2xlQXR0ciA9IGRhdGFQcmVmaXggKyAicm9sZSIsCgkJCWRhdGFQbGFjZWhvbGRlckF0dHIgPSBkYXRhUHJlZml4ICsgInBsYWNlaG9sZGVyIiwKCQkJZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCgkJCWlzUGxhY2Vob2xkZXJJdGVtID0gZmFsc2UsCgkJCW9wdEdyb3VwLAoJCQlpLAoJCQlvcHRpb24sICRvcHRpb24sIHBhcmVudCwgdGV4dCwgYW5jaG9yLCBjbGFzc2VzLAoJCQlvcHRMYWJlbCwgZGl2aWRlciwgaXRlbTsKCgkJc2VsZi5saXN0LmVtcHR5KCkuZmlsdGVyKCAiLnVpLWxpc3R2aWV3IiApLmxpc3R2aWV3KCAiZGVzdHJveSIgKTsKCQkkb3B0aW9ucyA9IHRoaXMuX3NlbGVjdE9wdGlvbnMoKTsKCQludW1PcHRpb25zID0gJG9wdGlvbnMubGVuZ3RoOwoJCXNlbGVjdCA9IHRoaXMuc2VsZWN0WyAwIF07CgoJCWZvciAoIGkgPSAwOyBpIDwgbnVtT3B0aW9ucztpKyssIGlzUGxhY2Vob2xkZXJJdGVtID0gZmFsc2UpIHsKCQkJb3B0aW9uID0gJG9wdGlvbnNbaV07CgkJCSRvcHRpb24gPSAkKCBvcHRpb24gKTsKCgkJCS8vIERvIG5vdCBjcmVhdGUgb3B0aW9ucyBiYXNlZCBvbiB1aS1zY3JlZW4taGlkZGVuIHNlbGVjdCBvcHRpb25zCgkJCWlmICggJG9wdGlvbi5oYXNDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICkgKSB7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJcGFyZW50ID0gb3B0aW9uLnBhcmVudE5vZGU7CgkJCXRleHQgPSAkb3B0aW9uLnRleHQoKTsKCQkJYW5jaG9yICA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJhIiApOwoJCQljbGFzc2VzID0gW107CgoJCQlhbmNob3Iuc2V0QXR0cmlidXRlKCAiaHJlZiIsICIjIiApOwoJCQlhbmNob3IuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCB0ZXh0ICkgKTsKCgkJCS8vIEFyZSB3ZSBpbnNpZGUgYW4gb3B0Z3JvdXA/CgkJCWlmICggcGFyZW50ICE9PSBzZWxlY3QgJiYgcGFyZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJvcHRncm91cCIgKSB7CgkJCQlvcHRMYWJlbCA9IHBhcmVudC5nZXRBdHRyaWJ1dGUoICJsYWJlbCIgKTsKCQkJCWlmICggb3B0TGFiZWwgIT09IG9wdEdyb3VwICkgewoJCQkJCWRpdmlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAibGkiICk7CgkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoIGRhdGFSb2xlQXR0ciwgImxpc3QtZGl2aWRlciIgKTsKCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggInJvbGUiLCAib3B0aW9uIiApOwoJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAidGFiaW5kZXgiLCAiLTEiICk7CgkJCQkJZGl2aWRlci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIG9wdExhYmVsICkgKTsKCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggZGl2aWRlciApOwoJCQkJCW9wdEdyb3VwID0gb3B0TGFiZWw7CgkJCQl9CgkJCX0KCgkJCWlmICggbmVlZFBsYWNlaG9sZGVyICYmICggIW9wdGlvbi5nZXRBdHRyaWJ1dGUoICJ2YWx1ZSIgKSB8fCB0ZXh0Lmxlbmd0aCA9PT0gMCB8fCAkb3B0aW9uLmpxbURhdGEoICJwbGFjZWhvbGRlciIgKSApICkgewoJCQkJbmVlZFBsYWNlaG9sZGVyID0gZmFsc2U7CgkJCQlpc1BsYWNlaG9sZGVySXRlbSA9IHRydWU7CgoJCQkJLy8gSWYgd2UgaGF2ZSBpZGVudGlmaWVkIGEgcGxhY2Vob2xkZXIsIHJlY29yZCB0aGUgZmFjdCB0aGF0IGl0IHdhcwoJCQkJLy8gdXMgd2hvIGhhdmUgYWRkZWQgdGhlIHBsYWNlaG9sZGVyIHRvIHRoZSBvcHRpb24gYW5kIG1hcmsgaXQKCQkJCS8vIHJldHJvYWN0aXZlbHkgaW4gdGhlIHNlbGVjdCBhcyB3ZWxsCgkJCQlpZiAoIG51bGwgPT09IG9wdGlvbi5nZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIgKSApIHsKCQkJCQl0aGlzLl9yZW1vdmVQbGFjZWhvbGRlckF0dHIgPSB0cnVlOwoJCQkJfQoJCQkJb3B0aW9uLnNldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciwgdHJ1ZSApOwoJCQkJaWYgKCBvLmhpZGVQbGFjZWhvbGRlck1lbnVJdGVtcyApIHsKCQkJCQljbGFzc2VzLnB1c2goICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCQkJfQoJCQkJaWYgKCBwbGFjZWhvbGRlciAhPT0gdGV4dCApIHsKCQkJCQlwbGFjZWhvbGRlciA9IHNlbGYucGxhY2Vob2xkZXIgPSB0ZXh0OwoJCQkJfQoJCQl9CgoJCQlpdGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImxpIiApOwoJCQlpZiAoIG9wdGlvbi5kaXNhYmxlZCApIHsKCQkJCWNsYXNzZXMucHVzaCggInVpLWRpc2FibGVkIiApOwoJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCQl9CgkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhSW5kZXhBdHRyLCBpICk7CgkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhSWNvbkF0dHIsIGRhdGFJY29uICk7CgkJCWlmICggaXNQbGFjZWhvbGRlckl0ZW0gKSB7CgkJCQlpdGVtLnNldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciwgdHJ1ZSApOwoJCQl9CgkJCWl0ZW0uY2xhc3NOYW1lID0gY2xhc3Nlcy5qb2luKCAiICIgKTsKCQkJaXRlbS5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgIm9wdGlvbiIgKTsKCQkJYW5jaG9yLnNldEF0dHJpYnV0ZSggInRhYmluZGV4IiwgIi0xIiApOwoJCQlpdGVtLmFwcGVuZENoaWxkKCBhbmNob3IgKTsKCQkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGl0ZW0gKTsKCQl9CgoJCXNlbGYubGlzdFswXS5hcHBlbmRDaGlsZCggZnJhZ21lbnQgKTsKCgkJLy8gSGlkZSBoZWFkZXIgaWYgaXQncyBub3QgYSBtdWx0aXNlbGVjdCBhbmQgdGhlcmUncyBubyBwbGFjZWhvbGRlcgoJCWlmICggIXRoaXMuaXNNdWx0aXBsZSAmJiAhcGxhY2Vob2xkZXIubGVuZ3RoICkgewoJCQl0aGlzLmhlYWRlci5hZGRDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5oZWFkZXJUaXRsZS50ZXh0KCB0aGlzLnBsYWNlaG9sZGVyICk7CgkJfQoKCQkvLyBOb3cgcG9wdWxhdGVkLCBjcmVhdGUgbGlzdHZpZXcKCQlzZWxmLmxpc3QubGlzdHZpZXcoKTsKCX0sCgoJX2J1dHRvbjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMub3B0aW9ucy5uYXRpdmVNZW51ID8KCQkJdGhpcy5fc3VwZXIoKSA6CgkJCSQoICI8YT4iLCB7CgkJCQkiaHJlZiI6ICIjIiwKCQkJCSJyb2xlIjogImJ1dHRvbiIsCgkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJImlkIjogdGhpcy5idXR0b25JZCwKCQkJCSJhcmlhLWhhc3BvcHVwIjogInRydWUiLAoKCQkJCS8vIFRPRE8gdmFsdWUgaXMgdW5kZWZpbmVkIGF0IGNyZWF0aW9uCgkJCQkiYXJpYS1vd25zIjogdGhpcy5tZW51SWQKCQkJfSk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCgkJaWYgKCAhdGhpcy5vcHRpb25zLm5hdGl2ZU1lbnUgKSB7CgkJCXRoaXMuY2xvc2UoKTsKCgkJCS8vIFJlc3RvcmUgdGhlIHRhYmluZGV4IGF0dHJpYnV0ZSB0byBpdHMgb3JpZ2luYWwgdmFsdWUKCQkJaWYgKCB0aGlzLl9vcmlnVGFiSW5kZXggIT09IHVuZGVmaW5lZCApIHsKCQkJCWlmICggdGhpcy5fb3JpZ1RhYkluZGV4ICE9PSBmYWxzZSApIHsKCQkJCQl0aGlzLnNlbGVjdC5hdHRyKCAidGFiaW5kZXgiLCB0aGlzLl9vcmlnVGFiSW5kZXggKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5zZWxlY3QucmVtb3ZlQXR0ciggInRhYmluZGV4IiApOwoJCQkJfQoJCQl9CgoJCQkvLyBSZW1vdmUgdGhlIHBsYWNlaG9sZGVyIGF0dHJpYnV0ZSBpZiB3ZSB3ZXJlIHRoZSBvbmVzIHRvIGFkZCBpdAoJCQlpZiAoIHRoaXMuX3JlbW92ZVBsYWNlaG9sZGVyQXR0ciApIHsKCQkJCXRoaXMuX3NlbGVjdE9wdGlvbnMoKS5yZW1vdmVBdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicGxhY2Vob2xkZXIiICk7CgkJCX0KCgkJCS8vIFJlbW92ZSB0aGUgcG9wdXAKCQkJdGhpcy5saXN0Ym94LnJlbW92ZSgpOwoKCQkJLy8gUmVtb3ZlIHRoZSBkaWFsb2cKCQkJdGhpcy5tZW51UGFnZS5yZW1vdmUoKTsKCQl9CgoJCS8vIENoYWluIHVwCgkJdGhpcy5fc3VwZXIoKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoKLy8gR2VuZXJhbCBwb2xpY3k6IERvIG5vdCBhY2Nlc3MgZGF0YS0qIGF0dHJpYnV0ZXMgZXhjZXB0IGR1cmluZyBlbmhhbmNlbWVudC4KLy8gSW4gYWxsIG90aGVyIGNhc2VzIHdlIGRldGVybWluZSB0aGUgc3RhdGUgb2YgdGhlIGJ1dHRvbiBleGNsdXNpdmVseSBmcm9tIGl0cwovLyBjbGFzc05hbWUuIFRoYXQncyB3aHkgb3B0aW9uc1RvQ2xhc3NlcyBleHBlY3RzIGEgZnVsbCBjb21wbGVtZW50IG9mIG9wdGlvbnMsCi8vIGFuZCB0aGUgalF1ZXJ5IHBsdWdpbiBjb21wbGV0ZXMgdGhlIHNldCBvZiBvcHRpb25zIGZyb20gdGhlIGRlZmF1bHQgdmFsdWVzLgoKLy8gTWFwIGNsYXNzZXMgdG8gYnV0dG9uTWFya3VwIGJvb2xlYW4gb3B0aW9ucyAtIHVzZWQgaW4gY2xhc3NOYW1lVG9PcHRpb25zKCkKdmFyIHJldmVyc2VCb29sT3B0aW9uTWFwID0gewoJCSJ1aS1zaGFkb3ciIDogInNoYWRvdyIsCgkJInVpLWNvcm5lci1hbGwiIDogImNvcm5lcnMiLAoJCSJ1aS1idG4taW5saW5lIiA6ICJpbmxpbmUiLAoJCSJ1aS1zaGFkb3ctaWNvbiIgOiAiaWNvbnNoYWRvdyIsIC8qIFRPRE86IFJlbW92ZSBpbiAxLjUgKi8KCQkidWktbWluaSIgOiAibWluaSIKCX0sCglnZXRBdHRyRml4ZWQgPSBmdW5jdGlvbigpIHsKCQl2YXIgcmV0ID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCgkJcmV0dXJuICggcmV0ID09IG51bGwgPyB1bmRlZmluZWQgOiByZXQgKTsKCX0sCgljYXBpdGFsTGV0dGVyc1JFID0gL1tBLVpdL2c7CgovLyBvcHRpb25zVG9DbGFzc2VzOgovLyBAb3B0aW9uczogQSBjb21wbGV0ZSBzZXQgb2Ygb3B0aW9ucyB0byBjb252ZXJ0IHRvIGNsYXNzIG5hbWVzLgovLyBAZXhpc3RpbmdDbGFzc2VzOiBleHRyYSBjbGFzc2VzIHRvIGFkZCB0byB0aGUgcmVzdWx0Ci8vCi8vIENvbnZlcnRzIEBvcHRpb25zIHRvIGJ1dHRvbk1hcmt1cCBjbGFzc2VzIGFuZCByZXR1cm5zIHRoZSByZXN1bHQgYXMgYW4gYXJyYXkKLy8gdGhhdCBjYW4gYmUgY29udmVydGVkIHRvIGFuIGVsZW1lbnQncyBjbGFzc05hbWUgd2l0aCAuam9pbiggIiAiICkuIEFsbAovLyBwb3NzaWJsZSBvcHRpb25zIG11c3QgYmUgc2V0IGluc2lkZSBAb3B0aW9ucy4gVXNlICQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzCi8vIHRvIGdldCBhIGNvbXBsZXRlIHNldCBhbmQgdXNlICQuZXh0ZW5kIHRvIG92ZXJyaWRlIHlvdXIgY2hvaWNlIG9mIG9wdGlvbnMKLy8gZnJvbSB0aGF0IHNldC4KZnVuY3Rpb24gb3B0aW9uc1RvQ2xhc3Nlcyggb3B0aW9ucywgZXhpc3RpbmdDbGFzc2VzICkgewoJdmFyIGNsYXNzZXMgPSBleGlzdGluZ0NsYXNzZXMgPyBleGlzdGluZ0NsYXNzZXMgOiBbXTsKCgkvLyBBZGQgY2xhc3NlcyB0byB0aGUgYXJyYXkgLSBmaXJzdCB1aS1idG4KCWNsYXNzZXMucHVzaCggInVpLWJ0biIgKTsKCgkvLyBJZiB0aGVyZSBpcyBhIHRoZW1lCglpZiAoIG9wdGlvbnMudGhlbWUgKSB7CgkJY2xhc3Nlcy5wdXNoKCAidWktYnRuLSIgKyBvcHRpb25zLnRoZW1lICk7Cgl9CgoJLy8gSWYgdGhlcmUncyBhbiBpY29uLCBhZGQgdGhlIGljb24tcmVsYXRlZCBjbGFzc2VzCglpZiAoIG9wdGlvbnMuaWNvbiApIHsKCQljbGFzc2VzID0gY2xhc3Nlcy5jb25jYXQoWwoJCQkidWktaWNvbi0iICsgb3B0aW9ucy5pY29uLAoJCQkidWktYnRuLWljb24tIiArIG9wdGlvbnMuaWNvbnBvcwoJCV0pOwoJCWlmICggb3B0aW9ucy5pY29uc2hhZG93ICkgewoJCQljbGFzc2VzLnB1c2goICJ1aS1zaGFkb3ctaWNvbiIgKTsgLyogVE9ETzogUmVtb3ZlIGluIDEuNSAqLwoJCX0KCX0KCgkvLyBBZGQgdGhlIGFwcHJvcHJpYXRlIGNsYXNzIGZvciBlYWNoIGJvb2xlYW4gb3B0aW9uCglpZiAoIG9wdGlvbnMuaW5saW5lICkgewoJCWNsYXNzZXMucHVzaCggInVpLWJ0bi1pbmxpbmUiICk7Cgl9CglpZiAoIG9wdGlvbnMuc2hhZG93ICkgewoJCWNsYXNzZXMucHVzaCggInVpLXNoYWRvdyIgKTsKCX0KCWlmICggb3B0aW9ucy5jb3JuZXJzICkgewoJCWNsYXNzZXMucHVzaCggInVpLWNvcm5lci1hbGwiICk7Cgl9CglpZiAoIG9wdGlvbnMubWluaSApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1taW5pIiApOwoJfQoKCS8vIENyZWF0ZSBhIHN0cmluZyBmcm9tIHRoZSBhcnJheSBhbmQgcmV0dXJuIGl0CglyZXR1cm4gY2xhc3NlczsKfQoKLy8gY2xhc3NOYW1lVG9PcHRpb25zOgovLyBAY2xhc3NlczogQSBzdHJpbmcgY29udGFpbmluZyBhIC5jbGFzc05hbWUtc3R5bGUgc3BhY2Utc2VwYXJhdGVkIGNsYXNzIGxpc3QKLy8KLy8gTG9vcHMgb3ZlciBAY2xhc3NlcyBhbmQgY2FsY3VsYXRlcyBhbiBvcHRpb25zIG9iamVjdCBiYXNlZCBvbiB0aGUKLy8gYnV0dG9uTWFya3VwLXJlbGF0ZWQgY2xhc3NlcyBpdCBmaW5kcy4gSXQgcmVjb3JkcyB1bnJlY29nbml6ZWQgY2xhc3NlcyBpbiBhbgovLyBhcnJheS4KLy8KLy8gUmV0dXJuczogQW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGZvbGxvd2luZyBpdGVtczoKLy8KLy8gIm9wdGlvbnMiOiBidXR0b25NYXJrdXAgb3B0aW9ucyBmb3VuZCB0byBiZSBwcmVzZW50IGJlY2F1c2Ugb2YgdGhlCi8vIHByZXNlbmNlL2Fic2VuY2Ugb2YgY29ycmVzcG9uZGluZyBjbGFzc2VzCi8vCi8vICJ1bmtub3duQ2xhc3NlcyI6IGEgc3RyaW5nIGNvbnRhaW5pbmcgYWxsIHRoZSBub24tYnV0dG9uTWFya3VwLXJlbGF0ZWQKLy8gY2xhc3NlcyBmb3VuZCBpbiBAY2xhc3NlcwovLwovLyAiYWxyZWFkeUVuaGFuY2VkIjogQSBib29sZWFuIGluZGljYXRpbmcgd2hldGhlciB0aGUgdWktYnRuIGNsYXNzIHdhcyBhbW9uZwovLyB0aG9zZSBmb3VuZCB0byBiZSBwcmVzZW50CmZ1bmN0aW9uIGNsYXNzTmFtZVRvT3B0aW9ucyggY2xhc3NlcyApIHsKCXZhciBpZHgsIG1hcCwgdW5rbm93bkNsYXNzLAoJCWFscmVhZHlFbmhhbmNlZCA9IGZhbHNlLAoJCW5vSWNvbiA9IHRydWUsCgkJbyA9IHsKCQkJaWNvbjogIiIsCgkJCWlubGluZTogZmFsc2UsCgkJCXNoYWRvdzogZmFsc2UsCgkJCWNvcm5lcnM6IGZhbHNlLAoJCQlpY29uc2hhZG93OiBmYWxzZSwKCQkJbWluaTogZmFsc2UKCQl9LAoJCXVua25vd25DbGFzc2VzID0gW107CgoJY2xhc3NlcyA9IGNsYXNzZXMuc3BsaXQoICIgIiApOwoKCS8vIExvb3Agb3ZlciB0aGUgY2xhc3NlcwoJZm9yICggaWR4ID0gMCA7IGlkeCA8IGNsYXNzZXMubGVuZ3RoIDsgaWR4KysgKSB7CgoJCS8vIEFzc3VtZSBpdCdzIGFuIHVucmVjb2duaXplZCBjbGFzcwoJCXVua25vd25DbGFzcyA9IHRydWU7CgoJCS8vIFJlY29nbml6ZSBib29sZWFuIG9wdGlvbnMgZnJvbSB0aGUgcHJlc2VuY2Ugb2YgY2xhc3NlcwoJCW1hcCA9IHJldmVyc2VCb29sT3B0aW9uTWFwWyBjbGFzc2VzWyBpZHggXSBdOwoJCWlmICggbWFwICE9PSB1bmRlZmluZWQgKSB7CgkJCXVua25vd25DbGFzcyA9IGZhbHNlOwoJCQlvWyBtYXAgXSA9IHRydWU7CgoJCS8vIFJlY29nbml6ZSB0aGUgcHJlc2VuY2Ugb2YgYW4gaWNvbiBhbmQgZXN0YWJsaXNoIHRoZSBpY29uIHBvc2l0aW9uCgkJfSBlbHNlIGlmICggY2xhc3Nlc1sgaWR4IF0uaW5kZXhPZiggInVpLWJ0bi1pY29uLSIgKSA9PT0gMCApIHsKCQkJdW5rbm93bkNsYXNzID0gZmFsc2U7CgkJCW5vSWNvbiA9IGZhbHNlOwoJCQlvLmljb25wb3MgPSBjbGFzc2VzWyBpZHggXS5zdWJzdHJpbmcoIDEyICk7CgoJCS8vIEVzdGFibGlzaCB3aGljaCBpY29uIGlzIHByZXNlbnQKCQl9IGVsc2UgaWYgKCBjbGFzc2VzWyBpZHggXS5pbmRleE9mKCAidWktaWNvbi0iICkgPT09IDAgKSB7CgkJCXVua25vd25DbGFzcyA9IGZhbHNlOwoJCQlvLmljb24gPSBjbGFzc2VzWyBpZHggXS5zdWJzdHJpbmcoIDggKTsKCgkJLy8gRXN0YWJsaXNoIHRoZSB0aGVtZSAtIHRoaXMgcmVjb2duaXplcyBvbmUtbGV0dGVyIHRoZW1lIHN3YXRjaCBuYW1lcwoJCX0gZWxzZSBpZiAoIGNsYXNzZXNbIGlkeCBdLmluZGV4T2YoICJ1aS1idG4tIiApID09PSAwICYmIGNsYXNzZXNbIGlkeCBdLmxlbmd0aCA9PT0gOCApIHsKCQkJdW5rbm93bkNsYXNzID0gZmFsc2U7CgkJCW8udGhlbWUgPSBjbGFzc2VzWyBpZHggXS5zdWJzdHJpbmcoIDcgKTsKCgkJLy8gUmVjb2duaXplIHRoYXQgdGhpcyBlbGVtZW50IGhhcyBhbHJlYWR5IGJlZW4gYnV0dG9uTWFya3VwLWVuaGFuY2VkCgkJfSBlbHNlIGlmICggY2xhc3Nlc1sgaWR4IF0gPT09ICJ1aS1idG4iICkgewoJCQl1bmtub3duQ2xhc3MgPSBmYWxzZTsKCQkJYWxyZWFkeUVuaGFuY2VkID0gdHJ1ZTsKCQl9CgoJCS8vIElmIHRoaXMgY2xhc3MgaGFzIG5vdCBiZWVuIHJlY29nbml6ZWQsIGFkZCBpdCB0byB0aGUgbGlzdAoJCWlmICggdW5rbm93bkNsYXNzICkgewoJCQl1bmtub3duQ2xhc3Nlcy5wdXNoKCBjbGFzc2VzWyBpZHggXSApOwoJCX0KCX0KCgkvLyBJZiBhICJ1aS1idG4taWNvbi0qIiBpY29uIHBvc2l0aW9uIGNsYXNzIGlzIGFic2VudCB0aGVyZSBjYW5ub3QgYmUgYW4gaWNvbgoJaWYgKCBub0ljb24gKSB7CgkJby5pY29uID0gIiI7Cgl9CgoJcmV0dXJuIHsKCQlvcHRpb25zOiBvLAoJCXVua25vd25DbGFzc2VzOiB1bmtub3duQ2xhc3NlcywKCQlhbHJlYWR5RW5oYW5jZWQ6IGFscmVhZHlFbmhhbmNlZAoJfTsKfQoKZnVuY3Rpb24gY2FtZWxDYXNlMkh5cGhlbmF0ZWQoIGMgKSB7CglyZXR1cm4gIi0iICsgYy50b0xvd2VyQ2FzZSgpOwp9CgovLyAkLmZuLmJ1dHRvbk1hcmt1cDoKLy8gRE9NOiBnZXRzL3NldHMgLmNsYXNzTmFtZQovLwovLyBAb3B0aW9uczogb3B0aW9ucyB0byBhcHBseSB0byB0aGUgZWxlbWVudHMgaW4gdGhlIGpRdWVyeSBvYmplY3QKLy8gQG92ZXJ3cml0ZUNsYXNzZXM6IGJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIHRvIGhvbm91ciBleGlzdGluZyBjbGFzc2VzCi8vCi8vIENhbGN1bGF0ZXMgdGhlIGNsYXNzZXMgdG8gYXBwbHkgdG8gdGhlIGVsZW1lbnRzIGluIHRoZSBqUXVlcnkgb2JqZWN0IGJhc2VkIG9uCi8vIHRoZSBvcHRpb25zIHBhc3NlZCBpbi4gSWYgQG92ZXJ3cml0ZUNsYXNzZXMgaXMgdHJ1ZSwgaXQgc2V0cyB0aGUgY2xhc3NOYW1lCi8vIHByb3BlcnR5IG9mIGVhY2ggZWxlbWVudCBpbiB0aGUgalF1ZXJ5IG9iamVjdCB0byB0aGUgYnV0dG9uTWFya3VwIGNsYXNzZXMKLy8gaXQgY2FsY3VsYXRlcyBiYXNlZCBvbiB0aGUgb3B0aW9ucyBwYXNzZWQgaW4uCi8vCi8vIElmIHlvdSB3aXNoIHRvIHByZXNlcnZlIGFueSBjbGFzc2VzIHRoYXQgYXJlIGFscmVhZHkgcHJlc2VudCBvbiB0aGUgZWxlbWVudHMKLy8gaW5zaWRlIHRoZSBqUXVlcnkgb2JqZWN0LCBpbmNsdWRpbmcgYnV0dG9uTWFya3VwLXJlbGF0ZWQgY2xhc3NlcyB0aGF0IHdlcmUKLy8gYWRkZWQgYnkgYSBwcmV2aW91cyBjYWxsIHRvICQuZm4uYnV0dG9uTWFya3VwKCkgb3IgZHVyaW5nIHBhZ2UgZW5oYW5jZW1lbnQKLy8gdGhlbiB5b3Ugc2hvdWxkIG9taXQgQG92ZXJ3cml0ZUNsYXNzZXMgb3Igc2V0IGl0IHRvIGZhbHNlLgokLmZuLmJ1dHRvbk1hcmt1cCA9IGZ1bmN0aW9uKCBvcHRpb25zLCBvdmVyd3JpdGVDbGFzc2VzICkgewoJdmFyIGlkeCwgZGF0YSwgZWwsIHJldHJpZXZlZE9wdGlvbnMsIG9wdGlvbktleSwKCQlkZWZhdWx0cyA9ICQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzOwoKCWZvciAoIGlkeCA9IDAgOyBpZHggPCB0aGlzLmxlbmd0aCA7IGlkeCsrICkgewoJCWVsID0gdGhpc1sgaWR4IF07CgkJZGF0YSA9IG92ZXJ3cml0ZUNsYXNzZXMgPwoKCQkJLy8gQXNzdW1lIHRoaXMgZWxlbWVudCBpcyBub3QgZW5oYW5jZWQgYW5kIGlnbm9yZSBpdHMgY2xhc3NlcwoJCQl7IGFscmVhZHlFbmhhbmNlZDogZmFsc2UsIHVua25vd25DbGFzc2VzOiBbXSB9IDoKCgkJCS8vIE90aGVyd2lzZSBhbmFseXplIGV4aXN0aW5nIGNsYXNzZXMgdG8gZXN0YWJsaXNoIGV4aXN0aW5nIG9wdGlvbnMgYW5kCgkJCS8vIGNsYXNzZXMKCQkJY2xhc3NOYW1lVG9PcHRpb25zKCBlbC5jbGFzc05hbWUgKTsKCgkJcmV0cmlldmVkT3B0aW9ucyA9ICQuZXh0ZW5kKCB7fSwKCgkJCS8vIElmIHRoZSBlbGVtZW50IGFscmVhZHkgaGFzIHRoZSBjbGFzcyB1aS1idG4sIHRoZW4gd2UgYXNzdW1lIHRoYXQKCQkJLy8gaXQgaGFzIHBhc3NlZCB0aHJvdWdoIGJ1dHRvbk1hcmt1cCBiZWZvcmUgLSBvdGhlcndpc2UsIHRoZSBvcHRpb25zCgkJCS8vIHJldHVybmVkIGJ5IGNsYXNzTmFtZVRvT3B0aW9ucyBkbyBub3QgY29ycmVjdGx5IHJlZmxlY3QgdGhlIHN0YXRlIG9mCgkJCS8vIHRoZSBlbGVtZW50CgkJCSggZGF0YS5hbHJlYWR5RW5oYW5jZWQgPyBkYXRhLm9wdGlvbnMgOiB7fSApLAoKCQkJLy8gRmluYWxseSwgYXBwbHkgdGhlIG9wdGlvbnMgcGFzc2VkIGluCgkJCW9wdGlvbnMgKTsKCgkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgY2FsbCBvbiB0aGlzIGVsZW1lbnQsIHJldHJpZXZlIHJlbWFpbmluZyBvcHRpb25zCgkJLy8gZnJvbSB0aGUgZGF0YS1hdHRyaWJ1dGVzCgkJaWYgKCAhZGF0YS5hbHJlYWR5RW5oYW5jZWQgKSB7CgkJCWZvciAoIG9wdGlvbktleSBpbiBkZWZhdWx0cyApIHsKCQkJCWlmICggcmV0cmlldmVkT3B0aW9uc1sgb3B0aW9uS2V5IF0gPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXRyaWV2ZWRPcHRpb25zWyBvcHRpb25LZXkgXSA9IGdldEF0dHJGaXhlZCggZWwsCgkJCQkJCW9wdGlvbktleS5yZXBsYWNlKCBjYXBpdGFsTGV0dGVyc1JFLCBjYW1lbENhc2UySHlwaGVuYXRlZCApCgkJCQkJKTsKCQkJCX0KCQkJfQoJCX0KCgkJZWwuY2xhc3NOYW1lID0gb3B0aW9uc1RvQ2xhc3NlcygKCgkJCS8vIE1lcmdlIGFsbCB0aGUgb3B0aW9ucyBhbmQgYXBwbHkgdGhlbSBhcyBjbGFzc2VzCgkJCSQuZXh0ZW5kKCB7fSwKCgkJCQkvLyBUaGUgZGVmYXVsdHMgZm9ybSB0aGUgYmFzaXMKCQkJCWRlZmF1bHRzLAoKCQkJCS8vIEFkZCB0aGUgY29tcHV0ZWQgb3B0aW9ucwoJCQkJcmV0cmlldmVkT3B0aW9ucwoJCQkpLAoKCQkJLy8gLi4uIGFuZCByZS1hcHBseSBhbnkgdW5yZWNvZ25pemVkIGNsYXNzZXMgdGhhdCB3ZXJlIGZvdW5kCgkJCWRhdGEudW5rbm93bkNsYXNzZXMgKS5qb2luKCAiICIgKTsKCQllbC5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgImJ1dHRvbiIgKTsKCX0KCglyZXR1cm4gdGhpczsKfTsKCi8vIGJ1dHRvbk1hcmt1cCBkZWZhdWx0cy4gVGhpcyBtdXN0IGJlIGEgY29tcGxldGUgc2V0LCBpLmUuLCBhIHZhbHVlIG11c3QgYmUKLy8gZ2l2ZW4gaGVyZSBmb3IgYWxsIHJlY29nbml6ZWQgb3B0aW9ucwokLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0cyA9IHsKCWljb246ICIiLAoJaWNvbnBvczogImxlZnQiLAoJdGhlbWU6IG51bGwsCglpbmxpbmU6IGZhbHNlLAoJc2hhZG93OiB0cnVlLAoJY29ybmVyczogdHJ1ZSwKCWljb25zaGFkb3c6IGZhbHNlLCAvKiBUT0RPOiBSZW1vdmUgaW4gMS41LiBPcHRpb24gZGVwcmVjYXRlZCBpbiAxLjQuICovCgltaW5pOiBmYWxzZQp9OwoKJC5leHRlbmQoICQuZm4uYnV0dG9uTWFya3VwLCB7Cglpbml0U2VsZWN0b3I6ICJhOmpxbURhdGEocm9sZT0nYnV0dG9uJyksIC51aS1iYXIgPiBhLCAudWktYmFyID4gOmpxbURhdGEocm9sZT0nY29udHJvbGdyb3VwJykgPiBhLCBidXR0b24iCn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29udHJvbGdyb3VwIiwgJC5leHRlbmQoIHsKCW9wdGlvbnM6IHsKCQllbmhhbmNlZDogZmFsc2UsCgkJdGhlbWU6IG51bGwsCgkJc2hhZG93OiBmYWxzZSwKCQljb3JuZXJzOiB0cnVlLAoJCWV4Y2x1ZGVJbnZpc2libGU6IHRydWUsCgkJdHlwZTogInZlcnRpY2FsIiwKCQltaW5pOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJLy8gUnVuIGJ1dHRvbm1hcmt1cAoJCWlmKCAkLm1vYmlsZS5lbmhhbmNlV2l0aEJ1dHRvbk1hcmt1cCApewoJCQl0aGlzLmVsZW1lbnQuZmluZCggJC5tb2JpbGUuZW5oYW5jZVdpdGhCdXR0b25NYXJrdXAuaW5pdFNlbGVjdG9yICkuZWFjaCggJC5tb2JpbGUuZW5oYW5jZVdpdGhCdXR0b25NYXJrdXAgKTsKCQl9CgkJLy8gRW5oYW5jZSBjaGlsZCB3aWRnZXRzCgkJJC5lYWNoKCB0aGlzLl9jaGlsZFdpZGdldHMsICQucHJveHkoIGZ1bmN0aW9uKCBudW1iZXIsIHdpZGdldE5hbWUgKSB7CgkJCWlmKCAkLm1vYmlsZVsgd2lkZ2V0TmFtZSBdICkgewoJCQkJdGhpcy5lbGVtZW50LmZpbmQoICQubW9iaWxlWyB3aWRnZXROYW1lIF0uaW5pdFNlbGVjdG9yIClbIHdpZGdldE5hbWUgXSgpOwoJCQl9CgkJfSwgdGhpcyApKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3VpOiBudWxsLAoJCQlfaW5pdGlhbFJlZnJlc2g6IHRydWUKCQl9KTsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQl0aGlzLl91aSA9IHsKCQkJCWdyb3VwTGVnZW5kOiBlbGVtLmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1sYWJlbCIgKS5jaGlsZHJlbigpLAoJCQkJY2hpbGRXcmFwcGVyOiBlbGVtLmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1jb250cm9scyIgKQoJCQl9OwoJCX0gZWxzZSB7CgkJCXRoaXMuX3VpID0gdGhpcy5fZW5oYW5jZSgpOwoJCX0KCQkKCX0sCgoJX2NoaWxkV2lkZ2V0czogWyAiY2hlY2tib3hyYWRpbyIsICJzZWxlY3RtZW51IiwgImJ1dHRvbiIgXSwKCglfdGhlbWVDbGFzc0Zyb21PcHRpb246IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlyZXR1cm4gKCB2YWx1ZSA/ICggdmFsdWUgPT09ICJub25lIiA/ICIiIDogInVpLWdyb3VwLXRoZW1lLSIgKyB2YWx1ZSApIDogIiIgKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQlvcHRzID0gdGhpcy5vcHRpb25zLAoJCQl1aSA9IHsKCQkJCWdyb3VwTGVnZW5kOiBlbGVtLmNoaWxkcmVuKCAibGVnZW5kIiApLAoJCQkJY2hpbGRXcmFwcGVyOiBlbGVtCgkJCQkJLmFkZENsYXNzKCAidWktY29udHJvbGdyb3VwICIgKwoJCQkJCQkidWktY29udHJvbGdyb3VwLSIgKwoJCQkJCQkJKCBvcHRzLnR5cGUgPT09ICJob3Jpem9udGFsIiA/ICJob3Jpem9udGFsIiA6ICJ2ZXJ0aWNhbCIgKSArICIgIiArCgkJCQkJCXRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCBvcHRzLnRoZW1lICkgKyAiICIgKwoJCQkJCQkoIG9wdHMuY29ybmVycyA/ICJ1aS1jb3JuZXItYWxsICIgOiAiIiApICsKCQkJCQkJKCBvcHRzLm1pbmkgPyAidWktbWluaSAiIDogIiIgKSApCgkJCQkJLndyYXBJbm5lciggIjxkaXYgIiArCgkJCQkJCSJjbGFzcz0ndWktY29udHJvbGdyb3VwLWNvbnRyb2xzICIgKwoJCQkJCQkJKCBvcHRzLnNoYWRvdyA9PT0gdHJ1ZSA/ICJ1aS1zaGFkb3ciIDogIiIgKSArICInPjwvZGl2PiIgKQoJCQkJCS5jaGlsZHJlbigpCgkJCX07CgoJCWlmICggdWkuZ3JvdXBMZWdlbmQubGVuZ3RoID4gMCApIHsKCQkJJCggIjxkaXYgcm9sZT0naGVhZGluZycgY2xhc3M9J3VpLWNvbnRyb2xncm91cC1sYWJlbCc+PC9kaXY+IiApCgkJCQkuYXBwZW5kKCB1aS5ncm91cExlZ2VuZCApCgkJCQkucHJlcGVuZFRvKCBlbGVtICk7CgkJfQoKCQlyZXR1cm4gdWk7Cgl9LAoKCV9pbml0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBjYWxsUmVmcmVzaCwKCQkJZWxlbSA9IHRoaXMuZWxlbWVudDsKCgkJLy8gTXVzdCBoYXZlIG9uZSBvZiBob3Jpem9udGFsIG9yIHZlcnRpY2FsCgkJaWYgKCBvcHRpb25zLnR5cGUgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbQoJCQkJLnJlbW92ZUNsYXNzKCAidWktY29udHJvbGdyb3VwLWhvcml6b250YWwgdWktY29udHJvbGdyb3VwLXZlcnRpY2FsIiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1jb250cm9sZ3JvdXAtIiArICggb3B0aW9ucy50eXBlID09PSAiaG9yaXpvbnRhbCIgPyAiaG9yaXpvbnRhbCIgOiAidmVydGljYWwiICkgKTsKCQkJY2FsbFJlZnJlc2ggPSB0cnVlOwoJCX0KCgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCWVsZW0KCQkJCS5yZW1vdmVDbGFzcyggdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oIHRoaXMub3B0aW9ucy50aGVtZSApICkKCQkJCS5hZGRDbGFzcyggdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oIG9wdGlvbnMudGhlbWUgKSApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBvcHRpb25zLmNvcm5lcnMgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCWVsZW0udG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgb3B0aW9ucy5taW5pICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuc2hhZG93ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3VpLmNoaWxkV3JhcHBlci50b2dnbGVDbGFzcyggInVpLXNoYWRvdyIsIG9wdGlvbnMuc2hhZG93ICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuZXhjbHVkZUludmlzaWJsZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLm9wdGlvbnMuZXhjbHVkZUludmlzaWJsZSA9IG9wdGlvbnMuZXhjbHVkZUludmlzaWJsZTsKCQkJY2FsbFJlZnJlc2ggPSB0cnVlOwoJCX0KCgkJaWYgKCBjYWxsUmVmcmVzaCApIHsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJfQoKCQlyZXR1cm4gdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0sCgoJY29udGFpbmVyOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fdWkuY2hpbGRXcmFwcGVyOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gdGhpcy5jb250YWluZXIoKSwKCQkJZWxzID0gJGVsLmZpbmQoICIudWktYnRuIiApLm5vdCggIi51aS1zbGlkZXItaGFuZGxlIiApLAoJCQljcmVhdGUgPSB0aGlzLl9pbml0aWFsUmVmcmVzaDsKCQlpZiAoICQubW9iaWxlLmNoZWNrYm94cmFkaW8gKSB7CgkJCSRlbC5maW5kKCAiOm1vYmlsZS1jaGVja2JveHJhZGlvIiApLmNoZWNrYm94cmFkaW8oICJyZWZyZXNoIiApOwoJCX0KCQl0aGlzLl9hZGRGaXJzdExhc3RDbGFzc2VzKCBlbHMsCgkJCXRoaXMub3B0aW9ucy5leGNsdWRlSW52aXNpYmxlID8gdGhpcy5fZ2V0VmlzaWJsZXMoIGVscywgY3JlYXRlICkgOiBlbHMsCgkJCWNyZWF0ZSApOwoJCXRoaXMuX2luaXRpYWxSZWZyZXNoID0gZmFsc2U7Cgl9LAoKCS8vIENhdmVhdDogSWYgdGhlIGxlZ2VuZCBpcyBub3QgdGhlIGZpcnN0IGNoaWxkIG9mIHRoZSBjb250cm9sZ3JvdXAgYXQgZW5oYW5jZQoJLy8gdGltZSwgaXQgd2lsbCBiZSBhZnRlciBfZGVzdHJveSgpLgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciB1aSwgYnV0dG9ucywKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXVpID0gdGhpcy5fdWk7CgkJYnV0dG9ucyA9IHRoaXMuZWxlbWVudAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb250cm9sZ3JvdXAgIiArCgkJCQkidWktY29udHJvbGdyb3VwLWhvcml6b250YWwgdWktY29udHJvbGdyb3VwLXZlcnRpY2FsIHVpLWNvcm5lci1hbGwgdWktbWluaSAiICsKCQkJCXRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCBvcHRzLnRoZW1lICkgKQoJCQkuZmluZCggIi51aS1idG4iICkKCQkJLm5vdCggIi51aS1zbGlkZXItaGFuZGxlIiApOwoKCQl0aGlzLl9yZW1vdmVGaXJzdExhc3RDbGFzc2VzKCBidXR0b25zICk7CgoJCXVpLmdyb3VwTGVnZW5kLnVud3JhcCgpOwoJCXVpLmNoaWxkV3JhcHBlci5jaGlsZHJlbigpLnVud3JhcCgpOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyApICk7Cgp9KShqUXVlcnkpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoKCSQud2lkZ2V0KCAibW9iaWxlLnRvb2xiYXIiLCB7CgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nZm9vdGVyJyksIDpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiwKCgkJb3B0aW9uczogewoJCQl0aGVtZTogbnVsbCwKCQkJYWRkQmFja0J0bjogZmFsc2UsCgkJCWJhY2tCdG5UaGVtZTogbnVsbCwKCQkJYmFja0J0blRleHQ6ICJCYWNrIgoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbGVmdGJ0biwgcmlnaHRidG4sIGJhY2tCdG4sCgkJCQlyb2xlID0gIHRoaXMuZWxlbWVudC5pcyggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApID8gImhlYWRlciIgOiAiZm9vdGVyIiwKCQkJCXBhZ2UgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICl7CgkJCQlwYWdlID0gZmFsc2U7CgkJCQl0aGlzLl9vbiggJC5tb2JpbGUuZG9jdW1lbnQsIHsKCQkJCQkicGFnZXNob3ciOiAicmVmcmVzaCIKCQkJCX0pOwoJCQl9CgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlyb2xlOiByb2xlLAoJCQkJcGFnZTogcGFnZSwKCQkJCWxlZnRidG46IGxlZnRidG4sCgkJCQlyaWdodGJ0bjogcmlnaHRidG4sCgkJCQliYWNrQnRuOiBiYWNrQnRuCgkJCX0pOwoJCQl0aGlzLmVsZW1lbnQuYXR0ciggInJvbGUiLCByb2xlID09PSAiaGVhZGVyIiA/ICJiYW5uZXIiIDogImNvbnRlbnRpbmZvIiApLmFkZENsYXNzKCAidWktIiArIHJvbGUgKTsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJCXRoaXMuX3NldE9wdGlvbnMoIHRoaXMub3B0aW9ucyApOwoJCX0sCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvICkgewoJCQlpZiAoIG8uYWRkQmFja0J0biAhPT0gdW5kZWZpbmVkICkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuYWRkQmFja0J0biAmJgoJCQkJCXRoaXMucm9sZSA9PT0gImhlYWRlciIgJiYKCQkJCQkkKCAiLnVpLXBhZ2UiICkubGVuZ3RoID4gMSAmJgoJCQkJCXRoaXMucGFnZVsgMCBdLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIgKSAhPT0gJC5tb2JpbGUucGF0aC5zdHJpcEhhc2goIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJCSF0aGlzLmxlZnRidG4gKSB7CgkJCQkJCXRoaXMuX2FkZEJhY2tCdXR0b24oKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5lbGVtZW50LmZpbmQoICIudWktdG9vbGJhci1iYWNrLWJ0biIgKS5yZW1vdmUoKTsKCQkJCX0KCQkJfQoJCQlpZiAoIG8uYmFja0J0blRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLmVsZW1lbnQKCQkJCQkuZmluZCggIi51aS10b29sYmFyLWJhY2stYnRuIiApCgkJCQkJLmFkZENsYXNzKCAidWktYnRuIHVpLWJ0bi0iICsgby5iYWNrQnRuVGhlbWUgKTsKCQkJfQoJCQlpZiAoIG8uYmFja0J0blRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXRvb2xiYXItYmFjay1idG4gLnVpLWJ0bi10ZXh0IiApLnRleHQoIG8uYmFja0J0blRleHQgKTsKCQkJfQoJCQlpZiAoIG8udGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXZhciBjdXJyZW50VGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUgPyB0aGlzLm9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIsCgkJCQkJbmV3VGhlbWUgPSBvLnRoZW1lID8gby50aGVtZSA6ICJpbmhlcml0IjsKCgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1iYXItIiArIGN1cnJlbnRUaGVtZSApLmFkZENsYXNzKCAidWktYmFyLSIgKyBuZXdUaGVtZSApOwoJCQl9CgoJCQl0aGlzLl9zdXBlciggbyApOwoJCX0sCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy5yb2xlID09PSAiaGVhZGVyIiApIHsKCQkJCXRoaXMuX2FkZEhlYWRlckJ1dHRvbkNsYXNzZXMoKTsKCQkJfQoJCQlpZiAoICF0aGlzLnBhZ2UgKSB7CgkJCQkkKCAiW2RhdGEtIisgJC5tb2JpbGUubnMgKyJyb2xlPSdwYWdlJ10iICkuY3NzKHsicG9zaXRpb24iOiJyZWxhdGl2ZSJ9KTsKCQkJCWlmICggdGhpcy5yb2xlID09PSAiZm9vdGVyIiApIHsKCQkJCQl0aGlzLmVsZW1lbnQuYXBwZW5kVG8oICJib2R5IiApOwoJCQkJfQoJCQl9CgkJCXRoaXMuX2FkZEhlYWRpbmdDbGFzc2VzKCk7CgkJCXRoaXMuX2J0bk1hcmt1cCgpOwoJCX0sCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQuIEFzIGZyb20gMS41IGRhdGEtcm9sZT0iYnV0dG9uIiBoYXMgdG8gYmUgcHJlc2VudCBpbiB0aGUgbWFya3VwLgoJCV9idG5NYXJrdXA6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICJhIiApLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlIiwgImJ1dHRvbiIgKTsKCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJjcmVhdGUiICk7CgkJfSwKCQlfYWRkSGVhZGVyQnV0dG9uQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJCXZhciAkaGVhZGVyYW5jaG9ycyA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbiggImEsIGJ1dHRvbiIgKTsKCQkJdGhpcy5sZWZ0YnRuID0gJGhlYWRlcmFuY2hvcnMuaGFzQ2xhc3MoICJ1aS1idG4tbGVmdCIgKTsKCQkJdGhpcy5yaWdodGJ0biA9ICRoZWFkZXJhbmNob3JzLmhhc0NsYXNzKCAidWktYnRuLXJpZ2h0IiApOwoKCQkJdGhpcy5sZWZ0YnRuID0gdGhpcy5sZWZ0YnRuIHx8ICRoZWFkZXJhbmNob3JzLmVxKCAwICkubm90KCAiLnVpLWJ0bi1yaWdodCIgKS5hZGRDbGFzcyggInVpLWJ0bi1sZWZ0IiApLmxlbmd0aDsKCgkJCXRoaXMucmlnaHRidG4gPSB0aGlzLnJpZ2h0YnRuIHx8ICRoZWFkZXJhbmNob3JzLmVxKCAxICkuYWRkQ2xhc3MoICJ1aS1idG4tcmlnaHQiICkubGVuZ3RoOwoKCQl9LAoJCV9hZGRCYWNrQnV0dG9uOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5iYWNrQnRuID0gJCggIjxhIHJvbGU9J2J1dHRvbicgaHJlZj0namF2YXNjcmlwdDp2b2lkKDApOycgY2xhc3M9J3VpLWJ0bi1sZWZ0IHVpLXRvb2xiYXItYmFjay1idG4nIGRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbD0nYmFjaycgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbj0nY2FyYXQtbCc+IiArIHRoaXMub3B0aW9ucy5iYWNrQnRuVGV4dCArICI8L2E+IiApCgkJCQkJLy8gSWYgdGhlbWUgaXMgcHJvdmlkZWQsIG92ZXJyaWRlIGRlZmF1bHQgaW5oZXJpdGFuY2UKCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lIiwgdGhpcy5vcHRpb25zLmJhY2tCdG5UaGVtZSB8fCB0aGlzLm9wdGlvbnMudGhlbWUgKQoJCQkJCS5wcmVwZW5kVG8oIHRoaXMuZWxlbWVudCApOwoJCX0sCgkJX2FkZEhlYWRpbmdDbGFzc2VzOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiaDEsIGgyLCBoMywgaDQsIGg1LCBoNiIgKQoJCQkJLmFkZENsYXNzKCAidWktdGl0bGUiICkKCQkJCS8vIFJlZ2FyZGxlc3Mgb2YgaCBlbGVtZW50IG51bWJlciBpbiBzcmMsIGl0IGJlY29tZXMgaDEgZm9yIHRoZSBlbmhhbmNlZCBwYWdlCgkJCQkuYXR0cih7CgkJCQkJInJvbGUiOiAiaGVhZGluZyIsCgkJCQkJImFyaWEtbGV2ZWwiOiAiMSIKCQkJCX0pOwoJCX0KCX0pOwoJCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCgkkLndpZGdldCggIm1vYmlsZS50b29sYmFyIiwgJC5tb2JpbGUudG9vbGJhciwgewoJCW9wdGlvbnM6IHsKCQkJcG9zaXRpb246bnVsbCwKCQkJdmlzaWJsZU9uUGFnZVNob3c6IHRydWUsCgkJCWRpc2FibGVQYWdlWm9vbTogdHJ1ZSwKCQkJdHJhbnNpdGlvbjogInNsaWRlIiwgLy9jYW4gYmUgbm9uZSwgZmFkZSwgc2xpZGUgKHNsaWRlIG1hcHMgdG8gc2xpZGV1cCBvciBzbGlkZWRvd24pCgkJCWZ1bGxzY3JlZW46IGZhbHNlLAoJCQl0YXBUb2dnbGU6IHRydWUsCgkJCXRhcFRvZ2dsZUJsYWNrbGlzdDogImEsIGJ1dHRvbiwgaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEsIC51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQsIC51aS1wb3B1cCwgLnVpLXBhbmVsLCAudWktcGFuZWwtZGlzbWlzcy1vcGVuIiwKCQkJaGlkZUR1cmluZ0ZvY3VzOiAiaW5wdXQsIHRleHRhcmVhLCBzZWxlY3QiLAoJCQl1cGRhdGVQYWdlUGFkZGluZzogdHJ1ZSwKCQkJdHJhY2tQZXJzaXN0ZW50VG9vbGJhcnM6IHRydWUsCgoJCQkvLyBCcm93c2VyIGRldGVjdGlvbiEgV2VlZWUsIGhlcmUgd2UgZ28uLi4KCQkJLy8gVW5mb3J0dW5hdGVseSwgcG9zaXRpb246Zml4ZWQgaXMgY29zdGx5LCBub3QgdG8gbWVudGlvbiBwcm9iYWJseSBpbXBvc3NpYmxlLCB0byBmZWF0dXJlLWRldGVjdCBhY2N1cmF0ZWx5LgoJCQkvLyBTb21lIHRlc3RzIGV4aXN0LCBidXQgdGhleSBjdXJyZW50bHkgcmV0dXJuIGZhbHNlIHJlc3VsdHMgaW4gY3JpdGljYWwgZGV2aWNlcyBhbmQgYnJvd3NlcnMsIHdoaWNoIGNvdWxkIGxlYWQgdG8gYSBicm9rZW4gZXhwZXJpZW5jZS4KCQkJLy8gVGVzdGluZyBmaXhlZCBwb3NpdGlvbmluZyBpcyBhbHNvIHByZXR0eSBvYnRydXNpdmUgdG8gcGFnZSBsb2FkLCByZXF1aXJpbmcgaW5qZWN0ZWQgZWxlbWVudHMgYW5kIHNjcm9sbGluZyB0aGUgd2luZG93CgkJCS8vIFRoZSBmb2xsb3dpbmcgZnVuY3Rpb24gc2VydmVzIHRvIHJ1bGUgb3V0IHNvbWUgcG9wdWxhciBicm93c2VycyB3aXRoIGtub3duIGZpeGVkLXBvc2l0aW9uaW5nIGlzc3VlcwoJCQkvLyBUaGlzIGlzIGEgcGx1Z2luIG9wdGlvbiBsaWtlIGFueSBvdGhlciwgc28gZmVlbCBmcmVlIHRvIGltcHJvdmUgb3Igb3ZlcndyaXRlIGl0CgkJCXN1cHBvcnRCbGFja2xpc3Q6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICEkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbjsKCQkJfQoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQlpZiAoIHRoaXMub3B0aW9ucy5wb3NpdGlvbiA9PT0gImZpeGVkIiAmJiAhdGhpcy5vcHRpb25zLnN1cHBvcnRCbGFja2xpc3QoKSApewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktIisgdGhpcy5yb2xlICsiLWZpeGVkIiApOwoJCQkJdGhpcy51cGRhdGVQYWdlUGFkZGluZygpOwoJCQkJdGhpcy5fYWRkVHJhbnNpdGlvbkNsYXNzKCk7CgkJCQl0aGlzLl9iaW5kUGFnZUV2ZW50cygpOwoJCQkJdGhpcy5fYmluZFRvZ2dsZUhhbmRsZXJzKCk7CgkJCQl0aGlzLl9zZXRPcHRpb25zKCB0aGlzLm9wdGlvbnMgKTsKCQkJfQoJCX0sCgoJCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggbyApewoJCQlpZiAoIHRoaXMub3B0aW9ucy5wb3NpdGlvbiA9PT0gImZpeGVkIiAmJiAhdGhpcy5vcHRpb25zLnN1cHBvcnRCbGFja2xpc3QoKSApewoJCQkJdmFyICRwYWdlID0gKCAhIXRoaXMucGFnZSApPyB0aGlzLnBhZ2U6ICggJCgiLnVpLXBhZ2UtYWN0aXZlIikubGVuZ3RoID4gMCApPyAkKCIudWktcGFnZS1hY3RpdmUiKTogJCgiLnVpLXBhZ2UiKS5lcSgwKTsKCgkJCQlpZiAoIG8uZnVsbHNjcmVlbiAhPT0gdW5kZWZpbmVkKXsKCQkJCQlpZiAoIG8uZnVsbHNjcmVlbiApIHsKCQkJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktIisgdGhpcy5yb2xlICsiLWZ1bGxzY3JlZW4iICk7CgkJCQkJCSRwYWdlLmFkZENsYXNzKCAidWktcGFnZS0iICsgdGhpcy5yb2xlICsgIi1mdWxsc2NyZWVuIiApOwoJCQkJCX0KCQkJCQkvLyBJZiBub3QgZnVsbHNjcmVlbiwgYWRkIGNsYXNzIHRvIHBhZ2UgdG8gc2V0IHRvcCBvciBib3R0b20gcGFkZGluZwoJCQkJCWVsc2UgewoJCQkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS0iKyB0aGlzLnJvbGUgKyItZnVsbHNjcmVlbiIgKTsKCQkJCQkJJHBhZ2UucmVtb3ZlQ2xhc3MoICJ1aS1wYWdlLSIgKyB0aGlzLnJvbGUgKyAiLWZ1bGxzY3JlZW4iICkuYWRkQ2xhc3MoICJ1aS1wYWdlLSIgKyB0aGlzLnJvbGUrICItZml4ZWQiICk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJCXRoaXMuX3N1cGVyKG8pOwoJCX0sCgoJCV9hZGRUcmFuc2l0aW9uQ2xhc3M6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdGNsYXNzID0gdGhpcy5vcHRpb25zLnRyYW5zaXRpb247CgoJCQlpZiAoIHRjbGFzcyAmJiB0Y2xhc3MgIT09ICJub25lIiApIHsKCQkJCS8vIHVzZSBhcHByb3ByaWF0ZSBzbGlkZSBmb3IgaGVhZGVyIG9yIGZvb3RlcgoJCQkJaWYgKCB0Y2xhc3MgPT09ICJzbGlkZSIgKSB7CgkJCQkJdGNsYXNzID0gdGhpcy5lbGVtZW50Lmhhc0NsYXNzKCAidWktaGVhZGVyIiApID8gInNsaWRlZG93biIgOiAic2xpZGV1cCI7CgkJCQl9CgoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0Y2xhc3MgKTsKCQkJfQoJCX0sCgoJCV9iaW5kUGFnZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJCXZhciBwYWdlID0gKCAhIXRoaXMucGFnZSApPyB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApOiAkLm1vYmlsZS5kb2N1bWVudDsKCQkJLy9wYWdlIGV2ZW50IGJpbmRpbmdzCgkJCS8vIEZpeGVkIHRvb2xiYXJzIHJlcXVpcmUgcGFnZSB6b29tIHRvIGJlIGRpc2FibGVkLCBvdGhlcndpc2UgdXNhYmlsaXR5IGlzc3VlcyBjcm9wIHVwCgkJCS8vIFRoaXMgbWV0aG9kIGlzIG1lYW50IHRvIGRpc2FibGUgem9vbSB3aGlsZSBhIGZpeGVkLXBvc2l0aW9uZWQgdG9vbGJhciBwYWdlIGlzIHZpc2libGUKCQkJdGhpcy5fb24oIHBhZ2UgLCB7CgkJCQkicGFnZWJlZm9yZXNob3ciOiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IiwKCQkJCSJ3ZWJraXRBbmltYXRpb25TdGFydCI6Il9oYW5kbGVBbmltYXRpb25TdGFydCIsCgkJCQkiYW5pbWF0aW9uc3RhcnQiOiJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInVwZGF0ZWxheW91dCI6ICJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInBhZ2VzaG93IjogIl9oYW5kbGVQYWdlU2hvdyIsCgkJCQkicGFnZWJlZm9yZWhpZGUiOiAiX2hhbmRsZVBhZ2VCZWZvcmVIaWRlIgoJCQl9KTsKCQl9LAoKCQlfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCApIHsKCQkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7CgkJCWlmICggby5kaXNhYmxlUGFnZVpvb20gKSB7CgkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCQlpZiAoICFvLnZpc2libGVPblBhZ2VTaG93ICkgewoJCQkJdGhpcy5oaWRlKCB0cnVlICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlQW5pbWF0aW9uU3RhcnQ6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHRoaXMub3B0aW9ucy51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCXRoaXMudXBkYXRlUGFnZVBhZGRpbmcoICggISF0aGlzLnBhZ2UgKT8gdGhpcy5wYWdlOiAiLnVpLXBhZ2UtYWN0aXZlIiApOwoJCQl9CgkJfSwKCgkJX2hhbmRsZVBhZ2VTaG93OiBmdW5jdGlvbigpIHsKCQkJdGhpcy51cGRhdGVQYWdlUGFkZGluZyggKCAhIXRoaXMucGFnZSApPyB0aGlzLnBhZ2U6ICIudWktcGFnZS1hY3RpdmUiICk7CgkJCWlmICggdGhpcy5vcHRpb25zLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJdGhpcy5fb24oICQubW9iaWxlLndpbmRvdywgeyAidGhyb3R0bGVkcmVzaXplIjogInVwZGF0ZVBhZ2VQYWRkaW5nIiB9ICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlUGFnZUJlZm9yZUhpZGU6IGZ1bmN0aW9uKCBlLCB1aSApIHsKCQkJdmFyIG8gPSB0aGlzLm9wdGlvbnMsCgkJCQl0aGlzRm9vdGVyLCB0aGlzSGVhZGVyLCBuZXh0Rm9vdGVyLCBuZXh0SGVhZGVyOwoKCgkJCWlmICggby5kaXNhYmxlUGFnZVpvb20gKSB7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQl9CgkJCWlmICggby51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCXRoaXMuX29mZiggJC5tb2JpbGUud2luZG93LCAidGhyb3R0bGVkcmVzaXplIiApOwoJCQl9CgoJCQlpZiAoIG8udHJhY2tQZXJzaXN0ZW50VG9vbGJhcnMgKSB7CgkJCQl0aGlzRm9vdGVyID0gJCggIi51aS1mb290ZXItZml4ZWQ6anFtRGF0YShpZCkiLCB0aGlzLnBhZ2UgKTsKCQkJCXRoaXNIZWFkZXIgPSAkKCAiLnVpLWhlYWRlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMucGFnZSApOwoJCQkJbmV4dEZvb3RlciA9IHRoaXNGb290ZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktZm9vdGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzRm9vdGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpOwoJCQkJbmV4dEhlYWRlciA9IHRoaXNIZWFkZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzSGVhZGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpOwoKCQkJCWlmICggbmV4dEZvb3Rlci5sZW5ndGggfHwgbmV4dEhlYWRlci5sZW5ndGggKSB7CgoJCQkJCW5leHRGb290ZXIuYWRkKCBuZXh0SGVhZGVyICkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCQkJdWkubmV4dFBhZ2Uub25lKCAicGFnZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCQkJbmV4dEhlYWRlci5wcmVwZW5kVG8oIHRoaXMgKTsKCQkJCQkJbmV4dEZvb3Rlci5hcHBlbmRUbyggdGhpcyApOwoJCQkJCX0pOwoJCQkJfQoJCQl9CgkJfSwKCgkJX3Zpc2libGU6IHRydWUsCgoJCS8vIFRoaXMgd2lsbCBzZXQgdGhlIGNvbnRlbnQgZWxlbWVudCdzIHRvcCBvciBib3R0b20gcGFkZGluZyBlcXVhbCB0byB0aGUgdG9vbGJhcidzIGhlaWdodAoJCXVwZGF0ZVBhZ2VQYWRkaW5nOiBmdW5jdGlvbiggdGJQYWdlICkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gKCB0aGlzLnJvbGUgPT09ImhlYWRlciIgKSwKCQkJCXBvcyA9IHBhcnNlRmxvYXQoICRlbC5jc3MoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSApOwoKCQkJLy8gVGhpcyBiZWhhdmlvciBvbmx5IGFwcGxpZXMgdG8gImZpeGVkIiwgbm90ICJmdWxsc2NyZWVuIgoJCQlpZiAoIHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICkgeyByZXR1cm47IH0KCQkJLy8gdGJQYWdlIGFyZ3VtZW50IGNhbiBiZSBhIFBhZ2Ugb2JqZWN0IG9yIGFuIGV2ZW50LCBpZiBjb21pbmcgZnJvbSB0aHJvdHRsZWQgcmVzaXplLgoJCQl0YlBhZ2UgPSAoIHRiUGFnZSAmJiB0YlBhZ2UudHlwZSA9PT0gdW5kZWZpbmVkICYmIHRiUGFnZSApIHx8IHRoaXMucGFnZSB8fCAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCQl0YlBhZ2UgPSAoICEhdGhpcy5wYWdlICk/IHRoaXMucGFnZTogIi51aS1wYWdlLWFjdGl2ZSI7CgkJCSQoIHRiUGFnZSApLmNzcyggInBhZGRpbmctIiArICggaGVhZGVyID8gInRvcCIgOiAiYm90dG9tIiApLCAkZWwub3V0ZXJIZWlnaHQoKSArIHBvcyApOwoJCX0sCgoJCV91c2VUcmFuc2l0aW9uOiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgJHdpbiA9ICQubW9iaWxlLndpbmRvdywKCQkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCXNjcm9sbCA9ICR3aW4uc2Nyb2xsVG9wKCksCgkJCQllbEhlaWdodCA9ICRlbC5oZWlnaHQoKSwKCQkJCXBIZWlnaHQgPSAoICEhdGhpcy5wYWdlICk/ICRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuaGVpZ2h0KCk6JCgiLnVpLXBhZ2UtYWN0aXZlIikuaGVpZ2h0KCksCgkJCQl2aWV3cG9ydEhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQkJcmV0dXJuICFub3RyYW5zaXRpb24gJiYKCQkJCSggdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gJiYgdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gIT09ICJub25lIiAmJgoJCQkJKAoJCQkJCSggdGhpcy5yb2xlID09PSAiaGVhZGVyIiAmJiAhdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gJiYgc2Nyb2xsID4gZWxIZWlnaHQgKSB8fAoJCQkJCSggdGhpcy5yb2xlID09PSAiZm9vdGVyIiAmJiAhdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gJiYgc2Nyb2xsICsgdmlld3BvcnRIZWlnaHQgPCBwSGVpZ2h0IC0gZWxIZWlnaHQgKQoJCQkJKSB8fCB0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbgoJCQkJKTsKCQl9LAoKCQlzaG93OiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgaGlkZUNsYXNzID0gInVpLWZpeGVkLWhpZGRlbiIsCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQ7CgoJCQlpZiAoIHRoaXMuX3VzZVRyYW5zaXRpb24oIG5vdHJhbnNpdGlvbiApICkgewoJCQkJJGVsCgkJCQkJLnJlbW92ZUNsYXNzKCAib3V0ICIgKyBoaWRlQ2xhc3MgKQoJCQkJCS5hZGRDbGFzcyggImluIiApCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKGZ1bmN0aW9uICgpIHsKCQkJCQkJJGVsLnJlbW92ZUNsYXNzKCAiaW4iICk7CgkJCQkJfSk7CgkJCX0KCQkJZWxzZSB7CgkJCQkkZWwucmVtb3ZlQ2xhc3MoIGhpZGVDbGFzcyApOwoJCQl9CgkJCXRoaXMuX3Zpc2libGUgPSB0cnVlOwoJCX0sCgoJCWhpZGU6IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKSB7CgkJCXZhciBoaWRlQ2xhc3MgPSAidWktZml4ZWQtaGlkZGVuIiwKCQkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCS8vIGlmIGl0J3MgYSBzbGlkZSB0cmFuc2l0aW9uLCBvdXIgbmV3IHRyYW5zaXRpb25zIG5lZWQgdGhlIHJldmVyc2UgY2xhc3MgYXMgd2VsbCB0byBzbGlkZSBvdXR3YXJkCgkJCQlvdXRjbGFzcyA9ICJvdXQiICsgKCB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiA9PT0gInNsaWRlIiA/ICIgcmV2ZXJzZSIgOiAiIiApOwoKCQkJaWYgKCB0aGlzLl91c2VUcmFuc2l0aW9uKCBub3RyYW5zaXRpb24gKSApIHsKCQkJCSRlbAoJCQkJCS5hZGRDbGFzcyggb3V0Y2xhc3MgKQoJCQkJCS5yZW1vdmVDbGFzcyggImluIiApCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKGZ1bmN0aW9uKCkgewoJCQkJCQkkZWwuYWRkQ2xhc3MoIGhpZGVDbGFzcyApLnJlbW92ZUNsYXNzKCBvdXRjbGFzcyApOwoJCQkJCX0pOwoJCQl9CgkJCWVsc2UgewoJCQkJJGVsLmFkZENsYXNzKCBoaWRlQ2xhc3MgKS5yZW1vdmVDbGFzcyggb3V0Y2xhc3MgKTsKCQkJfQoJCQl0aGlzLl92aXNpYmxlID0gZmFsc2U7CgkJfSwKCgkJdG9nZ2xlOiBmdW5jdGlvbigpIHsKCQkJdGhpc1sgdGhpcy5fdmlzaWJsZSA/ICJoaWRlIiA6ICJzaG93IiBdKCk7CgkJfSwKCgkJX2JpbmRUb2dnbGVIYW5kbGVyczogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgkJCQlkZWxheVNob3csIGRlbGF5SGlkZSwKCQkJCWlzVmlzaWJsZSA9IHRydWUsCgkJCQlwYWdlID0gKCAhIXRoaXMucGFnZSApPyB0aGlzLnBhZ2U6ICQoIi51aS1wYWdlIik7CgoJCQkvLyB0YXAgdG9nZ2xlCgkJCXBhZ2UKCQkJCS5iaW5kKCAidmNsaWNrIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJaWYgKCBvLnRhcFRvZ2dsZSAmJiAhJCggZS50YXJnZXQgKS5jbG9zZXN0KCBvLnRhcFRvZ2dsZUJsYWNrbGlzdCApLmxlbmd0aCApIHsKCQkJCQkJc2VsZi50b2dnbGUoKTsKCQkJCQl9CgkJCQl9KQoJCQkJLmJpbmQoICJmb2N1c2luIGZvY3Vzb3V0IiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJLy90aGlzIGhpZGVzIHRoZSB0b29sYmFycyBvbiBhIGtleWJvYXJkIHBvcCB0byBnaXZlIG1vcmUgc2NyZWVuIHJvb20gYW5kIHByZXZlbnQgaW9zIGJ1ZyB3aGljaAoJCQkJCS8vcG9zaXRpb25zIGZpeGVkIHRvb2xiYXJzIGluIHRoZSBtaWRkbGUgb2YgdGhlIHNjcmVlbiBvbiBwb3AgaWYgdGhlIGlucHV0IGlzIG5lYXIgdGhlIHRvcCBvcgoJCQkJCS8vYm90dG9tIG9mIHRoZSBzY3JlZW4gYWRkcmVzc2VzIGlzc3VlcyAjNDQxMCBGb290ZXIgbmF2YmFyIG1vdmVzIHVwIHdoZW4gY2xpY2tpbmcgb24gYSB0ZXh0Ym94IGluIGFuIEFuZHJvaWQgZW52aXJvbm1lbnQKCQkJCQkvL2FuZCBpc3N1ZSAjNDExMyBIZWFkZXIgYW5kIGZvb3RlciBjaGFuZ2UgdGhlaXIgcG9zaXRpb24gYWZ0ZXIga2V5Ym9hcmQgcG9wdXAgLSBpT1MKCQkJCQkvL2FuZCBpc3N1ZSAjNDQxMCBGb290ZXIgbmF2YmFyIG1vdmVzIHVwIHdoZW4gY2xpY2tpbmcgb24gYSB0ZXh0Ym94IGluIGFuIEFuZHJvaWQgZW52aXJvbm1lbnQKCQkJCQlpZiAoIHNjcmVlbi53aWR0aCA8IDEwMjUgJiYgJCggZS50YXJnZXQgKS5pcyggby5oaWRlRHVyaW5nRm9jdXMgKSAmJiAhJCggZS50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLWhlYWRlci1maXhlZCwgLnVpLWZvb3Rlci1maXhlZCIgKS5sZW5ndGggKSB7CgkJCQkJCS8vRml4IGZvciBpc3N1ZSAjNDcyNCBNb3ZpbmcgdGhyb3VnaCBmb3JtIGluIE1vYmlsZSBTYWZhcmkgd2l0aCAiTmV4dCIgYW5kICJQcmV2aW91cyIgc3lzdGVtCgkJCQkJCS8vY29udHJvbHMgY2F1c2VzIGZpeGVkIHBvc2l0aW9uLCB0YXAtdG9nZ2xlIGZhbHNlIEhlYWRlciB0byByZXZlYWwgaXRzZWxmCgkJCQkJCS8vIGlzVmlzaWJsZSBpbnN0ZWFkIG9mIHNlbGYuX3Zpc2libGUgYmVjYXVzZSB0aGUgZm9jdXNpbiBhbmQgZm9jdXNvdXQgZXZlbnRzIGZpcmUgdHdpY2UgYXQgdGhlIHNhbWUgdGltZQoJCQkJCQkvLyBBbHNvIHVzZSBhIGRlbGF5IGZvciBoaWRpbmcgdGhlIHRvb2xiYXJzIGJlY2F1c2Ugb24gQW5kcm9pZCBuYXRpdmUgYnJvd3NlciBmb2N1c2luIGlzIGRpcmVjbHR5IGZvbGxvd2VkCgkJCQkJCS8vIGJ5IGEgZm9jdXNvdXQgd2hlbiBhIG5hdGl2ZSBzZWxlY3RzIG9wZW5zIGFuZCB0aGUgb3RoZXIgd2F5IGFyb3VuZCB3aGVuIGl0IGNsb3Nlcy4KCQkJCQkJaWYgKCBlLnR5cGUgPT09ICJmb2N1c291dCIgJiYgIWlzVmlzaWJsZSApIHsKCQkJCQkJCWlzVmlzaWJsZSA9IHRydWU7CgkJCQkJCQkvL3dhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgYW5kIHNlZSBpZiB3ZSBoYXZlIGp1bXBlZCB0byBhbm90aGVyIGlucHV0CgkJCQkJCQljbGVhclRpbWVvdXQoIGRlbGF5SGlkZSApOwoJCQkJCQkJZGVsYXlTaG93ID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJCQkJc2VsZi5zaG93KCk7CgkJCQkJCQl9LCAwICk7CgkJCQkJCX0gZWxzZSBpZiAoIGUudHlwZSA9PT0gImZvY3VzaW4iICYmICEhaXNWaXNpYmxlICkgewoJCQkJCQkJLy9pZiB3ZSBoYXZlIGp1bXBlZCB0byBhbm90aGVyIGlucHV0IGNsZWFyIHRoZSB0aW1lIG91dCB0byBjYW5jZWwgdGhlIHNob3cuCgkJCQkJCQljbGVhclRpbWVvdXQoIGRlbGF5U2hvdyApOwoJCQkJCQkJaXNWaXNpYmxlID0gZmFsc2U7CgkJCQkJCQlkZWxheUhpZGUgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCQlzZWxmLmhpZGUoKTsKCQkJCQkJCX0sIDAgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0pOwoJCX0sCgoJCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCWhlYWRlciA9ICRlbC5oYXNDbGFzcyggInVpLWhlYWRlciIgKTsKCgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuY3NzKCAicGFkZGluZy0iICsgKCBoZWFkZXIgPyAidG9wIiA6ICJib3R0b20iICksICIiICk7CgkJCSRlbC5yZW1vdmVDbGFzcyggInVpLWhlYWRlci1maXhlZCB1aS1mb290ZXItZml4ZWQgdWktaGVhZGVyLWZ1bGxzY3JlZW4gdWktZm9vdGVyLWZ1bGxzY3JlZW4gaW4gb3V0IGZhZGUgc2xpZGVkb3duIHNsaWRldXAgdWktZml4ZWQtaGlkZGVuIiApOwoJCQkkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApLnJlbW92ZUNsYXNzKCAidWktcGFnZS1oZWFkZXItZml4ZWQgdWktcGFnZS1mb290ZXItZml4ZWQgdWktcGFnZS1oZWFkZXItZnVsbHNjcmVlbiB1aS1wYWdlLWZvb3Rlci1mdWxsc2NyZWVuIiApOwoJCX0KCgl9KTsKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkkLndpZGdldCggIm1vYmlsZS50b29sYmFyIiwgJC5tb2JpbGUudG9vbGJhciwgewoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCQkJdGhpcy5fd29ya2Fyb3VuZHMoKTsKCQl9LAoKCQkvL2NoZWNrIHRoZSBicm93c2VyIGFuZCB2ZXJzaW9uIGFuZCBydW4gbmVlZGVkIHdvcmthcm91bmRzCgkJX3dvcmthcm91bmRzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQkJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0sCgkJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJCXdrbWF0Y2ggPSB1YS5tYXRjaCggL0FwcGxlV2ViS2l0XC8oWzAtOV0rKS8gKSwKCQkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQkJb3MgPSBudWxsLAoJCQlzZWxmID0gdGhpczsKCQkJLy9zZXQgdGhlIG9zIHdlIGFyZSB3b3JraW5nIGluIGlmIGl0IGRvc2VudCBtYXRjaCBvbmUgd2l0aCB3b3JrYXJvdW5kcyByZXR1cm4KCQkJaWYgKCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBob25lIiApID4gLTEgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQYWQiICkgPiAtMSAgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQb2QiICkgPiAtMSApIHsKCQkJCW9zID0gImlvcyI7CgkJCX0gZWxzZSBpZiAoIHVhLmluZGV4T2YoICJBbmRyb2lkIiApID4gLTEgKSB7CgkJCQlvcyA9ICJhbmRyb2lkIjsKCQkJfSBlbHNlIHsKCQkJCXJldHVybjsKCQkJfQoJCQkvL2NoZWNrIG9zIHZlcnNpb24gaWYgaXQgZG9zZW50IG1hdGNoIG9uZSB3aXRoIHdvcmthcm91bmRzIHJldHVybgoJCQlpZiAoIG9zID09PSAiaW9zIiApIHsKCQkJCS8vaU9TICB3b3JrYXJvdW5kcwoJCQkJc2VsZi5fYmluZFNjcm9sbFdvcmthcm91bmQoKTsKCQkJfSBlbHNlIGlmICggb3MgPT09ICJhbmRyb2lkIiAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTM0ICkgewoJCQkJLy9BbmRyb2lkIDIuMyBydW4gYWxsIEFuZHJvaWQgMi4zIHdvcmthcm91bmQKCQkJCXNlbGYuX2JpbmRTY3JvbGxXb3JrYXJvdW5kKCk7CgkJCQlzZWxmLl9iaW5kTGlzdFRodW1iV29ya2Fyb3VuZCgpOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuOwoJCQl9CgkJfSwKCgkJLy9VdGlsaXR5IGNsYXNzIGZvciBjaGVja2luZyBoZWFkZXIgYW5kIGZvb3RlciBwb3NpdGlvbnMgcmVsYXRpdmUgdG8gdmlld3BvcnQKCQlfdmlld3BvcnRPZmZzZXQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gJGVsLmhhc0NsYXNzKCAidWktaGVhZGVyIiApLAoJCQkJb2Zmc2V0ID0gTWF0aC5hYnMoICRlbC5vZmZzZXQoKS50b3AgLSAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCkgKTsKCQkJaWYgKCAhaGVhZGVyICkgewoJCQkJb2Zmc2V0ID0gTWF0aC5yb3VuZCggb2Zmc2V0IC0gJC5tb2JpbGUud2luZG93LmhlaWdodCgpICsgJGVsLm91dGVySGVpZ2h0KCkgKSAtIDYwOwoJCQl9CgkJCXJldHVybiBvZmZzZXQ7CgkJfSwKCgkJLy9iaW5kIGV2ZW50cyBmb3IgX3RyaWdnZXJSZWRyYXcoKSBmdW5jdGlvbgoJCV9iaW5kU2Nyb2xsV29ya2Fyb3VuZDogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJLy9iaW5kIHRvIHNjcm9sbHN0b3AgYW5kIGNoZWNrIGlmIHRoZSB0b29sYmFycyBhcmUgY29ycmVjdGx5IHBvc2l0aW9uZWQKCQkJdGhpcy5fb24oICQubW9iaWxlLndpbmRvdywgeyBzY3JvbGxzdG9wOiBmdW5jdGlvbigpIHsKCQkJCXZhciB2aWV3cG9ydE9mZnNldCA9IHNlbGYuX3ZpZXdwb3J0T2Zmc2V0KCk7CgkJCQkvL2NoZWNrIGlmIHRoZSBoZWFkZXIgaXMgdmlzaWJsZSBhbmQgaWYgaXRzIGluIHRoZSByaWdodCBwbGFjZQoJCQkJaWYgKCB2aWV3cG9ydE9mZnNldCA+IDIgJiYgc2VsZi5fdmlzaWJsZSApIHsKCQkJCQlzZWxmLl90cmlnZ2VyUmVkcmF3KCk7CgkJCQl9CgkJCX19KTsKCQl9LAoKCQkvL3RoaXMgYWRkcmVzc2VzIGlzc3VlICM0MjUwIFBlcnNpc3RlbnQgZm9vdGVyIGluc3RhYmlsaXR5IGluIHYxLjEgd2l0aCBsb25nIHNlbGVjdCBsaXN0cyBpbiBBbmRyb2lkIDIuMy4zCgkJLy9hbmQgaXNzdWUgIzM3NDggQW5kcm9pZCAyLng6IFBhZ2UgdHJhbnNpdGlvbnMgYnJva2VuIHdoZW4gZml4ZWQgdG9vbGJhcnMgdXNlZAoJCS8vdGhlIGFic29sdXRlbHkgcG9zaXRpb25lZCB0aHVtYm5haWwgaW4gYSBsaXN0IHZpZXcgY2F1c2VzIHByb2JsZW1zIHdpdGggZml4ZWQgcG9zaXRpb24gYnV0dG9ucyBhYm92ZSBpbiBhIG5hdiBiYXIKCQkvL3NldHRpbmcgdGhlIGxpJ3MgdG8gLXdlYmtpdC10cmFuc2Zvcm06dHJhbnNsYXRlM2QoMCwwLDApOyBzb2x2ZXMgdGhpcyBwcm9ibGVtIHRvIGF2b2lkZSBwb3RlbnRpYWwgaXNzdWVzIGluIG90aGVyCgkJLy9wbGF0Zm9ybXMgd2Ugc2NvcGUgdGhpcyB3aXRoIHRoZSBjbGFzcyB1aS1hbmRyb2lkLTJ4LWZpeAoJCV9iaW5kTGlzdFRodW1iV29ya2Fyb3VuZDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuYWRkQ2xhc3MoICJ1aS1hbmRyb2lkLTJ4LWZpeGVkIiApOwoJCX0sCgkJLy90aGlzIGFkZHJlc3NlcyBpc3N1ZXMgIzQzMzcgRml4ZWQgaGVhZGVyIHByb2JsZW0gYWZ0ZXIgc2Nyb2xsaW5nIGNvbnRlbnQgb24gaU9TIGFuZCBBbmRyb2lkCgkJLy9hbmQgZGV2aWNlIGJ1Z3MgcHJvamVjdCBpc3N1ZSAjMSBGb3JtIGVsZW1lbnRzIGNhbiBsb3NlIGNsaWNrIGhpdCBhcmVhIGluIHBvc2l0aW9uOiBmaXhlZCBjb250YWluZXJzLgoJCS8vdGhpcyBhbHNvIGFkZHJlc3NlcyBub3Qgb24gZml4ZWQgdG9vbGJhcnMgcGFnZSBpbiBkb2NzCgkJLy9hZGRpbmcgMXB4IG9mIHBhZGRpbmcgdG8gdGhlIGJvdHRvbSB0aGVuIHJlbW92aW5nIGl0IGNhdXNlcyBhICJyZWRyYXciCgkJLy93aGljaCBwb3NpdGlvbnMgdGhlIHRvb2xiYXJzIGNvcnJlY3RseSAodGhleSB3aWxsIGFsd2F5cyBiZSB2aXN1YWxseSBjb3JyZWN0KQoJCV90cmlnZ2VyUmVkcmF3OiBmdW5jdGlvbigpIHsKCQkJdmFyIHBhZGRpbmdCb3R0b20gPSBwYXJzZUZsb2F0KCAkKCAiLnVpLXBhZ2UtYWN0aXZlIiApLmNzcyggInBhZGRpbmctYm90dG9tIiApICk7CgkJCS8vdHJpZ2dlciBwYWdlIHJlZHJhdyB0byBmaXggaW5jb3JyZWN0bHkgcG9zaXRpb25lZCBmaXhlZCBlbGVtZW50cwoJCQkkKCAiLnVpLXBhZ2UtYWN0aXZlIiApLmNzcyggInBhZGRpbmctYm90dG9tIiwgKCBwYWRkaW5nQm90dG9tICsgMSApICsgInB4IiApOwoJCQkvL2lmIHRoZSBwYWRkaW5nIGlzIHJlc2V0IHdpdGggb3V0IGEgdGltZW91dCB0aGUgcmVwb3NpdGlvbiB3aWxsIG5vdCBvY2N1cmUuCgkJCS8vdGhpcyBpcyBpbmRlcGVuZGFudCBvZiBKUU0gdGhlIGJyb3dzZXIgc2VlbXMgdG8gbmVlZCB0aGUgdGltZSB0byByZWFjdC4KCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkkKCAiLnVpLXBhZ2UtYWN0aXZlIiApLmNzcyggInBhZGRpbmctYm90dG9tIiwgcGFkZGluZ0JvdHRvbSArICJweCIgKTsKCQkJfSwgMCApOwoJCX0sCgoJCWRlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQkvL1JlbW92ZSB0aGUgY2xhc3Mgd2UgYWRkZWQgdG8gdGhlIHBhZ2UgcHJldmlvdXNseSBpbiBhbmRyb2lkIDIueAoJCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlLWFjdGl2ZSIgKS5yZW1vdmVDbGFzcyggInVpLWFuZHJvaWQtMngtZml4IiApOwoJCX0KCX0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5wYW5lbCIsIHsKCW9wdGlvbnM6IHsKCQljbGFzc2VzOiB7CgkJCXBhbmVsOiAidWktcGFuZWwiLAoJCQlwYW5lbE9wZW46ICJ1aS1wYW5lbC1vcGVuIiwKCQkJcGFuZWxDbG9zZWQ6ICJ1aS1wYW5lbC1jbG9zZWQiLAoJCQlwYW5lbEZpeGVkOiAidWktcGFuZWwtZml4ZWQiLAoJCQlwYW5lbElubmVyOiAidWktcGFuZWwtaW5uZXIiLAoJCQltb2RhbDogInVpLXBhbmVsLWRpc21pc3MiLAoJCQltb2RhbE9wZW46ICJ1aS1wYW5lbC1kaXNtaXNzLW9wZW4iLAoJCQlwYWdlQ29udGFpbmVyOiAidWktcGFuZWwtcGFnZS1jb250YWluZXIiLAoJCQlwYWdlV3JhcHBlcjogInVpLXBhbmVsLXdyYXBwZXIiLAoJCQlwYWdlRml4ZWRUb29sYmFyOiAidWktcGFuZWwtZml4ZWQtdG9vbGJhciIsCgkJCXBhZ2VDb250ZW50UHJlZml4OiAidWktcGFuZWwtcGFnZS1jb250ZW50IiwgLyogVXNlZCBmb3Igd3JhcHBlciBhbmQgZml4ZWQgdG9vbGJhcnMgcG9zaXRpb24sIGRpc3BsYXkgYW5kIG9wZW4gY2xhc3Nlcy4gKi8KCQkJYW5pbWF0ZTogInVpLXBhbmVsLWFuaW1hdGUiCgkJfSwKCQlhbmltYXRlOiB0cnVlLAoJCXRoZW1lOiAiYSIsCgkJcG9zaXRpb246ICJsZWZ0IiwKCQlkaXNtaXNzaWJsZTogdHJ1ZSwKCQlkaXNwbGF5OiAicmV2ZWFsIiwgLy9hY2NlcHRzIHJldmVhbCwgcHVzaCwgb3ZlcmxheQoJCXN3aXBlQ2xvc2U6IHRydWUsCgkJcG9zaXRpb25GaXhlZDogZmFsc2UKCX0sCgoJX3BhbmVsSUQ6IG51bGwsCglfY2xvc2VMaW5rOiBudWxsLAoJX3BhcmVudFBhZ2U6IG51bGwsCglfcGFnZTogbnVsbCwKCV9tb2RhbDogbnVsbCwKCV9wYW5lbElubmVyOiBudWxsLAoJX3dyYXBwZXI6IG51bGwsCglfZml4ZWRUb29sYmFyczogbnVsbCwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWwgPSB0aGlzLmVsZW1lbnQsCgkJCXBhcmVudFBhZ2UgPSBlbC5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApOwoKCQkvLyBleHBvc2Ugc29tZSBwcml2YXRlIHByb3BzIHRvIG90aGVyIG1ldGhvZHMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfcGFuZWxJRDogZWwuYXR0ciggImlkIiApLAoJCQlfY2xvc2VMaW5rOiBlbC5maW5kKCAiOmpxbURhdGEocmVsPSdjbG9zZScpIiApLAoJCQlfcGFyZW50UGFnZTogKCBwYXJlbnRQYWdlLmxlbmd0aCA+IDAgKSA/IHBhcmVudFBhZ2UgOiBmYWxzZSwKCQkJX3BhZ2U6IHRoaXMuX2dldFBhZ2UsCgkJCV9wYW5lbElubmVyOiB0aGlzLl9nZXRQYW5lbElubmVyKCksCgkJCV93cmFwcGVyOiB0aGlzLl9nZXRXcmFwcGVyLAoJCQlfZml4ZWRUb29sYmFyczogdGhpcy5fZ2V0Rml4ZWRUb29sYmFycwoJCX0pOwoJCQoJCXRoaXMuX2FkZFBhbmVsQ2xhc3NlcygpOwoKCQkvLyBpZiBhbmltYXRpbmcsIGFkZCB0aGUgY2xhc3MgdG8gZG8gc28KCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIXRoaXMub3B0aW9ucy5hbmltYXRlICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLmFuaW1hdGUgKTsKCQl9CgoJCXRoaXMuX2JpbmRVcGRhdGVMYXlvdXQoKTsKCQl0aGlzLl9iaW5kQ2xvc2VFdmVudHMoKTsKCQl0aGlzLl9iaW5kTGlua0xpc3RlbmVycygpOwoJCXRoaXMuX2JpbmRQYWdlRXZlbnRzKCk7CgoJCWlmICggISF0aGlzLm9wdGlvbnMuZGlzbWlzc2libGUgKSB7CgkJCXRoaXMuX2NyZWF0ZU1vZGFsKCk7CgkJfQoKCQl0aGlzLl9iaW5kU3dpcGVFdmVudHMoKTsKCX0sCgkKCV9nZXRQYW5lbElubmVyOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFuZWxJbm5lciA9IHRoaXMuZWxlbWVudC5maW5kKCAiLiIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbElubmVyICk7CgkJCgkJaWYgKCBwYW5lbElubmVyLmxlbmd0aCA9PT0gMCApIHsKCQkJcGFuZWxJbm5lciA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbigpLndyYXBBbGwoICI8ZGl2IGNsYXNzPSciICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxJbm5lciArICInIC8+IiApLnBhcmVudCgpOwoJCX0KCQkKCQlyZXR1cm4gcGFuZWxJbm5lcjsKCX0sCgkKCV9jcmVhdGVNb2RhbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQl0YXJnZXQgPSBzZWxmLl9wYXJlbnRQYWdlID8gc2VsZi5fcGFyZW50UGFnZS5wYXJlbnQoKSA6IHNlbGYuZWxlbWVudC5wYXJlbnQoKTsKCgkJc2VsZi5fbW9kYWwgPSAkKCAiPGRpdiBjbGFzcz0nIiArIHNlbGYub3B0aW9ucy5jbGFzc2VzLm1vZGFsICsgIicgZGF0YS1wYW5lbGlkPSciICsgc2VsZi5fcGFuZWxJRCArICInPjwvZGl2PiIgKQoJCQkub24oICJtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuY2xvc2UoKTsKCQkJfSkKCQkJLmFwcGVuZFRvKCB0YXJnZXQgKTsKCX0sCgkKCV9nZXRQYWdlOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFnZSA9IHRoaXMuX3BhcmVudFBhZ2UgPyB0aGlzLl9wYXJlbnRQYWdlIDogJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICk7CgkJCgkJcmV0dXJuIHBhZ2U7Cgl9LAoJCglfZ2V0V3JhcHBlcjogZnVuY3Rpb24oKSB7CgkJdmFyIHdyYXBwZXIgPSB0aGlzLl9wYWdlKCkuZmluZCggIi4iICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFnZVdyYXBwZXIgKSwKCQkJYW5pbWF0ZUNsYXNzID0gKCAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISF0aGlzLm9wdGlvbnMuYW5pbWF0ZSApID8gIiAiICsgdGhpcy5vcHRpb25zLmNsYXNzZXMuYW5pbWF0ZSA6ICIiOwoKCQlpZiAoIHdyYXBwZXIubGVuZ3RoID09PSAwICkgewoJCQl3cmFwcGVyID0gdGhpcy5fcGFnZSgpLmNoaWxkcmVuKCAiLnVpLWhlYWRlcjpub3QoOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykpLCAudWktY29udGVudDpub3QoOmpxbURhdGEocm9sZT0ncG9wdXAnKSksIC51aS1mb290ZXI6bm90KDpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpKSIgKQoJCQkJLndyYXBBbGwoICI8ZGl2IGNsYXNzPSciICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFnZVdyYXBwZXIgKyBhbmltYXRlQ2xhc3MgKyAiJyAvPjwvZGl2PiIgKQoJCQkJLnBhcmVudCgpOwoJCX0KCgkJcmV0dXJuIHdyYXBwZXI7Cgl9LAoJCglfZ2V0Rml4ZWRUb29sYmFyczogZnVuY3Rpb24oKSB7CgkJdmFyIGV4dEZpeGVkVG9vbGJhcnMgPSAkKCAiYm9keSIgKS5jaGlsZHJlbiggIi51aS1oZWFkZXI6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSwgLnVpLWZvb3RlcjpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpIiApLAoJCQlpbnRGaXhlZFRvb2xiYXJzID0gdGhpcy5fcGFnZSgpLmZpbmQoICIudWktaGVhZGVyOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJyksIC51aS1mb290ZXI6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSIgKSwKCQkJZml4ZWRUb29sYmFycyA9IGV4dEZpeGVkVG9vbGJhcnMuYWRkKCBpbnRGaXhlZFRvb2xiYXJzICkuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhZ2VGaXhlZFRvb2xiYXIgKTsKCgkJcmV0dXJuIGZpeGVkVG9vbGJhcnM7Cgl9LAoKCV9nZXRQb3NEaXNwbGF5Q2xhc3NlczogZnVuY3Rpb24oIHByZWZpeCApIHsKCQlyZXR1cm4gcHJlZml4ICsgIi1wb3NpdGlvbi0iICsgdGhpcy5vcHRpb25zLnBvc2l0aW9uICsgIiAiICsgcHJlZml4ICsgIi1kaXNwbGF5LSIgKyB0aGlzLm9wdGlvbnMuZGlzcGxheTsKCX0sCgoJX2dldFBhbmVsQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJdmFyIHBhbmVsQ2xhc3NlcyA9IHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsICsKCQkJIiAiICsgdGhpcy5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsICkgKwoJCQkiICIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbENsb3NlZDsKCgkJaWYgKCB0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCXBhbmVsQ2xhc3NlcyArPSAiIHVpLWJvZHktIiArIHRoaXMub3B0aW9ucy50aGVtZTsKCQl9CgkJaWYgKCAhIXRoaXMub3B0aW9ucy5wb3NpdGlvbkZpeGVkICkgewoJCQlwYW5lbENsYXNzZXMgKz0gIiAiICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxGaXhlZDsKCQl9CgkJcmV0dXJuIHBhbmVsQ2xhc3NlczsKCX0sCgoJX2FkZFBhbmVsQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLl9nZXRQYW5lbENsYXNzZXMoKSApOwoJfSwKCglfYmluZENsb3NlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXNlbGYuX2Nsb3NlTGluay5vbiggImNsaWNrLnBhbmVsIiAsIGZ1bmN0aW9uKCBlICkgewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCXNlbGYuY2xvc2UoKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0pOwoJCXNlbGYuZWxlbWVudC5vbiggImNsaWNrLnBhbmVsIiAsICJhOmpxbURhdGEoYWpheD0nZmFsc2UnKSIsIGZ1bmN0aW9uKC8qIGUgKi8pIHsKCQkJc2VsZi5jbG9zZSgpOwoJCX0pOwoJfSwKCglfcG9zaXRpb25QYW5lbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlwYW5lbElubmVySGVpZ2h0ID0gc2VsZi5fcGFuZWxJbm5lci5vdXRlckhlaWdodCgpLAoJCQlleHBhbmQgPSBwYW5lbElubmVySGVpZ2h0ID4gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCWlmICggZXhwYW5kIHx8ICFzZWxmLm9wdGlvbnMucG9zaXRpb25GaXhlZCApIHsKCQkJaWYgKCBleHBhbmQgKSB7CgkJCQlzZWxmLl91bmZpeFBhbmVsKCk7CgkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoIHBhbmVsSW5uZXJIZWlnaHQgKTsKCQkJfQoJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsICk7CgkJfSBlbHNlIHsKCQkJc2VsZi5fZml4UGFuZWwoKTsKCQl9Cgl9LAoKCV9iaW5kRml4TGlzdGVuZXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29uKCAkKCB3aW5kb3cgKSwgeyAidGhyb3R0bGVkcmVzaXplIjogIl9wb3NpdGlvblBhbmVsIiB9KTsKCX0sCgoJX3VuYmluZEZpeExpc3RlbmVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vZmYoICQoIHdpbmRvdyApLCAidGhyb3R0bGVkcmVzaXplIiApOwoJfSwKCglfdW5maXhQYW5lbDogZnVuY3Rpb24oKSB7CgkJaWYgKCAhIXRoaXMub3B0aW9ucy5wb3NpdGlvbkZpeGVkICYmICQuc3VwcG9ydC5maXhlZFBvc2l0aW9uICkgewoJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsRml4ZWQgKTsKCQl9Cgl9LAoKCV9maXhQYW5lbDogZnVuY3Rpb24oKSB7CgkJaWYgKCAhIXRoaXMub3B0aW9ucy5wb3NpdGlvbkZpeGVkICYmICQuc3VwcG9ydC5maXhlZFBvc2l0aW9uICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsRml4ZWQgKTsKCQl9Cgl9LAoKCV9iaW5kVXBkYXRlTGF5b3V0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXNlbGYuZWxlbWVudC5vbiggInVwZGF0ZWxheW91dCIsIGZ1bmN0aW9uKC8qIGUgKi8pIHsKCQkJaWYgKCBzZWxmLl9vcGVuICkgewoJCQkJc2VsZi5fcG9zaXRpb25QYW5lbCgpOwoJCQl9CgkJfSk7Cgl9LAoKCV9iaW5kTGlua0xpc3RlbmVyczogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb24oICJhIiwgewoJCQkiY2xpY2siOiAiX2hhbmRsZUNsaWNrIgoJCX0pOwoJCQoJfSwKCglfaGFuZGxlQ2xpY2s6IGZ1bmN0aW9uKCBlICl7CgkJaWYgKCAgZS5jdXJyZW50VGFyZ2V0LmhyZWYuc3BsaXQoICIjIiApWyAxIF0gPT09IHRoaXMuX3BhbmVsSUQgJiYgdGhpcy5fcGFuZWxJRCAhPT0gdW5kZWZpbmVkICkgewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCXZhciBsaW5rID0gJCggZS50YXJnZXQgKTsKCQkJaWYgKCBsaW5rLmhhc0NsYXNzKCAidWktYnRuIiApICkgewoJCQkJbGluay5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCXRoaXMuZWxlbWVudC5vbmUoICJwYW5lbG9wZW4gcGFuZWxjbG9zZSIsIGZ1bmN0aW9uKCkgewoJCQkJCWxpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQl9KTsKCQkJfQoJCQl0aGlzLnRvZ2dsZSgpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSwKCglfYmluZFN3aXBlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWFyZWEgPSBzZWxmLl9tb2RhbCA/IHNlbGYuZWxlbWVudC5hZGQoIHNlbGYuX21vZGFsICkgOiBzZWxmLmVsZW1lbnQ7CgoJCS8vIG9uIHN3aXBlLCBjbG9zZSB0aGUgcGFuZWwKCQlpZiAoICEhc2VsZi5vcHRpb25zLnN3aXBlQ2xvc2UgKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnBvc2l0aW9uID09PSAibGVmdCIgKSB7CgkJCQlhcmVhLm9uKCAic3dpcGVsZWZ0LnBhbmVsIiwgZnVuY3Rpb24oLyogZSAqLykgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJYXJlYS5vbiggInN3aXBlcmlnaHQucGFuZWwiLCBmdW5jdGlvbigvKiBlICovKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfSk7CgkJCX0KCQl9Cgl9LAoKCV9iaW5kUGFnZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQkkLm1vYmlsZS5kb2N1bWVudAoJCQkvLyBDbG9zZSB0aGUgcGFuZWwgaWYgYW5vdGhlciBwYW5lbCBvbiB0aGUgcGFnZSBvcGVucwoJCQkub24oICJwYW5lbGJlZm9yZW9wZW4iLCBmdW5jdGlvbiggZSApIHsKCQkJCWlmICggc2VsZi5fb3BlbiAmJiBlLnRhcmdldCAhPT0gc2VsZi5lbGVtZW50WyAwIF0gKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfQoJCQl9KQoJCQkvLyBPbiBlc2NhcGUsIGNsb3NlPyBtaWdodCBuZWVkIHRvIGhhdmUgYSB0YXJnZXQgY2hlY2sgdG9vLi4uCgkJCS5vbiggImtleXVwLnBhbmVsIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIGUua2V5Q29kZSA9PT0gMjcgJiYgc2VsZi5fb3BlbiApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9CgkJCX0pOwoJCQkKCQkvLyBDbGVhbiB1cCBvcGVuIHBhbmVscyBhZnRlciBwYWdlIGhpZGUKCQlpZiAoIHNlbGYuX3BhcmVudFBhZ2UgKSB7CgkJCSQubW9iaWxlLmRvY3VtZW50Lm9uKCAicGFnZWhpZGUiLCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSggdHJ1ZSApOwoJCQkJfQoJCQl9KTsKCQl9IGVsc2UgewoJCQkkLm1vYmlsZS5kb2N1bWVudC5vbiggInBhZ2ViZWZvcmVoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSggdHJ1ZSApOwoJCQkJfQoJCQl9KTsKCQl9Cgl9LAoKCS8vIHN0YXRlIHN0b3JhZ2Ugb2Ygb3BlbiBvciBjbG9zZWQKCV9vcGVuOiBmYWxzZSwKCV9wYWdlQ29udGVudE9wZW5DbGFzc2VzOiBudWxsLAoJX21vZGFsT3BlbkNsYXNzZXM6IG51bGwsCgoJb3BlbjogZnVuY3Rpb24oIGltbWVkaWF0ZSApIHsKCQlpZiAoICF0aGlzLl9vcGVuICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJCgkJCQlfb3BlblBhbmVsID0gZnVuY3Rpb24oKSB7CgkJCQkJJC5tb2JpbGUuZG9jdW1lbnQub2ZmKCAicGFuZWxjbG9zZSIgKTsKCQkJCQlzZWxmLl9wYWdlKCkuanFtRGF0YSggInBhbmVsIiwgIm9wZW4iICk7CgkJCQkJCgkJCQkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgJiYgby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3dyYXBwZXIoKS5hZGRDbGFzcyggby5jbGFzc2VzLmFuaW1hdGUgKTsKCQkJCQkJc2VsZi5fZml4ZWRUb29sYmFycygpLmFkZENsYXNzKCBvLmNsYXNzZXMuYW5pbWF0ZSApOwoJCQkJCX0KCgkJCQkJaWYgKCAhaW1tZWRpYXRlICYmICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIW8uYW5pbWF0ZSApIHsKCQkJCQkJJC5tb2JpbGUuZG9jdW1lbnQub24oIHNlbGYuX3RyYW5zaXRpb25FbmRFdmVudHMsIGNvbXBsZXRlICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJc2V0VGltZW91dCggY29tcGxldGUsIDAgKTsKCQkJCQl9CgoJCQkJCWlmICggby50aGVtZSAmJiBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZSgpLnBhcmVudCgpCgkJCQkJCQkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi10aGVtZWQgIiArIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi0iICsgby50aGVtZSApOwoJCQkJCX0KCgkJCQkJc2VsZi5lbGVtZW50CgkJCQkJCS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhbmVsQ2xvc2VkICkKCQkJCQkJLmFkZENsYXNzKCBvLmNsYXNzZXMucGFuZWxPcGVuICk7CgoJCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCgkJCQkJc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyA9IHNlbGYuX2dldFBvc0Rpc3BsYXlDbGFzc2VzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKTsKCQkJCQkKCQkJCQlpZiAoIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl9wYWdlKCkucGFyZW50KCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICk7CgkJCQkJCXNlbGYuX3dyYXBwZXIoKS5hZGRDbGFzcyggc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkuYWRkQ2xhc3MoIHNlbGYuX3BhZ2VDb250ZW50T3BlbkNsYXNzZXMgKTsKCQkJCQl9CgoJCQkJCXNlbGYuX21vZGFsT3BlbkNsYXNzZXMgPSBzZWxmLl9nZXRQb3NEaXNwbGF5Q2xhc3Nlcyggby5jbGFzc2VzLm1vZGFsICkgKyAiICIgKyBvLmNsYXNzZXMubW9kYWxPcGVuOwoJCQkJCWlmICggc2VsZi5fbW9kYWwgKSB7CgkJCQkJCXNlbGYuX21vZGFsLmFkZENsYXNzKCBzZWxmLl9tb2RhbE9wZW5DbGFzc2VzICk7CgkJCQkJfQoJCQkJfSwKCQkJCWNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJCQkJJC5tb2JpbGUuZG9jdW1lbnQub2ZmKCBzZWxmLl90cmFuc2l0aW9uRW5kRXZlbnRzLCBjb21wbGV0ZSApOwoJCQkJCQoJCQkJCWlmICggby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3dyYXBwZXIoKS5hZGRDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250ZW50UHJlZml4ICsgIi1vcGVuIiApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCQkJCQl9CgoJCQkJCXNlbGYuX2JpbmRGaXhMaXN0ZW5lcigpOwoKCQkJCQlzZWxmLl90cmlnZ2VyKCAib3BlbiIgKTsKCQkJCX07CgoJCQlzZWxmLl90cmlnZ2VyKCAiYmVmb3Jlb3BlbiIgKTsKCQkJCgkJCWlmICggc2VsZi5fcGFnZSgpLmpxbURhdGEoICJwYW5lbCIgKSA9PT0gIm9wZW4iICkgewoJCQkJJC5tb2JpbGUuZG9jdW1lbnQub24oICJwYW5lbGNsb3NlIiwgZnVuY3Rpb24oKSB7CgkJCQkJX29wZW5QYW5lbCgpOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlfb3BlblBhbmVsKCk7CgkJCX0KCgkJCXNlbGYuX29wZW4gPSB0cnVlOwoJCX0KCX0sCgoJY2xvc2U6IGZ1bmN0aW9uKCBpbW1lZGlhdGUgKSB7CgkJaWYgKCB0aGlzLl9vcGVuICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gdGhpcy5vcHRpb25zLAoJCQkJCgkJCQlfY2xvc2VQYW5lbCA9IGZ1bmN0aW9uKCkgewoJCQkJCWlmICggIWltbWVkaWF0ZSAmJiAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgKSB7CgkJCQkJCSQubW9iaWxlLmRvY3VtZW50Lm9uKCBzZWxmLl90cmFuc2l0aW9uRW5kRXZlbnRzLCBjb21wbGV0ZSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXNldFRpbWVvdXQoIGNvbXBsZXRlLCAwICk7CgkJCQkJfQoKCQkJCQlzZWxmLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbE9wZW4gKTsKCQkJCQkKCQkJCQlpZiAoIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyKCkucmVtb3ZlQ2xhc3MoIHNlbGYuX3BhZ2VDb250ZW50T3BlbkNsYXNzZXMgKTsKCQkJCQkJc2VsZi5fZml4ZWRUb29sYmFycygpLnJlbW92ZUNsYXNzKCBzZWxmLl9wYWdlQ29udGVudE9wZW5DbGFzc2VzICk7CgkJCQkJfQoJCQkJCQoJCQkJCWlmICggc2VsZi5fbW9kYWwgKSB7CgkJCQkJCXNlbGYuX21vZGFsLnJlbW92ZUNsYXNzKCBzZWxmLl9tb2RhbE9wZW5DbGFzc2VzICk7CgkJCQkJfQoJCQkJfSwKCQkJCWNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJCQkJJC5tb2JpbGUuZG9jdW1lbnQub2ZmKCBzZWxmLl90cmFuc2l0aW9uRW5kRXZlbnRzLCBjb21wbGV0ZSApOwoJCQkJCQoJCQkJCWlmICggby50aGVtZSAmJiBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZSgpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciArICItdGhlbWVkICIgKyBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciArICItIiArIG8udGhlbWUgKTsKCQkJCQl9CgkJCQkJCQoJCQkJCXNlbGYuZWxlbWVudC5hZGRDbGFzcyggby5jbGFzc2VzLnBhbmVsQ2xvc2VkICk7CgoJCQkJCWlmICggby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3BhZ2UoKS5wYXJlbnQoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKTsKCQkJCQkJc2VsZi5fd3JhcHBlcigpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKyAiLW9wZW4iICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250ZW50UHJlZml4ICsgIi1vcGVuIiApOwoJCQkJCX0KCgkJCQkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgJiYgby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3dyYXBwZXIoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLmFuaW1hdGUgKTsKCQkJCQkJc2VsZi5fZml4ZWRUb29sYmFycygpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMuYW5pbWF0ZSApOwoJCQkJCX0KCgkJCQkJc2VsZi5fZml4UGFuZWwoKTsKCQkJCQlzZWxmLl91bmJpbmRGaXhMaXN0ZW5lcigpOwoJCQkJCSQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCgpOwoKCQkJCQlzZWxmLl9wYWdlKCkuanFtUmVtb3ZlRGF0YSggInBhbmVsIiApOwoJCQkJCQoJCQkJCXNlbGYuX3RyaWdnZXIoICJjbG9zZSIgKTsKCQkJCX07CgoJCQlzZWxmLl90cmlnZ2VyKCAiYmVmb3JlY2xvc2UiICk7CgoJCQlfY2xvc2VQYW5lbCgpOwoKCQkJc2VsZi5fb3BlbiA9IGZhbHNlOwoJCX0KCX0sCgoJdG9nZ2xlOiBmdW5jdGlvbigpIHsKCQl0aGlzWyB0aGlzLl9vcGVuID8gImNsb3NlIiA6ICJvcGVuIiBdKCk7Cgl9LAoKCV90cmFuc2l0aW9uRW5kRXZlbnRzOiAid2Via2l0VHJhbnNpdGlvbkVuZCBvVHJhbnNpdGlvbkVuZCBvdHJhbnNpdGlvbmVuZCB0cmFuc2l0aW9uZW5kIG1zVHJhbnNpdGlvbkVuZCIsCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciBvID0gdGhpcy5vcHRpb25zLAoJCQltdWx0aXBsZVBhbmVscyA9ICggJCggImJvZHkgPiA6bW9iaWxlLXBhbmVsIiApLmxlbmd0aCArICQubW9iaWxlLmFjdGl2ZVBhZ2UuZmluZCggIjptb2JpbGUtcGFuZWwiICkubGVuZ3RoICkgPiAxOwoKCQlpZiAoIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkvLyBEZXN0cm95IHRoZSB3cmFwcGVyIGV2ZW4gaWYgdGhlcmUgYXJlIHN0aWxsIG90aGVyIHBhbmVscywgYmVjYXVzZSB3ZSBkb24ndCBrbm93IGlmIHRoZXkgdXNlIGEgd3JhcHBlcgoJCQl0aGlzLl93cmFwcGVyKCkuY2hpbGRyZW4oKS51bndyYXAoKTsKCgkJCWlmICggdGhpcy5fb3BlbiApIHsKCQkJCQoJCQkJdGhpcy5fZml4ZWRUb29sYmFycygpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKyAiLW9wZW4iICk7CgkJCQkKCQkJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICkgewoJCQkJCXRoaXMuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLmFuaW1hdGUgKTsKCQkJCX0KCQkJCQoJCQkJdGhpcy5fcGFnZSgpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciApOwoJCQkJCgkJCQlpZiAoIG8udGhlbWUgKSB7CgkJCQkJdGhpcy5fcGFnZSgpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciArICItdGhlbWVkICIgKyBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciArICItIiArIG8udGhlbWUgKTsKCQkJCX0KCQkJfQoJCX0KCgkJaWYgKCAhbXVsdGlwbGVQYW5lbHMgKSB7CgoJCQkkLm1vYmlsZS5kb2N1bWVudC5vZmYoICJwYW5lbG9wZW4gcGFuZWxjbG9zZSIgKTsKCQkJCgkJCWlmICggdGhpcy5fb3BlbiApIHsKCQkJCSQubW9iaWxlLmRvY3VtZW50Lm9mZiggdGhpcy5fdHJhbnNpdGlvbkVuZEV2ZW50cyApOwoJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCk7CgkJCX0KCQl9CgkJCgkJaWYgKCB0aGlzLl9vcGVuICkgewoJCQl0aGlzLl9wYWdlKCkuanFtUmVtb3ZlRGF0YSggInBhbmVsIiApOwoJCX0KCQkKCQl0aGlzLl9wYW5lbElubmVyLmNoaWxkcmVuKCkudW53cmFwKCk7CgoJCXRoaXMuZWxlbWVudAoJCQkucmVtb3ZlQ2xhc3MoIFsgdGhpcy5fZ2V0UGFuZWxDbGFzc2VzKCksIG8uY2xhc3Nlcy5wYW5lbE9wZW4sIG8uY2xhc3Nlcy5hbmltYXRlIF0uam9pbiggIiAiICkgKQoJCQkub2ZmKCAic3dpcGVsZWZ0LnBhbmVsIHN3aXBlcmlnaHQucGFuZWwiICkKCQkJLm9mZiggInBhbmVsYmVmb3Jlb3BlbiIgKQoJCQkub2ZmKCAicGFuZWxoaWRlIiApCgkJCS5vZmYoICJrZXl1cC5wYW5lbCIgKQoJCQkub2ZmKCAidXBkYXRlbGF5b3V0IiApCgkJCS5vZmYoIHRoaXMuX3RyYW5zaXRpb25FbmRFdmVudHMgKTsKCgkJdGhpcy5fY2xvc2VMaW5rLm9mZiggImNsaWNrLnBhbmVsIiApOwoKCQlpZiAoIHRoaXMuX21vZGFsICkgewoJCQl0aGlzLl9tb2RhbC5yZW1vdmUoKTsKCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50YWJsZSIsIHsKCW9wdGlvbnM6IHsKCQljbGFzc2VzOiB7CgkJCXRhYmxlOiAidWktdGFibGUiCgkJfSwKCQllbmhhbmNlZDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnRhYmxlICk7CgkJfQoKCQkvLyBleHRlbmQgaGVyZSwgYXNzaWduIG9uIHJlZnJlc2ggPiBfc2V0SGVhZGVycwoJCSQuZXh0ZW5kKCB0aGlzLCB7CgoJCQkvLyBFeHBvc2UgaGVhZGVycyBhbmQgYWxsSGVhZGVycyBwcm9wZXJ0aWVzIG9uIHRoZSB3aWRnZXQKCQkJLy8gaGVhZGVycyByZWZlcmVuY2VzIHRoZSBUSHMgd2l0aGluIHRoZSBmaXJzdCBUUiBpbiB0aGUgdGFibGUKCQkJaGVhZGVyczogdW5kZWZpbmVkLAoKCQkJLy8gYWxsSGVhZGVycyByZWZlcmVuY2VzIGhlYWRlcnMsIHBsdXMgYWxsIFRIcyBpbiB0aGUgdGhlYWQsIHdoaWNoIG1heQoJCQkvLyBpbmNsdWRlIHNldmVyYWwgcm93cywgb3Igbm90CgkJCWFsbEhlYWRlcnM6IHVuZGVmaW5lZAoJCX0pOwoKCQl0aGlzLl9yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCV9zZXRIZWFkZXJzOiBmdW5jdGlvbigpIHsKCQl2YXIgdHJzID0gdGhpcy5lbGVtZW50LmZpbmQoICJ0aGVhZCB0ciIgKTsKCgkJdGhpcy5oZWFkZXJzID0gdGhpcy5lbGVtZW50LmZpbmQoICJ0cjplcSgwKSIgKS5jaGlsZHJlbigpOwoJCXRoaXMuYWxsSGVhZGVycyA9IHRoaXMuaGVhZGVycy5hZGQoIHRycy5jaGlsZHJlbigpICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJcmVidWlsZDogJC5ub29wLAoKCV9yZWZyZXNoOiBmdW5jdGlvbiggLyogY3JlYXRlICovICkgewoJCXZhciB0YWJsZSA9IHRoaXMuZWxlbWVudCwKCQkJdHJzID0gdGFibGUuZmluZCggInRoZWFkIHRyIiApOwoKCQkvLyB1cGRhdGluZyBoZWFkZXJzIG9uIHJlZnJlc2ggKGZpeGVzICM1ODgwKQoJCXRoaXMuX3NldEhlYWRlcnMoKTsKCgkJLy8gSXRlcmF0ZSBvdmVyIHRoZSB0cnMKCQl0cnMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciBjb2x1bW5Db3VudCA9IDA7CgoJCQkvLyBJdGVyYXRlIG92ZXIgdGhlIGNoaWxkcmVuIG9mIHRoZSB0cgoJCQkkKCB0aGlzICkuY2hpbGRyZW4oKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCXZhciBzcGFuID0gcGFyc2VJbnQoIHRoaXMuZ2V0QXR0cmlidXRlKCAiY29sc3BhbiIgKSwgMTAgKSwKCQkJCQlzZWxlY3RvciA9ICI6bnRoLWNoaWxkKCIgKyAoIGNvbHVtbkNvdW50ICsgMSApICsgIikiLAoJCQkJCWo7CgoJCQkJdGhpcy5zZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJjb2xzdGFydCIsIGNvbHVtbkNvdW50ICsgMSApOwoKCQkJCWlmICggc3BhbiApIHsKCQkJCQlmb3IoIGogPSAwOyBqIDwgc3BhbiAtIDE7IGorKyApIHsKCQkJCQkJY29sdW1uQ291bnQrKzsKCQkJCQkJc2VsZWN0b3IgKz0gIiwgOm50aC1jaGlsZCgiICsgKCBjb2x1bW5Db3VudCArIDEgKSArICIpIjsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gU3RvcmUgImNlbGxzIiBkYXRhIG9uIGhlYWRlciBhcyBhIHJlZmVyZW5jZSB0byBhbGwgY2VsbHMgaW4gdGhlIAoJCQkJLy8gc2FtZSBjb2x1bW4gYXMgdGhpcyBUSAoJCQkJJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIsIHRhYmxlLmZpbmQoICJ0ciIgKS5ub3QoIHRycy5lcSggMCApICkubm90KCB0aGlzICkuY2hpbGRyZW4oIHNlbGVjdG9yICkgKTsKCgkJCQljb2x1bW5Db3VudCsrOwoJCQl9KTsKCQl9KTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50YWJsZSIsICQubW9iaWxlLnRhYmxlLCB7CglvcHRpb25zOiB7CgkJbW9kZTogImNvbHVtbnRvZ2dsZSIsCgkJY29sdW1uQnRuVGhlbWU6IG51bGwsCgkJY29sdW1uUG9wdXBUaGVtZTogbnVsbCwKCQljb2x1bW5CdG5UZXh0OiAiQ29sdW1ucy4uLiIsCgkJY2xhc3NlczogJC5leHRlbmQoICQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNsYXNzZXMsIHsKCQkJcG9wdXA6ICJ1aS10YWJsZS1jb2x1bW50b2dnbGUtcG9wdXAiLAoJCQljb2x1bW5CdG46ICJ1aS10YWJsZS1jb2x1bW50b2dnbGUtYnRuIiwKCQkJcHJpb3JpdHlQcmVmaXg6ICJ1aS10YWJsZS1wcmlvcml0eS0iLAoJCQljb2x1bW5Ub2dnbGVUYWJsZTogInVpLXRhYmxlLWNvbHVtbnRvZ2dsZSIKCQl9KQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQlpZiggdGhpcy5vcHRpb25zLm1vZGUgIT09ICJjb2x1bW50b2dnbGUiICkgewoJCQlyZXR1cm47CgkJfQoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfbWVudTogbnVsbAoJCX0pOwoKCQlpZiggdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9tZW51ID0gdGhpcy5kb2N1bWVudC5maW5kKCB0aGlzLl9pZCgpICsgIi1wb3B1cCIgKS5jaGlsZHJlbigpLmZpcnN0KCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5fbWVudSA9IHRoaXMuX2VuaGFuY2VDb2xUb2dnbGUoKTsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5jb2x1bW5Ub2dnbGVUYWJsZSApOwoJCX0KCgkJdGhpcy5fc2V0dXBFdmVudHMoKTsKCgkJdGhpcy5fc2V0VG9nZ2xlU3RhdGUoKTsKCX0sCgoJX2lkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gKCB0aGlzLmVsZW1lbnQuYXR0ciggImlkIiApIHx8ICggdGhpcy53aWRnZXROYW1lICsgdGhpcy51dWlkICkgKTsKCX0sCgoJX3NldHVwRXZlbnRzOiBmdW5jdGlvbigpIHsKCQkvL05PVEU6IGlucHV0cyBhcmUgYm91bmQgaW4gYmluZFRvZ2dsZXMsCgkJLy8gc28gaXQgY2FuIGJlIGNhbGxlZCBvbiByZWZyZXNoLCB0b28KCgkJLy8gdXBkYXRlIGNvbHVtbiB0b2dnbGVzIG9uIHJlc2l6ZQoJCXRoaXMuX29uKCAkLm1vYmlsZS53aW5kb3csIHsKCQkJdGhyb3R0bGVkcmVzaXplOiAiX3NldFRvZ2dsZVN0YXRlIgoJCX0pOwoJfSwKCglfYmluZFRvZ2dsZXM6IGZ1bmN0aW9uKCBtZW51ICkgewoJCXZhciBpbnB1dHMgPSBtZW51LmZpbmQoICJpbnB1dCIgKTsKCgkJdGhpcy5fb24oIGlucHV0cywgewoJCQljaGFuZ2U6ICJfbWVudUlucHV0Q2hhbmdlIgoJCX0pOwoJfSwKCglfYWRkVG9nZ2xlczogZnVuY3Rpb24oIG1lbnUsIGtlZXAgKSB7CgkJdmFyIG9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIGFsbG93IHVwZGF0ZSBvZiBtZW51IG9uIHJlZnJlc2ggKGZpeGVzICM1ODgwKQoJCWlmICggIWtlZXAgKSB7CgkJCW1lbnUuZW1wdHkoKTsKCQl9CgoJCS8vIGNyZWF0ZSB0aGUgaGlkZS9zaG93IHRvZ2dsZXMKCQl0aGlzLmhlYWRlcnMubm90KCAidGQiICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciBoZWFkZXIgPSAkKCB0aGlzICksCgkJCQlwcmlvcml0eSA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggdGhpcywgInByaW9yaXR5IiApLAoJCQkJY2VsbHMgPSBoZWFkZXIuYWRkKCBoZWFkZXIuanFtRGF0YSggImNlbGxzIiApICk7CgoJCQlpZiggcHJpb3JpdHkgKSB7CgkJCQljZWxscy5hZGRDbGFzcyggb3B0cy5jbGFzc2VzLnByaW9yaXR5UHJlZml4ICsgcHJpb3JpdHkgKTsKCgkJCQlpZiAoICFrZWVwICkgewoJCQkJCSQoIjxsYWJlbD48aW5wdXQgdHlwZT0nY2hlY2tib3gnIGNoZWNrZWQgLz4iICsKCQkJCQkJKCBoZWFkZXIuY2hpbGRyZW4oICJhYmJyIiApLmZpcnN0KCkuYXR0ciggInRpdGxlIiApIHx8CgkJCQkJCQloZWFkZXIudGV4dCgpICkgKwoJCQkJCQkiPC9sYWJlbD4iICkKCQkJCQkJLmFwcGVuZFRvKCBtZW51ICkKCQkJCQkJLmNoaWxkcmVuKCAwICkKCQkJCQkJLmpxbURhdGEoICJjZWxscyIsIGNlbGxzICkKCQkJCQkJLmNoZWNrYm94cmFkaW8oIHsKCQkJCQkJCXRoZW1lOiBvcHRzLmNvbHVtblBvcHVwVGhlbWUKCQkJCQkJfSk7CgkJCQl9CgkJCX0KCQl9KTsKCgkJLy8gc2V0IGJpbmRpbmdzIGhlcmUKCQlpZiAoICFrZWVwICkgewoJCQl0aGlzLl9iaW5kVG9nZ2xlcyggbWVudSApOwoJCX0KCX0sCgoJX21lbnVJbnB1dENoYW5nZTogZnVuY3Rpb24oIGV2dCApIHsKCQl2YXIgaW5wdXQgPSAkKCBldnQudGFyZ2V0ICksCgkJCWNoZWNrZWQgPSBpbnB1dFsgMCBdLmNoZWNrZWQ7CgoJCWlucHV0LmpxbURhdGEoICJjZWxscyIgKQoJCQkudG9nZ2xlQ2xhc3MoICJ1aS10YWJsZS1jZWxsLWhpZGRlbiIsICFjaGVja2VkICkKCQkJLnRvZ2dsZUNsYXNzKCAidWktdGFibGUtY2VsbC12aXNpYmxlIiwgY2hlY2tlZCApOwoKCQlpZiAoIGlucHV0WyAwIF0uZ2V0QXR0cmlidXRlKCAibG9ja2VkIiApICkgewoJCQlpbnB1dC5yZW1vdmVBdHRyKCAibG9ja2VkIiApOwoKCQkJdGhpcy5fdW5sb2NrQ2VsbHMoIGlucHV0LmpxbURhdGEoICJjZWxscyIgKSApOwoJCX0gZWxzZSB7CgkJCWlucHV0LmF0dHIoICJsb2NrZWQiLCB0cnVlICk7CgkJfQoJfSwKCglfdW5sb2NrQ2VsbHM6IGZ1bmN0aW9uKCBjZWxscyApIHsKCQkvLyBhbGxvdyBoaWRlL3Nob3cgdmlhIENTUyBvbmx5ID0gcmVtb3ZlIGFsbCB0b2dnbGUtbG9ja3MKCQljZWxscy5yZW1vdmVDbGFzcyggInVpLXRhYmxlLWNlbGwtaGlkZGVuIHVpLXRhYmxlLWNlbGwtdmlzaWJsZSIpOwoJfSwKCglfZW5oYW5jZUNvbFRvZ2dsZTogZnVuY3Rpb24oKSB7CgkJdmFyIGlkICwgbWVudUJ1dHRvbiwgcG9wdXAsIG1lbnUsCgkJCXRhYmxlID0gdGhpcy5lbGVtZW50LAoJCQlvcHRzID0gdGhpcy5vcHRpb25zLAoJCQlucyA9ICQubW9iaWxlLm5zLAoJCQlmcmFnbWVudCA9ICQubW9iaWxlLmRvY3VtZW50WyAwIF0uY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoKCQlpZCA9IHRoaXMuX2lkKCkgKyAiLXBvcHVwIjsKCQltZW51QnV0dG9uID0gJCggIjxhIHJvbGU9J2J1dHRvbicgaHJlZj0nIyIgKyBpZCArICInICIgKwoJCQkiY2xhc3M9JyIgKyBvcHRzLmNsYXNzZXMuY29sdW1uQnRuICsgIiB1aS1idG4gdWktYnRuLSIgKyAoIG9wdHMuY29sdW1uQnRuVGhlbWUgfHwgImEiICkgKyAiIHVpLWNvcm5lci1hbGwgdWktc2hhZG93IHVpLW1pbmknICIgKwoJCQkiZGF0YS0iICsgbnMgKyAicmVsPSdwb3B1cCcgIiArCgkJCSJkYXRhLSIgKyBucyArICJtaW5pPSd0cnVlJz4iICsgb3B0cy5jb2x1bW5CdG5UZXh0ICsgIjwvYT4iICk7CgkJcG9wdXAgPSAkKCAiPGRpdiBkYXRhLSIgKyBucyArICJyb2xlPSdwb3B1cCcgZGF0YS0iICsgbnMgKyAicm9sZT0nZmllbGRjb250YWluJyBjbGFzcz0nIiArIG9wdHMuY2xhc3Nlcy5wb3B1cCArICInIGlkPSciICsgaWQgKyAiJz48L2Rpdj4iICk7CgkJbWVudSA9ICQoICI8ZmllbGRzZXQgZGF0YS0iICsgbnMgKyAicm9sZT0nY29udHJvbGdyb3VwJz48L2ZpZWxkc2V0PiIgKTsKCgkJLy8gc2V0IGV4dGVuc2lvbiBoZXJlLCBzZW5kICJmYWxzZSIgdG8gdHJpZ2dlciBidWlsZC9yZWJ1aWxkCgkJdGhpcy5fYWRkVG9nZ2xlcyggbWVudSwgZmFsc2UgKTsKCgkJbWVudS5hcHBlbmRUbyggcG9wdXAgKTsKCgkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIHBvcHVwWyAwIF0gKTsKCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggbWVudUJ1dHRvblsgMCBdICk7CgkJdGFibGUuYmVmb3JlKCBmcmFnbWVudCApOwoKCQlwb3B1cC5wb3B1cCgpLmVuaGFuY2VXaXRoaW4oKTsKCgkJcmV0dXJuIG1lbnU7Cgl9LAoKCXJlYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLm1vZGUgPT09ICJjb2x1bW50b2dnbGUiICkgewoJCQkvLyBOT1RFOiByZWJ1aWxkIHBhc3NlcyAiZmFsc2UiLCB3aGlsZSByZWZyZXNoIHBhc3NlcyAidW5kZWZpbmVkIgoJCQkvLyBib3RoIHJlZnJlc2ggdGhlIHRhYmxlLCBidXQgaW5zaWRlIGFkZFRvZ2dsZXMsICFmYWxzZSB3aWxsIGJlIHRydWUsCgkJCS8vIHNvIGEgcmVidWlsZCBjYWxsIGNhbiBiZSBpbmRlbnRpZmllZAoJCQl0aGlzLl9yZWZyZXNoKCBmYWxzZSApOwoJCX0KCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdGhpcy5fc3VwZXIoIGNyZWF0ZSApOwoKCQlpZiAoICFjcmVhdGUgJiYgdGhpcy5vcHRpb25zLm1vZGUgPT09ICJjb2x1bW50b2dnbGUiICkgewoJCQkvLyBjb2x1bW5zIG5vdCBiZWluZyByZXBsYWNlZCBtdXN0IGJlIGNsZWFyZWQgZnJvbSBpbnB1dCB0b2dnbGUtbG9ja3MKCQkJdGhpcy5fdW5sb2NrQ2VsbHMoIHRoaXMuYWxsSGVhZGVycyApOwoKCQkJLy8gdXBkYXRlIGNvbHVtbnRvZ2dsZXMgYW5kIGNlbGxzCgkJCXRoaXMuX2FkZFRvZ2dsZXMoIHRoaXMuX21lbnUsIGNyZWF0ZSApOwoKCQkJLy8gY2hlY2svdW5jaGVjawoJCQl0aGlzLl9zZXRUb2dnbGVTdGF0ZSgpOwoJCX0KCX0sCgoJX3NldFRvZ2dsZVN0YXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9tZW51LmZpbmQoICJpbnB1dCIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGNoZWNrYm94ID0gJCggdGhpcyApOwoKCQkJdGhpcy5jaGVja2VkID0gY2hlY2tib3guanFtRGF0YSggImNlbGxzIiApLmVxKCAwICkuY3NzKCAiZGlzcGxheSIgKSA9PT0gInRhYmxlLWNlbGwiOwoJCQljaGVja2JveC5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCQl9KTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50YWJsZSIsICQubW9iaWxlLnRhYmxlLCB7CglvcHRpb25zOiB7CgkJbW9kZTogInJlZmxvdyIsCgkJY2xhc3NlczogJC5leHRlbmQoICQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNsYXNzZXMsIHsKCQkJcmVmbG93VGFibGU6ICJ1aS10YWJsZS1yZWZsb3ciLAoJCQljZWxsTGFiZWxzOiAidWktdGFibGUtY2VsbC1sYWJlbCIKCQl9KQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQkvLyBJZiBpdCdzIG5vdCByZWZsb3cgbW9kZSwgcmV0dXJuIGhlcmUuCgkJaWYoIHRoaXMub3B0aW9ucy5tb2RlICE9PSAicmVmbG93IiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMucmVmbG93VGFibGUgKTsKCgkJCXRoaXMuX3VwZGF0ZVJlZmxvdygpOwoJCX0KCX0sCgoJcmVidWlsZDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMubW9kZSA9PT0gInJlZmxvdyIgKSB7CgkJCXRoaXMuX3JlZnJlc2goIGZhbHNlICk7CgkJfQoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl0aGlzLl9zdXBlciggY3JlYXRlICk7CgkJaWYgKCAhY3JlYXRlICYmIHRoaXMub3B0aW9ucy5tb2RlID09PSAicmVmbG93IiApIHsKCQkJdGhpcy5fdXBkYXRlUmVmbG93KCApOwoJCX0KCX0sCgoJX3VwZGF0ZVJlZmxvdzogZnVuY3Rpb24oKSB7CgkJdmFyIHRhYmxlID0gdGhpcywKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJLy8gZ2V0IGhlYWRlcnMgaW4gcmV2ZXJzZSBvcmRlciBzbyB0aGF0IHRvcC1sZXZlbCBoZWFkZXJzIGFyZSBhcHBlbmRlZCBsYXN0CgkJJCggdGFibGUuYWxsSGVhZGVycy5nZXQoKS5yZXZlcnNlKCkgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGNlbGxzID0gJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKSwKCQkJCWNvbHN0YXJ0ID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAiY29sc3RhcnQiICksCgkJCQloaWVyYXJjaHlDbGFzcyA9IGNlbGxzLm5vdCggdGhpcyApLmZpbHRlciggInRoZWFkIHRoIiApLmxlbmd0aCAmJiAiIHVpLXRhYmxlLWNlbGwtbGFiZWwtdG9wIiwKCQkJCXRleHQgPSAkKCB0aGlzICkudGV4dCgpLAoJCQkJaXRlcmF0aW9uLCBmaWx0ZXI7CgoJCQkJaWYgKCB0ZXh0ICE9PSAiIiAgKSB7CgoJCQkJCWlmKCBoaWVyYXJjaHlDbGFzcyApIHsKCQkJCQkJaXRlcmF0aW9uID0gcGFyc2VJbnQoIHRoaXMuZ2V0QXR0cmlidXRlKCAiY29sc3BhbiIgKSwgMTAgKTsKCQkJCQkJZmlsdGVyID0gIiI7CgoJCQkJCQlpZiAoIGl0ZXJhdGlvbiApewoJCQkJCQkJZmlsdGVyID0gInRkOm50aC1jaGlsZCgiKyBpdGVyYXRpb24gKyJuICsgIiArICggY29sc3RhcnQgKSArIikiOwoJCQkJCQl9CgoJCQkJCQl0YWJsZS5fYWRkTGFiZWxzKCBjZWxscy5maWx0ZXIoIGZpbHRlciApLCBvcHRzLmNsYXNzZXMuY2VsbExhYmVscyArIGhpZXJhcmNoeUNsYXNzLCB0ZXh0ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGFibGUuX2FkZExhYmVscyggY2VsbHMsIG9wdHMuY2xhc3Nlcy5jZWxsTGFiZWxzLCB0ZXh0ICk7CgkJCQkJfQoKCQkJCX0KCQl9KTsKCX0sCgoJX2FkZExhYmVsczogZnVuY3Rpb24oIGNlbGxzLCBsYWJlbCwgdGV4dCApIHsKCQkvLyAubm90IGZpeGVzICM2MDA2CgkJY2VsbHMubm90KCAiOmhhcyhiLiIgKyBsYWJlbCArICIpIiApLnByZXBlbmQoICI8YiBjbGFzcz0nIiArIGxhYmVsICsgIic+IiArIHRleHQgKyAiPC9iPiIgICk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKLyohCiAqIGpRdWVyeSBVSSBUYWJzIEBWRVJTSU9OCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vdGFicy8KICoKICogRGVwZW5kczoKICoJanF1ZXJ5LnVpLmNvcmUuanMKICoJanF1ZXJ5LnVpLndpZGdldC5qcwogKi8KKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgdGFiSWQgPSAwLAoJcmhhc2ggPSAvIy4qJC87CgpmdW5jdGlvbiBnZXROZXh0VGFiSWQoKSB7CglyZXR1cm4gKyt0YWJJZDsKfQoKZnVuY3Rpb24gaXNMb2NhbCggYW5jaG9yICkgewoJcmV0dXJuIGFuY2hvci5oYXNoLmxlbmd0aCA+IDEgJiYKCQlkZWNvZGVVUklDb21wb25lbnQoIGFuY2hvci5ocmVmLnJlcGxhY2UoIHJoYXNoLCAiIiApICkgPT09CgkJCWRlY29kZVVSSUNvbXBvbmVudCggbG9jYXRpb24uaHJlZi5yZXBsYWNlKCByaGFzaCwgIiIgKSApOwp9CgokLndpZGdldCggInVpLnRhYnMiLCB7Cgl2ZXJzaW9uOiAiQFZFUlNJT04iLAoJZGVsYXk6IDMwMCwKCW9wdGlvbnM6IHsKCQlhY3RpdmU6IG51bGwsCgkJY29sbGFwc2libGU6IGZhbHNlLAoJCWV2ZW50OiAiY2xpY2siLAoJCWhlaWdodFN0eWxlOiAiY29udGVudCIsCgkJaGlkZTogbnVsbCwKCQlzaG93OiBudWxsLAoKCQkvLyBjYWxsYmFja3MKCQlhY3RpdmF0ZTogbnVsbCwKCQliZWZvcmVBY3RpdmF0ZTogbnVsbCwKCQliZWZvcmVMb2FkOiBudWxsLAoJCWxvYWQ6IG51bGwKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQl0aGlzLnJ1bm5pbmcgPSBmYWxzZTsKCgkJdGhpcy5lbGVtZW50CgkJCS5hZGRDbGFzcyggInVpLXRhYnMgdWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1hbGwiICkKCQkJLnRvZ2dsZUNsYXNzKCAidWktdGFicy1jb2xsYXBzaWJsZSIsIG9wdGlvbnMuY29sbGFwc2libGUgKQoJCQkvLyBQcmV2ZW50IHVzZXJzIGZyb20gZm9jdXNpbmcgZGlzYWJsZWQgdGFicyB2aWEgY2xpY2sKCQkJLmRlbGVnYXRlKCAiLnVpLXRhYnMtbmF2ID4gbGkiLCAibW91c2Vkb3duIiArIHRoaXMuZXZlbnROYW1lc3BhY2UsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggJCggdGhpcyApLmlzKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0pCgkJCS8vIHN1cHBvcnQ6IElFIDw5CgkJCS8vIFByZXZlbnRpbmcgdGhlIGRlZmF1bHQgYWN0aW9uIGluIG1vdXNlZG93biBkb2Vzbid0IHByZXZlbnQgSUUKCQkJLy8gZnJvbSBmb2N1c2luZyB0aGUgZWxlbWVudCwgc28gaWYgdGhlIGFuY2hvciBnZXRzIGZvY3VzZWQsIGJsdXIuCgkJCS8vIFdlIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgZm9jdXNpbmcgdGhlIHByZXZpb3VzbHkgZm9jdXNlZAoJCQkvLyBlbGVtZW50IHNpbmNlIGNsaWNraW5nIG9uIGEgbm9uLWZvY3VzYWJsZSBlbGVtZW50IHNob3VsZCBmb2N1cwoJCQkvLyB0aGUgYm9keSBhbnl3YXkuCgkJCS5kZWxlZ2F0ZSggIi51aS10YWJzLWFuY2hvciIsICJmb2N1cyIgKyB0aGlzLmV2ZW50TmFtZXNwYWNlLCBmdW5jdGlvbigpIHsKCQkJCWlmICggJCggdGhpcyApLmNsb3Nlc3QoICJsaSIgKS5pcyggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSApIHsKCQkJCQl0aGlzLmJsdXIoKTsKCQkJCX0KCQkJfSk7CgoJCXRoaXMuX3Byb2Nlc3NUYWJzKCk7CgkJb3B0aW9ucy5hY3RpdmUgPSB0aGlzLl9pbml0aWFsQWN0aXZlKCk7CgoJCS8vIFRha2UgZGlzYWJsaW5nIHRhYnMgdmlhIGNsYXNzIGF0dHJpYnV0ZSBmcm9tIEhUTUwKCQkvLyBpbnRvIGFjY291bnQgYW5kIHVwZGF0ZSBvcHRpb24gcHJvcGVybHkuCgkJaWYgKCAkLmlzQXJyYXkoIG9wdGlvbnMuZGlzYWJsZWQgKSApIHsKCQkJb3B0aW9ucy5kaXNhYmxlZCA9ICQudW5pcXVlKCBvcHRpb25zLmRpc2FibGVkLmNvbmNhdCgKCQkJCSQubWFwKCB0aGlzLnRhYnMuZmlsdGVyKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApLCBmdW5jdGlvbiggbGkgKSB7CgkJCQkJcmV0dXJuIHRoYXQudGFicy5pbmRleCggbGkgKTsKCQkJCX0pCgkJCSkgKS5zb3J0KCk7CgkJfQoKCQkvLyBjaGVjayBmb3IgbGVuZ3RoIGF2b2lkcyBlcnJvciB3aGVuIGluaXRpYWxpemluZyBlbXB0eSBsaXN0CgkJaWYgKCB0aGlzLm9wdGlvbnMuYWN0aXZlICE9PSBmYWxzZSAmJiB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQl0aGlzLmFjdGl2ZSA9IHRoaXMuX2ZpbmRBY3RpdmUoIG9wdGlvbnMuYWN0aXZlICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5hY3RpdmUgPSAkKCk7CgkJfQoKCQl0aGlzLl9yZWZyZXNoKCk7CgoJCWlmICggdGhpcy5hY3RpdmUubGVuZ3RoICkgewoJCQl0aGlzLmxvYWQoIG9wdGlvbnMuYWN0aXZlICk7CgkJfQoJfSwKCglfaW5pdGlhbEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGFjdGl2ZSA9IHRoaXMub3B0aW9ucy5hY3RpdmUsCgkJCWNvbGxhcHNpYmxlID0gdGhpcy5vcHRpb25zLmNvbGxhcHNpYmxlLAoJCQlsb2NhdGlvbkhhc2ggPSBsb2NhdGlvbi5oYXNoLnN1YnN0cmluZyggMSApOwoKCQlpZiAoIGFjdGl2ZSA9PT0gbnVsbCApIHsKCQkJLy8gY2hlY2sgdGhlIGZyYWdtZW50IGlkZW50aWZpZXIgaW4gdGhlIFVSTAoJCQlpZiAoIGxvY2F0aW9uSGFzaCApIHsKCQkJCXRoaXMudGFicy5lYWNoKGZ1bmN0aW9uKCBpLCB0YWIgKSB7CgkJCQkJaWYgKCAkKCB0YWIgKS5hdHRyKCAiYXJpYS1jb250cm9scyIgKSA9PT0gbG9jYXRpb25IYXNoICkgewoJCQkJCQlhY3RpdmUgPSBpOwoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCgkJCS8vIGNoZWNrIGZvciBhIHRhYiBtYXJrZWQgYWN0aXZlIHZpYSBhIGNsYXNzCgkJCWlmICggYWN0aXZlID09PSBudWxsICkgewoJCQkJYWN0aXZlID0gdGhpcy50YWJzLmluZGV4KCB0aGlzLnRhYnMuZmlsdGVyKCAiLnVpLXRhYnMtYWN0aXZlIiApICk7CgkJCX0KCgkJCS8vIG5vIGFjdGl2ZSB0YWIsIHNldCB0byBmYWxzZQoJCQlpZiAoIGFjdGl2ZSA9PT0gbnVsbCB8fCBhY3RpdmUgPT09IC0xICkgewoJCQkJYWN0aXZlID0gdGhpcy50YWJzLmxlbmd0aCA/IDAgOiBmYWxzZTsKCQkJfQoJCX0KCgkJLy8gaGFuZGxlIG51bWJlcnM6IG5lZ2F0aXZlLCBvdXQgb2YgcmFuZ2UKCQlpZiAoIGFjdGl2ZSAhPT0gZmFsc2UgKSB7CgkJCWFjdGl2ZSA9IHRoaXMudGFicy5pbmRleCggdGhpcy50YWJzLmVxKCBhY3RpdmUgKSApOwoJCQlpZiAoIGFjdGl2ZSA9PT0gLTEgKSB7CgkJCQlhY3RpdmUgPSBjb2xsYXBzaWJsZSA/IGZhbHNlIDogMDsKCQkJfQoJCX0KCgkJLy8gZG9uJ3QgYWxsb3cgY29sbGFwc2libGU6IGZhbHNlIGFuZCBhY3RpdmU6IGZhbHNlCgkJaWYgKCAhY29sbGFwc2libGUgJiYgYWN0aXZlID09PSBmYWxzZSAmJiB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQlhY3RpdmUgPSAwOwoJCX0KCgkJcmV0dXJuIGFjdGl2ZTsKCX0sCgoJX2dldENyZWF0ZUV2ZW50RGF0YTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHsKCQkJdGFiOiB0aGlzLmFjdGl2ZSwKCQkJcGFuZWw6ICF0aGlzLmFjdGl2ZS5sZW5ndGggPyAkKCkgOiB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGhpcy5hY3RpdmUgKQoJCX07Cgl9LAoKCV90YWJLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGZvY3VzZWRUYWIgPSAkKCB0aGlzLmRvY3VtZW50WzBdLmFjdGl2ZUVsZW1lbnQgKS5jbG9zZXN0KCAibGkiICksCgkJCXNlbGVjdGVkSW5kZXggPSB0aGlzLnRhYnMuaW5kZXgoIGZvY3VzZWRUYWIgKSwKCQkJZ29pbmdGb3J3YXJkID0gdHJ1ZTsKCgkJaWYgKCB0aGlzLl9oYW5kbGVQYWdlTmF2KCBldmVudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQljYXNlICQudWkua2V5Q29kZS5SSUdIVDoKCQkJY2FzZSAkLnVpLmtleUNvZGUuRE9XTjoKCQkJCXNlbGVjdGVkSW5kZXgrKzsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5VUDoKCQkJY2FzZSAkLnVpLmtleUNvZGUuTEVGVDoKCQkJCWdvaW5nRm9yd2FyZCA9IGZhbHNlOwoJCQkJc2VsZWN0ZWRJbmRleC0tOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC51aS5rZXlDb2RlLkVORDoKCQkJCXNlbGVjdGVkSW5kZXggPSB0aGlzLmFuY2hvcnMubGVuZ3RoIC0gMTsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5IT01FOgoJCQkJc2VsZWN0ZWRJbmRleCA9IDA7CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuU1BBQ0U6CgkJCQkvLyBBY3RpdmF0ZSBvbmx5LCBubyBjb2xsYXBzaW5nCgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJY2xlYXJUaW1lb3V0KCB0aGlzLmFjdGl2YXRpbmcgKTsKCQkJCXRoaXMuX2FjdGl2YXRlKCBzZWxlY3RlZEluZGV4ICk7CgkJCQlyZXR1cm47CgkJCWNhc2UgJC51aS5rZXlDb2RlLkVOVEVSOgoJCQkJLy8gVG9nZ2xlIChjYW5jZWwgZGVsYXllZCBhY3RpdmF0aW9uLCBhbGxvdyBjb2xsYXBzaW5nKQoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWNsZWFyVGltZW91dCggdGhpcy5hY3RpdmF0aW5nICk7CgkJCQkvLyBEZXRlcm1pbmUgaWYgd2Ugc2hvdWxkIGNvbGxhcHNlIG9yIGFjdGl2YXRlCgkJCQl0aGlzLl9hY3RpdmF0ZSggc2VsZWN0ZWRJbmRleCA9PT0gdGhpcy5vcHRpb25zLmFjdGl2ZSA/IGZhbHNlIDogc2VsZWN0ZWRJbmRleCApOwoJCQkJcmV0dXJuOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuOwoJCX0KCgkJLy8gRm9jdXMgdGhlIGFwcHJvcHJpYXRlIHRhYiwgYmFzZWQgb24gd2hpY2gga2V5IHdhcyBwcmVzc2VkCgkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQljbGVhclRpbWVvdXQoIHRoaXMuYWN0aXZhdGluZyApOwoJCXNlbGVjdGVkSW5kZXggPSB0aGlzLl9mb2N1c05leHRUYWIoIHNlbGVjdGVkSW5kZXgsIGdvaW5nRm9yd2FyZCApOwoKCQkvLyBOYXZpZ2F0aW5nIHdpdGggY29udHJvbCBrZXkgd2lsbCBwcmV2ZW50IGF1dG9tYXRpYyBhY3RpdmF0aW9uCgkJaWYgKCAhZXZlbnQuY3RybEtleSApIHsKCQkJLy8gVXBkYXRlIGFyaWEtc2VsZWN0ZWQgaW1tZWRpYXRlbHkgc28gdGhhdCBBVCB0aGluayB0aGUgdGFiIGlzIGFscmVhZHkgc2VsZWN0ZWQuCgkJCS8vIE90aGVyd2lzZSBBVCBtYXkgY29uZnVzZSB0aGUgdXNlciBieSBzdGF0aW5nIHRoYXQgdGhleSBuZWVkIHRvIGFjdGl2YXRlIHRoZSB0YWIsCgkJCS8vIGJ1dCB0aGUgdGFiIHdpbGwgYWxyZWFkeSBiZSBhY3RpdmF0ZWQgYnkgdGhlIHRpbWUgdGhlIGFubm91bmNlbWVudCBmaW5pc2hlcy4KCQkJZm9jdXNlZFRhYi5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsICJmYWxzZSIgKTsKCQkJdGhpcy50YWJzLmVxKCBzZWxlY3RlZEluZGV4ICkuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCAidHJ1ZSIgKTsKCgkJCXRoaXMuYWN0aXZhdGluZyA9IHRoaXMuX2RlbGF5KGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5vcHRpb24oICJhY3RpdmUiLCBzZWxlY3RlZEluZGV4ICk7CgkJCX0sIHRoaXMuZGVsYXkgKTsKCQl9Cgl9LAoKCV9wYW5lbEtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIHRoaXMuX2hhbmRsZVBhZ2VOYXYoIGV2ZW50ICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEN0cmwrdXAgbW92ZXMgZm9jdXMgdG8gdGhlIGN1cnJlbnQgdGFiCgkJaWYgKCBldmVudC5jdHJsS2V5ICYmIGV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5VUCApIHsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJdGhpcy5hY3RpdmUuZm9jdXMoKTsKCQl9Cgl9LAoKCS8vIEFsdCtwYWdlIHVwL2Rvd24gbW92ZXMgZm9jdXMgdG8gdGhlIHByZXZpb3VzL25leHQgdGFiIChhbmQgYWN0aXZhdGVzKQoJX2hhbmRsZVBhZ2VOYXY6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIGV2ZW50LmFsdEtleSAmJiBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuUEFHRV9VUCApIHsKCQkJdGhpcy5fYWN0aXZhdGUoIHRoaXMuX2ZvY3VzTmV4dFRhYiggdGhpcy5vcHRpb25zLmFjdGl2ZSAtIDEsIGZhbHNlICkgKTsKCQkJcmV0dXJuIHRydWU7CgkJfQoJCWlmICggZXZlbnQuYWx0S2V5ICYmIGV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5QQUdFX0RPV04gKSB7CgkJCXRoaXMuX2FjdGl2YXRlKCB0aGlzLl9mb2N1c05leHRUYWIoIHRoaXMub3B0aW9ucy5hY3RpdmUgKyAxLCB0cnVlICkgKTsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfSwKCglfZmluZE5leHRUYWI6IGZ1bmN0aW9uKCBpbmRleCwgZ29pbmdGb3J3YXJkICkgewoJCXZhciBsYXN0VGFiSW5kZXggPSB0aGlzLnRhYnMubGVuZ3RoIC0gMTsKCgkJZnVuY3Rpb24gY29uc3RyYWluKCkgewoJCQlpZiAoIGluZGV4ID4gbGFzdFRhYkluZGV4ICkgewoJCQkJaW5kZXggPSAwOwoJCQl9CgkJCWlmICggaW5kZXggPCAwICkgewoJCQkJaW5kZXggPSBsYXN0VGFiSW5kZXg7CgkJCX0KCQkJcmV0dXJuIGluZGV4OwoJCX0KCgkJd2hpbGUgKCAkLmluQXJyYXkoIGNvbnN0cmFpbigpLCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSAhPT0gLTEgKSB7CgkJCWluZGV4ID0gZ29pbmdGb3J3YXJkID8gaW5kZXggKyAxIDogaW5kZXggLSAxOwoJCX0KCgkJcmV0dXJuIGluZGV4OwoJfSwKCglfZm9jdXNOZXh0VGFiOiBmdW5jdGlvbiggaW5kZXgsIGdvaW5nRm9yd2FyZCApIHsKCQlpbmRleCA9IHRoaXMuX2ZpbmROZXh0VGFiKCBpbmRleCwgZ29pbmdGb3J3YXJkICk7CgkJdGhpcy50YWJzLmVxKCBpbmRleCApLmZvY3VzKCk7CgkJcmV0dXJuIGluZGV4OwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQlpZiAoIGtleSA9PT0gImFjdGl2ZSIgKSB7CgkJCS8vIF9hY3RpdmF0ZSgpIHdpbGwgaGFuZGxlIGludmFsaWQgdmFsdWVzIGFuZCB1cGRhdGUgdGhpcy5vcHRpb25zCgkJCXRoaXMuX2FjdGl2YXRlKCB2YWx1ZSApOwoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJLy8gZG9uJ3QgdXNlIHRoZSB3aWRnZXQgZmFjdG9yeSdzIGRpc2FibGVkIGhhbmRsaW5nCgkJCXRoaXMuX3NldHVwRGlzYWJsZWQoIHZhbHVlICk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlKTsKCgkJaWYgKCBrZXkgPT09ICJjb2xsYXBzaWJsZSIgKSB7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLXRhYnMtY29sbGFwc2libGUiLCB2YWx1ZSApOwoJCQkvLyBTZXR0aW5nIGNvbGxhcHNpYmxlOiBmYWxzZSB3aGlsZSBjb2xsYXBzZWQ7IG9wZW4gZmlyc3QgcGFuZWwKCQkJaWYgKCAhdmFsdWUgJiYgdGhpcy5vcHRpb25zLmFjdGl2ZSA9PT0gZmFsc2UgKSB7CgkJCQl0aGlzLl9hY3RpdmF0ZSggMCApOwoJCQl9CgkJfQoKCQlpZiAoIGtleSA9PT0gImV2ZW50IiApIHsKCQkJdGhpcy5fc2V0dXBFdmVudHMoIHZhbHVlICk7CgkJfQoKCQlpZiAoIGtleSA9PT0gImhlaWdodFN0eWxlIiApIHsKCQkJdGhpcy5fc2V0dXBIZWlnaHRTdHlsZSggdmFsdWUgKTsKCQl9Cgl9LAoKCV90YWJJZDogZnVuY3Rpb24oIHRhYiApIHsKCQlyZXR1cm4gdGFiLmF0dHIoICJhcmlhLWNvbnRyb2xzIiApIHx8ICJ1aS10YWJzLSIgKyBnZXROZXh0VGFiSWQoKTsKCX0sCgoJX3Nhbml0aXplU2VsZWN0b3I6IGZ1bmN0aW9uKCBoYXNoICkgewoJCXJldHVybiBoYXNoID8gaGFzaC5yZXBsYWNlKCAvWyEiJCUmJygpKissLlwvOjs8PT4/QFxbXF1cXmB7fH1+XS9nLCAiXFwkJiIgKSA6ICIiOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJbGlzID0gdGhpcy50YWJsaXN0LmNoaWxkcmVuKCAiOmhhcyhhW2hyZWZdKSIgKTsKCgkJLy8gZ2V0IGRpc2FibGVkIHRhYnMgZnJvbSBjbGFzcyBhdHRyaWJ1dGUgZnJvbSBIVE1MCgkJLy8gdGhpcyB3aWxsIGdldCBjb252ZXJ0ZWQgdG8gYSBib29sZWFuIGlmIG5lZWRlZCBpbiBfcmVmcmVzaCgpCgkJb3B0aW9ucy5kaXNhYmxlZCA9ICQubWFwKCBsaXMuZmlsdGVyKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApLCBmdW5jdGlvbiggdGFiICkgewoJCQlyZXR1cm4gbGlzLmluZGV4KCB0YWIgKTsKCQl9KTsKCgkJdGhpcy5fcHJvY2Vzc1RhYnMoKTsKCgkJLy8gd2FzIGNvbGxhcHNlZCBvciBubyB0YWJzCgkJaWYgKCBvcHRpb25zLmFjdGl2ZSA9PT0gZmFsc2UgfHwgIXRoaXMuYW5jaG9ycy5sZW5ndGggKSB7CgkJCW9wdGlvbnMuYWN0aXZlID0gZmFsc2U7CgkJCXRoaXMuYWN0aXZlID0gJCgpOwoJCS8vIHdhcyBhY3RpdmUsIGJ1dCBhY3RpdmUgdGFiIGlzIGdvbmUKCQl9IGVsc2UgaWYgKCB0aGlzLmFjdGl2ZS5sZW5ndGggJiYgISQuY29udGFpbnMoIHRoaXMudGFibGlzdFsgMCBdLCB0aGlzLmFjdGl2ZVsgMCBdICkgKSB7CgkJCS8vIGFsbCByZW1haW5pbmcgdGFicyBhcmUgZGlzYWJsZWQKCQkJaWYgKCB0aGlzLnRhYnMubGVuZ3RoID09PSBvcHRpb25zLmRpc2FibGVkLmxlbmd0aCApIHsKCQkJCW9wdGlvbnMuYWN0aXZlID0gZmFsc2U7CgkJCQl0aGlzLmFjdGl2ZSA9ICQoKTsKCQkJLy8gYWN0aXZhdGUgcHJldmlvdXMgdGFiCgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9hY3RpdmF0ZSggdGhpcy5fZmluZE5leHRUYWIoIE1hdGgubWF4KCAwLCBvcHRpb25zLmFjdGl2ZSAtIDEgKSwgZmFsc2UgKSApOwoJCQl9CgkJLy8gd2FzIGFjdGl2ZSwgYWN0aXZlIHRhYiBzdGlsbCBleGlzdHMKCQl9IGVsc2UgewoJCQkvLyBtYWtlIHN1cmUgYWN0aXZlIGluZGV4IGlzIGNvcnJlY3QKCQkJb3B0aW9ucy5hY3RpdmUgPSB0aGlzLnRhYnMuaW5kZXgoIHRoaXMuYWN0aXZlICk7CgkJfQoKCQl0aGlzLl9yZWZyZXNoKCk7Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXR1cERpc2FibGVkKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKTsKCQl0aGlzLl9zZXR1cEV2ZW50cyggdGhpcy5vcHRpb25zLmV2ZW50ICk7CgkJdGhpcy5fc2V0dXBIZWlnaHRTdHlsZSggdGhpcy5vcHRpb25zLmhlaWdodFN0eWxlICk7CgoJCXRoaXMudGFicy5ub3QoIHRoaXMuYWN0aXZlICkuYXR0cih7CgkJCSJhcmlhLXNlbGVjdGVkIjogImZhbHNlIiwKCQkJdGFiSW5kZXg6IC0xCgkJfSk7CgkJdGhpcy5wYW5lbHMubm90KCB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGhpcy5hY3RpdmUgKSApCgkJCS5oaWRlKCkKCQkJLmF0dHIoewoJCQkJImFyaWEtZXhwYW5kZWQiOiAiZmFsc2UiLAoJCQkJImFyaWEtaGlkZGVuIjogInRydWUiCgkJCX0pOwoKCQkvLyBNYWtlIHN1cmUgb25lIHRhYiBpcyBpbiB0aGUgdGFiIG9yZGVyCgkJaWYgKCAhdGhpcy5hY3RpdmUubGVuZ3RoICkgewoJCQl0aGlzLnRhYnMuZXEoIDAgKS5hdHRyKCAidGFiSW5kZXgiLCAwICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5hY3RpdmUKCQkJCS5hZGRDbGFzcyggInVpLXRhYnMtYWN0aXZlIHVpLXN0YXRlLWFjdGl2ZSIgKQoJCQkJLmF0dHIoewoJCQkJCSJhcmlhLXNlbGVjdGVkIjogInRydWUiLAoJCQkJCXRhYkluZGV4OiAwCgkJCQl9KTsKCQkJdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIHRoaXMuYWN0aXZlICkKCQkJCS5zaG93KCkKCQkJCS5hdHRyKHsKCQkJCQkiYXJpYS1leHBhbmRlZCI6ICJ0cnVlIiwKCQkJCQkiYXJpYS1oaWRkZW4iOiAiZmFsc2UiCgkJCQl9KTsKCQl9Cgl9LAoKCV9wcm9jZXNzVGFiczogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzOwoKCQl0aGlzLnRhYmxpc3QgPSB0aGlzLl9nZXRMaXN0KCkKCQkJLmFkZENsYXNzKCAidWktdGFicy1uYXYgdWktaGVscGVyLXJlc2V0IHVpLWhlbHBlci1jbGVhcmZpeCB1aS13aWRnZXQtaGVhZGVyIHVpLWNvcm5lci1hbGwiICkKCQkJLmF0dHIoICJyb2xlIiwgInRhYmxpc3QiICk7CgoJCXRoaXMudGFicyA9IHRoaXMudGFibGlzdC5maW5kKCAiPiBsaTpoYXMoYVtocmVmXSkiICkKCQkJLmFkZENsYXNzKCAidWktc3RhdGUtZGVmYXVsdCB1aS1jb3JuZXItdG9wIiApCgkJCS5hdHRyKHsKCQkJCXJvbGU6ICJ0YWIiLAoJCQkJdGFiSW5kZXg6IC0xCgkJCX0pOwoKCQl0aGlzLmFuY2hvcnMgPSB0aGlzLnRhYnMubWFwKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICQoICJhIiwgdGhpcyApWyAwIF07CgkJCX0pCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtYW5jaG9yIiApCgkJCS5hdHRyKHsKCQkJCXJvbGU6ICJwcmVzZW50YXRpb24iLAoJCQkJdGFiSW5kZXg6IC0xCgkJCX0pOwoKCQl0aGlzLnBhbmVscyA9ICQoKTsKCgkJdGhpcy5hbmNob3JzLmVhY2goZnVuY3Rpb24oIGksIGFuY2hvciApIHsKCQkJdmFyIHNlbGVjdG9yLCBwYW5lbCwgcGFuZWxJZCwKCQkJCWFuY2hvcklkID0gJCggYW5jaG9yICkudW5pcXVlSWQoKS5hdHRyKCAiaWQiICksCgkJCQl0YWIgPSAkKCBhbmNob3IgKS5jbG9zZXN0KCAibGkiICksCgkJCQlvcmlnaW5hbEFyaWFDb250cm9scyA9IHRhYi5hdHRyKCAiYXJpYS1jb250cm9scyIgKTsKCgkJCS8vIGlubGluZSB0YWIKCQkJaWYgKCBpc0xvY2FsKCBhbmNob3IgKSApIHsKCQkJCXNlbGVjdG9yID0gYW5jaG9yLmhhc2g7CgkJCQlwYW5lbCA9IHRoYXQuZWxlbWVudC5maW5kKCB0aGF0Ll9zYW5pdGl6ZVNlbGVjdG9yKCBzZWxlY3RvciApICk7CgkJCS8vIHJlbW90ZSB0YWIKCQkJfSBlbHNlIHsKCQkJCXBhbmVsSWQgPSB0aGF0Ll90YWJJZCggdGFiICk7CgkJCQlzZWxlY3RvciA9ICIjIiArIHBhbmVsSWQ7CgkJCQlwYW5lbCA9IHRoYXQuZWxlbWVudC5maW5kKCBzZWxlY3RvciApOwoJCQkJaWYgKCAhcGFuZWwubGVuZ3RoICkgewoJCQkJCXBhbmVsID0gdGhhdC5fY3JlYXRlUGFuZWwoIHBhbmVsSWQgKTsKCQkJCQlwYW5lbC5pbnNlcnRBZnRlciggdGhhdC5wYW5lbHNbIGkgLSAxIF0gfHwgdGhhdC50YWJsaXN0ICk7CgkJCQl9CgkJCQlwYW5lbC5hdHRyKCAiYXJpYS1saXZlIiwgInBvbGl0ZSIgKTsKCQkJfQoKCQkJaWYgKCBwYW5lbC5sZW5ndGgpIHsKCQkJCXRoYXQucGFuZWxzID0gdGhhdC5wYW5lbHMuYWRkKCBwYW5lbCApOwoJCQl9CgkJCWlmICggb3JpZ2luYWxBcmlhQ29udHJvbHMgKSB7CgkJCQl0YWIuZGF0YSggInVpLXRhYnMtYXJpYS1jb250cm9scyIsIG9yaWdpbmFsQXJpYUNvbnRyb2xzICk7CgkJCX0KCQkJdGFiLmF0dHIoewoJCQkJImFyaWEtY29udHJvbHMiOiBzZWxlY3Rvci5zdWJzdHJpbmcoIDEgKSwKCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBhbmNob3JJZAoJCQl9KTsKCQkJcGFuZWwuYXR0ciggImFyaWEtbGFiZWxsZWRieSIsIGFuY2hvcklkICk7CgkJfSk7CgoJCXRoaXMucGFuZWxzCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtcGFuZWwgdWktd2lkZ2V0LWNvbnRlbnQgdWktY29ybmVyLWJvdHRvbSIgKQoJCQkuYXR0ciggInJvbGUiLCAidGFicGFuZWwiICk7Cgl9LAoKCS8vIGFsbG93IG92ZXJyaWRpbmcgaG93IHRvIGZpbmQgdGhlIGxpc3QgZm9yIHJhcmUgdXNhZ2Ugc2NlbmFyaW9zICgjNzcxNSkKCV9nZXRMaXN0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lbGVtZW50LmZpbmQoICJvbCx1bCIgKS5lcSggMCApOwoJfSwKCglfY3JlYXRlUGFuZWw6IGZ1bmN0aW9uKCBpZCApIHsKCQlyZXR1cm4gJCggIjxkaXY+IiApCgkJCS5hdHRyKCAiaWQiLCBpZCApCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtcGFuZWwgdWktd2lkZ2V0LWNvbnRlbnQgdWktY29ybmVyLWJvdHRvbSIgKQoJCQkuZGF0YSggInVpLXRhYnMtZGVzdHJveSIsIHRydWUgKTsKCX0sCgoJX3NldHVwRGlzYWJsZWQ6IGZ1bmN0aW9uKCBkaXNhYmxlZCApIHsKCQlpZiAoICQuaXNBcnJheSggZGlzYWJsZWQgKSApIHsKCQkJaWYgKCAhZGlzYWJsZWQubGVuZ3RoICkgewoJCQkJZGlzYWJsZWQgPSBmYWxzZTsKCQkJfSBlbHNlIGlmICggZGlzYWJsZWQubGVuZ3RoID09PSB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQkJZGlzYWJsZWQgPSB0cnVlOwoJCQl9CgkJfQoKCQkvLyBkaXNhYmxlIHRhYnMKCQlmb3IgKCB2YXIgaSA9IDAsIGxpOyAoIGxpID0gdGhpcy50YWJzWyBpIF0gKTsgaSsrICkgewoJCQlpZiAoIGRpc2FibGVkID09PSB0cnVlIHx8ICQuaW5BcnJheSggaSwgZGlzYWJsZWQgKSAhPT0gLTEgKSB7CgkJCQkkKCBsaSApCgkJCQkJLmFkZENsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkKCQkJCQkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCAidHJ1ZSIgKTsKCQkJfSBlbHNlIHsKCQkJCSQoIGxpICkKCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1kaXNhYmxlZCIgKTsKCQkJfQoJCX0KCgkJdGhpcy5vcHRpb25zLmRpc2FibGVkID0gZGlzYWJsZWQ7Cgl9LAoKCV9zZXR1cEV2ZW50czogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBldmVudHMgPSB7CgkJCWNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJfTsKCQlpZiAoIGV2ZW50ICkgewoJCQkkLmVhY2goIGV2ZW50LnNwbGl0KCIgIiksIGZ1bmN0aW9uKCBpbmRleCwgZXZlbnROYW1lICkgewoJCQkJZXZlbnRzWyBldmVudE5hbWUgXSA9ICJfZXZlbnRIYW5kbGVyIjsKCQkJfSk7CgkJfQoKCQl0aGlzLl9vZmYoIHRoaXMuYW5jaG9ycy5hZGQoIHRoaXMudGFicyApLmFkZCggdGhpcy5wYW5lbHMgKSApOwoJCXRoaXMuX29uKCB0aGlzLmFuY2hvcnMsIGV2ZW50cyApOwoJCXRoaXMuX29uKCB0aGlzLnRhYnMsIHsga2V5ZG93bjogIl90YWJLZXlkb3duIiB9ICk7CgkJdGhpcy5fb24oIHRoaXMucGFuZWxzLCB7IGtleWRvd246ICJfcGFuZWxLZXlkb3duIiB9ICk7CgoJCXRoaXMuX2ZvY3VzYWJsZSggdGhpcy50YWJzICk7CgkJdGhpcy5faG92ZXJhYmxlKCB0aGlzLnRhYnMgKTsKCX0sCgoJX3NldHVwSGVpZ2h0U3R5bGU6IGZ1bmN0aW9uKCBoZWlnaHRTdHlsZSApIHsKCQl2YXIgbWF4SGVpZ2h0LAoJCQlwYXJlbnQgPSB0aGlzLmVsZW1lbnQucGFyZW50KCk7CgoJCWlmICggaGVpZ2h0U3R5bGUgPT09ICJmaWxsIiApIHsKCQkJbWF4SGVpZ2h0ID0gcGFyZW50LmhlaWdodCgpOwoJCQltYXhIZWlnaHQgLT0gdGhpcy5lbGVtZW50Lm91dGVySGVpZ2h0KCkgLSB0aGlzLmVsZW1lbnQuaGVpZ2h0KCk7CgoJCQl0aGlzLmVsZW1lbnQuc2libGluZ3MoICI6dmlzaWJsZSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGVsZW0gPSAkKCB0aGlzICksCgkJCQkJcG9zaXRpb24gPSBlbGVtLmNzcyggInBvc2l0aW9uIiApOwoKCQkJCWlmICggcG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgfHwgcG9zaXRpb24gPT09ICJmaXhlZCIgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJbWF4SGVpZ2h0IC09IGVsZW0ub3V0ZXJIZWlnaHQoIHRydWUgKTsKCQkJfSk7CgoJCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oKS5ub3QoIHRoaXMucGFuZWxzICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCW1heEhlaWdodCAtPSAkKCB0aGlzICkub3V0ZXJIZWlnaHQoIHRydWUgKTsKCQkJfSk7CgoJCQl0aGlzLnBhbmVscy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmhlaWdodCggTWF0aC5tYXgoIDAsIG1heEhlaWdodCAtCgkJCQkJJCggdGhpcyApLmlubmVySGVpZ2h0KCkgKyAkKCB0aGlzICkuaGVpZ2h0KCkgKSApOwoJCQl9KQoJCQkuY3NzKCAib3ZlcmZsb3ciLCAiYXV0byIgKTsKCQl9IGVsc2UgaWYgKCBoZWlnaHRTdHlsZSA9PT0gImF1dG8iICkgewoJCQltYXhIZWlnaHQgPSAwOwoJCQl0aGlzLnBhbmVscy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJbWF4SGVpZ2h0ID0gTWF0aC5tYXgoIG1heEhlaWdodCwgJCggdGhpcyApLmhlaWdodCggIiIgKS5oZWlnaHQoKSApOwoJCQl9KS5oZWlnaHQoIG1heEhlaWdodCApOwoJCX0KCX0sCgoJX2V2ZW50SGFuZGxlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlhY3RpdmUgPSB0aGlzLmFjdGl2ZSwKCQkJYW5jaG9yID0gJCggZXZlbnQuY3VycmVudFRhcmdldCApLAoJCQl0YWIgPSBhbmNob3IuY2xvc2VzdCggImxpIiApLAoJCQljbGlja2VkSXNBY3RpdmUgPSB0YWJbIDAgXSA9PT0gYWN0aXZlWyAwIF0sCgkJCWNvbGxhcHNpbmcgPSBjbGlja2VkSXNBY3RpdmUgJiYgb3B0aW9ucy5jb2xsYXBzaWJsZSwKCQkJdG9TaG93ID0gY29sbGFwc2luZyA/ICQoKSA6IHRoaXMuX2dldFBhbmVsRm9yVGFiKCB0YWIgKSwKCQkJdG9IaWRlID0gIWFjdGl2ZS5sZW5ndGggPyAkKCkgOiB0aGlzLl9nZXRQYW5lbEZvclRhYiggYWN0aXZlICksCgkJCWV2ZW50RGF0YSA9IHsKCQkJCW9sZFRhYjogYWN0aXZlLAoJCQkJb2xkUGFuZWw6IHRvSGlkZSwKCQkJCW5ld1RhYjogY29sbGFwc2luZyA/ICQoKSA6IHRhYiwKCQkJCW5ld1BhbmVsOiB0b1Nob3cKCQkJfTsKCgkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJaWYgKCB0YWIuaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKSB8fAoJCQkJLy8gdGFiIGlzIGFscmVhZHkgbG9hZGluZwoJCQkJdGFiLmhhc0NsYXNzKCAidWktdGFicy1sb2FkaW5nIiApIHx8CgkJCQkvLyBjYW4ndCBzd2l0Y2ggZHVybmluZyBhbiBhbmltYXRpb24KCQkJCXRoaXMucnVubmluZyB8fAoJCQkJLy8gY2xpY2sgb24gYWN0aXZlIGhlYWRlciwgYnV0IG5vdCBjb2xsYXBzaWJsZQoJCQkJKCBjbGlja2VkSXNBY3RpdmUgJiYgIW9wdGlvbnMuY29sbGFwc2libGUgKSB8fAoJCQkJLy8gYWxsb3cgY2FuY2VsaW5nIGFjdGl2YXRpb24KCQkJCSggdGhpcy5fdHJpZ2dlciggImJlZm9yZUFjdGl2YXRlIiwgZXZlbnQsIGV2ZW50RGF0YSApID09PSBmYWxzZSApICkgewoJCQlyZXR1cm47CgkJfQoKCQlvcHRpb25zLmFjdGl2ZSA9IGNvbGxhcHNpbmcgPyBmYWxzZSA6IHRoaXMudGFicy5pbmRleCggdGFiICk7CgoJCXRoaXMuYWN0aXZlID0gY2xpY2tlZElzQWN0aXZlID8gJCgpIDogdGFiOwoJCWlmICggdGhpcy54aHIgKSB7CgkJCXRoaXMueGhyLmFib3J0KCk7CgkJfQoKCQlpZiAoICF0b0hpZGUubGVuZ3RoICYmICF0b1Nob3cubGVuZ3RoICkgewoJCQkkLmVycm9yKCAialF1ZXJ5IFVJIFRhYnM6IE1pc21hdGNoaW5nIGZyYWdtZW50IGlkZW50aWZpZXIuIiApOwoJCX0KCgkJaWYgKCB0b1Nob3cubGVuZ3RoICkgewoJCQl0aGlzLmxvYWQoIHRoaXMudGFicy5pbmRleCggdGFiICksIGV2ZW50ICk7CgkJfQoJCXRoaXMuX3RvZ2dsZSggZXZlbnQsIGV2ZW50RGF0YSApOwoJfSwKCgkvLyBoYW5kbGVzIHNob3cvaGlkZSBmb3Igc2VsZWN0aW5nIHRhYnMKCV90b2dnbGU6IGZ1bmN0aW9uKCBldmVudCwgZXZlbnREYXRhICkgewoJCXZhciB0aGF0ID0gdGhpcywKCQkJdG9TaG93ID0gZXZlbnREYXRhLm5ld1BhbmVsLAoJCQl0b0hpZGUgPSBldmVudERhdGEub2xkUGFuZWw7CgoJCXRoaXMucnVubmluZyA9IHRydWU7CgoJCWZ1bmN0aW9uIGNvbXBsZXRlKCkgewoJCQl0aGF0LnJ1bm5pbmcgPSBmYWxzZTsKCQkJdGhhdC5fdHJpZ2dlciggImFjdGl2YXRlIiwgZXZlbnQsIGV2ZW50RGF0YSApOwoJCX0KCgkJZnVuY3Rpb24gc2hvdygpIHsKCQkJZXZlbnREYXRhLm5ld1RhYi5jbG9zZXN0KCAibGkiICkuYWRkQ2xhc3MoICJ1aS10YWJzLWFjdGl2ZSB1aS1zdGF0ZS1hY3RpdmUiICk7CgoJCQlpZiAoIHRvU2hvdy5sZW5ndGggJiYgdGhhdC5vcHRpb25zLnNob3cgKSB7CgkJCQl0aGF0Ll9zaG93KCB0b1Nob3csIHRoYXQub3B0aW9ucy5zaG93LCBjb21wbGV0ZSApOwoJCQl9IGVsc2UgewoJCQkJdG9TaG93LnNob3coKTsKCQkJCWNvbXBsZXRlKCk7CgkJCX0KCQl9CgoJCS8vIHN0YXJ0IG91dCBieSBoaWRpbmcsIHRoZW4gc2hvd2luZywgdGhlbiBjb21wbGV0aW5nCgkJaWYgKCB0b0hpZGUubGVuZ3RoICYmIHRoaXMub3B0aW9ucy5oaWRlICkgewoJCQl0aGlzLl9oaWRlKCB0b0hpZGUsIHRoaXMub3B0aW9ucy5oaWRlLCBmdW5jdGlvbigpIHsKCQkJCWV2ZW50RGF0YS5vbGRUYWIuY2xvc2VzdCggImxpIiApLnJlbW92ZUNsYXNzKCAidWktdGFicy1hY3RpdmUgdWktc3RhdGUtYWN0aXZlIiApOwoJCQkJc2hvdygpOwoJCQl9KTsKCQl9IGVsc2UgewoJCQlldmVudERhdGEub2xkVGFiLmNsb3Nlc3QoICJsaSIgKS5yZW1vdmVDbGFzcyggInVpLXRhYnMtYWN0aXZlIHVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJdG9IaWRlLmhpZGUoKTsKCQkJc2hvdygpOwoJCX0KCgkJdG9IaWRlLmF0dHIoewoJCQkiYXJpYS1leHBhbmRlZCI6ICJmYWxzZSIsCgkJCSJhcmlhLWhpZGRlbiI6ICJ0cnVlIgoJCX0pOwoJCWV2ZW50RGF0YS5vbGRUYWIuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCAiZmFsc2UiICk7CgkJLy8gSWYgd2UncmUgc3dpdGNoaW5nIHRhYnMsIHJlbW92ZSB0aGUgb2xkIHRhYiBmcm9tIHRoZSB0YWIgb3JkZXIuCgkJLy8gSWYgd2UncmUgb3BlbmluZyBmcm9tIGNvbGxhcHNlZCBzdGF0ZSwgcmVtb3ZlIHRoZSBwcmV2aW91cyB0YWIgZnJvbSB0aGUgdGFiIG9yZGVyLgoJCS8vIElmIHdlJ3JlIGNvbGxhcHNpbmcsIHRoZW4ga2VlcCB0aGUgY29sbGFwc2luZyB0YWIgaW4gdGhlIHRhYiBvcmRlci4KCQlpZiAoIHRvU2hvdy5sZW5ndGggJiYgdG9IaWRlLmxlbmd0aCApIHsKCQkJZXZlbnREYXRhLm9sZFRhYi5hdHRyKCAidGFiSW5kZXgiLCAtMSApOwoJCX0gZWxzZSBpZiAoIHRvU2hvdy5sZW5ndGggKSB7CgkJCXRoaXMudGFicy5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gJCggdGhpcyApLmF0dHIoICJ0YWJJbmRleCIgKSA9PT0gMDsKCQkJfSkKCQkJLmF0dHIoICJ0YWJJbmRleCIsIC0xICk7CgkJfQoKCQl0b1Nob3cuYXR0cih7CgkJCSJhcmlhLWV4cGFuZGVkIjogInRydWUiLAoJCQkiYXJpYS1oaWRkZW4iOiAiZmFsc2UiCgkJfSk7CgkJZXZlbnREYXRhLm5ld1RhYi5hdHRyKHsKCQkJImFyaWEtc2VsZWN0ZWQiOiAidHJ1ZSIsCgkJCXRhYkluZGV4OiAwCgkJfSk7Cgl9LAoKCV9hY3RpdmF0ZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXZhciBhbmNob3IsCgkJCWFjdGl2ZSA9IHRoaXMuX2ZpbmRBY3RpdmUoIGluZGV4ICk7CgoJCS8vIHRyeWluZyB0byBhY3RpdmF0ZSB0aGUgYWxyZWFkeSBhY3RpdmUgcGFuZWwKCQlpZiAoIGFjdGl2ZVsgMCBdID09PSB0aGlzLmFjdGl2ZVsgMCBdICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyB0cnlpbmcgdG8gY29sbGFwc2UsIHNpbXVsYXRlIGEgY2xpY2sgb24gdGhlIGN1cnJlbnQgYWN0aXZlIGhlYWRlcgoJCWlmICggIWFjdGl2ZS5sZW5ndGggKSB7CgkJCWFjdGl2ZSA9IHRoaXMuYWN0aXZlOwoJCX0KCgkJYW5jaG9yID0gYWN0aXZlLmZpbmQoICIudWktdGFicy1hbmNob3IiIClbIDAgXTsKCQl0aGlzLl9ldmVudEhhbmRsZXIoewoJCQl0YXJnZXQ6IGFuY2hvciwKCQkJY3VycmVudFRhcmdldDogYW5jaG9yLAoJCQlwcmV2ZW50RGVmYXVsdDogJC5ub29wCgkJfSk7Cgl9LAoKCV9maW5kQWN0aXZlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJcmV0dXJuIGluZGV4ID09PSBmYWxzZSA/ICQoKSA6IHRoaXMudGFicy5lcSggaW5kZXggKTsKCX0sCgoJX2dldEluZGV4OiBmdW5jdGlvbiggaW5kZXggKSB7CgkJLy8gbWV0YS1mdW5jdGlvbiB0byBnaXZlIHVzZXJzIG9wdGlvbiB0byBwcm92aWRlIGEgaHJlZiBzdHJpbmcgaW5zdGVhZCBvZiBhIG51bWVyaWNhbCBpbmRleC4KCQlpZiAoIHR5cGVvZiBpbmRleCA9PT0gInN0cmluZyIgKSB7CgkJCWluZGV4ID0gdGhpcy5hbmNob3JzLmluZGV4KCB0aGlzLmFuY2hvcnMuZmlsdGVyKCAiW2hyZWYkPSciICsgaW5kZXggKyAiJ10iICkgKTsKCQl9CgoJCXJldHVybiBpbmRleDsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy54aHIgKSB7CgkJCXRoaXMueGhyLmFib3J0KCk7CgkJfQoKCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS10YWJzIHVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCB1aS1jb3JuZXItYWxsIHVpLXRhYnMtY29sbGFwc2libGUiICk7CgoJCXRoaXMudGFibGlzdAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS10YWJzLW5hdiB1aS1oZWxwZXItcmVzZXQgdWktaGVscGVyLWNsZWFyZml4IHVpLXdpZGdldC1oZWFkZXIgdWktY29ybmVyLWFsbCIgKQoJCQkucmVtb3ZlQXR0ciggInJvbGUiICk7CgoJCXRoaXMuYW5jaG9ycwoJCQkucmVtb3ZlQ2xhc3MoICJ1aS10YWJzLWFuY2hvciIgKQoJCQkucmVtb3ZlQXR0ciggInJvbGUiICkKCQkJLnJlbW92ZUF0dHIoICJ0YWJJbmRleCIgKQoJCQkucmVtb3ZlVW5pcXVlSWQoKTsKCgkJdGhpcy50YWJzLmFkZCggdGhpcy5wYW5lbHMgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoICQuZGF0YSggdGhpcywgInVpLXRhYnMtZGVzdHJveSIgKSApIHsKCQkJCSQoIHRoaXMgKS5yZW1vdmUoKTsKCQkJfSBlbHNlIHsKCQkJCSQoIHRoaXMgKQoJCQkJCS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWRlZmF1bHQgdWktc3RhdGUtYWN0aXZlIHVpLXN0YXRlLWRpc2FibGVkICIgKwoJCQkJCQkidWktY29ybmVyLXRvcCB1aS1jb3JuZXItYm90dG9tIHVpLXdpZGdldC1jb250ZW50IHVpLXRhYnMtYWN0aXZlIHVpLXRhYnMtcGFuZWwiICkKCQkJCQkucmVtb3ZlQXR0ciggInRhYkluZGV4IiApCgkJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWxpdmUiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtYnVzeSIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1zZWxlY3RlZCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1sYWJlbGxlZGJ5IiApCgkJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWhpZGRlbiIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1leHBhbmRlZCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAicm9sZSIgKTsKCQkJfQoJCX0pOwoKCQl0aGlzLnRhYnMuZWFjaChmdW5jdGlvbigpIHsKCQkJdmFyIGxpID0gJCggdGhpcyApLAoJCQkJcHJldiA9IGxpLmRhdGEoICJ1aS10YWJzLWFyaWEtY29udHJvbHMiICk7CgkJCWlmICggcHJldiApIHsKCQkJCWxpCgkJCQkJLmF0dHIoICJhcmlhLWNvbnRyb2xzIiwgcHJldiApCgkJCQkJLnJlbW92ZURhdGEoICJ1aS10YWJzLWFyaWEtY29udHJvbHMiICk7CgkJCX0gZWxzZSB7CgkJCQlsaS5yZW1vdmVBdHRyKCAiYXJpYS1jb250cm9scyIgKTsKCQkJfQoJCX0pOwoKCQl0aGlzLnBhbmVscy5zaG93KCk7CgoJCWlmICggdGhpcy5vcHRpb25zLmhlaWdodFN0eWxlICE9PSAiY29udGVudCIgKSB7CgkJCXRoaXMucGFuZWxzLmNzcyggImhlaWdodCIsICIiICk7CgkJfQoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQl2YXIgZGlzYWJsZWQgPSB0aGlzLm9wdGlvbnMuZGlzYWJsZWQ7CgkJaWYgKCBkaXNhYmxlZCA9PT0gZmFsc2UgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggaW5kZXggPT09IHVuZGVmaW5lZCApIHsKCQkJZGlzYWJsZWQgPSBmYWxzZTsKCQl9IGVsc2UgewoJCQlpbmRleCA9IHRoaXMuX2dldEluZGV4KCBpbmRleCApOwoJCQlpZiAoICQuaXNBcnJheSggZGlzYWJsZWQgKSApIHsKCQkJCWRpc2FibGVkID0gJC5tYXAoIGRpc2FibGVkLCBmdW5jdGlvbiggbnVtICkgewoJCQkJCXJldHVybiBudW0gIT09IGluZGV4ID8gbnVtIDogbnVsbDsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJZGlzYWJsZWQgPSAkLm1hcCggdGhpcy50YWJzLCBmdW5jdGlvbiggbGksIG51bSApIHsKCQkJCQlyZXR1cm4gbnVtICE9PSBpbmRleCA/IG51bSA6IG51bGw7CgkJCQl9KTsKCQkJfQoJCX0KCQl0aGlzLl9zZXR1cERpc2FibGVkKCBkaXNhYmxlZCApOwoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJdmFyIGRpc2FibGVkID0gdGhpcy5vcHRpb25zLmRpc2FibGVkOwoJCWlmICggZGlzYWJsZWQgPT09IHRydWUgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggaW5kZXggPT09IHVuZGVmaW5lZCApIHsKCQkJZGlzYWJsZWQgPSB0cnVlOwoJCX0gZWxzZSB7CgkJCWluZGV4ID0gdGhpcy5fZ2V0SW5kZXgoIGluZGV4ICk7CgkJCWlmICggJC5pbkFycmF5KCBpbmRleCwgZGlzYWJsZWQgKSAhPT0gLTEgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCAkLmlzQXJyYXkoIGRpc2FibGVkICkgKSB7CgkJCQlkaXNhYmxlZCA9ICQubWVyZ2UoIFsgaW5kZXggXSwgZGlzYWJsZWQgKS5zb3J0KCk7CgkJCX0gZWxzZSB7CgkJCQlkaXNhYmxlZCA9IFsgaW5kZXggXTsKCQkJfQoJCX0KCQl0aGlzLl9zZXR1cERpc2FibGVkKCBkaXNhYmxlZCApOwoJfSwKCglsb2FkOiBmdW5jdGlvbiggaW5kZXgsIGV2ZW50ICkgewoJCWluZGV4ID0gdGhpcy5fZ2V0SW5kZXgoIGluZGV4ICk7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQl0YWIgPSB0aGlzLnRhYnMuZXEoIGluZGV4ICksCgkJCWFuY2hvciA9IHRhYi5maW5kKCAiLnVpLXRhYnMtYW5jaG9yIiApLAoJCQlwYW5lbCA9IHRoaXMuX2dldFBhbmVsRm9yVGFiKCB0YWIgKSwKCQkJZXZlbnREYXRhID0gewoJCQkJdGFiOiB0YWIsCgkJCQlwYW5lbDogcGFuZWwKCQkJfTsKCgkJLy8gbm90IHJlbW90ZQoJCWlmICggaXNMb2NhbCggYW5jaG9yWyAwIF0gKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy54aHIgPSAkLmFqYXgoIHRoaXMuX2FqYXhTZXR0aW5ncyggYW5jaG9yLCBldmVudCwgZXZlbnREYXRhICkgKTsKCgkJLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKCQkvLyBqUXVlcnkgPDEuOCByZXR1cm5zIGZhbHNlIGlmIHRoZSByZXF1ZXN0IGlzIGNhbmNlbGVkIGluIGJlZm9yZVNlbmQsCgkJLy8gYnV0IGFzIG9mIDEuOCwgJC5hamF4KCkgYWx3YXlzIHJldHVybnMgYSBqcVhIUiBvYmplY3QuCgkJaWYgKCB0aGlzLnhociAmJiB0aGlzLnhoci5zdGF0dXNUZXh0ICE9PSAiY2FuY2VsZWQiICkgewoJCQl0YWIuYWRkQ2xhc3MoICJ1aS10YWJzLWxvYWRpbmciICk7CgkJCXBhbmVsLmF0dHIoICJhcmlhLWJ1c3kiLCAidHJ1ZSIgKTsKCgkJCXRoaXMueGhyCgkJCQkuc3VjY2VzcyhmdW5jdGlvbiggcmVzcG9uc2UgKSB7CgkJCQkJLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKCQkJCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMTc3OAoJCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJCXBhbmVsLmh0bWwoIHJlc3BvbnNlICk7CgkJCQkJCXRoYXQuX3RyaWdnZXIoICJsb2FkIiwgZXZlbnQsIGV2ZW50RGF0YSApOwoJCQkJCX0sIDEgKTsKCQkJCX0pCgkJCQkuY29tcGxldGUoZnVuY3Rpb24oIGpxWEhSLCBzdGF0dXMgKSB7CgkJCQkJLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKCQkJCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMTc3OAoJCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJCWlmICggc3RhdHVzID09PSAiYWJvcnQiICkgewoJCQkJCQkJdGhhdC5wYW5lbHMuc3RvcCggZmFsc2UsIHRydWUgKTsKCQkJCQkJfQoKCQkJCQkJdGFiLnJlbW92ZUNsYXNzKCAidWktdGFicy1sb2FkaW5nIiApOwoJCQkJCQlwYW5lbC5yZW1vdmVBdHRyKCAiYXJpYS1idXN5IiApOwoKCQkJCQkJaWYgKCBqcVhIUiA9PT0gdGhhdC54aHIgKSB7CgkJCQkJCQlkZWxldGUgdGhhdC54aHI7CgkJCQkJCX0KCQkJCQl9LCAxICk7CgkJCQl9KTsKCQl9Cgl9LAoKCV9hamF4U2V0dGluZ3M6IGZ1bmN0aW9uKCBhbmNob3IsIGV2ZW50LCBldmVudERhdGEgKSB7CgkJdmFyIHRoYXQgPSB0aGlzOwoJCXJldHVybiB7CgkJCXVybDogYW5jaG9yLmF0dHIoICJocmVmIiApLAoJCQliZWZvcmVTZW5kOiBmdW5jdGlvbigganFYSFIsIHNldHRpbmdzICkgewoJCQkJcmV0dXJuIHRoYXQuX3RyaWdnZXIoICJiZWZvcmVMb2FkIiwgZXZlbnQsCgkJCQkJJC5leHRlbmQoIHsganFYSFIgOiBqcVhIUiwgYWpheFNldHRpbmdzOiBzZXR0aW5ncyB9LCBldmVudERhdGEgKSApOwoJCQl9CgkJfTsKCX0sCgoJX2dldFBhbmVsRm9yVGFiOiBmdW5jdGlvbiggdGFiICkgewoJCXZhciBpZCA9ICQoIHRhYiApLmF0dHIoICJhcmlhLWNvbnRyb2xzIiApOwoJCXJldHVybiB0aGlzLmVsZW1lbnQuZmluZCggdGhpcy5fc2FuaXRpemVTZWxlY3RvciggIiMiICsgaWQgKSApOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdyApIHsKCgkkLm1vYmlsZS5pb3NvcmllbnRhdGlvbmZpeEVuYWJsZWQgPSB0cnVlOwoKCS8vIFRoaXMgZml4IGFkZHJlc3NlcyBhbiBpT1MgYnVnLCBzbyByZXR1cm4gZWFybHkgaWYgdGhlIFVBIGNsYWltcyBpdCdzIHNvbWV0aGluZyBlbHNlLgoJdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQl6b29tLAoJCWV2dCwgeCwgeSwgeiwgYWlnOwoJaWYgKCAhKCAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgL09TIFsxLTVdX1swLTlfXSogbGlrZSBNYWMgT1MgWC9pLnRlc3QoIHVhICkgJiYgdWEuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEgKSApewoJCSQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCA9IGZhbHNlOwoJCXJldHVybjsKCX0KCgl6b29tID0gJC5tb2JpbGUuem9vbTsKCglmdW5jdGlvbiBjaGVja1RpbHQoIGUgKSB7CgkJZXZ0ID0gZS5vcmlnaW5hbEV2ZW50OwoJCWFpZyA9IGV2dC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5OwoKCQl4ID0gTWF0aC5hYnMoIGFpZy54ICk7CgkJeSA9IE1hdGguYWJzKCBhaWcueSApOwoJCXogPSBNYXRoLmFicyggYWlnLnogKTsKCgkJLy8gSWYgcG9ydHJhaXQgb3JpZW50YXRpb24gYW5kIGluIG9uZSBvZiB0aGUgZGFuZ2VyIHpvbmVzCgkJaWYgKCAhd2luZG93Lm9yaWVudGF0aW9uICYmICggeCA+IDcgfHwgKCAoIHogPiA2ICYmIHkgPCA4IHx8IHogPCA4ICYmIHkgPiA2ICkgJiYgeCA+IDUgKSApICkgewoJCQkJaWYgKCB6b29tLmVuYWJsZWQgKSB7CgkJCQkJem9vbS5kaXNhYmxlKCk7CgkJCQl9CgkJfQllbHNlIGlmICggIXpvb20uZW5hYmxlZCApIHsKCQkJCXpvb20uZW5hYmxlKCk7CgkJfQoJfQoKCSQubW9iaWxlLmRvY3VtZW50Lm9uKCAibW9iaWxlaW5pdCIsIGZ1bmN0aW9uKCkgewoJCWlmICggJC5tb2JpbGUuaW9zb3JpZW50YXRpb25maXhFbmFibGVkICl7CgkJCSQubW9iaWxlLndpbmRvdwoJCQkJLmJpbmQoICJvcmllbnRhdGlvbmNoYW5nZS5pb3NvcmllbnRhdGlvbmZpeCIsIHpvb20uZW5hYmxlICkKCQkJCS5iaW5kKCAiZGV2aWNlbW90aW9uLmlvc29yaWVudGF0aW9uZml4IiwgY2hlY2tUaWx0ICk7CgkJfQoJfSk7Cgp9KCBqUXVlcnksIHRoaXMgKSk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyCSRodG1sID0gJCggImh0bWwiICksCgkJJHdpbmRvdyA9ICQubW9iaWxlLndpbmRvdzsKCgkvL3JlbW92ZSBpbml0aWFsIGJ1aWxkIGNsYXNzIChvbmx5IHByZXNlbnQgb24gZmlyc3QgcGFnZXNob3cpCglmdW5jdGlvbiBoaWRlUmVuZGVyaW5nQ2xhc3MoKSB7CgkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1tb2JpbGUtcmVuZGVyaW5nIiApOwoJfQoKCS8vIHRyaWdnZXIgbW9iaWxlaW5pdCBldmVudCAtIHVzZWZ1bCBob29rIGZvciBjb25maWd1cmluZyAkLm1vYmlsZSBzZXR0aW5ncyBiZWZvcmUgdGhleSdyZSB1c2VkCgkkKCB3aW5kb3cuZG9jdW1lbnQgKS50cmlnZ2VyKCAibW9iaWxlaW5pdCIgKTsKCgkvLyBzdXBwb3J0IGNvbmRpdGlvbnMKCS8vIGlmIGRldmljZSBzdXBwb3J0IGNvbmRpdGlvbihzKSBhcmVuJ3QgbWV0LCBsZWF2ZSB0aGluZ3MgYXMgdGhleSBhcmUgLT4gYSBiYXNpYywgdXNhYmxlIGV4cGVyaWVuY2UsCgkvLyBvdGhlcndpc2UsIHByb2NlZWQgd2l0aCB0aGUgZW5oYW5jZW1lbnRzCglpZiAoICEkLm1vYmlsZS5ncmFkZUEoKSApIHsKCQlyZXR1cm47Cgl9CgoJLy8gb3ZlcnJpZGUgYWpheEVuYWJsZWQgb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBrbm93biBjb25mbGljdHMgd2l0aCBoYXNoIGhpc3RvcnkgdXBkYXRlcwoJLy8gb3IgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoQkI1LCBPcGVyYSBNaW5pKQoJaWYgKCAkLm1vYmlsZS5hamF4QmxhY2tsaXN0ICkgewoJCSQubW9iaWxlLmFqYXhFbmFibGVkID0gZmFsc2U7Cgl9CgoJLy8gQWRkIG1vYmlsZSwgaW5pdGlhbCBsb2FkICJyZW5kZXJpbmciIGNsYXNzZXMgdG8gZG9jRWwKCSRodG1sLmFkZENsYXNzKCAidWktbW9iaWxlIHVpLW1vYmlsZS1yZW5kZXJpbmciICk7CgoJLy8gVGhpcyBpcyBhIGZhbGxiYWNrLiBJZiBhbnl0aGluZyBnb2VzIHdyb25nIChKUyBlcnJvcnMsIGV0YyksIG9yIGV2ZW50cyBkb24ndCBmaXJlLAoJLy8gdGhpcyBlbnN1cmVzIHRoZSByZW5kZXJpbmcgY2xhc3MgaXMgcmVtb3ZlZCBhZnRlciA1IHNlY29uZHMsIHNvIGNvbnRlbnQgaXMgdmlzaWJsZSBhbmQgYWNjZXNzaWJsZQoJc2V0VGltZW91dCggaGlkZVJlbmRlcmluZ0NsYXNzLCA1MDAwICk7CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gZmluZCBhbmQgZW5oYW5jZSB0aGUgcGFnZXMgaW4gdGhlIGRvbSBhbmQgdHJhbnNpdGlvbiB0byB0aGUgZmlyc3QgcGFnZS4KCQlpbml0aWFsaXplUGFnZTogZnVuY3Rpb24oKSB7CgkJCS8vIGZpbmQgcHJlc2VudCBwYWdlcwoJCQl2YXIgcGF0aCA9ICQubW9iaWxlLnBhdGgsCgkJCQkkcGFnZXMgPSAkKCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKSwKCQkJCWhhc2ggPSBwYXRoLnN0cmlwSGFzaCggcGF0aC5zdHJpcFF1ZXJ5UGFyYW1zKHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gpICksCgkJCQloYXNoUGFnZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBoYXNoICk7CgoJCQkvLyBpZiBubyBwYWdlcyBhcmUgZm91bmQsIGNyZWF0ZSBvbmUgd2l0aCBib2R5J3MgaW5uZXIgaHRtbAoJCQlpZiAoICEkcGFnZXMubGVuZ3RoICkgewoJCQkJJHBhZ2VzID0gJCggImJvZHkiICkud3JhcElubmVyKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJz48L2Rpdj4iICkuY2hpbGRyZW4oIDAgKTsKCQkJfQoKCQkJLy8gYWRkIGRpYWxvZ3MsIHNldCBkYXRhLXVybCBhdHRycwoJCQkkcGFnZXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCQkvLyB1bmxlc3MgdGhlIGRhdGEgdXJsIGlzIGFscmVhZHkgc2V0IHNldCBpdCB0byB0aGUgcGF0aG5hbWUKCQkJCWlmICggISR0aGlzWyAwIF0uZ2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiApICkgewoJCQkJCSR0aGlzLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiLCAkdGhpcy5hdHRyKCAiaWQiICkgfHwgbG9jYXRpb24ucGF0aG5hbWUgKyBsb2NhdGlvbi5zZWFyY2ggKTsKCQkJCX0KCQkJfSk7CgoJCQkvLyBkZWZpbmUgZmlyc3QgcGFnZSBpbiBkb20gY2FzZSBvbmUgYmFja3Mgb3V0IHRvIHRoZSBkaXJlY3Rvcnkgcm9vdCAobm90IGFsd2F5cyB0aGUgZmlyc3QgcGFnZSB2aXNpdGVkLCBidXQgZGVmaW5lZCBhcyBmYWxsYmFjaykKCQkJJC5tb2JpbGUuZmlyc3RQYWdlID0gJHBhZ2VzLmZpcnN0KCk7CgoJCQkvLyBkZWZpbmUgcGFnZSBjb250YWluZXIKCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lciA9ICQubW9iaWxlLmZpcnN0UGFnZQoJCQkJLnBhcmVudCgpCgkJCQkuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtdmlld3BvcnQiICkKCQkJCS5jb250ZW50KCk7CgoJCQkvLyBpbml0aWFsaXplIG5hdmlnYXRpb24gZXZlbnRzIG5vdywgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgb2NjdXJyZWQgYW5kIHRoZSBwYWdlIGNvbnRhaW5lcgoJCQkvLyBoYXMgYmVlbiBjcmVhdGVkIGJ1dCBiZWZvcmUgdGhlIHJlc3Qgb2YgdGhlIGxpYnJhcnkgaXMgYWxlcnRlZCB0byB0aGF0IGZhY3QKCQkJJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZC5yZXNvbHZlKCk7CgoJCQkvLyBhbGVydCBsaXN0ZW5lcnMgdGhhdCB0aGUgcGFnZWNvbnRhaW5lciBoYXMgYmVlbiBkZXRlcm1pbmVkIGZvciBiaW5kaW5nCgkJCS8vIHRvIGV2ZW50cyB0cmlnZ2VyZWQgb24gaXQKCQkJJHdpbmRvdy50cmlnZ2VyKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIgKTsKCgkJCS8vIGN1ZSBwYWdlIGxvYWRpbmcgbWVzc2FnZQoJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coKTsKCgkJCS8vcmVtb3ZlIGluaXRpYWwgYnVpbGQgY2xhc3MgKG9ubHkgcHJlc2VudCBvbiBmaXJzdCBwYWdlc2hvdykKCQkJaGlkZVJlbmRlcmluZ0NsYXNzKCk7CgoJCQkvLyBpZiBoYXNoY2hhbmdlIGxpc3RlbmluZyBpcyBkaXNhYmxlZCwgdGhlcmUncyBubyBoYXNoIGRlZXBsaW5rLAoJCQkvLyB0aGUgaGFzaCBpcyBub3QgdmFsaWQgKGNvbnRhaW5zIG1vcmUgdGhhbiBvbmUgIyBvciBkb2VzIG5vdCBzdGFydCB3aXRoICMpCgkJCS8vIG9yIHRoZXJlIGlzIG5vIHBhZ2Ugd2l0aCB0aGF0IGhhc2gsIGNoYW5nZSB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgRE9NCgkJCS8vIFJlbWVtYmVyLCBob3dldmVyLCB0aGF0IHRoZSBoYXNoIGNhbiBhbHNvIGJlIGEgcGF0aCEKCQkJaWYgKCAhICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgJiYKCQkJCSQubW9iaWxlLnBhdGguaXNIYXNoVmFsaWQoIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJKCAkKCBoYXNoUGFnZSApLmlzKCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApIHx8CgkJCQkJJC5tb2JpbGUucGF0aC5pc1BhdGgoIGhhc2ggKSB8fAoJCQkJCWhhc2ggPT09ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgKSApICkgewoKCQkJCS8vIFN0b3JlIHRoZSBpbml0aWFsIGRlc3RpbmF0aW9uCgkJCQlpZiAoICQubW9iaWxlLnBhdGguaXNIYXNoVmFsaWQoIGxvY2F0aW9uLmhhc2ggKSApIHsKCQkJCQkkLm1vYmlsZS51cmxIaXN0b3J5LmluaXRpYWxEc3QgPSBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKTsKCQkJCX0KCgkJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IGluaXRpYWwgcG9wc3RhdGUgc3RhdGUgaWYgaXQgZXhpc3RzCgkJCQkvLyBzbyB0aGF0IG5hdmlnYXRpb24gYmFjayB0byB0aGUgaW5pdGlhbCBwYWdlIHdvcmtzIHByb3Blcmx5CgkJCQlpZiAoICQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3Iuc3F1YXNoKCBwYXRoLnBhcnNlTG9jYXRpb24oKS5ocmVmICk7CgkJCQl9CgoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggJC5tb2JpbGUuZmlyc3RQYWdlLCB7CgkJCQkJdHJhbnNpdGlvbjogIm5vbmUiLAoJCQkJCXJldmVyc2U6IHRydWUsCgkJCQkJY2hhbmdlSGFzaDogZmFsc2UsCgkJCQkJZnJvbUhhc2hDaGFuZ2U6IHRydWUKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJLy8gdHJpZ2dlciBoYXNoY2hhbmdlIG9yIG5hdmlnYXRlIHRvIHNxdWFzaCBhbmQgcmVjb3JkIHRoZSBjb3JyZWN0CgkJCQkvLyBoaXN0b3J5IGVudHJ5IGZvciBhbiBpbml0aWFsIGhhc2ggcGF0aAoJCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJCSR3aW5kb3cudHJpZ2dlciggImhhc2hjaGFuZ2UiLCBbdHJ1ZV0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gVE9ETyBmaWd1cmUgb3V0IGhvdyB0byBzaW1wbGlmeSB0aGlzIGludGVyYWN0aW9uIHdpdGggdGhlIGluaXRpYWwgaGlzdG9yeSBlbnRyeQoJCQkJCS8vIGF0IHRoZSBib3R0b20ganMvbmF2aWdhdGUvbmF2aWdhdGUuanMKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LnN0YWNrID0gW107CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUoICQubW9iaWxlLnBhdGguaXNQYXRoKCBsb2NhdGlvbi5oYXNoICkgPyBsb2NhdGlvbi5oYXNoIDogbG9jYXRpb24uaHJlZiApOwoJCQkJfQoJCQl9CgkJfQoJfSk7CgoJJChmdW5jdGlvbigpIHsKCQkvL1J1biBpbmxpbmVTVkcgc3VwcG9ydCB0ZXN0CgkJJC5zdXBwb3J0LmlubGluZVNWRygpOwoJCQoJCS8vIGNoZWNrIHdoaWNoIHNjcm9sbFRvcCB2YWx1ZSBzaG91bGQgYmUgdXNlZCBieSBzY3JvbGxpbmcgdG8gMSBpbW1lZGlhdGVseSBhdCBkb21yZWFkeQoJCS8vIHRoZW4gY2hlY2sgd2hhdCB0aGUgc2Nyb2xsIHRvcCBpcy4gQW5kcm9pZCB3aWxsIHJlcG9ydCAwLi4uIG90aGVycyAxCgkJLy8gbm90ZSB0aGF0IHRoaXMgaW5pdGlhbCBzY3JvbGwgd29uJ3QgaGlkZSB0aGUgYWRkcmVzcyBiYXIuIEl0J3MganVzdCBmb3IgdGhlIGNoZWNrLgoJCQoJCS8vIGhpZGUgaU9TIGJyb3dzZXIgY2hyb21lIG9uIGxvYWQgaWYgaGlkZVVybEJhciBpcyB0cnVlIHRoaXMgaXMgdG8gdHJ5IGFuZCBkbyBpdCBhcyBzb29uIGFzIHBvc3NpYmxlCgkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyICkgewoJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIDEgKTsKCQl9CgoJCS8vIGlmIGRlZmF1bHRIb21lU2Nyb2xsIGhhc24ndCBiZWVuIHNldCB5ZXQsIHNlZSBpZiBzY3JvbGxUb3AgaXMgMQoJCS8vIGl0IHNob3VsZCBiZSAxIGluIG1vc3QgYnJvd3NlcnMsIGJ1dCBhbmRyb2lkIHRyZWF0cyAxIGFzIDAgKGZvciBoaWRpbmcgYWRkciBiYXIpCgkJLy8gc28gaWYgaXQncyAxLCB1c2UgMCBmcm9tIG5vdyBvbgoJCSQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsID0gKCAhJC5zdXBwb3J0LnNjcm9sbFRvcCB8fCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCkgPT09IDEgKSA/IDAgOiAxOwoKCQkvL2RvbS1yZWFkeSBpbml0cwoJCWlmICggJC5tb2JpbGUuYXV0b0luaXRpYWxpemVQYWdlICkgewoJCQkkLm1vYmlsZS5pbml0aWFsaXplUGFnZSgpOwoJCX0KCgkJLy8gd2luZG93IGxvYWQgZXZlbnQKCQkvLyBoaWRlIGlPUyBicm93c2VyIGNocm9tZSBvbiBsb2FkIGlmIGhpZGVVcmxCYXIgaXMgdHJ1ZSB0aGlzIGlzIGFzIGZhbGwgYmFjayBpbmNhc2Ugd2Ugd2VyZSB0b28gZWFybHkgYmVmb3JlCgkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyICkgewoJCQkkd2luZG93LmxvYWQoICQubW9iaWxlLnNpbGVudFNjcm9sbCApOwoJCX0KCgkJaWYgKCAhJC5zdXBwb3J0LmNzc1BvaW50ZXJFdmVudHMgKSB7CgkJCS8vIElFIGFuZCBPcGVyYSBkb24ndCBzdXBwb3J0IENTUyBwb2ludGVyLWV2ZW50czogbm9uZSB0aGF0IHdlIHVzZSB0byBkaXNhYmxlIGxpbmstYmFzZWQgYnV0dG9ucwoJCQkvLyBieSBhZGRpbmcgdGhlICd1aS1kaXNhYmxlZCcgY2xhc3MgdG8gdGhlbS4gVXNpbmcgYSBKYXZhU2NyaXB0IHdvcmthcm91bmQgZm9yIHRob3NlIGJyb3dzZXIuCgkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzU1OAoKCQkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICIudWktZGlzYWJsZWQiLCAidmNsaWNrIiwKCQkJCWZ1bmN0aW9uKCBlICkgewoJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQllLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJfQoJCQkpOwoJCX0KCX0pOwp9KCBqUXVlcnksIHRoaXMgKSk7CgoKfSkpOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 06:49:43 GMT",
                    "Content-Length": "427307",
                    "Date": "Fri, 07 Nov 2014 06:49:43 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}