{
    "url": "http://localhost:9999/nbubna/store/dist/app.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Client-side JSON injection (DOM-based)",
    "issueType": 2098032,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based JSON injection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and incorporates this into a string that is parsed as a JSON data structure and then processed by the application. An attacker may be able to use this behavior to construct a URL which, if visited by another application user, will cause arbitrary JSON data to be processed. Depending on the purpose for which this data is used, it may be possible to subvert the application's logic, or cause unintended actions on behalf of the user.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based JSON injection vulnerabilities is not to parse as JSON any string containing data that originated from an untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from modifying the JSON structure in inappropriate ways. This may involve strict validation of specific items to ensure they do not contain any characters that may interfere with the structure of the JSON when it is parsed.",
    "issueDetail": "The application may be vulnerable to DOM-based client-side JSON injection. Data is read from <b>document.cookie</b> and written to <b>JSON.parse()</b> via the following statements:<ul><li>var date = new Date(),                 key = 'store.local',                 items = {},                 cookies = document.cookie.split(';');</li><li>var c = cookies[i];</li><li>c = c.substring(1, c.length);</li><li>items = JSON.parse(c.substring(key.length+1));</li></ul>Because the data originates from a cookie, the application's behavior is not trivial to exploit in an attack against another user. Typically, you will need to find a means of setting an arbitrary cookie value in the victim's browser in order to exploit the vulnerability. Applications often contain \"cookie-forcing\" conditions which make this possible, and such a condition in any related domain or subdomain can potentially be used for this purpose. Nonetheless, this limitation somewhat mitigates the impact of the vulnerability. ",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/nbubna/store/dist/app.js",
                "path": "/nbubna/store/dist/app.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9uYnVibmEvc3RvcmUvZGlzdC9hcHAuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjk0ODANCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFNhdCwgMDggTm92IDIwMTQgMTQ6NTI6MTIgR01UDQpMYXN0LU1vZGlmaWVkOiBTYXQsIDA4IE5vdiAyMDE0IDE0OjUyOjEyIEdNVA0KDQo7KGZ1bmN0aW9uKCl7CgovKioKICogUmVxdWlyZSB0aGUgZ2l2ZW4gcGF0aC4KICoKICogQHBhcmFtIHtTdHJpbmd9IHBhdGgKICogQHJldHVybiB7T2JqZWN0fSBleHBvcnRzCiAqIEBhcGkgcHVibGljCiAqLwoKZnVuY3Rpb24gcmVxdWlyZShwYXRoLCBwYXJlbnQsIG9yaWcpIHsKICB2YXIgcmVzb2x2ZWQgPSByZXF1aXJlLnJlc29sdmUocGF0aCk7CgogIC8vIGxvb2t1cCBmYWlsZWQKICBpZiAobnVsbCA9PSByZXNvbHZlZCkgewogICAgb3JpZyA9IG9yaWcgfHwgcGF0aDsKICAgIHBhcmVudCA9IHBhcmVudCB8fCAncm9vdCc7CiAgICB2YXIgZXJyID0gbmV3IEVycm9yKCdGYWlsZWQgdG8gcmVxdWlyZSAiJyArIG9yaWcgKyAnIiBmcm9tICInICsgcGFyZW50ICsgJyInKTsKICAgIGVyci5wYXRoID0gb3JpZzsKICAgIGVyci5wYXJlbnQgPSBwYXJlbnQ7CiAgICBlcnIucmVxdWlyZSA9IHRydWU7CiAgICB0aHJvdyBlcnI7CiAgfQoKICB2YXIgbW9kdWxlID0gcmVxdWlyZS5tb2R1bGVzW3Jlc29sdmVkXTsKCiAgLy8gcGVyZm9ybSByZWFsIHJlcXVpcmUoKQogIC8vIGJ5IGludm9raW5nIHRoZSBtb2R1bGUncwogIC8vIHJlZ2lzdGVyZWQgZnVuY3Rpb24KICBpZiAoIW1vZHVsZS5leHBvcnRzKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHt9OwogICAgbW9kdWxlLmNsaWVudCA9IG1vZHVsZS5jb21wb25lbnQgPSB0cnVlOwogICAgbW9kdWxlLmNhbGwodGhpcywgbW9kdWxlLmV4cG9ydHMsIHJlcXVpcmUucmVsYXRpdmUocmVzb2x2ZWQpLCBtb2R1bGUpOwogIH0KCiAgcmV0dXJuIG1vZHVsZS5leHBvcnRzOwp9CgovKioKICogUmVnaXN0ZXJlZCBtb2R1bGVzLgogKi8KCnJlcXVpcmUubW9kdWxlcyA9IHt9OwoKLyoqCiAqIFJlZ2lzdGVyZWQgYWxpYXNlcy4KICovCgpyZXF1aXJlLmFsaWFzZXMgPSB7fTsKCi8qKgogKiBSZXNvbHZlIGBwYXRoYC4KICoKICogTG9va3VwOgogKgogKiAgIC0gUEFUSC9pbmRleC5qcwogKiAgIC0gUEFUSC5qcwogKiAgIC0gUEFUSAogKgogKiBAcGFyYW0ge1N0cmluZ30gcGF0aAogKiBAcmV0dXJuIHtTdHJpbmd9IHBhdGggb3IgbnVsbAogKiBAYXBpIHByaXZhdGUKICovCgpyZXF1aXJlLnJlc29sdmUgPSBmdW5jdGlvbihwYXRoKSB7CiAgaWYgKHBhdGguY2hhckF0KDApID09PSAnLycpIHBhdGggPSBwYXRoLnNsaWNlKDEpOwoKICB2YXIgcGF0aHMgPSBbCiAgICBwYXRoLAogICAgcGF0aCArICcuanMnLAogICAgcGF0aCArICcuanNvbicsCiAgICBwYXRoICsgJy9pbmRleC5qcycsCiAgICBwYXRoICsgJy9pbmRleC5qc29uJwogIF07CgogIGZvciAodmFyIGkgPSAwOyBpIDwgcGF0aHMubGVuZ3RoOyBpKyspIHsKICAgIHZhciBwYXRoID0gcGF0aHNbaV07CiAgICBpZiAocmVxdWlyZS5tb2R1bGVzLmhhc093blByb3BlcnR5KHBhdGgpKSByZXR1cm4gcGF0aDsKICAgIGlmIChyZXF1aXJlLmFsaWFzZXMuaGFzT3duUHJvcGVydHkocGF0aCkpIHJldHVybiByZXF1aXJlLmFsaWFzZXNbcGF0aF07CiAgfQp9OwoKLyoqCiAqIE5vcm1hbGl6ZSBgcGF0aGAgcmVsYXRpdmUgdG8gdGhlIGN1cnJlbnQgcGF0aC4KICoKICogQHBhcmFtIHtTdHJpbmd9IGN1cnIKICogQHBhcmFtIHtTdHJpbmd9IHBhdGgKICogQHJldHVybiB7U3RyaW5nfQogKiBAYXBpIHByaXZhdGUKICovCgpyZXF1aXJlLm5vcm1hbGl6ZSA9IGZ1bmN0aW9uKGN1cnIsIHBhdGgpIHsKICB2YXIgc2VncyA9IFtdOwoKICBpZiAoJy4nICE9IHBhdGguY2hhckF0KDApKSByZXR1cm4gcGF0aDsKCiAgY3VyciA9IGN1cnIuc3BsaXQoJy8nKTsKICBwYXRoID0gcGF0aC5zcGxpdCgnLycpOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IHBhdGgubGVuZ3RoOyArK2kpIHsKICAgIGlmICgnLi4nID09IHBhdGhbaV0pIHsKICAgICAgY3Vyci5wb3AoKTsKICAgIH0gZWxzZSBpZiAoJy4nICE9IHBhdGhbaV0gJiYgJycgIT0gcGF0aFtpXSkgewogICAgICBzZWdzLnB1c2gocGF0aFtpXSk7CiAgICB9CiAgfQoKICByZXR1cm4gY3Vyci5jb25jYXQoc2Vncykuam9pbignLycpOwp9OwoKLyoqCiAqIFJlZ2lzdGVyIG1vZHVsZSBhdCBgcGF0aGAgd2l0aCBjYWxsYmFjayBgZGVmaW5pdGlvbmAuCiAqCiAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoCiAqIEBwYXJhbSB7RnVuY3Rpb259IGRlZmluaXRpb24KICogQGFwaSBwcml2YXRlCiAqLwoKcmVxdWlyZS5yZWdpc3RlciA9IGZ1bmN0aW9uKHBhdGgsIGRlZmluaXRpb24pIHsKICByZXF1aXJlLm1vZHVsZXNbcGF0aF0gPSBkZWZpbml0aW9uOwp9OwoKLyoqCiAqIEFsaWFzIGEgbW9kdWxlIGRlZmluaXRpb24uCiAqCiAqIEBwYXJhbSB7U3RyaW5nfSBmcm9tCiAqIEBwYXJhbSB7U3RyaW5nfSB0bwogKiBAYXBpIHByaXZhdGUKICovCgpyZXF1aXJlLmFsaWFzID0gZnVuY3Rpb24oZnJvbSwgdG8pIHsKICBpZiAoIXJlcXVpcmUubW9kdWxlcy5oYXNPd25Qcm9wZXJ0eShmcm9tKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gYWxpYXMgIicgKyBmcm9tICsgJyIsIGl0IGRvZXMgbm90IGV4aXN0Jyk7CiAgfQogIHJlcXVpcmUuYWxpYXNlc1t0b10gPSBmcm9tOwp9OwoKLyoqCiAqIFJldHVybiBhIHJlcXVpcmUgZnVuY3Rpb24gcmVsYXRpdmUgdG8gdGhlIGBwYXJlbnRgIHBhdGguCiAqCiAqIEBwYXJhbSB7U3RyaW5nfSBwYXJlbnQKICogQHJldHVybiB7RnVuY3Rpb259CiAqIEBhcGkgcHJpdmF0ZQogKi8KCnJlcXVpcmUucmVsYXRpdmUgPSBmdW5jdGlvbihwYXJlbnQpIHsKICB2YXIgcCA9IHJlcXVpcmUubm9ybWFsaXplKHBhcmVudCwgJy4uJyk7CgogIC8qKgogICAqIGxhc3RJbmRleE9mIGhlbHBlci4KICAgKi8KCiAgZnVuY3Rpb24gbGFzdEluZGV4T2YoYXJyLCBvYmopIHsKICAgIHZhciBpID0gYXJyLmxlbmd0aDsKICAgIHdoaWxlIChpLS0pIHsKICAgICAgaWYgKGFycltpXSA9PT0gb2JqKSByZXR1cm4gaTsKICAgIH0KICAgIHJldHVybiAtMTsKICB9CgogIC8qKgogICAqIFRoZSByZWxhdGl2ZSByZXF1aXJlKCkgaXRzZWxmLgogICAqLwoKICBmdW5jdGlvbiBsb2NhbFJlcXVpcmUocGF0aCkgewogICAgdmFyIHJlc29sdmVkID0gbG9jYWxSZXF1aXJlLnJlc29sdmUocGF0aCk7CiAgICByZXR1cm4gcmVxdWlyZShyZXNvbHZlZCwgcGFyZW50LCBwYXRoKTsKICB9CgogIC8qKgogICAqIFJlc29sdmUgcmVsYXRpdmUgdG8gdGhlIHBhcmVudC4KICAgKi8KCiAgbG9jYWxSZXF1aXJlLnJlc29sdmUgPSBmdW5jdGlvbihwYXRoKSB7CiAgICB2YXIgYyA9IHBhdGguY2hhckF0KDApOwogICAgaWYgKCcvJyA9PSBjKSByZXR1cm4gcGF0aC5zbGljZSgxKTsKICAgIGlmICgnLicgPT0gYykgcmV0dXJuIHJlcXVpcmUubm9ybWFsaXplKHAsIHBhdGgpOwoKICAgIC8vIHJlc29sdmUgZGVwcyBieSByZXR1cm5pbmcKICAgIC8vIHRoZSBkZXAgaW4gdGhlIG5lYXJlc3QgImRlcHMiCiAgICAvLyBkaXJlY3RvcnkKICAgIHZhciBzZWdzID0gcGFyZW50LnNwbGl0KCcvJyk7CiAgICB2YXIgaSA9IGxhc3RJbmRleE9mKHNlZ3MsICdkZXBzJykgKyAxOwogICAgaWYgKCFpKSBpID0gMDsKICAgIHBhdGggPSBzZWdzLnNsaWNlKDAsIGkgKyAxKS5qb2luKCcvJykgKyAnL2RlcHMvJyArIHBhdGg7CiAgICByZXR1cm4gcGF0aDsKICB9OwoKICAvKioKICAgKiBDaGVjayBpZiBtb2R1bGUgaXMgZGVmaW5lZCBhdCBgcGF0aGAuCiAgICovCgogIGxvY2FsUmVxdWlyZS5leGlzdHMgPSBmdW5jdGlvbihwYXRoKSB7CiAgICByZXR1cm4gcmVxdWlyZS5tb2R1bGVzLmhhc093blByb3BlcnR5KGxvY2FsUmVxdWlyZS5yZXNvbHZlKHBhdGgpKTsKICB9OwoKICByZXR1cm4gbG9jYWxSZXF1aXJlOwp9OwpyZXF1aXJlLnJlZ2lzdGVyKCJzdG9yZS9kaXN0L3N0b3JlMi5qcyIsIGZ1bmN0aW9uKGV4cG9ydHMsIHJlcXVpcmUsIG1vZHVsZSl7Ci8qISBzdG9yZTIgLSB2Mi4xLjYgLSAyMDE0LTA0LTA4CiogQ29weXJpZ2h0IChjKSAyMDE0IE5hdGhhbiBCdWJuYTsgTGljZW5zZWQgTUlULCBHUEwgKi8KOyhmdW5jdGlvbih3aW5kb3csIGRlZmluZSkgewogICAgdmFyIF8gPSB7CiAgICAgICAgdmVyc2lvbjogIjIuMS42IiwKICAgICAgICBhcmVhczoge30sCiAgICAgICAgYXBpczoge30sCgogICAgICAgIC8vIHV0aWxpdGllcwogICAgICAgIGluaGVyaXQ6IGZ1bmN0aW9uKGFwaSwgbykgewogICAgICAgICAgICBmb3IgKHZhciBwIGluIGFwaSkgewogICAgICAgICAgICAgICAgaWYgKCFvLmhhc093blByb3BlcnR5KHApKSB7CiAgICAgICAgICAgICAgICAgICAgb1twXSA9IGFwaVtwXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbzsKICAgICAgICB9LAogICAgICAgIHN0cmluZ2lmeTogZnVuY3Rpb24oZCkgewogICAgICAgICAgICByZXR1cm4gZCA9PT0gdW5kZWZpbmVkIHx8IHR5cGVvZiBkID09PSAiZnVuY3Rpb24iID8gZCsnJyA6IEpTT04uc3RyaW5naWZ5KGQpOwogICAgICAgIH0sCiAgICAgICAgcGFyc2U6IGZ1bmN0aW9uKHMpIHsKICAgICAgICAgICAgLy8gaWYgaXQgZG9lc24ndCBwYXJzZSwgcmV0dXJuIGFzIGlzCiAgICAgICAgICAgIHRyeXsgcmV0dXJuIEpTT04ucGFyc2Uocyk7IH1jYXRjaChlKXsgcmV0dXJuIHM7IH0KICAgICAgICB9LAoKICAgICAgICAvLyBleHRlbnNpb24gaG9va3MKICAgICAgICBmbjogZnVuY3Rpb24obmFtZSwgZm4pIHsKICAgICAgICAgICAgXy5zdG9yZUFQSVtuYW1lXSA9IGZuOwogICAgICAgICAgICBmb3IgKHZhciBhcGkgaW4gXy5hcGlzKSB7CiAgICAgICAgICAgICAgICBfLmFwaXNbYXBpXVtuYW1lXSA9IGZuOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uKGFyZWEsIGtleSl7IHJldHVybiBhcmVhLmdldEl0ZW0oa2V5KTsgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uKGFyZWEsIGtleSwgc3RyaW5nKXsgYXJlYS5zZXRJdGVtKGtleSwgc3RyaW5nKTsgfSwKICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGFyZWEsIGtleSl7IGFyZWEucmVtb3ZlSXRlbShrZXkpOyB9LAogICAgICAgIGtleTogZnVuY3Rpb24oYXJlYSwgaSl7IHJldHVybiBhcmVhLmtleShpKTsgfSwKICAgICAgICBsZW5ndGg6IGZ1bmN0aW9uKGFyZWEpeyByZXR1cm4gYXJlYS5sZW5ndGg7IH0sCiAgICAgICAgY2xlYXI6IGZ1bmN0aW9uKGFyZWEpeyBhcmVhLmNsZWFyKCk7IH0sCgogICAgICAgIC8vIGNvcmUgZnVuY3Rpb25zCiAgICAgICAgU3RvcmU6IGZ1bmN0aW9uKGlkLCBhcmVhLCBuYW1lc3BhY2UpIHsKICAgICAgICAgICAgdmFyIHN0b3JlID0gXy5pbmhlcml0KF8uc3RvcmVBUEksIGZ1bmN0aW9uKGtleSwgZGF0YSwgb3ZlcndyaXRlKSB7CiAgICAgICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCl7IHJldHVybiBzdG9yZS5nZXRBbGwoKTsgfQogICAgICAgICAgICAgICAgaWYgKGRhdGEgIT09IHVuZGVmaW5lZCl7IHJldHVybiBzdG9yZS5zZXQoa2V5LCBkYXRhLCBvdmVyd3JpdGUpOyB9CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGtleSA9PT0gInN0cmluZyIpeyByZXR1cm4gc3RvcmUuZ2V0KGtleSk7IH0KICAgICAgICAgICAgICAgIGlmICgha2V5KXsgcmV0dXJuIHN0b3JlLmNsZWFyKCk7IH0KICAgICAgICAgICAgICAgIHJldHVybiBzdG9yZS5zZXRBbGwoa2V5LCBkYXRhKTsvLyBvdmVyd3JpdGU9ZGF0YSwgZGF0YT1rZXkKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHN0b3JlLl9pZCA9IGlkOwogICAgICAgICAgICBzdG9yZS5fYXJlYSA9IGFyZWEgfHwgXy5pbmhlcml0KF8uc3RvcmFnZUFQSSwgeyBpdGVtczoge30sIG5hbWU6ICdmYWtlJyB9KTsKICAgICAgICAgICAgc3RvcmUuX25zID0gbmFtZXNwYWNlIHx8ICcnOwogICAgICAgICAgICBpZiAoIV8uYXJlYXNbaWRdKSB7CiAgICAgICAgICAgICAgICBfLmFyZWFzW2lkXSA9IHN0b3JlLl9hcmVhOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghXy5hcGlzW3N0b3JlLl9ucytzdG9yZS5faWRdKSB7CiAgICAgICAgICAgICAgICBfLmFwaXNbc3RvcmUuX25zK3N0b3JlLl9pZF0gPSBzdG9yZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3RvcmU7CiAgICAgICAgfSwKICAgICAgICBzdG9yZUFQSTogewogICAgICAgICAgICAvLyBhZG1pbiBmdW5jdGlvbnMKICAgICAgICAgICAgYXJlYTogZnVuY3Rpb24oaWQsIGFyZWEpIHsKICAgICAgICAgICAgICAgIHZhciBzdG9yZSA9IHRoaXNbaWRdOwogICAgICAgICAgICAgICAgaWYgKCFzdG9yZSB8fCAhc3RvcmUuYXJlYSkgewogICAgICAgICAgICAgICAgICAgIHN0b3JlID0gXy5TdG9yZShpZCwgYXJlYSwgdGhpcy5fbnMpOy8vbmV3IGFyZWEtc3BlY2lmaWMgYXBpIGluIHRoaXMgbmFtZXNwYWNlCiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzW2lkXSl7IHRoaXNbaWRdID0gc3RvcmU7IH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBzdG9yZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbmFtZXNwYWNlOiBmdW5jdGlvbihuYW1lc3BhY2UsIG5vU2Vzc2lvbikgewogICAgICAgICAgICAgICAgaWYgKCFuYW1lc3BhY2UpewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9ucyA/IHRoaXMuX25zLnN1YnN0cmluZygwLHRoaXMuX25zLmxlbmd0aC0xKSA6ICcnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG5zID0gbmFtZXNwYWNlLCBzdG9yZSA9IHRoaXNbbnNdOwogICAgICAgICAgICAgICAgaWYgKCFzdG9yZSB8fCAhc3RvcmUubmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgc3RvcmUgPSBfLlN0b3JlKHRoaXMuX2lkLCB0aGlzLl9hcmVhLCB0aGlzLl9ucytucysnLicpOy8vbmV3IG5hbWVzcGFjZWQgYXBpCiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzW25zXSl7IHRoaXNbbnNdID0gc3RvcmU7IH0KICAgICAgICAgICAgICAgICAgICBpZiAoIW5vU2Vzc2lvbil7IHN0b3JlLmFyZWEoJ3Nlc3Npb24nLCBfLmFyZWFzLnNlc3Npb24pOyB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gc3RvcmU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlzRmFrZTogZnVuY3Rpb24oKXsgcmV0dXJuIHRoaXMuX2FyZWEubmFtZSA9PT0gJ2Zha2UnOyB9LAogICAgICAgICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ3N0b3JlJysodGhpcy5fbnM/Jy4nK3RoaXMubmFtZXNwYWNlKCk6JycpKydbJyt0aGlzLl9pZCsnXSc7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBzdG9yYWdlIGZ1bmN0aW9ucwogICAgICAgICAgICBoYXM6IGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2FyZWEuaGFzKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2FyZWEuaGFzKHRoaXMuX2luKGtleSkpOy8vZXh0ZW5zaW9uIGhvb2sKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiAhISh0aGlzLl9pbihrZXkpIGluIHRoaXMuX2FyZWEpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzaXplOiBmdW5jdGlvbigpeyByZXR1cm4gdGhpcy5rZXlzKCkubGVuZ3RoOyB9LAogICAgICAgICAgICBlYWNoOiBmdW5jdGlvbihmbiwgYW5kKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpPTAsIG09Xy5sZW5ndGgodGhpcy5fYXJlYSk7IGk8bTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IHRoaXMuX291dChfLmtleSh0aGlzLl9hcmVhLCBpKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGtleSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbi5jYWxsKHRoaXMsIGtleSwgYW5kIHx8IHRoaXMuZ2V0KGtleSkpID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKG0gPiBfLmxlbmd0aCh0aGlzLl9hcmVhKSkgeyBtLS07IGktLTsgfS8vIGluIGNhc2Ugb2YgcmVtb3ZlSXRlbQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGFuZCB8fCB0aGlzOwogICAgICAgICAgICB9LAogICAgICAgICAgICBrZXlzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaywgbGlzdCl7IGxpc3QucHVzaChrKTsgfSwgW10pOwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKGtleSwgYWx0KSB7CiAgICAgICAgICAgICAgICB2YXIgcyA9IF8uZ2V0KHRoaXMuX2FyZWEsIHRoaXMuX2luKGtleSkpOwogICAgICAgICAgICAgICAgcmV0dXJuIHMgIT09IG51bGwgPyBfLnBhcnNlKHMpIDogYWx0IHx8IHM7Ly8gc3VwcG9ydCBhbHQgZm9yIGVhc3kgZGVmYXVsdCBtZ210CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldEFsbDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGssIGFsbCl7IGFsbFtrXSA9IHRoaXMuZ2V0KGspOyB9LCB7fSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldDogZnVuY3Rpb24oa2V5LCBkYXRhLCBvdmVyd3JpdGUpIHsKICAgICAgICAgICAgICAgIHZhciBkID0gdGhpcy5nZXQoa2V5KTsKICAgICAgICAgICAgICAgIGlmIChkICE9IG51bGwgJiYgb3ZlcndyaXRlID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRhOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIF8uc2V0KHRoaXMuX2FyZWEsIHRoaXMuX2luKGtleSksIF8uc3RyaW5naWZ5KGRhdGEpLCBvdmVyd3JpdGUpIHx8IGQ7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldEFsbDogZnVuY3Rpb24oZGF0YSwgb3ZlcndyaXRlKSB7CiAgICAgICAgICAgICAgICB2YXIgY2hhbmdlZCwgdmFsOwogICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICB2YWwgPSBkYXRhW2tleV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc2V0KGtleSwgdmFsLCBvdmVyd3JpdGUpICE9PSB2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQ7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgZCA9IHRoaXMuZ2V0KGtleSk7CiAgICAgICAgICAgICAgICBfLnJlbW92ZSh0aGlzLl9hcmVhLCB0aGlzLl9pbihrZXkpKTsKICAgICAgICAgICAgICAgIHJldHVybiBkOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjbGVhcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX25zKSB7CiAgICAgICAgICAgICAgICAgICAgXy5jbGVhcih0aGlzLl9hcmVhKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKGspeyBfLnJlbW92ZSh0aGlzLl9hcmVhLCB0aGlzLl9pbihrKSk7IH0sIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNsZWFyQWxsOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBhcmVhID0gdGhpcy5fYXJlYTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGlkIGluIF8uYXJlYXMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoXy5hcmVhcy5oYXNPd25Qcm9wZXJ0eShpZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYXJlYSA9IF8uYXJlYXNbaWRdOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5fYXJlYSA9IGFyZWE7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8vIGludGVybmFsIHVzZSBmdW5jdGlvbnMKICAgICAgICAgICAgX2luOiBmdW5jdGlvbihrKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGsgIT09ICJzdHJpbmciKXsgayA9IF8uc3RyaW5naWZ5KGspOyB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fbnMgPyB0aGlzLl9ucyArIGsgOiBrOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfb3V0OiBmdW5jdGlvbihrKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fbnMgPwogICAgICAgICAgICAgICAgICAgIGsgJiYgay5pbmRleE9mKHRoaXMuX25zKSA9PT0gMCA/CiAgICAgICAgICAgICAgICAgICAgICAgIGsuc3Vic3RyaW5nKHRoaXMuX25zLmxlbmd0aCkgOgogICAgICAgICAgICAgICAgICAgICAgICB1bmRlZmluZWQgOiAvLyBzbyBlYWNoKCkga25vd3MgdG8gc2tpcCBpdAogICAgICAgICAgICAgICAgICAgIGs7CiAgICAgICAgICAgIH0KICAgICAgICB9LC8vIGVuZCBfLnN0b3JlQVBJCiAgICAgICAgc3RvcmFnZUFQSTogewogICAgICAgICAgICBsZW5ndGg6IDAsCiAgICAgICAgICAgIGhhczogZnVuY3Rpb24oayl7IHJldHVybiB0aGlzLml0ZW1zLmhhc093blByb3BlcnR5KGspOyB9LAogICAgICAgICAgICBrZXk6IGZ1bmN0aW9uKGkpIHsKICAgICAgICAgICAgICAgIHZhciBjID0gMDsKICAgICAgICAgICAgICAgIGZvciAodmFyIGsgaW4gdGhpcy5pdGVtcyl7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaGFzKGspICYmIGkgPT09IGMrKykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldEl0ZW06IGZ1bmN0aW9uKGssIHYpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5oYXMoaykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmxlbmd0aCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5pdGVtc1trXSA9IHY7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHJlbW92ZUl0ZW06IGZ1bmN0aW9uKGspIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmhhcyhrKSkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLml0ZW1zW2tdOwogICAgICAgICAgICAgICAgICAgIHRoaXMubGVuZ3RoLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldEl0ZW06IGZ1bmN0aW9uKGspeyByZXR1cm4gdGhpcy5oYXMoaykgPyB0aGlzLml0ZW1zW2tdIDogbnVsbDsgfSwKICAgICAgICAgICAgY2xlYXI6IGZ1bmN0aW9uKCl7IGZvciAodmFyIGsgaW4gdGhpcy5saXN0KXsgdGhpcy5yZW1vdmVJdGVtKGspOyB9IH0sCiAgICAgICAgICAgIHRvU3RyaW5nOiBmdW5jdGlvbigpeyByZXR1cm4gdGhpcy5sZW5ndGgrJyBpdGVtcyBpbiAnK3RoaXMubmFtZSsnU3RvcmFnZSc7IH0KICAgICAgICB9Ly8gZW5kIF8uc3RvcmFnZUFQSQogICAgfTsKCiAgICAvLyBzZXR1cCB0aGUgcHJpbWFyeSBzdG9yZSBmbgogICAgaWYgKHdpbmRvdy5zdG9yZSl7IF8uY29uZmxpY3QgPSB3aW5kb3cuc3RvcmU7IH0KICAgIHZhciBzdG9yZSA9CiAgICAgICAgLy8gc2FmZWx5IHNldCB0aGlzIHVwICh0aHJvd3MgZXJyb3IgaW4gSUUxMC8zMmJpdCBtb2RlIGZvciBsb2NhbCBmaWxlcykKICAgICAgICBfLlN0b3JlKCJsb2NhbCIsIChmdW5jdGlvbigpe3RyeXsgcmV0dXJuIGxvY2FsU3RvcmFnZTsgfWNhdGNoKGUpe319KSgpKTsKICAgIHN0b3JlLmxvY2FsID0gc3RvcmU7Ly8gZm9yIGNvbXBsZXRlbmVzcwogICAgc3RvcmUuXyA9IF87Ly8gZm9yIGV4dGVuZGVycyBhbmQgZGVidWdnZXJzLi4uCiAgICAvLyBzYWZlbHkgc2V0dXAgc3RvcmUuc2Vzc2lvbiAodGhyb3dzIGV4Y2VwdGlvbiBpbiBGRiBmb3IgZmlsZTovLy8gdXJscykKICAgIHN0b3JlLmFyZWEoInNlc3Npb24iLCAoZnVuY3Rpb24oKXt0cnl7IHJldHVybiBzZXNzaW9uU3RvcmFnZTsgfWNhdGNoKGUpe319KSgpKTsKCiAgICBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBkZWZpbmUoZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gc3RvcmU7CiAgICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBzdG9yZTsKICAgIH0gZWxzZSB7CiAgICAgICAgd2luZG93LnN0b3JlID0gc3RvcmU7CiAgICB9Cgp9KSh3aW5kb3csIHdpbmRvdy5kZWZpbmUpOwoKfSk7CnJlcXVpcmUucmVnaXN0ZXIoInN0b3JlL3NyYy9zdG9yZS5vbi5qcyIsIGZ1bmN0aW9uKGV4cG9ydHMsIHJlcXVpcmUsIG1vZHVsZSl7Ci8qKgogKiBDb3B5cmlnaHQgKGMpIDIwMTMgRVNIQSBSZXNlYXJjaAogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgYW5kIEdQTCBsaWNlbnNlczoKICogICBodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocAogKiAgIGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9ncGwuaHRtbAogKgogKiBNYWtlcyBpdCBlYXN5IHRvIHdhdGNoIGZvciBzdG9yYWdlIGV2ZW50cyBieSBlbmhhbmNpbmcgdGhlIGV2ZW50cyBhbmQKICogYWxsb3dpbmcgYmluZGluZyB0byBwYXJ0aWN1bGFyIGtleXMgYW5kL29yIG5hbWVzcGFjZXMuCiAqCiAqIC8vIGxpc3RlbiB0byBwYXJ0aWN1bGFyIGtleSBzdG9yYWdlIGV2ZW50cyAoeWVzLCB0aGlzIGlzIG5hbWVzcGFjZSBzZW5zaXRpdmUpCiAqIHN0b3JlLm9uKCdmb28nLCBmdW5jdGlvbiBsaXN0ZW5Ub0ZvbyhlKXsgY29uc29sZS5sb2coJ2ZvbyB3YXMgY2hhbmdlZDonLCBlKTsgfSk7CiAqIHN0b3JlLm9mZignZm9vJywgbGlzdGVuVG9Gb28pOwogKgogKiAvLyBsaXN0ZW4gdG8gYWxsIHN0b3JhZ2UgZXZlbnRzIChhbHNvIG5hbWVzcGFjZSBzZW5zaXRpdmUpCiAqIHN0b3JlLm9uKGZ1bmN0aW9uIHN0b3JhZ2VFdmVudChlKXsgY29uc29sZS5sb2coJ3dlYiBzdG9yYWdlOicsIGUpOyB9KTsKICogc3RvcmUub2ZmKHN0b3JhZ2VFdmVudCk7CiAqIAogKiBTdGF0dXM6IEJFVEEgLSB1c2VmdWwsIGlmIHlvdSBhcmVuJ3QgdXNpbmcgSUU4IG9yIHdvcnNlCiAqLwo7KGZ1bmN0aW9uKHdpbmRvdywgXykgewoKICAgIF8ub24gPSBmdW5jdGlvbihrZXksIGZuKSB7CiAgICAgICAgaWYgKCFmbikgeyBmbiA9IGtleTsga2V5ID0gJyc7IH0vLyBubyBrZXkgPT09IGFsbCBrZXlzCiAgICAgICAgdmFyIGxpc3RlbmVyID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICB2YXIgayA9IHRoaXMuX291dChlLmtleSk7Ly8gdW5kZWZpbmVkIGlmIGtleSBpcyBub3QgaW4gdGhlIG5hbWVzcGFjZQogICAgICAgICAgICBpZiAoKGsgJiYgKCFrZXkgfHwgayA9PT0ga2V5KSkgJiYgLy8gbWF0Y2gga2V5IGlmIGxpc3RlbmVyIGhhcyBvbmUKICAgICAgICAgICAgICAgICghZS5zdG9yYWdlQXJlYSB8fCBlLnN0b3JhZ2VBcmVhID09PSB0aGlzLl9hcmVhKSkgey8vIG1hdGNoIGFyZWEsIGlmIGF2YWlsYWJsZQogICAgICAgICAgICAgICAgcmV0dXJuIGZuLmNhbGwodGhpcywgXy5ldmVudC5jYWxsKHRoaXMsIGssIGUpKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInN0b3JhZ2UiLCBmbltrZXkrJy1saXN0ZW5lciddPWxpc3RlbmVyLCBmYWxzZSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIF8ub2ZmID0gZnVuY3Rpb24oa2V5LCBmbikgewogICAgICAgIGlmICghZm4pIHsgZm4gPSBrZXk7IGtleSA9ICcnOyB9Ly8gbm8ga2V5ID09PSBhbGwga2V5cwogICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJzdG9yYWdlIiwgZm5ba2V5KyctbGlzdGVuZXInXSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIF8ub25jZSA9IGZ1bmN0aW9uKGtleSwgZm4pIHsKICAgICAgICBpZiAoIWZuKSB7IGZuID0ga2V5OyBrZXkgPSAnJzsgfQogICAgICAgIHZhciBzID0gdGhpcywgbGlzdGVuZXI7CiAgICAgICAgcmV0dXJuIHMub24oa2V5LCBsaXN0ZW5lciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzLm9mZihrZXksIGxpc3RlbmVyKTsKICAgICAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfSk7CiAgICB9OwoKICAgIF8uZXZlbnQgPSBmdW5jdGlvbihrLCBlKSB7CiAgICAgICAgdmFyIGV2ZW50ID0gewogICAgICAgICAgICBrZXk6IGssCiAgICAgICAgICAgIG5hbWVzcGFjZTogdGhpcy5uYW1lc3BhY2UoKSwKICAgICAgICAgICAgbmV3VmFsdWU6IF8ucGFyc2UoZS5uZXdWYWx1ZSksCiAgICAgICAgICAgIG9sZFZhbHVlOiBfLnBhcnNlKGUub2xkVmFsdWUpLAogICAgICAgICAgICB1cmw6IGUudXJsIHx8IGUudXJpLAogICAgICAgICAgICBzdG9yYWdlQXJlYTogZS5zdG9yYWdlQXJlYSwKICAgICAgICAgICAgc291cmNlOiBlLnNvdXJjZSwKICAgICAgICAgICAgdGltZVN0YW1wOiBlLnRpbWVTdGFtcCwKICAgICAgICAgICAgb3JpZ2luYWxFdmVudDogZQogICAgICAgIH07CiAgICAgICAgaWYgKF8uY2FjaGUpIHsKICAgICAgICAgICAgdmFyIG1pbiA9IF8uZXhwaXJlcyhlLm5ld1ZhbHVlIHx8IGUub2xkVmFsdWUpOwogICAgICAgICAgICBpZiAobWluKSB7CiAgICAgICAgICAgICAgICBldmVudC5leHBpcmVzID0gXy53aGVuKG1pbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV2ZW50OwogICAgfTsKCiAgICAvLyBzdG9yZTIgcG9saWN5IGlzIHRvIG5vdCB0aHJvdyBlcnJvcnMgb24gb2xkIGJyb3dzZXJzCiAgICB2YXIgb2xkID0gIXdpbmRvdy5hZGRFdmVudExpc3RlbmVyID8gZnVuY3Rpb24oKXt9IDogbnVsbDsKICAgIF8uZm4oJ29uJywgb2xkIHx8IF8ub24pOwogICAgXy5mbignb2ZmJywgb2xkIHx8IF8ub2ZmKTsKICAgIF8uZm4oJ29uY2UnLCBvbGQgfHwgXy5vbmNlKTsKCn0pKHdpbmRvdywgd2luZG93LnN0b3JlLl8pOwoKfSk7CnJlcXVpcmUucmVnaXN0ZXIoInN0b3JlL3NyYy9zdG9yZS5jYWNoZS5qcyIsIGZ1bmN0aW9uKGV4cG9ydHMsIHJlcXVpcmUsIG1vZHVsZSl7Ci8qKgogKiBDb3B5cmlnaHQgKGMpIDIwMTMgRVNIQSBSZXNlYXJjaAogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgYW5kIEdQTCBsaWNlbnNlczoKICogICBodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocAogKiAgIGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9ncGwuaHRtbAogKgogKiBBbGxvd3MgdXNlIG9mIHRoZSAnb3ZlcndyaXRlJyBwYXJhbSBvbiBzZXQgY2FsbHMgdG8gZ2l2ZSBhbiBlbmZvcmNlZCBleHBpcmF0aW9uIGRhdGUKICogd2l0aG91dCBicmVha2luZyBleGlzdGluZyAnb3ZlcndyaXRlJyBmdW5jdGlvbmFsaXR5LgogKgogKiBTdGF0dXM6IEJFVEEgLSB1c2VmdWwsIG5lZWRzIHRlc3RpbmcKICovCjsoZnVuY3Rpb24oXykgewogICAgdmFyIHByZWZpeCA9ICdleHBAJywKICAgICAgICBzdWZmaXggPSAnOycsCiAgICAgICAgcGFyc2UgPSBfLnBhcnNlLAogICAgICAgIF9nZXQgPSBfLmdldCwKICAgICAgICBfc2V0ID0gXy5zZXQ7CiAgICBfLnBhcnNlID0gZnVuY3Rpb24ocykgewogICAgICAgIGlmIChzICYmIHMuaW5kZXhPZihwcmVmaXgpID09PSAwKSB7CiAgICAgICAgICAgIHMgPSBzLnN1YnN0cmluZyhzLmluZGV4T2Yoc3VmZml4KSsxKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBhcnNlKHMpOwogICAgfTsKICAgIF8uZXhwaXJlcyA9IGZ1bmN0aW9uKHMpIHsKICAgICAgICBpZiAocyAmJiBzLmluZGV4T2YocHJlZml4KSA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gcGFyc2VJbnQocy5zdWJzdHJpbmcocHJlZml4Lmxlbmd0aCwgcy5pbmRleE9mKHN1ZmZpeCkpLCAxMCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CiAgICBfLndoZW4gPSBmdW5jdGlvbihtaW4pIHsvLyBpZiBtaW4sIHJldHVybiBtaW4tPmRhdGUsIGVsc2UgZGF0ZS0+bWluCiAgICAgICAgdmFyIG5vdyA9IE1hdGguZmxvb3IoKG5ldyBEYXRlKCkuZ2V0VGltZSgpKS82MDAwMCk7CiAgICAgICAgcmV0dXJuIG1pbiA/IG5ldyBEYXRlKChub3crbWluKSo2MDAwMCkgOiBub3c7CiAgICB9OwogICAgXy5jYWNoZSA9IGZ1bmN0aW9uKGFyZWEsIGtleSkgewogICAgICAgIHZhciBzID0gX2dldChhcmVhLCBrZXkpLAogICAgICAgICAgICBtaW4gPSBfLmV4cGlyZXMocyk7CiAgICAgICAgaWYgKG1pbiAmJiBfLndoZW4oKSA+PSBtaW4pIHsKICAgICAgICAgICAgcmV0dXJuIGFyZWEucmVtb3ZlSXRlbShrZXkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gczsKICAgIH07CiAgICBfLmdldCA9IGZ1bmN0aW9uKGFyZWEsIGtleSkgewogICAgICAgIHZhciBzID0gXy5jYWNoZShhcmVhLCBrZXkpOwogICAgICAgIHJldHVybiBzID09PSB1bmRlZmluZWQgPyBudWxsIDogczsKICAgIH07CiAgICBfLnNldCA9IGZ1bmN0aW9uKGFyZWEsIGtleSwgc3RyaW5nLCBtaW4pIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAobWluKSB7CiAgICAgICAgICAgICAgICBzdHJpbmcgPSBwcmVmaXggKyAoXy53aGVuKCkrbWluKSArIHN1ZmZpeCArIHN0cmluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICBfc2V0KGFyZWEsIGtleSwgc3RyaW5nKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGlmIChlLm5hbWUgPT09ICdRVU9UQV9FWENFRURFRF9FUlInIHx8IGUubmFtZSA9PT0gJ05TX0VSUk9SX0RPTV9RVU9UQV9SRUFDSEVEJykgewogICAgICAgICAgICAgICAgdmFyIGNoYW5nZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MCxtPWFyZWEubGVuZ3RoOyBpPG07IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChfLmNhY2hlKGFyZWEsIGtleSkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY2hhbmdlZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBfLnNldC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgfQogICAgfTsKfSkod2luZG93LnN0b3JlLl8sIHVuZGVmaW5lZCk7Cn0pOwpyZXF1aXJlLnJlZ2lzdGVyKCJzdG9yZS9zcmMvc3RvcmUubWVhc3VyZS5qcyIsIGZ1bmN0aW9uKGV4cG9ydHMsIHJlcXVpcmUsIG1vZHVsZSl7Ci8qKgogKiBDb3B5cmlnaHQgKGMpIDIwMTMgRVNIQSBSZXNlYXJjaAogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgYW5kIEdQTCBsaWNlbnNlczoKICogICBodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocAogKiAgIGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9ncGwuaHRtbAogKgogKiBzdG9yZS5yZW1haW5pbmdTcGFjZSgpOy8vIHJldHVybnMgcmVtYWluaW5nU3BhY2UgdmFsdWUgKGlmIGJyb3dzZXIgc3VwcG9ydHMgaXQpCiAqIHN0b3JlLmNoYXJzVXNlZCgpOy8vIHJldHVybnMgbGVuZ3RoIG9mIGFsbCBkYXRhIHdoZW4gc3RyaW5naWZpZWQKICogc3RvcmUuY2hhcnNMZWZ0KFt0cnVlXSk7Ly8gdGVzdHMgaG93IG1hbnkgbW9yZSBjaGFycyB3ZSBjYW4gZml0IChjcmFzaCB0aHJlYXQhKQogKiBzdG9yZS5jaGFyc1RvdGFsKFt0cnVlXSk7Ly8gY2hhcnNVc2VkICsgY2hhcnNMZWZ0LCBkdWguCiAqCiAqIFRPRE86IGJ5dGUvc3RyaW5nIGNvbnZlcnNpb25zCiAqCiAqIFN0YXR1czogQUxQSEEgLSBjaGFuZ2luZyBBUEkgKmFuZCogY3Jhc2ggdGhyZWF0cyA6KQogKi8KOyhmdW5jdGlvbihzdG9yZSwgXykgewoKICAgIF8uZm4oJ3JlbWFpbmluZ1NwYWNlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2FyZWEucmVtYWluaW5nU3BhY2U7CiAgICB9KTsKICAgIF8uZm4oJ2NoYXJzVXNlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBfLnN0cmluZ2lmeSh0aGlzLmdldEFsbCgpKS5sZW5ndGggLSAyOwogICAgfSk7CiAgICBfLmZuKCdjaGFyc0xlZnQnLCBmdW5jdGlvbih0ZXN0KSB7CiAgICAgICAgaWYgKHRoaXMuaXNGYWtlKCkpeyByZXR1cm47IH0KICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICB0ZXN0ID0gd2luZG93LmNvbmZpcm0oJ0NhbGxpbmcgc3RvcmUuY2hhcnNMZWZ0KCkgbWF5IGNyYXNoIHNvbWUgYnJvd3NlcnMhJyk7CiAgICAgICAgfQogICAgICAgIGlmICh0ZXN0KSB7CiAgICAgICAgICAgIHZhciBzID0gJ3MgJywgYWRkID0gczsKICAgICAgICAgICAgLy8gZ3JvdyBhZGQgZm9yIHNwZWVkCiAgICAgICAgICAgIHdoaWxlIChwdXQoc3RvcmUuX2FyZWEsIHMpKSB7CiAgICAgICAgICAgICAgICBzICs9IGFkZDsKICAgICAgICAgICAgICAgIGlmIChhZGQubGVuZ3RoIDwgNTAwMDApIHsKICAgICAgICAgICAgICAgICAgICBhZGQgPSBzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHNocmluayBhZGQgZm9yIGFjY3VyYWN5CiAgICAgICAgICAgIHdoaWxlIChhZGQubGVuZ3RoID4gMikgewogICAgICAgICAgICAgICAgcyA9IHMuc3Vic3RyaW5nKDAsIHMubGVuZ3RoIC0gKGFkZC5sZW5ndGgvMikpOwogICAgICAgICAgICAgICAgd2hpbGUgKHB1dChzdG9yZS5fYXJlYSwgcykpIHsKICAgICAgICAgICAgICAgICAgICBzICs9IGFkZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGFkZCA9IGFkZC5zdWJzdHJpbmcoYWRkLmxlbmd0aC8yKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfLnJlbW92ZShzdG9yZS5fYXJlYSwgIl9fdGVzdF9fIik7CiAgICAgICAgICAgIHJldHVybiBzLmxlbmd0aCArIDg7CiAgICAgICAgfQogICAgfSk7CiAgICBfLmZuKCdjaGFyc1RvdGFsJywgZnVuY3Rpb24odGVzdCkgewogICAgICAgIHJldHVybiBzdG9yZS5jaGFyc1VzZWQoKSArIHN0b3JlLmNoYXJzTGVmdCh0ZXN0KTsKICAgIH0pOwoKICAgIGZ1bmN0aW9uIHB1dChhcmVhLCBzKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXJlYS5zZXRJdGVtKCJfX3Rlc3RfXyIsIHMpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgfQoKfSkod2luZG93LnN0b3JlLCB3aW5kb3cuc3RvcmUuXyk7Cn0pOwpyZXF1aXJlLnJlZ2lzdGVyKCJzdG9yZS9zcmMvc3RvcmUub2xkLmpzIiwgZnVuY3Rpb24oZXhwb3J0cywgcmVxdWlyZSwgbW9kdWxlKXsKLyoqCiAqIENvcHlyaWdodCAoYykgMjAxMyBFU0hBIFJlc2VhcmNoCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBhbmQgR1BMIGxpY2Vuc2VzOgogKiAgIGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwCiAqICAgaHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzL2dwbC5odG1sCiAqCiAqIElmIGZha2UgKG5vbi1wZXJzaXN0ZW50KSBzdG9yYWdlIGZvciB1c2VycyBzdHVjayBpbiB0aGUgZGFyayBhZ2VzIAogKiBkb2VzIG5vdCBzYXRpc2Z5IHlvdSwgdGhpcyB3aWxsIHJlcGxhY2UgaXQgd2l0aCB0aGUgYSByZWFzb25hYmxlIGltaXRhdG9yIGZvciB0aGVpcgogKiBwYXRoZXRpYywgaW5jb21wZXRlbnQgYnJvd3Nlci4gIE5vdGUgdGhhdCB0aGUgc2Vzc2lvbiByZXBsYWNlbWVudCBoZXJlIGlzIHBvdGVudGlhbGx5CiAqIGluc2VjdXJlIGFzIGl0IHVzZXMgd2luZG93Lm5hbWUgd2l0aG91dCBhbnkgZmFuY3kgcHJvdGVjdGlvbnMuCiAqCiAqIFN0YXR1czogQkVUQSAtIHVuc3VwcG9ydGVkLCB1c2VmdWwsIG5lZWRzIHRlc3RpbmcgJiByZWZpbmluZwogKi8KOyhmdW5jdGlvbih3aW5kb3csIGRvY3VtZW50LCBzdG9yZSwgXykgewoKICAgIGZ1bmN0aW9uIGNyZWF0ZShuYW1lLCBpdGVtcywgdXBkYXRlKSB7CiAgICAgICAgdmFyIGxlbmd0aCA9IDA7CiAgICAgICAgZm9yICh2YXIgayBpbiBpdGVtcykgewogICAgICAgICAgICBpZiAoaXRlbXMuaGFzT3duUHJvcGVydHkoaykpIHsKICAgICAgICAgICAgICAgIGxlbmd0aCsrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBhcmVhID0gXy5pbmhlcml0KF8uc3RvcmFnZUFQSSwgeyBpdGVtczppdGVtcywgbGVuZ3RoOmxlbmd0aCwgbmFtZTpuYW1lIH0pOwogICAgICAgIGlmICh1cGRhdGUpIHsKICAgICAgICAgICAgYWRkVXBkYXRlRm4oYXJlYSwgJ3NldEl0ZW0nLCB1cGRhdGUpOwogICAgICAgICAgICBhZGRVcGRhdGVGbihhcmVhLCAncmVtb3ZlSXRlbScsIHVwZGF0ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhcmVhOwogICAgfQogICAgZnVuY3Rpb24gYWRkVXBkYXRlRm4oYXJlYSwgbmFtZSwgdXBkYXRlKSB7CiAgICAgICAgdmFyIG9sZCA9IGFyZWFbbmFtZV07CiAgICAgICAgYXJlYVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcmV0ID0gb2xkLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIHVwZGF0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH07CiAgICB9CgogICAgaWYgKHN0b3JlLmlzRmFrZSgpKSB7CiAgICAgICAgdmFyIGFyZWE7CgogICAgICAgIGlmIChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuYWRkQmVoYXZpb3IpIHsvLyBJRSB1c2VyRGF0YQogICAgICAgICAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwKICAgICAgICAgICAgICAgIHNuID0gJ2xvY2FsU3RvcmFnZScsCiAgICAgICAgICAgICAgICBib2R5ID0gZG9jdW1lbnQuYm9keSwKICAgICAgICAgICAgICAgIHdyYXAgPSBmdW5jdGlvbiB3cmFwKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBib2R5LmFwcGVuZENoaWxkKGVsKTsKICAgICAgICAgICAgICAgICAgICAgICAgZWwuYWRkQmVoYXZpb3IoJyNkZWZhdWx0I3VzZXJEYXRhJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsLmxvYWQoc24pOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmV0ID0gZm4uYXBwbHkoc3RvcmUuX2FyZWEsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsLnNhdmUoc24pOwogICAgICAgICAgICAgICAgICAgICAgICBib2R5LnJlbW92ZUNoaWxkKGVsKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGhhcyA9IGZ1bmN0aW9uIGhhcyhrZXkpewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbC5nZXRBdHRyaWJ1dGUoa2V5KSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBVc2VyRGF0YVN0b3JhZ2UgPSBmdW5jdGlvbiBVc2VyRGF0YVN0b3JhZ2UoKXt9OwoKICAgICAgICAgICAgVXNlckRhdGFTdG9yYWdlLnByb3RvdHlwZSA9IHsKICAgICAgICAgICAgICAgIGxlbmd0aDogKHdyYXAoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWwuWE1MRG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmF0dHJpYnV0ZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgfSkpKCksCiAgICAgICAgICAgICAgICBoYXM6IHdyYXAoaGFzKSwKICAgICAgICAgICAgICAgIGtleTogd3JhcChmdW5jdGlvbihpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsLlhNTERvY3VtZW50LmRvY3VtZW50RWxlbWVudC5hdHRyaWJ1dGVzW2ldOwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBzZXRJdGVtOiB3cmFwKGZ1bmN0aW9uKGssIHYpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWhhcyhrKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxlbmd0aCsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbC5zZXRBdHRyaWJ1dGUoaywgdik7CiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHJlbW92ZUl0ZW06IHdyYXAoZnVuY3Rpb24oaykgewogICAgICAgICAgICAgICAgICAgIGlmIChoYXMoaykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWwucmVtb3ZlQXR0cmlidXRlKGspOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxlbmd0aC0tOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ2V0SXRlbTogd3JhcChmdW5jdGlvbihrKXsgcmV0dXJuIGVsLmdldEF0dHJpYnV0ZShrKTsgfSksCiAgICAgICAgICAgICAgICBjbGVhcjogd3JhcChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYWxsID0gZWwuWE1MRG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmF0dHJpYnV0ZXM7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaT0wLCBhOyAhIShhID0gYWxsW2ldKTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZShhLm5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9OwogICAgICAgICAgICBhcmVhID0gbmV3IFVzZXJEYXRhU3RvcmFnZSgpOwoKICAgICAgICB9IGVsc2UgaWYgKCdnbG9iYWxTdG9yYWdlJyBpbiB3aW5kb3cgJiYgd2luZG93Lmdsb2JhbFN0b3JhZ2UpIHsvLyBGRiBnbG9iYWxTdG9yYWdlCiAgICAgICAgICAgIGFyZWEgPSBjcmVhdGUoJ2dsb2JhbCcsIHdpbmRvdy5nbG9iYWxTdG9yYWdlW3dpbmRvdy5sb2NhdGlvbi5ob3N0bmFtZV0pOwoKICAgICAgICB9IGVsc2Ugey8vIGNvb2tpZQogICAgICAgICAgICB2YXIgZGF0ZSA9IG5ldyBEYXRlKCksCiAgICAgICAgICAgICAgICBrZXkgPSAnc3RvcmUubG9jYWwnLAogICAgICAgICAgICAgICAgaXRlbXMgPSB7fSwKICAgICAgICAgICAgICAgIGNvb2tpZXMgPSBkb2N1bWVudC5jb29raWUuc3BsaXQoJzsnKTsKICAgICAgICAgICAgZGF0ZS5zZXRUaW1lKGRhdGUuZ2V0VGltZSgpKyg1KjM2NSoyNCo2MCo2MCoxMDAwKSk7Ly81IHllYXJzIG91dAogICAgICAgICAgICBkYXRlID0gZGF0ZS50b0dNVFN0cmluZygpOwogICAgICAgICAgICBmb3IgKHZhciBpPTAsbT1jb29raWVzLmxlbmd0aDsgaTxtOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjID0gY29va2llc1tpXTsKICAgICAgICAgICAgICAgIHdoaWxlIChjLmNoYXJBdCgwKSA9PT0gJyAnKSB7CiAgICAgICAgICAgICAgICAgICAgYyA9IGMuc3Vic3RyaW5nKDEsIGMubGVuZ3RoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChjLmluZGV4T2Yoa2V5KSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGl0ZW1zID0gSlNPTi5wYXJzZShjLnN1YnN0cmluZyhrZXkubGVuZ3RoKzEpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBhcmVhID0gY3JlYXRlKCdjb29raWUnLCBpdGVtcywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5jb29raWUgPSBrZXkrIj0iK0pTT04uc3RyaW5naWZ5KHRoaXMuaXRlbXMpKyI7IGV4cGlyZXM9IitkYXRlKyI7IHBhdGg9LyI7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gcmVwbGFjZSBsb2NhbCdzIGZha2Ugc3RvcmFnZQogICAgICAgIHN0b3JlLl9hcmVhID0gXy5hcmVhcy5sb2NhbCA9IGFyZWE7CiAgICB9CgogICAgaWYgKHN0b3JlLnNlc3Npb24uaXNGYWtlKCkpIHsKICAgICAgICB2YXIgc0l0ZW1zID0gd2luZG93Lm5hbWUgPyBKU09OLnBhcnNlKHdpbmRvdy5uYW1lKVtkb2N1bWVudC5kb21haW5dfHx7fSA6IHt9OwogICAgICAgIHN0b3JlLnNlc3Npb24uX2FyZWEgPSBfLmFyZWFzLnNlc3Npb24gPQogICAgICAgICAgICBjcmVhdGUoJ3dpbmRvd05hbWUnLCBzSXRlbXMsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIG8gPSB7fTsKICAgICAgICAgICAgICAgIG9bZG9jdW1lbnQuZG9tYWluXSA9IHRoaXMuaXRlbXM7CiAgICAgICAgICAgICAgICB3aW5kb3cubmFtZSA9IEpTT04uc3RyaW5naWZ5KG8pOwogICAgICAgICAgICB9KTsKICAgIH0KCn0pKHdpbmRvdywgZG9jdW1lbnQsIHdpbmRvdy5zdG9yZSwgd2luZG93LnN0b3JlLl8pOwoKfSk7CnJlcXVpcmUucmVnaXN0ZXIoInN0b3JlL3NyYy9zdG9yZS5vdmVyZmxvdy5qcyIsIGZ1bmN0aW9uKGV4cG9ydHMsIHJlcXVpcmUsIG1vZHVsZSl7Ci8qKgogKiBDb3B5cmlnaHQgKGMpIDIwMTMgRVNIQSBSZXNlYXJjaAogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgYW5kIEdQTCBsaWNlbnNlczoKICogICBodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocAogKiAgIGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9ncGwuaHRtbAogKgogKiBXaGVuIHF1b3RhIGlzIHJlYWNoZWQgb24gYSBzdG9yYWdlIGFyZWEsIHRoaXMgc2hpZnRzIGluY29taW5nIHZhbHVlcyB0byAKICogZmFrZSBzdG9yYWdlLCBzbyB0aGV5IGxhc3Qgb25seSBhcyBsb25nIGFzIHRoZSBwYWdlIGRvZXMuIFRoaXMgaXMgdXNlZnVsCiAqIGJlY2F1c2UgaXQgaXMgbW9yZSBidXJkZW5zb21lIGZvciBsb2NhbFN0b3JhZ2UgdG8gcmVjb3ZlciBmcm9tIHF1b3RhIGVycm9ycwogKiB0aGFuIGluY29tcGxldGUgY2FjaGVzLiBJbiBvdGhlciB3b3JkcywgaXQgaXMgd2lzZXIgdG8gcmVseSBvbiBzdG9yZS5qcwogKiBuZXZlciBjb21wbGFpbmluZyB0aGFuIG5ldmVyIG1pc3NpbmcgZGF0YS4gWW91IHNob3VsZCBhbHJlYWR5IGJlIGNoZWNraW5nCiAqIHRoZSBpbnRlZ3JpdHkgb2YgY2FjaGVkIGRhdGEgb24gZXZlcnkgcGFnZSBsb2FkLiBBbHNvIG5vdGUgdGhhdCBxdW90YSBlcnJvcnMKICogYXJlIHRocm93biBieSBTYWZhcmkgZm9yICpldmVyeSogc2V0SXRlbSB3aGVuIHVzZXIgaXMgaW4gcHJpdmF0ZSBicm93c2luZyBtb2RlLgogKiBodHRwOi8vc3Bpbi5hdG9taWNvYmplY3QuY29tLzIwMTMvMDEvMjMvaW9zLXByaXZhdGUtYnJvd3NpbmctbG9jYWxzdG9yYWdlLwogKgogKiBTdGF0dXM6IEJFVEEKICovCjsoZnVuY3Rpb24oc3RvcmUsIF8pIHsKICAgIHZhciBfc2V0ID0gXy5zZXQsCiAgICAgICAgX2dldCA9IF8uZ2V0LAogICAgICAgIF9yZW1vdmUgPSBfLnJlbW92ZSwKICAgICAgICBfa2V5ID0gXy5rZXksCiAgICAgICAgX2xlbmd0aCA9IF8ubGVuZ3RoLAogICAgICAgIF9jbGVhciA9IF8uY2xlYXI7CgogICAgXy5vdmVyZmxvdyA9IGZ1bmN0aW9uKGFyZWEsIGNyZWF0ZSkgewogICAgICAgIHZhciBuYW1lID0gYXJlYSA9PT0gXy5hcmVhcy5sb2NhbCA/ICcrbG9jYWwrJyA6CiAgICAgICAgICAgICAgICAgICBhcmVhID09PSBfLmFyZWFzLnNlc3Npb24gPyAnK3Nlc3Npb24rJyA6IGZhbHNlOwogICAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgICAgIHZhciBvdmVyZmxvdyA9IF8uYXJlYXNbbmFtZV07CiAgICAgICAgICAgIGlmIChjcmVhdGUgJiYgIW92ZXJmbG93KSB7CiAgICAgICAgICAgICAgICBvdmVyZmxvdyA9IHN0b3JlLmFyZWEobmFtZSkuX2FyZWE7Ly8gYXJlYSgpIGNvcGllcyB0byBfLmFyZWFzCiAgICAgICAgICAgIH0gZWxzZSBpZiAoY3JlYXRlID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgZGVsZXRlIF8uYXJlYXNbbmFtZV07CiAgICAgICAgICAgICAgICBkZWxldGUgc3RvcmVbbmFtZV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG92ZXJmbG93OwogICAgICAgIH0KICAgIH07CiAgICBfLnNldCA9IGZ1bmN0aW9uKGFyZWEsIGtleSwgc3RyaW5nKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgX3NldC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgaWYgKGUubmFtZSA9PT0gJ1FVT1RBX0VYQ0VFREVEX0VSUicgfHwKICAgICAgICAgICAgICAgIGUubmFtZSA9PT0gJ05TX0VSUk9SX0RPTV9RVU9UQV9SRUFDSEVEJyB8fAogICAgICAgICAgICAgICAgZS50b1N0cmluZygpLmluZGV4T2YoIlFVT1RBX0VYQ0VFREVEX0VSUiIpICE9PSAtMSB8fAogICAgICAgICAgICAgICAgZS50b1N0cmluZygpLmluZGV4T2YoIlF1b3RhRXhjZWVkZWRFcnJvciIpICE9PSAtMSkgewogICAgICAgICAgICAgICAgLy8gdGhlIGUudG9TdHJpbmcgaXMgbmVlZGVkIGZvciBJRTkgLyBJRTEwLCBjb3MgbmFtZSBpcyBlbXB0eSB0aGVyZQogICAgICAgICAgICAgICAgcmV0dXJuIF8uc2V0KF8ub3ZlcmZsb3coYXJlYSwgdHJ1ZSksIGtleSwgc3RyaW5nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgIH0KICAgIH07CiAgICBfLmdldCA9IGZ1bmN0aW9uKGFyZWEsIGtleSkgewogICAgICAgIHZhciBvdmVyZmxvdyA9IF8ub3ZlcmZsb3coYXJlYSk7CiAgICAgICAgcmV0dXJuIChvdmVyZmxvdyAmJiBfZ2V0LmNhbGwodGhpcywgb3ZlcmZsb3csIGtleSkpIHx8CiAgICAgICAgICAgIF9nZXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH07CiAgICBfLnJlbW92ZSA9IGZ1bmN0aW9uKGFyZWEsIGtleSkgewogICAgICAgIHZhciBvdmVyZmxvdyA9IF8ub3ZlcmZsb3coYXJlYSk7CiAgICAgICAgaWYgKG92ZXJmbG93KXsgX3JlbW92ZS5jYWxsKHRoaXMsIG92ZXJmbG93LCBrZXkpOyB9CiAgICAgICAgX3JlbW92ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfTsKICAgIF8ua2V5ID0gZnVuY3Rpb24oYXJlYSwgaSkgewogICAgICAgIHZhciBvdmVyZmxvdyA9IF8ub3ZlcmZsb3coYXJlYSk7CiAgICAgICAgaWYgKG92ZXJmbG93KSB7CiAgICAgICAgICAgIHZhciBsID0gX2xlbmd0aC5jYWxsKHRoaXMsIGFyZWEpOwogICAgICAgICAgICBpZiAoaSA+PSBsKSB7CiAgICAgICAgICAgICAgICBpID0gaSAtIGw7Ly8gbWFrZSBpIG92ZXJmbG93LXJlbGF0aXZlCiAgICAgICAgICAgICAgICBmb3IgKHZhciBqPTAsIG09X2xlbmd0aC5jYWxsKHRoaXMsIG92ZXJmbG93KTsgajxtOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaiA9PT0gaSkgey8vIGogaXMgb3ZlcmZsb3cgaW5kZXgKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9rZXkuY2FsbCh0aGlzLCBvdmVyZmxvdywgaik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBfa2V5LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9OwogICAgXy5sZW5ndGggPSBmdW5jdGlvbihhcmVhKSB7CiAgICAgICAgdmFyIGxlbmd0aCA9IF9sZW5ndGgoYXJlYSksCiAgICAgICAgICAgIG92ZXJmbG93ID0gXy5vdmVyZmxvdyhhcmVhKTsKICAgICAgICByZXR1cm4gb3ZlcmZsb3cgPyBsZW5ndGggKyBfbGVuZ3RoKG92ZXJmbG93KSA6IGxlbmd0aDsKICAgIH07CiAgICBfLmNsZWFyID0gZnVuY3Rpb24oYXJlYSkgewogICAgICAgIF8ub3ZlcmZsb3coYXJlYSwgZmFsc2UpOwogICAgICAgIF9jbGVhci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfTsKCn0pKHdpbmRvdy5zdG9yZSwgd2luZG93LnN0b3JlLl8pOwoKfSk7CnJlcXVpcmUucmVnaXN0ZXIoInN0b3JlL3NyYy9zdG9yZS5xdW90YS5qcyIsIGZ1bmN0aW9uKGV4cG9ydHMsIHJlcXVpcmUsIG1vZHVsZSl7Ci8qKgogKiBDb3B5cmlnaHQgKGMpIDIwMTMgRVNIQSBSZXNlYXJjaAogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgYW5kIEdQTCBsaWNlbnNlczoKICogICBodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocAogKiAgIGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9ncGwuaHRtbAogKgogKiBCaW5kIGhhbmRsZXJzIHRvIHF1b3RhIGVycm9yczoKICogICBzdG9yZS5xdW90YShmdW5jdGlvbihlLCBhcmVhLCBrZXksIHN0cikgewogKiAgICAgIGNvbnNvbGUubG9nKGUsIGFyZWEsIGtleSwgc3RyKTsKICogICB9KTsKICogSWYgYSBoYW5kbGVyIHJldHVybnMgdHJ1ZSBvdGhlciBoYW5kbGVycyBhcmUgbm90IGNhbGxlZCBhbmQKICogdGhlIGVycm9yIGlzIHN1cHByZXNzZWQuCiAqCiAqIFRoaW5rIHF1b3RhIGVycm9ycyB3aWxsIG5ldmVyIGhhcHBlbiB0byB5b3U/IFRoaW5rIGFnYWluOgogKiBodHRwOi8vc3Bpbi5hdG9taWNvYmplY3QuY29tLzIwMTMvMDEvMjMvaW9zLXByaXZhdGUtYnJvd3NpbmctbG9jYWxzdG9yYWdlLwogKiAodGhpcyBhZmZlY3RzIHNlc3Npb25TdG9yYWdlIHRvbykKICoKICogU3RhdHVzOiBBTFBIQSAtIEFQSSBjb3VsZCB1c2UgdW5iaW5kIGZlYXR1cmUKICovCjsoZnVuY3Rpb24oc3RvcmUsIF8pIHsKCiAgICBzdG9yZS5xdW90YSA9IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgc3RvcmUucXVvdGEuZm5zLnB1c2goZm4pOwogICAgfTsKICAgIHN0b3JlLnF1b3RhLmZucyA9IFtdOwoKICAgIHZhciBfc2V0ID0gXy5zZXQ7CiAgICBfLnNldCA9IGZ1bmN0aW9uKGFyZWEsIGtleSwgc3RyKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgX3NldC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgaWYgKGUubmFtZSA9PT0gJ1FVT1RBX0VYQ0VFREVEX0VSUicgfHwKICAgICAgICAgICAgICAgIGUubmFtZSA9PT0gJ05TX0VSUk9SX0RPTV9RVU9UQV9SRUFDSEVEJykgewogICAgICAgICAgICAgICAgdmFyIGZucyA9IHN0b3JlLnF1b3RhLmZuczsKICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MCxtPWZucy5sZW5ndGg7IGk8bTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRydWUgPT09IGZuc1tpXS5jYWxsKHRoaXMsIGUsIGFyZWEsIGtleSwgc3RyKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgfQogICAgfTsKCn0pKHdpbmRvdy5zdG9yZSwgd2luZG93LnN0b3JlLl8pOwp9KTsKcmVxdWlyZS5hbGlhcygic3RvcmUvZGlzdC9zdG9yZTIuanMiLCAic3RvcmUvaW5kZXguanMiKTsKCmlmICh0eXBlb2YgZXhwb3J0cyA9PSAib2JqZWN0IikgewogIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgic3RvcmUiKTsKfSBlbHNlIGlmICh0eXBlb2YgZGVmaW5lID09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgewogIGRlZmluZShmdW5jdGlvbigpeyByZXR1cm4gcmVxdWlyZSgic3RvcmUiKTsgfSk7Cn0gZWxzZSB7CiAgdGhpc1sic3RvcmUiXSA9IHJlcXVpcmUoInN0b3JlIik7Cn19KSgpOw==",
                "body": "OyhmdW5jdGlvbigpewoKLyoqCiAqIFJlcXVpcmUgdGhlIGdpdmVuIHBhdGguCiAqCiAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoCiAqIEByZXR1cm4ge09iamVjdH0gZXhwb3J0cwogKiBAYXBpIHB1YmxpYwogKi8KCmZ1bmN0aW9uIHJlcXVpcmUocGF0aCwgcGFyZW50LCBvcmlnKSB7CiAgdmFyIHJlc29sdmVkID0gcmVxdWlyZS5yZXNvbHZlKHBhdGgpOwoKICAvLyBsb29rdXAgZmFpbGVkCiAgaWYgKG51bGwgPT0gcmVzb2x2ZWQpIHsKICAgIG9yaWcgPSBvcmlnIHx8IHBhdGg7CiAgICBwYXJlbnQgPSBwYXJlbnQgfHwgJ3Jvb3QnOwogICAgdmFyIGVyciA9IG5ldyBFcnJvcignRmFpbGVkIHRvIHJlcXVpcmUgIicgKyBvcmlnICsgJyIgZnJvbSAiJyArIHBhcmVudCArICciJyk7CiAgICBlcnIucGF0aCA9IG9yaWc7CiAgICBlcnIucGFyZW50ID0gcGFyZW50OwogICAgZXJyLnJlcXVpcmUgPSB0cnVlOwogICAgdGhyb3cgZXJyOwogIH0KCiAgdmFyIG1vZHVsZSA9IHJlcXVpcmUubW9kdWxlc1tyZXNvbHZlZF07CgogIC8vIHBlcmZvcm0gcmVhbCByZXF1aXJlKCkKICAvLyBieSBpbnZva2luZyB0aGUgbW9kdWxlJ3MKICAvLyByZWdpc3RlcmVkIGZ1bmN0aW9uCiAgaWYgKCFtb2R1bGUuZXhwb3J0cykgewogICAgbW9kdWxlLmV4cG9ydHMgPSB7fTsKICAgIG1vZHVsZS5jbGllbnQgPSBtb2R1bGUuY29tcG9uZW50ID0gdHJ1ZTsKICAgIG1vZHVsZS5jYWxsKHRoaXMsIG1vZHVsZS5leHBvcnRzLCByZXF1aXJlLnJlbGF0aXZlKHJlc29sdmVkKSwgbW9kdWxlKTsKICB9CgogIHJldHVybiBtb2R1bGUuZXhwb3J0czsKfQoKLyoqCiAqIFJlZ2lzdGVyZWQgbW9kdWxlcy4KICovCgpyZXF1aXJlLm1vZHVsZXMgPSB7fTsKCi8qKgogKiBSZWdpc3RlcmVkIGFsaWFzZXMuCiAqLwoKcmVxdWlyZS5hbGlhc2VzID0ge307CgovKioKICogUmVzb2x2ZSBgcGF0aGAuCiAqCiAqIExvb2t1cDoKICoKICogICAtIFBBVEgvaW5kZXguanMKICogICAtIFBBVEguanMKICogICAtIFBBVEgKICoKICogQHBhcmFtIHtTdHJpbmd9IHBhdGgKICogQHJldHVybiB7U3RyaW5nfSBwYXRoIG9yIG51bGwKICogQGFwaSBwcml2YXRlCiAqLwoKcmVxdWlyZS5yZXNvbHZlID0gZnVuY3Rpb24ocGF0aCkgewogIGlmIChwYXRoLmNoYXJBdCgwKSA9PT0gJy8nKSBwYXRoID0gcGF0aC5zbGljZSgxKTsKCiAgdmFyIHBhdGhzID0gWwogICAgcGF0aCwKICAgIHBhdGggKyAnLmpzJywKICAgIHBhdGggKyAnLmpzb24nLAogICAgcGF0aCArICcvaW5kZXguanMnLAogICAgcGF0aCArICcvaW5kZXguanNvbicKICBdOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IHBhdGhzLmxlbmd0aDsgaSsrKSB7CiAgICB2YXIgcGF0aCA9IHBhdGhzW2ldOwogICAgaWYgKHJlcXVpcmUubW9kdWxlcy5oYXNPd25Qcm9wZXJ0eShwYXRoKSkgcmV0dXJuIHBhdGg7CiAgICBpZiAocmVxdWlyZS5hbGlhc2VzLmhhc093blByb3BlcnR5KHBhdGgpKSByZXR1cm4gcmVxdWlyZS5hbGlhc2VzW3BhdGhdOwogIH0KfTsKCi8qKgogKiBOb3JtYWxpemUgYHBhdGhgIHJlbGF0aXZlIHRvIHRoZSBjdXJyZW50IHBhdGguCiAqCiAqIEBwYXJhbSB7U3RyaW5nfSBjdXJyCiAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoCiAqIEByZXR1cm4ge1N0cmluZ30KICogQGFwaSBwcml2YXRlCiAqLwoKcmVxdWlyZS5ub3JtYWxpemUgPSBmdW5jdGlvbihjdXJyLCBwYXRoKSB7CiAgdmFyIHNlZ3MgPSBbXTsKCiAgaWYgKCcuJyAhPSBwYXRoLmNoYXJBdCgwKSkgcmV0dXJuIHBhdGg7CgogIGN1cnIgPSBjdXJyLnNwbGl0KCcvJyk7CiAgcGF0aCA9IHBhdGguc3BsaXQoJy8nKTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXRoLmxlbmd0aDsgKytpKSB7CiAgICBpZiAoJy4uJyA9PSBwYXRoW2ldKSB7CiAgICAgIGN1cnIucG9wKCk7CiAgICB9IGVsc2UgaWYgKCcuJyAhPSBwYXRoW2ldICYmICcnICE9IHBhdGhbaV0pIHsKICAgICAgc2Vncy5wdXNoKHBhdGhbaV0pOwogICAgfQogIH0KCiAgcmV0dXJuIGN1cnIuY29uY2F0KHNlZ3MpLmpvaW4oJy8nKTsKfTsKCi8qKgogKiBSZWdpc3RlciBtb2R1bGUgYXQgYHBhdGhgIHdpdGggY2FsbGJhY2sgYGRlZmluaXRpb25gLgogKgogKiBAcGFyYW0ge1N0cmluZ30gcGF0aAogKiBAcGFyYW0ge0Z1bmN0aW9ufSBkZWZpbml0aW9uCiAqIEBhcGkgcHJpdmF0ZQogKi8KCnJlcXVpcmUucmVnaXN0ZXIgPSBmdW5jdGlvbihwYXRoLCBkZWZpbml0aW9uKSB7CiAgcmVxdWlyZS5tb2R1bGVzW3BhdGhdID0gZGVmaW5pdGlvbjsKfTsKCi8qKgogKiBBbGlhcyBhIG1vZHVsZSBkZWZpbml0aW9uLgogKgogKiBAcGFyYW0ge1N0cmluZ30gZnJvbQogKiBAcGFyYW0ge1N0cmluZ30gdG8KICogQGFwaSBwcml2YXRlCiAqLwoKcmVxdWlyZS5hbGlhcyA9IGZ1bmN0aW9uKGZyb20sIHRvKSB7CiAgaWYgKCFyZXF1aXJlLm1vZHVsZXMuaGFzT3duUHJvcGVydHkoZnJvbSkpIHsKICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIGFsaWFzICInICsgZnJvbSArICciLCBpdCBkb2VzIG5vdCBleGlzdCcpOwogIH0KICByZXF1aXJlLmFsaWFzZXNbdG9dID0gZnJvbTsKfTsKCi8qKgogKiBSZXR1cm4gYSByZXF1aXJlIGZ1bmN0aW9uIHJlbGF0aXZlIHRvIHRoZSBgcGFyZW50YCBwYXRoLgogKgogKiBAcGFyYW0ge1N0cmluZ30gcGFyZW50CiAqIEByZXR1cm4ge0Z1bmN0aW9ufQogKiBAYXBpIHByaXZhdGUKICovCgpyZXF1aXJlLnJlbGF0aXZlID0gZnVuY3Rpb24ocGFyZW50KSB7CiAgdmFyIHAgPSByZXF1aXJlLm5vcm1hbGl6ZShwYXJlbnQsICcuLicpOwoKICAvKioKICAgKiBsYXN0SW5kZXhPZiBoZWxwZXIuCiAgICovCgogIGZ1bmN0aW9uIGxhc3RJbmRleE9mKGFyciwgb2JqKSB7CiAgICB2YXIgaSA9IGFyci5sZW5ndGg7CiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIGlmIChhcnJbaV0gPT09IG9iaikgcmV0dXJuIGk7CiAgICB9CiAgICByZXR1cm4gLTE7CiAgfQoKICAvKioKICAgKiBUaGUgcmVsYXRpdmUgcmVxdWlyZSgpIGl0c2VsZi4KICAgKi8KCiAgZnVuY3Rpb24gbG9jYWxSZXF1aXJlKHBhdGgpIHsKICAgIHZhciByZXNvbHZlZCA9IGxvY2FsUmVxdWlyZS5yZXNvbHZlKHBhdGgpOwogICAgcmV0dXJuIHJlcXVpcmUocmVzb2x2ZWQsIHBhcmVudCwgcGF0aCk7CiAgfQoKICAvKioKICAgKiBSZXNvbHZlIHJlbGF0aXZlIHRvIHRoZSBwYXJlbnQuCiAgICovCgogIGxvY2FsUmVxdWlyZS5yZXNvbHZlID0gZnVuY3Rpb24ocGF0aCkgewogICAgdmFyIGMgPSBwYXRoLmNoYXJBdCgwKTsKICAgIGlmICgnLycgPT0gYykgcmV0dXJuIHBhdGguc2xpY2UoMSk7CiAgICBpZiAoJy4nID09IGMpIHJldHVybiByZXF1aXJlLm5vcm1hbGl6ZShwLCBwYXRoKTsKCiAgICAvLyByZXNvbHZlIGRlcHMgYnkgcmV0dXJuaW5nCiAgICAvLyB0aGUgZGVwIGluIHRoZSBuZWFyZXN0ICJkZXBzIgogICAgLy8gZGlyZWN0b3J5CiAgICB2YXIgc2VncyA9IHBhcmVudC5zcGxpdCgnLycpOwogICAgdmFyIGkgPSBsYXN0SW5kZXhPZihzZWdzLCAnZGVwcycpICsgMTsKICAgIGlmICghaSkgaSA9IDA7CiAgICBwYXRoID0gc2Vncy5zbGljZSgwLCBpICsgMSkuam9pbignLycpICsgJy9kZXBzLycgKyBwYXRoOwogICAgcmV0dXJuIHBhdGg7CiAgfTsKCiAgLyoqCiAgICogQ2hlY2sgaWYgbW9kdWxlIGlzIGRlZmluZWQgYXQgYHBhdGhgLgogICAqLwoKICBsb2NhbFJlcXVpcmUuZXhpc3RzID0gZnVuY3Rpb24ocGF0aCkgewogICAgcmV0dXJuIHJlcXVpcmUubW9kdWxlcy5oYXNPd25Qcm9wZXJ0eShsb2NhbFJlcXVpcmUucmVzb2x2ZShwYXRoKSk7CiAgfTsKCiAgcmV0dXJuIGxvY2FsUmVxdWlyZTsKfTsKcmVxdWlyZS5yZWdpc3Rlcigic3RvcmUvZGlzdC9zdG9yZTIuanMiLCBmdW5jdGlvbihleHBvcnRzLCByZXF1aXJlLCBtb2R1bGUpewovKiEgc3RvcmUyIC0gdjIuMS42IC0gMjAxNC0wNC0wOAoqIENvcHlyaWdodCAoYykgMjAxNCBOYXRoYW4gQnVibmE7IExpY2Vuc2VkIE1JVCwgR1BMICovCjsoZnVuY3Rpb24od2luZG93LCBkZWZpbmUpIHsKICAgIHZhciBfID0gewogICAgICAgIHZlcnNpb246ICIyLjEuNiIsCiAgICAgICAgYXJlYXM6IHt9LAogICAgICAgIGFwaXM6IHt9LAoKICAgICAgICAvLyB1dGlsaXRpZXMKICAgICAgICBpbmhlcml0OiBmdW5jdGlvbihhcGksIG8pIHsKICAgICAgICAgICAgZm9yICh2YXIgcCBpbiBhcGkpIHsKICAgICAgICAgICAgICAgIGlmICghby5oYXNPd25Qcm9wZXJ0eShwKSkgewogICAgICAgICAgICAgICAgICAgIG9bcF0gPSBhcGlbcF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG87CiAgICAgICAgfSwKICAgICAgICBzdHJpbmdpZnk6IGZ1bmN0aW9uKGQpIHsKICAgICAgICAgICAgcmV0dXJuIGQgPT09IHVuZGVmaW5lZCB8fCB0eXBlb2YgZCA9PT0gImZ1bmN0aW9uIiA/IGQrJycgOiBKU09OLnN0cmluZ2lmeShkKTsKICAgICAgICB9LAogICAgICAgIHBhcnNlOiBmdW5jdGlvbihzKSB7CiAgICAgICAgICAgIC8vIGlmIGl0IGRvZXNuJ3QgcGFyc2UsIHJldHVybiBhcyBpcwogICAgICAgICAgICB0cnl7IHJldHVybiBKU09OLnBhcnNlKHMpOyB9Y2F0Y2goZSl7IHJldHVybiBzOyB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gZXh0ZW5zaW9uIGhvb2tzCiAgICAgICAgZm46IGZ1bmN0aW9uKG5hbWUsIGZuKSB7CiAgICAgICAgICAgIF8uc3RvcmVBUElbbmFtZV0gPSBmbjsKICAgICAgICAgICAgZm9yICh2YXIgYXBpIGluIF8uYXBpcykgewogICAgICAgICAgICAgICAgXy5hcGlzW2FwaV1bbmFtZV0gPSBmbjsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZ2V0OiBmdW5jdGlvbihhcmVhLCBrZXkpeyByZXR1cm4gYXJlYS5nZXRJdGVtKGtleSk7IH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbihhcmVhLCBrZXksIHN0cmluZyl7IGFyZWEuc2V0SXRlbShrZXksIHN0cmluZyk7IH0sCiAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbihhcmVhLCBrZXkpeyBhcmVhLnJlbW92ZUl0ZW0oa2V5KTsgfSwKICAgICAgICBrZXk6IGZ1bmN0aW9uKGFyZWEsIGkpeyByZXR1cm4gYXJlYS5rZXkoaSk7IH0sCiAgICAgICAgbGVuZ3RoOiBmdW5jdGlvbihhcmVhKXsgcmV0dXJuIGFyZWEubGVuZ3RoOyB9LAogICAgICAgIGNsZWFyOiBmdW5jdGlvbihhcmVhKXsgYXJlYS5jbGVhcigpOyB9LAoKICAgICAgICAvLyBjb3JlIGZ1bmN0aW9ucwogICAgICAgIFN0b3JlOiBmdW5jdGlvbihpZCwgYXJlYSwgbmFtZXNwYWNlKSB7CiAgICAgICAgICAgIHZhciBzdG9yZSA9IF8uaW5oZXJpdChfLnN0b3JlQVBJLCBmdW5jdGlvbihrZXksIGRhdGEsIG92ZXJ3cml0ZSkgewogICAgICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApeyByZXR1cm4gc3RvcmUuZ2V0QWxsKCk7IH0KICAgICAgICAgICAgICAgIGlmIChkYXRhICE9PSB1bmRlZmluZWQpeyByZXR1cm4gc3RvcmUuc2V0KGtleSwgZGF0YSwgb3ZlcndyaXRlKTsgfQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICJzdHJpbmciKXsgcmV0dXJuIHN0b3JlLmdldChrZXkpOyB9CiAgICAgICAgICAgICAgICBpZiAoIWtleSl7IHJldHVybiBzdG9yZS5jbGVhcigpOyB9CiAgICAgICAgICAgICAgICByZXR1cm4gc3RvcmUuc2V0QWxsKGtleSwgZGF0YSk7Ly8gb3ZlcndyaXRlPWRhdGEsIGRhdGE9a2V5CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzdG9yZS5faWQgPSBpZDsKICAgICAgICAgICAgc3RvcmUuX2FyZWEgPSBhcmVhIHx8IF8uaW5oZXJpdChfLnN0b3JhZ2VBUEksIHsgaXRlbXM6IHt9LCBuYW1lOiAnZmFrZScgfSk7CiAgICAgICAgICAgIHN0b3JlLl9ucyA9IG5hbWVzcGFjZSB8fCAnJzsKICAgICAgICAgICAgaWYgKCFfLmFyZWFzW2lkXSkgewogICAgICAgICAgICAgICAgXy5hcmVhc1tpZF0gPSBzdG9yZS5fYXJlYTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIV8uYXBpc1tzdG9yZS5fbnMrc3RvcmUuX2lkXSkgewogICAgICAgICAgICAgICAgXy5hcGlzW3N0b3JlLl9ucytzdG9yZS5faWRdID0gc3RvcmU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN0b3JlOwogICAgICAgIH0sCiAgICAgICAgc3RvcmVBUEk6IHsKICAgICAgICAgICAgLy8gYWRtaW4gZnVuY3Rpb25zCiAgICAgICAgICAgIGFyZWE6IGZ1bmN0aW9uKGlkLCBhcmVhKSB7CiAgICAgICAgICAgICAgICB2YXIgc3RvcmUgPSB0aGlzW2lkXTsKICAgICAgICAgICAgICAgIGlmICghc3RvcmUgfHwgIXN0b3JlLmFyZWEpIHsKICAgICAgICAgICAgICAgICAgICBzdG9yZSA9IF8uU3RvcmUoaWQsIGFyZWEsIHRoaXMuX25zKTsvL25ldyBhcmVhLXNwZWNpZmljIGFwaSBpbiB0aGlzIG5hbWVzcGFjZQogICAgICAgICAgICAgICAgICAgIGlmICghdGhpc1tpZF0peyB0aGlzW2lkXSA9IHN0b3JlOyB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gc3RvcmU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG5hbWVzcGFjZTogZnVuY3Rpb24obmFtZXNwYWNlLCBub1Nlc3Npb24pIHsKICAgICAgICAgICAgICAgIGlmICghbmFtZXNwYWNlKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fbnMgPyB0aGlzLl9ucy5zdWJzdHJpbmcoMCx0aGlzLl9ucy5sZW5ndGgtMSkgOiAnJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBucyA9IG5hbWVzcGFjZSwgc3RvcmUgPSB0aGlzW25zXTsKICAgICAgICAgICAgICAgIGlmICghc3RvcmUgfHwgIXN0b3JlLm5hbWVzcGFjZSkgewogICAgICAgICAgICAgICAgICAgIHN0b3JlID0gXy5TdG9yZSh0aGlzLl9pZCwgdGhpcy5fYXJlYSwgdGhpcy5fbnMrbnMrJy4nKTsvL25ldyBuYW1lc3BhY2VkIGFwaQogICAgICAgICAgICAgICAgICAgIGlmICghdGhpc1tuc10peyB0aGlzW25zXSA9IHN0b3JlOyB9CiAgICAgICAgICAgICAgICAgICAgaWYgKCFub1Nlc3Npb24peyBzdG9yZS5hcmVhKCdzZXNzaW9uJywgXy5hcmVhcy5zZXNzaW9uKTsgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHN0b3JlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBpc0Zha2U6IGZ1bmN0aW9uKCl7IHJldHVybiB0aGlzLl9hcmVhLm5hbWUgPT09ICdmYWtlJzsgfSwKICAgICAgICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuICdzdG9yZScrKHRoaXMuX25zPycuJyt0aGlzLm5hbWVzcGFjZSgpOicnKSsnWycrdGhpcy5faWQrJ10nOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gc3RvcmFnZSBmdW5jdGlvbnMKICAgICAgICAgICAgaGFzOiBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9hcmVhLmhhcykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9hcmVhLmhhcyh0aGlzLl9pbihrZXkpKTsvL2V4dGVuc2lvbiBob29rCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gISEodGhpcy5faW4oa2V5KSBpbiB0aGlzLl9hcmVhKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2l6ZTogZnVuY3Rpb24oKXsgcmV0dXJuIHRoaXMua2V5cygpLmxlbmd0aDsgfSwKICAgICAgICAgICAgZWFjaDogZnVuY3Rpb24oZm4sIGFuZCkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaT0wLCBtPV8ubGVuZ3RoKHRoaXMuX2FyZWEpOyBpPG07IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBrZXkgPSB0aGlzLl9vdXQoXy5rZXkodGhpcy5fYXJlYSwgaSkpOwogICAgICAgICAgICAgICAgICAgIGlmIChrZXkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4uY2FsbCh0aGlzLCBrZXksIGFuZCB8fCB0aGlzLmdldChrZXkpKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChtID4gXy5sZW5ndGgodGhpcy5fYXJlYSkpIHsgbS0tOyBpLS07IH0vLyBpbiBjYXNlIG9mIHJlbW92ZUl0ZW0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhbmQgfHwgdGhpczsKICAgICAgICAgICAgfSwKICAgICAgICAgICAga2V5czogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGssIGxpc3QpeyBsaXN0LnB1c2goayk7IH0sIFtdKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbihrZXksIGFsdCkgewogICAgICAgICAgICAgICAgdmFyIHMgPSBfLmdldCh0aGlzLl9hcmVhLCB0aGlzLl9pbihrZXkpKTsKICAgICAgICAgICAgICAgIHJldHVybiBzICE9PSBudWxsID8gXy5wYXJzZShzKSA6IGFsdCB8fCBzOy8vIHN1cHBvcnQgYWx0IGZvciBlYXN5IGRlZmF1bHQgbWdtdAogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXRBbGw6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihrLCBhbGwpeyBhbGxba10gPSB0aGlzLmdldChrKTsgfSwge30pOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgZGF0YSwgb3ZlcndyaXRlKSB7CiAgICAgICAgICAgICAgICB2YXIgZCA9IHRoaXMuZ2V0KGtleSk7CiAgICAgICAgICAgICAgICBpZiAoZCAhPSBudWxsICYmIG92ZXJ3cml0ZSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBfLnNldCh0aGlzLl9hcmVhLCB0aGlzLl9pbihrZXkpLCBfLnN0cmluZ2lmeShkYXRhKSwgb3ZlcndyaXRlKSB8fCBkOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXRBbGw6IGZ1bmN0aW9uKGRhdGEsIG92ZXJ3cml0ZSkgewogICAgICAgICAgICAgICAgdmFyIGNoYW5nZWQsIHZhbDsKICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsID0gZGF0YVtrZXldOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnNldChrZXksIHZhbCwgb3ZlcndyaXRlKSAhPT0gdmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5nZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBjaGFuZ2VkOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICAgICAgdmFyIGQgPSB0aGlzLmdldChrZXkpOwogICAgICAgICAgICAgICAgXy5yZW1vdmUodGhpcy5fYXJlYSwgdGhpcy5faW4oa2V5KSk7CiAgICAgICAgICAgICAgICByZXR1cm4gZDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2xlYXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9ucykgewogICAgICAgICAgICAgICAgICAgIF8uY2xlYXIodGhpcy5fYXJlYSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbihrKXsgXy5yZW1vdmUodGhpcy5fYXJlYSwgdGhpcy5faW4oaykpOyB9LCAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjbGVhckFsbDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJlYSA9IHRoaXMuX2FyZWE7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpZCBpbiBfLmFyZWFzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKF8uYXJlYXMuaGFzT3duUHJvcGVydHkoaWQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2FyZWEgPSBfLmFyZWFzW2lkXTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2FyZWEgPSBhcmVhOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBpbnRlcm5hbCB1c2UgZnVuY3Rpb25zCiAgICAgICAgICAgIF9pbjogZnVuY3Rpb24oaykgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBrICE9PSAic3RyaW5nIil7IGsgPSBfLnN0cmluZ2lmeShrKTsgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX25zID8gdGhpcy5fbnMgKyBrIDogazsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX291dDogZnVuY3Rpb24oaykgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX25zID8KICAgICAgICAgICAgICAgICAgICBrICYmIGsuaW5kZXhPZih0aGlzLl9ucykgPT09IDAgPwogICAgICAgICAgICAgICAgICAgICAgICBrLnN1YnN0cmluZyh0aGlzLl9ucy5sZW5ndGgpIDoKICAgICAgICAgICAgICAgICAgICAgICAgdW5kZWZpbmVkIDogLy8gc28gZWFjaCgpIGtub3dzIHRvIHNraXAgaXQKICAgICAgICAgICAgICAgICAgICBrOwogICAgICAgICAgICB9CiAgICAgICAgfSwvLyBlbmQgXy5zdG9yZUFQSQogICAgICAgIHN0b3JhZ2VBUEk6IHsKICAgICAgICAgICAgbGVuZ3RoOiAwLAogICAgICAgICAgICBoYXM6IGZ1bmN0aW9uKGspeyByZXR1cm4gdGhpcy5pdGVtcy5oYXNPd25Qcm9wZXJ0eShrKTsgfSwKICAgICAgICAgICAga2V5OiBmdW5jdGlvbihpKSB7CiAgICAgICAgICAgICAgICB2YXIgYyA9IDA7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBrIGluIHRoaXMuaXRlbXMpewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmhhcyhrKSAmJiBpID09PSBjKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXRJdGVtOiBmdW5jdGlvbihrLCB2KSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaGFzKGspKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sZW5ndGgrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuaXRlbXNba10gPSB2OwogICAgICAgICAgICB9LAogICAgICAgICAgICByZW1vdmVJdGVtOiBmdW5jdGlvbihrKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXMoaykpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5pdGVtc1trXTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmxlbmd0aC0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXRJdGVtOiBmdW5jdGlvbihrKXsgcmV0dXJuIHRoaXMuaGFzKGspID8gdGhpcy5pdGVtc1trXSA6IG51bGw7IH0sCiAgICAgICAgICAgIGNsZWFyOiBmdW5jdGlvbigpeyBmb3IgKHZhciBrIGluIHRoaXMubGlzdCl7IHRoaXMucmVtb3ZlSXRlbShrKTsgfSB9LAogICAgICAgICAgICB0b1N0cmluZzogZnVuY3Rpb24oKXsgcmV0dXJuIHRoaXMubGVuZ3RoKycgaXRlbXMgaW4gJyt0aGlzLm5hbWUrJ1N0b3JhZ2UnOyB9CiAgICAgICAgfS8vIGVuZCBfLnN0b3JhZ2VBUEkKICAgIH07CgogICAgLy8gc2V0dXAgdGhlIHByaW1hcnkgc3RvcmUgZm4KICAgIGlmICh3aW5kb3cuc3RvcmUpeyBfLmNvbmZsaWN0ID0gd2luZG93LnN0b3JlOyB9CiAgICB2YXIgc3RvcmUgPQogICAgICAgIC8vIHNhZmVseSBzZXQgdGhpcyB1cCAodGhyb3dzIGVycm9yIGluIElFMTAvMzJiaXQgbW9kZSBmb3IgbG9jYWwgZmlsZXMpCiAgICAgICAgXy5TdG9yZSgibG9jYWwiLCAoZnVuY3Rpb24oKXt0cnl7IHJldHVybiBsb2NhbFN0b3JhZ2U7IH1jYXRjaChlKXt9fSkoKSk7CiAgICBzdG9yZS5sb2NhbCA9IHN0b3JlOy8vIGZvciBjb21wbGV0ZW5lc3MKICAgIHN0b3JlLl8gPSBfOy8vIGZvciBleHRlbmRlcnMgYW5kIGRlYnVnZ2Vycy4uLgogICAgLy8gc2FmZWx5IHNldHVwIHN0b3JlLnNlc3Npb24gKHRocm93cyBleGNlcHRpb24gaW4gRkYgZm9yIGZpbGU6Ly8vIHVybHMpCiAgICBzdG9yZS5hcmVhKCJzZXNzaW9uIiwgKGZ1bmN0aW9uKCl7dHJ5eyByZXR1cm4gc2Vzc2lvblN0b3JhZ2U7IH1jYXRjaChlKXt9fSkoKSk7CgogICAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgZGVmaW5lKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHN0b3JlOwogICAgICAgIH0pOwogICAgfSBlbHNlIGlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyAmJiBtb2R1bGUuZXhwb3J0cykgewogICAgICAgIG1vZHVsZS5leHBvcnRzID0gc3RvcmU7CiAgICB9IGVsc2UgewogICAgICAgIHdpbmRvdy5zdG9yZSA9IHN0b3JlOwogICAgfQoKfSkod2luZG93LCB3aW5kb3cuZGVmaW5lKTsKCn0pOwpyZXF1aXJlLnJlZ2lzdGVyKCJzdG9yZS9zcmMvc3RvcmUub24uanMiLCBmdW5jdGlvbihleHBvcnRzLCByZXF1aXJlLCBtb2R1bGUpewovKioKICogQ29weXJpZ2h0IChjKSAyMDEzIEVTSEEgUmVzZWFyY2gKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXM6CiAqICAgaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHAKICogICBodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvZ3BsLmh0bWwKICoKICogTWFrZXMgaXQgZWFzeSB0byB3YXRjaCBmb3Igc3RvcmFnZSBldmVudHMgYnkgZW5oYW5jaW5nIHRoZSBldmVudHMgYW5kCiAqIGFsbG93aW5nIGJpbmRpbmcgdG8gcGFydGljdWxhciBrZXlzIGFuZC9vciBuYW1lc3BhY2VzLgogKgogKiAvLyBsaXN0ZW4gdG8gcGFydGljdWxhciBrZXkgc3RvcmFnZSBldmVudHMgKHllcywgdGhpcyBpcyBuYW1lc3BhY2Ugc2Vuc2l0aXZlKQogKiBzdG9yZS5vbignZm9vJywgZnVuY3Rpb24gbGlzdGVuVG9Gb28oZSl7IGNvbnNvbGUubG9nKCdmb28gd2FzIGNoYW5nZWQ6JywgZSk7IH0pOwogKiBzdG9yZS5vZmYoJ2ZvbycsIGxpc3RlblRvRm9vKTsKICoKICogLy8gbGlzdGVuIHRvIGFsbCBzdG9yYWdlIGV2ZW50cyAoYWxzbyBuYW1lc3BhY2Ugc2Vuc2l0aXZlKQogKiBzdG9yZS5vbihmdW5jdGlvbiBzdG9yYWdlRXZlbnQoZSl7IGNvbnNvbGUubG9nKCd3ZWIgc3RvcmFnZTonLCBlKTsgfSk7CiAqIHN0b3JlLm9mZihzdG9yYWdlRXZlbnQpOwogKiAKICogU3RhdHVzOiBCRVRBIC0gdXNlZnVsLCBpZiB5b3UgYXJlbid0IHVzaW5nIElFOCBvciB3b3JzZQogKi8KOyhmdW5jdGlvbih3aW5kb3csIF8pIHsKCiAgICBfLm9uID0gZnVuY3Rpb24oa2V5LCBmbikgewogICAgICAgIGlmICghZm4pIHsgZm4gPSBrZXk7IGtleSA9ICcnOyB9Ly8gbm8ga2V5ID09PSBhbGwga2V5cwogICAgICAgIHZhciBsaXN0ZW5lciA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdmFyIGsgPSB0aGlzLl9vdXQoZS5rZXkpOy8vIHVuZGVmaW5lZCBpZiBrZXkgaXMgbm90IGluIHRoZSBuYW1lc3BhY2UKICAgICAgICAgICAgaWYgKChrICYmICgha2V5IHx8IGsgPT09IGtleSkpICYmIC8vIG1hdGNoIGtleSBpZiBsaXN0ZW5lciBoYXMgb25lCiAgICAgICAgICAgICAgICAoIWUuc3RvcmFnZUFyZWEgfHwgZS5zdG9yYWdlQXJlYSA9PT0gdGhpcy5fYXJlYSkpIHsvLyBtYXRjaCBhcmVhLCBpZiBhdmFpbGFibGUKICAgICAgICAgICAgICAgIHJldHVybiBmbi5jYWxsKHRoaXMsIF8uZXZlbnQuY2FsbCh0aGlzLCBrLCBlKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJzdG9yYWdlIiwgZm5ba2V5KyctbGlzdGVuZXInXT1saXN0ZW5lciwgZmFsc2UpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICBfLm9mZiA9IGZ1bmN0aW9uKGtleSwgZm4pIHsKICAgICAgICBpZiAoIWZuKSB7IGZuID0ga2V5OyBrZXkgPSAnJzsgfS8vIG5vIGtleSA9PT0gYWxsIGtleXMKICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigic3RvcmFnZSIsIGZuW2tleSsnLWxpc3RlbmVyJ10pOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICBfLm9uY2UgPSBmdW5jdGlvbihrZXksIGZuKSB7CiAgICAgICAgaWYgKCFmbikgeyBmbiA9IGtleTsga2V5ID0gJyc7IH0KICAgICAgICB2YXIgcyA9IHRoaXMsIGxpc3RlbmVyOwogICAgICAgIHJldHVybiBzLm9uKGtleSwgbGlzdGVuZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcy5vZmYoa2V5LCBsaXN0ZW5lcik7CiAgICAgICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0pOwogICAgfTsKCiAgICBfLmV2ZW50ID0gZnVuY3Rpb24oaywgZSkgewogICAgICAgIHZhciBldmVudCA9IHsKICAgICAgICAgICAga2V5OiBrLAogICAgICAgICAgICBuYW1lc3BhY2U6IHRoaXMubmFtZXNwYWNlKCksCiAgICAgICAgICAgIG5ld1ZhbHVlOiBfLnBhcnNlKGUubmV3VmFsdWUpLAogICAgICAgICAgICBvbGRWYWx1ZTogXy5wYXJzZShlLm9sZFZhbHVlKSwKICAgICAgICAgICAgdXJsOiBlLnVybCB8fCBlLnVyaSwKICAgICAgICAgICAgc3RvcmFnZUFyZWE6IGUuc3RvcmFnZUFyZWEsCiAgICAgICAgICAgIHNvdXJjZTogZS5zb3VyY2UsCiAgICAgICAgICAgIHRpbWVTdGFtcDogZS50aW1lU3RhbXAsCiAgICAgICAgICAgIG9yaWdpbmFsRXZlbnQ6IGUKICAgICAgICB9OwogICAgICAgIGlmIChfLmNhY2hlKSB7CiAgICAgICAgICAgIHZhciBtaW4gPSBfLmV4cGlyZXMoZS5uZXdWYWx1ZSB8fCBlLm9sZFZhbHVlKTsKICAgICAgICAgICAgaWYgKG1pbikgewogICAgICAgICAgICAgICAgZXZlbnQuZXhwaXJlcyA9IF8ud2hlbihtaW4pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBldmVudDsKICAgIH07CgogICAgLy8gc3RvcmUyIHBvbGljeSBpcyB0byBub3QgdGhyb3cgZXJyb3JzIG9uIG9sZCBicm93c2VycwogICAgdmFyIG9sZCA9ICF3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lciA/IGZ1bmN0aW9uKCl7fSA6IG51bGw7CiAgICBfLmZuKCdvbicsIG9sZCB8fCBfLm9uKTsKICAgIF8uZm4oJ29mZicsIG9sZCB8fCBfLm9mZik7CiAgICBfLmZuKCdvbmNlJywgb2xkIHx8IF8ub25jZSk7Cgp9KSh3aW5kb3csIHdpbmRvdy5zdG9yZS5fKTsKCn0pOwpyZXF1aXJlLnJlZ2lzdGVyKCJzdG9yZS9zcmMvc3RvcmUuY2FjaGUuanMiLCBmdW5jdGlvbihleHBvcnRzLCByZXF1aXJlLCBtb2R1bGUpewovKioKICogQ29weXJpZ2h0IChjKSAyMDEzIEVTSEEgUmVzZWFyY2gKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXM6CiAqICAgaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHAKICogICBodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvZ3BsLmh0bWwKICoKICogQWxsb3dzIHVzZSBvZiB0aGUgJ292ZXJ3cml0ZScgcGFyYW0gb24gc2V0IGNhbGxzIHRvIGdpdmUgYW4gZW5mb3JjZWQgZXhwaXJhdGlvbiBkYXRlCiAqIHdpdGhvdXQgYnJlYWtpbmcgZXhpc3RpbmcgJ292ZXJ3cml0ZScgZnVuY3Rpb25hbGl0eS4KICoKICogU3RhdHVzOiBCRVRBIC0gdXNlZnVsLCBuZWVkcyB0ZXN0aW5nCiAqLwo7KGZ1bmN0aW9uKF8pIHsKICAgIHZhciBwcmVmaXggPSAnZXhwQCcsCiAgICAgICAgc3VmZml4ID0gJzsnLAogICAgICAgIHBhcnNlID0gXy5wYXJzZSwKICAgICAgICBfZ2V0ID0gXy5nZXQsCiAgICAgICAgX3NldCA9IF8uc2V0OwogICAgXy5wYXJzZSA9IGZ1bmN0aW9uKHMpIHsKICAgICAgICBpZiAocyAmJiBzLmluZGV4T2YocHJlZml4KSA9PT0gMCkgewogICAgICAgICAgICBzID0gcy5zdWJzdHJpbmcocy5pbmRleE9mKHN1ZmZpeCkrMSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwYXJzZShzKTsKICAgIH07CiAgICBfLmV4cGlyZXMgPSBmdW5jdGlvbihzKSB7CiAgICAgICAgaWYgKHMgJiYgcy5pbmRleE9mKHByZWZpeCkgPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIHBhcnNlSW50KHMuc3Vic3RyaW5nKHByZWZpeC5sZW5ndGgsIHMuaW5kZXhPZihzdWZmaXgpKSwgMTApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwogICAgXy53aGVuID0gZnVuY3Rpb24obWluKSB7Ly8gaWYgbWluLCByZXR1cm4gbWluLT5kYXRlLCBlbHNlIGRhdGUtPm1pbgogICAgICAgIHZhciBub3cgPSBNYXRoLmZsb29yKChuZXcgRGF0ZSgpLmdldFRpbWUoKSkvNjAwMDApOwogICAgICAgIHJldHVybiBtaW4gPyBuZXcgRGF0ZSgobm93K21pbikqNjAwMDApIDogbm93OwogICAgfTsKICAgIF8uY2FjaGUgPSBmdW5jdGlvbihhcmVhLCBrZXkpIHsKICAgICAgICB2YXIgcyA9IF9nZXQoYXJlYSwga2V5KSwKICAgICAgICAgICAgbWluID0gXy5leHBpcmVzKHMpOwogICAgICAgIGlmIChtaW4gJiYgXy53aGVuKCkgPj0gbWluKSB7CiAgICAgICAgICAgIHJldHVybiBhcmVhLnJlbW92ZUl0ZW0oa2V5KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHM7CiAgICB9OwogICAgXy5nZXQgPSBmdW5jdGlvbihhcmVhLCBrZXkpIHsKICAgICAgICB2YXIgcyA9IF8uY2FjaGUoYXJlYSwga2V5KTsKICAgICAgICByZXR1cm4gcyA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IHM7CiAgICB9OwogICAgXy5zZXQgPSBmdW5jdGlvbihhcmVhLCBrZXksIHN0cmluZywgbWluKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKG1pbikgewogICAgICAgICAgICAgICAgc3RyaW5nID0gcHJlZml4ICsgKF8ud2hlbigpK21pbikgKyBzdWZmaXggKyBzdHJpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgX3NldChhcmVhLCBrZXksIHN0cmluZyk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBpZiAoZS5uYW1lID09PSAnUVVPVEFfRVhDRUVERURfRVJSJyB8fCBlLm5hbWUgPT09ICdOU19FUlJPUl9ET01fUVVPVEFfUkVBQ0hFRCcpIHsKICAgICAgICAgICAgICAgIHZhciBjaGFuZ2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpPTAsbT1hcmVhLmxlbmd0aDsgaTxtOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAoXy5jYWNoZShhcmVhLCBrZXkpID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGNoYW5nZWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gXy5zZXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgIH0KICAgIH07Cn0pKHdpbmRvdy5zdG9yZS5fLCB1bmRlZmluZWQpOwp9KTsKcmVxdWlyZS5yZWdpc3Rlcigic3RvcmUvc3JjL3N0b3JlLm1lYXN1cmUuanMiLCBmdW5jdGlvbihleHBvcnRzLCByZXF1aXJlLCBtb2R1bGUpewovKioKICogQ29weXJpZ2h0IChjKSAyMDEzIEVTSEEgUmVzZWFyY2gKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXM6CiAqICAgaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHAKICogICBodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvZ3BsLmh0bWwKICoKICogc3RvcmUucmVtYWluaW5nU3BhY2UoKTsvLyByZXR1cm5zIHJlbWFpbmluZ1NwYWNlIHZhbHVlIChpZiBicm93c2VyIHN1cHBvcnRzIGl0KQogKiBzdG9yZS5jaGFyc1VzZWQoKTsvLyByZXR1cm5zIGxlbmd0aCBvZiBhbGwgZGF0YSB3aGVuIHN0cmluZ2lmaWVkCiAqIHN0b3JlLmNoYXJzTGVmdChbdHJ1ZV0pOy8vIHRlc3RzIGhvdyBtYW55IG1vcmUgY2hhcnMgd2UgY2FuIGZpdCAoY3Jhc2ggdGhyZWF0ISkKICogc3RvcmUuY2hhcnNUb3RhbChbdHJ1ZV0pOy8vIGNoYXJzVXNlZCArIGNoYXJzTGVmdCwgZHVoLgogKgogKiBUT0RPOiBieXRlL3N0cmluZyBjb252ZXJzaW9ucwogKgogKiBTdGF0dXM6IEFMUEhBIC0gY2hhbmdpbmcgQVBJICphbmQqIGNyYXNoIHRocmVhdHMgOikKICovCjsoZnVuY3Rpb24oc3RvcmUsIF8pIHsKCiAgICBfLmZuKCdyZW1haW5pbmdTcGFjZScsIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLl9hcmVhLnJlbWFpbmluZ1NwYWNlOwogICAgfSk7CiAgICBfLmZuKCdjaGFyc1VzZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gXy5zdHJpbmdpZnkodGhpcy5nZXRBbGwoKSkubGVuZ3RoIC0gMjsKICAgIH0pOwogICAgXy5mbignY2hhcnNMZWZ0JywgZnVuY3Rpb24odGVzdCkgewogICAgICAgIGlmICh0aGlzLmlzRmFrZSgpKXsgcmV0dXJuOyB9CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgdGVzdCA9IHdpbmRvdy5jb25maXJtKCdDYWxsaW5nIHN0b3JlLmNoYXJzTGVmdCgpIG1heSBjcmFzaCBzb21lIGJyb3dzZXJzIScpOwogICAgICAgIH0KICAgICAgICBpZiAodGVzdCkgewogICAgICAgICAgICB2YXIgcyA9ICdzICcsIGFkZCA9IHM7CiAgICAgICAgICAgIC8vIGdyb3cgYWRkIGZvciBzcGVlZAogICAgICAgICAgICB3aGlsZSAocHV0KHN0b3JlLl9hcmVhLCBzKSkgewogICAgICAgICAgICAgICAgcyArPSBhZGQ7CiAgICAgICAgICAgICAgICBpZiAoYWRkLmxlbmd0aCA8IDUwMDAwKSB7CiAgICAgICAgICAgICAgICAgICAgYWRkID0gczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBzaHJpbmsgYWRkIGZvciBhY2N1cmFjeQogICAgICAgICAgICB3aGlsZSAoYWRkLmxlbmd0aCA+IDIpIHsKICAgICAgICAgICAgICAgIHMgPSBzLnN1YnN0cmluZygwLCBzLmxlbmd0aCAtIChhZGQubGVuZ3RoLzIpKTsKICAgICAgICAgICAgICAgIHdoaWxlIChwdXQoc3RvcmUuX2FyZWEsIHMpKSB7CiAgICAgICAgICAgICAgICAgICAgcyArPSBhZGQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhZGQgPSBhZGQuc3Vic3RyaW5nKGFkZC5sZW5ndGgvMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgXy5yZW1vdmUoc3RvcmUuX2FyZWEsICJfX3Rlc3RfXyIpOwogICAgICAgICAgICByZXR1cm4gcy5sZW5ndGggKyA4OwogICAgICAgIH0KICAgIH0pOwogICAgXy5mbignY2hhcnNUb3RhbCcsIGZ1bmN0aW9uKHRlc3QpIHsKICAgICAgICByZXR1cm4gc3RvcmUuY2hhcnNVc2VkKCkgKyBzdG9yZS5jaGFyc0xlZnQodGVzdCk7CiAgICB9KTsKCiAgICBmdW5jdGlvbiBwdXQoYXJlYSwgcykgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGFyZWEuc2V0SXRlbSgiX190ZXN0X18iLCBzKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBjYXRjaCAoZSkge30KICAgIH0KCn0pKHdpbmRvdy5zdG9yZSwgd2luZG93LnN0b3JlLl8pOwp9KTsKcmVxdWlyZS5yZWdpc3Rlcigic3RvcmUvc3JjL3N0b3JlLm9sZC5qcyIsIGZ1bmN0aW9uKGV4cG9ydHMsIHJlcXVpcmUsIG1vZHVsZSl7Ci8qKgogKiBDb3B5cmlnaHQgKGMpIDIwMTMgRVNIQSBSZXNlYXJjaAogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgYW5kIEdQTCBsaWNlbnNlczoKICogICBodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocAogKiAgIGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9ncGwuaHRtbAogKgogKiBJZiBmYWtlIChub24tcGVyc2lzdGVudCkgc3RvcmFnZSBmb3IgdXNlcnMgc3R1Y2sgaW4gdGhlIGRhcmsgYWdlcyAKICogZG9lcyBub3Qgc2F0aXNmeSB5b3UsIHRoaXMgd2lsbCByZXBsYWNlIGl0IHdpdGggdGhlIGEgcmVhc29uYWJsZSBpbWl0YXRvciBmb3IgdGhlaXIKICogcGF0aGV0aWMsIGluY29tcGV0ZW50IGJyb3dzZXIuICBOb3RlIHRoYXQgdGhlIHNlc3Npb24gcmVwbGFjZW1lbnQgaGVyZSBpcyBwb3RlbnRpYWxseQogKiBpbnNlY3VyZSBhcyBpdCB1c2VzIHdpbmRvdy5uYW1lIHdpdGhvdXQgYW55IGZhbmN5IHByb3RlY3Rpb25zLgogKgogKiBTdGF0dXM6IEJFVEEgLSB1bnN1cHBvcnRlZCwgdXNlZnVsLCBuZWVkcyB0ZXN0aW5nICYgcmVmaW5pbmcKICovCjsoZnVuY3Rpb24od2luZG93LCBkb2N1bWVudCwgc3RvcmUsIF8pIHsKCiAgICBmdW5jdGlvbiBjcmVhdGUobmFtZSwgaXRlbXMsIHVwZGF0ZSkgewogICAgICAgIHZhciBsZW5ndGggPSAwOwogICAgICAgIGZvciAodmFyIGsgaW4gaXRlbXMpIHsKICAgICAgICAgICAgaWYgKGl0ZW1zLmhhc093blByb3BlcnR5KGspKSB7CiAgICAgICAgICAgICAgICBsZW5ndGgrKzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgYXJlYSA9IF8uaW5oZXJpdChfLnN0b3JhZ2VBUEksIHsgaXRlbXM6aXRlbXMsIGxlbmd0aDpsZW5ndGgsIG5hbWU6bmFtZSB9KTsKICAgICAgICBpZiAodXBkYXRlKSB7CiAgICAgICAgICAgIGFkZFVwZGF0ZUZuKGFyZWEsICdzZXRJdGVtJywgdXBkYXRlKTsKICAgICAgICAgICAgYWRkVXBkYXRlRm4oYXJlYSwgJ3JlbW92ZUl0ZW0nLCB1cGRhdGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXJlYTsKICAgIH0KICAgIGZ1bmN0aW9uIGFkZFVwZGF0ZUZuKGFyZWEsIG5hbWUsIHVwZGF0ZSkgewogICAgICAgIHZhciBvbGQgPSBhcmVhW25hbWVdOwogICAgICAgIGFyZWFbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHJldCA9IG9sZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB1cGRhdGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9OwogICAgfQoKICAgIGlmIChzdG9yZS5pc0Zha2UoKSkgewogICAgICAgIHZhciBhcmVhOwoKICAgICAgICBpZiAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmFkZEJlaGF2aW9yKSB7Ly8gSUUgdXNlckRhdGEKICAgICAgICAgICAgdmFyIGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksCiAgICAgICAgICAgICAgICBzbiA9ICdsb2NhbFN0b3JhZ2UnLAogICAgICAgICAgICAgICAgYm9keSA9IGRvY3VtZW50LmJvZHksCiAgICAgICAgICAgICAgICB3cmFwID0gZnVuY3Rpb24gd3JhcChmbikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYm9keS5hcHBlbmRDaGlsZChlbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsLmFkZEJlaGF2aW9yKCcjZGVmYXVsdCN1c2VyRGF0YScpOwogICAgICAgICAgICAgICAgICAgICAgICBlbC5sb2FkKHNuKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJldCA9IGZuLmFwcGx5KHN0b3JlLl9hcmVhLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICBlbC5zYXZlKHNuKTsKICAgICAgICAgICAgICAgICAgICAgICAgYm9keS5yZW1vdmVDaGlsZChlbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBoYXMgPSBmdW5jdGlvbiBoYXMoa2V5KXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWwuZ2V0QXR0cmlidXRlKGtleSkgIT09IG51bGw7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgVXNlckRhdGFTdG9yYWdlID0gZnVuY3Rpb24gVXNlckRhdGFTdG9yYWdlKCl7fTsKCiAgICAgICAgICAgIFVzZXJEYXRhU3RvcmFnZS5wcm90b3R5cGUgPSB7CiAgICAgICAgICAgICAgICBsZW5ndGg6ICh3cmFwKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsLlhNTERvY3VtZW50LmRvY3VtZW50RWxlbWVudC5hdHRyaWJ1dGVzLmxlbmd0aDsKICAgICAgICAgICAgICAgIH0pKSgpLAogICAgICAgICAgICAgICAgaGFzOiB3cmFwKGhhcyksCiAgICAgICAgICAgICAgICBrZXk6IHdyYXAoZnVuY3Rpb24oaSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbC5YTUxEb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuYXR0cmlidXRlc1tpXTsKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgc2V0SXRlbTogd3JhcChmdW5jdGlvbihrLCB2KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFoYXMoaykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sZW5ndGgrKzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKGssIHYpOwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICByZW1vdmVJdGVtOiB3cmFwKGZ1bmN0aW9uKGspIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaGFzKGspKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZShrKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sZW5ndGgtLTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdldEl0ZW06IHdyYXAoZnVuY3Rpb24oayl7IHJldHVybiBlbC5nZXRBdHRyaWJ1dGUoayk7IH0pLAogICAgICAgICAgICAgICAgY2xlYXI6IHdyYXAoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFsbCA9IGVsLlhNTERvY3VtZW50LmRvY3VtZW50RWxlbWVudC5hdHRyaWJ1dGVzOwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MCwgYTsgISEoYSA9IGFsbFtpXSk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBlbC5yZW1vdmVBdHRyaWJ1dGUoYS5uYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sZW5ndGggPSAwOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfTsKICAgICAgICAgICAgYXJlYSA9IG5ldyBVc2VyRGF0YVN0b3JhZ2UoKTsKCiAgICAgICAgfSBlbHNlIGlmICgnZ2xvYmFsU3RvcmFnZScgaW4gd2luZG93ICYmIHdpbmRvdy5nbG9iYWxTdG9yYWdlKSB7Ly8gRkYgZ2xvYmFsU3RvcmFnZQogICAgICAgICAgICBhcmVhID0gY3JlYXRlKCdnbG9iYWwnLCB3aW5kb3cuZ2xvYmFsU3RvcmFnZVt3aW5kb3cubG9jYXRpb24uaG9zdG5hbWVdKTsKCiAgICAgICAgfSBlbHNlIHsvLyBjb29raWUKICAgICAgICAgICAgdmFyIGRhdGUgPSBuZXcgRGF0ZSgpLAogICAgICAgICAgICAgICAga2V5ID0gJ3N0b3JlLmxvY2FsJywKICAgICAgICAgICAgICAgIGl0ZW1zID0ge30sCiAgICAgICAgICAgICAgICBjb29raWVzID0gZG9jdW1lbnQuY29va2llLnNwbGl0KCc7Jyk7CiAgICAgICAgICAgIGRhdGUuc2V0VGltZShkYXRlLmdldFRpbWUoKSsoNSozNjUqMjQqNjAqNjAqMTAwMCkpOy8vNSB5ZWFycyBvdXQKICAgICAgICAgICAgZGF0ZSA9IGRhdGUudG9HTVRTdHJpbmcoKTsKICAgICAgICAgICAgZm9yICh2YXIgaT0wLG09Y29va2llcy5sZW5ndGg7IGk8bTsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgYyA9IGNvb2tpZXNbaV07CiAgICAgICAgICAgICAgICB3aGlsZSAoYy5jaGFyQXQoMCkgPT09ICcgJykgewogICAgICAgICAgICAgICAgICAgIGMgPSBjLnN1YnN0cmluZygxLCBjLmxlbmd0aCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoYy5pbmRleE9mKGtleSkgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBpdGVtcyA9IEpTT04ucGFyc2UoYy5zdWJzdHJpbmcoa2V5Lmxlbmd0aCsxKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYXJlYSA9IGNyZWF0ZSgnY29va2llJywgaXRlbXMsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZG9jdW1lbnQuY29va2llID0ga2V5KyI9IitKU09OLnN0cmluZ2lmeSh0aGlzLml0ZW1zKSsiOyBleHBpcmVzPSIrZGF0ZSsiOyBwYXRoPS8iOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIHJlcGxhY2UgbG9jYWwncyBmYWtlIHN0b3JhZ2UKICAgICAgICBzdG9yZS5fYXJlYSA9IF8uYXJlYXMubG9jYWwgPSBhcmVhOwogICAgfQoKICAgIGlmIChzdG9yZS5zZXNzaW9uLmlzRmFrZSgpKSB7CiAgICAgICAgdmFyIHNJdGVtcyA9IHdpbmRvdy5uYW1lID8gSlNPTi5wYXJzZSh3aW5kb3cubmFtZSlbZG9jdW1lbnQuZG9tYWluXXx8e30gOiB7fTsKICAgICAgICBzdG9yZS5zZXNzaW9uLl9hcmVhID0gXy5hcmVhcy5zZXNzaW9uID0KICAgICAgICAgICAgY3JlYXRlKCd3aW5kb3dOYW1lJywgc0l0ZW1zLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBvID0ge307CiAgICAgICAgICAgICAgICBvW2RvY3VtZW50LmRvbWFpbl0gPSB0aGlzLml0ZW1zOwogICAgICAgICAgICAgICAgd2luZG93Lm5hbWUgPSBKU09OLnN0cmluZ2lmeShvKTsKICAgICAgICAgICAgfSk7CiAgICB9Cgp9KSh3aW5kb3csIGRvY3VtZW50LCB3aW5kb3cuc3RvcmUsIHdpbmRvdy5zdG9yZS5fKTsKCn0pOwpyZXF1aXJlLnJlZ2lzdGVyKCJzdG9yZS9zcmMvc3RvcmUub3ZlcmZsb3cuanMiLCBmdW5jdGlvbihleHBvcnRzLCByZXF1aXJlLCBtb2R1bGUpewovKioKICogQ29weXJpZ2h0IChjKSAyMDEzIEVTSEEgUmVzZWFyY2gKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXM6CiAqICAgaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHAKICogICBodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvZ3BsLmh0bWwKICoKICogV2hlbiBxdW90YSBpcyByZWFjaGVkIG9uIGEgc3RvcmFnZSBhcmVhLCB0aGlzIHNoaWZ0cyBpbmNvbWluZyB2YWx1ZXMgdG8gCiAqIGZha2Ugc3RvcmFnZSwgc28gdGhleSBsYXN0IG9ubHkgYXMgbG9uZyBhcyB0aGUgcGFnZSBkb2VzLiBUaGlzIGlzIHVzZWZ1bAogKiBiZWNhdXNlIGl0IGlzIG1vcmUgYnVyZGVuc29tZSBmb3IgbG9jYWxTdG9yYWdlIHRvIHJlY292ZXIgZnJvbSBxdW90YSBlcnJvcnMKICogdGhhbiBpbmNvbXBsZXRlIGNhY2hlcy4gSW4gb3RoZXIgd29yZHMsIGl0IGlzIHdpc2VyIHRvIHJlbHkgb24gc3RvcmUuanMKICogbmV2ZXIgY29tcGxhaW5pbmcgdGhhbiBuZXZlciBtaXNzaW5nIGRhdGEuIFlvdSBzaG91bGQgYWxyZWFkeSBiZSBjaGVja2luZwogKiB0aGUgaW50ZWdyaXR5IG9mIGNhY2hlZCBkYXRhIG9uIGV2ZXJ5IHBhZ2UgbG9hZC4gQWxzbyBub3RlIHRoYXQgcXVvdGEgZXJyb3JzCiAqIGFyZSB0aHJvd24gYnkgU2FmYXJpIGZvciAqZXZlcnkqIHNldEl0ZW0gd2hlbiB1c2VyIGlzIGluIHByaXZhdGUgYnJvd3NpbmcgbW9kZS4KICogaHR0cDovL3NwaW4uYXRvbWljb2JqZWN0LmNvbS8yMDEzLzAxLzIzL2lvcy1wcml2YXRlLWJyb3dzaW5nLWxvY2Fsc3RvcmFnZS8KICoKICogU3RhdHVzOiBCRVRBCiAqLwo7KGZ1bmN0aW9uKHN0b3JlLCBfKSB7CiAgICB2YXIgX3NldCA9IF8uc2V0LAogICAgICAgIF9nZXQgPSBfLmdldCwKICAgICAgICBfcmVtb3ZlID0gXy5yZW1vdmUsCiAgICAgICAgX2tleSA9IF8ua2V5LAogICAgICAgIF9sZW5ndGggPSBfLmxlbmd0aCwKICAgICAgICBfY2xlYXIgPSBfLmNsZWFyOwoKICAgIF8ub3ZlcmZsb3cgPSBmdW5jdGlvbihhcmVhLCBjcmVhdGUpIHsKICAgICAgICB2YXIgbmFtZSA9IGFyZWEgPT09IF8uYXJlYXMubG9jYWwgPyAnK2xvY2FsKycgOgogICAgICAgICAgICAgICAgICAgYXJlYSA9PT0gXy5hcmVhcy5zZXNzaW9uID8gJytzZXNzaW9uKycgOiBmYWxzZTsKICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICB2YXIgb3ZlcmZsb3cgPSBfLmFyZWFzW25hbWVdOwogICAgICAgICAgICBpZiAoY3JlYXRlICYmICFvdmVyZmxvdykgewogICAgICAgICAgICAgICAgb3ZlcmZsb3cgPSBzdG9yZS5hcmVhKG5hbWUpLl9hcmVhOy8vIGFyZWEoKSBjb3BpZXMgdG8gXy5hcmVhcwogICAgICAgICAgICB9IGVsc2UgaWYgKGNyZWF0ZSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBfLmFyZWFzW25hbWVdOwogICAgICAgICAgICAgICAgZGVsZXRlIHN0b3JlW25hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvdmVyZmxvdzsKICAgICAgICB9CiAgICB9OwogICAgXy5zZXQgPSBmdW5jdGlvbihhcmVhLCBrZXksIHN0cmluZykgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIF9zZXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGlmIChlLm5hbWUgPT09ICdRVU9UQV9FWENFRURFRF9FUlInIHx8CiAgICAgICAgICAgICAgICBlLm5hbWUgPT09ICdOU19FUlJPUl9ET01fUVVPVEFfUkVBQ0hFRCcgfHwKICAgICAgICAgICAgICAgIGUudG9TdHJpbmcoKS5pbmRleE9mKCJRVU9UQV9FWENFRURFRF9FUlIiKSAhPT0gLTEgfHwKICAgICAgICAgICAgICAgIGUudG9TdHJpbmcoKS5pbmRleE9mKCJRdW90YUV4Y2VlZGVkRXJyb3IiKSAhPT0gLTEpIHsKICAgICAgICAgICAgICAgIC8vIHRoZSBlLnRvU3RyaW5nIGlzIG5lZWRlZCBmb3IgSUU5IC8gSUUxMCwgY29zIG5hbWUgaXMgZW1wdHkgdGhlcmUKICAgICAgICAgICAgICAgIHJldHVybiBfLnNldChfLm92ZXJmbG93KGFyZWEsIHRydWUpLCBrZXksIHN0cmluZyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICB9CiAgICB9OwogICAgXy5nZXQgPSBmdW5jdGlvbihhcmVhLCBrZXkpIHsKICAgICAgICB2YXIgb3ZlcmZsb3cgPSBfLm92ZXJmbG93KGFyZWEpOwogICAgICAgIHJldHVybiAob3ZlcmZsb3cgJiYgX2dldC5jYWxsKHRoaXMsIG92ZXJmbG93LCBrZXkpKSB8fAogICAgICAgICAgICBfZ2V0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9OwogICAgXy5yZW1vdmUgPSBmdW5jdGlvbihhcmVhLCBrZXkpIHsKICAgICAgICB2YXIgb3ZlcmZsb3cgPSBfLm92ZXJmbG93KGFyZWEpOwogICAgICAgIGlmIChvdmVyZmxvdyl7IF9yZW1vdmUuY2FsbCh0aGlzLCBvdmVyZmxvdywga2V5KTsgfQogICAgICAgIF9yZW1vdmUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH07CiAgICBfLmtleSA9IGZ1bmN0aW9uKGFyZWEsIGkpIHsKICAgICAgICB2YXIgb3ZlcmZsb3cgPSBfLm92ZXJmbG93KGFyZWEpOwogICAgICAgIGlmIChvdmVyZmxvdykgewogICAgICAgICAgICB2YXIgbCA9IF9sZW5ndGguY2FsbCh0aGlzLCBhcmVhKTsKICAgICAgICAgICAgaWYgKGkgPj0gbCkgewogICAgICAgICAgICAgICAgaSA9IGkgLSBsOy8vIG1ha2UgaSBvdmVyZmxvdy1yZWxhdGl2ZQogICAgICAgICAgICAgICAgZm9yICh2YXIgaj0wLCBtPV9sZW5ndGguY2FsbCh0aGlzLCBvdmVyZmxvdyk7IGo8bTsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGogPT09IGkpIHsvLyBqIGlzIG92ZXJmbG93IGluZGV4CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfa2V5LmNhbGwodGhpcywgb3ZlcmZsb3csIGopOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gX2tleS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfTsKICAgIF8ubGVuZ3RoID0gZnVuY3Rpb24oYXJlYSkgewogICAgICAgIHZhciBsZW5ndGggPSBfbGVuZ3RoKGFyZWEpLAogICAgICAgICAgICBvdmVyZmxvdyA9IF8ub3ZlcmZsb3coYXJlYSk7CiAgICAgICAgcmV0dXJuIG92ZXJmbG93ID8gbGVuZ3RoICsgX2xlbmd0aChvdmVyZmxvdykgOiBsZW5ndGg7CiAgICB9OwogICAgXy5jbGVhciA9IGZ1bmN0aW9uKGFyZWEpIHsKICAgICAgICBfLm92ZXJmbG93KGFyZWEsIGZhbHNlKTsKICAgICAgICBfY2xlYXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH07Cgp9KSh3aW5kb3cuc3RvcmUsIHdpbmRvdy5zdG9yZS5fKTsKCn0pOwpyZXF1aXJlLnJlZ2lzdGVyKCJzdG9yZS9zcmMvc3RvcmUucXVvdGEuanMiLCBmdW5jdGlvbihleHBvcnRzLCByZXF1aXJlLCBtb2R1bGUpewovKioKICogQ29weXJpZ2h0IChjKSAyMDEzIEVTSEEgUmVzZWFyY2gKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXM6CiAqICAgaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHAKICogICBodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvZ3BsLmh0bWwKICoKICogQmluZCBoYW5kbGVycyB0byBxdW90YSBlcnJvcnM6CiAqICAgc3RvcmUucXVvdGEoZnVuY3Rpb24oZSwgYXJlYSwga2V5LCBzdHIpIHsKICogICAgICBjb25zb2xlLmxvZyhlLCBhcmVhLCBrZXksIHN0cik7CiAqICAgfSk7CiAqIElmIGEgaGFuZGxlciByZXR1cm5zIHRydWUgb3RoZXIgaGFuZGxlcnMgYXJlIG5vdCBjYWxsZWQgYW5kCiAqIHRoZSBlcnJvciBpcyBzdXBwcmVzc2VkLgogKgogKiBUaGluayBxdW90YSBlcnJvcnMgd2lsbCBuZXZlciBoYXBwZW4gdG8geW91PyBUaGluayBhZ2FpbjoKICogaHR0cDovL3NwaW4uYXRvbWljb2JqZWN0LmNvbS8yMDEzLzAxLzIzL2lvcy1wcml2YXRlLWJyb3dzaW5nLWxvY2Fsc3RvcmFnZS8KICogKHRoaXMgYWZmZWN0cyBzZXNzaW9uU3RvcmFnZSB0b28pCiAqCiAqIFN0YXR1czogQUxQSEEgLSBBUEkgY291bGQgdXNlIHVuYmluZCBmZWF0dXJlCiAqLwo7KGZ1bmN0aW9uKHN0b3JlLCBfKSB7CgogICAgc3RvcmUucXVvdGEgPSBmdW5jdGlvbihmbikgewogICAgICAgIHN0b3JlLnF1b3RhLmZucy5wdXNoKGZuKTsKICAgIH07CiAgICBzdG9yZS5xdW90YS5mbnMgPSBbXTsKCiAgICB2YXIgX3NldCA9IF8uc2V0OwogICAgXy5zZXQgPSBmdW5jdGlvbihhcmVhLCBrZXksIHN0cikgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIF9zZXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGlmIChlLm5hbWUgPT09ICdRVU9UQV9FWENFRURFRF9FUlInIHx8CiAgICAgICAgICAgICAgICBlLm5hbWUgPT09ICdOU19FUlJPUl9ET01fUVVPVEFfUkVBQ0hFRCcpIHsKICAgICAgICAgICAgICAgIHZhciBmbnMgPSBzdG9yZS5xdW90YS5mbnM7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpPTAsbT1mbnMubGVuZ3RoOyBpPG07IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmICh0cnVlID09PSBmbnNbaV0uY2FsbCh0aGlzLCBlLCBhcmVhLCBrZXksIHN0cikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgIH0KICAgIH07Cgp9KSh3aW5kb3cuc3RvcmUsIHdpbmRvdy5zdG9yZS5fKTsKfSk7CnJlcXVpcmUuYWxpYXMoInN0b3JlL2Rpc3Qvc3RvcmUyLmpzIiwgInN0b3JlL2luZGV4LmpzIik7CgppZiAodHlwZW9mIGV4cG9ydHMgPT0gIm9iamVjdCIpIHsKICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoInN0b3JlIik7Cn0gZWxzZSBpZiAodHlwZW9mIGRlZmluZSA9PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQpIHsKICBkZWZpbmUoZnVuY3Rpb24oKXsgcmV0dXJuIHJlcXVpcmUoInN0b3JlIik7IH0pOwp9IGVsc2UgewogIHRoaXNbInN0b3JlIl0gPSByZXF1aXJlKCJzdG9yZSIpOwp9fSkoKTs=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 14:52:12 GMT",
                    "Content-Length": "29480",
                    "Date": "Sat, 08 Nov 2014 14:52:12 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}