{
    "url": "http://localhost:9999/ouadi/rtl-jquery-mobile/js/rtl.jquery.mobile-1.4.0.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>location.pathname</b> and written to <b>the 'href' property of a DOM element</b> via the following statement:<ul><li>base[ 0 ].href = href || location.pathname;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/ouadi/rtl-jquery-mobile/js/rtl.jquery.mobile-1.4.0.js",
                "path": "/ouadi/rtl-jquery-mobile/js/rtl.jquery.mobile-1.4.0.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9vdWFkaS9ydGwtanF1ZXJ5LW1vYmlsZS9qcy9ydGwuanF1ZXJ5Lm1vYmlsZS0xLjQuMC5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNDQzNTEzDQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBTYXQsIDA4IE5vdiAyMDE0IDAzOjQxOjI0IEdNVA0KTGFzdC1Nb2RpZmllZDogU2F0LCAwOCBOb3YgMjAxNCAwMzo0MToyMyBHTVQNCg0KLyohCiogalF1ZXJ5IE1vYmlsZSAxLjQuMAoqIEdpdCBIRUFEIGhhc2g6IGYwOWFhZTBlMDM1ZDY4MDVlNDYxYTdiZTI0NmQwNGEwZGJjOThmNjkgPD4gRGF0ZTogVGh1IERlYyAxOSAyMDEzIDE3OjM0OjIyIFVUQwoqIGh0dHA6Ly9qcXVlcnltb2JpbGUuY29tCioKKiBDb3B5cmlnaHQgMjAxMCwgMjAxMyBqUXVlcnkgRm91bmRhdGlvbiwgSW5jLiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgoqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKKgoqLwoKLyoKKiBSaWdodC1Uby1MZWZ0IGNoYW5nZXMgbWFkZSBieSBNb3V0YXogU2hhbXMgdW5kZXIgdGhlIHNhbWUgbGljZW5zZShzKSBtZW50aW9uZWQgCiogaHR0cDovL3d3dy5pbnRsYXFhLmNvbS9qcXVlcnktbW9iaWxlLXJ0bCAKKiAKKi8KCihmdW5jdGlvbiAoIHJvb3QsIGRvYywgZmFjdG9yeSApIHsKCWlmICggdHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kICkgewoJCS8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS4KCQlkZWZpbmUoIFsgImpxdWVyeSIgXSwgZnVuY3Rpb24gKCAkICkgewoJCQlmYWN0b3J5KCAkLCByb290LCBkb2MgKTsKCQkJcmV0dXJuICQubW9iaWxlOwoJCX0pOwoJfSBlbHNlIHsKCQkvLyBCcm93c2VyIGdsb2JhbHMKCQlmYWN0b3J5KCByb290LmpRdWVyeSwgcm9vdCwgZG9jICk7Cgl9Cn0oIHRoaXMsIGRvY3VtZW50LCBmdW5jdGlvbiAoIGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkICkgewooZnVuY3Rpb24oICQgKSB7CgkkLm1vYmlsZSA9IHt9Owp9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJJC5leHRlbmQoICQubW9iaWxlLCB7CgoJCS8vIFZlcnNpb24gb2YgdGhlIGpRdWVyeSBNb2JpbGUgRnJhbWV3b3JrCgkJdmVyc2lvbjogIjEuNC4wIiwKCgkJLy8gRGVwcmVjYXRlZCBhbmQgbm8gbG9uZ2VyIHVzZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQkvLyBEZWZpbmUgdGhlIHVybCBwYXJhbWV0ZXIgdXNlZCBmb3IgcmVmZXJlbmNpbmcgd2lkZ2V0LWdlbmVyYXRlZCBzdWItcGFnZXMuCgkJLy8gVHJhbnNsYXRlcyB0byBleGFtcGxlLmh0bWwmdWktcGFnZT1zdWJwYWdlSWRlbnRpZmllcgoJCS8vIGhhc2ggc2VnbWVudCBiZWZvcmUgJnVpLXBhZ2U9IGlzIHVzZWQgdG8gbWFrZSBBamF4IHJlcXVlc3QKCQlzdWJQYWdlVXJsS2V5OiAidWktcGFnZSIsCgoJCWhpZGVVcmxCYXI6IHRydWUsCgoJCS8vIEtlZXBuYXRpdmUgU2VsZWN0b3IKCQlrZWVwTmF0aXZlOiAiOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJLy8gQ2xhc3MgYXNzaWduZWQgdG8gcGFnZSBjdXJyZW50bHkgaW4gdmlldywgYW5kIGR1cmluZyB0cmFuc2l0aW9ucwoJCWFjdGl2ZVBhZ2VDbGFzczogInVpLXBhZ2UtYWN0aXZlIiwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCS8vIENsYXNzIHVzZWQgZm9yICJhY3RpdmUiIGJ1dHRvbiBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJYWN0aXZlQnRuQ2xhc3M6ICJ1aS1idG4tYWN0aXZlIiwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCS8vIENsYXNzIHVzZWQgZm9yICJmb2N1cyIgZm9ybSBlbGVtZW50IHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlmb2N1c0NsYXNzOiAidWktZm9jdXMiLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGhhbmRsZSBjbGlja3MgYW5kIGZvcm0gc3VibWlzc2lvbnMgdGhyb3VnaCBBamF4LCB3aGVuIHNhbWUtZG9tYWluCgkJYWpheEVuYWJsZWQ6IHRydWUsCgoJCS8vIEF1dG9tYXRpY2FsbHkgbG9hZCBhbmQgc2hvdyBwYWdlcyBiYXNlZCBvbiBsb2NhdGlvbi5oYXNoCgkJaGFzaExpc3RlbmluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIGRpc2FibGUgdG8gcHJldmVudCBqcXVlcnkgZnJvbSBib3RoZXJpbmcgd2l0aCBsaW5rcwoJCWxpbmtCaW5kaW5nRW5hYmxlZDogdHJ1ZSwKCgkJLy8gU2V0IGRlZmF1bHQgcGFnZSB0cmFuc2l0aW9uIC0gJ25vbmUnIGZvciBubyB0cmFuc2l0aW9ucwoJCWRlZmF1bHRQYWdlVHJhbnNpdGlvbjogImZhZGUiLAoKCQkvLyBTZXQgbWF4aW11bSB3aW5kb3cgd2lkdGggZm9yIHRyYW5zaXRpb25zIHRvIGFwcGx5IC0gJ2ZhbHNlJyBmb3Igbm8gbGltaXQKCQltYXhUcmFuc2l0aW9uV2lkdGg6IGZhbHNlLAoKCQkvLyBNaW5pbXVtIHNjcm9sbCBkaXN0YW5jZSB0aGF0IHdpbGwgYmUgcmVtZW1iZXJlZCB3aGVuIHJldHVybmluZyB0byBhIHBhZ2UKCQkvLyBEZXByZWNhdGVkIHJlbW92ZSBpbiAxLjUKCQltaW5TY3JvbGxCYWNrOiAwLAoKCQkvLyBTZXQgZGVmYXVsdCBkaWFsb2cgdHJhbnNpdGlvbiAtICdub25lJyBmb3Igbm8gdHJhbnNpdGlvbnMKCQlkZWZhdWx0RGlhbG9nVHJhbnNpdGlvbjogInBvcCIsCgoJCS8vIEVycm9yIHJlc3BvbnNlIG1lc3NhZ2UgLSBhcHBlYXJzIHdoZW4gYW4gQWpheCBwYWdlIHJlcXVlc3QgZmFpbHMKCQlwYWdlTG9hZEVycm9yTWVzc2FnZTogIkVycm9yIExvYWRpbmcgUGFnZSIsCgoJCS8vIEZvciBlcnJvciBtZXNzYWdlcywgd2hpY2ggdGhlbWUgZG9lcyB0aGUgYm94IHVzZXM/CgkJcGFnZUxvYWRFcnJvck1lc3NhZ2VUaGVtZTogImEiLAoKCQkvLyByZXBsYWNlIGNhbGxzIHRvIHdpbmRvdy5oaXN0b3J5LmJhY2sgd2l0aCBwaG9uZWdhcHMgbmF2aWdhdGlvbiBoZWxwZXIKCQkvLyB3aGVyZSBpdCBpcyBwcm92aWRlZCBvbiB0aGUgd2luZG93IG9iamVjdAoJCXBob25lZ2FwTmF2aWdhdGlvbkVuYWJsZWQ6IGZhbHNlLAoKCQkvL2F1dG9tYXRpY2FsbHkgaW5pdGlhbGl6ZSB0aGUgRE9NIHdoZW4gaXQncyByZWFkeQoJCWF1dG9Jbml0aWFsaXplUGFnZTogdHJ1ZSwKCgkJcHVzaFN0YXRlRW5hYmxlZDogdHJ1ZSwKCgkJLy8gYWxsb3dzIHVzZXJzIHRvIG9wdCBpbiB0byBpZ25vcmluZyBjb250ZW50IGJ5IG1hcmtpbmcgYSBwYXJlbnQgZWxlbWVudCBhcwoJCS8vIGRhdGEtaWdub3JlZAoJCWlnbm9yZUNvbnRlbnRFbmFibGVkOiBmYWxzZSwKCgkJYnV0dG9uTWFya3VwOiB7CgkJCWhvdmVyRGVsYXk6IDIwMAoJCX0sCgoJCS8vIGRpc2FibGUgdGhlIGFsdGVyYXRpb24gb2YgdGhlIGR5bmFtaWMgYmFzZSB0YWcgb3IgbGlua3MgaW4gdGhlIGNhc2UKCQkvLyB0aGF0IGEgZHluYW1pYyBiYXNlIHRhZyBpc24ndCBzdXBwb3J0ZWQKCQlkeW5hbWljQmFzZUVuYWJsZWQ6IHRydWUsCgoJCS8vIGRlZmF1bHQgdGhlIHByb3BlcnR5IHRvIHJlbW92ZSBkZXBlbmRlbmN5IG9uIGFzc2lnbm1lbnQgaW4gaW5pdCBtb2R1bGUKCQlwYWdlQ29udGFpbmVyOiAkKCksCgoJCS8vZW5hYmxlIGNyb3NzLWRvbWFpbiBwYWdlIHN1cHBvcnQKCQlhbGxvd0Nyb3NzRG9tYWluUGFnZXM6IGZhbHNlLAoKCQlkaWFsb2dIYXNoS2V5OiAiJnVpLXN0YXRlPWRpYWxvZyIKCX0pOwp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyIG5zTm9ybWFsaXplRGljdCA9IHt9LAoJCW9sZEZpbmQgPSAkLmZpbmQsCgkJcmJyYWNlID0gLyg/Olx7W1xzXFNdKlx9fFxbW1xzXFNdKlxdKSQvLAoJCWpxbURhdGFSRSA9IC86anFtRGF0YVwoKFteKV0qKVwpL2c7CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgoJCS8vIE5hbWVzcGFjZSB1c2VkIGZyYW1ld29yay13aWRlIGZvciBkYXRhLWF0dHJzLiBEZWZhdWx0IGlzIG5vIG5hbWVzcGFjZQoKCQluczogIiIsCgoJCS8vIFJldHJpZXZlIGFuIGF0dHJpYnV0ZSBmcm9tIGFuIGVsZW1lbnQgYW5kIHBlcmZvcm0gc29tZSBtYXNzYWdpbmcgb2YgdGhlIHZhbHVlCgoJCWdldEF0dHJpYnV0ZTogZnVuY3Rpb24oIGVsZW1lbnQsIGtleSApIHsKCQkJdmFyIGRhdGE7CgoJCQllbGVtZW50ID0gZWxlbWVudC5qcXVlcnkgPyBlbGVtZW50WzBdIDogZWxlbWVudDsKCgkJCWlmICggZWxlbWVudCAmJiBlbGVtZW50LmdldEF0dHJpYnV0ZSApIHsKCQkJCWRhdGEgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsga2V5ICk7CgkJCX0KCgkJCS8vIENvcGllZCBmcm9tIGNvcmUncyBzcmMvZGF0YS5qczpkYXRhQXR0cigpCgkJCS8vIENvbnZlcnQgZnJvbSBhIHN0cmluZyB0byBhIHByb3BlciBkYXRhIHR5cGUKCQkJdHJ5IHsKCQkJCWRhdGEgPSBkYXRhID09PSAidHJ1ZSIgPyB0cnVlIDoKCQkJCQlkYXRhID09PSAiZmFsc2UiID8gZmFsc2UgOgoJCQkJCWRhdGEgPT09ICJudWxsIiA/IG51bGwgOgoJCQkJCS8vIE9ubHkgY29udmVydCB0byBhIG51bWJlciBpZiBpdCBkb2Vzbid0IGNoYW5nZSB0aGUgc3RyaW5nCgkJCQkJK2RhdGEgKyAiIiA9PT0gZGF0YSA/ICtkYXRhIDoKCQkJCQlyYnJhY2UudGVzdCggZGF0YSApID8gSlNPTi5wYXJzZSggZGF0YSApIDoKCQkJCQlkYXRhOwoJCQl9IGNhdGNoKCBlcnIgKSB7fQoKCQkJcmV0dXJuIGRhdGE7CgkJfSwKCgkJLy8gRXhwb3NlIG91ciBjYWNoZSBmb3IgdGVzdGluZyBwdXJwb3Nlcy4KCQluc05vcm1hbGl6ZURpY3Q6IG5zTm9ybWFsaXplRGljdCwKCgkJLy8gVGFrZSBhIGRhdGEgYXR0cmlidXRlIHByb3BlcnR5LCBwcmVwZW5kIHRoZSBuYW1lc3BhY2UKCQkvLyBhbmQgdGhlbiBjYW1lbCBjYXNlIHRoZSBhdHRyaWJ1dGUgc3RyaW5nLiBBZGQgdGhlIHJlc3VsdAoJCS8vIHRvIG91ciBuc05vcm1hbGl6ZURpY3Qgc28gd2UgZG9uJ3QgaGF2ZSB0byBkbyB0aGlzIGFnYWluLgoJCW5zTm9ybWFsaXplOiBmdW5jdGlvbiggcHJvcCApIHsKCQkJcmV0dXJuIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdIHx8CgkJCQkoIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdID0gJC5jYW1lbENhc2UoICQubW9iaWxlLm5zICsgcHJvcCApICk7CgkJfSwKCgkJLy8gRmluZCB0aGUgY2xvc2VzdCBqYXZhc2NyaXB0IHBhZ2UgZWxlbWVudCB0byBnYXRoZXIgc2V0dGluZ3MgZGF0YSBqc3BlcmYgdGVzdAoJCS8vIGh0dHA6Ly9qc3BlcmYuY29tL3NpbmdsZS1jb21wbGV4LXNlbGVjdG9yLXZzLW1hbnktY29tcGxleC1zZWxlY3RvcnMvZWRpdAoJCS8vIHBvc3NpYmx5IG5haXZlLCBidXQgaXQgc2hvd3MgdGhhdCB0aGUgcGFyc2luZyBvdmVyaGVhZCBmb3IgKmp1c3QqIHRoZSBwYWdlIHNlbGVjdG9yIHZzCgkJLy8gdGhlIHBhZ2UgYW5kIGRpYWxvZyBzZWxlY3RvciBpcyBuZWdsaWdhYmxlLiBUaGlzIGNvdWxkIHByb2JhYmx5IGJlIHNwZWVkIHVwIGJ5CgkJLy8gZG9pbmcgYSBzaW1pbGFyIHBhcmVudCBub2RlIHRyYXZlcnNhbCB0byB0aGUgb25lIGZvdW5kIGluIHRoZSBpbmhlcml0ZWQgdGhlbWUgY29kZSBhYm92ZQoJCWNsb3Nlc3RQYWdlRGF0YTogZnVuY3Rpb24oICR0YXJnZXQgKSB7CgkJCXJldHVybiAkdGFyZ2V0CgkJCQkuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkKCQkJCS5kYXRhKCAibW9iaWxlLXBhZ2UiICk7CgkJfQoKCX0pOwoKCS8vIE1vYmlsZSB2ZXJzaW9uIG9mIGRhdGEgYW5kIHJlbW92ZURhdGEgYW5kIGhhc0RhdGEgbWV0aG9kcwoJLy8gZW5zdXJlcyBhbGwgZGF0YSBpcyBzZXQgYW5kIHJldHJpZXZlZCB1c2luZyBqUXVlcnkgTW9iaWxlJ3MgZGF0YSBuYW1lc3BhY2UKCSQuZm4uanFtRGF0YSA9IGZ1bmN0aW9uKCBwcm9wLCB2YWx1ZSApIHsKCQl2YXIgcmVzdWx0OwoJCWlmICggdHlwZW9mIHByb3AgIT09ICJ1bmRlZmluZWQiICkgewoJCQlpZiAoIHByb3AgKSB7CgkJCQlwcm9wID0gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKTsKCQkJfQoKCQkJLy8gdW5kZWZpbmVkIGlzIHBlcm1pdHRlZCBhcyBhbiBleHBsaWNpdCBpbnB1dCBmb3IgdGhlIHNlY29uZCBwYXJhbQoJCQkvLyBpbiB0aGlzIGNhc2UgaXQgcmV0dXJucyB0aGUgdmFsdWUgYW5kIGRvZXMgbm90IHNldCBpdCB0byB1bmRlZmluZWQKCQkJaWYgKCBhcmd1bWVudHMubGVuZ3RoIDwgMiB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJcmVzdWx0ID0gdGhpcy5kYXRhKCBwcm9wICk7CgkJCX0gZWxzZSB7CgkJCQlyZXN1bHQgPSB0aGlzLmRhdGEoIHByb3AsIHZhbHVlICk7CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07CgoJJC5qcW1EYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCXJlc3VsdCA9ICQuZGF0YSggZWxlbSwgcHJvcCA/ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgOiBwcm9wLCB2YWx1ZSApOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmZuLmpxbVJlbW92ZURhdGEgPSBmdW5jdGlvbiggcHJvcCApIHsKCQlyZXR1cm4gdGhpcy5yZW1vdmVEYXRhKCAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApICk7Cgl9OwoKCSQuanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wICkgewoJCXJldHVybiAkLnJlbW92ZURhdGEoIGVsZW0sICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5maW5kID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0LCByZXQsIGV4dHJhICkgewoJCWlmICggc2VsZWN0b3IuaW5kZXhPZiggIjpqcW1EYXRhIiApID4gLTEgKSB7CgkJCXNlbGVjdG9yID0gc2VsZWN0b3IucmVwbGFjZSgganFtRGF0YVJFLCAiW2RhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICIkMV0iICk7CgkJfQoKCQlyZXR1cm4gb2xkRmluZC5jYWxsKCB0aGlzLCBzZWxlY3RvciwgY29udGV4dCwgcmV0LCBleHRyYSApOwoJfTsKCgkkLmV4dGVuZCggJC5maW5kLCBvbGRGaW5kICk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKiEKICogalF1ZXJ5IFVJIENvcmUgYzBhYjcxMDU2YjkzNjYyN2U4YTc4MjFmMDNjMDQ0YWVjNjI4MGE0MAogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2NhdGVnb3J5L3VpLWNvcmUvCiAqLwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciB1dWlkID0gMCwKCXJ1bmlxdWVJZCA9IC9edWktaWQtXGQrJC87CgovLyAkLnVpIG1pZ2h0IGV4aXN0IGZyb20gY29tcG9uZW50cyB3aXRoIG5vIGRlcGVuZGVuY2llcywgZS5nLiwgJC51aS5wb3NpdGlvbgokLnVpID0gJC51aSB8fCB7fTsKCiQuZXh0ZW5kKCAkLnVpLCB7Cgl2ZXJzaW9uOiAiYzBhYjcxMDU2YjkzNjYyN2U4YTc4MjFmMDNjMDQ0YWVjNjI4MGE0MCIsCgoJa2V5Q29kZTogewoJCUJBQ0tTUEFDRTogOCwKCQlDT01NQTogMTg4LAoJCURFTEVURTogNDYsCgkJRE9XTjogNDAsCgkJRU5EOiAzNSwKCQlFTlRFUjogMTMsCgkJRVNDQVBFOiAyNywKCQlIT01FOiAzNiwKCQlMRUZUOiAzNywKCQlQQUdFX0RPV046IDM0LAoJCVBBR0VfVVA6IDMzLAoJCVBFUklPRDogMTkwLAoJCVJJR0hUOiAzOSwKCQlTUEFDRTogMzIsCgkJVEFCOiA5LAoJCVVQOiAzOAoJfQp9KTsKCi8vIHBsdWdpbnMKJC5mbi5leHRlbmQoewoJZm9jdXM6IChmdW5jdGlvbiggb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGRlbGF5LCBmbiApIHsKCQkJcmV0dXJuIHR5cGVvZiBkZWxheSA9PT0gIm51bWJlciIgPwoJCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCXZhciBlbGVtID0gdGhpczsKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQkkKCBlbGVtICkuZm9jdXMoKTsKCQkJCQkJaWYgKCBmbiApIHsKCQkJCQkJCWZuLmNhbGwoIGVsZW0gKTsKCQkJCQkJfQoJCQkJCX0sIGRlbGF5ICk7CgkJCQl9KSA6CgkJCQlvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl9OwoJfSkoICQuZm4uZm9jdXMgKSwKCglzY3JvbGxQYXJlbnQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzY3JvbGxQYXJlbnQ7CgkJaWYgKCgkLnVpLmllICYmICgvKHN0YXRpY3xyZWxhdGl2ZSkvKS50ZXN0KHRoaXMuY3NzKCJwb3NpdGlvbiIpKSkgfHwgKC9hYnNvbHV0ZS8pLnRlc3QodGhpcy5jc3MoInBvc2l0aW9uIikpKSB7CgkJCXNjcm9sbFBhcmVudCA9IHRoaXMucGFyZW50cygpLmZpbHRlcihmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoLyhyZWxhdGl2ZXxhYnNvbHV0ZXxmaXhlZCkvKS50ZXN0KCQuY3NzKHRoaXMsInBvc2l0aW9uIikpICYmICgvKGF1dG98c2Nyb2xsKS8pLnRlc3QoJC5jc3ModGhpcywib3ZlcmZsb3ciKSskLmNzcyh0aGlzLCJvdmVyZmxvdy15IikrJC5jc3ModGhpcywib3ZlcmZsb3cteCIpKTsKCQkJfSkuZXEoMCk7CgkJfSBlbHNlIHsKCQkJc2Nyb2xsUGFyZW50ID0gdGhpcy5wYXJlbnRzKCkuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICgvKGF1dG98c2Nyb2xsKS8pLnRlc3QoJC5jc3ModGhpcywib3ZlcmZsb3ciKSskLmNzcyh0aGlzLCJvdmVyZmxvdy15IikrJC5jc3ModGhpcywib3ZlcmZsb3cteCIpKTsKCQkJfSkuZXEoMCk7CgkJfQoKCQlyZXR1cm4gKCAvZml4ZWQvICkudGVzdCggdGhpcy5jc3MoICJwb3NpdGlvbiIpICkgfHwgIXNjcm9sbFBhcmVudC5sZW5ndGggPyAkKCB0aGlzWyAwIF0ub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudCApIDogc2Nyb2xsUGFyZW50OwoJfSwKCgl1bmlxdWVJZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAhdGhpcy5pZCApIHsKCQkJCXRoaXMuaWQgPSAidWktaWQtIiArICgrK3V1aWQpOwoJCQl9CgkJfSk7Cgl9LAoKCXJlbW92ZVVuaXF1ZUlkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoIHJ1bmlxdWVJZC50ZXN0KCB0aGlzLmlkICkgKSB7CgkJCQkkKCB0aGlzICkucmVtb3ZlQXR0ciggImlkIiApOwoJCQl9CgkJfSk7Cgl9Cn0pOwoKLy8gc2VsZWN0b3JzCmZ1bmN0aW9uIGZvY3VzYWJsZSggZWxlbWVudCwgaXNUYWJJbmRleE5vdE5hTiApIHsKCXZhciBtYXAsIG1hcE5hbWUsIGltZywKCQlub2RlTmFtZSA9IGVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCWlmICggImFyZWEiID09PSBub2RlTmFtZSApIHsKCQltYXAgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJbWFwTmFtZSA9IG1hcC5uYW1lOwoJCWlmICggIWVsZW1lbnQuaHJlZiB8fCAhbWFwTmFtZSB8fCBtYXAubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gIm1hcCIgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaW1nID0gJCggImltZ1t1c2VtYXA9IyIgKyBtYXBOYW1lICsgIl0iIClbMF07CgkJcmV0dXJuICEhaW1nICYmIHZpc2libGUoIGltZyApOwoJfQoJcmV0dXJuICggL2lucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b258b2JqZWN0Ly50ZXN0KCBub2RlTmFtZSApID8KCQkhZWxlbWVudC5kaXNhYmxlZCA6CgkJImEiID09PSBub2RlTmFtZSA/CgkJCWVsZW1lbnQuaHJlZiB8fCBpc1RhYkluZGV4Tm90TmFOIDoKCQkJaXNUYWJJbmRleE5vdE5hTikgJiYKCQkvLyB0aGUgZWxlbWVudCBhbmQgYWxsIG9mIGl0cyBhbmNlc3RvcnMgbXVzdCBiZSB2aXNpYmxlCgkJdmlzaWJsZSggZWxlbWVudCApOwp9CgpmdW5jdGlvbiB2aXNpYmxlKCBlbGVtZW50ICkgewoJcmV0dXJuICQuZXhwci5maWx0ZXJzLnZpc2libGUoIGVsZW1lbnQgKSAmJgoJCSEkKCBlbGVtZW50ICkucGFyZW50cygpLmFkZEJhY2soKS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLmNzcyggdGhpcywgInZpc2liaWxpdHkiICkgPT09ICJoaWRkZW4iOwoJCX0pLmxlbmd0aDsKfQoKJC5leHRlbmQoICQuZXhwclsgIjoiIF0sIHsKCWRhdGE6ICQuZXhwci5jcmVhdGVQc2V1ZG8gPwoJCSQuZXhwci5jcmVhdGVQc2V1ZG8oZnVuY3Rpb24oIGRhdGFOYW1lICkgewoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGRhdGFOYW1lICk7CgkJCX07CgkJfSkgOgoJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJZnVuY3Rpb24oIGVsZW0sIGksIG1hdGNoICkgewoJCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIG1hdGNoWyAzIF0gKTsKCQl9LAoKCWZvY3VzYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJcmV0dXJuIGZvY3VzYWJsZSggZWxlbWVudCwgIWlzTmFOKCAkLmF0dHIoIGVsZW1lbnQsICJ0YWJpbmRleCIgKSApICk7Cgl9LAoKCXRhYmJhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl2YXIgdGFiSW5kZXggPSAkLmF0dHIoIGVsZW1lbnQsICJ0YWJpbmRleCIgKSwKCQkJaXNUYWJJbmRleE5hTiA9IGlzTmFOKCB0YWJJbmRleCApOwoJCXJldHVybiAoIGlzVGFiSW5kZXhOYU4gfHwgdGFiSW5kZXggPj0gMCApICYmIGZvY3VzYWJsZSggZWxlbWVudCwgIWlzVGFiSW5kZXhOYU4gKTsKCX0KfSk7CgovLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAppZiAoICEkKCAiPGE+IiApLm91dGVyV2lkdGgoIDEgKS5qcXVlcnkgKSB7CgkkLmVhY2goIFsgIldpZHRoIiwgIkhlaWdodCIgXSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgkJdmFyIHNpZGUgPSBuYW1lID09PSAiV2lkdGgiID8gWyAiTGVmdCIsICJSaWdodCIgXSA6IFsgIlRvcCIsICJCb3R0b20iIF0sCgkJCXR5cGUgPSBuYW1lLnRvTG93ZXJDYXNlKCksCgkJCW9yaWcgPSB7CgkJCQlpbm5lcldpZHRoOiAkLmZuLmlubmVyV2lkdGgsCgkJCQlpbm5lckhlaWdodDogJC5mbi5pbm5lckhlaWdodCwKCQkJCW91dGVyV2lkdGg6ICQuZm4ub3V0ZXJXaWR0aCwKCQkJCW91dGVySGVpZ2h0OiAkLmZuLm91dGVySGVpZ2h0CgkJCX07CgoJCWZ1bmN0aW9uIHJlZHVjZSggZWxlbSwgc2l6ZSwgYm9yZGVyLCBtYXJnaW4gKSB7CgkJCSQuZWFjaCggc2lkZSwgZnVuY3Rpb24oKSB7CgkJCQlzaXplIC09IHBhcnNlRmxvYXQoICQuY3NzKCBlbGVtLCAicGFkZGluZyIgKyB0aGlzICkgKSB8fCAwOwoJCQkJaWYgKCBib3JkZXIgKSB7CgkJCQkJc2l6ZSAtPSBwYXJzZUZsb2F0KCAkLmNzcyggZWxlbSwgImJvcmRlciIgKyB0aGlzICsgIldpZHRoIiApICkgfHwgMDsKCQkJCX0KCQkJCWlmICggbWFyZ2luICkgewoJCQkJCXNpemUgLT0gcGFyc2VGbG9hdCggJC5jc3MoIGVsZW0sICJtYXJnaW4iICsgdGhpcyApICkgfHwgMDsKCQkJCX0KCQkJfSk7CgkJCXJldHVybiBzaXplOwoJCX0KCgkJJC5mblsgImlubmVyIiArIG5hbWUgXSA9IGZ1bmN0aW9uKCBzaXplICkgewoJCQlpZiAoIHNpemUgPT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiBvcmlnWyAiaW5uZXIiICsgbmFtZSBdLmNhbGwoIHRoaXMgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5jc3MoIHR5cGUsIHJlZHVjZSggdGhpcywgc2l6ZSApICsgInB4IiApOwoJCQl9KTsKCQl9OwoKCQkkLmZuWyAib3V0ZXIiICsgbmFtZV0gPSBmdW5jdGlvbiggc2l6ZSwgbWFyZ2luICkgewoJCQlpZiAoIHR5cGVvZiBzaXplICE9PSAibnVtYmVyIiApIHsKCQkJCXJldHVybiBvcmlnWyAib3V0ZXIiICsgbmFtZSBdLmNhbGwoIHRoaXMsIHNpemUgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMpLmNzcyggdHlwZSwgcmVkdWNlKCB0aGlzLCBzaXplLCB0cnVlLCBtYXJnaW4gKSArICJweCIgKTsKCQkJfSk7CgkJfTsKCX0pOwp9CgovLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAppZiAoICEkLmZuLmFkZEJhY2sgKSB7CgkkLmZuLmFkZEJhY2sgPSBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMuYWRkKCBzZWxlY3RvciA9PSBudWxsID8KCQkJdGhpcy5wcmV2T2JqZWN0IDogdGhpcy5wcmV2T2JqZWN0LmZpbHRlciggc2VsZWN0b3IgKQoJCSk7Cgl9Owp9CgovLyBzdXBwb3J0OiBqUXVlcnkgMS42LjEsIDEuNi4yIChodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC85NDEzKQppZiAoICQoICI8YT4iICkuZGF0YSggImEtYiIsICJhIiApLnJlbW92ZURhdGEoICJhLWIiICkuZGF0YSggImEtYiIgKSApIHsKCSQuZm4ucmVtb3ZlRGF0YSA9IChmdW5jdGlvbiggcmVtb3ZlRGF0YSApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGtleSApIHsKCQkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQkJcmV0dXJuIHJlbW92ZURhdGEuY2FsbCggdGhpcywgJC5jYW1lbENhc2UoIGtleSApICk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gcmVtb3ZlRGF0YS5jYWxsKCB0aGlzICk7CgkJCX0KCQl9OwoJfSkoICQuZm4ucmVtb3ZlRGF0YSApOwp9CgoKCgoKLy8gZGVwcmVjYXRlZAokLnVpLmllID0gISEvbXNpZSBbXHcuXSsvLmV4ZWMoIG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSApOwoKJC5zdXBwb3J0LnNlbGVjdHN0YXJ0ID0gIm9uc2VsZWN0c3RhcnQiIGluIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CiQuZm4uZXh0ZW5kKHsKCWRpc2FibGVTZWxlY3Rpb246IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmJpbmQoICggJC5zdXBwb3J0LnNlbGVjdHN0YXJ0ID8gInNlbGVjdHN0YXJ0IiA6ICJtb3VzZWRvd24iICkgKwoJCQkiLnVpLWRpc2FibGVTZWxlY3Rpb24iLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9KTsKCX0sCgoJZW5hYmxlU2VsZWN0aW9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy51bmJpbmQoICIudWktZGlzYWJsZVNlbGVjdGlvbiIgKTsKCX0sCgoJekluZGV4OiBmdW5jdGlvbiggekluZGV4ICkgewoJCWlmICggekluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0aGlzLmNzcyggInpJbmRleCIsIHpJbmRleCApOwoJCX0KCgkJaWYgKCB0aGlzLmxlbmd0aCApIHsKCQkJdmFyIGVsZW0gPSAkKCB0aGlzWyAwIF0gKSwgcG9zaXRpb24sIHZhbHVlOwoJCQl3aGlsZSAoIGVsZW0ubGVuZ3RoICYmIGVsZW1bIDAgXSAhPT0gZG9jdW1lbnQgKSB7CgkJCQkvLyBJZ25vcmUgei1pbmRleCBpZiBwb3NpdGlvbiBpcyBzZXQgdG8gYSB2YWx1ZSB3aGVyZSB6LWluZGV4IGlzIGlnbm9yZWQgYnkgdGhlIGJyb3dzZXIKCQkJCS8vIFRoaXMgbWFrZXMgYmVoYXZpb3Igb2YgdGhpcyBmdW5jdGlvbiBjb25zaXN0ZW50IGFjcm9zcyBicm93c2VycwoJCQkJLy8gV2ViS2l0IGFsd2F5cyByZXR1cm5zIGF1dG8gaWYgdGhlIGVsZW1lbnQgaXMgcG9zaXRpb25lZAoJCQkJcG9zaXRpb24gPSBlbGVtLmNzcyggInBvc2l0aW9uIiApOwoJCQkJaWYgKCBwb3NpdGlvbiA9PT0gImFic29sdXRlIiB8fCBwb3NpdGlvbiA9PT0gInJlbGF0aXZlIiB8fCBwb3NpdGlvbiA9PT0gImZpeGVkIiApIHsKCQkJCQkvLyBJRSByZXR1cm5zIDAgd2hlbiB6SW5kZXggaXMgbm90IHNwZWNpZmllZAoJCQkJCS8vIG90aGVyIGJyb3dzZXJzIHJldHVybiBhIHN0cmluZwoJCQkJCS8vIHdlIGlnbm9yZSB0aGUgY2FzZSBvZiBuZXN0ZWQgZWxlbWVudHMgd2l0aCBhbiBleHBsaWNpdCB2YWx1ZSBvZiAwCgkJCQkJLy8gPGRpdiBzdHlsZT0iei1pbmRleDogLTEwOyI+PGRpdiBzdHlsZT0iei1pbmRleDogMDsiPjwvZGl2PjwvZGl2PgoJCQkJCXZhbHVlID0gcGFyc2VJbnQoIGVsZW0uY3NzKCAiekluZGV4IiApLCAxMCApOwoJCQkJCWlmICggIWlzTmFOKCB2YWx1ZSApICYmIHZhbHVlICE9PSAwICkgewoJCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQkJfQoJCQkJfQoJCQkJZWxlbSA9IGVsZW0ucGFyZW50KCk7CgkJCX0KCQl9CgoJCXJldHVybiAwOwoJfQp9KTsKCi8vICQudWkucGx1Z2luIGlzIGRlcHJlY2F0ZWQuIFVzZSAkLndpZGdldCgpIGV4dGVuc2lvbnMgaW5zdGVhZC4KJC51aS5wbHVnaW4gPSB7CglhZGQ6IGZ1bmN0aW9uKCBtb2R1bGUsIG9wdGlvbiwgc2V0ICkgewoJCXZhciBpLAoJCQlwcm90byA9ICQudWlbIG1vZHVsZSBdLnByb3RvdHlwZTsKCQlmb3IgKCBpIGluIHNldCApIHsKCQkJcHJvdG8ucGx1Z2luc1sgaSBdID0gcHJvdG8ucGx1Z2luc1sgaSBdIHx8IFtdOwoJCQlwcm90by5wbHVnaW5zWyBpIF0ucHVzaCggWyBvcHRpb24sIHNldFsgaSBdIF0gKTsKCQl9Cgl9LAoJY2FsbDogZnVuY3Rpb24oIGluc3RhbmNlLCBuYW1lLCBhcmdzLCBhbGxvd0Rpc2Nvbm5lY3RlZCApIHsKCQl2YXIgaSwKCQkJc2V0ID0gaW5zdGFuY2UucGx1Z2luc1sgbmFtZSBdOwoKCQlpZiAoICFzZXQgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggIWFsbG93RGlzY29ubmVjdGVkICYmICggIWluc3RhbmNlLmVsZW1lbnRbIDAgXS5wYXJlbnROb2RlIHx8IGluc3RhbmNlLmVsZW1lbnRbIDAgXS5wYXJlbnROb2RlLm5vZGVUeXBlID09PSAxMSApICkgewoJCQlyZXR1cm47CgkJfQoKCQlmb3IgKCBpID0gMDsgaSA8IHNldC5sZW5ndGg7IGkrKyApIHsKCQkJaWYgKCBpbnN0YW5jZS5vcHRpb25zWyBzZXRbIGkgXVsgMCBdIF0gKSB7CgkJCQlzZXRbIGkgXVsgMSBdLmFwcGx5KCBpbnN0YW5jZS5lbGVtZW50LCBhcmdzICk7CgkJCX0KCQl9Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gZGVmaW5lIHRoZSB3aW5kb3cgYW5kIHRoZSBkb2N1bWVudCBvYmplY3RzCgkJd2luZG93OiAkKCB3aW5kb3cgKSwKCQlkb2N1bWVudDogJCggZG9jdW1lbnQgKSwKCgkJLy8gVE9ETzogUmVtb3ZlIGFuZCB1c2UgJC51aS5rZXlDb2RlIGRpcmVjdGx5CgkJa2V5Q29kZTogJC51aS5rZXlDb2RlLAoKCQkvLyBQbGFjZSB0byBzdG9yZSB2YXJpb3VzIHdpZGdldCBleHRlbnNpb25zCgkJYmVoYXZpb3JzOiB7fSwKCgkJLy8gU2Nyb2xsIHBhZ2UgdmVydGljYWxseTogc2Nyb2xsIHRvIDAgdG8gaGlkZSBpT1MgYWRkcmVzcyBiYXIsIG9yIHBhc3MgYSBZIHZhbHVlCgkJc2lsZW50U2Nyb2xsOiBmdW5jdGlvbiggeXBvcyApIHsKCQkJaWYgKCAkLnR5cGUoIHlwb3MgKSAhPT0gIm51bWJlciIgKSB7CgkJCQl5cG9zID0gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJCX0KCgkJCS8vIHByZXZlbnQgc2Nyb2xsc3RhcnQgYW5kIHNjcm9sbHN0b3AgZXZlbnRzCgkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB5cG9zICk7CgkJCQkkLm1vYmlsZS5kb2N1bWVudC50cmlnZ2VyKCAic2lsZW50c2Nyb2xsIiwgeyB4OiAwLCB5OiB5cG9zIH0pOwoJCQl9LCAyMCApOwoKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJfSwgMTUwICk7CgkJfSwKCgkJZ2V0Q2xvc2VzdEJhc2VVcmw6IGZ1bmN0aW9uKCBlbGUgKQl7CgkJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFnZSBhbmQgZXh0cmFjdCBvdXQgaXRzIHVybC4KCQkJdmFyIHVybCA9ICQoIGVsZSApLmNsb3Nlc3QoICIudWktcGFnZSIgKS5qcW1EYXRhKCAidXJsIiApLAoJCQkJYmFzZSA9ICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgoJCQlpZiAoICEkLm1vYmlsZS5keW5hbWljQmFzZUVuYWJsZWQgfHwgIXVybCB8fCAhJC5tb2JpbGUucGF0aC5pc1BhdGgoIHVybCApICkgewoJCQkJdXJsID0gYmFzZTsKCQkJfQoKCQkJcmV0dXJuICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGJhc2UgKTsKCQl9LAoJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzczogZnVuY3Rpb24oIGZvcmNlUmVtb3ZhbCApIHsKCQkJaWYgKCAhISQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rICYmCgkJCQkoICEkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluay5jbG9zZXN0KCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKS5sZW5ndGggfHwKCQkJCQlmb3JjZVJlbW92YWwgKSApIHsKCgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfQoJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluayA9IG51bGw7CgkJfSwKCgkJLy8gREVQUkVDQVRFRCBpbiAxLjQKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhcmVudCB3aXRoIGEgdGhlbWUgY2xhc3Mgb24gaXQuIE5vdGUgdGhhdAoJCS8vIHdlIGFyZSBub3QgdXNpbmcgJC5mbi5jbG9zZXN0KCkgb24gcHVycG9zZSBoZXJlIGJlY2F1c2UgdGhpcwoJCS8vIG1ldGhvZCBnZXRzIGNhbGxlZCBxdWl0ZSBhIGJpdCBhbmQgd2UgbmVlZCBpdCB0byBiZSBhcyBmYXN0CgkJLy8gYXMgcG9zc2libGUuCgkJZ2V0SW5oZXJpdGVkVGhlbWU6IGZ1bmN0aW9uKCBlbCwgZGVmYXVsdFRoZW1lICkgewoJCQl2YXIgZSA9IGVsWyAwIF0sCgkJCQlsdHIgPSAiIiwKCQkJCXJlID0gL3VpLShiYXJ8Ym9keXxvdmVybGF5KS0oW2Etel0pXGIvLAoJCQkJYywgbTsKCQkJd2hpbGUgKCBlICkgewoJCQkJYyA9IGUuY2xhc3NOYW1lIHx8ICIiOwoJCQkJaWYgKCBjICYmICggbSA9IHJlLmV4ZWMoIGMgKSApICYmICggbHRyID0gbVsgMiBdICkgKSB7CgkJCQkJLy8gV2UgZm91bmQgYSBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzCgkJCQkJLy8gb24gaXQgc28gYmFpbCBmcm9tIHRoaXMgbG9vcC4KCQkJCQlicmVhazsKCQkJCX0KCgkJCQllID0gZS5wYXJlbnROb2RlOwoJCQl9CgkJCS8vIFJldHVybiB0aGUgdGhlbWUgbGV0dGVyIHdlIGZvdW5kLCBpZiBub25lLCByZXR1cm4gdGhlCgkJCS8vIHNwZWNpZmllZCBkZWZhdWx0LgoJCQlyZXR1cm4gbHRyIHx8IGRlZmF1bHRUaGVtZSB8fCAiYSI7CgkJfSwKCgkJZW5oYW5jZWFibGU6IGZ1bmN0aW9uKCBlbGVtZW50cyApIHsKCQkJcmV0dXJuIHRoaXMuaGF2ZVBhcmVudHMoIGVsZW1lbnRzLCAiZW5oYW5jZSIgKTsKCQl9LAoKCQloaWphY2thYmxlOiBmdW5jdGlvbiggZWxlbWVudHMgKSB7CgkJCXJldHVybiB0aGlzLmhhdmVQYXJlbnRzKCBlbGVtZW50cywgImFqYXgiICk7CgkJfSwKCgkJaGF2ZVBhcmVudHM6IGZ1bmN0aW9uKCBlbGVtZW50cywgYXR0ciApIHsKCQkJaWYgKCAhJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgKSB7CgkJCQlyZXR1cm4gZWxlbWVudHM7CgkJCX0KCgkJCXZhciBjb3VudCA9IGVsZW1lbnRzLmxlbmd0aCwKCQkJCSRuZXdTZXQgPSAkKCksCgkJCQllLCAkZWxlbWVudCwgZXhjbHVkZWQsCgkJCQlpLCBjOwoKCQkJZm9yICggaSA9IDA7IGkgPCBjb3VudDsgaSsrICkgewoJCQkJJGVsZW1lbnQgPSBlbGVtZW50cy5lcSggaSApOwoJCQkJZXhjbHVkZWQgPSBmYWxzZTsKCQkJCWUgPSBlbGVtZW50c1sgaSBdOwoKCQkJCXdoaWxlICggZSApIHsKCQkJCQljID0gZS5nZXRBdHRyaWJ1dGUgPyBlLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgYXR0ciApIDogIiI7CgoJCQkJCWlmICggYyA9PT0gImZhbHNlIiApIHsKCQkJCQkJZXhjbHVkZWQgPSB0cnVlOwoJCQkJCQlicmVhazsKCQkJCQl9CgoJCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCQl9CgoJCQkJaWYgKCAhZXhjbHVkZWQgKSB7CgkJCQkJJG5ld1NldCA9ICRuZXdTZXQuYWRkKCAkZWxlbWVudCApOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gJG5ld1NldDsKCQl9LAoKCQlnZXRTY3JlZW5IZWlnaHQ6IGZ1bmN0aW9uKCkgewoJCQkvLyBOYXRpdmUgaW5uZXJIZWlnaHQgcmV0dXJucyBtb3JlIGFjY3VyYXRlIHZhbHVlIGZvciB0aGlzIGFjcm9zcyBwbGF0Zm9ybXMsCgkJCS8vIGpRdWVyeSB2ZXJzaW9uIGlzIGhlcmUgYXMgYSBub3JtYWxpemVkIGZhbGxiYWNrIGZvciBwbGF0Zm9ybXMgbGlrZSBTeW1iaWFuCgkJCXJldHVybiB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJC5tb2JpbGUud2luZG93LmhlaWdodCgpOwoJCX0sCgoJCS8vc2ltcGx5IHNldCB0aGUgYWN0aXZlIHBhZ2UncyBtaW5pbXVtIGhlaWdodCB0byBzY3JlZW4gaGVpZ2h0LCBkZXBlbmRpbmcgb24gb3JpZW50YXRpb24KCQlyZXNldEFjdGl2ZVBhZ2VIZWlnaHQ6IGZ1bmN0aW9uKCBoZWlnaHQgKSB7CgkJCXZhciBwYWdlID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICksCgkJCQlwYWdlSGVpZ2h0ID0gcGFnZS5oZWlnaHQoKSwKCQkJCXBhZ2VPdXRlckhlaWdodCA9IHBhZ2Uub3V0ZXJIZWlnaHQoIHRydWUgKTsKCgkJCWhlaWdodCA9ICggdHlwZW9mIGhlaWdodCA9PT0gIm51bWJlciIgKSA/IGhlaWdodCA6ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQkJcGFnZS5jc3MoICJtaW4taGVpZ2h0IiwgaGVpZ2h0IC0gKCBwYWdlT3V0ZXJIZWlnaHQgLSBwYWdlSGVpZ2h0ICkgKTsKCQl9LAoKCQlsb2FkaW5nOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgY2FsbCB0byB0aGlzIGZ1bmN0aW9uLCBpbnN0YW50aWF0ZSBhIGxvYWRlciB3aWRnZXQKCQkJdmFyIGxvYWRlciA9IHRoaXMubG9hZGluZy5fd2lkZ2V0IHx8ICQoICQubW9iaWxlLmxvYWRlci5wcm90b3R5cGUuZGVmYXVsdEh0bWwgKS5sb2FkZXIoKSwKCgkJCQkvLyBDYWxsIHRoZSBhcHByb3ByaWF0ZSBtZXRob2Qgb24gdGhlIGxvYWRlcgoJCQkJcmV0dXJuVmFsdWUgPSBsb2FkZXIubG9hZGVyLmFwcGx5KCBsb2FkZXIsIGFyZ3VtZW50cyApOwoKCQkJLy8gTWFrZSBzdXJlIHRoZSBsb2FkZXIgaXMgcmV0YWluZWQgZm9yIGZ1dHVyZSBjYWxscyB0byB0aGlzIGZ1bmN0aW9uLgoJCQl0aGlzLmxvYWRpbmcuX3dpZGdldCA9IGxvYWRlcjsKCgkJCXJldHVybiByZXR1cm5WYWx1ZTsKCQl9Cgl9KTsKCgkkLmFkZERlcGVuZGVudHMgPSBmdW5jdGlvbiggZWxlbSwgbmV3RGVwZW5kZW50cyApIHsKCQl2YXIgJGVsZW0gPSAkKCBlbGVtICksCgkJCWRlcGVuZGVudHMgPSAkZWxlbS5qcW1EYXRhKCAiZGVwZW5kZW50cyIgKSB8fCAkKCk7CgoJCSRlbGVtLmpxbURhdGEoICJkZXBlbmRlbnRzIiwgJCggZGVwZW5kZW50cyApLmFkZCggbmV3RGVwZW5kZW50cyApICk7Cgl9OwoKCS8vIHBsdWdpbnMKCSQuZm4uZXh0ZW5kKHsKCQlyZW1vdmVXaXRoRGVwZW5kZW50czogZnVuY3Rpb24oKSB7CgkJCSQucmVtb3ZlV2l0aERlcGVuZGVudHMoIHRoaXMgKTsKCQl9LAoKCQkvLyBFbmhhbmNlIGNoaWxkIGVsZW1lbnRzCgkJZW5oYW5jZVdpdGhpbjogZnVuY3Rpb24oKSB7CgkJCXZhciBpbmRleCwKCQkJCXdpZGdldEVsZW1lbnRzID0ge30sCgkJCQlrZWVwTmF0aXZlID0gJC5tb2JpbGUucGFnZS5wcm90b3R5cGUua2VlcE5hdGl2ZVNlbGVjdG9yKCksCgkJCQl0aGF0ID0gdGhpczsKCgkJCS8vIEFkZCBubyBqcyBjbGFzcyB0byBlbGVtZW50cwoJCQlpZiAoICQubW9iaWxlLm5vanMgKSB7CgkJCQkkLm1vYmlsZS5ub2pzKCB0aGlzICk7CgkJCX0KCgkJCS8vIEJpbmQgbGlua3MgZm9yIGFqYXggbmF2CgkJCWlmICggJC5tb2JpbGUubGlua3MgKSB7CgkJCQkkLm1vYmlsZS5saW5rcyggdGhpcyApOwoJCQl9CgoJCQkvLyBEZWdyYWRlIGlucHV0cyBmb3Igc3R5bGVpbmcKCQkJaWYgKCAkLm1vYmlsZS5kZWdyYWRlSW5wdXRzV2l0aGluICkgewoJCQkJJC5tb2JpbGUuZGVncmFkZUlucHV0c1dpdGhpbiggdGhpcyApOwoJCQl9CgoJCQkvLyBSdW4gYnV0dG9ubWFya3VwCgkJCWlmICggJC5mbi5idXR0b25NYXJrdXAgKSB7CgkJCQl0aGlzLmZpbmQoICQuZm4uYnV0dG9uTWFya3VwLmluaXRTZWxlY3RvciApLm5vdCgga2VlcE5hdGl2ZSApCgkJCQkuanFtRW5oYW5jZWFibGUoKS5idXR0b25NYXJrdXAoKTsKCQkJfQoKCQkJLy8gQWRkIGNsYXNzZXMgZm9yIGZpZWxkQ29udGFpbgoJCQlpZiAoICQuZm4uZmllbGRjb250YWluICkgewoJCQkJdGhpcy5maW5kKCAiOmpxbURhdGEocm9sZT0nZmllbGRjb250YWluJykiICkubm90KCBrZWVwTmF0aXZlICkKCQkJCS5qcW1FbmhhbmNlYWJsZSgpLmZpZWxkY29udGFpbigpOwoJCQl9CgoJCQkvLyBFbmhhbmNlIHdpZGdldHMKCQkJJC5lYWNoKCAkLm1vYmlsZS53aWRnZXRzLCBmdW5jdGlvbiggbmFtZSwgY29uc3RydWN0b3IgKSB7CgoJCQkJLy8gSWYgaW5pdFNlbGVjdG9yIG5vdCBmYWxzZSBmaW5kIGVsZW1lbnRzCgkJCQlpZiAoIGNvbnN0cnVjdG9yLmluaXRTZWxlY3RvciApIHsKCgkJCQkJLy8gRmlsdGVyIGVsZW1lbnRzIHRoYXQgc2hvdWxkIG5vdCBiZSBlbmhhbmNlZCBiYXNlZCBvbiBwYXJlbnRzCgkJCQkJdmFyIGVsZW1lbnRzID0gJC5tb2JpbGUuZW5oYW5jZWFibGUoIHRoYXQuZmluZCggY29uc3RydWN0b3IuaW5pdFNlbGVjdG9yICkgKTsKCgkJCQkJLy8gSWYgYW55IG1hdGNoaW5nIGVsZW1lbnRzIHJlbWFpbiBmaWx0ZXIgb25lcyB3aXRoIGtlZXBOYXRpdmVTZWxlY3RvcgoJCQkJCWlmICggZWxlbWVudHMubGVuZ3RoID4gMCApIHsKCgkJCQkJCS8vICQubW9iaWxlLnBhZ2UucHJvdG90eXBlLmtlZXBOYXRpdmVTZWxlY3RvciBpcyBkZXByZWNhdGVkIHRoaXMgaXMganVzdCBmb3IgYmFja2NvbXBhdAoJCQkJCQkvLyBTd2l0Y2ggdG8gJC5tb2JpbGUua2VlcE5hdGl2ZSBpbiAxLjUgd2hpY2ggaXMganVzdCBhIHZhbHVlIG5vdCBhIGZ1bmN0aW9uCgkJCQkJCWVsZW1lbnRzID0gZWxlbWVudHMubm90KCBrZWVwTmF0aXZlICk7CgkJCQkJfQoKCQkJCQkvLyBFbmhhbmNlIHdoYXRldmVyIGlzIGxlZnQKCQkJCQlpZiAoIGVsZW1lbnRzLmxlbmd0aCA+IDAgKSB7CgkJCQkJCXdpZGdldEVsZW1lbnRzWyBjb25zdHJ1Y3Rvci5wcm90b3R5cGUud2lkZ2V0TmFtZSBdID0gZWxlbWVudHM7CgkJCQkJfQoJCQkJfQoJCQl9KTsKCgkJCWZvciAoIGluZGV4IGluIHdpZGdldEVsZW1lbnRzICkgewoJCQkJd2lkZ2V0RWxlbWVudHNbIGluZGV4IF1bIGluZGV4IF0oKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJYWRkRGVwZW5kZW50czogZnVuY3Rpb24oIG5ld0RlcGVuZGVudHMgKSB7CgkJCSQuYWRkRGVwZW5kZW50cyggdGhpcywgbmV3RGVwZW5kZW50cyApOwoJCX0sCgoJCS8vIG5vdGUgdGhhdCB0aGlzIGhlbHBlciBkb2Vzbid0IGF0dGVtcHQgdG8gaGFuZGxlIHRoZSBjYWxsYmFjawoJCS8vIG9yIHNldHRpbmcgb2YgYW4gaHRtbCBlbGVtZW50J3MgdGV4dCwgaXRzIG9ubHkgcHVycG9zZSBpcwoJCS8vIHRvIHJldHVybiB0aGUgaHRtbCBlbmNvZGVkIHZlcnNpb24gb2YgdGhlIHRleHQgaW4gYWxsIGNhc2VzLiAodGh1cyB0aGUgbmFtZSkKCQlnZXRFbmNvZGVkVGV4dDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkKCAiPGE+IiApLnRleHQoIHRoaXMudGV4dCgpICkuaHRtbCgpOwoJCX0sCgoJCS8vIGZsdWVudCBoZWxwZXIgZnVuY3Rpb24gZm9yIHRoZSBtb2JpbGUgbmFtZXNwYWNlZCBlcXVpdmFsZW50CgkJanFtRW5oYW5jZWFibGU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuZW5oYW5jZWFibGUoIHRoaXMgKTsKCQl9LAoKCQlqcW1IaWphY2thYmxlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmhpamFja2FibGUoIHRoaXMgKTsKCQl9Cgl9KTsKCgkkLnJlbW92ZVdpdGhEZXBlbmRlbnRzID0gZnVuY3Rpb24oIG5hdGl2ZUVsZW1lbnQgKSB7CgkJdmFyIGVsZW1lbnQgPSAkKCBuYXRpdmVFbGVtZW50ICk7CgoJCSggZWxlbWVudC5qcW1EYXRhKCAiZGVwZW5kZW50cyIgKSB8fCAkKCkgKS5yZW1vdmUoKTsKCQllbGVtZW50LnJlbW92ZSgpOwoJfTsKCSQuYWRkRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBuYXRpdmVFbGVtZW50LCBuZXdEZXBlbmRlbnRzICkgewoJCXZhciBlbGVtZW50ID0gJCggbmF0aXZlRWxlbWVudCApLAoJCQlkZXBlbmRlbnRzID0gZWxlbWVudC5qcW1EYXRhKCAiZGVwZW5kZW50cyIgKSB8fCAkKCk7CgoJCWVsZW1lbnQuanFtRGF0YSggImRlcGVuZGVudHMiLCAkKCBkZXBlbmRlbnRzICkuYWRkKCBuZXdEZXBlbmRlbnRzICkgKTsKCX07CgoJJC5maW5kLm1hdGNoZXMgPSBmdW5jdGlvbiggZXhwciwgc2V0ICkgewoJCXJldHVybiAkLmZpbmQoIGV4cHIsIG51bGwsIG51bGwsIHNldCApOwoJfTsKCgkkLmZpbmQubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24oIG5vZGUsIGV4cHIgKSB7CgkJcmV0dXJuICQuZmluZCggZXhwciwgbnVsbCwgbnVsbCwgWyBub2RlIF0gKS5sZW5ndGggPiAwOwoJfTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCgovKiEKICogalF1ZXJ5IFVJIFdpZGdldCBjMGFiNzEwNTZiOTM2NjI3ZThhNzgyMWYwM2MwNDRhZWM2MjgwYTQwTgogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2pRdWVyeS53aWRnZXQvCiAqLwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciB1dWlkID0gMCwKCXNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLAoJX2NsZWFuRGF0YSA9ICQuY2xlYW5EYXRhOwokLmNsZWFuRGF0YSA9IGZ1bmN0aW9uKCBlbGVtcyApIHsKCWZvciAoIHZhciBpID0gMCwgZWxlbTsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCXRyeSB7CgkJCSQoIGVsZW0gKS50cmlnZ2VySGFuZGxlciggInJlbW92ZSIgKTsKCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC84MjM1CgkJfSBjYXRjaCggZSApIHt9Cgl9CglfY2xlYW5EYXRhKCBlbGVtcyApOwp9OwoKJC53aWRnZXQgPSBmdW5jdGlvbiggbmFtZSwgYmFzZSwgcHJvdG90eXBlICkgewoJdmFyIGZ1bGxOYW1lLCBleGlzdGluZ0NvbnN0cnVjdG9yLCBjb25zdHJ1Y3RvciwgYmFzZVByb3RvdHlwZSwKCQkvLyBwcm94aWVkUHJvdG90eXBlIGFsbG93cyB0aGUgcHJvdmlkZWQgcHJvdG90eXBlIHRvIHJlbWFpbiB1bm1vZGlmaWVkCgkJLy8gc28gdGhhdCBpdCBjYW4gYmUgdXNlZCBhcyBhIG1peGluIGZvciBtdWx0aXBsZSB3aWRnZXRzICgjODg3NikKCQlwcm94aWVkUHJvdG90eXBlID0ge30sCgkJbmFtZXNwYWNlID0gbmFtZS5zcGxpdCggIi4iIClbIDAgXTsKCgluYW1lID0gbmFtZS5zcGxpdCggIi4iIClbIDEgXTsKCWZ1bGxOYW1lID0gbmFtZXNwYWNlICsgIi0iICsgbmFtZTsKCglpZiAoICFwcm90b3R5cGUgKSB7CgkJcHJvdG90eXBlID0gYmFzZTsKCQliYXNlID0gJC5XaWRnZXQ7Cgl9CgoJLy8gY3JlYXRlIHNlbGVjdG9yIGZvciBwbHVnaW4KCSQuZXhwclsgIjoiIF1bIGZ1bGxOYW1lLnRvTG93ZXJDYXNlKCkgXSA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiAhISQuZGF0YSggZWxlbSwgZnVsbE5hbWUgKTsKCX07CgoJJFsgbmFtZXNwYWNlIF0gPSAkWyBuYW1lc3BhY2UgXSB8fCB7fTsKCWV4aXN0aW5nQ29uc3RydWN0b3IgPSAkWyBuYW1lc3BhY2UgXVsgbmFtZSBdOwoJY29uc3RydWN0b3IgPSAkWyBuYW1lc3BhY2UgXVsgbmFtZSBdID0gZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7CgkJLy8gYWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0ICJuZXciIGtleXdvcmQKCQlpZiAoICF0aGlzLl9jcmVhdGVXaWRnZXQgKSB7CgkJCXJldHVybiBuZXcgY29uc3RydWN0b3IoIG9wdGlvbnMsIGVsZW1lbnQgKTsKCQl9CgoJCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCBpbml0aWFsaXppbmcgZm9yIHNpbXBsZSBpbmhlcml0YW5jZQoJCS8vIG11c3QgdXNlICJuZXciIGtleXdvcmQgKHRoZSBjb2RlIGFib3ZlIGFsd2F5cyBwYXNzZXMgYXJncykKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggKSB7CgkJCXRoaXMuX2NyZWF0ZVdpZGdldCggb3B0aW9ucywgZWxlbWVudCApOwoJCX0KCX07CgkvLyBleHRlbmQgd2l0aCB0aGUgZXhpc3RpbmcgY29uc3RydWN0b3IgdG8gY2Fycnkgb3ZlciBhbnkgc3RhdGljIHByb3BlcnRpZXMKCSQuZXh0ZW5kKCBjb25zdHJ1Y3RvciwgZXhpc3RpbmdDb25zdHJ1Y3RvciwgewoJCXZlcnNpb246IHByb3RvdHlwZS52ZXJzaW9uLAoJCS8vIGNvcHkgdGhlIG9iamVjdCB1c2VkIHRvIGNyZWF0ZSB0aGUgcHJvdG90eXBlIGluIGNhc2Ugd2UgbmVlZCB0bwoJCS8vIHJlZGVmaW5lIHRoZSB3aWRnZXQgbGF0ZXIKCQlfcHJvdG86ICQuZXh0ZW5kKCB7fSwgcHJvdG90eXBlICksCgkJLy8gdHJhY2sgd2lkZ2V0cyB0aGF0IGluaGVyaXQgZnJvbSB0aGlzIHdpZGdldCBpbiBjYXNlIHRoaXMgd2lkZ2V0IGlzCgkJLy8gcmVkZWZpbmVkIGFmdGVyIGEgd2lkZ2V0IGluaGVyaXRzIGZyb20gaXQKCQlfY2hpbGRDb25zdHJ1Y3RvcnM6IFtdCgl9KTsKCgliYXNlUHJvdG90eXBlID0gbmV3IGJhc2UoKTsKCS8vIHdlIG5lZWQgdG8gbWFrZSB0aGUgb3B0aW9ucyBoYXNoIGEgcHJvcGVydHkgZGlyZWN0bHkgb24gdGhlIG5ldyBpbnN0YW5jZQoJLy8gb3RoZXJ3aXNlIHdlJ2xsIG1vZGlmeSB0aGUgb3B0aW9ucyBoYXNoIG9uIHRoZSBwcm90b3R5cGUgdGhhdCB3ZSdyZQoJLy8gaW5oZXJpdGluZyBmcm9tCgliYXNlUHJvdG90eXBlLm9wdGlvbnMgPSAkLndpZGdldC5leHRlbmQoIHt9LCBiYXNlUHJvdG90eXBlLm9wdGlvbnMgKTsKCSQuZWFjaCggcHJvdG90eXBlLCBmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7CgkJaWYgKCAhJC5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlwcm94aWVkUHJvdG90eXBlWyBwcm9wIF0gPSB2YWx1ZTsKCQkJcmV0dXJuOwoJCX0KCQlwcm94aWVkUHJvdG90eXBlWyBwcm9wIF0gPSAoZnVuY3Rpb24oKSB7CgkJCXZhciBfc3VwZXIgPSBmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gYmFzZS5wcm90b3R5cGVbIHByb3AgXS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCQl9LAoJCQkJX3N1cGVyQXBwbHkgPSBmdW5jdGlvbiggYXJncyApIHsKCQkJCQlyZXR1cm4gYmFzZS5wcm90b3R5cGVbIHByb3AgXS5hcHBseSggdGhpcywgYXJncyApOwoJCQkJfTsKCQkJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCQkJdmFyIF9fc3VwZXIgPSB0aGlzLl9zdXBlciwKCQkJCQlfX3N1cGVyQXBwbHkgPSB0aGlzLl9zdXBlckFwcGx5LAoJCQkJCXJldHVyblZhbHVlOwoKCQkJCXRoaXMuX3N1cGVyID0gX3N1cGVyOwoJCQkJdGhpcy5fc3VwZXJBcHBseSA9IF9zdXBlckFwcGx5OwoKCQkJCXJldHVyblZhbHVlID0gdmFsdWUuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoKCQkJCXRoaXMuX3N1cGVyID0gX19zdXBlcjsKCQkJCXRoaXMuX3N1cGVyQXBwbHkgPSBfX3N1cGVyQXBwbHk7CgoJCQkJcmV0dXJuIHJldHVyblZhbHVlOwoJCQl9OwoJCX0pKCk7Cgl9KTsKCWNvbnN0cnVjdG9yLnByb3RvdHlwZSA9ICQud2lkZ2V0LmV4dGVuZCggYmFzZVByb3RvdHlwZSwgewoJCS8vIFRPRE86IHJlbW92ZSBzdXBwb3J0IGZvciB3aWRnZXRFdmVudFByZWZpeAoJCS8vIGFsd2F5cyB1c2UgdGhlIG5hbWUgKyBhIGNvbG9uIGFzIHRoZSBwcmVmaXgsIGUuZy4sIGRyYWdnYWJsZTpzdGFydAoJCS8vIGRvbid0IHByZWZpeCBmb3Igd2lkZ2V0cyB0aGF0IGFyZW4ndCBET00tYmFzZWQKCQl3aWRnZXRFdmVudFByZWZpeDogZXhpc3RpbmdDb25zdHJ1Y3RvciA/IChiYXNlUHJvdG90eXBlLndpZGdldEV2ZW50UHJlZml4IHx8IG5hbWUpIDogbmFtZQoJfSwgcHJveGllZFByb3RvdHlwZSwgewoJCWNvbnN0cnVjdG9yOiBjb25zdHJ1Y3RvciwKCQluYW1lc3BhY2U6IG5hbWVzcGFjZSwKCQl3aWRnZXROYW1lOiBuYW1lLAoJCXdpZGdldEZ1bGxOYW1lOiBmdWxsTmFtZQoJfSk7CgoJLy8gSWYgdGhpcyB3aWRnZXQgaXMgYmVpbmcgcmVkZWZpbmVkIHRoZW4gd2UgbmVlZCB0byBmaW5kIGFsbCB3aWRnZXRzIHRoYXQKCS8vIGFyZSBpbmhlcml0aW5nIGZyb20gaXQgYW5kIHJlZGVmaW5lIGFsbCBvZiB0aGVtIHNvIHRoYXQgdGhleSBpbmhlcml0IGZyb20KCS8vIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGlzIHdpZGdldC4gV2UncmUgZXNzZW50aWFsbHkgdHJ5aW5nIHRvIHJlcGxhY2Ugb25lCgkvLyBsZXZlbCBpbiB0aGUgcHJvdG90eXBlIGNoYWluLgoJaWYgKCBleGlzdGluZ0NvbnN0cnVjdG9yICkgewoJCSQuZWFjaCggZXhpc3RpbmdDb25zdHJ1Y3Rvci5fY2hpbGRDb25zdHJ1Y3RvcnMsIGZ1bmN0aW9uKCBpLCBjaGlsZCApIHsKCQkJdmFyIGNoaWxkUHJvdG90eXBlID0gY2hpbGQucHJvdG90eXBlOwoKCQkJLy8gcmVkZWZpbmUgdGhlIGNoaWxkIHdpZGdldCB1c2luZyB0aGUgc2FtZSBwcm90b3R5cGUgdGhhdCB3YXMKCQkJLy8gb3JpZ2luYWxseSB1c2VkLCBidXQgaW5oZXJpdCBmcm9tIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGUgYmFzZQoJCQkkLndpZGdldCggY2hpbGRQcm90b3R5cGUubmFtZXNwYWNlICsgIi4iICsgY2hpbGRQcm90b3R5cGUud2lkZ2V0TmFtZSwgY29uc3RydWN0b3IsIGNoaWxkLl9wcm90byApOwoJCX0pOwoJCS8vIHJlbW92ZSB0aGUgbGlzdCBvZiBleGlzdGluZyBjaGlsZCBjb25zdHJ1Y3RvcnMgZnJvbSB0aGUgb2xkIGNvbnN0cnVjdG9yCgkJLy8gc28gdGhlIG9sZCBjaGlsZCBjb25zdHJ1Y3RvcnMgY2FuIGJlIGdhcmJhZ2UgY29sbGVjdGVkCgkJZGVsZXRlIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzOwoJfSBlbHNlIHsKCQliYXNlLl9jaGlsZENvbnN0cnVjdG9ycy5wdXNoKCBjb25zdHJ1Y3RvciApOwoJfQoKCSQud2lkZ2V0LmJyaWRnZSggbmFtZSwgY29uc3RydWN0b3IgKTsKCglyZXR1cm4gY29uc3RydWN0b3I7Cn07CgokLndpZGdldC5leHRlbmQgPSBmdW5jdGlvbiggdGFyZ2V0ICkgewoJdmFyIGlucHV0ID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJaW5wdXRJbmRleCA9IDAsCgkJaW5wdXRMZW5ndGggPSBpbnB1dC5sZW5ndGgsCgkJa2V5LAoJCXZhbHVlOwoJZm9yICggOyBpbnB1dEluZGV4IDwgaW5wdXRMZW5ndGg7IGlucHV0SW5kZXgrKyApIHsKCQlmb3IgKCBrZXkgaW4gaW5wdXRbIGlucHV0SW5kZXggXSApIHsKCQkJdmFsdWUgPSBpbnB1dFsgaW5wdXRJbmRleCBdWyBrZXkgXTsKCQkJaWYgKCBpbnB1dFsgaW5wdXRJbmRleCBdLmhhc093blByb3BlcnR5KCBrZXkgKSAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJLy8gQ2xvbmUgb2JqZWN0cwoJCQkJaWYgKCAkLmlzUGxhaW5PYmplY3QoIHZhbHVlICkgKSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9ICQuaXNQbGFpbk9iamVjdCggdGFyZ2V0WyBrZXkgXSApID8KCQkJCQkJJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGFyZ2V0WyBrZXkgXSwgdmFsdWUgKSA6CgkJCQkJCS8vIERvbid0IGV4dGVuZCBzdHJpbmdzLCBhcnJheXMsIGV0Yy4gd2l0aCBvYmplY3RzCgkJCQkJCSQud2lkZ2V0LmV4dGVuZCgge30sIHZhbHVlICk7CgkJCQkvLyBDb3B5IGV2ZXJ5dGhpbmcgZWxzZSBieSByZWZlcmVuY2UKCQkJCX0gZWxzZSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoJfQoJcmV0dXJuIHRhcmdldDsKfTsKCiQud2lkZ2V0LmJyaWRnZSA9IGZ1bmN0aW9uKCBuYW1lLCBvYmplY3QgKSB7Cgl2YXIgZnVsbE5hbWUgPSBvYmplY3QucHJvdG90eXBlLndpZGdldEZ1bGxOYW1lIHx8IG5hbWU7CgkkLmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNNZXRob2RDYWxsID0gdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciLAoJCQlhcmdzID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJCXJldHVyblZhbHVlID0gdGhpczsKCgkJLy8gYWxsb3cgbXVsdGlwbGUgaGFzaGVzIHRvIGJlIHBhc3NlZCBvbiBpbml0CgkJb3B0aW9ucyA9ICFpc01ldGhvZENhbGwgJiYgYXJncy5sZW5ndGggPwoJCQkkLndpZGdldC5leHRlbmQuYXBwbHkoIG51bGwsIFsgb3B0aW9ucyBdLmNvbmNhdChhcmdzKSApIDoKCQkJb3B0aW9uczsKCgkJaWYgKCBpc01ldGhvZENhbGwgKSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBtZXRob2RWYWx1ZSwKCQkJCQlpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggb3B0aW9ucyA9PT0gImluc3RhbmNlIiApIHsKCQkJCQlyZXR1cm5WYWx1ZSA9IGluc3RhbmNlOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJCWlmICggIWluc3RhbmNlICkgewoJCQkJCXJldHVybiAkLmVycm9yKCAiY2Fubm90IGNhbGwgbWV0aG9kcyBvbiAiICsgbmFtZSArICIgcHJpb3IgdG8gaW5pdGlhbGl6YXRpb247ICIgKwoJCQkJCQkiYXR0ZW1wdGVkIHRvIGNhbGwgbWV0aG9kICciICsgb3B0aW9ucyArICInIiApOwoJCQkJfQoJCQkJaWYgKCAhJC5pc0Z1bmN0aW9uKCBpbnN0YW5jZVtvcHRpb25zXSApIHx8IG9wdGlvbnMuY2hhckF0KCAwICkgPT09ICJfIiApIHsKCQkJCQlyZXR1cm4gJC5lcnJvciggIm5vIHN1Y2ggbWV0aG9kICciICsgb3B0aW9ucyArICInIGZvciAiICsgbmFtZSArICIgd2lkZ2V0IGluc3RhbmNlIiApOwoJCQkJfQoJCQkJbWV0aG9kVmFsdWUgPSBpbnN0YW5jZVsgb3B0aW9ucyBdLmFwcGx5KCBpbnN0YW5jZSwgYXJncyApOwoJCQkJaWYgKCBtZXRob2RWYWx1ZSAhPT0gaW5zdGFuY2UgJiYgbWV0aG9kVmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm5WYWx1ZSA9IG1ldGhvZFZhbHVlICYmIG1ldGhvZFZhbHVlLmpxdWVyeSA/CgkJCQkJCXJldHVyblZhbHVlLnB1c2hTdGFjayggbWV0aG9kVmFsdWUuZ2V0KCkgKSA6CgkJCQkJCW1ldGhvZFZhbHVlOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSApOwoJCQkJaWYgKCBpbnN0YW5jZSApIHsKCQkJCQlpbnN0YW5jZS5vcHRpb24oIG9wdGlvbnMgfHwge30gKS5faW5pdCgpOwoJCQkJfSBlbHNlIHsKCQkJCQkkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lLCBuZXcgb2JqZWN0KCBvcHRpb25zLCB0aGlzICkgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9Owp9OwoKJC5XaWRnZXQgPSBmdW5jdGlvbiggLyogb3B0aW9ucywgZWxlbWVudCAqLyApIHt9OwokLldpZGdldC5fY2hpbGRDb25zdHJ1Y3RvcnMgPSBbXTsKCiQuV2lkZ2V0LnByb3RvdHlwZSA9IHsKCXdpZGdldE5hbWU6ICJ3aWRnZXQiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICIiLAoJZGVmYXVsdEVsZW1lbnQ6ICI8ZGl2PiIsCglvcHRpb25zOiB7CgkJZGlzYWJsZWQ6IGZhbHNlLAoKCQkvLyBjYWxsYmFja3MKCQljcmVhdGU6IG51bGwKCX0sCglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQllbGVtZW50ID0gJCggZWxlbWVudCB8fCB0aGlzLmRlZmF1bHRFbGVtZW50IHx8IHRoaXMgKVsgMCBdOwoJCXRoaXMuZWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQl0aGlzLnV1aWQgPSB1dWlkKys7CgkJdGhpcy5ldmVudE5hbWVzcGFjZSA9ICIuIiArIHRoaXMud2lkZ2V0TmFtZSArIHRoaXMudXVpZDsKCQl0aGlzLm9wdGlvbnMgPSAkLndpZGdldC5leHRlbmQoIHt9LAoJCQl0aGlzLm9wdGlvbnMsCgkJCXRoaXMuX2dldENyZWF0ZU9wdGlvbnMoKSwKCQkJb3B0aW9ucyApOwoKCQl0aGlzLmJpbmRpbmdzID0gJCgpOwoJCXRoaXMuaG92ZXJhYmxlID0gJCgpOwoJCXRoaXMuZm9jdXNhYmxlID0gJCgpOwoKCQlpZiAoIGVsZW1lbnQgIT09IHRoaXMgKSB7CgkJCSQuZGF0YSggZWxlbWVudCwgdGhpcy53aWRnZXRGdWxsTmFtZSwgdGhpcyApOwoJCQl0aGlzLl9vbiggdHJ1ZSwgdGhpcy5lbGVtZW50LCB7CgkJCQlyZW1vdmU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpZiAoIGV2ZW50LnRhcmdldCA9PT0gZWxlbWVudCApIHsKCQkJCQkJdGhpcy5kZXN0cm95KCk7CgkJCQkJfQoJCQkJfQoJCQl9KTsKCQkJdGhpcy5kb2N1bWVudCA9ICQoIGVsZW1lbnQuc3R5bGUgPwoJCQkJLy8gZWxlbWVudCB3aXRoaW4gdGhlIGRvY3VtZW50CgkJCQllbGVtZW50Lm93bmVyRG9jdW1lbnQgOgoJCQkJLy8gZWxlbWVudCBpcyB3aW5kb3cgb3IgZG9jdW1lbnQKCQkJCWVsZW1lbnQuZG9jdW1lbnQgfHwgZWxlbWVudCApOwoJCQl0aGlzLndpbmRvdyA9ICQoIHRoaXMuZG9jdW1lbnRbMF0uZGVmYXVsdFZpZXcgfHwgdGhpcy5kb2N1bWVudFswXS5wYXJlbnRXaW5kb3cgKTsKCQl9CgoJCXRoaXMuX2NyZWF0ZSgpOwoJCXRoaXMuX3RyaWdnZXIoICJjcmVhdGUiLCBudWxsLCB0aGlzLl9nZXRDcmVhdGVFdmVudERhdGEoKSApOwoJCXRoaXMuX2luaXQoKTsKCX0sCglfZ2V0Q3JlYXRlT3B0aW9uczogJC5ub29wLAoJX2dldENyZWF0ZUV2ZW50RGF0YTogJC5ub29wLAoJX2NyZWF0ZTogJC5ub29wLAoJX2luaXQ6ICQubm9vcCwKCglkZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9kZXN0cm95KCk7CgkJLy8gd2UgY2FuIHByb2JhYmx5IHJlbW92ZSB0aGUgdW5iaW5kIGNhbGxzIGluIDIuMAoJCS8vIGFsbCBldmVudCBiaW5kaW5ncyBzaG91bGQgZ28gdGhyb3VnaCB0aGlzLl9vbigpCgkJdGhpcy5lbGVtZW50CgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkucmVtb3ZlRGF0YSggdGhpcy53aWRnZXRGdWxsTmFtZSApCgkJCS8vIHN1cHBvcnQ6IGpxdWVyeSA8MS42LjMKCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvOTQxMwoJCQkucmVtb3ZlRGF0YSggJC5jYW1lbENhc2UoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKSApOwoJCXRoaXMud2lkZ2V0KCkKCQkJLnVuYmluZCggdGhpcy5ldmVudE5hbWVzcGFjZSApCgkJCS5yZW1vdmVBdHRyKCAiYXJpYS1kaXNhYmxlZCIgKQoJCQkucmVtb3ZlQ2xhc3MoCgkJCQl0aGlzLndpZGdldEZ1bGxOYW1lICsgIi1kaXNhYmxlZCAiICsKCQkJCSJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCgkJLy8gY2xlYW4gdXAgZXZlbnRzIGFuZCBzdGF0ZXMKCQl0aGlzLmJpbmRpbmdzLnVuYmluZCggdGhpcy5ldmVudE5hbWVzcGFjZSApOwoJCXRoaXMuaG92ZXJhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJdGhpcy5mb2N1c2FibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCX0sCglfZGVzdHJveTogJC5ub29wLAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCX0sCgoJb3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgb3B0aW9ucyA9IGtleSwKCQkJcGFydHMsCgkJCWN1ck9wdGlvbiwKCQkJaTsKCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAwICkgewoJCQkvLyBkb24ndCByZXR1cm4gYSByZWZlcmVuY2UgdG8gdGhlIGludGVybmFsIGhhc2gKCQkJcmV0dXJuICQud2lkZ2V0LmV4dGVuZCgge30sIHRoaXMub3B0aW9ucyApOwoJCX0KCgkJaWYgKCB0eXBlb2Yga2V5ID09PSAic3RyaW5nIiApIHsKCQkJLy8gaGFuZGxlIG5lc3RlZCBrZXlzLCBlLmcuLCAiZm9vLmJhciIgPT4geyBmb286IHsgYmFyOiBfX18gfSB9CgkJCW9wdGlvbnMgPSB7fTsKCQkJcGFydHMgPSBrZXkuc3BsaXQoICIuIiApOwoJCQlrZXkgPSBwYXJ0cy5zaGlmdCgpOwoJCQlpZiAoIHBhcnRzLmxlbmd0aCApIHsKCQkJCWN1ck9wdGlvbiA9IG9wdGlvbnNbIGtleSBdID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zWyBrZXkgXSApOwoJCQkJZm9yICggaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGggLSAxOyBpKysgKSB7CgkJCQkJY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF0gPSBjdXJPcHRpb25bIHBhcnRzWyBpIF0gXSB8fCB7fTsKCQkJCQljdXJPcHRpb24gPSBjdXJPcHRpb25bIHBhcnRzWyBpIF0gXTsKCQkJCX0KCQkJCWtleSA9IHBhcnRzLnBvcCgpOwoJCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVybiBjdXJPcHRpb25bIGtleSBdID09PSB1bmRlZmluZWQgPyBudWxsIDogY3VyT3B0aW9uWyBrZXkgXTsKCQkJCX0KCQkJCWN1ck9wdGlvblsga2V5IF0gPSB2YWx1ZTsKCQkJfSBlbHNlIHsKCQkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gdGhpcy5vcHRpb25zWyBrZXkgXSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IHRoaXMub3B0aW9uc1sga2V5IF07CgkJCQl9CgkJCQlvcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoJCQl9CgkJfQoKCQl0aGlzLl9zZXRPcHRpb25zKCBvcHRpb25zICk7CgoJCXJldHVybiB0aGlzOwoJfSwKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIga2V5OwoKCQlmb3IgKCBrZXkgaW4gb3B0aW9ucyApIHsKCQkJdGhpcy5fc2V0T3B0aW9uKCBrZXksIG9wdGlvbnNbIGtleSBdICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl0aGlzLm9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgoJCWlmICgga2V5ID09PSAiZGlzYWJsZWQiICkgewoJCQl0aGlzLndpZGdldCgpCgkJCQkudG9nZ2xlQ2xhc3MoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKyAiLWRpc2FibGVkIiwgISF2YWx1ZSApOwoJCQl0aGlzLmhvdmVyYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl0aGlzLmZvY3VzYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbnMoeyBkaXNhYmxlZDogZmFsc2UgfSk7Cgl9LAoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbnMoeyBkaXNhYmxlZDogdHJ1ZSB9KTsKCX0sCgoJX29uOiBmdW5jdGlvbiggc3VwcHJlc3NEaXNhYmxlZENoZWNrLCBlbGVtZW50LCBoYW5kbGVycyApIHsKCQl2YXIgZGVsZWdhdGVFbGVtZW50LAoJCQlpbnN0YW5jZSA9IHRoaXM7CgoJCS8vIG5vIHN1cHByZXNzRGlzYWJsZWRDaGVjayBmbGFnLCBzaHVmZmxlIGFyZ3VtZW50cwoJCWlmICggdHlwZW9mIHN1cHByZXNzRGlzYWJsZWRDaGVjayAhPT0gImJvb2xlYW4iICkgewoJCQloYW5kbGVycyA9IGVsZW1lbnQ7CgkJCWVsZW1lbnQgPSBzdXBwcmVzc0Rpc2FibGVkQ2hlY2s7CgkJCXN1cHByZXNzRGlzYWJsZWRDaGVjayA9IGZhbHNlOwoJCX0KCgkJLy8gbm8gZWxlbWVudCBhcmd1bWVudCwgc2h1ZmZsZSBhbmQgdXNlIHRoaXMuZWxlbWVudAoJCWlmICggIWhhbmRsZXJzICkgewoJCQloYW5kbGVycyA9IGVsZW1lbnQ7CgkJCWVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CgkJCWRlbGVnYXRlRWxlbWVudCA9IHRoaXMud2lkZ2V0KCk7CgkJfSBlbHNlIHsKCQkJLy8gYWNjZXB0IHNlbGVjdG9ycywgRE9NIGVsZW1lbnRzCgkJCWVsZW1lbnQgPSBkZWxlZ2F0ZUVsZW1lbnQgPSAkKCBlbGVtZW50ICk7CgkJCXRoaXMuYmluZGluZ3MgPSB0aGlzLmJpbmRpbmdzLmFkZCggZWxlbWVudCApOwoJCX0KCgkJJC5lYWNoKCBoYW5kbGVycywgZnVuY3Rpb24oIGV2ZW50LCBoYW5kbGVyICkgewoJCQlmdW5jdGlvbiBoYW5kbGVyUHJveHkoKSB7CgkJCQkvLyBhbGxvdyB3aWRnZXRzIHRvIGN1c3RvbWl6ZSB0aGUgZGlzYWJsZWQgaGFuZGxpbmcKCQkJCS8vIC0gZGlzYWJsZWQgYXMgYW4gYXJyYXkgaW5zdGVhZCBvZiBib29sZWFuCgkJCQkvLyAtIGRpc2FibGVkIGNsYXNzIGFzIG1ldGhvZCBmb3IgZGlzYWJsaW5nIGluZGl2aWR1YWwgcGFydHMKCQkJCWlmICggIXN1cHByZXNzRGlzYWJsZWRDaGVjayAmJgoJCQkJCQkoIGluc3RhbmNlLm9wdGlvbnMuZGlzYWJsZWQgPT09IHRydWUgfHwKCQkJCQkJCSQoIHRoaXMgKS5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJcmV0dXJuICggdHlwZW9mIGhhbmRsZXIgPT09ICJzdHJpbmciID8gaW5zdGFuY2VbIGhhbmRsZXIgXSA6IGhhbmRsZXIgKQoJCQkJCS5hcHBseSggaW5zdGFuY2UsIGFyZ3VtZW50cyApOwoJCQl9CgoJCQkvLyBjb3B5IHRoZSBndWlkIHNvIGRpcmVjdCB1bmJpbmRpbmcgd29ya3MKCQkJaWYgKCB0eXBlb2YgaGFuZGxlciAhPT0gInN0cmluZyIgKSB7CgkJCQloYW5kbGVyUHJveHkuZ3VpZCA9IGhhbmRsZXIuZ3VpZCA9CgkJCQkJaGFuZGxlci5ndWlkIHx8IGhhbmRsZXJQcm94eS5ndWlkIHx8ICQuZ3VpZCsrOwoJCQl9CgoJCQl2YXIgbWF0Y2ggPSBldmVudC5tYXRjaCggL14oXHcrKVxzKiguKikkLyApLAoJCQkJZXZlbnROYW1lID0gbWF0Y2hbMV0gKyBpbnN0YW5jZS5ldmVudE5hbWVzcGFjZSwKCQkJCXNlbGVjdG9yID0gbWF0Y2hbMl07CgkJCWlmICggc2VsZWN0b3IgKSB7CgkJCQlkZWxlZ2F0ZUVsZW1lbnQuZGVsZWdhdGUoIHNlbGVjdG9yLCBldmVudE5hbWUsIGhhbmRsZXJQcm94eSApOwoJCQl9IGVsc2UgewoJCQkJZWxlbWVudC5iaW5kKCBldmVudE5hbWUsIGhhbmRsZXJQcm94eSApOwoJCQl9CgkJfSk7Cgl9LAoKCV9vZmY6IGZ1bmN0aW9uKCBlbGVtZW50LCBldmVudE5hbWUgKSB7CgkJZXZlbnROYW1lID0gKGV2ZW50TmFtZSB8fCAiIikuc3BsaXQoICIgIiApLmpvaW4oIHRoaXMuZXZlbnROYW1lc3BhY2UgKyAiICIgKSArIHRoaXMuZXZlbnROYW1lc3BhY2U7CgkJZWxlbWVudC51bmJpbmQoIGV2ZW50TmFtZSApLnVuZGVsZWdhdGUoIGV2ZW50TmFtZSApOwoJfSwKCglfZGVsYXk6IGZ1bmN0aW9uKCBoYW5kbGVyLCBkZWxheSApIHsKCQlmdW5jdGlvbiBoYW5kbGVyUHJveHkoKSB7CgkJCXJldHVybiAoIHR5cGVvZiBoYW5kbGVyID09PSAic3RyaW5nIiA/IGluc3RhbmNlWyBoYW5kbGVyIF0gOiBoYW5kbGVyICkKCQkJCS5hcHBseSggaW5zdGFuY2UsIGFyZ3VtZW50cyApOwoJCX0KCQl2YXIgaW5zdGFuY2UgPSB0aGlzOwoJCXJldHVybiBzZXRUaW1lb3V0KCBoYW5kbGVyUHJveHksIGRlbGF5IHx8IDAgKTsKCX0sCgoJX2hvdmVyYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdGhpcy5ob3ZlcmFibGUgPSB0aGlzLmhvdmVyYWJsZS5hZGQoIGVsZW1lbnQgKTsKCQl0aGlzLl9vbiggZWxlbWVudCwgewoJCQltb3VzZWVudGVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJfSwKCQkJbW91c2VsZWF2ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJCX0KCQl9KTsKCX0sCgoJX2ZvY3VzYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdGhpcy5mb2N1c2FibGUgPSB0aGlzLmZvY3VzYWJsZS5hZGQoIGVsZW1lbnQgKTsKCQl0aGlzLl9vbiggZWxlbWVudCwgewoJCQlmb2N1c2luOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQkJfSwKCQkJZm9jdXNvdXQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCQl9CgkJfSk7Cgl9LAoKCV90cmlnZ2VyOiBmdW5jdGlvbiggdHlwZSwgZXZlbnQsIGRhdGEgKSB7CgkJdmFyIHByb3AsIG9yaWcsCgkJCWNhbGxiYWNrID0gdGhpcy5vcHRpb25zWyB0eXBlIF07CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoJCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCQlldmVudC50eXBlID0gKCB0eXBlID09PSB0aGlzLndpZGdldEV2ZW50UHJlZml4ID8KCQkJdHlwZSA6CgkJCXRoaXMud2lkZ2V0RXZlbnRQcmVmaXggKyB0eXBlICkudG9Mb3dlckNhc2UoKTsKCQkvLyB0aGUgb3JpZ2luYWwgZXZlbnQgbWF5IGNvbWUgZnJvbSBhbnkgZWxlbWVudAoJCS8vIHNvIHdlIG5lZWQgdG8gcmVzZXQgdGhlIHRhcmdldCBvbiB0aGUgbmV3IGV2ZW50CgkJZXZlbnQudGFyZ2V0ID0gdGhpcy5lbGVtZW50WyAwIF07CgoJCS8vIGNvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCQlvcmlnID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCQlpZiAoIG9yaWcgKSB7CgkJCWZvciAoIHByb3AgaW4gb3JpZyApIHsKCQkJCWlmICggISggcHJvcCBpbiBldmVudCApICkgewoJCQkJCWV2ZW50WyBwcm9wIF0gPSBvcmlnWyBwcm9wIF07CgkJCQl9CgkJCX0KCQl9CgoJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBldmVudCwgZGF0YSApOwoJCXJldHVybiAhKCAkLmlzRnVuY3Rpb24oIGNhbGxiYWNrICkgJiYKCQkJY2FsbGJhY2suYXBwbHkoIHRoaXMuZWxlbWVudFswXSwgWyBldmVudCBdLmNvbmNhdCggZGF0YSApICkgPT09IGZhbHNlIHx8CgkJCWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICk7Cgl9Cn07CgokLmVhY2goIHsgc2hvdzogImZhZGVJbiIsIGhpZGU6ICJmYWRlT3V0IiB9LCBmdW5jdGlvbiggbWV0aG9kLCBkZWZhdWx0RWZmZWN0ICkgewoJJC5XaWRnZXQucHJvdG90eXBlWyAiXyIgKyBtZXRob2QgXSA9IGZ1bmN0aW9uKCBlbGVtZW50LCBvcHRpb25zLCBjYWxsYmFjayApIHsKCQlpZiAoIHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiApIHsKCQkJb3B0aW9ucyA9IHsgZWZmZWN0OiBvcHRpb25zIH07CgkJfQoJCXZhciBoYXNPcHRpb25zLAoJCQllZmZlY3ROYW1lID0gIW9wdGlvbnMgPwoJCQkJbWV0aG9kIDoKCQkJCW9wdGlvbnMgPT09IHRydWUgfHwgdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiID8KCQkJCQlkZWZhdWx0RWZmZWN0IDoKCQkJCQlvcHRpb25zLmVmZmVjdCB8fCBkZWZhdWx0RWZmZWN0OwoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiICkgewoJCQlvcHRpb25zID0geyBkdXJhdGlvbjogb3B0aW9ucyB9OwoJCX0KCQloYXNPcHRpb25zID0gISQuaXNFbXB0eU9iamVjdCggb3B0aW9ucyApOwoJCW9wdGlvbnMuY29tcGxldGUgPSBjYWxsYmFjazsKCQlpZiAoIG9wdGlvbnMuZGVsYXkgKSB7CgkJCWVsZW1lbnQuZGVsYXkoIG9wdGlvbnMuZGVsYXkgKTsKCQl9CgkJaWYgKCBoYXNPcHRpb25zICYmICQuZWZmZWN0cyAmJiAkLmVmZmVjdHMuZWZmZWN0WyBlZmZlY3ROYW1lIF0gKSB7CgkJCWVsZW1lbnRbIG1ldGhvZCBdKCBvcHRpb25zICk7CgkJfSBlbHNlIGlmICggZWZmZWN0TmFtZSAhPT0gbWV0aG9kICYmIGVsZW1lbnRbIGVmZmVjdE5hbWUgXSApIHsKCQkJZWxlbWVudFsgZWZmZWN0TmFtZSBdKCBvcHRpb25zLmR1cmF0aW9uLCBvcHRpb25zLmVhc2luZywgY2FsbGJhY2sgKTsKCQl9IGVsc2UgewoJCQllbGVtZW50LnF1ZXVlKGZ1bmN0aW9uKCBuZXh0ICkgewoJCQkJJCggdGhpcyApWyBtZXRob2QgXSgpOwoJCQkJaWYgKCBjYWxsYmFjayApIHsKCQkJCQljYWxsYmFjay5jYWxsKCBlbGVtZW50WyAwIF0gKTsKCQkJCX0KCQkJCW5leHQoKTsKCQkJfSk7CgkJfQoJfTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciByY2FwaXRhbHMgPSAvW0EtWl0vZywKCXJlcGxhY2VGdW5jdGlvbiA9IGZ1bmN0aW9uKCBjICkgewoJCXJldHVybiAiLSIgKyBjLnRvTG93ZXJDYXNlKCk7Cgl9OwoKJC5leHRlbmQoICQuV2lkZ2V0LnByb3RvdHlwZSwgewoJX2dldENyZWF0ZU9wdGlvbnM6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb24sIHZhbHVlLAoJCQllbGVtID0gdGhpcy5lbGVtZW50WyAwIF0sCgkJCW9wdGlvbnMgPSB7fTsKCgkJLy8KCQlpZiAoICEkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIGVsZW0sICJkZWZhdWx0cyIgKSApIHsKCQkJZm9yICggb3B0aW9uIGluIHRoaXMub3B0aW9ucyApIHsKCQkJCXZhbHVlID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCBlbGVtLCBvcHRpb24ucmVwbGFjZSggcmNhcGl0YWxzLCByZXBsYWNlRnVuY3Rpb24gKSApOwoKCQkJCWlmICggdmFsdWUgIT0gbnVsbCApIHsKCQkJCQlvcHRpb25zWyBvcHRpb24gXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gb3B0aW9uczsKCX0KfSk7CgovL1RPRE86IFJlbW92ZSBpbiAxLjUgZm9yIGJhY2tjb21wYXQgb25seQokLm1vYmlsZS53aWRnZXQgPSAkLldpZGdldDsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQgKSB7CgkvLyBUT0RPIG1vdmUgbG9hZGVyIGNsYXNzIGRvd24gaW50byB0aGUgd2lkZ2V0IHNldHRpbmdzCgl2YXIgbG9hZGVyQ2xhc3MgPSAidWktbG9hZGVyIiwgJGh0bWwgPSAkKCAiaHRtbCIgKTsKCgkkLndpZGdldCggIm1vYmlsZS5sb2FkZXIiLCB7CgkJLy8gTk9URSBpZiB0aGUgZ2xvYmFsIGNvbmZpZyBzZXR0aW5ncyBhcmUgZGVmaW5lZCB0aGV5IHdpbGwgb3ZlcnJpZGUgdGhlc2UKCQkvLyAgICAgIG9wdGlvbnMKCQlvcHRpb25zOiB7CgkJCS8vIHRoZSB0aGVtZSBmb3IgdGhlIGxvYWRpbmcgbWVzc2FnZQoJCQl0aGVtZTogImEiLAoKCQkJLy8gd2hldGhlciB0aGUgdGV4dCBpbiB0aGUgbG9hZGluZyBtZXNzYWdlIGlzIHNob3duCgkJCXRleHRWaXNpYmxlOiBmYWxzZSwKCgkJCS8vIGN1c3RvbSBodG1sIGZvciB0aGUgaW5uZXIgY29udGVudCBvZiB0aGUgbG9hZGluZyBtZXNzYWdlCgkJCWh0bWw6ICIiLAoKCQkJLy8gdGhlIHRleHQgdG8gYmUgZGlzcGxheWVkIHdoZW4gdGhlIHBvcHVwIGlzIHNob3duCgkJCXRleHQ6ICJsb2FkaW5nIgoJCX0sCgoJCWRlZmF1bHRIdG1sOiAiPGRpdiBjbGFzcz0nIiArIGxvYWRlckNsYXNzICsgIic+IiArCgkJCSI8c3BhbiBjbGFzcz0ndWktaWNvbi1sb2FkaW5nJz48L3NwYW4+IiArCgkJCSI8aDE+PC9oMT4iICsKCQkJIjwvZGl2PiIsCgoJCS8vIEZvciBub24tZml4ZWQgc3VwcG9ydGluIGJyb3dzZXJzLiBQb3NpdGlvbiBhdCB5IGNlbnRlciAoaWYgc2Nyb2xsVG9wIHN1cHBvcnRlZCksIGFib3ZlIHRoZSBhY3RpdmVCdG4gKGlmIGRlZmluZWQpLCBvciBqdXN0IDEwMHB4IGZyb20gdG9wCgkJZmFrZUZpeExvYWRlcjogZnVuY3Rpb24oKSB7CgkJCXZhciBhY3RpdmVCdG4gPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApLmZpcnN0KCk7CgoJCQl0aGlzLmVsZW1lbnQKCQkJCS5jc3MoewoJCQkJCXRvcDogJC5zdXBwb3J0LnNjcm9sbFRvcCAmJiB0aGlzLndpbmRvdy5zY3JvbGxUb3AoKSArIHRoaXMud2luZG93LmhlaWdodCgpIC8gMiB8fAoJCQkJCQlhY3RpdmVCdG4ubGVuZ3RoICYmIGFjdGl2ZUJ0bi5vZmZzZXQoKS50b3AgfHwgMTAwCgkJCQl9KTsKCQl9LAoKCQkvLyBjaGVjayBwb3NpdGlvbiBvZiBsb2FkZXIgdG8gc2VlIGlmIGl0IGFwcGVhcnMgdG8gYmUgImZpeGVkIiB0byBjZW50ZXIKCQkvLyBpZiBub3QsIHVzZSBhYnMgcG9zaXRpb25pbmcKCQljaGVja0xvYWRlclBvc2l0aW9uOiBmdW5jdGlvbigpIHsKCQkJdmFyIG9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKSwKCQkJCXNjcm9sbFRvcCA9IHRoaXMud2luZG93LnNjcm9sbFRvcCgpLAoJCQkJc2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCQlpZiAoIG9mZnNldC50b3AgPCBzY3JvbGxUb3AgfHwgKCBvZmZzZXQudG9wIC0gc2Nyb2xsVG9wICkgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1sb2FkZXItZmFrZWZpeCIgKTsKCQkJCXRoaXMuZmFrZUZpeExvYWRlcigpOwoJCQkJdGhpcy53aW5kb3cKCQkJCQkudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uICkKCQkJCQkuYmluZCggInNjcm9sbCIsICQucHJveHkoIHRoaXMuZmFrZUZpeExvYWRlciwgdGhpcyApICk7CgkJCX0KCQl9LAoKCQlyZXNldEh0bWw6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuaHRtbCggJCggdGhpcy5kZWZhdWx0SHRtbCApLmh0bWwoKSApOwoJCX0sCgoJCS8vIFR1cm4gb24vb2ZmIHBhZ2UgbG9hZGluZyBtZXNzYWdlLiBUaGVtZSBkb3VibGVzIGFzIGFuIG9iamVjdCBhcmd1bWVudAoJCS8vIHdpdGggdGhlIGZvbGxvd2luZyBzaGFwZTogeyB0aGVtZTogJycsIHRleHQ6ICcnLCBodG1sOiAnJywgdGV4dFZpc2libGU6ICcnIH0KCQkvLyBOT1RFIHRoYXQgdGhlICQubW9iaWxlLmxvYWRpbmcqIHNldHRpbmdzIGFuZCBwYXJhbXMgcGFzdCB0aGUgZmlyc3QgYXJlIGRlcHJlY2F0ZWQKCQkvLyBUT0RPIHN3ZWV0IGplc3VzIHdlIG5lZWQgdG8gYnJlYWsgc29tZSBvZiB0aGlzIG91dAoJCXNob3c6IGZ1bmN0aW9uKCB0aGVtZSwgbXNnVGV4dCwgdGV4dG9ubHkgKSB7CgkJCXZhciB0ZXh0VmlzaWJsZSwgbWVzc2FnZSwgbG9hZFNldHRpbmdzOwoKCQkJdGhpcy5yZXNldEh0bWwoKTsKCgkJCS8vIHVzZSB0aGUgcHJvdG90eXBlIG9wdGlvbnMgc28gdGhhdCBwZW9wbGUgY2FuIHNldCB0aGVtIGdsb2JhbGx5IGF0CgkJCS8vIG1vYmlsZSBpbml0LiBDb25zaXN0ZW5jeSwgaXQncyB3aGF0J3MgZm9yIGRpbm5lcgoJCQlpZiAoICQudHlwZSggdGhlbWUgKSA9PT0gIm9iamVjdCIgKSB7CgkJCQlsb2FkU2V0dGluZ3MgPSAkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucywgdGhlbWUgKTsKCgkJCQl0aGVtZSA9IGxvYWRTZXR0aW5ncy50aGVtZTsKCQkJfSBlbHNlIHsKCQkJCWxvYWRTZXR0aW5ncyA9IHRoaXMub3B0aW9uczsKCgkJCQkvLyBoZXJlIHdlIHByZWZlciB0aGUgdGhlbWUgdmFsdWUgcGFzc2VkIGFzIGEgc3RyaW5nIGFyZ3VtZW50LCB0aGVuCgkJCQkvLyB3ZSBwcmVmZXIgdGhlIGdsb2JhbCBvcHRpb24gYmVjYXVzZSB3ZSBjYW4ndCB1c2UgdW5kZWZpbmVkIGRlZmF1bHQKCQkJCS8vIHByb3RvdHlwZSBvcHRpb25zLCB0aGVuIHRoZSBwcm90b3R5cGUgb3B0aW9uCgkJCQl0aGVtZSA9IHRoZW1lIHx8IGxvYWRTZXR0aW5ncy50aGVtZTsKCQkJfQoKCQkJLy8gc2V0IHRoZSBtZXNzYWdlIHRleHQsIHByZWZlciB0aGUgcGFyYW0sIHRoZW4gdGhlIHNldHRpbmdzIG9iamVjdAoJCQkvLyB0aGVuIGxvYWRpbmcgbWVzc2FnZQoJCQltZXNzYWdlID0gbXNnVGV4dCB8fCAoIGxvYWRTZXR0aW5ncy50ZXh0ID09PSBmYWxzZSA/ICIiIDogbG9hZFNldHRpbmdzLnRleHQgKTsKCgkJCS8vIHByZXBhcmUgdGhlIGRvbQoJCQkkaHRtbC5hZGRDbGFzcyggInVpLWxvYWRpbmciICk7CgoJCQl0ZXh0VmlzaWJsZSA9IGxvYWRTZXR0aW5ncy50ZXh0VmlzaWJsZTsKCgkJCS8vIGFkZCB0aGUgcHJvcGVyIGNzcyBnaXZlbiB0aGUgb3B0aW9ucyAodGhlbWUsIHRleHQsIGV0YykKCQkJLy8gRm9yY2UgdGV4dCB2aXNpYmlsaXR5IGlmIHRoZSBzZWNvbmQgYXJndW1lbnQgd2FzIHN1cHBsaWVkLCBvcgoJCQkvLyBpZiB0aGUgdGV4dCB3YXMgZXhwbGljaXRseSBzZXQgaW4gdGhlIG9iamVjdCBhcmdzCgkJCXRoaXMuZWxlbWVudC5hdHRyKCJjbGFzcyIsIGxvYWRlckNsYXNzICsKCQkJCSIgdWktY29ybmVyLWFsbCB1aS1ib2R5LSIgKyB0aGVtZSArCgkJCQkiIHVpLWxvYWRlci0iICsgKCB0ZXh0VmlzaWJsZSB8fCBtc2dUZXh0IHx8IHRoZW1lLnRleHQgPyAidmVyYm9zZSIgOiAiZGVmYXVsdCIgKSArCgkJCQkoIGxvYWRTZXR0aW5ncy50ZXh0b25seSB8fCB0ZXh0b25seSA/ICIgdWktbG9hZGVyLXRleHRvbmx5IiA6ICIiICkgKTsKCgkJCS8vIFRPRE8gdmVyaWZ5IHRoYXQganF1ZXJ5LmZuLmh0bWwgaXMgb2sgdG8gdXNlIGluIGJvdGggY2FzZXMgaGVyZQoJCQkvLyAgICAgIHRoaXMgbWlnaHQgYmUgb3Zlcmx5IGRlZmVuc2l2ZSBpbiBwcmV2ZW50aW5nIHVua25vd2luZyB4c3MKCQkJLy8gaWYgdGhlIGh0bWwgYXR0cmlidXRlIGlzIGRlZmluZWQgb24gdGhlIGxvYWRpbmcgc2V0dGluZ3MsIHVzZSB0aGF0CgkJCS8vIG90aGVyd2lzZSB1c2UgdGhlIGZhbGxiYWNrcyBmcm9tIGFib3ZlCgkJCWlmICggbG9hZFNldHRpbmdzLmh0bWwgKSB7CgkJCQl0aGlzLmVsZW1lbnQuaHRtbCggbG9hZFNldHRpbmdzLmh0bWwgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiaDEiICkudGV4dCggbWVzc2FnZSApOwoJCQl9CgoJCQkvLyBhdHRhY2ggdGhlIGxvYWRlciB0byB0aGUgRE9NCgkJCXRoaXMuZWxlbWVudC5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJLy8gY2hlY2sgdGhhdCB0aGUgbG9hZGVyIGlzIHZpc2libGUKCQkJdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uKCk7CgoJCQkvLyBvbiBzY3JvbGwgY2hlY2sgdGhlIGxvYWRlciBwb3NpdGlvbgoJCQl0aGlzLndpbmRvdy5iaW5kKCAic2Nyb2xsIiwgJC5wcm94eSggdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uLCB0aGlzICkgKTsKCQl9LAoKCQloaWRlOiBmdW5jdGlvbigpIHsKCQkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoKCQkJaWYgKCB0aGlzLm9wdGlvbnMudGV4dCApIHsKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWxvYWRlci1mYWtlZml4IiApOwoJCQl9CgoJCQkkLm1vYmlsZS53aW5kb3cudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5mYWtlRml4TG9hZGVyICk7CgkJCSQubW9iaWxlLndpbmRvdy51bmJpbmQoICJzY3JvbGwiLCB0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24gKTsKCQl9Cgl9KTsKCn0pKGpRdWVyeSwgdGhpcyk7CgoKLy8gU2NyaXB0OiBqUXVlcnkgaGFzaGNoYW5nZSBldmVudAovLyAKLy8gKlZlcnNpb246IDEuMywgTGFzdCB1cGRhdGVkOiA3LzIxLzIwMTAqCi8vIAovLyBQcm9qZWN0IEhvbWUgLSBodHRwOi8vYmVuYWxtYW4uY29tL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlLXBsdWdpbi8KLy8gR2l0SHViICAgICAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlLwovLyBTb3VyY2UgICAgICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5qcwovLyAoTWluaWZpZWQpICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5taW4uanMgKDAuOGtiIGd6aXBwZWQpCi8vIAovLyBBYm91dDogTGljZW5zZQovLyAKLy8gQ29weXJpZ2h0IChjKSAyMDEwICJDb3dib3kiIEJlbiBBbG1hbiwKLy8gRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXMuCi8vIGh0dHA6Ly9iZW5hbG1hbi5jb20vYWJvdXQvbGljZW5zZS8KLy8gCi8vIEFib3V0OiBFeGFtcGxlcwovLyAKLy8gVGhlc2Ugd29ya2luZyBleGFtcGxlcywgY29tcGxldGUgd2l0aCBmdWxseSBjb21tZW50ZWQgY29kZSwgaWxsdXN0cmF0ZSBhIGZldwovLyB3YXlzIGluIHdoaWNoIHRoaXMgcGx1Z2luIGNhbiBiZSB1c2VkLgovLyAKLy8gaGFzaGNoYW5nZSBldmVudCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9oYXNoY2hhbmdlLwovLyBkb2N1bWVudC5kb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvZG9jdW1lbnRfZG9tYWluLwovLyAKLy8gQWJvdXQ6IFN1cHBvcnQgYW5kIFRlc3RpbmcKLy8gCi8vIEluZm9ybWF0aW9uIGFib3V0IHdoYXQgdmVyc2lvbiBvciB2ZXJzaW9ucyBvZiBqUXVlcnkgdGhpcyBwbHVnaW4gaGFzIGJlZW4KLy8gdGVzdGVkIHdpdGgsIHdoYXQgYnJvd3NlcnMgaXQgaGFzIGJlZW4gdGVzdGVkIGluLCBhbmQgd2hlcmUgdGhlIHVuaXQgdGVzdHMKLy8gcmVzaWRlIChzbyB5b3UgY2FuIHRlc3QgaXQgeW91cnNlbGYpLgovLyAKLy8galF1ZXJ5IFZlcnNpb25zIC0gMS4yLjYsIDEuMy4yLCAxLjQuMSwgMS40LjIKLy8gQnJvd3NlcnMgVGVzdGVkIC0gSW50ZXJuZXQgRXhwbG9yZXIgNi04LCBGaXJlZm94IDItNCwgQ2hyb21lIDUtNiwgU2FmYXJpIDMuMi01LAovLyAgICAgICAgICAgICAgICAgICBPcGVyYSA5LjYtMTAuNjAsIGlQaG9uZSAzLjEsIEFuZHJvaWQgMS42LTIuMiwgQmxhY2tCZXJyeSA0LjYtNS4KLy8gVW5pdCBUZXN0cyAgICAgIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL3VuaXQvCi8vIAovLyBBYm91dDogS25vd24gaXNzdWVzCi8vIAovLyBXaGlsZSB0aGlzIGpRdWVyeSBoYXNoY2hhbmdlIGV2ZW50IGltcGxlbWVudGF0aW9uIGlzIHF1aXRlIHN0YWJsZSBhbmQKLy8gcm9idXN0LCB0aGVyZSBhcmUgYSBmZXcgdW5mb3J0dW5hdGUgYnJvd3NlciBidWdzIHN1cnJvdW5kaW5nIGV4cGVjdGVkCi8vIGhhc2hjaGFuZ2UgZXZlbnQtYmFzZWQgYmVoYXZpb3JzLCBpbmRlcGVuZGVudCBvZiBhbnkgSmF2YVNjcmlwdAovLyB3aW5kb3cub25oYXNoY2hhbmdlIGFic3RyYWN0aW9uLiBTZWUgdGhlIGZvbGxvd2luZyBleGFtcGxlcyBmb3IgbW9yZQovLyBpbmZvcm1hdGlvbjoKLy8gCi8vIENocm9tZTogQmFjayBCdXR0b24gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLWNocm9tZS1iYWNrLWJ1dHRvbi8KLy8gRmlyZWZveDogUmVtb3RlIFhNTEh0dHBSZXF1ZXN0IC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1maXJlZm94LXJlbW90ZS14aHIvCi8vIFdlYktpdDogQmFjayBCdXR0b24gaW4gYW4gSWZyYW1lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy13ZWJraXQtaGFzaC1pZnJhbWUvCi8vIFNhZmFyaTogQmFjayBCdXR0b24gZnJvbSBhIGRpZmZlcmVudCBkb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLXNhZmFyaS1iYWNrLWZyb20tZGlmZi1kb21haW4vCi8vIAovLyBBbHNvIG5vdGUgdGhhdCBzaG91bGQgYSBicm93c2VyIG5hdGl2ZWx5IHN1cHBvcnQgdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UgCi8vIGV2ZW50LCBidXQgbm90IHJlcG9ydCB0aGF0IGl0IGRvZXMsIHRoZSBmYWxsYmFjayBwb2xsaW5nIGxvb3Agd2lsbCBiZSB1c2VkLgovLyAKLy8gQWJvdXQ6IFJlbGVhc2UgSGlzdG9yeQovLyAKLy8gMS4zICAgLSAoNy8yMS8yMDEwKSBSZW9yZ2FuaXplZCBJRTYvNyBJZnJhbWUgY29kZSB0byBtYWtlIGl0IG1vcmUKLy8gICAgICAgICAicmVtb3ZhYmxlIiBmb3IgbW9iaWxlLW9ubHkgZGV2ZWxvcG1lbnQuIEFkZGVkIElFNi83IGRvY3VtZW50LnRpdGxlCi8vICAgICAgICAgc3VwcG9ydC4gQXR0ZW1wdGVkIHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZSBieSB1c2luZwovLyAgICAgICAgIHRlY2huaXF1ZXMgZnJvbSBodHRwOi8vd3d3LnBhY2llbGxvZ3JvdXAuY29tL2Jsb2cvP3A9NjA0LiBBZGRlZCAKLy8gICAgICAgICBzdXBwb3J0IGZvciB0aGUgInNob3J0Y3V0IiBmb3JtYXQgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoIGZuICkgYW5kCi8vICAgICAgICAgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBsaWtlIGpRdWVyeSBwcm92aWRlcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgovLyAgICAgICAgIFJlbmFtZWQgalF1ZXJ5Lmhhc2hjaGFuZ2VEZWxheSB0byA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IGFuZAovLyAgICAgICAgIGxvd2VyZWQgaXRzIGRlZmF1bHQgdmFsdWUgdG8gNTAuIEFkZGVkIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+Ci8vICAgICAgICAgYW5kIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmM+IHByb3BlcnRpZXMgcGx1cyBkb2N1bWVudC1kb21haW4uaHRtbAovLyAgICAgICAgIGZpbGUgdG8gYWRkcmVzcyBhY2Nlc3MgZGVuaWVkIGlzc3VlcyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGluCi8vICAgICAgICAgSUU2LzcuCi8vIDEuMiAgIC0gKDIvMTEvMjAxMCkgRml4ZWQgYSBidWcgd2hlcmUgY29taW5nIGJhY2sgdG8gYSBwYWdlIHVzaW5nIHRoaXMgcGx1Z2luCi8vICAgICAgICAgZnJvbSBhIHBhZ2Ugb24gYW5vdGhlciBkb21haW4gd291bGQgY2F1c2UgYW4gZXJyb3IgaW4gU2FmYXJpIDQuIEFsc28sCi8vICAgICAgICAgSUU2LzcgSWZyYW1lIGlzIG5vdyBpbnNlcnRlZCBhZnRlciB0aGUgYm9keSAodGhpcyBhY3R1YWxseSB3b3JrcyksCi8vICAgICAgICAgd2hpY2ggcHJldmVudHMgdGhlIHBhZ2UgZnJvbSBzY3JvbGxpbmcgd2hlbiB0aGUgZXZlbnQgaXMgZmlyc3QgYm91bmQuCi8vICAgICAgICAgRXZlbnQgY2FuIGFsc28gbm93IGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBpdCB3b24ndCBiZSB1c2FibGUKLy8gICAgICAgICBiZWZvcmUgdGhlbiBpbiBJRTYvNy4KLy8gMS4xICAgLSAoMS8yMS8yMDEwKSBJbmNvcnBvcmF0ZWQgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHRlc3QgdG8gZml4IElFOCBidWcKLy8gICAgICAgICB3aGVyZSBicm93c2VyIHZlcnNpb24gaXMgaW5jb3JyZWN0bHkgcmVwb3J0ZWQgYXMgOC4wLCBkZXNwaXRlCi8vICAgICAgICAgaW5jbHVzaW9uIG9mIHRoZSBYLVVBLUNvbXBhdGlibGUgSUU9RW11bGF0ZUlFNyBtZXRhIHRhZy4KLy8gMS4wICAgLSAoMS85LzIwMTApIEluaXRpYWwgUmVsZWFzZS4gQnJva2Ugb3V0IHRoZSBqUXVlcnkgQkJRIGV2ZW50LnNwZWNpYWwKLy8gICAgICAgICB3aW5kb3cub25oYXNoY2hhbmdlIGZ1bmN0aW9uYWxpdHkgaW50byBhIHNlcGFyYXRlIHBsdWdpbiBmb3IgdXNlcnMKLy8gICAgICAgICB3aG8gd2FudCBqdXN0IHRoZSBiYXNpYyBldmVudCAmIGJhY2sgYnV0dG9uIHN1cHBvcnQsIHdpdGhvdXQgYWxsIHRoZQovLyAgICAgICAgIGV4dHJhIGF3ZXNvbWVuZXNzIHRoYXQgQkJRIHByb3ZpZGVzLiBUaGlzIHBsdWdpbiB3aWxsIGJlIGluY2x1ZGVkIGFzCi8vICAgICAgICAgcGFydCBvZiBqUXVlcnkgQkJRLCBidXQgYWxzbyBiZSBhdmFpbGFibGUgc2VwYXJhdGVseS4KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CiAgLy8gUmV1c2VkIHN0cmluZy4KICB2YXIgc3RyX2hhc2hjaGFuZ2UgPSAnaGFzaGNoYW5nZScsCiAgICAKICAgIC8vIE1ldGhvZCAvIG9iamVjdCByZWZlcmVuY2VzLgogICAgZG9jID0gZG9jdW1lbnQsCiAgICBmYWtlX29uaGFzaGNoYW5nZSwKICAgIHNwZWNpYWwgPSAkLmV2ZW50LnNwZWNpYWwsCiAgICAKICAgIC8vIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCB3aW5kb3cub25oYXNoY2hhbmdlPyBOb3RlIHRoYXQgSUU4IHJ1bm5pbmcgaW4KICAgIC8vIElFNyBjb21wYXRpYmlsaXR5IG1vZGUgcmVwb3J0cyB0cnVlIGZvciAnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3csIGV2ZW4KICAgIC8vIHRob3VnaCB0aGUgZXZlbnQgaXNuJ3Qgc3VwcG9ydGVkLCBzbyBhbHNvIHRlc3QgZG9jdW1lbnQuZG9jdW1lbnRNb2RlLgogICAgZG9jX21vZGUgPSBkb2MuZG9jdW1lbnRNb2RlLAogICAgc3VwcG9ydHNfb25oYXNoY2hhbmdlID0gJ29uJyArIHN0cl9oYXNoY2hhbmdlIGluIHdpbmRvdyAmJiAoIGRvY19tb2RlID09PSB1bmRlZmluZWQgfHwgZG9jX21vZGUgPiA3ICk7CiAgCiAgLy8gR2V0IGxvY2F0aW9uLmhhc2ggKG9yIHdoYXQgeW91J2QgZXhwZWN0IGxvY2F0aW9uLmhhc2ggdG8gYmUpIHNhbnMgYW55CiAgLy8gbGVhZGluZyAjLiBUaGFua3MgZm9yIG1ha2luZyB0aGlzIG5lY2Vzc2FyeSwgRmlyZWZveCEKICBmdW5jdGlvbiBnZXRfZnJhZ21lbnQoIHVybCApIHsKICAgIHVybCA9IHVybCB8fCBsb2NhdGlvbi5ocmVmOwogICAgcmV0dXJuICcjJyArIHVybC5yZXBsYWNlKCAvXlteI10qIz8oLiopJC8sICckMScgKTsKICB9OwogIAogIC8vIE1ldGhvZDogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UKICAvLyAKICAvLyBCaW5kIGEgaGFuZGxlciB0byB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBvciB0cmlnZ2VyIGFsbCBib3VuZAogIC8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMuIFRoaXMgYmVoYXZpb3IgaXMgY29uc2lzdGVudCB3aXRoCiAgLy8galF1ZXJ5J3MgYnVpbHQtaW4gZXZlbnQgaGFuZGxlcnMuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCBbIGhhbmRsZXIgXSApOwogIC8vIAogIC8vIEFyZ3VtZW50czoKICAvLyAKICAvLyAgaGFuZGxlciAtIChGdW5jdGlvbikgT3B0aW9uYWwgaGFuZGxlciB0byBiZSBib3VuZCB0byB0aGUgaGFzaGNoYW5nZQogIC8vICAgIGV2ZW50LiBUaGlzIGlzIGEgInNob3J0Y3V0IiBmb3IgdGhlIG1vcmUgdmVyYm9zZSBmb3JtOgogIC8vICAgIGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgaGFuZGxlciApLiBJZiBoYW5kbGVyIGlzIG9taXR0ZWQsCiAgLy8gICAgYWxsIGJvdW5kIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMgd2lsbCBiZSB0cmlnZ2VyZWQuIFRoaXMKICAvLyAgICBpcyBhIHNob3J0Y3V0IGZvciB0aGUgbW9yZSB2ZXJib3NlCiAgLy8gICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuIFRoZXNlIGZvcm1zIGFyZSBkZXNjcmliZWQgaW4KICAvLyAgICB0aGUgPGhhc2hjaGFuZ2UgZXZlbnQ+IHNlY3Rpb24uCiAgLy8gCiAgLy8gUmV0dXJuczoKICAvLyAKICAvLyAgKGpRdWVyeSkgVGhlIGluaXRpYWwgalF1ZXJ5IGNvbGxlY3Rpb24gb2YgZWxlbWVudHMuCiAgCiAgLy8gQWxsb3cgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQoZWxlbSkuaGFzaGNoYW5nZSggZm4gKSBmb3IgYmluZGluZyBhbmQKICAvLyAkKGVsZW0pLmhhc2hjaGFuZ2UoKSBmb3IgdHJpZ2dlcmluZywgbGlrZSBqUXVlcnkgZG9lcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0gPSBmdW5jdGlvbiggZm4gKSB7CiAgICByZXR1cm4gZm4gPyB0aGlzLmJpbmQoIHN0cl9oYXNoY2hhbmdlLCBmbiApIDogdGhpcy50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogIH07CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5CiAgLy8gCiAgLy8gVGhlIG51bWVyaWMgaW50ZXJ2YWwgKGluIG1pbGxpc2Vjb25kcykgYXQgd2hpY2ggdGhlIDxoYXNoY2hhbmdlIGV2ZW50PgogIC8vIHBvbGxpbmcgbG9vcCBleGVjdXRlcy4gRGVmYXVsdHMgdG8gNTAuCiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbgogIC8vIAogIC8vIElmIHlvdSdyZSBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbiB5b3VyIEphdmFTY3JpcHQsIGFuZCB5b3Ugd2FudCBoYXNoCiAgLy8gaGlzdG9yeSB0byB3b3JrIGluIElFNi83LCBub3Qgb25seSBtdXN0IHRoaXMgcHJvcGVydHkgYmUgc2V0LCBidXQgeW91IG11c3QKICAvLyBhbHNvIHNldCBkb2N1bWVudC5kb21haW4gQkVGT1JFIGpRdWVyeSBpcyBsb2FkZWQgaW50byB0aGUgcGFnZS4gVGhpcwogIC8vIHByb3BlcnR5IGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcKICAvLyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vIAogIC8vIEluIGFkZGl0aW9uLCB0aGUgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydHkgbXVzdCBiZSBzZXQgdG8gdGhlCiAgLy8gcGF0aCBvZiB0aGUgaW5jbHVkZWQgImRvY3VtZW50LWRvbWFpbi5odG1sIiBmaWxlLCB3aGljaCBjYW4gYmUgcmVuYW1lZCBvcgogIC8vIG1vZGlmaWVkIGlmIG5lY2Vzc2FyeSAobm90ZSB0aGF0IHRoZSBkb2N1bWVudC5kb21haW4gc3BlY2lmaWVkIG11c3QgYmUgdGhlCiAgLy8gc2FtZSBpbiBib3RoIHlvdXIgbWFpbiBKYXZhU2NyaXB0IGFzIHdlbGwgYXMgaW4gdGhpcyBmaWxlKS4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4gPSBkb2N1bWVudC5kb21haW47CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYwogIC8vIAogIC8vIElmLCBmb3Igc29tZSByZWFzb24sIHlvdSBuZWVkIHRvIHNwZWNpZnkgYW4gSWZyYW1lIHNyYyBmaWxlIChmb3IgZXhhbXBsZSwKICAvLyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGFzIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+KSwgeW91IGNhbgogIC8vIGRvIHNvIHVzaW5nIHRoaXMgcHJvcGVydHkuIE5vdGUgdGhhdCB3aGVuIHVzaW5nIHRoaXMgcHJvcGVydHksIGhpc3RvcnkKICAvLyB3b24ndCBiZSByZWNvcmRlZCBpbiBJRTYvNyB1bnRpbCB0aGUgSWZyYW1lIHNyYyBmaWxlIGxvYWRzLiBUaGlzIHByb3BlcnR5CiAgLy8gaXMgb25seSBhcHBsaWNhYmxlIGlmIHlvdSBhcmUgc3VwcG9ydGluZyBJRTYvNyAob3IgSUU4IG9wZXJhdGluZyBpbiAiSUU3CiAgLy8gY29tcGF0aWJpbGl0eSIgbW9kZSkuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjID0gJ3BhdGgvdG8vZmlsZS5odG1sJzsKICAKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ID0gNTA7CiAgLyoKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbiA9IG51bGw7CiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmMgPSBudWxsOwogICovCiAgCiAgLy8gRXZlbnQ6IGhhc2hjaGFuZ2UgZXZlbnQKICAvLyAKICAvLyBGaXJlZCB3aGVuIGxvY2F0aW9uLmhhc2ggY2hhbmdlcy4gSW4gYnJvd3NlcnMgdGhhdCBzdXBwb3J0IGl0LCB0aGUgbmF0aXZlCiAgLy8gSFRNTDUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBpcyB1c2VkLCBvdGhlcndpc2UgYSBwb2xsaW5nIGxvb3AgaXMKICAvLyBpbml0aWFsaXplZCwgcnVubmluZyBldmVyeSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IG1pbGxpc2Vjb25kcyB0bwogIC8vIHNlZSBpZiB0aGUgaGFzaCBoYXMgY2hhbmdlZC4gSW4gSUU2LzcgKGFuZCBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKSwgYSBoaWRkZW4gSWZyYW1lIGlzIGNyZWF0ZWQgdG8gYWxsb3cgdGhlIGJhY2sgYnV0dG9uCiAgLy8gYW5kIGhhc2gtYmFzZWQgaGlzdG9yeSB0byB3b3JrLgogIC8vIAogIC8vIFVzYWdlIGFzIGRlc2NyaWJlZCBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2U+OgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPiAKICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCk7CiAgLy8gCiAgLy8gQSBtb3JlIHZlcmJvc2UgdXNhZ2UgdGhhdCBhbGxvd3MgZm9yIGV2ZW50IG5hbWVzcGFjaW5nOgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBmdW5jdGlvbihlKSB7CiAgLy8gPiAgIHZhciBoYXNoID0gbG9jYXRpb24uaGFzaDsKICAvLyA+ICAgLi4uCiAgLy8gPiB9KTsKICAvLyA+IAogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApOwogIC8vIAogIC8vIEFkZGl0aW9uYWwgTm90ZXM6CiAgLy8gCiAgLy8gKiBUaGUgcG9sbGluZyBsb29wIGFuZCBJZnJhbWUgYXJlIG5vdCBjcmVhdGVkIHVudGlsIGF0IGxlYXN0IG9uZSBoYW5kbGVyCiAgLy8gICBpcyBhY3R1YWxseSBib3VuZCB0byB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50LgogIC8vICogSWYgeW91IG5lZWQgdGhlIGJvdW5kIGhhbmRsZXIocykgdG8gZXhlY3V0ZSBpbW1lZGlhdGVseSwgaW4gY2FzZXMgd2hlcmUKICAvLyAgIGEgbG9jYXRpb24uaGFzaCBleGlzdHMgb24gcGFnZSBsb2FkLCB2aWEgYm9va21hcmsgb3IgcGFnZSByZWZyZXNoIGZvcgogIC8vICAgZXhhbXBsZSwgdXNlIGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBvciB0aGUgbW9yZSB2ZXJib3NlIAogIC8vICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuCiAgLy8gKiBUaGUgZXZlbnQgY2FuIGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBzaW5jZSBpdCB3b24ndCBiZSB1c2FibGUKICAvLyAgIGJlZm9yZSB0aGVuIGluIElFNi83IChkdWUgdG8gdGhlIG5lY2Vzc2FyeSBJZnJhbWUpLCByZWNvbW1lbmRlZCB1c2FnZSBpcwogIC8vICAgdG8gYmluZCBpdCBpbnNpZGUgYSBET00gcmVhZHkgaGFuZGxlci4KICAKICAvLyBPdmVycmlkZSBleGlzdGluZyAkLmV2ZW50LnNwZWNpYWwuaGFzaGNoYW5nZSBtZXRob2RzIChhbGxvd2luZyB0aGlzIHBsdWdpbgogIC8vIHRvIGJlIGRlZmluZWQgYWZ0ZXIgalF1ZXJ5IEJCUSBpbiBCQlEncyBzb3VyY2UgY29kZSkuCiAgc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSA9ICQuZXh0ZW5kKCBzcGVjaWFsWyBzdHJfaGFzaGNoYW5nZSBdLCB7CiAgICAKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGZpcnN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyBib3VuZCB0byB3aW5kb3cuCiAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIAogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gY3JlYXRlIG91ciBvd24uIEFuZCB3ZSBkb24ndCB3YW50IHRvIGNhbGwgdGhpcwogICAgICAvLyB1bnRpbCB0aGUgdXNlciBiaW5kcyB0byB0aGUgZXZlbnQsIGp1c3QgaW4gY2FzZSB0aGV5IG5ldmVyIGRvLCBzaW5jZSBpdAogICAgICAvLyB3aWxsIGNyZWF0ZSBhIHBvbGxpbmcgbG9vcCBhbmQgcG9zc2libHkgZXZlbiBhIGhpZGRlbiBJZnJhbWUuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0YXJ0ICk7CiAgICB9LAogICAgCiAgICAvLyBDYWxsZWQgb25seSB3aGVuIHRoZSBsYXN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyB1bmJvdW5kIGZyb20gd2luZG93LgogICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICAvLyBJZiB3aW5kb3cub25oYXNoY2hhbmdlIGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgdGhlcmUncyBub3RoaW5nIHRvIGRvLi4KICAgICAgaWYgKCBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIHN0b3Agb3VycyAoaWYgcG9zc2libGUpLgogICAgICAkKCBmYWtlX29uaGFzaGNoYW5nZS5zdG9wICk7CiAgICB9CiAgICAKICB9KTsKICAKICAvLyBmYWtlX29uaGFzaGNoYW5nZSBkb2VzIGFsbCB0aGUgd29yayBvZiB0cmlnZ2VyaW5nIHRoZSB3aW5kb3cub25oYXNoY2hhbmdlCiAgLy8gZXZlbnQgZm9yIGJyb3dzZXJzIHRoYXQgZG9uJ3QgbmF0aXZlbHkgc3VwcG9ydCBpdCwgaW5jbHVkaW5nIGNyZWF0aW5nIGEKICAvLyBwb2xsaW5nIGxvb3AgdG8gd2F0Y2ggZm9yIGhhc2ggY2hhbmdlcyBhbmQgaW4gSUUgNi83IGNyZWF0aW5nIGEgaGlkZGVuCiAgLy8gSWZyYW1lIHRvIGVuYWJsZSBiYWNrIGFuZCBmb3J3YXJkLgogIGZha2Vfb25oYXNoY2hhbmdlID0gKGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB7fSwKICAgICAgdGltZW91dF9pZCwKICAgICAgCiAgICAgIC8vIFJlbWVtYmVyIHRoZSBpbml0aWFsIGhhc2ggc28gaXQgZG9lc24ndCBnZXQgdHJpZ2dlcmVkIGltbWVkaWF0ZWx5LgogICAgICBsYXN0X2hhc2ggPSBnZXRfZnJhZ21lbnQoKSwKICAgICAgCiAgICAgIGZuX3JldHZhbCA9IGZ1bmN0aW9uKCB2YWwgKSB7IHJldHVybiB2YWw7IH0sCiAgICAgIGhpc3Rvcnlfc2V0ID0gZm5fcmV0dmFsLAogICAgICBoaXN0b3J5X2dldCA9IGZuX3JldHZhbDsKICAgIAogICAgLy8gU3RhcnQgdGhlIHBvbGxpbmcgbG9vcC4KICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCB8fCBwb2xsKCk7CiAgICB9OwogICAgCiAgICAvLyBTdG9wIHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCAmJiBjbGVhclRpbWVvdXQoIHRpbWVvdXRfaWQgKTsKICAgICAgdGltZW91dF9pZCA9IHVuZGVmaW5lZDsKICAgIH07CiAgICAKICAgIC8vIFRoaXMgcG9sbGluZyBsb29wIGNoZWNrcyBldmVyeSAkLmZuLmhhc2hjaGFuZ2UuZGVsYXkgbWlsbGlzZWNvbmRzIHRvIHNlZQogICAgLy8gaWYgbG9jYXRpb24uaGFzaCBoYXMgY2hhbmdlZCwgYW5kIHRyaWdnZXJzIHRoZSAnaGFzaGNoYW5nZScgZXZlbnQgb24KICAgIC8vIHdpbmRvdyB3aGVuIG5lY2Vzc2FyeS4KICAgIGZ1bmN0aW9uIHBvbGwoKSB7CiAgICAgIHZhciBoYXNoID0gZ2V0X2ZyYWdtZW50KCksCiAgICAgICAgaGlzdG9yeV9oYXNoID0gaGlzdG9yeV9nZXQoIGxhc3RfaGFzaCApOwogICAgICAKICAgICAgaWYgKCBoYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgaGlzdG9yeV9zZXQoIGxhc3RfaGFzaCA9IGhhc2gsIGhpc3RvcnlfaGFzaCApOwogICAgICAgIAogICAgICAgICQod2luZG93KS50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogICAgICAgIAogICAgICB9IGVsc2UgaWYgKCBoaXN0b3J5X2hhc2ggIT09IGxhc3RfaGFzaCApIHsKICAgICAgICBsb2NhdGlvbi5ocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKCAvIy4qLywgJycgKSArIGhpc3RvcnlfaGFzaDsKICAgICAgfQogICAgICAKICAgICAgdGltZW91dF9pZCA9IHNldFRpbWVvdXQoIHBvbGwsICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZGVsYXkgKTsKICAgIH07CiAgICAKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2diBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIHdpbmRvdy5hdHRhY2hFdmVudCAmJiAhd2luZG93LmFkZEV2ZW50TGlzdGVuZXIgJiYgIXN1cHBvcnRzX29uaGFzaGNoYW5nZSAmJiAoZnVuY3Rpb24oKSB7CiAgICAgIC8vIE5vdCBvbmx5IGRvIElFNi83IG5lZWQgdGhlICJtYWdpY2FsIiBJZnJhbWUgdHJlYXRtZW50LCBidXQgc28gZG9lcyBJRTgKICAgICAgLy8gd2hlbiBydW5uaW5nIGluICJJRTcgY29tcGF0aWJpbGl0eSIgbW9kZS4KICAgICAgCiAgICAgIHZhciBpZnJhbWUsCiAgICAgICAgaWZyYW1lX3NyYzsKICAgICAgCiAgICAgIC8vIFdoZW4gdGhlIGV2ZW50IGlzIGJvdW5kIGFuZCBwb2xsaW5nIHN0YXJ0cyBpbiBJRSA2LzcsIGNyZWF0ZSBhIGhpZGRlbgogICAgICAvLyBJZnJhbWUgZm9yIGhpc3RvcnkgaGFuZGxpbmcuCiAgICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoICFpZnJhbWUgKSB7CiAgICAgICAgICBpZnJhbWVfc3JjID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmM7CiAgICAgICAgICBpZnJhbWVfc3JjID0gaWZyYW1lX3NyYyAmJiBpZnJhbWVfc3JjICsgZ2V0X2ZyYWdtZW50KCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIENyZWF0ZSBoaWRkZW4gSWZyYW1lLiBBdHRlbXB0IHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZQogICAgICAgICAgLy8gYnkgdXNpbmcgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuCiAgICAgICAgICBpZnJhbWUgPSAkKCc8aWZyYW1lIHRhYmluZGV4PSItMSIgdGl0bGU9ImVtcHR5Ii8+JykuaGlkZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBXaGVuIElmcmFtZSBoYXMgY29tcGxldGVseSBsb2FkZWQsIGluaXRpYWxpemUgdGhlIGhpc3RvcnkgYW5kCiAgICAgICAgICAgIC8vIHN0YXJ0IHBvbGxpbmcuCiAgICAgICAgICAgIC5vbmUoICdsb2FkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWZyYW1lX3NyYyB8fCBoaXN0b3J5X3NldCggZ2V0X2ZyYWdtZW50KCkgKTsKICAgICAgICAgICAgICBwb2xsKCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBMb2FkIElmcmFtZSBzcmMgaWYgc3BlY2lmaWVkLCBvdGhlcndpc2Ugbm90aGluZy4KICAgICAgICAgICAgLmF0dHIoICdzcmMnLCBpZnJhbWVfc3JjIHx8ICdqYXZhc2NyaXB0OjAnICkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGVuZCBJZnJhbWUgYWZ0ZXIgdGhlIGVuZCBvZiB0aGUgYm9keSB0byBwcmV2ZW50IHVubmVjZXNzYXJ5CiAgICAgICAgICAgIC8vIGluaXRpYWwgcGFnZSBzY3JvbGxpbmcgKHllcywgdGhpcyB3b3JrcykuCiAgICAgICAgICAgIC5pbnNlcnRBZnRlciggJ2JvZHknIClbMF0uY29udGVudFdpbmRvdzsKICAgICAgICAgIAogICAgICAgICAgLy8gV2hlbmV2ZXIgYGRvY3VtZW50LnRpdGxlYCBjaGFuZ2VzLCB1cGRhdGUgdGhlIElmcmFtZSdzIHRpdGxlIHRvCiAgICAgICAgICAvLyBwcmV0dGlmeSB0aGUgYmFjay9uZXh0IGhpc3RvcnkgbWVudSBlbnRyaWVzLiBTaW5jZSBJRSBzb21ldGltZXMKICAgICAgICAgIC8vIGVycm9ycyB3aXRoICJVbnNwZWNpZmllZCBlcnJvciIgdGhlIHZlcnkgZmlyc3QgdGltZSB0aGlzIGlzIHNldAogICAgICAgICAgLy8gKHllcywgdmVyeSB1c2VmdWwpIHdyYXAgdGhpcyB3aXRoIGEgdHJ5L2NhdGNoIGJsb2NrLgogICAgICAgICAgZG9jLm9ucHJvcGVydHljaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpZiAoIGV2ZW50LnByb3BlcnR5TmFtZSA9PT0gJ3RpdGxlJyApIHsKICAgICAgICAgICAgICAgIGlmcmFtZS5kb2N1bWVudC50aXRsZSA9IGRvYy50aXRsZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2goZSkge30KICAgICAgICAgIH07CiAgICAgICAgICAKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgICAvLyBPdmVycmlkZSB0aGUgInN0b3AiIG1ldGhvZCBzaW5jZSBhbiBJRTYvNyBJZnJhbWUgd2FzIGNyZWF0ZWQuIEV2ZW4KICAgICAgLy8gaWYgdGhlcmUgYXJlIG5vIGxvbmdlciBhbnkgYm91bmQgZXZlbnQgaGFuZGxlcnMsIHRoZSBwb2xsaW5nIGxvb3AKICAgICAgLy8gaXMgc3RpbGwgbmVjZXNzYXJ5IGZvciBiYWNrL25leHQgdG8gd29yayBhdCBhbGwhCiAgICAgIHNlbGYuc3RvcCA9IGZuX3JldHZhbDsKICAgICAgCiAgICAgIC8vIEdldCBoaXN0b3J5IGJ5IGxvb2tpbmcgYXQgdGhlIGhpZGRlbiBJZnJhbWUncyBsb2NhdGlvbi5oYXNoLgogICAgICBoaXN0b3J5X2dldCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBnZXRfZnJhZ21lbnQoIGlmcmFtZS5sb2NhdGlvbi5ocmVmICk7CiAgICAgIH07CiAgICAgIAogICAgICAvLyBTZXQgYSBuZXcgaGlzdG9yeSBpdGVtIGJ5IG9wZW5pbmcgYW5kIHRoZW4gY2xvc2luZyB0aGUgSWZyYW1lCiAgICAgIC8vIGRvY3VtZW50LCAqdGhlbiogc2V0dGluZyBpdHMgbG9jYXRpb24uaGFzaC4gSWYgZG9jdW1lbnQuZG9tYWluIGhhcwogICAgICAvLyBiZWVuIHNldCwgdXBkYXRlIHRoYXQgYXMgd2VsbC4KICAgICAgaGlzdG9yeV9zZXQgPSBmdW5jdGlvbiggaGFzaCwgaGlzdG9yeV9oYXNoICkgewogICAgICAgIHZhciBpZnJhbWVfZG9jID0gaWZyYW1lLmRvY3VtZW50LAogICAgICAgICAgZG9tYWluID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kb21haW47CiAgICAgICAgCiAgICAgICAgaWYgKCBoYXNoICE9PSBoaXN0b3J5X2hhc2ggKSB7CiAgICAgICAgICAvLyBVcGRhdGUgSWZyYW1lIHdpdGggYW55IGluaXRpYWwgYGRvY3VtZW50LnRpdGxlYCB0aGF0IG1pZ2h0IGJlIHNldC4KICAgICAgICAgIGlmcmFtZV9kb2MudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAKICAgICAgICAgIC8vIE9wZW5pbmcgdGhlIElmcmFtZSdzIGRvY3VtZW50IGFmdGVyIGl0IGhhcyBiZWVuIGNsb3NlZCBpcyB3aGF0CiAgICAgICAgICAvLyBhY3R1YWxseSBhZGRzIGEgaGlzdG9yeSBlbnRyeS4KICAgICAgICAgIGlmcmFtZV9kb2Mub3BlbigpOwogICAgICAgICAgCiAgICAgICAgICAvLyBTZXQgZG9jdW1lbnQuZG9tYWluIGZvciB0aGUgSWZyYW1lIGRvY3VtZW50IGFzIHdlbGwsIGlmIG5lY2Vzc2FyeS4KICAgICAgICAgIGRvbWFpbiAmJiBpZnJhbWVfZG9jLndyaXRlKCAnPHNjcmlwdD5kb2N1bWVudC5kb21haW49IicgKyBkb21haW4gKyAnIjxcL3NjcmlwdD4nICk7CiAgICAgICAgICAKICAgICAgICAgIGlmcmFtZV9kb2MuY2xvc2UoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gVXBkYXRlIHRoZSBJZnJhbWUncyBoYXNoLCBmb3IgZ3JlYXQganVzdGljZS4KICAgICAgICAgIGlmcmFtZS5sb2NhdGlvbi5oYXNoID0gaGFzaDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgfSkoKTsKICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXiBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCBeXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIAogICAgcmV0dXJuIHNlbGY7CiAgfSkoKTsKICAKfSkoalF1ZXJ5LHRoaXMpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJLyohIG1hdGNoTWVkaWEoKSBwb2x5ZmlsbCAtIFRlc3QgYSBDU1MgbWVkaWEgdHlwZS9xdWVyeSBpbiBKUy4gQXV0aG9ycyAmIGNvcHlyaWdodCAoYykgMjAxMjogU2NvdHQgSmVobCwgUGF1bCBJcmlzaCwgTmljaG9sYXMgWmFrYXMuIER1YWwgTUlUL0JTRCBsaWNlbnNlICovCgl3aW5kb3cubWF0Y2hNZWRpYSA9IHdpbmRvdy5tYXRjaE1lZGlhIHx8IChmdW5jdGlvbiggZG9jLCB1bmRlZmluZWQgKSB7CgoJCQoKCQl2YXIgYm9vbCwKCQkJZG9jRWxlbSA9IGRvYy5kb2N1bWVudEVsZW1lbnQsCgkJCXJlZk5vZGUgPSBkb2NFbGVtLmZpcnN0RWxlbWVudENoaWxkIHx8IGRvY0VsZW0uZmlyc3RDaGlsZCwKCQkJLy8gZmFrZUJvZHkgcmVxdWlyZWQgZm9yIDxGRjQgd2hlbiBleGVjdXRlZCBpbiA8aGVhZD4KCQkJZmFrZUJvZHkgPSBkb2MuY3JlYXRlRWxlbWVudCggImJvZHkiICksCgkJCWRpdiA9IGRvYy5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoKCQlkaXYuaWQgPSAibXEtdGVzdC0xIjsKCQlkaXYuc3R5bGUuY3NzVGV4dCA9ICJwb3NpdGlvbjphYnNvbHV0ZTt0b3A6LTEwMGVtIjsKCQlmYWtlQm9keS5zdHlsZS5iYWNrZ3JvdW5kID0gIm5vbmUiOwoJCWZha2VCb2R5LmFwcGVuZENoaWxkKGRpdik7CgoJCXJldHVybiBmdW5jdGlvbihxKXsKCgkJCWRpdi5pbm5lckhUTUwgPSAiJnNoeTs8c3R5bGUgbWVkaWE9XCIiICsgcSArICJcIj4gI21xLXRlc3QtMSB7IHdpZHRoOiA0MnB4OyB9PC9zdHlsZT4iOwoKCQkJZG9jRWxlbS5pbnNlcnRCZWZvcmUoIGZha2VCb2R5LCByZWZOb2RlICk7CgkJCWJvb2wgPSBkaXYub2Zmc2V0V2lkdGggPT09IDQyOwoJCQlkb2NFbGVtLnJlbW92ZUNoaWxkKCBmYWtlQm9keSApOwoKCQkJcmV0dXJuIHsKCQkJCW1hdGNoZXM6IGJvb2wsCgkJCQltZWRpYTogcQoJCQl9OwoKCQl9OwoKCX0oIGRvY3VtZW50ICkpOwoKCS8vICQubW9iaWxlLm1lZGlhIHVzZXMgbWF0Y2hNZWRpYSB0byByZXR1cm4gYSBib29sZWFuLgoJJC5tb2JpbGUubWVkaWEgPSBmdW5jdGlvbiggcSApIHsKCQlyZXR1cm4gd2luZG93Lm1hdGNoTWVkaWEoIHEgKS5tYXRjaGVzOwoJfTsKCn0pKGpRdWVyeSk7CgoJKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJdmFyIHN1cHBvcnQgPSB7CgkJCXRvdWNoOiAib250b3VjaGVuZCIgaW4gZG9jdW1lbnQKCQl9OwoKCQkkLm1vYmlsZS5zdXBwb3J0ID0gJC5tb2JpbGUuc3VwcG9ydCB8fCB7fTsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCBzdXBwb3J0ICk7CgkJJC5leHRlbmQoICQubW9iaWxlLnN1cHBvcnQsIHN1cHBvcnQgKTsKCX0oIGpRdWVyeSApKTsKCgkoZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCB7CgkJCW9yaWVudGF0aW9uOiAib3JpZW50YXRpb24iIGluIHdpbmRvdyAmJiAib25vcmllbnRhdGlvbmNoYW5nZSIgaW4gd2luZG93CgkJfSk7Cgl9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIHRoeCBNb2Rlcm5penIKZnVuY3Rpb24gcHJvcEV4aXN0cyggcHJvcCApIHsKCXZhciB1Y19wcm9wID0gcHJvcC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zdWJzdHIoIDEgKSwKCQlwcm9wcyA9ICggcHJvcCArICIgIiArIHZlbmRvcnMuam9pbiggdWNfcHJvcCArICIgIiApICsgdWNfcHJvcCApLnNwbGl0KCAiICIgKSwKCQl2OwoKCWZvciAoIHYgaW4gcHJvcHMgKSB7CgkJaWYgKCBmYkNTU1sgcHJvcHNbIHYgXSBdICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KfQoKdmFyIGZha2VCb2R5ID0gJCggIjxib2R5PiIgKS5wcmVwZW5kVG8oICJodG1sIiApLAoJZmJDU1MgPSBmYWtlQm9keVsgMCBdLnN0eWxlLAoJdmVuZG9ycyA9IFsgIldlYmtpdCIsICJNb3oiLCAiTyIgXSwKCXdlYm9zID0gInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93LCAvL29ubHkgdXNlZCB0byBydWxlIG91dCBzY3JvbGxUb3AKCW9wZXJhID0gd2luZG93Lm9wZXJhLAoJb3BlcmFtaW5pID0gd2luZG93Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHdpbmRvdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIsCgliYiA9IHdpbmRvdy5ibGFja2JlcnJ5ICYmICFwcm9wRXhpc3RzKCAiLXdlYmtpdC10cmFuc2Zvcm0iICksIC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IGJveCBzaGFkb3csIGFzIGl0J3MgZmlsbGVkIG9wYXF1ZSBvbiBCQiA1IGFuZCBsb3dlcgoJbm9raWFMVEU3XzM7CgpmdW5jdGlvbiB2YWxpZFN0eWxlKCBwcm9wLCB2YWx1ZSwgY2hlY2tfdmVuZCApIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCXVjID0gZnVuY3Rpb24oIHR4dCApIHsKCQkJcmV0dXJuIHR4dC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgdHh0LnN1YnN0ciggMSApOwoJCX0sCgkJdmVuZF9wcmVmID0gZnVuY3Rpb24oIHZlbmQgKSB7CgkJCWlmICggdmVuZCA9PT0gIiIgKSB7CgkJCQlyZXR1cm4gIiI7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gICItIiArIHZlbmQuY2hhckF0KCAwICkudG9Mb3dlckNhc2UoKSArIHZlbmQuc3Vic3RyKCAxICkgKyAiLSI7CgkJCX0KCQl9LAoJCWNoZWNrX3N0eWxlID0gZnVuY3Rpb24oIHZlbmQgKSB7CgkJCXZhciB2ZW5kX3Byb3AgPSB2ZW5kX3ByZWYoIHZlbmQgKSArIHByb3AgKyAiOiAiICsgdmFsdWUgKyAiOyIsCgkJCQl1Y192ZW5kID0gdWMoIHZlbmQgKSwKCQkJCXByb3BTdHlsZSA9IHVjX3ZlbmQgKyAoIHVjX3ZlbmQgPT09ICIiID8gcHJvcCA6IHVjKCBwcm9wICkgKTsKCgkJCWRpdi5zZXRBdHRyaWJ1dGUoICJzdHlsZSIsIHZlbmRfcHJvcCApOwoKCQkJaWYgKCAhIWRpdi5zdHlsZVsgcHJvcFN0eWxlIF0gKSB7CgkJCQlyZXQgPSB0cnVlOwoJCQl9CgkJfSwKCQljaGVja192ZW5kcyA9IGNoZWNrX3ZlbmQgPyBjaGVja192ZW5kIDogdmVuZG9ycywKCQlpLCByZXQ7CgoJZm9yKCBpID0gMDsgaSA8IGNoZWNrX3ZlbmRzLmxlbmd0aDsgaSsrICkgewoJCWNoZWNrX3N0eWxlKCBjaGVja192ZW5kc1tpXSApOwoJfQoJcmV0dXJuICEhcmV0Owp9CgovLyBpbmxpbmUgU1ZHIHN1cHBvcnQgdGVzdApmdW5jdGlvbiBpbmxpbmVTVkcoKSB7CgkvLyBUaGFua3MgTW9kZXJuaXpyICYgRXJpayBEYWhsc3Ryb20KCXZhciB3ID0gd2luZG93LAoJCXN2ZyA9ICEhdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50TlMgJiYgISF3LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyggImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiwgInN2ZyIgKS5jcmVhdGVTVkdSZWN0ICYmICEoIHcub3BlcmEgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQ2hyb21lIiApID09PSAtMSApLAoJCXN1cHBvcnQgPSBmdW5jdGlvbiggZGF0YSApIHsKCQkJaWYgKCAhKCBkYXRhICYmIHN2ZyApICkgewoJCQkJJCggImh0bWwiICkuYWRkQ2xhc3MoICJ1aS1ub3N2ZyIgKTsKCQkJfQoJCX0sCgkJaW1nID0gbmV3IHcuSW1hZ2UoKTsKCglpbWcub25lcnJvciA9IGZ1bmN0aW9uKCkgewoJCXN1cHBvcnQoIGZhbHNlICk7Cgl9OwoJaW1nLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewoJCXN1cHBvcnQoIGltZy53aWR0aCA9PT0gMSAmJiBpbWcuaGVpZ2h0ID09PSAxICk7Cgl9OwoJaW1nLnNyYyA9ICJkYXRhOmltYWdlL2dpZjtiYXNlNjQsUjBsR09EbGhBUUFCQUlBQUFBQUFBUC8vL3l3QUFBQUFBUUFCQUFBQ0FVd0FPdz09IjsKfQoKZnVuY3Rpb24gdHJhbnNmb3JtM2RUZXN0KCkgewoJdmFyIG1xUHJvcCA9ICJ0cmFuc2Zvcm0tM2QiLAoJCS8vIEJlY2F1c2UgdGhlIGB0cmFuc2xhdGUzZGAgdGVzdCBiZWxvdyB0aHJvd3MgZmFsc2UgcG9zaXRpdmVzIGluIEFuZHJvaWQ6CgkJcmV0ID0gJC5tb2JpbGUubWVkaWEoICIoLSIgKyB2ZW5kb3JzLmpvaW4oICItIiArIG1xUHJvcCArICIpLCgtIiApICsgIi0iICsgbXFQcm9wICsgIiksKCIgKyBtcVByb3AgKyAiKSIgKSwKCQllbCwgdHJhbnNmb3JtcywgdDsKCglpZiAoIHJldCApIHsKCQlyZXR1cm4gISFyZXQ7Cgl9CgoJZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJdHJhbnNmb3JtcyA9IHsKCQkvLyBXZeKAmXJlIG9taXR0aW5nIE9wZXJhIGZvciB0aGUgdGltZSBiZWluZzsgTVMgdXNlcyB1bnByZWZpeGVkLgoJCSJNb3pUcmFuc2Zvcm0iOiAiLW1vei10cmFuc2Zvcm0iLAoJCSJ0cmFuc2Zvcm0iOiAidHJhbnNmb3JtIgoJfTsKCglmYWtlQm9keS5hcHBlbmQoIGVsICk7CgoJZm9yICggdCBpbiB0cmFuc2Zvcm1zICkgewoJCWlmICggZWwuc3R5bGVbIHQgXSAhPT0gdW5kZWZpbmVkICkgewoJCQllbC5zdHlsZVsgdCBdID0gInRyYW5zbGF0ZTNkKCAxMDBweCwgMXB4LCAxcHggKSI7CgkJCXJldCA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBlbCApLmdldFByb3BlcnR5VmFsdWUoIHRyYW5zZm9ybXNbIHQgXSApOwoJCX0KCX0KCXJldHVybiAoICEhcmV0ICYmIHJldCAhPT0gIm5vbmUiICk7Cn0KCi8vIFRlc3QgZm9yIGR5bmFtaWMtdXBkYXRpbmcgYmFzZSB0YWcgc3VwcG9ydCAoIGFsbG93cyB1cyB0byBhdm9pZCBocmVmLHNyYyBhdHRyIHJld3JpdGluZyApCmZ1bmN0aW9uIGJhc2VUYWdUZXN0KCkgewoJdmFyIGZhdXhCYXNlID0gbG9jYXRpb24ucHJvdG9jb2wgKyAiLy8iICsgbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lICsgInVpLWRpci8iLAoJCWJhc2UgPSAkKCAiaGVhZCBiYXNlIiApLAoJCWZhdXhFbGUgPSBudWxsLAoJCWhyZWYgPSAiIiwKCQlsaW5rLCByZWJhc2U7CgoJaWYgKCAhYmFzZS5sZW5ndGggKSB7CgkJYmFzZSA9IGZhdXhFbGUgPSAkKCAiPGJhc2U+IiwgeyAiaHJlZiI6IGZhdXhCYXNlIH0pLmFwcGVuZFRvKCAiaGVhZCIgKTsKCX0gZWxzZSB7CgkJaHJlZiA9IGJhc2UuYXR0ciggImhyZWYiICk7Cgl9CgoJbGluayA9ICQoICI8YSBocmVmPSd0ZXN0dXJsJyAvPiIgKS5wcmVwZW5kVG8oIGZha2VCb2R5ICk7CglyZWJhc2UgPSBsaW5rWyAwIF0uaHJlZjsKCWJhc2VbIDAgXS5ocmVmID0gaHJlZiB8fCBsb2NhdGlvbi5wYXRobmFtZTsKCglpZiAoIGZhdXhFbGUgKSB7CgkJZmF1eEVsZS5yZW1vdmUoKTsKCX0KCXJldHVybiByZWJhc2UuaW5kZXhPZiggZmF1eEJhc2UgKSA9PT0gMDsKfQoKLy8gVGhhbmtzIE1vZGVybml6cgpmdW5jdGlvbiBjc3NQb2ludGVyRXZlbnRzVGVzdCgpIHsKCXZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggIngiICksCgkJZG9jdW1lbnRFbGVtZW50ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LAoJCWdldENvbXB1dGVkU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSwKCQlzdXBwb3J0czsKCglpZiAoICEoICJwb2ludGVyRXZlbnRzIiBpbiBlbGVtZW50LnN0eWxlICkgKSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICJhdXRvIjsKCWVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICJ4IjsKCWRvY3VtZW50RWxlbWVudC5hcHBlbmRDaGlsZCggZWxlbWVudCApOwoJc3VwcG9ydHMgPSBnZXRDb21wdXRlZFN0eWxlICYmCglnZXRDb21wdXRlZFN0eWxlKCBlbGVtZW50LCAiIiApLnBvaW50ZXJFdmVudHMgPT09ICJhdXRvIjsKCWRvY3VtZW50RWxlbWVudC5yZW1vdmVDaGlsZCggZWxlbWVudCApOwoJcmV0dXJuICEhc3VwcG9ydHM7Cn0KCmZ1bmN0aW9uIGJvdW5kaW5nUmVjdCgpIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJcmV0dXJuIHR5cGVvZiBkaXYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0ICE9PSAidW5kZWZpbmVkIjsKfQoKLy8gbm9uLVVBLWJhc2VkIElFIHZlcnNpb24gY2hlY2sgYnkgSmFtZXMgUGFkb2xzZXksIG1vZGlmaWVkIGJ5IGpkYWx0b24gLSBmcm9tIGh0dHA6Ly9naXN0LmdpdGh1Yi5jb20vNTI3NjgzCi8vIGFsbG93cyBmb3IgaW5jbHVzaW9uIG9mIElFIDYrLCBpbmNsdWRpbmcgV2luZG93cyBNb2JpbGUgNwokLmV4dGVuZCggJC5tb2JpbGUsIHsgYnJvd3Nlcjoge30gfSApOwokLm1vYmlsZS5icm93c2VyLm9sZElFID0gKGZ1bmN0aW9uKCkgewoJdmFyIHYgPSAzLAoJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCgkJYSA9IGRpdi5hbGwgfHwgW107CgoJZG8gewoJCWRpdi5pbm5lckhUTUwgPSAiPCEtLVtpZiBndCBJRSAiICsgKCArK3YgKSArICJdPjxicj48IVtlbmRpZl0tLT4iOwoJfSB3aGlsZSggYVswXSApOwoKCXJldHVybiB2ID4gNCA/IHYgOiAhdjsKfSkoKTsKCmZ1bmN0aW9uIGZpeGVkUG9zaXRpb24oKSB7Cgl2YXIgdyA9IHdpbmRvdywKCQl1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0sCgkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTldKykvICksCgkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQlmZm1hdGNoID0gdWEubWF0Y2goIC9GZW5uZWNcLyhbMC05XSspLyApLAoJCWZmdmVyc2lvbiA9ICEhZmZtYXRjaCAmJiBmZm1hdGNoWyAxIF0sCgkJb3BlcmFtbW9iaWxlbWF0Y2ggPSB1YS5tYXRjaCggL09wZXJhIE1vYmlcLyhbMC05XSspLyApLAoJCW9tdmVyc2lvbiA9ICEhb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb3BlcmFtbW9iaWxlbWF0Y2hbIDEgXTsKCglpZiAoCgkJLy8gaU9TIDQuMyBhbmQgb2xkZXIgOiBQbGF0Zm9ybSBpcyBpUGhvbmUvUGFkL1RvdWNoIGFuZCBXZWJraXQgdmVyc2lvbiBpcyBsZXNzIHRoYW4gNTM0IChpb3M1KQoJCSggKCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBob25lIiApID4gLTEgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQYWQiICkgPiAtMSAgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQb2QiICkgPiAtMSApICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKSB8fAoJCS8vIE9wZXJhIE1pbmkKCQkoIHcub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIgKSB8fAoJCSggb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb212ZXJzaW9uIDwgNzQ1OCApCXx8CgkJLy9BbmRyb2lkIGx0ZSAyLjE6IFBsYXRmb3JtIGlzIEFuZHJvaWQgYW5kIFdlYmtpdCB2ZXJzaW9uIGlzIGxlc3MgdGhhbiA1MzMgKEFuZHJvaWQgMi4yKQoJCSggdWEuaW5kZXhPZiggIkFuZHJvaWQiICkgPiAtMSAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTMzICkgfHwKCQkvLyBGaXJlZm94IE1vYmlsZSBiZWZvcmUgNi4wIC0KCQkoIGZmdmVyc2lvbiAmJiBmZnZlcnNpb24gPCA2ICkgfHwKCQkvLyBXZWJPUyBsZXNzIHRoYW4gMwoJCSggInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93ICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKQl8fAoJCS8vIE1lZUdvCgkJKCB1YS5pbmRleE9mKCAiTWVlR28iICkgPiAtMSAmJiB1YS5pbmRleE9mKCAiTm9raWFCcm93c2VyLzguNS4wIiApID4gLTEgKSApIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJcmV0dXJuIHRydWU7Cn0KCiQuZXh0ZW5kKCAkLnN1cHBvcnQsIHsKCWNzc1RyYW5zaXRpb25zOiAiV2ViS2l0VHJhbnNpdGlvbkV2ZW50IiBpbiB3aW5kb3cgfHwKCQl2YWxpZFN0eWxlKCAidHJhbnNpdGlvbiIsICJoZWlnaHQgMTAwbXMgbGluZWFyIiwgWyAiV2Via2l0IiwgIk1veiIsICIiIF0gKSAmJgoJCSEkLm1vYmlsZS5icm93c2VyLm9sZElFICYmICFvcGVyYSwKCgkvLyBOb3RlLCBDaHJvbWUgZm9yIGlPUyBoYXMgYW4gZXh0cmVtZWx5IHF1aXJreSBpbXBsZW1lbnRhdGlvbiBvZiBwb3BzdGF0ZS4KCS8vIFdlJ3ZlIGNob3NlbiB0byB0YWtlIHRoZSBzaG9ydGVzdCBwYXRoIHRvIGEgYnVnIGZpeCBoZXJlIGZvciBpc3N1ZSAjNTQyNgoJLy8gU2VlIHRoZSBmb2xsb3dpbmcgbGluayBmb3IgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHJlZ2V4IGNob3NlbgoJLy8gaHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vY2hyb21lL21vYmlsZS9kb2NzL3VzZXItYWdlbnQjY2hyb21lX2Zvcl9pb3NfdXNlci1hZ2VudAoJcHVzaFN0YXRlOiAicHVzaFN0YXRlIiBpbiBoaXN0b3J5ICYmCgkJInJlcGxhY2VTdGF0ZSIgaW4gaGlzdG9yeSAmJgoJCS8vIFdoZW4gcnVubmluZyBpbnNpZGUgYSBGRiBpZnJhbWUsIGNhbGxpbmcgcmVwbGFjZVN0YXRlIGNhdXNlcyBhbiBlcnJvcgoJCSEoIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJGaXJlZm94IiApID49IDAgJiYgd2luZG93LnRvcCAhPT0gd2luZG93ICkgJiYKCQkoIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LnNlYXJjaCgvQ3JpT1MvKSA9PT0gLTEgKSwKCgltZWRpYXF1ZXJ5OiAkLm1vYmlsZS5tZWRpYSggIm9ubHkgYWxsIiApLAoJY3NzUHNldWRvRWxlbWVudDogISFwcm9wRXhpc3RzKCAiY29udGVudCIgKSwKCXRvdWNoT3ZlcmZsb3c6ICEhcHJvcEV4aXN0cyggIm92ZXJmbG93U2Nyb2xsaW5nIiApLAoJY3NzVHJhbnNmb3JtM2Q6IHRyYW5zZm9ybTNkVGVzdCgpLAoJY3NzQW5pbWF0aW9uczogISFwcm9wRXhpc3RzKCAiYW5pbWF0aW9uTmFtZSIgKSwKCWJveFNoYWRvdzogISFwcm9wRXhpc3RzKCAiYm94U2hhZG93IiApICYmICFiYiwKCWZpeGVkUG9zaXRpb246IGZpeGVkUG9zaXRpb24oKSwKCXNjcm9sbFRvcDogKCJwYWdlWE9mZnNldCIgaW4gd2luZG93IHx8CgkJInNjcm9sbFRvcCIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IHx8CgkJInNjcm9sbFRvcCIgaW4gZmFrZUJvZHlbIDAgXSkgJiYgIXdlYm9zICYmICFvcGVyYW1pbmksCgoJZHluYW1pY0Jhc2VUYWc6IGJhc2VUYWdUZXN0KCksCgljc3NQb2ludGVyRXZlbnRzOiBjc3NQb2ludGVyRXZlbnRzVGVzdCgpLAoJYm91bmRpbmdSZWN0OiBib3VuZGluZ1JlY3QoKSwKCWlubGluZVNWRzogaW5saW5lU1ZHCn0pOwoKZmFrZUJvZHkucmVtb3ZlKCk7CgovLyAkLm1vYmlsZS5hamF4QmxhY2tsaXN0IGlzIHVzZWQgdG8gb3ZlcnJpZGUgYWpheEVuYWJsZWQgb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBrbm93biBjb25mbGljdHMgd2l0aCBoYXNoIGhpc3RvcnkgdXBkYXRlcyAoQkI1LCBTeW1iaWFuKQovLyBvciB0aGF0IGdlbmVyYWxseSB3b3JrIGJldHRlciBicm93c2luZyBpbiByZWd1bGFyIGh0dHAgZm9yIGZ1bGwgcGFnZSByZWZyZXNoZXMgKE9wZXJhIE1pbmkpCi8vIE5vdGU6IFRoaXMgZGV0ZWN0aW9uIGJlbG93IGlzIHVzZWQgYXMgYSBsYXN0IHJlc29ydC4KLy8gV2UgcmVjb21tZW5kIG9ubHkgdXNpbmcgdGhlc2UgZGV0ZWN0aW9uIG1ldGhvZHMgd2hlbiBhbGwgb3RoZXIgbW9yZSByZWxpYWJsZS9mb3J3YXJkLWxvb2tpbmcgYXBwcm9hY2hlcyBhcmUgbm90IHBvc3NpYmxlCm5va2lhTFRFN18zID0gKGZ1bmN0aW9uKCkgewoKCXZhciB1YSA9IHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50OwoKCS8vVGhlIGZvbGxvd2luZyBpcyBhbiBhdHRlbXB0IHRvIG1hdGNoIE5va2lhIGJyb3dzZXJzIHRoYXQgYXJlIHJ1bm5pbmcgU3ltYmlhbi9zNjAsIHdpdGggd2Via2l0LCB2ZXJzaW9uIDcuMyBvciBvbGRlcgoJcmV0dXJuIHVhLmluZGV4T2YoICJOb2tpYSIgKSA+IC0xICYmCgkJCSggdWEuaW5kZXhPZiggIlN5bWJpYW4vMyIgKSA+IC0xIHx8IHVhLmluZGV4T2YoICJTZXJpZXM2MC81IiApID4gLTEgKSAmJgoJCQl1YS5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSAmJgoJCQl1YS5tYXRjaCggLyhCcm93c2VyTkd8Tm9raWFCcm93c2VyKVwvN1wuWzAtM10vICk7Cn0pKCk7CgovLyBTdXBwb3J0IGNvbmRpdGlvbnMgdGhhdCBtdXN0IGJlIG1ldCBpbiBvcmRlciB0byBwcm9jZWVkCi8vIGRlZmF1bHQgZW5oYW5jZWQgcXVhbGlmaWNhdGlvbnMgYXJlIG1lZGlhIHF1ZXJ5IHN1cHBvcnQgT1IgSUUgNysKCiQubW9iaWxlLmdyYWRlQSA9IGZ1bmN0aW9uKCkgewoJcmV0dXJuICggKCAkLnN1cHBvcnQubWVkaWFxdWVyeSAmJiAkLnN1cHBvcnQuY3NzUHNldWRvRWxlbWVudCApIHx8ICQubW9iaWxlLmJyb3dzZXIub2xkSUUgJiYgJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSA+PSA4ICkgJiYgKCAkLnN1cHBvcnQuYm91bmRpbmdSZWN0IHx8ICQuZm4uanF1ZXJ5Lm1hdGNoKC8xXC5bMC03K11cLlswLTkrXT8vKSAhPT0gbnVsbCApOwp9OwoKJC5tb2JpbGUuYWpheEJsYWNrbGlzdCA9CgkJCS8vIEJsYWNrQmVycnkgYnJvd3NlcnMsIHByZS13ZWJraXQKCQkJd2luZG93LmJsYWNrYmVycnkgJiYgIXdpbmRvdy5XZWJLaXRQb2ludCB8fAoJCQkvLyBPcGVyYSBNaW5pCgkJCW9wZXJhbWluaSB8fAoJCQkvLyBTeW1iaWFuIHdlYmtpdHMgcHJlIDcuMwoJCQlub2tpYUxURTdfMzsKCi8vIExhc3RseSwgdGhpcyB3b3JrYXJvdW5kIGlzIHRoZSBvbmx5IHdheSB3ZSd2ZSBmb3VuZCBzbyBmYXIgdG8gZ2V0IHByZSA3LjMgU3ltYmlhbiB3ZWJraXQgZGV2aWNlcwovLyB0byByZW5kZXIgdGhlIHN0eWxlc2hlZXRzIHdoZW4gdGhleSdyZSByZWZlcmVuY2VkIGJlZm9yZSB0aGlzIHNjcmlwdCwgYXMgd2UnZCByZWNvbW1lbmQgZG9pbmcuCi8vIFRoaXMgc2ltcGx5IHJlYXBwZW5kcyB0aGUgQ1NTIGluIHBsYWNlLCB3aGljaCBmb3Igc29tZSByZWFzb24gbWFrZXMgaXQgYXBwbHkKaWYgKCBub2tpYUxURTdfMyApIHsKCSQoZnVuY3Rpb24oKSB7CgkJJCggImhlYWQgbGlua1tyZWw9J3N0eWxlc2hlZXQnXSIgKS5hdHRyKCAicmVsIiwgImFsdGVybmF0ZSBzdHlsZXNoZWV0IiApLmF0dHIoICJyZWwiLCAic3R5bGVzaGVldCIgKTsKCX0pOwp9CgovLyBGb3IgcnVsaW5nIG91dCBzaGFkb3dzIHZpYSBjc3MKaWYgKCAhJC5zdXBwb3J0LmJveFNoYWRvdyApIHsKCSQoICJodG1sIiApLmFkZENsYXNzKCAidWktbm9ib3hzaGFkb3ciICk7Cn0KCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCXZhciAkd2luID0gJC5tb2JpbGUud2luZG93LCBzZWxmLAoJCWR1bW15Rm5Ub0luaXROYXZpZ2F0ZSA9IGZ1bmN0aW9uKCkgewoJCX07CgoJJC5ldmVudC5zcGVjaWFsLmJlZm9yZW5hdmlnYXRlID0gewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJJHdpbi5vbiggIm5hdmlnYXRlIiwgZHVtbXlGblRvSW5pdE5hdmlnYXRlICk7CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkkd2luLm9mZiggIm5hdmlnYXRlIiwgZHVtbXlGblRvSW5pdE5hdmlnYXRlICk7CgkJfQoJfTsKCgkkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUgPSBzZWxmID0gewoJCWJvdW5kOiBmYWxzZSwKCgkJcHVzaFN0YXRlRW5hYmxlZDogdHJ1ZSwKCgkJb3JpZ2luYWxFdmVudE5hbWU6IHVuZGVmaW5lZCwKCgkJLy8gSWYgcHVzaHN0YXRlIHN1cHBvcnQgaXMgcHJlc2VudCBhbmQgcHVzaCBzdGF0ZSBzdXBwb3J0IGlzIGRlZmluZWQgdG8KCQkvLyBiZSB0cnVlIG9uIHRoZSBtb2JpbGUgbmFtZXNwYWNlLgoJCWlzUHVzaFN0YXRlRW5hYmxlZDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLnN1cHBvcnQucHVzaFN0YXRlICYmCgkJCQkkLm1vYmlsZS5wdXNoU3RhdGVFbmFibGVkID09PSB0cnVlICYmCgkJCQl0aGlzLmlzSGFzaENoYW5nZUVuYWJsZWQoKTsKCQl9LAoKCQkvLyAhISBhc3N1bWVzIG1vYmlsZSBuYW1lc3BhY2UgaXMgcHJlc2VudAoJCWlzSGFzaENoYW5nZUVuYWJsZWQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgPT09IHRydWU7CgkJfSwKCgkJLy8gVE9ETyBhIGxvdCBvZiBkdXBsaWNhdGlvbiBiZXR3ZWVuIHBvcHN0YXRlIGFuZCBoYXNoY2hhbmdlCgkJcG9wc3RhdGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIG5ld0V2ZW50ID0gbmV3ICQuRXZlbnQoICJuYXZpZ2F0ZSIgKSwKCQkJCWJlZm9yZU5hdmlnYXRlID0gbmV3ICQuRXZlbnQoICJiZWZvcmVuYXZpZ2F0ZSIgKSwKCQkJCXN0YXRlID0gZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSB8fCB7fTsKCgkJCWJlZm9yZU5hdmlnYXRlLm9yaWdpbmFsRXZlbnQgPSBldmVudDsKCQkJJHdpbi50cmlnZ2VyKCBiZWZvcmVOYXZpZ2F0ZSApOwoKCQkJaWYgKCBiZWZvcmVOYXZpZ2F0ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCBldmVudC5oaXN0b3J5U3RhdGUgKSB7CgkJCQkkLmV4dGVuZChzdGF0ZSwgZXZlbnQuaGlzdG9yeVN0YXRlKTsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHRoZSBvcmlnaW5hbCBldmVudCBpcyB0cmFja2VkIGZvciB0aGUgZW5kCgkJCS8vIHVzZXIgdG8gaW5zcGVjdCBpbmNhc2UgdGhleSB3YW50IHRvIGRvIHNvbWV0aGluZyBzcGVjaWFsCgkJCW5ld0V2ZW50Lm9yaWdpbmFsRXZlbnQgPSBldmVudDsKCgkJCS8vIE5PVEUgd2UgbGV0IHRoZSBjdXJyZW50IHN0YWNrIHVud2luZCBiZWNhdXNlIGFueSBhc3NpZ25tZW50IHRvCgkJCS8vICAgICAgbG9jYXRpb24uaGFzaCB3aWxsIHN0b3AgdGhlIHdvcmxkIGFuZCBydW4gdGhpcyBldmVudCBoYW5kbGVyLiBCeQoJCQkvLyAgICAgIGRvaW5nIHRoaXMgd2UgY3JlYXRlIGEgc2ltaWxhciBiZWhhdmlvciB0byBoYXNoY2hhbmdlIG9uIGhhc2gKCQkJLy8gICAgICBhc3NpZ25tZW50CgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkkd2luLnRyaWdnZXIoIG5ld0V2ZW50LCB7CgkJCQkJc3RhdGU6IHN0YXRlCgkJCQl9KTsKCQkJfSwgMCk7CgkJfSwKCgkJaGFzaGNoYW5nZTogZnVuY3Rpb24oIGV2ZW50IC8qLCBkYXRhICovICkgewoJCQl2YXIgbmV3RXZlbnQgPSBuZXcgJC5FdmVudCggIm5hdmlnYXRlIiApLAoJCQkJYmVmb3JlTmF2aWdhdGUgPSBuZXcgJC5FdmVudCggImJlZm9yZW5hdmlnYXRlIiApOwoKCQkJYmVmb3JlTmF2aWdhdGUub3JpZ2luYWxFdmVudCA9IGV2ZW50OwoJCQkkd2luLnRyaWdnZXIoIGJlZm9yZU5hdmlnYXRlICk7CgoJCQlpZiAoIGJlZm9yZU5hdmlnYXRlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgdGhlIG9yaWdpbmFsIGV2ZW50IGlzIHRyYWNrZWQgZm9yIHRoZSBlbmQKCQkJLy8gdXNlciB0byBpbnNwZWN0IGluY2FzZSB0aGV5IHdhbnQgdG8gZG8gc29tZXRoaW5nIHNwZWNpYWwKCQkJbmV3RXZlbnQub3JpZ2luYWxFdmVudCA9IGV2ZW50OwoKCQkJLy8gVHJpZ2dlciB0aGUgaGFzaGNoYW5nZSB3aXRoIHN0YXRlIHByb3ZpZGVkIGJ5IHRoZSB1c2VyCgkJCS8vIHRoYXQgYWx0ZXJlZCB0aGUgaGFzaAoJCQkkd2luLnRyaWdnZXIoIG5ld0V2ZW50LCB7CgkJCQkvLyBVc2VycyB0aGF0IHdhbnQgdG8gZnVsbHkgbm9ybWFsaXplIHRoZSB0d28gZXZlbnRzCgkJCQkvLyB3aWxsIG5lZWQgdG8gZG8gaGlzdG9yeSBtYW5hZ2VtZW50IGRvd24gdGhlIHN0YWNrIGFuZAoJCQkJLy8gYWRkIHRoZSBzdGF0ZSB0byB0aGUgZXZlbnQgYmVmb3JlIHRoaXMgYmluZGluZyBpcyBmaXJlZAoJCQkJLy8gVE9ETyBjb25zaWRlciBhbGxvd2luZyBmb3IgdGhlIGV4cGxpY2l0IGFkZGl0aW9uIG9mIGNhbGxiYWNrcwoJCQkJLy8gICAgICB0byBiZSBmaXJlZCBiZWZvcmUgdGhpcyB2YWx1ZSBpcyBzZXQgdG8gYXZvaWQgZXZlbnQgdGltaW5nIGlzc3VlcwoJCQkJc3RhdGU6IGV2ZW50Lmhhc2hjaGFuZ2VTdGF0ZSB8fCB7fQoJCQl9KTsKCQl9LAoKCQkvLyBUT0RPIFdlIHJlYWxseSBvbmx5IHdhbnQgdG8gc2V0IHRoaXMgdXAgb25jZQoJCS8vICAgICAgYnV0IEknbSBub3QgY2xlYXIgaWYgdGhlcmUncyBhIGJldGVyIHdheSB0byBhY2hpZXZlCgkJLy8gICAgICB0aGlzIHdpdGggdGhlIGpRdWVyeSBzcGVjaWFsIGV2ZW50IHN0cnVjdHVyZQoJCXNldHVwOiBmdW5jdGlvbiggLyogZGF0YSwgbmFtZXNwYWNlcyAqLyApIHsKCQkJaWYgKCBzZWxmLmJvdW5kICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlzZWxmLmJvdW5kID0gdHJ1ZTsKCgkJCWlmICggc2VsZi5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCXNlbGYub3JpZ2luYWxFdmVudE5hbWUgPSAicG9wc3RhdGUiOwoJCQkJJHdpbi5iaW5kKCAicG9wc3RhdGUubmF2aWdhdGUiLCBzZWxmLnBvcHN0YXRlICk7CgkJCX0gZWxzZSBpZiAoIHNlbGYuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpICkgewoJCQkJc2VsZi5vcmlnaW5hbEV2ZW50TmFtZSA9ICJoYXNoY2hhbmdlIjsKCQkJCSR3aW4uYmluZCggImhhc2hjaGFuZ2UubmF2aWdhdGUiLCBzZWxmLmhhc2hjaGFuZ2UgKTsKCQkJfQoJCX0KCX07Cn0pKCBqUXVlcnkgKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJdmFyIHBhdGgsICRiYXNlLCBkaWFsb2dIYXNoS2V5ID0gIiZ1aS1zdGF0ZT1kaWFsb2ciOwoKCQkkLm1vYmlsZS5wYXRoID0gcGF0aCA9IHsKCQkJdWlTdGF0ZUtleTogIiZ1aS1zdGF0ZSIsCgoJCQkvLyBUaGlzIHNjYXJ5IGxvb2tpbmcgcmVndWxhciBleHByZXNzaW9uIHBhcnNlcyBhbiBhYnNvbHV0ZSBVUkwgb3IgaXRzIHJlbGF0aXZlCgkJCS8vIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBhbmQgaGFzaCksIGludG8gdGhlIHZhcmlvdXMKCQkJLy8gY29tcG9uZW50cyAocHJvdG9jb2wsIGhvc3QsIHBhdGgsIHF1ZXJ5LCBmcmFnbWVudCwgZXRjIHRoYXQgbWFrZSB1cCB0aGUKCQkJLy8gVVJMIGFzIHdlbGwgYXMgc29tZSBvdGhlciBjb21tb25seSB1c2VkIHN1Yi1wYXJ0cy4gV2hlbiB1c2VkIHdpdGggUmVnRXhwLmV4ZWMoKQoJCQkvLyBvciBTdHJpbmcubWF0Y2gsIGl0IHBhcnNlcyB0aGUgVVJMIGludG8gYSByZXN1bHRzIGFycmF5IHRoYXQgbG9va3MgbGlrZSB0aGlzOgoJCQkvLwoJCQkvLyAgICAgWzBdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3g/bXNnPTEyMzQmdHlwZT11bnJlYWQjbXNnLWNvbnRlbnQKCQkJLy8gICAgIFsxXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgICBbMl06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveAoJCQkvLyAgICAgWzNdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgICBbNF06IGh0dHA6CgkJCS8vICAgICBbNV06IC8vCgkJCS8vICAgICBbNl06IGpibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzddOiBqYmxhczpwYXNzd29yZAoJCQkvLyAgICAgWzhdOiBqYmxhcwoJCQkvLyAgICAgWzldOiBwYXNzd29yZAoJCQkvLyAgICBbMTBdOiBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgWzExXTogbXljb21wYW55LmNvbQoJCQkvLyAgICBbMTJdOiA4MDgwCgkJCS8vICAgIFsxM106IC9tYWlsL2luYm94CgkJCS8vICAgIFsxNF06IC9tYWlsLwoJCQkvLyAgICBbMTVdOiBpbmJveAoJCQkvLyAgICBbMTZdOiA/bXNnPTEyMzQmdHlwZT11bnJlYWQKCQkJLy8gICAgWzE3XTogI21zZy1jb250ZW50CgkJCS8vCgkJCXVybFBhcnNlUkU6IC9eXHMqKCgoKFteOlwvI1w/XSs6KT8oPzooXC9cLykoKD86KChbXjpAXC8jXD9dKykoPzpcOihbXjpAXC8jXD9dKykpPylAKT8oKFteOlwvI1w/XF1cW10rfFxbW15cL1xdQCM/XStcXSkoPzpcOihbMC05XSspKT8pKT8pPyk/KChcLz8oPzpbXlwvXD8jXStcLyspKikoW15cPyNdKikpKT8oXD9bXiNdKyk/KSgjLiopPy8sCgoJCQkvLyBBYnN0cmFjdGlvbiB0byBhZGRyZXNzIHhzcyAoSXNzdWUgIzQ3ODcpIGJ5IHJlbW92aW5nIHRoZSBhdXRob3JpdHkgaW4KCQkJLy8gYnJvd3NlcnMgdGhhdCBhdXRvCWRlY29kZSBpdC4gQWxsIHJlZmVyZW5jZXMgdG8gbG9jYXRpb24uaHJlZiBzaG91bGQgYmUKCQkJLy8gcmVwbGFjZWQgd2l0aCBhIGNhbGwgdG8gdGhpcyBtZXRob2Qgc28gdGhhdCBpdCBjYW4gYmUgZGVhbHQgd2l0aCBwcm9wZXJseSBoZXJlCgkJCWdldExvY2F0aW9uOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHVyaSA9IHVybCA/IHRoaXMucGFyc2VVcmwoIHVybCApIDogbG9jYXRpb24sCgkJCQkJaGFzaCA9IHRoaXMucGFyc2VVcmwoIHVybCB8fCBsb2NhdGlvbi5ocmVmICkuaGFzaDsKCgkJCQkvLyBtaW1pYyB0aGUgYnJvd3NlciB3aXRoIGFuIGVtcHR5IHN0cmluZyB3aGVuIHRoZSBoYXNoIGlzIGVtcHR5CgkJCQloYXNoID0gaGFzaCA9PT0gIiMiID8gIiIgOiBoYXNoOwoKCQkJCS8vIE1ha2Ugc3VyZSB0byBwYXJzZSB0aGUgdXJsIG9yIHRoZSBsb2NhdGlvbiBvYmplY3QgZm9yIHRoZSBoYXNoIGJlY2F1c2UgdXNpbmcgbG9jYXRpb24uaGFzaAoJCQkJLy8gaXMgYXV0b2RlY29kZWQgaW4gZmlyZWZveCwgdGhlIHJlc3Qgb2YgdGhlIHVybCBzaG91bGQgYmUgZnJvbSB0aGUgb2JqZWN0IChsb2NhdGlvbiB1bmxlc3MKCQkJCS8vIHdlJ3JlIHRlc3RpbmcpIHRvIGF2b2lkIHRoZSBpbmNsdXNpb24gb2YgdGhlIGF1dGhvcml0eQoJCQkJcmV0dXJuIHVyaS5wcm90b2NvbCArICIvLyIgKyB1cmkuaG9zdCArIHVyaS5wYXRobmFtZSArIHVyaS5zZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IHVybAoJCQlnZXREb2N1bWVudFVybDogZnVuY3Rpb24oIGFzUGFyc2VkT2JqZWN0ICkgewoJCQkJcmV0dXJuIGFzUGFyc2VkT2JqZWN0ID8gJC5leHRlbmQoIHt9LCBwYXRoLmRvY3VtZW50VXJsICkgOiBwYXRoLmRvY3VtZW50VXJsLmhyZWY7CgkJCX0sCgoJCQlwYXJzZUxvY2F0aW9uOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB0aGlzLnBhcnNlVXJsKCB0aGlzLmdldExvY2F0aW9uKCkgKTsKCQkJfSwKCgkJCS8vUGFyc2UgYSBVUkwgaW50byBhIHN0cnVjdHVyZSB0aGF0IGFsbG93cyBlYXN5IGFjY2VzcyB0bwoJCQkvL2FsbCBvZiB0aGUgVVJMIGNvbXBvbmVudHMgYnkgbmFtZS4KCQkJcGFyc2VVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBJZiB3ZSdyZSBwYXNzZWQgYW4gb2JqZWN0LCB3ZSdsbCBhc3N1bWUgdGhhdCBpdCBpcwoJCQkJLy8gYSBwYXJzZWQgdXJsIG9iamVjdCBhbmQganVzdCByZXR1cm4gaXQgYmFjayB0byB0aGUgY2FsbGVyLgoJCQkJaWYgKCAkLnR5cGUoIHVybCApID09PSAib2JqZWN0IiApIHsKCQkJCQlyZXR1cm4gdXJsOwoJCQkJfQoKCQkJCXZhciBtYXRjaGVzID0gcGF0aC51cmxQYXJzZVJFLmV4ZWMoIHVybCB8fCAiIiApIHx8IFtdOwoKCQkJCQkvLyBDcmVhdGUgYW4gb2JqZWN0IHRoYXQgYWxsb3dzIHRoZSBjYWxsZXIgdG8gYWNjZXNzIHRoZSBzdWItbWF0Y2hlcwoJCQkJCS8vIGJ5IG5hbWUuIE5vdGUgdGhhdCBJRSByZXR1cm5zIGFuIGVtcHR5IHN0cmluZyBpbnN0ZWFkIG9mIHVuZGVmaW5lZCwKCQkJCQkvLyBsaWtlIGFsbCBvdGhlciBicm93c2VycyBkbywgc28gd2Ugbm9ybWFsaXplIGV2ZXJ5dGhpbmcgc28gaXRzIGNvbnNpc3RlbnQKCQkJCQkvLyBubyBtYXR0ZXIgd2hhdCBicm93c2VyIHdlJ3JlIHJ1bm5pbmcgb24uCgkJCQkJcmV0dXJuIHsKCQkJCQkJaHJlZjogICAgICAgICBtYXRjaGVzWyAgMCBdIHx8ICIiLAoJCQkJCQlocmVmTm9IYXNoOiAgIG1hdGNoZXNbICAxIF0gfHwgIiIsCgkJCQkJCWhyZWZOb1NlYXJjaDogbWF0Y2hlc1sgIDIgXSB8fCAiIiwKCQkJCQkJZG9tYWluOiAgICAgICBtYXRjaGVzWyAgMyBdIHx8ICIiLAoJCQkJCQlwcm90b2NvbDogICAgIG1hdGNoZXNbICA0IF0gfHwgIiIsCgkJCQkJCWRvdWJsZVNsYXNoOiAgbWF0Y2hlc1sgIDUgXSB8fCAiIiwKCQkJCQkJYXV0aG9yaXR5OiAgICBtYXRjaGVzWyAgNiBdIHx8ICIiLAoJCQkJCQl1c2VybmFtZTogICAgIG1hdGNoZXNbICA4IF0gfHwgIiIsCgkJCQkJCXBhc3N3b3JkOiAgICAgbWF0Y2hlc1sgIDkgXSB8fCAiIiwKCQkJCQkJaG9zdDogICAgICAgICBtYXRjaGVzWyAxMCBdIHx8ICIiLAoJCQkJCQlob3N0bmFtZTogICAgIG1hdGNoZXNbIDExIF0gfHwgIiIsCgkJCQkJCXBvcnQ6ICAgICAgICAgbWF0Y2hlc1sgMTIgXSB8fCAiIiwKCQkJCQkJcGF0aG5hbWU6ICAgICBtYXRjaGVzWyAxMyBdIHx8ICIiLAoJCQkJCQlkaXJlY3Rvcnk6ICAgIG1hdGNoZXNbIDE0IF0gfHwgIiIsCgkJCQkJCWZpbGVuYW1lOiAgICAgbWF0Y2hlc1sgMTUgXSB8fCAiIiwKCQkJCQkJc2VhcmNoOiAgICAgICBtYXRjaGVzWyAxNiBdIHx8ICIiLAoJCQkJCQloYXNoOiAgICAgICAgIG1hdGNoZXNbIDE3IF0gfHwgIiIKCQkJCQl9OwoJCQl9LAoKCQkJLy9UdXJuIHJlbFBhdGggaW50byBhbiBhc2JvbHV0ZSBwYXRoLiBhYnNQYXRoIGlzCgkJCS8vYW4gb3B0aW9uYWwgYWJzb2x1dGUgcGF0aCB3aGljaCBkZXNjcmliZXMgd2hhdAoJCQkvL3JlbFBhdGggaXMgcmVsYXRpdmUgdG8uCgkJCW1ha2VQYXRoQWJzb2x1dGU6IGZ1bmN0aW9uKCByZWxQYXRoLCBhYnNQYXRoICkgewoJCQkJdmFyIGFic1N0YWNrLAoJCQkJCXJlbFN0YWNrLAoJCQkJCWksIGQ7CgoJCQkJaWYgKCByZWxQYXRoICYmIHJlbFBhdGguY2hhckF0KCAwICkgPT09ICIvIiApIHsKCQkJCQlyZXR1cm4gcmVsUGF0aDsKCQkJCX0KCgkJCQlyZWxQYXRoID0gcmVsUGF0aCB8fCAiIjsKCQkJCWFic1BhdGggPSBhYnNQYXRoID8gYWJzUGF0aC5yZXBsYWNlKCAvXlwvfChcL1teXC9dKnxbXlwvXSspJC9nLCAiIiApIDogIiI7CgoJCQkJYWJzU3RhY2sgPSBhYnNQYXRoID8gYWJzUGF0aC5zcGxpdCggIi8iICkgOiBbXTsKCQkJCXJlbFN0YWNrID0gcmVsUGF0aC5zcGxpdCggIi8iICk7CgoJCQkJZm9yICggaSA9IDA7IGkgPCByZWxTdGFjay5sZW5ndGg7IGkrKyApIHsKCQkJCQlkID0gcmVsU3RhY2tbIGkgXTsKCQkJCQlzd2l0Y2ggKCBkICkgewoJCQkJCQljYXNlICIuIjoKCQkJCQkJCWJyZWFrOwoJCQkJCQljYXNlICIuLiI6CgkJCQkJCQlpZiAoIGFic1N0YWNrLmxlbmd0aCApIHsKCQkJCQkJCQlhYnNTdGFjay5wb3AoKTsKCQkJCQkJCX0KCQkJCQkJCWJyZWFrOwoJCQkJCQlkZWZhdWx0OgoJCQkJCQkJYWJzU3RhY2sucHVzaCggZCApOwoJCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuICIvIiArIGFic1N0YWNrLmpvaW4oICIvIiApOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgaWYgYm90aCB1cmxzIGhhdmUgdGhlIHNhbWUgZG9tYWluLgoJCQlpc1NhbWVEb21haW46IGZ1bmN0aW9uKCBhYnNVcmwxLCBhYnNVcmwyICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIGFic1VybDEgKS5kb21haW4gPT09IHBhdGgucGFyc2VVcmwoIGFic1VybDIgKS5kb21haW47CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW55IHJlbGF0aXZlIHZhcmlhbnQuCgkJCWlzUmVsYXRpdmVVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBBbGwgcmVsYXRpdmUgVXJsIHZhcmlhbnRzIGhhdmUgb25lIHRoaW5nIGluIGNvbW1vbiwgbm8gcHJvdG9jb2wuCgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggdXJsICkucHJvdG9jb2wgPT09ICIiOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgZm9yIGFuIGFic29sdXRlIHVybC4KCQkJaXNBYnNvbHV0ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCAhPT0gIiI7CgkJCX0sCgoJCQkvL1R1cm4gdGhlIHNwZWNpZmllZCByZWFsdGl2ZSBVUkwgaW50byBhbiBhYnNvbHV0ZSBvbmUuIFRoaXMgZnVuY3Rpb24KCQkJLy9jYW4gaGFuZGxlIGFsbCByZWxhdGl2ZSB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgZnJhZ21lbnQpLgoJCQltYWtlVXJsQWJzb2x1dGU6IGZ1bmN0aW9uKCByZWxVcmwsIGFic1VybCApIHsKCQkJCWlmICggIXBhdGguaXNSZWxhdGl2ZVVybCggcmVsVXJsICkgKSB7CgkJCQkJcmV0dXJuIHJlbFVybDsKCQkJCX0KCgkJCQlpZiAoIGFic1VybCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCWFic1VybCA9IHRoaXMuZG9jdW1lbnRCYXNlOwoJCQkJfQoKCQkJCXZhciByZWxPYmogPSBwYXRoLnBhcnNlVXJsKCByZWxVcmwgKSwKCQkJCQlhYnNPYmogPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKSwKCQkJCQlwcm90b2NvbCA9IHJlbE9iai5wcm90b2NvbCB8fCBhYnNPYmoucHJvdG9jb2wsCgkJCQkJZG91YmxlU2xhc2ggPSByZWxPYmoucHJvdG9jb2wgPyByZWxPYmouZG91YmxlU2xhc2ggOiAoIHJlbE9iai5kb3VibGVTbGFzaCB8fCBhYnNPYmouZG91YmxlU2xhc2ggKSwKCQkJCQlhdXRob3JpdHkgPSByZWxPYmouYXV0aG9yaXR5IHx8IGFic09iai5hdXRob3JpdHksCgkJCQkJaGFzUGF0aCA9IHJlbE9iai5wYXRobmFtZSAhPT0gIiIsCgkJCQkJcGF0aG5hbWUgPSBwYXRoLm1ha2VQYXRoQWJzb2x1dGUoIHJlbE9iai5wYXRobmFtZSB8fCBhYnNPYmouZmlsZW5hbWUsIGFic09iai5wYXRobmFtZSApLAoJCQkJCXNlYXJjaCA9IHJlbE9iai5zZWFyY2ggfHwgKCAhaGFzUGF0aCAmJiBhYnNPYmouc2VhcmNoICkgfHwgIiIsCgkJCQkJaGFzaCA9IHJlbE9iai5oYXNoOwoKCQkJCXJldHVybiBwcm90b2NvbCArIGRvdWJsZVNsYXNoICsgYXV0aG9yaXR5ICsgcGF0aG5hbWUgKyBzZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJLy9BZGQgc2VhcmNoIChha2EgcXVlcnkpIHBhcmFtcyB0byB0aGUgc3BlY2lmaWVkIHVybC4KCQkJYWRkU2VhcmNoUGFyYW1zOiBmdW5jdGlvbiggdXJsLCBwYXJhbXMgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApLAoJCQkJCXAgPSAoIHR5cGVvZiBwYXJhbXMgPT09ICJvYmplY3QiICkgPyAkLnBhcmFtKCBwYXJhbXMgKSA6IHBhcmFtcywKCQkJCQlzID0gdS5zZWFyY2ggfHwgIj8iOwoJCQkJcmV0dXJuIHUuaHJlZk5vU2VhcmNoICsgcyArICggcy5jaGFyQXQoIHMubGVuZ3RoIC0gMSApICE9PSAiPyIgPyAiJiIgOiAiIiApICsgcCArICggdS5oYXNoIHx8ICIiICk7CgkJCX0sCgoJCQljb252ZXJ0VXJsVG9EYXRhVXJsOiBmdW5jdGlvbiggYWJzVXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKTsKCQkJCWlmICggcGF0aC5pc0VtYmVkZGVkUGFnZSggdSApICkgewoJCQkJCS8vIEZvciBlbWJlZGRlZCBwYWdlcywgcmVtb3ZlIHRoZSBkaWFsb2cgaGFzaCBrZXkgYXMgaW4gZ2V0RmlsZVBhdGgoKSwKCQkJCQkvLyBhbmQgcmVtb3ZlIG90aGVyd2lzZSB0aGUgRGF0YSBVcmwgd29uJ3QgbWF0Y2ggdGhlIGlkIG9mIHRoZSBlbWJlZGRlZCBQYWdlLgoJCQkJCXJldHVybiB1Lmhhc2gKCQkJCQkJLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF0KCQkJCQkJLnJlcGxhY2UoIC9eIy8sICIiICkKCQkJCQkJLnJlcGxhY2UoIC9cPy4qJC8sICIiICk7CgkJCQl9IGVsc2UgaWYgKCBwYXRoLmlzU2FtZURvbWFpbiggdSwgdGhpcy5kb2N1bWVudEJhc2UgKSApIHsKCQkJCQlyZXR1cm4gdS5ocmVmTm9IYXNoLnJlcGxhY2UoIHRoaXMuZG9jdW1lbnRCYXNlLmRvbWFpbiwgIiIgKS5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdOwoJCQkJfQoKCQkJCXJldHVybiB3aW5kb3cuZGVjb2RlVVJJQ29tcG9uZW50KGFic1VybCk7CgkJCX0sCgoJCQkvL2dldCBwYXRoIGZyb20gY3VycmVudCBoYXNoLCBvciBmcm9tIGEgZmlsZSBwYXRoCgkJCWdldDogZnVuY3Rpb24oIG5ld1BhdGggKSB7CgkJCQlpZiAoIG5ld1BhdGggPT09IHVuZGVmaW5lZCApIHsKCQkJCQluZXdQYXRoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQkJCX0KCQkJCXJldHVybiBwYXRoLnN0cmlwSGFzaCggbmV3UGF0aCApLnJlcGxhY2UoIC9bXlwvXSpcLlteXC8qXSskLywgIiIgKTsKCQkJfSwKCgkJCS8vc2V0IGxvY2F0aW9uIGhhc2ggdG8gcGF0aAoJCQlzZXQ6IGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJbG9jYXRpb24uaGFzaCA9IHBhdGg7CgkJCX0sCgoJCQkvL3Rlc3QgaWYgYSBnaXZlbiB1cmwgKHN0cmluZykgaXMgYSBwYXRoCgkJCS8vTk9URSBtaWdodCBiZSBleGNlcHRpb25hbGx5IG5haXZlCgkJCWlzUGF0aDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiAoIC9cLy8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCS8vcmV0dXJuIGEgdXJsIHBhdGggd2l0aCB0aGUgd2luZG93J3MgbG9jYXRpb24gcHJvdG9jb2wvaG9zdG5hbWUvcGF0aG5hbWUgcmVtb3ZlZAoJCQljbGVhbjogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggdGhpcy5kb2N1bWVudEJhc2UuZG9tYWluLCAiIiApOwoJCQl9LAoKCQkJLy9qdXN0IHJldHVybiB0aGUgdXJsIHdpdGhvdXQgYW4gaW5pdGlhbCAjCgkJCXN0cmlwSGFzaDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggL14jLywgIiIgKTsKCQkJfSwKCgkJCXN0cmlwUXVlcnlQYXJhbXM6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIC9cPy4qJC8sICIiICk7CgkJCX0sCgoJCQkvL3JlbW92ZSB0aGUgcHJlY2VkaW5nIGhhc2gsIGFueSBxdWVyeSBwYXJhbXMsIGFuZCBkaWFsb2cgbm90YXRpb25zCgkJCWNsZWFuSGFzaDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gcGF0aC5zdHJpcEhhc2goIGhhc2gucmVwbGFjZSggL1w/LiokLywgIiIgKS5yZXBsYWNlKCBkaWFsb2dIYXNoS2V5LCAiIiApICk7CgkJCX0sCgoJCQlpc0hhc2hWYWxpZDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gKCAvXiNbXiNdKyQvICkudGVzdCggaGFzaCApOwoJCQl9LAoKCQkJLy9jaGVjayB3aGV0aGVyIGEgdXJsIGlzIHJlZmVyZW5jaW5nIHRoZSBzYW1lIGRvbWFpbiwgb3IgYW4gZXh0ZXJuYWwgZG9tYWluIG9yIGRpZmZlcmVudCBwcm90b2NvbAoJCQkvL2NvdWxkIGJlIG1haWx0bywgZXRjCgkJCWlzRXh0ZXJuYWw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQkJcmV0dXJuIHUucHJvdG9jb2wgJiYgdS5kb21haW4gIT09IHRoaXMuZG9jdW1lbnRVcmwuZG9tYWluID8gdHJ1ZSA6IGZhbHNlOwoJCQl9LAoKCQkJaGFzUHJvdG9jb2w6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXig6P1x3KzopLyApLnRlc3QoIHVybCApOwoJCQl9LAoKCQkJaXNFbWJlZGRlZFBhZ2U6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoKCQkJCS8vaWYgdGhlIHBhdGggaXMgYWJzb2x1dGUsIHRoZW4gd2UgbmVlZCB0byBjb21wYXJlIHRoZSB1cmwgYWdhaW5zdAoJCQkJLy9ib3RoIHRoZSB0aGlzLmRvY3VtZW50VXJsIGFuZCB0aGUgZG9jdW1lbnRCYXNlLiBUaGUgbWFpbiByZWFzb24gZm9yIHRoaXMKCQkJCS8vaXMgdGhhdCBsaW5rcyBlbWJlZGRlZCB3aXRoaW4gZXh0ZXJuYWwgZG9jdW1lbnRzIHdpbGwgcmVmZXIgdG8gdGhlCgkJCQkvL2FwcGxpY2F0aW9uIGRvY3VtZW50LCB3aGVyZWFzIGxpbmtzIGVtYmVkZGVkIHdpdGhpbiB0aGUgYXBwbGljYXRpb24KCQkJCS8vZG9jdW1lbnQgd2lsbCBiZSByZXNvbHZlZCBhZ2FpbnN0IHRoZSBkb2N1bWVudCBiYXNlLgoJCQkJaWYgKCB1LnByb3RvY29sICE9PSAiIiApIHsKCQkJCQlyZXR1cm4gKCAhdGhpcy5pc1BhdGgodS5oYXNoKSAmJiB1Lmhhc2ggJiYgKCB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIHRoaXMuZG9jdW1lbnRCYXNlRGlmZmVycyAmJiB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSApICk7CgkJCQl9CgkJCQlyZXR1cm4gKCAvXiMvICkudGVzdCggdS5ocmVmICk7CgkJCX0sCgoJCQlzcXVhc2g6IGZ1bmN0aW9uKCB1cmwsIHJlc29sdXRpb25VcmwgKSB7CgkJCQl2YXIgaHJlZiwgY2xlYW5lZFVybCwgc2VhcmNoLCBzdGF0ZUluZGV4LAoJCQkJCWlzUGF0aCA9IHRoaXMuaXNQYXRoKCB1cmwgKSwKCQkJCQl1cmkgPSB0aGlzLnBhcnNlVXJsKCB1cmwgKSwKCQkJCQlwcmVzZXJ2ZWRIYXNoID0gdXJpLmhhc2gsCgkJCQkJdWlTdGF0ZSA9ICIiOwoKCQkJCS8vIHByb2R1Y2UgYSB1cmwgYWdhaW5zdCB3aGljaCB3ZSBjYW4gcmVzb2xlIHRoZSBwcm92aWRlZCBwYXRoCgkJCQlyZXNvbHV0aW9uVXJsID0gcmVzb2x1dGlvblVybCB8fCAocGF0aC5pc1BhdGgodXJsKSA/IHBhdGguZ2V0TG9jYXRpb24oKSA6IHBhdGguZ2V0RG9jdW1lbnRVcmwoKSk7CgoJCQkJLy8gSWYgdGhlIHVybCBpcyBhbnl0aGluZyBidXQgYSBzaW1wbGUgc3RyaW5nLCByZW1vdmUgYW55IHByZWNlZGluZyBoYXNoCgkJCQkvLyBlZyAjZm9vL2JhciAtPiBmb28vYmFyCgkJCQkvLyAgICAjZm9vIC0+ICNmb28KCQkJCWNsZWFuZWRVcmwgPSBpc1BhdGggPyBwYXRoLnN0cmlwSGFzaCggdXJsICkgOiB1cmw7CgoJCQkJLy8gSWYgdGhlIHVybCBpcyBhIGZ1bGwgdXJsIHdpdGggYSBoYXNoIGNoZWNrIGlmIHRoZSBwYXJzZWQgaGFzaCBpcyBhIHBhdGgKCQkJCS8vIGlmIGl0IGlzLCBzdHJpcCB0aGUgIywgYW5kIHVzZSBpdCBvdGhlcndpc2UgY29udGludWUgd2l0aG91dCBjaGFuZ2UKCQkJCWNsZWFuZWRVcmwgPSBwYXRoLmlzUGF0aCggdXJpLmhhc2ggKSA/IHBhdGguc3RyaXBIYXNoKCB1cmkuaGFzaCApIDogY2xlYW5lZFVybDsKCgkJCQkvLyBTcGxpdCB0aGUgVUkgU3RhdGUga2V5cyBvZmYgdGhlIGhyZWYKCQkJCXN0YXRlSW5kZXggPSBjbGVhbmVkVXJsLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApOwoKCQkJCS8vIHN0b3JlIHRoZSB1aSBzdGF0ZSBrZXlzIGZvciB1c2UKCQkJCWlmICggc3RhdGVJbmRleCA+IC0xICkgewoJCQkJCXVpU3RhdGUgPSBjbGVhbmVkVXJsLnNsaWNlKCBzdGF0ZUluZGV4ICk7CgkJCQkJY2xlYW5lZFVybCA9IGNsZWFuZWRVcmwuc2xpY2UoIDAsIHN0YXRlSW5kZXggKTsKCQkJCX0KCgkJCQkvLyBtYWtlIHRoZSBjbGVhbmVkVXJsIGFic29sdXRlIHJlbGF0aXZlIHRvIHRoZSByZXNvbHV0aW9uIHVybAoJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCBjbGVhbmVkVXJsLCByZXNvbHV0aW9uVXJsICk7CgoJCQkJLy8gZ3JhYiB0aGUgc2VhcmNoIGZyb20gdGhlIHJlc29sdmVkIHVybCBzaW5jZSBwYXJzaW5nIGZyb20KCQkJCS8vIHRoZSBwYXNzZWQgdXJsIG1heSBub3QgeWllbGQgdGhlIGNvcnJlY3QgcmVzdWx0CgkJCQlzZWFyY2ggPSB0aGlzLnBhcnNlVXJsKCBocmVmICkuc2VhcmNoOwoKCQkJCS8vIFRPRE8gYWxsIHRoaXMgY3JhcCBpcyB0ZXJyaWJsZSwgY2xlYW4gaXQgdXAKCQkJCWlmICggaXNQYXRoICkgewoJCQkJCS8vIHJlamVjdCB0aGUgaGFzaCBpZiBpdCdzIGEgcGF0aCBvciBpdCdzIGp1c3QgYSBkaWFsb2cga2V5CgkJCQkJaWYgKCBwYXRoLmlzUGF0aCggcHJlc2VydmVkSGFzaCApIHx8IHByZXNlcnZlZEhhc2gucmVwbGFjZSgiIyIsICIiKS5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKSA9PT0gMCkgewoJCQkJCQlwcmVzZXJ2ZWRIYXNoID0gIiI7CgkJCQkJfQoKCQkJCQkvLyBBcHBlbmQgdGhlIFVJIFN0YXRlIGtleXMgd2hlcmUgaXQgZXhpc3RzIGFuZCBpdCdzIGJlZW4gcmVtb3ZlZAoJCQkJCS8vIGZyb20gdGhlIHVybAoJCQkJCWlmICggdWlTdGF0ZSAmJiBwcmVzZXJ2ZWRIYXNoLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApID09PSAtMSkgewoJCQkJCQlwcmVzZXJ2ZWRIYXNoICs9IHVpU3RhdGU7CgkJCQkJfQoKCQkJCQkvLyBtYWtlIHN1cmUgdGhhdCBwb3VuZCBpcyBvbiB0aGUgZnJvbnQgb2YgdGhlIGhhc2gKCQkJCQlpZiAoIHByZXNlcnZlZEhhc2guaW5kZXhPZiggIiMiICkgPT09IC0xICYmIHByZXNlcnZlZEhhc2ggIT09ICIiICkgewoJCQkJCQlwcmVzZXJ2ZWRIYXNoID0gIiMiICsgcHJlc2VydmVkSGFzaDsKCQkJCQl9CgoJCQkJCS8vIHJlY29uc3RydWN0IGVhY2ggb2YgdGhlIHBpZWNlcyB3aXRoIHRoZSBuZXcgc2VhcmNoIHN0cmluZyBhbmQgaGFzaAoJCQkJCWhyZWYgPSBwYXRoLnBhcnNlVXJsKCBocmVmICk7CgkJCQkJaHJlZiA9IGhyZWYucHJvdG9jb2wgKyAiLy8iICsgaHJlZi5ob3N0ICsgaHJlZi5wYXRobmFtZSArIHNlYXJjaCArIHByZXNlcnZlZEhhc2g7CgkJCQl9IGVsc2UgewoJCQkJCWhyZWYgKz0gaHJlZi5pbmRleE9mKCAiIyIgKSA+IC0xID8gdWlTdGF0ZSA6ICIjIiArIHVpU3RhdGU7CgkJCQl9CgoJCQkJcmV0dXJuIGhyZWY7CgkJCX0sCgoJCQlpc1ByZXNlcnZhYmxlSGFzaDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gaGFzaC5yZXBsYWNlKCAiIyIsICIiICkuaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICkgPT09IDA7CgkJCX0sCgoJCQkvLyBFc2NhcGUgd2VpcmQgY2hhcmFjdGVycyBpbiB0aGUgaGFzaCBpZiBpdCBpcyB0byBiZSB1c2VkIGFzIGEgc2VsZWN0b3IKCQkJaGFzaFRvU2VsZWN0b3I6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJdmFyIGhhc0hhc2ggPSAoIGhhc2guc3Vic3RyaW5nKCAwLCAxICkgPT09ICIjIiApOwoJCQkJaWYgKCBoYXNIYXNoICkgewoJCQkJCWhhc2ggPSBoYXNoLnN1YnN0cmluZyggMSApOwoJCQkJfQoJCQkJcmV0dXJuICggaGFzSGFzaCA/ICIjIiA6ICIiICkgKyBoYXNoLnJlcGxhY2UoIC8oWyEiIyQlJicoKSorLC4vOjs8PT4/QFtcXV5ge3x9fl0pL2csICJcXCQxIiApOwoJCQl9LAoKCQkJLy8gcmV0dXJuIHRoZSBzdWJzdHJpbmcgb2YgYSBmaWxlcGF0aCBiZWZvcmUgdGhlIHN1Yi1wYWdlIGtleSwgZm9yIG1ha2luZwoJCQkvLyBhIHNlcnZlciByZXF1ZXN0CgkJCWdldEZpbGVQYXRoOiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCXZhciBzcGxpdGtleSA9ICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXk7CgkJCQlyZXR1cm4gcGF0aCAmJiBwYXRoLnNwbGl0KCBzcGxpdGtleSApWzBdLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCX0sCgoJCQkvLyBjaGVjayBpZiB0aGUgc3BlY2lmaWVkIHVybCByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIG1haW4KCQkJLy8gYXBwbGljYXRpb24gZG9jdW1lbnQuCgkJCWlzRmlyc3RQYWdlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gV2Ugb25seSBkZWFsIHdpdGggYWJzb2x1dGUgcGF0aHMuCgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIHRoaXMuZG9jdW1lbnRCYXNlICkgKSwKCgkJCQkJLy8gRG9lcyB0aGUgdXJsIGhhdmUgdGhlIHNhbWUgcGF0aCBhcyB0aGUgZG9jdW1lbnQ/CgkJCQkJc2FtZVBhdGggPSB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fAoJCQkJCQkoIHRoaXMuZG9jdW1lbnRCYXNlRGlmZmVycyAmJgoJCQkJCQkJdS5ocmVmTm9IYXNoID09PSB0aGlzLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICksCgoJCQkJCS8vIEdldCB0aGUgZmlyc3QgcGFnZSBlbGVtZW50LgoJCQkJCWZwID0gJC5tb2JpbGUuZmlyc3RQYWdlLAoKCQkJCQkvLyBHZXQgdGhlIGlkIG9mIHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQgaWYgaXQgaGFzIG9uZS4KCQkJCQlmcElkID0gZnAgJiYgZnBbMF0gPyBmcFswXS5pZCA6IHVuZGVmaW5lZDsKCgkJCQkvLyBUaGUgdXJsIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpZiB0aGUgcGF0aCBtYXRjaGVzIHRoZSBkb2N1bWVudCBhbmQKCQkJCS8vIGl0IGVpdGhlciBoYXMgbm8gaGFzaCB2YWx1ZSwgb3IgdGhlIGhhc2ggaXMgZXhhY3RseSBlcXVhbCB0byB0aGUgaWQKCQkJCS8vIG9mIHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQuCgkJCQlyZXR1cm4gc2FtZVBhdGggJiYKCQkJCQkoICF1Lmhhc2ggfHwKCQkJCQkJdS5oYXNoID09PSAiIyIgfHwKCQkJCQkJKCBmcElkICYmIHUuaGFzaC5yZXBsYWNlKCAvXiMvLCAiIiApID09PSBmcElkICkgKTsKCQkJfSwKCgkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cKCQkJLy8gY3Jvc3MtZG9tYWluIFhIUiByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZAoJCQkvLyB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuIFRoaXMgaXMgdXN1YWxseSB0byBhbGxvdyB0aGUgYXBwbGljYXRpb24gdG8KCQkJLy8gInBob25lIGhvbWUiIGFuZCBmZXRjaCBhcHAgc3BlY2lmaWMgZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyCgkJCS8vIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZSBhbGxvd0Nyb3NzRG9tYWluUGFnZXMKCQkJLy8gb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMgcmVxdWVzdHMgdG8gZ28KCQkJLy8gdGhyb3VnaCBvdXIgcGFnZSBsb2FkaW5nIGxvZ2ljLgoJCQlpc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdDogZnVuY3Rpb24oIGRvY1VybCwgcmVxVXJsICkgewoJCQkJcmV0dXJuICQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyAmJgoJCQkJCShkb2NVcmwucHJvdG9jb2wgPT09ICJmaWxlOiIgfHwgZG9jVXJsLnByb3RvY29sID09PSAiY29udGVudDoiKSAmJgoJCQkJCXJlcVVybC5zZWFyY2goIC9eaHR0cHM/Oi8gKSAhPT0gLTE7CgkJCX0KCQl9OwoKCQlwYXRoLmRvY3VtZW50VXJsID0gcGF0aC5wYXJzZUxvY2F0aW9uKCk7CgoJCSRiYXNlID0gJCggImhlYWQiICkuZmluZCggImJhc2UiICk7CgoJCXBhdGguZG9jdW1lbnRCYXNlID0gJGJhc2UubGVuZ3RoID8KCQkJcGF0aC5wYXJzZVVybCggcGF0aC5tYWtlVXJsQWJzb2x1dGUoICRiYXNlLmF0dHIoICJocmVmIiApLCBwYXRoLmRvY3VtZW50VXJsLmhyZWYgKSApIDoKCQkJcGF0aC5kb2N1bWVudFVybDsKCgkJcGF0aC5kb2N1bWVudEJhc2VEaWZmZXJzID0gKHBhdGguZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCAhPT0gcGF0aC5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCk7CgoJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCBiYXNlIHVybAoJCXBhdGguZ2V0RG9jdW1lbnRCYXNlID0gZnVuY3Rpb24oIGFzUGFyc2VkT2JqZWN0ICkgewoJCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIHBhdGguZG9jdW1lbnRCYXNlICkgOiBwYXRoLmRvY3VtZW50QmFzZS5ocmVmOwoJCX07CgoJCS8vIERFUFJFQ0FURUQgYXMgb2YgMS40LjAgLSByZW1vdmUgaW4gMS41LjAKCQkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCgkJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCB1cmwKCQkJZ2V0RG9jdW1lbnRVcmw6IHBhdGguZ2V0RG9jdW1lbnRVcmwsCgoJCQkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgYmFzZSB1cmwKCQkJZ2V0RG9jdW1lbnRCYXNlOiBwYXRoLmdldERvY3VtZW50QmFzZQoJCX0pOwp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJJC5tb2JpbGUuSGlzdG9yeSA9IGZ1bmN0aW9uKCBzdGFjaywgaW5kZXggKSB7CgkJdGhpcy5zdGFjayA9IHN0YWNrIHx8IFtdOwoJCXRoaXMuYWN0aXZlSW5kZXggPSBpbmRleCB8fCAwOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5IaXN0b3J5LnByb3RvdHlwZSwgewoJCWdldEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IF07CgkJfSwKCgkJZ2V0TGFzdDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLnByZXZpb3VzSW5kZXggXTsKCQl9LAoKCQlnZXROZXh0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMuYWN0aXZlSW5kZXggKyAxIF07CgkJfSwKCgkJZ2V0UHJldjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IC0gMSBdOwoJCX0sCgoJCS8vIGFkZE5ldyBpcyB1c2VkIHdoZW5ldmVyIGEgbmV3IHBhZ2UgaXMgYWRkZWQKCQlhZGQ6IGZ1bmN0aW9uKCB1cmwsIGRhdGEgKSB7CgkJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQkJLy9pZiB0aGVyZSdzIGZvcndhcmQgaGlzdG9yeSwgd2lwZSBpdAoJCQlpZiAoIHRoaXMuZ2V0TmV4dCgpICkgewoJCQkJdGhpcy5jbGVhckZvcndhcmQoKTsKCQkJfQoKCQkJLy8gaWYgdGhlIGhhc2ggaXMgaW5jbHVkZWQgaW4gdGhlIGRhdGEgbWFrZSBzdXJlIHRoZSBzaGFwZQoJCQkvLyBpcyBjb25zaXN0ZW50IGZvciBjb21wYXJpc29uCgkJCWlmICggZGF0YS5oYXNoICYmIGRhdGEuaGFzaC5pbmRleE9mKCAiIyIgKSA9PT0gLTEpIHsKCQkJCWRhdGEuaGFzaCA9ICIjIiArIGRhdGEuaGFzaDsKCQkJfQoKCQkJZGF0YS51cmwgPSB1cmw7CgkJCXRoaXMuc3RhY2sucHVzaCggZGF0YSApOwoJCQl0aGlzLmFjdGl2ZUluZGV4ID0gdGhpcy5zdGFjay5sZW5ndGggLSAxOwoJCX0sCgoJCS8vd2lwZSB1cmxzIGFoZWFkIG9mIGFjdGl2ZSBpbmRleAoJCWNsZWFyRm9yd2FyZDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuc3RhY2sgPSB0aGlzLnN0YWNrLnNsaWNlKCAwLCB0aGlzLmFjdGl2ZUluZGV4ICsgMSApOwoJCX0sCgoJCWZpbmQ6IGZ1bmN0aW9uKCB1cmwsIHN0YWNrLCBlYXJseVJldHVybiApIHsKCQkJc3RhY2sgPSBzdGFjayB8fCB0aGlzLnN0YWNrOwoKCQkJdmFyIGVudHJ5LCBpLCBsZW5ndGggPSBzdGFjay5sZW5ndGgsIGluZGV4OwoKCQkJZm9yICggaSA9IDA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJCWVudHJ5ID0gc3RhY2tbaV07CgoJCQkJaWYgKCBkZWNvZGVVUklDb21wb25lbnQodXJsKSA9PT0gZGVjb2RlVVJJQ29tcG9uZW50KGVudHJ5LnVybCkgfHwKCQkJCQlkZWNvZGVVUklDb21wb25lbnQodXJsKSA9PT0gZGVjb2RlVVJJQ29tcG9uZW50KGVudHJ5Lmhhc2gpICkgewoJCQkJCWluZGV4ID0gaTsKCgkJCQkJaWYgKCBlYXJseVJldHVybiApIHsKCQkJCQkJcmV0dXJuIGluZGV4OwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJcmV0dXJuIGluZGV4OwoJCX0sCgoJCWNsb3Nlc3Q6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCXZhciBjbG9zZXN0LCBhID0gdGhpcy5hY3RpdmVJbmRleDsKCgkJCS8vIEZpcnN0LCB0YWtlIHRoZSBzbGljZSBvZiB0aGUgaGlzdG9yeSBzdGFjayBiZWZvcmUgdGhlIGN1cnJlbnQgaW5kZXggYW5kIHNlYXJjaAoJCQkvLyBmb3IgYSB1cmwgbWF0Y2guIElmIG9uZSBpcyBmb3VuZCwgd2UnbGwgYXZvaWQgYXZvaWQgbG9va2luZyB0aHJvdWdoIGZvcndhcmQgaGlzdG9yeQoJCQkvLyBOT1RFIHRoZSBwcmVmZXJlbmNlIGZvciBiYWNrd2FyZCBoaXN0b3J5IG1vdmVtZW50IGlzIGRyaXZlbiBieSB0aGUgZmFjdCB0aGF0CgkJCS8vICAgICAgbW9zdCBtb2JpbGUgYnJvd3NlcnMgb25seSBoYXZlIGEgZGVkaWNhdGVkIGJhY2sgYnV0dG9uLCBhbmQgdXNlcnMgcmFyZWx5IHVzZQoJCQkvLyAgICAgIHRoZSBmb3J3YXJkIGJ1dHRvbiBpbiBkZXNrdG9wIGJyb3dzZXIgYW55aG93CgkJCWNsb3Nlc3QgPSB0aGlzLmZpbmQoIHVybCwgdGhpcy5zdGFjay5zbGljZSgwLCBhKSApOwoKCQkJLy8gSWYgbm90aGluZyB3YXMgZm91bmQgaW4gYmFja3dhcmQgaGlzdG9yeSBjaGVjayBmb3J3YXJkLiBUaGUgYHRydWVgCgkJCS8vIHZhbHVlIHBhc3NlZCBhcyB0aGUgdGhpcmQgcGFyYW1ldGVyIGNhdXNlcyB0aGUgZmluZCBtZXRob2QgdG8gYnJlYWsKCQkJLy8gb24gdGhlIGZpcnN0IG1hdGNoIGluIHRoZSBmb3J3YXJkIGhpc3Rvcnkgc2xpY2UuIFRoZSBzdGFydGluZyBpbmRleAoJCQkvLyBvZiB0aGUgc2xpY2UgbXVzdCB0aGVuIGJlIGFkZGVkIHRvIHRoZSByZXN1bHQgdG8gZ2V0IHRoZSBlbGVtZW50IGluZGV4CgkJCS8vIGluIHRoZSBvcmlnaW5hbCBoaXN0b3J5IHN0YWNrIDooIDooCgkJCS8vCgkJCS8vIFRPRE8gdGhpcyBpcyBoeXBlciBjb25mdXNpbmcgYW5kIHNob3VsZCBiZSBjbGVhbmVkIHVwICh1Z2ggc28gYmFkKQoJCQlpZiAoIGNsb3Nlc3QgPT09IHVuZGVmaW5lZCApIHsKCQkJCWNsb3Nlc3QgPSB0aGlzLmZpbmQoIHVybCwgdGhpcy5zdGFjay5zbGljZShhKSwgdHJ1ZSApOwoJCQkJY2xvc2VzdCA9IGNsb3Nlc3QgPT09IHVuZGVmaW5lZCA/IGNsb3Nlc3QgOiBjbG9zZXN0ICsgYTsKCQkJfQoKCQkJcmV0dXJuIGNsb3Nlc3Q7CgkJfSwKCgkJZGlyZWN0OiBmdW5jdGlvbiggb3B0cyApIHsKCQkJdmFyIG5ld0FjdGl2ZUluZGV4ID0gdGhpcy5jbG9zZXN0KCBvcHRzLnVybCApLCBhID0gdGhpcy5hY3RpdmVJbmRleDsKCgkJCS8vIHNhdmUgbmV3IHBhZ2UgaW5kZXgsIG51bGwgY2hlY2sgdG8gcHJldmVudCBmYWxzZXkgMCByZXN1bHQKCQkJLy8gcmVjb3JkIHRoZSBwcmV2aW91cyBpbmRleCBmb3IgcmVmZXJlbmNlCgkJCWlmICggbmV3QWN0aXZlSW5kZXggIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuYWN0aXZlSW5kZXggPSBuZXdBY3RpdmVJbmRleDsKCQkJCXRoaXMucHJldmlvdXNJbmRleCA9IGE7CgkJCX0KCgkJCS8vIGludm9rZSBjYWxsYmFja3Mgd2hlcmUgYXBwcm9wcmlhdGUKCQkJLy8KCQkJLy8gVE9ETyB0aGlzIGlzIGFsc28gY29udm9sdXRlZCBhbmQgY29uZnVzaW5nCgkJCWlmICggbmV3QWN0aXZlSW5kZXggPCBhICkgewoJCQkJKCBvcHRzLnByZXNlbnQgfHwgb3B0cy5iYWNrIHx8ICQubm9vcCApKCB0aGlzLmdldEFjdGl2ZSgpLCAiYmFjayIgKTsKCQkJfSBlbHNlIGlmICggbmV3QWN0aXZlSW5kZXggPiBhICkgewoJCQkJKCBvcHRzLnByZXNlbnQgfHwgb3B0cy5mb3J3YXJkIHx8ICQubm9vcCApKCB0aGlzLmdldEFjdGl2ZSgpLCAiZm9yd2FyZCIgKTsKCQkJfSBlbHNlIGlmICggbmV3QWN0aXZlSW5kZXggPT09IHVuZGVmaW5lZCAmJiBvcHRzLm1pc3NpbmcgKSB7CgkJCQlvcHRzLm1pc3NpbmcoIHRoaXMuZ2V0QWN0aXZlKCkgKTsKCQkJfQoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyIHBhdGggPSAkLm1vYmlsZS5wYXRoLAoJCWluaXRpYWxIcmVmID0gbG9jYXRpb24uaHJlZjsKCgkkLm1vYmlsZS5OYXZpZ2F0b3IgPSBmdW5jdGlvbiggaGlzdG9yeSApIHsKCQl0aGlzLmhpc3RvcnkgPSBoaXN0b3J5OwoJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgPSB0cnVlOwoKCQkkLm1vYmlsZS53aW5kb3cuYmluZCh7CgkJCSJwb3BzdGF0ZS5oaXN0b3J5IjogJC5wcm94eSggdGhpcy5wb3BzdGF0ZSwgdGhpcyApLAoJCQkiaGFzaGNoYW5nZS5oaXN0b3J5IjogJC5wcm94eSggdGhpcy5oYXNoY2hhbmdlLCB0aGlzICkKCQl9KTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuTmF2aWdhdG9yLnByb3RvdHlwZSwgewoJCXNxdWFzaDogZnVuY3Rpb24oIHVybCwgZGF0YSApIHsKCQkJdmFyIHN0YXRlLCBocmVmLCBoYXNoID0gcGF0aC5pc1BhdGgodXJsKSA/IHBhdGguc3RyaXBIYXNoKHVybCkgOiB1cmw7CgoJCQlocmVmID0gcGF0aC5zcXVhc2goIHVybCApOwoKCQkJLy8gbWFrZSBzdXJlIHRvIHByb3ZpZGUgdGhpcyBpbmZvcm1hdGlvbiB3aGVuIGl0IGlzbid0IGV4cGxpY2l0bHkgc2V0IGluIHRoZQoJCQkvLyBkYXRhIG9iamVjdCB0aGF0IHdhcyBwYXNzZWQgdG8gdGhlIHNxdWFzaCBtZXRob2QKCQkJc3RhdGUgPSAkLmV4dGVuZCh7CgkJCQloYXNoOiBoYXNoLAoJCQkJdXJsOiBocmVmCgkJCX0sIGRhdGEpOwoKCQkJLy8gcmVwbGFjZSB0aGUgY3VycmVudCB1cmwgd2l0aCB0aGUgbmV3IGhyZWYgYW5kIHN0b3JlIHRoZSBzdGF0ZQoJCQkvLyBOb3RlIHRoYXQgaW4gc29tZSBjYXNlcyB3ZSBtaWdodCBiZSByZXBsYWNpbmcgYW4gdXJsIHdpdGggdGhlCgkJCS8vIHNhbWUgdXJsLiBXZSBkbyB0aGlzIGFueXdheXMgYmVjYXVzZSB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGF0CgkJCS8vIGFsbCBvZiBvdXIgaGlzdG9yeSBlbnRyaWVzIGhhdmUgYSBzdGF0ZSBvYmplY3QgYXNzb2NpYXRlZCB3aXRoCgkJCS8vIHRoZW0uIFRoaXMgYWxsb3dzIHVzIHRvIHdvcmsgYXJvdW5kIHRoZSBjYXNlIHdoZXJlICQubW9iaWxlLmJhY2soKQoJCQkvLyBpcyBjYWxsZWQgdG8gdHJhbnNpdGlvbiBmcm9tIGFuIGV4dGVybmFsIHBhZ2UgdG8gYW4gZW1iZWRkZWQgcGFnZS4KCQkJLy8gSW4gdGhhdCBwYXJ0aWN1bGFyIGNhc2UsIGEgaGFzaGNoYW5nZSBldmVudCBpcyAqTk9UKiBnZW5lcmF0ZWQgYnkgdGhlIGJyb3dzZXIuCgkJCS8vIEVuc3VyaW5nIGVhY2ggaGlzdG9yeSBlbnRyeSBoYXMgYSBzdGF0ZSBvYmplY3QgbWVhbnMgdGhhdCBvblBvcFN0YXRlKCkKCQkJLy8gd2lsbCBhbHdheXMgdHJpZ2dlciBvdXIgaGFzaGNoYW5nZSBjYWxsYmFjayBldmVuIHdoZW4gYSBoYXNoY2hhbmdlIGV2ZW50CgkJCS8vIGlzIG5vdCBmaXJlZC4KCQkJd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKCBzdGF0ZSwgc3RhdGUudGl0bGUgfHwgZG9jdW1lbnQudGl0bGUsIGhyZWYgKTsKCgkJCXJldHVybiBzdGF0ZTsKCQl9LAoKCQloYXNoOiBmdW5jdGlvbiggdXJsLCBocmVmICkgewoJCQl2YXIgcGFyc2VkLCBsb2MsIGhhc2gsIHJlc29sdmVkOwoKCQkJLy8gR3JhYiB0aGUgaGFzaCBmb3IgcmVjb3JkaW5nLiBJZiB0aGUgcGFzc2VkIHVybCBpcyBhIHBhdGgKCQkJLy8gd2UgdXNlZCB0aGUgcGFyc2VkIHZlcnNpb24gb2YgdGhlIHNxdWFzaGVkIHVybCB0byByZWNvbnN0cnVjdCwKCQkJLy8gb3RoZXJ3aXNlIHdlIGFzc3VtZSBpdCdzIGEgaGFzaCBhbmQgc3RvcmUgaXQgZGlyZWN0bHkKCQkJcGFyc2VkID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgkJCWxvYyA9IHBhdGgucGFyc2VMb2NhdGlvbigpOwoKCQkJaWYgKCBsb2MucGF0aG5hbWUgKyBsb2Muc2VhcmNoID09PSBwYXJzZWQucGF0aG5hbWUgKyBwYXJzZWQuc2VhcmNoICkgewoJCQkJLy8gSWYgdGhlIHBhdGhuYW1lIGFuZCBzZWFyY2ggb2YgdGhlIHBhc3NlZCB1cmwgaXMgaWRlbnRpY2FsIHRvIHRoZSBjdXJyZW50IGxvYwoJCQkJLy8gdGhlbiB3ZSBtdXN0IHVzZSB0aGUgaGFzaC4gT3RoZXJ3aXNlIHRoZXJlIHdpbGwgYmUgbm8gZXZlbnQKCQkJCS8vIGVnLCB1cmwgPSAiL2Zvby9iYXI/YmF6I2JhbmciLCBsb2NhdGlvbi5ocmVmID0gImh0dHA6Ly9leGFtcGxlLmNvbS9mb28vYmFyP2JheiIKCQkJCWhhc2ggPSBwYXJzZWQuaGFzaCA/IHBhcnNlZC5oYXNoIDogcGFyc2VkLnBhdGhuYW1lICsgcGFyc2VkLnNlYXJjaDsKCQkJfSBlbHNlIGlmICggcGF0aC5pc1BhdGgodXJsKSApIHsKCQkJCXJlc29sdmVkID0gcGF0aC5wYXJzZVVybCggaHJlZiApOwoJCQkJLy8gSWYgdGhlIHBhc3NlZCB1cmwgaXMgYSBwYXRoLCBtYWtlIGl0IGRvbWFpbiByZWxhdGl2ZSBhbmQgcmVtb3ZlIGFueSB0cmFpbGluZyBoYXNoCgkJCQloYXNoID0gcmVzb2x2ZWQucGF0aG5hbWUgKyByZXNvbHZlZC5zZWFyY2ggKyAocGF0aC5pc1ByZXNlcnZhYmxlSGFzaCggcmVzb2x2ZWQuaGFzaCApPyByZXNvbHZlZC5oYXNoLnJlcGxhY2UoICIjIiwgIiIgKSA6ICIiKTsKCQkJfSBlbHNlIHsKCQkJCWhhc2ggPSB1cmw7CgkJCX0KCgkJCXJldHVybiBoYXNoOwoJCX0sCgoJCS8vIFRPRE8gcmVjb25zaWRlciBuYW1lCgkJZ286IGZ1bmN0aW9uKCB1cmwsIGRhdGEsIG5vRXZlbnRzICkgewoJCQl2YXIgc3RhdGUsIGhyZWYsIGhhc2gsIHBvcHN0YXRlRXZlbnQsCgkJCQlpc1BvcFN0YXRlRXZlbnQgPSAkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCk7CgoJCQkvLyBHZXQgdGhlIHVybCBhcyBpdCB3b3VsZCBsb29rIHNxdWFzaGVkIG9uIHRvIHRoZSBjdXJyZW50IHJlc29sdXRpb24gdXJsCgkJCWhyZWYgPSBwYXRoLnNxdWFzaCggdXJsICk7CgoJCQkvLyBzb3J0IG91dCB3aGF0IHRoZSBoYXNoIHNvdWxkIGJlIGZyb20gdGhlIHVybAoJCQloYXNoID0gdGhpcy5oYXNoKCB1cmwsIGhyZWYgKTsKCgkJCS8vIEhlcmUgd2UgcHJldmVudCB0aGUgbmV4dCBoYXNoIGNoYW5nZSBvciBwb3BzdGF0ZSBldmVudCBmcm9tIGRvaW5nIGFueQoJCQkvLyBoaXN0b3J5IG1hbmFnZW1lbnQuIEluIHRoZSBjYXNlIG9mIGhhc2hjaGFuZ2Ugd2UgZG9uJ3Qgc3dhbGxvdyBpdAoJCQkvLyBpZiB0aGVyZSB3aWxsIGJlIG5vIGhhc2hjaGFuZ2UgZmlyZWQgKHNpbmNlIHRoYXQgd29uJ3QgcmVzZXQgdGhlIHZhbHVlKQoJCQkvLyBhbmQgd2lsbCBzd2FsbG93IHRoZSBmb2xsb3dpbmcgaGFzaGNoYW5nZQoJCQlpZiAoIG5vRXZlbnRzICYmIGhhc2ggIT09IHBhdGguc3RyaXBIYXNoKHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gpICkgewoJCQkJdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgPSBub0V2ZW50czsKCQkJfQoKCQkJLy8gSU1QT1JUQU5UIGluIHRoZSBjYXNlIHdoZXJlIHBvcHN0YXRlIGlzIHN1cHBvcnRlZCB0aGUgZXZlbnQgd2lsbCBiZSB0cmlnZ2VyZWQKCQkJLy8gICAgICBkaXJlY3RseSwgc3RvcHBpbmcgZnVydGhlciBleGVjdXRpb24gLSBpZSwgaW50ZXJ1cHRpbmcgdGhlIGZsb3cgb2YgdGhpcwoJCQkvLyAgICAgIG1ldGhvZCBjYWxsIHRvIGZpcmUgYmluZGluZ3MgYXQgdGhpcyBleHByZXNzaW9uLiBCZWxvdyB0aGUgbmF2aWdhdGUgbWV0aG9kCgkJCS8vICAgICAgdGhlcmUgaXMgYSBiaW5kaW5nIHRvIGNhdGNoIHRoaXMgZXZlbnQgYW5kIHN0b3AgaXRzIHByb3BhZ2F0aW9uLgoJCQkvLwoJCQkvLyAgICAgIFdlIHRoZW4gdHJpZ2dlciBhIG5ldyBwb3BzdGF0ZSBldmVudCBvbiB0aGUgd2luZG93IHdpdGggYSBudWxsIHN0YXRlCgkJCS8vICAgICAgc28gdGhhdCB0aGUgbmF2aWdhdGUgZXZlbnRzIGNhbiBjb25jbHVkZSB0aGVpciB3b3JrIHByb3Blcmx5CgkJCS8vCgkJCS8vIGlmIHRoZSB1cmwgaXMgYSBwYXRoIHdlIHdhbnQgdG8gcHJlc2VydmUgdGhlIHF1ZXJ5IHBhcmFtcyB0aGF0IGFyZSBhdmFpbGFibGUgb24KCQkJLy8gdGhlIGN1cnJlbnQgdXJsLgoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSB0cnVlOwoJCQl3aW5kb3cubG9jYXRpb24uaGFzaCA9IGhhc2g7CgoJCQkvLyBJZiBwb3BzdGF0ZSBpcyBlbmFibGVkIGFuZCB0aGUgYnJvd3NlciB0cmlnZ2VycyBgcG9wc3RhdGVgIGV2ZW50cyB3aGVuIHRoZSBoYXNoCgkJCS8vIGlzIHNldCAodGhpcyBvZnRlbiBoYXBwZW5zIGltbWVkaWF0ZWx5IGluIGJyb3dzZXJzIGxpa2UgQ2hyb21lKSwgdGhlbiB0aGUKCQkJLy8gdGhpcyBmbGFnIHdpbGwgYmUgc2V0IHRvIGZhbHNlIGFscmVhZHkuIElmIGl0J3MgYSBicm93c2VyIHRoYXQgZG9lcyBub3QgdHJpZ2dlcgoJCQkvLyBhIGBwb3BzdGF0ZWAgb24gaGFzaCBhc3NpZ25lbWVudCBvciBgcmVwbGFjZVN0YXRlYCB0aGVuIHdlIG5lZWQgYXZvaWQgdGhlIGJyYW5jaAoJCQkvLyB0aGF0IHN3YWxsb3dzIHRoZSBldmVudCBjcmVhdGVkIGJ5IHRoZSBwb3BzdGF0ZSBnZW5lcmF0ZWQgYnkgdGhlIGhhc2ggYXNzaWdubWVudAoJCQkvLyBBdCB0aGUgdGltZSBvZiB0aGlzIHdyaXRpbmcgdGhpcyBoYXBwZW5zIHdpdGggT3BlcmEgMTIgYW5kIHNvbWUgdmVyc2lvbiBvZiBJRQoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCgkJCXN0YXRlID0gJC5leHRlbmQoewoJCQkJdXJsOiBocmVmLAoJCQkJaGFzaDogaGFzaCwKCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZQoJCQl9LCBkYXRhKTsKCgkJCWlmICggaXNQb3BTdGF0ZUV2ZW50ICkgewoJCQkJcG9wc3RhdGVFdmVudCA9IG5ldyAkLkV2ZW50KCAicG9wc3RhdGUiICk7CgkJCQlwb3BzdGF0ZUV2ZW50Lm9yaWdpbmFsRXZlbnQgPSB7CgkJCQkJdHlwZTogInBvcHN0YXRlIiwKCQkJCQlzdGF0ZTogbnVsbAoJCQkJfTsKCgkJCQl0aGlzLnNxdWFzaCggdXJsLCBzdGF0ZSApOwoKCQkJCS8vIFRyaWdnZXIgYSBuZXcgZmF1eCBwb3BzdGF0ZSBldmVudCB0byByZXBsYWNlIHRoZSBvbmUgdGhhdCB3ZQoJCQkJLy8gY2F1Z2h0IHRoYXQgd2FzIHRyaWdnZXJlZCBieSB0aGUgaGFzaCBzZXR0aW5nIGFib3ZlLgoJCQkJaWYgKCAhbm9FdmVudHMgKSB7CgkJCQkJdGhpcy5pZ25vcmVQb3BTdGF0ZSA9IHRydWU7CgkJCQkJJC5tb2JpbGUud2luZG93LnRyaWdnZXIoIHBvcHN0YXRlRXZlbnQgKTsKCQkJCX0KCQkJfQoKCQkJLy8gcmVjb3JkIHRoZSBoaXN0b3J5IGVudHJ5IHNvIHRoYXQgdGhlIGluZm9ybWF0aW9uIGNhbiBiZSBpbmNsdWRlZAoJCQkvLyBpbiBoYXNoY2hhbmdlIGV2ZW50IGRyaXZlbiBuYXZpZ2F0ZSBldmVudHMgaW4gYSBzaW1pbGFyIGZhc2hpb24gdG8KCQkJLy8gdGhlIHN0YXRlIHRoYXQncyBwcm92aWRlZCBieSBwb3BzdGF0ZQoJCQl0aGlzLmhpc3RvcnkuYWRkKCBzdGF0ZS51cmwsIHN0YXRlICk7CgkJfSwKCgkJLy8gVGhpcyBiaW5kaW5nIGlzIGludGVuZGVkIHRvIGNhdGNoIHRoZSBwb3BzdGF0ZSBldmVudHMgdGhhdCBhcmUgZmlyZWQKCQkvLyB3aGVuIGV4ZWN1dGlvbiBvZiB0aGUgYCQubmF2aWdhdGVgIG1ldGhvZCBzdG9wcyBhdCB3aW5kb3cubG9jYXRpb24uaGFzaCA9IHVybDsKCQkvLyBhbmQgY29tcGxldGVseSBwcmV2ZW50IHRoZW0gZnJvbSBwcm9wYWdhdGluZy4gVGhlIHBvcHN0YXRlIGV2ZW50IHdpbGwgdGhlbiBiZQoJCS8vIHJldHJpZ2dlcmVkIGFmdGVyIGV4ZWN1dGlvbiByZXN1bWVzCgkJLy8KCQkvLyBUT0RPIGdyYWIgdGhlIG9yaWdpbmFsIGV2ZW50IGhlcmUgYW5kIHVzZSBpdCBmb3IgdGhlIHN5bnRoZXRpYyBldmVudCBpbiB0aGUKCQkvLyAgICAgIHNlY29uZCBoYWxmIG9mIHRoZSBuYXZpZ2F0ZSBleGVjdXRpb24gdGhhdCB3aWxsIGZvbGxvdyB0aGlzIGJpbmRpbmcKCQlwb3BzdGF0ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgaGFzaCwgc3RhdGU7CgoJCQkvLyBQYXJ0bHkgdG8gc3VwcG9ydCBvdXIgdGVzdCBzdWl0ZSB3aGljaCBtYW51YWxseSBhbHRlcnMgdGhlIHN1cHBvcnQKCQkJLy8gdmFsdWUgdG8gdGVzdCBoYXNoY2hhbmdlLiBQYXJ0bHkgdG8gcHJldmVudCBhbGwgYXJvdW5kIHdlaXJkbmVzcwoJCQlpZiAoICEkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIHRoaXMgaXMgdGhlIHBvcHN0YXRlIHRyaWdnZXJlZCBieSB0aGUgYWN0dWFsIGFsdGVyYXRpb24gb2YgdGhlIGhhc2gKCQkJLy8gcHJldmVudCBpdCBjb21wbGV0ZWx5LiBIaXN0b3J5IGlzIHRyYWNrZWQgbWFudWFsbHkKCQkJaWYgKCB0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgKSB7CgkJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBpZiB0aGlzIGlzIHRoZSBwb3BzdGF0ZSB0cmlnZ2VyZWQgYWZ0ZXIgdGhlIGByZXBsYWNlU3RhdGVgIGNhbGwgaW4gdGhlIGdvCgkJCS8vIG1ldGhvZCwgdGhlbiBzaW1wbHkgaWdub3JlIGl0LiBUaGUgaGlzdG9yeSBlbnRyeSBoYXMgYWxyZWFkeSBiZWVuIGNhcHR1cmVkCgkJCWlmICggdGhpcy5pZ25vcmVQb3BTdGF0ZSApIHsKCQkJCXRoaXMuaWdub3JlUG9wU3RhdGUgPSBmYWxzZTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gc3RhdGUsIGFuZCB0aGUgaGlzdG9yeSBzdGFjayBsZW5ndGggaXMgb25lIHdlcmUKCQkJLy8gcHJvYmFibHkgZ2V0dGluZyB0aGUgcGFnZSBsb2FkIHBvcHN0YXRlIGZpcmVkIGJ5IGJyb3dzZXJzIGxpa2UgY2hyb21lCgkJCS8vIGF2b2lkIGl0IGFuZCBzZXQgdGhlIG9uZSB0aW1lIGZsYWcgdG8gZmFsc2UuCgkJCS8vIFRPRE86IERvIHdlIHJlYWxseSBuZWVkIGFsbCB0aGVzZSBjb25kaXRpb25zPyBDb21wYXJpbmcgbG9jYXRpb24gaHJlZnMKCQkJLy8gc2hvdWxkIGJlIHN1ZmZpY2llbnQuCgkJCWlmICggIWV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgJiYKCQkJCXRoaXMuaGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDEgJiYKCQkJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgKSB7CgkJCQl0aGlzLmlnbm9yZUluaXRpYWxIYXNoQ2hhbmdlID0gZmFsc2U7CgoJCQkJaWYgKCBsb2NhdGlvbi5ocmVmID09PSBpbml0aWFsSHJlZiApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJLy8gYWNjb3VudCBmb3IgZGlyZWN0IG1hbmlwdWxhdGlvbiBvZiB0aGUgaGFzaC4gVGhhdCBpcywgd2Ugd2lsbCByZWNlaXZlIGEgcG9wc3RhdGUKCQkJLy8gd2hlbiB0aGUgaGFzaCBpcyBjaGFuZ2VkIGJ5IGFzc2lnbm1lbnQsIGFuZCBpdCB3b24ndCBoYXZlIGEgc3RhdGUgYXNzb2NpYXRlZC4gV2UKCQkJLy8gdGhlbiBuZWVkIHRvIHNxdWFzaCB0aGUgaGFzaC4gU2VlIGJlbG93IGZvciBoYW5kbGluZyBvZiBoYXNoIGFzc2lnbm1lbnQgdGhhdAoJCQkvLyBtYXRjaGVzIGFuIGV4aXN0aW5nIGhpc3RvcnkgZW50cnkKCQkJLy8gVE9ETyBpdCBtaWdodCBiZSBiZXR0ZXIgdG8gb25seSBhZGQgdG8gdGhlIGhpc3Rvcnkgc3RhY2sKCQkJLy8gICAgICB3aGVuIHRoZSBoYXNoIGlzIGFkamFjZW50IHRvIHRoZSBhY3RpdmUgaGlzdG9yeSBlbnRyeQoJCQloYXNoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQkJaWYgKCAhZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSAmJiBoYXNoICkgewoJCQkJLy8gc3F1YXNoIHRoZSBoYXNoIHRoYXQncyBiZWVuIGFzc2lnbmVkIG9uIHRoZSBVUkwgd2l0aCByZXBsYWNlU3RhdGUKCQkJCS8vIGFsc28gZ3JhYiB0aGUgcmVzdWx0aW5nIHN0YXRlIG9iamVjdCBmb3Igc3RvcmFnZQoJCQkJc3RhdGUgPSB0aGlzLnNxdWFzaCggaGFzaCApOwoKCQkJCS8vIHJlY29yZCB0aGUgbmV3IGhhc2ggYXMgYW4gYWRkaXRpb25hbCBoaXN0b3J5IGVudHJ5CgkJCQkvLyB0byBtYXRjaCB0aGUgYnJvd3NlcidzIHRyZWF0bWVudCBvZiBoYXNoIGFzc2lnbm1lbnQKCQkJCXRoaXMuaGlzdG9yeS5hZGQoIHN0YXRlLnVybCwgc3RhdGUgKTsKCgkJCQkvLyBwYXNzIHRoZSBuZXdseSBjcmVhdGVkIHN0YXRlIGluZm9ybWF0aW9uCgkJCQkvLyBhbG9uZyB3aXRoIHRoZSBldmVudAoJCQkJZXZlbnQuaGlzdG9yeVN0YXRlID0gc3RhdGU7CgoJCQkJLy8gZG8gbm90IGFsdGVyIGhpc3RvcnksIHdlJ3ZlIGFkZGVkIGEgbmV3IGhpc3RvcnkgZW50cnkKCQkJCS8vIHNvIHdlIGtub3cgd2hlcmUgd2UgYXJlCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIGFsbCBlbHNlIGZhaWxzIHRoaXMgaXMgYSBwb3BzdGF0ZSB0aGF0IGNvbWVzIGZyb20gdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b25zCgkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHN0YXRlIG9mIG91ciBoaXN0b3J5IHN0YWNrIHByb3Blcmx5LCBhbmQgcmVjb3JkIHRoZSBkaXJlY3Rpb25hbGl0eQoJCQl0aGlzLmhpc3RvcnkuZGlyZWN0KHsKCQkJCXVybDogKGV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgfHwge30pLnVybCB8fCBoYXNoLAoKCQkJCS8vIFdoZW4gdGhlIHVybCBpcyBlaXRoZXIgZm9yd2FyZCBvciBiYWNrd2FyZCBpbiBoaXN0b3J5IGluY2x1ZGUgdGhlIGVudHJ5CgkJCQkvLyBhcyBkYXRhIG9uIHRoZSBldmVudCBvYmplY3QgZm9yIG1lcmdpbmcgYXMgZGF0YSBpbiB0aGUgbmF2aWdhdGUgZXZlbnQKCQkJCXByZXNlbnQ6IGZ1bmN0aW9uKCBoaXN0b3J5RW50cnksIGRpcmVjdGlvbiApIHsKCQkJCQkvLyBtYWtlIHN1cmUgdG8gY3JlYXRlIGEgbmV3IG9iamVjdCB0byBwYXNzIGRvd24gYXMgdGhlIG5hdmlnYXRlIGV2ZW50IGRhdGEKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUgPSAkLmV4dGVuZCh7fSwgaGlzdG9yeUVudHJ5KTsKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUuZGlyZWN0aW9uID0gZGlyZWN0aW9uOwoJCQkJfQoJCQl9KTsKCQl9LAoKCQkvLyBOT1RFIG11c3QgYmluZCBiZWZvcmUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50IGhhc2hjaGFuZ2UgYmluZGluZyBvdGhlcndpc2UgdGhlCgkJLy8gICAgICBuYXZpZ2F0aW9uIGRhdGEgd29uJ3QgYmUgYXR0YWNoZWQgdG8gdGhlIGhhc2hjaGFuZ2UgZXZlbnQgaW4gdGltZSBmb3IgdGhvc2UKCQkvLyAgICAgIGJpbmRpbmdzIHRvIGF0dGFjaCBpdCB0byB0aGUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50CgkJLy8gVE9ETyBhZGQgYSBjaGVjayBoZXJlIHRoYXQgYGhhc2hjaGFuZ2UubmF2aWdhdGVgIGlzIGJvdW5kIGFscmVhZHkgb3RoZXJ3aXNlIGl0J3MKCQkvLyAgICAgIGJyb2tlbiAoZXhjZXB0aW9uPykKCQloYXNoY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBoaXN0b3J5LCBoYXNoOwoKCQkJLy8gSWYgaGFzaGNoYW5nZSBsaXN0ZW5pbmcgaXMgZXhwbGljaXRseSBkaXNhYmxlZCBvciBwdXNoc3RhdGUgaXMgc3VwcG9ydGVkCgkJCS8vIGF2b2lkIG1ha2luZyB1c2Ugb2YgdGhlIGhhc2hjaGFuZ2UgaGFuZGxlci4KCQkJaWYgKCEkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpIHx8CgkJCQkkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIE9uIG9jY2FzaW9uIGV4cGxpY2l0bHkgd2FudCB0byBwcmV2ZW50IHRoZSBuZXh0IGhhc2ggZnJvbSBwcm9wb2dhdGluZyBiZWNhdXNlIHdlIG9ubHkKCQkJLy8gd2l0aCB0byBhbHRlciB0aGUgdXJsIHRvIHJlcHJlc2VudCB0aGUgbmV3IHN0YXRlIGRvIHNvIGhlcmUKCQkJaWYgKCB0aGlzLnByZXZlbnROZXh0SGFzaENoYW5nZSApIHsKCQkJCXRoaXMucHJldmVudE5leHRIYXNoQ2hhbmdlID0gZmFsc2U7CgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJaGlzdG9yeSA9IHRoaXMuaGlzdG9yeTsKCQkJaGFzaCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgoJCQkvLyBJZiB0aGlzIGlzIGEgaGFzaGNoYW5nZSBjYXVzZWQgYnkgdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b24KCQkJLy8gbWFrZSBzdXJlIHRvIHNldCB0aGUgc3RhdGUgb2Ygb3VyIGhpc3Rvcnkgc3RhY2sgcHJvcGVybHkKCQkJdGhpcy5oaXN0b3J5LmRpcmVjdCh7CgkJCQl1cmw6IGhhc2gsCgoJCQkJLy8gV2hlbiB0aGUgdXJsIGlzIGVpdGhlciBmb3J3YXJkIG9yIGJhY2t3YXJkIGluIGhpc3RvcnkgaW5jbHVkZSB0aGUgZW50cnkKCQkJCS8vIGFzIGRhdGEgb24gdGhlIGV2ZW50IG9iamVjdCBmb3IgbWVyZ2luZyBhcyBkYXRhIGluIHRoZSBuYXZpZ2F0ZSBldmVudAoJCQkJcHJlc2VudDogZnVuY3Rpb24oIGhpc3RvcnlFbnRyeSwgZGlyZWN0aW9uICkgewoJCQkJCS8vIG1ha2Ugc3VyZSB0byBjcmVhdGUgYSBuZXcgb2JqZWN0IHRvIHBhc3MgZG93biBhcyB0aGUgbmF2aWdhdGUgZXZlbnQgZGF0YQoJCQkJCWV2ZW50Lmhhc2hjaGFuZ2VTdGF0ZSA9ICQuZXh0ZW5kKHt9LCBoaXN0b3J5RW50cnkpOwoJCQkJCWV2ZW50Lmhhc2hjaGFuZ2VTdGF0ZS5kaXJlY3Rpb24gPSBkaXJlY3Rpb247CgkJCQl9LAoKCQkJCS8vIFdoZW4gd2UgZG9uJ3QgZmluZCBhIGhhc2ggaW4gb3VyIGhpc3RvcnkgY2xlYXJseSB3ZSdyZSBhaW1pbmcgdG8gZ28gdGhlcmUKCQkJCS8vIHJlY29yZCB0aGUgZW50cnkgYXMgbmV3IGZvciBmdXR1cmUgdHJhdmVyc2FsCgkJCQkvLwoJCQkJLy8gTk9URSBpdCdzIG5vdCBlbnRpcmVseSBjbGVhciB0aGF0IHRoaXMgaXMgdGhlIHJpZ2h0IHRoaW5nIHRvIGRvIGdpdmVuIHRoYXQgd2UKCQkJCS8vICAgICAgY2FuJ3Qga25vdyB0aGUgdXNlcnMgaW50ZW50aW9uLiBJdCBtaWdodCBiZSBiZXR0ZXIgdG8gZXhwbGljaXRseSBfbm90XwoJCQkJLy8gICAgICBzdXBwb3J0IGxvY2F0aW9uLmhhc2ggYXNzaWdubWVudCBpbiBwcmVmZXJlbmNlIHRvICQubmF2aWdhdGUgY2FsbHMKCQkJCS8vIFRPRE8gZmlyc3QgYXJnIHRvIGFkZCBzaG91bGQgYmUgdGhlIGhyZWYsIGJ1dCBpdCBjYXVzZXMgaXNzdWVzIGluIGlkZW50aWZ5aW5nCgkJCQkvLyAgICAgIGVtYmVkZWQgcGFnZXMKCQkJCW1pc3Npbmc6IGZ1bmN0aW9uKCkgewoJCQkJCWhpc3RvcnkuYWRkKCBoYXNoLCB7CgkJCQkJCWhhc2g6IGhhc2gsCgkJCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZQoJCQkJCX0pOwoJCQkJfQoJCQl9KTsKCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCS8vIFRPRE8gY29uc2lkZXIgcXVldWVpbmcgbmF2aWdhdGlvbiBhY3Rpdml0eSB1bnRpbCBwcmV2aW91cyBhY3Rpdml0aWVzIGhhdmUgY29tcGxldGVkCgkvLyAgICAgIHNvIHRoYXQgZW5kIHVzZXJzIGRvbid0IGhhdmUgdG8gdGhpbmsgYWJvdXQgaXQuIFB1bnRpbmcgZm9yIG5vdwoJLy8gVE9ETyAhISBtb3ZlIHRoZSBldmVudCBiaW5kaW5ncyBpbnRvIGNhbGxiYWNrcyBvbiB0aGUgbmF2aWdhdGUgZXZlbnQKCSQubW9iaWxlLm5hdmlnYXRlID0gZnVuY3Rpb24oIHVybCwgZGF0YSwgbm9FdmVudHMgKSB7CgkJJC5tb2JpbGUubmF2aWdhdGUubmF2aWdhdG9yLmdvKCB1cmwsIGRhdGEsIG5vRXZlbnRzICk7Cgl9OwoKCS8vIGV4cG9zZSB0aGUgaGlzdG9yeSBvbiB0aGUgbmF2aWdhdGUgbWV0aG9kIGluIGFudGljaXBhdGlvbiBvZiBmdWxsIGludGVncmF0aW9uIHdpdGgKCS8vIGV4aXN0aW5nIG5hdmlnYXRpb24gZnVuY3Rpb25hbHR5IHRoYXQgaXMgdGlnaHRseSBjb3VwbGVkIHRvIHRoZSBoaXN0b3J5IGluZm9ybWF0aW9uCgkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5ID0gbmV3ICQubW9iaWxlLkhpc3RvcnkoKTsKCgkvLyBpbnN0YW50aWF0ZSBhbiBpbnN0YW5jZSBvZiB0aGUgbmF2aWdhdG9yIGZvciB1c2Ugd2l0aGluIHRoZSAkLm5hdmlnYXRlIG1ldGhvZAoJJC5tb2JpbGUubmF2aWdhdGUubmF2aWdhdG9yID0gbmV3ICQubW9iaWxlLk5hdmlnYXRvciggJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeSApOwoKCXZhciBsb2MgPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKTsKCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuYWRkKCBsb2MuaHJlZiwge2hhc2g6IGxvYy5oYXNofSApOwp9KSggalF1ZXJ5ICk7CgoKLy8gVGhpcyBwbHVnaW4gaXMgYW4gZXhwZXJpbWVudCBmb3IgYWJzdHJhY3RpbmcgYXdheSB0aGUgdG91Y2ggYW5kIG1vdXNlCi8vIGV2ZW50cyBzbyB0aGF0IGRldmVsb3BlcnMgZG9uJ3QgaGF2ZSB0byB3b3JyeSBhYm91dCB3aGljaCBtZXRob2Qgb2YgaW5wdXQKLy8gdGhlIGRldmljZSB0aGVpciBkb2N1bWVudCBpcyBsb2FkZWQgb24gc3VwcG9ydHMuCi8vCi8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gYWxsb3cgdGhlIGRldmVsb3BlciB0byByZWdpc3RlciBsaXN0ZW5lcnMgZm9yIHRoZQovLyBiYXNpYyBtb3VzZSBldmVudHMsIHN1Y2ggYXMgbW91c2Vkb3duLCBtb3VzZW1vdmUsIG1vdXNldXAsIGFuZCBjbGljaywKLy8gYW5kIHRoZSBwbHVnaW4gd2lsbCB0YWtlIGNhcmUgb2YgcmVnaXN0ZXJpbmcgdGhlIGNvcnJlY3QgbGlzdGVuZXJzCi8vIGJlaGluZCB0aGUgc2NlbmVzIHRvIGludm9rZSB0aGUgbGlzdGVuZXIgYXQgdGhlIGZhc3Rlc3QgcG9zc2libGUgdGltZQovLyBmb3IgdGhhdCBkZXZpY2UsIHdoaWxlIHN0aWxsIHJldGFpbmluZyB0aGUgb3JkZXIgb2YgZXZlbnQgZmlyaW5nIGluCi8vIHRoZSB0cmFkaXRpb25hbCBtb3VzZSBlbnZpcm9ubWVudCwgc2hvdWxkIG11bHRpcGxlIGhhbmRsZXJzIGJlIHJlZ2lzdGVyZWQKLy8gb24gdGhlIHNhbWUgZWxlbWVudCBmb3IgZGlmZmVyZW50IGV2ZW50cy4KLy8KLy8gVGhlIGN1cnJlbnQgdmVyc2lvbiBleHBvc2VzIHRoZSBmb2xsb3dpbmcgdmlydHVhbCBldmVudHMgdG8galF1ZXJ5IGJpbmQgbWV0aG9kczoKLy8gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7Cgp2YXIgZGF0YVByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsTW91c2VCaW5kaW5ncyIsCgl0b3VjaFRhcmdldFByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsVG91Y2hJRCIsCgl2aXJ0dWFsRXZlbnROYW1lcyA9ICJ2bW91c2VvdmVyIHZtb3VzZWRvd24gdm1vdXNlbW92ZSB2bW91c2V1cCB2Y2xpY2sgdm1vdXNlb3V0IHZtb3VzZWNhbmNlbCIuc3BsaXQoICIgIiApLAoJdG91Y2hFdmVudFByb3BzID0gImNsaWVudFggY2xpZW50WSBwYWdlWCBwYWdlWSBzY3JlZW5YIHNjcmVlblkiLnNwbGl0KCAiICIgKSwKCW1vdXNlSG9va1Byb3BzID0gJC5ldmVudC5tb3VzZUhvb2tzID8gJC5ldmVudC5tb3VzZUhvb2tzLnByb3BzIDogW10sCgltb3VzZUV2ZW50UHJvcHMgPSAkLmV2ZW50LnByb3BzLmNvbmNhdCggbW91c2VIb29rUHJvcHMgKSwKCWFjdGl2ZURvY0hhbmRsZXJzID0ge30sCglyZXNldFRpbWVySUQgPSAwLAoJc3RhcnRYID0gMCwKCXN0YXJ0WSA9IDAsCglkaWRTY3JvbGwgPSBmYWxzZSwKCWNsaWNrQmxvY2tMaXN0ID0gW10sCglibG9ja01vdXNlVHJpZ2dlcnMgPSBmYWxzZSwKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlLAoJZXZlbnRDYXB0dXJlU3VwcG9ydGVkID0gImFkZEV2ZW50TGlzdGVuZXIiIGluIGRvY3VtZW50LAoJJGRvY3VtZW50ID0gJCggZG9jdW1lbnQgKSwKCW5leHRUb3VjaElEID0gMSwKCWxhc3RUb3VjaElEID0gMCwgdGhyZXNob2xkLAoJaTsKCiQudm1vdXNlID0gewoJbW92ZURpc3RhbmNlVGhyZXNob2xkOiAxMCwKCWNsaWNrRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJcmVzZXRUaW1lckR1cmF0aW9uOiAxNTAwCn07CgpmdW5jdGlvbiBnZXROYXRpdmVFdmVudCggZXZlbnQgKSB7CgoJd2hpbGUgKCBldmVudCAmJiB0eXBlb2YgZXZlbnQub3JpZ2luYWxFdmVudCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJZXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJfQoJcmV0dXJuIGV2ZW50Owp9CgpmdW5jdGlvbiBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKSB7CgoJdmFyIHQgPSBldmVudC50eXBlLAoJCW9lLCBwcm9wcywgbmUsIHByb3AsIGN0LCB0b3VjaCwgaSwgaiwgbGVuOwoKCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCWV2ZW50LnR5cGUgPSBldmVudFR5cGU7CgoJb2UgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJcHJvcHMgPSAkLmV2ZW50LnByb3BzOwoKCS8vIGFkZHJlc3NlcyBzZXBhcmF0aW9uIG9mICQuZXZlbnQucHJvcHMgaW4gdG8gJC5ldmVudC5tb3VzZUhvb2sucHJvcHMgYW5kIElzc3VlIDMyODAKCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzI4MAoJaWYgKCB0LnNlYXJjaCggL14obW91c2V8Y2xpY2spLyApID4gLTEgKSB7CgkJcHJvcHMgPSBtb3VzZUV2ZW50UHJvcHM7Cgl9CgoJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJLy8gdGhpcyB3b3VsZCBoYXBwZW4gaWYgd2UgY291bGQgY2FsbCAkLmV2ZW50LmZpeCBpbnN0ZWFkIG9mICQuRXZlbnQKCS8vIGJ1dCB3ZSBkb24ndCBoYXZlIGEgd2F5IHRvIGZvcmNlIGFuIGV2ZW50IHRvIGJlIGZpeGVkIG11bHRpcGxlIHRpbWVzCglpZiAoIG9lICkgewoJCWZvciAoIGkgPSBwcm9wcy5sZW5ndGgsIHByb3A7IGk7ICkgewoJCQlwcm9wID0gcHJvcHNbIC0taSBdOwoJCQlldmVudFsgcHJvcCBdID0gb2VbIHByb3AgXTsKCQl9Cgl9CgoJLy8gbWFrZSBzdXJlIHRoYXQgaWYgdGhlIG1vdXNlIGFuZCBjbGljayB2aXJ0dWFsIGV2ZW50cyBhcmUgZ2VuZXJhdGVkCgkvLyB3aXRob3V0IGEgLndoaWNoIG9uZSBpcyBkZWZpbmVkCglpZiAoIHQuc2VhcmNoKC9tb3VzZShkb3dufHVwKXxjbGljay8pID4gLTEgJiYgIWV2ZW50LndoaWNoICkgewoJCWV2ZW50LndoaWNoID0gMTsKCX0KCglpZiAoIHQuc2VhcmNoKC9edG91Y2gvKSAhPT0gLTEgKSB7CgkJbmUgPSBnZXROYXRpdmVFdmVudCggb2UgKTsKCQl0ID0gbmUudG91Y2hlczsKCQljdCA9IG5lLmNoYW5nZWRUb3VjaGVzOwoJCXRvdWNoID0gKCB0ICYmIHQubGVuZ3RoICkgPyB0WzBdIDogKCAoIGN0ICYmIGN0Lmxlbmd0aCApID8gY3RbIDAgXSA6IHVuZGVmaW5lZCApOwoKCQlpZiAoIHRvdWNoICkgewoJCQlmb3IgKCBqID0gMCwgbGVuID0gdG91Y2hFdmVudFByb3BzLmxlbmd0aDsgaiA8IGxlbjsgaisrKSB7CgkJCQlwcm9wID0gdG91Y2hFdmVudFByb3BzWyBqIF07CgkJCQlldmVudFsgcHJvcCBdID0gdG91Y2hbIHByb3AgXTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGVsZW1lbnQgKSB7CgoJdmFyIGZsYWdzID0ge30sCgkJYiwgazsKCgl3aGlsZSAoIGVsZW1lbnQgKSB7CgoJCWIgPSAkLmRhdGEoIGVsZW1lbnQsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJZm9yICggIGsgaW4gYiApIHsKCQkJaWYgKCBiWyBrIF0gKSB7CgkJCQlmbGFnc1sgayBdID0gZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgPSB0cnVlOwoJCQl9CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gZmxhZ3M7Cn0KCmZ1bmN0aW9uIGdldENsb3Nlc3RFbGVtZW50V2l0aFZpcnR1YWxCaW5kaW5nKCBlbGVtZW50LCBldmVudFR5cGUgKSB7Cgl2YXIgYjsKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlpZiAoIGIgJiYgKCAhZXZlbnRUeXBlIHx8IGJbIGV2ZW50VHlwZSBdICkgKSB7CgkJCXJldHVybiBlbGVtZW50OwoJCX0KCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJfQoJcmV0dXJuIG51bGw7Cn0KCmZ1bmN0aW9uIGVuYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSBmYWxzZTsKfQoKZnVuY3Rpb24gZGlzYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSB0cnVlOwp9CgpmdW5jdGlvbiBlbmFibGVNb3VzZUJpbmRpbmdzKCkgewoJbGFzdFRvdWNoSUQgPSAwOwoJY2xpY2tCbG9ja0xpc3QubGVuZ3RoID0gMDsKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlOwoKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGVuYWJsZWQsIG91cgoJLy8gdG91Y2ggYmluZGluZ3MgYXJlIGRpc2FibGVkLgoJZGlzYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gZGlzYWJsZU1vdXNlQmluZGluZ3MoKSB7CgkvLyBXaGVuIG1vdXNlIGJpbmRpbmdzIGFyZSBkaXNhYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZW5hYmxlZC4KCWVuYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gc3RhcnRSZXNldFRpbWVyKCkgewoJY2xlYXJSZXNldFRpbWVyKCk7CglyZXNldFRpbWVySUQgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQlyZXNldFRpbWVySUQgPSAwOwoJCWVuYWJsZU1vdXNlQmluZGluZ3MoKTsKCX0sICQudm1vdXNlLnJlc2V0VGltZXJEdXJhdGlvbiApOwp9CgpmdW5jdGlvbiBjbGVhclJlc2V0VGltZXIoKSB7CglpZiAoIHJlc2V0VGltZXJJRCApIHsKCQljbGVhclRpbWVvdXQoIHJlc2V0VGltZXJJRCApOwoJCXJlc2V0VGltZXJJRCA9IDA7Cgl9Cn0KCmZ1bmN0aW9uIHRyaWdnZXJWaXJ0dWFsRXZlbnQoIGV2ZW50VHlwZSwgZXZlbnQsIGZsYWdzICkgewoJdmFyIHZlOwoKCWlmICggKCBmbGFncyAmJiBmbGFnc1sgZXZlbnRUeXBlIF0gKSB8fAoJCQkJKCAhZmxhZ3MgJiYgZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGV2ZW50LnRhcmdldCwgZXZlbnRUeXBlICkgKSApIHsKCgkJdmUgPSBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKTsKCgkJJCggZXZlbnQudGFyZ2V0KS50cmlnZ2VyKCB2ZSApOwoJfQoKCXJldHVybiB2ZTsKfQoKZnVuY3Rpb24gbW91c2VFdmVudENhbGxiYWNrKCBldmVudCApIHsKCXZhciB0b3VjaElEID0gJC5kYXRhKCBldmVudC50YXJnZXQsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lICksCgkJdmU7CgoJaWYgKCAhYmxvY2tNb3VzZVRyaWdnZXJzICYmICggIWxhc3RUb3VjaElEIHx8IGxhc3RUb3VjaElEICE9PSB0b3VjaElEICkgKSB7CgkJdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidiIgKyBldmVudC50eXBlLCBldmVudCApOwoJCWlmICggdmUgKSB7CgkJCWlmICggdmUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJCWlmICggdmUuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJCWlmICggdmUuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQl9CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaFN0YXJ0KCBldmVudCApIHsKCgl2YXIgdG91Y2hlcyA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXMsCgkJdGFyZ2V0LCBmbGFncywgdDsKCglpZiAoIHRvdWNoZXMgJiYgdG91Y2hlcy5sZW5ndGggPT09IDEgKSB7CgoJCXRhcmdldCA9IGV2ZW50LnRhcmdldDsKCQlmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIHRhcmdldCApOwoKCQlpZiAoIGZsYWdzLmhhc1ZpcnR1YWxCaW5kaW5nICkgewoKCQkJbGFzdFRvdWNoSUQgPSBuZXh0VG91Y2hJRCsrOwoJCQkkLmRhdGEoIHRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUsIGxhc3RUb3VjaElEICk7CgoJCQljbGVhclJlc2V0VGltZXIoKTsKCgkJCWRpc2FibGVNb3VzZUJpbmRpbmdzKCk7CgkJCWRpZFNjcm9sbCA9IGZhbHNlOwoKCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXNbIDAgXTsKCQkJc3RhcnRYID0gdC5wYWdlWDsKCQkJc3RhcnRZID0gdC5wYWdlWTsKCgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VvdmVyIiwgZXZlbnQsIGZsYWdzICk7CgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vkb3duIiwgZXZlbnQsIGZsYWdzICk7CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVTY3JvbGwoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggIWRpZFNjcm9sbCApIHsKCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlY2FuY2VsIiwgZXZlbnQsIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApICk7Cgl9CgoJZGlkU2Nyb2xsID0gdHJ1ZTsKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaE1vdmUoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciB0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdLAoJCWRpZENhbmNlbCA9IGRpZFNjcm9sbCwKCQltb3ZlVGhyZXNob2xkID0gJC52bW91c2UubW92ZURpc3RhbmNlVGhyZXNob2xkLAoJCWZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICk7CgoJCWRpZFNjcm9sbCA9IGRpZFNjcm9sbCB8fAoJCQkoIE1hdGguYWJzKCB0LnBhZ2VYIC0gc3RhcnRYICkgPiBtb3ZlVGhyZXNob2xkIHx8CgkJCQlNYXRoLmFicyggdC5wYWdlWSAtIHN0YXJ0WSApID4gbW92ZVRocmVzaG9sZCApOwoKCWlmICggZGlkU2Nyb2xsICYmICFkaWRDYW5jZWwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBmbGFncyApOwoJfQoKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vtb3ZlIiwgZXZlbnQsIGZsYWdzICk7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7CgoJdmFyIGZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICksCgkJdmUsIHQ7Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNldXAiLCBldmVudCwgZmxhZ3MgKTsKCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidmNsaWNrIiwgZXZlbnQsIGZsYWdzICk7CgkJaWYgKCB2ZSAmJiB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJLy8gVGhlIHRhcmdldCBvZiB0aGUgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IHRoZSB0b3VjaGVuZAoJCQkvLyBldmVudCBkb24ndCBuZWNlc3NhcmlseSBtYXRjaCB0aGUgdGFyZ2V0IHVzZWQgZHVyaW5nIHRoZQoJCQkvLyB0b3VjaC4gVGhpcyBtZWFucyB3ZSBuZWVkIHRvIHJlbHkgb24gY29vcmRpbmF0ZXMgZm9yIGJsb2NraW5nCgkJCS8vIGFueSBjbGljayB0aGF0IGlzIGdlbmVyYXRlZC4KCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLmNoYW5nZWRUb3VjaGVzWyAwIF07CgkJCWNsaWNrQmxvY2tMaXN0LnB1c2goewoJCQkJdG91Y2hJRDogbGFzdFRvdWNoSUQsCgkJCQl4OiB0LmNsaWVudFgsCgkJCQl5OiB0LmNsaWVudFkKCQkJfSk7CgoJCQkvLyBQcmV2ZW50IGFueSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgZnJvbSB0cmlnZ2VyaW5nCgkJCS8vIHZpcnR1YWwgZXZlbnQgbm90aWZpY2F0aW9ucy4KCQkJYmxvY2tNb3VzZVRyaWdnZXJzID0gdHJ1ZTsKCQl9Cgl9Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3V0IiwgZXZlbnQsIGZsYWdzKTsKCWRpZFNjcm9sbCA9IGZhbHNlOwoKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYXNWaXJ0dWFsQmluZGluZ3MoIGVsZSApIHsKCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggZWxlLCBkYXRhUHJvcGVydHlOYW1lICksCgkJazsKCglpZiAoIGJpbmRpbmdzICkgewoJCWZvciAoIGsgaW4gYmluZGluZ3MgKSB7CgkJCWlmICggYmluZGluZ3NbIGsgXSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoJfQoJcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBkdW1teU1vdXNlSGFuZGxlcigpIHt9CgpmdW5jdGlvbiBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIGV2ZW50VHlwZSApIHsKCXZhciByZWFsVHlwZSA9IGV2ZW50VHlwZS5zdWJzdHIoIDEgKTsKCglyZXR1cm4gewoJCXNldHVwOiBmdW5jdGlvbigvKiBkYXRhLCBuYW1lc3BhY2UgKi8pIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGZvciB0aGlzIGVsZW1lbnQsCgkJCS8vIGFkZCBhIGJpbmRpbmdzIG9iamVjdCB0byBpdHMgZGF0YS4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lLCB7fSApOwoJCQl9CgoJCQkvLyBJZiBzZXR1cCBpcyBjYWxsZWQsIHdlIGtub3cgaXQgaXMgdGhlIGZpcnN0IGJpbmRpbmcgZm9yIHRoaXMKCQkJLy8gZXZlbnRUeXBlLCBzbyBpbml0aWFsaXplIHRoZSBjb3VudCBmb3IgdGhlIGV2ZW50VHlwZSB0byB6ZXJvLgoJCQl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gdHJ1ZTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgZXZlbnQgZm9yIHRoaXMgdHlwZSwKCQkJLy8gcmVnaXN0ZXIgYSBnbG9iYWwgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQlhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSB8fCAwICkgKyAxOwoKCQkJaWYgKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPT09IDEgKSB7CgkJCQkkZG9jdW1lbnQuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQkvLyBTb21lIGJyb3dzZXJzLCBsaWtlIE9wZXJhIE1pbmksIHdvbid0IGRpc3BhdGNoIG1vdXNlL2NsaWNrIGV2ZW50cwoJCQkvLyBmb3IgZWxlbWVudHMgdW5sZXNzIHRoZXkgYWN0dWFsbHkgaGF2ZSBoYW5kbGVycyByZWdpc3RlcmVkIG9uIHRoZW0uCgkJCS8vIFRvIGdldCBhcm91bmQgdGhpcywgd2UgcmVnaXN0ZXIgZHVtbXkgaGFuZGxlcnMgb24gdGhlIGVsZW1lbnRzLgoKCQkJJCggdGhpcyApLmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gRm9yIG5vdywgaWYgZXZlbnQgY2FwdHVyZSBpcyBub3Qgc3VwcG9ydGVkLCB3ZSByZWx5IG9uIG1vdXNlIGhhbmRsZXJzLgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhlIGRvY3VtZW50LAoJCQkJLy8gcmVnaXN0ZXIgb3VyIHRvdWNoc3RhcnQgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQkJYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gfHwgMCkgKyAxOwoKCQkJCWlmICggYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID09PSAxICkgewoJCQkJCSRkb2N1bWVudC5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoKCQkJCQkJLy8gT24gdG91Y2ggcGxhdGZvcm1zLCB0b3VjaGluZyB0aGUgc2NyZWVuIGFuZCB0aGVuIGRyYWdnaW5nIHlvdXIgZmluZ2VyCgkJCQkJCS8vIGNhdXNlcyB0aGUgd2luZG93IGNvbnRlbnQgdG8gc2Nyb2xsIGFmdGVyIHNvbWUgZGlzdGFuY2UgdGhyZXNob2xkIGlzCgkJCQkJCS8vIGV4Y2VlZGVkLiBPbiB0aGVzZSBwbGF0Zm9ybXMsIGEgc2Nyb2xsIHByZXZlbnRzIGEgY2xpY2sgZXZlbnQgZnJvbSBiZWluZwoJCQkJCQkvLyBkaXNwYXRjaGVkLCBhbmQgb24gc29tZSBwbGF0Zm9ybXMsIGV2ZW4gdGhlIHRvdWNoZW5kIGlzIHN1cHByZXNzZWQuIFRvCgkJCQkJCS8vIG1pbWljIHRoZSBzdXBwcmVzc2lvbiBvZiB0aGUgY2xpY2sgZXZlbnQsIHdlIG5lZWQgdG8gd2F0Y2ggZm9yIGEgc2Nyb2xsCgkJCQkJCS8vIGV2ZW50LiBVbmZvcnR1bmF0ZWx5LCBzb21lIHBsYXRmb3JtcyBsaWtlIGlPUyBkb24ndCBkaXNwYXRjaCBzY3JvbGwKCQkJCQkJLy8gZXZlbnRzIHVudGlsICpBRlRFUiogdGhlIHVzZXIgbGlmdHMgdGhlaXIgZmluZ2VyICh0b3VjaGVuZCkuIFRoaXMgbWVhbnMKCQkJCQkJLy8gd2UgbmVlZCB0byB3YXRjaCBib3RoIHNjcm9sbCBhbmQgdG91Y2htb3ZlIGV2ZW50cyB0byBmaWd1cmUgb3V0IHdoZXRoZXIKCQkJCQkJLy8gb3Igbm90IGEgc2Nyb2xsIGhhcHBlbmVucyBiZWZvcmUgdGhlIHRvdWNoZW5kIGV2ZW50IGlzIGZpcmVkLgoKCQkJCQkJLmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkuYmluZCggInNjcm9sbCIsIGhhbmRsZVNjcm9sbCApOwoJCQkJfQoJCQl9CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKC8qIGRhdGEsIG5hbWVzcGFjZSAqLykgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgYmluZGluZyBmb3IgdGhpcyBldmVudFR5cGUsCgkJCS8vIHJlbW92ZSBpdHMgZ2xvYmFsIGhhbmRsZXIgZnJvbSB0aGUgZG9jdW1lbnQuCgoJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXTsKCgkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSApIHsKCQkJCSRkb2N1bWVudC51bmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBpbiBleGlzdGVuY2UsCgkJCQkvLyByZW1vdmUgb3VyIGRvY3VtZW50IHRvdWNoc3RhcnQgbGlzdGVuZXIuCgoJCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF07CgoJCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdICkgewoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS51bmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkudW5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgkJCQkJCS51bmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJCS8vIHRlYXJkb3duIG1heSBiZSBjYWxsZWQgd2hlbiBhbiBlbGVtZW50IHdhcwoJCQkvLyByZW1vdmVkIGZyb20gdGhlIERPTS4gSWYgdGhpcyBpcyB0aGUgY2FzZSwKCQkJLy8galF1ZXJ5IGNvcmUgbWF5IGhhdmUgYWxyZWFkeSBzdHJpcHBlZCB0aGUgZWxlbWVudAoJCQkvLyBvZiBhbnkgZGF0YSBiaW5kaW5ncyBzbyB3ZSBuZWVkIHRvIGNoZWNrIGl0IGJlZm9yZQoJCQkvLyB1c2luZyBpdC4KCQkJaWYgKCBiaW5kaW5ncyApIHsKCQkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IGZhbHNlOwoJCQl9CgoJCQkvLyBVbnJlZ2lzdGVyIHRoZSBkdW1teSBldmVudCBoYW5kbGVyLgoKCQkJJHRoaXMudW5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIG9uIHRoZQoJCQkvLyBlbGVtZW50LCByZW1vdmUgdGhlIGJpbmRpbmcgZGF0YSBmcm9tIHRoZSBlbGVtZW50LgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkdGhpcy5yZW1vdmVEYXRhKCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCX0KCQl9Cgl9Owp9CgovLyBFeHBvc2Ugb3VyIGN1c3RvbSBldmVudHMgdG8gdGhlIGpRdWVyeSBiaW5kL3VuYmluZCBtZWNoYW5pc20uCgpmb3IgKCBpID0gMDsgaSA8IHZpcnR1YWxFdmVudE5hbWVzLmxlbmd0aDsgaSsrICkgewoJJC5ldmVudC5zcGVjaWFsWyB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdIF0gPSBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gKTsKfQoKLy8gQWRkIGEgY2FwdHVyZSBjbGljayBoYW5kbGVyIHRvIGJsb2NrIGNsaWNrcy4KLy8gTm90ZSB0aGF0IHdlIHJlcXVpcmUgZXZlbnQgY2FwdHVyZSBzdXBwb3J0IGZvciB0aGlzIHNvIGlmIHRoZSBkZXZpY2UKLy8gZG9lc24ndCBzdXBwb3J0IGl0LCB3ZSBwdW50IGZvciBub3cgYW5kIHJlbHkgc29sZWx5IG9uIG1vdXNlIGV2ZW50cy4KaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7Cglkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQl2YXIgY250ID0gY2xpY2tCbG9ja0xpc3QubGVuZ3RoLAoJCQl0YXJnZXQgPSBlLnRhcmdldCwKCQkJeCwgeSwgZWxlLCBpLCBvLCB0b3VjaElEOwoKCQlpZiAoIGNudCApIHsKCQkJeCA9IGUuY2xpZW50WDsKCQkJeSA9IGUuY2xpZW50WTsKCQkJdGhyZXNob2xkID0gJC52bW91c2UuY2xpY2tEaXN0YW5jZVRocmVzaG9sZDsKCgkJCS8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gcnVuIHRocm91Z2ggdGhlIGNsaWNrQmxvY2tMaXN0IHRvIHNlZSBpZgoJCQkvLyB0aGUgY3VycmVudCBjbGljayBldmVudCBpcyBpbiB0aGUgcHJveGltaXR5IG9mIG9uZSBvZiBvdXIKCQkJLy8gdmNsaWNrIGV2ZW50cyB0aGF0IGhhZCBwcmV2ZW50RGVmYXVsdCgpIGNhbGxlZCBvbiBpdC4gSWYgd2UgZmluZAoJCQkvLyBvbmUsIHRoZW4gd2UgYmxvY2sgdGhlIGNsaWNrLgoJCQkvLwoJCQkvLyBXaHkgZG8gd2UgaGF2ZSB0byByZWx5IG9uIHByb3hpbWl0eT8KCQkJLy8KCQkJLy8gQmVjYXVzZSB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaCBldmVudCB0aGF0IHRyaWdnZXJlZCB0aGUgdmNsaWNrCgkJCS8vIGNhbiBiZSBkaWZmZXJlbnQgZnJvbSB0aGUgdGFyZ2V0IG9mIHRoZSBjbGljayBldmVudCBzeW50aGVzaXplZAoJCQkvLyBieSB0aGUgYnJvd3Nlci4gVGhlIHRhcmdldCBvZiBhIG1vdXNlL2NsaWNrIGV2ZW50IHRoYXQgaXMgc3ludGhlc2l6ZWQKCQkJLy8gZnJvbSBhIHRvdWNoIGV2ZW50IHNlZW1zIHRvIGJlIGltcGxlbWVudGF0aW9uIHNwZWNpZmljLiBGb3IgZXhhbXBsZSwKCQkJLy8gc29tZSBicm93c2VycyB3aWxsIGZpcmUgbW91c2UvY2xpY2sgZXZlbnRzIGZvciBhIGxpbmsgdGhhdCBpcyBuZWFyCgkJCS8vIGEgdG91Y2ggZXZlbnQsIGV2ZW4gdGhvdWdoIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoc3RhcnQvdG91Y2hlbmQgZXZlbnQKCQkJLy8gc2F5cyB0aGUgdXNlciB0b3VjaGVkIG91dHNpZGUgdGhlIGxpbmsuIEFsc28sIGl0IHNlZW1zIHRoYXQgd2l0aCBtb3N0CgkJCS8vIGJyb3dzZXJzLCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayBldmVudCBpcyBub3QgY2FsY3VsYXRlZCB1bnRpbCB0aGUKCQkJLy8gdGltZSBpdCBpcyBkaXNwYXRjaGVkLCBzbyBpZiB5b3UgcmVwbGFjZSBhbiBlbGVtZW50IHRoYXQgeW91IHRvdWNoZWQKCQkJLy8gd2l0aCBhbm90aGVyIGVsZW1lbnQsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIHdpbGwgYmUgdGhlIG5ldwoJCQkvLyBlbGVtZW50IHVuZGVybmVhdGggdGhhdCBwb2ludC4KCQkJLy8KCQkJLy8gQXNpZGUgZnJvbSBwcm94aW1pdHksIHdlIGFsc28gY2hlY2sgdG8gc2VlIGlmIHRoZSB0YXJnZXQgYW5kIGFueQoJCQkvLyBvZiBpdHMgYW5jZXN0b3JzIHdlcmUgdGhlIG9uZXMgdGhhdCBibG9ja2VkIGEgY2xpY2suIFRoaXMgaXMgbmVjZXNzYXJ5CgkJCS8vIGJlY2F1c2Ugb2YgdGhlIHN0cmFuZ2UgbW91c2UvY2xpY2sgdGFyZ2V0IGNhbGN1bGF0aW9uIGRvbmUgaW4gdGhlCgkJCS8vIEFuZHJvaWQgMi4xIGJyb3dzZXIsIHdoZXJlIGlmIHlvdSBjbGljayBvbiBhbiBlbGVtZW50LCBhbmQgdGhlcmUgaXMgYQoJCQkvLyBtb3VzZS9jbGljayBoYW5kbGVyIG9uIG9uZSBvZiBpdHMgYW5jZXN0b3JzLCB0aGUgdGFyZ2V0IHdpbGwgYmUgdGhlCgkJCS8vIGlubmVybW9zdCBjaGlsZCBvZiB0aGUgdG91Y2hlZCBlbGVtZW50LCBldmVuIGlmIHRoYXQgY2hpbGQgaXMgbm8gd2hlcmUKCQkJLy8gbmVhciB0aGUgcG9pbnQgb2YgdG91Y2guCgoJCQllbGUgPSB0YXJnZXQ7CgoJCQl3aGlsZSAoIGVsZSApIHsKCQkJCWZvciAoIGkgPSAwOyBpIDwgY250OyBpKysgKSB7CgkJCQkJbyA9IGNsaWNrQmxvY2tMaXN0WyBpIF07CgkJCQkJdG91Y2hJRCA9IDA7CgoJCQkJCWlmICggKCBlbGUgPT09IHRhcmdldCAmJiBNYXRoLmFicyggby54IC0geCApIDwgdGhyZXNob2xkICYmIE1hdGguYWJzKCBvLnkgLSB5ICkgPCB0aHJlc2hvbGQgKSB8fAoJCQkJCQkJCSQuZGF0YSggZWxlLCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSApID09PSBvLnRvdWNoSUQgKSB7CgkJCQkJCS8vIFhYWDogV2UgbWF5IHdhbnQgdG8gY29uc2lkZXIgcmVtb3ZpbmcgbWF0Y2hlcyBmcm9tIHRoZSBibG9jayBsaXN0CgkJCQkJCS8vICAgICAgaW5zdGVhZCBvZiB3YWl0aW5nIGZvciB0aGUgcmVzZXQgdGltZXIgdG8gZmlyZS4KCQkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJfQoJCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJCX0KCQl9Cgl9LCB0cnVlKTsKfQp9KSggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhciAkZG9jdW1lbnQgPSAkKCBkb2N1bWVudCApLAoJCXN1cHBvcnRUb3VjaCA9ICQubW9iaWxlLnN1cHBvcnQudG91Y2gsCgkJc2Nyb2xsRXZlbnQgPSAidG91Y2htb3ZlIHNjcm9sbCIsCgkJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgkJdG91Y2hTdG9wRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hlbmQiIDogIm1vdXNldXAiLAoJCXRvdWNoTW92ZUV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNobW92ZSIgOiAibW91c2Vtb3ZlIjsKCgkvLyBzZXR1cCBuZXcgZXZlbnQgc2hvcnRjdXRzCgkkLmVhY2goICggInRvdWNoc3RhcnQgdG91Y2htb3ZlIHRvdWNoZW5kICIgKwoJCSJ0YXAgdGFwaG9sZCAiICsKCQkic3dpcGUgc3dpcGVsZWZ0IHN3aXBlcmlnaHQgIiArCgkJInNjcm9sbHN0YXJ0IHNjcm9sbHN0b3AiICkuc3BsaXQoICIgIiApLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgkJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCQlyZXR1cm4gZm4gPyB0aGlzLmJpbmQoIG5hbWUsIGZuICkgOiB0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCQl9OwoKCQkvLyBqUXVlcnkgPCAxLjgKCQlpZiAoICQuYXR0ckZuICkgewoJCQkkLmF0dHJGblsgbmFtZSBdID0gdHJ1ZTsKCQl9Cgl9KTsKCglmdW5jdGlvbiB0cmlnZ2VyQ3VzdG9tRXZlbnQoIG9iaiwgZXZlbnRUeXBlLCBldmVudCApIHsKCQl2YXIgb3JpZ2luYWxUeXBlID0gZXZlbnQudHlwZTsKCQlldmVudC50eXBlID0gZXZlbnRUeXBlOwoJCSQuZXZlbnQuZGlzcGF0Y2guY2FsbCggb2JqLCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSBvcmlnaW5hbFR5cGU7Cgl9CgoJLy8gYWxzbyBoYW5kbGVzIHNjcm9sbHN0b3AKCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydCA9IHsKCgkJZW5hYmxlZDogdHJ1ZSwKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKSwKCQkJCXNjcm9sbGluZywKCQkJCXRpbWVyOwoKCQkJZnVuY3Rpb24gdHJpZ2dlciggZXZlbnQsIHN0YXRlICkgewoJCQkJc2Nyb2xsaW5nID0gc3RhdGU7CgkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsIHNjcm9sbGluZyA/ICJzY3JvbGxzdGFydCIgOiAic2Nyb2xsc3RvcCIsIGV2ZW50ICk7CgkJCX0KCgkJCS8vIGlQaG9uZSB0cmlnZ2VycyBzY3JvbGwgYWZ0ZXIgYSBzbWFsbCBkZWxheTsgdXNlIHRvdWNobW92ZSBpbnN0ZWFkCgkJCSR0aGlzLmJpbmQoIHNjcm9sbEV2ZW50LCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICggIXNjcm9sbGluZyApIHsKCQkJCQl0cmlnZ2VyKCBldmVudCwgdHJ1ZSApOwoJCQkJfQoKCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCXRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlciggZXZlbnQsIGZhbHNlICk7CgkJCQl9LCA1MCApOwoJCQl9KTsKCQl9LAoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJJCggdGhpcyApLnVuYmluZCggc2Nyb2xsRXZlbnQgKTsKCQl9Cgl9OwoKCS8vIGFsc28gaGFuZGxlcyB0YXBob2xkCgkkLmV2ZW50LnNwZWNpYWwudGFwID0gewoJCXRhcGhvbGRUaHJlc2hvbGQ6IDc1MCwKCQllbWl0VGFwT25UYXBob2xkOiB0cnVlLAoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICksCgkJCQlpc1RhcGhvbGQgPSBmYWxzZTsKCgkJCSR0aGlzLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaXNUYXBob2xkID0gZmFsc2U7CgkJCQlpZiAoIGV2ZW50LndoaWNoICYmIGV2ZW50LndoaWNoICE9PSAxICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQl2YXIgb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQl0aW1lcjsKCgkJCQlmdW5jdGlvbiBjbGVhclRhcFRpbWVyKCkgewoJCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCX0KCgkJCQlmdW5jdGlvbiBjbGVhclRhcEhhbmRsZXJzKCkgewoJCQkJCWNsZWFyVGFwVGltZXIoKTsKCgkJCQkJJHRoaXMudW5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICkKCQkJCQkJLnVuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApOwoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgkJCQl9CgoJCQkJZnVuY3Rpb24gY2xpY2tIYW5kbGVyKCBldmVudCApIHsKCQkJCQljbGVhclRhcEhhbmRsZXJzKCk7CgoJCQkJCS8vIE9OTFkgdHJpZ2dlciBhICd0YXAnIGV2ZW50IGlmIHRoZSBzdGFydCB0YXJnZXQgaXMKCQkJCQkvLyB0aGUgc2FtZSBhcyB0aGUgc3RvcCB0YXJnZXQuCgkJCQkJaWYgKCAhaXNUYXBob2xkICYmIG9yaWdUYXJnZXQgPT09IGV2ZW50LnRhcmdldCApIHsKCQkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwIiwgZXZlbnQgKTsKCQkJCQl9IGVsc2UgaWYgKCBpc1RhcGhvbGQgKSB7CgkJCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCX0KCQkJCX0KCgkJCQkkdGhpcy5iaW5kKCAidm1vdXNldXAiLCBjbGVhclRhcFRpbWVyICkKCQkJCQkuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApOwoJCQkJJGRvY3VtZW50LmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgoJCQkJdGltZXIgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQlpZiAoICEkLmV2ZW50LnNwZWNpYWwudGFwLmVtaXRUYXBPblRhcGhvbGQgKSB7CgkJCQkJCWlzVGFwaG9sZCA9IHRydWU7CgkJCQkJfQoJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcGhvbGQiLCAkLkV2ZW50KCAidGFwaG9sZCIsIHsgdGFyZ2V0OiBvcmlnVGFyZ2V0IH0gKSApOwoJCQkJfSwgJC5ldmVudC5zcGVjaWFsLnRhcC50YXBob2xkVGhyZXNob2xkICk7CgkJCX0pOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkudW5iaW5kKCAidm1vdXNlZG93biIgKS51bmJpbmQoICJ2Y2xpY2siICkudW5iaW5kKCAidm1vdXNldXAiICk7CgkJCSRkb2N1bWVudC51bmJpbmQoICJ2bW91c2VjYW5jZWwiICk7CgkJfQoJfTsKCgkvLyBhbHNvIGhhbmRsZXMgc3dpcGVsZWZ0LCBzd2lwZXJpZ2h0CgkkLmV2ZW50LnNwZWNpYWwuc3dpcGUgPSB7CgkJc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZDogMzAsIC8vIE1vcmUgdGhhbiB0aGlzIGhvcml6b250YWwgZGlzcGxhY2VtZW50LCBhbmQgd2Ugd2lsbCBzdXBwcmVzcyBzY3JvbGxpbmcuCgoJCWR1cmF0aW9uVGhyZXNob2xkOiAxMDAwLCAvLyBNb3JlIHRpbWUgdGhhbiB0aGlzLCBhbmQgaXQgaXNuJ3QgYSBzd2lwZS4KCgkJaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkOiAzMCwgIC8vIFN3aXBlIGhvcml6b250YWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbW9yZSB0aGFuIHRoaXMuCgoJCXZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQ6IDc1LCAgLy8gU3dpcGUgdmVydGljYWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbGVzcyB0aGFuIHRoaXMuCgoJCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50OwoJCQlyZXR1cm4gewoJCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJCWNvb3JkczogWyBkYXRhLnBhZ2VYLCBkYXRhLnBhZ2VZIF0sCgkJCQkJCW9yaWdpbjogJCggZXZlbnQudGFyZ2V0ICkKCQkJCQl9OwoJCX0sCgoJCXN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGRhdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgPwoJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1sgMCBdIDogZXZlbnQ7CgkJCXJldHVybiB7CgkJCQkJCXRpbWU6ICggbmV3IERhdGUoKSApLmdldFRpbWUoKSwKCQkJCQkJY29vcmRzOiBbIGRhdGEucGFnZVgsIGRhdGEucGFnZVkgXQoJCQkJCX07CgkJfSwKCgkJaGFuZGxlU3dpcGU6IGZ1bmN0aW9uKCBzdGFydCwgc3RvcCwgdGhpc09iamVjdCwgb3JpZ1RhcmdldCApIHsKCQkJaWYgKCBzdG9wLnRpbWUgLSBzdGFydC50aW1lIDwgJC5ldmVudC5zcGVjaWFsLnN3aXBlLmR1cmF0aW9uVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAwIF0gLSBzdG9wLmNvb3Jkc1sgMCBdICkgPiAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAxIF0gLSBzdG9wLmNvb3Jkc1sgMSBdICkgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUudmVydGljYWxEaXN0YW5jZVRocmVzaG9sZCApIHsKCQkJCXZhciBkaXJlY3Rpb24gPSBzdGFydC5jb29yZHNbMF0gPiBzdG9wLmNvb3Jkc1sgMCBdID8gInN3aXBlbGVmdCIgOiAic3dpcGVyaWdodCI7CgoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAic3dpcGUiLCAkLkV2ZW50KCAic3dpcGUiLCB7IHRhcmdldDogb3JpZ1RhcmdldCwgc3dpcGVzdGFydDogc3RhcnQsIHN3aXBlc3RvcDogc3RvcCB9KSApOwoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCBkaXJlY3Rpb24sJC5FdmVudCggZGlyZWN0aW9uLCB7IHRhcmdldDogb3JpZ1RhcmdldCwgc3dpcGVzdGFydDogc3RhcnQsIHN3aXBlc3RvcDogc3RvcCB9ICkgKTsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJCXJldHVybiBmYWxzZTsKCgkJfSwKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKTsKCgkJCSR0aGlzLmJpbmQoIHRvdWNoU3RhcnRFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdmFyIHN0b3AsCgkJCQkJc3RhcnQgPSAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuc3RhcnQoIGV2ZW50ICksCgkJCQkJb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQllbWl0dGVkID0gZmFsc2U7CgoJCQkJZnVuY3Rpb24gbW92ZUhhbmRsZXIoIGV2ZW50ICkgewoJCQkJCWlmICggIXN0YXJ0ICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQlzdG9wID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnN0b3AoIGV2ZW50ICk7CgkJCQkJaWYgKCAhZW1pdHRlZCApIHsKCQkJCQkJZW1pdHRlZCA9ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5oYW5kbGVTd2lwZSggc3RhcnQsIHN0b3AsIHRoaXNPYmplY3QsIG9yaWdUYXJnZXQgKTsKCQkJCQl9CgkJCQkJLy8gcHJldmVudCBzY3JvbGxpbmcKCQkJCQlpZiAoIE1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5zY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkICkgewoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCX0KCQkJCX0KCgkJCQkkdGhpcy5iaW5kKCB0b3VjaE1vdmVFdmVudCwgbW92ZUhhbmRsZXIgKQoJCQkJCS5vbmUoIHRvdWNoU3RvcEV2ZW50LCBmdW5jdGlvbigpIHsKCQkJCQkJZW1pdHRlZCA9IHRydWU7CgkJCQkJCSR0aGlzLnVuYmluZCggdG91Y2hNb3ZlRXZlbnQsIG1vdmVIYW5kbGVyICk7CgkJCQl9KTsKCQkJfSk7CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkudW5iaW5kKCB0b3VjaFN0YXJ0RXZlbnQgKS51bmJpbmQoIHRvdWNoTW92ZUV2ZW50ICkudW5iaW5kKCB0b3VjaFN0b3BFdmVudCApOwoJCX0KCX07CgkkLmVhY2goewoJCXNjcm9sbHN0b3A6ICJzY3JvbGxzdGFydCIsCgkJdGFwaG9sZDogInRhcCIsCgkJc3dpcGVsZWZ0OiAic3dpcGUiLAoJCXN3aXBlcmlnaHQ6ICJzd2lwZSIKCX0sIGZ1bmN0aW9uKCBldmVudCwgc291cmNlRXZlbnQgKSB7CgoJCSQuZXZlbnQuc3BlY2lhbFsgZXZlbnQgXSA9IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmJpbmQoIHNvdXJjZUV2ZW50LCAkLm5vb3AgKTsKCQkJfSwKCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLnVuYmluZCggc291cmNlRXZlbnQgKTsKCQkJfQoJCX07Cgl9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCgoJLy8gdGhyb3R0bGVkIHJlc2l6ZSBldmVudAoJKGZ1bmN0aW9uKCAkICkgewoJCSQuZXZlbnQuc3BlY2lhbC50aHJvdHRsZWRyZXNpemUgPSB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCQl9LAoJCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkudW5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCQl9CgkJfTsKCgkJdmFyIHRocm90dGxlID0gMjUwLAoJCQloYW5kbGVyID0gZnVuY3Rpb24oKSB7CgkJCQljdXJyID0gKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpOwoJCQkJZGlmZiA9IGN1cnIgLSBsYXN0Q2FsbDsKCgkJCQlpZiAoIGRpZmYgPj0gdGhyb3R0bGUgKSB7CgoJCQkJCWxhc3RDYWxsID0gY3VycjsKCQkJCQkkKCB0aGlzICkudHJpZ2dlciggInRocm90dGxlZHJlc2l6ZSIgKTsKCgkJCQl9IGVsc2UgewoKCQkJCQlpZiAoIGhlbGRDYWxsICkgewoJCQkJCQljbGVhclRpbWVvdXQoIGhlbGRDYWxsICk7CgkJCQkJfQoKCQkJCQkvLyBQcm9taXNlIGEgaGVsZCBjYWxsIHdpbGwgc3RpbGwgZXhlY3V0ZQoJCQkJCWhlbGRDYWxsID0gc2V0VGltZW91dCggaGFuZGxlciwgdGhyb3R0bGUgLSBkaWZmICk7CgkJCQl9CgkJCX0sCgkJCWxhc3RDYWxsID0gMCwKCQkJaGVsZENhbGwsCgkJCWN1cnIsCgkJCWRpZmY7Cgl9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7Cgl2YXIgd2luID0gJCggd2luZG93ICksCgkJZXZlbnRfbmFtZSA9ICJvcmllbnRhdGlvbmNoYW5nZSIsCgkJZ2V0X29yaWVudGF0aW9uLAoJCWxhc3Rfb3JpZW50YXRpb24sCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUsCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0LAoJCXBvcnRyYWl0X21hcCA9IHsgIjAiOiB0cnVlLCAiMTgwIjogdHJ1ZSB9LAoJCXd3LCB3aCwgbGFuZHNjYXBlX3RocmVzaG9sZDsKCgkvLyBJdCBzZWVtcyB0aGF0IHNvbWUgZGV2aWNlL2Jyb3dzZXIgdmVuZG9ycyB1c2Ugd2luZG93Lm9yaWVudGF0aW9uIHZhbHVlcyAwIGFuZCAxODAgdG8KCS8vIGRlbm90ZSB0aGUgImRlZmF1bHQiIG9yaWVudGF0aW9uLiBGb3IgaU9TIGRldmljZXMsIGFuZCBtb3N0IG90aGVyIHNtYXJ0LXBob25lcyB0ZXN0ZWQsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyBhbHdheXMgInBvcnRyYWl0IiwgYnV0IGluIHNvbWUgQW5kcm9pZCBhbmQgUklNIGJhc2VkIHRhYmxldHMsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyAibGFuZHNjYXBlIi4gVGhlIGZvbGxvd2luZyBjb2RlIGF0dGVtcHRzIHRvIHVzZSB0aGUgd2luZG93CgkvLyBkaW1lbnNpb25zIHRvIGZpZ3VyZSBvdXQgd2hhdCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiBpcywgYW5kIHRoZW4gbWFrZXMgYWRqdXN0bWVudHMKCS8vIHRvIHRoZSB0byB0aGUgcG9ydHJhaXRfbWFwIGlmIG5lY2Vzc2FyeSwgc28gdGhhdCB3ZSBjYW4gcHJvcGVybHkgZGVjb2RlIHRoZQoJLy8gd2luZG93Lm9yaWVudGF0aW9uIHZhbHVlIHdoZW5ldmVyIGdldF9vcmllbnRhdGlvbigpIGlzIGNhbGxlZC4KCS8vCgkvLyBOb3RlIHRoYXQgd2UgdXNlZCB0byB1c2UgYSBtZWRpYSBxdWVyeSB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIG9yaWVudGF0aW9uIHRoZSBicm93c2VyCgkvLyB0aGlua3MgaXQgaXMgaW46CgkvLwoJLy8gICAgIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlID0gJC5tb2JpbGUubWVkaWEoImFsbCBhbmQgKG9yaWVudGF0aW9uOiBsYW5kc2NhcGUpIik7CgkvLwoJLy8gYnV0IHRoZXJlIHdhcyBhbiBpUGhvbmUvaVBvZCBUb3VjaCBidWcgYmVnaW5uaW5nIHdpdGggaU9TIDQuMiwgdXAgdGhyb3VnaCBpT1MgNS4xLAoJLy8gd2hlcmUgdGhlIGJyb3dzZXIgKkFMV0FZUyogYXBwbGllZCB0aGUgbGFuZHNjYXBlIG1lZGlhIHF1ZXJ5LiBUaGlzIGJ1ZyBkb2VzIG5vdAoJLy8gaGFwcGVuIG9uIGlQYWQuCgoJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgoJCS8vIENoZWNrIHRoZSB3aW5kb3cgd2lkdGggYW5kIGhlaWdodCB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24KCQkvLyBvZiB0aGUgZGV2aWNlIGlzIGF0IHRoaXMgbW9tZW50LiBOb3RlIHRoYXQgd2UndmUgaW5pdGlhbGl6ZWQgdGhlIHBvcnRyYWl0IG1hcAoJCS8vIHZhbHVlcyB0byAwIGFuZCAxODAsICpBTkQqIHdlIHB1cnBvc2VseSBjaGVjayBmb3IgbGFuZHNjYXBlIHNvIHRoYXQgaWYgd2UgZ3Vlc3MKCQkvLyB3cm9uZywgLCB3ZSBkZWZhdWx0IHRvIHRoZSBhc3N1bXB0aW9uIHRoYXQgcG9ydHJhaXQgaXMgdGhlIGRlZmF1bHQgb3JpZW50YXRpb24uCgkJLy8gV2UgdXNlIGEgdGhyZXNob2xkIGNoZWNrIGJlbG93IGJlY2F1c2Ugb24gc29tZSBwbGF0Zm9ybXMgbGlrZSBpT1MsIHRoZSBpUGhvbmUKCQkvLyBmb3JtLWZhY3RvciBjYW4gcmVwb3J0IGEgbGFyZ2VyIHdpZHRoIHRoYW4gaGVpZ2h0IGlmIHRoZSB1c2VyIHR1cm5zIG9uIHRoZQoJCS8vIGRldmVsb3BlciBjb25zb2xlLiBUaGUgYWN0dWFsIHRocmVzaG9sZCB2YWx1ZSBpcyBzb21ld2hhdCBhcmJpdHJhcnksIHdlIGp1c3QKCQkvLyBuZWVkIHRvIG1ha2Ugc3VyZSBpdCBpcyBsYXJnZSBlbm91Z2ggdG8gZXhjbHVkZSB0aGUgZGV2ZWxvcGVyIGNvbnNvbGUgY2FzZS4KCgkJd3cgPSB3aW5kb3cuaW5uZXJXaWR0aCB8fCB3aW4ud2lkdGgoKTsKCQl3aCA9IHdpbmRvdy5pbm5lckhlaWdodCB8fCB3aW4uaGVpZ2h0KCk7CgkJbGFuZHNjYXBlX3RocmVzaG9sZCA9IDUwOwoKCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSA9IHd3ID4gd2ggJiYgKCB3dyAtIHdoICkgPiBsYW5kc2NhcGVfdGhyZXNob2xkOwoKCQkvLyBOb3cgY2hlY2sgdG8gc2VlIGlmIHRoZSBjdXJyZW50IHdpbmRvdy5vcmllbnRhdGlvbiBpcyAwIG9yIDE4MC4KCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgPSBwb3J0cmFpdF9tYXBbIHdpbmRvdy5vcmllbnRhdGlvbiBdOwoKCQkvLyBJZiB0aGUgaW5pdGlhbCBvcmllbnRhdGlvbiBpcyBsYW5kc2NhcGUsIGJ1dCB3aW5kb3cub3JpZW50YXRpb24gcmVwb3J0cyAwIG9yIDE4MCwgKk9SKgoJCS8vIGlmIHRoZSBpbml0aWFsIG9yaWVudGF0aW9uIGlzIHBvcnRyYWl0LCBidXQgd2luZG93Lm9yaWVudGF0aW9uIHJlcG9ydHMgOTAgb3IgLTkwLCB3ZQoJCS8vIG5lZWQgdG8gZmxpcCBvdXIgcG9ydHJhaXRfbWFwIHZhbHVlcyBiZWNhdXNlIGxhbmRzY2FwZSBpcyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBmb3IKCQkvLyB0aGlzIGRldmljZS9icm93c2VyLgoJCWlmICggKCBpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSAmJiBpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgKSB8fCAoICFpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSAmJiAhaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ICkgKSB7CgkJCXBvcnRyYWl0X21hcCA9IHsgIi05MCI6IHRydWUsICI5MCI6IHRydWUgfTsKCQl9Cgl9CgoJJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlID0gJC5leHRlbmQoIHt9LCAkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UsIHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCS8vIElmIHRoZSBldmVudCBpcyBzdXBwb3J0ZWQgbmF0aXZlbHksIHJldHVybiBmYWxzZSBzbyB0aGF0IGpRdWVyeQoJCQkvLyB3aWxsIGJpbmQgdG8gdGhlIGV2ZW50IHVzaW5nIERPTSBtZXRob2RzLgoJCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiAmJiAhJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLmRpc2FibGVkICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQkvLyBHZXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24gdG8gYXZvaWQgaW5pdGlhbCBkb3VibGUtdHJpZ2dlcmluZy4KCQkJbGFzdF9vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgc2ltdWxhdGUgdGhlCgkJCS8vIGV2ZW50IGJ5IHRlc3Rpbmcgd2luZG93IGRpbWVuc2lvbnMgb24gcmVzaXplLgoJCQl3aW4uYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHJldHVybiBmYWxzZSBzbyB0aGF0CgkJCS8vIGpRdWVyeSB3aWxsIHVuYmluZCB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICEkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UuZGlzYWJsZWQgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCS8vIEJlY2F1c2UgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50IGRvZXNuJ3QgZXhpc3QsIHVuYmluZCB0aGUKCQkJLy8gcmVzaXplIGV2ZW50IGhhbmRsZXIuCgkJCXdpbi51bmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCBoYW5kbGVyICk7CgkJfSwKCQlhZGQ6IGZ1bmN0aW9uKCBoYW5kbGVPYmogKSB7CgkJCS8vIFNhdmUgYSByZWZlcmVuY2UgdG8gdGhlIGJvdW5kIGV2ZW50IGhhbmRsZXIuCgkJCXZhciBvbGRfaGFuZGxlciA9IGhhbmRsZU9iai5oYW5kbGVyOwoKCQkJaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBNb2RpZnkgZXZlbnQgb2JqZWN0LCBhZGRpbmcgdGhlIC5vcmllbnRhdGlvbiBwcm9wZXJ0eS4KCQkJCWV2ZW50Lm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkJLy8gQ2FsbCB0aGUgb3JpZ2luYWxseS1ib3VuZCBldmVudCBoYW5kbGVyIGFuZCByZXR1cm4gaXRzIHJlc3VsdC4KCQkJCXJldHVybiBvbGRfaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoJfSk7CgoJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoaXMgaGFuZGxlciB3aWxsIGJlIGJvdW5kIHRvCgkvLyB0aGUgd2luZG93IHJlc2l6ZSBldmVudCB0byBzaW11bGF0ZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQuCglmdW5jdGlvbiBoYW5kbGVyKCkgewoJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbi4KCQl2YXIgb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJaWYgKCBvcmllbnRhdGlvbiAhPT0gbGFzdF9vcmllbnRhdGlvbiApIHsKCQkJLy8gVGhlIG9yaWVudGF0aW9uIGhhcyBjaGFuZ2VkLCBzbyB0cmlnZ2VyIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCQkJbGFzdF9vcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uOwoJCQl3aW4udHJpZ2dlciggZXZlbnRfbmFtZSApOwoJCX0KCX0KCgkvLyBHZXQgdGhlIGN1cnJlbnQgcGFnZSBvcmllbnRhdGlvbi4gVGhpcyBtZXRob2QgaXMgZXhwb3NlZCBwdWJsaWNseSwgc2hvdWxkIGl0CgkvLyBiZSBuZWVkZWQsIGFzIGpRdWVyeS5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uKCkKCSQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXZhciBpc1BvcnRyYWl0ID0gdHJ1ZSwgZWxlbSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCgkJLy8gcHJlZmVyIHdpbmRvdyBvcmllbnRhdGlvbiB0byB0aGUgY2FsY3VsYXRpb24gYmFzZWQgb24gc2NyZWVuc2l6ZSBhcwoJCS8vIHRoZSBhY3R1YWwgc2NyZWVuIHJlc2l6ZSB0YWtlcyBwbGFjZSBiZWZvcmUgb3IgYWZ0ZXIgdGhlIG9yaWVudGF0aW9uIGNoYW5nZSBldmVudAoJCS8vIGhhcyBiZWVuIGZpcmVkIGRlcGVuZGluZyBvbiBpbXBsZW1lbnRhdGlvbiAoZWcgYW5kcm9pZCAyLjMgaXMgYmVmb3JlLCBpcGhvbmUgYWZ0ZXIpLgoJCS8vIE1vcmUgdGVzdGluZyBpcyByZXF1aXJlZCB0byBkZXRlcm1pbmUgaWYgYSBtb3JlIHJlbGlhYmxlIG1ldGhvZCBvZiBkZXRlcm1pbmluZyB0aGUgbmV3IHNjcmVlbnNpemUKCQkvLyBpcyBwb3NzaWJsZSB3aGVuIG9yaWVudGF0aW9uY2hhbmdlIGlzIGZpcmVkLiAoZWcsIHVzZSBtZWRpYSBxdWVyaWVzICsgZWxlbWVudCArIG9wYWNpdHkpCgkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgkJCS8vIGlmIHRoZSB3aW5kb3cgb3JpZW50YXRpb24gcmVnaXN0ZXJzIGFzIDAgb3IgMTgwIGRlZ3JlZXMgcmVwb3J0CgkJCS8vIHBvcnRyYWl0LCBvdGhlcndpc2UgbGFuZHNjYXBlCgkJCWlzUG9ydHJhaXQgPSBwb3J0cmFpdF9tYXBbIHdpbmRvdy5vcmllbnRhdGlvbiBdOwoJCX0gZWxzZSB7CgkJCWlzUG9ydHJhaXQgPSBlbGVtICYmIGVsZW0uY2xpZW50V2lkdGggLyBlbGVtLmNsaWVudEhlaWdodCA8IDEuMTsKCQl9CgoJCXJldHVybiBpc1BvcnRyYWl0ID8gInBvcnRyYWl0IiA6ICJsYW5kc2NhcGUiOwoJfTsKCgkkLmZuWyBldmVudF9uYW1lIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBldmVudF9uYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBldmVudF9uYW1lICk7Cgl9OwoKCS8vIGpRdWVyeSA8IDEuOAoJaWYgKCAkLmF0dHJGbiApIHsKCQkkLmF0dHJGblsgZXZlbnRfbmFtZSBdID0gdHJ1ZTsKCX0KCn0oIGpRdWVyeSwgdGhpcyApKTsKCgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCS8vIGV4aXN0aW5nIGJhc2UgdGFnPwoJdmFyIGJhc2VFbGVtZW50ID0gJCggImhlYWQiICkuY2hpbGRyZW4oICJiYXNlIiApLAoKCS8vIGJhc2UgZWxlbWVudCBtYW5hZ2VtZW50LCBkZWZpbmVkIGRlcGVuZGluZyBvbiBkeW5hbWljIGJhc2UgdGFnIHN1cHBvcnQKCS8vIFRPRE8gbW92ZSB0byBleHRlcm5hbCB3aWRnZXQKCWJhc2UgPSB7CgoJCS8vIGRlZmluZSBiYXNlIGVsZW1lbnQsIGZvciB1c2UgaW4gcm91dGluZyBhc3NldCB1cmxzIHRoYXQgYXJlIHJlZmVyZW5jZWQKCQkvLyBpbiBBamF4LXJlcXVlc3RlZCBtYXJrdXAKCQllbGVtZW50OiAoIGJhc2VFbGVtZW50Lmxlbmd0aCA/IGJhc2VFbGVtZW50IDoKCQkJJCggIjxiYXNlPiIsIHsgaHJlZjogJC5tb2JpbGUucGF0aC5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCB9ICkucHJlcGVuZFRvKCAkKCAiaGVhZCIgKSApICksCgoJCWxpbmtTZWxlY3RvcjogIltzcmNdLCBsaW5rW2hyZWZdLCBhW3JlbD0nZXh0ZXJuYWwnXSwgOmpxbURhdGEoYWpheD0nZmFsc2UnKSwgYVt0YXJnZXRdIiwKCgkJLy8gc2V0IHRoZSBnZW5lcmF0ZWQgQkFTRSBlbGVtZW50J3MgaHJlZiB0byBhIG5ldyBwYWdlJ3MgYmFzZSBwYXRoCgkJc2V0OiBmdW5jdGlvbiggaHJlZiApIHsKCgkJCS8vIHdlIHNob3VsZCBkbyBub3RoaW5nIGlmIHRoZSB1c2VyIHdhbnRzIHRvIG1hbmFnZSB0aGVpciB1cmwgYmFzZQoJCQkvLyBtYW51YWxseQoJCQlpZiAoICEkLm1vYmlsZS5keW5hbWljQmFzZUVuYWJsZWQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIHdlIHNob3VsZCB1c2UgdGhlIGJhc2UgdGFnIGlmIHdlIGNhbiBtYW5pcHVsYXRlIGl0IGR5bmFtaWNhbGx5CgkJCWlmICggJC5zdXBwb3J0LmR5bmFtaWNCYXNlVGFnICkgewoJCQkJYmFzZS5lbGVtZW50LmF0dHIoICJocmVmIiwKCQkJCQkkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgJC5tb2JpbGUucGF0aC5kb2N1bWVudEJhc2UgKSApOwoJCQl9CgkJfSwKCgkJcmV3cml0ZTogZnVuY3Rpb24oIGhyZWYsIHBhZ2UgKSB7CgkJCXZhciBuZXdQYXRoID0gJC5tb2JpbGUucGF0aC5nZXQoIGhyZWYgKTsKCgkJCXBhZ2UuZmluZCggYmFzZS5saW5rU2VsZWN0b3IgKS5lYWNoKGZ1bmN0aW9uKCBpLCBsaW5rICkgewoJCQkJdmFyIHRoaXNBdHRyID0gJCggbGluayApLmlzKCAiW2hyZWZdIiApID8gImhyZWYiIDoKCQkJCQkkKCBsaW5rICkuaXMoICJbc3JjXSIgKSA/ICJzcmMiIDogImFjdGlvbiIsCgkJCQl0aGlzVXJsID0gJCggbGluayApLmF0dHIoIHRoaXNBdHRyICk7CgoJCQkJLy8gWFhYX2pibGFzOiBXZSBuZWVkIHRvIGZpeCB0aGlzIHNvIHRoYXQgaXQgcmVtb3ZlcyB0aGUgZG9jdW1lbnQKCQkJCS8vICAgICAgICAgICAgYmFzZSBVUkwsIGFuZCB0aGVuIHByZXBlbmRzIHdpdGggdGhlIG5ldyBwYWdlIFVSTC4KCQkJCS8vIGlmIGZ1bGwgcGF0aCBleGlzdHMgYW5kIGlzIHNhbWUsIGNob3AgaXQgLSBoZWxwcyBJRSBvdXQKCQkJCXRoaXNVcmwgPSB0aGlzVXJsLnJlcGxhY2UoIGxvY2F0aW9uLnByb3RvY29sICsgIi8vIiArCgkJCQkJbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lLCAiIiApOwoKCQkJCWlmICggIS9eKFx3Kzp8I3xcLykvLnRlc3QoIHRoaXNVcmwgKSApIHsKCQkJCQkkKCBsaW5rICkuYXR0ciggdGhpc0F0dHIsIG5ld1BhdGggKyB0aGlzVXJsICk7CgkJCQl9CgkJCX0pOwoJCX0sCgoJCS8vIHNldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCXJlc2V0OiBmdW5jdGlvbigvKiBocmVmICovKSB7CgkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb1NlYXJjaCApOwoJCX0KCX07CgoJJC5tb2JpbGUuYmFzZSA9IGJhc2U7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CiQubW9iaWxlLndpZGdldHMgPSB7fTsKCnZhciBvcmlnaW5hbFdpZGdldCA9ICQud2lkZ2V0LAoKCS8vIFJlY29yZCB0aGUgb3JpZ2luYWwsIG5vbi1tb2JpbGVpbml0LW1vZGlmaWVkIHZlcnNpb24gb2YgJC5tb2JpbGUua2VlcE5hdGl2ZQoJLy8gc28gd2UgY2FuIGxhdGVyIGRldGVybWluZSB3aGV0aGVyIHNvbWVvbmUgaGFzIG1vZGlmaWVkICQubW9iaWxlLmtlZXBOYXRpdmUKCWtlZXBOYXRpdmVGYWN0b3J5RGVmYXVsdCA9ICQubW9iaWxlLmtlZXBOYXRpdmU7CgokLndpZGdldCA9IChmdW5jdGlvbiggb3JpZyApIHsKCXJldHVybiBmdW5jdGlvbigpIHsKCQl2YXIgY29uc3RydWN0b3IgPSBvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSwKCQkJbmFtZSA9IGNvbnN0cnVjdG9yLnByb3RvdHlwZS53aWRnZXROYW1lOwoKCQljb25zdHJ1Y3Rvci5pbml0U2VsZWN0b3IgPSAoICggY29uc3RydWN0b3IucHJvdG90eXBlLmluaXRTZWxlY3RvciAhPT0gdW5kZWZpbmVkICkgPwoJCQljb25zdHJ1Y3Rvci5wcm90b3R5cGUuaW5pdFNlbGVjdG9yIDogIjpqcW1EYXRhKHJvbGU9JyIgKyBuYW1lICsgIicpIiApOwoKCQkkLm1vYmlsZS53aWRnZXRzWyBuYW1lIF0gPSBjb25zdHJ1Y3RvcjsKCgkJcmV0dXJuIGNvbnN0cnVjdG9yOwoJfTsKfSkoICQud2lkZ2V0ICk7CgovLyBNYWtlIHN1cmUgJC53aWRnZXQgc3RpbGwgaGFzIGJyaWRnZSBhbmQgZXh0ZW5kIG1ldGhvZHMKJC5leHRlbmQoICQud2lkZ2V0LCBvcmlnaW5hbFdpZGdldCApOwoKLy8gRm9yIGJhY2tjb21wYXQgcmVtb3ZlIGluIDEuNQokLm1vYmlsZS5kb2N1bWVudC5vbiggImNyZWF0ZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCSQoIGV2ZW50LnRhcmdldCApLmVuaGFuY2VXaXRoaW4oKTsKfSk7CgokLndpZGdldCggIm1vYmlsZS5wYWdlIiwgewoJb3B0aW9uczogewoJCXRoZW1lOiAiYSIsCgkJZG9tQ2FjaGU6IGZhbHNlLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJa2VlcE5hdGl2ZURlZmF1bHQ6ICQubW9iaWxlLmtlZXBOYXRpdmUsCgoJCS8vIERlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQljb250ZW50VGhlbWU6IG51bGwsCgkJZW5oYW5jZWQ6IGZhbHNlCgl9LAoKCS8vIERFUFJFQ0FURUQgZm9yID4gMS40CgkvLyBUT0RPIHJlbW92ZSBhdCAxLjUKCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCkgewoJCSQuV2lkZ2V0LnByb3RvdHlwZS5fY3JlYXRlV2lkZ2V0LmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl0aGlzLl90cmlnZ2VyKCAiaW5pdCIgKTsKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJLy8gSWYgZmFsc2UgaXMgcmV0dXJuZWQgYnkgdGhlIGNhbGxiYWNrcyBkbyBub3QgY3JlYXRlIHRoZSBwYWdlCgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3JlY3JlYXRlIiApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9lbmhhbmNlKCk7CgkJfQoKCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LCB7CgkJCXBhZ2ViZWZvcmVoaWRlOiAicmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCIsCgkJCXBhZ2ViZWZvcmVzaG93OiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IgoJCX0pOwoKCQl0aGlzLmVsZW1lbnQuZW5oYW5jZVdpdGhpbigpOwoJCS8vIERpYWxvZyB3aWRnZXQgaXMgZGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIHRoaXMgaW4gMS41CgkJaWYgKCAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMuZWxlbWVudFswXSwgInJvbGUiICkgPT09ICJkaWFsb2ciICYmICQubW9iaWxlLmRpYWxvZyApIHsKCQkJdGhpcy5lbGVtZW50LmRpYWxvZygpOwoJCX0KCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uICgpIHsKCQl2YXIgYXR0clByZWZpeCA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQkJc2VsZiA9IHRoaXM7CgoJCWlmICggdGhpcy5vcHRpb25zLnJvbGUgKSB7CgkJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZSIsIHRoaXMub3B0aW9ucy5yb2xlICk7CgkJfQoKCQl0aGlzLmVsZW1lbnQKCQkJLmF0dHIoICJ0YWJpbmRleCIsICIwIiApCgkJCS5hZGRDbGFzcyggInVpLXBhZ2UgdWktcGFnZS10aGVtZS0iICsgdGhpcy5vcHRpb25zLnRoZW1lICk7CgoJCS8vIE1hbmlwdWxhdGlvbiBvZiBjb250ZW50IG9zIERlcHJlY2F0ZWQgYXMgb2YgMS40IHJlbW92ZSBpbiAxLjUKCQl0aGlzLmVsZW1lbnQuZmluZCggIlsiICsgYXR0clByZWZpeCArICJyb2xlPSdjb250ZW50J10iICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCXRoZW1lID0gdGhpcy5nZXRBdHRyaWJ1dGUoIGF0dHJQcmVmaXggKyAidGhlbWUiICkgfHwgdW5kZWZpbmVkOwoJCQkJc2VsZi5vcHRpb25zLmNvbnRlbnRUaGVtZSA9IHRoZW1lIHx8IHNlbGYub3B0aW9ucy5jb250ZW50VGhlbWUgfHwgKCBzZWxmLm9wdGlvbnMuZGlhbG9nICYmIHNlbGYub3B0aW9ucy50aGVtZSApIHx8ICggc2VsZi5lbGVtZW50LmpxbURhdGEoInJvbGUiKSA9PT0gImRpYWxvZyIgJiYgIHNlbGYub3B0aW9ucy50aGVtZSApOwoJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1jb250ZW50IiApOwoJCQkJaWYgKCBzZWxmLm9wdGlvbnMuY29udGVudFRoZW1lICkgewoJCQkJCSR0aGlzLmFkZENsYXNzKCAidWktYm9keS0iICsgKCBzZWxmLm9wdGlvbnMuY29udGVudFRoZW1lICkgKTsKCQkJCX0KCQkJCS8vIEFkZCBBUklBIHJvbGUKCQkJCSR0aGlzLmF0dHIoICJyb2xlIiwgIm1haW4iICkuYWRkQ2xhc3MoICJ1aS1jb250ZW50IiApOwoJCX0pOwoJfSwKCgliaW5kUmVtb3ZlOiBmdW5jdGlvbiggY2FsbGJhY2sgKSB7CgkJdmFyIHBhZ2UgPSB0aGlzLmVsZW1lbnQ7CgoJCS8vIHdoZW4gZG9tIGNhY2hpbmcgaXMgbm90IGVuYWJsZWQgb3IgdGhlIHBhZ2UgaXMgZW1iZWRkZWQgYmluZCB0byByZW1vdmUgdGhlIHBhZ2Ugb24gaGlkZQoJCWlmICggIXBhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLm9wdGlvbnMuZG9tQ2FjaGUgJiYKCQkJcGFnZS5pcyggIjpqcW1EYXRhKGV4dGVybmFsLXBhZ2U9J3RydWUnKSIgKSApIHsKCgkJCS8vIFRPRE8gdXNlIF9vbiAtIHRoYXQgaXMsIHNvcnQgb3V0IHdoeSBpdCBkb2Vzbid0IHdvcmsgaW4gdGhpcyBjYXNlCgkJCXBhZ2UuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIsIGNhbGxiYWNrIHx8IGZ1bmN0aW9uKCBlLCBkYXRhICkgewoKCQkJCS8vY2hlY2sgaWYgdGhpcyBpcyBhIHNhbWUgcGFnZSB0cmFuc2l0aW9uIGFuZCBpZiBzbyBkb24ndCByZW1vdmUgdGhlIHBhZ2UKCQkJCWlmKCAhZGF0YS5zYW1lUGFnZSApewoJCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCQkJcHJFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZXJlbW92ZSIgKTsKCgkJCQkJJHRoaXMudHJpZ2dlciggcHJFdmVudCApOwoKCQkJCQlpZiAoICFwckV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCQkkdGhpcy5yZW1vdmVXaXRoRGVwZW5kZW50cygpOwoJCQkJCX0KCQkJCX0KCQkJfSk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG8gKSB7CgkJaWYgKCBvLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHRoaXMub3B0aW9ucy50aGVtZSApLmFkZENsYXNzKCAidWktYm9keS0iICsgby50aGVtZSApOwoJCX0KCgkJaWYgKCBvLmNvbnRlbnRUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLmVsZW1lbnQuZmluZCggIltkYXRhLSIgKyAkLm1vYmlsZS5ucyArICI9J2NvbnRlbnQnXSIgKS5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHRoaXMub3B0aW9ucy5jb250ZW50VGhlbWUgKQoJCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgby5jb250ZW50VGhlbWUgKTsKCQl9Cgl9LAoKCV9oYW5kbGVQYWdlQmVmb3JlU2hvdzogZnVuY3Rpb24oLyogZSAqLykgewoJCXRoaXMuc2V0Q29udGFpbmVyQmFja2dyb3VuZCgpOwoJfSwKCS8vIERlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCXJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiOm1vYmlsZS1wYWdlY29udGFpbmVyIiApLnBhZ2Vjb250YWluZXIoeyAidGhlbWUiOiAibm9uZSIgfSk7Cgl9LAoJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJLy8gc2V0IHRoZSBwYWdlIGNvbnRhaW5lciBiYWNrZ3JvdW5kIHRvIHRoZSBwYWdlIHRoZW1lCglzZXRDb250YWluZXJCYWNrZ3JvdW5kOiBmdW5jdGlvbiggdGhlbWUgKSB7CgkJdGhpcy5lbGVtZW50LnBhcmVudCgpLnBhZ2Vjb250YWluZXIoIHsgInRoZW1lIjogdGhlbWUgfHwgdGhpcy5vcHRpb25zLnRoZW1lIH0gKTsKCX0sCgkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CglrZWVwTmF0aXZlU2VsZWN0b3I6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlrZWVwTmF0aXZlID0gJC50cmltKCBvcHRpb25zLmtlZXBOYXRpdmUgfHwgIiIgKSwKCQkJZ2xvYmFsVmFsdWUgPSAkLnRyaW0oICQubW9iaWxlLmtlZXBOYXRpdmUgKSwKCQkJb3B0aW9uVmFsdWUgPSAkLnRyaW0oIG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHQgKSwKCgkJCS8vIENoZWNrIGlmICQubW9iaWxlLmtlZXBOYXRpdmUgaGFzIGNoYW5nZWQgZnJvbSB0aGUgZmFjdG9yeSBkZWZhdWx0CgkJCW5ld0RlZmF1bHQgPSAoIGtlZXBOYXRpdmVGYWN0b3J5RGVmYXVsdCA9PT0gZ2xvYmFsVmFsdWUgPwoJCQkJIiIgOiBnbG9iYWxWYWx1ZSApLAoKCQkJLy8gSWYgJC5tb2JpbGUua2VlcE5hdGl2ZSBoYXMgbm90IGNoYW5nZWQsIHVzZSBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0CgkJCW9sZERlZmF1bHQgPSAoIG5ld0RlZmF1bHQgPT09ICIiID8gb3B0aW9uVmFsdWUgOiAiIiApOwoKCQkvLyBDb25jYXRlbmF0ZSBrZWVwTmF0aXZlIHNlbGVjdG9ycyBmcm9tIGFsbCBzb3VyY2VzIHdoZXJlIHRoZSB2YWx1ZSBoYXMKCQkvLyBjaGFuZ2VkIG9yLCBpZiBub3RoaW5nIGhhcyBjaGFuZ2VkLCByZXR1cm4gdGhlIGRlZmF1bHQKCQlyZXR1cm4gKCAoIGtlZXBOYXRpdmUgPyBbIGtlZXBOYXRpdmUgXSA6IFtdICkKCQkJLmNvbmNhdCggbmV3RGVmYXVsdCA/IFsgbmV3RGVmYXVsdCBdIDogW10gKQoJCQkuY29uY2F0KCBvbGREZWZhdWx0ID8gWyBvbGREZWZhdWx0IF0gOiBbXSApCgkJCS5qb2luKCAiLCAiICkgKTsKCX0KfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCSQud2lkZ2V0KCAibW9iaWxlLnBhZ2Vjb250YWluZXIiLCB7CgkJb3B0aW9uczogewoJCQl0aGVtZTogImEiCgkJfSwKCgkJaW5pdFNlbGVjdG9yOiBmYWxzZSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoKCQkJLy8gVE9ETyBjb25zaWRlciBtb3ZpbmcgdGhlIG5hdmlnYXRpb24gaGFuZGxlciBPVVQgb2Ygd2lkZ2V0IGludG8KCQkJLy8gICAgICBzb21lIG90aGVyIG9iamVjdCBhcyBnbHVlIGJldHdlZW4gdGhlIG5hdmlnYXRlIGV2ZW50IGFuZCB0aGUKCQkJLy8gICAgICBjb250ZW50IHdpZGdldCBsb2FkIGFuZCBjaGFuZ2UgbWV0aG9kcwoJCQl0aGlzLl9vbiggdGhpcy53aW5kb3csIHsgbmF2aWdhdGU6ICJfZmlsdGVyTmF2aWdhdGVFdmVudHMiIH0pOwoKCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7CgkJCQkvLyBkaXNhYmxlIGFuIHNjcm9sbCBzZXR0aW5nIHdoZW4gYSBoYXNoY2hhbmdlIGhhcyBiZWVuIGZpcmVkLAoJCQkJLy8gdGhpcyBvbmx5IHdvcmtzIGJlY2F1c2UgdGhlIHJlY29yZGluZyBvZiB0aGUgc2Nyb2xsIHBvc2l0aW9uCgkJCQkvLyBpcyBkZWxheWVkIGZvciAxMDBtcyBhZnRlciB0aGUgYnJvd3NlciBtaWdodCBoYXZlIGNoYW5nZWQgdGhlCgkJCQkvLyBwb3NpdGlvbiBiZWNhdXNlIG9mIHRoZSBoYXNoY2hhbmdlCgkJCQluYXZpZ2F0ZTogIl9kaXNhYmxlUmVjb3JkU2Nyb2xsIiwKCgkJCQkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgZm9yIHRoZSBmaXJzdCBwYWdlLCAicGFnZWNoYW5nZSIgd29uJ3QgYmUKCQkJCS8vIGZpcmVkIGluIHRoYXQgY2FzZQoJCQkJc2Nyb2xsc3RvcDogIl9kZWxheWVkUmVjb3JkU2Nyb2xsIgoJCQl9KTsKCgkJCS8vIFRPRE8gbW92ZSBmcm9tIHBhZ2UqIGV2ZW50cyB0byBjb250ZW50KiBldmVudHMKCQkJdGhpcy5fb24oeyBwYWdlY2hhbmdlOiAiX2FmdGVyQ29udGVudENoYW5nZSIgfSk7CgoJCQkvLyBoYW5kbGUgaW5pdGlhbCBoYXNoY2hhbmdlIGZyb20gY2hyb21lIDooCgkJCXRoaXMud2luZG93Lm9uZSggIm5hdmlnYXRlIiwgJC5wcm94eShmdW5jdGlvbigpIHsKCQkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoJCQl9LCB0aGlzKSk7CgkJfSwKCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCAmJiBvcHRpb25zLnRoZW1lICE9PSAibm9uZSIgKSB7CgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyB0aGlzLm9wdGlvbnMudGhlbWUgKQoJCQkJCS5hZGRDbGFzcyggInVpLW92ZXJsYXktIiArIG9wdGlvbnMudGhlbWUgKTsKCQkJfSBlbHNlIGlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktb3ZlcmxheS0iICsgdGhpcy5vcHRpb25zLnRoZW1lICk7CgkJCX0KCgkJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgkJfSwKCgkJX2Rpc2FibGVSZWNvcmRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnNldExhc3RTY3JvbGxFbmFibGVkID0gZmFsc2U7CgkJfSwKCgkJX2VuYWJsZVJlY29yZFNjcm9sbDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoJCX0sCgoJCS8vIFRPRE8gY29uc2lkZXIgdGhlIG5hbWUgaGVyZSwgc2luY2UgaXQncyBwdXJwb3NlIHNwZWNpZmljCgkJX2FmdGVyQ29udGVudENoYW5nZTogZnVuY3Rpb24oKSB7CgkJCS8vIG9uY2UgdGhlIHBhZ2UgaGFzIGNoYW5nZWQsIHJlLWVuYWJsZSB0aGUgc2Nyb2xsIHJlY29yZGluZwoJCQl0aGlzLnNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCgkJCS8vIHJlbW92ZSBhbnkgYmluZGluZyB0aGF0IHByZXZpb3VzbHkgZXhpc3RlZCBvbiB0aGUgZ2V0IHNjcm9sbAoJCQkvLyB3aGljaCBtYXkgb3IgbWF5IG5vdCBiZSBkaWZmZXJlbnQgdGhhbiB0aGUgc2Nyb2xsIGVsZW1lbnQKCQkJLy8gZGV0ZXJtaW5lZCBmb3IgdGhpcyBwYWdlIHByZXZpb3VzbHkKCQkJdGhpcy5fb2ZmKCB0aGlzLndpbmRvdywgInNjcm9sbHN0b3AiICk7CgoJCQkvLyBkZXRlcm1pbmUgYW5kIGJpbmQgdG8gdGhlIGN1cnJlbnQgc2NvbGwgZWxlbWVudCB3aGljaCBtYXkgYmUgdGhlCgkJCS8vIHdpbmRvdyBvciBpbiB0aGUgY2FzZSBvZiB0b3VjaCBvdmVyZmxvdyB0aGUgZWxlbWVudCB0b3VjaCBvdmVyZmxvdwoJCQl0aGlzLl9vbiggdGhpcy53aW5kb3csIHsgc2Nyb2xsc3RvcDogIl9kZWxheWVkUmVjb3JkU2Nyb2xsIiB9KTsKCQl9LAoKCQlfcmVjb3JkU2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJLy8gdGhpcyBiYXJyaWVyIHByZXZlbnRzIHNldHRpbmcgdGhlIHNjcm9sbCB2YWx1ZSBiYXNlZCBvbgoJCQkvLyB0aGUgYnJvd3NlciBzY3JvbGxpbmcgdGhlIHdpbmRvdyBiYXNlZCBvbiBhIGhhc2hjaGFuZ2UKCQkJaWYgKCAhdGhpcy5zZXRMYXN0U2Nyb2xsRW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGFjdGl2ZSA9IHRoaXMuX2dldEFjdGl2ZUhpc3RvcnkoKSwKCQkJCWN1cnJlbnRTY3JvbGwsIG1pblNjcm9sbCwgZGVmYXVsdFNjcm9sbDsKCgkJCWlmICggYWN0aXZlICkgewoJCQkJY3VycmVudFNjcm9sbCA9IHRoaXMuX2dldFNjcm9sbCgpOwoJCQkJbWluU2Nyb2xsID0gdGhpcy5fZ2V0TWluU2Nyb2xsKCk7CgkJCQlkZWZhdWx0U2Nyb2xsID0gdGhpcy5fZ2V0RGVmYXVsdFNjcm9sbCgpOwoKCQkJCS8vIFNldCBhY3RpdmUgcGFnZSdzIGxhc3RTY3JvbGwgcHJvcC4gSWYgdGhlIGxvY2F0aW9uIHdlJ3JlCgkJCQkvLyBzY3JvbGxpbmcgdG8gaXMgbGVzcyB0aGFuIG1pblNjcm9sbEJhY2ssIGxldCBpdCBnby4KCQkJCWFjdGl2ZS5sYXN0U2Nyb2xsID0gY3VycmVudFNjcm9sbCA8IG1pblNjcm9sbCA/IGRlZmF1bHRTY3JvbGwgOiBjdXJyZW50U2Nyb2xsOwoJCQl9CgkJfSwKCgkJX2RlbGF5ZWRSZWNvcmRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQlzZXRUaW1lb3V0KCAkLnByb3h5KHRoaXMsICJfcmVjb3JkU2Nyb2xsIiksIDEwMCApOwoJCX0sCgoJCV9nZXRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy53aW5kb3cuc2Nyb2xsVG9wKCk7CgkJfSwKCgkJX2dldE1pblNjcm9sbDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5taW5TY3JvbGxCYWNrOwoJCX0sCgoJCV9nZXREZWZhdWx0U2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsOwoJCX0sCgoJCV9maWx0ZXJOYXZpZ2F0ZUV2ZW50czogZnVuY3Rpb24oIGUsIGRhdGEgKSB7CgkJCXZhciB1cmw7CgoJCQlpZiAoIGUub3JpZ2luYWxFdmVudCAmJiBlLm9yaWdpbmFsRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXVybCA9IGUub3JpZ2luYWxFdmVudC50eXBlLmluZGV4T2YoICJoYXNoY2hhbmdlIiApID4gLTEgPyBkYXRhLnN0YXRlLmhhc2ggOiBkYXRhLnN0YXRlLnVybDsKCgkJCWlmICggIXVybCApIHsKCQkJCXVybCA9IHRoaXMuX2dldEhhc2goKTsKCQkJfQoKCQkJaWYgKCAhdXJsIHx8IHVybCA9PT0gIiMiIHx8IHVybC5pbmRleE9mKCAiIyIgKyAkLm1vYmlsZS5wYXRoLnVpU3RhdGVLZXkgKSA9PT0gMCApIHsKCQkJCXVybCA9IGxvY2F0aW9uLmhyZWY7CgkJCX0KCgkJCXRoaXMuX2hhbmRsZU5hdmlnYXRlKCB1cmwsIGRhdGEuc3RhdGUgKTsKCQl9LAoKCQlfZ2V0SGFzaDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoJCX0sCgoJCS8vIFRPRE8gYWN0aXZlIHBhZ2Ugc2hvdWxkIGJlIG1hbmFnZWQgYnkgdGhlIGNvbnRhaW5lciAoaWUsIGl0IHNob3VsZCBiZSBhIHByb3BlcnR5KQoJCWdldEFjdGl2ZVBhZ2U6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5hY3RpdmVQYWdlOwoJCX0sCgoJCS8vIFRPRE8gdGhlIGZpcnN0IHBhZ2Ugc2hvdWxkIGJlIGEgcHJvcGVydHkgc2V0IGR1cmluZyBfY3JlYXRlIHVzaW5nIHRoZSBsb2dpYwoJCS8vICAgICAgdGhhdCBjdXJyZW50bHkgcmVzaWRlcyBpbiBpbml0CgkJX2dldEluaXRpYWxDb250ZW50OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmZpcnN0UGFnZTsKCQl9LAoKCQkvLyBUT0RPIGVhY2ggY29udGVudCBjb250YWluZXIgc2hvdWxkIGhhdmUgYSBoaXN0b3J5IG9iamVjdAoJCV9nZXRIaXN0b3J5OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnk7CgkJfSwKCgkJLy8gVE9ETyB1c2UgX2dldEhpc3RvcnkKCQlfZ2V0QWN0aXZlSGlzdG9yeTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmdldEFjdGl2ZSgpOwoJCX0sCgoJCS8vIFRPRE8gdGhlIGRvY3VtZW50IGJhc2Ugc2hvdWxkIGJlIGRldGVybWluZWQgYXQgY3JlYXRpb24KCQlfZ2V0RG9jdW1lbnRCYXNlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlOwoJCX0sCgoJCWJhY2s6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmdvKCAtMSApOwoJCX0sCgoJCWZvcndhcmQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmdvKCAxICk7CgkJfSwKCgkJZ286IGZ1bmN0aW9uKCBzdGVwcyApIHsKCgkJCS8vaWYgaGFzaGxpc3RlbmluZyBpcyBlbmFibGVkIHVzZSBuYXRpdmUgaGlzdG9yeSBtZXRob2QKCQkJaWYgKCAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCApIHsKCQkJCXdpbmRvdy5oaXN0b3J5LmdvKCBzdGVwcyApOwoJCQl9IGVsc2UgewoKCQkJCS8vd2UgYXJlIG5vdCBsaXN0ZW5pbmcgdG8gdGhlIGhhc2ggc28gaGFuZGxlIGhpc3RvcnkgaW50ZXJuYWxseQoJCQkJdmFyIGFjdGl2ZUluZGV4ID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hY3RpdmVJbmRleCwKCQkJCQlpbmRleCA9IGFjdGl2ZUluZGV4ICsgcGFyc2VJbnQoIHN0ZXBzLCAxMCApLAoJCQkJCXVybCA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnkuc3RhY2tbIGluZGV4IF0udXJsLAoJCQkJCWRpcmVjdGlvbiA9ICggc3RlcHMgPj0gMSApPyAiZm9yd2FyZCIgOiAiYmFjayI7CgoJCQkJLy91cGRhdGUgdGhlIGhpc3Rvcnkgb2JqZWN0CgkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFjdGl2ZUluZGV4ID0gaW5kZXg7CgkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LnByZXZpb3VzSW5kZXggPSBhY3RpdmVJbmRleDsKCgkJCQkvL2NoYW5nZSB0byB0aGUgbmV3IHBhZ2UKCQkJCXRoaXMuY2hhbmdlKCB1cmwsIHsgZGlyZWN0aW9uOiBkaXJlY3Rpb24sIGNoYW5nZUhhc2g6IGZhbHNlLCBmcm9tSGFzaENoYW5nZTogdHJ1ZSB9ICk7CgkJCX0KCQl9LAoKCQkvLyBUT0RPIHJlbmFtZSBfaGFuZGxlRGVzdGluYXRpb24KCQlfaGFuZGxlRGVzdGluYXRpb246IGZ1bmN0aW9uKCB0byApIHsKCQkJdmFyIGhpc3Rvcnk7CgoJCQkvLyBjbGVhbiB0aGUgaGFzaCBmb3IgY29tcGFyaXNvbiBpZiBpdCdzIGEgdXJsCgkJCWlmICggJC50eXBlKHRvKSA9PT0gInN0cmluZyIgKSB7CgkJCQl0byA9ICQubW9iaWxlLnBhdGguc3RyaXBIYXNoKCB0byApOwoJCQl9CgoJCQlpZiAoIHRvICkgewoJCQkJaGlzdG9yeSA9IHRoaXMuX2dldEhpc3RvcnkoKTsKCgkJCQkvLyBBdCB0aGlzIHBvaW50LCAndG8nIGNhbiBiZSBvbmUgb2YgMyB0aGluZ3MsIGEgY2FjaGVkIHBhZ2UKCQkJCS8vIGVsZW1lbnQgZnJvbSBhIGhpc3Rvcnkgc3RhY2sgZW50cnksIGFuIGlkLCBvciBzaXRlLXJlbGF0aXZlIC8KCQkJCS8vIGFic29sdXRlIFVSTC4gSWYgJ3RvJyBpcyBhbiBpZCwgd2UgbmVlZCB0byByZXNvbHZlIGl0IGFnYWluc3QKCQkJCS8vIHRoZSBkb2N1bWVudEJhc2UsIG5vdCB0aGUgbG9jYXRpb24uaHJlZiwgc2luY2UgdGhlIGhhc2hjaGFuZ2UKCQkJCS8vIGNvdWxkJ3ZlIGJlZW4gdGhlIHJlc3VsdCBvZiBhIGZvcndhcmQvYmFja3dhcmQgbmF2aWdhdGlvbgoJCQkJLy8gdGhhdCBjcm9zc2VzIGZyb20gYW4gZXh0ZXJuYWwgcGFnZS9kaWFsb2cgdG8gYW4gaW50ZXJuYWwKCQkJCS8vIHBhZ2UvZGlhbG9nLgoJCQkJLy8KCQkJCS8vIFRPRE8gbW92ZSBjaGVjayB0byBoaXN0b3J5IG9iamVjdCBvciBwYXRoIG9iamVjdD8KCQkJCXRvID0gISQubW9iaWxlLnBhdGguaXNQYXRoKCB0byApID8gKCAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgdG8sIHRoaXMuX2dldERvY3VtZW50QmFzZSgpICkgKSA6IHRvOwoKCQkJCS8vIElmIHdlJ3JlIGFib3V0IHRvIGdvIHRvIGFuIGluaXRpYWwgVVJMIHRoYXQgY29udGFpbnMgYQoJCQkJLy8gcmVmZXJlbmNlIHRvIGEgbm9uLWV4aXN0ZW50IGludGVybmFsIHBhZ2UsIGdvIHRvIHRoZSBmaXJzdAoJCQkJLy8gcGFnZSBpbnN0ZWFkLiBXZSBrbm93IHRoYXQgdGhlIGluaXRpYWwgaGFzaCByZWZlcnMgdG8gYQoJCQkJLy8gbm9uLWV4aXN0ZW50IHBhZ2UsIGJlY2F1c2UgdGhlIGluaXRpYWwgaGFzaCBkaWQgbm90IGVuZAoJCQkJLy8gdXAgaW4gdGhlIGluaXRpYWwgaGlzdG9yeSBlbnRyeQoJCQkJLy8gVE9ETyBtb3ZlIGNoZWNrIHRvIGhpc3Rvcnkgb2JqZWN0PwoJCQkJaWYgKCB0byA9PT0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGhpc3RvcnkuaW5pdGlhbERzdCwgdGhpcy5fZ2V0RG9jdW1lbnRCYXNlKCkgKSAmJgoJCQkJCWhpc3Rvcnkuc3RhY2subGVuZ3RoICYmCgkJCQkJaGlzdG9yeS5zdGFja1swXS51cmwgIT09IGhpc3RvcnkuaW5pdGlhbERzdC5yZXBsYWNlKCAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5LCAiIiApICkgewoJCQkJCXRvID0gdGhpcy5fZ2V0SW5pdGlhbENvbnRlbnQoKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gdG8gfHwgdGhpcy5fZ2V0SW5pdGlhbENvbnRlbnQoKTsKCQl9LAoKCQlfaGFuZGxlRGlhbG9nOiBmdW5jdGlvbiggY2hhbmdlUGFnZU9wdGlvbnMsIGRhdGEgKSB7CgkJCXZhciB0bywgYWN0aXZlLCBhY3RpdmVDb250ZW50ID0gdGhpcy5nZXRBY3RpdmVQYWdlKCk7CgoJCQkvLyBJZiBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIG5vdCBhIGRpYWxvZyBza2lwIHRoZSBkaWFsb2cgYW5kIGNvbnRpbnVlCgkJCS8vIGluIHRoZSBzYW1lIGRpcmVjdGlvbgoJCQlpZiAoIGFjdGl2ZUNvbnRlbnQgJiYgIWFjdGl2ZUNvbnRlbnQuaGFzQ2xhc3MoICJ1aS1kaWFsb2ciICkgKSB7CgkJCQkvLyBkZXRlcm1pbmUgaWYgd2UncmUgaGVhZGluZyBmb3J3YXJkIG9yIGJhY2t3YXJkIGFuZCBjb250aW51ZQoJCQkJLy8gYWNjb3JkaW5nbHkgcGFzdCB0aGUgY3VycmVudCBkaWFsb2cKCQkJCWlmICggZGF0YS5kaXJlY3Rpb24gPT09ICJiYWNrIiApIHsKCQkJCQl0aGlzLmJhY2soKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5mb3J3YXJkKCk7CgkJCQl9CgoJCQkJLy8gcHJldmVudCBjaGFuZ2VQYWdlIGNhbGwKCQkJCXJldHVybiBmYWxzZTsKCQkJfSBlbHNlIHsKCQkJCS8vIGlmIHRoZSBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIGEgZGlhbG9nIGFuZCB3ZSdyZSBuYXZpZ2F0aW5nCgkJCQkvLyB0byBhIGRpYWxvZyB1c2UgdGhlIGRpYWxvZyBvYmplY3RlZCBzYXZlZCBpbiB0aGUgc3RhY2sKCQkJCXRvID0gZGF0YS5wYWdlVXJsOwoJCQkJYWN0aXZlID0gdGhpcy5fZ2V0QWN0aXZlSGlzdG9yeSgpOwoKCQkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHJvbGUsIHRyYW5zaXRpb24gYW5kIHJldmVyc2FsCgkJCQkvLyBhcyBtb3N0IG9mIHRoaXMgaXMgbG9zdCBieSB0aGUgZG9tQ2FjaGUgY2xlYW5pbmcKCQkJCSQuZXh0ZW5kKCBjaGFuZ2VQYWdlT3B0aW9ucywgewoJCQkJCXJvbGU6IGFjdGl2ZS5yb2xlLAoJCQkJCXRyYW5zaXRpb246IGFjdGl2ZS50cmFuc2l0aW9uLAoJCQkJCXJldmVyc2U6IGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIKCQkJCX0pOwoJCQl9CgoJCQlyZXR1cm4gdG87CgkJfSwKCgkJX2hhbmRsZU5hdmlnYXRlOiBmdW5jdGlvbiggdXJsLCBkYXRhICkgewoJCQkvL2ZpbmQgZmlyc3QgcGFnZSB2aWEgaGFzaAoJCQkvLyBUT0RPIHN0cmlwcGluZyB0aGUgaGFzaCB0d2ljZSB3aXRoIGhhbmRsZVVybAoJCQl2YXIgdG8gPSAkLm1vYmlsZS5wYXRoLnN0cmlwSGFzaCggdXJsICksIGhpc3RvcnkgPSB0aGlzLl9nZXRIaXN0b3J5KCksCgoJCQkJLy8gdHJhbnNpdGlvbiBpcyBmYWxzZSBpZiBpdCdzIHRoZSBmaXJzdCBwYWdlLCB1bmRlZmluZWQKCQkJCS8vIG90aGVyd2lzZSAoYW5kIG1heSBiZSBvdmVycmlkZGVuIGJ5IGRlZmF1bHQpCgkJCQl0cmFuc2l0aW9uID0gaGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDAgPyAibm9uZSIgOiB1bmRlZmluZWQsCgoJCQkJLy8gZGVmYXVsdCBvcHRpb25zIGZvciB0aGUgY2hhbmdQYWdlIGNhbGxzIG1hZGUgYWZ0ZXIgZXhhbWluaW5nCgkJCQkvLyB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgcGFnZSBhbmQgdGhlIGhhc2gsIE5PVEUgdGhhdCB0aGUKCQkJCS8vIHRyYW5zaXRpb24gaXMgZGVyaXZlZCBmcm9tIHRoZSBwcmV2aW91cyBoaXN0b3J5IGVudHJ5CgkJCQljaGFuZ2VQYWdlT3B0aW9ucyA9IHsKCQkJCQljaGFuZ2VIYXNoOiBmYWxzZSwKCQkJCQlmcm9tSGFzaENoYW5nZTogdHJ1ZSwKCQkJCQlyZXZlcnNlOiBkYXRhLmRpcmVjdGlvbiA9PT0gImJhY2siCgkJCQl9OwoKCQkJJC5leHRlbmQoIGNoYW5nZVBhZ2VPcHRpb25zLCBkYXRhLCB7CgkJCQl0cmFuc2l0aW9uOiAoIGhpc3RvcnkuZ2V0TGFzdCgpIHx8IHt9ICkudHJhbnNpdGlvbiB8fCB0cmFuc2l0aW9uCgkJCX0pOwoKCQkJLy8gVE9ETyBtb3ZlIHRvIF9oYW5kbGVEZXN0aW5hdGlvbiA/CgkJCS8vIElmIHRoaXMgaXNuJ3QgdGhlIGZpcnN0IHBhZ2UsIGlmIHRoZSBjdXJyZW50IHVybCBpcyBhIGRpYWxvZyBoYXNoCgkJCS8vIGtleSwgYW5kIHRoZSBpbml0aWFsIGRlc3RpbmF0aW9uIGlzbid0IGVxdWFsIHRvIHRoZSBjdXJyZW50IHRhcmdldAoJCQkvLyBwYWdlLCB1c2UgdGhlIHNwZWNpYWwgZGlhbG9nIGhhbmRsaW5nCgkJCWlmICggaGlzdG9yeS5hY3RpdmVJbmRleCA+IDAgJiYKCQkJCXRvLmluZGV4T2YoICQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgKSA+IC0xICYmCgkJCQloaXN0b3J5LmluaXRpYWxEc3QgIT09IHRvICkgewoKCQkJCXRvID0gdGhpcy5faGFuZGxlRGlhbG9nKCBjaGFuZ2VQYWdlT3B0aW9ucywgZGF0YSApOwoKCQkJCWlmICggdG8gPT09IGZhbHNlICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJdGhpcy5fY2hhbmdlQ29udGVudCggdGhpcy5faGFuZGxlRGVzdGluYXRpb24oIHRvICksIGNoYW5nZVBhZ2VPcHRpb25zICk7CgkJfSwKCgkJX2NoYW5nZUNvbnRlbnQ6IGZ1bmN0aW9uKCB0bywgb3B0cyApIHsKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggdG8sIG9wdHMgKTsKCQl9LAoKCQlfZ2V0QmFzZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5iYXNlOwoJCX0sCgoJCV9nZXROczogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5uczsKCQl9LAoKCQlfZW5oYW5jZTogZnVuY3Rpb24oIGNvbnRlbnQsIHJvbGUgKSB7CgkJCS8vIFRPRE8gY29uc2lkZXIgc3VwcG9ydGluZyBhIGN1c3RvbSBjYWxsYmFjaywgYW5kIHBhc3NpbmcgaW4KCQkJLy8gdGhlIHNldHRpbmdzIHdoaWNoIGluY2x1ZGVzIHRoZSByb2xlCgkJCXJldHVybiBjb250ZW50LnBhZ2UoeyByb2xlOiByb2xlIH0pOwoJCX0sCgoJCV9pbmNsdWRlOiBmdW5jdGlvbiggcGFnZSwgc2V0dGluZ3MgKSB7CgkJCS8vIGFwcGVuZCB0byBwYWdlIGFuZCBlbmhhbmNlCgkJCXBhZ2UuYXBwZW5kVG8oIHRoaXMuZWxlbWVudCApOwoKCQkJLy8gdXNlIHRoZSBwYWdlIHdpZGdldCB0byBlbmhhbmNlCgkJCXRoaXMuX2VuaGFuY2UoIHBhZ2UsIHNldHRpbmdzLnJvbGUgKTsKCgkJCS8vIHJlbW92ZSBwYWdlIG9uIGhpZGUKCQkJcGFnZS5wYWdlKCAiYmluZFJlbW92ZSIgKTsKCQl9LAoKCQlfZmluZDogZnVuY3Rpb24oIGFic1VybCApIHsKCQkJLy8gVE9ETyBjb25zaWRlciBzdXBwb3J0aW5nIGEgY3VzdG9tIGNhbGxiYWNrCgkJCXZhciBmaWxlVXJsID0gdGhpcy5fY3JlYXRlRmlsZVVybCggYWJzVXJsICksCgkJCQlkYXRhVXJsID0gdGhpcy5fY3JlYXRlRGF0YVVybCggYWJzVXJsICksCgkJCQlwYWdlLCBpbml0aWFsQ29udGVudCA9IHRoaXMuX2dldEluaXRpYWxDb250ZW50KCk7CgoJCQkvLyBDaGVjayB0byBzZWUgaWYgdGhlIHBhZ2UgYWxyZWFkeSBleGlzdHMgaW4gdGhlIERPTS4KCQkJLy8gTk9URSBkbyBfbm90XyB1c2UgdGhlIDpqcW1EYXRhIHBzZXVkbyBzZWxlY3RvciBiZWNhdXNlIHBhcmVudGhlc2lzCgkJCS8vICAgICAgYXJlIGEgdmFsaWQgdXJsIGNoYXIgYW5kIGl0IGJyZWFrcyBvbiB0aGUgZmlyc3Qgb2NjdXJlbmNlCgkJCXBhZ2UgPSB0aGlzLmVsZW1lbnQKCQkJCS5jaGlsZHJlbiggIltkYXRhLSIgKyB0aGlzLl9nZXROcygpICsidXJsPSciICsgZGF0YVVybCArICInXSIgKTsKCgkJCS8vIElmIHdlIGZhaWxlZCB0byBmaW5kIHRoZSBwYWdlLCBjaGVjayB0byBzZWUgaWYgdGhlIHVybCBpcyBhCgkJCS8vIHJlZmVyZW5jZSB0byBhbiBlbWJlZGRlZCBwYWdlLiBJZiBzbywgaXQgbWF5IGhhdmUgYmVlbiBkeW5hbWljYWxseQoJCQkvLyBpbmplY3RlZCBieSBhIGRldmVsb3BlciwgaW4gd2hpY2ggY2FzZSBpdCB3b3VsZCBiZSBsYWNraW5nIGEKCQkJLy8gZGF0YS11cmwgYXR0cmlidXRlIGFuZCBpbiBuZWVkIG9mIGVuaGFuY2VtZW50LgoJCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICYmIGRhdGFVcmwgJiYgISQubW9iaWxlLnBhdGguaXNQYXRoKCBkYXRhVXJsICkgKSB7CgkJCQlwYWdlID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAkLm1vYmlsZS5wYXRoLmhhc2hUb1NlbGVjdG9yKCIjIiArIGRhdGFVcmwpICkKCQkJCQkuYXR0ciggImRhdGEtIiArIHRoaXMuX2dldE5zKCkgKyAidXJsIiwgZGF0YVVybCApCgkJCQkJLmpxbURhdGEoICJ1cmwiLCBkYXRhVXJsICk7CgkJCX0KCgkJCS8vIElmIHdlIGZhaWxlZCB0byBmaW5kIGEgcGFnZSBpbiB0aGUgRE9NLCBjaGVjayB0aGUgVVJMIHRvIHNlZSBpZiBpdAoJCQkvLyByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIGFwcGxpY2F0aW9uLiBBbHNvIGNoZWNrIHRvIG1ha2Ugc3VyZQoJCQkvLyBvdXIgY2FjaGVkLWZpcnN0LXBhZ2UgaXMgYWN0dWFsbHkgaW4gdGhlIERPTS4gU29tZSB1c2VyIGRlcGxveWVkCgkJCS8vIGFwcHMgYXJlIHBydW5pbmcgdGhlIGZpcnN0IHBhZ2UgZnJvbSB0aGUgRE9NIGZvciB2YXJpb3VzIHJlYXNvbnMuCgkJCS8vIFdlIGNoZWNrIGZvciB0aGlzIGNhc2UgaGVyZSBiZWNhdXNlIHdlIGRvbid0IHdhbnQgYSBmaXJzdC1wYWdlIHdpdGgKCQkJLy8gYW4gaWQgZmFsbGluZyB0aHJvdWdoIHRvIHRoZSBub24tZXhpc3RlbnQgZW1iZWRkZWQgcGFnZSBlcnJvciBjYXNlLgoJCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICYmCgkJCQkkLm1vYmlsZS5wYXRoLmlzRmlyc3RQYWdlVXJsKCBmaWxlVXJsICkgJiYKCQkJCWluaXRpYWxDb250ZW50ICYmCgkJCQlpbml0aWFsQ29udGVudC5wYXJlbnQoKS5sZW5ndGggKSB7CgkJCQlwYWdlID0gJCggaW5pdGlhbENvbnRlbnQgKTsKCQkJfQoKCQkJcmV0dXJuIHBhZ2U7CgkJfSwKCgkJX2dldExvYWRlcjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5sb2FkaW5nKCk7CgkJfSwKCgkJX3Nob3dMb2FkaW5nOiBmdW5jdGlvbiggZGVsYXksIHRoZW1lLCBtc2csIHRleHRvbmx5ICkgewoJCQkvLyBUaGlzIGNvbmZpZ3VyYWJsZSB0aW1lb3V0IGFsbG93cyBjYWNoZWQgcGFnZXMgYSBicmllZgoJCQkvLyBkZWxheSB0byBsb2FkIHdpdGhvdXQgc2hvd2luZyBhIG1lc3NhZ2UKCQkJaWYgKCB0aGlzLl9sb2FkTXNnICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl0aGlzLl9sb2FkTXNnID0gc2V0VGltZW91dCgkLnByb3h5KGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fZ2V0TG9hZGVyKCkubG9hZGVyKCAic2hvdyIsIHRoZW1lLCBtc2csIHRleHRvbmx5ICk7CgkJCQl0aGlzLl9sb2FkTXNnID0gMDsKCQkJfSwgdGhpcyksIGRlbGF5ICk7CgkJfSwKCgkJX2hpZGVMb2FkaW5nOiBmdW5jdGlvbigpIHsKCQkJLy8gU3RvcCBtZXNzYWdlIHNob3cgdGltZXIKCQkJY2xlYXJUaW1lb3V0KCB0aGlzLl9sb2FkTXNnICk7CgkJCXRoaXMuX2xvYWRNc2cgPSAwOwoKCQkJLy8gSGlkZSBsb2FkaW5nIG1lc3NhZ2UKCQkJdGhpcy5fZ2V0TG9hZGVyKCkubG9hZGVyKCAiaGlkZSIgKTsKCQl9LAoKCQlfc2hvd0Vycm9yOiBmdW5jdGlvbigpIHsKCQkJLy8gbWFrZSBzdXJlIHRvIHJlbW92ZSB0aGUgY3VycmVudCBsb2FkaW5nIG1lc3NhZ2UKCQkJdGhpcy5faGlkZUxvYWRpbmcoKTsKCgkJCS8vIHNob3cgdGhlIGVycm9yIG1lc3NhZ2UKCQkJdGhpcy5fc2hvd0xvYWRpbmcoIDAsICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlVGhlbWUsICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlLCB0cnVlICk7CgoJCQkvLyBoaWRlIHRoZSBlcnJvciBtZXNzYWdlIGFmdGVyIGEgZGVsYXkKCQkJLy8gVE9ETyBjb25maWd1cmF0aW9uCgkJCXNldFRpbWVvdXQoICQucHJveHkodGhpcywgIl9oaWRlTG9hZGluZyIpLCAxNTAwICk7CgkJfSwKCgkJX3BhcnNlOiBmdW5jdGlvbiggaHRtbCwgZmlsZVVybCApIHsKCQkJLy8gVE9ETyBjb25zaWRlciBhbGxvd2luZyBjdXN0b21pemF0aW9uIG9mIHRoaXMgbWV0aG9kLiBJdCdzIHZlcnkgSlFNIHNwZWNpZmljCgkJCXZhciBwYWdlLCBhbGwgPSAkKCAiPGRpdj48L2Rpdj4iICk7CgoJCQkvL3dvcmthcm91bmQgdG8gYWxsb3cgc2NyaXB0cyB0byBleGVjdXRlIHdoZW4gaW5jbHVkZWQgaW4gcGFnZSBkaXZzCgkJCWFsbC5nZXQoIDAgKS5pbm5lckhUTUwgPSBodG1sOwoKCQkJcGFnZSA9IGFsbC5maW5kKCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKS5maXJzdCgpOwoKCQkJLy9pZiBwYWdlIGVsZW0gY291bGRuJ3QgYmUgZm91bmQsIGNyZWF0ZSBvbmUgYW5kIGluc2VydCB0aGUgYm9keSBlbGVtZW50J3MgY29udGVudHMKCQkJaWYgKCAhcGFnZS5sZW5ndGggKSB7CgkJCQlwYWdlID0gJCggIjxkaXYgZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJyb2xlPSdwYWdlJz4iICsKCQkJCQkoIGh0bWwuc3BsaXQoIC88XC8/Ym9keVtePl0qPi9nbWkgKVsxXSB8fCAiIiApICsKCQkJCQkiPC9kaXY+IiApOwoJCQl9CgoJCQkvLyBUT0RPIHRhZ2dpbmcgYSBwYWdlIHdpdGggZXh0ZXJuYWwgdG8gbWFrZSBzdXJlIHRoYXQgZW1iZWRkZWQgcGFnZXMgYXJlbid0CgkJCS8vIHJlbW92ZWQgYnkgdGhlIHZhcmlvdXMgcGFnZSBoYW5kbGluZyBjb2RlIGlzIGJhZC4gSGF2aW5nIHBhZ2UgaGFuZGxpbmcgY29kZQoJCQkvLyBpbiBtYW55IHBsYWNlcyBpcyBiYWQuIFNvbHV0aW9ucyBwb3N0IDEuMAoJCQlwYWdlLmF0dHIoICJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInVybCIsICQubW9iaWxlLnBhdGguY29udmVydFVybFRvRGF0YVVybChmaWxlVXJsKSApCgkJCQkuYXR0ciggImRhdGEtIiArIHRoaXMuX2dldE5zKCkgKyAiZXh0ZXJuYWwtcGFnZSIsIHRydWUgKTsKCgkJCXJldHVybiBwYWdlOwoJCX0sCgoJCV9zZXRMb2FkZWRUaXRsZTogZnVuY3Rpb24oIHBhZ2UsIGh0bWwgKSB7CgkJCS8vcGFnZSB0aXRsZSByZWdleHAKCQkJdmFyIG5ld1BhZ2VUaXRsZSA9IGh0bWwubWF0Y2goIC88dGl0bGVbXj5dKj4oW148XSopLyApICYmIFJlZ0V4cC4kMTsKCgkJCWlmICggbmV3UGFnZVRpdGxlICYmICFwYWdlLmpxbURhdGEoInRpdGxlIikgKSB7CgkJCQluZXdQYWdlVGl0bGUgPSAkKCAiPGRpdj4iICsgbmV3UGFnZVRpdGxlICsgIjwvZGl2PiIgKS50ZXh0KCk7CgkJCQlwYWdlLmpxbURhdGEoICJ0aXRsZSIsIG5ld1BhZ2VUaXRsZSApOwoJCQl9CgkJfSwKCgkJX2lzUmV3cml0YWJsZUJhc2VUYWc6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuZHluYW1pY0Jhc2VFbmFibGVkICYmICEkLnN1cHBvcnQuZHluYW1pY0Jhc2VUYWc7CgkJfSwKCgkJX2NyZWF0ZURhdGFVcmw6IGZ1bmN0aW9uKCBhYnNvbHV0ZVVybCApIHsKCQkJcmV0dXJuICQubW9iaWxlLnBhdGguY29udmVydFVybFRvRGF0YVVybCggYWJzb2x1dGVVcmwgKTsKCQl9LAoKCQlfY3JlYXRlRmlsZVVybDogZnVuY3Rpb24oIGFic29sdXRlVXJsICkgewoJCQlyZXR1cm4gJC5tb2JpbGUucGF0aC5nZXRGaWxlUGF0aCggYWJzb2x1dGVVcmwgKTsKCQl9LAoKCQlfdHJpZ2dlcldpdGhEZXByZWNhdGVkOiBmdW5jdGlvbiggbmFtZSwgZGF0YSwgcGFnZSApIHsKCQkJdmFyIGRlcHJlY2F0ZWRFdmVudCA9ICQuRXZlbnQoICJwYWdlIiArIG5hbWUgKSwKCQkJCW5ld0V2ZW50ID0gJC5FdmVudCggdGhpcy53aWRnZXROYW1lICsgbmFtZSApOwoKCQkJLy8gREVQUkVDQVRFRAoJCQkvLyB0cmlnZ2VyIHRoZSBvbGQgZGVwcmVjYXRlZCBldmVudCBvbiB0aGUgcGFnZSBpZiBpdCdzIHByb3ZpZGVkCgkJCSggcGFnZSB8fCB0aGlzLmVsZW1lbnQgKS50cmlnZ2VyKCBkZXByZWNhdGVkRXZlbnQsIGRhdGEgKTsKCgkJCS8vIHVzZSB0aGUgd2lkZ2V0IHRyaWdnZXIgbWV0aG9kIGZvciB0aGUgbmV3IGNvbnRlbnQqIGV2ZW50CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBuZXdFdmVudCwgZGF0YSApOwoKCQkJcmV0dXJuIHsKCQkJCWRlcHJlY2F0ZWRFdmVudDogZGVwcmVjYXRlZEV2ZW50LAoJCQkJZXZlbnQ6IG5ld0V2ZW50CgkJCX07CgkJfSwKCgkJLy8gVE9ETyBpdCB3b3VsZCBiZSBuaWNlIHRvIHNwbGl0IHRoaXMgdXAgbW9yZSBidXQgZXZlcnl0aGluZyBhcHBlYXJzIHRvIGJlICJvbmUgb2ZmIgoJCS8vICAgICAgb3IgcmVxdWlyZSBvcmRlcmluZyBzdWNoIHRoYXQgb3RoZXIgYml0cyBhcmUgc3ByaW5rbGVkIGluIGJldHdlZW4gcGFydHMgdGhhdAoJCS8vICAgICAgY291bGQgYmUgYWJzdHJhY3RlZCBvdXQgYXMgYSBncm91cAoJCV9sb2FkU3VjY2VzczogZnVuY3Rpb24oIGFic1VybCwgdHJpZ2dlckRhdGEsIHNldHRpbmdzLCBkZWZlcnJlZCApIHsKCQkJdmFyIGZpbGVVcmwgPSB0aGlzLl9jcmVhdGVGaWxlVXJsKCBhYnNVcmwgKSwKCQkJCWRhdGFVcmwgPSB0aGlzLl9jcmVhdGVEYXRhVXJsKCBhYnNVcmwgKTsKCgkJCXJldHVybiAkLnByb3h5KGZ1bmN0aW9uKCBodG1sLCB0ZXh0U3RhdHVzLCB4aHIgKSB7CgkJCQkvL3ByZS1wYXJzZSBodG1sIHRvIGNoZWNrIGZvciBhIGRhdGEtdXJsLAoJCQkJLy91c2UgaXQgYXMgdGhlIG5ldyBmaWxlVXJsLCBiYXNlIHBhdGgsIGV0YwoJCQkJdmFyIGNvbnRlbnQsCgoJCQkJCS8vIFRPRE8gaGFuZGxlIGRpYWxvZ3MgYWdhaW4KCQkJCQlwYWdlRWxlbVJlZ2V4ID0gbmV3IFJlZ0V4cCggIig8W14+XStcXGJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInJvbGU9W1wiJ10/cGFnZVtcIiddP1tePl0qPikiICksCgoJCQkJCWRhdGFVcmxSZWdleCA9IG5ldyBSZWdFeHAoICJcXGJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInVybD1bXCInXT8oW15cIic+XSopW1wiJ10/IiApOwoKCQkJCS8vIGRhdGEtdXJsIG11c3QgYmUgcHJvdmlkZWQgZm9yIHRoZSBiYXNlIHRhZyBzbyByZXNvdXJjZSByZXF1ZXN0cwoJCQkJLy8gY2FuIGJlIGRpcmVjdGVkIHRvIHRoZSBjb3JyZWN0IHVybC4gbG9hZGluZyBpbnRvIGEgdGVtcHJvcmFyeQoJCQkJLy8gZWxlbWVudCBtYWtlcyB0aGVzZSByZXF1ZXN0cyBpbW1lZGlhdGVseQoJCQkJaWYgKCBwYWdlRWxlbVJlZ2V4LnRlc3QoIGh0bWwgKSAmJgoJCQkJCVJlZ0V4cC4kMSAmJgoJCQkJCWRhdGFVcmxSZWdleC50ZXN0KCBSZWdFeHAuJDEgKSAmJgoJCQkJCVJlZ0V4cC4kMSApIHsKCQkJCQlmaWxlVXJsID0gJC5tb2JpbGUucGF0aC5nZXRGaWxlUGF0aCggJCgiPGRpdj4iICsgUmVnRXhwLiQxICsgIjwvZGl2PiIpLnRleHQoKSApOwoJCQkJfQoKCQkJCS8vZG9udCB1cGRhdGUgdGhlIGJhc2UgdGFnIGlmIHdlIGFyZSBwcmVmZXRjaGluZwoJCQkJaWYgKCBzZXR0aW5ncy5wcmVmZXRjaCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXRoaXMuX2dldEJhc2UoKS5zZXQoIGZpbGVVcmwgKTsKCQkJCX0KCgkJCQljb250ZW50ID0gdGhpcy5fcGFyc2UoIGh0bWwsIGZpbGVVcmwgKTsKCgkJCQl0aGlzLl9zZXRMb2FkZWRUaXRsZSggY29udGVudCwgaHRtbCApOwoKCQkJCS8vIEFkZCB0aGUgY29udGVudCByZWZlcmVuY2UgYW5kIHhociB0byBvdXIgdHJpZ2dlckRhdGEuCgkJCQl0cmlnZ2VyRGF0YS54aHIgPSB4aHI7CgkJCQl0cmlnZ2VyRGF0YS50ZXh0U3RhdHVzID0gdGV4dFN0YXR1czsKCgkJCQkvLyBERVBSRUNBVEVECgkJCQl0cmlnZ2VyRGF0YS5wYWdlID0gY29udGVudDsKCgkJCQl0cmlnZ2VyRGF0YS5jb250ZW50ID0gY29udGVudDsKCgkJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJCS8vIE5vdGUgdGhhdCBpdCBpcyB0aGUgcmVzcG9uc2liaWxpdHkgb2YgdGhlIGxpc3RlbmVyL2hhbmRsZXIKCQkJCS8vIHRoYXQgY2FsbGVkIHByZXZlbnREZWZhdWx0KCksIHRvIHJlc29sdmUvcmVqZWN0IHRoZQoJCQkJLy8gZGVmZXJyZWQgb2JqZWN0IHdpdGhpbiB0aGUgdHJpZ2dlckRhdGEuCgkJCQlpZiAoICF0aGlzLl90cmlnZ2VyKCAibG9hZCIsIHVuZGVmaW5lZCwgdHJpZ2dlckRhdGEgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gcmV3cml0ZSBzcmMgYW5kIGhyZWYgYXR0cnMgdG8gdXNlIGEgYmFzZSB1cmwgaWYgdGhlIGJhc2UgdGFnIHdvbid0IHdvcmsKCQkJCWlmICggdGhpcy5faXNSZXdyaXRhYmxlQmFzZVRhZygpICYmIGNvbnRlbnQgKSB7CgkJCQkJdGhpcy5fZ2V0QmFzZSgpLnJld3JpdGUoIGZpbGVVcmwsIGNvbnRlbnQgKTsKCQkJCX0KCgkJCQl0aGlzLl9pbmNsdWRlKCBjb250ZW50LCBzZXR0aW5ncyApOwoKCQkJCS8vIEVuaGFuY2luZyB0aGUgY29udGVudCBtYXkgcmVzdWx0IGluIG5ldyBkaWFsb2dzL3N1YiBjb250ZW50IGJlaW5nIGluc2VydGVkCgkJCQkvLyBpbnRvIHRoZSBET00uIElmIHRoZSBvcmlnaW5hbCBhYnNVcmwgcmVmZXJzIHRvIGEgc3ViLWNvbnRlbnQsIHRoYXQgaXMgdGhlCgkJCQkvLyByZWFsIGNvbnRlbnQgd2UgYXJlIGludGVyZXN0ZWQgaW4uCgkJCQlpZiAoIGFic1VybC5pbmRleE9mKCAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICkgPiAtMSApIHsKCQkJCQljb250ZW50ID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiW2RhdGEtIiArIHRoaXMuX2dldE5zKCkgKyJ1cmw9JyIgKyBkYXRhVXJsICsgIiddIiApOwoJCQkJfQoKCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoJCQkJCXRoaXMuX2hpZGVMb2FkaW5nKCk7CgkJCQl9CgoJCQkJLy8gQkVHSU4gREVQUkVDQVRFRCAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgY29udGVudCBsb2FkZWQgc3VjY2Vzc2Z1bGx5LgoJCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJwYWdlbG9hZCIgKTsKCQkJCS8vIEVORCBERVBSRUNBVEVEIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgoJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBzZXR0aW5ncywgY29udGVudCApOwoJCQl9LCB0aGlzKTsKCQl9LAoKCQlfbG9hZERlZmF1bHRzOiB7CgkJCXR5cGU6ICJnZXQiLAoJCQlkYXRhOiB1bmRlZmluZWQsCgoJCQkvLyBERVBSRUNBVEVECgkJCXJlbG9hZFBhZ2U6IGZhbHNlLAoKCQkJcmVsb2FkOiBmYWxzZSwKCgkJCS8vIEJ5IGRlZmF1bHQgd2UgcmVseSBvbiB0aGUgcm9sZSBkZWZpbmVkIGJ5IHRoZSBAZGF0YS1yb2xlIGF0dHJpYnV0ZS4KCQkJcm9sZTogdW5kZWZpbmVkLAoKCQkJc2hvd0xvYWRNc2c6IGZhbHNlLAoKCQkJLy8gVGhpcyBkZWxheSBhbGxvd3MgbG9hZHMgdGhhdCBwdWxsIGZyb20gYnJvd3NlciBjYWNoZSB0bwoJCQkvLyBvY2N1ciB3aXRob3V0IHNob3dpbmcgdGhlIGxvYWRpbmcgbWVzc2FnZS4KCQkJbG9hZE1zZ0RlbGF5OiA1MAoJCX0sCgoJCWxvYWQ6IGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMgKSB7CgkJCS8vIFRoaXMgZnVuY3Rpb24gdXNlcyBkZWZlcnJlZCBub3RpZmljYXRpb25zIHRvIGxldCBjYWxsZXJzCgkJCS8vIGtub3cgd2hlbiB0aGUgY29udGVudCBpcyBkb25lIGxvYWRpbmcsIG9yIGlmIGFuIGVycm9yIGhhcyBvY2N1cnJlZC4KCQkJdmFyIGRlZmVycmVkID0gKCBvcHRpb25zICYmIG9wdGlvbnMuZGVmZXJyZWQgKSB8fCAkLkRlZmVycmVkKCksCgoJCQkJLy8gVGhlIGRlZmF1bHQgbG9hZCBvcHRpb25zIHdpdGggb3ZlcnJpZGVzIHNwZWNpZmllZCBieSB0aGUgY2FsbGVyLgoJCQkJc2V0dGluZ3MgPSAkLmV4dGVuZCgge30sIHRoaXMuX2xvYWREZWZhdWx0cywgb3B0aW9ucyApLAoKCQkJCS8vIFRoZSBET00gZWxlbWVudCBmb3IgdGhlIGNvbnRlbnQgYWZ0ZXIgaXQgaGFzIGJlZW4gbG9hZGVkLgoJCQkJY29udGVudCA9IG51bGwsCgoJCQkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBwYXNzZWQgaW50byB0aGUgZnVuY3Rpb24uIFRoaXMKCQkJCS8vIHZlcnNpb24gb2YgdGhlIFVSTCBtYXkgY29udGFpbiBkaWFsb2cvc3ViY29udGVudCBwYXJhbXMgaW4gaXQuCgkJCQlhYnNVcmwgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCB0aGlzLl9maW5kQmFzZVdpdGhEZWZhdWx0KCkgKSwKCQkJCWZpbGVVcmwsIGRhdGFVcmwsIHBibEV2ZW50LCB0cmlnZ2VyRGF0YTsKCgkJCS8vIERFUFJFQ0FURUQgcmVsb2FkUGFnZQoJCQlzZXR0aW5ncy5yZWxvYWQgPSBzZXR0aW5ncy5yZWxvYWRQYWdlOwoKCQkJLy8gSWYgdGhlIGNhbGxlciBwcm92aWRlZCBkYXRhLCBhbmQgd2UncmUgdXNpbmcgImdldCIgcmVxdWVzdCwKCQkJLy8gYXBwZW5kIHRoZSBkYXRhIHRvIHRoZSBVUkwuCgkJCWlmICggc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAiZ2V0IiApIHsKCQkJCWFic1VybCA9ICQubW9iaWxlLnBhdGguYWRkU2VhcmNoUGFyYW1zKCBhYnNVcmwsIHNldHRpbmdzLmRhdGEgKTsKCQkJCXNldHRpbmdzLmRhdGEgPSB1bmRlZmluZWQ7CgkJCX0KCgkJCS8vIElmIHRoZSBjYWxsZXIgaXMgdXNpbmcgYSAicG9zdCIgcmVxdWVzdCwgcmVsb2FkIG11c3QgYmUgdHJ1ZQoJCQlpZiAoIHNldHRpbmdzLmRhdGEgJiYgc2V0dGluZ3MudHlwZSA9PT0gInBvc3QiICkgewoJCQkJc2V0dGluZ3MucmVsb2FkID0gdHJ1ZTsKCQkJfQoKCQkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBtaW51cyBhbnkgZGlhbG9nL3N1YmNvbnRlbnQgcGFyYW1zLgoJCQkvLyBJbiBvdGhlcndvcmRzIHRoZSByZWFsIFVSTCBvZiB0aGUgY29udGVudCB0byBiZSBsb2FkZWQuCgkJCWZpbGVVcmwgPSB0aGlzLl9jcmVhdGVGaWxlVXJsKCBhYnNVcmwgKTsKCgkJCS8vIFRoZSB2ZXJzaW9uIG9mIHRoZSBVcmwgYWN0dWFsbHkgc3RvcmVkIGluIHRoZSBkYXRhLXVybCBhdHRyaWJ1dGUgb2YKCQkJLy8gdGhlIGNvbnRlbnQuIEZvciBlbWJlZGRlZCBjb250ZW50LCBpdCBpcyBqdXN0IHRoZSBpZCBvZiB0aGUgcGFnZS4gRm9yCgkJCS8vIGNvbnRlbnQgd2l0aGluIHRoZSBzYW1lIGRvbWFpbiBhcyB0aGUgZG9jdW1lbnQgYmFzZSwgaXQgaXMgdGhlIHNpdGUKCQkJLy8gcmVsYXRpdmUgcGF0aC4gRm9yIGNyb3NzLWRvbWFpbiBjb250ZW50IChQaG9uZSBHYXAgb25seSkgdGhlIGVudGlyZQoJCQkvLyBhYnNvbHV0ZSBVcmwgaXMgdXNlZCB0byBsb2FkIHRoZSBjb250ZW50LgoJCQlkYXRhVXJsID0gdGhpcy5fY3JlYXRlRGF0YVVybCggYWJzVXJsICk7CgoJCQljb250ZW50ID0gdGhpcy5fZmluZCggYWJzVXJsICk7CgoJCQkvLyBJZiBpdCBpc24ndCBhIHJlZmVyZW5jZSB0byB0aGUgZmlyc3QgY29udGVudCBhbmQgcmVmZXJzIHRvIG1pc3NpbmcKCQkJLy8gZW1iZWRkZWQgY29udGVudCByZWplY3QgdGhlIGRlZmVycmVkIGFuZCByZXR1cm4KCQkJaWYgKCBjb250ZW50Lmxlbmd0aCA9PT0gMCAmJgoJCQkJJC5tb2JpbGUucGF0aC5pc0VtYmVkZGVkUGFnZShmaWxlVXJsKSAmJgoJCQkJISQubW9iaWxlLnBhdGguaXNGaXJzdFBhZ2VVcmwoZmlsZVVybCkgKSB7CgkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgc2V0dGluZ3MgKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gUmVzZXQgYmFzZSB0byB0aGUgZGVmYXVsdCBkb2N1bWVudCBiYXNlCgkJCS8vIFRPRE8gZmlndXJlIG91dCB3aHkgd2UgZG9lIHRoaXMKCQkJdGhpcy5fZ2V0QmFzZSgpLnJlc2V0KCk7CgoJCQkvLyBJZiB0aGUgY29udGVudCB3ZSBhcmUgaW50ZXJlc3RlZCBpbiBpcyBhbHJlYWR5IGluIHRoZSBET00sCgkJCS8vIGFuZCB0aGUgY2FsbGVyIGRpZCBub3QgaW5kaWNhdGUgdGhhdCB3ZSBzaG91bGQgZm9yY2UgYQoJCQkvLyByZWxvYWQgb2YgdGhlIGZpbGUsIHdlIGFyZSBkb25lLiBSZXNvbHZlIHRoZSBkZWZlcnJyZWQgc28gdGhhdAoJCQkvLyB1c2VycyBjYW4gYmluZCB0byAuZG9uZSBvbiB0aGUgcHJvbWlzZQoJCQlpZiAoIGNvbnRlbnQubGVuZ3RoICYmICFzZXR0aW5ncy5yZWxvYWQgKSB7CgkJCQl0aGlzLl9lbmhhbmNlKCBjb250ZW50LCBzZXR0aW5ncy5yb2xlICk7CgkJCQlkZWZlcnJlZC5yZXNvbHZlKCBhYnNVcmwsIHNldHRpbmdzLCBjb250ZW50ICk7CgoJCQkJLy9pZiB3ZSBhcmUgcmVsb2FkaW5nIHRoZSBjb250ZW50IG1ha2Ugc3VyZSB3ZSB1cGRhdGUKCQkJCS8vIHRoZSBiYXNlIGlmIGl0cyBub3QgYSBwcmVmZXRjaAoJCQkJaWYgKCAhc2V0dGluZ3MucHJlZmV0Y2ggKSB7CgkJCQkJdGhpcy5fZ2V0QmFzZSgpLnNldCh1cmwpOwoJCQkJfQoKCQkJCXJldHVybjsKCQkJfQoKCQkJdHJpZ2dlckRhdGEgPSB7CgkJCQl1cmw6IHVybCwKCQkJCWFic1VybDogYWJzVXJsLAoJCQkJZGF0YVVybDogZGF0YVVybCwKCQkJCWRlZmVycmVkOiBkZWZlcnJlZCwKCQkJCW9wdGlvbnM6IHNldHRpbmdzCgkJCX07CgoJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gbG9hZCBjb250ZW50LgoJCQlwYmxFdmVudCA9IHRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggImJlZm9yZWxvYWQiLCB0cmlnZ2VyRGF0YSApOwoKCQkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJCWlmICggcGJsRXZlbnQuZGVwcmVjYXRlZEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8CgkJCQlwYmxFdmVudC5ldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCQkJCXRoaXMuX3Nob3dMb2FkaW5nKCBzZXR0aW5ncy5sb2FkTXNnRGVsYXkgKTsKCQkJfQoKCQkJLy8gUmVzZXQgYmFzZSB0byB0aGUgZGVmYXVsdCBkb2N1bWVudCBiYXNlLgoJCQkvLyBvbmx5IHJlc2V0IGlmIHdlIGFyZSBub3QgcHJlZmV0Y2hpbmcKCQkJaWYgKCBzZXR0aW5ncy5wcmVmZXRjaCA9PT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fZ2V0QmFzZSgpLnJlc2V0KCk7CgkJCX0KCgkJCWlmICggISggJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzIHx8CgkJCQkkLm1vYmlsZS5wYXRoLmlzU2FtZURvbWFpbigkLm1vYmlsZS5wYXRoLmRvY3VtZW50VXJsLCBhYnNVcmwgKSApICkgewoJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIHNldHRpbmdzICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIExvYWQgdGhlIG5ldyBjb250ZW50LgoJCQkkLmFqYXgoewoJCQkJdXJsOiBmaWxlVXJsLAoJCQkJdHlwZTogc2V0dGluZ3MudHlwZSwKCQkJCWRhdGE6IHNldHRpbmdzLmRhdGEsCgkJCQljb250ZW50VHlwZTogc2V0dGluZ3MuY29udGVudFR5cGUsCgkJCQlkYXRhVHlwZTogImh0bWwiLAoJCQkJc3VjY2VzczogdGhpcy5fbG9hZFN1Y2Nlc3MoIGFic1VybCwgdHJpZ2dlckRhdGEsIHNldHRpbmdzLCBkZWZlcnJlZCApLAoJCQkJZXJyb3I6IHRoaXMuX2xvYWRFcnJvciggYWJzVXJsLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MsIGRlZmVycmVkICkKCQkJfSk7CgkJfSwKCgkJX2xvYWRFcnJvcjogZnVuY3Rpb24oIGFic1VybCwgdHJpZ2dlckRhdGEsIHNldHRpbmdzLCBkZWZlcnJlZCApIHsKCQkJcmV0dXJuICQucHJveHkoZnVuY3Rpb24oIHhociwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24gKSB7CgkJCQkvL3NldCBiYXNlIGJhY2sgdG8gY3VycmVudCBwYXRoCgkJCQl0aGlzLl9nZXRCYXNlKCkuc2V0KCAkLm1vYmlsZS5wYXRoLmdldCgpICk7CgoJCQkJLy8gQWRkIGVycm9yIGluZm8gdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgkJCQl0cmlnZ2VyRGF0YS5lcnJvclRocm93biA9IGVycm9yVGhyb3duOwoKCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgcGFnZSBsb2FkIGZhaWxlZC4KCQkJCXZhciBwbGZFdmVudCA9IHRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggImxvYWRmYWlsZWQiLCB0cmlnZ2VyRGF0YSApOwoKCQkJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCQkJLy8gTm90ZSB0aGF0IGl0IGlzIHRoZSByZXNwb25zaWJpbGl0eSBvZiB0aGUgbGlzdGVuZXIvaGFuZGxlcgoJCQkJLy8gdGhhdCBjYWxsZWQgcHJldmVudERlZmF1bHQoKSwgdG8gcmVzb2x2ZS9yZWplY3QgdGhlCgkJCQkvLyBkZWZlcnJlZCBvYmplY3Qgd2l0aGluIHRoZSB0cmlnZ2VyRGF0YS4KCQkJCWlmICggcGxmRXZlbnQuZGVwcmVjYXRlZEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8CgkJCQkJcGxmRXZlbnQuZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoJCQkJCXRoaXMuX3Nob3dFcnJvcigpOwoJCQkJfQoKCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBzZXR0aW5ncyApOwoJCQl9LCB0aGlzKTsKCQl9LAoKCQlfZ2V0VHJhbnNpdGlvbkhhbmRsZXI6IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCQl0cmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24oIHRyYW5zaXRpb24gKTsKCgkJCS8vZmluZCB0aGUgdHJhbnNpdGlvbiBoYW5kbGVyIGZvciB0aGUgc3BlY2lmaWVkIHRyYW5zaXRpb24uIElmIHRoZXJlCgkJCS8vaXNuJ3Qgb25lIGluIG91ciB0cmFuc2l0aW9uSGFuZGxlcnMgZGljdGlvbmFyeSwgdXNlIHRoZSBkZWZhdWx0IG9uZS4KCQkJLy9jYWxsIHRoZSBoYW5kbGVyIGltbWVkaWF0ZWx5IHRvIGtpY2stb2ZmIHRoZSB0cmFuc2l0aW9uLgoJCQlyZXR1cm4gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzWyB0cmFuc2l0aW9uIF0gfHwgJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyOwoJCX0sCgoJCS8vIFRPRE8gbW92ZSBpbnRvIHRyYW5zaXRpb24gaGFuZGxlcnM/CgkJX3RyaWdnZXJDc3NUcmFuc2l0aW9uRXZlbnRzOiBmdW5jdGlvbiggdG8sIGZyb20sIHByZWZpeCApIHsKCQkJdmFyIHNhbWVQYWdlID0gZmFsc2U7CgoJCQlwcmVmaXggPSBwcmVmaXggfHwgIiI7CgoJCQkvLyBUT0RPIGRlY2lkZSBpZiB0aGVzZSBldmVudHMgc2hvdWxkIGluIGZhY3QgYmUgdHJpZ2dlcmVkIG9uIHRoZSBjb250YWluZXIKCQkJaWYgKCBmcm9tICkgewoKCQkJCS8vQ2hlY2sgaWYgdGhpcyBpcyBhIHNhbWUgcGFnZSB0cmFuc2l0aW9uIGFuZCB0ZWxsIHRoZSBoYW5kbGVyIGluIHBhZ2UKCQkJCWlmKCB0b1swXSA9PT0gZnJvbVswXSApewoJCQkJCXNhbWVQYWdlID0gdHJ1ZTsKCQkJCX0KCgkJCQkvL3RyaWdnZXIgYmVmb3JlIHNob3cvaGlkZSBldmVudHMKCQkJCS8vIFRPRE8gZGVwcmVjYXRlIG5leHRQYWdlIGluIGZhdm9yIG9mIG5leHQKCQkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggcHJlZml4ICsgImhpZGUiLCB7IG5leHRQYWdlOiB0bywgc2FtZVBhZ2U6IHNhbWVQYWdlIH0sIGZyb20gKTsKCQkJfQoKCQkJLy8gVE9ETyBkZXByZWNhdGUgcHJldlBhZ2UgaW4gZmF2b3Igb2YgcHJldmlvdXMKCQkJdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCBwcmVmaXggKyAic2hvdyIsIHsgcHJldlBhZ2U6IGZyb20gfHwgJCggIiIgKSB9LCB0byApOwoJCX0sCgoJCS8vIFRPRE8gbWFrZSBwcml2YXRlIG9uY2UgY2hhbmdlIGhhcyBiZWVuIGRlZmluZWQgaW4gdGhlIHdpZGdldAoJCV9jc3NUcmFuc2l0aW9uOiBmdW5jdGlvbiggdG8sIGZyb20sIG9wdGlvbnMgKSB7CgkJCXZhciB0cmFuc2l0aW9uID0gb3B0aW9ucy50cmFuc2l0aW9uLAoJCQkJcmV2ZXJzZSA9IG9wdGlvbnMucmV2ZXJzZSwKCQkJCWRlZmVycmVkID0gb3B0aW9ucy5kZWZlcnJlZCwKCQkJCVRyYW5zaXRpb25IYW5kbGVyLAoJCQkJcHJvbWlzZTsKCgkJCXRoaXMuX3RyaWdnZXJDc3NUcmFuc2l0aW9uRXZlbnRzKCB0bywgZnJvbSwgImJlZm9yZSIgKTsKCgkJCS8vIFRPRE8gcHV0IHRoaXMgaW4gYSBiaW5kaW5nIHRvIGV2ZW50cyAqb3V0c2lkZSogdGhlIHdpZGdldAoJCQl0aGlzLl9oaWRlTG9hZGluZygpOwoKCQkJVHJhbnNpdGlvbkhhbmRsZXIgPSB0aGlzLl9nZXRUcmFuc2l0aW9uSGFuZGxlciggdHJhbnNpdGlvbiApOwoKCQkJcHJvbWlzZSA9ICggbmV3IFRyYW5zaXRpb25IYW5kbGVyKCB0cmFuc2l0aW9uLCByZXZlcnNlLCB0bywgZnJvbSApICkudHJhbnNpdGlvbigpOwoKCQkJLy8gVE9ETyB0ZW1wb3JhcnkgYWNjb21vZGF0aW9uIG9mIGFyZ3VtZW50IGRlZmVycmVkCgkJCXByb21pc2UuZG9uZShmdW5jdGlvbigpIHsKCQkJCWRlZmVycmVkLnJlc29sdmUuYXBwbHkoIGRlZmVycmVkLCBhcmd1bWVudHMgKTsKCQkJfSk7CgoJCQlwcm9taXNlLmRvbmUoJC5wcm94eShmdW5jdGlvbigpIHsKCQkJCXRoaXMuX3RyaWdnZXJDc3NUcmFuc2l0aW9uRXZlbnRzKCB0bywgZnJvbSApOwoJCQl9LCB0aGlzKSk7CgkJfSwKCgkJX3JlbGVhc2VUcmFuc2l0aW9uTG9jazogZnVuY3Rpb24oKSB7CgkJCS8vcmVsZWFzZSB0cmFuc2l0aW9uIGxvY2sgc28gbmF2aWdhdGlvbiBpcyBmcmVlIGFnYWluCgkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCQkJaWYgKCBwYWdlVHJhbnNpdGlvblF1ZXVlLmxlbmd0aCA+IDAgKSB7CgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlLmFwcGx5KCBudWxsLCBwYWdlVHJhbnNpdGlvblF1ZXVlLnBvcCgpICk7CgkJCX0KCQl9LAoKCQlfcmVtb3ZlQWN0aXZlTGlua0NsYXNzOiBmdW5jdGlvbiggZm9yY2UgKSB7CgkJCS8vY2xlYXIgb3V0IHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlCgkJCSQubW9iaWxlLnJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggZm9yY2UgKTsKCQl9LAoKCQlfbG9hZFVybDogZnVuY3Rpb24oIHRvLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MgKSB7CgkJCS8vIHByZXNlcnZlIHRoZSBvcmlnaW5hbCB0YXJnZXQgYXMgdGhlIGRhdGFVcmwgdmFsdWUgd2lsbCBiZQoJCQkvLyBzaW1wbGlmaWVkIGVnLCByZW1vdmluZyB1aS1zdGF0ZSwgYW5kIHJlbW92aW5nIHF1ZXJ5IHBhcmFtcwoJCQkvLyBmcm9tIHRoZSBoYXNoIHRoaXMgaXMgc28gdGhhdCB1c2VycyB3aG8gd2FudCB0byB1c2UgcXVlcnkKCQkJLy8gcGFyYW1zIGhhdmUgYWNjZXNzIHRvIHRoZW0gaW4gdGhlIGV2ZW50IGJpbmRpbmdzIGZvciB0aGUgcGFnZQoJCQkvLyBsaWZlIGN5Y2xlIFNlZSBpc3N1ZSAjNTA4NQoJCQlzZXR0aW5ncy50YXJnZXQgPSB0bzsKCQkJc2V0dGluZ3MuZGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgoJCQl0aGlzLmxvYWQoIHRvLCBzZXR0aW5ncyApOwoKCQkJc2V0dGluZ3MuZGVmZXJyZWQuZG9uZSgkLnByb3h5KGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMsIGNvbnRlbnQgKSB7CgkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgoJCQkJLy8gc3RvcmUgdGhlIG9yaWdpbmFsIGFic29sdXRlIHVybCBzbyB0aGF0IGl0IGNhbiBiZSBwcm92aWRlZAoJCQkJLy8gdG8gZXZlbnRzIGluIHRoZSB0cmlnZ2VyRGF0YSBvZiB0aGUgc3Vic2VxdWVudCBjaGFuZ2VQYWdlIGNhbGwKCQkJCW9wdGlvbnMuYWJzVXJsID0gdHJpZ2dlckRhdGEuYWJzVXJsOwoKCQkJCXRoaXMudHJhbnNpdGlvbiggY29udGVudCwgdHJpZ2dlckRhdGEsIG9wdGlvbnMgKTsKCQkJfSwgdGhpcykpOwoKCQkJc2V0dGluZ3MuZGVmZXJyZWQuZmFpbCgkLnByb3h5KGZ1bmN0aW9uKC8qIHVybCwgb3B0aW9ucyAqLykgewoJCQkJdGhpcy5fcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgkJCQl0aGlzLl9yZWxlYXNlVHJhbnNpdGlvbkxvY2soKTsKCQkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggImNoYW5nZWZhaWxlZCIsIHRyaWdnZXJEYXRhICk7CgkJCX0sIHRoaXMpKTsKCQl9LAoKCQlfdHJpZ2dlclBhZ2VCZWZvcmVDaGFuZ2U6IGZ1bmN0aW9uKCB0bywgdHJpZ2dlckRhdGEsIHNldHRpbmdzICkgewoJCQl2YXIgcGJjRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2ViZWZvcmVjaGFuZ2UiICk7CgoJCQkkLmV4dGVuZCh0cmlnZ2VyRGF0YSwgeyB0b1BhZ2U6IHRvLCBvcHRpb25zOiBzZXR0aW5ncyB9KTsKCgkJCS8vIE5PVEU6IHByZXNlcnZlIHRoZSBvcmlnaW5hbCB0YXJnZXQgYXMgdGhlIGRhdGFVcmwgdmFsdWUgd2lsbCBiZQoJCQkvLyBzaW1wbGlmaWVkIGVnLCByZW1vdmluZyB1aS1zdGF0ZSwgYW5kIHJlbW92aW5nIHF1ZXJ5IHBhcmFtcyBmcm9tCgkJCS8vIHRoZSBoYXNoIHRoaXMgaXMgc28gdGhhdCB1c2VycyB3aG8gd2FudCB0byB1c2UgcXVlcnkgcGFyYW1zIGhhdmUKCQkJLy8gYWNjZXNzIHRvIHRoZW0gaW4gdGhlIGV2ZW50IGJpbmRpbmdzIGZvciB0aGUgcGFnZSBsaWZlIGN5Y2xlCgkJCS8vIFNlZSBpc3N1ZSAjNTA4NQoJCQlpZiAoICQudHlwZSh0bykgPT09ICJzdHJpbmciICkgewoJCQkJLy8gaWYgdGhlIHRvUGFnZSBpcyBhIHN0cmluZyBzaW1wbHkgY29udmVydCBpdAoJCQkJdHJpZ2dlckRhdGEuYWJzVXJsID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIHRvLCB0aGlzLl9maW5kQmFzZVdpdGhEZWZhdWx0KCkgKTsKCQkJfSBlbHNlIHsKCQkJCS8vIGlmIHRoZSB0b1BhZ2UgaXMgYSBqUXVlcnkgb2JqZWN0IGdyYWIgdGhlIGFic29sdXRlIHVybCBzdG9yZWQKCQkJCS8vIGluIHRoZSBsb2FkUGFnZSBjYWxsYmFjayB3aGVyZSBpdCBleGlzdHMKCQkJCXRyaWdnZXJEYXRhLmFic1VybCA9IHNldHRpbmdzLmFic1VybDsKCQkJfQoKCQkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHdlJ3JlIGFib3V0IHRvIGNoYW5nZSB0aGUgY3VycmVudCBwYWdlLgoJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggcGJjRXZlbnQsIHRyaWdnZXJEYXRhICk7CgoJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJaWYgKCBwYmNFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJcmV0dXJuIHRydWU7CgkJfSwKCgkJY2hhbmdlOiBmdW5jdGlvbiggdG8sIG9wdGlvbnMgKSB7CgkJCS8vIElmIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgYSB0cmFuc2l0aW9uLCBxdWV1ZSB0aGUgY3VycmVudCByZXF1ZXN0LgoJCQkvLyBXZSdsbCBjYWxsIGNoYW5nZVBhZ2UoKSBvbmNlIHdlJ3JlIGRvbmUgd2l0aCB0aGUgY3VycmVudCB0cmFuc2l0aW9uCgkJCS8vIHRvIHNlcnZpY2UgdGhlIHJlcXVlc3QuCgkJCWlmICggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJCXBhZ2VUcmFuc2l0aW9uUXVldWUudW5zaGlmdCggYXJndW1lbnRzICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBzZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgJC5tb2JpbGUuY2hhbmdlUGFnZS5kZWZhdWx0cywgb3B0aW9ucyApLAoJCQkJdHJpZ2dlckRhdGEgPSB7fTsKCgkJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgZnJvbVBhZ2UuCgkJCXNldHRpbmdzLmZyb21QYWdlID0gc2V0dGluZ3MuZnJvbVBhZ2UgfHwgdGhpcy5hY3RpdmVQYWdlOwoKCQkJLy8gaWYgdGhlIHBhZ2UgYmVmb3JlY2hhbmdlIGRlZmF1bHQgaXMgcHJldmVudGVkIHJldHVybiBlYXJseQoJCQlpZiAoICF0aGlzLl90cmlnZ2VyUGFnZUJlZm9yZUNoYW5nZSh0bywgdHJpZ2dlckRhdGEsIHNldHRpbmdzKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gV2UgYWxsb3cgInBhZ2ViZWZvcmVjaGFuZ2UiIG9ic2VydmVycyB0byBtb2RpZnkgdGhlIHRvIGluCgkJCS8vIHRoZSB0cmlnZ2VyIGRhdGEgdG8gYWxsb3cgZm9yIHJlZGlyZWN0cy4gTWFrZSBzdXJlIG91ciB0byBpcwoJCQkvLyB1cGRhdGVkLiBXZSBhbHNvIG5lZWQgdG8gcmUtZXZhbHVhdGUgd2hldGhlciBpdCBpcyBhIHN0cmluZywKCQkJLy8gYmVjYXVzZSBhbiBvYmplY3QgY2FuIGFsc28gYmUgcmVwbGFjZWQgYnkgYSBzdHJpbmcKCQkJdG8gPSB0cmlnZ2VyRGF0YS50b1BhZ2U7CgoJCQkvLyBJZiB0aGUgY2FsbGVyIHBhc3NlZCB1cyBhIHVybCwgY2FsbCBsb2FkUGFnZSgpCgkJCS8vIHRvIG1ha2Ugc3VyZSBpdCBpcyBsb2FkZWQgaW50byB0aGUgRE9NLiBXZSdsbCBsaXN0ZW4KCQkJLy8gdG8gdGhlIHByb21pc2Ugb2JqZWN0IGl0IHJldHVybnMgc28gd2Uga25vdyB3aGVuCgkJCS8vIGl0IGlzIGRvbmUgbG9hZGluZyBvciBpZiBhbiBlcnJvciBvY3VycmVkLgoJCQlpZiAoICQudHlwZSh0bykgPT09ICJzdHJpbmciICkgewoJCQkJLy8gU2V0IHRoZSBpc1BhZ2VUcmFuc2l0aW9uaW5nIGZsYWcgdG8gcHJldmVudCBhbnkgcmVxdWVzdHMgZnJvbQoJCQkJLy8gZW50ZXJpbmcgdGhpcyBtZXRob2Qgd2hpbGUgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBsb2FkaW5nIGEgcGFnZQoJCQkJLy8gb3IgdHJhbnNpdGlvbmluZy4KCQkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSB0cnVlOwoKCQkJCXRoaXMuX2xvYWRVcmwoIHRvLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMudHJhbnNpdGlvbiggdG8sIHRyaWdnZXJEYXRhLCBzZXR0aW5ncyApOwoJCQl9CgkJfSwKCgkJdHJhbnNpdGlvbjogZnVuY3Rpb24oIHRvUGFnZSwgdHJpZ2dlckRhdGEsIHNldHRpbmdzICkgewoJCQl2YXIgZnJvbVBhZ2UsIHVybCwgcGFnZVVybCwgZmlsZVVybCwKCQkJCWFjdGl2ZSwgYWN0aXZlSXNJbml0aWFsUGFnZSwKCQkJCWhpc3RvcnlEaXIsIHBhZ2VUaXRsZSwgaXNEaWFsb2csCgkJCQlhbHJlYWR5VGhlcmUsIG5ld1BhZ2VUaXRsZSwKCQkJCXBhcmFtcywJY3NzVHJhbnNpdGlvbkRlZmVycmVkLAoJCQkJYmVmb3JlVHJhbnNpdGlvbjsKCgkJCS8vIElmIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgYSB0cmFuc2l0aW9uLCBxdWV1ZSB0aGUgY3VycmVudCByZXF1ZXN0LgoJCQkvLyBXZSdsbCBjYWxsIGNoYW5nZVBhZ2UoKSBvbmNlIHdlJ3JlIGRvbmUgd2l0aCB0aGUgY3VycmVudCB0cmFuc2l0aW9uCgkJCS8vIHRvIHNlcnZpY2UgdGhlIHJlcXVlc3QuCgkJCWlmICggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJCS8vIG1ha2Ugc3VyZSB0byBvbmx5IHF1ZXVlIHRoZSB0byBhbmQgc2V0dGluZ3MgdmFsdWVzIHNvIHRoZSBhcmd1bWVudHMKCQkJCS8vIHdvcmsgd2l0aCBhIGNhbGwgdG8gdGhlIGNoYW5nZSBtZXRob2QKCQkJCXBhZ2VUcmFuc2l0aW9uUXVldWUudW5zaGlmdCggW3RvUGFnZSwgc2V0dGluZ3NdICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIERFUFJFQ0FURUQgLSB0aGlzIGNhbGwgb25seSwgaW4gZmF2b3Igb2YgdGhlIGJlZm9yZSB0cmFuc2l0aW9uCgkJCS8vIGlmIHRoZSBwYWdlIGJlZm9yZWNoYW5nZSBkZWZhdWx0IGlzIHByZXZlbnRlZCByZXR1cm4gZWFybHkKCQkJaWYgKCAhdGhpcy5fdHJpZ2dlclBhZ2VCZWZvcmVDaGFuZ2UodG9QYWdlLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBpZiB0aGUgKGNvbnRlbnR8cGFnZSliZWZvcmV0cmFuc2l0aW9uIGRlZmF1bHQgaXMgcHJldmVudGVkIHJldHVybiBlYXJseQoJCQkvLyBOb3RlLCB3ZSBoYXZlIHRvIGNoZWNrIGZvciBib3RoIHRoZSBkZXByZWNhdGVkIGFuZCBuZXcgZXZlbnRzCgkJCWJlZm9yZVRyYW5zaXRpb24gPSB0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJiZWZvcmV0cmFuc2l0aW9uIiwgdHJpZ2dlckRhdGEgKTsKCQkJaWYgKGJlZm9yZVRyYW5zaXRpb24uZGVwcmVjYXRlZEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8CgkJCQliZWZvcmVUcmFuc2l0aW9uLmV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBTZXQgdGhlIGlzUGFnZVRyYW5zaXRpb25pbmcgZmxhZyB0byBwcmV2ZW50IGFueSByZXF1ZXN0cyBmcm9tCgkJCS8vIGVudGVyaW5nIHRoaXMgbWV0aG9kIHdoaWxlIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgbG9hZGluZyBhIHBhZ2UKCQkJLy8gb3IgdHJhbnNpdGlvbmluZy4KCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IHRydWU7CgoJCQkvLyBJZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGZpcnN0LXBhZ2Ugb2YgdGhlIGFwcGxpY2F0aW9uLCB3ZSBuZWVkIHRvIG1ha2UKCQkJLy8gc3VyZSBzZXR0aW5ncy5kYXRhVXJsIGlzIHNldCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgdXJsLiBUaGlzIGFsbG93cwoJCQkvLyB1cyB0byBhdm9pZCBnZW5lcmF0aW5nIGEgZG9jdW1lbnQgdXJsIHdpdGggYW4gaWQgaGFzaCBpbiB0aGUgY2FzZSB3aGVyZSB0aGUKCQkJLy8gZmlyc3QtcGFnZSBvZiB0aGUgZG9jdW1lbnQgaGFzIGFuIGlkIGF0dHJpYnV0ZSBzcGVjaWZpZWQuCgkJCWlmICggdG9QYWdlWyAwIF0gPT09ICQubW9iaWxlLmZpcnN0UGFnZVsgMCBdICYmICFzZXR0aW5ncy5kYXRhVXJsICkgewoJCQkJc2V0dGluZ3MuZGF0YVVybCA9ICQubW9iaWxlLnBhdGguZG9jdW1lbnRVcmwuaHJlZk5vSGFzaDsKCQkJfQoKCQkJLy8gVGhlIGNhbGxlciBwYXNzZWQgdXMgYSByZWFsIHBhZ2UgRE9NIGVsZW1lbnQuIFVwZGF0ZSBvdXIKCQkJLy8gaW50ZXJuYWwgc3RhdGUgYW5kIHRoZW4gdHJpZ2dlciBhIHRyYW5zaXRpb24gdG8gdGhlIHBhZ2UuCgkJCWZyb21QYWdlID0gc2V0dGluZ3MuZnJvbVBhZ2U7CgkJCXVybCA9ICggc2V0dGluZ3MuZGF0YVVybCAmJiAkLm1vYmlsZS5wYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoc2V0dGluZ3MuZGF0YVVybCkgKSB8fAoJCQkJdG9QYWdlLmpxbURhdGEoICJ1cmwiICk7CgoJCQkvLyBUaGUgcGFnZVVybCB2YXIgaXMgdXN1YWxseSB0aGUgc2FtZSBhcyB1cmwsIGV4Y2VwdCB3aGVuIHVybCBpcyBvYnNjdXJlZAoJCQkvLyBhcyBhIGRpYWxvZyB1cmwuIHBhZ2VVcmwgYWx3YXlzIGNvbnRhaW5zIHRoZSBmaWxlIHBhdGgKCQkJcGFnZVVybCA9IHVybDsKCQkJZmlsZVVybCA9ICQubW9iaWxlLnBhdGguZ2V0RmlsZVBhdGgoIHVybCApOwoJCQlhY3RpdmUgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmdldEFjdGl2ZSgpOwoJCQlhY3RpdmVJc0luaXRpYWxQYWdlID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMDsKCQkJaGlzdG9yeURpciA9IDA7CgkJCXBhZ2VUaXRsZSA9IGRvY3VtZW50LnRpdGxlOwoJCQlpc0RpYWxvZyA9ICggc2V0dGluZ3Mucm9sZSA9PT0gImRpYWxvZyIgfHwKCQkJCXRvUGFnZS5qcW1EYXRhKCAicm9sZSIgKSA9PT0gImRpYWxvZyIgKSAmJgoJCQkJdG9QYWdlLmpxbURhdGEoICJkaWFsb2ciICkgIT09IHRydWU7CgoJCQkvLyBCeSBkZWZhdWx0LCB3ZSBwcmV2ZW50IGNoYW5nZVBhZ2UgcmVxdWVzdHMgd2hlbiB0aGUgZnJvbVBhZ2UgYW5kIHRvUGFnZQoJCQkvLyBhcmUgdGhlIHNhbWUgZWxlbWVudCwgYnV0IGZvbGtzIHRoYXQgZ2VuZXJhdGUgY29udGVudAoJCQkvLyBtYW51YWxseS9keW5hbWljYWxseSBhbmQgcmV1c2UgcGFnZXMgd2FudCB0byBiZSBhYmxlIHRvIHRyYW5zaXRpb24gdG8KCQkJLy8gdGhlIHNhbWUgcGFnZS4gVG8gYWxsb3cgdGhpcywgdGhleSB3aWxsIG5lZWQgdG8gY2hhbmdlIHRoZSBkZWZhdWx0CgkJCS8vIHZhbHVlIG9mIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uIHRvIHRydWUsICpPUiosIHBhc3MgaXQgaW4gYXMgYW4KCQkJLy8gb3B0aW9uIHdoZW4gdGhleSBtYW51YWxseSBjYWxsIGNoYW5nZVBhZ2UoKS4gSXQgc2hvdWxkIGJlIG5vdGVkIHRoYXQKCQkJLy8gb3VyIGRlZmF1bHQgdHJhbnNpdGlvbiBhbmltYXRpb25zIGFzc3VtZSB0aGF0IHRoZSBmb3JtUGFnZSBhbmQgdG9QYWdlCgkJCS8vIGFyZSBkaWZmZXJlbnQgZWxlbWVudHMsIHNvIHRoZXkgbWF5IGJlaGF2ZSB1bmV4cGVjdGVkbHkuIEl0IGlzIHVwIHRvCgkJCS8vIHRoZSBkZXZlbG9wZXIgdGhhdCB0dXJucyBvbiB0aGUgYWxsb3dTYW1lUGFnZVRyYW5zaXRpb25hIG9wdGlvbiB0bwoJCQkvLyBlaXRoZXIgdHVybiBvZmYgdHJhbnNpdGlvbiBhbmltYXRpb25zLCBvciBtYWtlIHN1cmUgdGhhdCBhbiBhcHByb3ByaWF0ZQoJCQkvLyBhbmltYXRpb24gdHJhbnNpdGlvbiBpcyB1c2VkLgoJCQlpZiAoIGZyb21QYWdlICYmIGZyb21QYWdlWzBdID09PSB0b1BhZ2VbMF0gJiYKCQkJCSFzZXR0aW5ncy5hbGxvd1NhbWVQYWdlVHJhbnNpdGlvbiApIHsKCgkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJCQl0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJ0cmFuc2l0aW9uIiwgdHJpZ2dlckRhdGEgKTsKCQkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAicGFnZWNoYW5nZSIsIHRyaWdnZXJEYXRhICk7CgoJCQkJLy8gRXZlbiBpZiB0aGVyZSBpcyBubyBwYWdlIGNoYW5nZSB0byBiZSBkb25lLCB3ZSBzaG91bGQga2VlcCB0aGUKCQkJCS8vIHVybEhpc3RvcnkgaW4gc3luYyB3aXRoIHRoZSBoYXNoIGNoYW5nZXMKCQkJCWlmICggc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5kaXJlY3QoeyB1cmw6IHVybCB9KTsKCQkJCX0KCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoZSBwYWdlIHdlIGFyZSBnaXZlbiBoYXMgYWxyZWFkeSBiZWVuIGVuaGFuY2VkLgoJCQl0b1BhZ2UucGFnZSh7IHJvbGU6IHNldHRpbmdzLnJvbGUgfSk7CgoJCQkvLyBJZiB0aGUgY2hhbmdlUGFnZSByZXF1ZXN0IHdhcyBzZW50IGZyb20gYSBoYXNoQ2hhbmdlIGV2ZW50LCBjaGVjayB0bwoJCQkvLyBzZWUgaWYgdGhlIHBhZ2UgaXMgYWxyZWFkeSB3aXRoaW4gdGhlIHVybEhpc3Rvcnkgc3RhY2suIElmIHNvLCB3ZSdsbAoJCQkvLyBhc3N1bWUgdGhlIHVzZXIgaGl0IHRoZSBmb3J3YXJkL2JhY2sgYnV0dG9uIGFuZCB3aWxsIHRyeSB0byBtYXRjaCB0aGUKCQkJLy8gdHJhbnNpdGlvbiBhY2NvcmRpbmdseS4KCQkJaWYgKCBzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJCWhpc3RvcnlEaXIgPSBzZXR0aW5ncy5kaXJlY3Rpb24gPT09ICJiYWNrIiA/IC0xIDogMTsKCQkJfQoKCQkJLy8gS2lsbCB0aGUga2V5Ym9hcmQuCgkJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBzdG9wIGNyYXdsaW5nIHRoZSBlbnRpcmUgZG9jdW1lbnQgdG8ga2lsbCBmb2N1cy4KCQkJLy8gICAgICAgICAgICBJbnN0ZWFkLCB3ZSBzaG91bGQgYmUgdHJhY2tpbmcgZm9jdXMgd2l0aCBhIGRlbGVnYXRlKCkKCQkJLy8gICAgICAgICAgICBoYW5kbGVyIHNvIHdlIGFscmVhZHkgaGF2ZSB0aGUgZWxlbWVudCBpbiBoYW5kIGF0IHRoaXMKCQkJLy8gICAgICAgICAgICBwb2ludC4KCQkJLy8gV3JhcCB0aGlzIGluIGEgdHJ5L2NhdGNoIGJsb2NrIHNpbmNlIElFOSB0aHJvdyAiVW5zcGVjaWZpZWQgZXJyb3IiIGlmCgkJCS8vIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgaXMgdW5kZWZpbmVkIHdoZW4gd2UgYXJlIGluIGFuIElGcmFtZS4KCQkJdHJ5IHsKCQkJCWlmICggZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJgoJCQkJCWRvY3VtZW50LmFjdGl2ZUVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gImJvZHkiICkgewoKCQkJCQkkKCBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICkuYmx1cigpOwoJCQkJfSBlbHNlIHsKCQkJCQkkKCAiaW5wdXQ6Zm9jdXMsIHRleHRhcmVhOmZvY3VzLCBzZWxlY3Q6Zm9jdXMiICkuYmx1cigpOwoJCQkJfQoJCQl9IGNhdGNoKCBlICkge30KCgkJCS8vIFJlY29yZCB3aGV0aGVyIHdlIGFyZSBhdCBhIHBsYWNlIGluIGhpc3Rvcnkgd2hlcmUgYSBkaWFsb2cgdXNlZCB0byBiZSAtCgkJCS8vIGlmIHNvLCBkbyBub3QgYWRkIGEgbmV3IGhpc3RvcnkgZW50cnkgYW5kIGRvIG5vdCBjaGFuZ2UgdGhlIGhhc2ggZWl0aGVyCgkJCWFscmVhZHlUaGVyZSA9IGZhbHNlOwoKCQkJLy8gSWYgd2UncmUgZGlzcGxheWluZyB0aGUgcGFnZSBhcyBhIGRpYWxvZywgd2UgZG9uJ3Qgd2FudCB0aGUgdXJsCgkJCS8vIGZvciB0aGUgZGlhbG9nIGNvbnRlbnQgdG8gYmUgdXNlZCBpbiB0aGUgaGFzaC4gSW5zdGVhZCwgd2Ugd2FudAoJCQkvLyB0byBhcHBlbmQgdGhlIGRpYWxvZ0hhc2hLZXkgdG8gdGhlIHVybCBvZiB0aGUgY3VycmVudCBwYWdlLgoJCQlpZiAoIGlzRGlhbG9nICYmIGFjdGl2ZSApIHsKCQkJCS8vIG9uIHRoZSBpbml0aWFsIHBhZ2UgbG9hZCBhY3RpdmUudXJsIGlzIHVuZGVmaW5lZCBhbmQgaW4gdGhhdCBjYXNlCgkJCQkvLyBzaG91bGQgYmUgYW4gZW1wdHkgc3RyaW5nLiBNb3ZpbmcgdGhlIHVuZGVmaW5lZCAtPiBlbXB0eSBzdHJpbmcgYmFjawoJCQkJLy8gaW50byB1cmxIaXN0b3J5LmFkZE5ldyBzZWVtZWQgaW1wcnVkZW50IGdpdmVuIHVuZGVmaW5lZCBiZXR0ZXIKCQkJCS8vIHJlcHJlc2VudHMgdGhlIHVybCBzdGF0ZQoKCQkJCS8vIElmIHdlIGFyZSBhdCBhIHBsYWNlIGluIGhpc3RvcnkgdGhhdCBvbmNlIGJlbG9uZ2VkIHRvIGEgZGlhbG9nLCByZXVzZQoJCQkJLy8gdGhpcyBzdGF0ZSB3aXRob3V0IGFkZGluZyB0byB1cmxIaXN0b3J5IGFuZCB3aXRob3V0IG1vZGlmeWluZyB0aGUKCQkJCS8vIGhhc2guIEhvd2V2ZXIsIGlmIGEgZGlhbG9nIGlzIGFscmVhZHkgZGlzcGxheWVkIGF0IHRoaXMgcG9pbnQsIGFuZAoJCQkJLy8gd2UncmUgYWJvdXQgdG8gZGlzcGxheSBhbm90aGVyIGRpYWxvZywgdGhlbiB3ZSBtdXN0IGFkZCBhbm90aGVyIGhhc2gKCQkJCS8vIGFuZCBoaXN0b3J5IGVudHJ5IG9uIHRvcCBzbyB0aGF0IG9uZSBtYXkgbmF2aWdhdGUgYmFjayB0byB0aGUKCQkJCS8vIG9yaWdpbmFsIGRpYWxvZwoJCQkJaWYgKCBhY3RpdmUudXJsICYmCgkJCQkJYWN0aXZlLnVybC5pbmRleE9mKCAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5ICkgPiAtMSAmJgoJCQkJCXRoaXMuYWN0aXZlUGFnZSAmJgoJCQkJCSF0aGlzLmFjdGl2ZVBhZ2UuaGFzQ2xhc3MoICJ1aS1kaWFsb2ciICkgJiYKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCApIHsKCgkJCQkJc2V0dGluZ3MuY2hhbmdlSGFzaCA9IGZhbHNlOwoJCQkJCWFscmVhZHlUaGVyZSA9IHRydWU7CgkJCQl9CgoJCQkJLy8gTm9ybWFsbHksIHdlIHRhY2sgb24gYSBkaWFsb2cgaGFzaCBrZXksIGJ1dCBpZiB0aGlzIGlzIHRoZSBsb2NhdGlvbgoJCQkJLy8gb2YgYSBzdGFsZSBkaWFsb2csIHdlIHJldXNlIHRoZSBVUkwgZnJvbSB0aGUgZW50cnkKCQkJCXVybCA9ICggYWN0aXZlLnVybCB8fCAiIiApOwoKCQkJCS8vIGFjY291bnQgZm9yIGFic29sdXRlIHVybHMgaW5zdGVhZCBvZiBqdXN0IHJlbGF0aXZlIHVybHMgdXNlIGFzIGhhc2hlcwoJCQkJaWYgKCAhYWxyZWFkeVRoZXJlICYmIHVybC5pbmRleE9mKCIjIikgPiAtMSApIHsKCQkJCQl1cmwgKz0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleTsKCQkJCX0gZWxzZSB7CgkJCQkJdXJsICs9ICIjIiArICQubW9iaWxlLmRpYWxvZ0hhc2hLZXk7CgkJCQl9CgoJCQkJLy8gdGFjayBvbiBhbm90aGVyIGRpYWxvZ0hhc2hLZXkgaWYgdGhpcyBpcyB0aGUgc2FtZSBhcyB0aGUgaW5pdGlhbCBoYXNoCgkJCQkvLyB0aGlzIG1ha2VzIHN1cmUgdGhhdCBhIGhpc3RvcnkgZW50cnkgaXMgY3JlYXRlZCBmb3IgdGhpcyBkaWFsb2cKCQkJCWlmICggJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCAmJiB1cmwgPT09ICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuaW5pdGlhbERzdCApIHsKCQkJCQl1cmwgKz0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleTsKCQkJCX0KCQkJfQoKCQkJLy8gaWYgdGl0bGUgZWxlbWVudCB3YXNuJ3QgZm91bmQsIHRyeSB0aGUgcGFnZSBkaXYgZGF0YSBhdHRyIHRvbwoJCQkvLyBJZiB0aGlzIGlzIGEgZGVlcC1saW5rIG9yIGEgcmVsb2FkICggYWN0aXZlID09PSB1bmRlZmluZWQgKSB0aGVuIGp1c3QKCQkJLy8gdXNlIHBhZ2VUaXRsZQoJCQluZXdQYWdlVGl0bGUgPSAoICFhY3RpdmUgKSA/IHBhZ2VUaXRsZSA6IHRvUGFnZS5qcW1EYXRhKCAidGl0bGUiICkgfHwKCQkJCXRvUGFnZS5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLmZpbmQoICIudWktdGl0bGUiICkudGV4dCgpOwoJCQlpZiAoICEhbmV3UGFnZVRpdGxlICYmIHBhZ2VUaXRsZSA9PT0gZG9jdW1lbnQudGl0bGUgKSB7CgkJCQlwYWdlVGl0bGUgPSBuZXdQYWdlVGl0bGU7CgkJCX0KCQkJaWYgKCAhdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJCXRvUGFnZS5qcW1EYXRhKCAidGl0bGUiLCBwYWdlVGl0bGUgKTsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSB0cmFuc2l0aW9uIGRlZmluZWQuCgkJCXNldHRpbmdzLnRyYW5zaXRpb24gPSBzZXR0aW5ncy50cmFuc2l0aW9uIHx8CgkJCQkoICggaGlzdG9yeURpciAmJiAhYWN0aXZlSXNJbml0aWFsUGFnZSApID8gYWN0aXZlLnRyYW5zaXRpb24gOiB1bmRlZmluZWQgKSB8fAoJCQkJKCBpc0RpYWxvZyA/ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uIDogJC5tb2JpbGUuZGVmYXVsdFBhZ2VUcmFuc2l0aW9uICk7CgoJCQkvL2FkZCBwYWdlIHRvIGhpc3Rvcnkgc3RhY2sgaWYgaXQncyBub3QgYmFjayBvciBmb3J3YXJkCgkJCWlmICggIWhpc3RvcnlEaXIgJiYgYWxyZWFkeVRoZXJlICkgewoJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5nZXRBY3RpdmUoKS5wYWdlVXJsID0gcGFnZVVybDsKCQkJfQoKCQkJLy8gU2V0IHRoZSBsb2NhdGlvbiBoYXNoLgoJCQlpZiAoIHVybCAmJiAhc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgoJCQkJLy8gcmVidWlsZGluZyB0aGUgaGFzaCBoZXJlIHNpbmNlIHdlIGxvb3NlIGl0IGVhcmxpZXIgb24KCQkJCS8vIFRPRE8gcHJlc2VydmUgdGhlIG9yaWdpbmFsbHkgcGFzc2VkIGluIHBhdGgKCQkJCWlmICggISQubW9iaWxlLnBhdGguaXNQYXRoKCB1cmwgKSAmJiB1cmwuaW5kZXhPZiggIiMiICkgPCAwICkgewoJCQkJCXVybCA9ICIjIiArIHVybDsKCQkJCX0KCgkJCQkvLyBUT0RPIHRoZSBwcm9wZXJ0eSBuYW1lcyBoZXJlIGFyZSBqdXN0IHNpbGx5CgkJCQlwYXJhbXMgPSB7CgkJCQkJdHJhbnNpdGlvbjogc2V0dGluZ3MudHJhbnNpdGlvbiwKCQkJCQl0aXRsZTogcGFnZVRpdGxlLAoJCQkJCXBhZ2VVcmw6IHBhZ2VVcmwsCgkJCQkJcm9sZTogc2V0dGluZ3Mucm9sZQoJCQkJfTsKCgkJCQlpZiAoIHNldHRpbmdzLmNoYW5nZUhhc2ggIT09IGZhbHNlICYmICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICkgewoJCQkJCSQubW9iaWxlLm5hdmlnYXRlKCB1cmwsIHBhcmFtcywgdHJ1ZSk7CgkJCQl9IGVsc2UgaWYgKCB0b1BhZ2VbIDAgXSAhPT0gJC5tb2JpbGUuZmlyc3RQYWdlWyAwIF0gKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hZGQoIHVybCwgcGFyYW1zICk7CgkJCQl9CgkJCX0KCgkJCS8vc2V0IHBhZ2UgdGl0bGUKCQkJZG9jdW1lbnQudGl0bGUgPSBwYWdlVGl0bGU7CgoJCQkvL3NldCAidG9QYWdlIiBhcyBhY3RpdmVQYWdlIGRlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQkJJC5tb2JpbGUuYWN0aXZlUGFnZSA9IHRvUGFnZTsKCgkJCS8vbmV3IHdheSB0byBoYW5kbGUgYWN0aXZlUGFnZQoJCQl0aGlzLmFjdGl2ZVBhZ2UgPSB0b1BhZ2U7CgoJCQkvLyBJZiB3ZSdyZSBuYXZpZ2F0aW5nIGJhY2sgaW4gdGhlIFVSTCBoaXN0b3J5LCBzZXQgcmV2ZXJzZSBhY2NvcmRpbmdseS4KCQkJc2V0dGluZ3MucmV2ZXJzZSA9IHNldHRpbmdzLnJldmVyc2UgfHwgaGlzdG9yeURpciA8IDA7CgoJCQljc3NUcmFuc2l0aW9uRGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgoJCQl0aGlzLl9jc3NUcmFuc2l0aW9uKHRvUGFnZSwgZnJvbVBhZ2UsIHsKCQkJCXRyYW5zaXRpb246IHNldHRpbmdzLnRyYW5zaXRpb24sCgkJCQlyZXZlcnNlOiBzZXR0aW5ncy5yZXZlcnNlLAoJCQkJZGVmZXJyZWQ6IGNzc1RyYW5zaXRpb25EZWZlcnJlZAoJCQl9KTsKCgkJCWNzc1RyYW5zaXRpb25EZWZlcnJlZC5kb25lKCQucHJveHkoZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20sIGFscmVhZHlGb2N1c2VkICkgewoJCQkJJC5tb2JpbGUucmVtb3ZlQWN0aXZlTGlua0NsYXNzKCk7CgoJCQkJLy9pZiB0aGVyZSdzIGEgZHVwbGljYXRlQ2FjaGVkUGFnZSwgcmVtb3ZlIGl0IGZyb20gdGhlIERPTSBub3cgdGhhdCBpdCdzIGhpZGRlbgoJCQkJaWYgKCBzZXR0aW5ncy5kdXBsaWNhdGVDYWNoZWRQYWdlICkgewoJCQkJCXNldHRpbmdzLmR1cGxpY2F0ZUNhY2hlZFBhZ2UucmVtb3ZlKCk7CgkJCQl9CgoJCQkJLy8gZGVzcGl0ZSB2aXNpYmlsaXR5OiBoaWRkZW4gYWRkcmVzc2VzIGlzc3VlICMyOTY1CgkJCQkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzI5NjUKCQkJCWlmICggIWFscmVhZHlGb2N1c2VkICkgewoJCQkJCSQubW9iaWxlLmZvY3VzUGFnZSggdG9QYWdlICk7CgkJCQl9CgoJCQkJdGhpcy5fcmVsZWFzZVRyYW5zaXRpb25Mb2NrKCk7CgkJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoJCQkJdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAidHJhbnNpdGlvbiIsIHRyaWdnZXJEYXRhICk7CgkJCX0sIHRoaXMpKTsKCQl9LAoKCQkvLyBkZXRlcm1pbmUgdGhlIGN1cnJlbnQgYmFzZSB1cmwKCQlfZmluZEJhc2VXaXRoRGVmYXVsdDogZnVuY3Rpb24oKSB7CgkJCXZhciBjbG9zZXN0QmFzZSA9ICggdGhpcy5hY3RpdmVQYWdlICYmCgkJCSQubW9iaWxlLmdldENsb3Nlc3RCYXNlVXJsKCB0aGlzLmFjdGl2ZVBhZ2UgKSApOwoJCXJldHVybiBjbG9zZXN0QmFzZSB8fCAkLm1vYmlsZS5wYXRoLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoOwoJCX0KCX0pOwoKCS8vIFRoZSBmb2xsb3dpbmcgaGFuZGxlcnMgc2hvdWxkIGJlIGJvdW5kIGFmdGVyIG1vYmlsZWluaXQgaGFzIGJlZW4gdHJpZ2dlcmVkCgkvLyB0aGUgZm9sbG93aW5nIGRlZmVycmVkIGlzIHJlc29sdmVkIGluIHRoZSBpbml0IGZpbGUKCSQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgoJLy90aGVzZSB2YXJpYWJsZXMgbWFrZSBhbGwgcGFnZSBjb250YWluZXJzIHVzZSB0aGUgc2FtZSBxdWV1ZSBhbmQgb25seSBuYXZpZ2F0ZSBvbmUgYXQgYSB0aW1lCgkvLyBxdWV1ZSB0byBob2xkIHNpbXVsdGFuaW91cyBwYWdlIHRyYW5zaXRpb25zCgl2YXIgcGFnZVRyYW5zaXRpb25RdWV1ZSA9IFtdLAoKCQkvLyBpbmRpY2F0ZXMgd2hldGhlciBvciBub3QgcGFnZSBpcyBpbiBwcm9jZXNzIG9mIHRyYW5zaXRpb25pbmcKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkJLy8gcmVzb2x2ZWQgb24gZG9tcmVhZHkKCXZhciBkb21yZWFkeURlZmVycmVkID0gJC5EZWZlcnJlZCgpLAoJCWRvY3VtZW50VXJsID0gJC5tb2JpbGUucGF0aC5kb2N1bWVudFVybCwKCgkJLy8gdXNlZCB0byB0cmFjayBsYXN0IHZjbGlja2VkIGVsZW1lbnQgdG8gbWFrZSBzdXJlIGl0cyB2YWx1ZSBpcyBhZGRlZCB0byBmb3JtIGRhdGEKCQkkbGFzdFZDbGlja2VkID0gbnVsbDsKCgkvKiBFdmVudCBCaW5kaW5ncyAtIGhhc2hjaGFuZ2UsIHN1Ym1pdCwgYW5kIGNsaWNrICovCglmdW5jdGlvbiBmaW5kQ2xvc2VzdExpbmsoIGVsZSApCXsKCQl3aGlsZSAoIGVsZSApIHsKCQkJLy8gTG9vayBmb3IgdGhlIGNsb3Nlc3QgZWxlbWVudCB3aXRoIGEgbm9kZU5hbWUgb2YgImEiLgoJCQkvLyBOb3RlIHRoYXQgd2UgYXJlIGNoZWNraW5nIGlmIHdlIGhhdmUgYSB2YWxpZCBub2RlTmFtZQoJCQkvLyBiZWZvcmUgYXR0ZW1wdGluZyB0byBhY2Nlc3MgaXQuIFRoaXMgaXMgYmVjYXVzZSB0aGUKCQkJLy8gbm9kZSB3ZSBnZXQgY2FsbGVkIHdpdGggY291bGQgaGF2ZSBvcmlnaW5hdGVkIGZyb20gd2l0aGluCgkJCS8vIGFuIGVtYmVkZGVkIFNWRyBkb2N1bWVudCB3aGVyZSBzb21lIHN5bWJvbCBpbnN0YW5jZSBlbGVtZW50cwoJCQkvLyBkb24ndCBoYXZlIG5vZGVOYW1lIGRlZmluZWQgb24gdGhlbSwgb3Igc3RyaW5ncyBhcmUgb2YgdHlwZQoJCQkvLyBTVkdBbmltYXRlZFN0cmluZy4KCQkJaWYgKCAoIHR5cGVvZiBlbGUubm9kZU5hbWUgPT09ICJzdHJpbmciICkgJiYgZWxlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJhIiApIHsKCQkJCWJyZWFrOwoJCQl9CgkJCWVsZSA9IGVsZS5wYXJlbnROb2RlOwoJCX0KCQlyZXR1cm4gZWxlOwoJfQoKCSQubW9iaWxlLmxvYWRQYWdlID0gZnVuY3Rpb24oIHVybCwgb3B0cyApIHsKCQl2YXIgY29udGFpbmVyOwoKCQlvcHRzID0gb3B0cyB8fCB7fTsKCQljb250YWluZXIgPSAoIG9wdHMucGFnZUNvbnRhaW5lciB8fCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCS8vIGNyZWF0ZSB0aGUgZGVmZXJyZWQgdGhhdCB3aWxsIGJlIHN1cHBsaWVkIHRvIGxvYWRQYWdlIGNhbGxlcnMKCQkvLyBhbmQgcmVzb2x2ZWQgYnkgdGhlIGNvbnRlbnQgd2lkZ2V0J3MgbG9hZCBtZXRob2QKCQlvcHRzLmRlZmVycmVkID0gJC5EZWZlcnJlZCgpOwoKCQkvLyBQcmVmZXJyaW5nIHRvIGFsbG93IGV4Y2VwdGlvbnMgZm9yIHVuaW5pdGlhbGl6ZWQgb3B0cy5wYWdlQ29udGFpbmVyCgkJLy8gd2lkZ2V0cyBzbyB3ZSBrbm93IGlmIHdlIG5lZWQgdG8gZm9yY2UgaW5pdCBoZXJlIGZvciB1c2VycwoJCWNvbnRhaW5lci5wYWdlY29udGFpbmVyKCAibG9hZCIsIHVybCwgb3B0cyApOwoKCQkvLyBwcm92aWRlIHRoZSBkZWZlcnJlZAoJCXJldHVybiBvcHRzLmRlZmVycmVkLnByb21pc2UoKTsKCX07CgoJLy9kZWZpbmUgdmFycyBmb3IgaW50ZXJhbCB1c2UKCgkvKiBpbnRlcm5hbCB1dGlsaXR5IGZ1bmN0aW9ucyAqLwoKCS8vIE5PVEUgSXNzdWUgIzQ5NTAgQW5kcm9pZCBwaG9uZWdhcCBkb2Vzbid0IG5hdmlnYXRlIGJhY2sgcHJvcGVybHkKCS8vICAgICAgd2hlbiBhIGZ1bGwgcGFnZSByZWZyZXNoIGhhcyB0YWtlbiBwbGFjZS4gSXQgYXBwZWFycyB0aGF0IGhhc2hjaGFuZ2UKCS8vICAgICAgYW5kIHJlcGxhY2VzdGF0ZSBoaXN0b3J5IGFsdGVyYXRpb25zIHdvcmsgZmluZSBidXQgd2UgbmVlZCB0byBzdXBwb3J0CgkvLyAgICAgIGJvdGggZm9ybXMgb2YgaGlzdG9yeSB0cmF2ZXJzYWwgaW4gb3VyIGNvZGUgdGhhdCB1c2VzIGJhY2t3YXJkIGhpc3RvcnkKCS8vICAgICAgbW92ZW1lbnQKCSQubW9iaWxlLmJhY2sgPSBmdW5jdGlvbigpIHsKCQl2YXIgbmF2ID0gd2luZG93Lm5hdmlnYXRvcjsKCgkJLy8gaWYgdGhlIHNldHRpbmcgaXMgb24gYW5kIHRoZSBuYXZpZ2F0b3Igb2JqZWN0IGlzCgkJLy8gYXZhaWxhYmxlIHVzZSB0aGUgcGhvbmVnYXAgbmF2aWdhdGlvbiBjYXBhYmlsaXR5CgkJaWYgKCB0aGlzLnBob25lZ2FwTmF2aWdhdGlvbkVuYWJsZWQgJiYKCQkJbmF2ICYmCgkJCW5hdi5hcHAgJiYKCQkJbmF2LmFwcC5iYWNrSGlzdG9yeSApIHsKCQkJbmF2LmFwcC5iYWNrSGlzdG9yeSgpOwoJCX0gZWxzZSB7CgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIucGFnZWNvbnRhaW5lciggImJhY2siICk7CgkJfQoJfTsKCgkvL2RpcmVjdCBmb2N1cyB0byB0aGUgcGFnZSB0aXRsZSwgb3Igb3RoZXJ3aXNlIGZpcnN0IGZvY3VzYWJsZSBlbGVtZW50CgkkLm1vYmlsZS5mb2N1c1BhZ2UgPSBmdW5jdGlvbiAoIHBhZ2UgKSB7CgkJdmFyIGF1dG9mb2N1cyA9IHBhZ2UuZmluZCggIlthdXRvZm9jdXNdIiApLAoJCQlwYWdlVGl0bGUgPSBwYWdlLmZpbmQoICIudWktdGl0bGU6ZXEoMCkiICk7CgoJCWlmICggYXV0b2ZvY3VzLmxlbmd0aCApIHsKCQkJYXV0b2ZvY3VzLmZvY3VzKCk7CgkJCXJldHVybjsKCQl9CgoJCWlmICggcGFnZVRpdGxlLmxlbmd0aCApIHsKCQkJcGFnZVRpdGxlLmZvY3VzKCk7CgkJfSBlbHNlewoJCQlwYWdlLmZvY3VzKCk7CgkJfQoJfTsKCgkvLyBOby1vcCBpbXBsZW1lbnRhdGlvbiBvZiB0cmFuc2l0aW9uIGRlZ3JhZGF0aW9uCgkkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uIHx8IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCXJldHVybiB0cmFuc2l0aW9uOwoJfTsKCgkvKiBleHBvc2VkICQubW9iaWxlIG1ldGhvZHMgKi8KCgkvL2FuaW1hdGlvbiBjb21wbGV0ZSBjYWxsYmFjawoJJC5mbi5hbmltYXRpb25Db21wbGV0ZSA9IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2l0aW9ucyApIHsKCQkJcmV0dXJuICQoIHRoaXMgKS5vbmUoICJ3ZWJraXRBbmltYXRpb25FbmQgYW5pbWF0aW9uZW5kIiwgY2FsbGJhY2sgKTsKCQl9CgkJZWxzZXsKCQkJLy8gZGVmZXIgZXhlY3V0aW9uIGZvciBjb25zaXN0ZW5jeSBiZXR3ZWVuIHdlYmtpdC9ub24gd2Via2l0CgkJCXNldFRpbWVvdXQoIGNhbGxiYWNrLCAwICk7CgkJCXJldHVybiAkKCB0aGlzICk7CgkJfQoJfTsKCgkkLm1vYmlsZS5jaGFuZ2VQYWdlID0gZnVuY3Rpb24oIHRvLCBvcHRpb25zICkgewoJCSQubW9iaWxlLnBhZ2VDb250YWluZXIucGFnZWNvbnRhaW5lciggImNoYW5nZSIsIHRvLCBvcHRpb25zICk7Cgl9OwoKCSQubW9iaWxlLmNoYW5nZVBhZ2UuZGVmYXVsdHMgPSB7CgkJdHJhbnNpdGlvbjogdW5kZWZpbmVkLAoJCXJldmVyc2U6IGZhbHNlLAoJCWNoYW5nZUhhc2g6IHRydWUsCgkJZnJvbUhhc2hDaGFuZ2U6IGZhbHNlLAoJCXJvbGU6IHVuZGVmaW5lZCwgLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCWR1cGxpY2F0ZUNhY2hlZFBhZ2U6IHVuZGVmaW5lZCwKCQlwYWdlQ29udGFpbmVyOiB1bmRlZmluZWQsCgkJc2hvd0xvYWRNc2c6IHRydWUsIC8vbG9hZGluZyBtZXNzYWdlIHNob3dzIGJ5IGRlZmF1bHQgd2hlbiBwYWdlcyBhcmUgYmVpbmcgZmV0Y2hlZCBkdXJpbmcgY2hhbmdlUGFnZQoJCWRhdGFVcmw6IHVuZGVmaW5lZCwKCQlmcm9tUGFnZTogdW5kZWZpbmVkLAoJCWFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uOiBmYWxzZQoJfTsKCgkkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cyA9IGZ1bmN0aW9uKCkgewoJCXZhciBnZXRBamF4Rm9ybURhdGEgPSBmdW5jdGlvbiggJGZvcm0sIGNhbGN1bGF0ZU9ubHkgKSB7CgkJCXZhciB1cmwsIHJldCA9IHRydWUsIGZvcm1EYXRhLCB2Y2xpY2tlZE5hbWUsIG1ldGhvZDsKCQkJaWYgKCAhJC5tb2JpbGUuYWpheEVuYWJsZWQgfHwKCQkJCQkvLyB0ZXN0IHRoYXQgdGhlIGZvcm0gaXMsIGl0c2VsZiwgYWpheCBmYWxzZQoJCQkJCSRmb3JtLmlzKCAiOmpxbURhdGEoYWpheD0nZmFsc2UnKSIgKSB8fAoJCQkJCS8vIHRlc3QgdGhhdCAkLm1vYmlsZS5pZ25vcmVDb250ZW50RW5hYmxlZCBpcyBzZXQgYW5kCgkJCQkJLy8gdGhlIGZvcm0gb3Igb25lIG9mIGl0J3MgcGFyZW50cyBpcyBhamF4PWZhbHNlCgkJCQkJISRmb3JtLmpxbUhpamFja2FibGUoKS5sZW5ndGggfHwKCQkJCQkkZm9ybS5hdHRyKCAidGFyZ2V0IiApICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl1cmwgPSAoICRsYXN0VkNsaWNrZWQgJiYgJGxhc3RWQ2xpY2tlZC5hdHRyKCAiZm9ybWFjdGlvbiIgKSApIHx8CgkJCQkkZm9ybS5hdHRyKCAiYWN0aW9uIiApOwoJCQltZXRob2QgPSAoICRmb3JtLmF0dHIoICJtZXRob2QiICkgfHwgImdldCIgKS50b0xvd2VyQ2FzZSgpOwoKCQkJLy8gSWYgbm8gYWN0aW9uIGlzIHNwZWNpZmllZCwgYnJvd3NlcnMgZGVmYXVsdCB0byB1c2luZyB0aGUKCQkJLy8gVVJMIG9mIHRoZSBkb2N1bWVudCBjb250YWluaW5nIHRoZSBmb3JtLiBTaW5jZSB3ZSBkeW5hbWljYWxseQoJCQkvLyBwdWxsIGluIHBhZ2VzIGZyb20gZXh0ZXJuYWwgZG9jdW1lbnRzLCB0aGUgZm9ybSBzaG91bGQgc3VibWl0CgkJCS8vIHRvIHRoZSBVUkwgZm9yIHRoZSBzb3VyY2UgZG9jdW1lbnQgb2YgdGhlIHBhZ2UgY29udGFpbmluZwoJCQkvLyB0aGUgZm9ybS4KCQkJaWYgKCAhdXJsICkgewoJCQkJLy8gR2V0IHRoZSBAZGF0YS11cmwgZm9yIHRoZSBwYWdlIGNvbnRhaW5pbmcgdGhlIGZvcm0uCgkJCQl1cmwgPSAkLm1vYmlsZS5nZXRDbG9zZXN0QmFzZVVybCggJGZvcm0gKTsKCgkJCQkvLyBOT1RFOiBJZiB0aGUgbWV0aG9kIGlzICJnZXQiLCB3ZSBuZWVkIHRvIHN0cmlwIG9mZiB0aGUgcXVlcnkgc3RyaW5nCgkJCQkvLyBiZWNhdXNlIGl0IHdpbGwgZ2V0IHJlcGxhY2VkIHdpdGggdGhlIG5ldyBmb3JtIGRhdGEuIFNlZSBpc3N1ZSAjNTcxMC4KCQkJCWlmICggbWV0aG9kID09PSAiZ2V0IiApIHsKCQkJCQl1cmwgPSAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCB1cmwgKS5ocmVmTm9TZWFyY2g7CgkJCQl9CgoJCQkJaWYgKCB1cmwgPT09ICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSB7CgkJCQkJLy8gVGhlIHVybCB3ZSBnb3QgYmFjayBtYXRjaGVzIHRoZSBkb2N1bWVudCBiYXNlLAoJCQkJCS8vIHdoaWNoIG1lYW5zIHRoZSBwYWdlIG11c3QgYmUgYW4gaW50ZXJuYWwvZW1iZWRkZWQgcGFnZSwKCQkJCQkvLyBzbyBkZWZhdWx0IHRvIHVzaW5nIHRoZSBhY3R1YWwgZG9jdW1lbnQgdXJsIGFzIGEgYnJvd3NlcgoJCQkJCS8vIHdvdWxkLgoJCQkJCXVybCA9IGRvY3VtZW50VXJsLmhyZWZOb1NlYXJjaDsKCQkJCX0KCQkJfQoKCQkJdXJsID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICB1cmwsICQubW9iaWxlLmdldENsb3Nlc3RCYXNlVXJsKCAkZm9ybSApICk7CgoJCQlpZiAoICggJC5tb2JpbGUucGF0aC5pc0V4dGVybmFsKCB1cmwgKSAmJiAhJC5tb2JpbGUucGF0aC5pc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdCggZG9jdW1lbnRVcmwsIHVybCApICkgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCWlmICggIWNhbGN1bGF0ZU9ubHkgKSB7CgkJCQlmb3JtRGF0YSA9ICRmb3JtLnNlcmlhbGl6ZUFycmF5KCk7CgoJCQkJaWYgKCAkbGFzdFZDbGlja2VkICYmICRsYXN0VkNsaWNrZWRbIDAgXS5mb3JtID09PSAkZm9ybVsgMCBdICkgewoJCQkJCXZjbGlja2VkTmFtZSA9ICRsYXN0VkNsaWNrZWQuYXR0ciggIm5hbWUiICk7CgkJCQkJaWYgKCB2Y2xpY2tlZE5hbWUgKSB7CgkJCQkJCS8vIE1ha2Ugc3VyZSB0aGUgbGFzdCBjbGlja2VkIGVsZW1lbnQgaXMgaW5jbHVkZWQgaW4gdGhlIGZvcm0KCQkJCQkJJC5lYWNoKCBmb3JtRGF0YSwgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCQkJCQlpZiAoIHZhbHVlLm5hbWUgPT09IHZjbGlja2VkTmFtZSApIHsKCQkJCQkJCQkvLyBVbnNldCB2Y2xpY2tlZE5hbWUgLSB3ZSd2ZSBmb3VuZCBpdCBpbiB0aGUgc2VyaWFsaXplZCBkYXRhIGFscmVhZHkKCQkJCQkJCQl2Y2xpY2tlZE5hbWUgPSAiIjsKCQkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQl9CgkJCQkJCX0pOwoJCQkJCQlpZiAoIHZjbGlja2VkTmFtZSApIHsKCQkJCQkJCWZvcm1EYXRhLnB1c2goIHsgbmFtZTogdmNsaWNrZWROYW1lLCB2YWx1ZTogJGxhc3RWQ2xpY2tlZC5hdHRyKCAidmFsdWUiICkgfSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoKCQkJCXJldCA9IHsKCQkJCQl1cmw6IHVybCwKCQkJCQlvcHRpb25zOiB7CgkJCQkJCXR5cGU6CQltZXRob2QsCgkJCQkJCWRhdGE6CQkkLnBhcmFtKCBmb3JtRGF0YSApLAoJCQkJCQl0cmFuc2l0aW9uOgkkZm9ybS5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJCQkJcmV2ZXJzZToJJGZvcm0uanFtRGF0YSggImRpcmVjdGlvbiIgKSA9PT0gInJldmVyc2UiLAoJCQkJCQlyZWxvYWRQYWdlOgl0cnVlCgkJCQkJfQoJCQkJfTsKCQkJfQoKCQkJcmV0dXJuIHJldDsKCQl9OwoKCQkvL2JpbmQgdG8gZm9ybSBzdWJtaXQgZXZlbnRzLCBoYW5kbGUgd2l0aCBBamF4CgkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICJmb3JtIiwgInN1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZvcm1EYXRhOwoKCQkJaWYgKCAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlmb3JtRGF0YSA9IGdldEFqYXhGb3JtRGF0YSggJCggdGhpcyApICk7CgkJCQlpZiAoIGZvcm1EYXRhICkgewoJCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGZvcm1EYXRhLnVybCwgZm9ybURhdGEub3B0aW9ucyApOwoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0KCQl9KTsKCgkJLy9hZGQgYWN0aXZlIHN0YXRlIG9uIHZjbGljawoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciAkYnRuLCBidG5FbHMsIHRhcmdldCA9IGV2ZW50LnRhcmdldCwgbmVlZENsb3Nlc3QgPSBmYWxzZTsKCQkJLy8gaWYgdGhpcyBpc24ndCBhIGxlZnQgY2xpY2sgd2UgZG9uJ3QgY2FyZS4gSXRzIGltcG9ydGFudCB0byBub3RlCgkJCS8vIHRoYXQgd2hlbiB0aGUgdmlydHVhbCBldmVudCBpcyBnZW5lcmF0ZWQgaXQgd2lsbCBjcmVhdGUgdGhlIHdoaWNoIGF0dHIKCQkJaWYgKCBldmVudC53aGljaCA+IDEgfHwgISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gUmVjb3JkIHRoYXQgdGhpcyBlbGVtZW50IHdhcyBjbGlja2VkLCBpbiBjYXNlIHdlIG5lZWQgaXQgZm9yIGNvcnJlY3QKCQkJLy8gZm9ybSBzdWJtaXNzaW9uIGR1cmluZyB0aGUgInN1Ym1pdCIgaGFuZGxlciBhYm92ZQoJCQkkbGFzdFZDbGlja2VkID0gJCggdGFyZ2V0ICk7CgoJCQkvLyBUcnkgdG8gZmluZCBhIHRhcmdldCBlbGVtZW50IHRvIHdoaWNoIHRoZSBhY3RpdmUgY2xhc3Mgd2lsbCBiZSBhcHBsaWVkCgkJCWlmICggJC5kYXRhKCB0YXJnZXQsICJtb2JpbGUtYnV0dG9uIiApICkgewoJCQkJLy8gSWYgdGhlIGZvcm0gd2lsbCBub3QgYmUgc3VibWl0dGVkIHZpYSBBSkFYLCBkbyBub3QgYWRkIGFjdGl2ZSBjbGFzcwoJCQkJaWYgKCAhZ2V0QWpheEZvcm1EYXRhKCAkKCB0YXJnZXQgKS5jbG9zZXN0KCAiZm9ybSIgKSwgdHJ1ZSApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCS8vIFdlIHdpbGwgYXBwbHkgdGhlIGFjdGl2ZSBzdGF0ZSB0byB0aGlzIGJ1dHRvbiB3aWRnZXQgLSB0aGUgcGFyZW50CgkJCQkvLyBvZiB0aGUgaW5wdXQgdGhhdCB3YXMgY2xpY2tlZCB3aWxsIGhhdmUgdGhlIGFzc29jaWF0ZWQgZGF0YQoJCQkJaWYgKCB0YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCQl0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXRhcmdldCA9IGZpbmRDbG9zZXN0TGluayggdGFyZ2V0ICk7CgkJCQlpZiAoICEoIHRhcmdldCAmJiAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCB0YXJnZXQuZ2V0QXR0cmlidXRlKCAiaHJlZiIgKSB8fCAiIyIgKS5oYXNoICE9PSAiIyIgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUKCQkJCS8vIGxpbmsgd3JhcHBpbmcgY2FuIGJlIGF2b2lkZWQKCQkJCWlmICggISQoIHRhcmdldCApLmpxbUhpamFja2FibGUoKS5sZW5ndGggKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgoJCQkvLyBBdm9pZCBjYWxsaW5nIC5jbG9zZXN0IGJ5IHVzaW5nIHRoZSBkYXRhIHNldCBkdXJpbmcgLmJ1dHRvbk1hcmt1cCgpCgkJCS8vIExpc3QgaXRlbXMgaGF2ZSB0aGUgYnV0dG9uIGRhdGEgaW4gdGhlIHBhcmVudCBvZiB0aGUgZWxlbWVudCBjbGlja2VkCgkJCWlmICggISF+dGFyZ2V0LmNsYXNzTmFtZS5pbmRleE9mKCAidWktbGluay1pbmhlcml0IiApICkgewoJCQkJaWYgKCB0YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCQlidG5FbHMgPSAkLmRhdGEoIHRhcmdldC5wYXJlbnROb2RlLCAiYnV0dG9uRWxlbWVudHMiICk7CgkJCQl9CgkJCS8vIE90aGVyd2lzZSwgbG9vayBmb3IgdGhlIGRhdGEgb24gdGhlIHRhcmdldCBpdHNlbGYKCQkJfSBlbHNlIHsKCQkJCWJ0bkVscyA9ICQuZGF0YSggdGFyZ2V0LCAiYnV0dG9uRWxlbWVudHMiICk7CgkJCX0KCQkJLy8gSWYgZm91bmQsIGdyYWIgdGhlIGJ1dHRvbidzIG91dGVyIGVsZW1lbnQKCQkJaWYgKCBidG5FbHMgKSB7CgkJCQl0YXJnZXQgPSBidG5FbHMub3V0ZXI7CgkJCX0gZWxzZSB7CgkJCQluZWVkQ2xvc2VzdCA9IHRydWU7CgkJCX0KCgkJCSRidG4gPSAkKCB0YXJnZXQgKTsKCQkJLy8gSWYgdGhlIG91dGVyIGVsZW1lbnQgd2Fzbid0IGZvdW5kIGJ5IHRoZSBvdXIgaGV1cmlzdGljcywgdXNlIC5jbG9zZXN0KCkKCQkJaWYgKCBuZWVkQ2xvc2VzdCApIHsKCQkJCSRidG4gPSAkYnRuLmNsb3Nlc3QoICIudWktYnRuIiApOwoJCQl9CgoJCQlpZiAoICRidG4ubGVuZ3RoID4gMCAmJgoJCQkJISggJGJ0bi5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiB8fAoKCQkJCQkvLyBERVBSRUNBVEVEIGFzIG9mIDEuNC4wIC0gcmVtb3ZlIGFmdGVyIDEuNC4wIHJlbGVhc2UKCQkJCQkvLyBvbmx5IHVpLXN0YXRlLWRpc2FibGVkIHNob3VsZCBiZSBwcmVzZW50IHRoZXJlYWZ0ZXIKCQkJCQkkYnRuLmhhc0NsYXNzKCAidWktZGlzYWJsZWQiICkgKSApICkgewoJCQkJJC5tb2JpbGUucmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluayA9ICRidG47CgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluay5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfQoJCX0pOwoKCQkvLyBjbGljayByb3V0aW5nIC0gZGlyZWN0IHRvIEhUVFAgb3IgQWpheCwgYWNjb3JkaW5nbHkKCQkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWlmICggISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCB8fCBldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGxpbmsgPSBmaW5kQ2xvc2VzdExpbmsoIGV2ZW50LnRhcmdldCApLAoJCQkJJGxpbmsgPSAkKCBsaW5rICksCgoJCQkJLy9yZW1vdmUgYWN0aXZlIGxpbmsgY2xhc3MgaWYgZXh0ZXJuYWwgKHRoZW4gaXQgd29uJ3QgYmUgdGhlcmUgaWYgeW91IGNvbWUgYmFjaykKCQkJCWh0dHBDbGVhbnVwID0gZnVuY3Rpb24oKSB7CgkJCQkJd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7ICQubW9iaWxlLnJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOyB9LCAyMDAgKTsKCQkJCX0sCgkJCQliYXNlVXJsLCBocmVmLAoJCQkJdXNlRGVmYXVsdFVybEhhbmRsaW5nLCBpc0V4dGVybmFsLAoJCQkJdHJhbnNpdGlvbiwgcmV2ZXJzZSwgcm9sZTsKCgkJCS8vIElmIGEgYnV0dG9uIHdhcyBjbGlja2VkLCBjbGVhbiB1cCB0aGUgYWN0aXZlIGNsYXNzIGFkZGVkIGJ5IHZjbGljayBhYm92ZQoJCQlpZiAoICQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rICYmCgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGlua1sgMCBdID09PSBldmVudC50YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCWh0dHBDbGVhbnVwKCk7CgkJCX0KCgkJCS8vIElmIHRoZXJlIGlzIG5vIGxpbmsgYXNzb2NpYXRlZCB3aXRoIHRoZSBjbGljayBvciBpdHMgbm90IGEgbGVmdAoJCQkvLyBjbGljayB3ZSB3YW50IHRvIGlnbm9yZSB0aGUgY2xpY2sKCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUgbGluayB3cmFwcGluZwoJCQkvLyBjYW4gYmUgYXZvaWRlZAoJCQlpZiAoICFsaW5rIHx8IGV2ZW50LndoaWNoID4gMSB8fCAhJGxpbmsuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy9pZiB0aGVyZSdzIGEgZGF0YS1yZWw9YmFjayBhdHRyLCBnbyBiYWNrIGluIGhpc3RvcnkKCQkJaWYgKCAkbGluay5pcyggIjpqcW1EYXRhKHJlbD0nYmFjaycpIiApICkgewoJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQliYXNlVXJsID0gJC5tb2JpbGUuZ2V0Q2xvc2VzdEJhc2VVcmwoICRsaW5rICk7CgoJCQkvL2dldCBocmVmLCBpZiBkZWZpbmVkLCBvdGhlcndpc2UgZGVmYXVsdCB0byBlbXB0eSBoYXNoCgkJCWhyZWYgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGxpbmsuYXR0ciggImhyZWYiICkgfHwgIiMiLCBiYXNlVXJsICk7CgoJCQkvL2lmIGFqYXggaXMgZGlzYWJsZWQsIGV4aXQgZWFybHkKCQkJaWYgKCAhJC5tb2JpbGUuYWpheEVuYWJsZWQgJiYgISQubW9iaWxlLnBhdGguaXNFbWJlZGRlZFBhZ2UoIGhyZWYgKSApIHsKCQkJCWh0dHBDbGVhbnVwKCk7CgkJCQkvL3VzZSBkZWZhdWx0IGNsaWNrIGhhbmRsaW5nCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFhYWF9qYmxhczogSWRlYWxseSBsaW5rcyB0byBhcHBsaWNhdGlvbiBwYWdlcyBzaG91bGQgYmUgc3BlY2lmaWVkIGFzCgkJCS8vICAgICAgICAgICAgYW4gdXJsIHRvIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudCB3aXRoIGEgaGFzaCB0aGF0IGlzIGVpdGhlcgoJCQkvLyAgICAgICAgICAgIHRoZSBzaXRlIHJlbGF0aXZlIHBhdGggb3IgaWQgdG8gdGhlIHBhZ2UuIEJ1dCBzb21lIG9mIHRoZQoJCQkvLyAgICAgICAgICAgIGludGVybmFsIGNvZGUgdGhhdCBkeW5hbWljYWxseSBnZW5lcmF0ZXMgc3ViLXBhZ2VzIGZvciBuZXN0ZWQKCQkJLy8gICAgICAgICAgICBsaXN0cyBhbmQgc2VsZWN0IGRpYWxvZ3MsIGp1c3Qgd3JpdGUgYSBoYXNoIGluIHRoZSBsaW5rIHRoZXkKCQkJLy8gICAgICAgICAgICBjcmVhdGUuIFRoaXMgbWVhbnMgdGhlIGFjdHVhbCBVUkwgcGF0aCBpcyBiYXNlZCBvbiB3aGF0ZXZlcgoJCQkvLyAgICAgICAgICAgIHRoZSBjdXJyZW50IHZhbHVlIG9mIHRoZSBiYXNlIHRhZyBpcyBhdCB0aGUgdGltZSB0aGlzIGNvZGUKCQkJLy8gICAgICAgICAgICBpcyBjYWxsZWQuIEZvciBub3cgd2UgYXJlIGp1c3QgYXNzdW1pbmcgdGhhdCBhbnkgdXJsIHdpdGggYQoJCQkvLyAgICAgICAgICAgIGhhc2ggaW4gaXQgaXMgYW4gYXBwbGljYXRpb24gcGFnZSByZWZlcmVuY2UuCgkJCWlmICggaHJlZi5zZWFyY2goICIjIiApICE9PSAtMSApIHsKCQkJCWhyZWYgPSBocmVmLnJlcGxhY2UoIC9bXiNdKiMvLCAiIiApOwoJCQkJaWYgKCAhaHJlZiApIHsKCQkJCQkvL2xpbmsgd2FzIGFuIGVtcHR5IGhhc2ggbWVhbnQgcHVyZWx5CgkJCQkJLy9mb3IgaW50ZXJhY3Rpb24sIHNvIHdlIGlnbm9yZSBpdC4KCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0gZWxzZSBpZiAoICQubW9iaWxlLnBhdGguaXNQYXRoKCBocmVmICkgKSB7CgkJCQkJLy93ZSBoYXZlIGFwYXRoIHNvIG1ha2UgaXQgdGhlIGhyZWYgd2Ugd2FudCB0byBsb2FkLgoJCQkJCWhyZWYgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgYmFzZVVybCApOwoJCQkJfSBlbHNlIHsKCQkJCQkvL3dlIGhhdmUgYSBzaW1wbGUgaWQgc28gdXNlIHRoZSBkb2N1bWVudFVybCBhcyBpdHMgYmFzZS4KCQkJCQlocmVmID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGhyZWYsIGRvY3VtZW50VXJsLmhyZWZOb0hhc2ggKTsKCQkJCX0KCQkJfQoKCQkJLy8gU2hvdWxkIHdlIGhhbmRsZSB0aGlzIGxpbmssIG9yIGxldCB0aGUgYnJvd3NlciBkZWFsIHdpdGggaXQ/CgkJCXVzZURlZmF1bHRVcmxIYW5kbGluZyA9ICRsaW5rLmlzKCAiW3JlbD0nZXh0ZXJuYWwnXSIgKSB8fCAkbGluay5pcyggIjpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiICkgfHwgJGxpbmsuaXMoICJbdGFyZ2V0XSIgKTsKCgkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cgY3Jvc3MtZG9tYWluIFhIUgoJCQkvLyByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZCB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuCgkJCS8vIFRoaXMgaXMgdXN1YWxseSB0byBhbGxvdyB0aGUgYXBwbGljYXRpb24gdG8gInBob25lIGhvbWUiIGFuZCBmZXRjaCBhcHAgc3BlY2lmaWMKCQkJLy8gZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZQoJCQkvLyBhbGxvd0Nyb3NzRG9tYWluUGFnZXMgb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMKCQkJLy8gcmVxdWVzdHMgdG8gZ28gdGhyb3VnaCBvdXIgcGFnZSBsb2FkaW5nIGxvZ2ljLgoKCQkJLy9jaGVjayBmb3IgcHJvdG9jb2wgb3IgcmVsIGFuZCBpdHMgbm90IGFuIGVtYmVkZGVkIHBhZ2UKCQkJLy9UT0RPIG92ZXJsYXAgaW4gbG9naWMgZnJvbSBpc0V4dGVybmFsLCByZWw9ZXh0ZXJuYWwgY2hlY2sgc2hvdWxkIGJlCgkJCS8vICAgICBtb3ZlZCBpbnRvIG1vcmUgY29tcHJlaGVuc2l2ZSBpc0V4dGVybmFsTGluawoJCQlpc0V4dGVybmFsID0gdXNlRGVmYXVsdFVybEhhbmRsaW5nIHx8ICggJC5tb2JpbGUucGF0aC5pc0V4dGVybmFsKCBocmVmICkgJiYgISQubW9iaWxlLnBhdGguaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3QoIGRvY3VtZW50VXJsLCBocmVmICkgKTsKCgkJCWlmICggaXNFeHRlcm5hbCApIHsKCQkJCWh0dHBDbGVhbnVwKCk7CgkJCQkvL3VzZSBkZWZhdWx0IGNsaWNrIGhhbmRsaW5nCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vdXNlIGFqYXgKCQkJdHJhbnNpdGlvbiA9ICRsaW5rLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApOwoJCQlyZXZlcnNlID0gJGxpbmsuanFtRGF0YSggImRpcmVjdGlvbiIgKSA9PT0gInJldmVyc2UiIHx8CgkJCQkJCS8vIGRlcHJlY2F0ZWQgLSByZW1vdmUgYnkgMS4wCgkJCQkJCSRsaW5rLmpxbURhdGEoICJiYWNrIiApOwoKCQkJLy90aGlzIG1heSBuZWVkIHRvIGJlIG1vcmUgc3BlY2lmaWMgYXMgd2UgdXNlIGRhdGEtcmVsIG1vcmUKCQkJcm9sZSA9ICRsaW5rLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiICkgfHwgdW5kZWZpbmVkOwoKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggaHJlZiwgeyB0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLCByZXZlcnNlOiByZXZlcnNlLCByb2xlOiByb2xlLCBsaW5rOiAkbGluayB9ICk7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfSk7CgoJCS8vcHJlZmV0Y2ggcGFnZXMgd2hlbiBhbmNob3JzIHdpdGggZGF0YS1wcmVmZXRjaCBhcmUgZW5jb3VudGVyZWQKCQkkLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggIi51aS1wYWdlIiwgInBhZ2VzaG93LnByZWZldGNoIiwgZnVuY3Rpb24oKSB7CgkJCXZhciB1cmxzID0gW107CgkJCSQoIHRoaXMgKS5maW5kKCAiYTpqcW1EYXRhKHByZWZldGNoKSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyICRsaW5rID0gJCggdGhpcyApLAoJCQkJCXVybCA9ICRsaW5rLmF0dHIoICJocmVmIiApOwoKCQkJCWlmICggdXJsICYmICQuaW5BcnJheSggdXJsLCB1cmxzICkgPT09IC0xICkgewoJCQkJCXVybHMucHVzaCggdXJsICk7CgoJCQkJCSQubW9iaWxlLmxvYWRQYWdlKCB1cmwsIHsgcm9sZTogJGxpbmsuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbCIgKSxwcmVmZXRjaDogdHJ1ZSB9ICk7CgkJCQl9CgkJCX0pOwoJCX0pOwoKCQkvLyBUT0RPIGVuc3VyZSB0aGF0IHRoZSBuYXZpZ2F0ZSBiaW5kaW5nIGluIHRoZSBjb250ZW50IHdpZGdldCBoYXBwZW5zIGF0IHRoZSByaWdodCB0aW1lCgkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5wYWdlY29udGFpbmVyKCk7CgoJCS8vc2V0IHBhZ2UgbWluLWhlaWdodHMgdG8gYmUgZGV2aWNlIHNwZWNpZmljCgkJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VzaG93IiwgJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0ICk7CgkJJC5tb2JpbGUud2luZG93LmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCAkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCgl9Oy8vbmF2cmVhZHlEZWZlcnJlZCBkb25lIGNhbGxiYWNrCgoJJCggZnVuY3Rpb24oKSB7IGRvbXJlYWR5RGVmZXJyZWQucmVzb2x2ZSgpOyB9ICk7CgoJJC53aGVuKCBkb21yZWFkeURlZmVycmVkLCAkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkICkuZG9uZSggZnVuY3Rpb24oKSB7ICQubW9iaWxlLl9yZWdpc3RlckludGVybmFsRXZlbnRzKCk7IH0gKTsKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgoJLy8gVE9ETyByZW1vdmUgZGlyZWN0IHJlZmVyZW5jZXMgdG8gJC5tb2JpbGUgYW5kIHByb3BlcnRpZXMsIHdlIHNob3VsZAoJLy8gICAgICBmYXZvciBpbmplY3Rpb24gd2l0aCBwYXJhbXMgdG8gdGhlIGNvbnN0cnVjdG9yCgkkLm1vYmlsZS5UcmFuc2l0aW9uID0gZnVuY3Rpb24oKSB7CgkJdGhpcy5pbml0LmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuVHJhbnNpdGlvbi5wcm90b3R5cGUsIHsKCQl0b1ByZUNsYXNzOiAiIHVpLXBhZ2UtcHJlLWluIiwKCgkJaW5pdDogZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20gKSB7CgkJCSQuZXh0ZW5kKHRoaXMsIHsKCQkJCW5hbWU6IG5hbWUsCgkJCQlyZXZlcnNlOiByZXZlcnNlLAoJCQkJJHRvOiAkdG8sCgkJCQkkZnJvbTogJGZyb20sCgkJCQlkZWZlcnJlZDogbmV3ICQuRGVmZXJyZWQoKQoJCQl9KTsKCQl9LAoKCQljbGVhbkZyb206IGZ1bmN0aW9uKCkgewoJCQl0aGlzLiRmcm9tCgkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArICIgb3V0IGluIHJldmVyc2UgIiArIHRoaXMubmFtZSApCgkJCQkuaGVpZ2h0KCAiIiApOwoJCX0sCgoJCS8vIE5PVEUgb3ZlcnJpZGRlbiBieSBjaGlsZCBvYmplY3QgcHJvdG90eXBlcywgbm9vcCdkIGhlcmUgYXMgZGVmYXVsdHMKCQliZWZvcmVEb25lSW46IGZ1bmN0aW9uKCkge30sCgkJYmVmb3JlRG9uZU91dDogZnVuY3Rpb24oKSB7fSwKCQliZWZvcmVTdGFydE91dDogZnVuY3Rpb24oKSB7fSwKCgkJZG9uZUluOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5iZWZvcmVEb25lSW4oKTsKCgkJCXRoaXMuJHRvLnJlbW92ZUNsYXNzKCAib3V0IGluIHJldmVyc2UgIiArIHRoaXMubmFtZSApLmhlaWdodCggIiIgKTsKCgkJCXRoaXMudG9nZ2xlVmlld3BvcnRDbGFzcygpOwoKCQkJLy8gSW4gc29tZSBicm93c2VycyAoaU9TNSksIDNEIHRyYW5zaXRpb25zIGJsb2NrIHRoZSBhYmlsaXR5IHRvIHNjcm9sbCB0byB0aGUgZGVzaXJlZCBsb2NhdGlvbiBkdXJpbmcgdHJhbnNpdGlvbgoJCQkvLyBUaGlzIGVuc3VyZXMgd2UganVtcCB0byB0aGF0IHNwb3QgYWZ0ZXIgdGhlIGZhY3QsIGlmIHdlIGFyZW4ndCB0aGVyZSBhbHJlYWR5LgoJCQlpZiAoICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSAhPT0gdGhpcy50b1Njcm9sbCApIHsKCQkJCXRoaXMuc2Nyb2xsUGFnZSgpOwoJCQl9CgkJCWlmICggIXRoaXMuc2VxdWVudGlhbCApIHsKCQkJCXRoaXMuJHRvLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKTsKCQkJfQoJCQl0aGlzLmRlZmVycmVkLnJlc29sdmUoIHRoaXMubmFtZSwgdGhpcy5yZXZlcnNlLCB0aGlzLiR0bywgdGhpcy4kZnJvbSwgdHJ1ZSApOwoJCX0sCgoJCWRvbmVPdXQ6IGZ1bmN0aW9uKCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSwgcHJldmVudEZvY3VzICkgewoJCQl0aGlzLmJlZm9yZURvbmVPdXQoKTsKCQkJdGhpcy5zdGFydEluKCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSwgcHJldmVudEZvY3VzICk7CgkJfSwKCgkJaGlkZUluOiBmdW5jdGlvbiggY2FsbGJhY2sgKSB7CgkJCS8vIFByZXZlbnQgZmxpY2tlcmluZyBpbiBwaG9uZWdhcCBjb250YWluZXI6IHNlZSBjb21tZW50cyBhdCAjNDAyNCByZWdhcmRpbmcgaU9TCgkJCXRoaXMuJHRvLmNzcyggInotaW5kZXgiLCAtMTAgKTsKCQkJY2FsbGJhY2suY2FsbCggdGhpcyApOwoJCQl0aGlzLiR0by5jc3MoICJ6LWluZGV4IiwgIiIgKTsKCQl9LAoKCQlzY3JvbGxQYWdlOiBmdW5jdGlvbigpIHsKCQkJLy8gQnkgdXNpbmcgc2Nyb2xsVG8gaW5zdGVhZCBvZiBzaWxlbnRTY3JvbGwsIHdlIGNhbiBrZWVwIHRoaW5ncyBiZXR0ZXIgaW4gb3JkZXIKCQkJLy8gSnVzdCB0byBiZSBwcmVjYXV0aW9zLCBkaXNhYmxlIHNjcm9sbHN0YXJ0IGxpc3RlbmluZyBsaWtlIHNpbGVudFNjcm9sbCB3b3VsZAoJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IGZhbHNlOwoJCQkvL2lmIHdlIGFyZSBoaWRpbmcgdGhlIHVybCBiYXIgb3IgdGhlIHBhZ2Ugd2FzIHByZXZpb3VzbHkgc2Nyb2xsZWQgc2Nyb2xsIHRvIGhpZGUgb3IgcmV0dXJuIHRvIHBvc2l0aW9uCgkJCWlmICggJC5tb2JpbGUuaGlkZVVybEJhciB8fCB0aGlzLnRvU2Nyb2xsICE9PSAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCApIHsKCQkJCXdpbmRvdy5zY3JvbGxUbyggMCwgdGhpcy50b1Njcm9sbCApOwoJCQl9CgoJCQkvLyByZWVuYWJsZSBzY3JvbGxzdGFydCBsaXN0ZW5pbmcgbGlrZSBzaWxlbnRTY3JvbGwgd291bGQKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IHRydWU7CgkJCX0sIDE1MCApOwoJCX0sCgoJCXN0YXJ0SW46IGZ1bmN0aW9uKCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSwgcHJldmVudEZvY3VzICkgewoJCQl0aGlzLmhpZGVJbihmdW5jdGlvbigpIHsKCQkJCXRoaXMuJHRvLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKyB0aGlzLnRvUHJlQ2xhc3MgKTsKCgkJCQkvLyBTZW5kIGZvY3VzIHRvIHBhZ2UgYXMgaXQgaXMgbm93IGRpc3BsYXk6IGJsb2NrCgkJCQlpZiAoICFwcmV2ZW50Rm9jdXMgKSB7CgkJCQkJJC5tb2JpbGUuZm9jdXNQYWdlKCB0aGlzLiR0byApOwoJCQkJfQoKCQkJCS8vIFNldCB0byBwYWdlIGhlaWdodAoJCQkJdGhpcy4kdG8uaGVpZ2h0KCBzY3JlZW5IZWlnaHQgKyB0aGlzLnRvU2Nyb2xsICk7CgogICAgICAgICAgICAgICAgaWYgKCAhbm9uZSApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbFBhZ2UoKTsKICAgICAgICAgICAgICAgIH0KCQkJfSk7CgoJCQlpZiAoICFub25lICkgewoJCQkJdGhpcy4kdG8uYW5pbWF0aW9uQ29tcGxldGUoICQucHJveHkoZnVuY3Rpb24oKSB7CgkJCQkJdGhpcy5kb25lSW4oKTsKCQkJCX0sIHRoaXMgKSk7CgkJCX0KCgkJCXRoaXMuJHRvCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMudG9QcmVDbGFzcyApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgaW4gIiArIHJldmVyc2VDbGFzcyApOwoKCQkJaWYgKCBub25lICkgewoJCQkJdGhpcy5kb25lSW4oKTsKCQkJfQoKCQl9LAoKCQlzdGFydE91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICkgewoJCQl0aGlzLmJlZm9yZVN0YXJ0T3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApOwoKCQkJLy8gU2V0IHRoZSBmcm9tIHBhZ2UncyBoZWlnaHQgYW5kIHN0YXJ0IGl0IHRyYW5zaXRpb25pbmcgb3V0CgkJCS8vIE5vdGU6IHNldHRpbmcgYW4gZXhwbGljaXQgaGVpZ2h0IGhlbHBzIGVsaW1pbmF0ZSB0aWxpbmcgaW4gdGhlIHRyYW5zaXRpb25zCgkJCXRoaXMuJGZyb20KCQkJCS5oZWlnaHQoIHNjcmVlbkhlaWdodCArICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgb3V0IiArIHJldmVyc2VDbGFzcyApOwoJCX0sCgoJCXRvZ2dsZVZpZXdwb3J0Q2xhc3M6IGZ1bmN0aW9uKCkgewoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnRvZ2dsZUNsYXNzKCAidWktbW9iaWxlLXZpZXdwb3J0LXRyYW5zaXRpb25pbmcgdmlld3BvcnQtIiArIHRoaXMubmFtZSApOwoJCX0sCgoJCXRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewoJCQkvLyBOT1RFIG1hbnkgb2YgdGhlc2UgY291bGQgYmUgY2FsY3VsYXRlZC9yZWNvcmRlZCBpbiB0aGUgY29uc3RydWN0b3IsIGl0J3MgbXkKCQkJLy8gICAgICBvcGluaW9uIHRoYXQgYmluZGluZyB0aGVtIGFzIGxhdGUgYXMgcG9zc2libGUgaGFzIHZhbHVlIHdpdGggcmVnYXJkcyB0bwoJCQkvLyAgICAgIGJldHRlciB0cmFuc2l0aW9ucyB3aXRoIGZld2VyIGJ1Z3MuIEllLCBpdCdzIG5vdCBndWFyYW50ZWVkIHRoYXQgdGhlCgkJCS8vICAgICAgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZCBhbmQgdHJhbnNpdGlvbiB3aWxsIGJlIHJ1biBpbW1lZGlhdGVseSBhZnRlciBhcwoJCQkvLyAgICAgIGl0IGlzIHRvZGF5LiBTbyB3ZSB3YWl0IHVudGlsIHRyYW5zaXRpb24gaXMgaW52b2tlZCB0byBnYXRoZXIgdGhlIGZvbGxvd2luZwoJCQl2YXIgcmV2ZXJzZUNsYXNzID0gdGhpcy5yZXZlcnNlID8gIiByZXZlcnNlIiA6ICIiLAoJCQkJc2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCksCgkJCQltYXhUcmFuc2l0aW9uT3ZlcnJpZGUgPSAkLm1vYmlsZS5tYXhUcmFuc2l0aW9uV2lkdGggIT09IGZhbHNlICYmICQubW9iaWxlLndpbmRvdy53aWR0aCgpID4gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoLAoJCQkJbm9uZSA9ICEkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgfHwgISQuc3VwcG9ydC5jc3NBbmltYXRpb25zIHx8IG1heFRyYW5zaXRpb25PdmVycmlkZSB8fCAhdGhpcy5uYW1lIHx8IHRoaXMubmFtZSA9PT0gIm5vbmUiIHx8IE1hdGgubWF4KCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCksIHRoaXMudG9TY3JvbGwgKSA+ICQubW9iaWxlLmdldE1heFNjcm9sbEZvclRyYW5zaXRpb24oKTsKCgkJCXRoaXMudG9TY3JvbGwgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmdldEFjdGl2ZSgpLmxhc3RTY3JvbGwgfHwgJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJCXRoaXMudG9nZ2xlVmlld3BvcnRDbGFzcygpOwoKCQkJaWYgKCB0aGlzLiRmcm9tICYmICFub25lICkgewoJCQkJdGhpcy5zdGFydE91dCggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZG9uZU91dCggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUsIHRydWUgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZGVmZXJyZWQucHJvbWlzZSgpOwoJCX0KCX0pOwp9KSggalF1ZXJ5LCB0aGlzICk7CgoKKGZ1bmN0aW9uKCAkICkgewoKCSQubW9iaWxlLlNlcmlhbFRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQl0aGlzLmluaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuU2VyaWFsVHJhbnNpdGlvbi5wcm90b3R5cGUsICQubW9iaWxlLlRyYW5zaXRpb24ucHJvdG90eXBlLCB7CgkJc2VxdWVudGlhbDogdHJ1ZSwKCgkJYmVmb3JlRG9uZU91dDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy4kZnJvbSApIHsKCQkJCXRoaXMuY2xlYW5Gcm9tKCk7CgkJCX0KCQl9LAoKCQliZWZvcmVTdGFydE91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICkgewoJCQl0aGlzLiRmcm9tLmFuaW1hdGlvbkNvbXBsZXRlKCQucHJveHkoZnVuY3Rpb24oKSB7CgkJCQl0aGlzLmRvbmVPdXQoIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICk7CgkJCX0sIHRoaXMgKSk7CgkJfQoJfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkICkgewoKCSQubW9iaWxlLkNvbmN1cnJlbnRUcmFuc2l0aW9uID0gZnVuY3Rpb24oKSB7CgkJdGhpcy5pbml0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cgl9OwoKCSQuZXh0ZW5kKCQubW9iaWxlLkNvbmN1cnJlbnRUcmFuc2l0aW9uLnByb3RvdHlwZSwgJC5tb2JpbGUuVHJhbnNpdGlvbi5wcm90b3R5cGUsIHsKCQlzZXF1ZW50aWFsOiBmYWxzZSwKCgkJYmVmb3JlRG9uZUluOiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLiRmcm9tICkgewoJCQkJdGhpcy5jbGVhbkZyb20oKTsKCQkJfQoJCX0sCgoJCWJlZm9yZVN0YXJ0T3V0OiBmdW5jdGlvbiggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKSB7CgkJCXRoaXMuZG9uZU91dCggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKTsKCQl9Cgl9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQgKSB7CgoJLy8gZ2VuZXJhdGUgdGhlIGhhbmRsZXJzIGZyb20gdGhlIGFib3ZlCgl2YXIgZGVmYXVsdEdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCkgKiAzOwoJfTsKCgkvL3RyYW5zaXRpb24gaGFuZGxlciBkaWN0aW9uYXJ5IGZvciAzcmQgcGFydHkgdHJhbnNpdGlvbnMKCSQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycyA9IHsKCQkic2VxdWVudGlhbCI6ICQubW9iaWxlLlNlcmlhbFRyYW5zaXRpb24sCgkJInNpbXVsdGFuZW91cyI6ICQubW9iaWxlLkNvbmN1cnJlbnRUcmFuc2l0aW9uCgl9OwoKCS8vIE1ha2Ugb3VyIHRyYW5zaXRpb24gaGFuZGxlciB0aGUgcHVibGljIGRlZmF1bHQuCgkkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIgPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2VxdWVudGlhbDsKCgkkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzID0ge307CgoJLy8gSWYgdHJhbnNpdGlvbiBpcyBkZWZpbmVkLCBjaGVjayBpZiBjc3MgM0QgdHJhbnNmb3JtcyBhcmUgc3VwcG9ydGVkLCBhbmQgaWYgbm90LCBpZiBhIGZhbGxiYWNrIGlzIHNwZWNpZmllZAoJJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gPSBmdW5jdGlvbiggdHJhbnNpdGlvbiApIHsKCQlpZiAoIHRyYW5zaXRpb24gJiYgISQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF0gKSB7CgkJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF07CgkJfQoKCQlyZXR1cm4gdHJhbnNpdGlvbjsKCX07CgoJLy8gU2V0IHRoZSBnZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uIHRvIGRlZmF1bHQgaWYgbm8gaW1wbGVtZW50YXRpb24gd2FzIHNldCBieSB1c2VyCgkkLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uID0gJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB8fCBkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbjsKCn0pKCBqUXVlcnkgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgZmxpcCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MuZmxpcCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgZmxvdyBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MuZmxvdyA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgcG9wIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5wb3AgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gVXNlIHRoZSBzaW11bHRhbmVvdXMgdHJhbnNpdGlvbnMgaGFuZGxlciBmb3Igc2xpZGUgdHJhbnNpdGlvbnMKJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzLnNsaWRlID0gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzLnNpbXVsdGFuZW91czsKCi8vIFNldCB0aGUgc2xpZGUgdHJhbnNpdGlvbnMncyBmYWxsYmFjayB0byAiZmFkZSIKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZSA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGVkb3duIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZWRvd24gPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlZmFkZSBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCi8vIFNldCB0aGUgc2xpZGUgdHJhbnNpdGlvbnMncyBmYWxsYmFjayB0byAiZmFkZSIKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZWZhZGUgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRldXAgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRldXAgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHR1cm4gaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnR1cm4gPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5kZWdyYWRlSW5wdXRzID0gewoJY29sb3I6IGZhbHNlLAoJZGF0ZTogZmFsc2UsCglkYXRldGltZTogZmFsc2UsCgkiZGF0ZXRpbWUtbG9jYWwiOiBmYWxzZSwKCWVtYWlsOiBmYWxzZSwKCW1vbnRoOiBmYWxzZSwKCW51bWJlcjogZmFsc2UsCglyYW5nZTogIm51bWJlciIsCglzZWFyY2g6ICJ0ZXh0IiwKCXRlbDogZmFsc2UsCgl0aW1lOiBmYWxzZSwKCXVybDogZmFsc2UsCgl3ZWVrOiBmYWxzZQp9OwovLyBCYWNrY29tcGF0IHJlbW92ZSBpbiAxLjUKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5kZWdyYWRlSW5wdXRzID0gJC5tb2JpbGUuZGVncmFkZUlucHV0czsKCi8vIEF1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZGVncmFkZUlucHV0c1dpdGhpbiA9IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgoJdGFyZ2V0ID0gJCggdGFyZ2V0ICk7CgoJLy8gRGVncmFkZSBpbnB1dHMgdG8gYXZvaWQgcG9vcmx5IGltcGxlbWVudGVkIG5hdGl2ZSBmdW5jdGlvbmFsaXR5Cgl0YXJnZXQuZmluZCggImlucHV0IiApLm5vdCggJC5tb2JpbGUucGFnZS5wcm90b3R5cGUua2VlcE5hdGl2ZVNlbGVjdG9yKCkgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtZW50ID0gJCggdGhpcyApLAoJCQl0eXBlID0gdGhpcy5nZXRBdHRyaWJ1dGUoICJ0eXBlIiApLAoJCQlvcHRUeXBlID0gJC5tb2JpbGUuZGVncmFkZUlucHV0c1sgdHlwZSBdIHx8ICJ0ZXh0IiwKCQkJaHRtbCwgaGFzVHlwZSwgZmluZHN0ciwgcmVwc3RyOwoKCQlpZiAoICQubW9iaWxlLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSApIHsKCQkJaHRtbCA9ICQoICI8ZGl2PiIgKS5odG1sKCBlbGVtZW50LmNsb25lKCkgKS5odG1sKCk7CgkJCS8vIEluIElFIGJyb3dzZXJzLCB0aGUgdHlwZSBzb21ldGltZXMgZG9lc24ndCBleGlzdCBpbiB0aGUgY2xvbmVkIG1hcmt1cCwgc28gd2UgcmVwbGFjZSB0aGUgY2xvc2luZyB0YWcgaW5zdGVhZAoJCQloYXNUeXBlID0gaHRtbC5pbmRleE9mKCAiIHR5cGU9IiApID4gLTE7CgkJCWZpbmRzdHIgPSBoYXNUeXBlID8gL1xzK3R5cGU9WyInXT9cdytbJyJdPy8gOiAvXC8/Pi87CgkJCXJlcHN0ciA9ICIgdHlwZT1cIiIgKyBvcHRUeXBlICsgIlwiIGRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGU9XCIiICsgdHlwZSArICJcIiIgKyAoIGhhc1R5cGUgPyAiIiA6ICI+IiApOwoKCQkJZWxlbWVudC5yZXBsYWNlV2l0aCggaHRtbC5yZXBsYWNlKCBmaW5kc3RyLCByZXBzdHIgKSApOwoJCX0KCX0pOwoKfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5wYWdlIiwgJC5tb2JpbGUucGFnZSwgewoJb3B0aW9uczogewoKCQkvLyBBY2NlcHRzIGxlZnQsIHJpZ2h0IGFuZCBub25lCgkJY2xvc2VCdG46ICJsZWZ0IiwKCQljbG9zZUJ0blRleHQ6ICJDbG9zZSIsCgkJb3ZlcmxheVRoZW1lOiAiYSIsCgkJY29ybmVyczogdHJ1ZSwKCQlkaWFsb2c6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlhbG9nICkgewoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9pbm5lcjogdGhpcy5lbGVtZW50LmNoaWxkcmVuKCksCgkJCQlfaGVhZGVyQ2xvc2VCdXR0b246IG51bGwKCQkJfSk7CgoJCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCQl0aGlzLl9zZXRDbG9zZUJ0biggdGhpcy5vcHRpb25zLmNsb3NlQnRuICk7CgkJCX0KCQl9Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQkvLyBDbGFzcyB0aGUgbWFya3VwIGZvciBkaWFsb2cgc3R5bGluZyBhbmQgd3JhcCBpbnRlcmlvcgoJCWlmICggdGhpcy5vcHRpb25zLmRpYWxvZyApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktZGlhbG9nIiApCgkJCQkud3JhcElubmVyKCAkKCAiPGRpdi8+IiwgewoKCQkJCQkvLyBBUklBIHJvbGUKCQkJCQkicm9sZSIgOiAiZGlhbG9nIiwKCQkJCQkiY2xhc3MiIDogInVpLWRpYWxvZy1jb250YWluIHVpLW92ZXJsYXktc2hhZG93IiArCgkJCQkJCSggdGhpcy5vcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIgKQoJCQkJfSkpOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBjbG9zZUJ1dHRvbkxvY2F0aW9uLCBjbG9zZUJ1dHRvblRleHQsCgkJCWN1cnJlbnRPcHRzID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9pbm5lci50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCAhIW9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLm92ZXJsYXlUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoICQubW9iaWxlLmFjdGl2ZVBhZ2VbIDAgXSA9PT0gdGhpcy5lbGVtZW50WyAwIF0gKSB7CgkJCQljdXJyZW50T3B0cy5vdmVybGF5VGhlbWUgPSBvcHRpb25zLm92ZXJsYXlUaGVtZTsKCQkJCXRoaXMuX2hhbmRsZVBhZ2VCZWZvcmVTaG93KCk7CgkJCX0KCQl9CgoJCWlmICggb3B0aW9ucy5jbG9zZUJ0blRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJY2xvc2VCdXR0b25Mb2NhdGlvbiA9IGN1cnJlbnRPcHRzLmNsb3NlQnRuOwoJCQljbG9zZUJ1dHRvblRleHQgPSBvcHRpb25zLmNsb3NlQnRuVGV4dDsKCQl9CgoJCWlmICggb3B0aW9ucy5jbG9zZUJ0biAhPT0gdW5kZWZpbmVkICkgewoJCQljbG9zZUJ1dHRvbkxvY2F0aW9uID0gb3B0aW9ucy5jbG9zZUJ0bjsKCQl9CgoJCWlmICggY2xvc2VCdXR0b25Mb2NhdGlvbiApIHsKCQkJdGhpcy5fc2V0Q2xvc2VCdG4oIGNsb3NlQnV0dG9uTG9jYXRpb24sIGNsb3NlQnV0dG9uVGV4dCApOwoJCX0KCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0sCgoJX2hhbmRsZVBhZ2VCZWZvcmVTaG93OiBmdW5jdGlvbiAoKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICYmIHRoaXMub3B0aW9ucy5kaWFsb2cgKSB7CgkJCXRoaXMucmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCgpOwoJCQl0aGlzLnNldENvbnRhaW5lckJhY2tncm91bmQoIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgKTsKCQl9IGVsc2UgewoJCQl0aGlzLl9zdXBlcigpOwoJCX0KCX0sCgoJX3NldENsb3NlQnRuOiBmdW5jdGlvbiggbG9jYXRpb24sIHRleHQgKSB7CgkJdmFyIGRzdCwKCQkJYnRuID0gdGhpcy5faGVhZGVyQ2xvc2VCdXR0b247CgoJCS8vIFNhbml0aXplIHZhbHVlCgkJbG9jYXRpb24gPSAibGVmdCIgPT09IGxvY2F0aW9uID8gImxlZnQiIDogInJpZ2h0IiA9PT0gbG9jYXRpb24gPyAicmlnaHQiIDogIm5vbmUiOwoKCQlpZiAoICJub25lIiA9PT0gbG9jYXRpb24gKSB7CgkJCWlmICggYnRuICkgewoJCQkJYnRuLnJlbW92ZSgpOwoJCQkJYnRuID0gbnVsbDsKCQkJfQoJCX0gZWxzZSBpZiAoIGJ0biApIHsKCQkJYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLWxlZnQgdWktYnRuLXJpZ2h0IiApLmFkZENsYXNzKCAidWktYnRuLSIgKyBsb2NhdGlvbiApOwoJCQlpZiAoIHRleHQgKSB7CgkJCQlidG4udGV4dCggdGV4dCApOwoJCQl9CgkJfSBlbHNlIHsKCQkJZHN0ID0gdGhpcy5faW5uZXIuZmluZCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLmZpcnN0KCk7CgkJCWJ0biA9ICQoICI8YT48L2E+IiwgewoJCQkJCSJocmVmIjogIiMiLAoJCQkJCSJjbGFzcyI6ICJ1aS1idG4gdWktY29ybmVyLWFsbCB1aS1pY29uLWRlbGV0ZSB1aS1idG4taWNvbi1ub3RleHQgdWktYnRuLSIgKyBsb2NhdGlvbgoJCQkJfSkKCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIiwgImJhY2siICkKCQkJCS50ZXh0KCB0ZXh0IHx8IHRoaXMub3B0aW9ucy5jbG9zZUJ0blRleHQgfHwgIiIgKQoJCQkJLnByZXBlbmRUbyggZHN0ICk7CgkJCXRoaXMuX29uKCBidG4sIHsgY2xpY2s6ICJjbG9zZSIgfSApOwoJCX0KCgkJdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24gPSBidG47Cgl9Cn0pOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmRpYWxvZyIsIHsKCW9wdGlvbnM6IHsKCgkJLy8gQWNjZXB0cyBsZWZ0LCByaWdodCBhbmQgbm9uZQoJCWNsb3NlQnRuOiAibGVmdCIsCgkJY2xvc2VCdG5UZXh0OiAiQ2xvc2UiLAoJCW92ZXJsYXlUaGVtZTogImEiLAoJCWNvcm5lcnM6IHRydWUKCX0sCgoJLy8gT3ZlcnJpZGUgdGhlIHRoZW1lIHNldCBieSB0aGUgcGFnZSBwbHVnaW4gb24gcGFnZXNob3cKCV9oYW5kbGVQYWdlQmVmb3JlU2hvdzogZnVuY3Rpb24oKSB7CgkJdGhpcy5faXNDbG9zZWFibGUgPSB0cnVlOwoJCWlmICggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApIHsKCQkJdGhpcy5lbGVtZW50CgkJCQkucGFnZSggInJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQiICkKCQkJCS5wYWdlKCAic2V0Q29udGFpbmVyQmFja2dyb3VuZCIsIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgKTsKCQl9Cgl9LAoKCV9oYW5kbGVQYWdlQmVmb3JlSGlkZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5faXNDbG9zZWFibGUgPSBmYWxzZTsKCX0sCgoJLy8gY2xpY2sgYW5kIHN1Ym1pdCBldmVudHM6CgkvLyAtIGNsaWNrcyBhbmQgc3VibWl0cyBzaG91bGQgdXNlIHRoZSBjbG9zaW5nIHRyYW5zaXRpb24gdGhhdCB0aGUgZGlhbG9nCgkvLyAgIG9wZW5lZCB3aXRoIHVubGVzcyBhIGRhdGEtdHJhbnNpdGlvbiBpcyBzcGVjaWZpZWQgb24gdGhlIGxpbmsvZm9ybQoJLy8gLSBpZiB0aGUgY2xpY2sgd2FzIG9uIHRoZSBjbG9zZSBidXR0b24sIG9yIHRoZSBsaW5rIGhhcyBhIGRhdGEtcmVsPSJiYWNrIgoJLy8gICBpdCdsbCBnbyBiYWNrIGluIGhpc3RvcnkgbmF0dXJhbGx5CglfaGFuZGxlVkNsaWNrU3VibWl0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGF0dHJzLAoJCQkkdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggZXZlbnQudHlwZSA9PT0gInZjbGljayIgPyAiYSIgOiAiZm9ybSIgKTsKCgkJaWYgKCAkdGFyZ2V0Lmxlbmd0aCAmJiAhJHRhcmdldC5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSApIHsKCQkJYXR0cnMgPSB7fTsKCQkJYXR0cnNbICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0cmFuc2l0aW9uIiBdID0KCQkJCSggJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5nZXRBY3RpdmUoKSB8fCB7fSApWyAidHJhbnNpdGlvbiIgXSB8fAoJCQkJJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb247CgkJCWF0dHJzWyAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiZGlyZWN0aW9uIiBdID0gInJldmVyc2UiOwoJCQkkdGFyZ2V0LmF0dHIoIGF0dHJzICk7CgkJfQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJLy8gQ2xhc3MgdGhlIG1hcmt1cCBmb3IgZGlhbG9nIHN0eWxpbmcgYW5kIHdyYXAgaW50ZXJpb3IKCQllbGVtLmFkZENsYXNzKCAidWktZGlhbG9nIiApCgkJCS53cmFwSW5uZXIoICQoICI8ZGl2Lz4iLCB7CgoJCQkJLy8gQVJJQSByb2xlCgkJCQkicm9sZSIgOiAiZGlhbG9nIiwKCQkJCSJjbGFzcyIgOiAidWktZGlhbG9nLWNvbnRhaW4gdWktb3ZlcmxheS1zaGFkb3ciICsKCQkJCQkoICEhb3B0cy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiICkKCQkJfSkpOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfaXNDbG9zZWFibGU6IGZhbHNlLAoJCQlfaW5uZXI6IGVsZW0uY2hpbGRyZW4oKSwKCQkJX2hlYWRlckNsb3NlQnV0dG9uOiBudWxsCgkJfSk7CgoJCXRoaXMuX29uKCBlbGVtLCB7CgkJCXZjbGljazogIl9oYW5kbGVWQ2xpY2tTdWJtaXQiLAoJCQlzdWJtaXQ6ICJfaGFuZGxlVkNsaWNrU3VibWl0IiwKCQkJcGFnZWJlZm9yZXNob3c6ICJfaGFuZGxlUGFnZUJlZm9yZVNob3ciLAoJCQlwYWdlYmVmb3JlaGlkZTogIl9oYW5kbGVQYWdlQmVmb3JlSGlkZSIKCQl9KTsKCgkJdGhpcy5fc2V0Q2xvc2VCdG4oIG9wdHMuY2xvc2VCdG4gKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBjbG9zZUJ1dHRvbkxvY2F0aW9uLCBjbG9zZUJ1dHRvblRleHQsCgkJCWN1cnJlbnRPcHRzID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9pbm5lci50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCAhIW9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLm92ZXJsYXlUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoICQubW9iaWxlLmFjdGl2ZVBhZ2VbIDAgXSA9PT0gdGhpcy5lbGVtZW50WyAwIF0gKSB7CgkJCQljdXJyZW50T3B0cy5vdmVybGF5VGhlbWUgPSBvcHRpb25zLm92ZXJsYXlUaGVtZTsKCQkJCXRoaXMuX2hhbmRsZVBhZ2VCZWZvcmVTaG93KCk7CgkJCX0KCQl9CgoJCWlmICggb3B0aW9ucy5jbG9zZUJ0blRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJY2xvc2VCdXR0b25Mb2NhdGlvbiA9IGN1cnJlbnRPcHRzLmNsb3NlQnRuOwoJCQljbG9zZUJ1dHRvblRleHQgPSBvcHRpb25zLmNsb3NlQnRuVGV4dDsKCQl9CgoJCWlmICggb3B0aW9ucy5jbG9zZUJ0biAhPT0gdW5kZWZpbmVkICkgewoJCQljbG9zZUJ1dHRvbkxvY2F0aW9uID0gb3B0aW9ucy5jbG9zZUJ0bjsKCQl9CgoJCWlmICggY2xvc2VCdXR0b25Mb2NhdGlvbiApIHsKCQkJdGhpcy5fc2V0Q2xvc2VCdG4oIGNsb3NlQnV0dG9uTG9jYXRpb24sIGNsb3NlQnV0dG9uVGV4dCApOwoJCX0KCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0sCgoJX3NldENsb3NlQnRuOiBmdW5jdGlvbiggbG9jYXRpb24sIHRleHQgKSB7CgkJdmFyIGRzdCwKCQkJYnRuID0gdGhpcy5faGVhZGVyQ2xvc2VCdXR0b247CgoJCS8vIFNhbml0aXplIHZhbHVlCgkJbG9jYXRpb24gPSAibGVmdCIgPT09IGxvY2F0aW9uID8gImxlZnQiIDogInJpZ2h0IiA9PT0gbG9jYXRpb24gPyAicmlnaHQiIDogIm5vbmUiOwoKCQlpZiAoICJub25lIiA9PT0gbG9jYXRpb24gKSB7CgkJCWlmICggYnRuICkgewoJCQkJYnRuLnJlbW92ZSgpOwoJCQkJYnRuID0gbnVsbDsKCQkJfQoJCX0gZWxzZSBpZiAoIGJ0biApIHsKCQkJYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLWxlZnQgdWktYnRuLXJpZ2h0IiApLmFkZENsYXNzKCAidWktYnRuLSIgKyBsb2NhdGlvbiApOwoJCQlpZiAoIHRleHQgKSB7CgkJCQlidG4udGV4dCggdGV4dCApOwoJCQl9CgkJfSBlbHNlIHsKCQkJZHN0ID0gdGhpcy5faW5uZXIuZmluZCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLmZpcnN0KCk7CgkJCWJ0biA9ICQoICI8YT48L2E+IiwgewoJCQkJCSJyb2xlIjogImJ1dHRvbiIsCgkJCQkJImhyZWYiOiAiIyIsCgkJCQkJImNsYXNzIjogInVpLWJ0biB1aS1jb3JuZXItYWxsIHVpLWljb24tZGVsZXRlIHVpLWJ0bi1pY29uLW5vdGV4dCB1aS1idG4tIiArIGxvY2F0aW9uCgkJCQl9KQoJCQkJLnRleHQoIHRleHQgfHwgdGhpcy5vcHRpb25zLmNsb3NlQnRuVGV4dCB8fCAiIiApCgkJCQkucHJlcGVuZFRvKCBkc3QgKTsKCQkJdGhpcy5fb24oIGJ0biwgeyBjbGljazogImNsb3NlIiB9ICk7CgkJfQoKCQl0aGlzLl9oZWFkZXJDbG9zZUJ1dHRvbiA9IGJ0bjsKCX0sCgoJLy8gQ2xvc2UgbWV0aG9kIGdvZXMgYmFjayBpbiBoaXN0b3J5CgljbG9zZTogZnVuY3Rpb24oKSB7CgkJdmFyIGhpc3QgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5OwoKCQlpZiAoIHRoaXMuX2lzQ2xvc2VhYmxlICkgewoJCQl0aGlzLl9pc0Nsb3NlYWJsZSA9IGZhbHNlOwoJCQkvLyBJZiB0aGUgaGFzaCBsaXN0ZW5pbmcgaXMgZW5hYmxlZCBhbmQgdGhlcmUgaXMgYXQgbGVhc3Qgb25lIHByZWNlZGluZyBoaXN0b3J5CgkJCS8vIGVudHJ5IGl0J3Mgb2sgdG8gZ28gYmFjay4gSW5pdGlhbCBwYWdlcyB3aXRoIHRoZSBkaWFsb2cgaGFzaCBzdGF0ZSBhcmUgYW4gZXhhbXBsZQoJCQkvLyB3aGVyZSB0aGUgc3RhY2sgY2hlY2sgaXMgbmVjZXNzYXJ5CgkJCWlmICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgJiYgaGlzdC5hY3RpdmVJbmRleCA+IDAgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCX0gZWxzZSB7CgkJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnBhZ2Vjb250YWluZXIoICJiYWNrIiApOwoJCQl9CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHJJbml0aWFsTGV0dGVyID0gLyhbQS1aXSkvZzsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbGxhcHNpYmxlIiwgewoJb3B0aW9uczogewoJCWVuaGFuY2VkOiBmYWxzZSwKCQlleHBhbmRDdWVUZXh0OiBudWxsLAoJCWNvbGxhcHNlQ3VlVGV4dDogbnVsbCwKCQljb2xsYXBzZWQ6IHRydWUsCgkJaGVhZGluZzogImgxLGgyLGgzLGg0LGg1LGg2LGxlZ2VuZCIsCgkJY29sbGFwc2VkSWNvbjogbnVsbCwKCQlleHBhbmRlZEljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQl0aGVtZTogbnVsbCwKCQljb250ZW50VGhlbWU6IG51bGwsCgkJaW5zZXQ6IG51bGwsCgkJY29ybmVyczogbnVsbCwKCQltaW5pOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQl1aSA9IHsKCQkJCWFjY29yZGlvbjogZWxlbQoJCQkJCS5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiICsKCQkJCQkJKCAkLm1vYmlsZS5jb2xsYXBzaWJsZXNldCA/ICIsIDptb2JpbGUtY29sbGFwc2libGVzZXQiIDogIiIgKSApCgkJCQkJLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0IiApCgkJCX07CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV91aTogdWkKCQl9KTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXVpLmhlYWRpbmcgPSAkKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmciLCB0aGlzLmVsZW1lbnRbIDAgXSApOwoJCQl1aS5jb250ZW50ID0gdWkuaGVhZGluZy5uZXh0KCk7CgkJCXVpLmFuY2hvciA9ICQoICJhIiwgdWkuaGVhZGluZ1sgMCBdICkuZmlyc3QoKTsKCQkJdWkuc3RhdHVzID0gdWkuYW5jaG9yLmNoaWxkcmVuKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzIiApOwoJCX0gZWxzZSB7CgkJCXRoaXMuX2VuaGFuY2UoIGVsZW0sIHVpICk7CgkJfQoKCQl0aGlzLl9vbiggdWkuaGVhZGluZywgewoJCQkidGFwIjogZnVuY3Rpb24oKSB7CgkJCQl1aS5oZWFkaW5nLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0sCgoJCQkiY2xpY2siOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggIXVpLmhlYWRpbmcuaGFzQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIgKSApOwoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJfSk7Cgl9LAoKCS8vIEFkanVzdCB0aGUga2V5cyBpbnNpZGUgb3B0aW9ucyBmb3IgaW5oZXJpdGVkIHZhbHVlcwoJX2dldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBrZXksCgkJCWFjY29yZGlvbiA9IHRoaXMuX3VpLmFjY29yZGlvbiwKCQkJYWNjb3JkaW9uV2lkZ2V0ID0gdGhpcy5fdWkuYWNjb3JkaW9uV2lkZ2V0OwoKCQkvLyBDb3B5IG9wdGlvbnMKCQlvcHRpb25zID0gJC5leHRlbmQoIHt9LCBvcHRpb25zICk7CgoJCWlmICggYWNjb3JkaW9uLmxlbmd0aCAmJiAhYWNjb3JkaW9uV2lkZ2V0ICkgewoJCQl0aGlzLl91aS5hY2NvcmRpb25XaWRnZXQgPQoJCQlhY2NvcmRpb25XaWRnZXQgPSBhY2NvcmRpb24uZGF0YSggIm1vYmlsZS1jb2xsYXBzaWJsZXNldCIgKTsKCQl9CgoJCWZvciAoIGtleSBpbiBvcHRpb25zICkgewoKCQkJLy8gUmV0cmlldmUgdGhlIG9wdGlvbiB2YWx1ZSBmaXJzdCBmcm9tIHRoZSBvcHRpb25zIG9iamVjdCBwYXNzZWQgaW4gYW5kLCBpZgoJCQkvLyBudWxsLCBmcm9tIHRoZSBwYXJlbnQgYWNjb3JkaW9uIG9yLCBpZiB0aGF0J3MgbnVsbCB0b28sIG9yIGlmIHRoZXJlJ3Mgbm8KCQkJLy8gcGFyZW50IGFjY29yZGlvbiwgdGhlbiBmcm9tIHRoZSBkZWZhdWx0cy4KCQkJb3B0aW9uc1sga2V5IF0gPQoJCQkJKCBvcHRpb25zWyBrZXkgXSAhPSBudWxsICkgPyBvcHRpb25zWyBrZXkgXSA6CgkJCQkoIGFjY29yZGlvbldpZGdldCApID8gYWNjb3JkaW9uV2lkZ2V0Lm9wdGlvbnNbIGtleSBdIDoKCQkJCWFjY29yZGlvbi5sZW5ndGggPyAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIGFjY29yZGlvblsgMCBdLAoJCQkJCWtleS5yZXBsYWNlKCBySW5pdGlhbExldHRlciwgIi0kMSIgKS50b0xvd2VyQ2FzZSgpICk6CgkJCQludWxsOwoKCQkJaWYgKCBudWxsID09IG9wdGlvbnNbIGtleSBdICkgewoJCQkJb3B0aW9uc1sga2V5IF0gPSAkLm1vYmlsZS5jb2xsYXBzaWJsZS5kZWZhdWx0c1sga2V5IF07CgkJCX0KCQl9CgoJCXJldHVybiBvcHRpb25zOwoJfSwKCglfdGhlbWVDbGFzc0Zyb21PcHRpb246IGZ1bmN0aW9uKCBwcmVmaXgsIHZhbHVlICkgewoJCXJldHVybiAoIHZhbHVlID8gKCB2YWx1ZSA9PT0gIm5vbmUiID8gIiIgOiBwcmVmaXggKyB2YWx1ZSApIDogIiIgKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCBlbGVtLCB1aSApIHsKCQl2YXIgaWNvbmNsYXNzLAoJCQlvcHRzID0gdGhpcy5fZ2V0T3B0aW9ucyggdGhpcy5vcHRpb25zICksCgkJCWNvbnRlbnRUaGVtZUNsYXNzID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMuY29udGVudFRoZW1lICk7CgoJCWVsZW0uYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSAiICsKCQkJKCBvcHRzLmluc2V0ID8gInVpLWNvbGxhcHNpYmxlLWluc2V0ICIgOiAiIiApICsKCQkJKCBvcHRzLmluc2V0ICYmIG9wdHMuY29ybmVycyA/ICJ1aS1jb3JuZXItYWxsICIgOiAiIiApICsKCQkJKCBjb250ZW50VGhlbWVDbGFzcyA/ICJ1aS1jb2xsYXBzaWJsZS10aGVtZWQtY29udGVudCAiIDogIiIgKSApOwoJCXVpLm9yaWdpbmFsSGVhZGluZyA9IGVsZW0uY2hpbGRyZW4oIHRoaXMub3B0aW9ucy5oZWFkaW5nICkuZmlyc3QoKSwKCQl1aS5jb250ZW50ID0gZWxlbQoJCQkud3JhcElubmVyKCAiPGRpdiAiICsKCQkJCSJjbGFzcz0ndWktY29sbGFwc2libGUtY29udGVudCAiICsKCQkJCWNvbnRlbnRUaGVtZUNsYXNzICsgIic+PC9kaXY+IiApCgkJCS5jaGlsZHJlbiggIi51aS1jb2xsYXBzaWJsZS1jb250ZW50IiApLAoJCXVpLmhlYWRpbmcgPSB1aS5vcmlnaW5hbEhlYWRpbmc7CgoJCS8vIFJlcGxhY2UgY29sbGFwc2libGVIZWFkaW5nIGlmIGl0J3MgYSBsZWdlbmQKCQlpZiAoIHVpLmhlYWRpbmcuaXMoICJsZWdlbmQiICkgKSB7CgkJCXVpLmhlYWRpbmcgPSAkKCAiPGRpdiByb2xlPSdoZWFkaW5nJz4iKyB1aS5oZWFkaW5nLmh0bWwoKSArIjwvZGl2PiIgKTsKCQkJdWkucGxhY2Vob2xkZXIgPSAkKCAiPGRpdj48IS0tIHBsYWNlaG9sZGVyIGZvciBsZWdlbmQgLS0+PC9kaXY+IiApLmluc2VydEJlZm9yZSggdWkub3JpZ2luYWxIZWFkaW5nICk7CgkJCXVpLm9yaWdpbmFsSGVhZGluZy5yZW1vdmUoKTsKCQl9CgoJCWljb25jbGFzcyA9ICggb3B0cy5jb2xsYXBzZWQgPyAoIG9wdHMuY29sbGFwc2VkSWNvbiA/ICJ1aS1pY29uLSIgKyBvcHRzLmNvbGxhcHNlZEljb24gOiAiIiApOgoJCQkoIG9wdHMuZXhwYW5kZWRJY29uID8gInVpLWljb24tIiArIG9wdHMuZXhwYW5kZWRJY29uIDogIiIgKSApOwoKCQl1aS5zdGF0dXMgPSAkKCAiPHNwYW4gY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzJz48L3NwYW4+IiApOwoJCXVpLmFuY2hvciA9IHVpLmhlYWRpbmcKCQkJLmRldGFjaCgpCgkJCS8vbW9kaWZ5IG1hcmt1cCAmIGF0dHJpYnV0ZXMKCQkJLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZyIgKQoJCQkuYXBwZW5kKCB1aS5zdGF0dXMgKQoJCQkud3JhcElubmVyKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctdG9nZ2xlJz48L2E+IiApCgkJCS5maW5kKCAiYSIgKQoJCQkJLmZpcnN0KCkKCQkJCS5hZGRDbGFzcyggInVpLWJ0biAiICsKCQkJCQkoIGljb25jbGFzcyA/IGljb25jbGFzcyArICIgIiA6ICIiICkgKwoJCQkJCSggaWNvbmNsYXNzID8gKCAidWktYnRuLWljb24tIiArCgkJCQkJCSggb3B0cy5pY29ucG9zID09PSAicmlnaHQiID8gInJpZ2h0IiA6ICJsZWZ0IiApICkgKwoJCQkJCQkiICIgOiAiIiApICsKCQkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJ0bi0iLCBvcHRzLnRoZW1lICkgKyAiICIgKwoJCQkJCSggb3B0cy5taW5pID8gInVpLW1pbmkgIiA6ICIiICkgKTsKCgkJLy9kcm9wIGhlYWRpbmcgaW4gYmVmb3JlIGNvbnRlbnQKCQl1aS5oZWFkaW5nLmluc2VydEJlZm9yZSggdWkuY29udGVudCApOwoKCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggdGhpcy5vcHRpb25zLmNvbGxhcHNlZCApOwoKCQlyZXR1cm4gdWk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBrZXksIG9wdGlvbnMgPSB7fTsKCgkJZm9yICgga2V5IGluICQubW9iaWxlLmNvbGxhcHNpYmxlLmRlZmF1bHRzICkgewoJCQlvcHRpb25zWyBrZXkgXSA9IHRoaXMub3B0aW9uc1sga2V5IF07CgkJfQoKCQl0aGlzLl9zZXRPcHRpb25zKCBvcHRpb25zICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNDb2xsYXBzZWQsIG5ld1RoZW1lLCBvbGRUaGVtZSwgaGFzQ29ybmVycywKCQkJZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJY3VycmVudE9wdHMgPSB0aGlzLl9nZXRPcHRpb25zKCB0aGlzLm9wdGlvbnMgKSwKCQkJdWkgPSB0aGlzLl91aSwKCQkJYW5jaG9yID0gdWkuYW5jaG9yLAoJCQlzdGF0dXMgPSB1aS5zdGF0dXMsCgkJCW9wdHMgPSB0aGlzLl9nZXRPcHRpb25zKCBvcHRpb25zICk7CgoJCS8vIEZpcnN0IGFuZCBmb3JlbW9zdCB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgY29sbGFwc2libGUgaXMgaW4gdGhlIHByb3BlcgoJCS8vIHN0YXRlLCBpbiBjYXNlIHNvbWVib2R5IGRlY2lkZWQgdG8gY2hhbmdlIHRoZSBjb2xsYXBzZWQgb3B0aW9uIGF0IHRoZQoJCS8vIHNhbWUgdGltZSBhcyBhbm90aGVyIG9wdGlvbgoJCWlmICggb3B0aW9ucy5jb2xsYXBzZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5faGFuZGxlRXhwYW5kQ29sbGFwc2UoIG9wdGlvbnMuY29sbGFwc2VkICk7CgkJfQoKCQlpc0NvbGxhcHNlZCA9IGVsZW0uaGFzQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQiICk7CgoJCS8vIE9ubHkgb3B0aW9ucyByZWZlcnJpbmcgdG8gdGhlIGN1cnJlbnQgc3RhdGUgbmVlZCB0byBiZSBhcHBsaWVkIHJpZ2h0IGF3YXkKCQkvLyBJdCBpcyBlbm91Z2ggdG8gc3RvcmUgb3B0aW9ucyBjb3ZlcmluZyB0aGUgYWx0ZXJuYXRlIGluIHRoaXMub3B0aW9ucy4KCQlpZiAoIGlzQ29sbGFwc2VkICkgewoJCQlpZiAoIG9wdHMuZXhwYW5kQ3VlVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQkJc3RhdHVzLnRleHQoIG9wdHMuZXhwYW5kQ3VlVGV4dCApOwoJCQl9CgkJCWlmICggb3B0cy5jb2xsYXBzZWRJY29uICE9PSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIGN1cnJlbnRPcHRzLmNvbGxhcHNlZEljb24gKSB7CgkJCQkJYW5jaG9yLnJlbW92ZUNsYXNzKCAidWktaWNvbi0iICsgY3VycmVudE9wdHMuY29sbGFwc2VkSWNvbiApOwoJCQkJfQoJCQkJaWYgKCBvcHRzLmNvbGxhcHNlZEljb24gKSB7CgkJCQkJYW5jaG9yLmFkZENsYXNzKCAidWktaWNvbi0iICsgb3B0cy5jb2xsYXBzZWRJY29uICk7CgkJCQl9CgkJCX0KCQl9IGVsc2UgewoJCQlpZiAoIG9wdHMuY29sbGFwc2VDdWVUZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQlzdGF0dXMudGV4dCggb3B0cy5jb2xsYXBzZUN1ZVRleHQgKTsKCQkJfQoJCQlpZiAoIG9wdHMuZXhwYW5kZWRJY29uICE9PSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIGN1cnJlbnRPcHRzLmV4cGFuZGVkSWNvbiApIHsKCQkJCQlhbmNob3IucmVtb3ZlQ2xhc3MoICJ1aS1pY29uLSIgKyBjdXJyZW50T3B0cy5leHBhbmRlZEljb24gKTsKCQkJCX0KCQkJCWlmICggb3B0cy5leHBhbmRlZEljb24gKSB7CgkJCQkJYW5jaG9yLmFkZENsYXNzKCAidWktaWNvbi0iICsgb3B0cy5leHBhbmRlZEljb24gKTsKCQkJCX0KCQkJfQoJCX0KCgkJaWYgKCBvcHRzLmljb25wb3MgIT09IHVuZGVmaW5lZCApIHsKCQkJYW5jaG9yLnJlbW92ZUNsYXNzKCAidWktYnRuLWljb24tIiArICggY3VycmVudE9wdHMuaWNvblBvcyA9PT0gInJpZ2h0IiA/ICJyaWdodCIgOiAibGVmdCIgKSApOwoJCQlhbmNob3IuYWRkQ2xhc3MoICJ1aS1idG4taWNvbi0iICsgKCBvcHRzLmljb25Qb3MgPT09ICJyaWdodCIgPyAicmlnaHQiIDogImxlZnQiICkgKTsKCQl9CgoJCWlmICggb3B0cy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlvbGRUaGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYnRuLSIsIGN1cnJlbnRPcHRzLnRoZW1lICk7CgkJCW5ld1RoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1idG4tIiwgb3B0cy50aGVtZSApOwoJCQlhbmNob3IucmVtb3ZlQ2xhc3MoIG9sZFRoZW1lICkuYWRkQ2xhc3MoIG5ld1RoZW1lICk7CgkJfQoKCQlpZiAoIG9wdHMuY29udGVudFRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCW9sZFRoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIGN1cnJlbnRPcHRzLnRoZW1lICk7CgkJCW5ld1RoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMudGhlbWUgKTsKCQkJdWkuY29udGVudC5yZW1vdmVDbGFzcyggb2xkVGhlbWUgKS5hZGRDbGFzcyggbmV3VGhlbWUgKTsKCQl9CgoJCWlmICggb3B0cy5pbnNldCAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtaW5zZXQiLCBvcHRzLmluc2V0ICk7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0cy5pbnNldCAmJiAoIG9wdHMuY29ybmVycyB8fCBjdXJyZW50T3B0cy5jb3JuZXJzICkgKTsKCQl9CgoJCWlmICggb3B0cy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0cy5jb3JuZXJzICYmICggb3B0cy5pbnNldCB8fCBjdXJyZW50T3B0cy5pbnNldCApICk7CgkJfQoKCQlpZiAoIGhhc0Nvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBoYXNDb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdHMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQlhbmNob3IudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgb3B0cy5taW5pICk7CgkJfQoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfaGFuZGxlRXhwYW5kQ29sbGFwc2U6IGZ1bmN0aW9uKCBpc0NvbGxhcHNlICkgewoJCXZhciBvcHRzID0gdGhpcy5fZ2V0T3B0aW9ucyggdGhpcy5vcHRpb25zICksCgkJCXVpID0gdGhpcy5fdWk7CgoJCXVpLnN0YXR1cy50ZXh0KCBpc0NvbGxhcHNlID8gb3B0cy5leHBhbmRDdWVUZXh0IDogb3B0cy5jb2xsYXBzZUN1ZVRleHQgKTsKCQl1aS5oZWFkaW5nCgkJCS50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmctY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApCgkJCS5maW5kKCAiYSIgKS5maXJzdCgpCgkJCS50b2dnbGVDbGFzcyggInVpLWljb24tIiArIG9wdHMuZXhwYW5kZWRJY29uLCAhaXNDb2xsYXBzZSApCgoJCQkvLyBsb2dpYyBvciBjYXVzZSBzYW1lIGljb24gZm9yIGV4cGFuZGVkL2NvbGxhcHNlZCBzdGF0ZSB3b3VsZCByZW1vdmUgdGhlIHVpLWljb24tY2xhc3MKCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgb3B0cy5jb2xsYXBzZWRJY29uLCAoIGlzQ29sbGFwc2UgfHwgb3B0cy5leHBhbmRlZEljb24gPT09IG9wdHMuY29sbGFwc2VkSWNvbiApICkKCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoKCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICk7CgkJdWkuY29udGVudAoJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb250ZW50LWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKQoJCQkuYXR0ciggImFyaWEtaGlkZGVuIiwgaXNDb2xsYXBzZSApCgkJCS50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCXRoaXMub3B0aW9ucy5jb2xsYXBzZWQgPSBpc0NvbGxhcHNlOwoJCXRoaXMuX3RyaWdnZXIoIGlzQ29sbGFwc2UgPyAiY29sbGFwc2UiIDogImV4cGFuZCIgKTsKCX0sCgoJZXhwYW5kOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggZmFsc2UgKTsKCX0sCgoJY29sbGFwc2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2hhbmRsZUV4cGFuZENvbGxhcHNlKCB0cnVlICk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgdWkgPSB0aGlzLl91aSwKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHVpLnBsYWNlaG9sZGVyICkgewoJCQl1aS5vcmlnaW5hbEhlYWRpbmcuaW5zZXJ0QmVmb3JlKCB1aS5wbGFjZWhvbGRlciApOwoJCQl1aS5wbGFjZWhvbGRlci5yZW1vdmUoKTsKCQkJdWkuaGVhZGluZy5yZW1vdmUoKTsKCQl9IGVsc2UgewoJCQl1aS5zdGF0dXMucmVtb3ZlKCk7CgkJCXVpLmhlYWRpbmcKCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmcgdWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiICkKCQkJCS5jaGlsZHJlbigpCgkJCQkJLmNvbnRlbnRzKCkKCQkJCQkJLnVud3JhcCgpOwoJCX0KCgkJdWkuYW5jaG9yLmNvbnRlbnRzKCkudW53cmFwKCk7CgkJdWkuY29udGVudC5jb250ZW50cygpLnVud3JhcCgpOwoJCXRoaXMuZWxlbWVudAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSB1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQgIiArCgkJCQkidWktY29sbGFwc2libGUtdGhlbWVkLWNvbnRlbnQgdWktY29sbGFwc2libGUtaW5zZXQgdWktY29ybmVyLWFsbCIgKTsKCX0KfSk7CgovLyBEZWZhdWx0cyB0byBiZSB1c2VkIGJ5IGFsbCBpbnN0YW5jZXMgb2YgY29sbGFwc2libGUgaWYgcGVyLWluc3RhbmNlIHZhbHVlcwovLyBhcmUgdW5zZXQgb3IgaWYgbm90aGluZyBpcyBzcGVjaWZpZWQgYnkgd2F5IG9mIGluaGVyaXRhbmNlIGZyb20gYW4gYWNjb3JkaW9uLgovLyBOb3RlIHRoYXQgdGhpcyBoYXNoIGRvZXMgbm90IGNvbnRhaW4gb3B0aW9ucyAiY29sbGFwc2VkIiBvciAiaGVhZGluZyIsCi8vIGJlY2F1c2UgdGhvc2UgYXJlIG5vdCBpbmhlcml0YWJsZS4KJC5tb2JpbGUuY29sbGFwc2libGUuZGVmYXVsdHMgPSB7CglleHBhbmRDdWVUZXh0OiAiIGNsaWNrIHRvIGV4cGFuZCBjb250ZW50cyIsCgljb2xsYXBzZUN1ZVRleHQ6ICIgY2xpY2sgdG8gY29sbGFwc2UgY29udGVudHMiLAoJY29sbGFwc2VkSWNvbjogInBsdXMiLAoJY29udGVudFRoZW1lOiAiaW5oZXJpdCIsCglleHBhbmRlZEljb246ICJtaW51cyIsCglpY29ucG9zOiAicmlnaHQiLAoJaW5zZXQ6IHRydWUsCgljb3JuZXJzOiB0cnVlLAoJdGhlbWU6ICJpbmhlcml0IiwKCW1pbmk6IGZhbHNlCn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzID0gewoJX2dldFZpc2libGVzOiBmdW5jdGlvbiggJGVscywgY3JlYXRlICkgewoJCXZhciB2aXNpYmxlczsKCgkJaWYgKCBjcmVhdGUgKSB7CgkJCXZpc2libGVzID0gJGVscy5ub3QoICIudWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9IGVsc2UgewoJCQl2aXNpYmxlcyA9ICRlbHMuZmlsdGVyKCAiOnZpc2libGUiICk7CgkJCWlmICggdmlzaWJsZXMubGVuZ3RoID09PSAwICkgewoJCQkJdmlzaWJsZXMgPSAkZWxzLm5vdCggIi51aS1zY3JlZW4taGlkZGVuIiApOwoJCQl9CgkJfQoKCQlyZXR1cm4gdmlzaWJsZXM7Cgl9LAoKCV9hZGRGaXJzdExhc3RDbGFzc2VzOiBmdW5jdGlvbiggJGVscywgJHZpc2libGVzLCBjcmVhdGUgKSB7CgkJJGVscy5yZW1vdmVDbGFzcyggInVpLWZpcnN0LWNoaWxkIHVpLWxhc3QtY2hpbGQiICk7CgkJJHZpc2libGVzLmVxKCAwICkuYWRkQ2xhc3MoICJ1aS1maXJzdC1jaGlsZCIgKS5lbmQoKS5sYXN0KCkuYWRkQ2xhc3MoICJ1aS1sYXN0LWNoaWxkIiApOwoJCWlmICggIWNyZWF0ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJ1cGRhdGVsYXlvdXQiICk7CgkJfQoJfSwKCglfcmVtb3ZlRmlyc3RMYXN0Q2xhc3NlczogZnVuY3Rpb24oICRlbHMgKSB7CgkJJGVscy5yZW1vdmVDbGFzcyggInVpLWZpcnN0LWNoaWxkIHVpLWxhc3QtY2hpbGQiICk7Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBjaGlsZENvbGxhcHNpYmxlc1NlbGVjdG9yID0gIjptb2JpbGUtY29sbGFwc2libGUsICIgKyAkLm1vYmlsZS5jb2xsYXBzaWJsZS5pbml0U2VsZWN0b3I7CgokLndpZGdldCggIm1vYmlsZS5jb2xsYXBzaWJsZXNldCIsICQuZXh0ZW5kKCB7CgoJLy8gVGhlIGluaXRTZWxlY3RvciBpcyBkZXByZWNhdGVkIGFzIG9mIDEuNC4wLiBJbiAxLjUuMCB3ZSB3aWxsIHVzZQoJLy8gOmpxbURhdGEocm9sZT0nY29sbGFwc2libGVzZXQnKSB3aGljaCB3aWxsIGFsbG93IHVzIHRvIGdldCByaWQgb2YgdGhlIGxpbmUKCS8vIGJlbG93IGFsdG9nZXRoZXIsIGJlY2F1c2UgdGhlIGF1dG9pbml0IHdpbGwgZ2VuZXJhdGUgc3VjaCBhbiBpbml0U2VsZWN0b3IKCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpLDpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlc2V0JykiLAoKCW9wdGlvbnM6ICQuZXh0ZW5kKCB7CgkJZW5oYW5jZWQ6IGZhbHNlCgl9LCAkLm1vYmlsZS5jb2xsYXBzaWJsZS5kZWZhdWx0cyApLAoKCV9oYW5kbGVDb2xsYXBzaWJsZUV4cGFuZDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBjbG9zZXN0Q29sbGFwc2libGUgPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLWNvbGxhcHNpYmxlIiApOwoKCQlpZiAoIGNsb3Nlc3RDb2xsYXBzaWJsZS5wYXJlbnQoKS5pcyggIjptb2JpbGUtY29sbGFwc2libGVzZXQsIDpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpIiApICkgewoJCQljbG9zZXN0Q29sbGFwc2libGUKCQkJCS5zaWJsaW5ncyggIi51aS1jb2xsYXBzaWJsZTpub3QoLnVpLWNvbGxhcHNpYmxlLWNvbGxhcHNlZCkiICkKCQkJCS5jb2xsYXBzaWJsZSggImNvbGxhcHNlIiApOwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9jbGFzc2VzOiAiIgoJCX0pOwoKCQlpZiAoICFvcHRzLmVuaGFuY2VkICkgewoJCQllbGVtLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0ICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ncm91cC10aGVtZS0iLCBvcHRzLnRoZW1lICkgKyAiICIgKwoJCQkJKCBvcHRzLmNvcm5lcnMgJiYgb3B0cy5pbnNldCA/ICJ1aS1jb3JuZXItYWxsICIgOiAiIiApICk7CgkJCXRoaXMuZWxlbWVudC5maW5kKCAkLm1vYmlsZS5jb2xsYXBzaWJsZS5pbml0U2VsZWN0b3IgKS5jb2xsYXBzaWJsZSgpOwoJCX0KCgkJdGhpcy5fb24oIGVsZW0sIHsgY29sbGFwc2libGVleHBhbmQ6ICJfaGFuZGxlQ29sbGFwc2libGVFeHBhbmQiIH0gKTsKCX0sCgoJX3RoZW1lQ2xhc3NGcm9tT3B0aW9uOiBmdW5jdGlvbiggcHJlZml4LCB2YWx1ZSApIHsKCQlyZXR1cm4gKCB2YWx1ZSA/ICggdmFsdWUgPT09ICJub25lIiA/ICIiIDogcHJlZml4ICsgdmFsdWUgKSA6ICIiICk7Cgl9LAoKCV9pbml0OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9yZWZyZXNoKCB0cnVlICk7CgoJCS8vIEJlY2F1c2UgdGhlIGNvcm5lcnMgYXJlIGhhbmRsZWQgYnkgdGhlIGNvbGxhcHNpYmxlIGl0c2VsZiBhbmQgdGhlIGRlZmF1bHQgc3RhdGUgaXMgY29sbGFwc2VkCgkJLy8gVGhhdCB3YXMgY2F1c2luZyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQxMTYKCQl0aGlzLmVsZW1lbnQKCQkJLmNoaWxkcmVuKCBjaGlsZENvbGxhcHNpYmxlc1NlbGVjdG9yICkKCQkJLmZpbHRlciggIjpqcW1EYXRhKGNvbGxhcHNlZD0nZmFsc2UnKSIgKQoJCQkuY29sbGFwc2libGUoICJleHBhbmQiICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgcmV0LCBoYXNDb3JuZXJzLAoJCQllbGVtID0gdGhpcy5lbGVtZW50LAoJCQl0aGVtZUNsYXNzID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ncm91cC10aGVtZS0iLCBvcHRpb25zLnRoZW1lICk7CgoJCWlmICggdGhlbWVDbGFzcyApIHsKCQkJZWxlbQoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWdyb3VwLXRoZW1lLSIsIHRoaXMub3B0aW9ucy50aGVtZSApICkKCQkJCS5hZGRDbGFzcyggdGhlbWVDbGFzcyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmluc2V0ICE9PSB1bmRlZmluZWQgKSB7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0aW9ucy5pbnNldCAmJiAoIG9wdGlvbnMuY29ybmVycyB8fCB0aGlzLm9wdGlvbnMuY29ybmVycyApICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQloYXNDb3JuZXJzID0gISEoIG9wdGlvbnMuY29ybmVycyAmJiAoIG9wdGlvbnMuaW5zZXQgfHwgdGhpcy5vcHRpb25zLmluc2V0ICkgKTsKCQl9CgoJCWlmICggaGFzQ29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIGhhc0Nvcm5lcnMgKTsKCQl9CgoJCXJldCA9IHRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgkJdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiOm1vYmlsZS1jb2xsYXBzaWJsZSIgKS5jb2xsYXBzaWJsZSggInJlZnJlc2giICk7CgkJcmV0dXJuIHJldDsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciBlbCA9IHRoaXMuZWxlbWVudDsKCgkJdGhpcy5fcmVtb3ZlRmlyc3RMYXN0Q2xhc3NlcyggZWwuY2hpbGRyZW4oIGNoaWxkQ29sbGFwc2libGVzU2VsZWN0b3IgKSApOwoJCWVsCgkJCS5yZW1vdmVDbGFzcyggInVpLWNvbGxhcHNpYmxlLXNldCB1aS1jb3JuZXItYWxsICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ncm91cC10aGVtZS0iLCB0aGlzLm9wdGlvbnMudGhlbWUgKSApCgkJCS5jaGlsZHJlbiggIjptb2JpbGUtY29sbGFwc2libGUiICkKCQkJLmNvbGxhcHNpYmxlKCAiZGVzdHJveSIgKTsKCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdmFyIGNvbGxhcHNpYmxlc0luU2V0ID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCBjaGlsZENvbGxhcHNpYmxlc1NlbGVjdG9yICk7CgoJCXRoaXMuZWxlbWVudC5maW5kKCAkLm1vYmlsZS5jb2xsYXBzaWJsZS5pbml0U2VsZWN0b3IgKS5ub3QoICIudWktY29sbGFwc2libGUiICkuY29sbGFwc2libGUoKTsKCgkJdGhpcy5fYWRkRmlyc3RMYXN0Q2xhc3NlcyggY29sbGFwc2libGVzSW5TZXQsIHRoaXMuX2dldFZpc2libGVzKCBjb2xsYXBzaWJsZXNJblNldCwgY3JlYXRlICksIGNyZWF0ZSApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9yZWZyZXNoKCBmYWxzZSApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIERlcHJlY2F0ZWQgaW4gMS40CiQuZm4uZmllbGRjb250YWluID0gZnVuY3Rpb24oLyogb3B0aW9ucyAqLykgewoJcmV0dXJuIHRoaXMuYWRkQ2xhc3MoICJ1aS1maWVsZC1jb250YWluIiApOwp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmdyaWQgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJbyA9ICQuZXh0ZW5kKHsKCQkJCWdyaWQ6IG51bGwKCQkJfSwgb3B0aW9ucyApLAoJCQkka2lkcyA9ICR0aGlzLmNoaWxkcmVuKCksCgkJCWdyaWRDb2xzID0geyBzb2xvOjEsIGE6MiwgYjozLCBjOjQsIGQ6NSB9LAoJCQlncmlkID0gby5ncmlkLAoJCQlpdGVyYXRvciwKCQkJbGV0dGVyOwoKCQkJaWYgKCAhZ3JpZCApIHsKCQkJCWlmICggJGtpZHMubGVuZ3RoIDw9IDUgKSB7CgkJCQkJZm9yICggbGV0dGVyIGluIGdyaWRDb2xzICkgewoJCQkJCQlpZiAoIGdyaWRDb2xzWyBsZXR0ZXIgXSA9PT0gJGtpZHMubGVuZ3RoICkgewoJCQkJCQkJZ3JpZCA9IGxldHRlcjsKCQkJCQkJfQoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJZ3JpZCA9ICJhIjsKCQkJCQkkdGhpcy5hZGRDbGFzcyggInVpLWdyaWQtZHVvIiApOwoJCQkJfQoJCQl9CgkJCWl0ZXJhdG9yID0gZ3JpZENvbHNbZ3JpZF07CgoJCSR0aGlzLmFkZENsYXNzKCAidWktZ3JpZC0iICsgZ3JpZCApOwoKCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzEpIiApLmFkZENsYXNzKCAidWktYmxvY2stYSIgKTsKCgkJaWYgKCBpdGVyYXRvciA+IDEgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMikiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1iIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gMiApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibiszKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWMiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiAzICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzQpIiApLmFkZENsYXNzKCAidWktYmxvY2stZCIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDQgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rNSkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1lIiApOwoJCX0KCX0pOwp9Owp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLm5hdmJhciIsIHsKCW9wdGlvbnM6IHsKCQlpY29ucG9zOiAidG9wIiwKCQlncmlkOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQl2YXIgJG5hdmJhciA9IHRoaXMuZWxlbWVudCwKCQkJJG5hdmJ0bnMgPSAkbmF2YmFyLmZpbmQoICJhIiApLAoJCQlpY29ucG9zID0gJG5hdmJ0bnMuZmlsdGVyKCAiOmpxbURhdGEoaWNvbikiICkubGVuZ3RoID8gdGhpcy5vcHRpb25zLmljb25wb3MgOiB1bmRlZmluZWQ7CgoJCSRuYXZiYXIuYWRkQ2xhc3MoICJ1aS1uYXZiYXIiICkKCQkJLmF0dHIoICJyb2xlIiwgIm5hdmlnYXRpb24iICkKCQkJLmZpbmQoICJ1bCIgKQoJCQkuanFtRW5oYW5jZWFibGUoKQoJCQkuZ3JpZCh7IGdyaWQ6IHRoaXMub3B0aW9ucy5ncmlkIH0pOwoKCQkkbmF2YnRucwoJCQkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQl2YXIgaWNvbiA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggdGhpcywgImljb24iICksCgkJCQkJdGhlbWUgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMsICJ0aGVtZSIgKSwKCQkJCQljbGFzc2VzID0gInVpLWJ0biI7CgoJCQkJaWYgKCB0aGVtZSApIHsKCQkJCQljbGFzc2VzICs9ICIgdWktYnRuLSIgKyB0aGVtZTsKCQkJCX0KCQkJCWlmICggaWNvbiApIHsKCQkJCQljbGFzc2VzICs9ICIgdWktaWNvbi0iICsgaWNvbiArICIgdWktYnRuLWljb24tIiArIGljb25wb3M7CgkJCQl9CgkJCQkkKCB0aGlzICkuYWRkQ2xhc3MoIGNsYXNzZXMgKTsKCQkJfSk7CgoJCSRuYXZiYXIuZGVsZWdhdGUoICJhIiwgInZjbGljayIsIGZ1bmN0aW9uKCAvKiBldmVudCAqLyApIHsKCQkJdmFyIGFjdGl2ZUJ0biA9ICQoIHRoaXMgKTsKCgkJCWlmICggISggYWN0aXZlQnRuLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgfHwKCgkJCQkvLyBERVBSRUNBVEVEIGFzIG9mIDEuNC4wIC0gcmVtb3ZlIGFmdGVyIDEuNC4wIHJlbGVhc2UKCQkJCS8vIG9ubHkgdWktc3RhdGUtZGlzYWJsZWQgc2hvdWxkIGJlIHByZXNlbnQgdGhlcmVhZnRlcgoJCQkJYWN0aXZlQnRuLmhhc0NsYXNzKCAidWktZGlzYWJsZWQiICkgfHwKCQkJCWFjdGl2ZUJ0bi5oYXNDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKSApICkgewoKCQkJCSRuYXZidG5zLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJYWN0aXZlQnRuLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoKCQkJCS8vIFRoZSBjb2RlIGJlbG93IGlzIGEgd29ya2Fyb3VuZCB0byBmaXggIzExODEKCQkJCSQoIGRvY3VtZW50ICkub25lKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQlhY3RpdmVCdG4ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQl9KTsKCQkJfQoJCX0pOwoKCQkvLyBCdXR0b25zIGluIHRoZSBuYXZiYXIgd2l0aCB1aS1zdGF0ZS1wZXJzaXN0IGNsYXNzIHNob3VsZCByZWdhaW4gdGhlaXIgYWN0aXZlIHN0YXRlIGJlZm9yZSBwYWdlIHNob3cKCQkkbmF2YmFyLmNsb3Nlc3QoICIudWktcGFnZSIgKS5iaW5kKCAicGFnZWJlZm9yZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJJG5hdmJ0bnMuZmlsdGVyKCAiLnVpLXN0YXRlLXBlcnNpc3QiICkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfSk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgZ2V0QXR0ciA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZTsKCiQud2lkZ2V0KCAibW9iaWxlLmxpc3R2aWV3IiwgJC5leHRlbmQoIHsKCglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJY291bnRUaGVtZTogbnVsbCwgLyogRGVwcmVjYXRlZCBpbiAxLjQgKi8KCQlkaXZpZGVyVGhlbWU6IG51bGwsCgkJaWNvbjogImNhcmF0LWwiLAoJCXNwbGl0SWNvbjogImNhcmF0LWwiLAoJCXNwbGl0VGhlbWU6IG51bGwsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaW5zZXQ6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciB0ID0gdGhpcywKCQkJbGlzdHZpZXdDbGFzc2VzID0gIiI7CgoJCWxpc3R2aWV3Q2xhc3NlcyArPSB0Lm9wdGlvbnMuaW5zZXQgPyAiIHVpLWxpc3R2aWV3LWluc2V0IiA6ICIiOwoKCQlpZiAoICEhdC5vcHRpb25zLmluc2V0ICkgewoJCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiI7CgkJCWxpc3R2aWV3Q2xhc3NlcyArPSB0Lm9wdGlvbnMuc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiI7CgkJfQoKCQkvLyBjcmVhdGUgbGlzdHZpZXcgbWFya3VwCgkJdC5lbGVtZW50LmFkZENsYXNzKCAiIHVpLWxpc3R2aWV3IiArIGxpc3R2aWV3Q2xhc3NlcyApOwoKCQl0LnJlZnJlc2goIHRydWUgKTsKCX0sCgoJLy8gVE9ETzogUmVtb3ZlIGluIDEuNQoJX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIG5leHRQcm9wLCBsY05hbWUsIHVjTmFtZSApIHsKCQl2YXIgZGljdCA9IHt9OwoJCWRpY3RbIGxjTmFtZSBdID0gZGljdFsgdWNOYW1lIF0gPSB0cnVlOwoJCXdoaWxlICggZWxlICkgewoJCQlpZiAoIGRpY3RbIGVsZS5ub2RlTmFtZSBdICkgewoJCQkJcmV0dXJuIGVsZTsKCQkJfQoJCQllbGUgPSBlbGVbIG5leHRQcm9wIF07CgkJfQoJCXJldHVybiBudWxsOwoJfSwKCS8vIFRPRE86IFJlbW92ZSBpbiAxLjUKCV9hZGRUaHVtYkNsYXNzZXM6IGZ1bmN0aW9uKCBjb250YWluZXJzICkgewoJCXZhciBpLCBpbWcsIGxlbiA9IGNvbnRhaW5lcnMubGVuZ3RoOwoJCWZvciAoIGkgPSAwOyBpIDwgbGVuOyBpKysgKSB7CgkJCWltZyA9ICQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGNvbnRhaW5lcnNbIGkgXS5maXJzdENoaWxkLCAibmV4dFNpYmxpbmciLCAiaW1nIiwgIklNRyIgKSApOwoJCQlpZiAoIGltZy5sZW5ndGggKSB7CgkJCQkkKCB0aGlzLl9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lKCBpbWdbIDAgXS5wYXJlbnROb2RlLCAicGFyZW50Tm9kZSIsICJsaSIsICJMSSIgKSApLmFkZENsYXNzKCBpbWcuaGFzQ2xhc3MoICJ1aS1saS1pY29uIiApID8gInVpLWxpLWhhcy1pY29uIiA6ICJ1aS1saS1oYXMtdGh1bWIiICk7CgkJCX0KCQl9Cgl9LAoKCV9nZXRDaGlsZHJlbkJ5VGFnTmFtZTogZnVuY3Rpb24oIGVsZSwgbGNOYW1lLCB1Y05hbWUgKSB7CgkJdmFyIHJlc3VsdHMgPSBbXSwKCQkJZGljdCA9IHt9OwoJCWRpY3RbIGxjTmFtZSBdID0gZGljdFsgdWNOYW1lIF0gPSB0cnVlOwoJCWVsZSA9IGVsZS5maXJzdENoaWxkOwoJCXdoaWxlICggZWxlICkgewoJCQlpZiAoIGRpY3RbIGVsZS5ub2RlTmFtZSBdICkgewoJCQkJcmVzdWx0cy5wdXNoKCBlbGUgKTsKCQkJfQoJCQllbGUgPSBlbGUubmV4dFNpYmxpbmc7CgkJfQoJCXJldHVybiAkKCByZXN1bHRzICk7Cgl9LAoKCV9iZWZvcmVMaXN0dmlld1JlZnJlc2g6ICQubm9vcCwKCV9hZnRlckxpc3R2aWV3UmVmcmVzaDogJC5ub29wLAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdmFyIGJ1dHRvbkNsYXNzLCBwb3MsIG51bWxpLCBpdGVtLCBpdGVtQ2xhc3MsIGl0ZW1UaGVtZSwgaXRlbUljb24sIGljb24sIGEsCgkJCWlzRGl2aWRlciwgc3RhcnRDb3VudCwgbmV3U3RhcnRDb3VudCwgdmFsdWUsIGxhc3QsIHNwbGl0dGhlbWUsIHNwbGl0VGhlbWVDbGFzcywgc3BsaXRpY29uLAoJCQlhbHRCdXR0b25DbGFzcywgZGl2aWRlclRoZW1lLCBsaSwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJJGxpc3QgPSB0aGlzLmVsZW1lbnQsCgkJCW9sID0gISEkLm5vZGVOYW1lKCAkbGlzdFsgMCBdLCAib2wiICksCgkJCXN0YXJ0ID0gJGxpc3QuYXR0ciggInN0YXJ0IiApLAoJCQlpdGVtQ2xhc3NEaWN0ID0ge30sCgkJCWNvdW50QnViYmxlcyA9ICRsaXN0LmZpbmQoICIudWktbGktY291bnQiICksCgkJCWNvdW50VGhlbWUgPSBnZXRBdHRyKCAkbGlzdFsgMCBdLCAiY291bnR0aGVtZSIgKSB8fCB0aGlzLm9wdGlvbnMuY291bnRUaGVtZSwKCQkJY291bnRUaGVtZUNsYXNzID0gY291bnRUaGVtZSA/ICJ1aS1ib2R5LSIgKyBjb3VudFRoZW1lIDogInVpLWJvZHktaW5oZXJpdCI7CgoJCWlmICggby50aGVtZSApIHsKCQkJJGxpc3QuYWRkQ2xhc3MoICJ1aS1ncm91cC10aGVtZS0iICsgby50aGVtZSApOwoJCX0KCgkJLy8gQ2hlY2sgaWYgYSBzdGFydCBhdHRyaWJ1dGUgaGFzIGJlZW4gc2V0IHdoaWxlIHRha2luZyBhIHZhbHVlIG9mIDAgaW50byBhY2NvdW50CgkJaWYgKCBvbCAmJiAoIHN0YXJ0IHx8IHN0YXJ0ID09PSAwICkgKSB7CgkJCXN0YXJ0Q291bnQgPSBwYXJzZUludCggc3RhcnQsIDEwICkgLSAxOwoJCQkkbGlzdC5jc3MoICJjb3VudGVyLXJlc2V0IiwgImxpc3RudW1iZXJpbmcgIiArIHN0YXJ0Q291bnQgKTsKCQl9CgoJCXRoaXMuX2JlZm9yZUxpc3R2aWV3UmVmcmVzaCgpOwoKCQlsaSA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCAkbGlzdFsgMCBdLCAibGkiLCAiTEkiICk7CgoJCWZvciAoIHBvcyA9IDAsIG51bWxpID0gbGkubGVuZ3RoOyBwb3MgPCBudW1saTsgcG9zKysgKSB7CgkJCWl0ZW0gPSBsaS5lcSggcG9zICk7CgkJCWl0ZW1DbGFzcyA9ICIiOwoKCQkJaWYgKCBjcmVhdGUgfHwgaXRlbVsgMCBdLmNsYXNzTmFtZS5zZWFyY2goIC9cYnVpLWxpLXN0YXRpY1xifFxidWktbGktZGl2aWRlclxiLyApIDwgMCApIHsKCQkJCWEgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggaXRlbVsgMCBdLCAiYSIsICJBIiApOwoJCQkJaXNEaXZpZGVyID0gKCBnZXRBdHRyKCBpdGVtWyAwIF0sICJyb2xlIiApID09PSAibGlzdC1kaXZpZGVyIiApOwoJCQkJdmFsdWUgPSBpdGVtLmF0dHIoICJ2YWx1ZSIgKTsKCQkJCWl0ZW1UaGVtZSA9IGdldEF0dHIoIGl0ZW1bIDAgXSwgInRoZW1lIiApOwoKCQkJCWlmICggYS5sZW5ndGggJiYgYVsgMCBdLmNsYXNzTmFtZS5zZWFyY2goIC9cYnVpLWJ0blxiLyApIDwgMCAmJiAhaXNEaXZpZGVyICkgewoJCQkJCWl0ZW1JY29uID0gZ2V0QXR0ciggaXRlbVsgMCBdLCAiaWNvbiIgKTsKCQkJCQlpY29uID0gKCBpdGVtSWNvbiA9PT0gZmFsc2UgKSA/IGZhbHNlIDogKCBpdGVtSWNvbiB8fCBvLmljb24gKTsKCgkJCQkJLy8gVE9ETzogUmVtb3ZlIGluIDEuNSB0b2dldGhlciB3aXRoIGxpbmtzLmpzIChsaW5rcy5qcyAvIC51aS1saW5rIGRlcHJlY2F0ZWQgaW4gMS40KQoJCQkJCWEucmVtb3ZlQ2xhc3MoICJ1aS1saW5rIiApOwoKCQkJCQlidXR0b25DbGFzcyA9ICJ1aS1idG4iOwoKCQkJCQlpZiAoIGl0ZW1UaGVtZSApIHsKCQkJCQkJYnV0dG9uQ2xhc3MgKz0gIiB1aS1idG4tIiArIGl0ZW1UaGVtZTsKCQkJCQl9CgoJCQkJCWlmICggYS5sZW5ndGggPiAxICkgewoJCQkJCQlpdGVtQ2xhc3MgPSAidWktbGktaGFzLWFsdCI7CgoJCQkJCQlsYXN0ID0gYS5sYXN0KCk7CgkJCQkJCXNwbGl0dGhlbWUgPSBnZXRBdHRyKCBsYXN0WyAwIF0sICJ0aGVtZSIgKSB8fCBvLnNwbGl0VGhlbWUgfHwgZ2V0QXR0ciggaXRlbVsgMCBdLCAidGhlbWUiLCB0cnVlICk7CgkJCQkJCXNwbGl0VGhlbWVDbGFzcyA9IHNwbGl0dGhlbWUgPyAiIHVpLWJ0bi0iICsgc3BsaXR0aGVtZSA6ICIiOwoJCQkJCQlzcGxpdGljb24gPSBnZXRBdHRyKCBsYXN0WyAwIF0sICJpY29uIiApIHx8IGdldEF0dHIoIGl0ZW1bIDAgXSwgImljb24iICkgfHwgby5zcGxpdEljb247CgkJCQkJCWFsdEJ1dHRvbkNsYXNzID0gInVpLWJ0biB1aS1idG4taWNvbi1ub3RleHQgdWktaWNvbi0iICsgc3BsaXRpY29uICsgc3BsaXRUaGVtZUNsYXNzOwoKCQkJCQkJbGFzdAoJCQkJCQkJLmF0dHIoICJ0aXRsZSIsICQudHJpbSggbGFzdC5nZXRFbmNvZGVkVGV4dCgpICkgKQoJCQkJCQkJLmFkZENsYXNzKCBhbHRCdXR0b25DbGFzcyApCgkJCQkJCQkuZW1wdHkoKTsKCQkJCQl9IGVsc2UgaWYgKCBpY29uICkgewoJCQkJCQlidXR0b25DbGFzcyArPSAiIHVpLWJ0bi1pY29uLWxlZnQgdWktaWNvbi0iICsgaWNvbjsKCQkJCQl9CgoJCQkJCWEuZmlyc3QoKS5hZGRDbGFzcyggYnV0dG9uQ2xhc3MgKTsKCQkJCX0gZWxzZSBpZiAoIGlzRGl2aWRlciApIHsKCQkJCQlkaXZpZGVyVGhlbWUgPSAoIGdldEF0dHIoIGl0ZW1bIDAgXSwgInRoZW1lIiApIHx8IG8uZGl2aWRlclRoZW1lIHx8IG8udGhlbWUgKTsKCgkJCQkJaXRlbUNsYXNzID0gInVpLWxpLWRpdmlkZXIgdWktYmFyLSIgKyAoIGRpdmlkZXJUaGVtZSA/IGRpdmlkZXJUaGVtZSA6ICJpbmhlcml0IiApOwoKCQkJCQlpdGVtLmF0dHIoICJyb2xlIiwgImhlYWRpbmciICk7CgkJCQl9IGVsc2UgaWYgKCBhLmxlbmd0aCA8PSAwICkgewoJCQkJCWl0ZW1DbGFzcyA9ICJ1aS1saS1zdGF0aWMgdWktYm9keS0iICsgKCBpdGVtVGhlbWUgPyBpdGVtVGhlbWUgOiAiaW5oZXJpdCIgKTsKCQkJCX0KCQkJCWlmICggb2wgJiYgdmFsdWUgKSB7CgkJCQkJbmV3U3RhcnRDb3VudCA9IHBhcnNlSW50KCB2YWx1ZSAsIDEwICkgLSAxOwoKCQkJCQlpdGVtLmNzcyggImNvdW50ZXItcmVzZXQiLCAibGlzdG51bWJlcmluZyAiICsgbmV3U3RhcnRDb3VudCApOwoJCQkJfQoJCQl9CgoJCQkvLyBJbnN0ZWFkIG9mIHNldHRpbmcgaXRlbSBjbGFzcyBkaXJlY3RseSBvbiB0aGUgbGlzdCBpdGVtCgkJCS8vIGF0IHRoaXMgcG9pbnQgaW4gdGltZSwgcHVzaCB0aGUgaXRlbSBpbnRvIGEgZGljdGlvbmFyeQoJCQkvLyB0aGF0IHRlbGxzIHVzIHdoYXQgY2xhc3MgdG8gc2V0IG9uIGl0IHNvIHdlIGNhbiBkbyB0aGlzIGFmdGVyIHRoaXMKCQkJLy8gcHJvY2Vzc2luZyBsb29wIGlzIGZpbmlzaGVkLgoKCQkJaWYgKCAhaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKSB7CgkJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSA9IFtdOwoJCQl9CgoJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXS5wdXNoKCBpdGVtWyAwIF0gKTsKCQl9CgoJCS8vIFNldCB0aGUgYXBwcm9wcmlhdGUgbGlzdHZpZXcgaXRlbSBjbGFzc2VzIG9uIGVhY2ggbGlzdCBpdGVtLgoJCS8vIFRoZSBtYWluIHJlYXNvbiB3ZSBkaWRuJ3QgZG8gdGhpcwoJCS8vIGluIHRoZSBmb3ItbG9vcCBhYm92ZSBpcyBiZWNhdXNlIHdlIGNhbiBlbGltaW5hdGUgcGVyLWl0ZW0gZnVuY3Rpb24gb3ZlcmhlYWQKCQkvLyBieSBjYWxsaW5nIGFkZENsYXNzKCkgYW5kIGNoaWxkcmVuKCkgb25jZSBvciB0d2ljZSBhZnRlcndhcmRzLiBUaGlzCgkJLy8gY2FuIGdpdmUgdXMgYSBzaWduaWZpY2FudCBib29zdCBvbiBwbGF0Zm9ybXMgbGlrZSBXUDcuNS4KCgkJZm9yICggaXRlbUNsYXNzIGluIGl0ZW1DbGFzc0RpY3QgKSB7CgkJCSQoIGl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdICkuYWRkQ2xhc3MoIGl0ZW1DbGFzcyApOwoJCX0KCgkJY291bnRCdWJibGVzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktbGktaGFzLWNvdW50IiApOwoJCX0pOwoJCWlmICggY291bnRUaGVtZUNsYXNzICkgewoJCQljb3VudEJ1YmJsZXMuYWRkQ2xhc3MoIGNvdW50VGhlbWVDbGFzcyApOwoJCX0KCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQuIEZyb20gMS41IHlvdSBoYXZlIHRvIGFkZCBjbGFzcyB1aS1saS1oYXMtdGh1bWIgb3IgdWktbGktaGFzLWljb24gdG8gdGhlIExJLgoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggbGkgKTsKCQl0aGlzLl9hZGRUaHVtYkNsYXNzZXMoIGxpLmZpbmQoICIudWktYnRuIiApICk7CgoJCXRoaXMuX2FmdGVyTGlzdHZpZXdSZWZyZXNoKCk7CgoJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGxpLCB0aGlzLl9nZXRWaXNpYmxlcyggbGksIGNyZWF0ZSApLCBjcmVhdGUgKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgpmdW5jdGlvbiBkZWZhdWx0QXV0b2RpdmlkZXJzU2VsZWN0b3IoIGVsdCApIHsKCS8vIGxvb2sgZm9yIHRoZSB0ZXh0IGluIHRoZSBnaXZlbiBlbGVtZW50Cgl2YXIgdGV4dCA9ICQudHJpbSggZWx0LnRleHQoKSApIHx8IG51bGw7CgoJaWYgKCAhdGV4dCApIHsKCQlyZXR1cm4gbnVsbDsKCX0KCgkvLyBjcmVhdGUgdGhlIHRleHQgZm9yIHRoZSBkaXZpZGVyIChmaXJzdCB1cHBlcmNhc2VkIGxldHRlcikKCXRleHQgPSB0ZXh0LnNsaWNlKCAwLCAxICkudG9VcHBlckNhc2UoKTsKCglyZXR1cm4gdGV4dDsKfQoKJC53aWRnZXQoICJtb2JpbGUubGlzdHZpZXciLCAkLm1vYmlsZS5saXN0dmlldywgewoJb3B0aW9uczogewoJCWF1dG9kaXZpZGVyczogZmFsc2UsCgkJYXV0b2RpdmlkZXJzU2VsZWN0b3I6IGRlZmF1bHRBdXRvZGl2aWRlcnNTZWxlY3RvcgoJfSwKCglfYmVmb3JlTGlzdHZpZXdSZWZyZXNoOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5hdXRvZGl2aWRlcnMgKSB7CgkJCXRoaXMuX3JlcGxhY2VEaXZpZGVycygpOwoJCQl0aGlzLl9zdXBlckFwcGx5KCBhcmd1bWVudHMgKTsKCQl9Cgl9LAoKCV9yZXBsYWNlRGl2aWRlcnM6IGZ1bmN0aW9uKCkgewoJCXZhciBpLCBsaXMsIGxpLCBkaXZpZGVyVGV4dCwKCQkJbGFzdERpdmlkZXJUZXh0ID0gbnVsbCwKCQkJbGlzdCA9IHRoaXMuZWxlbWVudCwKCQkJZGl2aWRlcjsKCgkJbGlzdC5jaGlsZHJlbiggImxpOmpxbURhdGEocm9sZT0nbGlzdC1kaXZpZGVyJykiICkucmVtb3ZlKCk7CgoJCWxpcyA9IGxpc3QuY2hpbGRyZW4oICJsaSIgKTsKCgkJZm9yICggaSA9IDA7IGkgPCBsaXMubGVuZ3RoIDsgaSsrICkgewoJCQlsaSA9IGxpc1sgaSBdOwoJCQlkaXZpZGVyVGV4dCA9IHRoaXMub3B0aW9ucy5hdXRvZGl2aWRlcnNTZWxlY3RvciggJCggbGkgKSApOwoKCQkJaWYgKCBkaXZpZGVyVGV4dCAmJiBsYXN0RGl2aWRlclRleHQgIT09IGRpdmlkZXJUZXh0ICkgewoJCQkJZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJsaSIgKTsKCQkJCWRpdmlkZXIuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBkaXZpZGVyVGV4dCApICk7CgkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGUiLCAibGlzdC1kaXZpZGVyIiApOwoJCQkJbGkucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoIGRpdmlkZXIsIGxpICk7CgkJCX0KCgkJCWxhc3REaXZpZGVyVGV4dCA9IGRpdmlkZXJUZXh0OwoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciByZGl2aWRlciA9IC8oXnxccyl1aS1saS1kaXZpZGVyKCR8XHMpLywKCXJoaWRkZW4gPSAvKF58XHMpdWktc2NyZWVuLWhpZGRlbigkfFxzKS87CgokLndpZGdldCggIm1vYmlsZS5saXN0dmlldyIsICQubW9iaWxlLmxpc3R2aWV3LCB7CglvcHRpb25zOiB7CgkJaGlkZURpdmlkZXJzOiBmYWxzZQoJfSwKCglfYWZ0ZXJMaXN0dmlld1JlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBpdGVtcywgaWR4LCBpdGVtLCBoaWRlRGl2aWRlciA9IHRydWU7CgoJCXRoaXMuX3N1cGVyQXBwbHkoIGFyZ3VtZW50cyApOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5oaWRlRGl2aWRlcnMgKSB7CgkJCWl0ZW1zID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoIHRoaXMuZWxlbWVudFsgMCBdLCAibGkiLCAiTEkiICk7CgkJCWZvciAoIGlkeCA9IGl0ZW1zLmxlbmd0aCAtIDEgOyBpZHggPiAtMSA7IGlkeC0tICkgewoJCQkJaXRlbSA9IGl0ZW1zWyBpZHggXTsKCQkJCWlmICggaXRlbS5jbGFzc05hbWUubWF0Y2goIHJkaXZpZGVyICkgKSB7CgkJCQkJaWYgKCBoaWRlRGl2aWRlciApIHsKCQkJCQkJaXRlbS5jbGFzc05hbWUgPSBpdGVtLmNsYXNzTmFtZSArICIgdWktc2NyZWVuLWhpZGRlbiI7CgkJCQkJfQoJCQkJCWhpZGVEaXZpZGVyID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJaWYgKCAhaXRlbS5jbGFzc05hbWUubWF0Y2goIHJoaWRkZW4gKSApIHsKCQkJCQkJaGlkZURpdmlkZXIgPSBmYWxzZTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5ub2pzID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCSQoICI6anFtRGF0YShyb2xlPSdub2pzJykiLCB0YXJnZXQgKS5hZGRDbGFzcyggInVpLW5vanMiICk7Cn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgPSB7CglfaGFuZGxlRm9ybVJlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LmNsb3Nlc3QoICJmb3JtIiApLCB7CgkJCXJlc2V0OiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuX2RlbGF5KCAiX3Jlc2V0IiApOwoJCQl9CgkJfSk7Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CgovKgoqICJjaGVja2JveHJhZGlvIiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY2hlY2tib3hyYWRpbyIsICQuZXh0ZW5kKCB7CgoJaW5pdFNlbGVjdG9yOiAiaW5wdXQ6bm90KCA6anFtRGF0YShyb2xlPSdmbGlwc3dpdGNoJyApIClbdHlwZT0nY2hlY2tib3gnXSxpbnB1dFt0eXBlPSdyYWRpbyddOm5vdCggOmpxbURhdGEocm9sZT0nZmxpcHN3aXRjaCcgKSkiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogImluaGVyaXQiLAoJCW1pbmk6IGZhbHNlLAoJCXdyYXBwZXJDbGFzczogbnVsbCwKCQllbmhhbmNlZDogZmFsc2UsCgkJaWNvbnBvczogInJpZ2h0IgoKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgaW5wdXQgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWluaGVyaXRBdHRyID0gZnVuY3Rpb24oIGlucHV0LCBkYXRhQXR0ciApIHsKCQkJCXJldHVybiBpbnB1dC5qcW1EYXRhKCBkYXRhQXR0ciApIHx8CgkJCQkJaW5wdXQuY2xvc2VzdCggImZvcm0sIGZpZWxkc2V0IiApLmpxbURhdGEoIGRhdGFBdHRyICk7CgkJCX0sCgkJCS8vIE5PVEU6IFdpbmRvd3MgUGhvbmUgY291bGQgbm90IGZpbmQgdGhlIGxhYmVsIHRocm91Z2ggYSBzZWxlY3RvcgoJCQkvLyBmaWx0ZXIgd29ya3MgdGhvdWdoLgoJCQlwYXJlbnRMYWJlbCA9IGlucHV0LmNsb3Nlc3QoICJsYWJlbCIgKSwKCQkJbGFiZWwgPSBwYXJlbnRMYWJlbC5sZW5ndGggPyBwYXJlbnRMYWJlbCA6CgkJCQlpbnB1dAoJCQkJCS5jbG9zZXN0KCAiZm9ybSwgZmllbGRzZXQsIDpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkKCQkJCQkuZmluZCggImxhYmVsIiApCgkJCQkJLmZpbHRlciggIltmb3I9JyIgKyAkLm1vYmlsZS5wYXRoLmhhc2hUb1NlbGVjdG9yKCBpbnB1dFswXS5pZCApICsgIiddIiApCgkJCQkJLmZpcnN0KCksCgkJCWlucHV0dHlwZSA9IGlucHV0WzBdLnR5cGUsCgkJCWNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgaW5wdXR0eXBlICsgIi1vbiIsCgkJCXVuY2hlY2tlZENsYXNzID0gInVpLSIgKyBpbnB1dHR5cGUgKyAiLW9mZiI7CgoJCWlmICggaW5wdXR0eXBlICE9PSAiY2hlY2tib3giICYmIGlucHV0dHlwZSAhPT0gInJhZGlvIiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCB0aGlzLmVsZW1lbnRbMF0uZGlzYWJsZWQgKSB7CgkJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IHRydWU7CgkJfQoKCQlvLmljb25wb3MgPSBpbmhlcml0QXR0ciggaW5wdXQsICJpY29ucG9zIiApIHx8IGxhYmVsLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29ucG9zIiApIHx8IG8uaWNvbnBvcywKCgkJLy8gRXN0YWJsaXNoIG9wdGlvbnMKCQlvLm1pbmkgPSBpbmhlcml0QXR0ciggaW5wdXQsICJtaW5pIiApIHx8IG8ubWluaTsKCgkJLy8gRXhwb3NlIGZvciBvdGhlciBtZXRob2RzCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJaW5wdXQ6IGlucHV0LAoJCQlsYWJlbDogbGFiZWwsCgkJCXBhcmVudExhYmVsOiBwYXJlbnRMYWJlbCwKCQkJaW5wdXR0eXBlOiBpbnB1dHR5cGUsCgkJCWNoZWNrZWRDbGFzczogY2hlY2tlZENsYXNzLAoJCQl1bmNoZWNrZWRDbGFzczogdW5jaGVja2VkQ2xhc3MKCQl9KTsKCgkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9lbmhhbmNlKCk7CgkJfQoKCQl0aGlzLl9vbiggbGFiZWwsIHsKCQkJdm1vdXNlb3ZlcjogIl9oYW5kbGVMYWJlbFZNb3VzZU92ZXIiLAoJCQl2Y2xpY2s6ICJfaGFuZGxlTGFiZWxWQ2xpY2siCgkJfSk7CgoJCXRoaXMuX29uKCBpbnB1dCwgewoJCQl2bW91c2Vkb3duOiAiX2NhY2hlVmFscyIsCgkJCXZjbGljazogIl9oYW5kbGVJbnB1dFZDbGljayIsCgkJCWZvY3VzOiAiX2hhbmRsZUlucHV0Rm9jdXMiLAoJCQlibHVyOiAiX2hhbmRsZUlucHV0Qmx1ciIKCQl9KTsKCgkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmxhYmVsLmFkZENsYXNzKCAidWktYnRuIHVpLWNvcm5lci1hbGwiKTsKCgkJaWYgKCB0aGlzLnBhcmVudExhYmVsLmxlbmd0aCA+IDAgKSB7CgkJCXRoaXMuaW5wdXQuYWRkKCB0aGlzLmxhYmVsICkud3JhcEFsbCggdGhpcy5fd3JhcHBlcigpICk7CgkJfSBlbHNlIHsKCQkJLy90aGlzLmVsZW1lbnQucmVwbGFjZVdpdGgoIHRoaXMuaW5wdXQuYWRkKCB0aGlzLmxhYmVsICkud3JhcEFsbCggdGhpcy5fd3JhcHBlcigpICkgKTsKCQkJdGhpcy5lbGVtZW50LndyYXAoIHRoaXMuX3dyYXBwZXIoKSApOwoJCQl0aGlzLmVsZW1lbnQucGFyZW50KCkucHJlcGVuZCggdGhpcy5sYWJlbCApOwoJCX0KCgkJLy8gV3JhcCB0aGUgaW5wdXQgKyBsYWJlbCBpbiBhIGRpdgoKCQl0aGlzLl9zZXRPcHRpb25zKHsKCQkJInRoZW1lIjogdGhpcy5vcHRpb25zLnRoZW1lLAoJCQkiaWNvbnBvcyI6IHRoaXMub3B0aW9ucy5pY29ucG9zLAoJCQkibWluaSI6IHRoaXMub3B0aW9ucy5taW5pCgkJfSk7CgoJfSwKCglfd3JhcHBlcjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2IGNsYXNzPSciICArCgkJCSggdGhpcy5vcHRpb25zLndyYXBwZXJDbGFzcyA/IHRoaXMub3B0aW9ucy53cmFwcGVyQ2xhc3MgOiAiIiApICsKCQkJIiB1aS0iICsgdGhpcy5pbnB1dHR5cGUgKwoJCQkoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCA/ICIgdWktc3RhdGUtZGlzYWJsZWQiIDogIiIgKSArICInID4iICk7Cgl9LAoKCV9oYW5kbGVJbnB1dEZvY3VzOiBmdW5jdGlvbigpIHsKCQl0aGlzLmxhYmVsLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7Cgl9LAoKCV9oYW5kbGVJbnB1dEJsdXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMubGFiZWwucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCX0sCgoJX2hhbmRsZUlucHV0VkNsaWNrOiBmdW5jdGlvbigpIHsKCQl2YXIgJHRoaXMgPSB0aGlzLmVsZW1lbnQ7CgoJCS8vIEFkZHMgY2hlY2tlZCBhdHRyaWJ1dGUgdG8gY2hlY2tlZCBpbnB1dCB3aGVuIGtleWJvYXJkIGlzIHVzZWQKCQlpZiAoICR0aGlzLmlzKCAiOmNoZWNrZWQiICkgKSB7CgoJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIHRydWUpOwoJCQl0aGlzLl9nZXRJbnB1dFNldCgpLm5vdCggJHRoaXMgKS5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJfSBlbHNlIHsKCQkJJHRoaXMucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCX0KCgkJdGhpcy5fdXBkYXRlQWxsKCk7Cgl9LAoKCV9oYW5kbGVMYWJlbFZNb3VzZU92ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIHRoaXMubGFiZWwucGFyZW50KCkuaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKSApIHsKCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJfQoJfSwKCglfaGFuZGxlTGFiZWxWQ2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgaW5wdXQgPSB0aGlzLmVsZW1lbnQ7CgoJCWlmICggaW5wdXQuaXMoICI6ZGlzYWJsZWQiICkgKSB7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX2NhY2hlVmFscygpOwoKCQlpbnB1dC5wcm9wKCAiY2hlY2tlZCIsIHRoaXMuaW5wdXR0eXBlID09PSAicmFkaW8iICYmIHRydWUgfHwgIWlucHV0LnByb3AoICJjaGVja2VkIiApICk7CgoJCS8vIHRyaWdnZXIgY2xpY2sgaGFuZGxlcidzIGJvdW5kIGRpcmVjdGx5IHRvIHRoZSBpbnB1dCBhcyBhIHN1YnN0aXR1dGUgZm9yCgkJLy8gaG93IGxhYmVsIGNsaWNrcyBiZWhhdmUgbm9ybWFsbHkgaW4gdGhlIGJyb3dzZXJzCgkJLy8gVE9ETzogaXQgd291bGQgYmUgbmljZSB0byBsZXQgdGhlIGJyb3dzZXIncyBoYW5kbGUgdGhlIGNsaWNrcyBhbmQgcGFzcyB0aGVtCgkJLy8gICAgICAgdGhyb3VnaCB0byB0aGUgYXNzb2NpYXRlIGlucHV0LiB3ZSBjYW4gc3dhbGxvdyB0aGF0IGNsaWNrIGF0IHRoZSBwYXJlbnQKCQkvLyAgICAgICB3cmFwcGVyIGVsZW1lbnQgbGV2ZWwKCQlpbnB1dC50cmlnZ2VySGFuZGxlciggImNsaWNrIiApOwoKCQkvLyBJbnB1dCBzZXQgZm9yIGNvbW1vbiByYWRpbyBidXR0b25zIHdpbGwgY29udGFpbiBhbGwgdGhlIHJhZGlvCgkJLy8gYnV0dG9ucywgYnV0IHdpbGwgbm90IGZvciBjaGVja2JveGVzLiBjbGVhcmluZyB0aGUgY2hlY2tlZCBzdGF0dXMKCQkvLyBvZiBvdGhlciByYWRpb3MgZW5zdXJlcyB0aGUgYWN0aXZlIGJ1dHRvbiBzdGF0ZSBpcyBhcHBsaWVkIHByb3Blcmx5CgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5ub3QoIGlucHV0ICkucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoKCQl0aGlzLl91cGRhdGVBbGwoKTsKCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCV9jYWNoZVZhbHM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2dldElucHV0U2V0KCkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5hdHRyKCJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJjYWNoZVZhbCIsIHRoaXMuY2hlY2tlZCApOwoJCX0pOwoJfSwKCgkvL3JldHVybnMgZWl0aGVyIGEgc2V0IG9mIHJhZGlvcyB3aXRoIHRoZSBzYW1lIG5hbWUgYXR0cmlidXRlLCBvciBhIHNpbmdsZSBjaGVja2JveAoJX2dldElucHV0U2V0OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuaW5wdXR0eXBlID09PSAiY2hlY2tib3giICkgewoJCQlyZXR1cm4gdGhpcy5lbGVtZW50OwoJCX0KCgkJcmV0dXJuIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSwgOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKQoJCQkuZmluZCggImlucHV0W25hbWU9JyIgKyB0aGlzLmVsZW1lbnRbIDAgXS5uYW1lICsgIiddW3R5cGU9JyIgKyB0aGlzLmlucHV0dHlwZSArICInXSIgKTsKCX0sCgoJX3VwZGF0ZUFsbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQlpZiAoIHRoaXMuY2hlY2tlZCB8fCBzZWxmLmlucHV0dHlwZSA9PT0gImNoZWNrYm94IiApIHsKCQkJCSR0aGlzLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCX0KCQl9KQoJCS5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCX0sCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJLy8gSXMgdGhlIHdpZGdldCBzdXBwb3NlZCB0byBkaXNwbGF5IGFuIGljb24/CglfaGFzSWNvbjogZnVuY3Rpb24oKSB7CgkJdmFyIGNvbnRyb2xncm91cCwgY29udHJvbGdyb3VwV2lkZ2V0LAoJCQljb250cm9sZ3JvdXBDb25zdHJ1Y3RvciA9ICQubW9iaWxlLmNvbnRyb2xncm91cDsKCgkJLy8gSWYgdGhlIGNvbnRyb2xncm91cCB3aWRnZXQgaXMgZGVmaW5lZCAuLi4KCQlpZiAoIGNvbnRyb2xncm91cENvbnN0cnVjdG9yICkgewoJCQljb250cm9sZ3JvdXAgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCgKCQkJCSI6bW9iaWxlLWNvbnRyb2xncm91cCwiICsKCQkJCWNvbnRyb2xncm91cENvbnN0cnVjdG9yLnByb3RvdHlwZS5pbml0U2VsZWN0b3IgKTsKCgkJCS8vIC4uLiBhbmQgdGhlIGNoZWNrYm94IGlzIGluIGEgY29udHJvbGdyb3VwIC4uLgoJCQlpZiAoIGNvbnRyb2xncm91cC5sZW5ndGggPiAwICkgewoKCQkJCS8vIC4uLiBsb29rIGZvciBhIGNvbnRyb2xncm91cCB3aWRnZXQgaW5zdGFuY2UsIGFuZCAuLi4KCQkJCWNvbnRyb2xncm91cFdpZGdldCA9ICQuZGF0YSggY29udHJvbGdyb3VwWyAwIF0sICJtb2JpbGUtY29udHJvbGdyb3VwIiApOwoKCQkJCS8vIC4uLiBpZiBmb3VuZCwgZGVjaWRlIGJhc2VkIG9uIHRoZSBvcHRpb24gdmFsdWUsIC4uLgoJCQkJcmV0dXJuICggKCBjb250cm9sZ3JvdXBXaWRnZXQgPyBjb250cm9sZ3JvdXBXaWRnZXQub3B0aW9ucy50eXBlIDoKCgkJCQkJLy8gLi4uIG90aGVyd2lzZSBkZWNpZGUgYmFzZWQgb24gdGhlICJ0eXBlIiBkYXRhIGF0dHJpYnV0ZS4KCQkJCQljb250cm9sZ3JvdXAuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGUiICkgKSAhPT0gImhvcml6b250YWwiICk7CgkJCX0KCQl9CgoJCS8vIE5vcm1hbGx5LCB0aGUgd2lkZ2V0IGRpc3BsYXlzIGFuIGljb24uCgkJcmV0dXJuIHRydWU7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBoYXNJY29uID0gdGhpcy5faGFzSWNvbigpLAoJCQlpc0NoZWNrZWQgPSB0aGlzLmVsZW1lbnRbIDAgXS5jaGVja2VkLAoJCQlhY3RpdmUgPSAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcywKCQkJaWNvbnBvc0NsYXNzID0gInVpLWJ0bi1pY29uLSIgKyB0aGlzLm9wdGlvbnMuaWNvbnBvcywKCQkJYWRkQ2xhc3NlcyA9IFtdLAoJCQlyZW1vdmVDbGFzc2VzID0gW107CgoJCWlmICggaGFzSWNvbiApIHsKCQkJcmVtb3ZlQ2xhc3Nlcy5wdXNoKCBhY3RpdmUgKTsKCQkJYWRkQ2xhc3Nlcy5wdXNoKCBpY29ucG9zQ2xhc3MgKTsKCQl9IGVsc2UgewoJCQlyZW1vdmVDbGFzc2VzLnB1c2goIGljb25wb3NDbGFzcyApOwoJCQkoIGlzQ2hlY2tlZCA/IGFkZENsYXNzZXMgOiByZW1vdmVDbGFzc2VzICkucHVzaCggYWN0aXZlICk7CgkJfQoKCQlpZiAoIGlzQ2hlY2tlZCApIHsKCQkJYWRkQ2xhc3Nlcy5wdXNoKCB0aGlzLmNoZWNrZWRDbGFzcyApOwoJCQlyZW1vdmVDbGFzc2VzLnB1c2goIHRoaXMudW5jaGVja2VkQ2xhc3MgKTsKCQl9IGVsc2UgewoJCQlhZGRDbGFzc2VzLnB1c2goIHRoaXMudW5jaGVja2VkQ2xhc3MgKTsKCQkJcmVtb3ZlQ2xhc3Nlcy5wdXNoKCB0aGlzLmNoZWNrZWRDbGFzcyApOwoJCX0KCgkJdGhpcy5sYWJlbAoJCQkuYWRkQ2xhc3MoIGFkZENsYXNzZXMuam9pbiggIiAiICkgKQoJCQkucmVtb3ZlQ2xhc3MoIHJlbW92ZUNsYXNzZXMuam9pbiggIiAiICkgKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5sYWJlbC5wYXJlbnQoKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBsYWJlbCA9IHRoaXMubGFiZWwsCgkJCWN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlvdXRlciA9IHRoaXMud2lkZ2V0KCksCgkJCWhhc0ljb24gPSB0aGlzLl9oYXNJY29uKCk7CgoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLmlucHV0LnByb3AoICJkaXNhYmxlZCIsICEhb3B0aW9ucy5kaXNhYmxlZCApOwoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiwgISFvcHRpb25zLmRpc2FibGVkICk7CgkJfQoJCWlmICggb3B0aW9ucy5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktbWluaSIsICEhb3B0aW9ucy5taW5pICk7CgkJfQoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlsYWJlbAoJCQkJLnJlbW92ZUNsYXNzKCAidWktYnRuLSIgKyBjdXJyZW50T3B0aW9ucy50aGVtZSApCgkJCQkuYWRkQ2xhc3MoICJ1aS1idG4tIiArIG9wdGlvbnMudGhlbWUgKTsKCQl9CgkJaWYgKCBvcHRpb25zLndyYXBwZXJDbGFzcyAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlcgoJCQkJLnJlbW92ZUNsYXNzKCBjdXJyZW50T3B0aW9ucy53cmFwcGVyQ2xhc3MgKQoJCQkJLmFkZENsYXNzKCBvcHRpb25zLndyYXBwZXJDbGFzcyApOwoJCX0KCQlpZiAoIG9wdGlvbnMuaWNvbnBvcyAhPT0gdW5kZWZpbmVkICYmIGhhc0ljb24gKSB7CgkJCWxhYmVsLnJlbW92ZUNsYXNzKCAidWktYnRuLWljb24tIiArIGN1cnJlbnRPcHRpb25zLmljb25wb3MgKS5hZGRDbGFzcyggInVpLWJ0bi1pY29uLSIgKyBvcHRpb25zLmljb25wb3MgKTsKCQl9IGVsc2UgaWYgKCAhaGFzSWNvbiApIHsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoICJ1aS1idG4taWNvbi0iICsgY3VycmVudE9wdGlvbnMuaWNvbnBvcyApOwoJCX0KCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfQoKfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmJ1dHRvbiIsIHsKCglpbml0U2VsZWN0b3I6ICJpbnB1dFt0eXBlPSdidXR0b24nXSwgaW5wdXRbdHlwZT0nc3VibWl0J10sIGlucHV0W3R5cGU9J3Jlc2V0J10iLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQlpY29uOiBudWxsLAoJCWljb25wb3M6ICJyaWdodCIsCgkJaWNvbnNoYWRvdzogZmFsc2UsIC8qIFRPRE86IERlcHJlY2F0ZWQgaW4gMS40LCByZW1vdmUgaW4gMS41LiAqLwoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWlubGluZTogbnVsbCwKCQltaW5pOiBudWxsLAoJCXdyYXBwZXJDbGFzczogbnVsbCwKCQllbmhhbmNlZDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCWlmICggdGhpcy5lbGVtZW50LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQl0aGlzLm9wdGlvbnMuZGlzYWJsZWQgPSB0cnVlOwoJCX0KCgkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9lbmhhbmNlKCk7CgkJfQoKCQkkLmV4dGVuZCggdGhpcywgewoJCQl3cmFwcGVyOiB0aGlzLmVsZW1lbnQucGFyZW50KCkKCQl9KTsKCgkJdGhpcy5fb24oIHsKCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy53aWRnZXQoKS5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9LAoKCQkJYmx1cjogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLndpZGdldCgpLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0KCQl9KTsKCgkJdGhpcy5yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQud3JhcCggdGhpcy5fYnV0dG9uKCkgKTsKCX0sCgoJX2J1dHRvbjogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWljb25DbGFzc2VzID0gdGhpcy5fZ2V0SWNvbkNsYXNzZXMoIHRoaXMub3B0aW9ucyApOwoKCQlyZXR1cm4gJCgiPGRpdiBjbGFzcz0ndWktYnRuIHVpLWlucHV0LWJ0biIgKwoJCQkoIG9wdGlvbnMud3JhcHBlckNsYXNzID8gIiAiICsgb3B0aW9ucy53cmFwcGVyQ2xhc3MgOiAiIiApICsKCQkJKCBvcHRpb25zLnRoZW1lID8gIiB1aS1idG4tIiArIG9wdGlvbnMudGhlbWUgOiAiIiApICsKCQkJKCBvcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIgKSArCgkJCSggb3B0aW9ucy5zaGFkb3cgPyAiIHVpLXNoYWRvdyIgOiAiIiApICsKCQkJKCBvcHRpb25zLmlubGluZSA/ICIgdWktYnRuLWlubGluZSIgOiAiIiApICsKCQkJKCBvcHRpb25zLm1pbmkgPyAiIHVpLW1pbmkiIDogIiIgKSArCgkJCSggb3B0aW9ucy5kaXNhYmxlZCA/ICIgdWktc3RhdGUtZGlzYWJsZWQiIDogIiIgKSArCgkJCSggaWNvbkNsYXNzZXMgPyAoICIgIiArIGljb25DbGFzc2VzICkgOiAiIiApICsKCQkJIicgPiIgKyB0aGlzLmVsZW1lbnQudmFsKCkgKyAiPC9kaXY+IiApOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLndyYXBwZXI7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50Lmluc2VydEJlZm9yZSggdGhpcy5idXR0b24gKTsKCQkJdGhpcy5idXR0b24ucmVtb3ZlKCk7Cgl9LAoKCV9nZXRJY29uQ2xhc3NlczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJcmV0dXJuICggb3B0aW9ucy5pY29uID8gKCAidWktaWNvbi0iICsgb3B0aW9ucy5pY29uICsKCQkJKCBvcHRpb25zLmljb25zaGFkb3cgPyAiIHVpLXNoYWRvdy1pY29uIiA6ICIiICkgKyAvKiBUT0RPOiBEZXByZWNhdGVkIGluIDEuNCwgcmVtb3ZlIGluIDEuNS4gKi8KCQkJIiB1aS1idG4taWNvbi0iICsgb3B0aW9ucy5pY29ucG9zICkgOiAiIiApOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIG91dGVyID0gdGhpcy53aWRnZXQoKTsKCgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMub3B0aW9ucy50aGVtZSApCgkJCQkuYWRkQ2xhc3MoICJ1aS1idG4tIiArIG9wdGlvbnMudGhlbWUgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJb3V0ZXIudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoJCWlmICggb3B0aW9ucy5zaGFkb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJb3V0ZXIudG9nZ2xlQ2xhc3MoICJ1aS1zaGFkb3ciLCBvcHRpb25zLnNoYWRvdyApOwoJCX0KCQlpZiAoIG9wdGlvbnMuaW5saW5lICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktYnRuLWlubGluZSIsIG9wdGlvbnMuaW5saW5lICk7CgkJfQoJCWlmICggb3B0aW9ucy5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIG9wdGlvbnMubWluaSApOwoJCX0KCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIsIG9wdGlvbnMuZGlzYWJsZWQgKTsKCQkJb3V0ZXIudG9nZ2xlQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIsIG9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5pY29uICE9PSB1bmRlZmluZWQgfHwKCQkJCW9wdGlvbnMuaWNvbnNoYWRvdyAhPT0gdW5kZWZpbmVkIHx8IC8qIFRPRE86IERlcHJlY2F0ZWQgaW4gMS40LCByZW1vdmUgaW4gMS41LiAqLwoJCQkJb3B0aW9ucy5pY29ucG9zICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMuX2dldEljb25DbGFzc2VzKCB0aGlzLm9wdGlvbnMgKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMuX2dldEljb25DbGFzc2VzKAoJCQkJCSQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zLCBvcHRpb25zICkgKSApOwoJCX0KCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5pY29uICYmIHRoaXMub3B0aW9ucy5pY29ucG9zID09PSAibm90ZXh0IiAmJiB0aGlzLmVsZW1lbnQuYXR0ciggInRpdGxlIiApICkgewoJCQl0aGlzLmVsZW1lbnQuYXR0ciggInRpdGxlIiwgdGhpcy5lbGVtZW50LnZhbCgpICk7CgkJfQoJCWlmICggIWNyZWF0ZSApIHsKCQkJdmFyIG9yaWdpbmFsRWxlbWVudCA9IHRoaXMuZWxlbWVudC5kZXRhY2goKTsKCQkJJCggdGhpcy53cmFwcGVyICkudGV4dCggdGhpcy5lbGVtZW50LnZhbCgpICkuYXBwZW5kKCBvcmlnaW5hbEVsZW1lbnQgKTsKCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkICkgewoJdmFyCW1ldGEgPSAkKCAibWV0YVtuYW1lPXZpZXdwb3J0XSIgKSwKCQlpbml0aWFsQ29udGVudCA9IG1ldGEuYXR0ciggImNvbnRlbnQiICksCgkJZGlzYWJsZWRab29tID0gaW5pdGlhbENvbnRlbnQgKyAiLG1heGltdW0tc2NhbGU9MSwgdXNlci1zY2FsYWJsZT1ubyIsCgkJZW5hYmxlZFpvb20gPSBpbml0aWFsQ29udGVudCArICIsbWF4aW11bS1zY2FsZT0xMCwgdXNlci1zY2FsYWJsZT15ZXMiLAoJCWRpc2FibGVkSW5pdGlhbGx5ID0gLyh1c2VyLXNjYWxhYmxlW1xzXSo9W1xzXSpubyl8KG1heGltdW0tc2NhbGVbXHNdKj1bXHNdKjEpWyQsXHNdLy50ZXN0KCBpbml0aWFsQ29udGVudCApOwoKCSQubW9iaWxlLnpvb20gPSAkLmV4dGVuZCgge30sIHsKCQllbmFibGVkOiAhZGlzYWJsZWRJbml0aWFsbHksCgkJbG9ja2VkOiBmYWxzZSwKCQlkaXNhYmxlOiBmdW5jdGlvbiggbG9jayApIHsKCQkJaWYgKCAhZGlzYWJsZWRJbml0aWFsbHkgJiYgISQubW9iaWxlLnpvb20ubG9ja2VkICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGRpc2FibGVkWm9vbSApOwoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gZmFsc2U7CgkJCQkkLm1vYmlsZS56b29tLmxvY2tlZCA9IGxvY2sgfHwgZmFsc2U7CgkJCX0KCQl9LAoJCWVuYWJsZTogZnVuY3Rpb24oIHVubG9jayApIHsKCQkJaWYgKCAhZGlzYWJsZWRJbml0aWFsbHkgJiYgKCAhJC5tb2JpbGUuem9vbS5sb2NrZWQgfHwgdW5sb2NrID09PSB0cnVlICkgKSB7CgkJCQltZXRhLmF0dHIoICJjb250ZW50IiwgZW5hYmxlZFpvb20gKTsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IHRydWU7CgkJCQkkLm1vYmlsZS56b29tLmxvY2tlZCA9IGZhbHNlOwoJCQl9CgkJfSwKCQlyZXN0b3JlOiBmdW5jdGlvbigpIHsKCQkJaWYgKCAhZGlzYWJsZWRJbml0aWFsbHkgKSB7CgkJCQltZXRhLmF0dHIoICJjb250ZW50IiwgaW5pdGlhbENvbnRlbnQgKTsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IHRydWU7CgkJCX0KCQl9Cgl9KTsKCn0oIGpRdWVyeSApKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUudGV4dGlucHV0IiwgewoJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ndGV4dCddLCIgKwoJCSJpbnB1dFt0eXBlPSdzZWFyY2gnXSwiICsKCQkiOmpxbURhdGEodHlwZT0nc2VhcmNoJyksIiArCgkJImlucHV0W3R5cGU9J251bWJlciddLCIgKwoJCSI6anFtRGF0YSh0eXBlPSdudW1iZXInKSwiICsKCQkiaW5wdXRbdHlwZT0ncGFzc3dvcmQnXSwiICsKCQkiaW5wdXRbdHlwZT0nZW1haWwnXSwiICsKCQkiaW5wdXRbdHlwZT0ndXJsJ10sIiArCgkJImlucHV0W3R5cGU9J3RlbCddLCIgKwoJCSJ0ZXh0YXJlYSwiICsKCQkiaW5wdXRbdHlwZT0ndGltZSddLCIgKwoJCSJpbnB1dFt0eXBlPSdkYXRlJ10sIiArCgkJImlucHV0W3R5cGU9J21vbnRoJ10sIiArCgkJImlucHV0W3R5cGU9J3dlZWsnXSwiICsKCQkiaW5wdXRbdHlwZT0nZGF0ZXRpbWUnXSwiICsKCQkiaW5wdXRbdHlwZT0nZGF0ZXRpbWUtbG9jYWwnXSwiICsKCQkiaW5wdXRbdHlwZT0nY29sb3InXSwiICsKCQkiaW5wdXQ6bm90KFt0eXBlXSksIiArCgkJImlucHV0W3R5cGU9J2ZpbGUnXSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWNvcm5lcnM6IHRydWUsCgkJbWluaTogZmFsc2UsCgkJLy8gVGhpcyBvcHRpb24gZGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MgZGV2aWNlcy4KCQlwcmV2ZW50Rm9jdXNab29tOiAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSwKCQl3cmFwcGVyQ2xhc3M6ICIiLAoJCWVuaGFuY2VkOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWlzU2VhcmNoID0gdGhpcy5lbGVtZW50LmlzKCAiW3R5cGU9J3NlYXJjaCddLCA6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSIgKSwKCQkJaXNUZXh0YXJlYSA9IHRoaXMuZWxlbWVudFsgMCBdLnRhZ05hbWUgPT09ICJURVhUQVJFQSIsCgkJCWlzUmFuZ2UgPSB0aGlzLmVsZW1lbnQuaXMoICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInR5cGU9J3JhbmdlJ10iICksCgkJCWlucHV0TmVlZHNXcmFwID0gKCAodGhpcy5lbGVtZW50LmlzKCAiaW5wdXQiICkgfHwKCQkJCXRoaXMuZWxlbWVudC5pcyggIltkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAidHlwZT0nc2VhcmNoJ10iICkgKSAmJgoJCQkJCSFpc1JhbmdlICk7CgoJCWlmICggdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIgKSApIHsKCQkJb3B0aW9ucy5kaXNhYmxlZCA9IHRydWU7CgkJfQoKCQkkLmV4dGVuZCggdGhpcywgewoJCQljbGFzc2VzOiB0aGlzLl9jbGFzc2VzRnJvbU9wdGlvbnMoKSwKCQkJaXNTZWFyY2g6IGlzU2VhcmNoLAoJCQlpc1RleHRhcmVhOiBpc1RleHRhcmVhLAoJCQlpc1JhbmdlOiBpc1JhbmdlLAoJCQlpbnB1dE5lZWRzV3JhcDogaW5wdXROZWVkc1dyYXAKCQl9KTsKCgkJdGhpcy5fYXV0b0NvcnJlY3QoKTsKCgkJaWYgKCAhb3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgkJdGhpcy5fb24oIHsKCQkJImZvY3VzIjogIl9oYW5kbGVGb2N1cyIsCgkJCSJibHVyIjogIl9oYW5kbGVCbHVyIgoJCX0pOwoKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5zZXRPcHRpb25zKHsKCQkJImRpc2FibGVkIiA6IHRoaXMuZWxlbWVudC5pcyggIjpkaXNhYmxlZCIgKQoJCX0pOwoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW1lbnRDbGFzc2VzID0gW107CgoJCWlmICggdGhpcy5pc1RleHRhcmVhICkgewoJCQllbGVtZW50Q2xhc3Nlcy5wdXNoKCAidWktaW5wdXQtdGV4dCIgKTsKCQl9CgoJCWlmICggdGhpcy5pc1RleHRhcmVhIHx8IHRoaXMuaXNSYW5nZSApIHsKCQkJZWxlbWVudENsYXNzZXMucHVzaCggInVpLXNoYWRvdy1pbnNldCIgKTsKCQl9CgoJCS8vInNlYXJjaCIgYW5kICJ0ZXh0IiBpbnB1dCB3aWRnZXRzCgkJaWYgKCB0aGlzLmlucHV0TmVlZHNXcmFwICkgewoJCQl0aGlzLmVsZW1lbnQud3JhcCggdGhpcy5fd3JhcCgpICk7CgkJfSBlbHNlIHsKCQkJZWxlbWVudENsYXNzZXMgPSBlbGVtZW50Q2xhc3Nlcy5jb25jYXQoIHRoaXMuY2xhc3NlcyApOwoJCX0KCgkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCBlbGVtZW50Q2xhc3Nlcy5qb2luKCAiICIgKSApOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAoIHRoaXMuaW5wdXROZWVkc1dyYXAgKSA/IHRoaXMuZWxlbWVudC5wYXJlbnQoKSA6IHRoaXMuZWxlbWVudDsKCX0sCgoJX2NsYXNzZXNGcm9tT3B0aW9uczogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWNsYXNzZXMgPSBbXTsKCgkJY2xhc3Nlcy5wdXNoKCAidWktYm9keS0iICsgKCAoIG9wdGlvbnMudGhlbWUgPT09IG51bGwgKSA/ICJpbmhlcml0IiA6IG9wdGlvbnMudGhlbWUgKSApOwoJCWlmICggb3B0aW9ucy5jb3JuZXJzICkgewoJCQljbGFzc2VzLnB1c2goICJ1aS1jb3JuZXItYWxsIiApOwoJCX0KCQlpZiAoIG9wdGlvbnMubWluaSApIHsKCQkJY2xhc3Nlcy5wdXNoKCAidWktbWluaSIgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmRpc2FibGVkICkgewoJCQljbGFzc2VzLnB1c2goICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCQl9CgkJaWYgKCBvcHRpb25zLndyYXBwZXJDbGFzcyApIHsKCQkJY2xhc3Nlcy5wdXNoKCBvcHRpb25zLndyYXBwZXJDbGFzcyApOwoJCX0KCgkJcmV0dXJuIGNsYXNzZXM7Cgl9LAoKCV93cmFwOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJCggIjxkaXYgY2xhc3M9JyIgKwoJCQkoIHRoaXMuaXNTZWFyY2ggPyAidWktaW5wdXQtc2VhcmNoICIgOiAidWktaW5wdXQtdGV4dCAiICkgKwoJCQl0aGlzLmNsYXNzZXMuam9pbiggIiAiICkgKyAiICIgKwoJCQkidWktc2hhZG93LWluc2V0Jz48L2Rpdj4iICk7Cgl9LAoKCV9hdXRvQ29ycmVjdDogZnVuY3Rpb24oKSB7CgkJLy8gWFhYOiBUZW1wb3Jhcnkgd29ya2Fyb3VuZCBmb3IgaXNzdWUgNzg1IChBcHBsZSBidWcgODkxMDU4OSkuCgkJLy8gICAgICBUdXJuIG9mZiBhdXRvY29ycmVjdCBhbmQgYXV0b2NvbXBsZXRlIG9uIG5vbi1pT1MgNSBkZXZpY2VzCgkJLy8gICAgICBzaW5jZSB0aGUgcG9wdXAgdGhleSB1c2UgY2FuJ3QgYmUgZGlzbWlzc2VkIGJ5IHRoZSB1c2VyLiBOb3RlCgkJLy8gICAgICB0aGF0IHdlIHRlc3QgZm9yIHRoZSBwcmVzZW5jZSBvZiB0aGUgZmVhdHVyZSBieSBsb29raW5nIGZvcgoJCS8vICAgICAgdGhlIGF1dG9jb3JyZWN0IHByb3BlcnR5IG9uIHRoZSBpbnB1dCBlbGVtZW50LiBXZSBjdXJyZW50bHkKCQkvLyAgICAgIGhhdmUgbm8gdGVzdCBmb3IgaU9TIDUgb3IgbmV3ZXIgc28gd2UncmUgdGVtcG9yYXJpbHkgdXNpbmcKCQkvLyAgICAgIHRoZSB0b3VjaE92ZXJmbG93IHN1cHBvcnQgZmxhZyBmb3IgalFNIDEuMC4gWWVzLCBJIGZlZWwgZGlydHkuCgkJLy8gICAgICAtIGpibGFzCgkJaWYgKCB0eXBlb2YgdGhpcy5lbGVtZW50WzBdLmF1dG9jb3JyZWN0ICE9PSAidW5kZWZpbmVkIiAmJgoJCQkhJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgKSB7CgoJCQkvLyBTZXQgdGhlIGF0dHJpYnV0ZSBpbnN0ZWFkIG9mIHRoZSBwcm9wZXJ0eSBqdXN0IGluIGNhc2UgdGhlcmUKCQkJLy8gaXMgY29kZSB0aGF0IGF0dGVtcHRzIHRvIG1ha2UgbW9kaWZpY2F0aW9ucyB2aWEgSFRNTC4KCQkJdGhpcy5lbGVtZW50WzBdLnNldEF0dHJpYnV0ZSggImF1dG9jb3JyZWN0IiwgIm9mZiIgKTsKCQkJdGhpcy5lbGVtZW50WzBdLnNldEF0dHJpYnV0ZSggImF1dG9jb21wbGV0ZSIsICJvZmYiICk7CgkJfQoJfSwKCglfaGFuZGxlQmx1cjogZnVuY3Rpb24oKSB7CgkJdGhpcy53aWRnZXQoKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCWlmICggdGhpcy5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJfQoJfSwKCglfaGFuZGxlRm9jdXM6IGZ1bmN0aW9uKCkgewoJCS8vIEluIG1hbnkgc2l0dWF0aW9ucywgaU9TIHdpbGwgem9vbSBpbnRvIHRoZSBpbnB1dCB1cG9uIHRhcCwgdGhpcwoJCS8vIHByZXZlbnRzIHRoYXQgZnJvbSBoYXBwZW5pbmcKCQlpZiAoIHRoaXMub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQl9CgkJdGhpcy53aWRnZXQoKS5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24gKCBvcHRpb25zICkgewoJCXZhciBvdXRlciA9IHRoaXMud2lkZ2V0KCk7CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCWlmICggISggb3B0aW9ucy5kaXNhYmxlZCA9PT0gdW5kZWZpbmVkICYmCgkJCW9wdGlvbnMubWluaSA9PT0gdW5kZWZpbmVkICYmCgkJCW9wdGlvbnMuY29ybmVycyA9PT0gdW5kZWZpbmVkICYmCgkJCW9wdGlvbnMudGhlbWUgPT09IHVuZGVmaW5lZCAmJgoJCQlvcHRpb25zLndyYXBwZXJDbGFzcyA9PT0gdW5kZWZpbmVkICkgKSB7CgoJCQlvdXRlci5yZW1vdmVDbGFzcyggdGhpcy5jbGFzc2VzLmpvaW4oICIgIiApICk7CgkJCXRoaXMuY2xhc3NlcyA9IHRoaXMuX2NsYXNzZXNGcm9tT3B0aW9ucygpOwoJCQlvdXRlci5hZGRDbGFzcyggdGhpcy5jbGFzc2VzLmpvaW4oICIgIiApICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIsICEhb3B0aW9ucy5kaXNhYmxlZCApOwoJCX0KCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQlyZXR1cm47CgkJfQoJCWlmICggdGhpcy5pbnB1dE5lZWRzV3JhcCApIHsKCQkJdGhpcy5lbGVtZW50LnVud3JhcCgpOwoJCX0KCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1pbnB1dC10ZXh0ICIgKyB0aGlzLmNsYXNzZXMuam9pbiggIiAiICkgKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnNsaWRlciIsICQuZXh0ZW5kKCB7Cglpbml0U2VsZWN0b3I6ICJpbnB1dFt0eXBlPSdyYW5nZSddLCA6anFtRGF0YSh0eXBlPSdyYW5nZScpLCA6anFtRGF0YShyb2xlPSdzbGlkZXInKSIsCgoJd2lkZ2V0RXZlbnRQcmVmaXg6ICJzbGlkZSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCXRyYWNrVGhlbWU6IG51bGwsCgkJY29ybmVyczogdHJ1ZSwKCQltaW5pOiBmYWxzZSwKCQloaWdobGlnaHQ6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQkvLyBUT0RPOiBFYWNoIG9mIHRoZXNlIHNob3VsZCBoYXZlIGNvbW1lbnRzIGV4cGxhaW4gd2hhdCB0aGV5J3JlIGZvcgoJCXZhciBzZWxmID0gdGhpcywKCQkJY29udHJvbCA9IHRoaXMuZWxlbWVudCwKCQkJdHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lIHx8ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggY29udHJvbFsgMCBdLCAidGhlbWUiICksCgkJCXRyYWNrVGhlbWVDbGFzcyA9IHRyYWNrVGhlbWUgPyAiIHVpLWJhci0iICsgdHJhY2tUaGVtZSA6ICIgdWktYmFyLWluaGVyaXQiLAoJCQljb3JuZXJDbGFzcyA9ICggdGhpcy5vcHRpb25zLmNvcm5lcnMgfHwgY29udHJvbC5qcW1EYXRhKCAiY29ybmVycyIgKSApID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiLAoJCQltaW5pQ2xhc3MgPSAoIHRoaXMub3B0aW9ucy5taW5pIHx8IGNvbnRyb2wuanFtRGF0YSggIm1pbmkiICkgKSA/ICIgdWktbWluaSIgOiAiIiwKCQkJY1R5cGUgPSBjb250cm9sWyAwIF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKCQkJaXNUb2dnbGVTd2l0Y2ggPSAoIGNUeXBlID09PSAic2VsZWN0IiApLAoJCQlpc1Jhbmdlc2xpZGVyID0gY29udHJvbC5wYXJlbnQoKS5pcyggIjpqcW1EYXRhKHJvbGU9J3Jhbmdlc2xpZGVyJykiICksCgkJCXNlbGVjdENsYXNzID0gKCBpc1RvZ2dsZVN3aXRjaCApID8gInVpLXNsaWRlci1zd2l0Y2giIDogIiIsCgkJCWNvbnRyb2xJRCA9IGNvbnRyb2wuYXR0ciggImlkIiApLAoJCQkkbGFiZWwgPSAkKCAiW2Zvcj0nIiArIGNvbnRyb2xJRCArICInXSIgKSwKCQkJbGFiZWxJRCA9ICRsYWJlbC5hdHRyKCAiaWQiICkgfHwgY29udHJvbElEICsgIi1sYWJlbCIsCgkJCW1pbiA9ICFpc1RvZ2dsZVN3aXRjaCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1pbiIgKSApIDogMCwKCQkJbWF4ID0gICFpc1RvZ2dsZVN3aXRjaCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1heCIgKSApIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmxlbmd0aC0xLAoJCQlzdGVwID0gd2luZG93LnBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgfHwgMSApLAoJCQlkb21IYW5kbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiYSIgKSwKCQkJaGFuZGxlID0gJCggZG9tSGFuZGxlICksCgkJCWRvbVNsaWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCgkJCXNsaWRlciA9ICQoIGRvbVNsaWRlciApLAoJCQl2YWx1ZWJnID0gdGhpcy5vcHRpb25zLmhpZ2hsaWdodCAmJiAhaXNUb2dnbGVTd2l0Y2ggPyAoZnVuY3Rpb24oKSB7CgkJCQl2YXIgYmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJCQkJYmcuY2xhc3NOYW1lID0gInVpLXNsaWRlci1iZyAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3M7CgkJCQlyZXR1cm4gJCggYmcgKS5wcmVwZW5kVG8oIHNsaWRlciApOwoJCQl9KSgpIDogZmFsc2UsCgkJCW9wdGlvbnMsCgkJCXdyYXBwZXIsCgkJCWosIGxlbmd0aCwKCQkJaSwgb3B0aW9uc0NvdW50LCBvcmlnVGFiSW5kZXgsCgkJCXNpZGUsIGFjdGl2ZUNsYXNzLCBzbGlkZXJJbWc7CgoJCSRsYWJlbC5hdHRyKCAiaWQiLCBsYWJlbElEICk7CgkJdGhpcy5pc1RvZ2dsZVN3aXRjaCA9IGlzVG9nZ2xlU3dpdGNoOwoKCQlkb21IYW5kbGUuc2V0QXR0cmlidXRlKCAiaHJlZiIsICIjIiApOwoJCWRvbVNsaWRlci5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgImFwcGxpY2F0aW9uIiApOwoJCWRvbVNsaWRlci5jbGFzc05hbWUgPSBbIHRoaXMuaXNUb2dnbGVTd2l0Y2ggPyAidWktc2xpZGVyIHVpLXNsaWRlci10cmFjayB1aS1zaGFkb3ctaW5zZXQgIiA6ICJ1aS1zbGlkZXItdHJhY2sgdWktc2hhZG93LWluc2V0ICIsIHNlbGVjdENsYXNzLCB0cmFja1RoZW1lQ2xhc3MsIGNvcm5lckNsYXNzLCBtaW5pQ2xhc3MgXS5qb2luKCAiIiApOwoJCWRvbUhhbmRsZS5jbGFzc05hbWUgPSAidWktc2xpZGVyLWhhbmRsZSI7CgkJZG9tU2xpZGVyLmFwcGVuZENoaWxkKCBkb21IYW5kbGUgKTsKCgkJaGFuZGxlLmF0dHIoewoJCQkicm9sZSI6ICJzbGlkZXIiLAoJCQkiYXJpYS12YWx1ZW1pbiI6IG1pbiwKCQkJImFyaWEtdmFsdWVtYXgiOiBtYXgsCgkJCSJhcmlhLXZhbHVlbm93IjogdGhpcy5fdmFsdWUoKSwKCQkJImFyaWEtdmFsdWV0ZXh0IjogdGhpcy5fdmFsdWUoKSwKCQkJInRpdGxlIjogdGhpcy5fdmFsdWUoKSwKCQkJImFyaWEtbGFiZWxsZWRieSI6IGxhYmVsSUQKCQl9KTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJc2xpZGVyOiBzbGlkZXIsCgkJCWhhbmRsZTogaGFuZGxlLAoJCQljb250cm9sOiBjb250cm9sLAoJCQl0eXBlOiBjVHlwZSwKCQkJc3RlcDogc3RlcCwKCQkJbWF4OiBtYXgsCgkJCW1pbjogbWluLAoJCQl2YWx1ZWJnOiB2YWx1ZWJnLAoJCQlpc1Jhbmdlc2xpZGVyOiBpc1Jhbmdlc2xpZGVyLAoJCQlkcmFnZ2luZzogZmFsc2UsCgkJCWJlZm9yZVN0YXJ0OiBudWxsLAoJCQl1c2VyTW9kaWZpZWQ6IGZhbHNlLAoJCQltb3VzZU1vdmVkOiBmYWxzZQoJCX0pOwoKCQlpZiAoIGlzVG9nZ2xlU3dpdGNoICkgewoJCQkvLyBUT0RPOiByZXN0b3JlIG9yaWdpbmFsIHRhYmluZGV4IChpZiBhbnkpIGluIGEgZGVzdHJveSBtZXRob2QKCQkJb3JpZ1RhYkluZGV4ID0gY29udHJvbC5hdHRyKCAidGFiaW5kZXgiICk7CgkJCWlmICggb3JpZ1RhYkluZGV4ICkgewoJCQkJaGFuZGxlLmF0dHIoICJ0YWJpbmRleCIsIG9yaWdUYWJJbmRleCApOwoJCQl9CgkJCWNvbnRyb2wuYXR0ciggInRhYmluZGV4IiwgIi0xIiApLmZvY3VzKGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmJsdXIoKTsKCQkJCWhhbmRsZS5mb2N1cygpOwoJCQl9KTsKCgkJCXdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJCQl3cmFwcGVyLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItaW5uZXJvZmZzZXQiOwoKCQkJZm9yICggaiA9IDAsIGxlbmd0aCA9IGRvbVNsaWRlci5jaGlsZE5vZGVzLmxlbmd0aDsgaiA8IGxlbmd0aDsgaisrICkgewoJCQkJd3JhcHBlci5hcHBlbmRDaGlsZCggZG9tU2xpZGVyLmNoaWxkTm9kZXNbal0gKTsKCQkJfQoKCQkJZG9tU2xpZGVyLmFwcGVuZENoaWxkKCB3cmFwcGVyICk7CgoJCQkvLyBzbGlkZXIud3JhcElubmVyKCAiPGRpdiBjbGFzcz0ndWktc2xpZGVyLWlubmVyb2Zmc2V0Jz48L2Rpdj4iICk7CgoJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSB3aXRoIGEgc21vb3RoIHRyYW5zaXRpb24KCQkJaGFuZGxlLmFkZENsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCgkJCW9wdGlvbnMgPSBjb250cm9sLmZpbmQoICJvcHRpb24iICk7CgoJCQlmb3IgKCBpID0gMCwgb3B0aW9uc0NvdW50ID0gb3B0aW9ucy5sZW5ndGg7IGkgPCBvcHRpb25zQ291bnQ7IGkrKyApIHsKCQkJCXNpZGUgPSAhaSA/ICJiIiA6ICJhIjsKCQkJCWFjdGl2ZUNsYXNzID0gIWkgPyAiIiA6ICIgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzOwoJCQkJc2xpZGVySW1nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICk7CgoJCQkJc2xpZGVySW1nLmNsYXNzTmFtZSA9IFsgInVpLXNsaWRlci1sYWJlbCB1aS1zbGlkZXItbGFiZWwtIiwgc2lkZSwgYWN0aXZlQ2xhc3MgXS5qb2luKCAiIiApOwoJCQkJc2xpZGVySW1nLnNldEF0dHJpYnV0ZSggInJvbGUiLCAiaW1nIiApOwoJCQkJc2xpZGVySW1nLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggb3B0aW9uc1tpXS5pbm5lckhUTUwgKSApOwoJCQkJJCggc2xpZGVySW1nICkucHJlcGVuZFRvKCBzbGlkZXIgKTsKCQkJfQoKCQkJc2VsZi5fbGFiZWxzID0gJCggIi51aS1zbGlkZXItbGFiZWwiLCBzbGlkZXIgKTsKCgkJfQoKCQkvLyBtb25pdG9yIHRoZSBpbnB1dCBmb3IgdXBkYXRlZCB2YWx1ZXMKCQljb250cm9sLmFkZENsYXNzKCBpc1RvZ2dsZVN3aXRjaCA/ICJ1aS1zbGlkZXItc3dpdGNoIiA6ICJ1aS1zbGlkZXItaW5wdXQiICk7CgoJCXRoaXMuX29uKCBjb250cm9sLCB7CgkJCSJjaGFuZ2UiOiAiX2NvbnRyb2xDaGFuZ2UiLAoJCQkia2V5dXAiOiAiX2NvbnRyb2xLZXl1cCIsCgkJCSJibHVyIjogIl9jb250cm9sQmx1ciIsCgkJCSJ2bW91c2V1cCI6ICJfY29udHJvbFZNb3VzZVVwIgoJCX0pOwoKCQlzbGlkZXIuYmluZCggInZtb3VzZWRvd24iLCAkLnByb3h5KCB0aGlzLl9zbGlkZXJWTW91c2VEb3duLCB0aGlzICkgKQoJCQkuYmluZCggInZjbGljayIsIGZhbHNlICk7CgoJCS8vIFdlIGhhdmUgdG8gaW5zdGFudGlhdGUgYSBuZXcgZnVuY3Rpb24gb2JqZWN0IGZvciB0aGUgdW5iaW5kIHRvIHdvcmsgcHJvcGVybHkKCQkvLyBzaW5jZSB0aGUgbWV0aG9kIGl0c2VsZiBpcyBkZWZpbmVkIGluIHRoZSBwcm90b3R5cGUgKGNhdXNpbmcgaXQgdG8gdW5iaW5kIGV2ZXJ5dGhpbmcpCgkJdGhpcy5fb24oIGRvY3VtZW50LCB7ICJ2bW91c2Vtb3ZlIjogIl9wcmV2ZW50RG9jdW1lbnREcmFnIiB9KTsKCQl0aGlzLl9vbiggc2xpZGVyLmFkZCggZG9jdW1lbnQgKSwgeyAidm1vdXNldXAiOiAiX3NsaWRlclZNb3VzZVVwIiB9KTsKCgkJc2xpZGVyLmluc2VydEFmdGVyKCBjb250cm9sICk7CgoJCS8vIHdyYXAgaW4gYSBkaXYgZm9yIHN0eWxpbmcgcHVycG9zZXMKCQlpZiAoICFpc1RvZ2dsZVN3aXRjaCAmJiAhaXNSYW5nZXNsaWRlciApIHsKCQkJd3JhcHBlciA9IHRoaXMub3B0aW9ucy5taW5pID8gIjxkaXYgY2xhc3M9J3VpLXNsaWRlciB1aS1taW5pJz4iIDogIjxkaXYgY2xhc3M9J3VpLXNsaWRlcic+IjsKCgkJCWNvbnRyb2wuYWRkKCBzbGlkZXIgKS53cmFwQWxsKCB3cmFwcGVyICk7CgkJfQoKCQkvLyBiaW5kIHRoZSBoYW5kbGUgZXZlbnQgY2FsbGJhY2tzIGFuZCBzZXQgdGhlIGNvbnRleHQgdG8gdGhlIHdpZGdldCBpbnN0YW5jZQoJCXRoaXMuX29uKCB0aGlzLmhhbmRsZSwgewoJCQkidm1vdXNlZG93biI6ICJfaGFuZGxlVk1vdXNlRG93biIsCgkJCSJrZXlkb3duIjogIl9oYW5kbGVLZXlkb3duIiwKCQkJImtleXVwIjogIl9oYW5kbGVLZXl1cCIKCQl9KTsKCgkJdGhpcy5oYW5kbGUuYmluZCggInZjbGljayIsIGZhbHNlICk7CgoJCXRoaXMuX2hhbmRsZUZvcm1SZXNldCgpOwoKCQl0aGlzLnJlZnJlc2goIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB0cnVlICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0VGhlbWUoIG9wdGlvbnMudGhlbWUgKTsKCQl9CgoJCWlmICggb3B0aW9ucy50cmFja1RoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldFRyYWNrVGhlbWUoIG9wdGlvbnMudHJhY2tUaGVtZSApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0Q29ybmVycyggb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRNaW5pKCBvcHRpb25zLm1pbmkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5oaWdobGlnaHQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0SGlnaGxpZ2h0KCBvcHRpb25zLmhpZ2hsaWdodCApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldERpc2FibGVkKCBvcHRpb25zLmRpc2FibGVkICk7CgkJfQoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9LAoKCV9jb250cm9sQ2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJLy8gaWYgdGhlIHVzZXIgZHJhZ2dlZCB0aGUgaGFuZGxlLCB0aGUgImNoYW5nZSIgZXZlbnQgd2FzIHRyaWdnZXJlZCBmcm9tIGluc2lkZSByZWZyZXNoKCk7IGRvbid0IGNhbGwgcmVmcmVzaCgpIGFnYWluCgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiY29udHJvbGNoYW5nZSIsIGV2ZW50ICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCWlmICggIXRoaXMubW91c2VNb3ZlZCApIHsKCQkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpLCB0cnVlICk7CgkJfQoJfSwKCglfY29udHJvbEtleXVwOiBmdW5jdGlvbigvKiBldmVudCAqLykgeyAvLyBuZWNlc3Nhcnk/CgkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpLCB0cnVlLCB0cnVlICk7Cgl9LAoKCV9jb250cm9sQmx1cjogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCksIHRydWUgKTsKCX0sCgoJLy8gaXQgYXBwZWFycyB0aGUgY2xpY2tpbmcgdGhlIHVwIGFuZCBkb3duIGJ1dHRvbnMgaW4gY2hyb21lIG9uCgkvLyByYW5nZS9udW1iZXIgaW5wdXRzIGRvZXNuJ3QgdHJpZ2dlciBhIGNoYW5nZSB1bnRpbCB0aGUgZmllbGQgaXMKCS8vIGJsdXJyZWQuIEhlcmUgd2UgY2hlY2sgdGhpZiB0aGUgdmFsdWUgaGFzIGNoYW5nZWQgYW5kIHJlZnJlc2gKCV9jb250cm9sVk1vdXNlVXA6IGZ1bmN0aW9uKC8qIGV2ZW50ICovKSB7CgkJdGhpcy5fY2hlY2tlZFJlZnJlc2goKTsKCX0sCgoJLy8gTk9URSBmb3JjZSBmb2N1cyBvbiBoYW5kbGUKCV9oYW5kbGVWTW91c2VEb3duOiBmdW5jdGlvbigvKiBldmVudCAqLykgewoJCXRoaXMuaGFuZGxlLmZvY3VzKCk7Cgl9LAoKCV9oYW5kbGVLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGluZGV4ID0gdGhpcy5fdmFsdWUoKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gSW4gYWxsIGNhc2VzIHByZXZlbnQgdGhlIGRlZmF1bHQgYW5kIG1hcmsgdGhlIGhhbmRsZSBhcyBhY3RpdmUKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuSE9NRToKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkVORDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX0RPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRE9XTjoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQ6CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQkJCWlmICggIXRoaXMuX2tleVNsaWRpbmcgKSB7CgkJCQkJdGhpcy5fa2V5U2xpZGluZyA9IHRydWU7CgkJCQkJdGhpcy5oYW5kbGUuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7IC8qIFRPRE86IFdlIGRvbid0IHVzZSB0aGlzIGNsYXNzIGZvciBzdHlsaW5nLiBEbyB3ZSBuZWVkIHRvIGFkZCBpdD8gKi8KCQkJCX0KCgkJCQlicmVhazsKCQl9CgoJCS8vIG1vdmUgdGhlIHNsaWRlciBhY2NvcmRpbmcgdG8gdGhlIGtleXByZXNzCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCQl0aGlzLnJlZnJlc2goIHRoaXMubWluICk7CgkJCQlicmVhazsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkVORDoKCQkJCXRoaXMucmVmcmVzaCggdGhpcy5tYXggKTsKCQkJCWJyZWFrOwoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlVQOgoJCSAgICBjYXNlICQubW9iaWxlLmtleUNvZGUuTEVGVDoKCQkJCXRoaXMucmVmcmVzaCggaW5kZXggKyB0aGlzLnN0ZXAgKTsKCQkJCWJyZWFrOwoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRE9XTjoKCQkgICAgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUOgoJCQkJdGhpcy5yZWZyZXNoKCBpbmRleCAtIHRoaXMuc3RlcCApOwoJCQkJYnJlYWs7CgkJfQoJfSwgLy8gcmVtb3ZlIGFjdGl2ZSBtYXJrCgoJX2hhbmRsZUtleXVwOiBmdW5jdGlvbigvKiBldmVudCAqLykgewoJCWlmICggdGhpcy5fa2V5U2xpZGluZyApIHsKCQkJdGhpcy5fa2V5U2xpZGluZyA9IGZhbHNlOwoJCQl0aGlzLmhhbmRsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsgLyogU2VlIGNvbW1lbnQgYWJvdmUuICovCgkJfQoJfSwKCglfc2xpZGVyVk1vdXNlRG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCS8vIE5PVEU6IHdlIGRvbid0IGRvIHRoaXMgaW4gcmVmcmVzaCBiZWNhdXNlIHdlIHN0aWxsIHdhbnQgdG8KCQkvLyAgICAgICBzdXBwb3J0IHByb2dyYW1tYXRpYyBhbHRlcmF0aW9uIG9mIGRpc2FibGVkIGlucHV0cwoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8ICEoIGV2ZW50LndoaWNoID09PSAxIHx8IGV2ZW50LndoaWNoID09PSAwIHx8IGV2ZW50LndoaWNoID09PSB1bmRlZmluZWQgKSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVzdGFydCIsIGV2ZW50ICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCXRoaXMuZHJhZ2dpbmcgPSB0cnVlOwoJCXRoaXMudXNlck1vZGlmaWVkID0gZmFsc2U7CgkJdGhpcy5tb3VzZU1vdmVkID0gZmFsc2U7CgoJCWlmICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJdGhpcy5iZWZvcmVTdGFydCA9IHRoaXMuZWxlbWVudFswXS5zZWxlY3RlZEluZGV4OwoJCX0KCgkJdGhpcy5yZWZyZXNoKCBldmVudCApOwoJCXRoaXMuX3RyaWdnZXIoICJzdGFydCIgKTsKCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCV9zbGlkZXJWTW91c2VVcDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLmRyYWdnaW5nICkgewoJCQl0aGlzLmRyYWdnaW5nID0gZmFsc2U7CgoJCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSB3aXRoIGEgc21vb3RoIHRyYW5zaXRpb24KCQkJCXRoaXMuaGFuZGxlLmFkZENsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCgkJCQlpZiAoIHRoaXMubW91c2VNb3ZlZCApIHsKCQkJCQkvLyB0aGlzIGlzIGEgZHJhZywgY2hhbmdlIHRoZSB2YWx1ZSBvbmx5IGlmIHVzZXIgZHJhZ2dlZCBlbm91Z2gKCQkJCQlpZiAoIHRoaXMudXNlck1vZGlmaWVkICkgewoJCQkJCQl0aGlzLnJlZnJlc2goIHRoaXMuYmVmb3JlU3RhcnQgPT09IDAgPyAxIDogMCApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRoaXMucmVmcmVzaCggdGhpcy5iZWZvcmVTdGFydCApOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcyBpcyBqdXN0IGEgY2xpY2ssIGNoYW5nZSB0aGUgdmFsdWUKCQkJCQl0aGlzLnJlZnJlc2goIHRoaXMuYmVmb3JlU3RhcnQgPT09IDAgPyAxIDogMCApOwoJCQkJfQoJCQl9CgoJCQl0aGlzLm1vdXNlTW92ZWQgPSBmYWxzZTsKCQkJdGhpcy5fdHJpZ2dlciggInN0b3AiICk7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9LAoKCV9wcmV2ZW50RG9jdW1lbnREcmFnOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vIE5PVEU6IHdlIGRvbid0IGRvIHRoaXMgaW4gcmVmcmVzaCBiZWNhdXNlIHdlIHN0aWxsIHdhbnQgdG8KCQkJLy8gICAgICAgc3VwcG9ydCBwcm9ncmFtbWF0aWMgYWx0ZXJhdGlvbiBvZiBkaXNhYmxlZCBpbnB1dHMKCQkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiZHJhZyIsIGV2ZW50ICkgPT09IGZhbHNlKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQkJaWYgKCB0aGlzLmRyYWdnaW5nICYmICF0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgoJCQkJLy8gdGhpcy5tb3VzZU1vdmVkIG11c3QgYmUgdXBkYXRlZCBiZWZvcmUgcmVmcmVzaCgpIGJlY2F1c2UgaXQgd2lsbCBiZSB1c2VkIGluIHRoZSBjb250cm9sICJjaGFuZ2UiIGV2ZW50CgkJCQl0aGlzLm1vdXNlTW92ZWQgPSB0cnVlOwoKCQkJCWlmICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSBpbiBzeW5jIHdpdGggdGhlIG1vdXNlCgkJCQkJdGhpcy5oYW5kbGUucmVtb3ZlQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoJCQkJfQoKCQkJCXRoaXMucmVmcmVzaCggZXZlbnQgKTsKCgkJCQkvLyBvbmx5IGFmdGVyIHJlZnJlc2goKSB5b3UgY2FuIGNhbGN1bGF0ZSB0aGlzLnVzZXJNb2RpZmllZAoJCQkJdGhpcy51c2VyTW9kaWZpZWQgPSB0aGlzLmJlZm9yZVN0YXJ0ICE9PSB0aGlzLmVsZW1lbnRbMF0uc2VsZWN0ZWRJbmRleDsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgoJX2NoZWNrZWRSZWZyZXNoOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMudmFsdWUgIT09IHRoaXMuX3ZhbHVlKCkgKSB7CgkJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSApOwoJCX0KCX0sCgoJX3ZhbHVlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gIHRoaXMuaXNUb2dnbGVTd2l0Y2ggPyB0aGlzLmVsZW1lbnRbMF0uc2VsZWN0ZWRJbmRleCA6IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC52YWwoKSApIDsKCX0sCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goIHVuZGVmaW5lZCwgZmFsc2UsIHRydWUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIHZhbCwgaXNmcm9tQ29udHJvbCwgcHJldmVudElucHV0VXBkYXRlICkgewoJCS8vIE5PVEU6IHdlIGRvbid0IHJldHVybiBoZXJlIGJlY2F1c2Ugd2Ugd2FudCB0byBzdXBwb3J0IHByb2dyYW1tYXRpYwoJCS8vICAgICAgIGFsdGVyYXRpb24gb2YgdGhlIGlucHV0IHZhbHVlLCB3aGljaCBzaG91bGQgc3RpbGwgdXBkYXRlIHRoZSBzbGlkZXIKCgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlwYXJlbnRUaGVtZSA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggdGhpcy5lbGVtZW50WyAwIF0sICJ0aGVtZSIgKSwKCQkJdGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUgfHwgcGFyZW50VGhlbWUsCgkJCXRoZW1lQ2xhc3MgPSAgdGhlbWUgPyAiIHVpLWJ0bi0iICsgdGhlbWUgOiAiIiwKCQkJdHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lIHx8IHBhcmVudFRoZW1lLAoJCQl0cmFja1RoZW1lQ2xhc3MgPSB0cmFja1RoZW1lID8gIiB1aS1iYXItIiArIHRyYWNrVGhlbWUgOiAiIHVpLWJhci1pbmhlcml0IiwKCQkJY29ybmVyQ2xhc3MgPSB0aGlzLm9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiwKCQkJbWluaUNsYXNzID0gdGhpcy5vcHRpb25zLm1pbmkgPyAiIHVpLW1pbmkiIDogIiIsCgkJCWxlZnQsIHdpZHRoLCBkYXRhLCB0b2wsCgkJCXB4U3RlcCwgcGVyY2VudCwKCQkJY29udHJvbCwgaXNJbnB1dCwgb3B0aW9uRWxlbWVudHMsIG1pbiwgbWF4LCBzdGVwLAoJCQluZXd2YWwsIHZhbE1vZFN0ZXAsIGFsaWduVmFsdWUsIHBlcmNlbnRQZXJTdGVwLAoJCQloYW5kbGVQZXJjZW50LCBhUGVyY2VudCwgYlBlcmNlbnQsCgkJCXZhbHVlQ2hhbmdlZDsKCgkJc2VsZi5zbGlkZXJbMF0uY2xhc3NOYW1lID0gWyB0aGlzLmlzVG9nZ2xlU3dpdGNoID8gInVpLXNsaWRlciB1aS1zbGlkZXItc3dpdGNoIHVpLXNsaWRlci10cmFjayB1aS1zaGFkb3ctaW5zZXQiIDogInVpLXNsaWRlci10cmFjayB1aS1zaGFkb3ctaW5zZXQiLCB0cmFja1RoZW1lQ2xhc3MsIGNvcm5lckNsYXNzLCBtaW5pQ2xhc3MgXS5qb2luKCAiIiApOwoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8IHRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiICkgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCgkJLy8gc2V0IHRoZSBzdG9yZWQgdmFsdWUgZm9yIGNvbXBhcmlzb24gbGF0ZXIKCQl0aGlzLnZhbHVlID0gdGhpcy5fdmFsdWUoKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5oaWdobGlnaHQgJiYgIXRoaXMuaXNUb2dnbGVTd2l0Y2ggJiYgdGhpcy5zbGlkZXIuZmluZCggIi51aS1zbGlkZXItYmciICkubGVuZ3RoID09PSAwICkgewoJCQl0aGlzLnZhbHVlYmcgPSAoZnVuY3Rpb24oKSB7CgkJCQl2YXIgYmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJCQkJYmcuY2xhc3NOYW1lID0gInVpLXNsaWRlci1iZyAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3M7CgkJCQlyZXR1cm4gJCggYmcgKS5wcmVwZW5kVG8oIHNlbGYuc2xpZGVyICk7CgkJCX0pKCk7CgkJfQoJCXRoaXMuaGFuZGxlLmFkZENsYXNzKCAidWktYnRuIiArIHRoZW1lQ2xhc3MgKyAiIHVpLXNoYWRvdyIgKTsKCgkJY29udHJvbCA9IHRoaXMuZWxlbWVudDsKCQlpc0lucHV0ID0gIXRoaXMuaXNUb2dnbGVTd2l0Y2g7CgkJb3B0aW9uRWxlbWVudHMgPSBpc0lucHV0ID8gW10gOiBjb250cm9sLmZpbmQoICJvcHRpb24iICk7CgkJbWluID0gIGlzSW5wdXQgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDA7CgkJbWF4ID0gaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1heCIgKSApIDogb3B0aW9uRWxlbWVudHMubGVuZ3RoIC0gMTsKCQlzdGVwID0gKCBpc0lucHV0ICYmIHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgKSA+IDAgKSA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgKSA6IDE7CgoJCWlmICggdHlwZW9mIHZhbCA9PT0gIm9iamVjdCIgKSB7CgkJCWRhdGEgPSB2YWw7CgkJCS8vIGEgc2xpZ2h0IHRvbGVyYW5jZSBoZWxwZWQgZ2V0IHRvIHRoZSBlbmRzIG9mIHRoZSBzbGlkZXIKCQkJdG9sID0gODsKCgkJCWxlZnQgPSB0aGlzLnNsaWRlci5vZmZzZXQoKS5sZWZ0OwoJCQl3aWR0aCA9IHRoaXMuc2xpZGVyLndpZHRoKCk7CgkJCXB4U3RlcCA9IHdpZHRoLygobWF4LW1pbikvc3RlcCk7CgkJCWlmICggIXRoaXMuZHJhZ2dpbmcgfHwKCQkJCQlkYXRhLnBhZ2VYIDwgbGVmdCAtIHRvbCB8fAoJCQkJCWRhdGEucGFnZVggPiBsZWZ0ICsgd2lkdGggKyB0b2wgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCBweFN0ZXAgPiAxICkgewoJCQkgICAgcGVyY2VudCA9ICgoZGF0YS5wYWdlWCAtIGxlZnQpIC8gd2lkdGgpICogMTAwOwoJCQkgICAgcGVyY2VudCA9IDEwMCAtIHBlcmNlbnQ7CgkJCX0gZWxzZSB7CgkJCSAgICBwZXJjZW50ID0gTWF0aC5yb3VuZCgoKGRhdGEucGFnZVggLSBsZWZ0KSAvIHdpZHRoKSAqIDEwMCk7CgkJCSAgICBwZXJjZW50ID0gMTAwIC0gcGVyY2VudDsKCQkJfQoJCX0gZWxzZSB7CgkJCWlmICggdmFsID09IG51bGwgKSB7CgkJCQl2YWwgPSBpc0lucHV0ID8gcGFyc2VGbG9hdCggY29udHJvbC52YWwoKSB8fCAwICkgOiBjb250cm9sWzBdLnNlbGVjdGVkSW5kZXg7CgkJCX0KCQkJcGVyY2VudCA9ICggcGFyc2VGbG9hdCggdmFsICkgLSBtaW4gKSAvICggbWF4IC0gbWluICkgKiAxMDA7CgkJfQoKCQlpZiAoIGlzTmFOKCBwZXJjZW50ICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCW5ld3ZhbCA9ICggcGVyY2VudCAvIDEwMCApICogKCBtYXggLSBtaW4gKSArIG1pbjsKCgkJLy9mcm9tIGpRdWVyeSBVSSBzbGlkZXIsIHRoZSBmb2xsb3dpbmcgc291cmNlIHdpbGwgcm91bmQgdG8gdGhlIG5lYXJlc3Qgc3RlcAoJCXZhbE1vZFN0ZXAgPSAoIG5ld3ZhbCAtIG1pbiApICUgc3RlcDsKCQlhbGlnblZhbHVlID0gbmV3dmFsIC0gdmFsTW9kU3RlcDsKCgkJaWYgKCBNYXRoLmFicyggdmFsTW9kU3RlcCApICogMiA+PSBzdGVwICkgewoJCQlhbGlnblZhbHVlICs9ICggdmFsTW9kU3RlcCA+IDAgKSA/IHN0ZXAgOiAoIC1zdGVwICk7CgkJfQoKCQlwZXJjZW50UGVyU3RlcCA9IDEwMC8oKG1heC1taW4pL3N0ZXApOwoJCS8vIFNpbmNlIEphdmFTY3JpcHQgaGFzIHByb2JsZW1zIHdpdGggbGFyZ2UgZmxvYXRzLCByb3VuZAoJCS8vIHRoZSBmaW5hbCB2YWx1ZSB0byA1IGRpZ2l0cyBhZnRlciB0aGUgZGVjaW1hbCBwb2ludCAoc2VlIGpRdWVyeVVJOiAjNDEyNCkKCQluZXd2YWwgPSBwYXJzZUZsb2F0KCBhbGlnblZhbHVlLnRvRml4ZWQoNSkgKTsKCgkJaWYgKCB0eXBlb2YgcHhTdGVwID09PSAidW5kZWZpbmVkIiApIHsKCQkJcHhTdGVwID0gd2lkdGggLyAoIChtYXgtbWluKSAvIHN0ZXAgKTsKCQl9CgkJaWYgKCBweFN0ZXAgPiAxICYmIGlzSW5wdXQgKSB7CgkJCXBlcmNlbnQgPSAoIG5ld3ZhbCAtIG1pbiApICogcGVyY2VudFBlclN0ZXAgKiAoIDEgLyBzdGVwICk7CgkJfQoJCWlmICggcGVyY2VudCA8IDAgKSB7CgkJCXBlcmNlbnQgPSAwOwoJCX0KCgkJaWYgKCBwZXJjZW50ID4gMTAwICkgewoJCQlwZXJjZW50ID0gMTAwOwoJCX0KCgkJaWYgKCBuZXd2YWwgPCBtaW4gKSB7CgkJCW5ld3ZhbCA9IG1pbjsKCQl9CgoJCWlmICggbmV3dmFsID4gbWF4ICkgewoJCQluZXd2YWwgPSBtYXg7CgkJfQoKCQl0aGlzLmhhbmRsZS5jc3MoICJyaWdodCIsIHBlcmNlbnQgKyAiJSIgKTsKCgkJdGhpcy5oYW5kbGVbMF0uc2V0QXR0cmlidXRlKCAiYXJpYS12YWx1ZW5vdyIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuYXR0ciggInZhbHVlIiApICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggImFyaWEtdmFsdWV0ZXh0IiwgaXNJbnB1dCA/IG5ld3ZhbCA6IG9wdGlvbkVsZW1lbnRzLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggInRpdGxlIiwgaXNJbnB1dCA/IG5ld3ZhbCA6IG9wdGlvbkVsZW1lbnRzLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpICk7CgoJCWlmICggdGhpcy52YWx1ZWJnICkgewoJCQl0aGlzLnZhbHVlYmcuY3NzKCAid2lkdGgiLCBwZXJjZW50ICsgIiUiICk7CgkJfQoKCQkvLyBkcmFnIHRoZSBsYWJlbCB3aWR0aHMKCQlpZiAoIHRoaXMuX2xhYmVscyApIHsKCQkJaGFuZGxlUGVyY2VudCA9IHRoaXMuaGFuZGxlLndpZHRoKCkgLyB0aGlzLnNsaWRlci53aWR0aCgpICogMTAwOwoJCQlhUGVyY2VudCA9IHBlcmNlbnQgJiYgaGFuZGxlUGVyY2VudCArICggMTAwIC0gaGFuZGxlUGVyY2VudCApICogcGVyY2VudCAvIDEwMDsKCQkJYlBlcmNlbnQgPSBwZXJjZW50ID09PSAxMDAgPyAwIDogTWF0aC5taW4oIGhhbmRsZVBlcmNlbnQgKyAxMDAgLSBhUGVyY2VudCwgMTAwICk7CgoJCQl0aGlzLl9sYWJlbHMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBhYiA9ICQoIHRoaXMgKS5oYXNDbGFzcyggInVpLXNsaWRlci1sYWJlbC1hIiApOwoJCQkJJCggdGhpcyApLndpZHRoKCAoIGFiID8gYVBlcmNlbnQgOiBiUGVyY2VudCAgKSArICIlIiApOwoJCQl9KTsKCQl9CgoJCWlmICggIXByZXZlbnRJbnB1dFVwZGF0ZSApIHsKCQkJdmFsdWVDaGFuZ2VkID0gZmFsc2U7CgoJCQkvLyB1cGRhdGUgY29udHJvbCJzIHZhbHVlCgkJCWlmICggaXNJbnB1dCApIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2wudmFsKCkgIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2wudmFsKCBuZXd2YWwgKTsKCQkJfSBlbHNlIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ICE9PSBuZXd2YWw7CgkJCQljb250cm9sWyAwIF0uc2VsZWN0ZWRJbmRleCA9IG5ld3ZhbDsKCQkJfQoJCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVjaGFuZ2UiLCB2YWwgKSA9PT0gZmFsc2UpIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQkJaWYgKCAhaXNmcm9tQ29udHJvbCAmJiB2YWx1ZUNoYW5nZWQgKSB7CgkJCQljb250cm9sLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCX0KCQl9Cgl9LAoKCV9zZXRIaWdobGlnaHQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YWx1ZSA9ICEhdmFsdWU7CgkJaWYgKCB2YWx1ZSApIHsKCQkJdGhpcy5vcHRpb25zLmhpZ2hsaWdodCA9ICEhdmFsdWU7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0gZWxzZSBpZiAoIHRoaXMudmFsdWViZyApIHsKCQkJdGhpcy52YWx1ZWJnLnJlbW92ZSgpOwoJCQl0aGlzLnZhbHVlYmcgPSBmYWxzZTsKCQl9Cgl9LAoKCV9zZXRUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXRoaXMuaGFuZGxlCgkJCS5yZW1vdmVDbGFzcyggInVpLWJ0bi0iICsgdGhpcy5vcHRpb25zLnRoZW1lICkKCQkJLmFkZENsYXNzKCAidWktYnRuLSIgKyB2YWx1ZSApOwoKCQl2YXIgY3VycmVudFRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lID8gdGhpcy5vcHRpb25zLnRoZW1lIDogImluaGVyaXQiLAoJCQluZXdUaGVtZSA9IHZhbHVlID8gdmFsdWUgOiAiaW5oZXJpdCI7CgoJCXRoaXMuY29udHJvbAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1ib2R5LSIgKyBjdXJyZW50VGhlbWUgKQoJCQkuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyBuZXdUaGVtZSApOwoJfSwKCglfc2V0VHJhY2tUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhciBjdXJyZW50VHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lID8gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgOiAiaW5oZXJpdCIsCgkJCW5ld1RyYWNrVGhlbWUgPSB2YWx1ZSA/IHZhbHVlIDogImluaGVyaXQiOwoKCQl0aGlzLnNsaWRlcgoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1ib2R5LSIgKyBjdXJyZW50VHJhY2tUaGVtZSApCgkJCS5hZGRDbGFzcyggInVpLWJvZHktIiArIG5ld1RyYWNrVGhlbWUgKTsKCX0sCgoJX3NldE1pbmk6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YWx1ZSA9ICEhdmFsdWU7CgkJaWYgKCAhdGhpcy5pc1RvZ2dsZVN3aXRjaCAmJiAhdGhpcy5pc1Jhbmdlc2xpZGVyICkgewoJCQl0aGlzLnNsaWRlci5wYXJlbnQoKS50b2dnbGVDbGFzcyggInVpLW1pbmkiLCB2YWx1ZSApOwoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgdmFsdWUgKTsKCQl9CgkJdGhpcy5zbGlkZXIudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgdmFsdWUgKTsKCX0sCgoJX3NldENvcm5lcnM6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLnNsaWRlci50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCB2YWx1ZSApOwoKCQlpZiAoICF0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQl0aGlzLmNvbnRyb2wudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgdmFsdWUgKTsKCQl9Cgl9LAoKCV9zZXREaXNhYmxlZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhbHVlID0gISF2YWx1ZTsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLnNsaWRlci50b2dnbGVDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCX0KCn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgcG9wdXA7CgpmdW5jdGlvbiBnZXRQb3B1cCgpIHsKCWlmICggIXBvcHVwICkgewoJCXBvcHVwID0gJCggIjxkaXY+PC9kaXY+IiwgewoJCQkiY2xhc3MiOiAidWktc2xpZGVyLXBvcHVwIHVpLXNoYWRvdyB1aS1jb3JuZXItYWxsIgoJCX0pOwoJfQoJcmV0dXJuIHBvcHVwLmNsb25lKCk7Cn0KCiQud2lkZ2V0KCAibW9iaWxlLnNsaWRlciIsICQubW9iaWxlLnNsaWRlciwgewoJb3B0aW9uczogewoJCXBvcHVwRW5hYmxlZDogZmFsc2UsCgkJc2hvd1ZhbHVlOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfY3VycmVudFZhbHVlOiBudWxsLAoJCQlfcG9wdXA6IG51bGwsCgkJCV9wb3B1cFZpc2libGU6IGZhbHNlCgkJfSk7CgoJCXRoaXMuX3NldE9wdGlvbiggInBvcHVwRW5hYmxlZCIsIHRoaXMub3B0aW9ucy5wb3B1cEVuYWJsZWQgKTsKCgkJdGhpcy5fb24oIHRoaXMuaGFuZGxlLCB7ICJ2bW91c2Vkb3duIiA6ICJfc2hvd1BvcHVwIiB9ICk7CgkJdGhpcy5fb24oIHRoaXMuc2xpZGVyLmFkZCggdGhpcy5kb2N1bWVudCApLCB7ICJ2bW91c2V1cCIgOiAiX2hpZGVQb3B1cCIgfSApOwoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJLy8gcG9zaXRpb24gdGhlIHBvcHVwIGNlbnRlcmVkIDVweCBhYm92ZSB0aGUgaGFuZGxlCglfcG9zaXRpb25Qb3B1cDogZnVuY3Rpb24oKSB7CgkJdmFyIGRzdE9mZnNldCA9IHRoaXMuaGFuZGxlLm9mZnNldCgpOwoKCQl0aGlzLl9wb3B1cC5vZmZzZXQoIHsKCQkJbGVmdDogZHN0T2Zmc2V0LmxlZnQgKyAoIHRoaXMuaGFuZGxlLndpZHRoKCkgLSB0aGlzLl9wb3B1cC53aWR0aCgpICkgLyAyLAoJCQl0b3A6IGRzdE9mZnNldC50b3AgLSB0aGlzLl9wb3B1cC5vdXRlckhlaWdodCgpIC0gNQoJCX0pOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoKCQlpZiAoIGtleSA9PT0gInNob3dWYWx1ZSIgKSB7CgkJCXRoaXMuaGFuZGxlLmh0bWwoIHZhbHVlICYmICF0aGlzLm9wdGlvbnMubWluaSA/IHRoaXMuX3ZhbHVlKCkgOiAiIiApOwoJCX0gZWxzZSBpZiAoIGtleSA9PT0gInBvcHVwRW5hYmxlZCIgKSB7CgkJCWlmICggdmFsdWUgJiYgIXRoaXMuX3BvcHVwICkgewoJCQkJdGhpcy5fcG9wdXAgPSBnZXRQb3B1cCgpCgkJCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgKCB0aGlzLm9wdGlvbnMudGhlbWUgfHwgImEiICkgKQoJCQkJCS5pbnNlcnRCZWZvcmUoIHRoaXMuZWxlbWVudCApOwoJCQl9CgkJfQoJfSwKCgkvLyBzaG93IHZhbHVlIG9uIHRoZSBoYW5kbGUgYW5kIGluIHBvcHVwCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJdGhpcy5fcmVmcmVzaCgpOwoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIG8gPSB0aGlzLm9wdGlvbnMsIG5ld1ZhbHVlOwoKCQlpZiAoIG8ucG9wdXBFbmFibGVkICkgewoJCQkvLyByZW1vdmUgdGhlIHRpdGxlIGF0dHJpYnV0ZSBmcm9tIHRoZSBoYW5kbGUgKHdoaWNoIGlzCgkJCS8vIHJlc3BvbnNpYmxlIGZvciB0aGUgYW5ub3lpbmcgdG9vbHRpcCk7IE5CIHdlIGhhdmUKCQkJLy8gdG8gZG8gaXQgaGVyZSBhcyB0aGUganFtIHNsaWRlciBzZXRzIGl0IGV2ZXJ5IHRpbWUKCQkJLy8gdGhlIHNsaWRlcidzIHZhbHVlIGNoYW5nZXMgOigKCQkJdGhpcy5oYW5kbGUucmVtb3ZlQXR0ciggInRpdGxlIiApOwoJCX0KCgkJbmV3VmFsdWUgPSB0aGlzLl92YWx1ZSgpOwoJCWlmICggbmV3VmFsdWUgPT09IHRoaXMuX2N1cnJlbnRWYWx1ZSApIHsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9jdXJyZW50VmFsdWUgPSBuZXdWYWx1ZTsKCgkJaWYgKCBvLnBvcHVwRW5hYmxlZCAmJiB0aGlzLl9wb3B1cCApIHsKCQkJdGhpcy5fcG9zaXRpb25Qb3B1cCgpOwoJCQl0aGlzLl9wb3B1cC5odG1sKCBuZXdWYWx1ZSApOwoJCX0gZWxzZSBpZiAoIG8uc2hvd1ZhbHVlICYmICF0aGlzLm9wdGlvbnMubWluaSApIHsKCQkJdGhpcy5oYW5kbGUuaHRtbCggbmV3VmFsdWUgKTsKCQl9Cgl9LAoKCV9zaG93UG9wdXA6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5vcHRpb25zLnBvcHVwRW5hYmxlZCAmJiAhdGhpcy5fcG9wdXBWaXNpYmxlICkgewoJCQl0aGlzLmhhbmRsZS5odG1sKCAiIiApOwoJCQl0aGlzLl9wb3B1cC5zaG93KCk7CgkJCXRoaXMuX3Bvc2l0aW9uUG9wdXAoKTsKCQkJdGhpcy5fcG9wdXBWaXNpYmxlID0gdHJ1ZTsKCQl9Cgl9LAoKCV9oaWRlUG9wdXA6IGZ1bmN0aW9uKCkgewoJCXZhciBvID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG8ucG9wdXBFbmFibGVkICYmIHRoaXMuX3BvcHVwVmlzaWJsZSApIHsKCQkJaWYgKCBvLnNob3dWYWx1ZSAmJiAhby5taW5pICkgewoJCQkJdGhpcy5oYW5kbGUuaHRtbCggdGhpcy5fdmFsdWUoKSApOwoJCQl9CgkJCXRoaXMuX3BvcHVwLmhpZGUoKTsKCQkJdGhpcy5fcG9wdXBWaXNpYmxlID0gZmFsc2U7CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuZmxpcHN3aXRjaCIsICQuZXh0ZW5kKHsKCglvcHRpb25zOiB7CgkJb25UZXh0OiAiT24iLAoJCW9mZlRleHQ6ICJPZmYiLAoJCXRoZW1lOiBudWxsLAoJCWVuaGFuY2VkOiBmYWxzZSwKCQl3cmFwcGVyQ2xhc3M6IG51bGwsCgkJY29ybmVyczogdHJ1ZSwKCQltaW5pOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQkJdGhpcy5fZW5oYW5jZSgpOwoJCQl9IGVsc2UgewoJCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCQlmbGlwc3dpdGNoOiB0aGlzLmVsZW1lbnQucGFyZW50KCksCgkJCQkJb246IHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLWZsaXBzd2l0Y2gtb24iICkuZXEoIDAgKSwKCQkJCQlvZmY6IHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLWZsaXBzd2l0Y2gtb2ZmIiApLmVxKDApLAoJCQkJCXR5cGU6IHRoaXMuZWxlbWVudC5nZXQoIDAgKS50YWdOYW1lCgkJCQl9KTsKCQkJfQoKCQkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgoJCQlpZiAoIHRoaXMuZWxlbWVudC5pcyggIjpkaXNhYmxlZCIgKSApIHsKCQkJCXRoaXMuX3NldE9wdGlvbnMoewoJCQkJCSJkaXNhYmxlZCI6IHRydWUKCQkJCX0pOwoJCQl9CgoJCQl0aGlzLl9vbiggdGhpcy5mbGlwc3dpdGNoLCB7CgkJCQkiY2xpY2siOiAiX3RvZ2dsZSIsCgkJCQkic3dpcGVsZWZ0IjogIl9sZWZ0IiwKCQkJCSJzd2lwZXJpZ2h0IjogIl9yaWdodCIKCQkJfSk7CgoJCQl0aGlzLl9vbiggdGhpcy5vbiwgewoJCQkJImtleWRvd24iOiAiX2tleWRvd24iCgkJCX0pOwoKCQkJdGhpcy5fb24oIHsKCQkJCSJjaGFuZ2UiOiAicmVmcmVzaCIKCQkJfSk7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZmxpcHN3aXRjaDsKCX0sCgoJX3JpZ2h0OiBmdW5jdGlvbiAoKSB7CgkJdGhpcy5mbGlwc3dpdGNoLnJlbW92ZUNsYXNzKCAidWktZmxpcHN3aXRjaC1hY3RpdmUiICk7CgkJaWYgKCB0aGlzLnR5cGUgPT09ICJTRUxFQ1QiICkgewoJCQl0aGlzLmVsZW1lbnQuZ2V0KCAwICkuc2VsZWN0ZWRJbmRleCA9IDA7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbGVtZW50LnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCQl9CgkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJjaGFuZ2UiICk7Cgl9LAoKCV9sZWZ0OiBmdW5jdGlvbiAoKSB7CgkJdGhpcy5mbGlwc3dpdGNoLmFkZENsYXNzKCAidWktZmxpcHN3aXRjaC1hY3RpdmUiICk7CgkJaWYgKCB0aGlzLnR5cGUgPT09ICJTRUxFQ1QiICkgewoJCQl0aGlzLmVsZW1lbnQuZ2V0KCAwICkuc2VsZWN0ZWRJbmRleCA9IDE7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbGVtZW50LnByb3AoICJjaGVja2VkIiwgdHJ1ZSApOwoJCX0KCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggImNoYW5nZSIgKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXZhciBmbGlwc3dpdGNoID0gJCggIjxkaXY+IiApLAoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQllbGVtZW50ID0gdGhpcy5lbGVtZW50LAoJCQl0aGVtZSA9IG9wdGlvbnMudGhlbWUgPyBvcHRpb25zLnRoZW1lIDogImluaGVyaXQiLAoJCQlvbiA9ICQoICI8c3Bhbj48L3NwYW4+IiwgeyB0YWJpbmRleDogMSB9ICksCgkJCW9mZiA9ICQoICI8c3Bhbj48L3NwYW4+IiApLAoJCQl0eXBlID0gZWxlbWVudC5nZXQoIDAgKS50YWdOYW1lLAoJCQlvblRleHQgPSAoIHR5cGUgPT09ICJJTlBVVCIgKSA/CgkJCQlvcHRpb25zLm9uVGV4dCA6IGVsZW1lbnQuZmluZCggIm9wdGlvbiIgKS5lcSggMSApLnRleHQoKSwKCQkJb2ZmVGV4dCA9ICggdHlwZSA9PT0gIklOUFVUIiApID8KCQkJCW9wdGlvbnMub2ZmVGV4dCA6IGVsZW1lbnQuZmluZCggIm9wdGlvbiIgKS5lcSggMCApLnRleHQoKTsKCgkJCW9uCgkJCQkuYWRkQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLW9uIHVpLWJ0biB1aS1zaGFkb3cgdWktYnRuLWluaGVyaXQiICkKCQkJCS50ZXh0KCBvblRleHQgKTsKCQkJb2ZmCgkJCQkuYWRkQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLW9mZiIgKQoJCQkJLnRleHQoIG9mZlRleHQgKTsKCgkJCWZsaXBzd2l0Y2gKCQkJCS5hZGRDbGFzcyggInVpLWZsaXBzd2l0Y2ggdWktc2hhZG93LWluc2V0ICIgKwoJCQkJCSJ1aS1iYXItIiArIHRoZW1lICsgIiAiICsKCQkJCQkoIG9wdGlvbnMud3JhcHBlckNsYXNzID8gb3B0aW9ucy53cmFwcGVyQ2xhc3MgOiAiIiApICsgIiAiICsKCQkJCQkoICggZWxlbWVudC5pcyggIjpjaGVja2VkIiApIHx8CgkJCQkJCWVsZW1lbnQKCQkJCQkJCS5maW5kKCAib3B0aW9uIiApCgkJCQkJCQkuZXEoIDEgKQoJCQkJCQkJLmlzKCAiOnNlbGVjdGVkIiApICkgPyAidWktZmxpcHN3aXRjaC1hY3RpdmUiIDogIiIgKSArCgkJCQkJKCBlbGVtZW50LmlzKCI6ZGlzYWJsZWQiKSA/ICIgdWktc3RhdGUtZGlzYWJsZWQiOiAiIikgKwoJCQkJCSggb3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIjogIiIgKSArCgkJCQkJKCBvcHRpb25zLm1pbmkgPyAiIHVpLW1pbmkiOiAiIiApICkKCQkJCS5hcHBlbmQoIG9uLCBvZmYgKTsKCgkJCWVsZW1lbnQKCQkJCS5hZGRDbGFzcyggInVpLWZsaXBzd2l0Y2gtaW5wdXQiICkKCQkJCS5hZnRlciggZmxpcHN3aXRjaCApCgkJCQkuYXBwZW5kVG8oIGZsaXBzd2l0Y2ggKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJZmxpcHN3aXRjaDogZmxpcHN3aXRjaCwKCQkJb246IG9uLAoJCQlvZmY6IG9mZiwKCQkJdHlwZTogdHlwZQoJCX0pOwoJfSwKCglfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgZGlyZWN0aW9uLAoJCQlleGlzdGluZ0RpcmVjdGlvbiA9IHRoaXMuZmxpcHN3aXRjaC5oYXNDbGFzcygidWktZmxpcHN3aXRjaC1hY3RpdmUiKSA/ICJfbGVmdCIgOiAiX3JpZ2h0IjsKCgkJaWYgKCB0aGlzLnR5cGUgPT09ICJTRUxFQ1QiICkgewoJCQlkaXJlY3Rpb24gPSAoIHRoaXMuZWxlbWVudC5nZXQoIDAgKS5zZWxlY3RlZEluZGV4ID4gMCApID8gIl9yaWdodCI6ICJfbGVmdCI7CgkJfSBlbHNlIHsKCQkJZGlyZWN0aW9uID0gdGhpcy5lbGVtZW50LnByb3AoICJjaGVja2VkIiApID8gIl9yaWdodCI6ICJfbGVmdCI7CgkJfQoKCQlpZiAoIGRpcmVjdGlvbiAhPT0gZXhpc3RpbmdEaXJlY3Rpb24gKSB7CgkJCXRoaXNbIGRpcmVjdGlvbiBdKCk7CgkJfQoJfSwKCglfdG9nZ2xlOiBmdW5jdGlvbigpIHsKCQl2YXIgZGlyZWN0aW9uID0gdGhpcy5mbGlwc3dpdGNoLmhhc0NsYXNzKCAidWktZmxpcHN3aXRjaC1hY3RpdmUiICkgPyAiX2xlZnQiIDogIl9yaWdodCI7CgoJCXRoaXNbIGRpcmVjdGlvbiBdKCk7Cgl9LAoKCV9rZXlkb3duOiBmdW5jdGlvbiggZSApIHsKCSAgICBpZiAoZS53aGljaCA9PT0gJC5tb2JpbGUua2V5Q29kZS5SSUdIVCkgewoJCQl0aGlzLl9sZWZ0KCk7CgkgICAgfSBlbHNlIGlmIChlLndoaWNoID09PSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQpIHsKCQkJdGhpcy5fcmlnaHQoKTsKCQl9IGVsc2UgaWYgKCBlLndoaWNoID09PSAkLm1vYmlsZS5rZXlDb2RlLlNQQUNFICkgewoJCQl0aGlzLl90b2dnbGUoKTsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl2YXIgY3VycmVudFRoZW1lID0gb3B0aW9ucy50aGVtZSA/IG9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIsCgkJCQluZXdUaGVtZSA9IG9wdGlvbnMudGhlbWUgPyBvcHRpb25zLnRoZW1lIDogImluaGVyaXQiOwoKCQkJdGhpcy53aWRnZXQoKQoJCQkJLnJlbW92ZUNsYXNzKCAidWktYmFyLSIgKyBjdXJyZW50VGhlbWUgKQoJCQkJLmFkZENsYXNzKCAidWktYmFyLSIgKyBuZXdUaGVtZSApOwoJCX0KCQlpZiAoIG9wdGlvbnMub25UZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMub24udGV4dCggb3B0aW9ucy5vblRleHQgKTsKCQl9CgkJaWYgKCBvcHRpb25zLm9mZlRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5vZmYudGV4dCggb3B0aW9ucy5vZmZUZXh0ICk7CgkJfQoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLndpZGdldCgpLnRvZ2dsZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiLCBvcHRpb25zLmRpc2FibGVkICk7CgkJfQoJCWlmICggb3B0aW9ucy5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMud2lkZ2V0KCkudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgb3B0aW9ucy5taW5pICk7CgkJfQoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMud2lkZ2V0KCkudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5vbi5yZW1vdmUoKTsKCQl0aGlzLm9mZi5yZW1vdmUoKTsKCQl0aGlzLmVsZW1lbnQudW53cmFwKCk7CgkJdGhpcy5mbGlwc3dpdGNoLnJlbW92ZSgpOwoJCXRoaXMucmVtb3ZlQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLWlucHV0IiApOwoJfQoKfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCSQud2lkZ2V0KCAibW9iaWxlLnJhbmdlc2xpZGVyIiwgJC5leHRlbmQoIHsKCgkJb3B0aW9uczogewoJCQl0aGVtZTogbnVsbCwKCQkJdHJhY2tUaGVtZTogbnVsbCwKCQkJY29ybmVyczogdHJ1ZSwKCQkJbWluaTogZmFsc2UsCgkJCWhpZ2hsaWdodDogdHJ1ZQoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQllbENsYXNzID0gdGhpcy5vcHRpb25zLm1pbmkgPyAidWktcmFuZ2VzbGlkZXIgdWktbWluaSIgOiAidWktcmFuZ2VzbGlkZXIiLAoJCQlfaW5wdXRGaXJzdCA9ICRlbC5maW5kKCAiaW5wdXQiICkuZmlyc3QoKSwKCQkJX2lucHV0TGFzdCA9ICRlbC5maW5kKCAiaW5wdXQiICkubGFzdCgpLAoJCQlfbGFiZWwgPSAkZWwuZmluZCggImxhYmVsIiApLmZpcnN0KCksCgkJCV9zbGlkZXJXaWRnZXRGaXJzdCA9ICQuZGF0YSggX2lucHV0Rmlyc3QuZ2V0KCAwICksICJtb2JpbGUtc2xpZGVyIiApIHx8CgkJCQkkLmRhdGEoIF9pbnB1dEZpcnN0LnNsaWRlcigpLmdldCggMCApLCAibW9iaWxlLXNsaWRlciIgKSwKCQkJX3NsaWRlcldpZGdldExhc3QgPSAkLmRhdGEoIF9pbnB1dExhc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKSB8fAoJCQkJJC5kYXRhKCBfaW5wdXRMYXN0LnNsaWRlcigpLmdldCggMCApLCAibW9iaWxlLXNsaWRlciIgKSwKCQkJX3NsaWRlckZpcnN0ID0gX3NsaWRlcldpZGdldEZpcnN0LnNsaWRlciwKCQkJX3NsaWRlckxhc3QgPSBfc2xpZGVyV2lkZ2V0TGFzdC5zbGlkZXIsCgkJCWZpcnN0SGFuZGxlID0gX3NsaWRlcldpZGdldEZpcnN0LmhhbmRsZSwKCQkJX3NsaWRlcnMgPSAkKCAiPGRpdiBjbGFzcz0ndWktcmFuZ2VzbGlkZXItc2xpZGVycycgLz4iICkuYXBwZW5kVG8oICRlbCApOwoKCQkJX2lucHV0Rmlyc3QuYWRkQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1maXJzdCIgKTsKCQkJX2lucHV0TGFzdC5hZGRDbGFzcyggInVpLXJhbmdlc2xpZGVyLWxhc3QiICk7CgkJCSRlbC5hZGRDbGFzcyggZWxDbGFzcyApOwoKCQkJX3NsaWRlckZpcnN0LmFwcGVuZFRvKCBfc2xpZGVycyApOwoJCQlfc2xpZGVyTGFzdC5hcHBlbmRUbyggX3NsaWRlcnMgKTsKCQkJX2xhYmVsLmluc2VydEJlZm9yZSggJGVsICk7CgkJCWZpcnN0SGFuZGxlLnByZXBlbmRUbyggX3NsaWRlckxhc3QgKTsKCgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlfaW5wdXRGaXJzdDogX2lucHV0Rmlyc3QsCgkJCQlfaW5wdXRMYXN0OiBfaW5wdXRMYXN0LAoJCQkJX3NsaWRlckZpcnN0OiBfc2xpZGVyRmlyc3QsCgkJCQlfc2xpZGVyTGFzdDogX3NsaWRlckxhc3QsCgkJCQlfbGFiZWw6IF9sYWJlbCwKCQkJCV90YXJnZXRWYWw6IG51bGwsCgkJCQlfc2xpZGVyVGFyZ2V0OiBmYWxzZSwKCQkJCV9zbGlkZXJzOiBfc2xpZGVycywKCQkJCV9wcm94eTogZmFsc2UKCQkJfSk7CgoJCQl0aGlzLnJlZnJlc2goKTsKCQkJdGhpcy5fb24oIHRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQudWktc2xpZGVyLWlucHV0IiApLCB7CgkJCQkic2xpZGViZWZvcmVzdGFydCI6ICJfc2xpZGViZWZvcmVzdGFydCIsCgkJCQkic2xpZGVzdG9wIjogIl9zbGlkZXN0b3AiLAoJCQkJInNsaWRlZHJhZyI6ICJfc2xpZGVkcmFnIiwKCQkJCSJzbGlkZWJlZm9yZWNoYW5nZSI6ICJfY2hhbmdlIiwKCQkJCSJibHVyIjogIl9jaGFuZ2UiLAoJCQkJImtleXVwIjogIl9jaGFuZ2UiCgkJCX0pOwoJCQl0aGlzLl9vbih7CgkJCQkibW91c2Vkb3duIjoiX2NoYW5nZSIKCQkJfSk7CgkJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0iICksIHsKCQkJCSJyZXNldCI6Il9oYW5kbGVSZXNldCIKCQkJfSk7CgkJCXRoaXMuX29uKCBmaXJzdEhhbmRsZSwgewoJCQkJInZtb3VzZWRvd24iOiAiX2RyYWdGaXJzdEhhbmRsZSIKCQkJfSk7CgkJfSwKCQlfaGFuZGxlUmVzZXQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCS8vd2UgbXVzdCB3YWl0IGZvciB0aGUgc3RhY2sgdG8gdW53aW5kIGJlZm9yZSB1cGRhdGVpbmcgb3RoZXIgd2lzZSBzbGlkZXJzIHdpbGwgbm90IGhhdmUgdXBkYXRlZCB5ZXQKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQlzZWxmLl91cGRhdGVIaWdobGlnaHQoKTsKCQkJfSwwKTsKCQl9LAoKCQlfZHJhZ0ZpcnN0SGFuZGxlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vaWYgdGhlIGZpcnN0IGhhbmRsZSBpcyBkcmFnZ2VkIHNlbmQgdGhlIGV2ZW50IHRvIHRoZSBmaXJzdCBzbGlkZXIKCQkJJC5kYXRhKCB0aGlzLl9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuZHJhZ2dpbmcgPSB0cnVlOwoJCQkkLmRhdGEoIHRoaXMuX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5yZWZyZXNoKCBldmVudCApOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSwKCgkJX3NsaWRlZHJhZzogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZmlyc3QgPSAkKCBldmVudC50YXJnZXQgKS5pcyggdGhpcy5faW5wdXRGaXJzdCApLAoJCQkJb3RoZXJTbGlkZXIgPSAoIGZpcnN0ICkgPyB0aGlzLl9pbnB1dExhc3QgOiB0aGlzLl9pbnB1dEZpcnN0OwoKCQkJdGhpcy5fc2xpZGVyVGFyZ2V0ID0gZmFsc2U7CgkJCS8vaWYgdGhlIGRyYWcgd2FzIGluaXRpYXRlZCBvbiBhbiBleHRyZW1lIGFuZCB0aGUgb3RoZXIgaGFuZGxlIGlzIGZvY3VzZWQgc2VuZCB0aGUgZXZlbnRzIHRvCgkJCS8vdGhlIGNsb3Nlc3QgaGFuZGxlCgkJCWlmICggKCB0aGlzLl9wcm94eSA9PT0gImZpcnN0IiAmJiBmaXJzdCApIHx8ICggdGhpcy5fcHJveHkgPT09ICJsYXN0IiAmJiAhZmlyc3QgKSApIHsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5kcmFnZ2luZyA9IHRydWU7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkucmVmcmVzaCggZXZlbnQgKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgoJCV9zbGlkZXN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZpcnN0ID0gJCggZXZlbnQudGFyZ2V0ICkuaXMoIHRoaXMuX2lucHV0Rmlyc3QgKTsKCgkJCXRoaXMuX3Byb3h5ID0gZmFsc2U7CgkJCS8vdGhpcyBzdG9wcyBkcmFnZ2luZyBvZiB0aGUgaGFuZGxlIGFuZCBicmluZ3MgdGhlIGFjdGl2ZSB0cmFjayB0byB0aGUgZnJvbnQKCQkJLy90aGlzIG1ha2VzIGNsaWNrcyBvbiB0aGUgdHJhY2sgZ28gdGhlIHRoZSBsYXN0IGhhbmRsZSB1c2VkCgkJCXRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQiICkudHJpZ2dlciggInZtb3VzZXVwIiApOwoJCQl0aGlzLl9zbGlkZXJGaXJzdC5jc3MoICJ6LWluZGV4IiwgZmlyc3QgPyAxIDogIiIgKTsKCQl9LAoKCQlfc2xpZGViZWZvcmVzdGFydDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl0aGlzLl9zbGlkZXJUYXJnZXQgPSBmYWxzZTsKCQkJLy9pZiB0aGUgdHJhY2sgaXMgdGhlIHRhcmdldCByZW1lbWJlciB0aGlzIGFuZCB0aGUgb3JpZ2luYWwgdmFsdWUKCQkJaWYgKCAkKCBldmVudC5vcmlnaW5hbEV2ZW50LnRhcmdldCApLmhhc0NsYXNzKCAidWktc2xpZGVyLXRyYWNrIiApICkgewoJCQkJdGhpcy5fc2xpZGVyVGFyZ2V0ID0gdHJ1ZTsKCQkJCXRoaXMuX3RhcmdldFZhbCA9ICQoIGV2ZW50LnRhcmdldCApLnZhbCgpOwoJCQl9CgkJfSwKCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX3NldFRoZW1lKCBvcHRpb25zLnRoZW1lICk7CgkJCX0KCgkJCWlmICggb3B0aW9ucy50cmFja1RoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl9zZXRUcmFja1RoZW1lKCBvcHRpb25zLnRyYWNrVGhlbWUgKTsKCQkJfQoKCQkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX3NldE1pbmkoIG9wdGlvbnMubWluaSApOwoJCQl9CgoJCQlpZiAoIG9wdGlvbnMuaGlnaGxpZ2h0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl9zZXRIaWdobGlnaHQoIG9wdGlvbnMuaGlnaGxpZ2h0ICk7CgkJCX0KCQkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJfSwKCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQlvID0gdGhpcy5vcHRpb25zOwoKCQkJaWYgKCB0aGlzLl9pbnB1dEZpcnN0LmlzKCAiOmRpc2FibGVkIiApIHx8IHRoaXMuX2lucHV0TGFzdC5pcyggIjpkaXNhYmxlZCIgKSApIHsKCQkJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IHRydWU7CgkJCX0KCgkJCSRlbC5maW5kKCAiaW5wdXQiICkuc2xpZGVyKHsKCQkJCXRoZW1lOiBvLnRoZW1lLAoJCQkJdHJhY2tUaGVtZTogby50cmFja1RoZW1lLAoJCQkJZGlzYWJsZWQ6IG8uZGlzYWJsZWQsCgkJCQljb3JuZXJzOiBvLmNvcm5lcnMsCgkJCQltaW5pOiBvLm1pbmksCgkJCQloaWdobGlnaHQ6IG8uaGlnaGxpZ2h0CgkJCX0pLnNsaWRlciggInJlZnJlc2giICk7CgkJCXRoaXMuX3VwZGF0ZUhpZ2hsaWdodCgpOwoJCX0sCgoJCV9jaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCBldmVudC50eXBlID09PSAia2V5dXAiICkgewoJCQkJdGhpcy5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW1pbiA9IHBhcnNlRmxvYXQoIHRoaXMuX2lucHV0Rmlyc3QudmFsKCksIDEwICksCgkJCQltYXggPSBwYXJzZUZsb2F0KCB0aGlzLl9pbnB1dExhc3QudmFsKCksIDEwICksCgkJCQlmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmhhc0NsYXNzKCAidWktcmFuZ2VzbGlkZXItZmlyc3QiICksCgkJCQl0aGlzU2xpZGVyID0gZmlyc3QgPyB0aGlzLl9pbnB1dEZpcnN0IDogdGhpcy5faW5wdXRMYXN0LAoJCQkJb3RoZXJTbGlkZXIgPSBmaXJzdCA/IHRoaXMuX2lucHV0TGFzdCA6IHRoaXMuX2lucHV0Rmlyc3Q7CgoJCQlpZiAoICggdGhpcy5faW5wdXRGaXJzdC52YWwoKSA+IHRoaXMuX2lucHV0TGFzdC52YWwoKSAmJiBldmVudC50eXBlID09PSAibW91c2Vkb3duIiAmJiAhJChldmVudC50YXJnZXQpLmhhc0NsYXNzKCJ1aS1zbGlkZXItaGFuZGxlIikpICkgewoJCQkJdGhpc1NsaWRlci5ibHVyKCk7CgkJCX0gZWxzZSBpZiAoIGV2ZW50LnR5cGUgPT09ICJtb3VzZWRvd24iICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggbWluID4gbWF4ICYmICF0aGlzLl9zbGlkZXJUYXJnZXQgKSB7CgkJCQkvL3RoaXMgcHJldmVudHMgbWluIGZyb20gYmVpbmcgZ3JlYXRlciB0aGVuIG1heAoJCQkJdGhpc1NsaWRlci52YWwoIGZpcnN0ID8gbWF4OiBtaW4gKS5zbGlkZXIoICJyZWZyZXNoIiApOwoJCQkJdGhpcy5fdHJpZ2dlciggIm5vcm1hbGl6ZSIgKTsKCQkJfSBlbHNlIGlmICggbWluID4gbWF4ICkgewoJCQkJLy90aGlzIG1ha2VzIGl0IHNvIGNsaWNrcyBvbiB0aGUgdGFyZ2V0IG9uIGVpdGhlciBleHRyZW1lIGdvIHRvIHRoZSBjbG9zZXN0IGhhbmRsZQoJCQkJdGhpc1NsaWRlci52YWwoIHRoaXMuX3RhcmdldFZhbCApLnNsaWRlciggInJlZnJlc2giICk7CgoJCQkJLy9Zb3UgbXVzdCB3YWl0IGZvciB0aGUgc3RhY2sgdG8gdW53aW5kIHNvIGZpcnN0IHNsaWRlciBpcyB1cGRhdGVkIGJlZm9yZSB1cGRhdGluZyBzZWNvbmQKCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCW90aGVyU2xpZGVyLnZhbCggZmlyc3QgPyBtaW46IG1heCApLnNsaWRlciggInJlZnJlc2giICk7CgkJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmhhbmRsZS5mb2N1cygpOwoJCQkJCXNlbGYuX3NsaWRlckZpcnN0LmNzcyggInotaW5kZXgiLCBmaXJzdCA/ICIiIDogMSApOwoJCQkJCXNlbGYuX3RyaWdnZXIoICJub3JtYWxpemUiICk7CgkJCQl9LCAwICk7CgkJCQl0aGlzLl9wcm94eSA9ICggZmlyc3QgKSA/ICJmaXJzdCIgOiAibGFzdCI7CgkJCX0KCQkJLy9maXhlcyBpc3N1ZSB3aGVyZSB3aGVuIGJvdGggX3NsaWRlcnMgYXJlIGF0IG1pbiB0aGV5IGNhbm5vdCBiZSBhZGp1c3RlZAoJCQlpZiAoIG1pbiA9PT0gbWF4ICkgewoJCQkJJC5kYXRhKCB0aGlzU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAxICk7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAwICk7CgkJCX0gZWxzZSB7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAiIiApOwoJCQkJJC5kYXRhKCB0aGlzU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAiIiApOwoJCQl9CgoJCQl0aGlzLl91cGRhdGVIaWdobGlnaHQoKTsKCgkJCWlmICggbWluID49IG1heCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgoJCV91cGRhdGVIaWdobGlnaHQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWluID0gcGFyc2VJbnQoICQuZGF0YSggdGhpcy5faW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmhhbmRsZS5nZXQoMCkuc3R5bGUucmlnaHQsIDEwICksCgkJCQltYXggPSBwYXJzZUludCggJC5kYXRhKCB0aGlzLl9pbnB1dExhc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuZ2V0KDApLnN0eWxlLnJpZ2h0LCAxMCApLAoJCQkJd2lkdGggPSAobWF4IC0gbWluKTsKCgkJCXRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXNsaWRlci1iZyIgKS5jc3MoewoJCQkJIm1hcmdpbi1yaWdodCI6IG1pbiArICIlIiwKCQkJCSJ3aWR0aCI6IHdpZHRoICsgIiUiCgkJCX0pOwoJCX0sCgoJCV9zZXRUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9pbnB1dEZpcnN0LnNsaWRlciggIm9wdGlvbiIsICJ0aGVtZSIsIHZhbHVlICk7CgkJCXRoaXMuX2lucHV0TGFzdC5zbGlkZXIoICJvcHRpb24iLCAidGhlbWUiLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXRUcmFja1RoZW1lOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX2lucHV0Rmlyc3Quc2xpZGVyKCAib3B0aW9uIiwgInRyYWNrVGhlbWUiLCB2YWx1ZSApOwoJCQl0aGlzLl9pbnB1dExhc3Quc2xpZGVyKCAib3B0aW9uIiwgInRyYWNrVGhlbWUiLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXRNaW5pOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX2lucHV0Rmlyc3Quc2xpZGVyKCAib3B0aW9uIiwgIm1pbmkiLCB2YWx1ZSApOwoJCQl0aGlzLl9pbnB1dExhc3Quc2xpZGVyKCAib3B0aW9uIiwgIm1pbmkiLCB2YWx1ZSApOwoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgISF2YWx1ZSApOwoJCX0sCgoJCV9zZXRIaWdobGlnaHQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5faW5wdXRGaXJzdC5zbGlkZXIoICJvcHRpb24iLCAiaGlnaGxpZ2h0IiwgdmFsdWUgKTsKCQkJdGhpcy5faW5wdXRMYXN0LnNsaWRlciggIm9wdGlvbiIsICJoaWdobGlnaHQiLCB2YWx1ZSApOwoJCX0sCgoJCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fbGFiZWwucHJlcGVuZFRvKCB0aGlzLmVsZW1lbnQgKTsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktcmFuZ2VzbGlkZXIgdWktbWluaSIgKTsKCQkJdGhpcy5faW5wdXRGaXJzdC5hZnRlciggdGhpcy5fc2xpZGVyRmlyc3QgKTsKCQkJdGhpcy5faW5wdXRMYXN0LmFmdGVyKCB0aGlzLl9zbGlkZXJMYXN0ICk7CgkJCXRoaXMuX3NsaWRlcnMucmVtb3ZlKCk7CgkJCXRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQiICkucmVtb3ZlQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1maXJzdCB1aS1yYW5nZXNsaWRlci1sYXN0IiApLnNsaWRlciggImRlc3Ryb3kiICk7CgkJfQoKCX0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJJC53aWRnZXQoICJtb2JpbGUudGV4dGlucHV0IiwgJC5tb2JpbGUudGV4dGlucHV0LCB7CgkJb3B0aW9uczogewoJCQljbGVhckJ0bjogZmFsc2UsCgkJCWNsZWFyQnRuVGV4dDogIkNsZWFyIHRleHQiCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgoJCQlpZiAoICEhdGhpcy5vcHRpb25zLmNsZWFyQnRuIHx8IHRoaXMuaXNTZWFyY2ggKSB7CgkJCQl0aGlzLl9hZGRDbGVhckJ0bigpOwoJCQl9CgkJfSwKCgkJY2xlYXJCdXR0b246IGZ1bmN0aW9uKCkgewoKCQkJcmV0dXJuICQoICI8YSBocmVmPScjJyBjbGFzcz0ndWktaW5wdXQtY2xlYXIgdWktYnRuIHVpLWljb24tZGVsZXRlIHVpLWJ0bi1pY29uLW5vdGV4dCB1aS1jb3JuZXItYWxsIiArCiAgICAiJyB0aXRsZT0nIiArIHRoaXMub3B0aW9ucy5jbGVhckJ0blRleHQgKyAiJz4iICsgdGhpcy5vcHRpb25zLmNsZWFyQnRuVGV4dCArICI8L2E+IiApOwoKCQl9LAoKCQlfY2xlYXJCdG5DbGljazogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl0aGlzLmVsZW1lbnQudmFsKCAiIiApCgkJCQkJLmZvY3VzKCkKCQkJCQkudHJpZ2dlciggImNoYW5nZSIgKTsKCgkJCXRoaXMuX2NsZWFyQnRuLmFkZENsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiApOwoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0sCgoJCV9hZGRDbGVhckJ0bjogZnVuY3Rpb24oKSB7CgoJCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCQl0aGlzLl9lbmhhbmNlQ2xlYXIoKTsKCQkJfQoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9jbGVhckJ0bjogdGhpcy53aWRnZXQoKS5maW5kKCJhLnVpLWlucHV0LWNsZWFyIikKCQkJfSk7CgoJCQl0aGlzLl9iaW5kQ2xlYXJFdmVudHMoKTsKCgkJCXRoaXMuX3RvZ2dsZUNsZWFyKCk7CgoJCX0sCgoJCV9lbmhhbmNlQ2xlYXI6IGZ1bmN0aW9uKCkgewoKCQkJdGhpcy5jbGVhckJ1dHRvbigpLmFwcGVuZFRvKCB0aGlzLndpZGdldCgpICk7CgkJCXRoaXMud2lkZ2V0KCkuYWRkQ2xhc3MoICJ1aS1pbnB1dC1oYXMtY2xlYXIiICk7CgoJCX0sCgoJCV9iaW5kQ2xlYXJFdmVudHM6IGZ1bmN0aW9uKCkgewoKCQkJdGhpcy5fb24oIHRoaXMuX2NsZWFyQnRuLCB7CgkJCQkiY2xpY2siOiAiX2NsZWFyQnRuQ2xpY2siCgkJCX0pOwoKCQkJdGhpcy5fb24oewoJCQkJImtleXVwIjogIl90b2dnbGVDbGVhciIsCgkJCQkiY2hhbmdlIjogIl90b2dnbGVDbGVhciIsCgkJCQkiaW5wdXQiOiAiX3RvZ2dsZUNsZWFyIiwKCQkJCSJmb2N1cyI6ICJfdG9nZ2xlQ2xlYXIiLAoJCQkJImJsdXIiOiAiX3RvZ2dsZUNsZWFyIiwKCQkJCSJjdXQiOiAiX3RvZ2dsZUNsZWFyIiwKCQkJCSJwYXN0ZSI6ICJfdG9nZ2xlQ2xlYXIiCgoJCQl9KTsKCgkJfSwKCgkJX3VuYmluZENsZWFyOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fb2ZmKCB0aGlzLl9jbGVhckJ0biwgImNsaWNrIik7CgkJCXRoaXMuX29mZiggdGhpcy5lbGVtZW50LCAia2V5dXAgY2hhbmdlIGlucHV0IGZvY3VzIGJsdXIgY3V0IHBhc3RlIiApOwoJCX0sCgoJCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJCWlmICggb3B0aW9ucy5jbGVhcmJ0biAhPT0gdW5kZWZpbmVkICYmICF0aGlzLmVsZW1lbnQuaXMoICJ0ZXh0YXJlYSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSIgKSApIHsKCQkJCWlmICggb3B0aW9ucy5jbGVhckJ0biApIHsKCQkJCQl0aGlzLl9hZGRDbGVhckJ0bigpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLl9kZXN0cm95Q2xlYXIoKTsKCQkJCX0KCQkJfQoKCQkJaWYgKCBvcHRpb25zLmNsZWFyQnRuVGV4dCAhPT0gdW5kZWZpbmVkICYmIHRoaXMuX2NsZWFyQnRuICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl9jbGVhckJ0bi50ZXh0KCBvcHRpb25zLmNsZWFyQnRuVGV4dCApOwoJCQl9CgkJfSwKCgkJX3RvZ2dsZUNsZWFyOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fZGVsYXkoICJfdG9nZ2xlQ2xlYXJDbGFzcyIsIDAgKTsKCQl9LAoKCQlfdG9nZ2xlQ2xlYXJDbGFzczogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX2NsZWFyQnRuLnRvZ2dsZUNsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiwgIXRoaXMuZWxlbWVudC52YWwoKSApOwoJCX0sCgoJCV9kZXN0cm95Q2xlYXI6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1pbnB1dC1oYXMtY2xlYXIiICk7CgkJCXRoaXMuX3VuYmluZENsZWFyKCkuX2NsZWFyQnRuLnJlbW92ZSgpOwoJCX0sCgoJCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCQkJdGhpcy5fZGVzdHJveUNsZWFyKCk7CgkJfQoKCX0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJJC53aWRnZXQoICJtb2JpbGUudGV4dGlucHV0IiwgJC5tb2JpbGUudGV4dGlucHV0LCB7CgkJb3B0aW9uczogewoJCQlhdXRvZ3Jvdzp0cnVlLAoJCQlrZXl1cFRpbWVvdXRCdWZmZXI6IDEwMAoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoKCQkJaWYgKCB0aGlzLm9wdGlvbnMuYXV0b2dyb3cgJiYgdGhpcy5pc1RleHRhcmVhICkgewoJCQkJdGhpcy5fYXV0b2dyb3coKTsKCQkJfQoJCX0sCgoJCV9hdXRvZ3JvdzogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX29uKHsKCQkJCSJrZXl1cCI6ICJfdGltZW91dCIsCgkJCQkiY2hhbmdlIjogIl90aW1lb3V0IiwKCQkJCSJpbnB1dCI6ICJfdGltZW91dCIsCgkJCQkicGFzdGUiOiAiX3RpbWVvdXQiLAoJCQl9KTsKCgkJCS8vIEF0dGFjaCB0byB0aGUgdmFyaW91cyB5b3UtaGF2ZS1iZWNvbWUtdmlzaWJsZSBub3RpZmljYXRpb25zIHRoYXQgdGhlCgkJCS8vIHZhcmlvdXMgZnJhbWV3b3JrIGVsZW1lbnRzIGVtaXQuCgkJCS8vIFRPRE86IFJlbW92ZSBhbGwgYnV0IHRoZSB1cGRhdGVsYXlvdXQgaGFuZGxlciBvbmNlICM2NDI2IGlzIGZpeGVkLgoJCQl0aGlzLl9vbiggdHJ1ZSwgdGhpcy5kb2N1bWVudCwgewoKCQkJCS8vIFRPRE86IE1vdmUgdG8gbm9uLWRlcHJlY2F0ZWQgZXZlbnQKCQkJCSJwYWdlc2hvdyI6ICJfaGFuZGxlU2hvdyIsCgkJCQkicG9wdXBiZWZvcmVwb3NpdGlvbiI6ICJfaGFuZGxlU2hvdyIsCgkJCQkidXBkYXRlbGF5b3V0IjogIl9oYW5kbGVTaG93IiwKCQkJCSJwYW5lbG9wZW4iOiAiX2hhbmRsZVNob3ciCgkJCX0pOwoJCX0sCgoJCS8vIFN5bmNocm9ub3VzbHkgZml4IHRoZSB3aWRnZXQgaGVpZ2h0IGlmIHRoaXMgd2lkZ2V0J3MgcGFyZW50cyBhcmUgc3VjaAoJCS8vIHRoYXQgdGhleSBzaG93L2hpZGUgY29udGVudCBhdCBydW50aW1lLiBXZSBzdGlsbCBuZWVkIHRvIGNoZWNrIHdoZXRoZXIKCQkvLyB0aGUgd2lkZ2V0IGlzIGFjdHVhbGx5IHZpc2libGUgaW4gY2FzZSBpdCBpcyBjb250YWluZWQgaW5zaWRlIG11bHRpcGxlCgkJLy8gc3VjaCBjb250YWluZXJzLiBGb3IgZXhhbXBsZTogcGFuZWwgY29udGFpbnMgY29sbGFwc2libGUgY29udGFpbnMKCQkvLyBhdXRvZ3JvdyB0ZXh0aW5wdXQuIFRoZSBwYW5lbCBtYXkgZW1pdCAicGFuZWxvcGVuIiBpbmRpY2F0aW5nIHRoYXQgaXRzCgkJLy8gY29udGVudCBoYXMgYmVjb21lIHZpc2libGUsIGJ1dCB0aGUgY29sbGFwc2libGUgaXMgc3RpbGwgY29sbGFwc2VkLCBzbwoJCS8vIHRoZSBhdXRvZ3JvdyB0ZXh0YXJlYSBpcyBzdGlsbCBub3QgdmlzaWJsZS4KCQlfaGFuZGxlU2hvdzogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoICQuY29udGFpbnMoIGV2ZW50LnRhcmdldCwgdGhpcy5lbGVtZW50WyAwIF0gKSAmJgoJCQkJdGhpcy5lbGVtZW50LmlzKCAiOnZpc2libGUiICkgKSB7CgoJCQkJaWYgKCBldmVudC50eXBlICE9PSAicG9wdXBiZWZvcmVwb3NpdGlvbiIgKSB7CgkJCQkJdGhpcy5lbGVtZW50CgkJCQkJCS5hZGRDbGFzcyggInVpLXRleHRpbnB1dC1hdXRvZ3Jvdy1yZXNpemUiICkKCQkJCQkJLm9uZSggInRyYW5zaXRpb25lbmQgd2Via2l0VHJhbnNpdGlvbkVuZCBvVHJhbnNpdGlvbkVuZCIsCgkJCQkJCQkkLnByb3h5KCBmdW5jdGlvbigpIHsKCQkJCQkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS10ZXh0aW5wdXQtYXV0b2dyb3ctcmVzaXplIiApOwoJCQkJCQkJfSwgdGhpcyApICk7CgkJCQl9CgkJCQl0aGlzLl9wcmVwYXJlSGVpZ2h0VXBkYXRlKCk7CgkJCX0KCQl9LAoKCQlfdW5iaW5kQXV0b2dyb3c6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9vZmYoIHRoaXMuZWxlbWVudCwgImtleXVwIGNoYW5nZSBpbnB1dCBwYXN0ZSIgKTsKCQkJdGhpcy5fb2ZmKCB0aGlzLmRvY3VtZW50LAoJCQkJInBhZ2VzaG93IHBvcHVwYmVmb3JlcG9zaXRpb24gdXBkYXRlbGF5b3V0IHBhbmVsb3BlbiIgKTsKCQl9LAoKCQlrZXl1cFRpbWVvdXQ6IG51bGwsCgoJCV9wcmVwYXJlSGVpZ2h0VXBkYXRlOiBmdW5jdGlvbiggZGVsYXkgKSB7CgkJCWlmICggdGhpcy5rZXl1cFRpbWVvdXQgKSB7CgkJCQljbGVhclRpbWVvdXQoIHRoaXMua2V5dXBUaW1lb3V0ICk7CgkJCX0KCQkJaWYgKCBkZWxheSA9PT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fdXBkYXRlSGVpZ2h0KCk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmtleXVwVGltZW91dCA9IHRoaXMuX2RlbGF5KCAiX3VwZGF0ZUhlaWdodCIsIGRlbGF5ICk7CgkJCX0KCQl9LAoKCQlfdGltZW91dDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3ByZXBhcmVIZWlnaHRVcGRhdGUoIHRoaXMub3B0aW9ucy5rZXl1cFRpbWVvdXRCdWZmZXIgKTsKCQl9LAoKCQlfdXBkYXRlSGVpZ2h0OiBmdW5jdGlvbigpIHsKCgkJCXRoaXMua2V5dXBUaW1lb3V0ID0gMDsKCgkJCXRoaXMuZWxlbWVudC5jc3MoewoJCQkJImhlaWdodCI6IDAsCgkJCQkibWluLWhlaWdodCI6IDAsCgkJCQkibWF4LWhlaWdodCI6IDAKCQkJfSk7CgoJCQl2YXIgcGFkZGluZ1RvcCwgcGFkZGluZ0JvdHRvbSwgcGFkZGluZ0hlaWdodCwKCQkJCXNjcm9sbEhlaWdodCA9IHRoaXMuZWxlbWVudFsgMCBdLnNjcm9sbEhlaWdodCwKCQkJCWNsaWVudEhlaWdodCA9IHRoaXMuZWxlbWVudFsgMCBdLmNsaWVudEhlaWdodCwKCQkJCWJvcmRlclRvcCA9IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC5jc3MoICJib3JkZXItdG9wLXdpZHRoIiApICksCgkJCQlib3JkZXJCb3R0b20gPSBwYXJzZUZsb2F0KCB0aGlzLmVsZW1lbnQuY3NzKCAiYm9yZGVyLWJvdHRvbS13aWR0aCIgKSApLAoJCQkJYm9yZGVySGVpZ2h0ID0gYm9yZGVyVG9wICsgYm9yZGVyQm90dG9tLAoJCQkJaGVpZ2h0ID0gc2Nyb2xsSGVpZ2h0ICsgYm9yZGVySGVpZ2h0ICsgMTU7CgoJCQkvLyBJc3N1ZSA2MTc5OiBQYWRkaW5nIGlzIG5vdCBpbmNsdWRlZCBpbiBzY3JvbGxIZWlnaHQgYW5kCgkJCS8vIGNsaWVudEhlaWdodCBieSBGaXJlZm94IGlmIG5vIHNjcm9sbGJhciBpcyB2aXNpYmxlLiBCZWNhdXNlCgkJCS8vIHRleHRhcmVhcyB1c2UgdGhlIGJvcmRlci1ib3ggYm94LXNpemluZyBtb2RlbCwgcGFkZGluZyBzaG91bGQgYmUKCQkJLy8gaW5jbHVkZWQgaW4gdGhlIG5ldyAoYXNzaWduZWQpIGhlaWdodC4gQmVjYXVzZSB0aGUgaGVpZ2h0IGlzIHNldAoJCQkvLyB0byAwLCBjbGllbnRIZWlnaHQgPT0gMCBpbiBGaXJlZm94LiBUaGVyZWZvcmUsIHdlIGNhbiB1c2UgdGhpcyB0bwoJCQkvLyBjaGVjayBpZiBwYWRkaW5nIG11c3QgYmUgYWRkZWQuCgkJCWlmICggY2xpZW50SGVpZ2h0ID09PSAwICkgewoJCQkJcGFkZGluZ1RvcCA9IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC5jc3MoICJwYWRkaW5nLXRvcCIgKSApOwoJCQkJcGFkZGluZ0JvdHRvbSA9IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC5jc3MoICJwYWRkaW5nLWJvdHRvbSIgKSApOwoJCQkJcGFkZGluZ0hlaWdodCA9IHBhZGRpbmdUb3AgKyBwYWRkaW5nQm90dG9tOwoKCQkJCWhlaWdodCArPSBwYWRkaW5nSGVpZ2h0OwoJCQl9CgoJCQl0aGlzLmVsZW1lbnQuY3NzKHsKCQkJCSJoZWlnaHQiOiBoZWlnaHQsCgkJCQkibWluLWhlaWdodCI6ICIiLAoJCQkJIm1heC1oZWlnaHQiOiAiIgoJCQl9KTsKCQl9LAoKCQlyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLm9wdGlvbnMuYXV0b2dyb3cgJiYgdGhpcy5pc1RleHRhcmVhICkgewoJCQkJdGhpcy5fdXBkYXRlSGVpZ2h0KCk7CgkJCX0KCQl9LAoKCQlfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgoJCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoKCQkJaWYgKCBvcHRpb25zLmF1dG9ncm93ICE9PSB1bmRlZmluZWQgJiYgdGhpcy5pc1RleHRhcmVhICkgewoJCQkJaWYgKCBvcHRpb25zLmF1dG9ncm93ICkgewoJCQkJCXRoaXMuX2F1dG9ncm93KCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuX3VuYmluZEF1dG9ncm93KCk7CgkJCQl9CgkJCX0KCQl9CgoJfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2VsZWN0bWVudSIsICQuZXh0ZW5kKCB7Cglpbml0U2VsZWN0b3I6ICJzZWxlY3Q6bm90KCA6anFtRGF0YShyb2xlPSdzbGlkZXInKSk6bm90KCA6anFtRGF0YShyb2xlPSdmbGlwc3dpdGNoJykgKSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWljb246ICJjYXJhdC1kIiwKCQlpY29ucG9zOiAibGVmdCIsCgkJaW5saW5lOiBmYWxzZSwKCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpY29uc2hhZG93OiBmYWxzZSwgLyogVE9ETzogRGVwcmVjYXRlZCBpbiAxLjQsIHJlbW92ZSBpbiAxLjUuICovCgkJb3ZlcmxheVRoZW1lOiBudWxsLAoJCWRpdmlkZXJUaGVtZTogbnVsbCwKCQloaWRlUGxhY2Vob2xkZXJNZW51SXRlbXM6IHRydWUsCgkJY2xvc2VUZXh0OiAiQ2xvc2UiLAoJCW5hdGl2ZU1lbnU6IHRydWUsCgkJLy8gVGhpcyBvcHRpb24gZGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MgZGV2aWNlcy4KCQlwcmV2ZW50Rm9jdXNab29tOiAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSwKCQltaW5pOiBmYWxzZQoJfSwKCglfYnV0dG9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJCggIjxkaXYvPiIgKTsKCX0sCgoJX3NldERpc2FibGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHZhbHVlICk7CgkJdGhpcy5idXR0b24uYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHZhbHVlICk7Cgl9LAoKCV9mb2N1c0J1dHRvbiA6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCXNlbGYuYnV0dG9uLmZvY3VzKCk7CgkJfSwgNDApOwoJfSwKCglfc2VsZWN0T3B0aW9uczogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuc2VsZWN0LmZpbmQoICJvcHRpb24iICk7Cgl9LAoKCS8vIHNldHVwIGl0ZW1zIHRoYXQgYXJlIGdlbmVyYWxseSBuZWNlc3NhcnkgZm9yIHNlbGVjdCBtZW51IGV4dGVuc2lvbgoJX3ByZUV4dGVuc2lvbjogZnVuY3Rpb24oKSB7CgkJdmFyIGlubGluZSA9IHRoaXMub3B0aW9ucy5pbmxpbmUgfHwgdGhpcy5lbGVtZW50LmpxbURhdGEoICJpbmxpbmUiICksCgkJCW1pbmkgPSB0aGlzLm9wdGlvbnMubWluaSB8fCB0aGlzLmVsZW1lbnQuanFtRGF0YSggIm1pbmkiICksCgkJCWNsYXNzZXMgPSAiIjsKCQkvLyBUT0RPOiBQb3N0IDEuMS0tb25jZSB3ZSBoYXZlIHRpbWUgdG8gdGVzdCB0aG9yb3VnaGx5LS1hbnkgY2xhc3NlcyBtYW51YWxseSBhcHBsaWVkIHRvIHRoZSBvcmlnaW5hbCBlbGVtZW50IHNob3VsZCBiZSBjYXJyaWVkIG92ZXIgdG8gdGhlIGVuaGFuY2VkIGVsZW1lbnQsIHdpdGggYW4gYC1lbmhhbmNlZGAgc3VmZml4LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTc3CgkJLyogaWYgKCAkZWxbMF0uY2xhc3NOYW1lLmxlbmd0aCApIHsKCQkJY2xhc3NlcyA9ICRlbFswXS5jbGFzc05hbWU7CgkJfSAqLwoJCWlmICggISF+dGhpcy5lbGVtZW50WzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLWxlZnQiICkgKSB7CgkJCWNsYXNzZXMgPSAiIHVpLWJ0bi1sZWZ0IjsKCQl9CgoJCWlmICggICEhfnRoaXMuZWxlbWVudFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1yaWdodCIgKSApIHsKCQkJY2xhc3NlcyA9ICIgdWktYnRuLXJpZ2h0IjsKCQl9CgoJCWlmICggaW5saW5lICkgewoJCQljbGFzc2VzICs9ICIgdWktYnRuLWlubGluZSI7CgkJfQoJCWlmICggbWluaSApIHsKCQkJY2xhc3NlcyArPSAiIHVpLW1pbmkiOwoJCX0KCgkJdGhpcy5zZWxlY3QgPSB0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1idG4tbGVmdCB1aS1idG4tcmlnaHQiICkud3JhcCggIjxkaXYgY2xhc3M9J3VpLXNlbGVjdCIgKyBjbGFzc2VzICsgIic+IiApOwoJCXRoaXMuc2VsZWN0SWQgID0gdGhpcy5zZWxlY3QuYXR0ciggImlkIiApIHx8ICggInNlbGVjdC0iICsgdGhpcy51dWlkICk7CgkJdGhpcy5idXR0b25JZCA9IHRoaXMuc2VsZWN0SWQgKyAiLWJ1dHRvbiI7CgkJdGhpcy5sYWJlbCA9ICQoICJsYWJlbFtmb3I9JyIrIHRoaXMuc2VsZWN0SWQgKyInXSIgKTsKCQl0aGlzLmlzTXVsdGlwbGUgPSB0aGlzLnNlbGVjdFsgMCBdLm11bHRpcGxlOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIHdyYXBwZXIgPSB0aGlzLmVsZW1lbnQucGFyZW50cyggIi51aS1zZWxlY3QiICk7CgkJaWYgKCB3cmFwcGVyLmxlbmd0aCA+IDAgKSB7CgkJCWlmICggd3JhcHBlci5pcyggIi51aS1idG4tbGVmdCwgLnVpLWJ0bi1yaWdodCIgKSApIHsKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggd3JhcHBlci5oYXNDbGFzcyggInVpLWJ0bi1sZWZ0IiApID8gInVpLWJ0bi1sZWZ0IiA6ICJ1aS1idG4tcmlnaHQiICk7CgkJCX0KCQkJdGhpcy5lbGVtZW50Lmluc2VydEFmdGVyKCB3cmFwcGVyICk7CgkJCXdyYXBwZXIucmVtb3ZlKCk7CgkJfQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9wcmVFeHRlbnNpb24oKTsKCgkJdGhpcy5idXR0b24gPSB0aGlzLl9idXR0b24oKTsKCgkJdmFyIHNlbGYgPSB0aGlzLAoKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCgkJCWljb25wb3MgPSBvcHRpb25zLmljb24gPyAoIG9wdGlvbnMuaWNvbnBvcyB8fCB0aGlzLnNlbGVjdC5qcW1EYXRhKCAiaWNvbnBvcyIgKSApIDogZmFsc2UsCgoJCQlidXR0b24gPSB0aGlzLmJ1dHRvbgoJCQkJLmluc2VydEJlZm9yZSggdGhpcy5zZWxlY3QgKQoJCQkJLmF0dHIoICJpZCIsIHRoaXMuYnV0dG9uSWQgKQoJCQkJLmFkZENsYXNzKCAidWktYnRuIiArCgkJCQkJKCBvcHRpb25zLmljb24gPyAoICIgdWktaWNvbi0iICsgb3B0aW9ucy5pY29uICsgIiB1aS1idG4taWNvbi0iICsgaWNvbnBvcyArCgkJCQkJKCBvcHRpb25zLmljb25zaGFkb3cgPyAiIHVpLXNoYWRvdy1pY29uIiA6ICIiICkgKSA6CSIiICkgKyAvKiBUT0RPOiBSZW1vdmUgaW4gMS41LiAqLwoJCQkJCSggb3B0aW9ucy50aGVtZSA/ICIgdWktYnRuLSIgKyBvcHRpb25zLnRoZW1lIDogIiIgKSArCgkJCQkJKCBvcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIgKSArCgkJCQkJKCBvcHRpb25zLnNoYWRvdyA/ICIgdWktc2hhZG93IiA6ICIiICkgKTsKCgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgoJCS8vIE9wZXJhIGRvZXMgbm90IHByb3Blcmx5IHN1cHBvcnQgb3BhY2l0eSBvbiBzZWxlY3QgZWxlbWVudHMKCQkvLyBJbiBNaW5pLCBpdCBoaWRlcyB0aGUgZWxlbWVudCwgYnV0IG5vdCBpdHMgdGV4dAoJCS8vIE9uIHRoZSBkZXNrdG9wLGl0IHNlZW1zIHRvIGRvIHRoZSBvcHBvc2l0ZQoJCS8vIGZvciB0aGVzZSByZWFzb25zLCB1c2luZyB0aGUgbmF0aXZlTWVudSBvcHRpb24gcmVzdWx0cyBpbiBhIGZ1bGwgbmF0aXZlIHNlbGVjdCBpbiBPcGVyYQoJCWlmICggb3B0aW9ucy5uYXRpdmVNZW51ICYmIHdpbmRvdy5vcGVyYSAmJiB3aW5kb3cub3BlcmEudmVyc2lvbiApIHsKCQkJYnV0dG9uLmFkZENsYXNzKCAidWktc2VsZWN0LW5hdGl2ZW9ubHkiICk7CgkJfQoKCQkvLyBBZGQgY291bnRlciBmb3IgbXVsdGkgc2VsZWN0cwoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQl0aGlzLmJ1dHRvbkNvdW50ID0gJCggIjxzcGFuPiIgKQoJCQkJLmFkZENsYXNzKCAidWktbGktY291bnQgdWktYm9keS1pbmhlcml0IiApCgkJCQkuaGlkZSgpCgkJCQkuYXBwZW5kVG8oIGJ1dHRvbi5hZGRDbGFzcyggInVpLWxpLWhhcy1jb3VudCIgKSApOwoJCX0KCgkJLy8gRGlzYWJsZSBpZiBzcGVjaWZpZWQKCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIgKSkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCS8vIEV2ZW50cyBvbiBuYXRpdmUgc2VsZWN0CgkJdGhpcy5zZWxlY3QuY2hhbmdlKGZ1bmN0aW9uKCkgewoJCQlzZWxmLnJlZnJlc2goKTsKCgkJCWlmICggISFvcHRpb25zLm5hdGl2ZU1lbnUgKSB7CgkJCQl0aGlzLmJsdXIoKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCgkJdGhpcy5fb24oIHRoaXMuYnV0dG9uLCB7CgkJCWtleWRvd246ICJfaGFuZGxlS2V5ZG93biIKCQl9KTsKCgkJdGhpcy5idWlsZCgpOwoJfSwKCglidWlsZDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLnNlbGVjdAoJCQkuYXBwZW5kVG8oIHNlbGYuYnV0dG9uICkKCQkJLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBBZGQgYWN0aXZlIGNsYXNzIHRvIGJ1dHRvbgoJCQkJc2VsZi5idXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJmb2N1cyB2bW91c2VvdmVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3ZlciIgKTsKCQkJfSkKCQkJLmJpbmQoICJ2bW91c2Vtb3ZlIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBSZW1vdmUgYWN0aXZlIGNsYXNzIG9uIHNjcm9sbC90b3VjaG1vdmUKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImNoYW5nZSBibHVyIHZtb3VzZW91dCIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24udHJpZ2dlciggInZtb3VzZW91dCIgKQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSk7CgoJCS8vIEluIG1hbnkgc2l0dWF0aW9ucywgaU9TIHdpbGwgem9vbSBpbnRvIHRoZSBzZWxlY3QgdXBvbiB0YXAsIHRoaXMgcHJldmVudHMgdGhhdCBmcm9tIGhhcHBlbmluZwoJCXNlbGYuYnV0dG9uLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCQlzZWxmLmxhYmVsLmJpbmQoICJjbGljayBmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7CgkJc2VsZi5zZWxlY3QuYmluZCggImZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCQlzZWxmLmJ1dHRvbi5iaW5kKCAibW91c2V1cCIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQkJfSwgMCApOwoJCQl9CgkJfSk7CgkJc2VsZi5zZWxlY3QuYmluZCggImJsdXIiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCgl9LAoKCXNlbGVjdGVkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZCIgKTsKCX0sCgoJc2VsZWN0ZWRJbmRpY2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXJldHVybiB0aGlzLnNlbGVjdGVkKCkubWFwKGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gc2VsZi5fc2VsZWN0T3B0aW9ucygpLmluZGV4KCB0aGlzICk7CgkJfSkuZ2V0KCk7Cgl9LAoKCXNldEJ1dHRvblRleHQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJc2VsZWN0ZWQgPSB0aGlzLnNlbGVjdGVkKCksCgkJCXRleHQgPSB0aGlzLnBsYWNlaG9sZGVyLAoJCQlzcGFuID0gJCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgKTsKCgkJdGhpcy5idXR0b24uY2hpbGRyZW4oICJzcGFuIiApLm5vdCggIi51aS1saS1jb3VudCIgKS5yZW1vdmUoKS5lbmQoKS5lbmQoKS5wcmVwZW5kKCAoZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZWN0ZWQubGVuZ3RoICkgewoJCQkJdGV4dCA9IHNlbGVjdGVkLm1hcChmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gJCggdGhpcyApLnRleHQoKTsKCQkJCX0pLmdldCgpLmpvaW4oICIsICIgKTsKCQkJfSBlbHNlIHsKCQkJCXRleHQgPSBzZWxmLnBsYWNlaG9sZGVyOwoJCQl9CgoJCQlpZiAoIHRleHQgKSB7CgkJCQlzcGFuLnRleHQoIHRleHQgKTsKCQkJfSBlbHNlIHsKCQkJCXNwYW4uaHRtbCggIiZuYnNwOyIgKTsKCQkJfQoKCQkJLy8gVE9ETyBwb3NzaWJseSBhZ2dyZWdhdGUgbXVsdGlwbGUgc2VsZWN0IG9wdGlvbiBjbGFzc2VzCgkJCXJldHVybiBzcGFuCgkJCQkuYWRkQ2xhc3MoIHNlbGYuc2VsZWN0LmF0dHIoICJjbGFzcyIgKSApCgkJCQkuYWRkQ2xhc3MoIHNlbGVjdGVkLmF0dHIoICJjbGFzcyIgKSApCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0pKCkpOwoJfSwKCglzZXRCdXR0b25Db3VudDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpOwoKCQkvLyBtdWx0aXBsZSBjb3VudCBpbnNpZGUgYnV0dG9uCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnRbIHNlbGVjdGVkLmxlbmd0aCA+IDEgPyAic2hvdyIgOiAiaGlkZSIgXSgpLnRleHQoIHNlbGVjdGVkLmxlbmd0aCApOwoJCX0KCX0sCgoJX2hhbmRsZUtleWRvd246IGZ1bmN0aW9uKCAvKiBldmVudCAqLyApIHsKCQl0aGlzLl9kZWxheSggIl9yZWZyZXNoQnV0dG9uIiApOwoJfSwKCglfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCglfcmVmcmVzaEJ1dHRvbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgkJdGhpcy5zZXRCdXR0b25Db3VudCgpOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9yZWZyZXNoQnV0dG9uKCk7Cgl9LAoKCS8vIG9wZW4gYW5kIGNsb3NlIHByZXNlcnZlZCBpbiBuYXRpdmUgc2VsZWN0cwoJLy8gdG8gc2ltcGxpZnkgdXNlcnMgY29kZSB3aGVuIGxvb3Bpbmcgb3ZlciBzZWxlY3RzCglvcGVuOiAkLm5vb3AsCgljbG9zZTogJC5ub29wLAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3NldERpc2FibGVkKCB0cnVlICk7CgkJdGhpcy5idXR0b24uYWRkQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXREaXNhYmxlZCggZmFsc2UgKTsKCQl0aGlzLmJ1dHRvbi5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ICkgKTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUubGlua3MgPSBmdW5jdGlvbiggdGFyZ2V0ICkgewoKCS8vbGlua3Mgd2l0aGluIGNvbnRlbnQgYXJlYXMsIHRlc3RzIGluY2x1ZGVkIHdpdGggcGFnZQoJJCggdGFyZ2V0ICkKCQkuZmluZCggImEiICkKCQkuanFtRW5oYW5jZWFibGUoKQoJCS5maWx0ZXIoICI6anFtRGF0YShyZWw9J3BvcHVwJylbaHJlZl1baHJlZiE9JyddIiApCgkJLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkvLyBBY2Nlc3NpYmlsaXR5IGluZm8gZm9yIHBvcHVwcwoJCQl2YXIgZWxlbWVudCA9IHRoaXMsCgkJCQlpZHJlZiA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCAiaHJlZiIgKS5zdWJzdHJpbmcoIDEgKTsKCgkJCWlmICggaWRyZWYgKSB7CgkJCQllbGVtZW50LnNldEF0dHJpYnV0ZSggImFyaWEtaGFzcG9wdXAiLCB0cnVlICk7CgkJCQllbGVtZW50LnNldEF0dHJpYnV0ZSggImFyaWEtb3ducyIsIGlkcmVmICk7CgkJCQllbGVtZW50LnNldEF0dHJpYnV0ZSggImFyaWEtZXhwYW5kZWQiLCBmYWxzZSApOwoJCQl9CgkJfSkKCQkuZW5kKCkKCQkubm90KCAiLnVpLWJ0biwgOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiICkKCQkuYWRkQ2xhc3MoICJ1aS1saW5rIiApOwoKfTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCmZ1bmN0aW9uIGZpdFNlZ21lbnRJbnNpZGVTZWdtZW50KCB3aW5kb3dTaXplLCBzZWdtZW50U2l6ZSwgb2Zmc2V0LCBkZXNpcmVkICkgewoJdmFyIHJldHVyblZhbHVlID0gZGVzaXJlZDsKCglpZiAoIHdpbmRvd1NpemUgPCBzZWdtZW50U2l6ZSApIHsKCQkvLyBDZW50ZXIgc2VnbWVudCBpZiBpdCdzIGJpZ2dlciB0aGFuIHRoZSB3aW5kb3cKCQlyZXR1cm5WYWx1ZSA9IG9mZnNldCArICggd2luZG93U2l6ZSAtIHNlZ21lbnRTaXplICkgLyAyOwoJfSBlbHNlIHsKCQkvLyBPdGhlcndpc2UgY2VudGVyIGl0IGF0IHRoZSBkZXNpcmVkIGNvb3JkaW5hdGUgd2hpbGUga2VlcGluZyBpdCBjb21wbGV0ZWx5IGluc2lkZSB0aGUgd2luZG93CgkJcmV0dXJuVmFsdWUgPSBNYXRoLm1pbiggTWF0aC5tYXgoIG9mZnNldCwgZGVzaXJlZCAtIHNlZ21lbnRTaXplIC8gMiApLCBvZmZzZXQgKyB3aW5kb3dTaXplIC0gc2VnbWVudFNpemUgKTsKCX0KCglyZXR1cm4gcmV0dXJuVmFsdWU7Cn0KCmZ1bmN0aW9uIGdldFdpbmRvd0Nvb3JkaW5hdGVzKCB0aGVXaW5kb3cgKSB7CglyZXR1cm4gewoJCXg6IHRoZVdpbmRvdy5zY3JvbGxMZWZ0KCksCgkJeTogdGhlV2luZG93LnNjcm9sbFRvcCgpLAoJCWN4OiAoIHRoZVdpbmRvd1sgMCBdLmlubmVyV2lkdGggfHwgdGhlV2luZG93LndpZHRoKCkgKSwKCQljeTogKCB0aGVXaW5kb3dbIDAgXS5pbm5lckhlaWdodCB8fCB0aGVXaW5kb3cuaGVpZ2h0KCkgKQoJfTsKfQoKJC53aWRnZXQoICJtb2JpbGUucG9wdXAiLCB7CglvcHRpb25zOiB7CgkJd3JhcHBlckNsYXNzOiBudWxsLAoJCXRoZW1lOiBudWxsLAoJCW92ZXJsYXlUaGVtZTogbnVsbCwKCQlzaGFkb3c6IHRydWUsCgkJY29ybmVyczogdHJ1ZSwKCQl0cmFuc2l0aW9uOiAibm9uZSIsCgkJcG9zaXRpb25UbzogIm9yaWdpbiIsCgkJdG9sZXJhbmNlOiBudWxsLAoJCWNsb3NlTGlua1NlbGVjdG9yOiAiYTpqcW1EYXRhKHJlbD0nYmFjaycpIiwKCQljbG9zZUxpbmtFdmVudHM6ICJjbGljay5wb3B1cCIsCgkJbmF2aWdhdGVFdmVudHM6ICJuYXZpZ2F0ZS5wb3B1cCIsCgkJY2xvc2VFdmVudHM6ICJuYXZpZ2F0ZS5wb3B1cCBwYWdlYmVmb3JlY2hhbmdlLnBvcHVwIiwKCQlkaXNtaXNzaWJsZTogdHJ1ZSwKCQllbmhhbmNlZDogZmFsc2UsCgoJCS8vIE5PVEUgV2luZG93cyBQaG9uZSA3IGhhcyBhIHNjcm9sbCBwb3NpdGlvbiBjYWNoaW5nIGlzc3VlIHRoYXQKCQkvLyAgICAgIHJlcXVpcmVzIHVzIHRvIGRpc2FibGUgcG9wdXAgaGlzdG9yeSBtYW5hZ2VtZW50IGJ5IGRlZmF1bHQKCQkvLyAgICAgIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDc4NAoJCS8vCgkJLy8gTk9URSB0aGlzIG9wdGlvbiBpcyBtb2RpZmllZCBpbiBfY3JlYXRlIQoJCWhpc3Rvcnk6ICEkLm1vYmlsZS5icm93c2VyLm9sZElFCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGVFbGVtZW50ID0gdGhpcy5lbGVtZW50LAoJCQlteUlkID0gdGhlRWxlbWVudC5hdHRyKCAiaWQiICksCgkJCWN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQkvLyBXZSBuZWVkIHRvIGFkanVzdCB0aGUgaGlzdG9yeSBvcHRpb24gdG8gYmUgZmFsc2UgaWYgdGhlcmUncyBubyBBSkFYIG5hdi4KCQkvLyBXZSBjYW4ndCBkbyBpdCBpbiB0aGUgb3B0aW9uIGRlY2xhcmF0aW9ucyBiZWNhdXNlIHRob3NlIGFyZSBydW4gYmVmb3JlCgkJLy8gaXQgaXMgZGV0ZXJtaW5lZCB3aGV0aGVyIHRoZXJlIHNoYWxsIGJlIEFKQVggbmF2LgoJCWN1cnJlbnRPcHRpb25zLmhpc3RvcnkgPSBjdXJyZW50T3B0aW9ucy5oaXN0b3J5ICYmICQubW9iaWxlLmFqYXhFbmFibGVkICYmICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkOwoKCQkvLyBEZWZpbmUgaW5zdGFuY2UgdmFyaWFibGVzCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3Njcm9sbFRvcDogMCwKCQkJX3BhZ2U6IHRoZUVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLAoJCQlfdWk6IG51bGwsCgkJCV9mYWxsYmFja1RyYW5zaXRpb246ICIiLAoJCQlfY3VycmVudFRyYW5zaXRpb246IGZhbHNlLAoJCQlfcHJlcmVxdWlzaXRlczogbnVsbCwKCQkJX2lzT3BlbjogZmFsc2UsCgkJCV90b2xlcmFuY2U6IG51bGwsCgkJCV9yZXNpemVEYXRhOiBudWxsLAoJCQlfaWdub3JlUmVzaXplVG86IDAsCgkJCV9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3M6IGZhbHNlCgkJfSk7CgoJCWlmICggdGhpcy5fcGFnZS5sZW5ndGggPT09IDAgKSB7CgkJCXRoaXMuX3BhZ2UgPSAkKCAiYm9keSIgKTsKCQl9CgoJCWlmICggY3VycmVudE9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX3VpID0gewoJCQkJY29udGFpbmVyOiB0aGVFbGVtZW50LnBhcmVudCgpLAoJCQkJc2NyZWVuOiB0aGVFbGVtZW50LnBhcmVudCgpLnByZXYoKSwKCQkJCXBsYWNlaG9sZGVyOiAkKCB0aGlzLmRvY3VtZW50WyAwIF0uZ2V0RWxlbWVudEJ5SWQoIG15SWQgKyAiLXBsYWNlaG9sZGVyIiApICkKCQkJfTsKCQl9IGVsc2UgewoJCQl0aGlzLl91aSA9IHRoaXMuX2VuaGFuY2UoIHRoZUVsZW1lbnQsIG15SWQgKTsKCQkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCBjdXJyZW50T3B0aW9ucy50cmFuc2l0aW9uICk7CgkJfQoJCXRoaXMKCQkJLl9zZXRUb2xlcmFuY2UoIGN1cnJlbnRPcHRpb25zLnRvbGVyYW5jZSApCgkJCS5fdWkuZm9jdXNFbGVtZW50ID0gdGhpcy5fdWkuY29udGFpbmVyOwoKCQkvLyBFdmVudCBoYW5kbGVycwoJCXRoaXMuX29uKCB0aGlzLl91aS5zY3JlZW4sIHsgInZjbGljayI6ICJfZWF0RXZlbnRBbmRDbG9zZSIgfSApOwoJCXRoaXMuX29uKCB0aGlzLndpbmRvdywgewoJCQlvcmllbnRhdGlvbmNoYW5nZTogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dPcmllbnRhdGlvbmNoYW5nZSIgKSwKCQkJcmVzaXplOiAkLnByb3h5KCB0aGlzLCAiX2hhbmRsZVdpbmRvd1Jlc2l6ZSIgKSwKCQkJa2V5dXA6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93S2V5VXAiICkKCQl9KTsKCQl0aGlzLl9vbiggdGhpcy5kb2N1bWVudCwgeyAiZm9jdXNpbiI6ICJfaGFuZGxlRG9jdW1lbnRGb2N1c0luIiB9ICk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbiggdGhlRWxlbWVudCwgbXlJZCApIHsKCQl2YXIgY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCXdyYXBwZXJDbGFzcyA9IGN1cnJlbnRPcHRpb25zLndyYXBwZXJDbGFzcywKCQkJdWkgPSB7CgkJCQlzY3JlZW46ICQoICI8ZGl2IGNsYXNzPSd1aS1zY3JlZW4taGlkZGVuIHVpLXBvcHVwLXNjcmVlbiAiICsKCQkJCXRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktb3ZlcmxheS0iLCBjdXJyZW50T3B0aW9ucy5vdmVybGF5VGhlbWUgKSArICInPjwvZGl2PiIgKSwKCQkJCXBsYWNlaG9sZGVyOiAkKCAiPGRpdiBzdHlsZT0nZGlzcGxheTogbm9uZTsnPjwhLS0gcGxhY2Vob2xkZXIgLS0+PC9kaXY+IiApLAoJCQkJY29udGFpbmVyOiAkKCAiPGRpdiBjbGFzcz0ndWktcG9wdXAtY29udGFpbmVyIHVpLXBvcHVwLWhpZGRlbiB1aS1wb3B1cC10cnVuY2F0ZSIgKwoJCQkJCSggd3JhcHBlckNsYXNzID8gKCAiICIgKyB3cmFwcGVyQ2xhc3MgKSA6ICIiICkgKyAiJz48L2Rpdj4iICkKCQkJfSwKCQkJZnJhZ21lbnQgPSB0aGlzLmRvY3VtZW50WyAwIF0uY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoKCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggdWkuc2NyZWVuWyAwIF0gKTsKCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggdWkuY29udGFpbmVyWyAwIF0gKTsKCgkJaWYgKCBteUlkICkgewoJCQl1aS5zY3JlZW4uYXR0ciggImlkIiwgbXlJZCArICItc2NyZWVuIiApOwoJCQl1aS5jb250YWluZXIuYXR0ciggImlkIiwgbXlJZCArICItcG9wdXAiICk7CgkJCXVpLnBsYWNlaG9sZGVyCgkJCQkuYXR0ciggImlkIiwgbXlJZCArICItcGxhY2Vob2xkZXIiICkKCQkJCS5odG1sKCAiPCEtLSBwbGFjZWhvbGRlciBmb3IgIiArIG15SWQgKyAiIC0tPiIgKTsKCQl9CgoJCS8vIEFwcGx5IHRoZSBwcm90bwoJCXRoaXMuX3BhZ2VbIDAgXS5hcHBlbmRDaGlsZCggZnJhZ21lbnQgKTsKCQkvLyBMZWF2ZSBhIHBsYWNlaG9sZGVyIHdoZXJlIHRoZSBlbGVtZW50IHVzZWQgdG8gYmUKCQl1aS5wbGFjZWhvbGRlci5pbnNlcnRBZnRlciggdGhlRWxlbWVudCApOwoJCXRoZUVsZW1lbnQKCQkJLmRldGFjaCgpCgkJCS5hZGRDbGFzcyggInVpLXBvcHVwICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIGN1cnJlbnRPcHRpb25zLnRoZW1lICkgKyAiICIgKwoJCQkJKCBjdXJyZW50T3B0aW9ucy5zaGFkb3cgPyAidWktb3ZlcmxheS1zaGFkb3cgIiA6ICIiICkgKwoJCQkJKCBjdXJyZW50T3B0aW9ucy5jb3JuZXJzID8gInVpLWNvcm5lci1hbGwgIiA6ICIiICkgKQoJCQkuYXBwZW5kVG8oIHVpLmNvbnRhaW5lciApOwoKCQlyZXR1cm4gdWk7Cgl9LAoKCV9lYXRFdmVudEFuZENsb3NlOiBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJdGhlRXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl0aGVFdmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNtaXNzaWJsZSApIHsKCQkJdGhpcy5jbG9zZSgpOwoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCS8vIE1ha2Ugc3VyZSB0aGUgc2NyZWVuIGNvdmVycyB0aGUgZW50aXJlIGRvY3VtZW50IC0gQ1NTIGlzIHNvbWV0aW1lcyBub3QKCS8vIGVub3VnaCB0byBhY2NvbXBsaXNoIHRoaXMuCglfcmVzaXplU2NyZWVuOiBmdW5jdGlvbigpIHsKCQl2YXIgc2NyZWVuID0gdGhpcy5fdWkuc2NyZWVuLAoJCQlwb3B1cEhlaWdodCA9IHRoaXMuX3VpLmNvbnRhaW5lci5vdXRlckhlaWdodCggdHJ1ZSApLAoJCQlzY3JlZW5IZWlnaHQgPSBzY3JlZW4ucmVtb3ZlQXR0ciggInN0eWxlIiApLmhlaWdodCgpLAoKCQkJLy8gU3VidHJhY3RpbmcgMSBoZXJlIGlzIG5lY2Vzc2FyeSBmb3IgYW4gb2JzY3VyZSBBbmRyZG9pZCA0LjAgYnVnIHdoZXJlCgkJCS8vIHRoZSBicm93c2VyIGhhbmdzIGlmIHRoZSBzY3JlZW4gY292ZXJzIHRoZSBlbnRpcmUgZG9jdW1lbnQgOi8KCQkJZG9jdW1lbnRIZWlnaHQgPSB0aGlzLmRvY3VtZW50LmhlaWdodCgpIC0gMTsKCgkJaWYgKCBzY3JlZW5IZWlnaHQgPCBkb2N1bWVudEhlaWdodCApIHsKCQkJc2NyZWVuLmhlaWdodCggZG9jdW1lbnRIZWlnaHQgKTsKCQl9IGVsc2UgaWYgKCBwb3B1cEhlaWdodCA+IHNjcmVlbkhlaWdodCApIHsKCQkJc2NyZWVuLmhlaWdodCggcG9wdXBIZWlnaHQgKTsKCQl9Cgl9LAoKCV9oYW5kbGVXaW5kb3dLZXlVcDogZnVuY3Rpb24oIHRoZUV2ZW50ICkgewoJCWlmICggdGhpcy5faXNPcGVuICYmIHRoZUV2ZW50LmtleUNvZGUgPT09ICQubW9iaWxlLmtleUNvZGUuRVNDQVBFICkgewoJCQlyZXR1cm4gdGhpcy5fZWF0RXZlbnRBbmRDbG9zZSggdGhlRXZlbnQgKTsKCQl9Cgl9LAoKCV9leHBlY3RSZXNpemVFdmVudDogZnVuY3Rpb24oKSB7CgkJdmFyIHdpbmRvd0Nvb3JkaW5hdGVzID0gZ2V0V2luZG93Q29vcmRpbmF0ZXMoIHRoaXMud2luZG93ICk7CgoJCWlmICggdGhpcy5fcmVzaXplRGF0YSApIHsKCQkJaWYgKCB3aW5kb3dDb29yZGluYXRlcy54ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbmRvd0Nvb3JkaW5hdGVzLnggJiYKCQkJCXdpbmRvd0Nvb3JkaW5hdGVzLnkgPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luZG93Q29vcmRpbmF0ZXMueSAmJgoJCQkJd2luZG93Q29vcmRpbmF0ZXMuY3ggPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luZG93Q29vcmRpbmF0ZXMuY3ggJiYKCQkJCXdpbmRvd0Nvb3JkaW5hdGVzLmN5ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbmRvd0Nvb3JkaW5hdGVzLmN5ICkgewoJCQkJLy8gdGltZW91dCBub3QgcmVmcmVzaGVkCgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gZWxzZSB7CgkJCQkvLyBjbGVhciBleGlzdGluZyB0aW1lb3V0IC0gaXQgd2lsbCBiZSByZWZyZXNoZWQgYmVsb3cKCQkJCWNsZWFyVGltZW91dCggdGhpcy5fcmVzaXplRGF0YS50aW1lb3V0SWQgKTsKCQkJfQoJCX0KCgkJdGhpcy5fcmVzaXplRGF0YSA9IHsKCQkJdGltZW91dElkOiB0aGlzLl9kZWxheSggIl9yZXNpemVUaW1lb3V0IiwgMjAwICksCgkJCXdpbmRvd0Nvb3JkaW5hdGVzOiB3aW5kb3dDb29yZGluYXRlcwoJCX07CgoJCXJldHVybiB0cnVlOwoJfSwKCglfcmVzaXplVGltZW91dDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCWlmICggIXRoaXMuX2V4cGVjdFJlc2l6ZUV2ZW50KCkgKSB7CgkJCQlpZiAoIHRoaXMuX3VpLmNvbnRhaW5lci5oYXNDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKSApIHsKCQkJCQkvLyBlZmZlY3RpdmVseSByYXBpZC1vcGVuIHRoZSBwb3B1cCB3aGlsZSBsZWF2aW5nIHRoZSBzY3JlZW4gaW50YWN0CgkJCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtaGlkZGVuIHVpLXBvcHVwLXRydW5jYXRlIiApOwoJCQkJCXRoaXMucmVwb3NpdGlvbiggeyBwb3NpdGlvblRvOiAid2luZG93IiB9ICk7CgkJCQkJdGhpcy5faWdub3JlUmVzaXplRXZlbnRzKCk7CgkJCQl9CgoJCQkJdGhpcy5fcmVzaXplU2NyZWVuKCk7CgkJCQl0aGlzLl9yZXNpemVEYXRhID0gbnVsbDsKCQkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IGZhbHNlOwoJCQl9CgkJfSBlbHNlIHsKCQkJdGhpcy5fcmVzaXplRGF0YSA9IG51bGw7CgkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IGZhbHNlOwoJCX0KCX0sCgoJX3N0b3BJZ25vcmluZ1Jlc2l6ZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdGhpcy5faWdub3JlUmVzaXplVG8gPSAwOwoJfSwKCglfaWdub3JlUmVzaXplRXZlbnRzOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuX2lnbm9yZVJlc2l6ZVRvICkgewoJCQljbGVhclRpbWVvdXQoIHRoaXMuX2lnbm9yZVJlc2l6ZVRvICk7CgkJfQoJCXRoaXMuX2lnbm9yZVJlc2l6ZVRvID0gdGhpcy5fZGVsYXkoICJfc3RvcElnbm9yaW5nUmVzaXplRXZlbnRzIiwgMTAwMCApOwoJfSwKCglfaGFuZGxlV2luZG93UmVzaXplOiBmdW5jdGlvbigvKiB0aGVFdmVudCAqLykgewoJCWlmICggdGhpcy5faXNPcGVuICYmIHRoaXMuX2lnbm9yZVJlc2l6ZVRvID09PSAwICkgewoJCQlpZiAoICggdGhpcy5fZXhwZWN0UmVzaXplRXZlbnQoKSB8fCB0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgKSAmJgoJCQkJIXRoaXMuX3VpLmNvbnRhaW5lci5oYXNDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKSApIHsKCQkJCS8vIGVmZmVjdGl2ZWx5IHJhcGlkLWNsb3NlIHRoZSBwb3B1cCB3aGlsZSBsZWF2aW5nIHRoZSBzY3JlZW4gaW50YWN0CgkJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCQkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4gdWktcG9wdXAtdHJ1bmNhdGUiICkKCQkJCQkucmVtb3ZlQXR0ciggInN0eWxlIiApOwoJCQl9CgkJfQoJfSwKCglfaGFuZGxlV2luZG93T3JpZW50YXRpb25jaGFuZ2U6IGZ1bmN0aW9uKC8qIHRoZUV2ZW50ICovKSB7CgkJaWYgKCAhdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzICYmIHRoaXMuX2lzT3BlbiAmJiB0aGlzLl9pZ25vcmVSZXNpemVUbyA9PT0gMCApIHsKCQkJdGhpcy5fZXhwZWN0UmVzaXplRXZlbnQoKTsKCQkJdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzID0gdHJ1ZTsKCQl9Cgl9LAoKCS8vIFdoZW4gdGhlIHBvcHVwIGlzIG9wZW4sIGF0dGVtcHRpbmcgdG8gZm9jdXMgb24gYW4gZWxlbWVudCB0aGF0IGlzIG5vdCBhCgkvLyBjaGlsZCBvZiB0aGUgcG9wdXAgd2lsbCByZWRpcmVjdCBmb2N1cyB0byB0aGUgcG9wdXAKCV9oYW5kbGVEb2N1bWVudEZvY3VzSW46IGZ1bmN0aW9uKCB0aGVFdmVudCApIHsKCQl2YXIgdGFyZ2V0LAoJCQl0YXJnZXRFbGVtZW50ID0gdGhlRXZlbnQudGFyZ2V0LAoJCQl1aSA9IHRoaXMuX3VpOwoKCQlpZiAoICF0aGlzLl9pc09wZW4gKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggdGFyZ2V0RWxlbWVudCAhPT0gdWkuY29udGFpbmVyWyAwIF0gKSB7CgkJCXRhcmdldCA9ICQoIHRhcmdldEVsZW1lbnQgKTsKCQkJaWYgKCAwID09PSB0YXJnZXQucGFyZW50cygpLmZpbHRlciggdWkuY29udGFpbmVyWyAwIF0gKS5sZW5ndGggKSB7CgkJCQkkKCB0aGlzLmRvY3VtZW50WyAwIF0uYWN0aXZlRWxlbWVudCApLm9uZSggImZvY3VzIiwgZnVuY3Rpb24oLyogdGhlRXZlbnQgKi8pIHsKCQkJCQl0YXJnZXQuYmx1cigpOwoJCQkJfSk7CgkJCQl1aS5mb2N1c0VsZW1lbnQuZm9jdXMoKTsKCQkJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl0aGVFdmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfSBlbHNlIGlmICggdWkuZm9jdXNFbGVtZW50WyAwIF0gPT09IHVpLmNvbnRhaW5lclsgMCBdICkgewoJCQkJdWkuZm9jdXNFbGVtZW50ID0gdGFyZ2V0OwoJCQl9CgkJfQoKCQl0aGlzLl9pZ25vcmVSZXNpemVFdmVudHMoKTsKCX0sCgoJX3RoZW1lQ2xhc3NGcm9tT3B0aW9uOiBmdW5jdGlvbiggcHJlZml4LCB2YWx1ZSApIHsKCQlyZXR1cm4gKCB2YWx1ZSA/ICggdmFsdWUgPT09ICJub25lIiA/ICIiIDogKCBwcmVmaXggKyB2YWx1ZSApICkgOiAoIHByZWZpeCArICJpbmhlcml0IiApICk7Cgl9LAoKCV9hcHBseVRyYW5zaXRpb246IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlpZiAoIHZhbHVlICkgewoJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiApOwoJCQlpZiAoIHZhbHVlICE9PSAibm9uZSIgKSB7CgkJCQl0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gPSAkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiggdmFsdWUgKTsKCQkJCWlmICggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID09PSAibm9uZSIgKSB7CgkJCQkJdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID0gIiI7CgkJCQl9CgkJCQl0aGlzLl91aS5jb250YWluZXIuYWRkQ2xhc3MoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiApOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBuZXdPcHRpb25zICkgewoJCXZhciBjdXJyZW50T3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJdGhlRWxlbWVudCA9IHRoaXMuZWxlbWVudCwKCQkJc2NyZWVuID0gdGhpcy5fdWkuc2NyZWVuOwoKCQlpZiAoIG5ld09wdGlvbnMud3JhcHBlckNsYXNzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkJLnJlbW92ZUNsYXNzKCBjdXJyZW50T3B0aW9ucy53cmFwcGVyQ2xhc3MgKQoJCQkJLmFkZENsYXNzKCBuZXdPcHRpb25zLndyYXBwZXJDbGFzcyApOwoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoZUVsZW1lbnQKCQkJCS5yZW1vdmVDbGFzcyggdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIGN1cnJlbnRPcHRpb25zLnRoZW1lICkgKQoJCQkJLmFkZENsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgbmV3T3B0aW9ucy50aGVtZSApICk7CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMub3ZlcmxheVRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXNjcmVlbgoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLW92ZXJsYXktIiwgY3VycmVudE9wdGlvbnMub3ZlcmxheVRoZW1lICkgKQoJCQkJLmFkZENsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLW92ZXJsYXktIiwgbmV3T3B0aW9ucy5vdmVybGF5VGhlbWUgKSApOwoKCQkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCQlzY3JlZW4uYWRkQ2xhc3MoICJpbiIgKTsKCQkJfQoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLnNoYWRvdyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGVFbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktb3ZlcmxheS1zaGFkb3ciLCBuZXdPcHRpb25zLnNoYWRvdyApOwoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhlRWxlbWVudC50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBuZXdPcHRpb25zLmNvcm5lcnMgKTsKCQl9CgoJCWlmICggbmV3T3B0aW9ucy50cmFuc2l0aW9uICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggIXRoaXMuX2N1cnJlbnRUcmFuc2l0aW9uICkgewoJCQkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCBuZXdPcHRpb25zLnRyYW5zaXRpb24gKTsKCQkJfQoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLnRvbGVyYW5jZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRUb2xlcmFuY2UoIG5ld09wdGlvbnMudG9sZXJhbmNlICk7CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMuZGlzYWJsZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCBuZXdPcHRpb25zLmRpc2FibGVkICkgewoJCQkJdGhpcy5jbG9zZSgpOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fc3VwZXIoIG5ld09wdGlvbnMgKTsKCX0sCgoJX3NldFRvbGVyYW5jZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhciB0b2wgPSB7IHQ6IDMwLCByOiAxNSwgYjogMzAsIGw6IDE1IH0sCgkJCWFyOwoKCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCWFyID0gU3RyaW5nKCB2YWx1ZSApLnNwbGl0KCAiLCIgKTsKCgkJCSQuZWFjaCggYXIsIGZ1bmN0aW9uKCBpZHgsIHZhbCApIHsgYXJbIGlkeCBdID0gcGFyc2VJbnQoIHZhbCwgMTAgKTsgfSApOwoKCQkJc3dpdGNoKCBhci5sZW5ndGggKSB7CgkJCQkvLyBBbGwgdmFsdWVzIGFyZSB0byBiZSB0aGUgc2FtZQoJCQkJY2FzZSAxOgoJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCXRvbC50ID0gdG9sLnIgPSB0b2wuYiA9IHRvbC5sID0gYXJbIDAgXTsKCQkJCQl9CgkJCQkJYnJlYWs7CgoJCQkJLy8gVGhlIGZpcnN0IHZhbHVlIGRlbm90ZXMgdG9wL2JvdHRvbSB0b2xlcmFuY2UsIGFuZCB0aGUgc2Vjb25kIHZhbHVlIGRlbm90ZXMgbGVmdC9yaWdodCB0b2xlcmFuY2UKCQkJCWNhc2UgMjoKCQkJCQlpZiAoICFpc05hTiggYXJbIDAgXSApICkgewoJCQkJCQl0b2wudCA9IHRvbC5iID0gYXJbIDAgXTsKCQkJCQl9CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAxIF0gKSApIHsKCQkJCQkJdG9sLmwgPSB0b2wuciA9IGFyWyAxIF07CgkJCQkJfQoJCQkJCWJyZWFrOwoKCQkJCS8vIFRoZSBhcnJheSBjb250YWlucyB2YWx1ZXMgaW4gdGhlIG9yZGVyIHRvcCwgcmlnaHQsIGJvdHRvbSwgbGVmdAoJCQkJY2FzZSA0OgoJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCXRvbC50ID0gYXJbIDAgXTsKCQkJCQl9CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAxIF0gKSApIHsKCQkJCQkJdG9sLnIgPSBhclsgMSBdOwoJCQkJCX0KCQkJCQlpZiAoICFpc05hTiggYXJbIDIgXSApICkgewoJCQkJCQl0b2wuYiA9IGFyWyAyIF07CgkJCQkJfQoJCQkJCWlmICggIWlzTmFOKCBhclsgMyBdICkgKSB7CgkJCQkJCXRvbC5sID0gYXJbIDMgXTsKCQkJCQl9CgkJCQkJYnJlYWs7CgoJCQkJZGVmYXVsdDoKCQkJCQlicmVhazsKCQkJfQoJCX0KCgkJdGhpcy5fdG9sZXJhbmNlID0gdG9sOwoJCXJldHVybiB0aGlzOwoJfSwKCglfY2xhbXBQb3B1cFdpZHRoOiBmdW5jdGlvbiggaW5mb09ubHkgKSB7CgkJdmFyIG1lbnVTaXplLAoJCQl3aW5kb3dDb29yZGluYXRlcyA9IGdldFdpbmRvd0Nvb3JkaW5hdGVzKCB0aGlzLndpbmRvdyApLAoJCQkvLyByZWN0YW5nbGUgd2l0aGluIHdoaWNoIHRoZSBwb3B1cCBtdXN0IGZpdAoJCQlyZWN0YW5nbGUgPSB7CgkJCQl4OiB0aGlzLl90b2xlcmFuY2UubCwKCQkJCXk6IHdpbmRvd0Nvb3JkaW5hdGVzLnkgKyB0aGlzLl90b2xlcmFuY2UudCwKCQkJCWN4OiB3aW5kb3dDb29yZGluYXRlcy5jeCAtIHRoaXMuX3RvbGVyYW5jZS5sIC0gdGhpcy5fdG9sZXJhbmNlLnIsCgkJCQljeTogd2luZG93Q29vcmRpbmF0ZXMuY3kgLSB0aGlzLl90b2xlcmFuY2UudCAtIHRoaXMuX3RvbGVyYW5jZS5iCgkJCX07CgoJCWlmICggIWluZm9Pbmx5ICkgewoJCQkvLyBDbGFtcCB0aGUgd2lkdGggb2YgdGhlIG1lbnUgYmVmb3JlIGdyYWJiaW5nIGl0cyBzaXplCgkJCXRoaXMuX3VpLmNvbnRhaW5lci5jc3MoICJtYXgtd2lkdGgiLCByZWN0YW5nbGUuY3ggKTsKCQl9CgoJCW1lbnVTaXplID0gewoJCQljeDogdGhpcy5fdWkuY29udGFpbmVyLm91dGVyV2lkdGgoIHRydWUgKSwKCQkJY3k6IHRoaXMuX3VpLmNvbnRhaW5lci5vdXRlckhlaWdodCggdHJ1ZSApCgkJfTsKCgkJcmV0dXJuIHsgcmM6IHJlY3RhbmdsZSwgbWVudVNpemU6IG1lbnVTaXplIH07Cgl9LAoKCV9jYWxjdWxhdGVGaW5hbExvY2F0aW9uOiBmdW5jdGlvbiggZGVzaXJlZCwgY2xhbXBJbmZvICkgewoJCXZhciByZXR1cm5WYWx1ZSwKCQkJcmVjdGFuZ2xlID0gY2xhbXBJbmZvLnJjLAoJCQltZW51U2l6ZSA9IGNsYW1wSW5mby5tZW51U2l6ZTsKCgkJLy8gQ2VudGVyIHRoZSBtZW51IG92ZXIgdGhlIGRlc2lyZWQgY29vcmRpbmF0ZXMsIHdoaWxlIG5vdCBnb2luZyBvdXRzaWRlCgkJLy8gdGhlIHdpbmRvdyB0b2xlcmFuY2VzLiBUaGlzIHdpbGwgY2VudGVyIHdydC4gdGhlIHdpbmRvdyBpZiB0aGUgcG9wdXAgaXMKCQkvLyB0b28gbGFyZ2UuCgkJcmV0dXJuVmFsdWUgPSB7CgkJCWxlZnQ6IGZpdFNlZ21lbnRJbnNpZGVTZWdtZW50KCByZWN0YW5nbGUuY3gsIG1lbnVTaXplLmN4LCByZWN0YW5nbGUueCwgZGVzaXJlZC54ICksCgkJCXRvcDogZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHJlY3RhbmdsZS5jeSwgbWVudVNpemUuY3ksIHJlY3RhbmdsZS55LCBkZXNpcmVkLnkgKQoJCX07CgoJCS8vIE1ha2Ugc3VyZSB0aGUgdG9wIG9mIHRoZSBtZW51IGlzIHZpc2libGUKCQlyZXR1cm5WYWx1ZS50b3AgPSBNYXRoLm1heCggMCwgcmV0dXJuVmFsdWUudG9wICk7CgoJCS8vIElmIHRoZSBoZWlnaHQgb2YgdGhlIG1lbnUgaXMgc21hbGxlciB0aGFuIHRoZSBoZWlnaHQgb2YgdGhlIGRvY3VtZW50CgkJLy8gYWxpZ24gdGhlIGJvdHRvbSB3aXRoIHRoZSBib3R0b20gb2YgdGhlIGRvY3VtZW50CgoJCXJldHVyblZhbHVlLnRvcCAtPSBNYXRoLm1pbiggcmV0dXJuVmFsdWUudG9wLAoJCQlNYXRoLm1heCggMCwgcmV0dXJuVmFsdWUudG9wICsgbWVudVNpemUuY3kgLSB0aGlzLmRvY3VtZW50LmhlaWdodCgpICkgKTsKCgkJcmV0dXJuIHJldHVyblZhbHVlOwoJfSwKCgkvLyBUcnkgYW5kIGNlbnRlciB0aGUgb3ZlcmxheSBvdmVyIHRoZSBnaXZlbiBjb29yZGluYXRlcwoJX3BsYWNlbWVudENvb3JkczogZnVuY3Rpb24oIGRlc2lyZWQgKSB7CgkJcmV0dXJuIHRoaXMuX2NhbGN1bGF0ZUZpbmFsTG9jYXRpb24oIGRlc2lyZWQsIHRoaXMuX2NsYW1wUG9wdXBXaWR0aCgpICk7Cgl9LAoKCV9jcmVhdGVQcmVyZXF1aXNpdGVzOiBmdW5jdGlvbiggc2NyZWVuUHJlcmVxdWlzaXRlLCBjb250YWluZXJQcmVyZXF1aXNpdGUsIHdoZW5Eb25lICkgewoJCXZhciBwcmVyZXF1aXNpdGVzLAoJCQlzZWxmID0gdGhpczsKCgkJLy8gSXQgaXMgaW1wb3J0YW50IHRvIG1haW50YWluIGJvdGggdGhlIGxvY2FsIHZhcmlhYmxlIHByZXJlcXVpc2l0ZXMgYW5kCgkJLy8gc2VsZi5fcHJlcmVxdWlzaXRlcy4gVGhlIGxvY2FsIHZhcmlhYmxlIHJlbWFpbnMgaW4gdGhlIGNsb3N1cmUgb2YgdGhlCgkJLy8gZnVuY3Rpb25zIHdoaWNoIGNhbGwgdGhlIGNhbGxiYWNrcyBwYXNzZWQgaW4uIFRoZSBjb21wYXJpc29uIGJldHdlZW4gdGhlCgkJLy8gbG9jYWwgdmFyaWFibGUgYW5kIHNlbGYuX3ByZXJlcXVpc2l0ZXMgaXMgbmVjZXNzYXJ5LCBiZWNhdXNlIG9uY2UgYQoJCS8vIGZ1bmN0aW9uIGhhcyBiZWVuIHBhc3NlZCB0byAuYW5pbWF0aW9uQ29tcGxldGUoKSBpdCB3aWxsIGJlIGNhbGxlZCBuZXh0CgkJLy8gdGltZSBhbiBhbmltYXRpb24gY29tcGxldGVzLCBldmVuIGlmIHRoYXQncyBub3QgdGhlIGFuaW1hdGlvbiB3aG9zZSBlbmQKCQkvLyB0aGUgZnVuY3Rpb24gd2FzIHN1cHBvc2VkIHRvIGNhdGNoIChmb3IgZXhhbXBsZSwgaWYgYW4gYWJvcnQgaGFwcGVucwoJCS8vIGR1cmluZyB0aGUgb3BlbmluZyBhbmltYXRpb24sIHRoZSAuYW5pbWF0aW9uQ29tcGxldGUgaGFuZGxlciBpcyBub3QKCQkvLyBjYWxsZWQgZm9yIHRoYXQgYW5pbWF0aW9uIGFueW1vcmUsIGJ1dCB0aGUgaGFuZGxlciByZW1haW5zIGF0dGFjaGVkLCBzbwoJCS8vIGl0IGlzIGNhbGxlZCB0aGUgbmV4dCB0aW1lIHRoZSBwb3B1cCBpcyBvcGVuZWQgLSBtYWtpbmcgaXQgc3RhbGUuCgkJLy8gQ29tcGFyaW5nIHRoZSBsb2NhbCB2YXJpYWJsZSBwcmVyZXF1aXNpdGVzIHRvIHRoZSB3aWRnZXQtbGV2ZWwgdmFyaWFibGUKCQkvLyBzZWxmLl9wcmVyZXF1aXNpdGVzIGVuc3VyZXMgdGhhdCBjYWxsYmFja3MgdHJpZ2dlcmVkIGJ5IGEgc3RhbGUKCQkvLyAuYW5pbWF0aW9uQ29tcGxldGUgd2lsbCBiZSBpZ25vcmVkLgoKCQlwcmVyZXF1aXNpdGVzID0gewoJCQlzY3JlZW46ICQuRGVmZXJyZWQoKSwKCQkJY29udGFpbmVyOiAkLkRlZmVycmVkKCkKCQl9OwoKCQlwcmVyZXF1aXNpdGVzLnNjcmVlbi50aGVuKCBmdW5jdGlvbigpIHsKCQkJaWYgKCBwcmVyZXF1aXNpdGVzID09PSBzZWxmLl9wcmVyZXF1aXNpdGVzICkgewoJCQkJc2NyZWVuUHJlcmVxdWlzaXRlKCk7CgkJCX0KCQl9KTsKCgkJcHJlcmVxdWlzaXRlcy5jb250YWluZXIudGhlbiggZnVuY3Rpb24oKSB7CgkJCWlmICggcHJlcmVxdWlzaXRlcyA9PT0gc2VsZi5fcHJlcmVxdWlzaXRlcyApIHsKCQkJCWNvbnRhaW5lclByZXJlcXVpc2l0ZSgpOwoJCQl9CgkJfSk7CgoJCSQud2hlbiggcHJlcmVxdWlzaXRlcy5zY3JlZW4sIHByZXJlcXVpc2l0ZXMuY29udGFpbmVyICkuZG9uZSggZnVuY3Rpb24oKSB7CgkJCWlmICggcHJlcmVxdWlzaXRlcyA9PT0gc2VsZi5fcHJlcmVxdWlzaXRlcyApIHsKCQkJCXNlbGYuX3ByZXJlcXVpc2l0ZXMgPSBudWxsOwoJCQkJd2hlbkRvbmUoKTsKCQkJfQoJCX0pOwoKCQlzZWxmLl9wcmVyZXF1aXNpdGVzID0gcHJlcmVxdWlzaXRlczsKCX0sCgoJX2FuaW1hdGU6IGZ1bmN0aW9uKCBhcmdzICkgewoJCS8vIE5PVEUgYmVmb3JlIHJlbW92aW5nIHRoZSBkZWZhdWx0IGFuaW1hdGlvbiBvZiB0aGUgc2NyZWVuCgkJLy8gICAgICB0aGlzIGhhZCBhbiBhbmltYXRlIGNhbGxiYWNrIHRoYXQgd291bGQgcmVzb2x2ZSB0aGUgZGVmZXJyZWQKCQkvLyAgICAgIG5vdyB0aGUgZGVmZXJyZWQgaXMgcmVzb2x2ZWQgaW1tZWRpYXRlbHkKCQkvLyBUT0RPIHJlbW92ZSB0aGUgZGVwZW5kZW5jeSBvbiB0aGUgc2NyZWVuIGRlZmVycmVkCgkJdGhpcy5fdWkuc2NyZWVuCgkJCS5yZW1vdmVDbGFzcyggYXJncy5jbGFzc1RvUmVtb3ZlICkKCQkJLmFkZENsYXNzKCBhcmdzLnNjcmVlbkNsYXNzVG9BZGQgKTsKCgkJYXJncy5wcmVyZXF1aXNpdGVzLnNjcmVlbi5yZXNvbHZlKCk7CgoJCWlmICggYXJncy50cmFuc2l0aW9uICYmIGFyZ3MudHJhbnNpdGlvbiAhPT0gIm5vbmUiICkgewoJCQlpZiAoIGFyZ3MuYXBwbHlUcmFuc2l0aW9uICkgewoJCQkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCBhcmdzLnRyYW5zaXRpb24gKTsKCQkJfQoJCQlpZiAoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiApIHsKCQkJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkJCS5hbmltYXRpb25Db21wbGV0ZSggJC5wcm94eSggYXJncy5wcmVyZXF1aXNpdGVzLmNvbnRhaW5lciwgInJlc29sdmUiICkgKQoJCQkJCS5hZGRDbGFzcyggYXJncy5jb250YWluZXJDbGFzc1RvQWRkICkKCQkJCQkucmVtb3ZlQ2xhc3MoIGFyZ3MuY2xhc3NUb1JlbW92ZSApOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggYXJncy5jbGFzc1RvUmVtb3ZlICk7CgkJYXJncy5wcmVyZXF1aXNpdGVzLmNvbnRhaW5lci5yZXNvbHZlKCk7Cgl9LAoKCS8vIFRoZSBkZXNpcmVkIGNvb3JkaW5hdGVzIHBhc3NlZCBpbiB3aWxsIGJlIHJldHVybmVkIHVudG91Y2hlZCBpZiBubyByZWZlcmVuY2UgZWxlbWVudCBjYW4gYmUgaWRlbnRpZmllZCB2aWEKCS8vIGRlc2lyZWRQb3NpdGlvbi5wb3NpdGlvblRvLiBOZXZlcnRoZWxlc3MsIHRoaXMgZnVuY3Rpb24gZW5zdXJlcyB0aGF0IGl0cyByZXR1cm4gdmFsdWUgYWx3YXlzIGNvbnRhaW5zIHZhbGlkCgkvLyB4IGFuZCB5IGNvb3JkaW5hdGVzIGJ5IHNwZWNpZnlpbmcgdGhlIGNlbnRlciBtaWRkbGUgb2YgdGhlIHdpbmRvdyBpZiB0aGUgY29vcmRpbmF0ZXMgYXJlIGFic2VudC4KCS8vIG9wdGlvbnM6IHsgeDogY29vcmRpbmF0ZSwgeTogY29vcmRpbmF0ZSwgcG9zaXRpb25Ubzogc3RyaW5nOiAib3JpZ2luIiwgIndpbmRvdyIsIG9yIGpRdWVyeSBzZWxlY3RvcgoJX2Rlc2lyZWRDb29yZHM6IGZ1bmN0aW9uKCBvcGVuT3B0aW9ucyApIHsKCQl2YXIgb2Zmc2V0LAoJCQlkc3QgPSBudWxsLAoJCQl3aW5kb3dDb29yZGluYXRlcyA9IGdldFdpbmRvd0Nvb3JkaW5hdGVzKCB0aGlzLndpbmRvdyApLAoJCQl4ID0gb3Blbk9wdGlvbnMueCwKCQkJeSA9IG9wZW5PcHRpb25zLnksCgkJCXBUbyA9IG9wZW5PcHRpb25zLnBvc2l0aW9uVG87CgoJCS8vIEVzdGFibGlzaCB3aGljaCBlbGVtZW50IHdpbGwgc2VydmUgYXMgdGhlIHJlZmVyZW5jZQoJCWlmICggcFRvICYmIHBUbyAhPT0gIm9yaWdpbiIgKSB7CgkJCWlmICggcFRvID09PSAid2luZG93IiApIHsKCQkJCXggPSB3aW5kb3dDb29yZGluYXRlcy5jeCAvIDIgKyB3aW5kb3dDb29yZGluYXRlcy54OwoJCQkJeSA9IHdpbmRvd0Nvb3JkaW5hdGVzLmN5IC8gMiArIHdpbmRvd0Nvb3JkaW5hdGVzLnk7CgkJCX0gZWxzZSB7CgkJCQl0cnkgewoJCQkJCWRzdCA9ICQoIHBUbyApOwoJCQkJfSBjYXRjaCggZXJyICkgewoJCQkJCWRzdCA9IG51bGw7CgkJCQl9CgkJCQlpZiAoIGRzdCApIHsKCQkJCQlkc3QuZmlsdGVyKCAiOnZpc2libGUiICk7CgkJCQkJaWYgKCBkc3QubGVuZ3RoID09PSAwICkgewoJCQkJCQlkc3QgPSBudWxsOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJLy8gSWYgYW4gZWxlbWVudCB3YXMgZm91bmQsIGNlbnRlciBvdmVyIGl0CgkJaWYgKCBkc3QgKSB7CgkJCW9mZnNldCA9IGRzdC5vZmZzZXQoKTsKCQkJeCA9IG9mZnNldC5sZWZ0ICsgZHN0Lm91dGVyV2lkdGgoKSAvIDI7CgkJCXkgPSBvZmZzZXQudG9wICsgZHN0Lm91dGVySGVpZ2h0KCkgLyAyOwoJCX0KCgkJLy8gTWFrZSBzdXJlIHggYW5kIHkgYXJlIHZhbGlkIG51bWJlcnMgLSBjZW50ZXIgb3ZlciB0aGUgd2luZG93CgkJaWYgKCAkLnR5cGUoIHggKSAhPT0gIm51bWJlciIgfHwgaXNOYU4oIHggKSApIHsKCQkJeCA9IHdpbmRvd0Nvb3JkaW5hdGVzLmN4IC8gMiArIHdpbmRvd0Nvb3JkaW5hdGVzLng7CgkJfQoJCWlmICggJC50eXBlKCB5ICkgIT09ICJudW1iZXIiIHx8IGlzTmFOKCB5ICkgKSB7CgkJCXkgPSB3aW5kb3dDb29yZGluYXRlcy5jeSAvIDIgKyB3aW5kb3dDb29yZGluYXRlcy55OwoJCX0KCgkJcmV0dXJuIHsgeDogeCwgeTogeSB9OwoJfSwKCglfcmVwb3NpdGlvbjogZnVuY3Rpb24oIG9wZW5PcHRpb25zICkgewoJCS8vIFdlIG9ubHkgY2FyZSBhYm91dCBwb3NpdGlvbi1yZWxhdGVkIHBhcmFtZXRlcnMgZm9yIHJlcG9zaXRpb25pbmcKCQlvcGVuT3B0aW9ucyA9IHsKCQkJeDogb3Blbk9wdGlvbnMueCwKCQkJeTogb3Blbk9wdGlvbnMueSwKCQkJcG9zaXRpb25Ubzogb3Blbk9wdGlvbnMucG9zaXRpb25UbwoJCX07CgkJdGhpcy5fdHJpZ2dlciggImJlZm9yZXBvc2l0aW9uIiwgdW5kZWZpbmVkLCBvcGVuT3B0aW9ucyApOwoJCXRoaXMuX3VpLmNvbnRhaW5lci5vZmZzZXQoIHRoaXMuX3BsYWNlbWVudENvb3JkcyggdGhpcy5fZGVzaXJlZENvb3Jkcyggb3Blbk9wdGlvbnMgKSApICk7Cgl9LAoKCXJlcG9zaXRpb246IGZ1bmN0aW9uKCBvcGVuT3B0aW9ucyApIHsKCQlpZiAoIHRoaXMuX2lzT3BlbiApIHsKCQkJdGhpcy5fcmVwb3NpdGlvbiggb3Blbk9wdGlvbnMgKTsKCQl9Cgl9LAoKCV9vcGVuUHJlcmVxdWlzaXRlc0NvbXBsZXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgaWQgPSB0aGlzLmVsZW1lbnQuYXR0ciggImlkIiApOwoKCQl0aGlzLl91aS5jb250YWluZXIuYWRkQ2xhc3MoICJ1aS1wb3B1cC1hY3RpdmUiICk7CgkJdGhpcy5faXNPcGVuID0gdHJ1ZTsKCQl0aGlzLl9yZXNpemVTY3JlZW4oKTsKCQl0aGlzLl91aS5jb250YWluZXIuYXR0ciggInRhYmluZGV4IiwgIjAiICkuZm9jdXMoKTsKCQl0aGlzLl9pZ25vcmVSZXNpemVFdmVudHMoKTsKCQlpZiAoIGlkICkgewoJCQl0aGlzLmRvY3VtZW50LmZpbmQoICJbYXJpYS1oYXNwb3B1cD0ndHJ1ZSddW2FyaWEtb3ducz0nIiArICBpZCArICInXSIgKS5hdHRyKCAiYXJpYS1leHBhbmRlZCIsIHRydWUgKTsKCQl9CgkJdGhpcy5fdHJpZ2dlciggImFmdGVyb3BlbiIgKTsKCX0sCgoJX29wZW46IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBvcGVuT3B0aW9ucyA9ICQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zLCBvcHRpb25zICksCgkJCS8vIFRPRE8gbW92ZSBibGFja2xpc3QgdG8gcHJpdmF0ZSBtZXRob2QKCQkJYW5kcm9pZEJsYWNrbGlzdCA9ICggZnVuY3Rpb24oKSB7CgkJCQl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCQkJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJCQkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XC5dKykvICksCgkJCQkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQkJCQlhbmRyb2lkbWF0Y2ggPSB1YS5tYXRjaCggL0FuZHJvaWQgKFxkKyg/OlwuXGQrKSkvICksCgkJCQkJYW5kdmVyc2lvbiA9ICEhYW5kcm9pZG1hdGNoICYmIGFuZHJvaWRtYXRjaFsgMSBdLAoJCQkJCWNocm9tZW1hdGNoID0gdWEuaW5kZXhPZiggIkNocm9tZSIgKSA+IC0xOwoKCQkJCS8vIFBsYXRmb3JtIGlzIEFuZHJvaWQsIFdlYktpdCB2ZXJzaW9uIGlzIGdyZWF0ZXIgdGhhbiA1MzQuMTMgKCBBbmRyb2lkIDMuMi4xICkgYW5kIG5vdCBDaHJvbWUuCgkJCQlpZiAoIGFuZHJvaWRtYXRjaCAhPT0gbnVsbCAmJiBhbmR2ZXJzaW9uID09PSAiNC4wIiAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uID4gNTM0LjEzICYmICFjaHJvbWVtYXRjaCApIHsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0KCQkJCXJldHVybiBmYWxzZTsKCQkJfSgpKTsKCgkJLy8gQ291bnQgZG93biB0byB0cmlnZ2VyaW5nICJwb3B1cGFmdGVyb3BlbiIgLSB3ZSBoYXZlIHR3byBwcmVyZXF1aXNpdGVzOgoJCS8vIDEuIFRoZSBwb3B1cCB3aW5kb3cgYW5pbWF0aW9uIGNvbXBsZXRlcyAoY29udGFpbmVyKCkpCgkJLy8gMi4gVGhlIHNjcmVlbiBvcGFjaXR5IGFuaW1hdGlvbiBjb21wbGV0ZXMgKHNjcmVlbigpKQoJCXRoaXMuX2NyZWF0ZVByZXJlcXVpc2l0ZXMoCgkJCSQubm9vcCwKCQkJJC5ub29wLAoJCQkkLnByb3h5KCB0aGlzLCAiX29wZW5QcmVyZXF1aXNpdGVzQ29tcGxldGUiICkgKTsKCgkJdGhpcy5fY3VycmVudFRyYW5zaXRpb24gPSBvcGVuT3B0aW9ucy50cmFuc2l0aW9uOwoJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggb3Blbk9wdGlvbnMudHJhbnNpdGlvbiApOwoKCQl0aGlzLl91aS5zY3JlZW4ucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLXRydW5jYXRlIiApOwoKCQkvLyBHaXZlIGFwcGxpY2F0aW9ucyBhIGNoYW5jZSB0byBtb2RpZnkgdGhlIGNvbnRlbnRzIG9mIHRoZSBjb250YWluZXIgYmVmb3JlIGl0IGFwcGVhcnMKCQl0aGlzLl9yZXBvc2l0aW9uKCBvcGVuT3B0aW9ucyApOwoKCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICk7CgoJCWlmICggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSAmJiBhbmRyb2lkQmxhY2tsaXN0ICkgewoJCQkvKiBUT0RPOiBUaGUgbmF0aXZlIGJyb3dzZXIgb24gQW5kcm9pZCA0LjAuWCAoIkljZSBDcmVhbSBTYW5kd2ljaCIpIHN1ZmZlcnMgZnJvbSBhbiBpc3N1ZSB3aGVyZSB0aGUgcG9wdXAgb3ZlcmxheSBhcHBlYXJzIHRvIGJlIHotaW5kZXhlZCBhYm92ZSB0aGUgcG9wdXAgaXRzZWxmIHdoZW4gY2VydGFpbiBvdGhlciBzdHlsZXMgZXhpc3Qgb24gdGhlIHNhbWUgcGFnZSAtLSBuYW1lbHksIGFueSBlbGVtZW50IHNldCB0byBgcG9zaXRpb246IGZpeGVkYCBhbmQgY2VydGFpbiB0eXBlcyBvZiBpbnB1dC4gVGhlc2UgaXNzdWVzIGFyZSByZW1pbmlzY2VudCBvZiBwcmV2aW91c2x5IHVuY292ZXJlZCBidWdzIGluIG9sZGVyIHZlcnNpb25zIG9mIEFuZHJvaWQncyBuYXRpdmUgYnJvd3NlcjogaHR0cHM6Ly9naXRodWIuY29tL3Njb3R0amVobC9EZXZpY2UtQnVncy9pc3N1ZXMvMwoJCQlUaGlzIGZpeCBjbG9zZXMgdGhlIGZvbGxvd2luZyBidWdzICggSSB1c2UgImNsb3NlcyIgd2l0aCByZWx1Y3RhbmNlLCBhbmQgc3RyZXNzIHRoYXQgdGhpcyBpc3N1ZSBzaG91bGQgYmUgcmV2aXNpdGVkIGFzIHNvb24gYXMgcG9zc2libGUgKToKCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODE2CgkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDg0NAoJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4NzQKCQkJKi8KCgkJCS8vIFRPRE8gc29ydCBvdXQgd2h5IHRoaXMuX3BhZ2UgaXNuJ3Qgd29ya2luZwoJCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLmFkZENsYXNzKCAidWktcG9wdXAtb3BlbiIgKTsKCQl9CgkJdGhpcy5fYW5pbWF0ZSh7CgkJCWFkZGl0aW9uYWxDb25kaXRpb246IHRydWUsCgkJCXRyYW5zaXRpb246IG9wZW5PcHRpb25zLnRyYW5zaXRpb24sCgkJCWNsYXNzVG9SZW1vdmU6ICIiLAoJCQlzY3JlZW5DbGFzc1RvQWRkOiAiaW4iLAoJCQljb250YWluZXJDbGFzc1RvQWRkOiAiaW4iLAoJCQlhcHBseVRyYW5zaXRpb246IGZhbHNlLAoJCQlwcmVyZXF1aXNpdGVzOiB0aGlzLl9wcmVyZXF1aXNpdGVzCgkJfSk7Cgl9LAoKCV9jbG9zZVByZXJlcXVpc2l0ZVNjcmVlbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fdWkuc2NyZWVuCgkJCS5yZW1vdmVDbGFzcyggIm91dCIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJfSwKCglfY2xvc2VQcmVyZXF1aXNpdGVDb250YWluZXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkucmVtb3ZlQ2xhc3MoICJyZXZlcnNlIG91dCIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4gdWktcG9wdXAtdHJ1bmNhdGUiICkKCQkJLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCX0sCgoJX2Nsb3NlUHJlcmVxdWlzaXRlc0RvbmU6IGZ1bmN0aW9uKCkgewoJCXZhciBjb250YWluZXIgPSB0aGlzLl91aS5jb250YWluZXIsCgkJCWlkID0gdGhpcy5lbGVtZW50LmF0dHIoICJpZCIgKTsKCgkJY29udGFpbmVyLnJlbW92ZUF0dHIoICJ0YWJpbmRleCIgKTsKCgkJLy8gcmVtb3ZlIHRoZSBnbG9iYWwgbXV0ZXggZm9yIHBvcHVwcwoJCSQubW9iaWxlLnBvcHVwLmFjdGl2ZSA9IHVuZGVmaW5lZDsKCgkJLy8gQmx1ciBlbGVtZW50cyBpbnNpZGUgdGhlIGNvbnRhaW5lciwgaW5jbHVkaW5nIHRoZSBjb250YWluZXIKCQkkKCAiOmZvY3VzIiwgY29udGFpbmVyWyAwIF0gKS5hZGQoIGNvbnRhaW5lclsgMCBdICkuYmx1cigpOwoKCQlpZiAoIGlkICkgewoJCQl0aGlzLmRvY3VtZW50LmZpbmQoICJbYXJpYS1oYXNwb3B1cD0ndHJ1ZSddW2FyaWEtb3ducz0nIiArICBpZCArICInXSIgKS5hdHRyKCAiYXJpYS1leHBhbmRlZCIsIGZhbHNlICk7CgkJfQoKCQkvLyBhbGVydCB1c2VycyB0aGF0IHRoZSBwb3B1cCBpcyBjbG9zZWQKCQl0aGlzLl90cmlnZ2VyKCAiYWZ0ZXJjbG9zZSIgKTsKCX0sCgoJX2Nsb3NlOiBmdW5jdGlvbiggaW1tZWRpYXRlICkgewoJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLWFjdGl2ZSIgKTsKCQl0aGlzLl9wYWdlLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtb3BlbiIgKTsKCgkJdGhpcy5faXNPcGVuID0gZmFsc2U7CgoJCS8vIENvdW50IGRvd24gdG8gdHJpZ2dlcmluZyAicG9wdXBhZnRlcmNsb3NlIiAtIHdlIGhhdmUgdHdvIHByZXJlcXVpc2l0ZXM6CgkJLy8gMS4gVGhlIHBvcHVwIHdpbmRvdyByZXZlcnNlIGFuaW1hdGlvbiBjb21wbGV0ZXMgKGNvbnRhaW5lcigpKQoJCS8vIDIuIFRoZSBzY3JlZW4gb3BhY2l0eSBhbmltYXRpb24gY29tcGxldGVzIChzY3JlZW4oKSkKCQl0aGlzLl9jcmVhdGVQcmVyZXF1aXNpdGVzKAoJCQkkLnByb3h5KCB0aGlzLCAiX2Nsb3NlUHJlcmVxdWlzaXRlU2NyZWVuIiApLAoJCQkkLnByb3h5KCB0aGlzLCAiX2Nsb3NlUHJlcmVxdWlzaXRlQ29udGFpbmVyIiApLAoJCQkkLnByb3h5KCB0aGlzLCAiX2Nsb3NlUHJlcmVxdWlzaXRlc0RvbmUiICkgKTsKCgkJdGhpcy5fYW5pbWF0ZSggewoJCQlhZGRpdGlvbmFsQ29uZGl0aW9uOiB0aGlzLl91aS5zY3JlZW4uaGFzQ2xhc3MoICJpbiIgKSwKCQkJdHJhbnNpdGlvbjogKCBpbW1lZGlhdGUgPyAibm9uZSIgOiAoIHRoaXMuX2N1cnJlbnRUcmFuc2l0aW9uICkgKSwKCQkJY2xhc3NUb1JlbW92ZTogImluIiwKCQkJc2NyZWVuQ2xhc3NUb0FkZDogIm91dCIsCgkJCWNvbnRhaW5lckNsYXNzVG9BZGQ6ICJyZXZlcnNlIG91dCIsCgkJCWFwcGx5VHJhbnNpdGlvbjogdHJ1ZSwKCQkJcHJlcmVxdWlzaXRlczogdGhpcy5fcHJlcmVxdWlzaXRlcwoJCX0pOwoJfSwKCglfdW5lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gUHV0IHRoZSBlbGVtZW50IGJhY2sgdG8gd2hlcmUgdGhlIHBsYWNlaG9sZGVyIHdhcyBhbmQgcmVtb3ZlIHRoZSAidWktcG9wdXAiIGNsYXNzCgkJdGhpcy5fc2V0T3B0aW9ucyggeyB0aGVtZTogJC5tb2JpbGUucG9wdXAucHJvdG90eXBlLm9wdGlvbnMudGhlbWUgfSApOwoJCXRoaXMuZWxlbWVudAoJCQkvLyBDYW5ub3QgZGlyZWN0bHkgaW5zZXJ0QWZ0ZXIoKSAtIHdlIG5lZWQgdG8gZGV0YWNoKCkgZmlyc3QsIGJlY2F1c2UKCQkJLy8gaW5zZXJ0QWZ0ZXIoKSB3aWxsIGRvIG5vdGhpbmcgaWYgdGhlIHBheWxvYWQgZGl2IHdhcyBub3QgYXR0YWNoZWQKCQkJLy8gdG8gdGhlIERPTSBhdCB0aGUgdGltZSB0aGUgd2lkZ2V0IHdhcyBjcmVhdGVkLCBhbmQgc28gdGhlIHBheWxvYWQKCQkJLy8gd2lsbCByZW1haW4gaW5zaWRlIHRoZSBjb250YWluZXIgZXZlbiBhZnRlciB3ZSBjYWxsIGluc2VydEFmdGVyKCkuCgkJCS8vIElmIHRoYXQgaGFwcGVucyBhbmQgd2UgcmVtb3ZlIHRoZSBjb250YWluZXIgYSBmZXcgbGluZXMgYmVsb3csIHdlCgkJCS8vIHdpbGwgY2F1c2UgYW4gaW5maW5pdGUgcmVjdXJzaW9uIC0gIzUyNDQKCQkJLmRldGFjaCgpCgkJCS5pbnNlcnRBZnRlciggdGhpcy5fdWkucGxhY2Vob2xkZXIgKQoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cCB1aS1vdmVybGF5LXNoYWRvdyB1aS1jb3JuZXItYWxsIHVpLWJvZHktaW5oZXJpdCIgKTsKCQl0aGlzLl91aS5zY3JlZW4ucmVtb3ZlKCk7CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZSgpOwoJCXRoaXMuX3VpLnBsYWNlaG9sZGVyLnJlbW92ZSgpOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJaWYgKCAkLm1vYmlsZS5wb3B1cC5hY3RpdmUgPT09IHRoaXMgKSB7CgkJCXRoaXMuZWxlbWVudC5vbmUoICJwb3B1cGFmdGVyY2xvc2UiLCAkLnByb3h5KCB0aGlzLCAiX3VuZW5oYW5jZSIgKSApOwoJCQl0aGlzLmNsb3NlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5fdW5lbmhhbmNlKCk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJX2Nsb3NlUG9wdXA6IGZ1bmN0aW9uKCB0aGVFdmVudCwgZGF0YSApIHsKCQl2YXIgcGFyc2VkRHN0LCB0b1VybCwKCQkJY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWltbWVkaWF0ZSA9IGZhbHNlOwoKCQlpZiAoICggdGhlRXZlbnQgJiYgdGhlRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB8fCAkLm1vYmlsZS5wb3B1cC5hY3RpdmUgIT09IHRoaXMgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIHJlc3RvcmUgbG9jYXRpb24gb24gc2NyZWVuCgkJd2luZG93LnNjcm9sbFRvKCAwLCB0aGlzLl9zY3JvbGxUb3AgKTsKCgkJaWYgKCB0aGVFdmVudCAmJiB0aGVFdmVudC50eXBlID09PSAicGFnZWJlZm9yZWNoYW5nZSIgJiYgZGF0YSApIHsKCQkJLy8gRGV0ZXJtaW5lIHdoZXRoZXIgd2UgbmVlZCB0byByYXBpZC1jbG9zZSB0aGUgcG9wdXAsIG9yIHdoZXRoZXIgd2UgY2FuCgkJCS8vIHRha2UgdGhlIHRpbWUgdG8gcnVuIHRoZSBjbG9zaW5nIHRyYW5zaXRpb24KCQkJaWYgKCB0eXBlb2YgZGF0YS50b1BhZ2UgPT09ICJzdHJpbmciICkgewoJCQkJcGFyc2VkRHN0ID0gZGF0YS50b1BhZ2U7CgkJCX0gZWxzZSB7CgkJCQlwYXJzZWREc3QgPSBkYXRhLnRvUGFnZS5qcW1EYXRhKCAidXJsIiApOwoJCQl9CgkJCXBhcnNlZERzdCA9ICQubW9iaWxlLnBhdGgucGFyc2VVcmwoIHBhcnNlZERzdCApOwoJCQl0b1VybCA9IHBhcnNlZERzdC5wYXRobmFtZSArIHBhcnNlZERzdC5zZWFyY2ggKyBwYXJzZWREc3QuaGFzaDsKCgkJCWlmICggdGhpcy5fbXlVcmwgIT09ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCB0b1VybCApICkgewoJCQkJLy8gR29pbmcgdG8gYSBkaWZmZXJlbnQgcGFnZSAtIGNsb3NlIGltbWVkaWF0ZWx5CgkJCQlpbW1lZGlhdGUgPSB0cnVlOwoJCQl9IGVsc2UgewoJCQkJdGhlRXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCX0KCgkJLy8gcmVtb3ZlIG5hdiBiaW5kaW5ncwoJCXRoaXMud2luZG93Lm9mZiggY3VycmVudE9wdGlvbnMuY2xvc2VFdmVudHMgKTsKCQkvLyB1bmJpbmQgY2xpY2sgaGFuZGxlcnMgYWRkZWQgd2hlbiBoaXN0b3J5IGlzIGRpc2FibGVkCgkJdGhpcy5lbGVtZW50LnVuZGVsZWdhdGUoIGN1cnJlbnRPcHRpb25zLmNsb3NlTGlua1NlbGVjdG9yLCBjdXJyZW50T3B0aW9ucy5jbG9zZUxpbmtFdmVudHMgKTsKCgkJdGhpcy5fY2xvc2UoIGltbWVkaWF0ZSApOwoJfSwKCgkvLyBhbnkgbmF2aWdhdGlvbiBldmVudCBhZnRlciBhIHBvcHVwIGlzIG9wZW5lZCBzaG91bGQgY2xvc2UgdGhlIHBvcHVwCgkvLyBOT1RFIHRoZSBwYWdlYmVmb3JlY2hhbmdlIGlzIGJvdW5kIHRvIGNhdGNoIG5hdmlnYXRpb24gZXZlbnRzIHRoYXQgZG9uJ3QKCS8vICAgICAgYWx0ZXIgdGhlIHVybCAoZWcsIGRpYWxvZ3MgZnJvbSBwb3B1cHMpCglfYmluZENvbnRhaW5lckNsb3NlOiBmdW5jdGlvbigpIHsKCQl0aGlzLndpbmRvdwoJCQkub24oIHRoaXMub3B0aW9ucy5jbG9zZUV2ZW50cywgJC5wcm94eSggdGhpcywgIl9jbG9zZVBvcHVwIiApICk7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3VpLmNvbnRhaW5lcjsKCX0sCgoJLy8gVE9ETyBubyBjbGVhciBkZWxpbmlhdGlvbiBvZiB3aGF0IHNob3VsZCBiZSBoZXJlIGFuZAoJLy8gd2hhdCBzaG91bGQgYmUgaW4gX29wZW4uIFNlZW1zIHRvIGJlICJ2aXN1YWwiIHZzICJoaXN0b3J5IiBmb3Igbm93CglvcGVuOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgdXJsLCBoYXNoa2V5LCBhY3RpdmVQYWdlLCBjdXJyZW50SXNEaWFsb2csIGhhc0hhc2gsIHVybEhpc3RvcnksCgkJCXNlbGYgPSB0aGlzLAoJCQljdXJyZW50T3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCgkJLy8gbWFrZSBzdXJlIG9wZW4gaXMgaWRlbXBvdGVudAoJCWlmICggJC5tb2JpbGUucG9wdXAuYWN0aXZlIHx8IGN1cnJlbnRPcHRpb25zLmRpc2FibGVkICkgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCS8vIHNldCB0aGUgZ2xvYmFsIHBvcHVwIG11dGV4CgkJJC5tb2JpbGUucG9wdXAuYWN0aXZlID0gdGhpczsKCQl0aGlzLl9zY3JvbGxUb3AgPSB0aGlzLndpbmRvdy5zY3JvbGxUb3AoKTsKCgkJLy8gaWYgaGlzdG9yeSBhbHRlcmF0aW9uIGlzIGRpc2FibGVkIGNsb3NlIG9uIG5hdmlnYXRlIGV2ZW50cwoJCS8vIGFuZCBsZWF2ZSB0aGUgdXJsIGFzIGlzCgkJaWYgKCAhKCBjdXJyZW50T3B0aW9ucy5oaXN0b3J5ICkgKSB7CgkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJc2VsZi5fYmluZENvbnRhaW5lckNsb3NlKCk7CgoJCQkvLyBXaGVuIGhpc3RveSBpcyBkaXNhYmxlZCB3ZSBoYXZlIHRvIGdyYWIgdGhlIGRhdGEtcmVsCgkJCS8vIGJhY2sgbGluayBjbGlja3Mgc28gd2UgY2FuIGNsb3NlIHRoZSBwb3B1cCBpbnN0ZWFkIG9mCgkJCS8vIHJlbHlpbmcgb24gaGlzdG9yeSB0byBkbyBpdCBmb3IgdXMKCQkJc2VsZi5lbGVtZW50CgkJCQkuZGVsZWdhdGUoIGN1cnJlbnRPcHRpb25zLmNsb3NlTGlua1NlbGVjdG9yLCBjdXJyZW50T3B0aW9ucy5jbG9zZUxpbmtFdmVudHMsIGZ1bmN0aW9uKCB0aGVFdmVudCApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQkJdGhlRXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCX0pOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQkvLyBjYWNoZSBzb21lIHZhbHVlcyBmb3IgbWluL3JlYWRhYmlsaXR5CgkJdXJsSGlzdG9yeSA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnk7CgkJaGFzaGtleSA9ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXk7CgkJYWN0aXZlUGFnZSA9ICQubW9iaWxlLmFjdGl2ZVBhZ2U7CgkJY3VycmVudElzRGlhbG9nID0gKCBhY3RpdmVQYWdlID8gYWN0aXZlUGFnZS5oYXNDbGFzcyggInVpLWRpYWxvZyIgKSA6IGZhbHNlICk7CgkJdGhpcy5fbXlVcmwgPSB1cmwgPSB1cmxIaXN0b3J5LmdldEFjdGl2ZSgpLnVybDsKCQloYXNIYXNoID0gKCB1cmwuaW5kZXhPZiggaGFzaGtleSApID4gLTEgKSAmJiAhY3VycmVudElzRGlhbG9nICYmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA+IDAgKTsKCgkJaWYgKCBoYXNIYXNoICkgewoJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCS8vIGlmIHRoZSBjdXJyZW50IHVybCBoYXMgbm8gZGlhbG9nIGhhc2gga2V5IHByb2NlZWQgYXMgbm9ybWFsCgkJLy8gb3RoZXJ3aXNlLCBpZiB0aGUgcGFnZSBpcyBhIGRpYWxvZyBzaW1wbHkgdGFjayBvbiB0aGUgaGFzaCBrZXkKCQlpZiAoIHVybC5pbmRleE9mKCBoYXNoa2V5ICkgPT09IC0xICYmICFjdXJyZW50SXNEaWFsb2cgKSB7CgkJCXVybCA9IHVybCArICh1cmwuaW5kZXhPZiggIiMiICkgPiAtMSA/IGhhc2hrZXkgOiAiIyIgKyBoYXNoa2V5KTsKCQl9IGVsc2UgewoJCQl1cmwgPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoICsgaGFzaGtleTsKCQl9CgoJCS8vIFRhY2sgb24gYW4gZXh0cmEgaGFzaGtleSBpZiB0aGlzIGlzIHRoZSBmaXJzdCBwYWdlIGFuZCB3ZSd2ZSBqdXN0IHJlY29uc3RydWN0ZWQgdGhlIGluaXRpYWwgaGFzaAoJCWlmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCAmJiB1cmwgPT09IHVybEhpc3RvcnkuaW5pdGlhbERzdCApIHsKCQkJdXJsICs9IGhhc2hrZXk7CgkJfQoKCQkvLyBzd2FsbG93IHRoZSB0aGUgaW5pdGlhbCBuYXZpZ2F0aW9uIGV2ZW50LCBhbmQgYmluZCBmb3IgdGhlIG5leHQKCQl0aGlzLndpbmRvdy5vbmUoICJiZWZvcmVuYXZpZ2F0ZSIsIGZ1bmN0aW9uKCB0aGVFdmVudCApIHsKCQkJdGhlRXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJc2VsZi5fb3Blbiggb3B0aW9ucyApOwoJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCQl9KTsKCgkJdGhpcy51cmxBbHRlcmVkID0gdHJ1ZTsKCQkkLm1vYmlsZS5uYXZpZ2F0ZSggdXJsLCB7IHJvbGU6ICJkaWFsb2ciIH0gKTsKCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNsb3NlOiBmdW5jdGlvbigpIHsKCQkvLyBtYWtlIHN1cmUgY2xvc2UgaXMgaWRlbXBvdGVudAoJCWlmICggJC5tb2JpbGUucG9wdXAuYWN0aXZlICE9PSB0aGlzICkgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXRoaXMuX3Njcm9sbFRvcCA9IHRoaXMud2luZG93LnNjcm9sbFRvcCgpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5oaXN0b3J5ICYmIHRoaXMudXJsQWx0ZXJlZCApIHsKCQkJJC5tb2JpbGUuYmFjaygpOwoJCQl0aGlzLnVybEFsdGVyZWQgPSBmYWxzZTsKCQl9IGVsc2UgewoJCQkvLyBzaW11bGF0ZSB0aGUgbmF2IGJpbmRpbmdzIGhhdmluZyBmaXJlZAoJCQl0aGlzLl9jbG9zZVBvcHVwKCk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KfSk7CgovLyBUT0RPIHRoaXMgY2FuIGJlIG1vdmVkIGluc2lkZSB0aGUgd2lkZ2V0CiQubW9iaWxlLnBvcHVwLmhhbmRsZUxpbmsgPSBmdW5jdGlvbiggJGxpbmsgKSB7Cgl2YXIgb2Zmc2V0LAoJCXBhdGggPSAkLm1vYmlsZS5wYXRoLAoKCQkvLyBOT1RFIG1ha2Ugc3VyZSB0byBnZXQgb25seSB0aGUgaGFzaCBmcm9tIHRoZSBocmVmIGJlY2F1c2UgaWU3ICh3cDcpCgkJLy8gICAgICByZXR1cm5zIHRoZSBhYnNvbHV0ZSBocmVmIGluIHRoaXMgY2FzZSBydWluaW5nIHRoZSBlbGVtZW50IHNlbGVjdGlvbgoJCXBvcHVwID0gJCggcGF0aC5oYXNoVG9TZWxlY3RvciggcGF0aC5wYXJzZVVybCggJGxpbmsuYXR0ciggImhyZWYiICkgKS5oYXNoICkgKS5maXJzdCgpOwoKCWlmICggcG9wdXAubGVuZ3RoID4gMCAmJiBwb3B1cC5kYXRhKCAibW9iaWxlLXBvcHVwIiApICkgewoJCW9mZnNldCA9ICRsaW5rLm9mZnNldCgpOwoJCXBvcHVwLnBvcHVwKCAib3BlbiIsIHsKCQkJeDogb2Zmc2V0LmxlZnQgKyAkbGluay5vdXRlcldpZHRoKCkgLyAyLAoJCQl5OiBvZmZzZXQudG9wICsgJGxpbmsub3V0ZXJIZWlnaHQoKSAvIDIsCgkJCXRyYW5zaXRpb246ICRsaW5rLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQlwb3NpdGlvblRvOiAkbGluay5qcW1EYXRhKCAicG9zaXRpb24tdG8iICkKCQl9KTsKCX0KCgkvL3JlbW92ZSBhZnRlciBkZWxheQoJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJJGxpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7Cgl9LCAzMDAgKTsKfTsKCi8vIFRPRE8gbW92ZSBpbnNpZGUgX2NyZWF0ZQokLm1vYmlsZS5kb2N1bWVudC5vbiggInBhZ2ViZWZvcmVjaGFuZ2UiLCBmdW5jdGlvbiggdGhlRXZlbnQsIGRhdGEgKSB7CglpZiAoIGRhdGEub3B0aW9ucy5yb2xlID09PSAicG9wdXAiICkgewoJCSQubW9iaWxlLnBvcHVwLmhhbmRsZUxpbmsoIGRhdGEub3B0aW9ucy5saW5rICk7CgkJdGhlRXZlbnQucHJldmVudERlZmF1bHQoKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgovKgoqIGN1c3RvbSAic2VsZWN0bWVudSIgcGx1Z2luCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciB1bmZvY3VzYWJsZUl0ZW1TZWxlY3RvciA9ICIudWktZGlzYWJsZWQsLnVpLXN0YXRlLWRpc2FibGVkLC51aS1saS1kaXZpZGVyLC51aS1zY3JlZW4taGlkZGVuLDpqcW1EYXRhKHJvbGU9J3BsYWNlaG9sZGVyJykiLAoJZ29Ub0FkamFjZW50SXRlbSA9IGZ1bmN0aW9uKCBpdGVtLCB0YXJnZXQsIGRpcmVjdGlvbiApIHsKCQl2YXIgYWRqYWNlbnQgPSBpdGVtWyBkaXJlY3Rpb24gKyAiQWxsIiBdKCkKCQkJLm5vdCggdW5mb2N1c2FibGVJdGVtU2VsZWN0b3IgKQoJCQkuZmlyc3QoKTsKCgkJLy8gaWYgdGhlcmUncyBhIHByZXZpb3VzIG9wdGlvbiwgZm9jdXMgaXQKCQlpZiAoIGFkamFjZW50Lmxlbmd0aCApIHsKCQkJdGFyZ2V0CgkJCQkuYmx1cigpCgkJCQkuYXR0ciggInRhYmluZGV4IiwgIi0xIiApOwoKCQkJYWRqYWNlbnQuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCX0KCX07CgokLndpZGdldCggIm1vYmlsZS5zZWxlY3RtZW51IiwgJC5tb2JpbGUuc2VsZWN0bWVudSwgewoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7CgoJCS8vIEN1c3RvbSBzZWxlY3RzIGNhbm5vdCBleGlzdCBpbnNpZGUgcG9wdXBzLCBzbyByZXZlcnQgdGhlICJuYXRpdmVNZW51IgoJCS8vIG9wdGlvbiB0byB0cnVlIGlmIGEgcGFyZW50IGlzIGEgcG9wdXAKCQlvLm5hdGl2ZU1lbnUgPSBvLm5hdGl2ZU1lbnUgfHwgKCB0aGlzLmVsZW1lbnQucGFyZW50cyggIjpqcW1EYXRhKHJvbGU9J3BvcHVwJyksOm1vYmlsZS1wb3B1cCIgKS5sZW5ndGggPiAwICk7CgoJCXJldHVybiB0aGlzLl9zdXBlcigpOwoJfSwKCglfaGFuZGxlU2VsZWN0Rm9jdXM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5ibHVyKCk7CgkJdGhpcy5idXR0b24uZm9jdXMoKTsKCX0sCgoJX2hhbmRsZUtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl0aGlzLl9zdXBlciggZXZlbnQgKTsKCQl0aGlzLl9oYW5kbGVCdXR0b25WY2xpY2tLZXlkb3duKCBldmVudCApOwoJfSwKCglfaGFuZGxlQnV0dG9uVmNsaWNrS2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8IHRoaXMuaXNPcGVuICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoZXZlbnQudHlwZSA9PT0gInZjbGljayIgfHwKCQkJCWV2ZW50LmtleUNvZGUgJiYgKGV2ZW50LmtleUNvZGUgPT09ICQubW9iaWxlLmtleUNvZGUuRU5URVIgfHwgZXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5TUEFDRSkpIHsKCgkJCXRoaXMuX2RlY2lkZUZvcm1hdCgpOwoJCQlpZiAoIHRoaXMubWVudVR5cGUgPT09ICJvdmVybGF5IiApIHsKCQkJCXRoaXMuYnV0dG9uLmF0dHIoICJocmVmIiwgIiMiICsgdGhpcy5wb3B1cElkICkuYXR0ciggImRhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJyZWwiLCAicG9wdXAiICk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmJ1dHRvbi5hdHRyKCAiaHJlZiIsICIjIiArIHRoaXMuZGlhbG9nSWQgKS5hdHRyKCAiZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInJlbCIsICJkaWFsb2ciICk7CgkJCX0KCQkJdGhpcy5pc09wZW4gPSB0cnVlOwoJCQkvLyBEbyBub3QgcHJldmVudCBkZWZhdWx0LCBzbyB0aGUgbmF2aWdhdGlvbiBtYXkgaGF2ZSBhIGNoYW5jZSB0byBhY3R1YWxseSBvcGVuIHRoZSBjaG9zZW4gZm9ybWF0CgkJfQoJfSwKCglfaGFuZGxlTGlzdEZvY3VzOiBmdW5jdGlvbiggZSApIHsKCQl2YXIgcGFyYW1zID0gKCBlLnR5cGUgPT09ICJmb2N1c2luIiApID8KCQkJeyB0YWJpbmRleDogIjAiLCBldmVudDogInZtb3VzZW92ZXIiIH06CgkJCXsgdGFiaW5kZXg6ICItMSIsIGV2ZW50OiAidm1vdXNlb3V0IiB9OwoKCQkkKCBlLnRhcmdldCApCgkJCS5hdHRyKCAidGFiaW5kZXgiLCBwYXJhbXMudGFiaW5kZXggKQoJCQkudHJpZ2dlciggcGFyYW1zLmV2ZW50ICk7Cgl9LAoKCV9oYW5kbGVMaXN0S2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciB0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKSwKCQkJbGkgPSB0YXJnZXQuY2xvc2VzdCggImxpIiApOwoKCQkvLyBzd2l0Y2ggbG9naWMgYmFzZWQgb24gd2hpY2gga2V5IHdhcyBwcmVzc2VkCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJLy8gdXAgb3IgbGVmdCBhcnJvdyBrZXlzCgkJY2FzZSAzODoKCQkJZ29Ub0FkamFjZW50SXRlbSggbGksIHRhcmdldCwgInByZXYiICk7CgkJCXJldHVybiBmYWxzZTsKCQkJLy8gZG93biBvciByaWdodCBhcnJvdyBrZXlzCgkJY2FzZSA0MDoKCQkJZ29Ub0FkamFjZW50SXRlbSggbGksIHRhcmdldCwgIm5leHQiICk7CgkJCXJldHVybiBmYWxzZTsKCQkJLy8gSWYgZW50ZXIgb3Igc3BhY2UgaXMgcHJlc3NlZCwgdHJpZ2dlciBjbGljawoJCWNhc2UgMTM6CgkJY2FzZSAzMjoKCQkJdGFyZ2V0LnRyaWdnZXIoICJjbGljayIgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX0sCgoJX2hhbmRsZU1lbnVQYWdlSGlkZTogZnVuY3Rpb24oKSB7CgkJLy8gVE9ETyBjZW50cmFsaXplIHBhZ2UgcmVtb3ZhbCBiaW5kaW5nIC8gaGFuZGxpbmcgaW4gdGhlIHBhZ2UgcGx1Z2luLgoJCS8vIFN1Z2dlc3Rpb24gZnJvbSBAamJsYXMgdG8gZG8gcmVmY291bnRpbmcKCQkvLwoJCS8vIFRPRE8gZXh0cmVtZWx5IGNvbmZ1c2luZyBkZXBlbmRlbmN5IG9uIHRoZSBvcGVuIG1ldGhvZCB3aGVyZSB0aGUgcGFnZWhpZGUucmVtb3ZlCgkJLy8gYmluZGluZ3MgYXJlIHN0cmlwcGVkIHRvIHByZXZlbnQgdGhlIHBhcmVudCBwYWdlIGZyb20gZGlzYXBwZWFyaW5nLiBUaGUgd2F5CgkJLy8gd2UncmUga2VlcGluZyBwYWdlcyBpbiB0aGUgRE9NIHJpZ2h0IG5vdyBzdWNrcwoJCS8vCgkJLy8gcmViaW5kIHRoZSBwYWdlIHJlbW92ZSB0aGF0IHdhcyB1bmJvdW5kIGluIHRoZSBvcGVuIGZ1bmN0aW9uCgkJLy8gdG8gYWxsb3cgZm9yIHRoZSBwYXJlbnQgcGFnZSByZW1vdmFsIGZyb20gYWN0aW9ucyBvdGhlciB0aGFuIHRoZSB1c2UKCQkvLyBvZiBhIGRpYWxvZyBzaXplZCBjdXN0b20gc2VsZWN0CgkJLy8KCQkvLyBkb2luZyB0aGlzIGhlcmUgcHJvdmlkZXMgZm9yIHRoZSBiYWNrIGJ1dHRvbiBvbiB0aGUgY3VzdG9tIHNlbGVjdCBkaWFsb2cKCQl0aGlzLnRoaXNQYWdlLnBhZ2UoICJiaW5kUmVtb3ZlIiApOwoJfSwKCglfaGFuZGxlSGVhZGVyQ2xvc2VDbGljazogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm1lbnVUeXBlID09PSAib3ZlcmxheSIgKSB7CgkJCXRoaXMuY2xvc2UoKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX0sCgoJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxlY3RJZCwgcG9wdXBJZCwgZGlhbG9nSWQsIGxhYmVsLCB0aGlzUGFnZSwgaXNNdWx0aXBsZSwgbWVudUlkLCB0aGVtZUF0dHIsIG92ZXJsYXlUaGVtZUF0dHIsCgkJCWRpdmlkZXJUaGVtZUF0dHIsIG1lbnVQYWdlLCBsaXN0Ym94LCBsaXN0LCBoZWFkZXIsIGhlYWRlclRpdGxlLCBtZW51UGFnZUNvbnRlbnQsIG1lbnVQYWdlQ2xvc2UsIGhlYWRlckNsb3NlLCBzZWxmLAoJCQlvID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG8ubmF0aXZlTWVudSApIHsKCQkJcmV0dXJuIHRoaXMuX3N1cGVyKCk7CgkJfQoKCQlzZWxmID0gdGhpczsKCQlzZWxlY3RJZCA9IHRoaXMuc2VsZWN0SWQ7CgkJcG9wdXBJZCA9IHNlbGVjdElkICsgIi1saXN0Ym94IjsKCQlkaWFsb2dJZCA9IHNlbGVjdElkICsgIi1kaWFsb2ciOwoJCWxhYmVsID0gdGhpcy5sYWJlbDsKCQl0aGlzUGFnZSA9IHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICk7CgkJaXNNdWx0aXBsZSA9IHRoaXMuZWxlbWVudFsgMCBdLm11bHRpcGxlOwoJCW1lbnVJZCA9IHNlbGVjdElkICsgIi1tZW51IjsKCQl0aGVtZUF0dHIgPSBvLnRoZW1lID8gKCAiIGRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lPSciICsgby50aGVtZSArICInIiApIDogIiI7CgkJb3ZlcmxheVRoZW1lQXR0ciA9IG8ub3ZlcmxheVRoZW1lID8gKCAiIGRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lPSciICsgby5vdmVybGF5VGhlbWUgKyAiJyIgKSA6ICIiOwoJCWRpdmlkZXJUaGVtZUF0dHIgPSAoIG8uZGl2aWRlclRoZW1lICYmIGlzTXVsdGlwbGUgKSA/ICggIiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJkaXZpZGVyLXRoZW1lPSciICsgby5kaXZpZGVyVGhlbWUgKyAiJyIgKSA6ICIiOwoJCW1lbnVQYWdlID0gJCggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0nZGlhbG9nJyBjbGFzcz0ndWktc2VsZWN0bWVudScgaWQ9JyIgKyBkaWFsb2dJZCArICInIiArIHRoZW1lQXR0ciArIG92ZXJsYXlUaGVtZUF0dHIgKyAiPiIgKwoJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdoZWFkZXInPiIgKwoJCQkiPGRpdiBjbGFzcz0ndWktdGl0bGUnPiIgKyBsYWJlbC5nZXRFbmNvZGVkVGV4dCgpICsgIjwvZGl2PiIrCgkJCSI8L2Rpdj4iKwoJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdjb250ZW50Jz48L2Rpdj4iKwoJCQkiPC9kaXY+IiApOwoJCWxpc3Rib3ggPSAkKCAiPGRpdiBpZD0nIiArIHBvcHVwSWQgKyAiJyBjbGFzcz0ndWktc2VsZWN0bWVudSc+IiApLmluc2VydEFmdGVyKCB0aGlzLnNlbGVjdCApLnBvcHVwKHsgdGhlbWU6IG8ub3ZlcmxheVRoZW1lIH0pOwoJCWxpc3QgPSAkKCAiPHVsIGNsYXNzPSd1aS1zZWxlY3RtZW51LWxpc3QnIGlkPSciICsgbWVudUlkICsgIicgcm9sZT0nbGlzdGJveCcgYXJpYS1sYWJlbGxlZGJ5PSciICsgdGhpcy5idXR0b25JZCArICInIiArIHRoZW1lQXR0ciArIGRpdmlkZXJUaGVtZUF0dHIgKyAiPiIgKS5hcHBlbmRUbyggbGlzdGJveCApOwoJCWhlYWRlciA9ICQoICI8ZGl2IGNsYXNzPSd1aS1oZWFkZXIgdWktYmFyLSIgKyAoIG8udGhlbWUgPyBvLnRoZW1lIDogImluaGVyaXQiICkgKyAiJz4iICkucHJlcGVuZFRvKCBsaXN0Ym94ICk7CgkJaGVhZGVyVGl0bGUgPSAkKCAiPGgxIGNsYXNzPSd1aS10aXRsZSc+IiApLmFwcGVuZFRvKCBoZWFkZXIgKTsKCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCWhlYWRlckNsb3NlID0gJCggIjxhPiIsIHsKCQkJCSJyb2xlIjogImJ1dHRvbiIsCgkJCQkidGV4dCI6IG8uY2xvc2VUZXh0LAoJCQkJImhyZWYiOiAiIyIsCgkJCQkiY2xhc3MiOiAidWktYnRuIHVpLWNvcm5lci1hbGwgdWktYnRuLXJpZ2h0IHVpLWJ0bi1pY29uLW5vdGV4dCB1aS1pY29uLWRlbGV0ZSIKCQkJfSkuYXBwZW5kVG8oIGhlYWRlciApOwoJCX0KCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJc2VsZWN0SWQ6IHNlbGVjdElkLAoJCQltZW51SWQ6IG1lbnVJZCwKCQkJcG9wdXBJZDogcG9wdXBJZCwKCQkJZGlhbG9nSWQ6IGRpYWxvZ0lkLAoJCQl0aGlzUGFnZTogdGhpc1BhZ2UsCgkJCW1lbnVQYWdlOiBtZW51UGFnZSwKCQkJbGFiZWw6IGxhYmVsLAoJCQlpc011bHRpcGxlOiBpc011bHRpcGxlLAoJCQl0aGVtZTogby50aGVtZSwKCQkJbGlzdGJveDogbGlzdGJveCwKCQkJbGlzdDogbGlzdCwKCQkJaGVhZGVyOiBoZWFkZXIsCgkJCWhlYWRlclRpdGxlOiBoZWFkZXJUaXRsZSwKCQkJaGVhZGVyQ2xvc2U6IGhlYWRlckNsb3NlLAoJCQltZW51UGFnZUNvbnRlbnQ6IG1lbnVQYWdlQ29udGVudCwKCQkJbWVudVBhZ2VDbG9zZTogbWVudVBhZ2VDbG9zZSwKCQkJcGxhY2Vob2xkZXI6ICIiCgkJfSk7CgoJCS8vIENyZWF0ZSBsaXN0IGZyb20gc2VsZWN0LCB1cGRhdGUgc3RhdGUKCQl0aGlzLnJlZnJlc2goKTsKCgkJaWYgKCB0aGlzLl9vcmlnVGFiSW5kZXggPT09IHVuZGVmaW5lZCApIHsKCQkJLy8gTWFwIHVuZGVmaW5lZCB0byBmYWxzZSwgYmVjYXVzZSB0aGlzLl9vcmlnVGFiSW5kZXggPT09IHVuZGVmaW5lZAoJCQkvLyBpbmRpY2F0ZXMgdGhhdCB3ZSBoYXZlIG5vdCB5ZXQgY2hlY2tlZCB3aGV0aGVyIHRoZSBzZWxlY3QgaGFzCgkJCS8vIG9yaWdpbmFsbHkgaGFkIGEgdGFiaW5kZXggYXR0cmlidXRlLCB3aGVyZWFzIGZhbHNlIGluZGljYXRlcyB0aGF0CgkJCS8vIHdlIGhhdmUgY2hlY2tlZCB0aGUgc2VsZWN0IGZvciBzdWNoIGFuIGF0dHJpYnV0ZSwgYW5kIGhhdmUgZm91bmQKCQkJLy8gbm9uZSBwcmVzZW50LgoJCQl0aGlzLl9vcmlnVGFiSW5kZXggPSAoIHRoaXMuc2VsZWN0WyAwIF0uZ2V0QXR0cmlidXRlKCAidGFiaW5kZXgiICkgPT09IG51bGwgKSA/IGZhbHNlIDogdGhpcy5zZWxlY3QuYXR0ciggInRhYmluZGV4IiApOwoJCX0KCQl0aGlzLnNlbGVjdC5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgkJdGhpcy5fb24oIHRoaXMuc2VsZWN0LCB7IGZvY3VzIDogIl9oYW5kbGVTZWxlY3RGb2N1cyIgfSApOwoKCQkvLyBCdXR0b24gZXZlbnRzCgkJdGhpcy5fb24oIHRoaXMuYnV0dG9uLCB7CgkJCXZjbGljazogIl9oYW5kbGVCdXR0b25WY2xpY2tLZXlkb3duIgoJCX0pOwoKCQkvLyBFdmVudHMgZm9yIGxpc3QgaXRlbXMKCQl0aGlzLmxpc3QuYXR0ciggInJvbGUiLCAibGlzdGJveCIgKTsKCQl0aGlzLl9vbiggdGhpcy5saXN0LCB7CgkJCWZvY3VzaW4gOiAiX2hhbmRsZUxpc3RGb2N1cyIsCgkJCWZvY3Vzb3V0IDogIl9oYW5kbGVMaXN0Rm9jdXMiLAoJCQlrZXlkb3duOiAiX2hhbmRsZUxpc3RLZXlkb3duIgoJCX0pOwoJCXRoaXMubGlzdAoJCQkuZGVsZWdhdGUoICJsaTpub3QoLnVpLWRpc2FibGVkLC51aS1zdGF0ZS1kaXNhYmxlZCwudWktbGktZGl2aWRlcikiLCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJLy8gaW5kZXggb2Ygb3B0aW9uIHRhZyB0byBiZSBzZWxlY3RlZAoJCQkJdmFyIG9sZEluZGV4ID0gc2VsZi5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4LAoJCQkJCW5ld0luZGV4ID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAib3B0aW9uLWluZGV4IiApLAoJCQkJCW9wdGlvbiA9IHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5lcSggbmV3SW5kZXggKVsgMCBdOwoKCQkJCS8vIHRvZ2dsZSBzZWxlY3RlZCBzdGF0dXMgb24gdGhlIHRhZyBmb3IgbXVsdGkgc2VsZWN0cwoJCQkJb3B0aW9uLnNlbGVjdGVkID0gc2VsZi5pc011bHRpcGxlID8gIW9wdGlvbi5zZWxlY3RlZCA6IHRydWU7CgoJCQkJLy8gdG9nZ2xlIGNoZWNrYm94IGNsYXNzIGZvciBtdWx0aXBsZSBzZWxlY3RzCgkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkkKCB0aGlzICkuZmluZCggImEiICkKCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY2hlY2tib3gtb24iLCBvcHRpb24uc2VsZWN0ZWQgKQoJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jaGVja2JveC1vZmYiLCAhb3B0aW9uLnNlbGVjdGVkICk7CgkJCQl9CgoJCQkJLy8gdHJpZ2dlciBjaGFuZ2UgaWYgdmFsdWUgY2hhbmdlZAoJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgfHwgb2xkSW5kZXggIT09IG5ld0luZGV4ICkgewoJCQkJCXNlbGYuc2VsZWN0LnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCQl9CgoJCQkJLy8gaGlkZSBjdXN0b20gc2VsZWN0IGZvciBzaW5nbGUgc2VsZWN0cyBvbmx5IC0gb3RoZXJ3aXNlIGZvY3VzIGNsaWNrZWQgaXRlbQoJCQkJLy8gV2UgbmVlZCB0byBncmFiIHRoZSBjbGlja2VkIGl0ZW0gdGhlIGhhcmQgd2F5LCBiZWNhdXNlIHRoZSBsaXN0IG1heSBoYXZlIGJlZW4gcmVidWlsdAoJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJc2VsZi5saXN0LmZpbmQoICJsaTpub3QoLnVpLWxpLWRpdmlkZXIpIiApLmVxKCBuZXdJbmRleCApCgkJCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJCQl9CgkJCQllbHNlIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9CgoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfSk7CgoJCS8vIGJ1dHRvbiByZWZvY3VzIGVuc3VyZXMgcHJvcGVyIGhlaWdodCBjYWxjdWxhdGlvbgoJCS8vIGJ5IHJlbW92aW5nIHRoZSBpbmxpbmUgc3R5bGUgYW5kIGVuc3VyaW5nIHBhZ2UgaW5jbHVzaW9uCgkJdGhpcy5fb24oIHRoaXMubWVudVBhZ2UsIHsgcGFnZWhpZGU6ICJfaGFuZGxlTWVudVBhZ2VIaWRlIiB9ICk7CgoJCS8vIEV2ZW50cyBvbiB0aGUgcG9wdXAKCQl0aGlzLl9vbiggdGhpcy5saXN0Ym94LCB7IHBvcHVwYWZ0ZXJjbG9zZTogImNsb3NlIiB9ICk7CgoJCS8vIENsb3NlIGJ1dHRvbiBvbiBzbWFsbCBvdmVybGF5cwoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQl0aGlzLl9vbiggdGhpcy5oZWFkZXJDbG9zZSwgeyBjbGljazogIl9oYW5kbGVIZWFkZXJDbG9zZUNsaWNrIiB9ICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJX2lzUmVidWlsZFJlcXVpcmVkOiBmdW5jdGlvbigpIHsKCQl2YXIgbGlzdCA9IHRoaXMubGlzdC5maW5kKCAibGkiICksCgkJCW9wdGlvbnMgPSB0aGlzLl9zZWxlY3RPcHRpb25zKCkubm90KCAiLnVpLXNjcmVlbi1oaWRkZW4iICk7CgoJCS8vIFRPRE8gZXhjZWVkaW5nbHkgbmFpdmUgbWV0aG9kIHRvIGRldGVybWluZSBkaWZmZXJlbmNlCgkJLy8gaWdub3JlcyB2YWx1ZSBjaGFuZ2VzIGV0YyBpbiBmYXZvciBvZiBhIGZvcmNlZFJlYnVpbGQKCQkvLyBmcm9tIHRoZSB1c2VyIGluIHRoZSByZWZyZXNoIG1ldGhvZAoJCXJldHVybiBvcHRpb25zLnRleHQoKSAhPT0gbGlzdC50ZXh0KCk7Cgl9LAoKCXNlbGVjdGVkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZDpub3QoIDpqcW1EYXRhKHBsYWNlaG9sZGVyPSd0cnVlJykgKSIgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIGZvcmNlICkgewoJCXZhciBzZWxmLCBpbmRpY2VzOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5uYXRpdmVNZW51ICkgewoJCQlyZXR1cm4gdGhpcy5fc3VwZXIoIGZvcmNlICk7CgkJfQoKCQlzZWxmID0gdGhpczsKCQlpZiAoIGZvcmNlIHx8IHRoaXMuX2lzUmVidWlsZFJlcXVpcmVkKCkgKSB7CgkJCXNlbGYuX2J1aWxkTGlzdCgpOwoJCX0KCgkJaW5kaWNlcyA9IHRoaXMuc2VsZWN0ZWRJbmRpY2VzKCk7CgoJCXNlbGYuc2V0QnV0dG9uVGV4dCgpOwoJCXNlbGYuc2V0QnV0dG9uQ291bnQoKTsKCgkJc2VsZi5saXN0LmZpbmQoICJsaTpub3QoLnVpLWxpLWRpdmlkZXIpIiApCgkJCS5maW5kKCAiYSIgKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKS5lbmQoKQoJCQkuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCBmYWxzZSApCgkJCS5lYWNoKGZ1bmN0aW9uKCBpICkgewoKCQkJCWlmICggJC5pbkFycmF5KCBpLCBpbmRpY2VzICkgPiAtMSApIHsKCQkJCQl2YXIgaXRlbSA9ICQoIHRoaXMgKTsKCgkJCQkJLy8gQXJpYSBzZWxlY3RlZCBhdHRyCgkJCQkJaXRlbS5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsIHRydWUgKTsKCgkJCQkJLy8gTXVsdGlwbGUgc2VsZWN0czogYWRkIHRoZSAib24iIGNoZWNrYm94IHN0YXRlIHRvIHRoZSBpY29uCgkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJCWl0ZW0uZmluZCggImEiICkucmVtb3ZlQ2xhc3MoICJ1aS1jaGVja2JveC1vZmYiICkuYWRkQ2xhc3MoICJ1aS1jaGVja2JveC1vbiIgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlpZiAoIGl0ZW0uaGFzQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApICkgewoJCQkJCQkJaXRlbS5uZXh0KCkuZmluZCggImEiICkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlpdGVtLmZpbmQoICJhIiApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9KTsKCX0sCgoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8ICF0aGlzLmlzT3BlbiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlpZiAoIHNlbGYubWVudVR5cGUgPT09ICJwYWdlIiApIHsKCQkJc2VsZi5tZW51UGFnZS5kaWFsb2coICJjbG9zZSIgKTsKCQkJc2VsZi5saXN0LmFwcGVuZFRvKCBzZWxmLmxpc3Rib3ggKTsKCQl9IGVsc2UgewoJCQlzZWxmLmxpc3Rib3gucG9wdXAoICJjbG9zZSIgKTsKCQl9CgoJCXNlbGYuX2ZvY3VzQnV0dG9uKCk7CgkJLy8gYWxsb3cgdGhlIGRpYWxvZyB0byBiZSBjbG9zZWQgYWdhaW4KCQlzZWxmLmlzT3BlbiA9IGZhbHNlOwoJfSwKCglvcGVuOiBmdW5jdGlvbigpIHsKCQl0aGlzLmJ1dHRvbi5jbGljaygpOwoJfSwKCglfZm9jdXNNZW51SXRlbTogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdG9yID0gdGhpcy5saXN0LmZpbmQoICJhLiIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCWlmICggc2VsZWN0b3IubGVuZ3RoID09PSAwICkgewoJCQlzZWxlY3RvciA9IHRoaXMubGlzdC5maW5kKCAibGk6bm90KCIgKyB1bmZvY3VzYWJsZUl0ZW1TZWxlY3RvciArICIpIGEudWktYnRuIiApOwoJCX0KCQlzZWxlY3Rvci5maXJzdCgpLmZvY3VzKCk7Cgl9LAoKCV9kZWNpZGVGb3JtYXQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJJHdpbmRvdyA9IHRoaXMud2luZG93LAoJCQlzZWxmTGlzdFBhcmVudCA9IHNlbGYubGlzdC5wYXJlbnQoKSwKCQkJbWVudUhlaWdodCA9IHNlbGZMaXN0UGFyZW50Lm91dGVySGVpZ2h0KCksCgkJCXNjcm9sbFRvcCA9ICR3aW5kb3cuc2Nyb2xsVG9wKCksCgkJCWJ0bk9mZnNldCA9IHNlbGYuYnV0dG9uLm9mZnNldCgpLnRvcCwKCQkJc2NyZWVuSGVpZ2h0ID0gJHdpbmRvdy5oZWlnaHQoKTsKCgkJaWYgKCBtZW51SGVpZ2h0ID4gc2NyZWVuSGVpZ2h0IC0gODAgfHwgISQuc3VwcG9ydC5zY3JvbGxUb3AgKSB7CgoJCQlzZWxmLm1lbnVQYWdlLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICkucGFnZSgpOwoJCQlzZWxmLm1lbnVQYWdlQ29udGVudCA9IHNlbGYubWVudVBhZ2UuZmluZCggIi51aS1jb250ZW50IiApOwoJCQlzZWxmLm1lbnVQYWdlQ2xvc2UgPSBzZWxmLm1lbnVQYWdlLmZpbmQoICIudWktaGVhZGVyIGEiICk7CgoJCQkvLyBwcmV2ZW50IHRoZSBwYXJlbnQgcGFnZSBmcm9tIGJlaW5nIHJlbW92ZWQgZnJvbSB0aGUgRE9NLAoJCQkvLyBvdGhlcndpc2UgdGhlIHJlc3VsdHMgb2Ygc2VsZWN0aW5nIGEgbGlzdCBpdGVtIGluIHRoZSBkaWFsb2cKCQkJLy8gZmFsbCBpbnRvIGEgYmxhY2sgaG9sZQoJCQlzZWxmLnRoaXNQYWdlLnVuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIgKTsKCgkJCS8vZm9yIFdlYk9TL09wZXJhIE1pbmkgKHNldCBsYXN0c2Nyb2xsIHVzaW5nIGJ1dHRvbiBvZmZzZXQpCgkJCWlmICggc2Nyb2xsVG9wID09PSAwICYmIGJ0bk9mZnNldCA+IHNjcmVlbkhlaWdodCApIHsKCQkJCXNlbGYudGhpc1BhZ2Uub25lKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuanFtRGF0YSggImxhc3RTY3JvbGwiLCBidG5PZmZzZXQgKTsKCQkJCX0pOwoJCQl9CgoJCQlzZWxmLm1lbnVQYWdlLm9uZSggewoJCQkJcGFnZXNob3c6ICQucHJveHkoIHRoaXMsICJfZm9jdXNNZW51SXRlbSIgKSwKCQkJCXBhZ2VoaWRlOiAkLnByb3h5KCB0aGlzLCAiY2xvc2UiICkKCQkJfSk7CgoJCQlzZWxmLm1lbnVUeXBlID0gInBhZ2UiOwoJCQlzZWxmLm1lbnVQYWdlQ29udGVudC5hcHBlbmQoIHNlbGYubGlzdCApOwoJCQlzZWxmLm1lbnVQYWdlLmZpbmQoICJkaXYgLnVpLXRpdGxlIiApLnRleHQoIHNlbGYubGFiZWwudGV4dCgpICk7CgkJfSBlbHNlIHsKCQkJc2VsZi5tZW51VHlwZSA9ICJvdmVybGF5IjsKCgkJCXNlbGYubGlzdGJveC5vbmUoIHsgcG9wdXBhZnRlcm9wZW46ICQucHJveHkoIHRoaXMsICJfZm9jdXNNZW51SXRlbSIgKSB9ICk7CgkJfQoJfSwKCglfYnVpbGRMaXN0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCXBsYWNlaG9sZGVyID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJbmVlZFBsYWNlaG9sZGVyID0gdHJ1ZSwKCQkJZGF0YUljb24gPSAiZmFsc2UiLAoJCQkkb3B0aW9ucywgbnVtT3B0aW9ucywgc2VsZWN0LAoJCQlkYXRhUHJlZml4ID0gImRhdGEtIiArICQubW9iaWxlLm5zLAoJCQlkYXRhSW5kZXhBdHRyID0gZGF0YVByZWZpeCArICJvcHRpb24taW5kZXgiLAoJCQlkYXRhSWNvbkF0dHIgPSBkYXRhUHJlZml4ICsgImljb24iLAoJCQlkYXRhUm9sZUF0dHIgPSBkYXRhUHJlZml4ICsgInJvbGUiLAoJCQlkYXRhUGxhY2Vob2xkZXJBdHRyID0gZGF0YVByZWZpeCArICJwbGFjZWhvbGRlciIsCgkJCWZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAoJCQlpc1BsYWNlaG9sZGVySXRlbSA9IGZhbHNlLAoJCQlvcHRHcm91cCwKCQkJaSwKCQkJb3B0aW9uLCAkb3B0aW9uLCBwYXJlbnQsIHRleHQsIGFuY2hvciwgY2xhc3NlcywKCQkJb3B0TGFiZWwsIGRpdmlkZXIsIGl0ZW07CgoJCXNlbGYubGlzdC5lbXB0eSgpLmZpbHRlciggIi51aS1saXN0dmlldyIgKS5saXN0dmlldyggImRlc3Ryb3kiICk7CgkJJG9wdGlvbnMgPSB0aGlzLl9zZWxlY3RPcHRpb25zKCk7CgkJbnVtT3B0aW9ucyA9ICRvcHRpb25zLmxlbmd0aDsKCQlzZWxlY3QgPSB0aGlzLnNlbGVjdFsgMCBdOwoKCQlmb3IgKCBpID0gMDsgaSA8IG51bU9wdGlvbnM7aSsrLCBpc1BsYWNlaG9sZGVySXRlbSA9IGZhbHNlKSB7CgkJCW9wdGlvbiA9ICRvcHRpb25zW2ldOwoJCQkkb3B0aW9uID0gJCggb3B0aW9uICk7CgoJCQkvLyBEbyBub3QgY3JlYXRlIG9wdGlvbnMgYmFzZWQgb24gdWktc2NyZWVuLWhpZGRlbiBzZWxlY3Qgb3B0aW9ucwoJCQlpZiAoICRvcHRpb24uaGFzQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApICkgewoJCQkJY29udGludWU7CgkJCX0KCgkJCXBhcmVudCA9IG9wdGlvbi5wYXJlbnROb2RlOwoJCQl0ZXh0ID0gJG9wdGlvbi50ZXh0KCk7CgkJCWFuY2hvciAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiYSIgKTsKCQkJY2xhc3NlcyA9IFtdOwoKCQkJYW5jaG9yLnNldEF0dHJpYnV0ZSggImhyZWYiLCAiIyIgKTsKCQkJYW5jaG9yLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggdGV4dCApICk7CgoJCQkvLyBBcmUgd2UgaW5zaWRlIGFuIG9wdGdyb3VwPwoJCQlpZiAoIHBhcmVudCAhPT0gc2VsZWN0ICYmIHBhcmVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAib3B0Z3JvdXAiICkgewoJCQkJb3B0TGFiZWwgPSBwYXJlbnQuZ2V0QXR0cmlidXRlKCAibGFiZWwiICk7CgkJCQlpZiAoIG9wdExhYmVsICE9PSBvcHRHcm91cCApIHsKCQkJCQlkaXZpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImxpIiApOwoJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCBkYXRhUm9sZUF0dHIsICJsaXN0LWRpdmlkZXIiICk7CgkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgIm9wdGlvbiIgKTsKCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggInRhYmluZGV4IiwgIi0xIiApOwoJCQkJCWRpdmlkZXIuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBvcHRMYWJlbCApICk7CgkJCQkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGRpdmlkZXIgKTsKCQkJCQlvcHRHcm91cCA9IG9wdExhYmVsOwoJCQkJfQoJCQl9CgoJCQlpZiAoIG5lZWRQbGFjZWhvbGRlciAmJiAoICFvcHRpb24uZ2V0QXR0cmlidXRlKCAidmFsdWUiICkgfHwgdGV4dC5sZW5ndGggPT09IDAgfHwgJG9wdGlvbi5qcW1EYXRhKCAicGxhY2Vob2xkZXIiICkgKSApIHsKCQkJCW5lZWRQbGFjZWhvbGRlciA9IGZhbHNlOwoJCQkJaXNQbGFjZWhvbGRlckl0ZW0gPSB0cnVlOwoKCQkJCS8vIElmIHdlIGhhdmUgaWRlbnRpZmllZCBhIHBsYWNlaG9sZGVyLCByZWNvcmQgdGhlIGZhY3QgdGhhdCBpdCB3YXMKCQkJCS8vIHVzIHdobyBoYXZlIGFkZGVkIHRoZSBwbGFjZWhvbGRlciB0byB0aGUgb3B0aW9uIGFuZCBtYXJrIGl0CgkJCQkvLyByZXRyb2FjdGl2ZWx5IGluIHRoZSBzZWxlY3QgYXMgd2VsbAoJCQkJaWYgKCBudWxsID09PSBvcHRpb24uZ2V0QXR0cmlidXRlKCBkYXRhUGxhY2Vob2xkZXJBdHRyICkgKSB7CgkJCQkJdGhpcy5fcmVtb3ZlUGxhY2Vob2xkZXJBdHRyID0gdHJ1ZTsKCQkJCX0KCQkJCW9wdGlvbi5zZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIsIHRydWUgKTsKCQkJCWlmICggby5oaWRlUGxhY2Vob2xkZXJNZW51SXRlbXMgKSB7CgkJCQkJY2xhc3Nlcy5wdXNoKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQkJCX0KCQkJCWlmICggcGxhY2Vob2xkZXIgIT09IHRleHQgKSB7CgkJCQkJcGxhY2Vob2xkZXIgPSBzZWxmLnBsYWNlaG9sZGVyID0gdGV4dDsKCQkJCX0KCQkJfQoKCQkJaXRlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJsaSIgKTsKCQkJaWYgKCBvcHRpb24uZGlzYWJsZWQgKSB7CgkJCQljbGFzc2VzLnB1c2goICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCAiYXJpYS1kaXNhYmxlZCIsIHRydWUgKTsKCQkJfQoJCQlpdGVtLnNldEF0dHJpYnV0ZSggZGF0YUluZGV4QXR0ciwgaSApOwoJCQlpdGVtLnNldEF0dHJpYnV0ZSggZGF0YUljb25BdHRyLCBkYXRhSWNvbiApOwoJCQlpZiAoIGlzUGxhY2Vob2xkZXJJdGVtICkgewoJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIsIHRydWUgKTsKCQkJfQoJCQlpdGVtLmNsYXNzTmFtZSA9IGNsYXNzZXMuam9pbiggIiAiICk7CgkJCWl0ZW0uc2V0QXR0cmlidXRlKCAicm9sZSIsICJvcHRpb24iICk7CgkJCWFuY2hvci5zZXRBdHRyaWJ1dGUoICJ0YWJpbmRleCIsICItMSIgKTsKCQkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCQkkKCBhbmNob3IgKS5hZGRDbGFzcyggInVpLWJ0biB1aS1jaGVja2JveC1vZmYgdWktYnRuLWljb24tbGVmdCIgKTsKCQkJfQoKCQkJaXRlbS5hcHBlbmRDaGlsZCggYW5jaG9yICk7CgkJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBpdGVtICk7CgkJfQoKCQlzZWxmLmxpc3RbMF0uYXBwZW5kQ2hpbGQoIGZyYWdtZW50ICk7CgoJCS8vIEhpZGUgaGVhZGVyIGlmIGl0J3Mgbm90IGEgbXVsdGlzZWxlY3QgYW5kIHRoZXJlJ3Mgbm8gcGxhY2Vob2xkZXIKCQlpZiAoICF0aGlzLmlzTXVsdGlwbGUgJiYgIXBsYWNlaG9sZGVyLmxlbmd0aCApIHsKCQkJdGhpcy5oZWFkZXIuYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0gZWxzZSB7CgkJCXRoaXMuaGVhZGVyVGl0bGUudGV4dCggdGhpcy5wbGFjZWhvbGRlciApOwoJCX0KCgkJLy8gTm93IHBvcHVsYXRlZCwgY3JlYXRlIGxpc3R2aWV3CgkJc2VsZi5saXN0Lmxpc3R2aWV3KCk7Cgl9LAoKCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLm9wdGlvbnMubmF0aXZlTWVudSA/CgkJCXRoaXMuX3N1cGVyKCkgOgoJCQkkKCAiPGE+IiwgewoJCQkJImhyZWYiOiAiIyIsCgkJCQkicm9sZSI6ICJidXR0b24iLAoJCQkJLy8gVE9ETyB2YWx1ZSBpcyB1bmRlZmluZWQgYXQgY3JlYXRpb24KCQkJCSJpZCI6IHRoaXMuYnV0dG9uSWQsCgkJCQkiYXJpYS1oYXNwb3B1cCI6ICJ0cnVlIiwKCgkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJImFyaWEtb3ducyI6IHRoaXMubWVudUlkCgkJCX0pOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgoJCWlmICggIXRoaXMub3B0aW9ucy5uYXRpdmVNZW51ICkgewoJCQl0aGlzLmNsb3NlKCk7CgoJCQkvLyBSZXN0b3JlIHRoZSB0YWJpbmRleCBhdHRyaWJ1dGUgdG8gaXRzIG9yaWdpbmFsIHZhbHVlCgkJCWlmICggdGhpcy5fb3JpZ1RhYkluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIHRoaXMuX29yaWdUYWJJbmRleCAhPT0gZmFsc2UgKSB7CgkJCQkJdGhpcy5zZWxlY3QuYXR0ciggInRhYmluZGV4IiwgdGhpcy5fb3JpZ1RhYkluZGV4ICk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuc2VsZWN0LnJlbW92ZUF0dHIoICJ0YWJpbmRleCIgKTsKCQkJCX0KCQkJfQoKCQkJLy8gUmVtb3ZlIHRoZSBwbGFjZWhvbGRlciBhdHRyaWJ1dGUgaWYgd2Ugd2VyZSB0aGUgb25lcyB0byBhZGQgaXQKCQkJaWYgKCB0aGlzLl9yZW1vdmVQbGFjZWhvbGRlckF0dHIgKSB7CgkJCQl0aGlzLl9zZWxlY3RPcHRpb25zKCkucmVtb3ZlQXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInBsYWNlaG9sZGVyIiApOwoJCQl9CgoJCQkvLyBSZW1vdmUgdGhlIHBvcHVwCgkJCXRoaXMubGlzdGJveC5yZW1vdmUoKTsKCgkJCS8vIFJlbW92ZSB0aGUgZGlhbG9nCgkJCXRoaXMubWVudVBhZ2UucmVtb3ZlKCk7CgkJfQoKCQkvLyBDaGFpbiB1cAoJCXRoaXMuX3N1cGVyKCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKCi8vIGJ1dHRvbk1hcmt1cCBpcyBkZXByZWNhdGVkIGFzIG9mIDEuNC4wIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gMS41LjAuCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgovLyBHZW5lcmFsIHBvbGljeTogRG8gbm90IGFjY2VzcyBkYXRhLSogYXR0cmlidXRlcyBleGNlcHQgZHVyaW5nIGVuaGFuY2VtZW50LgovLyBJbiBhbGwgb3RoZXIgY2FzZXMgd2UgZGV0ZXJtaW5lIHRoZSBzdGF0ZSBvZiB0aGUgYnV0dG9uIGV4Y2x1c2l2ZWx5IGZyb20gaXRzCi8vIGNsYXNzTmFtZS4gVGhhdCdzIHdoeSBvcHRpb25zVG9DbGFzc2VzIGV4cGVjdHMgYSBmdWxsIGNvbXBsZW1lbnQgb2Ygb3B0aW9ucywKLy8gYW5kIHRoZSBqUXVlcnkgcGx1Z2luIGNvbXBsZXRlcyB0aGUgc2V0IG9mIG9wdGlvbnMgZnJvbSB0aGUgZGVmYXVsdCB2YWx1ZXMuCgovLyBNYXAgY2xhc3NlcyB0byBidXR0b25NYXJrdXAgYm9vbGVhbiBvcHRpb25zIC0gdXNlZCBpbiBjbGFzc05hbWVUb09wdGlvbnMoKQp2YXIgcmV2ZXJzZUJvb2xPcHRpb25NYXAgPSB7CgkJInVpLXNoYWRvdyIgOiAic2hhZG93IiwKCQkidWktY29ybmVyLWFsbCIgOiAiY29ybmVycyIsCgkJInVpLWJ0bi1pbmxpbmUiIDogImlubGluZSIsCgkJInVpLXNoYWRvdy1pY29uIiA6ICJpY29uc2hhZG93IiwgLyogVE9ETzogUmVtb3ZlIGluIDEuNSAqLwoJCSJ1aS1taW5pIiA6ICJtaW5pIgoJfSwKCWdldEF0dHJGaXhlZCA9IGZ1bmN0aW9uKCkgewoJCXZhciByZXQgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoKCQlyZXR1cm4gKCByZXQgPT0gbnVsbCA/IHVuZGVmaW5lZCA6IHJldCApOwoJfSwKCWNhcGl0YWxMZXR0ZXJzUkUgPSAvW0EtWl0vZzsKCi8vIG9wdGlvbnNUb0NsYXNzZXM6Ci8vIEBvcHRpb25zOiBBIGNvbXBsZXRlIHNldCBvZiBvcHRpb25zIHRvIGNvbnZlcnQgdG8gY2xhc3MgbmFtZXMuCi8vIEBleGlzdGluZ0NsYXNzZXM6IGV4dHJhIGNsYXNzZXMgdG8gYWRkIHRvIHRoZSByZXN1bHQKLy8KLy8gQ29udmVydHMgQG9wdGlvbnMgdG8gYnV0dG9uTWFya3VwIGNsYXNzZXMgYW5kIHJldHVybnMgdGhlIHJlc3VsdCBhcyBhbiBhcnJheQovLyB0aGF0IGNhbiBiZSBjb252ZXJ0ZWQgdG8gYW4gZWxlbWVudCdzIGNsYXNzTmFtZSB3aXRoIC5qb2luKCAiICIgKS4gQWxsCi8vIHBvc3NpYmxlIG9wdGlvbnMgbXVzdCBiZSBzZXQgaW5zaWRlIEBvcHRpb25zLiBVc2UgJC5mbi5idXR0b25NYXJrdXAuZGVmYXVsdHMKLy8gdG8gZ2V0IGEgY29tcGxldGUgc2V0IGFuZCB1c2UgJC5leHRlbmQgdG8gb3ZlcnJpZGUgeW91ciBjaG9pY2Ugb2Ygb3B0aW9ucwovLyBmcm9tIHRoYXQgc2V0LgpmdW5jdGlvbiBvcHRpb25zVG9DbGFzc2VzKCBvcHRpb25zLCBleGlzdGluZ0NsYXNzZXMgKSB7Cgl2YXIgY2xhc3NlcyA9IGV4aXN0aW5nQ2xhc3NlcyA/IGV4aXN0aW5nQ2xhc3NlcyA6IFtdOwoKCS8vIEFkZCBjbGFzc2VzIHRvIHRoZSBhcnJheSAtIGZpcnN0IHVpLWJ0bgoJY2xhc3Nlcy5wdXNoKCAidWktYnRuIiApOwoKCS8vIElmIHRoZXJlIGlzIGEgdGhlbWUKCWlmICggb3B0aW9ucy50aGVtZSApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1idG4tIiArIG9wdGlvbnMudGhlbWUgKTsKCX0KCgkvLyBJZiB0aGVyZSdzIGFuIGljb24sIGFkZCB0aGUgaWNvbi1yZWxhdGVkIGNsYXNzZXMKCWlmICggb3B0aW9ucy5pY29uICkgewoJCWNsYXNzZXMgPSBjbGFzc2VzLmNvbmNhdChbCgkJCSJ1aS1pY29uLSIgKyBvcHRpb25zLmljb24sCgkJCSJ1aS1idG4taWNvbi0iICsgb3B0aW9ucy5pY29ucG9zCgkJXSk7CgkJaWYgKCBvcHRpb25zLmljb25zaGFkb3cgKSB7CgkJCWNsYXNzZXMucHVzaCggInVpLXNoYWRvdy1pY29uIiApOyAvKiBUT0RPOiBSZW1vdmUgaW4gMS41ICovCgkJfQoJfQoKCS8vIEFkZCB0aGUgYXBwcm9wcmlhdGUgY2xhc3MgZm9yIGVhY2ggYm9vbGVhbiBvcHRpb24KCWlmICggb3B0aW9ucy5pbmxpbmUgKSB7CgkJY2xhc3Nlcy5wdXNoKCAidWktYnRuLWlubGluZSIgKTsKCX0KCWlmICggb3B0aW9ucy5zaGFkb3cgKSB7CgkJY2xhc3Nlcy5wdXNoKCAidWktc2hhZG93IiApOwoJfQoJaWYgKCBvcHRpb25zLmNvcm5lcnMgKSB7CgkJY2xhc3Nlcy5wdXNoKCAidWktY29ybmVyLWFsbCIgKTsKCX0KCWlmICggb3B0aW9ucy5taW5pICkgewoJCWNsYXNzZXMucHVzaCggInVpLW1pbmkiICk7Cgl9CgoJLy8gQ3JlYXRlIGEgc3RyaW5nIGZyb20gdGhlIGFycmF5IGFuZCByZXR1cm4gaXQKCXJldHVybiBjbGFzc2VzOwp9CgovLyBjbGFzc05hbWVUb09wdGlvbnM6Ci8vIEBjbGFzc2VzOiBBIHN0cmluZyBjb250YWluaW5nIGEgLmNsYXNzTmFtZS1zdHlsZSBzcGFjZS1zZXBhcmF0ZWQgY2xhc3MgbGlzdAovLwovLyBMb29wcyBvdmVyIEBjbGFzc2VzIGFuZCBjYWxjdWxhdGVzIGFuIG9wdGlvbnMgb2JqZWN0IGJhc2VkIG9uIHRoZQovLyBidXR0b25NYXJrdXAtcmVsYXRlZCBjbGFzc2VzIGl0IGZpbmRzLiBJdCByZWNvcmRzIHVucmVjb2duaXplZCBjbGFzc2VzIGluIGFuCi8vIGFycmF5LgovLwovLyBSZXR1cm5zOiBBbiBvYmplY3QgY29udGFpbmluZyB0aGUgZm9sbG93aW5nIGl0ZW1zOgovLwovLyAib3B0aW9ucyI6IGJ1dHRvbk1hcmt1cCBvcHRpb25zIGZvdW5kIHRvIGJlIHByZXNlbnQgYmVjYXVzZSBvZiB0aGUKLy8gcHJlc2VuY2UvYWJzZW5jZSBvZiBjb3JyZXNwb25kaW5nIGNsYXNzZXMKLy8KLy8gInVua25vd25DbGFzc2VzIjogYSBzdHJpbmcgY29udGFpbmluZyBhbGwgdGhlIG5vbi1idXR0b25NYXJrdXAtcmVsYXRlZAovLyBjbGFzc2VzIGZvdW5kIGluIEBjbGFzc2VzCi8vCi8vICJhbHJlYWR5RW5oYW5jZWQiOiBBIGJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIHRoZSB1aS1idG4gY2xhc3Mgd2FzIGFtb25nCi8vIHRob3NlIGZvdW5kIHRvIGJlIHByZXNlbnQKZnVuY3Rpb24gY2xhc3NOYW1lVG9PcHRpb25zKCBjbGFzc2VzICkgewoJdmFyIGlkeCwgbWFwLCB1bmtub3duQ2xhc3MsCgkJYWxyZWFkeUVuaGFuY2VkID0gZmFsc2UsCgkJbm9JY29uID0gdHJ1ZSwKCQlvID0gewoJCQlpY29uOiAiIiwKCQkJaW5saW5lOiBmYWxzZSwKCQkJc2hhZG93OiBmYWxzZSwKCQkJY29ybmVyczogZmFsc2UsCgkJCWljb25zaGFkb3c6IGZhbHNlLAoJCQltaW5pOiBmYWxzZQoJCX0sCgkJdW5rbm93bkNsYXNzZXMgPSBbXTsKCgljbGFzc2VzID0gY2xhc3Nlcy5zcGxpdCggIiAiICk7CgoJLy8gTG9vcCBvdmVyIHRoZSBjbGFzc2VzCglmb3IgKCBpZHggPSAwIDsgaWR4IDwgY2xhc3Nlcy5sZW5ndGggOyBpZHgrKyApIHsKCgkJLy8gQXNzdW1lIGl0J3MgYW4gdW5yZWNvZ25pemVkIGNsYXNzCgkJdW5rbm93bkNsYXNzID0gdHJ1ZTsKCgkJLy8gUmVjb2duaXplIGJvb2xlYW4gb3B0aW9ucyBmcm9tIHRoZSBwcmVzZW5jZSBvZiBjbGFzc2VzCgkJbWFwID0gcmV2ZXJzZUJvb2xPcHRpb25NYXBbIGNsYXNzZXNbIGlkeCBdIF07CgkJaWYgKCBtYXAgIT09IHVuZGVmaW5lZCApIHsKCQkJdW5rbm93bkNsYXNzID0gZmFsc2U7CgkJCW9bIG1hcCBdID0gdHJ1ZTsKCgkJLy8gUmVjb2duaXplIHRoZSBwcmVzZW5jZSBvZiBhbiBpY29uIGFuZCBlc3RhYmxpc2ggdGhlIGljb24gcG9zaXRpb24KCQl9IGVsc2UgaWYgKCBjbGFzc2VzWyBpZHggXS5pbmRleE9mKCAidWktYnRuLWljb24tIiApID09PSAwICkgewoJCQl1bmtub3duQ2xhc3MgPSBmYWxzZTsKCQkJbm9JY29uID0gZmFsc2U7CgkJCW8uaWNvbnBvcyA9IGNsYXNzZXNbIGlkeCBdLnN1YnN0cmluZyggMTIgKTsKCgkJLy8gRXN0YWJsaXNoIHdoaWNoIGljb24gaXMgcHJlc2VudAoJCX0gZWxzZSBpZiAoIGNsYXNzZXNbIGlkeCBdLmluZGV4T2YoICJ1aS1pY29uLSIgKSA9PT0gMCApIHsKCQkJdW5rbm93bkNsYXNzID0gZmFsc2U7CgkJCW8uaWNvbiA9IGNsYXNzZXNbIGlkeCBdLnN1YnN0cmluZyggOCApOwoKCQkvLyBFc3RhYmxpc2ggdGhlIHRoZW1lIC0gdGhpcyByZWNvZ25pemVzIG9uZS1sZXR0ZXIgdGhlbWUgc3dhdGNoIG5hbWVzCgkJfSBlbHNlIGlmICggY2xhc3Nlc1sgaWR4IF0uaW5kZXhPZiggInVpLWJ0bi0iICkgPT09IDAgJiYgY2xhc3Nlc1sgaWR4IF0ubGVuZ3RoID09PSA4ICkgewoJCQl1bmtub3duQ2xhc3MgPSBmYWxzZTsKCQkJby50aGVtZSA9IGNsYXNzZXNbIGlkeCBdLnN1YnN0cmluZyggNyApOwoKCQkvLyBSZWNvZ25pemUgdGhhdCB0aGlzIGVsZW1lbnQgaGFzIGFscmVhZHkgYmVlbiBidXR0b25NYXJrdXAtZW5oYW5jZWQKCQl9IGVsc2UgaWYgKCBjbGFzc2VzWyBpZHggXSA9PT0gInVpLWJ0biIgKSB7CgkJCXVua25vd25DbGFzcyA9IGZhbHNlOwoJCQlhbHJlYWR5RW5oYW5jZWQgPSB0cnVlOwoJCX0KCgkJLy8gSWYgdGhpcyBjbGFzcyBoYXMgbm90IGJlZW4gcmVjb2duaXplZCwgYWRkIGl0IHRvIHRoZSBsaXN0CgkJaWYgKCB1bmtub3duQ2xhc3MgKSB7CgkJCXVua25vd25DbGFzc2VzLnB1c2goIGNsYXNzZXNbIGlkeCBdICk7CgkJfQoJfQoKCS8vIElmIGEgInVpLWJ0bi1pY29uLSoiIGljb24gcG9zaXRpb24gY2xhc3MgaXMgYWJzZW50IHRoZXJlIGNhbm5vdCBiZSBhbiBpY29uCglpZiAoIG5vSWNvbiApIHsKCQlvLmljb24gPSAiIjsKCX0KCglyZXR1cm4gewoJCW9wdGlvbnM6IG8sCgkJdW5rbm93bkNsYXNzZXM6IHVua25vd25DbGFzc2VzLAoJCWFscmVhZHlFbmhhbmNlZDogYWxyZWFkeUVuaGFuY2VkCgl9Owp9CgpmdW5jdGlvbiBjYW1lbENhc2UySHlwaGVuYXRlZCggYyApIHsKCXJldHVybiAiLSIgKyBjLnRvTG93ZXJDYXNlKCk7Cn0KCi8vICQuZm4uYnV0dG9uTWFya3VwOgovLyBET006IGdldHMvc2V0cyAuY2xhc3NOYW1lCi8vCi8vIEBvcHRpb25zOiBvcHRpb25zIHRvIGFwcGx5IHRvIHRoZSBlbGVtZW50cyBpbiB0aGUgalF1ZXJ5IG9iamVjdAovLyBAb3ZlcndyaXRlQ2xhc3NlczogYm9vbGVhbiBpbmRpY2F0aW5nIHdoZXRoZXIgdG8gaG9ub3VyIGV4aXN0aW5nIGNsYXNzZXMKLy8KLy8gQ2FsY3VsYXRlcyB0aGUgY2xhc3NlcyB0byBhcHBseSB0byB0aGUgZWxlbWVudHMgaW4gdGhlIGpRdWVyeSBvYmplY3QgYmFzZWQgb24KLy8gdGhlIG9wdGlvbnMgcGFzc2VkIGluLiBJZiBAb3ZlcndyaXRlQ2xhc3NlcyBpcyB0cnVlLCBpdCBzZXRzIHRoZSBjbGFzc05hbWUKLy8gcHJvcGVydHkgb2YgZWFjaCBlbGVtZW50IGluIHRoZSBqUXVlcnkgb2JqZWN0IHRvIHRoZSBidXR0b25NYXJrdXAgY2xhc3NlcwovLyBpdCBjYWxjdWxhdGVzIGJhc2VkIG9uIHRoZSBvcHRpb25zIHBhc3NlZCBpbi4KLy8KLy8gSWYgeW91IHdpc2ggdG8gcHJlc2VydmUgYW55IGNsYXNzZXMgdGhhdCBhcmUgYWxyZWFkeSBwcmVzZW50IG9uIHRoZSBlbGVtZW50cwovLyBpbnNpZGUgdGhlIGpRdWVyeSBvYmplY3QsIGluY2x1ZGluZyBidXR0b25NYXJrdXAtcmVsYXRlZCBjbGFzc2VzIHRoYXQgd2VyZQovLyBhZGRlZCBieSBhIHByZXZpb3VzIGNhbGwgdG8gJC5mbi5idXR0b25NYXJrdXAoKSBvciBkdXJpbmcgcGFnZSBlbmhhbmNlbWVudAovLyB0aGVuIHlvdSBzaG91bGQgb21pdCBAb3ZlcndyaXRlQ2xhc3NlcyBvciBzZXQgaXQgdG8gZmFsc2UuCiQuZm4uYnV0dG9uTWFya3VwID0gZnVuY3Rpb24oIG9wdGlvbnMsIG92ZXJ3cml0ZUNsYXNzZXMgKSB7Cgl2YXIgaWR4LCBkYXRhLCBlbCwgcmV0cmlldmVkT3B0aW9ucywgb3B0aW9uS2V5LAoJCWRlZmF1bHRzID0gJC5mbi5idXR0b25NYXJrdXAuZGVmYXVsdHM7CgoJZm9yICggaWR4ID0gMCA7IGlkeCA8IHRoaXMubGVuZ3RoIDsgaWR4KysgKSB7CgkJZWwgPSB0aGlzWyBpZHggXTsKCQlkYXRhID0gb3ZlcndyaXRlQ2xhc3NlcyA/CgoJCQkvLyBBc3N1bWUgdGhpcyBlbGVtZW50IGlzIG5vdCBlbmhhbmNlZCBhbmQgaWdub3JlIGl0cyBjbGFzc2VzCgkJCXsgYWxyZWFkeUVuaGFuY2VkOiBmYWxzZSwgdW5rbm93bkNsYXNzZXM6IFtdIH0gOgoKCQkJLy8gT3RoZXJ3aXNlIGFuYWx5emUgZXhpc3RpbmcgY2xhc3NlcyB0byBlc3RhYmxpc2ggZXhpc3Rpbmcgb3B0aW9ucyBhbmQKCQkJLy8gY2xhc3NlcwoJCQljbGFzc05hbWVUb09wdGlvbnMoIGVsLmNsYXNzTmFtZSApOwoKCQlyZXRyaWV2ZWRPcHRpb25zID0gJC5leHRlbmQoIHt9LAoKCQkJLy8gSWYgdGhlIGVsZW1lbnQgYWxyZWFkeSBoYXMgdGhlIGNsYXNzIHVpLWJ0biwgdGhlbiB3ZSBhc3N1bWUgdGhhdAoJCQkvLyBpdCBoYXMgcGFzc2VkIHRocm91Z2ggYnV0dG9uTWFya3VwIGJlZm9yZSAtIG90aGVyd2lzZSwgdGhlIG9wdGlvbnMKCQkJLy8gcmV0dXJuZWQgYnkgY2xhc3NOYW1lVG9PcHRpb25zIGRvIG5vdCBjb3JyZWN0bHkgcmVmbGVjdCB0aGUgc3RhdGUgb2YKCQkJLy8gdGhlIGVsZW1lbnQKCQkJKCBkYXRhLmFscmVhZHlFbmhhbmNlZCA/IGRhdGEub3B0aW9ucyA6IHt9ICksCgoJCQkvLyBGaW5hbGx5LCBhcHBseSB0aGUgb3B0aW9ucyBwYXNzZWQgaW4KCQkJb3B0aW9ucyApOwoKCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCBjYWxsIG9uIHRoaXMgZWxlbWVudCwgcmV0cmlldmUgcmVtYWluaW5nIG9wdGlvbnMKCQkvLyBmcm9tIHRoZSBkYXRhLWF0dHJpYnV0ZXMKCQlpZiAoICFkYXRhLmFscmVhZHlFbmhhbmNlZCApIHsKCQkJZm9yICggb3B0aW9uS2V5IGluIGRlZmF1bHRzICkgewoJCQkJaWYgKCByZXRyaWV2ZWRPcHRpb25zWyBvcHRpb25LZXkgXSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHJpZXZlZE9wdGlvbnNbIG9wdGlvbktleSBdID0gZ2V0QXR0ckZpeGVkKCBlbCwKCQkJCQkJb3B0aW9uS2V5LnJlcGxhY2UoIGNhcGl0YWxMZXR0ZXJzUkUsIGNhbWVsQ2FzZTJIeXBoZW5hdGVkICkKCQkJCQkpOwoJCQkJfQoJCQl9CgkJfQoKCQllbC5jbGFzc05hbWUgPSBvcHRpb25zVG9DbGFzc2VzKAoKCQkJLy8gTWVyZ2UgYWxsIHRoZSBvcHRpb25zIGFuZCBhcHBseSB0aGVtIGFzIGNsYXNzZXMKCQkJJC5leHRlbmQoIHt9LAoKCQkJCS8vIFRoZSBkZWZhdWx0cyBmb3JtIHRoZSBiYXNpcwoJCQkJZGVmYXVsdHMsCgoJCQkJLy8gQWRkIHRoZSBjb21wdXRlZCBvcHRpb25zCgkJCQlyZXRyaWV2ZWRPcHRpb25zCgkJCSksCgoJCQkvLyAuLi4gYW5kIHJlLWFwcGx5IGFueSB1bnJlY29nbml6ZWQgY2xhc3NlcyB0aGF0IHdlcmUgZm91bmQKCQkJZGF0YS51bmtub3duQ2xhc3NlcyApLmpvaW4oICIgIiApOwoJCWlmICggZWwudGFnTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAiYnV0dG9uIiApIHsKCQkJZWwuc2V0QXR0cmlidXRlKCAicm9sZSIsICJidXR0b24iICk7CgkJfQoJfQoKCXJldHVybiB0aGlzOwp9OwoKLy8gYnV0dG9uTWFya3VwIGRlZmF1bHRzLiBUaGlzIG11c3QgYmUgYSBjb21wbGV0ZSBzZXQsIGkuZS4sIGEgdmFsdWUgbXVzdCBiZQovLyBnaXZlbiBoZXJlIGZvciBhbGwgcmVjb2duaXplZCBvcHRpb25zCiQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzID0gewoJaWNvbjogIiIsCglpY29ucG9zOiAicmlnaHQiLAoJdGhlbWU6IG51bGwsCglpbmxpbmU6IGZhbHNlLAoJc2hhZG93OiB0cnVlLAoJY29ybmVyczogdHJ1ZSwKCWljb25zaGFkb3c6IGZhbHNlLCAvKiBUT0RPOiBSZW1vdmUgaW4gMS41LiBPcHRpb24gZGVwcmVjYXRlZCBpbiAxLjQuICovCgltaW5pOiBmYWxzZQp9OwoKJC5leHRlbmQoICQuZm4uYnV0dG9uTWFya3VwLCB7Cglpbml0U2VsZWN0b3I6ICJhOmpxbURhdGEocm9sZT0nYnV0dG9uJyksIC51aS1iYXIgPiBhLCAudWktYmFyID4gOmpxbURhdGEocm9sZT0nY29udHJvbGdyb3VwJykgPiBhLCBidXR0b24iCn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29udHJvbGdyb3VwIiwgJC5leHRlbmQoIHsKCW9wdGlvbnM6IHsKCQllbmhhbmNlZDogZmFsc2UsCgkJdGhlbWU6IG51bGwsCgkJc2hhZG93OiBmYWxzZSwKCQljb3JuZXJzOiB0cnVlLAoJCWV4Y2x1ZGVJbnZpc2libGU6IHRydWUsCgkJdHlwZTogInZlcnRpY2FsIiwKCQltaW5pOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJLy8gUnVuIGJ1dHRvbm1hcmt1cAoJCWlmICggJC5mbi5idXR0b25NYXJrdXAgKSB7CgkJCXRoaXMuZWxlbWVudC5maW5kKCAkLmZuLmJ1dHRvbk1hcmt1cC5pbml0U2VsZWN0b3IgKS5idXR0b25NYXJrdXAoKTsKCQl9CgkJLy8gRW5oYW5jZSBjaGlsZCB3aWRnZXRzCgkJJC5lYWNoKCB0aGlzLl9jaGlsZFdpZGdldHMsICQucHJveHkoIGZ1bmN0aW9uKCBudW1iZXIsIHdpZGdldE5hbWUgKSB7CgkJCWlmICggJC5tb2JpbGVbIHdpZGdldE5hbWUgXSApIHsKCQkJCXRoaXMuZWxlbWVudC5maW5kKCAkLm1vYmlsZVsgd2lkZ2V0TmFtZSBdLmluaXRTZWxlY3RvciApLm5vdCggJC5tb2JpbGUucGFnZS5wcm90b3R5cGUua2VlcE5hdGl2ZVNlbGVjdG9yKCkgKVsgd2lkZ2V0TmFtZSBdKCk7CgkJCX0KCQl9LCB0aGlzICkpOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfdWk6IG51bGwsCgkJCV9pbml0aWFsUmVmcmVzaDogdHJ1ZQoJCX0pOwoKCQlpZiAoIG9wdHMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX3VpID0gewoJCQkJZ3JvdXBMZWdlbmQ6IGVsZW0uY2hpbGRyZW4oICIudWktY29udHJvbGdyb3VwLWxhYmVsIiApLmNoaWxkcmVuKCksCgkJCQljaGlsZFdyYXBwZXI6IGVsZW0uY2hpbGRyZW4oICIudWktY29udHJvbGdyb3VwLWNvbnRyb2xzIiApCgkJCX07CgkJfSBlbHNlIHsKCQkJdGhpcy5fdWkgPSB0aGlzLl9lbmhhbmNlKCk7CgkJfQoKCX0sCgoJX2NoaWxkV2lkZ2V0czogWyAiY2hlY2tib3hyYWRpbyIsICJzZWxlY3RtZW51IiwgImJ1dHRvbiIgXSwKCglfdGhlbWVDbGFzc0Zyb21PcHRpb246IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlyZXR1cm4gKCB2YWx1ZSA/ICggdmFsdWUgPT09ICJub25lIiA/ICIiIDogInVpLWdyb3VwLXRoZW1lLSIgKyB2YWx1ZSApIDogIiIgKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQlvcHRzID0gdGhpcy5vcHRpb25zLAoJCQl1aSA9IHsKCQkJCWdyb3VwTGVnZW5kOiBlbGVtLmNoaWxkcmVuKCAibGVnZW5kIiApLAoJCQkJY2hpbGRXcmFwcGVyOiBlbGVtCgkJCQkJLmFkZENsYXNzKCAidWktY29udHJvbGdyb3VwICIgKwoJCQkJCQkidWktY29udHJvbGdyb3VwLSIgKwoJCQkJCQkJKCBvcHRzLnR5cGUgPT09ICJob3Jpem9udGFsIiA/ICJob3Jpem9udGFsIiA6ICJ2ZXJ0aWNhbCIgKSArICIgIiArCgkJCQkJCXRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCBvcHRzLnRoZW1lICkgKyAiICIgKwoJCQkJCQkoIG9wdHMuY29ybmVycyA/ICJ1aS1jb3JuZXItYWxsICIgOiAiIiApICsKCQkJCQkJKCBvcHRzLm1pbmkgPyAidWktbWluaSAiIDogIiIgKSApCgkJCQkJLndyYXBJbm5lciggIjxkaXYgIiArCgkJCQkJCSJjbGFzcz0ndWktY29udHJvbGdyb3VwLWNvbnRyb2xzICIgKwoJCQkJCQkJKCBvcHRzLnNoYWRvdyA9PT0gdHJ1ZSA/ICJ1aS1zaGFkb3ciIDogIiIgKSArICInPjwvZGl2PiIgKQoJCQkJCS5jaGlsZHJlbigpCgkJCX07CgoJCWlmICggdWkuZ3JvdXBMZWdlbmQubGVuZ3RoID4gMCApIHsKCQkJJCggIjxkaXYgcm9sZT0naGVhZGluZycgY2xhc3M9J3VpLWNvbnRyb2xncm91cC1sYWJlbCc+PC9kaXY+IiApCgkJCQkuYXBwZW5kKCB1aS5ncm91cExlZ2VuZCApCgkJCQkucHJlcGVuZFRvKCBlbGVtICk7CgkJfQoKCQlyZXR1cm4gdWk7Cgl9LAoKCV9pbml0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBjYWxsUmVmcmVzaCwgcmV0dXJuVmFsdWUsCgkJCWVsZW0gPSB0aGlzLmVsZW1lbnQ7CgoJCS8vIE11c3QgaGF2ZSBvbmUgb2YgaG9yaXpvbnRhbCBvciB2ZXJ0aWNhbAoJCWlmICggb3B0aW9ucy50eXBlICE9PSB1bmRlZmluZWQgKSB7CgkJCWVsZW0KCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvbnRyb2xncm91cC1ob3Jpem9udGFsIHVpLWNvbnRyb2xncm91cC12ZXJ0aWNhbCIgKQoJCQkJLmFkZENsYXNzKCAidWktY29udHJvbGdyb3VwLSIgKyAoIG9wdGlvbnMudHlwZSA9PT0gImhvcml6b250YWwiID8gImhvcml6b250YWwiIDogInZlcnRpY2FsIiApICk7CgkJCWNhbGxSZWZyZXNoID0gdHJ1ZTsKCQl9CgoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCB0aGlzLm9wdGlvbnMudGhlbWUgKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCBvcHRpb25zLnRoZW1lICkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCWVsZW0udG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtLnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIG9wdGlvbnMubWluaSApOwoJCX0KCgkJaWYgKCBvcHRpb25zLnNoYWRvdyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl91aS5jaGlsZFdyYXBwZXIudG9nZ2xlQ2xhc3MoICJ1aS1zaGFkb3ciLCBvcHRpb25zLnNoYWRvdyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmV4Y2x1ZGVJbnZpc2libGUgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5vcHRpb25zLmV4Y2x1ZGVJbnZpc2libGUgPSBvcHRpb25zLmV4Y2x1ZGVJbnZpc2libGU7CgkJCWNhbGxSZWZyZXNoID0gdHJ1ZTsKCQl9CgoJCXJldHVyblZhbHVlID0gdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJaWYgKCBjYWxsUmVmcmVzaCApIHsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJfQoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9LAoKCWNvbnRhaW5lcjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3VpLmNoaWxkV3JhcHBlcjsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuY29udGFpbmVyKCksCgkJCWVscyA9ICRlbC5maW5kKCAiLnVpLWJ0biIgKS5ub3QoICIudWktc2xpZGVyLWhhbmRsZSIgKSwKCQkJY3JlYXRlID0gdGhpcy5faW5pdGlhbFJlZnJlc2g7CgkJaWYgKCAkLm1vYmlsZS5jaGVja2JveHJhZGlvICkgewoJCQkkZWwuZmluZCggIjptb2JpbGUtY2hlY2tib3hyYWRpbyIgKS5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCQl9CgkJdGhpcy5fYWRkRmlyc3RMYXN0Q2xhc3NlcyggZWxzLAoJCQl0aGlzLm9wdGlvbnMuZXhjbHVkZUludmlzaWJsZSA/IHRoaXMuX2dldFZpc2libGVzKCBlbHMsIGNyZWF0ZSApIDogZWxzLAoJCQljcmVhdGUgKTsKCQl0aGlzLl9pbml0aWFsUmVmcmVzaCA9IGZhbHNlOwoJfSwKCgkvLyBDYXZlYXQ6IElmIHRoZSBsZWdlbmQgaXMgbm90IHRoZSBmaXJzdCBjaGlsZCBvZiB0aGUgY29udHJvbGdyb3VwIGF0IGVuaGFuY2UKCS8vIHRpbWUsIGl0IHdpbGwgYmUgYWZ0ZXIgX2Rlc3Ryb3koKS4KCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgdWksIGJ1dHRvbnMsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggb3B0cy5lbmhhbmNlZCApIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQl1aSA9IHRoaXMuX3VpOwoJCWJ1dHRvbnMgPSB0aGlzLmVsZW1lbnQKCQkJLnJlbW92ZUNsYXNzKCAidWktY29udHJvbGdyb3VwICIgKwoJCQkJInVpLWNvbnRyb2xncm91cC1ob3Jpem9udGFsIHVpLWNvbnRyb2xncm91cC12ZXJ0aWNhbCB1aS1jb3JuZXItYWxsIHVpLW1pbmkgIiArCgkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggb3B0cy50aGVtZSApICkKCQkJLmZpbmQoICIudWktYnRuIiApCgkJCS5ub3QoICIudWktc2xpZGVyLWhhbmRsZSIgKTsKCgkJdGhpcy5fcmVtb3ZlRmlyc3RMYXN0Q2xhc3NlcyggYnV0dG9ucyApOwoKCQl1aS5ncm91cExlZ2VuZC51bndyYXAoKTsKCQl1aS5jaGlsZFdyYXBwZXIuY2hpbGRyZW4oKS51bndyYXAoKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgKSApOwoKfSkoalF1ZXJ5KTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCSQud2lkZ2V0KCAibW9iaWxlLnRvb2xiYXIiLCB7CgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nZm9vdGVyJyksIDpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiwKCgkJb3B0aW9uczogewoJCQl0aGVtZTogbnVsbCwKCQkJYWRkQmFja0J0bjogZmFsc2UsCgkJCWJhY2tCdG5UaGVtZTogbnVsbCwKCQkJYmFja0J0blRleHQ6ICJCYWNrIgoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbGVmdGJ0biwgcmlnaHRidG4sCgkJCQlyb2xlID0gIHRoaXMuZWxlbWVudC5pcyggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApID8gImhlYWRlciIgOiAiZm9vdGVyIiwKCQkJCXBhZ2UgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICkgewoJCQkJcGFnZSA9IGZhbHNlOwoJCQkJdGhpcy5fb24oIHRoaXMuZG9jdW1lbnQsIHsKCQkJCQkicGFnZXNob3ciOiAicmVmcmVzaCIKCQkJCX0pOwoJCQl9CgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlyb2xlOiByb2xlLAoJCQkJcGFnZTogcGFnZSwKCQkJCWxlZnRidG46IGxlZnRidG4sCgkJCQlyaWdodGJ0bjogcmlnaHRidG4sCgkJCQliYWNrQnRuOiBudWxsCgkJCX0pOwoJCQl0aGlzLmVsZW1lbnQuYXR0ciggInJvbGUiLCByb2xlID09PSAiaGVhZGVyIiA/ICJiYW5uZXIiIDogImNvbnRlbnRpbmZvIiApLmFkZENsYXNzKCAidWktIiArIHJvbGUgKTsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJCXRoaXMuX3NldE9wdGlvbnMoIHRoaXMub3B0aW9ucyApOwoJCX0sCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvICkgewoJCQlpZiAoIG8uYWRkQmFja0J0biAhPT0gdW5kZWZpbmVkICkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuYWRkQmFja0J0biAmJgoJCQkJCXRoaXMucm9sZSA9PT0gImhlYWRlciIgJiYKCQkJCQkkKCAiLnVpLXBhZ2UiICkubGVuZ3RoID4gMSAmJgoJCQkJCXRoaXMucGFnZVsgMCBdLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIgKSAhPT0gJC5tb2JpbGUucGF0aC5zdHJpcEhhc2goIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJCSF0aGlzLmxlZnRidG4gKSB7CgkJCQkJCXRoaXMuX2FkZEJhY2tCdXR0b24oKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5lbGVtZW50LmZpbmQoICIudWktdG9vbGJhci1iYWNrLWJ0biIgKS5yZW1vdmUoKTsKCQkJCX0KCQkJfQoJCQlpZiAoIG8uYmFja0J0blRoZW1lICE9IG51bGwgKSB7CgkJCQl0aGlzLmVsZW1lbnQKCQkJCQkuZmluZCggIi51aS10b29sYmFyLWJhY2stYnRuIiApCgkJCQkJLmFkZENsYXNzKCAidWktYnRuIHVpLWJ0bi0iICsgby5iYWNrQnRuVGhlbWUgKTsKCQkJfQoJCQlpZiAoIG8uYmFja0J0blRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXRvb2xiYXItYmFjay1idG4gLnVpLWJ0bi10ZXh0IiApLnRleHQoIG8uYmFja0J0blRleHQgKTsKCQkJfQoJCQlpZiAoIG8udGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXZhciBjdXJyZW50VGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUgPyB0aGlzLm9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIsCgkJCQkJbmV3VGhlbWUgPSBvLnRoZW1lID8gby50aGVtZSA6ICJpbmhlcml0IjsKCgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1iYXItIiArIGN1cnJlbnRUaGVtZSApLmFkZENsYXNzKCAidWktYmFyLSIgKyBuZXdUaGVtZSApOwoJCQl9CgoJCQl0aGlzLl9zdXBlciggbyApOwoJCX0sCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy5yb2xlID09PSAiaGVhZGVyIiApIHsKCQkJCXRoaXMuX2FkZEhlYWRlckJ1dHRvbkNsYXNzZXMoKTsKCQkJfQoJCQlpZiAoICF0aGlzLnBhZ2UgKSB7CgkJCQl0aGlzLl9zZXRSZWxhdGl2ZSgpOwoJCQkJaWYgKCB0aGlzLnJvbGUgPT09ICJmb290ZXIiICkgewoJCQkJCXRoaXMuZWxlbWVudC5hcHBlbmRUbyggImJvZHkiICk7CgkJCQl9CgkJCX0KCQkJdGhpcy5fYWRkSGVhZGluZ0NsYXNzZXMoKTsKCQkJdGhpcy5fYnRuTWFya3VwKCk7CgkJfSwKCgkJLy93ZSBvbmx5IHdhbnQgdGhpcyB0byBydW4gb24gbm9uIGZpeGVkIHRvb2xiYXJzIHNvIG1ha2UgaXQgZWFzeSB0byBvdmVycmlkZQoJCV9zZXRSZWxhdGl2ZTogZnVuY3Rpb24oKSB7CgkJCSQoICJbZGF0YS0iKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJ10iICkuY3NzKHsgInBvc2l0aW9uIjogInJlbGF0aXZlIiB9KTsKCQl9LAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNC4gQXMgZnJvbSAxLjUgYnV0dG9uIGNsYXNzZXMgaGF2ZSB0byBiZSBwcmVzZW50IGluIHRoZSBtYXJrdXAuCgkJX2J0bk1hcmt1cDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5jaGlsZHJlbiggImEiICkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGUiLCAiYnV0dG9uIiApOwoJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggImNyZWF0ZSIgKTsKCQl9LAoJCS8vIERlcHJlY2F0ZWQgaW4gMS40LiBBcyBmcm9tIDEuNSB1aS1idG4tbGVmdC9yaWdodCBjbGFzc2VzIGhhdmUgdG8gYmUgcHJlc2VudCBpbiB0aGUgbWFya3VwLgoJCV9hZGRIZWFkZXJCdXR0b25DbGFzc2VzOiBmdW5jdGlvbigpIHsKCQkJdmFyICRoZWFkZXJhbmNob3JzID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiYSwgYnV0dG9uIiApOwoJCQl0aGlzLmxlZnRidG4gPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1sZWZ0IiApOwoJCQl0aGlzLnJpZ2h0YnRuID0gJGhlYWRlcmFuY2hvcnMuaGFzQ2xhc3MoICJ1aS1idG4tcmlnaHQiICk7CgoJCQl0aGlzLnJpZ2h0YnRuID0gdGhpcy5yaWdodGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMCApLm5vdCggIi51aS1idG4tbGVmdCIgKS5hZGRDbGFzcyggInVpLWJ0bi1yaWdodCIgKS5sZW5ndGg7CgoJCQl0aGlzLmxlZnRidG4gPSB0aGlzLmxlZnRidG4gfHwgJGhlYWRlcmFuY2hvcnMuZXEoIDEgKS5hZGRDbGFzcyggInVpLWJ0bi1sZWZ0IiApLmxlbmd0aDsKCgkJfSwKCQlfYWRkQmFja0J1dHRvbjogZnVuY3Rpb24oKSB7CgkJCXZhciB0aGVtZSwKCQkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCQlpZiAoICF0aGlzLmJhY2tCdG4gKSB7CgkJCQl0aGVtZSA9IG9wdGlvbnMuYmFja0J0blRoZW1lIHx8IG9wdGlvbnMudGhlbWU7CgkJCQl0aGlzLmJhY2tCdG4gPSAkKCAiPGEgcm9sZT0nYnV0dG9uJyBocmVmPSdqYXZhc2NyaXB0OnZvaWQoMCk7JyAiICsKCQkJCQkiY2xhc3M9J3VpLWJ0biB1aS1jb3JuZXItYWxsIHVpLXNoYWRvdyB1aS1idG4tcmlnaHQgIiArCgkJCQkJCSggdGhlbWUgPyAidWktYnRuLSIgKyB0aGVtZSArICIgIiA6ICIiICkgKwoJCQkJCQkidWktdG9vbGJhci1iYWNrLWJ0biB1aS1pY29uLWNhcmF0LXIgdWktYnRuLWljb24tcmlnaHQnICIgKwoJCQkJCSJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWw9J2JhY2snPiIgKyBvcHRpb25zLmJhY2tCdG5UZXh0ICsgIjwvYT4iICkKCQkJCQkJLnByZXBlbmRUbyggdGhpcy5lbGVtZW50ICk7CgkJCX0KCQl9LAoJCV9hZGRIZWFkaW5nQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5jaGlsZHJlbiggImgxLCBoMiwgaDMsIGg0LCBoNSwgaDYiICkKCQkJCS5hZGRDbGFzcyggInVpLXRpdGxlIiApCgkJCQkvLyBSZWdhcmRsZXNzIG9mIGggZWxlbWVudCBudW1iZXIgaW4gc3JjLCBpdCBiZWNvbWVzIGgxIGZvciB0aGUgZW5oYW5jZWQgcGFnZQoJCQkJLmF0dHIoewoJCQkJCSJyb2xlIjogImhlYWRpbmciLAoJCQkJCSJhcmlhLWxldmVsIjogIjEiCgkJCQl9KTsKCQl9Cgl9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCSQud2lkZ2V0KCAibW9iaWxlLnRvb2xiYXIiLCAkLm1vYmlsZS50b29sYmFyLCB7CgkJb3B0aW9uczogewoJCQlwb3NpdGlvbjpudWxsLAoJCQl2aXNpYmxlT25QYWdlU2hvdzogdHJ1ZSwKCQkJZGlzYWJsZVBhZ2Vab29tOiB0cnVlLAoJCQl0cmFuc2l0aW9uOiAic2xpZGUiLCAvL2NhbiBiZSBub25lLCBmYWRlLCBzbGlkZSAoc2xpZGUgbWFwcyB0byBzbGlkZXVwIG9yIHNsaWRlZG93bikKCQkJZnVsbHNjcmVlbjogZmFsc2UsCgkJCXRhcFRvZ2dsZTogdHJ1ZSwKCQkJdGFwVG9nZ2xlQmxhY2tsaXN0OiAiYSwgYnV0dG9uLCBpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSwgLnVpLWhlYWRlci1maXhlZCwgLnVpLWZvb3Rlci1maXhlZCwgLnVpLWZsaXBzd2l0Y2gsIC51aS1wb3B1cCwgLnVpLXBhbmVsLCAudWktcGFuZWwtZGlzbWlzcy1vcGVuIiwKCQkJaGlkZUR1cmluZ0ZvY3VzOiAiaW5wdXQsIHRleHRhcmVhLCBzZWxlY3QiLAoJCQl1cGRhdGVQYWdlUGFkZGluZzogdHJ1ZSwKCQkJdHJhY2tQZXJzaXN0ZW50VG9vbGJhcnM6IHRydWUsCgoJCQkvLyBCcm93c2VyIGRldGVjdGlvbiEgV2VlZWUsIGhlcmUgd2UgZ28uLi4KCQkJLy8gVW5mb3J0dW5hdGVseSwgcG9zaXRpb246Zml4ZWQgaXMgY29zdGx5LCBub3QgdG8gbWVudGlvbiBwcm9iYWJseSBpbXBvc3NpYmxlLCB0byBmZWF0dXJlLWRldGVjdCBhY2N1cmF0ZWx5LgoJCQkvLyBTb21lIHRlc3RzIGV4aXN0LCBidXQgdGhleSBjdXJyZW50bHkgcmV0dXJuIGZhbHNlIHJlc3VsdHMgaW4gY3JpdGljYWwgZGV2aWNlcyBhbmQgYnJvd3NlcnMsIHdoaWNoIGNvdWxkIGxlYWQgdG8gYSBicm9rZW4gZXhwZXJpZW5jZS4KCQkJLy8gVGVzdGluZyBmaXhlZCBwb3NpdGlvbmluZyBpcyBhbHNvIHByZXR0eSBvYnRydXNpdmUgdG8gcGFnZSBsb2FkLCByZXF1aXJpbmcgaW5qZWN0ZWQgZWxlbWVudHMgYW5kIHNjcm9sbGluZyB0aGUgd2luZG93CgkJCS8vIFRoZSBmb2xsb3dpbmcgZnVuY3Rpb24gc2VydmVzIHRvIHJ1bGUgb3V0IHNvbWUgcG9wdWxhciBicm93c2VycyB3aXRoIGtub3duIGZpeGVkLXBvc2l0aW9uaW5nIGlzc3VlcwoJCQkvLyBUaGlzIGlzIGEgcGx1Z2luIG9wdGlvbiBsaWtlIGFueSBvdGhlciwgc28gZmVlbCBmcmVlIHRvIGltcHJvdmUgb3Igb3ZlcndyaXRlIGl0CgkJCXN1cHBvcnRCbGFja2xpc3Q6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICEkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbjsKCQkJfQoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQlpZiAoIHRoaXMub3B0aW9ucy5wb3NpdGlvbiA9PT0gImZpeGVkIiAmJiAhdGhpcy5vcHRpb25zLnN1cHBvcnRCbGFja2xpc3QoKSApIHsKCQkJCXRoaXMuX21ha2VGaXhlZCgpOwoJCQl9CgkJfSwKCgkJX21ha2VGaXhlZDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLSIrIHRoaXMucm9sZSArIi1maXhlZCIgKTsKCQkJdGhpcy51cGRhdGVQYWdlUGFkZGluZygpOwoJCQl0aGlzLl9hZGRUcmFuc2l0aW9uQ2xhc3MoKTsKCQkJdGhpcy5fYmluZFBhZ2VFdmVudHMoKTsKCQkJdGhpcy5fYmluZFRvZ2dsZUhhbmRsZXJzKCk7CgkJCXRoaXMuX3NldE9wdGlvbnMoIHRoaXMub3B0aW9ucyApOwoJCX0sCgoJCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggbyApIHsKCQkJaWYgKCBvLnBvc2l0aW9uID09PSAiZml4ZWQiICYmIHRoaXMub3B0aW9ucy5wb3NpdGlvbiAhPT0gImZpeGVkIiApIHsKCQkJCXRoaXMuX21ha2VGaXhlZCgpOwoJCQl9CgkJCWlmICggdGhpcy5vcHRpb25zLnBvc2l0aW9uID09PSAiZml4ZWQiICYmICF0aGlzLm9wdGlvbnMuc3VwcG9ydEJsYWNrbGlzdCgpICkgewoJCQkJdmFyICRwYWdlID0gKCAhIXRoaXMucGFnZSApPyB0aGlzLnBhZ2U6ICggJCgiLnVpLXBhZ2UtYWN0aXZlIikubGVuZ3RoID4gMCApPyAkKCIudWktcGFnZS1hY3RpdmUiKTogJCgiLnVpLXBhZ2UiKS5lcSgwKTsKCgkJCQlpZiAoIG8uZnVsbHNjcmVlbiAhPT0gdW5kZWZpbmVkKSB7CgkJCQkJaWYgKCBvLmZ1bGxzY3JlZW4gKSB7CgkJCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLSIrIHRoaXMucm9sZSArIi1mdWxsc2NyZWVuIiApOwoJCQkJCQkkcGFnZS5hZGRDbGFzcyggInVpLXBhZ2UtIiArIHRoaXMucm9sZSArICItZnVsbHNjcmVlbiIgKTsKCQkJCQl9CgkJCQkJLy8gSWYgbm90IGZ1bGxzY3JlZW4sIGFkZCBjbGFzcyB0byBwYWdlIHRvIHNldCB0b3Agb3IgYm90dG9tIHBhZGRpbmcKCQkJCQllbHNlIHsKCQkJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktIisgdGhpcy5yb2xlICsiLWZ1bGxzY3JlZW4iICk7CgkJCQkJCSRwYWdlLnJlbW92ZUNsYXNzKCAidWktcGFnZS0iICsgdGhpcy5yb2xlICsgIi1mdWxsc2NyZWVuIiApLmFkZENsYXNzKCAidWktcGFnZS0iICsgdGhpcy5yb2xlKyAiLWZpeGVkIiApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQl0aGlzLl9zdXBlcihvKTsKCQl9LAoKCQlfYWRkVHJhbnNpdGlvbkNsYXNzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRjbGFzcyA9IHRoaXMub3B0aW9ucy50cmFuc2l0aW9uOwoKCQkJaWYgKCB0Y2xhc3MgJiYgdGNsYXNzICE9PSAibm9uZSIgKSB7CgkJCQkvLyB1c2UgYXBwcm9wcmlhdGUgc2xpZGUgZm9yIGhlYWRlciBvciBmb290ZXIKCQkJCWlmICggdGNsYXNzID09PSAic2xpZGUiICkgewoJCQkJCXRjbGFzcyA9IHRoaXMuZWxlbWVudC5oYXNDbGFzcyggInVpLWhlYWRlciIgKSA/ICJzbGlkZWRvd24iIDogInNsaWRldXAiOwoJCQkJfQoKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGNsYXNzICk7CgkJCX0KCQl9LAoKCQlfYmluZFBhZ2VFdmVudHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgcGFnZSA9ICggISF0aGlzLnBhZ2UgKT8gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTogdGhpcy5kb2N1bWVudDsKCQkJLy9wYWdlIGV2ZW50IGJpbmRpbmdzCgkJCS8vIEZpeGVkIHRvb2xiYXJzIHJlcXVpcmUgcGFnZSB6b29tIHRvIGJlIGRpc2FibGVkLCBvdGhlcndpc2UgdXNhYmlsaXR5IGlzc3VlcyBjcm9wIHVwCgkJCS8vIFRoaXMgbWV0aG9kIGlzIG1lYW50IHRvIGRpc2FibGUgem9vbSB3aGlsZSBhIGZpeGVkLXBvc2l0aW9uZWQgdG9vbGJhciBwYWdlIGlzIHZpc2libGUKCQkJdGhpcy5fb24oIHBhZ2UgLCB7CgkJCQkicGFnZWJlZm9yZXNob3ciOiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IiwKCQkJCSJ3ZWJraXRBbmltYXRpb25TdGFydCI6Il9oYW5kbGVBbmltYXRpb25TdGFydCIsCgkJCQkiYW5pbWF0aW9uc3RhcnQiOiJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInVwZGF0ZWxheW91dCI6ICJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInBhZ2VzaG93IjogIl9oYW5kbGVQYWdlU2hvdyIsCgkJCQkicGFnZWJlZm9yZWhpZGUiOiAiX2hhbmRsZVBhZ2VCZWZvcmVIaWRlIgoJCQl9KTsKCQl9LAoKCQlfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCApIHsKCQkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7CgkJCWlmICggby5kaXNhYmxlUGFnZVpvb20gKSB7CgkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCQlpZiAoICFvLnZpc2libGVPblBhZ2VTaG93ICkgewoJCQkJdGhpcy5oaWRlKCB0cnVlICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlQW5pbWF0aW9uU3RhcnQ6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHRoaXMub3B0aW9ucy51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCXRoaXMudXBkYXRlUGFnZVBhZGRpbmcoICggISF0aGlzLnBhZ2UgKT8gdGhpcy5wYWdlOiAiLnVpLXBhZ2UtYWN0aXZlIiApOwoJCQl9CgkJfSwKCgkJX2hhbmRsZVBhZ2VTaG93OiBmdW5jdGlvbigpIHsKCQkJdGhpcy51cGRhdGVQYWdlUGFkZGluZyggKCAhIXRoaXMucGFnZSApPyB0aGlzLnBhZ2U6ICIudWktcGFnZS1hY3RpdmUiICk7CgkJCWlmICggdGhpcy5vcHRpb25zLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7ICJ0aHJvdHRsZWRyZXNpemUiOiAidXBkYXRlUGFnZVBhZGRpbmciIH0gKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVQYWdlQmVmb3JlSGlkZTogZnVuY3Rpb24oIGUsIHVpICkgewoJCQl2YXIgbyA9IHRoaXMub3B0aW9ucywKCQkJCXRoaXNGb290ZXIsIHRoaXNIZWFkZXIsIG5leHRGb290ZXIsIG5leHRIZWFkZXI7CgoJCQlpZiAoIG8uZGlzYWJsZVBhZ2Vab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJfQoJCQlpZiAoIG8udXBkYXRlUGFnZVBhZGRpbmcgKSB7CgkJCQl0aGlzLl9vZmYoIHRoaXMud2luZG93LCAidGhyb3R0bGVkcmVzaXplIiApOwoJCQl9CgoJCQlpZiAoIG8udHJhY2tQZXJzaXN0ZW50VG9vbGJhcnMgKSB7CgkJCQl0aGlzRm9vdGVyID0gJCggIi51aS1mb290ZXItZml4ZWQ6anFtRGF0YShpZCkiLCB0aGlzLnBhZ2UgKTsKCQkJCXRoaXNIZWFkZXIgPSAkKCAiLnVpLWhlYWRlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMucGFnZSApOwoJCQkJbmV4dEZvb3RlciA9IHRoaXNGb290ZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktZm9vdGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzRm9vdGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpOwoJCQkJbmV4dEhlYWRlciA9IHRoaXNIZWFkZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzSGVhZGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpOwoKCQkJCWlmICggbmV4dEZvb3Rlci5sZW5ndGggfHwgbmV4dEhlYWRlci5sZW5ndGggKSB7CgoJCQkJCW5leHRGb290ZXIuYWRkKCBuZXh0SGVhZGVyICkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCQkJdWkubmV4dFBhZ2Uub25lKCAicGFnZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCQkJbmV4dEhlYWRlci5wcmVwZW5kVG8oIHRoaXMgKTsKCQkJCQkJbmV4dEZvb3Rlci5hcHBlbmRUbyggdGhpcyApOwoJCQkJCX0pOwoJCQkJfQoJCQl9CgkJfSwKCgkJX3Zpc2libGU6IHRydWUsCgoJCS8vIFRoaXMgd2lsbCBzZXQgdGhlIGNvbnRlbnQgZWxlbWVudCdzIHRvcCBvciBib3R0b20gcGFkZGluZyBlcXVhbCB0byB0aGUgdG9vbGJhcidzIGhlaWdodAoJCXVwZGF0ZVBhZ2VQYWRkaW5nOiBmdW5jdGlvbiggdGJQYWdlICkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gKCB0aGlzLnJvbGUgPT09ImhlYWRlciIgKSwKCQkJCXBvcyA9IHBhcnNlRmxvYXQoICRlbC5jc3MoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSApOwoKCQkJLy8gVGhpcyBiZWhhdmlvciBvbmx5IGFwcGxpZXMgdG8gImZpeGVkIiwgbm90ICJmdWxsc2NyZWVuIgoJCQlpZiAoIHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICkgeyByZXR1cm47IH0KCQkJLy8gdGJQYWdlIGFyZ3VtZW50IGNhbiBiZSBhIFBhZ2Ugb2JqZWN0IG9yIGFuIGV2ZW50LCBpZiBjb21pbmcgZnJvbSB0aHJvdHRsZWQgcmVzaXplLgoJCQl0YlBhZ2UgPSAoIHRiUGFnZSAmJiB0YlBhZ2UudHlwZSA9PT0gdW5kZWZpbmVkICYmIHRiUGFnZSApIHx8IHRoaXMucGFnZSB8fCAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCQl0YlBhZ2UgPSAoICEhdGhpcy5wYWdlICk/IHRoaXMucGFnZTogIi51aS1wYWdlLWFjdGl2ZSI7CgkJCSQoIHRiUGFnZSApLmNzcyggInBhZGRpbmctIiArICggaGVhZGVyID8gInRvcCIgOiAiYm90dG9tIiApLCAkZWwub3V0ZXJIZWlnaHQoKSArIHBvcyApOwoJCX0sCgoJCV91c2VUcmFuc2l0aW9uOiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgJHdpbiA9IHRoaXMud2luZG93LAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJc2Nyb2xsID0gJHdpbi5zY3JvbGxUb3AoKSwKCQkJCWVsSGVpZ2h0ID0gJGVsLmhlaWdodCgpLAoJCQkJcEhlaWdodCA9ICggISF0aGlzLnBhZ2UgKT8gJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5oZWlnaHQoKTokKCIudWktcGFnZS1hY3RpdmUiKS5oZWlnaHQoKSwKCQkJCXZpZXdwb3J0SGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCQlyZXR1cm4gIW5vdHJhbnNpdGlvbiAmJgoJCQkJKCB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiAmJiB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiAhPT0gIm5vbmUiICYmCgkJCQkoCgkJCQkJKCB0aGlzLnJvbGUgPT09ICJoZWFkZXIiICYmICF0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiAmJiBzY3JvbGwgPiBlbEhlaWdodCApIHx8CgkJCQkJKCB0aGlzLnJvbGUgPT09ICJmb290ZXIiICYmICF0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiAmJiBzY3JvbGwgKyB2aWV3cG9ydEhlaWdodCA8IHBIZWlnaHQgLSBlbEhlaWdodCApCgkJCQkpIHx8IHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuCgkJCQkpOwoJCX0sCgoJCXNob3c6IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKSB7CgkJCXZhciBoaWRlQ2xhc3MgPSAidWktZml4ZWQtaGlkZGVuIiwKCQkJCSRlbCA9IHRoaXMuZWxlbWVudDsKCgkJCWlmICggdGhpcy5fdXNlVHJhbnNpdGlvbiggbm90cmFuc2l0aW9uICkgKSB7CgkJCQkkZWwKCQkJCQkucmVtb3ZlQ2xhc3MoICJvdXQgIiArIGhpZGVDbGFzcyApCgkJCQkJLmFkZENsYXNzKCAiaW4iICkKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24gKCkgewoJCQkJCQkkZWwucmVtb3ZlQ2xhc3MoICJpbiIgKTsKCQkJCQl9KTsKCQkJfQoJCQllbHNlIHsKCQkJCSRlbC5yZW1vdmVDbGFzcyggaGlkZUNsYXNzICk7CgkJCX0KCQkJdGhpcy5fdmlzaWJsZSA9IHRydWU7CgkJfSwKCgkJaGlkZTogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyIGhpZGVDbGFzcyA9ICJ1aS1maXhlZC1oaWRkZW4iLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJLy8gaWYgaXQncyBhIHNsaWRlIHRyYW5zaXRpb24sIG91ciBuZXcgdHJhbnNpdGlvbnMgbmVlZCB0aGUgcmV2ZXJzZSBjbGFzcyBhcyB3ZWxsIHRvIHNsaWRlIG91dHdhcmQKCQkJCW91dGNsYXNzID0gIm91dCIgKyAoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uID09PSAic2xpZGUiID8gIiByZXZlcnNlIiA6ICIiICk7CgoJCQlpZiAoIHRoaXMuX3VzZVRyYW5zaXRpb24oIG5vdHJhbnNpdGlvbiApICkgewoJCQkJJGVsCgkJCQkJLmFkZENsYXNzKCBvdXRjbGFzcyApCgkJCQkJLnJlbW92ZUNsYXNzKCAiaW4iICkKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24oKSB7CgkJCQkJCSRlbC5hZGRDbGFzcyggaGlkZUNsYXNzICkucmVtb3ZlQ2xhc3MoIG91dGNsYXNzICk7CgkJCQkJfSk7CgkJCX0KCQkJZWxzZSB7CgkJCQkkZWwuYWRkQ2xhc3MoIGhpZGVDbGFzcyApLnJlbW92ZUNsYXNzKCBvdXRjbGFzcyApOwoJCQl9CgkJCXRoaXMuX3Zpc2libGUgPSBmYWxzZTsKCQl9LAoKCQl0b2dnbGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzWyB0aGlzLl92aXNpYmxlID8gImhpZGUiIDogInNob3ciIF0oKTsKCQl9LAoKCQlfYmluZFRvZ2dsZUhhbmRsZXJzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbyA9IHNlbGYub3B0aW9ucywKCQkJCWRlbGF5U2hvdywgZGVsYXlIaWRlLAoJCQkJaXNWaXNpYmxlID0gdHJ1ZSwKCQkJCXBhZ2UgPSAoICEhdGhpcy5wYWdlICk/IHRoaXMucGFnZTogJCgiLnVpLXBhZ2UiKTsKCgkJCS8vIHRhcCB0b2dnbGUKCQkJcGFnZQoJCQkJLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQkJCQlpZiAoIG8udGFwVG9nZ2xlICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoIG8udGFwVG9nZ2xlQmxhY2tsaXN0ICkubGVuZ3RoICkgewoJCQkJCQlzZWxmLnRvZ2dsZSgpOwoJCQkJCX0KCQkJCX0pCgkJCQkuYmluZCggImZvY3VzaW4gZm9jdXNvdXQiLCBmdW5jdGlvbiggZSApIHsKCQkJCQkvL3RoaXMgaGlkZXMgdGhlIHRvb2xiYXJzIG9uIGEga2V5Ym9hcmQgcG9wIHRvIGdpdmUgbW9yZSBzY3JlZW4gcm9vbSBhbmQgcHJldmVudCBpb3MgYnVnIHdoaWNoCgkJCQkJLy9wb3NpdGlvbnMgZml4ZWQgdG9vbGJhcnMgaW4gdGhlIG1pZGRsZSBvZiB0aGUgc2NyZWVuIG9uIHBvcCBpZiB0aGUgaW5wdXQgaXMgbmVhciB0aGUgdG9wIG9yCgkJCQkJLy9ib3R0b20gb2YgdGhlIHNjcmVlbiBhZGRyZXNzZXMgaXNzdWVzICM0NDEwIEZvb3RlciBuYXZiYXIgbW92ZXMgdXAgd2hlbiBjbGlja2luZyBvbiBhIHRleHRib3ggaW4gYW4gQW5kcm9pZCBlbnZpcm9ubWVudAoJCQkJCS8vYW5kIGlzc3VlICM0MTEzIEhlYWRlciBhbmQgZm9vdGVyIGNoYW5nZSB0aGVpciBwb3NpdGlvbiBhZnRlciBrZXlib2FyZCBwb3B1cCAtIGlPUwoJCQkJCS8vYW5kIGlzc3VlICM0NDEwIEZvb3RlciBuYXZiYXIgbW92ZXMgdXAgd2hlbiBjbGlja2luZyBvbiBhIHRleHRib3ggaW4gYW4gQW5kcm9pZCBlbnZpcm9ubWVudAoJCQkJCWlmICggc2NyZWVuLndpZHRoIDwgMTAyNSAmJiAkKCBlLnRhcmdldCApLmlzKCBvLmhpZGVEdXJpbmdGb2N1cyApICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoICIudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkIiApLmxlbmd0aCApIHsKCQkJCQkJLy9GaXggZm9yIGlzc3VlICM0NzI0IE1vdmluZyB0aHJvdWdoIGZvcm0gaW4gTW9iaWxlIFNhZmFyaSB3aXRoICJOZXh0IiBhbmQgIlByZXZpb3VzIiBzeXN0ZW0KCQkJCQkJLy9jb250cm9scyBjYXVzZXMgZml4ZWQgcG9zaXRpb24sIHRhcC10b2dnbGUgZmFsc2UgSGVhZGVyIHRvIHJldmVhbCBpdHNlbGYKCQkJCQkJLy8gaXNWaXNpYmxlIGluc3RlYWQgb2Ygc2VsZi5fdmlzaWJsZSBiZWNhdXNlIHRoZSBmb2N1c2luIGFuZCBmb2N1c291dCBldmVudHMgZmlyZSB0d2ljZSBhdCB0aGUgc2FtZSB0aW1lCgkJCQkJCS8vIEFsc28gdXNlIGEgZGVsYXkgZm9yIGhpZGluZyB0aGUgdG9vbGJhcnMgYmVjYXVzZSBvbiBBbmRyb2lkIG5hdGl2ZSBicm93c2VyIGZvY3VzaW4gaXMgZGlyZWNsdHkgZm9sbG93ZWQKCQkJCQkJLy8gYnkgYSBmb2N1c291dCB3aGVuIGEgbmF0aXZlIHNlbGVjdHMgb3BlbnMgYW5kIHRoZSBvdGhlciB3YXkgYXJvdW5kIHdoZW4gaXQgY2xvc2VzLgoJCQkJCQlpZiAoIGUudHlwZSA9PT0gImZvY3Vzb3V0IiAmJiAhaXNWaXNpYmxlICkgewoJCQkJCQkJaXNWaXNpYmxlID0gdHJ1ZTsKCQkJCQkJCS8vd2FpdCBmb3IgdGhlIHN0YWNrIHRvIHVud2luZCBhbmQgc2VlIGlmIHdlIGhhdmUganVtcGVkIHRvIGFub3RoZXIgaW5wdXQKCQkJCQkJCWNsZWFyVGltZW91dCggZGVsYXlIaWRlICk7CgkJCQkJCQlkZWxheVNob3cgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCQlzZWxmLnNob3coKTsKCQkJCQkJCX0sIDAgKTsKCQkJCQkJfSBlbHNlIGlmICggZS50eXBlID09PSAiZm9jdXNpbiIgJiYgISFpc1Zpc2libGUgKSB7CgkJCQkJCQkvL2lmIHdlIGhhdmUganVtcGVkIHRvIGFub3RoZXIgaW5wdXQgY2xlYXIgdGhlIHRpbWUgb3V0IHRvIGNhbmNlbCB0aGUgc2hvdy4KCQkJCQkJCWNsZWFyVGltZW91dCggZGVsYXlTaG93ICk7CgkJCQkJCQlpc1Zpc2libGUgPSBmYWxzZTsKCQkJCQkJCWRlbGF5SGlkZSA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJCXNlbGYuaGlkZSgpOwoJCQkJCQkJfSwgMCApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSk7CgkJfSwKCgkJX3NldFJlbGF0aXZlOiBmdW5jdGlvbigpIHsKCQkJaWYoIHRoaXMub3B0aW9ucy5wb3NpdGlvbiAhPT0gImZpeGVkIiApewoJCQkJJCggIltkYXRhLSIrICQubW9iaWxlLm5zICsgInJvbGU9J3BhZ2UnXSIgKS5jc3MoeyAicG9zaXRpb24iOiAicmVsYXRpdmUiIH0pOwoJCQl9CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gJGVsLmhhc0NsYXNzKCAidWktaGVhZGVyIiApOwoKCQkJJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5jc3MoICJwYWRkaW5nLSIgKyAoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSwgIiIgKTsKCQkJJGVsLnJlbW92ZUNsYXNzKCAidWktaGVhZGVyLWZpeGVkIHVpLWZvb3Rlci1maXhlZCB1aS1oZWFkZXItZnVsbHNjcmVlbiB1aS1mb290ZXItZnVsbHNjcmVlbiBpbiBvdXQgZmFkZSBzbGlkZWRvd24gc2xpZGV1cCB1aS1maXhlZC1oaWRkZW4iICk7CgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkucmVtb3ZlQ2xhc3MoICJ1aS1wYWdlLWhlYWRlci1maXhlZCB1aS1wYWdlLWZvb3Rlci1maXhlZCB1aS1wYWdlLWhlYWRlci1mdWxsc2NyZWVuIHVpLXBhZ2UtZm9vdGVyLWZ1bGxzY3JlZW4iICk7CgkJfQoKCX0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCSQud2lkZ2V0KCAibW9iaWxlLnRvb2xiYXIiLCAkLm1vYmlsZS50b29sYmFyLCB7CgoJCV9tYWtlRml4ZWQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQl0aGlzLl93b3JrYXJvdW5kcygpOwoJCX0sCgoJCS8vY2hlY2sgdGhlIGJyb3dzZXIgYW5kIHZlcnNpb24gYW5kIHJ1biBuZWVkZWQgd29ya2Fyb3VuZHMKCQlfd29ya2Fyb3VuZHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCQlwbGF0Zm9ybSA9IG5hdmlnYXRvci5wbGF0Zm9ybSwKCQkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XSspLyApLAoJCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCQlvcyA9IG51bGwsCgkJCXNlbGYgPSB0aGlzOwoJCQkvL3NldCB0aGUgb3Mgd2UgYXJlIHdvcmtpbmcgaW4gaWYgaXQgZG9zZW50IG1hdGNoIG9uZSB3aXRoIHdvcmthcm91bmRzIHJldHVybgoJCQlpZiAoIHBsYXRmb3JtLmluZGV4T2YoICJpUGhvbmUiICkgPiAtMSB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBhZCIgKSA+IC0xICB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBvZCIgKSA+IC0xICkgewoJCQkJb3MgPSAiaW9zIjsKCQkJfSBlbHNlIGlmICggdWEuaW5kZXhPZiggIkFuZHJvaWQiICkgPiAtMSApIHsKCQkJCW9zID0gImFuZHJvaWQiOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuOwoJCQl9CgkJCS8vY2hlY2sgb3MgdmVyc2lvbiBpZiBpdCBkb3NlbnQgbWF0Y2ggb25lIHdpdGggd29ya2Fyb3VuZHMgcmV0dXJuCgkJCWlmICggb3MgPT09ICJpb3MiICkgewoJCQkJLy9pT1MgIHdvcmthcm91bmRzCgkJCQlzZWxmLl9iaW5kU2Nyb2xsV29ya2Fyb3VuZCgpOwoJCQl9IGVsc2UgaWYgKCBvcyA9PT0gImFuZHJvaWQiICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKSB7CgkJCQkvL0FuZHJvaWQgMi4zIHJ1biBhbGwgQW5kcm9pZCAyLjMgd29ya2Fyb3VuZAoJCQkJc2VsZi5fYmluZFNjcm9sbFdvcmthcm91bmQoKTsKCQkJCXNlbGYuX2JpbmRMaXN0VGh1bWJXb3JrYXJvdW5kKCk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm47CgkJCX0KCQl9LAoKCQkvL1V0aWxpdHkgY2xhc3MgZm9yIGNoZWNraW5nIGhlYWRlciBhbmQgZm9vdGVyIHBvc2l0aW9ucyByZWxhdGl2ZSB0byB2aWV3cG9ydAoJCV92aWV3cG9ydE9mZnNldDogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQloZWFkZXIgPSAkZWwuaGFzQ2xhc3MoICJ1aS1oZWFkZXIiICksCgkJCQlvZmZzZXQgPSBNYXRoLmFicyggJGVsLm9mZnNldCgpLnRvcCAtIHRoaXMud2luZG93LnNjcm9sbFRvcCgpICk7CgkJCWlmICggIWhlYWRlciApIHsKCQkJCW9mZnNldCA9IE1hdGgucm91bmQoIG9mZnNldCAtIHRoaXMud2luZG93LmhlaWdodCgpICsgJGVsLm91dGVySGVpZ2h0KCkgKSAtIDYwOwoJCQl9CgkJCXJldHVybiBvZmZzZXQ7CgkJfSwKCgkJLy9iaW5kIGV2ZW50cyBmb3IgX3RyaWdnZXJSZWRyYXcoKSBmdW5jdGlvbgoJCV9iaW5kU2Nyb2xsV29ya2Fyb3VuZDogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJLy9iaW5kIHRvIHNjcm9sbHN0b3AgYW5kIGNoZWNrIGlmIHRoZSB0b29sYmFycyBhcmUgY29ycmVjdGx5IHBvc2l0aW9uZWQKCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7IHNjcm9sbHN0b3A6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHZpZXdwb3J0T2Zmc2V0ID0gc2VsZi5fdmlld3BvcnRPZmZzZXQoKTsKCQkJCS8vY2hlY2sgaWYgdGhlIGhlYWRlciBpcyB2aXNpYmxlIGFuZCBpZiBpdHMgaW4gdGhlIHJpZ2h0IHBsYWNlCgkJCQlpZiAoIHZpZXdwb3J0T2Zmc2V0ID4gMiAmJiBzZWxmLl92aXNpYmxlICkgewoJCQkJCXNlbGYuX3RyaWdnZXJSZWRyYXcoKTsKCQkJCX0KCQkJfX0pOwoJCX0sCgoJCS8vdGhpcyBhZGRyZXNzZXMgaXNzdWUgIzQyNTAgUGVyc2lzdGVudCBmb290ZXIgaW5zdGFiaWxpdHkgaW4gdjEuMSB3aXRoIGxvbmcgc2VsZWN0IGxpc3RzIGluIEFuZHJvaWQgMi4zLjMKCQkvL2FuZCBpc3N1ZSAjMzc0OCBBbmRyb2lkIDIueDogUGFnZSB0cmFuc2l0aW9ucyBicm9rZW4gd2hlbiBmaXhlZCB0b29sYmFycyB1c2VkCgkJLy90aGUgYWJzb2x1dGVseSBwb3NpdGlvbmVkIHRodW1ibmFpbCBpbiBhIGxpc3QgdmlldyBjYXVzZXMgcHJvYmxlbXMgd2l0aCBmaXhlZCBwb3NpdGlvbiBidXR0b25zIGFib3ZlIGluIGEgbmF2IGJhcgoJCS8vc2V0dGluZyB0aGUgbGkncyB0byAtd2Via2l0LXRyYW5zZm9ybTp0cmFuc2xhdGUzZCgwLDAsMCk7IHNvbHZlcyB0aGlzIHByb2JsZW0gdG8gYXZvaWRlIHBvdGVudGlhbCBpc3N1ZXMgaW4gb3RoZXIKCQkvL3BsYXRmb3JtcyB3ZSBzY29wZSB0aGlzIHdpdGggdGhlIGNsYXNzIHVpLWFuZHJvaWQtMngtZml4CgkJX2JpbmRMaXN0VGh1bWJXb3JrYXJvdW5kOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKS5hZGRDbGFzcyggInVpLWFuZHJvaWQtMngtZml4ZWQiICk7CgkJfSwKCQkvL3RoaXMgYWRkcmVzc2VzIGlzc3VlcyAjNDMzNyBGaXhlZCBoZWFkZXIgcHJvYmxlbSBhZnRlciBzY3JvbGxpbmcgY29udGVudCBvbiBpT1MgYW5kIEFuZHJvaWQKCQkvL2FuZCBkZXZpY2UgYnVncyBwcm9qZWN0IGlzc3VlICMxIEZvcm0gZWxlbWVudHMgY2FuIGxvc2UgY2xpY2sgaGl0IGFyZWEgaW4gcG9zaXRpb246IGZpeGVkIGNvbnRhaW5lcnMuCgkJLy90aGlzIGFsc28gYWRkcmVzc2VzIG5vdCBvbiBmaXhlZCB0b29sYmFycyBwYWdlIGluIGRvY3MKCQkvL2FkZGluZyAxcHggb2YgcGFkZGluZyB0byB0aGUgYm90dG9tIHRoZW4gcmVtb3ZpbmcgaXQgY2F1c2VzIGEgInJlZHJhdyIKCQkvL3doaWNoIHBvc2l0aW9ucyB0aGUgdG9vbGJhcnMgY29ycmVjdGx5ICh0aGV5IHdpbGwgYWx3YXlzIGJlIHZpc3VhbGx5IGNvcnJlY3QpCgkJX3RyaWdnZXJSZWRyYXc6IGZ1bmN0aW9uKCkgewoJCQl2YXIgcGFkZGluZ0JvdHRvbSA9IHBhcnNlRmxvYXQoICQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iICkgKTsKCQkJLy90cmlnZ2VyIHBhZ2UgcmVkcmF3IHRvIGZpeCBpbmNvcnJlY3RseSBwb3NpdGlvbmVkIGZpeGVkIGVsZW1lbnRzCgkJCSQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iLCAoIHBhZGRpbmdCb3R0b20gKyAxICkgKyAicHgiICk7CgkJCS8vaWYgdGhlIHBhZGRpbmcgaXMgcmVzZXQgd2l0aCBvdXQgYSB0aW1lb3V0IHRoZSByZXBvc2l0aW9uIHdpbGwgbm90IG9jY3VyZS4KCQkJLy90aGlzIGlzIGluZGVwZW5kYW50IG9mIEpRTSB0aGUgYnJvd3NlciBzZWVtcyB0byBuZWVkIHRoZSB0aW1lIHRvIHJlYWN0LgoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCSQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iLCBwYWRkaW5nQm90dG9tICsgInB4IiApOwoJCQl9LCAwICk7CgkJfSwKCgkJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJCS8vUmVtb3ZlIHRoZSBjbGFzcyB3ZSBhZGRlZCB0byB0aGUgcGFnZSBwcmV2aW91c2x5IGluIGFuZHJvaWQgMi54CgkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UtYWN0aXZlIiApLnJlbW92ZUNsYXNzKCAidWktYW5kcm9pZC0yeC1maXgiICk7CgkJfQoJfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIGllSGFjayA9ICggJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSAmJiAkLm1vYmlsZS5icm93c2VyLm9sZElFIDw9IDggKSwKCXVpVGVtcGxhdGUgPSAkKAoJCSI8ZGl2IGNsYXNzPSd1aS1wb3B1cC1hcnJvdy1ndWlkZSc+PC9kaXY+IiArCgkJIjxkaXYgY2xhc3M9J3VpLXBvcHVwLWFycm93LWNvbnRhaW5lciIgKyAoIGllSGFjayA/ICIgaWUiIDogIiIgKSArICInPiIgKwoJCQkiPGRpdiBjbGFzcz0ndWktcG9wdXAtYXJyb3cnPiIgKwoJCQkJIjxkaXYgY2xhc3M9J3VpLXBvcHVwLWFycm93LWJhY2tncm91bmQnPjwvZGl2PiIgKwoJCQkiPC9kaXY+IiArCgkJIjwvZGl2PiIKCSksCgkvLyBOZWVkZWQgZm9yIHRyYW5zZm9ybWluZyBjb29yZGluYXRlcyBmcm9tIHNjcmVlbiB0byBhcnJvdyBiYWNrZ3JvdW5kCgl0eEZhY3RvciA9IE1hdGguc3FydCggMiApIC8gMjsKCmZ1bmN0aW9uIGdldEFycm93KCkgewoJdmFyIGNsb25lID0gdWlUZW1wbGF0ZS5jbG9uZSgpLAoJCWdkID0gY2xvbmUuZXEoIDAgKSwKCQljdCA9IGNsb25lLmVxKCAxICksCgkJYXIgPSBjdC5jaGlsZHJlbigpLAoJCWJnID0gYXIuY2hpbGRyZW4oKTsKCglyZXR1cm4geyBhckVsczogY3QuYWRkKCBnZCApLCBnZDogZ2QsIGN0OiBjdCwgYXI6IGFyLCBiZzogYmcgfTsKfQoKJC53aWRnZXQoICJtb2JpbGUucG9wdXAiLCAkLm1vYmlsZS5wb3B1cCwgewoJb3B0aW9uczogewoKCQlhcnJvdzogIiIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGFyLAoJCQlyZXQgPSB0aGlzLl9zdXBlcigpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5hcnJvdyApIHsKCQkJdGhpcy5fdWkuYXJyb3cgPSBhciA9IHRoaXMuX2FkZEFycm93KCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglfYWRkQXJyb3c6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGVtZSwKCQkJb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJYXIgPSBnZXRBcnJvdygpOwoKCQl0aGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBvcHRzLnRoZW1lICk7CgkJYXIuYXIuYWRkQ2xhc3MoIHRoZW1lICsgKCBvcHRzLnNoYWRvdyA/ICIgdWktb3ZlcmxheS1zaGFkb3ciIDogIiIgKSApOwoJCWFyLmJnLmFkZENsYXNzKCB0aGVtZSApOwoJCWFyLmFyRWxzLmhpZGUoKS5hcHBlbmRUbyggdGhpcy5lbGVtZW50ICk7CgoJCXJldHVybiBhcjsKCX0sCgoJX3VuZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJdmFyIGFyID0gdGhpcy5fdWkuYXJyb3c7CgoJCWlmICggYXIgKSB7CgkJCWFyLmFyRWxzLnJlbW92ZSgpOwoJCX0KCgkJcmV0dXJuIHRoaXMuX3N1cGVyKCk7Cgl9LAoKCS8vIFByZXRlbmQgdG8gc2hvdyBhbiBhcnJvdyBkZXNjcmliZWQgYnkgQHAgYW5kIEBkaXIgYW5kIGNhbGN1bGF0ZSB0aGUKCS8vIGRpc3RhbmNlIGZyb20gdGhlIGRlc2lyZWQgcG9pbnQuIElmIGEgYmVzdC1kaXN0YW5jZSBpcyBwYXNzZWQgaW4sIHJldHVybgoJLy8gdGhlIG1pbmltdW0gb2YgdGhlIG9uZSBwYXNzZWQgaW4gYW5kIHRoZSBvbmUgY2FsY3VsYXRlZC4KCV90cnlBbkFycm93OiBmdW5jdGlvbiggcCwgZGlyLCBkZXNpcmVkLCBzLCBiZXN0ICkgewoJCXZhciByZXN1bHQsIHIsIGRpZmYsIGRlc2lyZWRGb3JBcnJvdyA9IHt9LCB0aXAgPSB7fTsKCgkJLy8gSWYgdGhlIGFycm93IGhhcyBubyB3aWdnbGUgcm9vbSBhbG9uZyB0aGUgZWRnZSBvZiB0aGUgcG9wdXAsIGl0IGNhbm5vdAoJCS8vIGJlIGRpc3BsYXllZCBhbG9uZyB0aGUgcmVxdWVzdGVkIGVkZ2Ugd2l0aG91dCBpdCBzdGlja2luZyBvdXQuCgkJaWYgKCBzLmFyRnVsbFsgcC5kaW1LZXkgXSA+IHMuZ3VpZGVEaW1zWyBwLmRpbUtleSBdICkgewoJCQlyZXR1cm4gYmVzdDsKCQl9CgoJCWRlc2lyZWRGb3JBcnJvd1sgcC5mc3QgXSA9IGRlc2lyZWRbIHAuZnN0IF0gKwoJCQkoIHMuYXJIYWxmWyBwLm9EaW1LZXkgXSArIHMubWVudUhhbGZbIHAub0RpbUtleSBdICkgKiBwLm9mZnNldEZhY3RvciAtCgkJCXMuY29udGVudEJveFsgcC5mc3QgXSArICggcy5jbGFtcEluZm8ubWVudVNpemVbIHAub0RpbUtleSBdIC0gcy5jb250ZW50Qm94WyBwLm9EaW1LZXkgXSApICogcC5hcnJvd09mZnNldEZhY3RvcjsKCQlkZXNpcmVkRm9yQXJyb3dbIHAuc25kIF0gPSBkZXNpcmVkWyBwLnNuZCBdOwoKCQlyZXN1bHQgPSBzLnJlc3VsdCB8fCB0aGlzLl9jYWxjdWxhdGVGaW5hbExvY2F0aW9uKCBkZXNpcmVkRm9yQXJyb3csIHMuY2xhbXBJbmZvICk7CgkJciA9IHsgeDogcmVzdWx0LmxlZnQsIHk6IHJlc3VsdC50b3AgfTsKCgkJdGlwWyBwLmZzdCBdID0gclsgcC5mc3QgXSArIHMuY29udGVudEJveFsgcC5mc3QgXSArIHAudGlwT2Zmc2V0OwoJCXRpcFsgcC5zbmQgXSA9IE1hdGgubWF4KCByZXN1bHRbIHAucHJvcCBdICsgcy5ndWlkZU9mZnNldFsgcC5wcm9wIF0gKyBzLmFySGFsZlsgcC5kaW1LZXkgXSwKCQkJTWF0aC5taW4oIHJlc3VsdFsgcC5wcm9wIF0gKyBzLmd1aWRlT2Zmc2V0WyBwLnByb3AgXSArIHMuZ3VpZGVEaW1zWyBwLmRpbUtleSBdIC0gcy5hckhhbGZbIHAuZGltS2V5IF0sCgkJCQlkZXNpcmVkWyBwLnNuZCBdICkgKTsKCgkJZGlmZiA9IE1hdGguYWJzKCBkZXNpcmVkLnggLSB0aXAueCApICsgTWF0aC5hYnMoIGRlc2lyZWQueSAtIHRpcC55ICk7CgkJaWYgKCAhYmVzdCB8fCBkaWZmIDwgYmVzdC5kaWZmICkgewoJCQkvLyBDb252ZXJ0IHRpcCBvZmZzZXQgdG8gY29vcmRpbmF0ZXMgaW5zaWRlIHRoZSBwb3B1cAoJCQl0aXBbIHAuc25kIF0gLT0gcy5hckhhbGZbIHAuZGltS2V5IF0gKyByZXN1bHRbIHAucHJvcCBdICsgcy5jb250ZW50Qm94WyBwLnNuZCBdOwoJCQliZXN0ID0geyBkaXI6IGRpciwgZGlmZjogZGlmZiwgcmVzdWx0OiByZXN1bHQsIHBvc1Byb3A6IHAucHJvcCwgcG9zVmFsOiB0aXBbIHAuc25kIF0gfTsKCQl9CgoJCXJldHVybiBiZXN0OwoJfSwKCglfZ2V0UGxhY2VtZW50U3RhdGU6IGZ1bmN0aW9uKCBjbGFtcCApIHsKCQl2YXIgb2Zmc2V0LCBnZE9mZnNldCwKCQkJYXIgPSB0aGlzLl91aS5hcnJvdywKCQkJc3RhdGUgPSB7CgkJCQljbGFtcEluZm86IHRoaXMuX2NsYW1wUG9wdXBXaWR0aCggIWNsYW1wICksCgkJCQlhckZ1bGw6IHsgY3g6IGFyLmN0LndpZHRoKCksIGN5OiBhci5jdC5oZWlnaHQoKSB9LAoJCQkJZ3VpZGVEaW1zOiB7IGN4OiBhci5nZC53aWR0aCgpLCBjeTogYXIuZ2QuaGVpZ2h0KCkgfSwKCQkJCWd1aWRlT2Zmc2V0OiBhci5nZC5vZmZzZXQoKQoJCQl9OwoKCQlvZmZzZXQgPSB0aGlzLmVsZW1lbnQub2Zmc2V0KCk7CgoJCWFyLmdkLmNzcyggeyBsZWZ0OiAwLCB0b3A6IDAsIHJpZ2h0OiAwLCBib3R0b206IDAgfSApOwoJCWdkT2Zmc2V0ID0gYXIuZ2Qub2Zmc2V0KCk7CgkJc3RhdGUuY29udGVudEJveCA9IHsKCQkJeDogZ2RPZmZzZXQubGVmdCAtIG9mZnNldC5sZWZ0LAoJCQl5OiBnZE9mZnNldC50b3AgLSBvZmZzZXQudG9wLAoJCQljeDogYXIuZ2Qud2lkdGgoKSwKCQkJY3k6IGFyLmdkLmhlaWdodCgpCgkJfTsKCQlhci5nZC5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgoJCS8vIFRoZSBhcnJvdyBib3ggbW92ZXMgYmV0d2VlbiBndWlkZU9mZnNldCBhbmQgZ3VpZGVPZmZzZXQgKyBndWlkZURpbXMgLSBhckZ1bGwKCQlzdGF0ZS5ndWlkZU9mZnNldCA9IHsgbGVmdDogc3RhdGUuZ3VpZGVPZmZzZXQubGVmdCAtIG9mZnNldC5sZWZ0LCB0b3A6IHN0YXRlLmd1aWRlT2Zmc2V0LnRvcCAtIG9mZnNldC50b3AgfTsKCQlzdGF0ZS5hckhhbGYgPSB7IGN4OiBzdGF0ZS5hckZ1bGwuY3ggLyAyLCBjeTogc3RhdGUuYXJGdWxsLmN5IC8gMiB9OwoJCXN0YXRlLm1lbnVIYWxmID0geyBjeDogc3RhdGUuY2xhbXBJbmZvLm1lbnVTaXplLmN4IC8gMiwgY3k6IHN0YXRlLmNsYW1wSW5mby5tZW51U2l6ZS5jeSAvIDIgfTsKCgkJcmV0dXJuIHN0YXRlOwoJfSwKCglfcGxhY2VtZW50Q29vcmRzOiBmdW5jdGlvbiggZGVzaXJlZCApIHsKCQl2YXIgc3RhdGUsIGJlc3QsIHBhcmFtcywgYmdPZmZzZXQsIGVsT2Zmc2V0LCBkaWZmLCBiZ1JlZiwKCQkJb3B0aW9uVmFsdWUgPSB0aGlzLm9wdGlvbnMuYXJyb3csCgkJCWFyID0gdGhpcy5fdWkuYXJyb3c7CgoJCWlmICggIWFyICkgewoJCQlyZXR1cm4gdGhpcy5fc3VwZXIoIGRlc2lyZWQgKTsKCQl9CgoJCWFyLmFyRWxzLnNob3coKTsKCgkJYmdSZWYgPSB7fTsKCQlzdGF0ZSA9IHRoaXMuX2dldFBsYWNlbWVudFN0YXRlKCB0cnVlICk7CgkJcGFyYW1zID0gewoJCQkibCI6IHsgZnN0OiAieCIsIHNuZDogInkiLCBwcm9wOiAidG9wIiwgZGltS2V5OiAiY3kiLCBvRGltS2V5OiAiY3giLCBvZmZzZXRGYWN0b3I6IDEsIHRpcE9mZnNldDogIC1zdGF0ZS5hckhhbGYuY3gsIGFycm93T2Zmc2V0RmFjdG9yOiAwIH0sCgkJCSJyIjogeyBmc3Q6ICJ4Iiwgc25kOiAieSIsIHByb3A6ICJ0b3AiLCBkaW1LZXk6ICJjeSIsIG9EaW1LZXk6ICJjeCIsIG9mZnNldEZhY3RvcjogLTEsIHRpcE9mZnNldDogc3RhdGUuYXJIYWxmLmN4ICsgc3RhdGUuY29udGVudEJveC5jeCwgYXJyb3dPZmZzZXRGYWN0b3I6IDEgfSwKCQkJImIiOiB7IGZzdDogInkiLCBzbmQ6ICJ4IiwgcHJvcDogImxlZnQiLCBkaW1LZXk6ICJjeCIsIG9EaW1LZXk6ICJjeSIsIG9mZnNldEZhY3RvcjogLTEsIHRpcE9mZnNldDogc3RhdGUuYXJIYWxmLmN5ICsgc3RhdGUuY29udGVudEJveC5jeSwgYXJyb3dPZmZzZXRGYWN0b3I6IDEgfSwKCQkJInQiOiB7IGZzdDogInkiLCBzbmQ6ICJ4IiwgcHJvcDogImxlZnQiLCBkaW1LZXk6ICJjeCIsIG9EaW1LZXk6ICJjeSIsIG9mZnNldEZhY3RvcjogMSwgdGlwT2Zmc2V0OiAtc3RhdGUuYXJIYWxmLmN5LCBhcnJvd09mZnNldEZhY3RvcjogMCB9CgkJfTsKCgkJLy8gVHJ5IGVhY2ggc2lkZSBzcGVjaWZpZWQgaW4gdGhlIG9wdGlvbnMgdG8gc2VlIG9uIHdoaWNoIG9uZSB0aGUgYXJyb3cKCQkvLyBzaG91bGQgYmUgcGxhY2VkIHN1Y2ggdGhhdCB0aGUgZGlzdGFuY2UgYmV0d2VlbiB0aGUgdGlwIG9mIHRoZSBhcnJvdyBhbmQKCQkvLyB0aGUgZGVzaXJlZCBjb29yZGluYXRlcyBpcyB0aGUgc2hvcnRlc3QuCgkJJC5lYWNoKCAoIG9wdGlvblZhbHVlID09PSB0cnVlID8gImwsdCxyLGIiIDogb3B0aW9uVmFsdWUgKS5zcGxpdCggIiwiICksCgkJCSQucHJveHkoIGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQkJYmVzdCA9IHRoaXMuX3RyeUFuQXJyb3coIHBhcmFtc1sgdmFsdWUgXSwgdmFsdWUsIGRlc2lyZWQsIHN0YXRlLCBiZXN0ICk7CgkJCX0sIHRoaXMgKSApOwoKCQkvLyBDb3VsZCBub3QgcGxhY2UgdGhlIGFycm93IGFsb25nIGFueSBvZiB0aGUgZWRnZXMgLSBiZWhhdmUgYXMgaWYgc2hvd2luZwoJCS8vIHRoZSBhcnJvdyB3YXMgdHVybmVkIG9mZi4KCQlpZiAoICFiZXN0ICkgewoJCQlhci5hckVscy5oaWRlKCk7CgkJCXJldHVybiB0aGlzLl9zdXBlciggZGVzaXJlZCApOwoJCX0KCgkJLy8gTW92ZSB0aGUgYXJyb3cgaW50byBwbGFjZQoJCWFyLmN0CgkJCS5yZW1vdmVDbGFzcyggInVpLXBvcHVwLWFycm93LWwgdWktcG9wdXAtYXJyb3ctdCB1aS1wb3B1cC1hcnJvdy1yIHVpLXBvcHVwLWFycm93LWIiICkKCQkJLmFkZENsYXNzKCAidWktcG9wdXAtYXJyb3ctIiArIGJlc3QuZGlyICkKCQkJLnJlbW92ZUF0dHIoICJzdHlsZSIgKS5jc3MoIGJlc3QucG9zUHJvcCwgYmVzdC5wb3NWYWwgKQoJCQkuc2hvdygpOwoKCQkvLyBEbyBub3QgbW92ZS9zaXplIHRoZSBiYWNrZ3JvdW5kIGRpdiBvbiBJRSwgYmVjYXVzZSB3ZSB1c2UgdGhlIGFycm93IGRpdiBmb3IgYmFja2dyb3VuZCBhcyB3ZWxsLgoJCWlmICggIWllSGFjayApIHsKCQkJZWxPZmZzZXQgPSB0aGlzLmVsZW1lbnQub2Zmc2V0KCk7CgkJCWJnUmVmWyBwYXJhbXNbIGJlc3QuZGlyIF0uZnN0IF0gPSBhci5jdC5vZmZzZXQoKTsKCQkJYmdSZWZbIHBhcmFtc1sgYmVzdC5kaXIgXS5zbmQgXSA9IHsKCQkJCWxlZnQ6IGVsT2Zmc2V0LmxlZnQgKyBzdGF0ZS5jb250ZW50Qm94LngsCgkJCQl0b3A6IGVsT2Zmc2V0LnRvcCArIHN0YXRlLmNvbnRlbnRCb3gueQoJCQl9OwoJCQliZ09mZnNldCA9IGFyLmJnCgkJCQkucmVtb3ZlQXR0ciggInN0eWxlIiApCgkJCQkuY3NzKCAoICJjeCIgPT09IHBhcmFtc1sgYmVzdC5kaXIgXS5kaW1LZXkgPyAid2lkdGgiIDogImhlaWdodCIgKSwgc3RhdGUuY29udGVudEJveFsgcGFyYW1zWyBiZXN0LmRpciBdLmRpbUtleSBdICkKCQkJCS5vZmZzZXQoKTsKCQkJZGlmZiA9IHsgZHg6IGJnUmVmLngubGVmdCAtIGJnT2Zmc2V0LmxlZnQsIGR5OiBiZ1JlZi55LnRvcCAtIGJnT2Zmc2V0LnRvcCB9OwoJCQlhci5iZy5jc3MoIHsgbGVmdDogdHhGYWN0b3IgKiBkaWZmLmR5ICsgdHhGYWN0b3IgKiBkaWZmLmR4LCB0b3A6IHR4RmFjdG9yICogZGlmZi5keSAtIHR4RmFjdG9yICogZGlmZi5keCB9ICk7CgkJfQoKCQlyZXR1cm4gYmVzdC5yZXN1bHQ7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0cyApIHsKCQl2YXIgbmV3VGhlbWUsCgkJCW9sZFRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lLAoJCQlhciA9IHRoaXMuX3VpLmFycm93LAoJCQlyZXQgPSB0aGlzLl9zdXBlciggb3B0cyApOwoKCQlpZiAoIG9wdHMuYXJyb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCAhYXIgJiYgb3B0cy5hcnJvdyApIHsKCQkJCXRoaXMuX3VpLmFycm93ID0gdGhpcy5fYWRkQXJyb3coKTsKCgkJCQkvLyBJbXBvcnRhbnQgdG8gcmV0dXJuIGhlcmUgc28gd2UgZG9uJ3Qgc2V0IHRoZSBzYW1lIG9wdGlvbnMgYWxsIG92ZXIKCQkJCS8vIGFnYWluIGJlbG93LgoJCQkJcmV0dXJuOwoJCQl9IGVsc2UgaWYgKCBhciAmJiAhb3B0cy5hcnJvdyApIHsKCQkJCWFyLmFyRWxzLnJlbW92ZSgpOwoJCQkJdGhpcy5fdWkuYXJyb3cgPSBudWxsOwoJCQl9CgkJfQoKCQkvLyBSZWFzc2lnbiB3aXRoIHBvdGVudGlhbGx5IG5ldyBhcnJvdwoJCWFyID0gdGhpcy5fdWkuYXJyb3c7CgoJCWlmICggYXIgKSB7CgkJCWlmICggb3B0cy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJb2xkVGhlbWUgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgb2xkVGhlbWUgKTsKCQkJCW5ld1RoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMudGhlbWUgKTsKCQkJCWFyLmFyLnJlbW92ZUNsYXNzKCBvbGRUaGVtZSApLmFkZENsYXNzKCBuZXdUaGVtZSApOwoJCQkJYXIuYmcucmVtb3ZlQ2xhc3MoIG9sZFRoZW1lICkuYWRkQ2xhc3MoIG5ld1RoZW1lICk7CgkJCX0KCgkJCWlmICggb3B0cy5zaGFkb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJCWFyLmFyLnRvZ2dsZUNsYXNzKCAidWktb3ZlcmxheS1zaGFkb3ciLCBvcHRzLnNoYWRvdyApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIGFyID0gdGhpcy5fdWkuYXJyb3c7CgoJCWlmICggYXIgKSB7CgkJCWFyLmFyRWxzLnJlbW92ZSgpOwoJCX0KCgkJcmV0dXJuIHRoaXMuX3N1cGVyKCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUucGFuZWwiLCB7CglvcHRpb25zOiB7CgkJY2xhc3NlczogewoJCQlwYW5lbDogInVpLXBhbmVsIiwKCQkJcGFuZWxPcGVuOiAidWktcGFuZWwtb3BlbiIsCgkJCXBhbmVsQ2xvc2VkOiAidWktcGFuZWwtY2xvc2VkIiwKCQkJcGFuZWxGaXhlZDogInVpLXBhbmVsLWZpeGVkIiwKCQkJcGFuZWxJbm5lcjogInVpLXBhbmVsLWlubmVyIiwKCQkJbW9kYWw6ICJ1aS1wYW5lbC1kaXNtaXNzIiwKCQkJbW9kYWxPcGVuOiAidWktcGFuZWwtZGlzbWlzcy1vcGVuIiwKCQkJcGFnZUNvbnRhaW5lcjogInVpLXBhbmVsLXBhZ2UtY29udGFpbmVyIiwKCQkJcGFnZVdyYXBwZXI6ICJ1aS1wYW5lbC13cmFwcGVyIiwKCQkJcGFnZUZpeGVkVG9vbGJhcjogInVpLXBhbmVsLWZpeGVkLXRvb2xiYXIiLAoJCQlwYWdlQ29udGVudFByZWZpeDogInVpLXBhbmVsLXBhZ2UtY29udGVudCIsIC8qIFVzZWQgZm9yIHdyYXBwZXIgYW5kIGZpeGVkIHRvb2xiYXJzIHBvc2l0aW9uLCBkaXNwbGF5IGFuZCBvcGVuIGNsYXNzZXMuICovCgkJCWFuaW1hdGU6ICJ1aS1wYW5lbC1hbmltYXRlIgoJCX0sCgkJYW5pbWF0ZTogdHJ1ZSwKCQl0aGVtZTogbnVsbCwKCQlwb3NpdGlvbjogImxlZnQiLAoJCWRpc21pc3NpYmxlOiB0cnVlLAoJCWRpc3BsYXk6ICJyZXZlYWwiLCAvL2FjY2VwdHMgcmV2ZWFsLCBwdXNoLCBvdmVybGF5CgkJc3dpcGVDbG9zZTogdHJ1ZSwKCQlwb3NpdGlvbkZpeGVkOiBmYWxzZQoJfSwKCglfcGFuZWxJRDogbnVsbCwKCV9jbG9zZUxpbms6IG51bGwsCglfcGFyZW50UGFnZTogbnVsbCwKCV9wYWdlOiBudWxsLAoJX21vZGFsOiBudWxsLAoJX3BhbmVsSW5uZXI6IG51bGwsCglfd3JhcHBlcjogbnVsbCwKCV9maXhlZFRvb2xiYXJzOiBudWxsLAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBlbCA9IHRoaXMuZWxlbWVudCwKCQkJcGFyZW50UGFnZSA9IGVsLmNsb3Nlc3QoICI6anFtRGF0YShyb2xlPSdwYWdlJykiICk7CgoJCS8vIGV4cG9zZSBzb21lIHByaXZhdGUgcHJvcHMgdG8gb3RoZXIgbWV0aG9kcwoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9wYW5lbElEOiBlbC5hdHRyKCAiaWQiICksCgkJCV9jbG9zZUxpbms6IGVsLmZpbmQoICI6anFtRGF0YShyZWw9J2Nsb3NlJykiICksCgkJCV9wYXJlbnRQYWdlOiAoIHBhcmVudFBhZ2UubGVuZ3RoID4gMCApID8gcGFyZW50UGFnZSA6IGZhbHNlLAoJCQlfcGFnZTogdGhpcy5fZ2V0UGFnZSwKCQkJX3BhbmVsSW5uZXI6IHRoaXMuX2dldFBhbmVsSW5uZXIoKSwKCQkJX3dyYXBwZXI6IHRoaXMuX2dldFdyYXBwZXIsCgkJCV9maXhlZFRvb2xiYXJzOiB0aGlzLl9nZXRGaXhlZFRvb2xiYXJzCgkJfSk7CgoJCXRoaXMuX2FkZFBhbmVsQ2xhc3NlcygpOwoKCQkvLyBpZiBhbmltYXRpbmcsIGFkZCB0aGUgY2xhc3MgdG8gZG8gc28KCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIXRoaXMub3B0aW9ucy5hbmltYXRlICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLmFuaW1hdGUgKTsKCQl9CgoJCXRoaXMuX2JpbmRVcGRhdGVMYXlvdXQoKTsKCQl0aGlzLl9iaW5kQ2xvc2VFdmVudHMoKTsKCQl0aGlzLl9iaW5kTGlua0xpc3RlbmVycygpOwoJCXRoaXMuX2JpbmRQYWdlRXZlbnRzKCk7CgoJCWlmICggISF0aGlzLm9wdGlvbnMuZGlzbWlzc2libGUgKSB7CgkJCXRoaXMuX2NyZWF0ZU1vZGFsKCk7CgkJfQoKCQl0aGlzLl9iaW5kU3dpcGVFdmVudHMoKTsKCX0sCgoJX2dldFBhbmVsSW5uZXI6IGZ1bmN0aW9uKCkgewoJCXZhciBwYW5lbElubmVyID0gdGhpcy5lbGVtZW50LmZpbmQoICIuIiArIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsSW5uZXIgKTsKCgkJaWYgKCBwYW5lbElubmVyLmxlbmd0aCA9PT0gMCApIHsKCQkJcGFuZWxJbm5lciA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbigpLndyYXBBbGwoICI8ZGl2IGNsYXNzPSciICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxJbm5lciArICInIC8+IiApLnBhcmVudCgpOwoJCX0KCgkJcmV0dXJuIHBhbmVsSW5uZXI7Cgl9LAoKCV9jcmVhdGVNb2RhbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQl0YXJnZXQgPSBzZWxmLl9wYXJlbnRQYWdlID8gc2VsZi5fcGFyZW50UGFnZS5wYXJlbnQoKSA6IHNlbGYuZWxlbWVudC5wYXJlbnQoKTsKCgkJc2VsZi5fbW9kYWwgPSAkKCAiPGRpdiBjbGFzcz0nIiArIHNlbGYub3B0aW9ucy5jbGFzc2VzLm1vZGFsICsgIicgZGF0YS1wYW5lbGlkPSciICsgc2VsZi5fcGFuZWxJRCArICInPjwvZGl2PiIgKQoJCQkub24oICJtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuY2xvc2UoKTsKCQkJfSkKCQkJLmFwcGVuZFRvKCB0YXJnZXQgKTsKCX0sCgoJX2dldFBhZ2U6IGZ1bmN0aW9uKCkgewoJCXZhciBwYWdlID0gdGhpcy5fcGFyZW50UGFnZSA/IHRoaXMuX3BhcmVudFBhZ2UgOiAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKTsKCgkJcmV0dXJuIHBhZ2U7Cgl9LAoKCV9nZXRXcmFwcGVyOiBmdW5jdGlvbigpIHsKCQl2YXIgd3JhcHBlciA9IHRoaXMuX3BhZ2UoKS5maW5kKCAiLiIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYWdlV3JhcHBlciApOwoKCQlpZiAoIHdyYXBwZXIubGVuZ3RoID09PSAwICkgewoJCQl3cmFwcGVyID0gdGhpcy5fcGFnZSgpLmNoaWxkcmVuKCAiLnVpLWhlYWRlcjpub3QoLnVpLWhlYWRlci1maXhlZCksIC51aS1jb250ZW50Om5vdCgudWktcG9wdXApLCAudWktZm9vdGVyOm5vdCgudWktZm9vdGVyLWZpeGVkKSIgKQoJCQkJLndyYXBBbGwoICI8ZGl2IGNsYXNzPSciICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFnZVdyYXBwZXIgKyAiJz48L2Rpdj4iICkKCQkJCS5wYXJlbnQoKTsKCQl9CgoJCXJldHVybiB3cmFwcGVyOwoJfSwKCglfZ2V0Rml4ZWRUb29sYmFyczogZnVuY3Rpb24oKSB7CgkJdmFyIGV4dEZpeGVkVG9vbGJhcnMgPSAkKCAiYm9keSIgKS5jaGlsZHJlbiggIi51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQiICksCgkJCWludEZpeGVkVG9vbGJhcnMgPSB0aGlzLl9wYWdlKCkuZmluZCggIi51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQiICksCgkJCWZpeGVkVG9vbGJhcnMgPSBleHRGaXhlZFRvb2xiYXJzLmFkZCggaW50Rml4ZWRUb29sYmFycyApLmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYWdlRml4ZWRUb29sYmFyICk7CgoJCXJldHVybiBmaXhlZFRvb2xiYXJzOwoJfSwKCglfZ2V0UG9zRGlzcGxheUNsYXNzZXM6IGZ1bmN0aW9uKCBwcmVmaXggKSB7CgkJcmV0dXJuIHByZWZpeCArICItcG9zaXRpb24tIiArIHRoaXMub3B0aW9ucy5wb3NpdGlvbiArICIgIiArIHByZWZpeCArICItZGlzcGxheS0iICsgdGhpcy5vcHRpb25zLmRpc3BsYXk7Cgl9LAoKCV9nZXRQYW5lbENsYXNzZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBwYW5lbENsYXNzZXMgPSB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbCArCgkJCSIgIiArIHRoaXMuX2dldFBvc0Rpc3BsYXlDbGFzc2VzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbCApICsKCQkJIiAiICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxDbG9zZWQgKwoJCQkiICIgKyAidWktYm9keS0iICsgKCB0aGlzLm9wdGlvbnMudGhlbWUgPyB0aGlzLm9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIgKTsKCgkJaWYgKCAhIXRoaXMub3B0aW9ucy5wb3NpdGlvbkZpeGVkICkgewoJCQlwYW5lbENsYXNzZXMgKz0gIiAiICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxGaXhlZDsKCQl9CgoJCXJldHVybiBwYW5lbENsYXNzZXM7Cgl9LAoKCV9hZGRQYW5lbENsYXNzZXM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5fZ2V0UGFuZWxDbGFzc2VzKCkgKTsKCX0sCgoJX2JpbmRDbG9zZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZWxmLl9jbG9zZUxpbmsub24oICJjbGljay5wYW5lbCIgLCBmdW5jdGlvbiggZSApIHsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQlzZWxmLmNsb3NlKCk7CgkJCXJldHVybiBmYWxzZTsKCQl9KTsKCQlzZWxmLmVsZW1lbnQub24oICJjbGljay5wYW5lbCIgLCAiYTpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiLCBmdW5jdGlvbigvKiBlICovKSB7CgkJCXNlbGYuY2xvc2UoKTsKCQl9KTsKCX0sCgoJX3Bvc2l0aW9uUGFuZWw6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJcGFuZWxJbm5lckhlaWdodCA9IHNlbGYuX3BhbmVsSW5uZXIub3V0ZXJIZWlnaHQoKSwKCQkJZXhwYW5kID0gcGFuZWxJbm5lckhlaWdodCA+ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQlpZiAoIGV4cGFuZCB8fCAhc2VsZi5vcHRpb25zLnBvc2l0aW9uRml4ZWQgKSB7CgkJCWlmICggZXhwYW5kICkgewoJCQkJc2VsZi5fdW5maXhQYW5lbCgpOwoJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCBwYW5lbElubmVySGVpZ2h0ICk7CgkJCX0KCQkJd2luZG93LnNjcm9sbFRvKCAwLCAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCApOwoJCX0gZWxzZSB7CgkJCXNlbGYuX2ZpeFBhbmVsKCk7CgkJfQoJfSwKCglfYmluZEZpeExpc3RlbmVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbiggJCggd2luZG93ICksIHsgInRocm90dGxlZHJlc2l6ZSI6ICJfcG9zaXRpb25QYW5lbCIgfSk7Cgl9LAoKCV91bmJpbmRGaXhMaXN0ZW5lcjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb2ZmKCAkKCB3aW5kb3cgKSwgInRocm90dGxlZHJlc2l6ZSIgKTsKCX0sCgoJX3VuZml4UGFuZWw6IGZ1bmN0aW9uKCkgewoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCAmJiAkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbiApIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkICk7CgkJfQoJfSwKCglfZml4UGFuZWw6IGZ1bmN0aW9uKCkgewoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCAmJiAkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbiApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkICk7CgkJfQoJfSwKCglfYmluZFVwZGF0ZUxheW91dDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZWxmLmVsZW1lbnQub24oICJ1cGRhdGVsYXlvdXQiLCBmdW5jdGlvbigvKiBlICovKSB7CgkJCWlmICggc2VsZi5fb3BlbiApIHsKCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCQkJfQoJCX0pOwoJfSwKCglfYmluZExpbmtMaXN0ZW5lcnM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29uKCAiYm9keSIsIHsKCQkJImNsaWNrIGEiOiAiX2hhbmRsZUNsaWNrIgoJCX0pOwoKCX0sCgoJX2hhbmRsZUNsaWNrOiBmdW5jdGlvbiggZSApIHsKCQlpZiAoICBlLmN1cnJlbnRUYXJnZXQuaHJlZi5zcGxpdCggIiMiIClbIDEgXSA9PT0gdGhpcy5fcGFuZWxJRCAmJiB0aGlzLl9wYW5lbElEICE9PSB1bmRlZmluZWQgKSB7CgkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJdmFyIGxpbmsgPSAkKCBlLnRhcmdldCApOwoJCQlpZiAoIGxpbmsuaGFzQ2xhc3MoICJ1aS1idG4iICkgKSB7CgkJCQlsaW5rLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJdGhpcy5lbGVtZW50Lm9uZSggInBhbmVsb3BlbiBwYW5lbGNsb3NlIiwgZnVuY3Rpb24oKSB7CgkJCQkJbGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCX0pOwoJCQl9CgkJCXRoaXMudG9nZ2xlKCk7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9LAoKCV9iaW5kU3dpcGVFdmVudHM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJYXJlYSA9IHNlbGYuX21vZGFsID8gc2VsZi5lbGVtZW50LmFkZCggc2VsZi5fbW9kYWwgKSA6IHNlbGYuZWxlbWVudDsKCgkJLy8gb24gc3dpcGUsIGNsb3NlIHRoZSBwYW5lbAoJCWlmICggISFzZWxmLm9wdGlvbnMuc3dpcGVDbG9zZSApIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucG9zaXRpb24gPT09ICJsZWZ0IiApIHsKCQkJCWFyZWEub24oICJzd2lwZWxlZnQucGFuZWwiLCBmdW5jdGlvbigvKiBlICovKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlhcmVhLm9uKCAic3dpcGVyaWdodC5wYW5lbCIsIGZ1bmN0aW9uKC8qIGUgKi8pIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9KTsKCQkJfQoJCX0KCX0sCgoJX2JpbmRQYWdlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXRoaXMuZG9jdW1lbnQKCQkJLy8gQ2xvc2UgdGhlIHBhbmVsIGlmIGFub3RoZXIgcGFuZWwgb24gdGhlIHBhZ2Ugb3BlbnMKCQkJLm9uKCAicGFuZWxiZWZvcmVvcGVuIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gJiYgZS50YXJnZXQgIT09IHNlbGYuZWxlbWVudFsgMCBdICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0KCQkJfSkKCQkJLy8gT24gZXNjYXBlLCBjbG9zZT8gbWlnaHQgbmVlZCB0byBoYXZlIGEgdGFyZ2V0IGNoZWNrIHRvby4uLgoJCQkub24oICJrZXl1cC5wYW5lbCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJaWYgKCBlLmtleUNvZGUgPT09IDI3ICYmIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfQoJCQl9KTsKCgkJLy8gQ2xlYW4gdXAgb3BlbiBwYW5lbHMgYWZ0ZXIgcGFnZSBoaWRlCgkJaWYgKCBzZWxmLl9wYXJlbnRQYWdlICkgewoJCQl0aGlzLmRvY3VtZW50Lm9uKCAicGFnZWhpZGUiLCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSggdHJ1ZSApOwoJCQkJfQoJCQl9KTsKCQl9IGVsc2UgewoJCQl0aGlzLmRvY3VtZW50Lm9uKCAicGFnZWJlZm9yZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCWlmICggc2VsZi5fb3BlbiApIHsKCQkJCQlzZWxmLmNsb3NlKCB0cnVlICk7CgkJCQl9CgkJCX0pOwoJCX0KCX0sCgoJLy8gc3RhdGUgc3RvcmFnZSBvZiBvcGVuIG9yIGNsb3NlZAoJX29wZW46IGZhbHNlLAoJX3BhZ2VDb250ZW50T3BlbkNsYXNzZXM6IG51bGwsCglfbW9kYWxPcGVuQ2xhc3NlczogbnVsbCwKCglvcGVuOiBmdW5jdGlvbiggaW1tZWRpYXRlICkgewoJCWlmICggIXRoaXMuX29wZW4gKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgoJCQkJX29wZW5QYW5lbCA9IGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYuZG9jdW1lbnQub2ZmKCAicGFuZWxjbG9zZSIgKTsKCQkJCQlzZWxmLl9wYWdlKCkuanFtRGF0YSggInBhbmVsIiwgIm9wZW4iICk7CgoJCQkJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICYmIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyKCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5hZGRDbGFzcyggby5jbGFzc2VzLmFuaW1hdGUgKTsKCQkJCQl9CgoJCQkJCWlmICggIWltbWVkaWF0ZSAmJiAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgKSB7CgkJCQkJCXNlbGYuZG9jdW1lbnQub24oIHNlbGYuX3RyYW5zaXRpb25FbmRFdmVudHMsIGNvbXBsZXRlICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJc2V0VGltZW91dCggY29tcGxldGUsIDAgKTsKCQkJCQl9CgoJCQkJCWlmICggby50aGVtZSAmJiBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZSgpLnBhcmVudCgpCgkJCQkJCQkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi10aGVtZWQgIiArIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi0iICsgby50aGVtZSApOwoJCQkJCX0KCgkJCQkJc2VsZi5lbGVtZW50CgkJCQkJCS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhbmVsQ2xvc2VkICkKCQkJCQkJLmFkZENsYXNzKCBvLmNsYXNzZXMucGFuZWxPcGVuICk7CgoJCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCgkJCQkJc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyA9IHNlbGYuX2dldFBvc0Rpc3BsYXlDbGFzc2VzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKTsKCgkJCQkJaWYgKCBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZSgpLnBhcmVudCgpLmFkZENsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciApOwoJCQkJCQlzZWxmLl93cmFwcGVyKCkuYWRkQ2xhc3MoIHNlbGYuX3BhZ2VDb250ZW50T3BlbkNsYXNzZXMgKTsKCQkJCQkJc2VsZi5fZml4ZWRUb29sYmFycygpLmFkZENsYXNzKCBzZWxmLl9wYWdlQ29udGVudE9wZW5DbGFzc2VzICk7CgkJCQkJfQoKCQkJCQlzZWxmLl9tb2RhbE9wZW5DbGFzc2VzID0gc2VsZi5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIG8uY2xhc3Nlcy5tb2RhbCApICsgIiAiICsgby5jbGFzc2VzLm1vZGFsT3BlbjsKCQkJCQlpZiAoIHNlbGYuX21vZGFsICkgewoJCQkJCQlzZWxmLl9tb2RhbAoJCQkJCQkJLmFkZENsYXNzKCBzZWxmLl9tb2RhbE9wZW5DbGFzc2VzICkKCQkJCQkJCS5oZWlnaHQoIE1hdGgubWF4KCBzZWxmLl9tb2RhbC5oZWlnaHQoKSwgc2VsZi5kb2N1bWVudC5oZWlnaHQoKSApICk7CgkJCQkJfQoJCQkJfSwKCQkJCWNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5kb2N1bWVudC5vZmYoIHNlbGYuX3RyYW5zaXRpb25FbmRFdmVudHMsIGNvbXBsZXRlICk7CgoJCQkJCWlmICggby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3dyYXBwZXIoKS5hZGRDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250ZW50UHJlZml4ICsgIi1vcGVuIiApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCQkJCQl9CgoJCQkJCXNlbGYuX2JpbmRGaXhMaXN0ZW5lcigpOwoKCQkJCQlzZWxmLl90cmlnZ2VyKCAib3BlbiIgKTsKCQkJCX07CgoJCQlzZWxmLl90cmlnZ2VyKCAiYmVmb3Jlb3BlbiIgKTsKCgkJCWlmICggc2VsZi5fcGFnZSgpLmpxbURhdGEoICJwYW5lbCIgKSA9PT0gIm9wZW4iICkgewoJCQkJc2VsZi5kb2N1bWVudC5vbiggInBhbmVsY2xvc2UiLCBmdW5jdGlvbigpIHsKCQkJCQlfb3BlblBhbmVsKCk7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCV9vcGVuUGFuZWwoKTsKCQkJfQoKCQkJc2VsZi5fb3BlbiA9IHRydWU7CgkJfQoJfSwKCgljbG9zZTogZnVuY3Rpb24oIGltbWVkaWF0ZSApIHsKCQlpZiAoIHRoaXMuX29wZW4gKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSB0aGlzLm9wdGlvbnMsCgoJCQkJX2Nsb3NlUGFuZWwgPSBmdW5jdGlvbigpIHsKCQkJCQlpZiAoICFpbW1lZGlhdGUgJiYgJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICkgewoJCQkJCQlzZWxmLmRvY3VtZW50Lm9uKCBzZWxmLl90cmFuc2l0aW9uRW5kRXZlbnRzLCBjb21wbGV0ZSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXNldFRpbWVvdXQoIGNvbXBsZXRlLCAwICk7CgkJCQkJfQoKCQkJCQlzZWxmLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbE9wZW4gKTsKCgkJCQkJaWYgKCBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fd3JhcHBlcigpLnJlbW92ZUNsYXNzKCBzZWxmLl9wYWdlQ29udGVudE9wZW5DbGFzc2VzICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyApOwoJCQkJCX0KCgkJCQkJaWYgKCBzZWxmLl9tb2RhbCApIHsKCQkJCQkJc2VsZi5fbW9kYWwucmVtb3ZlQ2xhc3MoIHNlbGYuX21vZGFsT3BlbkNsYXNzZXMgKTsKCQkJCQl9CgkJCQl9LAoJCQkJY29tcGxldGUgPSBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLmRvY3VtZW50Lm9mZiggc2VsZi5fdHJhbnNpdGlvbkVuZEV2ZW50cywgY29tcGxldGUgKTsKCgkJCQkJaWYgKCBvLnRoZW1lICYmIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl9wYWdlKCkucGFyZW50KCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi10aGVtZWQgIiArIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi0iICsgby50aGVtZSApOwoJCQkJCX0KCgkJCQkJc2VsZi5lbGVtZW50LmFkZENsYXNzKCBvLmNsYXNzZXMucGFuZWxDbG9zZWQgKTsKCgkJCQkJaWYgKCBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZSgpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciApOwoJCQkJCQlzZWxmLl93cmFwcGVyKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCQkJCQkJc2VsZi5fZml4ZWRUb29sYmFycygpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKyAiLW9wZW4iICk7CgkJCQkJfQoKCQkJCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIW8uYW5pbWF0ZSAmJiBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fd3JhcHBlcigpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMuYW5pbWF0ZSApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJfQoKCQkJCQlzZWxmLl9maXhQYW5lbCgpOwoJCQkJCXNlbGYuX3VuYmluZEZpeExpc3RlbmVyKCk7CgkJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCk7CgoJCQkJCXNlbGYuX3BhZ2UoKS5qcW1SZW1vdmVEYXRhKCAicGFuZWwiICk7CgoJCQkJCXNlbGYuX3RyaWdnZXIoICJjbG9zZSIgKTsKCQkJCX07CgoJCQlzZWxmLl90cmlnZ2VyKCAiYmVmb3JlY2xvc2UiICk7CgoJCQlfY2xvc2VQYW5lbCgpOwoKCQkJc2VsZi5fb3BlbiA9IGZhbHNlOwoJCX0KCX0sCgoJdG9nZ2xlOiBmdW5jdGlvbigpIHsKCQl0aGlzWyB0aGlzLl9vcGVuID8gImNsb3NlIiA6ICJvcGVuIiBdKCk7Cgl9LAoKCV90cmFuc2l0aW9uRW5kRXZlbnRzOiAid2Via2l0VHJhbnNpdGlvbkVuZCBvVHJhbnNpdGlvbkVuZCBvdHJhbnNpdGlvbmVuZCB0cmFuc2l0aW9uZW5kIG1zVHJhbnNpdGlvbkVuZCIsCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciBvdGhlclBhbmVscywKCQlvID0gdGhpcy5vcHRpb25zLAoJCW11bHRpcGxlUGFuZWxzID0gKCAkKCAiYm9keSA+IDptb2JpbGUtcGFuZWwiICkubGVuZ3RoICsgJC5tb2JpbGUuYWN0aXZlUGFnZS5maW5kKCAiOm1vYmlsZS1wYW5lbCIgKS5sZW5ndGggKSA+IDE7CgoJCWlmICggby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgoJCQkvLyAgcmVtb3ZlIHRoZSB3cmFwcGVyIGlmIG5vdCBpbiB1c2UgYnkgYW5vdGhlciBwYW5lbAoJCQlvdGhlclBhbmVscyA9ICQoICJib2R5ID4gOm1vYmlsZS1wYW5lbCIgKS5hZGQoICQubW9iaWxlLmFjdGl2ZVBhZ2UuZmluZCggIjptb2JpbGUtcGFuZWwiICkgKTsKCQkJaWYgKCBvdGhlclBhbmVscy5ub3QoICIudWktcGFuZWwtZGlzcGxheS1vdmVybGF5IiApLm5vdCggdGhpcy5lbGVtZW50ICkubGVuZ3RoID09PSAwICkgewoJCQkJdGhpcy5fd3JhcHBlcigpLmNoaWxkcmVuKCkudW53cmFwKCk7CgkJCX0KCgkJCWlmICggdGhpcy5fb3BlbiApIHsKCgkJCQl0aGlzLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCgkJCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIW8uYW5pbWF0ZSApIHsKCQkJCQl0aGlzLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQl9CgoJCQkJdGhpcy5fcGFnZSgpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciApOwoKCQkJCWlmICggby50aGVtZSApIHsKCQkJCQl0aGlzLl9wYWdlKCkucGFyZW50KCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi10aGVtZWQgIiArIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi0iICsgby50aGVtZSApOwoJCQkJfQoJCQl9CgkJfQoKCQlpZiAoICFtdWx0aXBsZVBhbmVscyApIHsKCgkJCXRoaXMuZG9jdW1lbnQub2ZmKCAicGFuZWxvcGVuIHBhbmVsY2xvc2UiICk7CgoJCQlpZiAoIHRoaXMuX29wZW4gKSB7CgkJCQl0aGlzLmRvY3VtZW50Lm9mZiggdGhpcy5fdHJhbnNpdGlvbkVuZEV2ZW50cyApOwoJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCk7CgkJCX0KCQl9CgoJCWlmICggdGhpcy5fb3BlbiApIHsKCQkJdGhpcy5fcGFnZSgpLmpxbVJlbW92ZURhdGEoICJwYW5lbCIgKTsKCQl9CgoJCXRoaXMuX3BhbmVsSW5uZXIuY2hpbGRyZW4oKS51bndyYXAoKTsKCgkJdGhpcy5lbGVtZW50CgkJCS5yZW1vdmVDbGFzcyggWyB0aGlzLl9nZXRQYW5lbENsYXNzZXMoKSwgby5jbGFzc2VzLnBhbmVsT3Blbiwgby5jbGFzc2VzLmFuaW1hdGUgXS5qb2luKCAiICIgKSApCgkJCS5vZmYoICJzd2lwZWxlZnQucGFuZWwgc3dpcGVyaWdodC5wYW5lbCIgKQoJCQkub2ZmKCAicGFuZWxiZWZvcmVvcGVuIiApCgkJCS5vZmYoICJwYW5lbGhpZGUiICkKCQkJLm9mZiggImtleXVwLnBhbmVsIiApCgkJCS5vZmYoICJ1cGRhdGVsYXlvdXQiICkKCQkJLm9mZiggdGhpcy5fdHJhbnNpdGlvbkVuZEV2ZW50cyApOwoKCQl0aGlzLl9jbG9zZUxpbmsub2ZmKCAiY2xpY2sucGFuZWwiICk7CgoJCWlmICggdGhpcy5fbW9kYWwgKSB7CgkJCXRoaXMuX21vZGFsLnJlbW92ZSgpOwoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRhYmxlIiwgewoJb3B0aW9uczogewoJCWNsYXNzZXM6IHsKCQkJdGFibGU6ICJ1aS10YWJsZSIKCQl9LAoJCWVuaGFuY2VkOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMudGFibGUgKTsKCQl9CgoJCS8vIGV4dGVuZCBoZXJlLCBhc3NpZ24gb24gcmVmcmVzaCA+IF9zZXRIZWFkZXJzCgkJJC5leHRlbmQoIHRoaXMsIHsKCgkJCS8vIEV4cG9zZSBoZWFkZXJzIGFuZCBhbGxIZWFkZXJzIHByb3BlcnRpZXMgb24gdGhlIHdpZGdldAoJCQkvLyBoZWFkZXJzIHJlZmVyZW5jZXMgdGhlIFRIcyB3aXRoaW4gdGhlIGZpcnN0IFRSIGluIHRoZSB0YWJsZQoJCQloZWFkZXJzOiB1bmRlZmluZWQsCgoJCQkvLyBhbGxIZWFkZXJzIHJlZmVyZW5jZXMgaGVhZGVycywgcGx1cyBhbGwgVEhzIGluIHRoZSB0aGVhZCwgd2hpY2ggbWF5CgkJCS8vIGluY2x1ZGUgc2V2ZXJhbCByb3dzLCBvciBub3QKCQkJYWxsSGVhZGVyczogdW5kZWZpbmVkCgkJfSk7CgoJCXRoaXMuX3JlZnJlc2goIHRydWUgKTsKCX0sCgoJX3NldEhlYWRlcnM6IGZ1bmN0aW9uKCkgewoJCXZhciB0cnMgPSB0aGlzLmVsZW1lbnQuZmluZCggInRoZWFkIHRyIiApOwoKCQl0aGlzLmhlYWRlcnMgPSB0aGlzLmVsZW1lbnQuZmluZCggInRyOmVxKDApIiApLmNoaWxkcmVuKCk7CgkJdGhpcy5hbGxIZWFkZXJzID0gdGhpcy5oZWFkZXJzLmFkZCggdHJzLmNoaWxkcmVuKCkgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcmVmcmVzaCgpOwoJfSwKCglyZWJ1aWxkOiAkLm5vb3AsCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCAvKiBjcmVhdGUgKi8gKSB7CgkJdmFyIHRhYmxlID0gdGhpcy5lbGVtZW50LAoJCQl0cnMgPSB0YWJsZS5maW5kKCAidGhlYWQgdHIiICk7CgoJCS8vIHVwZGF0aW5nIGhlYWRlcnMgb24gcmVmcmVzaCAoZml4ZXMgIzU4ODApCgkJdGhpcy5fc2V0SGVhZGVycygpOwoKCQkvLyBJdGVyYXRlIG92ZXIgdGhlIHRycwoJCXRycy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGNvbHVtbkNvdW50ID0gMDsKCgkJCS8vIEl0ZXJhdGUgb3ZlciB0aGUgY2hpbGRyZW4gb2YgdGhlIHRyCgkJCSQoIHRoaXMgKS5jaGlsZHJlbigpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNwYW4gPSBwYXJzZUludCggdGhpcy5nZXRBdHRyaWJ1dGUoICJjb2xzcGFuIiApLCAxMCApLAoJCQkJCXNlbGVjdG9yID0gIjpudGgtY2hpbGQoIiArICggY29sdW1uQ291bnQgKyAxICkgKyAiKSIsCgkJCQkJajsKCgkJCQl0aGlzLnNldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgImNvbHN0YXJ0IiwgY29sdW1uQ291bnQgKyAxICk7CgoJCQkJaWYgKCBzcGFuICkgewoJCQkJCWZvciggaiA9IDA7IGogPCBzcGFuIC0gMTsgaisrICkgewoJCQkJCQljb2x1bW5Db3VudCsrOwoJCQkJCQlzZWxlY3RvciArPSAiLCA6bnRoLWNoaWxkKCIgKyAoIGNvbHVtbkNvdW50ICsgMSApICsgIikiOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBTdG9yZSAiY2VsbHMiIGRhdGEgb24gaGVhZGVyIGFzIGEgcmVmZXJlbmNlIHRvIGFsbCBjZWxscyBpbiB0aGUKCQkJCS8vIHNhbWUgY29sdW1uIGFzIHRoaXMgVEgKCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAiY2VsbHMiLCB0YWJsZS5maW5kKCAidHIiICkubm90KCB0cnMuZXEoIDAgKSApLm5vdCggdGhpcyApLmNoaWxkcmVuKCBzZWxlY3RvciApICk7CgoJCQkJY29sdW1uQ291bnQrKzsKCQkJfSk7CgkJfSk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUudGFibGUiLCAkLm1vYmlsZS50YWJsZSwgewoJb3B0aW9uczogewoJCW1vZGU6ICJjb2x1bW50b2dnbGUiLAoJCWNvbHVtbkJ0blRoZW1lOiBudWxsLAoJCWNvbHVtblBvcHVwVGhlbWU6IG51bGwsCgkJY29sdW1uQnRuVGV4dDogIkNvbHVtbnMuLi4iLAoJCWNsYXNzZXM6ICQuZXh0ZW5kKCAkLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jbGFzc2VzLCB7CgkJCXBvcHVwOiAidWktdGFibGUtY29sdW1udG9nZ2xlLXBvcHVwIiwKCQkJY29sdW1uQnRuOiAidWktdGFibGUtY29sdW1udG9nZ2xlLWJ0biIsCgkJCXByaW9yaXR5UHJlZml4OiAidWktdGFibGUtcHJpb3JpdHktIiwKCQkJY29sdW1uVG9nZ2xlVGFibGU6ICJ1aS10YWJsZS1jb2x1bW50b2dnbGUiCgkJfSkKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMubW9kZSAhPT0gImNvbHVtbnRvZ2dsZSIgKSB7CgkJCXJldHVybjsKCQl9CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9tZW51OiBudWxsCgkJfSk7CgoJCWlmICggdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9tZW51ID0gJCggdGhpcy5kb2N1bWVudFsgMCBdLmdldEVsZW1lbnRCeUlkKCB0aGlzLl9pZCgpICsgIi1wb3B1cCIgKSApLmNoaWxkcmVuKCkuZmlyc3QoKTsKCQkJdGhpcy5fYWRkVG9nZ2xlcyggdGhpcy5fbWVudSwgdHJ1ZSApOwoJCQl0aGlzLl9iaW5kVG9nZ2xlcyggdGhpcy5fbWVudSApOwoJCX0gZWxzZSB7CgkJCXRoaXMuX21lbnUgPSB0aGlzLl9lbmhhbmNlQ29sVG9nZ2xlKCk7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMuY29sdW1uVG9nZ2xlVGFibGUgKTsKCQl9CgoJCXRoaXMuX3NldHVwRXZlbnRzKCk7CgoJCXRoaXMuX3NldFRvZ2dsZVN0YXRlKCk7Cgl9LAoKCV9pZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICggdGhpcy5lbGVtZW50LmF0dHIoICJpZCIgKSB8fCAoIHRoaXMud2lkZ2V0TmFtZSArIHRoaXMudXVpZCApICk7Cgl9LAoKCV9zZXR1cEV2ZW50czogZnVuY3Rpb24oKSB7CgkJLy9OT1RFOiBpbnB1dHMgYXJlIGJvdW5kIGluIGJpbmRUb2dnbGVzLAoJCS8vIHNvIGl0IGNhbiBiZSBjYWxsZWQgb24gcmVmcmVzaCwgdG9vCgoJCS8vIHVwZGF0ZSBjb2x1bW4gdG9nZ2xlcyBvbiByZXNpemUKCQl0aGlzLl9vbiggdGhpcy53aW5kb3csIHsKCQkJdGhyb3R0bGVkcmVzaXplOiAiX3NldFRvZ2dsZVN0YXRlIgoJCX0pOwoJfSwKCglfYmluZFRvZ2dsZXM6IGZ1bmN0aW9uKCBtZW51ICkgewoJCXZhciBpbnB1dHMgPSBtZW51LmZpbmQoICJpbnB1dCIgKTsKCgkJdGhpcy5fb24oIGlucHV0cywgewoJCQljaGFuZ2U6ICJfbWVudUlucHV0Q2hhbmdlIgoJCX0pOwoJfSwKCglfYWRkVG9nZ2xlczogZnVuY3Rpb24oIG1lbnUsIGtlZXAgKSB7CgkJdmFyIGlucHV0cywKCQkJY2hlY2tib3hJbmRleCA9IDAsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnMsCgkJCWNvbnRhaW5lciA9IG1lbnUuY29udHJvbGdyb3VwKCAiY29udGFpbmVyIiApOwoKCQkvLyBhbGxvdyB1cGRhdGUgb2YgbWVudSBvbiByZWZyZXNoIChmaXhlcyAjNTg4MCkKCQlpZiAoIGtlZXAgKSB7CgkJCWlucHV0cyA9IG1lbnUuZmluZCggImlucHV0IiApOwoJCX0gZWxzZSB7CgkJCWNvbnRhaW5lci5lbXB0eSgpOwoJCX0KCgkJLy8gY3JlYXRlIHRoZSBoaWRlL3Nob3cgdG9nZ2xlcwoJCXRoaXMuaGVhZGVycy5ub3QoICJ0ZCIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGhlYWRlciA9ICQoIHRoaXMgKSwKCQkJCXByaW9yaXR5ID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAicHJpb3JpdHkiICksCgkJCQljZWxscyA9IGhlYWRlci5hZGQoIGhlYWRlci5qcW1EYXRhKCAiY2VsbHMiICkgKTsKCgkJCWlmICggcHJpb3JpdHkgKSB7CgkJCQljZWxscy5hZGRDbGFzcyggb3B0cy5jbGFzc2VzLnByaW9yaXR5UHJlZml4ICsgcHJpb3JpdHkgKTsKCgkJCQkoIGtlZXAgPyBpbnB1dHMuZXEoIGNoZWNrYm94SW5kZXgrKyApIDoKCQkJCQkkKCI8bGFiZWw+PGlucHV0IHR5cGU9J2NoZWNrYm94JyBjaGVja2VkIC8+IiArCgkJCQkJCSggaGVhZGVyLmNoaWxkcmVuKCAiYWJiciIgKS5maXJzdCgpLmF0dHIoICJ0aXRsZSIgKSB8fAoJCQkJCQkJaGVhZGVyLnRleHQoKSApICsKCQkJCQkJIjwvbGFiZWw+IiApCgkJCQkJCS5hcHBlbmRUbyggY29udGFpbmVyICkKCQkJCQkJLmNoaWxkcmVuKCAwICkKCQkJCQkJLmNoZWNrYm94cmFkaW8oIHsKCQkJCQkJCXRoZW1lOiBvcHRzLmNvbHVtblBvcHVwVGhlbWUKCQkJCQkJfSkgKQoJCQkJCS5qcW1EYXRhKCAiY2VsbHMiLCBjZWxscyApOwoJCQl9CgkJfSk7CgoJCS8vIHNldCBiaW5kaW5ncyBoZXJlCgkJaWYgKCAha2VlcCApIHsKCQkJbWVudS5jb250cm9sZ3JvdXAoICJyZWZyZXNoIiApOwoJCQl0aGlzLl9iaW5kVG9nZ2xlcyggbWVudSApOwoJCX0KCX0sCgoJX21lbnVJbnB1dENoYW5nZTogZnVuY3Rpb24oIGV2dCApIHsKCQl2YXIgaW5wdXQgPSAkKCBldnQudGFyZ2V0ICksCgkJCWNoZWNrZWQgPSBpbnB1dFsgMCBdLmNoZWNrZWQ7CgoJCWlucHV0LmpxbURhdGEoICJjZWxscyIgKQoJCQkudG9nZ2xlQ2xhc3MoICJ1aS10YWJsZS1jZWxsLWhpZGRlbiIsICFjaGVja2VkICkKCQkJLnRvZ2dsZUNsYXNzKCAidWktdGFibGUtY2VsbC12aXNpYmxlIiwgY2hlY2tlZCApOwoKCQlpZiAoIGlucHV0WyAwIF0uZ2V0QXR0cmlidXRlKCAibG9ja2VkIiApICkgewoJCQlpbnB1dC5yZW1vdmVBdHRyKCAibG9ja2VkIiApOwoKCQkJdGhpcy5fdW5sb2NrQ2VsbHMoIGlucHV0LmpxbURhdGEoICJjZWxscyIgKSApOwoJCX0gZWxzZSB7CgkJCWlucHV0LmF0dHIoICJsb2NrZWQiLCB0cnVlICk7CgkJfQoJfSwKCglfdW5sb2NrQ2VsbHM6IGZ1bmN0aW9uKCBjZWxscyApIHsKCQkvLyBhbGxvdyBoaWRlL3Nob3cgdmlhIENTUyBvbmx5ID0gcmVtb3ZlIGFsbCB0b2dnbGUtbG9ja3MKCQljZWxscy5yZW1vdmVDbGFzcyggInVpLXRhYmxlLWNlbGwtaGlkZGVuIHVpLXRhYmxlLWNlbGwtdmlzaWJsZSIpOwoJfSwKCglfZW5oYW5jZUNvbFRvZ2dsZTogZnVuY3Rpb24oKSB7CgkJdmFyIGlkICwgbWVudUJ1dHRvbiwgcG9wdXAsIG1lbnUsCgkJCXRhYmxlID0gdGhpcy5lbGVtZW50LAoJCQlvcHRzID0gdGhpcy5vcHRpb25zLAoJCQlucyA9ICQubW9iaWxlLm5zLAoJCQlmcmFnbWVudCA9IHRoaXMuZG9jdW1lbnRbIDAgXS5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CgoJCWlkID0gdGhpcy5faWQoKSArICItcG9wdXAiOwoJCW1lbnVCdXR0b24gPSAkKCAiPGEgaHJlZj0nIyIgKyBpZCArICInICIgKwoJCQkiY2xhc3M9JyIgKyBvcHRzLmNsYXNzZXMuY29sdW1uQnRuICsgIiB1aS1idG4gIiArCgkJCSJ1aS1idG4tIiArICggb3B0cy5jb2x1bW5CdG5UaGVtZSB8fCAiYSIgKSArCgkJCSIgdWktY29ybmVyLWFsbCB1aS1zaGFkb3cgdWktbWluaScgIiArCgkJCSJkYXRhLSIgKyBucyArICJyZWw9J3BvcHVwJz4iICsgb3B0cy5jb2x1bW5CdG5UZXh0ICsgIjwvYT4iICk7CgkJcG9wdXAgPSAkKCAiPGRpdiBjbGFzcz0nIiArIG9wdHMuY2xhc3Nlcy5wb3B1cCArICInIGlkPSciICsgaWQgKyAiJz48L2Rpdj4iICk7CgkJbWVudSA9ICQoICI8ZmllbGRzZXQ+PC9maWVsZHNldD4iICkuY29udHJvbGdyb3VwKCk7CgoJCS8vIHNldCBleHRlbnNpb24gaGVyZSwgc2VuZCAiZmFsc2UiIHRvIHRyaWdnZXIgYnVpbGQvcmVidWlsZAoJCXRoaXMuX2FkZFRvZ2dsZXMoIG1lbnUsIGZhbHNlICk7CgoJCW1lbnUuYXBwZW5kVG8oIHBvcHVwICk7CgoJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBwb3B1cFsgMCBdICk7CgkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIG1lbnVCdXR0b25bIDAgXSApOwoJCXRhYmxlLmJlZm9yZSggZnJhZ21lbnQgKTsKCgkJcG9wdXAucG9wdXAoKTsKCgkJcmV0dXJuIG1lbnU7Cgl9LAoKCXJlYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLm1vZGUgPT09ICJjb2x1bW50b2dnbGUiICkgewoJCQkvLyBOT1RFOiByZWJ1aWxkIHBhc3NlcyAiZmFsc2UiLCB3aGlsZSByZWZyZXNoIHBhc3NlcyAidW5kZWZpbmVkIgoJCQkvLyBib3RoIHJlZnJlc2ggdGhlIHRhYmxlLCBidXQgaW5zaWRlIGFkZFRvZ2dsZXMsICFmYWxzZSB3aWxsIGJlIHRydWUsCgkJCS8vIHNvIGEgcmVidWlsZCBjYWxsIGNhbiBiZSBpbmRlbnRpZmllZAoJCQl0aGlzLl9yZWZyZXNoKCBmYWxzZSApOwoJCX0KCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdGhpcy5fc3VwZXIoIGNyZWF0ZSApOwoKCQlpZiAoICFjcmVhdGUgJiYgdGhpcy5vcHRpb25zLm1vZGUgPT09ICJjb2x1bW50b2dnbGUiICkgewoJCQkvLyBjb2x1bW5zIG5vdCBiZWluZyByZXBsYWNlZCBtdXN0IGJlIGNsZWFyZWQgZnJvbSBpbnB1dCB0b2dnbGUtbG9ja3MKCQkJdGhpcy5fdW5sb2NrQ2VsbHMoIHRoaXMuYWxsSGVhZGVycyApOwoKCQkJLy8gdXBkYXRlIGNvbHVtbnRvZ2dsZXMgYW5kIGNlbGxzCgkJCXRoaXMuX2FkZFRvZ2dsZXMoIHRoaXMuX21lbnUsIGNyZWF0ZSApOwoKCQkJLy8gY2hlY2svdW5jaGVjawoJCQl0aGlzLl9zZXRUb2dnbGVTdGF0ZSgpOwoJCX0KCX0sCgoJX3NldFRvZ2dsZVN0YXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9tZW51LmZpbmQoICJpbnB1dCIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGNoZWNrYm94ID0gJCggdGhpcyApOwoKCQkJdGhpcy5jaGVja2VkID0gY2hlY2tib3guanFtRGF0YSggImNlbGxzIiApLmVxKCAwICkuY3NzKCAiZGlzcGxheSIgKSA9PT0gInRhYmxlLWNlbGwiOwoJCQljaGVja2JveC5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCQl9KTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50YWJsZSIsICQubW9iaWxlLnRhYmxlLCB7CglvcHRpb25zOiB7CgkJbW9kZTogInJlZmxvdyIsCgkJY2xhc3NlczogJC5leHRlbmQoICQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNsYXNzZXMsIHsKCQkJcmVmbG93VGFibGU6ICJ1aS10YWJsZS1yZWZsb3ciLAoJCQljZWxsTGFiZWxzOiAidWktdGFibGUtY2VsbC1sYWJlbCIKCQl9KQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQkvLyBJZiBpdCdzIG5vdCByZWZsb3cgbW9kZSwgcmV0dXJuIGhlcmUuCgkJaWYgKCB0aGlzLm9wdGlvbnMubW9kZSAhPT0gInJlZmxvdyIgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5yZWZsb3dUYWJsZSApOwoKCQkJdGhpcy5fdXBkYXRlUmVmbG93KCk7CgkJfQoJfSwKCglyZWJ1aWxkOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5tb2RlID09PSAicmVmbG93IiApIHsKCQkJdGhpcy5fcmVmcmVzaCggZmFsc2UgKTsKCQl9Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXRoaXMuX3N1cGVyKCBjcmVhdGUgKTsKCQlpZiAoICFjcmVhdGUgJiYgdGhpcy5vcHRpb25zLm1vZGUgPT09ICJyZWZsb3ciICkgewoJCQl0aGlzLl91cGRhdGVSZWZsb3coICk7CgkJfQoJfSwKCglfdXBkYXRlUmVmbG93OiBmdW5jdGlvbigpIHsKCQl2YXIgdGFibGUgPSB0aGlzLAoJCQlvcHRzID0gdGhpcy5vcHRpb25zOwoKCQkvLyBnZXQgaGVhZGVycyBpbiByZXZlcnNlIG9yZGVyIHNvIHRoYXQgdG9wLWxldmVsIGhlYWRlcnMgYXJlIGFwcGVuZGVkIGxhc3QKCQkkKCB0YWJsZS5hbGxIZWFkZXJzLmdldCgpLnJldmVyc2UoKSApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgY2VsbHMgPSAkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiApLAoJCQkJY29sc3RhcnQgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMsICJjb2xzdGFydCIgKSwKCQkJCWhpZXJhcmNoeUNsYXNzID0gY2VsbHMubm90KCB0aGlzICkuZmlsdGVyKCAidGhlYWQgdGgiICkubGVuZ3RoICYmICIgdWktdGFibGUtY2VsbC1sYWJlbC10b3AiLAoJCQkJdGV4dCA9ICQoIHRoaXMgKS50ZXh0KCksCgkJCQlpdGVyYXRpb24sIGZpbHRlcjsKCgkJCQlpZiAoIHRleHQgIT09ICIiICApIHsKCgkJCQkJaWYgKCBoaWVyYXJjaHlDbGFzcyApIHsKCQkJCQkJaXRlcmF0aW9uID0gcGFyc2VJbnQoIHRoaXMuZ2V0QXR0cmlidXRlKCAiY29sc3BhbiIgKSwgMTAgKTsKCQkJCQkJZmlsdGVyID0gIiI7CgoJCQkJCQlpZiAoIGl0ZXJhdGlvbiApIHsKCQkJCQkJCWZpbHRlciA9ICJ0ZDpudGgtY2hpbGQoIisgaXRlcmF0aW9uICsibiArICIgKyAoIGNvbHN0YXJ0ICkgKyIpIjsKCQkJCQkJfQoKCQkJCQkJdGFibGUuX2FkZExhYmVscyggY2VsbHMuZmlsdGVyKCBmaWx0ZXIgKSwgb3B0cy5jbGFzc2VzLmNlbGxMYWJlbHMgKyBoaWVyYXJjaHlDbGFzcywgdGV4dCApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRhYmxlLl9hZGRMYWJlbHMoIGNlbGxzLCBvcHRzLmNsYXNzZXMuY2VsbExhYmVscywgdGV4dCApOwoJCQkJCX0KCgkJCQl9CgkJfSk7Cgl9LAoKCV9hZGRMYWJlbHM6IGZ1bmN0aW9uKCBjZWxscywgbGFiZWwsIHRleHQgKSB7CgkJLy8gLm5vdCBmaXhlcyAjNjAwNgoJCWNlbGxzLm5vdCggIjpoYXMoYi4iICsgbGFiZWwgKyAiKSIgKS5wcmVwZW5kKCAiPGIgY2xhc3M9JyIgKyBsYWJlbCArICInPiIgKyB0ZXh0ICsgIjwvYj4iICApOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gVE9ETyByZW5hbWUgZmlsdGVyQ2FsbGJhY2svZGVwcmVjYXRlIGFuZCBkZWZhdWx0IHRvIHRoZSBpdGVtIGl0c2VsZiBhcyB0aGUgZmlyc3QgYXJndW1lbnQKdmFyIGRlZmF1bHRGaWx0ZXJDYWxsYmFjayA9IGZ1bmN0aW9uKCBpbmRleCwgc2VhcmNoVmFsdWUgKSB7CglyZXR1cm4gKCAoICIiICsgKCAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMsICJmaWx0ZXJ0ZXh0IiApIHx8ICQoIHRoaXMgKS50ZXh0KCkgKSApCgkJLnRvTG93ZXJDYXNlKCkuaW5kZXhPZiggc2VhcmNoVmFsdWUgKSA9PT0gLTEgKTsKfTsKCiQud2lkZ2V0KCAibW9iaWxlLmZpbHRlcmFibGUiLCB7CgoJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEoZmlsdGVyPSd0cnVlJykiLAoKCW9wdGlvbnM6IHsKCQlmaWx0ZXJSZXZlYWw6IGZhbHNlLAoJCWZpbHRlckNhbGxiYWNrOiBkZWZhdWx0RmlsdGVyQ2FsbGJhY2ssCgkJZW5oYW5jZWQ6IGZhbHNlLAoJCWlucHV0OiBudWxsLAoJCWNoaWxkcmVuOiAiPiBsaSwgPiBvcHRpb24sID4gb3B0Z3JvdXAgb3B0aW9uLCA+IHRib2R5IHRyLCA+IC51aS1jb250cm9sZ3JvdXAtY29udHJvbHMgPiAudWktYnRuLCA+IC51aS1jb250cm9sZ3JvdXAtY29udHJvbHMgPiAudWktY2hlY2tib3gsID4gLnVpLWNvbnRyb2xncm91cC1jb250cm9scyA+IC51aS1yYWRpbyIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9zZWFyY2g6IG51bGwsCgkJCV90aW1lcjogMAoJCX0pOwoKCQl0aGlzLl9zZXRJbnB1dCggb3B0cy5pbnB1dCApOwoJCWlmICggIW9wdHMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX2ZpbHRlckl0ZW1zKCAoICggdGhpcy5fc2VhcmNoICYmIHRoaXMuX3NlYXJjaC52YWwoKSApIHx8ICIiICkudG9Mb3dlckNhc2UoKSApOwoJCX0KCX0sCgoJX29uS2V5VXA6IGZ1bmN0aW9uKCkgewoJCXZhciB2YWwsIGxhc3R2YWwsCgkJCXNlYXJjaCA9IHRoaXMuX3NlYXJjaDsKCgkJaWYgKCBzZWFyY2ggKSB7CgkJCXZhbCA9IHNlYXJjaC52YWwoKS50b0xvd2VyQ2FzZSgpLAoJCQlsYXN0dmFsID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCBzZWFyY2hbIDAgXSwgImxhc3R2YWwiICkgKyAiIjsKCgkJCWlmICggbGFzdHZhbCAmJiBsYXN0dmFsID09PSB2YWwgKSB7CgkJCQkvLyBFeGVjdXRlIHRoZSBoYW5kbGVyIG9ubHkgb25jZSBwZXIgdmFsdWUgY2hhbmdlCgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggdGhpcy5fdGltZXIgKSB7CgkJCQl3aW5kb3cuY2xlYXJUaW1lb3V0KCB0aGlzLl90aW1lciApOwoJCQkJdGhpcy5fdGltZXIgPSAwOwoJCQl9CgoJCQl0aGlzLl90aW1lciA9IHRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsKCQkJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVmaWx0ZXIiLCAiYmVmb3JlZmlsdGVyIiwgeyBpbnB1dDogc2VhcmNoIH0gKTsKCgkJCQkvLyBDaGFuZ2UgdmFsIGFzIGxhc3R2YWwgZm9yIG5leHQgZXhlY3V0aW9uCgkJCQlzZWFyY2hbIDAgXS5zZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJsYXN0dmFsIiwgdmFsICk7CgoJCQkJdGhpcy5fZmlsdGVySXRlbXMoIHZhbCApOwoJCQkJdGhpcy5fdGltZXIgPSAwOwoJCQl9LCAyNTAgKTsKCQl9Cgl9LAoKCV9nZXRGaWx0ZXJhYmxlSXRlbXM6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQljaGlsZHJlbiA9IHRoaXMub3B0aW9ucy5jaGlsZHJlbiwKCQkJaXRlbXMgPSAhY2hpbGRyZW4gPyB7IGxlbmd0aDogMCB9OgoJCQkJJC5pc0Z1bmN0aW9uKCBjaGlsZHJlbiApID8gY2hpbGRyZW4oKToKCQkJCWNoaWxkcmVuLm5vZGVOYW1lID8gJCggY2hpbGRyZW4gKToKCQkJCWNoaWxkcmVuLmpxdWVyeSA/IGNoaWxkcmVuOgoJCQkJdGhpcy5lbGVtZW50LmZpbmQoIGNoaWxkcmVuICk7CgoJCWlmICggaXRlbXMubGVuZ3RoID09PSAwICkgewoJCQlpdGVtcyA9IGVsZW0uY2hpbGRyZW4oKTsKCQl9CgoJCXJldHVybiBpdGVtczsKCX0sCgoJX2ZpbHRlckl0ZW1zOiBmdW5jdGlvbiggdmFsICkgewoJCXZhciBpZHgsIGNhbGxiYWNrLCBsZW5ndGgsIGRzdCwKCQkJc2hvdyA9IFtdLAoJCQloaWRlID0gW10sCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnMsCgkJCWZpbHRlckl0ZW1zID0gdGhpcy5fZ2V0RmlsdGVyYWJsZUl0ZW1zKCk7CgoJCWlmICggdmFsICE9IG51bGwgKSB7CgkJCWNhbGxiYWNrID0gb3B0cy5maWx0ZXJDYWxsYmFjayB8fCBkZWZhdWx0RmlsdGVyQ2FsbGJhY2s7CgkJCWxlbmd0aCA9IGZpbHRlckl0ZW1zLmxlbmd0aDsKCgkJCS8vIFBhcnRpdGlvbiB0aGUgaXRlbXMgaW50byB0aG9zZSB0byBiZSBoaWRkZW4gYW5kIHRob3NlIHRvIGJlIHNob3duCgkJCWZvciAoIGlkeCA9IDAgOyBpZHggPCBsZW5ndGggOyBpZHgrKyApIHsKCQkJCWRzdCA9ICggY2FsbGJhY2suY2FsbCggZmlsdGVySXRlbXNbIGlkeCBdLCBpZHgsIHZhbCApICkgPyBoaWRlIDogc2hvdzsKCQkJCWRzdC5wdXNoKCBmaWx0ZXJJdGVtc1sgaWR4IF0gKTsKCQkJfQoJCX0KCgkJLy8gSWYgbm90aGluZyBpcyBoaWRkZW4sIHRoZW4gdGhlIGRlY2lzaW9uIHdoZXRoZXIgdG8gaGlkZSBvciBzaG93IHRoZSBpdGVtcwoJCS8vIGlzIGJhc2VkIG9uIHRoZSAiZmlsdGVyUmV2ZWFsIiBvcHRpb24uCgkJaWYgKCBoaWRlLmxlbmd0aCA9PT0gMCApIHsKCQkJZmlsdGVySXRlbXNbIG9wdHMuZmlsdGVyUmV2ZWFsID8gImFkZENsYXNzIiA6ICJyZW1vdmVDbGFzcyIgXSggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSBlbHNlIHsKCQkJJCggaGlkZSApLmFkZENsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQkJJCggc2hvdyApLnJlbW92ZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9CgoJCXRoaXMuX3JlZnJlc2hDaGlsZFdpZGdldCgpOwoJfSwKCgkvLyBUaGUgRGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiBfcmVmcmVzaENoaWxkV2lkZ2V0IGF0dGVtcHRzIHRvIGNhbGwKCS8vIHJlZnJlc2ggb24gY29sbGFwc2libGVzZXQsIGNvbnRyb2xncm91cCwgc2VsZWN0bWVudSwgb3IgbGlzdHZpZXcKCV9yZWZyZXNoQ2hpbGRXaWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXZhciB3aWRnZXQsIGlkeCwKCQkJcmVjb2duaXplZFdpZGdldHMgPSBbICJjb2xsYXBzaWJsZXNldCIsICJzZWxlY3RtZW51IiwgImNvbnRyb2xncm91cCIsICJsaXN0dmlldyIgXTsKCgkJZm9yICggaWR4ID0gcmVjb2duaXplZFdpZGdldHMubGVuZ3RoIC0gMSA7IGlkeCA+IC0xIDsgaWR4LS0gKSB7CgkJCXdpZGdldCA9IHJlY29nbml6ZWRXaWRnZXRzWyBpZHggXTsKCQkJaWYgKCAkLm1vYmlsZVsgd2lkZ2V0IF0gKSB7CgkJCQl3aWRnZXQgPSB0aGlzLmVsZW1lbnQuZGF0YSggIm1vYmlsZS0iICsgd2lkZ2V0ICk7CgkJCQlpZiAoIHdpZGdldCAmJiAkLmlzRnVuY3Rpb24oIHdpZGdldC5yZWZyZXNoICkgKSB7CgkJCQkJd2lkZ2V0LnJlZnJlc2goKTsKCQkJCX0KCQkJfQoJCX0KCX0sCgoJLy8gVE9ETzogV2hlbiB0aGUgaW5wdXQgaXMgbm90IGludGVybmFsLCBkbyBub3QgZXZlbiBzdG9yZSBpdCBpbiB0aGlzLl9zZWFyY2gKCV9zZXRJbnB1dDogZnVuY3Rpb24gKCBzZWxlY3RvciApIHsKCQl2YXIgc2VhcmNoID0gdGhpcy5fc2VhcmNoOwoKCQkvLyBTdG9wIGEgcGVuZGluZyBmaWx0ZXIgb3BlcmF0aW9uCgkJaWYgKCB0aGlzLl90aW1lciApIHsKCQkJd2luZG93LmNsZWFyVGltZW91dCggdGhpcy5fdGltZXIgKTsKCQkJdGhpcy5fdGltZXIgPSAwOwoJCX0KCgkJaWYgKCBzZWFyY2ggKSB7CgkJCXRoaXMuX29mZiggc2VhcmNoLCAia2V5dXAgY2hhbmdlIGlucHV0IiApOwoJCQlzZWFyY2ggPSBudWxsOwoJCX0KCgkJaWYgKCBzZWxlY3RvciApIHsKCQkJc2VhcmNoID0gc2VsZWN0b3IuanF1ZXJ5ID8gc2VsZWN0b3I6CgkJCQlzZWxlY3Rvci5ub2RlTmFtZSA/ICQoIHNlbGVjdG9yICk6CgkJCQl0aGlzLmRvY3VtZW50LmZpbmQoIHNlbGVjdG9yICk7CgoJCQl0aGlzLl9vbiggc2VhcmNoLCB7CgkJCQlrZXl1cDogIl9vbktleVVwIiwKCQkJCWNoYW5nZTogIl9vbktleVVwIiwKCQkJCWlucHV0OiAiX29uS2V5VXAiCgkJCX0pOwoJCX0KCgkJdGhpcy5fc2VhcmNoID0gc2VhcmNoOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIHJlZmlsdGVyID0gISggKCBvcHRpb25zLmZpbHRlclJldmVhbCA9PT0gdW5kZWZpbmVkICkgJiYKCQkJCSggb3B0aW9ucy5maWx0ZXJDYWxsYmFjayA9PT0gdW5kZWZpbmVkICkgJiYKCQkJCSggb3B0aW9ucy5jaGlsZHJlbiA9PT0gdW5kZWZpbmVkICkgKTsKCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJaWYgKCBvcHRpb25zLmlucHV0ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldElucHV0KCBvcHRpb25zLmlucHV0ICk7CgkJCXJlZmlsdGVyID0gdHJ1ZTsKCQl9CgoJCWlmICggcmVmaWx0ZXIgKSB7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0KCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRzID0gdGhpcy5vcHRpb25zLAoJCQlpdGVtcyA9IHRoaXMuX2dldEZpbHRlcmFibGVJdGVtcygpOwoKCQlpZiAoIG9wdHMuZW5oYW5jZWQgKSB7CgkJCWl0ZW1zLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIG9wdHMuZmlsdGVyUmV2ZWFsICk7CgkJfSBlbHNlIHsKCQkJaXRlbXMucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0KCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLl90aW1lciApIHsKCQkJd2luZG93LmNsZWFyVGltZW91dCggdGhpcy5fdGltZXIgKTsKCQkJdGhpcy5fdGltZXIgPSAwOwoJCX0KCQl0aGlzLl9maWx0ZXJJdGVtcyggKCAoIHRoaXMuX3NlYXJjaCAmJiB0aGlzLl9zZWFyY2gudmFsKCkgKSB8fCAiIiApLnRvTG93ZXJDYXNlKCkgKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIENyZWF0ZSBhIGZ1bmN0aW9uIHRoYXQgd2lsbCByZXBsYWNlIHRoZSBfc2V0T3B0aW9ucyBmdW5jdGlvbiBvZiBhIHdpZGdldCwKLy8gYW5kIHdpbGwgcGFzcyB0aGUgb3B0aW9ucyBvbiB0byB0aGUgaW5wdXQgb2YgdGhlIGZpbHRlcmFibGUuCnZhciByZXBsYWNlU2V0T3B0aW9ucyA9IGZ1bmN0aW9uKCBzZWxmLCBvcmlnICkgewoJCXJldHVybiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJb3JpZy5jYWxsKCB0aGlzLCBvcHRpb25zICk7CgkJCXNlbGYuX3N5bmNUZXh0SW5wdXRPcHRpb25zKCBvcHRpb25zICk7CgkJfTsKCX0sCglyRGl2aWRlckxpc3RJdGVtID0gLyhefFxzKXVpLWxpLWRpdmlkZXIoXHN8JCkvLAoJb3JpZ0RlZmF1bHRGaWx0ZXJDYWxsYmFjayA9ICQubW9iaWxlLmZpbHRlcmFibGUucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2s7CgovLyBPdmVycmlkZSB0aGUgZGVmYXVsdCBmaWx0ZXIgY2FsbGJhY2sgd2l0aCBvbmUgdGhhdCBkb2VzIG5vdCBoaWRlIGxpc3QgZGl2aWRlcnMKJC5tb2JpbGUuZmlsdGVyYWJsZS5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJDYWxsYmFjayA9IGZ1bmN0aW9uKCBpbmRleCwgc2VhcmNoVmFsdWUgKSB7CglyZXR1cm4gIXRoaXMuY2xhc3NOYW1lLm1hdGNoKCByRGl2aWRlckxpc3RJdGVtICkgJiYKCQlvcmlnRGVmYXVsdEZpbHRlckNhbGxiYWNrLmNhbGwoIHRoaXMsIGluZGV4LCBzZWFyY2hWYWx1ZSApOwp9OwoKJC53aWRnZXQoICJtb2JpbGUuZmlsdGVyYWJsZSIsICQubW9iaWxlLmZpbHRlcmFibGUsIHsKCW9wdGlvbnM6IHsKCQlmaWx0ZXJQbGFjZWhvbGRlcjogIkZpbHRlciBpdGVtcy4uLiIsCgkJZmlsdGVyVGhlbWU6IG51bGwKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGlkeCwgd2lkZ2V0TmFtZSwKCQkJZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJcmVjb2duaXplZFdpZGdldHMgPSBbICJjb2xsYXBzaWJsZXNldCIsICJzZWxlY3RtZW51IiwgImNvbnRyb2xncm91cCIsICJsaXN0dmlldyIgXSwKCQkJY3JlYXRlSGFuZGxlcnMgPSB7fTsKCgkJdGhpcy5fc3VwZXIoKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3dpZGdldDogbnVsbAoJCX0pOwoKCQlmb3IgKCBpZHggPSByZWNvZ25pemVkV2lkZ2V0cy5sZW5ndGggLSAxIDsgaWR4ID4gLTEgOyBpZHgtLSApIHsKCQkJd2lkZ2V0TmFtZSA9IHJlY29nbml6ZWRXaWRnZXRzWyBpZHggXTsKCQkJaWYgKCAkLm1vYmlsZVsgd2lkZ2V0TmFtZSBdICkgewoJCQkJaWYgKCB0aGlzLl9zZXRXaWRnZXQoIGVsZW0uZGF0YSggIm1vYmlsZS0iICsgd2lkZ2V0TmFtZSApICkgKSB7CgkJCQkJYnJlYWs7CgkJCQl9IGVsc2UgewoJCQkJCWNyZWF0ZUhhbmRsZXJzWyB3aWRnZXROYW1lICsgImNyZWF0ZSIgXSA9ICJfaGFuZGxlQ3JlYXRlIjsKCQkJCX0KCQkJfQoJCX0KCgkJaWYgKCAhdGhpcy5fd2lkZ2V0ICkgewoJCQl0aGlzLl9vbiggZWxlbSwgY3JlYXRlSGFuZGxlcnMgKTsKCQl9Cgl9LAoKCV9oYW5kbGVDcmVhdGU6IGZ1bmN0aW9uKCBldnQgKSB7CgkJdGhpcy5fc2V0V2lkZ2V0KCB0aGlzLmVsZW1lbnQuZGF0YSggIm1vYmlsZS0iICsgZXZ0LnR5cGUuc3Vic3RyaW5nKCAwLCBldnQudHlwZS5sZW5ndGggLSA2ICkgKSApOwoJfSwKCglfc2V0V2lkZ2V0OiBmdW5jdGlvbiggd2lkZ2V0ICkgewoJCWlmICggIXRoaXMuX3dpZGdldCAmJiB3aWRnZXQgKSB7CgkJCXRoaXMuX3dpZGdldCA9IHdpZGdldDsKCQkJdGhpcy5fd2lkZ2V0Ll9zZXRPcHRpb25zID0gcmVwbGFjZVNldE9wdGlvbnMoIHRoaXMsIHRoaXMuX3dpZGdldC5fc2V0T3B0aW9ucyApOwoJCX0KCgkJaWYgKCAhIXRoaXMuX3dpZGdldCApIHsKCQkJdGhpcy5fc3luY1RleHRJbnB1dE9wdGlvbnMoIHRoaXMuX3dpZGdldC5vcHRpb25zICk7CgkJCWlmICggdGhpcy5fd2lkZ2V0LndpZGdldE5hbWUgPT09ICJsaXN0dmlldyIgKSB7CgkJCQl0aGlzLl93aWRnZXQub3B0aW9ucy5oaWRlZGl2aWRlcnMgPSB0cnVlOwoJCQkJdGhpcy5fd2lkZ2V0LmVsZW1lbnQubGlzdHZpZXcoICJyZWZyZXNoIiApOwoJCQl9CgkJfQoKCQlyZXR1cm4gISF0aGlzLl93aWRnZXQ7Cgl9LAoKCV9pc1NlYXJjaEludGVybmFsOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gKCB0aGlzLl9zZWFyY2ggJiYgdGhpcy5fc2VhcmNoLmpxbURhdGEoICJ1aS1maWx0ZXJhYmxlLSIgKyB0aGlzLnV1aWQgKyAiLWludGVybmFsIiApICk7Cgl9LAoKCV9zZXRJbnB1dDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXZhciBvcHRzID0gdGhpcy5vcHRpb25zLAoJCQl1cGRhdGVQbGFjZWhvbGRlciA9IHRydWUsCgkJCXRleHRpbnB1dE9wdHMgPSB7fTsKCgkJaWYgKCAhc2VsZWN0b3IgKSB7CgkJCWlmICggdGhpcy5faXNTZWFyY2hJbnRlcm5hbCgpICkgewoKCQkJCS8vIElnbm9yZSB0aGUgY2FsbCB0byBzZXQgYSBuZXcgaW5wdXQgaWYgdGhlIHNlbGVjdG9yIGdvZXMgdG8gZmFsc3kgYW5kCgkJCQkvLyB0aGUgY3VycmVudCB0ZXh0aW5wdXQgaXMgYWxyZWFkeSBvZiB0aGUgaW50ZXJuYWxseSBnZW5lcmF0ZWQgdmFyaWV0eS4KCQkJCXJldHVybjsKCQkJfSBlbHNlIHsKCgkJCQkvLyBHZW5lcmF0aW5nIGEgbmV3IHRleHRpbnB1dCB3aWRnZXQuIE5vIG5lZWQgdG8gc2V0IHRoZSBwbGFjZWhvbGRlcgoJCQkJLy8gZnVydGhlciBkb3duIHRoZSBmdW5jdGlvbi4KCQkJCXVwZGF0ZVBsYWNlaG9sZGVyID0gZmFsc2U7CgkJCQlzZWxlY3RvciA9ICQoICI8aW5wdXQgIiArCgkJCQkJImRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGU9J3NlYXJjaCcgIiArCgkJCQkJInBsYWNlaG9sZGVyPSciICsgb3B0cy5maWx0ZXJQbGFjZWhvbGRlciArICInPjwvaW5wdXQ+IiApCgkJCQkJLmpxbURhdGEoICJ1aS1maWx0ZXJhYmxlLSIgKyB0aGlzLnV1aWQgKyAiLWludGVybmFsIiwgdHJ1ZSApOwoJCQkJJCggIjxmb3JtIGNsYXNzPSd1aS1maWx0ZXJhYmxlJz48L2Zvcm0+IiApCgkJCQkJLmFwcGVuZCggc2VsZWN0b3IgKQoJCQkJCS5zdWJtaXQoIGZ1bmN0aW9uKCBldnQgKSB7CgkJCQkJCWV2dC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQlzZWxlY3Rvci5ibHVyKCk7CgkJCQkJfSkKCQkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLmVsZW1lbnQgKTsKCQkJCWlmICggJC5tb2JpbGUudGV4dGlucHV0ICkgewoJCQkJCWlmICggdGhpcy5vcHRpb25zLmZpbHRlclRoZW1lICE9IG51bGwgKSB7CgkJCQkJCXRleHRpbnB1dE9wdHNbICJ0aGVtZSIgXSA9IG9wdHMuZmlsdGVyVGhlbWU7CgkJCQkJfQoKCQkJCQlzZWxlY3Rvci50ZXh0aW5wdXQoIHRleHRpbnB1dE9wdHMgKTsKCQkJCX0KCQkJfQoJCX0KCgkJdGhpcy5fc3VwZXIoIHNlbGVjdG9yICk7CgoJCWlmICggdGhpcy5faXNTZWFyY2hJbnRlcm5hbCgpICYmIHVwZGF0ZVBsYWNlaG9sZGVyICkgewoJCQl0aGlzLl9zZWFyY2guYXR0ciggInBsYWNlaG9sZGVyIiwgdGhpcy5vcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyICk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIHJldCA9IHRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCS8vIE5lZWQgdG8gc2V0IHRoZSBmaWx0ZXJQbGFjZWhvbGRlciBhZnRlciBoYXZpbmcgZXN0YWJsaXNoZWQgdGhlIHNlYXJjaCBpbnB1dAoJCWlmICggb3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlciAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoIHRoaXMuX2lzU2VhcmNoSW50ZXJuYWwoKSApIHsKCQkJCXRoaXMuX3NlYXJjaC5hdHRyKCAicGxhY2Vob2xkZXIiLCBvcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyICk7CgkJCX0KCQl9CgoJCWlmICggb3B0aW9ucy5maWx0ZXJUaGVtZSAhPT0gdW5kZWZpbmVkICYmIHRoaXMuX3NlYXJjaCAmJiAkLm1vYmlsZS50ZXh0aW5wdXQgKSB7CgkJCXRoaXMuX3NlYXJjaC50ZXh0aW5wdXQoICJvcHRpb24iLCAidGhlbWUiLCBvcHRpb25zLmZpbHRlclRoZW1lICk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLl9pc1NlYXJjaEludGVybmFsKCkgKSB7CgkJCXRoaXMuX3NlYXJjaC5yZW1vdmUoKTsKCQl9CgkJdGhpcy5fc3VwZXIoKTsKCX0sCgoJX3N5bmNUZXh0SW5wdXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaWR4LAoJCQl0ZXh0aW5wdXRPcHRpb25zID0ge307CgoJCS8vIFdlIG9ubHkgc3luYyBvcHRpb25zIGlmIHRoZSBmaWx0ZXJhYmxlJ3MgdGV4dGlucHV0IGlzIG9mIHRoZSBpbnRlcm5hbGx5CgkJLy8gZ2VuZXJhdGVkIHZhcmlldHksIHJhdGhlciB0aGFuIG9uZSBzcGVjaWZpZWQgYnkgdGhlIHVzZXIuCgkJaWYgKCB0aGlzLl9pc1NlYXJjaEludGVybmFsKCkgJiYgJC5tb2JpbGUudGV4dGlucHV0ICkgewoKCQkJLy8gQXBwbHkgb25seSB0aGUgb3B0aW9ucyB1bmRlcnN0b29kIGJ5IHRleHRpbnB1dAoJCQlmb3IgKCBpZHggaW4gJC5tb2JpbGUudGV4dGlucHV0LnByb3RvdHlwZS5vcHRpb25zICkgewoJCQkJaWYgKCBvcHRpb25zWyBpZHggXSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCWlmICggaWR4ID09PSAidGhlbWUiICYmIHRoaXMub3B0aW9ucy5maWx0ZXJUaGVtZSAhPSBudWxsICkgewoJCQkJCQl0ZXh0aW5wdXRPcHRpb25zWyBpZHggXSA9IHRoaXMub3B0aW9ucy5maWx0ZXJUaGVtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0ZXh0aW5wdXRPcHRpb25zWyBpZHggXSA9IG9wdGlvbnNbIGlkeCBdOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQl0aGlzLl9zZWFyY2gudGV4dGlucHV0KCAib3B0aW9uIiwgdGV4dGlucHV0T3B0aW9ucyApOwoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgovKiEKICogalF1ZXJ5IFVJIFRhYnMgZmFkZjJiMzEyYTA1MDQwNDM2NDUxYzY0YmJmYWY0ODE0YmM2MmM1NgogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL3RhYnMvCiAqCiAqIERlcGVuZHM6CiAqCWpxdWVyeS51aS5jb3JlLmpzCiAqCWpxdWVyeS51aS53aWRnZXQuanMKICovCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHRhYklkID0gMCwKCXJoYXNoID0gLyMuKiQvOwoKZnVuY3Rpb24gZ2V0TmV4dFRhYklkKCkgewoJcmV0dXJuICsrdGFiSWQ7Cn0KCmZ1bmN0aW9uIGlzTG9jYWwoIGFuY2hvciApIHsKCXJldHVybiBhbmNob3IuaGFzaC5sZW5ndGggPiAxICYmCgkJZGVjb2RlVVJJQ29tcG9uZW50KCBhbmNob3IuaHJlZi5yZXBsYWNlKCByaGFzaCwgIiIgKSApID09PQoJCQlkZWNvZGVVUklDb21wb25lbnQoIGxvY2F0aW9uLmhyZWYucmVwbGFjZSggcmhhc2gsICIiICkgKTsKfQoKJC53aWRnZXQoICJ1aS50YWJzIiwgewoJdmVyc2lvbjogImZhZGYyYjMxMmEwNTA0MDQzNjQ1MWM2NGJiZmFmNDgxNGJjNjJjNTYiLAoJZGVsYXk6IDMwMCwKCW9wdGlvbnM6IHsKCQlhY3RpdmU6IG51bGwsCgkJY29sbGFwc2libGU6IGZhbHNlLAoJCWV2ZW50OiAiY2xpY2siLAoJCWhlaWdodFN0eWxlOiAiY29udGVudCIsCgkJaGlkZTogbnVsbCwKCQlzaG93OiBudWxsLAoKCQkvLyBjYWxsYmFja3MKCQlhY3RpdmF0ZTogbnVsbCwKCQliZWZvcmVBY3RpdmF0ZTogbnVsbCwKCQliZWZvcmVMb2FkOiBudWxsLAoJCWxvYWQ6IG51bGwKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQl0aGlzLnJ1bm5pbmcgPSBmYWxzZTsKCgkJdGhpcy5lbGVtZW50CgkJCS5hZGRDbGFzcyggInVpLXRhYnMgdWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1hbGwiICkKCQkJLnRvZ2dsZUNsYXNzKCAidWktdGFicy1jb2xsYXBzaWJsZSIsIG9wdGlvbnMuY29sbGFwc2libGUgKQoJCQkvLyBQcmV2ZW50IHVzZXJzIGZyb20gZm9jdXNpbmcgZGlzYWJsZWQgdGFicyB2aWEgY2xpY2sKCQkJLmRlbGVnYXRlKCAiLnVpLXRhYnMtbmF2ID4gbGkiLCAibW91c2Vkb3duIiArIHRoaXMuZXZlbnROYW1lc3BhY2UsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggJCggdGhpcyApLmlzKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0pCgkJCS8vIHN1cHBvcnQ6IElFIDw5CgkJCS8vIFByZXZlbnRpbmcgdGhlIGRlZmF1bHQgYWN0aW9uIGluIG1vdXNlZG93biBkb2Vzbid0IHByZXZlbnQgSUUKCQkJLy8gZnJvbSBmb2N1c2luZyB0aGUgZWxlbWVudCwgc28gaWYgdGhlIGFuY2hvciBnZXRzIGZvY3VzZWQsIGJsdXIuCgkJCS8vIFdlIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgZm9jdXNpbmcgdGhlIHByZXZpb3VzbHkgZm9jdXNlZAoJCQkvLyBlbGVtZW50IHNpbmNlIGNsaWNraW5nIG9uIGEgbm9uLWZvY3VzYWJsZSBlbGVtZW50IHNob3VsZCBmb2N1cwoJCQkvLyB0aGUgYm9keSBhbnl3YXkuCgkJCS5kZWxlZ2F0ZSggIi51aS10YWJzLWFuY2hvciIsICJmb2N1cyIgKyB0aGlzLmV2ZW50TmFtZXNwYWNlLCBmdW5jdGlvbigpIHsKCQkJCWlmICggJCggdGhpcyApLmNsb3Nlc3QoICJsaSIgKS5pcyggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSApIHsKCQkJCQl0aGlzLmJsdXIoKTsKCQkJCX0KCQkJfSk7CgoJCXRoaXMuX3Byb2Nlc3NUYWJzKCk7CgkJb3B0aW9ucy5hY3RpdmUgPSB0aGlzLl9pbml0aWFsQWN0aXZlKCk7CgoJCS8vIFRha2UgZGlzYWJsaW5nIHRhYnMgdmlhIGNsYXNzIGF0dHJpYnV0ZSBmcm9tIEhUTUwKCQkvLyBpbnRvIGFjY291bnQgYW5kIHVwZGF0ZSBvcHRpb24gcHJvcGVybHkuCgkJaWYgKCAkLmlzQXJyYXkoIG9wdGlvbnMuZGlzYWJsZWQgKSApIHsKCQkJb3B0aW9ucy5kaXNhYmxlZCA9ICQudW5pcXVlKCBvcHRpb25zLmRpc2FibGVkLmNvbmNhdCgKCQkJCSQubWFwKCB0aGlzLnRhYnMuZmlsdGVyKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApLCBmdW5jdGlvbiggbGkgKSB7CgkJCQkJcmV0dXJuIHRoYXQudGFicy5pbmRleCggbGkgKTsKCQkJCX0pCgkJCSkgKS5zb3J0KCk7CgkJfQoKCQkvLyBjaGVjayBmb3IgbGVuZ3RoIGF2b2lkcyBlcnJvciB3aGVuIGluaXRpYWxpemluZyBlbXB0eSBsaXN0CgkJaWYgKCB0aGlzLm9wdGlvbnMuYWN0aXZlICE9PSBmYWxzZSAmJiB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQl0aGlzLmFjdGl2ZSA9IHRoaXMuX2ZpbmRBY3RpdmUoIG9wdGlvbnMuYWN0aXZlICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5hY3RpdmUgPSAkKCk7CgkJfQoKCQl0aGlzLl9yZWZyZXNoKCk7CgoJCWlmICggdGhpcy5hY3RpdmUubGVuZ3RoICkgewoJCQl0aGlzLmxvYWQoIG9wdGlvbnMuYWN0aXZlICk7CgkJfQoJfSwKCglfaW5pdGlhbEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGFjdGl2ZSA9IHRoaXMub3B0aW9ucy5hY3RpdmUsCgkJCWNvbGxhcHNpYmxlID0gdGhpcy5vcHRpb25zLmNvbGxhcHNpYmxlLAoJCQlsb2NhdGlvbkhhc2ggPSBsb2NhdGlvbi5oYXNoLnN1YnN0cmluZyggMSApOwoKCQlpZiAoIGFjdGl2ZSA9PT0gbnVsbCApIHsKCQkJLy8gY2hlY2sgdGhlIGZyYWdtZW50IGlkZW50aWZpZXIgaW4gdGhlIFVSTAoJCQlpZiAoIGxvY2F0aW9uSGFzaCApIHsKCQkJCXRoaXMudGFicy5lYWNoKGZ1bmN0aW9uKCBpLCB0YWIgKSB7CgkJCQkJaWYgKCAkKCB0YWIgKS5hdHRyKCAiYXJpYS1jb250cm9scyIgKSA9PT0gbG9jYXRpb25IYXNoICkgewoJCQkJCQlhY3RpdmUgPSBpOwoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCgkJCS8vIGNoZWNrIGZvciBhIHRhYiBtYXJrZWQgYWN0aXZlIHZpYSBhIGNsYXNzCgkJCWlmICggYWN0aXZlID09PSBudWxsICkgewoJCQkJYWN0aXZlID0gdGhpcy50YWJzLmluZGV4KCB0aGlzLnRhYnMuZmlsdGVyKCAiLnVpLXRhYnMtYWN0aXZlIiApICk7CgkJCX0KCgkJCS8vIG5vIGFjdGl2ZSB0YWIsIHNldCB0byBmYWxzZQoJCQlpZiAoIGFjdGl2ZSA9PT0gbnVsbCB8fCBhY3RpdmUgPT09IC0xICkgewoJCQkJYWN0aXZlID0gdGhpcy50YWJzLmxlbmd0aCA/IDAgOiBmYWxzZTsKCQkJfQoJCX0KCgkJLy8gaGFuZGxlIG51bWJlcnM6IG5lZ2F0aXZlLCBvdXQgb2YgcmFuZ2UKCQlpZiAoIGFjdGl2ZSAhPT0gZmFsc2UgKSB7CgkJCWFjdGl2ZSA9IHRoaXMudGFicy5pbmRleCggdGhpcy50YWJzLmVxKCBhY3RpdmUgKSApOwoJCQlpZiAoIGFjdGl2ZSA9PT0gLTEgKSB7CgkJCQlhY3RpdmUgPSBjb2xsYXBzaWJsZSA/IGZhbHNlIDogMDsKCQkJfQoJCX0KCgkJLy8gZG9uJ3QgYWxsb3cgY29sbGFwc2libGU6IGZhbHNlIGFuZCBhY3RpdmU6IGZhbHNlCgkJaWYgKCAhY29sbGFwc2libGUgJiYgYWN0aXZlID09PSBmYWxzZSAmJiB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQlhY3RpdmUgPSAwOwoJCX0KCgkJcmV0dXJuIGFjdGl2ZTsKCX0sCgoJX2dldENyZWF0ZUV2ZW50RGF0YTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHsKCQkJdGFiOiB0aGlzLmFjdGl2ZSwKCQkJcGFuZWw6ICF0aGlzLmFjdGl2ZS5sZW5ndGggPyAkKCkgOiB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGhpcy5hY3RpdmUgKQoJCX07Cgl9LAoKCV90YWJLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGZvY3VzZWRUYWIgPSAkKCB0aGlzLmRvY3VtZW50WzBdLmFjdGl2ZUVsZW1lbnQgKS5jbG9zZXN0KCAibGkiICksCgkJCXNlbGVjdGVkSW5kZXggPSB0aGlzLnRhYnMuaW5kZXgoIGZvY3VzZWRUYWIgKSwKCQkJZ29pbmdGb3J3YXJkID0gdHJ1ZTsKCgkJaWYgKCB0aGlzLl9oYW5kbGVQYWdlTmF2KCBldmVudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCSAgICBjYXNlICQudWkua2V5Q29kZS5MRUZUOgoJCQljYXNlICQudWkua2V5Q29kZS5ET1dOOgoJCQkJc2VsZWN0ZWRJbmRleCsrOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC51aS5rZXlDb2RlLlVQOgoJCSAgICBjYXNlICQudWkua2V5Q29kZS5SSUdIVDogCgkJCQlnb2luZ0ZvcndhcmQgPSBmYWxzZTsKCQkJCXNlbGVjdGVkSW5kZXgtLTsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5FTkQ6CgkJCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5hbmNob3JzLmxlbmd0aCAtIDE7CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuSE9NRToKCQkJCXNlbGVjdGVkSW5kZXggPSAwOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC51aS5rZXlDb2RlLlNQQUNFOgoJCQkJLy8gQWN0aXZhdGUgb25seSwgbm8gY29sbGFwc2luZwoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWNsZWFyVGltZW91dCggdGhpcy5hY3RpdmF0aW5nICk7CgkJCQl0aGlzLl9hY3RpdmF0ZSggc2VsZWN0ZWRJbmRleCApOwoJCQkJcmV0dXJuOwoJCQljYXNlICQudWkua2V5Q29kZS5FTlRFUjoKCQkJCS8vIFRvZ2dsZSAoY2FuY2VsIGRlbGF5ZWQgYWN0aXZhdGlvbiwgYWxsb3cgY29sbGFwc2luZykKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQljbGVhclRpbWVvdXQoIHRoaXMuYWN0aXZhdGluZyApOwoJCQkJLy8gRGV0ZXJtaW5lIGlmIHdlIHNob3VsZCBjb2xsYXBzZSBvciBhY3RpdmF0ZQoJCQkJdGhpcy5fYWN0aXZhdGUoIHNlbGVjdGVkSW5kZXggPT09IHRoaXMub3B0aW9ucy5hY3RpdmUgPyBmYWxzZSA6IHNlbGVjdGVkSW5kZXggKTsKCQkJCXJldHVybjsKCQkJZGVmYXVsdDoKCQkJCXJldHVybjsKCQl9CgoJCS8vIEZvY3VzIHRoZSBhcHByb3ByaWF0ZSB0YWIsIGJhc2VkIG9uIHdoaWNoIGtleSB3YXMgcHJlc3NlZAoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJY2xlYXJUaW1lb3V0KCB0aGlzLmFjdGl2YXRpbmcgKTsKCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5fZm9jdXNOZXh0VGFiKCBzZWxlY3RlZEluZGV4LCBnb2luZ0ZvcndhcmQgKTsKCgkJLy8gTmF2aWdhdGluZyB3aXRoIGNvbnRyb2wga2V5IHdpbGwgcHJldmVudCBhdXRvbWF0aWMgYWN0aXZhdGlvbgoJCWlmICggIWV2ZW50LmN0cmxLZXkgKSB7CgkJCS8vIFVwZGF0ZSBhcmlhLXNlbGVjdGVkIGltbWVkaWF0ZWx5IHNvIHRoYXQgQVQgdGhpbmsgdGhlIHRhYiBpcyBhbHJlYWR5IHNlbGVjdGVkLgoJCQkvLyBPdGhlcndpc2UgQVQgbWF5IGNvbmZ1c2UgdGhlIHVzZXIgYnkgc3RhdGluZyB0aGF0IHRoZXkgbmVlZCB0byBhY3RpdmF0ZSB0aGUgdGFiLAoJCQkvLyBidXQgdGhlIHRhYiB3aWxsIGFscmVhZHkgYmUgYWN0aXZhdGVkIGJ5IHRoZSB0aW1lIHRoZSBhbm5vdW5jZW1lbnQgZmluaXNoZXMuCgkJCWZvY3VzZWRUYWIuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCAiZmFsc2UiICk7CgkJCXRoaXMudGFicy5lcSggc2VsZWN0ZWRJbmRleCApLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgInRydWUiICk7CgoJCQl0aGlzLmFjdGl2YXRpbmcgPSB0aGlzLl9kZWxheShmdW5jdGlvbigpIHsKCQkJCXRoaXMub3B0aW9uKCAiYWN0aXZlIiwgc2VsZWN0ZWRJbmRleCApOwoJCQl9LCB0aGlzLmRlbGF5ICk7CgkJfQoJfSwKCglfcGFuZWxLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLl9oYW5kbGVQYWdlTmF2KCBldmVudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBDdHJsK3VwIG1vdmVzIGZvY3VzIHRvIHRoZSBjdXJyZW50IHRhYgoJCWlmICggZXZlbnQuY3RybEtleSAmJiBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuVVAgKSB7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCXRoaXMuYWN0aXZlLmZvY3VzKCk7CgkJfQoJfSwKCgkvLyBBbHQrcGFnZSB1cC9kb3duIG1vdmVzIGZvY3VzIHRvIHRoZSBwcmV2aW91cy9uZXh0IHRhYiAoYW5kIGFjdGl2YXRlcykKCV9oYW5kbGVQYWdlTmF2OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCBldmVudC5hbHRLZXkgJiYgZXZlbnQua2V5Q29kZSA9PT0gJC51aS5rZXlDb2RlLlBBR0VfVVAgKSB7CgkJCXRoaXMuX2FjdGl2YXRlKCB0aGlzLl9mb2N1c05leHRUYWIoIHRoaXMub3B0aW9ucy5hY3RpdmUgLSAxLCBmYWxzZSApICk7CgkJCXJldHVybiB0cnVlOwoJCX0KCQlpZiAoIGV2ZW50LmFsdEtleSAmJiBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuUEFHRV9ET1dOICkgewoJCQl0aGlzLl9hY3RpdmF0ZSggdGhpcy5fZm9jdXNOZXh0VGFiKCB0aGlzLm9wdGlvbnMuYWN0aXZlICsgMSwgdHJ1ZSApICk7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0sCgoJX2ZpbmROZXh0VGFiOiBmdW5jdGlvbiggaW5kZXgsIGdvaW5nRm9yd2FyZCApIHsKCQl2YXIgbGFzdFRhYkluZGV4ID0gdGhpcy50YWJzLmxlbmd0aCAtIDE7CgoJCWZ1bmN0aW9uIGNvbnN0cmFpbigpIHsKCQkJaWYgKCBpbmRleCA+IGxhc3RUYWJJbmRleCApIHsKCQkJCWluZGV4ID0gMDsKCQkJfQoJCQlpZiAoIGluZGV4IDwgMCApIHsKCQkJCWluZGV4ID0gbGFzdFRhYkluZGV4OwoJCQl9CgkJCXJldHVybiBpbmRleDsKCQl9CgoJCXdoaWxlICggJC5pbkFycmF5KCBjb25zdHJhaW4oKSwgdGhpcy5vcHRpb25zLmRpc2FibGVkICkgIT09IC0xICkgewoJCQlpbmRleCA9IGdvaW5nRm9yd2FyZCA/IGluZGV4ICsgMSA6IGluZGV4IC0gMTsKCQl9CgoJCXJldHVybiBpbmRleDsKCX0sCgoJX2ZvY3VzTmV4dFRhYjogZnVuY3Rpb24oIGluZGV4LCBnb2luZ0ZvcndhcmQgKSB7CgkJaW5kZXggPSB0aGlzLl9maW5kTmV4dFRhYiggaW5kZXgsIGdvaW5nRm9yd2FyZCApOwoJCXRoaXMudGFicy5lcSggaW5kZXggKS5mb2N1cygpOwoJCXJldHVybiBpbmRleDsKCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJaWYgKCBrZXkgPT09ICJhY3RpdmUiICkgewoJCQkvLyBfYWN0aXZhdGUoKSB3aWxsIGhhbmRsZSBpbnZhbGlkIHZhbHVlcyBhbmQgdXBkYXRlIHRoaXMub3B0aW9ucwoJCQl0aGlzLl9hY3RpdmF0ZSggdmFsdWUgKTsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7CgkJCS8vIGRvbid0IHVzZSB0aGUgd2lkZ2V0IGZhY3RvcnkncyBkaXNhYmxlZCBoYW5kbGluZwoJCQl0aGlzLl9zZXR1cERpc2FibGVkKCB2YWx1ZSApOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSk7CgoJCWlmICgga2V5ID09PSAiY29sbGFwc2libGUiICkgewoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS10YWJzLWNvbGxhcHNpYmxlIiwgdmFsdWUgKTsKCQkJLy8gU2V0dGluZyBjb2xsYXBzaWJsZTogZmFsc2Ugd2hpbGUgY29sbGFwc2VkOyBvcGVuIGZpcnN0IHBhbmVsCgkJCWlmICggIXZhbHVlICYmIHRoaXMub3B0aW9ucy5hY3RpdmUgPT09IGZhbHNlICkgewoJCQkJdGhpcy5fYWN0aXZhdGUoIDAgKTsKCQkJfQoJCX0KCgkJaWYgKCBrZXkgPT09ICJldmVudCIgKSB7CgkJCXRoaXMuX3NldHVwRXZlbnRzKCB2YWx1ZSApOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJoZWlnaHRTdHlsZSIgKSB7CgkJCXRoaXMuX3NldHVwSGVpZ2h0U3R5bGUoIHZhbHVlICk7CgkJfQoJfSwKCglfdGFiSWQ6IGZ1bmN0aW9uKCB0YWIgKSB7CgkJcmV0dXJuIHRhYi5hdHRyKCAiYXJpYS1jb250cm9scyIgKSB8fCAidWktdGFicy0iICsgZ2V0TmV4dFRhYklkKCk7Cgl9LAoKCV9zYW5pdGl6ZVNlbGVjdG9yOiBmdW5jdGlvbiggaGFzaCApIHsKCQlyZXR1cm4gaGFzaCA/IGhhc2gucmVwbGFjZSggL1shIiQlJicoKSorLC5cLzo7PD0+P0BcW1xdXF5ge3x9fl0vZywgIlxcJCYiICkgOiAiIjsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWxpcyA9IHRoaXMudGFibGlzdC5jaGlsZHJlbiggIjpoYXMoYVtocmVmXSkiICk7CgoJCS8vIGdldCBkaXNhYmxlZCB0YWJzIGZyb20gY2xhc3MgYXR0cmlidXRlIGZyb20gSFRNTAoJCS8vIHRoaXMgd2lsbCBnZXQgY29udmVydGVkIHRvIGEgYm9vbGVhbiBpZiBuZWVkZWQgaW4gX3JlZnJlc2goKQoJCW9wdGlvbnMuZGlzYWJsZWQgPSAkLm1hcCggbGlzLmZpbHRlciggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSwgZnVuY3Rpb24oIHRhYiApIHsKCQkJcmV0dXJuIGxpcy5pbmRleCggdGFiICk7CgkJfSk7CgoJCXRoaXMuX3Byb2Nlc3NUYWJzKCk7CgoJCS8vIHdhcyBjb2xsYXBzZWQgb3Igbm8gdGFicwoJCWlmICggb3B0aW9ucy5hY3RpdmUgPT09IGZhbHNlIHx8ICF0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQlvcHRpb25zLmFjdGl2ZSA9IGZhbHNlOwoJCQl0aGlzLmFjdGl2ZSA9ICQoKTsKCQkvLyB3YXMgYWN0aXZlLCBidXQgYWN0aXZlIHRhYiBpcyBnb25lCgkJfSBlbHNlIGlmICggdGhpcy5hY3RpdmUubGVuZ3RoICYmICEkLmNvbnRhaW5zKCB0aGlzLnRhYmxpc3RbIDAgXSwgdGhpcy5hY3RpdmVbIDAgXSApICkgewoJCQkvLyBhbGwgcmVtYWluaW5nIHRhYnMgYXJlIGRpc2FibGVkCgkJCWlmICggdGhpcy50YWJzLmxlbmd0aCA9PT0gb3B0aW9ucy5kaXNhYmxlZC5sZW5ndGggKSB7CgkJCQlvcHRpb25zLmFjdGl2ZSA9IGZhbHNlOwoJCQkJdGhpcy5hY3RpdmUgPSAkKCk7CgkJCS8vIGFjdGl2YXRlIHByZXZpb3VzIHRhYgoJCQl9IGVsc2UgewoJCQkJdGhpcy5fYWN0aXZhdGUoIHRoaXMuX2ZpbmROZXh0VGFiKCBNYXRoLm1heCggMCwgb3B0aW9ucy5hY3RpdmUgLSAxICksIGZhbHNlICkgKTsKCQkJfQoJCS8vIHdhcyBhY3RpdmUsIGFjdGl2ZSB0YWIgc3RpbGwgZXhpc3RzCgkJfSBlbHNlIHsKCQkJLy8gbWFrZSBzdXJlIGFjdGl2ZSBpbmRleCBpcyBjb3JyZWN0CgkJCW9wdGlvbnMuYWN0aXZlID0gdGhpcy50YWJzLmluZGV4KCB0aGlzLmFjdGl2ZSApOwoJCX0KCgkJdGhpcy5fcmVmcmVzaCgpOwoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0dXBEaXNhYmxlZCggdGhpcy5vcHRpb25zLmRpc2FibGVkICk7CgkJdGhpcy5fc2V0dXBFdmVudHMoIHRoaXMub3B0aW9ucy5ldmVudCApOwoJCXRoaXMuX3NldHVwSGVpZ2h0U3R5bGUoIHRoaXMub3B0aW9ucy5oZWlnaHRTdHlsZSApOwoKCQl0aGlzLnRhYnMubm90KCB0aGlzLmFjdGl2ZSApLmF0dHIoewoJCQkiYXJpYS1zZWxlY3RlZCI6ICJmYWxzZSIsCgkJCXRhYkluZGV4OiAtMQoJCX0pOwoJCXRoaXMucGFuZWxzLm5vdCggdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIHRoaXMuYWN0aXZlICkgKQoJCQkuaGlkZSgpCgkJCS5hdHRyKHsKCQkJCSJhcmlhLWV4cGFuZGVkIjogImZhbHNlIiwKCQkJCSJhcmlhLWhpZGRlbiI6ICJ0cnVlIgoJCQl9KTsKCgkJLy8gTWFrZSBzdXJlIG9uZSB0YWIgaXMgaW4gdGhlIHRhYiBvcmRlcgoJCWlmICggIXRoaXMuYWN0aXZlLmxlbmd0aCApIHsKCQkJdGhpcy50YWJzLmVxKCAwICkuYXR0ciggInRhYkluZGV4IiwgMCApOwoJCX0gZWxzZSB7CgkJCXRoaXMuYWN0aXZlCgkJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLWFjdGl2ZSB1aS1zdGF0ZS1hY3RpdmUiICkKCQkJCS5hdHRyKHsKCQkJCQkiYXJpYS1zZWxlY3RlZCI6ICJ0cnVlIiwKCQkJCQl0YWJJbmRleDogMAoJCQkJfSk7CgkJCXRoaXMuX2dldFBhbmVsRm9yVGFiKCB0aGlzLmFjdGl2ZSApCgkJCQkuc2hvdygpCgkJCQkuYXR0cih7CgkJCQkJImFyaWEtZXhwYW5kZWQiOiAidHJ1ZSIsCgkJCQkJImFyaWEtaGlkZGVuIjogImZhbHNlIgoJCQkJfSk7CgkJfQoJfSwKCglfcHJvY2Vzc1RhYnM6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gdGhpczsKCgkJdGhpcy50YWJsaXN0ID0gdGhpcy5fZ2V0TGlzdCgpCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtbmF2IHVpLWhlbHBlci1yZXNldCB1aS1oZWxwZXItY2xlYXJmaXggdWktd2lkZ2V0LWhlYWRlciB1aS1jb3JuZXItYWxsIiApCgkJCS5hdHRyKCAicm9sZSIsICJ0YWJsaXN0IiApOwoKCQl0aGlzLnRhYnMgPSB0aGlzLnRhYmxpc3QuZmluZCggIj4gbGk6aGFzKGFbaHJlZl0pIiApCgkJCS5hZGRDbGFzcyggInVpLXN0YXRlLWRlZmF1bHQgdWktY29ybmVyLXRvcCIgKQoJCQkuYXR0cih7CgkJCQlyb2xlOiAidGFiIiwKCQkJCXRhYkluZGV4OiAtMQoJCQl9KTsKCgkJdGhpcy5hbmNob3JzID0gdGhpcy50YWJzLm1hcChmdW5jdGlvbigpIHsKCQkJCXJldHVybiAkKCAiYSIsIHRoaXMgKVsgMCBdOwoJCQl9KQoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLWFuY2hvciIgKQoJCQkuYXR0cih7CgkJCQlyb2xlOiAicHJlc2VudGF0aW9uIiwKCQkJCXRhYkluZGV4OiAtMQoJCQl9KTsKCgkJdGhpcy5wYW5lbHMgPSAkKCk7CgoJCXRoaXMuYW5jaG9ycy5lYWNoKGZ1bmN0aW9uKCBpLCBhbmNob3IgKSB7CgkJCXZhciBzZWxlY3RvciwgcGFuZWwsIHBhbmVsSWQsCgkJCQlhbmNob3JJZCA9ICQoIGFuY2hvciApLnVuaXF1ZUlkKCkuYXR0ciggImlkIiApLAoJCQkJdGFiID0gJCggYW5jaG9yICkuY2xvc2VzdCggImxpIiApLAoJCQkJb3JpZ2luYWxBcmlhQ29udHJvbHMgPSB0YWIuYXR0ciggImFyaWEtY29udHJvbHMiICk7CgoJCQkvLyBpbmxpbmUgdGFiCgkJCWlmICggaXNMb2NhbCggYW5jaG9yICkgKSB7CgkJCQlzZWxlY3RvciA9IGFuY2hvci5oYXNoOwoJCQkJcGFuZWwgPSB0aGF0LmVsZW1lbnQuZmluZCggdGhhdC5fc2FuaXRpemVTZWxlY3Rvciggc2VsZWN0b3IgKSApOwoJCQkvLyByZW1vdGUgdGFiCgkJCX0gZWxzZSB7CgkJCQlwYW5lbElkID0gdGhhdC5fdGFiSWQoIHRhYiApOwoJCQkJc2VsZWN0b3IgPSAiIyIgKyBwYW5lbElkOwoJCQkJcGFuZWwgPSB0aGF0LmVsZW1lbnQuZmluZCggc2VsZWN0b3IgKTsKCQkJCWlmICggIXBhbmVsLmxlbmd0aCApIHsKCQkJCQlwYW5lbCA9IHRoYXQuX2NyZWF0ZVBhbmVsKCBwYW5lbElkICk7CgkJCQkJcGFuZWwuaW5zZXJ0QWZ0ZXIoIHRoYXQucGFuZWxzWyBpIC0gMSBdIHx8IHRoYXQudGFibGlzdCApOwoJCQkJfQoJCQkJcGFuZWwuYXR0ciggImFyaWEtbGl2ZSIsICJwb2xpdGUiICk7CgkJCX0KCgkJCWlmICggcGFuZWwubGVuZ3RoKSB7CgkJCQl0aGF0LnBhbmVscyA9IHRoYXQucGFuZWxzLmFkZCggcGFuZWwgKTsKCQkJfQoJCQlpZiAoIG9yaWdpbmFsQXJpYUNvbnRyb2xzICkgewoJCQkJdGFiLmRhdGEoICJ1aS10YWJzLWFyaWEtY29udHJvbHMiLCBvcmlnaW5hbEFyaWFDb250cm9scyApOwoJCQl9CgkJCXRhYi5hdHRyKHsKCQkJCSJhcmlhLWNvbnRyb2xzIjogc2VsZWN0b3Iuc3Vic3RyaW5nKCAxICksCgkJCQkiYXJpYS1sYWJlbGxlZGJ5IjogYW5jaG9ySWQKCQkJfSk7CgkJCXBhbmVsLmF0dHIoICJhcmlhLWxhYmVsbGVkYnkiLCBhbmNob3JJZCApOwoJCX0pOwoKCQl0aGlzLnBhbmVscwoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLXBhbmVsIHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1ib3R0b20iICkKCQkJLmF0dHIoICJyb2xlIiwgInRhYnBhbmVsIiApOwoJfSwKCgkvLyBhbGxvdyBvdmVycmlkaW5nIGhvdyB0byBmaW5kIHRoZSBsaXN0IGZvciByYXJlIHVzYWdlIHNjZW5hcmlvcyAoIzc3MTUpCglfZ2V0TGlzdDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudC5maW5kKCAib2wsdWwiICkuZXEoIDAgKTsKCX0sCgoJX2NyZWF0ZVBhbmVsOiBmdW5jdGlvbiggaWQgKSB7CgkJcmV0dXJuICQoICI8ZGl2PiIgKQoJCQkuYXR0ciggImlkIiwgaWQgKQoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLXBhbmVsIHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1ib3R0b20iICkKCQkJLmRhdGEoICJ1aS10YWJzLWRlc3Ryb3kiLCB0cnVlICk7Cgl9LAoKCV9zZXR1cERpc2FibGVkOiBmdW5jdGlvbiggZGlzYWJsZWQgKSB7CgkJaWYgKCAkLmlzQXJyYXkoIGRpc2FibGVkICkgKSB7CgkJCWlmICggIWRpc2FibGVkLmxlbmd0aCApIHsKCQkJCWRpc2FibGVkID0gZmFsc2U7CgkJCX0gZWxzZSBpZiAoIGRpc2FibGVkLmxlbmd0aCA9PT0gdGhpcy5hbmNob3JzLmxlbmd0aCApIHsKCQkJCWRpc2FibGVkID0gdHJ1ZTsKCQkJfQoJCX0KCgkJLy8gZGlzYWJsZSB0YWJzCgkJZm9yICggdmFyIGkgPSAwLCBsaTsgKCBsaSA9IHRoaXMudGFic1sgaSBdICk7IGkrKyApIHsKCQkJaWYgKCBkaXNhYmxlZCA9PT0gdHJ1ZSB8fCAkLmluQXJyYXkoIGksIGRpc2FibGVkICkgIT09IC0xICkgewoJCQkJJCggbGkgKQoJCQkJCS5hZGRDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApCgkJCQkJLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgInRydWUiICk7CgkJCX0gZWxzZSB7CgkJCQkkKCBsaSApCgkJCQkJLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICk7CgkJCX0KCQl9CgoJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IGRpc2FibGVkOwoJfSwKCglfc2V0dXBFdmVudHM6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgZXZlbnRzID0gewoJCQljbGljazogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCX07CgkJaWYgKCBldmVudCApIHsKCQkJJC5lYWNoKCBldmVudC5zcGxpdCgiICIpLCBmdW5jdGlvbiggaW5kZXgsIGV2ZW50TmFtZSApIHsKCQkJCWV2ZW50c1sgZXZlbnROYW1lIF0gPSAiX2V2ZW50SGFuZGxlciI7CgkJCX0pOwoJCX0KCgkJdGhpcy5fb2ZmKCB0aGlzLmFuY2hvcnMuYWRkKCB0aGlzLnRhYnMgKS5hZGQoIHRoaXMucGFuZWxzICkgKTsKCQl0aGlzLl9vbiggdGhpcy5hbmNob3JzLCBldmVudHMgKTsKCQl0aGlzLl9vbiggdGhpcy50YWJzLCB7IGtleWRvd246ICJfdGFiS2V5ZG93biIgfSApOwoJCXRoaXMuX29uKCB0aGlzLnBhbmVscywgeyBrZXlkb3duOiAiX3BhbmVsS2V5ZG93biIgfSApOwoKCQl0aGlzLl9mb2N1c2FibGUoIHRoaXMudGFicyApOwoJCXRoaXMuX2hvdmVyYWJsZSggdGhpcy50YWJzICk7Cgl9LAoKCV9zZXR1cEhlaWdodFN0eWxlOiBmdW5jdGlvbiggaGVpZ2h0U3R5bGUgKSB7CgkJdmFyIG1heEhlaWdodCwKCQkJcGFyZW50ID0gdGhpcy5lbGVtZW50LnBhcmVudCgpOwoKCQlpZiAoIGhlaWdodFN0eWxlID09PSAiZmlsbCIgKSB7CgkJCW1heEhlaWdodCA9IHBhcmVudC5oZWlnaHQoKTsKCQkJbWF4SGVpZ2h0IC09IHRoaXMuZWxlbWVudC5vdXRlckhlaWdodCgpIC0gdGhpcy5lbGVtZW50LmhlaWdodCgpOwoKCQkJdGhpcy5lbGVtZW50LnNpYmxpbmdzKCAiOnZpc2libGUiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBlbGVtID0gJCggdGhpcyApLAoJCQkJCXBvc2l0aW9uID0gZWxlbS5jc3MoICJwb3NpdGlvbiIgKTsKCgkJCQlpZiAoIHBvc2l0aW9uID09PSAiYWJzb2x1dGUiIHx8IHBvc2l0aW9uID09PSAiZml4ZWQiICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCW1heEhlaWdodCAtPSBlbGVtLm91dGVySGVpZ2h0KCB0cnVlICk7CgkJCX0pOwoKCQkJdGhpcy5lbGVtZW50LmNoaWxkcmVuKCkubm90KCB0aGlzLnBhbmVscyApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQltYXhIZWlnaHQgLT0gJCggdGhpcyApLm91dGVySGVpZ2h0KCB0cnVlICk7CgkJCX0pOwoKCQkJdGhpcy5wYW5lbHMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5oZWlnaHQoIE1hdGgubWF4KCAwLCBtYXhIZWlnaHQgLQoJCQkJCSQoIHRoaXMgKS5pbm5lckhlaWdodCgpICsgJCggdGhpcyApLmhlaWdodCgpICkgKTsKCQkJfSkKCQkJLmNzcyggIm92ZXJmbG93IiwgImF1dG8iICk7CgkJfSBlbHNlIGlmICggaGVpZ2h0U3R5bGUgPT09ICJhdXRvIiApIHsKCQkJbWF4SGVpZ2h0ID0gMDsKCQkJdGhpcy5wYW5lbHMuZWFjaChmdW5jdGlvbigpIHsKCQkJCW1heEhlaWdodCA9IE1hdGgubWF4KCBtYXhIZWlnaHQsICQoIHRoaXMgKS5oZWlnaHQoICIiICkuaGVpZ2h0KCkgKTsKCQkJfSkuaGVpZ2h0KCBtYXhIZWlnaHQgKTsKCQl9Cgl9LAoKCV9ldmVudEhhbmRsZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJYWN0aXZlID0gdGhpcy5hY3RpdmUsCgkJCWFuY2hvciA9ICQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKSwKCQkJdGFiID0gYW5jaG9yLmNsb3Nlc3QoICJsaSIgKSwKCQkJY2xpY2tlZElzQWN0aXZlID0gdGFiWyAwIF0gPT09IGFjdGl2ZVsgMCBdLAoJCQljb2xsYXBzaW5nID0gY2xpY2tlZElzQWN0aXZlICYmIG9wdGlvbnMuY29sbGFwc2libGUsCgkJCXRvU2hvdyA9IGNvbGxhcHNpbmcgPyAkKCkgOiB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGFiICksCgkJCXRvSGlkZSA9ICFhY3RpdmUubGVuZ3RoID8gJCgpIDogdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIGFjdGl2ZSApLAoJCQlldmVudERhdGEgPSB7CgkJCQlvbGRUYWI6IGFjdGl2ZSwKCQkJCW9sZFBhbmVsOiB0b0hpZGUsCgkJCQluZXdUYWI6IGNvbGxhcHNpbmcgPyAkKCkgOiB0YWIsCgkJCQluZXdQYW5lbDogdG9TaG93CgkJCX07CgoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCWlmICggdGFiLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgfHwKCQkJCS8vIHRhYiBpcyBhbHJlYWR5IGxvYWRpbmcKCQkJCXRhYi5oYXNDbGFzcyggInVpLXRhYnMtbG9hZGluZyIgKSB8fAoJCQkJLy8gY2FuJ3Qgc3dpdGNoIGR1cm5pbmcgYW4gYW5pbWF0aW9uCgkJCQl0aGlzLnJ1bm5pbmcgfHwKCQkJCS8vIGNsaWNrIG9uIGFjdGl2ZSBoZWFkZXIsIGJ1dCBub3QgY29sbGFwc2libGUKCQkJCSggY2xpY2tlZElzQWN0aXZlICYmICFvcHRpb25zLmNvbGxhcHNpYmxlICkgfHwKCQkJCS8vIGFsbG93IGNhbmNlbGluZyBhY3RpdmF0aW9uCgkJCQkoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVBY3RpdmF0ZSIsIGV2ZW50LCBldmVudERhdGEgKSA9PT0gZmFsc2UgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJb3B0aW9ucy5hY3RpdmUgPSBjb2xsYXBzaW5nID8gZmFsc2UgOiB0aGlzLnRhYnMuaW5kZXgoIHRhYiApOwoKCQl0aGlzLmFjdGl2ZSA9IGNsaWNrZWRJc0FjdGl2ZSA/ICQoKSA6IHRhYjsKCQlpZiAoIHRoaXMueGhyICkgewoJCQl0aGlzLnhoci5hYm9ydCgpOwoJCX0KCgkJaWYgKCAhdG9IaWRlLmxlbmd0aCAmJiAhdG9TaG93Lmxlbmd0aCApIHsKCQkJJC5lcnJvciggImpRdWVyeSBVSSBUYWJzOiBNaXNtYXRjaGluZyBmcmFnbWVudCBpZGVudGlmaWVyLiIgKTsKCQl9CgoJCWlmICggdG9TaG93Lmxlbmd0aCApIHsKCQkJdGhpcy5sb2FkKCB0aGlzLnRhYnMuaW5kZXgoIHRhYiApLCBldmVudCApOwoJCX0KCQl0aGlzLl90b2dnbGUoIGV2ZW50LCBldmVudERhdGEgKTsKCX0sCgoJLy8gaGFuZGxlcyBzaG93L2hpZGUgZm9yIHNlbGVjdGluZyB0YWJzCglfdG9nZ2xlOiBmdW5jdGlvbiggZXZlbnQsIGV2ZW50RGF0YSApIHsKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCXRvU2hvdyA9IGV2ZW50RGF0YS5uZXdQYW5lbCwKCQkJdG9IaWRlID0gZXZlbnREYXRhLm9sZFBhbmVsOwoKCQl0aGlzLnJ1bm5pbmcgPSB0cnVlOwoKCQlmdW5jdGlvbiBjb21wbGV0ZSgpIHsKCQkJdGhhdC5ydW5uaW5nID0gZmFsc2U7CgkJCXRoYXQuX3RyaWdnZXIoICJhY3RpdmF0ZSIsIGV2ZW50LCBldmVudERhdGEgKTsKCQl9CgoJCWZ1bmN0aW9uIHNob3coKSB7CgkJCWV2ZW50RGF0YS5uZXdUYWIuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktdGFicy1hY3RpdmUgdWktc3RhdGUtYWN0aXZlIiApOwoKCQkJaWYgKCB0b1Nob3cubGVuZ3RoICYmIHRoYXQub3B0aW9ucy5zaG93ICkgewoJCQkJdGhhdC5fc2hvdyggdG9TaG93LCB0aGF0Lm9wdGlvbnMuc2hvdywgY29tcGxldGUgKTsKCQkJfSBlbHNlIHsKCQkJCXRvU2hvdy5zaG93KCk7CgkJCQljb21wbGV0ZSgpOwoJCQl9CgkJfQoKCQkvLyBzdGFydCBvdXQgYnkgaGlkaW5nLCB0aGVuIHNob3dpbmcsIHRoZW4gY29tcGxldGluZwoJCWlmICggdG9IaWRlLmxlbmd0aCAmJiB0aGlzLm9wdGlvbnMuaGlkZSApIHsKCQkJdGhpcy5faGlkZSggdG9IaWRlLCB0aGlzLm9wdGlvbnMuaGlkZSwgZnVuY3Rpb24oKSB7CgkJCQlldmVudERhdGEub2xkVGFiLmNsb3Nlc3QoICJsaSIgKS5yZW1vdmVDbGFzcyggInVpLXRhYnMtYWN0aXZlIHVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCXNob3coKTsKCQkJfSk7CgkJfSBlbHNlIHsKCQkJZXZlbnREYXRhLm9sZFRhYi5jbG9zZXN0KCAibGkiICkucmVtb3ZlQ2xhc3MoICJ1aS10YWJzLWFjdGl2ZSB1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCXRvSGlkZS5oaWRlKCk7CgkJCXNob3coKTsKCQl9CgoJCXRvSGlkZS5hdHRyKHsKCQkJImFyaWEtZXhwYW5kZWQiOiAiZmFsc2UiLAoJCQkiYXJpYS1oaWRkZW4iOiAidHJ1ZSIKCQl9KTsKCQlldmVudERhdGEub2xkVGFiLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgImZhbHNlIiApOwoJCS8vIElmIHdlJ3JlIHN3aXRjaGluZyB0YWJzLCByZW1vdmUgdGhlIG9sZCB0YWIgZnJvbSB0aGUgdGFiIG9yZGVyLgoJCS8vIElmIHdlJ3JlIG9wZW5pbmcgZnJvbSBjb2xsYXBzZWQgc3RhdGUsIHJlbW92ZSB0aGUgcHJldmlvdXMgdGFiIGZyb20gdGhlIHRhYiBvcmRlci4KCQkvLyBJZiB3ZSdyZSBjb2xsYXBzaW5nLCB0aGVuIGtlZXAgdGhlIGNvbGxhcHNpbmcgdGFiIGluIHRoZSB0YWIgb3JkZXIuCgkJaWYgKCB0b1Nob3cubGVuZ3RoICYmIHRvSGlkZS5sZW5ndGggKSB7CgkJCWV2ZW50RGF0YS5vbGRUYWIuYXR0ciggInRhYkluZGV4IiwgLTEgKTsKCQl9IGVsc2UgaWYgKCB0b1Nob3cubGVuZ3RoICkgewoJCQl0aGlzLnRhYnMuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICQoIHRoaXMgKS5hdHRyKCAidGFiSW5kZXgiICkgPT09IDA7CgkJCX0pCgkJCS5hdHRyKCAidGFiSW5kZXgiLCAtMSApOwoJCX0KCgkJdG9TaG93LmF0dHIoewoJCQkiYXJpYS1leHBhbmRlZCI6ICJ0cnVlIiwKCQkJImFyaWEtaGlkZGVuIjogImZhbHNlIgoJCX0pOwoJCWV2ZW50RGF0YS5uZXdUYWIuYXR0cih7CgkJCSJhcmlhLXNlbGVjdGVkIjogInRydWUiLAoJCQl0YWJJbmRleDogMAoJCX0pOwoJfSwKCglfYWN0aXZhdGU6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQl2YXIgYW5jaG9yLAoJCQlhY3RpdmUgPSB0aGlzLl9maW5kQWN0aXZlKCBpbmRleCApOwoKCQkvLyB0cnlpbmcgdG8gYWN0aXZhdGUgdGhlIGFscmVhZHkgYWN0aXZlIHBhbmVsCgkJaWYgKCBhY3RpdmVbIDAgXSA9PT0gdGhpcy5hY3RpdmVbIDAgXSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gdHJ5aW5nIHRvIGNvbGxhcHNlLCBzaW11bGF0ZSBhIGNsaWNrIG9uIHRoZSBjdXJyZW50IGFjdGl2ZSBoZWFkZXIKCQlpZiAoICFhY3RpdmUubGVuZ3RoICkgewoJCQlhY3RpdmUgPSB0aGlzLmFjdGl2ZTsKCQl9CgoJCWFuY2hvciA9IGFjdGl2ZS5maW5kKCAiLnVpLXRhYnMtYW5jaG9yIiApWyAwIF07CgkJdGhpcy5fZXZlbnRIYW5kbGVyKHsKCQkJdGFyZ2V0OiBhbmNob3IsCgkJCWN1cnJlbnRUYXJnZXQ6IGFuY2hvciwKCQkJcHJldmVudERlZmF1bHQ6ICQubm9vcAoJCX0pOwoJfSwKCglfZmluZEFjdGl2ZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXJldHVybiBpbmRleCA9PT0gZmFsc2UgPyAkKCkgOiB0aGlzLnRhYnMuZXEoIGluZGV4ICk7Cgl9LAoKCV9nZXRJbmRleDogZnVuY3Rpb24oIGluZGV4ICkgewoJCS8vIG1ldGEtZnVuY3Rpb24gdG8gZ2l2ZSB1c2VycyBvcHRpb24gdG8gcHJvdmlkZSBhIGhyZWYgc3RyaW5nIGluc3RlYWQgb2YgYSBudW1lcmljYWwgaW5kZXguCgkJaWYgKCB0eXBlb2YgaW5kZXggPT09ICJzdHJpbmciICkgewoJCQlpbmRleCA9IHRoaXMuYW5jaG9ycy5pbmRleCggdGhpcy5hbmNob3JzLmZpbHRlciggIltocmVmJD0nIiArIGluZGV4ICsgIiddIiApICk7CgkJfQoKCQlyZXR1cm4gaW5kZXg7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMueGhyICkgewoJCQl0aGlzLnhoci5hYm9ydCgpOwoJCX0KCgkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktdGFicyB1aS13aWRnZXQgdWktd2lkZ2V0LWNvbnRlbnQgdWktY29ybmVyLWFsbCB1aS10YWJzLWNvbGxhcHNpYmxlIiApOwoKCQl0aGlzLnRhYmxpc3QKCQkJLnJlbW92ZUNsYXNzKCAidWktdGFicy1uYXYgdWktaGVscGVyLXJlc2V0IHVpLWhlbHBlci1jbGVhcmZpeCB1aS13aWRnZXQtaGVhZGVyIHVpLWNvcm5lci1hbGwiICkKCQkJLnJlbW92ZUF0dHIoICJyb2xlIiApOwoKCQl0aGlzLmFuY2hvcnMKCQkJLnJlbW92ZUNsYXNzKCAidWktdGFicy1hbmNob3IiICkKCQkJLnJlbW92ZUF0dHIoICJyb2xlIiApCgkJCS5yZW1vdmVBdHRyKCAidGFiSW5kZXgiICkKCQkJLnJlbW92ZVVuaXF1ZUlkKCk7CgoJCXRoaXMudGFicy5hZGQoIHRoaXMucGFuZWxzICkuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAkLmRhdGEoIHRoaXMsICJ1aS10YWJzLWRlc3Ryb3kiICkgKSB7CgkJCQkkKCB0aGlzICkucmVtb3ZlKCk7CgkJCX0gZWxzZSB7CgkJCQkkKCB0aGlzICkKCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1kZWZhdWx0IHVpLXN0YXRlLWFjdGl2ZSB1aS1zdGF0ZS1kaXNhYmxlZCAiICsKCQkJCQkJInVpLWNvcm5lci10b3AgdWktY29ybmVyLWJvdHRvbSB1aS13aWRnZXQtY29udGVudCB1aS10YWJzLWFjdGl2ZSB1aS10YWJzLXBhbmVsIiApCgkJCQkJLnJlbW92ZUF0dHIoICJ0YWJJbmRleCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1saXZlIiApCgkJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWJ1c3kiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtc2VsZWN0ZWQiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtbGFiZWxsZWRieSIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1oaWRkZW4iICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtZXhwYW5kZWQiICkKCQkJCQkucmVtb3ZlQXR0ciggInJvbGUiICk7CgkJCX0KCQl9KTsKCgkJdGhpcy50YWJzLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBsaSA9ICQoIHRoaXMgKSwKCQkJCXByZXYgPSBsaS5kYXRhKCAidWktdGFicy1hcmlhLWNvbnRyb2xzIiApOwoJCQlpZiAoIHByZXYgKSB7CgkJCQlsaQoJCQkJCS5hdHRyKCAiYXJpYS1jb250cm9scyIsIHByZXYgKQoJCQkJCS5yZW1vdmVEYXRhKCAidWktdGFicy1hcmlhLWNvbnRyb2xzIiApOwoJCQl9IGVsc2UgewoJCQkJbGkucmVtb3ZlQXR0ciggImFyaWEtY29udHJvbHMiICk7CgkJCX0KCQl9KTsKCgkJdGhpcy5wYW5lbHMuc2hvdygpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5oZWlnaHRTdHlsZSAhPT0gImNvbnRlbnQiICkgewoJCQl0aGlzLnBhbmVscy5jc3MoICJoZWlnaHQiLCAiIiApOwoJCX0KCX0sCgoJZW5hYmxlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJdmFyIGRpc2FibGVkID0gdGhpcy5vcHRpb25zLmRpc2FibGVkOwoJCWlmICggZGlzYWJsZWQgPT09IGZhbHNlICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGluZGV4ID09PSB1bmRlZmluZWQgKSB7CgkJCWRpc2FibGVkID0gZmFsc2U7CgkJfSBlbHNlIHsKCQkJaW5kZXggPSB0aGlzLl9nZXRJbmRleCggaW5kZXggKTsKCQkJaWYgKCAkLmlzQXJyYXkoIGRpc2FibGVkICkgKSB7CgkJCQlkaXNhYmxlZCA9ICQubWFwKCBkaXNhYmxlZCwgZnVuY3Rpb24oIG51bSApIHsKCQkJCQlyZXR1cm4gbnVtICE9PSBpbmRleCA/IG51bSA6IG51bGw7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCWRpc2FibGVkID0gJC5tYXAoIHRoaXMudGFicywgZnVuY3Rpb24oIGxpLCBudW0gKSB7CgkJCQkJcmV0dXJuIG51bSAhPT0gaW5kZXggPyBudW0gOiBudWxsOwoJCQkJfSk7CgkJCX0KCQl9CgkJdGhpcy5fc2V0dXBEaXNhYmxlZCggZGlzYWJsZWQgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXZhciBkaXNhYmxlZCA9IHRoaXMub3B0aW9ucy5kaXNhYmxlZDsKCQlpZiAoIGRpc2FibGVkID09PSB0cnVlICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGluZGV4ID09PSB1bmRlZmluZWQgKSB7CgkJCWRpc2FibGVkID0gdHJ1ZTsKCQl9IGVsc2UgewoJCQlpbmRleCA9IHRoaXMuX2dldEluZGV4KCBpbmRleCApOwoJCQlpZiAoICQuaW5BcnJheSggaW5kZXgsIGRpc2FibGVkICkgIT09IC0xICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggJC5pc0FycmF5KCBkaXNhYmxlZCApICkgewoJCQkJZGlzYWJsZWQgPSAkLm1lcmdlKCBbIGluZGV4IF0sIGRpc2FibGVkICkuc29ydCgpOwoJCQl9IGVsc2UgewoJCQkJZGlzYWJsZWQgPSBbIGluZGV4IF07CgkJCX0KCQl9CgkJdGhpcy5fc2V0dXBEaXNhYmxlZCggZGlzYWJsZWQgKTsKCX0sCgoJbG9hZDogZnVuY3Rpb24oIGluZGV4LCBldmVudCApIHsKCQlpbmRleCA9IHRoaXMuX2dldEluZGV4KCBpbmRleCApOwoJCXZhciB0aGF0ID0gdGhpcywKCQkJdGFiID0gdGhpcy50YWJzLmVxKCBpbmRleCApLAoJCQlhbmNob3IgPSB0YWIuZmluZCggIi51aS10YWJzLWFuY2hvciIgKSwKCQkJcGFuZWwgPSB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGFiICksCgkJCWV2ZW50RGF0YSA9IHsKCQkJCXRhYjogdGFiLAoJCQkJcGFuZWw6IHBhbmVsCgkJCX07CgoJCS8vIG5vdCByZW1vdGUKCQlpZiAoIGlzTG9jYWwoIGFuY2hvclsgMCBdICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMueGhyID0gJC5hamF4KCB0aGlzLl9hamF4U2V0dGluZ3MoIGFuY2hvciwgZXZlbnQsIGV2ZW50RGF0YSApICk7CgoJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJLy8galF1ZXJ5IDwxLjggcmV0dXJucyBmYWxzZSBpZiB0aGUgcmVxdWVzdCBpcyBjYW5jZWxlZCBpbiBiZWZvcmVTZW5kLAoJCS8vIGJ1dCBhcyBvZiAxLjgsICQuYWpheCgpIGFsd2F5cyByZXR1cm5zIGEganFYSFIgb2JqZWN0LgoJCWlmICggdGhpcy54aHIgJiYgdGhpcy54aHIuc3RhdHVzVGV4dCAhPT0gImNhbmNlbGVkIiApIHsKCQkJdGFiLmFkZENsYXNzKCAidWktdGFicy1sb2FkaW5nIiApOwoJCQlwYW5lbC5hdHRyKCAiYXJpYS1idXN5IiwgInRydWUiICk7CgoJCQl0aGlzLnhocgoJCQkJLnN1Y2Nlc3MoZnVuY3Rpb24oIHJlc3BvbnNlICkgewoJCQkJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTE3NzgKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQlwYW5lbC5odG1sKCByZXNwb25zZSApOwoJCQkJCQl0aGF0Ll90cmlnZ2VyKCAibG9hZCIsIGV2ZW50LCBldmVudERhdGEgKTsKCQkJCQl9LCAxICk7CgkJCQl9KQoJCQkJLmNvbXBsZXRlKGZ1bmN0aW9uKCBqcVhIUiwgc3RhdHVzICkgewoJCQkJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTE3NzgKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQlpZiAoIHN0YXR1cyA9PT0gImFib3J0IiApIHsKCQkJCQkJCXRoYXQucGFuZWxzLnN0b3AoIGZhbHNlLCB0cnVlICk7CgkJCQkJCX0KCgkJCQkJCXRhYi5yZW1vdmVDbGFzcyggInVpLXRhYnMtbG9hZGluZyIgKTsKCQkJCQkJcGFuZWwucmVtb3ZlQXR0ciggImFyaWEtYnVzeSIgKTsKCgkJCQkJCWlmICgganFYSFIgPT09IHRoYXQueGhyICkgewoJCQkJCQkJZGVsZXRlIHRoYXQueGhyOwoJCQkJCQl9CgkJCQkJfSwgMSApOwoJCQkJfSk7CgkJfQoJfSwKCglfYWpheFNldHRpbmdzOiBmdW5jdGlvbiggYW5jaG9yLCBldmVudCwgZXZlbnREYXRhICkgewoJCXZhciB0aGF0ID0gdGhpczsKCQlyZXR1cm4gewoJCQl1cmw6IGFuY2hvci5hdHRyKCAiaHJlZiIgKSwKCQkJYmVmb3JlU2VuZDogZnVuY3Rpb24oIGpxWEhSLCBzZXR0aW5ncyApIHsKCQkJCXJldHVybiB0aGF0Ll90cmlnZ2VyKCAiYmVmb3JlTG9hZCIsIGV2ZW50LAoJCQkJCSQuZXh0ZW5kKCB7IGpxWEhSIDoganFYSFIsIGFqYXhTZXR0aW5nczogc2V0dGluZ3MgfSwgZXZlbnREYXRhICkgKTsKCQkJfQoJCX07Cgl9LAoKCV9nZXRQYW5lbEZvclRhYjogZnVuY3Rpb24oIHRhYiApIHsKCQl2YXIgaWQgPSAkKCB0YWIgKS5hdHRyKCAiYXJpYS1jb250cm9scyIgKTsKCQlyZXR1cm4gdGhpcy5lbGVtZW50LmZpbmQoIHRoaXMuX3Nhbml0aXplU2VsZWN0b3IoICIjIiArIGlkICkgKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoKCSQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCA9IHRydWU7CgoJLy8gVGhpcyBmaXggYWRkcmVzc2VzIGFuIGlPUyBidWcsIHNvIHJldHVybiBlYXJseSBpZiB0aGUgVUEgY2xhaW1zIGl0J3Mgc29tZXRoaW5nIGVsc2UuCgl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCXpvb20sCgkJZXZ0LCB4LCB5LCB6LCBhaWc7CglpZiAoICEoIC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiAvT1MgWzEtNV1fWzAtOV9dKiBsaWtlIE1hYyBPUyBYL2kudGVzdCggdWEgKSAmJiB1YS5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSApICkgewoJCSQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCA9IGZhbHNlOwoJCXJldHVybjsKCX0KCgl6b29tID0gJC5tb2JpbGUuem9vbTsKCglmdW5jdGlvbiBjaGVja1RpbHQoIGUgKSB7CgkJZXZ0ID0gZS5vcmlnaW5hbEV2ZW50OwoJCWFpZyA9IGV2dC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5OwoKCQl4ID0gTWF0aC5hYnMoIGFpZy54ICk7CgkJeSA9IE1hdGguYWJzKCBhaWcueSApOwoJCXogPSBNYXRoLmFicyggYWlnLnogKTsKCgkJLy8gSWYgcG9ydHJhaXQgb3JpZW50YXRpb24gYW5kIGluIG9uZSBvZiB0aGUgZGFuZ2VyIHpvbmVzCgkJaWYgKCAhd2luZG93Lm9yaWVudGF0aW9uICYmICggeCA+IDcgfHwgKCAoIHogPiA2ICYmIHkgPCA4IHx8IHogPCA4ICYmIHkgPiA2ICkgJiYgeCA+IDUgKSApICkgewoJCQkJaWYgKCB6b29tLmVuYWJsZWQgKSB7CgkJCQkJem9vbS5kaXNhYmxlKCk7CgkJCQl9CgkJfQllbHNlIGlmICggIXpvb20uZW5hYmxlZCApIHsKCQkJCXpvb20uZW5hYmxlKCk7CgkJfQoJfQoKCSQubW9iaWxlLmRvY3VtZW50Lm9uKCAibW9iaWxlaW5pdCIsIGZ1bmN0aW9uKCkgewoJCWlmICggJC5tb2JpbGUuaW9zb3JpZW50YXRpb25maXhFbmFibGVkICkgewoJCQkkLm1vYmlsZS53aW5kb3cKCQkJCS5iaW5kKCAib3JpZW50YXRpb25jaGFuZ2UuaW9zb3JpZW50YXRpb25maXgiLCB6b29tLmVuYWJsZSApCgkJCQkuYmluZCggImRldmljZW1vdGlvbi5pb3NvcmllbnRhdGlvbmZpeCIsIGNoZWNrVGlsdCApOwoJCX0KCX0pOwoKfSggalF1ZXJ5LCB0aGlzICkpOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhcgkkaHRtbCA9ICQoICJodG1sIiApLAoJCSR3aW5kb3cgPSAkLm1vYmlsZS53aW5kb3c7CgoJLy9yZW1vdmUgaW5pdGlhbCBidWlsZCBjbGFzcyAob25seSBwcmVzZW50IG9uIGZpcnN0IHBhZ2VzaG93KQoJZnVuY3Rpb24gaGlkZVJlbmRlcmluZ0NsYXNzKCkgewoJCSRodG1sLnJlbW92ZUNsYXNzKCAidWktbW9iaWxlLXJlbmRlcmluZyIgKTsKCX0KCgkvLyB0cmlnZ2VyIG1vYmlsZWluaXQgZXZlbnQgLSB1c2VmdWwgaG9vayBmb3IgY29uZmlndXJpbmcgJC5tb2JpbGUgc2V0dGluZ3MgYmVmb3JlIHRoZXkncmUgdXNlZAoJJCggd2luZG93LmRvY3VtZW50ICkudHJpZ2dlciggIm1vYmlsZWluaXQiICk7CgoJLy8gc3VwcG9ydCBjb25kaXRpb25zCgkvLyBpZiBkZXZpY2Ugc3VwcG9ydCBjb25kaXRpb24ocykgYXJlbid0IG1ldCwgbGVhdmUgdGhpbmdzIGFzIHRoZXkgYXJlIC0+IGEgYmFzaWMsIHVzYWJsZSBleHBlcmllbmNlLAoJLy8gb3RoZXJ3aXNlLCBwcm9jZWVkIHdpdGggdGhlIGVuaGFuY2VtZW50cwoJaWYgKCAhJC5tb2JpbGUuZ3JhZGVBKCkgKSB7CgkJcmV0dXJuOwoJfQoKCS8vIG92ZXJyaWRlIGFqYXhFbmFibGVkIG9uIHBsYXRmb3JtcyB0aGF0IGhhdmUga25vd24gY29uZmxpY3RzIHdpdGggaGFzaCBoaXN0b3J5IHVwZGF0ZXMKCS8vIG9yIGdlbmVyYWxseSB3b3JrIGJldHRlciBicm93c2luZyBpbiByZWd1bGFyIGh0dHAgZm9yIGZ1bGwgcGFnZSByZWZyZXNoZXMgKEJCNSwgT3BlcmEgTWluaSkKCWlmICggJC5tb2JpbGUuYWpheEJsYWNrbGlzdCApIHsKCQkkLm1vYmlsZS5hamF4RW5hYmxlZCA9IGZhbHNlOwoJfQoKCS8vIEFkZCBtb2JpbGUsIGluaXRpYWwgbG9hZCAicmVuZGVyaW5nIiBjbGFzc2VzIHRvIGRvY0VsCgkkaHRtbC5hZGRDbGFzcyggInVpLW1vYmlsZSB1aS1tb2JpbGUtcmVuZGVyaW5nIiApOwoKCS8vIFRoaXMgaXMgYSBmYWxsYmFjay4gSWYgYW55dGhpbmcgZ29lcyB3cm9uZyAoSlMgZXJyb3JzLCBldGMpLCBvciBldmVudHMgZG9uJ3QgZmlyZSwKCS8vIHRoaXMgZW5zdXJlcyB0aGUgcmVuZGVyaW5nIGNsYXNzIGlzIHJlbW92ZWQgYWZ0ZXIgNSBzZWNvbmRzLCBzbyBjb250ZW50IGlzIHZpc2libGUgYW5kIGFjY2Vzc2libGUKCXNldFRpbWVvdXQoIGhpZGVSZW5kZXJpbmdDbGFzcywgNTAwMCApOwoKCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoJCS8vIGZpbmQgYW5kIGVuaGFuY2UgdGhlIHBhZ2VzIGluIHRoZSBkb20gYW5kIHRyYW5zaXRpb24gdG8gdGhlIGZpcnN0IHBhZ2UuCgkJaW5pdGlhbGl6ZVBhZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBmaW5kIHByZXNlbnQgcGFnZXMKCQkJdmFyIHBhdGggPSAkLm1vYmlsZS5wYXRoLAoJCQkJJHBhZ2VzID0gJCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICksCgkJCQloYXNoID0gcGF0aC5zdHJpcEhhc2goIHBhdGguc3RyaXBRdWVyeVBhcmFtcyhwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoKSApLAoJCQkJaGFzaFBhZ2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggaGFzaCApOwoKCQkJLy8gaWYgbm8gcGFnZXMgYXJlIGZvdW5kLCBjcmVhdGUgb25lIHdpdGggYm9keSdzIGlubmVyIGh0bWwKCQkJaWYgKCAhJHBhZ2VzLmxlbmd0aCApIHsKCQkJCSRwYWdlcyA9ICQoICJib2R5IiApLndyYXBJbm5lciggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0ncGFnZSc+PC9kaXY+IiApLmNoaWxkcmVuKCAwICk7CgkJCX0KCgkJCS8vIGFkZCBkaWFsb2dzLCBzZXQgZGF0YS11cmwgYXR0cnMKCQkJJHBhZ2VzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQkJLy8gdW5sZXNzIHRoZSBkYXRhIHVybCBpcyBhbHJlYWR5IHNldCBzZXQgaXQgdG8gdGhlIHBhdGhuYW1lCgkJCQlpZiAoICEkdGhpc1sgMCBdLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIgKSApIHsKCQkJCQkkdGhpcy5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgJHRoaXMuYXR0ciggImlkIiApIHx8IGxvY2F0aW9uLnBhdGhuYW1lICsgbG9jYXRpb24uc2VhcmNoICk7CgkJCQl9CgkJCX0pOwoKCQkJLy8gZGVmaW5lIGZpcnN0IHBhZ2UgaW4gZG9tIGNhc2Ugb25lIGJhY2tzIG91dCB0byB0aGUgZGlyZWN0b3J5IHJvb3QgKG5vdCBhbHdheXMgdGhlIGZpcnN0IHBhZ2UgdmlzaXRlZCwgYnV0IGRlZmluZWQgYXMgZmFsbGJhY2spCgkJCSQubW9iaWxlLmZpcnN0UGFnZSA9ICRwYWdlcy5maXJzdCgpOwoKCQkJLy8gZGVmaW5lIHBhZ2UgY29udGFpbmVyCgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIgPSAkLm1vYmlsZS5maXJzdFBhZ2UKCQkJCS5wYXJlbnQoKQoJCQkJLmFkZENsYXNzKCAidWktbW9iaWxlLXZpZXdwb3J0IiApCgkJCQkucGFnZWNvbnRhaW5lcigpOwoKCQkJLy8gaW5pdGlhbGl6ZSBuYXZpZ2F0aW9uIGV2ZW50cyBub3csIGFmdGVyIG1vYmlsZWluaXQgaGFzIG9jY3VycmVkIGFuZCB0aGUgcGFnZSBjb250YWluZXIKCQkJLy8gaGFzIGJlZW4gY3JlYXRlZCBidXQgYmVmb3JlIHRoZSByZXN0IG9mIHRoZSBsaWJyYXJ5IGlzIGFsZXJ0ZWQgdG8gdGhhdCBmYWN0CgkJCSQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQucmVzb2x2ZSgpOwoKCQkJLy8gYWxlcnQgbGlzdGVuZXJzIHRoYXQgdGhlIHBhZ2Vjb250YWluZXIgaGFzIGJlZW4gZGV0ZXJtaW5lZCBmb3IgYmluZGluZwoJCQkvLyB0byBldmVudHMgdHJpZ2dlcmVkIG9uIGl0CgkJCSR3aW5kb3cudHJpZ2dlciggInBhZ2Vjb250YWluZXJjcmVhdGUiICk7CgoJCQkvLyBjdWUgcGFnZSBsb2FkaW5nIG1lc3NhZ2UKCQkJJC5tb2JpbGUubG9hZGluZyggInNob3ciICk7CgoJCQkvL3JlbW92ZSBpbml0aWFsIGJ1aWxkIGNsYXNzIChvbmx5IHByZXNlbnQgb24gZmlyc3QgcGFnZXNob3cpCgkJCWhpZGVSZW5kZXJpbmdDbGFzcygpOwoKCQkJLy8gaWYgaGFzaGNoYW5nZSBsaXN0ZW5pbmcgaXMgZGlzYWJsZWQsIHRoZXJlJ3Mgbm8gaGFzaCBkZWVwbGluaywKCQkJLy8gdGhlIGhhc2ggaXMgbm90IHZhbGlkIChjb250YWlucyBtb3JlIHRoYW4gb25lICMgb3IgZG9lcyBub3Qgc3RhcnQgd2l0aCAjKQoJCQkvLyBvciB0aGVyZSBpcyBubyBwYWdlIHdpdGggdGhhdCBoYXNoLCBjaGFuZ2UgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIERPTQoJCQkvLyBSZW1lbWJlciwgaG93ZXZlciwgdGhhdCB0aGUgaGFzaCBjYW4gYWxzbyBiZSBhIHBhdGghCgkJCWlmICggISAoICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICYmCgkJCQkkLm1vYmlsZS5wYXRoLmlzSGFzaFZhbGlkKCBsb2NhdGlvbi5oYXNoICkgJiYKCQkJCSggJCggaGFzaFBhZ2UgKS5pcyggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKSB8fAoJCQkJCSQubW9iaWxlLnBhdGguaXNQYXRoKCBoYXNoICkgfHwKCQkJCQloYXNoID09PSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5ICkgKSApIHsKCgkJCQkvLyBTdG9yZSB0aGUgaW5pdGlhbCBkZXN0aW5hdGlvbgoJCQkJaWYgKCAkLm1vYmlsZS5wYXRoLmlzSGFzaFZhbGlkKCBsb2NhdGlvbi5oYXNoICkgKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5pbml0aWFsRHN0ID0gaGFzaC5yZXBsYWNlKCAiIyIsICIiICk7CgkJCQl9CgoJCQkJLy8gbWFrZSBzdXJlIHRvIHNldCBpbml0aWFsIHBvcHN0YXRlIHN0YXRlIGlmIGl0IGV4aXN0cwoJCQkJLy8gc28gdGhhdCBuYXZpZ2F0aW9uIGJhY2sgdG8gdGhlIGluaXRpYWwgcGFnZSB3b3JrcyBwcm9wZXJseQoJCQkJaWYgKCAkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUubmF2aWdhdG9yLnNxdWFzaCggcGF0aC5wYXJzZUxvY2F0aW9uKCkuaHJlZiApOwoJCQkJfQoKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoICQubW9iaWxlLmZpcnN0UGFnZSwgewoJCQkJCXRyYW5zaXRpb246ICJub25lIiwKCQkJCQlyZXZlcnNlOiB0cnVlLAoJCQkJCWNoYW5nZUhhc2g6IGZhbHNlLAoJCQkJCWZyb21IYXNoQ2hhbmdlOiB0cnVlCgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCS8vIHRyaWdnZXIgaGFzaGNoYW5nZSBvciBuYXZpZ2F0ZSB0byBzcXVhc2ggYW5kIHJlY29yZCB0aGUgY29ycmVjdAoJCQkJLy8gaGlzdG9yeSBlbnRyeSBmb3IgYW4gaW5pdGlhbCBoYXNoIHBhdGgKCQkJCWlmICggISQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCQkkd2luZG93LnRyaWdnZXIoICJoYXNoY2hhbmdlIiwgW3RydWVdICk7CgkJCQl9IGVsc2UgewoJCQkJCS8vIFRPRE8gZmlndXJlIG91dCBob3cgdG8gc2ltcGxpZnkgdGhpcyBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbml0aWFsIGhpc3RvcnkgZW50cnkKCQkJCQkvLyBhdCB0aGUgYm90dG9tIGpzL25hdmlnYXRlL25hdmlnYXRlLmpzCgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5zdGFjayA9IFtdOwoJCQkJCSQubW9iaWxlLm5hdmlnYXRlKCAkLm1vYmlsZS5wYXRoLmlzUGF0aCggbG9jYXRpb24uaGFzaCApID8gbG9jYXRpb24uaGFzaCA6IGxvY2F0aW9uLmhyZWYgKTsKCQkJCX0KCQkJfQoJCX0KCX0pOwoKCSQoZnVuY3Rpb24oKSB7CgkJLy9SdW4gaW5saW5lU1ZHIHN1cHBvcnQgdGVzdAoJCSQuc3VwcG9ydC5pbmxpbmVTVkcoKTsKCgkJLy8gY2hlY2sgd2hpY2ggc2Nyb2xsVG9wIHZhbHVlIHNob3VsZCBiZSB1c2VkIGJ5IHNjcm9sbGluZyB0byAxIGltbWVkaWF0ZWx5IGF0IGRvbXJlYWR5CgkJLy8gdGhlbiBjaGVjayB3aGF0IHRoZSBzY3JvbGwgdG9wIGlzLiBBbmRyb2lkIHdpbGwgcmVwb3J0IDAuLi4gb3RoZXJzIDEKCQkvLyBub3RlIHRoYXQgdGhpcyBpbml0aWFsIHNjcm9sbCB3b24ndCBoaWRlIHRoZSBhZGRyZXNzIGJhci4gSXQncyBqdXN0IGZvciB0aGUgY2hlY2suCgoJCS8vIGhpZGUgaU9TIGJyb3dzZXIgY2hyb21lIG9uIGxvYWQgaWYgaGlkZVVybEJhciBpcyB0cnVlIHRoaXMgaXMgdG8gdHJ5IGFuZCBkbyBpdCBhcyBzb29uIGFzIHBvc3NpYmxlCgkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyICkgewoJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIDEgKTsKCQl9CgoJCS8vIGlmIGRlZmF1bHRIb21lU2Nyb2xsIGhhc24ndCBiZWVuIHNldCB5ZXQsIHNlZSBpZiBzY3JvbGxUb3AgaXMgMQoJCS8vIGl0IHNob3VsZCBiZSAxIGluIG1vc3QgYnJvd3NlcnMsIGJ1dCBhbmRyb2lkIHRyZWF0cyAxIGFzIDAgKGZvciBoaWRpbmcgYWRkciBiYXIpCgkJLy8gc28gaWYgaXQncyAxLCB1c2UgMCBmcm9tIG5vdyBvbgoJCSQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsID0gKCAhJC5zdXBwb3J0LnNjcm9sbFRvcCB8fCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCkgPT09IDEgKSA/IDAgOiAxOwoKCQkvL2RvbS1yZWFkeSBpbml0cwoJCWlmICggJC5tb2JpbGUuYXV0b0luaXRpYWxpemVQYWdlICkgewoJCQkkLm1vYmlsZS5pbml0aWFsaXplUGFnZSgpOwoJCX0KCgkJLy8gd2luZG93IGxvYWQgZXZlbnQKCQkvLyBoaWRlIGlPUyBicm93c2VyIGNocm9tZSBvbiBsb2FkIGlmIGhpZGVVcmxCYXIgaXMgdHJ1ZSB0aGlzIGlzIGFzIGZhbGwgYmFjayBpbmNhc2Ugd2Ugd2VyZSB0b28gZWFybHkgYmVmb3JlCgkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyICkgewoJCQkkd2luZG93LmxvYWQoICQubW9iaWxlLnNpbGVudFNjcm9sbCApOwoJCX0KCgkJaWYgKCAhJC5zdXBwb3J0LmNzc1BvaW50ZXJFdmVudHMgKSB7CgkJCS8vIElFIGFuZCBPcGVyYSBkb24ndCBzdXBwb3J0IENTUyBwb2ludGVyLWV2ZW50czogbm9uZSB0aGF0IHdlIHVzZSB0byBkaXNhYmxlIGxpbmstYmFzZWQgYnV0dG9ucwoJCQkvLyBieSBhZGRpbmcgdGhlICd1aS1kaXNhYmxlZCcgY2xhc3MgdG8gdGhlbS4gVXNpbmcgYSBKYXZhU2NyaXB0IHdvcmthcm91bmQgZm9yIHRob3NlIGJyb3dzZXIuCgkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzU1OAoKCQkJLy8gREVQUkVDQVRFRCBhcyBvZiAxLjQuMCAtIHJlbW92ZSB1aS1kaXNhYmxlZCBhZnRlciAxLjQuMCByZWxlYXNlCgkJCS8vIG9ubHkgdWktc3RhdGUtZGlzYWJsZWQgc2hvdWxkIGJlIHByZXNlbnQgdGhlcmVhZnRlcgoJCQkkLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggIi51aS1zdGF0ZS1kaXNhYmxlZCwudWktZGlzYWJsZWQiLCAidmNsaWNrIiwKCQkJCWZ1bmN0aW9uKCBlICkgewoJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQllLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJfQoJCQkpOwoJCX0KCX0pOwp9KCBqUXVlcnksIHRoaXMgKSk7CgoKfSkpOwo=",
                "body": "LyohCiogalF1ZXJ5IE1vYmlsZSAxLjQuMAoqIEdpdCBIRUFEIGhhc2g6IGYwOWFhZTBlMDM1ZDY4MDVlNDYxYTdiZTI0NmQwNGEwZGJjOThmNjkgPD4gRGF0ZTogVGh1IERlYyAxOSAyMDEzIDE3OjM0OjIyIFVUQwoqIGh0dHA6Ly9qcXVlcnltb2JpbGUuY29tCioKKiBDb3B5cmlnaHQgMjAxMCwgMjAxMyBqUXVlcnkgRm91bmRhdGlvbiwgSW5jLiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgoqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKKgoqLwoKLyoKKiBSaWdodC1Uby1MZWZ0IGNoYW5nZXMgbWFkZSBieSBNb3V0YXogU2hhbXMgdW5kZXIgdGhlIHNhbWUgbGljZW5zZShzKSBtZW50aW9uZWQgCiogaHR0cDovL3d3dy5pbnRsYXFhLmNvbS9qcXVlcnktbW9iaWxlLXJ0bCAKKiAKKi8KCihmdW5jdGlvbiAoIHJvb3QsIGRvYywgZmFjdG9yeSApIHsKCWlmICggdHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kICkgewoJCS8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS4KCQlkZWZpbmUoIFsgImpxdWVyeSIgXSwgZnVuY3Rpb24gKCAkICkgewoJCQlmYWN0b3J5KCAkLCByb290LCBkb2MgKTsKCQkJcmV0dXJuICQubW9iaWxlOwoJCX0pOwoJfSBlbHNlIHsKCQkvLyBCcm93c2VyIGdsb2JhbHMKCQlmYWN0b3J5KCByb290LmpRdWVyeSwgcm9vdCwgZG9jICk7Cgl9Cn0oIHRoaXMsIGRvY3VtZW50LCBmdW5jdGlvbiAoIGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkICkgewooZnVuY3Rpb24oICQgKSB7CgkkLm1vYmlsZSA9IHt9Owp9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJJC5leHRlbmQoICQubW9iaWxlLCB7CgoJCS8vIFZlcnNpb24gb2YgdGhlIGpRdWVyeSBNb2JpbGUgRnJhbWV3b3JrCgkJdmVyc2lvbjogIjEuNC4wIiwKCgkJLy8gRGVwcmVjYXRlZCBhbmQgbm8gbG9uZ2VyIHVzZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQkvLyBEZWZpbmUgdGhlIHVybCBwYXJhbWV0ZXIgdXNlZCBmb3IgcmVmZXJlbmNpbmcgd2lkZ2V0LWdlbmVyYXRlZCBzdWItcGFnZXMuCgkJLy8gVHJhbnNsYXRlcyB0byBleGFtcGxlLmh0bWwmdWktcGFnZT1zdWJwYWdlSWRlbnRpZmllcgoJCS8vIGhhc2ggc2VnbWVudCBiZWZvcmUgJnVpLXBhZ2U9IGlzIHVzZWQgdG8gbWFrZSBBamF4IHJlcXVlc3QKCQlzdWJQYWdlVXJsS2V5OiAidWktcGFnZSIsCgoJCWhpZGVVcmxCYXI6IHRydWUsCgoJCS8vIEtlZXBuYXRpdmUgU2VsZWN0b3IKCQlrZWVwTmF0aXZlOiAiOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJLy8gQ2xhc3MgYXNzaWduZWQgdG8gcGFnZSBjdXJyZW50bHkgaW4gdmlldywgYW5kIGR1cmluZyB0cmFuc2l0aW9ucwoJCWFjdGl2ZVBhZ2VDbGFzczogInVpLXBhZ2UtYWN0aXZlIiwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCS8vIENsYXNzIHVzZWQgZm9yICJhY3RpdmUiIGJ1dHRvbiBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJYWN0aXZlQnRuQ2xhc3M6ICJ1aS1idG4tYWN0aXZlIiwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCS8vIENsYXNzIHVzZWQgZm9yICJmb2N1cyIgZm9ybSBlbGVtZW50IHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlmb2N1c0NsYXNzOiAidWktZm9jdXMiLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGhhbmRsZSBjbGlja3MgYW5kIGZvcm0gc3VibWlzc2lvbnMgdGhyb3VnaCBBamF4LCB3aGVuIHNhbWUtZG9tYWluCgkJYWpheEVuYWJsZWQ6IHRydWUsCgoJCS8vIEF1dG9tYXRpY2FsbHkgbG9hZCBhbmQgc2hvdyBwYWdlcyBiYXNlZCBvbiBsb2NhdGlvbi5oYXNoCgkJaGFzaExpc3RlbmluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIGRpc2FibGUgdG8gcHJldmVudCBqcXVlcnkgZnJvbSBib3RoZXJpbmcgd2l0aCBsaW5rcwoJCWxpbmtCaW5kaW5nRW5hYmxlZDogdHJ1ZSwKCgkJLy8gU2V0IGRlZmF1bHQgcGFnZSB0cmFuc2l0aW9uIC0gJ25vbmUnIGZvciBubyB0cmFuc2l0aW9ucwoJCWRlZmF1bHRQYWdlVHJhbnNpdGlvbjogImZhZGUiLAoKCQkvLyBTZXQgbWF4aW11bSB3aW5kb3cgd2lkdGggZm9yIHRyYW5zaXRpb25zIHRvIGFwcGx5IC0gJ2ZhbHNlJyBmb3Igbm8gbGltaXQKCQltYXhUcmFuc2l0aW9uV2lkdGg6IGZhbHNlLAoKCQkvLyBNaW5pbXVtIHNjcm9sbCBkaXN0YW5jZSB0aGF0IHdpbGwgYmUgcmVtZW1iZXJlZCB3aGVuIHJldHVybmluZyB0byBhIHBhZ2UKCQkvLyBEZXByZWNhdGVkIHJlbW92ZSBpbiAxLjUKCQltaW5TY3JvbGxCYWNrOiAwLAoKCQkvLyBTZXQgZGVmYXVsdCBkaWFsb2cgdHJhbnNpdGlvbiAtICdub25lJyBmb3Igbm8gdHJhbnNpdGlvbnMKCQlkZWZhdWx0RGlhbG9nVHJhbnNpdGlvbjogInBvcCIsCgoJCS8vIEVycm9yIHJlc3BvbnNlIG1lc3NhZ2UgLSBhcHBlYXJzIHdoZW4gYW4gQWpheCBwYWdlIHJlcXVlc3QgZmFpbHMKCQlwYWdlTG9hZEVycm9yTWVzc2FnZTogIkVycm9yIExvYWRpbmcgUGFnZSIsCgoJCS8vIEZvciBlcnJvciBtZXNzYWdlcywgd2hpY2ggdGhlbWUgZG9lcyB0aGUgYm94IHVzZXM/CgkJcGFnZUxvYWRFcnJvck1lc3NhZ2VUaGVtZTogImEiLAoKCQkvLyByZXBsYWNlIGNhbGxzIHRvIHdpbmRvdy5oaXN0b3J5LmJhY2sgd2l0aCBwaG9uZWdhcHMgbmF2aWdhdGlvbiBoZWxwZXIKCQkvLyB3aGVyZSBpdCBpcyBwcm92aWRlZCBvbiB0aGUgd2luZG93IG9iamVjdAoJCXBob25lZ2FwTmF2aWdhdGlvbkVuYWJsZWQ6IGZhbHNlLAoKCQkvL2F1dG9tYXRpY2FsbHkgaW5pdGlhbGl6ZSB0aGUgRE9NIHdoZW4gaXQncyByZWFkeQoJCWF1dG9Jbml0aWFsaXplUGFnZTogdHJ1ZSwKCgkJcHVzaFN0YXRlRW5hYmxlZDogdHJ1ZSwKCgkJLy8gYWxsb3dzIHVzZXJzIHRvIG9wdCBpbiB0byBpZ25vcmluZyBjb250ZW50IGJ5IG1hcmtpbmcgYSBwYXJlbnQgZWxlbWVudCBhcwoJCS8vIGRhdGEtaWdub3JlZAoJCWlnbm9yZUNvbnRlbnRFbmFibGVkOiBmYWxzZSwKCgkJYnV0dG9uTWFya3VwOiB7CgkJCWhvdmVyRGVsYXk6IDIwMAoJCX0sCgoJCS8vIGRpc2FibGUgdGhlIGFsdGVyYXRpb24gb2YgdGhlIGR5bmFtaWMgYmFzZSB0YWcgb3IgbGlua3MgaW4gdGhlIGNhc2UKCQkvLyB0aGF0IGEgZHluYW1pYyBiYXNlIHRhZyBpc24ndCBzdXBwb3J0ZWQKCQlkeW5hbWljQmFzZUVuYWJsZWQ6IHRydWUsCgoJCS8vIGRlZmF1bHQgdGhlIHByb3BlcnR5IHRvIHJlbW92ZSBkZXBlbmRlbmN5IG9uIGFzc2lnbm1lbnQgaW4gaW5pdCBtb2R1bGUKCQlwYWdlQ29udGFpbmVyOiAkKCksCgoJCS8vZW5hYmxlIGNyb3NzLWRvbWFpbiBwYWdlIHN1cHBvcnQKCQlhbGxvd0Nyb3NzRG9tYWluUGFnZXM6IGZhbHNlLAoKCQlkaWFsb2dIYXNoS2V5OiAiJnVpLXN0YXRlPWRpYWxvZyIKCX0pOwp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyIG5zTm9ybWFsaXplRGljdCA9IHt9LAoJCW9sZEZpbmQgPSAkLmZpbmQsCgkJcmJyYWNlID0gLyg/Olx7W1xzXFNdKlx9fFxbW1xzXFNdKlxdKSQvLAoJCWpxbURhdGFSRSA9IC86anFtRGF0YVwoKFteKV0qKVwpL2c7CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgoJCS8vIE5hbWVzcGFjZSB1c2VkIGZyYW1ld29yay13aWRlIGZvciBkYXRhLWF0dHJzLiBEZWZhdWx0IGlzIG5vIG5hbWVzcGFjZQoKCQluczogIiIsCgoJCS8vIFJldHJpZXZlIGFuIGF0dHJpYnV0ZSBmcm9tIGFuIGVsZW1lbnQgYW5kIHBlcmZvcm0gc29tZSBtYXNzYWdpbmcgb2YgdGhlIHZhbHVlCgoJCWdldEF0dHJpYnV0ZTogZnVuY3Rpb24oIGVsZW1lbnQsIGtleSApIHsKCQkJdmFyIGRhdGE7CgoJCQllbGVtZW50ID0gZWxlbWVudC5qcXVlcnkgPyBlbGVtZW50WzBdIDogZWxlbWVudDsKCgkJCWlmICggZWxlbWVudCAmJiBlbGVtZW50LmdldEF0dHJpYnV0ZSApIHsKCQkJCWRhdGEgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsga2V5ICk7CgkJCX0KCgkJCS8vIENvcGllZCBmcm9tIGNvcmUncyBzcmMvZGF0YS5qczpkYXRhQXR0cigpCgkJCS8vIENvbnZlcnQgZnJvbSBhIHN0cmluZyB0byBhIHByb3BlciBkYXRhIHR5cGUKCQkJdHJ5IHsKCQkJCWRhdGEgPSBkYXRhID09PSAidHJ1ZSIgPyB0cnVlIDoKCQkJCQlkYXRhID09PSAiZmFsc2UiID8gZmFsc2UgOgoJCQkJCWRhdGEgPT09ICJudWxsIiA/IG51bGwgOgoJCQkJCS8vIE9ubHkgY29udmVydCB0byBhIG51bWJlciBpZiBpdCBkb2Vzbid0IGNoYW5nZSB0aGUgc3RyaW5nCgkJCQkJK2RhdGEgKyAiIiA9PT0gZGF0YSA/ICtkYXRhIDoKCQkJCQlyYnJhY2UudGVzdCggZGF0YSApID8gSlNPTi5wYXJzZSggZGF0YSApIDoKCQkJCQlkYXRhOwoJCQl9IGNhdGNoKCBlcnIgKSB7fQoKCQkJcmV0dXJuIGRhdGE7CgkJfSwKCgkJLy8gRXhwb3NlIG91ciBjYWNoZSBmb3IgdGVzdGluZyBwdXJwb3Nlcy4KCQluc05vcm1hbGl6ZURpY3Q6IG5zTm9ybWFsaXplRGljdCwKCgkJLy8gVGFrZSBhIGRhdGEgYXR0cmlidXRlIHByb3BlcnR5LCBwcmVwZW5kIHRoZSBuYW1lc3BhY2UKCQkvLyBhbmQgdGhlbiBjYW1lbCBjYXNlIHRoZSBhdHRyaWJ1dGUgc3RyaW5nLiBBZGQgdGhlIHJlc3VsdAoJCS8vIHRvIG91ciBuc05vcm1hbGl6ZURpY3Qgc28gd2UgZG9uJ3QgaGF2ZSB0byBkbyB0aGlzIGFnYWluLgoJCW5zTm9ybWFsaXplOiBmdW5jdGlvbiggcHJvcCApIHsKCQkJcmV0dXJuIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdIHx8CgkJCQkoIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdID0gJC5jYW1lbENhc2UoICQubW9iaWxlLm5zICsgcHJvcCApICk7CgkJfSwKCgkJLy8gRmluZCB0aGUgY2xvc2VzdCBqYXZhc2NyaXB0IHBhZ2UgZWxlbWVudCB0byBnYXRoZXIgc2V0dGluZ3MgZGF0YSBqc3BlcmYgdGVzdAoJCS8vIGh0dHA6Ly9qc3BlcmYuY29tL3NpbmdsZS1jb21wbGV4LXNlbGVjdG9yLXZzLW1hbnktY29tcGxleC1zZWxlY3RvcnMvZWRpdAoJCS8vIHBvc3NpYmx5IG5haXZlLCBidXQgaXQgc2hvd3MgdGhhdCB0aGUgcGFyc2luZyBvdmVyaGVhZCBmb3IgKmp1c3QqIHRoZSBwYWdlIHNlbGVjdG9yIHZzCgkJLy8gdGhlIHBhZ2UgYW5kIGRpYWxvZyBzZWxlY3RvciBpcyBuZWdsaWdhYmxlLiBUaGlzIGNvdWxkIHByb2JhYmx5IGJlIHNwZWVkIHVwIGJ5CgkJLy8gZG9pbmcgYSBzaW1pbGFyIHBhcmVudCBub2RlIHRyYXZlcnNhbCB0byB0aGUgb25lIGZvdW5kIGluIHRoZSBpbmhlcml0ZWQgdGhlbWUgY29kZSBhYm92ZQoJCWNsb3Nlc3RQYWdlRGF0YTogZnVuY3Rpb24oICR0YXJnZXQgKSB7CgkJCXJldHVybiAkdGFyZ2V0CgkJCQkuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkKCQkJCS5kYXRhKCAibW9iaWxlLXBhZ2UiICk7CgkJfQoKCX0pOwoKCS8vIE1vYmlsZSB2ZXJzaW9uIG9mIGRhdGEgYW5kIHJlbW92ZURhdGEgYW5kIGhhc0RhdGEgbWV0aG9kcwoJLy8gZW5zdXJlcyBhbGwgZGF0YSBpcyBzZXQgYW5kIHJldHJpZXZlZCB1c2luZyBqUXVlcnkgTW9iaWxlJ3MgZGF0YSBuYW1lc3BhY2UKCSQuZm4uanFtRGF0YSA9IGZ1bmN0aW9uKCBwcm9wLCB2YWx1ZSApIHsKCQl2YXIgcmVzdWx0OwoJCWlmICggdHlwZW9mIHByb3AgIT09ICJ1bmRlZmluZWQiICkgewoJCQlpZiAoIHByb3AgKSB7CgkJCQlwcm9wID0gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKTsKCQkJfQoKCQkJLy8gdW5kZWZpbmVkIGlzIHBlcm1pdHRlZCBhcyBhbiBleHBsaWNpdCBpbnB1dCBmb3IgdGhlIHNlY29uZCBwYXJhbQoJCQkvLyBpbiB0aGlzIGNhc2UgaXQgcmV0dXJucyB0aGUgdmFsdWUgYW5kIGRvZXMgbm90IHNldCBpdCB0byB1bmRlZmluZWQKCQkJaWYgKCBhcmd1bWVudHMubGVuZ3RoIDwgMiB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJcmVzdWx0ID0gdGhpcy5kYXRhKCBwcm9wICk7CgkJCX0gZWxzZSB7CgkJCQlyZXN1bHQgPSB0aGlzLmRhdGEoIHByb3AsIHZhbHVlICk7CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07CgoJJC5qcW1EYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCXJlc3VsdCA9ICQuZGF0YSggZWxlbSwgcHJvcCA/ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgOiBwcm9wLCB2YWx1ZSApOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmZuLmpxbVJlbW92ZURhdGEgPSBmdW5jdGlvbiggcHJvcCApIHsKCQlyZXR1cm4gdGhpcy5yZW1vdmVEYXRhKCAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApICk7Cgl9OwoKCSQuanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wICkgewoJCXJldHVybiAkLnJlbW92ZURhdGEoIGVsZW0sICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5maW5kID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0LCByZXQsIGV4dHJhICkgewoJCWlmICggc2VsZWN0b3IuaW5kZXhPZiggIjpqcW1EYXRhIiApID4gLTEgKSB7CgkJCXNlbGVjdG9yID0gc2VsZWN0b3IucmVwbGFjZSgganFtRGF0YVJFLCAiW2RhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICIkMV0iICk7CgkJfQoKCQlyZXR1cm4gb2xkRmluZC5jYWxsKCB0aGlzLCBzZWxlY3RvciwgY29udGV4dCwgcmV0LCBleHRyYSApOwoJfTsKCgkkLmV4dGVuZCggJC5maW5kLCBvbGRGaW5kICk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKiEKICogalF1ZXJ5IFVJIENvcmUgYzBhYjcxMDU2YjkzNjYyN2U4YTc4MjFmMDNjMDQ0YWVjNjI4MGE0MAogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2NhdGVnb3J5L3VpLWNvcmUvCiAqLwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciB1dWlkID0gMCwKCXJ1bmlxdWVJZCA9IC9edWktaWQtXGQrJC87CgovLyAkLnVpIG1pZ2h0IGV4aXN0IGZyb20gY29tcG9uZW50cyB3aXRoIG5vIGRlcGVuZGVuY2llcywgZS5nLiwgJC51aS5wb3NpdGlvbgokLnVpID0gJC51aSB8fCB7fTsKCiQuZXh0ZW5kKCAkLnVpLCB7Cgl2ZXJzaW9uOiAiYzBhYjcxMDU2YjkzNjYyN2U4YTc4MjFmMDNjMDQ0YWVjNjI4MGE0MCIsCgoJa2V5Q29kZTogewoJCUJBQ0tTUEFDRTogOCwKCQlDT01NQTogMTg4LAoJCURFTEVURTogNDYsCgkJRE9XTjogNDAsCgkJRU5EOiAzNSwKCQlFTlRFUjogMTMsCgkJRVNDQVBFOiAyNywKCQlIT01FOiAzNiwKCQlMRUZUOiAzNywKCQlQQUdFX0RPV046IDM0LAoJCVBBR0VfVVA6IDMzLAoJCVBFUklPRDogMTkwLAoJCVJJR0hUOiAzOSwKCQlTUEFDRTogMzIsCgkJVEFCOiA5LAoJCVVQOiAzOAoJfQp9KTsKCi8vIHBsdWdpbnMKJC5mbi5leHRlbmQoewoJZm9jdXM6IChmdW5jdGlvbiggb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGRlbGF5LCBmbiApIHsKCQkJcmV0dXJuIHR5cGVvZiBkZWxheSA9PT0gIm51bWJlciIgPwoJCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCXZhciBlbGVtID0gdGhpczsKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQkkKCBlbGVtICkuZm9jdXMoKTsKCQkJCQkJaWYgKCBmbiApIHsKCQkJCQkJCWZuLmNhbGwoIGVsZW0gKTsKCQkJCQkJfQoJCQkJCX0sIGRlbGF5ICk7CgkJCQl9KSA6CgkJCQlvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl9OwoJfSkoICQuZm4uZm9jdXMgKSwKCglzY3JvbGxQYXJlbnQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzY3JvbGxQYXJlbnQ7CgkJaWYgKCgkLnVpLmllICYmICgvKHN0YXRpY3xyZWxhdGl2ZSkvKS50ZXN0KHRoaXMuY3NzKCJwb3NpdGlvbiIpKSkgfHwgKC9hYnNvbHV0ZS8pLnRlc3QodGhpcy5jc3MoInBvc2l0aW9uIikpKSB7CgkJCXNjcm9sbFBhcmVudCA9IHRoaXMucGFyZW50cygpLmZpbHRlcihmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoLyhyZWxhdGl2ZXxhYnNvbHV0ZXxmaXhlZCkvKS50ZXN0KCQuY3NzKHRoaXMsInBvc2l0aW9uIikpICYmICgvKGF1dG98c2Nyb2xsKS8pLnRlc3QoJC5jc3ModGhpcywib3ZlcmZsb3ciKSskLmNzcyh0aGlzLCJvdmVyZmxvdy15IikrJC5jc3ModGhpcywib3ZlcmZsb3cteCIpKTsKCQkJfSkuZXEoMCk7CgkJfSBlbHNlIHsKCQkJc2Nyb2xsUGFyZW50ID0gdGhpcy5wYXJlbnRzKCkuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICgvKGF1dG98c2Nyb2xsKS8pLnRlc3QoJC5jc3ModGhpcywib3ZlcmZsb3ciKSskLmNzcyh0aGlzLCJvdmVyZmxvdy15IikrJC5jc3ModGhpcywib3ZlcmZsb3cteCIpKTsKCQkJfSkuZXEoMCk7CgkJfQoKCQlyZXR1cm4gKCAvZml4ZWQvICkudGVzdCggdGhpcy5jc3MoICJwb3NpdGlvbiIpICkgfHwgIXNjcm9sbFBhcmVudC5sZW5ndGggPyAkKCB0aGlzWyAwIF0ub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudCApIDogc2Nyb2xsUGFyZW50OwoJfSwKCgl1bmlxdWVJZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAhdGhpcy5pZCApIHsKCQkJCXRoaXMuaWQgPSAidWktaWQtIiArICgrK3V1aWQpOwoJCQl9CgkJfSk7Cgl9LAoKCXJlbW92ZVVuaXF1ZUlkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoIHJ1bmlxdWVJZC50ZXN0KCB0aGlzLmlkICkgKSB7CgkJCQkkKCB0aGlzICkucmVtb3ZlQXR0ciggImlkIiApOwoJCQl9CgkJfSk7Cgl9Cn0pOwoKLy8gc2VsZWN0b3JzCmZ1bmN0aW9uIGZvY3VzYWJsZSggZWxlbWVudCwgaXNUYWJJbmRleE5vdE5hTiApIHsKCXZhciBtYXAsIG1hcE5hbWUsIGltZywKCQlub2RlTmFtZSA9IGVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCWlmICggImFyZWEiID09PSBub2RlTmFtZSApIHsKCQltYXAgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJbWFwTmFtZSA9IG1hcC5uYW1lOwoJCWlmICggIWVsZW1lbnQuaHJlZiB8fCAhbWFwTmFtZSB8fCBtYXAubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gIm1hcCIgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaW1nID0gJCggImltZ1t1c2VtYXA9IyIgKyBtYXBOYW1lICsgIl0iIClbMF07CgkJcmV0dXJuICEhaW1nICYmIHZpc2libGUoIGltZyApOwoJfQoJcmV0dXJuICggL2lucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b258b2JqZWN0Ly50ZXN0KCBub2RlTmFtZSApID8KCQkhZWxlbWVudC5kaXNhYmxlZCA6CgkJImEiID09PSBub2RlTmFtZSA/CgkJCWVsZW1lbnQuaHJlZiB8fCBpc1RhYkluZGV4Tm90TmFOIDoKCQkJaXNUYWJJbmRleE5vdE5hTikgJiYKCQkvLyB0aGUgZWxlbWVudCBhbmQgYWxsIG9mIGl0cyBhbmNlc3RvcnMgbXVzdCBiZSB2aXNpYmxlCgkJdmlzaWJsZSggZWxlbWVudCApOwp9CgpmdW5jdGlvbiB2aXNpYmxlKCBlbGVtZW50ICkgewoJcmV0dXJuICQuZXhwci5maWx0ZXJzLnZpc2libGUoIGVsZW1lbnQgKSAmJgoJCSEkKCBlbGVtZW50ICkucGFyZW50cygpLmFkZEJhY2soKS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLmNzcyggdGhpcywgInZpc2liaWxpdHkiICkgPT09ICJoaWRkZW4iOwoJCX0pLmxlbmd0aDsKfQoKJC5leHRlbmQoICQuZXhwclsgIjoiIF0sIHsKCWRhdGE6ICQuZXhwci5jcmVhdGVQc2V1ZG8gPwoJCSQuZXhwci5jcmVhdGVQc2V1ZG8oZnVuY3Rpb24oIGRhdGFOYW1lICkgewoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGRhdGFOYW1lICk7CgkJCX07CgkJfSkgOgoJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJZnVuY3Rpb24oIGVsZW0sIGksIG1hdGNoICkgewoJCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIG1hdGNoWyAzIF0gKTsKCQl9LAoKCWZvY3VzYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJcmV0dXJuIGZvY3VzYWJsZSggZWxlbWVudCwgIWlzTmFOKCAkLmF0dHIoIGVsZW1lbnQsICJ0YWJpbmRleCIgKSApICk7Cgl9LAoKCXRhYmJhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl2YXIgdGFiSW5kZXggPSAkLmF0dHIoIGVsZW1lbnQsICJ0YWJpbmRleCIgKSwKCQkJaXNUYWJJbmRleE5hTiA9IGlzTmFOKCB0YWJJbmRleCApOwoJCXJldHVybiAoIGlzVGFiSW5kZXhOYU4gfHwgdGFiSW5kZXggPj0gMCApICYmIGZvY3VzYWJsZSggZWxlbWVudCwgIWlzVGFiSW5kZXhOYU4gKTsKCX0KfSk7CgovLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAppZiAoICEkKCAiPGE+IiApLm91dGVyV2lkdGgoIDEgKS5qcXVlcnkgKSB7CgkkLmVhY2goIFsgIldpZHRoIiwgIkhlaWdodCIgXSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgkJdmFyIHNpZGUgPSBuYW1lID09PSAiV2lkdGgiID8gWyAiTGVmdCIsICJSaWdodCIgXSA6IFsgIlRvcCIsICJCb3R0b20iIF0sCgkJCXR5cGUgPSBuYW1lLnRvTG93ZXJDYXNlKCksCgkJCW9yaWcgPSB7CgkJCQlpbm5lcldpZHRoOiAkLmZuLmlubmVyV2lkdGgsCgkJCQlpbm5lckhlaWdodDogJC5mbi5pbm5lckhlaWdodCwKCQkJCW91dGVyV2lkdGg6ICQuZm4ub3V0ZXJXaWR0aCwKCQkJCW91dGVySGVpZ2h0OiAkLmZuLm91dGVySGVpZ2h0CgkJCX07CgoJCWZ1bmN0aW9uIHJlZHVjZSggZWxlbSwgc2l6ZSwgYm9yZGVyLCBtYXJnaW4gKSB7CgkJCSQuZWFjaCggc2lkZSwgZnVuY3Rpb24oKSB7CgkJCQlzaXplIC09IHBhcnNlRmxvYXQoICQuY3NzKCBlbGVtLCAicGFkZGluZyIgKyB0aGlzICkgKSB8fCAwOwoJCQkJaWYgKCBib3JkZXIgKSB7CgkJCQkJc2l6ZSAtPSBwYXJzZUZsb2F0KCAkLmNzcyggZWxlbSwgImJvcmRlciIgKyB0aGlzICsgIldpZHRoIiApICkgfHwgMDsKCQkJCX0KCQkJCWlmICggbWFyZ2luICkgewoJCQkJCXNpemUgLT0gcGFyc2VGbG9hdCggJC5jc3MoIGVsZW0sICJtYXJnaW4iICsgdGhpcyApICkgfHwgMDsKCQkJCX0KCQkJfSk7CgkJCXJldHVybiBzaXplOwoJCX0KCgkJJC5mblsgImlubmVyIiArIG5hbWUgXSA9IGZ1bmN0aW9uKCBzaXplICkgewoJCQlpZiAoIHNpemUgPT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiBvcmlnWyAiaW5uZXIiICsgbmFtZSBdLmNhbGwoIHRoaXMgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5jc3MoIHR5cGUsIHJlZHVjZSggdGhpcywgc2l6ZSApICsgInB4IiApOwoJCQl9KTsKCQl9OwoKCQkkLmZuWyAib3V0ZXIiICsgbmFtZV0gPSBmdW5jdGlvbiggc2l6ZSwgbWFyZ2luICkgewoJCQlpZiAoIHR5cGVvZiBzaXplICE9PSAibnVtYmVyIiApIHsKCQkJCXJldHVybiBvcmlnWyAib3V0ZXIiICsgbmFtZSBdLmNhbGwoIHRoaXMsIHNpemUgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMpLmNzcyggdHlwZSwgcmVkdWNlKCB0aGlzLCBzaXplLCB0cnVlLCBtYXJnaW4gKSArICJweCIgKTsKCQkJfSk7CgkJfTsKCX0pOwp9CgovLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAppZiAoICEkLmZuLmFkZEJhY2sgKSB7CgkkLmZuLmFkZEJhY2sgPSBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMuYWRkKCBzZWxlY3RvciA9PSBudWxsID8KCQkJdGhpcy5wcmV2T2JqZWN0IDogdGhpcy5wcmV2T2JqZWN0LmZpbHRlciggc2VsZWN0b3IgKQoJCSk7Cgl9Owp9CgovLyBzdXBwb3J0OiBqUXVlcnkgMS42LjEsIDEuNi4yIChodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC85NDEzKQppZiAoICQoICI8YT4iICkuZGF0YSggImEtYiIsICJhIiApLnJlbW92ZURhdGEoICJhLWIiICkuZGF0YSggImEtYiIgKSApIHsKCSQuZm4ucmVtb3ZlRGF0YSA9IChmdW5jdGlvbiggcmVtb3ZlRGF0YSApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGtleSApIHsKCQkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQkJcmV0dXJuIHJlbW92ZURhdGEuY2FsbCggdGhpcywgJC5jYW1lbENhc2UoIGtleSApICk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gcmVtb3ZlRGF0YS5jYWxsKCB0aGlzICk7CgkJCX0KCQl9OwoJfSkoICQuZm4ucmVtb3ZlRGF0YSApOwp9CgoKCgoKLy8gZGVwcmVjYXRlZAokLnVpLmllID0gISEvbXNpZSBbXHcuXSsvLmV4ZWMoIG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSApOwoKJC5zdXBwb3J0LnNlbGVjdHN0YXJ0ID0gIm9uc2VsZWN0c3RhcnQiIGluIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CiQuZm4uZXh0ZW5kKHsKCWRpc2FibGVTZWxlY3Rpb246IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmJpbmQoICggJC5zdXBwb3J0LnNlbGVjdHN0YXJ0ID8gInNlbGVjdHN0YXJ0IiA6ICJtb3VzZWRvd24iICkgKwoJCQkiLnVpLWRpc2FibGVTZWxlY3Rpb24iLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9KTsKCX0sCgoJZW5hYmxlU2VsZWN0aW9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy51bmJpbmQoICIudWktZGlzYWJsZVNlbGVjdGlvbiIgKTsKCX0sCgoJekluZGV4OiBmdW5jdGlvbiggekluZGV4ICkgewoJCWlmICggekluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0aGlzLmNzcyggInpJbmRleCIsIHpJbmRleCApOwoJCX0KCgkJaWYgKCB0aGlzLmxlbmd0aCApIHsKCQkJdmFyIGVsZW0gPSAkKCB0aGlzWyAwIF0gKSwgcG9zaXRpb24sIHZhbHVlOwoJCQl3aGlsZSAoIGVsZW0ubGVuZ3RoICYmIGVsZW1bIDAgXSAhPT0gZG9jdW1lbnQgKSB7CgkJCQkvLyBJZ25vcmUgei1pbmRleCBpZiBwb3NpdGlvbiBpcyBzZXQgdG8gYSB2YWx1ZSB3aGVyZSB6LWluZGV4IGlzIGlnbm9yZWQgYnkgdGhlIGJyb3dzZXIKCQkJCS8vIFRoaXMgbWFrZXMgYmVoYXZpb3Igb2YgdGhpcyBmdW5jdGlvbiBjb25zaXN0ZW50IGFjcm9zcyBicm93c2VycwoJCQkJLy8gV2ViS2l0IGFsd2F5cyByZXR1cm5zIGF1dG8gaWYgdGhlIGVsZW1lbnQgaXMgcG9zaXRpb25lZAoJCQkJcG9zaXRpb24gPSBlbGVtLmNzcyggInBvc2l0aW9uIiApOwoJCQkJaWYgKCBwb3NpdGlvbiA9PT0gImFic29sdXRlIiB8fCBwb3NpdGlvbiA9PT0gInJlbGF0aXZlIiB8fCBwb3NpdGlvbiA9PT0gImZpeGVkIiApIHsKCQkJCQkvLyBJRSByZXR1cm5zIDAgd2hlbiB6SW5kZXggaXMgbm90IHNwZWNpZmllZAoJCQkJCS8vIG90aGVyIGJyb3dzZXJzIHJldHVybiBhIHN0cmluZwoJCQkJCS8vIHdlIGlnbm9yZSB0aGUgY2FzZSBvZiBuZXN0ZWQgZWxlbWVudHMgd2l0aCBhbiBleHBsaWNpdCB2YWx1ZSBvZiAwCgkJCQkJLy8gPGRpdiBzdHlsZT0iei1pbmRleDogLTEwOyI+PGRpdiBzdHlsZT0iei1pbmRleDogMDsiPjwvZGl2PjwvZGl2PgoJCQkJCXZhbHVlID0gcGFyc2VJbnQoIGVsZW0uY3NzKCAiekluZGV4IiApLCAxMCApOwoJCQkJCWlmICggIWlzTmFOKCB2YWx1ZSApICYmIHZhbHVlICE9PSAwICkgewoJCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQkJfQoJCQkJfQoJCQkJZWxlbSA9IGVsZW0ucGFyZW50KCk7CgkJCX0KCQl9CgoJCXJldHVybiAwOwoJfQp9KTsKCi8vICQudWkucGx1Z2luIGlzIGRlcHJlY2F0ZWQuIFVzZSAkLndpZGdldCgpIGV4dGVuc2lvbnMgaW5zdGVhZC4KJC51aS5wbHVnaW4gPSB7CglhZGQ6IGZ1bmN0aW9uKCBtb2R1bGUsIG9wdGlvbiwgc2V0ICkgewoJCXZhciBpLAoJCQlwcm90byA9ICQudWlbIG1vZHVsZSBdLnByb3RvdHlwZTsKCQlmb3IgKCBpIGluIHNldCApIHsKCQkJcHJvdG8ucGx1Z2luc1sgaSBdID0gcHJvdG8ucGx1Z2luc1sgaSBdIHx8IFtdOwoJCQlwcm90by5wbHVnaW5zWyBpIF0ucHVzaCggWyBvcHRpb24sIHNldFsgaSBdIF0gKTsKCQl9Cgl9LAoJY2FsbDogZnVuY3Rpb24oIGluc3RhbmNlLCBuYW1lLCBhcmdzLCBhbGxvd0Rpc2Nvbm5lY3RlZCApIHsKCQl2YXIgaSwKCQkJc2V0ID0gaW5zdGFuY2UucGx1Z2luc1sgbmFtZSBdOwoKCQlpZiAoICFzZXQgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggIWFsbG93RGlzY29ubmVjdGVkICYmICggIWluc3RhbmNlLmVsZW1lbnRbIDAgXS5wYXJlbnROb2RlIHx8IGluc3RhbmNlLmVsZW1lbnRbIDAgXS5wYXJlbnROb2RlLm5vZGVUeXBlID09PSAxMSApICkgewoJCQlyZXR1cm47CgkJfQoKCQlmb3IgKCBpID0gMDsgaSA8IHNldC5sZW5ndGg7IGkrKyApIHsKCQkJaWYgKCBpbnN0YW5jZS5vcHRpb25zWyBzZXRbIGkgXVsgMCBdIF0gKSB7CgkJCQlzZXRbIGkgXVsgMSBdLmFwcGx5KCBpbnN0YW5jZS5lbGVtZW50LCBhcmdzICk7CgkJCX0KCQl9Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gZGVmaW5lIHRoZSB3aW5kb3cgYW5kIHRoZSBkb2N1bWVudCBvYmplY3RzCgkJd2luZG93OiAkKCB3aW5kb3cgKSwKCQlkb2N1bWVudDogJCggZG9jdW1lbnQgKSwKCgkJLy8gVE9ETzogUmVtb3ZlIGFuZCB1c2UgJC51aS5rZXlDb2RlIGRpcmVjdGx5CgkJa2V5Q29kZTogJC51aS5rZXlDb2RlLAoKCQkvLyBQbGFjZSB0byBzdG9yZSB2YXJpb3VzIHdpZGdldCBleHRlbnNpb25zCgkJYmVoYXZpb3JzOiB7fSwKCgkJLy8gU2Nyb2xsIHBhZ2UgdmVydGljYWxseTogc2Nyb2xsIHRvIDAgdG8gaGlkZSBpT1MgYWRkcmVzcyBiYXIsIG9yIHBhc3MgYSBZIHZhbHVlCgkJc2lsZW50U2Nyb2xsOiBmdW5jdGlvbiggeXBvcyApIHsKCQkJaWYgKCAkLnR5cGUoIHlwb3MgKSAhPT0gIm51bWJlciIgKSB7CgkJCQl5cG9zID0gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJCX0KCgkJCS8vIHByZXZlbnQgc2Nyb2xsc3RhcnQgYW5kIHNjcm9sbHN0b3AgZXZlbnRzCgkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB5cG9zICk7CgkJCQkkLm1vYmlsZS5kb2N1bWVudC50cmlnZ2VyKCAic2lsZW50c2Nyb2xsIiwgeyB4OiAwLCB5OiB5cG9zIH0pOwoJCQl9LCAyMCApOwoKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJfSwgMTUwICk7CgkJfSwKCgkJZ2V0Q2xvc2VzdEJhc2VVcmw6IGZ1bmN0aW9uKCBlbGUgKQl7CgkJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFnZSBhbmQgZXh0cmFjdCBvdXQgaXRzIHVybC4KCQkJdmFyIHVybCA9ICQoIGVsZSApLmNsb3Nlc3QoICIudWktcGFnZSIgKS5qcW1EYXRhKCAidXJsIiApLAoJCQkJYmFzZSA9ICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgoJCQlpZiAoICEkLm1vYmlsZS5keW5hbWljQmFzZUVuYWJsZWQgfHwgIXVybCB8fCAhJC5tb2JpbGUucGF0aC5pc1BhdGgoIHVybCApICkgewoJCQkJdXJsID0gYmFzZTsKCQkJfQoKCQkJcmV0dXJuICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGJhc2UgKTsKCQl9LAoJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzczogZnVuY3Rpb24oIGZvcmNlUmVtb3ZhbCApIHsKCQkJaWYgKCAhISQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rICYmCgkJCQkoICEkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluay5jbG9zZXN0KCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKS5sZW5ndGggfHwKCQkJCQlmb3JjZVJlbW92YWwgKSApIHsKCgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfQoJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluayA9IG51bGw7CgkJfSwKCgkJLy8gREVQUkVDQVRFRCBpbiAxLjQKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhcmVudCB3aXRoIGEgdGhlbWUgY2xhc3Mgb24gaXQuIE5vdGUgdGhhdAoJCS8vIHdlIGFyZSBub3QgdXNpbmcgJC5mbi5jbG9zZXN0KCkgb24gcHVycG9zZSBoZXJlIGJlY2F1c2UgdGhpcwoJCS8vIG1ldGhvZCBnZXRzIGNhbGxlZCBxdWl0ZSBhIGJpdCBhbmQgd2UgbmVlZCBpdCB0byBiZSBhcyBmYXN0CgkJLy8gYXMgcG9zc2libGUuCgkJZ2V0SW5oZXJpdGVkVGhlbWU6IGZ1bmN0aW9uKCBlbCwgZGVmYXVsdFRoZW1lICkgewoJCQl2YXIgZSA9IGVsWyAwIF0sCgkJCQlsdHIgPSAiIiwKCQkJCXJlID0gL3VpLShiYXJ8Ym9keXxvdmVybGF5KS0oW2Etel0pXGIvLAoJCQkJYywgbTsKCQkJd2hpbGUgKCBlICkgewoJCQkJYyA9IGUuY2xhc3NOYW1lIHx8ICIiOwoJCQkJaWYgKCBjICYmICggbSA9IHJlLmV4ZWMoIGMgKSApICYmICggbHRyID0gbVsgMiBdICkgKSB7CgkJCQkJLy8gV2UgZm91bmQgYSBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzCgkJCQkJLy8gb24gaXQgc28gYmFpbCBmcm9tIHRoaXMgbG9vcC4KCQkJCQlicmVhazsKCQkJCX0KCgkJCQllID0gZS5wYXJlbnROb2RlOwoJCQl9CgkJCS8vIFJldHVybiB0aGUgdGhlbWUgbGV0dGVyIHdlIGZvdW5kLCBpZiBub25lLCByZXR1cm4gdGhlCgkJCS8vIHNwZWNpZmllZCBkZWZhdWx0LgoJCQlyZXR1cm4gbHRyIHx8IGRlZmF1bHRUaGVtZSB8fCAiYSI7CgkJfSwKCgkJZW5oYW5jZWFibGU6IGZ1bmN0aW9uKCBlbGVtZW50cyApIHsKCQkJcmV0dXJuIHRoaXMuaGF2ZVBhcmVudHMoIGVsZW1lbnRzLCAiZW5oYW5jZSIgKTsKCQl9LAoKCQloaWphY2thYmxlOiBmdW5jdGlvbiggZWxlbWVudHMgKSB7CgkJCXJldHVybiB0aGlzLmhhdmVQYXJlbnRzKCBlbGVtZW50cywgImFqYXgiICk7CgkJfSwKCgkJaGF2ZVBhcmVudHM6IGZ1bmN0aW9uKCBlbGVtZW50cywgYXR0ciApIHsKCQkJaWYgKCAhJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgKSB7CgkJCQlyZXR1cm4gZWxlbWVudHM7CgkJCX0KCgkJCXZhciBjb3VudCA9IGVsZW1lbnRzLmxlbmd0aCwKCQkJCSRuZXdTZXQgPSAkKCksCgkJCQllLCAkZWxlbWVudCwgZXhjbHVkZWQsCgkJCQlpLCBjOwoKCQkJZm9yICggaSA9IDA7IGkgPCBjb3VudDsgaSsrICkgewoJCQkJJGVsZW1lbnQgPSBlbGVtZW50cy5lcSggaSApOwoJCQkJZXhjbHVkZWQgPSBmYWxzZTsKCQkJCWUgPSBlbGVtZW50c1sgaSBdOwoKCQkJCXdoaWxlICggZSApIHsKCQkJCQljID0gZS5nZXRBdHRyaWJ1dGUgPyBlLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgYXR0ciApIDogIiI7CgoJCQkJCWlmICggYyA9PT0gImZhbHNlIiApIHsKCQkJCQkJZXhjbHVkZWQgPSB0cnVlOwoJCQkJCQlicmVhazsKCQkJCQl9CgoJCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCQl9CgoJCQkJaWYgKCAhZXhjbHVkZWQgKSB7CgkJCQkJJG5ld1NldCA9ICRuZXdTZXQuYWRkKCAkZWxlbWVudCApOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gJG5ld1NldDsKCQl9LAoKCQlnZXRTY3JlZW5IZWlnaHQ6IGZ1bmN0aW9uKCkgewoJCQkvLyBOYXRpdmUgaW5uZXJIZWlnaHQgcmV0dXJucyBtb3JlIGFjY3VyYXRlIHZhbHVlIGZvciB0aGlzIGFjcm9zcyBwbGF0Zm9ybXMsCgkJCS8vIGpRdWVyeSB2ZXJzaW9uIGlzIGhlcmUgYXMgYSBub3JtYWxpemVkIGZhbGxiYWNrIGZvciBwbGF0Zm9ybXMgbGlrZSBTeW1iaWFuCgkJCXJldHVybiB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJC5tb2JpbGUud2luZG93LmhlaWdodCgpOwoJCX0sCgoJCS8vc2ltcGx5IHNldCB0aGUgYWN0aXZlIHBhZ2UncyBtaW5pbXVtIGhlaWdodCB0byBzY3JlZW4gaGVpZ2h0LCBkZXBlbmRpbmcgb24gb3JpZW50YXRpb24KCQlyZXNldEFjdGl2ZVBhZ2VIZWlnaHQ6IGZ1bmN0aW9uKCBoZWlnaHQgKSB7CgkJCXZhciBwYWdlID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICksCgkJCQlwYWdlSGVpZ2h0ID0gcGFnZS5oZWlnaHQoKSwKCQkJCXBhZ2VPdXRlckhlaWdodCA9IHBhZ2Uub3V0ZXJIZWlnaHQoIHRydWUgKTsKCgkJCWhlaWdodCA9ICggdHlwZW9mIGhlaWdodCA9PT0gIm51bWJlciIgKSA/IGhlaWdodCA6ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQkJcGFnZS5jc3MoICJtaW4taGVpZ2h0IiwgaGVpZ2h0IC0gKCBwYWdlT3V0ZXJIZWlnaHQgLSBwYWdlSGVpZ2h0ICkgKTsKCQl9LAoKCQlsb2FkaW5nOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgY2FsbCB0byB0aGlzIGZ1bmN0aW9uLCBpbnN0YW50aWF0ZSBhIGxvYWRlciB3aWRnZXQKCQkJdmFyIGxvYWRlciA9IHRoaXMubG9hZGluZy5fd2lkZ2V0IHx8ICQoICQubW9iaWxlLmxvYWRlci5wcm90b3R5cGUuZGVmYXVsdEh0bWwgKS5sb2FkZXIoKSwKCgkJCQkvLyBDYWxsIHRoZSBhcHByb3ByaWF0ZSBtZXRob2Qgb24gdGhlIGxvYWRlcgoJCQkJcmV0dXJuVmFsdWUgPSBsb2FkZXIubG9hZGVyLmFwcGx5KCBsb2FkZXIsIGFyZ3VtZW50cyApOwoKCQkJLy8gTWFrZSBzdXJlIHRoZSBsb2FkZXIgaXMgcmV0YWluZWQgZm9yIGZ1dHVyZSBjYWxscyB0byB0aGlzIGZ1bmN0aW9uLgoJCQl0aGlzLmxvYWRpbmcuX3dpZGdldCA9IGxvYWRlcjsKCgkJCXJldHVybiByZXR1cm5WYWx1ZTsKCQl9Cgl9KTsKCgkkLmFkZERlcGVuZGVudHMgPSBmdW5jdGlvbiggZWxlbSwgbmV3RGVwZW5kZW50cyApIHsKCQl2YXIgJGVsZW0gPSAkKCBlbGVtICksCgkJCWRlcGVuZGVudHMgPSAkZWxlbS5qcW1EYXRhKCAiZGVwZW5kZW50cyIgKSB8fCAkKCk7CgoJCSRlbGVtLmpxbURhdGEoICJkZXBlbmRlbnRzIiwgJCggZGVwZW5kZW50cyApLmFkZCggbmV3RGVwZW5kZW50cyApICk7Cgl9OwoKCS8vIHBsdWdpbnMKCSQuZm4uZXh0ZW5kKHsKCQlyZW1vdmVXaXRoRGVwZW5kZW50czogZnVuY3Rpb24oKSB7CgkJCSQucmVtb3ZlV2l0aERlcGVuZGVudHMoIHRoaXMgKTsKCQl9LAoKCQkvLyBFbmhhbmNlIGNoaWxkIGVsZW1lbnRzCgkJZW5oYW5jZVdpdGhpbjogZnVuY3Rpb24oKSB7CgkJCXZhciBpbmRleCwKCQkJCXdpZGdldEVsZW1lbnRzID0ge30sCgkJCQlrZWVwTmF0aXZlID0gJC5tb2JpbGUucGFnZS5wcm90b3R5cGUua2VlcE5hdGl2ZVNlbGVjdG9yKCksCgkJCQl0aGF0ID0gdGhpczsKCgkJCS8vIEFkZCBubyBqcyBjbGFzcyB0byBlbGVtZW50cwoJCQlpZiAoICQubW9iaWxlLm5vanMgKSB7CgkJCQkkLm1vYmlsZS5ub2pzKCB0aGlzICk7CgkJCX0KCgkJCS8vIEJpbmQgbGlua3MgZm9yIGFqYXggbmF2CgkJCWlmICggJC5tb2JpbGUubGlua3MgKSB7CgkJCQkkLm1vYmlsZS5saW5rcyggdGhpcyApOwoJCQl9CgoJCQkvLyBEZWdyYWRlIGlucHV0cyBmb3Igc3R5bGVpbmcKCQkJaWYgKCAkLm1vYmlsZS5kZWdyYWRlSW5wdXRzV2l0aGluICkgewoJCQkJJC5tb2JpbGUuZGVncmFkZUlucHV0c1dpdGhpbiggdGhpcyApOwoJCQl9CgoJCQkvLyBSdW4gYnV0dG9ubWFya3VwCgkJCWlmICggJC5mbi5idXR0b25NYXJrdXAgKSB7CgkJCQl0aGlzLmZpbmQoICQuZm4uYnV0dG9uTWFya3VwLmluaXRTZWxlY3RvciApLm5vdCgga2VlcE5hdGl2ZSApCgkJCQkuanFtRW5oYW5jZWFibGUoKS5idXR0b25NYXJrdXAoKTsKCQkJfQoKCQkJLy8gQWRkIGNsYXNzZXMgZm9yIGZpZWxkQ29udGFpbgoJCQlpZiAoICQuZm4uZmllbGRjb250YWluICkgewoJCQkJdGhpcy5maW5kKCAiOmpxbURhdGEocm9sZT0nZmllbGRjb250YWluJykiICkubm90KCBrZWVwTmF0aXZlICkKCQkJCS5qcW1FbmhhbmNlYWJsZSgpLmZpZWxkY29udGFpbigpOwoJCQl9CgoJCQkvLyBFbmhhbmNlIHdpZGdldHMKCQkJJC5lYWNoKCAkLm1vYmlsZS53aWRnZXRzLCBmdW5jdGlvbiggbmFtZSwgY29uc3RydWN0b3IgKSB7CgoJCQkJLy8gSWYgaW5pdFNlbGVjdG9yIG5vdCBmYWxzZSBmaW5kIGVsZW1lbnRzCgkJCQlpZiAoIGNvbnN0cnVjdG9yLmluaXRTZWxlY3RvciApIHsKCgkJCQkJLy8gRmlsdGVyIGVsZW1lbnRzIHRoYXQgc2hvdWxkIG5vdCBiZSBlbmhhbmNlZCBiYXNlZCBvbiBwYXJlbnRzCgkJCQkJdmFyIGVsZW1lbnRzID0gJC5tb2JpbGUuZW5oYW5jZWFibGUoIHRoYXQuZmluZCggY29uc3RydWN0b3IuaW5pdFNlbGVjdG9yICkgKTsKCgkJCQkJLy8gSWYgYW55IG1hdGNoaW5nIGVsZW1lbnRzIHJlbWFpbiBmaWx0ZXIgb25lcyB3aXRoIGtlZXBOYXRpdmVTZWxlY3RvcgoJCQkJCWlmICggZWxlbWVudHMubGVuZ3RoID4gMCApIHsKCgkJCQkJCS8vICQubW9iaWxlLnBhZ2UucHJvdG90eXBlLmtlZXBOYXRpdmVTZWxlY3RvciBpcyBkZXByZWNhdGVkIHRoaXMgaXMganVzdCBmb3IgYmFja2NvbXBhdAoJCQkJCQkvLyBTd2l0Y2ggdG8gJC5tb2JpbGUua2VlcE5hdGl2ZSBpbiAxLjUgd2hpY2ggaXMganVzdCBhIHZhbHVlIG5vdCBhIGZ1bmN0aW9uCgkJCQkJCWVsZW1lbnRzID0gZWxlbWVudHMubm90KCBrZWVwTmF0aXZlICk7CgkJCQkJfQoKCQkJCQkvLyBFbmhhbmNlIHdoYXRldmVyIGlzIGxlZnQKCQkJCQlpZiAoIGVsZW1lbnRzLmxlbmd0aCA+IDAgKSB7CgkJCQkJCXdpZGdldEVsZW1lbnRzWyBjb25zdHJ1Y3Rvci5wcm90b3R5cGUud2lkZ2V0TmFtZSBdID0gZWxlbWVudHM7CgkJCQkJfQoJCQkJfQoJCQl9KTsKCgkJCWZvciAoIGluZGV4IGluIHdpZGdldEVsZW1lbnRzICkgewoJCQkJd2lkZ2V0RWxlbWVudHNbIGluZGV4IF1bIGluZGV4IF0oKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJYWRkRGVwZW5kZW50czogZnVuY3Rpb24oIG5ld0RlcGVuZGVudHMgKSB7CgkJCSQuYWRkRGVwZW5kZW50cyggdGhpcywgbmV3RGVwZW5kZW50cyApOwoJCX0sCgoJCS8vIG5vdGUgdGhhdCB0aGlzIGhlbHBlciBkb2Vzbid0IGF0dGVtcHQgdG8gaGFuZGxlIHRoZSBjYWxsYmFjawoJCS8vIG9yIHNldHRpbmcgb2YgYW4gaHRtbCBlbGVtZW50J3MgdGV4dCwgaXRzIG9ubHkgcHVycG9zZSBpcwoJCS8vIHRvIHJldHVybiB0aGUgaHRtbCBlbmNvZGVkIHZlcnNpb24gb2YgdGhlIHRleHQgaW4gYWxsIGNhc2VzLiAodGh1cyB0aGUgbmFtZSkKCQlnZXRFbmNvZGVkVGV4dDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkKCAiPGE+IiApLnRleHQoIHRoaXMudGV4dCgpICkuaHRtbCgpOwoJCX0sCgoJCS8vIGZsdWVudCBoZWxwZXIgZnVuY3Rpb24gZm9yIHRoZSBtb2JpbGUgbmFtZXNwYWNlZCBlcXVpdmFsZW50CgkJanFtRW5oYW5jZWFibGU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuZW5oYW5jZWFibGUoIHRoaXMgKTsKCQl9LAoKCQlqcW1IaWphY2thYmxlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmhpamFja2FibGUoIHRoaXMgKTsKCQl9Cgl9KTsKCgkkLnJlbW92ZVdpdGhEZXBlbmRlbnRzID0gZnVuY3Rpb24oIG5hdGl2ZUVsZW1lbnQgKSB7CgkJdmFyIGVsZW1lbnQgPSAkKCBuYXRpdmVFbGVtZW50ICk7CgoJCSggZWxlbWVudC5qcW1EYXRhKCAiZGVwZW5kZW50cyIgKSB8fCAkKCkgKS5yZW1vdmUoKTsKCQllbGVtZW50LnJlbW92ZSgpOwoJfTsKCSQuYWRkRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBuYXRpdmVFbGVtZW50LCBuZXdEZXBlbmRlbnRzICkgewoJCXZhciBlbGVtZW50ID0gJCggbmF0aXZlRWxlbWVudCApLAoJCQlkZXBlbmRlbnRzID0gZWxlbWVudC5qcW1EYXRhKCAiZGVwZW5kZW50cyIgKSB8fCAkKCk7CgoJCWVsZW1lbnQuanFtRGF0YSggImRlcGVuZGVudHMiLCAkKCBkZXBlbmRlbnRzICkuYWRkKCBuZXdEZXBlbmRlbnRzICkgKTsKCX07CgoJJC5maW5kLm1hdGNoZXMgPSBmdW5jdGlvbiggZXhwciwgc2V0ICkgewoJCXJldHVybiAkLmZpbmQoIGV4cHIsIG51bGwsIG51bGwsIHNldCApOwoJfTsKCgkkLmZpbmQubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24oIG5vZGUsIGV4cHIgKSB7CgkJcmV0dXJuICQuZmluZCggZXhwciwgbnVsbCwgbnVsbCwgWyBub2RlIF0gKS5sZW5ndGggPiAwOwoJfTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCgovKiEKICogalF1ZXJ5IFVJIFdpZGdldCBjMGFiNzEwNTZiOTM2NjI3ZThhNzgyMWYwM2MwNDRhZWM2MjgwYTQwTgogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2pRdWVyeS53aWRnZXQvCiAqLwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciB1dWlkID0gMCwKCXNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLAoJX2NsZWFuRGF0YSA9ICQuY2xlYW5EYXRhOwokLmNsZWFuRGF0YSA9IGZ1bmN0aW9uKCBlbGVtcyApIHsKCWZvciAoIHZhciBpID0gMCwgZWxlbTsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCXRyeSB7CgkJCSQoIGVsZW0gKS50cmlnZ2VySGFuZGxlciggInJlbW92ZSIgKTsKCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC84MjM1CgkJfSBjYXRjaCggZSApIHt9Cgl9CglfY2xlYW5EYXRhKCBlbGVtcyApOwp9OwoKJC53aWRnZXQgPSBmdW5jdGlvbiggbmFtZSwgYmFzZSwgcHJvdG90eXBlICkgewoJdmFyIGZ1bGxOYW1lLCBleGlzdGluZ0NvbnN0cnVjdG9yLCBjb25zdHJ1Y3RvciwgYmFzZVByb3RvdHlwZSwKCQkvLyBwcm94aWVkUHJvdG90eXBlIGFsbG93cyB0aGUgcHJvdmlkZWQgcHJvdG90eXBlIHRvIHJlbWFpbiB1bm1vZGlmaWVkCgkJLy8gc28gdGhhdCBpdCBjYW4gYmUgdXNlZCBhcyBhIG1peGluIGZvciBtdWx0aXBsZSB3aWRnZXRzICgjODg3NikKCQlwcm94aWVkUHJvdG90eXBlID0ge30sCgkJbmFtZXNwYWNlID0gbmFtZS5zcGxpdCggIi4iIClbIDAgXTsKCgluYW1lID0gbmFtZS5zcGxpdCggIi4iIClbIDEgXTsKCWZ1bGxOYW1lID0gbmFtZXNwYWNlICsgIi0iICsgbmFtZTsKCglpZiAoICFwcm90b3R5cGUgKSB7CgkJcHJvdG90eXBlID0gYmFzZTsKCQliYXNlID0gJC5XaWRnZXQ7Cgl9CgoJLy8gY3JlYXRlIHNlbGVjdG9yIGZvciBwbHVnaW4KCSQuZXhwclsgIjoiIF1bIGZ1bGxOYW1lLnRvTG93ZXJDYXNlKCkgXSA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiAhISQuZGF0YSggZWxlbSwgZnVsbE5hbWUgKTsKCX07CgoJJFsgbmFtZXNwYWNlIF0gPSAkWyBuYW1lc3BhY2UgXSB8fCB7fTsKCWV4aXN0aW5nQ29uc3RydWN0b3IgPSAkWyBuYW1lc3BhY2UgXVsgbmFtZSBdOwoJY29uc3RydWN0b3IgPSAkWyBuYW1lc3BhY2UgXVsgbmFtZSBdID0gZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7CgkJLy8gYWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0ICJuZXciIGtleXdvcmQKCQlpZiAoICF0aGlzLl9jcmVhdGVXaWRnZXQgKSB7CgkJCXJldHVybiBuZXcgY29uc3RydWN0b3IoIG9wdGlvbnMsIGVsZW1lbnQgKTsKCQl9CgoJCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCBpbml0aWFsaXppbmcgZm9yIHNpbXBsZSBpbmhlcml0YW5jZQoJCS8vIG11c3QgdXNlICJuZXciIGtleXdvcmQgKHRoZSBjb2RlIGFib3ZlIGFsd2F5cyBwYXNzZXMgYXJncykKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggKSB7CgkJCXRoaXMuX2NyZWF0ZVdpZGdldCggb3B0aW9ucywgZWxlbWVudCApOwoJCX0KCX07CgkvLyBleHRlbmQgd2l0aCB0aGUgZXhpc3RpbmcgY29uc3RydWN0b3IgdG8gY2Fycnkgb3ZlciBhbnkgc3RhdGljIHByb3BlcnRpZXMKCSQuZXh0ZW5kKCBjb25zdHJ1Y3RvciwgZXhpc3RpbmdDb25zdHJ1Y3RvciwgewoJCXZlcnNpb246IHByb3RvdHlwZS52ZXJzaW9uLAoJCS8vIGNvcHkgdGhlIG9iamVjdCB1c2VkIHRvIGNyZWF0ZSB0aGUgcHJvdG90eXBlIGluIGNhc2Ugd2UgbmVlZCB0bwoJCS8vIHJlZGVmaW5lIHRoZSB3aWRnZXQgbGF0ZXIKCQlfcHJvdG86ICQuZXh0ZW5kKCB7fSwgcHJvdG90eXBlICksCgkJLy8gdHJhY2sgd2lkZ2V0cyB0aGF0IGluaGVyaXQgZnJvbSB0aGlzIHdpZGdldCBpbiBjYXNlIHRoaXMgd2lkZ2V0IGlzCgkJLy8gcmVkZWZpbmVkIGFmdGVyIGEgd2lkZ2V0IGluaGVyaXRzIGZyb20gaXQKCQlfY2hpbGRDb25zdHJ1Y3RvcnM6IFtdCgl9KTsKCgliYXNlUHJvdG90eXBlID0gbmV3IGJhc2UoKTsKCS8vIHdlIG5lZWQgdG8gbWFrZSB0aGUgb3B0aW9ucyBoYXNoIGEgcHJvcGVydHkgZGlyZWN0bHkgb24gdGhlIG5ldyBpbnN0YW5jZQoJLy8gb3RoZXJ3aXNlIHdlJ2xsIG1vZGlmeSB0aGUgb3B0aW9ucyBoYXNoIG9uIHRoZSBwcm90b3R5cGUgdGhhdCB3ZSdyZQoJLy8gaW5oZXJpdGluZyBmcm9tCgliYXNlUHJvdG90eXBlLm9wdGlvbnMgPSAkLndpZGdldC5leHRlbmQoIHt9LCBiYXNlUHJvdG90eXBlLm9wdGlvbnMgKTsKCSQuZWFjaCggcHJvdG90eXBlLCBmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7CgkJaWYgKCAhJC5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlwcm94aWVkUHJvdG90eXBlWyBwcm9wIF0gPSB2YWx1ZTsKCQkJcmV0dXJuOwoJCX0KCQlwcm94aWVkUHJvdG90eXBlWyBwcm9wIF0gPSAoZnVuY3Rpb24oKSB7CgkJCXZhciBfc3VwZXIgPSBmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gYmFzZS5wcm90b3R5cGVbIHByb3AgXS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCQl9LAoJCQkJX3N1cGVyQXBwbHkgPSBmdW5jdGlvbiggYXJncyApIHsKCQkJCQlyZXR1cm4gYmFzZS5wcm90b3R5cGVbIHByb3AgXS5hcHBseSggdGhpcywgYXJncyApOwoJCQkJfTsKCQkJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCQkJdmFyIF9fc3VwZXIgPSB0aGlzLl9zdXBlciwKCQkJCQlfX3N1cGVyQXBwbHkgPSB0aGlzLl9zdXBlckFwcGx5LAoJCQkJCXJldHVyblZhbHVlOwoKCQkJCXRoaXMuX3N1cGVyID0gX3N1cGVyOwoJCQkJdGhpcy5fc3VwZXJBcHBseSA9IF9zdXBlckFwcGx5OwoKCQkJCXJldHVyblZhbHVlID0gdmFsdWUuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoKCQkJCXRoaXMuX3N1cGVyID0gX19zdXBlcjsKCQkJCXRoaXMuX3N1cGVyQXBwbHkgPSBfX3N1cGVyQXBwbHk7CgoJCQkJcmV0dXJuIHJldHVyblZhbHVlOwoJCQl9OwoJCX0pKCk7Cgl9KTsKCWNvbnN0cnVjdG9yLnByb3RvdHlwZSA9ICQud2lkZ2V0LmV4dGVuZCggYmFzZVByb3RvdHlwZSwgewoJCS8vIFRPRE86IHJlbW92ZSBzdXBwb3J0IGZvciB3aWRnZXRFdmVudFByZWZpeAoJCS8vIGFsd2F5cyB1c2UgdGhlIG5hbWUgKyBhIGNvbG9uIGFzIHRoZSBwcmVmaXgsIGUuZy4sIGRyYWdnYWJsZTpzdGFydAoJCS8vIGRvbid0IHByZWZpeCBmb3Igd2lkZ2V0cyB0aGF0IGFyZW4ndCBET00tYmFzZWQKCQl3aWRnZXRFdmVudFByZWZpeDogZXhpc3RpbmdDb25zdHJ1Y3RvciA/IChiYXNlUHJvdG90eXBlLndpZGdldEV2ZW50UHJlZml4IHx8IG5hbWUpIDogbmFtZQoJfSwgcHJveGllZFByb3RvdHlwZSwgewoJCWNvbnN0cnVjdG9yOiBjb25zdHJ1Y3RvciwKCQluYW1lc3BhY2U6IG5hbWVzcGFjZSwKCQl3aWRnZXROYW1lOiBuYW1lLAoJCXdpZGdldEZ1bGxOYW1lOiBmdWxsTmFtZQoJfSk7CgoJLy8gSWYgdGhpcyB3aWRnZXQgaXMgYmVpbmcgcmVkZWZpbmVkIHRoZW4gd2UgbmVlZCB0byBmaW5kIGFsbCB3aWRnZXRzIHRoYXQKCS8vIGFyZSBpbmhlcml0aW5nIGZyb20gaXQgYW5kIHJlZGVmaW5lIGFsbCBvZiB0aGVtIHNvIHRoYXQgdGhleSBpbmhlcml0IGZyb20KCS8vIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGlzIHdpZGdldC4gV2UncmUgZXNzZW50aWFsbHkgdHJ5aW5nIHRvIHJlcGxhY2Ugb25lCgkvLyBsZXZlbCBpbiB0aGUgcHJvdG90eXBlIGNoYWluLgoJaWYgKCBleGlzdGluZ0NvbnN0cnVjdG9yICkgewoJCSQuZWFjaCggZXhpc3RpbmdDb25zdHJ1Y3Rvci5fY2hpbGRDb25zdHJ1Y3RvcnMsIGZ1bmN0aW9uKCBpLCBjaGlsZCApIHsKCQkJdmFyIGNoaWxkUHJvdG90eXBlID0gY2hpbGQucHJvdG90eXBlOwoKCQkJLy8gcmVkZWZpbmUgdGhlIGNoaWxkIHdpZGdldCB1c2luZyB0aGUgc2FtZSBwcm90b3R5cGUgdGhhdCB3YXMKCQkJLy8gb3JpZ2luYWxseSB1c2VkLCBidXQgaW5oZXJpdCBmcm9tIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGUgYmFzZQoJCQkkLndpZGdldCggY2hpbGRQcm90b3R5cGUubmFtZXNwYWNlICsgIi4iICsgY2hpbGRQcm90b3R5cGUud2lkZ2V0TmFtZSwgY29uc3RydWN0b3IsIGNoaWxkLl9wcm90byApOwoJCX0pOwoJCS8vIHJlbW92ZSB0aGUgbGlzdCBvZiBleGlzdGluZyBjaGlsZCBjb25zdHJ1Y3RvcnMgZnJvbSB0aGUgb2xkIGNvbnN0cnVjdG9yCgkJLy8gc28gdGhlIG9sZCBjaGlsZCBjb25zdHJ1Y3RvcnMgY2FuIGJlIGdhcmJhZ2UgY29sbGVjdGVkCgkJZGVsZXRlIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzOwoJfSBlbHNlIHsKCQliYXNlLl9jaGlsZENvbnN0cnVjdG9ycy5wdXNoKCBjb25zdHJ1Y3RvciApOwoJfQoKCSQud2lkZ2V0LmJyaWRnZSggbmFtZSwgY29uc3RydWN0b3IgKTsKCglyZXR1cm4gY29uc3RydWN0b3I7Cn07CgokLndpZGdldC5leHRlbmQgPSBmdW5jdGlvbiggdGFyZ2V0ICkgewoJdmFyIGlucHV0ID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJaW5wdXRJbmRleCA9IDAsCgkJaW5wdXRMZW5ndGggPSBpbnB1dC5sZW5ndGgsCgkJa2V5LAoJCXZhbHVlOwoJZm9yICggOyBpbnB1dEluZGV4IDwgaW5wdXRMZW5ndGg7IGlucHV0SW5kZXgrKyApIHsKCQlmb3IgKCBrZXkgaW4gaW5wdXRbIGlucHV0SW5kZXggXSApIHsKCQkJdmFsdWUgPSBpbnB1dFsgaW5wdXRJbmRleCBdWyBrZXkgXTsKCQkJaWYgKCBpbnB1dFsgaW5wdXRJbmRleCBdLmhhc093blByb3BlcnR5KCBrZXkgKSAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJLy8gQ2xvbmUgb2JqZWN0cwoJCQkJaWYgKCAkLmlzUGxhaW5PYmplY3QoIHZhbHVlICkgKSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9ICQuaXNQbGFpbk9iamVjdCggdGFyZ2V0WyBrZXkgXSApID8KCQkJCQkJJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGFyZ2V0WyBrZXkgXSwgdmFsdWUgKSA6CgkJCQkJCS8vIERvbid0IGV4dGVuZCBzdHJpbmdzLCBhcnJheXMsIGV0Yy4gd2l0aCBvYmplY3RzCgkJCQkJCSQud2lkZ2V0LmV4dGVuZCgge30sIHZhbHVlICk7CgkJCQkvLyBDb3B5IGV2ZXJ5dGhpbmcgZWxzZSBieSByZWZlcmVuY2UKCQkJCX0gZWxzZSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoJfQoJcmV0dXJuIHRhcmdldDsKfTsKCiQud2lkZ2V0LmJyaWRnZSA9IGZ1bmN0aW9uKCBuYW1lLCBvYmplY3QgKSB7Cgl2YXIgZnVsbE5hbWUgPSBvYmplY3QucHJvdG90eXBlLndpZGdldEZ1bGxOYW1lIHx8IG5hbWU7CgkkLmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNNZXRob2RDYWxsID0gdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciLAoJCQlhcmdzID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJCXJldHVyblZhbHVlID0gdGhpczsKCgkJLy8gYWxsb3cgbXVsdGlwbGUgaGFzaGVzIHRvIGJlIHBhc3NlZCBvbiBpbml0CgkJb3B0aW9ucyA9ICFpc01ldGhvZENhbGwgJiYgYXJncy5sZW5ndGggPwoJCQkkLndpZGdldC5leHRlbmQuYXBwbHkoIG51bGwsIFsgb3B0aW9ucyBdLmNvbmNhdChhcmdzKSApIDoKCQkJb3B0aW9uczsKCgkJaWYgKCBpc01ldGhvZENhbGwgKSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBtZXRob2RWYWx1ZSwKCQkJCQlpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggb3B0aW9ucyA9PT0gImluc3RhbmNlIiApIHsKCQkJCQlyZXR1cm5WYWx1ZSA9IGluc3RhbmNlOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJCWlmICggIWluc3RhbmNlICkgewoJCQkJCXJldHVybiAkLmVycm9yKCAiY2Fubm90IGNhbGwgbWV0aG9kcyBvbiAiICsgbmFtZSArICIgcHJpb3IgdG8gaW5pdGlhbGl6YXRpb247ICIgKwoJCQkJCQkiYXR0ZW1wdGVkIHRvIGNhbGwgbWV0aG9kICciICsgb3B0aW9ucyArICInIiApOwoJCQkJfQoJCQkJaWYgKCAhJC5pc0Z1bmN0aW9uKCBpbnN0YW5jZVtvcHRpb25zXSApIHx8IG9wdGlvbnMuY2hhckF0KCAwICkgPT09ICJfIiApIHsKCQkJCQlyZXR1cm4gJC5lcnJvciggIm5vIHN1Y2ggbWV0aG9kICciICsgb3B0aW9ucyArICInIGZvciAiICsgbmFtZSArICIgd2lkZ2V0IGluc3RhbmNlIiApOwoJCQkJfQoJCQkJbWV0aG9kVmFsdWUgPSBpbnN0YW5jZVsgb3B0aW9ucyBdLmFwcGx5KCBpbnN0YW5jZSwgYXJncyApOwoJCQkJaWYgKCBtZXRob2RWYWx1ZSAhPT0gaW5zdGFuY2UgJiYgbWV0aG9kVmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm5WYWx1ZSA9IG1ldGhvZFZhbHVlICYmIG1ldGhvZFZhbHVlLmpxdWVyeSA/CgkJCQkJCXJldHVyblZhbHVlLnB1c2hTdGFjayggbWV0aG9kVmFsdWUuZ2V0KCkgKSA6CgkJCQkJCW1ldGhvZFZhbHVlOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSApOwoJCQkJaWYgKCBpbnN0YW5jZSApIHsKCQkJCQlpbnN0YW5jZS5vcHRpb24oIG9wdGlvbnMgfHwge30gKS5faW5pdCgpOwoJCQkJfSBlbHNlIHsKCQkJCQkkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lLCBuZXcgb2JqZWN0KCBvcHRpb25zLCB0aGlzICkgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9Owp9OwoKJC5XaWRnZXQgPSBmdW5jdGlvbiggLyogb3B0aW9ucywgZWxlbWVudCAqLyApIHt9OwokLldpZGdldC5fY2hpbGRDb25zdHJ1Y3RvcnMgPSBbXTsKCiQuV2lkZ2V0LnByb3RvdHlwZSA9IHsKCXdpZGdldE5hbWU6ICJ3aWRnZXQiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICIiLAoJZGVmYXVsdEVsZW1lbnQ6ICI8ZGl2PiIsCglvcHRpb25zOiB7CgkJZGlzYWJsZWQ6IGZhbHNlLAoKCQkvLyBjYWxsYmFja3MKCQljcmVhdGU6IG51bGwKCX0sCglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQllbGVtZW50ID0gJCggZWxlbWVudCB8fCB0aGlzLmRlZmF1bHRFbGVtZW50IHx8IHRoaXMgKVsgMCBdOwoJCXRoaXMuZWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQl0aGlzLnV1aWQgPSB1dWlkKys7CgkJdGhpcy5ldmVudE5hbWVzcGFjZSA9ICIuIiArIHRoaXMud2lkZ2V0TmFtZSArIHRoaXMudXVpZDsKCQl0aGlzLm9wdGlvbnMgPSAkLndpZGdldC5leHRlbmQoIHt9LAoJCQl0aGlzLm9wdGlvbnMsCgkJCXRoaXMuX2dldENyZWF0ZU9wdGlvbnMoKSwKCQkJb3B0aW9ucyApOwoKCQl0aGlzLmJpbmRpbmdzID0gJCgpOwoJCXRoaXMuaG92ZXJhYmxlID0gJCgpOwoJCXRoaXMuZm9jdXNhYmxlID0gJCgpOwoKCQlpZiAoIGVsZW1lbnQgIT09IHRoaXMgKSB7CgkJCSQuZGF0YSggZWxlbWVudCwgdGhpcy53aWRnZXRGdWxsTmFtZSwgdGhpcyApOwoJCQl0aGlzLl9vbiggdHJ1ZSwgdGhpcy5lbGVtZW50LCB7CgkJCQlyZW1vdmU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpZiAoIGV2ZW50LnRhcmdldCA9PT0gZWxlbWVudCApIHsKCQkJCQkJdGhpcy5kZXN0cm95KCk7CgkJCQkJfQoJCQkJfQoJCQl9KTsKCQkJdGhpcy5kb2N1bWVudCA9ICQoIGVsZW1lbnQuc3R5bGUgPwoJCQkJLy8gZWxlbWVudCB3aXRoaW4gdGhlIGRvY3VtZW50CgkJCQllbGVtZW50Lm93bmVyRG9jdW1lbnQgOgoJCQkJLy8gZWxlbWVudCBpcyB3aW5kb3cgb3IgZG9jdW1lbnQKCQkJCWVsZW1lbnQuZG9jdW1lbnQgfHwgZWxlbWVudCApOwoJCQl0aGlzLndpbmRvdyA9ICQoIHRoaXMuZG9jdW1lbnRbMF0uZGVmYXVsdFZpZXcgfHwgdGhpcy5kb2N1bWVudFswXS5wYXJlbnRXaW5kb3cgKTsKCQl9CgoJCXRoaXMuX2NyZWF0ZSgpOwoJCXRoaXMuX3RyaWdnZXIoICJjcmVhdGUiLCBudWxsLCB0aGlzLl9nZXRDcmVhdGVFdmVudERhdGEoKSApOwoJCXRoaXMuX2luaXQoKTsKCX0sCglfZ2V0Q3JlYXRlT3B0aW9uczogJC5ub29wLAoJX2dldENyZWF0ZUV2ZW50RGF0YTogJC5ub29wLAoJX2NyZWF0ZTogJC5ub29wLAoJX2luaXQ6ICQubm9vcCwKCglkZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9kZXN0cm95KCk7CgkJLy8gd2UgY2FuIHByb2JhYmx5IHJlbW92ZSB0aGUgdW5iaW5kIGNhbGxzIGluIDIuMAoJCS8vIGFsbCBldmVudCBiaW5kaW5ncyBzaG91bGQgZ28gdGhyb3VnaCB0aGlzLl9vbigpCgkJdGhpcy5lbGVtZW50CgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkucmVtb3ZlRGF0YSggdGhpcy53aWRnZXRGdWxsTmFtZSApCgkJCS8vIHN1cHBvcnQ6IGpxdWVyeSA8MS42LjMKCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvOTQxMwoJCQkucmVtb3ZlRGF0YSggJC5jYW1lbENhc2UoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKSApOwoJCXRoaXMud2lkZ2V0KCkKCQkJLnVuYmluZCggdGhpcy5ldmVudE5hbWVzcGFjZSApCgkJCS5yZW1vdmVBdHRyKCAiYXJpYS1kaXNhYmxlZCIgKQoJCQkucmVtb3ZlQ2xhc3MoCgkJCQl0aGlzLndpZGdldEZ1bGxOYW1lICsgIi1kaXNhYmxlZCAiICsKCQkJCSJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCgkJLy8gY2xlYW4gdXAgZXZlbnRzIGFuZCBzdGF0ZXMKCQl0aGlzLmJpbmRpbmdzLnVuYmluZCggdGhpcy5ldmVudE5hbWVzcGFjZSApOwoJCXRoaXMuaG92ZXJhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJdGhpcy5mb2N1c2FibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCX0sCglfZGVzdHJveTogJC5ub29wLAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCX0sCgoJb3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgb3B0aW9ucyA9IGtleSwKCQkJcGFydHMsCgkJCWN1ck9wdGlvbiwKCQkJaTsKCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAwICkgewoJCQkvLyBkb24ndCByZXR1cm4gYSByZWZlcmVuY2UgdG8gdGhlIGludGVybmFsIGhhc2gKCQkJcmV0dXJuICQud2lkZ2V0LmV4dGVuZCgge30sIHRoaXMub3B0aW9ucyApOwoJCX0KCgkJaWYgKCB0eXBlb2Yga2V5ID09PSAic3RyaW5nIiApIHsKCQkJLy8gaGFuZGxlIG5lc3RlZCBrZXlzLCBlLmcuLCAiZm9vLmJhciIgPT4geyBmb286IHsgYmFyOiBfX18gfSB9CgkJCW9wdGlvbnMgPSB7fTsKCQkJcGFydHMgPSBrZXkuc3BsaXQoICIuIiApOwoJCQlrZXkgPSBwYXJ0cy5zaGlmdCgpOwoJCQlpZiAoIHBhcnRzLmxlbmd0aCApIHsKCQkJCWN1ck9wdGlvbiA9IG9wdGlvbnNbIGtleSBdID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zWyBrZXkgXSApOwoJCQkJZm9yICggaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGggLSAxOyBpKysgKSB7CgkJCQkJY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF0gPSBjdXJPcHRpb25bIHBhcnRzWyBpIF0gXSB8fCB7fTsKCQkJCQljdXJPcHRpb24gPSBjdXJPcHRpb25bIHBhcnRzWyBpIF0gXTsKCQkJCX0KCQkJCWtleSA9IHBhcnRzLnBvcCgpOwoJCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVybiBjdXJPcHRpb25bIGtleSBdID09PSB1bmRlZmluZWQgPyBudWxsIDogY3VyT3B0aW9uWyBrZXkgXTsKCQkJCX0KCQkJCWN1ck9wdGlvblsga2V5IF0gPSB2YWx1ZTsKCQkJfSBlbHNlIHsKCQkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gdGhpcy5vcHRpb25zWyBrZXkgXSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IHRoaXMub3B0aW9uc1sga2V5IF07CgkJCQl9CgkJCQlvcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoJCQl9CgkJfQoKCQl0aGlzLl9zZXRPcHRpb25zKCBvcHRpb25zICk7CgoJCXJldHVybiB0aGlzOwoJfSwKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIga2V5OwoKCQlmb3IgKCBrZXkgaW4gb3B0aW9ucyApIHsKCQkJdGhpcy5fc2V0T3B0aW9uKCBrZXksIG9wdGlvbnNbIGtleSBdICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl0aGlzLm9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgoJCWlmICgga2V5ID09PSAiZGlzYWJsZWQiICkgewoJCQl0aGlzLndpZGdldCgpCgkJCQkudG9nZ2xlQ2xhc3MoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKyAiLWRpc2FibGVkIiwgISF2YWx1ZSApOwoJCQl0aGlzLmhvdmVyYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl0aGlzLmZvY3VzYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbnMoeyBkaXNhYmxlZDogZmFsc2UgfSk7Cgl9LAoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbnMoeyBkaXNhYmxlZDogdHJ1ZSB9KTsKCX0sCgoJX29uOiBmdW5jdGlvbiggc3VwcHJlc3NEaXNhYmxlZENoZWNrLCBlbGVtZW50LCBoYW5kbGVycyApIHsKCQl2YXIgZGVsZWdhdGVFbGVtZW50LAoJCQlpbnN0YW5jZSA9IHRoaXM7CgoJCS8vIG5vIHN1cHByZXNzRGlzYWJsZWRDaGVjayBmbGFnLCBzaHVmZmxlIGFyZ3VtZW50cwoJCWlmICggdHlwZW9mIHN1cHByZXNzRGlzYWJsZWRDaGVjayAhPT0gImJvb2xlYW4iICkgewoJCQloYW5kbGVycyA9IGVsZW1lbnQ7CgkJCWVsZW1lbnQgPSBzdXBwcmVzc0Rpc2FibGVkQ2hlY2s7CgkJCXN1cHByZXNzRGlzYWJsZWRDaGVjayA9IGZhbHNlOwoJCX0KCgkJLy8gbm8gZWxlbWVudCBhcmd1bWVudCwgc2h1ZmZsZSBhbmQgdXNlIHRoaXMuZWxlbWVudAoJCWlmICggIWhhbmRsZXJzICkgewoJCQloYW5kbGVycyA9IGVsZW1lbnQ7CgkJCWVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CgkJCWRlbGVnYXRlRWxlbWVudCA9IHRoaXMud2lkZ2V0KCk7CgkJfSBlbHNlIHsKCQkJLy8gYWNjZXB0IHNlbGVjdG9ycywgRE9NIGVsZW1lbnRzCgkJCWVsZW1lbnQgPSBkZWxlZ2F0ZUVsZW1lbnQgPSAkKCBlbGVtZW50ICk7CgkJCXRoaXMuYmluZGluZ3MgPSB0aGlzLmJpbmRpbmdzLmFkZCggZWxlbWVudCApOwoJCX0KCgkJJC5lYWNoKCBoYW5kbGVycywgZnVuY3Rpb24oIGV2ZW50LCBoYW5kbGVyICkgewoJCQlmdW5jdGlvbiBoYW5kbGVyUHJveHkoKSB7CgkJCQkvLyBhbGxvdyB3aWRnZXRzIHRvIGN1c3RvbWl6ZSB0aGUgZGlzYWJsZWQgaGFuZGxpbmcKCQkJCS8vIC0gZGlzYWJsZWQgYXMgYW4gYXJyYXkgaW5zdGVhZCBvZiBib29sZWFuCgkJCQkvLyAtIGRpc2FibGVkIGNsYXNzIGFzIG1ldGhvZCBmb3IgZGlzYWJsaW5nIGluZGl2aWR1YWwgcGFydHMKCQkJCWlmICggIXN1cHByZXNzRGlzYWJsZWRDaGVjayAmJgoJCQkJCQkoIGluc3RhbmNlLm9wdGlvbnMuZGlzYWJsZWQgPT09IHRydWUgfHwKCQkJCQkJCSQoIHRoaXMgKS5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJcmV0dXJuICggdHlwZW9mIGhhbmRsZXIgPT09ICJzdHJpbmciID8gaW5zdGFuY2VbIGhhbmRsZXIgXSA6IGhhbmRsZXIgKQoJCQkJCS5hcHBseSggaW5zdGFuY2UsIGFyZ3VtZW50cyApOwoJCQl9CgoJCQkvLyBjb3B5IHRoZSBndWlkIHNvIGRpcmVjdCB1bmJpbmRpbmcgd29ya3MKCQkJaWYgKCB0eXBlb2YgaGFuZGxlciAhPT0gInN0cmluZyIgKSB7CgkJCQloYW5kbGVyUHJveHkuZ3VpZCA9IGhhbmRsZXIuZ3VpZCA9CgkJCQkJaGFuZGxlci5ndWlkIHx8IGhhbmRsZXJQcm94eS5ndWlkIHx8ICQuZ3VpZCsrOwoJCQl9CgoJCQl2YXIgbWF0Y2ggPSBldmVudC5tYXRjaCggL14oXHcrKVxzKiguKikkLyApLAoJCQkJZXZlbnROYW1lID0gbWF0Y2hbMV0gKyBpbnN0YW5jZS5ldmVudE5hbWVzcGFjZSwKCQkJCXNlbGVjdG9yID0gbWF0Y2hbMl07CgkJCWlmICggc2VsZWN0b3IgKSB7CgkJCQlkZWxlZ2F0ZUVsZW1lbnQuZGVsZWdhdGUoIHNlbGVjdG9yLCBldmVudE5hbWUsIGhhbmRsZXJQcm94eSApOwoJCQl9IGVsc2UgewoJCQkJZWxlbWVudC5iaW5kKCBldmVudE5hbWUsIGhhbmRsZXJQcm94eSApOwoJCQl9CgkJfSk7Cgl9LAoKCV9vZmY6IGZ1bmN0aW9uKCBlbGVtZW50LCBldmVudE5hbWUgKSB7CgkJZXZlbnROYW1lID0gKGV2ZW50TmFtZSB8fCAiIikuc3BsaXQoICIgIiApLmpvaW4oIHRoaXMuZXZlbnROYW1lc3BhY2UgKyAiICIgKSArIHRoaXMuZXZlbnROYW1lc3BhY2U7CgkJZWxlbWVudC51bmJpbmQoIGV2ZW50TmFtZSApLnVuZGVsZWdhdGUoIGV2ZW50TmFtZSApOwoJfSwKCglfZGVsYXk6IGZ1bmN0aW9uKCBoYW5kbGVyLCBkZWxheSApIHsKCQlmdW5jdGlvbiBoYW5kbGVyUHJveHkoKSB7CgkJCXJldHVybiAoIHR5cGVvZiBoYW5kbGVyID09PSAic3RyaW5nIiA/IGluc3RhbmNlWyBoYW5kbGVyIF0gOiBoYW5kbGVyICkKCQkJCS5hcHBseSggaW5zdGFuY2UsIGFyZ3VtZW50cyApOwoJCX0KCQl2YXIgaW5zdGFuY2UgPSB0aGlzOwoJCXJldHVybiBzZXRUaW1lb3V0KCBoYW5kbGVyUHJveHksIGRlbGF5IHx8IDAgKTsKCX0sCgoJX2hvdmVyYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdGhpcy5ob3ZlcmFibGUgPSB0aGlzLmhvdmVyYWJsZS5hZGQoIGVsZW1lbnQgKTsKCQl0aGlzLl9vbiggZWxlbWVudCwgewoJCQltb3VzZWVudGVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJfSwKCQkJbW91c2VsZWF2ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJCX0KCQl9KTsKCX0sCgoJX2ZvY3VzYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdGhpcy5mb2N1c2FibGUgPSB0aGlzLmZvY3VzYWJsZS5hZGQoIGVsZW1lbnQgKTsKCQl0aGlzLl9vbiggZWxlbWVudCwgewoJCQlmb2N1c2luOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQkJfSwKCQkJZm9jdXNvdXQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCQl9CgkJfSk7Cgl9LAoKCV90cmlnZ2VyOiBmdW5jdGlvbiggdHlwZSwgZXZlbnQsIGRhdGEgKSB7CgkJdmFyIHByb3AsIG9yaWcsCgkJCWNhbGxiYWNrID0gdGhpcy5vcHRpb25zWyB0eXBlIF07CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoJCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCQlldmVudC50eXBlID0gKCB0eXBlID09PSB0aGlzLndpZGdldEV2ZW50UHJlZml4ID8KCQkJdHlwZSA6CgkJCXRoaXMud2lkZ2V0RXZlbnRQcmVmaXggKyB0eXBlICkudG9Mb3dlckNhc2UoKTsKCQkvLyB0aGUgb3JpZ2luYWwgZXZlbnQgbWF5IGNvbWUgZnJvbSBhbnkgZWxlbWVudAoJCS8vIHNvIHdlIG5lZWQgdG8gcmVzZXQgdGhlIHRhcmdldCBvbiB0aGUgbmV3IGV2ZW50CgkJZXZlbnQudGFyZ2V0ID0gdGhpcy5lbGVtZW50WyAwIF07CgoJCS8vIGNvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCQlvcmlnID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCQlpZiAoIG9yaWcgKSB7CgkJCWZvciAoIHByb3AgaW4gb3JpZyApIHsKCQkJCWlmICggISggcHJvcCBpbiBldmVudCApICkgewoJCQkJCWV2ZW50WyBwcm9wIF0gPSBvcmlnWyBwcm9wIF07CgkJCQl9CgkJCX0KCQl9CgoJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBldmVudCwgZGF0YSApOwoJCXJldHVybiAhKCAkLmlzRnVuY3Rpb24oIGNhbGxiYWNrICkgJiYKCQkJY2FsbGJhY2suYXBwbHkoIHRoaXMuZWxlbWVudFswXSwgWyBldmVudCBdLmNvbmNhdCggZGF0YSApICkgPT09IGZhbHNlIHx8CgkJCWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICk7Cgl9Cn07CgokLmVhY2goIHsgc2hvdzogImZhZGVJbiIsIGhpZGU6ICJmYWRlT3V0IiB9LCBmdW5jdGlvbiggbWV0aG9kLCBkZWZhdWx0RWZmZWN0ICkgewoJJC5XaWRnZXQucHJvdG90eXBlWyAiXyIgKyBtZXRob2QgXSA9IGZ1bmN0aW9uKCBlbGVtZW50LCBvcHRpb25zLCBjYWxsYmFjayApIHsKCQlpZiAoIHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiApIHsKCQkJb3B0aW9ucyA9IHsgZWZmZWN0OiBvcHRpb25zIH07CgkJfQoJCXZhciBoYXNPcHRpb25zLAoJCQllZmZlY3ROYW1lID0gIW9wdGlvbnMgPwoJCQkJbWV0aG9kIDoKCQkJCW9wdGlvbnMgPT09IHRydWUgfHwgdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiID8KCQkJCQlkZWZhdWx0RWZmZWN0IDoKCQkJCQlvcHRpb25zLmVmZmVjdCB8fCBkZWZhdWx0RWZmZWN0OwoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiICkgewoJCQlvcHRpb25zID0geyBkdXJhdGlvbjogb3B0aW9ucyB9OwoJCX0KCQloYXNPcHRpb25zID0gISQuaXNFbXB0eU9iamVjdCggb3B0aW9ucyApOwoJCW9wdGlvbnMuY29tcGxldGUgPSBjYWxsYmFjazsKCQlpZiAoIG9wdGlvbnMuZGVsYXkgKSB7CgkJCWVsZW1lbnQuZGVsYXkoIG9wdGlvbnMuZGVsYXkgKTsKCQl9CgkJaWYgKCBoYXNPcHRpb25zICYmICQuZWZmZWN0cyAmJiAkLmVmZmVjdHMuZWZmZWN0WyBlZmZlY3ROYW1lIF0gKSB7CgkJCWVsZW1lbnRbIG1ldGhvZCBdKCBvcHRpb25zICk7CgkJfSBlbHNlIGlmICggZWZmZWN0TmFtZSAhPT0gbWV0aG9kICYmIGVsZW1lbnRbIGVmZmVjdE5hbWUgXSApIHsKCQkJZWxlbWVudFsgZWZmZWN0TmFtZSBdKCBvcHRpb25zLmR1cmF0aW9uLCBvcHRpb25zLmVhc2luZywgY2FsbGJhY2sgKTsKCQl9IGVsc2UgewoJCQllbGVtZW50LnF1ZXVlKGZ1bmN0aW9uKCBuZXh0ICkgewoJCQkJJCggdGhpcyApWyBtZXRob2QgXSgpOwoJCQkJaWYgKCBjYWxsYmFjayApIHsKCQkJCQljYWxsYmFjay5jYWxsKCBlbGVtZW50WyAwIF0gKTsKCQkJCX0KCQkJCW5leHQoKTsKCQkJfSk7CgkJfQoJfTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciByY2FwaXRhbHMgPSAvW0EtWl0vZywKCXJlcGxhY2VGdW5jdGlvbiA9IGZ1bmN0aW9uKCBjICkgewoJCXJldHVybiAiLSIgKyBjLnRvTG93ZXJDYXNlKCk7Cgl9OwoKJC5leHRlbmQoICQuV2lkZ2V0LnByb3RvdHlwZSwgewoJX2dldENyZWF0ZU9wdGlvbnM6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb24sIHZhbHVlLAoJCQllbGVtID0gdGhpcy5lbGVtZW50WyAwIF0sCgkJCW9wdGlvbnMgPSB7fTsKCgkJLy8KCQlpZiAoICEkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIGVsZW0sICJkZWZhdWx0cyIgKSApIHsKCQkJZm9yICggb3B0aW9uIGluIHRoaXMub3B0aW9ucyApIHsKCQkJCXZhbHVlID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCBlbGVtLCBvcHRpb24ucmVwbGFjZSggcmNhcGl0YWxzLCByZXBsYWNlRnVuY3Rpb24gKSApOwoKCQkJCWlmICggdmFsdWUgIT0gbnVsbCApIHsKCQkJCQlvcHRpb25zWyBvcHRpb24gXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gb3B0aW9uczsKCX0KfSk7CgovL1RPRE86IFJlbW92ZSBpbiAxLjUgZm9yIGJhY2tjb21wYXQgb25seQokLm1vYmlsZS53aWRnZXQgPSAkLldpZGdldDsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQgKSB7CgkvLyBUT0RPIG1vdmUgbG9hZGVyIGNsYXNzIGRvd24gaW50byB0aGUgd2lkZ2V0IHNldHRpbmdzCgl2YXIgbG9hZGVyQ2xhc3MgPSAidWktbG9hZGVyIiwgJGh0bWwgPSAkKCAiaHRtbCIgKTsKCgkkLndpZGdldCggIm1vYmlsZS5sb2FkZXIiLCB7CgkJLy8gTk9URSBpZiB0aGUgZ2xvYmFsIGNvbmZpZyBzZXR0aW5ncyBhcmUgZGVmaW5lZCB0aGV5IHdpbGwgb3ZlcnJpZGUgdGhlc2UKCQkvLyAgICAgIG9wdGlvbnMKCQlvcHRpb25zOiB7CgkJCS8vIHRoZSB0aGVtZSBmb3IgdGhlIGxvYWRpbmcgbWVzc2FnZQoJCQl0aGVtZTogImEiLAoKCQkJLy8gd2hldGhlciB0aGUgdGV4dCBpbiB0aGUgbG9hZGluZyBtZXNzYWdlIGlzIHNob3duCgkJCXRleHRWaXNpYmxlOiBmYWxzZSwKCgkJCS8vIGN1c3RvbSBodG1sIGZvciB0aGUgaW5uZXIgY29udGVudCBvZiB0aGUgbG9hZGluZyBtZXNzYWdlCgkJCWh0bWw6ICIiLAoKCQkJLy8gdGhlIHRleHQgdG8gYmUgZGlzcGxheWVkIHdoZW4gdGhlIHBvcHVwIGlzIHNob3duCgkJCXRleHQ6ICJsb2FkaW5nIgoJCX0sCgoJCWRlZmF1bHRIdG1sOiAiPGRpdiBjbGFzcz0nIiArIGxvYWRlckNsYXNzICsgIic+IiArCgkJCSI8c3BhbiBjbGFzcz0ndWktaWNvbi1sb2FkaW5nJz48L3NwYW4+IiArCgkJCSI8aDE+PC9oMT4iICsKCQkJIjwvZGl2PiIsCgoJCS8vIEZvciBub24tZml4ZWQgc3VwcG9ydGluIGJyb3dzZXJzLiBQb3NpdGlvbiBhdCB5IGNlbnRlciAoaWYgc2Nyb2xsVG9wIHN1cHBvcnRlZCksIGFib3ZlIHRoZSBhY3RpdmVCdG4gKGlmIGRlZmluZWQpLCBvciBqdXN0IDEwMHB4IGZyb20gdG9wCgkJZmFrZUZpeExvYWRlcjogZnVuY3Rpb24oKSB7CgkJCXZhciBhY3RpdmVCdG4gPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApLmZpcnN0KCk7CgoJCQl0aGlzLmVsZW1lbnQKCQkJCS5jc3MoewoJCQkJCXRvcDogJC5zdXBwb3J0LnNjcm9sbFRvcCAmJiB0aGlzLndpbmRvdy5zY3JvbGxUb3AoKSArIHRoaXMud2luZG93LmhlaWdodCgpIC8gMiB8fAoJCQkJCQlhY3RpdmVCdG4ubGVuZ3RoICYmIGFjdGl2ZUJ0bi5vZmZzZXQoKS50b3AgfHwgMTAwCgkJCQl9KTsKCQl9LAoKCQkvLyBjaGVjayBwb3NpdGlvbiBvZiBsb2FkZXIgdG8gc2VlIGlmIGl0IGFwcGVhcnMgdG8gYmUgImZpeGVkIiB0byBjZW50ZXIKCQkvLyBpZiBub3QsIHVzZSBhYnMgcG9zaXRpb25pbmcKCQljaGVja0xvYWRlclBvc2l0aW9uOiBmdW5jdGlvbigpIHsKCQkJdmFyIG9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKSwKCQkJCXNjcm9sbFRvcCA9IHRoaXMud2luZG93LnNjcm9sbFRvcCgpLAoJCQkJc2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCQlpZiAoIG9mZnNldC50b3AgPCBzY3JvbGxUb3AgfHwgKCBvZmZzZXQudG9wIC0gc2Nyb2xsVG9wICkgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1sb2FkZXItZmFrZWZpeCIgKTsKCQkJCXRoaXMuZmFrZUZpeExvYWRlcigpOwoJCQkJdGhpcy53aW5kb3cKCQkJCQkudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uICkKCQkJCQkuYmluZCggInNjcm9sbCIsICQucHJveHkoIHRoaXMuZmFrZUZpeExvYWRlciwgdGhpcyApICk7CgkJCX0KCQl9LAoKCQlyZXNldEh0bWw6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuaHRtbCggJCggdGhpcy5kZWZhdWx0SHRtbCApLmh0bWwoKSApOwoJCX0sCgoJCS8vIFR1cm4gb24vb2ZmIHBhZ2UgbG9hZGluZyBtZXNzYWdlLiBUaGVtZSBkb3VibGVzIGFzIGFuIG9iamVjdCBhcmd1bWVudAoJCS8vIHdpdGggdGhlIGZvbGxvd2luZyBzaGFwZTogeyB0aGVtZTogJycsIHRleHQ6ICcnLCBodG1sOiAnJywgdGV4dFZpc2libGU6ICcnIH0KCQkvLyBOT1RFIHRoYXQgdGhlICQubW9iaWxlLmxvYWRpbmcqIHNldHRpbmdzIGFuZCBwYXJhbXMgcGFzdCB0aGUgZmlyc3QgYXJlIGRlcHJlY2F0ZWQKCQkvLyBUT0RPIHN3ZWV0IGplc3VzIHdlIG5lZWQgdG8gYnJlYWsgc29tZSBvZiB0aGlzIG91dAoJCXNob3c6IGZ1bmN0aW9uKCB0aGVtZSwgbXNnVGV4dCwgdGV4dG9ubHkgKSB7CgkJCXZhciB0ZXh0VmlzaWJsZSwgbWVzc2FnZSwgbG9hZFNldHRpbmdzOwoKCQkJdGhpcy5yZXNldEh0bWwoKTsKCgkJCS8vIHVzZSB0aGUgcHJvdG90eXBlIG9wdGlvbnMgc28gdGhhdCBwZW9wbGUgY2FuIHNldCB0aGVtIGdsb2JhbGx5IGF0CgkJCS8vIG1vYmlsZSBpbml0LiBDb25zaXN0ZW5jeSwgaXQncyB3aGF0J3MgZm9yIGRpbm5lcgoJCQlpZiAoICQudHlwZSggdGhlbWUgKSA9PT0gIm9iamVjdCIgKSB7CgkJCQlsb2FkU2V0dGluZ3MgPSAkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucywgdGhlbWUgKTsKCgkJCQl0aGVtZSA9IGxvYWRTZXR0aW5ncy50aGVtZTsKCQkJfSBlbHNlIHsKCQkJCWxvYWRTZXR0aW5ncyA9IHRoaXMub3B0aW9uczsKCgkJCQkvLyBoZXJlIHdlIHByZWZlciB0aGUgdGhlbWUgdmFsdWUgcGFzc2VkIGFzIGEgc3RyaW5nIGFyZ3VtZW50LCB0aGVuCgkJCQkvLyB3ZSBwcmVmZXIgdGhlIGdsb2JhbCBvcHRpb24gYmVjYXVzZSB3ZSBjYW4ndCB1c2UgdW5kZWZpbmVkIGRlZmF1bHQKCQkJCS8vIHByb3RvdHlwZSBvcHRpb25zLCB0aGVuIHRoZSBwcm90b3R5cGUgb3B0aW9uCgkJCQl0aGVtZSA9IHRoZW1lIHx8IGxvYWRTZXR0aW5ncy50aGVtZTsKCQkJfQoKCQkJLy8gc2V0IHRoZSBtZXNzYWdlIHRleHQsIHByZWZlciB0aGUgcGFyYW0sIHRoZW4gdGhlIHNldHRpbmdzIG9iamVjdAoJCQkvLyB0aGVuIGxvYWRpbmcgbWVzc2FnZQoJCQltZXNzYWdlID0gbXNnVGV4dCB8fCAoIGxvYWRTZXR0aW5ncy50ZXh0ID09PSBmYWxzZSA/ICIiIDogbG9hZFNldHRpbmdzLnRleHQgKTsKCgkJCS8vIHByZXBhcmUgdGhlIGRvbQoJCQkkaHRtbC5hZGRDbGFzcyggInVpLWxvYWRpbmciICk7CgoJCQl0ZXh0VmlzaWJsZSA9IGxvYWRTZXR0aW5ncy50ZXh0VmlzaWJsZTsKCgkJCS8vIGFkZCB0aGUgcHJvcGVyIGNzcyBnaXZlbiB0aGUgb3B0aW9ucyAodGhlbWUsIHRleHQsIGV0YykKCQkJLy8gRm9yY2UgdGV4dCB2aXNpYmlsaXR5IGlmIHRoZSBzZWNvbmQgYXJndW1lbnQgd2FzIHN1cHBsaWVkLCBvcgoJCQkvLyBpZiB0aGUgdGV4dCB3YXMgZXhwbGljaXRseSBzZXQgaW4gdGhlIG9iamVjdCBhcmdzCgkJCXRoaXMuZWxlbWVudC5hdHRyKCJjbGFzcyIsIGxvYWRlckNsYXNzICsKCQkJCSIgdWktY29ybmVyLWFsbCB1aS1ib2R5LSIgKyB0aGVtZSArCgkJCQkiIHVpLWxvYWRlci0iICsgKCB0ZXh0VmlzaWJsZSB8fCBtc2dUZXh0IHx8IHRoZW1lLnRleHQgPyAidmVyYm9zZSIgOiAiZGVmYXVsdCIgKSArCgkJCQkoIGxvYWRTZXR0aW5ncy50ZXh0b25seSB8fCB0ZXh0b25seSA/ICIgdWktbG9hZGVyLXRleHRvbmx5IiA6ICIiICkgKTsKCgkJCS8vIFRPRE8gdmVyaWZ5IHRoYXQganF1ZXJ5LmZuLmh0bWwgaXMgb2sgdG8gdXNlIGluIGJvdGggY2FzZXMgaGVyZQoJCQkvLyAgICAgIHRoaXMgbWlnaHQgYmUgb3Zlcmx5IGRlZmVuc2l2ZSBpbiBwcmV2ZW50aW5nIHVua25vd2luZyB4c3MKCQkJLy8gaWYgdGhlIGh0bWwgYXR0cmlidXRlIGlzIGRlZmluZWQgb24gdGhlIGxvYWRpbmcgc2V0dGluZ3MsIHVzZSB0aGF0CgkJCS8vIG90aGVyd2lzZSB1c2UgdGhlIGZhbGxiYWNrcyBmcm9tIGFib3ZlCgkJCWlmICggbG9hZFNldHRpbmdzLmh0bWwgKSB7CgkJCQl0aGlzLmVsZW1lbnQuaHRtbCggbG9hZFNldHRpbmdzLmh0bWwgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiaDEiICkudGV4dCggbWVzc2FnZSApOwoJCQl9CgoJCQkvLyBhdHRhY2ggdGhlIGxvYWRlciB0byB0aGUgRE9NCgkJCXRoaXMuZWxlbWVudC5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJLy8gY2hlY2sgdGhhdCB0aGUgbG9hZGVyIGlzIHZpc2libGUKCQkJdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uKCk7CgoJCQkvLyBvbiBzY3JvbGwgY2hlY2sgdGhlIGxvYWRlciBwb3NpdGlvbgoJCQl0aGlzLndpbmRvdy5iaW5kKCAic2Nyb2xsIiwgJC5wcm94eSggdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uLCB0aGlzICkgKTsKCQl9LAoKCQloaWRlOiBmdW5jdGlvbigpIHsKCQkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoKCQkJaWYgKCB0aGlzLm9wdGlvbnMudGV4dCApIHsKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWxvYWRlci1mYWtlZml4IiApOwoJCQl9CgoJCQkkLm1vYmlsZS53aW5kb3cudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5mYWtlRml4TG9hZGVyICk7CgkJCSQubW9iaWxlLndpbmRvdy51bmJpbmQoICJzY3JvbGwiLCB0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24gKTsKCQl9Cgl9KTsKCn0pKGpRdWVyeSwgdGhpcyk7CgoKLy8gU2NyaXB0OiBqUXVlcnkgaGFzaGNoYW5nZSBldmVudAovLyAKLy8gKlZlcnNpb246IDEuMywgTGFzdCB1cGRhdGVkOiA3LzIxLzIwMTAqCi8vIAovLyBQcm9qZWN0IEhvbWUgLSBodHRwOi8vYmVuYWxtYW4uY29tL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlLXBsdWdpbi8KLy8gR2l0SHViICAgICAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlLwovLyBTb3VyY2UgICAgICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5qcwovLyAoTWluaWZpZWQpICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5taW4uanMgKDAuOGtiIGd6aXBwZWQpCi8vIAovLyBBYm91dDogTGljZW5zZQovLyAKLy8gQ29weXJpZ2h0IChjKSAyMDEwICJDb3dib3kiIEJlbiBBbG1hbiwKLy8gRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXMuCi8vIGh0dHA6Ly9iZW5hbG1hbi5jb20vYWJvdXQvbGljZW5zZS8KLy8gCi8vIEFib3V0OiBFeGFtcGxlcwovLyAKLy8gVGhlc2Ugd29ya2luZyBleGFtcGxlcywgY29tcGxldGUgd2l0aCBmdWxseSBjb21tZW50ZWQgY29kZSwgaWxsdXN0cmF0ZSBhIGZldwovLyB3YXlzIGluIHdoaWNoIHRoaXMgcGx1Z2luIGNhbiBiZSB1c2VkLgovLyAKLy8gaGFzaGNoYW5nZSBldmVudCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9oYXNoY2hhbmdlLwovLyBkb2N1bWVudC5kb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvZG9jdW1lbnRfZG9tYWluLwovLyAKLy8gQWJvdXQ6IFN1cHBvcnQgYW5kIFRlc3RpbmcKLy8gCi8vIEluZm9ybWF0aW9uIGFib3V0IHdoYXQgdmVyc2lvbiBvciB2ZXJzaW9ucyBvZiBqUXVlcnkgdGhpcyBwbHVnaW4gaGFzIGJlZW4KLy8gdGVzdGVkIHdpdGgsIHdoYXQgYnJvd3NlcnMgaXQgaGFzIGJlZW4gdGVzdGVkIGluLCBhbmQgd2hlcmUgdGhlIHVuaXQgdGVzdHMKLy8gcmVzaWRlIChzbyB5b3UgY2FuIHRlc3QgaXQgeW91cnNlbGYpLgovLyAKLy8galF1ZXJ5IFZlcnNpb25zIC0gMS4yLjYsIDEuMy4yLCAxLjQuMSwgMS40LjIKLy8gQnJvd3NlcnMgVGVzdGVkIC0gSW50ZXJuZXQgRXhwbG9yZXIgNi04LCBGaXJlZm94IDItNCwgQ2hyb21lIDUtNiwgU2FmYXJpIDMuMi01LAovLyAgICAgICAgICAgICAgICAgICBPcGVyYSA5LjYtMTAuNjAsIGlQaG9uZSAzLjEsIEFuZHJvaWQgMS42LTIuMiwgQmxhY2tCZXJyeSA0LjYtNS4KLy8gVW5pdCBUZXN0cyAgICAgIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL3VuaXQvCi8vIAovLyBBYm91dDogS25vd24gaXNzdWVzCi8vIAovLyBXaGlsZSB0aGlzIGpRdWVyeSBoYXNoY2hhbmdlIGV2ZW50IGltcGxlbWVudGF0aW9uIGlzIHF1aXRlIHN0YWJsZSBhbmQKLy8gcm9idXN0LCB0aGVyZSBhcmUgYSBmZXcgdW5mb3J0dW5hdGUgYnJvd3NlciBidWdzIHN1cnJvdW5kaW5nIGV4cGVjdGVkCi8vIGhhc2hjaGFuZ2UgZXZlbnQtYmFzZWQgYmVoYXZpb3JzLCBpbmRlcGVuZGVudCBvZiBhbnkgSmF2YVNjcmlwdAovLyB3aW5kb3cub25oYXNoY2hhbmdlIGFic3RyYWN0aW9uLiBTZWUgdGhlIGZvbGxvd2luZyBleGFtcGxlcyBmb3IgbW9yZQovLyBpbmZvcm1hdGlvbjoKLy8gCi8vIENocm9tZTogQmFjayBCdXR0b24gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLWNocm9tZS1iYWNrLWJ1dHRvbi8KLy8gRmlyZWZveDogUmVtb3RlIFhNTEh0dHBSZXF1ZXN0IC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1maXJlZm94LXJlbW90ZS14aHIvCi8vIFdlYktpdDogQmFjayBCdXR0b24gaW4gYW4gSWZyYW1lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy13ZWJraXQtaGFzaC1pZnJhbWUvCi8vIFNhZmFyaTogQmFjayBCdXR0b24gZnJvbSBhIGRpZmZlcmVudCBkb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLXNhZmFyaS1iYWNrLWZyb20tZGlmZi1kb21haW4vCi8vIAovLyBBbHNvIG5vdGUgdGhhdCBzaG91bGQgYSBicm93c2VyIG5hdGl2ZWx5IHN1cHBvcnQgdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UgCi8vIGV2ZW50LCBidXQgbm90IHJlcG9ydCB0aGF0IGl0IGRvZXMsIHRoZSBmYWxsYmFjayBwb2xsaW5nIGxvb3Agd2lsbCBiZSB1c2VkLgovLyAKLy8gQWJvdXQ6IFJlbGVhc2UgSGlzdG9yeQovLyAKLy8gMS4zICAgLSAoNy8yMS8yMDEwKSBSZW9yZ2FuaXplZCBJRTYvNyBJZnJhbWUgY29kZSB0byBtYWtlIGl0IG1vcmUKLy8gICAgICAgICAicmVtb3ZhYmxlIiBmb3IgbW9iaWxlLW9ubHkgZGV2ZWxvcG1lbnQuIEFkZGVkIElFNi83IGRvY3VtZW50LnRpdGxlCi8vICAgICAgICAgc3VwcG9ydC4gQXR0ZW1wdGVkIHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZSBieSB1c2luZwovLyAgICAgICAgIHRlY2huaXF1ZXMgZnJvbSBodHRwOi8vd3d3LnBhY2llbGxvZ3JvdXAuY29tL2Jsb2cvP3A9NjA0LiBBZGRlZCAKLy8gICAgICAgICBzdXBwb3J0IGZvciB0aGUgInNob3J0Y3V0IiBmb3JtYXQgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoIGZuICkgYW5kCi8vICAgICAgICAgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBsaWtlIGpRdWVyeSBwcm92aWRlcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgovLyAgICAgICAgIFJlbmFtZWQgalF1ZXJ5Lmhhc2hjaGFuZ2VEZWxheSB0byA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IGFuZAovLyAgICAgICAgIGxvd2VyZWQgaXRzIGRlZmF1bHQgdmFsdWUgdG8gNTAuIEFkZGVkIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+Ci8vICAgICAgICAgYW5kIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmM+IHByb3BlcnRpZXMgcGx1cyBkb2N1bWVudC1kb21haW4uaHRtbAovLyAgICAgICAgIGZpbGUgdG8gYWRkcmVzcyBhY2Nlc3MgZGVuaWVkIGlzc3VlcyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGluCi8vICAgICAgICAgSUU2LzcuCi8vIDEuMiAgIC0gKDIvMTEvMjAxMCkgRml4ZWQgYSBidWcgd2hlcmUgY29taW5nIGJhY2sgdG8gYSBwYWdlIHVzaW5nIHRoaXMgcGx1Z2luCi8vICAgICAgICAgZnJvbSBhIHBhZ2Ugb24gYW5vdGhlciBkb21haW4gd291bGQgY2F1c2UgYW4gZXJyb3IgaW4gU2FmYXJpIDQuIEFsc28sCi8vICAgICAgICAgSUU2LzcgSWZyYW1lIGlzIG5vdyBpbnNlcnRlZCBhZnRlciB0aGUgYm9keSAodGhpcyBhY3R1YWxseSB3b3JrcyksCi8vICAgICAgICAgd2hpY2ggcHJldmVudHMgdGhlIHBhZ2UgZnJvbSBzY3JvbGxpbmcgd2hlbiB0aGUgZXZlbnQgaXMgZmlyc3QgYm91bmQuCi8vICAgICAgICAgRXZlbnQgY2FuIGFsc28gbm93IGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBpdCB3b24ndCBiZSB1c2FibGUKLy8gICAgICAgICBiZWZvcmUgdGhlbiBpbiBJRTYvNy4KLy8gMS4xICAgLSAoMS8yMS8yMDEwKSBJbmNvcnBvcmF0ZWQgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHRlc3QgdG8gZml4IElFOCBidWcKLy8gICAgICAgICB3aGVyZSBicm93c2VyIHZlcnNpb24gaXMgaW5jb3JyZWN0bHkgcmVwb3J0ZWQgYXMgOC4wLCBkZXNwaXRlCi8vICAgICAgICAgaW5jbHVzaW9uIG9mIHRoZSBYLVVBLUNvbXBhdGlibGUgSUU9RW11bGF0ZUlFNyBtZXRhIHRhZy4KLy8gMS4wICAgLSAoMS85LzIwMTApIEluaXRpYWwgUmVsZWFzZS4gQnJva2Ugb3V0IHRoZSBqUXVlcnkgQkJRIGV2ZW50LnNwZWNpYWwKLy8gICAgICAgICB3aW5kb3cub25oYXNoY2hhbmdlIGZ1bmN0aW9uYWxpdHkgaW50byBhIHNlcGFyYXRlIHBsdWdpbiBmb3IgdXNlcnMKLy8gICAgICAgICB3aG8gd2FudCBqdXN0IHRoZSBiYXNpYyBldmVudCAmIGJhY2sgYnV0dG9uIHN1cHBvcnQsIHdpdGhvdXQgYWxsIHRoZQovLyAgICAgICAgIGV4dHJhIGF3ZXNvbWVuZXNzIHRoYXQgQkJRIHByb3ZpZGVzLiBUaGlzIHBsdWdpbiB3aWxsIGJlIGluY2x1ZGVkIGFzCi8vICAgICAgICAgcGFydCBvZiBqUXVlcnkgQkJRLCBidXQgYWxzbyBiZSBhdmFpbGFibGUgc2VwYXJhdGVseS4KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CiAgLy8gUmV1c2VkIHN0cmluZy4KICB2YXIgc3RyX2hhc2hjaGFuZ2UgPSAnaGFzaGNoYW5nZScsCiAgICAKICAgIC8vIE1ldGhvZCAvIG9iamVjdCByZWZlcmVuY2VzLgogICAgZG9jID0gZG9jdW1lbnQsCiAgICBmYWtlX29uaGFzaGNoYW5nZSwKICAgIHNwZWNpYWwgPSAkLmV2ZW50LnNwZWNpYWwsCiAgICAKICAgIC8vIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCB3aW5kb3cub25oYXNoY2hhbmdlPyBOb3RlIHRoYXQgSUU4IHJ1bm5pbmcgaW4KICAgIC8vIElFNyBjb21wYXRpYmlsaXR5IG1vZGUgcmVwb3J0cyB0cnVlIGZvciAnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3csIGV2ZW4KICAgIC8vIHRob3VnaCB0aGUgZXZlbnQgaXNuJ3Qgc3VwcG9ydGVkLCBzbyBhbHNvIHRlc3QgZG9jdW1lbnQuZG9jdW1lbnRNb2RlLgogICAgZG9jX21vZGUgPSBkb2MuZG9jdW1lbnRNb2RlLAogICAgc3VwcG9ydHNfb25oYXNoY2hhbmdlID0gJ29uJyArIHN0cl9oYXNoY2hhbmdlIGluIHdpbmRvdyAmJiAoIGRvY19tb2RlID09PSB1bmRlZmluZWQgfHwgZG9jX21vZGUgPiA3ICk7CiAgCiAgLy8gR2V0IGxvY2F0aW9uLmhhc2ggKG9yIHdoYXQgeW91J2QgZXhwZWN0IGxvY2F0aW9uLmhhc2ggdG8gYmUpIHNhbnMgYW55CiAgLy8gbGVhZGluZyAjLiBUaGFua3MgZm9yIG1ha2luZyB0aGlzIG5lY2Vzc2FyeSwgRmlyZWZveCEKICBmdW5jdGlvbiBnZXRfZnJhZ21lbnQoIHVybCApIHsKICAgIHVybCA9IHVybCB8fCBsb2NhdGlvbi5ocmVmOwogICAgcmV0dXJuICcjJyArIHVybC5yZXBsYWNlKCAvXlteI10qIz8oLiopJC8sICckMScgKTsKICB9OwogIAogIC8vIE1ldGhvZDogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UKICAvLyAKICAvLyBCaW5kIGEgaGFuZGxlciB0byB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBvciB0cmlnZ2VyIGFsbCBib3VuZAogIC8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMuIFRoaXMgYmVoYXZpb3IgaXMgY29uc2lzdGVudCB3aXRoCiAgLy8galF1ZXJ5J3MgYnVpbHQtaW4gZXZlbnQgaGFuZGxlcnMuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCBbIGhhbmRsZXIgXSApOwogIC8vIAogIC8vIEFyZ3VtZW50czoKICAvLyAKICAvLyAgaGFuZGxlciAtIChGdW5jdGlvbikgT3B0aW9uYWwgaGFuZGxlciB0byBiZSBib3VuZCB0byB0aGUgaGFzaGNoYW5nZQogIC8vICAgIGV2ZW50LiBUaGlzIGlzIGEgInNob3J0Y3V0IiBmb3IgdGhlIG1vcmUgdmVyYm9zZSBmb3JtOgogIC8vICAgIGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgaGFuZGxlciApLiBJZiBoYW5kbGVyIGlzIG9taXR0ZWQsCiAgLy8gICAgYWxsIGJvdW5kIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMgd2lsbCBiZSB0cmlnZ2VyZWQuIFRoaXMKICAvLyAgICBpcyBhIHNob3J0Y3V0IGZvciB0aGUgbW9yZSB2ZXJib3NlCiAgLy8gICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuIFRoZXNlIGZvcm1zIGFyZSBkZXNjcmliZWQgaW4KICAvLyAgICB0aGUgPGhhc2hjaGFuZ2UgZXZlbnQ+IHNlY3Rpb24uCiAgLy8gCiAgLy8gUmV0dXJuczoKICAvLyAKICAvLyAgKGpRdWVyeSkgVGhlIGluaXRpYWwgalF1ZXJ5IGNvbGxlY3Rpb24gb2YgZWxlbWVudHMuCiAgCiAgLy8gQWxsb3cgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQoZWxlbSkuaGFzaGNoYW5nZSggZm4gKSBmb3IgYmluZGluZyBhbmQKICAvLyAkKGVsZW0pLmhhc2hjaGFuZ2UoKSBmb3IgdHJpZ2dlcmluZywgbGlrZSBqUXVlcnkgZG9lcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0gPSBmdW5jdGlvbiggZm4gKSB7CiAgICByZXR1cm4gZm4gPyB0aGlzLmJpbmQoIHN0cl9oYXNoY2hhbmdlLCBmbiApIDogdGhpcy50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogIH07CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5CiAgLy8gCiAgLy8gVGhlIG51bWVyaWMgaW50ZXJ2YWwgKGluIG1pbGxpc2Vjb25kcykgYXQgd2hpY2ggdGhlIDxoYXNoY2hhbmdlIGV2ZW50PgogIC8vIHBvbGxpbmcgbG9vcCBleGVjdXRlcy4gRGVmYXVsdHMgdG8gNTAuCiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbgogIC8vIAogIC8vIElmIHlvdSdyZSBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbiB5b3VyIEphdmFTY3JpcHQsIGFuZCB5b3Ugd2FudCBoYXNoCiAgLy8gaGlzdG9yeSB0byB3b3JrIGluIElFNi83LCBub3Qgb25seSBtdXN0IHRoaXMgcHJvcGVydHkgYmUgc2V0LCBidXQgeW91IG11c3QKICAvLyBhbHNvIHNldCBkb2N1bWVudC5kb21haW4gQkVGT1JFIGpRdWVyeSBpcyBsb2FkZWQgaW50byB0aGUgcGFnZS4gVGhpcwogIC8vIHByb3BlcnR5IGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcKICAvLyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vIAogIC8vIEluIGFkZGl0aW9uLCB0aGUgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydHkgbXVzdCBiZSBzZXQgdG8gdGhlCiAgLy8gcGF0aCBvZiB0aGUgaW5jbHVkZWQgImRvY3VtZW50LWRvbWFpbi5odG1sIiBmaWxlLCB3aGljaCBjYW4gYmUgcmVuYW1lZCBvcgogIC8vIG1vZGlmaWVkIGlmIG5lY2Vzc2FyeSAobm90ZSB0aGF0IHRoZSBkb2N1bWVudC5kb21haW4gc3BlY2lmaWVkIG11c3QgYmUgdGhlCiAgLy8gc2FtZSBpbiBib3RoIHlvdXIgbWFpbiBKYXZhU2NyaXB0IGFzIHdlbGwgYXMgaW4gdGhpcyBmaWxlKS4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4gPSBkb2N1bWVudC5kb21haW47CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYwogIC8vIAogIC8vIElmLCBmb3Igc29tZSByZWFzb24sIHlvdSBuZWVkIHRvIHNwZWNpZnkgYW4gSWZyYW1lIHNyYyBmaWxlIChmb3IgZXhhbXBsZSwKICAvLyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGFzIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+KSwgeW91IGNhbgogIC8vIGRvIHNvIHVzaW5nIHRoaXMgcHJvcGVydHkuIE5vdGUgdGhhdCB3aGVuIHVzaW5nIHRoaXMgcHJvcGVydHksIGhpc3RvcnkKICAvLyB3b24ndCBiZSByZWNvcmRlZCBpbiBJRTYvNyB1bnRpbCB0aGUgSWZyYW1lIHNyYyBmaWxlIGxvYWRzLiBUaGlzIHByb3BlcnR5CiAgLy8gaXMgb25seSBhcHBsaWNhYmxlIGlmIHlvdSBhcmUgc3VwcG9ydGluZyBJRTYvNyAob3IgSUU4IG9wZXJhdGluZyBpbiAiSUU3CiAgLy8gY29tcGF0aWJpbGl0eSIgbW9kZSkuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjID0gJ3BhdGgvdG8vZmlsZS5odG1sJzsKICAKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ID0gNTA7CiAgLyoKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbiA9IG51bGw7CiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmMgPSBudWxsOwogICovCiAgCiAgLy8gRXZlbnQ6IGhhc2hjaGFuZ2UgZXZlbnQKICAvLyAKICAvLyBGaXJlZCB3aGVuIGxvY2F0aW9uLmhhc2ggY2hhbmdlcy4gSW4gYnJvd3NlcnMgdGhhdCBzdXBwb3J0IGl0LCB0aGUgbmF0aXZlCiAgLy8gSFRNTDUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBpcyB1c2VkLCBvdGhlcndpc2UgYSBwb2xsaW5nIGxvb3AgaXMKICAvLyBpbml0aWFsaXplZCwgcnVubmluZyBldmVyeSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IG1pbGxpc2Vjb25kcyB0bwogIC8vIHNlZSBpZiB0aGUgaGFzaCBoYXMgY2hhbmdlZC4gSW4gSUU2LzcgKGFuZCBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKSwgYSBoaWRkZW4gSWZyYW1lIGlzIGNyZWF0ZWQgdG8gYWxsb3cgdGhlIGJhY2sgYnV0dG9uCiAgLy8gYW5kIGhhc2gtYmFzZWQgaGlzdG9yeSB0byB3b3JrLgogIC8vIAogIC8vIFVzYWdlIGFzIGRlc2NyaWJlZCBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2U+OgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPiAKICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCk7CiAgLy8gCiAgLy8gQSBtb3JlIHZlcmJvc2UgdXNhZ2UgdGhhdCBhbGxvd3MgZm9yIGV2ZW50IG5hbWVzcGFjaW5nOgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBmdW5jdGlvbihlKSB7CiAgLy8gPiAgIHZhciBoYXNoID0gbG9jYXRpb24uaGFzaDsKICAvLyA+ICAgLi4uCiAgLy8gPiB9KTsKICAvLyA+IAogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApOwogIC8vIAogIC8vIEFkZGl0aW9uYWwgTm90ZXM6CiAgLy8gCiAgLy8gKiBUaGUgcG9sbGluZyBsb29wIGFuZCBJZnJhbWUgYXJlIG5vdCBjcmVhdGVkIHVudGlsIGF0IGxlYXN0IG9uZSBoYW5kbGVyCiAgLy8gICBpcyBhY3R1YWxseSBib3VuZCB0byB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50LgogIC8vICogSWYgeW91IG5lZWQgdGhlIGJvdW5kIGhhbmRsZXIocykgdG8gZXhlY3V0ZSBpbW1lZGlhdGVseSwgaW4gY2FzZXMgd2hlcmUKICAvLyAgIGEgbG9jYXRpb24uaGFzaCBleGlzdHMgb24gcGFnZSBsb2FkLCB2aWEgYm9va21hcmsgb3IgcGFnZSByZWZyZXNoIGZvcgogIC8vICAgZXhhbXBsZSwgdXNlIGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBvciB0aGUgbW9yZSB2ZXJib3NlIAogIC8vICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuCiAgLy8gKiBUaGUgZXZlbnQgY2FuIGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBzaW5jZSBpdCB3b24ndCBiZSB1c2FibGUKICAvLyAgIGJlZm9yZSB0aGVuIGluIElFNi83IChkdWUgdG8gdGhlIG5lY2Vzc2FyeSBJZnJhbWUpLCByZWNvbW1lbmRlZCB1c2FnZSBpcwogIC8vICAgdG8gYmluZCBpdCBpbnNpZGUgYSBET00gcmVhZHkgaGFuZGxlci4KICAKICAvLyBPdmVycmlkZSBleGlzdGluZyAkLmV2ZW50LnNwZWNpYWwuaGFzaGNoYW5nZSBtZXRob2RzIChhbGxvd2luZyB0aGlzIHBsdWdpbgogIC8vIHRvIGJlIGRlZmluZWQgYWZ0ZXIgalF1ZXJ5IEJCUSBpbiBCQlEncyBzb3VyY2UgY29kZSkuCiAgc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSA9ICQuZXh0ZW5kKCBzcGVjaWFsWyBzdHJfaGFzaGNoYW5nZSBdLCB7CiAgICAKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGZpcnN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyBib3VuZCB0byB3aW5kb3cuCiAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIAogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gY3JlYXRlIG91ciBvd24uIEFuZCB3ZSBkb24ndCB3YW50IHRvIGNhbGwgdGhpcwogICAgICAvLyB1bnRpbCB0aGUgdXNlciBiaW5kcyB0byB0aGUgZXZlbnQsIGp1c3QgaW4gY2FzZSB0aGV5IG5ldmVyIGRvLCBzaW5jZSBpdAogICAgICAvLyB3aWxsIGNyZWF0ZSBhIHBvbGxpbmcgbG9vcCBhbmQgcG9zc2libHkgZXZlbiBhIGhpZGRlbiBJZnJhbWUuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0YXJ0ICk7CiAgICB9LAogICAgCiAgICAvLyBDYWxsZWQgb25seSB3aGVuIHRoZSBsYXN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyB1bmJvdW5kIGZyb20gd2luZG93LgogICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICAvLyBJZiB3aW5kb3cub25oYXNoY2hhbmdlIGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgdGhlcmUncyBub3RoaW5nIHRvIGRvLi4KICAgICAgaWYgKCBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIHN0b3Agb3VycyAoaWYgcG9zc2libGUpLgogICAgICAkKCBmYWtlX29uaGFzaGNoYW5nZS5zdG9wICk7CiAgICB9CiAgICAKICB9KTsKICAKICAvLyBmYWtlX29uaGFzaGNoYW5nZSBkb2VzIGFsbCB0aGUgd29yayBvZiB0cmlnZ2VyaW5nIHRoZSB3aW5kb3cub25oYXNoY2hhbmdlCiAgLy8gZXZlbnQgZm9yIGJyb3dzZXJzIHRoYXQgZG9uJ3QgbmF0aXZlbHkgc3VwcG9ydCBpdCwgaW5jbHVkaW5nIGNyZWF0aW5nIGEKICAvLyBwb2xsaW5nIGxvb3AgdG8gd2F0Y2ggZm9yIGhhc2ggY2hhbmdlcyBhbmQgaW4gSUUgNi83IGNyZWF0aW5nIGEgaGlkZGVuCiAgLy8gSWZyYW1lIHRvIGVuYWJsZSBiYWNrIGFuZCBmb3J3YXJkLgogIGZha2Vfb25oYXNoY2hhbmdlID0gKGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB7fSwKICAgICAgdGltZW91dF9pZCwKICAgICAgCiAgICAgIC8vIFJlbWVtYmVyIHRoZSBpbml0aWFsIGhhc2ggc28gaXQgZG9lc24ndCBnZXQgdHJpZ2dlcmVkIGltbWVkaWF0ZWx5LgogICAgICBsYXN0X2hhc2ggPSBnZXRfZnJhZ21lbnQoKSwKICAgICAgCiAgICAgIGZuX3JldHZhbCA9IGZ1bmN0aW9uKCB2YWwgKSB7IHJldHVybiB2YWw7IH0sCiAgICAgIGhpc3Rvcnlfc2V0ID0gZm5fcmV0dmFsLAogICAgICBoaXN0b3J5X2dldCA9IGZuX3JldHZhbDsKICAgIAogICAgLy8gU3RhcnQgdGhlIHBvbGxpbmcgbG9vcC4KICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCB8fCBwb2xsKCk7CiAgICB9OwogICAgCiAgICAvLyBTdG9wIHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCAmJiBjbGVhclRpbWVvdXQoIHRpbWVvdXRfaWQgKTsKICAgICAgdGltZW91dF9pZCA9IHVuZGVmaW5lZDsKICAgIH07CiAgICAKICAgIC8vIFRoaXMgcG9sbGluZyBsb29wIGNoZWNrcyBldmVyeSAkLmZuLmhhc2hjaGFuZ2UuZGVsYXkgbWlsbGlzZWNvbmRzIHRvIHNlZQogICAgLy8gaWYgbG9jYXRpb24uaGFzaCBoYXMgY2hhbmdlZCwgYW5kIHRyaWdnZXJzIHRoZSAnaGFzaGNoYW5nZScgZXZlbnQgb24KICAgIC8vIHdpbmRvdyB3aGVuIG5lY2Vzc2FyeS4KICAgIGZ1bmN0aW9uIHBvbGwoKSB7CiAgICAgIHZhciBoYXNoID0gZ2V0X2ZyYWdtZW50KCksCiAgICAgICAgaGlzdG9yeV9oYXNoID0gaGlzdG9yeV9nZXQoIGxhc3RfaGFzaCApOwogICAgICAKICAgICAgaWYgKCBoYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgaGlzdG9yeV9zZXQoIGxhc3RfaGFzaCA9IGhhc2gsIGhpc3RvcnlfaGFzaCApOwogICAgICAgIAogICAgICAgICQod2luZG93KS50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogICAgICAgIAogICAgICB9IGVsc2UgaWYgKCBoaXN0b3J5X2hhc2ggIT09IGxhc3RfaGFzaCApIHsKICAgICAgICBsb2NhdGlvbi5ocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKCAvIy4qLywgJycgKSArIGhpc3RvcnlfaGFzaDsKICAgICAgfQogICAgICAKICAgICAgdGltZW91dF9pZCA9IHNldFRpbWVvdXQoIHBvbGwsICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZGVsYXkgKTsKICAgIH07CiAgICAKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2diBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIHdpbmRvdy5hdHRhY2hFdmVudCAmJiAhd2luZG93LmFkZEV2ZW50TGlzdGVuZXIgJiYgIXN1cHBvcnRzX29uaGFzaGNoYW5nZSAmJiAoZnVuY3Rpb24oKSB7CiAgICAgIC8vIE5vdCBvbmx5IGRvIElFNi83IG5lZWQgdGhlICJtYWdpY2FsIiBJZnJhbWUgdHJlYXRtZW50LCBidXQgc28gZG9lcyBJRTgKICAgICAgLy8gd2hlbiBydW5uaW5nIGluICJJRTcgY29tcGF0aWJpbGl0eSIgbW9kZS4KICAgICAgCiAgICAgIHZhciBpZnJhbWUsCiAgICAgICAgaWZyYW1lX3NyYzsKICAgICAgCiAgICAgIC8vIFdoZW4gdGhlIGV2ZW50IGlzIGJvdW5kIGFuZCBwb2xsaW5nIHN0YXJ0cyBpbiBJRSA2LzcsIGNyZWF0ZSBhIGhpZGRlbgogICAgICAvLyBJZnJhbWUgZm9yIGhpc3RvcnkgaGFuZGxpbmcuCiAgICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoICFpZnJhbWUgKSB7CiAgICAgICAgICBpZnJhbWVfc3JjID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmM7CiAgICAgICAgICBpZnJhbWVfc3JjID0gaWZyYW1lX3NyYyAmJiBpZnJhbWVfc3JjICsgZ2V0X2ZyYWdtZW50KCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIENyZWF0ZSBoaWRkZW4gSWZyYW1lLiBBdHRlbXB0IHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZQogICAgICAgICAgLy8gYnkgdXNpbmcgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuCiAgICAgICAgICBpZnJhbWUgPSAkKCc8aWZyYW1lIHRhYmluZGV4PSItMSIgdGl0bGU9ImVtcHR5Ii8+JykuaGlkZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBXaGVuIElmcmFtZSBoYXMgY29tcGxldGVseSBsb2FkZWQsIGluaXRpYWxpemUgdGhlIGhpc3RvcnkgYW5kCiAgICAgICAgICAgIC8vIHN0YXJ0IHBvbGxpbmcuCiAgICAgICAgICAgIC5vbmUoICdsb2FkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWZyYW1lX3NyYyB8fCBoaXN0b3J5X3NldCggZ2V0X2ZyYWdtZW50KCkgKTsKICAgICAgICAgICAgICBwb2xsKCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBMb2FkIElmcmFtZSBzcmMgaWYgc3BlY2lmaWVkLCBvdGhlcndpc2Ugbm90aGluZy4KICAgICAgICAgICAgLmF0dHIoICdzcmMnLCBpZnJhbWVfc3JjIHx8ICdqYXZhc2NyaXB0OjAnICkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGVuZCBJZnJhbWUgYWZ0ZXIgdGhlIGVuZCBvZiB0aGUgYm9keSB0byBwcmV2ZW50IHVubmVjZXNzYXJ5CiAgICAgICAgICAgIC8vIGluaXRpYWwgcGFnZSBzY3JvbGxpbmcgKHllcywgdGhpcyB3b3JrcykuCiAgICAgICAgICAgIC5pbnNlcnRBZnRlciggJ2JvZHknIClbMF0uY29udGVudFdpbmRvdzsKICAgICAgICAgIAogICAgICAgICAgLy8gV2hlbmV2ZXIgYGRvY3VtZW50LnRpdGxlYCBjaGFuZ2VzLCB1cGRhdGUgdGhlIElmcmFtZSdzIHRpdGxlIHRvCiAgICAgICAgICAvLyBwcmV0dGlmeSB0aGUgYmFjay9uZXh0IGhpc3RvcnkgbWVudSBlbnRyaWVzLiBTaW5jZSBJRSBzb21ldGltZXMKICAgICAgICAgIC8vIGVycm9ycyB3aXRoICJVbnNwZWNpZmllZCBlcnJvciIgdGhlIHZlcnkgZmlyc3QgdGltZSB0aGlzIGlzIHNldAogICAgICAgICAgLy8gKHllcywgdmVyeSB1c2VmdWwpIHdyYXAgdGhpcyB3aXRoIGEgdHJ5L2NhdGNoIGJsb2NrLgogICAgICAgICAgZG9jLm9ucHJvcGVydHljaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpZiAoIGV2ZW50LnByb3BlcnR5TmFtZSA9PT0gJ3RpdGxlJyApIHsKICAgICAgICAgICAgICAgIGlmcmFtZS5kb2N1bWVudC50aXRsZSA9IGRvYy50aXRsZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2goZSkge30KICAgICAgICAgIH07CiAgICAgICAgICAKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgICAvLyBPdmVycmlkZSB0aGUgInN0b3AiIG1ldGhvZCBzaW5jZSBhbiBJRTYvNyBJZnJhbWUgd2FzIGNyZWF0ZWQuIEV2ZW4KICAgICAgLy8gaWYgdGhlcmUgYXJlIG5vIGxvbmdlciBhbnkgYm91bmQgZXZlbnQgaGFuZGxlcnMsIHRoZSBwb2xsaW5nIGxvb3AKICAgICAgLy8gaXMgc3RpbGwgbmVjZXNzYXJ5IGZvciBiYWNrL25leHQgdG8gd29yayBhdCBhbGwhCiAgICAgIHNlbGYuc3RvcCA9IGZuX3JldHZhbDsKICAgICAgCiAgICAgIC8vIEdldCBoaXN0b3J5IGJ5IGxvb2tpbmcgYXQgdGhlIGhpZGRlbiBJZnJhbWUncyBsb2NhdGlvbi5oYXNoLgogICAgICBoaXN0b3J5X2dldCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBnZXRfZnJhZ21lbnQoIGlmcmFtZS5sb2NhdGlvbi5ocmVmICk7CiAgICAgIH07CiAgICAgIAogICAgICAvLyBTZXQgYSBuZXcgaGlzdG9yeSBpdGVtIGJ5IG9wZW5pbmcgYW5kIHRoZW4gY2xvc2luZyB0aGUgSWZyYW1lCiAgICAgIC8vIGRvY3VtZW50LCAqdGhlbiogc2V0dGluZyBpdHMgbG9jYXRpb24uaGFzaC4gSWYgZG9jdW1lbnQuZG9tYWluIGhhcwogICAgICAvLyBiZWVuIHNldCwgdXBkYXRlIHRoYXQgYXMgd2VsbC4KICAgICAgaGlzdG9yeV9zZXQgPSBmdW5jdGlvbiggaGFzaCwgaGlzdG9yeV9oYXNoICkgewogICAgICAgIHZhciBpZnJhbWVfZG9jID0gaWZyYW1lLmRvY3VtZW50LAogICAgICAgICAgZG9tYWluID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kb21haW47CiAgICAgICAgCiAgICAgICAgaWYgKCBoYXNoICE9PSBoaXN0b3J5X2hhc2ggKSB7CiAgICAgICAgICAvLyBVcGRhdGUgSWZyYW1lIHdpdGggYW55IGluaXRpYWwgYGRvY3VtZW50LnRpdGxlYCB0aGF0IG1pZ2h0IGJlIHNldC4KICAgICAgICAgIGlmcmFtZV9kb2MudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAKICAgICAgICAgIC8vIE9wZW5pbmcgdGhlIElmcmFtZSdzIGRvY3VtZW50IGFmdGVyIGl0IGhhcyBiZWVuIGNsb3NlZCBpcyB3aGF0CiAgICAgICAgICAvLyBhY3R1YWxseSBhZGRzIGEgaGlzdG9yeSBlbnRyeS4KICAgICAgICAgIGlmcmFtZV9kb2Mub3BlbigpOwogICAgICAgICAgCiAgICAgICAgICAvLyBTZXQgZG9jdW1lbnQuZG9tYWluIGZvciB0aGUgSWZyYW1lIGRvY3VtZW50IGFzIHdlbGwsIGlmIG5lY2Vzc2FyeS4KICAgICAgICAgIGRvbWFpbiAmJiBpZnJhbWVfZG9jLndyaXRlKCAnPHNjcmlwdD5kb2N1bWVudC5kb21haW49IicgKyBkb21haW4gKyAnIjxcL3NjcmlwdD4nICk7CiAgICAgICAgICAKICAgICAgICAgIGlmcmFtZV9kb2MuY2xvc2UoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gVXBkYXRlIHRoZSBJZnJhbWUncyBoYXNoLCBmb3IgZ3JlYXQganVzdGljZS4KICAgICAgICAgIGlmcmFtZS5sb2NhdGlvbi5oYXNoID0gaGFzaDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgfSkoKTsKICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXiBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCBeXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIAogICAgcmV0dXJuIHNlbGY7CiAgfSkoKTsKICAKfSkoalF1ZXJ5LHRoaXMpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJLyohIG1hdGNoTWVkaWEoKSBwb2x5ZmlsbCAtIFRlc3QgYSBDU1MgbWVkaWEgdHlwZS9xdWVyeSBpbiBKUy4gQXV0aG9ycyAmIGNvcHlyaWdodCAoYykgMjAxMjogU2NvdHQgSmVobCwgUGF1bCBJcmlzaCwgTmljaG9sYXMgWmFrYXMuIER1YWwgTUlUL0JTRCBsaWNlbnNlICovCgl3aW5kb3cubWF0Y2hNZWRpYSA9IHdpbmRvdy5tYXRjaE1lZGlhIHx8IChmdW5jdGlvbiggZG9jLCB1bmRlZmluZWQgKSB7CgoJCQoKCQl2YXIgYm9vbCwKCQkJZG9jRWxlbSA9IGRvYy5kb2N1bWVudEVsZW1lbnQsCgkJCXJlZk5vZGUgPSBkb2NFbGVtLmZpcnN0RWxlbWVudENoaWxkIHx8IGRvY0VsZW0uZmlyc3RDaGlsZCwKCQkJLy8gZmFrZUJvZHkgcmVxdWlyZWQgZm9yIDxGRjQgd2hlbiBleGVjdXRlZCBpbiA8aGVhZD4KCQkJZmFrZUJvZHkgPSBkb2MuY3JlYXRlRWxlbWVudCggImJvZHkiICksCgkJCWRpdiA9IGRvYy5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoKCQlkaXYuaWQgPSAibXEtdGVzdC0xIjsKCQlkaXYuc3R5bGUuY3NzVGV4dCA9ICJwb3NpdGlvbjphYnNvbHV0ZTt0b3A6LTEwMGVtIjsKCQlmYWtlQm9keS5zdHlsZS5iYWNrZ3JvdW5kID0gIm5vbmUiOwoJCWZha2VCb2R5LmFwcGVuZENoaWxkKGRpdik7CgoJCXJldHVybiBmdW5jdGlvbihxKXsKCgkJCWRpdi5pbm5lckhUTUwgPSAiJnNoeTs8c3R5bGUgbWVkaWE9XCIiICsgcSArICJcIj4gI21xLXRlc3QtMSB7IHdpZHRoOiA0MnB4OyB9PC9zdHlsZT4iOwoKCQkJZG9jRWxlbS5pbnNlcnRCZWZvcmUoIGZha2VCb2R5LCByZWZOb2RlICk7CgkJCWJvb2wgPSBkaXYub2Zmc2V0V2lkdGggPT09IDQyOwoJCQlkb2NFbGVtLnJlbW92ZUNoaWxkKCBmYWtlQm9keSApOwoKCQkJcmV0dXJuIHsKCQkJCW1hdGNoZXM6IGJvb2wsCgkJCQltZWRpYTogcQoJCQl9OwoKCQl9OwoKCX0oIGRvY3VtZW50ICkpOwoKCS8vICQubW9iaWxlLm1lZGlhIHVzZXMgbWF0Y2hNZWRpYSB0byByZXR1cm4gYSBib29sZWFuLgoJJC5tb2JpbGUubWVkaWEgPSBmdW5jdGlvbiggcSApIHsKCQlyZXR1cm4gd2luZG93Lm1hdGNoTWVkaWEoIHEgKS5tYXRjaGVzOwoJfTsKCn0pKGpRdWVyeSk7CgoJKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJdmFyIHN1cHBvcnQgPSB7CgkJCXRvdWNoOiAib250b3VjaGVuZCIgaW4gZG9jdW1lbnQKCQl9OwoKCQkkLm1vYmlsZS5zdXBwb3J0ID0gJC5tb2JpbGUuc3VwcG9ydCB8fCB7fTsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCBzdXBwb3J0ICk7CgkJJC5leHRlbmQoICQubW9iaWxlLnN1cHBvcnQsIHN1cHBvcnQgKTsKCX0oIGpRdWVyeSApKTsKCgkoZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCB7CgkJCW9yaWVudGF0aW9uOiAib3JpZW50YXRpb24iIGluIHdpbmRvdyAmJiAib25vcmllbnRhdGlvbmNoYW5nZSIgaW4gd2luZG93CgkJfSk7Cgl9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIHRoeCBNb2Rlcm5penIKZnVuY3Rpb24gcHJvcEV4aXN0cyggcHJvcCApIHsKCXZhciB1Y19wcm9wID0gcHJvcC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zdWJzdHIoIDEgKSwKCQlwcm9wcyA9ICggcHJvcCArICIgIiArIHZlbmRvcnMuam9pbiggdWNfcHJvcCArICIgIiApICsgdWNfcHJvcCApLnNwbGl0KCAiICIgKSwKCQl2OwoKCWZvciAoIHYgaW4gcHJvcHMgKSB7CgkJaWYgKCBmYkNTU1sgcHJvcHNbIHYgXSBdICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KfQoKdmFyIGZha2VCb2R5ID0gJCggIjxib2R5PiIgKS5wcmVwZW5kVG8oICJodG1sIiApLAoJZmJDU1MgPSBmYWtlQm9keVsgMCBdLnN0eWxlLAoJdmVuZG9ycyA9IFsgIldlYmtpdCIsICJNb3oiLCAiTyIgXSwKCXdlYm9zID0gInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93LCAvL29ubHkgdXNlZCB0byBydWxlIG91dCBzY3JvbGxUb3AKCW9wZXJhID0gd2luZG93Lm9wZXJhLAoJb3BlcmFtaW5pID0gd2luZG93Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHdpbmRvdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIsCgliYiA9IHdpbmRvdy5ibGFja2JlcnJ5ICYmICFwcm9wRXhpc3RzKCAiLXdlYmtpdC10cmFuc2Zvcm0iICksIC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IGJveCBzaGFkb3csIGFzIGl0J3MgZmlsbGVkIG9wYXF1ZSBvbiBCQiA1IGFuZCBsb3dlcgoJbm9raWFMVEU3XzM7CgpmdW5jdGlvbiB2YWxpZFN0eWxlKCBwcm9wLCB2YWx1ZSwgY2hlY2tfdmVuZCApIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCXVjID0gZnVuY3Rpb24oIHR4dCApIHsKCQkJcmV0dXJuIHR4dC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgdHh0LnN1YnN0ciggMSApOwoJCX0sCgkJdmVuZF9wcmVmID0gZnVuY3Rpb24oIHZlbmQgKSB7CgkJCWlmICggdmVuZCA9PT0gIiIgKSB7CgkJCQlyZXR1cm4gIiI7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gICItIiArIHZlbmQuY2hhckF0KCAwICkudG9Mb3dlckNhc2UoKSArIHZlbmQuc3Vic3RyKCAxICkgKyAiLSI7CgkJCX0KCQl9LAoJCWNoZWNrX3N0eWxlID0gZnVuY3Rpb24oIHZlbmQgKSB7CgkJCXZhciB2ZW5kX3Byb3AgPSB2ZW5kX3ByZWYoIHZlbmQgKSArIHByb3AgKyAiOiAiICsgdmFsdWUgKyAiOyIsCgkJCQl1Y192ZW5kID0gdWMoIHZlbmQgKSwKCQkJCXByb3BTdHlsZSA9IHVjX3ZlbmQgKyAoIHVjX3ZlbmQgPT09ICIiID8gcHJvcCA6IHVjKCBwcm9wICkgKTsKCgkJCWRpdi5zZXRBdHRyaWJ1dGUoICJzdHlsZSIsIHZlbmRfcHJvcCApOwoKCQkJaWYgKCAhIWRpdi5zdHlsZVsgcHJvcFN0eWxlIF0gKSB7CgkJCQlyZXQgPSB0cnVlOwoJCQl9CgkJfSwKCQljaGVja192ZW5kcyA9IGNoZWNrX3ZlbmQgPyBjaGVja192ZW5kIDogdmVuZG9ycywKCQlpLCByZXQ7CgoJZm9yKCBpID0gMDsgaSA8IGNoZWNrX3ZlbmRzLmxlbmd0aDsgaSsrICkgewoJCWNoZWNrX3N0eWxlKCBjaGVja192ZW5kc1tpXSApOwoJfQoJcmV0dXJuICEhcmV0Owp9CgovLyBpbmxpbmUgU1ZHIHN1cHBvcnQgdGVzdApmdW5jdGlvbiBpbmxpbmVTVkcoKSB7CgkvLyBUaGFua3MgTW9kZXJuaXpyICYgRXJpayBEYWhsc3Ryb20KCXZhciB3ID0gd2luZG93LAoJCXN2ZyA9ICEhdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50TlMgJiYgISF3LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyggImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiwgInN2ZyIgKS5jcmVhdGVTVkdSZWN0ICYmICEoIHcub3BlcmEgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQ2hyb21lIiApID09PSAtMSApLAoJCXN1cHBvcnQgPSBmdW5jdGlvbiggZGF0YSApIHsKCQkJaWYgKCAhKCBkYXRhICYmIHN2ZyApICkgewoJCQkJJCggImh0bWwiICkuYWRkQ2xhc3MoICJ1aS1ub3N2ZyIgKTsKCQkJfQoJCX0sCgkJaW1nID0gbmV3IHcuSW1hZ2UoKTsKCglpbWcub25lcnJvciA9IGZ1bmN0aW9uKCkgewoJCXN1cHBvcnQoIGZhbHNlICk7Cgl9OwoJaW1nLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewoJCXN1cHBvcnQoIGltZy53aWR0aCA9PT0gMSAmJiBpbWcuaGVpZ2h0ID09PSAxICk7Cgl9OwoJaW1nLnNyYyA9ICJkYXRhOmltYWdlL2dpZjtiYXNlNjQsUjBsR09EbGhBUUFCQUlBQUFBQUFBUC8vL3l3QUFBQUFBUUFCQUFBQ0FVd0FPdz09IjsKfQoKZnVuY3Rpb24gdHJhbnNmb3JtM2RUZXN0KCkgewoJdmFyIG1xUHJvcCA9ICJ0cmFuc2Zvcm0tM2QiLAoJCS8vIEJlY2F1c2UgdGhlIGB0cmFuc2xhdGUzZGAgdGVzdCBiZWxvdyB0aHJvd3MgZmFsc2UgcG9zaXRpdmVzIGluIEFuZHJvaWQ6CgkJcmV0ID0gJC5tb2JpbGUubWVkaWEoICIoLSIgKyB2ZW5kb3JzLmpvaW4oICItIiArIG1xUHJvcCArICIpLCgtIiApICsgIi0iICsgbXFQcm9wICsgIiksKCIgKyBtcVByb3AgKyAiKSIgKSwKCQllbCwgdHJhbnNmb3JtcywgdDsKCglpZiAoIHJldCApIHsKCQlyZXR1cm4gISFyZXQ7Cgl9CgoJZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJdHJhbnNmb3JtcyA9IHsKCQkvLyBXZeKAmXJlIG9taXR0aW5nIE9wZXJhIGZvciB0aGUgdGltZSBiZWluZzsgTVMgdXNlcyB1bnByZWZpeGVkLgoJCSJNb3pUcmFuc2Zvcm0iOiAiLW1vei10cmFuc2Zvcm0iLAoJCSJ0cmFuc2Zvcm0iOiAidHJhbnNmb3JtIgoJfTsKCglmYWtlQm9keS5hcHBlbmQoIGVsICk7CgoJZm9yICggdCBpbiB0cmFuc2Zvcm1zICkgewoJCWlmICggZWwuc3R5bGVbIHQgXSAhPT0gdW5kZWZpbmVkICkgewoJCQllbC5zdHlsZVsgdCBdID0gInRyYW5zbGF0ZTNkKCAxMDBweCwgMXB4LCAxcHggKSI7CgkJCXJldCA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBlbCApLmdldFByb3BlcnR5VmFsdWUoIHRyYW5zZm9ybXNbIHQgXSApOwoJCX0KCX0KCXJldHVybiAoICEhcmV0ICYmIHJldCAhPT0gIm5vbmUiICk7Cn0KCi8vIFRlc3QgZm9yIGR5bmFtaWMtdXBkYXRpbmcgYmFzZSB0YWcgc3VwcG9ydCAoIGFsbG93cyB1cyB0byBhdm9pZCBocmVmLHNyYyBhdHRyIHJld3JpdGluZyApCmZ1bmN0aW9uIGJhc2VUYWdUZXN0KCkgewoJdmFyIGZhdXhCYXNlID0gbG9jYXRpb24ucHJvdG9jb2wgKyAiLy8iICsgbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lICsgInVpLWRpci8iLAoJCWJhc2UgPSAkKCAiaGVhZCBiYXNlIiApLAoJCWZhdXhFbGUgPSBudWxsLAoJCWhyZWYgPSAiIiwKCQlsaW5rLCByZWJhc2U7CgoJaWYgKCAhYmFzZS5sZW5ndGggKSB7CgkJYmFzZSA9IGZhdXhFbGUgPSAkKCAiPGJhc2U+IiwgeyAiaHJlZiI6IGZhdXhCYXNlIH0pLmFwcGVuZFRvKCAiaGVhZCIgKTsKCX0gZWxzZSB7CgkJaHJlZiA9IGJhc2UuYXR0ciggImhyZWYiICk7Cgl9CgoJbGluayA9ICQoICI8YSBocmVmPSd0ZXN0dXJsJyAvPiIgKS5wcmVwZW5kVG8oIGZha2VCb2R5ICk7CglyZWJhc2UgPSBsaW5rWyAwIF0uaHJlZjsKCWJhc2VbIDAgXS5ocmVmID0gaHJlZiB8fCBsb2NhdGlvbi5wYXRobmFtZTsKCglpZiAoIGZhdXhFbGUgKSB7CgkJZmF1eEVsZS5yZW1vdmUoKTsKCX0KCXJldHVybiByZWJhc2UuaW5kZXhPZiggZmF1eEJhc2UgKSA9PT0gMDsKfQoKLy8gVGhhbmtzIE1vZGVybml6cgpmdW5jdGlvbiBjc3NQb2ludGVyRXZlbnRzVGVzdCgpIHsKCXZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggIngiICksCgkJZG9jdW1lbnRFbGVtZW50ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LAoJCWdldENvbXB1dGVkU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSwKCQlzdXBwb3J0czsKCglpZiAoICEoICJwb2ludGVyRXZlbnRzIiBpbiBlbGVtZW50LnN0eWxlICkgKSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICJhdXRvIjsKCWVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICJ4IjsKCWRvY3VtZW50RWxlbWVudC5hcHBlbmRDaGlsZCggZWxlbWVudCApOwoJc3VwcG9ydHMgPSBnZXRDb21wdXRlZFN0eWxlICYmCglnZXRDb21wdXRlZFN0eWxlKCBlbGVtZW50LCAiIiApLnBvaW50ZXJFdmVudHMgPT09ICJhdXRvIjsKCWRvY3VtZW50RWxlbWVudC5yZW1vdmVDaGlsZCggZWxlbWVudCApOwoJcmV0dXJuICEhc3VwcG9ydHM7Cn0KCmZ1bmN0aW9uIGJvdW5kaW5nUmVjdCgpIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJcmV0dXJuIHR5cGVvZiBkaXYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0ICE9PSAidW5kZWZpbmVkIjsKfQoKLy8gbm9uLVVBLWJhc2VkIElFIHZlcnNpb24gY2hlY2sgYnkgSmFtZXMgUGFkb2xzZXksIG1vZGlmaWVkIGJ5IGpkYWx0b24gLSBmcm9tIGh0dHA6Ly9naXN0LmdpdGh1Yi5jb20vNTI3NjgzCi8vIGFsbG93cyBmb3IgaW5jbHVzaW9uIG9mIElFIDYrLCBpbmNsdWRpbmcgV2luZG93cyBNb2JpbGUgNwokLmV4dGVuZCggJC5tb2JpbGUsIHsgYnJvd3Nlcjoge30gfSApOwokLm1vYmlsZS5icm93c2VyLm9sZElFID0gKGZ1bmN0aW9uKCkgewoJdmFyIHYgPSAzLAoJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCgkJYSA9IGRpdi5hbGwgfHwgW107CgoJZG8gewoJCWRpdi5pbm5lckhUTUwgPSAiPCEtLVtpZiBndCBJRSAiICsgKCArK3YgKSArICJdPjxicj48IVtlbmRpZl0tLT4iOwoJfSB3aGlsZSggYVswXSApOwoKCXJldHVybiB2ID4gNCA/IHYgOiAhdjsKfSkoKTsKCmZ1bmN0aW9uIGZpeGVkUG9zaXRpb24oKSB7Cgl2YXIgdyA9IHdpbmRvdywKCQl1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0sCgkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTldKykvICksCgkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQlmZm1hdGNoID0gdWEubWF0Y2goIC9GZW5uZWNcLyhbMC05XSspLyApLAoJCWZmdmVyc2lvbiA9ICEhZmZtYXRjaCAmJiBmZm1hdGNoWyAxIF0sCgkJb3BlcmFtbW9iaWxlbWF0Y2ggPSB1YS5tYXRjaCggL09wZXJhIE1vYmlcLyhbMC05XSspLyApLAoJCW9tdmVyc2lvbiA9ICEhb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb3BlcmFtbW9iaWxlbWF0Y2hbIDEgXTsKCglpZiAoCgkJLy8gaU9TIDQuMyBhbmQgb2xkZXIgOiBQbGF0Zm9ybSBpcyBpUGhvbmUvUGFkL1RvdWNoIGFuZCBXZWJraXQgdmVyc2lvbiBpcyBsZXNzIHRoYW4gNTM0IChpb3M1KQoJCSggKCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBob25lIiApID4gLTEgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQYWQiICkgPiAtMSAgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQb2QiICkgPiAtMSApICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKSB8fAoJCS8vIE9wZXJhIE1pbmkKCQkoIHcub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIgKSB8fAoJCSggb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb212ZXJzaW9uIDwgNzQ1OCApCXx8CgkJLy9BbmRyb2lkIGx0ZSAyLjE6IFBsYXRmb3JtIGlzIEFuZHJvaWQgYW5kIFdlYmtpdCB2ZXJzaW9uIGlzIGxlc3MgdGhhbiA1MzMgKEFuZHJvaWQgMi4yKQoJCSggdWEuaW5kZXhPZiggIkFuZHJvaWQiICkgPiAtMSAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTMzICkgfHwKCQkvLyBGaXJlZm94IE1vYmlsZSBiZWZvcmUgNi4wIC0KCQkoIGZmdmVyc2lvbiAmJiBmZnZlcnNpb24gPCA2ICkgfHwKCQkvLyBXZWJPUyBsZXNzIHRoYW4gMwoJCSggInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93ICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKQl8fAoJCS8vIE1lZUdvCgkJKCB1YS5pbmRleE9mKCAiTWVlR28iICkgPiAtMSAmJiB1YS5pbmRleE9mKCAiTm9raWFCcm93c2VyLzguNS4wIiApID4gLTEgKSApIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJcmV0dXJuIHRydWU7Cn0KCiQuZXh0ZW5kKCAkLnN1cHBvcnQsIHsKCWNzc1RyYW5zaXRpb25zOiAiV2ViS2l0VHJhbnNpdGlvbkV2ZW50IiBpbiB3aW5kb3cgfHwKCQl2YWxpZFN0eWxlKCAidHJhbnNpdGlvbiIsICJoZWlnaHQgMTAwbXMgbGluZWFyIiwgWyAiV2Via2l0IiwgIk1veiIsICIiIF0gKSAmJgoJCSEkLm1vYmlsZS5icm93c2VyLm9sZElFICYmICFvcGVyYSwKCgkvLyBOb3RlLCBDaHJvbWUgZm9yIGlPUyBoYXMgYW4gZXh0cmVtZWx5IHF1aXJreSBpbXBsZW1lbnRhdGlvbiBvZiBwb3BzdGF0ZS4KCS8vIFdlJ3ZlIGNob3NlbiB0byB0YWtlIHRoZSBzaG9ydGVzdCBwYXRoIHRvIGEgYnVnIGZpeCBoZXJlIGZvciBpc3N1ZSAjNTQyNgoJLy8gU2VlIHRoZSBmb2xsb3dpbmcgbGluayBmb3IgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHJlZ2V4IGNob3NlbgoJLy8gaHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vY2hyb21lL21vYmlsZS9kb2NzL3VzZXItYWdlbnQjY2hyb21lX2Zvcl9pb3NfdXNlci1hZ2VudAoJcHVzaFN0YXRlOiAicHVzaFN0YXRlIiBpbiBoaXN0b3J5ICYmCgkJInJlcGxhY2VTdGF0ZSIgaW4gaGlzdG9yeSAmJgoJCS8vIFdoZW4gcnVubmluZyBpbnNpZGUgYSBGRiBpZnJhbWUsIGNhbGxpbmcgcmVwbGFjZVN0YXRlIGNhdXNlcyBhbiBlcnJvcgoJCSEoIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJGaXJlZm94IiApID49IDAgJiYgd2luZG93LnRvcCAhPT0gd2luZG93ICkgJiYKCQkoIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LnNlYXJjaCgvQ3JpT1MvKSA9PT0gLTEgKSwKCgltZWRpYXF1ZXJ5OiAkLm1vYmlsZS5tZWRpYSggIm9ubHkgYWxsIiApLAoJY3NzUHNldWRvRWxlbWVudDogISFwcm9wRXhpc3RzKCAiY29udGVudCIgKSwKCXRvdWNoT3ZlcmZsb3c6ICEhcHJvcEV4aXN0cyggIm92ZXJmbG93U2Nyb2xsaW5nIiApLAoJY3NzVHJhbnNmb3JtM2Q6IHRyYW5zZm9ybTNkVGVzdCgpLAoJY3NzQW5pbWF0aW9uczogISFwcm9wRXhpc3RzKCAiYW5pbWF0aW9uTmFtZSIgKSwKCWJveFNoYWRvdzogISFwcm9wRXhpc3RzKCAiYm94U2hhZG93IiApICYmICFiYiwKCWZpeGVkUG9zaXRpb246IGZpeGVkUG9zaXRpb24oKSwKCXNjcm9sbFRvcDogKCJwYWdlWE9mZnNldCIgaW4gd2luZG93IHx8CgkJInNjcm9sbFRvcCIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IHx8CgkJInNjcm9sbFRvcCIgaW4gZmFrZUJvZHlbIDAgXSkgJiYgIXdlYm9zICYmICFvcGVyYW1pbmksCgoJZHluYW1pY0Jhc2VUYWc6IGJhc2VUYWdUZXN0KCksCgljc3NQb2ludGVyRXZlbnRzOiBjc3NQb2ludGVyRXZlbnRzVGVzdCgpLAoJYm91bmRpbmdSZWN0OiBib3VuZGluZ1JlY3QoKSwKCWlubGluZVNWRzogaW5saW5lU1ZHCn0pOwoKZmFrZUJvZHkucmVtb3ZlKCk7CgovLyAkLm1vYmlsZS5hamF4QmxhY2tsaXN0IGlzIHVzZWQgdG8gb3ZlcnJpZGUgYWpheEVuYWJsZWQgb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBrbm93biBjb25mbGljdHMgd2l0aCBoYXNoIGhpc3RvcnkgdXBkYXRlcyAoQkI1LCBTeW1iaWFuKQovLyBvciB0aGF0IGdlbmVyYWxseSB3b3JrIGJldHRlciBicm93c2luZyBpbiByZWd1bGFyIGh0dHAgZm9yIGZ1bGwgcGFnZSByZWZyZXNoZXMgKE9wZXJhIE1pbmkpCi8vIE5vdGU6IFRoaXMgZGV0ZWN0aW9uIGJlbG93IGlzIHVzZWQgYXMgYSBsYXN0IHJlc29ydC4KLy8gV2UgcmVjb21tZW5kIG9ubHkgdXNpbmcgdGhlc2UgZGV0ZWN0aW9uIG1ldGhvZHMgd2hlbiBhbGwgb3RoZXIgbW9yZSByZWxpYWJsZS9mb3J3YXJkLWxvb2tpbmcgYXBwcm9hY2hlcyBhcmUgbm90IHBvc3NpYmxlCm5va2lhTFRFN18zID0gKGZ1bmN0aW9uKCkgewoKCXZhciB1YSA9IHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50OwoKCS8vVGhlIGZvbGxvd2luZyBpcyBhbiBhdHRlbXB0IHRvIG1hdGNoIE5va2lhIGJyb3dzZXJzIHRoYXQgYXJlIHJ1bm5pbmcgU3ltYmlhbi9zNjAsIHdpdGggd2Via2l0LCB2ZXJzaW9uIDcuMyBvciBvbGRlcgoJcmV0dXJuIHVhLmluZGV4T2YoICJOb2tpYSIgKSA+IC0xICYmCgkJCSggdWEuaW5kZXhPZiggIlN5bWJpYW4vMyIgKSA+IC0xIHx8IHVhLmluZGV4T2YoICJTZXJpZXM2MC81IiApID4gLTEgKSAmJgoJCQl1YS5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSAmJgoJCQl1YS5tYXRjaCggLyhCcm93c2VyTkd8Tm9raWFCcm93c2VyKVwvN1wuWzAtM10vICk7Cn0pKCk7CgovLyBTdXBwb3J0IGNvbmRpdGlvbnMgdGhhdCBtdXN0IGJlIG1ldCBpbiBvcmRlciB0byBwcm9jZWVkCi8vIGRlZmF1bHQgZW5oYW5jZWQgcXVhbGlmaWNhdGlvbnMgYXJlIG1lZGlhIHF1ZXJ5IHN1cHBvcnQgT1IgSUUgNysKCiQubW9iaWxlLmdyYWRlQSA9IGZ1bmN0aW9uKCkgewoJcmV0dXJuICggKCAkLnN1cHBvcnQubWVkaWFxdWVyeSAmJiAkLnN1cHBvcnQuY3NzUHNldWRvRWxlbWVudCApIHx8ICQubW9iaWxlLmJyb3dzZXIub2xkSUUgJiYgJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSA+PSA4ICkgJiYgKCAkLnN1cHBvcnQuYm91bmRpbmdSZWN0IHx8ICQuZm4uanF1ZXJ5Lm1hdGNoKC8xXC5bMC03K11cLlswLTkrXT8vKSAhPT0gbnVsbCApOwp9OwoKJC5tb2JpbGUuYWpheEJsYWNrbGlzdCA9CgkJCS8vIEJsYWNrQmVycnkgYnJvd3NlcnMsIHByZS13ZWJraXQKCQkJd2luZG93LmJsYWNrYmVycnkgJiYgIXdpbmRvdy5XZWJLaXRQb2ludCB8fAoJCQkvLyBPcGVyYSBNaW5pCgkJCW9wZXJhbWluaSB8fAoJCQkvLyBTeW1iaWFuIHdlYmtpdHMgcHJlIDcuMwoJCQlub2tpYUxURTdfMzsKCi8vIExhc3RseSwgdGhpcyB3b3JrYXJvdW5kIGlzIHRoZSBvbmx5IHdheSB3ZSd2ZSBmb3VuZCBzbyBmYXIgdG8gZ2V0IHByZSA3LjMgU3ltYmlhbiB3ZWJraXQgZGV2aWNlcwovLyB0byByZW5kZXIgdGhlIHN0eWxlc2hlZXRzIHdoZW4gdGhleSdyZSByZWZlcmVuY2VkIGJlZm9yZSB0aGlzIHNjcmlwdCwgYXMgd2UnZCByZWNvbW1lbmQgZG9pbmcuCi8vIFRoaXMgc2ltcGx5IHJlYXBwZW5kcyB0aGUgQ1NTIGluIHBsYWNlLCB3aGljaCBmb3Igc29tZSByZWFzb24gbWFrZXMgaXQgYXBwbHkKaWYgKCBub2tpYUxURTdfMyApIHsKCSQoZnVuY3Rpb24oKSB7CgkJJCggImhlYWQgbGlua1tyZWw9J3N0eWxlc2hlZXQnXSIgKS5hdHRyKCAicmVsIiwgImFsdGVybmF0ZSBzdHlsZXNoZWV0IiApLmF0dHIoICJyZWwiLCAic3R5bGVzaGVldCIgKTsKCX0pOwp9CgovLyBGb3IgcnVsaW5nIG91dCBzaGFkb3dzIHZpYSBjc3MKaWYgKCAhJC5zdXBwb3J0LmJveFNoYWRvdyApIHsKCSQoICJodG1sIiApLmFkZENsYXNzKCAidWktbm9ib3hzaGFkb3ciICk7Cn0KCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCXZhciAkd2luID0gJC5tb2JpbGUud2luZG93LCBzZWxmLAoJCWR1bW15Rm5Ub0luaXROYXZpZ2F0ZSA9IGZ1bmN0aW9uKCkgewoJCX07CgoJJC5ldmVudC5zcGVjaWFsLmJlZm9yZW5hdmlnYXRlID0gewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJJHdpbi5vbiggIm5hdmlnYXRlIiwgZHVtbXlGblRvSW5pdE5hdmlnYXRlICk7CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkkd2luLm9mZiggIm5hdmlnYXRlIiwgZHVtbXlGblRvSW5pdE5hdmlnYXRlICk7CgkJfQoJfTsKCgkkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUgPSBzZWxmID0gewoJCWJvdW5kOiBmYWxzZSwKCgkJcHVzaFN0YXRlRW5hYmxlZDogdHJ1ZSwKCgkJb3JpZ2luYWxFdmVudE5hbWU6IHVuZGVmaW5lZCwKCgkJLy8gSWYgcHVzaHN0YXRlIHN1cHBvcnQgaXMgcHJlc2VudCBhbmQgcHVzaCBzdGF0ZSBzdXBwb3J0IGlzIGRlZmluZWQgdG8KCQkvLyBiZSB0cnVlIG9uIHRoZSBtb2JpbGUgbmFtZXNwYWNlLgoJCWlzUHVzaFN0YXRlRW5hYmxlZDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLnN1cHBvcnQucHVzaFN0YXRlICYmCgkJCQkkLm1vYmlsZS5wdXNoU3RhdGVFbmFibGVkID09PSB0cnVlICYmCgkJCQl0aGlzLmlzSGFzaENoYW5nZUVuYWJsZWQoKTsKCQl9LAoKCQkvLyAhISBhc3N1bWVzIG1vYmlsZSBuYW1lc3BhY2UgaXMgcHJlc2VudAoJCWlzSGFzaENoYW5nZUVuYWJsZWQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgPT09IHRydWU7CgkJfSwKCgkJLy8gVE9ETyBhIGxvdCBvZiBkdXBsaWNhdGlvbiBiZXR3ZWVuIHBvcHN0YXRlIGFuZCBoYXNoY2hhbmdlCgkJcG9wc3RhdGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIG5ld0V2ZW50ID0gbmV3ICQuRXZlbnQoICJuYXZpZ2F0ZSIgKSwKCQkJCWJlZm9yZU5hdmlnYXRlID0gbmV3ICQuRXZlbnQoICJiZWZvcmVuYXZpZ2F0ZSIgKSwKCQkJCXN0YXRlID0gZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSB8fCB7fTsKCgkJCWJlZm9yZU5hdmlnYXRlLm9yaWdpbmFsRXZlbnQgPSBldmVudDsKCQkJJHdpbi50cmlnZ2VyKCBiZWZvcmVOYXZpZ2F0ZSApOwoKCQkJaWYgKCBiZWZvcmVOYXZpZ2F0ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCBldmVudC5oaXN0b3J5U3RhdGUgKSB7CgkJCQkkLmV4dGVuZChzdGF0ZSwgZXZlbnQuaGlzdG9yeVN0YXRlKTsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHRoZSBvcmlnaW5hbCBldmVudCBpcyB0cmFja2VkIGZvciB0aGUgZW5kCgkJCS8vIHVzZXIgdG8gaW5zcGVjdCBpbmNhc2UgdGhleSB3YW50IHRvIGRvIHNvbWV0aGluZyBzcGVjaWFsCgkJCW5ld0V2ZW50Lm9yaWdpbmFsRXZlbnQgPSBldmVudDsKCgkJCS8vIE5PVEUgd2UgbGV0IHRoZSBjdXJyZW50IHN0YWNrIHVud2luZCBiZWNhdXNlIGFueSBhc3NpZ25tZW50IHRvCgkJCS8vICAgICAgbG9jYXRpb24uaGFzaCB3aWxsIHN0b3AgdGhlIHdvcmxkIGFuZCBydW4gdGhpcyBldmVudCBoYW5kbGVyLiBCeQoJCQkvLyAgICAgIGRvaW5nIHRoaXMgd2UgY3JlYXRlIGEgc2ltaWxhciBiZWhhdmlvciB0byBoYXNoY2hhbmdlIG9uIGhhc2gKCQkJLy8gICAgICBhc3NpZ25tZW50CgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkkd2luLnRyaWdnZXIoIG5ld0V2ZW50LCB7CgkJCQkJc3RhdGU6IHN0YXRlCgkJCQl9KTsKCQkJfSwgMCk7CgkJfSwKCgkJaGFzaGNoYW5nZTogZnVuY3Rpb24oIGV2ZW50IC8qLCBkYXRhICovICkgewoJCQl2YXIgbmV3RXZlbnQgPSBuZXcgJC5FdmVudCggIm5hdmlnYXRlIiApLAoJCQkJYmVmb3JlTmF2aWdhdGUgPSBuZXcgJC5FdmVudCggImJlZm9yZW5hdmlnYXRlIiApOwoKCQkJYmVmb3JlTmF2aWdhdGUub3JpZ2luYWxFdmVudCA9IGV2ZW50OwoJCQkkd2luLnRyaWdnZXIoIGJlZm9yZU5hdmlnYXRlICk7CgoJCQlpZiAoIGJlZm9yZU5hdmlnYXRlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgdGhlIG9yaWdpbmFsIGV2ZW50IGlzIHRyYWNrZWQgZm9yIHRoZSBlbmQKCQkJLy8gdXNlciB0byBpbnNwZWN0IGluY2FzZSB0aGV5IHdhbnQgdG8gZG8gc29tZXRoaW5nIHNwZWNpYWwKCQkJbmV3RXZlbnQub3JpZ2luYWxFdmVudCA9IGV2ZW50OwoKCQkJLy8gVHJpZ2dlciB0aGUgaGFzaGNoYW5nZSB3aXRoIHN0YXRlIHByb3ZpZGVkIGJ5IHRoZSB1c2VyCgkJCS8vIHRoYXQgYWx0ZXJlZCB0aGUgaGFzaAoJCQkkd2luLnRyaWdnZXIoIG5ld0V2ZW50LCB7CgkJCQkvLyBVc2VycyB0aGF0IHdhbnQgdG8gZnVsbHkgbm9ybWFsaXplIHRoZSB0d28gZXZlbnRzCgkJCQkvLyB3aWxsIG5lZWQgdG8gZG8gaGlzdG9yeSBtYW5hZ2VtZW50IGRvd24gdGhlIHN0YWNrIGFuZAoJCQkJLy8gYWRkIHRoZSBzdGF0ZSB0byB0aGUgZXZlbnQgYmVmb3JlIHRoaXMgYmluZGluZyBpcyBmaXJlZAoJCQkJLy8gVE9ETyBjb25zaWRlciBhbGxvd2luZyBmb3IgdGhlIGV4cGxpY2l0IGFkZGl0aW9uIG9mIGNhbGxiYWNrcwoJCQkJLy8gICAgICB0byBiZSBmaXJlZCBiZWZvcmUgdGhpcyB2YWx1ZSBpcyBzZXQgdG8gYXZvaWQgZXZlbnQgdGltaW5nIGlzc3VlcwoJCQkJc3RhdGU6IGV2ZW50Lmhhc2hjaGFuZ2VTdGF0ZSB8fCB7fQoJCQl9KTsKCQl9LAoKCQkvLyBUT0RPIFdlIHJlYWxseSBvbmx5IHdhbnQgdG8gc2V0IHRoaXMgdXAgb25jZQoJCS8vICAgICAgYnV0IEknbSBub3QgY2xlYXIgaWYgdGhlcmUncyBhIGJldGVyIHdheSB0byBhY2hpZXZlCgkJLy8gICAgICB0aGlzIHdpdGggdGhlIGpRdWVyeSBzcGVjaWFsIGV2ZW50IHN0cnVjdHVyZQoJCXNldHVwOiBmdW5jdGlvbiggLyogZGF0YSwgbmFtZXNwYWNlcyAqLyApIHsKCQkJaWYgKCBzZWxmLmJvdW5kICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlzZWxmLmJvdW5kID0gdHJ1ZTsKCgkJCWlmICggc2VsZi5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCXNlbGYub3JpZ2luYWxFdmVudE5hbWUgPSAicG9wc3RhdGUiOwoJCQkJJHdpbi5iaW5kKCAicG9wc3RhdGUubmF2aWdhdGUiLCBzZWxmLnBvcHN0YXRlICk7CgkJCX0gZWxzZSBpZiAoIHNlbGYuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpICkgewoJCQkJc2VsZi5vcmlnaW5hbEV2ZW50TmFtZSA9ICJoYXNoY2hhbmdlIjsKCQkJCSR3aW4uYmluZCggImhhc2hjaGFuZ2UubmF2aWdhdGUiLCBzZWxmLmhhc2hjaGFuZ2UgKTsKCQkJfQoJCX0KCX07Cn0pKCBqUXVlcnkgKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJdmFyIHBhdGgsICRiYXNlLCBkaWFsb2dIYXNoS2V5ID0gIiZ1aS1zdGF0ZT1kaWFsb2ciOwoKCQkkLm1vYmlsZS5wYXRoID0gcGF0aCA9IHsKCQkJdWlTdGF0ZUtleTogIiZ1aS1zdGF0ZSIsCgoJCQkvLyBUaGlzIHNjYXJ5IGxvb2tpbmcgcmVndWxhciBleHByZXNzaW9uIHBhcnNlcyBhbiBhYnNvbHV0ZSBVUkwgb3IgaXRzIHJlbGF0aXZlCgkJCS8vIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBhbmQgaGFzaCksIGludG8gdGhlIHZhcmlvdXMKCQkJLy8gY29tcG9uZW50cyAocHJvdG9jb2wsIGhvc3QsIHBhdGgsIHF1ZXJ5LCBmcmFnbWVudCwgZXRjIHRoYXQgbWFrZSB1cCB0aGUKCQkJLy8gVVJMIGFzIHdlbGwgYXMgc29tZSBvdGhlciBjb21tb25seSB1c2VkIHN1Yi1wYXJ0cy4gV2hlbiB1c2VkIHdpdGggUmVnRXhwLmV4ZWMoKQoJCQkvLyBvciBTdHJpbmcubWF0Y2gsIGl0IHBhcnNlcyB0aGUgVVJMIGludG8gYSByZXN1bHRzIGFycmF5IHRoYXQgbG9va3MgbGlrZSB0aGlzOgoJCQkvLwoJCQkvLyAgICAgWzBdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3g/bXNnPTEyMzQmdHlwZT11bnJlYWQjbXNnLWNvbnRlbnQKCQkJLy8gICAgIFsxXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgICBbMl06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveAoJCQkvLyAgICAgWzNdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgICBbNF06IGh0dHA6CgkJCS8vICAgICBbNV06IC8vCgkJCS8vICAgICBbNl06IGpibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzddOiBqYmxhczpwYXNzd29yZAoJCQkvLyAgICAgWzhdOiBqYmxhcwoJCQkvLyAgICAgWzldOiBwYXNzd29yZAoJCQkvLyAgICBbMTBdOiBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgWzExXTogbXljb21wYW55LmNvbQoJCQkvLyAgICBbMTJdOiA4MDgwCgkJCS8vICAgIFsxM106IC9tYWlsL2luYm94CgkJCS8vICAgIFsxNF06IC9tYWlsLwoJCQkvLyAgICBbMTVdOiBpbmJveAoJCQkvLyAgICBbMTZdOiA/bXNnPTEyMzQmdHlwZT11bnJlYWQKCQkJLy8gICAgWzE3XTogI21zZy1jb250ZW50CgkJCS8vCgkJCXVybFBhcnNlUkU6IC9eXHMqKCgoKFteOlwvI1w/XSs6KT8oPzooXC9cLykoKD86KChbXjpAXC8jXD9dKykoPzpcOihbXjpAXC8jXD9dKykpPylAKT8oKFteOlwvI1w/XF1cW10rfFxbW15cL1xdQCM/XStcXSkoPzpcOihbMC05XSspKT8pKT8pPyk/KChcLz8oPzpbXlwvXD8jXStcLyspKikoW15cPyNdKikpKT8oXD9bXiNdKyk/KSgjLiopPy8sCgoJCQkvLyBBYnN0cmFjdGlvbiB0byBhZGRyZXNzIHhzcyAoSXNzdWUgIzQ3ODcpIGJ5IHJlbW92aW5nIHRoZSBhdXRob3JpdHkgaW4KCQkJLy8gYnJvd3NlcnMgdGhhdCBhdXRvCWRlY29kZSBpdC4gQWxsIHJlZmVyZW5jZXMgdG8gbG9jYXRpb24uaHJlZiBzaG91bGQgYmUKCQkJLy8gcmVwbGFjZWQgd2l0aCBhIGNhbGwgdG8gdGhpcyBtZXRob2Qgc28gdGhhdCBpdCBjYW4gYmUgZGVhbHQgd2l0aCBwcm9wZXJseSBoZXJlCgkJCWdldExvY2F0aW9uOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHVyaSA9IHVybCA/IHRoaXMucGFyc2VVcmwoIHVybCApIDogbG9jYXRpb24sCgkJCQkJaGFzaCA9IHRoaXMucGFyc2VVcmwoIHVybCB8fCBsb2NhdGlvbi5ocmVmICkuaGFzaDsKCgkJCQkvLyBtaW1pYyB0aGUgYnJvd3NlciB3aXRoIGFuIGVtcHR5IHN0cmluZyB3aGVuIHRoZSBoYXNoIGlzIGVtcHR5CgkJCQloYXNoID0gaGFzaCA9PT0gIiMiID8gIiIgOiBoYXNoOwoKCQkJCS8vIE1ha2Ugc3VyZSB0byBwYXJzZSB0aGUgdXJsIG9yIHRoZSBsb2NhdGlvbiBvYmplY3QgZm9yIHRoZSBoYXNoIGJlY2F1c2UgdXNpbmcgbG9jYXRpb24uaGFzaAoJCQkJLy8gaXMgYXV0b2RlY29kZWQgaW4gZmlyZWZveCwgdGhlIHJlc3Qgb2YgdGhlIHVybCBzaG91bGQgYmUgZnJvbSB0aGUgb2JqZWN0IChsb2NhdGlvbiB1bmxlc3MKCQkJCS8vIHdlJ3JlIHRlc3RpbmcpIHRvIGF2b2lkIHRoZSBpbmNsdXNpb24gb2YgdGhlIGF1dGhvcml0eQoJCQkJcmV0dXJuIHVyaS5wcm90b2NvbCArICIvLyIgKyB1cmkuaG9zdCArIHVyaS5wYXRobmFtZSArIHVyaS5zZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IHVybAoJCQlnZXREb2N1bWVudFVybDogZnVuY3Rpb24oIGFzUGFyc2VkT2JqZWN0ICkgewoJCQkJcmV0dXJuIGFzUGFyc2VkT2JqZWN0ID8gJC5leHRlbmQoIHt9LCBwYXRoLmRvY3VtZW50VXJsICkgOiBwYXRoLmRvY3VtZW50VXJsLmhyZWY7CgkJCX0sCgoJCQlwYXJzZUxvY2F0aW9uOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB0aGlzLnBhcnNlVXJsKCB0aGlzLmdldExvY2F0aW9uKCkgKTsKCQkJfSwKCgkJCS8vUGFyc2UgYSBVUkwgaW50byBhIHN0cnVjdHVyZSB0aGF0IGFsbG93cyBlYXN5IGFjY2VzcyB0bwoJCQkvL2FsbCBvZiB0aGUgVVJMIGNvbXBvbmVudHMgYnkgbmFtZS4KCQkJcGFyc2VVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBJZiB3ZSdyZSBwYXNzZWQgYW4gb2JqZWN0LCB3ZSdsbCBhc3N1bWUgdGhhdCBpdCBpcwoJCQkJLy8gYSBwYXJzZWQgdXJsIG9iamVjdCBhbmQganVzdCByZXR1cm4gaXQgYmFjayB0byB0aGUgY2FsbGVyLgoJCQkJaWYgKCAkLnR5cGUoIHVybCApID09PSAib2JqZWN0IiApIHsKCQkJCQlyZXR1cm4gdXJsOwoJCQkJfQoKCQkJCXZhciBtYXRjaGVzID0gcGF0aC51cmxQYXJzZVJFLmV4ZWMoIHVybCB8fCAiIiApIHx8IFtdOwoKCQkJCQkvLyBDcmVhdGUgYW4gb2JqZWN0IHRoYXQgYWxsb3dzIHRoZSBjYWxsZXIgdG8gYWNjZXNzIHRoZSBzdWItbWF0Y2hlcwoJCQkJCS8vIGJ5IG5hbWUuIE5vdGUgdGhhdCBJRSByZXR1cm5zIGFuIGVtcHR5IHN0cmluZyBpbnN0ZWFkIG9mIHVuZGVmaW5lZCwKCQkJCQkvLyBsaWtlIGFsbCBvdGhlciBicm93c2VycyBkbywgc28gd2Ugbm9ybWFsaXplIGV2ZXJ5dGhpbmcgc28gaXRzIGNvbnNpc3RlbnQKCQkJCQkvLyBubyBtYXR0ZXIgd2hhdCBicm93c2VyIHdlJ3JlIHJ1bm5pbmcgb24uCgkJCQkJcmV0dXJuIHsKCQkJCQkJaHJlZjogICAgICAgICBtYXRjaGVzWyAgMCBdIHx8ICIiLAoJCQkJCQlocmVmTm9IYXNoOiAgIG1hdGNoZXNbICAxIF0gfHwgIiIsCgkJCQkJCWhyZWZOb1NlYXJjaDogbWF0Y2hlc1sgIDIgXSB8fCAiIiwKCQkJCQkJZG9tYWluOiAgICAgICBtYXRjaGVzWyAgMyBdIHx8ICIiLAoJCQkJCQlwcm90b2NvbDogICAgIG1hdGNoZXNbICA0IF0gfHwgIiIsCgkJCQkJCWRvdWJsZVNsYXNoOiAgbWF0Y2hlc1sgIDUgXSB8fCAiIiwKCQkJCQkJYXV0aG9yaXR5OiAgICBtYXRjaGVzWyAgNiBdIHx8ICIiLAoJCQkJCQl1c2VybmFtZTogICAgIG1hdGNoZXNbICA4IF0gfHwgIiIsCgkJCQkJCXBhc3N3b3JkOiAgICAgbWF0Y2hlc1sgIDkgXSB8fCAiIiwKCQkJCQkJaG9zdDogICAgICAgICBtYXRjaGVzWyAxMCBdIHx8ICIiLAoJCQkJCQlob3N0bmFtZTogICAgIG1hdGNoZXNbIDExIF0gfHwgIiIsCgkJCQkJCXBvcnQ6ICAgICAgICAgbWF0Y2hlc1sgMTIgXSB8fCAiIiwKCQkJCQkJcGF0aG5hbWU6ICAgICBtYXRjaGVzWyAxMyBdIHx8ICIiLAoJCQkJCQlkaXJlY3Rvcnk6ICAgIG1hdGNoZXNbIDE0IF0gfHwgIiIsCgkJCQkJCWZpbGVuYW1lOiAgICAgbWF0Y2hlc1sgMTUgXSB8fCAiIiwKCQkJCQkJc2VhcmNoOiAgICAgICBtYXRjaGVzWyAxNiBdIHx8ICIiLAoJCQkJCQloYXNoOiAgICAgICAgIG1hdGNoZXNbIDE3IF0gfHwgIiIKCQkJCQl9OwoJCQl9LAoKCQkJLy9UdXJuIHJlbFBhdGggaW50byBhbiBhc2JvbHV0ZSBwYXRoLiBhYnNQYXRoIGlzCgkJCS8vYW4gb3B0aW9uYWwgYWJzb2x1dGUgcGF0aCB3aGljaCBkZXNjcmliZXMgd2hhdAoJCQkvL3JlbFBhdGggaXMgcmVsYXRpdmUgdG8uCgkJCW1ha2VQYXRoQWJzb2x1dGU6IGZ1bmN0aW9uKCByZWxQYXRoLCBhYnNQYXRoICkgewoJCQkJdmFyIGFic1N0YWNrLAoJCQkJCXJlbFN0YWNrLAoJCQkJCWksIGQ7CgoJCQkJaWYgKCByZWxQYXRoICYmIHJlbFBhdGguY2hhckF0KCAwICkgPT09ICIvIiApIHsKCQkJCQlyZXR1cm4gcmVsUGF0aDsKCQkJCX0KCgkJCQlyZWxQYXRoID0gcmVsUGF0aCB8fCAiIjsKCQkJCWFic1BhdGggPSBhYnNQYXRoID8gYWJzUGF0aC5yZXBsYWNlKCAvXlwvfChcL1teXC9dKnxbXlwvXSspJC9nLCAiIiApIDogIiI7CgoJCQkJYWJzU3RhY2sgPSBhYnNQYXRoID8gYWJzUGF0aC5zcGxpdCggIi8iICkgOiBbXTsKCQkJCXJlbFN0YWNrID0gcmVsUGF0aC5zcGxpdCggIi8iICk7CgoJCQkJZm9yICggaSA9IDA7IGkgPCByZWxTdGFjay5sZW5ndGg7IGkrKyApIHsKCQkJCQlkID0gcmVsU3RhY2tbIGkgXTsKCQkJCQlzd2l0Y2ggKCBkICkgewoJCQkJCQljYXNlICIuIjoKCQkJCQkJCWJyZWFrOwoJCQkJCQljYXNlICIuLiI6CgkJCQkJCQlpZiAoIGFic1N0YWNrLmxlbmd0aCApIHsKCQkJCQkJCQlhYnNTdGFjay5wb3AoKTsKCQkJCQkJCX0KCQkJCQkJCWJyZWFrOwoJCQkJCQlkZWZhdWx0OgoJCQkJCQkJYWJzU3RhY2sucHVzaCggZCApOwoJCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuICIvIiArIGFic1N0YWNrLmpvaW4oICIvIiApOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgaWYgYm90aCB1cmxzIGhhdmUgdGhlIHNhbWUgZG9tYWluLgoJCQlpc1NhbWVEb21haW46IGZ1bmN0aW9uKCBhYnNVcmwxLCBhYnNVcmwyICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIGFic1VybDEgKS5kb21haW4gPT09IHBhdGgucGFyc2VVcmwoIGFic1VybDIgKS5kb21haW47CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW55IHJlbGF0aXZlIHZhcmlhbnQuCgkJCWlzUmVsYXRpdmVVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBBbGwgcmVsYXRpdmUgVXJsIHZhcmlhbnRzIGhhdmUgb25lIHRoaW5nIGluIGNvbW1vbiwgbm8gcHJvdG9jb2wuCgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggdXJsICkucHJvdG9jb2wgPT09ICIiOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgZm9yIGFuIGFic29sdXRlIHVybC4KCQkJaXNBYnNvbHV0ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCAhPT0gIiI7CgkJCX0sCgoJCQkvL1R1cm4gdGhlIHNwZWNpZmllZCByZWFsdGl2ZSBVUkwgaW50byBhbiBhYnNvbHV0ZSBvbmUuIFRoaXMgZnVuY3Rpb24KCQkJLy9jYW4gaGFuZGxlIGFsbCByZWxhdGl2ZSB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgZnJhZ21lbnQpLgoJCQltYWtlVXJsQWJzb2x1dGU6IGZ1bmN0aW9uKCByZWxVcmwsIGFic1VybCApIHsKCQkJCWlmICggIXBhdGguaXNSZWxhdGl2ZVVybCggcmVsVXJsICkgKSB7CgkJCQkJcmV0dXJuIHJlbFVybDsKCQkJCX0KCgkJCQlpZiAoIGFic1VybCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCWFic1VybCA9IHRoaXMuZG9jdW1lbnRCYXNlOwoJCQkJfQoKCQkJCXZhciByZWxPYmogPSBwYXRoLnBhcnNlVXJsKCByZWxVcmwgKSwKCQkJCQlhYnNPYmogPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKSwKCQkJCQlwcm90b2NvbCA9IHJlbE9iai5wcm90b2NvbCB8fCBhYnNPYmoucHJvdG9jb2wsCgkJCQkJZG91YmxlU2xhc2ggPSByZWxPYmoucHJvdG9jb2wgPyByZWxPYmouZG91YmxlU2xhc2ggOiAoIHJlbE9iai5kb3VibGVTbGFzaCB8fCBhYnNPYmouZG91YmxlU2xhc2ggKSwKCQkJCQlhdXRob3JpdHkgPSByZWxPYmouYXV0aG9yaXR5IHx8IGFic09iai5hdXRob3JpdHksCgkJCQkJaGFzUGF0aCA9IHJlbE9iai5wYXRobmFtZSAhPT0gIiIsCgkJCQkJcGF0aG5hbWUgPSBwYXRoLm1ha2VQYXRoQWJzb2x1dGUoIHJlbE9iai5wYXRobmFtZSB8fCBhYnNPYmouZmlsZW5hbWUsIGFic09iai5wYXRobmFtZSApLAoJCQkJCXNlYXJjaCA9IHJlbE9iai5zZWFyY2ggfHwgKCAhaGFzUGF0aCAmJiBhYnNPYmouc2VhcmNoICkgfHwgIiIsCgkJCQkJaGFzaCA9IHJlbE9iai5oYXNoOwoKCQkJCXJldHVybiBwcm90b2NvbCArIGRvdWJsZVNsYXNoICsgYXV0aG9yaXR5ICsgcGF0aG5hbWUgKyBzZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJLy9BZGQgc2VhcmNoIChha2EgcXVlcnkpIHBhcmFtcyB0byB0aGUgc3BlY2lmaWVkIHVybC4KCQkJYWRkU2VhcmNoUGFyYW1zOiBmdW5jdGlvbiggdXJsLCBwYXJhbXMgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApLAoJCQkJCXAgPSAoIHR5cGVvZiBwYXJhbXMgPT09ICJvYmplY3QiICkgPyAkLnBhcmFtKCBwYXJhbXMgKSA6IHBhcmFtcywKCQkJCQlzID0gdS5zZWFyY2ggfHwgIj8iOwoJCQkJcmV0dXJuIHUuaHJlZk5vU2VhcmNoICsgcyArICggcy5jaGFyQXQoIHMubGVuZ3RoIC0gMSApICE9PSAiPyIgPyAiJiIgOiAiIiApICsgcCArICggdS5oYXNoIHx8ICIiICk7CgkJCX0sCgoJCQljb252ZXJ0VXJsVG9EYXRhVXJsOiBmdW5jdGlvbiggYWJzVXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKTsKCQkJCWlmICggcGF0aC5pc0VtYmVkZGVkUGFnZSggdSApICkgewoJCQkJCS8vIEZvciBlbWJlZGRlZCBwYWdlcywgcmVtb3ZlIHRoZSBkaWFsb2cgaGFzaCBrZXkgYXMgaW4gZ2V0RmlsZVBhdGgoKSwKCQkJCQkvLyBhbmQgcmVtb3ZlIG90aGVyd2lzZSB0aGUgRGF0YSBVcmwgd29uJ3QgbWF0Y2ggdGhlIGlkIG9mIHRoZSBlbWJlZGRlZCBQYWdlLgoJCQkJCXJldHVybiB1Lmhhc2gKCQkJCQkJLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF0KCQkJCQkJLnJlcGxhY2UoIC9eIy8sICIiICkKCQkJCQkJLnJlcGxhY2UoIC9cPy4qJC8sICIiICk7CgkJCQl9IGVsc2UgaWYgKCBwYXRoLmlzU2FtZURvbWFpbiggdSwgdGhpcy5kb2N1bWVudEJhc2UgKSApIHsKCQkJCQlyZXR1cm4gdS5ocmVmTm9IYXNoLnJlcGxhY2UoIHRoaXMuZG9jdW1lbnRCYXNlLmRvbWFpbiwgIiIgKS5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdOwoJCQkJfQoKCQkJCXJldHVybiB3aW5kb3cuZGVjb2RlVVJJQ29tcG9uZW50KGFic1VybCk7CgkJCX0sCgoJCQkvL2dldCBwYXRoIGZyb20gY3VycmVudCBoYXNoLCBvciBmcm9tIGEgZmlsZSBwYXRoCgkJCWdldDogZnVuY3Rpb24oIG5ld1BhdGggKSB7CgkJCQlpZiAoIG5ld1BhdGggPT09IHVuZGVmaW5lZCApIHsKCQkJCQluZXdQYXRoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQkJCX0KCQkJCXJldHVybiBwYXRoLnN0cmlwSGFzaCggbmV3UGF0aCApLnJlcGxhY2UoIC9bXlwvXSpcLlteXC8qXSskLywgIiIgKTsKCQkJfSwKCgkJCS8vc2V0IGxvY2F0aW9uIGhhc2ggdG8gcGF0aAoJCQlzZXQ6IGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJbG9jYXRpb24uaGFzaCA9IHBhdGg7CgkJCX0sCgoJCQkvL3Rlc3QgaWYgYSBnaXZlbiB1cmwgKHN0cmluZykgaXMgYSBwYXRoCgkJCS8vTk9URSBtaWdodCBiZSBleGNlcHRpb25hbGx5IG5haXZlCgkJCWlzUGF0aDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiAoIC9cLy8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCS8vcmV0dXJuIGEgdXJsIHBhdGggd2l0aCB0aGUgd2luZG93J3MgbG9jYXRpb24gcHJvdG9jb2wvaG9zdG5hbWUvcGF0aG5hbWUgcmVtb3ZlZAoJCQljbGVhbjogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggdGhpcy5kb2N1bWVudEJhc2UuZG9tYWluLCAiIiApOwoJCQl9LAoKCQkJLy9qdXN0IHJldHVybiB0aGUgdXJsIHdpdGhvdXQgYW4gaW5pdGlhbCAjCgkJCXN0cmlwSGFzaDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggL14jLywgIiIgKTsKCQkJfSwKCgkJCXN0cmlwUXVlcnlQYXJhbXM6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIC9cPy4qJC8sICIiICk7CgkJCX0sCgoJCQkvL3JlbW92ZSB0aGUgcHJlY2VkaW5nIGhhc2gsIGFueSBxdWVyeSBwYXJhbXMsIGFuZCBkaWFsb2cgbm90YXRpb25zCgkJCWNsZWFuSGFzaDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gcGF0aC5zdHJpcEhhc2goIGhhc2gucmVwbGFjZSggL1w/LiokLywgIiIgKS5yZXBsYWNlKCBkaWFsb2dIYXNoS2V5LCAiIiApICk7CgkJCX0sCgoJCQlpc0hhc2hWYWxpZDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gKCAvXiNbXiNdKyQvICkudGVzdCggaGFzaCApOwoJCQl9LAoKCQkJLy9jaGVjayB3aGV0aGVyIGEgdXJsIGlzIHJlZmVyZW5jaW5nIHRoZSBzYW1lIGRvbWFpbiwgb3IgYW4gZXh0ZXJuYWwgZG9tYWluIG9yIGRpZmZlcmVudCBwcm90b2NvbAoJCQkvL2NvdWxkIGJlIG1haWx0bywgZXRjCgkJCWlzRXh0ZXJuYWw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQkJcmV0dXJuIHUucHJvdG9jb2wgJiYgdS5kb21haW4gIT09IHRoaXMuZG9jdW1lbnRVcmwuZG9tYWluID8gdHJ1ZSA6IGZhbHNlOwoJCQl9LAoKCQkJaGFzUHJvdG9jb2w6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXig6P1x3KzopLyApLnRlc3QoIHVybCApOwoJCQl9LAoKCQkJaXNFbWJlZGRlZFBhZ2U6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoKCQkJCS8vaWYgdGhlIHBhdGggaXMgYWJzb2x1dGUsIHRoZW4gd2UgbmVlZCB0byBjb21wYXJlIHRoZSB1cmwgYWdhaW5zdAoJCQkJLy9ib3RoIHRoZSB0aGlzLmRvY3VtZW50VXJsIGFuZCB0aGUgZG9jdW1lbnRCYXNlLiBUaGUgbWFpbiByZWFzb24gZm9yIHRoaXMKCQkJCS8vaXMgdGhhdCBsaW5rcyBlbWJlZGRlZCB3aXRoaW4gZXh0ZXJuYWwgZG9jdW1lbnRzIHdpbGwgcmVmZXIgdG8gdGhlCgkJCQkvL2FwcGxpY2F0aW9uIGRvY3VtZW50LCB3aGVyZWFzIGxpbmtzIGVtYmVkZGVkIHdpdGhpbiB0aGUgYXBwbGljYXRpb24KCQkJCS8vZG9jdW1lbnQgd2lsbCBiZSByZXNvbHZlZCBhZ2FpbnN0IHRoZSBkb2N1bWVudCBiYXNlLgoJCQkJaWYgKCB1LnByb3RvY29sICE9PSAiIiApIHsKCQkJCQlyZXR1cm4gKCAhdGhpcy5pc1BhdGgodS5oYXNoKSAmJiB1Lmhhc2ggJiYgKCB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIHRoaXMuZG9jdW1lbnRCYXNlRGlmZmVycyAmJiB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSApICk7CgkJCQl9CgkJCQlyZXR1cm4gKCAvXiMvICkudGVzdCggdS5ocmVmICk7CgkJCX0sCgoJCQlzcXVhc2g6IGZ1bmN0aW9uKCB1cmwsIHJlc29sdXRpb25VcmwgKSB7CgkJCQl2YXIgaHJlZiwgY2xlYW5lZFVybCwgc2VhcmNoLCBzdGF0ZUluZGV4LAoJCQkJCWlzUGF0aCA9IHRoaXMuaXNQYXRoKCB1cmwgKSwKCQkJCQl1cmkgPSB0aGlzLnBhcnNlVXJsKCB1cmwgKSwKCQkJCQlwcmVzZXJ2ZWRIYXNoID0gdXJpLmhhc2gsCgkJCQkJdWlTdGF0ZSA9ICIiOwoKCQkJCS8vIHByb2R1Y2UgYSB1cmwgYWdhaW5zdCB3aGljaCB3ZSBjYW4gcmVzb2xlIHRoZSBwcm92aWRlZCBwYXRoCgkJCQlyZXNvbHV0aW9uVXJsID0gcmVzb2x1dGlvblVybCB8fCAocGF0aC5pc1BhdGgodXJsKSA/IHBhdGguZ2V0TG9jYXRpb24oKSA6IHBhdGguZ2V0RG9jdW1lbnRVcmwoKSk7CgoJCQkJLy8gSWYgdGhlIHVybCBpcyBhbnl0aGluZyBidXQgYSBzaW1wbGUgc3RyaW5nLCByZW1vdmUgYW55IHByZWNlZGluZyBoYXNoCgkJCQkvLyBlZyAjZm9vL2JhciAtPiBmb28vYmFyCgkJCQkvLyAgICAjZm9vIC0+ICNmb28KCQkJCWNsZWFuZWRVcmwgPSBpc1BhdGggPyBwYXRoLnN0cmlwSGFzaCggdXJsICkgOiB1cmw7CgoJCQkJLy8gSWYgdGhlIHVybCBpcyBhIGZ1bGwgdXJsIHdpdGggYSBoYXNoIGNoZWNrIGlmIHRoZSBwYXJzZWQgaGFzaCBpcyBhIHBhdGgKCQkJCS8vIGlmIGl0IGlzLCBzdHJpcCB0aGUgIywgYW5kIHVzZSBpdCBvdGhlcndpc2UgY29udGludWUgd2l0aG91dCBjaGFuZ2UKCQkJCWNsZWFuZWRVcmwgPSBwYXRoLmlzUGF0aCggdXJpLmhhc2ggKSA/IHBhdGguc3RyaXBIYXNoKCB1cmkuaGFzaCApIDogY2xlYW5lZFVybDsKCgkJCQkvLyBTcGxpdCB0aGUgVUkgU3RhdGUga2V5cyBvZmYgdGhlIGhyZWYKCQkJCXN0YXRlSW5kZXggPSBjbGVhbmVkVXJsLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApOwoKCQkJCS8vIHN0b3JlIHRoZSB1aSBzdGF0ZSBrZXlzIGZvciB1c2UKCQkJCWlmICggc3RhdGVJbmRleCA+IC0xICkgewoJCQkJCXVpU3RhdGUgPSBjbGVhbmVkVXJsLnNsaWNlKCBzdGF0ZUluZGV4ICk7CgkJCQkJY2xlYW5lZFVybCA9IGNsZWFuZWRVcmwuc2xpY2UoIDAsIHN0YXRlSW5kZXggKTsKCQkJCX0KCgkJCQkvLyBtYWtlIHRoZSBjbGVhbmVkVXJsIGFic29sdXRlIHJlbGF0aXZlIHRvIHRoZSByZXNvbHV0aW9uIHVybAoJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCBjbGVhbmVkVXJsLCByZXNvbHV0aW9uVXJsICk7CgoJCQkJLy8gZ3JhYiB0aGUgc2VhcmNoIGZyb20gdGhlIHJlc29sdmVkIHVybCBzaW5jZSBwYXJzaW5nIGZyb20KCQkJCS8vIHRoZSBwYXNzZWQgdXJsIG1heSBub3QgeWllbGQgdGhlIGNvcnJlY3QgcmVzdWx0CgkJCQlzZWFyY2ggPSB0aGlzLnBhcnNlVXJsKCBocmVmICkuc2VhcmNoOwoKCQkJCS8vIFRPRE8gYWxsIHRoaXMgY3JhcCBpcyB0ZXJyaWJsZSwgY2xlYW4gaXQgdXAKCQkJCWlmICggaXNQYXRoICkgewoJCQkJCS8vIHJlamVjdCB0aGUgaGFzaCBpZiBpdCdzIGEgcGF0aCBvciBpdCdzIGp1c3QgYSBkaWFsb2cga2V5CgkJCQkJaWYgKCBwYXRoLmlzUGF0aCggcHJlc2VydmVkSGFzaCApIHx8IHByZXNlcnZlZEhhc2gucmVwbGFjZSgiIyIsICIiKS5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKSA9PT0gMCkgewoJCQkJCQlwcmVzZXJ2ZWRIYXNoID0gIiI7CgkJCQkJfQoKCQkJCQkvLyBBcHBlbmQgdGhlIFVJIFN0YXRlIGtleXMgd2hlcmUgaXQgZXhpc3RzIGFuZCBpdCdzIGJlZW4gcmVtb3ZlZAoJCQkJCS8vIGZyb20gdGhlIHVybAoJCQkJCWlmICggdWlTdGF0ZSAmJiBwcmVzZXJ2ZWRIYXNoLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApID09PSAtMSkgewoJCQkJCQlwcmVzZXJ2ZWRIYXNoICs9IHVpU3RhdGU7CgkJCQkJfQoKCQkJCQkvLyBtYWtlIHN1cmUgdGhhdCBwb3VuZCBpcyBvbiB0aGUgZnJvbnQgb2YgdGhlIGhhc2gKCQkJCQlpZiAoIHByZXNlcnZlZEhhc2guaW5kZXhPZiggIiMiICkgPT09IC0xICYmIHByZXNlcnZlZEhhc2ggIT09ICIiICkgewoJCQkJCQlwcmVzZXJ2ZWRIYXNoID0gIiMiICsgcHJlc2VydmVkSGFzaDsKCQkJCQl9CgoJCQkJCS8vIHJlY29uc3RydWN0IGVhY2ggb2YgdGhlIHBpZWNlcyB3aXRoIHRoZSBuZXcgc2VhcmNoIHN0cmluZyBhbmQgaGFzaAoJCQkJCWhyZWYgPSBwYXRoLnBhcnNlVXJsKCBocmVmICk7CgkJCQkJaHJlZiA9IGhyZWYucHJvdG9jb2wgKyAiLy8iICsgaHJlZi5ob3N0ICsgaHJlZi5wYXRobmFtZSArIHNlYXJjaCArIHByZXNlcnZlZEhhc2g7CgkJCQl9IGVsc2UgewoJCQkJCWhyZWYgKz0gaHJlZi5pbmRleE9mKCAiIyIgKSA+IC0xID8gdWlTdGF0ZSA6ICIjIiArIHVpU3RhdGU7CgkJCQl9CgoJCQkJcmV0dXJuIGhyZWY7CgkJCX0sCgoJCQlpc1ByZXNlcnZhYmxlSGFzaDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gaGFzaC5yZXBsYWNlKCAiIyIsICIiICkuaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICkgPT09IDA7CgkJCX0sCgoJCQkvLyBFc2NhcGUgd2VpcmQgY2hhcmFjdGVycyBpbiB0aGUgaGFzaCBpZiBpdCBpcyB0byBiZSB1c2VkIGFzIGEgc2VsZWN0b3IKCQkJaGFzaFRvU2VsZWN0b3I6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJdmFyIGhhc0hhc2ggPSAoIGhhc2guc3Vic3RyaW5nKCAwLCAxICkgPT09ICIjIiApOwoJCQkJaWYgKCBoYXNIYXNoICkgewoJCQkJCWhhc2ggPSBoYXNoLnN1YnN0cmluZyggMSApOwoJCQkJfQoJCQkJcmV0dXJuICggaGFzSGFzaCA/ICIjIiA6ICIiICkgKyBoYXNoLnJlcGxhY2UoIC8oWyEiIyQlJicoKSorLC4vOjs8PT4/QFtcXV5ge3x9fl0pL2csICJcXCQxIiApOwoJCQl9LAoKCQkJLy8gcmV0dXJuIHRoZSBzdWJzdHJpbmcgb2YgYSBmaWxlcGF0aCBiZWZvcmUgdGhlIHN1Yi1wYWdlIGtleSwgZm9yIG1ha2luZwoJCQkvLyBhIHNlcnZlciByZXF1ZXN0CgkJCWdldEZpbGVQYXRoOiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCXZhciBzcGxpdGtleSA9ICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXk7CgkJCQlyZXR1cm4gcGF0aCAmJiBwYXRoLnNwbGl0KCBzcGxpdGtleSApWzBdLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCX0sCgoJCQkvLyBjaGVjayBpZiB0aGUgc3BlY2lmaWVkIHVybCByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIG1haW4KCQkJLy8gYXBwbGljYXRpb24gZG9jdW1lbnQuCgkJCWlzRmlyc3RQYWdlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gV2Ugb25seSBkZWFsIHdpdGggYWJzb2x1dGUgcGF0aHMuCgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIHRoaXMuZG9jdW1lbnRCYXNlICkgKSwKCgkJCQkJLy8gRG9lcyB0aGUgdXJsIGhhdmUgdGhlIHNhbWUgcGF0aCBhcyB0aGUgZG9jdW1lbnQ/CgkJCQkJc2FtZVBhdGggPSB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fAoJCQkJCQkoIHRoaXMuZG9jdW1lbnRCYXNlRGlmZmVycyAmJgoJCQkJCQkJdS5ocmVmTm9IYXNoID09PSB0aGlzLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICksCgoJCQkJCS8vIEdldCB0aGUgZmlyc3QgcGFnZSBlbGVtZW50LgoJCQkJCWZwID0gJC5tb2JpbGUuZmlyc3RQYWdlLAoKCQkJCQkvLyBHZXQgdGhlIGlkIG9mIHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQgaWYgaXQgaGFzIG9uZS4KCQkJCQlmcElkID0gZnAgJiYgZnBbMF0gPyBmcFswXS5pZCA6IHVuZGVmaW5lZDsKCgkJCQkvLyBUaGUgdXJsIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpZiB0aGUgcGF0aCBtYXRjaGVzIHRoZSBkb2N1bWVudCBhbmQKCQkJCS8vIGl0IGVpdGhlciBoYXMgbm8gaGFzaCB2YWx1ZSwgb3IgdGhlIGhhc2ggaXMgZXhhY3RseSBlcXVhbCB0byB0aGUgaWQKCQkJCS8vIG9mIHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQuCgkJCQlyZXR1cm4gc2FtZVBhdGggJiYKCQkJCQkoICF1Lmhhc2ggfHwKCQkJCQkJdS5oYXNoID09PSAiIyIgfHwKCQkJCQkJKCBmcElkICYmIHUuaGFzaC5yZXBsYWNlKCAvXiMvLCAiIiApID09PSBmcElkICkgKTsKCQkJfSwKCgkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cKCQkJLy8gY3Jvc3MtZG9tYWluIFhIUiByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZAoJCQkvLyB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuIFRoaXMgaXMgdXN1YWxseSB0byBhbGxvdyB0aGUgYXBwbGljYXRpb24gdG8KCQkJLy8gInBob25lIGhvbWUiIGFuZCBmZXRjaCBhcHAgc3BlY2lmaWMgZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyCgkJCS8vIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZSBhbGxvd0Nyb3NzRG9tYWluUGFnZXMKCQkJLy8gb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMgcmVxdWVzdHMgdG8gZ28KCQkJLy8gdGhyb3VnaCBvdXIgcGFnZSBsb2FkaW5nIGxvZ2ljLgoJCQlpc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdDogZnVuY3Rpb24oIGRvY1VybCwgcmVxVXJsICkgewoJCQkJcmV0dXJuICQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyAmJgoJCQkJCShkb2NVcmwucHJvdG9jb2wgPT09ICJmaWxlOiIgfHwgZG9jVXJsLnByb3RvY29sID09PSAiY29udGVudDoiKSAmJgoJCQkJCXJlcVVybC5zZWFyY2goIC9eaHR0cHM/Oi8gKSAhPT0gLTE7CgkJCX0KCQl9OwoKCQlwYXRoLmRvY3VtZW50VXJsID0gcGF0aC5wYXJzZUxvY2F0aW9uKCk7CgoJCSRiYXNlID0gJCggImhlYWQiICkuZmluZCggImJhc2UiICk7CgoJCXBhdGguZG9jdW1lbnRCYXNlID0gJGJhc2UubGVuZ3RoID8KCQkJcGF0aC5wYXJzZVVybCggcGF0aC5tYWtlVXJsQWJzb2x1dGUoICRiYXNlLmF0dHIoICJocmVmIiApLCBwYXRoLmRvY3VtZW50VXJsLmhyZWYgKSApIDoKCQkJcGF0aC5kb2N1bWVudFVybDsKCgkJcGF0aC5kb2N1bWVudEJhc2VEaWZmZXJzID0gKHBhdGguZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCAhPT0gcGF0aC5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCk7CgoJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCBiYXNlIHVybAoJCXBhdGguZ2V0RG9jdW1lbnRCYXNlID0gZnVuY3Rpb24oIGFzUGFyc2VkT2JqZWN0ICkgewoJCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIHBhdGguZG9jdW1lbnRCYXNlICkgOiBwYXRoLmRvY3VtZW50QmFzZS5ocmVmOwoJCX07CgoJCS8vIERFUFJFQ0FURUQgYXMgb2YgMS40LjAgLSByZW1vdmUgaW4gMS41LjAKCQkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCgkJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCB1cmwKCQkJZ2V0RG9jdW1lbnRVcmw6IHBhdGguZ2V0RG9jdW1lbnRVcmwsCgoJCQkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgYmFzZSB1cmwKCQkJZ2V0RG9jdW1lbnRCYXNlOiBwYXRoLmdldERvY3VtZW50QmFzZQoJCX0pOwp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJJC5tb2JpbGUuSGlzdG9yeSA9IGZ1bmN0aW9uKCBzdGFjaywgaW5kZXggKSB7CgkJdGhpcy5zdGFjayA9IHN0YWNrIHx8IFtdOwoJCXRoaXMuYWN0aXZlSW5kZXggPSBpbmRleCB8fCAwOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5IaXN0b3J5LnByb3RvdHlwZSwgewoJCWdldEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IF07CgkJfSwKCgkJZ2V0TGFzdDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLnByZXZpb3VzSW5kZXggXTsKCQl9LAoKCQlnZXROZXh0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMuYWN0aXZlSW5kZXggKyAxIF07CgkJfSwKCgkJZ2V0UHJldjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IC0gMSBdOwoJCX0sCgoJCS8vIGFkZE5ldyBpcyB1c2VkIHdoZW5ldmVyIGEgbmV3IHBhZ2UgaXMgYWRkZWQKCQlhZGQ6IGZ1bmN0aW9uKCB1cmwsIGRhdGEgKSB7CgkJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQkJLy9pZiB0aGVyZSdzIGZvcndhcmQgaGlzdG9yeSwgd2lwZSBpdAoJCQlpZiAoIHRoaXMuZ2V0TmV4dCgpICkgewoJCQkJdGhpcy5jbGVhckZvcndhcmQoKTsKCQkJfQoKCQkJLy8gaWYgdGhlIGhhc2ggaXMgaW5jbHVkZWQgaW4gdGhlIGRhdGEgbWFrZSBzdXJlIHRoZSBzaGFwZQoJCQkvLyBpcyBjb25zaXN0ZW50IGZvciBjb21wYXJpc29uCgkJCWlmICggZGF0YS5oYXNoICYmIGRhdGEuaGFzaC5pbmRleE9mKCAiIyIgKSA9PT0gLTEpIHsKCQkJCWRhdGEuaGFzaCA9ICIjIiArIGRhdGEuaGFzaDsKCQkJfQoKCQkJZGF0YS51cmwgPSB1cmw7CgkJCXRoaXMuc3RhY2sucHVzaCggZGF0YSApOwoJCQl0aGlzLmFjdGl2ZUluZGV4ID0gdGhpcy5zdGFjay5sZW5ndGggLSAxOwoJCX0sCgoJCS8vd2lwZSB1cmxzIGFoZWFkIG9mIGFjdGl2ZSBpbmRleAoJCWNsZWFyRm9yd2FyZDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuc3RhY2sgPSB0aGlzLnN0YWNrLnNsaWNlKCAwLCB0aGlzLmFjdGl2ZUluZGV4ICsgMSApOwoJCX0sCgoJCWZpbmQ6IGZ1bmN0aW9uKCB1cmwsIHN0YWNrLCBlYXJseVJldHVybiApIHsKCQkJc3RhY2sgPSBzdGFjayB8fCB0aGlzLnN0YWNrOwoKCQkJdmFyIGVudHJ5LCBpLCBsZW5ndGggPSBzdGFjay5sZW5ndGgsIGluZGV4OwoKCQkJZm9yICggaSA9IDA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJCWVudHJ5ID0gc3RhY2tbaV07CgoJCQkJaWYgKCBkZWNvZGVVUklDb21wb25lbnQodXJsKSA9PT0gZGVjb2RlVVJJQ29tcG9uZW50KGVudHJ5LnVybCkgfHwKCQkJCQlkZWNvZGVVUklDb21wb25lbnQodXJsKSA9PT0gZGVjb2RlVVJJQ29tcG9uZW50KGVudHJ5Lmhhc2gpICkgewoJCQkJCWluZGV4ID0gaTsKCgkJCQkJaWYgKCBlYXJseVJldHVybiApIHsKCQkJCQkJcmV0dXJuIGluZGV4OwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJcmV0dXJuIGluZGV4OwoJCX0sCgoJCWNsb3Nlc3Q6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCXZhciBjbG9zZXN0LCBhID0gdGhpcy5hY3RpdmVJbmRleDsKCgkJCS8vIEZpcnN0LCB0YWtlIHRoZSBzbGljZSBvZiB0aGUgaGlzdG9yeSBzdGFjayBiZWZvcmUgdGhlIGN1cnJlbnQgaW5kZXggYW5kIHNlYXJjaAoJCQkvLyBmb3IgYSB1cmwgbWF0Y2guIElmIG9uZSBpcyBmb3VuZCwgd2UnbGwgYXZvaWQgYXZvaWQgbG9va2luZyB0aHJvdWdoIGZvcndhcmQgaGlzdG9yeQoJCQkvLyBOT1RFIHRoZSBwcmVmZXJlbmNlIGZvciBiYWNrd2FyZCBoaXN0b3J5IG1vdmVtZW50IGlzIGRyaXZlbiBieSB0aGUgZmFjdCB0aGF0CgkJCS8vICAgICAgbW9zdCBtb2JpbGUgYnJvd3NlcnMgb25seSBoYXZlIGEgZGVkaWNhdGVkIGJhY2sgYnV0dG9uLCBhbmQgdXNlcnMgcmFyZWx5IHVzZQoJCQkvLyAgICAgIHRoZSBmb3J3YXJkIGJ1dHRvbiBpbiBkZXNrdG9wIGJyb3dzZXIgYW55aG93CgkJCWNsb3Nlc3QgPSB0aGlzLmZpbmQoIHVybCwgdGhpcy5zdGFjay5zbGljZSgwLCBhKSApOwoKCQkJLy8gSWYgbm90aGluZyB3YXMgZm91bmQgaW4gYmFja3dhcmQgaGlzdG9yeSBjaGVjayBmb3J3YXJkLiBUaGUgYHRydWVgCgkJCS8vIHZhbHVlIHBhc3NlZCBhcyB0aGUgdGhpcmQgcGFyYW1ldGVyIGNhdXNlcyB0aGUgZmluZCBtZXRob2QgdG8gYnJlYWsKCQkJLy8gb24gdGhlIGZpcnN0IG1hdGNoIGluIHRoZSBmb3J3YXJkIGhpc3Rvcnkgc2xpY2UuIFRoZSBzdGFydGluZyBpbmRleAoJCQkvLyBvZiB0aGUgc2xpY2UgbXVzdCB0aGVuIGJlIGFkZGVkIHRvIHRoZSByZXN1bHQgdG8gZ2V0IHRoZSBlbGVtZW50IGluZGV4CgkJCS8vIGluIHRoZSBvcmlnaW5hbCBoaXN0b3J5IHN0YWNrIDooIDooCgkJCS8vCgkJCS8vIFRPRE8gdGhpcyBpcyBoeXBlciBjb25mdXNpbmcgYW5kIHNob3VsZCBiZSBjbGVhbmVkIHVwICh1Z2ggc28gYmFkKQoJCQlpZiAoIGNsb3Nlc3QgPT09IHVuZGVmaW5lZCApIHsKCQkJCWNsb3Nlc3QgPSB0aGlzLmZpbmQoIHVybCwgdGhpcy5zdGFjay5zbGljZShhKSwgdHJ1ZSApOwoJCQkJY2xvc2VzdCA9IGNsb3Nlc3QgPT09IHVuZGVmaW5lZCA/IGNsb3Nlc3QgOiBjbG9zZXN0ICsgYTsKCQkJfQoKCQkJcmV0dXJuIGNsb3Nlc3Q7CgkJfSwKCgkJZGlyZWN0OiBmdW5jdGlvbiggb3B0cyApIHsKCQkJdmFyIG5ld0FjdGl2ZUluZGV4ID0gdGhpcy5jbG9zZXN0KCBvcHRzLnVybCApLCBhID0gdGhpcy5hY3RpdmVJbmRleDsKCgkJCS8vIHNhdmUgbmV3IHBhZ2UgaW5kZXgsIG51bGwgY2hlY2sgdG8gcHJldmVudCBmYWxzZXkgMCByZXN1bHQKCQkJLy8gcmVjb3JkIHRoZSBwcmV2aW91cyBpbmRleCBmb3IgcmVmZXJlbmNlCgkJCWlmICggbmV3QWN0aXZlSW5kZXggIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuYWN0aXZlSW5kZXggPSBuZXdBY3RpdmVJbmRleDsKCQkJCXRoaXMucHJldmlvdXNJbmRleCA9IGE7CgkJCX0KCgkJCS8vIGludm9rZSBjYWxsYmFja3Mgd2hlcmUgYXBwcm9wcmlhdGUKCQkJLy8KCQkJLy8gVE9ETyB0aGlzIGlzIGFsc28gY29udm9sdXRlZCBhbmQgY29uZnVzaW5nCgkJCWlmICggbmV3QWN0aXZlSW5kZXggPCBhICkgewoJCQkJKCBvcHRzLnByZXNlbnQgfHwgb3B0cy5iYWNrIHx8ICQubm9vcCApKCB0aGlzLmdldEFjdGl2ZSgpLCAiYmFjayIgKTsKCQkJfSBlbHNlIGlmICggbmV3QWN0aXZlSW5kZXggPiBhICkgewoJCQkJKCBvcHRzLnByZXNlbnQgfHwgb3B0cy5mb3J3YXJkIHx8ICQubm9vcCApKCB0aGlzLmdldEFjdGl2ZSgpLCAiZm9yd2FyZCIgKTsKCQkJfSBlbHNlIGlmICggbmV3QWN0aXZlSW5kZXggPT09IHVuZGVmaW5lZCAmJiBvcHRzLm1pc3NpbmcgKSB7CgkJCQlvcHRzLm1pc3NpbmcoIHRoaXMuZ2V0QWN0aXZlKCkgKTsKCQkJfQoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyIHBhdGggPSAkLm1vYmlsZS5wYXRoLAoJCWluaXRpYWxIcmVmID0gbG9jYXRpb24uaHJlZjsKCgkkLm1vYmlsZS5OYXZpZ2F0b3IgPSBmdW5jdGlvbiggaGlzdG9yeSApIHsKCQl0aGlzLmhpc3RvcnkgPSBoaXN0b3J5OwoJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgPSB0cnVlOwoKCQkkLm1vYmlsZS53aW5kb3cuYmluZCh7CgkJCSJwb3BzdGF0ZS5oaXN0b3J5IjogJC5wcm94eSggdGhpcy5wb3BzdGF0ZSwgdGhpcyApLAoJCQkiaGFzaGNoYW5nZS5oaXN0b3J5IjogJC5wcm94eSggdGhpcy5oYXNoY2hhbmdlLCB0aGlzICkKCQl9KTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuTmF2aWdhdG9yLnByb3RvdHlwZSwgewoJCXNxdWFzaDogZnVuY3Rpb24oIHVybCwgZGF0YSApIHsKCQkJdmFyIHN0YXRlLCBocmVmLCBoYXNoID0gcGF0aC5pc1BhdGgodXJsKSA/IHBhdGguc3RyaXBIYXNoKHVybCkgOiB1cmw7CgoJCQlocmVmID0gcGF0aC5zcXVhc2goIHVybCApOwoKCQkJLy8gbWFrZSBzdXJlIHRvIHByb3ZpZGUgdGhpcyBpbmZvcm1hdGlvbiB3aGVuIGl0IGlzbid0IGV4cGxpY2l0bHkgc2V0IGluIHRoZQoJCQkvLyBkYXRhIG9iamVjdCB0aGF0IHdhcyBwYXNzZWQgdG8gdGhlIHNxdWFzaCBtZXRob2QKCQkJc3RhdGUgPSAkLmV4dGVuZCh7CgkJCQloYXNoOiBoYXNoLAoJCQkJdXJsOiBocmVmCgkJCX0sIGRhdGEpOwoKCQkJLy8gcmVwbGFjZSB0aGUgY3VycmVudCB1cmwgd2l0aCB0aGUgbmV3IGhyZWYgYW5kIHN0b3JlIHRoZSBzdGF0ZQoJCQkvLyBOb3RlIHRoYXQgaW4gc29tZSBjYXNlcyB3ZSBtaWdodCBiZSByZXBsYWNpbmcgYW4gdXJsIHdpdGggdGhlCgkJCS8vIHNhbWUgdXJsLiBXZSBkbyB0aGlzIGFueXdheXMgYmVjYXVzZSB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGF0CgkJCS8vIGFsbCBvZiBvdXIgaGlzdG9yeSBlbnRyaWVzIGhhdmUgYSBzdGF0ZSBvYmplY3QgYXNzb2NpYXRlZCB3aXRoCgkJCS8vIHRoZW0uIFRoaXMgYWxsb3dzIHVzIHRvIHdvcmsgYXJvdW5kIHRoZSBjYXNlIHdoZXJlICQubW9iaWxlLmJhY2soKQoJCQkvLyBpcyBjYWxsZWQgdG8gdHJhbnNpdGlvbiBmcm9tIGFuIGV4dGVybmFsIHBhZ2UgdG8gYW4gZW1iZWRkZWQgcGFnZS4KCQkJLy8gSW4gdGhhdCBwYXJ0aWN1bGFyIGNhc2UsIGEgaGFzaGNoYW5nZSBldmVudCBpcyAqTk9UKiBnZW5lcmF0ZWQgYnkgdGhlIGJyb3dzZXIuCgkJCS8vIEVuc3VyaW5nIGVhY2ggaGlzdG9yeSBlbnRyeSBoYXMgYSBzdGF0ZSBvYmplY3QgbWVhbnMgdGhhdCBvblBvcFN0YXRlKCkKCQkJLy8gd2lsbCBhbHdheXMgdHJpZ2dlciBvdXIgaGFzaGNoYW5nZSBjYWxsYmFjayBldmVuIHdoZW4gYSBoYXNoY2hhbmdlIGV2ZW50CgkJCS8vIGlzIG5vdCBmaXJlZC4KCQkJd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKCBzdGF0ZSwgc3RhdGUudGl0bGUgfHwgZG9jdW1lbnQudGl0bGUsIGhyZWYgKTsKCgkJCXJldHVybiBzdGF0ZTsKCQl9LAoKCQloYXNoOiBmdW5jdGlvbiggdXJsLCBocmVmICkgewoJCQl2YXIgcGFyc2VkLCBsb2MsIGhhc2gsIHJlc29sdmVkOwoKCQkJLy8gR3JhYiB0aGUgaGFzaCBmb3IgcmVjb3JkaW5nLiBJZiB0aGUgcGFzc2VkIHVybCBpcyBhIHBhdGgKCQkJLy8gd2UgdXNlZCB0aGUgcGFyc2VkIHZlcnNpb24gb2YgdGhlIHNxdWFzaGVkIHVybCB0byByZWNvbnN0cnVjdCwKCQkJLy8gb3RoZXJ3aXNlIHdlIGFzc3VtZSBpdCdzIGEgaGFzaCBhbmQgc3RvcmUgaXQgZGlyZWN0bHkKCQkJcGFyc2VkID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgkJCWxvYyA9IHBhdGgucGFyc2VMb2NhdGlvbigpOwoKCQkJaWYgKCBsb2MucGF0aG5hbWUgKyBsb2Muc2VhcmNoID09PSBwYXJzZWQucGF0aG5hbWUgKyBwYXJzZWQuc2VhcmNoICkgewoJCQkJLy8gSWYgdGhlIHBhdGhuYW1lIGFuZCBzZWFyY2ggb2YgdGhlIHBhc3NlZCB1cmwgaXMgaWRlbnRpY2FsIHRvIHRoZSBjdXJyZW50IGxvYwoJCQkJLy8gdGhlbiB3ZSBtdXN0IHVzZSB0aGUgaGFzaC4gT3RoZXJ3aXNlIHRoZXJlIHdpbGwgYmUgbm8gZXZlbnQKCQkJCS8vIGVnLCB1cmwgPSAiL2Zvby9iYXI/YmF6I2JhbmciLCBsb2NhdGlvbi5ocmVmID0gImh0dHA6Ly9leGFtcGxlLmNvbS9mb28vYmFyP2JheiIKCQkJCWhhc2ggPSBwYXJzZWQuaGFzaCA/IHBhcnNlZC5oYXNoIDogcGFyc2VkLnBhdGhuYW1lICsgcGFyc2VkLnNlYXJjaDsKCQkJfSBlbHNlIGlmICggcGF0aC5pc1BhdGgodXJsKSApIHsKCQkJCXJlc29sdmVkID0gcGF0aC5wYXJzZVVybCggaHJlZiApOwoJCQkJLy8gSWYgdGhlIHBhc3NlZCB1cmwgaXMgYSBwYXRoLCBtYWtlIGl0IGRvbWFpbiByZWxhdGl2ZSBhbmQgcmVtb3ZlIGFueSB0cmFpbGluZyBoYXNoCgkJCQloYXNoID0gcmVzb2x2ZWQucGF0aG5hbWUgKyByZXNvbHZlZC5zZWFyY2ggKyAocGF0aC5pc1ByZXNlcnZhYmxlSGFzaCggcmVzb2x2ZWQuaGFzaCApPyByZXNvbHZlZC5oYXNoLnJlcGxhY2UoICIjIiwgIiIgKSA6ICIiKTsKCQkJfSBlbHNlIHsKCQkJCWhhc2ggPSB1cmw7CgkJCX0KCgkJCXJldHVybiBoYXNoOwoJCX0sCgoJCS8vIFRPRE8gcmVjb25zaWRlciBuYW1lCgkJZ286IGZ1bmN0aW9uKCB1cmwsIGRhdGEsIG5vRXZlbnRzICkgewoJCQl2YXIgc3RhdGUsIGhyZWYsIGhhc2gsIHBvcHN0YXRlRXZlbnQsCgkJCQlpc1BvcFN0YXRlRXZlbnQgPSAkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCk7CgoJCQkvLyBHZXQgdGhlIHVybCBhcyBpdCB3b3VsZCBsb29rIHNxdWFzaGVkIG9uIHRvIHRoZSBjdXJyZW50IHJlc29sdXRpb24gdXJsCgkJCWhyZWYgPSBwYXRoLnNxdWFzaCggdXJsICk7CgoJCQkvLyBzb3J0IG91dCB3aGF0IHRoZSBoYXNoIHNvdWxkIGJlIGZyb20gdGhlIHVybAoJCQloYXNoID0gdGhpcy5oYXNoKCB1cmwsIGhyZWYgKTsKCgkJCS8vIEhlcmUgd2UgcHJldmVudCB0aGUgbmV4dCBoYXNoIGNoYW5nZSBvciBwb3BzdGF0ZSBldmVudCBmcm9tIGRvaW5nIGFueQoJCQkvLyBoaXN0b3J5IG1hbmFnZW1lbnQuIEluIHRoZSBjYXNlIG9mIGhhc2hjaGFuZ2Ugd2UgZG9uJ3Qgc3dhbGxvdyBpdAoJCQkvLyBpZiB0aGVyZSB3aWxsIGJlIG5vIGhhc2hjaGFuZ2UgZmlyZWQgKHNpbmNlIHRoYXQgd29uJ3QgcmVzZXQgdGhlIHZhbHVlKQoJCQkvLyBhbmQgd2lsbCBzd2FsbG93IHRoZSBmb2xsb3dpbmcgaGFzaGNoYW5nZQoJCQlpZiAoIG5vRXZlbnRzICYmIGhhc2ggIT09IHBhdGguc3RyaXBIYXNoKHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gpICkgewoJCQkJdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgPSBub0V2ZW50czsKCQkJfQoKCQkJLy8gSU1QT1JUQU5UIGluIHRoZSBjYXNlIHdoZXJlIHBvcHN0YXRlIGlzIHN1cHBvcnRlZCB0aGUgZXZlbnQgd2lsbCBiZSB0cmlnZ2VyZWQKCQkJLy8gICAgICBkaXJlY3RseSwgc3RvcHBpbmcgZnVydGhlciBleGVjdXRpb24gLSBpZSwgaW50ZXJ1cHRpbmcgdGhlIGZsb3cgb2YgdGhpcwoJCQkvLyAgICAgIG1ldGhvZCBjYWxsIHRvIGZpcmUgYmluZGluZ3MgYXQgdGhpcyBleHByZXNzaW9uLiBCZWxvdyB0aGUgbmF2aWdhdGUgbWV0aG9kCgkJCS8vICAgICAgdGhlcmUgaXMgYSBiaW5kaW5nIHRvIGNhdGNoIHRoaXMgZXZlbnQgYW5kIHN0b3AgaXRzIHByb3BhZ2F0aW9uLgoJCQkvLwoJCQkvLyAgICAgIFdlIHRoZW4gdHJpZ2dlciBhIG5ldyBwb3BzdGF0ZSBldmVudCBvbiB0aGUgd2luZG93IHdpdGggYSBudWxsIHN0YXRlCgkJCS8vICAgICAgc28gdGhhdCB0aGUgbmF2aWdhdGUgZXZlbnRzIGNhbiBjb25jbHVkZSB0aGVpciB3b3JrIHByb3Blcmx5CgkJCS8vCgkJCS8vIGlmIHRoZSB1cmwgaXMgYSBwYXRoIHdlIHdhbnQgdG8gcHJlc2VydmUgdGhlIHF1ZXJ5IHBhcmFtcyB0aGF0IGFyZSBhdmFpbGFibGUgb24KCQkJLy8gdGhlIGN1cnJlbnQgdXJsLgoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSB0cnVlOwoJCQl3aW5kb3cubG9jYXRpb24uaGFzaCA9IGhhc2g7CgoJCQkvLyBJZiBwb3BzdGF0ZSBpcyBlbmFibGVkIGFuZCB0aGUgYnJvd3NlciB0cmlnZ2VycyBgcG9wc3RhdGVgIGV2ZW50cyB3aGVuIHRoZSBoYXNoCgkJCS8vIGlzIHNldCAodGhpcyBvZnRlbiBoYXBwZW5zIGltbWVkaWF0ZWx5IGluIGJyb3dzZXJzIGxpa2UgQ2hyb21lKSwgdGhlbiB0aGUKCQkJLy8gdGhpcyBmbGFnIHdpbGwgYmUgc2V0IHRvIGZhbHNlIGFscmVhZHkuIElmIGl0J3MgYSBicm93c2VyIHRoYXQgZG9lcyBub3QgdHJpZ2dlcgoJCQkvLyBhIGBwb3BzdGF0ZWAgb24gaGFzaCBhc3NpZ25lbWVudCBvciBgcmVwbGFjZVN0YXRlYCB0aGVuIHdlIG5lZWQgYXZvaWQgdGhlIGJyYW5jaAoJCQkvLyB0aGF0IHN3YWxsb3dzIHRoZSBldmVudCBjcmVhdGVkIGJ5IHRoZSBwb3BzdGF0ZSBnZW5lcmF0ZWQgYnkgdGhlIGhhc2ggYXNzaWdubWVudAoJCQkvLyBBdCB0aGUgdGltZSBvZiB0aGlzIHdyaXRpbmcgdGhpcyBoYXBwZW5zIHdpdGggT3BlcmEgMTIgYW5kIHNvbWUgdmVyc2lvbiBvZiBJRQoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCgkJCXN0YXRlID0gJC5leHRlbmQoewoJCQkJdXJsOiBocmVmLAoJCQkJaGFzaDogaGFzaCwKCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZQoJCQl9LCBkYXRhKTsKCgkJCWlmICggaXNQb3BTdGF0ZUV2ZW50ICkgewoJCQkJcG9wc3RhdGVFdmVudCA9IG5ldyAkLkV2ZW50KCAicG9wc3RhdGUiICk7CgkJCQlwb3BzdGF0ZUV2ZW50Lm9yaWdpbmFsRXZlbnQgPSB7CgkJCQkJdHlwZTogInBvcHN0YXRlIiwKCQkJCQlzdGF0ZTogbnVsbAoJCQkJfTsKCgkJCQl0aGlzLnNxdWFzaCggdXJsLCBzdGF0ZSApOwoKCQkJCS8vIFRyaWdnZXIgYSBuZXcgZmF1eCBwb3BzdGF0ZSBldmVudCB0byByZXBsYWNlIHRoZSBvbmUgdGhhdCB3ZQoJCQkJLy8gY2F1Z2h0IHRoYXQgd2FzIHRyaWdnZXJlZCBieSB0aGUgaGFzaCBzZXR0aW5nIGFib3ZlLgoJCQkJaWYgKCAhbm9FdmVudHMgKSB7CgkJCQkJdGhpcy5pZ25vcmVQb3BTdGF0ZSA9IHRydWU7CgkJCQkJJC5tb2JpbGUud2luZG93LnRyaWdnZXIoIHBvcHN0YXRlRXZlbnQgKTsKCQkJCX0KCQkJfQoKCQkJLy8gcmVjb3JkIHRoZSBoaXN0b3J5IGVudHJ5IHNvIHRoYXQgdGhlIGluZm9ybWF0aW9uIGNhbiBiZSBpbmNsdWRlZAoJCQkvLyBpbiBoYXNoY2hhbmdlIGV2ZW50IGRyaXZlbiBuYXZpZ2F0ZSBldmVudHMgaW4gYSBzaW1pbGFyIGZhc2hpb24gdG8KCQkJLy8gdGhlIHN0YXRlIHRoYXQncyBwcm92aWRlZCBieSBwb3BzdGF0ZQoJCQl0aGlzLmhpc3RvcnkuYWRkKCBzdGF0ZS51cmwsIHN0YXRlICk7CgkJfSwKCgkJLy8gVGhpcyBiaW5kaW5nIGlzIGludGVuZGVkIHRvIGNhdGNoIHRoZSBwb3BzdGF0ZSBldmVudHMgdGhhdCBhcmUgZmlyZWQKCQkvLyB3aGVuIGV4ZWN1dGlvbiBvZiB0aGUgYCQubmF2aWdhdGVgIG1ldGhvZCBzdG9wcyBhdCB3aW5kb3cubG9jYXRpb24uaGFzaCA9IHVybDsKCQkvLyBhbmQgY29tcGxldGVseSBwcmV2ZW50IHRoZW0gZnJvbSBwcm9wYWdhdGluZy4gVGhlIHBvcHN0YXRlIGV2ZW50IHdpbGwgdGhlbiBiZQoJCS8vIHJldHJpZ2dlcmVkIGFmdGVyIGV4ZWN1dGlvbiByZXN1bWVzCgkJLy8KCQkvLyBUT0RPIGdyYWIgdGhlIG9yaWdpbmFsIGV2ZW50IGhlcmUgYW5kIHVzZSBpdCBmb3IgdGhlIHN5bnRoZXRpYyBldmVudCBpbiB0aGUKCQkvLyAgICAgIHNlY29uZCBoYWxmIG9mIHRoZSBuYXZpZ2F0ZSBleGVjdXRpb24gdGhhdCB3aWxsIGZvbGxvdyB0aGlzIGJpbmRpbmcKCQlwb3BzdGF0ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgaGFzaCwgc3RhdGU7CgoJCQkvLyBQYXJ0bHkgdG8gc3VwcG9ydCBvdXIgdGVzdCBzdWl0ZSB3aGljaCBtYW51YWxseSBhbHRlcnMgdGhlIHN1cHBvcnQKCQkJLy8gdmFsdWUgdG8gdGVzdCBoYXNoY2hhbmdlLiBQYXJ0bHkgdG8gcHJldmVudCBhbGwgYXJvdW5kIHdlaXJkbmVzcwoJCQlpZiAoICEkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIHRoaXMgaXMgdGhlIHBvcHN0YXRlIHRyaWdnZXJlZCBieSB0aGUgYWN0dWFsIGFsdGVyYXRpb24gb2YgdGhlIGhhc2gKCQkJLy8gcHJldmVudCBpdCBjb21wbGV0ZWx5LiBIaXN0b3J5IGlzIHRyYWNrZWQgbWFudWFsbHkKCQkJaWYgKCB0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgKSB7CgkJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBpZiB0aGlzIGlzIHRoZSBwb3BzdGF0ZSB0cmlnZ2VyZWQgYWZ0ZXIgdGhlIGByZXBsYWNlU3RhdGVgIGNhbGwgaW4gdGhlIGdvCgkJCS8vIG1ldGhvZCwgdGhlbiBzaW1wbHkgaWdub3JlIGl0LiBUaGUgaGlzdG9yeSBlbnRyeSBoYXMgYWxyZWFkeSBiZWVuIGNhcHR1cmVkCgkJCWlmICggdGhpcy5pZ25vcmVQb3BTdGF0ZSApIHsKCQkJCXRoaXMuaWdub3JlUG9wU3RhdGUgPSBmYWxzZTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gc3RhdGUsIGFuZCB0aGUgaGlzdG9yeSBzdGFjayBsZW5ndGggaXMgb25lIHdlcmUKCQkJLy8gcHJvYmFibHkgZ2V0dGluZyB0aGUgcGFnZSBsb2FkIHBvcHN0YXRlIGZpcmVkIGJ5IGJyb3dzZXJzIGxpa2UgY2hyb21lCgkJCS8vIGF2b2lkIGl0IGFuZCBzZXQgdGhlIG9uZSB0aW1lIGZsYWcgdG8gZmFsc2UuCgkJCS8vIFRPRE86IERvIHdlIHJlYWxseSBuZWVkIGFsbCB0aGVzZSBjb25kaXRpb25zPyBDb21wYXJpbmcgbG9jYXRpb24gaHJlZnMKCQkJLy8gc2hvdWxkIGJlIHN1ZmZpY2llbnQuCgkJCWlmICggIWV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgJiYKCQkJCXRoaXMuaGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDEgJiYKCQkJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgKSB7CgkJCQl0aGlzLmlnbm9yZUluaXRpYWxIYXNoQ2hhbmdlID0gZmFsc2U7CgoJCQkJaWYgKCBsb2NhdGlvbi5ocmVmID09PSBpbml0aWFsSHJlZiApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJLy8gYWNjb3VudCBmb3IgZGlyZWN0IG1hbmlwdWxhdGlvbiBvZiB0aGUgaGFzaC4gVGhhdCBpcywgd2Ugd2lsbCByZWNlaXZlIGEgcG9wc3RhdGUKCQkJLy8gd2hlbiB0aGUgaGFzaCBpcyBjaGFuZ2VkIGJ5IGFzc2lnbm1lbnQsIGFuZCBpdCB3b24ndCBoYXZlIGEgc3RhdGUgYXNzb2NpYXRlZC4gV2UKCQkJLy8gdGhlbiBuZWVkIHRvIHNxdWFzaCB0aGUgaGFzaC4gU2VlIGJlbG93IGZvciBoYW5kbGluZyBvZiBoYXNoIGFzc2lnbm1lbnQgdGhhdAoJCQkvLyBtYXRjaGVzIGFuIGV4aXN0aW5nIGhpc3RvcnkgZW50cnkKCQkJLy8gVE9ETyBpdCBtaWdodCBiZSBiZXR0ZXIgdG8gb25seSBhZGQgdG8gdGhlIGhpc3Rvcnkgc3RhY2sKCQkJLy8gICAgICB3aGVuIHRoZSBoYXNoIGlzIGFkamFjZW50IHRvIHRoZSBhY3RpdmUgaGlzdG9yeSBlbnRyeQoJCQloYXNoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQkJaWYgKCAhZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSAmJiBoYXNoICkgewoJCQkJLy8gc3F1YXNoIHRoZSBoYXNoIHRoYXQncyBiZWVuIGFzc2lnbmVkIG9uIHRoZSBVUkwgd2l0aCByZXBsYWNlU3RhdGUKCQkJCS8vIGFsc28gZ3JhYiB0aGUgcmVzdWx0aW5nIHN0YXRlIG9iamVjdCBmb3Igc3RvcmFnZQoJCQkJc3RhdGUgPSB0aGlzLnNxdWFzaCggaGFzaCApOwoKCQkJCS8vIHJlY29yZCB0aGUgbmV3IGhhc2ggYXMgYW4gYWRkaXRpb25hbCBoaXN0b3J5IGVudHJ5CgkJCQkvLyB0byBtYXRjaCB0aGUgYnJvd3NlcidzIHRyZWF0bWVudCBvZiBoYXNoIGFzc2lnbm1lbnQKCQkJCXRoaXMuaGlzdG9yeS5hZGQoIHN0YXRlLnVybCwgc3RhdGUgKTsKCgkJCQkvLyBwYXNzIHRoZSBuZXdseSBjcmVhdGVkIHN0YXRlIGluZm9ybWF0aW9uCgkJCQkvLyBhbG9uZyB3aXRoIHRoZSBldmVudAoJCQkJZXZlbnQuaGlzdG9yeVN0YXRlID0gc3RhdGU7CgoJCQkJLy8gZG8gbm90IGFsdGVyIGhpc3RvcnksIHdlJ3ZlIGFkZGVkIGEgbmV3IGhpc3RvcnkgZW50cnkKCQkJCS8vIHNvIHdlIGtub3cgd2hlcmUgd2UgYXJlCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIGFsbCBlbHNlIGZhaWxzIHRoaXMgaXMgYSBwb3BzdGF0ZSB0aGF0IGNvbWVzIGZyb20gdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b25zCgkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHN0YXRlIG9mIG91ciBoaXN0b3J5IHN0YWNrIHByb3Blcmx5LCBhbmQgcmVjb3JkIHRoZSBkaXJlY3Rpb25hbGl0eQoJCQl0aGlzLmhpc3RvcnkuZGlyZWN0KHsKCQkJCXVybDogKGV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgfHwge30pLnVybCB8fCBoYXNoLAoKCQkJCS8vIFdoZW4gdGhlIHVybCBpcyBlaXRoZXIgZm9yd2FyZCBvciBiYWNrd2FyZCBpbiBoaXN0b3J5IGluY2x1ZGUgdGhlIGVudHJ5CgkJCQkvLyBhcyBkYXRhIG9uIHRoZSBldmVudCBvYmplY3QgZm9yIG1lcmdpbmcgYXMgZGF0YSBpbiB0aGUgbmF2aWdhdGUgZXZlbnQKCQkJCXByZXNlbnQ6IGZ1bmN0aW9uKCBoaXN0b3J5RW50cnksIGRpcmVjdGlvbiApIHsKCQkJCQkvLyBtYWtlIHN1cmUgdG8gY3JlYXRlIGEgbmV3IG9iamVjdCB0byBwYXNzIGRvd24gYXMgdGhlIG5hdmlnYXRlIGV2ZW50IGRhdGEKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUgPSAkLmV4dGVuZCh7fSwgaGlzdG9yeUVudHJ5KTsKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUuZGlyZWN0aW9uID0gZGlyZWN0aW9uOwoJCQkJfQoJCQl9KTsKCQl9LAoKCQkvLyBOT1RFIG11c3QgYmluZCBiZWZvcmUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50IGhhc2hjaGFuZ2UgYmluZGluZyBvdGhlcndpc2UgdGhlCgkJLy8gICAgICBuYXZpZ2F0aW9uIGRhdGEgd29uJ3QgYmUgYXR0YWNoZWQgdG8gdGhlIGhhc2hjaGFuZ2UgZXZlbnQgaW4gdGltZSBmb3IgdGhvc2UKCQkvLyAgICAgIGJpbmRpbmdzIHRvIGF0dGFjaCBpdCB0byB0aGUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50CgkJLy8gVE9ETyBhZGQgYSBjaGVjayBoZXJlIHRoYXQgYGhhc2hjaGFuZ2UubmF2aWdhdGVgIGlzIGJvdW5kIGFscmVhZHkgb3RoZXJ3aXNlIGl0J3MKCQkvLyAgICAgIGJyb2tlbiAoZXhjZXB0aW9uPykKCQloYXNoY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBoaXN0b3J5LCBoYXNoOwoKCQkJLy8gSWYgaGFzaGNoYW5nZSBsaXN0ZW5pbmcgaXMgZXhwbGljaXRseSBkaXNhYmxlZCBvciBwdXNoc3RhdGUgaXMgc3VwcG9ydGVkCgkJCS8vIGF2b2lkIG1ha2luZyB1c2Ugb2YgdGhlIGhhc2hjaGFuZ2UgaGFuZGxlci4KCQkJaWYgKCEkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpIHx8CgkJCQkkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIE9uIG9jY2FzaW9uIGV4cGxpY2l0bHkgd2FudCB0byBwcmV2ZW50IHRoZSBuZXh0IGhhc2ggZnJvbSBwcm9wb2dhdGluZyBiZWNhdXNlIHdlIG9ubHkKCQkJLy8gd2l0aCB0byBhbHRlciB0aGUgdXJsIHRvIHJlcHJlc2VudCB0aGUgbmV3IHN0YXRlIGRvIHNvIGhlcmUKCQkJaWYgKCB0aGlzLnByZXZlbnROZXh0SGFzaENoYW5nZSApIHsKCQkJCXRoaXMucHJldmVudE5leHRIYXNoQ2hhbmdlID0gZmFsc2U7CgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJaGlzdG9yeSA9IHRoaXMuaGlzdG9yeTsKCQkJaGFzaCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgoJCQkvLyBJZiB0aGlzIGlzIGEgaGFzaGNoYW5nZSBjYXVzZWQgYnkgdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b24KCQkJLy8gbWFrZSBzdXJlIHRvIHNldCB0aGUgc3RhdGUgb2Ygb3VyIGhpc3Rvcnkgc3RhY2sgcHJvcGVybHkKCQkJdGhpcy5oaXN0b3J5LmRpcmVjdCh7CgkJCQl1cmw6IGhhc2gsCgoJCQkJLy8gV2hlbiB0aGUgdXJsIGlzIGVpdGhlciBmb3J3YXJkIG9yIGJhY2t3YXJkIGluIGhpc3RvcnkgaW5jbHVkZSB0aGUgZW50cnkKCQkJCS8vIGFzIGRhdGEgb24gdGhlIGV2ZW50IG9iamVjdCBmb3IgbWVyZ2luZyBhcyBkYXRhIGluIHRoZSBuYXZpZ2F0ZSBldmVudAoJCQkJcHJlc2VudDogZnVuY3Rpb24oIGhpc3RvcnlFbnRyeSwgZGlyZWN0aW9uICkgewoJCQkJCS8vIG1ha2Ugc3VyZSB0byBjcmVhdGUgYSBuZXcgb2JqZWN0IHRvIHBhc3MgZG93biBhcyB0aGUgbmF2aWdhdGUgZXZlbnQgZGF0YQoJCQkJCWV2ZW50Lmhhc2hjaGFuZ2VTdGF0ZSA9ICQuZXh0ZW5kKHt9LCBoaXN0b3J5RW50cnkpOwoJCQkJCWV2ZW50Lmhhc2hjaGFuZ2VTdGF0ZS5kaXJlY3Rpb24gPSBkaXJlY3Rpb247CgkJCQl9LAoKCQkJCS8vIFdoZW4gd2UgZG9uJ3QgZmluZCBhIGhhc2ggaW4gb3VyIGhpc3RvcnkgY2xlYXJseSB3ZSdyZSBhaW1pbmcgdG8gZ28gdGhlcmUKCQkJCS8vIHJlY29yZCB0aGUgZW50cnkgYXMgbmV3IGZvciBmdXR1cmUgdHJhdmVyc2FsCgkJCQkvLwoJCQkJLy8gTk9URSBpdCdzIG5vdCBlbnRpcmVseSBjbGVhciB0aGF0IHRoaXMgaXMgdGhlIHJpZ2h0IHRoaW5nIHRvIGRvIGdpdmVuIHRoYXQgd2UKCQkJCS8vICAgICAgY2FuJ3Qga25vdyB0aGUgdXNlcnMgaW50ZW50aW9uLiBJdCBtaWdodCBiZSBiZXR0ZXIgdG8gZXhwbGljaXRseSBfbm90XwoJCQkJLy8gICAgICBzdXBwb3J0IGxvY2F0aW9uLmhhc2ggYXNzaWdubWVudCBpbiBwcmVmZXJlbmNlIHRvICQubmF2aWdhdGUgY2FsbHMKCQkJCS8vIFRPRE8gZmlyc3QgYXJnIHRvIGFkZCBzaG91bGQgYmUgdGhlIGhyZWYsIGJ1dCBpdCBjYXVzZXMgaXNzdWVzIGluIGlkZW50aWZ5aW5nCgkJCQkvLyAgICAgIGVtYmVkZWQgcGFnZXMKCQkJCW1pc3Npbmc6IGZ1bmN0aW9uKCkgewoJCQkJCWhpc3RvcnkuYWRkKCBoYXNoLCB7CgkJCQkJCWhhc2g6IGhhc2gsCgkJCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZQoJCQkJCX0pOwoJCQkJfQoJCQl9KTsKCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCS8vIFRPRE8gY29uc2lkZXIgcXVldWVpbmcgbmF2aWdhdGlvbiBhY3Rpdml0eSB1bnRpbCBwcmV2aW91cyBhY3Rpdml0aWVzIGhhdmUgY29tcGxldGVkCgkvLyAgICAgIHNvIHRoYXQgZW5kIHVzZXJzIGRvbid0IGhhdmUgdG8gdGhpbmsgYWJvdXQgaXQuIFB1bnRpbmcgZm9yIG5vdwoJLy8gVE9ETyAhISBtb3ZlIHRoZSBldmVudCBiaW5kaW5ncyBpbnRvIGNhbGxiYWNrcyBvbiB0aGUgbmF2aWdhdGUgZXZlbnQKCSQubW9iaWxlLm5hdmlnYXRlID0gZnVuY3Rpb24oIHVybCwgZGF0YSwgbm9FdmVudHMgKSB7CgkJJC5tb2JpbGUubmF2aWdhdGUubmF2aWdhdG9yLmdvKCB1cmwsIGRhdGEsIG5vRXZlbnRzICk7Cgl9OwoKCS8vIGV4cG9zZSB0aGUgaGlzdG9yeSBvbiB0aGUgbmF2aWdhdGUgbWV0aG9kIGluIGFudGljaXBhdGlvbiBvZiBmdWxsIGludGVncmF0aW9uIHdpdGgKCS8vIGV4aXN0aW5nIG5hdmlnYXRpb24gZnVuY3Rpb25hbHR5IHRoYXQgaXMgdGlnaHRseSBjb3VwbGVkIHRvIHRoZSBoaXN0b3J5IGluZm9ybWF0aW9uCgkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5ID0gbmV3ICQubW9iaWxlLkhpc3RvcnkoKTsKCgkvLyBpbnN0YW50aWF0ZSBhbiBpbnN0YW5jZSBvZiB0aGUgbmF2aWdhdG9yIGZvciB1c2Ugd2l0aGluIHRoZSAkLm5hdmlnYXRlIG1ldGhvZAoJJC5tb2JpbGUubmF2aWdhdGUubmF2aWdhdG9yID0gbmV3ICQubW9iaWxlLk5hdmlnYXRvciggJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeSApOwoKCXZhciBsb2MgPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKTsKCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuYWRkKCBsb2MuaHJlZiwge2hhc2g6IGxvYy5oYXNofSApOwp9KSggalF1ZXJ5ICk7CgoKLy8gVGhpcyBwbHVnaW4gaXMgYW4gZXhwZXJpbWVudCBmb3IgYWJzdHJhY3RpbmcgYXdheSB0aGUgdG91Y2ggYW5kIG1vdXNlCi8vIGV2ZW50cyBzbyB0aGF0IGRldmVsb3BlcnMgZG9uJ3QgaGF2ZSB0byB3b3JyeSBhYm91dCB3aGljaCBtZXRob2Qgb2YgaW5wdXQKLy8gdGhlIGRldmljZSB0aGVpciBkb2N1bWVudCBpcyBsb2FkZWQgb24gc3VwcG9ydHMuCi8vCi8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gYWxsb3cgdGhlIGRldmVsb3BlciB0byByZWdpc3RlciBsaXN0ZW5lcnMgZm9yIHRoZQovLyBiYXNpYyBtb3VzZSBldmVudHMsIHN1Y2ggYXMgbW91c2Vkb3duLCBtb3VzZW1vdmUsIG1vdXNldXAsIGFuZCBjbGljaywKLy8gYW5kIHRoZSBwbHVnaW4gd2lsbCB0YWtlIGNhcmUgb2YgcmVnaXN0ZXJpbmcgdGhlIGNvcnJlY3QgbGlzdGVuZXJzCi8vIGJlaGluZCB0aGUgc2NlbmVzIHRvIGludm9rZSB0aGUgbGlzdGVuZXIgYXQgdGhlIGZhc3Rlc3QgcG9zc2libGUgdGltZQovLyBmb3IgdGhhdCBkZXZpY2UsIHdoaWxlIHN0aWxsIHJldGFpbmluZyB0aGUgb3JkZXIgb2YgZXZlbnQgZmlyaW5nIGluCi8vIHRoZSB0cmFkaXRpb25hbCBtb3VzZSBlbnZpcm9ubWVudCwgc2hvdWxkIG11bHRpcGxlIGhhbmRsZXJzIGJlIHJlZ2lzdGVyZWQKLy8gb24gdGhlIHNhbWUgZWxlbWVudCBmb3IgZGlmZmVyZW50IGV2ZW50cy4KLy8KLy8gVGhlIGN1cnJlbnQgdmVyc2lvbiBleHBvc2VzIHRoZSBmb2xsb3dpbmcgdmlydHVhbCBldmVudHMgdG8galF1ZXJ5IGJpbmQgbWV0aG9kczoKLy8gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7Cgp2YXIgZGF0YVByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsTW91c2VCaW5kaW5ncyIsCgl0b3VjaFRhcmdldFByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsVG91Y2hJRCIsCgl2aXJ0dWFsRXZlbnROYW1lcyA9ICJ2bW91c2VvdmVyIHZtb3VzZWRvd24gdm1vdXNlbW92ZSB2bW91c2V1cCB2Y2xpY2sgdm1vdXNlb3V0IHZtb3VzZWNhbmNlbCIuc3BsaXQoICIgIiApLAoJdG91Y2hFdmVudFByb3BzID0gImNsaWVudFggY2xpZW50WSBwYWdlWCBwYWdlWSBzY3JlZW5YIHNjcmVlblkiLnNwbGl0KCAiICIgKSwKCW1vdXNlSG9va1Byb3BzID0gJC5ldmVudC5tb3VzZUhvb2tzID8gJC5ldmVudC5tb3VzZUhvb2tzLnByb3BzIDogW10sCgltb3VzZUV2ZW50UHJvcHMgPSAkLmV2ZW50LnByb3BzLmNvbmNhdCggbW91c2VIb29rUHJvcHMgKSwKCWFjdGl2ZURvY0hhbmRsZXJzID0ge30sCglyZXNldFRpbWVySUQgPSAwLAoJc3RhcnRYID0gMCwKCXN0YXJ0WSA9IDAsCglkaWRTY3JvbGwgPSBmYWxzZSwKCWNsaWNrQmxvY2tMaXN0ID0gW10sCglibG9ja01vdXNlVHJpZ2dlcnMgPSBmYWxzZSwKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlLAoJZXZlbnRDYXB0dXJlU3VwcG9ydGVkID0gImFkZEV2ZW50TGlzdGVuZXIiIGluIGRvY3VtZW50LAoJJGRvY3VtZW50ID0gJCggZG9jdW1lbnQgKSwKCW5leHRUb3VjaElEID0gMSwKCWxhc3RUb3VjaElEID0gMCwgdGhyZXNob2xkLAoJaTsKCiQudm1vdXNlID0gewoJbW92ZURpc3RhbmNlVGhyZXNob2xkOiAxMCwKCWNsaWNrRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJcmVzZXRUaW1lckR1cmF0aW9uOiAxNTAwCn07CgpmdW5jdGlvbiBnZXROYXRpdmVFdmVudCggZXZlbnQgKSB7CgoJd2hpbGUgKCBldmVudCAmJiB0eXBlb2YgZXZlbnQub3JpZ2luYWxFdmVudCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJZXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJfQoJcmV0dXJuIGV2ZW50Owp9CgpmdW5jdGlvbiBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKSB7CgoJdmFyIHQgPSBldmVudC50eXBlLAoJCW9lLCBwcm9wcywgbmUsIHByb3AsIGN0LCB0b3VjaCwgaSwgaiwgbGVuOwoKCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCWV2ZW50LnR5cGUgPSBldmVudFR5cGU7CgoJb2UgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJcHJvcHMgPSAkLmV2ZW50LnByb3BzOwoKCS8vIGFkZHJlc3NlcyBzZXBhcmF0aW9uIG9mICQuZXZlbnQucHJvcHMgaW4gdG8gJC5ldmVudC5tb3VzZUhvb2sucHJvcHMgYW5kIElzc3VlIDMyODAKCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzI4MAoJaWYgKCB0LnNlYXJjaCggL14obW91c2V8Y2xpY2spLyApID4gLTEgKSB7CgkJcHJvcHMgPSBtb3VzZUV2ZW50UHJvcHM7Cgl9CgoJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJLy8gdGhpcyB3b3VsZCBoYXBwZW4gaWYgd2UgY291bGQgY2FsbCAkLmV2ZW50LmZpeCBpbnN0ZWFkIG9mICQuRXZlbnQKCS8vIGJ1dCB3ZSBkb24ndCBoYXZlIGEgd2F5IHRvIGZvcmNlIGFuIGV2ZW50IHRvIGJlIGZpeGVkIG11bHRpcGxlIHRpbWVzCglpZiAoIG9lICkgewoJCWZvciAoIGkgPSBwcm9wcy5sZW5ndGgsIHByb3A7IGk7ICkgewoJCQlwcm9wID0gcHJvcHNbIC0taSBdOwoJCQlldmVudFsgcHJvcCBdID0gb2VbIHByb3AgXTsKCQl9Cgl9CgoJLy8gbWFrZSBzdXJlIHRoYXQgaWYgdGhlIG1vdXNlIGFuZCBjbGljayB2aXJ0dWFsIGV2ZW50cyBhcmUgZ2VuZXJhdGVkCgkvLyB3aXRob3V0IGEgLndoaWNoIG9uZSBpcyBkZWZpbmVkCglpZiAoIHQuc2VhcmNoKC9tb3VzZShkb3dufHVwKXxjbGljay8pID4gLTEgJiYgIWV2ZW50LndoaWNoICkgewoJCWV2ZW50LndoaWNoID0gMTsKCX0KCglpZiAoIHQuc2VhcmNoKC9edG91Y2gvKSAhPT0gLTEgKSB7CgkJbmUgPSBnZXROYXRpdmVFdmVudCggb2UgKTsKCQl0ID0gbmUudG91Y2hlczsKCQljdCA9IG5lLmNoYW5nZWRUb3VjaGVzOwoJCXRvdWNoID0gKCB0ICYmIHQubGVuZ3RoICkgPyB0WzBdIDogKCAoIGN0ICYmIGN0Lmxlbmd0aCApID8gY3RbIDAgXSA6IHVuZGVmaW5lZCApOwoKCQlpZiAoIHRvdWNoICkgewoJCQlmb3IgKCBqID0gMCwgbGVuID0gdG91Y2hFdmVudFByb3BzLmxlbmd0aDsgaiA8IGxlbjsgaisrKSB7CgkJCQlwcm9wID0gdG91Y2hFdmVudFByb3BzWyBqIF07CgkJCQlldmVudFsgcHJvcCBdID0gdG91Y2hbIHByb3AgXTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGVsZW1lbnQgKSB7CgoJdmFyIGZsYWdzID0ge30sCgkJYiwgazsKCgl3aGlsZSAoIGVsZW1lbnQgKSB7CgoJCWIgPSAkLmRhdGEoIGVsZW1lbnQsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJZm9yICggIGsgaW4gYiApIHsKCQkJaWYgKCBiWyBrIF0gKSB7CgkJCQlmbGFnc1sgayBdID0gZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgPSB0cnVlOwoJCQl9CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gZmxhZ3M7Cn0KCmZ1bmN0aW9uIGdldENsb3Nlc3RFbGVtZW50V2l0aFZpcnR1YWxCaW5kaW5nKCBlbGVtZW50LCBldmVudFR5cGUgKSB7Cgl2YXIgYjsKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlpZiAoIGIgJiYgKCAhZXZlbnRUeXBlIHx8IGJbIGV2ZW50VHlwZSBdICkgKSB7CgkJCXJldHVybiBlbGVtZW50OwoJCX0KCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJfQoJcmV0dXJuIG51bGw7Cn0KCmZ1bmN0aW9uIGVuYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSBmYWxzZTsKfQoKZnVuY3Rpb24gZGlzYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSB0cnVlOwp9CgpmdW5jdGlvbiBlbmFibGVNb3VzZUJpbmRpbmdzKCkgewoJbGFzdFRvdWNoSUQgPSAwOwoJY2xpY2tCbG9ja0xpc3QubGVuZ3RoID0gMDsKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlOwoKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGVuYWJsZWQsIG91cgoJLy8gdG91Y2ggYmluZGluZ3MgYXJlIGRpc2FibGVkLgoJZGlzYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gZGlzYWJsZU1vdXNlQmluZGluZ3MoKSB7CgkvLyBXaGVuIG1vdXNlIGJpbmRpbmdzIGFyZSBkaXNhYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZW5hYmxlZC4KCWVuYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gc3RhcnRSZXNldFRpbWVyKCkgewoJY2xlYXJSZXNldFRpbWVyKCk7CglyZXNldFRpbWVySUQgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQlyZXNldFRpbWVySUQgPSAwOwoJCWVuYWJsZU1vdXNlQmluZGluZ3MoKTsKCX0sICQudm1vdXNlLnJlc2V0VGltZXJEdXJhdGlvbiApOwp9CgpmdW5jdGlvbiBjbGVhclJlc2V0VGltZXIoKSB7CglpZiAoIHJlc2V0VGltZXJJRCApIHsKCQljbGVhclRpbWVvdXQoIHJlc2V0VGltZXJJRCApOwoJCXJlc2V0VGltZXJJRCA9IDA7Cgl9Cn0KCmZ1bmN0aW9uIHRyaWdnZXJWaXJ0dWFsRXZlbnQoIGV2ZW50VHlwZSwgZXZlbnQsIGZsYWdzICkgewoJdmFyIHZlOwoKCWlmICggKCBmbGFncyAmJiBmbGFnc1sgZXZlbnRUeXBlIF0gKSB8fAoJCQkJKCAhZmxhZ3MgJiYgZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGV2ZW50LnRhcmdldCwgZXZlbnRUeXBlICkgKSApIHsKCgkJdmUgPSBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKTsKCgkJJCggZXZlbnQudGFyZ2V0KS50cmlnZ2VyKCB2ZSApOwoJfQoKCXJldHVybiB2ZTsKfQoKZnVuY3Rpb24gbW91c2VFdmVudENhbGxiYWNrKCBldmVudCApIHsKCXZhciB0b3VjaElEID0gJC5kYXRhKCBldmVudC50YXJnZXQsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lICksCgkJdmU7CgoJaWYgKCAhYmxvY2tNb3VzZVRyaWdnZXJzICYmICggIWxhc3RUb3VjaElEIHx8IGxhc3RUb3VjaElEICE9PSB0b3VjaElEICkgKSB7CgkJdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidiIgKyBldmVudC50eXBlLCBldmVudCApOwoJCWlmICggdmUgKSB7CgkJCWlmICggdmUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJCWlmICggdmUuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJCWlmICggdmUuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQl9CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaFN0YXJ0KCBldmVudCApIHsKCgl2YXIgdG91Y2hlcyA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXMsCgkJdGFyZ2V0LCBmbGFncywgdDsKCglpZiAoIHRvdWNoZXMgJiYgdG91Y2hlcy5sZW5ndGggPT09IDEgKSB7CgoJCXRhcmdldCA9IGV2ZW50LnRhcmdldDsKCQlmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIHRhcmdldCApOwoKCQlpZiAoIGZsYWdzLmhhc1ZpcnR1YWxCaW5kaW5nICkgewoKCQkJbGFzdFRvdWNoSUQgPSBuZXh0VG91Y2hJRCsrOwoJCQkkLmRhdGEoIHRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUsIGxhc3RUb3VjaElEICk7CgoJCQljbGVhclJlc2V0VGltZXIoKTsKCgkJCWRpc2FibGVNb3VzZUJpbmRpbmdzKCk7CgkJCWRpZFNjcm9sbCA9IGZhbHNlOwoKCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXNbIDAgXTsKCQkJc3RhcnRYID0gdC5wYWdlWDsKCQkJc3RhcnRZID0gdC5wYWdlWTsKCgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VvdmVyIiwgZXZlbnQsIGZsYWdzICk7CgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vkb3duIiwgZXZlbnQsIGZsYWdzICk7CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVTY3JvbGwoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggIWRpZFNjcm9sbCApIHsKCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlY2FuY2VsIiwgZXZlbnQsIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApICk7Cgl9CgoJZGlkU2Nyb2xsID0gdHJ1ZTsKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaE1vdmUoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciB0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdLAoJCWRpZENhbmNlbCA9IGRpZFNjcm9sbCwKCQltb3ZlVGhyZXNob2xkID0gJC52bW91c2UubW92ZURpc3RhbmNlVGhyZXNob2xkLAoJCWZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICk7CgoJCWRpZFNjcm9sbCA9IGRpZFNjcm9sbCB8fAoJCQkoIE1hdGguYWJzKCB0LnBhZ2VYIC0gc3RhcnRYICkgPiBtb3ZlVGhyZXNob2xkIHx8CgkJCQlNYXRoLmFicyggdC5wYWdlWSAtIHN0YXJ0WSApID4gbW92ZVRocmVzaG9sZCApOwoKCWlmICggZGlkU2Nyb2xsICYmICFkaWRDYW5jZWwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBmbGFncyApOwoJfQoKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vtb3ZlIiwgZXZlbnQsIGZsYWdzICk7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7CgoJdmFyIGZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICksCgkJdmUsIHQ7Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNldXAiLCBldmVudCwgZmxhZ3MgKTsKCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidmNsaWNrIiwgZXZlbnQsIGZsYWdzICk7CgkJaWYgKCB2ZSAmJiB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJLy8gVGhlIHRhcmdldCBvZiB0aGUgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IHRoZSB0b3VjaGVuZAoJCQkvLyBldmVudCBkb24ndCBuZWNlc3NhcmlseSBtYXRjaCB0aGUgdGFyZ2V0IHVzZWQgZHVyaW5nIHRoZQoJCQkvLyB0b3VjaC4gVGhpcyBtZWFucyB3ZSBuZWVkIHRvIHJlbHkgb24gY29vcmRpbmF0ZXMgZm9yIGJsb2NraW5nCgkJCS8vIGFueSBjbGljayB0aGF0IGlzIGdlbmVyYXRlZC4KCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLmNoYW5nZWRUb3VjaGVzWyAwIF07CgkJCWNsaWNrQmxvY2tMaXN0LnB1c2goewoJCQkJdG91Y2hJRDogbGFzdFRvdWNoSUQsCgkJCQl4OiB0LmNsaWVudFgsCgkJCQl5OiB0LmNsaWVudFkKCQkJfSk7CgoJCQkvLyBQcmV2ZW50IGFueSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgZnJvbSB0cmlnZ2VyaW5nCgkJCS8vIHZpcnR1YWwgZXZlbnQgbm90aWZpY2F0aW9ucy4KCQkJYmxvY2tNb3VzZVRyaWdnZXJzID0gdHJ1ZTsKCQl9Cgl9Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3V0IiwgZXZlbnQsIGZsYWdzKTsKCWRpZFNjcm9sbCA9IGZhbHNlOwoKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYXNWaXJ0dWFsQmluZGluZ3MoIGVsZSApIHsKCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggZWxlLCBkYXRhUHJvcGVydHlOYW1lICksCgkJazsKCglpZiAoIGJpbmRpbmdzICkgewoJCWZvciAoIGsgaW4gYmluZGluZ3MgKSB7CgkJCWlmICggYmluZGluZ3NbIGsgXSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoJfQoJcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBkdW1teU1vdXNlSGFuZGxlcigpIHt9CgpmdW5jdGlvbiBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIGV2ZW50VHlwZSApIHsKCXZhciByZWFsVHlwZSA9IGV2ZW50VHlwZS5zdWJzdHIoIDEgKTsKCglyZXR1cm4gewoJCXNldHVwOiBmdW5jdGlvbigvKiBkYXRhLCBuYW1lc3BhY2UgKi8pIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGZvciB0aGlzIGVsZW1lbnQsCgkJCS8vIGFkZCBhIGJpbmRpbmdzIG9iamVjdCB0byBpdHMgZGF0YS4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lLCB7fSApOwoJCQl9CgoJCQkvLyBJZiBzZXR1cCBpcyBjYWxsZWQsIHdlIGtub3cgaXQgaXMgdGhlIGZpcnN0IGJpbmRpbmcgZm9yIHRoaXMKCQkJLy8gZXZlbnRUeXBlLCBzbyBpbml0aWFsaXplIHRoZSBjb3VudCBmb3IgdGhlIGV2ZW50VHlwZSB0byB6ZXJvLgoJCQl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gdHJ1ZTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgZXZlbnQgZm9yIHRoaXMgdHlwZSwKCQkJLy8gcmVnaXN0ZXIgYSBnbG9iYWwgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQlhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSB8fCAwICkgKyAxOwoKCQkJaWYgKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPT09IDEgKSB7CgkJCQkkZG9jdW1lbnQuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQkvLyBTb21lIGJyb3dzZXJzLCBsaWtlIE9wZXJhIE1pbmksIHdvbid0IGRpc3BhdGNoIG1vdXNlL2NsaWNrIGV2ZW50cwoJCQkvLyBmb3IgZWxlbWVudHMgdW5sZXNzIHRoZXkgYWN0dWFsbHkgaGF2ZSBoYW5kbGVycyByZWdpc3RlcmVkIG9uIHRoZW0uCgkJCS8vIFRvIGdldCBhcm91bmQgdGhpcywgd2UgcmVnaXN0ZXIgZHVtbXkgaGFuZGxlcnMgb24gdGhlIGVsZW1lbnRzLgoKCQkJJCggdGhpcyApLmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gRm9yIG5vdywgaWYgZXZlbnQgY2FwdHVyZSBpcyBub3Qgc3VwcG9ydGVkLCB3ZSByZWx5IG9uIG1vdXNlIGhhbmRsZXJzLgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhlIGRvY3VtZW50LAoJCQkJLy8gcmVnaXN0ZXIgb3VyIHRvdWNoc3RhcnQgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQkJYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gfHwgMCkgKyAxOwoKCQkJCWlmICggYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID09PSAxICkgewoJCQkJCSRkb2N1bWVudC5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoKCQkJCQkJLy8gT24gdG91Y2ggcGxhdGZvcm1zLCB0b3VjaGluZyB0aGUgc2NyZWVuIGFuZCB0aGVuIGRyYWdnaW5nIHlvdXIgZmluZ2VyCgkJCQkJCS8vIGNhdXNlcyB0aGUgd2luZG93IGNvbnRlbnQgdG8gc2Nyb2xsIGFmdGVyIHNvbWUgZGlzdGFuY2UgdGhyZXNob2xkIGlzCgkJCQkJCS8vIGV4Y2VlZGVkLiBPbiB0aGVzZSBwbGF0Zm9ybXMsIGEgc2Nyb2xsIHByZXZlbnRzIGEgY2xpY2sgZXZlbnQgZnJvbSBiZWluZwoJCQkJCQkvLyBkaXNwYXRjaGVkLCBhbmQgb24gc29tZSBwbGF0Zm9ybXMsIGV2ZW4gdGhlIHRvdWNoZW5kIGlzIHN1cHByZXNzZWQuIFRvCgkJCQkJCS8vIG1pbWljIHRoZSBzdXBwcmVzc2lvbiBvZiB0aGUgY2xpY2sgZXZlbnQsIHdlIG5lZWQgdG8gd2F0Y2ggZm9yIGEgc2Nyb2xsCgkJCQkJCS8vIGV2ZW50LiBVbmZvcnR1bmF0ZWx5LCBzb21lIHBsYXRmb3JtcyBsaWtlIGlPUyBkb24ndCBkaXNwYXRjaCBzY3JvbGwKCQkJCQkJLy8gZXZlbnRzIHVudGlsICpBRlRFUiogdGhlIHVzZXIgbGlmdHMgdGhlaXIgZmluZ2VyICh0b3VjaGVuZCkuIFRoaXMgbWVhbnMKCQkJCQkJLy8gd2UgbmVlZCB0byB3YXRjaCBib3RoIHNjcm9sbCBhbmQgdG91Y2htb3ZlIGV2ZW50cyB0byBmaWd1cmUgb3V0IHdoZXRoZXIKCQkJCQkJLy8gb3Igbm90IGEgc2Nyb2xsIGhhcHBlbmVucyBiZWZvcmUgdGhlIHRvdWNoZW5kIGV2ZW50IGlzIGZpcmVkLgoKCQkJCQkJLmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkuYmluZCggInNjcm9sbCIsIGhhbmRsZVNjcm9sbCApOwoJCQkJfQoJCQl9CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKC8qIGRhdGEsIG5hbWVzcGFjZSAqLykgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgYmluZGluZyBmb3IgdGhpcyBldmVudFR5cGUsCgkJCS8vIHJlbW92ZSBpdHMgZ2xvYmFsIGhhbmRsZXIgZnJvbSB0aGUgZG9jdW1lbnQuCgoJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXTsKCgkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSApIHsKCQkJCSRkb2N1bWVudC51bmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBpbiBleGlzdGVuY2UsCgkJCQkvLyByZW1vdmUgb3VyIGRvY3VtZW50IHRvdWNoc3RhcnQgbGlzdGVuZXIuCgoJCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF07CgoJCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdICkgewoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS51bmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkudW5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgkJCQkJCS51bmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJCS8vIHRlYXJkb3duIG1heSBiZSBjYWxsZWQgd2hlbiBhbiBlbGVtZW50IHdhcwoJCQkvLyByZW1vdmVkIGZyb20gdGhlIERPTS4gSWYgdGhpcyBpcyB0aGUgY2FzZSwKCQkJLy8galF1ZXJ5IGNvcmUgbWF5IGhhdmUgYWxyZWFkeSBzdHJpcHBlZCB0aGUgZWxlbWVudAoJCQkvLyBvZiBhbnkgZGF0YSBiaW5kaW5ncyBzbyB3ZSBuZWVkIHRvIGNoZWNrIGl0IGJlZm9yZQoJCQkvLyB1c2luZyBpdC4KCQkJaWYgKCBiaW5kaW5ncyApIHsKCQkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IGZhbHNlOwoJCQl9CgoJCQkvLyBVbnJlZ2lzdGVyIHRoZSBkdW1teSBldmVudCBoYW5kbGVyLgoKCQkJJHRoaXMudW5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIG9uIHRoZQoJCQkvLyBlbGVtZW50LCByZW1vdmUgdGhlIGJpbmRpbmcgZGF0YSBmcm9tIHRoZSBlbGVtZW50LgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkdGhpcy5yZW1vdmVEYXRhKCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCX0KCQl9Cgl9Owp9CgovLyBFeHBvc2Ugb3VyIGN1c3RvbSBldmVudHMgdG8gdGhlIGpRdWVyeSBiaW5kL3VuYmluZCBtZWNoYW5pc20uCgpmb3IgKCBpID0gMDsgaSA8IHZpcnR1YWxFdmVudE5hbWVzLmxlbmd0aDsgaSsrICkgewoJJC5ldmVudC5zcGVjaWFsWyB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdIF0gPSBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gKTsKfQoKLy8gQWRkIGEgY2FwdHVyZSBjbGljayBoYW5kbGVyIHRvIGJsb2NrIGNsaWNrcy4KLy8gTm90ZSB0aGF0IHdlIHJlcXVpcmUgZXZlbnQgY2FwdHVyZSBzdXBwb3J0IGZvciB0aGlzIHNvIGlmIHRoZSBkZXZpY2UKLy8gZG9lc24ndCBzdXBwb3J0IGl0LCB3ZSBwdW50IGZvciBub3cgYW5kIHJlbHkgc29sZWx5IG9uIG1vdXNlIGV2ZW50cy4KaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7Cglkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQl2YXIgY250ID0gY2xpY2tCbG9ja0xpc3QubGVuZ3RoLAoJCQl0YXJnZXQgPSBlLnRhcmdldCwKCQkJeCwgeSwgZWxlLCBpLCBvLCB0b3VjaElEOwoKCQlpZiAoIGNudCApIHsKCQkJeCA9IGUuY2xpZW50WDsKCQkJeSA9IGUuY2xpZW50WTsKCQkJdGhyZXNob2xkID0gJC52bW91c2UuY2xpY2tEaXN0YW5jZVRocmVzaG9sZDsKCgkJCS8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gcnVuIHRocm91Z2ggdGhlIGNsaWNrQmxvY2tMaXN0IHRvIHNlZSBpZgoJCQkvLyB0aGUgY3VycmVudCBjbGljayBldmVudCBpcyBpbiB0aGUgcHJveGltaXR5IG9mIG9uZSBvZiBvdXIKCQkJLy8gdmNsaWNrIGV2ZW50cyB0aGF0IGhhZCBwcmV2ZW50RGVmYXVsdCgpIGNhbGxlZCBvbiBpdC4gSWYgd2UgZmluZAoJCQkvLyBvbmUsIHRoZW4gd2UgYmxvY2sgdGhlIGNsaWNrLgoJCQkvLwoJCQkvLyBXaHkgZG8gd2UgaGF2ZSB0byByZWx5IG9uIHByb3hpbWl0eT8KCQkJLy8KCQkJLy8gQmVjYXVzZSB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaCBldmVudCB0aGF0IHRyaWdnZXJlZCB0aGUgdmNsaWNrCgkJCS8vIGNhbiBiZSBkaWZmZXJlbnQgZnJvbSB0aGUgdGFyZ2V0IG9mIHRoZSBjbGljayBldmVudCBzeW50aGVzaXplZAoJCQkvLyBieSB0aGUgYnJvd3Nlci4gVGhlIHRhcmdldCBvZiBhIG1vdXNlL2NsaWNrIGV2ZW50IHRoYXQgaXMgc3ludGhlc2l6ZWQKCQkJLy8gZnJvbSBhIHRvdWNoIGV2ZW50IHNlZW1zIHRvIGJlIGltcGxlbWVudGF0aW9uIHNwZWNpZmljLiBGb3IgZXhhbXBsZSwKCQkJLy8gc29tZSBicm93c2VycyB3aWxsIGZpcmUgbW91c2UvY2xpY2sgZXZlbnRzIGZvciBhIGxpbmsgdGhhdCBpcyBuZWFyCgkJCS8vIGEgdG91Y2ggZXZlbnQsIGV2ZW4gdGhvdWdoIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoc3RhcnQvdG91Y2hlbmQgZXZlbnQKCQkJLy8gc2F5cyB0aGUgdXNlciB0b3VjaGVkIG91dHNpZGUgdGhlIGxpbmsuIEFsc28sIGl0IHNlZW1zIHRoYXQgd2l0aCBtb3N0CgkJCS8vIGJyb3dzZXJzLCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayBldmVudCBpcyBub3QgY2FsY3VsYXRlZCB1bnRpbCB0aGUKCQkJLy8gdGltZSBpdCBpcyBkaXNwYXRjaGVkLCBzbyBpZiB5b3UgcmVwbGFjZSBhbiBlbGVtZW50IHRoYXQgeW91IHRvdWNoZWQKCQkJLy8gd2l0aCBhbm90aGVyIGVsZW1lbnQsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIHdpbGwgYmUgdGhlIG5ldwoJCQkvLyBlbGVtZW50IHVuZGVybmVhdGggdGhhdCBwb2ludC4KCQkJLy8KCQkJLy8gQXNpZGUgZnJvbSBwcm94aW1pdHksIHdlIGFsc28gY2hlY2sgdG8gc2VlIGlmIHRoZSB0YXJnZXQgYW5kIGFueQoJCQkvLyBvZiBpdHMgYW5jZXN0b3JzIHdlcmUgdGhlIG9uZXMgdGhhdCBibG9ja2VkIGEgY2xpY2suIFRoaXMgaXMgbmVjZXNzYXJ5CgkJCS8vIGJlY2F1c2Ugb2YgdGhlIHN0cmFuZ2UgbW91c2UvY2xpY2sgdGFyZ2V0IGNhbGN1bGF0aW9uIGRvbmUgaW4gdGhlCgkJCS8vIEFuZHJvaWQgMi4xIGJyb3dzZXIsIHdoZXJlIGlmIHlvdSBjbGljayBvbiBhbiBlbGVtZW50LCBhbmQgdGhlcmUgaXMgYQoJCQkvLyBtb3VzZS9jbGljayBoYW5kbGVyIG9uIG9uZSBvZiBpdHMgYW5jZXN0b3JzLCB0aGUgdGFyZ2V0IHdpbGwgYmUgdGhlCgkJCS8vIGlubmVybW9zdCBjaGlsZCBvZiB0aGUgdG91Y2hlZCBlbGVtZW50LCBldmVuIGlmIHRoYXQgY2hpbGQgaXMgbm8gd2hlcmUKCQkJLy8gbmVhciB0aGUgcG9pbnQgb2YgdG91Y2guCgoJCQllbGUgPSB0YXJnZXQ7CgoJCQl3aGlsZSAoIGVsZSApIHsKCQkJCWZvciAoIGkgPSAwOyBpIDwgY250OyBpKysgKSB7CgkJCQkJbyA9IGNsaWNrQmxvY2tMaXN0WyBpIF07CgkJCQkJdG91Y2hJRCA9IDA7CgoJCQkJCWlmICggKCBlbGUgPT09IHRhcmdldCAmJiBNYXRoLmFicyggby54IC0geCApIDwgdGhyZXNob2xkICYmIE1hdGguYWJzKCBvLnkgLSB5ICkgPCB0aHJlc2hvbGQgKSB8fAoJCQkJCQkJCSQuZGF0YSggZWxlLCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSApID09PSBvLnRvdWNoSUQgKSB7CgkJCQkJCS8vIFhYWDogV2UgbWF5IHdhbnQgdG8gY29uc2lkZXIgcmVtb3ZpbmcgbWF0Y2hlcyBmcm9tIHRoZSBibG9jayBsaXN0CgkJCQkJCS8vICAgICAgaW5zdGVhZCBvZiB3YWl0aW5nIGZvciB0aGUgcmVzZXQgdGltZXIgdG8gZmlyZS4KCQkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJfQoJCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJCX0KCQl9Cgl9LCB0cnVlKTsKfQp9KSggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhciAkZG9jdW1lbnQgPSAkKCBkb2N1bWVudCApLAoJCXN1cHBvcnRUb3VjaCA9ICQubW9iaWxlLnN1cHBvcnQudG91Y2gsCgkJc2Nyb2xsRXZlbnQgPSAidG91Y2htb3ZlIHNjcm9sbCIsCgkJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgkJdG91Y2hTdG9wRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hlbmQiIDogIm1vdXNldXAiLAoJCXRvdWNoTW92ZUV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNobW92ZSIgOiAibW91c2Vtb3ZlIjsKCgkvLyBzZXR1cCBuZXcgZXZlbnQgc2hvcnRjdXRzCgkkLmVhY2goICggInRvdWNoc3RhcnQgdG91Y2htb3ZlIHRvdWNoZW5kICIgKwoJCSJ0YXAgdGFwaG9sZCAiICsKCQkic3dpcGUgc3dpcGVsZWZ0IHN3aXBlcmlnaHQgIiArCgkJInNjcm9sbHN0YXJ0IHNjcm9sbHN0b3AiICkuc3BsaXQoICIgIiApLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgkJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCQlyZXR1cm4gZm4gPyB0aGlzLmJpbmQoIG5hbWUsIGZuICkgOiB0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCQl9OwoKCQkvLyBqUXVlcnkgPCAxLjgKCQlpZiAoICQuYXR0ckZuICkgewoJCQkkLmF0dHJGblsgbmFtZSBdID0gdHJ1ZTsKCQl9Cgl9KTsKCglmdW5jdGlvbiB0cmlnZ2VyQ3VzdG9tRXZlbnQoIG9iaiwgZXZlbnRUeXBlLCBldmVudCApIHsKCQl2YXIgb3JpZ2luYWxUeXBlID0gZXZlbnQudHlwZTsKCQlldmVudC50eXBlID0gZXZlbnRUeXBlOwoJCSQuZXZlbnQuZGlzcGF0Y2guY2FsbCggb2JqLCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSBvcmlnaW5hbFR5cGU7Cgl9CgoJLy8gYWxzbyBoYW5kbGVzIHNjcm9sbHN0b3AKCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydCA9IHsKCgkJZW5hYmxlZDogdHJ1ZSwKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKSwKCQkJCXNjcm9sbGluZywKCQkJCXRpbWVyOwoKCQkJZnVuY3Rpb24gdHJpZ2dlciggZXZlbnQsIHN0YXRlICkgewoJCQkJc2Nyb2xsaW5nID0gc3RhdGU7CgkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsIHNjcm9sbGluZyA/ICJzY3JvbGxzdGFydCIgOiAic2Nyb2xsc3RvcCIsIGV2ZW50ICk7CgkJCX0KCgkJCS8vIGlQaG9uZSB0cmlnZ2VycyBzY3JvbGwgYWZ0ZXIgYSBzbWFsbCBkZWxheTsgdXNlIHRvdWNobW92ZSBpbnN0ZWFkCgkJCSR0aGlzLmJpbmQoIHNjcm9sbEV2ZW50LCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICggIXNjcm9sbGluZyApIHsKCQkJCQl0cmlnZ2VyKCBldmVudCwgdHJ1ZSApOwoJCQkJfQoKCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCXRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlciggZXZlbnQsIGZhbHNlICk7CgkJCQl9LCA1MCApOwoJCQl9KTsKCQl9LAoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJJCggdGhpcyApLnVuYmluZCggc2Nyb2xsRXZlbnQgKTsKCQl9Cgl9OwoKCS8vIGFsc28gaGFuZGxlcyB0YXBob2xkCgkkLmV2ZW50LnNwZWNpYWwudGFwID0gewoJCXRhcGhvbGRUaHJlc2hvbGQ6IDc1MCwKCQllbWl0VGFwT25UYXBob2xkOiB0cnVlLAoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICksCgkJCQlpc1RhcGhvbGQgPSBmYWxzZTsKCgkJCSR0aGlzLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaXNUYXBob2xkID0gZmFsc2U7CgkJCQlpZiAoIGV2ZW50LndoaWNoICYmIGV2ZW50LndoaWNoICE9PSAxICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQl2YXIgb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQl0aW1lcjsKCgkJCQlmdW5jdGlvbiBjbGVhclRhcFRpbWVyKCkgewoJCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCX0KCgkJCQlmdW5jdGlvbiBjbGVhclRhcEhhbmRsZXJzKCkgewoJCQkJCWNsZWFyVGFwVGltZXIoKTsKCgkJCQkJJHRoaXMudW5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICkKCQkJCQkJLnVuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApOwoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgkJCQl9CgoJCQkJZnVuY3Rpb24gY2xpY2tIYW5kbGVyKCBldmVudCApIHsKCQkJCQljbGVhclRhcEhhbmRsZXJzKCk7CgoJCQkJCS8vIE9OTFkgdHJpZ2dlciBhICd0YXAnIGV2ZW50IGlmIHRoZSBzdGFydCB0YXJnZXQgaXMKCQkJCQkvLyB0aGUgc2FtZSBhcyB0aGUgc3RvcCB0YXJnZXQuCgkJCQkJaWYgKCAhaXNUYXBob2xkICYmIG9yaWdUYXJnZXQgPT09IGV2ZW50LnRhcmdldCApIHsKCQkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwIiwgZXZlbnQgKTsKCQkJCQl9IGVsc2UgaWYgKCBpc1RhcGhvbGQgKSB7CgkJCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCX0KCQkJCX0KCgkJCQkkdGhpcy5iaW5kKCAidm1vdXNldXAiLCBjbGVhclRhcFRpbWVyICkKCQkJCQkuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApOwoJCQkJJGRvY3VtZW50LmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgoJCQkJdGltZXIgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQlpZiAoICEkLmV2ZW50LnNwZWNpYWwudGFwLmVtaXRUYXBPblRhcGhvbGQgKSB7CgkJCQkJCWlzVGFwaG9sZCA9IHRydWU7CgkJCQkJfQoJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcGhvbGQiLCAkLkV2ZW50KCAidGFwaG9sZCIsIHsgdGFyZ2V0OiBvcmlnVGFyZ2V0IH0gKSApOwoJCQkJfSwgJC5ldmVudC5zcGVjaWFsLnRhcC50YXBob2xkVGhyZXNob2xkICk7CgkJCX0pOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkudW5iaW5kKCAidm1vdXNlZG93biIgKS51bmJpbmQoICJ2Y2xpY2siICkudW5iaW5kKCAidm1vdXNldXAiICk7CgkJCSRkb2N1bWVudC51bmJpbmQoICJ2bW91c2VjYW5jZWwiICk7CgkJfQoJfTsKCgkvLyBhbHNvIGhhbmRsZXMgc3dpcGVsZWZ0LCBzd2lwZXJpZ2h0CgkkLmV2ZW50LnNwZWNpYWwuc3dpcGUgPSB7CgkJc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZDogMzAsIC8vIE1vcmUgdGhhbiB0aGlzIGhvcml6b250YWwgZGlzcGxhY2VtZW50LCBhbmQgd2Ugd2lsbCBzdXBwcmVzcyBzY3JvbGxpbmcuCgoJCWR1cmF0aW9uVGhyZXNob2xkOiAxMDAwLCAvLyBNb3JlIHRpbWUgdGhhbiB0aGlzLCBhbmQgaXQgaXNuJ3QgYSBzd2lwZS4KCgkJaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkOiAzMCwgIC8vIFN3aXBlIGhvcml6b250YWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbW9yZSB0aGFuIHRoaXMuCgoJCXZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQ6IDc1LCAgLy8gU3dpcGUgdmVydGljYWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbGVzcyB0aGFuIHRoaXMuCgoJCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50OwoJCQlyZXR1cm4gewoJCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJCWNvb3JkczogWyBkYXRhLnBhZ2VYLCBkYXRhLnBhZ2VZIF0sCgkJCQkJCW9yaWdpbjogJCggZXZlbnQudGFyZ2V0ICkKCQkJCQl9OwoJCX0sCgoJCXN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGRhdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgPwoJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1sgMCBdIDogZXZlbnQ7CgkJCXJldHVybiB7CgkJCQkJCXRpbWU6ICggbmV3IERhdGUoKSApLmdldFRpbWUoKSwKCQkJCQkJY29vcmRzOiBbIGRhdGEucGFnZVgsIGRhdGEucGFnZVkgXQoJCQkJCX07CgkJfSwKCgkJaGFuZGxlU3dpcGU6IGZ1bmN0aW9uKCBzdGFydCwgc3RvcCwgdGhpc09iamVjdCwgb3JpZ1RhcmdldCApIHsKCQkJaWYgKCBzdG9wLnRpbWUgLSBzdGFydC50aW1lIDwgJC5ldmVudC5zcGVjaWFsLnN3aXBlLmR1cmF0aW9uVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAwIF0gLSBzdG9wLmNvb3Jkc1sgMCBdICkgPiAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAxIF0gLSBzdG9wLmNvb3Jkc1sgMSBdICkgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUudmVydGljYWxEaXN0YW5jZVRocmVzaG9sZCApIHsKCQkJCXZhciBkaXJlY3Rpb24gPSBzdGFydC5jb29yZHNbMF0gPiBzdG9wLmNvb3Jkc1sgMCBdID8gInN3aXBlbGVmdCIgOiAic3dpcGVyaWdodCI7CgoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAic3dpcGUiLCAkLkV2ZW50KCAic3dpcGUiLCB7IHRhcmdldDogb3JpZ1RhcmdldCwgc3dpcGVzdGFydDogc3RhcnQsIHN3aXBlc3RvcDogc3RvcCB9KSApOwoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCBkaXJlY3Rpb24sJC5FdmVudCggZGlyZWN0aW9uLCB7IHRhcmdldDogb3JpZ1RhcmdldCwgc3dpcGVzdGFydDogc3RhcnQsIHN3aXBlc3RvcDogc3RvcCB9ICkgKTsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJCXJldHVybiBmYWxzZTsKCgkJfSwKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKTsKCgkJCSR0aGlzLmJpbmQoIHRvdWNoU3RhcnRFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdmFyIHN0b3AsCgkJCQkJc3RhcnQgPSAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuc3RhcnQoIGV2ZW50ICksCgkJCQkJb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQllbWl0dGVkID0gZmFsc2U7CgoJCQkJZnVuY3Rpb24gbW92ZUhhbmRsZXIoIGV2ZW50ICkgewoJCQkJCWlmICggIXN0YXJ0ICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQlzdG9wID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnN0b3AoIGV2ZW50ICk7CgkJCQkJaWYgKCAhZW1pdHRlZCApIHsKCQkJCQkJZW1pdHRlZCA9ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5oYW5kbGVTd2lwZSggc3RhcnQsIHN0b3AsIHRoaXNPYmplY3QsIG9yaWdUYXJnZXQgKTsKCQkJCQl9CgkJCQkJLy8gcHJldmVudCBzY3JvbGxpbmcKCQkJCQlpZiAoIE1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5zY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkICkgewoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCX0KCQkJCX0KCgkJCQkkdGhpcy5iaW5kKCB0b3VjaE1vdmVFdmVudCwgbW92ZUhhbmRsZXIgKQoJCQkJCS5vbmUoIHRvdWNoU3RvcEV2ZW50LCBmdW5jdGlvbigpIHsKCQkJCQkJZW1pdHRlZCA9IHRydWU7CgkJCQkJCSR0aGlzLnVuYmluZCggdG91Y2hNb3ZlRXZlbnQsIG1vdmVIYW5kbGVyICk7CgkJCQl9KTsKCQkJfSk7CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkudW5iaW5kKCB0b3VjaFN0YXJ0RXZlbnQgKS51bmJpbmQoIHRvdWNoTW92ZUV2ZW50ICkudW5iaW5kKCB0b3VjaFN0b3BFdmVudCApOwoJCX0KCX07CgkkLmVhY2goewoJCXNjcm9sbHN0b3A6ICJzY3JvbGxzdGFydCIsCgkJdGFwaG9sZDogInRhcCIsCgkJc3dpcGVsZWZ0OiAic3dpcGUiLAoJCXN3aXBlcmlnaHQ6ICJzd2lwZSIKCX0sIGZ1bmN0aW9uKCBldmVudCwgc291cmNlRXZlbnQgKSB7CgoJCSQuZXZlbnQuc3BlY2lhbFsgZXZlbnQgXSA9IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmJpbmQoIHNvdXJjZUV2ZW50LCAkLm5vb3AgKTsKCQkJfSwKCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLnVuYmluZCggc291cmNlRXZlbnQgKTsKCQkJfQoJCX07Cgl9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCgoJLy8gdGhyb3R0bGVkIHJlc2l6ZSBldmVudAoJKGZ1bmN0aW9uKCAkICkgewoJCSQuZXZlbnQuc3BlY2lhbC50aHJvdHRsZWRyZXNpemUgPSB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCQl9LAoJCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkudW5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCQl9CgkJfTsKCgkJdmFyIHRocm90dGxlID0gMjUwLAoJCQloYW5kbGVyID0gZnVuY3Rpb24oKSB7CgkJCQljdXJyID0gKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpOwoJCQkJZGlmZiA9IGN1cnIgLSBsYXN0Q2FsbDsKCgkJCQlpZiAoIGRpZmYgPj0gdGhyb3R0bGUgKSB7CgoJCQkJCWxhc3RDYWxsID0gY3VycjsKCQkJCQkkKCB0aGlzICkudHJpZ2dlciggInRocm90dGxlZHJlc2l6ZSIgKTsKCgkJCQl9IGVsc2UgewoKCQkJCQlpZiAoIGhlbGRDYWxsICkgewoJCQkJCQljbGVhclRpbWVvdXQoIGhlbGRDYWxsICk7CgkJCQkJfQoKCQkJCQkvLyBQcm9taXNlIGEgaGVsZCBjYWxsIHdpbGwgc3RpbGwgZXhlY3V0ZQoJCQkJCWhlbGRDYWxsID0gc2V0VGltZW91dCggaGFuZGxlciwgdGhyb3R0bGUgLSBkaWZmICk7CgkJCQl9CgkJCX0sCgkJCWxhc3RDYWxsID0gMCwKCQkJaGVsZENhbGwsCgkJCWN1cnIsCgkJCWRpZmY7Cgl9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7Cgl2YXIgd2luID0gJCggd2luZG93ICksCgkJZXZlbnRfbmFtZSA9ICJvcmllbnRhdGlvbmNoYW5nZSIsCgkJZ2V0X29yaWVudGF0aW9uLAoJCWxhc3Rfb3JpZW50YXRpb24sCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUsCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0LAoJCXBvcnRyYWl0X21hcCA9IHsgIjAiOiB0cnVlLCAiMTgwIjogdHJ1ZSB9LAoJCXd3LCB3aCwgbGFuZHNjYXBlX3RocmVzaG9sZDsKCgkvLyBJdCBzZWVtcyB0aGF0IHNvbWUgZGV2aWNlL2Jyb3dzZXIgdmVuZG9ycyB1c2Ugd2luZG93Lm9yaWVudGF0aW9uIHZhbHVlcyAwIGFuZCAxODAgdG8KCS8vIGRlbm90ZSB0aGUgImRlZmF1bHQiIG9yaWVudGF0aW9uLiBGb3IgaU9TIGRldmljZXMsIGFuZCBtb3N0IG90aGVyIHNtYXJ0LXBob25lcyB0ZXN0ZWQsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyBhbHdheXMgInBvcnRyYWl0IiwgYnV0IGluIHNvbWUgQW5kcm9pZCBhbmQgUklNIGJhc2VkIHRhYmxldHMsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyAibGFuZHNjYXBlIi4gVGhlIGZvbGxvd2luZyBjb2RlIGF0dGVtcHRzIHRvIHVzZSB0aGUgd2luZG93CgkvLyBkaW1lbnNpb25zIHRvIGZpZ3VyZSBvdXQgd2hhdCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiBpcywgYW5kIHRoZW4gbWFrZXMgYWRqdXN0bWVudHMKCS8vIHRvIHRoZSB0byB0aGUgcG9ydHJhaXRfbWFwIGlmIG5lY2Vzc2FyeSwgc28gdGhhdCB3ZSBjYW4gcHJvcGVybHkgZGVjb2RlIHRoZQoJLy8gd2luZG93Lm9yaWVudGF0aW9uIHZhbHVlIHdoZW5ldmVyIGdldF9vcmllbnRhdGlvbigpIGlzIGNhbGxlZC4KCS8vCgkvLyBOb3RlIHRoYXQgd2UgdXNlZCB0byB1c2UgYSBtZWRpYSBxdWVyeSB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIG9yaWVudGF0aW9uIHRoZSBicm93c2VyCgkvLyB0aGlua3MgaXQgaXMgaW46CgkvLwoJLy8gICAgIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlID0gJC5tb2JpbGUubWVkaWEoImFsbCBhbmQgKG9yaWVudGF0aW9uOiBsYW5kc2NhcGUpIik7CgkvLwoJLy8gYnV0IHRoZXJlIHdhcyBhbiBpUGhvbmUvaVBvZCBUb3VjaCBidWcgYmVnaW5uaW5nIHdpdGggaU9TIDQuMiwgdXAgdGhyb3VnaCBpT1MgNS4xLAoJLy8gd2hlcmUgdGhlIGJyb3dzZXIgKkFMV0FZUyogYXBwbGllZCB0aGUgbGFuZHNjYXBlIG1lZGlhIHF1ZXJ5LiBUaGlzIGJ1ZyBkb2VzIG5vdAoJLy8gaGFwcGVuIG9uIGlQYWQuCgoJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgoJCS8vIENoZWNrIHRoZSB3aW5kb3cgd2lkdGggYW5kIGhlaWdodCB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24KCQkvLyBvZiB0aGUgZGV2aWNlIGlzIGF0IHRoaXMgbW9tZW50LiBOb3RlIHRoYXQgd2UndmUgaW5pdGlhbGl6ZWQgdGhlIHBvcnRyYWl0IG1hcAoJCS8vIHZhbHVlcyB0byAwIGFuZCAxODAsICpBTkQqIHdlIHB1cnBvc2VseSBjaGVjayBmb3IgbGFuZHNjYXBlIHNvIHRoYXQgaWYgd2UgZ3Vlc3MKCQkvLyB3cm9uZywgLCB3ZSBkZWZhdWx0IHRvIHRoZSBhc3N1bXB0aW9uIHRoYXQgcG9ydHJhaXQgaXMgdGhlIGRlZmF1bHQgb3JpZW50YXRpb24uCgkJLy8gV2UgdXNlIGEgdGhyZXNob2xkIGNoZWNrIGJlbG93IGJlY2F1c2Ugb24gc29tZSBwbGF0Zm9ybXMgbGlrZSBpT1MsIHRoZSBpUGhvbmUKCQkvLyBmb3JtLWZhY3RvciBjYW4gcmVwb3J0IGEgbGFyZ2VyIHdpZHRoIHRoYW4gaGVpZ2h0IGlmIHRoZSB1c2VyIHR1cm5zIG9uIHRoZQoJCS8vIGRldmVsb3BlciBjb25zb2xlLiBUaGUgYWN0dWFsIHRocmVzaG9sZCB2YWx1ZSBpcyBzb21ld2hhdCBhcmJpdHJhcnksIHdlIGp1c3QKCQkvLyBuZWVkIHRvIG1ha2Ugc3VyZSBpdCBpcyBsYXJnZSBlbm91Z2ggdG8gZXhjbHVkZSB0aGUgZGV2ZWxvcGVyIGNvbnNvbGUgY2FzZS4KCgkJd3cgPSB3aW5kb3cuaW5uZXJXaWR0aCB8fCB3aW4ud2lkdGgoKTsKCQl3aCA9IHdpbmRvdy5pbm5lckhlaWdodCB8fCB3aW4uaGVpZ2h0KCk7CgkJbGFuZHNjYXBlX3RocmVzaG9sZCA9IDUwOwoKCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSA9IHd3ID4gd2ggJiYgKCB3dyAtIHdoICkgPiBsYW5kc2NhcGVfdGhyZXNob2xkOwoKCQkvLyBOb3cgY2hlY2sgdG8gc2VlIGlmIHRoZSBjdXJyZW50IHdpbmRvdy5vcmllbnRhdGlvbiBpcyAwIG9yIDE4MC4KCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgPSBwb3J0cmFpdF9tYXBbIHdpbmRvdy5vcmllbnRhdGlvbiBdOwoKCQkvLyBJZiB0aGUgaW5pdGlhbCBvcmllbnRhdGlvbiBpcyBsYW5kc2NhcGUsIGJ1dCB3aW5kb3cub3JpZW50YXRpb24gcmVwb3J0cyAwIG9yIDE4MCwgKk9SKgoJCS8vIGlmIHRoZSBpbml0aWFsIG9yaWVudGF0aW9uIGlzIHBvcnRyYWl0LCBidXQgd2luZG93Lm9yaWVudGF0aW9uIHJlcG9ydHMgOTAgb3IgLTkwLCB3ZQoJCS8vIG5lZWQgdG8gZmxpcCBvdXIgcG9ydHJhaXRfbWFwIHZhbHVlcyBiZWNhdXNlIGxhbmRzY2FwZSBpcyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBmb3IKCQkvLyB0aGlzIGRldmljZS9icm93c2VyLgoJCWlmICggKCBpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSAmJiBpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgKSB8fCAoICFpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSAmJiAhaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ICkgKSB7CgkJCXBvcnRyYWl0X21hcCA9IHsgIi05MCI6IHRydWUsICI5MCI6IHRydWUgfTsKCQl9Cgl9CgoJJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlID0gJC5leHRlbmQoIHt9LCAkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UsIHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCS8vIElmIHRoZSBldmVudCBpcyBzdXBwb3J0ZWQgbmF0aXZlbHksIHJldHVybiBmYWxzZSBzbyB0aGF0IGpRdWVyeQoJCQkvLyB3aWxsIGJpbmQgdG8gdGhlIGV2ZW50IHVzaW5nIERPTSBtZXRob2RzLgoJCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiAmJiAhJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLmRpc2FibGVkICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQkvLyBHZXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24gdG8gYXZvaWQgaW5pdGlhbCBkb3VibGUtdHJpZ2dlcmluZy4KCQkJbGFzdF9vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgc2ltdWxhdGUgdGhlCgkJCS8vIGV2ZW50IGJ5IHRlc3Rpbmcgd2luZG93IGRpbWVuc2lvbnMgb24gcmVzaXplLgoJCQl3aW4uYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHJldHVybiBmYWxzZSBzbyB0aGF0CgkJCS8vIGpRdWVyeSB3aWxsIHVuYmluZCB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICEkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UuZGlzYWJsZWQgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCS8vIEJlY2F1c2UgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50IGRvZXNuJ3QgZXhpc3QsIHVuYmluZCB0aGUKCQkJLy8gcmVzaXplIGV2ZW50IGhhbmRsZXIuCgkJCXdpbi51bmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCBoYW5kbGVyICk7CgkJfSwKCQlhZGQ6IGZ1bmN0aW9uKCBoYW5kbGVPYmogKSB7CgkJCS8vIFNhdmUgYSByZWZlcmVuY2UgdG8gdGhlIGJvdW5kIGV2ZW50IGhhbmRsZXIuCgkJCXZhciBvbGRfaGFuZGxlciA9IGhhbmRsZU9iai5oYW5kbGVyOwoKCQkJaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBNb2RpZnkgZXZlbnQgb2JqZWN0LCBhZGRpbmcgdGhlIC5vcmllbnRhdGlvbiBwcm9wZXJ0eS4KCQkJCWV2ZW50Lm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkJLy8gQ2FsbCB0aGUgb3JpZ2luYWxseS1ib3VuZCBldmVudCBoYW5kbGVyIGFuZCByZXR1cm4gaXRzIHJlc3VsdC4KCQkJCXJldHVybiBvbGRfaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoJfSk7CgoJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoaXMgaGFuZGxlciB3aWxsIGJlIGJvdW5kIHRvCgkvLyB0aGUgd2luZG93IHJlc2l6ZSBldmVudCB0byBzaW11bGF0ZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQuCglmdW5jdGlvbiBoYW5kbGVyKCkgewoJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbi4KCQl2YXIgb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJaWYgKCBvcmllbnRhdGlvbiAhPT0gbGFzdF9vcmllbnRhdGlvbiApIHsKCQkJLy8gVGhlIG9yaWVudGF0aW9uIGhhcyBjaGFuZ2VkLCBzbyB0cmlnZ2VyIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCQkJbGFzdF9vcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uOwoJCQl3aW4udHJpZ2dlciggZXZlbnRfbmFtZSApOwoJCX0KCX0KCgkvLyBHZXQgdGhlIGN1cnJlbnQgcGFnZSBvcmllbnRhdGlvbi4gVGhpcyBtZXRob2QgaXMgZXhwb3NlZCBwdWJsaWNseSwgc2hvdWxkIGl0CgkvLyBiZSBuZWVkZWQsIGFzIGpRdWVyeS5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uKCkKCSQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXZhciBpc1BvcnRyYWl0ID0gdHJ1ZSwgZWxlbSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCgkJLy8gcHJlZmVyIHdpbmRvdyBvcmllbnRhdGlvbiB0byB0aGUgY2FsY3VsYXRpb24gYmFzZWQgb24gc2NyZWVuc2l6ZSBhcwoJCS8vIHRoZSBhY3R1YWwgc2NyZWVuIHJlc2l6ZSB0YWtlcyBwbGFjZSBiZWZvcmUgb3IgYWZ0ZXIgdGhlIG9yaWVudGF0aW9uIGNoYW5nZSBldmVudAoJCS8vIGhhcyBiZWVuIGZpcmVkIGRlcGVuZGluZyBvbiBpbXBsZW1lbnRhdGlvbiAoZWcgYW5kcm9pZCAyLjMgaXMgYmVmb3JlLCBpcGhvbmUgYWZ0ZXIpLgoJCS8vIE1vcmUgdGVzdGluZyBpcyByZXF1aXJlZCB0byBkZXRlcm1pbmUgaWYgYSBtb3JlIHJlbGlhYmxlIG1ldGhvZCBvZiBkZXRlcm1pbmluZyB0aGUgbmV3IHNjcmVlbnNpemUKCQkvLyBpcyBwb3NzaWJsZSB3aGVuIG9yaWVudGF0aW9uY2hhbmdlIGlzIGZpcmVkLiAoZWcsIHVzZSBtZWRpYSBxdWVyaWVzICsgZWxlbWVudCArIG9wYWNpdHkpCgkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgkJCS8vIGlmIHRoZSB3aW5kb3cgb3JpZW50YXRpb24gcmVnaXN0ZXJzIGFzIDAgb3IgMTgwIGRlZ3JlZXMgcmVwb3J0CgkJCS8vIHBvcnRyYWl0LCBvdGhlcndpc2UgbGFuZHNjYXBlCgkJCWlzUG9ydHJhaXQgPSBwb3J0cmFpdF9tYXBbIHdpbmRvdy5vcmllbnRhdGlvbiBdOwoJCX0gZWxzZSB7CgkJCWlzUG9ydHJhaXQgPSBlbGVtICYmIGVsZW0uY2xpZW50V2lkdGggLyBlbGVtLmNsaWVudEhlaWdodCA8IDEuMTsKCQl9CgoJCXJldHVybiBpc1BvcnRyYWl0ID8gInBvcnRyYWl0IiA6ICJsYW5kc2NhcGUiOwoJfTsKCgkkLmZuWyBldmVudF9uYW1lIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBldmVudF9uYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBldmVudF9uYW1lICk7Cgl9OwoKCS8vIGpRdWVyeSA8IDEuOAoJaWYgKCAkLmF0dHJGbiApIHsKCQkkLmF0dHJGblsgZXZlbnRfbmFtZSBdID0gdHJ1ZTsKCX0KCn0oIGpRdWVyeSwgdGhpcyApKTsKCgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCS8vIGV4aXN0aW5nIGJhc2UgdGFnPwoJdmFyIGJhc2VFbGVtZW50ID0gJCggImhlYWQiICkuY2hpbGRyZW4oICJiYXNlIiApLAoKCS8vIGJhc2UgZWxlbWVudCBtYW5hZ2VtZW50LCBkZWZpbmVkIGRlcGVuZGluZyBvbiBkeW5hbWljIGJhc2UgdGFnIHN1cHBvcnQKCS8vIFRPRE8gbW92ZSB0byBleHRlcm5hbCB3aWRnZXQKCWJhc2UgPSB7CgoJCS8vIGRlZmluZSBiYXNlIGVsZW1lbnQsIGZvciB1c2UgaW4gcm91dGluZyBhc3NldCB1cmxzIHRoYXQgYXJlIHJlZmVyZW5jZWQKCQkvLyBpbiBBamF4LXJlcXVlc3RlZCBtYXJrdXAKCQllbGVtZW50OiAoIGJhc2VFbGVtZW50Lmxlbmd0aCA/IGJhc2VFbGVtZW50IDoKCQkJJCggIjxiYXNlPiIsIHsgaHJlZjogJC5tb2JpbGUucGF0aC5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCB9ICkucHJlcGVuZFRvKCAkKCAiaGVhZCIgKSApICksCgoJCWxpbmtTZWxlY3RvcjogIltzcmNdLCBsaW5rW2hyZWZdLCBhW3JlbD0nZXh0ZXJuYWwnXSwgOmpxbURhdGEoYWpheD0nZmFsc2UnKSwgYVt0YXJnZXRdIiwKCgkJLy8gc2V0IHRoZSBnZW5lcmF0ZWQgQkFTRSBlbGVtZW50J3MgaHJlZiB0byBhIG5ldyBwYWdlJ3MgYmFzZSBwYXRoCgkJc2V0OiBmdW5jdGlvbiggaHJlZiApIHsKCgkJCS8vIHdlIHNob3VsZCBkbyBub3RoaW5nIGlmIHRoZSB1c2VyIHdhbnRzIHRvIG1hbmFnZSB0aGVpciB1cmwgYmFzZQoJCQkvLyBtYW51YWxseQoJCQlpZiAoICEkLm1vYmlsZS5keW5hbWljQmFzZUVuYWJsZWQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIHdlIHNob3VsZCB1c2UgdGhlIGJhc2UgdGFnIGlmIHdlIGNhbiBtYW5pcHVsYXRlIGl0IGR5bmFtaWNhbGx5CgkJCWlmICggJC5zdXBwb3J0LmR5bmFtaWNCYXNlVGFnICkgewoJCQkJYmFzZS5lbGVtZW50LmF0dHIoICJocmVmIiwKCQkJCQkkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgJC5tb2JpbGUucGF0aC5kb2N1bWVudEJhc2UgKSApOwoJCQl9CgkJfSwKCgkJcmV3cml0ZTogZnVuY3Rpb24oIGhyZWYsIHBhZ2UgKSB7CgkJCXZhciBuZXdQYXRoID0gJC5tb2JpbGUucGF0aC5nZXQoIGhyZWYgKTsKCgkJCXBhZ2UuZmluZCggYmFzZS5saW5rU2VsZWN0b3IgKS5lYWNoKGZ1bmN0aW9uKCBpLCBsaW5rICkgewoJCQkJdmFyIHRoaXNBdHRyID0gJCggbGluayApLmlzKCAiW2hyZWZdIiApID8gImhyZWYiIDoKCQkJCQkkKCBsaW5rICkuaXMoICJbc3JjXSIgKSA/ICJzcmMiIDogImFjdGlvbiIsCgkJCQl0aGlzVXJsID0gJCggbGluayApLmF0dHIoIHRoaXNBdHRyICk7CgoJCQkJLy8gWFhYX2pibGFzOiBXZSBuZWVkIHRvIGZpeCB0aGlzIHNvIHRoYXQgaXQgcmVtb3ZlcyB0aGUgZG9jdW1lbnQKCQkJCS8vICAgICAgICAgICAgYmFzZSBVUkwsIGFuZCB0aGVuIHByZXBlbmRzIHdpdGggdGhlIG5ldyBwYWdlIFVSTC4KCQkJCS8vIGlmIGZ1bGwgcGF0aCBleGlzdHMgYW5kIGlzIHNhbWUsIGNob3AgaXQgLSBoZWxwcyBJRSBvdXQKCQkJCXRoaXNVcmwgPSB0aGlzVXJsLnJlcGxhY2UoIGxvY2F0aW9uLnByb3RvY29sICsgIi8vIiArCgkJCQkJbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lLCAiIiApOwoKCQkJCWlmICggIS9eKFx3Kzp8I3xcLykvLnRlc3QoIHRoaXNVcmwgKSApIHsKCQkJCQkkKCBsaW5rICkuYXR0ciggdGhpc0F0dHIsIG5ld1BhdGggKyB0aGlzVXJsICk7CgkJCQl9CgkJCX0pOwoJCX0sCgoJCS8vIHNldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCXJlc2V0OiBmdW5jdGlvbigvKiBocmVmICovKSB7CgkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb1NlYXJjaCApOwoJCX0KCX07CgoJJC5tb2JpbGUuYmFzZSA9IGJhc2U7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CiQubW9iaWxlLndpZGdldHMgPSB7fTsKCnZhciBvcmlnaW5hbFdpZGdldCA9ICQud2lkZ2V0LAoKCS8vIFJlY29yZCB0aGUgb3JpZ2luYWwsIG5vbi1tb2JpbGVpbml0LW1vZGlmaWVkIHZlcnNpb24gb2YgJC5tb2JpbGUua2VlcE5hdGl2ZQoJLy8gc28gd2UgY2FuIGxhdGVyIGRldGVybWluZSB3aGV0aGVyIHNvbWVvbmUgaGFzIG1vZGlmaWVkICQubW9iaWxlLmtlZXBOYXRpdmUKCWtlZXBOYXRpdmVGYWN0b3J5RGVmYXVsdCA9ICQubW9iaWxlLmtlZXBOYXRpdmU7CgokLndpZGdldCA9IChmdW5jdGlvbiggb3JpZyApIHsKCXJldHVybiBmdW5jdGlvbigpIHsKCQl2YXIgY29uc3RydWN0b3IgPSBvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSwKCQkJbmFtZSA9IGNvbnN0cnVjdG9yLnByb3RvdHlwZS53aWRnZXROYW1lOwoKCQljb25zdHJ1Y3Rvci5pbml0U2VsZWN0b3IgPSAoICggY29uc3RydWN0b3IucHJvdG90eXBlLmluaXRTZWxlY3RvciAhPT0gdW5kZWZpbmVkICkgPwoJCQljb25zdHJ1Y3Rvci5wcm90b3R5cGUuaW5pdFNlbGVjdG9yIDogIjpqcW1EYXRhKHJvbGU9JyIgKyBuYW1lICsgIicpIiApOwoKCQkkLm1vYmlsZS53aWRnZXRzWyBuYW1lIF0gPSBjb25zdHJ1Y3RvcjsKCgkJcmV0dXJuIGNvbnN0cnVjdG9yOwoJfTsKfSkoICQud2lkZ2V0ICk7CgovLyBNYWtlIHN1cmUgJC53aWRnZXQgc3RpbGwgaGFzIGJyaWRnZSBhbmQgZXh0ZW5kIG1ldGhvZHMKJC5leHRlbmQoICQud2lkZ2V0LCBvcmlnaW5hbFdpZGdldCApOwoKLy8gRm9yIGJhY2tjb21wYXQgcmVtb3ZlIGluIDEuNQokLm1vYmlsZS5kb2N1bWVudC5vbiggImNyZWF0ZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCSQoIGV2ZW50LnRhcmdldCApLmVuaGFuY2VXaXRoaW4oKTsKfSk7CgokLndpZGdldCggIm1vYmlsZS5wYWdlIiwgewoJb3B0aW9uczogewoJCXRoZW1lOiAiYSIsCgkJZG9tQ2FjaGU6IGZhbHNlLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJa2VlcE5hdGl2ZURlZmF1bHQ6ICQubW9iaWxlLmtlZXBOYXRpdmUsCgoJCS8vIERlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQljb250ZW50VGhlbWU6IG51bGwsCgkJZW5oYW5jZWQ6IGZhbHNlCgl9LAoKCS8vIERFUFJFQ0FURUQgZm9yID4gMS40CgkvLyBUT0RPIHJlbW92ZSBhdCAxLjUKCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCkgewoJCSQuV2lkZ2V0LnByb3RvdHlwZS5fY3JlYXRlV2lkZ2V0LmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl0aGlzLl90cmlnZ2VyKCAiaW5pdCIgKTsKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJLy8gSWYgZmFsc2UgaXMgcmV0dXJuZWQgYnkgdGhlIGNhbGxiYWNrcyBkbyBub3QgY3JlYXRlIHRoZSBwYWdlCgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3JlY3JlYXRlIiApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9lbmhhbmNlKCk7CgkJfQoKCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LCB7CgkJCXBhZ2ViZWZvcmVoaWRlOiAicmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCIsCgkJCXBhZ2ViZWZvcmVzaG93OiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IgoJCX0pOwoKCQl0aGlzLmVsZW1lbnQuZW5oYW5jZVdpdGhpbigpOwoJCS8vIERpYWxvZyB3aWRnZXQgaXMgZGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIHRoaXMgaW4gMS41CgkJaWYgKCAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMuZWxlbWVudFswXSwgInJvbGUiICkgPT09ICJkaWFsb2ciICYmICQubW9iaWxlLmRpYWxvZyApIHsKCQkJdGhpcy5lbGVtZW50LmRpYWxvZygpOwoJCX0KCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uICgpIHsKCQl2YXIgYXR0clByZWZpeCA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQkJc2VsZiA9IHRoaXM7CgoJCWlmICggdGhpcy5vcHRpb25zLnJvbGUgKSB7CgkJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZSIsIHRoaXMub3B0aW9ucy5yb2xlICk7CgkJfQoKCQl0aGlzLmVsZW1lbnQKCQkJLmF0dHIoICJ0YWJpbmRleCIsICIwIiApCgkJCS5hZGRDbGFzcyggInVpLXBhZ2UgdWktcGFnZS10aGVtZS0iICsgdGhpcy5vcHRpb25zLnRoZW1lICk7CgoJCS8vIE1hbmlwdWxhdGlvbiBvZiBjb250ZW50IG9zIERlcHJlY2F0ZWQgYXMgb2YgMS40IHJlbW92ZSBpbiAxLjUKCQl0aGlzLmVsZW1lbnQuZmluZCggIlsiICsgYXR0clByZWZpeCArICJyb2xlPSdjb250ZW50J10iICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCXRoZW1lID0gdGhpcy5nZXRBdHRyaWJ1dGUoIGF0dHJQcmVmaXggKyAidGhlbWUiICkgfHwgdW5kZWZpbmVkOwoJCQkJc2VsZi5vcHRpb25zLmNvbnRlbnRUaGVtZSA9IHRoZW1lIHx8IHNlbGYub3B0aW9ucy5jb250ZW50VGhlbWUgfHwgKCBzZWxmLm9wdGlvbnMuZGlhbG9nICYmIHNlbGYub3B0aW9ucy50aGVtZSApIHx8ICggc2VsZi5lbGVtZW50LmpxbURhdGEoInJvbGUiKSA9PT0gImRpYWxvZyIgJiYgIHNlbGYub3B0aW9ucy50aGVtZSApOwoJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1jb250ZW50IiApOwoJCQkJaWYgKCBzZWxmLm9wdGlvbnMuY29udGVudFRoZW1lICkgewoJCQkJCSR0aGlzLmFkZENsYXNzKCAidWktYm9keS0iICsgKCBzZWxmLm9wdGlvbnMuY29udGVudFRoZW1lICkgKTsKCQkJCX0KCQkJCS8vIEFkZCBBUklBIHJvbGUKCQkJCSR0aGlzLmF0dHIoICJyb2xlIiwgIm1haW4iICkuYWRkQ2xhc3MoICJ1aS1jb250ZW50IiApOwoJCX0pOwoJfSwKCgliaW5kUmVtb3ZlOiBmdW5jdGlvbiggY2FsbGJhY2sgKSB7CgkJdmFyIHBhZ2UgPSB0aGlzLmVsZW1lbnQ7CgoJCS8vIHdoZW4gZG9tIGNhY2hpbmcgaXMgbm90IGVuYWJsZWQgb3IgdGhlIHBhZ2UgaXMgZW1iZWRkZWQgYmluZCB0byByZW1vdmUgdGhlIHBhZ2Ugb24gaGlkZQoJCWlmICggIXBhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLm9wdGlvbnMuZG9tQ2FjaGUgJiYKCQkJcGFnZS5pcyggIjpqcW1EYXRhKGV4dGVybmFsLXBhZ2U9J3RydWUnKSIgKSApIHsKCgkJCS8vIFRPRE8gdXNlIF9vbiAtIHRoYXQgaXMsIHNvcnQgb3V0IHdoeSBpdCBkb2Vzbid0IHdvcmsgaW4gdGhpcyBjYXNlCgkJCXBhZ2UuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIsIGNhbGxiYWNrIHx8IGZ1bmN0aW9uKCBlLCBkYXRhICkgewoKCQkJCS8vY2hlY2sgaWYgdGhpcyBpcyBhIHNhbWUgcGFnZSB0cmFuc2l0aW9uIGFuZCBpZiBzbyBkb24ndCByZW1vdmUgdGhlIHBhZ2UKCQkJCWlmKCAhZGF0YS5zYW1lUGFnZSApewoJCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCQkJcHJFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZXJlbW92ZSIgKTsKCgkJCQkJJHRoaXMudHJpZ2dlciggcHJFdmVudCApOwoKCQkJCQlpZiAoICFwckV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCQkkdGhpcy5yZW1vdmVXaXRoRGVwZW5kZW50cygpOwoJCQkJCX0KCQkJCX0KCQkJfSk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG8gKSB7CgkJaWYgKCBvLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHRoaXMub3B0aW9ucy50aGVtZSApLmFkZENsYXNzKCAidWktYm9keS0iICsgby50aGVtZSApOwoJCX0KCgkJaWYgKCBvLmNvbnRlbnRUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLmVsZW1lbnQuZmluZCggIltkYXRhLSIgKyAkLm1vYmlsZS5ucyArICI9J2NvbnRlbnQnXSIgKS5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHRoaXMub3B0aW9ucy5jb250ZW50VGhlbWUgKQoJCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgby5jb250ZW50VGhlbWUgKTsKCQl9Cgl9LAoKCV9oYW5kbGVQYWdlQmVmb3JlU2hvdzogZnVuY3Rpb24oLyogZSAqLykgewoJCXRoaXMuc2V0Q29udGFpbmVyQmFja2dyb3VuZCgpOwoJfSwKCS8vIERlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCXJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiOm1vYmlsZS1wYWdlY29udGFpbmVyIiApLnBhZ2Vjb250YWluZXIoeyAidGhlbWUiOiAibm9uZSIgfSk7Cgl9LAoJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJLy8gc2V0IHRoZSBwYWdlIGNvbnRhaW5lciBiYWNrZ3JvdW5kIHRvIHRoZSBwYWdlIHRoZW1lCglzZXRDb250YWluZXJCYWNrZ3JvdW5kOiBmdW5jdGlvbiggdGhlbWUgKSB7CgkJdGhpcy5lbGVtZW50LnBhcmVudCgpLnBhZ2Vjb250YWluZXIoIHsgInRoZW1lIjogdGhlbWUgfHwgdGhpcy5vcHRpb25zLnRoZW1lIH0gKTsKCX0sCgkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CglrZWVwTmF0aXZlU2VsZWN0b3I6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlrZWVwTmF0aXZlID0gJC50cmltKCBvcHRpb25zLmtlZXBOYXRpdmUgfHwgIiIgKSwKCQkJZ2xvYmFsVmFsdWUgPSAkLnRyaW0oICQubW9iaWxlLmtlZXBOYXRpdmUgKSwKCQkJb3B0aW9uVmFsdWUgPSAkLnRyaW0oIG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHQgKSwKCgkJCS8vIENoZWNrIGlmICQubW9iaWxlLmtlZXBOYXRpdmUgaGFzIGNoYW5nZWQgZnJvbSB0aGUgZmFjdG9yeSBkZWZhdWx0CgkJCW5ld0RlZmF1bHQgPSAoIGtlZXBOYXRpdmVGYWN0b3J5RGVmYXVsdCA9PT0gZ2xvYmFsVmFsdWUgPwoJCQkJIiIgOiBnbG9iYWxWYWx1ZSApLAoKCQkJLy8gSWYgJC5tb2JpbGUua2VlcE5hdGl2ZSBoYXMgbm90IGNoYW5nZWQsIHVzZSBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0CgkJCW9sZERlZmF1bHQgPSAoIG5ld0RlZmF1bHQgPT09ICIiID8gb3B0aW9uVmFsdWUgOiAiIiApOwoKCQkvLyBDb25jYXRlbmF0ZSBrZWVwTmF0aXZlIHNlbGVjdG9ycyBmcm9tIGFsbCBzb3VyY2VzIHdoZXJlIHRoZSB2YWx1ZSBoYXMKCQkvLyBjaGFuZ2VkIG9yLCBpZiBub3RoaW5nIGhhcyBjaGFuZ2VkLCByZXR1cm4gdGhlIGRlZmF1bHQKCQlyZXR1cm4gKCAoIGtlZXBOYXRpdmUgPyBbIGtlZXBOYXRpdmUgXSA6IFtdICkKCQkJLmNvbmNhdCggbmV3RGVmYXVsdCA/IFsgbmV3RGVmYXVsdCBdIDogW10gKQoJCQkuY29uY2F0KCBvbGREZWZhdWx0ID8gWyBvbGREZWZhdWx0IF0gOiBbXSApCgkJCS5qb2luKCAiLCAiICkgKTsKCX0KfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCSQud2lkZ2V0KCAibW9iaWxlLnBhZ2Vjb250YWluZXIiLCB7CgkJb3B0aW9uczogewoJCQl0aGVtZTogImEiCgkJfSwKCgkJaW5pdFNlbGVjdG9yOiBmYWxzZSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoKCQkJLy8gVE9ETyBjb25zaWRlciBtb3ZpbmcgdGhlIG5hdmlnYXRpb24gaGFuZGxlciBPVVQgb2Ygd2lkZ2V0IGludG8KCQkJLy8gICAgICBzb21lIG90aGVyIG9iamVjdCBhcyBnbHVlIGJldHdlZW4gdGhlIG5hdmlnYXRlIGV2ZW50IGFuZCB0aGUKCQkJLy8gICAgICBjb250ZW50IHdpZGdldCBsb2FkIGFuZCBjaGFuZ2UgbWV0aG9kcwoJCQl0aGlzLl9vbiggdGhpcy53aW5kb3csIHsgbmF2aWdhdGU6ICJfZmlsdGVyTmF2aWdhdGVFdmVudHMiIH0pOwoKCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7CgkJCQkvLyBkaXNhYmxlIGFuIHNjcm9sbCBzZXR0aW5nIHdoZW4gYSBoYXNoY2hhbmdlIGhhcyBiZWVuIGZpcmVkLAoJCQkJLy8gdGhpcyBvbmx5IHdvcmtzIGJlY2F1c2UgdGhlIHJlY29yZGluZyBvZiB0aGUgc2Nyb2xsIHBvc2l0aW9uCgkJCQkvLyBpcyBkZWxheWVkIGZvciAxMDBtcyBhZnRlciB0aGUgYnJvd3NlciBtaWdodCBoYXZlIGNoYW5nZWQgdGhlCgkJCQkvLyBwb3NpdGlvbiBiZWNhdXNlIG9mIHRoZSBoYXNoY2hhbmdlCgkJCQluYXZpZ2F0ZTogIl9kaXNhYmxlUmVjb3JkU2Nyb2xsIiwKCgkJCQkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgZm9yIHRoZSBmaXJzdCBwYWdlLCAicGFnZWNoYW5nZSIgd29uJ3QgYmUKCQkJCS8vIGZpcmVkIGluIHRoYXQgY2FzZQoJCQkJc2Nyb2xsc3RvcDogIl9kZWxheWVkUmVjb3JkU2Nyb2xsIgoJCQl9KTsKCgkJCS8vIFRPRE8gbW92ZSBmcm9tIHBhZ2UqIGV2ZW50cyB0byBjb250ZW50KiBldmVudHMKCQkJdGhpcy5fb24oeyBwYWdlY2hhbmdlOiAiX2FmdGVyQ29udGVudENoYW5nZSIgfSk7CgoJCQkvLyBoYW5kbGUgaW5pdGlhbCBoYXNoY2hhbmdlIGZyb20gY2hyb21lIDooCgkJCXRoaXMud2luZG93Lm9uZSggIm5hdmlnYXRlIiwgJC5wcm94eShmdW5jdGlvbigpIHsKCQkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoJCQl9LCB0aGlzKSk7CgkJfSwKCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCAmJiBvcHRpb25zLnRoZW1lICE9PSAibm9uZSIgKSB7CgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyB0aGlzLm9wdGlvbnMudGhlbWUgKQoJCQkJCS5hZGRDbGFzcyggInVpLW92ZXJsYXktIiArIG9wdGlvbnMudGhlbWUgKTsKCQkJfSBlbHNlIGlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktb3ZlcmxheS0iICsgdGhpcy5vcHRpb25zLnRoZW1lICk7CgkJCX0KCgkJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgkJfSwKCgkJX2Rpc2FibGVSZWNvcmRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnNldExhc3RTY3JvbGxFbmFibGVkID0gZmFsc2U7CgkJfSwKCgkJX2VuYWJsZVJlY29yZFNjcm9sbDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoJCX0sCgoJCS8vIFRPRE8gY29uc2lkZXIgdGhlIG5hbWUgaGVyZSwgc2luY2UgaXQncyBwdXJwb3NlIHNwZWNpZmljCgkJX2FmdGVyQ29udGVudENoYW5nZTogZnVuY3Rpb24oKSB7CgkJCS8vIG9uY2UgdGhlIHBhZ2UgaGFzIGNoYW5nZWQsIHJlLWVuYWJsZSB0aGUgc2Nyb2xsIHJlY29yZGluZwoJCQl0aGlzLnNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCgkJCS8vIHJlbW92ZSBhbnkgYmluZGluZyB0aGF0IHByZXZpb3VzbHkgZXhpc3RlZCBvbiB0aGUgZ2V0IHNjcm9sbAoJCQkvLyB3aGljaCBtYXkgb3IgbWF5IG5vdCBiZSBkaWZmZXJlbnQgdGhhbiB0aGUgc2Nyb2xsIGVsZW1lbnQKCQkJLy8gZGV0ZXJtaW5lZCBmb3IgdGhpcyBwYWdlIHByZXZpb3VzbHkKCQkJdGhpcy5fb2ZmKCB0aGlzLndpbmRvdywgInNjcm9sbHN0b3AiICk7CgoJCQkvLyBkZXRlcm1pbmUgYW5kIGJpbmQgdG8gdGhlIGN1cnJlbnQgc2NvbGwgZWxlbWVudCB3aGljaCBtYXkgYmUgdGhlCgkJCS8vIHdpbmRvdyBvciBpbiB0aGUgY2FzZSBvZiB0b3VjaCBvdmVyZmxvdyB0aGUgZWxlbWVudCB0b3VjaCBvdmVyZmxvdwoJCQl0aGlzLl9vbiggdGhpcy53aW5kb3csIHsgc2Nyb2xsc3RvcDogIl9kZWxheWVkUmVjb3JkU2Nyb2xsIiB9KTsKCQl9LAoKCQlfcmVjb3JkU2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJLy8gdGhpcyBiYXJyaWVyIHByZXZlbnRzIHNldHRpbmcgdGhlIHNjcm9sbCB2YWx1ZSBiYXNlZCBvbgoJCQkvLyB0aGUgYnJvd3NlciBzY3JvbGxpbmcgdGhlIHdpbmRvdyBiYXNlZCBvbiBhIGhhc2hjaGFuZ2UKCQkJaWYgKCAhdGhpcy5zZXRMYXN0U2Nyb2xsRW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGFjdGl2ZSA9IHRoaXMuX2dldEFjdGl2ZUhpc3RvcnkoKSwKCQkJCWN1cnJlbnRTY3JvbGwsIG1pblNjcm9sbCwgZGVmYXVsdFNjcm9sbDsKCgkJCWlmICggYWN0aXZlICkgewoJCQkJY3VycmVudFNjcm9sbCA9IHRoaXMuX2dldFNjcm9sbCgpOwoJCQkJbWluU2Nyb2xsID0gdGhpcy5fZ2V0TWluU2Nyb2xsKCk7CgkJCQlkZWZhdWx0U2Nyb2xsID0gdGhpcy5fZ2V0RGVmYXVsdFNjcm9sbCgpOwoKCQkJCS8vIFNldCBhY3RpdmUgcGFnZSdzIGxhc3RTY3JvbGwgcHJvcC4gSWYgdGhlIGxvY2F0aW9uIHdlJ3JlCgkJCQkvLyBzY3JvbGxpbmcgdG8gaXMgbGVzcyB0aGFuIG1pblNjcm9sbEJhY2ssIGxldCBpdCBnby4KCQkJCWFjdGl2ZS5sYXN0U2Nyb2xsID0gY3VycmVudFNjcm9sbCA8IG1pblNjcm9sbCA/IGRlZmF1bHRTY3JvbGwgOiBjdXJyZW50U2Nyb2xsOwoJCQl9CgkJfSwKCgkJX2RlbGF5ZWRSZWNvcmRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQlzZXRUaW1lb3V0KCAkLnByb3h5KHRoaXMsICJfcmVjb3JkU2Nyb2xsIiksIDEwMCApOwoJCX0sCgoJCV9nZXRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy53aW5kb3cuc2Nyb2xsVG9wKCk7CgkJfSwKCgkJX2dldE1pblNjcm9sbDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5taW5TY3JvbGxCYWNrOwoJCX0sCgoJCV9nZXREZWZhdWx0U2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsOwoJCX0sCgoJCV9maWx0ZXJOYXZpZ2F0ZUV2ZW50czogZnVuY3Rpb24oIGUsIGRhdGEgKSB7CgkJCXZhciB1cmw7CgoJCQlpZiAoIGUub3JpZ2luYWxFdmVudCAmJiBlLm9yaWdpbmFsRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXVybCA9IGUub3JpZ2luYWxFdmVudC50eXBlLmluZGV4T2YoICJoYXNoY2hhbmdlIiApID4gLTEgPyBkYXRhLnN0YXRlLmhhc2ggOiBkYXRhLnN0YXRlLnVybDsKCgkJCWlmICggIXVybCApIHsKCQkJCXVybCA9IHRoaXMuX2dldEhhc2goKTsKCQkJfQoKCQkJaWYgKCAhdXJsIHx8IHVybCA9PT0gIiMiIHx8IHVybC5pbmRleE9mKCAiIyIgKyAkLm1vYmlsZS5wYXRoLnVpU3RhdGVLZXkgKSA9PT0gMCApIHsKCQkJCXVybCA9IGxvY2F0aW9uLmhyZWY7CgkJCX0KCgkJCXRoaXMuX2hhbmRsZU5hdmlnYXRlKCB1cmwsIGRhdGEuc3RhdGUgKTsKCQl9LAoKCQlfZ2V0SGFzaDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoJCX0sCgoJCS8vIFRPRE8gYWN0aXZlIHBhZ2Ugc2hvdWxkIGJlIG1hbmFnZWQgYnkgdGhlIGNvbnRhaW5lciAoaWUsIGl0IHNob3VsZCBiZSBhIHByb3BlcnR5KQoJCWdldEFjdGl2ZVBhZ2U6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5hY3RpdmVQYWdlOwoJCX0sCgoJCS8vIFRPRE8gdGhlIGZpcnN0IHBhZ2Ugc2hvdWxkIGJlIGEgcHJvcGVydHkgc2V0IGR1cmluZyBfY3JlYXRlIHVzaW5nIHRoZSBsb2dpYwoJCS8vICAgICAgdGhhdCBjdXJyZW50bHkgcmVzaWRlcyBpbiBpbml0CgkJX2dldEluaXRpYWxDb250ZW50OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmZpcnN0UGFnZTsKCQl9LAoKCQkvLyBUT0RPIGVhY2ggY29udGVudCBjb250YWluZXIgc2hvdWxkIGhhdmUgYSBoaXN0b3J5IG9iamVjdAoJCV9nZXRIaXN0b3J5OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnk7CgkJfSwKCgkJLy8gVE9ETyB1c2UgX2dldEhpc3RvcnkKCQlfZ2V0QWN0aXZlSGlzdG9yeTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmdldEFjdGl2ZSgpOwoJCX0sCgoJCS8vIFRPRE8gdGhlIGRvY3VtZW50IGJhc2Ugc2hvdWxkIGJlIGRldGVybWluZWQgYXQgY3JlYXRpb24KCQlfZ2V0RG9jdW1lbnRCYXNlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlOwoJCX0sCgoJCWJhY2s6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmdvKCAtMSApOwoJCX0sCgoJCWZvcndhcmQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmdvKCAxICk7CgkJfSwKCgkJZ286IGZ1bmN0aW9uKCBzdGVwcyApIHsKCgkJCS8vaWYgaGFzaGxpc3RlbmluZyBpcyBlbmFibGVkIHVzZSBuYXRpdmUgaGlzdG9yeSBtZXRob2QKCQkJaWYgKCAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCApIHsKCQkJCXdpbmRvdy5oaXN0b3J5LmdvKCBzdGVwcyApOwoJCQl9IGVsc2UgewoKCQkJCS8vd2UgYXJlIG5vdCBsaXN0ZW5pbmcgdG8gdGhlIGhhc2ggc28gaGFuZGxlIGhpc3RvcnkgaW50ZXJuYWxseQoJCQkJdmFyIGFjdGl2ZUluZGV4ID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hY3RpdmVJbmRleCwKCQkJCQlpbmRleCA9IGFjdGl2ZUluZGV4ICsgcGFyc2VJbnQoIHN0ZXBzLCAxMCApLAoJCQkJCXVybCA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnkuc3RhY2tbIGluZGV4IF0udXJsLAoJCQkJCWRpcmVjdGlvbiA9ICggc3RlcHMgPj0gMSApPyAiZm9yd2FyZCIgOiAiYmFjayI7CgoJCQkJLy91cGRhdGUgdGhlIGhpc3Rvcnkgb2JqZWN0CgkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFjdGl2ZUluZGV4ID0gaW5kZXg7CgkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LnByZXZpb3VzSW5kZXggPSBhY3RpdmVJbmRleDsKCgkJCQkvL2NoYW5nZSB0byB0aGUgbmV3IHBhZ2UKCQkJCXRoaXMuY2hhbmdlKCB1cmwsIHsgZGlyZWN0aW9uOiBkaXJlY3Rpb24sIGNoYW5nZUhhc2g6IGZhbHNlLCBmcm9tSGFzaENoYW5nZTogdHJ1ZSB9ICk7CgkJCX0KCQl9LAoKCQkvLyBUT0RPIHJlbmFtZSBfaGFuZGxlRGVzdGluYXRpb24KCQlfaGFuZGxlRGVzdGluYXRpb246IGZ1bmN0aW9uKCB0byApIHsKCQkJdmFyIGhpc3Rvcnk7CgoJCQkvLyBjbGVhbiB0aGUgaGFzaCBmb3IgY29tcGFyaXNvbiBpZiBpdCdzIGEgdXJsCgkJCWlmICggJC50eXBlKHRvKSA9PT0gInN0cmluZyIgKSB7CgkJCQl0byA9ICQubW9iaWxlLnBhdGguc3RyaXBIYXNoKCB0byApOwoJCQl9CgoJCQlpZiAoIHRvICkgewoJCQkJaGlzdG9yeSA9IHRoaXMuX2dldEhpc3RvcnkoKTsKCgkJCQkvLyBBdCB0aGlzIHBvaW50LCAndG8nIGNhbiBiZSBvbmUgb2YgMyB0aGluZ3MsIGEgY2FjaGVkIHBhZ2UKCQkJCS8vIGVsZW1lbnQgZnJvbSBhIGhpc3Rvcnkgc3RhY2sgZW50cnksIGFuIGlkLCBvciBzaXRlLXJlbGF0aXZlIC8KCQkJCS8vIGFic29sdXRlIFVSTC4gSWYgJ3RvJyBpcyBhbiBpZCwgd2UgbmVlZCB0byByZXNvbHZlIGl0IGFnYWluc3QKCQkJCS8vIHRoZSBkb2N1bWVudEJhc2UsIG5vdCB0aGUgbG9jYXRpb24uaHJlZiwgc2luY2UgdGhlIGhhc2hjaGFuZ2UKCQkJCS8vIGNvdWxkJ3ZlIGJlZW4gdGhlIHJlc3VsdCBvZiBhIGZvcndhcmQvYmFja3dhcmQgbmF2aWdhdGlvbgoJCQkJLy8gdGhhdCBjcm9zc2VzIGZyb20gYW4gZXh0ZXJuYWwgcGFnZS9kaWFsb2cgdG8gYW4gaW50ZXJuYWwKCQkJCS8vIHBhZ2UvZGlhbG9nLgoJCQkJLy8KCQkJCS8vIFRPRE8gbW92ZSBjaGVjayB0byBoaXN0b3J5IG9iamVjdCBvciBwYXRoIG9iamVjdD8KCQkJCXRvID0gISQubW9iaWxlLnBhdGguaXNQYXRoKCB0byApID8gKCAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgdG8sIHRoaXMuX2dldERvY3VtZW50QmFzZSgpICkgKSA6IHRvOwoKCQkJCS8vIElmIHdlJ3JlIGFib3V0IHRvIGdvIHRvIGFuIGluaXRpYWwgVVJMIHRoYXQgY29udGFpbnMgYQoJCQkJLy8gcmVmZXJlbmNlIHRvIGEgbm9uLWV4aXN0ZW50IGludGVybmFsIHBhZ2UsIGdvIHRvIHRoZSBmaXJzdAoJCQkJLy8gcGFnZSBpbnN0ZWFkLiBXZSBrbm93IHRoYXQgdGhlIGluaXRpYWwgaGFzaCByZWZlcnMgdG8gYQoJCQkJLy8gbm9uLWV4aXN0ZW50IHBhZ2UsIGJlY2F1c2UgdGhlIGluaXRpYWwgaGFzaCBkaWQgbm90IGVuZAoJCQkJLy8gdXAgaW4gdGhlIGluaXRpYWwgaGlzdG9yeSBlbnRyeQoJCQkJLy8gVE9ETyBtb3ZlIGNoZWNrIHRvIGhpc3Rvcnkgb2JqZWN0PwoJCQkJaWYgKCB0byA9PT0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGhpc3RvcnkuaW5pdGlhbERzdCwgdGhpcy5fZ2V0RG9jdW1lbnRCYXNlKCkgKSAmJgoJCQkJCWhpc3Rvcnkuc3RhY2subGVuZ3RoICYmCgkJCQkJaGlzdG9yeS5zdGFja1swXS51cmwgIT09IGhpc3RvcnkuaW5pdGlhbERzdC5yZXBsYWNlKCAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5LCAiIiApICkgewoJCQkJCXRvID0gdGhpcy5fZ2V0SW5pdGlhbENvbnRlbnQoKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gdG8gfHwgdGhpcy5fZ2V0SW5pdGlhbENvbnRlbnQoKTsKCQl9LAoKCQlfaGFuZGxlRGlhbG9nOiBmdW5jdGlvbiggY2hhbmdlUGFnZU9wdGlvbnMsIGRhdGEgKSB7CgkJCXZhciB0bywgYWN0aXZlLCBhY3RpdmVDb250ZW50ID0gdGhpcy5nZXRBY3RpdmVQYWdlKCk7CgoJCQkvLyBJZiBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIG5vdCBhIGRpYWxvZyBza2lwIHRoZSBkaWFsb2cgYW5kIGNvbnRpbnVlCgkJCS8vIGluIHRoZSBzYW1lIGRpcmVjdGlvbgoJCQlpZiAoIGFjdGl2ZUNvbnRlbnQgJiYgIWFjdGl2ZUNvbnRlbnQuaGFzQ2xhc3MoICJ1aS1kaWFsb2ciICkgKSB7CgkJCQkvLyBkZXRlcm1pbmUgaWYgd2UncmUgaGVhZGluZyBmb3J3YXJkIG9yIGJhY2t3YXJkIGFuZCBjb250aW51ZQoJCQkJLy8gYWNjb3JkaW5nbHkgcGFzdCB0aGUgY3VycmVudCBkaWFsb2cKCQkJCWlmICggZGF0YS5kaXJlY3Rpb24gPT09ICJiYWNrIiApIHsKCQkJCQl0aGlzLmJhY2soKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5mb3J3YXJkKCk7CgkJCQl9CgoJCQkJLy8gcHJldmVudCBjaGFuZ2VQYWdlIGNhbGwKCQkJCXJldHVybiBmYWxzZTsKCQkJfSBlbHNlIHsKCQkJCS8vIGlmIHRoZSBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIGEgZGlhbG9nIGFuZCB3ZSdyZSBuYXZpZ2F0aW5nCgkJCQkvLyB0byBhIGRpYWxvZyB1c2UgdGhlIGRpYWxvZyBvYmplY3RlZCBzYXZlZCBpbiB0aGUgc3RhY2sKCQkJCXRvID0gZGF0YS5wYWdlVXJsOwoJCQkJYWN0aXZlID0gdGhpcy5fZ2V0QWN0aXZlSGlzdG9yeSgpOwoKCQkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHJvbGUsIHRyYW5zaXRpb24gYW5kIHJldmVyc2FsCgkJCQkvLyBhcyBtb3N0IG9mIHRoaXMgaXMgbG9zdCBieSB0aGUgZG9tQ2FjaGUgY2xlYW5pbmcKCQkJCSQuZXh0ZW5kKCBjaGFuZ2VQYWdlT3B0aW9ucywgewoJCQkJCXJvbGU6IGFjdGl2ZS5yb2xlLAoJCQkJCXRyYW5zaXRpb246IGFjdGl2ZS50cmFuc2l0aW9uLAoJCQkJCXJldmVyc2U6IGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIKCQkJCX0pOwoJCQl9CgoJCQlyZXR1cm4gdG87CgkJfSwKCgkJX2hhbmRsZU5hdmlnYXRlOiBmdW5jdGlvbiggdXJsLCBkYXRhICkgewoJCQkvL2ZpbmQgZmlyc3QgcGFnZSB2aWEgaGFzaAoJCQkvLyBUT0RPIHN0cmlwcGluZyB0aGUgaGFzaCB0d2ljZSB3aXRoIGhhbmRsZVVybAoJCQl2YXIgdG8gPSAkLm1vYmlsZS5wYXRoLnN0cmlwSGFzaCggdXJsICksIGhpc3RvcnkgPSB0aGlzLl9nZXRIaXN0b3J5KCksCgoJCQkJLy8gdHJhbnNpdGlvbiBpcyBmYWxzZSBpZiBpdCdzIHRoZSBmaXJzdCBwYWdlLCB1bmRlZmluZWQKCQkJCS8vIG90aGVyd2lzZSAoYW5kIG1heSBiZSBvdmVycmlkZGVuIGJ5IGRlZmF1bHQpCgkJCQl0cmFuc2l0aW9uID0gaGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDAgPyAibm9uZSIgOiB1bmRlZmluZWQsCgoJCQkJLy8gZGVmYXVsdCBvcHRpb25zIGZvciB0aGUgY2hhbmdQYWdlIGNhbGxzIG1hZGUgYWZ0ZXIgZXhhbWluaW5nCgkJCQkvLyB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgcGFnZSBhbmQgdGhlIGhhc2gsIE5PVEUgdGhhdCB0aGUKCQkJCS8vIHRyYW5zaXRpb24gaXMgZGVyaXZlZCBmcm9tIHRoZSBwcmV2aW91cyBoaXN0b3J5IGVudHJ5CgkJCQljaGFuZ2VQYWdlT3B0aW9ucyA9IHsKCQkJCQljaGFuZ2VIYXNoOiBmYWxzZSwKCQkJCQlmcm9tSGFzaENoYW5nZTogdHJ1ZSwKCQkJCQlyZXZlcnNlOiBkYXRhLmRpcmVjdGlvbiA9PT0gImJhY2siCgkJCQl9OwoKCQkJJC5leHRlbmQoIGNoYW5nZVBhZ2VPcHRpb25zLCBkYXRhLCB7CgkJCQl0cmFuc2l0aW9uOiAoIGhpc3RvcnkuZ2V0TGFzdCgpIHx8IHt9ICkudHJhbnNpdGlvbiB8fCB0cmFuc2l0aW9uCgkJCX0pOwoKCQkJLy8gVE9ETyBtb3ZlIHRvIF9oYW5kbGVEZXN0aW5hdGlvbiA/CgkJCS8vIElmIHRoaXMgaXNuJ3QgdGhlIGZpcnN0IHBhZ2UsIGlmIHRoZSBjdXJyZW50IHVybCBpcyBhIGRpYWxvZyBoYXNoCgkJCS8vIGtleSwgYW5kIHRoZSBpbml0aWFsIGRlc3RpbmF0aW9uIGlzbid0IGVxdWFsIHRvIHRoZSBjdXJyZW50IHRhcmdldAoJCQkvLyBwYWdlLCB1c2UgdGhlIHNwZWNpYWwgZGlhbG9nIGhhbmRsaW5nCgkJCWlmICggaGlzdG9yeS5hY3RpdmVJbmRleCA+IDAgJiYKCQkJCXRvLmluZGV4T2YoICQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgKSA+IC0xICYmCgkJCQloaXN0b3J5LmluaXRpYWxEc3QgIT09IHRvICkgewoKCQkJCXRvID0gdGhpcy5faGFuZGxlRGlhbG9nKCBjaGFuZ2VQYWdlT3B0aW9ucywgZGF0YSApOwoKCQkJCWlmICggdG8gPT09IGZhbHNlICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJdGhpcy5fY2hhbmdlQ29udGVudCggdGhpcy5faGFuZGxlRGVzdGluYXRpb24oIHRvICksIGNoYW5nZVBhZ2VPcHRpb25zICk7CgkJfSwKCgkJX2NoYW5nZUNvbnRlbnQ6IGZ1bmN0aW9uKCB0bywgb3B0cyApIHsKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggdG8sIG9wdHMgKTsKCQl9LAoKCQlfZ2V0QmFzZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5iYXNlOwoJCX0sCgoJCV9nZXROczogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5uczsKCQl9LAoKCQlfZW5oYW5jZTogZnVuY3Rpb24oIGNvbnRlbnQsIHJvbGUgKSB7CgkJCS8vIFRPRE8gY29uc2lkZXIgc3VwcG9ydGluZyBhIGN1c3RvbSBjYWxsYmFjaywgYW5kIHBhc3NpbmcgaW4KCQkJLy8gdGhlIHNldHRpbmdzIHdoaWNoIGluY2x1ZGVzIHRoZSByb2xlCgkJCXJldHVybiBjb250ZW50LnBhZ2UoeyByb2xlOiByb2xlIH0pOwoJCX0sCgoJCV9pbmNsdWRlOiBmdW5jdGlvbiggcGFnZSwgc2V0dGluZ3MgKSB7CgkJCS8vIGFwcGVuZCB0byBwYWdlIGFuZCBlbmhhbmNlCgkJCXBhZ2UuYXBwZW5kVG8oIHRoaXMuZWxlbWVudCApOwoKCQkJLy8gdXNlIHRoZSBwYWdlIHdpZGdldCB0byBlbmhhbmNlCgkJCXRoaXMuX2VuaGFuY2UoIHBhZ2UsIHNldHRpbmdzLnJvbGUgKTsKCgkJCS8vIHJlbW92ZSBwYWdlIG9uIGhpZGUKCQkJcGFnZS5wYWdlKCAiYmluZFJlbW92ZSIgKTsKCQl9LAoKCQlfZmluZDogZnVuY3Rpb24oIGFic1VybCApIHsKCQkJLy8gVE9ETyBjb25zaWRlciBzdXBwb3J0aW5nIGEgY3VzdG9tIGNhbGxiYWNrCgkJCXZhciBmaWxlVXJsID0gdGhpcy5fY3JlYXRlRmlsZVVybCggYWJzVXJsICksCgkJCQlkYXRhVXJsID0gdGhpcy5fY3JlYXRlRGF0YVVybCggYWJzVXJsICksCgkJCQlwYWdlLCBpbml0aWFsQ29udGVudCA9IHRoaXMuX2dldEluaXRpYWxDb250ZW50KCk7CgoJCQkvLyBDaGVjayB0byBzZWUgaWYgdGhlIHBhZ2UgYWxyZWFkeSBleGlzdHMgaW4gdGhlIERPTS4KCQkJLy8gTk9URSBkbyBfbm90XyB1c2UgdGhlIDpqcW1EYXRhIHBzZXVkbyBzZWxlY3RvciBiZWNhdXNlIHBhcmVudGhlc2lzCgkJCS8vICAgICAgYXJlIGEgdmFsaWQgdXJsIGNoYXIgYW5kIGl0IGJyZWFrcyBvbiB0aGUgZmlyc3Qgb2NjdXJlbmNlCgkJCXBhZ2UgPSB0aGlzLmVsZW1lbnQKCQkJCS5jaGlsZHJlbiggIltkYXRhLSIgKyB0aGlzLl9nZXROcygpICsidXJsPSciICsgZGF0YVVybCArICInXSIgKTsKCgkJCS8vIElmIHdlIGZhaWxlZCB0byBmaW5kIHRoZSBwYWdlLCBjaGVjayB0byBzZWUgaWYgdGhlIHVybCBpcyBhCgkJCS8vIHJlZmVyZW5jZSB0byBhbiBlbWJlZGRlZCBwYWdlLiBJZiBzbywgaXQgbWF5IGhhdmUgYmVlbiBkeW5hbWljYWxseQoJCQkvLyBpbmplY3RlZCBieSBhIGRldmVsb3BlciwgaW4gd2hpY2ggY2FzZSBpdCB3b3VsZCBiZSBsYWNraW5nIGEKCQkJLy8gZGF0YS11cmwgYXR0cmlidXRlIGFuZCBpbiBuZWVkIG9mIGVuaGFuY2VtZW50LgoJCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICYmIGRhdGFVcmwgJiYgISQubW9iaWxlLnBhdGguaXNQYXRoKCBkYXRhVXJsICkgKSB7CgkJCQlwYWdlID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAkLm1vYmlsZS5wYXRoLmhhc2hUb1NlbGVjdG9yKCIjIiArIGRhdGFVcmwpICkKCQkJCQkuYXR0ciggImRhdGEtIiArIHRoaXMuX2dldE5zKCkgKyAidXJsIiwgZGF0YVVybCApCgkJCQkJLmpxbURhdGEoICJ1cmwiLCBkYXRhVXJsICk7CgkJCX0KCgkJCS8vIElmIHdlIGZhaWxlZCB0byBmaW5kIGEgcGFnZSBpbiB0aGUgRE9NLCBjaGVjayB0aGUgVVJMIHRvIHNlZSBpZiBpdAoJCQkvLyByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIGFwcGxpY2F0aW9uLiBBbHNvIGNoZWNrIHRvIG1ha2Ugc3VyZQoJCQkvLyBvdXIgY2FjaGVkLWZpcnN0LXBhZ2UgaXMgYWN0dWFsbHkgaW4gdGhlIERPTS4gU29tZSB1c2VyIGRlcGxveWVkCgkJCS8vIGFwcHMgYXJlIHBydW5pbmcgdGhlIGZpcnN0IHBhZ2UgZnJvbSB0aGUgRE9NIGZvciB2YXJpb3VzIHJlYXNvbnMuCgkJCS8vIFdlIGNoZWNrIGZvciB0aGlzIGNhc2UgaGVyZSBiZWNhdXNlIHdlIGRvbid0IHdhbnQgYSBmaXJzdC1wYWdlIHdpdGgKCQkJLy8gYW4gaWQgZmFsbGluZyB0aHJvdWdoIHRvIHRoZSBub24tZXhpc3RlbnQgZW1iZWRkZWQgcGFnZSBlcnJvciBjYXNlLgoJCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICYmCgkJCQkkLm1vYmlsZS5wYXRoLmlzRmlyc3RQYWdlVXJsKCBmaWxlVXJsICkgJiYKCQkJCWluaXRpYWxDb250ZW50ICYmCgkJCQlpbml0aWFsQ29udGVudC5wYXJlbnQoKS5sZW5ndGggKSB7CgkJCQlwYWdlID0gJCggaW5pdGlhbENvbnRlbnQgKTsKCQkJfQoKCQkJcmV0dXJuIHBhZ2U7CgkJfSwKCgkJX2dldExvYWRlcjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5sb2FkaW5nKCk7CgkJfSwKCgkJX3Nob3dMb2FkaW5nOiBmdW5jdGlvbiggZGVsYXksIHRoZW1lLCBtc2csIHRleHRvbmx5ICkgewoJCQkvLyBUaGlzIGNvbmZpZ3VyYWJsZSB0aW1lb3V0IGFsbG93cyBjYWNoZWQgcGFnZXMgYSBicmllZgoJCQkvLyBkZWxheSB0byBsb2FkIHdpdGhvdXQgc2hvd2luZyBhIG1lc3NhZ2UKCQkJaWYgKCB0aGlzLl9sb2FkTXNnICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl0aGlzLl9sb2FkTXNnID0gc2V0VGltZW91dCgkLnByb3h5KGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fZ2V0TG9hZGVyKCkubG9hZGVyKCAic2hvdyIsIHRoZW1lLCBtc2csIHRleHRvbmx5ICk7CgkJCQl0aGlzLl9sb2FkTXNnID0gMDsKCQkJfSwgdGhpcyksIGRlbGF5ICk7CgkJfSwKCgkJX2hpZGVMb2FkaW5nOiBmdW5jdGlvbigpIHsKCQkJLy8gU3RvcCBtZXNzYWdlIHNob3cgdGltZXIKCQkJY2xlYXJUaW1lb3V0KCB0aGlzLl9sb2FkTXNnICk7CgkJCXRoaXMuX2xvYWRNc2cgPSAwOwoKCQkJLy8gSGlkZSBsb2FkaW5nIG1lc3NhZ2UKCQkJdGhpcy5fZ2V0TG9hZGVyKCkubG9hZGVyKCAiaGlkZSIgKTsKCQl9LAoKCQlfc2hvd0Vycm9yOiBmdW5jdGlvbigpIHsKCQkJLy8gbWFrZSBzdXJlIHRvIHJlbW92ZSB0aGUgY3VycmVudCBsb2FkaW5nIG1lc3NhZ2UKCQkJdGhpcy5faGlkZUxvYWRpbmcoKTsKCgkJCS8vIHNob3cgdGhlIGVycm9yIG1lc3NhZ2UKCQkJdGhpcy5fc2hvd0xvYWRpbmcoIDAsICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlVGhlbWUsICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlLCB0cnVlICk7CgoJCQkvLyBoaWRlIHRoZSBlcnJvciBtZXNzYWdlIGFmdGVyIGEgZGVsYXkKCQkJLy8gVE9ETyBjb25maWd1cmF0aW9uCgkJCXNldFRpbWVvdXQoICQucHJveHkodGhpcywgIl9oaWRlTG9hZGluZyIpLCAxNTAwICk7CgkJfSwKCgkJX3BhcnNlOiBmdW5jdGlvbiggaHRtbCwgZmlsZVVybCApIHsKCQkJLy8gVE9ETyBjb25zaWRlciBhbGxvd2luZyBjdXN0b21pemF0aW9uIG9mIHRoaXMgbWV0aG9kLiBJdCdzIHZlcnkgSlFNIHNwZWNpZmljCgkJCXZhciBwYWdlLCBhbGwgPSAkKCAiPGRpdj48L2Rpdj4iICk7CgoJCQkvL3dvcmthcm91bmQgdG8gYWxsb3cgc2NyaXB0cyB0byBleGVjdXRlIHdoZW4gaW5jbHVkZWQgaW4gcGFnZSBkaXZzCgkJCWFsbC5nZXQoIDAgKS5pbm5lckhUTUwgPSBodG1sOwoKCQkJcGFnZSA9IGFsbC5maW5kKCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKS5maXJzdCgpOwoKCQkJLy9pZiBwYWdlIGVsZW0gY291bGRuJ3QgYmUgZm91bmQsIGNyZWF0ZSBvbmUgYW5kIGluc2VydCB0aGUgYm9keSBlbGVtZW50J3MgY29udGVudHMKCQkJaWYgKCAhcGFnZS5sZW5ndGggKSB7CgkJCQlwYWdlID0gJCggIjxkaXYgZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJyb2xlPSdwYWdlJz4iICsKCQkJCQkoIGh0bWwuc3BsaXQoIC88XC8/Ym9keVtePl0qPi9nbWkgKVsxXSB8fCAiIiApICsKCQkJCQkiPC9kaXY+IiApOwoJCQl9CgoJCQkvLyBUT0RPIHRhZ2dpbmcgYSBwYWdlIHdpdGggZXh0ZXJuYWwgdG8gbWFrZSBzdXJlIHRoYXQgZW1iZWRkZWQgcGFnZXMgYXJlbid0CgkJCS8vIHJlbW92ZWQgYnkgdGhlIHZhcmlvdXMgcGFnZSBoYW5kbGluZyBjb2RlIGlzIGJhZC4gSGF2aW5nIHBhZ2UgaGFuZGxpbmcgY29kZQoJCQkvLyBpbiBtYW55IHBsYWNlcyBpcyBiYWQuIFNvbHV0aW9ucyBwb3N0IDEuMAoJCQlwYWdlLmF0dHIoICJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInVybCIsICQubW9iaWxlLnBhdGguY29udmVydFVybFRvRGF0YVVybChmaWxlVXJsKSApCgkJCQkuYXR0ciggImRhdGEtIiArIHRoaXMuX2dldE5zKCkgKyAiZXh0ZXJuYWwtcGFnZSIsIHRydWUgKTsKCgkJCXJldHVybiBwYWdlOwoJCX0sCgoJCV9zZXRMb2FkZWRUaXRsZTogZnVuY3Rpb24oIHBhZ2UsIGh0bWwgKSB7CgkJCS8vcGFnZSB0aXRsZSByZWdleHAKCQkJdmFyIG5ld1BhZ2VUaXRsZSA9IGh0bWwubWF0Y2goIC88dGl0bGVbXj5dKj4oW148XSopLyApICYmIFJlZ0V4cC4kMTsKCgkJCWlmICggbmV3UGFnZVRpdGxlICYmICFwYWdlLmpxbURhdGEoInRpdGxlIikgKSB7CgkJCQluZXdQYWdlVGl0bGUgPSAkKCAiPGRpdj4iICsgbmV3UGFnZVRpdGxlICsgIjwvZGl2PiIgKS50ZXh0KCk7CgkJCQlwYWdlLmpxbURhdGEoICJ0aXRsZSIsIG5ld1BhZ2VUaXRsZSApOwoJCQl9CgkJfSwKCgkJX2lzUmV3cml0YWJsZUJhc2VUYWc6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuZHluYW1pY0Jhc2VFbmFibGVkICYmICEkLnN1cHBvcnQuZHluYW1pY0Jhc2VUYWc7CgkJfSwKCgkJX2NyZWF0ZURhdGFVcmw6IGZ1bmN0aW9uKCBhYnNvbHV0ZVVybCApIHsKCQkJcmV0dXJuICQubW9iaWxlLnBhdGguY29udmVydFVybFRvRGF0YVVybCggYWJzb2x1dGVVcmwgKTsKCQl9LAoKCQlfY3JlYXRlRmlsZVVybDogZnVuY3Rpb24oIGFic29sdXRlVXJsICkgewoJCQlyZXR1cm4gJC5tb2JpbGUucGF0aC5nZXRGaWxlUGF0aCggYWJzb2x1dGVVcmwgKTsKCQl9LAoKCQlfdHJpZ2dlcldpdGhEZXByZWNhdGVkOiBmdW5jdGlvbiggbmFtZSwgZGF0YSwgcGFnZSApIHsKCQkJdmFyIGRlcHJlY2F0ZWRFdmVudCA9ICQuRXZlbnQoICJwYWdlIiArIG5hbWUgKSwKCQkJCW5ld0V2ZW50ID0gJC5FdmVudCggdGhpcy53aWRnZXROYW1lICsgbmFtZSApOwoKCQkJLy8gREVQUkVDQVRFRAoJCQkvLyB0cmlnZ2VyIHRoZSBvbGQgZGVwcmVjYXRlZCBldmVudCBvbiB0aGUgcGFnZSBpZiBpdCdzIHByb3ZpZGVkCgkJCSggcGFnZSB8fCB0aGlzLmVsZW1lbnQgKS50cmlnZ2VyKCBkZXByZWNhdGVkRXZlbnQsIGRhdGEgKTsKCgkJCS8vIHVzZSB0aGUgd2lkZ2V0IHRyaWdnZXIgbWV0aG9kIGZvciB0aGUgbmV3IGNvbnRlbnQqIGV2ZW50CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBuZXdFdmVudCwgZGF0YSApOwoKCQkJcmV0dXJuIHsKCQkJCWRlcHJlY2F0ZWRFdmVudDogZGVwcmVjYXRlZEV2ZW50LAoJCQkJZXZlbnQ6IG5ld0V2ZW50CgkJCX07CgkJfSwKCgkJLy8gVE9ETyBpdCB3b3VsZCBiZSBuaWNlIHRvIHNwbGl0IHRoaXMgdXAgbW9yZSBidXQgZXZlcnl0aGluZyBhcHBlYXJzIHRvIGJlICJvbmUgb2ZmIgoJCS8vICAgICAgb3IgcmVxdWlyZSBvcmRlcmluZyBzdWNoIHRoYXQgb3RoZXIgYml0cyBhcmUgc3ByaW5rbGVkIGluIGJldHdlZW4gcGFydHMgdGhhdAoJCS8vICAgICAgY291bGQgYmUgYWJzdHJhY3RlZCBvdXQgYXMgYSBncm91cAoJCV9sb2FkU3VjY2VzczogZnVuY3Rpb24oIGFic1VybCwgdHJpZ2dlckRhdGEsIHNldHRpbmdzLCBkZWZlcnJlZCApIHsKCQkJdmFyIGZpbGVVcmwgPSB0aGlzLl9jcmVhdGVGaWxlVXJsKCBhYnNVcmwgKSwKCQkJCWRhdGFVcmwgPSB0aGlzLl9jcmVhdGVEYXRhVXJsKCBhYnNVcmwgKTsKCgkJCXJldHVybiAkLnByb3h5KGZ1bmN0aW9uKCBodG1sLCB0ZXh0U3RhdHVzLCB4aHIgKSB7CgkJCQkvL3ByZS1wYXJzZSBodG1sIHRvIGNoZWNrIGZvciBhIGRhdGEtdXJsLAoJCQkJLy91c2UgaXQgYXMgdGhlIG5ldyBmaWxlVXJsLCBiYXNlIHBhdGgsIGV0YwoJCQkJdmFyIGNvbnRlbnQsCgoJCQkJCS8vIFRPRE8gaGFuZGxlIGRpYWxvZ3MgYWdhaW4KCQkJCQlwYWdlRWxlbVJlZ2V4ID0gbmV3IFJlZ0V4cCggIig8W14+XStcXGJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInJvbGU9W1wiJ10/cGFnZVtcIiddP1tePl0qPikiICksCgoJCQkJCWRhdGFVcmxSZWdleCA9IG5ldyBSZWdFeHAoICJcXGJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInVybD1bXCInXT8oW15cIic+XSopW1wiJ10/IiApOwoKCQkJCS8vIGRhdGEtdXJsIG11c3QgYmUgcHJvdmlkZWQgZm9yIHRoZSBiYXNlIHRhZyBzbyByZXNvdXJjZSByZXF1ZXN0cwoJCQkJLy8gY2FuIGJlIGRpcmVjdGVkIHRvIHRoZSBjb3JyZWN0IHVybC4gbG9hZGluZyBpbnRvIGEgdGVtcHJvcmFyeQoJCQkJLy8gZWxlbWVudCBtYWtlcyB0aGVzZSByZXF1ZXN0cyBpbW1lZGlhdGVseQoJCQkJaWYgKCBwYWdlRWxlbVJlZ2V4LnRlc3QoIGh0bWwgKSAmJgoJCQkJCVJlZ0V4cC4kMSAmJgoJCQkJCWRhdGFVcmxSZWdleC50ZXN0KCBSZWdFeHAuJDEgKSAmJgoJCQkJCVJlZ0V4cC4kMSApIHsKCQkJCQlmaWxlVXJsID0gJC5tb2JpbGUucGF0aC5nZXRGaWxlUGF0aCggJCgiPGRpdj4iICsgUmVnRXhwLiQxICsgIjwvZGl2PiIpLnRleHQoKSApOwoJCQkJfQoKCQkJCS8vZG9udCB1cGRhdGUgdGhlIGJhc2UgdGFnIGlmIHdlIGFyZSBwcmVmZXRjaGluZwoJCQkJaWYgKCBzZXR0aW5ncy5wcmVmZXRjaCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXRoaXMuX2dldEJhc2UoKS5zZXQoIGZpbGVVcmwgKTsKCQkJCX0KCgkJCQljb250ZW50ID0gdGhpcy5fcGFyc2UoIGh0bWwsIGZpbGVVcmwgKTsKCgkJCQl0aGlzLl9zZXRMb2FkZWRUaXRsZSggY29udGVudCwgaHRtbCApOwoKCQkJCS8vIEFkZCB0aGUgY29udGVudCByZWZlcmVuY2UgYW5kIHhociB0byBvdXIgdHJpZ2dlckRhdGEuCgkJCQl0cmlnZ2VyRGF0YS54aHIgPSB4aHI7CgkJCQl0cmlnZ2VyRGF0YS50ZXh0U3RhdHVzID0gdGV4dFN0YXR1czsKCgkJCQkvLyBERVBSRUNBVEVECgkJCQl0cmlnZ2VyRGF0YS5wYWdlID0gY29udGVudDsKCgkJCQl0cmlnZ2VyRGF0YS5jb250ZW50ID0gY29udGVudDsKCgkJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJCS8vIE5vdGUgdGhhdCBpdCBpcyB0aGUgcmVzcG9uc2liaWxpdHkgb2YgdGhlIGxpc3RlbmVyL2hhbmRsZXIKCQkJCS8vIHRoYXQgY2FsbGVkIHByZXZlbnREZWZhdWx0KCksIHRvIHJlc29sdmUvcmVqZWN0IHRoZQoJCQkJLy8gZGVmZXJyZWQgb2JqZWN0IHdpdGhpbiB0aGUgdHJpZ2dlckRhdGEuCgkJCQlpZiAoICF0aGlzLl90cmlnZ2VyKCAibG9hZCIsIHVuZGVmaW5lZCwgdHJpZ2dlckRhdGEgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gcmV3cml0ZSBzcmMgYW5kIGhyZWYgYXR0cnMgdG8gdXNlIGEgYmFzZSB1cmwgaWYgdGhlIGJhc2UgdGFnIHdvbid0IHdvcmsKCQkJCWlmICggdGhpcy5faXNSZXdyaXRhYmxlQmFzZVRhZygpICYmIGNvbnRlbnQgKSB7CgkJCQkJdGhpcy5fZ2V0QmFzZSgpLnJld3JpdGUoIGZpbGVVcmwsIGNvbnRlbnQgKTsKCQkJCX0KCgkJCQl0aGlzLl9pbmNsdWRlKCBjb250ZW50LCBzZXR0aW5ncyApOwoKCQkJCS8vIEVuaGFuY2luZyB0aGUgY29udGVudCBtYXkgcmVzdWx0IGluIG5ldyBkaWFsb2dzL3N1YiBjb250ZW50IGJlaW5nIGluc2VydGVkCgkJCQkvLyBpbnRvIHRoZSBET00uIElmIHRoZSBvcmlnaW5hbCBhYnNVcmwgcmVmZXJzIHRvIGEgc3ViLWNvbnRlbnQsIHRoYXQgaXMgdGhlCgkJCQkvLyByZWFsIGNvbnRlbnQgd2UgYXJlIGludGVyZXN0ZWQgaW4uCgkJCQlpZiAoIGFic1VybC5pbmRleE9mKCAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICkgPiAtMSApIHsKCQkJCQljb250ZW50ID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiW2RhdGEtIiArIHRoaXMuX2dldE5zKCkgKyJ1cmw9JyIgKyBkYXRhVXJsICsgIiddIiApOwoJCQkJfQoKCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoJCQkJCXRoaXMuX2hpZGVMb2FkaW5nKCk7CgkJCQl9CgoJCQkJLy8gQkVHSU4gREVQUkVDQVRFRCAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgY29udGVudCBsb2FkZWQgc3VjY2Vzc2Z1bGx5LgoJCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJwYWdlbG9hZCIgKTsKCQkJCS8vIEVORCBERVBSRUNBVEVEIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgoJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBzZXR0aW5ncywgY29udGVudCApOwoJCQl9LCB0aGlzKTsKCQl9LAoKCQlfbG9hZERlZmF1bHRzOiB7CgkJCXR5cGU6ICJnZXQiLAoJCQlkYXRhOiB1bmRlZmluZWQsCgoJCQkvLyBERVBSRUNBVEVECgkJCXJlbG9hZFBhZ2U6IGZhbHNlLAoKCQkJcmVsb2FkOiBmYWxzZSwKCgkJCS8vIEJ5IGRlZmF1bHQgd2UgcmVseSBvbiB0aGUgcm9sZSBkZWZpbmVkIGJ5IHRoZSBAZGF0YS1yb2xlIGF0dHJpYnV0ZS4KCQkJcm9sZTogdW5kZWZpbmVkLAoKCQkJc2hvd0xvYWRNc2c6IGZhbHNlLAoKCQkJLy8gVGhpcyBkZWxheSBhbGxvd3MgbG9hZHMgdGhhdCBwdWxsIGZyb20gYnJvd3NlciBjYWNoZSB0bwoJCQkvLyBvY2N1ciB3aXRob3V0IHNob3dpbmcgdGhlIGxvYWRpbmcgbWVzc2FnZS4KCQkJbG9hZE1zZ0RlbGF5OiA1MAoJCX0sCgoJCWxvYWQ6IGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMgKSB7CgkJCS8vIFRoaXMgZnVuY3Rpb24gdXNlcyBkZWZlcnJlZCBub3RpZmljYXRpb25zIHRvIGxldCBjYWxsZXJzCgkJCS8vIGtub3cgd2hlbiB0aGUgY29udGVudCBpcyBkb25lIGxvYWRpbmcsIG9yIGlmIGFuIGVycm9yIGhhcyBvY2N1cnJlZC4KCQkJdmFyIGRlZmVycmVkID0gKCBvcHRpb25zICYmIG9wdGlvbnMuZGVmZXJyZWQgKSB8fCAkLkRlZmVycmVkKCksCgoJCQkJLy8gVGhlIGRlZmF1bHQgbG9hZCBvcHRpb25zIHdpdGggb3ZlcnJpZGVzIHNwZWNpZmllZCBieSB0aGUgY2FsbGVyLgoJCQkJc2V0dGluZ3MgPSAkLmV4dGVuZCgge30sIHRoaXMuX2xvYWREZWZhdWx0cywgb3B0aW9ucyApLAoKCQkJCS8vIFRoZSBET00gZWxlbWVudCBmb3IgdGhlIGNvbnRlbnQgYWZ0ZXIgaXQgaGFzIGJlZW4gbG9hZGVkLgoJCQkJY29udGVudCA9IG51bGwsCgoJCQkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBwYXNzZWQgaW50byB0aGUgZnVuY3Rpb24uIFRoaXMKCQkJCS8vIHZlcnNpb24gb2YgdGhlIFVSTCBtYXkgY29udGFpbiBkaWFsb2cvc3ViY29udGVudCBwYXJhbXMgaW4gaXQuCgkJCQlhYnNVcmwgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCB0aGlzLl9maW5kQmFzZVdpdGhEZWZhdWx0KCkgKSwKCQkJCWZpbGVVcmwsIGRhdGFVcmwsIHBibEV2ZW50LCB0cmlnZ2VyRGF0YTsKCgkJCS8vIERFUFJFQ0FURUQgcmVsb2FkUGFnZQoJCQlzZXR0aW5ncy5yZWxvYWQgPSBzZXR0aW5ncy5yZWxvYWRQYWdlOwoKCQkJLy8gSWYgdGhlIGNhbGxlciBwcm92aWRlZCBkYXRhLCBhbmQgd2UncmUgdXNpbmcgImdldCIgcmVxdWVzdCwKCQkJLy8gYXBwZW5kIHRoZSBkYXRhIHRvIHRoZSBVUkwuCgkJCWlmICggc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAiZ2V0IiApIHsKCQkJCWFic1VybCA9ICQubW9iaWxlLnBhdGguYWRkU2VhcmNoUGFyYW1zKCBhYnNVcmwsIHNldHRpbmdzLmRhdGEgKTsKCQkJCXNldHRpbmdzLmRhdGEgPSB1bmRlZmluZWQ7CgkJCX0KCgkJCS8vIElmIHRoZSBjYWxsZXIgaXMgdXNpbmcgYSAicG9zdCIgcmVxdWVzdCwgcmVsb2FkIG11c3QgYmUgdHJ1ZQoJCQlpZiAoIHNldHRpbmdzLmRhdGEgJiYgc2V0dGluZ3MudHlwZSA9PT0gInBvc3QiICkgewoJCQkJc2V0dGluZ3MucmVsb2FkID0gdHJ1ZTsKCQkJfQoKCQkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBtaW51cyBhbnkgZGlhbG9nL3N1YmNvbnRlbnQgcGFyYW1zLgoJCQkvLyBJbiBvdGhlcndvcmRzIHRoZSByZWFsIFVSTCBvZiB0aGUgY29udGVudCB0byBiZSBsb2FkZWQuCgkJCWZpbGVVcmwgPSB0aGlzLl9jcmVhdGVGaWxlVXJsKCBhYnNVcmwgKTsKCgkJCS8vIFRoZSB2ZXJzaW9uIG9mIHRoZSBVcmwgYWN0dWFsbHkgc3RvcmVkIGluIHRoZSBkYXRhLXVybCBhdHRyaWJ1dGUgb2YKCQkJLy8gdGhlIGNvbnRlbnQuIEZvciBlbWJlZGRlZCBjb250ZW50LCBpdCBpcyBqdXN0IHRoZSBpZCBvZiB0aGUgcGFnZS4gRm9yCgkJCS8vIGNvbnRlbnQgd2l0aGluIHRoZSBzYW1lIGRvbWFpbiBhcyB0aGUgZG9jdW1lbnQgYmFzZSwgaXQgaXMgdGhlIHNpdGUKCQkJLy8gcmVsYXRpdmUgcGF0aC4gRm9yIGNyb3NzLWRvbWFpbiBjb250ZW50IChQaG9uZSBHYXAgb25seSkgdGhlIGVudGlyZQoJCQkvLyBhYnNvbHV0ZSBVcmwgaXMgdXNlZCB0byBsb2FkIHRoZSBjb250ZW50LgoJCQlkYXRhVXJsID0gdGhpcy5fY3JlYXRlRGF0YVVybCggYWJzVXJsICk7CgoJCQljb250ZW50ID0gdGhpcy5fZmluZCggYWJzVXJsICk7CgoJCQkvLyBJZiBpdCBpc24ndCBhIHJlZmVyZW5jZSB0byB0aGUgZmlyc3QgY29udGVudCBhbmQgcmVmZXJzIHRvIG1pc3NpbmcKCQkJLy8gZW1iZWRkZWQgY29udGVudCByZWplY3QgdGhlIGRlZmVycmVkIGFuZCByZXR1cm4KCQkJaWYgKCBjb250ZW50Lmxlbmd0aCA9PT0gMCAmJgoJCQkJJC5tb2JpbGUucGF0aC5pc0VtYmVkZGVkUGFnZShmaWxlVXJsKSAmJgoJCQkJISQubW9iaWxlLnBhdGguaXNGaXJzdFBhZ2VVcmwoZmlsZVVybCkgKSB7CgkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgc2V0dGluZ3MgKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gUmVzZXQgYmFzZSB0byB0aGUgZGVmYXVsdCBkb2N1bWVudCBiYXNlCgkJCS8vIFRPRE8gZmlndXJlIG91dCB3aHkgd2UgZG9lIHRoaXMKCQkJdGhpcy5fZ2V0QmFzZSgpLnJlc2V0KCk7CgoJCQkvLyBJZiB0aGUgY29udGVudCB3ZSBhcmUgaW50ZXJlc3RlZCBpbiBpcyBhbHJlYWR5IGluIHRoZSBET00sCgkJCS8vIGFuZCB0aGUgY2FsbGVyIGRpZCBub3QgaW5kaWNhdGUgdGhhdCB3ZSBzaG91bGQgZm9yY2UgYQoJCQkvLyByZWxvYWQgb2YgdGhlIGZpbGUsIHdlIGFyZSBkb25lLiBSZXNvbHZlIHRoZSBkZWZlcnJyZWQgc28gdGhhdAoJCQkvLyB1c2VycyBjYW4gYmluZCB0byAuZG9uZSBvbiB0aGUgcHJvbWlzZQoJCQlpZiAoIGNvbnRlbnQubGVuZ3RoICYmICFzZXR0aW5ncy5yZWxvYWQgKSB7CgkJCQl0aGlzLl9lbmhhbmNlKCBjb250ZW50LCBzZXR0aW5ncy5yb2xlICk7CgkJCQlkZWZlcnJlZC5yZXNvbHZlKCBhYnNVcmwsIHNldHRpbmdzLCBjb250ZW50ICk7CgoJCQkJLy9pZiB3ZSBhcmUgcmVsb2FkaW5nIHRoZSBjb250ZW50IG1ha2Ugc3VyZSB3ZSB1cGRhdGUKCQkJCS8vIHRoZSBiYXNlIGlmIGl0cyBub3QgYSBwcmVmZXRjaAoJCQkJaWYgKCAhc2V0dGluZ3MucHJlZmV0Y2ggKSB7CgkJCQkJdGhpcy5fZ2V0QmFzZSgpLnNldCh1cmwpOwoJCQkJfQoKCQkJCXJldHVybjsKCQkJfQoKCQkJdHJpZ2dlckRhdGEgPSB7CgkJCQl1cmw6IHVybCwKCQkJCWFic1VybDogYWJzVXJsLAoJCQkJZGF0YVVybDogZGF0YVVybCwKCQkJCWRlZmVycmVkOiBkZWZlcnJlZCwKCQkJCW9wdGlvbnM6IHNldHRpbmdzCgkJCX07CgoJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gbG9hZCBjb250ZW50LgoJCQlwYmxFdmVudCA9IHRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggImJlZm9yZWxvYWQiLCB0cmlnZ2VyRGF0YSApOwoKCQkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJCWlmICggcGJsRXZlbnQuZGVwcmVjYXRlZEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8CgkJCQlwYmxFdmVudC5ldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCQkJCXRoaXMuX3Nob3dMb2FkaW5nKCBzZXR0aW5ncy5sb2FkTXNnRGVsYXkgKTsKCQkJfQoKCQkJLy8gUmVzZXQgYmFzZSB0byB0aGUgZGVmYXVsdCBkb2N1bWVudCBiYXNlLgoJCQkvLyBvbmx5IHJlc2V0IGlmIHdlIGFyZSBub3QgcHJlZmV0Y2hpbmcKCQkJaWYgKCBzZXR0aW5ncy5wcmVmZXRjaCA9PT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fZ2V0QmFzZSgpLnJlc2V0KCk7CgkJCX0KCgkJCWlmICggISggJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzIHx8CgkJCQkkLm1vYmlsZS5wYXRoLmlzU2FtZURvbWFpbigkLm1vYmlsZS5wYXRoLmRvY3VtZW50VXJsLCBhYnNVcmwgKSApICkgewoJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIHNldHRpbmdzICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIExvYWQgdGhlIG5ldyBjb250ZW50LgoJCQkkLmFqYXgoewoJCQkJdXJsOiBmaWxlVXJsLAoJCQkJdHlwZTogc2V0dGluZ3MudHlwZSwKCQkJCWRhdGE6IHNldHRpbmdzLmRhdGEsCgkJCQljb250ZW50VHlwZTogc2V0dGluZ3MuY29udGVudFR5cGUsCgkJCQlkYXRhVHlwZTogImh0bWwiLAoJCQkJc3VjY2VzczogdGhpcy5fbG9hZFN1Y2Nlc3MoIGFic1VybCwgdHJpZ2dlckRhdGEsIHNldHRpbmdzLCBkZWZlcnJlZCApLAoJCQkJZXJyb3I6IHRoaXMuX2xvYWRFcnJvciggYWJzVXJsLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MsIGRlZmVycmVkICkKCQkJfSk7CgkJfSwKCgkJX2xvYWRFcnJvcjogZnVuY3Rpb24oIGFic1VybCwgdHJpZ2dlckRhdGEsIHNldHRpbmdzLCBkZWZlcnJlZCApIHsKCQkJcmV0dXJuICQucHJveHkoZnVuY3Rpb24oIHhociwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24gKSB7CgkJCQkvL3NldCBiYXNlIGJhY2sgdG8gY3VycmVudCBwYXRoCgkJCQl0aGlzLl9nZXRCYXNlKCkuc2V0KCAkLm1vYmlsZS5wYXRoLmdldCgpICk7CgoJCQkJLy8gQWRkIGVycm9yIGluZm8gdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgkJCQl0cmlnZ2VyRGF0YS5lcnJvclRocm93biA9IGVycm9yVGhyb3duOwoKCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgcGFnZSBsb2FkIGZhaWxlZC4KCQkJCXZhciBwbGZFdmVudCA9IHRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggImxvYWRmYWlsZWQiLCB0cmlnZ2VyRGF0YSApOwoKCQkJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCQkJLy8gTm90ZSB0aGF0IGl0IGlzIHRoZSByZXNwb25zaWJpbGl0eSBvZiB0aGUgbGlzdGVuZXIvaGFuZGxlcgoJCQkJLy8gdGhhdCBjYWxsZWQgcHJldmVudERlZmF1bHQoKSwgdG8gcmVzb2x2ZS9yZWplY3QgdGhlCgkJCQkvLyBkZWZlcnJlZCBvYmplY3Qgd2l0aGluIHRoZSB0cmlnZ2VyRGF0YS4KCQkJCWlmICggcGxmRXZlbnQuZGVwcmVjYXRlZEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8CgkJCQkJcGxmRXZlbnQuZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoJCQkJCXRoaXMuX3Nob3dFcnJvcigpOwoJCQkJfQoKCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBzZXR0aW5ncyApOwoJCQl9LCB0aGlzKTsKCQl9LAoKCQlfZ2V0VHJhbnNpdGlvbkhhbmRsZXI6IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCQl0cmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24oIHRyYW5zaXRpb24gKTsKCgkJCS8vZmluZCB0aGUgdHJhbnNpdGlvbiBoYW5kbGVyIGZvciB0aGUgc3BlY2lmaWVkIHRyYW5zaXRpb24uIElmIHRoZXJlCgkJCS8vaXNuJ3Qgb25lIGluIG91ciB0cmFuc2l0aW9uSGFuZGxlcnMgZGljdGlvbmFyeSwgdXNlIHRoZSBkZWZhdWx0IG9uZS4KCQkJLy9jYWxsIHRoZSBoYW5kbGVyIGltbWVkaWF0ZWx5IHRvIGtpY2stb2ZmIHRoZSB0cmFuc2l0aW9uLgoJCQlyZXR1cm4gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzWyB0cmFuc2l0aW9uIF0gfHwgJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyOwoJCX0sCgoJCS8vIFRPRE8gbW92ZSBpbnRvIHRyYW5zaXRpb24gaGFuZGxlcnM/CgkJX3RyaWdnZXJDc3NUcmFuc2l0aW9uRXZlbnRzOiBmdW5jdGlvbiggdG8sIGZyb20sIHByZWZpeCApIHsKCQkJdmFyIHNhbWVQYWdlID0gZmFsc2U7CgoJCQlwcmVmaXggPSBwcmVmaXggfHwgIiI7CgoJCQkvLyBUT0RPIGRlY2lkZSBpZiB0aGVzZSBldmVudHMgc2hvdWxkIGluIGZhY3QgYmUgdHJpZ2dlcmVkIG9uIHRoZSBjb250YWluZXIKCQkJaWYgKCBmcm9tICkgewoKCQkJCS8vQ2hlY2sgaWYgdGhpcyBpcyBhIHNhbWUgcGFnZSB0cmFuc2l0aW9uIGFuZCB0ZWxsIHRoZSBoYW5kbGVyIGluIHBhZ2UKCQkJCWlmKCB0b1swXSA9PT0gZnJvbVswXSApewoJCQkJCXNhbWVQYWdlID0gdHJ1ZTsKCQkJCX0KCgkJCQkvL3RyaWdnZXIgYmVmb3JlIHNob3cvaGlkZSBldmVudHMKCQkJCS8vIFRPRE8gZGVwcmVjYXRlIG5leHRQYWdlIGluIGZhdm9yIG9mIG5leHQKCQkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggcHJlZml4ICsgImhpZGUiLCB7IG5leHRQYWdlOiB0bywgc2FtZVBhZ2U6IHNhbWVQYWdlIH0sIGZyb20gKTsKCQkJfQoKCQkJLy8gVE9ETyBkZXByZWNhdGUgcHJldlBhZ2UgaW4gZmF2b3Igb2YgcHJldmlvdXMKCQkJdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCBwcmVmaXggKyAic2hvdyIsIHsgcHJldlBhZ2U6IGZyb20gfHwgJCggIiIgKSB9LCB0byApOwoJCX0sCgoJCS8vIFRPRE8gbWFrZSBwcml2YXRlIG9uY2UgY2hhbmdlIGhhcyBiZWVuIGRlZmluZWQgaW4gdGhlIHdpZGdldAoJCV9jc3NUcmFuc2l0aW9uOiBmdW5jdGlvbiggdG8sIGZyb20sIG9wdGlvbnMgKSB7CgkJCXZhciB0cmFuc2l0aW9uID0gb3B0aW9ucy50cmFuc2l0aW9uLAoJCQkJcmV2ZXJzZSA9IG9wdGlvbnMucmV2ZXJzZSwKCQkJCWRlZmVycmVkID0gb3B0aW9ucy5kZWZlcnJlZCwKCQkJCVRyYW5zaXRpb25IYW5kbGVyLAoJCQkJcHJvbWlzZTsKCgkJCXRoaXMuX3RyaWdnZXJDc3NUcmFuc2l0aW9uRXZlbnRzKCB0bywgZnJvbSwgImJlZm9yZSIgKTsKCgkJCS8vIFRPRE8gcHV0IHRoaXMgaW4gYSBiaW5kaW5nIHRvIGV2ZW50cyAqb3V0c2lkZSogdGhlIHdpZGdldAoJCQl0aGlzLl9oaWRlTG9hZGluZygpOwoKCQkJVHJhbnNpdGlvbkhhbmRsZXIgPSB0aGlzLl9nZXRUcmFuc2l0aW9uSGFuZGxlciggdHJhbnNpdGlvbiApOwoKCQkJcHJvbWlzZSA9ICggbmV3IFRyYW5zaXRpb25IYW5kbGVyKCB0cmFuc2l0aW9uLCByZXZlcnNlLCB0bywgZnJvbSApICkudHJhbnNpdGlvbigpOwoKCQkJLy8gVE9ETyB0ZW1wb3JhcnkgYWNjb21vZGF0aW9uIG9mIGFyZ3VtZW50IGRlZmVycmVkCgkJCXByb21pc2UuZG9uZShmdW5jdGlvbigpIHsKCQkJCWRlZmVycmVkLnJlc29sdmUuYXBwbHkoIGRlZmVycmVkLCBhcmd1bWVudHMgKTsKCQkJfSk7CgoJCQlwcm9taXNlLmRvbmUoJC5wcm94eShmdW5jdGlvbigpIHsKCQkJCXRoaXMuX3RyaWdnZXJDc3NUcmFuc2l0aW9uRXZlbnRzKCB0bywgZnJvbSApOwoJCQl9LCB0aGlzKSk7CgkJfSwKCgkJX3JlbGVhc2VUcmFuc2l0aW9uTG9jazogZnVuY3Rpb24oKSB7CgkJCS8vcmVsZWFzZSB0cmFuc2l0aW9uIGxvY2sgc28gbmF2aWdhdGlvbiBpcyBmcmVlIGFnYWluCgkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCQkJaWYgKCBwYWdlVHJhbnNpdGlvblF1ZXVlLmxlbmd0aCA+IDAgKSB7CgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlLmFwcGx5KCBudWxsLCBwYWdlVHJhbnNpdGlvblF1ZXVlLnBvcCgpICk7CgkJCX0KCQl9LAoKCQlfcmVtb3ZlQWN0aXZlTGlua0NsYXNzOiBmdW5jdGlvbiggZm9yY2UgKSB7CgkJCS8vY2xlYXIgb3V0IHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlCgkJCSQubW9iaWxlLnJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggZm9yY2UgKTsKCQl9LAoKCQlfbG9hZFVybDogZnVuY3Rpb24oIHRvLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MgKSB7CgkJCS8vIHByZXNlcnZlIHRoZSBvcmlnaW5hbCB0YXJnZXQgYXMgdGhlIGRhdGFVcmwgdmFsdWUgd2lsbCBiZQoJCQkvLyBzaW1wbGlmaWVkIGVnLCByZW1vdmluZyB1aS1zdGF0ZSwgYW5kIHJlbW92aW5nIHF1ZXJ5IHBhcmFtcwoJCQkvLyBmcm9tIHRoZSBoYXNoIHRoaXMgaXMgc28gdGhhdCB1c2VycyB3aG8gd2FudCB0byB1c2UgcXVlcnkKCQkJLy8gcGFyYW1zIGhhdmUgYWNjZXNzIHRvIHRoZW0gaW4gdGhlIGV2ZW50IGJpbmRpbmdzIGZvciB0aGUgcGFnZQoJCQkvLyBsaWZlIGN5Y2xlIFNlZSBpc3N1ZSAjNTA4NQoJCQlzZXR0aW5ncy50YXJnZXQgPSB0bzsKCQkJc2V0dGluZ3MuZGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgoJCQl0aGlzLmxvYWQoIHRvLCBzZXR0aW5ncyApOwoKCQkJc2V0dGluZ3MuZGVmZXJyZWQuZG9uZSgkLnByb3h5KGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMsIGNvbnRlbnQgKSB7CgkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgoJCQkJLy8gc3RvcmUgdGhlIG9yaWdpbmFsIGFic29sdXRlIHVybCBzbyB0aGF0IGl0IGNhbiBiZSBwcm92aWRlZAoJCQkJLy8gdG8gZXZlbnRzIGluIHRoZSB0cmlnZ2VyRGF0YSBvZiB0aGUgc3Vic2VxdWVudCBjaGFuZ2VQYWdlIGNhbGwKCQkJCW9wdGlvbnMuYWJzVXJsID0gdHJpZ2dlckRhdGEuYWJzVXJsOwoKCQkJCXRoaXMudHJhbnNpdGlvbiggY29udGVudCwgdHJpZ2dlckRhdGEsIG9wdGlvbnMgKTsKCQkJfSwgdGhpcykpOwoKCQkJc2V0dGluZ3MuZGVmZXJyZWQuZmFpbCgkLnByb3h5KGZ1bmN0aW9uKC8qIHVybCwgb3B0aW9ucyAqLykgewoJCQkJdGhpcy5fcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgkJCQl0aGlzLl9yZWxlYXNlVHJhbnNpdGlvbkxvY2soKTsKCQkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggImNoYW5nZWZhaWxlZCIsIHRyaWdnZXJEYXRhICk7CgkJCX0sIHRoaXMpKTsKCQl9LAoKCQlfdHJpZ2dlclBhZ2VCZWZvcmVDaGFuZ2U6IGZ1bmN0aW9uKCB0bywgdHJpZ2dlckRhdGEsIHNldHRpbmdzICkgewoJCQl2YXIgcGJjRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2ViZWZvcmVjaGFuZ2UiICk7CgoJCQkkLmV4dGVuZCh0cmlnZ2VyRGF0YSwgeyB0b1BhZ2U6IHRvLCBvcHRpb25zOiBzZXR0aW5ncyB9KTsKCgkJCS8vIE5PVEU6IHByZXNlcnZlIHRoZSBvcmlnaW5hbCB0YXJnZXQgYXMgdGhlIGRhdGFVcmwgdmFsdWUgd2lsbCBiZQoJCQkvLyBzaW1wbGlmaWVkIGVnLCByZW1vdmluZyB1aS1zdGF0ZSwgYW5kIHJlbW92aW5nIHF1ZXJ5IHBhcmFtcyBmcm9tCgkJCS8vIHRoZSBoYXNoIHRoaXMgaXMgc28gdGhhdCB1c2VycyB3aG8gd2FudCB0byB1c2UgcXVlcnkgcGFyYW1zIGhhdmUKCQkJLy8gYWNjZXNzIHRvIHRoZW0gaW4gdGhlIGV2ZW50IGJpbmRpbmdzIGZvciB0aGUgcGFnZSBsaWZlIGN5Y2xlCgkJCS8vIFNlZSBpc3N1ZSAjNTA4NQoJCQlpZiAoICQudHlwZSh0bykgPT09ICJzdHJpbmciICkgewoJCQkJLy8gaWYgdGhlIHRvUGFnZSBpcyBhIHN0cmluZyBzaW1wbHkgY29udmVydCBpdAoJCQkJdHJpZ2dlckRhdGEuYWJzVXJsID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIHRvLCB0aGlzLl9maW5kQmFzZVdpdGhEZWZhdWx0KCkgKTsKCQkJfSBlbHNlIHsKCQkJCS8vIGlmIHRoZSB0b1BhZ2UgaXMgYSBqUXVlcnkgb2JqZWN0IGdyYWIgdGhlIGFic29sdXRlIHVybCBzdG9yZWQKCQkJCS8vIGluIHRoZSBsb2FkUGFnZSBjYWxsYmFjayB3aGVyZSBpdCBleGlzdHMKCQkJCXRyaWdnZXJEYXRhLmFic1VybCA9IHNldHRpbmdzLmFic1VybDsKCQkJfQoKCQkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHdlJ3JlIGFib3V0IHRvIGNoYW5nZSB0aGUgY3VycmVudCBwYWdlLgoJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggcGJjRXZlbnQsIHRyaWdnZXJEYXRhICk7CgoJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJaWYgKCBwYmNFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJcmV0dXJuIHRydWU7CgkJfSwKCgkJY2hhbmdlOiBmdW5jdGlvbiggdG8sIG9wdGlvbnMgKSB7CgkJCS8vIElmIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgYSB0cmFuc2l0aW9uLCBxdWV1ZSB0aGUgY3VycmVudCByZXF1ZXN0LgoJCQkvLyBXZSdsbCBjYWxsIGNoYW5nZVBhZ2UoKSBvbmNlIHdlJ3JlIGRvbmUgd2l0aCB0aGUgY3VycmVudCB0cmFuc2l0aW9uCgkJCS8vIHRvIHNlcnZpY2UgdGhlIHJlcXVlc3QuCgkJCWlmICggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJCXBhZ2VUcmFuc2l0aW9uUXVldWUudW5zaGlmdCggYXJndW1lbnRzICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBzZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgJC5tb2JpbGUuY2hhbmdlUGFnZS5kZWZhdWx0cywgb3B0aW9ucyApLAoJCQkJdHJpZ2dlckRhdGEgPSB7fTsKCgkJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgZnJvbVBhZ2UuCgkJCXNldHRpbmdzLmZyb21QYWdlID0gc2V0dGluZ3MuZnJvbVBhZ2UgfHwgdGhpcy5hY3RpdmVQYWdlOwoKCQkJLy8gaWYgdGhlIHBhZ2UgYmVmb3JlY2hhbmdlIGRlZmF1bHQgaXMgcHJldmVudGVkIHJldHVybiBlYXJseQoJCQlpZiAoICF0aGlzLl90cmlnZ2VyUGFnZUJlZm9yZUNoYW5nZSh0bywgdHJpZ2dlckRhdGEsIHNldHRpbmdzKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gV2UgYWxsb3cgInBhZ2ViZWZvcmVjaGFuZ2UiIG9ic2VydmVycyB0byBtb2RpZnkgdGhlIHRvIGluCgkJCS8vIHRoZSB0cmlnZ2VyIGRhdGEgdG8gYWxsb3cgZm9yIHJlZGlyZWN0cy4gTWFrZSBzdXJlIG91ciB0byBpcwoJCQkvLyB1cGRhdGVkLiBXZSBhbHNvIG5lZWQgdG8gcmUtZXZhbHVhdGUgd2hldGhlciBpdCBpcyBhIHN0cmluZywKCQkJLy8gYmVjYXVzZSBhbiBvYmplY3QgY2FuIGFsc28gYmUgcmVwbGFjZWQgYnkgYSBzdHJpbmcKCQkJdG8gPSB0cmlnZ2VyRGF0YS50b1BhZ2U7CgoJCQkvLyBJZiB0aGUgY2FsbGVyIHBhc3NlZCB1cyBhIHVybCwgY2FsbCBsb2FkUGFnZSgpCgkJCS8vIHRvIG1ha2Ugc3VyZSBpdCBpcyBsb2FkZWQgaW50byB0aGUgRE9NLiBXZSdsbCBsaXN0ZW4KCQkJLy8gdG8gdGhlIHByb21pc2Ugb2JqZWN0IGl0IHJldHVybnMgc28gd2Uga25vdyB3aGVuCgkJCS8vIGl0IGlzIGRvbmUgbG9hZGluZyBvciBpZiBhbiBlcnJvciBvY3VycmVkLgoJCQlpZiAoICQudHlwZSh0bykgPT09ICJzdHJpbmciICkgewoJCQkJLy8gU2V0IHRoZSBpc1BhZ2VUcmFuc2l0aW9uaW5nIGZsYWcgdG8gcHJldmVudCBhbnkgcmVxdWVzdHMgZnJvbQoJCQkJLy8gZW50ZXJpbmcgdGhpcyBtZXRob2Qgd2hpbGUgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBsb2FkaW5nIGEgcGFnZQoJCQkJLy8gb3IgdHJhbnNpdGlvbmluZy4KCQkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSB0cnVlOwoKCQkJCXRoaXMuX2xvYWRVcmwoIHRvLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMudHJhbnNpdGlvbiggdG8sIHRyaWdnZXJEYXRhLCBzZXR0aW5ncyApOwoJCQl9CgkJfSwKCgkJdHJhbnNpdGlvbjogZnVuY3Rpb24oIHRvUGFnZSwgdHJpZ2dlckRhdGEsIHNldHRpbmdzICkgewoJCQl2YXIgZnJvbVBhZ2UsIHVybCwgcGFnZVVybCwgZmlsZVVybCwKCQkJCWFjdGl2ZSwgYWN0aXZlSXNJbml0aWFsUGFnZSwKCQkJCWhpc3RvcnlEaXIsIHBhZ2VUaXRsZSwgaXNEaWFsb2csCgkJCQlhbHJlYWR5VGhlcmUsIG5ld1BhZ2VUaXRsZSwKCQkJCXBhcmFtcywJY3NzVHJhbnNpdGlvbkRlZmVycmVkLAoJCQkJYmVmb3JlVHJhbnNpdGlvbjsKCgkJCS8vIElmIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgYSB0cmFuc2l0aW9uLCBxdWV1ZSB0aGUgY3VycmVudCByZXF1ZXN0LgoJCQkvLyBXZSdsbCBjYWxsIGNoYW5nZVBhZ2UoKSBvbmNlIHdlJ3JlIGRvbmUgd2l0aCB0aGUgY3VycmVudCB0cmFuc2l0aW9uCgkJCS8vIHRvIHNlcnZpY2UgdGhlIHJlcXVlc3QuCgkJCWlmICggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJCS8vIG1ha2Ugc3VyZSB0byBvbmx5IHF1ZXVlIHRoZSB0byBhbmQgc2V0dGluZ3MgdmFsdWVzIHNvIHRoZSBhcmd1bWVudHMKCQkJCS8vIHdvcmsgd2l0aCBhIGNhbGwgdG8gdGhlIGNoYW5nZSBtZXRob2QKCQkJCXBhZ2VUcmFuc2l0aW9uUXVldWUudW5zaGlmdCggW3RvUGFnZSwgc2V0dGluZ3NdICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIERFUFJFQ0FURUQgLSB0aGlzIGNhbGwgb25seSwgaW4gZmF2b3Igb2YgdGhlIGJlZm9yZSB0cmFuc2l0aW9uCgkJCS8vIGlmIHRoZSBwYWdlIGJlZm9yZWNoYW5nZSBkZWZhdWx0IGlzIHByZXZlbnRlZCByZXR1cm4gZWFybHkKCQkJaWYgKCAhdGhpcy5fdHJpZ2dlclBhZ2VCZWZvcmVDaGFuZ2UodG9QYWdlLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBpZiB0aGUgKGNvbnRlbnR8cGFnZSliZWZvcmV0cmFuc2l0aW9uIGRlZmF1bHQgaXMgcHJldmVudGVkIHJldHVybiBlYXJseQoJCQkvLyBOb3RlLCB3ZSBoYXZlIHRvIGNoZWNrIGZvciBib3RoIHRoZSBkZXByZWNhdGVkIGFuZCBuZXcgZXZlbnRzCgkJCWJlZm9yZVRyYW5zaXRpb24gPSB0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJiZWZvcmV0cmFuc2l0aW9uIiwgdHJpZ2dlckRhdGEgKTsKCQkJaWYgKGJlZm9yZVRyYW5zaXRpb24uZGVwcmVjYXRlZEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8CgkJCQliZWZvcmVUcmFuc2l0aW9uLmV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBTZXQgdGhlIGlzUGFnZVRyYW5zaXRpb25pbmcgZmxhZyB0byBwcmV2ZW50IGFueSByZXF1ZXN0cyBmcm9tCgkJCS8vIGVudGVyaW5nIHRoaXMgbWV0aG9kIHdoaWxlIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgbG9hZGluZyBhIHBhZ2UKCQkJLy8gb3IgdHJhbnNpdGlvbmluZy4KCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IHRydWU7CgoJCQkvLyBJZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGZpcnN0LXBhZ2Ugb2YgdGhlIGFwcGxpY2F0aW9uLCB3ZSBuZWVkIHRvIG1ha2UKCQkJLy8gc3VyZSBzZXR0aW5ncy5kYXRhVXJsIGlzIHNldCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgdXJsLiBUaGlzIGFsbG93cwoJCQkvLyB1cyB0byBhdm9pZCBnZW5lcmF0aW5nIGEgZG9jdW1lbnQgdXJsIHdpdGggYW4gaWQgaGFzaCBpbiB0aGUgY2FzZSB3aGVyZSB0aGUKCQkJLy8gZmlyc3QtcGFnZSBvZiB0aGUgZG9jdW1lbnQgaGFzIGFuIGlkIGF0dHJpYnV0ZSBzcGVjaWZpZWQuCgkJCWlmICggdG9QYWdlWyAwIF0gPT09ICQubW9iaWxlLmZpcnN0UGFnZVsgMCBdICYmICFzZXR0aW5ncy5kYXRhVXJsICkgewoJCQkJc2V0dGluZ3MuZGF0YVVybCA9ICQubW9iaWxlLnBhdGguZG9jdW1lbnRVcmwuaHJlZk5vSGFzaDsKCQkJfQoKCQkJLy8gVGhlIGNhbGxlciBwYXNzZWQgdXMgYSByZWFsIHBhZ2UgRE9NIGVsZW1lbnQuIFVwZGF0ZSBvdXIKCQkJLy8gaW50ZXJuYWwgc3RhdGUgYW5kIHRoZW4gdHJpZ2dlciBhIHRyYW5zaXRpb24gdG8gdGhlIHBhZ2UuCgkJCWZyb21QYWdlID0gc2V0dGluZ3MuZnJvbVBhZ2U7CgkJCXVybCA9ICggc2V0dGluZ3MuZGF0YVVybCAmJiAkLm1vYmlsZS5wYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoc2V0dGluZ3MuZGF0YVVybCkgKSB8fAoJCQkJdG9QYWdlLmpxbURhdGEoICJ1cmwiICk7CgoJCQkvLyBUaGUgcGFnZVVybCB2YXIgaXMgdXN1YWxseSB0aGUgc2FtZSBhcyB1cmwsIGV4Y2VwdCB3aGVuIHVybCBpcyBvYnNjdXJlZAoJCQkvLyBhcyBhIGRpYWxvZyB1cmwuIHBhZ2VVcmwgYWx3YXlzIGNvbnRhaW5zIHRoZSBmaWxlIHBhdGgKCQkJcGFnZVVybCA9IHVybDsKCQkJZmlsZVVybCA9ICQubW9iaWxlLnBhdGguZ2V0RmlsZVBhdGgoIHVybCApOwoJCQlhY3RpdmUgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmdldEFjdGl2ZSgpOwoJCQlhY3RpdmVJc0luaXRpYWxQYWdlID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMDsKCQkJaGlzdG9yeURpciA9IDA7CgkJCXBhZ2VUaXRsZSA9IGRvY3VtZW50LnRpdGxlOwoJCQlpc0RpYWxvZyA9ICggc2V0dGluZ3Mucm9sZSA9PT0gImRpYWxvZyIgfHwKCQkJCXRvUGFnZS5qcW1EYXRhKCAicm9sZSIgKSA9PT0gImRpYWxvZyIgKSAmJgoJCQkJdG9QYWdlLmpxbURhdGEoICJkaWFsb2ciICkgIT09IHRydWU7CgoJCQkvLyBCeSBkZWZhdWx0LCB3ZSBwcmV2ZW50IGNoYW5nZVBhZ2UgcmVxdWVzdHMgd2hlbiB0aGUgZnJvbVBhZ2UgYW5kIHRvUGFnZQoJCQkvLyBhcmUgdGhlIHNhbWUgZWxlbWVudCwgYnV0IGZvbGtzIHRoYXQgZ2VuZXJhdGUgY29udGVudAoJCQkvLyBtYW51YWxseS9keW5hbWljYWxseSBhbmQgcmV1c2UgcGFnZXMgd2FudCB0byBiZSBhYmxlIHRvIHRyYW5zaXRpb24gdG8KCQkJLy8gdGhlIHNhbWUgcGFnZS4gVG8gYWxsb3cgdGhpcywgdGhleSB3aWxsIG5lZWQgdG8gY2hhbmdlIHRoZSBkZWZhdWx0CgkJCS8vIHZhbHVlIG9mIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uIHRvIHRydWUsICpPUiosIHBhc3MgaXQgaW4gYXMgYW4KCQkJLy8gb3B0aW9uIHdoZW4gdGhleSBtYW51YWxseSBjYWxsIGNoYW5nZVBhZ2UoKS4gSXQgc2hvdWxkIGJlIG5vdGVkIHRoYXQKCQkJLy8gb3VyIGRlZmF1bHQgdHJhbnNpdGlvbiBhbmltYXRpb25zIGFzc3VtZSB0aGF0IHRoZSBmb3JtUGFnZSBhbmQgdG9QYWdlCgkJCS8vIGFyZSBkaWZmZXJlbnQgZWxlbWVudHMsIHNvIHRoZXkgbWF5IGJlaGF2ZSB1bmV4cGVjdGVkbHkuIEl0IGlzIHVwIHRvCgkJCS8vIHRoZSBkZXZlbG9wZXIgdGhhdCB0dXJucyBvbiB0aGUgYWxsb3dTYW1lUGFnZVRyYW5zaXRpb25hIG9wdGlvbiB0bwoJCQkvLyBlaXRoZXIgdHVybiBvZmYgdHJhbnNpdGlvbiBhbmltYXRpb25zLCBvciBtYWtlIHN1cmUgdGhhdCBhbiBhcHByb3ByaWF0ZQoJCQkvLyBhbmltYXRpb24gdHJhbnNpdGlvbiBpcyB1c2VkLgoJCQlpZiAoIGZyb21QYWdlICYmIGZyb21QYWdlWzBdID09PSB0b1BhZ2VbMF0gJiYKCQkJCSFzZXR0aW5ncy5hbGxvd1NhbWVQYWdlVHJhbnNpdGlvbiApIHsKCgkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJCQl0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJ0cmFuc2l0aW9uIiwgdHJpZ2dlckRhdGEgKTsKCQkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAicGFnZWNoYW5nZSIsIHRyaWdnZXJEYXRhICk7CgoJCQkJLy8gRXZlbiBpZiB0aGVyZSBpcyBubyBwYWdlIGNoYW5nZSB0byBiZSBkb25lLCB3ZSBzaG91bGQga2VlcCB0aGUKCQkJCS8vIHVybEhpc3RvcnkgaW4gc3luYyB3aXRoIHRoZSBoYXNoIGNoYW5nZXMKCQkJCWlmICggc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5kaXJlY3QoeyB1cmw6IHVybCB9KTsKCQkJCX0KCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoZSBwYWdlIHdlIGFyZSBnaXZlbiBoYXMgYWxyZWFkeSBiZWVuIGVuaGFuY2VkLgoJCQl0b1BhZ2UucGFnZSh7IHJvbGU6IHNldHRpbmdzLnJvbGUgfSk7CgoJCQkvLyBJZiB0aGUgY2hhbmdlUGFnZSByZXF1ZXN0IHdhcyBzZW50IGZyb20gYSBoYXNoQ2hhbmdlIGV2ZW50LCBjaGVjayB0bwoJCQkvLyBzZWUgaWYgdGhlIHBhZ2UgaXMgYWxyZWFkeSB3aXRoaW4gdGhlIHVybEhpc3Rvcnkgc3RhY2suIElmIHNvLCB3ZSdsbAoJCQkvLyBhc3N1bWUgdGhlIHVzZXIgaGl0IHRoZSBmb3J3YXJkL2JhY2sgYnV0dG9uIGFuZCB3aWxsIHRyeSB0byBtYXRjaCB0aGUKCQkJLy8gdHJhbnNpdGlvbiBhY2NvcmRpbmdseS4KCQkJaWYgKCBzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJCWhpc3RvcnlEaXIgPSBzZXR0aW5ncy5kaXJlY3Rpb24gPT09ICJiYWNrIiA/IC0xIDogMTsKCQkJfQoKCQkJLy8gS2lsbCB0aGUga2V5Ym9hcmQuCgkJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBzdG9wIGNyYXdsaW5nIHRoZSBlbnRpcmUgZG9jdW1lbnQgdG8ga2lsbCBmb2N1cy4KCQkJLy8gICAgICAgICAgICBJbnN0ZWFkLCB3ZSBzaG91bGQgYmUgdHJhY2tpbmcgZm9jdXMgd2l0aCBhIGRlbGVnYXRlKCkKCQkJLy8gICAgICAgICAgICBoYW5kbGVyIHNvIHdlIGFscmVhZHkgaGF2ZSB0aGUgZWxlbWVudCBpbiBoYW5kIGF0IHRoaXMKCQkJLy8gICAgICAgICAgICBwb2ludC4KCQkJLy8gV3JhcCB0aGlzIGluIGEgdHJ5L2NhdGNoIGJsb2NrIHNpbmNlIElFOSB0aHJvdyAiVW5zcGVjaWZpZWQgZXJyb3IiIGlmCgkJCS8vIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgaXMgdW5kZWZpbmVkIHdoZW4gd2UgYXJlIGluIGFuIElGcmFtZS4KCQkJdHJ5IHsKCQkJCWlmICggZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJgoJCQkJCWRvY3VtZW50LmFjdGl2ZUVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gImJvZHkiICkgewoKCQkJCQkkKCBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICkuYmx1cigpOwoJCQkJfSBlbHNlIHsKCQkJCQkkKCAiaW5wdXQ6Zm9jdXMsIHRleHRhcmVhOmZvY3VzLCBzZWxlY3Q6Zm9jdXMiICkuYmx1cigpOwoJCQkJfQoJCQl9IGNhdGNoKCBlICkge30KCgkJCS8vIFJlY29yZCB3aGV0aGVyIHdlIGFyZSBhdCBhIHBsYWNlIGluIGhpc3Rvcnkgd2hlcmUgYSBkaWFsb2cgdXNlZCB0byBiZSAtCgkJCS8vIGlmIHNvLCBkbyBub3QgYWRkIGEgbmV3IGhpc3RvcnkgZW50cnkgYW5kIGRvIG5vdCBjaGFuZ2UgdGhlIGhhc2ggZWl0aGVyCgkJCWFscmVhZHlUaGVyZSA9IGZhbHNlOwoKCQkJLy8gSWYgd2UncmUgZGlzcGxheWluZyB0aGUgcGFnZSBhcyBhIGRpYWxvZywgd2UgZG9uJ3Qgd2FudCB0aGUgdXJsCgkJCS8vIGZvciB0aGUgZGlhbG9nIGNvbnRlbnQgdG8gYmUgdXNlZCBpbiB0aGUgaGFzaC4gSW5zdGVhZCwgd2Ugd2FudAoJCQkvLyB0byBhcHBlbmQgdGhlIGRpYWxvZ0hhc2hLZXkgdG8gdGhlIHVybCBvZiB0aGUgY3VycmVudCBwYWdlLgoJCQlpZiAoIGlzRGlhbG9nICYmIGFjdGl2ZSApIHsKCQkJCS8vIG9uIHRoZSBpbml0aWFsIHBhZ2UgbG9hZCBhY3RpdmUudXJsIGlzIHVuZGVmaW5lZCBhbmQgaW4gdGhhdCBjYXNlCgkJCQkvLyBzaG91bGQgYmUgYW4gZW1wdHkgc3RyaW5nLiBNb3ZpbmcgdGhlIHVuZGVmaW5lZCAtPiBlbXB0eSBzdHJpbmcgYmFjawoJCQkJLy8gaW50byB1cmxIaXN0b3J5LmFkZE5ldyBzZWVtZWQgaW1wcnVkZW50IGdpdmVuIHVuZGVmaW5lZCBiZXR0ZXIKCQkJCS8vIHJlcHJlc2VudHMgdGhlIHVybCBzdGF0ZQoKCQkJCS8vIElmIHdlIGFyZSBhdCBhIHBsYWNlIGluIGhpc3RvcnkgdGhhdCBvbmNlIGJlbG9uZ2VkIHRvIGEgZGlhbG9nLCByZXVzZQoJCQkJLy8gdGhpcyBzdGF0ZSB3aXRob3V0IGFkZGluZyB0byB1cmxIaXN0b3J5IGFuZCB3aXRob3V0IG1vZGlmeWluZyB0aGUKCQkJCS8vIGhhc2guIEhvd2V2ZXIsIGlmIGEgZGlhbG9nIGlzIGFscmVhZHkgZGlzcGxheWVkIGF0IHRoaXMgcG9pbnQsIGFuZAoJCQkJLy8gd2UncmUgYWJvdXQgdG8gZGlzcGxheSBhbm90aGVyIGRpYWxvZywgdGhlbiB3ZSBtdXN0IGFkZCBhbm90aGVyIGhhc2gKCQkJCS8vIGFuZCBoaXN0b3J5IGVudHJ5IG9uIHRvcCBzbyB0aGF0IG9uZSBtYXkgbmF2aWdhdGUgYmFjayB0byB0aGUKCQkJCS8vIG9yaWdpbmFsIGRpYWxvZwoJCQkJaWYgKCBhY3RpdmUudXJsICYmCgkJCQkJYWN0aXZlLnVybC5pbmRleE9mKCAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5ICkgPiAtMSAmJgoJCQkJCXRoaXMuYWN0aXZlUGFnZSAmJgoJCQkJCSF0aGlzLmFjdGl2ZVBhZ2UuaGFzQ2xhc3MoICJ1aS1kaWFsb2ciICkgJiYKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCApIHsKCgkJCQkJc2V0dGluZ3MuY2hhbmdlSGFzaCA9IGZhbHNlOwoJCQkJCWFscmVhZHlUaGVyZSA9IHRydWU7CgkJCQl9CgoJCQkJLy8gTm9ybWFsbHksIHdlIHRhY2sgb24gYSBkaWFsb2cgaGFzaCBrZXksIGJ1dCBpZiB0aGlzIGlzIHRoZSBsb2NhdGlvbgoJCQkJLy8gb2YgYSBzdGFsZSBkaWFsb2csIHdlIHJldXNlIHRoZSBVUkwgZnJvbSB0aGUgZW50cnkKCQkJCXVybCA9ICggYWN0aXZlLnVybCB8fCAiIiApOwoKCQkJCS8vIGFjY291bnQgZm9yIGFic29sdXRlIHVybHMgaW5zdGVhZCBvZiBqdXN0IHJlbGF0aXZlIHVybHMgdXNlIGFzIGhhc2hlcwoJCQkJaWYgKCAhYWxyZWFkeVRoZXJlICYmIHVybC5pbmRleE9mKCIjIikgPiAtMSApIHsKCQkJCQl1cmwgKz0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleTsKCQkJCX0gZWxzZSB7CgkJCQkJdXJsICs9ICIjIiArICQubW9iaWxlLmRpYWxvZ0hhc2hLZXk7CgkJCQl9CgoJCQkJLy8gdGFjayBvbiBhbm90aGVyIGRpYWxvZ0hhc2hLZXkgaWYgdGhpcyBpcyB0aGUgc2FtZSBhcyB0aGUgaW5pdGlhbCBoYXNoCgkJCQkvLyB0aGlzIG1ha2VzIHN1cmUgdGhhdCBhIGhpc3RvcnkgZW50cnkgaXMgY3JlYXRlZCBmb3IgdGhpcyBkaWFsb2cKCQkJCWlmICggJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCAmJiB1cmwgPT09ICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuaW5pdGlhbERzdCApIHsKCQkJCQl1cmwgKz0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleTsKCQkJCX0KCQkJfQoKCQkJLy8gaWYgdGl0bGUgZWxlbWVudCB3YXNuJ3QgZm91bmQsIHRyeSB0aGUgcGFnZSBkaXYgZGF0YSBhdHRyIHRvbwoJCQkvLyBJZiB0aGlzIGlzIGEgZGVlcC1saW5rIG9yIGEgcmVsb2FkICggYWN0aXZlID09PSB1bmRlZmluZWQgKSB0aGVuIGp1c3QKCQkJLy8gdXNlIHBhZ2VUaXRsZQoJCQluZXdQYWdlVGl0bGUgPSAoICFhY3RpdmUgKSA/IHBhZ2VUaXRsZSA6IHRvUGFnZS5qcW1EYXRhKCAidGl0bGUiICkgfHwKCQkJCXRvUGFnZS5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLmZpbmQoICIudWktdGl0bGUiICkudGV4dCgpOwoJCQlpZiAoICEhbmV3UGFnZVRpdGxlICYmIHBhZ2VUaXRsZSA9PT0gZG9jdW1lbnQudGl0bGUgKSB7CgkJCQlwYWdlVGl0bGUgPSBuZXdQYWdlVGl0bGU7CgkJCX0KCQkJaWYgKCAhdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJCXRvUGFnZS5qcW1EYXRhKCAidGl0bGUiLCBwYWdlVGl0bGUgKTsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSB0cmFuc2l0aW9uIGRlZmluZWQuCgkJCXNldHRpbmdzLnRyYW5zaXRpb24gPSBzZXR0aW5ncy50cmFuc2l0aW9uIHx8CgkJCQkoICggaGlzdG9yeURpciAmJiAhYWN0aXZlSXNJbml0aWFsUGFnZSApID8gYWN0aXZlLnRyYW5zaXRpb24gOiB1bmRlZmluZWQgKSB8fAoJCQkJKCBpc0RpYWxvZyA/ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uIDogJC5tb2JpbGUuZGVmYXVsdFBhZ2VUcmFuc2l0aW9uICk7CgoJCQkvL2FkZCBwYWdlIHRvIGhpc3Rvcnkgc3RhY2sgaWYgaXQncyBub3QgYmFjayBvciBmb3J3YXJkCgkJCWlmICggIWhpc3RvcnlEaXIgJiYgYWxyZWFkeVRoZXJlICkgewoJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5nZXRBY3RpdmUoKS5wYWdlVXJsID0gcGFnZVVybDsKCQkJfQoKCQkJLy8gU2V0IHRoZSBsb2NhdGlvbiBoYXNoLgoJCQlpZiAoIHVybCAmJiAhc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgoJCQkJLy8gcmVidWlsZGluZyB0aGUgaGFzaCBoZXJlIHNpbmNlIHdlIGxvb3NlIGl0IGVhcmxpZXIgb24KCQkJCS8vIFRPRE8gcHJlc2VydmUgdGhlIG9yaWdpbmFsbHkgcGFzc2VkIGluIHBhdGgKCQkJCWlmICggISQubW9iaWxlLnBhdGguaXNQYXRoKCB1cmwgKSAmJiB1cmwuaW5kZXhPZiggIiMiICkgPCAwICkgewoJCQkJCXVybCA9ICIjIiArIHVybDsKCQkJCX0KCgkJCQkvLyBUT0RPIHRoZSBwcm9wZXJ0eSBuYW1lcyBoZXJlIGFyZSBqdXN0IHNpbGx5CgkJCQlwYXJhbXMgPSB7CgkJCQkJdHJhbnNpdGlvbjogc2V0dGluZ3MudHJhbnNpdGlvbiwKCQkJCQl0aXRsZTogcGFnZVRpdGxlLAoJCQkJCXBhZ2VVcmw6IHBhZ2VVcmwsCgkJCQkJcm9sZTogc2V0dGluZ3Mucm9sZQoJCQkJfTsKCgkJCQlpZiAoIHNldHRpbmdzLmNoYW5nZUhhc2ggIT09IGZhbHNlICYmICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICkgewoJCQkJCSQubW9iaWxlLm5hdmlnYXRlKCB1cmwsIHBhcmFtcywgdHJ1ZSk7CgkJCQl9IGVsc2UgaWYgKCB0b1BhZ2VbIDAgXSAhPT0gJC5tb2JpbGUuZmlyc3RQYWdlWyAwIF0gKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hZGQoIHVybCwgcGFyYW1zICk7CgkJCQl9CgkJCX0KCgkJCS8vc2V0IHBhZ2UgdGl0bGUKCQkJZG9jdW1lbnQudGl0bGUgPSBwYWdlVGl0bGU7CgoJCQkvL3NldCAidG9QYWdlIiBhcyBhY3RpdmVQYWdlIGRlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQkJJC5tb2JpbGUuYWN0aXZlUGFnZSA9IHRvUGFnZTsKCgkJCS8vbmV3IHdheSB0byBoYW5kbGUgYWN0aXZlUGFnZQoJCQl0aGlzLmFjdGl2ZVBhZ2UgPSB0b1BhZ2U7CgoJCQkvLyBJZiB3ZSdyZSBuYXZpZ2F0aW5nIGJhY2sgaW4gdGhlIFVSTCBoaXN0b3J5LCBzZXQgcmV2ZXJzZSBhY2NvcmRpbmdseS4KCQkJc2V0dGluZ3MucmV2ZXJzZSA9IHNldHRpbmdzLnJldmVyc2UgfHwgaGlzdG9yeURpciA8IDA7CgoJCQljc3NUcmFuc2l0aW9uRGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgoJCQl0aGlzLl9jc3NUcmFuc2l0aW9uKHRvUGFnZSwgZnJvbVBhZ2UsIHsKCQkJCXRyYW5zaXRpb246IHNldHRpbmdzLnRyYW5zaXRpb24sCgkJCQlyZXZlcnNlOiBzZXR0aW5ncy5yZXZlcnNlLAoJCQkJZGVmZXJyZWQ6IGNzc1RyYW5zaXRpb25EZWZlcnJlZAoJCQl9KTsKCgkJCWNzc1RyYW5zaXRpb25EZWZlcnJlZC5kb25lKCQucHJveHkoZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20sIGFscmVhZHlGb2N1c2VkICkgewoJCQkJJC5tb2JpbGUucmVtb3ZlQWN0aXZlTGlua0NsYXNzKCk7CgoJCQkJLy9pZiB0aGVyZSdzIGEgZHVwbGljYXRlQ2FjaGVkUGFnZSwgcmVtb3ZlIGl0IGZyb20gdGhlIERPTSBub3cgdGhhdCBpdCdzIGhpZGRlbgoJCQkJaWYgKCBzZXR0aW5ncy5kdXBsaWNhdGVDYWNoZWRQYWdlICkgewoJCQkJCXNldHRpbmdzLmR1cGxpY2F0ZUNhY2hlZFBhZ2UucmVtb3ZlKCk7CgkJCQl9CgoJCQkJLy8gZGVzcGl0ZSB2aXNpYmlsaXR5OiBoaWRkZW4gYWRkcmVzc2VzIGlzc3VlICMyOTY1CgkJCQkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzI5NjUKCQkJCWlmICggIWFscmVhZHlGb2N1c2VkICkgewoJCQkJCSQubW9iaWxlLmZvY3VzUGFnZSggdG9QYWdlICk7CgkJCQl9CgoJCQkJdGhpcy5fcmVsZWFzZVRyYW5zaXRpb25Mb2NrKCk7CgkJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoJCQkJdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAidHJhbnNpdGlvbiIsIHRyaWdnZXJEYXRhICk7CgkJCX0sIHRoaXMpKTsKCQl9LAoKCQkvLyBkZXRlcm1pbmUgdGhlIGN1cnJlbnQgYmFzZSB1cmwKCQlfZmluZEJhc2VXaXRoRGVmYXVsdDogZnVuY3Rpb24oKSB7CgkJCXZhciBjbG9zZXN0QmFzZSA9ICggdGhpcy5hY3RpdmVQYWdlICYmCgkJCSQubW9iaWxlLmdldENsb3Nlc3RCYXNlVXJsKCB0aGlzLmFjdGl2ZVBhZ2UgKSApOwoJCXJldHVybiBjbG9zZXN0QmFzZSB8fCAkLm1vYmlsZS5wYXRoLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoOwoJCX0KCX0pOwoKCS8vIFRoZSBmb2xsb3dpbmcgaGFuZGxlcnMgc2hvdWxkIGJlIGJvdW5kIGFmdGVyIG1vYmlsZWluaXQgaGFzIGJlZW4gdHJpZ2dlcmVkCgkvLyB0aGUgZm9sbG93aW5nIGRlZmVycmVkIGlzIHJlc29sdmVkIGluIHRoZSBpbml0IGZpbGUKCSQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgoJLy90aGVzZSB2YXJpYWJsZXMgbWFrZSBhbGwgcGFnZSBjb250YWluZXJzIHVzZSB0aGUgc2FtZSBxdWV1ZSBhbmQgb25seSBuYXZpZ2F0ZSBvbmUgYXQgYSB0aW1lCgkvLyBxdWV1ZSB0byBob2xkIHNpbXVsdGFuaW91cyBwYWdlIHRyYW5zaXRpb25zCgl2YXIgcGFnZVRyYW5zaXRpb25RdWV1ZSA9IFtdLAoKCQkvLyBpbmRpY2F0ZXMgd2hldGhlciBvciBub3QgcGFnZSBpcyBpbiBwcm9jZXNzIG9mIHRyYW5zaXRpb25pbmcKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkJLy8gcmVzb2x2ZWQgb24gZG9tcmVhZHkKCXZhciBkb21yZWFkeURlZmVycmVkID0gJC5EZWZlcnJlZCgpLAoJCWRvY3VtZW50VXJsID0gJC5tb2JpbGUucGF0aC5kb2N1bWVudFVybCwKCgkJLy8gdXNlZCB0byB0cmFjayBsYXN0IHZjbGlja2VkIGVsZW1lbnQgdG8gbWFrZSBzdXJlIGl0cyB2YWx1ZSBpcyBhZGRlZCB0byBmb3JtIGRhdGEKCQkkbGFzdFZDbGlja2VkID0gbnVsbDsKCgkvKiBFdmVudCBCaW5kaW5ncyAtIGhhc2hjaGFuZ2UsIHN1Ym1pdCwgYW5kIGNsaWNrICovCglmdW5jdGlvbiBmaW5kQ2xvc2VzdExpbmsoIGVsZSApCXsKCQl3aGlsZSAoIGVsZSApIHsKCQkJLy8gTG9vayBmb3IgdGhlIGNsb3Nlc3QgZWxlbWVudCB3aXRoIGEgbm9kZU5hbWUgb2YgImEiLgoJCQkvLyBOb3RlIHRoYXQgd2UgYXJlIGNoZWNraW5nIGlmIHdlIGhhdmUgYSB2YWxpZCBub2RlTmFtZQoJCQkvLyBiZWZvcmUgYXR0ZW1wdGluZyB0byBhY2Nlc3MgaXQuIFRoaXMgaXMgYmVjYXVzZSB0aGUKCQkJLy8gbm9kZSB3ZSBnZXQgY2FsbGVkIHdpdGggY291bGQgaGF2ZSBvcmlnaW5hdGVkIGZyb20gd2l0aGluCgkJCS8vIGFuIGVtYmVkZGVkIFNWRyBkb2N1bWVudCB3aGVyZSBzb21lIHN5bWJvbCBpbnN0YW5jZSBlbGVtZW50cwoJCQkvLyBkb24ndCBoYXZlIG5vZGVOYW1lIGRlZmluZWQgb24gdGhlbSwgb3Igc3RyaW5ncyBhcmUgb2YgdHlwZQoJCQkvLyBTVkdBbmltYXRlZFN0cmluZy4KCQkJaWYgKCAoIHR5cGVvZiBlbGUubm9kZU5hbWUgPT09ICJzdHJpbmciICkgJiYgZWxlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJhIiApIHsKCQkJCWJyZWFrOwoJCQl9CgkJCWVsZSA9IGVsZS5wYXJlbnROb2RlOwoJCX0KCQlyZXR1cm4gZWxlOwoJfQoKCSQubW9iaWxlLmxvYWRQYWdlID0gZnVuY3Rpb24oIHVybCwgb3B0cyApIHsKCQl2YXIgY29udGFpbmVyOwoKCQlvcHRzID0gb3B0cyB8fCB7fTsKCQljb250YWluZXIgPSAoIG9wdHMucGFnZUNvbnRhaW5lciB8fCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCS8vIGNyZWF0ZSB0aGUgZGVmZXJyZWQgdGhhdCB3aWxsIGJlIHN1cHBsaWVkIHRvIGxvYWRQYWdlIGNhbGxlcnMKCQkvLyBhbmQgcmVzb2x2ZWQgYnkgdGhlIGNvbnRlbnQgd2lkZ2V0J3MgbG9hZCBtZXRob2QKCQlvcHRzLmRlZmVycmVkID0gJC5EZWZlcnJlZCgpOwoKCQkvLyBQcmVmZXJyaW5nIHRvIGFsbG93IGV4Y2VwdGlvbnMgZm9yIHVuaW5pdGlhbGl6ZWQgb3B0cy5wYWdlQ29udGFpbmVyCgkJLy8gd2lkZ2V0cyBzbyB3ZSBrbm93IGlmIHdlIG5lZWQgdG8gZm9yY2UgaW5pdCBoZXJlIGZvciB1c2VycwoJCWNvbnRhaW5lci5wYWdlY29udGFpbmVyKCAibG9hZCIsIHVybCwgb3B0cyApOwoKCQkvLyBwcm92aWRlIHRoZSBkZWZlcnJlZAoJCXJldHVybiBvcHRzLmRlZmVycmVkLnByb21pc2UoKTsKCX07CgoJLy9kZWZpbmUgdmFycyBmb3IgaW50ZXJhbCB1c2UKCgkvKiBpbnRlcm5hbCB1dGlsaXR5IGZ1bmN0aW9ucyAqLwoKCS8vIE5PVEUgSXNzdWUgIzQ5NTAgQW5kcm9pZCBwaG9uZWdhcCBkb2Vzbid0IG5hdmlnYXRlIGJhY2sgcHJvcGVybHkKCS8vICAgICAgd2hlbiBhIGZ1bGwgcGFnZSByZWZyZXNoIGhhcyB0YWtlbiBwbGFjZS4gSXQgYXBwZWFycyB0aGF0IGhhc2hjaGFuZ2UKCS8vICAgICAgYW5kIHJlcGxhY2VzdGF0ZSBoaXN0b3J5IGFsdGVyYXRpb25zIHdvcmsgZmluZSBidXQgd2UgbmVlZCB0byBzdXBwb3J0CgkvLyAgICAgIGJvdGggZm9ybXMgb2YgaGlzdG9yeSB0cmF2ZXJzYWwgaW4gb3VyIGNvZGUgdGhhdCB1c2VzIGJhY2t3YXJkIGhpc3RvcnkKCS8vICAgICAgbW92ZW1lbnQKCSQubW9iaWxlLmJhY2sgPSBmdW5jdGlvbigpIHsKCQl2YXIgbmF2ID0gd2luZG93Lm5hdmlnYXRvcjsKCgkJLy8gaWYgdGhlIHNldHRpbmcgaXMgb24gYW5kIHRoZSBuYXZpZ2F0b3Igb2JqZWN0IGlzCgkJLy8gYXZhaWxhYmxlIHVzZSB0aGUgcGhvbmVnYXAgbmF2aWdhdGlvbiBjYXBhYmlsaXR5CgkJaWYgKCB0aGlzLnBob25lZ2FwTmF2aWdhdGlvbkVuYWJsZWQgJiYKCQkJbmF2ICYmCgkJCW5hdi5hcHAgJiYKCQkJbmF2LmFwcC5iYWNrSGlzdG9yeSApIHsKCQkJbmF2LmFwcC5iYWNrSGlzdG9yeSgpOwoJCX0gZWxzZSB7CgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIucGFnZWNvbnRhaW5lciggImJhY2siICk7CgkJfQoJfTsKCgkvL2RpcmVjdCBmb2N1cyB0byB0aGUgcGFnZSB0aXRsZSwgb3Igb3RoZXJ3aXNlIGZpcnN0IGZvY3VzYWJsZSBlbGVtZW50CgkkLm1vYmlsZS5mb2N1c1BhZ2UgPSBmdW5jdGlvbiAoIHBhZ2UgKSB7CgkJdmFyIGF1dG9mb2N1cyA9IHBhZ2UuZmluZCggIlthdXRvZm9jdXNdIiApLAoJCQlwYWdlVGl0bGUgPSBwYWdlLmZpbmQoICIudWktdGl0bGU6ZXEoMCkiICk7CgoJCWlmICggYXV0b2ZvY3VzLmxlbmd0aCApIHsKCQkJYXV0b2ZvY3VzLmZvY3VzKCk7CgkJCXJldHVybjsKCQl9CgoJCWlmICggcGFnZVRpdGxlLmxlbmd0aCApIHsKCQkJcGFnZVRpdGxlLmZvY3VzKCk7CgkJfSBlbHNlewoJCQlwYWdlLmZvY3VzKCk7CgkJfQoJfTsKCgkvLyBOby1vcCBpbXBsZW1lbnRhdGlvbiBvZiB0cmFuc2l0aW9uIGRlZ3JhZGF0aW9uCgkkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uIHx8IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCXJldHVybiB0cmFuc2l0aW9uOwoJfTsKCgkvKiBleHBvc2VkICQubW9iaWxlIG1ldGhvZHMgKi8KCgkvL2FuaW1hdGlvbiBjb21wbGV0ZSBjYWxsYmFjawoJJC5mbi5hbmltYXRpb25Db21wbGV0ZSA9IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2l0aW9ucyApIHsKCQkJcmV0dXJuICQoIHRoaXMgKS5vbmUoICJ3ZWJraXRBbmltYXRpb25FbmQgYW5pbWF0aW9uZW5kIiwgY2FsbGJhY2sgKTsKCQl9CgkJZWxzZXsKCQkJLy8gZGVmZXIgZXhlY3V0aW9uIGZvciBjb25zaXN0ZW5jeSBiZXR3ZWVuIHdlYmtpdC9ub24gd2Via2l0CgkJCXNldFRpbWVvdXQoIGNhbGxiYWNrLCAwICk7CgkJCXJldHVybiAkKCB0aGlzICk7CgkJfQoJfTsKCgkkLm1vYmlsZS5jaGFuZ2VQYWdlID0gZnVuY3Rpb24oIHRvLCBvcHRpb25zICkgewoJCSQubW9iaWxlLnBhZ2VDb250YWluZXIucGFnZWNvbnRhaW5lciggImNoYW5nZSIsIHRvLCBvcHRpb25zICk7Cgl9OwoKCSQubW9iaWxlLmNoYW5nZVBhZ2UuZGVmYXVsdHMgPSB7CgkJdHJhbnNpdGlvbjogdW5kZWZpbmVkLAoJCXJldmVyc2U6IGZhbHNlLAoJCWNoYW5nZUhhc2g6IHRydWUsCgkJZnJvbUhhc2hDaGFuZ2U6IGZhbHNlLAoJCXJvbGU6IHVuZGVmaW5lZCwgLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCWR1cGxpY2F0ZUNhY2hlZFBhZ2U6IHVuZGVmaW5lZCwKCQlwYWdlQ29udGFpbmVyOiB1bmRlZmluZWQsCgkJc2hvd0xvYWRNc2c6IHRydWUsIC8vbG9hZGluZyBtZXNzYWdlIHNob3dzIGJ5IGRlZmF1bHQgd2hlbiBwYWdlcyBhcmUgYmVpbmcgZmV0Y2hlZCBkdXJpbmcgY2hhbmdlUGFnZQoJCWRhdGFVcmw6IHVuZGVmaW5lZCwKCQlmcm9tUGFnZTogdW5kZWZpbmVkLAoJCWFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uOiBmYWxzZQoJfTsKCgkkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cyA9IGZ1bmN0aW9uKCkgewoJCXZhciBnZXRBamF4Rm9ybURhdGEgPSBmdW5jdGlvbiggJGZvcm0sIGNhbGN1bGF0ZU9ubHkgKSB7CgkJCXZhciB1cmwsIHJldCA9IHRydWUsIGZvcm1EYXRhLCB2Y2xpY2tlZE5hbWUsIG1ldGhvZDsKCQkJaWYgKCAhJC5tb2JpbGUuYWpheEVuYWJsZWQgfHwKCQkJCQkvLyB0ZXN0IHRoYXQgdGhlIGZvcm0gaXMsIGl0c2VsZiwgYWpheCBmYWxzZQoJCQkJCSRmb3JtLmlzKCAiOmpxbURhdGEoYWpheD0nZmFsc2UnKSIgKSB8fAoJCQkJCS8vIHRlc3QgdGhhdCAkLm1vYmlsZS5pZ25vcmVDb250ZW50RW5hYmxlZCBpcyBzZXQgYW5kCgkJCQkJLy8gdGhlIGZvcm0gb3Igb25lIG9mIGl0J3MgcGFyZW50cyBpcyBhamF4PWZhbHNlCgkJCQkJISRmb3JtLmpxbUhpamFja2FibGUoKS5sZW5ndGggfHwKCQkJCQkkZm9ybS5hdHRyKCAidGFyZ2V0IiApICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl1cmwgPSAoICRsYXN0VkNsaWNrZWQgJiYgJGxhc3RWQ2xpY2tlZC5hdHRyKCAiZm9ybWFjdGlvbiIgKSApIHx8CgkJCQkkZm9ybS5hdHRyKCAiYWN0aW9uIiApOwoJCQltZXRob2QgPSAoICRmb3JtLmF0dHIoICJtZXRob2QiICkgfHwgImdldCIgKS50b0xvd2VyQ2FzZSgpOwoKCQkJLy8gSWYgbm8gYWN0aW9uIGlzIHNwZWNpZmllZCwgYnJvd3NlcnMgZGVmYXVsdCB0byB1c2luZyB0aGUKCQkJLy8gVVJMIG9mIHRoZSBkb2N1bWVudCBjb250YWluaW5nIHRoZSBmb3JtLiBTaW5jZSB3ZSBkeW5hbWljYWxseQoJCQkvLyBwdWxsIGluIHBhZ2VzIGZyb20gZXh0ZXJuYWwgZG9jdW1lbnRzLCB0aGUgZm9ybSBzaG91bGQgc3VibWl0CgkJCS8vIHRvIHRoZSBVUkwgZm9yIHRoZSBzb3VyY2UgZG9jdW1lbnQgb2YgdGhlIHBhZ2UgY29udGFpbmluZwoJCQkvLyB0aGUgZm9ybS4KCQkJaWYgKCAhdXJsICkgewoJCQkJLy8gR2V0IHRoZSBAZGF0YS11cmwgZm9yIHRoZSBwYWdlIGNvbnRhaW5pbmcgdGhlIGZvcm0uCgkJCQl1cmwgPSAkLm1vYmlsZS5nZXRDbG9zZXN0QmFzZVVybCggJGZvcm0gKTsKCgkJCQkvLyBOT1RFOiBJZiB0aGUgbWV0aG9kIGlzICJnZXQiLCB3ZSBuZWVkIHRvIHN0cmlwIG9mZiB0aGUgcXVlcnkgc3RyaW5nCgkJCQkvLyBiZWNhdXNlIGl0IHdpbGwgZ2V0IHJlcGxhY2VkIHdpdGggdGhlIG5ldyBmb3JtIGRhdGEuIFNlZSBpc3N1ZSAjNTcxMC4KCQkJCWlmICggbWV0aG9kID09PSAiZ2V0IiApIHsKCQkJCQl1cmwgPSAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCB1cmwgKS5ocmVmTm9TZWFyY2g7CgkJCQl9CgoJCQkJaWYgKCB1cmwgPT09ICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSB7CgkJCQkJLy8gVGhlIHVybCB3ZSBnb3QgYmFjayBtYXRjaGVzIHRoZSBkb2N1bWVudCBiYXNlLAoJCQkJCS8vIHdoaWNoIG1lYW5zIHRoZSBwYWdlIG11c3QgYmUgYW4gaW50ZXJuYWwvZW1iZWRkZWQgcGFnZSwKCQkJCQkvLyBzbyBkZWZhdWx0IHRvIHVzaW5nIHRoZSBhY3R1YWwgZG9jdW1lbnQgdXJsIGFzIGEgYnJvd3NlcgoJCQkJCS8vIHdvdWxkLgoJCQkJCXVybCA9IGRvY3VtZW50VXJsLmhyZWZOb1NlYXJjaDsKCQkJCX0KCQkJfQoKCQkJdXJsID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICB1cmwsICQubW9iaWxlLmdldENsb3Nlc3RCYXNlVXJsKCAkZm9ybSApICk7CgoJCQlpZiAoICggJC5tb2JpbGUucGF0aC5pc0V4dGVybmFsKCB1cmwgKSAmJiAhJC5tb2JpbGUucGF0aC5pc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdCggZG9jdW1lbnRVcmwsIHVybCApICkgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCWlmICggIWNhbGN1bGF0ZU9ubHkgKSB7CgkJCQlmb3JtRGF0YSA9ICRmb3JtLnNlcmlhbGl6ZUFycmF5KCk7CgoJCQkJaWYgKCAkbGFzdFZDbGlja2VkICYmICRsYXN0VkNsaWNrZWRbIDAgXS5mb3JtID09PSAkZm9ybVsgMCBdICkgewoJCQkJCXZjbGlja2VkTmFtZSA9ICRsYXN0VkNsaWNrZWQuYXR0ciggIm5hbWUiICk7CgkJCQkJaWYgKCB2Y2xpY2tlZE5hbWUgKSB7CgkJCQkJCS8vIE1ha2Ugc3VyZSB0aGUgbGFzdCBjbGlja2VkIGVsZW1lbnQgaXMgaW5jbHVkZWQgaW4gdGhlIGZvcm0KCQkJCQkJJC5lYWNoKCBmb3JtRGF0YSwgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCQkJCQlpZiAoIHZhbHVlLm5hbWUgPT09IHZjbGlja2VkTmFtZSApIHsKCQkJCQkJCQkvLyBVbnNldCB2Y2xpY2tlZE5hbWUgLSB3ZSd2ZSBmb3VuZCBpdCBpbiB0aGUgc2VyaWFsaXplZCBkYXRhIGFscmVhZHkKCQkJCQkJCQl2Y2xpY2tlZE5hbWUgPSAiIjsKCQkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQl9CgkJCQkJCX0pOwoJCQkJCQlpZiAoIHZjbGlja2VkTmFtZSApIHsKCQkJCQkJCWZvcm1EYXRhLnB1c2goIHsgbmFtZTogdmNsaWNrZWROYW1lLCB2YWx1ZTogJGxhc3RWQ2xpY2tlZC5hdHRyKCAidmFsdWUiICkgfSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoKCQkJCXJldCA9IHsKCQkJCQl1cmw6IHVybCwKCQkJCQlvcHRpb25zOiB7CgkJCQkJCXR5cGU6CQltZXRob2QsCgkJCQkJCWRhdGE6CQkkLnBhcmFtKCBmb3JtRGF0YSApLAoJCQkJCQl0cmFuc2l0aW9uOgkkZm9ybS5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJCQkJcmV2ZXJzZToJJGZvcm0uanFtRGF0YSggImRpcmVjdGlvbiIgKSA9PT0gInJldmVyc2UiLAoJCQkJCQlyZWxvYWRQYWdlOgl0cnVlCgkJCQkJfQoJCQkJfTsKCQkJfQoKCQkJcmV0dXJuIHJldDsKCQl9OwoKCQkvL2JpbmQgdG8gZm9ybSBzdWJtaXQgZXZlbnRzLCBoYW5kbGUgd2l0aCBBamF4CgkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICJmb3JtIiwgInN1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZvcm1EYXRhOwoKCQkJaWYgKCAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlmb3JtRGF0YSA9IGdldEFqYXhGb3JtRGF0YSggJCggdGhpcyApICk7CgkJCQlpZiAoIGZvcm1EYXRhICkgewoJCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGZvcm1EYXRhLnVybCwgZm9ybURhdGEub3B0aW9ucyApOwoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0KCQl9KTsKCgkJLy9hZGQgYWN0aXZlIHN0YXRlIG9uIHZjbGljawoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciAkYnRuLCBidG5FbHMsIHRhcmdldCA9IGV2ZW50LnRhcmdldCwgbmVlZENsb3Nlc3QgPSBmYWxzZTsKCQkJLy8gaWYgdGhpcyBpc24ndCBhIGxlZnQgY2xpY2sgd2UgZG9uJ3QgY2FyZS4gSXRzIGltcG9ydGFudCB0byBub3RlCgkJCS8vIHRoYXQgd2hlbiB0aGUgdmlydHVhbCBldmVudCBpcyBnZW5lcmF0ZWQgaXQgd2lsbCBjcmVhdGUgdGhlIHdoaWNoIGF0dHIKCQkJaWYgKCBldmVudC53aGljaCA+IDEgfHwgISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gUmVjb3JkIHRoYXQgdGhpcyBlbGVtZW50IHdhcyBjbGlja2VkLCBpbiBjYXNlIHdlIG5lZWQgaXQgZm9yIGNvcnJlY3QKCQkJLy8gZm9ybSBzdWJtaXNzaW9uIGR1cmluZyB0aGUgInN1Ym1pdCIgaGFuZGxlciBhYm92ZQoJCQkkbGFzdFZDbGlja2VkID0gJCggdGFyZ2V0ICk7CgoJCQkvLyBUcnkgdG8gZmluZCBhIHRhcmdldCBlbGVtZW50IHRvIHdoaWNoIHRoZSBhY3RpdmUgY2xhc3Mgd2lsbCBiZSBhcHBsaWVkCgkJCWlmICggJC5kYXRhKCB0YXJnZXQsICJtb2JpbGUtYnV0dG9uIiApICkgewoJCQkJLy8gSWYgdGhlIGZvcm0gd2lsbCBub3QgYmUgc3VibWl0dGVkIHZpYSBBSkFYLCBkbyBub3QgYWRkIGFjdGl2ZSBjbGFzcwoJCQkJaWYgKCAhZ2V0QWpheEZvcm1EYXRhKCAkKCB0YXJnZXQgKS5jbG9zZXN0KCAiZm9ybSIgKSwgdHJ1ZSApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCS8vIFdlIHdpbGwgYXBwbHkgdGhlIGFjdGl2ZSBzdGF0ZSB0byB0aGlzIGJ1dHRvbiB3aWRnZXQgLSB0aGUgcGFyZW50CgkJCQkvLyBvZiB0aGUgaW5wdXQgdGhhdCB3YXMgY2xpY2tlZCB3aWxsIGhhdmUgdGhlIGFzc29jaWF0ZWQgZGF0YQoJCQkJaWYgKCB0YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCQl0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXRhcmdldCA9IGZpbmRDbG9zZXN0TGluayggdGFyZ2V0ICk7CgkJCQlpZiAoICEoIHRhcmdldCAmJiAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCB0YXJnZXQuZ2V0QXR0cmlidXRlKCAiaHJlZiIgKSB8fCAiIyIgKS5oYXNoICE9PSAiIyIgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUKCQkJCS8vIGxpbmsgd3JhcHBpbmcgY2FuIGJlIGF2b2lkZWQKCQkJCWlmICggISQoIHRhcmdldCApLmpxbUhpamFja2FibGUoKS5sZW5ndGggKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgoJCQkvLyBBdm9pZCBjYWxsaW5nIC5jbG9zZXN0IGJ5IHVzaW5nIHRoZSBkYXRhIHNldCBkdXJpbmcgLmJ1dHRvbk1hcmt1cCgpCgkJCS8vIExpc3QgaXRlbXMgaGF2ZSB0aGUgYnV0dG9uIGRhdGEgaW4gdGhlIHBhcmVudCBvZiB0aGUgZWxlbWVudCBjbGlja2VkCgkJCWlmICggISF+dGFyZ2V0LmNsYXNzTmFtZS5pbmRleE9mKCAidWktbGluay1pbmhlcml0IiApICkgewoJCQkJaWYgKCB0YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCQlidG5FbHMgPSAkLmRhdGEoIHRhcmdldC5wYXJlbnROb2RlLCAiYnV0dG9uRWxlbWVudHMiICk7CgkJCQl9CgkJCS8vIE90aGVyd2lzZSwgbG9vayBmb3IgdGhlIGRhdGEgb24gdGhlIHRhcmdldCBpdHNlbGYKCQkJfSBlbHNlIHsKCQkJCWJ0bkVscyA9ICQuZGF0YSggdGFyZ2V0LCAiYnV0dG9uRWxlbWVudHMiICk7CgkJCX0KCQkJLy8gSWYgZm91bmQsIGdyYWIgdGhlIGJ1dHRvbidzIG91dGVyIGVsZW1lbnQKCQkJaWYgKCBidG5FbHMgKSB7CgkJCQl0YXJnZXQgPSBidG5FbHMub3V0ZXI7CgkJCX0gZWxzZSB7CgkJCQluZWVkQ2xvc2VzdCA9IHRydWU7CgkJCX0KCgkJCSRidG4gPSAkKCB0YXJnZXQgKTsKCQkJLy8gSWYgdGhlIG91dGVyIGVsZW1lbnQgd2Fzbid0IGZvdW5kIGJ5IHRoZSBvdXIgaGV1cmlzdGljcywgdXNlIC5jbG9zZXN0KCkKCQkJaWYgKCBuZWVkQ2xvc2VzdCApIHsKCQkJCSRidG4gPSAkYnRuLmNsb3Nlc3QoICIudWktYnRuIiApOwoJCQl9CgoJCQlpZiAoICRidG4ubGVuZ3RoID4gMCAmJgoJCQkJISggJGJ0bi5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiB8fAoKCQkJCQkvLyBERVBSRUNBVEVEIGFzIG9mIDEuNC4wIC0gcmVtb3ZlIGFmdGVyIDEuNC4wIHJlbGVhc2UKCQkJCQkvLyBvbmx5IHVpLXN0YXRlLWRpc2FibGVkIHNob3VsZCBiZSBwcmVzZW50IHRoZXJlYWZ0ZXIKCQkJCQkkYnRuLmhhc0NsYXNzKCAidWktZGlzYWJsZWQiICkgKSApICkgewoJCQkJJC5tb2JpbGUucmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluayA9ICRidG47CgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluay5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfQoJCX0pOwoKCQkvLyBjbGljayByb3V0aW5nIC0gZGlyZWN0IHRvIEhUVFAgb3IgQWpheCwgYWNjb3JkaW5nbHkKCQkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWlmICggISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCB8fCBldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGxpbmsgPSBmaW5kQ2xvc2VzdExpbmsoIGV2ZW50LnRhcmdldCApLAoJCQkJJGxpbmsgPSAkKCBsaW5rICksCgoJCQkJLy9yZW1vdmUgYWN0aXZlIGxpbmsgY2xhc3MgaWYgZXh0ZXJuYWwgKHRoZW4gaXQgd29uJ3QgYmUgdGhlcmUgaWYgeW91IGNvbWUgYmFjaykKCQkJCWh0dHBDbGVhbnVwID0gZnVuY3Rpb24oKSB7CgkJCQkJd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7ICQubW9iaWxlLnJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOyB9LCAyMDAgKTsKCQkJCX0sCgkJCQliYXNlVXJsLCBocmVmLAoJCQkJdXNlRGVmYXVsdFVybEhhbmRsaW5nLCBpc0V4dGVybmFsLAoJCQkJdHJhbnNpdGlvbiwgcmV2ZXJzZSwgcm9sZTsKCgkJCS8vIElmIGEgYnV0dG9uIHdhcyBjbGlja2VkLCBjbGVhbiB1cCB0aGUgYWN0aXZlIGNsYXNzIGFkZGVkIGJ5IHZjbGljayBhYm92ZQoJCQlpZiAoICQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rICYmCgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGlua1sgMCBdID09PSBldmVudC50YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCWh0dHBDbGVhbnVwKCk7CgkJCX0KCgkJCS8vIElmIHRoZXJlIGlzIG5vIGxpbmsgYXNzb2NpYXRlZCB3aXRoIHRoZSBjbGljayBvciBpdHMgbm90IGEgbGVmdAoJCQkvLyBjbGljayB3ZSB3YW50IHRvIGlnbm9yZSB0aGUgY2xpY2sKCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUgbGluayB3cmFwcGluZwoJCQkvLyBjYW4gYmUgYXZvaWRlZAoJCQlpZiAoICFsaW5rIHx8IGV2ZW50LndoaWNoID4gMSB8fCAhJGxpbmsuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy9pZiB0aGVyZSdzIGEgZGF0YS1yZWw9YmFjayBhdHRyLCBnbyBiYWNrIGluIGhpc3RvcnkKCQkJaWYgKCAkbGluay5pcyggIjpqcW1EYXRhKHJlbD0nYmFjaycpIiApICkgewoJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQliYXNlVXJsID0gJC5tb2JpbGUuZ2V0Q2xvc2VzdEJhc2VVcmwoICRsaW5rICk7CgoJCQkvL2dldCBocmVmLCBpZiBkZWZpbmVkLCBvdGhlcndpc2UgZGVmYXVsdCB0byBlbXB0eSBoYXNoCgkJCWhyZWYgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGxpbmsuYXR0ciggImhyZWYiICkgfHwgIiMiLCBiYXNlVXJsICk7CgoJCQkvL2lmIGFqYXggaXMgZGlzYWJsZWQsIGV4aXQgZWFybHkKCQkJaWYgKCAhJC5tb2JpbGUuYWpheEVuYWJsZWQgJiYgISQubW9iaWxlLnBhdGguaXNFbWJlZGRlZFBhZ2UoIGhyZWYgKSApIHsKCQkJCWh0dHBDbGVhbnVwKCk7CgkJCQkvL3VzZSBkZWZhdWx0IGNsaWNrIGhhbmRsaW5nCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFhYWF9qYmxhczogSWRlYWxseSBsaW5rcyB0byBhcHBsaWNhdGlvbiBwYWdlcyBzaG91bGQgYmUgc3BlY2lmaWVkIGFzCgkJCS8vICAgICAgICAgICAgYW4gdXJsIHRvIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudCB3aXRoIGEgaGFzaCB0aGF0IGlzIGVpdGhlcgoJCQkvLyAgICAgICAgICAgIHRoZSBzaXRlIHJlbGF0aXZlIHBhdGggb3IgaWQgdG8gdGhlIHBhZ2UuIEJ1dCBzb21lIG9mIHRoZQoJCQkvLyAgICAgICAgICAgIGludGVybmFsIGNvZGUgdGhhdCBkeW5hbWljYWxseSBnZW5lcmF0ZXMgc3ViLXBhZ2VzIGZvciBuZXN0ZWQKCQkJLy8gICAgICAgICAgICBsaXN0cyBhbmQgc2VsZWN0IGRpYWxvZ3MsIGp1c3Qgd3JpdGUgYSBoYXNoIGluIHRoZSBsaW5rIHRoZXkKCQkJLy8gICAgICAgICAgICBjcmVhdGUuIFRoaXMgbWVhbnMgdGhlIGFjdHVhbCBVUkwgcGF0aCBpcyBiYXNlZCBvbiB3aGF0ZXZlcgoJCQkvLyAgICAgICAgICAgIHRoZSBjdXJyZW50IHZhbHVlIG9mIHRoZSBiYXNlIHRhZyBpcyBhdCB0aGUgdGltZSB0aGlzIGNvZGUKCQkJLy8gICAgICAgICAgICBpcyBjYWxsZWQuIEZvciBub3cgd2UgYXJlIGp1c3QgYXNzdW1pbmcgdGhhdCBhbnkgdXJsIHdpdGggYQoJCQkvLyAgICAgICAgICAgIGhhc2ggaW4gaXQgaXMgYW4gYXBwbGljYXRpb24gcGFnZSByZWZlcmVuY2UuCgkJCWlmICggaHJlZi5zZWFyY2goICIjIiApICE9PSAtMSApIHsKCQkJCWhyZWYgPSBocmVmLnJlcGxhY2UoIC9bXiNdKiMvLCAiIiApOwoJCQkJaWYgKCAhaHJlZiApIHsKCQkJCQkvL2xpbmsgd2FzIGFuIGVtcHR5IGhhc2ggbWVhbnQgcHVyZWx5CgkJCQkJLy9mb3IgaW50ZXJhY3Rpb24sIHNvIHdlIGlnbm9yZSBpdC4KCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0gZWxzZSBpZiAoICQubW9iaWxlLnBhdGguaXNQYXRoKCBocmVmICkgKSB7CgkJCQkJLy93ZSBoYXZlIGFwYXRoIHNvIG1ha2UgaXQgdGhlIGhyZWYgd2Ugd2FudCB0byBsb2FkLgoJCQkJCWhyZWYgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgYmFzZVVybCApOwoJCQkJfSBlbHNlIHsKCQkJCQkvL3dlIGhhdmUgYSBzaW1wbGUgaWQgc28gdXNlIHRoZSBkb2N1bWVudFVybCBhcyBpdHMgYmFzZS4KCQkJCQlocmVmID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGhyZWYsIGRvY3VtZW50VXJsLmhyZWZOb0hhc2ggKTsKCQkJCX0KCQkJfQoKCQkJLy8gU2hvdWxkIHdlIGhhbmRsZSB0aGlzIGxpbmssIG9yIGxldCB0aGUgYnJvd3NlciBkZWFsIHdpdGggaXQ/CgkJCXVzZURlZmF1bHRVcmxIYW5kbGluZyA9ICRsaW5rLmlzKCAiW3JlbD0nZXh0ZXJuYWwnXSIgKSB8fCAkbGluay5pcyggIjpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiICkgfHwgJGxpbmsuaXMoICJbdGFyZ2V0XSIgKTsKCgkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cgY3Jvc3MtZG9tYWluIFhIUgoJCQkvLyByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZCB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuCgkJCS8vIFRoaXMgaXMgdXN1YWxseSB0byBhbGxvdyB0aGUgYXBwbGljYXRpb24gdG8gInBob25lIGhvbWUiIGFuZCBmZXRjaCBhcHAgc3BlY2lmaWMKCQkJLy8gZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZQoJCQkvLyBhbGxvd0Nyb3NzRG9tYWluUGFnZXMgb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMKCQkJLy8gcmVxdWVzdHMgdG8gZ28gdGhyb3VnaCBvdXIgcGFnZSBsb2FkaW5nIGxvZ2ljLgoKCQkJLy9jaGVjayBmb3IgcHJvdG9jb2wgb3IgcmVsIGFuZCBpdHMgbm90IGFuIGVtYmVkZGVkIHBhZ2UKCQkJLy9UT0RPIG92ZXJsYXAgaW4gbG9naWMgZnJvbSBpc0V4dGVybmFsLCByZWw9ZXh0ZXJuYWwgY2hlY2sgc2hvdWxkIGJlCgkJCS8vICAgICBtb3ZlZCBpbnRvIG1vcmUgY29tcHJlaGVuc2l2ZSBpc0V4dGVybmFsTGluawoJCQlpc0V4dGVybmFsID0gdXNlRGVmYXVsdFVybEhhbmRsaW5nIHx8ICggJC5tb2JpbGUucGF0aC5pc0V4dGVybmFsKCBocmVmICkgJiYgISQubW9iaWxlLnBhdGguaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3QoIGRvY3VtZW50VXJsLCBocmVmICkgKTsKCgkJCWlmICggaXNFeHRlcm5hbCApIHsKCQkJCWh0dHBDbGVhbnVwKCk7CgkJCQkvL3VzZSBkZWZhdWx0IGNsaWNrIGhhbmRsaW5nCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vdXNlIGFqYXgKCQkJdHJhbnNpdGlvbiA9ICRsaW5rLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApOwoJCQlyZXZlcnNlID0gJGxpbmsuanFtRGF0YSggImRpcmVjdGlvbiIgKSA9PT0gInJldmVyc2UiIHx8CgkJCQkJCS8vIGRlcHJlY2F0ZWQgLSByZW1vdmUgYnkgMS4wCgkJCQkJCSRsaW5rLmpxbURhdGEoICJiYWNrIiApOwoKCQkJLy90aGlzIG1heSBuZWVkIHRvIGJlIG1vcmUgc3BlY2lmaWMgYXMgd2UgdXNlIGRhdGEtcmVsIG1vcmUKCQkJcm9sZSA9ICRsaW5rLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiICkgfHwgdW5kZWZpbmVkOwoKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggaHJlZiwgeyB0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLCByZXZlcnNlOiByZXZlcnNlLCByb2xlOiByb2xlLCBsaW5rOiAkbGluayB9ICk7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfSk7CgoJCS8vcHJlZmV0Y2ggcGFnZXMgd2hlbiBhbmNob3JzIHdpdGggZGF0YS1wcmVmZXRjaCBhcmUgZW5jb3VudGVyZWQKCQkkLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggIi51aS1wYWdlIiwgInBhZ2VzaG93LnByZWZldGNoIiwgZnVuY3Rpb24oKSB7CgkJCXZhciB1cmxzID0gW107CgkJCSQoIHRoaXMgKS5maW5kKCAiYTpqcW1EYXRhKHByZWZldGNoKSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyICRsaW5rID0gJCggdGhpcyApLAoJCQkJCXVybCA9ICRsaW5rLmF0dHIoICJocmVmIiApOwoKCQkJCWlmICggdXJsICYmICQuaW5BcnJheSggdXJsLCB1cmxzICkgPT09IC0xICkgewoJCQkJCXVybHMucHVzaCggdXJsICk7CgoJCQkJCSQubW9iaWxlLmxvYWRQYWdlKCB1cmwsIHsgcm9sZTogJGxpbmsuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbCIgKSxwcmVmZXRjaDogdHJ1ZSB9ICk7CgkJCQl9CgkJCX0pOwoJCX0pOwoKCQkvLyBUT0RPIGVuc3VyZSB0aGF0IHRoZSBuYXZpZ2F0ZSBiaW5kaW5nIGluIHRoZSBjb250ZW50IHdpZGdldCBoYXBwZW5zIGF0IHRoZSByaWdodCB0aW1lCgkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5wYWdlY29udGFpbmVyKCk7CgoJCS8vc2V0IHBhZ2UgbWluLWhlaWdodHMgdG8gYmUgZGV2aWNlIHNwZWNpZmljCgkJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VzaG93IiwgJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0ICk7CgkJJC5tb2JpbGUud2luZG93LmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCAkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCgl9Oy8vbmF2cmVhZHlEZWZlcnJlZCBkb25lIGNhbGxiYWNrCgoJJCggZnVuY3Rpb24oKSB7IGRvbXJlYWR5RGVmZXJyZWQucmVzb2x2ZSgpOyB9ICk7CgoJJC53aGVuKCBkb21yZWFkeURlZmVycmVkLCAkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkICkuZG9uZSggZnVuY3Rpb24oKSB7ICQubW9iaWxlLl9yZWdpc3RlckludGVybmFsRXZlbnRzKCk7IH0gKTsKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgoJLy8gVE9ETyByZW1vdmUgZGlyZWN0IHJlZmVyZW5jZXMgdG8gJC5tb2JpbGUgYW5kIHByb3BlcnRpZXMsIHdlIHNob3VsZAoJLy8gICAgICBmYXZvciBpbmplY3Rpb24gd2l0aCBwYXJhbXMgdG8gdGhlIGNvbnN0cnVjdG9yCgkkLm1vYmlsZS5UcmFuc2l0aW9uID0gZnVuY3Rpb24oKSB7CgkJdGhpcy5pbml0LmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuVHJhbnNpdGlvbi5wcm90b3R5cGUsIHsKCQl0b1ByZUNsYXNzOiAiIHVpLXBhZ2UtcHJlLWluIiwKCgkJaW5pdDogZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20gKSB7CgkJCSQuZXh0ZW5kKHRoaXMsIHsKCQkJCW5hbWU6IG5hbWUsCgkJCQlyZXZlcnNlOiByZXZlcnNlLAoJCQkJJHRvOiAkdG8sCgkJCQkkZnJvbTogJGZyb20sCgkJCQlkZWZlcnJlZDogbmV3ICQuRGVmZXJyZWQoKQoJCQl9KTsKCQl9LAoKCQljbGVhbkZyb206IGZ1bmN0aW9uKCkgewoJCQl0aGlzLiRmcm9tCgkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArICIgb3V0IGluIHJldmVyc2UgIiArIHRoaXMubmFtZSApCgkJCQkuaGVpZ2h0KCAiIiApOwoJCX0sCgoJCS8vIE5PVEUgb3ZlcnJpZGRlbiBieSBjaGlsZCBvYmplY3QgcHJvdG90eXBlcywgbm9vcCdkIGhlcmUgYXMgZGVmYXVsdHMKCQliZWZvcmVEb25lSW46IGZ1bmN0aW9uKCkge30sCgkJYmVmb3JlRG9uZU91dDogZnVuY3Rpb24oKSB7fSwKCQliZWZvcmVTdGFydE91dDogZnVuY3Rpb24oKSB7fSwKCgkJZG9uZUluOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5iZWZvcmVEb25lSW4oKTsKCgkJCXRoaXMuJHRvLnJlbW92ZUNsYXNzKCAib3V0IGluIHJldmVyc2UgIiArIHRoaXMubmFtZSApLmhlaWdodCggIiIgKTsKCgkJCXRoaXMudG9nZ2xlVmlld3BvcnRDbGFzcygpOwoKCQkJLy8gSW4gc29tZSBicm93c2VycyAoaU9TNSksIDNEIHRyYW5zaXRpb25zIGJsb2NrIHRoZSBhYmlsaXR5IHRvIHNjcm9sbCB0byB0aGUgZGVzaXJlZCBsb2NhdGlvbiBkdXJpbmcgdHJhbnNpdGlvbgoJCQkvLyBUaGlzIGVuc3VyZXMgd2UganVtcCB0byB0aGF0IHNwb3QgYWZ0ZXIgdGhlIGZhY3QsIGlmIHdlIGFyZW4ndCB0aGVyZSBhbHJlYWR5LgoJCQlpZiAoICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSAhPT0gdGhpcy50b1Njcm9sbCApIHsKCQkJCXRoaXMuc2Nyb2xsUGFnZSgpOwoJCQl9CgkJCWlmICggIXRoaXMuc2VxdWVudGlhbCApIHsKCQkJCXRoaXMuJHRvLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKTsKCQkJfQoJCQl0aGlzLmRlZmVycmVkLnJlc29sdmUoIHRoaXMubmFtZSwgdGhpcy5yZXZlcnNlLCB0aGlzLiR0bywgdGhpcy4kZnJvbSwgdHJ1ZSApOwoJCX0sCgoJCWRvbmVPdXQ6IGZ1bmN0aW9uKCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSwgcHJldmVudEZvY3VzICkgewoJCQl0aGlzLmJlZm9yZURvbmVPdXQoKTsKCQkJdGhpcy5zdGFydEluKCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSwgcHJldmVudEZvY3VzICk7CgkJfSwKCgkJaGlkZUluOiBmdW5jdGlvbiggY2FsbGJhY2sgKSB7CgkJCS8vIFByZXZlbnQgZmxpY2tlcmluZyBpbiBwaG9uZWdhcCBjb250YWluZXI6IHNlZSBjb21tZW50cyBhdCAjNDAyNCByZWdhcmRpbmcgaU9TCgkJCXRoaXMuJHRvLmNzcyggInotaW5kZXgiLCAtMTAgKTsKCQkJY2FsbGJhY2suY2FsbCggdGhpcyApOwoJCQl0aGlzLiR0by5jc3MoICJ6LWluZGV4IiwgIiIgKTsKCQl9LAoKCQlzY3JvbGxQYWdlOiBmdW5jdGlvbigpIHsKCQkJLy8gQnkgdXNpbmcgc2Nyb2xsVG8gaW5zdGVhZCBvZiBzaWxlbnRTY3JvbGwsIHdlIGNhbiBrZWVwIHRoaW5ncyBiZXR0ZXIgaW4gb3JkZXIKCQkJLy8gSnVzdCB0byBiZSBwcmVjYXV0aW9zLCBkaXNhYmxlIHNjcm9sbHN0YXJ0IGxpc3RlbmluZyBsaWtlIHNpbGVudFNjcm9sbCB3b3VsZAoJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IGZhbHNlOwoJCQkvL2lmIHdlIGFyZSBoaWRpbmcgdGhlIHVybCBiYXIgb3IgdGhlIHBhZ2Ugd2FzIHByZXZpb3VzbHkgc2Nyb2xsZWQgc2Nyb2xsIHRvIGhpZGUgb3IgcmV0dXJuIHRvIHBvc2l0aW9uCgkJCWlmICggJC5tb2JpbGUuaGlkZVVybEJhciB8fCB0aGlzLnRvU2Nyb2xsICE9PSAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCApIHsKCQkJCXdpbmRvdy5zY3JvbGxUbyggMCwgdGhpcy50b1Njcm9sbCApOwoJCQl9CgoJCQkvLyByZWVuYWJsZSBzY3JvbGxzdGFydCBsaXN0ZW5pbmcgbGlrZSBzaWxlbnRTY3JvbGwgd291bGQKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IHRydWU7CgkJCX0sIDE1MCApOwoJCX0sCgoJCXN0YXJ0SW46IGZ1bmN0aW9uKCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSwgcHJldmVudEZvY3VzICkgewoJCQl0aGlzLmhpZGVJbihmdW5jdGlvbigpIHsKCQkJCXRoaXMuJHRvLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKyB0aGlzLnRvUHJlQ2xhc3MgKTsKCgkJCQkvLyBTZW5kIGZvY3VzIHRvIHBhZ2UgYXMgaXQgaXMgbm93IGRpc3BsYXk6IGJsb2NrCgkJCQlpZiAoICFwcmV2ZW50Rm9jdXMgKSB7CgkJCQkJJC5tb2JpbGUuZm9jdXNQYWdlKCB0aGlzLiR0byApOwoJCQkJfQoKCQkJCS8vIFNldCB0byBwYWdlIGhlaWdodAoJCQkJdGhpcy4kdG8uaGVpZ2h0KCBzY3JlZW5IZWlnaHQgKyB0aGlzLnRvU2Nyb2xsICk7CgogICAgICAgICAgICAgICAgaWYgKCAhbm9uZSApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbFBhZ2UoKTsKICAgICAgICAgICAgICAgIH0KCQkJfSk7CgoJCQlpZiAoICFub25lICkgewoJCQkJdGhpcy4kdG8uYW5pbWF0aW9uQ29tcGxldGUoICQucHJveHkoZnVuY3Rpb24oKSB7CgkJCQkJdGhpcy5kb25lSW4oKTsKCQkJCX0sIHRoaXMgKSk7CgkJCX0KCgkJCXRoaXMuJHRvCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMudG9QcmVDbGFzcyApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgaW4gIiArIHJldmVyc2VDbGFzcyApOwoKCQkJaWYgKCBub25lICkgewoJCQkJdGhpcy5kb25lSW4oKTsKCQkJfQoKCQl9LAoKCQlzdGFydE91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICkgewoJCQl0aGlzLmJlZm9yZVN0YXJ0T3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApOwoKCQkJLy8gU2V0IHRoZSBmcm9tIHBhZ2UncyBoZWlnaHQgYW5kIHN0YXJ0IGl0IHRyYW5zaXRpb25pbmcgb3V0CgkJCS8vIE5vdGU6IHNldHRpbmcgYW4gZXhwbGljaXQgaGVpZ2h0IGhlbHBzIGVsaW1pbmF0ZSB0aWxpbmcgaW4gdGhlIHRyYW5zaXRpb25zCgkJCXRoaXMuJGZyb20KCQkJCS5oZWlnaHQoIHNjcmVlbkhlaWdodCArICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgb3V0IiArIHJldmVyc2VDbGFzcyApOwoJCX0sCgoJCXRvZ2dsZVZpZXdwb3J0Q2xhc3M6IGZ1bmN0aW9uKCkgewoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnRvZ2dsZUNsYXNzKCAidWktbW9iaWxlLXZpZXdwb3J0LXRyYW5zaXRpb25pbmcgdmlld3BvcnQtIiArIHRoaXMubmFtZSApOwoJCX0sCgoJCXRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewoJCQkvLyBOT1RFIG1hbnkgb2YgdGhlc2UgY291bGQgYmUgY2FsY3VsYXRlZC9yZWNvcmRlZCBpbiB0aGUgY29uc3RydWN0b3IsIGl0J3MgbXkKCQkJLy8gICAgICBvcGluaW9uIHRoYXQgYmluZGluZyB0aGVtIGFzIGxhdGUgYXMgcG9zc2libGUgaGFzIHZhbHVlIHdpdGggcmVnYXJkcyB0bwoJCQkvLyAgICAgIGJldHRlciB0cmFuc2l0aW9ucyB3aXRoIGZld2VyIGJ1Z3MuIEllLCBpdCdzIG5vdCBndWFyYW50ZWVkIHRoYXQgdGhlCgkJCS8vICAgICAgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZCBhbmQgdHJhbnNpdGlvbiB3aWxsIGJlIHJ1biBpbW1lZGlhdGVseSBhZnRlciBhcwoJCQkvLyAgICAgIGl0IGlzIHRvZGF5LiBTbyB3ZSB3YWl0IHVudGlsIHRyYW5zaXRpb24gaXMgaW52b2tlZCB0byBnYXRoZXIgdGhlIGZvbGxvd2luZwoJCQl2YXIgcmV2ZXJzZUNsYXNzID0gdGhpcy5yZXZlcnNlID8gIiByZXZlcnNlIiA6ICIiLAoJCQkJc2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCksCgkJCQltYXhUcmFuc2l0aW9uT3ZlcnJpZGUgPSAkLm1vYmlsZS5tYXhUcmFuc2l0aW9uV2lkdGggIT09IGZhbHNlICYmICQubW9iaWxlLndpbmRvdy53aWR0aCgpID4gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoLAoJCQkJbm9uZSA9ICEkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgfHwgISQuc3VwcG9ydC5jc3NBbmltYXRpb25zIHx8IG1heFRyYW5zaXRpb25PdmVycmlkZSB8fCAhdGhpcy5uYW1lIHx8IHRoaXMubmFtZSA9PT0gIm5vbmUiIHx8IE1hdGgubWF4KCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCksIHRoaXMudG9TY3JvbGwgKSA+ICQubW9iaWxlLmdldE1heFNjcm9sbEZvclRyYW5zaXRpb24oKTsKCgkJCXRoaXMudG9TY3JvbGwgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmdldEFjdGl2ZSgpLmxhc3RTY3JvbGwgfHwgJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJCXRoaXMudG9nZ2xlVmlld3BvcnRDbGFzcygpOwoKCQkJaWYgKCB0aGlzLiRmcm9tICYmICFub25lICkgewoJCQkJdGhpcy5zdGFydE91dCggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZG9uZU91dCggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUsIHRydWUgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZGVmZXJyZWQucHJvbWlzZSgpOwoJCX0KCX0pOwp9KSggalF1ZXJ5LCB0aGlzICk7CgoKKGZ1bmN0aW9uKCAkICkgewoKCSQubW9iaWxlLlNlcmlhbFRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQl0aGlzLmluaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuU2VyaWFsVHJhbnNpdGlvbi5wcm90b3R5cGUsICQubW9iaWxlLlRyYW5zaXRpb24ucHJvdG90eXBlLCB7CgkJc2VxdWVudGlhbDogdHJ1ZSwKCgkJYmVmb3JlRG9uZU91dDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy4kZnJvbSApIHsKCQkJCXRoaXMuY2xlYW5Gcm9tKCk7CgkJCX0KCQl9LAoKCQliZWZvcmVTdGFydE91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICkgewoJCQl0aGlzLiRmcm9tLmFuaW1hdGlvbkNvbXBsZXRlKCQucHJveHkoZnVuY3Rpb24oKSB7CgkJCQl0aGlzLmRvbmVPdXQoIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICk7CgkJCX0sIHRoaXMgKSk7CgkJfQoJfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkICkgewoKCSQubW9iaWxlLkNvbmN1cnJlbnRUcmFuc2l0aW9uID0gZnVuY3Rpb24oKSB7CgkJdGhpcy5pbml0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cgl9OwoKCSQuZXh0ZW5kKCQubW9iaWxlLkNvbmN1cnJlbnRUcmFuc2l0aW9uLnByb3RvdHlwZSwgJC5tb2JpbGUuVHJhbnNpdGlvbi5wcm90b3R5cGUsIHsKCQlzZXF1ZW50aWFsOiBmYWxzZSwKCgkJYmVmb3JlRG9uZUluOiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLiRmcm9tICkgewoJCQkJdGhpcy5jbGVhbkZyb20oKTsKCQkJfQoJCX0sCgoJCWJlZm9yZVN0YXJ0T3V0OiBmdW5jdGlvbiggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKSB7CgkJCXRoaXMuZG9uZU91dCggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKTsKCQl9Cgl9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQgKSB7CgoJLy8gZ2VuZXJhdGUgdGhlIGhhbmRsZXJzIGZyb20gdGhlIGFib3ZlCgl2YXIgZGVmYXVsdEdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCkgKiAzOwoJfTsKCgkvL3RyYW5zaXRpb24gaGFuZGxlciBkaWN0aW9uYXJ5IGZvciAzcmQgcGFydHkgdHJhbnNpdGlvbnMKCSQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycyA9IHsKCQkic2VxdWVudGlhbCI6ICQubW9iaWxlLlNlcmlhbFRyYW5zaXRpb24sCgkJInNpbXVsdGFuZW91cyI6ICQubW9iaWxlLkNvbmN1cnJlbnRUcmFuc2l0aW9uCgl9OwoKCS8vIE1ha2Ugb3VyIHRyYW5zaXRpb24gaGFuZGxlciB0aGUgcHVibGljIGRlZmF1bHQuCgkkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIgPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2VxdWVudGlhbDsKCgkkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzID0ge307CgoJLy8gSWYgdHJhbnNpdGlvbiBpcyBkZWZpbmVkLCBjaGVjayBpZiBjc3MgM0QgdHJhbnNmb3JtcyBhcmUgc3VwcG9ydGVkLCBhbmQgaWYgbm90LCBpZiBhIGZhbGxiYWNrIGlzIHNwZWNpZmllZAoJJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gPSBmdW5jdGlvbiggdHJhbnNpdGlvbiApIHsKCQlpZiAoIHRyYW5zaXRpb24gJiYgISQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF0gKSB7CgkJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF07CgkJfQoKCQlyZXR1cm4gdHJhbnNpdGlvbjsKCX07CgoJLy8gU2V0IHRoZSBnZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uIHRvIGRlZmF1bHQgaWYgbm8gaW1wbGVtZW50YXRpb24gd2FzIHNldCBieSB1c2VyCgkkLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uID0gJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB8fCBkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbjsKCn0pKCBqUXVlcnkgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgZmxpcCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MuZmxpcCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgZmxvdyBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MuZmxvdyA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgcG9wIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5wb3AgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gVXNlIHRoZSBzaW11bHRhbmVvdXMgdHJhbnNpdGlvbnMgaGFuZGxlciBmb3Igc2xpZGUgdHJhbnNpdGlvbnMKJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzLnNsaWRlID0gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzLnNpbXVsdGFuZW91czsKCi8vIFNldCB0aGUgc2xpZGUgdHJhbnNpdGlvbnMncyBmYWxsYmFjayB0byAiZmFkZSIKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZSA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGVkb3duIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZWRvd24gPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlZmFkZSBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCi8vIFNldCB0aGUgc2xpZGUgdHJhbnNpdGlvbnMncyBmYWxsYmFjayB0byAiZmFkZSIKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZWZhZGUgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRldXAgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRldXAgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHR1cm4gaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnR1cm4gPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5kZWdyYWRlSW5wdXRzID0gewoJY29sb3I6IGZhbHNlLAoJZGF0ZTogZmFsc2UsCglkYXRldGltZTogZmFsc2UsCgkiZGF0ZXRpbWUtbG9jYWwiOiBmYWxzZSwKCWVtYWlsOiBmYWxzZSwKCW1vbnRoOiBmYWxzZSwKCW51bWJlcjogZmFsc2UsCglyYW5nZTogIm51bWJlciIsCglzZWFyY2g6ICJ0ZXh0IiwKCXRlbDogZmFsc2UsCgl0aW1lOiBmYWxzZSwKCXVybDogZmFsc2UsCgl3ZWVrOiBmYWxzZQp9OwovLyBCYWNrY29tcGF0IHJlbW92ZSBpbiAxLjUKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5kZWdyYWRlSW5wdXRzID0gJC5tb2JpbGUuZGVncmFkZUlucHV0czsKCi8vIEF1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZGVncmFkZUlucHV0c1dpdGhpbiA9IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgoJdGFyZ2V0ID0gJCggdGFyZ2V0ICk7CgoJLy8gRGVncmFkZSBpbnB1dHMgdG8gYXZvaWQgcG9vcmx5IGltcGxlbWVudGVkIG5hdGl2ZSBmdW5jdGlvbmFsaXR5Cgl0YXJnZXQuZmluZCggImlucHV0IiApLm5vdCggJC5tb2JpbGUucGFnZS5wcm90b3R5cGUua2VlcE5hdGl2ZVNlbGVjdG9yKCkgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtZW50ID0gJCggdGhpcyApLAoJCQl0eXBlID0gdGhpcy5nZXRBdHRyaWJ1dGUoICJ0eXBlIiApLAoJCQlvcHRUeXBlID0gJC5tb2JpbGUuZGVncmFkZUlucHV0c1sgdHlwZSBdIHx8ICJ0ZXh0IiwKCQkJaHRtbCwgaGFzVHlwZSwgZmluZHN0ciwgcmVwc3RyOwoKCQlpZiAoICQubW9iaWxlLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSApIHsKCQkJaHRtbCA9ICQoICI8ZGl2PiIgKS5odG1sKCBlbGVtZW50LmNsb25lKCkgKS5odG1sKCk7CgkJCS8vIEluIElFIGJyb3dzZXJzLCB0aGUgdHlwZSBzb21ldGltZXMgZG9lc24ndCBleGlzdCBpbiB0aGUgY2xvbmVkIG1hcmt1cCwgc28gd2UgcmVwbGFjZSB0aGUgY2xvc2luZyB0YWcgaW5zdGVhZAoJCQloYXNUeXBlID0gaHRtbC5pbmRleE9mKCAiIHR5cGU9IiApID4gLTE7CgkJCWZpbmRzdHIgPSBoYXNUeXBlID8gL1xzK3R5cGU9WyInXT9cdytbJyJdPy8gOiAvXC8/Pi87CgkJCXJlcHN0ciA9ICIgdHlwZT1cIiIgKyBvcHRUeXBlICsgIlwiIGRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGU9XCIiICsgdHlwZSArICJcIiIgKyAoIGhhc1R5cGUgPyAiIiA6ICI+IiApOwoKCQkJZWxlbWVudC5yZXBsYWNlV2l0aCggaHRtbC5yZXBsYWNlKCBmaW5kc3RyLCByZXBzdHIgKSApOwoJCX0KCX0pOwoKfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5wYWdlIiwgJC5tb2JpbGUucGFnZSwgewoJb3B0aW9uczogewoKCQkvLyBBY2NlcHRzIGxlZnQsIHJpZ2h0IGFuZCBub25lCgkJY2xvc2VCdG46ICJsZWZ0IiwKCQljbG9zZUJ0blRleHQ6ICJDbG9zZSIsCgkJb3ZlcmxheVRoZW1lOiAiYSIsCgkJY29ybmVyczogdHJ1ZSwKCQlkaWFsb2c6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlhbG9nICkgewoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9pbm5lcjogdGhpcy5lbGVtZW50LmNoaWxkcmVuKCksCgkJCQlfaGVhZGVyQ2xvc2VCdXR0b246IG51bGwKCQkJfSk7CgoJCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCQl0aGlzLl9zZXRDbG9zZUJ0biggdGhpcy5vcHRpb25zLmNsb3NlQnRuICk7CgkJCX0KCQl9Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQkvLyBDbGFzcyB0aGUgbWFya3VwIGZvciBkaWFsb2cgc3R5bGluZyBhbmQgd3JhcCBpbnRlcmlvcgoJCWlmICggdGhpcy5vcHRpb25zLmRpYWxvZyApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktZGlhbG9nIiApCgkJCQkud3JhcElubmVyKCAkKCAiPGRpdi8+IiwgewoKCQkJCQkvLyBBUklBIHJvbGUKCQkJCQkicm9sZSIgOiAiZGlhbG9nIiwKCQkJCQkiY2xhc3MiIDogInVpLWRpYWxvZy1jb250YWluIHVpLW92ZXJsYXktc2hhZG93IiArCgkJCQkJCSggdGhpcy5vcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIgKQoJCQkJfSkpOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBjbG9zZUJ1dHRvbkxvY2F0aW9uLCBjbG9zZUJ1dHRvblRleHQsCgkJCWN1cnJlbnRPcHRzID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9pbm5lci50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCAhIW9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLm92ZXJsYXlUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoICQubW9iaWxlLmFjdGl2ZVBhZ2VbIDAgXSA9PT0gdGhpcy5lbGVtZW50WyAwIF0gKSB7CgkJCQljdXJyZW50T3B0cy5vdmVybGF5VGhlbWUgPSBvcHRpb25zLm92ZXJsYXlUaGVtZTsKCQkJCXRoaXMuX2hhbmRsZVBhZ2VCZWZvcmVTaG93KCk7CgkJCX0KCQl9CgoJCWlmICggb3B0aW9ucy5jbG9zZUJ0blRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJY2xvc2VCdXR0b25Mb2NhdGlvbiA9IGN1cnJlbnRPcHRzLmNsb3NlQnRuOwoJCQljbG9zZUJ1dHRvblRleHQgPSBvcHRpb25zLmNsb3NlQnRuVGV4dDsKCQl9CgoJCWlmICggb3B0aW9ucy5jbG9zZUJ0biAhPT0gdW5kZWZpbmVkICkgewoJCQljbG9zZUJ1dHRvbkxvY2F0aW9uID0gb3B0aW9ucy5jbG9zZUJ0bjsKCQl9CgoJCWlmICggY2xvc2VCdXR0b25Mb2NhdGlvbiApIHsKCQkJdGhpcy5fc2V0Q2xvc2VCdG4oIGNsb3NlQnV0dG9uTG9jYXRpb24sIGNsb3NlQnV0dG9uVGV4dCApOwoJCX0KCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0sCgoJX2hhbmRsZVBhZ2VCZWZvcmVTaG93OiBmdW5jdGlvbiAoKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICYmIHRoaXMub3B0aW9ucy5kaWFsb2cgKSB7CgkJCXRoaXMucmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCgpOwoJCQl0aGlzLnNldENvbnRhaW5lckJhY2tncm91bmQoIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgKTsKCQl9IGVsc2UgewoJCQl0aGlzLl9zdXBlcigpOwoJCX0KCX0sCgoJX3NldENsb3NlQnRuOiBmdW5jdGlvbiggbG9jYXRpb24sIHRleHQgKSB7CgkJdmFyIGRzdCwKCQkJYnRuID0gdGhpcy5faGVhZGVyQ2xvc2VCdXR0b247CgoJCS8vIFNhbml0aXplIHZhbHVlCgkJbG9jYXRpb24gPSAibGVmdCIgPT09IGxvY2F0aW9uID8gImxlZnQiIDogInJpZ2h0IiA9PT0gbG9jYXRpb24gPyAicmlnaHQiIDogIm5vbmUiOwoKCQlpZiAoICJub25lIiA9PT0gbG9jYXRpb24gKSB7CgkJCWlmICggYnRuICkgewoJCQkJYnRuLnJlbW92ZSgpOwoJCQkJYnRuID0gbnVsbDsKCQkJfQoJCX0gZWxzZSBpZiAoIGJ0biApIHsKCQkJYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLWxlZnQgdWktYnRuLXJpZ2h0IiApLmFkZENsYXNzKCAidWktYnRuLSIgKyBsb2NhdGlvbiApOwoJCQlpZiAoIHRleHQgKSB7CgkJCQlidG4udGV4dCggdGV4dCApOwoJCQl9CgkJfSBlbHNlIHsKCQkJZHN0ID0gdGhpcy5faW5uZXIuZmluZCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLmZpcnN0KCk7CgkJCWJ0biA9ICQoICI8YT48L2E+IiwgewoJCQkJCSJocmVmIjogIiMiLAoJCQkJCSJjbGFzcyI6ICJ1aS1idG4gdWktY29ybmVyLWFsbCB1aS1pY29uLWRlbGV0ZSB1aS1idG4taWNvbi1ub3RleHQgdWktYnRuLSIgKyBsb2NhdGlvbgoJCQkJfSkKCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIiwgImJhY2siICkKCQkJCS50ZXh0KCB0ZXh0IHx8IHRoaXMub3B0aW9ucy5jbG9zZUJ0blRleHQgfHwgIiIgKQoJCQkJLnByZXBlbmRUbyggZHN0ICk7CgkJCXRoaXMuX29uKCBidG4sIHsgY2xpY2s6ICJjbG9zZSIgfSApOwoJCX0KCgkJdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24gPSBidG47Cgl9Cn0pOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmRpYWxvZyIsIHsKCW9wdGlvbnM6IHsKCgkJLy8gQWNjZXB0cyBsZWZ0LCByaWdodCBhbmQgbm9uZQoJCWNsb3NlQnRuOiAibGVmdCIsCgkJY2xvc2VCdG5UZXh0OiAiQ2xvc2UiLAoJCW92ZXJsYXlUaGVtZTogImEiLAoJCWNvcm5lcnM6IHRydWUKCX0sCgoJLy8gT3ZlcnJpZGUgdGhlIHRoZW1lIHNldCBieSB0aGUgcGFnZSBwbHVnaW4gb24gcGFnZXNob3cKCV9oYW5kbGVQYWdlQmVmb3JlU2hvdzogZnVuY3Rpb24oKSB7CgkJdGhpcy5faXNDbG9zZWFibGUgPSB0cnVlOwoJCWlmICggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApIHsKCQkJdGhpcy5lbGVtZW50CgkJCQkucGFnZSggInJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQiICkKCQkJCS5wYWdlKCAic2V0Q29udGFpbmVyQmFja2dyb3VuZCIsIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgKTsKCQl9Cgl9LAoKCV9oYW5kbGVQYWdlQmVmb3JlSGlkZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5faXNDbG9zZWFibGUgPSBmYWxzZTsKCX0sCgoJLy8gY2xpY2sgYW5kIHN1Ym1pdCBldmVudHM6CgkvLyAtIGNsaWNrcyBhbmQgc3VibWl0cyBzaG91bGQgdXNlIHRoZSBjbG9zaW5nIHRyYW5zaXRpb24gdGhhdCB0aGUgZGlhbG9nCgkvLyAgIG9wZW5lZCB3aXRoIHVubGVzcyBhIGRhdGEtdHJhbnNpdGlvbiBpcyBzcGVjaWZpZWQgb24gdGhlIGxpbmsvZm9ybQoJLy8gLSBpZiB0aGUgY2xpY2sgd2FzIG9uIHRoZSBjbG9zZSBidXR0b24sIG9yIHRoZSBsaW5rIGhhcyBhIGRhdGEtcmVsPSJiYWNrIgoJLy8gICBpdCdsbCBnbyBiYWNrIGluIGhpc3RvcnkgbmF0dXJhbGx5CglfaGFuZGxlVkNsaWNrU3VibWl0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGF0dHJzLAoJCQkkdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggZXZlbnQudHlwZSA9PT0gInZjbGljayIgPyAiYSIgOiAiZm9ybSIgKTsKCgkJaWYgKCAkdGFyZ2V0Lmxlbmd0aCAmJiAhJHRhcmdldC5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSApIHsKCQkJYXR0cnMgPSB7fTsKCQkJYXR0cnNbICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0cmFuc2l0aW9uIiBdID0KCQkJCSggJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5nZXRBY3RpdmUoKSB8fCB7fSApWyAidHJhbnNpdGlvbiIgXSB8fAoJCQkJJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb247CgkJCWF0dHJzWyAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiZGlyZWN0aW9uIiBdID0gInJldmVyc2UiOwoJCQkkdGFyZ2V0LmF0dHIoIGF0dHJzICk7CgkJfQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJLy8gQ2xhc3MgdGhlIG1hcmt1cCBmb3IgZGlhbG9nIHN0eWxpbmcgYW5kIHdyYXAgaW50ZXJpb3IKCQllbGVtLmFkZENsYXNzKCAidWktZGlhbG9nIiApCgkJCS53cmFwSW5uZXIoICQoICI8ZGl2Lz4iLCB7CgoJCQkJLy8gQVJJQSByb2xlCgkJCQkicm9sZSIgOiAiZGlhbG9nIiwKCQkJCSJjbGFzcyIgOiAidWktZGlhbG9nLWNvbnRhaW4gdWktb3ZlcmxheS1zaGFkb3ciICsKCQkJCQkoICEhb3B0cy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiICkKCQkJfSkpOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfaXNDbG9zZWFibGU6IGZhbHNlLAoJCQlfaW5uZXI6IGVsZW0uY2hpbGRyZW4oKSwKCQkJX2hlYWRlckNsb3NlQnV0dG9uOiBudWxsCgkJfSk7CgoJCXRoaXMuX29uKCBlbGVtLCB7CgkJCXZjbGljazogIl9oYW5kbGVWQ2xpY2tTdWJtaXQiLAoJCQlzdWJtaXQ6ICJfaGFuZGxlVkNsaWNrU3VibWl0IiwKCQkJcGFnZWJlZm9yZXNob3c6ICJfaGFuZGxlUGFnZUJlZm9yZVNob3ciLAoJCQlwYWdlYmVmb3JlaGlkZTogIl9oYW5kbGVQYWdlQmVmb3JlSGlkZSIKCQl9KTsKCgkJdGhpcy5fc2V0Q2xvc2VCdG4oIG9wdHMuY2xvc2VCdG4gKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBjbG9zZUJ1dHRvbkxvY2F0aW9uLCBjbG9zZUJ1dHRvblRleHQsCgkJCWN1cnJlbnRPcHRzID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9pbm5lci50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCAhIW9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLm92ZXJsYXlUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoICQubW9iaWxlLmFjdGl2ZVBhZ2VbIDAgXSA9PT0gdGhpcy5lbGVtZW50WyAwIF0gKSB7CgkJCQljdXJyZW50T3B0cy5vdmVybGF5VGhlbWUgPSBvcHRpb25zLm92ZXJsYXlUaGVtZTsKCQkJCXRoaXMuX2hhbmRsZVBhZ2VCZWZvcmVTaG93KCk7CgkJCX0KCQl9CgoJCWlmICggb3B0aW9ucy5jbG9zZUJ0blRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJY2xvc2VCdXR0b25Mb2NhdGlvbiA9IGN1cnJlbnRPcHRzLmNsb3NlQnRuOwoJCQljbG9zZUJ1dHRvblRleHQgPSBvcHRpb25zLmNsb3NlQnRuVGV4dDsKCQl9CgoJCWlmICggb3B0aW9ucy5jbG9zZUJ0biAhPT0gdW5kZWZpbmVkICkgewoJCQljbG9zZUJ1dHRvbkxvY2F0aW9uID0gb3B0aW9ucy5jbG9zZUJ0bjsKCQl9CgoJCWlmICggY2xvc2VCdXR0b25Mb2NhdGlvbiApIHsKCQkJdGhpcy5fc2V0Q2xvc2VCdG4oIGNsb3NlQnV0dG9uTG9jYXRpb24sIGNsb3NlQnV0dG9uVGV4dCApOwoJCX0KCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0sCgoJX3NldENsb3NlQnRuOiBmdW5jdGlvbiggbG9jYXRpb24sIHRleHQgKSB7CgkJdmFyIGRzdCwKCQkJYnRuID0gdGhpcy5faGVhZGVyQ2xvc2VCdXR0b247CgoJCS8vIFNhbml0aXplIHZhbHVlCgkJbG9jYXRpb24gPSAibGVmdCIgPT09IGxvY2F0aW9uID8gImxlZnQiIDogInJpZ2h0IiA9PT0gbG9jYXRpb24gPyAicmlnaHQiIDogIm5vbmUiOwoKCQlpZiAoICJub25lIiA9PT0gbG9jYXRpb24gKSB7CgkJCWlmICggYnRuICkgewoJCQkJYnRuLnJlbW92ZSgpOwoJCQkJYnRuID0gbnVsbDsKCQkJfQoJCX0gZWxzZSBpZiAoIGJ0biApIHsKCQkJYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLWxlZnQgdWktYnRuLXJpZ2h0IiApLmFkZENsYXNzKCAidWktYnRuLSIgKyBsb2NhdGlvbiApOwoJCQlpZiAoIHRleHQgKSB7CgkJCQlidG4udGV4dCggdGV4dCApOwoJCQl9CgkJfSBlbHNlIHsKCQkJZHN0ID0gdGhpcy5faW5uZXIuZmluZCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLmZpcnN0KCk7CgkJCWJ0biA9ICQoICI8YT48L2E+IiwgewoJCQkJCSJyb2xlIjogImJ1dHRvbiIsCgkJCQkJImhyZWYiOiAiIyIsCgkJCQkJImNsYXNzIjogInVpLWJ0biB1aS1jb3JuZXItYWxsIHVpLWljb24tZGVsZXRlIHVpLWJ0bi1pY29uLW5vdGV4dCB1aS1idG4tIiArIGxvY2F0aW9uCgkJCQl9KQoJCQkJLnRleHQoIHRleHQgfHwgdGhpcy5vcHRpb25zLmNsb3NlQnRuVGV4dCB8fCAiIiApCgkJCQkucHJlcGVuZFRvKCBkc3QgKTsKCQkJdGhpcy5fb24oIGJ0biwgeyBjbGljazogImNsb3NlIiB9ICk7CgkJfQoKCQl0aGlzLl9oZWFkZXJDbG9zZUJ1dHRvbiA9IGJ0bjsKCX0sCgoJLy8gQ2xvc2UgbWV0aG9kIGdvZXMgYmFjayBpbiBoaXN0b3J5CgljbG9zZTogZnVuY3Rpb24oKSB7CgkJdmFyIGhpc3QgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5OwoKCQlpZiAoIHRoaXMuX2lzQ2xvc2VhYmxlICkgewoJCQl0aGlzLl9pc0Nsb3NlYWJsZSA9IGZhbHNlOwoJCQkvLyBJZiB0aGUgaGFzaCBsaXN0ZW5pbmcgaXMgZW5hYmxlZCBhbmQgdGhlcmUgaXMgYXQgbGVhc3Qgb25lIHByZWNlZGluZyBoaXN0b3J5CgkJCS8vIGVudHJ5IGl0J3Mgb2sgdG8gZ28gYmFjay4gSW5pdGlhbCBwYWdlcyB3aXRoIHRoZSBkaWFsb2cgaGFzaCBzdGF0ZSBhcmUgYW4gZXhhbXBsZQoJCQkvLyB3aGVyZSB0aGUgc3RhY2sgY2hlY2sgaXMgbmVjZXNzYXJ5CgkJCWlmICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgJiYgaGlzdC5hY3RpdmVJbmRleCA+IDAgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCX0gZWxzZSB7CgkJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnBhZ2Vjb250YWluZXIoICJiYWNrIiApOwoJCQl9CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHJJbml0aWFsTGV0dGVyID0gLyhbQS1aXSkvZzsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbGxhcHNpYmxlIiwgewoJb3B0aW9uczogewoJCWVuaGFuY2VkOiBmYWxzZSwKCQlleHBhbmRDdWVUZXh0OiBudWxsLAoJCWNvbGxhcHNlQ3VlVGV4dDogbnVsbCwKCQljb2xsYXBzZWQ6IHRydWUsCgkJaGVhZGluZzogImgxLGgyLGgzLGg0LGg1LGg2LGxlZ2VuZCIsCgkJY29sbGFwc2VkSWNvbjogbnVsbCwKCQlleHBhbmRlZEljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQl0aGVtZTogbnVsbCwKCQljb250ZW50VGhlbWU6IG51bGwsCgkJaW5zZXQ6IG51bGwsCgkJY29ybmVyczogbnVsbCwKCQltaW5pOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQl1aSA9IHsKCQkJCWFjY29yZGlvbjogZWxlbQoJCQkJCS5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiICsKCQkJCQkJKCAkLm1vYmlsZS5jb2xsYXBzaWJsZXNldCA/ICIsIDptb2JpbGUtY29sbGFwc2libGVzZXQiIDogIiIgKSApCgkJCQkJLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0IiApCgkJCX07CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV91aTogdWkKCQl9KTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXVpLmhlYWRpbmcgPSAkKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmciLCB0aGlzLmVsZW1lbnRbIDAgXSApOwoJCQl1aS5jb250ZW50ID0gdWkuaGVhZGluZy5uZXh0KCk7CgkJCXVpLmFuY2hvciA9ICQoICJhIiwgdWkuaGVhZGluZ1sgMCBdICkuZmlyc3QoKTsKCQkJdWkuc3RhdHVzID0gdWkuYW5jaG9yLmNoaWxkcmVuKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzIiApOwoJCX0gZWxzZSB7CgkJCXRoaXMuX2VuaGFuY2UoIGVsZW0sIHVpICk7CgkJfQoKCQl0aGlzLl9vbiggdWkuaGVhZGluZywgewoJCQkidGFwIjogZnVuY3Rpb24oKSB7CgkJCQl1aS5oZWFkaW5nLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0sCgoJCQkiY2xpY2siOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggIXVpLmhlYWRpbmcuaGFzQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIgKSApOwoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJfSk7Cgl9LAoKCS8vIEFkanVzdCB0aGUga2V5cyBpbnNpZGUgb3B0aW9ucyBmb3IgaW5oZXJpdGVkIHZhbHVlcwoJX2dldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBrZXksCgkJCWFjY29yZGlvbiA9IHRoaXMuX3VpLmFjY29yZGlvbiwKCQkJYWNjb3JkaW9uV2lkZ2V0ID0gdGhpcy5fdWkuYWNjb3JkaW9uV2lkZ2V0OwoKCQkvLyBDb3B5IG9wdGlvbnMKCQlvcHRpb25zID0gJC5leHRlbmQoIHt9LCBvcHRpb25zICk7CgoJCWlmICggYWNjb3JkaW9uLmxlbmd0aCAmJiAhYWNjb3JkaW9uV2lkZ2V0ICkgewoJCQl0aGlzLl91aS5hY2NvcmRpb25XaWRnZXQgPQoJCQlhY2NvcmRpb25XaWRnZXQgPSBhY2NvcmRpb24uZGF0YSggIm1vYmlsZS1jb2xsYXBzaWJsZXNldCIgKTsKCQl9CgoJCWZvciAoIGtleSBpbiBvcHRpb25zICkgewoKCQkJLy8gUmV0cmlldmUgdGhlIG9wdGlvbiB2YWx1ZSBmaXJzdCBmcm9tIHRoZSBvcHRpb25zIG9iamVjdCBwYXNzZWQgaW4gYW5kLCBpZgoJCQkvLyBudWxsLCBmcm9tIHRoZSBwYXJlbnQgYWNjb3JkaW9uIG9yLCBpZiB0aGF0J3MgbnVsbCB0b28sIG9yIGlmIHRoZXJlJ3Mgbm8KCQkJLy8gcGFyZW50IGFjY29yZGlvbiwgdGhlbiBmcm9tIHRoZSBkZWZhdWx0cy4KCQkJb3B0aW9uc1sga2V5IF0gPQoJCQkJKCBvcHRpb25zWyBrZXkgXSAhPSBudWxsICkgPyBvcHRpb25zWyBrZXkgXSA6CgkJCQkoIGFjY29yZGlvbldpZGdldCApID8gYWNjb3JkaW9uV2lkZ2V0Lm9wdGlvbnNbIGtleSBdIDoKCQkJCWFjY29yZGlvbi5sZW5ndGggPyAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIGFjY29yZGlvblsgMCBdLAoJCQkJCWtleS5yZXBsYWNlKCBySW5pdGlhbExldHRlciwgIi0kMSIgKS50b0xvd2VyQ2FzZSgpICk6CgkJCQludWxsOwoKCQkJaWYgKCBudWxsID09IG9wdGlvbnNbIGtleSBdICkgewoJCQkJb3B0aW9uc1sga2V5IF0gPSAkLm1vYmlsZS5jb2xsYXBzaWJsZS5kZWZhdWx0c1sga2V5IF07CgkJCX0KCQl9CgoJCXJldHVybiBvcHRpb25zOwoJfSwKCglfdGhlbWVDbGFzc0Zyb21PcHRpb246IGZ1bmN0aW9uKCBwcmVmaXgsIHZhbHVlICkgewoJCXJldHVybiAoIHZhbHVlID8gKCB2YWx1ZSA9PT0gIm5vbmUiID8gIiIgOiBwcmVmaXggKyB2YWx1ZSApIDogIiIgKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCBlbGVtLCB1aSApIHsKCQl2YXIgaWNvbmNsYXNzLAoJCQlvcHRzID0gdGhpcy5fZ2V0T3B0aW9ucyggdGhpcy5vcHRpb25zICksCgkJCWNvbnRlbnRUaGVtZUNsYXNzID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMuY29udGVudFRoZW1lICk7CgoJCWVsZW0uYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSAiICsKCQkJKCBvcHRzLmluc2V0ID8gInVpLWNvbGxhcHNpYmxlLWluc2V0ICIgOiAiIiApICsKCQkJKCBvcHRzLmluc2V0ICYmIG9wdHMuY29ybmVycyA/ICJ1aS1jb3JuZXItYWxsICIgOiAiIiApICsKCQkJKCBjb250ZW50VGhlbWVDbGFzcyA/ICJ1aS1jb2xsYXBzaWJsZS10aGVtZWQtY29udGVudCAiIDogIiIgKSApOwoJCXVpLm9yaWdpbmFsSGVhZGluZyA9IGVsZW0uY2hpbGRyZW4oIHRoaXMub3B0aW9ucy5oZWFkaW5nICkuZmlyc3QoKSwKCQl1aS5jb250ZW50ID0gZWxlbQoJCQkud3JhcElubmVyKCAiPGRpdiAiICsKCQkJCSJjbGFzcz0ndWktY29sbGFwc2libGUtY29udGVudCAiICsKCQkJCWNvbnRlbnRUaGVtZUNsYXNzICsgIic+PC9kaXY+IiApCgkJCS5jaGlsZHJlbiggIi51aS1jb2xsYXBzaWJsZS1jb250ZW50IiApLAoJCXVpLmhlYWRpbmcgPSB1aS5vcmlnaW5hbEhlYWRpbmc7CgoJCS8vIFJlcGxhY2UgY29sbGFwc2libGVIZWFkaW5nIGlmIGl0J3MgYSBsZWdlbmQKCQlpZiAoIHVpLmhlYWRpbmcuaXMoICJsZWdlbmQiICkgKSB7CgkJCXVpLmhlYWRpbmcgPSAkKCAiPGRpdiByb2xlPSdoZWFkaW5nJz4iKyB1aS5oZWFkaW5nLmh0bWwoKSArIjwvZGl2PiIgKTsKCQkJdWkucGxhY2Vob2xkZXIgPSAkKCAiPGRpdj48IS0tIHBsYWNlaG9sZGVyIGZvciBsZWdlbmQgLS0+PC9kaXY+IiApLmluc2VydEJlZm9yZSggdWkub3JpZ2luYWxIZWFkaW5nICk7CgkJCXVpLm9yaWdpbmFsSGVhZGluZy5yZW1vdmUoKTsKCQl9CgoJCWljb25jbGFzcyA9ICggb3B0cy5jb2xsYXBzZWQgPyAoIG9wdHMuY29sbGFwc2VkSWNvbiA/ICJ1aS1pY29uLSIgKyBvcHRzLmNvbGxhcHNlZEljb24gOiAiIiApOgoJCQkoIG9wdHMuZXhwYW5kZWRJY29uID8gInVpLWljb24tIiArIG9wdHMuZXhwYW5kZWRJY29uIDogIiIgKSApOwoKCQl1aS5zdGF0dXMgPSAkKCAiPHNwYW4gY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzJz48L3NwYW4+IiApOwoJCXVpLmFuY2hvciA9IHVpLmhlYWRpbmcKCQkJLmRldGFjaCgpCgkJCS8vbW9kaWZ5IG1hcmt1cCAmIGF0dHJpYnV0ZXMKCQkJLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZyIgKQoJCQkuYXBwZW5kKCB1aS5zdGF0dXMgKQoJCQkud3JhcElubmVyKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctdG9nZ2xlJz48L2E+IiApCgkJCS5maW5kKCAiYSIgKQoJCQkJLmZpcnN0KCkKCQkJCS5hZGRDbGFzcyggInVpLWJ0biAiICsKCQkJCQkoIGljb25jbGFzcyA/IGljb25jbGFzcyArICIgIiA6ICIiICkgKwoJCQkJCSggaWNvbmNsYXNzID8gKCAidWktYnRuLWljb24tIiArCgkJCQkJCSggb3B0cy5pY29ucG9zID09PSAicmlnaHQiID8gInJpZ2h0IiA6ICJsZWZ0IiApICkgKwoJCQkJCQkiICIgOiAiIiApICsKCQkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJ0bi0iLCBvcHRzLnRoZW1lICkgKyAiICIgKwoJCQkJCSggb3B0cy5taW5pID8gInVpLW1pbmkgIiA6ICIiICkgKTsKCgkJLy9kcm9wIGhlYWRpbmcgaW4gYmVmb3JlIGNvbnRlbnQKCQl1aS5oZWFkaW5nLmluc2VydEJlZm9yZSggdWkuY29udGVudCApOwoKCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggdGhpcy5vcHRpb25zLmNvbGxhcHNlZCApOwoKCQlyZXR1cm4gdWk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBrZXksIG9wdGlvbnMgPSB7fTsKCgkJZm9yICgga2V5IGluICQubW9iaWxlLmNvbGxhcHNpYmxlLmRlZmF1bHRzICkgewoJCQlvcHRpb25zWyBrZXkgXSA9IHRoaXMub3B0aW9uc1sga2V5IF07CgkJfQoKCQl0aGlzLl9zZXRPcHRpb25zKCBvcHRpb25zICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNDb2xsYXBzZWQsIG5ld1RoZW1lLCBvbGRUaGVtZSwgaGFzQ29ybmVycywKCQkJZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJY3VycmVudE9wdHMgPSB0aGlzLl9nZXRPcHRpb25zKCB0aGlzLm9wdGlvbnMgKSwKCQkJdWkgPSB0aGlzLl91aSwKCQkJYW5jaG9yID0gdWkuYW5jaG9yLAoJCQlzdGF0dXMgPSB1aS5zdGF0dXMsCgkJCW9wdHMgPSB0aGlzLl9nZXRPcHRpb25zKCBvcHRpb25zICk7CgoJCS8vIEZpcnN0IGFuZCBmb3JlbW9zdCB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgY29sbGFwc2libGUgaXMgaW4gdGhlIHByb3BlcgoJCS8vIHN0YXRlLCBpbiBjYXNlIHNvbWVib2R5IGRlY2lkZWQgdG8gY2hhbmdlIHRoZSBjb2xsYXBzZWQgb3B0aW9uIGF0IHRoZQoJCS8vIHNhbWUgdGltZSBhcyBhbm90aGVyIG9wdGlvbgoJCWlmICggb3B0aW9ucy5jb2xsYXBzZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5faGFuZGxlRXhwYW5kQ29sbGFwc2UoIG9wdGlvbnMuY29sbGFwc2VkICk7CgkJfQoKCQlpc0NvbGxhcHNlZCA9IGVsZW0uaGFzQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQiICk7CgoJCS8vIE9ubHkgb3B0aW9ucyByZWZlcnJpbmcgdG8gdGhlIGN1cnJlbnQgc3RhdGUgbmVlZCB0byBiZSBhcHBsaWVkIHJpZ2h0IGF3YXkKCQkvLyBJdCBpcyBlbm91Z2ggdG8gc3RvcmUgb3B0aW9ucyBjb3ZlcmluZyB0aGUgYWx0ZXJuYXRlIGluIHRoaXMub3B0aW9ucy4KCQlpZiAoIGlzQ29sbGFwc2VkICkgewoJCQlpZiAoIG9wdHMuZXhwYW5kQ3VlVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQkJc3RhdHVzLnRleHQoIG9wdHMuZXhwYW5kQ3VlVGV4dCApOwoJCQl9CgkJCWlmICggb3B0cy5jb2xsYXBzZWRJY29uICE9PSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIGN1cnJlbnRPcHRzLmNvbGxhcHNlZEljb24gKSB7CgkJCQkJYW5jaG9yLnJlbW92ZUNsYXNzKCAidWktaWNvbi0iICsgY3VycmVudE9wdHMuY29sbGFwc2VkSWNvbiApOwoJCQkJfQoJCQkJaWYgKCBvcHRzLmNvbGxhcHNlZEljb24gKSB7CgkJCQkJYW5jaG9yLmFkZENsYXNzKCAidWktaWNvbi0iICsgb3B0cy5jb2xsYXBzZWRJY29uICk7CgkJCQl9CgkJCX0KCQl9IGVsc2UgewoJCQlpZiAoIG9wdHMuY29sbGFwc2VDdWVUZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQlzdGF0dXMudGV4dCggb3B0cy5jb2xsYXBzZUN1ZVRleHQgKTsKCQkJfQoJCQlpZiAoIG9wdHMuZXhwYW5kZWRJY29uICE9PSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIGN1cnJlbnRPcHRzLmV4cGFuZGVkSWNvbiApIHsKCQkJCQlhbmNob3IucmVtb3ZlQ2xhc3MoICJ1aS1pY29uLSIgKyBjdXJyZW50T3B0cy5leHBhbmRlZEljb24gKTsKCQkJCX0KCQkJCWlmICggb3B0cy5leHBhbmRlZEljb24gKSB7CgkJCQkJYW5jaG9yLmFkZENsYXNzKCAidWktaWNvbi0iICsgb3B0cy5leHBhbmRlZEljb24gKTsKCQkJCX0KCQkJfQoJCX0KCgkJaWYgKCBvcHRzLmljb25wb3MgIT09IHVuZGVmaW5lZCApIHsKCQkJYW5jaG9yLnJlbW92ZUNsYXNzKCAidWktYnRuLWljb24tIiArICggY3VycmVudE9wdHMuaWNvblBvcyA9PT0gInJpZ2h0IiA/ICJyaWdodCIgOiAibGVmdCIgKSApOwoJCQlhbmNob3IuYWRkQ2xhc3MoICJ1aS1idG4taWNvbi0iICsgKCBvcHRzLmljb25Qb3MgPT09ICJyaWdodCIgPyAicmlnaHQiIDogImxlZnQiICkgKTsKCQl9CgoJCWlmICggb3B0cy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlvbGRUaGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYnRuLSIsIGN1cnJlbnRPcHRzLnRoZW1lICk7CgkJCW5ld1RoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1idG4tIiwgb3B0cy50aGVtZSApOwoJCQlhbmNob3IucmVtb3ZlQ2xhc3MoIG9sZFRoZW1lICkuYWRkQ2xhc3MoIG5ld1RoZW1lICk7CgkJfQoKCQlpZiAoIG9wdHMuY29udGVudFRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCW9sZFRoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIGN1cnJlbnRPcHRzLnRoZW1lICk7CgkJCW5ld1RoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMudGhlbWUgKTsKCQkJdWkuY29udGVudC5yZW1vdmVDbGFzcyggb2xkVGhlbWUgKS5hZGRDbGFzcyggbmV3VGhlbWUgKTsKCQl9CgoJCWlmICggb3B0cy5pbnNldCAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtaW5zZXQiLCBvcHRzLmluc2V0ICk7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0cy5pbnNldCAmJiAoIG9wdHMuY29ybmVycyB8fCBjdXJyZW50T3B0cy5jb3JuZXJzICkgKTsKCQl9CgoJCWlmICggb3B0cy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0cy5jb3JuZXJzICYmICggb3B0cy5pbnNldCB8fCBjdXJyZW50T3B0cy5pbnNldCApICk7CgkJfQoKCQlpZiAoIGhhc0Nvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBoYXNDb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdHMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQlhbmNob3IudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgb3B0cy5taW5pICk7CgkJfQoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfaGFuZGxlRXhwYW5kQ29sbGFwc2U6IGZ1bmN0aW9uKCBpc0NvbGxhcHNlICkgewoJCXZhciBvcHRzID0gdGhpcy5fZ2V0T3B0aW9ucyggdGhpcy5vcHRpb25zICksCgkJCXVpID0gdGhpcy5fdWk7CgoJCXVpLnN0YXR1cy50ZXh0KCBpc0NvbGxhcHNlID8gb3B0cy5leHBhbmRDdWVUZXh0IDogb3B0cy5jb2xsYXBzZUN1ZVRleHQgKTsKCQl1aS5oZWFkaW5nCgkJCS50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmctY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApCgkJCS5maW5kKCAiYSIgKS5maXJzdCgpCgkJCS50b2dnbGVDbGFzcyggInVpLWljb24tIiArIG9wdHMuZXhwYW5kZWRJY29uLCAhaXNDb2xsYXBzZSApCgoJCQkvLyBsb2dpYyBvciBjYXVzZSBzYW1lIGljb24gZm9yIGV4cGFuZGVkL2NvbGxhcHNlZCBzdGF0ZSB3b3VsZCByZW1vdmUgdGhlIHVpLWljb24tY2xhc3MKCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgb3B0cy5jb2xsYXBzZWRJY29uLCAoIGlzQ29sbGFwc2UgfHwgb3B0cy5leHBhbmRlZEljb24gPT09IG9wdHMuY29sbGFwc2VkSWNvbiApICkKCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoKCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICk7CgkJdWkuY29udGVudAoJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb250ZW50LWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKQoJCQkuYXR0ciggImFyaWEtaGlkZGVuIiwgaXNDb2xsYXBzZSApCgkJCS50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCXRoaXMub3B0aW9ucy5jb2xsYXBzZWQgPSBpc0NvbGxhcHNlOwoJCXRoaXMuX3RyaWdnZXIoIGlzQ29sbGFwc2UgPyAiY29sbGFwc2UiIDogImV4cGFuZCIgKTsKCX0sCgoJZXhwYW5kOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggZmFsc2UgKTsKCX0sCgoJY29sbGFwc2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2hhbmRsZUV4cGFuZENvbGxhcHNlKCB0cnVlICk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgdWkgPSB0aGlzLl91aSwKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHVpLnBsYWNlaG9sZGVyICkgewoJCQl1aS5vcmlnaW5hbEhlYWRpbmcuaW5zZXJ0QmVmb3JlKCB1aS5wbGFjZWhvbGRlciApOwoJCQl1aS5wbGFjZWhvbGRlci5yZW1vdmUoKTsKCQkJdWkuaGVhZGluZy5yZW1vdmUoKTsKCQl9IGVsc2UgewoJCQl1aS5zdGF0dXMucmVtb3ZlKCk7CgkJCXVpLmhlYWRpbmcKCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmcgdWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiICkKCQkJCS5jaGlsZHJlbigpCgkJCQkJLmNvbnRlbnRzKCkKCQkJCQkJLnVud3JhcCgpOwoJCX0KCgkJdWkuYW5jaG9yLmNvbnRlbnRzKCkudW53cmFwKCk7CgkJdWkuY29udGVudC5jb250ZW50cygpLnVud3JhcCgpOwoJCXRoaXMuZWxlbWVudAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSB1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQgIiArCgkJCQkidWktY29sbGFwc2libGUtdGhlbWVkLWNvbnRlbnQgdWktY29sbGFwc2libGUtaW5zZXQgdWktY29ybmVyLWFsbCIgKTsKCX0KfSk7CgovLyBEZWZhdWx0cyB0byBiZSB1c2VkIGJ5IGFsbCBpbnN0YW5jZXMgb2YgY29sbGFwc2libGUgaWYgcGVyLWluc3RhbmNlIHZhbHVlcwovLyBhcmUgdW5zZXQgb3IgaWYgbm90aGluZyBpcyBzcGVjaWZpZWQgYnkgd2F5IG9mIGluaGVyaXRhbmNlIGZyb20gYW4gYWNjb3JkaW9uLgovLyBOb3RlIHRoYXQgdGhpcyBoYXNoIGRvZXMgbm90IGNvbnRhaW4gb3B0aW9ucyAiY29sbGFwc2VkIiBvciAiaGVhZGluZyIsCi8vIGJlY2F1c2UgdGhvc2UgYXJlIG5vdCBpbmhlcml0YWJsZS4KJC5tb2JpbGUuY29sbGFwc2libGUuZGVmYXVsdHMgPSB7CglleHBhbmRDdWVUZXh0OiAiIGNsaWNrIHRvIGV4cGFuZCBjb250ZW50cyIsCgljb2xsYXBzZUN1ZVRleHQ6ICIgY2xpY2sgdG8gY29sbGFwc2UgY29udGVudHMiLAoJY29sbGFwc2VkSWNvbjogInBsdXMiLAoJY29udGVudFRoZW1lOiAiaW5oZXJpdCIsCglleHBhbmRlZEljb246ICJtaW51cyIsCglpY29ucG9zOiAicmlnaHQiLAoJaW5zZXQ6IHRydWUsCgljb3JuZXJzOiB0cnVlLAoJdGhlbWU6ICJpbmhlcml0IiwKCW1pbmk6IGZhbHNlCn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzID0gewoJX2dldFZpc2libGVzOiBmdW5jdGlvbiggJGVscywgY3JlYXRlICkgewoJCXZhciB2aXNpYmxlczsKCgkJaWYgKCBjcmVhdGUgKSB7CgkJCXZpc2libGVzID0gJGVscy5ub3QoICIudWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9IGVsc2UgewoJCQl2aXNpYmxlcyA9ICRlbHMuZmlsdGVyKCAiOnZpc2libGUiICk7CgkJCWlmICggdmlzaWJsZXMubGVuZ3RoID09PSAwICkgewoJCQkJdmlzaWJsZXMgPSAkZWxzLm5vdCggIi51aS1zY3JlZW4taGlkZGVuIiApOwoJCQl9CgkJfQoKCQlyZXR1cm4gdmlzaWJsZXM7Cgl9LAoKCV9hZGRGaXJzdExhc3RDbGFzc2VzOiBmdW5jdGlvbiggJGVscywgJHZpc2libGVzLCBjcmVhdGUgKSB7CgkJJGVscy5yZW1vdmVDbGFzcyggInVpLWZpcnN0LWNoaWxkIHVpLWxhc3QtY2hpbGQiICk7CgkJJHZpc2libGVzLmVxKCAwICkuYWRkQ2xhc3MoICJ1aS1maXJzdC1jaGlsZCIgKS5lbmQoKS5sYXN0KCkuYWRkQ2xhc3MoICJ1aS1sYXN0LWNoaWxkIiApOwoJCWlmICggIWNyZWF0ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJ1cGRhdGVsYXlvdXQiICk7CgkJfQoJfSwKCglfcmVtb3ZlRmlyc3RMYXN0Q2xhc3NlczogZnVuY3Rpb24oICRlbHMgKSB7CgkJJGVscy5yZW1vdmVDbGFzcyggInVpLWZpcnN0LWNoaWxkIHVpLWxhc3QtY2hpbGQiICk7Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBjaGlsZENvbGxhcHNpYmxlc1NlbGVjdG9yID0gIjptb2JpbGUtY29sbGFwc2libGUsICIgKyAkLm1vYmlsZS5jb2xsYXBzaWJsZS5pbml0U2VsZWN0b3I7CgokLndpZGdldCggIm1vYmlsZS5jb2xsYXBzaWJsZXNldCIsICQuZXh0ZW5kKCB7CgoJLy8gVGhlIGluaXRTZWxlY3RvciBpcyBkZXByZWNhdGVkIGFzIG9mIDEuNC4wLiBJbiAxLjUuMCB3ZSB3aWxsIHVzZQoJLy8gOmpxbURhdGEocm9sZT0nY29sbGFwc2libGVzZXQnKSB3aGljaCB3aWxsIGFsbG93IHVzIHRvIGdldCByaWQgb2YgdGhlIGxpbmUKCS8vIGJlbG93IGFsdG9nZXRoZXIsIGJlY2F1c2UgdGhlIGF1dG9pbml0IHdpbGwgZ2VuZXJhdGUgc3VjaCBhbiBpbml0U2VsZWN0b3IKCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpLDpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlc2V0JykiLAoKCW9wdGlvbnM6ICQuZXh0ZW5kKCB7CgkJZW5oYW5jZWQ6IGZhbHNlCgl9LCAkLm1vYmlsZS5jb2xsYXBzaWJsZS5kZWZhdWx0cyApLAoKCV9oYW5kbGVDb2xsYXBzaWJsZUV4cGFuZDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBjbG9zZXN0Q29sbGFwc2libGUgPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLWNvbGxhcHNpYmxlIiApOwoKCQlpZiAoIGNsb3Nlc3RDb2xsYXBzaWJsZS5wYXJlbnQoKS5pcyggIjptb2JpbGUtY29sbGFwc2libGVzZXQsIDpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpIiApICkgewoJCQljbG9zZXN0Q29sbGFwc2libGUKCQkJCS5zaWJsaW5ncyggIi51aS1jb2xsYXBzaWJsZTpub3QoLnVpLWNvbGxhcHNpYmxlLWNvbGxhcHNlZCkiICkKCQkJCS5jb2xsYXBzaWJsZSggImNvbGxhcHNlIiApOwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9jbGFzc2VzOiAiIgoJCX0pOwoKCQlpZiAoICFvcHRzLmVuaGFuY2VkICkgewoJCQllbGVtLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0ICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ncm91cC10aGVtZS0iLCBvcHRzLnRoZW1lICkgKyAiICIgKwoJCQkJKCBvcHRzLmNvcm5lcnMgJiYgb3B0cy5pbnNldCA/ICJ1aS1jb3JuZXItYWxsICIgOiAiIiApICk7CgkJCXRoaXMuZWxlbWVudC5maW5kKCAkLm1vYmlsZS5jb2xsYXBzaWJsZS5pbml0U2VsZWN0b3IgKS5jb2xsYXBzaWJsZSgpOwoJCX0KCgkJdGhpcy5fb24oIGVsZW0sIHsgY29sbGFwc2libGVleHBhbmQ6ICJfaGFuZGxlQ29sbGFwc2libGVFeHBhbmQiIH0gKTsKCX0sCgoJX3RoZW1lQ2xhc3NGcm9tT3B0aW9uOiBmdW5jdGlvbiggcHJlZml4LCB2YWx1ZSApIHsKCQlyZXR1cm4gKCB2YWx1ZSA/ICggdmFsdWUgPT09ICJub25lIiA/ICIiIDogcHJlZml4ICsgdmFsdWUgKSA6ICIiICk7Cgl9LAoKCV9pbml0OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9yZWZyZXNoKCB0cnVlICk7CgoJCS8vIEJlY2F1c2UgdGhlIGNvcm5lcnMgYXJlIGhhbmRsZWQgYnkgdGhlIGNvbGxhcHNpYmxlIGl0c2VsZiBhbmQgdGhlIGRlZmF1bHQgc3RhdGUgaXMgY29sbGFwc2VkCgkJLy8gVGhhdCB3YXMgY2F1c2luZyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQxMTYKCQl0aGlzLmVsZW1lbnQKCQkJLmNoaWxkcmVuKCBjaGlsZENvbGxhcHNpYmxlc1NlbGVjdG9yICkKCQkJLmZpbHRlciggIjpqcW1EYXRhKGNvbGxhcHNlZD0nZmFsc2UnKSIgKQoJCQkuY29sbGFwc2libGUoICJleHBhbmQiICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgcmV0LCBoYXNDb3JuZXJzLAoJCQllbGVtID0gdGhpcy5lbGVtZW50LAoJCQl0aGVtZUNsYXNzID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ncm91cC10aGVtZS0iLCBvcHRpb25zLnRoZW1lICk7CgoJCWlmICggdGhlbWVDbGFzcyApIHsKCQkJZWxlbQoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWdyb3VwLXRoZW1lLSIsIHRoaXMub3B0aW9ucy50aGVtZSApICkKCQkJCS5hZGRDbGFzcyggdGhlbWVDbGFzcyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmluc2V0ICE9PSB1bmRlZmluZWQgKSB7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0aW9ucy5pbnNldCAmJiAoIG9wdGlvbnMuY29ybmVycyB8fCB0aGlzLm9wdGlvbnMuY29ybmVycyApICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQloYXNDb3JuZXJzID0gISEoIG9wdGlvbnMuY29ybmVycyAmJiAoIG9wdGlvbnMuaW5zZXQgfHwgdGhpcy5vcHRpb25zLmluc2V0ICkgKTsKCQl9CgoJCWlmICggaGFzQ29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIGhhc0Nvcm5lcnMgKTsKCQl9CgoJCXJldCA9IHRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgkJdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiOm1vYmlsZS1jb2xsYXBzaWJsZSIgKS5jb2xsYXBzaWJsZSggInJlZnJlc2giICk7CgkJcmV0dXJuIHJldDsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciBlbCA9IHRoaXMuZWxlbWVudDsKCgkJdGhpcy5fcmVtb3ZlRmlyc3RMYXN0Q2xhc3NlcyggZWwuY2hpbGRyZW4oIGNoaWxkQ29sbGFwc2libGVzU2VsZWN0b3IgKSApOwoJCWVsCgkJCS5yZW1vdmVDbGFzcyggInVpLWNvbGxhcHNpYmxlLXNldCB1aS1jb3JuZXItYWxsICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ncm91cC10aGVtZS0iLCB0aGlzLm9wdGlvbnMudGhlbWUgKSApCgkJCS5jaGlsZHJlbiggIjptb2JpbGUtY29sbGFwc2libGUiICkKCQkJLmNvbGxhcHNpYmxlKCAiZGVzdHJveSIgKTsKCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdmFyIGNvbGxhcHNpYmxlc0luU2V0ID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCBjaGlsZENvbGxhcHNpYmxlc1NlbGVjdG9yICk7CgoJCXRoaXMuZWxlbWVudC5maW5kKCAkLm1vYmlsZS5jb2xsYXBzaWJsZS5pbml0U2VsZWN0b3IgKS5ub3QoICIudWktY29sbGFwc2libGUiICkuY29sbGFwc2libGUoKTsKCgkJdGhpcy5fYWRkRmlyc3RMYXN0Q2xhc3NlcyggY29sbGFwc2libGVzSW5TZXQsIHRoaXMuX2dldFZpc2libGVzKCBjb2xsYXBzaWJsZXNJblNldCwgY3JlYXRlICksIGNyZWF0ZSApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9yZWZyZXNoKCBmYWxzZSApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIERlcHJlY2F0ZWQgaW4gMS40CiQuZm4uZmllbGRjb250YWluID0gZnVuY3Rpb24oLyogb3B0aW9ucyAqLykgewoJcmV0dXJuIHRoaXMuYWRkQ2xhc3MoICJ1aS1maWVsZC1jb250YWluIiApOwp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmdyaWQgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJbyA9ICQuZXh0ZW5kKHsKCQkJCWdyaWQ6IG51bGwKCQkJfSwgb3B0aW9ucyApLAoJCQkka2lkcyA9ICR0aGlzLmNoaWxkcmVuKCksCgkJCWdyaWRDb2xzID0geyBzb2xvOjEsIGE6MiwgYjozLCBjOjQsIGQ6NSB9LAoJCQlncmlkID0gby5ncmlkLAoJCQlpdGVyYXRvciwKCQkJbGV0dGVyOwoKCQkJaWYgKCAhZ3JpZCApIHsKCQkJCWlmICggJGtpZHMubGVuZ3RoIDw9IDUgKSB7CgkJCQkJZm9yICggbGV0dGVyIGluIGdyaWRDb2xzICkgewoJCQkJCQlpZiAoIGdyaWRDb2xzWyBsZXR0ZXIgXSA9PT0gJGtpZHMubGVuZ3RoICkgewoJCQkJCQkJZ3JpZCA9IGxldHRlcjsKCQkJCQkJfQoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJZ3JpZCA9ICJhIjsKCQkJCQkkdGhpcy5hZGRDbGFzcyggInVpLWdyaWQtZHVvIiApOwoJCQkJfQoJCQl9CgkJCWl0ZXJhdG9yID0gZ3JpZENvbHNbZ3JpZF07CgoJCSR0aGlzLmFkZENsYXNzKCAidWktZ3JpZC0iICsgZ3JpZCApOwoKCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzEpIiApLmFkZENsYXNzKCAidWktYmxvY2stYSIgKTsKCgkJaWYgKCBpdGVyYXRvciA+IDEgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMikiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1iIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gMiApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibiszKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWMiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiAzICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzQpIiApLmFkZENsYXNzKCAidWktYmxvY2stZCIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDQgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rNSkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1lIiApOwoJCX0KCX0pOwp9Owp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLm5hdmJhciIsIHsKCW9wdGlvbnM6IHsKCQlpY29ucG9zOiAidG9wIiwKCQlncmlkOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQl2YXIgJG5hdmJhciA9IHRoaXMuZWxlbWVudCwKCQkJJG5hdmJ0bnMgPSAkbmF2YmFyLmZpbmQoICJhIiApLAoJCQlpY29ucG9zID0gJG5hdmJ0bnMuZmlsdGVyKCAiOmpxbURhdGEoaWNvbikiICkubGVuZ3RoID8gdGhpcy5vcHRpb25zLmljb25wb3MgOiB1bmRlZmluZWQ7CgoJCSRuYXZiYXIuYWRkQ2xhc3MoICJ1aS1uYXZiYXIiICkKCQkJLmF0dHIoICJyb2xlIiwgIm5hdmlnYXRpb24iICkKCQkJLmZpbmQoICJ1bCIgKQoJCQkuanFtRW5oYW5jZWFibGUoKQoJCQkuZ3JpZCh7IGdyaWQ6IHRoaXMub3B0aW9ucy5ncmlkIH0pOwoKCQkkbmF2YnRucwoJCQkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQl2YXIgaWNvbiA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggdGhpcywgImljb24iICksCgkJCQkJdGhlbWUgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMsICJ0aGVtZSIgKSwKCQkJCQljbGFzc2VzID0gInVpLWJ0biI7CgoJCQkJaWYgKCB0aGVtZSApIHsKCQkJCQljbGFzc2VzICs9ICIgdWktYnRuLSIgKyB0aGVtZTsKCQkJCX0KCQkJCWlmICggaWNvbiApIHsKCQkJCQljbGFzc2VzICs9ICIgdWktaWNvbi0iICsgaWNvbiArICIgdWktYnRuLWljb24tIiArIGljb25wb3M7CgkJCQl9CgkJCQkkKCB0aGlzICkuYWRkQ2xhc3MoIGNsYXNzZXMgKTsKCQkJfSk7CgoJCSRuYXZiYXIuZGVsZWdhdGUoICJhIiwgInZjbGljayIsIGZ1bmN0aW9uKCAvKiBldmVudCAqLyApIHsKCQkJdmFyIGFjdGl2ZUJ0biA9ICQoIHRoaXMgKTsKCgkJCWlmICggISggYWN0aXZlQnRuLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgfHwKCgkJCQkvLyBERVBSRUNBVEVEIGFzIG9mIDEuNC4wIC0gcmVtb3ZlIGFmdGVyIDEuNC4wIHJlbGVhc2UKCQkJCS8vIG9ubHkgdWktc3RhdGUtZGlzYWJsZWQgc2hvdWxkIGJlIHByZXNlbnQgdGhlcmVhZnRlcgoJCQkJYWN0aXZlQnRuLmhhc0NsYXNzKCAidWktZGlzYWJsZWQiICkgfHwKCQkJCWFjdGl2ZUJ0bi5oYXNDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKSApICkgewoKCQkJCSRuYXZidG5zLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJYWN0aXZlQnRuLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoKCQkJCS8vIFRoZSBjb2RlIGJlbG93IGlzIGEgd29ya2Fyb3VuZCB0byBmaXggIzExODEKCQkJCSQoIGRvY3VtZW50ICkub25lKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQlhY3RpdmVCdG4ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQl9KTsKCQkJfQoJCX0pOwoKCQkvLyBCdXR0b25zIGluIHRoZSBuYXZiYXIgd2l0aCB1aS1zdGF0ZS1wZXJzaXN0IGNsYXNzIHNob3VsZCByZWdhaW4gdGhlaXIgYWN0aXZlIHN0YXRlIGJlZm9yZSBwYWdlIHNob3cKCQkkbmF2YmFyLmNsb3Nlc3QoICIudWktcGFnZSIgKS5iaW5kKCAicGFnZWJlZm9yZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJJG5hdmJ0bnMuZmlsdGVyKCAiLnVpLXN0YXRlLXBlcnNpc3QiICkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfSk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgZ2V0QXR0ciA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZTsKCiQud2lkZ2V0KCAibW9iaWxlLmxpc3R2aWV3IiwgJC5leHRlbmQoIHsKCglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJY291bnRUaGVtZTogbnVsbCwgLyogRGVwcmVjYXRlZCBpbiAxLjQgKi8KCQlkaXZpZGVyVGhlbWU6IG51bGwsCgkJaWNvbjogImNhcmF0LWwiLAoJCXNwbGl0SWNvbjogImNhcmF0LWwiLAoJCXNwbGl0VGhlbWU6IG51bGwsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaW5zZXQ6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciB0ID0gdGhpcywKCQkJbGlzdHZpZXdDbGFzc2VzID0gIiI7CgoJCWxpc3R2aWV3Q2xhc3NlcyArPSB0Lm9wdGlvbnMuaW5zZXQgPyAiIHVpLWxpc3R2aWV3LWluc2V0IiA6ICIiOwoKCQlpZiAoICEhdC5vcHRpb25zLmluc2V0ICkgewoJCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiI7CgkJCWxpc3R2aWV3Q2xhc3NlcyArPSB0Lm9wdGlvbnMuc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiI7CgkJfQoKCQkvLyBjcmVhdGUgbGlzdHZpZXcgbWFya3VwCgkJdC5lbGVtZW50LmFkZENsYXNzKCAiIHVpLWxpc3R2aWV3IiArIGxpc3R2aWV3Q2xhc3NlcyApOwoKCQl0LnJlZnJlc2goIHRydWUgKTsKCX0sCgoJLy8gVE9ETzogUmVtb3ZlIGluIDEuNQoJX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIG5leHRQcm9wLCBsY05hbWUsIHVjTmFtZSApIHsKCQl2YXIgZGljdCA9IHt9OwoJCWRpY3RbIGxjTmFtZSBdID0gZGljdFsgdWNOYW1lIF0gPSB0cnVlOwoJCXdoaWxlICggZWxlICkgewoJCQlpZiAoIGRpY3RbIGVsZS5ub2RlTmFtZSBdICkgewoJCQkJcmV0dXJuIGVsZTsKCQkJfQoJCQllbGUgPSBlbGVbIG5leHRQcm9wIF07CgkJfQoJCXJldHVybiBudWxsOwoJfSwKCS8vIFRPRE86IFJlbW92ZSBpbiAxLjUKCV9hZGRUaHVtYkNsYXNzZXM6IGZ1bmN0aW9uKCBjb250YWluZXJzICkgewoJCXZhciBpLCBpbWcsIGxlbiA9IGNvbnRhaW5lcnMubGVuZ3RoOwoJCWZvciAoIGkgPSAwOyBpIDwgbGVuOyBpKysgKSB7CgkJCWltZyA9ICQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGNvbnRhaW5lcnNbIGkgXS5maXJzdENoaWxkLCAibmV4dFNpYmxpbmciLCAiaW1nIiwgIklNRyIgKSApOwoJCQlpZiAoIGltZy5sZW5ndGggKSB7CgkJCQkkKCB0aGlzLl9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lKCBpbWdbIDAgXS5wYXJlbnROb2RlLCAicGFyZW50Tm9kZSIsICJsaSIsICJMSSIgKSApLmFkZENsYXNzKCBpbWcuaGFzQ2xhc3MoICJ1aS1saS1pY29uIiApID8gInVpLWxpLWhhcy1pY29uIiA6ICJ1aS1saS1oYXMtdGh1bWIiICk7CgkJCX0KCQl9Cgl9LAoKCV9nZXRDaGlsZHJlbkJ5VGFnTmFtZTogZnVuY3Rpb24oIGVsZSwgbGNOYW1lLCB1Y05hbWUgKSB7CgkJdmFyIHJlc3VsdHMgPSBbXSwKCQkJZGljdCA9IHt9OwoJCWRpY3RbIGxjTmFtZSBdID0gZGljdFsgdWNOYW1lIF0gPSB0cnVlOwoJCWVsZSA9IGVsZS5maXJzdENoaWxkOwoJCXdoaWxlICggZWxlICkgewoJCQlpZiAoIGRpY3RbIGVsZS5ub2RlTmFtZSBdICkgewoJCQkJcmVzdWx0cy5wdXNoKCBlbGUgKTsKCQkJfQoJCQllbGUgPSBlbGUubmV4dFNpYmxpbmc7CgkJfQoJCXJldHVybiAkKCByZXN1bHRzICk7Cgl9LAoKCV9iZWZvcmVMaXN0dmlld1JlZnJlc2g6ICQubm9vcCwKCV9hZnRlckxpc3R2aWV3UmVmcmVzaDogJC5ub29wLAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdmFyIGJ1dHRvbkNsYXNzLCBwb3MsIG51bWxpLCBpdGVtLCBpdGVtQ2xhc3MsIGl0ZW1UaGVtZSwgaXRlbUljb24sIGljb24sIGEsCgkJCWlzRGl2aWRlciwgc3RhcnRDb3VudCwgbmV3U3RhcnRDb3VudCwgdmFsdWUsIGxhc3QsIHNwbGl0dGhlbWUsIHNwbGl0VGhlbWVDbGFzcywgc3BsaXRpY29uLAoJCQlhbHRCdXR0b25DbGFzcywgZGl2aWRlclRoZW1lLCBsaSwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJJGxpc3QgPSB0aGlzLmVsZW1lbnQsCgkJCW9sID0gISEkLm5vZGVOYW1lKCAkbGlzdFsgMCBdLCAib2wiICksCgkJCXN0YXJ0ID0gJGxpc3QuYXR0ciggInN0YXJ0IiApLAoJCQlpdGVtQ2xhc3NEaWN0ID0ge30sCgkJCWNvdW50QnViYmxlcyA9ICRsaXN0LmZpbmQoICIudWktbGktY291bnQiICksCgkJCWNvdW50VGhlbWUgPSBnZXRBdHRyKCAkbGlzdFsgMCBdLCAiY291bnR0aGVtZSIgKSB8fCB0aGlzLm9wdGlvbnMuY291bnRUaGVtZSwKCQkJY291bnRUaGVtZUNsYXNzID0gY291bnRUaGVtZSA/ICJ1aS1ib2R5LSIgKyBjb3VudFRoZW1lIDogInVpLWJvZHktaW5oZXJpdCI7CgoJCWlmICggby50aGVtZSApIHsKCQkJJGxpc3QuYWRkQ2xhc3MoICJ1aS1ncm91cC10aGVtZS0iICsgby50aGVtZSApOwoJCX0KCgkJLy8gQ2hlY2sgaWYgYSBzdGFydCBhdHRyaWJ1dGUgaGFzIGJlZW4gc2V0IHdoaWxlIHRha2luZyBhIHZhbHVlIG9mIDAgaW50byBhY2NvdW50CgkJaWYgKCBvbCAmJiAoIHN0YXJ0IHx8IHN0YXJ0ID09PSAwICkgKSB7CgkJCXN0YXJ0Q291bnQgPSBwYXJzZUludCggc3RhcnQsIDEwICkgLSAxOwoJCQkkbGlzdC5jc3MoICJjb3VudGVyLXJlc2V0IiwgImxpc3RudW1iZXJpbmcgIiArIHN0YXJ0Q291bnQgKTsKCQl9CgoJCXRoaXMuX2JlZm9yZUxpc3R2aWV3UmVmcmVzaCgpOwoKCQlsaSA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCAkbGlzdFsgMCBdLCAibGkiLCAiTEkiICk7CgoJCWZvciAoIHBvcyA9IDAsIG51bWxpID0gbGkubGVuZ3RoOyBwb3MgPCBudW1saTsgcG9zKysgKSB7CgkJCWl0ZW0gPSBsaS5lcSggcG9zICk7CgkJCWl0ZW1DbGFzcyA9ICIiOwoKCQkJaWYgKCBjcmVhdGUgfHwgaXRlbVsgMCBdLmNsYXNzTmFtZS5zZWFyY2goIC9cYnVpLWxpLXN0YXRpY1xifFxidWktbGktZGl2aWRlclxiLyApIDwgMCApIHsKCQkJCWEgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggaXRlbVsgMCBdLCAiYSIsICJBIiApOwoJCQkJaXNEaXZpZGVyID0gKCBnZXRBdHRyKCBpdGVtWyAwIF0sICJyb2xlIiApID09PSAibGlzdC1kaXZpZGVyIiApOwoJCQkJdmFsdWUgPSBpdGVtLmF0dHIoICJ2YWx1ZSIgKTsKCQkJCWl0ZW1UaGVtZSA9IGdldEF0dHIoIGl0ZW1bIDAgXSwgInRoZW1lIiApOwoKCQkJCWlmICggYS5sZW5ndGggJiYgYVsgMCBdLmNsYXNzTmFtZS5zZWFyY2goIC9cYnVpLWJ0blxiLyApIDwgMCAmJiAhaXNEaXZpZGVyICkgewoJCQkJCWl0ZW1JY29uID0gZ2V0QXR0ciggaXRlbVsgMCBdLCAiaWNvbiIgKTsKCQkJCQlpY29uID0gKCBpdGVtSWNvbiA9PT0gZmFsc2UgKSA/IGZhbHNlIDogKCBpdGVtSWNvbiB8fCBvLmljb24gKTsKCgkJCQkJLy8gVE9ETzogUmVtb3ZlIGluIDEuNSB0b2dldGhlciB3aXRoIGxpbmtzLmpzIChsaW5rcy5qcyAvIC51aS1saW5rIGRlcHJlY2F0ZWQgaW4gMS40KQoJCQkJCWEucmVtb3ZlQ2xhc3MoICJ1aS1saW5rIiApOwoKCQkJCQlidXR0b25DbGFzcyA9ICJ1aS1idG4iOwoKCQkJCQlpZiAoIGl0ZW1UaGVtZSApIHsKCQkJCQkJYnV0dG9uQ2xhc3MgKz0gIiB1aS1idG4tIiArIGl0ZW1UaGVtZTsKCQkJCQl9CgoJCQkJCWlmICggYS5sZW5ndGggPiAxICkgewoJCQkJCQlpdGVtQ2xhc3MgPSAidWktbGktaGFzLWFsdCI7CgoJCQkJCQlsYXN0ID0gYS5sYXN0KCk7CgkJCQkJCXNwbGl0dGhlbWUgPSBnZXRBdHRyKCBsYXN0WyAwIF0sICJ0aGVtZSIgKSB8fCBvLnNwbGl0VGhlbWUgfHwgZ2V0QXR0ciggaXRlbVsgMCBdLCAidGhlbWUiLCB0cnVlICk7CgkJCQkJCXNwbGl0VGhlbWVDbGFzcyA9IHNwbGl0dGhlbWUgPyAiIHVpLWJ0bi0iICsgc3BsaXR0aGVtZSA6ICIiOwoJCQkJCQlzcGxpdGljb24gPSBnZXRBdHRyKCBsYXN0WyAwIF0sICJpY29uIiApIHx8IGdldEF0dHIoIGl0ZW1bIDAgXSwgImljb24iICkgfHwgby5zcGxpdEljb247CgkJCQkJCWFsdEJ1dHRvbkNsYXNzID0gInVpLWJ0biB1aS1idG4taWNvbi1ub3RleHQgdWktaWNvbi0iICsgc3BsaXRpY29uICsgc3BsaXRUaGVtZUNsYXNzOwoKCQkJCQkJbGFzdAoJCQkJCQkJLmF0dHIoICJ0aXRsZSIsICQudHJpbSggbGFzdC5nZXRFbmNvZGVkVGV4dCgpICkgKQoJCQkJCQkJLmFkZENsYXNzKCBhbHRCdXR0b25DbGFzcyApCgkJCQkJCQkuZW1wdHkoKTsKCQkJCQl9IGVsc2UgaWYgKCBpY29uICkgewoJCQkJCQlidXR0b25DbGFzcyArPSAiIHVpLWJ0bi1pY29uLWxlZnQgdWktaWNvbi0iICsgaWNvbjsKCQkJCQl9CgoJCQkJCWEuZmlyc3QoKS5hZGRDbGFzcyggYnV0dG9uQ2xhc3MgKTsKCQkJCX0gZWxzZSBpZiAoIGlzRGl2aWRlciApIHsKCQkJCQlkaXZpZGVyVGhlbWUgPSAoIGdldEF0dHIoIGl0ZW1bIDAgXSwgInRoZW1lIiApIHx8IG8uZGl2aWRlclRoZW1lIHx8IG8udGhlbWUgKTsKCgkJCQkJaXRlbUNsYXNzID0gInVpLWxpLWRpdmlkZXIgdWktYmFyLSIgKyAoIGRpdmlkZXJUaGVtZSA/IGRpdmlkZXJUaGVtZSA6ICJpbmhlcml0IiApOwoKCQkJCQlpdGVtLmF0dHIoICJyb2xlIiwgImhlYWRpbmciICk7CgkJCQl9IGVsc2UgaWYgKCBhLmxlbmd0aCA8PSAwICkgewoJCQkJCWl0ZW1DbGFzcyA9ICJ1aS1saS1zdGF0aWMgdWktYm9keS0iICsgKCBpdGVtVGhlbWUgPyBpdGVtVGhlbWUgOiAiaW5oZXJpdCIgKTsKCQkJCX0KCQkJCWlmICggb2wgJiYgdmFsdWUgKSB7CgkJCQkJbmV3U3RhcnRDb3VudCA9IHBhcnNlSW50KCB2YWx1ZSAsIDEwICkgLSAxOwoKCQkJCQlpdGVtLmNzcyggImNvdW50ZXItcmVzZXQiLCAibGlzdG51bWJlcmluZyAiICsgbmV3U3RhcnRDb3VudCApOwoJCQkJfQoJCQl9CgoJCQkvLyBJbnN0ZWFkIG9mIHNldHRpbmcgaXRlbSBjbGFzcyBkaXJlY3RseSBvbiB0aGUgbGlzdCBpdGVtCgkJCS8vIGF0IHRoaXMgcG9pbnQgaW4gdGltZSwgcHVzaCB0aGUgaXRlbSBpbnRvIGEgZGljdGlvbmFyeQoJCQkvLyB0aGF0IHRlbGxzIHVzIHdoYXQgY2xhc3MgdG8gc2V0IG9uIGl0IHNvIHdlIGNhbiBkbyB0aGlzIGFmdGVyIHRoaXMKCQkJLy8gcHJvY2Vzc2luZyBsb29wIGlzIGZpbmlzaGVkLgoKCQkJaWYgKCAhaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKSB7CgkJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSA9IFtdOwoJCQl9CgoJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXS5wdXNoKCBpdGVtWyAwIF0gKTsKCQl9CgoJCS8vIFNldCB0aGUgYXBwcm9wcmlhdGUgbGlzdHZpZXcgaXRlbSBjbGFzc2VzIG9uIGVhY2ggbGlzdCBpdGVtLgoJCS8vIFRoZSBtYWluIHJlYXNvbiB3ZSBkaWRuJ3QgZG8gdGhpcwoJCS8vIGluIHRoZSBmb3ItbG9vcCBhYm92ZSBpcyBiZWNhdXNlIHdlIGNhbiBlbGltaW5hdGUgcGVyLWl0ZW0gZnVuY3Rpb24gb3ZlcmhlYWQKCQkvLyBieSBjYWxsaW5nIGFkZENsYXNzKCkgYW5kIGNoaWxkcmVuKCkgb25jZSBvciB0d2ljZSBhZnRlcndhcmRzLiBUaGlzCgkJLy8gY2FuIGdpdmUgdXMgYSBzaWduaWZpY2FudCBib29zdCBvbiBwbGF0Zm9ybXMgbGlrZSBXUDcuNS4KCgkJZm9yICggaXRlbUNsYXNzIGluIGl0ZW1DbGFzc0RpY3QgKSB7CgkJCSQoIGl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdICkuYWRkQ2xhc3MoIGl0ZW1DbGFzcyApOwoJCX0KCgkJY291bnRCdWJibGVzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktbGktaGFzLWNvdW50IiApOwoJCX0pOwoJCWlmICggY291bnRUaGVtZUNsYXNzICkgewoJCQljb3VudEJ1YmJsZXMuYWRkQ2xhc3MoIGNvdW50VGhlbWVDbGFzcyApOwoJCX0KCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQuIEZyb20gMS41IHlvdSBoYXZlIHRvIGFkZCBjbGFzcyB1aS1saS1oYXMtdGh1bWIgb3IgdWktbGktaGFzLWljb24gdG8gdGhlIExJLgoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggbGkgKTsKCQl0aGlzLl9hZGRUaHVtYkNsYXNzZXMoIGxpLmZpbmQoICIudWktYnRuIiApICk7CgoJCXRoaXMuX2FmdGVyTGlzdHZpZXdSZWZyZXNoKCk7CgoJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGxpLCB0aGlzLl9nZXRWaXNpYmxlcyggbGksIGNyZWF0ZSApLCBjcmVhdGUgKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgpmdW5jdGlvbiBkZWZhdWx0QXV0b2RpdmlkZXJzU2VsZWN0b3IoIGVsdCApIHsKCS8vIGxvb2sgZm9yIHRoZSB0ZXh0IGluIHRoZSBnaXZlbiBlbGVtZW50Cgl2YXIgdGV4dCA9ICQudHJpbSggZWx0LnRleHQoKSApIHx8IG51bGw7CgoJaWYgKCAhdGV4dCApIHsKCQlyZXR1cm4gbnVsbDsKCX0KCgkvLyBjcmVhdGUgdGhlIHRleHQgZm9yIHRoZSBkaXZpZGVyIChmaXJzdCB1cHBlcmNhc2VkIGxldHRlcikKCXRleHQgPSB0ZXh0LnNsaWNlKCAwLCAxICkudG9VcHBlckNhc2UoKTsKCglyZXR1cm4gdGV4dDsKfQoKJC53aWRnZXQoICJtb2JpbGUubGlzdHZpZXciLCAkLm1vYmlsZS5saXN0dmlldywgewoJb3B0aW9uczogewoJCWF1dG9kaXZpZGVyczogZmFsc2UsCgkJYXV0b2RpdmlkZXJzU2VsZWN0b3I6IGRlZmF1bHRBdXRvZGl2aWRlcnNTZWxlY3RvcgoJfSwKCglfYmVmb3JlTGlzdHZpZXdSZWZyZXNoOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5hdXRvZGl2aWRlcnMgKSB7CgkJCXRoaXMuX3JlcGxhY2VEaXZpZGVycygpOwoJCQl0aGlzLl9zdXBlckFwcGx5KCBhcmd1bWVudHMgKTsKCQl9Cgl9LAoKCV9yZXBsYWNlRGl2aWRlcnM6IGZ1bmN0aW9uKCkgewoJCXZhciBpLCBsaXMsIGxpLCBkaXZpZGVyVGV4dCwKCQkJbGFzdERpdmlkZXJUZXh0ID0gbnVsbCwKCQkJbGlzdCA9IHRoaXMuZWxlbWVudCwKCQkJZGl2aWRlcjsKCgkJbGlzdC5jaGlsZHJlbiggImxpOmpxbURhdGEocm9sZT0nbGlzdC1kaXZpZGVyJykiICkucmVtb3ZlKCk7CgoJCWxpcyA9IGxpc3QuY2hpbGRyZW4oICJsaSIgKTsKCgkJZm9yICggaSA9IDA7IGkgPCBsaXMubGVuZ3RoIDsgaSsrICkgewoJCQlsaSA9IGxpc1sgaSBdOwoJCQlkaXZpZGVyVGV4dCA9IHRoaXMub3B0aW9ucy5hdXRvZGl2aWRlcnNTZWxlY3RvciggJCggbGkgKSApOwoKCQkJaWYgKCBkaXZpZGVyVGV4dCAmJiBsYXN0RGl2aWRlclRleHQgIT09IGRpdmlkZXJUZXh0ICkgewoJCQkJZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJsaSIgKTsKCQkJCWRpdmlkZXIuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBkaXZpZGVyVGV4dCApICk7CgkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGUiLCAibGlzdC1kaXZpZGVyIiApOwoJCQkJbGkucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoIGRpdmlkZXIsIGxpICk7CgkJCX0KCgkJCWxhc3REaXZpZGVyVGV4dCA9IGRpdmlkZXJUZXh0OwoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciByZGl2aWRlciA9IC8oXnxccyl1aS1saS1kaXZpZGVyKCR8XHMpLywKCXJoaWRkZW4gPSAvKF58XHMpdWktc2NyZWVuLWhpZGRlbigkfFxzKS87CgokLndpZGdldCggIm1vYmlsZS5saXN0dmlldyIsICQubW9iaWxlLmxpc3R2aWV3LCB7CglvcHRpb25zOiB7CgkJaGlkZURpdmlkZXJzOiBmYWxzZQoJfSwKCglfYWZ0ZXJMaXN0dmlld1JlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBpdGVtcywgaWR4LCBpdGVtLCBoaWRlRGl2aWRlciA9IHRydWU7CgoJCXRoaXMuX3N1cGVyQXBwbHkoIGFyZ3VtZW50cyApOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5oaWRlRGl2aWRlcnMgKSB7CgkJCWl0ZW1zID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoIHRoaXMuZWxlbWVudFsgMCBdLCAibGkiLCAiTEkiICk7CgkJCWZvciAoIGlkeCA9IGl0ZW1zLmxlbmd0aCAtIDEgOyBpZHggPiAtMSA7IGlkeC0tICkgewoJCQkJaXRlbSA9IGl0ZW1zWyBpZHggXTsKCQkJCWlmICggaXRlbS5jbGFzc05hbWUubWF0Y2goIHJkaXZpZGVyICkgKSB7CgkJCQkJaWYgKCBoaWRlRGl2aWRlciApIHsKCQkJCQkJaXRlbS5jbGFzc05hbWUgPSBpdGVtLmNsYXNzTmFtZSArICIgdWktc2NyZWVuLWhpZGRlbiI7CgkJCQkJfQoJCQkJCWhpZGVEaXZpZGVyID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJaWYgKCAhaXRlbS5jbGFzc05hbWUubWF0Y2goIHJoaWRkZW4gKSApIHsKCQkJCQkJaGlkZURpdmlkZXIgPSBmYWxzZTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5ub2pzID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCSQoICI6anFtRGF0YShyb2xlPSdub2pzJykiLCB0YXJnZXQgKS5hZGRDbGFzcyggInVpLW5vanMiICk7Cn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgPSB7CglfaGFuZGxlRm9ybVJlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LmNsb3Nlc3QoICJmb3JtIiApLCB7CgkJCXJlc2V0OiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuX2RlbGF5KCAiX3Jlc2V0IiApOwoJCQl9CgkJfSk7Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CgovKgoqICJjaGVja2JveHJhZGlvIiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY2hlY2tib3hyYWRpbyIsICQuZXh0ZW5kKCB7CgoJaW5pdFNlbGVjdG9yOiAiaW5wdXQ6bm90KCA6anFtRGF0YShyb2xlPSdmbGlwc3dpdGNoJyApIClbdHlwZT0nY2hlY2tib3gnXSxpbnB1dFt0eXBlPSdyYWRpbyddOm5vdCggOmpxbURhdGEocm9sZT0nZmxpcHN3aXRjaCcgKSkiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogImluaGVyaXQiLAoJCW1pbmk6IGZhbHNlLAoJCXdyYXBwZXJDbGFzczogbnVsbCwKCQllbmhhbmNlZDogZmFsc2UsCgkJaWNvbnBvczogInJpZ2h0IgoKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgaW5wdXQgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWluaGVyaXRBdHRyID0gZnVuY3Rpb24oIGlucHV0LCBkYXRhQXR0ciApIHsKCQkJCXJldHVybiBpbnB1dC5qcW1EYXRhKCBkYXRhQXR0ciApIHx8CgkJCQkJaW5wdXQuY2xvc2VzdCggImZvcm0sIGZpZWxkc2V0IiApLmpxbURhdGEoIGRhdGFBdHRyICk7CgkJCX0sCgkJCS8vIE5PVEU6IFdpbmRvd3MgUGhvbmUgY291bGQgbm90IGZpbmQgdGhlIGxhYmVsIHRocm91Z2ggYSBzZWxlY3RvcgoJCQkvLyBmaWx0ZXIgd29ya3MgdGhvdWdoLgoJCQlwYXJlbnRMYWJlbCA9IGlucHV0LmNsb3Nlc3QoICJsYWJlbCIgKSwKCQkJbGFiZWwgPSBwYXJlbnRMYWJlbC5sZW5ndGggPyBwYXJlbnRMYWJlbCA6CgkJCQlpbnB1dAoJCQkJCS5jbG9zZXN0KCAiZm9ybSwgZmllbGRzZXQsIDpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkKCQkJCQkuZmluZCggImxhYmVsIiApCgkJCQkJLmZpbHRlciggIltmb3I9JyIgKyAkLm1vYmlsZS5wYXRoLmhhc2hUb1NlbGVjdG9yKCBpbnB1dFswXS5pZCApICsgIiddIiApCgkJCQkJLmZpcnN0KCksCgkJCWlucHV0dHlwZSA9IGlucHV0WzBdLnR5cGUsCgkJCWNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgaW5wdXR0eXBlICsgIi1vbiIsCgkJCXVuY2hlY2tlZENsYXNzID0gInVpLSIgKyBpbnB1dHR5cGUgKyAiLW9mZiI7CgoJCWlmICggaW5wdXR0eXBlICE9PSAiY2hlY2tib3giICYmIGlucHV0dHlwZSAhPT0gInJhZGlvIiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCB0aGlzLmVsZW1lbnRbMF0uZGlzYWJsZWQgKSB7CgkJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IHRydWU7CgkJfQoKCQlvLmljb25wb3MgPSBpbmhlcml0QXR0ciggaW5wdXQsICJpY29ucG9zIiApIHx8IGxhYmVsLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29ucG9zIiApIHx8IG8uaWNvbnBvcywKCgkJLy8gRXN0YWJsaXNoIG9wdGlvbnMKCQlvLm1pbmkgPSBpbmhlcml0QXR0ciggaW5wdXQsICJtaW5pIiApIHx8IG8ubWluaTsKCgkJLy8gRXhwb3NlIGZvciBvdGhlciBtZXRob2RzCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJaW5wdXQ6IGlucHV0LAoJCQlsYWJlbDogbGFiZWwsCgkJCXBhcmVudExhYmVsOiBwYXJlbnRMYWJlbCwKCQkJaW5wdXR0eXBlOiBpbnB1dHR5cGUsCgkJCWNoZWNrZWRDbGFzczogY2hlY2tlZENsYXNzLAoJCQl1bmNoZWNrZWRDbGFzczogdW5jaGVja2VkQ2xhc3MKCQl9KTsKCgkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9lbmhhbmNlKCk7CgkJfQoKCQl0aGlzLl9vbiggbGFiZWwsIHsKCQkJdm1vdXNlb3ZlcjogIl9oYW5kbGVMYWJlbFZNb3VzZU92ZXIiLAoJCQl2Y2xpY2s6ICJfaGFuZGxlTGFiZWxWQ2xpY2siCgkJfSk7CgoJCXRoaXMuX29uKCBpbnB1dCwgewoJCQl2bW91c2Vkb3duOiAiX2NhY2hlVmFscyIsCgkJCXZjbGljazogIl9oYW5kbGVJbnB1dFZDbGljayIsCgkJCWZvY3VzOiAiX2hhbmRsZUlucHV0Rm9jdXMiLAoJCQlibHVyOiAiX2hhbmRsZUlucHV0Qmx1ciIKCQl9KTsKCgkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmxhYmVsLmFkZENsYXNzKCAidWktYnRuIHVpLWNvcm5lci1hbGwiKTsKCgkJaWYgKCB0aGlzLnBhcmVudExhYmVsLmxlbmd0aCA+IDAgKSB7CgkJCXRoaXMuaW5wdXQuYWRkKCB0aGlzLmxhYmVsICkud3JhcEFsbCggdGhpcy5fd3JhcHBlcigpICk7CgkJfSBlbHNlIHsKCQkJLy90aGlzLmVsZW1lbnQucmVwbGFjZVdpdGgoIHRoaXMuaW5wdXQuYWRkKCB0aGlzLmxhYmVsICkud3JhcEFsbCggdGhpcy5fd3JhcHBlcigpICkgKTsKCQkJdGhpcy5lbGVtZW50LndyYXAoIHRoaXMuX3dyYXBwZXIoKSApOwoJCQl0aGlzLmVsZW1lbnQucGFyZW50KCkucHJlcGVuZCggdGhpcy5sYWJlbCApOwoJCX0KCgkJLy8gV3JhcCB0aGUgaW5wdXQgKyBsYWJlbCBpbiBhIGRpdgoKCQl0aGlzLl9zZXRPcHRpb25zKHsKCQkJInRoZW1lIjogdGhpcy5vcHRpb25zLnRoZW1lLAoJCQkiaWNvbnBvcyI6IHRoaXMub3B0aW9ucy5pY29ucG9zLAoJCQkibWluaSI6IHRoaXMub3B0aW9ucy5taW5pCgkJfSk7CgoJfSwKCglfd3JhcHBlcjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2IGNsYXNzPSciICArCgkJCSggdGhpcy5vcHRpb25zLndyYXBwZXJDbGFzcyA/IHRoaXMub3B0aW9ucy53cmFwcGVyQ2xhc3MgOiAiIiApICsKCQkJIiB1aS0iICsgdGhpcy5pbnB1dHR5cGUgKwoJCQkoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCA/ICIgdWktc3RhdGUtZGlzYWJsZWQiIDogIiIgKSArICInID4iICk7Cgl9LAoKCV9oYW5kbGVJbnB1dEZvY3VzOiBmdW5jdGlvbigpIHsKCQl0aGlzLmxhYmVsLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7Cgl9LAoKCV9oYW5kbGVJbnB1dEJsdXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMubGFiZWwucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCX0sCgoJX2hhbmRsZUlucHV0VkNsaWNrOiBmdW5jdGlvbigpIHsKCQl2YXIgJHRoaXMgPSB0aGlzLmVsZW1lbnQ7CgoJCS8vIEFkZHMgY2hlY2tlZCBhdHRyaWJ1dGUgdG8gY2hlY2tlZCBpbnB1dCB3aGVuIGtleWJvYXJkIGlzIHVzZWQKCQlpZiAoICR0aGlzLmlzKCAiOmNoZWNrZWQiICkgKSB7CgoJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIHRydWUpOwoJCQl0aGlzLl9nZXRJbnB1dFNldCgpLm5vdCggJHRoaXMgKS5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJfSBlbHNlIHsKCQkJJHRoaXMucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCX0KCgkJdGhpcy5fdXBkYXRlQWxsKCk7Cgl9LAoKCV9oYW5kbGVMYWJlbFZNb3VzZU92ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIHRoaXMubGFiZWwucGFyZW50KCkuaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKSApIHsKCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJfQoJfSwKCglfaGFuZGxlTGFiZWxWQ2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgaW5wdXQgPSB0aGlzLmVsZW1lbnQ7CgoJCWlmICggaW5wdXQuaXMoICI6ZGlzYWJsZWQiICkgKSB7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX2NhY2hlVmFscygpOwoKCQlpbnB1dC5wcm9wKCAiY2hlY2tlZCIsIHRoaXMuaW5wdXR0eXBlID09PSAicmFkaW8iICYmIHRydWUgfHwgIWlucHV0LnByb3AoICJjaGVja2VkIiApICk7CgoJCS8vIHRyaWdnZXIgY2xpY2sgaGFuZGxlcidzIGJvdW5kIGRpcmVjdGx5IHRvIHRoZSBpbnB1dCBhcyBhIHN1YnN0aXR1dGUgZm9yCgkJLy8gaG93IGxhYmVsIGNsaWNrcyBiZWhhdmUgbm9ybWFsbHkgaW4gdGhlIGJyb3dzZXJzCgkJLy8gVE9ETzogaXQgd291bGQgYmUgbmljZSB0byBsZXQgdGhlIGJyb3dzZXIncyBoYW5kbGUgdGhlIGNsaWNrcyBhbmQgcGFzcyB0aGVtCgkJLy8gICAgICAgdGhyb3VnaCB0byB0aGUgYXNzb2NpYXRlIGlucHV0LiB3ZSBjYW4gc3dhbGxvdyB0aGF0IGNsaWNrIGF0IHRoZSBwYXJlbnQKCQkvLyAgICAgICB3cmFwcGVyIGVsZW1lbnQgbGV2ZWwKCQlpbnB1dC50cmlnZ2VySGFuZGxlciggImNsaWNrIiApOwoKCQkvLyBJbnB1dCBzZXQgZm9yIGNvbW1vbiByYWRpbyBidXR0b25zIHdpbGwgY29udGFpbiBhbGwgdGhlIHJhZGlvCgkJLy8gYnV0dG9ucywgYnV0IHdpbGwgbm90IGZvciBjaGVja2JveGVzLiBjbGVhcmluZyB0aGUgY2hlY2tlZCBzdGF0dXMKCQkvLyBvZiBvdGhlciByYWRpb3MgZW5zdXJlcyB0aGUgYWN0aXZlIGJ1dHRvbiBzdGF0ZSBpcyBhcHBsaWVkIHByb3Blcmx5CgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5ub3QoIGlucHV0ICkucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoKCQl0aGlzLl91cGRhdGVBbGwoKTsKCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCV9jYWNoZVZhbHM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2dldElucHV0U2V0KCkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5hdHRyKCJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJjYWNoZVZhbCIsIHRoaXMuY2hlY2tlZCApOwoJCX0pOwoJfSwKCgkvL3JldHVybnMgZWl0aGVyIGEgc2V0IG9mIHJhZGlvcyB3aXRoIHRoZSBzYW1lIG5hbWUgYXR0cmlidXRlLCBvciBhIHNpbmdsZSBjaGVja2JveAoJX2dldElucHV0U2V0OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuaW5wdXR0eXBlID09PSAiY2hlY2tib3giICkgewoJCQlyZXR1cm4gdGhpcy5lbGVtZW50OwoJCX0KCgkJcmV0dXJuIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSwgOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKQoJCQkuZmluZCggImlucHV0W25hbWU9JyIgKyB0aGlzLmVsZW1lbnRbIDAgXS5uYW1lICsgIiddW3R5cGU9JyIgKyB0aGlzLmlucHV0dHlwZSArICInXSIgKTsKCX0sCgoJX3VwZGF0ZUFsbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQlpZiAoIHRoaXMuY2hlY2tlZCB8fCBzZWxmLmlucHV0dHlwZSA9PT0gImNoZWNrYm94IiApIHsKCQkJCSR0aGlzLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCX0KCQl9KQoJCS5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCX0sCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJLy8gSXMgdGhlIHdpZGdldCBzdXBwb3NlZCB0byBkaXNwbGF5IGFuIGljb24/CglfaGFzSWNvbjogZnVuY3Rpb24oKSB7CgkJdmFyIGNvbnRyb2xncm91cCwgY29udHJvbGdyb3VwV2lkZ2V0LAoJCQljb250cm9sZ3JvdXBDb25zdHJ1Y3RvciA9ICQubW9iaWxlLmNvbnRyb2xncm91cDsKCgkJLy8gSWYgdGhlIGNvbnRyb2xncm91cCB3aWRnZXQgaXMgZGVmaW5lZCAuLi4KCQlpZiAoIGNvbnRyb2xncm91cENvbnN0cnVjdG9yICkgewoJCQljb250cm9sZ3JvdXAgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCgKCQkJCSI6bW9iaWxlLWNvbnRyb2xncm91cCwiICsKCQkJCWNvbnRyb2xncm91cENvbnN0cnVjdG9yLnByb3RvdHlwZS5pbml0U2VsZWN0b3IgKTsKCgkJCS8vIC4uLiBhbmQgdGhlIGNoZWNrYm94IGlzIGluIGEgY29udHJvbGdyb3VwIC4uLgoJCQlpZiAoIGNvbnRyb2xncm91cC5sZW5ndGggPiAwICkgewoKCQkJCS8vIC4uLiBsb29rIGZvciBhIGNvbnRyb2xncm91cCB3aWRnZXQgaW5zdGFuY2UsIGFuZCAuLi4KCQkJCWNvbnRyb2xncm91cFdpZGdldCA9ICQuZGF0YSggY29udHJvbGdyb3VwWyAwIF0sICJtb2JpbGUtY29udHJvbGdyb3VwIiApOwoKCQkJCS8vIC4uLiBpZiBmb3VuZCwgZGVjaWRlIGJhc2VkIG9uIHRoZSBvcHRpb24gdmFsdWUsIC4uLgoJCQkJcmV0dXJuICggKCBjb250cm9sZ3JvdXBXaWRnZXQgPyBjb250cm9sZ3JvdXBXaWRnZXQub3B0aW9ucy50eXBlIDoKCgkJCQkJLy8gLi4uIG90aGVyd2lzZSBkZWNpZGUgYmFzZWQgb24gdGhlICJ0eXBlIiBkYXRhIGF0dHJpYnV0ZS4KCQkJCQljb250cm9sZ3JvdXAuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGUiICkgKSAhPT0gImhvcml6b250YWwiICk7CgkJCX0KCQl9CgoJCS8vIE5vcm1hbGx5LCB0aGUgd2lkZ2V0IGRpc3BsYXlzIGFuIGljb24uCgkJcmV0dXJuIHRydWU7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBoYXNJY29uID0gdGhpcy5faGFzSWNvbigpLAoJCQlpc0NoZWNrZWQgPSB0aGlzLmVsZW1lbnRbIDAgXS5jaGVja2VkLAoJCQlhY3RpdmUgPSAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcywKCQkJaWNvbnBvc0NsYXNzID0gInVpLWJ0bi1pY29uLSIgKyB0aGlzLm9wdGlvbnMuaWNvbnBvcywKCQkJYWRkQ2xhc3NlcyA9IFtdLAoJCQlyZW1vdmVDbGFzc2VzID0gW107CgoJCWlmICggaGFzSWNvbiApIHsKCQkJcmVtb3ZlQ2xhc3Nlcy5wdXNoKCBhY3RpdmUgKTsKCQkJYWRkQ2xhc3Nlcy5wdXNoKCBpY29ucG9zQ2xhc3MgKTsKCQl9IGVsc2UgewoJCQlyZW1vdmVDbGFzc2VzLnB1c2goIGljb25wb3NDbGFzcyApOwoJCQkoIGlzQ2hlY2tlZCA/IGFkZENsYXNzZXMgOiByZW1vdmVDbGFzc2VzICkucHVzaCggYWN0aXZlICk7CgkJfQoKCQlpZiAoIGlzQ2hlY2tlZCApIHsKCQkJYWRkQ2xhc3Nlcy5wdXNoKCB0aGlzLmNoZWNrZWRDbGFzcyApOwoJCQlyZW1vdmVDbGFzc2VzLnB1c2goIHRoaXMudW5jaGVja2VkQ2xhc3MgKTsKCQl9IGVsc2UgewoJCQlhZGRDbGFzc2VzLnB1c2goIHRoaXMudW5jaGVja2VkQ2xhc3MgKTsKCQkJcmVtb3ZlQ2xhc3Nlcy5wdXNoKCB0aGlzLmNoZWNrZWRDbGFzcyApOwoJCX0KCgkJdGhpcy5sYWJlbAoJCQkuYWRkQ2xhc3MoIGFkZENsYXNzZXMuam9pbiggIiAiICkgKQoJCQkucmVtb3ZlQ2xhc3MoIHJlbW92ZUNsYXNzZXMuam9pbiggIiAiICkgKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5sYWJlbC5wYXJlbnQoKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBsYWJlbCA9IHRoaXMubGFiZWwsCgkJCWN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlvdXRlciA9IHRoaXMud2lkZ2V0KCksCgkJCWhhc0ljb24gPSB0aGlzLl9oYXNJY29uKCk7CgoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLmlucHV0LnByb3AoICJkaXNhYmxlZCIsICEhb3B0aW9ucy5kaXNhYmxlZCApOwoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiwgISFvcHRpb25zLmRpc2FibGVkICk7CgkJfQoJCWlmICggb3B0aW9ucy5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktbWluaSIsICEhb3B0aW9ucy5taW5pICk7CgkJfQoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlsYWJlbAoJCQkJLnJlbW92ZUNsYXNzKCAidWktYnRuLSIgKyBjdXJyZW50T3B0aW9ucy50aGVtZSApCgkJCQkuYWRkQ2xhc3MoICJ1aS1idG4tIiArIG9wdGlvbnMudGhlbWUgKTsKCQl9CgkJaWYgKCBvcHRpb25zLndyYXBwZXJDbGFzcyAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlcgoJCQkJLnJlbW92ZUNsYXNzKCBjdXJyZW50T3B0aW9ucy53cmFwcGVyQ2xhc3MgKQoJCQkJLmFkZENsYXNzKCBvcHRpb25zLndyYXBwZXJDbGFzcyApOwoJCX0KCQlpZiAoIG9wdGlvbnMuaWNvbnBvcyAhPT0gdW5kZWZpbmVkICYmIGhhc0ljb24gKSB7CgkJCWxhYmVsLnJlbW92ZUNsYXNzKCAidWktYnRuLWljb24tIiArIGN1cnJlbnRPcHRpb25zLmljb25wb3MgKS5hZGRDbGFzcyggInVpLWJ0bi1pY29uLSIgKyBvcHRpb25zLmljb25wb3MgKTsKCQl9IGVsc2UgaWYgKCAhaGFzSWNvbiApIHsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoICJ1aS1idG4taWNvbi0iICsgY3VycmVudE9wdGlvbnMuaWNvbnBvcyApOwoJCX0KCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfQoKfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmJ1dHRvbiIsIHsKCglpbml0U2VsZWN0b3I6ICJpbnB1dFt0eXBlPSdidXR0b24nXSwgaW5wdXRbdHlwZT0nc3VibWl0J10sIGlucHV0W3R5cGU9J3Jlc2V0J10iLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQlpY29uOiBudWxsLAoJCWljb25wb3M6ICJyaWdodCIsCgkJaWNvbnNoYWRvdzogZmFsc2UsIC8qIFRPRE86IERlcHJlY2F0ZWQgaW4gMS40LCByZW1vdmUgaW4gMS41LiAqLwoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWlubGluZTogbnVsbCwKCQltaW5pOiBudWxsLAoJCXdyYXBwZXJDbGFzczogbnVsbCwKCQllbmhhbmNlZDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCWlmICggdGhpcy5lbGVtZW50LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQl0aGlzLm9wdGlvbnMuZGlzYWJsZWQgPSB0cnVlOwoJCX0KCgkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9lbmhhbmNlKCk7CgkJfQoKCQkkLmV4dGVuZCggdGhpcywgewoJCQl3cmFwcGVyOiB0aGlzLmVsZW1lbnQucGFyZW50KCkKCQl9KTsKCgkJdGhpcy5fb24oIHsKCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy53aWRnZXQoKS5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9LAoKCQkJYmx1cjogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLndpZGdldCgpLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0KCQl9KTsKCgkJdGhpcy5yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQud3JhcCggdGhpcy5fYnV0dG9uKCkgKTsKCX0sCgoJX2J1dHRvbjogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWljb25DbGFzc2VzID0gdGhpcy5fZ2V0SWNvbkNsYXNzZXMoIHRoaXMub3B0aW9ucyApOwoKCQlyZXR1cm4gJCgiPGRpdiBjbGFzcz0ndWktYnRuIHVpLWlucHV0LWJ0biIgKwoJCQkoIG9wdGlvbnMud3JhcHBlckNsYXNzID8gIiAiICsgb3B0aW9ucy53cmFwcGVyQ2xhc3MgOiAiIiApICsKCQkJKCBvcHRpb25zLnRoZW1lID8gIiB1aS1idG4tIiArIG9wdGlvbnMudGhlbWUgOiAiIiApICsKCQkJKCBvcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIgKSArCgkJCSggb3B0aW9ucy5zaGFkb3cgPyAiIHVpLXNoYWRvdyIgOiAiIiApICsKCQkJKCBvcHRpb25zLmlubGluZSA/ICIgdWktYnRuLWlubGluZSIgOiAiIiApICsKCQkJKCBvcHRpb25zLm1pbmkgPyAiIHVpLW1pbmkiIDogIiIgKSArCgkJCSggb3B0aW9ucy5kaXNhYmxlZCA/ICIgdWktc3RhdGUtZGlzYWJsZWQiIDogIiIgKSArCgkJCSggaWNvbkNsYXNzZXMgPyAoICIgIiArIGljb25DbGFzc2VzICkgOiAiIiApICsKCQkJIicgPiIgKyB0aGlzLmVsZW1lbnQudmFsKCkgKyAiPC9kaXY+IiApOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLndyYXBwZXI7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50Lmluc2VydEJlZm9yZSggdGhpcy5idXR0b24gKTsKCQkJdGhpcy5idXR0b24ucmVtb3ZlKCk7Cgl9LAoKCV9nZXRJY29uQ2xhc3NlczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJcmV0dXJuICggb3B0aW9ucy5pY29uID8gKCAidWktaWNvbi0iICsgb3B0aW9ucy5pY29uICsKCQkJKCBvcHRpb25zLmljb25zaGFkb3cgPyAiIHVpLXNoYWRvdy1pY29uIiA6ICIiICkgKyAvKiBUT0RPOiBEZXByZWNhdGVkIGluIDEuNCwgcmVtb3ZlIGluIDEuNS4gKi8KCQkJIiB1aS1idG4taWNvbi0iICsgb3B0aW9ucy5pY29ucG9zICkgOiAiIiApOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIG91dGVyID0gdGhpcy53aWRnZXQoKTsKCgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMub3B0aW9ucy50aGVtZSApCgkJCQkuYWRkQ2xhc3MoICJ1aS1idG4tIiArIG9wdGlvbnMudGhlbWUgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJb3V0ZXIudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoJCWlmICggb3B0aW9ucy5zaGFkb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJb3V0ZXIudG9nZ2xlQ2xhc3MoICJ1aS1zaGFkb3ciLCBvcHRpb25zLnNoYWRvdyApOwoJCX0KCQlpZiAoIG9wdGlvbnMuaW5saW5lICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktYnRuLWlubGluZSIsIG9wdGlvbnMuaW5saW5lICk7CgkJfQoJCWlmICggb3B0aW9ucy5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIG9wdGlvbnMubWluaSApOwoJCX0KCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIsIG9wdGlvbnMuZGlzYWJsZWQgKTsKCQkJb3V0ZXIudG9nZ2xlQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIsIG9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5pY29uICE9PSB1bmRlZmluZWQgfHwKCQkJCW9wdGlvbnMuaWNvbnNoYWRvdyAhPT0gdW5kZWZpbmVkIHx8IC8qIFRPRE86IERlcHJlY2F0ZWQgaW4gMS40LCByZW1vdmUgaW4gMS41LiAqLwoJCQkJb3B0aW9ucy5pY29ucG9zICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMuX2dldEljb25DbGFzc2VzKCB0aGlzLm9wdGlvbnMgKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMuX2dldEljb25DbGFzc2VzKAoJCQkJCSQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zLCBvcHRpb25zICkgKSApOwoJCX0KCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5pY29uICYmIHRoaXMub3B0aW9ucy5pY29ucG9zID09PSAibm90ZXh0IiAmJiB0aGlzLmVsZW1lbnQuYXR0ciggInRpdGxlIiApICkgewoJCQl0aGlzLmVsZW1lbnQuYXR0ciggInRpdGxlIiwgdGhpcy5lbGVtZW50LnZhbCgpICk7CgkJfQoJCWlmICggIWNyZWF0ZSApIHsKCQkJdmFyIG9yaWdpbmFsRWxlbWVudCA9IHRoaXMuZWxlbWVudC5kZXRhY2goKTsKCQkJJCggdGhpcy53cmFwcGVyICkudGV4dCggdGhpcy5lbGVtZW50LnZhbCgpICkuYXBwZW5kKCBvcmlnaW5hbEVsZW1lbnQgKTsKCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkICkgewoJdmFyCW1ldGEgPSAkKCAibWV0YVtuYW1lPXZpZXdwb3J0XSIgKSwKCQlpbml0aWFsQ29udGVudCA9IG1ldGEuYXR0ciggImNvbnRlbnQiICksCgkJZGlzYWJsZWRab29tID0gaW5pdGlhbENvbnRlbnQgKyAiLG1heGltdW0tc2NhbGU9MSwgdXNlci1zY2FsYWJsZT1ubyIsCgkJZW5hYmxlZFpvb20gPSBpbml0aWFsQ29udGVudCArICIsbWF4aW11bS1zY2FsZT0xMCwgdXNlci1zY2FsYWJsZT15ZXMiLAoJCWRpc2FibGVkSW5pdGlhbGx5ID0gLyh1c2VyLXNjYWxhYmxlW1xzXSo9W1xzXSpubyl8KG1heGltdW0tc2NhbGVbXHNdKj1bXHNdKjEpWyQsXHNdLy50ZXN0KCBpbml0aWFsQ29udGVudCApOwoKCSQubW9iaWxlLnpvb20gPSAkLmV4dGVuZCgge30sIHsKCQllbmFibGVkOiAhZGlzYWJsZWRJbml0aWFsbHksCgkJbG9ja2VkOiBmYWxzZSwKCQlkaXNhYmxlOiBmdW5jdGlvbiggbG9jayApIHsKCQkJaWYgKCAhZGlzYWJsZWRJbml0aWFsbHkgJiYgISQubW9iaWxlLnpvb20ubG9ja2VkICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGRpc2FibGVkWm9vbSApOwoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gZmFsc2U7CgkJCQkkLm1vYmlsZS56b29tLmxvY2tlZCA9IGxvY2sgfHwgZmFsc2U7CgkJCX0KCQl9LAoJCWVuYWJsZTogZnVuY3Rpb24oIHVubG9jayApIHsKCQkJaWYgKCAhZGlzYWJsZWRJbml0aWFsbHkgJiYgKCAhJC5tb2JpbGUuem9vbS5sb2NrZWQgfHwgdW5sb2NrID09PSB0cnVlICkgKSB7CgkJCQltZXRhLmF0dHIoICJjb250ZW50IiwgZW5hYmxlZFpvb20gKTsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IHRydWU7CgkJCQkkLm1vYmlsZS56b29tLmxvY2tlZCA9IGZhbHNlOwoJCQl9CgkJfSwKCQlyZXN0b3JlOiBmdW5jdGlvbigpIHsKCQkJaWYgKCAhZGlzYWJsZWRJbml0aWFsbHkgKSB7CgkJCQltZXRhLmF0dHIoICJjb250ZW50IiwgaW5pdGlhbENvbnRlbnQgKTsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IHRydWU7CgkJCX0KCQl9Cgl9KTsKCn0oIGpRdWVyeSApKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUudGV4dGlucHV0IiwgewoJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ndGV4dCddLCIgKwoJCSJpbnB1dFt0eXBlPSdzZWFyY2gnXSwiICsKCQkiOmpxbURhdGEodHlwZT0nc2VhcmNoJyksIiArCgkJImlucHV0W3R5cGU9J251bWJlciddLCIgKwoJCSI6anFtRGF0YSh0eXBlPSdudW1iZXInKSwiICsKCQkiaW5wdXRbdHlwZT0ncGFzc3dvcmQnXSwiICsKCQkiaW5wdXRbdHlwZT0nZW1haWwnXSwiICsKCQkiaW5wdXRbdHlwZT0ndXJsJ10sIiArCgkJImlucHV0W3R5cGU9J3RlbCddLCIgKwoJCSJ0ZXh0YXJlYSwiICsKCQkiaW5wdXRbdHlwZT0ndGltZSddLCIgKwoJCSJpbnB1dFt0eXBlPSdkYXRlJ10sIiArCgkJImlucHV0W3R5cGU9J21vbnRoJ10sIiArCgkJImlucHV0W3R5cGU9J3dlZWsnXSwiICsKCQkiaW5wdXRbdHlwZT0nZGF0ZXRpbWUnXSwiICsKCQkiaW5wdXRbdHlwZT0nZGF0ZXRpbWUtbG9jYWwnXSwiICsKCQkiaW5wdXRbdHlwZT0nY29sb3InXSwiICsKCQkiaW5wdXQ6bm90KFt0eXBlXSksIiArCgkJImlucHV0W3R5cGU9J2ZpbGUnXSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWNvcm5lcnM6IHRydWUsCgkJbWluaTogZmFsc2UsCgkJLy8gVGhpcyBvcHRpb24gZGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MgZGV2aWNlcy4KCQlwcmV2ZW50Rm9jdXNab29tOiAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSwKCQl3cmFwcGVyQ2xhc3M6ICIiLAoJCWVuaGFuY2VkOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWlzU2VhcmNoID0gdGhpcy5lbGVtZW50LmlzKCAiW3R5cGU9J3NlYXJjaCddLCA6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSIgKSwKCQkJaXNUZXh0YXJlYSA9IHRoaXMuZWxlbWVudFsgMCBdLnRhZ05hbWUgPT09ICJURVhUQVJFQSIsCgkJCWlzUmFuZ2UgPSB0aGlzLmVsZW1lbnQuaXMoICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInR5cGU9J3JhbmdlJ10iICksCgkJCWlucHV0TmVlZHNXcmFwID0gKCAodGhpcy5lbGVtZW50LmlzKCAiaW5wdXQiICkgfHwKCQkJCXRoaXMuZWxlbWVudC5pcyggIltkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAidHlwZT0nc2VhcmNoJ10iICkgKSAmJgoJCQkJCSFpc1JhbmdlICk7CgoJCWlmICggdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIgKSApIHsKCQkJb3B0aW9ucy5kaXNhYmxlZCA9IHRydWU7CgkJfQoKCQkkLmV4dGVuZCggdGhpcywgewoJCQljbGFzc2VzOiB0aGlzLl9jbGFzc2VzRnJvbU9wdGlvbnMoKSwKCQkJaXNTZWFyY2g6IGlzU2VhcmNoLAoJCQlpc1RleHRhcmVhOiBpc1RleHRhcmVhLAoJCQlpc1JhbmdlOiBpc1JhbmdlLAoJCQlpbnB1dE5lZWRzV3JhcDogaW5wdXROZWVkc1dyYXAKCQl9KTsKCgkJdGhpcy5fYXV0b0NvcnJlY3QoKTsKCgkJaWYgKCAhb3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgkJdGhpcy5fb24oIHsKCQkJImZvY3VzIjogIl9oYW5kbGVGb2N1cyIsCgkJCSJibHVyIjogIl9oYW5kbGVCbHVyIgoJCX0pOwoKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5zZXRPcHRpb25zKHsKCQkJImRpc2FibGVkIiA6IHRoaXMuZWxlbWVudC5pcyggIjpkaXNhYmxlZCIgKQoJCX0pOwoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW1lbnRDbGFzc2VzID0gW107CgoJCWlmICggdGhpcy5pc1RleHRhcmVhICkgewoJCQllbGVtZW50Q2xhc3Nlcy5wdXNoKCAidWktaW5wdXQtdGV4dCIgKTsKCQl9CgoJCWlmICggdGhpcy5pc1RleHRhcmVhIHx8IHRoaXMuaXNSYW5nZSApIHsKCQkJZWxlbWVudENsYXNzZXMucHVzaCggInVpLXNoYWRvdy1pbnNldCIgKTsKCQl9CgoJCS8vInNlYXJjaCIgYW5kICJ0ZXh0IiBpbnB1dCB3aWRnZXRzCgkJaWYgKCB0aGlzLmlucHV0TmVlZHNXcmFwICkgewoJCQl0aGlzLmVsZW1lbnQud3JhcCggdGhpcy5fd3JhcCgpICk7CgkJfSBlbHNlIHsKCQkJZWxlbWVudENsYXNzZXMgPSBlbGVtZW50Q2xhc3Nlcy5jb25jYXQoIHRoaXMuY2xhc3NlcyApOwoJCX0KCgkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCBlbGVtZW50Q2xhc3Nlcy5qb2luKCAiICIgKSApOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAoIHRoaXMuaW5wdXROZWVkc1dyYXAgKSA/IHRoaXMuZWxlbWVudC5wYXJlbnQoKSA6IHRoaXMuZWxlbWVudDsKCX0sCgoJX2NsYXNzZXNGcm9tT3B0aW9uczogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWNsYXNzZXMgPSBbXTsKCgkJY2xhc3Nlcy5wdXNoKCAidWktYm9keS0iICsgKCAoIG9wdGlvbnMudGhlbWUgPT09IG51bGwgKSA/ICJpbmhlcml0IiA6IG9wdGlvbnMudGhlbWUgKSApOwoJCWlmICggb3B0aW9ucy5jb3JuZXJzICkgewoJCQljbGFzc2VzLnB1c2goICJ1aS1jb3JuZXItYWxsIiApOwoJCX0KCQlpZiAoIG9wdGlvbnMubWluaSApIHsKCQkJY2xhc3Nlcy5wdXNoKCAidWktbWluaSIgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmRpc2FibGVkICkgewoJCQljbGFzc2VzLnB1c2goICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCQl9CgkJaWYgKCBvcHRpb25zLndyYXBwZXJDbGFzcyApIHsKCQkJY2xhc3Nlcy5wdXNoKCBvcHRpb25zLndyYXBwZXJDbGFzcyApOwoJCX0KCgkJcmV0dXJuIGNsYXNzZXM7Cgl9LAoKCV93cmFwOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJCggIjxkaXYgY2xhc3M9JyIgKwoJCQkoIHRoaXMuaXNTZWFyY2ggPyAidWktaW5wdXQtc2VhcmNoICIgOiAidWktaW5wdXQtdGV4dCAiICkgKwoJCQl0aGlzLmNsYXNzZXMuam9pbiggIiAiICkgKyAiICIgKwoJCQkidWktc2hhZG93LWluc2V0Jz48L2Rpdj4iICk7Cgl9LAoKCV9hdXRvQ29ycmVjdDogZnVuY3Rpb24oKSB7CgkJLy8gWFhYOiBUZW1wb3Jhcnkgd29ya2Fyb3VuZCBmb3IgaXNzdWUgNzg1IChBcHBsZSBidWcgODkxMDU4OSkuCgkJLy8gICAgICBUdXJuIG9mZiBhdXRvY29ycmVjdCBhbmQgYXV0b2NvbXBsZXRlIG9uIG5vbi1pT1MgNSBkZXZpY2VzCgkJLy8gICAgICBzaW5jZSB0aGUgcG9wdXAgdGhleSB1c2UgY2FuJ3QgYmUgZGlzbWlzc2VkIGJ5IHRoZSB1c2VyLiBOb3RlCgkJLy8gICAgICB0aGF0IHdlIHRlc3QgZm9yIHRoZSBwcmVzZW5jZSBvZiB0aGUgZmVhdHVyZSBieSBsb29raW5nIGZvcgoJCS8vICAgICAgdGhlIGF1dG9jb3JyZWN0IHByb3BlcnR5IG9uIHRoZSBpbnB1dCBlbGVtZW50LiBXZSBjdXJyZW50bHkKCQkvLyAgICAgIGhhdmUgbm8gdGVzdCBmb3IgaU9TIDUgb3IgbmV3ZXIgc28gd2UncmUgdGVtcG9yYXJpbHkgdXNpbmcKCQkvLyAgICAgIHRoZSB0b3VjaE92ZXJmbG93IHN1cHBvcnQgZmxhZyBmb3IgalFNIDEuMC4gWWVzLCBJIGZlZWwgZGlydHkuCgkJLy8gICAgICAtIGpibGFzCgkJaWYgKCB0eXBlb2YgdGhpcy5lbGVtZW50WzBdLmF1dG9jb3JyZWN0ICE9PSAidW5kZWZpbmVkIiAmJgoJCQkhJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgKSB7CgoJCQkvLyBTZXQgdGhlIGF0dHJpYnV0ZSBpbnN0ZWFkIG9mIHRoZSBwcm9wZXJ0eSBqdXN0IGluIGNhc2UgdGhlcmUKCQkJLy8gaXMgY29kZSB0aGF0IGF0dGVtcHRzIHRvIG1ha2UgbW9kaWZpY2F0aW9ucyB2aWEgSFRNTC4KCQkJdGhpcy5lbGVtZW50WzBdLnNldEF0dHJpYnV0ZSggImF1dG9jb3JyZWN0IiwgIm9mZiIgKTsKCQkJdGhpcy5lbGVtZW50WzBdLnNldEF0dHJpYnV0ZSggImF1dG9jb21wbGV0ZSIsICJvZmYiICk7CgkJfQoJfSwKCglfaGFuZGxlQmx1cjogZnVuY3Rpb24oKSB7CgkJdGhpcy53aWRnZXQoKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCWlmICggdGhpcy5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJfQoJfSwKCglfaGFuZGxlRm9jdXM6IGZ1bmN0aW9uKCkgewoJCS8vIEluIG1hbnkgc2l0dWF0aW9ucywgaU9TIHdpbGwgem9vbSBpbnRvIHRoZSBpbnB1dCB1cG9uIHRhcCwgdGhpcwoJCS8vIHByZXZlbnRzIHRoYXQgZnJvbSBoYXBwZW5pbmcKCQlpZiAoIHRoaXMub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQl9CgkJdGhpcy53aWRnZXQoKS5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24gKCBvcHRpb25zICkgewoJCXZhciBvdXRlciA9IHRoaXMud2lkZ2V0KCk7CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCWlmICggISggb3B0aW9ucy5kaXNhYmxlZCA9PT0gdW5kZWZpbmVkICYmCgkJCW9wdGlvbnMubWluaSA9PT0gdW5kZWZpbmVkICYmCgkJCW9wdGlvbnMuY29ybmVycyA9PT0gdW5kZWZpbmVkICYmCgkJCW9wdGlvbnMudGhlbWUgPT09IHVuZGVmaW5lZCAmJgoJCQlvcHRpb25zLndyYXBwZXJDbGFzcyA9PT0gdW5kZWZpbmVkICkgKSB7CgoJCQlvdXRlci5yZW1vdmVDbGFzcyggdGhpcy5jbGFzc2VzLmpvaW4oICIgIiApICk7CgkJCXRoaXMuY2xhc3NlcyA9IHRoaXMuX2NsYXNzZXNGcm9tT3B0aW9ucygpOwoJCQlvdXRlci5hZGRDbGFzcyggdGhpcy5jbGFzc2VzLmpvaW4oICIgIiApICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIsICEhb3B0aW9ucy5kaXNhYmxlZCApOwoJCX0KCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQlyZXR1cm47CgkJfQoJCWlmICggdGhpcy5pbnB1dE5lZWRzV3JhcCApIHsKCQkJdGhpcy5lbGVtZW50LnVud3JhcCgpOwoJCX0KCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1pbnB1dC10ZXh0ICIgKyB0aGlzLmNsYXNzZXMuam9pbiggIiAiICkgKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnNsaWRlciIsICQuZXh0ZW5kKCB7Cglpbml0U2VsZWN0b3I6ICJpbnB1dFt0eXBlPSdyYW5nZSddLCA6anFtRGF0YSh0eXBlPSdyYW5nZScpLCA6anFtRGF0YShyb2xlPSdzbGlkZXInKSIsCgoJd2lkZ2V0RXZlbnRQcmVmaXg6ICJzbGlkZSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCXRyYWNrVGhlbWU6IG51bGwsCgkJY29ybmVyczogdHJ1ZSwKCQltaW5pOiBmYWxzZSwKCQloaWdobGlnaHQ6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQkvLyBUT0RPOiBFYWNoIG9mIHRoZXNlIHNob3VsZCBoYXZlIGNvbW1lbnRzIGV4cGxhaW4gd2hhdCB0aGV5J3JlIGZvcgoJCXZhciBzZWxmID0gdGhpcywKCQkJY29udHJvbCA9IHRoaXMuZWxlbWVudCwKCQkJdHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lIHx8ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggY29udHJvbFsgMCBdLCAidGhlbWUiICksCgkJCXRyYWNrVGhlbWVDbGFzcyA9IHRyYWNrVGhlbWUgPyAiIHVpLWJhci0iICsgdHJhY2tUaGVtZSA6ICIgdWktYmFyLWluaGVyaXQiLAoJCQljb3JuZXJDbGFzcyA9ICggdGhpcy5vcHRpb25zLmNvcm5lcnMgfHwgY29udHJvbC5qcW1EYXRhKCAiY29ybmVycyIgKSApID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiLAoJCQltaW5pQ2xhc3MgPSAoIHRoaXMub3B0aW9ucy5taW5pIHx8IGNvbnRyb2wuanFtRGF0YSggIm1pbmkiICkgKSA/ICIgdWktbWluaSIgOiAiIiwKCQkJY1R5cGUgPSBjb250cm9sWyAwIF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKCQkJaXNUb2dnbGVTd2l0Y2ggPSAoIGNUeXBlID09PSAic2VsZWN0IiApLAoJCQlpc1Jhbmdlc2xpZGVyID0gY29udHJvbC5wYXJlbnQoKS5pcyggIjpqcW1EYXRhKHJvbGU9J3Jhbmdlc2xpZGVyJykiICksCgkJCXNlbGVjdENsYXNzID0gKCBpc1RvZ2dsZVN3aXRjaCApID8gInVpLXNsaWRlci1zd2l0Y2giIDogIiIsCgkJCWNvbnRyb2xJRCA9IGNvbnRyb2wuYXR0ciggImlkIiApLAoJCQkkbGFiZWwgPSAkKCAiW2Zvcj0nIiArIGNvbnRyb2xJRCArICInXSIgKSwKCQkJbGFiZWxJRCA9ICRsYWJlbC5hdHRyKCAiaWQiICkgfHwgY29udHJvbElEICsgIi1sYWJlbCIsCgkJCW1pbiA9ICFpc1RvZ2dsZVN3aXRjaCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1pbiIgKSApIDogMCwKCQkJbWF4ID0gICFpc1RvZ2dsZVN3aXRjaCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1heCIgKSApIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmxlbmd0aC0xLAoJCQlzdGVwID0gd2luZG93LnBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgfHwgMSApLAoJCQlkb21IYW5kbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiYSIgKSwKCQkJaGFuZGxlID0gJCggZG9tSGFuZGxlICksCgkJCWRvbVNsaWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCgkJCXNsaWRlciA9ICQoIGRvbVNsaWRlciApLAoJCQl2YWx1ZWJnID0gdGhpcy5vcHRpb25zLmhpZ2hsaWdodCAmJiAhaXNUb2dnbGVTd2l0Y2ggPyAoZnVuY3Rpb24oKSB7CgkJCQl2YXIgYmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJCQkJYmcuY2xhc3NOYW1lID0gInVpLXNsaWRlci1iZyAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3M7CgkJCQlyZXR1cm4gJCggYmcgKS5wcmVwZW5kVG8oIHNsaWRlciApOwoJCQl9KSgpIDogZmFsc2UsCgkJCW9wdGlvbnMsCgkJCXdyYXBwZXIsCgkJCWosIGxlbmd0aCwKCQkJaSwgb3B0aW9uc0NvdW50LCBvcmlnVGFiSW5kZXgsCgkJCXNpZGUsIGFjdGl2ZUNsYXNzLCBzbGlkZXJJbWc7CgoJCSRsYWJlbC5hdHRyKCAiaWQiLCBsYWJlbElEICk7CgkJdGhpcy5pc1RvZ2dsZVN3aXRjaCA9IGlzVG9nZ2xlU3dpdGNoOwoKCQlkb21IYW5kbGUuc2V0QXR0cmlidXRlKCAiaHJlZiIsICIjIiApOwoJCWRvbVNsaWRlci5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgImFwcGxpY2F0aW9uIiApOwoJCWRvbVNsaWRlci5jbGFzc05hbWUgPSBbIHRoaXMuaXNUb2dnbGVTd2l0Y2ggPyAidWktc2xpZGVyIHVpLXNsaWRlci10cmFjayB1aS1zaGFkb3ctaW5zZXQgIiA6ICJ1aS1zbGlkZXItdHJhY2sgdWktc2hhZG93LWluc2V0ICIsIHNlbGVjdENsYXNzLCB0cmFja1RoZW1lQ2xhc3MsIGNvcm5lckNsYXNzLCBtaW5pQ2xhc3MgXS5qb2luKCAiIiApOwoJCWRvbUhhbmRsZS5jbGFzc05hbWUgPSAidWktc2xpZGVyLWhhbmRsZSI7CgkJZG9tU2xpZGVyLmFwcGVuZENoaWxkKCBkb21IYW5kbGUgKTsKCgkJaGFuZGxlLmF0dHIoewoJCQkicm9sZSI6ICJzbGlkZXIiLAoJCQkiYXJpYS12YWx1ZW1pbiI6IG1pbiwKCQkJImFyaWEtdmFsdWVtYXgiOiBtYXgsCgkJCSJhcmlhLXZhbHVlbm93IjogdGhpcy5fdmFsdWUoKSwKCQkJImFyaWEtdmFsdWV0ZXh0IjogdGhpcy5fdmFsdWUoKSwKCQkJInRpdGxlIjogdGhpcy5fdmFsdWUoKSwKCQkJImFyaWEtbGFiZWxsZWRieSI6IGxhYmVsSUQKCQl9KTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJc2xpZGVyOiBzbGlkZXIsCgkJCWhhbmRsZTogaGFuZGxlLAoJCQljb250cm9sOiBjb250cm9sLAoJCQl0eXBlOiBjVHlwZSwKCQkJc3RlcDogc3RlcCwKCQkJbWF4OiBtYXgsCgkJCW1pbjogbWluLAoJCQl2YWx1ZWJnOiB2YWx1ZWJnLAoJCQlpc1Jhbmdlc2xpZGVyOiBpc1Jhbmdlc2xpZGVyLAoJCQlkcmFnZ2luZzogZmFsc2UsCgkJCWJlZm9yZVN0YXJ0OiBudWxsLAoJCQl1c2VyTW9kaWZpZWQ6IGZhbHNlLAoJCQltb3VzZU1vdmVkOiBmYWxzZQoJCX0pOwoKCQlpZiAoIGlzVG9nZ2xlU3dpdGNoICkgewoJCQkvLyBUT0RPOiByZXN0b3JlIG9yaWdpbmFsIHRhYmluZGV4IChpZiBhbnkpIGluIGEgZGVzdHJveSBtZXRob2QKCQkJb3JpZ1RhYkluZGV4ID0gY29udHJvbC5hdHRyKCAidGFiaW5kZXgiICk7CgkJCWlmICggb3JpZ1RhYkluZGV4ICkgewoJCQkJaGFuZGxlLmF0dHIoICJ0YWJpbmRleCIsIG9yaWdUYWJJbmRleCApOwoJCQl9CgkJCWNvbnRyb2wuYXR0ciggInRhYmluZGV4IiwgIi0xIiApLmZvY3VzKGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmJsdXIoKTsKCQkJCWhhbmRsZS5mb2N1cygpOwoJCQl9KTsKCgkJCXdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJCQl3cmFwcGVyLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItaW5uZXJvZmZzZXQiOwoKCQkJZm9yICggaiA9IDAsIGxlbmd0aCA9IGRvbVNsaWRlci5jaGlsZE5vZGVzLmxlbmd0aDsgaiA8IGxlbmd0aDsgaisrICkgewoJCQkJd3JhcHBlci5hcHBlbmRDaGlsZCggZG9tU2xpZGVyLmNoaWxkTm9kZXNbal0gKTsKCQkJfQoKCQkJZG9tU2xpZGVyLmFwcGVuZENoaWxkKCB3cmFwcGVyICk7CgoJCQkvLyBzbGlkZXIud3JhcElubmVyKCAiPGRpdiBjbGFzcz0ndWktc2xpZGVyLWlubmVyb2Zmc2V0Jz48L2Rpdj4iICk7CgoJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSB3aXRoIGEgc21vb3RoIHRyYW5zaXRpb24KCQkJaGFuZGxlLmFkZENsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCgkJCW9wdGlvbnMgPSBjb250cm9sLmZpbmQoICJvcHRpb24iICk7CgoJCQlmb3IgKCBpID0gMCwgb3B0aW9uc0NvdW50ID0gb3B0aW9ucy5sZW5ndGg7IGkgPCBvcHRpb25zQ291bnQ7IGkrKyApIHsKCQkJCXNpZGUgPSAhaSA/ICJiIiA6ICJhIjsKCQkJCWFjdGl2ZUNsYXNzID0gIWkgPyAiIiA6ICIgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzOwoJCQkJc2xpZGVySW1nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICk7CgoJCQkJc2xpZGVySW1nLmNsYXNzTmFtZSA9IFsgInVpLXNsaWRlci1sYWJlbCB1aS1zbGlkZXItbGFiZWwtIiwgc2lkZSwgYWN0aXZlQ2xhc3MgXS5qb2luKCAiIiApOwoJCQkJc2xpZGVySW1nLnNldEF0dHJpYnV0ZSggInJvbGUiLCAiaW1nIiApOwoJCQkJc2xpZGVySW1nLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggb3B0aW9uc1tpXS5pbm5lckhUTUwgKSApOwoJCQkJJCggc2xpZGVySW1nICkucHJlcGVuZFRvKCBzbGlkZXIgKTsKCQkJfQoKCQkJc2VsZi5fbGFiZWxzID0gJCggIi51aS1zbGlkZXItbGFiZWwiLCBzbGlkZXIgKTsKCgkJfQoKCQkvLyBtb25pdG9yIHRoZSBpbnB1dCBmb3IgdXBkYXRlZCB2YWx1ZXMKCQljb250cm9sLmFkZENsYXNzKCBpc1RvZ2dsZVN3aXRjaCA/ICJ1aS1zbGlkZXItc3dpdGNoIiA6ICJ1aS1zbGlkZXItaW5wdXQiICk7CgoJCXRoaXMuX29uKCBjb250cm9sLCB7CgkJCSJjaGFuZ2UiOiAiX2NvbnRyb2xDaGFuZ2UiLAoJCQkia2V5dXAiOiAiX2NvbnRyb2xLZXl1cCIsCgkJCSJibHVyIjogIl9jb250cm9sQmx1ciIsCgkJCSJ2bW91c2V1cCI6ICJfY29udHJvbFZNb3VzZVVwIgoJCX0pOwoKCQlzbGlkZXIuYmluZCggInZtb3VzZWRvd24iLCAkLnByb3h5KCB0aGlzLl9zbGlkZXJWTW91c2VEb3duLCB0aGlzICkgKQoJCQkuYmluZCggInZjbGljayIsIGZhbHNlICk7CgoJCS8vIFdlIGhhdmUgdG8gaW5zdGFudGlhdGUgYSBuZXcgZnVuY3Rpb24gb2JqZWN0IGZvciB0aGUgdW5iaW5kIHRvIHdvcmsgcHJvcGVybHkKCQkvLyBzaW5jZSB0aGUgbWV0aG9kIGl0c2VsZiBpcyBkZWZpbmVkIGluIHRoZSBwcm90b3R5cGUgKGNhdXNpbmcgaXQgdG8gdW5iaW5kIGV2ZXJ5dGhpbmcpCgkJdGhpcy5fb24oIGRvY3VtZW50LCB7ICJ2bW91c2Vtb3ZlIjogIl9wcmV2ZW50RG9jdW1lbnREcmFnIiB9KTsKCQl0aGlzLl9vbiggc2xpZGVyLmFkZCggZG9jdW1lbnQgKSwgeyAidm1vdXNldXAiOiAiX3NsaWRlclZNb3VzZVVwIiB9KTsKCgkJc2xpZGVyLmluc2VydEFmdGVyKCBjb250cm9sICk7CgoJCS8vIHdyYXAgaW4gYSBkaXYgZm9yIHN0eWxpbmcgcHVycG9zZXMKCQlpZiAoICFpc1RvZ2dsZVN3aXRjaCAmJiAhaXNSYW5nZXNsaWRlciApIHsKCQkJd3JhcHBlciA9IHRoaXMub3B0aW9ucy5taW5pID8gIjxkaXYgY2xhc3M9J3VpLXNsaWRlciB1aS1taW5pJz4iIDogIjxkaXYgY2xhc3M9J3VpLXNsaWRlcic+IjsKCgkJCWNvbnRyb2wuYWRkKCBzbGlkZXIgKS53cmFwQWxsKCB3cmFwcGVyICk7CgkJfQoKCQkvLyBiaW5kIHRoZSBoYW5kbGUgZXZlbnQgY2FsbGJhY2tzIGFuZCBzZXQgdGhlIGNvbnRleHQgdG8gdGhlIHdpZGdldCBpbnN0YW5jZQoJCXRoaXMuX29uKCB0aGlzLmhhbmRsZSwgewoJCQkidm1vdXNlZG93biI6ICJfaGFuZGxlVk1vdXNlRG93biIsCgkJCSJrZXlkb3duIjogIl9oYW5kbGVLZXlkb3duIiwKCQkJImtleXVwIjogIl9oYW5kbGVLZXl1cCIKCQl9KTsKCgkJdGhpcy5oYW5kbGUuYmluZCggInZjbGljayIsIGZhbHNlICk7CgoJCXRoaXMuX2hhbmRsZUZvcm1SZXNldCgpOwoKCQl0aGlzLnJlZnJlc2goIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB0cnVlICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0VGhlbWUoIG9wdGlvbnMudGhlbWUgKTsKCQl9CgoJCWlmICggb3B0aW9ucy50cmFja1RoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldFRyYWNrVGhlbWUoIG9wdGlvbnMudHJhY2tUaGVtZSApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0Q29ybmVycyggb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRNaW5pKCBvcHRpb25zLm1pbmkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5oaWdobGlnaHQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0SGlnaGxpZ2h0KCBvcHRpb25zLmhpZ2hsaWdodCApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldERpc2FibGVkKCBvcHRpb25zLmRpc2FibGVkICk7CgkJfQoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9LAoKCV9jb250cm9sQ2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJLy8gaWYgdGhlIHVzZXIgZHJhZ2dlZCB0aGUgaGFuZGxlLCB0aGUgImNoYW5nZSIgZXZlbnQgd2FzIHRyaWdnZXJlZCBmcm9tIGluc2lkZSByZWZyZXNoKCk7IGRvbid0IGNhbGwgcmVmcmVzaCgpIGFnYWluCgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiY29udHJvbGNoYW5nZSIsIGV2ZW50ICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCWlmICggIXRoaXMubW91c2VNb3ZlZCApIHsKCQkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpLCB0cnVlICk7CgkJfQoJfSwKCglfY29udHJvbEtleXVwOiBmdW5jdGlvbigvKiBldmVudCAqLykgeyAvLyBuZWNlc3Nhcnk/CgkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpLCB0cnVlLCB0cnVlICk7Cgl9LAoKCV9jb250cm9sQmx1cjogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCksIHRydWUgKTsKCX0sCgoJLy8gaXQgYXBwZWFycyB0aGUgY2xpY2tpbmcgdGhlIHVwIGFuZCBkb3duIGJ1dHRvbnMgaW4gY2hyb21lIG9uCgkvLyByYW5nZS9udW1iZXIgaW5wdXRzIGRvZXNuJ3QgdHJpZ2dlciBhIGNoYW5nZSB1bnRpbCB0aGUgZmllbGQgaXMKCS8vIGJsdXJyZWQuIEhlcmUgd2UgY2hlY2sgdGhpZiB0aGUgdmFsdWUgaGFzIGNoYW5nZWQgYW5kIHJlZnJlc2gKCV9jb250cm9sVk1vdXNlVXA6IGZ1bmN0aW9uKC8qIGV2ZW50ICovKSB7CgkJdGhpcy5fY2hlY2tlZFJlZnJlc2goKTsKCX0sCgoJLy8gTk9URSBmb3JjZSBmb2N1cyBvbiBoYW5kbGUKCV9oYW5kbGVWTW91c2VEb3duOiBmdW5jdGlvbigvKiBldmVudCAqLykgewoJCXRoaXMuaGFuZGxlLmZvY3VzKCk7Cgl9LAoKCV9oYW5kbGVLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGluZGV4ID0gdGhpcy5fdmFsdWUoKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gSW4gYWxsIGNhc2VzIHByZXZlbnQgdGhlIGRlZmF1bHQgYW5kIG1hcmsgdGhlIGhhbmRsZSBhcyBhY3RpdmUKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuSE9NRToKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkVORDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX0RPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRE9XTjoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQ6CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQkJCWlmICggIXRoaXMuX2tleVNsaWRpbmcgKSB7CgkJCQkJdGhpcy5fa2V5U2xpZGluZyA9IHRydWU7CgkJCQkJdGhpcy5oYW5kbGUuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7IC8qIFRPRE86IFdlIGRvbid0IHVzZSB0aGlzIGNsYXNzIGZvciBzdHlsaW5nLiBEbyB3ZSBuZWVkIHRvIGFkZCBpdD8gKi8KCQkJCX0KCgkJCQlicmVhazsKCQl9CgoJCS8vIG1vdmUgdGhlIHNsaWRlciBhY2NvcmRpbmcgdG8gdGhlIGtleXByZXNzCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCQl0aGlzLnJlZnJlc2goIHRoaXMubWluICk7CgkJCQlicmVhazsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkVORDoKCQkJCXRoaXMucmVmcmVzaCggdGhpcy5tYXggKTsKCQkJCWJyZWFrOwoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlVQOgoJCSAgICBjYXNlICQubW9iaWxlLmtleUNvZGUuTEVGVDoKCQkJCXRoaXMucmVmcmVzaCggaW5kZXggKyB0aGlzLnN0ZXAgKTsKCQkJCWJyZWFrOwoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRE9XTjoKCQkgICAgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUOgoJCQkJdGhpcy5yZWZyZXNoKCBpbmRleCAtIHRoaXMuc3RlcCApOwoJCQkJYnJlYWs7CgkJfQoJfSwgLy8gcmVtb3ZlIGFjdGl2ZSBtYXJrCgoJX2hhbmRsZUtleXVwOiBmdW5jdGlvbigvKiBldmVudCAqLykgewoJCWlmICggdGhpcy5fa2V5U2xpZGluZyApIHsKCQkJdGhpcy5fa2V5U2xpZGluZyA9IGZhbHNlOwoJCQl0aGlzLmhhbmRsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsgLyogU2VlIGNvbW1lbnQgYWJvdmUuICovCgkJfQoJfSwKCglfc2xpZGVyVk1vdXNlRG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCS8vIE5PVEU6IHdlIGRvbid0IGRvIHRoaXMgaW4gcmVmcmVzaCBiZWNhdXNlIHdlIHN0aWxsIHdhbnQgdG8KCQkvLyAgICAgICBzdXBwb3J0IHByb2dyYW1tYXRpYyBhbHRlcmF0aW9uIG9mIGRpc2FibGVkIGlucHV0cwoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8ICEoIGV2ZW50LndoaWNoID09PSAxIHx8IGV2ZW50LndoaWNoID09PSAwIHx8IGV2ZW50LndoaWNoID09PSB1bmRlZmluZWQgKSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVzdGFydCIsIGV2ZW50ICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCXRoaXMuZHJhZ2dpbmcgPSB0cnVlOwoJCXRoaXMudXNlck1vZGlmaWVkID0gZmFsc2U7CgkJdGhpcy5tb3VzZU1vdmVkID0gZmFsc2U7CgoJCWlmICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJdGhpcy5iZWZvcmVTdGFydCA9IHRoaXMuZWxlbWVudFswXS5zZWxlY3RlZEluZGV4OwoJCX0KCgkJdGhpcy5yZWZyZXNoKCBldmVudCApOwoJCXRoaXMuX3RyaWdnZXIoICJzdGFydCIgKTsKCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCV9zbGlkZXJWTW91c2VVcDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLmRyYWdnaW5nICkgewoJCQl0aGlzLmRyYWdnaW5nID0gZmFsc2U7CgoJCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSB3aXRoIGEgc21vb3RoIHRyYW5zaXRpb24KCQkJCXRoaXMuaGFuZGxlLmFkZENsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCgkJCQlpZiAoIHRoaXMubW91c2VNb3ZlZCApIHsKCQkJCQkvLyB0aGlzIGlzIGEgZHJhZywgY2hhbmdlIHRoZSB2YWx1ZSBvbmx5IGlmIHVzZXIgZHJhZ2dlZCBlbm91Z2gKCQkJCQlpZiAoIHRoaXMudXNlck1vZGlmaWVkICkgewoJCQkJCQl0aGlzLnJlZnJlc2goIHRoaXMuYmVmb3JlU3RhcnQgPT09IDAgPyAxIDogMCApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRoaXMucmVmcmVzaCggdGhpcy5iZWZvcmVTdGFydCApOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcyBpcyBqdXN0IGEgY2xpY2ssIGNoYW5nZSB0aGUgdmFsdWUKCQkJCQl0aGlzLnJlZnJlc2goIHRoaXMuYmVmb3JlU3RhcnQgPT09IDAgPyAxIDogMCApOwoJCQkJfQoJCQl9CgoJCQl0aGlzLm1vdXNlTW92ZWQgPSBmYWxzZTsKCQkJdGhpcy5fdHJpZ2dlciggInN0b3AiICk7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9LAoKCV9wcmV2ZW50RG9jdW1lbnREcmFnOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vIE5PVEU6IHdlIGRvbid0IGRvIHRoaXMgaW4gcmVmcmVzaCBiZWNhdXNlIHdlIHN0aWxsIHdhbnQgdG8KCQkJLy8gICAgICAgc3VwcG9ydCBwcm9ncmFtbWF0aWMgYWx0ZXJhdGlvbiBvZiBkaXNhYmxlZCBpbnB1dHMKCQkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiZHJhZyIsIGV2ZW50ICkgPT09IGZhbHNlKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQkJaWYgKCB0aGlzLmRyYWdnaW5nICYmICF0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgoJCQkJLy8gdGhpcy5tb3VzZU1vdmVkIG11c3QgYmUgdXBkYXRlZCBiZWZvcmUgcmVmcmVzaCgpIGJlY2F1c2UgaXQgd2lsbCBiZSB1c2VkIGluIHRoZSBjb250cm9sICJjaGFuZ2UiIGV2ZW50CgkJCQl0aGlzLm1vdXNlTW92ZWQgPSB0cnVlOwoKCQkJCWlmICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSBpbiBzeW5jIHdpdGggdGhlIG1vdXNlCgkJCQkJdGhpcy5oYW5kbGUucmVtb3ZlQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoJCQkJfQoKCQkJCXRoaXMucmVmcmVzaCggZXZlbnQgKTsKCgkJCQkvLyBvbmx5IGFmdGVyIHJlZnJlc2goKSB5b3UgY2FuIGNhbGN1bGF0ZSB0aGlzLnVzZXJNb2RpZmllZAoJCQkJdGhpcy51c2VyTW9kaWZpZWQgPSB0aGlzLmJlZm9yZVN0YXJ0ICE9PSB0aGlzLmVsZW1lbnRbMF0uc2VsZWN0ZWRJbmRleDsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgoJX2NoZWNrZWRSZWZyZXNoOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMudmFsdWUgIT09IHRoaXMuX3ZhbHVlKCkgKSB7CgkJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSApOwoJCX0KCX0sCgoJX3ZhbHVlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gIHRoaXMuaXNUb2dnbGVTd2l0Y2ggPyB0aGlzLmVsZW1lbnRbMF0uc2VsZWN0ZWRJbmRleCA6IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC52YWwoKSApIDsKCX0sCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goIHVuZGVmaW5lZCwgZmFsc2UsIHRydWUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIHZhbCwgaXNmcm9tQ29udHJvbCwgcHJldmVudElucHV0VXBkYXRlICkgewoJCS8vIE5PVEU6IHdlIGRvbid0IHJldHVybiBoZXJlIGJlY2F1c2Ugd2Ugd2FudCB0byBzdXBwb3J0IHByb2dyYW1tYXRpYwoJCS8vICAgICAgIGFsdGVyYXRpb24gb2YgdGhlIGlucHV0IHZhbHVlLCB3aGljaCBzaG91bGQgc3RpbGwgdXBkYXRlIHRoZSBzbGlkZXIKCgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlwYXJlbnRUaGVtZSA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggdGhpcy5lbGVtZW50WyAwIF0sICJ0aGVtZSIgKSwKCQkJdGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUgfHwgcGFyZW50VGhlbWUsCgkJCXRoZW1lQ2xhc3MgPSAgdGhlbWUgPyAiIHVpLWJ0bi0iICsgdGhlbWUgOiAiIiwKCQkJdHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lIHx8IHBhcmVudFRoZW1lLAoJCQl0cmFja1RoZW1lQ2xhc3MgPSB0cmFja1RoZW1lID8gIiB1aS1iYXItIiArIHRyYWNrVGhlbWUgOiAiIHVpLWJhci1pbmhlcml0IiwKCQkJY29ybmVyQ2xhc3MgPSB0aGlzLm9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiwKCQkJbWluaUNsYXNzID0gdGhpcy5vcHRpb25zLm1pbmkgPyAiIHVpLW1pbmkiIDogIiIsCgkJCWxlZnQsIHdpZHRoLCBkYXRhLCB0b2wsCgkJCXB4U3RlcCwgcGVyY2VudCwKCQkJY29udHJvbCwgaXNJbnB1dCwgb3B0aW9uRWxlbWVudHMsIG1pbiwgbWF4LCBzdGVwLAoJCQluZXd2YWwsIHZhbE1vZFN0ZXAsIGFsaWduVmFsdWUsIHBlcmNlbnRQZXJTdGVwLAoJCQloYW5kbGVQZXJjZW50LCBhUGVyY2VudCwgYlBlcmNlbnQsCgkJCXZhbHVlQ2hhbmdlZDsKCgkJc2VsZi5zbGlkZXJbMF0uY2xhc3NOYW1lID0gWyB0aGlzLmlzVG9nZ2xlU3dpdGNoID8gInVpLXNsaWRlciB1aS1zbGlkZXItc3dpdGNoIHVpLXNsaWRlci10cmFjayB1aS1zaGFkb3ctaW5zZXQiIDogInVpLXNsaWRlci10cmFjayB1aS1zaGFkb3ctaW5zZXQiLCB0cmFja1RoZW1lQ2xhc3MsIGNvcm5lckNsYXNzLCBtaW5pQ2xhc3MgXS5qb2luKCAiIiApOwoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8IHRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiICkgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCgkJLy8gc2V0IHRoZSBzdG9yZWQgdmFsdWUgZm9yIGNvbXBhcmlzb24gbGF0ZXIKCQl0aGlzLnZhbHVlID0gdGhpcy5fdmFsdWUoKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5oaWdobGlnaHQgJiYgIXRoaXMuaXNUb2dnbGVTd2l0Y2ggJiYgdGhpcy5zbGlkZXIuZmluZCggIi51aS1zbGlkZXItYmciICkubGVuZ3RoID09PSAwICkgewoJCQl0aGlzLnZhbHVlYmcgPSAoZnVuY3Rpb24oKSB7CgkJCQl2YXIgYmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJCQkJYmcuY2xhc3NOYW1lID0gInVpLXNsaWRlci1iZyAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3M7CgkJCQlyZXR1cm4gJCggYmcgKS5wcmVwZW5kVG8oIHNlbGYuc2xpZGVyICk7CgkJCX0pKCk7CgkJfQoJCXRoaXMuaGFuZGxlLmFkZENsYXNzKCAidWktYnRuIiArIHRoZW1lQ2xhc3MgKyAiIHVpLXNoYWRvdyIgKTsKCgkJY29udHJvbCA9IHRoaXMuZWxlbWVudDsKCQlpc0lucHV0ID0gIXRoaXMuaXNUb2dnbGVTd2l0Y2g7CgkJb3B0aW9uRWxlbWVudHMgPSBpc0lucHV0ID8gW10gOiBjb250cm9sLmZpbmQoICJvcHRpb24iICk7CgkJbWluID0gIGlzSW5wdXQgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDA7CgkJbWF4ID0gaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1heCIgKSApIDogb3B0aW9uRWxlbWVudHMubGVuZ3RoIC0gMTsKCQlzdGVwID0gKCBpc0lucHV0ICYmIHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgKSA+IDAgKSA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgKSA6IDE7CgoJCWlmICggdHlwZW9mIHZhbCA9PT0gIm9iamVjdCIgKSB7CgkJCWRhdGEgPSB2YWw7CgkJCS8vIGEgc2xpZ2h0IHRvbGVyYW5jZSBoZWxwZWQgZ2V0IHRvIHRoZSBlbmRzIG9mIHRoZSBzbGlkZXIKCQkJdG9sID0gODsKCgkJCWxlZnQgPSB0aGlzLnNsaWRlci5vZmZzZXQoKS5sZWZ0OwoJCQl3aWR0aCA9IHRoaXMuc2xpZGVyLndpZHRoKCk7CgkJCXB4U3RlcCA9IHdpZHRoLygobWF4LW1pbikvc3RlcCk7CgkJCWlmICggIXRoaXMuZHJhZ2dpbmcgfHwKCQkJCQlkYXRhLnBhZ2VYIDwgbGVmdCAtIHRvbCB8fAoJCQkJCWRhdGEucGFnZVggPiBsZWZ0ICsgd2lkdGggKyB0b2wgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCBweFN0ZXAgPiAxICkgewoJCQkgICAgcGVyY2VudCA9ICgoZGF0YS5wYWdlWCAtIGxlZnQpIC8gd2lkdGgpICogMTAwOwoJCQkgICAgcGVyY2VudCA9IDEwMCAtIHBlcmNlbnQ7CgkJCX0gZWxzZSB7CgkJCSAgICBwZXJjZW50ID0gTWF0aC5yb3VuZCgoKGRhdGEucGFnZVggLSBsZWZ0KSAvIHdpZHRoKSAqIDEwMCk7CgkJCSAgICBwZXJjZW50ID0gMTAwIC0gcGVyY2VudDsKCQkJfQoJCX0gZWxzZSB7CgkJCWlmICggdmFsID09IG51bGwgKSB7CgkJCQl2YWwgPSBpc0lucHV0ID8gcGFyc2VGbG9hdCggY29udHJvbC52YWwoKSB8fCAwICkgOiBjb250cm9sWzBdLnNlbGVjdGVkSW5kZXg7CgkJCX0KCQkJcGVyY2VudCA9ICggcGFyc2VGbG9hdCggdmFsICkgLSBtaW4gKSAvICggbWF4IC0gbWluICkgKiAxMDA7CgkJfQoKCQlpZiAoIGlzTmFOKCBwZXJjZW50ICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCW5ld3ZhbCA9ICggcGVyY2VudCAvIDEwMCApICogKCBtYXggLSBtaW4gKSArIG1pbjsKCgkJLy9mcm9tIGpRdWVyeSBVSSBzbGlkZXIsIHRoZSBmb2xsb3dpbmcgc291cmNlIHdpbGwgcm91bmQgdG8gdGhlIG5lYXJlc3Qgc3RlcAoJCXZhbE1vZFN0ZXAgPSAoIG5ld3ZhbCAtIG1pbiApICUgc3RlcDsKCQlhbGlnblZhbHVlID0gbmV3dmFsIC0gdmFsTW9kU3RlcDsKCgkJaWYgKCBNYXRoLmFicyggdmFsTW9kU3RlcCApICogMiA+PSBzdGVwICkgewoJCQlhbGlnblZhbHVlICs9ICggdmFsTW9kU3RlcCA+IDAgKSA/IHN0ZXAgOiAoIC1zdGVwICk7CgkJfQoKCQlwZXJjZW50UGVyU3RlcCA9IDEwMC8oKG1heC1taW4pL3N0ZXApOwoJCS8vIFNpbmNlIEphdmFTY3JpcHQgaGFzIHByb2JsZW1zIHdpdGggbGFyZ2UgZmxvYXRzLCByb3VuZAoJCS8vIHRoZSBmaW5hbCB2YWx1ZSB0byA1IGRpZ2l0cyBhZnRlciB0aGUgZGVjaW1hbCBwb2ludCAoc2VlIGpRdWVyeVVJOiAjNDEyNCkKCQluZXd2YWwgPSBwYXJzZUZsb2F0KCBhbGlnblZhbHVlLnRvRml4ZWQoNSkgKTsKCgkJaWYgKCB0eXBlb2YgcHhTdGVwID09PSAidW5kZWZpbmVkIiApIHsKCQkJcHhTdGVwID0gd2lkdGggLyAoIChtYXgtbWluKSAvIHN0ZXAgKTsKCQl9CgkJaWYgKCBweFN0ZXAgPiAxICYmIGlzSW5wdXQgKSB7CgkJCXBlcmNlbnQgPSAoIG5ld3ZhbCAtIG1pbiApICogcGVyY2VudFBlclN0ZXAgKiAoIDEgLyBzdGVwICk7CgkJfQoJCWlmICggcGVyY2VudCA8IDAgKSB7CgkJCXBlcmNlbnQgPSAwOwoJCX0KCgkJaWYgKCBwZXJjZW50ID4gMTAwICkgewoJCQlwZXJjZW50ID0gMTAwOwoJCX0KCgkJaWYgKCBuZXd2YWwgPCBtaW4gKSB7CgkJCW5ld3ZhbCA9IG1pbjsKCQl9CgoJCWlmICggbmV3dmFsID4gbWF4ICkgewoJCQluZXd2YWwgPSBtYXg7CgkJfQoKCQl0aGlzLmhhbmRsZS5jc3MoICJyaWdodCIsIHBlcmNlbnQgKyAiJSIgKTsKCgkJdGhpcy5oYW5kbGVbMF0uc2V0QXR0cmlidXRlKCAiYXJpYS12YWx1ZW5vdyIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuYXR0ciggInZhbHVlIiApICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggImFyaWEtdmFsdWV0ZXh0IiwgaXNJbnB1dCA/IG5ld3ZhbCA6IG9wdGlvbkVsZW1lbnRzLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggInRpdGxlIiwgaXNJbnB1dCA/IG5ld3ZhbCA6IG9wdGlvbkVsZW1lbnRzLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpICk7CgoJCWlmICggdGhpcy52YWx1ZWJnICkgewoJCQl0aGlzLnZhbHVlYmcuY3NzKCAid2lkdGgiLCBwZXJjZW50ICsgIiUiICk7CgkJfQoKCQkvLyBkcmFnIHRoZSBsYWJlbCB3aWR0aHMKCQlpZiAoIHRoaXMuX2xhYmVscyApIHsKCQkJaGFuZGxlUGVyY2VudCA9IHRoaXMuaGFuZGxlLndpZHRoKCkgLyB0aGlzLnNsaWRlci53aWR0aCgpICogMTAwOwoJCQlhUGVyY2VudCA9IHBlcmNlbnQgJiYgaGFuZGxlUGVyY2VudCArICggMTAwIC0gaGFuZGxlUGVyY2VudCApICogcGVyY2VudCAvIDEwMDsKCQkJYlBlcmNlbnQgPSBwZXJjZW50ID09PSAxMDAgPyAwIDogTWF0aC5taW4oIGhhbmRsZVBlcmNlbnQgKyAxMDAgLSBhUGVyY2VudCwgMTAwICk7CgoJCQl0aGlzLl9sYWJlbHMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBhYiA9ICQoIHRoaXMgKS5oYXNDbGFzcyggInVpLXNsaWRlci1sYWJlbC1hIiApOwoJCQkJJCggdGhpcyApLndpZHRoKCAoIGFiID8gYVBlcmNlbnQgOiBiUGVyY2VudCAgKSArICIlIiApOwoJCQl9KTsKCQl9CgoJCWlmICggIXByZXZlbnRJbnB1dFVwZGF0ZSApIHsKCQkJdmFsdWVDaGFuZ2VkID0gZmFsc2U7CgoJCQkvLyB1cGRhdGUgY29udHJvbCJzIHZhbHVlCgkJCWlmICggaXNJbnB1dCApIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2wudmFsKCkgIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2wudmFsKCBuZXd2YWwgKTsKCQkJfSBlbHNlIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ICE9PSBuZXd2YWw7CgkJCQljb250cm9sWyAwIF0uc2VsZWN0ZWRJbmRleCA9IG5ld3ZhbDsKCQkJfQoJCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVjaGFuZ2UiLCB2YWwgKSA9PT0gZmFsc2UpIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQkJaWYgKCAhaXNmcm9tQ29udHJvbCAmJiB2YWx1ZUNoYW5nZWQgKSB7CgkJCQljb250cm9sLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCX0KCQl9Cgl9LAoKCV9zZXRIaWdobGlnaHQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YWx1ZSA9ICEhdmFsdWU7CgkJaWYgKCB2YWx1ZSApIHsKCQkJdGhpcy5vcHRpb25zLmhpZ2hsaWdodCA9ICEhdmFsdWU7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0gZWxzZSBpZiAoIHRoaXMudmFsdWViZyApIHsKCQkJdGhpcy52YWx1ZWJnLnJlbW92ZSgpOwoJCQl0aGlzLnZhbHVlYmcgPSBmYWxzZTsKCQl9Cgl9LAoKCV9zZXRUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXRoaXMuaGFuZGxlCgkJCS5yZW1vdmVDbGFzcyggInVpLWJ0bi0iICsgdGhpcy5vcHRpb25zLnRoZW1lICkKCQkJLmFkZENsYXNzKCAidWktYnRuLSIgKyB2YWx1ZSApOwoKCQl2YXIgY3VycmVudFRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lID8gdGhpcy5vcHRpb25zLnRoZW1lIDogImluaGVyaXQiLAoJCQluZXdUaGVtZSA9IHZhbHVlID8gdmFsdWUgOiAiaW5oZXJpdCI7CgoJCXRoaXMuY29udHJvbAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1ib2R5LSIgKyBjdXJyZW50VGhlbWUgKQoJCQkuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyBuZXdUaGVtZSApOwoJfSwKCglfc2V0VHJhY2tUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhciBjdXJyZW50VHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lID8gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgOiAiaW5oZXJpdCIsCgkJCW5ld1RyYWNrVGhlbWUgPSB2YWx1ZSA/IHZhbHVlIDogImluaGVyaXQiOwoKCQl0aGlzLnNsaWRlcgoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1ib2R5LSIgKyBjdXJyZW50VHJhY2tUaGVtZSApCgkJCS5hZGRDbGFzcyggInVpLWJvZHktIiArIG5ld1RyYWNrVGhlbWUgKTsKCX0sCgoJX3NldE1pbmk6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YWx1ZSA9ICEhdmFsdWU7CgkJaWYgKCAhdGhpcy5pc1RvZ2dsZVN3aXRjaCAmJiAhdGhpcy5pc1Jhbmdlc2xpZGVyICkgewoJCQl0aGlzLnNsaWRlci5wYXJlbnQoKS50b2dnbGVDbGFzcyggInVpLW1pbmkiLCB2YWx1ZSApOwoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgdmFsdWUgKTsKCQl9CgkJdGhpcy5zbGlkZXIudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgdmFsdWUgKTsKCX0sCgoJX3NldENvcm5lcnM6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLnNsaWRlci50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCB2YWx1ZSApOwoKCQlpZiAoICF0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQl0aGlzLmNvbnRyb2wudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgdmFsdWUgKTsKCQl9Cgl9LAoKCV9zZXREaXNhYmxlZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhbHVlID0gISF2YWx1ZTsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLnNsaWRlci50b2dnbGVDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCX0KCn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgcG9wdXA7CgpmdW5jdGlvbiBnZXRQb3B1cCgpIHsKCWlmICggIXBvcHVwICkgewoJCXBvcHVwID0gJCggIjxkaXY+PC9kaXY+IiwgewoJCQkiY2xhc3MiOiAidWktc2xpZGVyLXBvcHVwIHVpLXNoYWRvdyB1aS1jb3JuZXItYWxsIgoJCX0pOwoJfQoJcmV0dXJuIHBvcHVwLmNsb25lKCk7Cn0KCiQud2lkZ2V0KCAibW9iaWxlLnNsaWRlciIsICQubW9iaWxlLnNsaWRlciwgewoJb3B0aW9uczogewoJCXBvcHVwRW5hYmxlZDogZmFsc2UsCgkJc2hvd1ZhbHVlOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfY3VycmVudFZhbHVlOiBudWxsLAoJCQlfcG9wdXA6IG51bGwsCgkJCV9wb3B1cFZpc2libGU6IGZhbHNlCgkJfSk7CgoJCXRoaXMuX3NldE9wdGlvbiggInBvcHVwRW5hYmxlZCIsIHRoaXMub3B0aW9ucy5wb3B1cEVuYWJsZWQgKTsKCgkJdGhpcy5fb24oIHRoaXMuaGFuZGxlLCB7ICJ2bW91c2Vkb3duIiA6ICJfc2hvd1BvcHVwIiB9ICk7CgkJdGhpcy5fb24oIHRoaXMuc2xpZGVyLmFkZCggdGhpcy5kb2N1bWVudCApLCB7ICJ2bW91c2V1cCIgOiAiX2hpZGVQb3B1cCIgfSApOwoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJLy8gcG9zaXRpb24gdGhlIHBvcHVwIGNlbnRlcmVkIDVweCBhYm92ZSB0aGUgaGFuZGxlCglfcG9zaXRpb25Qb3B1cDogZnVuY3Rpb24oKSB7CgkJdmFyIGRzdE9mZnNldCA9IHRoaXMuaGFuZGxlLm9mZnNldCgpOwoKCQl0aGlzLl9wb3B1cC5vZmZzZXQoIHsKCQkJbGVmdDogZHN0T2Zmc2V0LmxlZnQgKyAoIHRoaXMuaGFuZGxlLndpZHRoKCkgLSB0aGlzLl9wb3B1cC53aWR0aCgpICkgLyAyLAoJCQl0b3A6IGRzdE9mZnNldC50b3AgLSB0aGlzLl9wb3B1cC5vdXRlckhlaWdodCgpIC0gNQoJCX0pOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoKCQlpZiAoIGtleSA9PT0gInNob3dWYWx1ZSIgKSB7CgkJCXRoaXMuaGFuZGxlLmh0bWwoIHZhbHVlICYmICF0aGlzLm9wdGlvbnMubWluaSA/IHRoaXMuX3ZhbHVlKCkgOiAiIiApOwoJCX0gZWxzZSBpZiAoIGtleSA9PT0gInBvcHVwRW5hYmxlZCIgKSB7CgkJCWlmICggdmFsdWUgJiYgIXRoaXMuX3BvcHVwICkgewoJCQkJdGhpcy5fcG9wdXAgPSBnZXRQb3B1cCgpCgkJCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgKCB0aGlzLm9wdGlvbnMudGhlbWUgfHwgImEiICkgKQoJCQkJCS5pbnNlcnRCZWZvcmUoIHRoaXMuZWxlbWVudCApOwoJCQl9CgkJfQoJfSwKCgkvLyBzaG93IHZhbHVlIG9uIHRoZSBoYW5kbGUgYW5kIGluIHBvcHVwCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJdGhpcy5fcmVmcmVzaCgpOwoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIG8gPSB0aGlzLm9wdGlvbnMsIG5ld1ZhbHVlOwoKCQlpZiAoIG8ucG9wdXBFbmFibGVkICkgewoJCQkvLyByZW1vdmUgdGhlIHRpdGxlIGF0dHJpYnV0ZSBmcm9tIHRoZSBoYW5kbGUgKHdoaWNoIGlzCgkJCS8vIHJlc3BvbnNpYmxlIGZvciB0aGUgYW5ub3lpbmcgdG9vbHRpcCk7IE5CIHdlIGhhdmUKCQkJLy8gdG8gZG8gaXQgaGVyZSBhcyB0aGUganFtIHNsaWRlciBzZXRzIGl0IGV2ZXJ5IHRpbWUKCQkJLy8gdGhlIHNsaWRlcidzIHZhbHVlIGNoYW5nZXMgOigKCQkJdGhpcy5oYW5kbGUucmVtb3ZlQXR0ciggInRpdGxlIiApOwoJCX0KCgkJbmV3VmFsdWUgPSB0aGlzLl92YWx1ZSgpOwoJCWlmICggbmV3VmFsdWUgPT09IHRoaXMuX2N1cnJlbnRWYWx1ZSApIHsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9jdXJyZW50VmFsdWUgPSBuZXdWYWx1ZTsKCgkJaWYgKCBvLnBvcHVwRW5hYmxlZCAmJiB0aGlzLl9wb3B1cCApIHsKCQkJdGhpcy5fcG9zaXRpb25Qb3B1cCgpOwoJCQl0aGlzLl9wb3B1cC5odG1sKCBuZXdWYWx1ZSApOwoJCX0gZWxzZSBpZiAoIG8uc2hvd1ZhbHVlICYmICF0aGlzLm9wdGlvbnMubWluaSApIHsKCQkJdGhpcy5oYW5kbGUuaHRtbCggbmV3VmFsdWUgKTsKCQl9Cgl9LAoKCV9zaG93UG9wdXA6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5vcHRpb25zLnBvcHVwRW5hYmxlZCAmJiAhdGhpcy5fcG9wdXBWaXNpYmxlICkgewoJCQl0aGlzLmhhbmRsZS5odG1sKCAiIiApOwoJCQl0aGlzLl9wb3B1cC5zaG93KCk7CgkJCXRoaXMuX3Bvc2l0aW9uUG9wdXAoKTsKCQkJdGhpcy5fcG9wdXBWaXNpYmxlID0gdHJ1ZTsKCQl9Cgl9LAoKCV9oaWRlUG9wdXA6IGZ1bmN0aW9uKCkgewoJCXZhciBvID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG8ucG9wdXBFbmFibGVkICYmIHRoaXMuX3BvcHVwVmlzaWJsZSApIHsKCQkJaWYgKCBvLnNob3dWYWx1ZSAmJiAhby5taW5pICkgewoJCQkJdGhpcy5oYW5kbGUuaHRtbCggdGhpcy5fdmFsdWUoKSApOwoJCQl9CgkJCXRoaXMuX3BvcHVwLmhpZGUoKTsKCQkJdGhpcy5fcG9wdXBWaXNpYmxlID0gZmFsc2U7CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuZmxpcHN3aXRjaCIsICQuZXh0ZW5kKHsKCglvcHRpb25zOiB7CgkJb25UZXh0OiAiT24iLAoJCW9mZlRleHQ6ICJPZmYiLAoJCXRoZW1lOiBudWxsLAoJCWVuaGFuY2VkOiBmYWxzZSwKCQl3cmFwcGVyQ2xhc3M6IG51bGwsCgkJY29ybmVyczogdHJ1ZSwKCQltaW5pOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQkJdGhpcy5fZW5oYW5jZSgpOwoJCQl9IGVsc2UgewoJCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCQlmbGlwc3dpdGNoOiB0aGlzLmVsZW1lbnQucGFyZW50KCksCgkJCQkJb246IHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLWZsaXBzd2l0Y2gtb24iICkuZXEoIDAgKSwKCQkJCQlvZmY6IHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLWZsaXBzd2l0Y2gtb2ZmIiApLmVxKDApLAoJCQkJCXR5cGU6IHRoaXMuZWxlbWVudC5nZXQoIDAgKS50YWdOYW1lCgkJCQl9KTsKCQkJfQoKCQkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgoJCQlpZiAoIHRoaXMuZWxlbWVudC5pcyggIjpkaXNhYmxlZCIgKSApIHsKCQkJCXRoaXMuX3NldE9wdGlvbnMoewoJCQkJCSJkaXNhYmxlZCI6IHRydWUKCQkJCX0pOwoJCQl9CgoJCQl0aGlzLl9vbiggdGhpcy5mbGlwc3dpdGNoLCB7CgkJCQkiY2xpY2siOiAiX3RvZ2dsZSIsCgkJCQkic3dpcGVsZWZ0IjogIl9sZWZ0IiwKCQkJCSJzd2lwZXJpZ2h0IjogIl9yaWdodCIKCQkJfSk7CgoJCQl0aGlzLl9vbiggdGhpcy5vbiwgewoJCQkJImtleWRvd24iOiAiX2tleWRvd24iCgkJCX0pOwoKCQkJdGhpcy5fb24oIHsKCQkJCSJjaGFuZ2UiOiAicmVmcmVzaCIKCQkJfSk7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZmxpcHN3aXRjaDsKCX0sCgoJX3JpZ2h0OiBmdW5jdGlvbiAoKSB7CgkJdGhpcy5mbGlwc3dpdGNoLnJlbW92ZUNsYXNzKCAidWktZmxpcHN3aXRjaC1hY3RpdmUiICk7CgkJaWYgKCB0aGlzLnR5cGUgPT09ICJTRUxFQ1QiICkgewoJCQl0aGlzLmVsZW1lbnQuZ2V0KCAwICkuc2VsZWN0ZWRJbmRleCA9IDA7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbGVtZW50LnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCQl9CgkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJjaGFuZ2UiICk7Cgl9LAoKCV9sZWZ0OiBmdW5jdGlvbiAoKSB7CgkJdGhpcy5mbGlwc3dpdGNoLmFkZENsYXNzKCAidWktZmxpcHN3aXRjaC1hY3RpdmUiICk7CgkJaWYgKCB0aGlzLnR5cGUgPT09ICJTRUxFQ1QiICkgewoJCQl0aGlzLmVsZW1lbnQuZ2V0KCAwICkuc2VsZWN0ZWRJbmRleCA9IDE7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbGVtZW50LnByb3AoICJjaGVja2VkIiwgdHJ1ZSApOwoJCX0KCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggImNoYW5nZSIgKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXZhciBmbGlwc3dpdGNoID0gJCggIjxkaXY+IiApLAoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQllbGVtZW50ID0gdGhpcy5lbGVtZW50LAoJCQl0aGVtZSA9IG9wdGlvbnMudGhlbWUgPyBvcHRpb25zLnRoZW1lIDogImluaGVyaXQiLAoJCQlvbiA9ICQoICI8c3Bhbj48L3NwYW4+IiwgeyB0YWJpbmRleDogMSB9ICksCgkJCW9mZiA9ICQoICI8c3Bhbj48L3NwYW4+IiApLAoJCQl0eXBlID0gZWxlbWVudC5nZXQoIDAgKS50YWdOYW1lLAoJCQlvblRleHQgPSAoIHR5cGUgPT09ICJJTlBVVCIgKSA/CgkJCQlvcHRpb25zLm9uVGV4dCA6IGVsZW1lbnQuZmluZCggIm9wdGlvbiIgKS5lcSggMSApLnRleHQoKSwKCQkJb2ZmVGV4dCA9ICggdHlwZSA9PT0gIklOUFVUIiApID8KCQkJCW9wdGlvbnMub2ZmVGV4dCA6IGVsZW1lbnQuZmluZCggIm9wdGlvbiIgKS5lcSggMCApLnRleHQoKTsKCgkJCW9uCgkJCQkuYWRkQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLW9uIHVpLWJ0biB1aS1zaGFkb3cgdWktYnRuLWluaGVyaXQiICkKCQkJCS50ZXh0KCBvblRleHQgKTsKCQkJb2ZmCgkJCQkuYWRkQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLW9mZiIgKQoJCQkJLnRleHQoIG9mZlRleHQgKTsKCgkJCWZsaXBzd2l0Y2gKCQkJCS5hZGRDbGFzcyggInVpLWZsaXBzd2l0Y2ggdWktc2hhZG93LWluc2V0ICIgKwoJCQkJCSJ1aS1iYXItIiArIHRoZW1lICsgIiAiICsKCQkJCQkoIG9wdGlvbnMud3JhcHBlckNsYXNzID8gb3B0aW9ucy53cmFwcGVyQ2xhc3MgOiAiIiApICsgIiAiICsKCQkJCQkoICggZWxlbWVudC5pcyggIjpjaGVja2VkIiApIHx8CgkJCQkJCWVsZW1lbnQKCQkJCQkJCS5maW5kKCAib3B0aW9uIiApCgkJCQkJCQkuZXEoIDEgKQoJCQkJCQkJLmlzKCAiOnNlbGVjdGVkIiApICkgPyAidWktZmxpcHN3aXRjaC1hY3RpdmUiIDogIiIgKSArCgkJCQkJKCBlbGVtZW50LmlzKCI6ZGlzYWJsZWQiKSA/ICIgdWktc3RhdGUtZGlzYWJsZWQiOiAiIikgKwoJCQkJCSggb3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIjogIiIgKSArCgkJCQkJKCBvcHRpb25zLm1pbmkgPyAiIHVpLW1pbmkiOiAiIiApICkKCQkJCS5hcHBlbmQoIG9uLCBvZmYgKTsKCgkJCWVsZW1lbnQKCQkJCS5hZGRDbGFzcyggInVpLWZsaXBzd2l0Y2gtaW5wdXQiICkKCQkJCS5hZnRlciggZmxpcHN3aXRjaCApCgkJCQkuYXBwZW5kVG8oIGZsaXBzd2l0Y2ggKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJZmxpcHN3aXRjaDogZmxpcHN3aXRjaCwKCQkJb246IG9uLAoJCQlvZmY6IG9mZiwKCQkJdHlwZTogdHlwZQoJCX0pOwoJfSwKCglfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgZGlyZWN0aW9uLAoJCQlleGlzdGluZ0RpcmVjdGlvbiA9IHRoaXMuZmxpcHN3aXRjaC5oYXNDbGFzcygidWktZmxpcHN3aXRjaC1hY3RpdmUiKSA/ICJfbGVmdCIgOiAiX3JpZ2h0IjsKCgkJaWYgKCB0aGlzLnR5cGUgPT09ICJTRUxFQ1QiICkgewoJCQlkaXJlY3Rpb24gPSAoIHRoaXMuZWxlbWVudC5nZXQoIDAgKS5zZWxlY3RlZEluZGV4ID4gMCApID8gIl9yaWdodCI6ICJfbGVmdCI7CgkJfSBlbHNlIHsKCQkJZGlyZWN0aW9uID0gdGhpcy5lbGVtZW50LnByb3AoICJjaGVja2VkIiApID8gIl9yaWdodCI6ICJfbGVmdCI7CgkJfQoKCQlpZiAoIGRpcmVjdGlvbiAhPT0gZXhpc3RpbmdEaXJlY3Rpb24gKSB7CgkJCXRoaXNbIGRpcmVjdGlvbiBdKCk7CgkJfQoJfSwKCglfdG9nZ2xlOiBmdW5jdGlvbigpIHsKCQl2YXIgZGlyZWN0aW9uID0gdGhpcy5mbGlwc3dpdGNoLmhhc0NsYXNzKCAidWktZmxpcHN3aXRjaC1hY3RpdmUiICkgPyAiX2xlZnQiIDogIl9yaWdodCI7CgoJCXRoaXNbIGRpcmVjdGlvbiBdKCk7Cgl9LAoKCV9rZXlkb3duOiBmdW5jdGlvbiggZSApIHsKCSAgICBpZiAoZS53aGljaCA9PT0gJC5tb2JpbGUua2V5Q29kZS5SSUdIVCkgewoJCQl0aGlzLl9sZWZ0KCk7CgkgICAgfSBlbHNlIGlmIChlLndoaWNoID09PSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQpIHsKCQkJdGhpcy5fcmlnaHQoKTsKCQl9IGVsc2UgaWYgKCBlLndoaWNoID09PSAkLm1vYmlsZS5rZXlDb2RlLlNQQUNFICkgewoJCQl0aGlzLl90b2dnbGUoKTsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl2YXIgY3VycmVudFRoZW1lID0gb3B0aW9ucy50aGVtZSA/IG9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIsCgkJCQluZXdUaGVtZSA9IG9wdGlvbnMudGhlbWUgPyBvcHRpb25zLnRoZW1lIDogImluaGVyaXQiOwoKCQkJdGhpcy53aWRnZXQoKQoJCQkJLnJlbW92ZUNsYXNzKCAidWktYmFyLSIgKyBjdXJyZW50VGhlbWUgKQoJCQkJLmFkZENsYXNzKCAidWktYmFyLSIgKyBuZXdUaGVtZSApOwoJCX0KCQlpZiAoIG9wdGlvbnMub25UZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMub24udGV4dCggb3B0aW9ucy5vblRleHQgKTsKCQl9CgkJaWYgKCBvcHRpb25zLm9mZlRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5vZmYudGV4dCggb3B0aW9ucy5vZmZUZXh0ICk7CgkJfQoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLndpZGdldCgpLnRvZ2dsZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiLCBvcHRpb25zLmRpc2FibGVkICk7CgkJfQoJCWlmICggb3B0aW9ucy5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMud2lkZ2V0KCkudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgb3B0aW9ucy5taW5pICk7CgkJfQoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMud2lkZ2V0KCkudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5vbi5yZW1vdmUoKTsKCQl0aGlzLm9mZi5yZW1vdmUoKTsKCQl0aGlzLmVsZW1lbnQudW53cmFwKCk7CgkJdGhpcy5mbGlwc3dpdGNoLnJlbW92ZSgpOwoJCXRoaXMucmVtb3ZlQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLWlucHV0IiApOwoJfQoKfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCSQud2lkZ2V0KCAibW9iaWxlLnJhbmdlc2xpZGVyIiwgJC5leHRlbmQoIHsKCgkJb3B0aW9uczogewoJCQl0aGVtZTogbnVsbCwKCQkJdHJhY2tUaGVtZTogbnVsbCwKCQkJY29ybmVyczogdHJ1ZSwKCQkJbWluaTogZmFsc2UsCgkJCWhpZ2hsaWdodDogdHJ1ZQoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQllbENsYXNzID0gdGhpcy5vcHRpb25zLm1pbmkgPyAidWktcmFuZ2VzbGlkZXIgdWktbWluaSIgOiAidWktcmFuZ2VzbGlkZXIiLAoJCQlfaW5wdXRGaXJzdCA9ICRlbC5maW5kKCAiaW5wdXQiICkuZmlyc3QoKSwKCQkJX2lucHV0TGFzdCA9ICRlbC5maW5kKCAiaW5wdXQiICkubGFzdCgpLAoJCQlfbGFiZWwgPSAkZWwuZmluZCggImxhYmVsIiApLmZpcnN0KCksCgkJCV9zbGlkZXJXaWRnZXRGaXJzdCA9ICQuZGF0YSggX2lucHV0Rmlyc3QuZ2V0KCAwICksICJtb2JpbGUtc2xpZGVyIiApIHx8CgkJCQkkLmRhdGEoIF9pbnB1dEZpcnN0LnNsaWRlcigpLmdldCggMCApLCAibW9iaWxlLXNsaWRlciIgKSwKCQkJX3NsaWRlcldpZGdldExhc3QgPSAkLmRhdGEoIF9pbnB1dExhc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKSB8fAoJCQkJJC5kYXRhKCBfaW5wdXRMYXN0LnNsaWRlcigpLmdldCggMCApLCAibW9iaWxlLXNsaWRlciIgKSwKCQkJX3NsaWRlckZpcnN0ID0gX3NsaWRlcldpZGdldEZpcnN0LnNsaWRlciwKCQkJX3NsaWRlckxhc3QgPSBfc2xpZGVyV2lkZ2V0TGFzdC5zbGlkZXIsCgkJCWZpcnN0SGFuZGxlID0gX3NsaWRlcldpZGdldEZpcnN0LmhhbmRsZSwKCQkJX3NsaWRlcnMgPSAkKCAiPGRpdiBjbGFzcz0ndWktcmFuZ2VzbGlkZXItc2xpZGVycycgLz4iICkuYXBwZW5kVG8oICRlbCApOwoKCQkJX2lucHV0Rmlyc3QuYWRkQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1maXJzdCIgKTsKCQkJX2lucHV0TGFzdC5hZGRDbGFzcyggInVpLXJhbmdlc2xpZGVyLWxhc3QiICk7CgkJCSRlbC5hZGRDbGFzcyggZWxDbGFzcyApOwoKCQkJX3NsaWRlckZpcnN0LmFwcGVuZFRvKCBfc2xpZGVycyApOwoJCQlfc2xpZGVyTGFzdC5hcHBlbmRUbyggX3NsaWRlcnMgKTsKCQkJX2xhYmVsLmluc2VydEJlZm9yZSggJGVsICk7CgkJCWZpcnN0SGFuZGxlLnByZXBlbmRUbyggX3NsaWRlckxhc3QgKTsKCgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlfaW5wdXRGaXJzdDogX2lucHV0Rmlyc3QsCgkJCQlfaW5wdXRMYXN0OiBfaW5wdXRMYXN0LAoJCQkJX3NsaWRlckZpcnN0OiBfc2xpZGVyRmlyc3QsCgkJCQlfc2xpZGVyTGFzdDogX3NsaWRlckxhc3QsCgkJCQlfbGFiZWw6IF9sYWJlbCwKCQkJCV90YXJnZXRWYWw6IG51bGwsCgkJCQlfc2xpZGVyVGFyZ2V0OiBmYWxzZSwKCQkJCV9zbGlkZXJzOiBfc2xpZGVycywKCQkJCV9wcm94eTogZmFsc2UKCQkJfSk7CgoJCQl0aGlzLnJlZnJlc2goKTsKCQkJdGhpcy5fb24oIHRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQudWktc2xpZGVyLWlucHV0IiApLCB7CgkJCQkic2xpZGViZWZvcmVzdGFydCI6ICJfc2xpZGViZWZvcmVzdGFydCIsCgkJCQkic2xpZGVzdG9wIjogIl9zbGlkZXN0b3AiLAoJCQkJInNsaWRlZHJhZyI6ICJfc2xpZGVkcmFnIiwKCQkJCSJzbGlkZWJlZm9yZWNoYW5nZSI6ICJfY2hhbmdlIiwKCQkJCSJibHVyIjogIl9jaGFuZ2UiLAoJCQkJImtleXVwIjogIl9jaGFuZ2UiCgkJCX0pOwoJCQl0aGlzLl9vbih7CgkJCQkibW91c2Vkb3duIjoiX2NoYW5nZSIKCQkJfSk7CgkJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0iICksIHsKCQkJCSJyZXNldCI6Il9oYW5kbGVSZXNldCIKCQkJfSk7CgkJCXRoaXMuX29uKCBmaXJzdEhhbmRsZSwgewoJCQkJInZtb3VzZWRvd24iOiAiX2RyYWdGaXJzdEhhbmRsZSIKCQkJfSk7CgkJfSwKCQlfaGFuZGxlUmVzZXQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCS8vd2UgbXVzdCB3YWl0IGZvciB0aGUgc3RhY2sgdG8gdW53aW5kIGJlZm9yZSB1cGRhdGVpbmcgb3RoZXIgd2lzZSBzbGlkZXJzIHdpbGwgbm90IGhhdmUgdXBkYXRlZCB5ZXQKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQlzZWxmLl91cGRhdGVIaWdobGlnaHQoKTsKCQkJfSwwKTsKCQl9LAoKCQlfZHJhZ0ZpcnN0SGFuZGxlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vaWYgdGhlIGZpcnN0IGhhbmRsZSBpcyBkcmFnZ2VkIHNlbmQgdGhlIGV2ZW50IHRvIHRoZSBmaXJzdCBzbGlkZXIKCQkJJC5kYXRhKCB0aGlzLl9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuZHJhZ2dpbmcgPSB0cnVlOwoJCQkkLmRhdGEoIHRoaXMuX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5yZWZyZXNoKCBldmVudCApOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSwKCgkJX3NsaWRlZHJhZzogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZmlyc3QgPSAkKCBldmVudC50YXJnZXQgKS5pcyggdGhpcy5faW5wdXRGaXJzdCApLAoJCQkJb3RoZXJTbGlkZXIgPSAoIGZpcnN0ICkgPyB0aGlzLl9pbnB1dExhc3QgOiB0aGlzLl9pbnB1dEZpcnN0OwoKCQkJdGhpcy5fc2xpZGVyVGFyZ2V0ID0gZmFsc2U7CgkJCS8vaWYgdGhlIGRyYWcgd2FzIGluaXRpYXRlZCBvbiBhbiBleHRyZW1lIGFuZCB0aGUgb3RoZXIgaGFuZGxlIGlzIGZvY3VzZWQgc2VuZCB0aGUgZXZlbnRzIHRvCgkJCS8vdGhlIGNsb3Nlc3QgaGFuZGxlCgkJCWlmICggKCB0aGlzLl9wcm94eSA9PT0gImZpcnN0IiAmJiBmaXJzdCApIHx8ICggdGhpcy5fcHJveHkgPT09ICJsYXN0IiAmJiAhZmlyc3QgKSApIHsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5kcmFnZ2luZyA9IHRydWU7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkucmVmcmVzaCggZXZlbnQgKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgoJCV9zbGlkZXN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZpcnN0ID0gJCggZXZlbnQudGFyZ2V0ICkuaXMoIHRoaXMuX2lucHV0Rmlyc3QgKTsKCgkJCXRoaXMuX3Byb3h5ID0gZmFsc2U7CgkJCS8vdGhpcyBzdG9wcyBkcmFnZ2luZyBvZiB0aGUgaGFuZGxlIGFuZCBicmluZ3MgdGhlIGFjdGl2ZSB0cmFjayB0byB0aGUgZnJvbnQKCQkJLy90aGlzIG1ha2VzIGNsaWNrcyBvbiB0aGUgdHJhY2sgZ28gdGhlIHRoZSBsYXN0IGhhbmRsZSB1c2VkCgkJCXRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQiICkudHJpZ2dlciggInZtb3VzZXVwIiApOwoJCQl0aGlzLl9zbGlkZXJGaXJzdC5jc3MoICJ6LWluZGV4IiwgZmlyc3QgPyAxIDogIiIgKTsKCQl9LAoKCQlfc2xpZGViZWZvcmVzdGFydDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl0aGlzLl9zbGlkZXJUYXJnZXQgPSBmYWxzZTsKCQkJLy9pZiB0aGUgdHJhY2sgaXMgdGhlIHRhcmdldCByZW1lbWJlciB0aGlzIGFuZCB0aGUgb3JpZ2luYWwgdmFsdWUKCQkJaWYgKCAkKCBldmVudC5vcmlnaW5hbEV2ZW50LnRhcmdldCApLmhhc0NsYXNzKCAidWktc2xpZGVyLXRyYWNrIiApICkgewoJCQkJdGhpcy5fc2xpZGVyVGFyZ2V0ID0gdHJ1ZTsKCQkJCXRoaXMuX3RhcmdldFZhbCA9ICQoIGV2ZW50LnRhcmdldCApLnZhbCgpOwoJCQl9CgkJfSwKCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX3NldFRoZW1lKCBvcHRpb25zLnRoZW1lICk7CgkJCX0KCgkJCWlmICggb3B0aW9ucy50cmFja1RoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl9zZXRUcmFja1RoZW1lKCBvcHRpb25zLnRyYWNrVGhlbWUgKTsKCQkJfQoKCQkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX3NldE1pbmkoIG9wdGlvbnMubWluaSApOwoJCQl9CgoJCQlpZiAoIG9wdGlvbnMuaGlnaGxpZ2h0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl9zZXRIaWdobGlnaHQoIG9wdGlvbnMuaGlnaGxpZ2h0ICk7CgkJCX0KCQkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJfSwKCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQlvID0gdGhpcy5vcHRpb25zOwoKCQkJaWYgKCB0aGlzLl9pbnB1dEZpcnN0LmlzKCAiOmRpc2FibGVkIiApIHx8IHRoaXMuX2lucHV0TGFzdC5pcyggIjpkaXNhYmxlZCIgKSApIHsKCQkJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IHRydWU7CgkJCX0KCgkJCSRlbC5maW5kKCAiaW5wdXQiICkuc2xpZGVyKHsKCQkJCXRoZW1lOiBvLnRoZW1lLAoJCQkJdHJhY2tUaGVtZTogby50cmFja1RoZW1lLAoJCQkJZGlzYWJsZWQ6IG8uZGlzYWJsZWQsCgkJCQljb3JuZXJzOiBvLmNvcm5lcnMsCgkJCQltaW5pOiBvLm1pbmksCgkJCQloaWdobGlnaHQ6IG8uaGlnaGxpZ2h0CgkJCX0pLnNsaWRlciggInJlZnJlc2giICk7CgkJCXRoaXMuX3VwZGF0ZUhpZ2hsaWdodCgpOwoJCX0sCgoJCV9jaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCBldmVudC50eXBlID09PSAia2V5dXAiICkgewoJCQkJdGhpcy5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW1pbiA9IHBhcnNlRmxvYXQoIHRoaXMuX2lucHV0Rmlyc3QudmFsKCksIDEwICksCgkJCQltYXggPSBwYXJzZUZsb2F0KCB0aGlzLl9pbnB1dExhc3QudmFsKCksIDEwICksCgkJCQlmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmhhc0NsYXNzKCAidWktcmFuZ2VzbGlkZXItZmlyc3QiICksCgkJCQl0aGlzU2xpZGVyID0gZmlyc3QgPyB0aGlzLl9pbnB1dEZpcnN0IDogdGhpcy5faW5wdXRMYXN0LAoJCQkJb3RoZXJTbGlkZXIgPSBmaXJzdCA/IHRoaXMuX2lucHV0TGFzdCA6IHRoaXMuX2lucHV0Rmlyc3Q7CgoJCQlpZiAoICggdGhpcy5faW5wdXRGaXJzdC52YWwoKSA+IHRoaXMuX2lucHV0TGFzdC52YWwoKSAmJiBldmVudC50eXBlID09PSAibW91c2Vkb3duIiAmJiAhJChldmVudC50YXJnZXQpLmhhc0NsYXNzKCJ1aS1zbGlkZXItaGFuZGxlIikpICkgewoJCQkJdGhpc1NsaWRlci5ibHVyKCk7CgkJCX0gZWxzZSBpZiAoIGV2ZW50LnR5cGUgPT09ICJtb3VzZWRvd24iICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggbWluID4gbWF4ICYmICF0aGlzLl9zbGlkZXJUYXJnZXQgKSB7CgkJCQkvL3RoaXMgcHJldmVudHMgbWluIGZyb20gYmVpbmcgZ3JlYXRlciB0aGVuIG1heAoJCQkJdGhpc1NsaWRlci52YWwoIGZpcnN0ID8gbWF4OiBtaW4gKS5zbGlkZXIoICJyZWZyZXNoIiApOwoJCQkJdGhpcy5fdHJpZ2dlciggIm5vcm1hbGl6ZSIgKTsKCQkJfSBlbHNlIGlmICggbWluID4gbWF4ICkgewoJCQkJLy90aGlzIG1ha2VzIGl0IHNvIGNsaWNrcyBvbiB0aGUgdGFyZ2V0IG9uIGVpdGhlciBleHRyZW1lIGdvIHRvIHRoZSBjbG9zZXN0IGhhbmRsZQoJCQkJdGhpc1NsaWRlci52YWwoIHRoaXMuX3RhcmdldFZhbCApLnNsaWRlciggInJlZnJlc2giICk7CgoJCQkJLy9Zb3UgbXVzdCB3YWl0IGZvciB0aGUgc3RhY2sgdG8gdW53aW5kIHNvIGZpcnN0IHNsaWRlciBpcyB1cGRhdGVkIGJlZm9yZSB1cGRhdGluZyBzZWNvbmQKCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCW90aGVyU2xpZGVyLnZhbCggZmlyc3QgPyBtaW46IG1heCApLnNsaWRlciggInJlZnJlc2giICk7CgkJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmhhbmRsZS5mb2N1cygpOwoJCQkJCXNlbGYuX3NsaWRlckZpcnN0LmNzcyggInotaW5kZXgiLCBmaXJzdCA/ICIiIDogMSApOwoJCQkJCXNlbGYuX3RyaWdnZXIoICJub3JtYWxpemUiICk7CgkJCQl9LCAwICk7CgkJCQl0aGlzLl9wcm94eSA9ICggZmlyc3QgKSA/ICJmaXJzdCIgOiAibGFzdCI7CgkJCX0KCQkJLy9maXhlcyBpc3N1ZSB3aGVyZSB3aGVuIGJvdGggX3NsaWRlcnMgYXJlIGF0IG1pbiB0aGV5IGNhbm5vdCBiZSBhZGp1c3RlZAoJCQlpZiAoIG1pbiA9PT0gbWF4ICkgewoJCQkJJC5kYXRhKCB0aGlzU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAxICk7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAwICk7CgkJCX0gZWxzZSB7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAiIiApOwoJCQkJJC5kYXRhKCB0aGlzU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAiIiApOwoJCQl9CgoJCQl0aGlzLl91cGRhdGVIaWdobGlnaHQoKTsKCgkJCWlmICggbWluID49IG1heCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgoJCV91cGRhdGVIaWdobGlnaHQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWluID0gcGFyc2VJbnQoICQuZGF0YSggdGhpcy5faW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmhhbmRsZS5nZXQoMCkuc3R5bGUucmlnaHQsIDEwICksCgkJCQltYXggPSBwYXJzZUludCggJC5kYXRhKCB0aGlzLl9pbnB1dExhc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuZ2V0KDApLnN0eWxlLnJpZ2h0LCAxMCApLAoJCQkJd2lkdGggPSAobWF4IC0gbWluKTsKCgkJCXRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXNsaWRlci1iZyIgKS5jc3MoewoJCQkJIm1hcmdpbi1yaWdodCI6IG1pbiArICIlIiwKCQkJCSJ3aWR0aCI6IHdpZHRoICsgIiUiCgkJCX0pOwoJCX0sCgoJCV9zZXRUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9pbnB1dEZpcnN0LnNsaWRlciggIm9wdGlvbiIsICJ0aGVtZSIsIHZhbHVlICk7CgkJCXRoaXMuX2lucHV0TGFzdC5zbGlkZXIoICJvcHRpb24iLCAidGhlbWUiLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXRUcmFja1RoZW1lOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX2lucHV0Rmlyc3Quc2xpZGVyKCAib3B0aW9uIiwgInRyYWNrVGhlbWUiLCB2YWx1ZSApOwoJCQl0aGlzLl9pbnB1dExhc3Quc2xpZGVyKCAib3B0aW9uIiwgInRyYWNrVGhlbWUiLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXRNaW5pOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX2lucHV0Rmlyc3Quc2xpZGVyKCAib3B0aW9uIiwgIm1pbmkiLCB2YWx1ZSApOwoJCQl0aGlzLl9pbnB1dExhc3Quc2xpZGVyKCAib3B0aW9uIiwgIm1pbmkiLCB2YWx1ZSApOwoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgISF2YWx1ZSApOwoJCX0sCgoJCV9zZXRIaWdobGlnaHQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5faW5wdXRGaXJzdC5zbGlkZXIoICJvcHRpb24iLCAiaGlnaGxpZ2h0IiwgdmFsdWUgKTsKCQkJdGhpcy5faW5wdXRMYXN0LnNsaWRlciggIm9wdGlvbiIsICJoaWdobGlnaHQiLCB2YWx1ZSApOwoJCX0sCgoJCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fbGFiZWwucHJlcGVuZFRvKCB0aGlzLmVsZW1lbnQgKTsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktcmFuZ2VzbGlkZXIgdWktbWluaSIgKTsKCQkJdGhpcy5faW5wdXRGaXJzdC5hZnRlciggdGhpcy5fc2xpZGVyRmlyc3QgKTsKCQkJdGhpcy5faW5wdXRMYXN0LmFmdGVyKCB0aGlzLl9zbGlkZXJMYXN0ICk7CgkJCXRoaXMuX3NsaWRlcnMucmVtb3ZlKCk7CgkJCXRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQiICkucmVtb3ZlQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1maXJzdCB1aS1yYW5nZXNsaWRlci1sYXN0IiApLnNsaWRlciggImRlc3Ryb3kiICk7CgkJfQoKCX0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJJC53aWRnZXQoICJtb2JpbGUudGV4dGlucHV0IiwgJC5tb2JpbGUudGV4dGlucHV0LCB7CgkJb3B0aW9uczogewoJCQljbGVhckJ0bjogZmFsc2UsCgkJCWNsZWFyQnRuVGV4dDogIkNsZWFyIHRleHQiCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgoJCQlpZiAoICEhdGhpcy5vcHRpb25zLmNsZWFyQnRuIHx8IHRoaXMuaXNTZWFyY2ggKSB7CgkJCQl0aGlzLl9hZGRDbGVhckJ0bigpOwoJCQl9CgkJfSwKCgkJY2xlYXJCdXR0b246IGZ1bmN0aW9uKCkgewoKCQkJcmV0dXJuICQoICI8YSBocmVmPScjJyBjbGFzcz0ndWktaW5wdXQtY2xlYXIgdWktYnRuIHVpLWljb24tZGVsZXRlIHVpLWJ0bi1pY29uLW5vdGV4dCB1aS1jb3JuZXItYWxsIiArCiAgICAiJyB0aXRsZT0nIiArIHRoaXMub3B0aW9ucy5jbGVhckJ0blRleHQgKyAiJz4iICsgdGhpcy5vcHRpb25zLmNsZWFyQnRuVGV4dCArICI8L2E+IiApOwoKCQl9LAoKCQlfY2xlYXJCdG5DbGljazogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl0aGlzLmVsZW1lbnQudmFsKCAiIiApCgkJCQkJLmZvY3VzKCkKCQkJCQkudHJpZ2dlciggImNoYW5nZSIgKTsKCgkJCXRoaXMuX2NsZWFyQnRuLmFkZENsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiApOwoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0sCgoJCV9hZGRDbGVhckJ0bjogZnVuY3Rpb24oKSB7CgoJCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCQl0aGlzLl9lbmhhbmNlQ2xlYXIoKTsKCQkJfQoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9jbGVhckJ0bjogdGhpcy53aWRnZXQoKS5maW5kKCJhLnVpLWlucHV0LWNsZWFyIikKCQkJfSk7CgoJCQl0aGlzLl9iaW5kQ2xlYXJFdmVudHMoKTsKCgkJCXRoaXMuX3RvZ2dsZUNsZWFyKCk7CgoJCX0sCgoJCV9lbmhhbmNlQ2xlYXI6IGZ1bmN0aW9uKCkgewoKCQkJdGhpcy5jbGVhckJ1dHRvbigpLmFwcGVuZFRvKCB0aGlzLndpZGdldCgpICk7CgkJCXRoaXMud2lkZ2V0KCkuYWRkQ2xhc3MoICJ1aS1pbnB1dC1oYXMtY2xlYXIiICk7CgoJCX0sCgoJCV9iaW5kQ2xlYXJFdmVudHM6IGZ1bmN0aW9uKCkgewoKCQkJdGhpcy5fb24oIHRoaXMuX2NsZWFyQnRuLCB7CgkJCQkiY2xpY2siOiAiX2NsZWFyQnRuQ2xpY2siCgkJCX0pOwoKCQkJdGhpcy5fb24oewoJCQkJImtleXVwIjogIl90b2dnbGVDbGVhciIsCgkJCQkiY2hhbmdlIjogIl90b2dnbGVDbGVhciIsCgkJCQkiaW5wdXQiOiAiX3RvZ2dsZUNsZWFyIiwKCQkJCSJmb2N1cyI6ICJfdG9nZ2xlQ2xlYXIiLAoJCQkJImJsdXIiOiAiX3RvZ2dsZUNsZWFyIiwKCQkJCSJjdXQiOiAiX3RvZ2dsZUNsZWFyIiwKCQkJCSJwYXN0ZSI6ICJfdG9nZ2xlQ2xlYXIiCgoJCQl9KTsKCgkJfSwKCgkJX3VuYmluZENsZWFyOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fb2ZmKCB0aGlzLl9jbGVhckJ0biwgImNsaWNrIik7CgkJCXRoaXMuX29mZiggdGhpcy5lbGVtZW50LCAia2V5dXAgY2hhbmdlIGlucHV0IGZvY3VzIGJsdXIgY3V0IHBhc3RlIiApOwoJCX0sCgoJCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJCWlmICggb3B0aW9ucy5jbGVhcmJ0biAhPT0gdW5kZWZpbmVkICYmICF0aGlzLmVsZW1lbnQuaXMoICJ0ZXh0YXJlYSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSIgKSApIHsKCQkJCWlmICggb3B0aW9ucy5jbGVhckJ0biApIHsKCQkJCQl0aGlzLl9hZGRDbGVhckJ0bigpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLl9kZXN0cm95Q2xlYXIoKTsKCQkJCX0KCQkJfQoKCQkJaWYgKCBvcHRpb25zLmNsZWFyQnRuVGV4dCAhPT0gdW5kZWZpbmVkICYmIHRoaXMuX2NsZWFyQnRuICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl9jbGVhckJ0bi50ZXh0KCBvcHRpb25zLmNsZWFyQnRuVGV4dCApOwoJCQl9CgkJfSwKCgkJX3RvZ2dsZUNsZWFyOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fZGVsYXkoICJfdG9nZ2xlQ2xlYXJDbGFzcyIsIDAgKTsKCQl9LAoKCQlfdG9nZ2xlQ2xlYXJDbGFzczogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX2NsZWFyQnRuLnRvZ2dsZUNsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiwgIXRoaXMuZWxlbWVudC52YWwoKSApOwoJCX0sCgoJCV9kZXN0cm95Q2xlYXI6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1pbnB1dC1oYXMtY2xlYXIiICk7CgkJCXRoaXMuX3VuYmluZENsZWFyKCkuX2NsZWFyQnRuLnJlbW92ZSgpOwoJCX0sCgoJCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCQkJdGhpcy5fZGVzdHJveUNsZWFyKCk7CgkJfQoKCX0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJJC53aWRnZXQoICJtb2JpbGUudGV4dGlucHV0IiwgJC5tb2JpbGUudGV4dGlucHV0LCB7CgkJb3B0aW9uczogewoJCQlhdXRvZ3Jvdzp0cnVlLAoJCQlrZXl1cFRpbWVvdXRCdWZmZXI6IDEwMAoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoKCQkJaWYgKCB0aGlzLm9wdGlvbnMuYXV0b2dyb3cgJiYgdGhpcy5pc1RleHRhcmVhICkgewoJCQkJdGhpcy5fYXV0b2dyb3coKTsKCQkJfQoJCX0sCgoJCV9hdXRvZ3JvdzogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX29uKHsKCQkJCSJrZXl1cCI6ICJfdGltZW91dCIsCgkJCQkiY2hhbmdlIjogIl90aW1lb3V0IiwKCQkJCSJpbnB1dCI6ICJfdGltZW91dCIsCgkJCQkicGFzdGUiOiAiX3RpbWVvdXQiLAoJCQl9KTsKCgkJCS8vIEF0dGFjaCB0byB0aGUgdmFyaW91cyB5b3UtaGF2ZS1iZWNvbWUtdmlzaWJsZSBub3RpZmljYXRpb25zIHRoYXQgdGhlCgkJCS8vIHZhcmlvdXMgZnJhbWV3b3JrIGVsZW1lbnRzIGVtaXQuCgkJCS8vIFRPRE86IFJlbW92ZSBhbGwgYnV0IHRoZSB1cGRhdGVsYXlvdXQgaGFuZGxlciBvbmNlICM2NDI2IGlzIGZpeGVkLgoJCQl0aGlzLl9vbiggdHJ1ZSwgdGhpcy5kb2N1bWVudCwgewoKCQkJCS8vIFRPRE86IE1vdmUgdG8gbm9uLWRlcHJlY2F0ZWQgZXZlbnQKCQkJCSJwYWdlc2hvdyI6ICJfaGFuZGxlU2hvdyIsCgkJCQkicG9wdXBiZWZvcmVwb3NpdGlvbiI6ICJfaGFuZGxlU2hvdyIsCgkJCQkidXBkYXRlbGF5b3V0IjogIl9oYW5kbGVTaG93IiwKCQkJCSJwYW5lbG9wZW4iOiAiX2hhbmRsZVNob3ciCgkJCX0pOwoJCX0sCgoJCS8vIFN5bmNocm9ub3VzbHkgZml4IHRoZSB3aWRnZXQgaGVpZ2h0IGlmIHRoaXMgd2lkZ2V0J3MgcGFyZW50cyBhcmUgc3VjaAoJCS8vIHRoYXQgdGhleSBzaG93L2hpZGUgY29udGVudCBhdCBydW50aW1lLiBXZSBzdGlsbCBuZWVkIHRvIGNoZWNrIHdoZXRoZXIKCQkvLyB0aGUgd2lkZ2V0IGlzIGFjdHVhbGx5IHZpc2libGUgaW4gY2FzZSBpdCBpcyBjb250YWluZWQgaW5zaWRlIG11bHRpcGxlCgkJLy8gc3VjaCBjb250YWluZXJzLiBGb3IgZXhhbXBsZTogcGFuZWwgY29udGFpbnMgY29sbGFwc2libGUgY29udGFpbnMKCQkvLyBhdXRvZ3JvdyB0ZXh0aW5wdXQuIFRoZSBwYW5lbCBtYXkgZW1pdCAicGFuZWxvcGVuIiBpbmRpY2F0aW5nIHRoYXQgaXRzCgkJLy8gY29udGVudCBoYXMgYmVjb21lIHZpc2libGUsIGJ1dCB0aGUgY29sbGFwc2libGUgaXMgc3RpbGwgY29sbGFwc2VkLCBzbwoJCS8vIHRoZSBhdXRvZ3JvdyB0ZXh0YXJlYSBpcyBzdGlsbCBub3QgdmlzaWJsZS4KCQlfaGFuZGxlU2hvdzogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoICQuY29udGFpbnMoIGV2ZW50LnRhcmdldCwgdGhpcy5lbGVtZW50WyAwIF0gKSAmJgoJCQkJdGhpcy5lbGVtZW50LmlzKCAiOnZpc2libGUiICkgKSB7CgoJCQkJaWYgKCBldmVudC50eXBlICE9PSAicG9wdXBiZWZvcmVwb3NpdGlvbiIgKSB7CgkJCQkJdGhpcy5lbGVtZW50CgkJCQkJCS5hZGRDbGFzcyggInVpLXRleHRpbnB1dC1hdXRvZ3Jvdy1yZXNpemUiICkKCQkJCQkJLm9uZSggInRyYW5zaXRpb25lbmQgd2Via2l0VHJhbnNpdGlvbkVuZCBvVHJhbnNpdGlvbkVuZCIsCgkJCQkJCQkkLnByb3h5KCBmdW5jdGlvbigpIHsKCQkJCQkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS10ZXh0aW5wdXQtYXV0b2dyb3ctcmVzaXplIiApOwoJCQkJCQkJfSwgdGhpcyApICk7CgkJCQl9CgkJCQl0aGlzLl9wcmVwYXJlSGVpZ2h0VXBkYXRlKCk7CgkJCX0KCQl9LAoKCQlfdW5iaW5kQXV0b2dyb3c6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9vZmYoIHRoaXMuZWxlbWVudCwgImtleXVwIGNoYW5nZSBpbnB1dCBwYXN0ZSIgKTsKCQkJdGhpcy5fb2ZmKCB0aGlzLmRvY3VtZW50LAoJCQkJInBhZ2VzaG93IHBvcHVwYmVmb3JlcG9zaXRpb24gdXBkYXRlbGF5b3V0IHBhbmVsb3BlbiIgKTsKCQl9LAoKCQlrZXl1cFRpbWVvdXQ6IG51bGwsCgoJCV9wcmVwYXJlSGVpZ2h0VXBkYXRlOiBmdW5jdGlvbiggZGVsYXkgKSB7CgkJCWlmICggdGhpcy5rZXl1cFRpbWVvdXQgKSB7CgkJCQljbGVhclRpbWVvdXQoIHRoaXMua2V5dXBUaW1lb3V0ICk7CgkJCX0KCQkJaWYgKCBkZWxheSA9PT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fdXBkYXRlSGVpZ2h0KCk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmtleXVwVGltZW91dCA9IHRoaXMuX2RlbGF5KCAiX3VwZGF0ZUhlaWdodCIsIGRlbGF5ICk7CgkJCX0KCQl9LAoKCQlfdGltZW91dDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3ByZXBhcmVIZWlnaHRVcGRhdGUoIHRoaXMub3B0aW9ucy5rZXl1cFRpbWVvdXRCdWZmZXIgKTsKCQl9LAoKCQlfdXBkYXRlSGVpZ2h0OiBmdW5jdGlvbigpIHsKCgkJCXRoaXMua2V5dXBUaW1lb3V0ID0gMDsKCgkJCXRoaXMuZWxlbWVudC5jc3MoewoJCQkJImhlaWdodCI6IDAsCgkJCQkibWluLWhlaWdodCI6IDAsCgkJCQkibWF4LWhlaWdodCI6IDAKCQkJfSk7CgoJCQl2YXIgcGFkZGluZ1RvcCwgcGFkZGluZ0JvdHRvbSwgcGFkZGluZ0hlaWdodCwKCQkJCXNjcm9sbEhlaWdodCA9IHRoaXMuZWxlbWVudFsgMCBdLnNjcm9sbEhlaWdodCwKCQkJCWNsaWVudEhlaWdodCA9IHRoaXMuZWxlbWVudFsgMCBdLmNsaWVudEhlaWdodCwKCQkJCWJvcmRlclRvcCA9IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC5jc3MoICJib3JkZXItdG9wLXdpZHRoIiApICksCgkJCQlib3JkZXJCb3R0b20gPSBwYXJzZUZsb2F0KCB0aGlzLmVsZW1lbnQuY3NzKCAiYm9yZGVyLWJvdHRvbS13aWR0aCIgKSApLAoJCQkJYm9yZGVySGVpZ2h0ID0gYm9yZGVyVG9wICsgYm9yZGVyQm90dG9tLAoJCQkJaGVpZ2h0ID0gc2Nyb2xsSGVpZ2h0ICsgYm9yZGVySGVpZ2h0ICsgMTU7CgoJCQkvLyBJc3N1ZSA2MTc5OiBQYWRkaW5nIGlzIG5vdCBpbmNsdWRlZCBpbiBzY3JvbGxIZWlnaHQgYW5kCgkJCS8vIGNsaWVudEhlaWdodCBieSBGaXJlZm94IGlmIG5vIHNjcm9sbGJhciBpcyB2aXNpYmxlLiBCZWNhdXNlCgkJCS8vIHRleHRhcmVhcyB1c2UgdGhlIGJvcmRlci1ib3ggYm94LXNpemluZyBtb2RlbCwgcGFkZGluZyBzaG91bGQgYmUKCQkJLy8gaW5jbHVkZWQgaW4gdGhlIG5ldyAoYXNzaWduZWQpIGhlaWdodC4gQmVjYXVzZSB0aGUgaGVpZ2h0IGlzIHNldAoJCQkvLyB0byAwLCBjbGllbnRIZWlnaHQgPT0gMCBpbiBGaXJlZm94LiBUaGVyZWZvcmUsIHdlIGNhbiB1c2UgdGhpcyB0bwoJCQkvLyBjaGVjayBpZiBwYWRkaW5nIG11c3QgYmUgYWRkZWQuCgkJCWlmICggY2xpZW50SGVpZ2h0ID09PSAwICkgewoJCQkJcGFkZGluZ1RvcCA9IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC5jc3MoICJwYWRkaW5nLXRvcCIgKSApOwoJCQkJcGFkZGluZ0JvdHRvbSA9IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC5jc3MoICJwYWRkaW5nLWJvdHRvbSIgKSApOwoJCQkJcGFkZGluZ0hlaWdodCA9IHBhZGRpbmdUb3AgKyBwYWRkaW5nQm90dG9tOwoKCQkJCWhlaWdodCArPSBwYWRkaW5nSGVpZ2h0OwoJCQl9CgoJCQl0aGlzLmVsZW1lbnQuY3NzKHsKCQkJCSJoZWlnaHQiOiBoZWlnaHQsCgkJCQkibWluLWhlaWdodCI6ICIiLAoJCQkJIm1heC1oZWlnaHQiOiAiIgoJCQl9KTsKCQl9LAoKCQlyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLm9wdGlvbnMuYXV0b2dyb3cgJiYgdGhpcy5pc1RleHRhcmVhICkgewoJCQkJdGhpcy5fdXBkYXRlSGVpZ2h0KCk7CgkJCX0KCQl9LAoKCQlfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgoJCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoKCQkJaWYgKCBvcHRpb25zLmF1dG9ncm93ICE9PSB1bmRlZmluZWQgJiYgdGhpcy5pc1RleHRhcmVhICkgewoJCQkJaWYgKCBvcHRpb25zLmF1dG9ncm93ICkgewoJCQkJCXRoaXMuX2F1dG9ncm93KCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuX3VuYmluZEF1dG9ncm93KCk7CgkJCQl9CgkJCX0KCQl9CgoJfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2VsZWN0bWVudSIsICQuZXh0ZW5kKCB7Cglpbml0U2VsZWN0b3I6ICJzZWxlY3Q6bm90KCA6anFtRGF0YShyb2xlPSdzbGlkZXInKSk6bm90KCA6anFtRGF0YShyb2xlPSdmbGlwc3dpdGNoJykgKSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWljb246ICJjYXJhdC1kIiwKCQlpY29ucG9zOiAibGVmdCIsCgkJaW5saW5lOiBmYWxzZSwKCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpY29uc2hhZG93OiBmYWxzZSwgLyogVE9ETzogRGVwcmVjYXRlZCBpbiAxLjQsIHJlbW92ZSBpbiAxLjUuICovCgkJb3ZlcmxheVRoZW1lOiBudWxsLAoJCWRpdmlkZXJUaGVtZTogbnVsbCwKCQloaWRlUGxhY2Vob2xkZXJNZW51SXRlbXM6IHRydWUsCgkJY2xvc2VUZXh0OiAiQ2xvc2UiLAoJCW5hdGl2ZU1lbnU6IHRydWUsCgkJLy8gVGhpcyBvcHRpb24gZGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MgZGV2aWNlcy4KCQlwcmV2ZW50Rm9jdXNab29tOiAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSwKCQltaW5pOiBmYWxzZQoJfSwKCglfYnV0dG9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJCggIjxkaXYvPiIgKTsKCX0sCgoJX3NldERpc2FibGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHZhbHVlICk7CgkJdGhpcy5idXR0b24uYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHZhbHVlICk7Cgl9LAoKCV9mb2N1c0J1dHRvbiA6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCXNlbGYuYnV0dG9uLmZvY3VzKCk7CgkJfSwgNDApOwoJfSwKCglfc2VsZWN0T3B0aW9uczogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuc2VsZWN0LmZpbmQoICJvcHRpb24iICk7Cgl9LAoKCS8vIHNldHVwIGl0ZW1zIHRoYXQgYXJlIGdlbmVyYWxseSBuZWNlc3NhcnkgZm9yIHNlbGVjdCBtZW51IGV4dGVuc2lvbgoJX3ByZUV4dGVuc2lvbjogZnVuY3Rpb24oKSB7CgkJdmFyIGlubGluZSA9IHRoaXMub3B0aW9ucy5pbmxpbmUgfHwgdGhpcy5lbGVtZW50LmpxbURhdGEoICJpbmxpbmUiICksCgkJCW1pbmkgPSB0aGlzLm9wdGlvbnMubWluaSB8fCB0aGlzLmVsZW1lbnQuanFtRGF0YSggIm1pbmkiICksCgkJCWNsYXNzZXMgPSAiIjsKCQkvLyBUT0RPOiBQb3N0IDEuMS0tb25jZSB3ZSBoYXZlIHRpbWUgdG8gdGVzdCB0aG9yb3VnaGx5LS1hbnkgY2xhc3NlcyBtYW51YWxseSBhcHBsaWVkIHRvIHRoZSBvcmlnaW5hbCBlbGVtZW50IHNob3VsZCBiZSBjYXJyaWVkIG92ZXIgdG8gdGhlIGVuaGFuY2VkIGVsZW1lbnQsIHdpdGggYW4gYC1lbmhhbmNlZGAgc3VmZml4LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTc3CgkJLyogaWYgKCAkZWxbMF0uY2xhc3NOYW1lLmxlbmd0aCApIHsKCQkJY2xhc3NlcyA9ICRlbFswXS5jbGFzc05hbWU7CgkJfSAqLwoJCWlmICggISF+dGhpcy5lbGVtZW50WzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLWxlZnQiICkgKSB7CgkJCWNsYXNzZXMgPSAiIHVpLWJ0bi1sZWZ0IjsKCQl9CgoJCWlmICggICEhfnRoaXMuZWxlbWVudFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1yaWdodCIgKSApIHsKCQkJY2xhc3NlcyA9ICIgdWktYnRuLXJpZ2h0IjsKCQl9CgoJCWlmICggaW5saW5lICkgewoJCQljbGFzc2VzICs9ICIgdWktYnRuLWlubGluZSI7CgkJfQoJCWlmICggbWluaSApIHsKCQkJY2xhc3NlcyArPSAiIHVpLW1pbmkiOwoJCX0KCgkJdGhpcy5zZWxlY3QgPSB0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1idG4tbGVmdCB1aS1idG4tcmlnaHQiICkud3JhcCggIjxkaXYgY2xhc3M9J3VpLXNlbGVjdCIgKyBjbGFzc2VzICsgIic+IiApOwoJCXRoaXMuc2VsZWN0SWQgID0gdGhpcy5zZWxlY3QuYXR0ciggImlkIiApIHx8ICggInNlbGVjdC0iICsgdGhpcy51dWlkICk7CgkJdGhpcy5idXR0b25JZCA9IHRoaXMuc2VsZWN0SWQgKyAiLWJ1dHRvbiI7CgkJdGhpcy5sYWJlbCA9ICQoICJsYWJlbFtmb3I9JyIrIHRoaXMuc2VsZWN0SWQgKyInXSIgKTsKCQl0aGlzLmlzTXVsdGlwbGUgPSB0aGlzLnNlbGVjdFsgMCBdLm11bHRpcGxlOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIHdyYXBwZXIgPSB0aGlzLmVsZW1lbnQucGFyZW50cyggIi51aS1zZWxlY3QiICk7CgkJaWYgKCB3cmFwcGVyLmxlbmd0aCA+IDAgKSB7CgkJCWlmICggd3JhcHBlci5pcyggIi51aS1idG4tbGVmdCwgLnVpLWJ0bi1yaWdodCIgKSApIHsKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggd3JhcHBlci5oYXNDbGFzcyggInVpLWJ0bi1sZWZ0IiApID8gInVpLWJ0bi1sZWZ0IiA6ICJ1aS1idG4tcmlnaHQiICk7CgkJCX0KCQkJdGhpcy5lbGVtZW50Lmluc2VydEFmdGVyKCB3cmFwcGVyICk7CgkJCXdyYXBwZXIucmVtb3ZlKCk7CgkJfQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9wcmVFeHRlbnNpb24oKTsKCgkJdGhpcy5idXR0b24gPSB0aGlzLl9idXR0b24oKTsKCgkJdmFyIHNlbGYgPSB0aGlzLAoKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCgkJCWljb25wb3MgPSBvcHRpb25zLmljb24gPyAoIG9wdGlvbnMuaWNvbnBvcyB8fCB0aGlzLnNlbGVjdC5qcW1EYXRhKCAiaWNvbnBvcyIgKSApIDogZmFsc2UsCgoJCQlidXR0b24gPSB0aGlzLmJ1dHRvbgoJCQkJLmluc2VydEJlZm9yZSggdGhpcy5zZWxlY3QgKQoJCQkJLmF0dHIoICJpZCIsIHRoaXMuYnV0dG9uSWQgKQoJCQkJLmFkZENsYXNzKCAidWktYnRuIiArCgkJCQkJKCBvcHRpb25zLmljb24gPyAoICIgdWktaWNvbi0iICsgb3B0aW9ucy5pY29uICsgIiB1aS1idG4taWNvbi0iICsgaWNvbnBvcyArCgkJCQkJKCBvcHRpb25zLmljb25zaGFkb3cgPyAiIHVpLXNoYWRvdy1pY29uIiA6ICIiICkgKSA6CSIiICkgKyAvKiBUT0RPOiBSZW1vdmUgaW4gMS41LiAqLwoJCQkJCSggb3B0aW9ucy50aGVtZSA/ICIgdWktYnRuLSIgKyBvcHRpb25zLnRoZW1lIDogIiIgKSArCgkJCQkJKCBvcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIgKSArCgkJCQkJKCBvcHRpb25zLnNoYWRvdyA/ICIgdWktc2hhZG93IiA6ICIiICkgKTsKCgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgoJCS8vIE9wZXJhIGRvZXMgbm90IHByb3Blcmx5IHN1cHBvcnQgb3BhY2l0eSBvbiBzZWxlY3QgZWxlbWVudHMKCQkvLyBJbiBNaW5pLCBpdCBoaWRlcyB0aGUgZWxlbWVudCwgYnV0IG5vdCBpdHMgdGV4dAoJCS8vIE9uIHRoZSBkZXNrdG9wLGl0IHNlZW1zIHRvIGRvIHRoZSBvcHBvc2l0ZQoJCS8vIGZvciB0aGVzZSByZWFzb25zLCB1c2luZyB0aGUgbmF0aXZlTWVudSBvcHRpb24gcmVzdWx0cyBpbiBhIGZ1bGwgbmF0aXZlIHNlbGVjdCBpbiBPcGVyYQoJCWlmICggb3B0aW9ucy5uYXRpdmVNZW51ICYmIHdpbmRvdy5vcGVyYSAmJiB3aW5kb3cub3BlcmEudmVyc2lvbiApIHsKCQkJYnV0dG9uLmFkZENsYXNzKCAidWktc2VsZWN0LW5hdGl2ZW9ubHkiICk7CgkJfQoKCQkvLyBBZGQgY291bnRlciBmb3IgbXVsdGkgc2VsZWN0cwoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQl0aGlzLmJ1dHRvbkNvdW50ID0gJCggIjxzcGFuPiIgKQoJCQkJLmFkZENsYXNzKCAidWktbGktY291bnQgdWktYm9keS1pbmhlcml0IiApCgkJCQkuaGlkZSgpCgkJCQkuYXBwZW5kVG8oIGJ1dHRvbi5hZGRDbGFzcyggInVpLWxpLWhhcy1jb3VudCIgKSApOwoJCX0KCgkJLy8gRGlzYWJsZSBpZiBzcGVjaWZpZWQKCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIgKSkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCS8vIEV2ZW50cyBvbiBuYXRpdmUgc2VsZWN0CgkJdGhpcy5zZWxlY3QuY2hhbmdlKGZ1bmN0aW9uKCkgewoJCQlzZWxmLnJlZnJlc2goKTsKCgkJCWlmICggISFvcHRpb25zLm5hdGl2ZU1lbnUgKSB7CgkJCQl0aGlzLmJsdXIoKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCgkJdGhpcy5fb24oIHRoaXMuYnV0dG9uLCB7CgkJCWtleWRvd246ICJfaGFuZGxlS2V5ZG93biIKCQl9KTsKCgkJdGhpcy5idWlsZCgpOwoJfSwKCglidWlsZDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLnNlbGVjdAoJCQkuYXBwZW5kVG8oIHNlbGYuYnV0dG9uICkKCQkJLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBBZGQgYWN0aXZlIGNsYXNzIHRvIGJ1dHRvbgoJCQkJc2VsZi5idXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJmb2N1cyB2bW91c2VvdmVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3ZlciIgKTsKCQkJfSkKCQkJLmJpbmQoICJ2bW91c2Vtb3ZlIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBSZW1vdmUgYWN0aXZlIGNsYXNzIG9uIHNjcm9sbC90b3VjaG1vdmUKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImNoYW5nZSBibHVyIHZtb3VzZW91dCIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24udHJpZ2dlciggInZtb3VzZW91dCIgKQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSk7CgoJCS8vIEluIG1hbnkgc2l0dWF0aW9ucywgaU9TIHdpbGwgem9vbSBpbnRvIHRoZSBzZWxlY3QgdXBvbiB0YXAsIHRoaXMgcHJldmVudHMgdGhhdCBmcm9tIGhhcHBlbmluZwoJCXNlbGYuYnV0dG9uLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCQlzZWxmLmxhYmVsLmJpbmQoICJjbGljayBmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7CgkJc2VsZi5zZWxlY3QuYmluZCggImZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCQlzZWxmLmJ1dHRvbi5iaW5kKCAibW91c2V1cCIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQkJfSwgMCApOwoJCQl9CgkJfSk7CgkJc2VsZi5zZWxlY3QuYmluZCggImJsdXIiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCgl9LAoKCXNlbGVjdGVkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZCIgKTsKCX0sCgoJc2VsZWN0ZWRJbmRpY2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXJldHVybiB0aGlzLnNlbGVjdGVkKCkubWFwKGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gc2VsZi5fc2VsZWN0T3B0aW9ucygpLmluZGV4KCB0aGlzICk7CgkJfSkuZ2V0KCk7Cgl9LAoKCXNldEJ1dHRvblRleHQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJc2VsZWN0ZWQgPSB0aGlzLnNlbGVjdGVkKCksCgkJCXRleHQgPSB0aGlzLnBsYWNlaG9sZGVyLAoJCQlzcGFuID0gJCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgKTsKCgkJdGhpcy5idXR0b24uY2hpbGRyZW4oICJzcGFuIiApLm5vdCggIi51aS1saS1jb3VudCIgKS5yZW1vdmUoKS5lbmQoKS5lbmQoKS5wcmVwZW5kKCAoZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZWN0ZWQubGVuZ3RoICkgewoJCQkJdGV4dCA9IHNlbGVjdGVkLm1hcChmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gJCggdGhpcyApLnRleHQoKTsKCQkJCX0pLmdldCgpLmpvaW4oICIsICIgKTsKCQkJfSBlbHNlIHsKCQkJCXRleHQgPSBzZWxmLnBsYWNlaG9sZGVyOwoJCQl9CgoJCQlpZiAoIHRleHQgKSB7CgkJCQlzcGFuLnRleHQoIHRleHQgKTsKCQkJfSBlbHNlIHsKCQkJCXNwYW4uaHRtbCggIiZuYnNwOyIgKTsKCQkJfQoKCQkJLy8gVE9ETyBwb3NzaWJseSBhZ2dyZWdhdGUgbXVsdGlwbGUgc2VsZWN0IG9wdGlvbiBjbGFzc2VzCgkJCXJldHVybiBzcGFuCgkJCQkuYWRkQ2xhc3MoIHNlbGYuc2VsZWN0LmF0dHIoICJjbGFzcyIgKSApCgkJCQkuYWRkQ2xhc3MoIHNlbGVjdGVkLmF0dHIoICJjbGFzcyIgKSApCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0pKCkpOwoJfSwKCglzZXRCdXR0b25Db3VudDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpOwoKCQkvLyBtdWx0aXBsZSBjb3VudCBpbnNpZGUgYnV0dG9uCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnRbIHNlbGVjdGVkLmxlbmd0aCA+IDEgPyAic2hvdyIgOiAiaGlkZSIgXSgpLnRleHQoIHNlbGVjdGVkLmxlbmd0aCApOwoJCX0KCX0sCgoJX2hhbmRsZUtleWRvd246IGZ1bmN0aW9uKCAvKiBldmVudCAqLyApIHsKCQl0aGlzLl9kZWxheSggIl9yZWZyZXNoQnV0dG9uIiApOwoJfSwKCglfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCglfcmVmcmVzaEJ1dHRvbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgkJdGhpcy5zZXRCdXR0b25Db3VudCgpOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9yZWZyZXNoQnV0dG9uKCk7Cgl9LAoKCS8vIG9wZW4gYW5kIGNsb3NlIHByZXNlcnZlZCBpbiBuYXRpdmUgc2VsZWN0cwoJLy8gdG8gc2ltcGxpZnkgdXNlcnMgY29kZSB3aGVuIGxvb3Bpbmcgb3ZlciBzZWxlY3RzCglvcGVuOiAkLm5vb3AsCgljbG9zZTogJC5ub29wLAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3NldERpc2FibGVkKCB0cnVlICk7CgkJdGhpcy5idXR0b24uYWRkQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXREaXNhYmxlZCggZmFsc2UgKTsKCQl0aGlzLmJ1dHRvbi5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ICkgKTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUubGlua3MgPSBmdW5jdGlvbiggdGFyZ2V0ICkgewoKCS8vbGlua3Mgd2l0aGluIGNvbnRlbnQgYXJlYXMsIHRlc3RzIGluY2x1ZGVkIHdpdGggcGFnZQoJJCggdGFyZ2V0ICkKCQkuZmluZCggImEiICkKCQkuanFtRW5oYW5jZWFibGUoKQoJCS5maWx0ZXIoICI6anFtRGF0YShyZWw9J3BvcHVwJylbaHJlZl1baHJlZiE9JyddIiApCgkJLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkvLyBBY2Nlc3NpYmlsaXR5IGluZm8gZm9yIHBvcHVwcwoJCQl2YXIgZWxlbWVudCA9IHRoaXMsCgkJCQlpZHJlZiA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCAiaHJlZiIgKS5zdWJzdHJpbmcoIDEgKTsKCgkJCWlmICggaWRyZWYgKSB7CgkJCQllbGVtZW50LnNldEF0dHJpYnV0ZSggImFyaWEtaGFzcG9wdXAiLCB0cnVlICk7CgkJCQllbGVtZW50LnNldEF0dHJpYnV0ZSggImFyaWEtb3ducyIsIGlkcmVmICk7CgkJCQllbGVtZW50LnNldEF0dHJpYnV0ZSggImFyaWEtZXhwYW5kZWQiLCBmYWxzZSApOwoJCQl9CgkJfSkKCQkuZW5kKCkKCQkubm90KCAiLnVpLWJ0biwgOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiICkKCQkuYWRkQ2xhc3MoICJ1aS1saW5rIiApOwoKfTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCmZ1bmN0aW9uIGZpdFNlZ21lbnRJbnNpZGVTZWdtZW50KCB3aW5kb3dTaXplLCBzZWdtZW50U2l6ZSwgb2Zmc2V0LCBkZXNpcmVkICkgewoJdmFyIHJldHVyblZhbHVlID0gZGVzaXJlZDsKCglpZiAoIHdpbmRvd1NpemUgPCBzZWdtZW50U2l6ZSApIHsKCQkvLyBDZW50ZXIgc2VnbWVudCBpZiBpdCdzIGJpZ2dlciB0aGFuIHRoZSB3aW5kb3cKCQlyZXR1cm5WYWx1ZSA9IG9mZnNldCArICggd2luZG93U2l6ZSAtIHNlZ21lbnRTaXplICkgLyAyOwoJfSBlbHNlIHsKCQkvLyBPdGhlcndpc2UgY2VudGVyIGl0IGF0IHRoZSBkZXNpcmVkIGNvb3JkaW5hdGUgd2hpbGUga2VlcGluZyBpdCBjb21wbGV0ZWx5IGluc2lkZSB0aGUgd2luZG93CgkJcmV0dXJuVmFsdWUgPSBNYXRoLm1pbiggTWF0aC5tYXgoIG9mZnNldCwgZGVzaXJlZCAtIHNlZ21lbnRTaXplIC8gMiApLCBvZmZzZXQgKyB3aW5kb3dTaXplIC0gc2VnbWVudFNpemUgKTsKCX0KCglyZXR1cm4gcmV0dXJuVmFsdWU7Cn0KCmZ1bmN0aW9uIGdldFdpbmRvd0Nvb3JkaW5hdGVzKCB0aGVXaW5kb3cgKSB7CglyZXR1cm4gewoJCXg6IHRoZVdpbmRvdy5zY3JvbGxMZWZ0KCksCgkJeTogdGhlV2luZG93LnNjcm9sbFRvcCgpLAoJCWN4OiAoIHRoZVdpbmRvd1sgMCBdLmlubmVyV2lkdGggfHwgdGhlV2luZG93LndpZHRoKCkgKSwKCQljeTogKCB0aGVXaW5kb3dbIDAgXS5pbm5lckhlaWdodCB8fCB0aGVXaW5kb3cuaGVpZ2h0KCkgKQoJfTsKfQoKJC53aWRnZXQoICJtb2JpbGUucG9wdXAiLCB7CglvcHRpb25zOiB7CgkJd3JhcHBlckNsYXNzOiBudWxsLAoJCXRoZW1lOiBudWxsLAoJCW92ZXJsYXlUaGVtZTogbnVsbCwKCQlzaGFkb3c6IHRydWUsCgkJY29ybmVyczogdHJ1ZSwKCQl0cmFuc2l0aW9uOiAibm9uZSIsCgkJcG9zaXRpb25UbzogIm9yaWdpbiIsCgkJdG9sZXJhbmNlOiBudWxsLAoJCWNsb3NlTGlua1NlbGVjdG9yOiAiYTpqcW1EYXRhKHJlbD0nYmFjaycpIiwKCQljbG9zZUxpbmtFdmVudHM6ICJjbGljay5wb3B1cCIsCgkJbmF2aWdhdGVFdmVudHM6ICJuYXZpZ2F0ZS5wb3B1cCIsCgkJY2xvc2VFdmVudHM6ICJuYXZpZ2F0ZS5wb3B1cCBwYWdlYmVmb3JlY2hhbmdlLnBvcHVwIiwKCQlkaXNtaXNzaWJsZTogdHJ1ZSwKCQllbmhhbmNlZDogZmFsc2UsCgoJCS8vIE5PVEUgV2luZG93cyBQaG9uZSA3IGhhcyBhIHNjcm9sbCBwb3NpdGlvbiBjYWNoaW5nIGlzc3VlIHRoYXQKCQkvLyAgICAgIHJlcXVpcmVzIHVzIHRvIGRpc2FibGUgcG9wdXAgaGlzdG9yeSBtYW5hZ2VtZW50IGJ5IGRlZmF1bHQKCQkvLyAgICAgIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDc4NAoJCS8vCgkJLy8gTk9URSB0aGlzIG9wdGlvbiBpcyBtb2RpZmllZCBpbiBfY3JlYXRlIQoJCWhpc3Rvcnk6ICEkLm1vYmlsZS5icm93c2VyLm9sZElFCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGVFbGVtZW50ID0gdGhpcy5lbGVtZW50LAoJCQlteUlkID0gdGhlRWxlbWVudC5hdHRyKCAiaWQiICksCgkJCWN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQkvLyBXZSBuZWVkIHRvIGFkanVzdCB0aGUgaGlzdG9yeSBvcHRpb24gdG8gYmUgZmFsc2UgaWYgdGhlcmUncyBubyBBSkFYIG5hdi4KCQkvLyBXZSBjYW4ndCBkbyBpdCBpbiB0aGUgb3B0aW9uIGRlY2xhcmF0aW9ucyBiZWNhdXNlIHRob3NlIGFyZSBydW4gYmVmb3JlCgkJLy8gaXQgaXMgZGV0ZXJtaW5lZCB3aGV0aGVyIHRoZXJlIHNoYWxsIGJlIEFKQVggbmF2LgoJCWN1cnJlbnRPcHRpb25zLmhpc3RvcnkgPSBjdXJyZW50T3B0aW9ucy5oaXN0b3J5ICYmICQubW9iaWxlLmFqYXhFbmFibGVkICYmICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkOwoKCQkvLyBEZWZpbmUgaW5zdGFuY2UgdmFyaWFibGVzCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3Njcm9sbFRvcDogMCwKCQkJX3BhZ2U6IHRoZUVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLAoJCQlfdWk6IG51bGwsCgkJCV9mYWxsYmFja1RyYW5zaXRpb246ICIiLAoJCQlfY3VycmVudFRyYW5zaXRpb246IGZhbHNlLAoJCQlfcHJlcmVxdWlzaXRlczogbnVsbCwKCQkJX2lzT3BlbjogZmFsc2UsCgkJCV90b2xlcmFuY2U6IG51bGwsCgkJCV9yZXNpemVEYXRhOiBudWxsLAoJCQlfaWdub3JlUmVzaXplVG86IDAsCgkJCV9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3M6IGZhbHNlCgkJfSk7CgoJCWlmICggdGhpcy5fcGFnZS5sZW5ndGggPT09IDAgKSB7CgkJCXRoaXMuX3BhZ2UgPSAkKCAiYm9keSIgKTsKCQl9CgoJCWlmICggY3VycmVudE9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX3VpID0gewoJCQkJY29udGFpbmVyOiB0aGVFbGVtZW50LnBhcmVudCgpLAoJCQkJc2NyZWVuOiB0aGVFbGVtZW50LnBhcmVudCgpLnByZXYoKSwKCQkJCXBsYWNlaG9sZGVyOiAkKCB0aGlzLmRvY3VtZW50WyAwIF0uZ2V0RWxlbWVudEJ5SWQoIG15SWQgKyAiLXBsYWNlaG9sZGVyIiApICkKCQkJfTsKCQl9IGVsc2UgewoJCQl0aGlzLl91aSA9IHRoaXMuX2VuaGFuY2UoIHRoZUVsZW1lbnQsIG15SWQgKTsKCQkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCBjdXJyZW50T3B0aW9ucy50cmFuc2l0aW9uICk7CgkJfQoJCXRoaXMKCQkJLl9zZXRUb2xlcmFuY2UoIGN1cnJlbnRPcHRpb25zLnRvbGVyYW5jZSApCgkJCS5fdWkuZm9jdXNFbGVtZW50ID0gdGhpcy5fdWkuY29udGFpbmVyOwoKCQkvLyBFdmVudCBoYW5kbGVycwoJCXRoaXMuX29uKCB0aGlzLl91aS5zY3JlZW4sIHsgInZjbGljayI6ICJfZWF0RXZlbnRBbmRDbG9zZSIgfSApOwoJCXRoaXMuX29uKCB0aGlzLndpbmRvdywgewoJCQlvcmllbnRhdGlvbmNoYW5nZTogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dPcmllbnRhdGlvbmNoYW5nZSIgKSwKCQkJcmVzaXplOiAkLnByb3h5KCB0aGlzLCAiX2hhbmRsZVdpbmRvd1Jlc2l6ZSIgKSwKCQkJa2V5dXA6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93S2V5VXAiICkKCQl9KTsKCQl0aGlzLl9vbiggdGhpcy5kb2N1bWVudCwgeyAiZm9jdXNpbiI6ICJfaGFuZGxlRG9jdW1lbnRGb2N1c0luIiB9ICk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbiggdGhlRWxlbWVudCwgbXlJZCApIHsKCQl2YXIgY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCXdyYXBwZXJDbGFzcyA9IGN1cnJlbnRPcHRpb25zLndyYXBwZXJDbGFzcywKCQkJdWkgPSB7CgkJCQlzY3JlZW46ICQoICI8ZGl2IGNsYXNzPSd1aS1zY3JlZW4taGlkZGVuIHVpLXBvcHVwLXNjcmVlbiAiICsKCQkJCXRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktb3ZlcmxheS0iLCBjdXJyZW50T3B0aW9ucy5vdmVybGF5VGhlbWUgKSArICInPjwvZGl2PiIgKSwKCQkJCXBsYWNlaG9sZGVyOiAkKCAiPGRpdiBzdHlsZT0nZGlzcGxheTogbm9uZTsnPjwhLS0gcGxhY2Vob2xkZXIgLS0+PC9kaXY+IiApLAoJCQkJY29udGFpbmVyOiAkKCAiPGRpdiBjbGFzcz0ndWktcG9wdXAtY29udGFpbmVyIHVpLXBvcHVwLWhpZGRlbiB1aS1wb3B1cC10cnVuY2F0ZSIgKwoJCQkJCSggd3JhcHBlckNsYXNzID8gKCAiICIgKyB3cmFwcGVyQ2xhc3MgKSA6ICIiICkgKyAiJz48L2Rpdj4iICkKCQkJfSwKCQkJZnJhZ21lbnQgPSB0aGlzLmRvY3VtZW50WyAwIF0uY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoKCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggdWkuc2NyZWVuWyAwIF0gKTsKCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggdWkuY29udGFpbmVyWyAwIF0gKTsKCgkJaWYgKCBteUlkICkgewoJCQl1aS5zY3JlZW4uYXR0ciggImlkIiwgbXlJZCArICItc2NyZWVuIiApOwoJCQl1aS5jb250YWluZXIuYXR0ciggImlkIiwgbXlJZCArICItcG9wdXAiICk7CgkJCXVpLnBsYWNlaG9sZGVyCgkJCQkuYXR0ciggImlkIiwgbXlJZCArICItcGxhY2Vob2xkZXIiICkKCQkJCS5odG1sKCAiPCEtLSBwbGFjZWhvbGRlciBmb3IgIiArIG15SWQgKyAiIC0tPiIgKTsKCQl9CgoJCS8vIEFwcGx5IHRoZSBwcm90bwoJCXRoaXMuX3BhZ2VbIDAgXS5hcHBlbmRDaGlsZCggZnJhZ21lbnQgKTsKCQkvLyBMZWF2ZSBhIHBsYWNlaG9sZGVyIHdoZXJlIHRoZSBlbGVtZW50IHVzZWQgdG8gYmUKCQl1aS5wbGFjZWhvbGRlci5pbnNlcnRBZnRlciggdGhlRWxlbWVudCApOwoJCXRoZUVsZW1lbnQKCQkJLmRldGFjaCgpCgkJCS5hZGRDbGFzcyggInVpLXBvcHVwICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIGN1cnJlbnRPcHRpb25zLnRoZW1lICkgKyAiICIgKwoJCQkJKCBjdXJyZW50T3B0aW9ucy5zaGFkb3cgPyAidWktb3ZlcmxheS1zaGFkb3cgIiA6ICIiICkgKwoJCQkJKCBjdXJyZW50T3B0aW9ucy5jb3JuZXJzID8gInVpLWNvcm5lci1hbGwgIiA6ICIiICkgKQoJCQkuYXBwZW5kVG8oIHVpLmNvbnRhaW5lciApOwoKCQlyZXR1cm4gdWk7Cgl9LAoKCV9lYXRFdmVudEFuZENsb3NlOiBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJdGhlRXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl0aGVFdmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNtaXNzaWJsZSApIHsKCQkJdGhpcy5jbG9zZSgpOwoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCS8vIE1ha2Ugc3VyZSB0aGUgc2NyZWVuIGNvdmVycyB0aGUgZW50aXJlIGRvY3VtZW50IC0gQ1NTIGlzIHNvbWV0aW1lcyBub3QKCS8vIGVub3VnaCB0byBhY2NvbXBsaXNoIHRoaXMuCglfcmVzaXplU2NyZWVuOiBmdW5jdGlvbigpIHsKCQl2YXIgc2NyZWVuID0gdGhpcy5fdWkuc2NyZWVuLAoJCQlwb3B1cEhlaWdodCA9IHRoaXMuX3VpLmNvbnRhaW5lci5vdXRlckhlaWdodCggdHJ1ZSApLAoJCQlzY3JlZW5IZWlnaHQgPSBzY3JlZW4ucmVtb3ZlQXR0ciggInN0eWxlIiApLmhlaWdodCgpLAoKCQkJLy8gU3VidHJhY3RpbmcgMSBoZXJlIGlzIG5lY2Vzc2FyeSBmb3IgYW4gb2JzY3VyZSBBbmRyZG9pZCA0LjAgYnVnIHdoZXJlCgkJCS8vIHRoZSBicm93c2VyIGhhbmdzIGlmIHRoZSBzY3JlZW4gY292ZXJzIHRoZSBlbnRpcmUgZG9jdW1lbnQgOi8KCQkJZG9jdW1lbnRIZWlnaHQgPSB0aGlzLmRvY3VtZW50LmhlaWdodCgpIC0gMTsKCgkJaWYgKCBzY3JlZW5IZWlnaHQgPCBkb2N1bWVudEhlaWdodCApIHsKCQkJc2NyZWVuLmhlaWdodCggZG9jdW1lbnRIZWlnaHQgKTsKCQl9IGVsc2UgaWYgKCBwb3B1cEhlaWdodCA+IHNjcmVlbkhlaWdodCApIHsKCQkJc2NyZWVuLmhlaWdodCggcG9wdXBIZWlnaHQgKTsKCQl9Cgl9LAoKCV9oYW5kbGVXaW5kb3dLZXlVcDogZnVuY3Rpb24oIHRoZUV2ZW50ICkgewoJCWlmICggdGhpcy5faXNPcGVuICYmIHRoZUV2ZW50LmtleUNvZGUgPT09ICQubW9iaWxlLmtleUNvZGUuRVNDQVBFICkgewoJCQlyZXR1cm4gdGhpcy5fZWF0RXZlbnRBbmRDbG9zZSggdGhlRXZlbnQgKTsKCQl9Cgl9LAoKCV9leHBlY3RSZXNpemVFdmVudDogZnVuY3Rpb24oKSB7CgkJdmFyIHdpbmRvd0Nvb3JkaW5hdGVzID0gZ2V0V2luZG93Q29vcmRpbmF0ZXMoIHRoaXMud2luZG93ICk7CgoJCWlmICggdGhpcy5fcmVzaXplRGF0YSApIHsKCQkJaWYgKCB3aW5kb3dDb29yZGluYXRlcy54ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbmRvd0Nvb3JkaW5hdGVzLnggJiYKCQkJCXdpbmRvd0Nvb3JkaW5hdGVzLnkgPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luZG93Q29vcmRpbmF0ZXMueSAmJgoJCQkJd2luZG93Q29vcmRpbmF0ZXMuY3ggPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luZG93Q29vcmRpbmF0ZXMuY3ggJiYKCQkJCXdpbmRvd0Nvb3JkaW5hdGVzLmN5ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbmRvd0Nvb3JkaW5hdGVzLmN5ICkgewoJCQkJLy8gdGltZW91dCBub3QgcmVmcmVzaGVkCgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gZWxzZSB7CgkJCQkvLyBjbGVhciBleGlzdGluZyB0aW1lb3V0IC0gaXQgd2lsbCBiZSByZWZyZXNoZWQgYmVsb3cKCQkJCWNsZWFyVGltZW91dCggdGhpcy5fcmVzaXplRGF0YS50aW1lb3V0SWQgKTsKCQkJfQoJCX0KCgkJdGhpcy5fcmVzaXplRGF0YSA9IHsKCQkJdGltZW91dElkOiB0aGlzLl9kZWxheSggIl9yZXNpemVUaW1lb3V0IiwgMjAwICksCgkJCXdpbmRvd0Nvb3JkaW5hdGVzOiB3aW5kb3dDb29yZGluYXRlcwoJCX07CgoJCXJldHVybiB0cnVlOwoJfSwKCglfcmVzaXplVGltZW91dDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCWlmICggIXRoaXMuX2V4cGVjdFJlc2l6ZUV2ZW50KCkgKSB7CgkJCQlpZiAoIHRoaXMuX3VpLmNvbnRhaW5lci5oYXNDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKSApIHsKCQkJCQkvLyBlZmZlY3RpdmVseSByYXBpZC1vcGVuIHRoZSBwb3B1cCB3aGlsZSBsZWF2aW5nIHRoZSBzY3JlZW4gaW50YWN0CgkJCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtaGlkZGVuIHVpLXBvcHVwLXRydW5jYXRlIiApOwoJCQkJCXRoaXMucmVwb3NpdGlvbiggeyBwb3NpdGlvblRvOiAid2luZG93IiB9ICk7CgkJCQkJdGhpcy5faWdub3JlUmVzaXplRXZlbnRzKCk7CgkJCQl9CgoJCQkJdGhpcy5fcmVzaXplU2NyZWVuKCk7CgkJCQl0aGlzLl9yZXNpemVEYXRhID0gbnVsbDsKCQkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IGZhbHNlOwoJCQl9CgkJfSBlbHNlIHsKCQkJdGhpcy5fcmVzaXplRGF0YSA9IG51bGw7CgkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IGZhbHNlOwoJCX0KCX0sCgoJX3N0b3BJZ25vcmluZ1Jlc2l6ZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdGhpcy5faWdub3JlUmVzaXplVG8gPSAwOwoJfSwKCglfaWdub3JlUmVzaXplRXZlbnRzOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuX2lnbm9yZVJlc2l6ZVRvICkgewoJCQljbGVhclRpbWVvdXQoIHRoaXMuX2lnbm9yZVJlc2l6ZVRvICk7CgkJfQoJCXRoaXMuX2lnbm9yZVJlc2l6ZVRvID0gdGhpcy5fZGVsYXkoICJfc3RvcElnbm9yaW5nUmVzaXplRXZlbnRzIiwgMTAwMCApOwoJfSwKCglfaGFuZGxlV2luZG93UmVzaXplOiBmdW5jdGlvbigvKiB0aGVFdmVudCAqLykgewoJCWlmICggdGhpcy5faXNPcGVuICYmIHRoaXMuX2lnbm9yZVJlc2l6ZVRvID09PSAwICkgewoJCQlpZiAoICggdGhpcy5fZXhwZWN0UmVzaXplRXZlbnQoKSB8fCB0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgKSAmJgoJCQkJIXRoaXMuX3VpLmNvbnRhaW5lci5oYXNDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKSApIHsKCQkJCS8vIGVmZmVjdGl2ZWx5IHJhcGlkLWNsb3NlIHRoZSBwb3B1cCB3aGlsZSBsZWF2aW5nIHRoZSBzY3JlZW4gaW50YWN0CgkJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCQkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4gdWktcG9wdXAtdHJ1bmNhdGUiICkKCQkJCQkucmVtb3ZlQXR0ciggInN0eWxlIiApOwoJCQl9CgkJfQoJfSwKCglfaGFuZGxlV2luZG93T3JpZW50YXRpb25jaGFuZ2U6IGZ1bmN0aW9uKC8qIHRoZUV2ZW50ICovKSB7CgkJaWYgKCAhdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzICYmIHRoaXMuX2lzT3BlbiAmJiB0aGlzLl9pZ25vcmVSZXNpemVUbyA9PT0gMCApIHsKCQkJdGhpcy5fZXhwZWN0UmVzaXplRXZlbnQoKTsKCQkJdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzID0gdHJ1ZTsKCQl9Cgl9LAoKCS8vIFdoZW4gdGhlIHBvcHVwIGlzIG9wZW4sIGF0dGVtcHRpbmcgdG8gZm9jdXMgb24gYW4gZWxlbWVudCB0aGF0IGlzIG5vdCBhCgkvLyBjaGlsZCBvZiB0aGUgcG9wdXAgd2lsbCByZWRpcmVjdCBmb2N1cyB0byB0aGUgcG9wdXAKCV9oYW5kbGVEb2N1bWVudEZvY3VzSW46IGZ1bmN0aW9uKCB0aGVFdmVudCApIHsKCQl2YXIgdGFyZ2V0LAoJCQl0YXJnZXRFbGVtZW50ID0gdGhlRXZlbnQudGFyZ2V0LAoJCQl1aSA9IHRoaXMuX3VpOwoKCQlpZiAoICF0aGlzLl9pc09wZW4gKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggdGFyZ2V0RWxlbWVudCAhPT0gdWkuY29udGFpbmVyWyAwIF0gKSB7CgkJCXRhcmdldCA9ICQoIHRhcmdldEVsZW1lbnQgKTsKCQkJaWYgKCAwID09PSB0YXJnZXQucGFyZW50cygpLmZpbHRlciggdWkuY29udGFpbmVyWyAwIF0gKS5sZW5ndGggKSB7CgkJCQkkKCB0aGlzLmRvY3VtZW50WyAwIF0uYWN0aXZlRWxlbWVudCApLm9uZSggImZvY3VzIiwgZnVuY3Rpb24oLyogdGhlRXZlbnQgKi8pIHsKCQkJCQl0YXJnZXQuYmx1cigpOwoJCQkJfSk7CgkJCQl1aS5mb2N1c0VsZW1lbnQuZm9jdXMoKTsKCQkJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl0aGVFdmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfSBlbHNlIGlmICggdWkuZm9jdXNFbGVtZW50WyAwIF0gPT09IHVpLmNvbnRhaW5lclsgMCBdICkgewoJCQkJdWkuZm9jdXNFbGVtZW50ID0gdGFyZ2V0OwoJCQl9CgkJfQoKCQl0aGlzLl9pZ25vcmVSZXNpemVFdmVudHMoKTsKCX0sCgoJX3RoZW1lQ2xhc3NGcm9tT3B0aW9uOiBmdW5jdGlvbiggcHJlZml4LCB2YWx1ZSApIHsKCQlyZXR1cm4gKCB2YWx1ZSA/ICggdmFsdWUgPT09ICJub25lIiA/ICIiIDogKCBwcmVmaXggKyB2YWx1ZSApICkgOiAoIHByZWZpeCArICJpbmhlcml0IiApICk7Cgl9LAoKCV9hcHBseVRyYW5zaXRpb246IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlpZiAoIHZhbHVlICkgewoJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiApOwoJCQlpZiAoIHZhbHVlICE9PSAibm9uZSIgKSB7CgkJCQl0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gPSAkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiggdmFsdWUgKTsKCQkJCWlmICggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID09PSAibm9uZSIgKSB7CgkJCQkJdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID0gIiI7CgkJCQl9CgkJCQl0aGlzLl91aS5jb250YWluZXIuYWRkQ2xhc3MoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiApOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBuZXdPcHRpb25zICkgewoJCXZhciBjdXJyZW50T3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJdGhlRWxlbWVudCA9IHRoaXMuZWxlbWVudCwKCQkJc2NyZWVuID0gdGhpcy5fdWkuc2NyZWVuOwoKCQlpZiAoIG5ld09wdGlvbnMud3JhcHBlckNsYXNzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkJLnJlbW92ZUNsYXNzKCBjdXJyZW50T3B0aW9ucy53cmFwcGVyQ2xhc3MgKQoJCQkJLmFkZENsYXNzKCBuZXdPcHRpb25zLndyYXBwZXJDbGFzcyApOwoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoZUVsZW1lbnQKCQkJCS5yZW1vdmVDbGFzcyggdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIGN1cnJlbnRPcHRpb25zLnRoZW1lICkgKQoJCQkJLmFkZENsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgbmV3T3B0aW9ucy50aGVtZSApICk7CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMub3ZlcmxheVRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXNjcmVlbgoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLW92ZXJsYXktIiwgY3VycmVudE9wdGlvbnMub3ZlcmxheVRoZW1lICkgKQoJCQkJLmFkZENsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLW92ZXJsYXktIiwgbmV3T3B0aW9ucy5vdmVybGF5VGhlbWUgKSApOwoKCQkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCQlzY3JlZW4uYWRkQ2xhc3MoICJpbiIgKTsKCQkJfQoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLnNoYWRvdyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGVFbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktb3ZlcmxheS1zaGFkb3ciLCBuZXdPcHRpb25zLnNoYWRvdyApOwoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhlRWxlbWVudC50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBuZXdPcHRpb25zLmNvcm5lcnMgKTsKCQl9CgoJCWlmICggbmV3T3B0aW9ucy50cmFuc2l0aW9uICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggIXRoaXMuX2N1cnJlbnRUcmFuc2l0aW9uICkgewoJCQkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCBuZXdPcHRpb25zLnRyYW5zaXRpb24gKTsKCQkJfQoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLnRvbGVyYW5jZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRUb2xlcmFuY2UoIG5ld09wdGlvbnMudG9sZXJhbmNlICk7CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMuZGlzYWJsZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCBuZXdPcHRpb25zLmRpc2FibGVkICkgewoJCQkJdGhpcy5jbG9zZSgpOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fc3VwZXIoIG5ld09wdGlvbnMgKTsKCX0sCgoJX3NldFRvbGVyYW5jZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhciB0b2wgPSB7IHQ6IDMwLCByOiAxNSwgYjogMzAsIGw6IDE1IH0sCgkJCWFyOwoKCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCWFyID0gU3RyaW5nKCB2YWx1ZSApLnNwbGl0KCAiLCIgKTsKCgkJCSQuZWFjaCggYXIsIGZ1bmN0aW9uKCBpZHgsIHZhbCApIHsgYXJbIGlkeCBdID0gcGFyc2VJbnQoIHZhbCwgMTAgKTsgfSApOwoKCQkJc3dpdGNoKCBhci5sZW5ndGggKSB7CgkJCQkvLyBBbGwgdmFsdWVzIGFyZSB0byBiZSB0aGUgc2FtZQoJCQkJY2FzZSAxOgoJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCXRvbC50ID0gdG9sLnIgPSB0b2wuYiA9IHRvbC5sID0gYXJbIDAgXTsKCQkJCQl9CgkJCQkJYnJlYWs7CgoJCQkJLy8gVGhlIGZpcnN0IHZhbHVlIGRlbm90ZXMgdG9wL2JvdHRvbSB0b2xlcmFuY2UsIGFuZCB0aGUgc2Vjb25kIHZhbHVlIGRlbm90ZXMgbGVmdC9yaWdodCB0b2xlcmFuY2UKCQkJCWNhc2UgMjoKCQkJCQlpZiAoICFpc05hTiggYXJbIDAgXSApICkgewoJCQkJCQl0b2wudCA9IHRvbC5iID0gYXJbIDAgXTsKCQkJCQl9CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAxIF0gKSApIHsKCQkJCQkJdG9sLmwgPSB0b2wuciA9IGFyWyAxIF07CgkJCQkJfQoJCQkJCWJyZWFrOwoKCQkJCS8vIFRoZSBhcnJheSBjb250YWlucyB2YWx1ZXMgaW4gdGhlIG9yZGVyIHRvcCwgcmlnaHQsIGJvdHRvbSwgbGVmdAoJCQkJY2FzZSA0OgoJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCXRvbC50ID0gYXJbIDAgXTsKCQkJCQl9CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAxIF0gKSApIHsKCQkJCQkJdG9sLnIgPSBhclsgMSBdOwoJCQkJCX0KCQkJCQlpZiAoICFpc05hTiggYXJbIDIgXSApICkgewoJCQkJCQl0b2wuYiA9IGFyWyAyIF07CgkJCQkJfQoJCQkJCWlmICggIWlzTmFOKCBhclsgMyBdICkgKSB7CgkJCQkJCXRvbC5sID0gYXJbIDMgXTsKCQkJCQl9CgkJCQkJYnJlYWs7CgoJCQkJZGVmYXVsdDoKCQkJCQlicmVhazsKCQkJfQoJCX0KCgkJdGhpcy5fdG9sZXJhbmNlID0gdG9sOwoJCXJldHVybiB0aGlzOwoJfSwKCglfY2xhbXBQb3B1cFdpZHRoOiBmdW5jdGlvbiggaW5mb09ubHkgKSB7CgkJdmFyIG1lbnVTaXplLAoJCQl3aW5kb3dDb29yZGluYXRlcyA9IGdldFdpbmRvd0Nvb3JkaW5hdGVzKCB0aGlzLndpbmRvdyApLAoJCQkvLyByZWN0YW5nbGUgd2l0aGluIHdoaWNoIHRoZSBwb3B1cCBtdXN0IGZpdAoJCQlyZWN0YW5nbGUgPSB7CgkJCQl4OiB0aGlzLl90b2xlcmFuY2UubCwKCQkJCXk6IHdpbmRvd0Nvb3JkaW5hdGVzLnkgKyB0aGlzLl90b2xlcmFuY2UudCwKCQkJCWN4OiB3aW5kb3dDb29yZGluYXRlcy5jeCAtIHRoaXMuX3RvbGVyYW5jZS5sIC0gdGhpcy5fdG9sZXJhbmNlLnIsCgkJCQljeTogd2luZG93Q29vcmRpbmF0ZXMuY3kgLSB0aGlzLl90b2xlcmFuY2UudCAtIHRoaXMuX3RvbGVyYW5jZS5iCgkJCX07CgoJCWlmICggIWluZm9Pbmx5ICkgewoJCQkvLyBDbGFtcCB0aGUgd2lkdGggb2YgdGhlIG1lbnUgYmVmb3JlIGdyYWJiaW5nIGl0cyBzaXplCgkJCXRoaXMuX3VpLmNvbnRhaW5lci5jc3MoICJtYXgtd2lkdGgiLCByZWN0YW5nbGUuY3ggKTsKCQl9CgoJCW1lbnVTaXplID0gewoJCQljeDogdGhpcy5fdWkuY29udGFpbmVyLm91dGVyV2lkdGgoIHRydWUgKSwKCQkJY3k6IHRoaXMuX3VpLmNvbnRhaW5lci5vdXRlckhlaWdodCggdHJ1ZSApCgkJfTsKCgkJcmV0dXJuIHsgcmM6IHJlY3RhbmdsZSwgbWVudVNpemU6IG1lbnVTaXplIH07Cgl9LAoKCV9jYWxjdWxhdGVGaW5hbExvY2F0aW9uOiBmdW5jdGlvbiggZGVzaXJlZCwgY2xhbXBJbmZvICkgewoJCXZhciByZXR1cm5WYWx1ZSwKCQkJcmVjdGFuZ2xlID0gY2xhbXBJbmZvLnJjLAoJCQltZW51U2l6ZSA9IGNsYW1wSW5mby5tZW51U2l6ZTsKCgkJLy8gQ2VudGVyIHRoZSBtZW51IG92ZXIgdGhlIGRlc2lyZWQgY29vcmRpbmF0ZXMsIHdoaWxlIG5vdCBnb2luZyBvdXRzaWRlCgkJLy8gdGhlIHdpbmRvdyB0b2xlcmFuY2VzLiBUaGlzIHdpbGwgY2VudGVyIHdydC4gdGhlIHdpbmRvdyBpZiB0aGUgcG9wdXAgaXMKCQkvLyB0b28gbGFyZ2UuCgkJcmV0dXJuVmFsdWUgPSB7CgkJCWxlZnQ6IGZpdFNlZ21lbnRJbnNpZGVTZWdtZW50KCByZWN0YW5nbGUuY3gsIG1lbnVTaXplLmN4LCByZWN0YW5nbGUueCwgZGVzaXJlZC54ICksCgkJCXRvcDogZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHJlY3RhbmdsZS5jeSwgbWVudVNpemUuY3ksIHJlY3RhbmdsZS55LCBkZXNpcmVkLnkgKQoJCX07CgoJCS8vIE1ha2Ugc3VyZSB0aGUgdG9wIG9mIHRoZSBtZW51IGlzIHZpc2libGUKCQlyZXR1cm5WYWx1ZS50b3AgPSBNYXRoLm1heCggMCwgcmV0dXJuVmFsdWUudG9wICk7CgoJCS8vIElmIHRoZSBoZWlnaHQgb2YgdGhlIG1lbnUgaXMgc21hbGxlciB0aGFuIHRoZSBoZWlnaHQgb2YgdGhlIGRvY3VtZW50CgkJLy8gYWxpZ24gdGhlIGJvdHRvbSB3aXRoIHRoZSBib3R0b20gb2YgdGhlIGRvY3VtZW50CgoJCXJldHVyblZhbHVlLnRvcCAtPSBNYXRoLm1pbiggcmV0dXJuVmFsdWUudG9wLAoJCQlNYXRoLm1heCggMCwgcmV0dXJuVmFsdWUudG9wICsgbWVudVNpemUuY3kgLSB0aGlzLmRvY3VtZW50LmhlaWdodCgpICkgKTsKCgkJcmV0dXJuIHJldHVyblZhbHVlOwoJfSwKCgkvLyBUcnkgYW5kIGNlbnRlciB0aGUgb3ZlcmxheSBvdmVyIHRoZSBnaXZlbiBjb29yZGluYXRlcwoJX3BsYWNlbWVudENvb3JkczogZnVuY3Rpb24oIGRlc2lyZWQgKSB7CgkJcmV0dXJuIHRoaXMuX2NhbGN1bGF0ZUZpbmFsTG9jYXRpb24oIGRlc2lyZWQsIHRoaXMuX2NsYW1wUG9wdXBXaWR0aCgpICk7Cgl9LAoKCV9jcmVhdGVQcmVyZXF1aXNpdGVzOiBmdW5jdGlvbiggc2NyZWVuUHJlcmVxdWlzaXRlLCBjb250YWluZXJQcmVyZXF1aXNpdGUsIHdoZW5Eb25lICkgewoJCXZhciBwcmVyZXF1aXNpdGVzLAoJCQlzZWxmID0gdGhpczsKCgkJLy8gSXQgaXMgaW1wb3J0YW50IHRvIG1haW50YWluIGJvdGggdGhlIGxvY2FsIHZhcmlhYmxlIHByZXJlcXVpc2l0ZXMgYW5kCgkJLy8gc2VsZi5fcHJlcmVxdWlzaXRlcy4gVGhlIGxvY2FsIHZhcmlhYmxlIHJlbWFpbnMgaW4gdGhlIGNsb3N1cmUgb2YgdGhlCgkJLy8gZnVuY3Rpb25zIHdoaWNoIGNhbGwgdGhlIGNhbGxiYWNrcyBwYXNzZWQgaW4uIFRoZSBjb21wYXJpc29uIGJldHdlZW4gdGhlCgkJLy8gbG9jYWwgdmFyaWFibGUgYW5kIHNlbGYuX3ByZXJlcXVpc2l0ZXMgaXMgbmVjZXNzYXJ5LCBiZWNhdXNlIG9uY2UgYQoJCS8vIGZ1bmN0aW9uIGhhcyBiZWVuIHBhc3NlZCB0byAuYW5pbWF0aW9uQ29tcGxldGUoKSBpdCB3aWxsIGJlIGNhbGxlZCBuZXh0CgkJLy8gdGltZSBhbiBhbmltYXRpb24gY29tcGxldGVzLCBldmVuIGlmIHRoYXQncyBub3QgdGhlIGFuaW1hdGlvbiB3aG9zZSBlbmQKCQkvLyB0aGUgZnVuY3Rpb24gd2FzIHN1cHBvc2VkIHRvIGNhdGNoIChmb3IgZXhhbXBsZSwgaWYgYW4gYWJvcnQgaGFwcGVucwoJCS8vIGR1cmluZyB0aGUgb3BlbmluZyBhbmltYXRpb24sIHRoZSAuYW5pbWF0aW9uQ29tcGxldGUgaGFuZGxlciBpcyBub3QKCQkvLyBjYWxsZWQgZm9yIHRoYXQgYW5pbWF0aW9uIGFueW1vcmUsIGJ1dCB0aGUgaGFuZGxlciByZW1haW5zIGF0dGFjaGVkLCBzbwoJCS8vIGl0IGlzIGNhbGxlZCB0aGUgbmV4dCB0aW1lIHRoZSBwb3B1cCBpcyBvcGVuZWQgLSBtYWtpbmcgaXQgc3RhbGUuCgkJLy8gQ29tcGFyaW5nIHRoZSBsb2NhbCB2YXJpYWJsZSBwcmVyZXF1aXNpdGVzIHRvIHRoZSB3aWRnZXQtbGV2ZWwgdmFyaWFibGUKCQkvLyBzZWxmLl9wcmVyZXF1aXNpdGVzIGVuc3VyZXMgdGhhdCBjYWxsYmFja3MgdHJpZ2dlcmVkIGJ5IGEgc3RhbGUKCQkvLyAuYW5pbWF0aW9uQ29tcGxldGUgd2lsbCBiZSBpZ25vcmVkLgoKCQlwcmVyZXF1aXNpdGVzID0gewoJCQlzY3JlZW46ICQuRGVmZXJyZWQoKSwKCQkJY29udGFpbmVyOiAkLkRlZmVycmVkKCkKCQl9OwoKCQlwcmVyZXF1aXNpdGVzLnNjcmVlbi50aGVuKCBmdW5jdGlvbigpIHsKCQkJaWYgKCBwcmVyZXF1aXNpdGVzID09PSBzZWxmLl9wcmVyZXF1aXNpdGVzICkgewoJCQkJc2NyZWVuUHJlcmVxdWlzaXRlKCk7CgkJCX0KCQl9KTsKCgkJcHJlcmVxdWlzaXRlcy5jb250YWluZXIudGhlbiggZnVuY3Rpb24oKSB7CgkJCWlmICggcHJlcmVxdWlzaXRlcyA9PT0gc2VsZi5fcHJlcmVxdWlzaXRlcyApIHsKCQkJCWNvbnRhaW5lclByZXJlcXVpc2l0ZSgpOwoJCQl9CgkJfSk7CgoJCSQud2hlbiggcHJlcmVxdWlzaXRlcy5zY3JlZW4sIHByZXJlcXVpc2l0ZXMuY29udGFpbmVyICkuZG9uZSggZnVuY3Rpb24oKSB7CgkJCWlmICggcHJlcmVxdWlzaXRlcyA9PT0gc2VsZi5fcHJlcmVxdWlzaXRlcyApIHsKCQkJCXNlbGYuX3ByZXJlcXVpc2l0ZXMgPSBudWxsOwoJCQkJd2hlbkRvbmUoKTsKCQkJfQoJCX0pOwoKCQlzZWxmLl9wcmVyZXF1aXNpdGVzID0gcHJlcmVxdWlzaXRlczsKCX0sCgoJX2FuaW1hdGU6IGZ1bmN0aW9uKCBhcmdzICkgewoJCS8vIE5PVEUgYmVmb3JlIHJlbW92aW5nIHRoZSBkZWZhdWx0IGFuaW1hdGlvbiBvZiB0aGUgc2NyZWVuCgkJLy8gICAgICB0aGlzIGhhZCBhbiBhbmltYXRlIGNhbGxiYWNrIHRoYXQgd291bGQgcmVzb2x2ZSB0aGUgZGVmZXJyZWQKCQkvLyAgICAgIG5vdyB0aGUgZGVmZXJyZWQgaXMgcmVzb2x2ZWQgaW1tZWRpYXRlbHkKCQkvLyBUT0RPIHJlbW92ZSB0aGUgZGVwZW5kZW5jeSBvbiB0aGUgc2NyZWVuIGRlZmVycmVkCgkJdGhpcy5fdWkuc2NyZWVuCgkJCS5yZW1vdmVDbGFzcyggYXJncy5jbGFzc1RvUmVtb3ZlICkKCQkJLmFkZENsYXNzKCBhcmdzLnNjcmVlbkNsYXNzVG9BZGQgKTsKCgkJYXJncy5wcmVyZXF1aXNpdGVzLnNjcmVlbi5yZXNvbHZlKCk7CgoJCWlmICggYXJncy50cmFuc2l0aW9uICYmIGFyZ3MudHJhbnNpdGlvbiAhPT0gIm5vbmUiICkgewoJCQlpZiAoIGFyZ3MuYXBwbHlUcmFuc2l0aW9uICkgewoJCQkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCBhcmdzLnRyYW5zaXRpb24gKTsKCQkJfQoJCQlpZiAoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiApIHsKCQkJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkJCS5hbmltYXRpb25Db21wbGV0ZSggJC5wcm94eSggYXJncy5wcmVyZXF1aXNpdGVzLmNvbnRhaW5lciwgInJlc29sdmUiICkgKQoJCQkJCS5hZGRDbGFzcyggYXJncy5jb250YWluZXJDbGFzc1RvQWRkICkKCQkJCQkucmVtb3ZlQ2xhc3MoIGFyZ3MuY2xhc3NUb1JlbW92ZSApOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggYXJncy5jbGFzc1RvUmVtb3ZlICk7CgkJYXJncy5wcmVyZXF1aXNpdGVzLmNvbnRhaW5lci5yZXNvbHZlKCk7Cgl9LAoKCS8vIFRoZSBkZXNpcmVkIGNvb3JkaW5hdGVzIHBhc3NlZCBpbiB3aWxsIGJlIHJldHVybmVkIHVudG91Y2hlZCBpZiBubyByZWZlcmVuY2UgZWxlbWVudCBjYW4gYmUgaWRlbnRpZmllZCB2aWEKCS8vIGRlc2lyZWRQb3NpdGlvbi5wb3NpdGlvblRvLiBOZXZlcnRoZWxlc3MsIHRoaXMgZnVuY3Rpb24gZW5zdXJlcyB0aGF0IGl0cyByZXR1cm4gdmFsdWUgYWx3YXlzIGNvbnRhaW5zIHZhbGlkCgkvLyB4IGFuZCB5IGNvb3JkaW5hdGVzIGJ5IHNwZWNpZnlpbmcgdGhlIGNlbnRlciBtaWRkbGUgb2YgdGhlIHdpbmRvdyBpZiB0aGUgY29vcmRpbmF0ZXMgYXJlIGFic2VudC4KCS8vIG9wdGlvbnM6IHsgeDogY29vcmRpbmF0ZSwgeTogY29vcmRpbmF0ZSwgcG9zaXRpb25Ubzogc3RyaW5nOiAib3JpZ2luIiwgIndpbmRvdyIsIG9yIGpRdWVyeSBzZWxlY3RvcgoJX2Rlc2lyZWRDb29yZHM6IGZ1bmN0aW9uKCBvcGVuT3B0aW9ucyApIHsKCQl2YXIgb2Zmc2V0LAoJCQlkc3QgPSBudWxsLAoJCQl3aW5kb3dDb29yZGluYXRlcyA9IGdldFdpbmRvd0Nvb3JkaW5hdGVzKCB0aGlzLndpbmRvdyApLAoJCQl4ID0gb3Blbk9wdGlvbnMueCwKCQkJeSA9IG9wZW5PcHRpb25zLnksCgkJCXBUbyA9IG9wZW5PcHRpb25zLnBvc2l0aW9uVG87CgoJCS8vIEVzdGFibGlzaCB3aGljaCBlbGVtZW50IHdpbGwgc2VydmUgYXMgdGhlIHJlZmVyZW5jZQoJCWlmICggcFRvICYmIHBUbyAhPT0gIm9yaWdpbiIgKSB7CgkJCWlmICggcFRvID09PSAid2luZG93IiApIHsKCQkJCXggPSB3aW5kb3dDb29yZGluYXRlcy5jeCAvIDIgKyB3aW5kb3dDb29yZGluYXRlcy54OwoJCQkJeSA9IHdpbmRvd0Nvb3JkaW5hdGVzLmN5IC8gMiArIHdpbmRvd0Nvb3JkaW5hdGVzLnk7CgkJCX0gZWxzZSB7CgkJCQl0cnkgewoJCQkJCWRzdCA9ICQoIHBUbyApOwoJCQkJfSBjYXRjaCggZXJyICkgewoJCQkJCWRzdCA9IG51bGw7CgkJCQl9CgkJCQlpZiAoIGRzdCApIHsKCQkJCQlkc3QuZmlsdGVyKCAiOnZpc2libGUiICk7CgkJCQkJaWYgKCBkc3QubGVuZ3RoID09PSAwICkgewoJCQkJCQlkc3QgPSBudWxsOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJLy8gSWYgYW4gZWxlbWVudCB3YXMgZm91bmQsIGNlbnRlciBvdmVyIGl0CgkJaWYgKCBkc3QgKSB7CgkJCW9mZnNldCA9IGRzdC5vZmZzZXQoKTsKCQkJeCA9IG9mZnNldC5sZWZ0ICsgZHN0Lm91dGVyV2lkdGgoKSAvIDI7CgkJCXkgPSBvZmZzZXQudG9wICsgZHN0Lm91dGVySGVpZ2h0KCkgLyAyOwoJCX0KCgkJLy8gTWFrZSBzdXJlIHggYW5kIHkgYXJlIHZhbGlkIG51bWJlcnMgLSBjZW50ZXIgb3ZlciB0aGUgd2luZG93CgkJaWYgKCAkLnR5cGUoIHggKSAhPT0gIm51bWJlciIgfHwgaXNOYU4oIHggKSApIHsKCQkJeCA9IHdpbmRvd0Nvb3JkaW5hdGVzLmN4IC8gMiArIHdpbmRvd0Nvb3JkaW5hdGVzLng7CgkJfQoJCWlmICggJC50eXBlKCB5ICkgIT09ICJudW1iZXIiIHx8IGlzTmFOKCB5ICkgKSB7CgkJCXkgPSB3aW5kb3dDb29yZGluYXRlcy5jeSAvIDIgKyB3aW5kb3dDb29yZGluYXRlcy55OwoJCX0KCgkJcmV0dXJuIHsgeDogeCwgeTogeSB9OwoJfSwKCglfcmVwb3NpdGlvbjogZnVuY3Rpb24oIG9wZW5PcHRpb25zICkgewoJCS8vIFdlIG9ubHkgY2FyZSBhYm91dCBwb3NpdGlvbi1yZWxhdGVkIHBhcmFtZXRlcnMgZm9yIHJlcG9zaXRpb25pbmcKCQlvcGVuT3B0aW9ucyA9IHsKCQkJeDogb3Blbk9wdGlvbnMueCwKCQkJeTogb3Blbk9wdGlvbnMueSwKCQkJcG9zaXRpb25Ubzogb3Blbk9wdGlvbnMucG9zaXRpb25UbwoJCX07CgkJdGhpcy5fdHJpZ2dlciggImJlZm9yZXBvc2l0aW9uIiwgdW5kZWZpbmVkLCBvcGVuT3B0aW9ucyApOwoJCXRoaXMuX3VpLmNvbnRhaW5lci5vZmZzZXQoIHRoaXMuX3BsYWNlbWVudENvb3JkcyggdGhpcy5fZGVzaXJlZENvb3Jkcyggb3Blbk9wdGlvbnMgKSApICk7Cgl9LAoKCXJlcG9zaXRpb246IGZ1bmN0aW9uKCBvcGVuT3B0aW9ucyApIHsKCQlpZiAoIHRoaXMuX2lzT3BlbiApIHsKCQkJdGhpcy5fcmVwb3NpdGlvbiggb3Blbk9wdGlvbnMgKTsKCQl9Cgl9LAoKCV9vcGVuUHJlcmVxdWlzaXRlc0NvbXBsZXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgaWQgPSB0aGlzLmVsZW1lbnQuYXR0ciggImlkIiApOwoKCQl0aGlzLl91aS5jb250YWluZXIuYWRkQ2xhc3MoICJ1aS1wb3B1cC1hY3RpdmUiICk7CgkJdGhpcy5faXNPcGVuID0gdHJ1ZTsKCQl0aGlzLl9yZXNpemVTY3JlZW4oKTsKCQl0aGlzLl91aS5jb250YWluZXIuYXR0ciggInRhYmluZGV4IiwgIjAiICkuZm9jdXMoKTsKCQl0aGlzLl9pZ25vcmVSZXNpemVFdmVudHMoKTsKCQlpZiAoIGlkICkgewoJCQl0aGlzLmRvY3VtZW50LmZpbmQoICJbYXJpYS1oYXNwb3B1cD0ndHJ1ZSddW2FyaWEtb3ducz0nIiArICBpZCArICInXSIgKS5hdHRyKCAiYXJpYS1leHBhbmRlZCIsIHRydWUgKTsKCQl9CgkJdGhpcy5fdHJpZ2dlciggImFmdGVyb3BlbiIgKTsKCX0sCgoJX29wZW46IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBvcGVuT3B0aW9ucyA9ICQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zLCBvcHRpb25zICksCgkJCS8vIFRPRE8gbW92ZSBibGFja2xpc3QgdG8gcHJpdmF0ZSBtZXRob2QKCQkJYW5kcm9pZEJsYWNrbGlzdCA9ICggZnVuY3Rpb24oKSB7CgkJCQl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCQkJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJCQkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XC5dKykvICksCgkJCQkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQkJCQlhbmRyb2lkbWF0Y2ggPSB1YS5tYXRjaCggL0FuZHJvaWQgKFxkKyg/OlwuXGQrKSkvICksCgkJCQkJYW5kdmVyc2lvbiA9ICEhYW5kcm9pZG1hdGNoICYmIGFuZHJvaWRtYXRjaFsgMSBdLAoJCQkJCWNocm9tZW1hdGNoID0gdWEuaW5kZXhPZiggIkNocm9tZSIgKSA+IC0xOwoKCQkJCS8vIFBsYXRmb3JtIGlzIEFuZHJvaWQsIFdlYktpdCB2ZXJzaW9uIGlzIGdyZWF0ZXIgdGhhbiA1MzQuMTMgKCBBbmRyb2lkIDMuMi4xICkgYW5kIG5vdCBDaHJvbWUuCgkJCQlpZiAoIGFuZHJvaWRtYXRjaCAhPT0gbnVsbCAmJiBhbmR2ZXJzaW9uID09PSAiNC4wIiAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uID4gNTM0LjEzICYmICFjaHJvbWVtYXRjaCApIHsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0KCQkJCXJldHVybiBmYWxzZTsKCQkJfSgpKTsKCgkJLy8gQ291bnQgZG93biB0byB0cmlnZ2VyaW5nICJwb3B1cGFmdGVyb3BlbiIgLSB3ZSBoYXZlIHR3byBwcmVyZXF1aXNpdGVzOgoJCS8vIDEuIFRoZSBwb3B1cCB3aW5kb3cgYW5pbWF0aW9uIGNvbXBsZXRlcyAoY29udGFpbmVyKCkpCgkJLy8gMi4gVGhlIHNjcmVlbiBvcGFjaXR5IGFuaW1hdGlvbiBjb21wbGV0ZXMgKHNjcmVlbigpKQoJCXRoaXMuX2NyZWF0ZVByZXJlcXVpc2l0ZXMoCgkJCSQubm9vcCwKCQkJJC5ub29wLAoJCQkkLnByb3h5KCB0aGlzLCAiX29wZW5QcmVyZXF1aXNpdGVzQ29tcGxldGUiICkgKTsKCgkJdGhpcy5fY3VycmVudFRyYW5zaXRpb24gPSBvcGVuT3B0aW9ucy50cmFuc2l0aW9uOwoJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggb3Blbk9wdGlvbnMudHJhbnNpdGlvbiApOwoKCQl0aGlzLl91aS5zY3JlZW4ucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLXRydW5jYXRlIiApOwoKCQkvLyBHaXZlIGFwcGxpY2F0aW9ucyBhIGNoYW5jZSB0byBtb2RpZnkgdGhlIGNvbnRlbnRzIG9mIHRoZSBjb250YWluZXIgYmVmb3JlIGl0IGFwcGVhcnMKCQl0aGlzLl9yZXBvc2l0aW9uKCBvcGVuT3B0aW9ucyApOwoKCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICk7CgoJCWlmICggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSAmJiBhbmRyb2lkQmxhY2tsaXN0ICkgewoJCQkvKiBUT0RPOiBUaGUgbmF0aXZlIGJyb3dzZXIgb24gQW5kcm9pZCA0LjAuWCAoIkljZSBDcmVhbSBTYW5kd2ljaCIpIHN1ZmZlcnMgZnJvbSBhbiBpc3N1ZSB3aGVyZSB0aGUgcG9wdXAgb3ZlcmxheSBhcHBlYXJzIHRvIGJlIHotaW5kZXhlZCBhYm92ZSB0aGUgcG9wdXAgaXRzZWxmIHdoZW4gY2VydGFpbiBvdGhlciBzdHlsZXMgZXhpc3Qgb24gdGhlIHNhbWUgcGFnZSAtLSBuYW1lbHksIGFueSBlbGVtZW50IHNldCB0byBgcG9zaXRpb246IGZpeGVkYCBhbmQgY2VydGFpbiB0eXBlcyBvZiBpbnB1dC4gVGhlc2UgaXNzdWVzIGFyZSByZW1pbmlzY2VudCBvZiBwcmV2aW91c2x5IHVuY292ZXJlZCBidWdzIGluIG9sZGVyIHZlcnNpb25zIG9mIEFuZHJvaWQncyBuYXRpdmUgYnJvd3NlcjogaHR0cHM6Ly9naXRodWIuY29tL3Njb3R0amVobC9EZXZpY2UtQnVncy9pc3N1ZXMvMwoJCQlUaGlzIGZpeCBjbG9zZXMgdGhlIGZvbGxvd2luZyBidWdzICggSSB1c2UgImNsb3NlcyIgd2l0aCByZWx1Y3RhbmNlLCBhbmQgc3RyZXNzIHRoYXQgdGhpcyBpc3N1ZSBzaG91bGQgYmUgcmV2aXNpdGVkIGFzIHNvb24gYXMgcG9zc2libGUgKToKCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODE2CgkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDg0NAoJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4NzQKCQkJKi8KCgkJCS8vIFRPRE8gc29ydCBvdXQgd2h5IHRoaXMuX3BhZ2UgaXNuJ3Qgd29ya2luZwoJCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLmFkZENsYXNzKCAidWktcG9wdXAtb3BlbiIgKTsKCQl9CgkJdGhpcy5fYW5pbWF0ZSh7CgkJCWFkZGl0aW9uYWxDb25kaXRpb246IHRydWUsCgkJCXRyYW5zaXRpb246IG9wZW5PcHRpb25zLnRyYW5zaXRpb24sCgkJCWNsYXNzVG9SZW1vdmU6ICIiLAoJCQlzY3JlZW5DbGFzc1RvQWRkOiAiaW4iLAoJCQljb250YWluZXJDbGFzc1RvQWRkOiAiaW4iLAoJCQlhcHBseVRyYW5zaXRpb246IGZhbHNlLAoJCQlwcmVyZXF1aXNpdGVzOiB0aGlzLl9wcmVyZXF1aXNpdGVzCgkJfSk7Cgl9LAoKCV9jbG9zZVByZXJlcXVpc2l0ZVNjcmVlbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fdWkuc2NyZWVuCgkJCS5yZW1vdmVDbGFzcyggIm91dCIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJfSwKCglfY2xvc2VQcmVyZXF1aXNpdGVDb250YWluZXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkucmVtb3ZlQ2xhc3MoICJyZXZlcnNlIG91dCIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4gdWktcG9wdXAtdHJ1bmNhdGUiICkKCQkJLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCX0sCgoJX2Nsb3NlUHJlcmVxdWlzaXRlc0RvbmU6IGZ1bmN0aW9uKCkgewoJCXZhciBjb250YWluZXIgPSB0aGlzLl91aS5jb250YWluZXIsCgkJCWlkID0gdGhpcy5lbGVtZW50LmF0dHIoICJpZCIgKTsKCgkJY29udGFpbmVyLnJlbW92ZUF0dHIoICJ0YWJpbmRleCIgKTsKCgkJLy8gcmVtb3ZlIHRoZSBnbG9iYWwgbXV0ZXggZm9yIHBvcHVwcwoJCSQubW9iaWxlLnBvcHVwLmFjdGl2ZSA9IHVuZGVmaW5lZDsKCgkJLy8gQmx1ciBlbGVtZW50cyBpbnNpZGUgdGhlIGNvbnRhaW5lciwgaW5jbHVkaW5nIHRoZSBjb250YWluZXIKCQkkKCAiOmZvY3VzIiwgY29udGFpbmVyWyAwIF0gKS5hZGQoIGNvbnRhaW5lclsgMCBdICkuYmx1cigpOwoKCQlpZiAoIGlkICkgewoJCQl0aGlzLmRvY3VtZW50LmZpbmQoICJbYXJpYS1oYXNwb3B1cD0ndHJ1ZSddW2FyaWEtb3ducz0nIiArICBpZCArICInXSIgKS5hdHRyKCAiYXJpYS1leHBhbmRlZCIsIGZhbHNlICk7CgkJfQoKCQkvLyBhbGVydCB1c2VycyB0aGF0IHRoZSBwb3B1cCBpcyBjbG9zZWQKCQl0aGlzLl90cmlnZ2VyKCAiYWZ0ZXJjbG9zZSIgKTsKCX0sCgoJX2Nsb3NlOiBmdW5jdGlvbiggaW1tZWRpYXRlICkgewoJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLWFjdGl2ZSIgKTsKCQl0aGlzLl9wYWdlLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtb3BlbiIgKTsKCgkJdGhpcy5faXNPcGVuID0gZmFsc2U7CgoJCS8vIENvdW50IGRvd24gdG8gdHJpZ2dlcmluZyAicG9wdXBhZnRlcmNsb3NlIiAtIHdlIGhhdmUgdHdvIHByZXJlcXVpc2l0ZXM6CgkJLy8gMS4gVGhlIHBvcHVwIHdpbmRvdyByZXZlcnNlIGFuaW1hdGlvbiBjb21wbGV0ZXMgKGNvbnRhaW5lcigpKQoJCS8vIDIuIFRoZSBzY3JlZW4gb3BhY2l0eSBhbmltYXRpb24gY29tcGxldGVzIChzY3JlZW4oKSkKCQl0aGlzLl9jcmVhdGVQcmVyZXF1aXNpdGVzKAoJCQkkLnByb3h5KCB0aGlzLCAiX2Nsb3NlUHJlcmVxdWlzaXRlU2NyZWVuIiApLAoJCQkkLnByb3h5KCB0aGlzLCAiX2Nsb3NlUHJlcmVxdWlzaXRlQ29udGFpbmVyIiApLAoJCQkkLnByb3h5KCB0aGlzLCAiX2Nsb3NlUHJlcmVxdWlzaXRlc0RvbmUiICkgKTsKCgkJdGhpcy5fYW5pbWF0ZSggewoJCQlhZGRpdGlvbmFsQ29uZGl0aW9uOiB0aGlzLl91aS5zY3JlZW4uaGFzQ2xhc3MoICJpbiIgKSwKCQkJdHJhbnNpdGlvbjogKCBpbW1lZGlhdGUgPyAibm9uZSIgOiAoIHRoaXMuX2N1cnJlbnRUcmFuc2l0aW9uICkgKSwKCQkJY2xhc3NUb1JlbW92ZTogImluIiwKCQkJc2NyZWVuQ2xhc3NUb0FkZDogIm91dCIsCgkJCWNvbnRhaW5lckNsYXNzVG9BZGQ6ICJyZXZlcnNlIG91dCIsCgkJCWFwcGx5VHJhbnNpdGlvbjogdHJ1ZSwKCQkJcHJlcmVxdWlzaXRlczogdGhpcy5fcHJlcmVxdWlzaXRlcwoJCX0pOwoJfSwKCglfdW5lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gUHV0IHRoZSBlbGVtZW50IGJhY2sgdG8gd2hlcmUgdGhlIHBsYWNlaG9sZGVyIHdhcyBhbmQgcmVtb3ZlIHRoZSAidWktcG9wdXAiIGNsYXNzCgkJdGhpcy5fc2V0T3B0aW9ucyggeyB0aGVtZTogJC5tb2JpbGUucG9wdXAucHJvdG90eXBlLm9wdGlvbnMudGhlbWUgfSApOwoJCXRoaXMuZWxlbWVudAoJCQkvLyBDYW5ub3QgZGlyZWN0bHkgaW5zZXJ0QWZ0ZXIoKSAtIHdlIG5lZWQgdG8gZGV0YWNoKCkgZmlyc3QsIGJlY2F1c2UKCQkJLy8gaW5zZXJ0QWZ0ZXIoKSB3aWxsIGRvIG5vdGhpbmcgaWYgdGhlIHBheWxvYWQgZGl2IHdhcyBub3QgYXR0YWNoZWQKCQkJLy8gdG8gdGhlIERPTSBhdCB0aGUgdGltZSB0aGUgd2lkZ2V0IHdhcyBjcmVhdGVkLCBhbmQgc28gdGhlIHBheWxvYWQKCQkJLy8gd2lsbCByZW1haW4gaW5zaWRlIHRoZSBjb250YWluZXIgZXZlbiBhZnRlciB3ZSBjYWxsIGluc2VydEFmdGVyKCkuCgkJCS8vIElmIHRoYXQgaGFwcGVucyBhbmQgd2UgcmVtb3ZlIHRoZSBjb250YWluZXIgYSBmZXcgbGluZXMgYmVsb3csIHdlCgkJCS8vIHdpbGwgY2F1c2UgYW4gaW5maW5pdGUgcmVjdXJzaW9uIC0gIzUyNDQKCQkJLmRldGFjaCgpCgkJCS5pbnNlcnRBZnRlciggdGhpcy5fdWkucGxhY2Vob2xkZXIgKQoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cCB1aS1vdmVybGF5LXNoYWRvdyB1aS1jb3JuZXItYWxsIHVpLWJvZHktaW5oZXJpdCIgKTsKCQl0aGlzLl91aS5zY3JlZW4ucmVtb3ZlKCk7CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZSgpOwoJCXRoaXMuX3VpLnBsYWNlaG9sZGVyLnJlbW92ZSgpOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJaWYgKCAkLm1vYmlsZS5wb3B1cC5hY3RpdmUgPT09IHRoaXMgKSB7CgkJCXRoaXMuZWxlbWVudC5vbmUoICJwb3B1cGFmdGVyY2xvc2UiLCAkLnByb3h5KCB0aGlzLCAiX3VuZW5oYW5jZSIgKSApOwoJCQl0aGlzLmNsb3NlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5fdW5lbmhhbmNlKCk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJX2Nsb3NlUG9wdXA6IGZ1bmN0aW9uKCB0aGVFdmVudCwgZGF0YSApIHsKCQl2YXIgcGFyc2VkRHN0LCB0b1VybCwKCQkJY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWltbWVkaWF0ZSA9IGZhbHNlOwoKCQlpZiAoICggdGhlRXZlbnQgJiYgdGhlRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB8fCAkLm1vYmlsZS5wb3B1cC5hY3RpdmUgIT09IHRoaXMgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIHJlc3RvcmUgbG9jYXRpb24gb24gc2NyZWVuCgkJd2luZG93LnNjcm9sbFRvKCAwLCB0aGlzLl9zY3JvbGxUb3AgKTsKCgkJaWYgKCB0aGVFdmVudCAmJiB0aGVFdmVudC50eXBlID09PSAicGFnZWJlZm9yZWNoYW5nZSIgJiYgZGF0YSApIHsKCQkJLy8gRGV0ZXJtaW5lIHdoZXRoZXIgd2UgbmVlZCB0byByYXBpZC1jbG9zZSB0aGUgcG9wdXAsIG9yIHdoZXRoZXIgd2UgY2FuCgkJCS8vIHRha2UgdGhlIHRpbWUgdG8gcnVuIHRoZSBjbG9zaW5nIHRyYW5zaXRpb24KCQkJaWYgKCB0eXBlb2YgZGF0YS50b1BhZ2UgPT09ICJzdHJpbmciICkgewoJCQkJcGFyc2VkRHN0ID0gZGF0YS50b1BhZ2U7CgkJCX0gZWxzZSB7CgkJCQlwYXJzZWREc3QgPSBkYXRhLnRvUGFnZS5qcW1EYXRhKCAidXJsIiApOwoJCQl9CgkJCXBhcnNlZERzdCA9ICQubW9iaWxlLnBhdGgucGFyc2VVcmwoIHBhcnNlZERzdCApOwoJCQl0b1VybCA9IHBhcnNlZERzdC5wYXRobmFtZSArIHBhcnNlZERzdC5zZWFyY2ggKyBwYXJzZWREc3QuaGFzaDsKCgkJCWlmICggdGhpcy5fbXlVcmwgIT09ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCB0b1VybCApICkgewoJCQkJLy8gR29pbmcgdG8gYSBkaWZmZXJlbnQgcGFnZSAtIGNsb3NlIGltbWVkaWF0ZWx5CgkJCQlpbW1lZGlhdGUgPSB0cnVlOwoJCQl9IGVsc2UgewoJCQkJdGhlRXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCX0KCgkJLy8gcmVtb3ZlIG5hdiBiaW5kaW5ncwoJCXRoaXMud2luZG93Lm9mZiggY3VycmVudE9wdGlvbnMuY2xvc2VFdmVudHMgKTsKCQkvLyB1bmJpbmQgY2xpY2sgaGFuZGxlcnMgYWRkZWQgd2hlbiBoaXN0b3J5IGlzIGRpc2FibGVkCgkJdGhpcy5lbGVtZW50LnVuZGVsZWdhdGUoIGN1cnJlbnRPcHRpb25zLmNsb3NlTGlua1NlbGVjdG9yLCBjdXJyZW50T3B0aW9ucy5jbG9zZUxpbmtFdmVudHMgKTsKCgkJdGhpcy5fY2xvc2UoIGltbWVkaWF0ZSApOwoJfSwKCgkvLyBhbnkgbmF2aWdhdGlvbiBldmVudCBhZnRlciBhIHBvcHVwIGlzIG9wZW5lZCBzaG91bGQgY2xvc2UgdGhlIHBvcHVwCgkvLyBOT1RFIHRoZSBwYWdlYmVmb3JlY2hhbmdlIGlzIGJvdW5kIHRvIGNhdGNoIG5hdmlnYXRpb24gZXZlbnRzIHRoYXQgZG9uJ3QKCS8vICAgICAgYWx0ZXIgdGhlIHVybCAoZWcsIGRpYWxvZ3MgZnJvbSBwb3B1cHMpCglfYmluZENvbnRhaW5lckNsb3NlOiBmdW5jdGlvbigpIHsKCQl0aGlzLndpbmRvdwoJCQkub24oIHRoaXMub3B0aW9ucy5jbG9zZUV2ZW50cywgJC5wcm94eSggdGhpcywgIl9jbG9zZVBvcHVwIiApICk7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3VpLmNvbnRhaW5lcjsKCX0sCgoJLy8gVE9ETyBubyBjbGVhciBkZWxpbmlhdGlvbiBvZiB3aGF0IHNob3VsZCBiZSBoZXJlIGFuZAoJLy8gd2hhdCBzaG91bGQgYmUgaW4gX29wZW4uIFNlZW1zIHRvIGJlICJ2aXN1YWwiIHZzICJoaXN0b3J5IiBmb3Igbm93CglvcGVuOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgdXJsLCBoYXNoa2V5LCBhY3RpdmVQYWdlLCBjdXJyZW50SXNEaWFsb2csIGhhc0hhc2gsIHVybEhpc3RvcnksCgkJCXNlbGYgPSB0aGlzLAoJCQljdXJyZW50T3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCgkJLy8gbWFrZSBzdXJlIG9wZW4gaXMgaWRlbXBvdGVudAoJCWlmICggJC5tb2JpbGUucG9wdXAuYWN0aXZlIHx8IGN1cnJlbnRPcHRpb25zLmRpc2FibGVkICkgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCS8vIHNldCB0aGUgZ2xvYmFsIHBvcHVwIG11dGV4CgkJJC5tb2JpbGUucG9wdXAuYWN0aXZlID0gdGhpczsKCQl0aGlzLl9zY3JvbGxUb3AgPSB0aGlzLndpbmRvdy5zY3JvbGxUb3AoKTsKCgkJLy8gaWYgaGlzdG9yeSBhbHRlcmF0aW9uIGlzIGRpc2FibGVkIGNsb3NlIG9uIG5hdmlnYXRlIGV2ZW50cwoJCS8vIGFuZCBsZWF2ZSB0aGUgdXJsIGFzIGlzCgkJaWYgKCAhKCBjdXJyZW50T3B0aW9ucy5oaXN0b3J5ICkgKSB7CgkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJc2VsZi5fYmluZENvbnRhaW5lckNsb3NlKCk7CgoJCQkvLyBXaGVuIGhpc3RveSBpcyBkaXNhYmxlZCB3ZSBoYXZlIHRvIGdyYWIgdGhlIGRhdGEtcmVsCgkJCS8vIGJhY2sgbGluayBjbGlja3Mgc28gd2UgY2FuIGNsb3NlIHRoZSBwb3B1cCBpbnN0ZWFkIG9mCgkJCS8vIHJlbHlpbmcgb24gaGlzdG9yeSB0byBkbyBpdCBmb3IgdXMKCQkJc2VsZi5lbGVtZW50CgkJCQkuZGVsZWdhdGUoIGN1cnJlbnRPcHRpb25zLmNsb3NlTGlua1NlbGVjdG9yLCBjdXJyZW50T3B0aW9ucy5jbG9zZUxpbmtFdmVudHMsIGZ1bmN0aW9uKCB0aGVFdmVudCApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQkJdGhlRXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCX0pOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQkvLyBjYWNoZSBzb21lIHZhbHVlcyBmb3IgbWluL3JlYWRhYmlsaXR5CgkJdXJsSGlzdG9yeSA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnk7CgkJaGFzaGtleSA9ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXk7CgkJYWN0aXZlUGFnZSA9ICQubW9iaWxlLmFjdGl2ZVBhZ2U7CgkJY3VycmVudElzRGlhbG9nID0gKCBhY3RpdmVQYWdlID8gYWN0aXZlUGFnZS5oYXNDbGFzcyggInVpLWRpYWxvZyIgKSA6IGZhbHNlICk7CgkJdGhpcy5fbXlVcmwgPSB1cmwgPSB1cmxIaXN0b3J5LmdldEFjdGl2ZSgpLnVybDsKCQloYXNIYXNoID0gKCB1cmwuaW5kZXhPZiggaGFzaGtleSApID4gLTEgKSAmJiAhY3VycmVudElzRGlhbG9nICYmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA+IDAgKTsKCgkJaWYgKCBoYXNIYXNoICkgewoJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCS8vIGlmIHRoZSBjdXJyZW50IHVybCBoYXMgbm8gZGlhbG9nIGhhc2gga2V5IHByb2NlZWQgYXMgbm9ybWFsCgkJLy8gb3RoZXJ3aXNlLCBpZiB0aGUgcGFnZSBpcyBhIGRpYWxvZyBzaW1wbHkgdGFjayBvbiB0aGUgaGFzaCBrZXkKCQlpZiAoIHVybC5pbmRleE9mKCBoYXNoa2V5ICkgPT09IC0xICYmICFjdXJyZW50SXNEaWFsb2cgKSB7CgkJCXVybCA9IHVybCArICh1cmwuaW5kZXhPZiggIiMiICkgPiAtMSA/IGhhc2hrZXkgOiAiIyIgKyBoYXNoa2V5KTsKCQl9IGVsc2UgewoJCQl1cmwgPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoICsgaGFzaGtleTsKCQl9CgoJCS8vIFRhY2sgb24gYW4gZXh0cmEgaGFzaGtleSBpZiB0aGlzIGlzIHRoZSBmaXJzdCBwYWdlIGFuZCB3ZSd2ZSBqdXN0IHJlY29uc3RydWN0ZWQgdGhlIGluaXRpYWwgaGFzaAoJCWlmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCAmJiB1cmwgPT09IHVybEhpc3RvcnkuaW5pdGlhbERzdCApIHsKCQkJdXJsICs9IGhhc2hrZXk7CgkJfQoKCQkvLyBzd2FsbG93IHRoZSB0aGUgaW5pdGlhbCBuYXZpZ2F0aW9uIGV2ZW50LCBhbmQgYmluZCBmb3IgdGhlIG5leHQKCQl0aGlzLndpbmRvdy5vbmUoICJiZWZvcmVuYXZpZ2F0ZSIsIGZ1bmN0aW9uKCB0aGVFdmVudCApIHsKCQkJdGhlRXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJc2VsZi5fb3Blbiggb3B0aW9ucyApOwoJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCQl9KTsKCgkJdGhpcy51cmxBbHRlcmVkID0gdHJ1ZTsKCQkkLm1vYmlsZS5uYXZpZ2F0ZSggdXJsLCB7IHJvbGU6ICJkaWFsb2ciIH0gKTsKCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNsb3NlOiBmdW5jdGlvbigpIHsKCQkvLyBtYWtlIHN1cmUgY2xvc2UgaXMgaWRlbXBvdGVudAoJCWlmICggJC5tb2JpbGUucG9wdXAuYWN0aXZlICE9PSB0aGlzICkgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXRoaXMuX3Njcm9sbFRvcCA9IHRoaXMud2luZG93LnNjcm9sbFRvcCgpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5oaXN0b3J5ICYmIHRoaXMudXJsQWx0ZXJlZCApIHsKCQkJJC5tb2JpbGUuYmFjaygpOwoJCQl0aGlzLnVybEFsdGVyZWQgPSBmYWxzZTsKCQl9IGVsc2UgewoJCQkvLyBzaW11bGF0ZSB0aGUgbmF2IGJpbmRpbmdzIGhhdmluZyBmaXJlZAoJCQl0aGlzLl9jbG9zZVBvcHVwKCk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KfSk7CgovLyBUT0RPIHRoaXMgY2FuIGJlIG1vdmVkIGluc2lkZSB0aGUgd2lkZ2V0CiQubW9iaWxlLnBvcHVwLmhhbmRsZUxpbmsgPSBmdW5jdGlvbiggJGxpbmsgKSB7Cgl2YXIgb2Zmc2V0LAoJCXBhdGggPSAkLm1vYmlsZS5wYXRoLAoKCQkvLyBOT1RFIG1ha2Ugc3VyZSB0byBnZXQgb25seSB0aGUgaGFzaCBmcm9tIHRoZSBocmVmIGJlY2F1c2UgaWU3ICh3cDcpCgkJLy8gICAgICByZXR1cm5zIHRoZSBhYnNvbHV0ZSBocmVmIGluIHRoaXMgY2FzZSBydWluaW5nIHRoZSBlbGVtZW50IHNlbGVjdGlvbgoJCXBvcHVwID0gJCggcGF0aC5oYXNoVG9TZWxlY3RvciggcGF0aC5wYXJzZVVybCggJGxpbmsuYXR0ciggImhyZWYiICkgKS5oYXNoICkgKS5maXJzdCgpOwoKCWlmICggcG9wdXAubGVuZ3RoID4gMCAmJiBwb3B1cC5kYXRhKCAibW9iaWxlLXBvcHVwIiApICkgewoJCW9mZnNldCA9ICRsaW5rLm9mZnNldCgpOwoJCXBvcHVwLnBvcHVwKCAib3BlbiIsIHsKCQkJeDogb2Zmc2V0LmxlZnQgKyAkbGluay5vdXRlcldpZHRoKCkgLyAyLAoJCQl5OiBvZmZzZXQudG9wICsgJGxpbmsub3V0ZXJIZWlnaHQoKSAvIDIsCgkJCXRyYW5zaXRpb246ICRsaW5rLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQlwb3NpdGlvblRvOiAkbGluay5qcW1EYXRhKCAicG9zaXRpb24tdG8iICkKCQl9KTsKCX0KCgkvL3JlbW92ZSBhZnRlciBkZWxheQoJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJJGxpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7Cgl9LCAzMDAgKTsKfTsKCi8vIFRPRE8gbW92ZSBpbnNpZGUgX2NyZWF0ZQokLm1vYmlsZS5kb2N1bWVudC5vbiggInBhZ2ViZWZvcmVjaGFuZ2UiLCBmdW5jdGlvbiggdGhlRXZlbnQsIGRhdGEgKSB7CglpZiAoIGRhdGEub3B0aW9ucy5yb2xlID09PSAicG9wdXAiICkgewoJCSQubW9iaWxlLnBvcHVwLmhhbmRsZUxpbmsoIGRhdGEub3B0aW9ucy5saW5rICk7CgkJdGhlRXZlbnQucHJldmVudERlZmF1bHQoKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgovKgoqIGN1c3RvbSAic2VsZWN0bWVudSIgcGx1Z2luCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciB1bmZvY3VzYWJsZUl0ZW1TZWxlY3RvciA9ICIudWktZGlzYWJsZWQsLnVpLXN0YXRlLWRpc2FibGVkLC51aS1saS1kaXZpZGVyLC51aS1zY3JlZW4taGlkZGVuLDpqcW1EYXRhKHJvbGU9J3BsYWNlaG9sZGVyJykiLAoJZ29Ub0FkamFjZW50SXRlbSA9IGZ1bmN0aW9uKCBpdGVtLCB0YXJnZXQsIGRpcmVjdGlvbiApIHsKCQl2YXIgYWRqYWNlbnQgPSBpdGVtWyBkaXJlY3Rpb24gKyAiQWxsIiBdKCkKCQkJLm5vdCggdW5mb2N1c2FibGVJdGVtU2VsZWN0b3IgKQoJCQkuZmlyc3QoKTsKCgkJLy8gaWYgdGhlcmUncyBhIHByZXZpb3VzIG9wdGlvbiwgZm9jdXMgaXQKCQlpZiAoIGFkamFjZW50Lmxlbmd0aCApIHsKCQkJdGFyZ2V0CgkJCQkuYmx1cigpCgkJCQkuYXR0ciggInRhYmluZGV4IiwgIi0xIiApOwoKCQkJYWRqYWNlbnQuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCX0KCX07CgokLndpZGdldCggIm1vYmlsZS5zZWxlY3RtZW51IiwgJC5tb2JpbGUuc2VsZWN0bWVudSwgewoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7CgoJCS8vIEN1c3RvbSBzZWxlY3RzIGNhbm5vdCBleGlzdCBpbnNpZGUgcG9wdXBzLCBzbyByZXZlcnQgdGhlICJuYXRpdmVNZW51IgoJCS8vIG9wdGlvbiB0byB0cnVlIGlmIGEgcGFyZW50IGlzIGEgcG9wdXAKCQlvLm5hdGl2ZU1lbnUgPSBvLm5hdGl2ZU1lbnUgfHwgKCB0aGlzLmVsZW1lbnQucGFyZW50cyggIjpqcW1EYXRhKHJvbGU9J3BvcHVwJyksOm1vYmlsZS1wb3B1cCIgKS5sZW5ndGggPiAwICk7CgoJCXJldHVybiB0aGlzLl9zdXBlcigpOwoJfSwKCglfaGFuZGxlU2VsZWN0Rm9jdXM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5ibHVyKCk7CgkJdGhpcy5idXR0b24uZm9jdXMoKTsKCX0sCgoJX2hhbmRsZUtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl0aGlzLl9zdXBlciggZXZlbnQgKTsKCQl0aGlzLl9oYW5kbGVCdXR0b25WY2xpY2tLZXlkb3duKCBldmVudCApOwoJfSwKCglfaGFuZGxlQnV0dG9uVmNsaWNrS2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8IHRoaXMuaXNPcGVuICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoZXZlbnQudHlwZSA9PT0gInZjbGljayIgfHwKCQkJCWV2ZW50LmtleUNvZGUgJiYgKGV2ZW50LmtleUNvZGUgPT09ICQubW9iaWxlLmtleUNvZGUuRU5URVIgfHwgZXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5TUEFDRSkpIHsKCgkJCXRoaXMuX2RlY2lkZUZvcm1hdCgpOwoJCQlpZiAoIHRoaXMubWVudVR5cGUgPT09ICJvdmVybGF5IiApIHsKCQkJCXRoaXMuYnV0dG9uLmF0dHIoICJocmVmIiwgIiMiICsgdGhpcy5wb3B1cElkICkuYXR0ciggImRhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJyZWwiLCAicG9wdXAiICk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmJ1dHRvbi5hdHRyKCAiaHJlZiIsICIjIiArIHRoaXMuZGlhbG9nSWQgKS5hdHRyKCAiZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInJlbCIsICJkaWFsb2ciICk7CgkJCX0KCQkJdGhpcy5pc09wZW4gPSB0cnVlOwoJCQkvLyBEbyBub3QgcHJldmVudCBkZWZhdWx0LCBzbyB0aGUgbmF2aWdhdGlvbiBtYXkgaGF2ZSBhIGNoYW5jZSB0byBhY3R1YWxseSBvcGVuIHRoZSBjaG9zZW4gZm9ybWF0CgkJfQoJfSwKCglfaGFuZGxlTGlzdEZvY3VzOiBmdW5jdGlvbiggZSApIHsKCQl2YXIgcGFyYW1zID0gKCBlLnR5cGUgPT09ICJmb2N1c2luIiApID8KCQkJeyB0YWJpbmRleDogIjAiLCBldmVudDogInZtb3VzZW92ZXIiIH06CgkJCXsgdGFiaW5kZXg6ICItMSIsIGV2ZW50OiAidm1vdXNlb3V0IiB9OwoKCQkkKCBlLnRhcmdldCApCgkJCS5hdHRyKCAidGFiaW5kZXgiLCBwYXJhbXMudGFiaW5kZXggKQoJCQkudHJpZ2dlciggcGFyYW1zLmV2ZW50ICk7Cgl9LAoKCV9oYW5kbGVMaXN0S2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciB0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKSwKCQkJbGkgPSB0YXJnZXQuY2xvc2VzdCggImxpIiApOwoKCQkvLyBzd2l0Y2ggbG9naWMgYmFzZWQgb24gd2hpY2gga2V5IHdhcyBwcmVzc2VkCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJLy8gdXAgb3IgbGVmdCBhcnJvdyBrZXlzCgkJY2FzZSAzODoKCQkJZ29Ub0FkamFjZW50SXRlbSggbGksIHRhcmdldCwgInByZXYiICk7CgkJCXJldHVybiBmYWxzZTsKCQkJLy8gZG93biBvciByaWdodCBhcnJvdyBrZXlzCgkJY2FzZSA0MDoKCQkJZ29Ub0FkamFjZW50SXRlbSggbGksIHRhcmdldCwgIm5leHQiICk7CgkJCXJldHVybiBmYWxzZTsKCQkJLy8gSWYgZW50ZXIgb3Igc3BhY2UgaXMgcHJlc3NlZCwgdHJpZ2dlciBjbGljawoJCWNhc2UgMTM6CgkJY2FzZSAzMjoKCQkJdGFyZ2V0LnRyaWdnZXIoICJjbGljayIgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX0sCgoJX2hhbmRsZU1lbnVQYWdlSGlkZTogZnVuY3Rpb24oKSB7CgkJLy8gVE9ETyBjZW50cmFsaXplIHBhZ2UgcmVtb3ZhbCBiaW5kaW5nIC8gaGFuZGxpbmcgaW4gdGhlIHBhZ2UgcGx1Z2luLgoJCS8vIFN1Z2dlc3Rpb24gZnJvbSBAamJsYXMgdG8gZG8gcmVmY291bnRpbmcKCQkvLwoJCS8vIFRPRE8gZXh0cmVtZWx5IGNvbmZ1c2luZyBkZXBlbmRlbmN5IG9uIHRoZSBvcGVuIG1ldGhvZCB3aGVyZSB0aGUgcGFnZWhpZGUucmVtb3ZlCgkJLy8gYmluZGluZ3MgYXJlIHN0cmlwcGVkIHRvIHByZXZlbnQgdGhlIHBhcmVudCBwYWdlIGZyb20gZGlzYXBwZWFyaW5nLiBUaGUgd2F5CgkJLy8gd2UncmUga2VlcGluZyBwYWdlcyBpbiB0aGUgRE9NIHJpZ2h0IG5vdyBzdWNrcwoJCS8vCgkJLy8gcmViaW5kIHRoZSBwYWdlIHJlbW92ZSB0aGF0IHdhcyB1bmJvdW5kIGluIHRoZSBvcGVuIGZ1bmN0aW9uCgkJLy8gdG8gYWxsb3cgZm9yIHRoZSBwYXJlbnQgcGFnZSByZW1vdmFsIGZyb20gYWN0aW9ucyBvdGhlciB0aGFuIHRoZSB1c2UKCQkvLyBvZiBhIGRpYWxvZyBzaXplZCBjdXN0b20gc2VsZWN0CgkJLy8KCQkvLyBkb2luZyB0aGlzIGhlcmUgcHJvdmlkZXMgZm9yIHRoZSBiYWNrIGJ1dHRvbiBvbiB0aGUgY3VzdG9tIHNlbGVjdCBkaWFsb2cKCQl0aGlzLnRoaXNQYWdlLnBhZ2UoICJiaW5kUmVtb3ZlIiApOwoJfSwKCglfaGFuZGxlSGVhZGVyQ2xvc2VDbGljazogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm1lbnVUeXBlID09PSAib3ZlcmxheSIgKSB7CgkJCXRoaXMuY2xvc2UoKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX0sCgoJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxlY3RJZCwgcG9wdXBJZCwgZGlhbG9nSWQsIGxhYmVsLCB0aGlzUGFnZSwgaXNNdWx0aXBsZSwgbWVudUlkLCB0aGVtZUF0dHIsIG92ZXJsYXlUaGVtZUF0dHIsCgkJCWRpdmlkZXJUaGVtZUF0dHIsIG1lbnVQYWdlLCBsaXN0Ym94LCBsaXN0LCBoZWFkZXIsIGhlYWRlclRpdGxlLCBtZW51UGFnZUNvbnRlbnQsIG1lbnVQYWdlQ2xvc2UsIGhlYWRlckNsb3NlLCBzZWxmLAoJCQlvID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG8ubmF0aXZlTWVudSApIHsKCQkJcmV0dXJuIHRoaXMuX3N1cGVyKCk7CgkJfQoKCQlzZWxmID0gdGhpczsKCQlzZWxlY3RJZCA9IHRoaXMuc2VsZWN0SWQ7CgkJcG9wdXBJZCA9IHNlbGVjdElkICsgIi1saXN0Ym94IjsKCQlkaWFsb2dJZCA9IHNlbGVjdElkICsgIi1kaWFsb2ciOwoJCWxhYmVsID0gdGhpcy5sYWJlbDsKCQl0aGlzUGFnZSA9IHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICk7CgkJaXNNdWx0aXBsZSA9IHRoaXMuZWxlbWVudFsgMCBdLm11bHRpcGxlOwoJCW1lbnVJZCA9IHNlbGVjdElkICsgIi1tZW51IjsKCQl0aGVtZUF0dHIgPSBvLnRoZW1lID8gKCAiIGRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lPSciICsgby50aGVtZSArICInIiApIDogIiI7CgkJb3ZlcmxheVRoZW1lQXR0ciA9IG8ub3ZlcmxheVRoZW1lID8gKCAiIGRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lPSciICsgby5vdmVybGF5VGhlbWUgKyAiJyIgKSA6ICIiOwoJCWRpdmlkZXJUaGVtZUF0dHIgPSAoIG8uZGl2aWRlclRoZW1lICYmIGlzTXVsdGlwbGUgKSA/ICggIiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJkaXZpZGVyLXRoZW1lPSciICsgby5kaXZpZGVyVGhlbWUgKyAiJyIgKSA6ICIiOwoJCW1lbnVQYWdlID0gJCggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0nZGlhbG9nJyBjbGFzcz0ndWktc2VsZWN0bWVudScgaWQ9JyIgKyBkaWFsb2dJZCArICInIiArIHRoZW1lQXR0ciArIG92ZXJsYXlUaGVtZUF0dHIgKyAiPiIgKwoJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdoZWFkZXInPiIgKwoJCQkiPGRpdiBjbGFzcz0ndWktdGl0bGUnPiIgKyBsYWJlbC5nZXRFbmNvZGVkVGV4dCgpICsgIjwvZGl2PiIrCgkJCSI8L2Rpdj4iKwoJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdjb250ZW50Jz48L2Rpdj4iKwoJCQkiPC9kaXY+IiApOwoJCWxpc3Rib3ggPSAkKCAiPGRpdiBpZD0nIiArIHBvcHVwSWQgKyAiJyBjbGFzcz0ndWktc2VsZWN0bWVudSc+IiApLmluc2VydEFmdGVyKCB0aGlzLnNlbGVjdCApLnBvcHVwKHsgdGhlbWU6IG8ub3ZlcmxheVRoZW1lIH0pOwoJCWxpc3QgPSAkKCAiPHVsIGNsYXNzPSd1aS1zZWxlY3RtZW51LWxpc3QnIGlkPSciICsgbWVudUlkICsgIicgcm9sZT0nbGlzdGJveCcgYXJpYS1sYWJlbGxlZGJ5PSciICsgdGhpcy5idXR0b25JZCArICInIiArIHRoZW1lQXR0ciArIGRpdmlkZXJUaGVtZUF0dHIgKyAiPiIgKS5hcHBlbmRUbyggbGlzdGJveCApOwoJCWhlYWRlciA9ICQoICI8ZGl2IGNsYXNzPSd1aS1oZWFkZXIgdWktYmFyLSIgKyAoIG8udGhlbWUgPyBvLnRoZW1lIDogImluaGVyaXQiICkgKyAiJz4iICkucHJlcGVuZFRvKCBsaXN0Ym94ICk7CgkJaGVhZGVyVGl0bGUgPSAkKCAiPGgxIGNsYXNzPSd1aS10aXRsZSc+IiApLmFwcGVuZFRvKCBoZWFkZXIgKTsKCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCWhlYWRlckNsb3NlID0gJCggIjxhPiIsIHsKCQkJCSJyb2xlIjogImJ1dHRvbiIsCgkJCQkidGV4dCI6IG8uY2xvc2VUZXh0LAoJCQkJImhyZWYiOiAiIyIsCgkJCQkiY2xhc3MiOiAidWktYnRuIHVpLWNvcm5lci1hbGwgdWktYnRuLXJpZ2h0IHVpLWJ0bi1pY29uLW5vdGV4dCB1aS1pY29uLWRlbGV0ZSIKCQkJfSkuYXBwZW5kVG8oIGhlYWRlciApOwoJCX0KCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJc2VsZWN0SWQ6IHNlbGVjdElkLAoJCQltZW51SWQ6IG1lbnVJZCwKCQkJcG9wdXBJZDogcG9wdXBJZCwKCQkJZGlhbG9nSWQ6IGRpYWxvZ0lkLAoJCQl0aGlzUGFnZTogdGhpc1BhZ2UsCgkJCW1lbnVQYWdlOiBtZW51UGFnZSwKCQkJbGFiZWw6IGxhYmVsLAoJCQlpc011bHRpcGxlOiBpc011bHRpcGxlLAoJCQl0aGVtZTogby50aGVtZSwKCQkJbGlzdGJveDogbGlzdGJveCwKCQkJbGlzdDogbGlzdCwKCQkJaGVhZGVyOiBoZWFkZXIsCgkJCWhlYWRlclRpdGxlOiBoZWFkZXJUaXRsZSwKCQkJaGVhZGVyQ2xvc2U6IGhlYWRlckNsb3NlLAoJCQltZW51UGFnZUNvbnRlbnQ6IG1lbnVQYWdlQ29udGVudCwKCQkJbWVudVBhZ2VDbG9zZTogbWVudVBhZ2VDbG9zZSwKCQkJcGxhY2Vob2xkZXI6ICIiCgkJfSk7CgoJCS8vIENyZWF0ZSBsaXN0IGZyb20gc2VsZWN0LCB1cGRhdGUgc3RhdGUKCQl0aGlzLnJlZnJlc2goKTsKCgkJaWYgKCB0aGlzLl9vcmlnVGFiSW5kZXggPT09IHVuZGVmaW5lZCApIHsKCQkJLy8gTWFwIHVuZGVmaW5lZCB0byBmYWxzZSwgYmVjYXVzZSB0aGlzLl9vcmlnVGFiSW5kZXggPT09IHVuZGVmaW5lZAoJCQkvLyBpbmRpY2F0ZXMgdGhhdCB3ZSBoYXZlIG5vdCB5ZXQgY2hlY2tlZCB3aGV0aGVyIHRoZSBzZWxlY3QgaGFzCgkJCS8vIG9yaWdpbmFsbHkgaGFkIGEgdGFiaW5kZXggYXR0cmlidXRlLCB3aGVyZWFzIGZhbHNlIGluZGljYXRlcyB0aGF0CgkJCS8vIHdlIGhhdmUgY2hlY2tlZCB0aGUgc2VsZWN0IGZvciBzdWNoIGFuIGF0dHJpYnV0ZSwgYW5kIGhhdmUgZm91bmQKCQkJLy8gbm9uZSBwcmVzZW50LgoJCQl0aGlzLl9vcmlnVGFiSW5kZXggPSAoIHRoaXMuc2VsZWN0WyAwIF0uZ2V0QXR0cmlidXRlKCAidGFiaW5kZXgiICkgPT09IG51bGwgKSA/IGZhbHNlIDogdGhpcy5zZWxlY3QuYXR0ciggInRhYmluZGV4IiApOwoJCX0KCQl0aGlzLnNlbGVjdC5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgkJdGhpcy5fb24oIHRoaXMuc2VsZWN0LCB7IGZvY3VzIDogIl9oYW5kbGVTZWxlY3RGb2N1cyIgfSApOwoKCQkvLyBCdXR0b24gZXZlbnRzCgkJdGhpcy5fb24oIHRoaXMuYnV0dG9uLCB7CgkJCXZjbGljazogIl9oYW5kbGVCdXR0b25WY2xpY2tLZXlkb3duIgoJCX0pOwoKCQkvLyBFdmVudHMgZm9yIGxpc3QgaXRlbXMKCQl0aGlzLmxpc3QuYXR0ciggInJvbGUiLCAibGlzdGJveCIgKTsKCQl0aGlzLl9vbiggdGhpcy5saXN0LCB7CgkJCWZvY3VzaW4gOiAiX2hhbmRsZUxpc3RGb2N1cyIsCgkJCWZvY3Vzb3V0IDogIl9oYW5kbGVMaXN0Rm9jdXMiLAoJCQlrZXlkb3duOiAiX2hhbmRsZUxpc3RLZXlkb3duIgoJCX0pOwoJCXRoaXMubGlzdAoJCQkuZGVsZWdhdGUoICJsaTpub3QoLnVpLWRpc2FibGVkLC51aS1zdGF0ZS1kaXNhYmxlZCwudWktbGktZGl2aWRlcikiLCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJLy8gaW5kZXggb2Ygb3B0aW9uIHRhZyB0byBiZSBzZWxlY3RlZAoJCQkJdmFyIG9sZEluZGV4ID0gc2VsZi5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4LAoJCQkJCW5ld0luZGV4ID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAib3B0aW9uLWluZGV4IiApLAoJCQkJCW9wdGlvbiA9IHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5lcSggbmV3SW5kZXggKVsgMCBdOwoKCQkJCS8vIHRvZ2dsZSBzZWxlY3RlZCBzdGF0dXMgb24gdGhlIHRhZyBmb3IgbXVsdGkgc2VsZWN0cwoJCQkJb3B0aW9uLnNlbGVjdGVkID0gc2VsZi5pc011bHRpcGxlID8gIW9wdGlvbi5zZWxlY3RlZCA6IHRydWU7CgoJCQkJLy8gdG9nZ2xlIGNoZWNrYm94IGNsYXNzIGZvciBtdWx0aXBsZSBzZWxlY3RzCgkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkkKCB0aGlzICkuZmluZCggImEiICkKCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY2hlY2tib3gtb24iLCBvcHRpb24uc2VsZWN0ZWQgKQoJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jaGVja2JveC1vZmYiLCAhb3B0aW9uLnNlbGVjdGVkICk7CgkJCQl9CgoJCQkJLy8gdHJpZ2dlciBjaGFuZ2UgaWYgdmFsdWUgY2hhbmdlZAoJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgfHwgb2xkSW5kZXggIT09IG5ld0luZGV4ICkgewoJCQkJCXNlbGYuc2VsZWN0LnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCQl9CgoJCQkJLy8gaGlkZSBjdXN0b20gc2VsZWN0IGZvciBzaW5nbGUgc2VsZWN0cyBvbmx5IC0gb3RoZXJ3aXNlIGZvY3VzIGNsaWNrZWQgaXRlbQoJCQkJLy8gV2UgbmVlZCB0byBncmFiIHRoZSBjbGlja2VkIGl0ZW0gdGhlIGhhcmQgd2F5LCBiZWNhdXNlIHRoZSBsaXN0IG1heSBoYXZlIGJlZW4gcmVidWlsdAoJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJc2VsZi5saXN0LmZpbmQoICJsaTpub3QoLnVpLWxpLWRpdmlkZXIpIiApLmVxKCBuZXdJbmRleCApCgkJCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJCQl9CgkJCQllbHNlIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9CgoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfSk7CgoJCS8vIGJ1dHRvbiByZWZvY3VzIGVuc3VyZXMgcHJvcGVyIGhlaWdodCBjYWxjdWxhdGlvbgoJCS8vIGJ5IHJlbW92aW5nIHRoZSBpbmxpbmUgc3R5bGUgYW5kIGVuc3VyaW5nIHBhZ2UgaW5jbHVzaW9uCgkJdGhpcy5fb24oIHRoaXMubWVudVBhZ2UsIHsgcGFnZWhpZGU6ICJfaGFuZGxlTWVudVBhZ2VIaWRlIiB9ICk7CgoJCS8vIEV2ZW50cyBvbiB0aGUgcG9wdXAKCQl0aGlzLl9vbiggdGhpcy5saXN0Ym94LCB7IHBvcHVwYWZ0ZXJjbG9zZTogImNsb3NlIiB9ICk7CgoJCS8vIENsb3NlIGJ1dHRvbiBvbiBzbWFsbCBvdmVybGF5cwoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQl0aGlzLl9vbiggdGhpcy5oZWFkZXJDbG9zZSwgeyBjbGljazogIl9oYW5kbGVIZWFkZXJDbG9zZUNsaWNrIiB9ICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJX2lzUmVidWlsZFJlcXVpcmVkOiBmdW5jdGlvbigpIHsKCQl2YXIgbGlzdCA9IHRoaXMubGlzdC5maW5kKCAibGkiICksCgkJCW9wdGlvbnMgPSB0aGlzLl9zZWxlY3RPcHRpb25zKCkubm90KCAiLnVpLXNjcmVlbi1oaWRkZW4iICk7CgoJCS8vIFRPRE8gZXhjZWVkaW5nbHkgbmFpdmUgbWV0aG9kIHRvIGRldGVybWluZSBkaWZmZXJlbmNlCgkJLy8gaWdub3JlcyB2YWx1ZSBjaGFuZ2VzIGV0YyBpbiBmYXZvciBvZiBhIGZvcmNlZFJlYnVpbGQKCQkvLyBmcm9tIHRoZSB1c2VyIGluIHRoZSByZWZyZXNoIG1ldGhvZAoJCXJldHVybiBvcHRpb25zLnRleHQoKSAhPT0gbGlzdC50ZXh0KCk7Cgl9LAoKCXNlbGVjdGVkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZDpub3QoIDpqcW1EYXRhKHBsYWNlaG9sZGVyPSd0cnVlJykgKSIgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIGZvcmNlICkgewoJCXZhciBzZWxmLCBpbmRpY2VzOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5uYXRpdmVNZW51ICkgewoJCQlyZXR1cm4gdGhpcy5fc3VwZXIoIGZvcmNlICk7CgkJfQoKCQlzZWxmID0gdGhpczsKCQlpZiAoIGZvcmNlIHx8IHRoaXMuX2lzUmVidWlsZFJlcXVpcmVkKCkgKSB7CgkJCXNlbGYuX2J1aWxkTGlzdCgpOwoJCX0KCgkJaW5kaWNlcyA9IHRoaXMuc2VsZWN0ZWRJbmRpY2VzKCk7CgoJCXNlbGYuc2V0QnV0dG9uVGV4dCgpOwoJCXNlbGYuc2V0QnV0dG9uQ291bnQoKTsKCgkJc2VsZi5saXN0LmZpbmQoICJsaTpub3QoLnVpLWxpLWRpdmlkZXIpIiApCgkJCS5maW5kKCAiYSIgKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKS5lbmQoKQoJCQkuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCBmYWxzZSApCgkJCS5lYWNoKGZ1bmN0aW9uKCBpICkgewoKCQkJCWlmICggJC5pbkFycmF5KCBpLCBpbmRpY2VzICkgPiAtMSApIHsKCQkJCQl2YXIgaXRlbSA9ICQoIHRoaXMgKTsKCgkJCQkJLy8gQXJpYSBzZWxlY3RlZCBhdHRyCgkJCQkJaXRlbS5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsIHRydWUgKTsKCgkJCQkJLy8gTXVsdGlwbGUgc2VsZWN0czogYWRkIHRoZSAib24iIGNoZWNrYm94IHN0YXRlIHRvIHRoZSBpY29uCgkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJCWl0ZW0uZmluZCggImEiICkucmVtb3ZlQ2xhc3MoICJ1aS1jaGVja2JveC1vZmYiICkuYWRkQ2xhc3MoICJ1aS1jaGVja2JveC1vbiIgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlpZiAoIGl0ZW0uaGFzQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApICkgewoJCQkJCQkJaXRlbS5uZXh0KCkuZmluZCggImEiICkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlpdGVtLmZpbmQoICJhIiApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9KTsKCX0sCgoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8ICF0aGlzLmlzT3BlbiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlpZiAoIHNlbGYubWVudVR5cGUgPT09ICJwYWdlIiApIHsKCQkJc2VsZi5tZW51UGFnZS5kaWFsb2coICJjbG9zZSIgKTsKCQkJc2VsZi5saXN0LmFwcGVuZFRvKCBzZWxmLmxpc3Rib3ggKTsKCQl9IGVsc2UgewoJCQlzZWxmLmxpc3Rib3gucG9wdXAoICJjbG9zZSIgKTsKCQl9CgoJCXNlbGYuX2ZvY3VzQnV0dG9uKCk7CgkJLy8gYWxsb3cgdGhlIGRpYWxvZyB0byBiZSBjbG9zZWQgYWdhaW4KCQlzZWxmLmlzT3BlbiA9IGZhbHNlOwoJfSwKCglvcGVuOiBmdW5jdGlvbigpIHsKCQl0aGlzLmJ1dHRvbi5jbGljaygpOwoJfSwKCglfZm9jdXNNZW51SXRlbTogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdG9yID0gdGhpcy5saXN0LmZpbmQoICJhLiIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCWlmICggc2VsZWN0b3IubGVuZ3RoID09PSAwICkgewoJCQlzZWxlY3RvciA9IHRoaXMubGlzdC5maW5kKCAibGk6bm90KCIgKyB1bmZvY3VzYWJsZUl0ZW1TZWxlY3RvciArICIpIGEudWktYnRuIiApOwoJCX0KCQlzZWxlY3Rvci5maXJzdCgpLmZvY3VzKCk7Cgl9LAoKCV9kZWNpZGVGb3JtYXQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJJHdpbmRvdyA9IHRoaXMud2luZG93LAoJCQlzZWxmTGlzdFBhcmVudCA9IHNlbGYubGlzdC5wYXJlbnQoKSwKCQkJbWVudUhlaWdodCA9IHNlbGZMaXN0UGFyZW50Lm91dGVySGVpZ2h0KCksCgkJCXNjcm9sbFRvcCA9ICR3aW5kb3cuc2Nyb2xsVG9wKCksCgkJCWJ0bk9mZnNldCA9IHNlbGYuYnV0dG9uLm9mZnNldCgpLnRvcCwKCQkJc2NyZWVuSGVpZ2h0ID0gJHdpbmRvdy5oZWlnaHQoKTsKCgkJaWYgKCBtZW51SGVpZ2h0ID4gc2NyZWVuSGVpZ2h0IC0gODAgfHwgISQuc3VwcG9ydC5zY3JvbGxUb3AgKSB7CgoJCQlzZWxmLm1lbnVQYWdlLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICkucGFnZSgpOwoJCQlzZWxmLm1lbnVQYWdlQ29udGVudCA9IHNlbGYubWVudVBhZ2UuZmluZCggIi51aS1jb250ZW50IiApOwoJCQlzZWxmLm1lbnVQYWdlQ2xvc2UgPSBzZWxmLm1lbnVQYWdlLmZpbmQoICIudWktaGVhZGVyIGEiICk7CgoJCQkvLyBwcmV2ZW50IHRoZSBwYXJlbnQgcGFnZSBmcm9tIGJlaW5nIHJlbW92ZWQgZnJvbSB0aGUgRE9NLAoJCQkvLyBvdGhlcndpc2UgdGhlIHJlc3VsdHMgb2Ygc2VsZWN0aW5nIGEgbGlzdCBpdGVtIGluIHRoZSBkaWFsb2cKCQkJLy8gZmFsbCBpbnRvIGEgYmxhY2sgaG9sZQoJCQlzZWxmLnRoaXNQYWdlLnVuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIgKTsKCgkJCS8vZm9yIFdlYk9TL09wZXJhIE1pbmkgKHNldCBsYXN0c2Nyb2xsIHVzaW5nIGJ1dHRvbiBvZmZzZXQpCgkJCWlmICggc2Nyb2xsVG9wID09PSAwICYmIGJ0bk9mZnNldCA+IHNjcmVlbkhlaWdodCApIHsKCQkJCXNlbGYudGhpc1BhZ2Uub25lKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuanFtRGF0YSggImxhc3RTY3JvbGwiLCBidG5PZmZzZXQgKTsKCQkJCX0pOwoJCQl9CgoJCQlzZWxmLm1lbnVQYWdlLm9uZSggewoJCQkJcGFnZXNob3c6ICQucHJveHkoIHRoaXMsICJfZm9jdXNNZW51SXRlbSIgKSwKCQkJCXBhZ2VoaWRlOiAkLnByb3h5KCB0aGlzLCAiY2xvc2UiICkKCQkJfSk7CgoJCQlzZWxmLm1lbnVUeXBlID0gInBhZ2UiOwoJCQlzZWxmLm1lbnVQYWdlQ29udGVudC5hcHBlbmQoIHNlbGYubGlzdCApOwoJCQlzZWxmLm1lbnVQYWdlLmZpbmQoICJkaXYgLnVpLXRpdGxlIiApLnRleHQoIHNlbGYubGFiZWwudGV4dCgpICk7CgkJfSBlbHNlIHsKCQkJc2VsZi5tZW51VHlwZSA9ICJvdmVybGF5IjsKCgkJCXNlbGYubGlzdGJveC5vbmUoIHsgcG9wdXBhZnRlcm9wZW46ICQucHJveHkoIHRoaXMsICJfZm9jdXNNZW51SXRlbSIgKSB9ICk7CgkJfQoJfSwKCglfYnVpbGRMaXN0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCXBsYWNlaG9sZGVyID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJbmVlZFBsYWNlaG9sZGVyID0gdHJ1ZSwKCQkJZGF0YUljb24gPSAiZmFsc2UiLAoJCQkkb3B0aW9ucywgbnVtT3B0aW9ucywgc2VsZWN0LAoJCQlkYXRhUHJlZml4ID0gImRhdGEtIiArICQubW9iaWxlLm5zLAoJCQlkYXRhSW5kZXhBdHRyID0gZGF0YVByZWZpeCArICJvcHRpb24taW5kZXgiLAoJCQlkYXRhSWNvbkF0dHIgPSBkYXRhUHJlZml4ICsgImljb24iLAoJCQlkYXRhUm9sZUF0dHIgPSBkYXRhUHJlZml4ICsgInJvbGUiLAoJCQlkYXRhUGxhY2Vob2xkZXJBdHRyID0gZGF0YVByZWZpeCArICJwbGFjZWhvbGRlciIsCgkJCWZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAoJCQlpc1BsYWNlaG9sZGVySXRlbSA9IGZhbHNlLAoJCQlvcHRHcm91cCwKCQkJaSwKCQkJb3B0aW9uLCAkb3B0aW9uLCBwYXJlbnQsIHRleHQsIGFuY2hvciwgY2xhc3NlcywKCQkJb3B0TGFiZWwsIGRpdmlkZXIsIGl0ZW07CgoJCXNlbGYubGlzdC5lbXB0eSgpLmZpbHRlciggIi51aS1saXN0dmlldyIgKS5saXN0dmlldyggImRlc3Ryb3kiICk7CgkJJG9wdGlvbnMgPSB0aGlzLl9zZWxlY3RPcHRpb25zKCk7CgkJbnVtT3B0aW9ucyA9ICRvcHRpb25zLmxlbmd0aDsKCQlzZWxlY3QgPSB0aGlzLnNlbGVjdFsgMCBdOwoKCQlmb3IgKCBpID0gMDsgaSA8IG51bU9wdGlvbnM7aSsrLCBpc1BsYWNlaG9sZGVySXRlbSA9IGZhbHNlKSB7CgkJCW9wdGlvbiA9ICRvcHRpb25zW2ldOwoJCQkkb3B0aW9uID0gJCggb3B0aW9uICk7CgoJCQkvLyBEbyBub3QgY3JlYXRlIG9wdGlvbnMgYmFzZWQgb24gdWktc2NyZWVuLWhpZGRlbiBzZWxlY3Qgb3B0aW9ucwoJCQlpZiAoICRvcHRpb24uaGFzQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApICkgewoJCQkJY29udGludWU7CgkJCX0KCgkJCXBhcmVudCA9IG9wdGlvbi5wYXJlbnROb2RlOwoJCQl0ZXh0ID0gJG9wdGlvbi50ZXh0KCk7CgkJCWFuY2hvciAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiYSIgKTsKCQkJY2xhc3NlcyA9IFtdOwoKCQkJYW5jaG9yLnNldEF0dHJpYnV0ZSggImhyZWYiLCAiIyIgKTsKCQkJYW5jaG9yLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggdGV4dCApICk7CgoJCQkvLyBBcmUgd2UgaW5zaWRlIGFuIG9wdGdyb3VwPwoJCQlpZiAoIHBhcmVudCAhPT0gc2VsZWN0ICYmIHBhcmVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAib3B0Z3JvdXAiICkgewoJCQkJb3B0TGFiZWwgPSBwYXJlbnQuZ2V0QXR0cmlidXRlKCAibGFiZWwiICk7CgkJCQlpZiAoIG9wdExhYmVsICE9PSBvcHRHcm91cCApIHsKCQkJCQlkaXZpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImxpIiApOwoJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCBkYXRhUm9sZUF0dHIsICJsaXN0LWRpdmlkZXIiICk7CgkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgIm9wdGlvbiIgKTsKCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggInRhYmluZGV4IiwgIi0xIiApOwoJCQkJCWRpdmlkZXIuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBvcHRMYWJlbCApICk7CgkJCQkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGRpdmlkZXIgKTsKCQkJCQlvcHRHcm91cCA9IG9wdExhYmVsOwoJCQkJfQoJCQl9CgoJCQlpZiAoIG5lZWRQbGFjZWhvbGRlciAmJiAoICFvcHRpb24uZ2V0QXR0cmlidXRlKCAidmFsdWUiICkgfHwgdGV4dC5sZW5ndGggPT09IDAgfHwgJG9wdGlvbi5qcW1EYXRhKCAicGxhY2Vob2xkZXIiICkgKSApIHsKCQkJCW5lZWRQbGFjZWhvbGRlciA9IGZhbHNlOwoJCQkJaXNQbGFjZWhvbGRlckl0ZW0gPSB0cnVlOwoKCQkJCS8vIElmIHdlIGhhdmUgaWRlbnRpZmllZCBhIHBsYWNlaG9sZGVyLCByZWNvcmQgdGhlIGZhY3QgdGhhdCBpdCB3YXMKCQkJCS8vIHVzIHdobyBoYXZlIGFkZGVkIHRoZSBwbGFjZWhvbGRlciB0byB0aGUgb3B0aW9uIGFuZCBtYXJrIGl0CgkJCQkvLyByZXRyb2FjdGl2ZWx5IGluIHRoZSBzZWxlY3QgYXMgd2VsbAoJCQkJaWYgKCBudWxsID09PSBvcHRpb24uZ2V0QXR0cmlidXRlKCBkYXRhUGxhY2Vob2xkZXJBdHRyICkgKSB7CgkJCQkJdGhpcy5fcmVtb3ZlUGxhY2Vob2xkZXJBdHRyID0gdHJ1ZTsKCQkJCX0KCQkJCW9wdGlvbi5zZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIsIHRydWUgKTsKCQkJCWlmICggby5oaWRlUGxhY2Vob2xkZXJNZW51SXRlbXMgKSB7CgkJCQkJY2xhc3Nlcy5wdXNoKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQkJCX0KCQkJCWlmICggcGxhY2Vob2xkZXIgIT09IHRleHQgKSB7CgkJCQkJcGxhY2Vob2xkZXIgPSBzZWxmLnBsYWNlaG9sZGVyID0gdGV4dDsKCQkJCX0KCQkJfQoKCQkJaXRlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJsaSIgKTsKCQkJaWYgKCBvcHRpb24uZGlzYWJsZWQgKSB7CgkJCQljbGFzc2VzLnB1c2goICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCAiYXJpYS1kaXNhYmxlZCIsIHRydWUgKTsKCQkJfQoJCQlpdGVtLnNldEF0dHJpYnV0ZSggZGF0YUluZGV4QXR0ciwgaSApOwoJCQlpdGVtLnNldEF0dHJpYnV0ZSggZGF0YUljb25BdHRyLCBkYXRhSWNvbiApOwoJCQlpZiAoIGlzUGxhY2Vob2xkZXJJdGVtICkgewoJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIsIHRydWUgKTsKCQkJfQoJCQlpdGVtLmNsYXNzTmFtZSA9IGNsYXNzZXMuam9pbiggIiAiICk7CgkJCWl0ZW0uc2V0QXR0cmlidXRlKCAicm9sZSIsICJvcHRpb24iICk7CgkJCWFuY2hvci5zZXRBdHRyaWJ1dGUoICJ0YWJpbmRleCIsICItMSIgKTsKCQkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCQkkKCBhbmNob3IgKS5hZGRDbGFzcyggInVpLWJ0biB1aS1jaGVja2JveC1vZmYgdWktYnRuLWljb24tbGVmdCIgKTsKCQkJfQoKCQkJaXRlbS5hcHBlbmRDaGlsZCggYW5jaG9yICk7CgkJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBpdGVtICk7CgkJfQoKCQlzZWxmLmxpc3RbMF0uYXBwZW5kQ2hpbGQoIGZyYWdtZW50ICk7CgoJCS8vIEhpZGUgaGVhZGVyIGlmIGl0J3Mgbm90IGEgbXVsdGlzZWxlY3QgYW5kIHRoZXJlJ3Mgbm8gcGxhY2Vob2xkZXIKCQlpZiAoICF0aGlzLmlzTXVsdGlwbGUgJiYgIXBsYWNlaG9sZGVyLmxlbmd0aCApIHsKCQkJdGhpcy5oZWFkZXIuYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0gZWxzZSB7CgkJCXRoaXMuaGVhZGVyVGl0bGUudGV4dCggdGhpcy5wbGFjZWhvbGRlciApOwoJCX0KCgkJLy8gTm93IHBvcHVsYXRlZCwgY3JlYXRlIGxpc3R2aWV3CgkJc2VsZi5saXN0Lmxpc3R2aWV3KCk7Cgl9LAoKCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLm9wdGlvbnMubmF0aXZlTWVudSA/CgkJCXRoaXMuX3N1cGVyKCkgOgoJCQkkKCAiPGE+IiwgewoJCQkJImhyZWYiOiAiIyIsCgkJCQkicm9sZSI6ICJidXR0b24iLAoJCQkJLy8gVE9ETyB2YWx1ZSBpcyB1bmRlZmluZWQgYXQgY3JlYXRpb24KCQkJCSJpZCI6IHRoaXMuYnV0dG9uSWQsCgkJCQkiYXJpYS1oYXNwb3B1cCI6ICJ0cnVlIiwKCgkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJImFyaWEtb3ducyI6IHRoaXMubWVudUlkCgkJCX0pOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgoJCWlmICggIXRoaXMub3B0aW9ucy5uYXRpdmVNZW51ICkgewoJCQl0aGlzLmNsb3NlKCk7CgoJCQkvLyBSZXN0b3JlIHRoZSB0YWJpbmRleCBhdHRyaWJ1dGUgdG8gaXRzIG9yaWdpbmFsIHZhbHVlCgkJCWlmICggdGhpcy5fb3JpZ1RhYkluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIHRoaXMuX29yaWdUYWJJbmRleCAhPT0gZmFsc2UgKSB7CgkJCQkJdGhpcy5zZWxlY3QuYXR0ciggInRhYmluZGV4IiwgdGhpcy5fb3JpZ1RhYkluZGV4ICk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuc2VsZWN0LnJlbW92ZUF0dHIoICJ0YWJpbmRleCIgKTsKCQkJCX0KCQkJfQoKCQkJLy8gUmVtb3ZlIHRoZSBwbGFjZWhvbGRlciBhdHRyaWJ1dGUgaWYgd2Ugd2VyZSB0aGUgb25lcyB0byBhZGQgaXQKCQkJaWYgKCB0aGlzLl9yZW1vdmVQbGFjZWhvbGRlckF0dHIgKSB7CgkJCQl0aGlzLl9zZWxlY3RPcHRpb25zKCkucmVtb3ZlQXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInBsYWNlaG9sZGVyIiApOwoJCQl9CgoJCQkvLyBSZW1vdmUgdGhlIHBvcHVwCgkJCXRoaXMubGlzdGJveC5yZW1vdmUoKTsKCgkJCS8vIFJlbW92ZSB0aGUgZGlhbG9nCgkJCXRoaXMubWVudVBhZ2UucmVtb3ZlKCk7CgkJfQoKCQkvLyBDaGFpbiB1cAoJCXRoaXMuX3N1cGVyKCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKCi8vIGJ1dHRvbk1hcmt1cCBpcyBkZXByZWNhdGVkIGFzIG9mIDEuNC4wIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gMS41LjAuCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgovLyBHZW5lcmFsIHBvbGljeTogRG8gbm90IGFjY2VzcyBkYXRhLSogYXR0cmlidXRlcyBleGNlcHQgZHVyaW5nIGVuaGFuY2VtZW50LgovLyBJbiBhbGwgb3RoZXIgY2FzZXMgd2UgZGV0ZXJtaW5lIHRoZSBzdGF0ZSBvZiB0aGUgYnV0dG9uIGV4Y2x1c2l2ZWx5IGZyb20gaXRzCi8vIGNsYXNzTmFtZS4gVGhhdCdzIHdoeSBvcHRpb25zVG9DbGFzc2VzIGV4cGVjdHMgYSBmdWxsIGNvbXBsZW1lbnQgb2Ygb3B0aW9ucywKLy8gYW5kIHRoZSBqUXVlcnkgcGx1Z2luIGNvbXBsZXRlcyB0aGUgc2V0IG9mIG9wdGlvbnMgZnJvbSB0aGUgZGVmYXVsdCB2YWx1ZXMuCgovLyBNYXAgY2xhc3NlcyB0byBidXR0b25NYXJrdXAgYm9vbGVhbiBvcHRpb25zIC0gdXNlZCBpbiBjbGFzc05hbWVUb09wdGlvbnMoKQp2YXIgcmV2ZXJzZUJvb2xPcHRpb25NYXAgPSB7CgkJInVpLXNoYWRvdyIgOiAic2hhZG93IiwKCQkidWktY29ybmVyLWFsbCIgOiAiY29ybmVycyIsCgkJInVpLWJ0bi1pbmxpbmUiIDogImlubGluZSIsCgkJInVpLXNoYWRvdy1pY29uIiA6ICJpY29uc2hhZG93IiwgLyogVE9ETzogUmVtb3ZlIGluIDEuNSAqLwoJCSJ1aS1taW5pIiA6ICJtaW5pIgoJfSwKCWdldEF0dHJGaXhlZCA9IGZ1bmN0aW9uKCkgewoJCXZhciByZXQgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoKCQlyZXR1cm4gKCByZXQgPT0gbnVsbCA/IHVuZGVmaW5lZCA6IHJldCApOwoJfSwKCWNhcGl0YWxMZXR0ZXJzUkUgPSAvW0EtWl0vZzsKCi8vIG9wdGlvbnNUb0NsYXNzZXM6Ci8vIEBvcHRpb25zOiBBIGNvbXBsZXRlIHNldCBvZiBvcHRpb25zIHRvIGNvbnZlcnQgdG8gY2xhc3MgbmFtZXMuCi8vIEBleGlzdGluZ0NsYXNzZXM6IGV4dHJhIGNsYXNzZXMgdG8gYWRkIHRvIHRoZSByZXN1bHQKLy8KLy8gQ29udmVydHMgQG9wdGlvbnMgdG8gYnV0dG9uTWFya3VwIGNsYXNzZXMgYW5kIHJldHVybnMgdGhlIHJlc3VsdCBhcyBhbiBhcnJheQovLyB0aGF0IGNhbiBiZSBjb252ZXJ0ZWQgdG8gYW4gZWxlbWVudCdzIGNsYXNzTmFtZSB3aXRoIC5qb2luKCAiICIgKS4gQWxsCi8vIHBvc3NpYmxlIG9wdGlvbnMgbXVzdCBiZSBzZXQgaW5zaWRlIEBvcHRpb25zLiBVc2UgJC5mbi5idXR0b25NYXJrdXAuZGVmYXVsdHMKLy8gdG8gZ2V0IGEgY29tcGxldGUgc2V0IGFuZCB1c2UgJC5leHRlbmQgdG8gb3ZlcnJpZGUgeW91ciBjaG9pY2Ugb2Ygb3B0aW9ucwovLyBmcm9tIHRoYXQgc2V0LgpmdW5jdGlvbiBvcHRpb25zVG9DbGFzc2VzKCBvcHRpb25zLCBleGlzdGluZ0NsYXNzZXMgKSB7Cgl2YXIgY2xhc3NlcyA9IGV4aXN0aW5nQ2xhc3NlcyA/IGV4aXN0aW5nQ2xhc3NlcyA6IFtdOwoKCS8vIEFkZCBjbGFzc2VzIHRvIHRoZSBhcnJheSAtIGZpcnN0IHVpLWJ0bgoJY2xhc3Nlcy5wdXNoKCAidWktYnRuIiApOwoKCS8vIElmIHRoZXJlIGlzIGEgdGhlbWUKCWlmICggb3B0aW9ucy50aGVtZSApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1idG4tIiArIG9wdGlvbnMudGhlbWUgKTsKCX0KCgkvLyBJZiB0aGVyZSdzIGFuIGljb24sIGFkZCB0aGUgaWNvbi1yZWxhdGVkIGNsYXNzZXMKCWlmICggb3B0aW9ucy5pY29uICkgewoJCWNsYXNzZXMgPSBjbGFzc2VzLmNvbmNhdChbCgkJCSJ1aS1pY29uLSIgKyBvcHRpb25zLmljb24sCgkJCSJ1aS1idG4taWNvbi0iICsgb3B0aW9ucy5pY29ucG9zCgkJXSk7CgkJaWYgKCBvcHRpb25zLmljb25zaGFkb3cgKSB7CgkJCWNsYXNzZXMucHVzaCggInVpLXNoYWRvdy1pY29uIiApOyAvKiBUT0RPOiBSZW1vdmUgaW4gMS41ICovCgkJfQoJfQoKCS8vIEFkZCB0aGUgYXBwcm9wcmlhdGUgY2xhc3MgZm9yIGVhY2ggYm9vbGVhbiBvcHRpb24KCWlmICggb3B0aW9ucy5pbmxpbmUgKSB7CgkJY2xhc3Nlcy5wdXNoKCAidWktYnRuLWlubGluZSIgKTsKCX0KCWlmICggb3B0aW9ucy5zaGFkb3cgKSB7CgkJY2xhc3Nlcy5wdXNoKCAidWktc2hhZG93IiApOwoJfQoJaWYgKCBvcHRpb25zLmNvcm5lcnMgKSB7CgkJY2xhc3Nlcy5wdXNoKCAidWktY29ybmVyLWFsbCIgKTsKCX0KCWlmICggb3B0aW9ucy5taW5pICkgewoJCWNsYXNzZXMucHVzaCggInVpLW1pbmkiICk7Cgl9CgoJLy8gQ3JlYXRlIGEgc3RyaW5nIGZyb20gdGhlIGFycmF5IGFuZCByZXR1cm4gaXQKCXJldHVybiBjbGFzc2VzOwp9CgovLyBjbGFzc05hbWVUb09wdGlvbnM6Ci8vIEBjbGFzc2VzOiBBIHN0cmluZyBjb250YWluaW5nIGEgLmNsYXNzTmFtZS1zdHlsZSBzcGFjZS1zZXBhcmF0ZWQgY2xhc3MgbGlzdAovLwovLyBMb29wcyBvdmVyIEBjbGFzc2VzIGFuZCBjYWxjdWxhdGVzIGFuIG9wdGlvbnMgb2JqZWN0IGJhc2VkIG9uIHRoZQovLyBidXR0b25NYXJrdXAtcmVsYXRlZCBjbGFzc2VzIGl0IGZpbmRzLiBJdCByZWNvcmRzIHVucmVjb2duaXplZCBjbGFzc2VzIGluIGFuCi8vIGFycmF5LgovLwovLyBSZXR1cm5zOiBBbiBvYmplY3QgY29udGFpbmluZyB0aGUgZm9sbG93aW5nIGl0ZW1zOgovLwovLyAib3B0aW9ucyI6IGJ1dHRvbk1hcmt1cCBvcHRpb25zIGZvdW5kIHRvIGJlIHByZXNlbnQgYmVjYXVzZSBvZiB0aGUKLy8gcHJlc2VuY2UvYWJzZW5jZSBvZiBjb3JyZXNwb25kaW5nIGNsYXNzZXMKLy8KLy8gInVua25vd25DbGFzc2VzIjogYSBzdHJpbmcgY29udGFpbmluZyBhbGwgdGhlIG5vbi1idXR0b25NYXJrdXAtcmVsYXRlZAovLyBjbGFzc2VzIGZvdW5kIGluIEBjbGFzc2VzCi8vCi8vICJhbHJlYWR5RW5oYW5jZWQiOiBBIGJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIHRoZSB1aS1idG4gY2xhc3Mgd2FzIGFtb25nCi8vIHRob3NlIGZvdW5kIHRvIGJlIHByZXNlbnQKZnVuY3Rpb24gY2xhc3NOYW1lVG9PcHRpb25zKCBjbGFzc2VzICkgewoJdmFyIGlkeCwgbWFwLCB1bmtub3duQ2xhc3MsCgkJYWxyZWFkeUVuaGFuY2VkID0gZmFsc2UsCgkJbm9JY29uID0gdHJ1ZSwKCQlvID0gewoJCQlpY29uOiAiIiwKCQkJaW5saW5lOiBmYWxzZSwKCQkJc2hhZG93OiBmYWxzZSwKCQkJY29ybmVyczogZmFsc2UsCgkJCWljb25zaGFkb3c6IGZhbHNlLAoJCQltaW5pOiBmYWxzZQoJCX0sCgkJdW5rbm93bkNsYXNzZXMgPSBbXTsKCgljbGFzc2VzID0gY2xhc3Nlcy5zcGxpdCggIiAiICk7CgoJLy8gTG9vcCBvdmVyIHRoZSBjbGFzc2VzCglmb3IgKCBpZHggPSAwIDsgaWR4IDwgY2xhc3Nlcy5sZW5ndGggOyBpZHgrKyApIHsKCgkJLy8gQXNzdW1lIGl0J3MgYW4gdW5yZWNvZ25pemVkIGNsYXNzCgkJdW5rbm93bkNsYXNzID0gdHJ1ZTsKCgkJLy8gUmVjb2duaXplIGJvb2xlYW4gb3B0aW9ucyBmcm9tIHRoZSBwcmVzZW5jZSBvZiBjbGFzc2VzCgkJbWFwID0gcmV2ZXJzZUJvb2xPcHRpb25NYXBbIGNsYXNzZXNbIGlkeCBdIF07CgkJaWYgKCBtYXAgIT09IHVuZGVmaW5lZCApIHsKCQkJdW5rbm93bkNsYXNzID0gZmFsc2U7CgkJCW9bIG1hcCBdID0gdHJ1ZTsKCgkJLy8gUmVjb2duaXplIHRoZSBwcmVzZW5jZSBvZiBhbiBpY29uIGFuZCBlc3RhYmxpc2ggdGhlIGljb24gcG9zaXRpb24KCQl9IGVsc2UgaWYgKCBjbGFzc2VzWyBpZHggXS5pbmRleE9mKCAidWktYnRuLWljb24tIiApID09PSAwICkgewoJCQl1bmtub3duQ2xhc3MgPSBmYWxzZTsKCQkJbm9JY29uID0gZmFsc2U7CgkJCW8uaWNvbnBvcyA9IGNsYXNzZXNbIGlkeCBdLnN1YnN0cmluZyggMTIgKTsKCgkJLy8gRXN0YWJsaXNoIHdoaWNoIGljb24gaXMgcHJlc2VudAoJCX0gZWxzZSBpZiAoIGNsYXNzZXNbIGlkeCBdLmluZGV4T2YoICJ1aS1pY29uLSIgKSA9PT0gMCApIHsKCQkJdW5rbm93bkNsYXNzID0gZmFsc2U7CgkJCW8uaWNvbiA9IGNsYXNzZXNbIGlkeCBdLnN1YnN0cmluZyggOCApOwoKCQkvLyBFc3RhYmxpc2ggdGhlIHRoZW1lIC0gdGhpcyByZWNvZ25pemVzIG9uZS1sZXR0ZXIgdGhlbWUgc3dhdGNoIG5hbWVzCgkJfSBlbHNlIGlmICggY2xhc3Nlc1sgaWR4IF0uaW5kZXhPZiggInVpLWJ0bi0iICkgPT09IDAgJiYgY2xhc3Nlc1sgaWR4IF0ubGVuZ3RoID09PSA4ICkgewoJCQl1bmtub3duQ2xhc3MgPSBmYWxzZTsKCQkJby50aGVtZSA9IGNsYXNzZXNbIGlkeCBdLnN1YnN0cmluZyggNyApOwoKCQkvLyBSZWNvZ25pemUgdGhhdCB0aGlzIGVsZW1lbnQgaGFzIGFscmVhZHkgYmVlbiBidXR0b25NYXJrdXAtZW5oYW5jZWQKCQl9IGVsc2UgaWYgKCBjbGFzc2VzWyBpZHggXSA9PT0gInVpLWJ0biIgKSB7CgkJCXVua25vd25DbGFzcyA9IGZhbHNlOwoJCQlhbHJlYWR5RW5oYW5jZWQgPSB0cnVlOwoJCX0KCgkJLy8gSWYgdGhpcyBjbGFzcyBoYXMgbm90IGJlZW4gcmVjb2duaXplZCwgYWRkIGl0IHRvIHRoZSBsaXN0CgkJaWYgKCB1bmtub3duQ2xhc3MgKSB7CgkJCXVua25vd25DbGFzc2VzLnB1c2goIGNsYXNzZXNbIGlkeCBdICk7CgkJfQoJfQoKCS8vIElmIGEgInVpLWJ0bi1pY29uLSoiIGljb24gcG9zaXRpb24gY2xhc3MgaXMgYWJzZW50IHRoZXJlIGNhbm5vdCBiZSBhbiBpY29uCglpZiAoIG5vSWNvbiApIHsKCQlvLmljb24gPSAiIjsKCX0KCglyZXR1cm4gewoJCW9wdGlvbnM6IG8sCgkJdW5rbm93bkNsYXNzZXM6IHVua25vd25DbGFzc2VzLAoJCWFscmVhZHlFbmhhbmNlZDogYWxyZWFkeUVuaGFuY2VkCgl9Owp9CgpmdW5jdGlvbiBjYW1lbENhc2UySHlwaGVuYXRlZCggYyApIHsKCXJldHVybiAiLSIgKyBjLnRvTG93ZXJDYXNlKCk7Cn0KCi8vICQuZm4uYnV0dG9uTWFya3VwOgovLyBET006IGdldHMvc2V0cyAuY2xhc3NOYW1lCi8vCi8vIEBvcHRpb25zOiBvcHRpb25zIHRvIGFwcGx5IHRvIHRoZSBlbGVtZW50cyBpbiB0aGUgalF1ZXJ5IG9iamVjdAovLyBAb3ZlcndyaXRlQ2xhc3NlczogYm9vbGVhbiBpbmRpY2F0aW5nIHdoZXRoZXIgdG8gaG9ub3VyIGV4aXN0aW5nIGNsYXNzZXMKLy8KLy8gQ2FsY3VsYXRlcyB0aGUgY2xhc3NlcyB0byBhcHBseSB0byB0aGUgZWxlbWVudHMgaW4gdGhlIGpRdWVyeSBvYmplY3QgYmFzZWQgb24KLy8gdGhlIG9wdGlvbnMgcGFzc2VkIGluLiBJZiBAb3ZlcndyaXRlQ2xhc3NlcyBpcyB0cnVlLCBpdCBzZXRzIHRoZSBjbGFzc05hbWUKLy8gcHJvcGVydHkgb2YgZWFjaCBlbGVtZW50IGluIHRoZSBqUXVlcnkgb2JqZWN0IHRvIHRoZSBidXR0b25NYXJrdXAgY2xhc3NlcwovLyBpdCBjYWxjdWxhdGVzIGJhc2VkIG9uIHRoZSBvcHRpb25zIHBhc3NlZCBpbi4KLy8KLy8gSWYgeW91IHdpc2ggdG8gcHJlc2VydmUgYW55IGNsYXNzZXMgdGhhdCBhcmUgYWxyZWFkeSBwcmVzZW50IG9uIHRoZSBlbGVtZW50cwovLyBpbnNpZGUgdGhlIGpRdWVyeSBvYmplY3QsIGluY2x1ZGluZyBidXR0b25NYXJrdXAtcmVsYXRlZCBjbGFzc2VzIHRoYXQgd2VyZQovLyBhZGRlZCBieSBhIHByZXZpb3VzIGNhbGwgdG8gJC5mbi5idXR0b25NYXJrdXAoKSBvciBkdXJpbmcgcGFnZSBlbmhhbmNlbWVudAovLyB0aGVuIHlvdSBzaG91bGQgb21pdCBAb3ZlcndyaXRlQ2xhc3NlcyBvciBzZXQgaXQgdG8gZmFsc2UuCiQuZm4uYnV0dG9uTWFya3VwID0gZnVuY3Rpb24oIG9wdGlvbnMsIG92ZXJ3cml0ZUNsYXNzZXMgKSB7Cgl2YXIgaWR4LCBkYXRhLCBlbCwgcmV0cmlldmVkT3B0aW9ucywgb3B0aW9uS2V5LAoJCWRlZmF1bHRzID0gJC5mbi5idXR0b25NYXJrdXAuZGVmYXVsdHM7CgoJZm9yICggaWR4ID0gMCA7IGlkeCA8IHRoaXMubGVuZ3RoIDsgaWR4KysgKSB7CgkJZWwgPSB0aGlzWyBpZHggXTsKCQlkYXRhID0gb3ZlcndyaXRlQ2xhc3NlcyA/CgoJCQkvLyBBc3N1bWUgdGhpcyBlbGVtZW50IGlzIG5vdCBlbmhhbmNlZCBhbmQgaWdub3JlIGl0cyBjbGFzc2VzCgkJCXsgYWxyZWFkeUVuaGFuY2VkOiBmYWxzZSwgdW5rbm93bkNsYXNzZXM6IFtdIH0gOgoKCQkJLy8gT3RoZXJ3aXNlIGFuYWx5emUgZXhpc3RpbmcgY2xhc3NlcyB0byBlc3RhYmxpc2ggZXhpc3Rpbmcgb3B0aW9ucyBhbmQKCQkJLy8gY2xhc3NlcwoJCQljbGFzc05hbWVUb09wdGlvbnMoIGVsLmNsYXNzTmFtZSApOwoKCQlyZXRyaWV2ZWRPcHRpb25zID0gJC5leHRlbmQoIHt9LAoKCQkJLy8gSWYgdGhlIGVsZW1lbnQgYWxyZWFkeSBoYXMgdGhlIGNsYXNzIHVpLWJ0biwgdGhlbiB3ZSBhc3N1bWUgdGhhdAoJCQkvLyBpdCBoYXMgcGFzc2VkIHRocm91Z2ggYnV0dG9uTWFya3VwIGJlZm9yZSAtIG90aGVyd2lzZSwgdGhlIG9wdGlvbnMKCQkJLy8gcmV0dXJuZWQgYnkgY2xhc3NOYW1lVG9PcHRpb25zIGRvIG5vdCBjb3JyZWN0bHkgcmVmbGVjdCB0aGUgc3RhdGUgb2YKCQkJLy8gdGhlIGVsZW1lbnQKCQkJKCBkYXRhLmFscmVhZHlFbmhhbmNlZCA/IGRhdGEub3B0aW9ucyA6IHt9ICksCgoJCQkvLyBGaW5hbGx5LCBhcHBseSB0aGUgb3B0aW9ucyBwYXNzZWQgaW4KCQkJb3B0aW9ucyApOwoKCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCBjYWxsIG9uIHRoaXMgZWxlbWVudCwgcmV0cmlldmUgcmVtYWluaW5nIG9wdGlvbnMKCQkvLyBmcm9tIHRoZSBkYXRhLWF0dHJpYnV0ZXMKCQlpZiAoICFkYXRhLmFscmVhZHlFbmhhbmNlZCApIHsKCQkJZm9yICggb3B0aW9uS2V5IGluIGRlZmF1bHRzICkgewoJCQkJaWYgKCByZXRyaWV2ZWRPcHRpb25zWyBvcHRpb25LZXkgXSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHJpZXZlZE9wdGlvbnNbIG9wdGlvbktleSBdID0gZ2V0QXR0ckZpeGVkKCBlbCwKCQkJCQkJb3B0aW9uS2V5LnJlcGxhY2UoIGNhcGl0YWxMZXR0ZXJzUkUsIGNhbWVsQ2FzZTJIeXBoZW5hdGVkICkKCQkJCQkpOwoJCQkJfQoJCQl9CgkJfQoKCQllbC5jbGFzc05hbWUgPSBvcHRpb25zVG9DbGFzc2VzKAoKCQkJLy8gTWVyZ2UgYWxsIHRoZSBvcHRpb25zIGFuZCBhcHBseSB0aGVtIGFzIGNsYXNzZXMKCQkJJC5leHRlbmQoIHt9LAoKCQkJCS8vIFRoZSBkZWZhdWx0cyBmb3JtIHRoZSBiYXNpcwoJCQkJZGVmYXVsdHMsCgoJCQkJLy8gQWRkIHRoZSBjb21wdXRlZCBvcHRpb25zCgkJCQlyZXRyaWV2ZWRPcHRpb25zCgkJCSksCgoJCQkvLyAuLi4gYW5kIHJlLWFwcGx5IGFueSB1bnJlY29nbml6ZWQgY2xhc3NlcyB0aGF0IHdlcmUgZm91bmQKCQkJZGF0YS51bmtub3duQ2xhc3NlcyApLmpvaW4oICIgIiApOwoJCWlmICggZWwudGFnTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAiYnV0dG9uIiApIHsKCQkJZWwuc2V0QXR0cmlidXRlKCAicm9sZSIsICJidXR0b24iICk7CgkJfQoJfQoKCXJldHVybiB0aGlzOwp9OwoKLy8gYnV0dG9uTWFya3VwIGRlZmF1bHRzLiBUaGlzIG11c3QgYmUgYSBjb21wbGV0ZSBzZXQsIGkuZS4sIGEgdmFsdWUgbXVzdCBiZQovLyBnaXZlbiBoZXJlIGZvciBhbGwgcmVjb2duaXplZCBvcHRpb25zCiQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzID0gewoJaWNvbjogIiIsCglpY29ucG9zOiAicmlnaHQiLAoJdGhlbWU6IG51bGwsCglpbmxpbmU6IGZhbHNlLAoJc2hhZG93OiB0cnVlLAoJY29ybmVyczogdHJ1ZSwKCWljb25zaGFkb3c6IGZhbHNlLCAvKiBUT0RPOiBSZW1vdmUgaW4gMS41LiBPcHRpb24gZGVwcmVjYXRlZCBpbiAxLjQuICovCgltaW5pOiBmYWxzZQp9OwoKJC5leHRlbmQoICQuZm4uYnV0dG9uTWFya3VwLCB7Cglpbml0U2VsZWN0b3I6ICJhOmpxbURhdGEocm9sZT0nYnV0dG9uJyksIC51aS1iYXIgPiBhLCAudWktYmFyID4gOmpxbURhdGEocm9sZT0nY29udHJvbGdyb3VwJykgPiBhLCBidXR0b24iCn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29udHJvbGdyb3VwIiwgJC5leHRlbmQoIHsKCW9wdGlvbnM6IHsKCQllbmhhbmNlZDogZmFsc2UsCgkJdGhlbWU6IG51bGwsCgkJc2hhZG93OiBmYWxzZSwKCQljb3JuZXJzOiB0cnVlLAoJCWV4Y2x1ZGVJbnZpc2libGU6IHRydWUsCgkJdHlwZTogInZlcnRpY2FsIiwKCQltaW5pOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJLy8gUnVuIGJ1dHRvbm1hcmt1cAoJCWlmICggJC5mbi5idXR0b25NYXJrdXAgKSB7CgkJCXRoaXMuZWxlbWVudC5maW5kKCAkLmZuLmJ1dHRvbk1hcmt1cC5pbml0U2VsZWN0b3IgKS5idXR0b25NYXJrdXAoKTsKCQl9CgkJLy8gRW5oYW5jZSBjaGlsZCB3aWRnZXRzCgkJJC5lYWNoKCB0aGlzLl9jaGlsZFdpZGdldHMsICQucHJveHkoIGZ1bmN0aW9uKCBudW1iZXIsIHdpZGdldE5hbWUgKSB7CgkJCWlmICggJC5tb2JpbGVbIHdpZGdldE5hbWUgXSApIHsKCQkJCXRoaXMuZWxlbWVudC5maW5kKCAkLm1vYmlsZVsgd2lkZ2V0TmFtZSBdLmluaXRTZWxlY3RvciApLm5vdCggJC5tb2JpbGUucGFnZS5wcm90b3R5cGUua2VlcE5hdGl2ZVNlbGVjdG9yKCkgKVsgd2lkZ2V0TmFtZSBdKCk7CgkJCX0KCQl9LCB0aGlzICkpOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfdWk6IG51bGwsCgkJCV9pbml0aWFsUmVmcmVzaDogdHJ1ZQoJCX0pOwoKCQlpZiAoIG9wdHMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX3VpID0gewoJCQkJZ3JvdXBMZWdlbmQ6IGVsZW0uY2hpbGRyZW4oICIudWktY29udHJvbGdyb3VwLWxhYmVsIiApLmNoaWxkcmVuKCksCgkJCQljaGlsZFdyYXBwZXI6IGVsZW0uY2hpbGRyZW4oICIudWktY29udHJvbGdyb3VwLWNvbnRyb2xzIiApCgkJCX07CgkJfSBlbHNlIHsKCQkJdGhpcy5fdWkgPSB0aGlzLl9lbmhhbmNlKCk7CgkJfQoKCX0sCgoJX2NoaWxkV2lkZ2V0czogWyAiY2hlY2tib3hyYWRpbyIsICJzZWxlY3RtZW51IiwgImJ1dHRvbiIgXSwKCglfdGhlbWVDbGFzc0Zyb21PcHRpb246IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlyZXR1cm4gKCB2YWx1ZSA/ICggdmFsdWUgPT09ICJub25lIiA/ICIiIDogInVpLWdyb3VwLXRoZW1lLSIgKyB2YWx1ZSApIDogIiIgKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQlvcHRzID0gdGhpcy5vcHRpb25zLAoJCQl1aSA9IHsKCQkJCWdyb3VwTGVnZW5kOiBlbGVtLmNoaWxkcmVuKCAibGVnZW5kIiApLAoJCQkJY2hpbGRXcmFwcGVyOiBlbGVtCgkJCQkJLmFkZENsYXNzKCAidWktY29udHJvbGdyb3VwICIgKwoJCQkJCQkidWktY29udHJvbGdyb3VwLSIgKwoJCQkJCQkJKCBvcHRzLnR5cGUgPT09ICJob3Jpem9udGFsIiA/ICJob3Jpem9udGFsIiA6ICJ2ZXJ0aWNhbCIgKSArICIgIiArCgkJCQkJCXRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCBvcHRzLnRoZW1lICkgKyAiICIgKwoJCQkJCQkoIG9wdHMuY29ybmVycyA/ICJ1aS1jb3JuZXItYWxsICIgOiAiIiApICsKCQkJCQkJKCBvcHRzLm1pbmkgPyAidWktbWluaSAiIDogIiIgKSApCgkJCQkJLndyYXBJbm5lciggIjxkaXYgIiArCgkJCQkJCSJjbGFzcz0ndWktY29udHJvbGdyb3VwLWNvbnRyb2xzICIgKwoJCQkJCQkJKCBvcHRzLnNoYWRvdyA9PT0gdHJ1ZSA/ICJ1aS1zaGFkb3ciIDogIiIgKSArICInPjwvZGl2PiIgKQoJCQkJCS5jaGlsZHJlbigpCgkJCX07CgoJCWlmICggdWkuZ3JvdXBMZWdlbmQubGVuZ3RoID4gMCApIHsKCQkJJCggIjxkaXYgcm9sZT0naGVhZGluZycgY2xhc3M9J3VpLWNvbnRyb2xncm91cC1sYWJlbCc+PC9kaXY+IiApCgkJCQkuYXBwZW5kKCB1aS5ncm91cExlZ2VuZCApCgkJCQkucHJlcGVuZFRvKCBlbGVtICk7CgkJfQoKCQlyZXR1cm4gdWk7Cgl9LAoKCV9pbml0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBjYWxsUmVmcmVzaCwgcmV0dXJuVmFsdWUsCgkJCWVsZW0gPSB0aGlzLmVsZW1lbnQ7CgoJCS8vIE11c3QgaGF2ZSBvbmUgb2YgaG9yaXpvbnRhbCBvciB2ZXJ0aWNhbAoJCWlmICggb3B0aW9ucy50eXBlICE9PSB1bmRlZmluZWQgKSB7CgkJCWVsZW0KCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvbnRyb2xncm91cC1ob3Jpem9udGFsIHVpLWNvbnRyb2xncm91cC12ZXJ0aWNhbCIgKQoJCQkJLmFkZENsYXNzKCAidWktY29udHJvbGdyb3VwLSIgKyAoIG9wdGlvbnMudHlwZSA9PT0gImhvcml6b250YWwiID8gImhvcml6b250YWwiIDogInZlcnRpY2FsIiApICk7CgkJCWNhbGxSZWZyZXNoID0gdHJ1ZTsKCQl9CgoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCB0aGlzLm9wdGlvbnMudGhlbWUgKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCBvcHRpb25zLnRoZW1lICkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCWVsZW0udG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtLnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIG9wdGlvbnMubWluaSApOwoJCX0KCgkJaWYgKCBvcHRpb25zLnNoYWRvdyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl91aS5jaGlsZFdyYXBwZXIudG9nZ2xlQ2xhc3MoICJ1aS1zaGFkb3ciLCBvcHRpb25zLnNoYWRvdyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmV4Y2x1ZGVJbnZpc2libGUgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5vcHRpb25zLmV4Y2x1ZGVJbnZpc2libGUgPSBvcHRpb25zLmV4Y2x1ZGVJbnZpc2libGU7CgkJCWNhbGxSZWZyZXNoID0gdHJ1ZTsKCQl9CgoJCXJldHVyblZhbHVlID0gdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJaWYgKCBjYWxsUmVmcmVzaCApIHsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJfQoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9LAoKCWNvbnRhaW5lcjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3VpLmNoaWxkV3JhcHBlcjsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuY29udGFpbmVyKCksCgkJCWVscyA9ICRlbC5maW5kKCAiLnVpLWJ0biIgKS5ub3QoICIudWktc2xpZGVyLWhhbmRsZSIgKSwKCQkJY3JlYXRlID0gdGhpcy5faW5pdGlhbFJlZnJlc2g7CgkJaWYgKCAkLm1vYmlsZS5jaGVja2JveHJhZGlvICkgewoJCQkkZWwuZmluZCggIjptb2JpbGUtY2hlY2tib3hyYWRpbyIgKS5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCQl9CgkJdGhpcy5fYWRkRmlyc3RMYXN0Q2xhc3NlcyggZWxzLAoJCQl0aGlzLm9wdGlvbnMuZXhjbHVkZUludmlzaWJsZSA/IHRoaXMuX2dldFZpc2libGVzKCBlbHMsIGNyZWF0ZSApIDogZWxzLAoJCQljcmVhdGUgKTsKCQl0aGlzLl9pbml0aWFsUmVmcmVzaCA9IGZhbHNlOwoJfSwKCgkvLyBDYXZlYXQ6IElmIHRoZSBsZWdlbmQgaXMgbm90IHRoZSBmaXJzdCBjaGlsZCBvZiB0aGUgY29udHJvbGdyb3VwIGF0IGVuaGFuY2UKCS8vIHRpbWUsIGl0IHdpbGwgYmUgYWZ0ZXIgX2Rlc3Ryb3koKS4KCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgdWksIGJ1dHRvbnMsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggb3B0cy5lbmhhbmNlZCApIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQl1aSA9IHRoaXMuX3VpOwoJCWJ1dHRvbnMgPSB0aGlzLmVsZW1lbnQKCQkJLnJlbW92ZUNsYXNzKCAidWktY29udHJvbGdyb3VwICIgKwoJCQkJInVpLWNvbnRyb2xncm91cC1ob3Jpem9udGFsIHVpLWNvbnRyb2xncm91cC12ZXJ0aWNhbCB1aS1jb3JuZXItYWxsIHVpLW1pbmkgIiArCgkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggb3B0cy50aGVtZSApICkKCQkJLmZpbmQoICIudWktYnRuIiApCgkJCS5ub3QoICIudWktc2xpZGVyLWhhbmRsZSIgKTsKCgkJdGhpcy5fcmVtb3ZlRmlyc3RMYXN0Q2xhc3NlcyggYnV0dG9ucyApOwoKCQl1aS5ncm91cExlZ2VuZC51bndyYXAoKTsKCQl1aS5jaGlsZFdyYXBwZXIuY2hpbGRyZW4oKS51bndyYXAoKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgKSApOwoKfSkoalF1ZXJ5KTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCSQud2lkZ2V0KCAibW9iaWxlLnRvb2xiYXIiLCB7CgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nZm9vdGVyJyksIDpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiwKCgkJb3B0aW9uczogewoJCQl0aGVtZTogbnVsbCwKCQkJYWRkQmFja0J0bjogZmFsc2UsCgkJCWJhY2tCdG5UaGVtZTogbnVsbCwKCQkJYmFja0J0blRleHQ6ICJCYWNrIgoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbGVmdGJ0biwgcmlnaHRidG4sCgkJCQlyb2xlID0gIHRoaXMuZWxlbWVudC5pcyggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApID8gImhlYWRlciIgOiAiZm9vdGVyIiwKCQkJCXBhZ2UgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICkgewoJCQkJcGFnZSA9IGZhbHNlOwoJCQkJdGhpcy5fb24oIHRoaXMuZG9jdW1lbnQsIHsKCQkJCQkicGFnZXNob3ciOiAicmVmcmVzaCIKCQkJCX0pOwoJCQl9CgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlyb2xlOiByb2xlLAoJCQkJcGFnZTogcGFnZSwKCQkJCWxlZnRidG46IGxlZnRidG4sCgkJCQlyaWdodGJ0bjogcmlnaHRidG4sCgkJCQliYWNrQnRuOiBudWxsCgkJCX0pOwoJCQl0aGlzLmVsZW1lbnQuYXR0ciggInJvbGUiLCByb2xlID09PSAiaGVhZGVyIiA/ICJiYW5uZXIiIDogImNvbnRlbnRpbmZvIiApLmFkZENsYXNzKCAidWktIiArIHJvbGUgKTsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJCXRoaXMuX3NldE9wdGlvbnMoIHRoaXMub3B0aW9ucyApOwoJCX0sCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvICkgewoJCQlpZiAoIG8uYWRkQmFja0J0biAhPT0gdW5kZWZpbmVkICkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuYWRkQmFja0J0biAmJgoJCQkJCXRoaXMucm9sZSA9PT0gImhlYWRlciIgJiYKCQkJCQkkKCAiLnVpLXBhZ2UiICkubGVuZ3RoID4gMSAmJgoJCQkJCXRoaXMucGFnZVsgMCBdLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIgKSAhPT0gJC5tb2JpbGUucGF0aC5zdHJpcEhhc2goIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJCSF0aGlzLmxlZnRidG4gKSB7CgkJCQkJCXRoaXMuX2FkZEJhY2tCdXR0b24oKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5lbGVtZW50LmZpbmQoICIudWktdG9vbGJhci1iYWNrLWJ0biIgKS5yZW1vdmUoKTsKCQkJCX0KCQkJfQoJCQlpZiAoIG8uYmFja0J0blRoZW1lICE9IG51bGwgKSB7CgkJCQl0aGlzLmVsZW1lbnQKCQkJCQkuZmluZCggIi51aS10b29sYmFyLWJhY2stYnRuIiApCgkJCQkJLmFkZENsYXNzKCAidWktYnRuIHVpLWJ0bi0iICsgby5iYWNrQnRuVGhlbWUgKTsKCQkJfQoJCQlpZiAoIG8uYmFja0J0blRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXRvb2xiYXItYmFjay1idG4gLnVpLWJ0bi10ZXh0IiApLnRleHQoIG8uYmFja0J0blRleHQgKTsKCQkJfQoJCQlpZiAoIG8udGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXZhciBjdXJyZW50VGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUgPyB0aGlzLm9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIsCgkJCQkJbmV3VGhlbWUgPSBvLnRoZW1lID8gby50aGVtZSA6ICJpbmhlcml0IjsKCgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1iYXItIiArIGN1cnJlbnRUaGVtZSApLmFkZENsYXNzKCAidWktYmFyLSIgKyBuZXdUaGVtZSApOwoJCQl9CgoJCQl0aGlzLl9zdXBlciggbyApOwoJCX0sCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy5yb2xlID09PSAiaGVhZGVyIiApIHsKCQkJCXRoaXMuX2FkZEhlYWRlckJ1dHRvbkNsYXNzZXMoKTsKCQkJfQoJCQlpZiAoICF0aGlzLnBhZ2UgKSB7CgkJCQl0aGlzLl9zZXRSZWxhdGl2ZSgpOwoJCQkJaWYgKCB0aGlzLnJvbGUgPT09ICJmb290ZXIiICkgewoJCQkJCXRoaXMuZWxlbWVudC5hcHBlbmRUbyggImJvZHkiICk7CgkJCQl9CgkJCX0KCQkJdGhpcy5fYWRkSGVhZGluZ0NsYXNzZXMoKTsKCQkJdGhpcy5fYnRuTWFya3VwKCk7CgkJfSwKCgkJLy93ZSBvbmx5IHdhbnQgdGhpcyB0byBydW4gb24gbm9uIGZpeGVkIHRvb2xiYXJzIHNvIG1ha2UgaXQgZWFzeSB0byBvdmVycmlkZQoJCV9zZXRSZWxhdGl2ZTogZnVuY3Rpb24oKSB7CgkJCSQoICJbZGF0YS0iKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJ10iICkuY3NzKHsgInBvc2l0aW9uIjogInJlbGF0aXZlIiB9KTsKCQl9LAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNC4gQXMgZnJvbSAxLjUgYnV0dG9uIGNsYXNzZXMgaGF2ZSB0byBiZSBwcmVzZW50IGluIHRoZSBtYXJrdXAuCgkJX2J0bk1hcmt1cDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5jaGlsZHJlbiggImEiICkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGUiLCAiYnV0dG9uIiApOwoJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggImNyZWF0ZSIgKTsKCQl9LAoJCS8vIERlcHJlY2F0ZWQgaW4gMS40LiBBcyBmcm9tIDEuNSB1aS1idG4tbGVmdC9yaWdodCBjbGFzc2VzIGhhdmUgdG8gYmUgcHJlc2VudCBpbiB0aGUgbWFya3VwLgoJCV9hZGRIZWFkZXJCdXR0b25DbGFzc2VzOiBmdW5jdGlvbigpIHsKCQkJdmFyICRoZWFkZXJhbmNob3JzID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiYSwgYnV0dG9uIiApOwoJCQl0aGlzLmxlZnRidG4gPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1sZWZ0IiApOwoJCQl0aGlzLnJpZ2h0YnRuID0gJGhlYWRlcmFuY2hvcnMuaGFzQ2xhc3MoICJ1aS1idG4tcmlnaHQiICk7CgoJCQl0aGlzLnJpZ2h0YnRuID0gdGhpcy5yaWdodGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMCApLm5vdCggIi51aS1idG4tbGVmdCIgKS5hZGRDbGFzcyggInVpLWJ0bi1yaWdodCIgKS5sZW5ndGg7CgoJCQl0aGlzLmxlZnRidG4gPSB0aGlzLmxlZnRidG4gfHwgJGhlYWRlcmFuY2hvcnMuZXEoIDEgKS5hZGRDbGFzcyggInVpLWJ0bi1sZWZ0IiApLmxlbmd0aDsKCgkJfSwKCQlfYWRkQmFja0J1dHRvbjogZnVuY3Rpb24oKSB7CgkJCXZhciB0aGVtZSwKCQkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCQlpZiAoICF0aGlzLmJhY2tCdG4gKSB7CgkJCQl0aGVtZSA9IG9wdGlvbnMuYmFja0J0blRoZW1lIHx8IG9wdGlvbnMudGhlbWU7CgkJCQl0aGlzLmJhY2tCdG4gPSAkKCAiPGEgcm9sZT0nYnV0dG9uJyBocmVmPSdqYXZhc2NyaXB0OnZvaWQoMCk7JyAiICsKCQkJCQkiY2xhc3M9J3VpLWJ0biB1aS1jb3JuZXItYWxsIHVpLXNoYWRvdyB1aS1idG4tcmlnaHQgIiArCgkJCQkJCSggdGhlbWUgPyAidWktYnRuLSIgKyB0aGVtZSArICIgIiA6ICIiICkgKwoJCQkJCQkidWktdG9vbGJhci1iYWNrLWJ0biB1aS1pY29uLWNhcmF0LXIgdWktYnRuLWljb24tcmlnaHQnICIgKwoJCQkJCSJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWw9J2JhY2snPiIgKyBvcHRpb25zLmJhY2tCdG5UZXh0ICsgIjwvYT4iICkKCQkJCQkJLnByZXBlbmRUbyggdGhpcy5lbGVtZW50ICk7CgkJCX0KCQl9LAoJCV9hZGRIZWFkaW5nQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5jaGlsZHJlbiggImgxLCBoMiwgaDMsIGg0LCBoNSwgaDYiICkKCQkJCS5hZGRDbGFzcyggInVpLXRpdGxlIiApCgkJCQkvLyBSZWdhcmRsZXNzIG9mIGggZWxlbWVudCBudW1iZXIgaW4gc3JjLCBpdCBiZWNvbWVzIGgxIGZvciB0aGUgZW5oYW5jZWQgcGFnZQoJCQkJLmF0dHIoewoJCQkJCSJyb2xlIjogImhlYWRpbmciLAoJCQkJCSJhcmlhLWxldmVsIjogIjEiCgkJCQl9KTsKCQl9Cgl9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCSQud2lkZ2V0KCAibW9iaWxlLnRvb2xiYXIiLCAkLm1vYmlsZS50b29sYmFyLCB7CgkJb3B0aW9uczogewoJCQlwb3NpdGlvbjpudWxsLAoJCQl2aXNpYmxlT25QYWdlU2hvdzogdHJ1ZSwKCQkJZGlzYWJsZVBhZ2Vab29tOiB0cnVlLAoJCQl0cmFuc2l0aW9uOiAic2xpZGUiLCAvL2NhbiBiZSBub25lLCBmYWRlLCBzbGlkZSAoc2xpZGUgbWFwcyB0byBzbGlkZXVwIG9yIHNsaWRlZG93bikKCQkJZnVsbHNjcmVlbjogZmFsc2UsCgkJCXRhcFRvZ2dsZTogdHJ1ZSwKCQkJdGFwVG9nZ2xlQmxhY2tsaXN0OiAiYSwgYnV0dG9uLCBpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSwgLnVpLWhlYWRlci1maXhlZCwgLnVpLWZvb3Rlci1maXhlZCwgLnVpLWZsaXBzd2l0Y2gsIC51aS1wb3B1cCwgLnVpLXBhbmVsLCAudWktcGFuZWwtZGlzbWlzcy1vcGVuIiwKCQkJaGlkZUR1cmluZ0ZvY3VzOiAiaW5wdXQsIHRleHRhcmVhLCBzZWxlY3QiLAoJCQl1cGRhdGVQYWdlUGFkZGluZzogdHJ1ZSwKCQkJdHJhY2tQZXJzaXN0ZW50VG9vbGJhcnM6IHRydWUsCgoJCQkvLyBCcm93c2VyIGRldGVjdGlvbiEgV2VlZWUsIGhlcmUgd2UgZ28uLi4KCQkJLy8gVW5mb3J0dW5hdGVseSwgcG9zaXRpb246Zml4ZWQgaXMgY29zdGx5LCBub3QgdG8gbWVudGlvbiBwcm9iYWJseSBpbXBvc3NpYmxlLCB0byBmZWF0dXJlLWRldGVjdCBhY2N1cmF0ZWx5LgoJCQkvLyBTb21lIHRlc3RzIGV4aXN0LCBidXQgdGhleSBjdXJyZW50bHkgcmV0dXJuIGZhbHNlIHJlc3VsdHMgaW4gY3JpdGljYWwgZGV2aWNlcyBhbmQgYnJvd3NlcnMsIHdoaWNoIGNvdWxkIGxlYWQgdG8gYSBicm9rZW4gZXhwZXJpZW5jZS4KCQkJLy8gVGVzdGluZyBmaXhlZCBwb3NpdGlvbmluZyBpcyBhbHNvIHByZXR0eSBvYnRydXNpdmUgdG8gcGFnZSBsb2FkLCByZXF1aXJpbmcgaW5qZWN0ZWQgZWxlbWVudHMgYW5kIHNjcm9sbGluZyB0aGUgd2luZG93CgkJCS8vIFRoZSBmb2xsb3dpbmcgZnVuY3Rpb24gc2VydmVzIHRvIHJ1bGUgb3V0IHNvbWUgcG9wdWxhciBicm93c2VycyB3aXRoIGtub3duIGZpeGVkLXBvc2l0aW9uaW5nIGlzc3VlcwoJCQkvLyBUaGlzIGlzIGEgcGx1Z2luIG9wdGlvbiBsaWtlIGFueSBvdGhlciwgc28gZmVlbCBmcmVlIHRvIGltcHJvdmUgb3Igb3ZlcndyaXRlIGl0CgkJCXN1cHBvcnRCbGFja2xpc3Q6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICEkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbjsKCQkJfQoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQlpZiAoIHRoaXMub3B0aW9ucy5wb3NpdGlvbiA9PT0gImZpeGVkIiAmJiAhdGhpcy5vcHRpb25zLnN1cHBvcnRCbGFja2xpc3QoKSApIHsKCQkJCXRoaXMuX21ha2VGaXhlZCgpOwoJCQl9CgkJfSwKCgkJX21ha2VGaXhlZDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLSIrIHRoaXMucm9sZSArIi1maXhlZCIgKTsKCQkJdGhpcy51cGRhdGVQYWdlUGFkZGluZygpOwoJCQl0aGlzLl9hZGRUcmFuc2l0aW9uQ2xhc3MoKTsKCQkJdGhpcy5fYmluZFBhZ2VFdmVudHMoKTsKCQkJdGhpcy5fYmluZFRvZ2dsZUhhbmRsZXJzKCk7CgkJCXRoaXMuX3NldE9wdGlvbnMoIHRoaXMub3B0aW9ucyApOwoJCX0sCgoJCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggbyApIHsKCQkJaWYgKCBvLnBvc2l0aW9uID09PSAiZml4ZWQiICYmIHRoaXMub3B0aW9ucy5wb3NpdGlvbiAhPT0gImZpeGVkIiApIHsKCQkJCXRoaXMuX21ha2VGaXhlZCgpOwoJCQl9CgkJCWlmICggdGhpcy5vcHRpb25zLnBvc2l0aW9uID09PSAiZml4ZWQiICYmICF0aGlzLm9wdGlvbnMuc3VwcG9ydEJsYWNrbGlzdCgpICkgewoJCQkJdmFyICRwYWdlID0gKCAhIXRoaXMucGFnZSApPyB0aGlzLnBhZ2U6ICggJCgiLnVpLXBhZ2UtYWN0aXZlIikubGVuZ3RoID4gMCApPyAkKCIudWktcGFnZS1hY3RpdmUiKTogJCgiLnVpLXBhZ2UiKS5lcSgwKTsKCgkJCQlpZiAoIG8uZnVsbHNjcmVlbiAhPT0gdW5kZWZpbmVkKSB7CgkJCQkJaWYgKCBvLmZ1bGxzY3JlZW4gKSB7CgkJCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLSIrIHRoaXMucm9sZSArIi1mdWxsc2NyZWVuIiApOwoJCQkJCQkkcGFnZS5hZGRDbGFzcyggInVpLXBhZ2UtIiArIHRoaXMucm9sZSArICItZnVsbHNjcmVlbiIgKTsKCQkJCQl9CgkJCQkJLy8gSWYgbm90IGZ1bGxzY3JlZW4sIGFkZCBjbGFzcyB0byBwYWdlIHRvIHNldCB0b3Agb3IgYm90dG9tIHBhZGRpbmcKCQkJCQllbHNlIHsKCQkJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktIisgdGhpcy5yb2xlICsiLWZ1bGxzY3JlZW4iICk7CgkJCQkJCSRwYWdlLnJlbW92ZUNsYXNzKCAidWktcGFnZS0iICsgdGhpcy5yb2xlICsgIi1mdWxsc2NyZWVuIiApLmFkZENsYXNzKCAidWktcGFnZS0iICsgdGhpcy5yb2xlKyAiLWZpeGVkIiApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQl0aGlzLl9zdXBlcihvKTsKCQl9LAoKCQlfYWRkVHJhbnNpdGlvbkNsYXNzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRjbGFzcyA9IHRoaXMub3B0aW9ucy50cmFuc2l0aW9uOwoKCQkJaWYgKCB0Y2xhc3MgJiYgdGNsYXNzICE9PSAibm9uZSIgKSB7CgkJCQkvLyB1c2UgYXBwcm9wcmlhdGUgc2xpZGUgZm9yIGhlYWRlciBvciBmb290ZXIKCQkJCWlmICggdGNsYXNzID09PSAic2xpZGUiICkgewoJCQkJCXRjbGFzcyA9IHRoaXMuZWxlbWVudC5oYXNDbGFzcyggInVpLWhlYWRlciIgKSA/ICJzbGlkZWRvd24iIDogInNsaWRldXAiOwoJCQkJfQoKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGNsYXNzICk7CgkJCX0KCQl9LAoKCQlfYmluZFBhZ2VFdmVudHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgcGFnZSA9ICggISF0aGlzLnBhZ2UgKT8gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTogdGhpcy5kb2N1bWVudDsKCQkJLy9wYWdlIGV2ZW50IGJpbmRpbmdzCgkJCS8vIEZpeGVkIHRvb2xiYXJzIHJlcXVpcmUgcGFnZSB6b29tIHRvIGJlIGRpc2FibGVkLCBvdGhlcndpc2UgdXNhYmlsaXR5IGlzc3VlcyBjcm9wIHVwCgkJCS8vIFRoaXMgbWV0aG9kIGlzIG1lYW50IHRvIGRpc2FibGUgem9vbSB3aGlsZSBhIGZpeGVkLXBvc2l0aW9uZWQgdG9vbGJhciBwYWdlIGlzIHZpc2libGUKCQkJdGhpcy5fb24oIHBhZ2UgLCB7CgkJCQkicGFnZWJlZm9yZXNob3ciOiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IiwKCQkJCSJ3ZWJraXRBbmltYXRpb25TdGFydCI6Il9oYW5kbGVBbmltYXRpb25TdGFydCIsCgkJCQkiYW5pbWF0aW9uc3RhcnQiOiJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInVwZGF0ZWxheW91dCI6ICJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInBhZ2VzaG93IjogIl9oYW5kbGVQYWdlU2hvdyIsCgkJCQkicGFnZWJlZm9yZWhpZGUiOiAiX2hhbmRsZVBhZ2VCZWZvcmVIaWRlIgoJCQl9KTsKCQl9LAoKCQlfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCApIHsKCQkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7CgkJCWlmICggby5kaXNhYmxlUGFnZVpvb20gKSB7CgkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCQlpZiAoICFvLnZpc2libGVPblBhZ2VTaG93ICkgewoJCQkJdGhpcy5oaWRlKCB0cnVlICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlQW5pbWF0aW9uU3RhcnQ6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHRoaXMub3B0aW9ucy51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCXRoaXMudXBkYXRlUGFnZVBhZGRpbmcoICggISF0aGlzLnBhZ2UgKT8gdGhpcy5wYWdlOiAiLnVpLXBhZ2UtYWN0aXZlIiApOwoJCQl9CgkJfSwKCgkJX2hhbmRsZVBhZ2VTaG93OiBmdW5jdGlvbigpIHsKCQkJdGhpcy51cGRhdGVQYWdlUGFkZGluZyggKCAhIXRoaXMucGFnZSApPyB0aGlzLnBhZ2U6ICIudWktcGFnZS1hY3RpdmUiICk7CgkJCWlmICggdGhpcy5vcHRpb25zLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7ICJ0aHJvdHRsZWRyZXNpemUiOiAidXBkYXRlUGFnZVBhZGRpbmciIH0gKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVQYWdlQmVmb3JlSGlkZTogZnVuY3Rpb24oIGUsIHVpICkgewoJCQl2YXIgbyA9IHRoaXMub3B0aW9ucywKCQkJCXRoaXNGb290ZXIsIHRoaXNIZWFkZXIsIG5leHRGb290ZXIsIG5leHRIZWFkZXI7CgoJCQlpZiAoIG8uZGlzYWJsZVBhZ2Vab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJfQoJCQlpZiAoIG8udXBkYXRlUGFnZVBhZGRpbmcgKSB7CgkJCQl0aGlzLl9vZmYoIHRoaXMud2luZG93LCAidGhyb3R0bGVkcmVzaXplIiApOwoJCQl9CgoJCQlpZiAoIG8udHJhY2tQZXJzaXN0ZW50VG9vbGJhcnMgKSB7CgkJCQl0aGlzRm9vdGVyID0gJCggIi51aS1mb290ZXItZml4ZWQ6anFtRGF0YShpZCkiLCB0aGlzLnBhZ2UgKTsKCQkJCXRoaXNIZWFkZXIgPSAkKCAiLnVpLWhlYWRlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMucGFnZSApOwoJCQkJbmV4dEZvb3RlciA9IHRoaXNGb290ZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktZm9vdGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzRm9vdGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpOwoJCQkJbmV4dEhlYWRlciA9IHRoaXNIZWFkZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzSGVhZGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpOwoKCQkJCWlmICggbmV4dEZvb3Rlci5sZW5ndGggfHwgbmV4dEhlYWRlci5sZW5ndGggKSB7CgoJCQkJCW5leHRGb290ZXIuYWRkKCBuZXh0SGVhZGVyICkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCQkJdWkubmV4dFBhZ2Uub25lKCAicGFnZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCQkJbmV4dEhlYWRlci5wcmVwZW5kVG8oIHRoaXMgKTsKCQkJCQkJbmV4dEZvb3Rlci5hcHBlbmRUbyggdGhpcyApOwoJCQkJCX0pOwoJCQkJfQoJCQl9CgkJfSwKCgkJX3Zpc2libGU6IHRydWUsCgoJCS8vIFRoaXMgd2lsbCBzZXQgdGhlIGNvbnRlbnQgZWxlbWVudCdzIHRvcCBvciBib3R0b20gcGFkZGluZyBlcXVhbCB0byB0aGUgdG9vbGJhcidzIGhlaWdodAoJCXVwZGF0ZVBhZ2VQYWRkaW5nOiBmdW5jdGlvbiggdGJQYWdlICkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gKCB0aGlzLnJvbGUgPT09ImhlYWRlciIgKSwKCQkJCXBvcyA9IHBhcnNlRmxvYXQoICRlbC5jc3MoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSApOwoKCQkJLy8gVGhpcyBiZWhhdmlvciBvbmx5IGFwcGxpZXMgdG8gImZpeGVkIiwgbm90ICJmdWxsc2NyZWVuIgoJCQlpZiAoIHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICkgeyByZXR1cm47IH0KCQkJLy8gdGJQYWdlIGFyZ3VtZW50IGNhbiBiZSBhIFBhZ2Ugb2JqZWN0IG9yIGFuIGV2ZW50LCBpZiBjb21pbmcgZnJvbSB0aHJvdHRsZWQgcmVzaXplLgoJCQl0YlBhZ2UgPSAoIHRiUGFnZSAmJiB0YlBhZ2UudHlwZSA9PT0gdW5kZWZpbmVkICYmIHRiUGFnZSApIHx8IHRoaXMucGFnZSB8fCAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCQl0YlBhZ2UgPSAoICEhdGhpcy5wYWdlICk/IHRoaXMucGFnZTogIi51aS1wYWdlLWFjdGl2ZSI7CgkJCSQoIHRiUGFnZSApLmNzcyggInBhZGRpbmctIiArICggaGVhZGVyID8gInRvcCIgOiAiYm90dG9tIiApLCAkZWwub3V0ZXJIZWlnaHQoKSArIHBvcyApOwoJCX0sCgoJCV91c2VUcmFuc2l0aW9uOiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgJHdpbiA9IHRoaXMud2luZG93LAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJc2Nyb2xsID0gJHdpbi5zY3JvbGxUb3AoKSwKCQkJCWVsSGVpZ2h0ID0gJGVsLmhlaWdodCgpLAoJCQkJcEhlaWdodCA9ICggISF0aGlzLnBhZ2UgKT8gJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5oZWlnaHQoKTokKCIudWktcGFnZS1hY3RpdmUiKS5oZWlnaHQoKSwKCQkJCXZpZXdwb3J0SGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCQlyZXR1cm4gIW5vdHJhbnNpdGlvbiAmJgoJCQkJKCB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiAmJiB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiAhPT0gIm5vbmUiICYmCgkJCQkoCgkJCQkJKCB0aGlzLnJvbGUgPT09ICJoZWFkZXIiICYmICF0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiAmJiBzY3JvbGwgPiBlbEhlaWdodCApIHx8CgkJCQkJKCB0aGlzLnJvbGUgPT09ICJmb290ZXIiICYmICF0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiAmJiBzY3JvbGwgKyB2aWV3cG9ydEhlaWdodCA8IHBIZWlnaHQgLSBlbEhlaWdodCApCgkJCQkpIHx8IHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuCgkJCQkpOwoJCX0sCgoJCXNob3c6IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKSB7CgkJCXZhciBoaWRlQ2xhc3MgPSAidWktZml4ZWQtaGlkZGVuIiwKCQkJCSRlbCA9IHRoaXMuZWxlbWVudDsKCgkJCWlmICggdGhpcy5fdXNlVHJhbnNpdGlvbiggbm90cmFuc2l0aW9uICkgKSB7CgkJCQkkZWwKCQkJCQkucmVtb3ZlQ2xhc3MoICJvdXQgIiArIGhpZGVDbGFzcyApCgkJCQkJLmFkZENsYXNzKCAiaW4iICkKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24gKCkgewoJCQkJCQkkZWwucmVtb3ZlQ2xhc3MoICJpbiIgKTsKCQkJCQl9KTsKCQkJfQoJCQllbHNlIHsKCQkJCSRlbC5yZW1vdmVDbGFzcyggaGlkZUNsYXNzICk7CgkJCX0KCQkJdGhpcy5fdmlzaWJsZSA9IHRydWU7CgkJfSwKCgkJaGlkZTogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyIGhpZGVDbGFzcyA9ICJ1aS1maXhlZC1oaWRkZW4iLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJLy8gaWYgaXQncyBhIHNsaWRlIHRyYW5zaXRpb24sIG91ciBuZXcgdHJhbnNpdGlvbnMgbmVlZCB0aGUgcmV2ZXJzZSBjbGFzcyBhcyB3ZWxsIHRvIHNsaWRlIG91dHdhcmQKCQkJCW91dGNsYXNzID0gIm91dCIgKyAoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uID09PSAic2xpZGUiID8gIiByZXZlcnNlIiA6ICIiICk7CgoJCQlpZiAoIHRoaXMuX3VzZVRyYW5zaXRpb24oIG5vdHJhbnNpdGlvbiApICkgewoJCQkJJGVsCgkJCQkJLmFkZENsYXNzKCBvdXRjbGFzcyApCgkJCQkJLnJlbW92ZUNsYXNzKCAiaW4iICkKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24oKSB7CgkJCQkJCSRlbC5hZGRDbGFzcyggaGlkZUNsYXNzICkucmVtb3ZlQ2xhc3MoIG91dGNsYXNzICk7CgkJCQkJfSk7CgkJCX0KCQkJZWxzZSB7CgkJCQkkZWwuYWRkQ2xhc3MoIGhpZGVDbGFzcyApLnJlbW92ZUNsYXNzKCBvdXRjbGFzcyApOwoJCQl9CgkJCXRoaXMuX3Zpc2libGUgPSBmYWxzZTsKCQl9LAoKCQl0b2dnbGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzWyB0aGlzLl92aXNpYmxlID8gImhpZGUiIDogInNob3ciIF0oKTsKCQl9LAoKCQlfYmluZFRvZ2dsZUhhbmRsZXJzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbyA9IHNlbGYub3B0aW9ucywKCQkJCWRlbGF5U2hvdywgZGVsYXlIaWRlLAoJCQkJaXNWaXNpYmxlID0gdHJ1ZSwKCQkJCXBhZ2UgPSAoICEhdGhpcy5wYWdlICk/IHRoaXMucGFnZTogJCgiLnVpLXBhZ2UiKTsKCgkJCS8vIHRhcCB0b2dnbGUKCQkJcGFnZQoJCQkJLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQkJCQlpZiAoIG8udGFwVG9nZ2xlICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoIG8udGFwVG9nZ2xlQmxhY2tsaXN0ICkubGVuZ3RoICkgewoJCQkJCQlzZWxmLnRvZ2dsZSgpOwoJCQkJCX0KCQkJCX0pCgkJCQkuYmluZCggImZvY3VzaW4gZm9jdXNvdXQiLCBmdW5jdGlvbiggZSApIHsKCQkJCQkvL3RoaXMgaGlkZXMgdGhlIHRvb2xiYXJzIG9uIGEga2V5Ym9hcmQgcG9wIHRvIGdpdmUgbW9yZSBzY3JlZW4gcm9vbSBhbmQgcHJldmVudCBpb3MgYnVnIHdoaWNoCgkJCQkJLy9wb3NpdGlvbnMgZml4ZWQgdG9vbGJhcnMgaW4gdGhlIG1pZGRsZSBvZiB0aGUgc2NyZWVuIG9uIHBvcCBpZiB0aGUgaW5wdXQgaXMgbmVhciB0aGUgdG9wIG9yCgkJCQkJLy9ib3R0b20gb2YgdGhlIHNjcmVlbiBhZGRyZXNzZXMgaXNzdWVzICM0NDEwIEZvb3RlciBuYXZiYXIgbW92ZXMgdXAgd2hlbiBjbGlja2luZyBvbiBhIHRleHRib3ggaW4gYW4gQW5kcm9pZCBlbnZpcm9ubWVudAoJCQkJCS8vYW5kIGlzc3VlICM0MTEzIEhlYWRlciBhbmQgZm9vdGVyIGNoYW5nZSB0aGVpciBwb3NpdGlvbiBhZnRlciBrZXlib2FyZCBwb3B1cCAtIGlPUwoJCQkJCS8vYW5kIGlzc3VlICM0NDEwIEZvb3RlciBuYXZiYXIgbW92ZXMgdXAgd2hlbiBjbGlja2luZyBvbiBhIHRleHRib3ggaW4gYW4gQW5kcm9pZCBlbnZpcm9ubWVudAoJCQkJCWlmICggc2NyZWVuLndpZHRoIDwgMTAyNSAmJiAkKCBlLnRhcmdldCApLmlzKCBvLmhpZGVEdXJpbmdGb2N1cyApICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoICIudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkIiApLmxlbmd0aCApIHsKCQkJCQkJLy9GaXggZm9yIGlzc3VlICM0NzI0IE1vdmluZyB0aHJvdWdoIGZvcm0gaW4gTW9iaWxlIFNhZmFyaSB3aXRoICJOZXh0IiBhbmQgIlByZXZpb3VzIiBzeXN0ZW0KCQkJCQkJLy9jb250cm9scyBjYXVzZXMgZml4ZWQgcG9zaXRpb24sIHRhcC10b2dnbGUgZmFsc2UgSGVhZGVyIHRvIHJldmVhbCBpdHNlbGYKCQkJCQkJLy8gaXNWaXNpYmxlIGluc3RlYWQgb2Ygc2VsZi5fdmlzaWJsZSBiZWNhdXNlIHRoZSBmb2N1c2luIGFuZCBmb2N1c291dCBldmVudHMgZmlyZSB0d2ljZSBhdCB0aGUgc2FtZSB0aW1lCgkJCQkJCS8vIEFsc28gdXNlIGEgZGVsYXkgZm9yIGhpZGluZyB0aGUgdG9vbGJhcnMgYmVjYXVzZSBvbiBBbmRyb2lkIG5hdGl2ZSBicm93c2VyIGZvY3VzaW4gaXMgZGlyZWNsdHkgZm9sbG93ZWQKCQkJCQkJLy8gYnkgYSBmb2N1c291dCB3aGVuIGEgbmF0aXZlIHNlbGVjdHMgb3BlbnMgYW5kIHRoZSBvdGhlciB3YXkgYXJvdW5kIHdoZW4gaXQgY2xvc2VzLgoJCQkJCQlpZiAoIGUudHlwZSA9PT0gImZvY3Vzb3V0IiAmJiAhaXNWaXNpYmxlICkgewoJCQkJCQkJaXNWaXNpYmxlID0gdHJ1ZTsKCQkJCQkJCS8vd2FpdCBmb3IgdGhlIHN0YWNrIHRvIHVud2luZCBhbmQgc2VlIGlmIHdlIGhhdmUganVtcGVkIHRvIGFub3RoZXIgaW5wdXQKCQkJCQkJCWNsZWFyVGltZW91dCggZGVsYXlIaWRlICk7CgkJCQkJCQlkZWxheVNob3cgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCQlzZWxmLnNob3coKTsKCQkJCQkJCX0sIDAgKTsKCQkJCQkJfSBlbHNlIGlmICggZS50eXBlID09PSAiZm9jdXNpbiIgJiYgISFpc1Zpc2libGUgKSB7CgkJCQkJCQkvL2lmIHdlIGhhdmUganVtcGVkIHRvIGFub3RoZXIgaW5wdXQgY2xlYXIgdGhlIHRpbWUgb3V0IHRvIGNhbmNlbCB0aGUgc2hvdy4KCQkJCQkJCWNsZWFyVGltZW91dCggZGVsYXlTaG93ICk7CgkJCQkJCQlpc1Zpc2libGUgPSBmYWxzZTsKCQkJCQkJCWRlbGF5SGlkZSA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJCXNlbGYuaGlkZSgpOwoJCQkJCQkJfSwgMCApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSk7CgkJfSwKCgkJX3NldFJlbGF0aXZlOiBmdW5jdGlvbigpIHsKCQkJaWYoIHRoaXMub3B0aW9ucy5wb3NpdGlvbiAhPT0gImZpeGVkIiApewoJCQkJJCggIltkYXRhLSIrICQubW9iaWxlLm5zICsgInJvbGU9J3BhZ2UnXSIgKS5jc3MoeyAicG9zaXRpb24iOiAicmVsYXRpdmUiIH0pOwoJCQl9CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gJGVsLmhhc0NsYXNzKCAidWktaGVhZGVyIiApOwoKCQkJJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5jc3MoICJwYWRkaW5nLSIgKyAoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSwgIiIgKTsKCQkJJGVsLnJlbW92ZUNsYXNzKCAidWktaGVhZGVyLWZpeGVkIHVpLWZvb3Rlci1maXhlZCB1aS1oZWFkZXItZnVsbHNjcmVlbiB1aS1mb290ZXItZnVsbHNjcmVlbiBpbiBvdXQgZmFkZSBzbGlkZWRvd24gc2xpZGV1cCB1aS1maXhlZC1oaWRkZW4iICk7CgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkucmVtb3ZlQ2xhc3MoICJ1aS1wYWdlLWhlYWRlci1maXhlZCB1aS1wYWdlLWZvb3Rlci1maXhlZCB1aS1wYWdlLWhlYWRlci1mdWxsc2NyZWVuIHVpLXBhZ2UtZm9vdGVyLWZ1bGxzY3JlZW4iICk7CgkJfQoKCX0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCSQud2lkZ2V0KCAibW9iaWxlLnRvb2xiYXIiLCAkLm1vYmlsZS50b29sYmFyLCB7CgoJCV9tYWtlRml4ZWQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQl0aGlzLl93b3JrYXJvdW5kcygpOwoJCX0sCgoJCS8vY2hlY2sgdGhlIGJyb3dzZXIgYW5kIHZlcnNpb24gYW5kIHJ1biBuZWVkZWQgd29ya2Fyb3VuZHMKCQlfd29ya2Fyb3VuZHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCQlwbGF0Zm9ybSA9IG5hdmlnYXRvci5wbGF0Zm9ybSwKCQkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XSspLyApLAoJCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCQlvcyA9IG51bGwsCgkJCXNlbGYgPSB0aGlzOwoJCQkvL3NldCB0aGUgb3Mgd2UgYXJlIHdvcmtpbmcgaW4gaWYgaXQgZG9zZW50IG1hdGNoIG9uZSB3aXRoIHdvcmthcm91bmRzIHJldHVybgoJCQlpZiAoIHBsYXRmb3JtLmluZGV4T2YoICJpUGhvbmUiICkgPiAtMSB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBhZCIgKSA+IC0xICB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBvZCIgKSA+IC0xICkgewoJCQkJb3MgPSAiaW9zIjsKCQkJfSBlbHNlIGlmICggdWEuaW5kZXhPZiggIkFuZHJvaWQiICkgPiAtMSApIHsKCQkJCW9zID0gImFuZHJvaWQiOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuOwoJCQl9CgkJCS8vY2hlY2sgb3MgdmVyc2lvbiBpZiBpdCBkb3NlbnQgbWF0Y2ggb25lIHdpdGggd29ya2Fyb3VuZHMgcmV0dXJuCgkJCWlmICggb3MgPT09ICJpb3MiICkgewoJCQkJLy9pT1MgIHdvcmthcm91bmRzCgkJCQlzZWxmLl9iaW5kU2Nyb2xsV29ya2Fyb3VuZCgpOwoJCQl9IGVsc2UgaWYgKCBvcyA9PT0gImFuZHJvaWQiICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKSB7CgkJCQkvL0FuZHJvaWQgMi4zIHJ1biBhbGwgQW5kcm9pZCAyLjMgd29ya2Fyb3VuZAoJCQkJc2VsZi5fYmluZFNjcm9sbFdvcmthcm91bmQoKTsKCQkJCXNlbGYuX2JpbmRMaXN0VGh1bWJXb3JrYXJvdW5kKCk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm47CgkJCX0KCQl9LAoKCQkvL1V0aWxpdHkgY2xhc3MgZm9yIGNoZWNraW5nIGhlYWRlciBhbmQgZm9vdGVyIHBvc2l0aW9ucyByZWxhdGl2ZSB0byB2aWV3cG9ydAoJCV92aWV3cG9ydE9mZnNldDogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQloZWFkZXIgPSAkZWwuaGFzQ2xhc3MoICJ1aS1oZWFkZXIiICksCgkJCQlvZmZzZXQgPSBNYXRoLmFicyggJGVsLm9mZnNldCgpLnRvcCAtIHRoaXMud2luZG93LnNjcm9sbFRvcCgpICk7CgkJCWlmICggIWhlYWRlciApIHsKCQkJCW9mZnNldCA9IE1hdGgucm91bmQoIG9mZnNldCAtIHRoaXMud2luZG93LmhlaWdodCgpICsgJGVsLm91dGVySGVpZ2h0KCkgKSAtIDYwOwoJCQl9CgkJCXJldHVybiBvZmZzZXQ7CgkJfSwKCgkJLy9iaW5kIGV2ZW50cyBmb3IgX3RyaWdnZXJSZWRyYXcoKSBmdW5jdGlvbgoJCV9iaW5kU2Nyb2xsV29ya2Fyb3VuZDogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJLy9iaW5kIHRvIHNjcm9sbHN0b3AgYW5kIGNoZWNrIGlmIHRoZSB0b29sYmFycyBhcmUgY29ycmVjdGx5IHBvc2l0aW9uZWQKCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7IHNjcm9sbHN0b3A6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHZpZXdwb3J0T2Zmc2V0ID0gc2VsZi5fdmlld3BvcnRPZmZzZXQoKTsKCQkJCS8vY2hlY2sgaWYgdGhlIGhlYWRlciBpcyB2aXNpYmxlIGFuZCBpZiBpdHMgaW4gdGhlIHJpZ2h0IHBsYWNlCgkJCQlpZiAoIHZpZXdwb3J0T2Zmc2V0ID4gMiAmJiBzZWxmLl92aXNpYmxlICkgewoJCQkJCXNlbGYuX3RyaWdnZXJSZWRyYXcoKTsKCQkJCX0KCQkJfX0pOwoJCX0sCgoJCS8vdGhpcyBhZGRyZXNzZXMgaXNzdWUgIzQyNTAgUGVyc2lzdGVudCBmb290ZXIgaW5zdGFiaWxpdHkgaW4gdjEuMSB3aXRoIGxvbmcgc2VsZWN0IGxpc3RzIGluIEFuZHJvaWQgMi4zLjMKCQkvL2FuZCBpc3N1ZSAjMzc0OCBBbmRyb2lkIDIueDogUGFnZSB0cmFuc2l0aW9ucyBicm9rZW4gd2hlbiBmaXhlZCB0b29sYmFycyB1c2VkCgkJLy90aGUgYWJzb2x1dGVseSBwb3NpdGlvbmVkIHRodW1ibmFpbCBpbiBhIGxpc3QgdmlldyBjYXVzZXMgcHJvYmxlbXMgd2l0aCBmaXhlZCBwb3NpdGlvbiBidXR0b25zIGFib3ZlIGluIGEgbmF2IGJhcgoJCS8vc2V0dGluZyB0aGUgbGkncyB0byAtd2Via2l0LXRyYW5zZm9ybTp0cmFuc2xhdGUzZCgwLDAsMCk7IHNvbHZlcyB0aGlzIHByb2JsZW0gdG8gYXZvaWRlIHBvdGVudGlhbCBpc3N1ZXMgaW4gb3RoZXIKCQkvL3BsYXRmb3JtcyB3ZSBzY29wZSB0aGlzIHdpdGggdGhlIGNsYXNzIHVpLWFuZHJvaWQtMngtZml4CgkJX2JpbmRMaXN0VGh1bWJXb3JrYXJvdW5kOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKS5hZGRDbGFzcyggInVpLWFuZHJvaWQtMngtZml4ZWQiICk7CgkJfSwKCQkvL3RoaXMgYWRkcmVzc2VzIGlzc3VlcyAjNDMzNyBGaXhlZCBoZWFkZXIgcHJvYmxlbSBhZnRlciBzY3JvbGxpbmcgY29udGVudCBvbiBpT1MgYW5kIEFuZHJvaWQKCQkvL2FuZCBkZXZpY2UgYnVncyBwcm9qZWN0IGlzc3VlICMxIEZvcm0gZWxlbWVudHMgY2FuIGxvc2UgY2xpY2sgaGl0IGFyZWEgaW4gcG9zaXRpb246IGZpeGVkIGNvbnRhaW5lcnMuCgkJLy90aGlzIGFsc28gYWRkcmVzc2VzIG5vdCBvbiBmaXhlZCB0b29sYmFycyBwYWdlIGluIGRvY3MKCQkvL2FkZGluZyAxcHggb2YgcGFkZGluZyB0byB0aGUgYm90dG9tIHRoZW4gcmVtb3ZpbmcgaXQgY2F1c2VzIGEgInJlZHJhdyIKCQkvL3doaWNoIHBvc2l0aW9ucyB0aGUgdG9vbGJhcnMgY29ycmVjdGx5ICh0aGV5IHdpbGwgYWx3YXlzIGJlIHZpc3VhbGx5IGNvcnJlY3QpCgkJX3RyaWdnZXJSZWRyYXc6IGZ1bmN0aW9uKCkgewoJCQl2YXIgcGFkZGluZ0JvdHRvbSA9IHBhcnNlRmxvYXQoICQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iICkgKTsKCQkJLy90cmlnZ2VyIHBhZ2UgcmVkcmF3IHRvIGZpeCBpbmNvcnJlY3RseSBwb3NpdGlvbmVkIGZpeGVkIGVsZW1lbnRzCgkJCSQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iLCAoIHBhZGRpbmdCb3R0b20gKyAxICkgKyAicHgiICk7CgkJCS8vaWYgdGhlIHBhZGRpbmcgaXMgcmVzZXQgd2l0aCBvdXQgYSB0aW1lb3V0IHRoZSByZXBvc2l0aW9uIHdpbGwgbm90IG9jY3VyZS4KCQkJLy90aGlzIGlzIGluZGVwZW5kYW50IG9mIEpRTSB0aGUgYnJvd3NlciBzZWVtcyB0byBuZWVkIHRoZSB0aW1lIHRvIHJlYWN0LgoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCSQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iLCBwYWRkaW5nQm90dG9tICsgInB4IiApOwoJCQl9LCAwICk7CgkJfSwKCgkJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJCS8vUmVtb3ZlIHRoZSBjbGFzcyB3ZSBhZGRlZCB0byB0aGUgcGFnZSBwcmV2aW91c2x5IGluIGFuZHJvaWQgMi54CgkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UtYWN0aXZlIiApLnJlbW92ZUNsYXNzKCAidWktYW5kcm9pZC0yeC1maXgiICk7CgkJfQoJfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIGllSGFjayA9ICggJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSAmJiAkLm1vYmlsZS5icm93c2VyLm9sZElFIDw9IDggKSwKCXVpVGVtcGxhdGUgPSAkKAoJCSI8ZGl2IGNsYXNzPSd1aS1wb3B1cC1hcnJvdy1ndWlkZSc+PC9kaXY+IiArCgkJIjxkaXYgY2xhc3M9J3VpLXBvcHVwLWFycm93LWNvbnRhaW5lciIgKyAoIGllSGFjayA/ICIgaWUiIDogIiIgKSArICInPiIgKwoJCQkiPGRpdiBjbGFzcz0ndWktcG9wdXAtYXJyb3cnPiIgKwoJCQkJIjxkaXYgY2xhc3M9J3VpLXBvcHVwLWFycm93LWJhY2tncm91bmQnPjwvZGl2PiIgKwoJCQkiPC9kaXY+IiArCgkJIjwvZGl2PiIKCSksCgkvLyBOZWVkZWQgZm9yIHRyYW5zZm9ybWluZyBjb29yZGluYXRlcyBmcm9tIHNjcmVlbiB0byBhcnJvdyBiYWNrZ3JvdW5kCgl0eEZhY3RvciA9IE1hdGguc3FydCggMiApIC8gMjsKCmZ1bmN0aW9uIGdldEFycm93KCkgewoJdmFyIGNsb25lID0gdWlUZW1wbGF0ZS5jbG9uZSgpLAoJCWdkID0gY2xvbmUuZXEoIDAgKSwKCQljdCA9IGNsb25lLmVxKCAxICksCgkJYXIgPSBjdC5jaGlsZHJlbigpLAoJCWJnID0gYXIuY2hpbGRyZW4oKTsKCglyZXR1cm4geyBhckVsczogY3QuYWRkKCBnZCApLCBnZDogZ2QsIGN0OiBjdCwgYXI6IGFyLCBiZzogYmcgfTsKfQoKJC53aWRnZXQoICJtb2JpbGUucG9wdXAiLCAkLm1vYmlsZS5wb3B1cCwgewoJb3B0aW9uczogewoKCQlhcnJvdzogIiIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGFyLAoJCQlyZXQgPSB0aGlzLl9zdXBlcigpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5hcnJvdyApIHsKCQkJdGhpcy5fdWkuYXJyb3cgPSBhciA9IHRoaXMuX2FkZEFycm93KCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglfYWRkQXJyb3c6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGVtZSwKCQkJb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJYXIgPSBnZXRBcnJvdygpOwoKCQl0aGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBvcHRzLnRoZW1lICk7CgkJYXIuYXIuYWRkQ2xhc3MoIHRoZW1lICsgKCBvcHRzLnNoYWRvdyA/ICIgdWktb3ZlcmxheS1zaGFkb3ciIDogIiIgKSApOwoJCWFyLmJnLmFkZENsYXNzKCB0aGVtZSApOwoJCWFyLmFyRWxzLmhpZGUoKS5hcHBlbmRUbyggdGhpcy5lbGVtZW50ICk7CgoJCXJldHVybiBhcjsKCX0sCgoJX3VuZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJdmFyIGFyID0gdGhpcy5fdWkuYXJyb3c7CgoJCWlmICggYXIgKSB7CgkJCWFyLmFyRWxzLnJlbW92ZSgpOwoJCX0KCgkJcmV0dXJuIHRoaXMuX3N1cGVyKCk7Cgl9LAoKCS8vIFByZXRlbmQgdG8gc2hvdyBhbiBhcnJvdyBkZXNjcmliZWQgYnkgQHAgYW5kIEBkaXIgYW5kIGNhbGN1bGF0ZSB0aGUKCS8vIGRpc3RhbmNlIGZyb20gdGhlIGRlc2lyZWQgcG9pbnQuIElmIGEgYmVzdC1kaXN0YW5jZSBpcyBwYXNzZWQgaW4sIHJldHVybgoJLy8gdGhlIG1pbmltdW0gb2YgdGhlIG9uZSBwYXNzZWQgaW4gYW5kIHRoZSBvbmUgY2FsY3VsYXRlZC4KCV90cnlBbkFycm93OiBmdW5jdGlvbiggcCwgZGlyLCBkZXNpcmVkLCBzLCBiZXN0ICkgewoJCXZhciByZXN1bHQsIHIsIGRpZmYsIGRlc2lyZWRGb3JBcnJvdyA9IHt9LCB0aXAgPSB7fTsKCgkJLy8gSWYgdGhlIGFycm93IGhhcyBubyB3aWdnbGUgcm9vbSBhbG9uZyB0aGUgZWRnZSBvZiB0aGUgcG9wdXAsIGl0IGNhbm5vdAoJCS8vIGJlIGRpc3BsYXllZCBhbG9uZyB0aGUgcmVxdWVzdGVkIGVkZ2Ugd2l0aG91dCBpdCBzdGlja2luZyBvdXQuCgkJaWYgKCBzLmFyRnVsbFsgcC5kaW1LZXkgXSA+IHMuZ3VpZGVEaW1zWyBwLmRpbUtleSBdICkgewoJCQlyZXR1cm4gYmVzdDsKCQl9CgoJCWRlc2lyZWRGb3JBcnJvd1sgcC5mc3QgXSA9IGRlc2lyZWRbIHAuZnN0IF0gKwoJCQkoIHMuYXJIYWxmWyBwLm9EaW1LZXkgXSArIHMubWVudUhhbGZbIHAub0RpbUtleSBdICkgKiBwLm9mZnNldEZhY3RvciAtCgkJCXMuY29udGVudEJveFsgcC5mc3QgXSArICggcy5jbGFtcEluZm8ubWVudVNpemVbIHAub0RpbUtleSBdIC0gcy5jb250ZW50Qm94WyBwLm9EaW1LZXkgXSApICogcC5hcnJvd09mZnNldEZhY3RvcjsKCQlkZXNpcmVkRm9yQXJyb3dbIHAuc25kIF0gPSBkZXNpcmVkWyBwLnNuZCBdOwoKCQlyZXN1bHQgPSBzLnJlc3VsdCB8fCB0aGlzLl9jYWxjdWxhdGVGaW5hbExvY2F0aW9uKCBkZXNpcmVkRm9yQXJyb3csIHMuY2xhbXBJbmZvICk7CgkJciA9IHsgeDogcmVzdWx0LmxlZnQsIHk6IHJlc3VsdC50b3AgfTsKCgkJdGlwWyBwLmZzdCBdID0gclsgcC5mc3QgXSArIHMuY29udGVudEJveFsgcC5mc3QgXSArIHAudGlwT2Zmc2V0OwoJCXRpcFsgcC5zbmQgXSA9IE1hdGgubWF4KCByZXN1bHRbIHAucHJvcCBdICsgcy5ndWlkZU9mZnNldFsgcC5wcm9wIF0gKyBzLmFySGFsZlsgcC5kaW1LZXkgXSwKCQkJTWF0aC5taW4oIHJlc3VsdFsgcC5wcm9wIF0gKyBzLmd1aWRlT2Zmc2V0WyBwLnByb3AgXSArIHMuZ3VpZGVEaW1zWyBwLmRpbUtleSBdIC0gcy5hckhhbGZbIHAuZGltS2V5IF0sCgkJCQlkZXNpcmVkWyBwLnNuZCBdICkgKTsKCgkJZGlmZiA9IE1hdGguYWJzKCBkZXNpcmVkLnggLSB0aXAueCApICsgTWF0aC5hYnMoIGRlc2lyZWQueSAtIHRpcC55ICk7CgkJaWYgKCAhYmVzdCB8fCBkaWZmIDwgYmVzdC5kaWZmICkgewoJCQkvLyBDb252ZXJ0IHRpcCBvZmZzZXQgdG8gY29vcmRpbmF0ZXMgaW5zaWRlIHRoZSBwb3B1cAoJCQl0aXBbIHAuc25kIF0gLT0gcy5hckhhbGZbIHAuZGltS2V5IF0gKyByZXN1bHRbIHAucHJvcCBdICsgcy5jb250ZW50Qm94WyBwLnNuZCBdOwoJCQliZXN0ID0geyBkaXI6IGRpciwgZGlmZjogZGlmZiwgcmVzdWx0OiByZXN1bHQsIHBvc1Byb3A6IHAucHJvcCwgcG9zVmFsOiB0aXBbIHAuc25kIF0gfTsKCQl9CgoJCXJldHVybiBiZXN0OwoJfSwKCglfZ2V0UGxhY2VtZW50U3RhdGU6IGZ1bmN0aW9uKCBjbGFtcCApIHsKCQl2YXIgb2Zmc2V0LCBnZE9mZnNldCwKCQkJYXIgPSB0aGlzLl91aS5hcnJvdywKCQkJc3RhdGUgPSB7CgkJCQljbGFtcEluZm86IHRoaXMuX2NsYW1wUG9wdXBXaWR0aCggIWNsYW1wICksCgkJCQlhckZ1bGw6IHsgY3g6IGFyLmN0LndpZHRoKCksIGN5OiBhci5jdC5oZWlnaHQoKSB9LAoJCQkJZ3VpZGVEaW1zOiB7IGN4OiBhci5nZC53aWR0aCgpLCBjeTogYXIuZ2QuaGVpZ2h0KCkgfSwKCQkJCWd1aWRlT2Zmc2V0OiBhci5nZC5vZmZzZXQoKQoJCQl9OwoKCQlvZmZzZXQgPSB0aGlzLmVsZW1lbnQub2Zmc2V0KCk7CgoJCWFyLmdkLmNzcyggeyBsZWZ0OiAwLCB0b3A6IDAsIHJpZ2h0OiAwLCBib3R0b206IDAgfSApOwoJCWdkT2Zmc2V0ID0gYXIuZ2Qub2Zmc2V0KCk7CgkJc3RhdGUuY29udGVudEJveCA9IHsKCQkJeDogZ2RPZmZzZXQubGVmdCAtIG9mZnNldC5sZWZ0LAoJCQl5OiBnZE9mZnNldC50b3AgLSBvZmZzZXQudG9wLAoJCQljeDogYXIuZ2Qud2lkdGgoKSwKCQkJY3k6IGFyLmdkLmhlaWdodCgpCgkJfTsKCQlhci5nZC5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgoJCS8vIFRoZSBhcnJvdyBib3ggbW92ZXMgYmV0d2VlbiBndWlkZU9mZnNldCBhbmQgZ3VpZGVPZmZzZXQgKyBndWlkZURpbXMgLSBhckZ1bGwKCQlzdGF0ZS5ndWlkZU9mZnNldCA9IHsgbGVmdDogc3RhdGUuZ3VpZGVPZmZzZXQubGVmdCAtIG9mZnNldC5sZWZ0LCB0b3A6IHN0YXRlLmd1aWRlT2Zmc2V0LnRvcCAtIG9mZnNldC50b3AgfTsKCQlzdGF0ZS5hckhhbGYgPSB7IGN4OiBzdGF0ZS5hckZ1bGwuY3ggLyAyLCBjeTogc3RhdGUuYXJGdWxsLmN5IC8gMiB9OwoJCXN0YXRlLm1lbnVIYWxmID0geyBjeDogc3RhdGUuY2xhbXBJbmZvLm1lbnVTaXplLmN4IC8gMiwgY3k6IHN0YXRlLmNsYW1wSW5mby5tZW51U2l6ZS5jeSAvIDIgfTsKCgkJcmV0dXJuIHN0YXRlOwoJfSwKCglfcGxhY2VtZW50Q29vcmRzOiBmdW5jdGlvbiggZGVzaXJlZCApIHsKCQl2YXIgc3RhdGUsIGJlc3QsIHBhcmFtcywgYmdPZmZzZXQsIGVsT2Zmc2V0LCBkaWZmLCBiZ1JlZiwKCQkJb3B0aW9uVmFsdWUgPSB0aGlzLm9wdGlvbnMuYXJyb3csCgkJCWFyID0gdGhpcy5fdWkuYXJyb3c7CgoJCWlmICggIWFyICkgewoJCQlyZXR1cm4gdGhpcy5fc3VwZXIoIGRlc2lyZWQgKTsKCQl9CgoJCWFyLmFyRWxzLnNob3coKTsKCgkJYmdSZWYgPSB7fTsKCQlzdGF0ZSA9IHRoaXMuX2dldFBsYWNlbWVudFN0YXRlKCB0cnVlICk7CgkJcGFyYW1zID0gewoJCQkibCI6IHsgZnN0OiAieCIsIHNuZDogInkiLCBwcm9wOiAidG9wIiwgZGltS2V5OiAiY3kiLCBvRGltS2V5OiAiY3giLCBvZmZzZXRGYWN0b3I6IDEsIHRpcE9mZnNldDogIC1zdGF0ZS5hckhhbGYuY3gsIGFycm93T2Zmc2V0RmFjdG9yOiAwIH0sCgkJCSJyIjogeyBmc3Q6ICJ4Iiwgc25kOiAieSIsIHByb3A6ICJ0b3AiLCBkaW1LZXk6ICJjeSIsIG9EaW1LZXk6ICJjeCIsIG9mZnNldEZhY3RvcjogLTEsIHRpcE9mZnNldDogc3RhdGUuYXJIYWxmLmN4ICsgc3RhdGUuY29udGVudEJveC5jeCwgYXJyb3dPZmZzZXRGYWN0b3I6IDEgfSwKCQkJImIiOiB7IGZzdDogInkiLCBzbmQ6ICJ4IiwgcHJvcDogImxlZnQiLCBkaW1LZXk6ICJjeCIsIG9EaW1LZXk6ICJjeSIsIG9mZnNldEZhY3RvcjogLTEsIHRpcE9mZnNldDogc3RhdGUuYXJIYWxmLmN5ICsgc3RhdGUuY29udGVudEJveC5jeSwgYXJyb3dPZmZzZXRGYWN0b3I6IDEgfSwKCQkJInQiOiB7IGZzdDogInkiLCBzbmQ6ICJ4IiwgcHJvcDogImxlZnQiLCBkaW1LZXk6ICJjeCIsIG9EaW1LZXk6ICJjeSIsIG9mZnNldEZhY3RvcjogMSwgdGlwT2Zmc2V0OiAtc3RhdGUuYXJIYWxmLmN5LCBhcnJvd09mZnNldEZhY3RvcjogMCB9CgkJfTsKCgkJLy8gVHJ5IGVhY2ggc2lkZSBzcGVjaWZpZWQgaW4gdGhlIG9wdGlvbnMgdG8gc2VlIG9uIHdoaWNoIG9uZSB0aGUgYXJyb3cKCQkvLyBzaG91bGQgYmUgcGxhY2VkIHN1Y2ggdGhhdCB0aGUgZGlzdGFuY2UgYmV0d2VlbiB0aGUgdGlwIG9mIHRoZSBhcnJvdyBhbmQKCQkvLyB0aGUgZGVzaXJlZCBjb29yZGluYXRlcyBpcyB0aGUgc2hvcnRlc3QuCgkJJC5lYWNoKCAoIG9wdGlvblZhbHVlID09PSB0cnVlID8gImwsdCxyLGIiIDogb3B0aW9uVmFsdWUgKS5zcGxpdCggIiwiICksCgkJCSQucHJveHkoIGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQkJYmVzdCA9IHRoaXMuX3RyeUFuQXJyb3coIHBhcmFtc1sgdmFsdWUgXSwgdmFsdWUsIGRlc2lyZWQsIHN0YXRlLCBiZXN0ICk7CgkJCX0sIHRoaXMgKSApOwoKCQkvLyBDb3VsZCBub3QgcGxhY2UgdGhlIGFycm93IGFsb25nIGFueSBvZiB0aGUgZWRnZXMgLSBiZWhhdmUgYXMgaWYgc2hvd2luZwoJCS8vIHRoZSBhcnJvdyB3YXMgdHVybmVkIG9mZi4KCQlpZiAoICFiZXN0ICkgewoJCQlhci5hckVscy5oaWRlKCk7CgkJCXJldHVybiB0aGlzLl9zdXBlciggZGVzaXJlZCApOwoJCX0KCgkJLy8gTW92ZSB0aGUgYXJyb3cgaW50byBwbGFjZQoJCWFyLmN0CgkJCS5yZW1vdmVDbGFzcyggInVpLXBvcHVwLWFycm93LWwgdWktcG9wdXAtYXJyb3ctdCB1aS1wb3B1cC1hcnJvdy1yIHVpLXBvcHVwLWFycm93LWIiICkKCQkJLmFkZENsYXNzKCAidWktcG9wdXAtYXJyb3ctIiArIGJlc3QuZGlyICkKCQkJLnJlbW92ZUF0dHIoICJzdHlsZSIgKS5jc3MoIGJlc3QucG9zUHJvcCwgYmVzdC5wb3NWYWwgKQoJCQkuc2hvdygpOwoKCQkvLyBEbyBub3QgbW92ZS9zaXplIHRoZSBiYWNrZ3JvdW5kIGRpdiBvbiBJRSwgYmVjYXVzZSB3ZSB1c2UgdGhlIGFycm93IGRpdiBmb3IgYmFja2dyb3VuZCBhcyB3ZWxsLgoJCWlmICggIWllSGFjayApIHsKCQkJZWxPZmZzZXQgPSB0aGlzLmVsZW1lbnQub2Zmc2V0KCk7CgkJCWJnUmVmWyBwYXJhbXNbIGJlc3QuZGlyIF0uZnN0IF0gPSBhci5jdC5vZmZzZXQoKTsKCQkJYmdSZWZbIHBhcmFtc1sgYmVzdC5kaXIgXS5zbmQgXSA9IHsKCQkJCWxlZnQ6IGVsT2Zmc2V0LmxlZnQgKyBzdGF0ZS5jb250ZW50Qm94LngsCgkJCQl0b3A6IGVsT2Zmc2V0LnRvcCArIHN0YXRlLmNvbnRlbnRCb3gueQoJCQl9OwoJCQliZ09mZnNldCA9IGFyLmJnCgkJCQkucmVtb3ZlQXR0ciggInN0eWxlIiApCgkJCQkuY3NzKCAoICJjeCIgPT09IHBhcmFtc1sgYmVzdC5kaXIgXS5kaW1LZXkgPyAid2lkdGgiIDogImhlaWdodCIgKSwgc3RhdGUuY29udGVudEJveFsgcGFyYW1zWyBiZXN0LmRpciBdLmRpbUtleSBdICkKCQkJCS5vZmZzZXQoKTsKCQkJZGlmZiA9IHsgZHg6IGJnUmVmLngubGVmdCAtIGJnT2Zmc2V0LmxlZnQsIGR5OiBiZ1JlZi55LnRvcCAtIGJnT2Zmc2V0LnRvcCB9OwoJCQlhci5iZy5jc3MoIHsgbGVmdDogdHhGYWN0b3IgKiBkaWZmLmR5ICsgdHhGYWN0b3IgKiBkaWZmLmR4LCB0b3A6IHR4RmFjdG9yICogZGlmZi5keSAtIHR4RmFjdG9yICogZGlmZi5keCB9ICk7CgkJfQoKCQlyZXR1cm4gYmVzdC5yZXN1bHQ7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0cyApIHsKCQl2YXIgbmV3VGhlbWUsCgkJCW9sZFRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lLAoJCQlhciA9IHRoaXMuX3VpLmFycm93LAoJCQlyZXQgPSB0aGlzLl9zdXBlciggb3B0cyApOwoKCQlpZiAoIG9wdHMuYXJyb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCAhYXIgJiYgb3B0cy5hcnJvdyApIHsKCQkJCXRoaXMuX3VpLmFycm93ID0gdGhpcy5fYWRkQXJyb3coKTsKCgkJCQkvLyBJbXBvcnRhbnQgdG8gcmV0dXJuIGhlcmUgc28gd2UgZG9uJ3Qgc2V0IHRoZSBzYW1lIG9wdGlvbnMgYWxsIG92ZXIKCQkJCS8vIGFnYWluIGJlbG93LgoJCQkJcmV0dXJuOwoJCQl9IGVsc2UgaWYgKCBhciAmJiAhb3B0cy5hcnJvdyApIHsKCQkJCWFyLmFyRWxzLnJlbW92ZSgpOwoJCQkJdGhpcy5fdWkuYXJyb3cgPSBudWxsOwoJCQl9CgkJfQoKCQkvLyBSZWFzc2lnbiB3aXRoIHBvdGVudGlhbGx5IG5ldyBhcnJvdwoJCWFyID0gdGhpcy5fdWkuYXJyb3c7CgoJCWlmICggYXIgKSB7CgkJCWlmICggb3B0cy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJb2xkVGhlbWUgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgb2xkVGhlbWUgKTsKCQkJCW5ld1RoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMudGhlbWUgKTsKCQkJCWFyLmFyLnJlbW92ZUNsYXNzKCBvbGRUaGVtZSApLmFkZENsYXNzKCBuZXdUaGVtZSApOwoJCQkJYXIuYmcucmVtb3ZlQ2xhc3MoIG9sZFRoZW1lICkuYWRkQ2xhc3MoIG5ld1RoZW1lICk7CgkJCX0KCgkJCWlmICggb3B0cy5zaGFkb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJCWFyLmFyLnRvZ2dsZUNsYXNzKCAidWktb3ZlcmxheS1zaGFkb3ciLCBvcHRzLnNoYWRvdyApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIGFyID0gdGhpcy5fdWkuYXJyb3c7CgoJCWlmICggYXIgKSB7CgkJCWFyLmFyRWxzLnJlbW92ZSgpOwoJCX0KCgkJcmV0dXJuIHRoaXMuX3N1cGVyKCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUucGFuZWwiLCB7CglvcHRpb25zOiB7CgkJY2xhc3NlczogewoJCQlwYW5lbDogInVpLXBhbmVsIiwKCQkJcGFuZWxPcGVuOiAidWktcGFuZWwtb3BlbiIsCgkJCXBhbmVsQ2xvc2VkOiAidWktcGFuZWwtY2xvc2VkIiwKCQkJcGFuZWxGaXhlZDogInVpLXBhbmVsLWZpeGVkIiwKCQkJcGFuZWxJbm5lcjogInVpLXBhbmVsLWlubmVyIiwKCQkJbW9kYWw6ICJ1aS1wYW5lbC1kaXNtaXNzIiwKCQkJbW9kYWxPcGVuOiAidWktcGFuZWwtZGlzbWlzcy1vcGVuIiwKCQkJcGFnZUNvbnRhaW5lcjogInVpLXBhbmVsLXBhZ2UtY29udGFpbmVyIiwKCQkJcGFnZVdyYXBwZXI6ICJ1aS1wYW5lbC13cmFwcGVyIiwKCQkJcGFnZUZpeGVkVG9vbGJhcjogInVpLXBhbmVsLWZpeGVkLXRvb2xiYXIiLAoJCQlwYWdlQ29udGVudFByZWZpeDogInVpLXBhbmVsLXBhZ2UtY29udGVudCIsIC8qIFVzZWQgZm9yIHdyYXBwZXIgYW5kIGZpeGVkIHRvb2xiYXJzIHBvc2l0aW9uLCBkaXNwbGF5IGFuZCBvcGVuIGNsYXNzZXMuICovCgkJCWFuaW1hdGU6ICJ1aS1wYW5lbC1hbmltYXRlIgoJCX0sCgkJYW5pbWF0ZTogdHJ1ZSwKCQl0aGVtZTogbnVsbCwKCQlwb3NpdGlvbjogImxlZnQiLAoJCWRpc21pc3NpYmxlOiB0cnVlLAoJCWRpc3BsYXk6ICJyZXZlYWwiLCAvL2FjY2VwdHMgcmV2ZWFsLCBwdXNoLCBvdmVybGF5CgkJc3dpcGVDbG9zZTogdHJ1ZSwKCQlwb3NpdGlvbkZpeGVkOiBmYWxzZQoJfSwKCglfcGFuZWxJRDogbnVsbCwKCV9jbG9zZUxpbms6IG51bGwsCglfcGFyZW50UGFnZTogbnVsbCwKCV9wYWdlOiBudWxsLAoJX21vZGFsOiBudWxsLAoJX3BhbmVsSW5uZXI6IG51bGwsCglfd3JhcHBlcjogbnVsbCwKCV9maXhlZFRvb2xiYXJzOiBudWxsLAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBlbCA9IHRoaXMuZWxlbWVudCwKCQkJcGFyZW50UGFnZSA9IGVsLmNsb3Nlc3QoICI6anFtRGF0YShyb2xlPSdwYWdlJykiICk7CgoJCS8vIGV4cG9zZSBzb21lIHByaXZhdGUgcHJvcHMgdG8gb3RoZXIgbWV0aG9kcwoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9wYW5lbElEOiBlbC5hdHRyKCAiaWQiICksCgkJCV9jbG9zZUxpbms6IGVsLmZpbmQoICI6anFtRGF0YShyZWw9J2Nsb3NlJykiICksCgkJCV9wYXJlbnRQYWdlOiAoIHBhcmVudFBhZ2UubGVuZ3RoID4gMCApID8gcGFyZW50UGFnZSA6IGZhbHNlLAoJCQlfcGFnZTogdGhpcy5fZ2V0UGFnZSwKCQkJX3BhbmVsSW5uZXI6IHRoaXMuX2dldFBhbmVsSW5uZXIoKSwKCQkJX3dyYXBwZXI6IHRoaXMuX2dldFdyYXBwZXIsCgkJCV9maXhlZFRvb2xiYXJzOiB0aGlzLl9nZXRGaXhlZFRvb2xiYXJzCgkJfSk7CgoJCXRoaXMuX2FkZFBhbmVsQ2xhc3NlcygpOwoKCQkvLyBpZiBhbmltYXRpbmcsIGFkZCB0aGUgY2xhc3MgdG8gZG8gc28KCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIXRoaXMub3B0aW9ucy5hbmltYXRlICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLmFuaW1hdGUgKTsKCQl9CgoJCXRoaXMuX2JpbmRVcGRhdGVMYXlvdXQoKTsKCQl0aGlzLl9iaW5kQ2xvc2VFdmVudHMoKTsKCQl0aGlzLl9iaW5kTGlua0xpc3RlbmVycygpOwoJCXRoaXMuX2JpbmRQYWdlRXZlbnRzKCk7CgoJCWlmICggISF0aGlzLm9wdGlvbnMuZGlzbWlzc2libGUgKSB7CgkJCXRoaXMuX2NyZWF0ZU1vZGFsKCk7CgkJfQoKCQl0aGlzLl9iaW5kU3dpcGVFdmVudHMoKTsKCX0sCgoJX2dldFBhbmVsSW5uZXI6IGZ1bmN0aW9uKCkgewoJCXZhciBwYW5lbElubmVyID0gdGhpcy5lbGVtZW50LmZpbmQoICIuIiArIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsSW5uZXIgKTsKCgkJaWYgKCBwYW5lbElubmVyLmxlbmd0aCA9PT0gMCApIHsKCQkJcGFuZWxJbm5lciA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbigpLndyYXBBbGwoICI8ZGl2IGNsYXNzPSciICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxJbm5lciArICInIC8+IiApLnBhcmVudCgpOwoJCX0KCgkJcmV0dXJuIHBhbmVsSW5uZXI7Cgl9LAoKCV9jcmVhdGVNb2RhbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQl0YXJnZXQgPSBzZWxmLl9wYXJlbnRQYWdlID8gc2VsZi5fcGFyZW50UGFnZS5wYXJlbnQoKSA6IHNlbGYuZWxlbWVudC5wYXJlbnQoKTsKCgkJc2VsZi5fbW9kYWwgPSAkKCAiPGRpdiBjbGFzcz0nIiArIHNlbGYub3B0aW9ucy5jbGFzc2VzLm1vZGFsICsgIicgZGF0YS1wYW5lbGlkPSciICsgc2VsZi5fcGFuZWxJRCArICInPjwvZGl2PiIgKQoJCQkub24oICJtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuY2xvc2UoKTsKCQkJfSkKCQkJLmFwcGVuZFRvKCB0YXJnZXQgKTsKCX0sCgoJX2dldFBhZ2U6IGZ1bmN0aW9uKCkgewoJCXZhciBwYWdlID0gdGhpcy5fcGFyZW50UGFnZSA/IHRoaXMuX3BhcmVudFBhZ2UgOiAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKTsKCgkJcmV0dXJuIHBhZ2U7Cgl9LAoKCV9nZXRXcmFwcGVyOiBmdW5jdGlvbigpIHsKCQl2YXIgd3JhcHBlciA9IHRoaXMuX3BhZ2UoKS5maW5kKCAiLiIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYWdlV3JhcHBlciApOwoKCQlpZiAoIHdyYXBwZXIubGVuZ3RoID09PSAwICkgewoJCQl3cmFwcGVyID0gdGhpcy5fcGFnZSgpLmNoaWxkcmVuKCAiLnVpLWhlYWRlcjpub3QoLnVpLWhlYWRlci1maXhlZCksIC51aS1jb250ZW50Om5vdCgudWktcG9wdXApLCAudWktZm9vdGVyOm5vdCgudWktZm9vdGVyLWZpeGVkKSIgKQoJCQkJLndyYXBBbGwoICI8ZGl2IGNsYXNzPSciICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFnZVdyYXBwZXIgKyAiJz48L2Rpdj4iICkKCQkJCS5wYXJlbnQoKTsKCQl9CgoJCXJldHVybiB3cmFwcGVyOwoJfSwKCglfZ2V0Rml4ZWRUb29sYmFyczogZnVuY3Rpb24oKSB7CgkJdmFyIGV4dEZpeGVkVG9vbGJhcnMgPSAkKCAiYm9keSIgKS5jaGlsZHJlbiggIi51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQiICksCgkJCWludEZpeGVkVG9vbGJhcnMgPSB0aGlzLl9wYWdlKCkuZmluZCggIi51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQiICksCgkJCWZpeGVkVG9vbGJhcnMgPSBleHRGaXhlZFRvb2xiYXJzLmFkZCggaW50Rml4ZWRUb29sYmFycyApLmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYWdlRml4ZWRUb29sYmFyICk7CgoJCXJldHVybiBmaXhlZFRvb2xiYXJzOwoJfSwKCglfZ2V0UG9zRGlzcGxheUNsYXNzZXM6IGZ1bmN0aW9uKCBwcmVmaXggKSB7CgkJcmV0dXJuIHByZWZpeCArICItcG9zaXRpb24tIiArIHRoaXMub3B0aW9ucy5wb3NpdGlvbiArICIgIiArIHByZWZpeCArICItZGlzcGxheS0iICsgdGhpcy5vcHRpb25zLmRpc3BsYXk7Cgl9LAoKCV9nZXRQYW5lbENsYXNzZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBwYW5lbENsYXNzZXMgPSB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbCArCgkJCSIgIiArIHRoaXMuX2dldFBvc0Rpc3BsYXlDbGFzc2VzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbCApICsKCQkJIiAiICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxDbG9zZWQgKwoJCQkiICIgKyAidWktYm9keS0iICsgKCB0aGlzLm9wdGlvbnMudGhlbWUgPyB0aGlzLm9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIgKTsKCgkJaWYgKCAhIXRoaXMub3B0aW9ucy5wb3NpdGlvbkZpeGVkICkgewoJCQlwYW5lbENsYXNzZXMgKz0gIiAiICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxGaXhlZDsKCQl9CgoJCXJldHVybiBwYW5lbENsYXNzZXM7Cgl9LAoKCV9hZGRQYW5lbENsYXNzZXM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5fZ2V0UGFuZWxDbGFzc2VzKCkgKTsKCX0sCgoJX2JpbmRDbG9zZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZWxmLl9jbG9zZUxpbmsub24oICJjbGljay5wYW5lbCIgLCBmdW5jdGlvbiggZSApIHsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQlzZWxmLmNsb3NlKCk7CgkJCXJldHVybiBmYWxzZTsKCQl9KTsKCQlzZWxmLmVsZW1lbnQub24oICJjbGljay5wYW5lbCIgLCAiYTpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiLCBmdW5jdGlvbigvKiBlICovKSB7CgkJCXNlbGYuY2xvc2UoKTsKCQl9KTsKCX0sCgoJX3Bvc2l0aW9uUGFuZWw6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJcGFuZWxJbm5lckhlaWdodCA9IHNlbGYuX3BhbmVsSW5uZXIub3V0ZXJIZWlnaHQoKSwKCQkJZXhwYW5kID0gcGFuZWxJbm5lckhlaWdodCA+ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQlpZiAoIGV4cGFuZCB8fCAhc2VsZi5vcHRpb25zLnBvc2l0aW9uRml4ZWQgKSB7CgkJCWlmICggZXhwYW5kICkgewoJCQkJc2VsZi5fdW5maXhQYW5lbCgpOwoJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCBwYW5lbElubmVySGVpZ2h0ICk7CgkJCX0KCQkJd2luZG93LnNjcm9sbFRvKCAwLCAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCApOwoJCX0gZWxzZSB7CgkJCXNlbGYuX2ZpeFBhbmVsKCk7CgkJfQoJfSwKCglfYmluZEZpeExpc3RlbmVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbiggJCggd2luZG93ICksIHsgInRocm90dGxlZHJlc2l6ZSI6ICJfcG9zaXRpb25QYW5lbCIgfSk7Cgl9LAoKCV91bmJpbmRGaXhMaXN0ZW5lcjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb2ZmKCAkKCB3aW5kb3cgKSwgInRocm90dGxlZHJlc2l6ZSIgKTsKCX0sCgoJX3VuZml4UGFuZWw6IGZ1bmN0aW9uKCkgewoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCAmJiAkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbiApIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkICk7CgkJfQoJfSwKCglfZml4UGFuZWw6IGZ1bmN0aW9uKCkgewoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCAmJiAkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbiApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkICk7CgkJfQoJfSwKCglfYmluZFVwZGF0ZUxheW91dDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZWxmLmVsZW1lbnQub24oICJ1cGRhdGVsYXlvdXQiLCBmdW5jdGlvbigvKiBlICovKSB7CgkJCWlmICggc2VsZi5fb3BlbiApIHsKCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCQkJfQoJCX0pOwoJfSwKCglfYmluZExpbmtMaXN0ZW5lcnM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29uKCAiYm9keSIsIHsKCQkJImNsaWNrIGEiOiAiX2hhbmRsZUNsaWNrIgoJCX0pOwoKCX0sCgoJX2hhbmRsZUNsaWNrOiBmdW5jdGlvbiggZSApIHsKCQlpZiAoICBlLmN1cnJlbnRUYXJnZXQuaHJlZi5zcGxpdCggIiMiIClbIDEgXSA9PT0gdGhpcy5fcGFuZWxJRCAmJiB0aGlzLl9wYW5lbElEICE9PSB1bmRlZmluZWQgKSB7CgkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJdmFyIGxpbmsgPSAkKCBlLnRhcmdldCApOwoJCQlpZiAoIGxpbmsuaGFzQ2xhc3MoICJ1aS1idG4iICkgKSB7CgkJCQlsaW5rLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJdGhpcy5lbGVtZW50Lm9uZSggInBhbmVsb3BlbiBwYW5lbGNsb3NlIiwgZnVuY3Rpb24oKSB7CgkJCQkJbGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCX0pOwoJCQl9CgkJCXRoaXMudG9nZ2xlKCk7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9LAoKCV9iaW5kU3dpcGVFdmVudHM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJYXJlYSA9IHNlbGYuX21vZGFsID8gc2VsZi5lbGVtZW50LmFkZCggc2VsZi5fbW9kYWwgKSA6IHNlbGYuZWxlbWVudDsKCgkJLy8gb24gc3dpcGUsIGNsb3NlIHRoZSBwYW5lbAoJCWlmICggISFzZWxmLm9wdGlvbnMuc3dpcGVDbG9zZSApIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucG9zaXRpb24gPT09ICJsZWZ0IiApIHsKCQkJCWFyZWEub24oICJzd2lwZWxlZnQucGFuZWwiLCBmdW5jdGlvbigvKiBlICovKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlhcmVhLm9uKCAic3dpcGVyaWdodC5wYW5lbCIsIGZ1bmN0aW9uKC8qIGUgKi8pIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9KTsKCQkJfQoJCX0KCX0sCgoJX2JpbmRQYWdlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXRoaXMuZG9jdW1lbnQKCQkJLy8gQ2xvc2UgdGhlIHBhbmVsIGlmIGFub3RoZXIgcGFuZWwgb24gdGhlIHBhZ2Ugb3BlbnMKCQkJLm9uKCAicGFuZWxiZWZvcmVvcGVuIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gJiYgZS50YXJnZXQgIT09IHNlbGYuZWxlbWVudFsgMCBdICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0KCQkJfSkKCQkJLy8gT24gZXNjYXBlLCBjbG9zZT8gbWlnaHQgbmVlZCB0byBoYXZlIGEgdGFyZ2V0IGNoZWNrIHRvby4uLgoJCQkub24oICJrZXl1cC5wYW5lbCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJaWYgKCBlLmtleUNvZGUgPT09IDI3ICYmIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfQoJCQl9KTsKCgkJLy8gQ2xlYW4gdXAgb3BlbiBwYW5lbHMgYWZ0ZXIgcGFnZSBoaWRlCgkJaWYgKCBzZWxmLl9wYXJlbnRQYWdlICkgewoJCQl0aGlzLmRvY3VtZW50Lm9uKCAicGFnZWhpZGUiLCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSggdHJ1ZSApOwoJCQkJfQoJCQl9KTsKCQl9IGVsc2UgewoJCQl0aGlzLmRvY3VtZW50Lm9uKCAicGFnZWJlZm9yZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCWlmICggc2VsZi5fb3BlbiApIHsKCQkJCQlzZWxmLmNsb3NlKCB0cnVlICk7CgkJCQl9CgkJCX0pOwoJCX0KCX0sCgoJLy8gc3RhdGUgc3RvcmFnZSBvZiBvcGVuIG9yIGNsb3NlZAoJX29wZW46IGZhbHNlLAoJX3BhZ2VDb250ZW50T3BlbkNsYXNzZXM6IG51bGwsCglfbW9kYWxPcGVuQ2xhc3NlczogbnVsbCwKCglvcGVuOiBmdW5jdGlvbiggaW1tZWRpYXRlICkgewoJCWlmICggIXRoaXMuX29wZW4gKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgoJCQkJX29wZW5QYW5lbCA9IGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYuZG9jdW1lbnQub2ZmKCAicGFuZWxjbG9zZSIgKTsKCQkJCQlzZWxmLl9wYWdlKCkuanFtRGF0YSggInBhbmVsIiwgIm9wZW4iICk7CgoJCQkJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICYmIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyKCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5hZGRDbGFzcyggby5jbGFzc2VzLmFuaW1hdGUgKTsKCQkJCQl9CgoJCQkJCWlmICggIWltbWVkaWF0ZSAmJiAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgKSB7CgkJCQkJCXNlbGYuZG9jdW1lbnQub24oIHNlbGYuX3RyYW5zaXRpb25FbmRFdmVudHMsIGNvbXBsZXRlICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJc2V0VGltZW91dCggY29tcGxldGUsIDAgKTsKCQkJCQl9CgoJCQkJCWlmICggby50aGVtZSAmJiBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZSgpLnBhcmVudCgpCgkJCQkJCQkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi10aGVtZWQgIiArIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi0iICsgby50aGVtZSApOwoJCQkJCX0KCgkJCQkJc2VsZi5lbGVtZW50CgkJCQkJCS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhbmVsQ2xvc2VkICkKCQkJCQkJLmFkZENsYXNzKCBvLmNsYXNzZXMucGFuZWxPcGVuICk7CgoJCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCgkJCQkJc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyA9IHNlbGYuX2dldFBvc0Rpc3BsYXlDbGFzc2VzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKTsKCgkJCQkJaWYgKCBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZSgpLnBhcmVudCgpLmFkZENsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciApOwoJCQkJCQlzZWxmLl93cmFwcGVyKCkuYWRkQ2xhc3MoIHNlbGYuX3BhZ2VDb250ZW50T3BlbkNsYXNzZXMgKTsKCQkJCQkJc2VsZi5fZml4ZWRUb29sYmFycygpLmFkZENsYXNzKCBzZWxmLl9wYWdlQ29udGVudE9wZW5DbGFzc2VzICk7CgkJCQkJfQoKCQkJCQlzZWxmLl9tb2RhbE9wZW5DbGFzc2VzID0gc2VsZi5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIG8uY2xhc3Nlcy5tb2RhbCApICsgIiAiICsgby5jbGFzc2VzLm1vZGFsT3BlbjsKCQkJCQlpZiAoIHNlbGYuX21vZGFsICkgewoJCQkJCQlzZWxmLl9tb2RhbAoJCQkJCQkJLmFkZENsYXNzKCBzZWxmLl9tb2RhbE9wZW5DbGFzc2VzICkKCQkJCQkJCS5oZWlnaHQoIE1hdGgubWF4KCBzZWxmLl9tb2RhbC5oZWlnaHQoKSwgc2VsZi5kb2N1bWVudC5oZWlnaHQoKSApICk7CgkJCQkJfQoJCQkJfSwKCQkJCWNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5kb2N1bWVudC5vZmYoIHNlbGYuX3RyYW5zaXRpb25FbmRFdmVudHMsIGNvbXBsZXRlICk7CgoJCQkJCWlmICggby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3dyYXBwZXIoKS5hZGRDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250ZW50UHJlZml4ICsgIi1vcGVuIiApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCQkJCQl9CgoJCQkJCXNlbGYuX2JpbmRGaXhMaXN0ZW5lcigpOwoKCQkJCQlzZWxmLl90cmlnZ2VyKCAib3BlbiIgKTsKCQkJCX07CgoJCQlzZWxmLl90cmlnZ2VyKCAiYmVmb3Jlb3BlbiIgKTsKCgkJCWlmICggc2VsZi5fcGFnZSgpLmpxbURhdGEoICJwYW5lbCIgKSA9PT0gIm9wZW4iICkgewoJCQkJc2VsZi5kb2N1bWVudC5vbiggInBhbmVsY2xvc2UiLCBmdW5jdGlvbigpIHsKCQkJCQlfb3BlblBhbmVsKCk7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCV9vcGVuUGFuZWwoKTsKCQkJfQoKCQkJc2VsZi5fb3BlbiA9IHRydWU7CgkJfQoJfSwKCgljbG9zZTogZnVuY3Rpb24oIGltbWVkaWF0ZSApIHsKCQlpZiAoIHRoaXMuX29wZW4gKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSB0aGlzLm9wdGlvbnMsCgoJCQkJX2Nsb3NlUGFuZWwgPSBmdW5jdGlvbigpIHsKCQkJCQlpZiAoICFpbW1lZGlhdGUgJiYgJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICkgewoJCQkJCQlzZWxmLmRvY3VtZW50Lm9uKCBzZWxmLl90cmFuc2l0aW9uRW5kRXZlbnRzLCBjb21wbGV0ZSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXNldFRpbWVvdXQoIGNvbXBsZXRlLCAwICk7CgkJCQkJfQoKCQkJCQlzZWxmLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbE9wZW4gKTsKCgkJCQkJaWYgKCBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fd3JhcHBlcigpLnJlbW92ZUNsYXNzKCBzZWxmLl9wYWdlQ29udGVudE9wZW5DbGFzc2VzICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyApOwoJCQkJCX0KCgkJCQkJaWYgKCBzZWxmLl9tb2RhbCApIHsKCQkJCQkJc2VsZi5fbW9kYWwucmVtb3ZlQ2xhc3MoIHNlbGYuX21vZGFsT3BlbkNsYXNzZXMgKTsKCQkJCQl9CgkJCQl9LAoJCQkJY29tcGxldGUgPSBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLmRvY3VtZW50Lm9mZiggc2VsZi5fdHJhbnNpdGlvbkVuZEV2ZW50cywgY29tcGxldGUgKTsKCgkJCQkJaWYgKCBvLnRoZW1lICYmIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl9wYWdlKCkucGFyZW50KCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi10aGVtZWQgIiArIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi0iICsgby50aGVtZSApOwoJCQkJCX0KCgkJCQkJc2VsZi5lbGVtZW50LmFkZENsYXNzKCBvLmNsYXNzZXMucGFuZWxDbG9zZWQgKTsKCgkJCQkJaWYgKCBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZSgpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciApOwoJCQkJCQlzZWxmLl93cmFwcGVyKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCQkJCQkJc2VsZi5fZml4ZWRUb29sYmFycygpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKyAiLW9wZW4iICk7CgkJCQkJfQoKCQkJCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIW8uYW5pbWF0ZSAmJiBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fd3JhcHBlcigpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMuYW5pbWF0ZSApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJfQoKCQkJCQlzZWxmLl9maXhQYW5lbCgpOwoJCQkJCXNlbGYuX3VuYmluZEZpeExpc3RlbmVyKCk7CgkJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCk7CgoJCQkJCXNlbGYuX3BhZ2UoKS5qcW1SZW1vdmVEYXRhKCAicGFuZWwiICk7CgoJCQkJCXNlbGYuX3RyaWdnZXIoICJjbG9zZSIgKTsKCQkJCX07CgoJCQlzZWxmLl90cmlnZ2VyKCAiYmVmb3JlY2xvc2UiICk7CgoJCQlfY2xvc2VQYW5lbCgpOwoKCQkJc2VsZi5fb3BlbiA9IGZhbHNlOwoJCX0KCX0sCgoJdG9nZ2xlOiBmdW5jdGlvbigpIHsKCQl0aGlzWyB0aGlzLl9vcGVuID8gImNsb3NlIiA6ICJvcGVuIiBdKCk7Cgl9LAoKCV90cmFuc2l0aW9uRW5kRXZlbnRzOiAid2Via2l0VHJhbnNpdGlvbkVuZCBvVHJhbnNpdGlvbkVuZCBvdHJhbnNpdGlvbmVuZCB0cmFuc2l0aW9uZW5kIG1zVHJhbnNpdGlvbkVuZCIsCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciBvdGhlclBhbmVscywKCQlvID0gdGhpcy5vcHRpb25zLAoJCW11bHRpcGxlUGFuZWxzID0gKCAkKCAiYm9keSA+IDptb2JpbGUtcGFuZWwiICkubGVuZ3RoICsgJC5tb2JpbGUuYWN0aXZlUGFnZS5maW5kKCAiOm1vYmlsZS1wYW5lbCIgKS5sZW5ndGggKSA+IDE7CgoJCWlmICggby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgoJCQkvLyAgcmVtb3ZlIHRoZSB3cmFwcGVyIGlmIG5vdCBpbiB1c2UgYnkgYW5vdGhlciBwYW5lbAoJCQlvdGhlclBhbmVscyA9ICQoICJib2R5ID4gOm1vYmlsZS1wYW5lbCIgKS5hZGQoICQubW9iaWxlLmFjdGl2ZVBhZ2UuZmluZCggIjptb2JpbGUtcGFuZWwiICkgKTsKCQkJaWYgKCBvdGhlclBhbmVscy5ub3QoICIudWktcGFuZWwtZGlzcGxheS1vdmVybGF5IiApLm5vdCggdGhpcy5lbGVtZW50ICkubGVuZ3RoID09PSAwICkgewoJCQkJdGhpcy5fd3JhcHBlcigpLmNoaWxkcmVuKCkudW53cmFwKCk7CgkJCX0KCgkJCWlmICggdGhpcy5fb3BlbiApIHsKCgkJCQl0aGlzLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCgkJCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIW8uYW5pbWF0ZSApIHsKCQkJCQl0aGlzLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQl9CgoJCQkJdGhpcy5fcGFnZSgpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciApOwoKCQkJCWlmICggby50aGVtZSApIHsKCQkJCQl0aGlzLl9wYWdlKCkucGFyZW50KCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi10aGVtZWQgIiArIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi0iICsgby50aGVtZSApOwoJCQkJfQoJCQl9CgkJfQoKCQlpZiAoICFtdWx0aXBsZVBhbmVscyApIHsKCgkJCXRoaXMuZG9jdW1lbnQub2ZmKCAicGFuZWxvcGVuIHBhbmVsY2xvc2UiICk7CgoJCQlpZiAoIHRoaXMuX29wZW4gKSB7CgkJCQl0aGlzLmRvY3VtZW50Lm9mZiggdGhpcy5fdHJhbnNpdGlvbkVuZEV2ZW50cyApOwoJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCk7CgkJCX0KCQl9CgoJCWlmICggdGhpcy5fb3BlbiApIHsKCQkJdGhpcy5fcGFnZSgpLmpxbVJlbW92ZURhdGEoICJwYW5lbCIgKTsKCQl9CgoJCXRoaXMuX3BhbmVsSW5uZXIuY2hpbGRyZW4oKS51bndyYXAoKTsKCgkJdGhpcy5lbGVtZW50CgkJCS5yZW1vdmVDbGFzcyggWyB0aGlzLl9nZXRQYW5lbENsYXNzZXMoKSwgby5jbGFzc2VzLnBhbmVsT3Blbiwgby5jbGFzc2VzLmFuaW1hdGUgXS5qb2luKCAiICIgKSApCgkJCS5vZmYoICJzd2lwZWxlZnQucGFuZWwgc3dpcGVyaWdodC5wYW5lbCIgKQoJCQkub2ZmKCAicGFuZWxiZWZvcmVvcGVuIiApCgkJCS5vZmYoICJwYW5lbGhpZGUiICkKCQkJLm9mZiggImtleXVwLnBhbmVsIiApCgkJCS5vZmYoICJ1cGRhdGVsYXlvdXQiICkKCQkJLm9mZiggdGhpcy5fdHJhbnNpdGlvbkVuZEV2ZW50cyApOwoKCQl0aGlzLl9jbG9zZUxpbmsub2ZmKCAiY2xpY2sucGFuZWwiICk7CgoJCWlmICggdGhpcy5fbW9kYWwgKSB7CgkJCXRoaXMuX21vZGFsLnJlbW92ZSgpOwoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRhYmxlIiwgewoJb3B0aW9uczogewoJCWNsYXNzZXM6IHsKCQkJdGFibGU6ICJ1aS10YWJsZSIKCQl9LAoJCWVuaGFuY2VkOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMudGFibGUgKTsKCQl9CgoJCS8vIGV4dGVuZCBoZXJlLCBhc3NpZ24gb24gcmVmcmVzaCA+IF9zZXRIZWFkZXJzCgkJJC5leHRlbmQoIHRoaXMsIHsKCgkJCS8vIEV4cG9zZSBoZWFkZXJzIGFuZCBhbGxIZWFkZXJzIHByb3BlcnRpZXMgb24gdGhlIHdpZGdldAoJCQkvLyBoZWFkZXJzIHJlZmVyZW5jZXMgdGhlIFRIcyB3aXRoaW4gdGhlIGZpcnN0IFRSIGluIHRoZSB0YWJsZQoJCQloZWFkZXJzOiB1bmRlZmluZWQsCgoJCQkvLyBhbGxIZWFkZXJzIHJlZmVyZW5jZXMgaGVhZGVycywgcGx1cyBhbGwgVEhzIGluIHRoZSB0aGVhZCwgd2hpY2ggbWF5CgkJCS8vIGluY2x1ZGUgc2V2ZXJhbCByb3dzLCBvciBub3QKCQkJYWxsSGVhZGVyczogdW5kZWZpbmVkCgkJfSk7CgoJCXRoaXMuX3JlZnJlc2goIHRydWUgKTsKCX0sCgoJX3NldEhlYWRlcnM6IGZ1bmN0aW9uKCkgewoJCXZhciB0cnMgPSB0aGlzLmVsZW1lbnQuZmluZCggInRoZWFkIHRyIiApOwoKCQl0aGlzLmhlYWRlcnMgPSB0aGlzLmVsZW1lbnQuZmluZCggInRyOmVxKDApIiApLmNoaWxkcmVuKCk7CgkJdGhpcy5hbGxIZWFkZXJzID0gdGhpcy5oZWFkZXJzLmFkZCggdHJzLmNoaWxkcmVuKCkgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcmVmcmVzaCgpOwoJfSwKCglyZWJ1aWxkOiAkLm5vb3AsCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCAvKiBjcmVhdGUgKi8gKSB7CgkJdmFyIHRhYmxlID0gdGhpcy5lbGVtZW50LAoJCQl0cnMgPSB0YWJsZS5maW5kKCAidGhlYWQgdHIiICk7CgoJCS8vIHVwZGF0aW5nIGhlYWRlcnMgb24gcmVmcmVzaCAoZml4ZXMgIzU4ODApCgkJdGhpcy5fc2V0SGVhZGVycygpOwoKCQkvLyBJdGVyYXRlIG92ZXIgdGhlIHRycwoJCXRycy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGNvbHVtbkNvdW50ID0gMDsKCgkJCS8vIEl0ZXJhdGUgb3ZlciB0aGUgY2hpbGRyZW4gb2YgdGhlIHRyCgkJCSQoIHRoaXMgKS5jaGlsZHJlbigpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNwYW4gPSBwYXJzZUludCggdGhpcy5nZXRBdHRyaWJ1dGUoICJjb2xzcGFuIiApLCAxMCApLAoJCQkJCXNlbGVjdG9yID0gIjpudGgtY2hpbGQoIiArICggY29sdW1uQ291bnQgKyAxICkgKyAiKSIsCgkJCQkJajsKCgkJCQl0aGlzLnNldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgImNvbHN0YXJ0IiwgY29sdW1uQ291bnQgKyAxICk7CgoJCQkJaWYgKCBzcGFuICkgewoJCQkJCWZvciggaiA9IDA7IGogPCBzcGFuIC0gMTsgaisrICkgewoJCQkJCQljb2x1bW5Db3VudCsrOwoJCQkJCQlzZWxlY3RvciArPSAiLCA6bnRoLWNoaWxkKCIgKyAoIGNvbHVtbkNvdW50ICsgMSApICsgIikiOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBTdG9yZSAiY2VsbHMiIGRhdGEgb24gaGVhZGVyIGFzIGEgcmVmZXJlbmNlIHRvIGFsbCBjZWxscyBpbiB0aGUKCQkJCS8vIHNhbWUgY29sdW1uIGFzIHRoaXMgVEgKCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAiY2VsbHMiLCB0YWJsZS5maW5kKCAidHIiICkubm90KCB0cnMuZXEoIDAgKSApLm5vdCggdGhpcyApLmNoaWxkcmVuKCBzZWxlY3RvciApICk7CgoJCQkJY29sdW1uQ291bnQrKzsKCQkJfSk7CgkJfSk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUudGFibGUiLCAkLm1vYmlsZS50YWJsZSwgewoJb3B0aW9uczogewoJCW1vZGU6ICJjb2x1bW50b2dnbGUiLAoJCWNvbHVtbkJ0blRoZW1lOiBudWxsLAoJCWNvbHVtblBvcHVwVGhlbWU6IG51bGwsCgkJY29sdW1uQnRuVGV4dDogIkNvbHVtbnMuLi4iLAoJCWNsYXNzZXM6ICQuZXh0ZW5kKCAkLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jbGFzc2VzLCB7CgkJCXBvcHVwOiAidWktdGFibGUtY29sdW1udG9nZ2xlLXBvcHVwIiwKCQkJY29sdW1uQnRuOiAidWktdGFibGUtY29sdW1udG9nZ2xlLWJ0biIsCgkJCXByaW9yaXR5UHJlZml4OiAidWktdGFibGUtcHJpb3JpdHktIiwKCQkJY29sdW1uVG9nZ2xlVGFibGU6ICJ1aS10YWJsZS1jb2x1bW50b2dnbGUiCgkJfSkKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMubW9kZSAhPT0gImNvbHVtbnRvZ2dsZSIgKSB7CgkJCXJldHVybjsKCQl9CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9tZW51OiBudWxsCgkJfSk7CgoJCWlmICggdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9tZW51ID0gJCggdGhpcy5kb2N1bWVudFsgMCBdLmdldEVsZW1lbnRCeUlkKCB0aGlzLl9pZCgpICsgIi1wb3B1cCIgKSApLmNoaWxkcmVuKCkuZmlyc3QoKTsKCQkJdGhpcy5fYWRkVG9nZ2xlcyggdGhpcy5fbWVudSwgdHJ1ZSApOwoJCQl0aGlzLl9iaW5kVG9nZ2xlcyggdGhpcy5fbWVudSApOwoJCX0gZWxzZSB7CgkJCXRoaXMuX21lbnUgPSB0aGlzLl9lbmhhbmNlQ29sVG9nZ2xlKCk7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMuY29sdW1uVG9nZ2xlVGFibGUgKTsKCQl9CgoJCXRoaXMuX3NldHVwRXZlbnRzKCk7CgoJCXRoaXMuX3NldFRvZ2dsZVN0YXRlKCk7Cgl9LAoKCV9pZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICggdGhpcy5lbGVtZW50LmF0dHIoICJpZCIgKSB8fCAoIHRoaXMud2lkZ2V0TmFtZSArIHRoaXMudXVpZCApICk7Cgl9LAoKCV9zZXR1cEV2ZW50czogZnVuY3Rpb24oKSB7CgkJLy9OT1RFOiBpbnB1dHMgYXJlIGJvdW5kIGluIGJpbmRUb2dnbGVzLAoJCS8vIHNvIGl0IGNhbiBiZSBjYWxsZWQgb24gcmVmcmVzaCwgdG9vCgoJCS8vIHVwZGF0ZSBjb2x1bW4gdG9nZ2xlcyBvbiByZXNpemUKCQl0aGlzLl9vbiggdGhpcy53aW5kb3csIHsKCQkJdGhyb3R0bGVkcmVzaXplOiAiX3NldFRvZ2dsZVN0YXRlIgoJCX0pOwoJfSwKCglfYmluZFRvZ2dsZXM6IGZ1bmN0aW9uKCBtZW51ICkgewoJCXZhciBpbnB1dHMgPSBtZW51LmZpbmQoICJpbnB1dCIgKTsKCgkJdGhpcy5fb24oIGlucHV0cywgewoJCQljaGFuZ2U6ICJfbWVudUlucHV0Q2hhbmdlIgoJCX0pOwoJfSwKCglfYWRkVG9nZ2xlczogZnVuY3Rpb24oIG1lbnUsIGtlZXAgKSB7CgkJdmFyIGlucHV0cywKCQkJY2hlY2tib3hJbmRleCA9IDAsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnMsCgkJCWNvbnRhaW5lciA9IG1lbnUuY29udHJvbGdyb3VwKCAiY29udGFpbmVyIiApOwoKCQkvLyBhbGxvdyB1cGRhdGUgb2YgbWVudSBvbiByZWZyZXNoIChmaXhlcyAjNTg4MCkKCQlpZiAoIGtlZXAgKSB7CgkJCWlucHV0cyA9IG1lbnUuZmluZCggImlucHV0IiApOwoJCX0gZWxzZSB7CgkJCWNvbnRhaW5lci5lbXB0eSgpOwoJCX0KCgkJLy8gY3JlYXRlIHRoZSBoaWRlL3Nob3cgdG9nZ2xlcwoJCXRoaXMuaGVhZGVycy5ub3QoICJ0ZCIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGhlYWRlciA9ICQoIHRoaXMgKSwKCQkJCXByaW9yaXR5ID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAicHJpb3JpdHkiICksCgkJCQljZWxscyA9IGhlYWRlci5hZGQoIGhlYWRlci5qcW1EYXRhKCAiY2VsbHMiICkgKTsKCgkJCWlmICggcHJpb3JpdHkgKSB7CgkJCQljZWxscy5hZGRDbGFzcyggb3B0cy5jbGFzc2VzLnByaW9yaXR5UHJlZml4ICsgcHJpb3JpdHkgKTsKCgkJCQkoIGtlZXAgPyBpbnB1dHMuZXEoIGNoZWNrYm94SW5kZXgrKyApIDoKCQkJCQkkKCI8bGFiZWw+PGlucHV0IHR5cGU9J2NoZWNrYm94JyBjaGVja2VkIC8+IiArCgkJCQkJCSggaGVhZGVyLmNoaWxkcmVuKCAiYWJiciIgKS5maXJzdCgpLmF0dHIoICJ0aXRsZSIgKSB8fAoJCQkJCQkJaGVhZGVyLnRleHQoKSApICsKCQkJCQkJIjwvbGFiZWw+IiApCgkJCQkJCS5hcHBlbmRUbyggY29udGFpbmVyICkKCQkJCQkJLmNoaWxkcmVuKCAwICkKCQkJCQkJLmNoZWNrYm94cmFkaW8oIHsKCQkJCQkJCXRoZW1lOiBvcHRzLmNvbHVtblBvcHVwVGhlbWUKCQkJCQkJfSkgKQoJCQkJCS5qcW1EYXRhKCAiY2VsbHMiLCBjZWxscyApOwoJCQl9CgkJfSk7CgoJCS8vIHNldCBiaW5kaW5ncyBoZXJlCgkJaWYgKCAha2VlcCApIHsKCQkJbWVudS5jb250cm9sZ3JvdXAoICJyZWZyZXNoIiApOwoJCQl0aGlzLl9iaW5kVG9nZ2xlcyggbWVudSApOwoJCX0KCX0sCgoJX21lbnVJbnB1dENoYW5nZTogZnVuY3Rpb24oIGV2dCApIHsKCQl2YXIgaW5wdXQgPSAkKCBldnQudGFyZ2V0ICksCgkJCWNoZWNrZWQgPSBpbnB1dFsgMCBdLmNoZWNrZWQ7CgoJCWlucHV0LmpxbURhdGEoICJjZWxscyIgKQoJCQkudG9nZ2xlQ2xhc3MoICJ1aS10YWJsZS1jZWxsLWhpZGRlbiIsICFjaGVja2VkICkKCQkJLnRvZ2dsZUNsYXNzKCAidWktdGFibGUtY2VsbC12aXNpYmxlIiwgY2hlY2tlZCApOwoKCQlpZiAoIGlucHV0WyAwIF0uZ2V0QXR0cmlidXRlKCAibG9ja2VkIiApICkgewoJCQlpbnB1dC5yZW1vdmVBdHRyKCAibG9ja2VkIiApOwoKCQkJdGhpcy5fdW5sb2NrQ2VsbHMoIGlucHV0LmpxbURhdGEoICJjZWxscyIgKSApOwoJCX0gZWxzZSB7CgkJCWlucHV0LmF0dHIoICJsb2NrZWQiLCB0cnVlICk7CgkJfQoJfSwKCglfdW5sb2NrQ2VsbHM6IGZ1bmN0aW9uKCBjZWxscyApIHsKCQkvLyBhbGxvdyBoaWRlL3Nob3cgdmlhIENTUyBvbmx5ID0gcmVtb3ZlIGFsbCB0b2dnbGUtbG9ja3MKCQljZWxscy5yZW1vdmVDbGFzcyggInVpLXRhYmxlLWNlbGwtaGlkZGVuIHVpLXRhYmxlLWNlbGwtdmlzaWJsZSIpOwoJfSwKCglfZW5oYW5jZUNvbFRvZ2dsZTogZnVuY3Rpb24oKSB7CgkJdmFyIGlkICwgbWVudUJ1dHRvbiwgcG9wdXAsIG1lbnUsCgkJCXRhYmxlID0gdGhpcy5lbGVtZW50LAoJCQlvcHRzID0gdGhpcy5vcHRpb25zLAoJCQlucyA9ICQubW9iaWxlLm5zLAoJCQlmcmFnbWVudCA9IHRoaXMuZG9jdW1lbnRbIDAgXS5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CgoJCWlkID0gdGhpcy5faWQoKSArICItcG9wdXAiOwoJCW1lbnVCdXR0b24gPSAkKCAiPGEgaHJlZj0nIyIgKyBpZCArICInICIgKwoJCQkiY2xhc3M9JyIgKyBvcHRzLmNsYXNzZXMuY29sdW1uQnRuICsgIiB1aS1idG4gIiArCgkJCSJ1aS1idG4tIiArICggb3B0cy5jb2x1bW5CdG5UaGVtZSB8fCAiYSIgKSArCgkJCSIgdWktY29ybmVyLWFsbCB1aS1zaGFkb3cgdWktbWluaScgIiArCgkJCSJkYXRhLSIgKyBucyArICJyZWw9J3BvcHVwJz4iICsgb3B0cy5jb2x1bW5CdG5UZXh0ICsgIjwvYT4iICk7CgkJcG9wdXAgPSAkKCAiPGRpdiBjbGFzcz0nIiArIG9wdHMuY2xhc3Nlcy5wb3B1cCArICInIGlkPSciICsgaWQgKyAiJz48L2Rpdj4iICk7CgkJbWVudSA9ICQoICI8ZmllbGRzZXQ+PC9maWVsZHNldD4iICkuY29udHJvbGdyb3VwKCk7CgoJCS8vIHNldCBleHRlbnNpb24gaGVyZSwgc2VuZCAiZmFsc2UiIHRvIHRyaWdnZXIgYnVpbGQvcmVidWlsZAoJCXRoaXMuX2FkZFRvZ2dsZXMoIG1lbnUsIGZhbHNlICk7CgoJCW1lbnUuYXBwZW5kVG8oIHBvcHVwICk7CgoJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBwb3B1cFsgMCBdICk7CgkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIG1lbnVCdXR0b25bIDAgXSApOwoJCXRhYmxlLmJlZm9yZSggZnJhZ21lbnQgKTsKCgkJcG9wdXAucG9wdXAoKTsKCgkJcmV0dXJuIG1lbnU7Cgl9LAoKCXJlYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLm1vZGUgPT09ICJjb2x1bW50b2dnbGUiICkgewoJCQkvLyBOT1RFOiByZWJ1aWxkIHBhc3NlcyAiZmFsc2UiLCB3aGlsZSByZWZyZXNoIHBhc3NlcyAidW5kZWZpbmVkIgoJCQkvLyBib3RoIHJlZnJlc2ggdGhlIHRhYmxlLCBidXQgaW5zaWRlIGFkZFRvZ2dsZXMsICFmYWxzZSB3aWxsIGJlIHRydWUsCgkJCS8vIHNvIGEgcmVidWlsZCBjYWxsIGNhbiBiZSBpbmRlbnRpZmllZAoJCQl0aGlzLl9yZWZyZXNoKCBmYWxzZSApOwoJCX0KCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdGhpcy5fc3VwZXIoIGNyZWF0ZSApOwoKCQlpZiAoICFjcmVhdGUgJiYgdGhpcy5vcHRpb25zLm1vZGUgPT09ICJjb2x1bW50b2dnbGUiICkgewoJCQkvLyBjb2x1bW5zIG5vdCBiZWluZyByZXBsYWNlZCBtdXN0IGJlIGNsZWFyZWQgZnJvbSBpbnB1dCB0b2dnbGUtbG9ja3MKCQkJdGhpcy5fdW5sb2NrQ2VsbHMoIHRoaXMuYWxsSGVhZGVycyApOwoKCQkJLy8gdXBkYXRlIGNvbHVtbnRvZ2dsZXMgYW5kIGNlbGxzCgkJCXRoaXMuX2FkZFRvZ2dsZXMoIHRoaXMuX21lbnUsIGNyZWF0ZSApOwoKCQkJLy8gY2hlY2svdW5jaGVjawoJCQl0aGlzLl9zZXRUb2dnbGVTdGF0ZSgpOwoJCX0KCX0sCgoJX3NldFRvZ2dsZVN0YXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9tZW51LmZpbmQoICJpbnB1dCIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGNoZWNrYm94ID0gJCggdGhpcyApOwoKCQkJdGhpcy5jaGVja2VkID0gY2hlY2tib3guanFtRGF0YSggImNlbGxzIiApLmVxKCAwICkuY3NzKCAiZGlzcGxheSIgKSA9PT0gInRhYmxlLWNlbGwiOwoJCQljaGVja2JveC5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCQl9KTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50YWJsZSIsICQubW9iaWxlLnRhYmxlLCB7CglvcHRpb25zOiB7CgkJbW9kZTogInJlZmxvdyIsCgkJY2xhc3NlczogJC5leHRlbmQoICQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNsYXNzZXMsIHsKCQkJcmVmbG93VGFibGU6ICJ1aS10YWJsZS1yZWZsb3ciLAoJCQljZWxsTGFiZWxzOiAidWktdGFibGUtY2VsbC1sYWJlbCIKCQl9KQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQkvLyBJZiBpdCdzIG5vdCByZWZsb3cgbW9kZSwgcmV0dXJuIGhlcmUuCgkJaWYgKCB0aGlzLm9wdGlvbnMubW9kZSAhPT0gInJlZmxvdyIgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5yZWZsb3dUYWJsZSApOwoKCQkJdGhpcy5fdXBkYXRlUmVmbG93KCk7CgkJfQoJfSwKCglyZWJ1aWxkOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5tb2RlID09PSAicmVmbG93IiApIHsKCQkJdGhpcy5fcmVmcmVzaCggZmFsc2UgKTsKCQl9Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXRoaXMuX3N1cGVyKCBjcmVhdGUgKTsKCQlpZiAoICFjcmVhdGUgJiYgdGhpcy5vcHRpb25zLm1vZGUgPT09ICJyZWZsb3ciICkgewoJCQl0aGlzLl91cGRhdGVSZWZsb3coICk7CgkJfQoJfSwKCglfdXBkYXRlUmVmbG93OiBmdW5jdGlvbigpIHsKCQl2YXIgdGFibGUgPSB0aGlzLAoJCQlvcHRzID0gdGhpcy5vcHRpb25zOwoKCQkvLyBnZXQgaGVhZGVycyBpbiByZXZlcnNlIG9yZGVyIHNvIHRoYXQgdG9wLWxldmVsIGhlYWRlcnMgYXJlIGFwcGVuZGVkIGxhc3QKCQkkKCB0YWJsZS5hbGxIZWFkZXJzLmdldCgpLnJldmVyc2UoKSApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgY2VsbHMgPSAkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiApLAoJCQkJY29sc3RhcnQgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMsICJjb2xzdGFydCIgKSwKCQkJCWhpZXJhcmNoeUNsYXNzID0gY2VsbHMubm90KCB0aGlzICkuZmlsdGVyKCAidGhlYWQgdGgiICkubGVuZ3RoICYmICIgdWktdGFibGUtY2VsbC1sYWJlbC10b3AiLAoJCQkJdGV4dCA9ICQoIHRoaXMgKS50ZXh0KCksCgkJCQlpdGVyYXRpb24sIGZpbHRlcjsKCgkJCQlpZiAoIHRleHQgIT09ICIiICApIHsKCgkJCQkJaWYgKCBoaWVyYXJjaHlDbGFzcyApIHsKCQkJCQkJaXRlcmF0aW9uID0gcGFyc2VJbnQoIHRoaXMuZ2V0QXR0cmlidXRlKCAiY29sc3BhbiIgKSwgMTAgKTsKCQkJCQkJZmlsdGVyID0gIiI7CgoJCQkJCQlpZiAoIGl0ZXJhdGlvbiApIHsKCQkJCQkJCWZpbHRlciA9ICJ0ZDpudGgtY2hpbGQoIisgaXRlcmF0aW9uICsibiArICIgKyAoIGNvbHN0YXJ0ICkgKyIpIjsKCQkJCQkJfQoKCQkJCQkJdGFibGUuX2FkZExhYmVscyggY2VsbHMuZmlsdGVyKCBmaWx0ZXIgKSwgb3B0cy5jbGFzc2VzLmNlbGxMYWJlbHMgKyBoaWVyYXJjaHlDbGFzcywgdGV4dCApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRhYmxlLl9hZGRMYWJlbHMoIGNlbGxzLCBvcHRzLmNsYXNzZXMuY2VsbExhYmVscywgdGV4dCApOwoJCQkJCX0KCgkJCQl9CgkJfSk7Cgl9LAoKCV9hZGRMYWJlbHM6IGZ1bmN0aW9uKCBjZWxscywgbGFiZWwsIHRleHQgKSB7CgkJLy8gLm5vdCBmaXhlcyAjNjAwNgoJCWNlbGxzLm5vdCggIjpoYXMoYi4iICsgbGFiZWwgKyAiKSIgKS5wcmVwZW5kKCAiPGIgY2xhc3M9JyIgKyBsYWJlbCArICInPiIgKyB0ZXh0ICsgIjwvYj4iICApOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gVE9ETyByZW5hbWUgZmlsdGVyQ2FsbGJhY2svZGVwcmVjYXRlIGFuZCBkZWZhdWx0IHRvIHRoZSBpdGVtIGl0c2VsZiBhcyB0aGUgZmlyc3QgYXJndW1lbnQKdmFyIGRlZmF1bHRGaWx0ZXJDYWxsYmFjayA9IGZ1bmN0aW9uKCBpbmRleCwgc2VhcmNoVmFsdWUgKSB7CglyZXR1cm4gKCAoICIiICsgKCAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMsICJmaWx0ZXJ0ZXh0IiApIHx8ICQoIHRoaXMgKS50ZXh0KCkgKSApCgkJLnRvTG93ZXJDYXNlKCkuaW5kZXhPZiggc2VhcmNoVmFsdWUgKSA9PT0gLTEgKTsKfTsKCiQud2lkZ2V0KCAibW9iaWxlLmZpbHRlcmFibGUiLCB7CgoJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEoZmlsdGVyPSd0cnVlJykiLAoKCW9wdGlvbnM6IHsKCQlmaWx0ZXJSZXZlYWw6IGZhbHNlLAoJCWZpbHRlckNhbGxiYWNrOiBkZWZhdWx0RmlsdGVyQ2FsbGJhY2ssCgkJZW5oYW5jZWQ6IGZhbHNlLAoJCWlucHV0OiBudWxsLAoJCWNoaWxkcmVuOiAiPiBsaSwgPiBvcHRpb24sID4gb3B0Z3JvdXAgb3B0aW9uLCA+IHRib2R5IHRyLCA+IC51aS1jb250cm9sZ3JvdXAtY29udHJvbHMgPiAudWktYnRuLCA+IC51aS1jb250cm9sZ3JvdXAtY29udHJvbHMgPiAudWktY2hlY2tib3gsID4gLnVpLWNvbnRyb2xncm91cC1jb250cm9scyA+IC51aS1yYWRpbyIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9zZWFyY2g6IG51bGwsCgkJCV90aW1lcjogMAoJCX0pOwoKCQl0aGlzLl9zZXRJbnB1dCggb3B0cy5pbnB1dCApOwoJCWlmICggIW9wdHMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX2ZpbHRlckl0ZW1zKCAoICggdGhpcy5fc2VhcmNoICYmIHRoaXMuX3NlYXJjaC52YWwoKSApIHx8ICIiICkudG9Mb3dlckNhc2UoKSApOwoJCX0KCX0sCgoJX29uS2V5VXA6IGZ1bmN0aW9uKCkgewoJCXZhciB2YWwsIGxhc3R2YWwsCgkJCXNlYXJjaCA9IHRoaXMuX3NlYXJjaDsKCgkJaWYgKCBzZWFyY2ggKSB7CgkJCXZhbCA9IHNlYXJjaC52YWwoKS50b0xvd2VyQ2FzZSgpLAoJCQlsYXN0dmFsID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCBzZWFyY2hbIDAgXSwgImxhc3R2YWwiICkgKyAiIjsKCgkJCWlmICggbGFzdHZhbCAmJiBsYXN0dmFsID09PSB2YWwgKSB7CgkJCQkvLyBFeGVjdXRlIHRoZSBoYW5kbGVyIG9ubHkgb25jZSBwZXIgdmFsdWUgY2hhbmdlCgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggdGhpcy5fdGltZXIgKSB7CgkJCQl3aW5kb3cuY2xlYXJUaW1lb3V0KCB0aGlzLl90aW1lciApOwoJCQkJdGhpcy5fdGltZXIgPSAwOwoJCQl9CgoJCQl0aGlzLl90aW1lciA9IHRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsKCQkJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVmaWx0ZXIiLCAiYmVmb3JlZmlsdGVyIiwgeyBpbnB1dDogc2VhcmNoIH0gKTsKCgkJCQkvLyBDaGFuZ2UgdmFsIGFzIGxhc3R2YWwgZm9yIG5leHQgZXhlY3V0aW9uCgkJCQlzZWFyY2hbIDAgXS5zZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJsYXN0dmFsIiwgdmFsICk7CgoJCQkJdGhpcy5fZmlsdGVySXRlbXMoIHZhbCApOwoJCQkJdGhpcy5fdGltZXIgPSAwOwoJCQl9LCAyNTAgKTsKCQl9Cgl9LAoKCV9nZXRGaWx0ZXJhYmxlSXRlbXM6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQljaGlsZHJlbiA9IHRoaXMub3B0aW9ucy5jaGlsZHJlbiwKCQkJaXRlbXMgPSAhY2hpbGRyZW4gPyB7IGxlbmd0aDogMCB9OgoJCQkJJC5pc0Z1bmN0aW9uKCBjaGlsZHJlbiApID8gY2hpbGRyZW4oKToKCQkJCWNoaWxkcmVuLm5vZGVOYW1lID8gJCggY2hpbGRyZW4gKToKCQkJCWNoaWxkcmVuLmpxdWVyeSA/IGNoaWxkcmVuOgoJCQkJdGhpcy5lbGVtZW50LmZpbmQoIGNoaWxkcmVuICk7CgoJCWlmICggaXRlbXMubGVuZ3RoID09PSAwICkgewoJCQlpdGVtcyA9IGVsZW0uY2hpbGRyZW4oKTsKCQl9CgoJCXJldHVybiBpdGVtczsKCX0sCgoJX2ZpbHRlckl0ZW1zOiBmdW5jdGlvbiggdmFsICkgewoJCXZhciBpZHgsIGNhbGxiYWNrLCBsZW5ndGgsIGRzdCwKCQkJc2hvdyA9IFtdLAoJCQloaWRlID0gW10sCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnMsCgkJCWZpbHRlckl0ZW1zID0gdGhpcy5fZ2V0RmlsdGVyYWJsZUl0ZW1zKCk7CgoJCWlmICggdmFsICE9IG51bGwgKSB7CgkJCWNhbGxiYWNrID0gb3B0cy5maWx0ZXJDYWxsYmFjayB8fCBkZWZhdWx0RmlsdGVyQ2FsbGJhY2s7CgkJCWxlbmd0aCA9IGZpbHRlckl0ZW1zLmxlbmd0aDsKCgkJCS8vIFBhcnRpdGlvbiB0aGUgaXRlbXMgaW50byB0aG9zZSB0byBiZSBoaWRkZW4gYW5kIHRob3NlIHRvIGJlIHNob3duCgkJCWZvciAoIGlkeCA9IDAgOyBpZHggPCBsZW5ndGggOyBpZHgrKyApIHsKCQkJCWRzdCA9ICggY2FsbGJhY2suY2FsbCggZmlsdGVySXRlbXNbIGlkeCBdLCBpZHgsIHZhbCApICkgPyBoaWRlIDogc2hvdzsKCQkJCWRzdC5wdXNoKCBmaWx0ZXJJdGVtc1sgaWR4IF0gKTsKCQkJfQoJCX0KCgkJLy8gSWYgbm90aGluZyBpcyBoaWRkZW4sIHRoZW4gdGhlIGRlY2lzaW9uIHdoZXRoZXIgdG8gaGlkZSBvciBzaG93IHRoZSBpdGVtcwoJCS8vIGlzIGJhc2VkIG9uIHRoZSAiZmlsdGVyUmV2ZWFsIiBvcHRpb24uCgkJaWYgKCBoaWRlLmxlbmd0aCA9PT0gMCApIHsKCQkJZmlsdGVySXRlbXNbIG9wdHMuZmlsdGVyUmV2ZWFsID8gImFkZENsYXNzIiA6ICJyZW1vdmVDbGFzcyIgXSggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSBlbHNlIHsKCQkJJCggaGlkZSApLmFkZENsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQkJJCggc2hvdyApLnJlbW92ZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9CgoJCXRoaXMuX3JlZnJlc2hDaGlsZFdpZGdldCgpOwoJfSwKCgkvLyBUaGUgRGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiBfcmVmcmVzaENoaWxkV2lkZ2V0IGF0dGVtcHRzIHRvIGNhbGwKCS8vIHJlZnJlc2ggb24gY29sbGFwc2libGVzZXQsIGNvbnRyb2xncm91cCwgc2VsZWN0bWVudSwgb3IgbGlzdHZpZXcKCV9yZWZyZXNoQ2hpbGRXaWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXZhciB3aWRnZXQsIGlkeCwKCQkJcmVjb2duaXplZFdpZGdldHMgPSBbICJjb2xsYXBzaWJsZXNldCIsICJzZWxlY3RtZW51IiwgImNvbnRyb2xncm91cCIsICJsaXN0dmlldyIgXTsKCgkJZm9yICggaWR4ID0gcmVjb2duaXplZFdpZGdldHMubGVuZ3RoIC0gMSA7IGlkeCA+IC0xIDsgaWR4LS0gKSB7CgkJCXdpZGdldCA9IHJlY29nbml6ZWRXaWRnZXRzWyBpZHggXTsKCQkJaWYgKCAkLm1vYmlsZVsgd2lkZ2V0IF0gKSB7CgkJCQl3aWRnZXQgPSB0aGlzLmVsZW1lbnQuZGF0YSggIm1vYmlsZS0iICsgd2lkZ2V0ICk7CgkJCQlpZiAoIHdpZGdldCAmJiAkLmlzRnVuY3Rpb24oIHdpZGdldC5yZWZyZXNoICkgKSB7CgkJCQkJd2lkZ2V0LnJlZnJlc2goKTsKCQkJCX0KCQkJfQoJCX0KCX0sCgoJLy8gVE9ETzogV2hlbiB0aGUgaW5wdXQgaXMgbm90IGludGVybmFsLCBkbyBub3QgZXZlbiBzdG9yZSBpdCBpbiB0aGlzLl9zZWFyY2gKCV9zZXRJbnB1dDogZnVuY3Rpb24gKCBzZWxlY3RvciApIHsKCQl2YXIgc2VhcmNoID0gdGhpcy5fc2VhcmNoOwoKCQkvLyBTdG9wIGEgcGVuZGluZyBmaWx0ZXIgb3BlcmF0aW9uCgkJaWYgKCB0aGlzLl90aW1lciApIHsKCQkJd2luZG93LmNsZWFyVGltZW91dCggdGhpcy5fdGltZXIgKTsKCQkJdGhpcy5fdGltZXIgPSAwOwoJCX0KCgkJaWYgKCBzZWFyY2ggKSB7CgkJCXRoaXMuX29mZiggc2VhcmNoLCAia2V5dXAgY2hhbmdlIGlucHV0IiApOwoJCQlzZWFyY2ggPSBudWxsOwoJCX0KCgkJaWYgKCBzZWxlY3RvciApIHsKCQkJc2VhcmNoID0gc2VsZWN0b3IuanF1ZXJ5ID8gc2VsZWN0b3I6CgkJCQlzZWxlY3Rvci5ub2RlTmFtZSA/ICQoIHNlbGVjdG9yICk6CgkJCQl0aGlzLmRvY3VtZW50LmZpbmQoIHNlbGVjdG9yICk7CgoJCQl0aGlzLl9vbiggc2VhcmNoLCB7CgkJCQlrZXl1cDogIl9vbktleVVwIiwKCQkJCWNoYW5nZTogIl9vbktleVVwIiwKCQkJCWlucHV0OiAiX29uS2V5VXAiCgkJCX0pOwoJCX0KCgkJdGhpcy5fc2VhcmNoID0gc2VhcmNoOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIHJlZmlsdGVyID0gISggKCBvcHRpb25zLmZpbHRlclJldmVhbCA9PT0gdW5kZWZpbmVkICkgJiYKCQkJCSggb3B0aW9ucy5maWx0ZXJDYWxsYmFjayA9PT0gdW5kZWZpbmVkICkgJiYKCQkJCSggb3B0aW9ucy5jaGlsZHJlbiA9PT0gdW5kZWZpbmVkICkgKTsKCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJaWYgKCBvcHRpb25zLmlucHV0ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldElucHV0KCBvcHRpb25zLmlucHV0ICk7CgkJCXJlZmlsdGVyID0gdHJ1ZTsKCQl9CgoJCWlmICggcmVmaWx0ZXIgKSB7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0KCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRzID0gdGhpcy5vcHRpb25zLAoJCQlpdGVtcyA9IHRoaXMuX2dldEZpbHRlcmFibGVJdGVtcygpOwoKCQlpZiAoIG9wdHMuZW5oYW5jZWQgKSB7CgkJCWl0ZW1zLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIG9wdHMuZmlsdGVyUmV2ZWFsICk7CgkJfSBlbHNlIHsKCQkJaXRlbXMucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0KCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLl90aW1lciApIHsKCQkJd2luZG93LmNsZWFyVGltZW91dCggdGhpcy5fdGltZXIgKTsKCQkJdGhpcy5fdGltZXIgPSAwOwoJCX0KCQl0aGlzLl9maWx0ZXJJdGVtcyggKCAoIHRoaXMuX3NlYXJjaCAmJiB0aGlzLl9zZWFyY2gudmFsKCkgKSB8fCAiIiApLnRvTG93ZXJDYXNlKCkgKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIENyZWF0ZSBhIGZ1bmN0aW9uIHRoYXQgd2lsbCByZXBsYWNlIHRoZSBfc2V0T3B0aW9ucyBmdW5jdGlvbiBvZiBhIHdpZGdldCwKLy8gYW5kIHdpbGwgcGFzcyB0aGUgb3B0aW9ucyBvbiB0byB0aGUgaW5wdXQgb2YgdGhlIGZpbHRlcmFibGUuCnZhciByZXBsYWNlU2V0T3B0aW9ucyA9IGZ1bmN0aW9uKCBzZWxmLCBvcmlnICkgewoJCXJldHVybiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJb3JpZy5jYWxsKCB0aGlzLCBvcHRpb25zICk7CgkJCXNlbGYuX3N5bmNUZXh0SW5wdXRPcHRpb25zKCBvcHRpb25zICk7CgkJfTsKCX0sCglyRGl2aWRlckxpc3RJdGVtID0gLyhefFxzKXVpLWxpLWRpdmlkZXIoXHN8JCkvLAoJb3JpZ0RlZmF1bHRGaWx0ZXJDYWxsYmFjayA9ICQubW9iaWxlLmZpbHRlcmFibGUucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2s7CgovLyBPdmVycmlkZSB0aGUgZGVmYXVsdCBmaWx0ZXIgY2FsbGJhY2sgd2l0aCBvbmUgdGhhdCBkb2VzIG5vdCBoaWRlIGxpc3QgZGl2aWRlcnMKJC5tb2JpbGUuZmlsdGVyYWJsZS5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJDYWxsYmFjayA9IGZ1bmN0aW9uKCBpbmRleCwgc2VhcmNoVmFsdWUgKSB7CglyZXR1cm4gIXRoaXMuY2xhc3NOYW1lLm1hdGNoKCByRGl2aWRlckxpc3RJdGVtICkgJiYKCQlvcmlnRGVmYXVsdEZpbHRlckNhbGxiYWNrLmNhbGwoIHRoaXMsIGluZGV4LCBzZWFyY2hWYWx1ZSApOwp9OwoKJC53aWRnZXQoICJtb2JpbGUuZmlsdGVyYWJsZSIsICQubW9iaWxlLmZpbHRlcmFibGUsIHsKCW9wdGlvbnM6IHsKCQlmaWx0ZXJQbGFjZWhvbGRlcjogIkZpbHRlciBpdGVtcy4uLiIsCgkJZmlsdGVyVGhlbWU6IG51bGwKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGlkeCwgd2lkZ2V0TmFtZSwKCQkJZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJcmVjb2duaXplZFdpZGdldHMgPSBbICJjb2xsYXBzaWJsZXNldCIsICJzZWxlY3RtZW51IiwgImNvbnRyb2xncm91cCIsICJsaXN0dmlldyIgXSwKCQkJY3JlYXRlSGFuZGxlcnMgPSB7fTsKCgkJdGhpcy5fc3VwZXIoKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3dpZGdldDogbnVsbAoJCX0pOwoKCQlmb3IgKCBpZHggPSByZWNvZ25pemVkV2lkZ2V0cy5sZW5ndGggLSAxIDsgaWR4ID4gLTEgOyBpZHgtLSApIHsKCQkJd2lkZ2V0TmFtZSA9IHJlY29nbml6ZWRXaWRnZXRzWyBpZHggXTsKCQkJaWYgKCAkLm1vYmlsZVsgd2lkZ2V0TmFtZSBdICkgewoJCQkJaWYgKCB0aGlzLl9zZXRXaWRnZXQoIGVsZW0uZGF0YSggIm1vYmlsZS0iICsgd2lkZ2V0TmFtZSApICkgKSB7CgkJCQkJYnJlYWs7CgkJCQl9IGVsc2UgewoJCQkJCWNyZWF0ZUhhbmRsZXJzWyB3aWRnZXROYW1lICsgImNyZWF0ZSIgXSA9ICJfaGFuZGxlQ3JlYXRlIjsKCQkJCX0KCQkJfQoJCX0KCgkJaWYgKCAhdGhpcy5fd2lkZ2V0ICkgewoJCQl0aGlzLl9vbiggZWxlbSwgY3JlYXRlSGFuZGxlcnMgKTsKCQl9Cgl9LAoKCV9oYW5kbGVDcmVhdGU6IGZ1bmN0aW9uKCBldnQgKSB7CgkJdGhpcy5fc2V0V2lkZ2V0KCB0aGlzLmVsZW1lbnQuZGF0YSggIm1vYmlsZS0iICsgZXZ0LnR5cGUuc3Vic3RyaW5nKCAwLCBldnQudHlwZS5sZW5ndGggLSA2ICkgKSApOwoJfSwKCglfc2V0V2lkZ2V0OiBmdW5jdGlvbiggd2lkZ2V0ICkgewoJCWlmICggIXRoaXMuX3dpZGdldCAmJiB3aWRnZXQgKSB7CgkJCXRoaXMuX3dpZGdldCA9IHdpZGdldDsKCQkJdGhpcy5fd2lkZ2V0Ll9zZXRPcHRpb25zID0gcmVwbGFjZVNldE9wdGlvbnMoIHRoaXMsIHRoaXMuX3dpZGdldC5fc2V0T3B0aW9ucyApOwoJCX0KCgkJaWYgKCAhIXRoaXMuX3dpZGdldCApIHsKCQkJdGhpcy5fc3luY1RleHRJbnB1dE9wdGlvbnMoIHRoaXMuX3dpZGdldC5vcHRpb25zICk7CgkJCWlmICggdGhpcy5fd2lkZ2V0LndpZGdldE5hbWUgPT09ICJsaXN0dmlldyIgKSB7CgkJCQl0aGlzLl93aWRnZXQub3B0aW9ucy5oaWRlZGl2aWRlcnMgPSB0cnVlOwoJCQkJdGhpcy5fd2lkZ2V0LmVsZW1lbnQubGlzdHZpZXcoICJyZWZyZXNoIiApOwoJCQl9CgkJfQoKCQlyZXR1cm4gISF0aGlzLl93aWRnZXQ7Cgl9LAoKCV9pc1NlYXJjaEludGVybmFsOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gKCB0aGlzLl9zZWFyY2ggJiYgdGhpcy5fc2VhcmNoLmpxbURhdGEoICJ1aS1maWx0ZXJhYmxlLSIgKyB0aGlzLnV1aWQgKyAiLWludGVybmFsIiApICk7Cgl9LAoKCV9zZXRJbnB1dDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXZhciBvcHRzID0gdGhpcy5vcHRpb25zLAoJCQl1cGRhdGVQbGFjZWhvbGRlciA9IHRydWUsCgkJCXRleHRpbnB1dE9wdHMgPSB7fTsKCgkJaWYgKCAhc2VsZWN0b3IgKSB7CgkJCWlmICggdGhpcy5faXNTZWFyY2hJbnRlcm5hbCgpICkgewoKCQkJCS8vIElnbm9yZSB0aGUgY2FsbCB0byBzZXQgYSBuZXcgaW5wdXQgaWYgdGhlIHNlbGVjdG9yIGdvZXMgdG8gZmFsc3kgYW5kCgkJCQkvLyB0aGUgY3VycmVudCB0ZXh0aW5wdXQgaXMgYWxyZWFkeSBvZiB0aGUgaW50ZXJuYWxseSBnZW5lcmF0ZWQgdmFyaWV0eS4KCQkJCXJldHVybjsKCQkJfSBlbHNlIHsKCgkJCQkvLyBHZW5lcmF0aW5nIGEgbmV3IHRleHRpbnB1dCB3aWRnZXQuIE5vIG5lZWQgdG8gc2V0IHRoZSBwbGFjZWhvbGRlcgoJCQkJLy8gZnVydGhlciBkb3duIHRoZSBmdW5jdGlvbi4KCQkJCXVwZGF0ZVBsYWNlaG9sZGVyID0gZmFsc2U7CgkJCQlzZWxlY3RvciA9ICQoICI8aW5wdXQgIiArCgkJCQkJImRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGU9J3NlYXJjaCcgIiArCgkJCQkJInBsYWNlaG9sZGVyPSciICsgb3B0cy5maWx0ZXJQbGFjZWhvbGRlciArICInPjwvaW5wdXQ+IiApCgkJCQkJLmpxbURhdGEoICJ1aS1maWx0ZXJhYmxlLSIgKyB0aGlzLnV1aWQgKyAiLWludGVybmFsIiwgdHJ1ZSApOwoJCQkJJCggIjxmb3JtIGNsYXNzPSd1aS1maWx0ZXJhYmxlJz48L2Zvcm0+IiApCgkJCQkJLmFwcGVuZCggc2VsZWN0b3IgKQoJCQkJCS5zdWJtaXQoIGZ1bmN0aW9uKCBldnQgKSB7CgkJCQkJCWV2dC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQlzZWxlY3Rvci5ibHVyKCk7CgkJCQkJfSkKCQkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLmVsZW1lbnQgKTsKCQkJCWlmICggJC5tb2JpbGUudGV4dGlucHV0ICkgewoJCQkJCWlmICggdGhpcy5vcHRpb25zLmZpbHRlclRoZW1lICE9IG51bGwgKSB7CgkJCQkJCXRleHRpbnB1dE9wdHNbICJ0aGVtZSIgXSA9IG9wdHMuZmlsdGVyVGhlbWU7CgkJCQkJfQoKCQkJCQlzZWxlY3Rvci50ZXh0aW5wdXQoIHRleHRpbnB1dE9wdHMgKTsKCQkJCX0KCQkJfQoJCX0KCgkJdGhpcy5fc3VwZXIoIHNlbGVjdG9yICk7CgoJCWlmICggdGhpcy5faXNTZWFyY2hJbnRlcm5hbCgpICYmIHVwZGF0ZVBsYWNlaG9sZGVyICkgewoJCQl0aGlzLl9zZWFyY2guYXR0ciggInBsYWNlaG9sZGVyIiwgdGhpcy5vcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyICk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIHJldCA9IHRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCS8vIE5lZWQgdG8gc2V0IHRoZSBmaWx0ZXJQbGFjZWhvbGRlciBhZnRlciBoYXZpbmcgZXN0YWJsaXNoZWQgdGhlIHNlYXJjaCBpbnB1dAoJCWlmICggb3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlciAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoIHRoaXMuX2lzU2VhcmNoSW50ZXJuYWwoKSApIHsKCQkJCXRoaXMuX3NlYXJjaC5hdHRyKCAicGxhY2Vob2xkZXIiLCBvcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyICk7CgkJCX0KCQl9CgoJCWlmICggb3B0aW9ucy5maWx0ZXJUaGVtZSAhPT0gdW5kZWZpbmVkICYmIHRoaXMuX3NlYXJjaCAmJiAkLm1vYmlsZS50ZXh0aW5wdXQgKSB7CgkJCXRoaXMuX3NlYXJjaC50ZXh0aW5wdXQoICJvcHRpb24iLCAidGhlbWUiLCBvcHRpb25zLmZpbHRlclRoZW1lICk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLl9pc1NlYXJjaEludGVybmFsKCkgKSB7CgkJCXRoaXMuX3NlYXJjaC5yZW1vdmUoKTsKCQl9CgkJdGhpcy5fc3VwZXIoKTsKCX0sCgoJX3N5bmNUZXh0SW5wdXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaWR4LAoJCQl0ZXh0aW5wdXRPcHRpb25zID0ge307CgoJCS8vIFdlIG9ubHkgc3luYyBvcHRpb25zIGlmIHRoZSBmaWx0ZXJhYmxlJ3MgdGV4dGlucHV0IGlzIG9mIHRoZSBpbnRlcm5hbGx5CgkJLy8gZ2VuZXJhdGVkIHZhcmlldHksIHJhdGhlciB0aGFuIG9uZSBzcGVjaWZpZWQgYnkgdGhlIHVzZXIuCgkJaWYgKCB0aGlzLl9pc1NlYXJjaEludGVybmFsKCkgJiYgJC5tb2JpbGUudGV4dGlucHV0ICkgewoKCQkJLy8gQXBwbHkgb25seSB0aGUgb3B0aW9ucyB1bmRlcnN0b29kIGJ5IHRleHRpbnB1dAoJCQlmb3IgKCBpZHggaW4gJC5tb2JpbGUudGV4dGlucHV0LnByb3RvdHlwZS5vcHRpb25zICkgewoJCQkJaWYgKCBvcHRpb25zWyBpZHggXSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCWlmICggaWR4ID09PSAidGhlbWUiICYmIHRoaXMub3B0aW9ucy5maWx0ZXJUaGVtZSAhPSBudWxsICkgewoJCQkJCQl0ZXh0aW5wdXRPcHRpb25zWyBpZHggXSA9IHRoaXMub3B0aW9ucy5maWx0ZXJUaGVtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0ZXh0aW5wdXRPcHRpb25zWyBpZHggXSA9IG9wdGlvbnNbIGlkeCBdOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQl0aGlzLl9zZWFyY2gudGV4dGlucHV0KCAib3B0aW9uIiwgdGV4dGlucHV0T3B0aW9ucyApOwoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgovKiEKICogalF1ZXJ5IFVJIFRhYnMgZmFkZjJiMzEyYTA1MDQwNDM2NDUxYzY0YmJmYWY0ODE0YmM2MmM1NgogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL3RhYnMvCiAqCiAqIERlcGVuZHM6CiAqCWpxdWVyeS51aS5jb3JlLmpzCiAqCWpxdWVyeS51aS53aWRnZXQuanMKICovCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHRhYklkID0gMCwKCXJoYXNoID0gLyMuKiQvOwoKZnVuY3Rpb24gZ2V0TmV4dFRhYklkKCkgewoJcmV0dXJuICsrdGFiSWQ7Cn0KCmZ1bmN0aW9uIGlzTG9jYWwoIGFuY2hvciApIHsKCXJldHVybiBhbmNob3IuaGFzaC5sZW5ndGggPiAxICYmCgkJZGVjb2RlVVJJQ29tcG9uZW50KCBhbmNob3IuaHJlZi5yZXBsYWNlKCByaGFzaCwgIiIgKSApID09PQoJCQlkZWNvZGVVUklDb21wb25lbnQoIGxvY2F0aW9uLmhyZWYucmVwbGFjZSggcmhhc2gsICIiICkgKTsKfQoKJC53aWRnZXQoICJ1aS50YWJzIiwgewoJdmVyc2lvbjogImZhZGYyYjMxMmEwNTA0MDQzNjQ1MWM2NGJiZmFmNDgxNGJjNjJjNTYiLAoJZGVsYXk6IDMwMCwKCW9wdGlvbnM6IHsKCQlhY3RpdmU6IG51bGwsCgkJY29sbGFwc2libGU6IGZhbHNlLAoJCWV2ZW50OiAiY2xpY2siLAoJCWhlaWdodFN0eWxlOiAiY29udGVudCIsCgkJaGlkZTogbnVsbCwKCQlzaG93OiBudWxsLAoKCQkvLyBjYWxsYmFja3MKCQlhY3RpdmF0ZTogbnVsbCwKCQliZWZvcmVBY3RpdmF0ZTogbnVsbCwKCQliZWZvcmVMb2FkOiBudWxsLAoJCWxvYWQ6IG51bGwKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQl0aGlzLnJ1bm5pbmcgPSBmYWxzZTsKCgkJdGhpcy5lbGVtZW50CgkJCS5hZGRDbGFzcyggInVpLXRhYnMgdWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1hbGwiICkKCQkJLnRvZ2dsZUNsYXNzKCAidWktdGFicy1jb2xsYXBzaWJsZSIsIG9wdGlvbnMuY29sbGFwc2libGUgKQoJCQkvLyBQcmV2ZW50IHVzZXJzIGZyb20gZm9jdXNpbmcgZGlzYWJsZWQgdGFicyB2aWEgY2xpY2sKCQkJLmRlbGVnYXRlKCAiLnVpLXRhYnMtbmF2ID4gbGkiLCAibW91c2Vkb3duIiArIHRoaXMuZXZlbnROYW1lc3BhY2UsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggJCggdGhpcyApLmlzKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0pCgkJCS8vIHN1cHBvcnQ6IElFIDw5CgkJCS8vIFByZXZlbnRpbmcgdGhlIGRlZmF1bHQgYWN0aW9uIGluIG1vdXNlZG93biBkb2Vzbid0IHByZXZlbnQgSUUKCQkJLy8gZnJvbSBmb2N1c2luZyB0aGUgZWxlbWVudCwgc28gaWYgdGhlIGFuY2hvciBnZXRzIGZvY3VzZWQsIGJsdXIuCgkJCS8vIFdlIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgZm9jdXNpbmcgdGhlIHByZXZpb3VzbHkgZm9jdXNlZAoJCQkvLyBlbGVtZW50IHNpbmNlIGNsaWNraW5nIG9uIGEgbm9uLWZvY3VzYWJsZSBlbGVtZW50IHNob3VsZCBmb2N1cwoJCQkvLyB0aGUgYm9keSBhbnl3YXkuCgkJCS5kZWxlZ2F0ZSggIi51aS10YWJzLWFuY2hvciIsICJmb2N1cyIgKyB0aGlzLmV2ZW50TmFtZXNwYWNlLCBmdW5jdGlvbigpIHsKCQkJCWlmICggJCggdGhpcyApLmNsb3Nlc3QoICJsaSIgKS5pcyggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSApIHsKCQkJCQl0aGlzLmJsdXIoKTsKCQkJCX0KCQkJfSk7CgoJCXRoaXMuX3Byb2Nlc3NUYWJzKCk7CgkJb3B0aW9ucy5hY3RpdmUgPSB0aGlzLl9pbml0aWFsQWN0aXZlKCk7CgoJCS8vIFRha2UgZGlzYWJsaW5nIHRhYnMgdmlhIGNsYXNzIGF0dHJpYnV0ZSBmcm9tIEhUTUwKCQkvLyBpbnRvIGFjY291bnQgYW5kIHVwZGF0ZSBvcHRpb24gcHJvcGVybHkuCgkJaWYgKCAkLmlzQXJyYXkoIG9wdGlvbnMuZGlzYWJsZWQgKSApIHsKCQkJb3B0aW9ucy5kaXNhYmxlZCA9ICQudW5pcXVlKCBvcHRpb25zLmRpc2FibGVkLmNvbmNhdCgKCQkJCSQubWFwKCB0aGlzLnRhYnMuZmlsdGVyKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApLCBmdW5jdGlvbiggbGkgKSB7CgkJCQkJcmV0dXJuIHRoYXQudGFicy5pbmRleCggbGkgKTsKCQkJCX0pCgkJCSkgKS5zb3J0KCk7CgkJfQoKCQkvLyBjaGVjayBmb3IgbGVuZ3RoIGF2b2lkcyBlcnJvciB3aGVuIGluaXRpYWxpemluZyBlbXB0eSBsaXN0CgkJaWYgKCB0aGlzLm9wdGlvbnMuYWN0aXZlICE9PSBmYWxzZSAmJiB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQl0aGlzLmFjdGl2ZSA9IHRoaXMuX2ZpbmRBY3RpdmUoIG9wdGlvbnMuYWN0aXZlICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5hY3RpdmUgPSAkKCk7CgkJfQoKCQl0aGlzLl9yZWZyZXNoKCk7CgoJCWlmICggdGhpcy5hY3RpdmUubGVuZ3RoICkgewoJCQl0aGlzLmxvYWQoIG9wdGlvbnMuYWN0aXZlICk7CgkJfQoJfSwKCglfaW5pdGlhbEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGFjdGl2ZSA9IHRoaXMub3B0aW9ucy5hY3RpdmUsCgkJCWNvbGxhcHNpYmxlID0gdGhpcy5vcHRpb25zLmNvbGxhcHNpYmxlLAoJCQlsb2NhdGlvbkhhc2ggPSBsb2NhdGlvbi5oYXNoLnN1YnN0cmluZyggMSApOwoKCQlpZiAoIGFjdGl2ZSA9PT0gbnVsbCApIHsKCQkJLy8gY2hlY2sgdGhlIGZyYWdtZW50IGlkZW50aWZpZXIgaW4gdGhlIFVSTAoJCQlpZiAoIGxvY2F0aW9uSGFzaCApIHsKCQkJCXRoaXMudGFicy5lYWNoKGZ1bmN0aW9uKCBpLCB0YWIgKSB7CgkJCQkJaWYgKCAkKCB0YWIgKS5hdHRyKCAiYXJpYS1jb250cm9scyIgKSA9PT0gbG9jYXRpb25IYXNoICkgewoJCQkJCQlhY3RpdmUgPSBpOwoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCgkJCS8vIGNoZWNrIGZvciBhIHRhYiBtYXJrZWQgYWN0aXZlIHZpYSBhIGNsYXNzCgkJCWlmICggYWN0aXZlID09PSBudWxsICkgewoJCQkJYWN0aXZlID0gdGhpcy50YWJzLmluZGV4KCB0aGlzLnRhYnMuZmlsdGVyKCAiLnVpLXRhYnMtYWN0aXZlIiApICk7CgkJCX0KCgkJCS8vIG5vIGFjdGl2ZSB0YWIsIHNldCB0byBmYWxzZQoJCQlpZiAoIGFjdGl2ZSA9PT0gbnVsbCB8fCBhY3RpdmUgPT09IC0xICkgewoJCQkJYWN0aXZlID0gdGhpcy50YWJzLmxlbmd0aCA/IDAgOiBmYWxzZTsKCQkJfQoJCX0KCgkJLy8gaGFuZGxlIG51bWJlcnM6IG5lZ2F0aXZlLCBvdXQgb2YgcmFuZ2UKCQlpZiAoIGFjdGl2ZSAhPT0gZmFsc2UgKSB7CgkJCWFjdGl2ZSA9IHRoaXMudGFicy5pbmRleCggdGhpcy50YWJzLmVxKCBhY3RpdmUgKSApOwoJCQlpZiAoIGFjdGl2ZSA9PT0gLTEgKSB7CgkJCQlhY3RpdmUgPSBjb2xsYXBzaWJsZSA/IGZhbHNlIDogMDsKCQkJfQoJCX0KCgkJLy8gZG9uJ3QgYWxsb3cgY29sbGFwc2libGU6IGZhbHNlIGFuZCBhY3RpdmU6IGZhbHNlCgkJaWYgKCAhY29sbGFwc2libGUgJiYgYWN0aXZlID09PSBmYWxzZSAmJiB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQlhY3RpdmUgPSAwOwoJCX0KCgkJcmV0dXJuIGFjdGl2ZTsKCX0sCgoJX2dldENyZWF0ZUV2ZW50RGF0YTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHsKCQkJdGFiOiB0aGlzLmFjdGl2ZSwKCQkJcGFuZWw6ICF0aGlzLmFjdGl2ZS5sZW5ndGggPyAkKCkgOiB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGhpcy5hY3RpdmUgKQoJCX07Cgl9LAoKCV90YWJLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGZvY3VzZWRUYWIgPSAkKCB0aGlzLmRvY3VtZW50WzBdLmFjdGl2ZUVsZW1lbnQgKS5jbG9zZXN0KCAibGkiICksCgkJCXNlbGVjdGVkSW5kZXggPSB0aGlzLnRhYnMuaW5kZXgoIGZvY3VzZWRUYWIgKSwKCQkJZ29pbmdGb3J3YXJkID0gdHJ1ZTsKCgkJaWYgKCB0aGlzLl9oYW5kbGVQYWdlTmF2KCBldmVudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCSAgICBjYXNlICQudWkua2V5Q29kZS5MRUZUOgoJCQljYXNlICQudWkua2V5Q29kZS5ET1dOOgoJCQkJc2VsZWN0ZWRJbmRleCsrOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC51aS5rZXlDb2RlLlVQOgoJCSAgICBjYXNlICQudWkua2V5Q29kZS5SSUdIVDogCgkJCQlnb2luZ0ZvcndhcmQgPSBmYWxzZTsKCQkJCXNlbGVjdGVkSW5kZXgtLTsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5FTkQ6CgkJCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5hbmNob3JzLmxlbmd0aCAtIDE7CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuSE9NRToKCQkJCXNlbGVjdGVkSW5kZXggPSAwOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC51aS5rZXlDb2RlLlNQQUNFOgoJCQkJLy8gQWN0aXZhdGUgb25seSwgbm8gY29sbGFwc2luZwoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWNsZWFyVGltZW91dCggdGhpcy5hY3RpdmF0aW5nICk7CgkJCQl0aGlzLl9hY3RpdmF0ZSggc2VsZWN0ZWRJbmRleCApOwoJCQkJcmV0dXJuOwoJCQljYXNlICQudWkua2V5Q29kZS5FTlRFUjoKCQkJCS8vIFRvZ2dsZSAoY2FuY2VsIGRlbGF5ZWQgYWN0aXZhdGlvbiwgYWxsb3cgY29sbGFwc2luZykKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQljbGVhclRpbWVvdXQoIHRoaXMuYWN0aXZhdGluZyApOwoJCQkJLy8gRGV0ZXJtaW5lIGlmIHdlIHNob3VsZCBjb2xsYXBzZSBvciBhY3RpdmF0ZQoJCQkJdGhpcy5fYWN0aXZhdGUoIHNlbGVjdGVkSW5kZXggPT09IHRoaXMub3B0aW9ucy5hY3RpdmUgPyBmYWxzZSA6IHNlbGVjdGVkSW5kZXggKTsKCQkJCXJldHVybjsKCQkJZGVmYXVsdDoKCQkJCXJldHVybjsKCQl9CgoJCS8vIEZvY3VzIHRoZSBhcHByb3ByaWF0ZSB0YWIsIGJhc2VkIG9uIHdoaWNoIGtleSB3YXMgcHJlc3NlZAoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJY2xlYXJUaW1lb3V0KCB0aGlzLmFjdGl2YXRpbmcgKTsKCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5fZm9jdXNOZXh0VGFiKCBzZWxlY3RlZEluZGV4LCBnb2luZ0ZvcndhcmQgKTsKCgkJLy8gTmF2aWdhdGluZyB3aXRoIGNvbnRyb2wga2V5IHdpbGwgcHJldmVudCBhdXRvbWF0aWMgYWN0aXZhdGlvbgoJCWlmICggIWV2ZW50LmN0cmxLZXkgKSB7CgkJCS8vIFVwZGF0ZSBhcmlhLXNlbGVjdGVkIGltbWVkaWF0ZWx5IHNvIHRoYXQgQVQgdGhpbmsgdGhlIHRhYiBpcyBhbHJlYWR5IHNlbGVjdGVkLgoJCQkvLyBPdGhlcndpc2UgQVQgbWF5IGNvbmZ1c2UgdGhlIHVzZXIgYnkgc3RhdGluZyB0aGF0IHRoZXkgbmVlZCB0byBhY3RpdmF0ZSB0aGUgdGFiLAoJCQkvLyBidXQgdGhlIHRhYiB3aWxsIGFscmVhZHkgYmUgYWN0aXZhdGVkIGJ5IHRoZSB0aW1lIHRoZSBhbm5vdW5jZW1lbnQgZmluaXNoZXMuCgkJCWZvY3VzZWRUYWIuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCAiZmFsc2UiICk7CgkJCXRoaXMudGFicy5lcSggc2VsZWN0ZWRJbmRleCApLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgInRydWUiICk7CgoJCQl0aGlzLmFjdGl2YXRpbmcgPSB0aGlzLl9kZWxheShmdW5jdGlvbigpIHsKCQkJCXRoaXMub3B0aW9uKCAiYWN0aXZlIiwgc2VsZWN0ZWRJbmRleCApOwoJCQl9LCB0aGlzLmRlbGF5ICk7CgkJfQoJfSwKCglfcGFuZWxLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLl9oYW5kbGVQYWdlTmF2KCBldmVudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBDdHJsK3VwIG1vdmVzIGZvY3VzIHRvIHRoZSBjdXJyZW50IHRhYgoJCWlmICggZXZlbnQuY3RybEtleSAmJiBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuVVAgKSB7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCXRoaXMuYWN0aXZlLmZvY3VzKCk7CgkJfQoJfSwKCgkvLyBBbHQrcGFnZSB1cC9kb3duIG1vdmVzIGZvY3VzIHRvIHRoZSBwcmV2aW91cy9uZXh0IHRhYiAoYW5kIGFjdGl2YXRlcykKCV9oYW5kbGVQYWdlTmF2OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCBldmVudC5hbHRLZXkgJiYgZXZlbnQua2V5Q29kZSA9PT0gJC51aS5rZXlDb2RlLlBBR0VfVVAgKSB7CgkJCXRoaXMuX2FjdGl2YXRlKCB0aGlzLl9mb2N1c05leHRUYWIoIHRoaXMub3B0aW9ucy5hY3RpdmUgLSAxLCBmYWxzZSApICk7CgkJCXJldHVybiB0cnVlOwoJCX0KCQlpZiAoIGV2ZW50LmFsdEtleSAmJiBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuUEFHRV9ET1dOICkgewoJCQl0aGlzLl9hY3RpdmF0ZSggdGhpcy5fZm9jdXNOZXh0VGFiKCB0aGlzLm9wdGlvbnMuYWN0aXZlICsgMSwgdHJ1ZSApICk7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0sCgoJX2ZpbmROZXh0VGFiOiBmdW5jdGlvbiggaW5kZXgsIGdvaW5nRm9yd2FyZCApIHsKCQl2YXIgbGFzdFRhYkluZGV4ID0gdGhpcy50YWJzLmxlbmd0aCAtIDE7CgoJCWZ1bmN0aW9uIGNvbnN0cmFpbigpIHsKCQkJaWYgKCBpbmRleCA+IGxhc3RUYWJJbmRleCApIHsKCQkJCWluZGV4ID0gMDsKCQkJfQoJCQlpZiAoIGluZGV4IDwgMCApIHsKCQkJCWluZGV4ID0gbGFzdFRhYkluZGV4OwoJCQl9CgkJCXJldHVybiBpbmRleDsKCQl9CgoJCXdoaWxlICggJC5pbkFycmF5KCBjb25zdHJhaW4oKSwgdGhpcy5vcHRpb25zLmRpc2FibGVkICkgIT09IC0xICkgewoJCQlpbmRleCA9IGdvaW5nRm9yd2FyZCA/IGluZGV4ICsgMSA6IGluZGV4IC0gMTsKCQl9CgoJCXJldHVybiBpbmRleDsKCX0sCgoJX2ZvY3VzTmV4dFRhYjogZnVuY3Rpb24oIGluZGV4LCBnb2luZ0ZvcndhcmQgKSB7CgkJaW5kZXggPSB0aGlzLl9maW5kTmV4dFRhYiggaW5kZXgsIGdvaW5nRm9yd2FyZCApOwoJCXRoaXMudGFicy5lcSggaW5kZXggKS5mb2N1cygpOwoJCXJldHVybiBpbmRleDsKCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJaWYgKCBrZXkgPT09ICJhY3RpdmUiICkgewoJCQkvLyBfYWN0aXZhdGUoKSB3aWxsIGhhbmRsZSBpbnZhbGlkIHZhbHVlcyBhbmQgdXBkYXRlIHRoaXMub3B0aW9ucwoJCQl0aGlzLl9hY3RpdmF0ZSggdmFsdWUgKTsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7CgkJCS8vIGRvbid0IHVzZSB0aGUgd2lkZ2V0IGZhY3RvcnkncyBkaXNhYmxlZCBoYW5kbGluZwoJCQl0aGlzLl9zZXR1cERpc2FibGVkKCB2YWx1ZSApOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSk7CgoJCWlmICgga2V5ID09PSAiY29sbGFwc2libGUiICkgewoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS10YWJzLWNvbGxhcHNpYmxlIiwgdmFsdWUgKTsKCQkJLy8gU2V0dGluZyBjb2xsYXBzaWJsZTogZmFsc2Ugd2hpbGUgY29sbGFwc2VkOyBvcGVuIGZpcnN0IHBhbmVsCgkJCWlmICggIXZhbHVlICYmIHRoaXMub3B0aW9ucy5hY3RpdmUgPT09IGZhbHNlICkgewoJCQkJdGhpcy5fYWN0aXZhdGUoIDAgKTsKCQkJfQoJCX0KCgkJaWYgKCBrZXkgPT09ICJldmVudCIgKSB7CgkJCXRoaXMuX3NldHVwRXZlbnRzKCB2YWx1ZSApOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJoZWlnaHRTdHlsZSIgKSB7CgkJCXRoaXMuX3NldHVwSGVpZ2h0U3R5bGUoIHZhbHVlICk7CgkJfQoJfSwKCglfdGFiSWQ6IGZ1bmN0aW9uKCB0YWIgKSB7CgkJcmV0dXJuIHRhYi5hdHRyKCAiYXJpYS1jb250cm9scyIgKSB8fCAidWktdGFicy0iICsgZ2V0TmV4dFRhYklkKCk7Cgl9LAoKCV9zYW5pdGl6ZVNlbGVjdG9yOiBmdW5jdGlvbiggaGFzaCApIHsKCQlyZXR1cm4gaGFzaCA/IGhhc2gucmVwbGFjZSggL1shIiQlJicoKSorLC5cLzo7PD0+P0BcW1xdXF5ge3x9fl0vZywgIlxcJCYiICkgOiAiIjsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWxpcyA9IHRoaXMudGFibGlzdC5jaGlsZHJlbiggIjpoYXMoYVtocmVmXSkiICk7CgoJCS8vIGdldCBkaXNhYmxlZCB0YWJzIGZyb20gY2xhc3MgYXR0cmlidXRlIGZyb20gSFRNTAoJCS8vIHRoaXMgd2lsbCBnZXQgY29udmVydGVkIHRvIGEgYm9vbGVhbiBpZiBuZWVkZWQgaW4gX3JlZnJlc2goKQoJCW9wdGlvbnMuZGlzYWJsZWQgPSAkLm1hcCggbGlzLmZpbHRlciggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSwgZnVuY3Rpb24oIHRhYiApIHsKCQkJcmV0dXJuIGxpcy5pbmRleCggdGFiICk7CgkJfSk7CgoJCXRoaXMuX3Byb2Nlc3NUYWJzKCk7CgoJCS8vIHdhcyBjb2xsYXBzZWQgb3Igbm8gdGFicwoJCWlmICggb3B0aW9ucy5hY3RpdmUgPT09IGZhbHNlIHx8ICF0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQlvcHRpb25zLmFjdGl2ZSA9IGZhbHNlOwoJCQl0aGlzLmFjdGl2ZSA9ICQoKTsKCQkvLyB3YXMgYWN0aXZlLCBidXQgYWN0aXZlIHRhYiBpcyBnb25lCgkJfSBlbHNlIGlmICggdGhpcy5hY3RpdmUubGVuZ3RoICYmICEkLmNvbnRhaW5zKCB0aGlzLnRhYmxpc3RbIDAgXSwgdGhpcy5hY3RpdmVbIDAgXSApICkgewoJCQkvLyBhbGwgcmVtYWluaW5nIHRhYnMgYXJlIGRpc2FibGVkCgkJCWlmICggdGhpcy50YWJzLmxlbmd0aCA9PT0gb3B0aW9ucy5kaXNhYmxlZC5sZW5ndGggKSB7CgkJCQlvcHRpb25zLmFjdGl2ZSA9IGZhbHNlOwoJCQkJdGhpcy5hY3RpdmUgPSAkKCk7CgkJCS8vIGFjdGl2YXRlIHByZXZpb3VzIHRhYgoJCQl9IGVsc2UgewoJCQkJdGhpcy5fYWN0aXZhdGUoIHRoaXMuX2ZpbmROZXh0VGFiKCBNYXRoLm1heCggMCwgb3B0aW9ucy5hY3RpdmUgLSAxICksIGZhbHNlICkgKTsKCQkJfQoJCS8vIHdhcyBhY3RpdmUsIGFjdGl2ZSB0YWIgc3RpbGwgZXhpc3RzCgkJfSBlbHNlIHsKCQkJLy8gbWFrZSBzdXJlIGFjdGl2ZSBpbmRleCBpcyBjb3JyZWN0CgkJCW9wdGlvbnMuYWN0aXZlID0gdGhpcy50YWJzLmluZGV4KCB0aGlzLmFjdGl2ZSApOwoJCX0KCgkJdGhpcy5fcmVmcmVzaCgpOwoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0dXBEaXNhYmxlZCggdGhpcy5vcHRpb25zLmRpc2FibGVkICk7CgkJdGhpcy5fc2V0dXBFdmVudHMoIHRoaXMub3B0aW9ucy5ldmVudCApOwoJCXRoaXMuX3NldHVwSGVpZ2h0U3R5bGUoIHRoaXMub3B0aW9ucy5oZWlnaHRTdHlsZSApOwoKCQl0aGlzLnRhYnMubm90KCB0aGlzLmFjdGl2ZSApLmF0dHIoewoJCQkiYXJpYS1zZWxlY3RlZCI6ICJmYWxzZSIsCgkJCXRhYkluZGV4OiAtMQoJCX0pOwoJCXRoaXMucGFuZWxzLm5vdCggdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIHRoaXMuYWN0aXZlICkgKQoJCQkuaGlkZSgpCgkJCS5hdHRyKHsKCQkJCSJhcmlhLWV4cGFuZGVkIjogImZhbHNlIiwKCQkJCSJhcmlhLWhpZGRlbiI6ICJ0cnVlIgoJCQl9KTsKCgkJLy8gTWFrZSBzdXJlIG9uZSB0YWIgaXMgaW4gdGhlIHRhYiBvcmRlcgoJCWlmICggIXRoaXMuYWN0aXZlLmxlbmd0aCApIHsKCQkJdGhpcy50YWJzLmVxKCAwICkuYXR0ciggInRhYkluZGV4IiwgMCApOwoJCX0gZWxzZSB7CgkJCXRoaXMuYWN0aXZlCgkJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLWFjdGl2ZSB1aS1zdGF0ZS1hY3RpdmUiICkKCQkJCS5hdHRyKHsKCQkJCQkiYXJpYS1zZWxlY3RlZCI6ICJ0cnVlIiwKCQkJCQl0YWJJbmRleDogMAoJCQkJfSk7CgkJCXRoaXMuX2dldFBhbmVsRm9yVGFiKCB0aGlzLmFjdGl2ZSApCgkJCQkuc2hvdygpCgkJCQkuYXR0cih7CgkJCQkJImFyaWEtZXhwYW5kZWQiOiAidHJ1ZSIsCgkJCQkJImFyaWEtaGlkZGVuIjogImZhbHNlIgoJCQkJfSk7CgkJfQoJfSwKCglfcHJvY2Vzc1RhYnM6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gdGhpczsKCgkJdGhpcy50YWJsaXN0ID0gdGhpcy5fZ2V0TGlzdCgpCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtbmF2IHVpLWhlbHBlci1yZXNldCB1aS1oZWxwZXItY2xlYXJmaXggdWktd2lkZ2V0LWhlYWRlciB1aS1jb3JuZXItYWxsIiApCgkJCS5hdHRyKCAicm9sZSIsICJ0YWJsaXN0IiApOwoKCQl0aGlzLnRhYnMgPSB0aGlzLnRhYmxpc3QuZmluZCggIj4gbGk6aGFzKGFbaHJlZl0pIiApCgkJCS5hZGRDbGFzcyggInVpLXN0YXRlLWRlZmF1bHQgdWktY29ybmVyLXRvcCIgKQoJCQkuYXR0cih7CgkJCQlyb2xlOiAidGFiIiwKCQkJCXRhYkluZGV4OiAtMQoJCQl9KTsKCgkJdGhpcy5hbmNob3JzID0gdGhpcy50YWJzLm1hcChmdW5jdGlvbigpIHsKCQkJCXJldHVybiAkKCAiYSIsIHRoaXMgKVsgMCBdOwoJCQl9KQoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLWFuY2hvciIgKQoJCQkuYXR0cih7CgkJCQlyb2xlOiAicHJlc2VudGF0aW9uIiwKCQkJCXRhYkluZGV4OiAtMQoJCQl9KTsKCgkJdGhpcy5wYW5lbHMgPSAkKCk7CgoJCXRoaXMuYW5jaG9ycy5lYWNoKGZ1bmN0aW9uKCBpLCBhbmNob3IgKSB7CgkJCXZhciBzZWxlY3RvciwgcGFuZWwsIHBhbmVsSWQsCgkJCQlhbmNob3JJZCA9ICQoIGFuY2hvciApLnVuaXF1ZUlkKCkuYXR0ciggImlkIiApLAoJCQkJdGFiID0gJCggYW5jaG9yICkuY2xvc2VzdCggImxpIiApLAoJCQkJb3JpZ2luYWxBcmlhQ29udHJvbHMgPSB0YWIuYXR0ciggImFyaWEtY29udHJvbHMiICk7CgoJCQkvLyBpbmxpbmUgdGFiCgkJCWlmICggaXNMb2NhbCggYW5jaG9yICkgKSB7CgkJCQlzZWxlY3RvciA9IGFuY2hvci5oYXNoOwoJCQkJcGFuZWwgPSB0aGF0LmVsZW1lbnQuZmluZCggdGhhdC5fc2FuaXRpemVTZWxlY3Rvciggc2VsZWN0b3IgKSApOwoJCQkvLyByZW1vdGUgdGFiCgkJCX0gZWxzZSB7CgkJCQlwYW5lbElkID0gdGhhdC5fdGFiSWQoIHRhYiApOwoJCQkJc2VsZWN0b3IgPSAiIyIgKyBwYW5lbElkOwoJCQkJcGFuZWwgPSB0aGF0LmVsZW1lbnQuZmluZCggc2VsZWN0b3IgKTsKCQkJCWlmICggIXBhbmVsLmxlbmd0aCApIHsKCQkJCQlwYW5lbCA9IHRoYXQuX2NyZWF0ZVBhbmVsKCBwYW5lbElkICk7CgkJCQkJcGFuZWwuaW5zZXJ0QWZ0ZXIoIHRoYXQucGFuZWxzWyBpIC0gMSBdIHx8IHRoYXQudGFibGlzdCApOwoJCQkJfQoJCQkJcGFuZWwuYXR0ciggImFyaWEtbGl2ZSIsICJwb2xpdGUiICk7CgkJCX0KCgkJCWlmICggcGFuZWwubGVuZ3RoKSB7CgkJCQl0aGF0LnBhbmVscyA9IHRoYXQucGFuZWxzLmFkZCggcGFuZWwgKTsKCQkJfQoJCQlpZiAoIG9yaWdpbmFsQXJpYUNvbnRyb2xzICkgewoJCQkJdGFiLmRhdGEoICJ1aS10YWJzLWFyaWEtY29udHJvbHMiLCBvcmlnaW5hbEFyaWFDb250cm9scyApOwoJCQl9CgkJCXRhYi5hdHRyKHsKCQkJCSJhcmlhLWNvbnRyb2xzIjogc2VsZWN0b3Iuc3Vic3RyaW5nKCAxICksCgkJCQkiYXJpYS1sYWJlbGxlZGJ5IjogYW5jaG9ySWQKCQkJfSk7CgkJCXBhbmVsLmF0dHIoICJhcmlhLWxhYmVsbGVkYnkiLCBhbmNob3JJZCApOwoJCX0pOwoKCQl0aGlzLnBhbmVscwoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLXBhbmVsIHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1ib3R0b20iICkKCQkJLmF0dHIoICJyb2xlIiwgInRhYnBhbmVsIiApOwoJfSwKCgkvLyBhbGxvdyBvdmVycmlkaW5nIGhvdyB0byBmaW5kIHRoZSBsaXN0IGZvciByYXJlIHVzYWdlIHNjZW5hcmlvcyAoIzc3MTUpCglfZ2V0TGlzdDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudC5maW5kKCAib2wsdWwiICkuZXEoIDAgKTsKCX0sCgoJX2NyZWF0ZVBhbmVsOiBmdW5jdGlvbiggaWQgKSB7CgkJcmV0dXJuICQoICI8ZGl2PiIgKQoJCQkuYXR0ciggImlkIiwgaWQgKQoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLXBhbmVsIHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1ib3R0b20iICkKCQkJLmRhdGEoICJ1aS10YWJzLWRlc3Ryb3kiLCB0cnVlICk7Cgl9LAoKCV9zZXR1cERpc2FibGVkOiBmdW5jdGlvbiggZGlzYWJsZWQgKSB7CgkJaWYgKCAkLmlzQXJyYXkoIGRpc2FibGVkICkgKSB7CgkJCWlmICggIWRpc2FibGVkLmxlbmd0aCApIHsKCQkJCWRpc2FibGVkID0gZmFsc2U7CgkJCX0gZWxzZSBpZiAoIGRpc2FibGVkLmxlbmd0aCA9PT0gdGhpcy5hbmNob3JzLmxlbmd0aCApIHsKCQkJCWRpc2FibGVkID0gdHJ1ZTsKCQkJfQoJCX0KCgkJLy8gZGlzYWJsZSB0YWJzCgkJZm9yICggdmFyIGkgPSAwLCBsaTsgKCBsaSA9IHRoaXMudGFic1sgaSBdICk7IGkrKyApIHsKCQkJaWYgKCBkaXNhYmxlZCA9PT0gdHJ1ZSB8fCAkLmluQXJyYXkoIGksIGRpc2FibGVkICkgIT09IC0xICkgewoJCQkJJCggbGkgKQoJCQkJCS5hZGRDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApCgkJCQkJLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgInRydWUiICk7CgkJCX0gZWxzZSB7CgkJCQkkKCBsaSApCgkJCQkJLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICk7CgkJCX0KCQl9CgoJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IGRpc2FibGVkOwoJfSwKCglfc2V0dXBFdmVudHM6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgZXZlbnRzID0gewoJCQljbGljazogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCX07CgkJaWYgKCBldmVudCApIHsKCQkJJC5lYWNoKCBldmVudC5zcGxpdCgiICIpLCBmdW5jdGlvbiggaW5kZXgsIGV2ZW50TmFtZSApIHsKCQkJCWV2ZW50c1sgZXZlbnROYW1lIF0gPSAiX2V2ZW50SGFuZGxlciI7CgkJCX0pOwoJCX0KCgkJdGhpcy5fb2ZmKCB0aGlzLmFuY2hvcnMuYWRkKCB0aGlzLnRhYnMgKS5hZGQoIHRoaXMucGFuZWxzICkgKTsKCQl0aGlzLl9vbiggdGhpcy5hbmNob3JzLCBldmVudHMgKTsKCQl0aGlzLl9vbiggdGhpcy50YWJzLCB7IGtleWRvd246ICJfdGFiS2V5ZG93biIgfSApOwoJCXRoaXMuX29uKCB0aGlzLnBhbmVscywgeyBrZXlkb3duOiAiX3BhbmVsS2V5ZG93biIgfSApOwoKCQl0aGlzLl9mb2N1c2FibGUoIHRoaXMudGFicyApOwoJCXRoaXMuX2hvdmVyYWJsZSggdGhpcy50YWJzICk7Cgl9LAoKCV9zZXR1cEhlaWdodFN0eWxlOiBmdW5jdGlvbiggaGVpZ2h0U3R5bGUgKSB7CgkJdmFyIG1heEhlaWdodCwKCQkJcGFyZW50ID0gdGhpcy5lbGVtZW50LnBhcmVudCgpOwoKCQlpZiAoIGhlaWdodFN0eWxlID09PSAiZmlsbCIgKSB7CgkJCW1heEhlaWdodCA9IHBhcmVudC5oZWlnaHQoKTsKCQkJbWF4SGVpZ2h0IC09IHRoaXMuZWxlbWVudC5vdXRlckhlaWdodCgpIC0gdGhpcy5lbGVtZW50LmhlaWdodCgpOwoKCQkJdGhpcy5lbGVtZW50LnNpYmxpbmdzKCAiOnZpc2libGUiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBlbGVtID0gJCggdGhpcyApLAoJCQkJCXBvc2l0aW9uID0gZWxlbS5jc3MoICJwb3NpdGlvbiIgKTsKCgkJCQlpZiAoIHBvc2l0aW9uID09PSAiYWJzb2x1dGUiIHx8IHBvc2l0aW9uID09PSAiZml4ZWQiICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCW1heEhlaWdodCAtPSBlbGVtLm91dGVySGVpZ2h0KCB0cnVlICk7CgkJCX0pOwoKCQkJdGhpcy5lbGVtZW50LmNoaWxkcmVuKCkubm90KCB0aGlzLnBhbmVscyApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQltYXhIZWlnaHQgLT0gJCggdGhpcyApLm91dGVySGVpZ2h0KCB0cnVlICk7CgkJCX0pOwoKCQkJdGhpcy5wYW5lbHMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5oZWlnaHQoIE1hdGgubWF4KCAwLCBtYXhIZWlnaHQgLQoJCQkJCSQoIHRoaXMgKS5pbm5lckhlaWdodCgpICsgJCggdGhpcyApLmhlaWdodCgpICkgKTsKCQkJfSkKCQkJLmNzcyggIm92ZXJmbG93IiwgImF1dG8iICk7CgkJfSBlbHNlIGlmICggaGVpZ2h0U3R5bGUgPT09ICJhdXRvIiApIHsKCQkJbWF4SGVpZ2h0ID0gMDsKCQkJdGhpcy5wYW5lbHMuZWFjaChmdW5jdGlvbigpIHsKCQkJCW1heEhlaWdodCA9IE1hdGgubWF4KCBtYXhIZWlnaHQsICQoIHRoaXMgKS5oZWlnaHQoICIiICkuaGVpZ2h0KCkgKTsKCQkJfSkuaGVpZ2h0KCBtYXhIZWlnaHQgKTsKCQl9Cgl9LAoKCV9ldmVudEhhbmRsZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJYWN0aXZlID0gdGhpcy5hY3RpdmUsCgkJCWFuY2hvciA9ICQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKSwKCQkJdGFiID0gYW5jaG9yLmNsb3Nlc3QoICJsaSIgKSwKCQkJY2xpY2tlZElzQWN0aXZlID0gdGFiWyAwIF0gPT09IGFjdGl2ZVsgMCBdLAoJCQljb2xsYXBzaW5nID0gY2xpY2tlZElzQWN0aXZlICYmIG9wdGlvbnMuY29sbGFwc2libGUsCgkJCXRvU2hvdyA9IGNvbGxhcHNpbmcgPyAkKCkgOiB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGFiICksCgkJCXRvSGlkZSA9ICFhY3RpdmUubGVuZ3RoID8gJCgpIDogdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIGFjdGl2ZSApLAoJCQlldmVudERhdGEgPSB7CgkJCQlvbGRUYWI6IGFjdGl2ZSwKCQkJCW9sZFBhbmVsOiB0b0hpZGUsCgkJCQluZXdUYWI6IGNvbGxhcHNpbmcgPyAkKCkgOiB0YWIsCgkJCQluZXdQYW5lbDogdG9TaG93CgkJCX07CgoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCWlmICggdGFiLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgfHwKCQkJCS8vIHRhYiBpcyBhbHJlYWR5IGxvYWRpbmcKCQkJCXRhYi5oYXNDbGFzcyggInVpLXRhYnMtbG9hZGluZyIgKSB8fAoJCQkJLy8gY2FuJ3Qgc3dpdGNoIGR1cm5pbmcgYW4gYW5pbWF0aW9uCgkJCQl0aGlzLnJ1bm5pbmcgfHwKCQkJCS8vIGNsaWNrIG9uIGFjdGl2ZSBoZWFkZXIsIGJ1dCBub3QgY29sbGFwc2libGUKCQkJCSggY2xpY2tlZElzQWN0aXZlICYmICFvcHRpb25zLmNvbGxhcHNpYmxlICkgfHwKCQkJCS8vIGFsbG93IGNhbmNlbGluZyBhY3RpdmF0aW9uCgkJCQkoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVBY3RpdmF0ZSIsIGV2ZW50LCBldmVudERhdGEgKSA9PT0gZmFsc2UgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJb3B0aW9ucy5hY3RpdmUgPSBjb2xsYXBzaW5nID8gZmFsc2UgOiB0aGlzLnRhYnMuaW5kZXgoIHRhYiApOwoKCQl0aGlzLmFjdGl2ZSA9IGNsaWNrZWRJc0FjdGl2ZSA/ICQoKSA6IHRhYjsKCQlpZiAoIHRoaXMueGhyICkgewoJCQl0aGlzLnhoci5hYm9ydCgpOwoJCX0KCgkJaWYgKCAhdG9IaWRlLmxlbmd0aCAmJiAhdG9TaG93Lmxlbmd0aCApIHsKCQkJJC5lcnJvciggImpRdWVyeSBVSSBUYWJzOiBNaXNtYXRjaGluZyBmcmFnbWVudCBpZGVudGlmaWVyLiIgKTsKCQl9CgoJCWlmICggdG9TaG93Lmxlbmd0aCApIHsKCQkJdGhpcy5sb2FkKCB0aGlzLnRhYnMuaW5kZXgoIHRhYiApLCBldmVudCApOwoJCX0KCQl0aGlzLl90b2dnbGUoIGV2ZW50LCBldmVudERhdGEgKTsKCX0sCgoJLy8gaGFuZGxlcyBzaG93L2hpZGUgZm9yIHNlbGVjdGluZyB0YWJzCglfdG9nZ2xlOiBmdW5jdGlvbiggZXZlbnQsIGV2ZW50RGF0YSApIHsKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCXRvU2hvdyA9IGV2ZW50RGF0YS5uZXdQYW5lbCwKCQkJdG9IaWRlID0gZXZlbnREYXRhLm9sZFBhbmVsOwoKCQl0aGlzLnJ1bm5pbmcgPSB0cnVlOwoKCQlmdW5jdGlvbiBjb21wbGV0ZSgpIHsKCQkJdGhhdC5ydW5uaW5nID0gZmFsc2U7CgkJCXRoYXQuX3RyaWdnZXIoICJhY3RpdmF0ZSIsIGV2ZW50LCBldmVudERhdGEgKTsKCQl9CgoJCWZ1bmN0aW9uIHNob3coKSB7CgkJCWV2ZW50RGF0YS5uZXdUYWIuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktdGFicy1hY3RpdmUgdWktc3RhdGUtYWN0aXZlIiApOwoKCQkJaWYgKCB0b1Nob3cubGVuZ3RoICYmIHRoYXQub3B0aW9ucy5zaG93ICkgewoJCQkJdGhhdC5fc2hvdyggdG9TaG93LCB0aGF0Lm9wdGlvbnMuc2hvdywgY29tcGxldGUgKTsKCQkJfSBlbHNlIHsKCQkJCXRvU2hvdy5zaG93KCk7CgkJCQljb21wbGV0ZSgpOwoJCQl9CgkJfQoKCQkvLyBzdGFydCBvdXQgYnkgaGlkaW5nLCB0aGVuIHNob3dpbmcsIHRoZW4gY29tcGxldGluZwoJCWlmICggdG9IaWRlLmxlbmd0aCAmJiB0aGlzLm9wdGlvbnMuaGlkZSApIHsKCQkJdGhpcy5faGlkZSggdG9IaWRlLCB0aGlzLm9wdGlvbnMuaGlkZSwgZnVuY3Rpb24oKSB7CgkJCQlldmVudERhdGEub2xkVGFiLmNsb3Nlc3QoICJsaSIgKS5yZW1vdmVDbGFzcyggInVpLXRhYnMtYWN0aXZlIHVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCXNob3coKTsKCQkJfSk7CgkJfSBlbHNlIHsKCQkJZXZlbnREYXRhLm9sZFRhYi5jbG9zZXN0KCAibGkiICkucmVtb3ZlQ2xhc3MoICJ1aS10YWJzLWFjdGl2ZSB1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCXRvSGlkZS5oaWRlKCk7CgkJCXNob3coKTsKCQl9CgoJCXRvSGlkZS5hdHRyKHsKCQkJImFyaWEtZXhwYW5kZWQiOiAiZmFsc2UiLAoJCQkiYXJpYS1oaWRkZW4iOiAidHJ1ZSIKCQl9KTsKCQlldmVudERhdGEub2xkVGFiLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgImZhbHNlIiApOwoJCS8vIElmIHdlJ3JlIHN3aXRjaGluZyB0YWJzLCByZW1vdmUgdGhlIG9sZCB0YWIgZnJvbSB0aGUgdGFiIG9yZGVyLgoJCS8vIElmIHdlJ3JlIG9wZW5pbmcgZnJvbSBjb2xsYXBzZWQgc3RhdGUsIHJlbW92ZSB0aGUgcHJldmlvdXMgdGFiIGZyb20gdGhlIHRhYiBvcmRlci4KCQkvLyBJZiB3ZSdyZSBjb2xsYXBzaW5nLCB0aGVuIGtlZXAgdGhlIGNvbGxhcHNpbmcgdGFiIGluIHRoZSB0YWIgb3JkZXIuCgkJaWYgKCB0b1Nob3cubGVuZ3RoICYmIHRvSGlkZS5sZW5ndGggKSB7CgkJCWV2ZW50RGF0YS5vbGRUYWIuYXR0ciggInRhYkluZGV4IiwgLTEgKTsKCQl9IGVsc2UgaWYgKCB0b1Nob3cubGVuZ3RoICkgewoJCQl0aGlzLnRhYnMuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICQoIHRoaXMgKS5hdHRyKCAidGFiSW5kZXgiICkgPT09IDA7CgkJCX0pCgkJCS5hdHRyKCAidGFiSW5kZXgiLCAtMSApOwoJCX0KCgkJdG9TaG93LmF0dHIoewoJCQkiYXJpYS1leHBhbmRlZCI6ICJ0cnVlIiwKCQkJImFyaWEtaGlkZGVuIjogImZhbHNlIgoJCX0pOwoJCWV2ZW50RGF0YS5uZXdUYWIuYXR0cih7CgkJCSJhcmlhLXNlbGVjdGVkIjogInRydWUiLAoJCQl0YWJJbmRleDogMAoJCX0pOwoJfSwKCglfYWN0aXZhdGU6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQl2YXIgYW5jaG9yLAoJCQlhY3RpdmUgPSB0aGlzLl9maW5kQWN0aXZlKCBpbmRleCApOwoKCQkvLyB0cnlpbmcgdG8gYWN0aXZhdGUgdGhlIGFscmVhZHkgYWN0aXZlIHBhbmVsCgkJaWYgKCBhY3RpdmVbIDAgXSA9PT0gdGhpcy5hY3RpdmVbIDAgXSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gdHJ5aW5nIHRvIGNvbGxhcHNlLCBzaW11bGF0ZSBhIGNsaWNrIG9uIHRoZSBjdXJyZW50IGFjdGl2ZSBoZWFkZXIKCQlpZiAoICFhY3RpdmUubGVuZ3RoICkgewoJCQlhY3RpdmUgPSB0aGlzLmFjdGl2ZTsKCQl9CgoJCWFuY2hvciA9IGFjdGl2ZS5maW5kKCAiLnVpLXRhYnMtYW5jaG9yIiApWyAwIF07CgkJdGhpcy5fZXZlbnRIYW5kbGVyKHsKCQkJdGFyZ2V0OiBhbmNob3IsCgkJCWN1cnJlbnRUYXJnZXQ6IGFuY2hvciwKCQkJcHJldmVudERlZmF1bHQ6ICQubm9vcAoJCX0pOwoJfSwKCglfZmluZEFjdGl2ZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXJldHVybiBpbmRleCA9PT0gZmFsc2UgPyAkKCkgOiB0aGlzLnRhYnMuZXEoIGluZGV4ICk7Cgl9LAoKCV9nZXRJbmRleDogZnVuY3Rpb24oIGluZGV4ICkgewoJCS8vIG1ldGEtZnVuY3Rpb24gdG8gZ2l2ZSB1c2VycyBvcHRpb24gdG8gcHJvdmlkZSBhIGhyZWYgc3RyaW5nIGluc3RlYWQgb2YgYSBudW1lcmljYWwgaW5kZXguCgkJaWYgKCB0eXBlb2YgaW5kZXggPT09ICJzdHJpbmciICkgewoJCQlpbmRleCA9IHRoaXMuYW5jaG9ycy5pbmRleCggdGhpcy5hbmNob3JzLmZpbHRlciggIltocmVmJD0nIiArIGluZGV4ICsgIiddIiApICk7CgkJfQoKCQlyZXR1cm4gaW5kZXg7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMueGhyICkgewoJCQl0aGlzLnhoci5hYm9ydCgpOwoJCX0KCgkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktdGFicyB1aS13aWRnZXQgdWktd2lkZ2V0LWNvbnRlbnQgdWktY29ybmVyLWFsbCB1aS10YWJzLWNvbGxhcHNpYmxlIiApOwoKCQl0aGlzLnRhYmxpc3QKCQkJLnJlbW92ZUNsYXNzKCAidWktdGFicy1uYXYgdWktaGVscGVyLXJlc2V0IHVpLWhlbHBlci1jbGVhcmZpeCB1aS13aWRnZXQtaGVhZGVyIHVpLWNvcm5lci1hbGwiICkKCQkJLnJlbW92ZUF0dHIoICJyb2xlIiApOwoKCQl0aGlzLmFuY2hvcnMKCQkJLnJlbW92ZUNsYXNzKCAidWktdGFicy1hbmNob3IiICkKCQkJLnJlbW92ZUF0dHIoICJyb2xlIiApCgkJCS5yZW1vdmVBdHRyKCAidGFiSW5kZXgiICkKCQkJLnJlbW92ZVVuaXF1ZUlkKCk7CgoJCXRoaXMudGFicy5hZGQoIHRoaXMucGFuZWxzICkuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAkLmRhdGEoIHRoaXMsICJ1aS10YWJzLWRlc3Ryb3kiICkgKSB7CgkJCQkkKCB0aGlzICkucmVtb3ZlKCk7CgkJCX0gZWxzZSB7CgkJCQkkKCB0aGlzICkKCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1kZWZhdWx0IHVpLXN0YXRlLWFjdGl2ZSB1aS1zdGF0ZS1kaXNhYmxlZCAiICsKCQkJCQkJInVpLWNvcm5lci10b3AgdWktY29ybmVyLWJvdHRvbSB1aS13aWRnZXQtY29udGVudCB1aS10YWJzLWFjdGl2ZSB1aS10YWJzLXBhbmVsIiApCgkJCQkJLnJlbW92ZUF0dHIoICJ0YWJJbmRleCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1saXZlIiApCgkJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWJ1c3kiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtc2VsZWN0ZWQiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtbGFiZWxsZWRieSIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1oaWRkZW4iICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtZXhwYW5kZWQiICkKCQkJCQkucmVtb3ZlQXR0ciggInJvbGUiICk7CgkJCX0KCQl9KTsKCgkJdGhpcy50YWJzLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBsaSA9ICQoIHRoaXMgKSwKCQkJCXByZXYgPSBsaS5kYXRhKCAidWktdGFicy1hcmlhLWNvbnRyb2xzIiApOwoJCQlpZiAoIHByZXYgKSB7CgkJCQlsaQoJCQkJCS5hdHRyKCAiYXJpYS1jb250cm9scyIsIHByZXYgKQoJCQkJCS5yZW1vdmVEYXRhKCAidWktdGFicy1hcmlhLWNvbnRyb2xzIiApOwoJCQl9IGVsc2UgewoJCQkJbGkucmVtb3ZlQXR0ciggImFyaWEtY29udHJvbHMiICk7CgkJCX0KCQl9KTsKCgkJdGhpcy5wYW5lbHMuc2hvdygpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5oZWlnaHRTdHlsZSAhPT0gImNvbnRlbnQiICkgewoJCQl0aGlzLnBhbmVscy5jc3MoICJoZWlnaHQiLCAiIiApOwoJCX0KCX0sCgoJZW5hYmxlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJdmFyIGRpc2FibGVkID0gdGhpcy5vcHRpb25zLmRpc2FibGVkOwoJCWlmICggZGlzYWJsZWQgPT09IGZhbHNlICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGluZGV4ID09PSB1bmRlZmluZWQgKSB7CgkJCWRpc2FibGVkID0gZmFsc2U7CgkJfSBlbHNlIHsKCQkJaW5kZXggPSB0aGlzLl9nZXRJbmRleCggaW5kZXggKTsKCQkJaWYgKCAkLmlzQXJyYXkoIGRpc2FibGVkICkgKSB7CgkJCQlkaXNhYmxlZCA9ICQubWFwKCBkaXNhYmxlZCwgZnVuY3Rpb24oIG51bSApIHsKCQkJCQlyZXR1cm4gbnVtICE9PSBpbmRleCA/IG51bSA6IG51bGw7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCWRpc2FibGVkID0gJC5tYXAoIHRoaXMudGFicywgZnVuY3Rpb24oIGxpLCBudW0gKSB7CgkJCQkJcmV0dXJuIG51bSAhPT0gaW5kZXggPyBudW0gOiBudWxsOwoJCQkJfSk7CgkJCX0KCQl9CgkJdGhpcy5fc2V0dXBEaXNhYmxlZCggZGlzYWJsZWQgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXZhciBkaXNhYmxlZCA9IHRoaXMub3B0aW9ucy5kaXNhYmxlZDsKCQlpZiAoIGRpc2FibGVkID09PSB0cnVlICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGluZGV4ID09PSB1bmRlZmluZWQgKSB7CgkJCWRpc2FibGVkID0gdHJ1ZTsKCQl9IGVsc2UgewoJCQlpbmRleCA9IHRoaXMuX2dldEluZGV4KCBpbmRleCApOwoJCQlpZiAoICQuaW5BcnJheSggaW5kZXgsIGRpc2FibGVkICkgIT09IC0xICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggJC5pc0FycmF5KCBkaXNhYmxlZCApICkgewoJCQkJZGlzYWJsZWQgPSAkLm1lcmdlKCBbIGluZGV4IF0sIGRpc2FibGVkICkuc29ydCgpOwoJCQl9IGVsc2UgewoJCQkJZGlzYWJsZWQgPSBbIGluZGV4IF07CgkJCX0KCQl9CgkJdGhpcy5fc2V0dXBEaXNhYmxlZCggZGlzYWJsZWQgKTsKCX0sCgoJbG9hZDogZnVuY3Rpb24oIGluZGV4LCBldmVudCApIHsKCQlpbmRleCA9IHRoaXMuX2dldEluZGV4KCBpbmRleCApOwoJCXZhciB0aGF0ID0gdGhpcywKCQkJdGFiID0gdGhpcy50YWJzLmVxKCBpbmRleCApLAoJCQlhbmNob3IgPSB0YWIuZmluZCggIi51aS10YWJzLWFuY2hvciIgKSwKCQkJcGFuZWwgPSB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGFiICksCgkJCWV2ZW50RGF0YSA9IHsKCQkJCXRhYjogdGFiLAoJCQkJcGFuZWw6IHBhbmVsCgkJCX07CgoJCS8vIG5vdCByZW1vdGUKCQlpZiAoIGlzTG9jYWwoIGFuY2hvclsgMCBdICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMueGhyID0gJC5hamF4KCB0aGlzLl9hamF4U2V0dGluZ3MoIGFuY2hvciwgZXZlbnQsIGV2ZW50RGF0YSApICk7CgoJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJLy8galF1ZXJ5IDwxLjggcmV0dXJucyBmYWxzZSBpZiB0aGUgcmVxdWVzdCBpcyBjYW5jZWxlZCBpbiBiZWZvcmVTZW5kLAoJCS8vIGJ1dCBhcyBvZiAxLjgsICQuYWpheCgpIGFsd2F5cyByZXR1cm5zIGEganFYSFIgb2JqZWN0LgoJCWlmICggdGhpcy54aHIgJiYgdGhpcy54aHIuc3RhdHVzVGV4dCAhPT0gImNhbmNlbGVkIiApIHsKCQkJdGFiLmFkZENsYXNzKCAidWktdGFicy1sb2FkaW5nIiApOwoJCQlwYW5lbC5hdHRyKCAiYXJpYS1idXN5IiwgInRydWUiICk7CgoJCQl0aGlzLnhocgoJCQkJLnN1Y2Nlc3MoZnVuY3Rpb24oIHJlc3BvbnNlICkgewoJCQkJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTE3NzgKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQlwYW5lbC5odG1sKCByZXNwb25zZSApOwoJCQkJCQl0aGF0Ll90cmlnZ2VyKCAibG9hZCIsIGV2ZW50LCBldmVudERhdGEgKTsKCQkJCQl9LCAxICk7CgkJCQl9KQoJCQkJLmNvbXBsZXRlKGZ1bmN0aW9uKCBqcVhIUiwgc3RhdHVzICkgewoJCQkJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTE3NzgKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQlpZiAoIHN0YXR1cyA9PT0gImFib3J0IiApIHsKCQkJCQkJCXRoYXQucGFuZWxzLnN0b3AoIGZhbHNlLCB0cnVlICk7CgkJCQkJCX0KCgkJCQkJCXRhYi5yZW1vdmVDbGFzcyggInVpLXRhYnMtbG9hZGluZyIgKTsKCQkJCQkJcGFuZWwucmVtb3ZlQXR0ciggImFyaWEtYnVzeSIgKTsKCgkJCQkJCWlmICgganFYSFIgPT09IHRoYXQueGhyICkgewoJCQkJCQkJZGVsZXRlIHRoYXQueGhyOwoJCQkJCQl9CgkJCQkJfSwgMSApOwoJCQkJfSk7CgkJfQoJfSwKCglfYWpheFNldHRpbmdzOiBmdW5jdGlvbiggYW5jaG9yLCBldmVudCwgZXZlbnREYXRhICkgewoJCXZhciB0aGF0ID0gdGhpczsKCQlyZXR1cm4gewoJCQl1cmw6IGFuY2hvci5hdHRyKCAiaHJlZiIgKSwKCQkJYmVmb3JlU2VuZDogZnVuY3Rpb24oIGpxWEhSLCBzZXR0aW5ncyApIHsKCQkJCXJldHVybiB0aGF0Ll90cmlnZ2VyKCAiYmVmb3JlTG9hZCIsIGV2ZW50LAoJCQkJCSQuZXh0ZW5kKCB7IGpxWEhSIDoganFYSFIsIGFqYXhTZXR0aW5nczogc2V0dGluZ3MgfSwgZXZlbnREYXRhICkgKTsKCQkJfQoJCX07Cgl9LAoKCV9nZXRQYW5lbEZvclRhYjogZnVuY3Rpb24oIHRhYiApIHsKCQl2YXIgaWQgPSAkKCB0YWIgKS5hdHRyKCAiYXJpYS1jb250cm9scyIgKTsKCQlyZXR1cm4gdGhpcy5lbGVtZW50LmZpbmQoIHRoaXMuX3Nhbml0aXplU2VsZWN0b3IoICIjIiArIGlkICkgKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoKCSQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCA9IHRydWU7CgoJLy8gVGhpcyBmaXggYWRkcmVzc2VzIGFuIGlPUyBidWcsIHNvIHJldHVybiBlYXJseSBpZiB0aGUgVUEgY2xhaW1zIGl0J3Mgc29tZXRoaW5nIGVsc2UuCgl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCXpvb20sCgkJZXZ0LCB4LCB5LCB6LCBhaWc7CglpZiAoICEoIC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiAvT1MgWzEtNV1fWzAtOV9dKiBsaWtlIE1hYyBPUyBYL2kudGVzdCggdWEgKSAmJiB1YS5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSApICkgewoJCSQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCA9IGZhbHNlOwoJCXJldHVybjsKCX0KCgl6b29tID0gJC5tb2JpbGUuem9vbTsKCglmdW5jdGlvbiBjaGVja1RpbHQoIGUgKSB7CgkJZXZ0ID0gZS5vcmlnaW5hbEV2ZW50OwoJCWFpZyA9IGV2dC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5OwoKCQl4ID0gTWF0aC5hYnMoIGFpZy54ICk7CgkJeSA9IE1hdGguYWJzKCBhaWcueSApOwoJCXogPSBNYXRoLmFicyggYWlnLnogKTsKCgkJLy8gSWYgcG9ydHJhaXQgb3JpZW50YXRpb24gYW5kIGluIG9uZSBvZiB0aGUgZGFuZ2VyIHpvbmVzCgkJaWYgKCAhd2luZG93Lm9yaWVudGF0aW9uICYmICggeCA+IDcgfHwgKCAoIHogPiA2ICYmIHkgPCA4IHx8IHogPCA4ICYmIHkgPiA2ICkgJiYgeCA+IDUgKSApICkgewoJCQkJaWYgKCB6b29tLmVuYWJsZWQgKSB7CgkJCQkJem9vbS5kaXNhYmxlKCk7CgkJCQl9CgkJfQllbHNlIGlmICggIXpvb20uZW5hYmxlZCApIHsKCQkJCXpvb20uZW5hYmxlKCk7CgkJfQoJfQoKCSQubW9iaWxlLmRvY3VtZW50Lm9uKCAibW9iaWxlaW5pdCIsIGZ1bmN0aW9uKCkgewoJCWlmICggJC5tb2JpbGUuaW9zb3JpZW50YXRpb25maXhFbmFibGVkICkgewoJCQkkLm1vYmlsZS53aW5kb3cKCQkJCS5iaW5kKCAib3JpZW50YXRpb25jaGFuZ2UuaW9zb3JpZW50YXRpb25maXgiLCB6b29tLmVuYWJsZSApCgkJCQkuYmluZCggImRldmljZW1vdGlvbi5pb3NvcmllbnRhdGlvbmZpeCIsIGNoZWNrVGlsdCApOwoJCX0KCX0pOwoKfSggalF1ZXJ5LCB0aGlzICkpOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhcgkkaHRtbCA9ICQoICJodG1sIiApLAoJCSR3aW5kb3cgPSAkLm1vYmlsZS53aW5kb3c7CgoJLy9yZW1vdmUgaW5pdGlhbCBidWlsZCBjbGFzcyAob25seSBwcmVzZW50IG9uIGZpcnN0IHBhZ2VzaG93KQoJZnVuY3Rpb24gaGlkZVJlbmRlcmluZ0NsYXNzKCkgewoJCSRodG1sLnJlbW92ZUNsYXNzKCAidWktbW9iaWxlLXJlbmRlcmluZyIgKTsKCX0KCgkvLyB0cmlnZ2VyIG1vYmlsZWluaXQgZXZlbnQgLSB1c2VmdWwgaG9vayBmb3IgY29uZmlndXJpbmcgJC5tb2JpbGUgc2V0dGluZ3MgYmVmb3JlIHRoZXkncmUgdXNlZAoJJCggd2luZG93LmRvY3VtZW50ICkudHJpZ2dlciggIm1vYmlsZWluaXQiICk7CgoJLy8gc3VwcG9ydCBjb25kaXRpb25zCgkvLyBpZiBkZXZpY2Ugc3VwcG9ydCBjb25kaXRpb24ocykgYXJlbid0IG1ldCwgbGVhdmUgdGhpbmdzIGFzIHRoZXkgYXJlIC0+IGEgYmFzaWMsIHVzYWJsZSBleHBlcmllbmNlLAoJLy8gb3RoZXJ3aXNlLCBwcm9jZWVkIHdpdGggdGhlIGVuaGFuY2VtZW50cwoJaWYgKCAhJC5tb2JpbGUuZ3JhZGVBKCkgKSB7CgkJcmV0dXJuOwoJfQoKCS8vIG92ZXJyaWRlIGFqYXhFbmFibGVkIG9uIHBsYXRmb3JtcyB0aGF0IGhhdmUga25vd24gY29uZmxpY3RzIHdpdGggaGFzaCBoaXN0b3J5IHVwZGF0ZXMKCS8vIG9yIGdlbmVyYWxseSB3b3JrIGJldHRlciBicm93c2luZyBpbiByZWd1bGFyIGh0dHAgZm9yIGZ1bGwgcGFnZSByZWZyZXNoZXMgKEJCNSwgT3BlcmEgTWluaSkKCWlmICggJC5tb2JpbGUuYWpheEJsYWNrbGlzdCApIHsKCQkkLm1vYmlsZS5hamF4RW5hYmxlZCA9IGZhbHNlOwoJfQoKCS8vIEFkZCBtb2JpbGUsIGluaXRpYWwgbG9hZCAicmVuZGVyaW5nIiBjbGFzc2VzIHRvIGRvY0VsCgkkaHRtbC5hZGRDbGFzcyggInVpLW1vYmlsZSB1aS1tb2JpbGUtcmVuZGVyaW5nIiApOwoKCS8vIFRoaXMgaXMgYSBmYWxsYmFjay4gSWYgYW55dGhpbmcgZ29lcyB3cm9uZyAoSlMgZXJyb3JzLCBldGMpLCBvciBldmVudHMgZG9uJ3QgZmlyZSwKCS8vIHRoaXMgZW5zdXJlcyB0aGUgcmVuZGVyaW5nIGNsYXNzIGlzIHJlbW92ZWQgYWZ0ZXIgNSBzZWNvbmRzLCBzbyBjb250ZW50IGlzIHZpc2libGUgYW5kIGFjY2Vzc2libGUKCXNldFRpbWVvdXQoIGhpZGVSZW5kZXJpbmdDbGFzcywgNTAwMCApOwoKCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoJCS8vIGZpbmQgYW5kIGVuaGFuY2UgdGhlIHBhZ2VzIGluIHRoZSBkb20gYW5kIHRyYW5zaXRpb24gdG8gdGhlIGZpcnN0IHBhZ2UuCgkJaW5pdGlhbGl6ZVBhZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBmaW5kIHByZXNlbnQgcGFnZXMKCQkJdmFyIHBhdGggPSAkLm1vYmlsZS5wYXRoLAoJCQkJJHBhZ2VzID0gJCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICksCgkJCQloYXNoID0gcGF0aC5zdHJpcEhhc2goIHBhdGguc3RyaXBRdWVyeVBhcmFtcyhwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoKSApLAoJCQkJaGFzaFBhZ2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggaGFzaCApOwoKCQkJLy8gaWYgbm8gcGFnZXMgYXJlIGZvdW5kLCBjcmVhdGUgb25lIHdpdGggYm9keSdzIGlubmVyIGh0bWwKCQkJaWYgKCAhJHBhZ2VzLmxlbmd0aCApIHsKCQkJCSRwYWdlcyA9ICQoICJib2R5IiApLndyYXBJbm5lciggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0ncGFnZSc+PC9kaXY+IiApLmNoaWxkcmVuKCAwICk7CgkJCX0KCgkJCS8vIGFkZCBkaWFsb2dzLCBzZXQgZGF0YS11cmwgYXR0cnMKCQkJJHBhZ2VzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQkJLy8gdW5sZXNzIHRoZSBkYXRhIHVybCBpcyBhbHJlYWR5IHNldCBzZXQgaXQgdG8gdGhlIHBhdGhuYW1lCgkJCQlpZiAoICEkdGhpc1sgMCBdLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIgKSApIHsKCQkJCQkkdGhpcy5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgJHRoaXMuYXR0ciggImlkIiApIHx8IGxvY2F0aW9uLnBhdGhuYW1lICsgbG9jYXRpb24uc2VhcmNoICk7CgkJCQl9CgkJCX0pOwoKCQkJLy8gZGVmaW5lIGZpcnN0IHBhZ2UgaW4gZG9tIGNhc2Ugb25lIGJhY2tzIG91dCB0byB0aGUgZGlyZWN0b3J5IHJvb3QgKG5vdCBhbHdheXMgdGhlIGZpcnN0IHBhZ2UgdmlzaXRlZCwgYnV0IGRlZmluZWQgYXMgZmFsbGJhY2spCgkJCSQubW9iaWxlLmZpcnN0UGFnZSA9ICRwYWdlcy5maXJzdCgpOwoKCQkJLy8gZGVmaW5lIHBhZ2UgY29udGFpbmVyCgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIgPSAkLm1vYmlsZS5maXJzdFBhZ2UKCQkJCS5wYXJlbnQoKQoJCQkJLmFkZENsYXNzKCAidWktbW9iaWxlLXZpZXdwb3J0IiApCgkJCQkucGFnZWNvbnRhaW5lcigpOwoKCQkJLy8gaW5pdGlhbGl6ZSBuYXZpZ2F0aW9uIGV2ZW50cyBub3csIGFmdGVyIG1vYmlsZWluaXQgaGFzIG9jY3VycmVkIGFuZCB0aGUgcGFnZSBjb250YWluZXIKCQkJLy8gaGFzIGJlZW4gY3JlYXRlZCBidXQgYmVmb3JlIHRoZSByZXN0IG9mIHRoZSBsaWJyYXJ5IGlzIGFsZXJ0ZWQgdG8gdGhhdCBmYWN0CgkJCSQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQucmVzb2x2ZSgpOwoKCQkJLy8gYWxlcnQgbGlzdGVuZXJzIHRoYXQgdGhlIHBhZ2Vjb250YWluZXIgaGFzIGJlZW4gZGV0ZXJtaW5lZCBmb3IgYmluZGluZwoJCQkvLyB0byBldmVudHMgdHJpZ2dlcmVkIG9uIGl0CgkJCSR3aW5kb3cudHJpZ2dlciggInBhZ2Vjb250YWluZXJjcmVhdGUiICk7CgoJCQkvLyBjdWUgcGFnZSBsb2FkaW5nIG1lc3NhZ2UKCQkJJC5tb2JpbGUubG9hZGluZyggInNob3ciICk7CgoJCQkvL3JlbW92ZSBpbml0aWFsIGJ1aWxkIGNsYXNzIChvbmx5IHByZXNlbnQgb24gZmlyc3QgcGFnZXNob3cpCgkJCWhpZGVSZW5kZXJpbmdDbGFzcygpOwoKCQkJLy8gaWYgaGFzaGNoYW5nZSBsaXN0ZW5pbmcgaXMgZGlzYWJsZWQsIHRoZXJlJ3Mgbm8gaGFzaCBkZWVwbGluaywKCQkJLy8gdGhlIGhhc2ggaXMgbm90IHZhbGlkIChjb250YWlucyBtb3JlIHRoYW4gb25lICMgb3IgZG9lcyBub3Qgc3RhcnQgd2l0aCAjKQoJCQkvLyBvciB0aGVyZSBpcyBubyBwYWdlIHdpdGggdGhhdCBoYXNoLCBjaGFuZ2UgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIERPTQoJCQkvLyBSZW1lbWJlciwgaG93ZXZlciwgdGhhdCB0aGUgaGFzaCBjYW4gYWxzbyBiZSBhIHBhdGghCgkJCWlmICggISAoICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICYmCgkJCQkkLm1vYmlsZS5wYXRoLmlzSGFzaFZhbGlkKCBsb2NhdGlvbi5oYXNoICkgJiYKCQkJCSggJCggaGFzaFBhZ2UgKS5pcyggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKSB8fAoJCQkJCSQubW9iaWxlLnBhdGguaXNQYXRoKCBoYXNoICkgfHwKCQkJCQloYXNoID09PSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5ICkgKSApIHsKCgkJCQkvLyBTdG9yZSB0aGUgaW5pdGlhbCBkZXN0aW5hdGlvbgoJCQkJaWYgKCAkLm1vYmlsZS5wYXRoLmlzSGFzaFZhbGlkKCBsb2NhdGlvbi5oYXNoICkgKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5pbml0aWFsRHN0ID0gaGFzaC5yZXBsYWNlKCAiIyIsICIiICk7CgkJCQl9CgoJCQkJLy8gbWFrZSBzdXJlIHRvIHNldCBpbml0aWFsIHBvcHN0YXRlIHN0YXRlIGlmIGl0IGV4aXN0cwoJCQkJLy8gc28gdGhhdCBuYXZpZ2F0aW9uIGJhY2sgdG8gdGhlIGluaXRpYWwgcGFnZSB3b3JrcyBwcm9wZXJseQoJCQkJaWYgKCAkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUubmF2aWdhdG9yLnNxdWFzaCggcGF0aC5wYXJzZUxvY2F0aW9uKCkuaHJlZiApOwoJCQkJfQoKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoICQubW9iaWxlLmZpcnN0UGFnZSwgewoJCQkJCXRyYW5zaXRpb246ICJub25lIiwKCQkJCQlyZXZlcnNlOiB0cnVlLAoJCQkJCWNoYW5nZUhhc2g6IGZhbHNlLAoJCQkJCWZyb21IYXNoQ2hhbmdlOiB0cnVlCgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCS8vIHRyaWdnZXIgaGFzaGNoYW5nZSBvciBuYXZpZ2F0ZSB0byBzcXVhc2ggYW5kIHJlY29yZCB0aGUgY29ycmVjdAoJCQkJLy8gaGlzdG9yeSBlbnRyeSBmb3IgYW4gaW5pdGlhbCBoYXNoIHBhdGgKCQkJCWlmICggISQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCQkkd2luZG93LnRyaWdnZXIoICJoYXNoY2hhbmdlIiwgW3RydWVdICk7CgkJCQl9IGVsc2UgewoJCQkJCS8vIFRPRE8gZmlndXJlIG91dCBob3cgdG8gc2ltcGxpZnkgdGhpcyBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbml0aWFsIGhpc3RvcnkgZW50cnkKCQkJCQkvLyBhdCB0aGUgYm90dG9tIGpzL25hdmlnYXRlL25hdmlnYXRlLmpzCgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5zdGFjayA9IFtdOwoJCQkJCSQubW9iaWxlLm5hdmlnYXRlKCAkLm1vYmlsZS5wYXRoLmlzUGF0aCggbG9jYXRpb24uaGFzaCApID8gbG9jYXRpb24uaGFzaCA6IGxvY2F0aW9uLmhyZWYgKTsKCQkJCX0KCQkJfQoJCX0KCX0pOwoKCSQoZnVuY3Rpb24oKSB7CgkJLy9SdW4gaW5saW5lU1ZHIHN1cHBvcnQgdGVzdAoJCSQuc3VwcG9ydC5pbmxpbmVTVkcoKTsKCgkJLy8gY2hlY2sgd2hpY2ggc2Nyb2xsVG9wIHZhbHVlIHNob3VsZCBiZSB1c2VkIGJ5IHNjcm9sbGluZyB0byAxIGltbWVkaWF0ZWx5IGF0IGRvbXJlYWR5CgkJLy8gdGhlbiBjaGVjayB3aGF0IHRoZSBzY3JvbGwgdG9wIGlzLiBBbmRyb2lkIHdpbGwgcmVwb3J0IDAuLi4gb3RoZXJzIDEKCQkvLyBub3RlIHRoYXQgdGhpcyBpbml0aWFsIHNjcm9sbCB3b24ndCBoaWRlIHRoZSBhZGRyZXNzIGJhci4gSXQncyBqdXN0IGZvciB0aGUgY2hlY2suCgoJCS8vIGhpZGUgaU9TIGJyb3dzZXIgY2hyb21lIG9uIGxvYWQgaWYgaGlkZVVybEJhciBpcyB0cnVlIHRoaXMgaXMgdG8gdHJ5IGFuZCBkbyBpdCBhcyBzb29uIGFzIHBvc3NpYmxlCgkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyICkgewoJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIDEgKTsKCQl9CgoJCS8vIGlmIGRlZmF1bHRIb21lU2Nyb2xsIGhhc24ndCBiZWVuIHNldCB5ZXQsIHNlZSBpZiBzY3JvbGxUb3AgaXMgMQoJCS8vIGl0IHNob3VsZCBiZSAxIGluIG1vc3QgYnJvd3NlcnMsIGJ1dCBhbmRyb2lkIHRyZWF0cyAxIGFzIDAgKGZvciBoaWRpbmcgYWRkciBiYXIpCgkJLy8gc28gaWYgaXQncyAxLCB1c2UgMCBmcm9tIG5vdyBvbgoJCSQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsID0gKCAhJC5zdXBwb3J0LnNjcm9sbFRvcCB8fCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCkgPT09IDEgKSA/IDAgOiAxOwoKCQkvL2RvbS1yZWFkeSBpbml0cwoJCWlmICggJC5tb2JpbGUuYXV0b0luaXRpYWxpemVQYWdlICkgewoJCQkkLm1vYmlsZS5pbml0aWFsaXplUGFnZSgpOwoJCX0KCgkJLy8gd2luZG93IGxvYWQgZXZlbnQKCQkvLyBoaWRlIGlPUyBicm93c2VyIGNocm9tZSBvbiBsb2FkIGlmIGhpZGVVcmxCYXIgaXMgdHJ1ZSB0aGlzIGlzIGFzIGZhbGwgYmFjayBpbmNhc2Ugd2Ugd2VyZSB0b28gZWFybHkgYmVmb3JlCgkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyICkgewoJCQkkd2luZG93LmxvYWQoICQubW9iaWxlLnNpbGVudFNjcm9sbCApOwoJCX0KCgkJaWYgKCAhJC5zdXBwb3J0LmNzc1BvaW50ZXJFdmVudHMgKSB7CgkJCS8vIElFIGFuZCBPcGVyYSBkb24ndCBzdXBwb3J0IENTUyBwb2ludGVyLWV2ZW50czogbm9uZSB0aGF0IHdlIHVzZSB0byBkaXNhYmxlIGxpbmstYmFzZWQgYnV0dG9ucwoJCQkvLyBieSBhZGRpbmcgdGhlICd1aS1kaXNhYmxlZCcgY2xhc3MgdG8gdGhlbS4gVXNpbmcgYSBKYXZhU2NyaXB0IHdvcmthcm91bmQgZm9yIHRob3NlIGJyb3dzZXIuCgkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzU1OAoKCQkJLy8gREVQUkVDQVRFRCBhcyBvZiAxLjQuMCAtIHJlbW92ZSB1aS1kaXNhYmxlZCBhZnRlciAxLjQuMCByZWxlYXNlCgkJCS8vIG9ubHkgdWktc3RhdGUtZGlzYWJsZWQgc2hvdWxkIGJlIHByZXNlbnQgdGhlcmVhZnRlcgoJCQkkLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggIi51aS1zdGF0ZS1kaXNhYmxlZCwudWktZGlzYWJsZWQiLCAidmNsaWNrIiwKCQkJCWZ1bmN0aW9uKCBlICkgewoJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQllLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJfQoJCQkpOwoJCX0KCX0pOwp9KCBqUXVlcnksIHRoaXMgKSk7CgoKfSkpOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 03:41:23 GMT",
                    "Content-Length": "443513",
                    "Date": "Sat, 08 Nov 2014 03:41:24 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}