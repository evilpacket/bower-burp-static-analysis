{
    "url": "http://localhost:9999/oieduardorabelo/sawpf/src/js/thorax/2.0.0rc1/thorax-mobile.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statements:<ul><li>var href = location.href.replace(/(javascript:|#).*$/, '');</li><li>location.replace(href + '#' + fragment);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/oieduardorabelo/sawpf/src/js/thorax/2.0.0rc1/thorax-mobile.js",
                "path": "/oieduardorabelo/sawpf/src/js/thorax/2.0.0rc1/thorax-mobile.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9vaWVkdWFyZG9yYWJlbG8vc2F3cGYvc3JjL2pzL3Rob3JheC8yLjAuMHJjMS90aG9yYXgtbW9iaWxlLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjk3MTc1DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBTYXQsIDA4IE5vdiAyMDE0IDAzOjU1OjM1IEdNVA0KTGFzdC1Nb2RpZmllZDogU2F0LCAwOCBOb3YgMjAxNCAwMzo1NDo1OSBHTVQNCg0KLyogWmVwdG8gdjEuMHJjMSAtIHBvbHlmaWxsIHplcHRvIGV2ZW50IGRldGVjdCBmeCBhamF4IGZvcm0gdG91Y2ggLSB6ZXB0b2pzLmNvbS9saWNlbnNlICovCjsoZnVuY3Rpb24odW5kZWZpbmVkKXsKICBpZiAoU3RyaW5nLnByb3RvdHlwZS50cmltID09PSB1bmRlZmluZWQpIC8vIGZpeCBmb3IgaU9TIDMuMgogICAgU3RyaW5nLnByb3RvdHlwZS50cmltID0gZnVuY3Rpb24oKXsgcmV0dXJuIHRoaXMucmVwbGFjZSgvXlxzKy8sICcnKS5yZXBsYWNlKC9ccyskLywgJycpIH0KCiAgLy8gRm9yIGlPUyAzLngKICAvLyBmcm9tIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL0FycmF5L3JlZHVjZQogIGlmIChBcnJheS5wcm90b3R5cGUucmVkdWNlID09PSB1bmRlZmluZWQpCiAgICBBcnJheS5wcm90b3R5cGUucmVkdWNlID0gZnVuY3Rpb24oZnVuKXsKICAgICAgaWYodGhpcyA9PT0gdm9pZCAwIHx8IHRoaXMgPT09IG51bGwpIHRocm93IG5ldyBUeXBlRXJyb3IoKQogICAgICB2YXIgdCA9IE9iamVjdCh0aGlzKSwgbGVuID0gdC5sZW5ndGggPj4+IDAsIGsgPSAwLCBhY2N1bXVsYXRvcgogICAgICBpZih0eXBlb2YgZnVuICE9ICdmdW5jdGlvbicpIHRocm93IG5ldyBUeXBlRXJyb3IoKQogICAgICBpZihsZW4gPT0gMCAmJiBhcmd1bWVudHMubGVuZ3RoID09IDEpIHRocm93IG5ldyBUeXBlRXJyb3IoKQoKICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aCA+PSAyKQogICAgICAgYWNjdW11bGF0b3IgPSBhcmd1bWVudHNbMV0KICAgICAgZWxzZQogICAgICAgIGRvewogICAgICAgICAgaWYoayBpbiB0KXsKICAgICAgICAgICAgYWNjdW11bGF0b3IgPSB0W2srK10KICAgICAgICAgICAgYnJlYWsKICAgICAgICAgIH0KICAgICAgICAgIGlmKCsrayA+PSBsZW4pIHRocm93IG5ldyBUeXBlRXJyb3IoKQogICAgICAgIH0gd2hpbGUgKHRydWUpCgogICAgICB3aGlsZSAoayA8IGxlbil7CiAgICAgICAgaWYoayBpbiB0KSBhY2N1bXVsYXRvciA9IGZ1bi5jYWxsKHVuZGVmaW5lZCwgYWNjdW11bGF0b3IsIHRba10sIGssIHQpCiAgICAgICAgaysrCiAgICAgIH0KICAgICAgcmV0dXJuIGFjY3VtdWxhdG9yCiAgICB9Cgp9KSgpCnZhciBaZXB0byA9IChmdW5jdGlvbigpIHsKICB2YXIgdW5kZWZpbmVkLCBrZXksICQsIGNsYXNzTGlzdCwgZW1wdHlBcnJheSA9IFtdLCBzbGljZSA9IGVtcHR5QXJyYXkuc2xpY2UsCiAgICBkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudCwKICAgIGVsZW1lbnREaXNwbGF5ID0ge30sIGNsYXNzQ2FjaGUgPSB7fSwKICAgIGdldENvbXB1dGVkU3R5bGUgPSBkb2N1bWVudC5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlLAogICAgY3NzTnVtYmVyID0geyAnY29sdW1uLWNvdW50JzogMSwgJ2NvbHVtbnMnOiAxLCAnZm9udC13ZWlnaHQnOiAxLCAnbGluZS1oZWlnaHQnOiAxLCdvcGFjaXR5JzogMSwgJ3otaW5kZXgnOiAxLCAnem9vbSc6IDEgfSwKICAgIGZyYWdtZW50UkUgPSAvXlxzKjwoXHcrfCEpW14+XSo+LywKCiAgICAvLyBVc2VkIGJ5IGAkLnplcHRvLmluaXRgIHRvIHdyYXAgZWxlbWVudHMsIHRleHQvY29tbWVudCBub2RlcywgZG9jdW1lbnQsCiAgICAvLyBhbmQgZG9jdW1lbnQgZnJhZ21lbnQgbm9kZSB0eXBlcy4KICAgIGVsZW1lbnRUeXBlcyA9IFsxLCAzLCA4LCA5LCAxMV0sCgogICAgYWRqYWNlbmN5T3BlcmF0b3JzID0gWyAnYWZ0ZXInLCAncHJlcGVuZCcsICdiZWZvcmUnLCAnYXBwZW5kJyBdLAogICAgdGFibGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0YWJsZScpLAogICAgdGFibGVSb3cgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0cicpLAogICAgY29udGFpbmVycyA9IHsKICAgICAgJ3RyJzogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGJvZHknKSwKICAgICAgJ3Rib2R5JzogdGFibGUsICd0aGVhZCc6IHRhYmxlLCAndGZvb3QnOiB0YWJsZSwKICAgICAgJ3RkJzogdGFibGVSb3csICd0aCc6IHRhYmxlUm93LAogICAgICAnKic6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpCiAgICB9LAogICAgcmVhZHlSRSA9IC9jb21wbGV0ZXxsb2FkZWR8aW50ZXJhY3RpdmUvLAogICAgY2xhc3NTZWxlY3RvclJFID0gL15cLihbXHctXSspJC8sCiAgICBpZFNlbGVjdG9yUkUgPSAvXiMoW1x3LV0rKSQvLAogICAgdGFnU2VsZWN0b3JSRSA9IC9eW1x3LV0rJC8sCiAgICB0b1N0cmluZyA9ICh7fSkudG9TdHJpbmcsCiAgICB6ZXB0byA9IHt9LAogICAgY2FtZWxpemUsIHVuaXEsCiAgICB0ZW1wUGFyZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykKCiAgemVwdG8ubWF0Y2hlcyA9IGZ1bmN0aW9uKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICBpZiAoIWVsZW1lbnQgfHwgZWxlbWVudC5ub2RlVHlwZSAhPT0gMSkgcmV0dXJuIGZhbHNlCiAgICB2YXIgbWF0Y2hlc1NlbGVjdG9yID0gZWxlbWVudC53ZWJraXRNYXRjaGVzU2VsZWN0b3IgfHwgZWxlbWVudC5tb3pNYXRjaGVzU2VsZWN0b3IgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lm9NYXRjaGVzU2VsZWN0b3IgfHwgZWxlbWVudC5tYXRjaGVzU2VsZWN0b3IKICAgIGlmIChtYXRjaGVzU2VsZWN0b3IpIHJldHVybiBtYXRjaGVzU2VsZWN0b3IuY2FsbChlbGVtZW50LCBzZWxlY3RvcikKICAgIC8vIGZhbGwgYmFjayB0byBwZXJmb3JtaW5nIGEgc2VsZWN0b3I6CiAgICB2YXIgbWF0Y2gsIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZSwgdGVtcCA9ICFwYXJlbnQKICAgIGlmICh0ZW1wKSAocGFyZW50ID0gdGVtcFBhcmVudCkuYXBwZW5kQ2hpbGQoZWxlbWVudCkKICAgIG1hdGNoID0gfnplcHRvLnFzYShwYXJlbnQsIHNlbGVjdG9yKS5pbmRleE9mKGVsZW1lbnQpCiAgICB0ZW1wICYmIHRlbXBQYXJlbnQucmVtb3ZlQ2hpbGQoZWxlbWVudCkKICAgIHJldHVybiBtYXRjaAogIH0KCiAgZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSkgeyByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gIltvYmplY3QgRnVuY3Rpb25dIiB9CiAgZnVuY3Rpb24gaXNPYmplY3QodmFsdWUpIHsgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgT2JqZWN0IH0KICBmdW5jdGlvbiBpc1BsYWluT2JqZWN0KHZhbHVlKSB7CiAgICB2YXIga2V5LCBjdG9yCiAgICBpZiAodG9TdHJpbmcuY2FsbCh2YWx1ZSkgIT09ICJbb2JqZWN0IE9iamVjdF0iKSByZXR1cm4gZmFsc2UKICAgIGN0b3IgPSAoaXNGdW5jdGlvbih2YWx1ZS5jb25zdHJ1Y3RvcikgJiYgdmFsdWUuY29uc3RydWN0b3IucHJvdG90eXBlKQogICAgaWYgKCFjdG9yIHx8ICFoYXNPd25Qcm9wZXJ0eS5jYWxsKGN0b3IsICdpc1Byb3RvdHlwZU9mJykpIHJldHVybiBmYWxzZQogICAgZm9yIChrZXkgaW4gdmFsdWUpOwogICAgcmV0dXJuIGtleSA9PT0gdW5kZWZpbmVkIHx8IGhhc093blByb3BlcnR5LmNhbGwodmFsdWUsIGtleSkKICB9CiAgZnVuY3Rpb24gaXNBcnJheSh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBBcnJheSB9CiAgZnVuY3Rpb24gbGlrZUFycmF5KG9iaikgeyByZXR1cm4gdHlwZW9mIG9iai5sZW5ndGggPT0gJ251bWJlcicgfQoKICBmdW5jdGlvbiBjb21wYWN0KGFycmF5KSB7IHJldHVybiBhcnJheS5maWx0ZXIoZnVuY3Rpb24oaXRlbSl7IHJldHVybiBpdGVtICE9PSB1bmRlZmluZWQgJiYgaXRlbSAhPT0gbnVsbCB9KSB9CiAgZnVuY3Rpb24gZmxhdHRlbihhcnJheSkgeyByZXR1cm4gYXJyYXkubGVuZ3RoID4gMCA/IFtdLmNvbmNhdC5hcHBseShbXSwgYXJyYXkpIDogYXJyYXkgfQogIGNhbWVsaXplID0gZnVuY3Rpb24oc3RyKXsgcmV0dXJuIHN0ci5yZXBsYWNlKC8tKyguKT8vZywgZnVuY3Rpb24obWF0Y2gsIGNocil7IHJldHVybiBjaHIgPyBjaHIudG9VcHBlckNhc2UoKSA6ICcnIH0pIH0KICBmdW5jdGlvbiBkYXNoZXJpemUoc3RyKSB7CiAgICByZXR1cm4gc3RyLnJlcGxhY2UoLzo6L2csICcvJykKICAgICAgICAgICAucmVwbGFjZSgvKFtBLVpdKykoW0EtWl1bYS16XSkvZywgJyQxXyQyJykKICAgICAgICAgICAucmVwbGFjZSgvKFthLXpcZF0pKFtBLVpdKS9nLCAnJDFfJDInKQogICAgICAgICAgIC5yZXBsYWNlKC9fL2csICctJykKICAgICAgICAgICAudG9Mb3dlckNhc2UoKQogIH0KICB1bmlxID0gZnVuY3Rpb24oYXJyYXkpeyByZXR1cm4gYXJyYXkuZmlsdGVyKGZ1bmN0aW9uKGl0ZW0sIGlkeCl7IHJldHVybiBhcnJheS5pbmRleE9mKGl0ZW0pID09IGlkeCB9KSB9CgogIGZ1bmN0aW9uIGNsYXNzUkUobmFtZSkgewogICAgcmV0dXJuIG5hbWUgaW4gY2xhc3NDYWNoZSA/CiAgICAgIGNsYXNzQ2FjaGVbbmFtZV0gOiAoY2xhc3NDYWNoZVtuYW1lXSA9IG5ldyBSZWdFeHAoJyhefFxccyknICsgbmFtZSArICcoXFxzfCQpJykpCiAgfQoKICBmdW5jdGlvbiBtYXliZUFkZFB4KG5hbWUsIHZhbHVlKSB7CiAgICByZXR1cm4gKHR5cGVvZiB2YWx1ZSA9PSAibnVtYmVyIiAmJiAhY3NzTnVtYmVyW2Rhc2hlcml6ZShuYW1lKV0pID8gdmFsdWUgKyAicHgiIDogdmFsdWUKICB9CgogIGZ1bmN0aW9uIGRlZmF1bHREaXNwbGF5KG5vZGVOYW1lKSB7CiAgICB2YXIgZWxlbWVudCwgZGlzcGxheQogICAgaWYgKCFlbGVtZW50RGlzcGxheVtub2RlTmFtZV0pIHsKICAgICAgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQobm9kZU5hbWUpCiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZWxlbWVudCkKICAgICAgZGlzcGxheSA9IGdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgJycpLmdldFByb3BlcnR5VmFsdWUoImRpc3BsYXkiKQogICAgICBlbGVtZW50LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWxlbWVudCkKICAgICAgZGlzcGxheSA9PSAibm9uZSIgJiYgKGRpc3BsYXkgPSAiYmxvY2siKQogICAgICBlbGVtZW50RGlzcGxheVtub2RlTmFtZV0gPSBkaXNwbGF5CiAgICB9CiAgICByZXR1cm4gZWxlbWVudERpc3BsYXlbbm9kZU5hbWVdCiAgfQoKICAvLyBgJC56ZXB0by5mcmFnbWVudGAgdGFrZXMgYSBodG1sIHN0cmluZyBhbmQgYW4gb3B0aW9uYWwgdGFnIG5hbWUKICAvLyB0byBnZW5lcmF0ZSBET00gbm9kZXMgbm9kZXMgZnJvbSB0aGUgZ2l2ZW4gaHRtbCBzdHJpbmcuCiAgLy8gVGhlIGdlbmVyYXRlZCBET00gbm9kZXMgYXJlIHJldHVybmVkIGFzIGFuIGFycmF5LgogIC8vIFRoaXMgZnVuY3Rpb24gY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zIGZvciBleGFtcGxlIHRvIG1ha2UKICAvLyBpdCBjb21wYXRpYmxlIHdpdGggYnJvd3NlcnMgdGhhdCBkb24ndCBzdXBwb3J0IHRoZSBET00gZnVsbHkuCiAgemVwdG8uZnJhZ21lbnQgPSBmdW5jdGlvbihodG1sLCBuYW1lKSB7CiAgICBpZiAobmFtZSA9PT0gdW5kZWZpbmVkKSBuYW1lID0gZnJhZ21lbnRSRS50ZXN0KGh0bWwpICYmIFJlZ0V4cC4kMQogICAgaWYgKCEobmFtZSBpbiBjb250YWluZXJzKSkgbmFtZSA9ICcqJwogICAgdmFyIGNvbnRhaW5lciA9IGNvbnRhaW5lcnNbbmFtZV0KICAgIGNvbnRhaW5lci5pbm5lckhUTUwgPSAnJyArIGh0bWwKICAgIHJldHVybiAkLmVhY2goc2xpY2UuY2FsbChjb250YWluZXIuY2hpbGROb2RlcyksIGZ1bmN0aW9uKCl7CiAgICAgIGNvbnRhaW5lci5yZW1vdmVDaGlsZCh0aGlzKQogICAgfSkKICB9CgogIC8vIGAkLnplcHRvLlpgIHN3YXBzIG91dCB0aGUgcHJvdG90eXBlIG9mIHRoZSBnaXZlbiBgZG9tYCBhcnJheQogIC8vIG9mIG5vZGVzIHdpdGggYCQuZm5gIGFuZCB0aHVzIHN1cHBseWluZyBhbGwgdGhlIFplcHRvIGZ1bmN0aW9ucwogIC8vIHRvIHRoZSBhcnJheS4gTm90ZSB0aGF0IGBfX3Byb3RvX19gIGlzIG5vdCBzdXBwb3J0ZWQgb24gSW50ZXJuZXQKICAvLyBFeHBsb3Jlci4gVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zLgogIHplcHRvLlogPSBmdW5jdGlvbihkb20sIHNlbGVjdG9yKSB7CiAgICBkb20gPSBkb20gfHwgW10KICAgIGRvbS5fX3Byb3RvX18gPSBhcmd1bWVudHMuY2FsbGVlLnByb3RvdHlwZQogICAgZG9tLnNlbGVjdG9yID0gc2VsZWN0b3IgfHwgJycKICAgIHJldHVybiBkb20KICB9CgogIC8vIGAkLnplcHRvLmlzWmAgc2hvdWxkIHJldHVybiBgdHJ1ZWAgaWYgdGhlIGdpdmVuIG9iamVjdCBpcyBhIFplcHRvCiAgLy8gY29sbGVjdGlvbi4gVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zLgogIHplcHRvLmlzWiA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgcmV0dXJuIG9iamVjdCBpbnN0YW5jZW9mIHplcHRvLloKICB9CgogIC8vIGAkLnplcHRvLmluaXRgIGlzIFplcHRvJ3MgY291bnRlcnBhcnQgdG8galF1ZXJ5J3MgYCQuZm4uaW5pdGAgYW5kCiAgLy8gdGFrZXMgYSBDU1Mgc2VsZWN0b3IgYW5kIGFuIG9wdGlvbmFsIGNvbnRleHQgKGFuZCBoYW5kbGVzIHZhcmlvdXMKICAvLyBzcGVjaWFsIGNhc2VzKS4KICAvLyBUaGlzIG1ldGhvZCBjYW4gYmUgb3ZlcnJpZGVuIGluIHBsdWdpbnMuCiAgemVwdG8uaW5pdCA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBjb250ZXh0KSB7CiAgICAvLyBJZiBub3RoaW5nIGdpdmVuLCByZXR1cm4gYW4gZW1wdHkgWmVwdG8gY29sbGVjdGlvbgogICAgaWYgKCFzZWxlY3RvcikgcmV0dXJuIHplcHRvLlooKQogICAgLy8gSWYgYSBmdW5jdGlvbiBpcyBnaXZlbiwgY2FsbCBpdCB3aGVuIHRoZSBET00gaXMgcmVhZHkKICAgIGVsc2UgaWYgKGlzRnVuY3Rpb24oc2VsZWN0b3IpKSByZXR1cm4gJChkb2N1bWVudCkucmVhZHkoc2VsZWN0b3IpCiAgICAvLyBJZiBhIFplcHRvIGNvbGxlY3Rpb24gaXMgZ2l2ZW4sIGp1dHMgcmV0dXJuIGl0CiAgICBlbHNlIGlmICh6ZXB0by5pc1ooc2VsZWN0b3IpKSByZXR1cm4gc2VsZWN0b3IKICAgIGVsc2UgewogICAgICB2YXIgZG9tCiAgICAgIC8vIG5vcm1hbGl6ZSBhcnJheSBpZiBhbiBhcnJheSBvZiBub2RlcyBpcyBnaXZlbgogICAgICBpZiAoaXNBcnJheShzZWxlY3RvcikpIGRvbSA9IGNvbXBhY3Qoc2VsZWN0b3IpCiAgICAgIC8vIGlmIGEgSmF2YVNjcmlwdCBvYmplY3QgaXMgZ2l2ZW4sIHJldHVybiBhIGNvcHkgb2YgaXQKICAgICAgLy8gdGhpcyBpcyBhIHNvbWV3aGF0IHBlY3VsaWFyIG9wdGlvbiwgYnV0IHN1cHBvcnRlZCBieQogICAgICAvLyBqUXVlcnkgc28gd2UnbGwgZG8gaXQsIHRvbwogICAgICBlbHNlIGlmIChpc1BsYWluT2JqZWN0KHNlbGVjdG9yKSkKICAgICAgICBkb20gPSBbJC5leHRlbmQoe30sIHNlbGVjdG9yKV0sIHNlbGVjdG9yID0gbnVsbAogICAgICAvLyB3cmFwIHN0dWZmIGxpa2UgYGRvY3VtZW50YCBvciBgd2luZG93YAogICAgICBlbHNlIGlmIChlbGVtZW50VHlwZXMuaW5kZXhPZihzZWxlY3Rvci5ub2RlVHlwZSkgPj0gMCB8fCBzZWxlY3RvciA9PT0gd2luZG93KQogICAgICAgIGRvbSA9IFtzZWxlY3Rvcl0sIHNlbGVjdG9yID0gbnVsbAogICAgICAvLyBJZiBpdCdzIGEgaHRtbCBmcmFnbWVudCwgY3JlYXRlIG5vZGVzIGZyb20gaXQKICAgICAgZWxzZSBpZiAoZnJhZ21lbnRSRS50ZXN0KHNlbGVjdG9yKSkKICAgICAgICBkb20gPSB6ZXB0by5mcmFnbWVudChzZWxlY3Rvci50cmltKCksIFJlZ0V4cC4kMSksIHNlbGVjdG9yID0gbnVsbAogICAgICAvLyBJZiB0aGVyZSdzIGEgY29udGV4dCwgY3JlYXRlIGEgY29sbGVjdGlvbiBvbiB0aGF0IGNvbnRleHQgZmlyc3QsIGFuZCBzZWxlY3QKICAgICAgLy8gbm9kZXMgZnJvbSB0aGVyZQogICAgICBlbHNlIGlmIChjb250ZXh0ICE9PSB1bmRlZmluZWQpIHJldHVybiAkKGNvbnRleHQpLmZpbmQoc2VsZWN0b3IpCiAgICAgIC8vIEFuZCBsYXN0IGJ1dCBubyBsZWFzdCwgaWYgaXQncyBhIENTUyBzZWxlY3RvciwgdXNlIGl0IHRvIHNlbGVjdCBub2Rlcy4KICAgICAgZWxzZSBkb20gPSB6ZXB0by5xc2EoZG9jdW1lbnQsIHNlbGVjdG9yKQogICAgICAvLyBjcmVhdGUgYSBuZXcgWmVwdG8gY29sbGVjdGlvbiBmcm9tIHRoZSBub2RlcyBmb3VuZAogICAgICByZXR1cm4gemVwdG8uWihkb20sIHNlbGVjdG9yKQogICAgfQogIH0KCiAgLy8gYCRgIHdpbGwgYmUgdGhlIGJhc2UgYFplcHRvYCBvYmplY3QuIFdoZW4gY2FsbGluZyB0aGlzCiAgLy8gZnVuY3Rpb24ganVzdCBjYWxsIGAkLnplcHRvLmluaXQsIHdoaWNocyBtYWtlcyB0aGUgaW1wbGVtZW50YXRpb24KICAvLyBkZXRhaWxzIG9mIHNlbGVjdGluZyBub2RlcyBhbmQgY3JlYXRpbmcgWmVwdG8gY29sbGVjdGlvbnMKICAvLyBwYXRjaGFibGUgaW4gcGx1Z2lucy4KICAkID0gZnVuY3Rpb24oc2VsZWN0b3IsIGNvbnRleHQpewogICAgcmV0dXJuIHplcHRvLmluaXQoc2VsZWN0b3IsIGNvbnRleHQpCiAgfQoKICAvLyBDb3B5IGFsbCBidXQgdW5kZWZpbmVkIHByb3BlcnRpZXMgZnJvbSBvbmUgb3IgbW9yZQogIC8vIG9iamVjdHMgdG8gdGhlIGB0YXJnZXRgIG9iamVjdC4KICAkLmV4dGVuZCA9IGZ1bmN0aW9uKHRhcmdldCl7CiAgICBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkuZm9yRWFjaChmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgZm9yIChrZXkgaW4gc291cmNlKQogICAgICAgIGlmIChzb3VyY2Vba2V5XSAhPT0gdW5kZWZpbmVkKQogICAgICAgICAgdGFyZ2V0W2tleV0gPSBzb3VyY2Vba2V5XQogICAgfSkKICAgIHJldHVybiB0YXJnZXQKICB9CgogIC8vIGAkLnplcHRvLnFzYWAgaXMgWmVwdG8ncyBDU1Mgc2VsZWN0b3IgaW1wbGVtZW50YXRpb24gd2hpY2gKICAvLyB1c2VzIGBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsYCBhbmQgb3B0aW1pemVzIGZvciBzb21lIHNwZWNpYWwgY2FzZXMsIGxpa2UgYCNpZGAuCiAgLy8gVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zLgogIHplcHRvLnFzYSA9IGZ1bmN0aW9uKGVsZW1lbnQsIHNlbGVjdG9yKXsKICAgIHZhciBmb3VuZAogICAgcmV0dXJuIChlbGVtZW50ID09PSBkb2N1bWVudCAmJiBpZFNlbGVjdG9yUkUudGVzdChzZWxlY3RvcikpID8KICAgICAgKCAoZm91bmQgPSBlbGVtZW50LmdldEVsZW1lbnRCeUlkKFJlZ0V4cC4kMSkpID8gW2ZvdW5kXSA6IGVtcHR5QXJyYXkgKSA6CiAgICAgIChlbGVtZW50Lm5vZGVUeXBlICE9PSAxICYmIGVsZW1lbnQubm9kZVR5cGUgIT09IDkpID8gZW1wdHlBcnJheSA6CiAgICAgIHNsaWNlLmNhbGwoCiAgICAgICAgY2xhc3NTZWxlY3RvclJFLnRlc3Qoc2VsZWN0b3IpID8gZWxlbWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKFJlZ0V4cC4kMSkgOgogICAgICAgIHRhZ1NlbGVjdG9yUkUudGVzdChzZWxlY3RvcikgPyBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKHNlbGVjdG9yKSA6CiAgICAgICAgZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKQogICAgICApCiAgfQoKICBmdW5jdGlvbiBmaWx0ZXJlZChub2Rlcywgc2VsZWN0b3IpIHsKICAgIHJldHVybiBzZWxlY3RvciA9PT0gdW5kZWZpbmVkID8gJChub2RlcykgOiAkKG5vZGVzKS5maWx0ZXIoc2VsZWN0b3IpCiAgfQoKICBmdW5jdGlvbiBmdW5jQXJnKGNvbnRleHQsIGFyZywgaWR4LCBwYXlsb2FkKSB7CiAgIHJldHVybiBpc0Z1bmN0aW9uKGFyZykgPyBhcmcuY2FsbChjb250ZXh0LCBpZHgsIHBheWxvYWQpIDogYXJnCiAgfQoKICAkLmlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uCiAgJC5pc09iamVjdCA9IGlzT2JqZWN0CiAgJC5pc0FycmF5ID0gaXNBcnJheQogICQuaXNQbGFpbk9iamVjdCA9IGlzUGxhaW5PYmplY3QKCiAgJC5pbkFycmF5ID0gZnVuY3Rpb24oZWxlbSwgYXJyYXksIGkpewogICAgcmV0dXJuIGVtcHR5QXJyYXkuaW5kZXhPZi5jYWxsKGFycmF5LCBlbGVtLCBpKQogIH0KCiAgJC50cmltID0gZnVuY3Rpb24oc3RyKSB7IHJldHVybiBzdHIudHJpbSgpIH0KCiAgLy8gcGx1Z2luIGNvbXBhdGliaWxpdHkKICAkLnV1aWQgPSAwCgogICQubWFwID0gZnVuY3Rpb24oZWxlbWVudHMsIGNhbGxiYWNrKXsKICAgIHZhciB2YWx1ZSwgdmFsdWVzID0gW10sIGksIGtleQogICAgaWYgKGxpa2VBcnJheShlbGVtZW50cykpCiAgICAgIGZvciAoaSA9IDA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhbHVlID0gY2FsbGJhY2soZWxlbWVudHNbaV0sIGkpCiAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHZhbHVlcy5wdXNoKHZhbHVlKQogICAgICB9CiAgICBlbHNlCiAgICAgIGZvciAoa2V5IGluIGVsZW1lbnRzKSB7CiAgICAgICAgdmFsdWUgPSBjYWxsYmFjayhlbGVtZW50c1trZXldLCBrZXkpCiAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHZhbHVlcy5wdXNoKHZhbHVlKQogICAgICB9CiAgICByZXR1cm4gZmxhdHRlbih2YWx1ZXMpCiAgfQoKICAkLmVhY2ggPSBmdW5jdGlvbihlbGVtZW50cywgY2FsbGJhY2spewogICAgdmFyIGksIGtleQogICAgaWYgKGxpa2VBcnJheShlbGVtZW50cykpIHsKICAgICAgZm9yIChpID0gMDsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKQogICAgICAgIGlmIChjYWxsYmFjay5jYWxsKGVsZW1lbnRzW2ldLCBpLCBlbGVtZW50c1tpXSkgPT09IGZhbHNlKSByZXR1cm4gZWxlbWVudHMKICAgIH0gZWxzZSB7CiAgICAgIGZvciAoa2V5IGluIGVsZW1lbnRzKQogICAgICAgIGlmIChjYWxsYmFjay5jYWxsKGVsZW1lbnRzW2tleV0sIGtleSwgZWxlbWVudHNba2V5XSkgPT09IGZhbHNlKSByZXR1cm4gZWxlbWVudHMKICAgIH0KCiAgICByZXR1cm4gZWxlbWVudHMKICB9CgogIC8vIERlZmluZSBtZXRob2RzIHRoYXQgd2lsbCBiZSBhdmFpbGFibGUgb24gYWxsCiAgLy8gWmVwdG8gY29sbGVjdGlvbnMKICAkLmZuID0gewogICAgLy8gQmVjYXVzZSBhIGNvbGxlY3Rpb24gYWN0cyBsaWtlIGFuIGFycmF5CiAgICAvLyBjb3B5IG92ZXIgdGhlc2UgdXNlZnVsIGFycmF5IGZ1bmN0aW9ucy4KICAgIGZvckVhY2g6IGVtcHR5QXJyYXkuZm9yRWFjaCwKICAgIHJlZHVjZTogZW1wdHlBcnJheS5yZWR1Y2UsCiAgICBwdXNoOiBlbXB0eUFycmF5LnB1c2gsCiAgICBpbmRleE9mOiBlbXB0eUFycmF5LmluZGV4T2YsCiAgICBjb25jYXQ6IGVtcHR5QXJyYXkuY29uY2F0LAoKICAgIC8vIGBtYXBgIGFuZCBgc2xpY2VgIGluIHRoZSBqUXVlcnkgQVBJIHdvcmsgZGlmZmVyZW50bHkKICAgIC8vIGZyb20gdGhlaXIgYXJyYXkgY291bnRlcnBhcnRzCiAgICBtYXA6IGZ1bmN0aW9uKGZuKXsKICAgICAgcmV0dXJuICQubWFwKHRoaXMsIGZ1bmN0aW9uKGVsLCBpKXsgcmV0dXJuIGZuLmNhbGwoZWwsIGksIGVsKSB9KQogICAgfSwKICAgIHNsaWNlOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gJChzbGljZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKQogICAgfSwKCiAgICByZWFkeTogZnVuY3Rpb24oY2FsbGJhY2spewogICAgICBpZiAocmVhZHlSRS50ZXN0KGRvY3VtZW50LnJlYWR5U3RhdGUpKSBjYWxsYmFjaygkKQogICAgICBlbHNlIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBmdW5jdGlvbigpeyBjYWxsYmFjaygkKSB9LCBmYWxzZSkKICAgICAgcmV0dXJuIHRoaXMKICAgIH0sCiAgICBnZXQ6IGZ1bmN0aW9uKGlkeCl7CiAgICAgIHJldHVybiBpZHggPT09IHVuZGVmaW5lZCA/IHNsaWNlLmNhbGwodGhpcykgOiB0aGlzW2lkeF0KICAgIH0sCiAgICB0b0FycmF5OiBmdW5jdGlvbigpeyByZXR1cm4gdGhpcy5nZXQoKSB9LAogICAgc2l6ZTogZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIHRoaXMubGVuZ3RoCiAgICB9LAogICAgcmVtb3ZlOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSAhPSBudWxsKQogICAgICAgICAgdGhpcy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMpCiAgICAgIH0pCiAgICB9LAogICAgZWFjaDogZnVuY3Rpb24oY2FsbGJhY2spewogICAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24oZWwsIGlkeCl7IGNhbGxiYWNrLmNhbGwoZWwsIGlkeCwgZWwpIH0pCiAgICAgIHJldHVybiB0aGlzCiAgICB9LAogICAgZmlsdGVyOiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHJldHVybiAkKFtdLmZpbHRlci5jYWxsKHRoaXMsIGZ1bmN0aW9uKGVsZW1lbnQpewogICAgICAgIHJldHVybiB6ZXB0by5tYXRjaGVzKGVsZW1lbnQsIHNlbGVjdG9yKQogICAgICB9KSkKICAgIH0sCiAgICBhZGQ6IGZ1bmN0aW9uKHNlbGVjdG9yLGNvbnRleHQpewogICAgICByZXR1cm4gJCh1bmlxKHRoaXMuY29uY2F0KCQoc2VsZWN0b3IsY29udGV4dCkpKSkKICAgIH0sCiAgICBpczogZnVuY3Rpb24oc2VsZWN0b3IpewogICAgICByZXR1cm4gdGhpcy5sZW5ndGggPiAwICYmIHplcHRvLm1hdGNoZXModGhpc1swXSwgc2VsZWN0b3IpCiAgICB9LAogICAgbm90OiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHZhciBub2Rlcz1bXQogICAgICBpZiAoaXNGdW5jdGlvbihzZWxlY3RvcikgJiYgc2VsZWN0b3IuY2FsbCAhPT0gdW5kZWZpbmVkKQogICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgICAgaWYgKCFzZWxlY3Rvci5jYWxsKHRoaXMsaWR4KSkgbm9kZXMucHVzaCh0aGlzKQogICAgICAgIH0pCiAgICAgIGVsc2UgewogICAgICAgIHZhciBleGNsdWRlcyA9IHR5cGVvZiBzZWxlY3RvciA9PSAnc3RyaW5nJyA/IHRoaXMuZmlsdGVyKHNlbGVjdG9yKSA6CiAgICAgICAgICAobGlrZUFycmF5KHNlbGVjdG9yKSAmJiBpc0Z1bmN0aW9uKHNlbGVjdG9yLml0ZW0pKSA/IHNsaWNlLmNhbGwoc2VsZWN0b3IpIDogJChzZWxlY3RvcikKICAgICAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24oZWwpewogICAgICAgICAgaWYgKGV4Y2x1ZGVzLmluZGV4T2YoZWwpIDwgMCkgbm9kZXMucHVzaChlbCkKICAgICAgICB9KQogICAgICB9CiAgICAgIHJldHVybiAkKG5vZGVzKQogICAgfSwKICAgIGVxOiBmdW5jdGlvbihpZHgpewogICAgICByZXR1cm4gaWR4ID09PSAtMSA/IHRoaXMuc2xpY2UoaWR4KSA6IHRoaXMuc2xpY2UoaWR4LCArIGlkeCArIDEpCiAgICB9LAogICAgZmlyc3Q6IGZ1bmN0aW9uKCl7CiAgICAgIHZhciBlbCA9IHRoaXNbMF0KICAgICAgcmV0dXJuIGVsICYmICFpc09iamVjdChlbCkgPyBlbCA6ICQoZWwpCiAgICB9LAogICAgbGFzdDogZnVuY3Rpb24oKXsKICAgICAgdmFyIGVsID0gdGhpc1t0aGlzLmxlbmd0aCAtIDFdCiAgICAgIHJldHVybiBlbCAmJiAhaXNPYmplY3QoZWwpID8gZWwgOiAkKGVsKQogICAgfSwKICAgIGZpbmQ6IGZ1bmN0aW9uKHNlbGVjdG9yKXsKICAgICAgdmFyIHJlc3VsdAogICAgICBpZiAodGhpcy5sZW5ndGggPT0gMSkgcmVzdWx0ID0gemVwdG8ucXNhKHRoaXNbMF0sIHNlbGVjdG9yKQogICAgICBlbHNlIHJlc3VsdCA9IHRoaXMubWFwKGZ1bmN0aW9uKCl7IHJldHVybiB6ZXB0by5xc2EodGhpcywgc2VsZWN0b3IpIH0pCiAgICAgIHJldHVybiAkKHJlc3VsdCkKICAgIH0sCiAgICBjbG9zZXN0OiBmdW5jdGlvbihzZWxlY3RvciwgY29udGV4dCl7CiAgICAgIHZhciBub2RlID0gdGhpc1swXQogICAgICB3aGlsZSAobm9kZSAmJiAhemVwdG8ubWF0Y2hlcyhub2RlLCBzZWxlY3RvcikpCiAgICAgICAgbm9kZSA9IG5vZGUgIT09IGNvbnRleHQgJiYgbm9kZSAhPT0gZG9jdW1lbnQgJiYgbm9kZS5wYXJlbnROb2RlCiAgICAgIHJldHVybiAkKG5vZGUpCiAgICB9LAogICAgcGFyZW50czogZnVuY3Rpb24oc2VsZWN0b3IpewogICAgICB2YXIgYW5jZXN0b3JzID0gW10sIG5vZGVzID0gdGhpcwogICAgICB3aGlsZSAobm9kZXMubGVuZ3RoID4gMCkKICAgICAgICBub2RlcyA9ICQubWFwKG5vZGVzLCBmdW5jdGlvbihub2RlKXsKICAgICAgICAgIGlmICgobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkgJiYgbm9kZSAhPT0gZG9jdW1lbnQgJiYgYW5jZXN0b3JzLmluZGV4T2Yobm9kZSkgPCAwKSB7CiAgICAgICAgICAgIGFuY2VzdG9ycy5wdXNoKG5vZGUpCiAgICAgICAgICAgIHJldHVybiBub2RlCiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgcmV0dXJuIGZpbHRlcmVkKGFuY2VzdG9ycywgc2VsZWN0b3IpCiAgICB9LAogICAgcGFyZW50OiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHJldHVybiBmaWx0ZXJlZCh1bmlxKHRoaXMucGx1Y2soJ3BhcmVudE5vZGUnKSksIHNlbGVjdG9yKQogICAgfSwKICAgIGNoaWxkcmVuOiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHJldHVybiBmaWx0ZXJlZCh0aGlzLm1hcChmdW5jdGlvbigpeyByZXR1cm4gc2xpY2UuY2FsbCh0aGlzLmNoaWxkcmVuKSB9KSwgc2VsZWN0b3IpCiAgICB9LAogICAgc2libGluZ3M6IGZ1bmN0aW9uKHNlbGVjdG9yKXsKICAgICAgcmV0dXJuIGZpbHRlcmVkKHRoaXMubWFwKGZ1bmN0aW9uKGksIGVsKXsKICAgICAgICByZXR1cm4gc2xpY2UuY2FsbChlbC5wYXJlbnROb2RlLmNoaWxkcmVuKS5maWx0ZXIoZnVuY3Rpb24oY2hpbGQpeyByZXR1cm4gY2hpbGQhPT1lbCB9KQogICAgICB9KSwgc2VsZWN0b3IpCiAgICB9LAogICAgZW1wdHk6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsgdGhpcy5pbm5lckhUTUwgPSAnJyB9KQogICAgfSwKICAgIC8vIGBwbHVja2AgaXMgYm9ycm93ZWQgZnJvbSBQcm90b3R5cGUuanMKICAgIHBsdWNrOiBmdW5jdGlvbihwcm9wZXJ0eSl7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbigpeyByZXR1cm4gdGhpc1twcm9wZXJ0eV0gfSkKICAgIH0sCiAgICBzaG93OiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5zdHlsZS5kaXNwbGF5ID09ICJub25lIiAmJiAodGhpcy5zdHlsZS5kaXNwbGF5ID0gbnVsbCkKICAgICAgICBpZiAoZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLCAnJykuZ2V0UHJvcGVydHlWYWx1ZSgiZGlzcGxheSIpID09ICJub25lIikKICAgICAgICAgIHRoaXMuc3R5bGUuZGlzcGxheSA9IGRlZmF1bHREaXNwbGF5KHRoaXMubm9kZU5hbWUpCiAgICAgIH0pCiAgICB9LAogICAgcmVwbGFjZVdpdGg6IGZ1bmN0aW9uKG5ld0NvbnRlbnQpewogICAgICByZXR1cm4gdGhpcy5iZWZvcmUobmV3Q29udGVudCkucmVtb3ZlKCkKICAgIH0sCiAgICB3cmFwOiBmdW5jdGlvbihuZXdDb250ZW50KXsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICAgICQodGhpcykud3JhcEFsbCgkKG5ld0NvbnRlbnQpWzBdLmNsb25lTm9kZShmYWxzZSkpCiAgICAgIH0pCiAgICB9LAogICAgd3JhcEFsbDogZnVuY3Rpb24obmV3Q29udGVudCl7CiAgICAgIGlmICh0aGlzWzBdKSB7CiAgICAgICAgJCh0aGlzWzBdKS5iZWZvcmUobmV3Q29udGVudCA9ICQobmV3Q29udGVudCkpCiAgICAgICAgbmV3Q29udGVudC5hcHBlbmQodGhpcykKICAgICAgfQogICAgICByZXR1cm4gdGhpcwogICAgfSwKICAgIHVud3JhcDogZnVuY3Rpb24oKXsKICAgICAgdGhpcy5wYXJlbnQoKS5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgJCh0aGlzKS5yZXBsYWNlV2l0aCgkKHRoaXMpLmNoaWxkcmVuKCkpCiAgICAgIH0pCiAgICAgIHJldHVybiB0aGlzCiAgICB9LAogICAgY2xvbmU6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiAkKHRoaXMubWFwKGZ1bmN0aW9uKCl7IHJldHVybiB0aGlzLmNsb25lTm9kZSh0cnVlKSB9KSkKICAgIH0sCiAgICBoaWRlOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5jc3MoImRpc3BsYXkiLCAibm9uZSIpCiAgICB9LAogICAgdG9nZ2xlOiBmdW5jdGlvbihzZXR0aW5nKXsKICAgICAgcmV0dXJuIChzZXR0aW5nID09PSB1bmRlZmluZWQgPyB0aGlzLmNzcygiZGlzcGxheSIpID09ICJub25lIiA6IHNldHRpbmcpID8gdGhpcy5zaG93KCkgOiB0aGlzLmhpZGUoKQogICAgfSwKICAgIHByZXY6IGZ1bmN0aW9uKCl7IHJldHVybiAkKHRoaXMucGx1Y2soJ3ByZXZpb3VzRWxlbWVudFNpYmxpbmcnKSkgfSwKICAgIG5leHQ6IGZ1bmN0aW9uKCl7IHJldHVybiAkKHRoaXMucGx1Y2soJ25leHRFbGVtZW50U2libGluZycpKSB9LAogICAgaHRtbDogZnVuY3Rpb24oaHRtbCl7CiAgICAgIHJldHVybiBodG1sID09PSB1bmRlZmluZWQgPwogICAgICAgICh0aGlzLmxlbmd0aCA+IDAgPyB0aGlzWzBdLmlubmVySFRNTCA6IG51bGwpIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIHZhciBvcmlnaW5IdG1sID0gdGhpcy5pbm5lckhUTUwKICAgICAgICAgICQodGhpcykuZW1wdHkoKS5hcHBlbmQoIGZ1bmNBcmcodGhpcywgaHRtbCwgaWR4LCBvcmlnaW5IdG1sKSApCiAgICAgICAgfSkKICAgIH0sCiAgICB0ZXh0OiBmdW5jdGlvbih0ZXh0KXsKICAgICAgcmV0dXJuIHRleHQgPT09IHVuZGVmaW5lZCA/CiAgICAgICAgKHRoaXMubGVuZ3RoID4gMCA/IHRoaXNbMF0udGV4dENvbnRlbnQgOiBudWxsKSA6CiAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMudGV4dENvbnRlbnQgPSB0ZXh0IH0pCiAgICB9LAogICAgYXR0cjogZnVuY3Rpb24obmFtZSwgdmFsdWUpewogICAgICB2YXIgcmVzdWx0CiAgICAgIHJldHVybiAodHlwZW9mIG5hbWUgPT0gJ3N0cmluZycgJiYgdmFsdWUgPT09IHVuZGVmaW5lZCkgPwogICAgICAgICh0aGlzLmxlbmd0aCA9PSAwIHx8IHRoaXNbMF0ubm9kZVR5cGUgIT09IDEgPyB1bmRlZmluZWQgOgogICAgICAgICAgKG5hbWUgPT0gJ3ZhbHVlJyAmJiB0aGlzWzBdLm5vZGVOYW1lID09ICdJTlBVVCcpID8gdGhpcy52YWwoKSA6CiAgICAgICAgICAoIShyZXN1bHQgPSB0aGlzWzBdLmdldEF0dHJpYnV0ZShuYW1lKSkgJiYgbmFtZSBpbiB0aGlzWzBdKSA/IHRoaXNbMF1bbmFtZV0gOiByZXN1bHQKICAgICAgICApIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIGlmICh0aGlzLm5vZGVUeXBlICE9PSAxKSByZXR1cm4KICAgICAgICAgIGlmIChpc09iamVjdChuYW1lKSkgZm9yIChrZXkgaW4gbmFtZSkgdGhpcy5zZXRBdHRyaWJ1dGUoa2V5LCBuYW1lW2tleV0pCiAgICAgICAgICBlbHNlIHRoaXMuc2V0QXR0cmlidXRlKG5hbWUsIGZ1bmNBcmcodGhpcywgdmFsdWUsIGlkeCwgdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSkpKQogICAgICAgIH0pCiAgICB9LAogICAgcmVtb3ZlQXR0cjogZnVuY3Rpb24obmFtZSl7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsgaWYgKHRoaXMubm9kZVR5cGUgPT09IDEpIHRoaXMucmVtb3ZlQXR0cmlidXRlKG5hbWUpIH0pCiAgICB9LAogICAgcHJvcDogZnVuY3Rpb24obmFtZSwgdmFsdWUpewogICAgICByZXR1cm4gKHZhbHVlID09PSB1bmRlZmluZWQpID8KICAgICAgICAodGhpc1swXSA/IHRoaXNbMF1bbmFtZV0gOiB1bmRlZmluZWQpIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIHRoaXNbbmFtZV0gPSBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIHRoaXNbbmFtZV0pCiAgICAgICAgfSkKICAgIH0sCiAgICBkYXRhOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSl7CiAgICAgIHZhciBkYXRhID0gdGhpcy5hdHRyKCdkYXRhLScgKyBkYXNoZXJpemUobmFtZSksIHZhbHVlKQogICAgICByZXR1cm4gZGF0YSAhPT0gbnVsbCA/IGRhdGEgOiB1bmRlZmluZWQKICAgIH0sCiAgICB2YWw6IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgcmV0dXJuICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSA/CiAgICAgICAgKHRoaXMubGVuZ3RoID4gMCA/IHRoaXNbMF0udmFsdWUgOiB1bmRlZmluZWQpIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIHRoaXMudmFsdWUgPSBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIHRoaXMudmFsdWUpCiAgICAgICAgfSkKICAgIH0sCiAgICBvZmZzZXQ6IGZ1bmN0aW9uKCl7CiAgICAgIGlmICh0aGlzLmxlbmd0aD09MCkgcmV0dXJuIG51bGwKICAgICAgdmFyIG9iaiA9IHRoaXNbMF0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkKICAgICAgcmV0dXJuIHsKICAgICAgICBsZWZ0OiBvYmoubGVmdCArIHdpbmRvdy5wYWdlWE9mZnNldCwKICAgICAgICB0b3A6IG9iai50b3AgKyB3aW5kb3cucGFnZVlPZmZzZXQsCiAgICAgICAgd2lkdGg6IG9iai53aWR0aCwKICAgICAgICBoZWlnaHQ6IG9iai5oZWlnaHQKICAgICAgfQogICAgfSwKICAgIGNzczogZnVuY3Rpb24ocHJvcGVydHksIHZhbHVlKXsKICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIHByb3BlcnR5ID09ICdzdHJpbmcnKQogICAgICAgIHJldHVybiAoCiAgICAgICAgICB0aGlzLmxlbmd0aCA9PSAwCiAgICAgICAgICAgID8gdW5kZWZpbmVkCiAgICAgICAgICAgIDogdGhpc1swXS5zdHlsZVtjYW1lbGl6ZShwcm9wZXJ0eSldIHx8IGdldENvbXB1dGVkU3R5bGUodGhpc1swXSwgJycpLmdldFByb3BlcnR5VmFsdWUocHJvcGVydHkpKQoKICAgICAgdmFyIGNzcyA9ICcnCiAgICAgIGZvciAoa2V5IGluIHByb3BlcnR5KQogICAgICAgIGlmKHR5cGVvZiBwcm9wZXJ0eVtrZXldID09ICdzdHJpbmcnICYmIHByb3BlcnR5W2tleV0gPT0gJycpCiAgICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oKXsgdGhpcy5zdHlsZS5yZW1vdmVQcm9wZXJ0eShkYXNoZXJpemUoa2V5KSkgfSkKICAgICAgICBlbHNlCiAgICAgICAgICBjc3MgKz0gZGFzaGVyaXplKGtleSkgKyAnOicgKyBtYXliZUFkZFB4KGtleSwgcHJvcGVydHlba2V5XSkgKyAnOycKCiAgICAgIGlmICh0eXBlb2YgcHJvcGVydHkgPT0gJ3N0cmluZycpCiAgICAgICAgaWYgKHZhbHVlID09ICcnKQogICAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMuc3R5bGUucmVtb3ZlUHJvcGVydHkoZGFzaGVyaXplKHByb3BlcnR5KSkgfSkKICAgICAgICBlbHNlCiAgICAgICAgICBjc3MgPSBkYXNoZXJpemUocHJvcGVydHkpICsgIjoiICsgbWF5YmVBZGRQeChwcm9wZXJ0eSwgdmFsdWUpCgogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMuc3R5bGUuY3NzVGV4dCArPSAnOycgKyBjc3MgfSkKICAgIH0sCiAgICBpbmRleDogZnVuY3Rpb24oZWxlbWVudCl7CiAgICAgIHJldHVybiBlbGVtZW50ID8gdGhpcy5pbmRleE9mKCQoZWxlbWVudClbMF0pIDogdGhpcy5wYXJlbnQoKS5jaGlsZHJlbigpLmluZGV4T2YodGhpc1swXSkKICAgIH0sCiAgICBoYXNDbGFzczogZnVuY3Rpb24obmFtZSl7CiAgICAgIGlmICh0aGlzLmxlbmd0aCA8IDEpIHJldHVybiBmYWxzZQogICAgICBlbHNlIHJldHVybiBjbGFzc1JFKG5hbWUpLnRlc3QodGhpc1swXS5jbGFzc05hbWUpCiAgICB9LAogICAgYWRkQ2xhc3M6IGZ1bmN0aW9uKG5hbWUpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGlkeCl7CiAgICAgICAgY2xhc3NMaXN0ID0gW10KICAgICAgICB2YXIgY2xzID0gdGhpcy5jbGFzc05hbWUsIG5ld05hbWUgPSBmdW5jQXJnKHRoaXMsIG5hbWUsIGlkeCwgY2xzKQogICAgICAgIG5ld05hbWUuc3BsaXQoL1xzKy9nKS5mb3JFYWNoKGZ1bmN0aW9uKGtsYXNzKXsKICAgICAgICAgIGlmICghJCh0aGlzKS5oYXNDbGFzcyhrbGFzcykpIGNsYXNzTGlzdC5wdXNoKGtsYXNzKQogICAgICAgIH0sIHRoaXMpCiAgICAgICAgY2xhc3NMaXN0Lmxlbmd0aCAmJiAodGhpcy5jbGFzc05hbWUgKz0gKGNscyA/ICIgIiA6ICIiKSArIGNsYXNzTGlzdC5qb2luKCIgIikpCiAgICAgIH0pCiAgICB9LAogICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKG5hbWUpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGlkeCl7CiAgICAgICAgaWYgKG5hbWUgPT09IHVuZGVmaW5lZCkKICAgICAgICAgIHJldHVybiB0aGlzLmNsYXNzTmFtZSA9ICcnCiAgICAgICAgY2xhc3NMaXN0ID0gdGhpcy5jbGFzc05hbWUKICAgICAgICBmdW5jQXJnKHRoaXMsIG5hbWUsIGlkeCwgY2xhc3NMaXN0KS5zcGxpdCgvXHMrL2cpLmZvckVhY2goZnVuY3Rpb24oa2xhc3MpewogICAgICAgICAgY2xhc3NMaXN0ID0gY2xhc3NMaXN0LnJlcGxhY2UoY2xhc3NSRShrbGFzcyksICIgIikKICAgICAgICB9KQogICAgICAgIHRoaXMuY2xhc3NOYW1lID0gY2xhc3NMaXN0LnRyaW0oKQogICAgICB9KQogICAgfSwKICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbihuYW1lLCB3aGVuKXsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgIHZhciBuZXdOYW1lID0gZnVuY0FyZyh0aGlzLCBuYW1lLCBpZHgsIHRoaXMuY2xhc3NOYW1lKQogICAgICAgIDsod2hlbiA9PT0gdW5kZWZpbmVkID8gISQodGhpcykuaGFzQ2xhc3MobmV3TmFtZSkgOiB3aGVuKSA/CiAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKG5ld05hbWUpIDogJCh0aGlzKS5yZW1vdmVDbGFzcyhuZXdOYW1lKQogICAgICB9KQogICAgfQogIH0KCiAgLy8gR2VuZXJhdGUgdGhlIGB3aWR0aGAgYW5kIGBoZWlnaHRgIGZ1bmN0aW9ucwogIDtbJ3dpZHRoJywgJ2hlaWdodCddLmZvckVhY2goZnVuY3Rpb24oZGltZW5zaW9uKXsKICAgICQuZm5bZGltZW5zaW9uXSA9IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgdmFyIG9mZnNldCwgRGltZW5zaW9uID0gZGltZW5zaW9uLnJlcGxhY2UoLy4vLCBmdW5jdGlvbihtKXsgcmV0dXJuIG1bMF0udG9VcHBlckNhc2UoKSB9KQogICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHRoaXNbMF0gPT0gd2luZG93ID8gd2luZG93Wydpbm5lcicgKyBEaW1lbnNpb25dIDoKICAgICAgICB0aGlzWzBdID09IGRvY3VtZW50ID8gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50WydvZmZzZXQnICsgRGltZW5zaW9uXSA6CiAgICAgICAgKG9mZnNldCA9IHRoaXMub2Zmc2V0KCkpICYmIG9mZnNldFtkaW1lbnNpb25dCiAgICAgIGVsc2UgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgIHZhciBlbCA9ICQodGhpcykKICAgICAgICBlbC5jc3MoZGltZW5zaW9uLCBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIGVsW2RpbWVuc2lvbl0oKSkpCiAgICAgIH0pCiAgICB9CiAgfSkKCiAgZnVuY3Rpb24gaW5zZXJ0KG9wZXJhdG9yLCB0YXJnZXQsIG5vZGUpIHsKICAgIHZhciBwYXJlbnQgPSAob3BlcmF0b3IgJSAyKSA/IHRhcmdldCA6IHRhcmdldC5wYXJlbnROb2RlCiAgICBwYXJlbnQgPyBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsCiAgICAgICFvcGVyYXRvciA/IHRhcmdldC5uZXh0U2libGluZyA6ICAgICAgLy8gYWZ0ZXIKICAgICAgb3BlcmF0b3IgPT0gMSA/IHBhcmVudC5maXJzdENoaWxkIDogICAvLyBwcmVwZW5kCiAgICAgIG9wZXJhdG9yID09IDIgPyB0YXJnZXQgOiAgICAgICAgICAgICAgLy8gYmVmb3JlCiAgICAgIG51bGwpIDogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYXBwZW5kCiAgICAgICQobm9kZSkucmVtb3ZlKCkKICB9CgogIGZ1bmN0aW9uIHRyYXZlcnNlTm9kZShub2RlLCBmdW4pIHsKICAgIGZ1bihub2RlKQogICAgZm9yICh2YXIga2V5IGluIG5vZGUuY2hpbGROb2RlcykgdHJhdmVyc2VOb2RlKG5vZGUuY2hpbGROb2Rlc1trZXldLCBmdW4pCiAgfQoKICAvLyBHZW5lcmF0ZSB0aGUgYGFmdGVyYCwgYHByZXBlbmRgLCBgYmVmb3JlYCwgYGFwcGVuZGAsCiAgLy8gYGluc2VydEFmdGVyYCwgYGluc2VydEJlZm9yZWAsIGBhcHBlbmRUb2AsIGFuZCBgcHJlcGVuZFRvYCBtZXRob2RzLgogIGFkamFjZW5jeU9wZXJhdG9ycy5mb3JFYWNoKGZ1bmN0aW9uKGtleSwgb3BlcmF0b3IpIHsKICAgICQuZm5ba2V5XSA9IGZ1bmN0aW9uKCl7CiAgICAgIC8vIGFyZ3VtZW50cyBjYW4gYmUgbm9kZXMsIGFycmF5cyBvZiBub2RlcywgWmVwdG8gb2JqZWN0cyBhbmQgSFRNTCBzdHJpbmdzCiAgICAgIHZhciBub2RlcyA9ICQubWFwKGFyZ3VtZW50cywgZnVuY3Rpb24obil7IHJldHVybiBpc09iamVjdChuKSA/IG4gOiB6ZXB0by5mcmFnbWVudChuKSB9KQogICAgICBpZiAobm9kZXMubGVuZ3RoIDwgMSkgcmV0dXJuIHRoaXMKICAgICAgdmFyIHNpemUgPSB0aGlzLmxlbmd0aCwgY29weUJ5Q2xvbmUgPSBzaXplID4gMSwgaW5SZXZlcnNlID0gb3BlcmF0b3IgPCAyCgogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGluZGV4LCB0YXJnZXQpewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBub2RlID0gbm9kZXNbaW5SZXZlcnNlID8gbm9kZXMubGVuZ3RoLWktMSA6IGldCiAgICAgICAgICB0cmF2ZXJzZU5vZGUobm9kZSwgZnVuY3Rpb24obm9kZSl7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVOYW1lICE9IG51bGwgJiYgbm9kZS5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpID09PSAnU0NSSVBUJyAmJiAoIW5vZGUudHlwZSB8fCBub2RlLnR5cGUgPT09ICd0ZXh0L2phdmFzY3JpcHQnKSkKICAgICAgICAgICAgICB3aW5kb3dbJ2V2YWwnXS5jYWxsKHdpbmRvdywgbm9kZS5pbm5lckhUTUwpCiAgICAgICAgICB9KQogICAgICAgICAgaWYgKGNvcHlCeUNsb25lICYmIGluZGV4IDwgc2l6ZSAtIDEpIG5vZGUgPSBub2RlLmNsb25lTm9kZSh0cnVlKQogICAgICAgICAgaW5zZXJ0KG9wZXJhdG9yLCB0YXJnZXQsIG5vZGUpCiAgICAgICAgfQogICAgICB9KQogICAgfQoKICAgICQuZm5bKG9wZXJhdG9yICUgMikgPyBrZXkrJ1RvJyA6ICdpbnNlcnQnKyhvcGVyYXRvciA/ICdCZWZvcmUnIDogJ0FmdGVyJyldID0gZnVuY3Rpb24oaHRtbCl7CiAgICAgICQoaHRtbClba2V5XSh0aGlzKQogICAgICByZXR1cm4gdGhpcwogICAgfQogIH0pCgogIHplcHRvLloucHJvdG90eXBlID0gJC5mbgoKICAvLyBFeHBvcnQgaW50ZXJuYWwgQVBJIGZ1bmN0aW9ucyBpbiB0aGUgYCQuemVwdG9gIG5hbWVzcGFjZQogIHplcHRvLmNhbWVsaXplID0gY2FtZWxpemUKICB6ZXB0by51bmlxID0gdW5pcQogICQuemVwdG8gPSB6ZXB0bwoKICByZXR1cm4gJAp9KSgpCgovLyBJZiBgJGAgaXMgbm90IHlldCBkZWZpbmVkLCBwb2ludCBpdCB0byBgWmVwdG9gCndpbmRvdy5aZXB0byA9IFplcHRvCickJyBpbiB3aW5kb3cgfHwgKHdpbmRvdy4kID0gWmVwdG8pCjsoZnVuY3Rpb24oJCl7CiAgdmFyICQkID0gJC56ZXB0by5xc2EsIGhhbmRsZXJzID0ge30sIF96aWQgPSAxLCBzcGVjaWFsRXZlbnRzPXt9CgogIHNwZWNpYWxFdmVudHMuY2xpY2sgPSBzcGVjaWFsRXZlbnRzLm1vdXNlZG93biA9IHNwZWNpYWxFdmVudHMubW91c2V1cCA9IHNwZWNpYWxFdmVudHMubW91c2Vtb3ZlID0gJ01vdXNlRXZlbnRzJwoKICBmdW5jdGlvbiB6aWQoZWxlbWVudCkgewogICAgcmV0dXJuIGVsZW1lbnQuX3ppZCB8fCAoZWxlbWVudC5femlkID0gX3ppZCsrKQogIH0KICBmdW5jdGlvbiBmaW5kSGFuZGxlcnMoZWxlbWVudCwgZXZlbnQsIGZuLCBzZWxlY3RvcikgewogICAgZXZlbnQgPSBwYXJzZShldmVudCkKICAgIGlmIChldmVudC5ucykgdmFyIG1hdGNoZXIgPSBtYXRjaGVyRm9yKGV2ZW50Lm5zKQogICAgcmV0dXJuIChoYW5kbGVyc1t6aWQoZWxlbWVudCldIHx8IFtdKS5maWx0ZXIoZnVuY3Rpb24oaGFuZGxlcikgewogICAgICByZXR1cm4gaGFuZGxlcgogICAgICAgICYmICghZXZlbnQuZSAgfHwgaGFuZGxlci5lID09IGV2ZW50LmUpCiAgICAgICAgJiYgKCFldmVudC5ucyB8fCBtYXRjaGVyLnRlc3QoaGFuZGxlci5ucykpCiAgICAgICAgJiYgKCFmbiAgICAgICB8fCB6aWQoaGFuZGxlci5mbikgPT09IHppZChmbikpCiAgICAgICAgJiYgKCFzZWxlY3RvciB8fCBoYW5kbGVyLnNlbCA9PSBzZWxlY3RvcikKICAgIH0pCiAgfQogIGZ1bmN0aW9uIHBhcnNlKGV2ZW50KSB7CiAgICB2YXIgcGFydHMgPSAoJycgKyBldmVudCkuc3BsaXQoJy4nKQogICAgcmV0dXJuIHtlOiBwYXJ0c1swXSwgbnM6IHBhcnRzLnNsaWNlKDEpLnNvcnQoKS5qb2luKCcgJyl9CiAgfQogIGZ1bmN0aW9uIG1hdGNoZXJGb3IobnMpIHsKICAgIHJldHVybiBuZXcgUmVnRXhwKCcoPzpefCApJyArIG5zLnJlcGxhY2UoJyAnLCAnIC4qID8nKSArICcoPzogfCQpJykKICB9CgogIGZ1bmN0aW9uIGVhY2hFdmVudChldmVudHMsIGZuLCBpdGVyYXRvcil7CiAgICBpZiAoJC5pc09iamVjdChldmVudHMpKSAkLmVhY2goZXZlbnRzLCBpdGVyYXRvcikKICAgIGVsc2UgZXZlbnRzLnNwbGl0KC9ccy8pLmZvckVhY2goZnVuY3Rpb24odHlwZSl7IGl0ZXJhdG9yKHR5cGUsIGZuKSB9KQogIH0KCiAgLy8gV0FSTiBmaXggbmFtZXNwYWNlZCBmb2N1cyAmIGJsdXIgZXZlbnRzIGRlbGVnYXRpb24uIElzc3VlcyAjNTUyICYgIzU5NyBwYXRjaGVkIGZyb20gdGhlIHVwc3RyZWFtIGNoYW5nZXM6CiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21hZHJvYmJ5L3plcHRvL2NvbW1pdC9iYmI1Y2ExN2Q3YzE4NzRjZmYyYTlhN2MzZWE5NGE4YzhkNzlhNzkxCiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21hZHJvYmJ5L3plcHRvL2NvbW1pdC83NGJkNmY1MzFjNWJhMTU0YmU0OGU0OGZmMjIzOTI5YTBmNTdjMmZhCiAgZnVuY3Rpb24gZXZlbnRDYXB0dXJlKGhhbmRsZXIsIGNhcHR1cmVTZXR0aW5nKSB7CiAgICByZXR1cm4gaGFuZGxlci5kZWwgJiYKICAgICAgKGhhbmRsZXIuZSA9PSAnZm9jdXMnIHx8IGhhbmRsZXIuZSA9PSAnYmx1cicpIHx8CiAgICAgICEhY2FwdHVyZVNldHRpbmcKICB9CgogIGZ1bmN0aW9uIGFkZChlbGVtZW50LCBldmVudHMsIGZuLCBzZWxlY3RvciwgZ2V0RGVsZWdhdGUsIGNhcHR1cmUpewogICAgdmFyIGlkID0gemlkKGVsZW1lbnQpLCBzZXQgPSAoaGFuZGxlcnNbaWRdIHx8IChoYW5kbGVyc1tpZF0gPSBbXSkpCiAgICBlYWNoRXZlbnQoZXZlbnRzLCBmbiwgZnVuY3Rpb24oZXZlbnQsIGZuKXsKICAgICAgdmFyIGRlbGVnYXRlID0gZ2V0RGVsZWdhdGUgJiYgZ2V0RGVsZWdhdGUoZm4sIGV2ZW50KSwKICAgICAgICBjYWxsYmFjayA9IGRlbGVnYXRlIHx8IGZuCiAgICAgIHZhciBwcm94eWZuID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IGNhbGxiYWNrLmFwcGx5KGVsZW1lbnQsIFtldmVudF0uY29uY2F0KGV2ZW50LmRhdGEpKQogICAgICAgIGlmIChyZXN1bHQgPT09IGZhbHNlKSBldmVudC5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgcmV0dXJuIHJlc3VsdAogICAgICB9CiAgICAgIHZhciBoYW5kbGVyID0gJC5leHRlbmQocGFyc2UoZXZlbnQpLCB7Zm46IGZuLCBwcm94eTogcHJveHlmbiwgc2VsOiBzZWxlY3RvciwgZGVsOiBkZWxlZ2F0ZSwgaTogc2V0Lmxlbmd0aH0pCiAgICAgIHNldC5wdXNoKGhhbmRsZXIpCiAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihoYW5kbGVyLmUsIHByb3h5Zm4sIGV2ZW50Q2FwdHVyZShoYW5kbGVyLCBjYXB0dXJlKSkKICAgIH0pCiAgfQogIGZ1bmN0aW9uIHJlbW92ZShlbGVtZW50LCBldmVudHMsIGZuLCBzZWxlY3RvciwgY2FwdHVyZSl7CiAgICB2YXIgaWQgPSB6aWQoZWxlbWVudCkKICAgIGVhY2hFdmVudChldmVudHMgfHwgJycsIGZuLCBmdW5jdGlvbihldmVudCwgZm4pewogICAgICBmaW5kSGFuZGxlcnMoZWxlbWVudCwgZXZlbnQsIGZuLCBzZWxlY3RvcikuZm9yRWFjaChmdW5jdGlvbihoYW5kbGVyKXsKICAgICAgICBkZWxldGUgaGFuZGxlcnNbaWRdW2hhbmRsZXIuaV0KICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoaGFuZGxlci5lLCBoYW5kbGVyLnByb3h5LCBldmVudENhcHR1cmUoaGFuZGxlciwgY2FwdHVyZSkpCiAgICAgIH0pCiAgICB9KQogIH0KCiAgJC5ldmVudCA9IHsgYWRkOiBhZGQsIHJlbW92ZTogcmVtb3ZlIH0KCiAgJC5wcm94eSA9IGZ1bmN0aW9uKGZuLCBjb250ZXh0KSB7CiAgICBpZiAoJC5pc0Z1bmN0aW9uKGZuKSkgewogICAgICB2YXIgcHJveHlGbiA9IGZ1bmN0aW9uKCl7IHJldHVybiBmbi5hcHBseShjb250ZXh0LCBhcmd1bWVudHMpIH0KICAgICAgcHJveHlGbi5femlkID0gemlkKGZuKQogICAgICByZXR1cm4gcHJveHlGbgogICAgfSBlbHNlIGlmICh0eXBlb2YgY29udGV4dCA9PSAnc3RyaW5nJykgewogICAgICByZXR1cm4gJC5wcm94eShmbltjb250ZXh0XSwgZm4pCiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJleHBlY3RlZCBmdW5jdGlvbiIpCiAgICB9CiAgfQoKICAkLmZuLmJpbmQgPSBmdW5jdGlvbihldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICBhZGQodGhpcywgZXZlbnQsIGNhbGxiYWNrKQogICAgfSkKICB9CiAgJC5mbi51bmJpbmQgPSBmdW5jdGlvbihldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICByZW1vdmUodGhpcywgZXZlbnQsIGNhbGxiYWNrKQogICAgfSkKICB9CiAgJC5mbi5vbmUgPSBmdW5jdGlvbihldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpLCBlbGVtZW50KXsKICAgICAgYWRkKHRoaXMsIGV2ZW50LCBjYWxsYmFjaywgbnVsbCwgZnVuY3Rpb24oZm4sIHR5cGUpewogICAgICAgIHJldHVybiBmdW5jdGlvbigpewogICAgICAgICAgdmFyIHJlc3VsdCA9IGZuLmFwcGx5KGVsZW1lbnQsIGFyZ3VtZW50cykKICAgICAgICAgIHJlbW92ZShlbGVtZW50LCB0eXBlLCBmbikKICAgICAgICAgIHJldHVybiByZXN1bHQKICAgICAgICB9CiAgICAgIH0pCiAgICB9KQogIH0KCiAgdmFyIHJldHVyblRydWUgPSBmdW5jdGlvbigpe3JldHVybiB0cnVlfSwKICAgICAgcmV0dXJuRmFsc2UgPSBmdW5jdGlvbigpe3JldHVybiBmYWxzZX0sCiAgICAgIGV2ZW50TWV0aG9kcyA9IHsKICAgICAgICBwcmV2ZW50RGVmYXVsdDogJ2lzRGVmYXVsdFByZXZlbnRlZCcsCiAgICAgICAgc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOiAnaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQnLAogICAgICAgIHN0b3BQcm9wYWdhdGlvbjogJ2lzUHJvcGFnYXRpb25TdG9wcGVkJwogICAgICB9CiAgZnVuY3Rpb24gY3JlYXRlUHJveHkoZXZlbnQpIHsKICAgIHZhciBwcm94eSA9ICQuZXh0ZW5kKHtvcmlnaW5hbEV2ZW50OiBldmVudH0sIGV2ZW50KQogICAgJC5lYWNoKGV2ZW50TWV0aG9kcywgZnVuY3Rpb24obmFtZSwgcHJlZGljYXRlKSB7CiAgICAgIHByb3h5W25hbWVdID0gZnVuY3Rpb24oKXsKICAgICAgICB0aGlzW3ByZWRpY2F0ZV0gPSByZXR1cm5UcnVlCiAgICAgICAgcmV0dXJuIGV2ZW50W25hbWVdLmFwcGx5KGV2ZW50LCBhcmd1bWVudHMpCiAgICAgIH0KICAgICAgcHJveHlbcHJlZGljYXRlXSA9IHJldHVybkZhbHNlCiAgICB9KQogICAgcmV0dXJuIHByb3h5CiAgfQoKICAvLyBlbXVsYXRlcyB0aGUgJ2RlZmF1bHRQcmV2ZW50ZWQnIHByb3BlcnR5IGZvciBicm93c2VycyB0aGF0IGhhdmUgbm9uZQogIGZ1bmN0aW9uIGZpeChldmVudCkgewogICAgaWYgKCEoJ2RlZmF1bHRQcmV2ZW50ZWQnIGluIGV2ZW50KSkgewogICAgICBldmVudC5kZWZhdWx0UHJldmVudGVkID0gZmFsc2UKICAgICAgdmFyIHByZXZlbnQgPSBldmVudC5wcmV2ZW50RGVmYXVsdAogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZGVmYXVsdFByZXZlbnRlZCA9IHRydWUKICAgICAgICBwcmV2ZW50LmNhbGwodGhpcykKICAgICAgfQogICAgfQogIH0KCiAgJC5mbi5kZWxlZ2F0ZSA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpLCBlbGVtZW50KXsKICAgICAgYWRkKGVsZW1lbnQsIGV2ZW50LCBjYWxsYmFjaywgc2VsZWN0b3IsIGZ1bmN0aW9uKGZuKXsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oZSl7CiAgICAgICAgICB2YXIgZXZ0LCBtYXRjaCA9ICQoZS50YXJnZXQpLmNsb3Nlc3Qoc2VsZWN0b3IsIGVsZW1lbnQpLmdldCgwKQogICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgIGV2dCA9ICQuZXh0ZW5kKGNyZWF0ZVByb3h5KGUpLCB7Y3VycmVudFRhcmdldDogbWF0Y2gsIGxpdmVGaXJlZDogZWxlbWVudH0pCiAgICAgICAgICAgIHJldHVybiBmbi5hcHBseShtYXRjaCwgW2V2dF0uY29uY2F0KFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSkpCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KQogICAgfSkKICB9CiAgJC5mbi51bmRlbGVnYXRlID0gZnVuY3Rpb24oc2VsZWN0b3IsIGV2ZW50LCBjYWxsYmFjayl7CiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgIHJlbW92ZSh0aGlzLCBldmVudCwgY2FsbGJhY2ssIHNlbGVjdG9yKQogICAgfSkKICB9CgogICQuZm4ubGl2ZSA9IGZ1bmN0aW9uKGV2ZW50LCBjYWxsYmFjayl7CiAgICAkKGRvY3VtZW50LmJvZHkpLmRlbGVnYXRlKHRoaXMuc2VsZWN0b3IsIGV2ZW50LCBjYWxsYmFjaykKICAgIHJldHVybiB0aGlzCiAgfQogICQuZm4uZGllID0gZnVuY3Rpb24oZXZlbnQsIGNhbGxiYWNrKXsKICAgICQoZG9jdW1lbnQuYm9keSkudW5kZWxlZ2F0ZSh0aGlzLnNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spCiAgICByZXR1cm4gdGhpcwogIH0KCiAgJC5mbi5vbiA9IGZ1bmN0aW9uKGV2ZW50LCBzZWxlY3RvciwgY2FsbGJhY2spewogICAgcmV0dXJuIHNlbGVjdG9yID09IHVuZGVmaW5lZCB8fCAkLmlzRnVuY3Rpb24oc2VsZWN0b3IpID8KICAgICAgdGhpcy5iaW5kKGV2ZW50LCBzZWxlY3RvcikgOiB0aGlzLmRlbGVnYXRlKHNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spCiAgfQogICQuZm4ub2ZmID0gZnVuY3Rpb24oZXZlbnQsIHNlbGVjdG9yLCBjYWxsYmFjayl7CiAgICByZXR1cm4gc2VsZWN0b3IgPT0gdW5kZWZpbmVkIHx8ICQuaXNGdW5jdGlvbihzZWxlY3RvcikgPwogICAgICB0aGlzLnVuYmluZChldmVudCwgc2VsZWN0b3IpIDogdGhpcy51bmRlbGVnYXRlKHNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spCiAgfQoKICAkLmZuLnRyaWdnZXIgPSBmdW5jdGlvbihldmVudCwgZGF0YSl7CiAgICBpZiAodHlwZW9mIGV2ZW50ID09ICdzdHJpbmcnKSBldmVudCA9ICQuRXZlbnQoZXZlbnQpCiAgICBmaXgoZXZlbnQpCiAgICBldmVudC5kYXRhID0gZGF0YQogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICAvLyBpdGVtcyBpbiB0aGUgY29sbGVjdGlvbiBtaWdodCBub3QgYmUgRE9NIGVsZW1lbnRzCiAgICAgIC8vICh0b2RvOiBwb3NzaWJseSBzdXBwb3J0IGV2ZW50cyBvbiBwbGFpbiBvbGQgb2JqZWN0cykKICAgICAgaWYoJ2Rpc3BhdGNoRXZlbnQnIGluIHRoaXMpIHRoaXMuZGlzcGF0Y2hFdmVudChldmVudCkKICAgIH0pCiAgfQoKICAvLyB0cmlnZ2VycyBldmVudCBoYW5kbGVycyBvbiBjdXJyZW50IGVsZW1lbnQganVzdCBhcyBpZiBhbiBldmVudCBvY2N1cnJlZCwKICAvLyBkb2Vzbid0IHRyaWdnZXIgYW4gYWN0dWFsIGV2ZW50LCBkb2Vzbid0IGJ1YmJsZQogICQuZm4udHJpZ2dlckhhbmRsZXIgPSBmdW5jdGlvbihldmVudCwgZGF0YSl7CiAgICB2YXIgZSwgcmVzdWx0CiAgICB0aGlzLmVhY2goZnVuY3Rpb24oaSwgZWxlbWVudCl7CiAgICAgIGUgPSBjcmVhdGVQcm94eSh0eXBlb2YgZXZlbnQgPT0gJ3N0cmluZycgPyAkLkV2ZW50KGV2ZW50KSA6IGV2ZW50KQogICAgICBlLmRhdGEgPSBkYXRhCiAgICAgIGUudGFyZ2V0ID0gZWxlbWVudAogICAgICAkLmVhY2goZmluZEhhbmRsZXJzKGVsZW1lbnQsIGV2ZW50LnR5cGUgfHwgZXZlbnQpLCBmdW5jdGlvbihpLCBoYW5kbGVyKXsKICAgICAgICByZXN1bHQgPSBoYW5kbGVyLnByb3h5KGUpCiAgICAgICAgaWYgKGUuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSkgcmV0dXJuIGZhbHNlCiAgICAgIH0pCiAgICB9KQogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgLy8gc2hvcnRjdXQgbWV0aG9kcyBmb3IgYC5iaW5kKGV2ZW50LCBmbilgIGZvciBlYWNoIGV2ZW50IHR5cGUKICA7KCdmb2N1c2luIGZvY3Vzb3V0IGxvYWQgcmVzaXplIHNjcm9sbCB1bmxvYWQgY2xpY2sgZGJsY2xpY2sgJysKICAnbW91c2Vkb3duIG1vdXNldXAgbW91c2Vtb3ZlIG1vdXNlb3ZlciBtb3VzZW91dCAnKwogICdjaGFuZ2Ugc2VsZWN0IGtleWRvd24ga2V5cHJlc3Mga2V5dXAgZXJyb3InKS5zcGxpdCgnICcpLmZvckVhY2goZnVuY3Rpb24oZXZlbnQpIHsKICAgICQuZm5bZXZlbnRdID0gZnVuY3Rpb24oY2FsbGJhY2speyByZXR1cm4gdGhpcy5iaW5kKGV2ZW50LCBjYWxsYmFjaykgfQogIH0pCgogIDtbJ2ZvY3VzJywgJ2JsdXInXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICQuZm5bbmFtZV0gPSBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICBpZiAoY2FsbGJhY2spIHRoaXMuYmluZChuYW1lLCBjYWxsYmFjaykKICAgICAgZWxzZSBpZiAodGhpcy5sZW5ndGgpIHRyeSB7IHRoaXMuZ2V0KDApW25hbWVdKCkgfSBjYXRjaChlKXt9CiAgICAgIHJldHVybiB0aGlzCiAgICB9CiAgfSkKCiAgJC5FdmVudCA9IGZ1bmN0aW9uKHR5cGUsIHByb3BzKSB7CiAgICB2YXIgZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudChzcGVjaWFsRXZlbnRzW3R5cGVdIHx8ICdFdmVudHMnKSwgYnViYmxlcyA9IHRydWUKICAgIGlmIChwcm9wcykgZm9yICh2YXIgbmFtZSBpbiBwcm9wcykgKG5hbWUgPT0gJ2J1YmJsZXMnKSA/IChidWJibGVzID0gISFwcm9wc1tuYW1lXSkgOiAoZXZlbnRbbmFtZV0gPSBwcm9wc1tuYW1lXSkKICAgIGV2ZW50LmluaXRFdmVudCh0eXBlLCBidWJibGVzLCB0cnVlLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsKQogICAgcmV0dXJuIGV2ZW50CiAgfQoKfSkoWmVwdG8pCjsoZnVuY3Rpb24oJCl7CiAgZnVuY3Rpb24gZGV0ZWN0KHVhKXsKICAgIHZhciBvcyA9IHRoaXMub3MgPSB7fSwgYnJvd3NlciA9IHRoaXMuYnJvd3NlciA9IHt9LAogICAgICB3ZWJraXQgPSB1YS5tYXRjaCgvV2ViS2l0XC8oW1xkLl0rKS8pLAogICAgICBhbmRyb2lkID0gdWEubWF0Y2goLyhBbmRyb2lkKVxzKyhbXGQuXSspLyksCiAgICAgIGlwYWQgPSB1YS5tYXRjaCgvKGlQYWQpLipPU1xzKFtcZF9dKykvKSwKICAgICAgaXBob25lID0gIWlwYWQgJiYgdWEubWF0Y2goLyhpUGhvbmVcc09TKVxzKFtcZF9dKykvKSwKICAgICAgd2Vib3MgPSB1YS5tYXRjaCgvKHdlYk9TfGhwd09TKVtcc1wvXShbXGQuXSspLyksCiAgICAgIHRvdWNocGFkID0gd2Vib3MgJiYgdWEubWF0Y2goL1RvdWNoUGFkLyksCiAgICAgIGtpbmRsZSA9IHVhLm1hdGNoKC9LaW5kbGVcLyhbXGQuXSspLyksCiAgICAgIHNpbGsgPSB1YS5tYXRjaCgvU2lsa1wvKFtcZC5fXSspLyksCiAgICAgIGJsYWNrYmVycnkgPSB1YS5tYXRjaCgvKEJsYWNrQmVycnkpLipWZXJzaW9uXC8oW1xkLl0rKS8pCgogICAgLy8gdG9kbyBjbGVhbiB0aGlzIHVwIHdpdGggYSBiZXR0ZXIgT1MvYnJvd3NlcgogICAgLy8gc2VwYXJhdGlvbi4gd2UgbmVlZCB0byBkaXNjZXJuIGJldHdlZW4gbXVsdGlwbGUKICAgIC8vIGJyb3dzZXJzIG9uIGFuZHJvaWQsIGFuZCBkZWNpZGUgaWYga2luZGxlIGZpcmUgaW4KICAgIC8vIHNpbGsgbW9kZSBpcyBhbmRyb2lkIG9yIG5vdAoKICAgIGlmIChicm93c2VyLndlYmtpdCA9ICEhd2Via2l0KSBicm93c2VyLnZlcnNpb24gPSB3ZWJraXRbMV0KCiAgICBpZiAoYW5kcm9pZCkgb3MuYW5kcm9pZCA9IHRydWUsIG9zLnZlcnNpb24gPSBhbmRyb2lkWzJdCiAgICBpZiAoaXBob25lKSBvcy5pb3MgPSBvcy5pcGhvbmUgPSB0cnVlLCBvcy52ZXJzaW9uID0gaXBob25lWzJdLnJlcGxhY2UoL18vZywgJy4nKQogICAgaWYgKGlwYWQpIG9zLmlvcyA9IG9zLmlwYWQgPSB0cnVlLCBvcy52ZXJzaW9uID0gaXBhZFsyXS5yZXBsYWNlKC9fL2csICcuJykKICAgIGlmICh3ZWJvcykgb3Mud2Vib3MgPSB0cnVlLCBvcy52ZXJzaW9uID0gd2Vib3NbMl0KICAgIGlmICh0b3VjaHBhZCkgb3MudG91Y2hwYWQgPSB0cnVlCiAgICBpZiAoYmxhY2tiZXJyeSkgb3MuYmxhY2tiZXJyeSA9IHRydWUsIG9zLnZlcnNpb24gPSBibGFja2JlcnJ5WzJdCiAgICBpZiAoa2luZGxlKSBvcy5raW5kbGUgPSB0cnVlLCBvcy52ZXJzaW9uID0ga2luZGxlWzFdCiAgICBpZiAoc2lsaykgYnJvd3Nlci5zaWxrID0gdHJ1ZSwgYnJvd3Nlci52ZXJzaW9uID0gc2lsa1sxXQogICAgaWYgKCFzaWxrICYmIG9zLmFuZHJvaWQgJiYgdWEubWF0Y2goL0tpbmRsZSBGaXJlLykpIGJyb3dzZXIuc2lsayA9IHRydWUKICB9CgogIGRldGVjdC5jYWxsKCQsIG5hdmlnYXRvci51c2VyQWdlbnQpCiAgLy8gbWFrZSBhdmFpbGFibGUgdG8gdW5pdCB0ZXN0cwogICQuX19kZXRlY3QgPSBkZXRlY3QKCn0pKFplcHRvKQo7KGZ1bmN0aW9uKCQsIHVuZGVmaW5lZCl7CiAgdmFyIHByZWZpeCA9ICcnLCBldmVudFByZWZpeCwgZW5kRXZlbnROYW1lLCBlbmRBbmltYXRpb25OYW1lLAogICAgdmVuZG9ycyA9IHsgV2Via2l0OiAnd2Via2l0JywgTW96OiAnJywgTzogJ28nLCBtczogJ01TJyB9LAogICAgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsIHRlc3RFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLAogICAgc3VwcG9ydGVkVHJhbnNmb3JtcyA9IC9eKCh0cmFuc2xhdGV8cm90YXRlfHNjYWxlKShYfFl8WnwzZCk/fG1hdHJpeCgzZCk/fHBlcnNwZWN0aXZlfHNrZXcoWHxZKT8pJC9pLAogICAgY2xlYXJQcm9wZXJ0aWVzID0ge30KCiAgZnVuY3Rpb24gZG93bmNhc2Uoc3RyKSB7IHJldHVybiBzdHIudG9Mb3dlckNhc2UoKSB9CiAgZnVuY3Rpb24gbm9ybWFsaXplRXZlbnQobmFtZSkgeyByZXR1cm4gZXZlbnRQcmVmaXggPyBldmVudFByZWZpeCArIG5hbWUgOiBkb3duY2FzZShuYW1lKSB9CgogICQuZWFjaCh2ZW5kb3JzLCBmdW5jdGlvbih2ZW5kb3IsIGV2ZW50KXsKICAgIGlmICh0ZXN0RWwuc3R5bGVbdmVuZG9yICsgJ1RyYW5zaXRpb25Qcm9wZXJ0eSddICE9PSB1bmRlZmluZWQpIHsKICAgICAgcHJlZml4ID0gJy0nICsgZG93bmNhc2UodmVuZG9yKSArICctJwogICAgICBldmVudFByZWZpeCA9IGV2ZW50CiAgICAgIHJldHVybiBmYWxzZQogICAgfQogIH0pCgogIGNsZWFyUHJvcGVydGllc1twcmVmaXggKyAndHJhbnNpdGlvbi1wcm9wZXJ0eSddID0KICBjbGVhclByb3BlcnRpZXNbcHJlZml4ICsgJ3RyYW5zaXRpb24tZHVyYXRpb24nXSA9CiAgY2xlYXJQcm9wZXJ0aWVzW3ByZWZpeCArICd0cmFuc2l0aW9uLXRpbWluZy1mdW5jdGlvbiddID0KICBjbGVhclByb3BlcnRpZXNbcHJlZml4ICsgJ2FuaW1hdGlvbi1uYW1lJ10gPQogIGNsZWFyUHJvcGVydGllc1twcmVmaXggKyAnYW5pbWF0aW9uLWR1cmF0aW9uJ10gPSAnJwoKICAkLmZ4ID0gewogICAgb2ZmOiAoZXZlbnRQcmVmaXggPT09IHVuZGVmaW5lZCAmJiB0ZXN0RWwuc3R5bGUudHJhbnNpdGlvblByb3BlcnR5ID09PSB1bmRlZmluZWQpLAogICAgY3NzUHJlZml4OiBwcmVmaXgsCiAgICB0cmFuc2l0aW9uRW5kOiBub3JtYWxpemVFdmVudCgnVHJhbnNpdGlvbkVuZCcpLAogICAgYW5pbWF0aW9uRW5kOiBub3JtYWxpemVFdmVudCgnQW5pbWF0aW9uRW5kJykKICB9CgogICQuZm4uYW5pbWF0ZSA9IGZ1bmN0aW9uKHByb3BlcnRpZXMsIGR1cmF0aW9uLCBlYXNlLCBjYWxsYmFjayl7CiAgICBpZiAoJC5pc09iamVjdChkdXJhdGlvbikpCiAgICAgIGVhc2UgPSBkdXJhdGlvbi5lYXNpbmcsIGNhbGxiYWNrID0gZHVyYXRpb24uY29tcGxldGUsIGR1cmF0aW9uID0gZHVyYXRpb24uZHVyYXRpb24KICAgIGlmIChkdXJhdGlvbikgZHVyYXRpb24gPSBkdXJhdGlvbiAvIDEwMDAKICAgIHJldHVybiB0aGlzLmFuaW0ocHJvcGVydGllcywgZHVyYXRpb24sIGVhc2UsIGNhbGxiYWNrKQogIH0KCiAgJC5mbi5hbmltID0gZnVuY3Rpb24ocHJvcGVydGllcywgZHVyYXRpb24sIGVhc2UsIGNhbGxiYWNrKXsKICAgIHZhciB0cmFuc2Zvcm1zLCBjc3NQcm9wZXJ0aWVzID0ge30sIGtleSwgdGhhdCA9IHRoaXMsIHdyYXBwZWRDYWxsYmFjaywgZW5kRXZlbnQgPSAkLmZ4LnRyYW5zaXRpb25FbmQKICAgIGlmIChkdXJhdGlvbiA9PT0gdW5kZWZpbmVkKSBkdXJhdGlvbiA9IDAuNAogICAgaWYgKCQuZngub2ZmKSBkdXJhdGlvbiA9IDAKCiAgICBpZiAodHlwZW9mIHByb3BlcnRpZXMgPT0gJ3N0cmluZycpIHsKICAgICAgLy8ga2V5ZnJhbWUgYW5pbWF0aW9uCiAgICAgIGNzc1Byb3BlcnRpZXNbcHJlZml4ICsgJ2FuaW1hdGlvbi1uYW1lJ10gPSBwcm9wZXJ0aWVzCiAgICAgIGNzc1Byb3BlcnRpZXNbcHJlZml4ICsgJ2FuaW1hdGlvbi1kdXJhdGlvbiddID0gZHVyYXRpb24gKyAncycKICAgICAgZW5kRXZlbnQgPSAkLmZ4LmFuaW1hdGlvbkVuZAogICAgfSBlbHNlIHsKICAgICAgLy8gQ1NTIHRyYW5zaXRpb25zCiAgICAgIGZvciAoa2V5IGluIHByb3BlcnRpZXMpCiAgICAgICAgaWYgKHN1cHBvcnRlZFRyYW5zZm9ybXMudGVzdChrZXkpKSB7CiAgICAgICAgICB0cmFuc2Zvcm1zIHx8ICh0cmFuc2Zvcm1zID0gW10pCiAgICAgICAgICB0cmFuc2Zvcm1zLnB1c2goa2V5ICsgJygnICsgcHJvcGVydGllc1trZXldICsgJyknKQogICAgICAgIH0KICAgICAgICBlbHNlIGNzc1Byb3BlcnRpZXNba2V5XSA9IHByb3BlcnRpZXNba2V5XQoKICAgICAgaWYgKHRyYW5zZm9ybXMpIGNzc1Byb3BlcnRpZXNbcHJlZml4ICsgJ3RyYW5zZm9ybSddID0gdHJhbnNmb3Jtcy5qb2luKCcgJykKICAgICAgaWYgKCEkLmZ4Lm9mZiAmJiB0eXBlb2YgcHJvcGVydGllcyA9PT0gJ29iamVjdCcpIHsKICAgICAgICBjc3NQcm9wZXJ0aWVzW3ByZWZpeCArICd0cmFuc2l0aW9uLXByb3BlcnR5J10gPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKS5qb2luKCcsICcpCiAgICAgICAgY3NzUHJvcGVydGllc1twcmVmaXggKyAndHJhbnNpdGlvbi1kdXJhdGlvbiddID0gZHVyYXRpb24gKyAncycKICAgICAgICBjc3NQcm9wZXJ0aWVzW3ByZWZpeCArICd0cmFuc2l0aW9uLXRpbWluZy1mdW5jdGlvbiddID0gKGVhc2UgfHwgJ2xpbmVhcicpCiAgICAgIH0KICAgIH0KCiAgICB3cmFwcGVkQ2FsbGJhY2sgPSBmdW5jdGlvbihldmVudCl7CiAgICAgIGlmICh0eXBlb2YgZXZlbnQgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgaWYgKGV2ZW50LnRhcmdldCAhPT0gZXZlbnQuY3VycmVudFRhcmdldCkgcmV0dXJuIC8vIG1ha2VzIHN1cmUgdGhlIGV2ZW50IGRpZG4ndCBidWJibGUgZnJvbSAiYmVsb3ciCiAgICAgICAgJChldmVudC50YXJnZXQpLnVuYmluZChlbmRFdmVudCwgYXJndW1lbnRzLmNhbGxlZSkKICAgICAgfQogICAgICAkKHRoaXMpLmNzcyhjbGVhclByb3BlcnRpZXMpCiAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrLmNhbGwodGhpcykKICAgIH0KICAgIGlmIChkdXJhdGlvbiA+IDApIHRoaXMuYmluZChlbmRFdmVudCwgd3JhcHBlZENhbGxiYWNrKQoKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgIHRoYXQuY3NzKGNzc1Byb3BlcnRpZXMpCiAgICAgIGlmIChkdXJhdGlvbiA8PSAwKSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIHRoYXQuZWFjaChmdW5jdGlvbigpeyB3cmFwcGVkQ2FsbGJhY2suY2FsbCh0aGlzKSB9KQogICAgICB9LCAwKQogICAgfSwgMCkKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgdGVzdEVsID0gbnVsbAp9KShaZXB0bykKOyhmdW5jdGlvbigkKXsKICB2YXIganNvbnBJRCA9IDAsCiAgICAgIGlzT2JqZWN0ID0gJC5pc09iamVjdCwKICAgICAgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsCiAgICAgIGtleSwKICAgICAgbmFtZSwKICAgICAgcnNjcmlwdCA9IC88c2NyaXB0XGJbXjxdKig/Oig/ITxcL3NjcmlwdD4pPFtePF0qKSo8XC9zY3JpcHQ+L2dpLAogICAgICBzY3JpcHRUeXBlUkUgPSAvXig/OnRleHR8YXBwbGljYXRpb24pXC9qYXZhc2NyaXB0L2ksCiAgICAgIHhtbFR5cGVSRSA9IC9eKD86dGV4dHxhcHBsaWNhdGlvbilcL3htbC9pLAogICAgICBqc29uVHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgaHRtbFR5cGUgPSAndGV4dC9odG1sJywKICAgICAgYmxhbmtSRSA9IC9eXHMqJC8KCiAgLy8gdHJpZ2dlciBhIGN1c3RvbSBldmVudCBhbmQgcmV0dXJuIGZhbHNlIGlmIGl0IHdhcyBjYW5jZWxsZWQKICBmdW5jdGlvbiB0cmlnZ2VyQW5kUmV0dXJuKGNvbnRleHQsIGV2ZW50TmFtZSwgZGF0YSkgewogICAgdmFyIGV2ZW50ID0gJC5FdmVudChldmVudE5hbWUpCiAgICAkKGNvbnRleHQpLnRyaWdnZXIoZXZlbnQsIGRhdGEpCiAgICByZXR1cm4gIWV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQKICB9CgogIC8vIHRyaWdnZXIgYW4gQWpheCAiZ2xvYmFsIiBldmVudAogIGZ1bmN0aW9uIHRyaWdnZXJHbG9iYWwoc2V0dGluZ3MsIGNvbnRleHQsIGV2ZW50TmFtZSwgZGF0YSkgewogICAgaWYgKHNldHRpbmdzLmdsb2JhbCkgcmV0dXJuIHRyaWdnZXJBbmRSZXR1cm4oY29udGV4dCB8fCBkb2N1bWVudCwgZXZlbnROYW1lLCBkYXRhKQogIH0KCiAgLy8gTnVtYmVyIG9mIGFjdGl2ZSBBamF4IHJlcXVlc3RzCiAgJC5hY3RpdmUgPSAwCgogIGZ1bmN0aW9uIGFqYXhTdGFydChzZXR0aW5ncykgewogICAgaWYgKHNldHRpbmdzLmdsb2JhbCAmJiAkLmFjdGl2ZSsrID09PSAwKSB0cmlnZ2VyR2xvYmFsKHNldHRpbmdzLCBudWxsLCAnYWpheFN0YXJ0JykKICB9CiAgZnVuY3Rpb24gYWpheFN0b3Aoc2V0dGluZ3MpIHsKICAgIGlmIChzZXR0aW5ncy5nbG9iYWwgJiYgISgtLSQuYWN0aXZlKSkgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgbnVsbCwgJ2FqYXhTdG9wJykKICB9CgogIC8vIHRyaWdnZXJzIGFuIGV4dHJhIGdsb2JhbCBldmVudCAiYWpheEJlZm9yZVNlbmQiIHRoYXQncyBsaWtlICJhamF4U2VuZCIgYnV0IGNhbmNlbGFibGUKICBmdW5jdGlvbiBhamF4QmVmb3JlU2VuZCh4aHIsIHNldHRpbmdzKSB7CiAgICB2YXIgY29udGV4dCA9IHNldHRpbmdzLmNvbnRleHQKICAgIGlmIChzZXR0aW5ncy5iZWZvcmVTZW5kLmNhbGwoY29udGV4dCwgeGhyLCBzZXR0aW5ncykgPT09IGZhbHNlIHx8CiAgICAgICAgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgY29udGV4dCwgJ2FqYXhCZWZvcmVTZW5kJywgW3hociwgc2V0dGluZ3NdKSA9PT0gZmFsc2UpCiAgICAgIHJldHVybiBmYWxzZQoKICAgIHRyaWdnZXJHbG9iYWwoc2V0dGluZ3MsIGNvbnRleHQsICdhamF4U2VuZCcsIFt4aHIsIHNldHRpbmdzXSkKICB9CiAgZnVuY3Rpb24gYWpheFN1Y2Nlc3MoZGF0YSwgeGhyLCBzZXR0aW5ncykgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0LCBzdGF0dXMgPSAnc3VjY2VzcycKICAgIHNldHRpbmdzLnN1Y2Nlc3MuY2FsbChjb250ZXh0LCBkYXRhLCBzdGF0dXMsIHhocikKICAgIHRyaWdnZXJHbG9iYWwoc2V0dGluZ3MsIGNvbnRleHQsICdhamF4U3VjY2VzcycsIFt4aHIsIHNldHRpbmdzLCBkYXRhXSkKICAgIGFqYXhDb21wbGV0ZShzdGF0dXMsIHhociwgc2V0dGluZ3MpCiAgfQogIC8vIHR5cGU6ICJ0aW1lb3V0IiwgImVycm9yIiwgImFib3J0IiwgInBhcnNlcmVycm9yIgogIGZ1bmN0aW9uIGFqYXhFcnJvcihlcnJvciwgdHlwZSwgeGhyLCBzZXR0aW5ncykgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0CiAgICBzZXR0aW5ncy5lcnJvci5jYWxsKGNvbnRleHQsIHhociwgdHlwZSwgZXJyb3IpCiAgICB0cmlnZ2VyR2xvYmFsKHNldHRpbmdzLCBjb250ZXh0LCAnYWpheEVycm9yJywgW3hociwgc2V0dGluZ3MsIGVycm9yXSkKICAgIGFqYXhDb21wbGV0ZSh0eXBlLCB4aHIsIHNldHRpbmdzKQogIH0KICAvLyBzdGF0dXM6ICJzdWNjZXNzIiwgIm5vdG1vZGlmaWVkIiwgImVycm9yIiwgInRpbWVvdXQiLCAiYWJvcnQiLCAicGFyc2VyZXJyb3IiCiAgZnVuY3Rpb24gYWpheENvbXBsZXRlKHN0YXR1cywgeGhyLCBzZXR0aW5ncykgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0CiAgICBzZXR0aW5ncy5jb21wbGV0ZS5jYWxsKGNvbnRleHQsIHhociwgc3RhdHVzKQogICAgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgY29udGV4dCwgJ2FqYXhDb21wbGV0ZScsIFt4aHIsIHNldHRpbmdzXSkKICAgIGFqYXhTdG9wKHNldHRpbmdzKQogIH0KCiAgLy8gRW1wdHkgZnVuY3Rpb24sIHVzZWQgYXMgZGVmYXVsdCBjYWxsYmFjawogIGZ1bmN0aW9uIGVtcHR5KCkge30KCiAgJC5hamF4SlNPTlAgPSBmdW5jdGlvbihvcHRpb25zKXsKICAgIHZhciBjYWxsYmFja05hbWUgPSAnanNvbnAnICsgKCsranNvbnBJRCksCiAgICAgIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpLAogICAgICBhYm9ydCA9IGZ1bmN0aW9uKCl7CiAgICAgICAgJChzY3JpcHQpLnJlbW92ZSgpCiAgICAgICAgaWYgKGNhbGxiYWNrTmFtZSBpbiB3aW5kb3cpIHdpbmRvd1tjYWxsYmFja05hbWVdID0gZW1wdHkKICAgICAgICBhamF4Q29tcGxldGUoJ2Fib3J0JywgeGhyLCBvcHRpb25zKQogICAgICB9LAogICAgICB4aHIgPSB7IGFib3J0OiBhYm9ydCB9LCBhYm9ydFRpbWVvdXQKCiAgICBpZiAob3B0aW9ucy5lcnJvcikgc2NyaXB0Lm9uZXJyb3IgPSBmdW5jdGlvbigpIHsKICAgICAgeGhyLmFib3J0KCkKICAgICAgb3B0aW9ucy5lcnJvcigpCiAgICB9CgogICAgd2luZG93W2NhbGxiYWNrTmFtZV0gPSBmdW5jdGlvbihkYXRhKXsKICAgICAgY2xlYXJUaW1lb3V0KGFib3J0VGltZW91dCkKICAgICAgJChzY3JpcHQpLnJlbW92ZSgpCiAgICAgIGRlbGV0ZSB3aW5kb3dbY2FsbGJhY2tOYW1lXQogICAgICBhamF4U3VjY2VzcyhkYXRhLCB4aHIsIG9wdGlvbnMpCiAgICB9CgogICAgc2VyaWFsaXplRGF0YShvcHRpb25zKQogICAgc2NyaXB0LnNyYyA9IG9wdGlvbnMudXJsLnJlcGxhY2UoLz1cPy8sICc9JyArIGNhbGxiYWNrTmFtZSkKICAgICQoJ2hlYWQnKS5hcHBlbmQoc2NyaXB0KQoKICAgIGlmIChvcHRpb25zLnRpbWVvdXQgPiAwKSBhYm9ydFRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgeGhyLmFib3J0KCkKICAgICAgICBhamF4Q29tcGxldGUoJ3RpbWVvdXQnLCB4aHIsIG9wdGlvbnMpCiAgICAgIH0sIG9wdGlvbnMudGltZW91dCkKCiAgICByZXR1cm4geGhyCiAgfQoKICAkLmFqYXhTZXR0aW5ncyA9IHsKICAgIC8vIERlZmF1bHQgdHlwZSBvZiByZXF1ZXN0CiAgICB0eXBlOiAnR0VUJywKICAgIC8vIENhbGxiYWNrIHRoYXQgaXMgZXhlY3V0ZWQgYmVmb3JlIHJlcXVlc3QKICAgIGJlZm9yZVNlbmQ6IGVtcHR5LAogICAgLy8gQ2FsbGJhY2sgdGhhdCBpcyBleGVjdXRlZCBpZiB0aGUgcmVxdWVzdCBzdWNjZWVkcwogICAgc3VjY2VzczogZW1wdHksCiAgICAvLyBDYWxsYmFjayB0aGF0IGlzIGV4ZWN1dGVkIHRoZSB0aGUgc2VydmVyIGRyb3BzIGVycm9yCiAgICBlcnJvcjogZW1wdHksCiAgICAvLyBDYWxsYmFjayB0aGF0IGlzIGV4ZWN1dGVkIG9uIHJlcXVlc3QgY29tcGxldGUgKGJvdGg6IGVycm9yIGFuZCBzdWNjZXNzKQogICAgY29tcGxldGU6IGVtcHR5LAogICAgLy8gVGhlIGNvbnRleHQgZm9yIHRoZSBjYWxsYmFja3MKICAgIGNvbnRleHQ6IG51bGwsCiAgICAvLyBXaGV0aGVyIHRvIHRyaWdnZXIgImdsb2JhbCIgQWpheCBldmVudHMKICAgIGdsb2JhbDogdHJ1ZSwKICAgIC8vIFRyYW5zcG9ydAogICAgeGhyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBuZXcgd2luZG93LlhNTEh0dHBSZXF1ZXN0KCkKICAgIH0sCiAgICAvLyBNSU1FIHR5cGVzIG1hcHBpbmcKICAgIGFjY2VwdHM6IHsKICAgICAgc2NyaXB0OiAndGV4dC9qYXZhc2NyaXB0LCBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0JywKICAgICAganNvbjogICBqc29uVHlwZSwKICAgICAgeG1sOiAgICAnYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCcsCiAgICAgIGh0bWw6ICAgaHRtbFR5cGUsCiAgICAgIHRleHQ6ICAgJ3RleHQvcGxhaW4nCiAgICB9LAogICAgLy8gV2hldGhlciB0aGUgcmVxdWVzdCBpcyB0byBhbm90aGVyIGRvbWFpbgogICAgY3Jvc3NEb21haW46IGZhbHNlLAogICAgLy8gRGVmYXVsdCB0aW1lb3V0CiAgICB0aW1lb3V0OiAwCiAgfQoKICBmdW5jdGlvbiBtaW1lVG9EYXRhVHlwZShtaW1lKSB7CiAgICByZXR1cm4gbWltZSAmJiAoIG1pbWUgPT0gaHRtbFR5cGUgPyAnaHRtbCcgOgogICAgICBtaW1lID09IGpzb25UeXBlID8gJ2pzb24nIDoKICAgICAgc2NyaXB0VHlwZVJFLnRlc3QobWltZSkgPyAnc2NyaXB0JyA6CiAgICAgIHhtbFR5cGVSRS50ZXN0KG1pbWUpICYmICd4bWwnICkgfHwgJ3RleHQnCiAgfQoKICBmdW5jdGlvbiBhcHBlbmRRdWVyeSh1cmwsIHF1ZXJ5KSB7CiAgICByZXR1cm4gKHVybCArICcmJyArIHF1ZXJ5KS5yZXBsYWNlKC9bJj9dezEsMn0vLCAnPycpCiAgfQoKICAvLyBzZXJpYWxpemUgcGF5bG9hZCBhbmQgYXBwZW5kIGl0IHRvIHRoZSBVUkwgZm9yIEdFVCByZXF1ZXN0cwogIGZ1bmN0aW9uIHNlcmlhbGl6ZURhdGEob3B0aW9ucykgewogICAgaWYgKGlzT2JqZWN0KG9wdGlvbnMuZGF0YSkpIG9wdGlvbnMuZGF0YSA9ICQucGFyYW0ob3B0aW9ucy5kYXRhKQogICAgaWYgKG9wdGlvbnMuZGF0YSAmJiAoIW9wdGlvbnMudHlwZSB8fCBvcHRpb25zLnR5cGUudG9VcHBlckNhc2UoKSA9PSAnR0VUJykpCiAgICAgIG9wdGlvbnMudXJsID0gYXBwZW5kUXVlcnkob3B0aW9ucy51cmwsIG9wdGlvbnMuZGF0YSkKICB9CgogICQuYWpheCA9IGZ1bmN0aW9uKG9wdGlvbnMpewogICAgdmFyIHNldHRpbmdzID0gJC5leHRlbmQoe30sIG9wdGlvbnMgfHwge30pCiAgICBmb3IgKGtleSBpbiAkLmFqYXhTZXR0aW5ncykgaWYgKHNldHRpbmdzW2tleV0gPT09IHVuZGVmaW5lZCkgc2V0dGluZ3Nba2V5XSA9ICQuYWpheFNldHRpbmdzW2tleV0KCiAgICBhamF4U3RhcnQoc2V0dGluZ3MpCgogICAgaWYgKCFzZXR0aW5ncy5jcm9zc0RvbWFpbikgc2V0dGluZ3MuY3Jvc3NEb21haW4gPSAvXihbXHctXSs6KT9cL1wvKFteXC9dKykvLnRlc3Qoc2V0dGluZ3MudXJsKSAmJgogICAgICBSZWdFeHAuJDIgIT0gd2luZG93LmxvY2F0aW9uLmhvc3QKCiAgICB2YXIgZGF0YVR5cGUgPSBzZXR0aW5ncy5kYXRhVHlwZSwgaGFzUGxhY2Vob2xkZXIgPSAvPVw/Ly50ZXN0KHNldHRpbmdzLnVybCkKICAgIGlmIChkYXRhVHlwZSA9PSAnanNvbnAnIHx8IGhhc1BsYWNlaG9sZGVyKSB7CiAgICAgIGlmICghaGFzUGxhY2Vob2xkZXIpIHNldHRpbmdzLnVybCA9IGFwcGVuZFF1ZXJ5KHNldHRpbmdzLnVybCwgJ2NhbGxiYWNrPT8nKQogICAgICByZXR1cm4gJC5hamF4SlNPTlAoc2V0dGluZ3MpCiAgICB9CgogICAgaWYgKCFzZXR0aW5ncy51cmwpIHNldHRpbmdzLnVybCA9IHdpbmRvdy5sb2NhdGlvbi50b1N0cmluZygpCiAgICBzZXJpYWxpemVEYXRhKHNldHRpbmdzKQoKICAgIHZhciBtaW1lID0gc2V0dGluZ3MuYWNjZXB0c1tkYXRhVHlwZV0sCiAgICAgICAgYmFzZUhlYWRlcnMgPSB7IH0sCiAgICAgICAgcHJvdG9jb2wgPSAvXihbXHctXSs6KVwvXC8vLnRlc3Qoc2V0dGluZ3MudXJsKSA/IFJlZ0V4cC4kMSA6IHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbCwKICAgICAgICB4aHIgPSAkLmFqYXhTZXR0aW5ncy54aHIoKSwgYWJvcnRUaW1lb3V0CgogICAgaWYgKCFzZXR0aW5ncy5jcm9zc0RvbWFpbikgYmFzZUhlYWRlcnNbJ1gtUmVxdWVzdGVkLVdpdGgnXSA9ICdYTUxIdHRwUmVxdWVzdCcKICAgIGlmIChtaW1lKSB7CiAgICAgIGJhc2VIZWFkZXJzWydBY2NlcHQnXSA9IG1pbWUKICAgICAgaWYgKG1pbWUuaW5kZXhPZignLCcpID4gLTEpIG1pbWUgPSBtaW1lLnNwbGl0KCcsJywgMilbMF0KICAgICAgeGhyLm92ZXJyaWRlTWltZVR5cGUgJiYgeGhyLm92ZXJyaWRlTWltZVR5cGUobWltZSkKICAgIH0KICAgIGlmIChzZXR0aW5ncy5jb250ZW50VHlwZSB8fCAoc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlLnRvVXBwZXJDYXNlKCkgIT0gJ0dFVCcpKQogICAgICBiYXNlSGVhZGVyc1snQ29udGVudC1UeXBlJ10gPSAoc2V0dGluZ3MuY29udGVudFR5cGUgfHwgJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcpCiAgICBzZXR0aW5ncy5oZWFkZXJzID0gJC5leHRlbmQoYmFzZUhlYWRlcnMsIHNldHRpbmdzLmhlYWRlcnMgfHwge30pCgogICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCl7CiAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PSA0KSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KGFib3J0VGltZW91dCkKICAgICAgICB2YXIgcmVzdWx0LCBlcnJvciA9IGZhbHNlCiAgICAgICAgaWYgKCh4aHIuc3RhdHVzID49IDIwMCAmJiB4aHIuc3RhdHVzIDwgMzAwKSB8fCB4aHIuc3RhdHVzID09IDMwNCB8fCAoeGhyLnN0YXR1cyA9PSAwICYmIHByb3RvY29sID09ICdmaWxlOicpKSB7CiAgICAgICAgICBkYXRhVHlwZSA9IGRhdGFUeXBlIHx8IG1pbWVUb0RhdGFUeXBlKHhoci5nZXRSZXNwb25zZUhlYWRlcignY29udGVudC10eXBlJykpCiAgICAgICAgICByZXN1bHQgPSB4aHIucmVzcG9uc2VUZXh0CgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGRhdGFUeXBlID09ICdzY3JpcHQnKSAgICAoMSxldmFsKShyZXN1bHQpCiAgICAgICAgICAgIGVsc2UgaWYgKGRhdGFUeXBlID09ICd4bWwnKSAgcmVzdWx0ID0geGhyLnJlc3BvbnNlWE1MCiAgICAgICAgICAgIGVsc2UgaWYgKGRhdGFUeXBlID09ICdqc29uJykgcmVzdWx0ID0gYmxhbmtSRS50ZXN0KHJlc3VsdCkgPyBudWxsIDogSlNPTi5wYXJzZShyZXN1bHQpCiAgICAgICAgICB9IGNhdGNoIChlKSB7IGVycm9yID0gZSB9CgogICAgICAgICAgaWYgKGVycm9yKSBhamF4RXJyb3IoZXJyb3IsICdwYXJzZXJlcnJvcicsIHhociwgc2V0dGluZ3MpCiAgICAgICAgICBlbHNlIGFqYXhTdWNjZXNzKHJlc3VsdCwgeGhyLCBzZXR0aW5ncykKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYWpheEVycm9yKG51bGwsICdlcnJvcicsIHhociwgc2V0dGluZ3MpCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgdmFyIGFzeW5jID0gJ2FzeW5jJyBpbiBzZXR0aW5ncyA/IHNldHRpbmdzLmFzeW5jIDogdHJ1ZQogICAgeGhyLm9wZW4oc2V0dGluZ3MudHlwZSwgc2V0dGluZ3MudXJsLCBhc3luYykKCiAgICBmb3IgKG5hbWUgaW4gc2V0dGluZ3MuaGVhZGVycykgeGhyLnNldFJlcXVlc3RIZWFkZXIobmFtZSwgc2V0dGluZ3MuaGVhZGVyc1tuYW1lXSkKCiAgICBpZiAoYWpheEJlZm9yZVNlbmQoeGhyLCBzZXR0aW5ncykgPT09IGZhbHNlKSB7CiAgICAgIHhoci5hYm9ydCgpCiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGlmIChzZXR0aW5ncy50aW1lb3V0ID4gMCkgYWJvcnRUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBlbXB0eQogICAgICAgIHhoci5hYm9ydCgpCiAgICAgICAgYWpheEVycm9yKG51bGwsICd0aW1lb3V0JywgeGhyLCBzZXR0aW5ncykKICAgICAgfSwgc2V0dGluZ3MudGltZW91dCkKCiAgICAvLyBhdm9pZCBzZW5kaW5nIGVtcHR5IHN0cmluZyAoIzMxOSkKICAgIHhoci5zZW5kKHNldHRpbmdzLmRhdGEgPyBzZXR0aW5ncy5kYXRhIDogbnVsbCkKICAgIHJldHVybiB4aHIKICB9CgogICQuZ2V0ID0gZnVuY3Rpb24odXJsLCBzdWNjZXNzKXsgcmV0dXJuICQuYWpheCh7IHVybDogdXJsLCBzdWNjZXNzOiBzdWNjZXNzIH0pIH0KCiAgJC5wb3N0ID0gZnVuY3Rpb24odXJsLCBkYXRhLCBzdWNjZXNzLCBkYXRhVHlwZSl7CiAgICBpZiAoJC5pc0Z1bmN0aW9uKGRhdGEpKSBkYXRhVHlwZSA9IGRhdGFUeXBlIHx8IHN1Y2Nlc3MsIHN1Y2Nlc3MgPSBkYXRhLCBkYXRhID0gbnVsbAogICAgcmV0dXJuICQuYWpheCh7IHR5cGU6ICdQT1NUJywgdXJsOiB1cmwsIGRhdGE6IGRhdGEsIHN1Y2Nlc3M6IHN1Y2Nlc3MsIGRhdGFUeXBlOiBkYXRhVHlwZSB9KQogIH0KCiAgJC5nZXRKU09OID0gZnVuY3Rpb24odXJsLCBzdWNjZXNzKXsKICAgIHJldHVybiAkLmFqYXgoeyB1cmw6IHVybCwgc3VjY2Vzczogc3VjY2VzcywgZGF0YVR5cGU6ICdqc29uJyB9KQogIH0KCiAgJC5mbi5sb2FkID0gZnVuY3Rpb24odXJsLCBzdWNjZXNzKXsKICAgIGlmICghdGhpcy5sZW5ndGgpIHJldHVybiB0aGlzCiAgICB2YXIgc2VsZiA9IHRoaXMsIHBhcnRzID0gdXJsLnNwbGl0KC9ccy8pLCBzZWxlY3RvcgogICAgaWYgKHBhcnRzLmxlbmd0aCA+IDEpIHVybCA9IHBhcnRzWzBdLCBzZWxlY3RvciA9IHBhcnRzWzFdCiAgICAkLmdldCh1cmwsIGZ1bmN0aW9uKHJlc3BvbnNlKXsKICAgICAgc2VsZi5odG1sKHNlbGVjdG9yID8KICAgICAgICAkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpKS5odG1sKHJlc3BvbnNlLnJlcGxhY2UocnNjcmlwdCwgIiIpKS5maW5kKHNlbGVjdG9yKS5odG1sKCkKICAgICAgICA6IHJlc3BvbnNlKQogICAgICBzdWNjZXNzICYmIHN1Y2Nlc3MuY2FsbChzZWxmKQogICAgfSkKICAgIHJldHVybiB0aGlzCiAgfQoKICB2YXIgZXNjYXBlID0gZW5jb2RlVVJJQ29tcG9uZW50CgogIGZ1bmN0aW9uIHNlcmlhbGl6ZShwYXJhbXMsIG9iaiwgdHJhZGl0aW9uYWwsIHNjb3BlKXsKICAgIHZhciBhcnJheSA9ICQuaXNBcnJheShvYmopCiAgICAkLmVhY2gob2JqLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIGlmIChzY29wZSkga2V5ID0gdHJhZGl0aW9uYWwgPyBzY29wZSA6IHNjb3BlICsgJ1snICsgKGFycmF5ID8gJycgOiBrZXkpICsgJ10nCiAgICAgIC8vIGhhbmRsZSBkYXRhIGluIHNlcmlhbGl6ZUFycmF5KCkgZm9ybWF0CiAgICAgIGlmICghc2NvcGUgJiYgYXJyYXkpIHBhcmFtcy5hZGQodmFsdWUubmFtZSwgdmFsdWUudmFsdWUpCiAgICAgIC8vIHJlY3Vyc2UgaW50byBuZXN0ZWQgb2JqZWN0cwogICAgICBlbHNlIGlmICh0cmFkaXRpb25hbCA/ICQuaXNBcnJheSh2YWx1ZSkgOiBpc09iamVjdCh2YWx1ZSkpCiAgICAgICAgc2VyaWFsaXplKHBhcmFtcywgdmFsdWUsIHRyYWRpdGlvbmFsLCBrZXkpCiAgICAgIGVsc2UgcGFyYW1zLmFkZChrZXksIHZhbHVlKQogICAgfSkKICB9CgogICQucGFyYW0gPSBmdW5jdGlvbihvYmosIHRyYWRpdGlvbmFsKXsKICAgIHZhciBwYXJhbXMgPSBbXQogICAgcGFyYW1zLmFkZCA9IGZ1bmN0aW9uKGssIHYpeyB0aGlzLnB1c2goZXNjYXBlKGspICsgJz0nICsgZXNjYXBlKHYpKSB9CiAgICBzZXJpYWxpemUocGFyYW1zLCBvYmosIHRyYWRpdGlvbmFsKQogICAgcmV0dXJuIHBhcmFtcy5qb2luKCcmJykucmVwbGFjZSgnJTIwJywgJysnKQogIH0KfSkoWmVwdG8pCjsoZnVuY3Rpb24gKCQpIHsKICAkLmZuLnNlcmlhbGl6ZUFycmF5ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHJlc3VsdCA9IFtdLCBlbAogICAgJCggQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcy5nZXQoMCkuZWxlbWVudHMpICkuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgIGVsID0gJCh0aGlzKQogICAgICB2YXIgdHlwZSA9IGVsLmF0dHIoJ3R5cGUnKQogICAgICBpZiAodGhpcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9ICdmaWVsZHNldCcgJiYKICAgICAgICAhdGhpcy5kaXNhYmxlZCAmJiB0eXBlICE9ICdzdWJtaXQnICYmIHR5cGUgIT0gJ3Jlc2V0JyAmJiB0eXBlICE9ICdidXR0b24nICYmCiAgICAgICAgKCh0eXBlICE9ICdyYWRpbycgJiYgdHlwZSAhPSAnY2hlY2tib3gnKSB8fCB0aGlzLmNoZWNrZWQpKQogICAgICAgIHJlc3VsdC5wdXNoKHsKICAgICAgICAgIG5hbWU6IGVsLmF0dHIoJ25hbWUnKSwKICAgICAgICAgIHZhbHVlOiBlbC52YWwoKQogICAgICAgIH0pCiAgICB9KQogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgJC5mbi5zZXJpYWxpemUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgcmVzdWx0ID0gW10KICAgIHRoaXMuc2VyaWFsaXplQXJyYXkoKS5mb3JFYWNoKGZ1bmN0aW9uIChlbG0pIHsKICAgICAgcmVzdWx0LnB1c2goIGVuY29kZVVSSUNvbXBvbmVudChlbG0ubmFtZSkgKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQoZWxtLnZhbHVlKSApCiAgICB9KQogICAgcmV0dXJuIHJlc3VsdC5qb2luKCcmJykKICB9CgogICQuZm4uc3VibWl0ID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICBpZiAoY2FsbGJhY2spIHRoaXMuYmluZCgnc3VibWl0JywgY2FsbGJhY2spCiAgICBlbHNlIGlmICh0aGlzLmxlbmd0aCkgewogICAgICB2YXIgZXZlbnQgPSAkLkV2ZW50KCdzdWJtaXQnKQogICAgICB0aGlzLmVxKDApLnRyaWdnZXIoZXZlbnQpCiAgICAgIGlmICghZXZlbnQuZGVmYXVsdFByZXZlbnRlZCkgdGhpcy5nZXQoMCkuc3VibWl0KCkKICAgIH0KICAgIHJldHVybiB0aGlzCiAgfQoKfSkoWmVwdG8pCjsoZnVuY3Rpb24oJCl7CiAgdmFyIHRvdWNoID0ge30sIHRvdWNoVGltZW91dAoKICBmdW5jdGlvbiBwYXJlbnRJZlRleHQobm9kZSl7CiAgICByZXR1cm4gJ3RhZ05hbWUnIGluIG5vZGUgPyBub2RlIDogbm9kZS5wYXJlbnROb2RlCiAgfQoKICBmdW5jdGlvbiBzd2lwZURpcmVjdGlvbih4MSwgeDIsIHkxLCB5Mil7CiAgICB2YXIgeERlbHRhID0gTWF0aC5hYnMoeDEgLSB4MiksIHlEZWx0YSA9IE1hdGguYWJzKHkxIC0geTIpCiAgICByZXR1cm4geERlbHRhID49IHlEZWx0YSA/ICh4MSAtIHgyID4gMCA/ICdMZWZ0JyA6ICdSaWdodCcpIDogKHkxIC0geTIgPiAwID8gJ1VwJyA6ICdEb3duJykKICB9CgogIHZhciBsb25nVGFwRGVsYXkgPSA3NTAsIGxvbmdUYXBUaW1lb3V0CgogIGZ1bmN0aW9uIGxvbmdUYXAoKXsKICAgIGxvbmdUYXBUaW1lb3V0ID0gbnVsbAogICAgaWYgKHRvdWNoLmxhc3QpIHsKICAgICAgdG91Y2guZWwudHJpZ2dlcignbG9uZ1RhcCcpCiAgICAgIHRvdWNoID0ge30KICAgIH0KICB9CgogIGZ1bmN0aW9uIGNhbmNlbExvbmdUYXAoKXsKICAgIGlmIChsb25nVGFwVGltZW91dCkgY2xlYXJUaW1lb3V0KGxvbmdUYXBUaW1lb3V0KQogICAgbG9uZ1RhcFRpbWVvdXQgPSBudWxsCiAgfQoKICAkKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpewogICAgdmFyIG5vdywgZGVsdGEKCiAgICAkKGRvY3VtZW50LmJvZHkpLmJpbmQoJ3RvdWNoc3RhcnQnLCBmdW5jdGlvbihlKXsKICAgICAgbm93ID0gRGF0ZS5ub3coKQogICAgICBkZWx0YSA9IG5vdyAtICh0b3VjaC5sYXN0IHx8IG5vdykKICAgICAgdG91Y2guZWwgPSAkKHBhcmVudElmVGV4dChlLnRvdWNoZXNbMF0udGFyZ2V0KSkKICAgICAgdG91Y2hUaW1lb3V0ICYmIGNsZWFyVGltZW91dCh0b3VjaFRpbWVvdXQpCiAgICAgIHRvdWNoLngxID0gZS50b3VjaGVzWzBdLnBhZ2VYCiAgICAgIHRvdWNoLnkxID0gZS50b3VjaGVzWzBdLnBhZ2VZCiAgICAgIGlmIChkZWx0YSA+IDAgJiYgZGVsdGEgPD0gMjUwKSB0b3VjaC5pc0RvdWJsZVRhcCA9IHRydWUKICAgICAgdG91Y2gubGFzdCA9IG5vdwogICAgICBsb25nVGFwVGltZW91dCA9IHNldFRpbWVvdXQobG9uZ1RhcCwgbG9uZ1RhcERlbGF5KQogICAgfSkuYmluZCgndG91Y2htb3ZlJywgZnVuY3Rpb24oZSl7CiAgICAgIGNhbmNlbExvbmdUYXAoKQogICAgICB0b3VjaC54MiA9IGUudG91Y2hlc1swXS5wYWdlWAogICAgICB0b3VjaC55MiA9IGUudG91Y2hlc1swXS5wYWdlWQogICAgfSkuYmluZCgndG91Y2hlbmQnLCBmdW5jdGlvbihlKXsKICAgICAgIGNhbmNlbExvbmdUYXAoKQoKICAgICAgLy8gZG91YmxlIHRhcCAodGFwcGVkIHR3aWNlIHdpdGhpbiAyNTBtcykKICAgICAgaWYgKHRvdWNoLmlzRG91YmxlVGFwKSB7CiAgICAgICAgdG91Y2guZWwudHJpZ2dlcignZG91YmxlVGFwJykKICAgICAgICB0b3VjaCA9IHt9CgogICAgICAvLyBzd2lwZQogICAgICB9IGVsc2UgaWYgKCh0b3VjaC54MiAmJiBNYXRoLmFicyh0b3VjaC54MSAtIHRvdWNoLngyKSA+IDMwKSB8fAogICAgICAgICAgICAgICAgICh0b3VjaC55MiAmJiBNYXRoLmFicyh0b3VjaC55MSAtIHRvdWNoLnkyKSA+IDMwKSkgewogICAgICAgIHRvdWNoLmVsLnRyaWdnZXIoJ3N3aXBlJykgJiYKICAgICAgICAgIHRvdWNoLmVsLnRyaWdnZXIoJ3N3aXBlJyArIChzd2lwZURpcmVjdGlvbih0b3VjaC54MSwgdG91Y2gueDIsIHRvdWNoLnkxLCB0b3VjaC55MikpKQogICAgICAgIHRvdWNoID0ge30KCiAgICAgIC8vIG5vcm1hbCB0YXAKICAgICAgfSBlbHNlIGlmICgnbGFzdCcgaW4gdG91Y2gpIHsKICAgICAgICB0b3VjaC5lbC50cmlnZ2VyKCd0YXAnKQoKICAgICAgICB0b3VjaFRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICB0b3VjaFRpbWVvdXQgPSBudWxsCiAgICAgICAgICB0b3VjaC5lbC50cmlnZ2VyKCdzaW5nbGVUYXAnKQogICAgICAgICAgdG91Y2ggPSB7fQogICAgICAgIH0sIDI1MCkKICAgICAgfQogICAgfSkuYmluZCgndG91Y2hjYW5jZWwnLCBmdW5jdGlvbigpewogICAgICBpZiAodG91Y2hUaW1lb3V0KSBjbGVhclRpbWVvdXQodG91Y2hUaW1lb3V0KQogICAgICBpZiAobG9uZ1RhcFRpbWVvdXQpIGNsZWFyVGltZW91dChsb25nVGFwVGltZW91dCkKICAgICAgbG9uZ1RhcFRpbWVvdXQgPSB0b3VjaFRpbWVvdXQgPSBudWxsCiAgICAgIHRvdWNoID0ge30KICAgIH0pCiAgfSkKCiAgO1snc3dpcGUnLCAnc3dpcGVMZWZ0JywgJ3N3aXBlUmlnaHQnLCAnc3dpcGVVcCcsICdzd2lwZURvd24nLCAnZG91YmxlVGFwJywgJ3RhcCcsICdzaW5nbGVUYXAnLCAnbG9uZ1RhcCddLmZvckVhY2goZnVuY3Rpb24obSl7CiAgICAkLmZuW21dID0gZnVuY3Rpb24oY2FsbGJhY2speyByZXR1cm4gdGhpcy5iaW5kKG0sIGNhbGxiYWNrKSB9CiAgfSkKfSkoWmVwdG8pCgovLyBsaWIvaGFuZGxlYmFycy9iYXNlLmpzCgovKmpzaGludCBlcW51bGw6dHJ1ZSovCnRoaXMuSGFuZGxlYmFycyA9IHt9OwoKKGZ1bmN0aW9uKEhhbmRsZWJhcnMpIHsKCkhhbmRsZWJhcnMuVkVSU0lPTiA9ICIxLjAucmMuMSI7CgpIYW5kbGViYXJzLmhlbHBlcnMgID0ge307CkhhbmRsZWJhcnMucGFydGlhbHMgPSB7fTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIgPSBmdW5jdGlvbihuYW1lLCBmbiwgaW52ZXJzZSkgewogIGlmKGludmVyc2UpIHsgZm4ubm90ID0gaW52ZXJzZTsgfQogIHRoaXMuaGVscGVyc1tuYW1lXSA9IGZuOwp9OwoKSGFuZGxlYmFycy5yZWdpc3RlclBhcnRpYWwgPSBmdW5jdGlvbihuYW1lLCBzdHIpIHsKICB0aGlzLnBhcnRpYWxzW25hbWVdID0gc3RyOwp9OwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaGVscGVyTWlzc2luZycsIGZ1bmN0aW9uKGFyZykgewogIGlmKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHsKICAgIHJldHVybiB1bmRlZmluZWQ7CiAgfSBlbHNlIHsKICAgIHRocm93IG5ldyBFcnJvcigiQ291bGQgbm90IGZpbmQgcHJvcGVydHkgJyIgKyBhcmcgKyAiJyIpOwogIH0KfSk7Cgp2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLCBmdW5jdGlvblR5cGUgPSAiW29iamVjdCBGdW5jdGlvbl0iOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignYmxvY2tIZWxwZXJNaXNzaW5nJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHZhciBpbnZlcnNlID0gb3B0aW9ucy5pbnZlcnNlIHx8IGZ1bmN0aW9uKCkge30sIGZuID0gb3B0aW9ucy5mbjsKCgogIHZhciByZXQgPSAiIjsKICB2YXIgdHlwZSA9IHRvU3RyaW5nLmNhbGwoY29udGV4dCk7CgogIGlmKHR5cGUgPT09IGZ1bmN0aW9uVHlwZSkgeyBjb250ZXh0ID0gY29udGV4dC5jYWxsKHRoaXMpOyB9CgogIGlmKGNvbnRleHQgPT09IHRydWUpIHsKICAgIHJldHVybiBmbih0aGlzKTsKICB9IGVsc2UgaWYoY29udGV4dCA9PT0gZmFsc2UgfHwgY29udGV4dCA9PSBudWxsKSB7CiAgICByZXR1cm4gaW52ZXJzZSh0aGlzKTsKICB9IGVsc2UgaWYodHlwZSA9PT0gIltvYmplY3QgQXJyYXldIikgewogICAgaWYoY29udGV4dC5sZW5ndGggPiAwKSB7CiAgICAgIHJldHVybiBIYW5kbGViYXJzLmhlbHBlcnMuZWFjaChjb250ZXh0LCBvcHRpb25zKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBpbnZlcnNlKHRoaXMpOwogICAgfQogIH0gZWxzZSB7CiAgICByZXR1cm4gZm4oY29udGV4dCk7CiAgfQp9KTsKCkhhbmRsZWJhcnMuSyA9IGZ1bmN0aW9uKCkge307CgpIYW5kbGViYXJzLmNyZWF0ZUZyYW1lID0gT2JqZWN0LmNyZWF0ZSB8fCBmdW5jdGlvbihvYmplY3QpIHsKICBIYW5kbGViYXJzLksucHJvdG90eXBlID0gb2JqZWN0OwogIHZhciBvYmogPSBuZXcgSGFuZGxlYmFycy5LKCk7CiAgSGFuZGxlYmFycy5LLnByb3RvdHlwZSA9IG51bGw7CiAgcmV0dXJuIG9iajsKfTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2VhY2gnLCBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgdmFyIGZuID0gb3B0aW9ucy5mbiwgaW52ZXJzZSA9IG9wdGlvbnMuaW52ZXJzZTsKICB2YXIgcmV0ID0gIiIsIGRhdGE7CgogIGlmIChvcHRpb25zLmRhdGEpIHsKICAgIGRhdGEgPSBIYW5kbGViYXJzLmNyZWF0ZUZyYW1lKG9wdGlvbnMuZGF0YSk7CiAgfQoKICBpZihjb250ZXh0ICYmIGNvbnRleHQubGVuZ3RoID4gMCkgewogICAgZm9yKHZhciBpPTAsIGo9Y29udGV4dC5sZW5ndGg7IGk8ajsgaSsrKSB7CiAgICAgIGlmIChkYXRhKSB7IGRhdGEuaW5kZXggPSBpOyB9CiAgICAgIHJldCA9IHJldCArIGZuKGNvbnRleHRbaV0sIHsgZGF0YTogZGF0YSB9KTsKICAgIH0KICB9IGVsc2UgewogICAgcmV0ID0gaW52ZXJzZSh0aGlzKTsKICB9CiAgcmV0dXJuIHJldDsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpZicsIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICB2YXIgdHlwZSA9IHRvU3RyaW5nLmNhbGwoY29udGV4dCk7CiAgaWYodHlwZSA9PT0gZnVuY3Rpb25UeXBlKSB7IGNvbnRleHQgPSBjb250ZXh0LmNhbGwodGhpcyk7IH0KCiAgaWYoIWNvbnRleHQgfHwgSGFuZGxlYmFycy5VdGlscy5pc0VtcHR5KGNvbnRleHQpKSB7CiAgICByZXR1cm4gb3B0aW9ucy5pbnZlcnNlKHRoaXMpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gb3B0aW9ucy5mbih0aGlzKTsKICB9Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcigndW5sZXNzJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHZhciBmbiA9IG9wdGlvbnMuZm4sIGludmVyc2UgPSBvcHRpb25zLmludmVyc2U7CiAgb3B0aW9ucy5mbiA9IGludmVyc2U7CiAgb3B0aW9ucy5pbnZlcnNlID0gZm47CgogIHJldHVybiBIYW5kbGViYXJzLmhlbHBlcnNbJ2lmJ10uY2FsbCh0aGlzLCBjb250ZXh0LCBvcHRpb25zKTsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd3aXRoJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHJldHVybiBvcHRpb25zLmZuKGNvbnRleHQpOwp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2xvZycsIGZ1bmN0aW9uKGNvbnRleHQpIHsKICBIYW5kbGViYXJzLmxvZyhjb250ZXh0KTsKfSk7Cgp9KHRoaXMuSGFuZGxlYmFycykpOwo7Ci8vIGxpYi9oYW5kbGViYXJzL2NvbXBpbGVyL3BhcnNlci5qcwovKiBKaXNvbiBnZW5lcmF0ZWQgcGFyc2VyICovCnZhciBoYW5kbGViYXJzID0gKGZ1bmN0aW9uKCl7CnZhciBwYXJzZXIgPSB7dHJhY2U6IGZ1bmN0aW9uIHRyYWNlKCkgeyB9LAp5eToge30sCnN5bWJvbHNfOiB7ImVycm9yIjoyLCJyb290IjozLCJwcm9ncmFtIjo0LCJFT0YiOjUsInN0YXRlbWVudHMiOjYsInNpbXBsZUludmVyc2UiOjcsInN0YXRlbWVudCI6OCwib3BlbkludmVyc2UiOjksImNsb3NlQmxvY2siOjEwLCJvcGVuQmxvY2siOjExLCJtdXN0YWNoZSI6MTIsInBhcnRpYWwiOjEzLCJDT05URU5UIjoxNCwiQ09NTUVOVCI6MTUsIk9QRU5fQkxPQ0siOjE2LCJpbk11c3RhY2hlIjoxNywiQ0xPU0UiOjE4LCJPUEVOX0lOVkVSU0UiOjE5LCJPUEVOX0VOREJMT0NLIjoyMCwicGF0aCI6MjEsIk9QRU4iOjIyLCJPUEVOX1VORVNDQVBFRCI6MjMsIk9QRU5fUEFSVElBTCI6MjQsInBhcmFtcyI6MjUsImhhc2giOjI2LCJEQVRBIjoyNywicGFyYW0iOjI4LCJTVFJJTkciOjI5LCJJTlRFR0VSIjozMCwiQk9PTEVBTiI6MzEsImhhc2hTZWdtZW50cyI6MzIsImhhc2hTZWdtZW50IjozMywiSUQiOjM0LCJFUVVBTFMiOjM1LCJwYXRoU2VnbWVudHMiOjM2LCJTRVAiOjM3LCIkYWNjZXB0IjowLCIkZW5kIjoxfSwKdGVybWluYWxzXzogezI6ImVycm9yIiw1OiJFT0YiLDE0OiJDT05URU5UIiwxNToiQ09NTUVOVCIsMTY6Ik9QRU5fQkxPQ0siLDE4OiJDTE9TRSIsMTk6Ik9QRU5fSU5WRVJTRSIsMjA6Ik9QRU5fRU5EQkxPQ0siLDIyOiJPUEVOIiwyMzoiT1BFTl9VTkVTQ0FQRUQiLDI0OiJPUEVOX1BBUlRJQUwiLDI3OiJEQVRBIiwyOToiU1RSSU5HIiwzMDoiSU5URUdFUiIsMzE6IkJPT0xFQU4iLDM0OiJJRCIsMzU6IkVRVUFMUyIsMzc6IlNFUCJ9LApwcm9kdWN0aW9uc186IFswLFszLDJdLFs0LDNdLFs0LDFdLFs0LDBdLFs2LDFdLFs2LDJdLFs4LDNdLFs4LDNdLFs4LDFdLFs4LDFdLFs4LDFdLFs4LDFdLFsxMSwzXSxbOSwzXSxbMTAsM10sWzEyLDNdLFsxMiwzXSxbMTMsM10sWzEzLDRdLFs3LDJdLFsxNywzXSxbMTcsMl0sWzE3LDJdLFsxNywxXSxbMTcsMV0sWzI1LDJdLFsyNSwxXSxbMjgsMV0sWzI4LDFdLFsyOCwxXSxbMjgsMV0sWzI4LDFdLFsyNiwxXSxbMzIsMl0sWzMyLDFdLFszMywzXSxbMzMsM10sWzMzLDNdLFszMywzXSxbMzMsM10sWzIxLDFdLFszNiwzXSxbMzYsMV1dLApwZXJmb3JtQWN0aW9uOiBmdW5jdGlvbiBhbm9ueW1vdXMoeXl0ZXh0LHl5bGVuZyx5eWxpbmVubyx5eSx5eXN0YXRlLCQkLF8kKSB7Cgp2YXIgJDAgPSAkJC5sZW5ndGggLSAxOwpzd2l0Y2ggKHl5c3RhdGUpIHsKY2FzZSAxOiByZXR1cm4gJCRbJDAtMV07IApicmVhazsKY2FzZSAyOiB0aGlzLiQgPSBuZXcgeXkuUHJvZ3JhbU5vZGUoJCRbJDAtMl0sICQkWyQwXSk7IApicmVhazsKY2FzZSAzOiB0aGlzLiQgPSBuZXcgeXkuUHJvZ3JhbU5vZGUoJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDQ6IHRoaXMuJCA9IG5ldyB5eS5Qcm9ncmFtTm9kZShbXSk7IApicmVhazsKY2FzZSA1OiB0aGlzLiQgPSBbJCRbJDBdXTsgCmJyZWFrOwpjYXNlIDY6ICQkWyQwLTFdLnB1c2goJCRbJDBdKTsgdGhpcy4kID0gJCRbJDAtMV07IApicmVhazsKY2FzZSA3OiB0aGlzLiQgPSBuZXcgeXkuQmxvY2tOb2RlKCQkWyQwLTJdLCAkJFskMC0xXS5pbnZlcnNlLCAkJFskMC0xXSwgJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDg6IHRoaXMuJCA9IG5ldyB5eS5CbG9ja05vZGUoJCRbJDAtMl0sICQkWyQwLTFdLCAkJFskMC0xXS5pbnZlcnNlLCAkJFskMF0pOyAKYnJlYWs7CmNhc2UgOTogdGhpcy4kID0gJCRbJDBdOyAKYnJlYWs7CmNhc2UgMTA6IHRoaXMuJCA9ICQkWyQwXTsgCmJyZWFrOwpjYXNlIDExOiB0aGlzLiQgPSBuZXcgeXkuQ29udGVudE5vZGUoJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDEyOiB0aGlzLiQgPSBuZXcgeXkuQ29tbWVudE5vZGUoJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDEzOiB0aGlzLiQgPSBuZXcgeXkuTXVzdGFjaGVOb2RlKCQkWyQwLTFdWzBdLCAkJFskMC0xXVsxXSk7IApicmVhazsKY2FzZSAxNDogdGhpcy4kID0gbmV3IHl5Lk11c3RhY2hlTm9kZSgkJFskMC0xXVswXSwgJCRbJDAtMV1bMV0pOyAKYnJlYWs7CmNhc2UgMTU6IHRoaXMuJCA9ICQkWyQwLTFdOyAKYnJlYWs7CmNhc2UgMTY6IHRoaXMuJCA9IG5ldyB5eS5NdXN0YWNoZU5vZGUoJCRbJDAtMV1bMF0sICQkWyQwLTFdWzFdKTsgCmJyZWFrOwpjYXNlIDE3OiB0aGlzLiQgPSBuZXcgeXkuTXVzdGFjaGVOb2RlKCQkWyQwLTFdWzBdLCAkJFskMC0xXVsxXSwgdHJ1ZSk7IApicmVhazsKY2FzZSAxODogdGhpcy4kID0gbmV3IHl5LlBhcnRpYWxOb2RlKCQkWyQwLTFdKTsgCmJyZWFrOwpjYXNlIDE5OiB0aGlzLiQgPSBuZXcgeXkuUGFydGlhbE5vZGUoJCRbJDAtMl0sICQkWyQwLTFdKTsgCmJyZWFrOwpjYXNlIDIwOiAKYnJlYWs7CmNhc2UgMjE6IHRoaXMuJCA9IFtbJCRbJDAtMl1dLmNvbmNhdCgkJFskMC0xXSksICQkWyQwXV07IApicmVhazsKY2FzZSAyMjogdGhpcy4kID0gW1skJFskMC0xXV0uY29uY2F0KCQkWyQwXSksIG51bGxdOyAKYnJlYWs7CmNhc2UgMjM6IHRoaXMuJCA9IFtbJCRbJDAtMV1dLCAkJFskMF1dOyAKYnJlYWs7CmNhc2UgMjQ6IHRoaXMuJCA9IFtbJCRbJDBdXSwgbnVsbF07IApicmVhazsKY2FzZSAyNTogdGhpcy4kID0gW1tuZXcgeXkuRGF0YU5vZGUoJCRbJDBdKV0sIG51bGxdOyAKYnJlYWs7CmNhc2UgMjY6ICQkWyQwLTFdLnB1c2goJCRbJDBdKTsgdGhpcy4kID0gJCRbJDAtMV07IApicmVhazsKY2FzZSAyNzogdGhpcy4kID0gWyQkWyQwXV07IApicmVhazsKY2FzZSAyODogdGhpcy4kID0gJCRbJDBdOyAKYnJlYWs7CmNhc2UgMjk6IHRoaXMuJCA9IG5ldyB5eS5TdHJpbmdOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMDogdGhpcy4kID0gbmV3IHl5LkludGVnZXJOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMTogdGhpcy4kID0gbmV3IHl5LkJvb2xlYW5Ob2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMjogdGhpcy4kID0gbmV3IHl5LkRhdGFOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMzogdGhpcy4kID0gbmV3IHl5Lkhhc2hOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzNDogJCRbJDAtMV0ucHVzaCgkJFskMF0pOyB0aGlzLiQgPSAkJFskMC0xXTsgCmJyZWFrOwpjYXNlIDM1OiB0aGlzLiQgPSBbJCRbJDBdXTsgCmJyZWFrOwpjYXNlIDM2OiB0aGlzLiQgPSBbJCRbJDAtMl0sICQkWyQwXV07IApicmVhazsKY2FzZSAzNzogdGhpcy4kID0gWyQkWyQwLTJdLCBuZXcgeXkuU3RyaW5nTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDM4OiB0aGlzLiQgPSBbJCRbJDAtMl0sIG5ldyB5eS5JbnRlZ2VyTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDM5OiB0aGlzLiQgPSBbJCRbJDAtMl0sIG5ldyB5eS5Cb29sZWFuTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDQwOiB0aGlzLiQgPSBbJCRbJDAtMl0sIG5ldyB5eS5EYXRhTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDQxOiB0aGlzLiQgPSBuZXcgeXkuSWROb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSA0MjogJCRbJDAtMl0ucHVzaCgkJFskMF0pOyB0aGlzLiQgPSAkJFskMC0yXTsgCmJyZWFrOwpjYXNlIDQzOiB0aGlzLiQgPSBbJCRbJDBdXTsgCmJyZWFrOwp9Cn0sCnRhYmxlOiBbezM6MSw0OjIsNTpbMiw0XSw2OjMsODo0LDk6NSwxMTo2LDEyOjcsMTM6OCwxNDpbMSw5XSwxNTpbMSwxMF0sMTY6WzEsMTJdLDE5OlsxLDExXSwyMjpbMSwxM10sMjM6WzEsMTRdLDI0OlsxLDE1XX0sezE6WzNdfSx7NTpbMSwxNl19LHs1OlsyLDNdLDc6MTcsODoxOCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxOV0sMjA6WzIsM10sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNDpbMSwxNV19LHs1OlsyLDVdLDE0OlsyLDVdLDE1OlsyLDVdLDE2OlsyLDVdLDE5OlsyLDVdLDIwOlsyLDVdLDIyOlsyLDVdLDIzOlsyLDVdLDI0OlsyLDVdfSx7NDoyMCw2OjMsODo0LDk6NSwxMTo2LDEyOjcsMTM6OCwxNDpbMSw5XSwxNTpbMSwxMF0sMTY6WzEsMTJdLDE5OlsxLDExXSwyMDpbMiw0XSwyMjpbMSwxM10sMjM6WzEsMTRdLDI0OlsxLDE1XX0sezQ6MjEsNjozLDg6NCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxMV0sMjA6WzIsNF0sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNDpbMSwxNV19LHs1OlsyLDldLDE0OlsyLDldLDE1OlsyLDldLDE2OlsyLDldLDE5OlsyLDldLDIwOlsyLDldLDIyOlsyLDldLDIzOlsyLDldLDI0OlsyLDldfSx7NTpbMiwxMF0sMTQ6WzIsMTBdLDE1OlsyLDEwXSwxNjpbMiwxMF0sMTk6WzIsMTBdLDIwOlsyLDEwXSwyMjpbMiwxMF0sMjM6WzIsMTBdLDI0OlsyLDEwXX0sezU6WzIsMTFdLDE0OlsyLDExXSwxNTpbMiwxMV0sMTY6WzIsMTFdLDE5OlsyLDExXSwyMDpbMiwxMV0sMjI6WzIsMTFdLDIzOlsyLDExXSwyNDpbMiwxMV19LHs1OlsyLDEyXSwxNDpbMiwxMl0sMTU6WzIsMTJdLDE2OlsyLDEyXSwxOTpbMiwxMl0sMjA6WzIsMTJdLDIyOlsyLDEyXSwyMzpbMiwxMl0sMjQ6WzIsMTJdfSx7MTc6MjIsMjE6MjMsMjc6WzEsMjRdLDM0OlsxLDI2XSwzNjoyNX0sezE3OjI3LDIxOjIzLDI3OlsxLDI0XSwzNDpbMSwyNl0sMzY6MjV9LHsxNzoyOCwyMToyMywyNzpbMSwyNF0sMzQ6WzEsMjZdLDM2OjI1fSx7MTc6MjksMjE6MjMsMjc6WzEsMjRdLDM0OlsxLDI2XSwzNjoyNX0sezIxOjMwLDM0OlsxLDI2XSwzNjoyNX0sezE6WzIsMV19LHs2OjMxLDg6NCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxMV0sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNDpbMSwxNV19LHs1OlsyLDZdLDE0OlsyLDZdLDE1OlsyLDZdLDE2OlsyLDZdLDE5OlsyLDZdLDIwOlsyLDZdLDIyOlsyLDZdLDIzOlsyLDZdLDI0OlsyLDZdfSx7MTc6MjIsMTg6WzEsMzJdLDIxOjIzLDI3OlsxLDI0XSwzNDpbMSwyNl0sMzY6MjV9LHsxMDozMywyMDpbMSwzNF19LHsxMDozNSwyMDpbMSwzNF19LHsxODpbMSwzNl19LHsxODpbMiwyNF0sMjE6NDEsMjU6MzcsMjY6MzgsMjc6WzEsNDVdLDI4OjM5LDI5OlsxLDQyXSwzMDpbMSw0M10sMzE6WzEsNDRdLDMyOjQwLDMzOjQ2LDM0OlsxLDQ3XSwzNjoyNX0sezE4OlsyLDI1XX0sezE4OlsyLDQxXSwyNzpbMiw0MV0sMjk6WzIsNDFdLDMwOlsyLDQxXSwzMTpbMiw0MV0sMzQ6WzIsNDFdLDM3OlsxLDQ4XX0sezE4OlsyLDQzXSwyNzpbMiw0M10sMjk6WzIsNDNdLDMwOlsyLDQzXSwzMTpbMiw0M10sMzQ6WzIsNDNdLDM3OlsyLDQzXX0sezE4OlsxLDQ5XX0sezE4OlsxLDUwXX0sezE4OlsxLDUxXX0sezE4OlsxLDUyXSwyMTo1MywzNDpbMSwyNl0sMzY6MjV9LHs1OlsyLDJdLDg6MTgsOTo1LDExOjYsMTI6NywxMzo4LDE0OlsxLDldLDE1OlsxLDEwXSwxNjpbMSwxMl0sMTk6WzEsMTFdLDIwOlsyLDJdLDIyOlsxLDEzXSwyMzpbMSwxNF0sMjQ6WzEsMTVdfSx7MTQ6WzIsMjBdLDE1OlsyLDIwXSwxNjpbMiwyMF0sMTk6WzIsMjBdLDIyOlsyLDIwXSwyMzpbMiwyMF0sMjQ6WzIsMjBdfSx7NTpbMiw3XSwxNDpbMiw3XSwxNTpbMiw3XSwxNjpbMiw3XSwxOTpbMiw3XSwyMDpbMiw3XSwyMjpbMiw3XSwyMzpbMiw3XSwyNDpbMiw3XX0sezIxOjU0LDM0OlsxLDI2XSwzNjoyNX0sezU6WzIsOF0sMTQ6WzIsOF0sMTU6WzIsOF0sMTY6WzIsOF0sMTk6WzIsOF0sMjA6WzIsOF0sMjI6WzIsOF0sMjM6WzIsOF0sMjQ6WzIsOF19LHsxNDpbMiwxNF0sMTU6WzIsMTRdLDE2OlsyLDE0XSwxOTpbMiwxNF0sMjA6WzIsMTRdLDIyOlsyLDE0XSwyMzpbMiwxNF0sMjQ6WzIsMTRdfSx7MTg6WzIsMjJdLDIxOjQxLDI2OjU1LDI3OlsxLDQ1XSwyODo1NiwyOTpbMSw0Ml0sMzA6WzEsNDNdLDMxOlsxLDQ0XSwzMjo0MCwzMzo0NiwzNDpbMSw0N10sMzY6MjV9LHsxODpbMiwyM119LHsxODpbMiwyN10sMjc6WzIsMjddLDI5OlsyLDI3XSwzMDpbMiwyN10sMzE6WzIsMjddLDM0OlsyLDI3XX0sezE4OlsyLDMzXSwzMzo1NywzNDpbMSw1OF19LHsxODpbMiwyOF0sMjc6WzIsMjhdLDI5OlsyLDI4XSwzMDpbMiwyOF0sMzE6WzIsMjhdLDM0OlsyLDI4XX0sezE4OlsyLDI5XSwyNzpbMiwyOV0sMjk6WzIsMjldLDMwOlsyLDI5XSwzMTpbMiwyOV0sMzQ6WzIsMjldfSx7MTg6WzIsMzBdLDI3OlsyLDMwXSwyOTpbMiwzMF0sMzA6WzIsMzBdLDMxOlsyLDMwXSwzNDpbMiwzMF19LHsxODpbMiwzMV0sMjc6WzIsMzFdLDI5OlsyLDMxXSwzMDpbMiwzMV0sMzE6WzIsMzFdLDM0OlsyLDMxXX0sezE4OlsyLDMyXSwyNzpbMiwzMl0sMjk6WzIsMzJdLDMwOlsyLDMyXSwzMTpbMiwzMl0sMzQ6WzIsMzJdfSx7MTg6WzIsMzVdLDM0OlsyLDM1XX0sezE4OlsyLDQzXSwyNzpbMiw0M10sMjk6WzIsNDNdLDMwOlsyLDQzXSwzMTpbMiw0M10sMzQ6WzIsNDNdLDM1OlsxLDU5XSwzNzpbMiw0M119LHszNDpbMSw2MF19LHsxNDpbMiwxM10sMTU6WzIsMTNdLDE2OlsyLDEzXSwxOTpbMiwxM10sMjA6WzIsMTNdLDIyOlsyLDEzXSwyMzpbMiwxM10sMjQ6WzIsMTNdfSx7NTpbMiwxNl0sMTQ6WzIsMTZdLDE1OlsyLDE2XSwxNjpbMiwxNl0sMTk6WzIsMTZdLDIwOlsyLDE2XSwyMjpbMiwxNl0sMjM6WzIsMTZdLDI0OlsyLDE2XX0sezU6WzIsMTddLDE0OlsyLDE3XSwxNTpbMiwxN10sMTY6WzIsMTddLDE5OlsyLDE3XSwyMDpbMiwxN10sMjI6WzIsMTddLDIzOlsyLDE3XSwyNDpbMiwxN119LHs1OlsyLDE4XSwxNDpbMiwxOF0sMTU6WzIsMThdLDE2OlsyLDE4XSwxOTpbMiwxOF0sMjA6WzIsMThdLDIyOlsyLDE4XSwyMzpbMiwxOF0sMjQ6WzIsMThdfSx7MTg6WzEsNjFdfSx7MTg6WzEsNjJdfSx7MTg6WzIsMjFdfSx7MTg6WzIsMjZdLDI3OlsyLDI2XSwyOTpbMiwyNl0sMzA6WzIsMjZdLDMxOlsyLDI2XSwzNDpbMiwyNl19LHsxODpbMiwzNF0sMzQ6WzIsMzRdfSx7MzU6WzEsNTldfSx7MjE6NjMsMjc6WzEsNjddLDI5OlsxLDY0XSwzMDpbMSw2NV0sMzE6WzEsNjZdLDM0OlsxLDI2XSwzNjoyNX0sezE4OlsyLDQyXSwyNzpbMiw0Ml0sMjk6WzIsNDJdLDMwOlsyLDQyXSwzMTpbMiw0Ml0sMzQ6WzIsNDJdLDM3OlsyLDQyXX0sezU6WzIsMTldLDE0OlsyLDE5XSwxNTpbMiwxOV0sMTY6WzIsMTldLDE5OlsyLDE5XSwyMDpbMiwxOV0sMjI6WzIsMTldLDIzOlsyLDE5XSwyNDpbMiwxOV19LHs1OlsyLDE1XSwxNDpbMiwxNV0sMTU6WzIsMTVdLDE2OlsyLDE1XSwxOTpbMiwxNV0sMjA6WzIsMTVdLDIyOlsyLDE1XSwyMzpbMiwxNV0sMjQ6WzIsMTVdfSx7MTg6WzIsMzZdLDM0OlsyLDM2XX0sezE4OlsyLDM3XSwzNDpbMiwzN119LHsxODpbMiwzOF0sMzQ6WzIsMzhdfSx7MTg6WzIsMzldLDM0OlsyLDM5XX0sezE4OlsyLDQwXSwzNDpbMiw0MF19XSwKZGVmYXVsdEFjdGlvbnM6IHsxNjpbMiwxXSwyNDpbMiwyNV0sMzg6WzIsMjNdLDU1OlsyLDIxXX0sCnBhcnNlRXJyb3I6IGZ1bmN0aW9uIHBhcnNlRXJyb3Ioc3RyLCBoYXNoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3Ioc3RyKTsKfSwKcGFyc2U6IGZ1bmN0aW9uIHBhcnNlKGlucHV0KSB7CiAgICB2YXIgc2VsZiA9IHRoaXMsIHN0YWNrID0gWzBdLCB2c3RhY2sgPSBbbnVsbF0sIGxzdGFjayA9IFtdLCB0YWJsZSA9IHRoaXMudGFibGUsIHl5dGV4dCA9ICIiLCB5eWxpbmVubyA9IDAsIHl5bGVuZyA9IDAsIHJlY292ZXJpbmcgPSAwLCBURVJST1IgPSAyLCBFT0YgPSAxOwogICAgdGhpcy5sZXhlci5zZXRJbnB1dChpbnB1dCk7CiAgICB0aGlzLmxleGVyLnl5ID0gdGhpcy55eTsKICAgIHRoaXMueXkubGV4ZXIgPSB0aGlzLmxleGVyOwogICAgdGhpcy55eS5wYXJzZXIgPSB0aGlzOwogICAgaWYgKHR5cGVvZiB0aGlzLmxleGVyLnl5bGxvYyA9PSAidW5kZWZpbmVkIikKICAgICAgICB0aGlzLmxleGVyLnl5bGxvYyA9IHt9OwogICAgdmFyIHl5bG9jID0gdGhpcy5sZXhlci55eWxsb2M7CiAgICBsc3RhY2sucHVzaCh5eWxvYyk7CiAgICB2YXIgcmFuZ2VzID0gdGhpcy5sZXhlci5vcHRpb25zICYmIHRoaXMubGV4ZXIub3B0aW9ucy5yYW5nZXM7CiAgICBpZiAodHlwZW9mIHRoaXMueXkucGFyc2VFcnJvciA9PT0gImZ1bmN0aW9uIikKICAgICAgICB0aGlzLnBhcnNlRXJyb3IgPSB0aGlzLnl5LnBhcnNlRXJyb3I7CiAgICBmdW5jdGlvbiBwb3BTdGFjayhuKSB7CiAgICAgICAgc3RhY2subGVuZ3RoID0gc3RhY2subGVuZ3RoIC0gMiAqIG47CiAgICAgICAgdnN0YWNrLmxlbmd0aCA9IHZzdGFjay5sZW5ndGggLSBuOwogICAgICAgIGxzdGFjay5sZW5ndGggPSBsc3RhY2subGVuZ3RoIC0gbjsKICAgIH0KICAgIGZ1bmN0aW9uIGxleCgpIHsKICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgdG9rZW4gPSBzZWxmLmxleGVyLmxleCgpIHx8IDE7CiAgICAgICAgaWYgKHR5cGVvZiB0b2tlbiAhPT0gIm51bWJlciIpIHsKICAgICAgICAgICAgdG9rZW4gPSBzZWxmLnN5bWJvbHNfW3Rva2VuXSB8fCB0b2tlbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRva2VuOwogICAgfQogICAgdmFyIHN5bWJvbCwgcHJlRXJyb3JTeW1ib2wsIHN0YXRlLCBhY3Rpb24sIGEsIHIsIHl5dmFsID0ge30sIHAsIGxlbiwgbmV3U3RhdGUsIGV4cGVjdGVkOwogICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBzdGF0ZSA9IHN0YWNrW3N0YWNrLmxlbmd0aCAtIDFdOwogICAgICAgIGlmICh0aGlzLmRlZmF1bHRBY3Rpb25zW3N0YXRlXSkgewogICAgICAgICAgICBhY3Rpb24gPSB0aGlzLmRlZmF1bHRBY3Rpb25zW3N0YXRlXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoc3ltYm9sID09PSBudWxsIHx8IHR5cGVvZiBzeW1ib2wgPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIHN5bWJvbCA9IGxleCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFjdGlvbiA9IHRhYmxlW3N0YXRlXSAmJiB0YWJsZVtzdGF0ZV1bc3ltYm9sXTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBhY3Rpb24gPT09ICJ1bmRlZmluZWQiIHx8ICFhY3Rpb24ubGVuZ3RoIHx8ICFhY3Rpb25bMF0pIHsKICAgICAgICAgICAgdmFyIGVyclN0ciA9ICIiOwogICAgICAgICAgICBpZiAoIXJlY292ZXJpbmcpIHsKICAgICAgICAgICAgICAgIGV4cGVjdGVkID0gW107CiAgICAgICAgICAgICAgICBmb3IgKHAgaW4gdGFibGVbc3RhdGVdKQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlcm1pbmFsc19bcF0gJiYgcCA+IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXhwZWN0ZWQucHVzaCgiJyIgKyB0aGlzLnRlcm1pbmFsc19bcF0gKyAiJyIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0aGlzLmxleGVyLnNob3dQb3NpdGlvbikgewogICAgICAgICAgICAgICAgICAgIGVyclN0ciA9ICJQYXJzZSBlcnJvciBvbiBsaW5lICIgKyAoeXlsaW5lbm8gKyAxKSArICI6XG4iICsgdGhpcy5sZXhlci5zaG93UG9zaXRpb24oKSArICJcbkV4cGVjdGluZyAiICsgZXhwZWN0ZWQuam9pbigiLCAiKSArICIsIGdvdCAnIiArICh0aGlzLnRlcm1pbmFsc19bc3ltYm9sXSB8fCBzeW1ib2wpICsgIiciOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlcnJTdHIgPSAiUGFyc2UgZXJyb3Igb24gbGluZSAiICsgKHl5bGluZW5vICsgMSkgKyAiOiBVbmV4cGVjdGVkICIgKyAoc3ltYm9sID09IDE/ImVuZCBvZiBpbnB1dCI6IiciICsgKHRoaXMudGVybWluYWxzX1tzeW1ib2xdIHx8IHN5bWJvbCkgKyAiJyIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5wYXJzZUVycm9yKGVyclN0ciwge3RleHQ6IHRoaXMubGV4ZXIubWF0Y2gsIHRva2VuOiB0aGlzLnRlcm1pbmFsc19bc3ltYm9sXSB8fCBzeW1ib2wsIGxpbmU6IHRoaXMubGV4ZXIueXlsaW5lbm8sIGxvYzogeXlsb2MsIGV4cGVjdGVkOiBleHBlY3RlZH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChhY3Rpb25bMF0gaW5zdGFuY2VvZiBBcnJheSAmJiBhY3Rpb24ubGVuZ3RoID4gMSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlBhcnNlIEVycm9yOiBtdWx0aXBsZSBhY3Rpb25zIHBvc3NpYmxlIGF0IHN0YXRlOiAiICsgc3RhdGUgKyAiLCB0b2tlbjogIiArIHN5bWJvbCk7CiAgICAgICAgfQogICAgICAgIHN3aXRjaCAoYWN0aW9uWzBdKSB7CiAgICAgICAgY2FzZSAxOgogICAgICAgICAgICBzdGFjay5wdXNoKHN5bWJvbCk7CiAgICAgICAgICAgIHZzdGFjay5wdXNoKHRoaXMubGV4ZXIueXl0ZXh0KTsKICAgICAgICAgICAgbHN0YWNrLnB1c2godGhpcy5sZXhlci55eWxsb2MpOwogICAgICAgICAgICBzdGFjay5wdXNoKGFjdGlvblsxXSk7CiAgICAgICAgICAgIHN5bWJvbCA9IG51bGw7CiAgICAgICAgICAgIGlmICghcHJlRXJyb3JTeW1ib2wpIHsKICAgICAgICAgICAgICAgIHl5bGVuZyA9IHRoaXMubGV4ZXIueXlsZW5nOwogICAgICAgICAgICAgICAgeXl0ZXh0ID0gdGhpcy5sZXhlci55eXRleHQ7CiAgICAgICAgICAgICAgICB5eWxpbmVubyA9IHRoaXMubGV4ZXIueXlsaW5lbm87CiAgICAgICAgICAgICAgICB5eWxvYyA9IHRoaXMubGV4ZXIueXlsbG9jOwogICAgICAgICAgICAgICAgaWYgKHJlY292ZXJpbmcgPiAwKQogICAgICAgICAgICAgICAgICAgIHJlY292ZXJpbmctLTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN5bWJvbCA9IHByZUVycm9yU3ltYm9sOwogICAgICAgICAgICAgICAgcHJlRXJyb3JTeW1ib2wgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgbGVuID0gdGhpcy5wcm9kdWN0aW9uc19bYWN0aW9uWzFdXVsxXTsKICAgICAgICAgICAgeXl2YWwuJCA9IHZzdGFja1t2c3RhY2subGVuZ3RoIC0gbGVuXTsKICAgICAgICAgICAgeXl2YWwuXyQgPSB7Zmlyc3RfbGluZTogbHN0YWNrW2xzdGFjay5sZW5ndGggLSAobGVuIHx8IDEpXS5maXJzdF9saW5lLCBsYXN0X2xpbmU6IGxzdGFja1tsc3RhY2subGVuZ3RoIC0gMV0ubGFzdF9saW5lLCBmaXJzdF9jb2x1bW46IGxzdGFja1tsc3RhY2subGVuZ3RoIC0gKGxlbiB8fCAxKV0uZmlyc3RfY29sdW1uLCBsYXN0X2NvbHVtbjogbHN0YWNrW2xzdGFjay5sZW5ndGggLSAxXS5sYXN0X2NvbHVtbn07CiAgICAgICAgICAgIGlmIChyYW5nZXMpIHsKICAgICAgICAgICAgICAgIHl5dmFsLl8kLnJhbmdlID0gW2xzdGFja1tsc3RhY2subGVuZ3RoIC0gKGxlbiB8fCAxKV0ucmFuZ2VbMF0sIGxzdGFja1tsc3RhY2subGVuZ3RoIC0gMV0ucmFuZ2VbMV1dOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHIgPSB0aGlzLnBlcmZvcm1BY3Rpb24uY2FsbCh5eXZhbCwgeXl0ZXh0LCB5eWxlbmcsIHl5bGluZW5vLCB0aGlzLnl5LCBhY3Rpb25bMV0sIHZzdGFjaywgbHN0YWNrKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiByICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxlbikgewogICAgICAgICAgICAgICAgc3RhY2sgPSBzdGFjay5zbGljZSgwLCAtMSAqIGxlbiAqIDIpOwogICAgICAgICAgICAgICAgdnN0YWNrID0gdnN0YWNrLnNsaWNlKDAsIC0xICogbGVuKTsKICAgICAgICAgICAgICAgIGxzdGFjayA9IGxzdGFjay5zbGljZSgwLCAtMSAqIGxlbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3RhY2sucHVzaCh0aGlzLnByb2R1Y3Rpb25zX1thY3Rpb25bMV1dWzBdKTsKICAgICAgICAgICAgdnN0YWNrLnB1c2goeXl2YWwuJCk7CiAgICAgICAgICAgIGxzdGFjay5wdXNoKHl5dmFsLl8kKTsKICAgICAgICAgICAgbmV3U3RhdGUgPSB0YWJsZVtzdGFja1tzdGFjay5sZW5ndGggLSAyXV1bc3RhY2tbc3RhY2subGVuZ3RoIC0gMV1dOwogICAgICAgICAgICBzdGFjay5wdXNoKG5ld1N0YXRlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAzOgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKfQp9OwovKiBKaXNvbiBnZW5lcmF0ZWQgbGV4ZXIgKi8KdmFyIGxleGVyID0gKGZ1bmN0aW9uKCl7CnZhciBsZXhlciA9ICh7RU9GOjEsCnBhcnNlRXJyb3I6ZnVuY3Rpb24gcGFyc2VFcnJvcihzdHIsIGhhc2gpIHsKICAgICAgICBpZiAodGhpcy55eS5wYXJzZXIpIHsKICAgICAgICAgICAgdGhpcy55eS5wYXJzZXIucGFyc2VFcnJvcihzdHIsIGhhc2gpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihzdHIpOwogICAgICAgIH0KICAgIH0sCnNldElucHV0OmZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgIHRoaXMuX2lucHV0ID0gaW5wdXQ7CiAgICAgICAgdGhpcy5fbW9yZSA9IHRoaXMuX2xlc3MgPSB0aGlzLmRvbmUgPSBmYWxzZTsKICAgICAgICB0aGlzLnl5bGluZW5vID0gdGhpcy55eWxlbmcgPSAwOwogICAgICAgIHRoaXMueXl0ZXh0ID0gdGhpcy5tYXRjaGVkID0gdGhpcy5tYXRjaCA9ICcnOwogICAgICAgIHRoaXMuY29uZGl0aW9uU3RhY2sgPSBbJ0lOSVRJQUwnXTsKICAgICAgICB0aGlzLnl5bGxvYyA9IHtmaXJzdF9saW5lOjEsZmlyc3RfY29sdW1uOjAsbGFzdF9saW5lOjEsbGFzdF9jb2x1bW46MH07CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5yYW5nZXMpIHRoaXMueXlsbG9jLnJhbmdlID0gWzAsMF07CiAgICAgICAgdGhpcy5vZmZzZXQgPSAwOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKaW5wdXQ6ZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBjaCA9IHRoaXMuX2lucHV0WzBdOwogICAgICAgIHRoaXMueXl0ZXh0ICs9IGNoOwogICAgICAgIHRoaXMueXlsZW5nKys7CiAgICAgICAgdGhpcy5vZmZzZXQrKzsKICAgICAgICB0aGlzLm1hdGNoICs9IGNoOwogICAgICAgIHRoaXMubWF0Y2hlZCArPSBjaDsKICAgICAgICB2YXIgbGluZXMgPSBjaC5tYXRjaCgvKD86XHJcbj98XG4pLiovZyk7CiAgICAgICAgaWYgKGxpbmVzKSB7CiAgICAgICAgICAgIHRoaXMueXlsaW5lbm8rKzsKICAgICAgICAgICAgdGhpcy55eWxsb2MubGFzdF9saW5lKys7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy55eWxsb2MubGFzdF9jb2x1bW4rKzsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5yYW5nZXMpIHRoaXMueXlsbG9jLnJhbmdlWzFdKys7CgogICAgICAgIHRoaXMuX2lucHV0ID0gdGhpcy5faW5wdXQuc2xpY2UoMSk7CiAgICAgICAgcmV0dXJuIGNoOwogICAgfSwKdW5wdXQ6ZnVuY3Rpb24gKGNoKSB7CiAgICAgICAgdmFyIGxlbiA9IGNoLmxlbmd0aDsKICAgICAgICB2YXIgbGluZXMgPSBjaC5zcGxpdCgvKD86XHJcbj98XG4pL2cpOwoKICAgICAgICB0aGlzLl9pbnB1dCA9IGNoICsgdGhpcy5faW5wdXQ7CiAgICAgICAgdGhpcy55eXRleHQgPSB0aGlzLnl5dGV4dC5zdWJzdHIoMCwgdGhpcy55eXRleHQubGVuZ3RoLWxlbi0xKTsKICAgICAgICAvL3RoaXMueXlsZW5nIC09IGxlbjsKICAgICAgICB0aGlzLm9mZnNldCAtPSBsZW47CiAgICAgICAgdmFyIG9sZExpbmVzID0gdGhpcy5tYXRjaC5zcGxpdCgvKD86XHJcbj98XG4pL2cpOwogICAgICAgIHRoaXMubWF0Y2ggPSB0aGlzLm1hdGNoLnN1YnN0cigwLCB0aGlzLm1hdGNoLmxlbmd0aC0xKTsKICAgICAgICB0aGlzLm1hdGNoZWQgPSB0aGlzLm1hdGNoZWQuc3Vic3RyKDAsIHRoaXMubWF0Y2hlZC5sZW5ndGgtMSk7CgogICAgICAgIGlmIChsaW5lcy5sZW5ndGgtMSkgdGhpcy55eWxpbmVubyAtPSBsaW5lcy5sZW5ndGgtMTsKICAgICAgICB2YXIgciA9IHRoaXMueXlsbG9jLnJhbmdlOwoKICAgICAgICB0aGlzLnl5bGxvYyA9IHtmaXJzdF9saW5lOiB0aGlzLnl5bGxvYy5maXJzdF9saW5lLAogICAgICAgICAgbGFzdF9saW5lOiB0aGlzLnl5bGluZW5vKzEsCiAgICAgICAgICBmaXJzdF9jb2x1bW46IHRoaXMueXlsbG9jLmZpcnN0X2NvbHVtbiwKICAgICAgICAgIGxhc3RfY29sdW1uOiBsaW5lcyA/CiAgICAgICAgICAgICAgKGxpbmVzLmxlbmd0aCA9PT0gb2xkTGluZXMubGVuZ3RoID8gdGhpcy55eWxsb2MuZmlyc3RfY29sdW1uIDogMCkgKyBvbGRMaW5lc1tvbGRMaW5lcy5sZW5ndGggLSBsaW5lcy5sZW5ndGhdLmxlbmd0aCAtIGxpbmVzWzBdLmxlbmd0aDoKICAgICAgICAgICAgICB0aGlzLnl5bGxvYy5maXJzdF9jb2x1bW4gLSBsZW4KICAgICAgICAgIH07CgogICAgICAgIGlmICh0aGlzLm9wdGlvbnMucmFuZ2VzKSB7CiAgICAgICAgICAgIHRoaXMueXlsbG9jLnJhbmdlID0gW3JbMF0sIHJbMF0gKyB0aGlzLnl5bGVuZyAtIGxlbl07CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKbW9yZTpmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5fbW9yZSA9IHRydWU7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LApsZXNzOmZ1bmN0aW9uIChuKSB7CiAgICAgICAgdGhpcy51bnB1dCh0aGlzLm1hdGNoLnNsaWNlKG4pKTsKICAgIH0sCnBhc3RJbnB1dDpmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHBhc3QgPSB0aGlzLm1hdGNoZWQuc3Vic3RyKDAsIHRoaXMubWF0Y2hlZC5sZW5ndGggLSB0aGlzLm1hdGNoLmxlbmd0aCk7CiAgICAgICAgcmV0dXJuIChwYXN0Lmxlbmd0aCA+IDIwID8gJy4uLic6JycpICsgcGFzdC5zdWJzdHIoLTIwKS5yZXBsYWNlKC9cbi9nLCAiIik7CiAgICB9LAp1cGNvbWluZ0lucHV0OmZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbmV4dCA9IHRoaXMubWF0Y2g7CiAgICAgICAgaWYgKG5leHQubGVuZ3RoIDwgMjApIHsKICAgICAgICAgICAgbmV4dCArPSB0aGlzLl9pbnB1dC5zdWJzdHIoMCwgMjAtbmV4dC5sZW5ndGgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gKG5leHQuc3Vic3RyKDAsMjApKyhuZXh0Lmxlbmd0aCA+IDIwID8gJy4uLic6JycpKS5yZXBsYWNlKC9cbi9nLCAiIik7CiAgICB9LApzaG93UG9zaXRpb246ZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBwcmUgPSB0aGlzLnBhc3RJbnB1dCgpOwogICAgICAgIHZhciBjID0gbmV3IEFycmF5KHByZS5sZW5ndGggKyAxKS5qb2luKCItIik7CiAgICAgICAgcmV0dXJuIHByZSArIHRoaXMudXBjb21pbmdJbnB1dCgpICsgIlxuIiArIGMrIl4iOwogICAgfSwKbmV4dDpmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHRoaXMuZG9uZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5FT0Y7CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5faW5wdXQpIHRoaXMuZG9uZSA9IHRydWU7CgogICAgICAgIHZhciB0b2tlbiwKICAgICAgICAgICAgbWF0Y2gsCiAgICAgICAgICAgIHRlbXBNYXRjaCwKICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgIGNvbCwKICAgICAgICAgICAgbGluZXM7CiAgICAgICAgaWYgKCF0aGlzLl9tb3JlKSB7CiAgICAgICAgICAgIHRoaXMueXl0ZXh0ID0gJyc7CiAgICAgICAgICAgIHRoaXMubWF0Y2ggPSAnJzsKICAgICAgICB9CiAgICAgICAgdmFyIHJ1bGVzID0gdGhpcy5fY3VycmVudFJ1bGVzKCk7CiAgICAgICAgZm9yICh2YXIgaT0wO2kgPCBydWxlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB0ZW1wTWF0Y2ggPSB0aGlzLl9pbnB1dC5tYXRjaCh0aGlzLnJ1bGVzW3J1bGVzW2ldXSk7CiAgICAgICAgICAgIGlmICh0ZW1wTWF0Y2ggJiYgKCFtYXRjaCB8fCB0ZW1wTWF0Y2hbMF0ubGVuZ3RoID4gbWF0Y2hbMF0ubGVuZ3RoKSkgewogICAgICAgICAgICAgICAgbWF0Y2ggPSB0ZW1wTWF0Y2g7CiAgICAgICAgICAgICAgICBpbmRleCA9IGk7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5mbGV4KSBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgbGluZXMgPSBtYXRjaFswXS5tYXRjaCgvKD86XHJcbj98XG4pLiovZyk7CiAgICAgICAgICAgIGlmIChsaW5lcykgdGhpcy55eWxpbmVubyArPSBsaW5lcy5sZW5ndGg7CiAgICAgICAgICAgIHRoaXMueXlsbG9jID0ge2ZpcnN0X2xpbmU6IHRoaXMueXlsbG9jLmxhc3RfbGluZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdF9saW5lOiB0aGlzLnl5bGluZW5vKzEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0X2NvbHVtbjogdGhpcy55eWxsb2MubGFzdF9jb2x1bW4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RfY29sdW1uOiBsaW5lcyA/IGxpbmVzW2xpbmVzLmxlbmd0aC0xXS5sZW5ndGgtbGluZXNbbGluZXMubGVuZ3RoLTFdLm1hdGNoKC9ccj9cbj8vKVswXS5sZW5ndGggOiB0aGlzLnl5bGxvYy5sYXN0X2NvbHVtbiArIG1hdGNoWzBdLmxlbmd0aH07CiAgICAgICAgICAgIHRoaXMueXl0ZXh0ICs9IG1hdGNoWzBdOwogICAgICAgICAgICB0aGlzLm1hdGNoICs9IG1hdGNoWzBdOwogICAgICAgICAgICB0aGlzLm1hdGNoZXMgPSBtYXRjaDsKICAgICAgICAgICAgdGhpcy55eWxlbmcgPSB0aGlzLnl5dGV4dC5sZW5ndGg7CiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMucmFuZ2VzKSB7CiAgICAgICAgICAgICAgICB0aGlzLnl5bGxvYy5yYW5nZSA9IFt0aGlzLm9mZnNldCwgdGhpcy5vZmZzZXQgKz0gdGhpcy55eWxlbmddOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX21vcmUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faW5wdXQgPSB0aGlzLl9pbnB1dC5zbGljZShtYXRjaFswXS5sZW5ndGgpOwogICAgICAgICAgICB0aGlzLm1hdGNoZWQgKz0gbWF0Y2hbMF07CiAgICAgICAgICAgIHRva2VuID0gdGhpcy5wZXJmb3JtQWN0aW9uLmNhbGwodGhpcywgdGhpcy55eSwgdGhpcywgcnVsZXNbaW5kZXhdLHRoaXMuY29uZGl0aW9uU3RhY2tbdGhpcy5jb25kaXRpb25TdGFjay5sZW5ndGgtMV0pOwogICAgICAgICAgICBpZiAodGhpcy5kb25lICYmIHRoaXMuX2lucHV0KSB0aGlzLmRvbmUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRva2VuKSByZXR1cm4gdG9rZW47CiAgICAgICAgICAgIGVsc2UgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5faW5wdXQgPT09ICIiKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLkVPRjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJzZUVycm9yKCdMZXhpY2FsIGVycm9yIG9uIGxpbmUgJysodGhpcy55eWxpbmVubysxKSsnLiBVbnJlY29nbml6ZWQgdGV4dC5cbicrdGhpcy5zaG93UG9zaXRpb24oKSwKICAgICAgICAgICAgICAgICAgICB7dGV4dDogIiIsIHRva2VuOiBudWxsLCBsaW5lOiB0aGlzLnl5bGluZW5vfSk7CiAgICAgICAgfQogICAgfSwKbGV4OmZ1bmN0aW9uIGxleCgpIHsKICAgICAgICB2YXIgciA9IHRoaXMubmV4dCgpOwogICAgICAgIGlmICh0eXBlb2YgciAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGV4KCk7CiAgICAgICAgfQogICAgfSwKYmVnaW46ZnVuY3Rpb24gYmVnaW4oY29uZGl0aW9uKSB7CiAgICAgICAgdGhpcy5jb25kaXRpb25TdGFjay5wdXNoKGNvbmRpdGlvbik7CiAgICB9LApwb3BTdGF0ZTpmdW5jdGlvbiBwb3BTdGF0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25kaXRpb25TdGFjay5wb3AoKTsKICAgIH0sCl9jdXJyZW50UnVsZXM6ZnVuY3Rpb24gX2N1cnJlbnRSdWxlcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25kaXRpb25zW3RoaXMuY29uZGl0aW9uU3RhY2tbdGhpcy5jb25kaXRpb25TdGFjay5sZW5ndGgtMV1dLnJ1bGVzOwogICAgfSwKdG9wU3RhdGU6ZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmNvbmRpdGlvblN0YWNrW3RoaXMuY29uZGl0aW9uU3RhY2subGVuZ3RoLTJdOwogICAgfSwKcHVzaFN0YXRlOmZ1bmN0aW9uIGJlZ2luKGNvbmRpdGlvbikgewogICAgICAgIHRoaXMuYmVnaW4oY29uZGl0aW9uKTsKICAgIH19KTsKbGV4ZXIub3B0aW9ucyA9IHt9OwpsZXhlci5wZXJmb3JtQWN0aW9uID0gZnVuY3Rpb24gYW5vbnltb3VzKHl5LHl5XywkYXZvaWRpbmdfbmFtZV9jb2xsaXNpb25zLFlZX1NUQVJUKSB7Cgp2YXIgWVlTVEFURT1ZWV9TVEFSVApzd2l0Y2goJGF2b2lkaW5nX25hbWVfY29sbGlzaW9ucykgewpjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeXlfLnl5dGV4dC5zbGljZSgtMSkgIT09ICJcXCIpIHRoaXMuYmVnaW4oIm11Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeXlfLnl5dGV4dC5zbGljZSgtMSkgPT09ICJcXCIpIHl5Xy55eXRleHQgPSB5eV8ueXl0ZXh0LnN1YnN0cigwLHl5Xy55eWxlbmctMSksIHRoaXMuYmVnaW4oImVtdSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHl5Xy55eXRleHQpIHJldHVybiAxNDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCmJyZWFrOwpjYXNlIDE6IHJldHVybiAxNDsgCmJyZWFrOwpjYXNlIDI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeXlfLnl5dGV4dC5zbGljZSgtMSkgIT09ICJcXCIpIHRoaXMucG9wU3RhdGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih5eV8ueXl0ZXh0LnNsaWNlKC0xKSA9PT0gIlxcIikgeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDAseXlfLnl5bGVuZy0xKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMTQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIApicmVhazsKY2FzZSAzOiByZXR1cm4gMjQ7IApicmVhazsKY2FzZSA0OiByZXR1cm4gMTY7IApicmVhazsKY2FzZSA1OiByZXR1cm4gMjA7IApicmVhazsKY2FzZSA2OiByZXR1cm4gMTk7IApicmVhazsKY2FzZSA3OiByZXR1cm4gMTk7IApicmVhazsKY2FzZSA4OiByZXR1cm4gMjM7IApicmVhazsKY2FzZSA5OiByZXR1cm4gMjM7IApicmVhazsKY2FzZSAxMDogeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDMseXlfLnl5bGVuZy01KTsgdGhpcy5wb3BTdGF0ZSgpOyByZXR1cm4gMTU7IApicmVhazsKY2FzZSAxMTogcmV0dXJuIDIyOyAKYnJlYWs7CmNhc2UgMTI6IHJldHVybiAzNTsgCmJyZWFrOwpjYXNlIDEzOiByZXR1cm4gMzQ7IApicmVhazsKY2FzZSAxNDogcmV0dXJuIDM0OyAKYnJlYWs7CmNhc2UgMTU6IHJldHVybiAzNzsgCmJyZWFrOwpjYXNlIDE2OiAvKmlnbm9yZSB3aGl0ZXNwYWNlKi8gCmJyZWFrOwpjYXNlIDE3OiB0aGlzLnBvcFN0YXRlKCk7IHJldHVybiAxODsgCmJyZWFrOwpjYXNlIDE4OiB0aGlzLnBvcFN0YXRlKCk7IHJldHVybiAxODsgCmJyZWFrOwpjYXNlIDE5OiB5eV8ueXl0ZXh0ID0geXlfLnl5dGV4dC5zdWJzdHIoMSx5eV8ueXlsZW5nLTIpLnJlcGxhY2UoL1xcIi9nLCciJyk7IHJldHVybiAyOTsgCmJyZWFrOwpjYXNlIDIwOiB5eV8ueXl0ZXh0ID0geXlfLnl5dGV4dC5zdWJzdHIoMSx5eV8ueXlsZW5nLTIpLnJlcGxhY2UoL1xcIi9nLCciJyk7IHJldHVybiAyOTsgCmJyZWFrOwpjYXNlIDIxOiB5eV8ueXl0ZXh0ID0geXlfLnl5dGV4dC5zdWJzdHIoMSk7IHJldHVybiAyNzsgCmJyZWFrOwpjYXNlIDIyOiByZXR1cm4gMzE7IApicmVhazsKY2FzZSAyMzogcmV0dXJuIDMxOyAKYnJlYWs7CmNhc2UgMjQ6IHJldHVybiAzMDsgCmJyZWFrOwpjYXNlIDI1OiByZXR1cm4gMzQ7IApicmVhazsKY2FzZSAyNjogeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDEsIHl5Xy55eWxlbmctMik7IHJldHVybiAzNDsgCmJyZWFrOwpjYXNlIDI3OiByZXR1cm4gJ0lOVkFMSUQnOyAKYnJlYWs7CmNhc2UgMjg6IHJldHVybiA1OyAKYnJlYWs7Cn0KfTsKbGV4ZXIucnVsZXMgPSBbL14oPzpbXlx4MDBdKj8oPz0oXHtceykpKS8sL14oPzpbXlx4MDBdKykvLC9eKD86W15ceDAwXXsyLH0/KD89KFx7XHt8JCkpKS8sL14oPzpce1x7PikvLC9eKD86XHtceyMpLywvXig/Olx7XHtcLykvLC9eKD86XHtce1xeKS8sL14oPzpce1x7XHMqZWxzZVxiKS8sL14oPzpce1x7XHspLywvXig/Olx7XHsmKS8sL14oPzpce1x7IVtcc1xTXSo/XH1cfSkvLC9eKD86XHtceykvLC9eKD86PSkvLC9eKD86XC4oPz1bfSBdKSkvLC9eKD86XC5cLikvLC9eKD86W1wvLl0pLywvXig/OlxzKykvLC9eKD86XH1cfVx9KS8sL14oPzpcfVx9KS8sL14oPzoiKFxcWyJdfFteIl0pKiIpLywvXig/OicoXFxbJ118W14nXSkqJykvLC9eKD86QFthLXpBLVpdKykvLC9eKD86dHJ1ZSg/PVt9XHNdKSkvLC9eKD86ZmFsc2UoPz1bfVxzXSkpLywvXig/OlswLTldKyg/PVt9XHNdKSkvLC9eKD86W2EtekEtWjAtOV8kLV0rKD89Wz19XHNcLy5dKSkvLC9eKD86XFtbXlxdXSpcXSkvLC9eKD86LikvLC9eKD86JCkvXTsKbGV4ZXIuY29uZGl0aW9ucyA9IHsibXUiOnsicnVsZXMiOlszLDQsNSw2LDcsOCw5LDEwLDExLDEyLDEzLDE0LDE1LDE2LDE3LDE4LDE5LDIwLDIxLDIyLDIzLDI0LDI1LDI2LDI3LDI4XSwiaW5jbHVzaXZlIjpmYWxzZX0sImVtdSI6eyJydWxlcyI6WzJdLCJpbmNsdXNpdmUiOmZhbHNlfSwiSU5JVElBTCI6eyJydWxlcyI6WzAsMSwyOF0sImluY2x1c2l2ZSI6dHJ1ZX19OwpyZXR1cm4gbGV4ZXI7fSkoKQpwYXJzZXIubGV4ZXIgPSBsZXhlcjsKZnVuY3Rpb24gUGFyc2VyICgpIHsgdGhpcy55eSA9IHt9OyB9UGFyc2VyLnByb3RvdHlwZSA9IHBhcnNlcjtwYXJzZXIuUGFyc2VyID0gUGFyc2VyOwpyZXR1cm4gbmV3IFBhcnNlcjsKfSkoKTsKaWYgKHR5cGVvZiByZXF1aXJlICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKZXhwb3J0cy5wYXJzZXIgPSBoYW5kbGViYXJzOwpleHBvcnRzLlBhcnNlciA9IGhhbmRsZWJhcnMuUGFyc2VyOwpleHBvcnRzLnBhcnNlID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gaGFuZGxlYmFycy5wYXJzZS5hcHBseShoYW5kbGViYXJzLCBhcmd1bWVudHMpOyB9CmV4cG9ydHMubWFpbiA9IGZ1bmN0aW9uIGNvbW1vbmpzTWFpbihhcmdzKSB7CiAgICBpZiAoIWFyZ3NbMV0pCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVc2FnZTogJythcmdzWzBdKycgRklMRScpOwogICAgdmFyIHNvdXJjZSwgY3dkOwogICAgaWYgKHR5cGVvZiBwcm9jZXNzICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIHNvdXJjZSA9IHJlcXVpcmUoJ2ZzJykucmVhZEZpbGVTeW5jKHJlcXVpcmUoJ3BhdGgnKS5yZXNvbHZlKGFyZ3NbMV0pLCAidXRmOCIpOwogICAgfSBlbHNlIHsKICAgICAgICBzb3VyY2UgPSByZXF1aXJlKCJmaWxlIikucGF0aChyZXF1aXJlKCJmaWxlIikuY3dkKCkpLmpvaW4oYXJnc1sxXSkucmVhZCh7Y2hhcnNldDogInV0Zi04In0pOwogICAgfQogICAgcmV0dXJuIGV4cG9ydHMucGFyc2VyLnBhcnNlKHNvdXJjZSk7Cn0KaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIHJlcXVpcmUubWFpbiA9PT0gbW9kdWxlKSB7CiAgZXhwb3J0cy5tYWluKHR5cGVvZiBwcm9jZXNzICE9PSAndW5kZWZpbmVkJyA/IHByb2Nlc3MuYXJndi5zbGljZSgxKSA6IHJlcXVpcmUoInN5c3RlbSIpLmFyZ3MpOwp9Cn07CjsKLy8gbGliL2hhbmRsZWJhcnMvY29tcGlsZXIvYmFzZS5qcwpIYW5kbGViYXJzLlBhcnNlciA9IGhhbmRsZWJhcnM7CgpIYW5kbGViYXJzLnBhcnNlID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgSGFuZGxlYmFycy5QYXJzZXIueXkgPSBIYW5kbGViYXJzLkFTVDsKICByZXR1cm4gSGFuZGxlYmFycy5QYXJzZXIucGFyc2Uoc3RyaW5nKTsKfTsKCkhhbmRsZWJhcnMucHJpbnQgPSBmdW5jdGlvbihhc3QpIHsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuUHJpbnRWaXNpdG9yKCkuYWNjZXB0KGFzdCk7Cn07CgpIYW5kbGViYXJzLmxvZ2dlciA9IHsKICBERUJVRzogMCwgSU5GTzogMSwgV0FSTjogMiwgRVJST1I6IDMsIGxldmVsOiAzLAoKICAvLyBvdmVycmlkZSBpbiB0aGUgaG9zdCBlbnZpcm9ubWVudAogIGxvZzogZnVuY3Rpb24obGV2ZWwsIHN0cikge30KfTsKCkhhbmRsZWJhcnMubG9nID0gZnVuY3Rpb24obGV2ZWwsIHN0cikgeyBIYW5kbGViYXJzLmxvZ2dlci5sb2cobGV2ZWwsIHN0cik7IH07CjsKLy8gbGliL2hhbmRsZWJhcnMvY29tcGlsZXIvYXN0LmpzCihmdW5jdGlvbigpIHsKCiAgSGFuZGxlYmFycy5BU1QgPSB7fTsKCiAgSGFuZGxlYmFycy5BU1QuUHJvZ3JhbU5vZGUgPSBmdW5jdGlvbihzdGF0ZW1lbnRzLCBpbnZlcnNlKSB7CiAgICB0aGlzLnR5cGUgPSAicHJvZ3JhbSI7CiAgICB0aGlzLnN0YXRlbWVudHMgPSBzdGF0ZW1lbnRzOwogICAgaWYoaW52ZXJzZSkgeyB0aGlzLmludmVyc2UgPSBuZXcgSGFuZGxlYmFycy5BU1QuUHJvZ3JhbU5vZGUoaW52ZXJzZSk7IH0KICB9OwoKICBIYW5kbGViYXJzLkFTVC5NdXN0YWNoZU5vZGUgPSBmdW5jdGlvbihyYXdQYXJhbXMsIGhhc2gsIHVuZXNjYXBlZCkgewogICAgdGhpcy50eXBlID0gIm11c3RhY2hlIjsKICAgIHRoaXMuZXNjYXBlZCA9ICF1bmVzY2FwZWQ7CiAgICB0aGlzLmhhc2ggPSBoYXNoOwoKICAgIHZhciBpZCA9IHRoaXMuaWQgPSByYXdQYXJhbXNbMF07CiAgICB2YXIgcGFyYW1zID0gdGhpcy5wYXJhbXMgPSByYXdQYXJhbXMuc2xpY2UoMSk7CgogICAgLy8gYSBtdXN0YWNoZSBpcyBhbiBlbGlnaWJsZSBoZWxwZXIgaWY6CiAgICAvLyAqIGl0cyBpZCBpcyBzaW1wbGUgKGEgc2luZ2xlIHBhcnQsIG5vdCBgdGhpc2Agb3IgYC4uYCkKICAgIHZhciBlbGlnaWJsZUhlbHBlciA9IHRoaXMuZWxpZ2libGVIZWxwZXIgPSBpZC5pc1NpbXBsZTsKCiAgICAvLyBhIG11c3RhY2hlIGlzIGRlZmluaXRlbHkgYSBoZWxwZXIgaWY6CiAgICAvLyAqIGl0IGlzIGFuIGVsaWdpYmxlIGhlbHBlciwgYW5kCiAgICAvLyAqIGl0IGhhcyBhdCBsZWFzdCBvbmUgcGFyYW1ldGVyIG9yIGhhc2ggc2VnbWVudAogICAgdGhpcy5pc0hlbHBlciA9IGVsaWdpYmxlSGVscGVyICYmIChwYXJhbXMubGVuZ3RoIHx8IGhhc2gpOwoKICAgIC8vIGlmIGEgbXVzdGFjaGUgaXMgYW4gZWxpZ2libGUgaGVscGVyIGJ1dCBub3QgYSBkZWZpbml0ZQogICAgLy8gaGVscGVyLCBpdCBpcyBhbWJpZ3VvdXMsIGFuZCB3aWxsIGJlIHJlc29sdmVkIGluIGEgbGF0ZXIKICAgIC8vIHBhc3Mgb3IgYXQgcnVudGltZS4KICB9OwoKICBIYW5kbGViYXJzLkFTVC5QYXJ0aWFsTm9kZSA9IGZ1bmN0aW9uKGlkLCBjb250ZXh0KSB7CiAgICB0aGlzLnR5cGUgICAgPSAicGFydGlhbCI7CgogICAgLy8gVE9ETzogZGlzYWxsb3cgY29tcGxleCBJRHMKCiAgICB0aGlzLmlkICAgICAgPSBpZDsKICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgfTsKCiAgdmFyIHZlcmlmeU1hdGNoID0gZnVuY3Rpb24ob3BlbiwgY2xvc2UpIHsKICAgIGlmKG9wZW4ub3JpZ2luYWwgIT09IGNsb3NlLm9yaWdpbmFsKSB7CiAgICAgIHRocm93IG5ldyBIYW5kbGViYXJzLkV4Y2VwdGlvbihvcGVuLm9yaWdpbmFsICsgIiBkb2Vzbid0IG1hdGNoICIgKyBjbG9zZS5vcmlnaW5hbCk7CiAgICB9CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuQmxvY2tOb2RlID0gZnVuY3Rpb24obXVzdGFjaGUsIHByb2dyYW0sIGludmVyc2UsIGNsb3NlKSB7CiAgICB2ZXJpZnlNYXRjaChtdXN0YWNoZS5pZCwgY2xvc2UpOwogICAgdGhpcy50eXBlID0gImJsb2NrIjsKICAgIHRoaXMubXVzdGFjaGUgPSBtdXN0YWNoZTsKICAgIHRoaXMucHJvZ3JhbSAgPSBwcm9ncmFtOwogICAgdGhpcy5pbnZlcnNlICA9IGludmVyc2U7CgogICAgaWYgKHRoaXMuaW52ZXJzZSAmJiAhdGhpcy5wcm9ncmFtKSB7CiAgICAgIHRoaXMuaXNJbnZlcnNlID0gdHJ1ZTsKICAgIH0KICB9OwoKICBIYW5kbGViYXJzLkFTVC5Db250ZW50Tm9kZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgdGhpcy50eXBlID0gImNvbnRlbnQiOwogICAgdGhpcy5zdHJpbmcgPSBzdHJpbmc7CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuSGFzaE5vZGUgPSBmdW5jdGlvbihwYWlycykgewogICAgdGhpcy50eXBlID0gImhhc2giOwogICAgdGhpcy5wYWlycyA9IHBhaXJzOwogIH07CgogIEhhbmRsZWJhcnMuQVNULklkTm9kZSA9IGZ1bmN0aW9uKHBhcnRzKSB7CiAgICB0aGlzLnR5cGUgPSAiSUQiOwogICAgdGhpcy5vcmlnaW5hbCA9IHBhcnRzLmpvaW4oIi4iKTsKCiAgICB2YXIgZGlnID0gW10sIGRlcHRoID0gMDsKCiAgICBmb3IodmFyIGk9MCxsPXBhcnRzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgdmFyIHBhcnQgPSBwYXJ0c1tpXTsKCiAgICAgIGlmKHBhcnQgPT09ICIuLiIpIHsgZGVwdGgrKzsgfQogICAgICBlbHNlIGlmKHBhcnQgPT09ICIuIiB8fCBwYXJ0ID09PSAidGhpcyIpIHsgdGhpcy5pc1Njb3BlZCA9IHRydWU7IH0KICAgICAgZWxzZSB7IGRpZy5wdXNoKHBhcnQpOyB9CiAgICB9CgogICAgdGhpcy5wYXJ0cyAgICA9IGRpZzsKICAgIHRoaXMuc3RyaW5nICAgPSBkaWcuam9pbignLicpOwogICAgdGhpcy5kZXB0aCAgICA9IGRlcHRoOwoKICAgIC8vIGFuIElEIGlzIHNpbXBsZSBpZiBpdCBvbmx5IGhhcyBvbmUgcGFydCwgYW5kIHRoYXQgcGFydCBpcyBub3QKICAgIC8vIGAuLmAgb3IgYHRoaXNgLgogICAgdGhpcy5pc1NpbXBsZSA9IHBhcnRzLmxlbmd0aCA9PT0gMSAmJiAhdGhpcy5pc1Njb3BlZCAmJiBkZXB0aCA9PT0gMDsKICB9OwoKICBIYW5kbGViYXJzLkFTVC5EYXRhTm9kZSA9IGZ1bmN0aW9uKGlkKSB7CiAgICB0aGlzLnR5cGUgPSAiREFUQSI7CiAgICB0aGlzLmlkID0gaWQ7CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuU3RyaW5nTm9kZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgdGhpcy50eXBlID0gIlNUUklORyI7CiAgICB0aGlzLnN0cmluZyA9IHN0cmluZzsKICB9OwoKICBIYW5kbGViYXJzLkFTVC5JbnRlZ2VyTm9kZSA9IGZ1bmN0aW9uKGludGVnZXIpIHsKICAgIHRoaXMudHlwZSA9ICJJTlRFR0VSIjsKICAgIHRoaXMuaW50ZWdlciA9IGludGVnZXI7CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuQm9vbGVhbk5vZGUgPSBmdW5jdGlvbihib29sKSB7CiAgICB0aGlzLnR5cGUgPSAiQk9PTEVBTiI7CiAgICB0aGlzLmJvb2wgPSBib29sOwogIH07CgogIEhhbmRsZWJhcnMuQVNULkNvbW1lbnROb2RlID0gZnVuY3Rpb24oY29tbWVudCkgewogICAgdGhpcy50eXBlID0gImNvbW1lbnQiOwogICAgdGhpcy5jb21tZW50ID0gY29tbWVudDsKICB9OwoKfSkoKTs7Ci8vIGxpYi9oYW5kbGViYXJzL3V0aWxzLmpzCkhhbmRsZWJhcnMuRXhjZXB0aW9uID0gZnVuY3Rpb24obWVzc2FnZSkgewogIHZhciB0bXAgPSBFcnJvci5wcm90b3R5cGUuY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgZm9yICh2YXIgcCBpbiB0bXApIHsKICAgIGlmICh0bXAuaGFzT3duUHJvcGVydHkocCkpIHsgdGhpc1twXSA9IHRtcFtwXTsgfQogIH0KCiAgdGhpcy5tZXNzYWdlID0gdG1wLm1lc3NhZ2U7Cn07CkhhbmRsZWJhcnMuRXhjZXB0aW9uLnByb3RvdHlwZSA9IG5ldyBFcnJvcigpOwoKLy8gQnVpbGQgb3V0IG91ciBiYXNpYyBTYWZlU3RyaW5nIHR5cGUKSGFuZGxlYmFycy5TYWZlU3RyaW5nID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgdGhpcy5zdHJpbmcgPSBzdHJpbmc7Cn07CkhhbmRsZWJhcnMuU2FmZVN0cmluZy5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5zdHJpbmcudG9TdHJpbmcoKTsKfTsKCihmdW5jdGlvbigpIHsKICB2YXIgZXNjYXBlID0gewogICAgIiYiOiAiJmFtcDsiLAogICAgIjwiOiAiJmx0OyIsCiAgICAiPiI6ICImZ3Q7IiwKICAgICciJzogIiZxdW90OyIsCiAgICAiJyI6ICImI3gyNzsiLAogICAgImAiOiAiJiN4NjA7IgogIH07CgogIHZhciBiYWRDaGFycyA9IC9bJjw+IidgXS9nOwogIHZhciBwb3NzaWJsZSA9IC9bJjw+IidgXS87CgogIHZhciBlc2NhcGVDaGFyID0gZnVuY3Rpb24oY2hyKSB7CiAgICByZXR1cm4gZXNjYXBlW2Nocl0gfHwgIiZhbXA7IjsKICB9OwoKICBIYW5kbGViYXJzLlV0aWxzID0gewogICAgZXNjYXBlRXhwcmVzc2lvbjogZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgIC8vIGRvbid0IGVzY2FwZSBTYWZlU3RyaW5ncywgc2luY2UgdGhleSdyZSBhbHJlYWR5IHNhZmUKICAgICAgaWYgKHN0cmluZyBpbnN0YW5jZW9mIEhhbmRsZWJhcnMuU2FmZVN0cmluZykgewogICAgICAgIHJldHVybiBzdHJpbmcudG9TdHJpbmcoKTsKICAgICAgfSBlbHNlIGlmIChzdHJpbmcgPT0gbnVsbCB8fCBzdHJpbmcgPT09IGZhbHNlKSB7CiAgICAgICAgcmV0dXJuICIiOwogICAgICB9CgogICAgICBpZighcG9zc2libGUudGVzdChzdHJpbmcpKSB7IHJldHVybiBzdHJpbmc7IH0KICAgICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKGJhZENoYXJzLCBlc2NhcGVDaGFyKTsKICAgIH0sCgogICAgaXNFbXB0eTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBmYWxzZSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgaWYoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKSA9PT0gIltvYmplY3QgQXJyYXldIiAmJiB2YWx1ZS5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICB9Owp9KSgpOzsKLy8gbGliL2hhbmRsZWJhcnMvY29tcGlsZXIvY29tcGlsZXIuanMKCi8qanNoaW50IGVxbnVsbDp0cnVlKi8KSGFuZGxlYmFycy5Db21waWxlciA9IGZ1bmN0aW9uKCkge307CkhhbmRsZWJhcnMuSmF2YVNjcmlwdENvbXBpbGVyID0gZnVuY3Rpb24oKSB7fTsKCihmdW5jdGlvbihDb21waWxlciwgSmF2YVNjcmlwdENvbXBpbGVyKSB7CiAgLy8gdGhlIGZvdW5kSGVscGVyIHJlZ2lzdGVyIHdpbGwgZGlzYW1iaWd1YXRlIGhlbHBlciBsb29rdXAgZnJvbSBmaW5kaW5nIGEKICAvLyBmdW5jdGlvbiBpbiBhIGNvbnRleHQuIFRoaXMgaXMgbmVjZXNzYXJ5IGZvciBtdXN0YWNoZSBjb21wYXRpYmlsaXR5LCB3aGljaAogIC8vIHJlcXVpcmVzIHRoYXQgY29udGV4dCBmdW5jdGlvbnMgaW4gYmxvY2tzIGFyZSBldmFsdWF0ZWQgYnkgYmxvY2tIZWxwZXJNaXNzaW5nLAogIC8vIGFuZCB0aGVuIHByb2NlZWQgYXMgaWYgdGhlIHJlc3VsdGluZyB2YWx1ZSB3YXMgcHJvdmlkZWQgdG8gYmxvY2tIZWxwZXJNaXNzaW5nLgoKICBDb21waWxlci5wcm90b3R5cGUgPSB7CiAgICBjb21waWxlcjogQ29tcGlsZXIsCgogICAgZGlzYXNzZW1ibGU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb3Bjb2RlcyA9IHRoaXMub3Bjb2Rlcywgb3Bjb2RlLCBvdXQgPSBbXSwgcGFyYW1zLCBwYXJhbTsKCiAgICAgIGZvciAodmFyIGk9MCwgbD1vcGNvZGVzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICBvcGNvZGUgPSBvcGNvZGVzW2ldOwoKICAgICAgICBpZiAob3Bjb2RlLm9wY29kZSA9PT0gJ0RFQ0xBUkUnKSB7CiAgICAgICAgICBvdXQucHVzaCgiREVDTEFSRSAiICsgb3Bjb2RlLm5hbWUgKyAiPSIgKyBvcGNvZGUudmFsdWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBwYXJhbXMgPSBbXTsKICAgICAgICAgIGZvciAodmFyIGo9MDsgajxvcGNvZGUuYXJncy5sZW5ndGg7IGorKykgewogICAgICAgICAgICBwYXJhbSA9IG9wY29kZS5hcmdzW2pdOwogICAgICAgICAgICBpZiAodHlwZW9mIHBhcmFtID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHBhcmFtID0gIlwiIiArIHBhcmFtLnJlcGxhY2UoIlxuIiwgIlxcbiIpICsgIlwiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJhbXMucHVzaChwYXJhbSk7CiAgICAgICAgICB9CiAgICAgICAgICBvdXQucHVzaChvcGNvZGUub3Bjb2RlICsgIiAiICsgcGFyYW1zLmpvaW4oIiAiKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gb3V0LmpvaW4oIlxuIik7CiAgICB9LAoKICAgIGd1aWQ6IDAsCgogICAgY29tcGlsZTogZnVuY3Rpb24ocHJvZ3JhbSwgb3B0aW9ucykgewogICAgICB0aGlzLmNoaWxkcmVuID0gW107CiAgICAgIHRoaXMuZGVwdGhzID0ge2xpc3Q6IFtdfTsKICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKCiAgICAgIC8vIFRoZXNlIGNoYW5nZXMgd2lsbCBwcm9wYWdhdGUgdG8gdGhlIG90aGVyIGNvbXBpbGVyIGNvbXBvbmVudHMKICAgICAgdmFyIGtub3duSGVscGVycyA9IHRoaXMub3B0aW9ucy5rbm93bkhlbHBlcnM7CiAgICAgIHRoaXMub3B0aW9ucy5rbm93bkhlbHBlcnMgPSB7CiAgICAgICAgJ2hlbHBlck1pc3NpbmcnOiB0cnVlLAogICAgICAgICdibG9ja0hlbHBlck1pc3NpbmcnOiB0cnVlLAogICAgICAgICdlYWNoJzogdHJ1ZSwKICAgICAgICAnaWYnOiB0cnVlLAogICAgICAgICd1bmxlc3MnOiB0cnVlLAogICAgICAgICd3aXRoJzogdHJ1ZSwKICAgICAgICAnbG9nJzogdHJ1ZQogICAgICB9OwogICAgICBpZiAoa25vd25IZWxwZXJzKSB7CiAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBrbm93bkhlbHBlcnMpIHsKICAgICAgICAgIHRoaXMub3B0aW9ucy5rbm93bkhlbHBlcnNbbmFtZV0gPSBrbm93bkhlbHBlcnNbbmFtZV07CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5wcm9ncmFtKHByb2dyYW0pOwogICAgfSwKCiAgICBhY2NlcHQ6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgcmV0dXJuIHRoaXNbbm9kZS50eXBlXShub2RlKTsKICAgIH0sCgogICAgcHJvZ3JhbTogZnVuY3Rpb24ocHJvZ3JhbSkgewogICAgICB2YXIgc3RhdGVtZW50cyA9IHByb2dyYW0uc3RhdGVtZW50cywgc3RhdGVtZW50OwogICAgICB0aGlzLm9wY29kZXMgPSBbXTsKCiAgICAgIGZvcih2YXIgaT0wLCBsPXN0YXRlbWVudHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIHN0YXRlbWVudCA9IHN0YXRlbWVudHNbaV07CiAgICAgICAgdGhpc1tzdGF0ZW1lbnQudHlwZV0oc3RhdGVtZW50KTsKICAgICAgfQogICAgICB0aGlzLmlzU2ltcGxlID0gbCA9PT0gMTsKCiAgICAgIHRoaXMuZGVwdGhzLmxpc3QgPSB0aGlzLmRlcHRocy5saXN0LnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgICAgIHJldHVybiBhIC0gYjsKICAgICAgfSk7CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgY29tcGlsZVByb2dyYW06IGZ1bmN0aW9uKHByb2dyYW0pIHsKICAgICAgdmFyIHJlc3VsdCA9IG5ldyB0aGlzLmNvbXBpbGVyKCkuY29tcGlsZShwcm9ncmFtLCB0aGlzLm9wdGlvbnMpOwogICAgICB2YXIgZ3VpZCA9IHRoaXMuZ3VpZCsrLCBkZXB0aDsKCiAgICAgIHRoaXMudXNlUGFydGlhbCA9IHRoaXMudXNlUGFydGlhbCB8fCByZXN1bHQudXNlUGFydGlhbDsKCiAgICAgIHRoaXMuY2hpbGRyZW5bZ3VpZF0gPSByZXN1bHQ7CgogICAgICBmb3IodmFyIGk9MCwgbD1yZXN1bHQuZGVwdGhzLmxpc3QubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIGRlcHRoID0gcmVzdWx0LmRlcHRocy5saXN0W2ldOwoKICAgICAgICBpZihkZXB0aCA8IDIpIHsgY29udGludWU7IH0KICAgICAgICBlbHNlIHsgdGhpcy5hZGREZXB0aChkZXB0aCAtIDEpOyB9CiAgICAgIH0KCiAgICAgIHJldHVybiBndWlkOwogICAgfSwKCiAgICBibG9jazogZnVuY3Rpb24oYmxvY2spIHsKICAgICAgdmFyIG11c3RhY2hlID0gYmxvY2subXVzdGFjaGUsCiAgICAgICAgICBwcm9ncmFtID0gYmxvY2sucHJvZ3JhbSwKICAgICAgICAgIGludmVyc2UgPSBibG9jay5pbnZlcnNlOwoKICAgICAgaWYgKHByb2dyYW0pIHsKICAgICAgICBwcm9ncmFtID0gdGhpcy5jb21waWxlUHJvZ3JhbShwcm9ncmFtKTsKICAgICAgfQoKICAgICAgaWYgKGludmVyc2UpIHsKICAgICAgICBpbnZlcnNlID0gdGhpcy5jb21waWxlUHJvZ3JhbShpbnZlcnNlKTsKICAgICAgfQoKICAgICAgdmFyIHR5cGUgPSB0aGlzLmNsYXNzaWZ5TXVzdGFjaGUobXVzdGFjaGUpOwoKICAgICAgaWYgKHR5cGUgPT09ICJoZWxwZXIiKSB7CiAgICAgICAgdGhpcy5oZWxwZXJNdXN0YWNoZShtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gInNpbXBsZSIpIHsKICAgICAgICB0aGlzLnNpbXBsZU11c3RhY2hlKG11c3RhY2hlKTsKCiAgICAgICAgLy8gbm93IHRoYXQgdGhlIHNpbXBsZSBtdXN0YWNoZSBpcyByZXNvbHZlZCwgd2UgbmVlZCB0bwogICAgICAgIC8vIGV2YWx1YXRlIGl0IGJ5IGV4ZWN1dGluZyBgYmxvY2tIZWxwZXJNaXNzaW5nYAogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIHByb2dyYW0pOwogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIGludmVyc2UpOwogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoTGl0ZXJhbCcsICd7fScpOwogICAgICAgIHRoaXMub3Bjb2RlKCdibG9ja1ZhbHVlJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5hbWJpZ3VvdXNNdXN0YWNoZShtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSk7CgogICAgICAgIC8vIG5vdyB0aGF0IHRoZSBzaW1wbGUgbXVzdGFjaGUgaXMgcmVzb2x2ZWQsIHdlIG5lZWQgdG8KICAgICAgICAvLyBldmFsdWF0ZSBpdCBieSBleGVjdXRpbmcgYGJsb2NrSGVscGVyTWlzc2luZ2AKICAgICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBwcm9ncmFtKTsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBpbnZlcnNlKTsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCAne30nKTsKICAgICAgICB0aGlzLm9wY29kZSgnYW1iaWd1b3VzQmxvY2tWYWx1ZScpOwogICAgICB9CgogICAgICB0aGlzLm9wY29kZSgnYXBwZW5kJyk7CiAgICB9LAoKICAgIGhhc2g6IGZ1bmN0aW9uKGhhc2gpIHsKICAgICAgdmFyIHBhaXJzID0gaGFzaC5wYWlycywgcGFpciwgdmFsOwoKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2gnLCAne30nKTsKCiAgICAgIGZvcih2YXIgaT0wLCBsPXBhaXJzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICBwYWlyID0gcGFpcnNbaV07CiAgICAgICAgdmFsICA9IHBhaXJbMV07CgogICAgICAgIHRoaXMuYWNjZXB0KHZhbCk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2Fzc2lnblRvSGFzaCcsIHBhaXJbMF0pOwogICAgICB9CiAgICB9LAoKICAgIHBhcnRpYWw6IGZ1bmN0aW9uKHBhcnRpYWwpIHsKICAgICAgdmFyIGlkID0gcGFydGlhbC5pZDsKICAgICAgdGhpcy51c2VQYXJ0aWFsID0gdHJ1ZTsKCiAgICAgIGlmKHBhcnRpYWwuY29udGV4dCkgewogICAgICAgIHRoaXMuSUQocGFydGlhbC5jb250ZXh0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaCcsICdkZXB0aDAnKTsKICAgICAgfQoKICAgICAgdGhpcy5vcGNvZGUoJ2ludm9rZVBhcnRpYWwnLCBpZC5vcmlnaW5hbCk7CiAgICAgIHRoaXMub3Bjb2RlKCdhcHBlbmQnKTsKICAgIH0sCgogICAgY29udGVudDogZnVuY3Rpb24oY29udGVudCkgewogICAgICB0aGlzLm9wY29kZSgnYXBwZW5kQ29udGVudCcsIGNvbnRlbnQuc3RyaW5nKTsKICAgIH0sCgogICAgbXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlKSB7CiAgICAgIHZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwogICAgICB2YXIgdHlwZSA9IHRoaXMuY2xhc3NpZnlNdXN0YWNoZShtdXN0YWNoZSk7CgogICAgICBpZiAodHlwZSA9PT0gInNpbXBsZSIpIHsKICAgICAgICB0aGlzLnNpbXBsZU11c3RhY2hlKG11c3RhY2hlKTsKICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAiaGVscGVyIikgewogICAgICAgIHRoaXMuaGVscGVyTXVzdGFjaGUobXVzdGFjaGUpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYW1iaWd1b3VzTXVzdGFjaGUobXVzdGFjaGUpOwogICAgICB9CgogICAgICBpZihtdXN0YWNoZS5lc2NhcGVkICYmICFvcHRpb25zLm5vRXNjYXBlKSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2FwcGVuZEVzY2FwZWQnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgnYXBwZW5kJyk7CiAgICAgIH0KICAgIH0sCgogICAgYW1iaWd1b3VzTXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBpZCA9IG11c3RhY2hlLmlkLCBuYW1lID0gaWQucGFydHNbMF07CgogICAgICB0aGlzLm9wY29kZSgnZ2V0Q29udGV4dCcsIGlkLmRlcHRoKTsKCiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIHByb2dyYW0pOwogICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBpbnZlcnNlKTsKCiAgICAgIHRoaXMub3Bjb2RlKCdpbnZva2VBbWJpZ3VvdXMnLCBuYW1lKTsKICAgIH0sCgogICAgc2ltcGxlTXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBpZCA9IG11c3RhY2hlLmlkOwoKICAgICAgaWYgKGlkLnR5cGUgPT09ICdEQVRBJykgewogICAgICAgIHRoaXMuREFUQShpZCk7CiAgICAgIH0gZWxzZSBpZiAoaWQucGFydHMubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5JRChpZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU2ltcGxpZmllZCBJRCBmb3IgYHRoaXNgCiAgICAgICAgdGhpcy5hZGREZXB0aChpZC5kZXB0aCk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBpZC5kZXB0aCk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hDb250ZXh0Jyk7CiAgICAgIH0KCiAgICAgIHRoaXMub3Bjb2RlKCdyZXNvbHZlUG9zc2libGVMYW1iZGEnKTsKICAgIH0sCgogICAgaGVscGVyTXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBwYXJhbXMgPSB0aGlzLnNldHVwRnVsbE11c3RhY2hlUGFyYW1zKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSwKICAgICAgICAgIG5hbWUgPSBtdXN0YWNoZS5pZC5wYXJ0c1swXTsKCiAgICAgIGlmICh0aGlzLm9wdGlvbnMua25vd25IZWxwZXJzW25hbWVdKSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2ludm9rZUtub3duSGVscGVyJywgcGFyYW1zLmxlbmd0aCwgbmFtZSk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5rbm93bkhlbHBlcnNPbmx5KSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3Ugc3BlY2lmaWVkIGtub3duSGVscGVyc09ubHksIGJ1dCB1c2VkIHRoZSB1bmtub3duIGhlbHBlciAiICsgbmFtZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2ludm9rZUhlbHBlcicsIHBhcmFtcy5sZW5ndGgsIG5hbWUpOwogICAgICB9CiAgICB9LAoKICAgIElEOiBmdW5jdGlvbihpZCkgewogICAgICB0aGlzLmFkZERlcHRoKGlkLmRlcHRoKTsKICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBpZC5kZXB0aCk7CgogICAgICB2YXIgbmFtZSA9IGlkLnBhcnRzWzBdOwogICAgICBpZiAoIW5hbWUpIHsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaENvbnRleHQnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgnbG9va3VwT25Db250ZXh0JywgaWQucGFydHNbMF0pOwogICAgICB9CgogICAgICBmb3IodmFyIGk9MSwgbD1pZC5wYXJ0cy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2xvb2t1cCcsIGlkLnBhcnRzW2ldKTsKICAgICAgfQogICAgfSwKCiAgICBEQVRBOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHRoaXMub3B0aW9ucy5kYXRhID0gdHJ1ZTsKICAgICAgdGhpcy5vcGNvZGUoJ2xvb2t1cERhdGEnLCBkYXRhLmlkKTsKICAgIH0sCgogICAgU1RSSU5HOiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hTdHJpbmcnLCBzdHJpbmcuc3RyaW5nKTsKICAgIH0sCgogICAgSU5URUdFUjogZnVuY3Rpb24oaW50ZWdlcikgewogICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCBpbnRlZ2VyLmludGVnZXIpOwogICAgfSwKCiAgICBCT09MRUFOOiBmdW5jdGlvbihib29sKSB7CiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoTGl0ZXJhbCcsIGJvb2wuYm9vbCk7CiAgICB9LAoKICAgIGNvbW1lbnQ6IGZ1bmN0aW9uKCkge30sCgogICAgLy8gSEVMUEVSUwogICAgb3Bjb2RlOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHRoaXMub3Bjb2Rlcy5wdXNoKHsgb3Bjb2RlOiBuYW1lLCBhcmdzOiBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSkgfSk7CiAgICB9LAoKICAgIGRlY2xhcmU6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgIHRoaXMub3Bjb2Rlcy5wdXNoKHsgb3Bjb2RlOiAnREVDTEFSRScsIG5hbWU6IG5hbWUsIHZhbHVlOiB2YWx1ZSB9KTsKICAgIH0sCgogICAgYWRkRGVwdGg6IGZ1bmN0aW9uKGRlcHRoKSB7CiAgICAgIGlmKGlzTmFOKGRlcHRoKSkgeyB0aHJvdyBuZXcgRXJyb3IoIkVXT1QiKTsgfQogICAgICBpZihkZXB0aCA9PT0gMCkgeyByZXR1cm47IH0KCiAgICAgIGlmKCF0aGlzLmRlcHRoc1tkZXB0aF0pIHsKICAgICAgICB0aGlzLmRlcHRoc1tkZXB0aF0gPSB0cnVlOwogICAgICAgIHRoaXMuZGVwdGhzLmxpc3QucHVzaChkZXB0aCk7CiAgICAgIH0KICAgIH0sCgogICAgY2xhc3NpZnlNdXN0YWNoZTogZnVuY3Rpb24obXVzdGFjaGUpIHsKICAgICAgdmFyIGlzSGVscGVyICAgPSBtdXN0YWNoZS5pc0hlbHBlcjsKICAgICAgdmFyIGlzRWxpZ2libGUgPSBtdXN0YWNoZS5lbGlnaWJsZUhlbHBlcjsKICAgICAgdmFyIG9wdGlvbnMgICAgPSB0aGlzLm9wdGlvbnM7CgogICAgICAvLyBpZiBhbWJpZ3VvdXMsIHdlIGNhbiBwb3NzaWJseSByZXNvbHZlIHRoZSBhbWJpZ3VpdHkgbm93CiAgICAgIGlmIChpc0VsaWdpYmxlICYmICFpc0hlbHBlcikgewogICAgICAgIHZhciBuYW1lID0gbXVzdGFjaGUuaWQucGFydHNbMF07CgogICAgICAgIGlmIChvcHRpb25zLmtub3duSGVscGVyc1tuYW1lXSkgewogICAgICAgICAgaXNIZWxwZXIgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5rbm93bkhlbHBlcnNPbmx5KSB7CiAgICAgICAgICBpc0VsaWdpYmxlID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoaXNIZWxwZXIpIHsgcmV0dXJuICJoZWxwZXIiOyB9CiAgICAgIGVsc2UgaWYgKGlzRWxpZ2libGUpIHsgcmV0dXJuICJhbWJpZ3VvdXMiOyB9CiAgICAgIGVsc2UgeyByZXR1cm4gInNpbXBsZSI7IH0KICAgIH0sCgogICAgcHVzaFBhcmFtczogZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgIHZhciBpID0gcGFyYW1zLmxlbmd0aCwgcGFyYW07CgogICAgICB3aGlsZShpLS0pIHsKICAgICAgICBwYXJhbSA9IHBhcmFtc1tpXTsKCiAgICAgICAgaWYodGhpcy5vcHRpb25zLnN0cmluZ1BhcmFtcykgewogICAgICAgICAgaWYocGFyYW0uZGVwdGgpIHsKICAgICAgICAgICAgdGhpcy5hZGREZXB0aChwYXJhbS5kZXB0aCk7CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBwYXJhbS5kZXB0aCB8fCAwKTsKICAgICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoU3RyaW5nUGFyYW0nLCBwYXJhbS5zdHJpbmcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzW3BhcmFtLnR5cGVdKHBhcmFtKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgc2V0dXBNdXN0YWNoZVBhcmFtczogZnVuY3Rpb24obXVzdGFjaGUpIHsKICAgICAgdmFyIHBhcmFtcyA9IG11c3RhY2hlLnBhcmFtczsKICAgICAgdGhpcy5wdXNoUGFyYW1zKHBhcmFtcyk7CgogICAgICBpZihtdXN0YWNoZS5oYXNoKSB7CiAgICAgICAgdGhpcy5oYXNoKG11c3RhY2hlLmhhc2gpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoTGl0ZXJhbCcsICd7fScpOwogICAgICB9CgogICAgICByZXR1cm4gcGFyYW1zOwogICAgfSwKCiAgICAvLyB0aGlzIHdpbGwgcmVwbGFjZSBzZXR1cE11c3RhY2hlUGFyYW1zIHdoZW4gd2UncmUgZG9uZQogICAgc2V0dXBGdWxsTXVzdGFjaGVQYXJhbXM6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBwYXJhbXMgPSBtdXN0YWNoZS5wYXJhbXM7CiAgICAgIHRoaXMucHVzaFBhcmFtcyhwYXJhbXMpOwoKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hQcm9ncmFtJywgcHJvZ3JhbSk7CiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIGludmVyc2UpOwoKICAgICAgaWYobXVzdGFjaGUuaGFzaCkgewogICAgICAgIHRoaXMuaGFzaChtdXN0YWNoZS5oYXNoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCAne30nKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHBhcmFtczsKICAgIH0KICB9OwoKICB2YXIgTGl0ZXJhbCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgfTsKCiAgSmF2YVNjcmlwdENvbXBpbGVyLnByb3RvdHlwZSA9IHsKICAgIC8vIFBVQkxJQyBBUEk6IFlvdSBjYW4gb3ZlcnJpZGUgdGhlc2UgbWV0aG9kcyBpbiBhIHN1YmNsYXNzIHRvIHByb3ZpZGUKICAgIC8vIGFsdGVybmF0aXZlIGNvbXBpbGVkIGZvcm1zIGZvciBuYW1lIGxvb2t1cCBhbmQgYnVmZmVyaW5nIHNlbWFudGljcwogICAgbmFtZUxvb2t1cDogZnVuY3Rpb24ocGFyZW50LCBuYW1lLCB0eXBlKSB7CiAgICAgIGlmICgvXlswLTldKyQvLnRlc3QobmFtZSkpIHsKICAgICAgICByZXR1cm4gcGFyZW50ICsgIlsiICsgbmFtZSArICJdIjsKICAgICAgfSBlbHNlIGlmIChKYXZhU2NyaXB0Q29tcGlsZXIuaXNWYWxpZEphdmFTY3JpcHRWYXJpYWJsZU5hbWUobmFtZSkpIHsKICAgICAgICByZXR1cm4gcGFyZW50ICsgIi4iICsgbmFtZTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICByZXR1cm4gcGFyZW50ICsgIlsnIiArIG5hbWUgKyAiJ10iOwogICAgICB9CiAgICB9LAoKICAgIGFwcGVuZFRvQnVmZmVyOiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgaWYgKHRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICByZXR1cm4gInJldHVybiAiICsgc3RyaW5nICsgIjsiOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiAiYnVmZmVyICs9ICIgKyBzdHJpbmcgKyAiOyI7CiAgICAgIH0KICAgIH0sCgogICAgaW5pdGlhbGl6ZUJ1ZmZlcjogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnF1b3RlZFN0cmluZygiIik7CiAgICB9LAoKICAgIG5hbWVzcGFjZTogIkhhbmRsZWJhcnMiLAogICAgLy8gRU5EIFBVQkxJQyBBUEkKCiAgICBjb21waWxlOiBmdW5jdGlvbihlbnZpcm9ubWVudCwgb3B0aW9ucywgY29udGV4dCwgYXNPYmplY3QpIHsKICAgICAgdGhpcy5lbnZpcm9ubWVudCA9IGVudmlyb25tZW50OwogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgICAgSGFuZGxlYmFycy5sb2coSGFuZGxlYmFycy5sb2dnZXIuREVCVUcsIHRoaXMuZW52aXJvbm1lbnQuZGlzYXNzZW1ibGUoKSArICJcblxuIik7CgogICAgICB0aGlzLm5hbWUgPSB0aGlzLmVudmlyb25tZW50Lm5hbWU7CiAgICAgIHRoaXMuaXNDaGlsZCA9ICEhY29udGV4dDsKICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dCB8fCB7CiAgICAgICAgcHJvZ3JhbXM6IFtdLAogICAgICAgIGFsaWFzZXM6IHsgfQogICAgICB9OwoKICAgICAgdGhpcy5wcmVhbWJsZSgpOwoKICAgICAgdGhpcy5zdGFja1Nsb3QgPSAwOwogICAgICB0aGlzLnN0YWNrVmFycyA9IFtdOwogICAgICB0aGlzLnJlZ2lzdGVycyA9IHsgbGlzdDogW10gfTsKICAgICAgdGhpcy5jb21waWxlU3RhY2sgPSBbXTsKCiAgICAgIHRoaXMuY29tcGlsZUNoaWxkcmVuKGVudmlyb25tZW50LCBvcHRpb25zKTsKCiAgICAgIHZhciBvcGNvZGVzID0gZW52aXJvbm1lbnQub3Bjb2Rlcywgb3Bjb2RlOwoKICAgICAgdGhpcy5pID0gMDsKCiAgICAgIGZvcihsPW9wY29kZXMubGVuZ3RoOyB0aGlzLmk8bDsgdGhpcy5pKyspIHsKICAgICAgICBvcGNvZGUgPSBvcGNvZGVzW3RoaXMuaV07CgogICAgICAgIGlmKG9wY29kZS5vcGNvZGUgPT09ICdERUNMQVJFJykgewogICAgICAgICAgdGhpc1tvcGNvZGUubmFtZV0gPSBvcGNvZGUudmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXNbb3Bjb2RlLm9wY29kZV0uYXBwbHkodGhpcywgb3Bjb2RlLmFyZ3MpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlRnVuY3Rpb25Db250ZXh0KGFzT2JqZWN0KTsKICAgIH0sCgogICAgbmV4dE9wY29kZTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBvcGNvZGVzID0gdGhpcy5lbnZpcm9ubWVudC5vcGNvZGVzLCBvcGNvZGUgPSBvcGNvZGVzW3RoaXMuaSArIDFdOwogICAgICByZXR1cm4gb3Bjb2Rlc1t0aGlzLmkgKyAxXTsKICAgIH0sCgogICAgZWF0OiBmdW5jdGlvbihvcGNvZGUpIHsKICAgICAgdGhpcy5pID0gdGhpcy5pICsgMTsKICAgIH0sCgogICAgcHJlYW1ibGU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb3V0ID0gW107CgogICAgICBpZiAoIXRoaXMuaXNDaGlsZCkgewogICAgICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLm5hbWVzcGFjZTsKICAgICAgICB2YXIgY29waWVzID0gImhlbHBlcnMgPSBoZWxwZXJzIHx8ICIgKyBuYW1lc3BhY2UgKyAiLmhlbHBlcnM7IjsKICAgICAgICBpZiAodGhpcy5lbnZpcm9ubWVudC51c2VQYXJ0aWFsKSB7IGNvcGllcyA9IGNvcGllcyArICIgcGFydGlhbHMgPSBwYXJ0aWFscyB8fCAiICsgbmFtZXNwYWNlICsgIi5wYXJ0aWFsczsiOyB9CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5kYXRhKSB7IGNvcGllcyA9IGNvcGllcyArICIgZGF0YSA9IGRhdGEgfHwge307IjsgfQogICAgICAgIG91dC5wdXNoKGNvcGllcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3V0LnB1c2goJycpOwogICAgICB9CgogICAgICBpZiAoIXRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICBvdXQucHVzaCgiLCBidWZmZXIgPSAiICsgdGhpcy5pbml0aWFsaXplQnVmZmVyKCkpOwogICAgICB9IGVsc2UgewogICAgICAgIG91dC5wdXNoKCIiKTsKICAgICAgfQoKICAgICAgLy8gdHJhY2sgdGhlIGxhc3QgY29udGV4dCBwdXNoZWQgaW50byBwbGFjZSB0byBhbGxvdyBza2lwcGluZyB0aGUKICAgICAgLy8gZ2V0Q29udGV4dCBvcGNvZGUgd2hlbiBpdCB3b3VsZCBiZSBhIG5vb3AKICAgICAgdGhpcy5sYXN0Q29udGV4dCA9IDA7CiAgICAgIHRoaXMuc291cmNlID0gb3V0OwogICAgfSwKCiAgICBjcmVhdGVGdW5jdGlvbkNvbnRleHQ6IGZ1bmN0aW9uKGFzT2JqZWN0KSB7CiAgICAgIHZhciBsb2NhbHMgPSB0aGlzLnN0YWNrVmFycy5jb25jYXQodGhpcy5yZWdpc3RlcnMubGlzdCk7CgogICAgICBpZihsb2NhbHMubGVuZ3RoID4gMCkgewogICAgICAgIHRoaXMuc291cmNlWzFdID0gdGhpcy5zb3VyY2VbMV0gKyAiLCAiICsgbG9jYWxzLmpvaW4oIiwgIik7CiAgICAgIH0KCiAgICAgIC8vIEdlbmVyYXRlIG1pbmltaXplciBhbGlhcyBtYXBwaW5ncwogICAgICBpZiAoIXRoaXMuaXNDaGlsZCkgewogICAgICAgIHZhciBhbGlhc2VzID0gW107CiAgICAgICAgZm9yICh2YXIgYWxpYXMgaW4gdGhpcy5jb250ZXh0LmFsaWFzZXMpIHsKICAgICAgICAgIHRoaXMuc291cmNlWzFdID0gdGhpcy5zb3VyY2VbMV0gKyAnLCAnICsgYWxpYXMgKyAnPScgKyB0aGlzLmNvbnRleHQuYWxpYXNlc1thbGlhc107CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5zb3VyY2VbMV0pIHsKICAgICAgICB0aGlzLnNvdXJjZVsxXSA9ICJ2YXIgIiArIHRoaXMuc291cmNlWzFdLnN1YnN0cmluZygyKSArICI7IjsKICAgICAgfQoKICAgICAgLy8gTWVyZ2UgY2hpbGRyZW4KICAgICAgaWYgKCF0aGlzLmlzQ2hpbGQpIHsKICAgICAgICB0aGlzLnNvdXJjZVsxXSArPSAnXG4nICsgdGhpcy5jb250ZXh0LnByb2dyYW1zLmpvaW4oJ1xuJykgKyAnXG4nOwogICAgICB9CgogICAgICBpZiAoIXRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICB0aGlzLnNvdXJjZS5wdXNoKCJyZXR1cm4gYnVmZmVyOyIpOwogICAgICB9CgogICAgICB2YXIgcGFyYW1zID0gdGhpcy5pc0NoaWxkID8gWyJkZXB0aDAiLCAiZGF0YSJdIDogWyJIYW5kbGViYXJzIiwgImRlcHRoMCIsICJoZWxwZXJzIiwgInBhcnRpYWxzIiwgImRhdGEiXTsKCiAgICAgIGZvcih2YXIgaT0wLCBsPXRoaXMuZW52aXJvbm1lbnQuZGVwdGhzLmxpc3QubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIHBhcmFtcy5wdXNoKCJkZXB0aCIgKyB0aGlzLmVudmlyb25tZW50LmRlcHRocy5saXN0W2ldKTsKICAgICAgfQoKICAgICAgaWYgKGFzT2JqZWN0KSB7CiAgICAgICAgcGFyYW1zLnB1c2godGhpcy5zb3VyY2Uuam9pbigiXG4gICIpKTsKCiAgICAgICAgcmV0dXJuIEZ1bmN0aW9uLmFwcGx5KHRoaXMsIHBhcmFtcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGZ1bmN0aW9uU291cmNlID0gJ2Z1bmN0aW9uICcgKyAodGhpcy5uYW1lIHx8ICcnKSArICcoJyArIHBhcmFtcy5qb2luKCcsJykgKyAnKSB7XG4gICcgKyB0aGlzLnNvdXJjZS5qb2luKCJcbiAgIikgKyAnfSc7CiAgICAgICAgSGFuZGxlYmFycy5sb2coSGFuZGxlYmFycy5sb2dnZXIuREVCVUcsIGZ1bmN0aW9uU291cmNlICsgIlxuXG4iKTsKICAgICAgICByZXR1cm4gZnVuY3Rpb25Tb3VyY2U7CiAgICAgIH0KICAgIH0sCgogICAgLy8gW2Jsb2NrVmFsdWVdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogaGFzaCwgaW52ZXJzZSwgcHJvZ3JhbSwgdmFsdWUKICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogcmV0dXJuIHZhbHVlIG9mIGJsb2NrSGVscGVyTWlzc2luZwogICAgLy8KICAgIC8vIFRoZSBwdXJwb3NlIG9mIHRoaXMgb3Bjb2RlIGlzIHRvIHRha2UgYSBibG9jayBvZiB0aGUgZm9ybQogICAgLy8gYHt7I2Zvb319Li4ue3svZm9vfX1gLCByZXNvbHZlIHRoZSB2YWx1ZSBvZiBgZm9vYCwgYW5kCiAgICAvLyByZXBsYWNlIGl0IG9uIHRoZSBzdGFjayB3aXRoIHRoZSByZXN1bHQgb2YgcHJvcGVybHkKICAgIC8vIGludm9raW5nIGJsb2NrSGVscGVyTWlzc2luZy4KICAgIGJsb2NrVmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5ibG9ja0hlbHBlck1pc3NpbmcgPSAnaGVscGVycy5ibG9ja0hlbHBlck1pc3NpbmcnOwoKICAgICAgdmFyIHBhcmFtcyA9IFsiZGVwdGgwIl07CiAgICAgIHRoaXMuc2V0dXBQYXJhbXMoMCwgcGFyYW1zKTsKCiAgICAgIHRoaXMucmVwbGFjZVN0YWNrKGZ1bmN0aW9uKGN1cnJlbnQpIHsKICAgICAgICBwYXJhbXMuc3BsaWNlKDEsIDAsIGN1cnJlbnQpOwogICAgICAgIHJldHVybiBjdXJyZW50ICsgIiA9IGJsb2NrSGVscGVyTWlzc2luZy5jYWxsKCIgKyBwYXJhbXMuam9pbigiLCAiKSArICIpIjsKICAgICAgfSk7CiAgICB9LAoKICAgIC8vIFthbWJpZ3VvdXNCbG9ja1ZhbHVlXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IGhhc2gsIGludmVyc2UsIHByb2dyYW0sIHZhbHVlCiAgICAvLyBDb21waWxlciB2YWx1ZSwgYmVmb3JlOiBsYXN0SGVscGVyPXZhbHVlIG9mIGxhc3QgZm91bmQgaGVscGVyLCBpZiBhbnkKICAgIC8vIE9uIHN0YWNrLCBhZnRlciwgaWYgbm8gbGFzdEhlbHBlcjogc2FtZSBhcyBbYmxvY2tWYWx1ZV0KICAgIC8vIE9uIHN0YWNrLCBhZnRlciwgaWYgbGFzdEhlbHBlcjogdmFsdWUKICAgIGFtYmlndW91c0Jsb2NrVmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5ibG9ja0hlbHBlck1pc3NpbmcgPSAnaGVscGVycy5ibG9ja0hlbHBlck1pc3NpbmcnOwoKICAgICAgdmFyIHBhcmFtcyA9IFsiZGVwdGgwIl07CiAgICAgIHRoaXMuc2V0dXBQYXJhbXMoMCwgcGFyYW1zKTsKCiAgICAgIHZhciBjdXJyZW50ID0gdGhpcy50b3BTdGFjaygpOwogICAgICBwYXJhbXMuc3BsaWNlKDEsIDAsIGN1cnJlbnQpOwoKICAgICAgdGhpcy5zb3VyY2UucHVzaCgiaWYgKCEiICsgdGhpcy5sYXN0SGVscGVyICsgIikgeyAiICsgY3VycmVudCArICIgPSBibG9ja0hlbHBlck1pc3NpbmcuY2FsbCgiICsgcGFyYW1zLmpvaW4oIiwgIikgKyAiKTsgfSIpOwogICAgfSwKCiAgICAvLyBbYXBwZW5kQ29udGVudF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogLi4uCiAgICAvLwogICAgLy8gQXBwZW5kcyB0aGUgc3RyaW5nIHZhbHVlIG9mIGBjb250ZW50YCB0byB0aGUgY3VycmVudCBidWZmZXIKICAgIGFwcGVuZENvbnRlbnQ6IGZ1bmN0aW9uKGNvbnRlbnQpIHsKICAgICAgdGhpcy5zb3VyY2UucHVzaCh0aGlzLmFwcGVuZFRvQnVmZmVyKHRoaXMucXVvdGVkU3RyaW5nKGNvbnRlbnQpKSk7CiAgICB9LAoKICAgIC8vIFthcHBlbmRdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogdmFsdWUsIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiAuLi4KICAgIC8vCiAgICAvLyBDb2VyY2VzIGB2YWx1ZWAgdG8gYSBTdHJpbmcgYW5kIGFwcGVuZHMgaXQgdG8gdGhlIGN1cnJlbnQgYnVmZmVyLgogICAgLy8KICAgIC8vIElmIGB2YWx1ZWAgaXMgdHJ1dGh5LCBvciAwLCBpdCBpcyBjb2VyY2VkIGludG8gYSBzdHJpbmcgYW5kIGFwcGVuZGVkCiAgICAvLyBPdGhlcndpc2UsIHRoZSBlbXB0eSBzdHJpbmcgaXMgYXBwZW5kZWQKICAgIGFwcGVuZDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBsb2NhbCA9IHRoaXMucG9wU3RhY2soKTsKICAgICAgdGhpcy5zb3VyY2UucHVzaCgiaWYoIiArIGxvY2FsICsgIiB8fCAiICsgbG9jYWwgKyAiID09PSAwKSB7ICIgKyB0aGlzLmFwcGVuZFRvQnVmZmVyKGxvY2FsKSArICIgfSIpOwogICAgICBpZiAodGhpcy5lbnZpcm9ubWVudC5pc1NpbXBsZSkgewogICAgICAgIHRoaXMuc291cmNlLnB1c2goImVsc2UgeyAiICsgdGhpcy5hcHBlbmRUb0J1ZmZlcigiJyciKSArICIgfSIpOwogICAgICB9CiAgICB9LAoKICAgIC8vIFthcHBlbmRFc2NhcGVkXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogLi4uCiAgICAvLwogICAgLy8gRXNjYXBlIGB2YWx1ZWAgYW5kIGFwcGVuZCBpdCB0byB0aGUgYnVmZmVyCiAgICBhcHBlbmRFc2NhcGVkOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIG9wY29kZSA9IHRoaXMubmV4dE9wY29kZSgpLCBleHRyYSA9ICIiOwogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5lc2NhcGVFeHByZXNzaW9uID0gJ3RoaXMuZXNjYXBlRXhwcmVzc2lvbic7CgogICAgICBpZihvcGNvZGUgJiYgb3Bjb2RlLm9wY29kZSA9PT0gJ2FwcGVuZENvbnRlbnQnKSB7CiAgICAgICAgZXh0cmEgPSAiICsgIiArIHRoaXMucXVvdGVkU3RyaW5nKG9wY29kZS5hcmdzWzBdKTsKICAgICAgICB0aGlzLmVhdChvcGNvZGUpOwogICAgICB9CgogICAgICB0aGlzLnNvdXJjZS5wdXNoKHRoaXMuYXBwZW5kVG9CdWZmZXIoImVzY2FwZUV4cHJlc3Npb24oIiArIHRoaXMucG9wU3RhY2soKSArICIpIiArIGV4dHJhKSk7CiAgICB9LAoKICAgIC8vIFtnZXRDb250ZXh0XQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiAuLi4KICAgIC8vIENvbXBpbGVyIHZhbHVlLCBhZnRlcjogbGFzdENvbnRleHQ9ZGVwdGgKICAgIC8vCiAgICAvLyBTZXQgdGhlIHZhbHVlIG9mIHRoZSBgbGFzdENvbnRleHRgIGNvbXBpbGVyIHZhbHVlIHRvIHRoZSBkZXB0aAogICAgZ2V0Q29udGV4dDogZnVuY3Rpb24oZGVwdGgpIHsKICAgICAgaWYodGhpcy5sYXN0Q29udGV4dCAhPT0gZGVwdGgpIHsKICAgICAgICB0aGlzLmxhc3RDb250ZXh0ID0gZGVwdGg7CiAgICAgIH0KICAgIH0sCgogICAgLy8gW2xvb2t1cE9uQ29udGV4dF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogY3VycmVudENvbnRleHRbbmFtZV0sIC4uLgogICAgLy8KICAgIC8vIExvb2tzIHVwIHRoZSB2YWx1ZSBvZiBgbmFtZWAgb24gdGhlIGN1cnJlbnQgY29udGV4dCBhbmQgcHVzaGVzCiAgICAvLyBpdCBvbnRvIHRoZSBzdGFjay4KICAgIGxvb2t1cE9uQ29udGV4dDogZnVuY3Rpb24obmFtZSkgewogICAgICB0aGlzLnB1c2hTdGFjayh0aGlzLm5hbWVMb29rdXAoJ2RlcHRoJyArIHRoaXMubGFzdENvbnRleHQsIG5hbWUsICdjb250ZXh0JykpOwogICAgfSwKCiAgICAvLyBbcHVzaENvbnRleHRdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IGN1cnJlbnRDb250ZXh0LCAuLi4KICAgIC8vCiAgICAvLyBQdXNoZXMgdGhlIHZhbHVlIG9mIHRoZSBjdXJyZW50IGNvbnRleHQgb250byB0aGUgc3RhY2suCiAgICBwdXNoQ29udGV4dDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbCgnZGVwdGgnICsgdGhpcy5sYXN0Q29udGV4dCk7CiAgICB9LAoKICAgIC8vIFtyZXNvbHZlUG9zc2libGVMYW1iZGFdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogdmFsdWUsIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXNvbHZlZCB2YWx1ZSwgLi4uCiAgICAvLwogICAgLy8gSWYgdGhlIGB2YWx1ZWAgaXMgYSBsYW1iZGEsIHJlcGxhY2UgaXQgb24gdGhlIHN0YWNrIGJ5CiAgICAvLyB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBsYW1iZGEKICAgIHJlc29sdmVQb3NzaWJsZUxhbWJkYTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLmZ1bmN0aW9uVHlwZSA9ICciZnVuY3Rpb24iJzsKCiAgICAgIHRoaXMucmVwbGFjZVN0YWNrKGZ1bmN0aW9uKGN1cnJlbnQpIHsKICAgICAgICByZXR1cm4gInR5cGVvZiAiICsgY3VycmVudCArICIgPT09IGZ1bmN0aW9uVHlwZSA/ICIgKyBjdXJyZW50ICsgIigpIDogIiArIGN1cnJlbnQ7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBbbG9va3VwXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogdmFsdWVbbmFtZV0sIC4uLgogICAgLy8KICAgIC8vIFJlcGxhY2UgdGhlIHZhbHVlIG9uIHRoZSBzdGFjayB3aXRoIHRoZSByZXN1bHQgb2YgbG9va2luZwogICAgLy8gdXAgYG5hbWVgIG9uIGB2YWx1ZWAKICAgIGxvb2t1cDogZnVuY3Rpb24obmFtZSkgewogICAgICB0aGlzLnJlcGxhY2VTdGFjayhmdW5jdGlvbihjdXJyZW50KSB7CiAgICAgICAgcmV0dXJuIGN1cnJlbnQgKyAiID09IG51bGwgfHwgIiArIGN1cnJlbnQgKyAiID09PSBmYWxzZSA/ICIgKyBjdXJyZW50ICsgIiA6ICIgKyB0aGlzLm5hbWVMb29rdXAoY3VycmVudCwgbmFtZSwgJ2NvbnRleHQnKTsKICAgICAgfSk7CiAgICB9LAoKICAgIC8vIFtsb29rdXBEYXRhXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBkYXRhW2lkXSwgLi4uCiAgICAvLwogICAgLy8gUHVzaCB0aGUgcmVzdWx0IG9mIGxvb2tpbmcgdXAgYGlkYCBvbiB0aGUgY3VycmVudCBkYXRhCiAgICBsb29rdXBEYXRhOiBmdW5jdGlvbihpZCkgewogICAgICB0aGlzLnB1c2hTdGFjayh0aGlzLm5hbWVMb29rdXAoJ2RhdGEnLCBpZCwgJ2RhdGEnKSk7CiAgICB9LAoKICAgIC8vIFtwdXNoU3RyaW5nUGFyYW1dCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHN0cmluZywgY3VycmVudENvbnRleHQsIC4uLgogICAgLy8KICAgIC8vIFRoaXMgb3Bjb2RlIGlzIGRlc2lnbmVkIGZvciB1c2UgaW4gc3RyaW5nIG1vZGUsIHdoaWNoCiAgICAvLyBwcm92aWRlcyB0aGUgc3RyaW5nIHZhbHVlIG9mIGEgcGFyYW1ldGVyIGFsb25nIHdpdGggaXRzCiAgICAvLyBkZXB0aCByYXRoZXIgdGhhbiByZXNvbHZpbmcgaXQgaW1tZWRpYXRlbHkuCiAgICBwdXNoU3RyaW5nUGFyYW06IGZ1bmN0aW9uKHN0cmluZykgewogICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwoJ2RlcHRoJyArIHRoaXMubGFzdENvbnRleHQpOwogICAgICB0aGlzLnB1c2hTdHJpbmcoc3RyaW5nKTsKICAgIH0sCgogICAgLy8gW3B1c2hTdHJpbmddCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHF1b3RlZFN0cmluZyhzdHJpbmcpLCAuLi4KICAgIC8vCiAgICAvLyBQdXNoIGEgcXVvdGVkIHZlcnNpb24gb2YgYHN0cmluZ2Agb250byB0aGUgc3RhY2sKICAgIHB1c2hTdHJpbmc6IGZ1bmN0aW9uKHN0cmluZykgewogICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwodGhpcy5xdW90ZWRTdHJpbmcoc3RyaW5nKSk7CiAgICB9LAoKICAgIC8vIFtwdXNoXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBleHByLCAuLi4KICAgIC8vCiAgICAvLyBQdXNoIGFuIGV4cHJlc3Npb24gb250byB0aGUgc3RhY2sKICAgIHB1c2g6IGZ1bmN0aW9uKGV4cHIpIHsKICAgICAgdGhpcy5wdXNoU3RhY2soZXhwcik7CiAgICB9LAoKICAgIC8vIFtwdXNoTGl0ZXJhbF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogdmFsdWUsIC4uLgogICAgLy8KICAgIC8vIFB1c2hlcyBhIHZhbHVlIG9udG8gdGhlIHN0YWNrLiBUaGlzIG9wZXJhdGlvbiBwcmV2ZW50cwogICAgLy8gdGhlIGNvbXBpbGVyIGZyb20gY3JlYXRpbmcgYSB0ZW1wb3JhcnkgdmFyaWFibGUgdG8gaG9sZAogICAgLy8gaXQuCiAgICBwdXNoTGl0ZXJhbDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdGhpcy5wdXNoU3RhY2tMaXRlcmFsKHZhbHVlKTsKICAgIH0sCgogICAgLy8gW3B1c2hQcm9ncmFtXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBwcm9ncmFtKGd1aWQpLCAuLi4KICAgIC8vCiAgICAvLyBQdXNoIGEgcHJvZ3JhbSBleHByZXNzaW9uIG9udG8gdGhlIHN0YWNrLiBUaGlzIHRha2VzCiAgICAvLyBhIGNvbXBpbGUtdGltZSBndWlkIGFuZCBjb252ZXJ0cyBpdCBpbnRvIGEgcnVudGltZS1hY2Nlc3NpYmxlCiAgICAvLyBleHByZXNzaW9uLgogICAgcHVzaFByb2dyYW06IGZ1bmN0aW9uKGd1aWQpIHsKICAgICAgaWYgKGd1aWQgIT0gbnVsbCkgewogICAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbCh0aGlzLnByb2dyYW1FeHByZXNzaW9uKGd1aWQpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwobnVsbCk7CiAgICAgIH0KICAgIH0sCgogICAgLy8gW2ludm9rZUhlbHBlcl0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBoYXNoLCBpbnZlcnNlLCBwcm9ncmFtLCBwYXJhbXMuLi4sIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXN1bHQgb2YgaGVscGVyIGludm9jYXRpb24KICAgIC8vCiAgICAvLyBQb3BzIG9mZiB0aGUgaGVscGVyJ3MgcGFyYW1ldGVycywgaW52b2tlcyB0aGUgaGVscGVyLAogICAgLy8gYW5kIHB1c2hlcyB0aGUgaGVscGVyJ3MgcmV0dXJuIHZhbHVlIG9udG8gdGhlIHN0YWNrLgogICAgLy8KICAgIC8vIElmIHRoZSBoZWxwZXIgaXMgbm90IGZvdW5kLCBgaGVscGVyTWlzc2luZ2AgaXMgY2FsbGVkLgogICAgaW52b2tlSGVscGVyOiBmdW5jdGlvbihwYXJhbVNpemUsIG5hbWUpIHsKICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuaGVscGVyTWlzc2luZyA9ICdoZWxwZXJzLmhlbHBlck1pc3NpbmcnOwoKICAgICAgdmFyIGhlbHBlciA9IHRoaXMubGFzdEhlbHBlciA9IHRoaXMuc2V0dXBIZWxwZXIocGFyYW1TaXplLCBuYW1lKTsKICAgICAgdGhpcy5yZWdpc3RlcignZm91bmRIZWxwZXInLCBoZWxwZXIubmFtZSk7CgogICAgICB0aGlzLnB1c2hTdGFjaygiZm91bmRIZWxwZXIgPyBmb3VuZEhlbHBlci5jYWxsKCIgKwogICAgICAgIGhlbHBlci5jYWxsUGFyYW1zICsgIikgIiArICI6IGhlbHBlck1pc3NpbmcuY2FsbCgiICsKICAgICAgICBoZWxwZXIuaGVscGVyTWlzc2luZ1BhcmFtcyArICIpIik7CiAgICB9LAoKICAgIC8vIFtpbnZva2VLbm93bkhlbHBlcl0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBoYXNoLCBpbnZlcnNlLCBwcm9ncmFtLCBwYXJhbXMuLi4sIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXN1bHQgb2YgaGVscGVyIGludm9jYXRpb24KICAgIC8vCiAgICAvLyBUaGlzIG9wZXJhdGlvbiBpcyB1c2VkIHdoZW4gdGhlIGhlbHBlciBpcyBrbm93biB0byBleGlzdCwKICAgIC8vIHNvIGEgYGhlbHBlck1pc3NpbmdgIGZhbGxiYWNrIGlzIG5vdCByZXF1aXJlZC4KICAgIGludm9rZUtub3duSGVscGVyOiBmdW5jdGlvbihwYXJhbVNpemUsIG5hbWUpIHsKICAgICAgdmFyIGhlbHBlciA9IHRoaXMuc2V0dXBIZWxwZXIocGFyYW1TaXplLCBuYW1lKTsKICAgICAgdGhpcy5wdXNoU3RhY2soaGVscGVyLm5hbWUgKyAiLmNhbGwoIiArIGhlbHBlci5jYWxsUGFyYW1zICsgIikiKTsKICAgIH0sCgogICAgLy8gW2ludm9rZUFtYmlndW91c10KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBoYXNoLCBpbnZlcnNlLCBwcm9ncmFtLCBwYXJhbXMuLi4sIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXN1bHQgb2YgZGlzYW1iaWd1YXRpb24KICAgIC8vCiAgICAvLyBUaGlzIG9wZXJhdGlvbiBpcyB1c2VkIHdoZW4gYW4gZXhwcmVzc2lvbiBsaWtlIGB7e2Zvb319YAogICAgLy8gaXMgcHJvdmlkZWQsIGJ1dCB3ZSBkb24ndCBrbm93IGF0IGNvbXBpbGUtdGltZSB3aGV0aGVyIGl0CiAgICAvLyBpcyBhIGhlbHBlciBvciBhIHBhdGguCiAgICAvLwogICAgLy8gVGhpcyBvcGVyYXRpb24gZW1pdHMgbW9yZSBjb2RlIHRoYW4gdGhlIG90aGVyIG9wdGlvbnMsCiAgICAvLyBhbmQgY2FuIGJlIGF2b2lkZWQgYnkgcGFzc2luZyB0aGUgYGtub3duSGVscGVyc2AgYW5kCiAgICAvLyBga25vd25IZWxwZXJzT25seWAgZmxhZ3MgYXQgY29tcGlsZS10aW1lLgogICAgaW52b2tlQW1iaWd1b3VzOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLmZ1bmN0aW9uVHlwZSA9ICciZnVuY3Rpb24iJzsKCiAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbCgne30nKTsKICAgICAgdmFyIGhlbHBlciA9IHRoaXMuc2V0dXBIZWxwZXIoMCwgbmFtZSk7CgogICAgICB2YXIgaGVscGVyTmFtZSA9IHRoaXMubGFzdEhlbHBlciA9IHRoaXMubmFtZUxvb2t1cCgnaGVscGVycycsIG5hbWUsICdoZWxwZXInKTsKICAgICAgdGhpcy5yZWdpc3RlcignZm91bmRIZWxwZXInLCBoZWxwZXJOYW1lKTsKCiAgICAgIHZhciBub25IZWxwZXIgPSB0aGlzLm5hbWVMb29rdXAoJ2RlcHRoJyArIHRoaXMubGFzdENvbnRleHQsIG5hbWUsICdjb250ZXh0Jyk7CiAgICAgIHZhciBuZXh0U3RhY2sgPSB0aGlzLm5leHRTdGFjaygpOwoKICAgICAgdGhpcy5zb3VyY2UucHVzaCgnaWYgKGZvdW5kSGVscGVyKSB7ICcgKyBuZXh0U3RhY2sgKyAnID0gZm91bmRIZWxwZXIuY2FsbCgnICsgaGVscGVyLmNhbGxQYXJhbXMgKyAnKTsgfScpOwogICAgICB0aGlzLnNvdXJjZS5wdXNoKCdlbHNlIHsgJyArIG5leHRTdGFjayArICcgPSAnICsgbm9uSGVscGVyICsgJzsgJyArIG5leHRTdGFjayArICcgPSB0eXBlb2YgJyArIG5leHRTdGFjayArICcgPT09IGZ1bmN0aW9uVHlwZSA/ICcgKyBuZXh0U3RhY2sgKyAnKCkgOiAnICsgbmV4dFN0YWNrICsgJzsgfScpOwogICAgfSwKCiAgICAvLyBbaW52b2tlUGFydGlhbF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBjb250ZXh0LCAuLi4KICAgIC8vIE9uIHN0YWNrIGFmdGVyOiByZXN1bHQgb2YgcGFydGlhbCBpbnZvY2F0aW9uCiAgICAvLwogICAgLy8gVGhpcyBvcGVyYXRpb24gcG9wcyBvZmYgYSBjb250ZXh0LCBpbnZva2VzIGEgcGFydGlhbCB3aXRoIHRoYXQgY29udGV4dCwKICAgIC8vIGFuZCBwdXNoZXMgdGhlIHJlc3VsdCBvZiB0aGUgaW52b2NhdGlvbiBiYWNrLgogICAgaW52b2tlUGFydGlhbDogZnVuY3Rpb24obmFtZSkgewogICAgICB2YXIgcGFyYW1zID0gW3RoaXMubmFtZUxvb2t1cCgncGFydGlhbHMnLCBuYW1lLCAncGFydGlhbCcpLCAiJyIgKyBuYW1lICsgIiciLCB0aGlzLnBvcFN0YWNrKCksICJoZWxwZXJzIiwgInBhcnRpYWxzIl07CgogICAgICBpZiAodGhpcy5vcHRpb25zLmRhdGEpIHsKICAgICAgICBwYXJhbXMucHVzaCgiZGF0YSIpOwogICAgICB9CgogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5zZWxmID0gInRoaXMiOwogICAgICB0aGlzLnB1c2hTdGFjaygic2VsZi5pbnZva2VQYXJ0aWFsKCIgKyBwYXJhbXMuam9pbigiLCAiKSArICIpOyIpOwogICAgfSwKCiAgICAvLyBbYXNzaWduVG9IYXNoXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCBoYXNoLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogaGFzaCwgLi4uCiAgICAvLwogICAgLy8gUG9wcyBhIHZhbHVlIGFuZCBoYXNoIG9mZiB0aGUgc3RhY2ssIGFzc2lnbnMgYGhhc2hba2V5XSA9IHZhbHVlYAogICAgLy8gYW5kIHB1c2hlcyB0aGUgaGFzaCBiYWNrIG9udG8gdGhlIHN0YWNrLgogICAgYXNzaWduVG9IYXNoOiBmdW5jdGlvbihrZXkpIHsKICAgICAgdmFyIHZhbHVlID0gdGhpcy5wb3BTdGFjaygpOwogICAgICB2YXIgaGFzaCA9IHRoaXMudG9wU3RhY2soKTsKCiAgICAgIHRoaXMuc291cmNlLnB1c2goaGFzaCArICJbJyIgKyBrZXkgKyAiJ10gPSAiICsgdmFsdWUgKyAiOyIpOwogICAgfSwKCiAgICAvLyBIRUxQRVJTCgogICAgY29tcGlsZXI6IEphdmFTY3JpcHRDb21waWxlciwKCiAgICBjb21waWxlQ2hpbGRyZW46IGZ1bmN0aW9uKGVudmlyb25tZW50LCBvcHRpb25zKSB7CiAgICAgIHZhciBjaGlsZHJlbiA9IGVudmlyb25tZW50LmNoaWxkcmVuLCBjaGlsZCwgY29tcGlsZXI7CgogICAgICBmb3IodmFyIGk9MCwgbD1jaGlsZHJlbi5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgY2hpbGQgPSBjaGlsZHJlbltpXTsKICAgICAgICBjb21waWxlciA9IG5ldyB0aGlzLmNvbXBpbGVyKCk7CgogICAgICAgIHRoaXMuY29udGV4dC5wcm9ncmFtcy5wdXNoKCcnKTsgICAgIC8vIFBsYWNlaG9sZGVyIHRvIHByZXZlbnQgbmFtZSBjb25mbGljdHMgZm9yIG5lc3RlZCBjaGlsZHJlbgogICAgICAgIHZhciBpbmRleCA9IHRoaXMuY29udGV4dC5wcm9ncmFtcy5sZW5ndGg7CiAgICAgICAgY2hpbGQuaW5kZXggPSBpbmRleDsKICAgICAgICBjaGlsZC5uYW1lID0gJ3Byb2dyYW0nICsgaW5kZXg7CiAgICAgICAgdGhpcy5jb250ZXh0LnByb2dyYW1zW2luZGV4XSA9IGNvbXBpbGVyLmNvbXBpbGUoY2hpbGQsIG9wdGlvbnMsIHRoaXMuY29udGV4dCk7CiAgICAgIH0KICAgIH0sCgogICAgcHJvZ3JhbUV4cHJlc3Npb246IGZ1bmN0aW9uKGd1aWQpIHsKICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuc2VsZiA9ICJ0aGlzIjsKCiAgICAgIGlmKGd1aWQgPT0gbnVsbCkgewogICAgICAgIHJldHVybiAic2VsZi5ub29wIjsKICAgICAgfQoKICAgICAgdmFyIGNoaWxkID0gdGhpcy5lbnZpcm9ubWVudC5jaGlsZHJlbltndWlkXSwKICAgICAgICAgIGRlcHRocyA9IGNoaWxkLmRlcHRocy5saXN0LCBkZXB0aDsKCiAgICAgIHZhciBwcm9ncmFtUGFyYW1zID0gW2NoaWxkLmluZGV4LCBjaGlsZC5uYW1lLCAiZGF0YSJdOwoKICAgICAgZm9yKHZhciBpPTAsIGwgPSBkZXB0aHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIGRlcHRoID0gZGVwdGhzW2ldOwoKICAgICAgICBpZihkZXB0aCA9PT0gMSkgeyBwcm9ncmFtUGFyYW1zLnB1c2goImRlcHRoMCIpOyB9CiAgICAgICAgZWxzZSB7IHByb2dyYW1QYXJhbXMucHVzaCgiZGVwdGgiICsgKGRlcHRoIC0gMSkpOyB9CiAgICAgIH0KCiAgICAgIGlmKGRlcHRocy5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gInNlbGYucHJvZ3JhbSgiICsgcHJvZ3JhbVBhcmFtcy5qb2luKCIsICIpICsgIikiOwogICAgICB9IGVsc2UgewogICAgICAgIHByb2dyYW1QYXJhbXMuc2hpZnQoKTsKICAgICAgICByZXR1cm4gInNlbGYucHJvZ3JhbVdpdGhEZXB0aCgiICsgcHJvZ3JhbVBhcmFtcy5qb2luKCIsICIpICsgIikiOwogICAgICB9CiAgICB9LAoKICAgIHJlZ2lzdGVyOiBmdW5jdGlvbihuYW1lLCB2YWwpIHsKICAgICAgdGhpcy51c2VSZWdpc3RlcihuYW1lKTsKICAgICAgdGhpcy5zb3VyY2UucHVzaChuYW1lICsgIiA9ICIgKyB2YWwgKyAiOyIpOwogICAgfSwKCiAgICB1c2VSZWdpc3RlcjogZnVuY3Rpb24obmFtZSkgewogICAgICBpZighdGhpcy5yZWdpc3RlcnNbbmFtZV0pIHsKICAgICAgICB0aGlzLnJlZ2lzdGVyc1tuYW1lXSA9IHRydWU7CiAgICAgICAgdGhpcy5yZWdpc3RlcnMubGlzdC5wdXNoKG5hbWUpOwogICAgICB9CiAgICB9LAoKICAgIHB1c2hTdGFja0xpdGVyYWw6IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgdGhpcy5jb21waWxlU3RhY2sucHVzaChuZXcgTGl0ZXJhbChpdGVtKSk7CiAgICAgIHJldHVybiBpdGVtOwogICAgfSwKCiAgICBwdXNoU3RhY2s6IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgdGhpcy5zb3VyY2UucHVzaCh0aGlzLmluY3JTdGFjaygpICsgIiA9ICIgKyBpdGVtICsgIjsiKTsKICAgICAgdGhpcy5jb21waWxlU3RhY2sucHVzaCgic3RhY2siICsgdGhpcy5zdGFja1Nsb3QpOwogICAgICByZXR1cm4gInN0YWNrIiArIHRoaXMuc3RhY2tTbG90OwogICAgfSwKCiAgICByZXBsYWNlU3RhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgIHZhciBpdGVtID0gY2FsbGJhY2suY2FsbCh0aGlzLCB0aGlzLnRvcFN0YWNrKCkpOwoKICAgICAgdGhpcy5zb3VyY2UucHVzaCh0aGlzLnRvcFN0YWNrKCkgKyAiID0gIiArIGl0ZW0gKyAiOyIpOwogICAgICByZXR1cm4gInN0YWNrIiArIHRoaXMuc3RhY2tTbG90OwogICAgfSwKCiAgICBuZXh0U3RhY2s6IGZ1bmN0aW9uKHNraXBDb21waWxlU3RhY2spIHsKICAgICAgdmFyIG5hbWUgPSB0aGlzLmluY3JTdGFjaygpOwogICAgICB0aGlzLmNvbXBpbGVTdGFjay5wdXNoKCJzdGFjayIgKyB0aGlzLnN0YWNrU2xvdCk7CiAgICAgIHJldHVybiBuYW1lOwogICAgfSwKCiAgICBpbmNyU3RhY2s6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnN0YWNrU2xvdCsrOwogICAgICBpZih0aGlzLnN0YWNrU2xvdCA+IHRoaXMuc3RhY2tWYXJzLmxlbmd0aCkgeyB0aGlzLnN0YWNrVmFycy5wdXNoKCJzdGFjayIgKyB0aGlzLnN0YWNrU2xvdCk7IH0KICAgICAgcmV0dXJuICJzdGFjayIgKyB0aGlzLnN0YWNrU2xvdDsKICAgIH0sCgogICAgcG9wU3RhY2s6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgaXRlbSA9IHRoaXMuY29tcGlsZVN0YWNrLnBvcCgpOwoKICAgICAgaWYgKGl0ZW0gaW5zdGFuY2VvZiBMaXRlcmFsKSB7CiAgICAgICAgcmV0dXJuIGl0ZW0udmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zdGFja1Nsb3QtLTsKICAgICAgICByZXR1cm4gaXRlbTsKICAgICAgfQogICAgfSwKCiAgICB0b3BTdGFjazogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpdGVtID0gdGhpcy5jb21waWxlU3RhY2tbdGhpcy5jb21waWxlU3RhY2subGVuZ3RoIC0gMV07CgogICAgICBpZiAoaXRlbSBpbnN0YW5jZW9mIExpdGVyYWwpIHsKICAgICAgICByZXR1cm4gaXRlbS52YWx1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gaXRlbTsKICAgICAgfQogICAgfSwKCiAgICBxdW90ZWRTdHJpbmc6IGZ1bmN0aW9uKHN0cikgewogICAgICByZXR1cm4gJyInICsgc3RyCiAgICAgICAgLnJlcGxhY2UoL1xcL2csICdcXFxcJykKICAgICAgICAucmVwbGFjZSgvIi9nLCAnXFwiJykKICAgICAgICAucmVwbGFjZSgvXG4vZywgJ1xcbicpCiAgICAgICAgLnJlcGxhY2UoL1xyL2csICdcXHInKSArICciJzsKICAgIH0sCgogICAgc2V0dXBIZWxwZXI6IGZ1bmN0aW9uKHBhcmFtU2l6ZSwgbmFtZSkgewogICAgICB2YXIgcGFyYW1zID0gW107CiAgICAgIHRoaXMuc2V0dXBQYXJhbXMocGFyYW1TaXplLCBwYXJhbXMpOwogICAgICB2YXIgZm91bmRIZWxwZXIgPSB0aGlzLm5hbWVMb29rdXAoJ2hlbHBlcnMnLCBuYW1lLCAnaGVscGVyJyk7CgogICAgICByZXR1cm4gewogICAgICAgIHBhcmFtczogcGFyYW1zLAogICAgICAgIG5hbWU6IGZvdW5kSGVscGVyLAogICAgICAgIGNhbGxQYXJhbXM6IFsiZGVwdGgwIl0uY29uY2F0KHBhcmFtcykuam9pbigiLCAiKSwKICAgICAgICBoZWxwZXJNaXNzaW5nUGFyYW1zOiBbImRlcHRoMCIsIHRoaXMucXVvdGVkU3RyaW5nKG5hbWUpXS5jb25jYXQocGFyYW1zKS5qb2luKCIsICIpCiAgICAgIH07CiAgICB9LAoKICAgIC8vIHRoZSBwYXJhbXMgYW5kIGNvbnRleHRzIGFyZ3VtZW50cyBhcmUgcGFzc2VkIGluIGFycmF5cwogICAgLy8gdG8gZmlsbCBpbgogICAgc2V0dXBQYXJhbXM6IGZ1bmN0aW9uKHBhcmFtU2l6ZSwgcGFyYW1zKSB7CiAgICAgIHZhciBvcHRpb25zID0gW10sIGNvbnRleHRzID0gW10sIHBhcmFtLCBpbnZlcnNlLCBwcm9ncmFtOwoKICAgICAgb3B0aW9ucy5wdXNoKCJoYXNoOiIgKyB0aGlzLnBvcFN0YWNrKCkpOwoKICAgICAgaW52ZXJzZSA9IHRoaXMucG9wU3RhY2soKTsKICAgICAgcHJvZ3JhbSA9IHRoaXMucG9wU3RhY2soKTsKCiAgICAgIC8vIEF2b2lkIHNldHRpbmcgZm4gYW5kIGludmVyc2UgaWYgbmVpdGhlciBhcmUgc2V0LiBUaGlzIGFsbG93cwogICAgICAvLyBoZWxwZXJzIHRvIGRvIGEgY2hlY2sgZm9yIGBpZiAob3B0aW9ucy5mbilgCiAgICAgIGlmIChwcm9ncmFtIHx8IGludmVyc2UpIHsKICAgICAgICBpZiAoIXByb2dyYW0pIHsKICAgICAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLnNlbGYgPSAidGhpcyI7CiAgICAgICAgICBwcm9ncmFtID0gInNlbGYubm9vcCI7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWludmVyc2UpIHsKICAgICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuc2VsZiA9ICJ0aGlzIjsKICAgICAgICAgIGludmVyc2UgPSAic2VsZi5ub29wIjsKICAgICAgICB9CgogICAgICAgIG9wdGlvbnMucHVzaCgiaW52ZXJzZToiICsgaW52ZXJzZSk7CiAgICAgICAgb3B0aW9ucy5wdXNoKCJmbjoiICsgcHJvZ3JhbSk7CiAgICAgIH0KCiAgICAgIGZvcih2YXIgaT0wOyBpPHBhcmFtU2l6ZTsgaSsrKSB7CiAgICAgICAgcGFyYW0gPSB0aGlzLnBvcFN0YWNrKCk7CiAgICAgICAgcGFyYW1zLnB1c2gocGFyYW0pOwoKICAgICAgICBpZih0aGlzLm9wdGlvbnMuc3RyaW5nUGFyYW1zKSB7CiAgICAgICAgICBjb250ZXh0cy5wdXNoKHRoaXMucG9wU3RhY2soKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5vcHRpb25zLnN0cmluZ1BhcmFtcykgewogICAgICAgIG9wdGlvbnMucHVzaCgiY29udGV4dHM6WyIgKyBjb250ZXh0cy5qb2luKCIsIikgKyAiXSIpOwogICAgICB9CgogICAgICBpZih0aGlzLm9wdGlvbnMuZGF0YSkgewogICAgICAgIG9wdGlvbnMucHVzaCgiZGF0YTpkYXRhIik7CiAgICAgIH0KCiAgICAgIHBhcmFtcy5wdXNoKCJ7IiArIG9wdGlvbnMuam9pbigiLCIpICsgIn0iKTsKICAgICAgcmV0dXJuIHBhcmFtcy5qb2luKCIsICIpOwogICAgfQogIH07CgogIHZhciByZXNlcnZlZFdvcmRzID0gKAogICAgImJyZWFrIGVsc2UgbmV3IHZhciIgKwogICAgIiBjYXNlIGZpbmFsbHkgcmV0dXJuIHZvaWQiICsKICAgICIgY2F0Y2ggZm9yIHN3aXRjaCB3aGlsZSIgKwogICAgIiBjb250aW51ZSBmdW5jdGlvbiB0aGlzIHdpdGgiICsKICAgICIgZGVmYXVsdCBpZiB0aHJvdyIgKwogICAgIiBkZWxldGUgaW4gdHJ5IiArCiAgICAiIGRvIGluc3RhbmNlb2YgdHlwZW9mIiArCiAgICAiIGFic3RyYWN0IGVudW0gaW50IHNob3J0IiArCiAgICAiIGJvb2xlYW4gZXhwb3J0IGludGVyZmFjZSBzdGF0aWMiICsKICAgICIgYnl0ZSBleHRlbmRzIGxvbmcgc3VwZXIiICsKICAgICIgY2hhciBmaW5hbCBuYXRpdmUgc3luY2hyb25pemVkIiArCiAgICAiIGNsYXNzIGZsb2F0IHBhY2thZ2UgdGhyb3dzIiArCiAgICAiIGNvbnN0IGdvdG8gcHJpdmF0ZSB0cmFuc2llbnQiICsKICAgICIgZGVidWdnZXIgaW1wbGVtZW50cyBwcm90ZWN0ZWQgdm9sYXRpbGUiICsKICAgICIgZG91YmxlIGltcG9ydCBwdWJsaWMgbGV0IHlpZWxkIgogICkuc3BsaXQoIiAiKTsKCiAgdmFyIGNvbXBpbGVyV29yZHMgPSBKYXZhU2NyaXB0Q29tcGlsZXIuUkVTRVJWRURfV09SRFMgPSB7fTsKCiAgZm9yKHZhciBpPTAsIGw9cmVzZXJ2ZWRXb3Jkcy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICBjb21waWxlcldvcmRzW3Jlc2VydmVkV29yZHNbaV1dID0gdHJ1ZTsKICB9CgogIEphdmFTY3JpcHRDb21waWxlci5pc1ZhbGlkSmF2YVNjcmlwdFZhcmlhYmxlTmFtZSA9IGZ1bmN0aW9uKG5hbWUpIHsKICAgIGlmKCFKYXZhU2NyaXB0Q29tcGlsZXIuUkVTRVJWRURfV09SRFNbbmFtZV0gJiYgL15bYS16QS1aXyRdWzAtOWEtekEtWl8kXSskLy50ZXN0KG5hbWUpKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH07Cgp9KShIYW5kbGViYXJzLkNvbXBpbGVyLCBIYW5kbGViYXJzLkphdmFTY3JpcHRDb21waWxlcik7CgpIYW5kbGViYXJzLnByZWNvbXBpbGUgPSBmdW5jdGlvbihzdHJpbmcsIG9wdGlvbnMpIHsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgdmFyIGFzdCA9IEhhbmRsZWJhcnMucGFyc2Uoc3RyaW5nKTsKICB2YXIgZW52aXJvbm1lbnQgPSBuZXcgSGFuZGxlYmFycy5Db21waWxlcigpLmNvbXBpbGUoYXN0LCBvcHRpb25zKTsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuSmF2YVNjcmlwdENvbXBpbGVyKCkuY29tcGlsZShlbnZpcm9ubWVudCwgb3B0aW9ucyk7Cn07CgpIYW5kbGViYXJzLmNvbXBpbGUgPSBmdW5jdGlvbihzdHJpbmcsIG9wdGlvbnMpIHsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgdmFyIGNvbXBpbGVkOwogIGZ1bmN0aW9uIGNvbXBpbGUoKSB7CiAgICB2YXIgYXN0ID0gSGFuZGxlYmFycy5wYXJzZShzdHJpbmcpOwogICAgdmFyIGVudmlyb25tZW50ID0gbmV3IEhhbmRsZWJhcnMuQ29tcGlsZXIoKS5jb21waWxlKGFzdCwgb3B0aW9ucyk7CiAgICB2YXIgdGVtcGxhdGVTcGVjID0gbmV3IEhhbmRsZWJhcnMuSmF2YVNjcmlwdENvbXBpbGVyKCkuY29tcGlsZShlbnZpcm9ubWVudCwgb3B0aW9ucywgdW5kZWZpbmVkLCB0cnVlKTsKICAgIHJldHVybiBIYW5kbGViYXJzLnRlbXBsYXRlKHRlbXBsYXRlU3BlYyk7CiAgfQoKICAvLyBUZW1wbGF0ZSBpcyBvbmx5IGNvbXBpbGVkIG9uIGZpcnN0IHVzZSBhbmQgY2FjaGVkIGFmdGVyIHRoYXQgcG9pbnQuCiAgcmV0dXJuIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICAgIGlmICghY29tcGlsZWQpIHsKICAgICAgY29tcGlsZWQgPSBjb21waWxlKCk7CiAgICB9CiAgICByZXR1cm4gY29tcGlsZWQuY2FsbCh0aGlzLCBjb250ZXh0LCBvcHRpb25zKTsKICB9Owp9Owo7Ci8vIGxpYi9oYW5kbGViYXJzL3J1bnRpbWUuanMKSGFuZGxlYmFycy5WTSA9IHsKICB0ZW1wbGF0ZTogZnVuY3Rpb24odGVtcGxhdGVTcGVjKSB7CiAgICAvLyBKdXN0IGFkZCB3YXRlcgogICAgdmFyIGNvbnRhaW5lciA9IHsKICAgICAgZXNjYXBlRXhwcmVzc2lvbjogSGFuZGxlYmFycy5VdGlscy5lc2NhcGVFeHByZXNzaW9uLAogICAgICBpbnZva2VQYXJ0aWFsOiBIYW5kbGViYXJzLlZNLmludm9rZVBhcnRpYWwsCiAgICAgIHByb2dyYW1zOiBbXSwKICAgICAgcHJvZ3JhbTogZnVuY3Rpb24oaSwgZm4sIGRhdGEpIHsKICAgICAgICB2YXIgcHJvZ3JhbVdyYXBwZXIgPSB0aGlzLnByb2dyYW1zW2ldOwogICAgICAgIGlmKGRhdGEpIHsKICAgICAgICAgIHByb2dyYW1XcmFwcGVyID0gSGFuZGxlYmFycy5WTS5wcm9ncmFtKGZuLCBkYXRhKTsKICAgICAgICAgIHByb2dyYW1XcmFwcGVyLnByb2dyYW0gPSBpOwogICAgICAgIH0gZWxzZSBpZiAoIXByb2dyYW1XcmFwcGVyKSB7CiAgICAgICAgICBwcm9ncmFtV3JhcHBlciA9IHRoaXMucHJvZ3JhbXNbaV0gPSBIYW5kbGViYXJzLlZNLnByb2dyYW0oZm4pOwogICAgICAgICAgcHJvZ3JhbVdyYXBwZXIucHJvZ3JhbSA9IGk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwcm9ncmFtV3JhcHBlcjsKICAgICAgfSwKICAgICAgcHJvZ3JhbVdpdGhEZXB0aDogSGFuZGxlYmFycy5WTS5wcm9ncmFtV2l0aERlcHRoLAogICAgICBub29wOiBIYW5kbGViYXJzLlZNLm5vb3AKICAgIH07CgogICAgcmV0dXJuIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHJldHVybiB0ZW1wbGF0ZVNwZWMuY2FsbChjb250YWluZXIsIEhhbmRsZWJhcnMsIGNvbnRleHQsIG9wdGlvbnMuaGVscGVycywgb3B0aW9ucy5wYXJ0aWFscywgb3B0aW9ucy5kYXRhKTsKICAgIH07CiAgfSwKCiAgcHJvZ3JhbVdpdGhEZXB0aDogZnVuY3Rpb24oZm4sIGRhdGEsICRkZXB0aCkgewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwoKICAgIHJldHVybiBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIFtjb250ZXh0LCBvcHRpb25zLmRhdGEgfHwgZGF0YV0uY29uY2F0KGFyZ3MpKTsKICAgIH07CiAgfSwKICBwcm9ncmFtOiBmdW5jdGlvbihmbiwgZGF0YSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgICByZXR1cm4gZm4oY29udGV4dCwgb3B0aW9ucy5kYXRhIHx8IGRhdGEpOwogICAgfTsKICB9LAogIG5vb3A6IGZ1bmN0aW9uKCkgeyByZXR1cm4gIiI7IH0sCiAgaW52b2tlUGFydGlhbDogZnVuY3Rpb24ocGFydGlhbCwgbmFtZSwgY29udGV4dCwgaGVscGVycywgcGFydGlhbHMsIGRhdGEpIHsKICAgIHZhciBvcHRpb25zID0geyBoZWxwZXJzOiBoZWxwZXJzLCBwYXJ0aWFsczogcGFydGlhbHMsIGRhdGE6IGRhdGEgfTsKCiAgICBpZihwYXJ0aWFsID09PSB1bmRlZmluZWQpIHsKICAgICAgdGhyb3cgbmV3IEhhbmRsZWJhcnMuRXhjZXB0aW9uKCJUaGUgcGFydGlhbCAiICsgbmFtZSArICIgY291bGQgbm90IGJlIGZvdW5kIik7CiAgICB9IGVsc2UgaWYocGFydGlhbCBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7CiAgICAgIHJldHVybiBwYXJ0aWFsKGNvbnRleHQsIG9wdGlvbnMpOwogICAgfSBlbHNlIGlmICghSGFuZGxlYmFycy5jb21waWxlKSB7CiAgICAgIHRocm93IG5ldyBIYW5kbGViYXJzLkV4Y2VwdGlvbigiVGhlIHBhcnRpYWwgIiArIG5hbWUgKyAiIGNvdWxkIG5vdCBiZSBjb21waWxlZCB3aGVuIHJ1bm5pbmcgaW4gcnVudGltZS1vbmx5IG1vZGUiKTsKICAgIH0gZWxzZSB7CiAgICAgIHBhcnRpYWxzW25hbWVdID0gSGFuZGxlYmFycy5jb21waWxlKHBhcnRpYWwsIHtkYXRhOiBkYXRhICE9PSB1bmRlZmluZWR9KTsKICAgICAgcmV0dXJuIHBhcnRpYWxzW25hbWVdKGNvbnRleHQsIG9wdGlvbnMpOwogICAgfQogIH0KfTsKCkhhbmRsZWJhcnMudGVtcGxhdGUgPSBIYW5kbGViYXJzLlZNLnRlbXBsYXRlOwo7CgovLyAgICAgVW5kZXJzY29yZS5qcyAxLjQuMgovLyAgICAgaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcKLy8gICAgIChjKSAyMDA5LTIwMTIgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIEluYy4KLy8gICAgIFVuZGVyc2NvcmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCgooZnVuY3Rpb24oKSB7CgogIC8vIEJhc2VsaW5lIHNldHVwCiAgLy8gLS0tLS0tLS0tLS0tLS0KCiAgLy8gRXN0YWJsaXNoIHRoZSByb290IG9iamVjdCwgYHdpbmRvd2AgaW4gdGhlIGJyb3dzZXIsIG9yIGBnbG9iYWxgIG9uIHRoZSBzZXJ2ZXIuCiAgdmFyIHJvb3QgPSB0aGlzOwoKICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYF9gIHZhcmlhYmxlLgogIHZhciBwcmV2aW91c1VuZGVyc2NvcmUgPSByb290Ll87CgogIC8vIEVzdGFibGlzaCB0aGUgb2JqZWN0IHRoYXQgZ2V0cyByZXR1cm5lZCB0byBicmVhayBvdXQgb2YgYSBsb29wIGl0ZXJhdGlvbi4KICB2YXIgYnJlYWtlciA9IHt9OwoKICAvLyBTYXZlIGJ5dGVzIGluIHRoZSBtaW5pZmllZCAoYnV0IG5vdCBnemlwcGVkKSB2ZXJzaW9uOgogIHZhciBBcnJheVByb3RvID0gQXJyYXkucHJvdG90eXBlLCBPYmpQcm90byA9IE9iamVjdC5wcm90b3R5cGUsIEZ1bmNQcm90byA9IEZ1bmN0aW9uLnByb3RvdHlwZTsKCiAgLy8gQ3JlYXRlIHF1aWNrIHJlZmVyZW5jZSB2YXJpYWJsZXMgZm9yIHNwZWVkIGFjY2VzcyB0byBjb3JlIHByb3RvdHlwZXMuCiAgdmFyIHB1c2ggICAgICAgICAgICAgPSBBcnJheVByb3RvLnB1c2gsCiAgICAgIHNsaWNlICAgICAgICAgICAgPSBBcnJheVByb3RvLnNsaWNlLAogICAgICBjb25jYXQgICAgICAgICAgID0gQXJyYXlQcm90by5jb25jYXQsCiAgICAgIHVuc2hpZnQgICAgICAgICAgPSBBcnJheVByb3RvLnVuc2hpZnQsCiAgICAgIHRvU3RyaW5nICAgICAgICAgPSBPYmpQcm90by50b1N0cmluZywKICAgICAgaGFzT3duUHJvcGVydHkgICA9IE9ialByb3RvLmhhc093blByb3BlcnR5OwoKICAvLyBBbGwgKipFQ01BU2NyaXB0IDUqKiBuYXRpdmUgZnVuY3Rpb24gaW1wbGVtZW50YXRpb25zIHRoYXQgd2UgaG9wZSB0byB1c2UKICAvLyBhcmUgZGVjbGFyZWQgaGVyZS4KICB2YXIKICAgIG5hdGl2ZUZvckVhY2ggICAgICA9IEFycmF5UHJvdG8uZm9yRWFjaCwKICAgIG5hdGl2ZU1hcCAgICAgICAgICA9IEFycmF5UHJvdG8ubWFwLAogICAgbmF0aXZlUmVkdWNlICAgICAgID0gQXJyYXlQcm90by5yZWR1Y2UsCiAgICBuYXRpdmVSZWR1Y2VSaWdodCAgPSBBcnJheVByb3RvLnJlZHVjZVJpZ2h0LAogICAgbmF0aXZlRmlsdGVyICAgICAgID0gQXJyYXlQcm90by5maWx0ZXIsCiAgICBuYXRpdmVFdmVyeSAgICAgICAgPSBBcnJheVByb3RvLmV2ZXJ5LAogICAgbmF0aXZlU29tZSAgICAgICAgID0gQXJyYXlQcm90by5zb21lLAogICAgbmF0aXZlSW5kZXhPZiAgICAgID0gQXJyYXlQcm90by5pbmRleE9mLAogICAgbmF0aXZlTGFzdEluZGV4T2YgID0gQXJyYXlQcm90by5sYXN0SW5kZXhPZiwKICAgIG5hdGl2ZUlzQXJyYXkgICAgICA9IEFycmF5LmlzQXJyYXksCiAgICBuYXRpdmVLZXlzICAgICAgICAgPSBPYmplY3Qua2V5cywKICAgIG5hdGl2ZUJpbmQgICAgICAgICA9IEZ1bmNQcm90by5iaW5kOwoKICAvLyBDcmVhdGUgYSBzYWZlIHJlZmVyZW5jZSB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QgZm9yIHVzZSBiZWxvdy4KICB2YXIgXyA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKG9iaiBpbnN0YW5jZW9mIF8pIHJldHVybiBvYmo7CiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgXykpIHJldHVybiBuZXcgXyhvYmopOwogICAgdGhpcy5fd3JhcHBlZCA9IG9iajsKICB9OwoKICAvLyBFeHBvcnQgdGhlIFVuZGVyc2NvcmUgb2JqZWN0IGZvciAqKk5vZGUuanMqKiwgd2l0aAogIC8vIGJhY2t3YXJkcy1jb21wYXRpYmlsaXR5IGZvciB0aGUgb2xkIGByZXF1aXJlKClgIEFQSS4gSWYgd2UncmUgaW4KICAvLyB0aGUgYnJvd3NlciwgYWRkIGBfYCBhcyBhIGdsb2JhbCBvYmplY3QgdmlhIGEgc3RyaW5nIGlkZW50aWZpZXIsCiAgLy8gZm9yIENsb3N1cmUgQ29tcGlsZXIgImFkdmFuY2VkIiBtb2RlLgogIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIGlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyAmJiBtb2R1bGUuZXhwb3J0cykgewogICAgICBleHBvcnRzID0gbW9kdWxlLmV4cG9ydHMgPSBfOwogICAgfQogICAgZXhwb3J0cy5fID0gXzsKICB9IGVsc2UgewogICAgcm9vdFsnXyddID0gXzsKICB9CgogIC8vIEN1cnJlbnQgdmVyc2lvbi4KICBfLlZFUlNJT04gPSAnMS40LjInOwoKICAvLyBDb2xsZWN0aW9uIEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFRoZSBjb3JuZXJzdG9uZSwgYW4gYGVhY2hgIGltcGxlbWVudGF0aW9uLCBha2EgYGZvckVhY2hgLgogIC8vIEhhbmRsZXMgb2JqZWN0cyB3aXRoIHRoZSBidWlsdC1pbiBgZm9yRWFjaGAsIGFycmF5cywgYW5kIHJhdyBvYmplY3RzLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBmb3JFYWNoYCBpZiBhdmFpbGFibGUuCiAgdmFyIGVhY2ggPSBfLmVhY2ggPSBfLmZvckVhY2ggPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybjsKICAgIGlmIChuYXRpdmVGb3JFYWNoICYmIG9iai5mb3JFYWNoID09PSBuYXRpdmVGb3JFYWNoKSB7CiAgICAgIG9iai5mb3JFYWNoKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH0gZWxzZSBpZiAob2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGgpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBvYmoubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgaWYgKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2ldLCBpLCBvYmopID09PSBicmVha2VyKSByZXR1cm47CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICBpZiAoXy5oYXMob2JqLCBrZXkpKSB7CiAgICAgICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5LCBvYmopID09PSBicmVha2VyKSByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSByZXN1bHRzIG9mIGFwcGx5aW5nIHRoZSBpdGVyYXRvciB0byBlYWNoIGVsZW1lbnQuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYG1hcGAgaWYgYXZhaWxhYmxlLgogIF8ubWFwID0gXy5jb2xsZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHJlc3VsdHM7CiAgICBpZiAobmF0aXZlTWFwICYmIG9iai5tYXAgPT09IG5hdGl2ZU1hcCkgcmV0dXJuIG9iai5tYXAoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICByZXN1bHRzW3Jlc3VsdHMubGVuZ3RoXSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKCiAgLy8gKipSZWR1Y2UqKiBidWlsZHMgdXAgYSBzaW5nbGUgcmVzdWx0IGZyb20gYSBsaXN0IG9mIHZhbHVlcywgYWthIGBpbmplY3RgLAogIC8vIG9yIGBmb2xkbGAuIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGByZWR1Y2VgIGlmIGF2YWlsYWJsZS4KICBfLnJlZHVjZSA9IF8uZm9sZGwgPSBfLmluamVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIG1lbW8sIGNvbnRleHQpIHsKICAgIHZhciBpbml0aWFsID0gYXJndW1lbnRzLmxlbmd0aCA+IDI7CiAgICBpZiAob2JqID09IG51bGwpIG9iaiA9IFtdOwogICAgaWYgKG5hdGl2ZVJlZHVjZSAmJiBvYmoucmVkdWNlID09PSBuYXRpdmVSZWR1Y2UpIHsKICAgICAgaWYgKGNvbnRleHQpIGl0ZXJhdG9yID0gXy5iaW5kKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgICAgcmV0dXJuIGluaXRpYWwgPyBvYmoucmVkdWNlKGl0ZXJhdG9yLCBtZW1vKSA6IG9iai5yZWR1Y2UoaXRlcmF0b3IpOwogICAgfQogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoIWluaXRpYWwpIHsKICAgICAgICBtZW1vID0gdmFsdWU7CiAgICAgICAgaW5pdGlhbCA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWVtbyA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgbWVtbywgdmFsdWUsIGluZGV4LCBsaXN0KTsKICAgICAgfQogICAgfSk7CiAgICBpZiAoIWluaXRpYWwpIHRocm93IG5ldyBUeXBlRXJyb3IoJ1JlZHVjZSBvZiBlbXB0eSBhcnJheSB3aXRoIG5vIGluaXRpYWwgdmFsdWUnKTsKICAgIHJldHVybiBtZW1vOwogIH07CgogIC8vIFRoZSByaWdodC1hc3NvY2lhdGl2ZSB2ZXJzaW9uIG9mIHJlZHVjZSwgYWxzbyBrbm93biBhcyBgZm9sZHJgLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGByZWR1Y2VSaWdodGAgaWYgYXZhaWxhYmxlLgogIF8ucmVkdWNlUmlnaHQgPSBfLmZvbGRyID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgbWVtbywgY29udGV4dCkgewogICAgdmFyIGluaXRpYWwgPSBhcmd1bWVudHMubGVuZ3RoID4gMjsKICAgIGlmIChvYmogPT0gbnVsbCkgb2JqID0gW107CiAgICBpZiAobmF0aXZlUmVkdWNlUmlnaHQgJiYgb2JqLnJlZHVjZVJpZ2h0ID09PSBuYXRpdmVSZWR1Y2VSaWdodCkgewogICAgICBpZiAoY29udGV4dCkgaXRlcmF0b3IgPSBfLmJpbmQoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA+IDIgPyBvYmoucmVkdWNlUmlnaHQoaXRlcmF0b3IsIG1lbW8pIDogb2JqLnJlZHVjZVJpZ2h0KGl0ZXJhdG9yKTsKICAgIH0KICAgIHZhciBsZW5ndGggPSBvYmoubGVuZ3RoOwogICAgaWYgKGxlbmd0aCAhPT0gK2xlbmd0aCkgewogICAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwogICAgICBsZW5ndGggPSBrZXlzLmxlbmd0aDsKICAgIH0KICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaW5kZXggPSBrZXlzID8ga2V5c1stLWxlbmd0aF0gOiAtLWxlbmd0aDsKICAgICAgaWYgKCFpbml0aWFsKSB7CiAgICAgICAgbWVtbyA9IG9ialtpbmRleF07CiAgICAgICAgaW5pdGlhbCA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWVtbyA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgbWVtbywgb2JqW2luZGV4XSwgaW5kZXgsIGxpc3QpOwogICAgICB9CiAgICB9KTsKICAgIGlmICghaW5pdGlhbCkgdGhyb3cgbmV3IFR5cGVFcnJvcignUmVkdWNlIG9mIGVtcHR5IGFycmF5IHdpdGggbm8gaW5pdGlhbCB2YWx1ZScpOwogICAgcmV0dXJuIG1lbW87CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBmaXJzdCB2YWx1ZSB3aGljaCBwYXNzZXMgYSB0cnV0aCB0ZXN0LiBBbGlhc2VkIGFzIGBkZXRlY3RgLgogIF8uZmluZCA9IF8uZGV0ZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdDsKICAgIGFueShvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSB7CiAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBSZXR1cm4gYWxsIHRoZSBlbGVtZW50cyB0aGF0IHBhc3MgYSB0cnV0aCB0ZXN0LgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBmaWx0ZXJgIGlmIGF2YWlsYWJsZS4KICAvLyBBbGlhc2VkIGFzIGBzZWxlY3RgLgogIF8uZmlsdGVyID0gXy5zZWxlY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0czsKICAgIGlmIChuYXRpdmVGaWx0ZXIgJiYgb2JqLmZpbHRlciA9PT0gbmF0aXZlRmlsdGVyKSByZXR1cm4gb2JqLmZpbHRlcihpdGVyYXRvciwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmIChpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpIHJlc3VsdHNbcmVzdWx0cy5sZW5ndGhdID0gdmFsdWU7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIGZvciB3aGljaCBhIHRydXRoIHRlc3QgZmFpbHMuCiAgXy5yZWplY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0czsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKCFpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpIHJlc3VsdHNbcmVzdWx0cy5sZW5ndGhdID0gdmFsdWU7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIERldGVybWluZSB3aGV0aGVyIGFsbCBvZiB0aGUgZWxlbWVudHMgbWF0Y2ggYSB0cnV0aCB0ZXN0LgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBldmVyeWAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYGFsbGAuCiAgXy5ldmVyeSA9IF8uYWxsID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgfHwgKGl0ZXJhdG9yID0gXy5pZGVudGl0eSk7CiAgICB2YXIgcmVzdWx0ID0gdHJ1ZTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHJlc3VsdDsKICAgIGlmIChuYXRpdmVFdmVyeSAmJiBvYmouZXZlcnkgPT09IG5hdGl2ZUV2ZXJ5KSByZXR1cm4gb2JqLmV2ZXJ5KGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKCEocmVzdWx0ID0gcmVzdWx0ICYmIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkpIHJldHVybiBicmVha2VyOwogICAgfSk7CiAgICByZXR1cm4gISFyZXN1bHQ7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIGlmIGF0IGxlYXN0IG9uZSBlbGVtZW50IGluIHRoZSBvYmplY3QgbWF0Y2hlcyBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYHNvbWVgIGlmIGF2YWlsYWJsZS4KICAvLyBBbGlhc2VkIGFzIGBhbnlgLgogIHZhciBhbnkgPSBfLnNvbWUgPSBfLmFueSA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGl0ZXJhdG9yIHx8IChpdGVyYXRvciA9IF8uaWRlbnRpdHkpOwogICAgdmFyIHJlc3VsdCA9IGZhbHNlOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0OwogICAgaWYgKG5hdGl2ZVNvbWUgJiYgb2JqLnNvbWUgPT09IG5hdGl2ZVNvbWUpIHJldHVybiBvYmouc29tZShpdGVyYXRvciwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmIChyZXN1bHQgfHwgKHJlc3VsdCA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkpIHJldHVybiBicmVha2VyOwogICAgfSk7CiAgICByZXR1cm4gISFyZXN1bHQ7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBhcnJheSBvciBvYmplY3QgY29udGFpbnMgYSBnaXZlbiB2YWx1ZSAodXNpbmcgYD09PWApLgogIC8vIEFsaWFzZWQgYXMgYGluY2x1ZGVgLgogIF8uY29udGFpbnMgPSBfLmluY2x1ZGUgPSBmdW5jdGlvbihvYmosIHRhcmdldCkgewogICAgdmFyIGZvdW5kID0gZmFsc2U7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiBmb3VuZDsKICAgIGlmIChuYXRpdmVJbmRleE9mICYmIG9iai5pbmRleE9mID09PSBuYXRpdmVJbmRleE9mKSByZXR1cm4gb2JqLmluZGV4T2YodGFyZ2V0KSAhPSAtMTsKICAgIGZvdW5kID0gYW55KG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSB0YXJnZXQ7CiAgICB9KTsKICAgIHJldHVybiBmb3VuZDsKICB9OwoKICAvLyBJbnZva2UgYSBtZXRob2QgKHdpdGggYXJndW1lbnRzKSBvbiBldmVyeSBpdGVtIGluIGEgY29sbGVjdGlvbi4KICBfLmludm9rZSA9IGZ1bmN0aW9uKG9iaiwgbWV0aG9kKSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHJldHVybiBfLm1hcChvYmosIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiAoXy5pc0Z1bmN0aW9uKG1ldGhvZCkgPyBtZXRob2QgOiB2YWx1ZVttZXRob2RdKS5hcHBseSh2YWx1ZSwgYXJncyk7CiAgICB9KTsKICB9OwoKICAvLyBDb252ZW5pZW5jZSB2ZXJzaW9uIG9mIGEgY29tbW9uIHVzZSBjYXNlIG9mIGBtYXBgOiBmZXRjaGluZyBhIHByb3BlcnR5LgogIF8ucGx1Y2sgPSBmdW5jdGlvbihvYmosIGtleSkgewogICAgcmV0dXJuIF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUpeyByZXR1cm4gdmFsdWVba2V5XTsgfSk7CiAgfTsKCiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgZmlsdGVyYDogc2VsZWN0aW5nIG9ubHkgb2JqZWN0cwogIC8vIHdpdGggc3BlY2lmaWMgYGtleTp2YWx1ZWAgcGFpcnMuCiAgXy53aGVyZSA9IGZ1bmN0aW9uKG9iaiwgYXR0cnMpIHsKICAgIGlmIChfLmlzRW1wdHkoYXR0cnMpKSByZXR1cm4gW107CiAgICByZXR1cm4gXy5maWx0ZXIob2JqLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICBmb3IgKHZhciBrZXkgaW4gYXR0cnMpIHsKICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gdmFsdWVba2V5XSkgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfSk7CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBtYXhpbXVtIGVsZW1lbnQgb3IgKGVsZW1lbnQtYmFzZWQgY29tcHV0YXRpb24pLgogIC8vIENhbid0IG9wdGltaXplIGFycmF5cyBvZiBpbnRlZ2VycyBsb25nZXIgdGhhbiA2NSw1MzUgZWxlbWVudHMuCiAgLy8gU2VlOiBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9ODA3OTcKICBfLm1heCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0FycmF5KG9iaikgJiYgb2JqWzBdID09PSArb2JqWzBdICYmIG9iai5sZW5ndGggPCA2NTUzNSkgewogICAgICByZXR1cm4gTWF0aC5tYXguYXBwbHkoTWF0aCwgb2JqKTsKICAgIH0KICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0VtcHR5KG9iaikpIHJldHVybiAtSW5maW5pdHk7CiAgICB2YXIgcmVzdWx0ID0ge2NvbXB1dGVkIDogLUluZmluaXR5fTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgdmFyIGNvbXB1dGVkID0gaXRlcmF0b3IgPyBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkgOiB2YWx1ZTsKICAgICAgY29tcHV0ZWQgPj0gcmVzdWx0LmNvbXB1dGVkICYmIChyZXN1bHQgPSB7dmFsdWUgOiB2YWx1ZSwgY29tcHV0ZWQgOiBjb21wdXRlZH0pOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0LnZhbHVlOwogIH07CgogIC8vIFJldHVybiB0aGUgbWluaW11bSBlbGVtZW50IChvciBlbGVtZW50LWJhc2VkIGNvbXB1dGF0aW9uKS4KICBfLm1pbiA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0FycmF5KG9iaikgJiYgb2JqWzBdID09PSArb2JqWzBdICYmIG9iai5sZW5ndGggPCA2NTUzNSkgewogICAgICByZXR1cm4gTWF0aC5taW4uYXBwbHkoTWF0aCwgb2JqKTsKICAgIH0KICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0VtcHR5KG9iaikpIHJldHVybiBJbmZpbml0eTsKICAgIHZhciByZXN1bHQgPSB7Y29tcHV0ZWQgOiBJbmZpbml0eX07CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHZhciBjb21wdXRlZCA9IGl0ZXJhdG9yID8gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpIDogdmFsdWU7CiAgICAgIGNvbXB1dGVkIDwgcmVzdWx0LmNvbXB1dGVkICYmIChyZXN1bHQgPSB7dmFsdWUgOiB2YWx1ZSwgY29tcHV0ZWQgOiBjb21wdXRlZH0pOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0LnZhbHVlOwogIH07CgogIC8vIFNodWZmbGUgYW4gYXJyYXkuCiAgXy5zaHVmZmxlID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgcmFuZDsKICAgIHZhciBpbmRleCA9IDA7CiAgICB2YXIgc2h1ZmZsZWQgPSBbXTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICByYW5kID0gXy5yYW5kb20oaW5kZXgrKyk7CiAgICAgIHNodWZmbGVkW2luZGV4IC0gMV0gPSBzaHVmZmxlZFtyYW5kXTsKICAgICAgc2h1ZmZsZWRbcmFuZF0gPSB2YWx1ZTsKICAgIH0pOwogICAgcmV0dXJuIHNodWZmbGVkOwogIH07CgogIC8vIEFuIGludGVybmFsIGZ1bmN0aW9uIHRvIGdlbmVyYXRlIGxvb2t1cCBpdGVyYXRvcnMuCiAgdmFyIGxvb2t1cEl0ZXJhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiBfLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUgOiBmdW5jdGlvbihvYmopeyByZXR1cm4gb2JqW3ZhbHVlXTsgfTsKICB9OwoKICAvLyBTb3J0IHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24gcHJvZHVjZWQgYnkgYW4gaXRlcmF0b3IuCiAgXy5zb3J0QnkgPSBmdW5jdGlvbihvYmosIHZhbHVlLCBjb250ZXh0KSB7CiAgICB2YXIgaXRlcmF0b3IgPSBsb29rdXBJdGVyYXRvcih2YWx1ZSk7CiAgICByZXR1cm4gXy5wbHVjayhfLm1hcChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICByZXR1cm4gewogICAgICAgIHZhbHVlIDogdmFsdWUsCiAgICAgICAgaW5kZXggOiBpbmRleCwKICAgICAgICBjcml0ZXJpYSA6IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KQogICAgICB9OwogICAgfSkuc29ydChmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICB2YXIgYSA9IGxlZnQuY3JpdGVyaWE7CiAgICAgIHZhciBiID0gcmlnaHQuY3JpdGVyaWE7CiAgICAgIGlmIChhICE9PSBiKSB7CiAgICAgICAgaWYgKGEgPiBiIHx8IGEgPT09IHZvaWQgMCkgcmV0dXJuIDE7CiAgICAgICAgaWYgKGEgPCBiIHx8IGIgPT09IHZvaWQgMCkgcmV0dXJuIC0xOwogICAgICB9CiAgICAgIHJldHVybiBsZWZ0LmluZGV4IDwgcmlnaHQuaW5kZXggPyAtMSA6IDE7CiAgICB9KSwgJ3ZhbHVlJyk7CiAgfTsKCiAgLy8gQW4gaW50ZXJuYWwgZnVuY3Rpb24gdXNlZCBmb3IgYWdncmVnYXRlICJncm91cCBieSIgb3BlcmF0aW9ucy4KICB2YXIgZ3JvdXAgPSBmdW5jdGlvbihvYmosIHZhbHVlLCBjb250ZXh0LCBiZWhhdmlvcikgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgdmFyIGl0ZXJhdG9yID0gbG9va3VwSXRlcmF0b3IodmFsdWUpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkgewogICAgICB2YXIga2V5ID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIG9iaik7CiAgICAgIGJlaGF2aW9yKHJlc3VsdCwga2V5LCB2YWx1ZSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gR3JvdXBzIHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24uIFBhc3MgZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZQogIC8vIHRvIGdyb3VwIGJ5LCBvciBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgY3JpdGVyaW9uLgogIF8uZ3JvdXBCeSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQpIHsKICAgIHJldHVybiBncm91cChvYmosIHZhbHVlLCBjb250ZXh0LCBmdW5jdGlvbihyZXN1bHQsIGtleSwgdmFsdWUpIHsKICAgICAgKF8uaGFzKHJlc3VsdCwga2V5KSA/IHJlc3VsdFtrZXldIDogKHJlc3VsdFtrZXldID0gW10pKS5wdXNoKHZhbHVlKTsKICAgIH0pOwogIH07CgogIC8vIENvdW50cyBpbnN0YW5jZXMgb2YgYW4gb2JqZWN0IHRoYXQgZ3JvdXAgYnkgYSBjZXJ0YWluIGNyaXRlcmlvbi4gUGFzcwogIC8vIGVpdGhlciBhIHN0cmluZyBhdHRyaWJ1dGUgdG8gY291bnQgYnksIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZQogIC8vIGNyaXRlcmlvbi4KICBfLmNvdW50QnkgPSBmdW5jdGlvbihvYmosIHZhbHVlLCBjb250ZXh0KSB7CiAgICByZXR1cm4gZ3JvdXAob2JqLCB2YWx1ZSwgY29udGV4dCwgZnVuY3Rpb24ocmVzdWx0LCBrZXksIHZhbHVlKSB7CiAgICAgIGlmICghXy5oYXMocmVzdWx0LCBrZXkpKSByZXN1bHRba2V5XSA9IDA7CiAgICAgIHJlc3VsdFtrZXldKys7CiAgICB9KTsKICB9OwoKICAvLyBVc2UgYSBjb21wYXJhdG9yIGZ1bmN0aW9uIHRvIGZpZ3VyZSBvdXQgdGhlIHNtYWxsZXN0IGluZGV4IGF0IHdoaWNoCiAgLy8gYW4gb2JqZWN0IHNob3VsZCBiZSBpbnNlcnRlZCBzbyBhcyB0byBtYWludGFpbiBvcmRlci4gVXNlcyBiaW5hcnkgc2VhcmNoLgogIF8uc29ydGVkSW5kZXggPSBmdW5jdGlvbihhcnJheSwgb2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgPSBpdGVyYXRvciA9PSBudWxsID8gXy5pZGVudGl0eSA6IGxvb2t1cEl0ZXJhdG9yKGl0ZXJhdG9yKTsKICAgIHZhciB2YWx1ZSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqKTsKICAgIHZhciBsb3cgPSAwLCBoaWdoID0gYXJyYXkubGVuZ3RoOwogICAgd2hpbGUgKGxvdyA8IGhpZ2gpIHsKICAgICAgdmFyIG1pZCA9IChsb3cgKyBoaWdoKSA+Pj4gMTsKICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBhcnJheVttaWRdKSA8IHZhbHVlID8gbG93ID0gbWlkICsgMSA6IGhpZ2ggPSBtaWQ7CiAgICB9CiAgICByZXR1cm4gbG93OwogIH07CgogIC8vIFNhZmVseSBjb252ZXJ0IGFueXRoaW5nIGl0ZXJhYmxlIGludG8gYSByZWFsLCBsaXZlIGFycmF5LgogIF8udG9BcnJheSA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCFvYmopIHJldHVybiBbXTsKICAgIGlmIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgcmV0dXJuIHNsaWNlLmNhbGwob2JqKTsKICAgIHJldHVybiBfLnZhbHVlcyhvYmopOwogIH07CgogIC8vIFJldHVybiB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIGFuIG9iamVjdC4KICBfLnNpemUgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiAob2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGgpID8gb2JqLmxlbmd0aCA6IF8ua2V5cyhvYmopLmxlbmd0aDsKICB9OwoKICAvLyBBcnJheSBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0KCiAgLy8gR2V0IHRoZSBmaXJzdCBlbGVtZW50IG9mIGFuIGFycmF5LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIHRoZSBmaXJzdCBOCiAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gQWxpYXNlZCBhcyBgaGVhZGAgYW5kIGB0YWtlYC4gVGhlICoqZ3VhcmQqKiBjaGVjawogIC8vIGFsbG93cyBpdCB0byB3b3JrIHdpdGggYF8ubWFwYC4KICBfLmZpcnN0ID0gXy5oZWFkID0gXy50YWtlID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICByZXR1cm4gKG4gIT0gbnVsbCkgJiYgIWd1YXJkID8gc2xpY2UuY2FsbChhcnJheSwgMCwgbikgOiBhcnJheVswXTsKICB9OwoKICAvLyBSZXR1cm5zIGV2ZXJ5dGhpbmcgYnV0IHRoZSBsYXN0IGVudHJ5IG9mIHRoZSBhcnJheS4gRXNwZWNpYWxseSB1c2VmdWwgb24KICAvLyB0aGUgYXJndW1lbnRzIG9iamVjdC4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiBhbGwgdGhlIHZhbHVlcyBpbgogIC8vIHRoZSBhcnJheSwgZXhjbHVkaW5nIHRoZSBsYXN0IE4uIFRoZSAqKmd1YXJkKiogY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aAogIC8vIGBfLm1hcGAuCiAgXy5pbml0aWFsID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgMCwgYXJyYXkubGVuZ3RoIC0gKChuID09IG51bGwpIHx8IGd1YXJkID8gMSA6IG4pKTsKICB9OwoKICAvLyBHZXQgdGhlIGxhc3QgZWxlbWVudCBvZiBhbiBhcnJheS4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiB0aGUgbGFzdCBOCiAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gVGhlICoqZ3VhcmQqKiBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCiAgXy5sYXN0ID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICBpZiAoKG4gIT0gbnVsbCkgJiYgIWd1YXJkKSB7CiAgICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCBNYXRoLm1heChhcnJheS5sZW5ndGggLSBuLCAwKSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gYXJyYXlbYXJyYXkubGVuZ3RoIC0gMV07CiAgICB9CiAgfTsKCiAgLy8gUmV0dXJucyBldmVyeXRoaW5nIGJ1dCB0aGUgZmlyc3QgZW50cnkgb2YgdGhlIGFycmF5LiBBbGlhc2VkIGFzIGB0YWlsYCBhbmQgYGRyb3BgLgogIC8vIEVzcGVjaWFsbHkgdXNlZnVsIG9uIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nIGFuICoqbioqIHdpbGwgcmV0dXJuCiAgLy8gdGhlIHJlc3QgTiB2YWx1ZXMgaW4gdGhlIGFycmF5LiBUaGUgKipndWFyZCoqCiAgLy8gY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8ucmVzdCA9IF8udGFpbCA9IF8uZHJvcCA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewogICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIChuID09IG51bGwpIHx8IGd1YXJkID8gMSA6IG4pOwogIH07CgogIC8vIFRyaW0gb3V0IGFsbCBmYWxzeSB2YWx1ZXMgZnJvbSBhbiBhcnJheS4KICBfLmNvbXBhY3QgPSBmdW5jdGlvbihhcnJheSkgewogICAgcmV0dXJuIF8uZmlsdGVyKGFycmF5LCBmdW5jdGlvbih2YWx1ZSl7IHJldHVybiAhIXZhbHVlOyB9KTsKICB9OwoKICAvLyBJbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiBvZiBhIHJlY3Vyc2l2ZSBgZmxhdHRlbmAgZnVuY3Rpb24uCiAgdmFyIGZsYXR0ZW4gPSBmdW5jdGlvbihpbnB1dCwgc2hhbGxvdywgb3V0cHV0KSB7CiAgICBlYWNoKGlucHV0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAoXy5pc0FycmF5KHZhbHVlKSkgewogICAgICAgIHNoYWxsb3cgPyBwdXNoLmFwcGx5KG91dHB1dCwgdmFsdWUpIDogZmxhdHRlbih2YWx1ZSwgc2hhbGxvdywgb3V0cHV0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvdXRwdXQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG91dHB1dDsKICB9OwoKICAvLyBSZXR1cm4gYSBjb21wbGV0ZWx5IGZsYXR0ZW5lZCB2ZXJzaW9uIG9mIGFuIGFycmF5LgogIF8uZmxhdHRlbiA9IGZ1bmN0aW9uKGFycmF5LCBzaGFsbG93KSB7CiAgICByZXR1cm4gZmxhdHRlbihhcnJheSwgc2hhbGxvdywgW10pOwogIH07CgogIC8vIFJldHVybiBhIHZlcnNpb24gb2YgdGhlIGFycmF5IHRoYXQgZG9lcyBub3QgY29udGFpbiB0aGUgc3BlY2lmaWVkIHZhbHVlKHMpLgogIF8ud2l0aG91dCA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICByZXR1cm4gXy5kaWZmZXJlbmNlKGFycmF5LCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogIH07CgogIC8vIFByb2R1Y2UgYSBkdXBsaWNhdGUtZnJlZSB2ZXJzaW9uIG9mIHRoZSBhcnJheS4gSWYgdGhlIGFycmF5IGhhcyBhbHJlYWR5CiAgLy8gYmVlbiBzb3J0ZWQsIHlvdSBoYXZlIHRoZSBvcHRpb24gb2YgdXNpbmcgYSBmYXN0ZXIgYWxnb3JpdGhtLgogIC8vIEFsaWFzZWQgYXMgYHVuaXF1ZWAuCiAgXy51bmlxID0gXy51bmlxdWUgPSBmdW5jdGlvbihhcnJheSwgaXNTb3J0ZWQsIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgaW5pdGlhbCA9IGl0ZXJhdG9yID8gXy5tYXAoYXJyYXksIGl0ZXJhdG9yLCBjb250ZXh0KSA6IGFycmF5OwogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIHZhciBzZWVuID0gW107CiAgICBlYWNoKGluaXRpYWwsIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkgewogICAgICBpZiAoaXNTb3J0ZWQgPyAoIWluZGV4IHx8IHNlZW5bc2Vlbi5sZW5ndGggLSAxXSAhPT0gdmFsdWUpIDogIV8uY29udGFpbnMoc2VlbiwgdmFsdWUpKSB7CiAgICAgICAgc2Vlbi5wdXNoKHZhbHVlKTsKICAgICAgICByZXN1bHRzLnB1c2goYXJyYXlbaW5kZXhdKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgdGhlIHVuaW9uOiBlYWNoIGRpc3RpbmN0IGVsZW1lbnQgZnJvbSBhbGwgb2YKICAvLyB0aGUgcGFzc2VkLWluIGFycmF5cy4KICBfLnVuaW9uID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gXy51bmlxKGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBhcmd1bWVudHMpKTsKICB9OwoKICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgZXZlcnkgaXRlbSBzaGFyZWQgYmV0d2VlbiBhbGwgdGhlCiAgLy8gcGFzc2VkLWluIGFycmF5cy4KICBfLmludGVyc2VjdGlvbiA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICB2YXIgcmVzdCA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIHJldHVybiBfLmZpbHRlcihfLnVuaXEoYXJyYXkpLCBmdW5jdGlvbihpdGVtKSB7CiAgICAgIHJldHVybiBfLmV2ZXJ5KHJlc3QsIGZ1bmN0aW9uKG90aGVyKSB7CiAgICAgICAgcmV0dXJuIF8uaW5kZXhPZihvdGhlciwgaXRlbSkgPj0gMDsKICAgICAgfSk7CiAgICB9KTsKICB9OwoKICAvLyBUYWtlIHRoZSBkaWZmZXJlbmNlIGJldHdlZW4gb25lIGFycmF5IGFuZCBhIG51bWJlciBvZiBvdGhlciBhcnJheXMuCiAgLy8gT25seSB0aGUgZWxlbWVudHMgcHJlc2VudCBpbiBqdXN0IHRoZSBmaXJzdCBhcnJheSB3aWxsIHJlbWFpbi4KICBfLmRpZmZlcmVuY2UgPSBmdW5jdGlvbihhcnJheSkgewogICAgdmFyIHJlc3QgPSBjb25jYXQuYXBwbHkoQXJyYXlQcm90bywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIHJldHVybiBfLmZpbHRlcihhcnJheSwgZnVuY3Rpb24odmFsdWUpeyByZXR1cm4gIV8uY29udGFpbnMocmVzdCwgdmFsdWUpOyB9KTsKICB9OwoKICAvLyBaaXAgdG9nZXRoZXIgbXVsdGlwbGUgbGlzdHMgaW50byBhIHNpbmdsZSBhcnJheSAtLSBlbGVtZW50cyB0aGF0IHNoYXJlCiAgLy8gYW4gaW5kZXggZ28gdG9nZXRoZXIuCiAgXy56aXAgPSBmdW5jdGlvbigpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgdmFyIGxlbmd0aCA9IF8ubWF4KF8ucGx1Y2soYXJncywgJ2xlbmd0aCcpKTsKICAgIHZhciByZXN1bHRzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHJlc3VsdHNbaV0gPSBfLnBsdWNrKGFyZ3MsICIiICsgaSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyBDb252ZXJ0cyBsaXN0cyBpbnRvIG9iamVjdHMuIFBhc3MgZWl0aGVyIGEgc2luZ2xlIGFycmF5IG9mIGBba2V5LCB2YWx1ZV1gCiAgLy8gcGFpcnMsIG9yIHR3byBwYXJhbGxlbCBhcnJheXMgb2YgdGhlIHNhbWUgbGVuZ3RoIC0tIG9uZSBvZiBrZXlzLCBhbmQgb25lIG9mCiAgLy8gdGhlIGNvcnJlc3BvbmRpbmcgdmFsdWVzLgogIF8ub2JqZWN0ID0gZnVuY3Rpb24obGlzdCwgdmFsdWVzKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGxpc3QubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIGlmICh2YWx1ZXMpIHsKICAgICAgICByZXN1bHRbbGlzdFtpXV0gPSB2YWx1ZXNbaV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0W2xpc3RbaV1bMF1dID0gbGlzdFtpXVsxXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBJZiB0aGUgYnJvd3NlciBkb2Vzbid0IHN1cHBseSB1cyB3aXRoIGluZGV4T2YgKEknbSBsb29raW5nIGF0IHlvdSwgKipNU0lFKiopLAogIC8vIHdlIG5lZWQgdGhpcyBmdW5jdGlvbi4gUmV0dXJuIHRoZSBwb3NpdGlvbiBvZiB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBhbgogIC8vIGl0ZW0gaW4gYW4gYXJyYXksIG9yIC0xIGlmIHRoZSBpdGVtIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgYXJyYXkuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGluZGV4T2ZgIGlmIGF2YWlsYWJsZS4KICAvLyBJZiB0aGUgYXJyYXkgaXMgbGFyZ2UgYW5kIGFscmVhZHkgaW4gc29ydCBvcmRlciwgcGFzcyBgdHJ1ZWAKICAvLyBmb3IgKippc1NvcnRlZCoqIHRvIHVzZSBiaW5hcnkgc2VhcmNoLgogIF8uaW5kZXhPZiA9IGZ1bmN0aW9uKGFycmF5LCBpdGVtLCBpc1NvcnRlZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiAtMTsKICAgIHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsKICAgIGlmIChpc1NvcnRlZCkgewogICAgICBpZiAodHlwZW9mIGlzU29ydGVkID09ICdudW1iZXInKSB7CiAgICAgICAgaSA9IChpc1NvcnRlZCA8IDAgPyBNYXRoLm1heCgwLCBsICsgaXNTb3J0ZWQpIDogaXNTb3J0ZWQpOwogICAgICB9IGVsc2UgewogICAgICAgIGkgPSBfLnNvcnRlZEluZGV4KGFycmF5LCBpdGVtKTsKICAgICAgICByZXR1cm4gYXJyYXlbaV0gPT09IGl0ZW0gPyBpIDogLTE7CiAgICAgIH0KICAgIH0KICAgIGlmIChuYXRpdmVJbmRleE9mICYmIGFycmF5LmluZGV4T2YgPT09IG5hdGl2ZUluZGV4T2YpIHJldHVybiBhcnJheS5pbmRleE9mKGl0ZW0sIGlzU29ydGVkKTsKICAgIGZvciAoOyBpIDwgbDsgaSsrKSBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pIHJldHVybiBpOwogICAgcmV0dXJuIC0xOwogIH07CgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBsYXN0SW5kZXhPZmAgaWYgYXZhaWxhYmxlLgogIF8ubGFzdEluZGV4T2YgPSBmdW5jdGlvbihhcnJheSwgaXRlbSwgZnJvbSkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiAtMTsKICAgIHZhciBoYXNJbmRleCA9IGZyb20gIT0gbnVsbDsKICAgIGlmIChuYXRpdmVMYXN0SW5kZXhPZiAmJiBhcnJheS5sYXN0SW5kZXhPZiA9PT0gbmF0aXZlTGFzdEluZGV4T2YpIHsKICAgICAgcmV0dXJuIGhhc0luZGV4ID8gYXJyYXkubGFzdEluZGV4T2YoaXRlbSwgZnJvbSkgOiBhcnJheS5sYXN0SW5kZXhPZihpdGVtKTsKICAgIH0KICAgIHZhciBpID0gKGhhc0luZGV4ID8gZnJvbSA6IGFycmF5Lmxlbmd0aCk7CiAgICB3aGlsZSAoaS0tKSBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pIHJldHVybiBpOwogICAgcmV0dXJuIC0xOwogIH07CgogIC8vIEdlbmVyYXRlIGFuIGludGVnZXIgQXJyYXkgY29udGFpbmluZyBhbiBhcml0aG1ldGljIHByb2dyZXNzaW9uLiBBIHBvcnQgb2YKICAvLyB0aGUgbmF0aXZlIFB5dGhvbiBgcmFuZ2UoKWAgZnVuY3Rpb24uIFNlZQogIC8vIFt0aGUgUHl0aG9uIGRvY3VtZW50YXRpb25dKGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvbGlicmFyeS9mdW5jdGlvbnMuaHRtbCNyYW5nZSkuCiAgXy5yYW5nZSA9IGZ1bmN0aW9uKHN0YXJ0LCBzdG9wLCBzdGVwKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8PSAxKSB7CiAgICAgIHN0b3AgPSBzdGFydCB8fCAwOwogICAgICBzdGFydCA9IDA7CiAgICB9CiAgICBzdGVwID0gYXJndW1lbnRzWzJdIHx8IDE7CgogICAgdmFyIGxlbiA9IE1hdGgubWF4KE1hdGguY2VpbCgoc3RvcCAtIHN0YXJ0KSAvIHN0ZXApLCAwKTsKICAgIHZhciBpZHggPSAwOwogICAgdmFyIHJhbmdlID0gbmV3IEFycmF5KGxlbik7CgogICAgd2hpbGUoaWR4IDwgbGVuKSB7CiAgICAgIHJhbmdlW2lkeCsrXSA9IHN0YXJ0OwogICAgICBzdGFydCArPSBzdGVwOwogICAgfQoKICAgIHJldHVybiByYW5nZTsKICB9OwoKICAvLyBGdW5jdGlvbiAoYWhlbSkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJldXNhYmxlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciBwcm90b3R5cGUgc2V0dGluZy4KICB2YXIgY3RvciA9IGZ1bmN0aW9uKCl7fTsKCiAgLy8gQ3JlYXRlIGEgZnVuY3Rpb24gYm91bmQgdG8gYSBnaXZlbiBvYmplY3QgKGFzc2lnbmluZyBgdGhpc2AsIGFuZCBhcmd1bWVudHMsCiAgLy8gb3B0aW9uYWxseSkuIEJpbmRpbmcgd2l0aCBhcmd1bWVudHMgaXMgYWxzbyBrbm93biBhcyBgY3VycnlgLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBGdW5jdGlvbi5iaW5kYCBpZiBhdmFpbGFibGUuCiAgLy8gV2UgY2hlY2sgZm9yIGBmdW5jLmJpbmRgIGZpcnN0LCB0byBmYWlsIGZhc3Qgd2hlbiBgZnVuY2AgaXMgdW5kZWZpbmVkLgogIF8uYmluZCA9IGZ1bmN0aW9uIGJpbmQoZnVuYywgY29udGV4dCkgewogICAgdmFyIGJvdW5kLCBhcmdzOwogICAgaWYgKGZ1bmMuYmluZCA9PT0gbmF0aXZlQmluZCAmJiBuYXRpdmVCaW5kKSByZXR1cm4gbmF0aXZlQmluZC5hcHBseShmdW5jLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgaWYgKCFfLmlzRnVuY3Rpb24oZnVuYykpIHRocm93IG5ldyBUeXBlRXJyb3I7CiAgICBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIGJvdW5kID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBib3VuZCkpIHJldHVybiBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICBjdG9yLnByb3RvdHlwZSA9IGZ1bmMucHJvdG90eXBlOwogICAgICB2YXIgc2VsZiA9IG5ldyBjdG9yOwogICAgICB2YXIgcmVzdWx0ID0gZnVuYy5hcHBseShzZWxmLCBhcmdzLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgICAgaWYgKE9iamVjdChyZXN1bHQpID09PSByZXN1bHQpIHJldHVybiByZXN1bHQ7CiAgICAgIHJldHVybiBzZWxmOwogICAgfTsKICB9OwoKICAvLyBCaW5kIGFsbCBvZiBhbiBvYmplY3QncyBtZXRob2RzIHRvIHRoYXQgb2JqZWN0LiBVc2VmdWwgZm9yIGVuc3VyaW5nIHRoYXQKICAvLyBhbGwgY2FsbGJhY2tzIGRlZmluZWQgb24gYW4gb2JqZWN0IGJlbG9uZyB0byBpdC4KICBfLmJpbmRBbGwgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBmdW5jcyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIGlmIChmdW5jcy5sZW5ndGggPT0gMCkgZnVuY3MgPSBfLmZ1bmN0aW9ucyhvYmopOwogICAgZWFjaChmdW5jcywgZnVuY3Rpb24oZikgeyBvYmpbZl0gPSBfLmJpbmQob2JqW2ZdLCBvYmopOyB9KTsKICAgIHJldHVybiBvYmo7CiAgfTsKCiAgLy8gTWVtb2l6ZSBhbiBleHBlbnNpdmUgZnVuY3Rpb24gYnkgc3RvcmluZyBpdHMgcmVzdWx0cy4KICBfLm1lbW9pemUgPSBmdW5jdGlvbihmdW5jLCBoYXNoZXIpIHsKICAgIHZhciBtZW1vID0ge307CiAgICBoYXNoZXIgfHwgKGhhc2hlciA9IF8uaWRlbnRpdHkpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIga2V5ID0gaGFzaGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiBfLmhhcyhtZW1vLCBrZXkpID8gbWVtb1trZXldIDogKG1lbW9ba2V5XSA9IGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9OwogIH07CgogIC8vIERlbGF5cyBhIGZ1bmN0aW9uIGZvciB0aGUgZ2l2ZW4gbnVtYmVyIG9mIG1pbGxpc2Vjb25kcywgYW5kIHRoZW4gY2FsbHMKICAvLyBpdCB3aXRoIHRoZSBhcmd1bWVudHMgc3VwcGxpZWQuCiAgXy5kZWxheSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsgcmV0dXJuIGZ1bmMuYXBwbHkobnVsbCwgYXJncyk7IH0sIHdhaXQpOwogIH07CgogIC8vIERlZmVycyBhIGZ1bmN0aW9uLCBzY2hlZHVsaW5nIGl0IHRvIHJ1biBhZnRlciB0aGUgY3VycmVudCBjYWxsIHN0YWNrIGhhcwogIC8vIGNsZWFyZWQuCiAgXy5kZWZlciA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAgIHJldHVybiBfLmRlbGF5LmFwcGx5KF8sIFtmdW5jLCAxXS5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKSk7CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0LCB3aGVuIGludm9rZWQsIHdpbGwgb25seSBiZSB0cmlnZ2VyZWQgYXQgbW9zdCBvbmNlCiAgLy8gZHVyaW5nIGEgZ2l2ZW4gd2luZG93IG9mIHRpbWUuCiAgXy50aHJvdHRsZSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQpIHsKICAgIHZhciBjb250ZXh0LCBhcmdzLCB0aW1lb3V0LCB0aHJvdHRsaW5nLCBtb3JlLCByZXN1bHQ7CiAgICB2YXIgd2hlbkRvbmUgPSBfLmRlYm91bmNlKGZ1bmN0aW9uKCl7IG1vcmUgPSB0aHJvdHRsaW5nID0gZmFsc2U7IH0sIHdhaXQpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBjb250ZXh0ID0gdGhpczsgYXJncyA9IGFyZ3VtZW50czsKICAgICAgdmFyIGxhdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgaWYgKG1vcmUpIHsKICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgfQogICAgICAgIHdoZW5Eb25lKCk7CiAgICAgIH07CiAgICAgIGlmICghdGltZW91dCkgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQpOwogICAgICBpZiAodGhyb3R0bGluZykgewogICAgICAgIG1vcmUgPSB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm90dGxpbmcgPSB0cnVlOwogICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgIH0KICAgICAgd2hlbkRvbmUoKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0LCBhcyBsb25nIGFzIGl0IGNvbnRpbnVlcyB0byBiZSBpbnZva2VkLCB3aWxsIG5vdAogIC8vIGJlIHRyaWdnZXJlZC4gVGhlIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIGFmdGVyIGl0IHN0b3BzIGJlaW5nIGNhbGxlZCBmb3IKICAvLyBOIG1pbGxpc2Vjb25kcy4gSWYgYGltbWVkaWF0ZWAgaXMgcGFzc2VkLCB0cmlnZ2VyIHRoZSBmdW5jdGlvbiBvbiB0aGUKICAvLyBsZWFkaW5nIGVkZ2UsIGluc3RlYWQgb2YgdGhlIHRyYWlsaW5nLgogIF8uZGVib3VuY2UgPSBmdW5jdGlvbihmdW5jLCB3YWl0LCBpbW1lZGlhdGUpIHsKICAgIHZhciB0aW1lb3V0LCByZXN1bHQ7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBjb250ZXh0ID0gdGhpcywgYXJncyA9IGFyZ3VtZW50czsKICAgICAgdmFyIGxhdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgaWYgKCFpbW1lZGlhdGUpIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgIH07CiAgICAgIHZhciBjYWxsTm93ID0gaW1tZWRpYXRlICYmICF0aW1lb3V0OwogICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CiAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCB3YWl0KTsKICAgICAgaWYgKGNhbGxOb3cpIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgZXhlY3V0ZWQgYXQgbW9zdCBvbmUgdGltZSwgbm8gbWF0dGVyIGhvdwogIC8vIG9mdGVuIHlvdSBjYWxsIGl0LiBVc2VmdWwgZm9yIGxhenkgaW5pdGlhbGl6YXRpb24uCiAgXy5vbmNlID0gZnVuY3Rpb24oZnVuYykgewogICAgdmFyIHJhbiA9IGZhbHNlLCBtZW1vOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBpZiAocmFuKSByZXR1cm4gbWVtbzsKICAgICAgcmFuID0gdHJ1ZTsKICAgICAgbWVtbyA9IGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgZnVuYyA9IG51bGw7CiAgICAgIHJldHVybiBtZW1vOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIHRoZSBmaXJzdCBmdW5jdGlvbiBwYXNzZWQgYXMgYW4gYXJndW1lbnQgdG8gdGhlIHNlY29uZCwKICAvLyBhbGxvd2luZyB5b3UgdG8gYWRqdXN0IGFyZ3VtZW50cywgcnVuIGNvZGUgYmVmb3JlIGFuZCBhZnRlciwgYW5kCiAgLy8gY29uZGl0aW9uYWxseSBleGVjdXRlIHRoZSBvcmlnaW5hbCBmdW5jdGlvbi4KICBfLndyYXAgPSBmdW5jdGlvbihmdW5jLCB3cmFwcGVyKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gW2Z1bmNdOwogICAgICBwdXNoLmFwcGx5KGFyZ3MsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiB3cmFwcGVyLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCBpcyB0aGUgY29tcG9zaXRpb24gb2YgYSBsaXN0IG9mIGZ1bmN0aW9ucywgZWFjaAogIC8vIGNvbnN1bWluZyB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBmdW5jdGlvbiB0aGF0IGZvbGxvd3MuCiAgXy5jb21wb3NlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgZnVuY3MgPSBhcmd1bWVudHM7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwogICAgICBmb3IgKHZhciBpID0gZnVuY3MubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICBhcmdzID0gW2Z1bmNzW2ldLmFwcGx5KHRoaXMsIGFyZ3MpXTsKICAgICAgfQogICAgICByZXR1cm4gYXJnc1swXTsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBvbmx5IGJlIGV4ZWN1dGVkIGFmdGVyIGJlaW5nIGNhbGxlZCBOIHRpbWVzLgogIF8uYWZ0ZXIgPSBmdW5jdGlvbih0aW1lcywgZnVuYykgewogICAgaWYgKHRpbWVzIDw9IDApIHJldHVybiBmdW5jKCk7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGlmICgtLXRpbWVzIDwgMSkgewogICAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH07CiAgfTsKCiAgLy8gT2JqZWN0IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gUmV0cmlldmUgdGhlIG5hbWVzIG9mIGFuIG9iamVjdCdzIHByb3BlcnRpZXMuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYE9iamVjdC5rZXlzYAogIF8ua2V5cyA9IG5hdGl2ZUtleXMgfHwgZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqICE9PSBPYmplY3Qob2JqKSkgdGhyb3cgbmV3IFR5cGVFcnJvcignSW52YWxpZCBvYmplY3QnKTsKICAgIHZhciBrZXlzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSBrZXlzW2tleXMubGVuZ3RoXSA9IGtleTsKICAgIHJldHVybiBrZXlzOwogIH07CgogIC8vIFJldHJpZXZlIHRoZSB2YWx1ZXMgb2YgYW4gb2JqZWN0J3MgcHJvcGVydGllcy4KICBfLnZhbHVlcyA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIHZhbHVlcyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgdmFsdWVzLnB1c2gob2JqW2tleV0pOwogICAgcmV0dXJuIHZhbHVlczsKICB9OwoKICAvLyBDb252ZXJ0IGFuIG9iamVjdCBpbnRvIGEgbGlzdCBvZiBgW2tleSwgdmFsdWVdYCBwYWlycy4KICBfLnBhaXJzID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgcGFpcnMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIHBhaXJzLnB1c2goW2tleSwgb2JqW2tleV1dKTsKICAgIHJldHVybiBwYWlyczsKICB9OwoKICAvLyBJbnZlcnQgdGhlIGtleXMgYW5kIHZhbHVlcyBvZiBhbiBvYmplY3QuIFRoZSB2YWx1ZXMgbXVzdCBiZSBzZXJpYWxpemFibGUuCiAgXy5pbnZlcnQgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIHJlc3VsdFtvYmpba2V5XV0gPSBrZXk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIFJldHVybiBhIHNvcnRlZCBsaXN0IG9mIHRoZSBmdW5jdGlvbiBuYW1lcyBhdmFpbGFibGUgb24gdGhlIG9iamVjdC4KICAvLyBBbGlhc2VkIGFzIGBtZXRob2RzYAogIF8uZnVuY3Rpb25zID0gXy5tZXRob2RzID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgbmFtZXMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihvYmpba2V5XSkpIG5hbWVzLnB1c2goa2V5KTsKICAgIH0KICAgIHJldHVybiBuYW1lcy5zb3J0KCk7CiAgfTsKCiAgLy8gRXh0ZW5kIGEgZ2l2ZW4gb2JqZWN0IHdpdGggYWxsIHRoZSBwcm9wZXJ0aWVzIGluIHBhc3NlZC1pbiBvYmplY3QocykuCiAgXy5leHRlbmQgPSBmdW5jdGlvbihvYmopIHsKICAgIGVhY2goc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLCBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICBvYmpbcHJvcF0gPSBzb3VyY2VbcHJvcF07CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBvYmplY3Qgb25seSBjb250YWluaW5nIHRoZSB3aGl0ZWxpc3RlZCBwcm9wZXJ0aWVzLgogIF8ucGljayA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGNvcHkgPSB7fTsKICAgIHZhciBrZXlzID0gY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBlYWNoKGtleXMsIGZ1bmN0aW9uKGtleSkgewogICAgICBpZiAoa2V5IGluIG9iaikgY29weVtrZXldID0gb2JqW2tleV07CiAgICB9KTsKICAgIHJldHVybiBjb3B5OwogIH07CgogICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBvYmplY3Qgd2l0aG91dCB0aGUgYmxhY2tsaXN0ZWQgcHJvcGVydGllcy4KICBfLm9taXQgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBjb3B5ID0ge307CiAgICB2YXIga2V5cyA9IGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAoIV8uY29udGFpbnMoa2V5cywga2V5KSkgY29weVtrZXldID0gb2JqW2tleV07CiAgICB9CiAgICByZXR1cm4gY29weTsKICB9OwoKICAvLyBGaWxsIGluIGEgZ2l2ZW4gb2JqZWN0IHdpdGggZGVmYXVsdCBwcm9wZXJ0aWVzLgogIF8uZGVmYXVsdHMgPSBmdW5jdGlvbihvYmopIHsKICAgIGVhY2goc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLCBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICBpZiAob2JqW3Byb3BdID09IG51bGwpIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIENyZWF0ZSBhIChzaGFsbG93LWNsb25lZCkgZHVwbGljYXRlIG9mIGFuIG9iamVjdC4KICBfLmNsb25lID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIV8uaXNPYmplY3Qob2JqKSkgcmV0dXJuIG9iajsKICAgIHJldHVybiBfLmlzQXJyYXkob2JqKSA/IG9iai5zbGljZSgpIDogXy5leHRlbmQoe30sIG9iaik7CiAgfTsKCiAgLy8gSW52b2tlcyBpbnRlcmNlcHRvciB3aXRoIHRoZSBvYmosIGFuZCB0aGVuIHJldHVybnMgb2JqLgogIC8vIFRoZSBwcmltYXJ5IHB1cnBvc2Ugb2YgdGhpcyBtZXRob2QgaXMgdG8gInRhcCBpbnRvIiBhIG1ldGhvZCBjaGFpbiwgaW4KICAvLyBvcmRlciB0byBwZXJmb3JtIG9wZXJhdGlvbnMgb24gaW50ZXJtZWRpYXRlIHJlc3VsdHMgd2l0aGluIHRoZSBjaGFpbi4KICBfLnRhcCA9IGZ1bmN0aW9uKG9iaiwgaW50ZXJjZXB0b3IpIHsKICAgIGludGVyY2VwdG9yKG9iaik7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIEludGVybmFsIHJlY3Vyc2l2ZSBjb21wYXJpc29uIGZ1bmN0aW9uIGZvciBgaXNFcXVhbGAuCiAgdmFyIGVxID0gZnVuY3Rpb24oYSwgYiwgYVN0YWNrLCBiU3RhY2spIHsKICAgIC8vIElkZW50aWNhbCBvYmplY3RzIGFyZSBlcXVhbC4gYDAgPT09IC0wYCwgYnV0IHRoZXkgYXJlbid0IGlkZW50aWNhbC4KICAgIC8vIFNlZSB0aGUgSGFybW9ueSBgZWdhbGAgcHJvcG9zYWw6IGh0dHA6Ly93aWtpLmVjbWFzY3JpcHQub3JnL2Rva3UucGhwP2lkPWhhcm1vbnk6ZWdhbC4KICAgIGlmIChhID09PSBiKSByZXR1cm4gYSAhPT0gMCB8fCAxIC8gYSA9PSAxIC8gYjsKICAgIC8vIEEgc3RyaWN0IGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5IGJlY2F1c2UgYG51bGwgPT0gdW5kZWZpbmVkYC4KICAgIGlmIChhID09IG51bGwgfHwgYiA9PSBudWxsKSByZXR1cm4gYSA9PT0gYjsKICAgIC8vIFVud3JhcCBhbnkgd3JhcHBlZCBvYmplY3RzLgogICAgaWYgKGEgaW5zdGFuY2VvZiBfKSBhID0gYS5fd3JhcHBlZDsKICAgIGlmIChiIGluc3RhbmNlb2YgXykgYiA9IGIuX3dyYXBwZWQ7CiAgICAvLyBDb21wYXJlIGBbW0NsYXNzXV1gIG5hbWVzLgogICAgdmFyIGNsYXNzTmFtZSA9IHRvU3RyaW5nLmNhbGwoYSk7CiAgICBpZiAoY2xhc3NOYW1lICE9IHRvU3RyaW5nLmNhbGwoYikpIHJldHVybiBmYWxzZTsKICAgIHN3aXRjaCAoY2xhc3NOYW1lKSB7CiAgICAgIC8vIFN0cmluZ3MsIG51bWJlcnMsIGRhdGVzLCBhbmQgYm9vbGVhbnMgYXJlIGNvbXBhcmVkIGJ5IHZhbHVlLgogICAgICBjYXNlICdbb2JqZWN0IFN0cmluZ10nOgogICAgICAgIC8vIFByaW1pdGl2ZXMgYW5kIHRoZWlyIGNvcnJlc3BvbmRpbmcgb2JqZWN0IHdyYXBwZXJzIGFyZSBlcXVpdmFsZW50OyB0aHVzLCBgIjUiYCBpcwogICAgICAgIC8vIGVxdWl2YWxlbnQgdG8gYG5ldyBTdHJpbmcoIjUiKWAuCiAgICAgICAgcmV0dXJuIGEgPT0gU3RyaW5nKGIpOwogICAgICBjYXNlICdbb2JqZWN0IE51bWJlcl0nOgogICAgICAgIC8vIGBOYU5gcyBhcmUgZXF1aXZhbGVudCwgYnV0IG5vbi1yZWZsZXhpdmUuIEFuIGBlZ2FsYCBjb21wYXJpc29uIGlzIHBlcmZvcm1lZCBmb3IKICAgICAgICAvLyBvdGhlciBudW1lcmljIHZhbHVlcy4KICAgICAgICByZXR1cm4gYSAhPSArYSA/IGIgIT0gK2IgOiAoYSA9PSAwID8gMSAvIGEgPT0gMSAvIGIgOiBhID09ICtiKTsKICAgICAgY2FzZSAnW29iamVjdCBEYXRlXSc6CiAgICAgIGNhc2UgJ1tvYmplY3QgQm9vbGVhbl0nOgogICAgICAgIC8vIENvZXJjZSBkYXRlcyBhbmQgYm9vbGVhbnMgdG8gbnVtZXJpYyBwcmltaXRpdmUgdmFsdWVzLiBEYXRlcyBhcmUgY29tcGFyZWQgYnkgdGhlaXIKICAgICAgICAvLyBtaWxsaXNlY29uZCByZXByZXNlbnRhdGlvbnMuIE5vdGUgdGhhdCBpbnZhbGlkIGRhdGVzIHdpdGggbWlsbGlzZWNvbmQgcmVwcmVzZW50YXRpb25zCiAgICAgICAgLy8gb2YgYE5hTmAgYXJlIG5vdCBlcXVpdmFsZW50LgogICAgICAgIHJldHVybiArYSA9PSArYjsKICAgICAgLy8gUmVnRXhwcyBhcmUgY29tcGFyZWQgYnkgdGhlaXIgc291cmNlIHBhdHRlcm5zIGFuZCBmbGFncy4KICAgICAgY2FzZSAnW29iamVjdCBSZWdFeHBdJzoKICAgICAgICByZXR1cm4gYS5zb3VyY2UgPT0gYi5zb3VyY2UgJiYKICAgICAgICAgICAgICAgYS5nbG9iYWwgPT0gYi5nbG9iYWwgJiYKICAgICAgICAgICAgICAgYS5tdWx0aWxpbmUgPT0gYi5tdWx0aWxpbmUgJiYKICAgICAgICAgICAgICAgYS5pZ25vcmVDYXNlID09IGIuaWdub3JlQ2FzZTsKICAgIH0KICAgIGlmICh0eXBlb2YgYSAhPSAnb2JqZWN0JyB8fCB0eXBlb2YgYiAhPSAnb2JqZWN0JykgcmV0dXJuIGZhbHNlOwogICAgLy8gQXNzdW1lIGVxdWFsaXR5IGZvciBjeWNsaWMgc3RydWN0dXJlcy4gVGhlIGFsZ29yaXRobSBmb3IgZGV0ZWN0aW5nIGN5Y2xpYwogICAgLy8gc3RydWN0dXJlcyBpcyBhZGFwdGVkIGZyb20gRVMgNS4xIHNlY3Rpb24gMTUuMTIuMywgYWJzdHJhY3Qgb3BlcmF0aW9uIGBKT2AuCiAgICB2YXIgbGVuZ3RoID0gYVN0YWNrLmxlbmd0aDsKICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAvLyBMaW5lYXIgc2VhcmNoLiBQZXJmb3JtYW5jZSBpcyBpbnZlcnNlbHkgcHJvcG9ydGlvbmFsIHRvIHRoZSBudW1iZXIgb2YKICAgICAgLy8gdW5pcXVlIG5lc3RlZCBzdHJ1Y3R1cmVzLgogICAgICBpZiAoYVN0YWNrW2xlbmd0aF0gPT0gYSkgcmV0dXJuIGJTdGFja1tsZW5ndGhdID09IGI7CiAgICB9CiAgICAvLyBBZGQgdGhlIGZpcnN0IG9iamVjdCB0byB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMuCiAgICBhU3RhY2sucHVzaChhKTsKICAgIGJTdGFjay5wdXNoKGIpOwogICAgdmFyIHNpemUgPSAwLCByZXN1bHQgPSB0cnVlOwogICAgLy8gUmVjdXJzaXZlbHkgY29tcGFyZSBvYmplY3RzIGFuZCBhcnJheXMuCiAgICBpZiAoY2xhc3NOYW1lID09ICdbb2JqZWN0IEFycmF5XScpIHsKICAgICAgLy8gQ29tcGFyZSBhcnJheSBsZW5ndGhzIHRvIGRldGVybWluZSBpZiBhIGRlZXAgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkuCiAgICAgIHNpemUgPSBhLmxlbmd0aDsKICAgICAgcmVzdWx0ID0gc2l6ZSA9PSBiLmxlbmd0aDsKICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIC8vIERlZXAgY29tcGFyZSB0aGUgY29udGVudHMsIGlnbm9yaW5nIG5vbi1udW1lcmljIHByb3BlcnRpZXMuCiAgICAgICAgd2hpbGUgKHNpemUtLSkgewogICAgICAgICAgaWYgKCEocmVzdWx0ID0gZXEoYVtzaXplXSwgYltzaXplXSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBPYmplY3RzIHdpdGggZGlmZmVyZW50IGNvbnN0cnVjdG9ycyBhcmUgbm90IGVxdWl2YWxlbnQsIGJ1dCBgT2JqZWN0YHMKICAgICAgLy8gZnJvbSBkaWZmZXJlbnQgZnJhbWVzIGFyZS4KICAgICAgdmFyIGFDdG9yID0gYS5jb25zdHJ1Y3RvciwgYkN0b3IgPSBiLmNvbnN0cnVjdG9yOwogICAgICBpZiAoYUN0b3IgIT09IGJDdG9yICYmICEoXy5pc0Z1bmN0aW9uKGFDdG9yKSAmJiAoYUN0b3IgaW5zdGFuY2VvZiBhQ3RvcikgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uaXNGdW5jdGlvbihiQ3RvcikgJiYgKGJDdG9yIGluc3RhbmNlb2YgYkN0b3IpKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICAvLyBEZWVwIGNvbXBhcmUgb2JqZWN0cy4KICAgICAgZm9yICh2YXIga2V5IGluIGEpIHsKICAgICAgICBpZiAoXy5oYXMoYSwga2V5KSkgewogICAgICAgICAgLy8gQ291bnQgdGhlIGV4cGVjdGVkIG51bWJlciBvZiBwcm9wZXJ0aWVzLgogICAgICAgICAgc2l6ZSsrOwogICAgICAgICAgLy8gRGVlcCBjb21wYXJlIGVhY2ggbWVtYmVyLgogICAgICAgICAgaWYgKCEocmVzdWx0ID0gXy5oYXMoYiwga2V5KSAmJiBlcShhW2tleV0sIGJba2V5XSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIEVuc3VyZSB0aGF0IGJvdGggb2JqZWN0cyBjb250YWluIHRoZSBzYW1lIG51bWJlciBvZiBwcm9wZXJ0aWVzLgogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgZm9yIChrZXkgaW4gYikgewogICAgICAgICAgaWYgKF8uaGFzKGIsIGtleSkgJiYgIShzaXplLS0pKSBicmVhazsKICAgICAgICB9CiAgICAgICAgcmVzdWx0ID0gIXNpemU7CiAgICAgIH0KICAgIH0KICAgIC8vIFJlbW92ZSB0aGUgZmlyc3Qgb2JqZWN0IGZyb20gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgogICAgYVN0YWNrLnBvcCgpOwogICAgYlN0YWNrLnBvcCgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBQZXJmb3JtIGEgZGVlcCBjb21wYXJpc29uIHRvIGNoZWNrIGlmIHR3byBvYmplY3RzIGFyZSBlcXVhbC4KICBfLmlzRXF1YWwgPSBmdW5jdGlvbihhLCBiKSB7CiAgICByZXR1cm4gZXEoYSwgYiwgW10sIFtdKTsKICB9OwoKICAvLyBJcyBhIGdpdmVuIGFycmF5LCBzdHJpbmcsIG9yIG9iamVjdCBlbXB0eT8KICAvLyBBbiAiZW1wdHkiIG9iamVjdCBoYXMgbm8gZW51bWVyYWJsZSBvd24tcHJvcGVydGllcy4KICBfLmlzRW1wdHkgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHRydWU7CiAgICBpZiAoXy5pc0FycmF5KG9iaikgfHwgXy5pc1N0cmluZyhvYmopKSByZXR1cm4gb2JqLmxlbmd0aCA9PT0gMDsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIHJldHVybiBmYWxzZTsKICAgIHJldHVybiB0cnVlOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBET00gZWxlbWVudD8KICBfLmlzRWxlbWVudCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuICEhKG9iaiAmJiBvYmoubm9kZVR5cGUgPT09IDEpOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYW4gYXJyYXk/CiAgLy8gRGVsZWdhdGVzIHRvIEVDTUE1J3MgbmF0aXZlIEFycmF5LmlzQXJyYXkKICBfLmlzQXJyYXkgPSBuYXRpdmVJc0FycmF5IHx8IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PSAnW29iamVjdCBBcnJheV0nOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFyaWFibGUgYW4gb2JqZWN0PwogIF8uaXNPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IE9iamVjdChvYmopOwogIH07CgogIC8vIEFkZCBzb21lIGlzVHlwZSBtZXRob2RzOiBpc0FyZ3VtZW50cywgaXNGdW5jdGlvbiwgaXNTdHJpbmcsIGlzTnVtYmVyLCBpc0RhdGUsIGlzUmVnRXhwLgogIGVhY2goWydBcmd1bWVudHMnLCAnRnVuY3Rpb24nLCAnU3RyaW5nJywgJ051bWJlcicsICdEYXRlJywgJ1JlZ0V4cCddLCBmdW5jdGlvbihuYW1lKSB7CiAgICBfWydpcycgKyBuYW1lXSA9IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0ICcgKyBuYW1lICsgJ10nOwogICAgfTsKICB9KTsKCiAgLy8gRGVmaW5lIGEgZmFsbGJhY2sgdmVyc2lvbiBvZiB0aGUgbWV0aG9kIGluIGJyb3dzZXJzIChhaGVtLCBJRSksIHdoZXJlCiAgLy8gdGhlcmUgaXNuJ3QgYW55IGluc3BlY3RhYmxlICJBcmd1bWVudHMiIHR5cGUuCiAgaWYgKCFfLmlzQXJndW1lbnRzKGFyZ3VtZW50cykpIHsKICAgIF8uaXNBcmd1bWVudHMgPSBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuICEhKG9iaiAmJiBfLmhhcyhvYmosICdjYWxsZWUnKSk7CiAgICB9OwogIH0KCiAgLy8gT3B0aW1pemUgYGlzRnVuY3Rpb25gIGlmIGFwcHJvcHJpYXRlLgogIGlmICh0eXBlb2YgKC8uLykgIT09ICdmdW5jdGlvbicpIHsKICAgIF8uaXNGdW5jdGlvbiA9IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gJ2Z1bmN0aW9uJzsKICAgIH07CiAgfQoKICAvLyBJcyBhIGdpdmVuIG9iamVjdCBhIGZpbml0ZSBudW1iZXI/CiAgXy5pc0Zpbml0ZSA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIF8uaXNOdW1iZXIob2JqKSAmJiBpc0Zpbml0ZShvYmopOwogIH07CgogIC8vIElzIHRoZSBnaXZlbiB2YWx1ZSBgTmFOYD8gKE5hTiBpcyB0aGUgb25seSBudW1iZXIgd2hpY2ggZG9lcyBub3QgZXF1YWwgaXRzZWxmKS4KICBfLmlzTmFOID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXy5pc051bWJlcihvYmopICYmIG9iaiAhPSArb2JqOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBib29sZWFuPwogIF8uaXNCb29sZWFuID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSB0cnVlIHx8IG9iaiA9PT0gZmFsc2UgfHwgdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0IEJvb2xlYW5dJzsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhbHVlIGVxdWFsIHRvIG51bGw/CiAgXy5pc051bGwgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IG51bGw7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YXJpYWJsZSB1bmRlZmluZWQ/CiAgXy5pc1VuZGVmaW5lZCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gdm9pZCAwOwogIH07CgogIC8vIFNob3J0Y3V0IGZ1bmN0aW9uIGZvciBjaGVja2luZyBpZiBhbiBvYmplY3QgaGFzIGEgZ2l2ZW4gcHJvcGVydHkgZGlyZWN0bHkKICAvLyBvbiBpdHNlbGYgKGluIG90aGVyIHdvcmRzLCBub3Qgb24gYSBwcm90b3R5cGUpLgogIF8uaGFzID0gZnVuY3Rpb24ob2JqLCBrZXkpIHsKICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KTsKICB9OwoKICAvLyBVdGlsaXR5IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJ1biBVbmRlcnNjb3JlLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBfYCB2YXJpYWJsZSB0byBpdHMKICAvLyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QuCiAgXy5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CiAgICByb290Ll8gPSBwcmV2aW91c1VuZGVyc2NvcmU7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBLZWVwIHRoZSBpZGVudGl0eSBmdW5jdGlvbiBhcm91bmQgZm9yIGRlZmF1bHQgaXRlcmF0b3JzLgogIF8uaWRlbnRpdHkgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlOwogIH07CgogIC8vIFJ1biBhIGZ1bmN0aW9uICoqbioqIHRpbWVzLgogIF8udGltZXMgPSBmdW5jdGlvbihuLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuOyBpKyspIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgaSk7CiAgfTsKCiAgLy8gUmV0dXJuIGEgcmFuZG9tIGludGVnZXIgYmV0d2VlbiBtaW4gYW5kIG1heCAoaW5jbHVzaXZlKS4KICBfLnJhbmRvbSA9IGZ1bmN0aW9uKG1pbiwgbWF4KSB7CiAgICBpZiAobWF4ID09IG51bGwpIHsKICAgICAgbWF4ID0gbWluOwogICAgICBtaW4gPSAwOwogICAgfQogICAgcmV0dXJuIG1pbiArICgwIHwgTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4gKyAxKSk7CiAgfTsKCiAgLy8gTGlzdCBvZiBIVE1MIGVudGl0aWVzIGZvciBlc2NhcGluZy4KICB2YXIgZW50aXR5TWFwID0gewogICAgZXNjYXBlOiB7CiAgICAgICcmJzogJyZhbXA7JywKICAgICAgJzwnOiAnJmx0OycsCiAgICAgICc+JzogJyZndDsnLAogICAgICAnIic6ICcmcXVvdDsnLAogICAgICAiJyI6ICcmI3gyNzsnLAogICAgICAnLyc6ICcmI3gyRjsnCiAgICB9CiAgfTsKICBlbnRpdHlNYXAudW5lc2NhcGUgPSBfLmludmVydChlbnRpdHlNYXAuZXNjYXBlKTsKCiAgLy8gUmVnZXhlcyBjb250YWluaW5nIHRoZSBrZXlzIGFuZCB2YWx1ZXMgbGlzdGVkIGltbWVkaWF0ZWx5IGFib3ZlLgogIHZhciBlbnRpdHlSZWdleGVzID0gewogICAgZXNjYXBlOiAgIG5ldyBSZWdFeHAoJ1snICsgXy5rZXlzKGVudGl0eU1hcC5lc2NhcGUpLmpvaW4oJycpICsgJ10nLCAnZycpLAogICAgdW5lc2NhcGU6IG5ldyBSZWdFeHAoJygnICsgXy5rZXlzKGVudGl0eU1hcC51bmVzY2FwZSkuam9pbignfCcpICsgJyknLCAnZycpCiAgfTsKCiAgLy8gRnVuY3Rpb25zIGZvciBlc2NhcGluZyBhbmQgdW5lc2NhcGluZyBzdHJpbmdzIHRvL2Zyb20gSFRNTCBpbnRlcnBvbGF0aW9uLgogIF8uZWFjaChbJ2VzY2FwZScsICd1bmVzY2FwZSddLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIF9bbWV0aG9kXSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgICBpZiAoc3RyaW5nID09IG51bGwpIHJldHVybiAnJzsKICAgICAgcmV0dXJuICgnJyArIHN0cmluZykucmVwbGFjZShlbnRpdHlSZWdleGVzW21ldGhvZF0sIGZ1bmN0aW9uKG1hdGNoKSB7CiAgICAgICAgcmV0dXJuIGVudGl0eU1hcFttZXRob2RdW21hdGNoXTsKICAgICAgfSk7CiAgICB9OwogIH0pOwoKICAvLyBJZiB0aGUgdmFsdWUgb2YgdGhlIG5hbWVkIHByb3BlcnR5IGlzIGEgZnVuY3Rpb24gdGhlbiBpbnZva2UgaXQ7CiAgLy8gb3RoZXJ3aXNlLCByZXR1cm4gaXQuCiAgXy5yZXN1bHQgPSBmdW5jdGlvbihvYmplY3QsIHByb3BlcnR5KSB7CiAgICBpZiAob2JqZWN0ID09IG51bGwpIHJldHVybiBudWxsOwogICAgdmFyIHZhbHVlID0gb2JqZWN0W3Byb3BlcnR5XTsKICAgIHJldHVybiBfLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUuY2FsbChvYmplY3QpIDogdmFsdWU7CiAgfTsKCiAgLy8gQWRkIHlvdXIgb3duIGN1c3RvbSBmdW5jdGlvbnMgdG8gdGhlIFVuZGVyc2NvcmUgb2JqZWN0LgogIF8ubWl4aW4gPSBmdW5jdGlvbihvYmopIHsKICAgIGVhY2goXy5mdW5jdGlvbnMob2JqKSwgZnVuY3Rpb24obmFtZSl7CiAgICAgIHZhciBmdW5jID0gX1tuYW1lXSA9IG9ialtuYW1lXTsKICAgICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYXJncyA9IFt0aGlzLl93cmFwcGVkXTsKICAgICAgICBwdXNoLmFwcGx5KGFyZ3MsIGFyZ3VtZW50cyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIGZ1bmMuYXBwbHkoXywgYXJncykpOwogICAgICB9OwogICAgfSk7CiAgfTsKCiAgLy8gR2VuZXJhdGUgYSB1bmlxdWUgaW50ZWdlciBpZCAodW5pcXVlIHdpdGhpbiB0aGUgZW50aXJlIGNsaWVudCBzZXNzaW9uKS4KICAvLyBVc2VmdWwgZm9yIHRlbXBvcmFyeSBET00gaWRzLgogIHZhciBpZENvdW50ZXIgPSAwOwogIF8udW5pcXVlSWQgPSBmdW5jdGlvbihwcmVmaXgpIHsKICAgIHZhciBpZCA9IGlkQ291bnRlcisrOwogICAgcmV0dXJuIHByZWZpeCA/IHByZWZpeCArIGlkIDogaWQ7CiAgfTsKCiAgLy8gQnkgZGVmYXVsdCwgVW5kZXJzY29yZSB1c2VzIEVSQi1zdHlsZSB0ZW1wbGF0ZSBkZWxpbWl0ZXJzLCBjaGFuZ2UgdGhlCiAgLy8gZm9sbG93aW5nIHRlbXBsYXRlIHNldHRpbmdzIHRvIHVzZSBhbHRlcm5hdGl2ZSBkZWxpbWl0ZXJzLgogIF8udGVtcGxhdGVTZXR0aW5ncyA9IHsKICAgIGV2YWx1YXRlICAgIDogLzwlKFtcc1xTXSs/KSU+L2csCiAgICBpbnRlcnBvbGF0ZSA6IC88JT0oW1xzXFNdKz8pJT4vZywKICAgIGVzY2FwZSAgICAgIDogLzwlLShbXHNcU10rPyklPi9nCiAgfTsKCiAgLy8gV2hlbiBjdXN0b21pemluZyBgdGVtcGxhdGVTZXR0aW5nc2AsIGlmIHlvdSBkb24ndCB3YW50IHRvIGRlZmluZSBhbgogIC8vIGludGVycG9sYXRpb24sIGV2YWx1YXRpb24gb3IgZXNjYXBpbmcgcmVnZXgsIHdlIG5lZWQgb25lIHRoYXQgaXMKICAvLyBndWFyYW50ZWVkIG5vdCB0byBtYXRjaC4KICB2YXIgbm9NYXRjaCA9IC8oLileLzsKCiAgLy8gQ2VydGFpbiBjaGFyYWN0ZXJzIG5lZWQgdG8gYmUgZXNjYXBlZCBzbyB0aGF0IHRoZXkgY2FuIGJlIHB1dCBpbnRvIGEKICAvLyBzdHJpbmcgbGl0ZXJhbC4KICB2YXIgZXNjYXBlcyA9IHsKICAgICInIjogICAgICAiJyIsCiAgICAnXFwnOiAgICAgJ1xcJywKICAgICdccic6ICAgICAncicsCiAgICAnXG4nOiAgICAgJ24nLAogICAgJ1x0JzogICAgICd0JywKICAgICdcdTIwMjgnOiAndTIwMjgnLAogICAgJ1x1MjAyOSc6ICd1MjAyOScKICB9OwoKICB2YXIgZXNjYXBlciA9IC9cXHwnfFxyfFxufFx0fFx1MjAyOHxcdTIwMjkvZzsKCiAgLy8gSmF2YVNjcmlwdCBtaWNyby10ZW1wbGF0aW5nLCBzaW1pbGFyIHRvIEpvaG4gUmVzaWcncyBpbXBsZW1lbnRhdGlvbi4KICAvLyBVbmRlcnNjb3JlIHRlbXBsYXRpbmcgaGFuZGxlcyBhcmJpdHJhcnkgZGVsaW1pdGVycywgcHJlc2VydmVzIHdoaXRlc3BhY2UsCiAgLy8gYW5kIGNvcnJlY3RseSBlc2NhcGVzIHF1b3RlcyB3aXRoaW4gaW50ZXJwb2xhdGVkIGNvZGUuCiAgXy50ZW1wbGF0ZSA9IGZ1bmN0aW9uKHRleHQsIGRhdGEsIHNldHRpbmdzKSB7CiAgICBzZXR0aW5ncyA9IF8uZGVmYXVsdHMoe30sIHNldHRpbmdzLCBfLnRlbXBsYXRlU2V0dGluZ3MpOwoKICAgIC8vIENvbWJpbmUgZGVsaW1pdGVycyBpbnRvIG9uZSByZWd1bGFyIGV4cHJlc3Npb24gdmlhIGFsdGVybmF0aW9uLgogICAgdmFyIG1hdGNoZXIgPSBuZXcgUmVnRXhwKFsKICAgICAgKHNldHRpbmdzLmVzY2FwZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5pbnRlcnBvbGF0ZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5ldmFsdWF0ZSB8fCBub01hdGNoKS5zb3VyY2UKICAgIF0uam9pbignfCcpICsgJ3wkJywgJ2cnKTsKCiAgICAvLyBDb21waWxlIHRoZSB0ZW1wbGF0ZSBzb3VyY2UsIGVzY2FwaW5nIHN0cmluZyBsaXRlcmFscyBhcHByb3ByaWF0ZWx5LgogICAgdmFyIGluZGV4ID0gMDsKICAgIHZhciBzb3VyY2UgPSAiX19wKz0nIjsKICAgIHRleHQucmVwbGFjZShtYXRjaGVyLCBmdW5jdGlvbihtYXRjaCwgZXNjYXBlLCBpbnRlcnBvbGF0ZSwgZXZhbHVhdGUsIG9mZnNldCkgewogICAgICBzb3VyY2UgKz0gdGV4dC5zbGljZShpbmRleCwgb2Zmc2V0KQogICAgICAgIC5yZXBsYWNlKGVzY2FwZXIsIGZ1bmN0aW9uKG1hdGNoKSB7IHJldHVybiAnXFwnICsgZXNjYXBlc1ttYXRjaF07IH0pOwogICAgICBzb3VyY2UgKz0KICAgICAgICBlc2NhcGUgPyAiJytcbigoX190PSgiICsgZXNjYXBlICsgIikpPT1udWxsPycnOl8uZXNjYXBlKF9fdCkpK1xuJyIgOgogICAgICAgIGludGVycG9sYXRlID8gIicrXG4oKF9fdD0oIiArIGludGVycG9sYXRlICsgIikpPT1udWxsPycnOl9fdCkrXG4nIiA6CiAgICAgICAgZXZhbHVhdGUgPyAiJztcbiIgKyBldmFsdWF0ZSArICJcbl9fcCs9JyIgOiAnJzsKICAgICAgaW5kZXggPSBvZmZzZXQgKyBtYXRjaC5sZW5ndGg7CiAgICB9KTsKICAgIHNvdXJjZSArPSAiJztcbiI7CgogICAgLy8gSWYgYSB2YXJpYWJsZSBpcyBub3Qgc3BlY2lmaWVkLCBwbGFjZSBkYXRhIHZhbHVlcyBpbiBsb2NhbCBzY29wZS4KICAgIGlmICghc2V0dGluZ3MudmFyaWFibGUpIHNvdXJjZSA9ICd3aXRoKG9ianx8e30pe1xuJyArIHNvdXJjZSArICd9XG4nOwoKICAgIHNvdXJjZSA9ICJ2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4sIiArCiAgICAgICJwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9O1xuIiArCiAgICAgIHNvdXJjZSArICJyZXR1cm4gX19wO1xuIjsKCiAgICB0cnkgewogICAgICB2YXIgcmVuZGVyID0gbmV3IEZ1bmN0aW9uKHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonLCAnXycsIHNvdXJjZSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGUuc291cmNlID0gc291cmNlOwogICAgICB0aHJvdyBlOwogICAgfQoKICAgIGlmIChkYXRhKSByZXR1cm4gcmVuZGVyKGRhdGEsIF8pOwogICAgdmFyIHRlbXBsYXRlID0gZnVuY3Rpb24oZGF0YSkgewogICAgICByZXR1cm4gcmVuZGVyLmNhbGwodGhpcywgZGF0YSwgXyk7CiAgICB9OwoKICAgIC8vIFByb3ZpZGUgdGhlIGNvbXBpbGVkIGZ1bmN0aW9uIHNvdXJjZSBhcyBhIGNvbnZlbmllbmNlIGZvciBwcmVjb21waWxhdGlvbi4KICAgIHRlbXBsYXRlLnNvdXJjZSA9ICdmdW5jdGlvbignICsgKHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonKSArICcpe1xuJyArIHNvdXJjZSArICd9JzsKCiAgICByZXR1cm4gdGVtcGxhdGU7CiAgfTsKCiAgLy8gQWRkIGEgImNoYWluIiBmdW5jdGlvbiwgd2hpY2ggd2lsbCBkZWxlZ2F0ZSB0byB0aGUgd3JhcHBlci4KICBfLmNoYWluID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXyhvYmopLmNoYWluKCk7CiAgfTsKCiAgLy8gT09QCiAgLy8gLS0tLS0tLS0tLS0tLS0tCiAgLy8gSWYgVW5kZXJzY29yZSBpcyBjYWxsZWQgYXMgYSBmdW5jdGlvbiwgaXQgcmV0dXJucyBhIHdyYXBwZWQgb2JqZWN0IHRoYXQKICAvLyBjYW4gYmUgdXNlZCBPTy1zdHlsZS4gVGhpcyB3cmFwcGVyIGhvbGRzIGFsdGVyZWQgdmVyc2lvbnMgb2YgYWxsIHRoZQogIC8vIHVuZGVyc2NvcmUgZnVuY3Rpb25zLiBXcmFwcGVkIG9iamVjdHMgbWF5IGJlIGNoYWluZWQuCgogIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb250aW51ZSBjaGFpbmluZyBpbnRlcm1lZGlhdGUgcmVzdWx0cy4KICB2YXIgcmVzdWx0ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gdGhpcy5fY2hhaW4gPyBfKG9iaikuY2hhaW4oKSA6IG9iajsKICB9OwoKICAvLyBBZGQgYWxsIG9mIHRoZSBVbmRlcnNjb3JlIGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlciBvYmplY3QuCiAgXy5taXhpbihfKTsKCiAgLy8gQWRkIGFsbCBtdXRhdG9yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KICBlYWNoKFsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0J10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIHZhciBtZXRob2QgPSBBcnJheVByb3RvW25hbWVdOwogICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIG9iaiA9IHRoaXMuX3dyYXBwZWQ7CiAgICAgIG1ldGhvZC5hcHBseShvYmosIGFyZ3VtZW50cyk7CiAgICAgIGlmICgobmFtZSA9PSAnc2hpZnQnIHx8IG5hbWUgPT0gJ3NwbGljZScpICYmIG9iai5sZW5ndGggPT09IDApIGRlbGV0ZSBvYmpbMF07CiAgICAgIHJldHVybiByZXN1bHQuY2FsbCh0aGlzLCBvYmopOwogICAgfTsKICB9KTsKCiAgLy8gQWRkIGFsbCBhY2Nlc3NvciBBcnJheSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIuCiAgZWFjaChbJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIHZhciBtZXRob2QgPSBBcnJheVByb3RvW25hbWVdOwogICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIG1ldGhvZC5hcHBseSh0aGlzLl93cmFwcGVkLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfSk7CgogIF8uZXh0ZW5kKF8ucHJvdG90eXBlLCB7CgogICAgLy8gU3RhcnQgY2hhaW5pbmcgYSB3cmFwcGVkIFVuZGVyc2NvcmUgb2JqZWN0LgogICAgY2hhaW46IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLl9jaGFpbiA9IHRydWU7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBFeHRyYWN0cyB0aGUgcmVzdWx0IGZyb20gYSB3cmFwcGVkIGFuZCBjaGFpbmVkIG9iamVjdC4KICAgIHZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuX3dyYXBwZWQ7CiAgICB9CgogIH0pOwoKfSkuY2FsbCh0aGlzKTsKCi8vICAgICBCYWNrYm9uZS5qcyAwLjkuOQoKLy8gICAgIChjKSAyMDEwLTIwMTIgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIEluYy4KLy8gICAgIEJhY2tib25lIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgovLyAgICAgRm9yIGFsbCBkZXRhaWxzIGFuZCBkb2N1bWVudGF0aW9uOgovLyAgICAgaHR0cDovL2JhY2tib25lanMub3JnCgooZnVuY3Rpb24oKXsKCiAgLy8gSW5pdGlhbCBTZXR1cAogIC8vIC0tLS0tLS0tLS0tLS0KCiAgLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgZ2xvYmFsIG9iamVjdCAoYHdpbmRvd2AgaW4gdGhlIGJyb3dzZXIsIGBleHBvcnRzYAogIC8vIG9uIHRoZSBzZXJ2ZXIpLgogIHZhciByb290ID0gdGhpczsKCiAgLy8gU2F2ZSB0aGUgcHJldmlvdXMgdmFsdWUgb2YgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUsIHNvIHRoYXQgaXQgY2FuIGJlCiAgLy8gcmVzdG9yZWQgbGF0ZXIgb24sIGlmIGBub0NvbmZsaWN0YCBpcyB1c2VkLgogIHZhciBwcmV2aW91c0JhY2tib25lID0gcm9vdC5CYWNrYm9uZTsKCiAgLy8gQ3JlYXRlIGEgbG9jYWwgcmVmZXJlbmNlIHRvIGFycmF5IG1ldGhvZHMuCiAgdmFyIGFycmF5ID0gW107CiAgdmFyIHB1c2ggPSBhcnJheS5wdXNoOwogIHZhciBzbGljZSA9IGFycmF5LnNsaWNlOwogIHZhciBzcGxpY2UgPSBhcnJheS5zcGxpY2U7CgogIC8vIFRoZSB0b3AtbGV2ZWwgbmFtZXNwYWNlLiBBbGwgcHVibGljIEJhY2tib25lIGNsYXNzZXMgYW5kIG1vZHVsZXMgd2lsbAogIC8vIGJlIGF0dGFjaGVkIHRvIHRoaXMuIEV4cG9ydGVkIGZvciBib3RoIENvbW1vbkpTIGFuZCB0aGUgYnJvd3Nlci4KICB2YXIgQmFja2JvbmU7CiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgQmFja2JvbmUgPSBleHBvcnRzOwogIH0gZWxzZSB7CiAgICBCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmUgPSB7fTsKICB9CgogIC8vIEN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgbGlicmFyeS4gS2VlcCBpbiBzeW5jIHdpdGggYHBhY2thZ2UuanNvbmAuCiAgQmFja2JvbmUuVkVSU0lPTiA9ICcwLjkuOSc7CgogIC8vIFJlcXVpcmUgVW5kZXJzY29yZSwgaWYgd2UncmUgb24gdGhlIHNlcnZlciwgYW5kIGl0J3Mgbm90IGFscmVhZHkgcHJlc2VudC4KICB2YXIgXyA9IHJvb3QuXzsKICBpZiAoIV8gJiYgKHR5cGVvZiByZXF1aXJlICE9PSAndW5kZWZpbmVkJykpIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyk7CgogIC8vIEZvciBCYWNrYm9uZSdzIHB1cnBvc2VzLCBqUXVlcnksIFplcHRvLCBvciBFbmRlciBvd25zIHRoZSBgJGAgdmFyaWFibGUuCiAgQmFja2JvbmUuJCA9IHJvb3QualF1ZXJ5IHx8IHJvb3QuWmVwdG8gfHwgcm9vdC5lbmRlcjsKCiAgLy8gUnVucyBCYWNrYm9uZS5qcyBpbiAqbm9Db25mbGljdCogbW9kZSwgcmV0dXJuaW5nIHRoZSBgQmFja2JvbmVgIHZhcmlhYmxlCiAgLy8gdG8gaXRzIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoaXMgQmFja2JvbmUgb2JqZWN0LgogIEJhY2tib25lLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICAgIHJvb3QuQmFja2JvbmUgPSBwcmV2aW91c0JhY2tib25lOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLy8gVHVybiBvbiBgZW11bGF0ZUhUVFBgIHRvIHN1cHBvcnQgbGVnYWN5IEhUVFAgc2VydmVycy4gU2V0dGluZyB0aGlzIG9wdGlvbgogIC8vIHdpbGwgZmFrZSBgIlBVVCJgIGFuZCBgIkRFTEVURSJgIHJlcXVlc3RzIHZpYSB0aGUgYF9tZXRob2RgIHBhcmFtZXRlciBhbmQKICAvLyBzZXQgYSBgWC1IdHRwLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgogIEJhY2tib25lLmVtdWxhdGVIVFRQID0gZmFsc2U7CgogIC8vIFR1cm4gb24gYGVtdWxhdGVKU09OYCB0byBzdXBwb3J0IGxlZ2FjeSBzZXJ2ZXJzIHRoYXQgY2FuJ3QgZGVhbCB3aXRoIGRpcmVjdAogIC8vIGBhcHBsaWNhdGlvbi9qc29uYCByZXF1ZXN0cyAuLi4gd2lsbCBlbmNvZGUgdGhlIGJvZHkgYXMKICAvLyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYCBpbnN0ZWFkIGFuZCB3aWxsIHNlbmQgdGhlIG1vZGVsIGluIGEKICAvLyBmb3JtIHBhcmFtIG5hbWVkIGBtb2RlbGAuCiAgQmFja2JvbmUuZW11bGF0ZUpTT04gPSBmYWxzZTsKCiAgLy8gQmFja2JvbmUuRXZlbnRzCiAgLy8gLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJlZ3VsYXIgZXhwcmVzc2lvbiB1c2VkIHRvIHNwbGl0IGV2ZW50IHN0cmluZ3MuCiAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLzsKCiAgLy8gSW1wbGVtZW50IGZhbmN5IGZlYXR1cmVzIG9mIHRoZSBFdmVudHMgQVBJIHN1Y2ggYXMgbXVsdGlwbGUgZXZlbnQKICAvLyBuYW1lcyBgImNoYW5nZSBibHVyImAgYW5kIGpRdWVyeS1zdHlsZSBldmVudCBtYXBzIGB7Y2hhbmdlOiBhY3Rpb259YAogIC8vIGluIHRlcm1zIG9mIHRoZSBleGlzdGluZyBBUEkuCiAgdmFyIGV2ZW50c0FwaSA9IGZ1bmN0aW9uKG9iaiwgYWN0aW9uLCBuYW1lLCByZXN0KSB7CiAgICBpZiAoIW5hbWUpIHJldHVybiB0cnVlOwogICAgaWYgKHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgewogICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZSkgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW2tleSwgbmFtZVtrZXldXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGV2ZW50U3BsaXR0ZXIudGVzdChuYW1lKSkgewogICAgICB2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW25hbWVzW2ldXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9OwoKICAvLyBPcHRpbWl6ZWQgaW50ZXJuYWwgZGlzcGF0Y2ggZnVuY3Rpb24gZm9yIHRyaWdnZXJpbmcgZXZlbnRzLiBUcmllcyB0bwogIC8vIGtlZXAgdGhlIHVzdWFsIGNhc2VzIHNwZWVkeSAobW9zdCBCYWNrYm9uZSBldmVudHMgaGF2ZSAzIGFyZ3VtZW50cykuCiAgdmFyIHRyaWdnZXJFdmVudHMgPSBmdW5jdGlvbihvYmosIGV2ZW50cywgYXJncykgewogICAgdmFyIGV2LCBpID0gLTEsIGwgPSBldmVudHMubGVuZ3RoOwogICAgc3dpdGNoIChhcmdzLmxlbmd0aCkgewogICAgY2FzZSAwOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCk7CiAgICByZXR1cm47CiAgICBjYXNlIDE6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhcmdzWzBdKTsKICAgIHJldHVybjsKICAgIGNhc2UgMjogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGFyZ3NbMF0sIGFyZ3NbMV0pOwogICAgcmV0dXJuOwogICAgY2FzZSAzOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSk7CiAgICByZXR1cm47CiAgICBkZWZhdWx0OiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5hcHBseShldi5jdHgsIGFyZ3MpOwogICAgfQogIH07CgogIC8vIEEgbW9kdWxlIHRoYXQgY2FuIGJlIG1peGVkIGluIHRvICphbnkgb2JqZWN0KiBpbiBvcmRlciB0byBwcm92aWRlIGl0IHdpdGgKICAvLyBjdXN0b20gZXZlbnRzLiBZb3UgbWF5IGJpbmQgd2l0aCBgb25gIG9yIHJlbW92ZSB3aXRoIGBvZmZgIGNhbGxiYWNrCiAgLy8gZnVuY3Rpb25zIHRvIGFuIGV2ZW50OyBgdHJpZ2dlcmAtaW5nIGFuIGV2ZW50IGZpcmVzIGFsbCBjYWxsYmFja3MgaW4KICAvLyBzdWNjZXNzaW9uLgogIC8vCiAgLy8gICAgIHZhciBvYmplY3QgPSB7fTsKICAvLyAgICAgXy5leHRlbmQob2JqZWN0LCBCYWNrYm9uZS5FdmVudHMpOwogIC8vICAgICBvYmplY3Qub24oJ2V4cGFuZCcsIGZ1bmN0aW9uKCl7IGFsZXJ0KCdleHBhbmRlZCcpOyB9KTsKICAvLyAgICAgb2JqZWN0LnRyaWdnZXIoJ2V4cGFuZCcpOwogIC8vCiAgdmFyIEV2ZW50cyA9IEJhY2tib25lLkV2ZW50cyA9IHsKCiAgICAvLyBCaW5kIG9uZSBvciBtb3JlIHNwYWNlIHNlcGFyYXRlZCBldmVudHMsIG9yIGFuIGV2ZW50cyBtYXAsCiAgICAvLyB0byBhIGBjYWxsYmFja2AgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQgdGhlIGNhbGxiYWNrIHRvCiAgICAvLyBhbGwgZXZlbnRzIGZpcmVkLgogICAgb246IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghKGV2ZW50c0FwaSh0aGlzLCAnb24nLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSAmJiBjYWxsYmFjaykpIHJldHVybiB0aGlzOwogICAgICB0aGlzLl9ldmVudHMgfHwgKHRoaXMuX2V2ZW50cyA9IHt9KTsKICAgICAgdmFyIGxpc3QgPSB0aGlzLl9ldmVudHNbbmFtZV0gfHwgKHRoaXMuX2V2ZW50c1tuYW1lXSA9IFtdKTsKICAgICAgbGlzdC5wdXNoKHtjYWxsYmFjazogY2FsbGJhY2ssIGNvbnRleHQ6IGNvbnRleHQsIGN0eDogY29udGV4dCB8fCB0aGlzfSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBCaW5kIGV2ZW50cyB0byBvbmx5IGJlIHRyaWdnZXJlZCBhIHNpbmdsZSB0aW1lLiBBZnRlciB0aGUgZmlyc3QgdGltZQogICAgLy8gdGhlIGNhbGxiYWNrIGlzIGludm9rZWQsIGl0IHdpbGwgYmUgcmVtb3ZlZC4KICAgIG9uY2U6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghKGV2ZW50c0FwaSh0aGlzLCAnb25jZScsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pICYmIGNhbGxiYWNrKSkgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIG9uY2UgPSBfLm9uY2UoZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5vZmYobmFtZSwgb25jZSk7CiAgICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSk7CiAgICAgIG9uY2UuX2NhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgIHRoaXMub24obmFtZSwgb25jZSwgY29udGV4dCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBSZW1vdmUgb25lIG9yIG1hbnkgY2FsbGJhY2tzLiBJZiBgY29udGV4dGAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKICAgIC8vIGNhbGxiYWNrcyB3aXRoIHRoYXQgZnVuY3Rpb24uIElmIGBjYWxsYmFja2AgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKICAgIC8vIGNhbGxiYWNrcyBmb3IgdGhlIGV2ZW50LiBJZiBgZXZlbnRzYCBpcyBudWxsLCByZW1vdmVzIGFsbCBib3VuZAogICAgLy8gY2FsbGJhY2tzIGZvciBhbGwgZXZlbnRzLgogICAgb2ZmOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICB2YXIgbGlzdCwgZXYsIGV2ZW50cywgbmFtZXMsIGksIGwsIGosIGs7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzIHx8ICFldmVudHNBcGkodGhpcywgJ29mZicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCFuYW1lICYmICFjYWxsYmFjayAmJiAhY29udGV4dCkgewogICAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CgogICAgICBuYW1lcyA9IG5hbWUgPyBbbmFtZV0gOiBfLmtleXModGhpcy5fZXZlbnRzKTsKICAgICAgZm9yIChpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG5hbWUgPSBuYW1lc1tpXTsKICAgICAgICBpZiAobGlzdCA9IHRoaXMuX2V2ZW50c1tuYW1lXSkgewogICAgICAgICAgZXZlbnRzID0gW107CiAgICAgICAgICBpZiAoY2FsbGJhY2sgfHwgY29udGV4dCkgewogICAgICAgICAgICBmb3IgKGogPSAwLCBrID0gbGlzdC5sZW5ndGg7IGogPCBrOyBqKyspIHsKICAgICAgICAgICAgICBldiA9IGxpc3Rbal07CiAgICAgICAgICAgICAgaWYgKChjYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gKGV2LmNhbGxiYWNrLl9jYWxsYmFjayB8fCBldi5jYWxsYmFjaykpIHx8CiAgICAgICAgICAgICAgICAgIChjb250ZXh0ICYmIGNvbnRleHQgIT09IGV2LmNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICBldmVudHMucHVzaChldik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9ldmVudHNbbmFtZV0gPSBldmVudHM7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAvLyBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQogICAgLy8gKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgLy8gcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgdHJpZ2dlcjogZnVuY3Rpb24obmFtZSkgewogICAgICBpZiAoIXRoaXMuX2V2ZW50cykgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAndHJpZ2dlcicsIG5hbWUsIGFyZ3MpKSByZXR1cm4gdGhpczsKICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgdmFyIGFsbEV2ZW50cyA9IHRoaXMuX2V2ZW50cy5hbGw7CiAgICAgIGlmIChldmVudHMpIHRyaWdnZXJFdmVudHModGhpcywgZXZlbnRzLCBhcmdzKTsKICAgICAgaWYgKGFsbEV2ZW50cykgdHJpZ2dlckV2ZW50cyh0aGlzLCBhbGxFdmVudHMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBBbiBpbnZlcnNpb24tb2YtY29udHJvbCB2ZXJzaW9uIG9mIGBvbmAuIFRlbGwgKnRoaXMqIG9iamVjdCB0byBsaXN0ZW4gdG8KICAgIC8vIGFuIGV2ZW50IGluIGFub3RoZXIgb2JqZWN0IC4uLiBrZWVwaW5nIHRyYWNrIG9mIHdoYXQgaXQncyBsaXN0ZW5pbmcgdG8uCiAgICBsaXN0ZW5UbzogZnVuY3Rpb24ob2JqZWN0LCBldmVudHMsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnMgfHwgKHRoaXMuX2xpc3RlbmVycyA9IHt9KTsKICAgICAgdmFyIGlkID0gb2JqZWN0Ll9saXN0ZW5lcklkIHx8IChvYmplY3QuX2xpc3RlbmVySWQgPSBfLnVuaXF1ZUlkKCdsJykpOwogICAgICBsaXN0ZW5lcnNbaWRdID0gb2JqZWN0OwogICAgICBvYmplY3Qub24oZXZlbnRzLCBjYWxsYmFjayB8fCB0aGlzLCB0aGlzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFRlbGwgdGhpcyBvYmplY3QgdG8gc3RvcCBsaXN0ZW5pbmcgdG8gZWl0aGVyIHNwZWNpZmljIGV2ZW50cyAuLi4gb3IKICAgIC8vIHRvIGV2ZXJ5IG9iamVjdCBpdCdzIGN1cnJlbnRseSBsaXN0ZW5pbmcgdG8uCiAgICBzdG9wTGlzdGVuaW5nOiBmdW5jdGlvbihvYmplY3QsIGV2ZW50cywgY2FsbGJhY2spIHsKICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVyczsKICAgICAgaWYgKCFsaXN0ZW5lcnMpIHJldHVybjsKICAgICAgaWYgKG9iamVjdCkgewogICAgICAgIG9iamVjdC5vZmYoZXZlbnRzLCBjYWxsYmFjaywgdGhpcyk7CiAgICAgICAgaWYgKCFldmVudHMgJiYgIWNhbGxiYWNrKSBkZWxldGUgbGlzdGVuZXJzW29iamVjdC5fbGlzdGVuZXJJZF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yICh2YXIgaWQgaW4gbGlzdGVuZXJzKSB7CiAgICAgICAgICBsaXN0ZW5lcnNbaWRdLm9mZihudWxsLCBudWxsLCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fbGlzdGVuZXJzID0ge307CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgfTsKCiAgLy8gQWxpYXNlcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCiAgRXZlbnRzLmJpbmQgICA9IEV2ZW50cy5vbjsKICBFdmVudHMudW5iaW5kID0gRXZlbnRzLm9mZjsKCiAgLy8gQWxsb3cgdGhlIGBCYWNrYm9uZWAgb2JqZWN0IHRvIHNlcnZlIGFzIGEgZ2xvYmFsIGV2ZW50IGJ1cywgZm9yIGZvbGtzIHdobwogIC8vIHdhbnQgZ2xvYmFsICJwdWJzdWIiIGluIGEgY29udmVuaWVudCBwbGFjZS4KICBfLmV4dGVuZChCYWNrYm9uZSwgRXZlbnRzKTsKCiAgLy8gQmFja2JvbmUuTW9kZWwKICAvLyAtLS0tLS0tLS0tLS0tLQoKICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwsIHdpdGggZGVmaW5lZCBhdHRyaWJ1dGVzLiBBIGNsaWVudCBpZCAoYGNpZGApCiAgLy8gaXMgYXV0b21hdGljYWxseSBnZW5lcmF0ZWQgYW5kIGFzc2lnbmVkIGZvciB5b3UuCiAgdmFyIE1vZGVsID0gQmFja2JvbmUuTW9kZWwgPSBmdW5jdGlvbihhdHRyaWJ1dGVzLCBvcHRpb25zKSB7CiAgICB2YXIgZGVmYXVsdHM7CiAgICB2YXIgYXR0cnMgPSBhdHRyaWJ1dGVzIHx8IHt9OwogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjJyk7CiAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwogICAgdGhpcy5fY2hhbmdlcyA9IFtdOwogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5jb2xsZWN0aW9uKSB0aGlzLmNvbGxlY3Rpb24gPSBvcHRpb25zLmNvbGxlY3Rpb247CiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnBhcnNlKSBhdHRycyA9IHRoaXMucGFyc2UoYXR0cnMpOwogICAgaWYgKGRlZmF1bHRzID0gXy5yZXN1bHQodGhpcywgJ2RlZmF1bHRzJykpIF8uZGVmYXVsdHMoYXR0cnMsIGRlZmF1bHRzKTsKICAgIHRoaXMuc2V0KGF0dHJzLCB7c2lsZW50OiB0cnVlfSk7CiAgICB0aGlzLl9jdXJyZW50QXR0cmlidXRlcyA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CgogIC8vIEF0dGFjaCBhbGwgaW5oZXJpdGFibGUgbWV0aG9kcyB0byB0aGUgTW9kZWwgcHJvdG90eXBlLgogIF8uZXh0ZW5kKE1vZGVsLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gQSBoYXNoIG9mIGF0dHJpYnV0ZXMgd2hvc2UgY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWUgZGlmZmVyLgogICAgY2hhbmdlZDogbnVsbCwKCiAgICAvLyBUaGUgZGVmYXVsdCBuYW1lIGZvciB0aGUgSlNPTiBgaWRgIGF0dHJpYnV0ZSBpcyBgImlkImAuIE1vbmdvREIgYW5kCiAgICAvLyBDb3VjaERCIHVzZXJzIG1heSB3YW50IHRvIHNldCB0aGlzIHRvIGAiX2lkImAuCiAgICBpZEF0dHJpYnV0ZTogJ2lkJywKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG1vZGVsJ3MgYGF0dHJpYnV0ZXNgIG9iamVjdC4KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGdldDogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIEhUTUwtZXNjYXBlZCB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCiAgICBlc2NhcGU6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uZXNjYXBlKHRoaXMuZ2V0KGF0dHIpKTsKICAgIH0sCgogICAgLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF0dHJpYnV0ZSBjb250YWlucyBhIHZhbHVlIHRoYXQgaXMgbm90IG51bGwKICAgIC8vIG9yIHVuZGVmaW5lZC4KICAgIGhhczogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5nZXQoYXR0cikgIT0gbnVsbDsKICAgIH0sCgogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzIG9uIHRoZSBvYmplY3QsIGZpcmluZyBgImNoYW5nZSJgIHVubGVzcwogICAgLy8geW91IGNob29zZSB0byBzaWxlbmNlIGl0LgogICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgb3B0aW9ucykgewogICAgICB2YXIgYXR0ciwgYXR0cnM7CiAgICAgIGlmIChrZXkgPT0gbnVsbCkgcmV0dXJuIHRoaXM7CgogICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KICAgICAgaWYgKF8uaXNPYmplY3Qoa2V5KSkgewogICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgIH0KCiAgICAgIC8vIEV4dHJhY3QgYXR0cmlidXRlcyBhbmQgb3B0aW9ucy4KICAgICAgdmFyIHNpbGVudCA9IG9wdGlvbnMgJiYgb3B0aW9ucy5zaWxlbnQ7CiAgICAgIHZhciB1bnNldCA9IG9wdGlvbnMgJiYgb3B0aW9ucy51bnNldDsKCiAgICAgIC8vIFJ1biB2YWxpZGF0aW9uLgogICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwoKICAgICAgLy8gQ2hlY2sgZm9yIGNoYW5nZXMgb2YgYGlkYC4KICAgICAgaWYgKHRoaXMuaWRBdHRyaWJ1dGUgaW4gYXR0cnMpIHRoaXMuaWQgPSBhdHRyc1t0aGlzLmlkQXR0cmlidXRlXTsKCiAgICAgIHZhciBub3cgPSB0aGlzLmF0dHJpYnV0ZXM7CgogICAgICAvLyBGb3IgZWFjaCBgc2V0YCBhdHRyaWJ1dGUuLi4KICAgICAgZm9yIChhdHRyIGluIGF0dHJzKSB7CiAgICAgICAgdmFsID0gYXR0cnNbYXR0cl07CgogICAgICAgIC8vIFVwZGF0ZSBvciBkZWxldGUgdGhlIGN1cnJlbnQgdmFsdWUsIGFuZCB0cmFjayB0aGUgY2hhbmdlLgogICAgICAgIHVuc2V0ID8gZGVsZXRlIG5vd1thdHRyXSA6IG5vd1thdHRyXSA9IHZhbDsKICAgICAgICB0aGlzLl9jaGFuZ2VzLnB1c2goYXR0ciwgdmFsKTsKICAgICAgfQoKICAgICAgLy8gU2lnbmFsIHRoYXQgdGhlIG1vZGVsJ3Mgc3RhdGUgaGFzIHBvdGVudGlhbGx5IGNoYW5nZWQsIGFuZCB3ZSBuZWVkCiAgICAgIC8vIHRvIHJlY29tcHV0ZSB0aGUgYWN0dWFsIGNoYW5nZXMuCiAgICAgIHRoaXMuX2hhc0NvbXB1dGVkID0gZmFsc2U7CgogICAgICAvLyBGaXJlIHRoZSBgImNoYW5nZSJgIGV2ZW50cy4KICAgICAgaWYgKCFzaWxlbnQpIHRoaXMuY2hhbmdlKG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUmVtb3ZlIGFuIGF0dHJpYnV0ZSBmcm9tIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAgdW5sZXNzIHlvdSBjaG9vc2UKICAgIC8vIHRvIHNpbGVuY2UgaXQuIGB1bnNldGAgaXMgYSBub29wIGlmIHRoZSBhdHRyaWJ1dGUgZG9lc24ndCBleGlzdC4KICAgIHVuc2V0OiBmdW5jdGlvbihhdHRyLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLnNldChhdHRyLCB2b2lkIDAsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7CiAgICB9LAoKICAgIC8vIENsZWFyIGFsbCBhdHRyaWJ1dGVzIG9uIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAgdW5sZXNzIHlvdSBjaG9vc2UKICAgIC8vIHRvIHNpbGVuY2UgaXQuCiAgICBjbGVhcjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgYXR0cnMgPSB7fTsKICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuYXR0cmlidXRlcykgYXR0cnNba2V5XSA9IHZvaWQgMDsKICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHJzLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3Vuc2V0OiB0cnVlfSkpOwogICAgfSwKCiAgICAvLyBGZXRjaCB0aGUgbW9kZWwgZnJvbSB0aGUgc2VydmVyLiBJZiB0aGUgc2VydmVyJ3MgcmVwcmVzZW50YXRpb24gb2YgdGhlCiAgICAvLyBtb2RlbCBkaWZmZXJzIGZyb20gaXRzIGN1cnJlbnQgYXR0cmlidXRlcywgdGhleSB3aWxsIGJlIG92ZXJyaWRlbiwKICAgIC8vIHRyaWdnZXJpbmcgYSBgImNoYW5nZSJgIGV2ZW50LgogICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCwgc3RhdHVzLCB4aHIpIHsKICAgICAgICBpZiAoIW1vZGVsLnNldChtb2RlbC5wYXJzZShyZXNwKSwgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKICAgIH0sCgogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzLCBhbmQgc3luYyB0aGUgbW9kZWwgdG8gdGhlIHNlcnZlci4KICAgIC8vIElmIHRoZSBzZXJ2ZXIgcmV0dXJucyBhbiBhdHRyaWJ1dGVzIGhhc2ggdGhhdCBkaWZmZXJzLCB0aGUgbW9kZWwncwogICAgLy8gc3RhdGUgd2lsbCBiZSBgc2V0YCBhZ2Fpbi4KICAgIHNhdmU6IGZ1bmN0aW9uKGtleSwgdmFsLCBvcHRpb25zKSB7CiAgICAgIHZhciBhdHRycywgY3VycmVudCwgZG9uZTsKCiAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgogICAgICBpZiAoa2V5ID09IG51bGwgfHwgXy5pc09iamVjdChrZXkpKSB7CiAgICAgICAgYXR0cnMgPSBrZXk7CiAgICAgICAgb3B0aW9ucyA9IHZhbDsKICAgICAgfSBlbHNlIGlmIChrZXkgIT0gbnVsbCkgewogICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwogICAgICB9CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwoKICAgICAgLy8gSWYgd2UncmUgIndhaXQiLWluZyB0byBzZXQgY2hhbmdlZCBhdHRyaWJ1dGVzLCB2YWxpZGF0ZSBlYXJseS4KICAgICAgaWYgKG9wdGlvbnMud2FpdCkgewogICAgICAgIGlmIChhdHRycyAmJiAhdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgY3VycmVudCA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgfQoKICAgICAgLy8gUmVndWxhciBzYXZlcyBgc2V0YCBhdHRyaWJ1dGVzIGJlZm9yZSBwZXJzaXN0aW5nIHRvIHRoZSBzZXJ2ZXIuCiAgICAgIHZhciBzaWxlbnRPcHRpb25zID0gXy5leHRlbmQoe30sIG9wdGlvbnMsIHtzaWxlbnQ6IHRydWV9KTsKICAgICAgaWYgKGF0dHJzICYmICF0aGlzLnNldChhdHRycywgb3B0aW9ucy53YWl0ID8gc2lsZW50T3B0aW9ucyA6IG9wdGlvbnMpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICAvLyBEbyBub3QgcGVyc2lzdCBpbnZhbGlkIG1vZGVscy4KICAgICAgaWYgKCFhdHRycyAmJiAhdGhpcy5fdmFsaWRhdGUobnVsbCwgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKCiAgICAgIC8vIEFmdGVyIGEgc3VjY2Vzc2Z1bCBzZXJ2ZXItc2lkZSBzYXZlLCB0aGUgY2xpZW50IGlzIChvcHRpb25hbGx5KQogICAgICAvLyB1cGRhdGVkIHdpdGggdGhlIHNlcnZlci1zaWRlIHN0YXRlLgogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCwgc3RhdHVzLCB4aHIpIHsKICAgICAgICBkb25lID0gdHJ1ZTsKICAgICAgICB2YXIgc2VydmVyQXR0cnMgPSBtb2RlbC5wYXJzZShyZXNwKTsKICAgICAgICBpZiAob3B0aW9ucy53YWl0KSBzZXJ2ZXJBdHRycyA9IF8uZXh0ZW5kKGF0dHJzIHx8IHt9LCBzZXJ2ZXJBdHRycyk7CiAgICAgICAgaWYgKCFtb2RlbC5zZXQoc2VydmVyQXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwoKICAgICAgLy8gRmluaXNoIGNvbmZpZ3VyaW5nIGFuZCBzZW5kaW5nIHRoZSBBamF4IHJlcXVlc3QuCiAgICAgIHZhciBtZXRob2QgPSB0aGlzLmlzTmV3KCkgPyAnY3JlYXRlJyA6IChvcHRpb25zLnBhdGNoID8gJ3BhdGNoJyA6ICd1cGRhdGUnKTsKICAgICAgaWYgKG1ldGhvZCA9PSAncGF0Y2gnKSBvcHRpb25zLmF0dHJzID0gYXR0cnM7CiAgICAgIHZhciB4aHIgPSB0aGlzLnN5bmMobWV0aG9kLCB0aGlzLCBvcHRpb25zKTsKCiAgICAgIC8vIFdoZW4gdXNpbmcgYHdhaXRgLCByZXNldCBhdHRyaWJ1dGVzIHRvIG9yaWdpbmFsIHZhbHVlcyB1bmxlc3MKICAgICAgLy8gYHN1Y2Nlc3NgIGhhcyBiZWVuIGNhbGxlZCBhbHJlYWR5LgogICAgICBpZiAoIWRvbmUgJiYgb3B0aW9ucy53YWl0KSB7CiAgICAgICAgdGhpcy5jbGVhcihzaWxlbnRPcHRpb25zKTsKICAgICAgICB0aGlzLnNldChjdXJyZW50LCBzaWxlbnRPcHRpb25zKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCgogICAgLy8gRGVzdHJveSB0aGlzIG1vZGVsIG9uIHRoZSBzZXJ2ZXIgaWYgaXQgd2FzIGFscmVhZHkgcGVyc2lzdGVkLgogICAgLy8gT3B0aW1pc3RpY2FsbHkgcmVtb3ZlcyB0aGUgbW9kZWwgZnJvbSBpdHMgY29sbGVjdGlvbiwgaWYgaXQgaGFzIG9uZS4KICAgIC8vIElmIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIHdhaXRzIGZvciB0aGUgc2VydmVyIHRvIHJlc3BvbmQgYmVmb3JlIHJlbW92YWwuCiAgICBkZXN0cm95OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKCiAgICAgIHZhciBkZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbW9kZWwudHJpZ2dlcignZGVzdHJveScsIG1vZGVsLCBtb2RlbC5jb2xsZWN0aW9uLCBvcHRpb25zKTsKICAgICAgfTsKCiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICBpZiAob3B0aW9ucy53YWl0IHx8IG1vZGVsLmlzTmV3KCkpIGRlc3Ryb3koKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CgogICAgICBpZiAodGhpcy5pc05ldygpKSB7CiAgICAgICAgb3B0aW9ucy5zdWNjZXNzKCk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICB2YXIgeGhyID0gdGhpcy5zeW5jKCdkZWxldGUnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgaWYgKCFvcHRpb25zLndhaXQpIGRlc3Ryb3koKTsKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCgogICAgLy8gRGVmYXVsdCBVUkwgZm9yIHRoZSBtb2RlbCdzIHJlcHJlc2VudGF0aW9uIG9uIHRoZSBzZXJ2ZXIgLS0gaWYgeW91J3JlCiAgICAvLyB1c2luZyBCYWNrYm9uZSdzIHJlc3RmdWwgbWV0aG9kcywgb3ZlcnJpZGUgdGhpcyB0byBjaGFuZ2UgdGhlIGVuZHBvaW50CiAgICAvLyB0aGF0IHdpbGwgYmUgY2FsbGVkLgogICAgdXJsOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGJhc2UgPSBfLnJlc3VsdCh0aGlzLCAndXJsUm9vdCcpIHx8IF8ucmVzdWx0KHRoaXMuY29sbGVjdGlvbiwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHJldHVybiBiYXNlOwogICAgICByZXR1cm4gYmFzZSArIChiYXNlLmNoYXJBdChiYXNlLmxlbmd0aCAtIDEpID09PSAnLycgPyAnJyA6ICcvJykgKyBlbmNvZGVVUklDb21wb25lbnQodGhpcy5pZCk7CiAgICB9LAoKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gdGhlIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBgc2V0YCBvbgogICAgLy8gdGhlIG1vZGVsLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgdGhlIHJlc3BvbnNlIGFsb25nLgogICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgcmV0dXJuIHJlc3A7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIGlkZW50aWNhbCBhdHRyaWJ1dGVzIHRvIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5hdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gQSBtb2RlbCBpcyBuZXcgaWYgaXQgaGFzIG5ldmVyIGJlZW4gc2F2ZWQgdG8gdGhlIHNlcnZlciwgYW5kIGxhY2tzIGFuIGlkLgogICAgaXNOZXc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5pZCA9PSBudWxsOwogICAgfSwKCiAgICAvLyBDYWxsIHRoaXMgbWV0aG9kIHRvIG1hbnVhbGx5IGZpcmUgYSBgImNoYW5nZSJgIGV2ZW50IGZvciB0aGlzIG1vZGVsIGFuZAogICAgLy8gYSBgImNoYW5nZTphdHRyaWJ1dGUiYCBldmVudCBmb3IgZWFjaCBjaGFuZ2VkIGF0dHJpYnV0ZS4KICAgIC8vIENhbGxpbmcgdGhpcyB3aWxsIGNhdXNlIGFsbCBvYmplY3RzIG9ic2VydmluZyB0aGUgbW9kZWwgdG8gdXBkYXRlLgogICAgY2hhbmdlOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBjaGFuZ2luZyA9IHRoaXMuX2NoYW5naW5nOwogICAgICB0aGlzLl9jaGFuZ2luZyA9IHRydWU7CgogICAgICAvLyBHZW5lcmF0ZSB0aGUgY2hhbmdlcyB0byBiZSB0cmlnZ2VyZWQgb24gdGhlIG1vZGVsLgogICAgICB2YXIgdHJpZ2dlcnMgPSB0aGlzLl9jb21wdXRlQ2hhbmdlcyh0cnVlKTsKCiAgICAgIHRoaXMuX3BlbmRpbmcgPSAhIXRyaWdnZXJzLmxlbmd0aDsKCiAgICAgIGZvciAodmFyIGkgPSB0cmlnZ2Vycy5sZW5ndGggLSAyOyBpID49IDA7IGkgLT0gMikgewogICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyB0cmlnZ2Vyc1tpXSwgdGhpcywgdHJpZ2dlcnNbaSArIDFdLCBvcHRpb25zKTsKICAgICAgfQoKICAgICAgaWYgKGNoYW5naW5nKSByZXR1cm4gdGhpczsKCiAgICAgIC8vIFRyaWdnZXIgYSBgY2hhbmdlYCB3aGlsZSB0aGVyZSBoYXZlIGJlZW4gY2hhbmdlcy4KICAgICAgd2hpbGUgKHRoaXMuX3BlbmRpbmcpIHsKICAgICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2UnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgIH0KCiAgICAgIHRoaXMuX2NoYW5naW5nID0gZmFsc2U7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBEZXRlcm1pbmUgaWYgdGhlIG1vZGVsIGhhcyBjaGFuZ2VkIHNpbmNlIHRoZSBsYXN0IGAiY2hhbmdlImAgZXZlbnQuCiAgICAvLyBJZiB5b3Ugc3BlY2lmeSBhbiBhdHRyaWJ1dGUgbmFtZSwgZGV0ZXJtaW5lIGlmIHRoYXQgYXR0cmlidXRlIGhhcyBjaGFuZ2VkLgogICAgaGFzQ2hhbmdlZDogZnVuY3Rpb24oYXR0cikgewogICAgICBpZiAoIXRoaXMuX2hhc0NvbXB1dGVkKSB0aGlzLl9jb21wdXRlQ2hhbmdlcygpOwogICAgICBpZiAoYXR0ciA9PSBudWxsKSByZXR1cm4gIV8uaXNFbXB0eSh0aGlzLmNoYW5nZWQpOwogICAgICByZXR1cm4gXy5oYXModGhpcy5jaGFuZ2VkLCBhdHRyKTsKICAgIH0sCgogICAgLy8gUmV0dXJuIGFuIG9iamVjdCBjb250YWluaW5nIGFsbCB0aGUgYXR0cmlidXRlcyB0aGF0IGhhdmUgY2hhbmdlZCwgb3IKICAgIC8vIGZhbHNlIGlmIHRoZXJlIGFyZSBubyBjaGFuZ2VkIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3IgZGV0ZXJtaW5pbmcgd2hhdAogICAgLy8gcGFydHMgb2YgYSB2aWV3IG5lZWQgdG8gYmUgdXBkYXRlZCBhbmQvb3Igd2hhdCBhdHRyaWJ1dGVzIG5lZWQgdG8gYmUKICAgIC8vIHBlcnNpc3RlZCB0byB0aGUgc2VydmVyLiBVbnNldCBhdHRyaWJ1dGVzIHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgIC8vIFlvdSBjYW4gYWxzbyBwYXNzIGFuIGF0dHJpYnV0ZXMgb2JqZWN0IHRvIGRpZmYgYWdhaW5zdCB0aGUgbW9kZWwsCiAgICAvLyBkZXRlcm1pbmluZyBpZiB0aGVyZSAqd291bGQgYmUqIGEgY2hhbmdlLgogICAgY2hhbmdlZEF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGRpZmYpIHsKICAgICAgaWYgKCFkaWZmKSByZXR1cm4gdGhpcy5oYXNDaGFuZ2VkKCkgPyBfLmNsb25lKHRoaXMuY2hhbmdlZCkgOiBmYWxzZTsKICAgICAgdmFyIHZhbCwgY2hhbmdlZCA9IGZhbHNlLCBvbGQgPSB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXM7CiAgICAgIGZvciAodmFyIGF0dHIgaW4gZGlmZikgewogICAgICAgIGlmIChfLmlzRXF1YWwob2xkW2F0dHJdLCAodmFsID0gZGlmZlthdHRyXSkpKSBjb250aW51ZTsKICAgICAgICAoY2hhbmdlZCB8fCAoY2hhbmdlZCA9IHt9KSlbYXR0cl0gPSB2YWw7CiAgICAgIH0KICAgICAgcmV0dXJuIGNoYW5nZWQ7CiAgICB9LAoKICAgIC8vIExvb2tpbmcgYXQgdGhlIGJ1aWx0IHVwIGxpc3Qgb2YgYHNldGAgYXR0cmlidXRlIGNoYW5nZXMsIGNvbXB1dGUgaG93CiAgICAvLyBtYW55IG9mIHRoZSBhdHRyaWJ1dGVzIGhhdmUgYWN0dWFsbHkgY2hhbmdlZC4gSWYgYGxvdWRgLCByZXR1cm4gYQogICAgLy8gYm9pbGVkLWRvd24gbGlzdCBvZiBvbmx5IHRoZSByZWFsIGNoYW5nZXMuCiAgICBfY29tcHV0ZUNoYW5nZXM6IGZ1bmN0aW9uKGxvdWQpIHsKICAgICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICAgIHZhciBhbHJlYWR5ID0ge307CiAgICAgIHZhciB0cmlnZ2VycyA9IFtdOwogICAgICB2YXIgY3VycmVudCA9IHRoaXMuX2N1cnJlbnRBdHRyaWJ1dGVzOwogICAgICB2YXIgY2hhbmdlcyA9IHRoaXMuX2NoYW5nZXM7CgogICAgICAvLyBMb29wIHRocm91Z2ggdGhlIGN1cnJlbnQgcXVldWUgb2YgcG90ZW50aWFsIG1vZGVsIGNoYW5nZXMuCiAgICAgIGZvciAodmFyIGkgPSBjaGFuZ2VzLmxlbmd0aCAtIDI7IGkgPj0gMDsgaSAtPSAyKSB7CiAgICAgICAgdmFyIGtleSA9IGNoYW5nZXNbaV0sIHZhbCA9IGNoYW5nZXNbaSArIDFdOwogICAgICAgIGlmIChhbHJlYWR5W2tleV0pIGNvbnRpbnVlOwogICAgICAgIGFscmVhZHlba2V5XSA9IHRydWU7CgogICAgICAgIC8vIENoZWNrIGlmIHRoZSBhdHRyaWJ1dGUgaGFzIGJlZW4gbW9kaWZpZWQgc2luY2UgdGhlIGxhc3QgY2hhbmdlLAogICAgICAgIC8vIGFuZCB1cGRhdGUgYHRoaXMuY2hhbmdlZGAgYWNjb3JkaW5nbHkuIElmIHdlJ3JlIGluc2lkZSBvZiBhIGBjaGFuZ2VgCiAgICAgICAgLy8gY2FsbCwgYWxzbyBhZGQgYSB0cmlnZ2VyIHRvIHRoZSBsaXN0LgogICAgICAgIGlmIChjdXJyZW50W2tleV0gIT09IHZhbCkgewogICAgICAgICAgdGhpcy5jaGFuZ2VkW2tleV0gPSB2YWw7CiAgICAgICAgICBpZiAoIWxvdWQpIGNvbnRpbnVlOwogICAgICAgICAgdHJpZ2dlcnMucHVzaChrZXksIHZhbCk7CiAgICAgICAgICBjdXJyZW50W2tleV0gPSB2YWw7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChsb3VkKSB0aGlzLl9jaGFuZ2VzID0gW107CgogICAgICAvLyBTaWduYWxzIGB0aGlzLmNoYW5nZWRgIGlzIGN1cnJlbnQgdG8gcHJldmVudCBkdXBsaWNhdGUgY2FsbHMgZnJvbSBgdGhpcy5oYXNDaGFuZ2VkYC4KICAgICAgdGhpcy5faGFzQ29tcHV0ZWQgPSB0cnVlOwogICAgICByZXR1cm4gdHJpZ2dlcnM7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgcHJldmlvdXMgdmFsdWUgb2YgYW4gYXR0cmlidXRlLCByZWNvcmRlZCBhdCB0aGUgdGltZSB0aGUgbGFzdAogICAgLy8gYCJjaGFuZ2UiYCBldmVudCB3YXMgZmlyZWQuCiAgICBwcmV2aW91czogZnVuY3Rpb24oYXR0cikgewogICAgICBpZiAoYXR0ciA9PSBudWxsIHx8ICF0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpIHJldHVybiBudWxsOwogICAgICByZXR1cm4gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgYWxsIG9mIHRoZSBhdHRyaWJ1dGVzIG9mIHRoZSBtb2RlbCBhdCB0aGUgdGltZSBvZiB0aGUgcHJldmlvdXMKICAgIC8vIGAiY2hhbmdlImAgZXZlbnQuCiAgICBwcmV2aW91c0F0dHJpYnV0ZXM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBSdW4gdmFsaWRhdGlvbiBhZ2FpbnN0IHRoZSBuZXh0IGNvbXBsZXRlIHNldCBvZiBtb2RlbCBhdHRyaWJ1dGVzLAogICAgLy8gcmV0dXJuaW5nIGB0cnVlYCBpZiBhbGwgaXMgd2VsbC4gSWYgYSBzcGVjaWZpYyBgZXJyb3JgIGNhbGxiYWNrIGhhcwogICAgLy8gYmVlbiBwYXNzZWQsIGNhbGwgdGhhdCBpbnN0ZWFkIG9mIGZpcmluZyB0aGUgZ2VuZXJhbCBgImVycm9yImAgZXZlbnQuCiAgICBfdmFsaWRhdGU6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgIGlmICghdGhpcy52YWxpZGF0ZSkgcmV0dXJuIHRydWU7CiAgICAgIGF0dHJzID0gXy5leHRlbmQoe30sIHRoaXMuYXR0cmlidXRlcywgYXR0cnMpOwogICAgICB2YXIgZXJyb3IgPSB0aGlzLnZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKTsKICAgICAgaWYgKCFlcnJvcikgcmV0dXJuIHRydWU7CiAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuZXJyb3IpIG9wdGlvbnMuZXJyb3IodGhpcywgZXJyb3IsIG9wdGlvbnMpOwogICAgICB0aGlzLnRyaWdnZXIoJ2Vycm9yJywgdGhpcywgZXJyb3IsIG9wdGlvbnMpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5Db2xsZWN0aW9uCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBQcm92aWRlcyBhIHN0YW5kYXJkIGNvbGxlY3Rpb24gY2xhc3MgZm9yIG91ciBzZXRzIG9mIG1vZGVscywgb3JkZXJlZAogIC8vIG9yIHVub3JkZXJlZC4gSWYgYSBgY29tcGFyYXRvcmAgaXMgc3BlY2lmaWVkLCB0aGUgQ29sbGVjdGlvbiB3aWxsIG1haW50YWluCiAgLy8gaXRzIG1vZGVscyBpbiBzb3J0IG9yZGVyLCBhcyB0aGV5J3JlIGFkZGVkIGFuZCByZW1vdmVkLgogIHZhciBDb2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIGlmIChvcHRpb25zLm1vZGVsKSB0aGlzLm1vZGVsID0gb3B0aW9ucy5tb2RlbDsKICAgIGlmIChvcHRpb25zLmNvbXBhcmF0b3IgIT09IHZvaWQgMCkgdGhpcy5jb21wYXJhdG9yID0gb3B0aW9ucy5jb21wYXJhdG9yOwogICAgdGhpcy5fcmVzZXQoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKG1vZGVscykgdGhpcy5yZXNldChtb2RlbHMsIF8uZXh0ZW5kKHtzaWxlbnQ6IHRydWV9LCBvcHRpb25zKSk7CiAgfTsKCiAgLy8gRGVmaW5lIHRoZSBDb2xsZWN0aW9uJ3MgaW5oZXJpdGFibGUgbWV0aG9kcy4KICBfLmV4dGVuZChDb2xsZWN0aW9uLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgbW9kZWwgZm9yIGEgY29sbGVjdGlvbiBpcyBqdXN0IGEgKipCYWNrYm9uZS5Nb2RlbCoqLgogICAgLy8gVGhpcyBzaG91bGQgYmUgb3ZlcnJpZGRlbiBpbiBtb3N0IGNhc2VzLgogICAgbW9kZWw6IE1vZGVsLAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gVGhlIEpTT04gcmVwcmVzZW50YXRpb24gb2YgYSBDb2xsZWN0aW9uIGlzIGFuIGFycmF5IG9mIHRoZQogICAgLy8gbW9kZWxzJyBhdHRyaWJ1dGVzLgogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbihtb2RlbCl7IHJldHVybiBtb2RlbC50b0pTT04ob3B0aW9ucyk7IH0pOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCwgb3IgbGlzdCBvZiBtb2RlbHMgdG8gdGhlIHNldC4gUGFzcyAqKnNpbGVudCoqIHRvIGF2b2lkCiAgICAvLyBmaXJpbmcgdGhlIGBhZGRgIGV2ZW50IGZvciBldmVyeSBuZXcgbW9kZWwuCiAgICBhZGQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICB2YXIgaSwgYXJncywgbGVuZ3RoLCBtb2RlbCwgZXhpc3RpbmcsIG5lZWRzU29ydDsKICAgICAgdmFyIGF0ID0gb3B0aW9ucyAmJiBvcHRpb25zLmF0OwogICAgICB2YXIgc29ydCA9ICgob3B0aW9ucyAmJiBvcHRpb25zLnNvcnQpID09IG51bGwgPyB0cnVlIDogb3B0aW9ucy5zb3J0KTsKICAgICAgbW9kZWxzID0gXy5pc0FycmF5KG1vZGVscykgPyBtb2RlbHMuc2xpY2UoKSA6IFttb2RlbHNdOwoKICAgICAgLy8gVHVybiBiYXJlIG9iamVjdHMgaW50byBtb2RlbCByZWZlcmVuY2VzLCBhbmQgcHJldmVudCBpbnZhbGlkIG1vZGVscwogICAgICAvLyBmcm9tIGJlaW5nIGFkZGVkLgogICAgICBmb3IgKGkgPSBtb2RlbHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICBpZighKG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsc1tpXSwgb3B0aW9ucykpKSB7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoImVycm9yIiwgdGhpcywgbW9kZWxzW2ldLCBvcHRpb25zKTsKICAgICAgICAgIG1vZGVscy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgbW9kZWxzW2ldID0gbW9kZWw7CgogICAgICAgIGV4aXN0aW5nID0gbW9kZWwuaWQgIT0gbnVsbCAmJiB0aGlzLl9ieUlkW21vZGVsLmlkXTsKICAgICAgICAvLyBJZiBhIGR1cGxpY2F0ZSBpcyBmb3VuZCwgcHJldmVudCBpdCBmcm9tIGJlaW5nIGFkZGVkIGFuZAogICAgICAgIC8vIG9wdGlvbmFsbHkgbWVyZ2UgaXQgaW50byB0aGUgZXhpc3RpbmcgbW9kZWwuCiAgICAgICAgaWYgKGV4aXN0aW5nIHx8IHRoaXMuX2J5Q2lkW21vZGVsLmNpZF0pIHsKICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMubWVyZ2UgJiYgZXhpc3RpbmcpIHsKICAgICAgICAgICAgZXhpc3Rpbmcuc2V0KG1vZGVsLmF0dHJpYnV0ZXMsIG9wdGlvbnMpOwogICAgICAgICAgICBuZWVkc1NvcnQgPSBzb3J0OwogICAgICAgICAgfQogICAgICAgICAgbW9kZWxzLnNwbGljZShpLCAxKTsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgLy8gTGlzdGVuIHRvIGFkZGVkIG1vZGVscycgZXZlbnRzLCBhbmQgaW5kZXggbW9kZWxzIGZvciBsb29rdXAgYnkKICAgICAgICAvLyBgaWRgIGFuZCBieSBgY2lkYC4KICAgICAgICBtb2RlbC5vbignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgICAgICB0aGlzLl9ieUNpZFttb2RlbC5jaWRdID0gbW9kZWw7CiAgICAgICAgaWYgKG1vZGVsLmlkICE9IG51bGwpIHRoaXMuX2J5SWRbbW9kZWwuaWRdID0gbW9kZWw7CiAgICAgIH0KCiAgICAgIC8vIFNlZSBpZiBzb3J0aW5nIGlzIG5lZWRlZCwgdXBkYXRlIGBsZW5ndGhgIGFuZCBzcGxpY2UgaW4gbmV3IG1vZGVscy4KICAgICAgaWYgKG1vZGVscy5sZW5ndGgpIG5lZWRzU29ydCA9IHNvcnQ7CiAgICAgIHRoaXMubGVuZ3RoICs9IG1vZGVscy5sZW5ndGg7CiAgICAgIGFyZ3MgPSBbYXQgIT0gbnVsbCA/IGF0IDogdGhpcy5tb2RlbHMubGVuZ3RoLCAwXTsKICAgICAgcHVzaC5hcHBseShhcmdzLCBtb2RlbHMpOwogICAgICBzcGxpY2UuYXBwbHkodGhpcy5tb2RlbHMsIGFyZ3MpOwoKICAgICAgLy8gU29ydCB0aGUgY29sbGVjdGlvbiBpZiBhcHByb3ByaWF0ZS4KICAgICAgaWYgKG5lZWRzU29ydCAmJiB0aGlzLmNvbXBhcmF0b3IgJiYgYXQgPT0gbnVsbCkgdGhpcy5zb3J0KHtzaWxlbnQ6IHRydWV9KTsKCiAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuc2lsZW50KSByZXR1cm4gdGhpczsKCiAgICAgIC8vIFRyaWdnZXIgYGFkZGAgZXZlbnRzLgogICAgICB3aGlsZSAobW9kZWwgPSBtb2RlbHMuc2hpZnQoKSkgewogICAgICAgIG1vZGVsLnRyaWdnZXIoJ2FkZCcsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsLCBvciBhIGxpc3Qgb2YgbW9kZWxzIGZyb20gdGhlIHNldC4gUGFzcyBzaWxlbnQgdG8gYXZvaWQKICAgIC8vIGZpcmluZyB0aGUgYHJlbW92ZWAgZXZlbnQgZm9yIGV2ZXJ5IG1vZGVsIHJlbW92ZWQuCiAgICByZW1vdmU6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICB2YXIgaSwgbCwgaW5kZXgsIG1vZGVsOwogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICBtb2RlbHMgPSBfLmlzQXJyYXkobW9kZWxzKSA/IG1vZGVscy5zbGljZSgpIDogW21vZGVsc107CiAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbW9kZWwgPSB0aGlzLmdldChtb2RlbHNbaV0pOwogICAgICAgIGlmICghbW9kZWwpIGNvbnRpbnVlOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmlkXTsKICAgICAgICBkZWxldGUgdGhpcy5fYnlDaWRbbW9kZWwuY2lkXTsKICAgICAgICBpbmRleCA9IHRoaXMuaW5kZXhPZihtb2RlbCk7CiAgICAgICAgdGhpcy5tb2RlbHMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB0aGlzLmxlbmd0aC0tOwogICAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHsKICAgICAgICAgIG9wdGlvbnMuaW5kZXggPSBpbmRleDsKICAgICAgICAgIG1vZGVsLnRyaWdnZXIoJ3JlbW92ZScsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKG1vZGVsKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHB1c2g6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKTsKICAgICAgdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogdGhpcy5sZW5ndGh9LCBvcHRpb25zKSk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gUmVtb3ZlIGEgbW9kZWwgZnJvbSB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgcG9wOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQodGhpcy5sZW5ndGggLSAxKTsKICAgICAgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vIEFkZCBhIG1vZGVsIHRvIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICB1bnNoaWZ0OiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICBtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHRoaXMuYWRkKG1vZGVsLCBfLmV4dGVuZCh7YXQ6IDB9LCBvcHRpb25zKSk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gUmVtb3ZlIGEgbW9kZWwgZnJvbSB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgc2hpZnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCgwKTsKICAgICAgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vIFNsaWNlIG91dCBhIHN1Yi1hcnJheSBvZiBtb2RlbHMgZnJvbSB0aGUgY29sbGVjdGlvbi4KICAgIHNsaWNlOiBmdW5jdGlvbihiZWdpbiwgZW5kKSB7CiAgICAgIHJldHVybiB0aGlzLm1vZGVscy5zbGljZShiZWdpbiwgZW5kKTsKICAgIH0sCgogICAgLy8gR2V0IGEgbW9kZWwgZnJvbSB0aGUgc2V0IGJ5IGlkLgogICAgZ2V0OiBmdW5jdGlvbihvYmopIHsKICAgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwogICAgICByZXR1cm4gdGhpcy5fYnlJZFtvYmouaWQgIT0gbnVsbCA/IG9iai5pZCA6IG9ial0gfHwgdGhpcy5fYnlDaWRbb2JqLmNpZCB8fCBvYmpdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIG1vZGVsIGF0IHRoZSBnaXZlbiBpbmRleC4KICAgIGF0OiBmdW5jdGlvbihpbmRleCkgewogICAgICByZXR1cm4gdGhpcy5tb2RlbHNbaW5kZXhdOwogICAgfSwKCiAgICAvLyBSZXR1cm4gbW9kZWxzIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMgb2YgYGZpbHRlcmAuCiAgICB3aGVyZTogZnVuY3Rpb24oYXR0cnMpIHsKICAgICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBbXTsKICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gbW9kZWwuZ2V0KGtleSkpIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBGb3JjZSB0aGUgY29sbGVjdGlvbiB0byByZS1zb3J0IGl0c2VsZi4gWW91IGRvbid0IG5lZWQgdG8gY2FsbCB0aGlzIHVuZGVyCiAgICAvLyBub3JtYWwgY2lyY3Vtc3RhbmNlcywgYXMgdGhlIHNldCB3aWxsIG1haW50YWluIHNvcnQgb3JkZXIgYXMgZWFjaCBpdGVtCiAgICAvLyBpcyBhZGRlZC4KICAgIHNvcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKCF0aGlzLmNvbXBhcmF0b3IpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBzb3J0IGEgc2V0IHdpdGhvdXQgYSBjb21wYXJhdG9yJyk7CiAgICAgIH0KCiAgICAgIGlmIChfLmlzU3RyaW5nKHRoaXMuY29tcGFyYXRvcikgfHwgdGhpcy5jb21wYXJhdG9yLmxlbmd0aCA9PT0gMSkgewogICAgICAgIHRoaXMubW9kZWxzID0gdGhpcy5zb3J0QnkodGhpcy5jb21wYXJhdG9yLCB0aGlzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm1vZGVscy5zb3J0KF8uYmluZCh0aGlzLmNvbXBhcmF0b3IsIHRoaXMpKTsKICAgICAgfQoKICAgICAgaWYgKCFvcHRpb25zIHx8ICFvcHRpb25zLnNpbGVudCkgdGhpcy50cmlnZ2VyKCdzb3J0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBQbHVjayBhbiBhdHRyaWJ1dGUgZnJvbSBlYWNoIG1vZGVsIGluIHRoZSBjb2xsZWN0aW9uLgogICAgcGx1Y2s6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uaW52b2tlKHRoaXMubW9kZWxzLCAnZ2V0JywgYXR0cik7CiAgICB9LAoKICAgIC8vIFNtYXJ0bHkgdXBkYXRlIGEgY29sbGVjdGlvbiB3aXRoIGEgY2hhbmdlIHNldCBvZiBtb2RlbHMsIGFkZGluZywKICAgIC8vIHJlbW92aW5nLCBhbmQgbWVyZ2luZyBhcyBuZWNlc3NhcnkuCiAgICB1cGRhdGU6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICB2YXIgbW9kZWwsIGksIGwsIGV4aXN0aW5nOwogICAgICB2YXIgYWRkID0gW10sIHJlbW92ZSA9IFtdLCBtb2RlbE1hcCA9IHt9OwogICAgICB2YXIgaWRBdHRyID0gdGhpcy5tb2RlbC5wcm90b3R5cGUuaWRBdHRyaWJ1dGU7CiAgICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7YWRkOiB0cnVlLCBtZXJnZTogdHJ1ZSwgcmVtb3ZlOiB0cnVlfSwgb3B0aW9ucyk7CiAgICAgIGlmIChvcHRpb25zLnBhcnNlKSBtb2RlbHMgPSB0aGlzLnBhcnNlKG1vZGVscyk7CgogICAgICAvLyBBbGxvdyBhIHNpbmdsZSBtb2RlbCAob3Igbm8gYXJndW1lbnQpIHRvIGJlIHBhc3NlZC4KICAgICAgaWYgKCFfLmlzQXJyYXkobW9kZWxzKSkgbW9kZWxzID0gbW9kZWxzID8gW21vZGVsc10gOiBbXTsKCiAgICAgIC8vIFByb3h5IHRvIGBhZGRgIGZvciB0aGlzIGNhc2UsIG5vIG5lZWQgdG8gaXRlcmF0ZS4uLgogICAgICBpZiAob3B0aW9ucy5hZGQgJiYgIW9wdGlvbnMucmVtb3ZlKSByZXR1cm4gdGhpcy5hZGQobW9kZWxzLCBvcHRpb25zKTsKCiAgICAgIC8vIERldGVybWluZSB3aGljaCBtb2RlbHMgdG8gYWRkIGFuZCBtZXJnZSwgYW5kIHdoaWNoIHRvIHJlbW92ZS4KICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBtb2RlbCA9IG1vZGVsc1tpXTsKICAgICAgICBleGlzdGluZyA9IHRoaXMuZ2V0KG1vZGVsLmlkIHx8IG1vZGVsLmNpZCB8fCBtb2RlbFtpZEF0dHJdKTsKICAgICAgICBpZiAob3B0aW9ucy5yZW1vdmUgJiYgZXhpc3RpbmcpIG1vZGVsTWFwW2V4aXN0aW5nLmNpZF0gPSB0cnVlOwogICAgICAgIGlmICgob3B0aW9ucy5hZGQgJiYgIWV4aXN0aW5nKSB8fCAob3B0aW9ucy5tZXJnZSAmJiBleGlzdGluZykpIHsKICAgICAgICAgIGFkZC5wdXNoKG1vZGVsKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKG9wdGlvbnMucmVtb3ZlKSB7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMubW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgbW9kZWwgPSB0aGlzLm1vZGVsc1tpXTsKICAgICAgICAgIGlmICghbW9kZWxNYXBbbW9kZWwuY2lkXSkgcmVtb3ZlLnB1c2gobW9kZWwpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gUmVtb3ZlIG1vZGVscyAoaWYgYXBwbGljYWJsZSkgYmVmb3JlIHdlIGFkZCBhbmQgbWVyZ2UgdGhlIHJlc3QuCiAgICAgIGlmIChyZW1vdmUubGVuZ3RoKSB0aGlzLnJlbW92ZShyZW1vdmUsIG9wdGlvbnMpOwogICAgICBpZiAoYWRkLmxlbmd0aCkgdGhpcy5hZGQoYWRkLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFdoZW4geW91IGhhdmUgbW9yZSBpdGVtcyB0aGFuIHlvdSB3YW50IHRvIGFkZCBvciByZW1vdmUgaW5kaXZpZHVhbGx5LAogICAgLy8geW91IGNhbiByZXNldCB0aGUgZW50aXJlIHNldCB3aXRoIGEgbmV3IGxpc3Qgb2YgbW9kZWxzLCB3aXRob3V0IGZpcmluZwogICAgLy8gYW55IGBhZGRgIG9yIGByZW1vdmVgIGV2ZW50cy4gRmlyZXMgYHJlc2V0YCB3aGVuIGZpbmlzaGVkLgogICAgcmVzZXQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICBpZiAob3B0aW9ucy5wYXJzZSkgbW9kZWxzID0gdGhpcy5wYXJzZShtb2RlbHMpOwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZSh0aGlzLm1vZGVsc1tpXSk7CiAgICAgIH0KICAgICAgb3B0aW9ucy5wcmV2aW91c01vZGVscyA9IHRoaXMubW9kZWxzOwogICAgICB0aGlzLl9yZXNldCgpOwogICAgICBpZiAobW9kZWxzKSB0aGlzLmFkZChtb2RlbHMsIF8uZXh0ZW5kKHtzaWxlbnQ6IHRydWV9LCBvcHRpb25zKSk7CiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcigncmVzZXQnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEZldGNoIHRoZSBkZWZhdWx0IHNldCBvZiBtb2RlbHMgZm9yIHRoaXMgY29sbGVjdGlvbiwgcmVzZXR0aW5nIHRoZQogICAgLy8gY29sbGVjdGlvbiB3aGVuIHRoZXkgYXJyaXZlLiBJZiBgYWRkOiB0cnVlYCBpcyBwYXNzZWQsIGFwcGVuZHMgdGhlCiAgICAvLyBtb2RlbHMgdG8gdGhlIGNvbGxlY3Rpb24gaW5zdGVhZCBvZiByZXNldHRpbmcuCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3AsIHN0YXR1cywgeGhyKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IG9wdGlvbnMudXBkYXRlID8gJ3VwZGF0ZScgOiAncmVzZXQnOwogICAgICAgIGNvbGxlY3Rpb25bbWV0aG9kXShyZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvLyBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgYSBtb2RlbCBpbiB0aGlzIGNvbGxlY3Rpb24uIEFkZCB0aGUgbW9kZWwgdG8gdGhlCiAgICAvLyBjb2xsZWN0aW9uIGltbWVkaWF0ZWx5LCB1bmxlc3MgYHdhaXQ6IHRydWVgIGlzIHBhc3NlZCwgaW4gd2hpY2ggY2FzZSB3ZQogICAgLy8gd2FpdCBmb3IgdGhlIHNlcnZlciB0byBhZ3JlZS4KICAgIGNyZWF0ZTogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgdmFyIGNvbGxlY3Rpb24gPSB0aGlzOwogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgbW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpOwogICAgICBpZiAoIW1vZGVsKSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICghb3B0aW9ucy53YWl0KSBjb2xsZWN0aW9uLmFkZChtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihtb2RlbCwgcmVzcCwgb3B0aW9ucykgewogICAgICAgIGlmIChvcHRpb25zLndhaXQpIGNvbGxlY3Rpb24uYWRkKG1vZGVsLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIG1vZGVsLnNhdmUobnVsbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byBhIGxpc3Qgb2YgbW9kZWxzIHRvIGJlIGFkZGVkIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbi4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIGl0IHRocm91Z2guCiAgICBwYXJzZTogZnVuY3Rpb24ocmVzcCkgewogICAgICByZXR1cm4gcmVzcDsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGNvbGxlY3Rpb24gd2l0aCBhbiBpZGVudGljYWwgbGlzdCBvZiBtb2RlbHMgYXMgdGhpcyBvbmUuCiAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLm1vZGVscyk7CiAgICB9LAoKICAgIC8vIFByb3h5IHRvIF8ncyBjaGFpbi4gQ2FuJ3QgYmUgcHJveGllZCB0aGUgc2FtZSB3YXkgdGhlIHJlc3Qgb2YgdGhlCiAgICAvLyB1bmRlcnNjb3JlIG1ldGhvZHMgYXJlIHByb3hpZWQgYmVjYXVzZSBpdCByZWxpZXMgb24gdGhlIHVuZGVyc2NvcmUKICAgIC8vIGNvbnN0cnVjdG9yLgogICAgY2hhaW46IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gXyh0aGlzLm1vZGVscykuY2hhaW4oKTsKICAgIH0sCgogICAgLy8gUmVzZXQgYWxsIGludGVybmFsIHN0YXRlLiBDYWxsZWQgd2hlbiB0aGUgY29sbGVjdGlvbiBpcyByZXNldC4KICAgIF9yZXNldDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubGVuZ3RoID0gMDsKICAgICAgdGhpcy5tb2RlbHMgPSBbXTsKICAgICAgdGhpcy5fYnlJZCAgPSB7fTsKICAgICAgdGhpcy5fYnlDaWQgPSB7fTsKICAgIH0sCgogICAgLy8gUHJlcGFyZSBhIG1vZGVsIG9yIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBhZGRlZCB0byB0aGlzIGNvbGxlY3Rpb24uCiAgICBfcHJlcGFyZU1vZGVsOiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgewogICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiBNb2RlbCkgewogICAgICAgIGlmICghYXR0cnMuY29sbGVjdGlvbikgYXR0cnMuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgICAgcmV0dXJuIGF0dHJzOwogICAgICB9CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIG9wdGlvbnMuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBtb2RlbCA9IG5ldyB0aGlzLm1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgaWYgKCFtb2RlbC5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHJlbW92ZSBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uCiAgICBfcmVtb3ZlUmVmZXJlbmNlOiBmdW5jdGlvbihtb2RlbCkgewogICAgICBpZiAodGhpcyA9PT0gbW9kZWwuY29sbGVjdGlvbikgZGVsZXRlIG1vZGVsLmNvbGxlY3Rpb247CiAgICAgIG1vZGVsLm9mZignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgIH0sCgogICAgLy8gSW50ZXJuYWwgbWV0aG9kIGNhbGxlZCBldmVyeSB0aW1lIGEgbW9kZWwgaW4gdGhlIHNldCBmaXJlcyBhbiBldmVudC4KICAgIC8vIFNldHMgbmVlZCB0byB1cGRhdGUgdGhlaXIgaW5kZXhlcyB3aGVuIG1vZGVscyBjaGFuZ2UgaWRzLiBBbGwgb3RoZXIKICAgIC8vIGV2ZW50cyBzaW1wbHkgcHJveHkgdGhyb3VnaC4gImFkZCIgYW5kICJyZW1vdmUiIGV2ZW50cyB0aGF0IG9yaWdpbmF0ZQogICAgLy8gaW4gb3RoZXIgY29sbGVjdGlvbnMgYXJlIGlnbm9yZWQuCiAgICBfb25Nb2RlbEV2ZW50OiBmdW5jdGlvbihldmVudCwgbW9kZWwsIGNvbGxlY3Rpb24sIG9wdGlvbnMpIHsKICAgICAgaWYgKChldmVudCA9PT0gJ2FkZCcgfHwgZXZlbnQgPT09ICdyZW1vdmUnKSAmJiBjb2xsZWN0aW9uICE9PSB0aGlzKSByZXR1cm47CiAgICAgIGlmIChldmVudCA9PT0gJ2Rlc3Ryb3knKSB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIGlmIChtb2RlbCAmJiBldmVudCA9PT0gJ2NoYW5nZTonICsgbW9kZWwuaWRBdHRyaWJ1dGUpIHsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5wcmV2aW91cyhtb2RlbC5pZEF0dHJpYnV0ZSldOwogICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQoKICB9KTsKCiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIENvbGxlY3Rpb24uCiAgdmFyIG1ldGhvZHMgPSBbJ2ZvckVhY2gnLCAnZWFjaCcsICdtYXAnLCAnY29sbGVjdCcsICdyZWR1Y2UnLCAnZm9sZGwnLAogICAgJ2luamVjdCcsICdyZWR1Y2VSaWdodCcsICdmb2xkcicsICdmaW5kJywgJ2RldGVjdCcsICdmaWx0ZXInLCAnc2VsZWN0JywKICAgICdyZWplY3QnLCAnZXZlcnknLCAnYWxsJywgJ3NvbWUnLCAnYW55JywgJ2luY2x1ZGUnLCAnY29udGFpbnMnLCAnaW52b2tlJywKICAgICdtYXgnLCAnbWluJywgJ3NvcnRlZEluZGV4JywgJ3RvQXJyYXknLCAnc2l6ZScsICdmaXJzdCcsICdoZWFkJywgJ3Rha2UnLAogICAgJ2luaXRpYWwnLCAncmVzdCcsICd0YWlsJywgJ2xhc3QnLCAnd2l0aG91dCcsICdpbmRleE9mJywgJ3NodWZmbGUnLAogICAgJ2xhc3RJbmRleE9mJywgJ2lzRW1wdHknXTsKCiAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgQ29sbGVjdGlvbiNtb2RlbHNgLgogIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIENvbGxlY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLm1vZGVscyk7CiAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CiAgICB9OwogIH0pOwoKICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB0YWtlIGEgcHJvcGVydHkgbmFtZSBhcyBhbiBhcmd1bWVudC4KICB2YXIgYXR0cmlidXRlTWV0aG9kcyA9IFsnZ3JvdXBCeScsICdjb3VudEJ5JywgJ3NvcnRCeSddOwoKICAvLyBVc2UgYXR0cmlidXRlcyBpbnN0ZWFkIG9mIHByb3BlcnRpZXMuCiAgXy5lYWNoKGF0dHJpYnV0ZU1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHZhciBpdGVyYXRvciA9IF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIG1vZGVsLmdldCh2YWx1ZSk7CiAgICAgIH07CiAgICAgIHJldHVybiBfW21ldGhvZF0odGhpcy5tb2RlbHMsIGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH07CiAgfSk7CgogIC8vIEJhY2tib25lLlJvdXRlcgogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBSb3V0ZXJzIG1hcCBmYXV4LVVSTHMgdG8gYWN0aW9ucywgYW5kIGZpcmUgZXZlbnRzIHdoZW4gcm91dGVzIGFyZQogIC8vIG1hdGNoZWQuIENyZWF0aW5nIGEgbmV3IG9uZSBzZXRzIGl0cyBgcm91dGVzYCBoYXNoLCBpZiBub3Qgc2V0IHN0YXRpY2FsbHkuCiAgdmFyIFJvdXRlciA9IEJhY2tib25lLlJvdXRlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBpZiAob3B0aW9ucy5yb3V0ZXMpIHRoaXMucm91dGVzID0gb3B0aW9ucy5yb3V0ZXM7CiAgICB0aGlzLl9iaW5kUm91dGVzKCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwoKICAvLyBDYWNoZWQgcmVndWxhciBleHByZXNzaW9ucyBmb3IgbWF0Y2hpbmcgbmFtZWQgcGFyYW0gcGFydHMgYW5kIHNwbGF0dGVkCiAgLy8gcGFydHMgb2Ygcm91dGUgc3RyaW5ncy4KICB2YXIgb3B0aW9uYWxQYXJhbSA9IC9cKCguKj8pXCkvZzsKICB2YXIgbmFtZWRQYXJhbSAgICA9IC86XHcrL2c7CiAgdmFyIHNwbGF0UGFyYW0gICAgPSAvXCpcdysvZzsKICB2YXIgZXNjYXBlUmVnRXhwICA9IC9bXC17fVxbXF0rPy4sXFxcXiR8I1xzXS9nOwoKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuUm91dGVyKiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChSb3V0ZXIucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIE1hbnVhbGx5IGJpbmQgYSBzaW5nbGUgbmFtZWQgcm91dGUgdG8gYSBjYWxsYmFjay4gRm9yIGV4YW1wbGU6CiAgICAvLwogICAgLy8gICAgIHRoaXMucm91dGUoJ3NlYXJjaC86cXVlcnkvcDpudW0nLCAnc2VhcmNoJywgZnVuY3Rpb24ocXVlcnksIG51bSkgewogICAgLy8gICAgICAgLi4uCiAgICAvLyAgICAgfSk7CiAgICAvLwogICAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBuYW1lLCBjYWxsYmFjaykgewogICAgICBpZiAoIV8uaXNSZWdFeHAocm91dGUpKSByb3V0ZSA9IHRoaXMuX3JvdXRlVG9SZWdFeHAocm91dGUpOwogICAgICBpZiAoIWNhbGxiYWNrKSBjYWxsYmFjayA9IHRoaXNbbmFtZV07CiAgICAgIEJhY2tib25lLmhpc3Rvcnkucm91dGUocm91dGUsIF8uYmluZChmdW5jdGlvbihmcmFnbWVudCkgewogICAgICAgIHZhciBhcmdzID0gdGhpcy5fZXh0cmFjdFBhcmFtZXRlcnMocm91dGUsIGZyYWdtZW50KTsKICAgICAgICBjYWxsYmFjayAmJiBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgWydyb3V0ZTonICsgbmFtZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgICBCYWNrYm9uZS5oaXN0b3J5LnRyaWdnZXIoJ3JvdXRlJywgdGhpcywgbmFtZSwgYXJncyk7CiAgICAgIH0sIHRoaXMpKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFNpbXBsZSBwcm94eSB0byBgQmFja2JvbmUuaGlzdG9yeWAgdG8gc2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhpc3RvcnkuCiAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5uYXZpZ2F0ZShmcmFnbWVudCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBCaW5kIGFsbCBkZWZpbmVkIHJvdXRlcyB0byBgQmFja2JvbmUuaGlzdG9yeWAuIFdlIGhhdmUgdG8gcmV2ZXJzZSB0aGUKICAgIC8vIG9yZGVyIG9mIHRoZSByb3V0ZXMgaGVyZSB0byBzdXBwb3J0IGJlaGF2aW9yIHdoZXJlIHRoZSBtb3N0IGdlbmVyYWwKICAgIC8vIHJvdXRlcyBjYW4gYmUgZGVmaW5lZCBhdCB0aGUgYm90dG9tIG9mIHRoZSByb3V0ZSBtYXAuCiAgICBfYmluZFJvdXRlczogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy5yb3V0ZXMpIHJldHVybjsKICAgICAgdmFyIHJvdXRlLCByb3V0ZXMgPSBfLmtleXModGhpcy5yb3V0ZXMpOwogICAgICB3aGlsZSAoKHJvdXRlID0gcm91dGVzLnBvcCgpKSAhPSBudWxsKSB7CiAgICAgICAgdGhpcy5yb3V0ZShyb3V0ZSwgdGhpcy5yb3V0ZXNbcm91dGVdKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBDb252ZXJ0IGEgcm91dGUgc3RyaW5nIGludG8gYSByZWd1bGFyIGV4cHJlc3Npb24sIHN1aXRhYmxlIGZvciBtYXRjaGluZwogICAgLy8gYWdhaW5zdCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoLgogICAgX3JvdXRlVG9SZWdFeHA6IGZ1bmN0aW9uKHJvdXRlKSB7CiAgICAgIHJvdXRlID0gcm91dGUucmVwbGFjZShlc2NhcGVSZWdFeHAsICdcXCQmJykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG9wdGlvbmFsUGFyYW0sICcoPzokMSk/JykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG5hbWVkUGFyYW0sICcoW15cL10rKScpCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZShzcGxhdFBhcmFtLCAnKC4qPyknKTsKICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcm91dGUgKyAnJCcpOwogICAgfSwKCiAgICAvLyBHaXZlbiBhIHJvdXRlLCBhbmQgYSBVUkwgZnJhZ21lbnQgdGhhdCBpdCBtYXRjaGVzLCByZXR1cm4gdGhlIGFycmF5IG9mCiAgICAvLyBleHRyYWN0ZWQgcGFyYW1ldGVycy4KICAgIF9leHRyYWN0UGFyYW1ldGVyczogZnVuY3Rpb24ocm91dGUsIGZyYWdtZW50KSB7CiAgICAgIHJldHVybiByb3V0ZS5leGVjKGZyYWdtZW50KS5zbGljZSgxKTsKICAgIH0KCiAgfSk7CgogIC8vIEJhY2tib25lLkhpc3RvcnkKICAvLyAtLS0tLS0tLS0tLS0tLS0tCgogIC8vIEhhbmRsZXMgY3Jvc3MtYnJvd3NlciBoaXN0b3J5IG1hbmFnZW1lbnQsIGJhc2VkIG9uIFVSTCBmcmFnbWVudHMuIElmIHRoZQogIC8vIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBgb25oYXNoY2hhbmdlYCwgZmFsbHMgYmFjayB0byBwb2xsaW5nLgogIHZhciBIaXN0b3J5ID0gQmFja2JvbmUuSGlzdG9yeSA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5oYW5kbGVycyA9IFtdOwogICAgXy5iaW5kQWxsKHRoaXMsICdjaGVja1VybCcpOwoKICAgIC8vIEVuc3VyZSB0aGF0IGBIaXN0b3J5YCBjYW4gYmUgdXNlZCBvdXRzaWRlIG9mIHRoZSBicm93c2VyLgogICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHRoaXMubG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CiAgICAgIHRoaXMuaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwogICAgfQogIH07CgogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KICB2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaGVzLgogIHZhciByb290U3RyaXBwZXIgPSAvXlwvK3xcLyskL2c7CgogIC8vIENhY2hlZCByZWdleCBmb3IgZGV0ZWN0aW5nIE1TSUUuCiAgdmFyIGlzRXhwbG9yZXIgPSAvbXNpZSBbXHcuXSsvOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guCiAgdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKCiAgLy8gSGFzIHRoZSBoaXN0b3J5IGhhbmRsaW5nIGFscmVhZHkgYmVlbiBzdGFydGVkPwogIEhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOwoKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuSGlzdG9yeSoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCiAgXy5leHRlbmQoSGlzdG9yeS5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIFRoZSBkZWZhdWx0IGludGVydmFsIHRvIHBvbGwgZm9yIGhhc2ggY2hhbmdlcywgaWYgbmVjZXNzYXJ5LCBpcwogICAgLy8gdHdlbnR5IHRpbWVzIGEgc2Vjb25kLgogICAgaW50ZXJ2YWw6IDUwLAoKICAgIC8vIEdldHMgdGhlIHRydWUgaGFzaCB2YWx1ZS4gQ2Fubm90IHVzZSBsb2NhdGlvbi5oYXNoIGRpcmVjdGx5IGR1ZSB0byBidWcKICAgIC8vIGluIEZpcmVmb3ggd2hlcmUgbG9jYXRpb24uaGFzaCB3aWxsIGFsd2F5cyBiZSBkZWNvZGVkLgogICAgZ2V0SGFzaDogZnVuY3Rpb24od2luZG93KSB7CiAgICAgIHZhciBtYXRjaCA9ICh3aW5kb3cgfHwgdGhpcykubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CiAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogJyc7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgY3Jvc3MtYnJvd3NlciBub3JtYWxpemVkIFVSTCBmcmFnbWVudCwgZWl0aGVyIGZyb20gdGhlIFVSTCwKICAgIC8vIHRoZSBoYXNoLCBvciB0aGUgb3ZlcnJpZGUuCiAgICBnZXRGcmFnbWVudDogZnVuY3Rpb24oZnJhZ21lbnQsIGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgIGlmIChmcmFnbWVudCA9PSBudWxsKSB7CiAgICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSB8fCAhdGhpcy5fd2FudHNIYXNoQ2hhbmdlIHx8IGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMubG9jYXRpb24ucGF0aG5hbWU7CiAgICAgICAgICB2YXIgcm9vdCA9IHRoaXMucm9vdC5yZXBsYWNlKHRyYWlsaW5nU2xhc2gsICcnKTsKICAgICAgICAgIGlmICghZnJhZ21lbnQuaW5kZXhPZihyb290KSkgZnJhZ21lbnQgPSBmcmFnbWVudC5zdWJzdHIocm9vdC5sZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZnJhZ21lbnQucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICB9LAoKICAgIC8vIFN0YXJ0IHRoZSBoYXNoIGNoYW5nZSBoYW5kbGluZywgcmV0dXJuaW5nIGB0cnVlYCBpZiB0aGUgY3VycmVudCBVUkwgbWF0Y2hlcwogICAgLy8gYW4gZXhpc3Rpbmcgcm91dGUsIGFuZCBgZmFsc2VgIG90aGVyd2lzZS4KICAgIHN0YXJ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmIChIaXN0b3J5LnN0YXJ0ZWQpIHRocm93IG5ldyBFcnJvcigiQmFja2JvbmUuaGlzdG9yeSBoYXMgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQiKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gdHJ1ZTsKCiAgICAgIC8vIEZpZ3VyZSBvdXQgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbi4gRG8gd2UgbmVlZCBhbiBpZnJhbWU/CiAgICAgIC8vIElzIHB1c2hTdGF0ZSBkZXNpcmVkIC4uLiBpcyBpdCBhdmFpbGFibGU/CiAgICAgIHRoaXMub3B0aW9ucyAgICAgICAgICA9IF8uZXh0ZW5kKHt9LCB7cm9vdDogJy8nfSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsKICAgICAgdGhpcy5yb290ICAgICAgICAgICAgID0gdGhpcy5vcHRpb25zLnJvb3Q7CiAgICAgIHRoaXMuX3dhbnRzSGFzaENoYW5nZSA9IHRoaXMub3B0aW9ucy5oYXNoQ2hhbmdlICE9PSBmYWxzZTsKICAgICAgdGhpcy5fd2FudHNQdXNoU3RhdGUgID0gISF0aGlzLm9wdGlvbnMucHVzaFN0YXRlOwogICAgICB0aGlzLl9oYXNQdXNoU3RhdGUgICAgPSAhISh0aGlzLm9wdGlvbnMucHVzaFN0YXRlICYmIHRoaXMuaGlzdG9yeSAmJiB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKTsKICAgICAgdmFyIGZyYWdtZW50ICAgICAgICAgID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICB2YXIgZG9jTW9kZSAgICAgICAgICAgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgIHZhciBvbGRJRSAgICAgICAgICAgICA9IChpc0V4cGxvcmVyLmV4ZWMobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKSAmJiAoIWRvY01vZGUgfHwgZG9jTW9kZSA8PSA3KSk7CgogICAgICAvLyBOb3JtYWxpemUgcm9vdCB0byBhbHdheXMgaW5jbHVkZSBhIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoLgogICAgICB0aGlzLnJvb3QgPSAoJy8nICsgdGhpcy5yb290ICsgJy8nKS5yZXBsYWNlKHJvb3RTdHJpcHBlciwgJy8nKTsKCiAgICAgIGlmIChvbGRJRSAmJiB0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLmlmcmFtZSA9IEJhY2tib25lLiQoJzxpZnJhbWUgc3JjPSJqYXZhc2NyaXB0OjAiIHRhYmluZGV4PSItMSIgLz4nKS5oaWRlKCkuYXBwZW5kVG8oJ2JvZHknKVswXS5jb250ZW50V2luZG93OwogICAgICAgIHRoaXMubmF2aWdhdGUoZnJhZ21lbnQpOwogICAgICB9CgogICAgICAvLyBEZXBlbmRpbmcgb24gd2hldGhlciB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgb3IgaGFzaGVzLCBhbmQgd2hldGhlcgogICAgICAvLyAnb25oYXNoY2hhbmdlJyBpcyBzdXBwb3J0ZWQsIGRldGVybWluZSBob3cgd2UgY2hlY2sgdGhlIFVSTCBzdGF0ZS4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIEJhY2tib25lLiQod2luZG93KS5iaW5kKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiAoJ29uaGFzaGNoYW5nZScgaW4gd2luZG93KSAmJiAhb2xkSUUpIHsKICAgICAgICBCYWNrYm9uZS4kKHdpbmRvdykuYmluZCgnaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLmNoZWNrVXJsLCB0aGlzLmludGVydmFsKTsKICAgICAgfQoKICAgICAgLy8gRGV0ZXJtaW5lIGlmIHdlIG5lZWQgdG8gY2hhbmdlIHRoZSBiYXNlIHVybCwgZm9yIGEgcHVzaFN0YXRlIGxpbmsKICAgICAgLy8gb3BlbmVkIGJ5IGEgbm9uLXB1c2hTdGF0ZSBicm93c2VyLgogICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CiAgICAgIHZhciBsb2MgPSB0aGlzLmxvY2F0aW9uOwogICAgICB2YXIgYXRSb290ID0gbG9jLnBhdGhuYW1lLnJlcGxhY2UoL1teXC9dJC8sICckJi8nKSA9PT0gdGhpcy5yb290OwoKICAgICAgLy8gSWYgd2UndmUgc3RhcnRlZCBvZmYgd2l0aCBhIHJvdXRlIGZyb20gYSBgcHVzaFN0YXRlYC1lbmFibGVkIGJyb3dzZXIsCiAgICAgIC8vIGJ1dCB3ZSdyZSBjdXJyZW50bHkgaW4gYSBicm93c2VyIHRoYXQgZG9lc24ndCBzdXBwb3J0IGl0Li4uCiAgICAgIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgdGhpcy5fd2FudHNQdXNoU3RhdGUgJiYgIXRoaXMuX2hhc1B1c2hTdGF0ZSAmJiAhYXRSb290KSB7CiAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQobnVsbCwgdHJ1ZSk7CiAgICAgICAgdGhpcy5sb2NhdGlvbi5yZXBsYWNlKHRoaXMucm9vdCArIHRoaXMubG9jYXRpb24uc2VhcmNoICsgJyMnICsgdGhpcy5mcmFnbWVudCk7CiAgICAgICAgLy8gUmV0dXJuIGltbWVkaWF0ZWx5IGFzIGJyb3dzZXIgd2lsbCBkbyByZWRpcmVjdCB0byBuZXcgdXJsCiAgICAgICAgcmV0dXJuIHRydWU7CgogICAgICAvLyBPciBpZiB3ZSd2ZSBzdGFydGVkIG91dCB3aXRoIGEgaGFzaC1iYXNlZCByb3V0ZSwgYnV0IHdlJ3JlIGN1cnJlbnRseQogICAgICAvLyBpbiBhIGJyb3dzZXIgd2hlcmUgaXQgY291bGQgYmUgYHB1c2hTdGF0ZWAtYmFzZWQgaW5zdGVhZC4uLgogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzUHVzaFN0YXRlICYmIHRoaXMuX2hhc1B1c2hTdGF0ZSAmJiBhdFJvb3QgJiYgbG9jLmhhc2gpIHsKICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCkucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICAgICAgdGhpcy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsIHRoaXMucm9vdCArIHRoaXMuZnJhZ21lbnQgKyBsb2Muc2VhcmNoKTsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuc2lsZW50KSByZXR1cm4gdGhpcy5sb2FkVXJsKCk7CiAgICB9LAoKICAgIC8vIERpc2FibGUgQmFja2JvbmUuaGlzdG9yeSwgcGVyaGFwcyB0ZW1wb3JhcmlseS4gTm90IHVzZWZ1bCBpbiBhIHJlYWwgYXBwLAogICAgLy8gYnV0IHBvc3NpYmx5IHVzZWZ1bCBmb3IgdW5pdCB0ZXN0aW5nIFJvdXRlcnMuCiAgICBzdG9wOiBmdW5jdGlvbigpIHsKICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLnVuYmluZCgncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKS51bmJpbmQoJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLl9jaGVja1VybEludGVydmFsKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CiAgICB9LAoKICAgIC8vIEFkZCBhIHJvdXRlIHRvIGJlIHRlc3RlZCB3aGVuIHRoZSBmcmFnbWVudCBjaGFuZ2VzLiBSb3V0ZXMgYWRkZWQgbGF0ZXIKICAgIC8vIG1heSBvdmVycmlkZSBwcmV2aW91cyByb3V0ZXMuCiAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuaGFuZGxlcnMudW5zaGlmdCh7cm91dGU6IHJvdXRlLCBjYWxsYmFjazogY2FsbGJhY2t9KTsKICAgIH0sCgogICAgLy8gQ2hlY2tzIHRoZSBjdXJyZW50IFVSTCB0byBzZWUgaWYgaXQgaGFzIGNoYW5nZWQsIGFuZCBpZiBpdCBoYXMsCiAgICAvLyBjYWxscyBgbG9hZFVybGAsIG5vcm1hbGl6aW5nIGFjcm9zcyB0aGUgaGlkZGVuIGlmcmFtZS4KICAgIGNoZWNrVXJsOiBmdW5jdGlvbihlKSB7CiAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICBpZiAoY3VycmVudCA9PT0gdGhpcy5mcmFnbWVudCAmJiB0aGlzLmlmcmFtZSkgewogICAgICAgIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpOwogICAgICB9CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50KSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICh0aGlzLmlmcmFtZSkgdGhpcy5uYXZpZ2F0ZShjdXJyZW50KTsKICAgICAgdGhpcy5sb2FkVXJsKCkgfHwgdGhpcy5sb2FkVXJsKHRoaXMuZ2V0SGFzaCgpKTsKICAgIH0sCgogICAgLy8gQXR0ZW1wdCB0byBsb2FkIHRoZSBjdXJyZW50IFVSTCBmcmFnbWVudC4gSWYgYSByb3V0ZSBzdWNjZWVkcyB3aXRoIGEKICAgIC8vIG1hdGNoLCByZXR1cm5zIGB0cnVlYC4gSWYgbm8gZGVmaW5lZCByb3V0ZXMgbWF0Y2hlcyB0aGUgZnJhZ21lbnQsCiAgICAvLyByZXR1cm5zIGBmYWxzZWAuCiAgICBsb2FkVXJsOiBmdW5jdGlvbihmcmFnbWVudE92ZXJyaWRlKSB7CiAgICAgIHZhciBmcmFnbWVudCA9IHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50T3ZlcnJpZGUpOwogICAgICB2YXIgbWF0Y2hlZCA9IF8uYW55KHRoaXMuaGFuZGxlcnMsIGZ1bmN0aW9uKGhhbmRsZXIpIHsKICAgICAgICBpZiAoaGFuZGxlci5yb3V0ZS50ZXN0KGZyYWdtZW50KSkgewogICAgICAgICAgaGFuZGxlci5jYWxsYmFjayhmcmFnbWVudCk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gbWF0Y2hlZDsKICAgIH0sCgogICAgLy8gU2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhhc2ggaGlzdG9yeSwgb3IgcmVwbGFjZSB0aGUgVVJMIHN0YXRlIGlmIHRoZQogICAgLy8gJ3JlcGxhY2UnIG9wdGlvbiBpcyBwYXNzZWQuIFlvdSBhcmUgcmVzcG9uc2libGUgZm9yIHByb3Blcmx5IFVSTC1lbmNvZGluZwogICAgLy8gdGhlIGZyYWdtZW50IGluIGFkdmFuY2UuCiAgICAvLwogICAgLy8gVGhlIG9wdGlvbnMgb2JqZWN0IGNhbiBjb250YWluIGB0cmlnZ2VyOiB0cnVlYCBpZiB5b3Ugd2lzaCB0byBoYXZlIHRoZQogICAgLy8gcm91dGUgY2FsbGJhY2sgYmUgZmlyZWQgKG5vdCB1c3VhbGx5IGRlc2lyYWJsZSksIG9yIGByZXBsYWNlOiB0cnVlYCwgaWYKICAgIC8vIHlvdSB3aXNoIHRvIG1vZGlmeSB0aGUgY3VycmVudCBVUkwgd2l0aG91dCBhZGRpbmcgYW4gZW50cnkgdG8gdGhlIGhpc3RvcnkuCiAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKICAgICAgaWYgKCFIaXN0b3J5LnN0YXJ0ZWQpIHJldHVybiBmYWxzZTsKICAgICAgaWYgKCFvcHRpb25zIHx8IG9wdGlvbnMgPT09IHRydWUpIG9wdGlvbnMgPSB7dHJpZ2dlcjogb3B0aW9uc307CiAgICAgIGZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudCB8fCAnJyk7CiAgICAgIGlmICh0aGlzLmZyYWdtZW50ID09PSBmcmFnbWVudCkgcmV0dXJuOwogICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CiAgICAgIHZhciB1cmwgPSB0aGlzLnJvb3QgKyBmcmFnbWVudDsKCiAgICAgIC8vIElmIHB1c2hTdGF0ZSBpcyBhdmFpbGFibGUsIHdlIHVzZSBpdCB0byBzZXQgdGhlIGZyYWdtZW50IGFzIGEgcmVhbCBVUkwuCiAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKICAgICAgICB0aGlzLmhpc3Rvcnlbb3B0aW9ucy5yZXBsYWNlID8gJ3JlcGxhY2VTdGF0ZScgOiAncHVzaFN0YXRlJ10oe30sIGRvY3VtZW50LnRpdGxlLCB1cmwpOwoKICAgICAgLy8gSWYgaGFzaCBjaGFuZ2VzIGhhdmVuJ3QgYmVlbiBleHBsaWNpdGx5IGRpc2FibGVkLCB1cGRhdGUgdGhlIGhhc2gKICAgICAgLy8gZnJhZ21lbnQgdG8gc3RvcmUgaGlzdG9yeS4KICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwogICAgICAgIGlmICh0aGlzLmlmcmFtZSAmJiAoZnJhZ21lbnQgIT09IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSkpKSB7CiAgICAgICAgICAvLyBPcGVuaW5nIGFuZCBjbG9zaW5nIHRoZSBpZnJhbWUgdHJpY2tzIElFNyBhbmQgZWFybGllciB0byBwdXNoIGEKICAgICAgICAgIC8vIGhpc3RvcnkgZW50cnkgb24gaGFzaC10YWcgY2hhbmdlLiAgV2hlbiByZXBsYWNlIGlzIHRydWUsIHdlIGRvbid0CiAgICAgICAgICAvLyB3YW50IHRoaXMuCiAgICAgICAgICBpZighb3B0aW9ucy5yZXBsYWNlKSB0aGlzLmlmcmFtZS5kb2N1bWVudC5vcGVuKCkuY2xvc2UoKTsKICAgICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5pZnJhbWUubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwogICAgICAgIH0KCiAgICAgIC8vIElmIHlvdSd2ZSB0b2xkIHVzIHRoYXQgeW91IGV4cGxpY2l0bHkgZG9uJ3Qgd2FudCBmYWxsYmFjayBoYXNoY2hhbmdlLQogICAgICAvLyBiYXNlZCBoaXN0b3J5LCB0aGVuIGBuYXZpZ2F0ZWAgYmVjb21lcyBhIHBhZ2UgcmVmcmVzaC4KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5sb2NhdGlvbi5hc3NpZ24odXJsKTsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy50cmlnZ2VyKSB0aGlzLmxvYWRVcmwoZnJhZ21lbnQpOwogICAgfSwKCiAgICAvLyBVcGRhdGUgdGhlIGhhc2ggbG9jYXRpb24sIGVpdGhlciByZXBsYWNpbmcgdGhlIGN1cnJlbnQgZW50cnksIG9yIGFkZGluZwogICAgLy8gYSBuZXcgb25lIHRvIHRoZSBicm93c2VyIGhpc3RvcnkuCiAgICBfdXBkYXRlSGFzaDogZnVuY3Rpb24obG9jYXRpb24sIGZyYWdtZW50LCByZXBsYWNlKSB7CiAgICAgIGlmIChyZXBsYWNlKSB7CiAgICAgICAgdmFyIGhyZWYgPSBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoLyhqYXZhc2NyaXB0OnwjKS4qJC8sICcnKTsKICAgICAgICBsb2NhdGlvbi5yZXBsYWNlKGhyZWYgKyAnIycgKyBmcmFnbWVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU29tZSBicm93c2VycyByZXF1aXJlIHRoYXQgYGhhc2hgIGNvbnRhaW5zIGEgbGVhZGluZyAjLgogICAgICAgIGxvY2F0aW9uLmhhc2ggPSAnIycgKyBmcmFnbWVudDsKICAgICAgfQogICAgfQoKICB9KTsKCiAgLy8gQ3JlYXRlIHRoZSBkZWZhdWx0IEJhY2tib25lLmhpc3RvcnkuCiAgQmFja2JvbmUuaGlzdG9yeSA9IG5ldyBIaXN0b3J5OwoKICAvLyBCYWNrYm9uZS5WaWV3CiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBDcmVhdGluZyBhIEJhY2tib25lLlZpZXcgY3JlYXRlcyBpdHMgaW5pdGlhbCBlbGVtZW50IG91dHNpZGUgb2YgdGhlIERPTSwKICAvLyBpZiBhbiBleGlzdGluZyBlbGVtZW50IGlzIG5vdCBwcm92aWRlZC4uLgogIHZhciBWaWV3ID0gQmFja2JvbmUuVmlldyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHRoaXMuY2lkID0gXy51bmlxdWVJZCgndmlldycpOwogICAgdGhpcy5fY29uZmlndXJlKG9wdGlvbnMgfHwge30pOwogICAgdGhpcy5fZW5zdXJlRWxlbWVudCgpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CiAgfTsKCiAgLy8gQ2FjaGVkIHJlZ2V4IHRvIHNwbGl0IGtleXMgZm9yIGBkZWxlZ2F0ZWAuCiAgdmFyIGRlbGVnYXRlRXZlbnRTcGxpdHRlciA9IC9eKFxTKylccyooLiopJC87CgogIC8vIExpc3Qgb2YgdmlldyBvcHRpb25zIHRvIGJlIG1lcmdlZCBhcyBwcm9wZXJ0aWVzLgogIHZhciB2aWV3T3B0aW9ucyA9IFsnbW9kZWwnLCAnY29sbGVjdGlvbicsICdlbCcsICdpZCcsICdhdHRyaWJ1dGVzJywgJ2NsYXNzTmFtZScsICd0YWdOYW1lJywgJ2V2ZW50cyddOwoKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuVmlldyoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCiAgXy5leHRlbmQoVmlldy5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIFRoZSBkZWZhdWx0IGB0YWdOYW1lYCBvZiBhIFZpZXcncyBlbGVtZW50IGlzIGAiZGl2ImAuCiAgICB0YWdOYW1lOiAnZGl2JywKCiAgICAvLyBqUXVlcnkgZGVsZWdhdGUgZm9yIGVsZW1lbnQgbG9va3VwLCBzY29wZWQgdG8gRE9NIGVsZW1lbnRzIHdpdGhpbiB0aGUKICAgIC8vIGN1cnJlbnQgdmlldy4gVGhpcyBzaG91bGQgYmUgcHJlZmVyZWQgdG8gZ2xvYmFsIGxvb2t1cHMgd2hlcmUgcG9zc2libGUuCiAgICAkOiBmdW5jdGlvbihzZWxlY3RvcikgewogICAgICByZXR1cm4gdGhpcy4kZWwuZmluZChzZWxlY3Rvcik7CiAgICB9LAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gKipyZW5kZXIqKiBpcyB0aGUgY29yZSBmdW5jdGlvbiB0aGF0IHlvdXIgdmlldyBzaG91bGQgb3ZlcnJpZGUsIGluIG9yZGVyCiAgICAvLyB0byBwb3B1bGF0ZSBpdHMgZWxlbWVudCAoYHRoaXMuZWxgKSwgd2l0aCB0aGUgYXBwcm9wcmlhdGUgSFRNTC4gVGhlCiAgICAvLyBjb252ZW50aW9uIGlzIGZvciAqKnJlbmRlcioqIHRvIGFsd2F5cyByZXR1cm4gYHRoaXNgLgogICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSB0aGlzIHZpZXcgYnkgdGFraW5nIHRoZSBlbGVtZW50IG91dCBvZiB0aGUgRE9NLCBhbmQgcmVtb3ZpbmcgYW55CiAgICAvLyBhcHBsaWNhYmxlIEJhY2tib25lLkV2ZW50cyBsaXN0ZW5lcnMuCiAgICByZW1vdmU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC5yZW1vdmUoKTsKICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBGb3Igc21hbGwgYW1vdW50cyBvZiBET00gRWxlbWVudHMsIHdoZXJlIGEgZnVsbC1ibG93biB0ZW1wbGF0ZSBpc24ndAogICAgLy8gbmVlZGVkLCB1c2UgKiptYWtlKiogdG8gbWFudWZhY3R1cmUgZWxlbWVudHMsIG9uZSBhdCBhIHRpbWUuCiAgICAvLwogICAgLy8gICAgIHZhciBlbCA9IHRoaXMubWFrZSgnbGknLCB7J2NsYXNzJzogJ3Jvdyd9LCB0aGlzLm1vZGVsLmVzY2FwZSgndGl0bGUnKSk7CiAgICAvLwogICAgbWFrZTogZnVuY3Rpb24odGFnTmFtZSwgYXR0cmlidXRlcywgY29udGVudCkgewogICAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZ05hbWUpOwogICAgICBpZiAoYXR0cmlidXRlcykgQmFja2JvbmUuJChlbCkuYXR0cihhdHRyaWJ1dGVzKTsKICAgICAgaWYgKGNvbnRlbnQgIT0gbnVsbCkgQmFja2JvbmUuJChlbCkuaHRtbChjb250ZW50KTsKICAgICAgcmV0dXJuIGVsOwogICAgfSwKCiAgICAvLyBDaGFuZ2UgdGhlIHZpZXcncyBlbGVtZW50IChgdGhpcy5lbGAgcHJvcGVydHkpLCBpbmNsdWRpbmcgZXZlbnQKICAgIC8vIHJlLWRlbGVnYXRpb24uCiAgICBzZXRFbGVtZW50OiBmdW5jdGlvbihlbGVtZW50LCBkZWxlZ2F0ZSkgewogICAgICBpZiAodGhpcy4kZWwpIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICB0aGlzLiRlbCA9IGVsZW1lbnQgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gZWxlbWVudCA6IEJhY2tib25lLiQoZWxlbWVudCk7CiAgICAgIHRoaXMuZWwgPSB0aGlzLiRlbFswXTsKICAgICAgaWYgKGRlbGVnYXRlICE9PSBmYWxzZSkgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gU2V0IGNhbGxiYWNrcywgd2hlcmUgYHRoaXMuZXZlbnRzYCBpcyBhIGhhc2ggb2YKICAgIC8vCiAgICAvLyAqeyJldmVudCBzZWxlY3RvciI6ICJjYWxsYmFjayJ9KgogICAgLy8KICAgIC8vICAgICB7CiAgICAvLyAgICAgICAnbW91c2Vkb3duIC50aXRsZSc6ICAnZWRpdCcsCiAgICAvLyAgICAgICAnY2xpY2sgLmJ1dHRvbic6ICAgICAnc2F2ZScKICAgIC8vICAgICAgICdjbGljayAub3Blbic6ICAgICAgIGZ1bmN0aW9uKGUpIHsgLi4uIH0KICAgIC8vICAgICB9CiAgICAvLwogICAgLy8gcGFpcnMuIENhbGxiYWNrcyB3aWxsIGJlIGJvdW5kIHRvIHRoZSB2aWV3LCB3aXRoIGB0aGlzYCBzZXQgcHJvcGVybHkuCiAgICAvLyBVc2VzIGV2ZW50IGRlbGVnYXRpb24gZm9yIGVmZmljaWVuY3kuCiAgICAvLyBPbWl0dGluZyB0aGUgc2VsZWN0b3IgYmluZHMgdGhlIGV2ZW50IHRvIGB0aGlzLmVsYC4KICAgIC8vIFRoaXMgb25seSB3b3JrcyBmb3IgZGVsZWdhdGUtYWJsZSBldmVudHM6IG5vdCBgZm9jdXNgLCBgYmx1cmAsIGFuZAogICAgLy8gbm90IGBjaGFuZ2VgLCBgc3VibWl0YCwgYW5kIGByZXNldGAgaW4gSW50ZXJuZXQgRXhwbG9yZXIuCiAgICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oZXZlbnRzKSB7CiAgICAgIGlmICghKGV2ZW50cyB8fCAoZXZlbnRzID0gXy5yZXN1bHQodGhpcywgJ2V2ZW50cycpKSkpIHJldHVybjsKICAgICAgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIGZvciAodmFyIGtleSBpbiBldmVudHMpIHsKICAgICAgICB2YXIgbWV0aG9kID0gZXZlbnRzW2tleV07CiAgICAgICAgaWYgKCFfLmlzRnVuY3Rpb24obWV0aG9kKSkgbWV0aG9kID0gdGhpc1tldmVudHNba2V5XV07CiAgICAgICAgaWYgKCFtZXRob2QpIHRocm93IG5ldyBFcnJvcignTWV0aG9kICInICsgZXZlbnRzW2tleV0gKyAnIiBkb2VzIG5vdCBleGlzdCcpOwogICAgICAgIHZhciBtYXRjaCA9IGtleS5tYXRjaChkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIpOwogICAgICAgIHZhciBldmVudE5hbWUgPSBtYXRjaFsxXSwgc2VsZWN0b3IgPSBtYXRjaFsyXTsKICAgICAgICBtZXRob2QgPSBfLmJpbmQobWV0aG9kLCB0aGlzKTsKICAgICAgICBldmVudE5hbWUgKz0gJy5kZWxlZ2F0ZUV2ZW50cycgKyB0aGlzLmNpZDsKICAgICAgICBpZiAoc2VsZWN0b3IgPT09ICcnKSB7CiAgICAgICAgICB0aGlzLiRlbC5iaW5kKGV2ZW50TmFtZSwgbWV0aG9kKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy4kZWwuZGVsZWdhdGUoc2VsZWN0b3IsIGV2ZW50TmFtZSwgbWV0aG9kKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgLy8gQ2xlYXJzIGFsbCBjYWxsYmFja3MgcHJldmlvdXNseSBib3VuZCB0byB0aGUgdmlldyB3aXRoIGBkZWxlZ2F0ZUV2ZW50c2AuCiAgICAvLyBZb3UgdXN1YWxseSBkb24ndCBuZWVkIHRvIHVzZSB0aGlzLCBidXQgbWF5IHdpc2ggdG8gaWYgeW91IGhhdmUgbXVsdGlwbGUKICAgIC8vIEJhY2tib25lIHZpZXdzIGF0dGFjaGVkIHRvIHRoZSBzYW1lIERPTSBlbGVtZW50LgogICAgdW5kZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLnVuYmluZCgnLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkKTsKICAgIH0sCgogICAgLy8gUGVyZm9ybXMgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbiBvZiBhIFZpZXcgd2l0aCBhIHNldCBvZiBvcHRpb25zLgogICAgLy8gS2V5cyB3aXRoIHNwZWNpYWwgbWVhbmluZyAqKG1vZGVsLCBjb2xsZWN0aW9uLCBpZCwgY2xhc3NOYW1lKSosIGFyZQogICAgLy8gYXR0YWNoZWQgZGlyZWN0bHkgdG8gdGhlIHZpZXcuCiAgICBfY29uZmlndXJlOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmICh0aGlzLm9wdGlvbnMpIG9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ29wdGlvbnMnKSwgb3B0aW9ucyk7CiAgICAgIF8uZXh0ZW5kKHRoaXMsIF8ucGljayhvcHRpb25zLCB2aWV3T3B0aW9ucykpOwogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgfSwKCiAgICAvLyBFbnN1cmUgdGhhdCB0aGUgVmlldyBoYXMgYSBET00gZWxlbWVudCB0byByZW5kZXIgaW50by4KICAgIC8vIElmIGB0aGlzLmVsYCBpcyBhIHN0cmluZywgcGFzcyBpdCB0aHJvdWdoIGAkKClgLCB0YWtlIHRoZSBmaXJzdAogICAgLy8gbWF0Y2hpbmcgZWxlbWVudCwgYW5kIHJlLWFzc2lnbiBpdCB0byBgZWxgLiBPdGhlcndpc2UsIGNyZWF0ZQogICAgLy8gYW4gZWxlbWVudCBmcm9tIHRoZSBgaWRgLCBgY2xhc3NOYW1lYCBhbmQgYHRhZ05hbWVgIHByb3BlcnRpZXMuCiAgICBfZW5zdXJlRWxlbWVudDogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy5lbCkgewogICAgICAgIHZhciBhdHRycyA9IF8uZXh0ZW5kKHt9LCBfLnJlc3VsdCh0aGlzLCAnYXR0cmlidXRlcycpKTsKICAgICAgICBpZiAodGhpcy5pZCkgYXR0cnMuaWQgPSBfLnJlc3VsdCh0aGlzLCAnaWQnKTsKICAgICAgICBpZiAodGhpcy5jbGFzc05hbWUpIGF0dHJzWydjbGFzcyddID0gXy5yZXN1bHQodGhpcywgJ2NsYXNzTmFtZScpOwogICAgICAgIHRoaXMuc2V0RWxlbWVudCh0aGlzLm1ha2UoXy5yZXN1bHQodGhpcywgJ3RhZ05hbWUnKSwgYXR0cnMpLCBmYWxzZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KF8ucmVzdWx0KHRoaXMsICdlbCcpLCBmYWxzZSk7CiAgICAgIH0KICAgIH0KCiAgfSk7CgogIC8vIEJhY2tib25lLnN5bmMKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIE1hcCBmcm9tIENSVUQgdG8gSFRUUCBmb3Igb3VyIGRlZmF1bHQgYEJhY2tib25lLnN5bmNgIGltcGxlbWVudGF0aW9uLgogIHZhciBtZXRob2RNYXAgPSB7CiAgICAnY3JlYXRlJzogJ1BPU1QnLAogICAgJ3VwZGF0ZSc6ICdQVVQnLAogICAgJ3BhdGNoJzogICdQQVRDSCcsCiAgICAnZGVsZXRlJzogJ0RFTEVURScsCiAgICAncmVhZCc6ICAgJ0dFVCcKICB9OwoKICAvLyBPdmVycmlkZSB0aGlzIGZ1bmN0aW9uIHRvIGNoYW5nZSB0aGUgbWFubmVyIGluIHdoaWNoIEJhY2tib25lIHBlcnNpc3RzCiAgLy8gbW9kZWxzIHRvIHRoZSBzZXJ2ZXIuIFlvdSB3aWxsIGJlIHBhc3NlZCB0aGUgdHlwZSBvZiByZXF1ZXN0LCBhbmQgdGhlCiAgLy8gbW9kZWwgaW4gcXVlc3Rpb24uIEJ5IGRlZmF1bHQsIG1ha2VzIGEgUkVTVGZ1bCBBamF4IHJlcXVlc3QKICAvLyB0byB0aGUgbW9kZWwncyBgdXJsKClgLiBTb21lIHBvc3NpYmxlIGN1c3RvbWl6YXRpb25zIGNvdWxkIGJlOgogIC8vCiAgLy8gKiBVc2UgYHNldFRpbWVvdXRgIHRvIGJhdGNoIHJhcGlkLWZpcmUgdXBkYXRlcyBpbnRvIGEgc2luZ2xlIHJlcXVlc3QuCiAgLy8gKiBTZW5kIHVwIHRoZSBtb2RlbHMgYXMgWE1MIGluc3RlYWQgb2YgSlNPTi4KICAvLyAqIFBlcnNpc3QgbW9kZWxzIHZpYSBXZWJTb2NrZXRzIGluc3RlYWQgb2YgQWpheC4KICAvLwogIC8vIFR1cm4gb24gYEJhY2tib25lLmVtdWxhdGVIVFRQYCBpbiBvcmRlciB0byBzZW5kIGBQVVRgIGFuZCBgREVMRVRFYCByZXF1ZXN0cwogIC8vIGFzIGBQT1NUYCwgd2l0aCBhIGBfbWV0aG9kYCBwYXJhbWV0ZXIgY29udGFpbmluZyB0aGUgdHJ1ZSBIVFRQIG1ldGhvZCwKICAvLyBhcyB3ZWxsIGFzIGFsbCByZXF1ZXN0cyB3aXRoIHRoZSBib2R5IGFzIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgCiAgLy8gaW5zdGVhZCBvZiBgYXBwbGljYXRpb24vanNvbmAgd2l0aCB0aGUgbW9kZWwgaW4gYSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIC8vIFVzZWZ1bCB3aGVuIGludGVyZmFjaW5nIHdpdGggc2VydmVyLXNpZGUgbGFuZ3VhZ2VzIGxpa2UgKipQSFAqKiB0aGF0IG1ha2UKICAvLyBpdCBkaWZmaWN1bHQgdG8gcmVhZCB0aGUgYm9keSBvZiBgUFVUYCByZXF1ZXN0cy4KICBCYWNrYm9uZS5zeW5jID0gZnVuY3Rpb24obWV0aG9kLCBtb2RlbCwgb3B0aW9ucykgewogICAgdmFyIHR5cGUgPSBtZXRob2RNYXBbbWV0aG9kXTsKCiAgICAvLyBEZWZhdWx0IG9wdGlvbnMsIHVubGVzcyBzcGVjaWZpZWQuCiAgICBfLmRlZmF1bHRzKG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSksIHsKICAgICAgZW11bGF0ZUhUVFA6IEJhY2tib25lLmVtdWxhdGVIVFRQLAogICAgICBlbXVsYXRlSlNPTjogQmFja2JvbmUuZW11bGF0ZUpTT04KICAgIH0pOwoKICAgIC8vIERlZmF1bHQgSlNPTi1yZXF1ZXN0IG9wdGlvbnMuCiAgICB2YXIgcGFyYW1zID0ge3R5cGU6IHR5cGUsIGRhdGFUeXBlOiAnanNvbid9OwoKICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgYSBVUkwuCiAgICBpZiAoIW9wdGlvbnMudXJsKSB7CiAgICAgIHBhcmFtcy51cmwgPSBfLnJlc3VsdChtb2RlbCwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICB9CgogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSB0aGUgYXBwcm9wcmlhdGUgcmVxdWVzdCBkYXRhLgogICAgaWYgKG9wdGlvbnMuZGF0YSA9PSBudWxsICYmIG1vZGVsICYmIChtZXRob2QgPT09ICdjcmVhdGUnIHx8IG1ldGhvZCA9PT0gJ3VwZGF0ZScgfHwgbWV0aG9kID09PSAncGF0Y2gnKSkgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24vanNvbic7CiAgICAgIHBhcmFtcy5kYXRhID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucy5hdHRycyB8fCBtb2RlbC50b0pTT04ob3B0aW9ucykpOwogICAgfQoKICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEpTT04gYnkgZW5jb2RpbmcgdGhlIHJlcXVlc3QgaW50byBhbiBIVE1MLWZvcm0uCiAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJzsKICAgICAgcGFyYW1zLmRhdGEgPSBwYXJhbXMuZGF0YSA/IHttb2RlbDogcGFyYW1zLmRhdGF9IDoge307CiAgICB9CgogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSFRUUCBieSBtaW1pY2tpbmcgdGhlIEhUVFAgbWV0aG9kIHdpdGggYF9tZXRob2RgCiAgICAvLyBBbmQgYW4gYFgtSFRUUC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICAgIGlmIChvcHRpb25zLmVtdWxhdGVIVFRQICYmICh0eXBlID09PSAnUFVUJyB8fCB0eXBlID09PSAnREVMRVRFJyB8fCB0eXBlID09PSAnUEFUQ0gnKSkgewogICAgICBwYXJhbXMudHlwZSA9ICdQT1NUJzsKICAgICAgaWYgKG9wdGlvbnMuZW11bGF0ZUpTT04pIHBhcmFtcy5kYXRhLl9tZXRob2QgPSB0eXBlOwogICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgb3B0aW9ucy5iZWZvcmVTZW5kID0gZnVuY3Rpb24oeGhyKSB7CiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ1gtSFRUUC1NZXRob2QtT3ZlcnJpZGUnLCB0eXBlKTsKICAgICAgICBpZiAoYmVmb3JlU2VuZCkgcmV0dXJuIGJlZm9yZVNlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KCiAgICAvLyBEb24ndCBwcm9jZXNzIGRhdGEgb24gYSBub24tR0VUIHJlcXVlc3QuCiAgICBpZiAocGFyYW1zLnR5cGUgIT09ICdHRVQnICYmICFvcHRpb25zLmVtdWxhdGVKU09OKSB7CiAgICAgIHBhcmFtcy5wcm9jZXNzRGF0YSA9IGZhbHNlOwogICAgfQoKICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCwgc3RhdHVzLCB4aHIpIHsKICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MocmVzcCwgc3RhdHVzLCB4aHIpOwogICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgfTsKCiAgICB2YXIgZXJyb3IgPSBvcHRpb25zLmVycm9yOwogICAgb3B0aW9ucy5lcnJvciA9IGZ1bmN0aW9uKHhociwgc3RhdHVzLCB0aHJvd24pIHsKICAgICAgaWYgKGVycm9yKSBlcnJvcihtb2RlbCwgeGhyLCBvcHRpb25zKTsKICAgICAgbW9kZWwudHJpZ2dlcignZXJyb3InLCBtb2RlbCwgeGhyLCBvcHRpb25zKTsKICAgIH07CgogICAgLy8gTWFrZSB0aGUgcmVxdWVzdCwgYWxsb3dpbmcgdGhlIHVzZXIgdG8gb3ZlcnJpZGUgYW55IEFqYXggb3B0aW9ucy4KICAgIHZhciB4aHIgPSBCYWNrYm9uZS5hamF4KF8uZXh0ZW5kKHBhcmFtcywgb3B0aW9ucykpOwogICAgbW9kZWwudHJpZ2dlcigncmVxdWVzdCcsIG1vZGVsLCB4aHIsIG9wdGlvbnMpOwogICAgcmV0dXJuIHhocjsKICB9OwoKICAvLyBTZXQgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgYEJhY2tib25lLmFqYXhgIHRvIHByb3h5IHRocm91Z2ggdG8gYCRgLgogIEJhY2tib25lLmFqYXggPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBCYWNrYm9uZS4kLmFqYXguYXBwbHkoQmFja2JvbmUuJCwgYXJndW1lbnRzKTsKICB9OwoKICAvLyBIZWxwZXJzCiAgLy8gLS0tLS0tLQoKICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29ycmVjdGx5IHNldCB1cCB0aGUgcHJvdG90eXBlIGNoYWluLCBmb3Igc3ViY2xhc3Nlcy4KICAvLyBTaW1pbGFyIHRvIGBnb29nLmluaGVyaXRzYCwgYnV0IHVzZXMgYSBoYXNoIG9mIHByb3RvdHlwZSBwcm9wZXJ0aWVzIGFuZAogIC8vIGNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuCiAgdmFyIGV4dGVuZCA9IGZ1bmN0aW9uKHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7CiAgICB2YXIgcGFyZW50ID0gdGhpczsKICAgIHZhciBjaGlsZDsKCiAgICAvLyBUaGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHRoZSBuZXcgc3ViY2xhc3MgaXMgZWl0aGVyIGRlZmluZWQgYnkgeW91CiAgICAvLyAodGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgaW4geW91ciBgZXh0ZW5kYCBkZWZpbml0aW9uKSwgb3IgZGVmYXVsdGVkCiAgICAvLyBieSB1cyB0byBzaW1wbHkgY2FsbCB0aGUgcGFyZW50J3MgY29uc3RydWN0b3IuCiAgICBpZiAocHJvdG9Qcm9wcyAmJiBfLmhhcyhwcm90b1Byb3BzLCAnY29uc3RydWN0b3InKSkgewogICAgICBjaGlsZCA9IHByb3RvUHJvcHMuY29uc3RydWN0b3I7CiAgICB9IGVsc2UgewogICAgICBjaGlsZCA9IGZ1bmN0aW9uKCl7IHBhcmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyB9OwogICAgfQoKICAgIC8vIEFkZCBzdGF0aWMgcHJvcGVydGllcyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24sIGlmIHN1cHBsaWVkLgogICAgXy5leHRlbmQoY2hpbGQsIHBhcmVudCwgc3RhdGljUHJvcHMpOwoKICAgIC8vIFNldCB0aGUgcHJvdG90eXBlIGNoYWluIHRvIGluaGVyaXQgZnJvbSBgcGFyZW50YCwgd2l0aG91dCBjYWxsaW5nCiAgICAvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uKCl7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfTsKICAgIFN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOwogICAgY2hpbGQucHJvdG90eXBlID0gbmV3IFN1cnJvZ2F0ZTsKCiAgICAvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKICAgIC8vIGlmIHN1cHBsaWVkLgogICAgaWYgKHByb3RvUHJvcHMpIF8uZXh0ZW5kKGNoaWxkLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7CgogICAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAogICAgLy8gbGF0ZXIuCiAgICBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOwoKICAgIHJldHVybiBjaGlsZDsKICB9OwoKICAvLyBTZXQgdXAgaW5oZXJpdGFuY2UgZm9yIHRoZSBtb2RlbCwgY29sbGVjdGlvbiwgcm91dGVyLCB2aWV3IGFuZCBoaXN0b3J5LgogIE1vZGVsLmV4dGVuZCA9IENvbGxlY3Rpb24uZXh0ZW5kID0gUm91dGVyLmV4dGVuZCA9IFZpZXcuZXh0ZW5kID0gSGlzdG9yeS5leHRlbmQgPSBleHRlbmQ7CgogIC8vIFRocm93IGFuIGVycm9yIHdoZW4gYSBVUkwgaXMgbmVlZGVkLCBhbmQgbm9uZSBpcyBzdXBwbGllZC4KICB2YXIgdXJsRXJyb3IgPSBmdW5jdGlvbigpIHsKICAgIHRocm93IG5ldyBFcnJvcignQSAidXJsIiBwcm9wZXJ0eSBvciBmdW5jdGlvbiBtdXN0IGJlIHNwZWNpZmllZCcpOwogIH07Cgp9KS5jYWxsKHRoaXMpOwovKgpDb3B5cmlnaHQgKGMpIDIwMTEtMjAxMyBAV2FsbWFydExhYnMKClBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvCmRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlCnJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vcgpzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwpmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgoKVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCgpUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgpJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCkFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcKRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUgpERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiovCgo7OwooZnVuY3Rpb24oKSB7CgovKmdsb2JhbCBjbG9uZUluaGVyaXRWYXJzLCBjcmVhdGVJbmhlcml0VmFycywgY3JlYXRlUmVnaXN0cnlXcmFwcGVyLCBnZXRWYWx1ZSwgaW5oZXJpdFZhcnMgKi8KCi8vc3VwcG9ydCB6ZXB0by5mb3JFYWNoIG9uIGpRdWVyeQppZiAoISQuZm4uZm9yRWFjaCkgewogICQuZm4uZm9yRWFjaCA9IGZ1bmN0aW9uKGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICAkLmZuLmVhY2guY2FsbCh0aGlzLCBmdW5jdGlvbihpbmRleCkgewogICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQgfHwgdGhpcywgdGhpcywgaW5kZXgpOwogICAgfSk7CiAgfTsKfQoKdmFyIHZpZXdOYW1lQXR0cmlidXRlTmFtZSA9ICdkYXRhLXZpZXctbmFtZScsCiAgICB2aWV3Q2lkQXR0cmlidXRlTmFtZSA9ICdkYXRhLXZpZXctY2lkJywKICAgIHZpZXdIZWxwZXJBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtdmlldy1oZWxwZXInOwoKLy92aWV3IGluc3RhbmNlcwp2YXIgdmlld3NJbmRleGVkQnlDaWQgPSB7fTsKCnZhciBUaG9yYXggPSB0aGlzLlRob3JheCA9IHsKICBWRVJTSU9OOiAnMi4wLjBiNicsCiAgdGVtcGxhdGVQYXRoUHJlZml4OiAnJywKICB0ZW1wbGF0ZXM6IHt9LAogIC8vdmlldyBjbGFzc2VzCiAgVmlld3M6IHt9LAogIC8vY2VydGFpbiBlcnJvciBwcm9uZSBwaWVjZXMgb2YgY29kZSAob24gQW5kcm9pZCBvbmx5IGl0IHNlZW1zKQogIC8vYXJlIHdyYXBwZWQgaW4gYSB0cnkgY2F0Y2ggYmxvY2ssIHRoZW4gdHJpZ2dlciB0aGlzIGhhbmRsZXIgaW4KICAvL3RoZSBjYXRjaCwgd2l0aCB0aGUgbmFtZSBvZiB0aGUgZnVuY3Rpb24gb3IgZXZlbnQgdGhhdCB3YXMKICAvL3RyeWluZyB0byBiZSBleGVjdXRlZC4gT3ZlcnJpZGUgdGhpcyB3aXRoIGEgY3VzdG9tIGhhbmRsZXIKICAvL3RvIGRlYnVnIC8gbG9nIC8gZXRjCiAgb25FeGNlcHRpb246IGZ1bmN0aW9uKG5hbWUsIGVycikgewogICAgdGhyb3cgZXJyOwogIH0KfTsKClRob3JheC5WaWV3ID0gQmFja2JvbmUuVmlldy5leHRlbmQoewogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbigpIHsKICAgIHZhciByZXNwb25zZSA9IEJhY2tib25lLlZpZXcuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIF8uZWFjaChpbmhlcml0VmFycywgZnVuY3Rpb24ob2JqKSB7CiAgICAgIGlmIChvYmouY3RvcikgewogICAgICAgIG9iai5jdG9yLmNhbGwodGhpcywgcmVzcG9uc2UpOwogICAgICB9CiAgICB9LCB0aGlzKTsKICAgIHJldHVybiByZXNwb25zZTsKICB9LAogIF9jb25maWd1cmU6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWQgPSB7fTsKICAgIHRoaXMuX2JvdW5kRGF0YU9iamVjdHNCeUNpZCA9IHt9OwoKICAgIC8vIFNldHVwIG9iamVjdCBldmVudCB0cmFja2luZwogICAgXy5lYWNoKGluaGVyaXRWYXJzLCBmdW5jdGlvbihvYmopIHsKICAgICAgc2VsZltvYmoubmFtZV0gPSBbXTsKICAgIH0pOwoKICAgIHZpZXdzSW5kZXhlZEJ5Q2lkW3RoaXMuY2lkXSA9IHRoaXM7CiAgICB0aGlzLmNoaWxkcmVuID0ge307CiAgICB0aGlzLl9yZW5kZXJDb3VudCA9IDA7CgogICAgLy90aGlzLm9wdGlvbnMgaXMgcmVtb3ZlZCBpbiBUaG9yYXguVmlldywgd2UgbWVyZ2UgcGFzc2VkCiAgICAvL3Byb3BlcnRpZXMgZGlyZWN0bHkgd2l0aCB0aGUgdmlldyBhbmQgdGVtcGxhdGUgY29udGV4dAogICAgXy5leHRlbmQodGhpcywgb3B0aW9ucyB8fCB7fSk7CgogICAgLy8gU2V0dXAgaGVscGVycwogICAgYmluZEhlbHBlcnMuY2FsbCh0aGlzKTsKCiAgICAvL2NvbXBpbGUgYSBzdHJpbmcgaWYgaXQgaXMgc2V0IGFzIHRoaXMudGVtcGxhdGUKICAgIGlmICh0eXBlb2YgdGhpcy50ZW1wbGF0ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgdGhpcy50ZW1wbGF0ZSA9IEhhbmRsZWJhcnMuY29tcGlsZSh0aGlzLnRlbXBsYXRlLCB7ZGF0YTogdHJ1ZX0pOwogICAgfSBlbHNlIGlmICh0aGlzLm5hbWUgJiYgIXRoaXMudGVtcGxhdGUpIHsKICAgICAgLy9mZXRjaCB0aGUgdGVtcGxhdGUKICAgICAgdGhpcy50ZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRoaXMubmFtZSwgdHJ1ZSk7CiAgICB9CgogICAgXy5lYWNoKGluaGVyaXRWYXJzLCBmdW5jdGlvbihvYmopIHsKICAgICAgaWYgKG9iai5jb25maWd1cmUpIHsKICAgICAgICBvYmouY29uZmlndXJlLmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0sIHRoaXMpOwogIH0sCgogIHNldEVsZW1lbnQgOiBmdW5jdGlvbigpIHsKICAgIHZhciByZXNwb25zZSA9IEJhY2tib25lLlZpZXcucHJvdG90eXBlLnNldEVsZW1lbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMubmFtZSAmJiB0aGlzLiRlbC5hdHRyKHZpZXdOYW1lQXR0cmlidXRlTmFtZSwgdGhpcy5uYW1lKTsKICAgIHRoaXMuJGVsLmF0dHIodmlld0NpZEF0dHJpYnV0ZU5hbWUsIHRoaXMuY2lkKTsKICAgIHJldHVybiByZXNwb25zZTsKICB9LAoKICBfYWRkQ2hpbGQ6IGZ1bmN0aW9uKHZpZXcpIHsKICAgIHRoaXMuY2hpbGRyZW5bdmlldy5jaWRdID0gdmlldzsKICAgIGlmICghdmlldy5wYXJlbnQpIHsKICAgICAgdmlldy5wYXJlbnQgPSB0aGlzOwogICAgfQogICAgdGhpcy50cmlnZ2VyKCdjaGlsZCcsIHZpZXcpOwogICAgcmV0dXJuIHZpZXc7CiAgfSwKCiAgX3JlbW92ZUNoaWxkOiBmdW5jdGlvbih2aWV3KSB7CiAgICBkZWxldGUgdGhpcy5jaGlsZHJlblt2aWV3LmNpZF07CiAgICB2aWV3LnBhcmVudCA9IG51bGw7CiAgICByZXR1cm4gdmlldzsKICB9LAoKICBkZXN0cm95OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zID0gXy5kZWZhdWx0cyhvcHRpb25zIHx8IHt9LCB7CiAgICAgIGNoaWxkcmVuOiB0cnVlCiAgICB9KTsKICAgIHRoaXMudHJpZ2dlcignZGVzdHJveWVkJyk7CiAgICBkZWxldGUgdmlld3NJbmRleGVkQnlDaWRbdGhpcy5jaWRdOwogICAgXy5lYWNoKHRoaXMuY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgIHRoaXMuX3JlbW92ZUNoaWxkKGNoaWxkKTsKICAgICAgaWYgKG9wdGlvbnMuY2hpbGRyZW4pIHsKICAgICAgICBjaGlsZC5kZXN0cm95KCk7CiAgICAgIH0KICAgIH0sIHRoaXMpOwogICAgdGhpcy5mcmVlemUgJiYgdGhpcy5mcmVlemUoKTsKICB9LAoKICByZW5kZXI6IGZ1bmN0aW9uKG91dHB1dCkgewogICAgdGhpcy5fcHJldmlvdXNIZWxwZXJzID0gXy5maWx0ZXIodGhpcy5jaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQpIHsgcmV0dXJuIGNoaWxkLl9oZWxwZXJPcHRpb25zOyB9KTsKCiAgICB2YXIgY2hpbGRyZW4gPSB7fTsKICAgIF8uZWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCwga2V5KSB7CiAgICAgIGlmICghY2hpbGQuX2hlbHBlck9wdGlvbnMpIHsKICAgICAgICBjaGlsZHJlbltrZXldID0gY2hpbGQ7CiAgICAgIH0KICAgIH0pOwogICAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwoKICAgIGlmICh0eXBlb2Ygb3V0cHV0ID09PSAndW5kZWZpbmVkJyB8fCAoIV8uaXNFbGVtZW50KG91dHB1dCkgJiYgIVRob3JheC5VdGlsLmlzJChvdXRwdXQpICYmICEob3V0cHV0ICYmIG91dHB1dC5lbCkgJiYgdHlwZW9mIG91dHB1dCAhPT0gJ3N0cmluZycgJiYgdHlwZW9mIG91dHB1dCAhPT0gJ2Z1bmN0aW9uJykpIHsKICAgICAgaWYgKCF0aGlzLnRlbXBsYXRlKSB7CiAgICAgICAgLy9pZiB0aGUgbmFtZSB3YXMgc2V0IGFmdGVyIHRoZSB2aWV3IHdhcyBjcmVhdGVkIHRyeSBvbmUgbW9yZSB0aW1lIHRvIGZldGNoIGEgdGVtcGxhdGUKICAgICAgICBpZiAodGhpcy5uYW1lKSB7CiAgICAgICAgICB0aGlzLnRlbXBsYXRlID0gVGhvcmF4LlV0aWwuZ2V0VGVtcGxhdGUodGhpcy5uYW1lLCB0cnVlKTsKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLnRlbXBsYXRlKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1ZpZXcgJyArICh0aGlzLm5hbWUgfHwgdGhpcy5jaWQpICsgJy5yZW5kZXIoKSB3YXMgY2FsbGVkIHdpdGggbm8gY29udGVudCBhbmQgbm8gdGVtcGxhdGUgc2V0IG9uIHRoZSB2aWV3LicpOwogICAgICAgIH0KICAgICAgfQogICAgICBvdXRwdXQgPSB0aGlzLnJlbmRlclRlbXBsYXRlKHRoaXMudGVtcGxhdGUpOwogICAgfSBlbHNlIGlmICh0eXBlb2Ygb3V0cHV0ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIG91dHB1dCA9IHRoaXMucmVuZGVyVGVtcGxhdGUob3V0cHV0KTsKICAgIH0KCiAgICAvLyBEZXN0cm95IGFueSBoZWxwZXJzIHRoYXQgbWF5IGJlIGxpbmdlcmluZwogICAgXy5lYWNoKHRoaXMuX3ByZXZpb3VzSGVscGVycywgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgY2hpbGQuZGVzdHJveSgpOwogICAgICBjaGlsZC5wYXJlbnQgPSB1bmRlZmluZWQ7CiAgICB9KTsKICAgIHRoaXMuX3ByZXZpb3VzSGVscGVycyA9IHVuZGVmaW5lZDsKCiAgICAvL2FjY2VwdCBhIHZpZXcsIHN0cmluZywgSGFuZGxlYmFycy5TYWZlU3RyaW5nIG9yIERPTSBlbGVtZW50CiAgICB0aGlzLmh0bWwoKG91dHB1dCAmJiBvdXRwdXQuZWwpIHx8IChvdXRwdXQgJiYgb3V0cHV0LnN0cmluZykgfHwgb3V0cHV0KTsKICAgICsrdGhpcy5fcmVuZGVyQ291bnQ7CiAgICB0aGlzLnRyaWdnZXIoJ3JlbmRlcmVkJyk7CiAgICByZXR1cm4gb3V0cHV0OwogIH0sCgogIGNvbnRleHQ6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuICh0aGlzLm1vZGVsICYmIHRoaXMubW9kZWwuYXR0cmlidXRlcykgfHwge307CiAgfSwKCiAgX2dldENvbnRleHQ6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIF8uZXh0ZW5kKHt9LCB0aGlzLCBnZXRWYWx1ZSh0aGlzLCAnY29udGV4dCcpIHx8IHt9KTsKICB9LAoKICAvLyBQcml2YXRlIHZhcmlhYmxlcyBpbiBoYW5kbGViYXJzIC8gb3B0aW9ucy5kYXRhIGluIHRlbXBsYXRlIGhlbHBlcnMKICBfZ2V0RGF0YTogZnVuY3Rpb24oZGF0YSkgewogICAgcmV0dXJuIHsKICAgICAgdmlldzogdGhpcywKICAgICAgY2lkOiBfLnVuaXF1ZUlkKCd0JyksCiAgICAgIHlpZWxkOiBmdW5jdGlvbigpIHsKICAgICAgICAvLyBmbiBpcyBzZWVkZWQgYnkgdGVtcGxhdGUgaGVscGVyIHBhc3NpbmcgY29udGV4dCB0byBkYXRhCiAgICAgICAgcmV0dXJuIGRhdGEuZm4gJiYgZGF0YS5mbihkYXRhKTsKICAgICAgfQogICAgfTsKICB9LAoKICBfZ2V0SGVscGVyczogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5oZWxwZXJzKSB7CiAgICAgIHJldHVybiBfLmV4dGVuZCh7fSwgSGFuZGxlYmFycy5oZWxwZXJzLCB0aGlzLmhlbHBlcnMpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIEhhbmRsZWJhcnMuaGVscGVyczsKICAgIH0KCiAgfSwKCiAgcmVuZGVyVGVtcGxhdGU6IGZ1bmN0aW9uKGZpbGUsIGNvbnRleHQsIGlnbm9yZUVycm9ycykgewogICAgdmFyIHRlbXBsYXRlOwogICAgY29udGV4dCA9IGNvbnRleHQgfHwgdGhpcy5fZ2V0Q29udGV4dCgpOwogICAgaWYgKHR5cGVvZiBmaWxlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHRlbXBsYXRlID0gZmlsZTsKICAgIH0gZWxzZSB7CiAgICAgIHRlbXBsYXRlID0gVGhvcmF4LlV0aWwuZ2V0VGVtcGxhdGUoZmlsZSk7CiAgICB9CiAgICBpZiAoIXRlbXBsYXRlKSB7CiAgICAgIGlmIChpZ25vcmVFcnJvcnMpIHsKICAgICAgICByZXR1cm4gJyc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmFibGUgdG8gZmluZCB0ZW1wbGF0ZSAnICsgZmlsZSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0ZW1wbGF0ZShjb250ZXh0LCB7CiAgICAgICAgaGVscGVyczogdGhpcy5fZ2V0SGVscGVycygpLAogICAgICAgIGRhdGE6IHRoaXMuX2dldERhdGEoY29udGV4dCkKICAgICAgfSk7CiAgICB9CiAgfSwKCiAgZW5zdXJlUmVuZGVyZWQ6IGZ1bmN0aW9uKCkgewogICAgIXRoaXMuX3JlbmRlckNvdW50ICYmIHRoaXMucmVuZGVyKCk7CiAgfSwKCiAgYXBwZW5kVG86IGZ1bmN0aW9uKGVsKSB7CiAgICB0aGlzLmVuc3VyZVJlbmRlcmVkKCk7CiAgICAkKGVsKS5hcHBlbmQodGhpcy5lbCk7CiAgICB0aGlzLnRyaWdnZXIoJ3JlYWR5Jyk7CiAgfSwKCiAgaHRtbDogZnVuY3Rpb24oaHRtbCkgewoKICAgIGZ1bmN0aW9uIHJlcGxhY2VIVE1MKHZpZXcpIHsKICAgICAgdmlldy5lbC5pbm5lckhUTUwgPSAiIjsKICAgICAgcmV0dXJuIHZpZXcuJGVsLmFwcGVuZChodG1sKTsKICAgIH0KCiAgICBpZiAodHlwZW9mIGh0bWwgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHJldHVybiB0aGlzLmVsLmlubmVySFRNTDsKICAgIH0gZWxzZSB7CiAgICAgIC8vIEV2ZW50IGZvciBJRSBlbGVtZW50IGZpeGVzCiAgICAgIHRoaXMudHJpZ2dlcignYmVmb3JlOmFwcGVuZCcpOwogICAgICB2YXIgZWxlbWVudDsKICAgICAgaWYgKHRoaXMuY29sbGVjdGlvbiAmJiB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbdGhpcy5jb2xsZWN0aW9uLmNpZF0gJiYgdGhpcy5fcmVuZGVyQ291bnQpIHsKICAgICAgICAvLyBwcmVzZXJ2ZSBjb2xsZWN0aW9uIGVsZW1lbnQgaWYgaXQgd2FzIG5vdCBjcmVhdGVkIHdpdGgge3tjb2xsZWN0aW9ufX0gaGVscGVyCiAgICAgICAgdmFyIG9sZENvbGxlY3Rpb25FbGVtZW50ID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogICAgICAgIGVsZW1lbnQgPSByZXBsYWNlSFRNTCh0aGlzKTsKICAgICAgICBpZiAoIW9sZENvbGxlY3Rpb25FbGVtZW50LmF0dHIoJ2RhdGEtdmlldy1jaWQnKSkgewogICAgICAgICAgdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpLnJlcGxhY2VXaXRoKG9sZENvbGxlY3Rpb25FbGVtZW50KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZWxlbWVudCA9IHJlcGxhY2VIVE1MKHRoaXMpOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlcignYXBwZW5kJyk7CiAgICAgIHJldHVybiBlbGVtZW50OwogICAgfQogIH0sCgogIF9hbmNob3JDbGljazogZnVuY3Rpb24oZXZlbnQpIHsKICAgIHZhciB0YXJnZXQgPSAkKGV2ZW50LmN1cnJlbnRUYXJnZXQpLAogICAgICAgIGhyZWYgPSB0YXJnZXQuYXR0cignaHJlZicpOwogICAgLy8gUm91dGUgYW55dGhpbmcgdGhhdCBzdGFydHMgd2l0aCAjIG9yIC8gKGV4Y2x1ZGluZyAvL2RvbWFpbiB1cmxzKQogICAgaWYgKGhyZWYgJiYgKGhyZWZbMF0gPT09ICcjJyB8fCAoaHJlZlswXSA9PT0gJy8nICYmIGhyZWZbMV0gIT09ICcvJykpKSB7CiAgICAgIEJhY2tib25lLmhpc3RvcnkubmF2aWdhdGUoaHJlZiwgewogICAgICAgIHRyaWdnZXI6IHRydWUKICAgICAgfSk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KfSk7CgpUaG9yYXguVmlldy5leHRlbmQgPSBmdW5jdGlvbigpIHsKICBjcmVhdGVJbmhlcml0VmFycyh0aGlzKTsKCiAgdmFyIGNoaWxkID0gQmFja2JvbmUuVmlldy5leHRlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICBjaGlsZC5fX3BhcmVudF9fID0gdGhpczsKCiAgcmVzZXRJbmhlcml0VmFycyhjaGlsZCk7CgogIHJldHVybiBjaGlsZDsKfTsKCmNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcihUaG9yYXguVmlldywgVGhvcmF4LlZpZXdzKTsKCmZ1bmN0aW9uIGJpbmRIZWxwZXJzKCkgewogIGlmICh0aGlzLmhlbHBlcnMpIHsKICAgIF8uZWFjaCh0aGlzLmhlbHBlcnMsIGZ1bmN0aW9uKGhlbHBlciwgbmFtZSkgewogICAgICB2YXIgdmlldyA9IHRoaXM7CiAgICAgIHRoaXMuaGVscGVyc1tuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gXy50b0FycmF5KGFyZ3VtZW50cyksCiAgICAgICAgICAgIG9wdGlvbnMgPSBfLmxhc3QoYXJncyk7CiAgICAgICAgb3B0aW9ucy5jb250ZXh0ID0gdGhpczsKICAgICAgICByZXR1cm4gaGVscGVyLmFwcGx5KHZpZXcsIGFyZ3MpOwogICAgICB9OwogICAgfSwgdGhpcyk7CiAgfQp9CgovLyQoc2VsZWN0b3IpLnZpZXcoKSBoZWxwZXIKJC5mbi52aWV3ID0gZnVuY3Rpb24ob3B0aW9ucykgewogIG9wdGlvbnMgPSBfLmRlZmF1bHRzKG9wdGlvbnMgfHwge30sIHsKICAgIGhlbHBlcjogdHJ1ZQogIH0pOwogIHZhciBzZWxlY3RvciA9ICdbJyArIHZpZXdDaWRBdHRyaWJ1dGVOYW1lICsgJ10nOwogIGlmICghb3B0aW9ucy5oZWxwZXIpIHsKICAgIHNlbGVjdG9yICs9ICc6bm90KFsnICsgdmlld0hlbHBlckF0dHJpYnV0ZU5hbWUgKyAnXSknOwogIH0KICB2YXIgZWwgPSAkKHRoaXMpLmNsb3Nlc3Qoc2VsZWN0b3IpOwogIHJldHVybiAoZWwgJiYgdmlld3NJbmRleGVkQnlDaWRbZWwuYXR0cih2aWV3Q2lkQXR0cmlidXRlTmFtZSldKSB8fCBmYWxzZTsKfTsKCjs7Ci8qZ2xvYmFsIGNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcjp0cnVlLCBjbG9uZUV2ZW50czogdHJ1ZSAqLwpmdW5jdGlvbiBjcmVhdGVSZWdpc3RyeVdyYXBwZXIoa2xhc3MsIGhhc2gpIHsKICB2YXIgJHN1cGVyID0ga2xhc3MuZXh0ZW5kOwogIGtsYXNzLmV4dGVuZCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGNoaWxkID0gJHN1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBpZiAoY2hpbGQucHJvdG90eXBlLm5hbWUpIHsKICAgICAgaGFzaFtjaGlsZC5wcm90b3R5cGUubmFtZV0gPSBjaGlsZDsKICAgIH0KICAgIHJldHVybiBjaGlsZDsKICB9Owp9CmZ1bmN0aW9uIHJlZ2lzdHJ5R2V0KG9iamVjdCwgdHlwZSwgbmFtZSwgaWdub3JlRXJyb3JzKSB7CiAgdmFyIHRhcmdldCA9IG9iamVjdFt0eXBlXSwKICAgICAgdmFsdWU7CiAgaWYgKG5hbWUuaW5kZXhPZignLicpID49IDApIHsKICAgIHZhciBiaXRzID0gbmFtZS5zcGxpdCgvXC4vKTsKICAgIG5hbWUgPSBiaXRzLnBvcCgpOwogICAgXy5lYWNoKGJpdHMsIGZ1bmN0aW9uKGtleSkgewogICAgICB0YXJnZXQgPSB0YXJnZXRba2V5XTsKICAgIH0pOwogIH0KICB0YXJnZXQgJiYgKHZhbHVlID0gdGFyZ2V0W25hbWVdKTsKICBpZiAoIXZhbHVlICYmICFpZ25vcmVFcnJvcnMpIHsKICAgIHRocm93IG5ldyBFcnJvcih0eXBlICsgJzogJyArIG5hbWUgKyAnIGRvZXMgbm90IGV4aXN0LicpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQp9CgovLyBnZXRWYWx1ZSBpcyB1c2VkIGluc3RlYWQgb2YgXy5yZXN1bHQgYmVjYXVzZSB3ZQovLyBuZWVkIGFuIGV4dHJhIHNjb3BlIHBhcmFtZXRlciwgYW5kIHdpbGwgbWluaWZ5Ci8vIGJldHRlciB0aGFuIF8ucmVzdWx0CmZ1bmN0aW9uIGdldFZhbHVlKG9iamVjdCwgcHJvcCwgc2NvcGUpIHsKICBpZiAoIShvYmplY3QgJiYgb2JqZWN0W3Byb3BdKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiBfLmlzRnVuY3Rpb24ob2JqZWN0W3Byb3BdKQogICAgPyBvYmplY3RbcHJvcF0uY2FsbChzY29wZSB8fCBvYmplY3QpCiAgICA6IG9iamVjdFtwcm9wXTsKfQoKdmFyIGluaGVyaXRWYXJzID0ge307CmZ1bmN0aW9uIGNyZWF0ZUluaGVyaXRWYXJzKHNlbGYpIHsKICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIG91ciBzdGF0aWMgZXZlbnQgb2JqZWN0cwogIF8uZWFjaChpbmhlcml0VmFycywgZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIXNlbGZbb2JqLm5hbWVdKSB7CiAgICAgIHNlbGZbb2JqLm5hbWVdID0gW107CiAgICB9CiAgfSk7Cn0KZnVuY3Rpb24gcmVzZXRJbmhlcml0VmFycyhzZWxmKSB7CiAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSBvdXIgc3RhdGljIGV2ZW50IG9iamVjdHMKICBfLmVhY2goaW5oZXJpdFZhcnMsIGZ1bmN0aW9uKG9iaikgewogICAgc2VsZltvYmoubmFtZV0gPSBbXTsKICB9KTsKfQpmdW5jdGlvbiB3YWxrSW5oZXJpdFRyZWUoc291cmNlLCBmaWVsZE5hbWUsIGlzU3RhdGljLCBjYWxsYmFjaykgewogIHZhciB0cmVlID0gW107CiAgaWYgKF8uaGFzKHNvdXJjZSwgZmllbGROYW1lKSkgewogICAgdHJlZS5wdXNoKHNvdXJjZSk7CiAgfQogIHZhciBpdGVyYXRlID0gc291cmNlOwogIGlmIChpc1N0YXRpYykgewogICAgd2hpbGUgKGl0ZXJhdGUgPSBpdGVyYXRlLl9fcGFyZW50X18pIHsKICAgICAgaWYgKF8uaGFzKGl0ZXJhdGUsIGZpZWxkTmFtZSkpIHsKICAgICAgICB0cmVlLnB1c2goaXRlcmF0ZSk7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgaXRlcmF0ZSA9IGl0ZXJhdGUuY29uc3RydWN0b3I7CiAgICB3aGlsZSAoaXRlcmF0ZSkgewogICAgICBpZiAoaXRlcmF0ZS5wcm90b3R5cGUgJiYgXy5oYXMoaXRlcmF0ZS5wcm90b3R5cGUsIGZpZWxkTmFtZSkpIHsKICAgICAgICB0cmVlLnB1c2goaXRlcmF0ZS5wcm90b3R5cGUpOwogICAgICB9CiAgICAgIGl0ZXJhdGUgPSBpdGVyYXRlLl9fc3VwZXJfXyAmJiBpdGVyYXRlLl9fc3VwZXJfXy5jb25zdHJ1Y3RvcjsKICAgIH0KICB9CgogIHZhciBpID0gdHJlZS5sZW5ndGg7CiAgd2hpbGUgKGktLSkgewogICAgXy5lYWNoKGdldFZhbHVlKHRyZWVbaV0sIGZpZWxkTmFtZSwgc291cmNlKSwgY2FsbGJhY2spOwogIH0KfQoKZnVuY3Rpb24gb2JqZWN0RXZlbnRzKHRhcmdldCwgZXZlbnROYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogIGlmIChfLmlzT2JqZWN0KGNhbGxiYWNrKSkgewogICAgdmFyIHNwZWMgPSBpbmhlcml0VmFyc1tldmVudE5hbWVdOwogICAgaWYgKHNwZWMgJiYgc3BlYy5ldmVudCkgewogICAgICBhZGRFdmVudHModGFyZ2V0WydfJyArIGV2ZW50TmFtZSArICdFdmVudHMnXSwgY2FsbGJhY2ssIGNvbnRleHQpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9Cn0KZnVuY3Rpb24gYWRkRXZlbnRzKHRhcmdldCwgc291cmNlLCBjb250ZXh0KSB7CiAgXy5lYWNoKHNvdXJjZSwgZnVuY3Rpb24oY2FsbGJhY2ssIGV2ZW50TmFtZSkgewogICAgaWYgKF8uaXNBcnJheShjYWxsYmFjaykpIHsKICAgICAgXy5lYWNoKGNhbGxiYWNrLCBmdW5jdGlvbihjYikgewogICAgICAgIHRhcmdldC5wdXNoKFtldmVudE5hbWUsIGNiLCBjb250ZXh0XSk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgdGFyZ2V0LnB1c2goW2V2ZW50TmFtZSwgY2FsbGJhY2ssIGNvbnRleHRdKTsKICAgIH0KICB9KTsKfQoKZnVuY3Rpb24gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykgewogIGlmICghb3B0aW9ucyB8fCAhb3B0aW9ucy5kYXRhKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0hhbmRsZWJhcnMgdGVtcGxhdGUgY29tcGlsZWQgd2l0aG91dCBkYXRhLCB1c2U6IEhhbmRsZWJhcnMuY29tcGlsZSh0ZW1wbGF0ZSwge2RhdGE6IHRydWV9KScpOwogIH0KICByZXR1cm4gb3B0aW9ucy5kYXRhOwp9CgpUaG9yYXguVXRpbCA9IHsKICBnZXRWaWV3SW5zdGFuY2U6IGZ1bmN0aW9uKG5hbWUsIGF0dHJpYnV0ZXMpIHsKICAgIGF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzIHx8IHt9OwogICAgYXR0cmlidXRlc1snY2xhc3MnXSAmJiAoYXR0cmlidXRlcy5jbGFzc05hbWUgPSBhdHRyaWJ1dGVzWydjbGFzcyddKTsKICAgIGF0dHJpYnV0ZXMudGFnICYmIChhdHRyaWJ1dGVzLnRhZ05hbWUgPSBhdHRyaWJ1dGVzLnRhZyk7CiAgICBpZiAodHlwZW9mIG5hbWUgPT09ICdzdHJpbmcnKSB7CiAgICAgIHZhciBLbGFzcyA9IHJlZ2lzdHJ5R2V0KFRob3JheCwgJ1ZpZXdzJywgbmFtZSwgZmFsc2UpOwogICAgICByZXR1cm4gS2xhc3MuY2lkID8gXy5leHRlbmQoS2xhc3MsIGF0dHJpYnV0ZXMgfHwge30pIDogbmV3IEtsYXNzKGF0dHJpYnV0ZXMpOwogICAgfSBlbHNlIGlmICh0eXBlb2YgbmFtZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICByZXR1cm4gbmV3IG5hbWUoYXR0cmlidXRlcyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbmFtZTsKICAgIH0KICB9LAoKICBnZXRUZW1wbGF0ZTogZnVuY3Rpb24oZmlsZSwgaWdub3JlRXJyb3JzKSB7CiAgICAvL2FwcGVuZCB0aGUgdGVtcGxhdGUgcGF0aCBwcmVmaXggaWYgaXQgaXMgbWlzc2luZwogICAgdmFyIHBhdGhQcmVmaXggPSBUaG9yYXgudGVtcGxhdGVQYXRoUHJlZml4LAogICAgICAgIHRlbXBsYXRlOwogICAgaWYgKHBhdGhQcmVmaXggJiYgZmlsZS5zdWJzdHIoMCwgcGF0aFByZWZpeC5sZW5ndGgpICE9PSBwYXRoUHJlZml4KSB7CiAgICAgIGZpbGUgPSBwYXRoUHJlZml4ICsgZmlsZTsKICAgIH0KCiAgICAvLyBXaXRob3V0IGV4dGVuc2lvbgogICAgZmlsZSA9IGZpbGUucmVwbGFjZSgvXC5oYW5kbGViYXJzJC8sICcnKTsKICAgIHRlbXBsYXRlID0gVGhvcmF4LnRlbXBsYXRlc1tmaWxlXTsKICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgLy8gV2l0aCBleHRlbnNpb24KICAgICAgZmlsZSA9IGZpbGUgKyAnLmhhbmRsZWJhcnMnOwogICAgICB0ZW1wbGF0ZSA9IFRob3JheC50ZW1wbGF0ZXNbZmlsZV07CiAgICB9CgogICAgaWYgKHRlbXBsYXRlICYmIHR5cGVvZiB0ZW1wbGF0ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgdGVtcGxhdGUgPSBUaG9yYXgudGVtcGxhdGVzW2ZpbGVdID0gSGFuZGxlYmFycy5jb21waWxlKHRlbXBsYXRlLCB7ZGF0YTogdHJ1ZX0pOwogICAgfSBlbHNlIGlmICghdGVtcGxhdGUgJiYgIWlnbm9yZUVycm9ycykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ3RlbXBsYXRlczogJyArIGZpbGUgKyAnIGRvZXMgbm90IGV4aXN0LicpOwogICAgfQogICAgcmV0dXJuIHRlbXBsYXRlOwogIH0sCgogIC8vJ3NlbGVjdG9yJyBpcyBub3QgcHJlc2VudCBpbiAkKCc8cD48L3A+JykKICAvL1RPRE86IGludmVzdGlnYWdlIGEgYmV0dGVyIGRldGVjdGlvbiBtZXRob2QKICBpcyQ6IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICdvYmplY3QnICYmICgnbGVuZ3RoJyBpbiBvYmopOwogIH0sCiAgZXhwYW5kVG9rZW46IGZ1bmN0aW9uKGlucHV0LCBzY29wZSkgewogICAgaWYgKGlucHV0ICYmIGlucHV0LmluZGV4T2YgJiYgaW5wdXQuaW5kZXhPZigne3snKSA+PSAwKSB7CiAgICAgIHZhciByZSA9IC8oPzpcez9bXntdKyl8KD86XHtceyhbXn1dKylcfVx9KS9nLAogICAgICAgICAgbWF0Y2gsCiAgICAgICAgICByZXQgPSBbXTsKICAgICAgZnVuY3Rpb24gZGVyZWYodG9rZW4sIHNjb3BlKSB7CiAgICAgICAgaWYgKHRva2VuLm1hdGNoKC9eKCJ8JykvKSAmJiB0b2tlbi5tYXRjaCgvKCJ8JykkLykpIHsKICAgICAgICAgIHJldHVybiB0b2tlbi5yZXBsYWNlKC8oXigifCcpfCgnfCIpJCkvZywgJycpOwogICAgICAgIH0KICAgICAgICB2YXIgc2VnbWVudHMgPSB0b2tlbi5zcGxpdCgnLicpLAogICAgICAgICAgICBsZW4gPSBzZWdtZW50cy5sZW5ndGg7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IHNjb3BlICYmIGkgPCBsZW47IGkrKykgewogICAgICAgICAgaWYgKHNlZ21lbnRzW2ldICE9PSAndGhpcycpIHsKICAgICAgICAgICAgc2NvcGUgPSBzY29wZVtzZWdtZW50c1tpXV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzY29wZTsKICAgICAgfQogICAgICB3aGlsZSAobWF0Y2ggPSByZS5leGVjKGlucHV0KSkgewogICAgICAgIGlmIChtYXRjaFsxXSkgewogICAgICAgICAgdmFyIHBhcmFtcyA9IG1hdGNoWzFdLnNwbGl0KC9ccysvKTsKICAgICAgICAgIGlmIChwYXJhbXMubGVuZ3RoID4gMSkgewogICAgICAgICAgICB2YXIgaGVscGVyID0gcGFyYW1zLnNoaWZ0KCk7CiAgICAgICAgICAgIHBhcmFtcyA9IF8ubWFwKHBhcmFtcywgZnVuY3Rpb24ocGFyYW0pIHsgcmV0dXJuIGRlcmVmKHBhcmFtLCBzY29wZSk7IH0pOwogICAgICAgICAgICBpZiAoSGFuZGxlYmFycy5oZWxwZXJzW2hlbHBlcl0pIHsKICAgICAgICAgICAgICByZXQucHVzaChIYW5kbGViYXJzLmhlbHBlcnNbaGVscGVyXS5hcHBseShzY29wZSwgcGFyYW1zKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gSWYgdGhlIGhlbHBlciBpcyBub3QgZGVmaW5lZCBkbyBub3RoaW5nCiAgICAgICAgICAgICAgcmV0LnB1c2gobWF0Y2hbMF0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXQucHVzaChkZXJlZihwYXJhbXNbMF0sIHNjb3BlKSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldC5wdXNoKG1hdGNoWzBdKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaW5wdXQgPSByZXQuam9pbignJyk7CiAgICB9CiAgICByZXR1cm4gaW5wdXQ7CiAgfSwKICB0YWc6IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIGNvbnRlbnQsIHNjb3BlKSB7CiAgICB2YXIgaHRtbEF0dHJpYnV0ZXMgPSBfLm9taXQoYXR0cmlidXRlcywgJ3RhZycsICd0YWdOYW1lJyksCiAgICAgICAgdGFnID0gYXR0cmlidXRlcy50YWcgfHwgYXR0cmlidXRlcy50YWdOYW1lIHx8ICdkaXYnOwogICAgcmV0dXJuICc8JyArIHRhZyArICcgJyArIF8ubWFwKGh0bWxBdHRyaWJ1dGVzLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICd1bmRlZmluZWQnIHx8IGtleSA9PT0gJ2V4cGFuZC10b2tlbnMnKSB7CiAgICAgICAgcmV0dXJuICcnOwogICAgICB9CiAgICAgIHZhciBmb3JtYXR0ZWRWYWx1ZSA9IHZhbHVlOwogICAgICBpZiAoc2NvcGUpIHsKICAgICAgICBmb3JtYXR0ZWRWYWx1ZSA9IFRob3JheC5VdGlsLmV4cGFuZFRva2VuKHZhbHVlLCBzY29wZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGtleSArICc9IicgKyBIYW5kbGViYXJzLlV0aWxzLmVzY2FwZUV4cHJlc3Npb24oZm9ybWF0dGVkVmFsdWUpICsgJyInOwogICAgfSkuam9pbignICcpICsgJz4nICsgKHR5cGVvZiBjb250ZW50ID09PSAndW5kZWZpbmVkJyA/ICcnIDogY29udGVudCkgKyAnPC8nICsgdGFnICsgJz4nOwogIH0sCiAgaHRtbEF0dHJpYnV0ZXNGcm9tT3B0aW9uczogZnVuY3Rpb24ob3B0aW9ucykgewogICAgdmFyIGh0bWxBdHRyaWJ1dGVzID0ge307CiAgICBpZiAob3B0aW9ucy50YWcpIHsKICAgICAgaHRtbEF0dHJpYnV0ZXMudGFnID0gb3B0aW9ucy50YWc7CiAgICB9CiAgICBpZiAob3B0aW9ucy50YWdOYW1lKSB7CiAgICAgIGh0bWxBdHRyaWJ1dGVzLnRhZ05hbWUgPSBvcHRpb25zLnRhZ05hbWU7CiAgICB9CiAgICBpZiAob3B0aW9uc1snY2xhc3MnXSkgewogICAgICBodG1sQXR0cmlidXRlc1snY2xhc3MnXSA9IG9wdGlvbnNbJ2NsYXNzJ107CiAgICB9CiAgICBpZiAob3B0aW9ucy5pZCkgewogICAgICBodG1sQXR0cmlidXRlcy5pZCA9IG9wdGlvbnMuaWQ7CiAgICB9CiAgICByZXR1cm4gaHRtbEF0dHJpYnV0ZXM7CiAgfQp9OwoKOzsKLypnbG9iYWwgY3JlYXRlSW5oZXJpdFZhcnMsIGluaGVyaXRWYXJzICovClRob3JheC5NaXhpbnMgPSB7fTsKCmluaGVyaXRWYXJzLm1peGlucyA9IHsKICBuYW1lOiAnbWl4aW5zJywKICBjb25maWd1cmU6IGZ1bmN0aW9uKCkgewogICAgXy5lYWNoKHRoaXMuY29uc3RydWN0b3IubWl4aW5zLCB0aGlzLm1peGluLCB0aGlzKTsKICAgIF8uZWFjaCh0aGlzLm1peGlucywgdGhpcy5taXhpbiwgdGhpcyk7CiAgfQp9OwoKXy5leHRlbmQoVGhvcmF4LlZpZXcsIHsKICBtaXhpbjogZnVuY3Rpb24obWl4aW4pIHsKICAgIGNyZWF0ZUluaGVyaXRWYXJzKHRoaXMpOwogICAgdGhpcy5taXhpbnMucHVzaChtaXhpbik7CiAgfSwKICByZWdpc3Rlck1peGluOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgbWV0aG9kcykgewogICAgVGhvcmF4Lk1peGluc1tuYW1lXSA9IFtjYWxsYmFjaywgbWV0aG9kc107CiAgfQp9KTsKClRob3JheC5WaWV3LnByb3RvdHlwZS5taXhpbiA9IGZ1bmN0aW9uKG5hbWUpIHsKICBpZiAoIXRoaXMuX2FwcGxpZWRNaXhpbnMpIHsKICAgIHRoaXMuX2FwcGxpZWRNaXhpbnMgPSBbXTsKICB9CiAgaWYgKHRoaXMuX2FwcGxpZWRNaXhpbnMuaW5kZXhPZihuYW1lKSA9PT0gLTEpIHsKICAgIHRoaXMuX2FwcGxpZWRNaXhpbnMucHVzaChuYW1lKTsKICAgIGlmICh0eXBlb2YgbmFtZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBuYW1lLmNhbGwodGhpcyk7CiAgICB9IGVsc2UgewogICAgICB2YXIgbWl4aW4gPSBUaG9yYXguTWl4aW5zW25hbWVdOwogICAgICBfLmV4dGVuZCh0aGlzLCBtaXhpblsxXSk7CiAgICAgIC8vbWl4aW4gY2FsbGJhY2sgbWF5IGJlIGFuIGFycmF5IG9mIFtjYWxsYmFjaywgYXJndW1lbnRzXQogICAgICBpZiAoXy5pc0FycmF5KG1peGluWzBdKSkgewogICAgICAgIG1peGluWzBdWzBdLmFwcGx5KHRoaXMsIG1peGluWzBdWzFdKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtaXhpblswXS5hcHBseSh0aGlzLCBfLnRvQXJyYXkoYXJndW1lbnRzKS5zbGljZSgxKSk7CiAgICAgIH0KICAgIH0KICB9Cn07Cgo7OwovKmdsb2JhbCBjcmVhdGVJbmhlcml0VmFycywgaW5oZXJpdFZhcnMsIG9iamVjdEV2ZW50cywgd2Fsa0luaGVyaXRUcmVlICovCi8vIFNhdmUgYSBjb3B5IG9mIHRoZSBfb24gbWV0aG9kIHRvIGNhbGwgYXMgYSAkc3VwZXIgbWV0aG9kCnZhciBfb24gPSBUaG9yYXguVmlldy5wcm90b3R5cGUub247Cgppbmhlcml0VmFycy5ldmVudCA9IHsKICBuYW1lOiAnX2V2ZW50cycsCgogIGNvbmZpZ3VyZTogZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB3YWxrSW5oZXJpdFRyZWUodGhpcy5jb25zdHJ1Y3RvciwgJ19ldmVudHMnLCB0cnVlLCBmdW5jdGlvbihldmVudCkgewogICAgICBzZWxmLm9uLmFwcGx5KHNlbGYsIGV2ZW50KTsKICAgIH0pOwogICAgd2Fsa0luaGVyaXRUcmVlKHRoaXMsICdldmVudHMnLCBmYWxzZSwgZnVuY3Rpb24oaGFuZGxlciwgZXZlbnROYW1lKSB7CiAgICAgIHNlbGYub24oZXZlbnROYW1lLCBoYW5kbGVyLCBzZWxmKTsKICAgIH0pOwogIH0KfTsKCl8uZXh0ZW5kKFRob3JheC5WaWV3LCB7CiAgb246IGZ1bmN0aW9uKGV2ZW50TmFtZSwgY2FsbGJhY2spIHsKICAgIGNyZWF0ZUluaGVyaXRWYXJzKHRoaXMpOwoKICAgIGlmIChvYmplY3RFdmVudHModGhpcywgZXZlbnROYW1lLCBjYWxsYmFjaykpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgLy9hY2NlcHQgb24oeyJyZW5kZXJlZCI6IGhhbmRsZXJ9KQogICAgaWYgKHR5cGVvZiBldmVudE5hbWUgPT09ICdvYmplY3QnKSB7CiAgICAgIF8uZWFjaChldmVudE5hbWUsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICB0aGlzLm9uKGtleSwgdmFsdWUpOwogICAgICB9LCB0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vYWNjZXB0IG9uKHsicmVuZGVyZWQiOiBbaGFuZGxlciwgaGFuZGxlcl19KQogICAgICBpZiAoXy5pc0FycmF5KGNhbGxiYWNrKSkgewogICAgICAgIF8uZWFjaChjYWxsYmFjaywgZnVuY3Rpb24oY2IpIHsKICAgICAgICAgIHRoaXMuX2V2ZW50cy5wdXNoKFtldmVudE5hbWUsIGNiXSk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgIC8vYWNjZXB0IG9uKCJyZW5kZXJlZCIsIGhhbmRsZXIpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fZXZlbnRzLnB1c2goW2V2ZW50TmFtZSwgY2FsbGJhY2tdKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQp9KTsKCl8uZXh0ZW5kKFRob3JheC5WaWV3LnByb3RvdHlwZSwgewogIGZyZWV6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgXy5lYWNoKHRoaXMuX2JvdW5kRGF0YU9iamVjdHNCeUNpZCwgdGhpcy51bmJpbmREYXRhT2JqZWN0LCB0aGlzKTsKICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKG9wdGlvbnMgfHwge30sIHsKICAgICAgZG9tOiB0cnVlLAogICAgICBjaGlsZHJlbjogdHJ1ZQogICAgfSk7CiAgICB0aGlzLm9mZigpOwogICAgaWYgKG9wdGlvbnMuZG9tKSB7CiAgICAgIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgfQogICAgdGhpcy50cmlnZ2VyKCdmcmVlemUnKTsKICAgIGlmIChvcHRpb25zLmNoaWxkcmVuKSB7CiAgICAgIF8uZWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgICAgIGNoaWxkLmZyZWV6ZShvcHRpb25zKTsKICAgICAgfSwgdGhpcyk7CiAgICB9CiAgfSwKICBvbjogZnVuY3Rpb24oZXZlbnROYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgaWYgKG9iamVjdEV2ZW50cyh0aGlzLCBldmVudE5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICBpZiAodHlwZW9mIGV2ZW50TmFtZSA9PT0gJ29iamVjdCcgJiYgYXJndW1lbnRzLmxlbmd0aCA8IDMpIHsKICAgICAgLy9hY2NlcHQgb24oeyJyZW5kZXJlZCI6IGNhbGxiYWNrfSkKICAgICAgXy5lYWNoKGV2ZW50TmFtZSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIHRoaXMub24oa2V5LCB2YWx1ZSwgY2FsbGJhY2sgfHwgdGhpcyk7ICAgIC8vIGNhbGxiYWNrIGlzIGNvbnRleHQgaW4gdGhpcyBmb3JtIG9mIHRoZSBjYWxsCiAgICAgIH0sIHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgLy9hY2NlcHQgb24oInJlbmRlcmVkIiwgY2FsbGJhY2ssIGNvbnRleHQpCiAgICAgIC8vYWNjZXB0IG9uKCJjbGljayBhIiwgY2FsbGJhY2ssIGNvbnRleHQpCiAgICAgIF8uZWFjaCgoXy5pc0FycmF5KGNhbGxiYWNrKSA/IGNhbGxiYWNrIDogW2NhbGxiYWNrXSksIGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIHBhcmFtcyA9IGV2ZW50UGFyYW1zRnJvbUV2ZW50SXRlbS5jYWxsKHRoaXMsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIGNvbnRleHQgfHwgdGhpcyk7CiAgICAgICAgaWYgKHBhcmFtcy50eXBlID09PSAnRE9NJykgewogICAgICAgICAgLy93aWxsIGNhbGwgX2FkZEV2ZW50IGR1cmluZyBkZWxlZ2F0ZUV2ZW50cygpCiAgICAgICAgICBpZiAoIXRoaXMuX2V2ZW50c1RvRGVsZWdhdGUpIHsKICAgICAgICAgICAgdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSA9IFtdOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZS5wdXNoKHBhcmFtcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuX2FkZEV2ZW50KHBhcmFtcyk7CiAgICAgICAgfQogICAgICB9LCB0aGlzKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0sCiAgZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cykgewogICAgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICBpZiAoZXZlbnRzKSB7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24oZXZlbnRzKSkgewogICAgICAgIGV2ZW50cyA9IGV2ZW50cy5jYWxsKHRoaXMpOwogICAgICB9CiAgICAgIHRoaXMuX2V2ZW50c1RvRGVsZWdhdGUgPSBbXTsKICAgICAgdGhpcy5vbihldmVudHMpOwogICAgfQogICAgdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSAmJiBfLmVhY2godGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSwgdGhpcy5fYWRkRXZlbnQsIHRoaXMpOwogIH0sCiAgLy9wYXJhbXMgbWF5IGNvbnRhaW46CiAgLy8tIG5hbWUKICAvLy0gb3JpZ2luYWxOYW1lCiAgLy8tIHNlbGVjdG9yCiAgLy8tIHR5cGUgInZpZXciIHx8ICJET00iCiAgLy8tIGhhbmRsZXIKICBfYWRkRXZlbnQ6IGZ1bmN0aW9uKHBhcmFtcykgewogICAgaWYgKHBhcmFtcy50eXBlID09PSAndmlldycpIHsKICAgICAgXy5lYWNoKHBhcmFtcy5uYW1lLnNwbGl0KC9ccysvKSwgZnVuY3Rpb24obmFtZSkgewogICAgICAgIF9vbi5jYWxsKHRoaXMsIG5hbWUsIGJpbmRFdmVudEhhbmRsZXIuY2FsbCh0aGlzLCAndmlldy1ldmVudDonLCBwYXJhbXMpKTsKICAgICAgfSwgdGhpcyk7CiAgICB9IGVsc2UgewogICAgICB2YXIgYm91bmRIYW5kbGVyID0gYmluZEV2ZW50SGFuZGxlci5jYWxsKHRoaXMsICdkb20tZXZlbnQ6JywgcGFyYW1zKTsKICAgICAgaWYgKCFwYXJhbXMubmVzdGVkKSB7CiAgICAgICAgYm91bmRIYW5kbGVyID0gY29udGFpbkhhbmRsZXJUb0N1cmVudFZpZXcoYm91bmRIYW5kbGVyLCB0aGlzLmNpZCk7CiAgICAgIH0KICAgICAgaWYgKHBhcmFtcy5zZWxlY3RvcikgewogICAgICAgIHZhciBuYW1lID0gcGFyYW1zLm5hbWUgKyAnLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkOwogICAgICAgIHRoaXMuJGVsLm9uKG5hbWUsIHBhcmFtcy5zZWxlY3RvciwgYm91bmRIYW5kbGVyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLiRlbC5vbihwYXJhbXMubmFtZSwgYm91bmRIYW5kbGVyKTsKICAgICAgfQogICAgfQogIH0KfSk7CgovLyBwcm9wYWdhdGUgcmVhZHkgZXZlbnQgdG8gY2hpbGRyZW4KZnVuY3Rpb24gdHJpZ2dlclJlYWR5KHZpZXcpIHsKICB2aWV3LnRyaWdnZXIoJ3JlYWR5Jyk7Cn0KCi8vIFdoZW4gdmlldyBpcyByZWFkeSB0cmlnZ2VyIHJlYWR5IGV2ZW50IG9uIGFsbAovLyBjaGlsZHJlbiB0aGF0IGFyZSBwcmVzZW50LCB0aGVuIHJlZ2lzdGVyIGFuCi8vIGV2ZW50IHRoYXQgd2lsbCB0cmlnZ2VyIHJlYWR5IG9uIG5ldyBjaGlsZHJlbgovLyB3aGVuIHRoZXkgYXJlIGFkZGVkClRob3JheC5WaWV3Lm9uKCdyZWFkeScsIGZ1bmN0aW9uKCkgewogIGlmICghdGhpcy5faXNSZWFkeSkgewogICAgdGhpcy5faXNSZWFkeSA9IHRydWU7CiAgICBfLmVhY2godGhpcy5jaGlsZHJlbiwgdHJpZ2dlclJlYWR5KTsKICAgIHRoaXMub24oJ2NoaWxkJywgdHJpZ2dlclJlYWR5KTsKICB9Cn0pOwoKdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXihuZXN0ZWRccyspPyhcUyspKD86XHMrKC4rKSk/LzsKCnZhciBkb21FdmVudHMgPSBbXSwKICAgIGRvbUV2ZW50UmVnZXhwOwpmdW5jdGlvbiBwdXNoRG9tRXZlbnRzKGV2ZW50cykgewogIGRvbUV2ZW50cy5wdXNoLmFwcGx5KGRvbUV2ZW50cywgZXZlbnRzKTsKICBkb21FdmVudFJlZ2V4cCA9IG5ldyBSZWdFeHAoJ14obmVzdGVkXFxzKyk/KCcgKyBkb21FdmVudHMuam9pbignfCcpICsgJykoPzpcXHN8JCknKTsKfQpwdXNoRG9tRXZlbnRzKFsKICAnbW91c2Vkb3duJywgJ21vdXNldXAnLCAnbW91c2Vtb3ZlJywgJ21vdXNlb3ZlcicsICdtb3VzZW91dCcsCiAgJ3RvdWNoc3RhcnQnLCAndG91Y2hlbmQnLCAndG91Y2htb3ZlJywKICAnY2xpY2snLCAnZGJsY2xpY2snLAogICdrZXl1cCcsICdrZXlkb3duJywgJ2tleXByZXNzJywKICAnc3VibWl0JywgJ2NoYW5nZScsCiAgJ2ZvY3VzJywgJ2JsdXInCl0pOwoKZnVuY3Rpb24gY29udGFpbkhhbmRsZXJUb0N1cmVudFZpZXcoaGFuZGxlciwgY2lkKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICB2YXIgdmlldyA9ICQoZXZlbnQudGFyZ2V0KS52aWV3KHtoZWxwZXI6IGZhbHNlfSk7CiAgICBpZiAodmlldyAmJiB2aWV3LmNpZCA9PT0gY2lkKSB7CiAgICAgIGV2ZW50Lm9yaWdpbmFsQ29udGV4dCA9IHRoaXM7CiAgICAgIGhhbmRsZXIoZXZlbnQpOwogICAgfQogIH07Cn0KCmZ1bmN0aW9uIGJpbmRFdmVudEhhbmRsZXIoZXZlbnROYW1lLCBwYXJhbXMpIHsKICBldmVudE5hbWUgKz0gcGFyYW1zLm9yaWdpbmFsTmFtZTsKCiAgdmFyIGNhbGxiYWNrID0gcGFyYW1zLmhhbmRsZXIsCiAgICAgIG1ldGhvZCA9IHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJyA/IGNhbGxiYWNrIDogdGhpc1tjYWxsYmFja107CiAgaWYgKCFtZXRob2QpIHsKICAgIHRocm93IG5ldyBFcnJvcignRXZlbnQgIicgKyBjYWxsYmFjayArICciIGRvZXMgbm90IGV4aXN0ICcgKyAodGhpcy5uYW1lIHx8IHRoaXMuY2lkKSArICc6JyArIGV2ZW50TmFtZSk7CiAgfQogIHJldHVybiBfLmJpbmQoZnVuY3Rpb24oKSB7CiAgICB0cnkgewogICAgICBtZXRob2QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgVGhvcmF4Lm9uRXhjZXB0aW9uKCd0aG9yYXgtZXhjZXB0aW9uOiAnICsgKHRoaXMubmFtZSB8fCB0aGlzLmNpZCkgKyAnOicgKyBldmVudE5hbWUsIGUpOwogICAgfQogIH0sIHBhcmFtcy5jb250ZXh0IHx8IHRoaXMpOwp9CgpmdW5jdGlvbiBldmVudFBhcmFtc0Zyb21FdmVudEl0ZW0obmFtZSwgaGFuZGxlciwgY29udGV4dCkgewogIHZhciBwYXJhbXMgPSB7CiAgICBvcmlnaW5hbE5hbWU6IG5hbWUsCiAgICBoYW5kbGVyOiB0eXBlb2YgaGFuZGxlciA9PT0gJ3N0cmluZycgPyB0aGlzW2hhbmRsZXJdIDogaGFuZGxlcgogIH07CiAgaWYgKG5hbWUubWF0Y2goZG9tRXZlbnRSZWdleHApKSB7CiAgICB2YXIgbWF0Y2ggPSBldmVudFNwbGl0dGVyLmV4ZWMobmFtZSk7CiAgICBwYXJhbXMubmVzdGVkID0gISFtYXRjaFsxXTsKICAgIHBhcmFtcy5uYW1lID0gbWF0Y2hbMl07CiAgICBwYXJhbXMudHlwZSA9ICdET00nOwogICAgcGFyYW1zLnNlbGVjdG9yID0gbWF0Y2hbM107CiAgfSBlbHNlIHsKICAgIHBhcmFtcy5uYW1lID0gbmFtZTsKICAgIHBhcmFtcy50eXBlID0gJ3ZpZXcnOwogIH0KICBwYXJhbXMuY29udGV4dCA9IGNvbnRleHQ7CiAgcmV0dXJuIHBhcmFtczsKfQoKOzsKLypnbG9iYWwgZ2V0T3B0aW9uc0RhdGEsIHZpZXdIZWxwZXJBdHRyaWJ1dGVOYW1lICovCnZhciB2aWV3UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtdmlldy10bXAnOwp2YXIgdmlld1RlbXBsYXRlT3ZlcnJpZGVzID0ge307CgpUaG9yYXguSGVscGVyVmlldyA9IFRob3JheC5WaWV3LmV4dGVuZCh7CiAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgVGhvcmF4LlZpZXcucHJvdG90eXBlLl9lbnN1cmVFbGVtZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB0aGlzLiRlbC5hdHRyKHZpZXdIZWxwZXJBdHRyaWJ1dGVOYW1lLCB0aGlzLl9oZWxwZXJOYW1lKTsKICB9LAogIF9nZXRDb250ZXh0OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLnBhcmVudC5fZ2V0Q29udGV4dC5hcHBseSh0aGlzLnBhcmVudCwgYXJndW1lbnRzKTsKICB9LAp9KTsKCi8vZW5zdXJlIG5lc3RlZCBpbmxpbmUgaGVscGVycyB3aWxsIGFsd2F5cyBoYXZlIHRoaXMucGFyZW50Ci8vc2V0IHRvIHRoZSB2aWV3IGNvbnRhaW5pbmcgdGhlIHRlbXBsYXRlCmZ1bmN0aW9uIGdldFBhcmVudChwYXJlbnQpIHsKICB3aGlsZSAocGFyZW50Ll9oZWxwZXJOYW1lKSB7CiAgICBwYXJlbnQgPSBwYXJlbnQucGFyZW50OwogIH0KICByZXR1cm4gcGFyZW50Owp9CgpIYW5kbGViYXJzLnJlZ2lzdGVyVmlld0hlbHBlciA9IGZ1bmN0aW9uKG5hbWUsIFZpZXdDbGFzcywgY2FsbGJhY2spIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikgewogICAgaWYgKFZpZXdDbGFzcy5mYWN0b3J5KSB7CiAgICAgIGNhbGxiYWNrID0gVmlld0NsYXNzLmNhbGxiYWNrOwogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2sgPSBWaWV3Q2xhc3M7CiAgICAgIFZpZXdDbGFzcyA9IFRob3JheC5IZWxwZXJWaWV3OwogICAgfQogIH0KICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKG5hbWUsIGZ1bmN0aW9uKCkgewogICAgdmFyIGFyZ3MgPSBfLnRvQXJyYXkoYXJndW1lbnRzKSwKICAgICAgICBvcHRpb25zID0gYXJncy5wb3AoKSwKICAgICAgICBkZWNsYXJpbmdWaWV3ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldzsKCiAgICB2YXIgdmlld09wdGlvbnMgPSB7CiAgICAgIHRlbXBsYXRlOiBvcHRpb25zLmZuIHx8IEhhbmRsZWJhcnMuVk0ubm9vcCwKICAgICAgaW52ZXJzZTogb3B0aW9ucy5pbnZlcnNlLAogICAgICBvcHRpb25zOiBvcHRpb25zLmhhc2gsCiAgICAgIGRlY2xhcmluZ1ZpZXc6IGRlY2xhcmluZ1ZpZXcsCiAgICAgIHBhcmVudDogZ2V0UGFyZW50KGRlY2xhcmluZ1ZpZXcpLAogICAgICBfaGVscGVyTmFtZTogbmFtZSwKICAgICAgX2hlbHBlck9wdGlvbnM6IHsKICAgICAgICBvcHRpb25zOiBjbG9uZUhlbHBlck9wdGlvbnMob3B0aW9ucyksCiAgICAgICAgYXJnczogXy5jbG9uZShhcmdzKQogICAgICB9CiAgICB9OwoKICAgIG9wdGlvbnMuaGFzaC5pZCAmJiAodmlld09wdGlvbnMuaWQgPSBvcHRpb25zLmhhc2guaWQpOwogICAgb3B0aW9ucy5oYXNoWydjbGFzcyddICYmICh2aWV3T3B0aW9ucy5jbGFzc05hbWUgPSBvcHRpb25zLmhhc2hbJ2NsYXNzJ10pOwogICAgb3B0aW9ucy5oYXNoLmNsYXNzTmFtZSAmJiAodmlld09wdGlvbnMuY2xhc3NOYW1lID0gb3B0aW9ucy5oYXNoLmNsYXNzTmFtZSk7CiAgICBvcHRpb25zLmhhc2gudGFnICYmICh2aWV3T3B0aW9ucy50YWdOYW1lID0gb3B0aW9ucy5oYXNoLnRhZyk7CiAgICBvcHRpb25zLmhhc2gudGFnTmFtZSAmJiAodmlld09wdGlvbnMudGFnTmFtZSA9IG9wdGlvbnMuaGFzaC50YWdOYW1lKTsKCiAgICAvLyBDaGVjayB0byBzZWUgaWYgd2UgaGF2ZSBhbiBleGlzdGluZyBpbnN0YW5jZSB0aGF0IHdlIGNhbiByZXVzZQogICAgdmFyIGluc3RhbmNlID0gXy5maW5kKGRlY2xhcmluZ1ZpZXcuX3ByZXZpb3VzSGVscGVycywgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgcmV0dXJuIGNvbXBhcmVIZWxwZXJPcHRpb25zKHZpZXdPcHRpb25zLCBjaGlsZCk7CiAgICB9KTsKCiAgICAvLyBDcmVhdGUgdGhlIGluc3RhbmNlIGlmIHdlIGRvbid0IGFscmVhZHkgaGF2ZSBvbmUKICAgIGlmICghaW5zdGFuY2UpIHsKICAgICAgaWYgKFZpZXdDbGFzcy5mYWN0b3J5KSB7CiAgICAgICAgaW5zdGFuY2UgPSBWaWV3Q2xhc3MuZmFjdG9yeShhcmdzLCB2aWV3T3B0aW9ucyk7CiAgICAgICAgaWYgKCFpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuICcnOwogICAgICAgIH0KCiAgICAgICAgaW5zdGFuY2UuX2hlbHBlck5hbWUgPSB2aWV3T3B0aW9ucy5faGVscGVyTmFtZTsKICAgICAgICBpbnN0YW5jZS5faGVscGVyT3B0aW9ucyA9IHZpZXdPcHRpb25zLl9oZWxwZXJPcHRpb25zOwogICAgICB9IGVsc2UgewogICAgICAgIGluc3RhbmNlID0gbmV3IFZpZXdDbGFzcyh2aWV3T3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIGFyZ3MucHVzaChpbnN0YW5jZSk7CiAgICAgIGRlY2xhcmluZ1ZpZXcuX2FkZENoaWxkKGluc3RhbmNlKTsKICAgICAgZGVjbGFyaW5nVmlldy50cmlnZ2VyLmFwcGx5KGRlY2xhcmluZ1ZpZXcsIFsnaGVscGVyJywgbmFtZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgZGVjbGFyaW5nVmlldy50cmlnZ2VyLmFwcGx5KGRlY2xhcmluZ1ZpZXcsIFsnaGVscGVyOicgKyBuYW1lXS5jb25jYXQoYXJncykpOwoKICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7CiAgICB9IGVsc2UgewogICAgICBkZWNsYXJpbmdWaWV3Ll9wcmV2aW91c0hlbHBlcnMgPSBfLndpdGhvdXQoZGVjbGFyaW5nVmlldy5fcHJldmlvdXNIZWxwZXJzLCBpbnN0YW5jZSk7CiAgICAgIGRlY2xhcmluZ1ZpZXcuY2hpbGRyZW5baW5zdGFuY2UuY2lkXSA9IGluc3RhbmNlOwogICAgfQoKICAgIHZhciBodG1sQXR0cmlidXRlcyA9IFRob3JheC5VdGlsLmh0bWxBdHRyaWJ1dGVzRnJvbU9wdGlvbnMob3B0aW9ucy5oYXNoKTsKICAgIGh0bWxBdHRyaWJ1dGVzW3ZpZXdQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWVdID0gaW5zdGFuY2UuY2lkOwoKICAgIHZhciBleHBhbmRUb2tlbnMgPSBvcHRpb25zLmhhc2hbJ2V4cGFuZC10b2tlbnMnXTsKICAgIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZyhodG1sQXR0cmlidXRlcywgJycsIGV4cGFuZFRva2VucyA/IHRoaXMgOiBudWxsKSk7CiAgfSk7CiAgdmFyIGhlbHBlciA9IEhhbmRsZWJhcnMuaGVscGVyc1tuYW1lXTsKICByZXR1cm4gaGVscGVyOwp9OwoKVGhvcmF4LlZpZXcub24oJ2FwcGVuZCcsIGZ1bmN0aW9uKHNjb3BlLCBjYWxsYmFjaykgewogIChzY29wZSB8fCB0aGlzLiRlbCkuZmluZCgnWycgKyB2aWV3UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lICsgJ10nKS5mb3JFYWNoKGZ1bmN0aW9uKGVsKSB7CiAgICB2YXIgcGxhY2Vob2xkZXJJZCA9IGVsLmdldEF0dHJpYnV0ZSh2aWV3UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lKSwKICAgICAgICB2aWV3ID0gdGhpcy5jaGlsZHJlbltwbGFjZWhvbGRlcklkXTsKICAgIGlmICh2aWV3KSB7CiAgICAgIC8vc2VlIGlmIHRoZSB2aWV3IGhlbHBlciBkZWNsYXJlZCBhbiBvdmVycmlkZSBmb3IgdGhlIHZpZXcKICAgICAgLy9pZiBub3QsIGVuc3VyZSB0aGUgdmlldyBoYXMgYmVlbiByZW5kZXJlZCBhdCBsZWFzdCBvbmNlCiAgICAgIGlmICh2aWV3VGVtcGxhdGVPdmVycmlkZXNbcGxhY2Vob2xkZXJJZF0pIHsKICAgICAgICB2aWV3LnJlbmRlcih2aWV3VGVtcGxhdGVPdmVycmlkZXNbcGxhY2Vob2xkZXJJZF0pOwogICAgICAgIGRlbGV0ZSB2aWV3VGVtcGxhdGVPdmVycmlkZXNbcGxhY2Vob2xkZXJJZF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmlldy5lbnN1cmVSZW5kZXJlZCgpOwogICAgICB9CiAgICAgICQoZWwpLnJlcGxhY2VXaXRoKHZpZXcuZWwpOwogICAgICBjYWxsYmFjayAmJiBjYWxsYmFjayh2aWV3LmVsKTsKICAgIH0KICB9LCB0aGlzKTsKfSk7CgoKLyoqCiAqIENsb25lcyB0aGUgaGVscGVyIG9wdGlvbnMsIGRyb3BwaW5nIGl0ZW1zIHRoYXQgYXJlIGtub3duIHRvIGNoYW5nZQogKiBiZXR3ZWVuIHJlbmRlcmluZyBjeWNsZXMgYXMgYXBwcm9wcmlhdGUuCiAqLwpmdW5jdGlvbiBjbG9uZUhlbHBlck9wdGlvbnMob3B0aW9ucykgewogIHZhciByZXQgPSBfLnBpY2sob3B0aW9ucywgJ2ZuJywgJ2ludmVyc2UnLCAnaGFzaCcsICdkYXRhJyk7CiAgcmV0LmRhdGEgPSBfLm9taXQob3B0aW9ucy5kYXRhLCAnY2lkJywgJ3ZpZXcnLCAneWllbGQnKTsKICByZXR1cm4gcmV0Owp9CgovKioKICogQ2hlY2tzIGZvciBiYXNpYyBlcXVhbGl0eSBiZXR3ZWVuIHR3byBzZXRzIG9mIHBhcmFtZXRlcnMgZm9yIGEgaGVscGVyIHZpZXcuCiAqCiAqIENoZWNrZWQgZmllbGRzIGluY2x1ZGU6CiAqICAtIF9oZWxwZXJOYW1lCiAqICAtIEFsbCBhcmdzCiAqICAtIEhhc2gKICogIC0gRGF0YQogKiAgLSBGdW5jdGlvbiBhbmQgSW52ZXJ0IChpZCBiYXNlZCBpZiBwb3NzaWJsZSkKICoKICogVGhpcyBtZXRob2QgYWxsb3dzIHVzIHRvIGRldGVybWluZSBpZiB0aGUgaW5wdXRzIHRvIGEgZ2l2ZW4gdmlldyBhcmUgdGhlIHNhbWUuIElmIHRoZXkKICogYXJlIHRoZW4gd2UgbWFrZSB0aGUgYXNzdW1wdGlvbiB0aGF0IHRoZSByZW5kZXJpbmcgd2lsbCBiZSB0aGUgc2FtZSAob3IgdGhlIGNoaWxkIHZpZXcgd2lsbAogKiBvdGhlcndpc2UgcmVyZW5kZXJpbmcgaXQgYnkgbW9uaXRvcmluZyBpdCdzIHBhcmFtZXRlcnMgYXMgbmVjZXNzYXJ5KSBhbmQgcmV1c2UgdGhlIHZpZXcgb24KICogcmVyZW5kZXIgb2YgdGhlIHBhcmVudCB2aWV3LgogKi8KZnVuY3Rpb24gY29tcGFyZUhlbHBlck9wdGlvbnMoYSwgYikgewogIGZ1bmN0aW9uIGNvbXBhcmVWYWx1ZXMoYSwgYikgewogICAgcmV0dXJuIF8uZXZlcnkoYSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICByZXR1cm4gYltrZXldID09PSB2YWx1ZTsKICAgIH0pOwogIH0KCiAgaWYgKGEuX2hlbHBlck5hbWUgIT09IGIuX2hlbHBlck5hbWUpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIGEgPSBhLl9oZWxwZXJPcHRpb25zOwogIGIgPSBiLl9oZWxwZXJPcHRpb25zOwoKICAvLyBJbXBsZW1lbnRzIGEgZmlyc3QgbGV2ZWwgZGVwdGggY29tcGFyaXNvbgogIHJldHVybiBhLmFyZ3MubGVuZ3RoID09PSBiLmFyZ3MubGVuZ3RoCiAgICAgICYmIGNvbXBhcmVWYWx1ZXMoYS5hcmdzLCBiLmFyZ3MpCiAgICAgICYmIF8uaXNFcXVhbChfLmtleXMoYS5vcHRpb25zKSwgXy5rZXlzKGIub3B0aW9ucykpCiAgICAgICYmIF8uZXZlcnkoYS5vcHRpb25zLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICBpZiAoa2V5ID09PSAnZGF0YScgfHwga2V5ID09PSAnaGFzaCcpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmVWYWx1ZXMoYS5vcHRpb25zW2tleV0sIGIub3B0aW9uc1trZXldKTsKICAgICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAnZm4nIHx8IGtleSA9PT0gJ2ludmVyc2UnKSB7CiAgICAgICAgICAgIHJldHVybiBiLm9wdGlvbnNba2V5XSA9PT0gdmFsdWUKICAgICAgICAgICAgICAgIHx8ICh2YWx1ZSAmJiBfLmhhcyh2YWx1ZSwgJ3Byb2dyYW0nKSAmJiAoKGIub3B0aW9uc1trZXldIHx8IHt9KS5wcm9ncmFtID09PSB2YWx1ZS5wcm9ncmFtKSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYi5vcHRpb25zW2tleV0gPT09IHZhbHVlOwogICAgICAgIH0pOwp9Cgo7OwovKmdsb2JhbCBnZXRWYWx1ZSwgaW5oZXJpdFZhcnMsIHdhbGtJbmhlcml0VHJlZSAqLwoKZnVuY3Rpb24gZGF0YU9iamVjdCh0eXBlLCBzcGVjKSB7CiAgc3BlYyA9IGluaGVyaXRWYXJzW3R5cGVdID0gXy5kZWZhdWx0cyh7CiAgICBuYW1lOiAnXycgKyB0eXBlICsgJ0V2ZW50cycsCiAgICBldmVudDogdHJ1ZQogIH0sIHNwZWMpOwoKICAvLyBBZGQgYSBjYWxsYmFjayBpbiB0aGUgdmlldyBjb25zdHJ1Y3RvcgogIHNwZWMuY3RvciA9IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXNbdHlwZV0pIHsKICAgICAgLy8gTmVlZCB0byBudWxsIHRoaXMubW9kZWwvY29sbGVjdGlvbiBzbyBzZXRNb2RlbC9Db2xsZWN0aW9uIHdpbGwKICAgICAgLy8gbm90IHRyZWF0IGl0IGFzIHRoZSBvbGQgbW9kZWwvY29sbGVjdGlvbiBhbmQgaW1tZWRpYXRlbHkgcmV0dXJuCiAgICAgIHZhciBvYmplY3QgPSB0aGlzW3R5cGVdOwogICAgICB0aGlzW3R5cGVdID0gbnVsbDsKICAgICAgdGhpc1tzcGVjLnNldF0ob2JqZWN0KTsKICAgIH0KICB9OwoKICBmdW5jdGlvbiBzZXRPYmplY3QoZGF0YU9iamVjdCwgb3B0aW9ucykgewogICAgdmFyIG9sZCA9IHRoaXNbdHlwZV0sCiAgICAgICAgJGVsID0gZ2V0VmFsdWUodGhpcywgc3BlYy4kZWwpOwoKICAgIGlmIChkYXRhT2JqZWN0ID09PSBvbGQpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBpZiAob2xkKSB7CiAgICAgIHRoaXMudW5iaW5kRGF0YU9iamVjdChvbGQpOwogICAgfQoKICAgIGlmIChkYXRhT2JqZWN0KSB7CiAgICAgIHRoaXNbdHlwZV0gPSBkYXRhT2JqZWN0OwoKICAgICAgaWYgKHNwZWMubG9hZGluZykgewogICAgICAgIHNwZWMubG9hZGluZy5jYWxsKHRoaXMpOwogICAgICB9CgogICAgICB0aGlzLmJpbmREYXRhT2JqZWN0KHR5cGUsIGRhdGFPYmplY3QsIF8uZXh0ZW5kKHt9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMpKTsKICAgICAgJGVsLmF0dHIoc3BlYy5jaWRBdHRyTmFtZSwgZGF0YU9iamVjdC5jaWQpOwogICAgICBkYXRhT2JqZWN0LnRyaWdnZXIoJ3NldCcsIGRhdGFPYmplY3QsIG9sZCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzW3R5cGVdID0gZmFsc2U7CiAgICAgIGlmIChzcGVjLmNoYW5nZSkgewogICAgICAgIHNwZWMuY2hhbmdlLmNhbGwodGhpcywgZmFsc2UpOwogICAgICB9CiAgICAgICRlbC5yZW1vdmVBdHRyKHNwZWMuY2lkQXR0ck5hbWUpOwogICAgfQogICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2U6ZGF0YS1vYmplY3QnLCB0eXBlLCBkYXRhT2JqZWN0LCBvbGQpOwogICAgc3BlYy5zZXRDYWxsYmFjayAmJiBzcGVjLnNldENhbGxiYWNrLmNhbGwodGhpcywgZGF0YU9iamVjdCwgb3B0aW9ucyk7CiAgICByZXR1cm4gdGhpczsKICB9CgogIFRob3JheC5WaWV3LnByb3RvdHlwZVtzcGVjLnNldF0gPSBzZXRPYmplY3Q7Cn0KCl8uZXh0ZW5kKFRob3JheC5WaWV3LnByb3RvdHlwZSwgewogIGJpbmREYXRhT2JqZWN0OiBmdW5jdGlvbih0eXBlLCBkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgICBpZiAodGhpcy5fYm91bmREYXRhT2JqZWN0c0J5Q2lkW2RhdGFPYmplY3QuY2lkXSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICAvLyBDb2xsZWN0aW9ucyBkbyBub3QgaGF2ZSBhIGNpZCBhdHRyaWJ1dGUgYnkgZGVmYXVsdAogICAgZW5zdXJlRGF0YU9iamVjdENpZCh0eXBlLCBkYXRhT2JqZWN0KTsKICAgIHRoaXMuX2JvdW5kRGF0YU9iamVjdHNCeUNpZFtkYXRhT2JqZWN0LmNpZF0gPSBkYXRhT2JqZWN0OwoKICAgIHZhciBvcHRpb25zID0gdGhpcy5fbW9kaWZ5RGF0YU9iamVjdE9wdGlvbnMoZGF0YU9iamVjdCwgXy5leHRlbmQoe30sIGluaGVyaXRWYXJzW3R5cGVdLmRlZmF1bHRPcHRpb25zLCBvcHRpb25zKSk7CiAgICB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbZGF0YU9iamVjdC5jaWRdID0gb3B0aW9uczsKCiAgICBiaW5kRXZlbnRzLmNhbGwodGhpcywgdHlwZSwgZGF0YU9iamVjdCwgdGhpcy5jb25zdHJ1Y3Rvcik7CiAgICBiaW5kRXZlbnRzLmNhbGwodGhpcywgdHlwZSwgZGF0YU9iamVjdCwgdGhpcyk7CgogICAgaWYgKGRhdGFPYmplY3Quc2hvdWxkRmV0Y2gpIHsKICAgICAgaWYgKGRhdGFPYmplY3Quc2hvdWxkRmV0Y2gob3B0aW9ucykpIHsKICAgICAgICBsb2FkT2JqZWN0KGRhdGFPYmplY3QsIG9wdGlvbnMpOwogICAgICB9IGVsc2UgaWYgKGluaGVyaXRWYXJzW3R5cGVdLmNoYW5nZSkgewogICAgICAgIC8vIHdhbnQgdG8gdHJpZ2dlciBidWlsdCBpbiByZW5kZXJpbmcgd2l0aG91dCB0cmlnZ2VyaW5nIGV2ZW50IG9uIG1vZGVsCiAgICAgICAgaW5oZXJpdFZhcnNbdHlwZV0uY2hhbmdlLmNhbGwodGhpcywgZGF0YU9iamVjdCwgb3B0aW9ucyk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9LAoKICB1bmJpbmREYXRhT2JqZWN0OiBmdW5jdGlvbiAoZGF0YU9iamVjdCkgewogICAgaWYgKCF0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWRbZGF0YU9iamVjdC5jaWRdKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGRlbGV0ZSB0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWRbZGF0YU9iamVjdC5jaWRdOwogICAgZGF0YU9iamVjdC50cmlnZ2VyKCdmcmVlemUnKTsKICAgIHRoaXMuc3RvcExpc3RlbmluZyhkYXRhT2JqZWN0KTsKICAgIGRlbGV0ZSB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbZGF0YU9iamVjdC5jaWRdOwogICAgcmV0dXJuIHRydWU7CiAgfSwKCiAgX21vZGlmeURhdGFPYmplY3RPcHRpb25zOiBmdW5jdGlvbihkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgICByZXR1cm4gb3B0aW9uczsKICB9Cn0pOwoKZnVuY3Rpb24gYmluZEV2ZW50cyh0eXBlLCB0YXJnZXQsIHNvdXJjZSkgewogIHZhciBjb250ZXh0ID0gdGhpczsKICB3YWxrSW5oZXJpdFRyZWUoc291cmNlLCAnXycgKyB0eXBlICsgJ0V2ZW50cycsIHRydWUsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAvLyBnZXRFdmVudENhbGxiYWNrIHdpbGwgcmVzb2x2ZSBpZiBpdCBpcyBhIHN0cmluZyBvciBhIG1ldGhvZAogICAgLy8gYW5kIHJldHVybiBhIG1ldGhvZAogICAgY29udGV4dC5saXN0ZW5Ubyh0YXJnZXQsIGV2ZW50WzBdLCBfLmJpbmQoZ2V0RXZlbnRDYWxsYmFjayhldmVudFsxXSwgY29udGV4dCksIGV2ZW50WzJdIHx8IGNvbnRleHQpKTsKICB9KTsKfQoKZnVuY3Rpb24gbG9hZE9iamVjdChkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgaWYgKGRhdGFPYmplY3QubG9hZCkgewogICAgZGF0YU9iamVjdC5sb2FkKGZ1bmN0aW9uKCkgewogICAgICBvcHRpb25zICYmIG9wdGlvbnMuc3VjY2VzcyAmJiBvcHRpb25zLnN1Y2Nlc3MoZGF0YU9iamVjdCk7CiAgICB9LCBvcHRpb25zKTsKICB9IGVsc2UgewogICAgZGF0YU9iamVjdC5mZXRjaChvcHRpb25zKTsKICB9Cn0KCmZ1bmN0aW9uIGdldEV2ZW50Q2FsbGJhY2soY2FsbGJhY2ssIGNvbnRleHQpIHsKICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7CiAgICByZXR1cm4gY2FsbGJhY2s7CiAgfSBlbHNlIHsKICAgIHJldHVybiBjb250ZXh0W2NhbGxiYWNrXTsKICB9Cn0KCmZ1bmN0aW9uIGVuc3VyZURhdGFPYmplY3RDaWQodHlwZSwgb2JqKSB7CiAgb2JqLmNpZCA9IG9iai5jaWQgfHwgXy51bmlxdWVJZCh0eXBlKTsKfQoKOzsKLypnbG9iYWwgY3JlYXRlUmVnaXN0cnlXcmFwcGVyLCBkYXRhT2JqZWN0LCBnZXRWYWx1ZSAqLwp2YXIgbW9kZWxDaWRBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtbW9kZWwtY2lkJzsKClRob3JheC5Nb2RlbCA9IEJhY2tib25lLk1vZGVsLmV4dGVuZCh7CiAgaXNFbXB0eTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gIXRoaXMuaXNQb3B1bGF0ZWQoKTsKICB9LAogIGlzUG9wdWxhdGVkOiBmdW5jdGlvbigpIHsKICAgIC8vIFdlIGFyZSBwb3B1bGF0ZWQgaWYgd2UgaGF2ZSBhdHRyaWJ1dGVzIHNldAogICAgdmFyIGF0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyksCiAgICAgICAgZGVmYXVsdHMgPSBnZXRWYWx1ZSh0aGlzLCAnZGVmYXVsdHMnKSB8fCB7fTsKICAgIGZvciAodmFyIGRlZmF1bHRfa2V5IGluIGRlZmF1bHRzKSB7CiAgICAgIGlmIChhdHRyaWJ1dGVzW2RlZmF1bHRfa2V5XSAhPSBkZWZhdWx0c1tkZWZhdWx0X2tleV0pIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBkZWxldGUgYXR0cmlidXRlc1tkZWZhdWx0X2tleV07CiAgICB9CiAgICB2YXIga2V5cyA9IF8ua2V5cyhhdHRyaWJ1dGVzKTsKICAgIHJldHVybiBrZXlzLmxlbmd0aCA+IDEgfHwgKGtleXMubGVuZ3RoID09PSAxICYmIGtleXNbMF0gIT09IHRoaXMuaWRBdHRyaWJ1dGUpOwogIH0sCiAgc2hvdWxkRmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIC8vIHVybCgpIHdpbGwgdGhyb3cgaWYgbW9kZWwgaGFzIG5vIGB1cmxSb290YCBhbmQgbm8gYGNvbGxlY3Rpb25gCiAgICAvLyBvciBoYXMgYGNvbGxlY3Rpb25gIGFuZCBgY29sbGVjdGlvbmAgaGFzIG5vIGB1cmxgCiAgICB2YXIgdXJsOwogICAgdHJ5IHsKICAgICAgdXJsID0gZ2V0VmFsdWUodGhpcywgJ3VybCcpOwogICAgfSBjYXRjaChlKSB7CiAgICAgIHVybCA9IGZhbHNlOwogICAgfQogICAgcmV0dXJuIG9wdGlvbnMuZmV0Y2ggJiYgISF1cmwgJiYgIXRoaXMuaXNQb3B1bGF0ZWQoKTsKICB9Cn0pOwoKVGhvcmF4Lk1vZGVscyA9IHt9OwpjcmVhdGVSZWdpc3RyeVdyYXBwZXIoVGhvcmF4Lk1vZGVsLCBUaG9yYXguTW9kZWxzKTsKCmRhdGFPYmplY3QoJ21vZGVsJywgewogIHNldDogJ3NldE1vZGVsJywKICBkZWZhdWx0T3B0aW9uczogewogICAgcmVuZGVyOiB0cnVlLAogICAgZmV0Y2g6IHRydWUsCiAgICBzdWNjZXNzOiBmYWxzZSwKICAgIGVycm9yczogdHJ1ZQogIH0sCiAgY2hhbmdlOiBvbk1vZGVsQ2hhbmdlLAogICRlbDogJyRlbCcsCiAgY2lkQXR0ck5hbWU6IG1vZGVsQ2lkQXR0cmlidXRlTmFtZQp9KTsKCmZ1bmN0aW9uIG9uTW9kZWxDaGFuZ2UobW9kZWwpIHsKICB2YXIgbW9kZWxPcHRpb25zID0gbW9kZWwgJiYgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW21vZGVsLmNpZF07CiAgLy8gIW1vZGVsT3B0aW9ucyB3aWxsIGJlIHRydWUgd2hlbiBzZXRNb2RlbChmYWxzZSkgaXMgY2FsbGVkCiAgaWYgKCFtb2RlbE9wdGlvbnMgfHwgKG1vZGVsT3B0aW9ucyAmJiBtb2RlbE9wdGlvbnMucmVuZGVyKSkgewogICAgdGhpcy5yZW5kZXIoKTsKICB9Cn0KClRob3JheC5WaWV3Lm9uKHsKICBtb2RlbDogewogICAgZXJyb3I6IGZ1bmN0aW9uKG1vZGVsLCBlcnJvcnMpIHsKICAgICAgaWYgKHRoaXMuX29iamVjdE9wdGlvbnNCeUNpZFttb2RlbC5jaWRdLmVycm9ycykgewogICAgICAgIHRoaXMudHJpZ2dlcignZXJyb3InLCBlcnJvcnMsIG1vZGVsKTsKICAgICAgfQogICAgfSwKICAgIGNoYW5nZTogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgb25Nb2RlbENoYW5nZS5jYWxsKHRoaXMsIG1vZGVsKTsKICAgIH0KICB9Cn0pOwoKJC5mbi5tb2RlbCA9IGZ1bmN0aW9uKHZpZXcpIHsKICB2YXIgJHRoaXMgPSAkKHRoaXMpLAogICAgICBtb2RlbEVsZW1lbnQgPSAkdGhpcy5jbG9zZXN0KCdbJyArIG1vZGVsQ2lkQXR0cmlidXRlTmFtZSArICddJyksCiAgICAgIG1vZGVsQ2lkID0gbW9kZWxFbGVtZW50ICYmIG1vZGVsRWxlbWVudC5hdHRyKG1vZGVsQ2lkQXR0cmlidXRlTmFtZSk7CiAgaWYgKG1vZGVsQ2lkKSB7CiAgICB2YXIgdmlldyA9IHZpZXcgfHwgJHRoaXMudmlldygpOwogICAgaWYgKHZpZXcgJiYgdmlldy5tb2RlbCAmJiB2aWV3Lm1vZGVsLmNpZCA9PT0gbW9kZWxDaWQpIHsKICAgICAgcmV0dXJuIHZpZXcubW9kZWwgfHwgZmFsc2U7CiAgICB9CiAgICB2YXIgY29sbGVjdGlvbiA9ICR0aGlzLmNvbGxlY3Rpb24odmlldyk7CiAgICBpZiAoY29sbGVjdGlvbikgewogICAgICByZXR1cm4gY29sbGVjdGlvbi5maW5kKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIG1vZGVsLmNpZCA9PT0gbW9kZWxDaWQ7CiAgICAgIH0pIHx8IGZhbHNlOwogICAgfQogIH0KICByZXR1cm4gZmFsc2U7Cn07Cgo7OwovKmdsb2JhbCBjcmVhdGVSZWdpc3RyeVdyYXBwZXIsIGRhdGFPYmplY3QsIGdldEV2ZW50Q2FsbGJhY2ssIGdldFZhbHVlLCBtb2RlbENpZEF0dHJpYnV0ZU5hbWUsIHZpZXdDaWRBdHRyaWJ1dGVOYW1lICovCnZhciBfZmV0Y2ggPSBCYWNrYm9uZS5Db2xsZWN0aW9uLnByb3RvdHlwZS5mZXRjaCwKICAgIF9yZXNldCA9IEJhY2tib25lLkNvbGxlY3Rpb24ucHJvdG90eXBlLnJlc2V0LAogICAgY29sbGVjdGlvbkNpZEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1jb2xsZWN0aW9uLWNpZCcsCiAgICBjb2xsZWN0aW9uRW1wdHlBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtY29sbGVjdGlvbi1lbXB0eScsCiAgICBjb2xsZWN0aW9uRWxlbWVudEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1jb2xsZWN0aW9uLWVsZW1lbnQnLAogICAgcHJpbWFyeUNvbGxlY3Rpb25BdHRyaWJ1dGVOYW1lID0gJ2RhdGEtY29sbGVjdGlvbi1wcmltYXJ5JywKICAgIEVMRU1FTlRfTk9ERV9UWVBFID0gMTsKClRob3JheC5Db2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbi5leHRlbmQoewogIG1vZGVsOiBUaG9yYXguTW9kZWwgfHwgQmFja2JvbmUuTW9kZWwsCiAgaXNFbXB0eTogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5sZW5ndGggPiAwKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLmxlbmd0aCA9PT0gMCAmJiB0aGlzLmlzUG9wdWxhdGVkKCk7CiAgICB9CiAgfSwKICBpc1BvcHVsYXRlZDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fZmV0Y2hlZCB8fCB0aGlzLmxlbmd0aCA+IDAgfHwgKCF0aGlzLmxlbmd0aCAmJiAhZ2V0VmFsdWUodGhpcywgJ3VybCcpKTsKICB9LAogIHNob3VsZEZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICByZXR1cm4gb3B0aW9ucy5mZXRjaCAmJiAhIWdldFZhbHVlKHRoaXMsICd1cmwnKSAmJiAhdGhpcy5pc1BvcHVsYXRlZCgpOwogIH0sCiAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihjb2xsZWN0aW9uLCByZXNwb25zZSkgewogICAgICBjb2xsZWN0aW9uLl9mZXRjaGVkID0gdHJ1ZTsKICAgICAgc3VjY2VzcyAmJiBzdWNjZXNzKGNvbGxlY3Rpb24sIHJlc3BvbnNlKTsKICAgIH07CiAgICByZXR1cm4gX2ZldGNoLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfSwKICByZXNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICB0aGlzLl9mZXRjaGVkID0gISFtb2RlbHM7CiAgICByZXR1cm4gX3Jlc2V0LmNhbGwodGhpcywgbW9kZWxzLCBvcHRpb25zKTsKICB9Cn0pOwoKVGhvcmF4LkNvbGxlY3Rpb25zID0ge307CmNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcihUaG9yYXguQ29sbGVjdGlvbiwgVGhvcmF4LkNvbGxlY3Rpb25zKTsKCmRhdGFPYmplY3QoJ2NvbGxlY3Rpb24nLCB7CiAgc2V0OiAnc2V0Q29sbGVjdGlvbicsCiAgc2V0Q2FsbGJhY2s6IGFmdGVyU2V0Q29sbGVjdGlvbiwKICBkZWZhdWx0T3B0aW9uczogewogICAgcmVuZGVyOiB0cnVlLAogICAgZmV0Y2g6IHRydWUsCiAgICBzdWNjZXNzOiBmYWxzZSwKICAgIGVycm9yczogdHJ1ZQogIH0sCiAgY2hhbmdlOiBvbkNvbGxlY3Rpb25SZXNldCwKICAkZWw6ICdnZXRDb2xsZWN0aW9uRWxlbWVudCcsCiAgY2lkQXR0ck5hbWU6IGNvbGxlY3Rpb25DaWRBdHRyaWJ1dGVOYW1lCn0pOwoKXy5leHRlbmQoVGhvcmF4LlZpZXcucHJvdG90eXBlLCB7CiAgX2NvbGxlY3Rpb25TZWxlY3RvcjogJ1snICsgY29sbGVjdGlvbkVsZW1lbnRBdHRyaWJ1dGVOYW1lICsgJ10nLAogIC8vYXBwZW5kSXRlbShtb2RlbCBbLGluZGV4XSkKICAvL2FwcGVuZEl0ZW0oaHRtbF9zdHJpbmcsIGluZGV4KQogIC8vYXBwZW5kSXRlbSh2aWV3LCBpbmRleCkKICBhcHBlbmRJdGVtOiBmdW5jdGlvbihtb2RlbCwgaW5kZXgsIG9wdGlvbnMpIHsKICAgIC8vZW1wdHkgaXRlbQogICAgaWYgKCFtb2RlbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgaXRlbVZpZXcsCiAgICAgICAgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAvL2lmIGluZGV4IGFyZ3VtZW50IGlzIGEgdmlldwogICAgaW5kZXggJiYgaW5kZXguZWwgJiYgKGluZGV4ID0gJGVsLmNoaWxkcmVuKCkuaW5kZXhPZihpbmRleC5lbCkgKyAxKTsKICAgIC8vaWYgYXJndW1lbnQgaXMgYSB2aWV3LCBvciBodG1sIHN0cmluZwogICAgaWYgKG1vZGVsLmVsIHx8IHR5cGVvZiBtb2RlbCA9PT0gJ3N0cmluZycpIHsKICAgICAgaXRlbVZpZXcgPSBtb2RlbDsKICAgICAgbW9kZWwgPSBmYWxzZTsKICAgIH0gZWxzZSB7CiAgICAgIGluZGV4ID0gaW5kZXggfHwgdGhpcy5jb2xsZWN0aW9uLmluZGV4T2YobW9kZWwpIHx8IDA7CiAgICAgIGl0ZW1WaWV3ID0gdGhpcy5yZW5kZXJJdGVtKG1vZGVsLCBpbmRleCk7CiAgICB9CiAgICBpZiAoaXRlbVZpZXcpIHsKICAgICAgaXRlbVZpZXcuY2lkICYmIHRoaXMuX2FkZENoaWxkKGl0ZW1WaWV3KTsKICAgICAgLy9pZiB0aGUgcmVuZGVyZXIncyBvdXRwdXQgd2Fzbid0IGNvbnRhaW5lZCBpbiBhIHRhZywgd3JhcCBpdCBpbiBhIGRpdgogICAgICAvL3BsYWluIHRleHQsIG9yIGEgbWl4dHVyZSBvZiB0b3AgbGV2ZWwgdGV4dCBub2RlcyBhbmQgZWxlbWVudCBub2RlcwogICAgICAvL3dpbGwgZ2V0IHdyYXBwZWQKICAgICAgaWYgKHR5cGVvZiBpdGVtVmlldyA9PT0gJ3N0cmluZycgJiYgIWl0ZW1WaWV3Lm1hdGNoKC9eXHMqPC9tKSkgewogICAgICAgIGl0ZW1WaWV3ID0gJzxkaXY+JyArIGl0ZW1WaWV3ICsgJzwvZGl2Pic7CiAgICAgIH0KICAgICAgdmFyIGl0ZW1FbGVtZW50ID0gaXRlbVZpZXcuZWwgPyBbaXRlbVZpZXcuZWxdIDogXy5maWx0ZXIoJChpdGVtVmlldyksIGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAvL2ZpbHRlciBvdXQgdG9wIGxldmVsIHdoaXRlc3BhY2Ugbm9kZXMKICAgICAgICByZXR1cm4gbm9kZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFX1RZUEU7CiAgICAgIH0pOwogICAgICBtb2RlbCAmJiAkKGl0ZW1FbGVtZW50KS5hdHRyKG1vZGVsQ2lkQXR0cmlidXRlTmFtZSwgbW9kZWwuY2lkKTsKICAgICAgdmFyIHByZXZpb3VzTW9kZWwgPSBpbmRleCA+IDAgPyB0aGlzLmNvbGxlY3Rpb24uYXQoaW5kZXggLSAxKSA6IGZhbHNlOwogICAgICBpZiAoIXByZXZpb3VzTW9kZWwpIHsKICAgICAgICAkZWwucHJlcGVuZChpdGVtRWxlbWVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy91c2UgbGFzdCgpIGFzIGFwcGVuZEl0ZW0gY2FuIGFjY2VwdCBtdWx0aXBsZSBub2RlcyBmcm9tIGEgdGVtcGxhdGUKICAgICAgICB2YXIgbGFzdCA9ICRlbC5maW5kKCdbJyArIG1vZGVsQ2lkQXR0cmlidXRlTmFtZSArICc9IicgKyBwcmV2aW91c01vZGVsLmNpZCArICciXScpLmxhc3QoKTsKICAgICAgICBsYXN0LmFmdGVyKGl0ZW1FbGVtZW50KTsKICAgICAgfQoKICAgICAgdGhpcy50cmlnZ2VyKCdhcHBlbmQnLCBudWxsLCBmdW5jdGlvbihlbCkgewogICAgICAgIGVsLnNldEF0dHJpYnV0ZShtb2RlbENpZEF0dHJpYnV0ZU5hbWUsIG1vZGVsLmNpZCk7CiAgICAgIH0pOwoKICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgewogICAgICAgIHRoaXMudHJpZ2dlcigncmVuZGVyZWQ6aXRlbScsIHRoaXMsIHRoaXMuY29sbGVjdGlvbiwgbW9kZWwsIGl0ZW1FbGVtZW50LCBpbmRleCk7CiAgICAgICAgYXBwbHlJdGVtVmlzaWJsaXR5RmlsdGVyLmNhbGwodGhpcywgbW9kZWwpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gaXRlbVZpZXc7CiAgfSwKICAvL8KgdXBkYXRlSXRlbSBvbmx5IHVzZWZ1bCBpZiB0aGVyZSBpcyBubyBpdGVtIHZpZXcsIG90aGVyd2lzZQogIC8vwqBpdGVtVmlldy5yZW5kZXIoKSBwcm92aWRlcyB0aGUgc2FtZSBmdW5jdGlvbmFsaXR5CiAgdXBkYXRlSXRlbTogZnVuY3Rpb24obW9kZWwpIHsKICAgIHRoaXMucmVtb3ZlSXRlbShtb2RlbCk7CiAgICB0aGlzLmFwcGVuZEl0ZW0obW9kZWwpOwogIH0sCiAgcmVtb3ZlSXRlbTogZnVuY3Rpb24obW9kZWwpIHsKICAgIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCksCiAgICAgICAgdmlld0VsID0gJGVsLmZpbmQoJ1snICsgbW9kZWxDaWRBdHRyaWJ1dGVOYW1lICsgJz0iJyArIG1vZGVsLmNpZCArICciXScpOwogICAgaWYgKCF2aWV3RWwubGVuZ3RoKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHZpZXdFbC5yZW1vdmUoKTsKICAgIHZhciB2aWV3Q2lkID0gdmlld0VsLmF0dHIodmlld0NpZEF0dHJpYnV0ZU5hbWUpLAogICAgICAgIGNoaWxkID0gdGhpcy5jaGlsZHJlblt2aWV3Q2lkXTsKICAgIGlmIChjaGlsZCkgewogICAgICB0aGlzLl9yZW1vdmVDaGlsZChjaGlsZCk7CiAgICAgIGNoaWxkLmRlc3Ryb3koKTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0sCiAgcmVuZGVyQ29sbGVjdGlvbjogZnVuY3Rpb24oKSB7CiAgICB0aGlzLmVuc3VyZVJlbmRlcmVkKCk7CiAgICBpZiAoY29sbGVjdGlvbkhlbHBlclByZXNlbnRGb3JQcmltYXJ5Q29sbGVjdGlvbi5jYWxsKHRoaXMpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0aGlzLmNvbGxlY3Rpb24pIHsKICAgICAgaWYgKHRoaXMuY29sbGVjdGlvbi5pc0VtcHR5KCkpIHsKICAgICAgICBoYW5kbGVDaGFuZ2VGcm9tTm90RW1wdHlUb0VtcHR5LmNhbGwodGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaGFuZGxlQ2hhbmdlRnJvbUVtcHR5VG9Ob3RFbXB0eS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuY29sbGVjdGlvbi5mb3JFYWNoKGZ1bmN0aW9uKGl0ZW0sIGkpIHsKICAgICAgICAgIHRoaXMuYXBwZW5kSXRlbShpdGVtLCBpKTsKICAgICAgICB9LCB0aGlzKTsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXIoJ3JlbmRlcmVkOmNvbGxlY3Rpb24nLCB0aGlzLCB0aGlzLmNvbGxlY3Rpb24pOwogICAgICBhcHBseVZpc2liaWxpdHlGaWx0ZXIuY2FsbCh0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIGhhbmRsZUNoYW5nZUZyb21Ob3RFbXB0eVRvRW1wdHkuY2FsbCh0aGlzKTsKICAgIH0KICB9LAogIGVtcHR5Q2xhc3M6ICdlbXB0eScsCiAgcmVuZGVyRW1wdHk6IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuZW1wdHlWaWV3KSB7CiAgICAgIHZhciB2aWV3T3B0aW9ucyA9IHt9OwogICAgICBpZiAodGhpcy5lbXB0eVRlbXBsYXRlKSB7CiAgICAgICAgdmlld09wdGlvbnMudGVtcGxhdGUgPSB0aGlzLmVtcHR5VGVtcGxhdGU7CiAgICAgIH0KICAgICAgdmFyIHZpZXcgPSBUaG9yYXguVXRpbC5nZXRWaWV3SW5zdGFuY2UodGhpcy5lbXB0eVZpZXcsIHZpZXdPcHRpb25zKTsKICAgICAgdmlldy5lbnN1cmVSZW5kZXJlZCgpOwogICAgICByZXR1cm4gdmlldzsKICAgIH0gZWxzZSB7CiAgICAgIGlmICghdGhpcy5lbXB0eVRlbXBsYXRlKSB7CiAgICAgICAgdGhpcy5lbXB0eVRlbXBsYXRlID0gVGhvcmF4LlV0aWwuZ2V0VGVtcGxhdGUodGhpcy5uYW1lICsgJy1lbXB0eScsIHRydWUpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmVtcHR5VGVtcGxhdGUgJiYgdGhpcy5yZW5kZXJUZW1wbGF0ZSh0aGlzLmVtcHR5VGVtcGxhdGUpOwogICAgfQogIH0sCiAgcmVuZGVySXRlbTogZnVuY3Rpb24obW9kZWwsIGkpIHsKICAgIGlmICh0aGlzLml0ZW1WaWV3KSB7CiAgICAgIHZhciB2aWV3T3B0aW9ucyA9IHsKICAgICAgICBtb2RlbDogbW9kZWwKICAgICAgfTsKICAgICAgaWYgKHRoaXMuaXRlbVRlbXBsYXRlKSB7CiAgICAgICAgdmlld09wdGlvbnMudGVtcGxhdGUgPSB0aGlzLml0ZW1UZW1wbGF0ZTsKICAgICAgfQogICAgICB2YXIgdmlldyA9IFRob3JheC5VdGlsLmdldFZpZXdJbnN0YW5jZSh0aGlzLml0ZW1WaWV3LCB2aWV3T3B0aW9ucyk7CiAgICAgIHZpZXcuZW5zdXJlUmVuZGVyZWQoKTsKICAgICAgcmV0dXJuIHZpZXc7CiAgICB9IGVsc2UgewogICAgICBpZiAoIXRoaXMuaXRlbVRlbXBsYXRlKSB7CiAgICAgICAgdGhpcy5pdGVtVGVtcGxhdGUgPSBUaG9yYXguVXRpbC5nZXRUZW1wbGF0ZSh0aGlzLm5hbWUgKyAnLWl0ZW0nKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5yZW5kZXJUZW1wbGF0ZSh0aGlzLml0ZW1UZW1wbGF0ZSwgdGhpcy5pdGVtQ29udGV4dChtb2RlbCwgaSkpOwogICAgfQogIH0sCiAgaXRlbUNvbnRleHQ6IGZ1bmN0aW9uKG1vZGVsIC8qLCBpICovKSB7CiAgICByZXR1cm4gbW9kZWwuYXR0cmlidXRlczsKICB9LAogIGFwcGVuZEVtcHR5OiBmdW5jdGlvbigpIHsKICAgIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgICAkZWwuZW1wdHkoKTsKICAgIHZhciBlbXB0eUNvbnRlbnQgPSB0aGlzLnJlbmRlckVtcHR5KCk7CiAgICBlbXB0eUNvbnRlbnQgJiYgdGhpcy5hcHBlbmRJdGVtKGVtcHR5Q29udGVudCwgMCwgewogICAgICBzaWxlbnQ6IHRydWUKICAgIH0pOwogICAgdGhpcy50cmlnZ2VyKCdyZW5kZXJlZDplbXB0eScsIHRoaXMsIHRoaXMuY29sbGVjdGlvbik7CiAgfSwKICBnZXRDb2xsZWN0aW9uRWxlbWVudDogZnVuY3Rpb24oKSB7CiAgICB2YXIgZWxlbWVudCA9IHRoaXMuJCh0aGlzLl9jb2xsZWN0aW9uU2VsZWN0b3IpOwogICAgcmV0dXJuIGVsZW1lbnQubGVuZ3RoID09PSAwID8gdGhpcy4kZWwgOiBlbGVtZW50OwogIH0sCiAgLy8gRXZlbnRzIHRoYXQgd2lsbCBvbmx5IGJlIGJvdW5kIHRvICJ0aGlzLmNvbGxlY3Rpb24iCiAgX2NvbGxlY3Rpb25SZW5kZXJpbmdFdmVudHM6IHsKICAgIHJlc2V0OiBvbkNvbGxlY3Rpb25SZXNldCwKICAgIHNvcnQ6IG9uQ29sbGVjdGlvblJlc2V0LAogICAgZmlsdGVyOiBmdW5jdGlvbigpIHsKICAgICAgYXBwbHlWaXNpYmlsaXR5RmlsdGVyLmNhbGwodGhpcyk7CiAgICB9LAogICAgY2hhbmdlOiBmdW5jdGlvbihtb2RlbCkgewogICAgICAvLyBJZiB3ZSByZW5kZXJlZCB3aXRoIGl0ZW0gdmlld3MsIG1vZGVsIGNoYW5nZXMgd2lsbCBiZSBvYnNlcnZlZAogICAgICAvLyBieSB0aGUgZ2VuZXJhdGVkIGl0ZW0gdmlldyBidXQgaWYgd2UgcmVuZGVyZWQgd2l0aCB0ZW1wbGF0ZXMKICAgICAgLy8gdGhlbiBtb2RlbCBjaGFuZ2VzIG5lZWQgdG8gYmUgYm91bmQgYXMgbm90aGluZyBpcyB3YXRjaGluZwogICAgICAhdGhpcy5pdGVtVmlldyAmJiB0aGlzLnVwZGF0ZUl0ZW0obW9kZWwpOwogICAgICBhcHBseUl0ZW1WaXNpYmxpdHlGaWx0ZXIuY2FsbCh0aGlzLCBtb2RlbCk7CiAgICB9LAogICAgYWRkOiBmdW5jdGlvbihtb2RlbCkgewogICAgICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogICAgICB0aGlzLmNvbGxlY3Rpb24ubGVuZ3RoID09PSAxICYmICRlbC5sZW5ndGggJiYgaGFuZGxlQ2hhbmdlRnJvbUVtcHR5VG9Ob3RFbXB0eS5jYWxsKHRoaXMpOwogICAgICBpZiAoJGVsLmxlbmd0aCkgewogICAgICAgIHZhciBpbmRleCA9IHRoaXMuY29sbGVjdGlvbi5pbmRleE9mKG1vZGVsKTsKICAgICAgICB0aGlzLmFwcGVuZEl0ZW0obW9kZWwsIGluZGV4KTsKICAgICAgfQogICAgfSwKICAgIHJlbW92ZTogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgdmFyICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICAgICAgdGhpcy5yZW1vdmVJdGVtKG1vZGVsKTsKICAgICAgdGhpcy5jb2xsZWN0aW9uLmxlbmd0aCA9PT0gMCAmJiAkZWwubGVuZ3RoICYmIGhhbmRsZUNoYW5nZUZyb21Ob3RFbXB0eVRvRW1wdHkuY2FsbCh0aGlzKTsKICAgIH0KICB9Cn0pOwoKVGhvcmF4LlZpZXcub24oewogIGNvbGxlY3Rpb246IHsKICAgIGVycm9yOiBmdW5jdGlvbihjb2xsZWN0aW9uLCBtZXNzYWdlKSB7CiAgICAgIGlmICh0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbY29sbGVjdGlvbi5jaWRdLmVycm9ycykgewogICAgICAgIHRoaXMudHJpZ2dlcignZXJyb3InLCBtZXNzYWdlLCBjb2xsZWN0aW9uKTsKICAgICAgfQogICAgfQogIH0KfSk7CgpmdW5jdGlvbiBvbkNvbGxlY3Rpb25SZXNldChjb2xsZWN0aW9uKSB7CiAgaWYgKGNvbGxlY3Rpb24gPT09IHRoaXMuY29sbGVjdGlvbiAmJiB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbdGhpcy5jb2xsZWN0aW9uLmNpZF0ucmVuZGVyKSB7CiAgICB0aGlzLnJlbmRlckNvbGxlY3Rpb24oKTsKICB9Cn0KCmZ1bmN0aW9uIGFmdGVyU2V0Q29sbGVjdGlvbihjb2xsZWN0aW9uKSB7CiAgaWYgKCFjb2xsZWN0aW9uSGVscGVyUHJlc2VudEZvclByaW1hcnlDb2xsZWN0aW9uLmNhbGwodGhpcykgJiYgY29sbGVjdGlvbikgewogICAgXy5lYWNoKHRoaXMuX2NvbGxlY3Rpb25SZW5kZXJpbmdFdmVudHMsIGZ1bmN0aW9uKGNhbGxiYWNrLCBldmVudE5hbWUpIHsKICAgICAgLy8gZ2V0RXZlbnRDYWxsYmFjayB3aWxsIHJlc29sdmUgaWYgaXQgaXMgYSBzdHJpbmcgb3IgYSBtZXRob2QKICAgICAgLy8gYW5kIHJldHVybiBhIG1ldGhvZAogICAgICB0aGlzLmxpc3RlblRvKGNvbGxlY3Rpb24sIGV2ZW50TmFtZSwgZ2V0RXZlbnRDYWxsYmFjayhjYWxsYmFjaywgdGhpcykpOwogICAgfSwgdGhpcyk7CiAgfQp9CgpmdW5jdGlvbiBjb2xsZWN0aW9uSGVscGVyUHJlc2VudEZvclByaW1hcnlDb2xsZWN0aW9uKCkgewogIHJldHVybiB0aGlzLmNvbGxlY3Rpb24gJiYgdGhpcy4kKCdbJyArIHByaW1hcnlDb2xsZWN0aW9uQXR0cmlidXRlTmFtZSArICc9IicgKyB0aGlzLmNvbGxlY3Rpb24uY2lkICsgJyJdJykubGVuZ3RoOwp9CgpmdW5jdGlvbiBhcHBseVZpc2liaWxpdHlGaWx0ZXIoKSB7CiAgaWYgKHRoaXMuaXRlbUZpbHRlcikgewogICAgdGhpcy5jb2xsZWN0aW9uLmZvckVhY2goZnVuY3Rpb24obW9kZWwpIHsKICAgICAgYXBwbHlJdGVtVmlzaWJsaXR5RmlsdGVyLmNhbGwodGhpcywgbW9kZWwpOwogICAgfSwgdGhpcyk7CiAgfQp9CgpmdW5jdGlvbiBhcHBseUl0ZW1WaXNpYmxpdHlGaWx0ZXIobW9kZWwpIHsKICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogIHRoaXMuaXRlbUZpbHRlciAmJiAkZWwuZmluZCgnWycgKyBtb2RlbENpZEF0dHJpYnV0ZU5hbWUgKyAnPSInICsgbW9kZWwuY2lkICsgJyJdJylbaXRlbVNob3VsZEJlVmlzaWJsZS5jYWxsKHRoaXMsIG1vZGVsKSA/ICdzaG93JyA6ICdoaWRlJ10oKTsKfQoKZnVuY3Rpb24gaXRlbVNob3VsZEJlVmlzaWJsZShtb2RlbCkgewogIHJldHVybiB0aGlzLml0ZW1GaWx0ZXIobW9kZWwsIHRoaXMuY29sbGVjdGlvbi5pbmRleE9mKG1vZGVsKSk7Cn0KCmZ1bmN0aW9uIGhhbmRsZUNoYW5nZUZyb21FbXB0eVRvTm90RW1wdHkoKSB7CiAgdmFyICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICB0aGlzLmVtcHR5Q2xhc3MgJiYgJGVsLnJlbW92ZUNsYXNzKHRoaXMuZW1wdHlDbGFzcyk7CiAgJGVsLnJlbW92ZUF0dHIoY29sbGVjdGlvbkVtcHR5QXR0cmlidXRlTmFtZSk7CiAgJGVsLmVtcHR5KCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZUNoYW5nZUZyb21Ob3RFbXB0eVRvRW1wdHkoKSB7CiAgdmFyICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICB0aGlzLmVtcHR5Q2xhc3MgJiYgJGVsLmFkZENsYXNzKHRoaXMuZW1wdHlDbGFzcyk7CiAgJGVsLmF0dHIoY29sbGVjdGlvbkVtcHR5QXR0cmlidXRlTmFtZSwgdHJ1ZSk7CiAgdGhpcy5hcHBlbmRFbXB0eSgpOwp9CgovLyQoc2VsZWN0b3IpLmNvbGxlY3Rpb24oKSBoZWxwZXIKJC5mbi5jb2xsZWN0aW9uID0gZnVuY3Rpb24odmlldykgewogIGlmICh2aWV3ICYmIHZpZXcuY29sbGVjdGlvbikgewogICAgcmV0dXJuIHZpZXcuY29sbGVjdGlvbjsKICB9CiAgdmFyICR0aGlzID0gJCh0aGlzKSwKICAgICAgY29sbGVjdGlvbkVsZW1lbnQgPSAkdGhpcy5jbG9zZXN0KCdbJyArIGNvbGxlY3Rpb25DaWRBdHRyaWJ1dGVOYW1lICsgJ10nKSwKICAgICAgY29sbGVjdGlvbkNpZCA9IGNvbGxlY3Rpb25FbGVtZW50ICYmIGNvbGxlY3Rpb25FbGVtZW50LmF0dHIoY29sbGVjdGlvbkNpZEF0dHJpYnV0ZU5hbWUpOwogIGlmIChjb2xsZWN0aW9uQ2lkKSB7CiAgICB2aWV3ID0gJHRoaXMudmlldygpOwogICAgaWYgKHZpZXcpIHsKICAgICAgcmV0dXJuIHZpZXcuY29sbGVjdGlvbjsKICAgIH0KICB9CiAgcmV0dXJuIGZhbHNlOwp9OwoKOzsKLypnbG9iYWwgaW5oZXJpdFZhcnMgKi8KCmluaGVyaXRWYXJzLm1vZGVsLmRlZmF1bHRPcHRpb25zLnBvcHVsYXRlID0gdHJ1ZTsKCnZhciBvbGRNb2RlbENoYW5nZSA9IGluaGVyaXRWYXJzLm1vZGVsLmNoYW5nZTsKaW5oZXJpdFZhcnMubW9kZWwuY2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgb2xkTW9kZWxDaGFuZ2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAvLyBUT0RPIDogV2hhdCBjYW4gd2UgZG8gdG8gcmVtb3ZlIHRoaXMgZHVwbGljYXRpb24/CiAgdmFyIG1vZGVsT3B0aW9ucyA9IHRoaXMubW9kZWwgJiYgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW3RoaXMubW9kZWwuY2lkXTsKICBpZiAobW9kZWxPcHRpb25zICYmIG1vZGVsT3B0aW9ucy5wb3B1bGF0ZSkgewogICAgdGhpcy5wb3B1bGF0ZSh0aGlzLm1vZGVsLmF0dHJpYnV0ZXMsIG1vZGVsT3B0aW9ucy5wb3B1bGF0ZSA9PT0gdHJ1ZSA/IHt9IDogbW9kZWxPcHRpb25zLnBvcHVsYXRlKTsKICB9Cn07CmluaGVyaXRWYXJzLm1vZGVsLmRlZmF1bHRPcHRpb25zLnBvcHVsYXRlID0gdHJ1ZTsKCl8uZXh0ZW5kKFRob3JheC5WaWV3LnByb3RvdHlwZSwgewogIC8vc2VyaWFsaXplcyBhIGZvcm0gcHJlc2VudCBpbiB0aGUgdmlldywgcmV0dXJuaW5nIHRoZSBzZXJpYWxpemVkIGRhdGEKICAvL2FzIGFuIG9iamVjdAogIC8vcGFzcyB7c2V0OmZhbHNlfSB0byBub3QgdXBkYXRlIHRoaXMubW9kZWwgaWYgcHJlc2VudAogIC8vY2FuIHBhc3Mgb3B0aW9ucywgY2FsbGJhY2sgb3IgZXZlbnQgaW4gYW55IG9yZGVyCiAgc2VyaWFsaXplOiBmdW5jdGlvbigpIHsKICAgIHZhciBjYWxsYmFjaywgb3B0aW9ucywgZXZlbnQ7CiAgICAvL2lnbm9yZSB1bmRlZmluZWQgYXJndW1lbnRzIGluIGNhc2UgZXZlbnQgd2FzIG51bGwKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgKytpKSB7CiAgICAgIGlmICh0eXBlb2YgYXJndW1lbnRzW2ldID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgY2FsbGJhY2sgPSBhcmd1bWVudHNbaV07CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZ3VtZW50c1tpXSA9PT0gJ29iamVjdCcpIHsKICAgICAgICBpZiAoJ3N0b3BQcm9wYWdhdGlvbicgaW4gYXJndW1lbnRzW2ldICYmICdwcmV2ZW50RGVmYXVsdCcgaW4gYXJndW1lbnRzW2ldKSB7CiAgICAgICAgICBldmVudCA9IGFyZ3VtZW50c1tpXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgb3B0aW9ucyA9IGFyZ3VtZW50c1tpXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAoZXZlbnQgJiYgIXRoaXMuX3ByZXZlbnREdXBsaWNhdGVTdWJtaXNzaW9uKGV2ZW50KSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHsKICAgICAgc2V0OiB0cnVlLAogICAgICB2YWxpZGF0ZTogdHJ1ZSwKICAgICAgY2hpbGRyZW46IHRydWUsCiAgICAgIHNpbGVudDogdHJ1ZQogICAgfSwgb3B0aW9ucyB8fCB7fSk7CgogICAgdmFyIGF0dHJpYnV0ZXMgPSBvcHRpb25zLmF0dHJpYnV0ZXMgfHwge307CgogICAgLy9jYWxsYmFjayBoYXMgY29udGV4dCBvZiBlbGVtZW50CiAgICB2YXIgdmlldyA9IHRoaXM7CiAgICB2YXIgZXJyb3JzID0gW107CiAgICBlYWNoTmFtZWRJbnB1dC5jYWxsKHRoaXMsIG9wdGlvbnMsIGZ1bmN0aW9uKCkgewogICAgICB2YXIgdmFsdWUgPSB2aWV3Ll9nZXRJbnB1dFZhbHVlKHRoaXMsIG9wdGlvbnMsIGVycm9ycyk7CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgb2JqZWN0QW5kS2V5RnJvbUF0dHJpYnV0ZXNBbmROYW1lLmNhbGwodGhpcywgYXR0cmlidXRlcywgdGhpcy5uYW1lLCB7bW9kZTogJ3NlcmlhbGl6ZSd9LCBmdW5jdGlvbihvYmplY3QsIGtleSkgewogICAgICAgICAgaWYgKCFvYmplY3Rba2V5XSkgewogICAgICAgICAgICBvYmplY3Rba2V5XSA9IHZhbHVlOwogICAgICAgICAgfSBlbHNlIGlmIChfLmlzQXJyYXkob2JqZWN0W2tleV0pKSB7CiAgICAgICAgICAgIG9iamVjdFtrZXldLnB1c2godmFsdWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgb2JqZWN0W2tleV0gPSBbb2JqZWN0W2tleV0sIHZhbHVlXTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CgogICAgdGhpcy50cmlnZ2VyKCdzZXJpYWxpemUnLCBhdHRyaWJ1dGVzLCBvcHRpb25zKTsKCiAgICBpZiAob3B0aW9ucy52YWxpZGF0ZSkgewogICAgICB2YXIgdmFsaWRhdGVJbnB1dEVycm9ycyA9IHRoaXMudmFsaWRhdGVJbnB1dChhdHRyaWJ1dGVzKTsKICAgICAgaWYgKHZhbGlkYXRlSW5wdXRFcnJvcnMgJiYgdmFsaWRhdGVJbnB1dEVycm9ycy5sZW5ndGgpIHsKICAgICAgICBlcnJvcnMgPSBlcnJvcnMuY29uY2F0KHZhbGlkYXRlSW5wdXRFcnJvcnMpOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlcigndmFsaWRhdGUnLCBhdHRyaWJ1dGVzLCBlcnJvcnMsIG9wdGlvbnMpOwogICAgICBpZiAoZXJyb3JzLmxlbmd0aCkgewogICAgICAgIHRoaXMudHJpZ2dlcignZXJyb3InLCBlcnJvcnMpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQoKICAgIGlmIChvcHRpb25zLnNldCAmJiB0aGlzLm1vZGVsKSB7CiAgICAgIGlmICghdGhpcy5tb2RlbC5zZXQoYXR0cmlidXRlcywge3NpbGVudDogb3B0aW9ucy5zaWxlbnR9KSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQoKICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrLmNhbGwodGhpcywgYXR0cmlidXRlcywgXy5iaW5kKHJlc2V0U3VibWl0U3RhdGUsIHRoaXMpKTsKICAgIHJldHVybiBhdHRyaWJ1dGVzOwogIH0sCgogIF9wcmV2ZW50RHVwbGljYXRlU3VibWlzc2lvbjogZnVuY3Rpb24oZXZlbnQsIGNhbGxiYWNrKSB7CiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKICAgIHZhciBmb3JtID0gJChldmVudC50YXJnZXQpOwogICAgaWYgKChldmVudC50YXJnZXQudGFnTmFtZSB8fCAnJykudG9Mb3dlckNhc2UoKSAhPT0gJ2Zvcm0nKSB7CiAgICAgIC8vIEhhbmRsZSBub24tc3VibWl0IGV2ZW50cyBieSBnYXRpbmcgb24gdGhlIGZvcm0KICAgICAgZm9ybSA9ICQoZXZlbnQudGFyZ2V0KS5jbG9zZXN0KCdmb3JtJyk7CiAgICB9CgogICAgaWYgKCFmb3JtLmF0dHIoJ2RhdGEtc3VibWl0LXdhaXQnKSkgewogICAgICBmb3JtLmF0dHIoJ2RhdGEtc3VibWl0LXdhaXQnLCAndHJ1ZScpOwogICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICBjYWxsYmFjay5jYWxsKHRoaXMsIGV2ZW50KTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9LAoKICAvL3BvcHVsYXRlIGEgZm9ybSBmcm9tIHRoZSBwYXNzZWQgYXR0cmlidXRlcyBvciB0aGlzLm1vZGVsIGlmIHByZXNlbnQKICBwb3B1bGF0ZTogZnVuY3Rpb24oYXR0cmlidXRlcywgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHsKICAgICAgY2hpbGRyZW46IHRydWUKICAgIH0sIG9wdGlvbnMgfHwge30pOwogICAgdmFyIHZhbHVlLCBhdHRyaWJ1dGVzID0gYXR0cmlidXRlcyB8fCB0aGlzLl9nZXRDb250ZXh0KCk7CiAgICAvL2NhbGxiYWNrIGhhcyBjb250ZXh0IG9mIGVsZW1lbnQKICAgIGVhY2hOYW1lZElucHV0LmNhbGwodGhpcywgb3B0aW9ucywgZnVuY3Rpb24oKSB7CiAgICAgIG9iamVjdEFuZEtleUZyb21BdHRyaWJ1dGVzQW5kTmFtZS5jYWxsKHRoaXMsIGF0dHJpYnV0ZXMsIHRoaXMubmFtZSwge21vZGU6ICdwb3B1bGF0ZSd9LCBmdW5jdGlvbihvYmplY3QsIGtleSkgewogICAgICAgIGlmIChvYmplY3QgJiYgdHlwZW9mICh2YWx1ZSA9IG9iamVjdFtrZXldKSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIC8vd2lsbCBvbmx5IGV4ZWN1dGUgaWYgd2UgaGF2ZSBhIG5hbWUgdGhhdCBtYXRjaGVzIHRoZSBzdHJ1Y3R1cmUgaW4gYXR0cmlidXRlcwogICAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gJ2NoZWNrYm94JyAmJiBfLmlzQm9vbGVhbih2YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy5jaGVja2VkID0gdmFsdWU7CiAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudHlwZSA9PT0gJ2NoZWNrYm94JyB8fCB0aGlzLnR5cGUgPT09ICdyYWRpbycpIHsKICAgICAgICAgICAgdGhpcy5jaGVja2VkID0gdmFsdWUgPT0gdGhpcy52YWx1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CgogICAgdGhpcy50cmlnZ2VyKCdwb3B1bGF0ZScsIGF0dHJpYnV0ZXMpOwogIH0sCgogIC8vcGVyZm9ybSBmb3JtIHZhbGlkYXRpb24sIGltcGxlbWVudGVkIGJ5IGNoaWxkIGNsYXNzCiAgdmFsaWRhdGVJbnB1dDogZnVuY3Rpb24oLyogYXR0cmlidXRlcywgb3B0aW9ucywgZXJyb3JzICovKSB7fSwKCiAgX2dldElucHV0VmFsdWU6IGZ1bmN0aW9uKGlucHV0IC8qICwgb3B0aW9ucywgZXJyb3JzICovKSB7CiAgICBpZiAoaW5wdXQudHlwZSA9PT0gJ2NoZWNrYm94JyB8fCBpbnB1dC50eXBlID09PSAncmFkaW8nKSB7CiAgICAgIGlmIChpbnB1dC5jaGVja2VkKSB7CiAgICAgICAgcmV0dXJuIGlucHV0LnZhbHVlOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlucHV0Lm11bHRpcGxlID09PSB0cnVlKSB7CiAgICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgICAgJCgnb3B0aW9uJywgaW5wdXQpLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWQpIHsKICAgICAgICAgIHZhbHVlcy5wdXNoKHRoaXMudmFsdWUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiB2YWx1ZXM7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gaW5wdXQudmFsdWU7CiAgICB9CiAgfQp9KTsKClRob3JheC5WaWV3Lm9uKHsKICBlcnJvcjogZnVuY3Rpb24oKSB7CiAgICByZXNldFN1Ym1pdFN0YXRlLmNhbGwodGhpcyk7CgogICAgLy8gSWYgd2UgZXJyb3JlZCB3aXRoIGEgbW9kZWwgd2Ugd2FudCB0byByZXNldCB0aGUgY29udGVudCBidXQgbGVhdmUgdGhlIFVJCiAgICAvLyBpbnRhY3QuIElmIHRoZSB1c2VyIHVwZGF0ZXMgdGhlIGRhdGEgYW5kIHNlcmlhbGl6ZXMgYW55IG92ZXJ3cml0dGVuIGRhdGEKICAgIC8vIHdpbGwgYmUgcmVzdG9yZWQuCiAgICBpZiAodGhpcy5tb2RlbCAmJiB0aGlzLm1vZGVsLnByZXZpb3VzQXR0cmlidXRlcykgewogICAgICB0aGlzLm1vZGVsLnNldCh0aGlzLm1vZGVsLnByZXZpb3VzQXR0cmlidXRlcygpLCB7CiAgICAgICAgc2lsZW50OiB0cnVlCiAgICAgIH0pOwogICAgfQogIH0sCiAgZGVhY3RpdmF0ZWQ6IGZ1bmN0aW9uKCkgewogICAgcmVzZXRTdWJtaXRTdGF0ZS5jYWxsKHRoaXMpOwogIH0KfSk7CgpmdW5jdGlvbiBlYWNoTmFtZWRJbnB1dChvcHRpb25zLCBpdGVyYXRvciwgY29udGV4dCkgewogIHZhciBpID0gMCwKICAgICAgc2VsZiA9IHRoaXM7CgogIHRoaXMuJCgnc2VsZWN0LGlucHV0LHRleHRhcmVhJywgb3B0aW9ucy5yb290IHx8IHRoaXMuZWwpLmVhY2goZnVuY3Rpb24oKSB7CiAgICBpZiAoIW9wdGlvbnMuY2hpbGRyZW4pIHsKICAgICAgaWYgKHNlbGYgIT09ICQodGhpcykudmlldyh7aGVscGVyOiBmYWxzZX0pKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgICBpZiAodGhpcy50eXBlICE9PSAnYnV0dG9uJyAmJiB0aGlzLnR5cGUgIT09ICdjYW5jZWwnICYmIHRoaXMudHlwZSAhPT0gJ3N1Ym1pdCcgJiYgdGhpcy5uYW1lICYmIHRoaXMubmFtZSAhPT0gJycpIHsKICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0IHx8IHRoaXMsIGksIHRoaXMpOwogICAgICArK2k7CiAgICB9CiAgfSk7Cn0KCi8vY2FsbHMgYSBjYWxsYmFjayB3aXRoIHRoZSBjb3JyZWN0IG9iamVjdCBmcmFnbWVudCBhbmQga2V5IGZyb20gYSBjb21wb3VuZCBuYW1lCmZ1bmN0aW9uIG9iamVjdEFuZEtleUZyb21BdHRyaWJ1dGVzQW5kTmFtZShhdHRyaWJ1dGVzLCBuYW1lLCBvcHRpb25zLCBjYWxsYmFjaykgewogIHZhciBrZXksCiAgICAgIG9iamVjdCA9IGF0dHJpYnV0ZXMsCiAgICAgIGtleXMgPSBuYW1lLnNwbGl0KCdbJyksCiAgICAgIG1vZGUgPSBvcHRpb25zLm1vZGU7CgogIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGggLSAxOyArK2kpIHsKICAgIGtleSA9IGtleXNbaV0ucmVwbGFjZSgnXScsICcnKTsKICAgIGlmICghb2JqZWN0W2tleV0pIHsKICAgICAgaWYgKG1vZGUgPT09ICdzZXJpYWxpemUnKSB7CiAgICAgICAgb2JqZWN0W2tleV0gPSB7fTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2suY2FsbCh0aGlzLCBmYWxzZSwga2V5KTsKICAgICAgfQogICAgfQogICAgb2JqZWN0ID0gb2JqZWN0W2tleV07CiAgfQogIGtleSA9IGtleXNba2V5cy5sZW5ndGggLSAxXS5yZXBsYWNlKCddJywgJycpOwogIGNhbGxiYWNrLmNhbGwodGhpcywgb2JqZWN0LCBrZXkpOwp9CgpmdW5jdGlvbiByZXNldFN1Ym1pdFN0YXRlKCkgewogIHRoaXMuJCgnZm9ybScpLnJlbW92ZUF0dHIoJ2RhdGEtc3VibWl0LXdhaXQnKTsKfQoKOzsKdmFyIGxheW91dENpZEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1sYXlvdXQtY2lkJzsKClRob3JheC5MYXlvdXRWaWV3ID0gVGhvcmF4LlZpZXcuZXh0ZW5kKHsKICByZW5kZXI6IGZ1bmN0aW9uKG91dHB1dCkgewogICAgLy9UT0RPOiBmaXhtZSwgbHVtYmFyIGluc2VydHMgdGVtcGxhdGVzIGFmdGVyIEpTLCBtb3N0IG9mIHRoZSB0aW1lIHRoaXMgaXMgZmluZQogICAgLy9idXQgQXBwbGljYXRpb24gd2lsbCBiZSBjcmVhdGVkIGluIGluaXQuanMgKHVubGlrZSBtb3N0IHZpZXdzKQogICAgLy9zbyBuZWVkIHRvIHB1dCB0aGlzIGhlcmUgc28gdGhlIHRlbXBsYXRlIHdpbGwgYmUgcGlja2VkIHVwCiAgICB2YXIgbGF5b3V0VGVtcGxhdGU7CiAgICBpZiAodGhpcy5uYW1lKSB7CiAgICAgIGxheW91dFRlbXBsYXRlID0gVGhvcmF4LlV0aWwuZ2V0VGVtcGxhdGUodGhpcy5uYW1lLCB0cnVlKTsKICAgIH0KICAgIC8vYSB0ZW1wbGF0ZSBpcyBvcHRpb25hbCBpbiBhIGxheW91dAogICAgaWYgKG91dHB1dCB8fCB0aGlzLnRlbXBsYXRlIHx8IGxheW91dFRlbXBsYXRlKSB7CiAgICAgIC8vYnV0IGlmIHByZXNlbnQsIGl0IG11c3QgaGF2ZSBlbWJlZGRlZCBhbiBlbGVtZW50IGNvbnRhaW5pbmcgbGF5b3V0Q2lkQXR0cmlidXRlTmFtZSAKICAgICAgdmFyIHJlc3BvbnNlID0gVGhvcmF4LlZpZXcucHJvdG90eXBlLnJlbmRlci5jYWxsKHRoaXMsIG91dHB1dCB8fCB0aGlzLnRlbXBsYXRlIHx8IGxheW91dFRlbXBsYXRlKTsKICAgICAgZW5zdXJlTGF5b3V0Vmlld3NUYXJnZXRFbGVtZW50LmNhbGwodGhpcyk7CiAgICAgIHJldHVybiByZXNwb25zZTsKICAgIH0gZWxzZSB7CiAgICAgIGVuc3VyZUxheW91dENpZC5jYWxsKHRoaXMpOwogICAgfQogIH0sCiAgc2V0VmlldzogZnVuY3Rpb24odmlldywgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHsKICAgICAgc2Nyb2xsOiB0cnVlLAogICAgICBkZXN0cm95OiB0cnVlCiAgICB9LCBvcHRpb25zIHx8IHt9KTsKICAgIGlmICh0eXBlb2YgdmlldyA9PT0gJ3N0cmluZycpIHsKICAgICAgdmlldyA9IG5ldyAoVGhvcmF4LlV0aWwucmVnaXN0cnlHZXQoVGhvcmF4LCAnVmlld3MnLCB2aWV3LCBmYWxzZSkpKCk7CiAgICB9CiAgICB0aGlzLmVuc3VyZVJlbmRlcmVkKCk7CiAgICB2YXIgb2xkVmlldyA9IHRoaXMuX3ZpZXc7CiAgICBpZiAodmlldyA9PT0gb2xkVmlldykgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBpZiAob3B0aW9ucy5kZXN0cm95ICYmIHZpZXcpIHsKICAgICAgdmlldy5fc2hvdWxkRGVzdHJveU9uTmV4dFNldFZpZXcgPSB0cnVlOwogICAgfQoKICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOnZpZXc6c3RhcnQnLCB2aWV3LCBvbGRWaWV3LCBvcHRpb25zKTsKCiAgICBpZiAob2xkVmlldykgewogICAgICB0aGlzLl9yZW1vdmVDaGlsZChvbGRWaWV3KTsKICAgICAgb2xkVmlldy4kZWwucmVtb3ZlKCk7CiAgICAgIG9sZFZpZXcudHJpZ2dlcignZGVhY3RpdmF0ZWQnLCBvcHRpb25zKTsKICAgICAgaWYgKG9sZFZpZXcuX3Nob3VsZERlc3Ryb3lPbk5leHRTZXRWaWV3KSB7CiAgICAgICAgb2xkVmlldy5kZXN0cm95KCk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAodmlldykgewogICAgICB2aWV3LnRyaWdnZXIoJ2FjdGl2YXRlZCcsIG9wdGlvbnMpOwogICAgICB0aGlzLl9hZGRDaGlsZCh2aWV3KTsKICAgICAgdGhpcy5fdmlldyA9IHZpZXc7CiAgICAgIHRoaXMuX3ZpZXcuYXBwZW5kVG8oZ2V0TGF5b3V0Vmlld3NUYXJnZXRFbGVtZW50LmNhbGwodGhpcykpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fdmlldyA9IHVuZGVmaW5lZDsKICAgIH0KCiAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTp2aWV3OmVuZCcsIHZpZXcsIG9sZFZpZXcsIG9wdGlvbnMpOwogICAgcmV0dXJuIHZpZXc7CiAgfSwKCiAgZ2V0VmlldzogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fdmlldzsKICB9Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignbGF5b3V0JywgZnVuY3Rpb24ob3B0aW9ucykgewogIG9wdGlvbnMuaGFzaFtsYXlvdXRDaWRBdHRyaWJ1dGVOYW1lXSA9IGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXcuY2lkOwogIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZy5jYWxsKHRoaXMsIG9wdGlvbnMuaGFzaCwgJycsIHRoaXMpKTsKfSk7CgpmdW5jdGlvbiBlbnN1cmVMYXlvdXRDaWQoKSB7CiAgKyt0aGlzLl9yZW5kZXJDb3VudDsKICAvL3NldCB0aGUgbGF5b3V0Q2lkQXR0cmlidXRlTmFtZSBvbiB0aGlzLiRlbCBpZiB0aGVyZSB3YXMgbm8gdGVtcGxhdGUKICB0aGlzLiRlbC5hdHRyKGxheW91dENpZEF0dHJpYnV0ZU5hbWUsIHRoaXMuY2lkKTsKfQoKZnVuY3Rpb24gZW5zdXJlTGF5b3V0Vmlld3NUYXJnZXRFbGVtZW50KCkgewogIGlmICghdGhpcy4kKCdbJyArIGxheW91dENpZEF0dHJpYnV0ZU5hbWUgKyAnPSInICsgdGhpcy5jaWQgKyAnIl0nKVswXSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdObyBsYXlvdXQgZWxlbWVudCBmb3VuZCBpbiAnICsgKHRoaXMubmFtZSB8fCB0aGlzLmNpZCkpOwogIH0KfQoKZnVuY3Rpb24gZ2V0TGF5b3V0Vmlld3NUYXJnZXRFbGVtZW50KCkgewogIHJldHVybiB0aGlzLiQoJ1snICsgbGF5b3V0Q2lkQXR0cmlidXRlTmFtZSArICc9IicgKyB0aGlzLmNpZCArICciXScpWzBdIHx8IHRoaXMuZWxbMF0gfHwgdGhpcy5lbDsKfQoKOzsKLypnbG9iYWwgY3JlYXRlUmVnaXN0cnlXcmFwcGVyICovCgovL1JvdXRlcgpmdW5jdGlvbiBpbml0aWFsaXplUm91dGVyKCkgewogIEJhY2tib25lLmhpc3RvcnkgfHwgKEJhY2tib25lLmhpc3RvcnkgPSBuZXcgQmFja2JvbmUuSGlzdG9yeSgpKTsKICBCYWNrYm9uZS5oaXN0b3J5Lm9uKCdyb3V0ZScsIG9uUm91dGUsIHRoaXMpOwogIC8vcm91dGVyIGRvZXMgbm90IGhhdmUgYSBidWlsdCBpbiBkZXN0cm95IGV2ZW50CiAgLy9idXQgVmlld0NvbnRyb2xsZXIgZG9lcwogIHRoaXMub24oJ2Rlc3Ryb3llZCcsIGZ1bmN0aW9uKCkgewogICAgQmFja2JvbmUuaGlzdG9yeS5vZmYoJ3JvdXRlJywgb25Sb3V0ZSwgdGhpcyk7CiAgfSk7Cn0KClRob3JheC5Sb3V0ZXIgPSBCYWNrYm9uZS5Sb3V0ZXIuZXh0ZW5kKHsKICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oKSB7CiAgICB2YXIgcmVzcG9uc2UgPSBUaG9yYXguUm91dGVyLl9fc3VwZXJfXy5jb25zdHJ1Y3Rvci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaW5pdGlhbGl6ZVJvdXRlci5jYWxsKHRoaXMpOwogICAgcmV0dXJuIHJlc3BvbnNlOwogIH0sCiAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBuYW1lLCBjYWxsYmFjaykgewogICAgaWYgKCFjYWxsYmFjaykgewogICAgICBjYWxsYmFjayA9IHRoaXNbbmFtZV07CiAgICB9CiAgICAvL2FkZCBhIHJvdXRlOmJlZm9yZSBldmVudCB0aGF0IGlzIGZpcmVkIGJlZm9yZSB0aGUgY2FsbGJhY2sgaXMgY2FsbGVkCiAgICByZXR1cm4gQmFja2JvbmUuUm91dGVyLnByb3RvdHlwZS5yb3V0ZS5jYWxsKHRoaXMsIHJvdXRlLCBuYW1lLCBmdW5jdGlvbigpIHsKICAgICAgdGhpcy50cmlnZ2VyLmFwcGx5KHRoaXMsIFsncm91dGU6YmVmb3JlJywgcm91dGUsIG5hbWVdLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgIHJldHVybiBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSk7CiAgfQp9KTsKClRob3JheC5Sb3V0ZXJzID0ge307CmNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcihUaG9yYXguUm91dGVyLCBUaG9yYXguUm91dGVycyk7CgpmdW5jdGlvbiBvblJvdXRlKHJvdXRlciAvKiAsIG5hbWUgKi8pIHsKICBpZiAodGhpcyA9PT0gcm91dGVyKSB7CiAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgWydyb3V0ZSddLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKSk7CiAgfQp9Cgo7OwpUaG9yYXguQ29sbGVjdGlvbkhlbHBlclZpZXcgPSBUaG9yYXguSGVscGVyVmlldy5leHRlbmQoewogIC8vIEZvcndhcmQgcmVuZGVyIGV2ZW50cyB0byB0aGUgcGFyZW50CiAgZXZlbnRzOiB7CiAgICAncmVuZGVyZWQ6aXRlbSc6IGZvcndhcmRSZW5kZXJFdmVudCgncmVuZGVyZWQ6aXRlbScpLAogICAgJ3JlbmRlcmVkOmNvbGxlY3Rpb24nOiBmb3J3YXJkUmVuZGVyRXZlbnQoJ3JlbmRlcmVkOmNvbGxlY3Rpb24nKSwKICAgICdyZW5kZXJlZDplbXB0eSc6IGZvcndhcmRSZW5kZXJFdmVudCgncmVuZGVyZWQ6ZW1wdHknKQogIH0sCiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIF8uZWFjaChjb2xsZWN0aW9uT3B0aW9uTmFtZXMsIGZ1bmN0aW9uKHZpZXdBdHRyaWJ1dGVOYW1lLCBoZWxwZXJPcHRpb25OYW1lKSB7CiAgICAgIGlmIChvcHRpb25zLm9wdGlvbnNbaGVscGVyT3B0aW9uTmFtZV0pIHsKICAgICAgICB2YXIgdmFsdWUgPSBvcHRpb25zLm9wdGlvbnNbaGVscGVyT3B0aW9uTmFtZV07CiAgICAgICAgaWYgKHZpZXdBdHRyaWJ1dGVOYW1lID09PSAnaXRlbVRlbXBsYXRlJyB8fCB2aWV3QXR0cmlidXRlTmFtZSA9PT0gJ2VtcHR5VGVtcGxhdGUnKSB7CiAgICAgICAgICB2YWx1ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgb3B0aW9uc1t2aWV3QXR0cmlidXRlTmFtZV0gPSB2YWx1ZTsKICAgICAgfQogICAgfSk7CiAgICAvLyBIYW5kbGViYXJzLlZNLm5vb3AgaXMgcGFzc2VkIGluIHRoZSBoYW5kbGViYXJzIG9wdGlvbnMgb2JqZWN0IGFzCiAgICAvLyBhIGRlZmF1bHQgZm9yIGZuIGFuZCBpbnZlcnNlLCBpZiBhIGJsb2NrIHdhcyBwcmVzZW50LiBOZWVkIHRvCiAgICAvLyBjaGVjayB0byBlbnN1cmUgd2UgZG9uJ3QgcGljayB0aGUgZW1wdHkgLyBudWxsIGJsb2NrIHVwLgogICAgaWYgKCFvcHRpb25zLml0ZW1UZW1wbGF0ZSAmJiBvcHRpb25zLnRlbXBsYXRlICYmIG9wdGlvbnMudGVtcGxhdGUgIT09IEhhbmRsZWJhcnMuVk0ubm9vcCkgewogICAgICBvcHRpb25zLml0ZW1UZW1wbGF0ZSA9IG9wdGlvbnMudGVtcGxhdGU7CiAgICAgIG9wdGlvbnMudGVtcGxhdGUgPSBIYW5kbGViYXJzLlZNLm5vb3A7CiAgICB9CiAgICBpZiAoIW9wdGlvbnMuZW1wdHlUZW1wbGF0ZSAmJiBvcHRpb25zLmludmVyc2UgJiYgb3B0aW9ucy5pbnZlcnNlICE9PSBIYW5kbGViYXJzLlZNLm5vb3ApIHsKICAgICAgb3B0aW9ucy5lbXB0eVRlbXBsYXRlID0gb3B0aW9ucy5pbnZlcnNlOwogICAgICBvcHRpb25zLmludmVyc2UgPSBIYW5kbGViYXJzLlZNLm5vb3A7CiAgICB9CiAgICAhb3B0aW9ucy50ZW1wbGF0ZSAmJiAob3B0aW9ucy50ZW1wbGF0ZSA9IEhhbmRsZWJhcnMuVk0ubm9vcCk7CiAgICB2YXIgcmVzcG9uc2UgPSBUaG9yYXguSGVscGVyVmlldy5jYWxsKHRoaXMsIG9wdGlvbnMpOwogICAgaWYgKHRoaXMucGFyZW50Lm5hbWUpIHsKICAgICAgaWYgKCF0aGlzLmVtcHR5VGVtcGxhdGUpIHsKICAgICAgICB0aGlzLmVtcHR5VGVtcGxhdGUgPSBUaG9yYXguVXRpbC5nZXRUZW1wbGF0ZSh0aGlzLnBhcmVudC5uYW1lICsgJy1lbXB0eScsIHRydWUpOwogICAgICB9CiAgICAgIGlmICghdGhpcy5pdGVtVGVtcGxhdGUpIHsKICAgICAgICB0aGlzLml0ZW1UZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRoaXMucGFyZW50Lm5hbWUgKyAnLWl0ZW0nLCB0cnVlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3BvbnNlOwogIH0sCiAgaXRlbUNvbnRleHQ6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMucGFyZW50Lml0ZW1Db250ZXh0LmFwcGx5KHRoaXMucGFyZW50LCBhcmd1bWVudHMpOwogIH0sCiAgc2V0QXNQcmltYXJ5Q29sbGVjdGlvbkhlbHBlcjogZnVuY3Rpb24oY29sbGVjdGlvbikgewogICAgdGhpcy4kZWwuYXR0cihwcmltYXJ5Q29sbGVjdGlvbkF0dHJpYnV0ZU5hbWUsIGNvbGxlY3Rpb24uY2lkKTsKICAgIF8uZWFjaChmb3J3YXJkYWJsZVByb3BlcnRpZXMsIGZ1bmN0aW9uKHByb3BlcnR5TmFtZSkgewogICAgICBmb3J3YXJkTWlzc2luZ1Byb3BlcnR5LmNhbGwodGhpcywgcHJvcGVydHlOYW1lKTsKICAgIH0sIHRoaXMpOwogICAgaWYgKHRoaXMucGFyZW50Lml0ZW1GaWx0ZXIpIHsKICAgICAgdGhpcy5pdGVtRmlsdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucGFyZW50Lml0ZW1GaWx0ZXIuYXBwbHkodGhpcy5wYXJlbnQsIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICB9CiAgfQp9KTsKCnZhciBjb2xsZWN0aW9uT3B0aW9uTmFtZXMgPSB7CiAgJ2l0ZW0tdGVtcGxhdGUnOiAnaXRlbVRlbXBsYXRlJywKICAnZW1wdHktdGVtcGxhdGUnOiAnZW1wdHlUZW1wbGF0ZScsCiAgJ2l0ZW0tdmlldyc6ICdpdGVtVmlldycsCiAgJ2VtcHR5LXZpZXcnOiAnZW1wdHlWaWV3JywKICAnZW1wdHktY2xhc3MnOiAnZW1wdHlDbGFzcycKfTsKCmZ1bmN0aW9uIGZvcndhcmRSZW5kZXJFdmVudChldmVudE5hbWUpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB2YXIgYXJncyA9IF8udG9BcnJheShhcmd1bWVudHMpOwogICAgYXJncy51bnNoaWZ0KGV2ZW50TmFtZSk7CiAgICB0aGlzLnBhcmVudC50cmlnZ2VyLmFwcGx5KHRoaXMucGFyZW50LCBhcmdzKTsKICB9Cn0KCnZhciBmb3J3YXJkYWJsZVByb3BlcnRpZXMgPSBbCiAgJ2l0ZW1UZW1wbGF0ZScsCiAgJ2l0ZW1WaWV3JywKICAnZW1wdHlUZW1wbGF0ZScsCiAgJ2VtcHR5VmlldycKXTsKCmZ1bmN0aW9uIGZvcndhcmRNaXNzaW5nUHJvcGVydHkocHJvcGVydHlOYW1lKSB7CiAgdmFyIHBhcmVudCA9IGdldFBhcmVudCh0aGlzKTsKICBpZiAoIXRoaXNbcHJvcGVydHlOYW1lXSkgewogICAgdmFyIHByb3AgPSBwYXJlbnRbcHJvcGVydHlOYW1lXTsKICAgIGlmIChwcm9wKXsKICAgICAgdGhpc1twcm9wZXJ0eU5hbWVdID0gcHJvcDsKICAgIH0KICB9Cn0KCkhhbmRsZWJhcnMucmVnaXN0ZXJWaWV3SGVscGVyKCdjb2xsZWN0aW9uJywgVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3LCBmdW5jdGlvbihjb2xsZWN0aW9uLCB2aWV3KSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgIHZpZXcgPSBjb2xsZWN0aW9uOwogICAgY29sbGVjdGlvbiA9IHZpZXcuZGVjbGFyaW5nVmlldy5jb2xsZWN0aW9uOwogIH0KICAvLyBOZWVkIGFkZGl0aW9uYWwgY2hlY2sgaGVyZSB0byBzZWUgaWYgaXQgaXMgdGhlCiAgLy8gcHJpbWFyeSBjb2xsZWN0aW9uIGFzIHRlbXBsYXRlcyBjYW4gZG86CiAgLy8gI2NvbGxlY3Rpb24gdGhpcy5jb2xsZWN0aW9uCiAgaWYgKGNvbGxlY3Rpb24gJiYgY29sbGVjdGlvbiA9PT0gdmlldy5kZWNsYXJpbmdWaWV3LmNvbGxlY3Rpb24pIHsKICAgIGVuc3VyZURhdGFPYmplY3RDaWQoJ2NvbGxlY3Rpb24nLCBjb2xsZWN0aW9uKTsKICAgIHZpZXcuc2V0QXNQcmltYXJ5Q29sbGVjdGlvbkhlbHBlcihjb2xsZWN0aW9uKTsKICB9CiAgLy8gTWFyayBwcmltYXJ5IGNvbGxlY3Rpb24gZWxlbWVudCB3aXRoIGNvbGxlY3Rpb24gZWxlbWVudCBhdHRyaWJ1dGUgc28gdGhhdAogIC8vIGl0IGNhbiBiZSBmb3VuZCBieSBnZXRDb2xsZWN0aW9uRWxlbWVudCBtZXRob2QKICAvLyBUaGlzIHdpbGwgZXhlY3V0ZSBpZiBib3RoIGNvbGxlY3Rpb24gYW5kIHRoZSBkZWxjYXJpbmcgdmlldydzIGNvbGxlY3Rpb24KICAvLyBhcmUgbnVsbCBpbiBjYXNlcyB3aGVyZSB7e2NvbGxlY3Rpb259fSB3YXMgZGVjbGFyZWQgaW4gYSB2aWV3IGFuZAogIC8vIHNldENvbGxlY3Rpb24gaGFzIG5vdCB5ZXQgYmVlbiBjYWxsZWQKICBpZiAoY29sbGVjdGlvbiA9PT0gdmlldy5kZWNsYXJpbmdWaWV3LmNvbGxlY3Rpb24pIHsKICAgIHZpZXcuJGVsLmF0dHIoY29sbGVjdGlvbkVsZW1lbnRBdHRyaWJ1dGVOYW1lLCAndHJ1ZScpOwogIH0KICBjb2xsZWN0aW9uICYmIHZpZXcuc2V0Q29sbGVjdGlvbihjb2xsZWN0aW9uKTsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdjb2xsZWN0aW9uLWVsZW1lbnQnLCBmdW5jdGlvbihvcHRpb25zKSB7CiAgb3B0aW9ucy5oYXNoLnRhZyA9IG9wdGlvbnMuaGFzaC50YWcgfHwgb3B0aW9ucy5oYXNoLnRhZ05hbWUgfHwgJ2Rpdic7CiAgb3B0aW9ucy5oYXNoW2NvbGxlY3Rpb25FbGVtZW50QXR0cmlidXRlTmFtZV0gPSB0cnVlOwogIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZy5jYWxsKHRoaXMsIG9wdGlvbnMuaGFzaCwgJycsIHRoaXMpKTsKfSk7Cgo7OwpIYW5kbGViYXJzLnJlZ2lzdGVyVmlld0hlbHBlcignZW1wdHknLCBmdW5jdGlvbihjb2xsZWN0aW9uLCB2aWV3KSB7CiAgdmFyIGVtcHR5LCBub0FyZ3VtZW50OwogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICB2aWV3ID0gY29sbGVjdGlvbjsKICAgIGNvbGxlY3Rpb24gPSBmYWxzZTsKICAgIG5vQXJndW1lbnQgPSB0cnVlOwogIH0KCiAgdmFyIF9yZW5kZXIgPSB2aWV3LnJlbmRlcjsKICB2aWV3LnJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgaWYgKG5vQXJndW1lbnQpIHsKICAgICAgZW1wdHkgPSAhdGhpcy5wYXJlbnQubW9kZWwgfHwgdGhpcy5wYXJlbnQubW9kZWwuaXNFbXB0eSgpOwogICAgfSBlbHNlIHsKICAgICAgZW1wdHkgPSAhY29sbGVjdGlvbiB8fCBjb2xsZWN0aW9uLmlzRW1wdHkoKTsKICAgIH0KICAgIGlmIChlbXB0eSkgewogICAgICB0aGlzLnBhcmVudC50cmlnZ2VyKCdyZW5kZXJlZDplbXB0eScsIHRoaXMsIGNvbGxlY3Rpb24pOwogICAgICByZXR1cm4gX3JlbmRlci5jYWxsKHRoaXMsIHRoaXMudGVtcGxhdGUpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIF9yZW5kZXIuY2FsbCh0aGlzLCB0aGlzLmludmVyc2UpOwogICAgfQogIH07CgogIHZhciByZW5kZXIgPSBfLmJpbmQodmlldy5yZW5kZXIsIHZpZXcpOwoKICBpZiAobm9Bcmd1bWVudCkgewogICAgdmlldy5saXN0ZW5Ubyh2aWV3LnBhcmVudCwgJ2NoYW5nZTpkYXRhLW9iamVjdCcsIGZ1bmN0aW9uKHR5cGUsIG9iamVjdCwgb2xkKSB7CiAgICAgIGlmICh0eXBlID09PSAnbW9kZWwnKSB7CiAgICAgICAgaWYgKG9sZCkgewogICAgICAgICAgdmlldy5zdG9wTGlzdGVuaW5nKG9sZCk7CiAgICAgICAgfQogICAgICAgIGlmIChvYmplY3QpIHsKICAgICAgICAgIHZpZXcubGlzdGVuVG8ob2JqZWN0LCAnY2hhbmdlJywgcmVuZGVyKTsKICAgICAgICB9CiAgICAgICAgcmVuZGVyKCk7CiAgICAgIH0KICAgIH0pOwogICAgaWYgKHZpZXcucGFyZW50Lm1vZGVsKSB7CiAgICAgIHZpZXcubGlzdGVuVG8odmlldy5wYXJlbnQubW9kZWwsICdjaGFuZ2UnLCByZW5kZXIpOwogICAgfQogIH0gZWxzZSBpZiAoY29sbGVjdGlvbikgewogICAgdmlldy5saXN0ZW5Ubyhjb2xsZWN0aW9uLCAncmVtb3ZlJywgZnVuY3Rpb24oKSB7CiAgICAgIGlmIChjb2xsZWN0aW9uLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJlbmRlcigpOwogICAgICB9CiAgICB9KTsKICAgIHZpZXcubGlzdGVuVG8oY29sbGVjdGlvbiwgJ2FkZCcsIGZ1bmN0aW9uKCkgewogICAgICBpZiAoY29sbGVjdGlvbi5sZW5ndGggPT09IDEpIHsKICAgICAgICByZW5kZXIoKTsKICAgICAgfQogICAgfSk7CiAgICB2aWV3Lmxpc3RlblRvKGNvbGxlY3Rpb24sICdyZXNldCcsIHJlbmRlcik7CiAgfQoKICByZW5kZXIoKTsKfSk7Cgo7OwpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd0ZW1wbGF0ZScsIGZ1bmN0aW9uKG5hbWUsIG9wdGlvbnMpIHsKICB2YXIgY29udGV4dCA9IF8uZXh0ZW5kKHtmbjogb3B0aW9ucyAmJiBvcHRpb25zLmZufSwgdGhpcywgb3B0aW9ucyA/IG9wdGlvbnMuaGFzaCA6IHt9KTsKICB2YXIgb3V0cHV0ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldy5yZW5kZXJUZW1wbGF0ZShuYW1lLCBjb250ZXh0KTsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhvdXRwdXQpOwp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3lpZWxkJywgZnVuY3Rpb24ob3B0aW9ucykgewogIHJldHVybiBnZXRPcHRpb25zRGF0YShvcHRpb25zKS55aWVsZCAmJiBvcHRpb25zLmRhdGEueWllbGQoKTsKfSk7Cgo7OwpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd1cmwnLCBmdW5jdGlvbih1cmwpIHsKICB2YXIgZnJhZ21lbnQ7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAyKSB7CiAgICBmcmFnbWVudCA9IF8ubWFwKF8uaGVhZChhcmd1bWVudHMsIGFyZ3VtZW50cy5sZW5ndGggLSAxKSwgZW5jb2RlVVJJQ29tcG9uZW50KS5qb2luKCcvJyk7CiAgfSBlbHNlIHsKICAgIHZhciBvcHRpb25zID0gYXJndW1lbnRzWzFdLAogICAgICAgIGhhc2ggPSAob3B0aW9ucyAmJiBvcHRpb25zLmhhc2gpIHx8IG9wdGlvbnM7CiAgICBpZiAoaGFzaCAmJiBoYXNoWydleHBhbmQtdG9rZW5zJ10pIHsKICAgICAgZnJhZ21lbnQgPSBUaG9yYXguVXRpbC5leHBhbmRUb2tlbih1cmwsIHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgZnJhZ21lbnQgPSB1cmw7CiAgICB9CiAgfQogIHJldHVybiAoQmFja2JvbmUuaGlzdG9yeS5faGFzUHVzaFN0YXRlID8gQmFja2JvbmUuaGlzdG9yeS5vcHRpb25zLnJvb3QgOiAnIycpICsgZnJhZ21lbnQ7Cn0pOwoKOzsKLypnbG9iYWwgdmlld1RlbXBsYXRlT3ZlcnJpZGVzICovCkhhbmRsZWJhcnMucmVnaXN0ZXJWaWV3SGVscGVyKCd2aWV3JywgewogIGZhY3Rvcnk6IGZ1bmN0aW9uKGFyZ3MsIG9wdGlvbnMpIHsKICAgIHZhciBWaWV3ID0gYXJncy5sZW5ndGggPj0gMSA/IGFyZ3NbMF0gOiBUaG9yYXguVmlldzsKICAgIHJldHVybiBUaG9yYXguVXRpbC5nZXRWaWV3SW5zdGFuY2UoVmlldywgb3B0aW9ucy5vcHRpb25zKTsKICB9LAogIGNhbGxiYWNrOiBmdW5jdGlvbigpIHsKICAgIHZhciBpbnN0YW5jZSA9IGFyZ3VtZW50c1thcmd1bWVudHMubGVuZ3RoLTFdLAogICAgICAgIG9wdGlvbnMgPSBpbnN0YW5jZS5faGVscGVyT3B0aW9ucy5vcHRpb25zLAogICAgICAgIHBsYWNlaG9sZGVySWQgPSBpbnN0YW5jZS5jaWQ7CgogICAgaWYgKG9wdGlvbnMuZm4pIHsKICAgICAgdmlld1RlbXBsYXRlT3ZlcnJpZGVzW3BsYWNlaG9sZGVySWRdID0gb3B0aW9ucy5mbjsKICAgIH0KICB9Cn0pOwoKOzsKdmFyIGNhbGxNZXRob2RBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtY2FsbC1tZXRob2QnLAogICAgdHJpZ2dlckV2ZW50QXR0cmlidXRlTmFtZSA9ICdkYXRhLXRyaWdnZXItZXZlbnQnOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignYnV0dG9uJywgZnVuY3Rpb24obWV0aG9kLCBvcHRpb25zKSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgIG9wdGlvbnMgPSBtZXRob2Q7CiAgICBtZXRob2QgPSBvcHRpb25zLmhhc2gubWV0aG9kOwogIH0KICB2YXIgaGFzaCA9IG9wdGlvbnMuaGFzaCwKICAgICAgZXhwYW5kVG9rZW5zID0gaGFzaFsnZXhwYW5kLXRva2VucyddOwogIGRlbGV0ZSBoYXNoWydleHBhbmQtdG9rZW5zJ107CiAgaWYgKCFtZXRob2QgJiYgIW9wdGlvbnMuaGFzaC50cmlnZ2VyKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoImJ1dHRvbiBoZWxwZXIgbXVzdCBoYXZlIGEgbWV0aG9kIG5hbWUgYXMgdGhlIGZpcnN0IGFyZ3VtZW50IG9yIGEgJ3RyaWdnZXInLCBvciBhICdtZXRob2QnIGF0dHJpYnV0ZSBzcGVjaWZpZWQuIik7CiAgfQogIGhhc2gudGFnID0gaGFzaC50YWcgfHwgaGFzaC50YWdOYW1lIHx8ICdidXR0b24nOwogIGhhc2gudHJpZ2dlciAmJiAoaGFzaFt0cmlnZ2VyRXZlbnRBdHRyaWJ1dGVOYW1lXSA9IGhhc2gudHJpZ2dlcik7CiAgZGVsZXRlIGhhc2gudHJpZ2dlcjsKICBtZXRob2QgJiYgKGhhc2hbY2FsbE1ldGhvZEF0dHJpYnV0ZU5hbWVdID0gbWV0aG9kKTsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhUaG9yYXguVXRpbC50YWcoaGFzaCwgb3B0aW9ucy5mbiA/IG9wdGlvbnMuZm4odGhpcykgOiAnJywgZXhwYW5kVG9rZW5zID8gdGhpcyA6IG51bGwpKTsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdsaW5rJywgZnVuY3Rpb24oKSB7CiAgdmFyIGFyZ3MgPSBfLnRvQXJyYXkoYXJndW1lbnRzKSwKICAgICAgb3B0aW9ucyA9IGFyZ3MucG9wKCksCiAgICAgIGhhc2ggPSBvcHRpb25zLmhhc2gsCiAgICAgIC8vIHVybCBpcyBhbiBhcnJheSB0aGF0IHdpbGwgYmUgcGFzc2VkIHRvIHRoZSB1cmwgaGVscGVyCiAgICAgIHVybCA9IGFyZ3MubGVuZ3RoID09PSAwID8gW2hhc2guaHJlZl0gOiBhcmdzLAogICAgICBleHBhbmRUb2tlbnMgPSBoYXNoWydleHBhbmQtdG9rZW5zJ107CiAgZGVsZXRlIGhhc2hbJ2V4cGFuZC10b2tlbnMnXTsKICBpZiAoIXVybFswXSkgewogICAgdGhyb3cgbmV3IEVycm9yKCJsaW5rIGhlbHBlciByZXF1aXJlcyBhbiBocmVmIGFzIHRoZSBmaXJzdCBhcmd1bWVudCBvciBhbiAnaHJlZicgYXR0cmlidXRlIik7CiAgfQogIHVybC5wdXNoKG9wdGlvbnMpOwogIGhhc2guaHJlZiA9IEhhbmRsZWJhcnMuaGVscGVycy51cmwuYXBwbHkodGhpcywgdXJsKTsKICBoYXNoLnRhZyA9IGhhc2gudGFnIHx8IGhhc2gudGFnTmFtZSB8fCAnYSc7CiAgaGFzaC50cmlnZ2VyICYmIChoYXNoW3RyaWdnZXJFdmVudEF0dHJpYnV0ZU5hbWVdID0gb3B0aW9ucy5oYXNoLnRyaWdnZXIpOwogIGRlbGV0ZSBoYXNoLnRyaWdnZXI7CiAgaGFzaFtjYWxsTWV0aG9kQXR0cmlidXRlTmFtZV0gPSAnX2FuY2hvckNsaWNrJzsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhUaG9yYXguVXRpbC50YWcoaGFzaCwgb3B0aW9ucy5mbiA/IG9wdGlvbnMuZm4odGhpcykgOiAnJywgZXhwYW5kVG9rZW5zID8gdGhpcyA6IG51bGwpKTsKfSk7Cgp2YXIgY2xpY2tTZWxlY3RvciA9ICdbJyArIGNhbGxNZXRob2RBdHRyaWJ1dGVOYW1lICsgJ10sIFsnICsgdHJpZ2dlckV2ZW50QXR0cmlidXRlTmFtZSArICddJzsKCmZ1bmN0aW9uIGhhbmRsZUNsaWNrKGV2ZW50KSB7CiAgdmFyIHRhcmdldCA9ICQoZXZlbnQudGFyZ2V0KSwKICAgICAgdmlldyA9IHRhcmdldC52aWV3KHtoZWxwZXI6IGZhbHNlfSksCiAgICAgIG1ldGhvZE5hbWUgPSB0YXJnZXQuYXR0cihjYWxsTWV0aG9kQXR0cmlidXRlTmFtZSksCiAgICAgIGV2ZW50TmFtZSA9IHRhcmdldC5hdHRyKHRyaWdnZXJFdmVudEF0dHJpYnV0ZU5hbWUpLAogICAgICBtZXRob2RSZXNwb25zZSA9IGZhbHNlOwogIG1ldGhvZE5hbWUgJiYgKG1ldGhvZFJlc3BvbnNlID0gdmlld1ttZXRob2ROYW1lXS5jYWxsKHZpZXcsIGV2ZW50KSk7CiAgZXZlbnROYW1lICYmIHZpZXcudHJpZ2dlcihldmVudE5hbWUsIGV2ZW50KTsKICB0YXJnZXQudGFnTmFtZSA9PT0gIkEiICYmIG1ldGhvZFJlc3BvbnNlID09PSBmYWxzZSAmJiBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwp9Cgp2YXIgbGFzdENsaWNrSGFuZGxlckV2ZW50TmFtZTsKCmZ1bmN0aW9uIHJlZ2lzdGVyQ2xpY2tIYW5kbGVyKCkgewogIHVucmVnaXN0ZXJDbGlja0hhbmRsZXIoKTsKICBsYXN0Q2xpY2tIYW5kbGVyRXZlbnROYW1lID0gVGhvcmF4Ll9mYXN0Q2xpY2tFdmVudE5hbWUgfHwgJ2NsaWNrJzsKICAkKGRvY3VtZW50KS5vbihsYXN0Q2xpY2tIYW5kbGVyRXZlbnROYW1lLCBjbGlja1NlbGVjdG9yLCBoYW5kbGVDbGljayk7Cn0KCmZ1bmN0aW9uIHVucmVnaXN0ZXJDbGlja0hhbmRsZXIoKSB7CiAgbGFzdENsaWNrSGFuZGxlckV2ZW50TmFtZSAmJiAkKGRvY3VtZW50KS5vZmYobGFzdENsaWNrSGFuZGxlckV2ZW50TmFtZSwgY2xpY2tTZWxlY3RvciwgaGFuZGxlQ2xpY2spOwp9CgokKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpIHsKICBpZiAoIVRob3JheC5fZmFzdENsaWNrRXZlbnROYW1lKSB7CiAgICByZWdpc3RlckNsaWNrSGFuZGxlcigpOwogIH0KfSk7Cgo7Owp2YXIgZWxlbWVudFBsYWNlaG9sZGVyQXR0cmlidXRlTmFtZSA9ICdkYXRhLWVsZW1lbnQtdG1wJzsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2VsZW1lbnQnLCBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKSB7CiAgdmFyIGNpZCA9IF8udW5pcXVlSWQoJ2VsZW1lbnQnKSwKICAgICAgZGVjbGFyaW5nVmlldyA9IGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXcsCiAgICAgIGh0bWxBdHRyaWJ1dGVzID0gVGhvcmF4LlV0aWwuaHRtbEF0dHJpYnV0ZXNGcm9tT3B0aW9ucyhvcHRpb25zLmhhc2gpOwogIGh0bWxBdHRyaWJ1dGVzW2VsZW1lbnRQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWVdID0gY2lkOwogIGRlY2xhcmluZ1ZpZXcuX2VsZW1lbnRzQnlDaWQgfHwgKGRlY2xhcmluZ1ZpZXcuX2VsZW1lbnRzQnlDaWQgPSB7fSk7CiAgZGVjbGFyaW5nVmlldy5fZWxlbWVudHNCeUNpZFtjaWRdID0gZWxlbWVudDsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhUaG9yYXguVXRpbC50YWcoaHRtbEF0dHJpYnV0ZXMpKTsKfSk7CgpUaG9yYXguVmlldy5vbignYXBwZW5kJywgZnVuY3Rpb24oc2NvcGUsIGNhbGxiYWNrKSB7CiAgKHNjb3BlIHx8IHRoaXMuJGVsKS5maW5kKCdbJyArIGVsZW1lbnRQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWUgKyAnXScpLmZvckVhY2goZnVuY3Rpb24oZWwpIHsKICAgIHZhciAkZWwgPSAkKGVsKSwKICAgICAgICBjaWQgPSAkZWwuYXR0cihlbGVtZW50UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lKSwKICAgICAgICBlbGVtZW50ID0gdGhpcy5fZWxlbWVudHNCeUNpZFtjaWRdOwogICAgLy8gQSBjYWxsYmFjayBmdW5jdGlvbiBtYXkgYmUgc3BlY2lmaWVkIGFzIHRoZSB2YWx1ZQogICAgaWYgKF8uaXNGdW5jdGlvbihlbGVtZW50KSkgewogICAgICBlbGVtZW50ID0gZWxlbWVudC5jYWxsKHRoaXMpOwogICAgfQogICAgJGVsLnJlcGxhY2VXaXRoKGVsZW1lbnQpOwogICAgY2FsbGJhY2sgJiYgY2FsbGJhY2soZWxlbWVudCk7CiAgfSwgdGhpcyk7Cn0pOwoKOzsKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignc3VwZXInLCBmdW5jdGlvbihvcHRpb25zKSB7CiAgdmFyIGRlY2xhcmluZ1ZpZXcgPSBnZXRPcHRpb25zRGF0YShvcHRpb25zKS52aWV3LAogICAgICBwYXJlbnQgPSBkZWNsYXJpbmdWaWV3LmNvbnN0cnVjdG9yICYmIGRlY2xhcmluZ1ZpZXcuY29uc3RydWN0b3IuX19zdXBlcl9fOwogIGlmIChwYXJlbnQpIHsKICAgIHZhciB0ZW1wbGF0ZSA9IHBhcmVudC50ZW1wbGF0ZTsKICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgaWYgKCFwYXJlbnQubmFtZSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHVzZSBzdXBlciBoZWxwZXIgd2hlbiBwYXJlbnQgaGFzIG5vIG5hbWUgb3IgdGVtcGxhdGUuJyk7CiAgICAgIH0KICAgICAgdGVtcGxhdGUgPSBUaG9yYXguVXRpbC5nZXRUZW1wbGF0ZShwYXJlbnQubmFtZSwgZmFsc2UpOwogICAgfQogICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgdGVtcGxhdGUgPSBIYW5kbGViYXJzLmNvbXBpbGUodGVtcGxhdGUsIHtkYXRhOiB0cnVlfSk7CiAgICB9CiAgICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyh0ZW1wbGF0ZSh0aGlzLCBvcHRpb25zKSk7CiAgfSBlbHNlIHsKICAgIHJldHVybiAnJzsKICB9Cn0pOwoKOzsKLypnbG9iYWwgY29sbGVjdGlvbk9wdGlvbk5hbWVzLCBpbmhlcml0VmFycyAqLwoKdmFyIGxvYWRTdGFydCA9ICdsb2FkOnN0YXJ0JywKICAgIGxvYWRFbmQgPSAnbG9hZDplbmQnLAogICAgcm9vdE9iamVjdDsKClRob3JheC5zZXRSb290T2JqZWN0ID0gZnVuY3Rpb24ob2JqKSB7CiAgcm9vdE9iamVjdCA9IG9iajsKfTsKClRob3JheC5sb2FkSGFuZGxlciA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQsIGNvbnRleHQpIHsKICB2YXIgbG9hZENvdW50ZXIgPSBfLnVuaXF1ZUlkKCk7CiAgcmV0dXJuIGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCkgewogICAgdmFyIHNlbGYgPSBjb250ZXh0IHx8IHRoaXM7CiAgICBzZWxmLl9sb2FkSW5mbyA9IHNlbGYuX2xvYWRJbmZvIHx8IFtdOwogICAgdmFyIGxvYWRJbmZvID0gc2VsZi5fbG9hZEluZm9bbG9hZENvdW50ZXJdOwoKICAgIGZ1bmN0aW9uIHN0YXJ0TG9hZFRpbWVvdXQoKSB7CgogICAgICAvLyBJZiB0aGUgdGltZW91dCBoYXMgYmVlbiBzZXQgYWxyZWFkeSBidXQgaGFzIG5vdCB0cmlnZ2VyZWQgeWV0IGRvIG5vdGhpbmcKICAgICAgLy8gT3RoZXJ3aXNlIHNldCBhIG5ldyB0aW1lb3V0IChlaXRoZXIgaW5pdGlhbCBvciBmb3IgZ29pbmcgZnJvbSBiYWNrZ3JvdW5kIHRvCiAgICAgIC8vIG5vbi1iYWNrZ3JvdW5kIGxvYWRpbmcpCiAgICAgIGlmIChsb2FkSW5mby50aW1lb3V0ICYmICFsb2FkSW5mby5ydW4pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBsb2FkaW5nVGltZW91dCA9IHNlbGYuX2xvYWRpbmdUaW1lb3V0RHVyYXRpb24gIT09IHVuZGVmaW5lZCA/CiAgICAgICAgc2VsZi5fbG9hZGluZ1RpbWVvdXREdXJhdGlvbiA6IFRob3JheC5WaWV3LnByb3RvdHlwZS5fbG9hZGluZ1RpbWVvdXREdXJhdGlvbjsKICAgICAgbG9hZEluZm8udGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBsb2FkSW5mby5ydW4gPSB0cnVlOwogICAgICAgICAgICBzdGFydC5jYWxsKHNlbGYsIGxvYWRJbmZvLm1lc3NhZ2UsIGxvYWRJbmZvLmJhY2tncm91bmQsIGxvYWRJbmZvKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgVGhvcmF4Lm9uRXhjZXB0aW9uKCdsb2FkU3RhcnQnLCBlKTsKICAgICAgICAgIH0KICAgICAgICB9LCBsb2FkaW5nVGltZW91dCAqIDEwMDApOwogICAgfQoKICAgIGlmICghbG9hZEluZm8pIHsKICAgICAgbG9hZEluZm8gPSBzZWxmLl9sb2FkSW5mb1tsb2FkQ291bnRlcl0gPSBfLmV4dGVuZCh7CiAgICAgICAgZXZlbnRzOiBbXSwKICAgICAgICB0aW1lb3V0OiAwLAogICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsCiAgICAgICAgYmFja2dyb3VuZDogISFiYWNrZ3JvdW5kCiAgICAgIH0sIEJhY2tib25lLkV2ZW50cyk7CiAgICAgIHN0YXJ0TG9hZFRpbWVvdXQoKTsKICAgIH0gZWxzZSB7CiAgICAgIGNsZWFyVGltZW91dChsb2FkSW5mby5lbmRUaW1lb3V0KTsKCiAgICAgIGxvYWRJbmZvLm1lc3NhZ2UgPSBtZXNzYWdlOwogICAgICBpZiAoIWJhY2tncm91bmQgJiYgbG9hZEluZm8uYmFja2dyb3VuZCkgewogICAgICAgIGxvYWRJbmZvLmJhY2tncm91bmQgPSBmYWxzZTsKICAgICAgICBzdGFydExvYWRUaW1lb3V0KCk7CiAgICAgIH0KICAgIH0KCiAgICBsb2FkSW5mby5ldmVudHMucHVzaChvYmplY3QpOwogICAgb2JqZWN0Lm9uKGxvYWRFbmQsIGZ1bmN0aW9uIGVuZENhbGxiYWNrKCkgewogICAgICBvYmplY3Qub2ZmKGxvYWRFbmQsIGVuZENhbGxiYWNrKTsKCiAgICAgIHZhciBsb2FkaW5nRW5kVGltZW91dCA9IHNlbGYuX2xvYWRpbmdUaW1lb3V0RW5kRHVyYXRpb247CiAgICAgIGlmIChsb2FkaW5nRW5kVGltZW91dCA9PT0gdm9pZCAwKSB7CiAgICAgICAgLy8gSWYgd2UgYXJlIHJ1bm5pbmcgb24gYSBub24tdmlldyBvYmplY3QgcHVsbCB0aGUgZGVmYXVsdCB0aW1lb3V0CiAgICAgICAgbG9hZGluZ0VuZFRpbWVvdXQgPSBUaG9yYXguVmlldy5wcm90b3R5cGUuX2xvYWRpbmdUaW1lb3V0RW5kRHVyYXRpb247CiAgICAgIH0KCiAgICAgIHZhciBldmVudHMgPSBsb2FkSW5mby5ldmVudHMsCiAgICAgICAgICBpbmRleCA9IGV2ZW50cy5pbmRleE9mKG9iamVjdCk7CiAgICAgIGlmIChpbmRleCA+PSAwKSB7CiAgICAgICAgZXZlbnRzLnNwbGljZShpbmRleCwgMSk7CiAgICAgIH0KICAgICAgaWYgKCFldmVudHMubGVuZ3RoKSB7CiAgICAgICAgbG9hZEluZm8uZW5kVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoIWV2ZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgICB2YXIgcnVuID0gbG9hZEluZm8ucnVuOwoKICAgICAgICAgICAgICBpZiAocnVuKSB7CiAgICAgICAgICAgICAgICAvLyBFbWl0IHRoZSBlbmQgYmVoYXZpb3IsIGJ1dCBvbmx5IGlmIHRoZXJlIGlzIGEgcGFpcmVkIHN0YXJ0CiAgICAgICAgICAgICAgICBlbmQuY2FsbChzZWxmLCBsb2FkSW5mby5iYWNrZ3JvdW5kLCBsb2FkSW5mbyk7CiAgICAgICAgICAgICAgICBsb2FkSW5mby50cmlnZ2VyKGxvYWRFbmQsIGxvYWRJbmZvKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vIElmIHN0b3BwaW5nIG1ha2Ugc3VyZSB3ZSBkb24ndCBydW4gYSBzdGFydAogICAgICAgICAgICAgIGNsZWFyVGltZW91dChsb2FkSW5mby50aW1lb3V0KTsKICAgICAgICAgICAgICBsb2FkSW5mbyA9IHNlbGYuX2xvYWRJbmZvW2xvYWRDb3VudGVyXSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBUaG9yYXgub25FeGNlcHRpb24oJ2xvYWRFbmQnLCBlKTsKICAgICAgICAgIH0KICAgICAgICB9LCBsb2FkaW5nRW5kVGltZW91dCAqIDEwMDApOwogICAgICB9CiAgICB9KTsKICB9Owp9OwoKLyoqCiAqIEhlbHBlciBtZXRob2QgZm9yIHByb3BhZ2F0aW5nIGxvYWQ6c3RhcnQgZXZlbnRzIHRvIG90aGVyIG9iamVjdHMuCiAqCiAqIEZvcndhcmRzIGxvYWQ6c3RhcnQgZXZlbnRzIHRoYXQgb2NjdXIgb24gYHNvdXJjZWAgdG8gYGRlc3RgLgogKi8KVGhvcmF4LmZvcndhcmRMb2FkRXZlbnRzID0gZnVuY3Rpb24oc291cmNlLCBkZXN0LCBvbmNlKSB7CiAgZnVuY3Rpb24gbG9hZChtZXNzYWdlLCBiYWNrZ291bmQsIG9iamVjdCkgewogICAgaWYgKG9uY2UpIHsKICAgICAgc291cmNlLm9mZihsb2FkU3RhcnQsIGxvYWQpOwogICAgfQogICAgZGVzdC50cmlnZ2VyKGxvYWRTdGFydCwgbWVzc2FnZSwgYmFja2dvdW5kLCBvYmplY3QpOwogIH0KICBzb3VyY2Uub24obG9hZFN0YXJ0LCBsb2FkKTsKICByZXR1cm4gewogICAgb2ZmOiBmdW5jdGlvbigpIHsKICAgICAgc291cmNlLm9mZihsb2FkU3RhcnQsIGxvYWQpOwogICAgfQogIH07Cn07CgovLwovLyBEYXRhIGxvYWQgZXZlbnQgZ2VuZXJhdGlvbgovLwoKLyoqCiAqIE1peGluZyBmb3IgZ2VuZXJhdGluZyBsb2FkOnN0YXJ0IGFuZCBsb2FkOmVuZCBldmVudHMuCiAqLwpUaG9yYXgubWl4aW5Mb2FkYWJsZSA9IGZ1bmN0aW9uKHRhcmdldCwgdXNlUGFyZW50KSB7CiAgXy5leHRlbmQodGFyZ2V0LCB7CiAgICAvL2xvYWRpbmcgY29uZmlnCiAgICBfbG9hZGluZ0NsYXNzTmFtZTogJ2xvYWRpbmcnLAogICAgX2xvYWRpbmdUaW1lb3V0RHVyYXRpb246IDAuMzMsCiAgICBfbG9hZGluZ1RpbWVvdXRFbmREdXJhdGlvbjogMC4xMCwKCiAgICAvLyBQcm9wYWdhdGVzIGxvYWRpbmcgdmlldyBwYXJhbWV0ZXJzIHRvIHRoZSBBSkFYIGxheWVyCiAgICBvbkxvYWRTdGFydDogZnVuY3Rpb24obWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KSB7CiAgICAgIHZhciB0aGF0ID0gdXNlUGFyZW50ID8gdGhpcy5wYXJlbnQgOiB0aGlzOwogICAgICBpZiAoIXRoYXQubm9uQmxvY2tpbmdMb2FkICYmICFiYWNrZ3JvdW5kICYmIHJvb3RPYmplY3QgJiYgcm9vdE9iamVjdCAhPT0gdGhpcykgewogICAgICAgIHJvb3RPYmplY3QudHJpZ2dlcihsb2FkU3RhcnQsIG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCk7CiAgICAgIH0KICAgICAgJCh0aGF0LmVsKS5hZGRDbGFzcyh0aGF0Ll9sb2FkaW5nQ2xhc3NOYW1lKTsKICAgICAgLy91c2VkIGJ5IGxvYWRpbmcgaGVscGVycwogICAgICBpZiAodGhhdC5fbG9hZGluZ0NhbGxiYWNrcykgewogICAgICAgIF8uZWFjaCh0aGF0Ll9sb2FkaW5nQ2FsbGJhY2tzLCBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgIG9uTG9hZEVuZDogZnVuY3Rpb24oLyogYmFja2dyb3VuZCwgb2JqZWN0ICovKSB7CiAgICAgIHZhciB0aGF0ID0gdXNlUGFyZW50ID8gdGhpcy5wYXJlbnQgOiB0aGlzOwogICAgICAkKHRoYXQuZWwpLnJlbW92ZUNsYXNzKHRoYXQuX2xvYWRpbmdDbGFzc05hbWUpOwogICAgICAvL3VzZWQgYnkgbG9hZGluZyBoZWxwZXJzCiAgICAgIGlmICh0aGF0Ll9sb2FkaW5nQ2FsbGJhY2tzKSB7CiAgICAgICAgXy5lYWNoKHRoYXQuX2xvYWRpbmdDYWxsYmFja3MsIGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfSk7Cn07CgpUaG9yYXgubWl4aW5Mb2FkYWJsZUV2ZW50cyA9IGZ1bmN0aW9uKHRhcmdldCwgdXNlUGFyZW50KSB7CiAgXy5leHRlbmQodGFyZ2V0LCB7CiAgICBsb2FkU3RhcnQ6IGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQpIHsKICAgICAgdmFyIHRoYXQgPSB1c2VQYXJlbnQgPyB0aGlzLnBhcmVudCA6IHRoaXM7CiAgICAgIHRoYXQudHJpZ2dlcihsb2FkU3RhcnQsIG1lc3NhZ2UsIGJhY2tncm91bmQsIHRoYXQpOwogICAgfSwKICAgIGxvYWRFbmQ6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdGhhdCA9IHVzZVBhcmVudCA/IHRoaXMucGFyZW50IDogdGhpczsKICAgICAgdGhhdC50cmlnZ2VyKGxvYWRFbmQsIHRoYXQpOwogICAgfQogIH0pOwp9OwoKVGhvcmF4Lm1peGluTG9hZGFibGUoVGhvcmF4LlZpZXcucHJvdG90eXBlKTsKVGhvcmF4Lm1peGluTG9hZGFibGVFdmVudHMoVGhvcmF4LlZpZXcucHJvdG90eXBlKTsKClRob3JheC5zeW5jID0gZnVuY3Rpb24obWV0aG9kLCBkYXRhT2JqLCBvcHRpb25zKSB7CiAgdmFyIHNlbGYgPSB0aGlzLAogICAgICBjb21wbGV0ZSA9IG9wdGlvbnMuY29tcGxldGU7CgogIG9wdGlvbnMuY29tcGxldGUgPSBmdW5jdGlvbigpIHsKICAgIHNlbGYuX3JlcXVlc3QgPSB1bmRlZmluZWQ7CiAgICBzZWxmLl9hYm9ydGVkID0gZmFsc2U7CgogICAgY29tcGxldGUgJiYgY29tcGxldGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwogIHRoaXMuX3JlcXVlc3QgPSBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogIHJldHVybiB0aGlzLl9yZXF1ZXN0Owp9OwoKZnVuY3Rpb24gYmluZFRvUm91dGUoY2FsbGJhY2ssIGZhaWxiYWNrKSB7CiAgdmFyIGZyYWdtZW50ID0gQmFja2JvbmUuaGlzdG9yeS5nZXRGcmFnbWVudCgpLAogICAgICByb3V0ZUNoYW5nZWQgPSBmYWxzZTsKCiAgZnVuY3Rpb24gcm91dGVIYW5kbGVyKCkgewogICAgaWYgKGZyYWdtZW50ID09PSBCYWNrYm9uZS5oaXN0b3J5LmdldEZyYWdtZW50KCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgcm91dGVDaGFuZ2VkID0gdHJ1ZTsKICAgIHJlcy5jYW5jZWwoKTsKICAgIGZhaWxiYWNrICYmIGZhaWxiYWNrKCk7CiAgfQoKICBCYWNrYm9uZS5oaXN0b3J5Lm9uKCdyb3V0ZScsIHJvdXRlSGFuZGxlcik7CgogIGZ1bmN0aW9uIGZpbmFsaXplcigpIHsKICAgIEJhY2tib25lLmhpc3Rvcnkub2ZmKCdyb3V0ZScsIHJvdXRlSGFuZGxlcik7CiAgICBpZiAoIXJvdXRlQ2hhbmdlZCkgewogICAgICBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0KCiAgdmFyIHJlcyA9IF8uYmluZChmaW5hbGl6ZXIsIHRoaXMpOwogIHJlcy5jYW5jZWwgPSBmdW5jdGlvbigpIHsKICAgIEJhY2tib25lLmhpc3Rvcnkub2ZmKCdyb3V0ZScsIHJvdXRlSGFuZGxlcik7CiAgfTsKCiAgcmV0dXJuIHJlczsKfQoKZnVuY3Rpb24gbG9hZERhdGEoY2FsbGJhY2ssIGZhaWxiYWNrLCBvcHRpb25zKSB7CiAgaWYgKHRoaXMuaXNQb3B1bGF0ZWQoKSkgewogICAgcmV0dXJuIGNhbGxiYWNrKHRoaXMpOwogIH0KCiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIgJiYgdHlwZW9mIGZhaWxiYWNrICE9PSAnZnVuY3Rpb24nICYmIF8uaXNPYmplY3QoZmFpbGJhY2spKSB7CiAgICBvcHRpb25zID0gZmFpbGJhY2s7CiAgICBmYWlsYmFjayA9IGZhbHNlOwogIH0KCiAgdmFyIHNlbGYgPSB0aGlzLAogICAgICByb3V0ZUNoYW5nZWQgPSBmYWxzZSwKICAgICAgc3VjY2Vzc0NhbGxiYWNrID0gYmluZFRvUm91dGUoXy5iaW5kKGNhbGxiYWNrLCBzZWxmKSwgZnVuY3Rpb24oKSB7CiAgICAgICAgcm91dGVDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICBpZiAoc2VsZi5fcmVxdWVzdCkgewogICAgICAgICAgc2VsZi5fYWJvcnRlZCA9IHRydWU7CiAgICAgICAgICBzZWxmLl9yZXF1ZXN0LmFib3J0KCk7CiAgICAgICAgfQogICAgICAgIGZhaWxiYWNrICYmIGZhaWxiYWNrLmNhbGwoc2VsZiwgZmFsc2UpOwogICAgICB9KTsKCiAgdGhpcy5mZXRjaChfLmRlZmF1bHRzKHsKICAgIHN1Y2Nlc3M6IHN1Y2Nlc3NDYWxsYmFjaywKICAgIGVycm9yOiBmYWlsYmFjayAmJiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCFyb3V0ZUNoYW5nZWQpIHsKICAgICAgICBmYWlsYmFjay5hcHBseShzZWxmLCBbdHJ1ZV0uY29uY2F0KF8udG9BcnJheShhcmd1bWVudHMpKSk7CiAgICAgIH0KICAgIH0sCiAgICBjb21wbGV0ZTogZnVuY3Rpb24oKSB7CiAgICAgIHN1Y2Nlc3NDYWxsYmFjay5jYW5jZWwoKTsKICAgIH0KICB9LCBvcHRpb25zKSk7Cn0KCmZ1bmN0aW9uIGZldGNoUXVldWUob3B0aW9ucywgJHN1cGVyKSB7CiAgaWYgKG9wdGlvbnMucmVzZXRRdWV1ZSkgewogICAgLy8gV0FSTjogU2hvdWxkIGVuc3VyZSB0aGF0IGxvYWRlcnMgYXJlIHByb3RlY3RlZCBmcm9tIG91dCBvZiBiYW5kIGRhdGEKICAgIC8vICAgIHdoZW4gdXNpbmcgdGhpcyBvcHRpb24KICAgIHRoaXMuZmV0Y2hRdWV1ZSA9IHVuZGVmaW5lZDsKICB9CgogIGlmICghdGhpcy5mZXRjaFF1ZXVlKSB7CiAgICAvLyBLaWNrIG9mZiB0aGUgcmVxdWVzdAogICAgdGhpcy5mZXRjaFF1ZXVlID0gW29wdGlvbnNdOwogICAgb3B0aW9ucyA9IF8uZGVmYXVsdHMoewogICAgICBzdWNjZXNzOiBmbHVzaFF1ZXVlKHRoaXMsIHRoaXMuZmV0Y2hRdWV1ZSwgJ3N1Y2Nlc3MnKSwKICAgICAgZXJyb3I6IGZsdXNoUXVldWUodGhpcywgdGhpcy5mZXRjaFF1ZXVlLCAnZXJyb3InKSwKICAgICAgY29tcGxldGU6IGZsdXNoUXVldWUodGhpcywgdGhpcy5mZXRjaFF1ZXVlLCAnY29tcGxldGUnKQogICAgfSwgb3B0aW9ucyk7CiAgICAkc3VwZXIuY2FsbCh0aGlzLCBvcHRpb25zKTsKICB9IGVsc2UgewogICAgLy8gQ3VycmVudGx5IGZldGNoaW5nLiBRdWV1ZSBhbmQgcHJvY2VzcyBvbmNlIGNvbXBsZXRlCiAgICB0aGlzLmZldGNoUXVldWUucHVzaChvcHRpb25zKTsKICB9Cn0KCmZ1bmN0aW9uIGZsdXNoUXVldWUoc2VsZiwgZmV0Y2hRdWV1ZSwgaGFuZGxlcikgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwoKICAgIC8vIEZsdXNoIHRoZSBxdWV1ZS4gRXhlY3V0ZXMgYW55IGNhbGxiYWNrIGhhbmRsZXJzIHRoYXQKICAgIC8vIG1heSBoYXZlIGJlZW4gcGFzc2VkIGluIHRoZSBmZXRjaCBvcHRpb25zLgogICAgXy5lYWNoKGZldGNoUXVldWUsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnNbaGFuZGxlcl0pIHsKICAgICAgICBvcHRpb25zW2hhbmRsZXJdLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB9CiAgICB9LCB0aGlzKTsKCiAgICAvLyBSZXNldCB0aGUgcXVldWUgaWYgd2UgYXJlIHN0aWxsIHRoZSBhY3RpdmUgcmVxdWVzdAogICAgaWYgKHNlbGYuZmV0Y2hRdWV1ZSA9PT0gZmV0Y2hRdWV1ZSkgewogICAgICBzZWxmLmZldGNoUXVldWUgPSB1bmRlZmluZWQ7CiAgICB9CiAgfTsKfQoKdmFyIGtsYXNzZXMgPSBbXTsKVGhvcmF4Lk1vZGVsICYmIGtsYXNzZXMucHVzaChUaG9yYXguTW9kZWwpOwpUaG9yYXguQ29sbGVjdGlvbiAmJiBrbGFzc2VzLnB1c2goVGhvcmF4LkNvbGxlY3Rpb24pOwoKXy5lYWNoKGtsYXNzZXMsIGZ1bmN0aW9uKERhdGFDbGFzcykgewogIHZhciAkZmV0Y2ggPSBEYXRhQ2xhc3MucHJvdG90eXBlLmZldGNoOwogIFRob3JheC5taXhpbkxvYWRhYmxlRXZlbnRzKERhdGFDbGFzcy5wcm90b3R5cGUsIGZhbHNlKTsKICBfLmV4dGVuZChEYXRhQ2xhc3MucHJvdG90eXBlLCB7CiAgICBzeW5jOiBUaG9yYXguc3luYywKCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICAgIHZhciBzZWxmID0gdGhpcywKICAgICAgICAgIGNvbXBsZXRlID0gb3B0aW9ucy5jb21wbGV0ZTsKCiAgICAgIG9wdGlvbnMuY29tcGxldGUgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb21wbGV0ZSAmJiBjb21wbGV0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIHNlbGYubG9hZEVuZCgpOwogICAgICB9OwogICAgICBzZWxmLmxvYWRTdGFydCh1bmRlZmluZWQsIG9wdGlvbnMuYmFja2dyb3VuZCk7CiAgICAgIHJldHVybiBmZXRjaFF1ZXVlLmNhbGwodGhpcywgb3B0aW9ucyB8fCB7fSwgJGZldGNoKTsKICAgIH0sCgogICAgbG9hZDogZnVuY3Rpb24oY2FsbGJhY2ssIGZhaWxiYWNrLCBvcHRpb25zKSB7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyICYmIHR5cGVvZiBmYWlsYmFjayAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgIG9wdGlvbnMgPSBmYWlsYmFjazsKICAgICAgICBmYWlsYmFjayA9IGZhbHNlOwogICAgICB9CgogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgaWYgKCFvcHRpb25zLmJhY2tncm91bmQgJiYgIXRoaXMuaXNQb3B1bGF0ZWQoKSAmJiByb290T2JqZWN0KSB7CiAgICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgdGhlIGdsb2JhbCBzY29wZSBzZWVzIHRoZSBwcm9wZXIgbG9hZCBldmVudHMgaGVyZQogICAgICAgIC8vIGlmIHdlIGFyZSBsb2FkaW5nIGluIHN0YW5kYWxvbmUgbW9kZQogICAgICAgIFRob3JheC5mb3J3YXJkTG9hZEV2ZW50cyh0aGlzLCByb290T2JqZWN0LCB0cnVlKTsKICAgICAgfQoKICAgICAgbG9hZERhdGEuY2FsbCh0aGlzLCBjYWxsYmFjaywgZmFpbGJhY2ssIG9wdGlvbnMpOwogICAgfQogIH0pOwp9KTsKClRob3JheC5VdGlsLmJpbmRUb1JvdXRlID0gYmluZFRvUm91dGU7CgppZiAoVGhvcmF4LlJvdXRlcikgewogIFRob3JheC5Sb3V0ZXIuYmluZFRvUm91dGUgPSBUaG9yYXguUm91dGVyLnByb3RvdHlwZS5iaW5kVG9Sb3V0ZSA9IGJpbmRUb1JvdXRlOwp9CgovLyBQcm9wYWdhdGVzIGxvYWRpbmcgdmlldyBwYXJhbWV0ZXJzIHRvIHRoZSBBSkFYIGxheWVyClRob3JheC5WaWV3LnByb3RvdHlwZS5fbW9kaWZ5RGF0YU9iamVjdE9wdGlvbnMgPSBmdW5jdGlvbihkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgb3B0aW9ucy5pZ25vcmVFcnJvcnMgPSB0aGlzLmlnbm9yZUZldGNoRXJyb3I7CiAgb3B0aW9ucy5iYWNrZ3JvdW5kID0gdGhpcy5ub25CbG9ja2luZ0xvYWQ7CiAgcmV0dXJuIG9wdGlvbnM7Cn07CgpUaG9yYXguSGVscGVyVmlldy5wcm90b3R5cGUuX21vZGlmeURhdGFPYmplY3RPcHRpb25zID0gZnVuY3Rpb24oZGF0YU9iamVjdCwgb3B0aW9ucykgewogIG9wdGlvbnMuaWdub3JlRXJyb3JzID0gdGhpcy5wYXJlbnQuaWdub3JlRmV0Y2hFcnJvcjsKICBvcHRpb25zLmJhY2tncm91bmQgPSB0aGlzLnBhcmVudC5ub25CbG9ja2luZ0xvYWQ7CiAgcmV0dXJuIG9wdGlvbnM7Cn07Cgppbmhlcml0VmFycy5jb2xsZWN0aW9uLmxvYWRpbmcgPSBmdW5jdGlvbigpIHsKICB2YXIgbG9hZGluZ1ZpZXcgPSB0aGlzLmxvYWRpbmdWaWV3LAogICAgICBsb2FkaW5nVGVtcGxhdGUgPSB0aGlzLmxvYWRpbmdUZW1wbGF0ZSwKICAgICAgbG9hZGluZ1BsYWNlbWVudCA9IHRoaXMubG9hZGluZ1BsYWNlbWVudDsKICAvL2FkZCAibG9hZGluZy12aWV3IiBhbmQgImxvYWRpbmctdGVtcGxhdGUiIG9wdGlvbnMgdG8gY29sbGVjdGlvbiBoZWxwZXIKICBpZiAobG9hZGluZ1ZpZXcgfHwgbG9hZGluZ1RlbXBsYXRlKSB7CiAgICB2YXIgY2FsbGJhY2sgPSBUaG9yYXgubG9hZEhhbmRsZXIoXy5iaW5kKGZ1bmN0aW9uKCkgewogICAgICB2YXIgaXRlbTsKICAgICAgaWYgKHRoaXMuY29sbGVjdGlvbi5sZW5ndGggPT09IDApIHsKICAgICAgICB0aGlzLiRlbC5lbXB0eSgpOwogICAgICB9CiAgICAgIGlmIChsb2FkaW5nVmlldykgewogICAgICAgIHZhciBpbnN0YW5jZSA9IFRob3JheC5VdGlsLmdldFZpZXdJbnN0YW5jZShsb2FkaW5nVmlldywgewogICAgICAgICAgY29sbGVjdGlvbjogdGhpcy5jb2xsZWN0aW9uCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5fYWRkQ2hpbGQoaW5zdGFuY2UpOwogICAgICAgIGlmIChsb2FkaW5nVGVtcGxhdGUpIHsKICAgICAgICAgIGluc3RhbmNlLnJlbmRlcihsb2FkaW5nVGVtcGxhdGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpbnN0YW5jZS5yZW5kZXIoKTsKICAgICAgICB9CiAgICAgICAgaXRlbSA9IGluc3RhbmNlOwogICAgICB9IGVsc2UgewogICAgICAgIGl0ZW0gPSB0aGlzLnJlbmRlclRlbXBsYXRlKGxvYWRpbmdUZW1wbGF0ZSk7CiAgICAgIH0KICAgICAgdmFyIGluZGV4ID0gbG9hZGluZ1BsYWNlbWVudAogICAgICAgID8gbG9hZGluZ1BsYWNlbWVudC5jYWxsKHRoaXMpCiAgICAgICAgOiB0aGlzLmNvbGxlY3Rpb24ubGVuZ3RoCiAgICAgIDsKICAgICAgdGhpcy5hcHBlbmRJdGVtKGl0ZW0sIGluZGV4KTsKICAgICAgdGhpcy4kZWwuY2hpbGRyZW4oKS5lcShpbmRleCkuYXR0cignZGF0YS1sb2FkaW5nLWVsZW1lbnQnLCB0aGlzLmNvbGxlY3Rpb24uY2lkKTsKICAgIH0sIHRoaXMpLCBfLmJpbmQoZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLmZpbmQoJ1tkYXRhLWxvYWRpbmctZWxlbWVudD0iJyArIHRoaXMuY29sbGVjdGlvbi5jaWQgKyAnIl0nKS5yZW1vdmUoKTsKICAgIH0sIHRoaXMpLAogICAgdGhpcy5jb2xsZWN0aW9uKTsKCiAgICB0aGlzLmxpc3RlblRvKHRoaXMuY29sbGVjdGlvbiwgJ2xvYWQ6c3RhcnQnLCBjYWxsYmFjayk7CiAgfQp9OwoKaWYgKHR5cGVvZiBjb2xsZWN0aW9uT3B0aW9uTmFtZXMgIT09ICd1bmRlZmluZWQnKSB7CiAgY29sbGVjdGlvbk9wdGlvbk5hbWVzWydsb2FkaW5nLXRlbXBsYXRlJ10gPSAnbG9hZGluZ1RlbXBsYXRlJzsKICBjb2xsZWN0aW9uT3B0aW9uTmFtZXNbJ2xvYWRpbmctdmlldyddID0gJ2xvYWRpbmdWaWV3JzsKICBjb2xsZWN0aW9uT3B0aW9uTmFtZXNbJ2xvYWRpbmctcGxhY2VtZW50J10gPSAnbG9hZGluZ1BsYWNlbWVudCc7Cn0KClRob3JheC5WaWV3Lm9uKHsKICAnbG9hZDpzdGFydCc6IFRob3JheC5sb2FkSGFuZGxlcigKICAgICAgZnVuY3Rpb24obWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KSB7CiAgICAgICAgdGhpcy5vbkxvYWRTdGFydChtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpOwogICAgICB9LAogICAgICBmdW5jdGlvbihiYWNrZ3JvdW5kLCBvYmplY3QpIHsKICAgICAgICB0aGlzLm9uTG9hZEVuZChvYmplY3QpOwogICAgICB9KSwKCiAgY29sbGVjdGlvbjogewogICAgJ2xvYWQ6c3RhcnQnOiBmdW5jdGlvbihtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpIHsKICAgICAgdGhpcy50cmlnZ2VyKGxvYWRTdGFydCwgbWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KTsKICAgIH0KICB9LAogIG1vZGVsOiB7CiAgICAnbG9hZDpzdGFydCc6IGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCkgewogICAgICB0aGlzLnRyaWdnZXIobG9hZFN0YXJ0LCBtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpOwogICAgfQogIH0KfSk7Cgo7OwpIYW5kbGViYXJzLnJlZ2lzdGVyVmlld0hlbHBlcignbG9hZGluZycsIGZ1bmN0aW9uKHZpZXcpIHsKICB2YXIgX3JlbmRlciA9IHZpZXcucmVuZGVyOwogIHZpZXcucmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICBpZiAodmlldy5wYXJlbnQuJGVsLmhhc0NsYXNzKHZpZXcucGFyZW50Ll9sb2FkaW5nQ2xhc3NOYW1lKSkgewogICAgICByZXR1cm4gX3JlbmRlci5jYWxsKHRoaXMsIHZpZXcuZm4pOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIF9yZW5kZXIuY2FsbCh0aGlzLCB2aWV3LmludmVyc2UpOwogICAgfQogIH07CiAgdmFyIGNhbGxiYWNrID0gXy5iaW5kKHZpZXcucmVuZGVyLCB2aWV3KTsKICB2aWV3LnBhcmVudC5fbG9hZGluZ0NhbGxiYWNrcyA9IHZpZXcucGFyZW50Ll9sb2FkaW5nQ2FsbGJhY2tzIHx8IFtdOwogIHZpZXcucGFyZW50Ll9sb2FkaW5nQ2FsbGJhY2tzLnB1c2goY2FsbGJhY2spOwogIHZpZXcub24oJ2ZyZWV6ZScsIGZ1bmN0aW9uKCkgewogICAgdmlldy5wYXJlbnQuX2xvYWRpbmdDYWxsYmFja3MgPSBfLndpdGhvdXQodmlldy5wYXJlbnQuX2xvYWRpbmdDYWxsYmFja3MsIGNhbGxiYWNrKTsKICB9KTsKICB2aWV3LnJlbmRlcigpOwp9KTsKCjs7Ci8qZ2xvYmFsIHB1c2hEb21FdmVudHMgKi8KdmFyIGlzTW9iaWxlID0gJ29udG91Y2hzdGFydCcgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LAogICAgaXNpT1MgPSBuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC8oaVBob25lfGlQb2R8aVBhZCkvaSksCiAgICBpc0FuZHJvaWQgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkuaW5kZXhPZigiYW5kcm9pZCIpID4gLTEgPyAxIDogMCwKICAgIG1pbmltdW1TY3JvbGxZT2Zmc2V0ID0gaXNBbmRyb2lkID8gMSA6IDA7CgpUaG9yYXguVXRpbC5zY3JvbGxUbyA9IGZ1bmN0aW9uKHgsIHkpIHsKICB5ID0geSB8fCBtaW5pbXVtU2Nyb2xsWU9mZnNldDsKICBmdW5jdGlvbiBfc2Nyb2xsVG8oKSB7CiAgICB3aW5kb3cuc2Nyb2xsVG8oeCwgeSk7CiAgfQogIGlmIChpc2lPUykgewogICAgLy8gYSBkZWZlciBpcyByZXF1aXJlZCBmb3IgaW9zCiAgICBfLmRlZmVyKF9zY3JvbGxUbyk7CiAgfSBlbHNlIHsKICAgIF9zY3JvbGxUbygpOwogIH0KICByZXR1cm4gW3gsIHldOwp9OwoKVGhvcmF4LkxheW91dFZpZXcub24oJ2NoYW5nZTp2aWV3OmVuZCcsIGZ1bmN0aW9uKG5ld1ZpZXcsIG9sZFZpZXcsIG9wdGlvbnMpIHsKICBvcHRpb25zLnNjcm9sbCAmJiBUaG9yYXguVXRpbC5zY3JvbGxUbygwLCAwKTsKfSk7CgpUaG9yYXguVXRpbC5zY3JvbGxUb1RvcCA9IGZ1bmN0aW9uKCkgewogIC8vIGFuZHJvaWQgd2lsbCB1c2UgaGVpZ2h0IG9mIDEgYmVjYXVzZSBvZiBtaW5pbXVtU2Nyb2xsWU9mZnNldCBpbiBzY3JvbGxUbygpCiAgcmV0dXJuIHRoaXMuc2Nyb2xsVG8oMCwgMCk7Cn07CgpwdXNoRG9tRXZlbnRzKFsKICAnc2luZ2xlVGFwJywgJ2RvdWJsZVRhcCcsICdsb25nVGFwJywKICAnc3dpcGUnLAogICdzd2lwZVVwJywgJ3N3aXBlRG93bicsCiAgJ3N3aXBlTGVmdCcsICdzd2lwZVJpZ2h0JwpdKTsKCi8vYnVpbHQgaW4gZG9tIGV2ZW50cwpUaG9yYXguVmlldy5vbih7CiAgJ3N1Ym1pdCBmb3JtJzogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKICAgIC8vIEhpZGUgYW55IHZpcnR1YWwga2V5Ym9hcmRzIHRoYXQgbWF5IGJlIGxpbmdlcmluZyBhcm91bmQKICAgIHZhciBmb2N1c2VkID0gJCgnOmZvY3VzJylbMF07CiAgICBmb2N1c2VkICYmIGZvY3VzZWQuYmx1cigpOwogIH0KfSk7Cgo7OwovKmdsb2JhbCBpc01vYmlsZSwgcmVnaXN0ZXJDbGlja0hhbmRsZXIgKi8KCi8vcmVtb3ZhbCBvZiBjbGljayBkZWxheSBvbiBtb2JpbGUgd2Via2l0CnZhciBUQVBfUkFOR0UgPSA1OyAgICAvLyArLTVweCBpcyBzdGlsbCBjb25zaWRlcmVkIGEgdGFwCgpUaG9yYXguX2Zhc3RDbGlja0V2ZW50TmFtZSA9ICdjbGljayc7ClRob3JheC5jb25maWd1cmVGYXN0Q2xpY2sgPSBmdW5jdGlvbih1c2VGYXN0Q2xpY2spIHsKICB2YXIgYm9keSA9IGRvY3VtZW50LmJvZHk7CiAgaWYgKHVzZUZhc3RDbGljayAmJiBpc01vYmlsZSkgewogICAgVGhvcmF4Ll9mYXN0Q2xpY2tFdmVudE5hbWUgPSAnZmFzdC1jbGljayc7CiAgICBib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBvblRvdWNoU3RhcnQsIHRydWUpOwogICAgYm9keS5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBvblRvdWNoTW92ZSwgdHJ1ZSk7CiAgICBib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgb25Ub3VjaEVuZCwgdHJ1ZSk7CiAgICBib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgY2xpY2tLaWxsZXIsIHRydWUpOwogIH0gZWxzZSB7CiAgICBUaG9yYXguX2Zhc3RDbGlja0V2ZW50TmFtZSA9ICdjbGljayc7CiAgICBib2R5LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBvblRvdWNoU3RhcnQsIHRydWUpOwogICAgYm9keS5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBvblRvdWNoTW92ZSwgdHJ1ZSk7CiAgICBib2R5LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgb25Ub3VjaEVuZCwgdHJ1ZSk7CiAgICBib2R5LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgY2xpY2tLaWxsZXIsIHRydWUpOwogIH0KICBpZiAodHlwZW9mIHJlZ2lzdGVyQ2xpY2tIYW5kbGVyICE9PSAndW5kZWZpbmVkJykgewogICAgcmVnaXN0ZXJDbGlja0hhbmRsZXIgJiYgcmVnaXN0ZXJDbGlja0hhbmRsZXIoKTsKICB9Cn07CgppZiAoaXNNb2JpbGUpIHsKICB2YXIgc3RhcnQsCiAgICAgIGNsaWNrUmVkUnVtOwoKICBmdW5jdGlvbiBvblRvdWNoU3RhcnQoZXZlbnQpIHsKICAgIHRyeSB7CiAgICAgIGlmIChldmVudC50b3VjaGVzLmxlbmd0aCA9PT0gMSkgewogICAgICAgIHZhciB0b3VjaCA9IGV2ZW50LnRvdWNoZXNbMF07CiAgICAgICAgc3RhcnQgPSB7eDogdG91Y2guY2xpZW50WCwgeTogdG91Y2guY2xpZW50WX07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RhcnQgPSBmYWxzZTsKICAgICAgfQogICAgICBjbGlja1JlZFJ1bSA9IGZhbHNlOwogICAgfSBjYXRjaCAoZSkgewogICAgICBUaG9yYXgub25FeGNlcHRpb24oJ2Zhc3QtY2xpY2sgc3RhcnQnLCBlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIG9uVG91Y2hNb3ZlKCkgewogICAgaWYgKCFldmVudC50b3VjaGVzIHx8IGV2ZW50LnRvdWNoZXMubGVuZ3RoID4gMSkgewogICAgICBzdGFydCA9IGZhbHNlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZGVmYXVsdFByZXZlbnRlZChldmVudCkgewogICAgcmV0dXJuIGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCA/IGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIDogZXZlbnQuZGVmYXVsdFByZXZlbnRlZDsKICB9CgogIGZ1bmN0aW9uIG9uVG91Y2hFbmQoZXZlbnQpIHsKICAgIHRyeSB7CiAgICAgIHZhciB0b3VjaCA9IGV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdOwogICAgICBpZiAoc3RhcnQKICAgICAgICAgICYmIE1hdGguYWJzKHRvdWNoLmNsaWVudFggLSBzdGFydC54KSA8PSBUQVBfUkFOR0UKICAgICAgICAgICYmIE1hdGguYWJzKHRvdWNoLmNsaWVudFkgLSBzdGFydC55KSA8PSBUQVBfUkFOR0UpIHsKICAgICAgICB2YXIgdGFyZ2V0ID0gdG91Y2gudGFyZ2V0OwoKICAgICAgICAvLyBzZWUgaWYgdGFyZ2V0IGVsZW1lbnQgb3IgYW5jZXN0b3IgaXMgZGlzYWJsZWQgYXMgY2xpY2sgd291bGQgbm90IGJlIHRyaWdnZXJlZCBpbiB0aGlzIGNhc2UKICAgICAgICB2YXIgZGlzYWJsZWQgPSAhISgkKHRhcmdldCkuY2xvc2VzdCgnW2Rpc2FibGVkXScpLmxlbmd0aCk7CiAgICAgICAgaWYgKCFkaXNhYmxlZCkgewogICAgICAgICAgZXZlbnQgPSAkLkV2ZW50KFRob3JheC5fZmFzdENsaWNrRXZlbnROYW1lLCB7b3JpZ2luYWw6IGV2ZW50fSk7CiAgICAgICAgICAkKHRhcmdldCkudHJpZ2dlcihldmVudCk7CiAgICAgICAgICBpZiAoIWRlZmF1bHRQcmV2ZW50ZWQoZXZlbnQpICYmICh0YXJnZXQuY29udHJvbCB8fCB0YXJnZXQuaHRtbEZvcikpIHsKICAgICAgICAgICAgaWYgKHRhcmdldC5jb250cm9sKSB7CiAgICAgICAgICAgICAgJCh0YXJnZXQuY29udHJvbCkudHJpZ2dlcihldmVudCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgJCgiIyIgKyB0YXJnZXQuaHRtbEZvcikudHJpZ2dlcihldmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChkZWZhdWx0UHJldmVudGVkKGV2ZW50KSkgewogICAgICAgICAgICAvLyBJZiB0aGUgZmFzdC1jbGljayB3YXMgaGFuZGxlZCwgcHJldmVudCBmdXRoZXIgb3BlcmF0aW9ucwogICAgICAgICAgICBjbGlja1JlZFJ1bSA9IHRydWU7CiAgICAgICAgICAgIGV2ZW50Lm9yaWdpbmFsLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICBUaG9yYXgub25FeGNlcHRpb24oJ2Zhc3QtY2xpY2sgZW5kJywgZSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjbGlja0tpbGxlcihldmVudCkgewogICAgaWYgKGNsaWNrUmVkUnVtKSB7CiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICBjbGlja1JlZFJ1bSA9IGZhbHNlOwogICAgfQogIH0KCiAgLy8gVXNlIHRoaXMgaW5zdGVhZCBvZiAkKGZ1bmN0aW9uKCkge30pIHNvIHRoYXQgalF1ZXJ5CiAgLy8gZG9lcyBub3QgcmVnaXN0ZXIgYSB0aW1lb3V0CiAgJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7CiAgICBUaG9yYXguY29uZmlndXJlRmFzdENsaWNrKGlzTW9iaWxlKTsKICB9KTsKfSBlbHNlIHsKICBpZiAodHlwZW9mIHJlZ2lzdGVyQ2xpY2tIYW5kbGVyICE9PSAndW5kZWZpbmVkJykgewogICAgcmVnaXN0ZXJDbGlja0hhbmRsZXIgJiYgcmVnaXN0ZXJDbGlja0hhbmRsZXIoKTsKICB9Cn0KCjs7Ci8qZ2xvYmFsIGlzQW5kcm9pZCwgaXNNb2JpbGUgKi8KCiQuZm4udGFwSG9sZEFuZEVuZCA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBjYWxsYmFja1N0YXJ0LCBjYWxsYmFja0VuZCkgewogIGZ1bmN0aW9uIHRyaWdnZXJFdmVudChvYmosIGV2ZW50VHlwZSwgY2FsbGJhY2ssIGV2ZW50KSB7CiAgICB2YXIgb3JpZ2luYWxUeXBlID0gZXZlbnQudHlwZSwKICAgICAgICByZXN1bHQ7CgogICAgZXZlbnQudHlwZSA9IGV2ZW50VHlwZTsKICAgIGlmIChjYWxsYmFjaykgewogICAgICByZXN1bHQgPSBjYWxsYmFjay5jYWxsKG9iaiwgZXZlbnQpOwogICAgfQogICAgZXZlbnQudHlwZSA9IG9yaWdpbmFsVHlwZTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICB2YXIgdGltZXJzID0gW107CiAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgIHZhciB0aGlzT2JqZWN0ID0gdGhpcywKICAgICAgICB0YXBIb2xkU3RhcnQgPSBmYWxzZSwKICAgICAgICAkdGhpcyA9ICQodGhpc09iamVjdCk7CgogICAgJHRoaXMub24oJ3RvdWNoc3RhcnQnLCBzZWxlY3RvciwgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgdGFwSG9sZFN0YXJ0ID0gZmFsc2U7CiAgICAgIHZhciBvcmlnRXZlbnQgPSBldmVudCwKICAgICAgICAgIHRpbWVyOwoKICAgICAgZnVuY3Rpb24gY2xlYXJUYXBUaW1lcihldmVudCkgewogICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7CgogICAgICAgIGlmICh0YXBIb2xkU3RhcnQpIHsKICAgICAgICAgIHZhciByZXR2YWwgPSBmYWxzZTsKICAgICAgICAgIGlmIChldmVudCkgewogICAgICAgICAgICAvLyBXZSBhcmVuJ3Qgc2VuZGluZyBhbnkgZW5kIGV2ZW50cyBmb3IgdG91Y2hjYW5jZWwgY2FzZXMsCiAgICAgICAgICAgIC8vIHByZXZlbnQgYW4gZXhjZXB0aW9uCiAgICAgICAgICAgIHJldHZhbCA9IHRyaWdnZXJFdmVudCh0aGlzT2JqZWN0LCAndGFwSG9sZEVuZCcsIGNhbGxiYWNrRW5kLCBldmVudCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmV0dmFsID09PSBmYWxzZSkgewogICAgICAgICAgICBfLmVhY2godGltZXJzLCBjbGVhclRpbWVvdXQpOwogICAgICAgICAgICB0aW1lcnMgPSBbXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgICQoZG9jdW1lbnQpLm9uZSgndG91Y2hjYW5jZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICBjbGVhclRhcFRpbWVyKCk7CgogICAgICAgICR0aGlzLm9mZigndG91Y2htb3ZlJywgc2VsZWN0b3IsIGNsZWFyVGFwVGltZXIpOwogICAgICAgICR0aGlzLm9mZigndG91Y2hlbmQnLCBzZWxlY3RvciwgY2xlYXJUYXBUaW1lcik7CiAgICAgIH0pOwoKICAgICAgJHRoaXMub24oJ3RvdWNoZW5kJywgc2VsZWN0b3IsIGNsZWFyVGFwVGltZXIpOwogICAgICAkdGhpcy5vbigndG91Y2htb3ZlJywgc2VsZWN0b3IsIGNsZWFyVGFwVGltZXIpOwoKICAgICAgdGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIHRhcEhvbGRTdGFydCA9IHRydWU7CiAgICAgICAgdmFyIHJldHZhbCA9IHRyaWdnZXJFdmVudCh0aGlzT2JqZWN0LCAndGFwSG9sZFN0YXJ0JywgY2FsbGJhY2tTdGFydCwgb3JpZ0V2ZW50KTsKICAgICAgICBpZiAocmV0dmFsID09PSBmYWxzZSkgewogICAgICAgICAgXy5lYWNoKHRpbWVycywgY2xlYXJUaW1lb3V0KTsKICAgICAgICAgIHRpbWVycyA9IFtdOwogICAgICAgIH0KICAgICAgfSwgMTUwKTsKICAgICAgdGltZXJzLnB1c2godGltZXIpOwogICAgfSk7CiAgfSk7Cn07CgovL29ubHkgZW5hYmxlIG9uIGFuZHJvaWQKdmFyIHVzZU5hdGl2ZUhpZ2hsaWdodCA9ICFpc0FuZHJvaWQ7ClRob3JheC5jb25maWd1cmVUYXBIaWdobGlnaHQgPSBmdW5jdGlvbih1c2VOYXRpdmUpIHsKICB1c2VOYXRpdmVIaWdobGlnaHQgPSB1c2VOYXRpdmU7Cn07Cgp2YXIgTkFUSVZFX1RBUFBBQkxFID0gewogICdBJzogdHJ1ZSwKICAnSU5QVVQnOiB0cnVlLAogICdCVVRUT04nOiB0cnVlLAogICdTRUxFQ1QnOiB0cnVlLAogICdURVhUQVJFQSc6IHRydWUKfTsKCmZ1bmN0aW9uIGZpeHVwVGFwSGlnaGxpZ2h0KHNjb3BlKSB7CiAgXy5lYWNoKHRoaXMuX2RvbUV2ZW50cyB8fCBbXSwgZnVuY3Rpb24oYmluZCkgewogICAgdmFyIGNvbXBvbmVudHMgPSBiaW5kLnNwbGl0KCcgJyksCiAgICAgICAgc2VsZWN0b3IgPSBjb21wb25lbnRzLnNsaWNlKDEpLmpvaW4oJyAnKSB8fCB1bmRlZmluZWQ7ICAvLyBOZWVkZWQgdG8gbWFrZSB6ZXB0byBoYXBweQoKICAgIGlmIChjb21wb25lbnRzWzBdID09PSAnY2xpY2snKSB7CiAgICAgIC8vICFzZWxlY3RvciBjYXNlIGlzIGZvciByb290IGNsaWNrIGhhbmRsZXJzIG9uIHRoZSB2aWV3LCBpLmUuICdjbGljaycKICAgICAgJChzZWxlY3RvciB8fCB0aGlzLmVsLCBzZWxlY3RvciAmJiAoc2NvcGUgfHwgdGhpcy5lbCkpLmZvckVhY2goZnVuY3Rpb24oZWwpIHsKICAgICAgICB2YXIgJGVsID0gJChlbCkuZGF0YSgndGFwcGFibGUnLCB0cnVlKTsKCiAgICAgICAgaWYgKHVzZU5hdGl2ZUhpZ2hsaWdodCAmJiAhTkFUSVZFX1RBUFBBQkxFW2VsLnRhZ05hbWVdKSB7CiAgICAgICAgICAvLyBBZGQgYW4gZXhwbGljaXQgTk9QIGJpbmQgdG8gYWxsb3cgdGFwLWhpZ2hsaWdodCBzdXBwb3J0CiAgICAgICAgICAkZWwub24oJ2NsaWNrJywgZmFsc2UpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSwgdGhpcyk7Cn0KCl8uZXh0ZW5kKFRob3JheC5WaWV3LnByb3RvdHlwZSwgewogIF90YXBIaWdobGlnaHRDbGFzc05hbWU6ICdhY3RpdmUnLAogIF90YXBIaWdobGlnaHRTdGFydDogZnVuY3Rpb24oZXZlbnQpIHsKICAgIHZhciB0YXJnZXQgPSBldmVudC5jdXJyZW50VGFyZ2V0LAogICAgICAgIHRhZ05hbWUgPSB0YXJnZXQgJiYgdGFyZ2V0LnRhZ05hbWUudG9Mb3dlckNhc2UoKTsKCiAgICAvLyBVc2VyIGlucHV0IGNvbnRyb2xzIG1heSBiZSB2aXN1YWxseSBwYXJ0IG9mIGEgbGFyZ2VyIGdyb3VwLiBGb3IgdGhlc2UgY2FzZXMKICAgIC8vIHdlIHdhbnQgdG8gZ2l2ZSBwcmlvcml0eSB0byBhbnkgcGFyZW50IHRoYXQgbWF5IHByb3ZpZGUgYSBmb2N1cyBvcGVyYXRpb24uCiAgICBpZiAodGFnTmFtZSA9PT0gJ2lucHV0JyB8fCB0YWdOYW1lID09PSAnc2VsZWN0JyB8fCB0YWdOYW1lID09PSAndGV4dGFyZWEnKSB7CiAgICAgIHRhcmdldCA9ICQodGFyZ2V0KS5jbG9zZXN0KCdbZGF0YS10YXBwYWJsZT10cnVlXScpWzBdIHx8IHRhcmdldDsKICAgIH0KCiAgICBpZiAodGFyZ2V0KSB7CiAgICAgICQodGFyZ2V0KS5hZGRDbGFzcyh0aGlzLl90YXBIaWdobGlnaHRDbGFzc05hbWUpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSwKICBfdGFwSGlnaGxpZ2h0RW5kOiBmdW5jdGlvbigvKiBldmVudCAqLykgewogICAgJCgnLicgKyB0aGlzLl90YXBIaWdobGlnaHRDbGFzc05hbWUpLnJlbW92ZUNsYXNzKHRoaXMuX3RhcEhpZ2hsaWdodENsYXNzTmFtZSk7CiAgfQp9KTsKCi8vVE9ETzogZXhhbWluZSBpZiB0aGVzZSBhcmUgc3RpbGwgbmVlZGVkCnZhciBmaXh1cFRhcEhpZ2hsaWdodENhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgZml4dXBUYXBIaWdobGlnaHQuY2FsbCh0aGlzKTsKfTsKClRob3JheC5WaWV3Lm9uKHsKICAncmVuZGVyZWQnOiBmaXh1cFRhcEhpZ2hsaWdodENhbGxiYWNrLAogICdyZW5kZXJlZDpjb2xsZWN0aW9uJzogZml4dXBUYXBIaWdobGlnaHRDYWxsYmFjaywKICAncmVuZGVyZWQ6aXRlbSc6IGZpeHVwVGFwSGlnaGxpZ2h0Q2FsbGJhY2ssCiAgJ3JlbmRlcmVkOmVtcHR5JzogZml4dXBUYXBIaWdobGlnaHRDYWxsYmFjawp9KTsKCnZhciBfc2V0RWxlbWVudCA9IFRob3JheC5WaWV3LnByb3RvdHlwZS5zZXRFbGVtZW50LAogICAgdGFwSGlnaGxpZ2h0U2VsZWN0b3IgPSAnW2RhdGEtdGFwcGFibGU9dHJ1ZV0sIGEsIGlucHV0LCBidXR0b24sIHNlbGVjdCwgdGV4dGFyZWEnOwoKVGhvcmF4LlZpZXcucHJvdG90eXBlLnNldEVsZW1lbnQgPSBmdW5jdGlvbigpIHsKICB2YXIgcmVzcG9uc2UgPSBfc2V0RWxlbWVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIGlmICghdGhpcy5ub1RhcEhpZ2hsaWdodCkgewogICAgaWYgKCF1c2VOYXRpdmVIaWdobGlnaHQpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBmdW5jdGlvbiBleGVjKG5hbWUpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzZWxmW25hbWVdLmFwcGx5KHNlbGYsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgVGhvcmF4Lm9uRXhjZXB0aW9uKG5hbWUsIGUpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KICAgICAgdGhpcy4kZWwudGFwSG9sZEFuZEVuZCh0YXBIaWdobGlnaHRTZWxlY3RvciwgZXhlYygnX3RhcEhpZ2hsaWdodFN0YXJ0JyksIGV4ZWMoJ190YXBIaWdobGlnaHRFbmQnKSk7CiAgICB9CiAgfQogIHJldHVybiByZXNwb25zZTsKfTsKCnZhciBfYWRkRXZlbnQgPSBUaG9yYXguVmlldy5wcm90b3R5cGUuX2FkZEV2ZW50OwpUaG9yYXguVmlldy5wcm90b3R5cGUuX2FkZEV2ZW50ID0gZnVuY3Rpb24ocGFyYW1zKSB7CiAgdGhpcy5fZG9tRXZlbnRzID0gdGhpcy5fZG9tRXZlbnRzIHx8IFtdOwogIChwYXJhbXMudHlwZSA9PT0gIkRPTSIpICYmIHRoaXMuX2RvbUV2ZW50cy5wdXNoKHBhcmFtcy5vcmlnaW5hbE5hbWUpOwogIGlzTW9iaWxlICYmIChwYXJhbXMubmFtZSA9IHBhcmFtcy5uYW1lLnJlcGxhY2UoL15jbGlja1xiLywgVGhvcmF4Ll9mYXN0Q2xpY2tFdmVudE5hbWUpKTsKICByZXR1cm4gX2FkZEV2ZW50LmNhbGwodGhpcywgcGFyYW1zKTsKfTsKCjs7CgoKfSkoKTsKCg==",
                "body": "LyogWmVwdG8gdjEuMHJjMSAtIHBvbHlmaWxsIHplcHRvIGV2ZW50IGRldGVjdCBmeCBhamF4IGZvcm0gdG91Y2ggLSB6ZXB0b2pzLmNvbS9saWNlbnNlICovCjsoZnVuY3Rpb24odW5kZWZpbmVkKXsKICBpZiAoU3RyaW5nLnByb3RvdHlwZS50cmltID09PSB1bmRlZmluZWQpIC8vIGZpeCBmb3IgaU9TIDMuMgogICAgU3RyaW5nLnByb3RvdHlwZS50cmltID0gZnVuY3Rpb24oKXsgcmV0dXJuIHRoaXMucmVwbGFjZSgvXlxzKy8sICcnKS5yZXBsYWNlKC9ccyskLywgJycpIH0KCiAgLy8gRm9yIGlPUyAzLngKICAvLyBmcm9tIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL0FycmF5L3JlZHVjZQogIGlmIChBcnJheS5wcm90b3R5cGUucmVkdWNlID09PSB1bmRlZmluZWQpCiAgICBBcnJheS5wcm90b3R5cGUucmVkdWNlID0gZnVuY3Rpb24oZnVuKXsKICAgICAgaWYodGhpcyA9PT0gdm9pZCAwIHx8IHRoaXMgPT09IG51bGwpIHRocm93IG5ldyBUeXBlRXJyb3IoKQogICAgICB2YXIgdCA9IE9iamVjdCh0aGlzKSwgbGVuID0gdC5sZW5ndGggPj4+IDAsIGsgPSAwLCBhY2N1bXVsYXRvcgogICAgICBpZih0eXBlb2YgZnVuICE9ICdmdW5jdGlvbicpIHRocm93IG5ldyBUeXBlRXJyb3IoKQogICAgICBpZihsZW4gPT0gMCAmJiBhcmd1bWVudHMubGVuZ3RoID09IDEpIHRocm93IG5ldyBUeXBlRXJyb3IoKQoKICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aCA+PSAyKQogICAgICAgYWNjdW11bGF0b3IgPSBhcmd1bWVudHNbMV0KICAgICAgZWxzZQogICAgICAgIGRvewogICAgICAgICAgaWYoayBpbiB0KXsKICAgICAgICAgICAgYWNjdW11bGF0b3IgPSB0W2srK10KICAgICAgICAgICAgYnJlYWsKICAgICAgICAgIH0KICAgICAgICAgIGlmKCsrayA+PSBsZW4pIHRocm93IG5ldyBUeXBlRXJyb3IoKQogICAgICAgIH0gd2hpbGUgKHRydWUpCgogICAgICB3aGlsZSAoayA8IGxlbil7CiAgICAgICAgaWYoayBpbiB0KSBhY2N1bXVsYXRvciA9IGZ1bi5jYWxsKHVuZGVmaW5lZCwgYWNjdW11bGF0b3IsIHRba10sIGssIHQpCiAgICAgICAgaysrCiAgICAgIH0KICAgICAgcmV0dXJuIGFjY3VtdWxhdG9yCiAgICB9Cgp9KSgpCnZhciBaZXB0byA9IChmdW5jdGlvbigpIHsKICB2YXIgdW5kZWZpbmVkLCBrZXksICQsIGNsYXNzTGlzdCwgZW1wdHlBcnJheSA9IFtdLCBzbGljZSA9IGVtcHR5QXJyYXkuc2xpY2UsCiAgICBkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudCwKICAgIGVsZW1lbnREaXNwbGF5ID0ge30sIGNsYXNzQ2FjaGUgPSB7fSwKICAgIGdldENvbXB1dGVkU3R5bGUgPSBkb2N1bWVudC5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlLAogICAgY3NzTnVtYmVyID0geyAnY29sdW1uLWNvdW50JzogMSwgJ2NvbHVtbnMnOiAxLCAnZm9udC13ZWlnaHQnOiAxLCAnbGluZS1oZWlnaHQnOiAxLCdvcGFjaXR5JzogMSwgJ3otaW5kZXgnOiAxLCAnem9vbSc6IDEgfSwKICAgIGZyYWdtZW50UkUgPSAvXlxzKjwoXHcrfCEpW14+XSo+LywKCiAgICAvLyBVc2VkIGJ5IGAkLnplcHRvLmluaXRgIHRvIHdyYXAgZWxlbWVudHMsIHRleHQvY29tbWVudCBub2RlcywgZG9jdW1lbnQsCiAgICAvLyBhbmQgZG9jdW1lbnQgZnJhZ21lbnQgbm9kZSB0eXBlcy4KICAgIGVsZW1lbnRUeXBlcyA9IFsxLCAzLCA4LCA5LCAxMV0sCgogICAgYWRqYWNlbmN5T3BlcmF0b3JzID0gWyAnYWZ0ZXInLCAncHJlcGVuZCcsICdiZWZvcmUnLCAnYXBwZW5kJyBdLAogICAgdGFibGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0YWJsZScpLAogICAgdGFibGVSb3cgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0cicpLAogICAgY29udGFpbmVycyA9IHsKICAgICAgJ3RyJzogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGJvZHknKSwKICAgICAgJ3Rib2R5JzogdGFibGUsICd0aGVhZCc6IHRhYmxlLCAndGZvb3QnOiB0YWJsZSwKICAgICAgJ3RkJzogdGFibGVSb3csICd0aCc6IHRhYmxlUm93LAogICAgICAnKic6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpCiAgICB9LAogICAgcmVhZHlSRSA9IC9jb21wbGV0ZXxsb2FkZWR8aW50ZXJhY3RpdmUvLAogICAgY2xhc3NTZWxlY3RvclJFID0gL15cLihbXHctXSspJC8sCiAgICBpZFNlbGVjdG9yUkUgPSAvXiMoW1x3LV0rKSQvLAogICAgdGFnU2VsZWN0b3JSRSA9IC9eW1x3LV0rJC8sCiAgICB0b1N0cmluZyA9ICh7fSkudG9TdHJpbmcsCiAgICB6ZXB0byA9IHt9LAogICAgY2FtZWxpemUsIHVuaXEsCiAgICB0ZW1wUGFyZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykKCiAgemVwdG8ubWF0Y2hlcyA9IGZ1bmN0aW9uKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICBpZiAoIWVsZW1lbnQgfHwgZWxlbWVudC5ub2RlVHlwZSAhPT0gMSkgcmV0dXJuIGZhbHNlCiAgICB2YXIgbWF0Y2hlc1NlbGVjdG9yID0gZWxlbWVudC53ZWJraXRNYXRjaGVzU2VsZWN0b3IgfHwgZWxlbWVudC5tb3pNYXRjaGVzU2VsZWN0b3IgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lm9NYXRjaGVzU2VsZWN0b3IgfHwgZWxlbWVudC5tYXRjaGVzU2VsZWN0b3IKICAgIGlmIChtYXRjaGVzU2VsZWN0b3IpIHJldHVybiBtYXRjaGVzU2VsZWN0b3IuY2FsbChlbGVtZW50LCBzZWxlY3RvcikKICAgIC8vIGZhbGwgYmFjayB0byBwZXJmb3JtaW5nIGEgc2VsZWN0b3I6CiAgICB2YXIgbWF0Y2gsIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZSwgdGVtcCA9ICFwYXJlbnQKICAgIGlmICh0ZW1wKSAocGFyZW50ID0gdGVtcFBhcmVudCkuYXBwZW5kQ2hpbGQoZWxlbWVudCkKICAgIG1hdGNoID0gfnplcHRvLnFzYShwYXJlbnQsIHNlbGVjdG9yKS5pbmRleE9mKGVsZW1lbnQpCiAgICB0ZW1wICYmIHRlbXBQYXJlbnQucmVtb3ZlQ2hpbGQoZWxlbWVudCkKICAgIHJldHVybiBtYXRjaAogIH0KCiAgZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSkgeyByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gIltvYmplY3QgRnVuY3Rpb25dIiB9CiAgZnVuY3Rpb24gaXNPYmplY3QodmFsdWUpIHsgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgT2JqZWN0IH0KICBmdW5jdGlvbiBpc1BsYWluT2JqZWN0KHZhbHVlKSB7CiAgICB2YXIga2V5LCBjdG9yCiAgICBpZiAodG9TdHJpbmcuY2FsbCh2YWx1ZSkgIT09ICJbb2JqZWN0IE9iamVjdF0iKSByZXR1cm4gZmFsc2UKICAgIGN0b3IgPSAoaXNGdW5jdGlvbih2YWx1ZS5jb25zdHJ1Y3RvcikgJiYgdmFsdWUuY29uc3RydWN0b3IucHJvdG90eXBlKQogICAgaWYgKCFjdG9yIHx8ICFoYXNPd25Qcm9wZXJ0eS5jYWxsKGN0b3IsICdpc1Byb3RvdHlwZU9mJykpIHJldHVybiBmYWxzZQogICAgZm9yIChrZXkgaW4gdmFsdWUpOwogICAgcmV0dXJuIGtleSA9PT0gdW5kZWZpbmVkIHx8IGhhc093blByb3BlcnR5LmNhbGwodmFsdWUsIGtleSkKICB9CiAgZnVuY3Rpb24gaXNBcnJheSh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBBcnJheSB9CiAgZnVuY3Rpb24gbGlrZUFycmF5KG9iaikgeyByZXR1cm4gdHlwZW9mIG9iai5sZW5ndGggPT0gJ251bWJlcicgfQoKICBmdW5jdGlvbiBjb21wYWN0KGFycmF5KSB7IHJldHVybiBhcnJheS5maWx0ZXIoZnVuY3Rpb24oaXRlbSl7IHJldHVybiBpdGVtICE9PSB1bmRlZmluZWQgJiYgaXRlbSAhPT0gbnVsbCB9KSB9CiAgZnVuY3Rpb24gZmxhdHRlbihhcnJheSkgeyByZXR1cm4gYXJyYXkubGVuZ3RoID4gMCA/IFtdLmNvbmNhdC5hcHBseShbXSwgYXJyYXkpIDogYXJyYXkgfQogIGNhbWVsaXplID0gZnVuY3Rpb24oc3RyKXsgcmV0dXJuIHN0ci5yZXBsYWNlKC8tKyguKT8vZywgZnVuY3Rpb24obWF0Y2gsIGNocil7IHJldHVybiBjaHIgPyBjaHIudG9VcHBlckNhc2UoKSA6ICcnIH0pIH0KICBmdW5jdGlvbiBkYXNoZXJpemUoc3RyKSB7CiAgICByZXR1cm4gc3RyLnJlcGxhY2UoLzo6L2csICcvJykKICAgICAgICAgICAucmVwbGFjZSgvKFtBLVpdKykoW0EtWl1bYS16XSkvZywgJyQxXyQyJykKICAgICAgICAgICAucmVwbGFjZSgvKFthLXpcZF0pKFtBLVpdKS9nLCAnJDFfJDInKQogICAgICAgICAgIC5yZXBsYWNlKC9fL2csICctJykKICAgICAgICAgICAudG9Mb3dlckNhc2UoKQogIH0KICB1bmlxID0gZnVuY3Rpb24oYXJyYXkpeyByZXR1cm4gYXJyYXkuZmlsdGVyKGZ1bmN0aW9uKGl0ZW0sIGlkeCl7IHJldHVybiBhcnJheS5pbmRleE9mKGl0ZW0pID09IGlkeCB9KSB9CgogIGZ1bmN0aW9uIGNsYXNzUkUobmFtZSkgewogICAgcmV0dXJuIG5hbWUgaW4gY2xhc3NDYWNoZSA/CiAgICAgIGNsYXNzQ2FjaGVbbmFtZV0gOiAoY2xhc3NDYWNoZVtuYW1lXSA9IG5ldyBSZWdFeHAoJyhefFxccyknICsgbmFtZSArICcoXFxzfCQpJykpCiAgfQoKICBmdW5jdGlvbiBtYXliZUFkZFB4KG5hbWUsIHZhbHVlKSB7CiAgICByZXR1cm4gKHR5cGVvZiB2YWx1ZSA9PSAibnVtYmVyIiAmJiAhY3NzTnVtYmVyW2Rhc2hlcml6ZShuYW1lKV0pID8gdmFsdWUgKyAicHgiIDogdmFsdWUKICB9CgogIGZ1bmN0aW9uIGRlZmF1bHREaXNwbGF5KG5vZGVOYW1lKSB7CiAgICB2YXIgZWxlbWVudCwgZGlzcGxheQogICAgaWYgKCFlbGVtZW50RGlzcGxheVtub2RlTmFtZV0pIHsKICAgICAgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQobm9kZU5hbWUpCiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZWxlbWVudCkKICAgICAgZGlzcGxheSA9IGdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgJycpLmdldFByb3BlcnR5VmFsdWUoImRpc3BsYXkiKQogICAgICBlbGVtZW50LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWxlbWVudCkKICAgICAgZGlzcGxheSA9PSAibm9uZSIgJiYgKGRpc3BsYXkgPSAiYmxvY2siKQogICAgICBlbGVtZW50RGlzcGxheVtub2RlTmFtZV0gPSBkaXNwbGF5CiAgICB9CiAgICByZXR1cm4gZWxlbWVudERpc3BsYXlbbm9kZU5hbWVdCiAgfQoKICAvLyBgJC56ZXB0by5mcmFnbWVudGAgdGFrZXMgYSBodG1sIHN0cmluZyBhbmQgYW4gb3B0aW9uYWwgdGFnIG5hbWUKICAvLyB0byBnZW5lcmF0ZSBET00gbm9kZXMgbm9kZXMgZnJvbSB0aGUgZ2l2ZW4gaHRtbCBzdHJpbmcuCiAgLy8gVGhlIGdlbmVyYXRlZCBET00gbm9kZXMgYXJlIHJldHVybmVkIGFzIGFuIGFycmF5LgogIC8vIFRoaXMgZnVuY3Rpb24gY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zIGZvciBleGFtcGxlIHRvIG1ha2UKICAvLyBpdCBjb21wYXRpYmxlIHdpdGggYnJvd3NlcnMgdGhhdCBkb24ndCBzdXBwb3J0IHRoZSBET00gZnVsbHkuCiAgemVwdG8uZnJhZ21lbnQgPSBmdW5jdGlvbihodG1sLCBuYW1lKSB7CiAgICBpZiAobmFtZSA9PT0gdW5kZWZpbmVkKSBuYW1lID0gZnJhZ21lbnRSRS50ZXN0KGh0bWwpICYmIFJlZ0V4cC4kMQogICAgaWYgKCEobmFtZSBpbiBjb250YWluZXJzKSkgbmFtZSA9ICcqJwogICAgdmFyIGNvbnRhaW5lciA9IGNvbnRhaW5lcnNbbmFtZV0KICAgIGNvbnRhaW5lci5pbm5lckhUTUwgPSAnJyArIGh0bWwKICAgIHJldHVybiAkLmVhY2goc2xpY2UuY2FsbChjb250YWluZXIuY2hpbGROb2RlcyksIGZ1bmN0aW9uKCl7CiAgICAgIGNvbnRhaW5lci5yZW1vdmVDaGlsZCh0aGlzKQogICAgfSkKICB9CgogIC8vIGAkLnplcHRvLlpgIHN3YXBzIG91dCB0aGUgcHJvdG90eXBlIG9mIHRoZSBnaXZlbiBgZG9tYCBhcnJheQogIC8vIG9mIG5vZGVzIHdpdGggYCQuZm5gIGFuZCB0aHVzIHN1cHBseWluZyBhbGwgdGhlIFplcHRvIGZ1bmN0aW9ucwogIC8vIHRvIHRoZSBhcnJheS4gTm90ZSB0aGF0IGBfX3Byb3RvX19gIGlzIG5vdCBzdXBwb3J0ZWQgb24gSW50ZXJuZXQKICAvLyBFeHBsb3Jlci4gVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zLgogIHplcHRvLlogPSBmdW5jdGlvbihkb20sIHNlbGVjdG9yKSB7CiAgICBkb20gPSBkb20gfHwgW10KICAgIGRvbS5fX3Byb3RvX18gPSBhcmd1bWVudHMuY2FsbGVlLnByb3RvdHlwZQogICAgZG9tLnNlbGVjdG9yID0gc2VsZWN0b3IgfHwgJycKICAgIHJldHVybiBkb20KICB9CgogIC8vIGAkLnplcHRvLmlzWmAgc2hvdWxkIHJldHVybiBgdHJ1ZWAgaWYgdGhlIGdpdmVuIG9iamVjdCBpcyBhIFplcHRvCiAgLy8gY29sbGVjdGlvbi4gVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zLgogIHplcHRvLmlzWiA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgcmV0dXJuIG9iamVjdCBpbnN0YW5jZW9mIHplcHRvLloKICB9CgogIC8vIGAkLnplcHRvLmluaXRgIGlzIFplcHRvJ3MgY291bnRlcnBhcnQgdG8galF1ZXJ5J3MgYCQuZm4uaW5pdGAgYW5kCiAgLy8gdGFrZXMgYSBDU1Mgc2VsZWN0b3IgYW5kIGFuIG9wdGlvbmFsIGNvbnRleHQgKGFuZCBoYW5kbGVzIHZhcmlvdXMKICAvLyBzcGVjaWFsIGNhc2VzKS4KICAvLyBUaGlzIG1ldGhvZCBjYW4gYmUgb3ZlcnJpZGVuIGluIHBsdWdpbnMuCiAgemVwdG8uaW5pdCA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBjb250ZXh0KSB7CiAgICAvLyBJZiBub3RoaW5nIGdpdmVuLCByZXR1cm4gYW4gZW1wdHkgWmVwdG8gY29sbGVjdGlvbgogICAgaWYgKCFzZWxlY3RvcikgcmV0dXJuIHplcHRvLlooKQogICAgLy8gSWYgYSBmdW5jdGlvbiBpcyBnaXZlbiwgY2FsbCBpdCB3aGVuIHRoZSBET00gaXMgcmVhZHkKICAgIGVsc2UgaWYgKGlzRnVuY3Rpb24oc2VsZWN0b3IpKSByZXR1cm4gJChkb2N1bWVudCkucmVhZHkoc2VsZWN0b3IpCiAgICAvLyBJZiBhIFplcHRvIGNvbGxlY3Rpb24gaXMgZ2l2ZW4sIGp1dHMgcmV0dXJuIGl0CiAgICBlbHNlIGlmICh6ZXB0by5pc1ooc2VsZWN0b3IpKSByZXR1cm4gc2VsZWN0b3IKICAgIGVsc2UgewogICAgICB2YXIgZG9tCiAgICAgIC8vIG5vcm1hbGl6ZSBhcnJheSBpZiBhbiBhcnJheSBvZiBub2RlcyBpcyBnaXZlbgogICAgICBpZiAoaXNBcnJheShzZWxlY3RvcikpIGRvbSA9IGNvbXBhY3Qoc2VsZWN0b3IpCiAgICAgIC8vIGlmIGEgSmF2YVNjcmlwdCBvYmplY3QgaXMgZ2l2ZW4sIHJldHVybiBhIGNvcHkgb2YgaXQKICAgICAgLy8gdGhpcyBpcyBhIHNvbWV3aGF0IHBlY3VsaWFyIG9wdGlvbiwgYnV0IHN1cHBvcnRlZCBieQogICAgICAvLyBqUXVlcnkgc28gd2UnbGwgZG8gaXQsIHRvbwogICAgICBlbHNlIGlmIChpc1BsYWluT2JqZWN0KHNlbGVjdG9yKSkKICAgICAgICBkb20gPSBbJC5leHRlbmQoe30sIHNlbGVjdG9yKV0sIHNlbGVjdG9yID0gbnVsbAogICAgICAvLyB3cmFwIHN0dWZmIGxpa2UgYGRvY3VtZW50YCBvciBgd2luZG93YAogICAgICBlbHNlIGlmIChlbGVtZW50VHlwZXMuaW5kZXhPZihzZWxlY3Rvci5ub2RlVHlwZSkgPj0gMCB8fCBzZWxlY3RvciA9PT0gd2luZG93KQogICAgICAgIGRvbSA9IFtzZWxlY3Rvcl0sIHNlbGVjdG9yID0gbnVsbAogICAgICAvLyBJZiBpdCdzIGEgaHRtbCBmcmFnbWVudCwgY3JlYXRlIG5vZGVzIGZyb20gaXQKICAgICAgZWxzZSBpZiAoZnJhZ21lbnRSRS50ZXN0KHNlbGVjdG9yKSkKICAgICAgICBkb20gPSB6ZXB0by5mcmFnbWVudChzZWxlY3Rvci50cmltKCksIFJlZ0V4cC4kMSksIHNlbGVjdG9yID0gbnVsbAogICAgICAvLyBJZiB0aGVyZSdzIGEgY29udGV4dCwgY3JlYXRlIGEgY29sbGVjdGlvbiBvbiB0aGF0IGNvbnRleHQgZmlyc3QsIGFuZCBzZWxlY3QKICAgICAgLy8gbm9kZXMgZnJvbSB0aGVyZQogICAgICBlbHNlIGlmIChjb250ZXh0ICE9PSB1bmRlZmluZWQpIHJldHVybiAkKGNvbnRleHQpLmZpbmQoc2VsZWN0b3IpCiAgICAgIC8vIEFuZCBsYXN0IGJ1dCBubyBsZWFzdCwgaWYgaXQncyBhIENTUyBzZWxlY3RvciwgdXNlIGl0IHRvIHNlbGVjdCBub2Rlcy4KICAgICAgZWxzZSBkb20gPSB6ZXB0by5xc2EoZG9jdW1lbnQsIHNlbGVjdG9yKQogICAgICAvLyBjcmVhdGUgYSBuZXcgWmVwdG8gY29sbGVjdGlvbiBmcm9tIHRoZSBub2RlcyBmb3VuZAogICAgICByZXR1cm4gemVwdG8uWihkb20sIHNlbGVjdG9yKQogICAgfQogIH0KCiAgLy8gYCRgIHdpbGwgYmUgdGhlIGJhc2UgYFplcHRvYCBvYmplY3QuIFdoZW4gY2FsbGluZyB0aGlzCiAgLy8gZnVuY3Rpb24ganVzdCBjYWxsIGAkLnplcHRvLmluaXQsIHdoaWNocyBtYWtlcyB0aGUgaW1wbGVtZW50YXRpb24KICAvLyBkZXRhaWxzIG9mIHNlbGVjdGluZyBub2RlcyBhbmQgY3JlYXRpbmcgWmVwdG8gY29sbGVjdGlvbnMKICAvLyBwYXRjaGFibGUgaW4gcGx1Z2lucy4KICAkID0gZnVuY3Rpb24oc2VsZWN0b3IsIGNvbnRleHQpewogICAgcmV0dXJuIHplcHRvLmluaXQoc2VsZWN0b3IsIGNvbnRleHQpCiAgfQoKICAvLyBDb3B5IGFsbCBidXQgdW5kZWZpbmVkIHByb3BlcnRpZXMgZnJvbSBvbmUgb3IgbW9yZQogIC8vIG9iamVjdHMgdG8gdGhlIGB0YXJnZXRgIG9iamVjdC4KICAkLmV4dGVuZCA9IGZ1bmN0aW9uKHRhcmdldCl7CiAgICBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkuZm9yRWFjaChmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgZm9yIChrZXkgaW4gc291cmNlKQogICAgICAgIGlmIChzb3VyY2Vba2V5XSAhPT0gdW5kZWZpbmVkKQogICAgICAgICAgdGFyZ2V0W2tleV0gPSBzb3VyY2Vba2V5XQogICAgfSkKICAgIHJldHVybiB0YXJnZXQKICB9CgogIC8vIGAkLnplcHRvLnFzYWAgaXMgWmVwdG8ncyBDU1Mgc2VsZWN0b3IgaW1wbGVtZW50YXRpb24gd2hpY2gKICAvLyB1c2VzIGBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsYCBhbmQgb3B0aW1pemVzIGZvciBzb21lIHNwZWNpYWwgY2FzZXMsIGxpa2UgYCNpZGAuCiAgLy8gVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zLgogIHplcHRvLnFzYSA9IGZ1bmN0aW9uKGVsZW1lbnQsIHNlbGVjdG9yKXsKICAgIHZhciBmb3VuZAogICAgcmV0dXJuIChlbGVtZW50ID09PSBkb2N1bWVudCAmJiBpZFNlbGVjdG9yUkUudGVzdChzZWxlY3RvcikpID8KICAgICAgKCAoZm91bmQgPSBlbGVtZW50LmdldEVsZW1lbnRCeUlkKFJlZ0V4cC4kMSkpID8gW2ZvdW5kXSA6IGVtcHR5QXJyYXkgKSA6CiAgICAgIChlbGVtZW50Lm5vZGVUeXBlICE9PSAxICYmIGVsZW1lbnQubm9kZVR5cGUgIT09IDkpID8gZW1wdHlBcnJheSA6CiAgICAgIHNsaWNlLmNhbGwoCiAgICAgICAgY2xhc3NTZWxlY3RvclJFLnRlc3Qoc2VsZWN0b3IpID8gZWxlbWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKFJlZ0V4cC4kMSkgOgogICAgICAgIHRhZ1NlbGVjdG9yUkUudGVzdChzZWxlY3RvcikgPyBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKHNlbGVjdG9yKSA6CiAgICAgICAgZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKQogICAgICApCiAgfQoKICBmdW5jdGlvbiBmaWx0ZXJlZChub2Rlcywgc2VsZWN0b3IpIHsKICAgIHJldHVybiBzZWxlY3RvciA9PT0gdW5kZWZpbmVkID8gJChub2RlcykgOiAkKG5vZGVzKS5maWx0ZXIoc2VsZWN0b3IpCiAgfQoKICBmdW5jdGlvbiBmdW5jQXJnKGNvbnRleHQsIGFyZywgaWR4LCBwYXlsb2FkKSB7CiAgIHJldHVybiBpc0Z1bmN0aW9uKGFyZykgPyBhcmcuY2FsbChjb250ZXh0LCBpZHgsIHBheWxvYWQpIDogYXJnCiAgfQoKICAkLmlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uCiAgJC5pc09iamVjdCA9IGlzT2JqZWN0CiAgJC5pc0FycmF5ID0gaXNBcnJheQogICQuaXNQbGFpbk9iamVjdCA9IGlzUGxhaW5PYmplY3QKCiAgJC5pbkFycmF5ID0gZnVuY3Rpb24oZWxlbSwgYXJyYXksIGkpewogICAgcmV0dXJuIGVtcHR5QXJyYXkuaW5kZXhPZi5jYWxsKGFycmF5LCBlbGVtLCBpKQogIH0KCiAgJC50cmltID0gZnVuY3Rpb24oc3RyKSB7IHJldHVybiBzdHIudHJpbSgpIH0KCiAgLy8gcGx1Z2luIGNvbXBhdGliaWxpdHkKICAkLnV1aWQgPSAwCgogICQubWFwID0gZnVuY3Rpb24oZWxlbWVudHMsIGNhbGxiYWNrKXsKICAgIHZhciB2YWx1ZSwgdmFsdWVzID0gW10sIGksIGtleQogICAgaWYgKGxpa2VBcnJheShlbGVtZW50cykpCiAgICAgIGZvciAoaSA9IDA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhbHVlID0gY2FsbGJhY2soZWxlbWVudHNbaV0sIGkpCiAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHZhbHVlcy5wdXNoKHZhbHVlKQogICAgICB9CiAgICBlbHNlCiAgICAgIGZvciAoa2V5IGluIGVsZW1lbnRzKSB7CiAgICAgICAgdmFsdWUgPSBjYWxsYmFjayhlbGVtZW50c1trZXldLCBrZXkpCiAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHZhbHVlcy5wdXNoKHZhbHVlKQogICAgICB9CiAgICByZXR1cm4gZmxhdHRlbih2YWx1ZXMpCiAgfQoKICAkLmVhY2ggPSBmdW5jdGlvbihlbGVtZW50cywgY2FsbGJhY2spewogICAgdmFyIGksIGtleQogICAgaWYgKGxpa2VBcnJheShlbGVtZW50cykpIHsKICAgICAgZm9yIChpID0gMDsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKQogICAgICAgIGlmIChjYWxsYmFjay5jYWxsKGVsZW1lbnRzW2ldLCBpLCBlbGVtZW50c1tpXSkgPT09IGZhbHNlKSByZXR1cm4gZWxlbWVudHMKICAgIH0gZWxzZSB7CiAgICAgIGZvciAoa2V5IGluIGVsZW1lbnRzKQogICAgICAgIGlmIChjYWxsYmFjay5jYWxsKGVsZW1lbnRzW2tleV0sIGtleSwgZWxlbWVudHNba2V5XSkgPT09IGZhbHNlKSByZXR1cm4gZWxlbWVudHMKICAgIH0KCiAgICByZXR1cm4gZWxlbWVudHMKICB9CgogIC8vIERlZmluZSBtZXRob2RzIHRoYXQgd2lsbCBiZSBhdmFpbGFibGUgb24gYWxsCiAgLy8gWmVwdG8gY29sbGVjdGlvbnMKICAkLmZuID0gewogICAgLy8gQmVjYXVzZSBhIGNvbGxlY3Rpb24gYWN0cyBsaWtlIGFuIGFycmF5CiAgICAvLyBjb3B5IG92ZXIgdGhlc2UgdXNlZnVsIGFycmF5IGZ1bmN0aW9ucy4KICAgIGZvckVhY2g6IGVtcHR5QXJyYXkuZm9yRWFjaCwKICAgIHJlZHVjZTogZW1wdHlBcnJheS5yZWR1Y2UsCiAgICBwdXNoOiBlbXB0eUFycmF5LnB1c2gsCiAgICBpbmRleE9mOiBlbXB0eUFycmF5LmluZGV4T2YsCiAgICBjb25jYXQ6IGVtcHR5QXJyYXkuY29uY2F0LAoKICAgIC8vIGBtYXBgIGFuZCBgc2xpY2VgIGluIHRoZSBqUXVlcnkgQVBJIHdvcmsgZGlmZmVyZW50bHkKICAgIC8vIGZyb20gdGhlaXIgYXJyYXkgY291bnRlcnBhcnRzCiAgICBtYXA6IGZ1bmN0aW9uKGZuKXsKICAgICAgcmV0dXJuICQubWFwKHRoaXMsIGZ1bmN0aW9uKGVsLCBpKXsgcmV0dXJuIGZuLmNhbGwoZWwsIGksIGVsKSB9KQogICAgfSwKICAgIHNsaWNlOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gJChzbGljZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKQogICAgfSwKCiAgICByZWFkeTogZnVuY3Rpb24oY2FsbGJhY2spewogICAgICBpZiAocmVhZHlSRS50ZXN0KGRvY3VtZW50LnJlYWR5U3RhdGUpKSBjYWxsYmFjaygkKQogICAgICBlbHNlIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBmdW5jdGlvbigpeyBjYWxsYmFjaygkKSB9LCBmYWxzZSkKICAgICAgcmV0dXJuIHRoaXMKICAgIH0sCiAgICBnZXQ6IGZ1bmN0aW9uKGlkeCl7CiAgICAgIHJldHVybiBpZHggPT09IHVuZGVmaW5lZCA/IHNsaWNlLmNhbGwodGhpcykgOiB0aGlzW2lkeF0KICAgIH0sCiAgICB0b0FycmF5OiBmdW5jdGlvbigpeyByZXR1cm4gdGhpcy5nZXQoKSB9LAogICAgc2l6ZTogZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIHRoaXMubGVuZ3RoCiAgICB9LAogICAgcmVtb3ZlOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSAhPSBudWxsKQogICAgICAgICAgdGhpcy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMpCiAgICAgIH0pCiAgICB9LAogICAgZWFjaDogZnVuY3Rpb24oY2FsbGJhY2spewogICAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24oZWwsIGlkeCl7IGNhbGxiYWNrLmNhbGwoZWwsIGlkeCwgZWwpIH0pCiAgICAgIHJldHVybiB0aGlzCiAgICB9LAogICAgZmlsdGVyOiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHJldHVybiAkKFtdLmZpbHRlci5jYWxsKHRoaXMsIGZ1bmN0aW9uKGVsZW1lbnQpewogICAgICAgIHJldHVybiB6ZXB0by5tYXRjaGVzKGVsZW1lbnQsIHNlbGVjdG9yKQogICAgICB9KSkKICAgIH0sCiAgICBhZGQ6IGZ1bmN0aW9uKHNlbGVjdG9yLGNvbnRleHQpewogICAgICByZXR1cm4gJCh1bmlxKHRoaXMuY29uY2F0KCQoc2VsZWN0b3IsY29udGV4dCkpKSkKICAgIH0sCiAgICBpczogZnVuY3Rpb24oc2VsZWN0b3IpewogICAgICByZXR1cm4gdGhpcy5sZW5ndGggPiAwICYmIHplcHRvLm1hdGNoZXModGhpc1swXSwgc2VsZWN0b3IpCiAgICB9LAogICAgbm90OiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHZhciBub2Rlcz1bXQogICAgICBpZiAoaXNGdW5jdGlvbihzZWxlY3RvcikgJiYgc2VsZWN0b3IuY2FsbCAhPT0gdW5kZWZpbmVkKQogICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgICAgaWYgKCFzZWxlY3Rvci5jYWxsKHRoaXMsaWR4KSkgbm9kZXMucHVzaCh0aGlzKQogICAgICAgIH0pCiAgICAgIGVsc2UgewogICAgICAgIHZhciBleGNsdWRlcyA9IHR5cGVvZiBzZWxlY3RvciA9PSAnc3RyaW5nJyA/IHRoaXMuZmlsdGVyKHNlbGVjdG9yKSA6CiAgICAgICAgICAobGlrZUFycmF5KHNlbGVjdG9yKSAmJiBpc0Z1bmN0aW9uKHNlbGVjdG9yLml0ZW0pKSA/IHNsaWNlLmNhbGwoc2VsZWN0b3IpIDogJChzZWxlY3RvcikKICAgICAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24oZWwpewogICAgICAgICAgaWYgKGV4Y2x1ZGVzLmluZGV4T2YoZWwpIDwgMCkgbm9kZXMucHVzaChlbCkKICAgICAgICB9KQogICAgICB9CiAgICAgIHJldHVybiAkKG5vZGVzKQogICAgfSwKICAgIGVxOiBmdW5jdGlvbihpZHgpewogICAgICByZXR1cm4gaWR4ID09PSAtMSA/IHRoaXMuc2xpY2UoaWR4KSA6IHRoaXMuc2xpY2UoaWR4LCArIGlkeCArIDEpCiAgICB9LAogICAgZmlyc3Q6IGZ1bmN0aW9uKCl7CiAgICAgIHZhciBlbCA9IHRoaXNbMF0KICAgICAgcmV0dXJuIGVsICYmICFpc09iamVjdChlbCkgPyBlbCA6ICQoZWwpCiAgICB9LAogICAgbGFzdDogZnVuY3Rpb24oKXsKICAgICAgdmFyIGVsID0gdGhpc1t0aGlzLmxlbmd0aCAtIDFdCiAgICAgIHJldHVybiBlbCAmJiAhaXNPYmplY3QoZWwpID8gZWwgOiAkKGVsKQogICAgfSwKICAgIGZpbmQ6IGZ1bmN0aW9uKHNlbGVjdG9yKXsKICAgICAgdmFyIHJlc3VsdAogICAgICBpZiAodGhpcy5sZW5ndGggPT0gMSkgcmVzdWx0ID0gemVwdG8ucXNhKHRoaXNbMF0sIHNlbGVjdG9yKQogICAgICBlbHNlIHJlc3VsdCA9IHRoaXMubWFwKGZ1bmN0aW9uKCl7IHJldHVybiB6ZXB0by5xc2EodGhpcywgc2VsZWN0b3IpIH0pCiAgICAgIHJldHVybiAkKHJlc3VsdCkKICAgIH0sCiAgICBjbG9zZXN0OiBmdW5jdGlvbihzZWxlY3RvciwgY29udGV4dCl7CiAgICAgIHZhciBub2RlID0gdGhpc1swXQogICAgICB3aGlsZSAobm9kZSAmJiAhemVwdG8ubWF0Y2hlcyhub2RlLCBzZWxlY3RvcikpCiAgICAgICAgbm9kZSA9IG5vZGUgIT09IGNvbnRleHQgJiYgbm9kZSAhPT0gZG9jdW1lbnQgJiYgbm9kZS5wYXJlbnROb2RlCiAgICAgIHJldHVybiAkKG5vZGUpCiAgICB9LAogICAgcGFyZW50czogZnVuY3Rpb24oc2VsZWN0b3IpewogICAgICB2YXIgYW5jZXN0b3JzID0gW10sIG5vZGVzID0gdGhpcwogICAgICB3aGlsZSAobm9kZXMubGVuZ3RoID4gMCkKICAgICAgICBub2RlcyA9ICQubWFwKG5vZGVzLCBmdW5jdGlvbihub2RlKXsKICAgICAgICAgIGlmICgobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkgJiYgbm9kZSAhPT0gZG9jdW1lbnQgJiYgYW5jZXN0b3JzLmluZGV4T2Yobm9kZSkgPCAwKSB7CiAgICAgICAgICAgIGFuY2VzdG9ycy5wdXNoKG5vZGUpCiAgICAgICAgICAgIHJldHVybiBub2RlCiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgcmV0dXJuIGZpbHRlcmVkKGFuY2VzdG9ycywgc2VsZWN0b3IpCiAgICB9LAogICAgcGFyZW50OiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHJldHVybiBmaWx0ZXJlZCh1bmlxKHRoaXMucGx1Y2soJ3BhcmVudE5vZGUnKSksIHNlbGVjdG9yKQogICAgfSwKICAgIGNoaWxkcmVuOiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHJldHVybiBmaWx0ZXJlZCh0aGlzLm1hcChmdW5jdGlvbigpeyByZXR1cm4gc2xpY2UuY2FsbCh0aGlzLmNoaWxkcmVuKSB9KSwgc2VsZWN0b3IpCiAgICB9LAogICAgc2libGluZ3M6IGZ1bmN0aW9uKHNlbGVjdG9yKXsKICAgICAgcmV0dXJuIGZpbHRlcmVkKHRoaXMubWFwKGZ1bmN0aW9uKGksIGVsKXsKICAgICAgICByZXR1cm4gc2xpY2UuY2FsbChlbC5wYXJlbnROb2RlLmNoaWxkcmVuKS5maWx0ZXIoZnVuY3Rpb24oY2hpbGQpeyByZXR1cm4gY2hpbGQhPT1lbCB9KQogICAgICB9KSwgc2VsZWN0b3IpCiAgICB9LAogICAgZW1wdHk6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsgdGhpcy5pbm5lckhUTUwgPSAnJyB9KQogICAgfSwKICAgIC8vIGBwbHVja2AgaXMgYm9ycm93ZWQgZnJvbSBQcm90b3R5cGUuanMKICAgIHBsdWNrOiBmdW5jdGlvbihwcm9wZXJ0eSl7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbigpeyByZXR1cm4gdGhpc1twcm9wZXJ0eV0gfSkKICAgIH0sCiAgICBzaG93OiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5zdHlsZS5kaXNwbGF5ID09ICJub25lIiAmJiAodGhpcy5zdHlsZS5kaXNwbGF5ID0gbnVsbCkKICAgICAgICBpZiAoZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLCAnJykuZ2V0UHJvcGVydHlWYWx1ZSgiZGlzcGxheSIpID09ICJub25lIikKICAgICAgICAgIHRoaXMuc3R5bGUuZGlzcGxheSA9IGRlZmF1bHREaXNwbGF5KHRoaXMubm9kZU5hbWUpCiAgICAgIH0pCiAgICB9LAogICAgcmVwbGFjZVdpdGg6IGZ1bmN0aW9uKG5ld0NvbnRlbnQpewogICAgICByZXR1cm4gdGhpcy5iZWZvcmUobmV3Q29udGVudCkucmVtb3ZlKCkKICAgIH0sCiAgICB3cmFwOiBmdW5jdGlvbihuZXdDb250ZW50KXsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICAgICQodGhpcykud3JhcEFsbCgkKG5ld0NvbnRlbnQpWzBdLmNsb25lTm9kZShmYWxzZSkpCiAgICAgIH0pCiAgICB9LAogICAgd3JhcEFsbDogZnVuY3Rpb24obmV3Q29udGVudCl7CiAgICAgIGlmICh0aGlzWzBdKSB7CiAgICAgICAgJCh0aGlzWzBdKS5iZWZvcmUobmV3Q29udGVudCA9ICQobmV3Q29udGVudCkpCiAgICAgICAgbmV3Q29udGVudC5hcHBlbmQodGhpcykKICAgICAgfQogICAgICByZXR1cm4gdGhpcwogICAgfSwKICAgIHVud3JhcDogZnVuY3Rpb24oKXsKICAgICAgdGhpcy5wYXJlbnQoKS5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgJCh0aGlzKS5yZXBsYWNlV2l0aCgkKHRoaXMpLmNoaWxkcmVuKCkpCiAgICAgIH0pCiAgICAgIHJldHVybiB0aGlzCiAgICB9LAogICAgY2xvbmU6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiAkKHRoaXMubWFwKGZ1bmN0aW9uKCl7IHJldHVybiB0aGlzLmNsb25lTm9kZSh0cnVlKSB9KSkKICAgIH0sCiAgICBoaWRlOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5jc3MoImRpc3BsYXkiLCAibm9uZSIpCiAgICB9LAogICAgdG9nZ2xlOiBmdW5jdGlvbihzZXR0aW5nKXsKICAgICAgcmV0dXJuIChzZXR0aW5nID09PSB1bmRlZmluZWQgPyB0aGlzLmNzcygiZGlzcGxheSIpID09ICJub25lIiA6IHNldHRpbmcpID8gdGhpcy5zaG93KCkgOiB0aGlzLmhpZGUoKQogICAgfSwKICAgIHByZXY6IGZ1bmN0aW9uKCl7IHJldHVybiAkKHRoaXMucGx1Y2soJ3ByZXZpb3VzRWxlbWVudFNpYmxpbmcnKSkgfSwKICAgIG5leHQ6IGZ1bmN0aW9uKCl7IHJldHVybiAkKHRoaXMucGx1Y2soJ25leHRFbGVtZW50U2libGluZycpKSB9LAogICAgaHRtbDogZnVuY3Rpb24oaHRtbCl7CiAgICAgIHJldHVybiBodG1sID09PSB1bmRlZmluZWQgPwogICAgICAgICh0aGlzLmxlbmd0aCA+IDAgPyB0aGlzWzBdLmlubmVySFRNTCA6IG51bGwpIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIHZhciBvcmlnaW5IdG1sID0gdGhpcy5pbm5lckhUTUwKICAgICAgICAgICQodGhpcykuZW1wdHkoKS5hcHBlbmQoIGZ1bmNBcmcodGhpcywgaHRtbCwgaWR4LCBvcmlnaW5IdG1sKSApCiAgICAgICAgfSkKICAgIH0sCiAgICB0ZXh0OiBmdW5jdGlvbih0ZXh0KXsKICAgICAgcmV0dXJuIHRleHQgPT09IHVuZGVmaW5lZCA/CiAgICAgICAgKHRoaXMubGVuZ3RoID4gMCA/IHRoaXNbMF0udGV4dENvbnRlbnQgOiBudWxsKSA6CiAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMudGV4dENvbnRlbnQgPSB0ZXh0IH0pCiAgICB9LAogICAgYXR0cjogZnVuY3Rpb24obmFtZSwgdmFsdWUpewogICAgICB2YXIgcmVzdWx0CiAgICAgIHJldHVybiAodHlwZW9mIG5hbWUgPT0gJ3N0cmluZycgJiYgdmFsdWUgPT09IHVuZGVmaW5lZCkgPwogICAgICAgICh0aGlzLmxlbmd0aCA9PSAwIHx8IHRoaXNbMF0ubm9kZVR5cGUgIT09IDEgPyB1bmRlZmluZWQgOgogICAgICAgICAgKG5hbWUgPT0gJ3ZhbHVlJyAmJiB0aGlzWzBdLm5vZGVOYW1lID09ICdJTlBVVCcpID8gdGhpcy52YWwoKSA6CiAgICAgICAgICAoIShyZXN1bHQgPSB0aGlzWzBdLmdldEF0dHJpYnV0ZShuYW1lKSkgJiYgbmFtZSBpbiB0aGlzWzBdKSA/IHRoaXNbMF1bbmFtZV0gOiByZXN1bHQKICAgICAgICApIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIGlmICh0aGlzLm5vZGVUeXBlICE9PSAxKSByZXR1cm4KICAgICAgICAgIGlmIChpc09iamVjdChuYW1lKSkgZm9yIChrZXkgaW4gbmFtZSkgdGhpcy5zZXRBdHRyaWJ1dGUoa2V5LCBuYW1lW2tleV0pCiAgICAgICAgICBlbHNlIHRoaXMuc2V0QXR0cmlidXRlKG5hbWUsIGZ1bmNBcmcodGhpcywgdmFsdWUsIGlkeCwgdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSkpKQogICAgICAgIH0pCiAgICB9LAogICAgcmVtb3ZlQXR0cjogZnVuY3Rpb24obmFtZSl7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsgaWYgKHRoaXMubm9kZVR5cGUgPT09IDEpIHRoaXMucmVtb3ZlQXR0cmlidXRlKG5hbWUpIH0pCiAgICB9LAogICAgcHJvcDogZnVuY3Rpb24obmFtZSwgdmFsdWUpewogICAgICByZXR1cm4gKHZhbHVlID09PSB1bmRlZmluZWQpID8KICAgICAgICAodGhpc1swXSA/IHRoaXNbMF1bbmFtZV0gOiB1bmRlZmluZWQpIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIHRoaXNbbmFtZV0gPSBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIHRoaXNbbmFtZV0pCiAgICAgICAgfSkKICAgIH0sCiAgICBkYXRhOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSl7CiAgICAgIHZhciBkYXRhID0gdGhpcy5hdHRyKCdkYXRhLScgKyBkYXNoZXJpemUobmFtZSksIHZhbHVlKQogICAgICByZXR1cm4gZGF0YSAhPT0gbnVsbCA/IGRhdGEgOiB1bmRlZmluZWQKICAgIH0sCiAgICB2YWw6IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgcmV0dXJuICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSA/CiAgICAgICAgKHRoaXMubGVuZ3RoID4gMCA/IHRoaXNbMF0udmFsdWUgOiB1bmRlZmluZWQpIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIHRoaXMudmFsdWUgPSBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIHRoaXMudmFsdWUpCiAgICAgICAgfSkKICAgIH0sCiAgICBvZmZzZXQ6IGZ1bmN0aW9uKCl7CiAgICAgIGlmICh0aGlzLmxlbmd0aD09MCkgcmV0dXJuIG51bGwKICAgICAgdmFyIG9iaiA9IHRoaXNbMF0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkKICAgICAgcmV0dXJuIHsKICAgICAgICBsZWZ0OiBvYmoubGVmdCArIHdpbmRvdy5wYWdlWE9mZnNldCwKICAgICAgICB0b3A6IG9iai50b3AgKyB3aW5kb3cucGFnZVlPZmZzZXQsCiAgICAgICAgd2lkdGg6IG9iai53aWR0aCwKICAgICAgICBoZWlnaHQ6IG9iai5oZWlnaHQKICAgICAgfQogICAgfSwKICAgIGNzczogZnVuY3Rpb24ocHJvcGVydHksIHZhbHVlKXsKICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIHByb3BlcnR5ID09ICdzdHJpbmcnKQogICAgICAgIHJldHVybiAoCiAgICAgICAgICB0aGlzLmxlbmd0aCA9PSAwCiAgICAgICAgICAgID8gdW5kZWZpbmVkCiAgICAgICAgICAgIDogdGhpc1swXS5zdHlsZVtjYW1lbGl6ZShwcm9wZXJ0eSldIHx8IGdldENvbXB1dGVkU3R5bGUodGhpc1swXSwgJycpLmdldFByb3BlcnR5VmFsdWUocHJvcGVydHkpKQoKICAgICAgdmFyIGNzcyA9ICcnCiAgICAgIGZvciAoa2V5IGluIHByb3BlcnR5KQogICAgICAgIGlmKHR5cGVvZiBwcm9wZXJ0eVtrZXldID09ICdzdHJpbmcnICYmIHByb3BlcnR5W2tleV0gPT0gJycpCiAgICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oKXsgdGhpcy5zdHlsZS5yZW1vdmVQcm9wZXJ0eShkYXNoZXJpemUoa2V5KSkgfSkKICAgICAgICBlbHNlCiAgICAgICAgICBjc3MgKz0gZGFzaGVyaXplKGtleSkgKyAnOicgKyBtYXliZUFkZFB4KGtleSwgcHJvcGVydHlba2V5XSkgKyAnOycKCiAgICAgIGlmICh0eXBlb2YgcHJvcGVydHkgPT0gJ3N0cmluZycpCiAgICAgICAgaWYgKHZhbHVlID09ICcnKQogICAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMuc3R5bGUucmVtb3ZlUHJvcGVydHkoZGFzaGVyaXplKHByb3BlcnR5KSkgfSkKICAgICAgICBlbHNlCiAgICAgICAgICBjc3MgPSBkYXNoZXJpemUocHJvcGVydHkpICsgIjoiICsgbWF5YmVBZGRQeChwcm9wZXJ0eSwgdmFsdWUpCgogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMuc3R5bGUuY3NzVGV4dCArPSAnOycgKyBjc3MgfSkKICAgIH0sCiAgICBpbmRleDogZnVuY3Rpb24oZWxlbWVudCl7CiAgICAgIHJldHVybiBlbGVtZW50ID8gdGhpcy5pbmRleE9mKCQoZWxlbWVudClbMF0pIDogdGhpcy5wYXJlbnQoKS5jaGlsZHJlbigpLmluZGV4T2YodGhpc1swXSkKICAgIH0sCiAgICBoYXNDbGFzczogZnVuY3Rpb24obmFtZSl7CiAgICAgIGlmICh0aGlzLmxlbmd0aCA8IDEpIHJldHVybiBmYWxzZQogICAgICBlbHNlIHJldHVybiBjbGFzc1JFKG5hbWUpLnRlc3QodGhpc1swXS5jbGFzc05hbWUpCiAgICB9LAogICAgYWRkQ2xhc3M6IGZ1bmN0aW9uKG5hbWUpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGlkeCl7CiAgICAgICAgY2xhc3NMaXN0ID0gW10KICAgICAgICB2YXIgY2xzID0gdGhpcy5jbGFzc05hbWUsIG5ld05hbWUgPSBmdW5jQXJnKHRoaXMsIG5hbWUsIGlkeCwgY2xzKQogICAgICAgIG5ld05hbWUuc3BsaXQoL1xzKy9nKS5mb3JFYWNoKGZ1bmN0aW9uKGtsYXNzKXsKICAgICAgICAgIGlmICghJCh0aGlzKS5oYXNDbGFzcyhrbGFzcykpIGNsYXNzTGlzdC5wdXNoKGtsYXNzKQogICAgICAgIH0sIHRoaXMpCiAgICAgICAgY2xhc3NMaXN0Lmxlbmd0aCAmJiAodGhpcy5jbGFzc05hbWUgKz0gKGNscyA/ICIgIiA6ICIiKSArIGNsYXNzTGlzdC5qb2luKCIgIikpCiAgICAgIH0pCiAgICB9LAogICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKG5hbWUpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGlkeCl7CiAgICAgICAgaWYgKG5hbWUgPT09IHVuZGVmaW5lZCkKICAgICAgICAgIHJldHVybiB0aGlzLmNsYXNzTmFtZSA9ICcnCiAgICAgICAgY2xhc3NMaXN0ID0gdGhpcy5jbGFzc05hbWUKICAgICAgICBmdW5jQXJnKHRoaXMsIG5hbWUsIGlkeCwgY2xhc3NMaXN0KS5zcGxpdCgvXHMrL2cpLmZvckVhY2goZnVuY3Rpb24oa2xhc3MpewogICAgICAgICAgY2xhc3NMaXN0ID0gY2xhc3NMaXN0LnJlcGxhY2UoY2xhc3NSRShrbGFzcyksICIgIikKICAgICAgICB9KQogICAgICAgIHRoaXMuY2xhc3NOYW1lID0gY2xhc3NMaXN0LnRyaW0oKQogICAgICB9KQogICAgfSwKICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbihuYW1lLCB3aGVuKXsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgIHZhciBuZXdOYW1lID0gZnVuY0FyZyh0aGlzLCBuYW1lLCBpZHgsIHRoaXMuY2xhc3NOYW1lKQogICAgICAgIDsod2hlbiA9PT0gdW5kZWZpbmVkID8gISQodGhpcykuaGFzQ2xhc3MobmV3TmFtZSkgOiB3aGVuKSA/CiAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKG5ld05hbWUpIDogJCh0aGlzKS5yZW1vdmVDbGFzcyhuZXdOYW1lKQogICAgICB9KQogICAgfQogIH0KCiAgLy8gR2VuZXJhdGUgdGhlIGB3aWR0aGAgYW5kIGBoZWlnaHRgIGZ1bmN0aW9ucwogIDtbJ3dpZHRoJywgJ2hlaWdodCddLmZvckVhY2goZnVuY3Rpb24oZGltZW5zaW9uKXsKICAgICQuZm5bZGltZW5zaW9uXSA9IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgdmFyIG9mZnNldCwgRGltZW5zaW9uID0gZGltZW5zaW9uLnJlcGxhY2UoLy4vLCBmdW5jdGlvbihtKXsgcmV0dXJuIG1bMF0udG9VcHBlckNhc2UoKSB9KQogICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHRoaXNbMF0gPT0gd2luZG93ID8gd2luZG93Wydpbm5lcicgKyBEaW1lbnNpb25dIDoKICAgICAgICB0aGlzWzBdID09IGRvY3VtZW50ID8gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50WydvZmZzZXQnICsgRGltZW5zaW9uXSA6CiAgICAgICAgKG9mZnNldCA9IHRoaXMub2Zmc2V0KCkpICYmIG9mZnNldFtkaW1lbnNpb25dCiAgICAgIGVsc2UgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgIHZhciBlbCA9ICQodGhpcykKICAgICAgICBlbC5jc3MoZGltZW5zaW9uLCBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIGVsW2RpbWVuc2lvbl0oKSkpCiAgICAgIH0pCiAgICB9CiAgfSkKCiAgZnVuY3Rpb24gaW5zZXJ0KG9wZXJhdG9yLCB0YXJnZXQsIG5vZGUpIHsKICAgIHZhciBwYXJlbnQgPSAob3BlcmF0b3IgJSAyKSA/IHRhcmdldCA6IHRhcmdldC5wYXJlbnROb2RlCiAgICBwYXJlbnQgPyBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsCiAgICAgICFvcGVyYXRvciA/IHRhcmdldC5uZXh0U2libGluZyA6ICAgICAgLy8gYWZ0ZXIKICAgICAgb3BlcmF0b3IgPT0gMSA/IHBhcmVudC5maXJzdENoaWxkIDogICAvLyBwcmVwZW5kCiAgICAgIG9wZXJhdG9yID09IDIgPyB0YXJnZXQgOiAgICAgICAgICAgICAgLy8gYmVmb3JlCiAgICAgIG51bGwpIDogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYXBwZW5kCiAgICAgICQobm9kZSkucmVtb3ZlKCkKICB9CgogIGZ1bmN0aW9uIHRyYXZlcnNlTm9kZShub2RlLCBmdW4pIHsKICAgIGZ1bihub2RlKQogICAgZm9yICh2YXIga2V5IGluIG5vZGUuY2hpbGROb2RlcykgdHJhdmVyc2VOb2RlKG5vZGUuY2hpbGROb2Rlc1trZXldLCBmdW4pCiAgfQoKICAvLyBHZW5lcmF0ZSB0aGUgYGFmdGVyYCwgYHByZXBlbmRgLCBgYmVmb3JlYCwgYGFwcGVuZGAsCiAgLy8gYGluc2VydEFmdGVyYCwgYGluc2VydEJlZm9yZWAsIGBhcHBlbmRUb2AsIGFuZCBgcHJlcGVuZFRvYCBtZXRob2RzLgogIGFkamFjZW5jeU9wZXJhdG9ycy5mb3JFYWNoKGZ1bmN0aW9uKGtleSwgb3BlcmF0b3IpIHsKICAgICQuZm5ba2V5XSA9IGZ1bmN0aW9uKCl7CiAgICAgIC8vIGFyZ3VtZW50cyBjYW4gYmUgbm9kZXMsIGFycmF5cyBvZiBub2RlcywgWmVwdG8gb2JqZWN0cyBhbmQgSFRNTCBzdHJpbmdzCiAgICAgIHZhciBub2RlcyA9ICQubWFwKGFyZ3VtZW50cywgZnVuY3Rpb24obil7IHJldHVybiBpc09iamVjdChuKSA/IG4gOiB6ZXB0by5mcmFnbWVudChuKSB9KQogICAgICBpZiAobm9kZXMubGVuZ3RoIDwgMSkgcmV0dXJuIHRoaXMKICAgICAgdmFyIHNpemUgPSB0aGlzLmxlbmd0aCwgY29weUJ5Q2xvbmUgPSBzaXplID4gMSwgaW5SZXZlcnNlID0gb3BlcmF0b3IgPCAyCgogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGluZGV4LCB0YXJnZXQpewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBub2RlID0gbm9kZXNbaW5SZXZlcnNlID8gbm9kZXMubGVuZ3RoLWktMSA6IGldCiAgICAgICAgICB0cmF2ZXJzZU5vZGUobm9kZSwgZnVuY3Rpb24obm9kZSl7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVOYW1lICE9IG51bGwgJiYgbm9kZS5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpID09PSAnU0NSSVBUJyAmJiAoIW5vZGUudHlwZSB8fCBub2RlLnR5cGUgPT09ICd0ZXh0L2phdmFzY3JpcHQnKSkKICAgICAgICAgICAgICB3aW5kb3dbJ2V2YWwnXS5jYWxsKHdpbmRvdywgbm9kZS5pbm5lckhUTUwpCiAgICAgICAgICB9KQogICAgICAgICAgaWYgKGNvcHlCeUNsb25lICYmIGluZGV4IDwgc2l6ZSAtIDEpIG5vZGUgPSBub2RlLmNsb25lTm9kZSh0cnVlKQogICAgICAgICAgaW5zZXJ0KG9wZXJhdG9yLCB0YXJnZXQsIG5vZGUpCiAgICAgICAgfQogICAgICB9KQogICAgfQoKICAgICQuZm5bKG9wZXJhdG9yICUgMikgPyBrZXkrJ1RvJyA6ICdpbnNlcnQnKyhvcGVyYXRvciA/ICdCZWZvcmUnIDogJ0FmdGVyJyldID0gZnVuY3Rpb24oaHRtbCl7CiAgICAgICQoaHRtbClba2V5XSh0aGlzKQogICAgICByZXR1cm4gdGhpcwogICAgfQogIH0pCgogIHplcHRvLloucHJvdG90eXBlID0gJC5mbgoKICAvLyBFeHBvcnQgaW50ZXJuYWwgQVBJIGZ1bmN0aW9ucyBpbiB0aGUgYCQuemVwdG9gIG5hbWVzcGFjZQogIHplcHRvLmNhbWVsaXplID0gY2FtZWxpemUKICB6ZXB0by51bmlxID0gdW5pcQogICQuemVwdG8gPSB6ZXB0bwoKICByZXR1cm4gJAp9KSgpCgovLyBJZiBgJGAgaXMgbm90IHlldCBkZWZpbmVkLCBwb2ludCBpdCB0byBgWmVwdG9gCndpbmRvdy5aZXB0byA9IFplcHRvCickJyBpbiB3aW5kb3cgfHwgKHdpbmRvdy4kID0gWmVwdG8pCjsoZnVuY3Rpb24oJCl7CiAgdmFyICQkID0gJC56ZXB0by5xc2EsIGhhbmRsZXJzID0ge30sIF96aWQgPSAxLCBzcGVjaWFsRXZlbnRzPXt9CgogIHNwZWNpYWxFdmVudHMuY2xpY2sgPSBzcGVjaWFsRXZlbnRzLm1vdXNlZG93biA9IHNwZWNpYWxFdmVudHMubW91c2V1cCA9IHNwZWNpYWxFdmVudHMubW91c2Vtb3ZlID0gJ01vdXNlRXZlbnRzJwoKICBmdW5jdGlvbiB6aWQoZWxlbWVudCkgewogICAgcmV0dXJuIGVsZW1lbnQuX3ppZCB8fCAoZWxlbWVudC5femlkID0gX3ppZCsrKQogIH0KICBmdW5jdGlvbiBmaW5kSGFuZGxlcnMoZWxlbWVudCwgZXZlbnQsIGZuLCBzZWxlY3RvcikgewogICAgZXZlbnQgPSBwYXJzZShldmVudCkKICAgIGlmIChldmVudC5ucykgdmFyIG1hdGNoZXIgPSBtYXRjaGVyRm9yKGV2ZW50Lm5zKQogICAgcmV0dXJuIChoYW5kbGVyc1t6aWQoZWxlbWVudCldIHx8IFtdKS5maWx0ZXIoZnVuY3Rpb24oaGFuZGxlcikgewogICAgICByZXR1cm4gaGFuZGxlcgogICAgICAgICYmICghZXZlbnQuZSAgfHwgaGFuZGxlci5lID09IGV2ZW50LmUpCiAgICAgICAgJiYgKCFldmVudC5ucyB8fCBtYXRjaGVyLnRlc3QoaGFuZGxlci5ucykpCiAgICAgICAgJiYgKCFmbiAgICAgICB8fCB6aWQoaGFuZGxlci5mbikgPT09IHppZChmbikpCiAgICAgICAgJiYgKCFzZWxlY3RvciB8fCBoYW5kbGVyLnNlbCA9PSBzZWxlY3RvcikKICAgIH0pCiAgfQogIGZ1bmN0aW9uIHBhcnNlKGV2ZW50KSB7CiAgICB2YXIgcGFydHMgPSAoJycgKyBldmVudCkuc3BsaXQoJy4nKQogICAgcmV0dXJuIHtlOiBwYXJ0c1swXSwgbnM6IHBhcnRzLnNsaWNlKDEpLnNvcnQoKS5qb2luKCcgJyl9CiAgfQogIGZ1bmN0aW9uIG1hdGNoZXJGb3IobnMpIHsKICAgIHJldHVybiBuZXcgUmVnRXhwKCcoPzpefCApJyArIG5zLnJlcGxhY2UoJyAnLCAnIC4qID8nKSArICcoPzogfCQpJykKICB9CgogIGZ1bmN0aW9uIGVhY2hFdmVudChldmVudHMsIGZuLCBpdGVyYXRvcil7CiAgICBpZiAoJC5pc09iamVjdChldmVudHMpKSAkLmVhY2goZXZlbnRzLCBpdGVyYXRvcikKICAgIGVsc2UgZXZlbnRzLnNwbGl0KC9ccy8pLmZvckVhY2goZnVuY3Rpb24odHlwZSl7IGl0ZXJhdG9yKHR5cGUsIGZuKSB9KQogIH0KCiAgLy8gV0FSTiBmaXggbmFtZXNwYWNlZCBmb2N1cyAmIGJsdXIgZXZlbnRzIGRlbGVnYXRpb24uIElzc3VlcyAjNTUyICYgIzU5NyBwYXRjaGVkIGZyb20gdGhlIHVwc3RyZWFtIGNoYW5nZXM6CiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21hZHJvYmJ5L3plcHRvL2NvbW1pdC9iYmI1Y2ExN2Q3YzE4NzRjZmYyYTlhN2MzZWE5NGE4YzhkNzlhNzkxCiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21hZHJvYmJ5L3plcHRvL2NvbW1pdC83NGJkNmY1MzFjNWJhMTU0YmU0OGU0OGZmMjIzOTI5YTBmNTdjMmZhCiAgZnVuY3Rpb24gZXZlbnRDYXB0dXJlKGhhbmRsZXIsIGNhcHR1cmVTZXR0aW5nKSB7CiAgICByZXR1cm4gaGFuZGxlci5kZWwgJiYKICAgICAgKGhhbmRsZXIuZSA9PSAnZm9jdXMnIHx8IGhhbmRsZXIuZSA9PSAnYmx1cicpIHx8CiAgICAgICEhY2FwdHVyZVNldHRpbmcKICB9CgogIGZ1bmN0aW9uIGFkZChlbGVtZW50LCBldmVudHMsIGZuLCBzZWxlY3RvciwgZ2V0RGVsZWdhdGUsIGNhcHR1cmUpewogICAgdmFyIGlkID0gemlkKGVsZW1lbnQpLCBzZXQgPSAoaGFuZGxlcnNbaWRdIHx8IChoYW5kbGVyc1tpZF0gPSBbXSkpCiAgICBlYWNoRXZlbnQoZXZlbnRzLCBmbiwgZnVuY3Rpb24oZXZlbnQsIGZuKXsKICAgICAgdmFyIGRlbGVnYXRlID0gZ2V0RGVsZWdhdGUgJiYgZ2V0RGVsZWdhdGUoZm4sIGV2ZW50KSwKICAgICAgICBjYWxsYmFjayA9IGRlbGVnYXRlIHx8IGZuCiAgICAgIHZhciBwcm94eWZuID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IGNhbGxiYWNrLmFwcGx5KGVsZW1lbnQsIFtldmVudF0uY29uY2F0KGV2ZW50LmRhdGEpKQogICAgICAgIGlmIChyZXN1bHQgPT09IGZhbHNlKSBldmVudC5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgcmV0dXJuIHJlc3VsdAogICAgICB9CiAgICAgIHZhciBoYW5kbGVyID0gJC5leHRlbmQocGFyc2UoZXZlbnQpLCB7Zm46IGZuLCBwcm94eTogcHJveHlmbiwgc2VsOiBzZWxlY3RvciwgZGVsOiBkZWxlZ2F0ZSwgaTogc2V0Lmxlbmd0aH0pCiAgICAgIHNldC5wdXNoKGhhbmRsZXIpCiAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihoYW5kbGVyLmUsIHByb3h5Zm4sIGV2ZW50Q2FwdHVyZShoYW5kbGVyLCBjYXB0dXJlKSkKICAgIH0pCiAgfQogIGZ1bmN0aW9uIHJlbW92ZShlbGVtZW50LCBldmVudHMsIGZuLCBzZWxlY3RvciwgY2FwdHVyZSl7CiAgICB2YXIgaWQgPSB6aWQoZWxlbWVudCkKICAgIGVhY2hFdmVudChldmVudHMgfHwgJycsIGZuLCBmdW5jdGlvbihldmVudCwgZm4pewogICAgICBmaW5kSGFuZGxlcnMoZWxlbWVudCwgZXZlbnQsIGZuLCBzZWxlY3RvcikuZm9yRWFjaChmdW5jdGlvbihoYW5kbGVyKXsKICAgICAgICBkZWxldGUgaGFuZGxlcnNbaWRdW2hhbmRsZXIuaV0KICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoaGFuZGxlci5lLCBoYW5kbGVyLnByb3h5LCBldmVudENhcHR1cmUoaGFuZGxlciwgY2FwdHVyZSkpCiAgICAgIH0pCiAgICB9KQogIH0KCiAgJC5ldmVudCA9IHsgYWRkOiBhZGQsIHJlbW92ZTogcmVtb3ZlIH0KCiAgJC5wcm94eSA9IGZ1bmN0aW9uKGZuLCBjb250ZXh0KSB7CiAgICBpZiAoJC5pc0Z1bmN0aW9uKGZuKSkgewogICAgICB2YXIgcHJveHlGbiA9IGZ1bmN0aW9uKCl7IHJldHVybiBmbi5hcHBseShjb250ZXh0LCBhcmd1bWVudHMpIH0KICAgICAgcHJveHlGbi5femlkID0gemlkKGZuKQogICAgICByZXR1cm4gcHJveHlGbgogICAgfSBlbHNlIGlmICh0eXBlb2YgY29udGV4dCA9PSAnc3RyaW5nJykgewogICAgICByZXR1cm4gJC5wcm94eShmbltjb250ZXh0XSwgZm4pCiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJleHBlY3RlZCBmdW5jdGlvbiIpCiAgICB9CiAgfQoKICAkLmZuLmJpbmQgPSBmdW5jdGlvbihldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICBhZGQodGhpcywgZXZlbnQsIGNhbGxiYWNrKQogICAgfSkKICB9CiAgJC5mbi51bmJpbmQgPSBmdW5jdGlvbihldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICByZW1vdmUodGhpcywgZXZlbnQsIGNhbGxiYWNrKQogICAgfSkKICB9CiAgJC5mbi5vbmUgPSBmdW5jdGlvbihldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpLCBlbGVtZW50KXsKICAgICAgYWRkKHRoaXMsIGV2ZW50LCBjYWxsYmFjaywgbnVsbCwgZnVuY3Rpb24oZm4sIHR5cGUpewogICAgICAgIHJldHVybiBmdW5jdGlvbigpewogICAgICAgICAgdmFyIHJlc3VsdCA9IGZuLmFwcGx5KGVsZW1lbnQsIGFyZ3VtZW50cykKICAgICAgICAgIHJlbW92ZShlbGVtZW50LCB0eXBlLCBmbikKICAgICAgICAgIHJldHVybiByZXN1bHQKICAgICAgICB9CiAgICAgIH0pCiAgICB9KQogIH0KCiAgdmFyIHJldHVyblRydWUgPSBmdW5jdGlvbigpe3JldHVybiB0cnVlfSwKICAgICAgcmV0dXJuRmFsc2UgPSBmdW5jdGlvbigpe3JldHVybiBmYWxzZX0sCiAgICAgIGV2ZW50TWV0aG9kcyA9IHsKICAgICAgICBwcmV2ZW50RGVmYXVsdDogJ2lzRGVmYXVsdFByZXZlbnRlZCcsCiAgICAgICAgc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOiAnaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQnLAogICAgICAgIHN0b3BQcm9wYWdhdGlvbjogJ2lzUHJvcGFnYXRpb25TdG9wcGVkJwogICAgICB9CiAgZnVuY3Rpb24gY3JlYXRlUHJveHkoZXZlbnQpIHsKICAgIHZhciBwcm94eSA9ICQuZXh0ZW5kKHtvcmlnaW5hbEV2ZW50OiBldmVudH0sIGV2ZW50KQogICAgJC5lYWNoKGV2ZW50TWV0aG9kcywgZnVuY3Rpb24obmFtZSwgcHJlZGljYXRlKSB7CiAgICAgIHByb3h5W25hbWVdID0gZnVuY3Rpb24oKXsKICAgICAgICB0aGlzW3ByZWRpY2F0ZV0gPSByZXR1cm5UcnVlCiAgICAgICAgcmV0dXJuIGV2ZW50W25hbWVdLmFwcGx5KGV2ZW50LCBhcmd1bWVudHMpCiAgICAgIH0KICAgICAgcHJveHlbcHJlZGljYXRlXSA9IHJldHVybkZhbHNlCiAgICB9KQogICAgcmV0dXJuIHByb3h5CiAgfQoKICAvLyBlbXVsYXRlcyB0aGUgJ2RlZmF1bHRQcmV2ZW50ZWQnIHByb3BlcnR5IGZvciBicm93c2VycyB0aGF0IGhhdmUgbm9uZQogIGZ1bmN0aW9uIGZpeChldmVudCkgewogICAgaWYgKCEoJ2RlZmF1bHRQcmV2ZW50ZWQnIGluIGV2ZW50KSkgewogICAgICBldmVudC5kZWZhdWx0UHJldmVudGVkID0gZmFsc2UKICAgICAgdmFyIHByZXZlbnQgPSBldmVudC5wcmV2ZW50RGVmYXVsdAogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZGVmYXVsdFByZXZlbnRlZCA9IHRydWUKICAgICAgICBwcmV2ZW50LmNhbGwodGhpcykKICAgICAgfQogICAgfQogIH0KCiAgJC5mbi5kZWxlZ2F0ZSA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpLCBlbGVtZW50KXsKICAgICAgYWRkKGVsZW1lbnQsIGV2ZW50LCBjYWxsYmFjaywgc2VsZWN0b3IsIGZ1bmN0aW9uKGZuKXsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oZSl7CiAgICAgICAgICB2YXIgZXZ0LCBtYXRjaCA9ICQoZS50YXJnZXQpLmNsb3Nlc3Qoc2VsZWN0b3IsIGVsZW1lbnQpLmdldCgwKQogICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgIGV2dCA9ICQuZXh0ZW5kKGNyZWF0ZVByb3h5KGUpLCB7Y3VycmVudFRhcmdldDogbWF0Y2gsIGxpdmVGaXJlZDogZWxlbWVudH0pCiAgICAgICAgICAgIHJldHVybiBmbi5hcHBseShtYXRjaCwgW2V2dF0uY29uY2F0KFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSkpCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KQogICAgfSkKICB9CiAgJC5mbi51bmRlbGVnYXRlID0gZnVuY3Rpb24oc2VsZWN0b3IsIGV2ZW50LCBjYWxsYmFjayl7CiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgIHJlbW92ZSh0aGlzLCBldmVudCwgY2FsbGJhY2ssIHNlbGVjdG9yKQogICAgfSkKICB9CgogICQuZm4ubGl2ZSA9IGZ1bmN0aW9uKGV2ZW50LCBjYWxsYmFjayl7CiAgICAkKGRvY3VtZW50LmJvZHkpLmRlbGVnYXRlKHRoaXMuc2VsZWN0b3IsIGV2ZW50LCBjYWxsYmFjaykKICAgIHJldHVybiB0aGlzCiAgfQogICQuZm4uZGllID0gZnVuY3Rpb24oZXZlbnQsIGNhbGxiYWNrKXsKICAgICQoZG9jdW1lbnQuYm9keSkudW5kZWxlZ2F0ZSh0aGlzLnNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spCiAgICByZXR1cm4gdGhpcwogIH0KCiAgJC5mbi5vbiA9IGZ1bmN0aW9uKGV2ZW50LCBzZWxlY3RvciwgY2FsbGJhY2spewogICAgcmV0dXJuIHNlbGVjdG9yID09IHVuZGVmaW5lZCB8fCAkLmlzRnVuY3Rpb24oc2VsZWN0b3IpID8KICAgICAgdGhpcy5iaW5kKGV2ZW50LCBzZWxlY3RvcikgOiB0aGlzLmRlbGVnYXRlKHNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spCiAgfQogICQuZm4ub2ZmID0gZnVuY3Rpb24oZXZlbnQsIHNlbGVjdG9yLCBjYWxsYmFjayl7CiAgICByZXR1cm4gc2VsZWN0b3IgPT0gdW5kZWZpbmVkIHx8ICQuaXNGdW5jdGlvbihzZWxlY3RvcikgPwogICAgICB0aGlzLnVuYmluZChldmVudCwgc2VsZWN0b3IpIDogdGhpcy51bmRlbGVnYXRlKHNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spCiAgfQoKICAkLmZuLnRyaWdnZXIgPSBmdW5jdGlvbihldmVudCwgZGF0YSl7CiAgICBpZiAodHlwZW9mIGV2ZW50ID09ICdzdHJpbmcnKSBldmVudCA9ICQuRXZlbnQoZXZlbnQpCiAgICBmaXgoZXZlbnQpCiAgICBldmVudC5kYXRhID0gZGF0YQogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICAvLyBpdGVtcyBpbiB0aGUgY29sbGVjdGlvbiBtaWdodCBub3QgYmUgRE9NIGVsZW1lbnRzCiAgICAgIC8vICh0b2RvOiBwb3NzaWJseSBzdXBwb3J0IGV2ZW50cyBvbiBwbGFpbiBvbGQgb2JqZWN0cykKICAgICAgaWYoJ2Rpc3BhdGNoRXZlbnQnIGluIHRoaXMpIHRoaXMuZGlzcGF0Y2hFdmVudChldmVudCkKICAgIH0pCiAgfQoKICAvLyB0cmlnZ2VycyBldmVudCBoYW5kbGVycyBvbiBjdXJyZW50IGVsZW1lbnQganVzdCBhcyBpZiBhbiBldmVudCBvY2N1cnJlZCwKICAvLyBkb2Vzbid0IHRyaWdnZXIgYW4gYWN0dWFsIGV2ZW50LCBkb2Vzbid0IGJ1YmJsZQogICQuZm4udHJpZ2dlckhhbmRsZXIgPSBmdW5jdGlvbihldmVudCwgZGF0YSl7CiAgICB2YXIgZSwgcmVzdWx0CiAgICB0aGlzLmVhY2goZnVuY3Rpb24oaSwgZWxlbWVudCl7CiAgICAgIGUgPSBjcmVhdGVQcm94eSh0eXBlb2YgZXZlbnQgPT0gJ3N0cmluZycgPyAkLkV2ZW50KGV2ZW50KSA6IGV2ZW50KQogICAgICBlLmRhdGEgPSBkYXRhCiAgICAgIGUudGFyZ2V0ID0gZWxlbWVudAogICAgICAkLmVhY2goZmluZEhhbmRsZXJzKGVsZW1lbnQsIGV2ZW50LnR5cGUgfHwgZXZlbnQpLCBmdW5jdGlvbihpLCBoYW5kbGVyKXsKICAgICAgICByZXN1bHQgPSBoYW5kbGVyLnByb3h5KGUpCiAgICAgICAgaWYgKGUuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSkgcmV0dXJuIGZhbHNlCiAgICAgIH0pCiAgICB9KQogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgLy8gc2hvcnRjdXQgbWV0aG9kcyBmb3IgYC5iaW5kKGV2ZW50LCBmbilgIGZvciBlYWNoIGV2ZW50IHR5cGUKICA7KCdmb2N1c2luIGZvY3Vzb3V0IGxvYWQgcmVzaXplIHNjcm9sbCB1bmxvYWQgY2xpY2sgZGJsY2xpY2sgJysKICAnbW91c2Vkb3duIG1vdXNldXAgbW91c2Vtb3ZlIG1vdXNlb3ZlciBtb3VzZW91dCAnKwogICdjaGFuZ2Ugc2VsZWN0IGtleWRvd24ga2V5cHJlc3Mga2V5dXAgZXJyb3InKS5zcGxpdCgnICcpLmZvckVhY2goZnVuY3Rpb24oZXZlbnQpIHsKICAgICQuZm5bZXZlbnRdID0gZnVuY3Rpb24oY2FsbGJhY2speyByZXR1cm4gdGhpcy5iaW5kKGV2ZW50LCBjYWxsYmFjaykgfQogIH0pCgogIDtbJ2ZvY3VzJywgJ2JsdXInXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICQuZm5bbmFtZV0gPSBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICBpZiAoY2FsbGJhY2spIHRoaXMuYmluZChuYW1lLCBjYWxsYmFjaykKICAgICAgZWxzZSBpZiAodGhpcy5sZW5ndGgpIHRyeSB7IHRoaXMuZ2V0KDApW25hbWVdKCkgfSBjYXRjaChlKXt9CiAgICAgIHJldHVybiB0aGlzCiAgICB9CiAgfSkKCiAgJC5FdmVudCA9IGZ1bmN0aW9uKHR5cGUsIHByb3BzKSB7CiAgICB2YXIgZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudChzcGVjaWFsRXZlbnRzW3R5cGVdIHx8ICdFdmVudHMnKSwgYnViYmxlcyA9IHRydWUKICAgIGlmIChwcm9wcykgZm9yICh2YXIgbmFtZSBpbiBwcm9wcykgKG5hbWUgPT0gJ2J1YmJsZXMnKSA/IChidWJibGVzID0gISFwcm9wc1tuYW1lXSkgOiAoZXZlbnRbbmFtZV0gPSBwcm9wc1tuYW1lXSkKICAgIGV2ZW50LmluaXRFdmVudCh0eXBlLCBidWJibGVzLCB0cnVlLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsKQogICAgcmV0dXJuIGV2ZW50CiAgfQoKfSkoWmVwdG8pCjsoZnVuY3Rpb24oJCl7CiAgZnVuY3Rpb24gZGV0ZWN0KHVhKXsKICAgIHZhciBvcyA9IHRoaXMub3MgPSB7fSwgYnJvd3NlciA9IHRoaXMuYnJvd3NlciA9IHt9LAogICAgICB3ZWJraXQgPSB1YS5tYXRjaCgvV2ViS2l0XC8oW1xkLl0rKS8pLAogICAgICBhbmRyb2lkID0gdWEubWF0Y2goLyhBbmRyb2lkKVxzKyhbXGQuXSspLyksCiAgICAgIGlwYWQgPSB1YS5tYXRjaCgvKGlQYWQpLipPU1xzKFtcZF9dKykvKSwKICAgICAgaXBob25lID0gIWlwYWQgJiYgdWEubWF0Y2goLyhpUGhvbmVcc09TKVxzKFtcZF9dKykvKSwKICAgICAgd2Vib3MgPSB1YS5tYXRjaCgvKHdlYk9TfGhwd09TKVtcc1wvXShbXGQuXSspLyksCiAgICAgIHRvdWNocGFkID0gd2Vib3MgJiYgdWEubWF0Y2goL1RvdWNoUGFkLyksCiAgICAgIGtpbmRsZSA9IHVhLm1hdGNoKC9LaW5kbGVcLyhbXGQuXSspLyksCiAgICAgIHNpbGsgPSB1YS5tYXRjaCgvU2lsa1wvKFtcZC5fXSspLyksCiAgICAgIGJsYWNrYmVycnkgPSB1YS5tYXRjaCgvKEJsYWNrQmVycnkpLipWZXJzaW9uXC8oW1xkLl0rKS8pCgogICAgLy8gdG9kbyBjbGVhbiB0aGlzIHVwIHdpdGggYSBiZXR0ZXIgT1MvYnJvd3NlcgogICAgLy8gc2VwYXJhdGlvbi4gd2UgbmVlZCB0byBkaXNjZXJuIGJldHdlZW4gbXVsdGlwbGUKICAgIC8vIGJyb3dzZXJzIG9uIGFuZHJvaWQsIGFuZCBkZWNpZGUgaWYga2luZGxlIGZpcmUgaW4KICAgIC8vIHNpbGsgbW9kZSBpcyBhbmRyb2lkIG9yIG5vdAoKICAgIGlmIChicm93c2VyLndlYmtpdCA9ICEhd2Via2l0KSBicm93c2VyLnZlcnNpb24gPSB3ZWJraXRbMV0KCiAgICBpZiAoYW5kcm9pZCkgb3MuYW5kcm9pZCA9IHRydWUsIG9zLnZlcnNpb24gPSBhbmRyb2lkWzJdCiAgICBpZiAoaXBob25lKSBvcy5pb3MgPSBvcy5pcGhvbmUgPSB0cnVlLCBvcy52ZXJzaW9uID0gaXBob25lWzJdLnJlcGxhY2UoL18vZywgJy4nKQogICAgaWYgKGlwYWQpIG9zLmlvcyA9IG9zLmlwYWQgPSB0cnVlLCBvcy52ZXJzaW9uID0gaXBhZFsyXS5yZXBsYWNlKC9fL2csICcuJykKICAgIGlmICh3ZWJvcykgb3Mud2Vib3MgPSB0cnVlLCBvcy52ZXJzaW9uID0gd2Vib3NbMl0KICAgIGlmICh0b3VjaHBhZCkgb3MudG91Y2hwYWQgPSB0cnVlCiAgICBpZiAoYmxhY2tiZXJyeSkgb3MuYmxhY2tiZXJyeSA9IHRydWUsIG9zLnZlcnNpb24gPSBibGFja2JlcnJ5WzJdCiAgICBpZiAoa2luZGxlKSBvcy5raW5kbGUgPSB0cnVlLCBvcy52ZXJzaW9uID0ga2luZGxlWzFdCiAgICBpZiAoc2lsaykgYnJvd3Nlci5zaWxrID0gdHJ1ZSwgYnJvd3Nlci52ZXJzaW9uID0gc2lsa1sxXQogICAgaWYgKCFzaWxrICYmIG9zLmFuZHJvaWQgJiYgdWEubWF0Y2goL0tpbmRsZSBGaXJlLykpIGJyb3dzZXIuc2lsayA9IHRydWUKICB9CgogIGRldGVjdC5jYWxsKCQsIG5hdmlnYXRvci51c2VyQWdlbnQpCiAgLy8gbWFrZSBhdmFpbGFibGUgdG8gdW5pdCB0ZXN0cwogICQuX19kZXRlY3QgPSBkZXRlY3QKCn0pKFplcHRvKQo7KGZ1bmN0aW9uKCQsIHVuZGVmaW5lZCl7CiAgdmFyIHByZWZpeCA9ICcnLCBldmVudFByZWZpeCwgZW5kRXZlbnROYW1lLCBlbmRBbmltYXRpb25OYW1lLAogICAgdmVuZG9ycyA9IHsgV2Via2l0OiAnd2Via2l0JywgTW96OiAnJywgTzogJ28nLCBtczogJ01TJyB9LAogICAgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsIHRlc3RFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLAogICAgc3VwcG9ydGVkVHJhbnNmb3JtcyA9IC9eKCh0cmFuc2xhdGV8cm90YXRlfHNjYWxlKShYfFl8WnwzZCk/fG1hdHJpeCgzZCk/fHBlcnNwZWN0aXZlfHNrZXcoWHxZKT8pJC9pLAogICAgY2xlYXJQcm9wZXJ0aWVzID0ge30KCiAgZnVuY3Rpb24gZG93bmNhc2Uoc3RyKSB7IHJldHVybiBzdHIudG9Mb3dlckNhc2UoKSB9CiAgZnVuY3Rpb24gbm9ybWFsaXplRXZlbnQobmFtZSkgeyByZXR1cm4gZXZlbnRQcmVmaXggPyBldmVudFByZWZpeCArIG5hbWUgOiBkb3duY2FzZShuYW1lKSB9CgogICQuZWFjaCh2ZW5kb3JzLCBmdW5jdGlvbih2ZW5kb3IsIGV2ZW50KXsKICAgIGlmICh0ZXN0RWwuc3R5bGVbdmVuZG9yICsgJ1RyYW5zaXRpb25Qcm9wZXJ0eSddICE9PSB1bmRlZmluZWQpIHsKICAgICAgcHJlZml4ID0gJy0nICsgZG93bmNhc2UodmVuZG9yKSArICctJwogICAgICBldmVudFByZWZpeCA9IGV2ZW50CiAgICAgIHJldHVybiBmYWxzZQogICAgfQogIH0pCgogIGNsZWFyUHJvcGVydGllc1twcmVmaXggKyAndHJhbnNpdGlvbi1wcm9wZXJ0eSddID0KICBjbGVhclByb3BlcnRpZXNbcHJlZml4ICsgJ3RyYW5zaXRpb24tZHVyYXRpb24nXSA9CiAgY2xlYXJQcm9wZXJ0aWVzW3ByZWZpeCArICd0cmFuc2l0aW9uLXRpbWluZy1mdW5jdGlvbiddID0KICBjbGVhclByb3BlcnRpZXNbcHJlZml4ICsgJ2FuaW1hdGlvbi1uYW1lJ10gPQogIGNsZWFyUHJvcGVydGllc1twcmVmaXggKyAnYW5pbWF0aW9uLWR1cmF0aW9uJ10gPSAnJwoKICAkLmZ4ID0gewogICAgb2ZmOiAoZXZlbnRQcmVmaXggPT09IHVuZGVmaW5lZCAmJiB0ZXN0RWwuc3R5bGUudHJhbnNpdGlvblByb3BlcnR5ID09PSB1bmRlZmluZWQpLAogICAgY3NzUHJlZml4OiBwcmVmaXgsCiAgICB0cmFuc2l0aW9uRW5kOiBub3JtYWxpemVFdmVudCgnVHJhbnNpdGlvbkVuZCcpLAogICAgYW5pbWF0aW9uRW5kOiBub3JtYWxpemVFdmVudCgnQW5pbWF0aW9uRW5kJykKICB9CgogICQuZm4uYW5pbWF0ZSA9IGZ1bmN0aW9uKHByb3BlcnRpZXMsIGR1cmF0aW9uLCBlYXNlLCBjYWxsYmFjayl7CiAgICBpZiAoJC5pc09iamVjdChkdXJhdGlvbikpCiAgICAgIGVhc2UgPSBkdXJhdGlvbi5lYXNpbmcsIGNhbGxiYWNrID0gZHVyYXRpb24uY29tcGxldGUsIGR1cmF0aW9uID0gZHVyYXRpb24uZHVyYXRpb24KICAgIGlmIChkdXJhdGlvbikgZHVyYXRpb24gPSBkdXJhdGlvbiAvIDEwMDAKICAgIHJldHVybiB0aGlzLmFuaW0ocHJvcGVydGllcywgZHVyYXRpb24sIGVhc2UsIGNhbGxiYWNrKQogIH0KCiAgJC5mbi5hbmltID0gZnVuY3Rpb24ocHJvcGVydGllcywgZHVyYXRpb24sIGVhc2UsIGNhbGxiYWNrKXsKICAgIHZhciB0cmFuc2Zvcm1zLCBjc3NQcm9wZXJ0aWVzID0ge30sIGtleSwgdGhhdCA9IHRoaXMsIHdyYXBwZWRDYWxsYmFjaywgZW5kRXZlbnQgPSAkLmZ4LnRyYW5zaXRpb25FbmQKICAgIGlmIChkdXJhdGlvbiA9PT0gdW5kZWZpbmVkKSBkdXJhdGlvbiA9IDAuNAogICAgaWYgKCQuZngub2ZmKSBkdXJhdGlvbiA9IDAKCiAgICBpZiAodHlwZW9mIHByb3BlcnRpZXMgPT0gJ3N0cmluZycpIHsKICAgICAgLy8ga2V5ZnJhbWUgYW5pbWF0aW9uCiAgICAgIGNzc1Byb3BlcnRpZXNbcHJlZml4ICsgJ2FuaW1hdGlvbi1uYW1lJ10gPSBwcm9wZXJ0aWVzCiAgICAgIGNzc1Byb3BlcnRpZXNbcHJlZml4ICsgJ2FuaW1hdGlvbi1kdXJhdGlvbiddID0gZHVyYXRpb24gKyAncycKICAgICAgZW5kRXZlbnQgPSAkLmZ4LmFuaW1hdGlvbkVuZAogICAgfSBlbHNlIHsKICAgICAgLy8gQ1NTIHRyYW5zaXRpb25zCiAgICAgIGZvciAoa2V5IGluIHByb3BlcnRpZXMpCiAgICAgICAgaWYgKHN1cHBvcnRlZFRyYW5zZm9ybXMudGVzdChrZXkpKSB7CiAgICAgICAgICB0cmFuc2Zvcm1zIHx8ICh0cmFuc2Zvcm1zID0gW10pCiAgICAgICAgICB0cmFuc2Zvcm1zLnB1c2goa2V5ICsgJygnICsgcHJvcGVydGllc1trZXldICsgJyknKQogICAgICAgIH0KICAgICAgICBlbHNlIGNzc1Byb3BlcnRpZXNba2V5XSA9IHByb3BlcnRpZXNba2V5XQoKICAgICAgaWYgKHRyYW5zZm9ybXMpIGNzc1Byb3BlcnRpZXNbcHJlZml4ICsgJ3RyYW5zZm9ybSddID0gdHJhbnNmb3Jtcy5qb2luKCcgJykKICAgICAgaWYgKCEkLmZ4Lm9mZiAmJiB0eXBlb2YgcHJvcGVydGllcyA9PT0gJ29iamVjdCcpIHsKICAgICAgICBjc3NQcm9wZXJ0aWVzW3ByZWZpeCArICd0cmFuc2l0aW9uLXByb3BlcnR5J10gPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKS5qb2luKCcsICcpCiAgICAgICAgY3NzUHJvcGVydGllc1twcmVmaXggKyAndHJhbnNpdGlvbi1kdXJhdGlvbiddID0gZHVyYXRpb24gKyAncycKICAgICAgICBjc3NQcm9wZXJ0aWVzW3ByZWZpeCArICd0cmFuc2l0aW9uLXRpbWluZy1mdW5jdGlvbiddID0gKGVhc2UgfHwgJ2xpbmVhcicpCiAgICAgIH0KICAgIH0KCiAgICB3cmFwcGVkQ2FsbGJhY2sgPSBmdW5jdGlvbihldmVudCl7CiAgICAgIGlmICh0eXBlb2YgZXZlbnQgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgaWYgKGV2ZW50LnRhcmdldCAhPT0gZXZlbnQuY3VycmVudFRhcmdldCkgcmV0dXJuIC8vIG1ha2VzIHN1cmUgdGhlIGV2ZW50IGRpZG4ndCBidWJibGUgZnJvbSAiYmVsb3ciCiAgICAgICAgJChldmVudC50YXJnZXQpLnVuYmluZChlbmRFdmVudCwgYXJndW1lbnRzLmNhbGxlZSkKICAgICAgfQogICAgICAkKHRoaXMpLmNzcyhjbGVhclByb3BlcnRpZXMpCiAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrLmNhbGwodGhpcykKICAgIH0KICAgIGlmIChkdXJhdGlvbiA+IDApIHRoaXMuYmluZChlbmRFdmVudCwgd3JhcHBlZENhbGxiYWNrKQoKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgIHRoYXQuY3NzKGNzc1Byb3BlcnRpZXMpCiAgICAgIGlmIChkdXJhdGlvbiA8PSAwKSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIHRoYXQuZWFjaChmdW5jdGlvbigpeyB3cmFwcGVkQ2FsbGJhY2suY2FsbCh0aGlzKSB9KQogICAgICB9LCAwKQogICAgfSwgMCkKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgdGVzdEVsID0gbnVsbAp9KShaZXB0bykKOyhmdW5jdGlvbigkKXsKICB2YXIganNvbnBJRCA9IDAsCiAgICAgIGlzT2JqZWN0ID0gJC5pc09iamVjdCwKICAgICAgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsCiAgICAgIGtleSwKICAgICAgbmFtZSwKICAgICAgcnNjcmlwdCA9IC88c2NyaXB0XGJbXjxdKig/Oig/ITxcL3NjcmlwdD4pPFtePF0qKSo8XC9zY3JpcHQ+L2dpLAogICAgICBzY3JpcHRUeXBlUkUgPSAvXig/OnRleHR8YXBwbGljYXRpb24pXC9qYXZhc2NyaXB0L2ksCiAgICAgIHhtbFR5cGVSRSA9IC9eKD86dGV4dHxhcHBsaWNhdGlvbilcL3htbC9pLAogICAgICBqc29uVHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgaHRtbFR5cGUgPSAndGV4dC9odG1sJywKICAgICAgYmxhbmtSRSA9IC9eXHMqJC8KCiAgLy8gdHJpZ2dlciBhIGN1c3RvbSBldmVudCBhbmQgcmV0dXJuIGZhbHNlIGlmIGl0IHdhcyBjYW5jZWxsZWQKICBmdW5jdGlvbiB0cmlnZ2VyQW5kUmV0dXJuKGNvbnRleHQsIGV2ZW50TmFtZSwgZGF0YSkgewogICAgdmFyIGV2ZW50ID0gJC5FdmVudChldmVudE5hbWUpCiAgICAkKGNvbnRleHQpLnRyaWdnZXIoZXZlbnQsIGRhdGEpCiAgICByZXR1cm4gIWV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQKICB9CgogIC8vIHRyaWdnZXIgYW4gQWpheCAiZ2xvYmFsIiBldmVudAogIGZ1bmN0aW9uIHRyaWdnZXJHbG9iYWwoc2V0dGluZ3MsIGNvbnRleHQsIGV2ZW50TmFtZSwgZGF0YSkgewogICAgaWYgKHNldHRpbmdzLmdsb2JhbCkgcmV0dXJuIHRyaWdnZXJBbmRSZXR1cm4oY29udGV4dCB8fCBkb2N1bWVudCwgZXZlbnROYW1lLCBkYXRhKQogIH0KCiAgLy8gTnVtYmVyIG9mIGFjdGl2ZSBBamF4IHJlcXVlc3RzCiAgJC5hY3RpdmUgPSAwCgogIGZ1bmN0aW9uIGFqYXhTdGFydChzZXR0aW5ncykgewogICAgaWYgKHNldHRpbmdzLmdsb2JhbCAmJiAkLmFjdGl2ZSsrID09PSAwKSB0cmlnZ2VyR2xvYmFsKHNldHRpbmdzLCBudWxsLCAnYWpheFN0YXJ0JykKICB9CiAgZnVuY3Rpb24gYWpheFN0b3Aoc2V0dGluZ3MpIHsKICAgIGlmIChzZXR0aW5ncy5nbG9iYWwgJiYgISgtLSQuYWN0aXZlKSkgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgbnVsbCwgJ2FqYXhTdG9wJykKICB9CgogIC8vIHRyaWdnZXJzIGFuIGV4dHJhIGdsb2JhbCBldmVudCAiYWpheEJlZm9yZVNlbmQiIHRoYXQncyBsaWtlICJhamF4U2VuZCIgYnV0IGNhbmNlbGFibGUKICBmdW5jdGlvbiBhamF4QmVmb3JlU2VuZCh4aHIsIHNldHRpbmdzKSB7CiAgICB2YXIgY29udGV4dCA9IHNldHRpbmdzLmNvbnRleHQKICAgIGlmIChzZXR0aW5ncy5iZWZvcmVTZW5kLmNhbGwoY29udGV4dCwgeGhyLCBzZXR0aW5ncykgPT09IGZhbHNlIHx8CiAgICAgICAgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgY29udGV4dCwgJ2FqYXhCZWZvcmVTZW5kJywgW3hociwgc2V0dGluZ3NdKSA9PT0gZmFsc2UpCiAgICAgIHJldHVybiBmYWxzZQoKICAgIHRyaWdnZXJHbG9iYWwoc2V0dGluZ3MsIGNvbnRleHQsICdhamF4U2VuZCcsIFt4aHIsIHNldHRpbmdzXSkKICB9CiAgZnVuY3Rpb24gYWpheFN1Y2Nlc3MoZGF0YSwgeGhyLCBzZXR0aW5ncykgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0LCBzdGF0dXMgPSAnc3VjY2VzcycKICAgIHNldHRpbmdzLnN1Y2Nlc3MuY2FsbChjb250ZXh0LCBkYXRhLCBzdGF0dXMsIHhocikKICAgIHRyaWdnZXJHbG9iYWwoc2V0dGluZ3MsIGNvbnRleHQsICdhamF4U3VjY2VzcycsIFt4aHIsIHNldHRpbmdzLCBkYXRhXSkKICAgIGFqYXhDb21wbGV0ZShzdGF0dXMsIHhociwgc2V0dGluZ3MpCiAgfQogIC8vIHR5cGU6ICJ0aW1lb3V0IiwgImVycm9yIiwgImFib3J0IiwgInBhcnNlcmVycm9yIgogIGZ1bmN0aW9uIGFqYXhFcnJvcihlcnJvciwgdHlwZSwgeGhyLCBzZXR0aW5ncykgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0CiAgICBzZXR0aW5ncy5lcnJvci5jYWxsKGNvbnRleHQsIHhociwgdHlwZSwgZXJyb3IpCiAgICB0cmlnZ2VyR2xvYmFsKHNldHRpbmdzLCBjb250ZXh0LCAnYWpheEVycm9yJywgW3hociwgc2V0dGluZ3MsIGVycm9yXSkKICAgIGFqYXhDb21wbGV0ZSh0eXBlLCB4aHIsIHNldHRpbmdzKQogIH0KICAvLyBzdGF0dXM6ICJzdWNjZXNzIiwgIm5vdG1vZGlmaWVkIiwgImVycm9yIiwgInRpbWVvdXQiLCAiYWJvcnQiLCAicGFyc2VyZXJyb3IiCiAgZnVuY3Rpb24gYWpheENvbXBsZXRlKHN0YXR1cywgeGhyLCBzZXR0aW5ncykgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0CiAgICBzZXR0aW5ncy5jb21wbGV0ZS5jYWxsKGNvbnRleHQsIHhociwgc3RhdHVzKQogICAgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgY29udGV4dCwgJ2FqYXhDb21wbGV0ZScsIFt4aHIsIHNldHRpbmdzXSkKICAgIGFqYXhTdG9wKHNldHRpbmdzKQogIH0KCiAgLy8gRW1wdHkgZnVuY3Rpb24sIHVzZWQgYXMgZGVmYXVsdCBjYWxsYmFjawogIGZ1bmN0aW9uIGVtcHR5KCkge30KCiAgJC5hamF4SlNPTlAgPSBmdW5jdGlvbihvcHRpb25zKXsKICAgIHZhciBjYWxsYmFja05hbWUgPSAnanNvbnAnICsgKCsranNvbnBJRCksCiAgICAgIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpLAogICAgICBhYm9ydCA9IGZ1bmN0aW9uKCl7CiAgICAgICAgJChzY3JpcHQpLnJlbW92ZSgpCiAgICAgICAgaWYgKGNhbGxiYWNrTmFtZSBpbiB3aW5kb3cpIHdpbmRvd1tjYWxsYmFja05hbWVdID0gZW1wdHkKICAgICAgICBhamF4Q29tcGxldGUoJ2Fib3J0JywgeGhyLCBvcHRpb25zKQogICAgICB9LAogICAgICB4aHIgPSB7IGFib3J0OiBhYm9ydCB9LCBhYm9ydFRpbWVvdXQKCiAgICBpZiAob3B0aW9ucy5lcnJvcikgc2NyaXB0Lm9uZXJyb3IgPSBmdW5jdGlvbigpIHsKICAgICAgeGhyLmFib3J0KCkKICAgICAgb3B0aW9ucy5lcnJvcigpCiAgICB9CgogICAgd2luZG93W2NhbGxiYWNrTmFtZV0gPSBmdW5jdGlvbihkYXRhKXsKICAgICAgY2xlYXJUaW1lb3V0KGFib3J0VGltZW91dCkKICAgICAgJChzY3JpcHQpLnJlbW92ZSgpCiAgICAgIGRlbGV0ZSB3aW5kb3dbY2FsbGJhY2tOYW1lXQogICAgICBhamF4U3VjY2VzcyhkYXRhLCB4aHIsIG9wdGlvbnMpCiAgICB9CgogICAgc2VyaWFsaXplRGF0YShvcHRpb25zKQogICAgc2NyaXB0LnNyYyA9IG9wdGlvbnMudXJsLnJlcGxhY2UoLz1cPy8sICc9JyArIGNhbGxiYWNrTmFtZSkKICAgICQoJ2hlYWQnKS5hcHBlbmQoc2NyaXB0KQoKICAgIGlmIChvcHRpb25zLnRpbWVvdXQgPiAwKSBhYm9ydFRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgeGhyLmFib3J0KCkKICAgICAgICBhamF4Q29tcGxldGUoJ3RpbWVvdXQnLCB4aHIsIG9wdGlvbnMpCiAgICAgIH0sIG9wdGlvbnMudGltZW91dCkKCiAgICByZXR1cm4geGhyCiAgfQoKICAkLmFqYXhTZXR0aW5ncyA9IHsKICAgIC8vIERlZmF1bHQgdHlwZSBvZiByZXF1ZXN0CiAgICB0eXBlOiAnR0VUJywKICAgIC8vIENhbGxiYWNrIHRoYXQgaXMgZXhlY3V0ZWQgYmVmb3JlIHJlcXVlc3QKICAgIGJlZm9yZVNlbmQ6IGVtcHR5LAogICAgLy8gQ2FsbGJhY2sgdGhhdCBpcyBleGVjdXRlZCBpZiB0aGUgcmVxdWVzdCBzdWNjZWVkcwogICAgc3VjY2VzczogZW1wdHksCiAgICAvLyBDYWxsYmFjayB0aGF0IGlzIGV4ZWN1dGVkIHRoZSB0aGUgc2VydmVyIGRyb3BzIGVycm9yCiAgICBlcnJvcjogZW1wdHksCiAgICAvLyBDYWxsYmFjayB0aGF0IGlzIGV4ZWN1dGVkIG9uIHJlcXVlc3QgY29tcGxldGUgKGJvdGg6IGVycm9yIGFuZCBzdWNjZXNzKQogICAgY29tcGxldGU6IGVtcHR5LAogICAgLy8gVGhlIGNvbnRleHQgZm9yIHRoZSBjYWxsYmFja3MKICAgIGNvbnRleHQ6IG51bGwsCiAgICAvLyBXaGV0aGVyIHRvIHRyaWdnZXIgImdsb2JhbCIgQWpheCBldmVudHMKICAgIGdsb2JhbDogdHJ1ZSwKICAgIC8vIFRyYW5zcG9ydAogICAgeGhyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBuZXcgd2luZG93LlhNTEh0dHBSZXF1ZXN0KCkKICAgIH0sCiAgICAvLyBNSU1FIHR5cGVzIG1hcHBpbmcKICAgIGFjY2VwdHM6IHsKICAgICAgc2NyaXB0OiAndGV4dC9qYXZhc2NyaXB0LCBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0JywKICAgICAganNvbjogICBqc29uVHlwZSwKICAgICAgeG1sOiAgICAnYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCcsCiAgICAgIGh0bWw6ICAgaHRtbFR5cGUsCiAgICAgIHRleHQ6ICAgJ3RleHQvcGxhaW4nCiAgICB9LAogICAgLy8gV2hldGhlciB0aGUgcmVxdWVzdCBpcyB0byBhbm90aGVyIGRvbWFpbgogICAgY3Jvc3NEb21haW46IGZhbHNlLAogICAgLy8gRGVmYXVsdCB0aW1lb3V0CiAgICB0aW1lb3V0OiAwCiAgfQoKICBmdW5jdGlvbiBtaW1lVG9EYXRhVHlwZShtaW1lKSB7CiAgICByZXR1cm4gbWltZSAmJiAoIG1pbWUgPT0gaHRtbFR5cGUgPyAnaHRtbCcgOgogICAgICBtaW1lID09IGpzb25UeXBlID8gJ2pzb24nIDoKICAgICAgc2NyaXB0VHlwZVJFLnRlc3QobWltZSkgPyAnc2NyaXB0JyA6CiAgICAgIHhtbFR5cGVSRS50ZXN0KG1pbWUpICYmICd4bWwnICkgfHwgJ3RleHQnCiAgfQoKICBmdW5jdGlvbiBhcHBlbmRRdWVyeSh1cmwsIHF1ZXJ5KSB7CiAgICByZXR1cm4gKHVybCArICcmJyArIHF1ZXJ5KS5yZXBsYWNlKC9bJj9dezEsMn0vLCAnPycpCiAgfQoKICAvLyBzZXJpYWxpemUgcGF5bG9hZCBhbmQgYXBwZW5kIGl0IHRvIHRoZSBVUkwgZm9yIEdFVCByZXF1ZXN0cwogIGZ1bmN0aW9uIHNlcmlhbGl6ZURhdGEob3B0aW9ucykgewogICAgaWYgKGlzT2JqZWN0KG9wdGlvbnMuZGF0YSkpIG9wdGlvbnMuZGF0YSA9ICQucGFyYW0ob3B0aW9ucy5kYXRhKQogICAgaWYgKG9wdGlvbnMuZGF0YSAmJiAoIW9wdGlvbnMudHlwZSB8fCBvcHRpb25zLnR5cGUudG9VcHBlckNhc2UoKSA9PSAnR0VUJykpCiAgICAgIG9wdGlvbnMudXJsID0gYXBwZW5kUXVlcnkob3B0aW9ucy51cmwsIG9wdGlvbnMuZGF0YSkKICB9CgogICQuYWpheCA9IGZ1bmN0aW9uKG9wdGlvbnMpewogICAgdmFyIHNldHRpbmdzID0gJC5leHRlbmQoe30sIG9wdGlvbnMgfHwge30pCiAgICBmb3IgKGtleSBpbiAkLmFqYXhTZXR0aW5ncykgaWYgKHNldHRpbmdzW2tleV0gPT09IHVuZGVmaW5lZCkgc2V0dGluZ3Nba2V5XSA9ICQuYWpheFNldHRpbmdzW2tleV0KCiAgICBhamF4U3RhcnQoc2V0dGluZ3MpCgogICAgaWYgKCFzZXR0aW5ncy5jcm9zc0RvbWFpbikgc2V0dGluZ3MuY3Jvc3NEb21haW4gPSAvXihbXHctXSs6KT9cL1wvKFteXC9dKykvLnRlc3Qoc2V0dGluZ3MudXJsKSAmJgogICAgICBSZWdFeHAuJDIgIT0gd2luZG93LmxvY2F0aW9uLmhvc3QKCiAgICB2YXIgZGF0YVR5cGUgPSBzZXR0aW5ncy5kYXRhVHlwZSwgaGFzUGxhY2Vob2xkZXIgPSAvPVw/Ly50ZXN0KHNldHRpbmdzLnVybCkKICAgIGlmIChkYXRhVHlwZSA9PSAnanNvbnAnIHx8IGhhc1BsYWNlaG9sZGVyKSB7CiAgICAgIGlmICghaGFzUGxhY2Vob2xkZXIpIHNldHRpbmdzLnVybCA9IGFwcGVuZFF1ZXJ5KHNldHRpbmdzLnVybCwgJ2NhbGxiYWNrPT8nKQogICAgICByZXR1cm4gJC5hamF4SlNPTlAoc2V0dGluZ3MpCiAgICB9CgogICAgaWYgKCFzZXR0aW5ncy51cmwpIHNldHRpbmdzLnVybCA9IHdpbmRvdy5sb2NhdGlvbi50b1N0cmluZygpCiAgICBzZXJpYWxpemVEYXRhKHNldHRpbmdzKQoKICAgIHZhciBtaW1lID0gc2V0dGluZ3MuYWNjZXB0c1tkYXRhVHlwZV0sCiAgICAgICAgYmFzZUhlYWRlcnMgPSB7IH0sCiAgICAgICAgcHJvdG9jb2wgPSAvXihbXHctXSs6KVwvXC8vLnRlc3Qoc2V0dGluZ3MudXJsKSA/IFJlZ0V4cC4kMSA6IHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbCwKICAgICAgICB4aHIgPSAkLmFqYXhTZXR0aW5ncy54aHIoKSwgYWJvcnRUaW1lb3V0CgogICAgaWYgKCFzZXR0aW5ncy5jcm9zc0RvbWFpbikgYmFzZUhlYWRlcnNbJ1gtUmVxdWVzdGVkLVdpdGgnXSA9ICdYTUxIdHRwUmVxdWVzdCcKICAgIGlmIChtaW1lKSB7CiAgICAgIGJhc2VIZWFkZXJzWydBY2NlcHQnXSA9IG1pbWUKICAgICAgaWYgKG1pbWUuaW5kZXhPZignLCcpID4gLTEpIG1pbWUgPSBtaW1lLnNwbGl0KCcsJywgMilbMF0KICAgICAgeGhyLm92ZXJyaWRlTWltZVR5cGUgJiYgeGhyLm92ZXJyaWRlTWltZVR5cGUobWltZSkKICAgIH0KICAgIGlmIChzZXR0aW5ncy5jb250ZW50VHlwZSB8fCAoc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlLnRvVXBwZXJDYXNlKCkgIT0gJ0dFVCcpKQogICAgICBiYXNlSGVhZGVyc1snQ29udGVudC1UeXBlJ10gPSAoc2V0dGluZ3MuY29udGVudFR5cGUgfHwgJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcpCiAgICBzZXR0aW5ncy5oZWFkZXJzID0gJC5leHRlbmQoYmFzZUhlYWRlcnMsIHNldHRpbmdzLmhlYWRlcnMgfHwge30pCgogICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCl7CiAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PSA0KSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KGFib3J0VGltZW91dCkKICAgICAgICB2YXIgcmVzdWx0LCBlcnJvciA9IGZhbHNlCiAgICAgICAgaWYgKCh4aHIuc3RhdHVzID49IDIwMCAmJiB4aHIuc3RhdHVzIDwgMzAwKSB8fCB4aHIuc3RhdHVzID09IDMwNCB8fCAoeGhyLnN0YXR1cyA9PSAwICYmIHByb3RvY29sID09ICdmaWxlOicpKSB7CiAgICAgICAgICBkYXRhVHlwZSA9IGRhdGFUeXBlIHx8IG1pbWVUb0RhdGFUeXBlKHhoci5nZXRSZXNwb25zZUhlYWRlcignY29udGVudC10eXBlJykpCiAgICAgICAgICByZXN1bHQgPSB4aHIucmVzcG9uc2VUZXh0CgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGRhdGFUeXBlID09ICdzY3JpcHQnKSAgICAoMSxldmFsKShyZXN1bHQpCiAgICAgICAgICAgIGVsc2UgaWYgKGRhdGFUeXBlID09ICd4bWwnKSAgcmVzdWx0ID0geGhyLnJlc3BvbnNlWE1MCiAgICAgICAgICAgIGVsc2UgaWYgKGRhdGFUeXBlID09ICdqc29uJykgcmVzdWx0ID0gYmxhbmtSRS50ZXN0KHJlc3VsdCkgPyBudWxsIDogSlNPTi5wYXJzZShyZXN1bHQpCiAgICAgICAgICB9IGNhdGNoIChlKSB7IGVycm9yID0gZSB9CgogICAgICAgICAgaWYgKGVycm9yKSBhamF4RXJyb3IoZXJyb3IsICdwYXJzZXJlcnJvcicsIHhociwgc2V0dGluZ3MpCiAgICAgICAgICBlbHNlIGFqYXhTdWNjZXNzKHJlc3VsdCwgeGhyLCBzZXR0aW5ncykKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYWpheEVycm9yKG51bGwsICdlcnJvcicsIHhociwgc2V0dGluZ3MpCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgdmFyIGFzeW5jID0gJ2FzeW5jJyBpbiBzZXR0aW5ncyA/IHNldHRpbmdzLmFzeW5jIDogdHJ1ZQogICAgeGhyLm9wZW4oc2V0dGluZ3MudHlwZSwgc2V0dGluZ3MudXJsLCBhc3luYykKCiAgICBmb3IgKG5hbWUgaW4gc2V0dGluZ3MuaGVhZGVycykgeGhyLnNldFJlcXVlc3RIZWFkZXIobmFtZSwgc2V0dGluZ3MuaGVhZGVyc1tuYW1lXSkKCiAgICBpZiAoYWpheEJlZm9yZVNlbmQoeGhyLCBzZXR0aW5ncykgPT09IGZhbHNlKSB7CiAgICAgIHhoci5hYm9ydCgpCiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGlmIChzZXR0aW5ncy50aW1lb3V0ID4gMCkgYWJvcnRUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBlbXB0eQogICAgICAgIHhoci5hYm9ydCgpCiAgICAgICAgYWpheEVycm9yKG51bGwsICd0aW1lb3V0JywgeGhyLCBzZXR0aW5ncykKICAgICAgfSwgc2V0dGluZ3MudGltZW91dCkKCiAgICAvLyBhdm9pZCBzZW5kaW5nIGVtcHR5IHN0cmluZyAoIzMxOSkKICAgIHhoci5zZW5kKHNldHRpbmdzLmRhdGEgPyBzZXR0aW5ncy5kYXRhIDogbnVsbCkKICAgIHJldHVybiB4aHIKICB9CgogICQuZ2V0ID0gZnVuY3Rpb24odXJsLCBzdWNjZXNzKXsgcmV0dXJuICQuYWpheCh7IHVybDogdXJsLCBzdWNjZXNzOiBzdWNjZXNzIH0pIH0KCiAgJC5wb3N0ID0gZnVuY3Rpb24odXJsLCBkYXRhLCBzdWNjZXNzLCBkYXRhVHlwZSl7CiAgICBpZiAoJC5pc0Z1bmN0aW9uKGRhdGEpKSBkYXRhVHlwZSA9IGRhdGFUeXBlIHx8IHN1Y2Nlc3MsIHN1Y2Nlc3MgPSBkYXRhLCBkYXRhID0gbnVsbAogICAgcmV0dXJuICQuYWpheCh7IHR5cGU6ICdQT1NUJywgdXJsOiB1cmwsIGRhdGE6IGRhdGEsIHN1Y2Nlc3M6IHN1Y2Nlc3MsIGRhdGFUeXBlOiBkYXRhVHlwZSB9KQogIH0KCiAgJC5nZXRKU09OID0gZnVuY3Rpb24odXJsLCBzdWNjZXNzKXsKICAgIHJldHVybiAkLmFqYXgoeyB1cmw6IHVybCwgc3VjY2Vzczogc3VjY2VzcywgZGF0YVR5cGU6ICdqc29uJyB9KQogIH0KCiAgJC5mbi5sb2FkID0gZnVuY3Rpb24odXJsLCBzdWNjZXNzKXsKICAgIGlmICghdGhpcy5sZW5ndGgpIHJldHVybiB0aGlzCiAgICB2YXIgc2VsZiA9IHRoaXMsIHBhcnRzID0gdXJsLnNwbGl0KC9ccy8pLCBzZWxlY3RvcgogICAgaWYgKHBhcnRzLmxlbmd0aCA+IDEpIHVybCA9IHBhcnRzWzBdLCBzZWxlY3RvciA9IHBhcnRzWzFdCiAgICAkLmdldCh1cmwsIGZ1bmN0aW9uKHJlc3BvbnNlKXsKICAgICAgc2VsZi5odG1sKHNlbGVjdG9yID8KICAgICAgICAkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpKS5odG1sKHJlc3BvbnNlLnJlcGxhY2UocnNjcmlwdCwgIiIpKS5maW5kKHNlbGVjdG9yKS5odG1sKCkKICAgICAgICA6IHJlc3BvbnNlKQogICAgICBzdWNjZXNzICYmIHN1Y2Nlc3MuY2FsbChzZWxmKQogICAgfSkKICAgIHJldHVybiB0aGlzCiAgfQoKICB2YXIgZXNjYXBlID0gZW5jb2RlVVJJQ29tcG9uZW50CgogIGZ1bmN0aW9uIHNlcmlhbGl6ZShwYXJhbXMsIG9iaiwgdHJhZGl0aW9uYWwsIHNjb3BlKXsKICAgIHZhciBhcnJheSA9ICQuaXNBcnJheShvYmopCiAgICAkLmVhY2gob2JqLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIGlmIChzY29wZSkga2V5ID0gdHJhZGl0aW9uYWwgPyBzY29wZSA6IHNjb3BlICsgJ1snICsgKGFycmF5ID8gJycgOiBrZXkpICsgJ10nCiAgICAgIC8vIGhhbmRsZSBkYXRhIGluIHNlcmlhbGl6ZUFycmF5KCkgZm9ybWF0CiAgICAgIGlmICghc2NvcGUgJiYgYXJyYXkpIHBhcmFtcy5hZGQodmFsdWUubmFtZSwgdmFsdWUudmFsdWUpCiAgICAgIC8vIHJlY3Vyc2UgaW50byBuZXN0ZWQgb2JqZWN0cwogICAgICBlbHNlIGlmICh0cmFkaXRpb25hbCA/ICQuaXNBcnJheSh2YWx1ZSkgOiBpc09iamVjdCh2YWx1ZSkpCiAgICAgICAgc2VyaWFsaXplKHBhcmFtcywgdmFsdWUsIHRyYWRpdGlvbmFsLCBrZXkpCiAgICAgIGVsc2UgcGFyYW1zLmFkZChrZXksIHZhbHVlKQogICAgfSkKICB9CgogICQucGFyYW0gPSBmdW5jdGlvbihvYmosIHRyYWRpdGlvbmFsKXsKICAgIHZhciBwYXJhbXMgPSBbXQogICAgcGFyYW1zLmFkZCA9IGZ1bmN0aW9uKGssIHYpeyB0aGlzLnB1c2goZXNjYXBlKGspICsgJz0nICsgZXNjYXBlKHYpKSB9CiAgICBzZXJpYWxpemUocGFyYW1zLCBvYmosIHRyYWRpdGlvbmFsKQogICAgcmV0dXJuIHBhcmFtcy5qb2luKCcmJykucmVwbGFjZSgnJTIwJywgJysnKQogIH0KfSkoWmVwdG8pCjsoZnVuY3Rpb24gKCQpIHsKICAkLmZuLnNlcmlhbGl6ZUFycmF5ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHJlc3VsdCA9IFtdLCBlbAogICAgJCggQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcy5nZXQoMCkuZWxlbWVudHMpICkuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgIGVsID0gJCh0aGlzKQogICAgICB2YXIgdHlwZSA9IGVsLmF0dHIoJ3R5cGUnKQogICAgICBpZiAodGhpcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9ICdmaWVsZHNldCcgJiYKICAgICAgICAhdGhpcy5kaXNhYmxlZCAmJiB0eXBlICE9ICdzdWJtaXQnICYmIHR5cGUgIT0gJ3Jlc2V0JyAmJiB0eXBlICE9ICdidXR0b24nICYmCiAgICAgICAgKCh0eXBlICE9ICdyYWRpbycgJiYgdHlwZSAhPSAnY2hlY2tib3gnKSB8fCB0aGlzLmNoZWNrZWQpKQogICAgICAgIHJlc3VsdC5wdXNoKHsKICAgICAgICAgIG5hbWU6IGVsLmF0dHIoJ25hbWUnKSwKICAgICAgICAgIHZhbHVlOiBlbC52YWwoKQogICAgICAgIH0pCiAgICB9KQogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgJC5mbi5zZXJpYWxpemUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgcmVzdWx0ID0gW10KICAgIHRoaXMuc2VyaWFsaXplQXJyYXkoKS5mb3JFYWNoKGZ1bmN0aW9uIChlbG0pIHsKICAgICAgcmVzdWx0LnB1c2goIGVuY29kZVVSSUNvbXBvbmVudChlbG0ubmFtZSkgKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQoZWxtLnZhbHVlKSApCiAgICB9KQogICAgcmV0dXJuIHJlc3VsdC5qb2luKCcmJykKICB9CgogICQuZm4uc3VibWl0ID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICBpZiAoY2FsbGJhY2spIHRoaXMuYmluZCgnc3VibWl0JywgY2FsbGJhY2spCiAgICBlbHNlIGlmICh0aGlzLmxlbmd0aCkgewogICAgICB2YXIgZXZlbnQgPSAkLkV2ZW50KCdzdWJtaXQnKQogICAgICB0aGlzLmVxKDApLnRyaWdnZXIoZXZlbnQpCiAgICAgIGlmICghZXZlbnQuZGVmYXVsdFByZXZlbnRlZCkgdGhpcy5nZXQoMCkuc3VibWl0KCkKICAgIH0KICAgIHJldHVybiB0aGlzCiAgfQoKfSkoWmVwdG8pCjsoZnVuY3Rpb24oJCl7CiAgdmFyIHRvdWNoID0ge30sIHRvdWNoVGltZW91dAoKICBmdW5jdGlvbiBwYXJlbnRJZlRleHQobm9kZSl7CiAgICByZXR1cm4gJ3RhZ05hbWUnIGluIG5vZGUgPyBub2RlIDogbm9kZS5wYXJlbnROb2RlCiAgfQoKICBmdW5jdGlvbiBzd2lwZURpcmVjdGlvbih4MSwgeDIsIHkxLCB5Mil7CiAgICB2YXIgeERlbHRhID0gTWF0aC5hYnMoeDEgLSB4MiksIHlEZWx0YSA9IE1hdGguYWJzKHkxIC0geTIpCiAgICByZXR1cm4geERlbHRhID49IHlEZWx0YSA/ICh4MSAtIHgyID4gMCA/ICdMZWZ0JyA6ICdSaWdodCcpIDogKHkxIC0geTIgPiAwID8gJ1VwJyA6ICdEb3duJykKICB9CgogIHZhciBsb25nVGFwRGVsYXkgPSA3NTAsIGxvbmdUYXBUaW1lb3V0CgogIGZ1bmN0aW9uIGxvbmdUYXAoKXsKICAgIGxvbmdUYXBUaW1lb3V0ID0gbnVsbAogICAgaWYgKHRvdWNoLmxhc3QpIHsKICAgICAgdG91Y2guZWwudHJpZ2dlcignbG9uZ1RhcCcpCiAgICAgIHRvdWNoID0ge30KICAgIH0KICB9CgogIGZ1bmN0aW9uIGNhbmNlbExvbmdUYXAoKXsKICAgIGlmIChsb25nVGFwVGltZW91dCkgY2xlYXJUaW1lb3V0KGxvbmdUYXBUaW1lb3V0KQogICAgbG9uZ1RhcFRpbWVvdXQgPSBudWxsCiAgfQoKICAkKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpewogICAgdmFyIG5vdywgZGVsdGEKCiAgICAkKGRvY3VtZW50LmJvZHkpLmJpbmQoJ3RvdWNoc3RhcnQnLCBmdW5jdGlvbihlKXsKICAgICAgbm93ID0gRGF0ZS5ub3coKQogICAgICBkZWx0YSA9IG5vdyAtICh0b3VjaC5sYXN0IHx8IG5vdykKICAgICAgdG91Y2guZWwgPSAkKHBhcmVudElmVGV4dChlLnRvdWNoZXNbMF0udGFyZ2V0KSkKICAgICAgdG91Y2hUaW1lb3V0ICYmIGNsZWFyVGltZW91dCh0b3VjaFRpbWVvdXQpCiAgICAgIHRvdWNoLngxID0gZS50b3VjaGVzWzBdLnBhZ2VYCiAgICAgIHRvdWNoLnkxID0gZS50b3VjaGVzWzBdLnBhZ2VZCiAgICAgIGlmIChkZWx0YSA+IDAgJiYgZGVsdGEgPD0gMjUwKSB0b3VjaC5pc0RvdWJsZVRhcCA9IHRydWUKICAgICAgdG91Y2gubGFzdCA9IG5vdwogICAgICBsb25nVGFwVGltZW91dCA9IHNldFRpbWVvdXQobG9uZ1RhcCwgbG9uZ1RhcERlbGF5KQogICAgfSkuYmluZCgndG91Y2htb3ZlJywgZnVuY3Rpb24oZSl7CiAgICAgIGNhbmNlbExvbmdUYXAoKQogICAgICB0b3VjaC54MiA9IGUudG91Y2hlc1swXS5wYWdlWAogICAgICB0b3VjaC55MiA9IGUudG91Y2hlc1swXS5wYWdlWQogICAgfSkuYmluZCgndG91Y2hlbmQnLCBmdW5jdGlvbihlKXsKICAgICAgIGNhbmNlbExvbmdUYXAoKQoKICAgICAgLy8gZG91YmxlIHRhcCAodGFwcGVkIHR3aWNlIHdpdGhpbiAyNTBtcykKICAgICAgaWYgKHRvdWNoLmlzRG91YmxlVGFwKSB7CiAgICAgICAgdG91Y2guZWwudHJpZ2dlcignZG91YmxlVGFwJykKICAgICAgICB0b3VjaCA9IHt9CgogICAgICAvLyBzd2lwZQogICAgICB9IGVsc2UgaWYgKCh0b3VjaC54MiAmJiBNYXRoLmFicyh0b3VjaC54MSAtIHRvdWNoLngyKSA+IDMwKSB8fAogICAgICAgICAgICAgICAgICh0b3VjaC55MiAmJiBNYXRoLmFicyh0b3VjaC55MSAtIHRvdWNoLnkyKSA+IDMwKSkgewogICAgICAgIHRvdWNoLmVsLnRyaWdnZXIoJ3N3aXBlJykgJiYKICAgICAgICAgIHRvdWNoLmVsLnRyaWdnZXIoJ3N3aXBlJyArIChzd2lwZURpcmVjdGlvbih0b3VjaC54MSwgdG91Y2gueDIsIHRvdWNoLnkxLCB0b3VjaC55MikpKQogICAgICAgIHRvdWNoID0ge30KCiAgICAgIC8vIG5vcm1hbCB0YXAKICAgICAgfSBlbHNlIGlmICgnbGFzdCcgaW4gdG91Y2gpIHsKICAgICAgICB0b3VjaC5lbC50cmlnZ2VyKCd0YXAnKQoKICAgICAgICB0b3VjaFRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICB0b3VjaFRpbWVvdXQgPSBudWxsCiAgICAgICAgICB0b3VjaC5lbC50cmlnZ2VyKCdzaW5nbGVUYXAnKQogICAgICAgICAgdG91Y2ggPSB7fQogICAgICAgIH0sIDI1MCkKICAgICAgfQogICAgfSkuYmluZCgndG91Y2hjYW5jZWwnLCBmdW5jdGlvbigpewogICAgICBpZiAodG91Y2hUaW1lb3V0KSBjbGVhclRpbWVvdXQodG91Y2hUaW1lb3V0KQogICAgICBpZiAobG9uZ1RhcFRpbWVvdXQpIGNsZWFyVGltZW91dChsb25nVGFwVGltZW91dCkKICAgICAgbG9uZ1RhcFRpbWVvdXQgPSB0b3VjaFRpbWVvdXQgPSBudWxsCiAgICAgIHRvdWNoID0ge30KICAgIH0pCiAgfSkKCiAgO1snc3dpcGUnLCAnc3dpcGVMZWZ0JywgJ3N3aXBlUmlnaHQnLCAnc3dpcGVVcCcsICdzd2lwZURvd24nLCAnZG91YmxlVGFwJywgJ3RhcCcsICdzaW5nbGVUYXAnLCAnbG9uZ1RhcCddLmZvckVhY2goZnVuY3Rpb24obSl7CiAgICAkLmZuW21dID0gZnVuY3Rpb24oY2FsbGJhY2speyByZXR1cm4gdGhpcy5iaW5kKG0sIGNhbGxiYWNrKSB9CiAgfSkKfSkoWmVwdG8pCgovLyBsaWIvaGFuZGxlYmFycy9iYXNlLmpzCgovKmpzaGludCBlcW51bGw6dHJ1ZSovCnRoaXMuSGFuZGxlYmFycyA9IHt9OwoKKGZ1bmN0aW9uKEhhbmRsZWJhcnMpIHsKCkhhbmRsZWJhcnMuVkVSU0lPTiA9ICIxLjAucmMuMSI7CgpIYW5kbGViYXJzLmhlbHBlcnMgID0ge307CkhhbmRsZWJhcnMucGFydGlhbHMgPSB7fTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIgPSBmdW5jdGlvbihuYW1lLCBmbiwgaW52ZXJzZSkgewogIGlmKGludmVyc2UpIHsgZm4ubm90ID0gaW52ZXJzZTsgfQogIHRoaXMuaGVscGVyc1tuYW1lXSA9IGZuOwp9OwoKSGFuZGxlYmFycy5yZWdpc3RlclBhcnRpYWwgPSBmdW5jdGlvbihuYW1lLCBzdHIpIHsKICB0aGlzLnBhcnRpYWxzW25hbWVdID0gc3RyOwp9OwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaGVscGVyTWlzc2luZycsIGZ1bmN0aW9uKGFyZykgewogIGlmKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHsKICAgIHJldHVybiB1bmRlZmluZWQ7CiAgfSBlbHNlIHsKICAgIHRocm93IG5ldyBFcnJvcigiQ291bGQgbm90IGZpbmQgcHJvcGVydHkgJyIgKyBhcmcgKyAiJyIpOwogIH0KfSk7Cgp2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLCBmdW5jdGlvblR5cGUgPSAiW29iamVjdCBGdW5jdGlvbl0iOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignYmxvY2tIZWxwZXJNaXNzaW5nJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHZhciBpbnZlcnNlID0gb3B0aW9ucy5pbnZlcnNlIHx8IGZ1bmN0aW9uKCkge30sIGZuID0gb3B0aW9ucy5mbjsKCgogIHZhciByZXQgPSAiIjsKICB2YXIgdHlwZSA9IHRvU3RyaW5nLmNhbGwoY29udGV4dCk7CgogIGlmKHR5cGUgPT09IGZ1bmN0aW9uVHlwZSkgeyBjb250ZXh0ID0gY29udGV4dC5jYWxsKHRoaXMpOyB9CgogIGlmKGNvbnRleHQgPT09IHRydWUpIHsKICAgIHJldHVybiBmbih0aGlzKTsKICB9IGVsc2UgaWYoY29udGV4dCA9PT0gZmFsc2UgfHwgY29udGV4dCA9PSBudWxsKSB7CiAgICByZXR1cm4gaW52ZXJzZSh0aGlzKTsKICB9IGVsc2UgaWYodHlwZSA9PT0gIltvYmplY3QgQXJyYXldIikgewogICAgaWYoY29udGV4dC5sZW5ndGggPiAwKSB7CiAgICAgIHJldHVybiBIYW5kbGViYXJzLmhlbHBlcnMuZWFjaChjb250ZXh0LCBvcHRpb25zKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBpbnZlcnNlKHRoaXMpOwogICAgfQogIH0gZWxzZSB7CiAgICByZXR1cm4gZm4oY29udGV4dCk7CiAgfQp9KTsKCkhhbmRsZWJhcnMuSyA9IGZ1bmN0aW9uKCkge307CgpIYW5kbGViYXJzLmNyZWF0ZUZyYW1lID0gT2JqZWN0LmNyZWF0ZSB8fCBmdW5jdGlvbihvYmplY3QpIHsKICBIYW5kbGViYXJzLksucHJvdG90eXBlID0gb2JqZWN0OwogIHZhciBvYmogPSBuZXcgSGFuZGxlYmFycy5LKCk7CiAgSGFuZGxlYmFycy5LLnByb3RvdHlwZSA9IG51bGw7CiAgcmV0dXJuIG9iajsKfTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2VhY2gnLCBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgdmFyIGZuID0gb3B0aW9ucy5mbiwgaW52ZXJzZSA9IG9wdGlvbnMuaW52ZXJzZTsKICB2YXIgcmV0ID0gIiIsIGRhdGE7CgogIGlmIChvcHRpb25zLmRhdGEpIHsKICAgIGRhdGEgPSBIYW5kbGViYXJzLmNyZWF0ZUZyYW1lKG9wdGlvbnMuZGF0YSk7CiAgfQoKICBpZihjb250ZXh0ICYmIGNvbnRleHQubGVuZ3RoID4gMCkgewogICAgZm9yKHZhciBpPTAsIGo9Y29udGV4dC5sZW5ndGg7IGk8ajsgaSsrKSB7CiAgICAgIGlmIChkYXRhKSB7IGRhdGEuaW5kZXggPSBpOyB9CiAgICAgIHJldCA9IHJldCArIGZuKGNvbnRleHRbaV0sIHsgZGF0YTogZGF0YSB9KTsKICAgIH0KICB9IGVsc2UgewogICAgcmV0ID0gaW52ZXJzZSh0aGlzKTsKICB9CiAgcmV0dXJuIHJldDsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpZicsIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICB2YXIgdHlwZSA9IHRvU3RyaW5nLmNhbGwoY29udGV4dCk7CiAgaWYodHlwZSA9PT0gZnVuY3Rpb25UeXBlKSB7IGNvbnRleHQgPSBjb250ZXh0LmNhbGwodGhpcyk7IH0KCiAgaWYoIWNvbnRleHQgfHwgSGFuZGxlYmFycy5VdGlscy5pc0VtcHR5KGNvbnRleHQpKSB7CiAgICByZXR1cm4gb3B0aW9ucy5pbnZlcnNlKHRoaXMpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gb3B0aW9ucy5mbih0aGlzKTsKICB9Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcigndW5sZXNzJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHZhciBmbiA9IG9wdGlvbnMuZm4sIGludmVyc2UgPSBvcHRpb25zLmludmVyc2U7CiAgb3B0aW9ucy5mbiA9IGludmVyc2U7CiAgb3B0aW9ucy5pbnZlcnNlID0gZm47CgogIHJldHVybiBIYW5kbGViYXJzLmhlbHBlcnNbJ2lmJ10uY2FsbCh0aGlzLCBjb250ZXh0LCBvcHRpb25zKTsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd3aXRoJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHJldHVybiBvcHRpb25zLmZuKGNvbnRleHQpOwp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2xvZycsIGZ1bmN0aW9uKGNvbnRleHQpIHsKICBIYW5kbGViYXJzLmxvZyhjb250ZXh0KTsKfSk7Cgp9KHRoaXMuSGFuZGxlYmFycykpOwo7Ci8vIGxpYi9oYW5kbGViYXJzL2NvbXBpbGVyL3BhcnNlci5qcwovKiBKaXNvbiBnZW5lcmF0ZWQgcGFyc2VyICovCnZhciBoYW5kbGViYXJzID0gKGZ1bmN0aW9uKCl7CnZhciBwYXJzZXIgPSB7dHJhY2U6IGZ1bmN0aW9uIHRyYWNlKCkgeyB9LAp5eToge30sCnN5bWJvbHNfOiB7ImVycm9yIjoyLCJyb290IjozLCJwcm9ncmFtIjo0LCJFT0YiOjUsInN0YXRlbWVudHMiOjYsInNpbXBsZUludmVyc2UiOjcsInN0YXRlbWVudCI6OCwib3BlbkludmVyc2UiOjksImNsb3NlQmxvY2siOjEwLCJvcGVuQmxvY2siOjExLCJtdXN0YWNoZSI6MTIsInBhcnRpYWwiOjEzLCJDT05URU5UIjoxNCwiQ09NTUVOVCI6MTUsIk9QRU5fQkxPQ0siOjE2LCJpbk11c3RhY2hlIjoxNywiQ0xPU0UiOjE4LCJPUEVOX0lOVkVSU0UiOjE5LCJPUEVOX0VOREJMT0NLIjoyMCwicGF0aCI6MjEsIk9QRU4iOjIyLCJPUEVOX1VORVNDQVBFRCI6MjMsIk9QRU5fUEFSVElBTCI6MjQsInBhcmFtcyI6MjUsImhhc2giOjI2LCJEQVRBIjoyNywicGFyYW0iOjI4LCJTVFJJTkciOjI5LCJJTlRFR0VSIjozMCwiQk9PTEVBTiI6MzEsImhhc2hTZWdtZW50cyI6MzIsImhhc2hTZWdtZW50IjozMywiSUQiOjM0LCJFUVVBTFMiOjM1LCJwYXRoU2VnbWVudHMiOjM2LCJTRVAiOjM3LCIkYWNjZXB0IjowLCIkZW5kIjoxfSwKdGVybWluYWxzXzogezI6ImVycm9yIiw1OiJFT0YiLDE0OiJDT05URU5UIiwxNToiQ09NTUVOVCIsMTY6Ik9QRU5fQkxPQ0siLDE4OiJDTE9TRSIsMTk6Ik9QRU5fSU5WRVJTRSIsMjA6Ik9QRU5fRU5EQkxPQ0siLDIyOiJPUEVOIiwyMzoiT1BFTl9VTkVTQ0FQRUQiLDI0OiJPUEVOX1BBUlRJQUwiLDI3OiJEQVRBIiwyOToiU1RSSU5HIiwzMDoiSU5URUdFUiIsMzE6IkJPT0xFQU4iLDM0OiJJRCIsMzU6IkVRVUFMUyIsMzc6IlNFUCJ9LApwcm9kdWN0aW9uc186IFswLFszLDJdLFs0LDNdLFs0LDFdLFs0LDBdLFs2LDFdLFs2LDJdLFs4LDNdLFs4LDNdLFs4LDFdLFs4LDFdLFs4LDFdLFs4LDFdLFsxMSwzXSxbOSwzXSxbMTAsM10sWzEyLDNdLFsxMiwzXSxbMTMsM10sWzEzLDRdLFs3LDJdLFsxNywzXSxbMTcsMl0sWzE3LDJdLFsxNywxXSxbMTcsMV0sWzI1LDJdLFsyNSwxXSxbMjgsMV0sWzI4LDFdLFsyOCwxXSxbMjgsMV0sWzI4LDFdLFsyNiwxXSxbMzIsMl0sWzMyLDFdLFszMywzXSxbMzMsM10sWzMzLDNdLFszMywzXSxbMzMsM10sWzIxLDFdLFszNiwzXSxbMzYsMV1dLApwZXJmb3JtQWN0aW9uOiBmdW5jdGlvbiBhbm9ueW1vdXMoeXl0ZXh0LHl5bGVuZyx5eWxpbmVubyx5eSx5eXN0YXRlLCQkLF8kKSB7Cgp2YXIgJDAgPSAkJC5sZW5ndGggLSAxOwpzd2l0Y2ggKHl5c3RhdGUpIHsKY2FzZSAxOiByZXR1cm4gJCRbJDAtMV07IApicmVhazsKY2FzZSAyOiB0aGlzLiQgPSBuZXcgeXkuUHJvZ3JhbU5vZGUoJCRbJDAtMl0sICQkWyQwXSk7IApicmVhazsKY2FzZSAzOiB0aGlzLiQgPSBuZXcgeXkuUHJvZ3JhbU5vZGUoJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDQ6IHRoaXMuJCA9IG5ldyB5eS5Qcm9ncmFtTm9kZShbXSk7IApicmVhazsKY2FzZSA1OiB0aGlzLiQgPSBbJCRbJDBdXTsgCmJyZWFrOwpjYXNlIDY6ICQkWyQwLTFdLnB1c2goJCRbJDBdKTsgdGhpcy4kID0gJCRbJDAtMV07IApicmVhazsKY2FzZSA3OiB0aGlzLiQgPSBuZXcgeXkuQmxvY2tOb2RlKCQkWyQwLTJdLCAkJFskMC0xXS5pbnZlcnNlLCAkJFskMC0xXSwgJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDg6IHRoaXMuJCA9IG5ldyB5eS5CbG9ja05vZGUoJCRbJDAtMl0sICQkWyQwLTFdLCAkJFskMC0xXS5pbnZlcnNlLCAkJFskMF0pOyAKYnJlYWs7CmNhc2UgOTogdGhpcy4kID0gJCRbJDBdOyAKYnJlYWs7CmNhc2UgMTA6IHRoaXMuJCA9ICQkWyQwXTsgCmJyZWFrOwpjYXNlIDExOiB0aGlzLiQgPSBuZXcgeXkuQ29udGVudE5vZGUoJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDEyOiB0aGlzLiQgPSBuZXcgeXkuQ29tbWVudE5vZGUoJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDEzOiB0aGlzLiQgPSBuZXcgeXkuTXVzdGFjaGVOb2RlKCQkWyQwLTFdWzBdLCAkJFskMC0xXVsxXSk7IApicmVhazsKY2FzZSAxNDogdGhpcy4kID0gbmV3IHl5Lk11c3RhY2hlTm9kZSgkJFskMC0xXVswXSwgJCRbJDAtMV1bMV0pOyAKYnJlYWs7CmNhc2UgMTU6IHRoaXMuJCA9ICQkWyQwLTFdOyAKYnJlYWs7CmNhc2UgMTY6IHRoaXMuJCA9IG5ldyB5eS5NdXN0YWNoZU5vZGUoJCRbJDAtMV1bMF0sICQkWyQwLTFdWzFdKTsgCmJyZWFrOwpjYXNlIDE3OiB0aGlzLiQgPSBuZXcgeXkuTXVzdGFjaGVOb2RlKCQkWyQwLTFdWzBdLCAkJFskMC0xXVsxXSwgdHJ1ZSk7IApicmVhazsKY2FzZSAxODogdGhpcy4kID0gbmV3IHl5LlBhcnRpYWxOb2RlKCQkWyQwLTFdKTsgCmJyZWFrOwpjYXNlIDE5OiB0aGlzLiQgPSBuZXcgeXkuUGFydGlhbE5vZGUoJCRbJDAtMl0sICQkWyQwLTFdKTsgCmJyZWFrOwpjYXNlIDIwOiAKYnJlYWs7CmNhc2UgMjE6IHRoaXMuJCA9IFtbJCRbJDAtMl1dLmNvbmNhdCgkJFskMC0xXSksICQkWyQwXV07IApicmVhazsKY2FzZSAyMjogdGhpcy4kID0gW1skJFskMC0xXV0uY29uY2F0KCQkWyQwXSksIG51bGxdOyAKYnJlYWs7CmNhc2UgMjM6IHRoaXMuJCA9IFtbJCRbJDAtMV1dLCAkJFskMF1dOyAKYnJlYWs7CmNhc2UgMjQ6IHRoaXMuJCA9IFtbJCRbJDBdXSwgbnVsbF07IApicmVhazsKY2FzZSAyNTogdGhpcy4kID0gW1tuZXcgeXkuRGF0YU5vZGUoJCRbJDBdKV0sIG51bGxdOyAKYnJlYWs7CmNhc2UgMjY6ICQkWyQwLTFdLnB1c2goJCRbJDBdKTsgdGhpcy4kID0gJCRbJDAtMV07IApicmVhazsKY2FzZSAyNzogdGhpcy4kID0gWyQkWyQwXV07IApicmVhazsKY2FzZSAyODogdGhpcy4kID0gJCRbJDBdOyAKYnJlYWs7CmNhc2UgMjk6IHRoaXMuJCA9IG5ldyB5eS5TdHJpbmdOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMDogdGhpcy4kID0gbmV3IHl5LkludGVnZXJOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMTogdGhpcy4kID0gbmV3IHl5LkJvb2xlYW5Ob2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMjogdGhpcy4kID0gbmV3IHl5LkRhdGFOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMzogdGhpcy4kID0gbmV3IHl5Lkhhc2hOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzNDogJCRbJDAtMV0ucHVzaCgkJFskMF0pOyB0aGlzLiQgPSAkJFskMC0xXTsgCmJyZWFrOwpjYXNlIDM1OiB0aGlzLiQgPSBbJCRbJDBdXTsgCmJyZWFrOwpjYXNlIDM2OiB0aGlzLiQgPSBbJCRbJDAtMl0sICQkWyQwXV07IApicmVhazsKY2FzZSAzNzogdGhpcy4kID0gWyQkWyQwLTJdLCBuZXcgeXkuU3RyaW5nTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDM4OiB0aGlzLiQgPSBbJCRbJDAtMl0sIG5ldyB5eS5JbnRlZ2VyTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDM5OiB0aGlzLiQgPSBbJCRbJDAtMl0sIG5ldyB5eS5Cb29sZWFuTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDQwOiB0aGlzLiQgPSBbJCRbJDAtMl0sIG5ldyB5eS5EYXRhTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDQxOiB0aGlzLiQgPSBuZXcgeXkuSWROb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSA0MjogJCRbJDAtMl0ucHVzaCgkJFskMF0pOyB0aGlzLiQgPSAkJFskMC0yXTsgCmJyZWFrOwpjYXNlIDQzOiB0aGlzLiQgPSBbJCRbJDBdXTsgCmJyZWFrOwp9Cn0sCnRhYmxlOiBbezM6MSw0OjIsNTpbMiw0XSw2OjMsODo0LDk6NSwxMTo2LDEyOjcsMTM6OCwxNDpbMSw5XSwxNTpbMSwxMF0sMTY6WzEsMTJdLDE5OlsxLDExXSwyMjpbMSwxM10sMjM6WzEsMTRdLDI0OlsxLDE1XX0sezE6WzNdfSx7NTpbMSwxNl19LHs1OlsyLDNdLDc6MTcsODoxOCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxOV0sMjA6WzIsM10sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNDpbMSwxNV19LHs1OlsyLDVdLDE0OlsyLDVdLDE1OlsyLDVdLDE2OlsyLDVdLDE5OlsyLDVdLDIwOlsyLDVdLDIyOlsyLDVdLDIzOlsyLDVdLDI0OlsyLDVdfSx7NDoyMCw2OjMsODo0LDk6NSwxMTo2LDEyOjcsMTM6OCwxNDpbMSw5XSwxNTpbMSwxMF0sMTY6WzEsMTJdLDE5OlsxLDExXSwyMDpbMiw0XSwyMjpbMSwxM10sMjM6WzEsMTRdLDI0OlsxLDE1XX0sezQ6MjEsNjozLDg6NCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxMV0sMjA6WzIsNF0sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNDpbMSwxNV19LHs1OlsyLDldLDE0OlsyLDldLDE1OlsyLDldLDE2OlsyLDldLDE5OlsyLDldLDIwOlsyLDldLDIyOlsyLDldLDIzOlsyLDldLDI0OlsyLDldfSx7NTpbMiwxMF0sMTQ6WzIsMTBdLDE1OlsyLDEwXSwxNjpbMiwxMF0sMTk6WzIsMTBdLDIwOlsyLDEwXSwyMjpbMiwxMF0sMjM6WzIsMTBdLDI0OlsyLDEwXX0sezU6WzIsMTFdLDE0OlsyLDExXSwxNTpbMiwxMV0sMTY6WzIsMTFdLDE5OlsyLDExXSwyMDpbMiwxMV0sMjI6WzIsMTFdLDIzOlsyLDExXSwyNDpbMiwxMV19LHs1OlsyLDEyXSwxNDpbMiwxMl0sMTU6WzIsMTJdLDE2OlsyLDEyXSwxOTpbMiwxMl0sMjA6WzIsMTJdLDIyOlsyLDEyXSwyMzpbMiwxMl0sMjQ6WzIsMTJdfSx7MTc6MjIsMjE6MjMsMjc6WzEsMjRdLDM0OlsxLDI2XSwzNjoyNX0sezE3OjI3LDIxOjIzLDI3OlsxLDI0XSwzNDpbMSwyNl0sMzY6MjV9LHsxNzoyOCwyMToyMywyNzpbMSwyNF0sMzQ6WzEsMjZdLDM2OjI1fSx7MTc6MjksMjE6MjMsMjc6WzEsMjRdLDM0OlsxLDI2XSwzNjoyNX0sezIxOjMwLDM0OlsxLDI2XSwzNjoyNX0sezE6WzIsMV19LHs2OjMxLDg6NCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxMV0sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNDpbMSwxNV19LHs1OlsyLDZdLDE0OlsyLDZdLDE1OlsyLDZdLDE2OlsyLDZdLDE5OlsyLDZdLDIwOlsyLDZdLDIyOlsyLDZdLDIzOlsyLDZdLDI0OlsyLDZdfSx7MTc6MjIsMTg6WzEsMzJdLDIxOjIzLDI3OlsxLDI0XSwzNDpbMSwyNl0sMzY6MjV9LHsxMDozMywyMDpbMSwzNF19LHsxMDozNSwyMDpbMSwzNF19LHsxODpbMSwzNl19LHsxODpbMiwyNF0sMjE6NDEsMjU6MzcsMjY6MzgsMjc6WzEsNDVdLDI4OjM5LDI5OlsxLDQyXSwzMDpbMSw0M10sMzE6WzEsNDRdLDMyOjQwLDMzOjQ2LDM0OlsxLDQ3XSwzNjoyNX0sezE4OlsyLDI1XX0sezE4OlsyLDQxXSwyNzpbMiw0MV0sMjk6WzIsNDFdLDMwOlsyLDQxXSwzMTpbMiw0MV0sMzQ6WzIsNDFdLDM3OlsxLDQ4XX0sezE4OlsyLDQzXSwyNzpbMiw0M10sMjk6WzIsNDNdLDMwOlsyLDQzXSwzMTpbMiw0M10sMzQ6WzIsNDNdLDM3OlsyLDQzXX0sezE4OlsxLDQ5XX0sezE4OlsxLDUwXX0sezE4OlsxLDUxXX0sezE4OlsxLDUyXSwyMTo1MywzNDpbMSwyNl0sMzY6MjV9LHs1OlsyLDJdLDg6MTgsOTo1LDExOjYsMTI6NywxMzo4LDE0OlsxLDldLDE1OlsxLDEwXSwxNjpbMSwxMl0sMTk6WzEsMTFdLDIwOlsyLDJdLDIyOlsxLDEzXSwyMzpbMSwxNF0sMjQ6WzEsMTVdfSx7MTQ6WzIsMjBdLDE1OlsyLDIwXSwxNjpbMiwyMF0sMTk6WzIsMjBdLDIyOlsyLDIwXSwyMzpbMiwyMF0sMjQ6WzIsMjBdfSx7NTpbMiw3XSwxNDpbMiw3XSwxNTpbMiw3XSwxNjpbMiw3XSwxOTpbMiw3XSwyMDpbMiw3XSwyMjpbMiw3XSwyMzpbMiw3XSwyNDpbMiw3XX0sezIxOjU0LDM0OlsxLDI2XSwzNjoyNX0sezU6WzIsOF0sMTQ6WzIsOF0sMTU6WzIsOF0sMTY6WzIsOF0sMTk6WzIsOF0sMjA6WzIsOF0sMjI6WzIsOF0sMjM6WzIsOF0sMjQ6WzIsOF19LHsxNDpbMiwxNF0sMTU6WzIsMTRdLDE2OlsyLDE0XSwxOTpbMiwxNF0sMjA6WzIsMTRdLDIyOlsyLDE0XSwyMzpbMiwxNF0sMjQ6WzIsMTRdfSx7MTg6WzIsMjJdLDIxOjQxLDI2OjU1LDI3OlsxLDQ1XSwyODo1NiwyOTpbMSw0Ml0sMzA6WzEsNDNdLDMxOlsxLDQ0XSwzMjo0MCwzMzo0NiwzNDpbMSw0N10sMzY6MjV9LHsxODpbMiwyM119LHsxODpbMiwyN10sMjc6WzIsMjddLDI5OlsyLDI3XSwzMDpbMiwyN10sMzE6WzIsMjddLDM0OlsyLDI3XX0sezE4OlsyLDMzXSwzMzo1NywzNDpbMSw1OF19LHsxODpbMiwyOF0sMjc6WzIsMjhdLDI5OlsyLDI4XSwzMDpbMiwyOF0sMzE6WzIsMjhdLDM0OlsyLDI4XX0sezE4OlsyLDI5XSwyNzpbMiwyOV0sMjk6WzIsMjldLDMwOlsyLDI5XSwzMTpbMiwyOV0sMzQ6WzIsMjldfSx7MTg6WzIsMzBdLDI3OlsyLDMwXSwyOTpbMiwzMF0sMzA6WzIsMzBdLDMxOlsyLDMwXSwzNDpbMiwzMF19LHsxODpbMiwzMV0sMjc6WzIsMzFdLDI5OlsyLDMxXSwzMDpbMiwzMV0sMzE6WzIsMzFdLDM0OlsyLDMxXX0sezE4OlsyLDMyXSwyNzpbMiwzMl0sMjk6WzIsMzJdLDMwOlsyLDMyXSwzMTpbMiwzMl0sMzQ6WzIsMzJdfSx7MTg6WzIsMzVdLDM0OlsyLDM1XX0sezE4OlsyLDQzXSwyNzpbMiw0M10sMjk6WzIsNDNdLDMwOlsyLDQzXSwzMTpbMiw0M10sMzQ6WzIsNDNdLDM1OlsxLDU5XSwzNzpbMiw0M119LHszNDpbMSw2MF19LHsxNDpbMiwxM10sMTU6WzIsMTNdLDE2OlsyLDEzXSwxOTpbMiwxM10sMjA6WzIsMTNdLDIyOlsyLDEzXSwyMzpbMiwxM10sMjQ6WzIsMTNdfSx7NTpbMiwxNl0sMTQ6WzIsMTZdLDE1OlsyLDE2XSwxNjpbMiwxNl0sMTk6WzIsMTZdLDIwOlsyLDE2XSwyMjpbMiwxNl0sMjM6WzIsMTZdLDI0OlsyLDE2XX0sezU6WzIsMTddLDE0OlsyLDE3XSwxNTpbMiwxN10sMTY6WzIsMTddLDE5OlsyLDE3XSwyMDpbMiwxN10sMjI6WzIsMTddLDIzOlsyLDE3XSwyNDpbMiwxN119LHs1OlsyLDE4XSwxNDpbMiwxOF0sMTU6WzIsMThdLDE2OlsyLDE4XSwxOTpbMiwxOF0sMjA6WzIsMThdLDIyOlsyLDE4XSwyMzpbMiwxOF0sMjQ6WzIsMThdfSx7MTg6WzEsNjFdfSx7MTg6WzEsNjJdfSx7MTg6WzIsMjFdfSx7MTg6WzIsMjZdLDI3OlsyLDI2XSwyOTpbMiwyNl0sMzA6WzIsMjZdLDMxOlsyLDI2XSwzNDpbMiwyNl19LHsxODpbMiwzNF0sMzQ6WzIsMzRdfSx7MzU6WzEsNTldfSx7MjE6NjMsMjc6WzEsNjddLDI5OlsxLDY0XSwzMDpbMSw2NV0sMzE6WzEsNjZdLDM0OlsxLDI2XSwzNjoyNX0sezE4OlsyLDQyXSwyNzpbMiw0Ml0sMjk6WzIsNDJdLDMwOlsyLDQyXSwzMTpbMiw0Ml0sMzQ6WzIsNDJdLDM3OlsyLDQyXX0sezU6WzIsMTldLDE0OlsyLDE5XSwxNTpbMiwxOV0sMTY6WzIsMTldLDE5OlsyLDE5XSwyMDpbMiwxOV0sMjI6WzIsMTldLDIzOlsyLDE5XSwyNDpbMiwxOV19LHs1OlsyLDE1XSwxNDpbMiwxNV0sMTU6WzIsMTVdLDE2OlsyLDE1XSwxOTpbMiwxNV0sMjA6WzIsMTVdLDIyOlsyLDE1XSwyMzpbMiwxNV0sMjQ6WzIsMTVdfSx7MTg6WzIsMzZdLDM0OlsyLDM2XX0sezE4OlsyLDM3XSwzNDpbMiwzN119LHsxODpbMiwzOF0sMzQ6WzIsMzhdfSx7MTg6WzIsMzldLDM0OlsyLDM5XX0sezE4OlsyLDQwXSwzNDpbMiw0MF19XSwKZGVmYXVsdEFjdGlvbnM6IHsxNjpbMiwxXSwyNDpbMiwyNV0sMzg6WzIsMjNdLDU1OlsyLDIxXX0sCnBhcnNlRXJyb3I6IGZ1bmN0aW9uIHBhcnNlRXJyb3Ioc3RyLCBoYXNoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3Ioc3RyKTsKfSwKcGFyc2U6IGZ1bmN0aW9uIHBhcnNlKGlucHV0KSB7CiAgICB2YXIgc2VsZiA9IHRoaXMsIHN0YWNrID0gWzBdLCB2c3RhY2sgPSBbbnVsbF0sIGxzdGFjayA9IFtdLCB0YWJsZSA9IHRoaXMudGFibGUsIHl5dGV4dCA9ICIiLCB5eWxpbmVubyA9IDAsIHl5bGVuZyA9IDAsIHJlY292ZXJpbmcgPSAwLCBURVJST1IgPSAyLCBFT0YgPSAxOwogICAgdGhpcy5sZXhlci5zZXRJbnB1dChpbnB1dCk7CiAgICB0aGlzLmxleGVyLnl5ID0gdGhpcy55eTsKICAgIHRoaXMueXkubGV4ZXIgPSB0aGlzLmxleGVyOwogICAgdGhpcy55eS5wYXJzZXIgPSB0aGlzOwogICAgaWYgKHR5cGVvZiB0aGlzLmxleGVyLnl5bGxvYyA9PSAidW5kZWZpbmVkIikKICAgICAgICB0aGlzLmxleGVyLnl5bGxvYyA9IHt9OwogICAgdmFyIHl5bG9jID0gdGhpcy5sZXhlci55eWxsb2M7CiAgICBsc3RhY2sucHVzaCh5eWxvYyk7CiAgICB2YXIgcmFuZ2VzID0gdGhpcy5sZXhlci5vcHRpb25zICYmIHRoaXMubGV4ZXIub3B0aW9ucy5yYW5nZXM7CiAgICBpZiAodHlwZW9mIHRoaXMueXkucGFyc2VFcnJvciA9PT0gImZ1bmN0aW9uIikKICAgICAgICB0aGlzLnBhcnNlRXJyb3IgPSB0aGlzLnl5LnBhcnNlRXJyb3I7CiAgICBmdW5jdGlvbiBwb3BTdGFjayhuKSB7CiAgICAgICAgc3RhY2subGVuZ3RoID0gc3RhY2subGVuZ3RoIC0gMiAqIG47CiAgICAgICAgdnN0YWNrLmxlbmd0aCA9IHZzdGFjay5sZW5ndGggLSBuOwogICAgICAgIGxzdGFjay5sZW5ndGggPSBsc3RhY2subGVuZ3RoIC0gbjsKICAgIH0KICAgIGZ1bmN0aW9uIGxleCgpIHsKICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgdG9rZW4gPSBzZWxmLmxleGVyLmxleCgpIHx8IDE7CiAgICAgICAgaWYgKHR5cGVvZiB0b2tlbiAhPT0gIm51bWJlciIpIHsKICAgICAgICAgICAgdG9rZW4gPSBzZWxmLnN5bWJvbHNfW3Rva2VuXSB8fCB0b2tlbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRva2VuOwogICAgfQogICAgdmFyIHN5bWJvbCwgcHJlRXJyb3JTeW1ib2wsIHN0YXRlLCBhY3Rpb24sIGEsIHIsIHl5dmFsID0ge30sIHAsIGxlbiwgbmV3U3RhdGUsIGV4cGVjdGVkOwogICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBzdGF0ZSA9IHN0YWNrW3N0YWNrLmxlbmd0aCAtIDFdOwogICAgICAgIGlmICh0aGlzLmRlZmF1bHRBY3Rpb25zW3N0YXRlXSkgewogICAgICAgICAgICBhY3Rpb24gPSB0aGlzLmRlZmF1bHRBY3Rpb25zW3N0YXRlXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoc3ltYm9sID09PSBudWxsIHx8IHR5cGVvZiBzeW1ib2wgPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIHN5bWJvbCA9IGxleCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFjdGlvbiA9IHRhYmxlW3N0YXRlXSAmJiB0YWJsZVtzdGF0ZV1bc3ltYm9sXTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBhY3Rpb24gPT09ICJ1bmRlZmluZWQiIHx8ICFhY3Rpb24ubGVuZ3RoIHx8ICFhY3Rpb25bMF0pIHsKICAgICAgICAgICAgdmFyIGVyclN0ciA9ICIiOwogICAgICAgICAgICBpZiAoIXJlY292ZXJpbmcpIHsKICAgICAgICAgICAgICAgIGV4cGVjdGVkID0gW107CiAgICAgICAgICAgICAgICBmb3IgKHAgaW4gdGFibGVbc3RhdGVdKQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlcm1pbmFsc19bcF0gJiYgcCA+IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXhwZWN0ZWQucHVzaCgiJyIgKyB0aGlzLnRlcm1pbmFsc19bcF0gKyAiJyIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0aGlzLmxleGVyLnNob3dQb3NpdGlvbikgewogICAgICAgICAgICAgICAgICAgIGVyclN0ciA9ICJQYXJzZSBlcnJvciBvbiBsaW5lICIgKyAoeXlsaW5lbm8gKyAxKSArICI6XG4iICsgdGhpcy5sZXhlci5zaG93UG9zaXRpb24oKSArICJcbkV4cGVjdGluZyAiICsgZXhwZWN0ZWQuam9pbigiLCAiKSArICIsIGdvdCAnIiArICh0aGlzLnRlcm1pbmFsc19bc3ltYm9sXSB8fCBzeW1ib2wpICsgIiciOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlcnJTdHIgPSAiUGFyc2UgZXJyb3Igb24gbGluZSAiICsgKHl5bGluZW5vICsgMSkgKyAiOiBVbmV4cGVjdGVkICIgKyAoc3ltYm9sID09IDE/ImVuZCBvZiBpbnB1dCI6IiciICsgKHRoaXMudGVybWluYWxzX1tzeW1ib2xdIHx8IHN5bWJvbCkgKyAiJyIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5wYXJzZUVycm9yKGVyclN0ciwge3RleHQ6IHRoaXMubGV4ZXIubWF0Y2gsIHRva2VuOiB0aGlzLnRlcm1pbmFsc19bc3ltYm9sXSB8fCBzeW1ib2wsIGxpbmU6IHRoaXMubGV4ZXIueXlsaW5lbm8sIGxvYzogeXlsb2MsIGV4cGVjdGVkOiBleHBlY3RlZH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChhY3Rpb25bMF0gaW5zdGFuY2VvZiBBcnJheSAmJiBhY3Rpb24ubGVuZ3RoID4gMSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlBhcnNlIEVycm9yOiBtdWx0aXBsZSBhY3Rpb25zIHBvc3NpYmxlIGF0IHN0YXRlOiAiICsgc3RhdGUgKyAiLCB0b2tlbjogIiArIHN5bWJvbCk7CiAgICAgICAgfQogICAgICAgIHN3aXRjaCAoYWN0aW9uWzBdKSB7CiAgICAgICAgY2FzZSAxOgogICAgICAgICAgICBzdGFjay5wdXNoKHN5bWJvbCk7CiAgICAgICAgICAgIHZzdGFjay5wdXNoKHRoaXMubGV4ZXIueXl0ZXh0KTsKICAgICAgICAgICAgbHN0YWNrLnB1c2godGhpcy5sZXhlci55eWxsb2MpOwogICAgICAgICAgICBzdGFjay5wdXNoKGFjdGlvblsxXSk7CiAgICAgICAgICAgIHN5bWJvbCA9IG51bGw7CiAgICAgICAgICAgIGlmICghcHJlRXJyb3JTeW1ib2wpIHsKICAgICAgICAgICAgICAgIHl5bGVuZyA9IHRoaXMubGV4ZXIueXlsZW5nOwogICAgICAgICAgICAgICAgeXl0ZXh0ID0gdGhpcy5sZXhlci55eXRleHQ7CiAgICAgICAgICAgICAgICB5eWxpbmVubyA9IHRoaXMubGV4ZXIueXlsaW5lbm87CiAgICAgICAgICAgICAgICB5eWxvYyA9IHRoaXMubGV4ZXIueXlsbG9jOwogICAgICAgICAgICAgICAgaWYgKHJlY292ZXJpbmcgPiAwKQogICAgICAgICAgICAgICAgICAgIHJlY292ZXJpbmctLTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN5bWJvbCA9IHByZUVycm9yU3ltYm9sOwogICAgICAgICAgICAgICAgcHJlRXJyb3JTeW1ib2wgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgbGVuID0gdGhpcy5wcm9kdWN0aW9uc19bYWN0aW9uWzFdXVsxXTsKICAgICAgICAgICAgeXl2YWwuJCA9IHZzdGFja1t2c3RhY2subGVuZ3RoIC0gbGVuXTsKICAgICAgICAgICAgeXl2YWwuXyQgPSB7Zmlyc3RfbGluZTogbHN0YWNrW2xzdGFjay5sZW5ndGggLSAobGVuIHx8IDEpXS5maXJzdF9saW5lLCBsYXN0X2xpbmU6IGxzdGFja1tsc3RhY2subGVuZ3RoIC0gMV0ubGFzdF9saW5lLCBmaXJzdF9jb2x1bW46IGxzdGFja1tsc3RhY2subGVuZ3RoIC0gKGxlbiB8fCAxKV0uZmlyc3RfY29sdW1uLCBsYXN0X2NvbHVtbjogbHN0YWNrW2xzdGFjay5sZW5ndGggLSAxXS5sYXN0X2NvbHVtbn07CiAgICAgICAgICAgIGlmIChyYW5nZXMpIHsKICAgICAgICAgICAgICAgIHl5dmFsLl8kLnJhbmdlID0gW2xzdGFja1tsc3RhY2subGVuZ3RoIC0gKGxlbiB8fCAxKV0ucmFuZ2VbMF0sIGxzdGFja1tsc3RhY2subGVuZ3RoIC0gMV0ucmFuZ2VbMV1dOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHIgPSB0aGlzLnBlcmZvcm1BY3Rpb24uY2FsbCh5eXZhbCwgeXl0ZXh0LCB5eWxlbmcsIHl5bGluZW5vLCB0aGlzLnl5LCBhY3Rpb25bMV0sIHZzdGFjaywgbHN0YWNrKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiByICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxlbikgewogICAgICAgICAgICAgICAgc3RhY2sgPSBzdGFjay5zbGljZSgwLCAtMSAqIGxlbiAqIDIpOwogICAgICAgICAgICAgICAgdnN0YWNrID0gdnN0YWNrLnNsaWNlKDAsIC0xICogbGVuKTsKICAgICAgICAgICAgICAgIGxzdGFjayA9IGxzdGFjay5zbGljZSgwLCAtMSAqIGxlbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3RhY2sucHVzaCh0aGlzLnByb2R1Y3Rpb25zX1thY3Rpb25bMV1dWzBdKTsKICAgICAgICAgICAgdnN0YWNrLnB1c2goeXl2YWwuJCk7CiAgICAgICAgICAgIGxzdGFjay5wdXNoKHl5dmFsLl8kKTsKICAgICAgICAgICAgbmV3U3RhdGUgPSB0YWJsZVtzdGFja1tzdGFjay5sZW5ndGggLSAyXV1bc3RhY2tbc3RhY2subGVuZ3RoIC0gMV1dOwogICAgICAgICAgICBzdGFjay5wdXNoKG5ld1N0YXRlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAzOgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKfQp9OwovKiBKaXNvbiBnZW5lcmF0ZWQgbGV4ZXIgKi8KdmFyIGxleGVyID0gKGZ1bmN0aW9uKCl7CnZhciBsZXhlciA9ICh7RU9GOjEsCnBhcnNlRXJyb3I6ZnVuY3Rpb24gcGFyc2VFcnJvcihzdHIsIGhhc2gpIHsKICAgICAgICBpZiAodGhpcy55eS5wYXJzZXIpIHsKICAgICAgICAgICAgdGhpcy55eS5wYXJzZXIucGFyc2VFcnJvcihzdHIsIGhhc2gpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihzdHIpOwogICAgICAgIH0KICAgIH0sCnNldElucHV0OmZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgIHRoaXMuX2lucHV0ID0gaW5wdXQ7CiAgICAgICAgdGhpcy5fbW9yZSA9IHRoaXMuX2xlc3MgPSB0aGlzLmRvbmUgPSBmYWxzZTsKICAgICAgICB0aGlzLnl5bGluZW5vID0gdGhpcy55eWxlbmcgPSAwOwogICAgICAgIHRoaXMueXl0ZXh0ID0gdGhpcy5tYXRjaGVkID0gdGhpcy5tYXRjaCA9ICcnOwogICAgICAgIHRoaXMuY29uZGl0aW9uU3RhY2sgPSBbJ0lOSVRJQUwnXTsKICAgICAgICB0aGlzLnl5bGxvYyA9IHtmaXJzdF9saW5lOjEsZmlyc3RfY29sdW1uOjAsbGFzdF9saW5lOjEsbGFzdF9jb2x1bW46MH07CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5yYW5nZXMpIHRoaXMueXlsbG9jLnJhbmdlID0gWzAsMF07CiAgICAgICAgdGhpcy5vZmZzZXQgPSAwOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKaW5wdXQ6ZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBjaCA9IHRoaXMuX2lucHV0WzBdOwogICAgICAgIHRoaXMueXl0ZXh0ICs9IGNoOwogICAgICAgIHRoaXMueXlsZW5nKys7CiAgICAgICAgdGhpcy5vZmZzZXQrKzsKICAgICAgICB0aGlzLm1hdGNoICs9IGNoOwogICAgICAgIHRoaXMubWF0Y2hlZCArPSBjaDsKICAgICAgICB2YXIgbGluZXMgPSBjaC5tYXRjaCgvKD86XHJcbj98XG4pLiovZyk7CiAgICAgICAgaWYgKGxpbmVzKSB7CiAgICAgICAgICAgIHRoaXMueXlsaW5lbm8rKzsKICAgICAgICAgICAgdGhpcy55eWxsb2MubGFzdF9saW5lKys7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy55eWxsb2MubGFzdF9jb2x1bW4rKzsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5yYW5nZXMpIHRoaXMueXlsbG9jLnJhbmdlWzFdKys7CgogICAgICAgIHRoaXMuX2lucHV0ID0gdGhpcy5faW5wdXQuc2xpY2UoMSk7CiAgICAgICAgcmV0dXJuIGNoOwogICAgfSwKdW5wdXQ6ZnVuY3Rpb24gKGNoKSB7CiAgICAgICAgdmFyIGxlbiA9IGNoLmxlbmd0aDsKICAgICAgICB2YXIgbGluZXMgPSBjaC5zcGxpdCgvKD86XHJcbj98XG4pL2cpOwoKICAgICAgICB0aGlzLl9pbnB1dCA9IGNoICsgdGhpcy5faW5wdXQ7CiAgICAgICAgdGhpcy55eXRleHQgPSB0aGlzLnl5dGV4dC5zdWJzdHIoMCwgdGhpcy55eXRleHQubGVuZ3RoLWxlbi0xKTsKICAgICAgICAvL3RoaXMueXlsZW5nIC09IGxlbjsKICAgICAgICB0aGlzLm9mZnNldCAtPSBsZW47CiAgICAgICAgdmFyIG9sZExpbmVzID0gdGhpcy5tYXRjaC5zcGxpdCgvKD86XHJcbj98XG4pL2cpOwogICAgICAgIHRoaXMubWF0Y2ggPSB0aGlzLm1hdGNoLnN1YnN0cigwLCB0aGlzLm1hdGNoLmxlbmd0aC0xKTsKICAgICAgICB0aGlzLm1hdGNoZWQgPSB0aGlzLm1hdGNoZWQuc3Vic3RyKDAsIHRoaXMubWF0Y2hlZC5sZW5ndGgtMSk7CgogICAgICAgIGlmIChsaW5lcy5sZW5ndGgtMSkgdGhpcy55eWxpbmVubyAtPSBsaW5lcy5sZW5ndGgtMTsKICAgICAgICB2YXIgciA9IHRoaXMueXlsbG9jLnJhbmdlOwoKICAgICAgICB0aGlzLnl5bGxvYyA9IHtmaXJzdF9saW5lOiB0aGlzLnl5bGxvYy5maXJzdF9saW5lLAogICAgICAgICAgbGFzdF9saW5lOiB0aGlzLnl5bGluZW5vKzEsCiAgICAgICAgICBmaXJzdF9jb2x1bW46IHRoaXMueXlsbG9jLmZpcnN0X2NvbHVtbiwKICAgICAgICAgIGxhc3RfY29sdW1uOiBsaW5lcyA/CiAgICAgICAgICAgICAgKGxpbmVzLmxlbmd0aCA9PT0gb2xkTGluZXMubGVuZ3RoID8gdGhpcy55eWxsb2MuZmlyc3RfY29sdW1uIDogMCkgKyBvbGRMaW5lc1tvbGRMaW5lcy5sZW5ndGggLSBsaW5lcy5sZW5ndGhdLmxlbmd0aCAtIGxpbmVzWzBdLmxlbmd0aDoKICAgICAgICAgICAgICB0aGlzLnl5bGxvYy5maXJzdF9jb2x1bW4gLSBsZW4KICAgICAgICAgIH07CgogICAgICAgIGlmICh0aGlzLm9wdGlvbnMucmFuZ2VzKSB7CiAgICAgICAgICAgIHRoaXMueXlsbG9jLnJhbmdlID0gW3JbMF0sIHJbMF0gKyB0aGlzLnl5bGVuZyAtIGxlbl07CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKbW9yZTpmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5fbW9yZSA9IHRydWU7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LApsZXNzOmZ1bmN0aW9uIChuKSB7CiAgICAgICAgdGhpcy51bnB1dCh0aGlzLm1hdGNoLnNsaWNlKG4pKTsKICAgIH0sCnBhc3RJbnB1dDpmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHBhc3QgPSB0aGlzLm1hdGNoZWQuc3Vic3RyKDAsIHRoaXMubWF0Y2hlZC5sZW5ndGggLSB0aGlzLm1hdGNoLmxlbmd0aCk7CiAgICAgICAgcmV0dXJuIChwYXN0Lmxlbmd0aCA+IDIwID8gJy4uLic6JycpICsgcGFzdC5zdWJzdHIoLTIwKS5yZXBsYWNlKC9cbi9nLCAiIik7CiAgICB9LAp1cGNvbWluZ0lucHV0OmZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbmV4dCA9IHRoaXMubWF0Y2g7CiAgICAgICAgaWYgKG5leHQubGVuZ3RoIDwgMjApIHsKICAgICAgICAgICAgbmV4dCArPSB0aGlzLl9pbnB1dC5zdWJzdHIoMCwgMjAtbmV4dC5sZW5ndGgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gKG5leHQuc3Vic3RyKDAsMjApKyhuZXh0Lmxlbmd0aCA+IDIwID8gJy4uLic6JycpKS5yZXBsYWNlKC9cbi9nLCAiIik7CiAgICB9LApzaG93UG9zaXRpb246ZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBwcmUgPSB0aGlzLnBhc3RJbnB1dCgpOwogICAgICAgIHZhciBjID0gbmV3IEFycmF5KHByZS5sZW5ndGggKyAxKS5qb2luKCItIik7CiAgICAgICAgcmV0dXJuIHByZSArIHRoaXMudXBjb21pbmdJbnB1dCgpICsgIlxuIiArIGMrIl4iOwogICAgfSwKbmV4dDpmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHRoaXMuZG9uZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5FT0Y7CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5faW5wdXQpIHRoaXMuZG9uZSA9IHRydWU7CgogICAgICAgIHZhciB0b2tlbiwKICAgICAgICAgICAgbWF0Y2gsCiAgICAgICAgICAgIHRlbXBNYXRjaCwKICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgIGNvbCwKICAgICAgICAgICAgbGluZXM7CiAgICAgICAgaWYgKCF0aGlzLl9tb3JlKSB7CiAgICAgICAgICAgIHRoaXMueXl0ZXh0ID0gJyc7CiAgICAgICAgICAgIHRoaXMubWF0Y2ggPSAnJzsKICAgICAgICB9CiAgICAgICAgdmFyIHJ1bGVzID0gdGhpcy5fY3VycmVudFJ1bGVzKCk7CiAgICAgICAgZm9yICh2YXIgaT0wO2kgPCBydWxlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB0ZW1wTWF0Y2ggPSB0aGlzLl9pbnB1dC5tYXRjaCh0aGlzLnJ1bGVzW3J1bGVzW2ldXSk7CiAgICAgICAgICAgIGlmICh0ZW1wTWF0Y2ggJiYgKCFtYXRjaCB8fCB0ZW1wTWF0Y2hbMF0ubGVuZ3RoID4gbWF0Y2hbMF0ubGVuZ3RoKSkgewogICAgICAgICAgICAgICAgbWF0Y2ggPSB0ZW1wTWF0Y2g7CiAgICAgICAgICAgICAgICBpbmRleCA9IGk7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5mbGV4KSBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgbGluZXMgPSBtYXRjaFswXS5tYXRjaCgvKD86XHJcbj98XG4pLiovZyk7CiAgICAgICAgICAgIGlmIChsaW5lcykgdGhpcy55eWxpbmVubyArPSBsaW5lcy5sZW5ndGg7CiAgICAgICAgICAgIHRoaXMueXlsbG9jID0ge2ZpcnN0X2xpbmU6IHRoaXMueXlsbG9jLmxhc3RfbGluZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdF9saW5lOiB0aGlzLnl5bGluZW5vKzEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0X2NvbHVtbjogdGhpcy55eWxsb2MubGFzdF9jb2x1bW4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RfY29sdW1uOiBsaW5lcyA/IGxpbmVzW2xpbmVzLmxlbmd0aC0xXS5sZW5ndGgtbGluZXNbbGluZXMubGVuZ3RoLTFdLm1hdGNoKC9ccj9cbj8vKVswXS5sZW5ndGggOiB0aGlzLnl5bGxvYy5sYXN0X2NvbHVtbiArIG1hdGNoWzBdLmxlbmd0aH07CiAgICAgICAgICAgIHRoaXMueXl0ZXh0ICs9IG1hdGNoWzBdOwogICAgICAgICAgICB0aGlzLm1hdGNoICs9IG1hdGNoWzBdOwogICAgICAgICAgICB0aGlzLm1hdGNoZXMgPSBtYXRjaDsKICAgICAgICAgICAgdGhpcy55eWxlbmcgPSB0aGlzLnl5dGV4dC5sZW5ndGg7CiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMucmFuZ2VzKSB7CiAgICAgICAgICAgICAgICB0aGlzLnl5bGxvYy5yYW5nZSA9IFt0aGlzLm9mZnNldCwgdGhpcy5vZmZzZXQgKz0gdGhpcy55eWxlbmddOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX21vcmUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faW5wdXQgPSB0aGlzLl9pbnB1dC5zbGljZShtYXRjaFswXS5sZW5ndGgpOwogICAgICAgICAgICB0aGlzLm1hdGNoZWQgKz0gbWF0Y2hbMF07CiAgICAgICAgICAgIHRva2VuID0gdGhpcy5wZXJmb3JtQWN0aW9uLmNhbGwodGhpcywgdGhpcy55eSwgdGhpcywgcnVsZXNbaW5kZXhdLHRoaXMuY29uZGl0aW9uU3RhY2tbdGhpcy5jb25kaXRpb25TdGFjay5sZW5ndGgtMV0pOwogICAgICAgICAgICBpZiAodGhpcy5kb25lICYmIHRoaXMuX2lucHV0KSB0aGlzLmRvbmUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRva2VuKSByZXR1cm4gdG9rZW47CiAgICAgICAgICAgIGVsc2UgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5faW5wdXQgPT09ICIiKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLkVPRjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJzZUVycm9yKCdMZXhpY2FsIGVycm9yIG9uIGxpbmUgJysodGhpcy55eWxpbmVubysxKSsnLiBVbnJlY29nbml6ZWQgdGV4dC5cbicrdGhpcy5zaG93UG9zaXRpb24oKSwKICAgICAgICAgICAgICAgICAgICB7dGV4dDogIiIsIHRva2VuOiBudWxsLCBsaW5lOiB0aGlzLnl5bGluZW5vfSk7CiAgICAgICAgfQogICAgfSwKbGV4OmZ1bmN0aW9uIGxleCgpIHsKICAgICAgICB2YXIgciA9IHRoaXMubmV4dCgpOwogICAgICAgIGlmICh0eXBlb2YgciAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGV4KCk7CiAgICAgICAgfQogICAgfSwKYmVnaW46ZnVuY3Rpb24gYmVnaW4oY29uZGl0aW9uKSB7CiAgICAgICAgdGhpcy5jb25kaXRpb25TdGFjay5wdXNoKGNvbmRpdGlvbik7CiAgICB9LApwb3BTdGF0ZTpmdW5jdGlvbiBwb3BTdGF0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25kaXRpb25TdGFjay5wb3AoKTsKICAgIH0sCl9jdXJyZW50UnVsZXM6ZnVuY3Rpb24gX2N1cnJlbnRSdWxlcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25kaXRpb25zW3RoaXMuY29uZGl0aW9uU3RhY2tbdGhpcy5jb25kaXRpb25TdGFjay5sZW5ndGgtMV1dLnJ1bGVzOwogICAgfSwKdG9wU3RhdGU6ZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmNvbmRpdGlvblN0YWNrW3RoaXMuY29uZGl0aW9uU3RhY2subGVuZ3RoLTJdOwogICAgfSwKcHVzaFN0YXRlOmZ1bmN0aW9uIGJlZ2luKGNvbmRpdGlvbikgewogICAgICAgIHRoaXMuYmVnaW4oY29uZGl0aW9uKTsKICAgIH19KTsKbGV4ZXIub3B0aW9ucyA9IHt9OwpsZXhlci5wZXJmb3JtQWN0aW9uID0gZnVuY3Rpb24gYW5vbnltb3VzKHl5LHl5XywkYXZvaWRpbmdfbmFtZV9jb2xsaXNpb25zLFlZX1NUQVJUKSB7Cgp2YXIgWVlTVEFURT1ZWV9TVEFSVApzd2l0Y2goJGF2b2lkaW5nX25hbWVfY29sbGlzaW9ucykgewpjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeXlfLnl5dGV4dC5zbGljZSgtMSkgIT09ICJcXCIpIHRoaXMuYmVnaW4oIm11Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeXlfLnl5dGV4dC5zbGljZSgtMSkgPT09ICJcXCIpIHl5Xy55eXRleHQgPSB5eV8ueXl0ZXh0LnN1YnN0cigwLHl5Xy55eWxlbmctMSksIHRoaXMuYmVnaW4oImVtdSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHl5Xy55eXRleHQpIHJldHVybiAxNDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCmJyZWFrOwpjYXNlIDE6IHJldHVybiAxNDsgCmJyZWFrOwpjYXNlIDI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeXlfLnl5dGV4dC5zbGljZSgtMSkgIT09ICJcXCIpIHRoaXMucG9wU3RhdGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih5eV8ueXl0ZXh0LnNsaWNlKC0xKSA9PT0gIlxcIikgeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDAseXlfLnl5bGVuZy0xKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMTQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIApicmVhazsKY2FzZSAzOiByZXR1cm4gMjQ7IApicmVhazsKY2FzZSA0OiByZXR1cm4gMTY7IApicmVhazsKY2FzZSA1OiByZXR1cm4gMjA7IApicmVhazsKY2FzZSA2OiByZXR1cm4gMTk7IApicmVhazsKY2FzZSA3OiByZXR1cm4gMTk7IApicmVhazsKY2FzZSA4OiByZXR1cm4gMjM7IApicmVhazsKY2FzZSA5OiByZXR1cm4gMjM7IApicmVhazsKY2FzZSAxMDogeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDMseXlfLnl5bGVuZy01KTsgdGhpcy5wb3BTdGF0ZSgpOyByZXR1cm4gMTU7IApicmVhazsKY2FzZSAxMTogcmV0dXJuIDIyOyAKYnJlYWs7CmNhc2UgMTI6IHJldHVybiAzNTsgCmJyZWFrOwpjYXNlIDEzOiByZXR1cm4gMzQ7IApicmVhazsKY2FzZSAxNDogcmV0dXJuIDM0OyAKYnJlYWs7CmNhc2UgMTU6IHJldHVybiAzNzsgCmJyZWFrOwpjYXNlIDE2OiAvKmlnbm9yZSB3aGl0ZXNwYWNlKi8gCmJyZWFrOwpjYXNlIDE3OiB0aGlzLnBvcFN0YXRlKCk7IHJldHVybiAxODsgCmJyZWFrOwpjYXNlIDE4OiB0aGlzLnBvcFN0YXRlKCk7IHJldHVybiAxODsgCmJyZWFrOwpjYXNlIDE5OiB5eV8ueXl0ZXh0ID0geXlfLnl5dGV4dC5zdWJzdHIoMSx5eV8ueXlsZW5nLTIpLnJlcGxhY2UoL1xcIi9nLCciJyk7IHJldHVybiAyOTsgCmJyZWFrOwpjYXNlIDIwOiB5eV8ueXl0ZXh0ID0geXlfLnl5dGV4dC5zdWJzdHIoMSx5eV8ueXlsZW5nLTIpLnJlcGxhY2UoL1xcIi9nLCciJyk7IHJldHVybiAyOTsgCmJyZWFrOwpjYXNlIDIxOiB5eV8ueXl0ZXh0ID0geXlfLnl5dGV4dC5zdWJzdHIoMSk7IHJldHVybiAyNzsgCmJyZWFrOwpjYXNlIDIyOiByZXR1cm4gMzE7IApicmVhazsKY2FzZSAyMzogcmV0dXJuIDMxOyAKYnJlYWs7CmNhc2UgMjQ6IHJldHVybiAzMDsgCmJyZWFrOwpjYXNlIDI1OiByZXR1cm4gMzQ7IApicmVhazsKY2FzZSAyNjogeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDEsIHl5Xy55eWxlbmctMik7IHJldHVybiAzNDsgCmJyZWFrOwpjYXNlIDI3OiByZXR1cm4gJ0lOVkFMSUQnOyAKYnJlYWs7CmNhc2UgMjg6IHJldHVybiA1OyAKYnJlYWs7Cn0KfTsKbGV4ZXIucnVsZXMgPSBbL14oPzpbXlx4MDBdKj8oPz0oXHtceykpKS8sL14oPzpbXlx4MDBdKykvLC9eKD86W15ceDAwXXsyLH0/KD89KFx7XHt8JCkpKS8sL14oPzpce1x7PikvLC9eKD86XHtceyMpLywvXig/Olx7XHtcLykvLC9eKD86XHtce1xeKS8sL14oPzpce1x7XHMqZWxzZVxiKS8sL14oPzpce1x7XHspLywvXig/Olx7XHsmKS8sL14oPzpce1x7IVtcc1xTXSo/XH1cfSkvLC9eKD86XHtceykvLC9eKD86PSkvLC9eKD86XC4oPz1bfSBdKSkvLC9eKD86XC5cLikvLC9eKD86W1wvLl0pLywvXig/OlxzKykvLC9eKD86XH1cfVx9KS8sL14oPzpcfVx9KS8sL14oPzoiKFxcWyJdfFteIl0pKiIpLywvXig/OicoXFxbJ118W14nXSkqJykvLC9eKD86QFthLXpBLVpdKykvLC9eKD86dHJ1ZSg/PVt9XHNdKSkvLC9eKD86ZmFsc2UoPz1bfVxzXSkpLywvXig/OlswLTldKyg/PVt9XHNdKSkvLC9eKD86W2EtekEtWjAtOV8kLV0rKD89Wz19XHNcLy5dKSkvLC9eKD86XFtbXlxdXSpcXSkvLC9eKD86LikvLC9eKD86JCkvXTsKbGV4ZXIuY29uZGl0aW9ucyA9IHsibXUiOnsicnVsZXMiOlszLDQsNSw2LDcsOCw5LDEwLDExLDEyLDEzLDE0LDE1LDE2LDE3LDE4LDE5LDIwLDIxLDIyLDIzLDI0LDI1LDI2LDI3LDI4XSwiaW5jbHVzaXZlIjpmYWxzZX0sImVtdSI6eyJydWxlcyI6WzJdLCJpbmNsdXNpdmUiOmZhbHNlfSwiSU5JVElBTCI6eyJydWxlcyI6WzAsMSwyOF0sImluY2x1c2l2ZSI6dHJ1ZX19OwpyZXR1cm4gbGV4ZXI7fSkoKQpwYXJzZXIubGV4ZXIgPSBsZXhlcjsKZnVuY3Rpb24gUGFyc2VyICgpIHsgdGhpcy55eSA9IHt9OyB9UGFyc2VyLnByb3RvdHlwZSA9IHBhcnNlcjtwYXJzZXIuUGFyc2VyID0gUGFyc2VyOwpyZXR1cm4gbmV3IFBhcnNlcjsKfSkoKTsKaWYgKHR5cGVvZiByZXF1aXJlICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKZXhwb3J0cy5wYXJzZXIgPSBoYW5kbGViYXJzOwpleHBvcnRzLlBhcnNlciA9IGhhbmRsZWJhcnMuUGFyc2VyOwpleHBvcnRzLnBhcnNlID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gaGFuZGxlYmFycy5wYXJzZS5hcHBseShoYW5kbGViYXJzLCBhcmd1bWVudHMpOyB9CmV4cG9ydHMubWFpbiA9IGZ1bmN0aW9uIGNvbW1vbmpzTWFpbihhcmdzKSB7CiAgICBpZiAoIWFyZ3NbMV0pCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVc2FnZTogJythcmdzWzBdKycgRklMRScpOwogICAgdmFyIHNvdXJjZSwgY3dkOwogICAgaWYgKHR5cGVvZiBwcm9jZXNzICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIHNvdXJjZSA9IHJlcXVpcmUoJ2ZzJykucmVhZEZpbGVTeW5jKHJlcXVpcmUoJ3BhdGgnKS5yZXNvbHZlKGFyZ3NbMV0pLCAidXRmOCIpOwogICAgfSBlbHNlIHsKICAgICAgICBzb3VyY2UgPSByZXF1aXJlKCJmaWxlIikucGF0aChyZXF1aXJlKCJmaWxlIikuY3dkKCkpLmpvaW4oYXJnc1sxXSkucmVhZCh7Y2hhcnNldDogInV0Zi04In0pOwogICAgfQogICAgcmV0dXJuIGV4cG9ydHMucGFyc2VyLnBhcnNlKHNvdXJjZSk7Cn0KaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIHJlcXVpcmUubWFpbiA9PT0gbW9kdWxlKSB7CiAgZXhwb3J0cy5tYWluKHR5cGVvZiBwcm9jZXNzICE9PSAndW5kZWZpbmVkJyA/IHByb2Nlc3MuYXJndi5zbGljZSgxKSA6IHJlcXVpcmUoInN5c3RlbSIpLmFyZ3MpOwp9Cn07CjsKLy8gbGliL2hhbmRsZWJhcnMvY29tcGlsZXIvYmFzZS5qcwpIYW5kbGViYXJzLlBhcnNlciA9IGhhbmRsZWJhcnM7CgpIYW5kbGViYXJzLnBhcnNlID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgSGFuZGxlYmFycy5QYXJzZXIueXkgPSBIYW5kbGViYXJzLkFTVDsKICByZXR1cm4gSGFuZGxlYmFycy5QYXJzZXIucGFyc2Uoc3RyaW5nKTsKfTsKCkhhbmRsZWJhcnMucHJpbnQgPSBmdW5jdGlvbihhc3QpIHsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuUHJpbnRWaXNpdG9yKCkuYWNjZXB0KGFzdCk7Cn07CgpIYW5kbGViYXJzLmxvZ2dlciA9IHsKICBERUJVRzogMCwgSU5GTzogMSwgV0FSTjogMiwgRVJST1I6IDMsIGxldmVsOiAzLAoKICAvLyBvdmVycmlkZSBpbiB0aGUgaG9zdCBlbnZpcm9ubWVudAogIGxvZzogZnVuY3Rpb24obGV2ZWwsIHN0cikge30KfTsKCkhhbmRsZWJhcnMubG9nID0gZnVuY3Rpb24obGV2ZWwsIHN0cikgeyBIYW5kbGViYXJzLmxvZ2dlci5sb2cobGV2ZWwsIHN0cik7IH07CjsKLy8gbGliL2hhbmRsZWJhcnMvY29tcGlsZXIvYXN0LmpzCihmdW5jdGlvbigpIHsKCiAgSGFuZGxlYmFycy5BU1QgPSB7fTsKCiAgSGFuZGxlYmFycy5BU1QuUHJvZ3JhbU5vZGUgPSBmdW5jdGlvbihzdGF0ZW1lbnRzLCBpbnZlcnNlKSB7CiAgICB0aGlzLnR5cGUgPSAicHJvZ3JhbSI7CiAgICB0aGlzLnN0YXRlbWVudHMgPSBzdGF0ZW1lbnRzOwogICAgaWYoaW52ZXJzZSkgeyB0aGlzLmludmVyc2UgPSBuZXcgSGFuZGxlYmFycy5BU1QuUHJvZ3JhbU5vZGUoaW52ZXJzZSk7IH0KICB9OwoKICBIYW5kbGViYXJzLkFTVC5NdXN0YWNoZU5vZGUgPSBmdW5jdGlvbihyYXdQYXJhbXMsIGhhc2gsIHVuZXNjYXBlZCkgewogICAgdGhpcy50eXBlID0gIm11c3RhY2hlIjsKICAgIHRoaXMuZXNjYXBlZCA9ICF1bmVzY2FwZWQ7CiAgICB0aGlzLmhhc2ggPSBoYXNoOwoKICAgIHZhciBpZCA9IHRoaXMuaWQgPSByYXdQYXJhbXNbMF07CiAgICB2YXIgcGFyYW1zID0gdGhpcy5wYXJhbXMgPSByYXdQYXJhbXMuc2xpY2UoMSk7CgogICAgLy8gYSBtdXN0YWNoZSBpcyBhbiBlbGlnaWJsZSBoZWxwZXIgaWY6CiAgICAvLyAqIGl0cyBpZCBpcyBzaW1wbGUgKGEgc2luZ2xlIHBhcnQsIG5vdCBgdGhpc2Agb3IgYC4uYCkKICAgIHZhciBlbGlnaWJsZUhlbHBlciA9IHRoaXMuZWxpZ2libGVIZWxwZXIgPSBpZC5pc1NpbXBsZTsKCiAgICAvLyBhIG11c3RhY2hlIGlzIGRlZmluaXRlbHkgYSBoZWxwZXIgaWY6CiAgICAvLyAqIGl0IGlzIGFuIGVsaWdpYmxlIGhlbHBlciwgYW5kCiAgICAvLyAqIGl0IGhhcyBhdCBsZWFzdCBvbmUgcGFyYW1ldGVyIG9yIGhhc2ggc2VnbWVudAogICAgdGhpcy5pc0hlbHBlciA9IGVsaWdpYmxlSGVscGVyICYmIChwYXJhbXMubGVuZ3RoIHx8IGhhc2gpOwoKICAgIC8vIGlmIGEgbXVzdGFjaGUgaXMgYW4gZWxpZ2libGUgaGVscGVyIGJ1dCBub3QgYSBkZWZpbml0ZQogICAgLy8gaGVscGVyLCBpdCBpcyBhbWJpZ3VvdXMsIGFuZCB3aWxsIGJlIHJlc29sdmVkIGluIGEgbGF0ZXIKICAgIC8vIHBhc3Mgb3IgYXQgcnVudGltZS4KICB9OwoKICBIYW5kbGViYXJzLkFTVC5QYXJ0aWFsTm9kZSA9IGZ1bmN0aW9uKGlkLCBjb250ZXh0KSB7CiAgICB0aGlzLnR5cGUgICAgPSAicGFydGlhbCI7CgogICAgLy8gVE9ETzogZGlzYWxsb3cgY29tcGxleCBJRHMKCiAgICB0aGlzLmlkICAgICAgPSBpZDsKICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgfTsKCiAgdmFyIHZlcmlmeU1hdGNoID0gZnVuY3Rpb24ob3BlbiwgY2xvc2UpIHsKICAgIGlmKG9wZW4ub3JpZ2luYWwgIT09IGNsb3NlLm9yaWdpbmFsKSB7CiAgICAgIHRocm93IG5ldyBIYW5kbGViYXJzLkV4Y2VwdGlvbihvcGVuLm9yaWdpbmFsICsgIiBkb2Vzbid0IG1hdGNoICIgKyBjbG9zZS5vcmlnaW5hbCk7CiAgICB9CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuQmxvY2tOb2RlID0gZnVuY3Rpb24obXVzdGFjaGUsIHByb2dyYW0sIGludmVyc2UsIGNsb3NlKSB7CiAgICB2ZXJpZnlNYXRjaChtdXN0YWNoZS5pZCwgY2xvc2UpOwogICAgdGhpcy50eXBlID0gImJsb2NrIjsKICAgIHRoaXMubXVzdGFjaGUgPSBtdXN0YWNoZTsKICAgIHRoaXMucHJvZ3JhbSAgPSBwcm9ncmFtOwogICAgdGhpcy5pbnZlcnNlICA9IGludmVyc2U7CgogICAgaWYgKHRoaXMuaW52ZXJzZSAmJiAhdGhpcy5wcm9ncmFtKSB7CiAgICAgIHRoaXMuaXNJbnZlcnNlID0gdHJ1ZTsKICAgIH0KICB9OwoKICBIYW5kbGViYXJzLkFTVC5Db250ZW50Tm9kZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgdGhpcy50eXBlID0gImNvbnRlbnQiOwogICAgdGhpcy5zdHJpbmcgPSBzdHJpbmc7CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuSGFzaE5vZGUgPSBmdW5jdGlvbihwYWlycykgewogICAgdGhpcy50eXBlID0gImhhc2giOwogICAgdGhpcy5wYWlycyA9IHBhaXJzOwogIH07CgogIEhhbmRsZWJhcnMuQVNULklkTm9kZSA9IGZ1bmN0aW9uKHBhcnRzKSB7CiAgICB0aGlzLnR5cGUgPSAiSUQiOwogICAgdGhpcy5vcmlnaW5hbCA9IHBhcnRzLmpvaW4oIi4iKTsKCiAgICB2YXIgZGlnID0gW10sIGRlcHRoID0gMDsKCiAgICBmb3IodmFyIGk9MCxsPXBhcnRzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgdmFyIHBhcnQgPSBwYXJ0c1tpXTsKCiAgICAgIGlmKHBhcnQgPT09ICIuLiIpIHsgZGVwdGgrKzsgfQogICAgICBlbHNlIGlmKHBhcnQgPT09ICIuIiB8fCBwYXJ0ID09PSAidGhpcyIpIHsgdGhpcy5pc1Njb3BlZCA9IHRydWU7IH0KICAgICAgZWxzZSB7IGRpZy5wdXNoKHBhcnQpOyB9CiAgICB9CgogICAgdGhpcy5wYXJ0cyAgICA9IGRpZzsKICAgIHRoaXMuc3RyaW5nICAgPSBkaWcuam9pbignLicpOwogICAgdGhpcy5kZXB0aCAgICA9IGRlcHRoOwoKICAgIC8vIGFuIElEIGlzIHNpbXBsZSBpZiBpdCBvbmx5IGhhcyBvbmUgcGFydCwgYW5kIHRoYXQgcGFydCBpcyBub3QKICAgIC8vIGAuLmAgb3IgYHRoaXNgLgogICAgdGhpcy5pc1NpbXBsZSA9IHBhcnRzLmxlbmd0aCA9PT0gMSAmJiAhdGhpcy5pc1Njb3BlZCAmJiBkZXB0aCA9PT0gMDsKICB9OwoKICBIYW5kbGViYXJzLkFTVC5EYXRhTm9kZSA9IGZ1bmN0aW9uKGlkKSB7CiAgICB0aGlzLnR5cGUgPSAiREFUQSI7CiAgICB0aGlzLmlkID0gaWQ7CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuU3RyaW5nTm9kZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgdGhpcy50eXBlID0gIlNUUklORyI7CiAgICB0aGlzLnN0cmluZyA9IHN0cmluZzsKICB9OwoKICBIYW5kbGViYXJzLkFTVC5JbnRlZ2VyTm9kZSA9IGZ1bmN0aW9uKGludGVnZXIpIHsKICAgIHRoaXMudHlwZSA9ICJJTlRFR0VSIjsKICAgIHRoaXMuaW50ZWdlciA9IGludGVnZXI7CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuQm9vbGVhbk5vZGUgPSBmdW5jdGlvbihib29sKSB7CiAgICB0aGlzLnR5cGUgPSAiQk9PTEVBTiI7CiAgICB0aGlzLmJvb2wgPSBib29sOwogIH07CgogIEhhbmRsZWJhcnMuQVNULkNvbW1lbnROb2RlID0gZnVuY3Rpb24oY29tbWVudCkgewogICAgdGhpcy50eXBlID0gImNvbW1lbnQiOwogICAgdGhpcy5jb21tZW50ID0gY29tbWVudDsKICB9OwoKfSkoKTs7Ci8vIGxpYi9oYW5kbGViYXJzL3V0aWxzLmpzCkhhbmRsZWJhcnMuRXhjZXB0aW9uID0gZnVuY3Rpb24obWVzc2FnZSkgewogIHZhciB0bXAgPSBFcnJvci5wcm90b3R5cGUuY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgZm9yICh2YXIgcCBpbiB0bXApIHsKICAgIGlmICh0bXAuaGFzT3duUHJvcGVydHkocCkpIHsgdGhpc1twXSA9IHRtcFtwXTsgfQogIH0KCiAgdGhpcy5tZXNzYWdlID0gdG1wLm1lc3NhZ2U7Cn07CkhhbmRsZWJhcnMuRXhjZXB0aW9uLnByb3RvdHlwZSA9IG5ldyBFcnJvcigpOwoKLy8gQnVpbGQgb3V0IG91ciBiYXNpYyBTYWZlU3RyaW5nIHR5cGUKSGFuZGxlYmFycy5TYWZlU3RyaW5nID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgdGhpcy5zdHJpbmcgPSBzdHJpbmc7Cn07CkhhbmRsZWJhcnMuU2FmZVN0cmluZy5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5zdHJpbmcudG9TdHJpbmcoKTsKfTsKCihmdW5jdGlvbigpIHsKICB2YXIgZXNjYXBlID0gewogICAgIiYiOiAiJmFtcDsiLAogICAgIjwiOiAiJmx0OyIsCiAgICAiPiI6ICImZ3Q7IiwKICAgICciJzogIiZxdW90OyIsCiAgICAiJyI6ICImI3gyNzsiLAogICAgImAiOiAiJiN4NjA7IgogIH07CgogIHZhciBiYWRDaGFycyA9IC9bJjw+IidgXS9nOwogIHZhciBwb3NzaWJsZSA9IC9bJjw+IidgXS87CgogIHZhciBlc2NhcGVDaGFyID0gZnVuY3Rpb24oY2hyKSB7CiAgICByZXR1cm4gZXNjYXBlW2Nocl0gfHwgIiZhbXA7IjsKICB9OwoKICBIYW5kbGViYXJzLlV0aWxzID0gewogICAgZXNjYXBlRXhwcmVzc2lvbjogZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgIC8vIGRvbid0IGVzY2FwZSBTYWZlU3RyaW5ncywgc2luY2UgdGhleSdyZSBhbHJlYWR5IHNhZmUKICAgICAgaWYgKHN0cmluZyBpbnN0YW5jZW9mIEhhbmRsZWJhcnMuU2FmZVN0cmluZykgewogICAgICAgIHJldHVybiBzdHJpbmcudG9TdHJpbmcoKTsKICAgICAgfSBlbHNlIGlmIChzdHJpbmcgPT0gbnVsbCB8fCBzdHJpbmcgPT09IGZhbHNlKSB7CiAgICAgICAgcmV0dXJuICIiOwogICAgICB9CgogICAgICBpZighcG9zc2libGUudGVzdChzdHJpbmcpKSB7IHJldHVybiBzdHJpbmc7IH0KICAgICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKGJhZENoYXJzLCBlc2NhcGVDaGFyKTsKICAgIH0sCgogICAgaXNFbXB0eTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBmYWxzZSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgaWYoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKSA9PT0gIltvYmplY3QgQXJyYXldIiAmJiB2YWx1ZS5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICB9Owp9KSgpOzsKLy8gbGliL2hhbmRsZWJhcnMvY29tcGlsZXIvY29tcGlsZXIuanMKCi8qanNoaW50IGVxbnVsbDp0cnVlKi8KSGFuZGxlYmFycy5Db21waWxlciA9IGZ1bmN0aW9uKCkge307CkhhbmRsZWJhcnMuSmF2YVNjcmlwdENvbXBpbGVyID0gZnVuY3Rpb24oKSB7fTsKCihmdW5jdGlvbihDb21waWxlciwgSmF2YVNjcmlwdENvbXBpbGVyKSB7CiAgLy8gdGhlIGZvdW5kSGVscGVyIHJlZ2lzdGVyIHdpbGwgZGlzYW1iaWd1YXRlIGhlbHBlciBsb29rdXAgZnJvbSBmaW5kaW5nIGEKICAvLyBmdW5jdGlvbiBpbiBhIGNvbnRleHQuIFRoaXMgaXMgbmVjZXNzYXJ5IGZvciBtdXN0YWNoZSBjb21wYXRpYmlsaXR5LCB3aGljaAogIC8vIHJlcXVpcmVzIHRoYXQgY29udGV4dCBmdW5jdGlvbnMgaW4gYmxvY2tzIGFyZSBldmFsdWF0ZWQgYnkgYmxvY2tIZWxwZXJNaXNzaW5nLAogIC8vIGFuZCB0aGVuIHByb2NlZWQgYXMgaWYgdGhlIHJlc3VsdGluZyB2YWx1ZSB3YXMgcHJvdmlkZWQgdG8gYmxvY2tIZWxwZXJNaXNzaW5nLgoKICBDb21waWxlci5wcm90b3R5cGUgPSB7CiAgICBjb21waWxlcjogQ29tcGlsZXIsCgogICAgZGlzYXNzZW1ibGU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb3Bjb2RlcyA9IHRoaXMub3Bjb2Rlcywgb3Bjb2RlLCBvdXQgPSBbXSwgcGFyYW1zLCBwYXJhbTsKCiAgICAgIGZvciAodmFyIGk9MCwgbD1vcGNvZGVzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICBvcGNvZGUgPSBvcGNvZGVzW2ldOwoKICAgICAgICBpZiAob3Bjb2RlLm9wY29kZSA9PT0gJ0RFQ0xBUkUnKSB7CiAgICAgICAgICBvdXQucHVzaCgiREVDTEFSRSAiICsgb3Bjb2RlLm5hbWUgKyAiPSIgKyBvcGNvZGUudmFsdWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBwYXJhbXMgPSBbXTsKICAgICAgICAgIGZvciAodmFyIGo9MDsgajxvcGNvZGUuYXJncy5sZW5ndGg7IGorKykgewogICAgICAgICAgICBwYXJhbSA9IG9wY29kZS5hcmdzW2pdOwogICAgICAgICAgICBpZiAodHlwZW9mIHBhcmFtID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHBhcmFtID0gIlwiIiArIHBhcmFtLnJlcGxhY2UoIlxuIiwgIlxcbiIpICsgIlwiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJhbXMucHVzaChwYXJhbSk7CiAgICAgICAgICB9CiAgICAgICAgICBvdXQucHVzaChvcGNvZGUub3Bjb2RlICsgIiAiICsgcGFyYW1zLmpvaW4oIiAiKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gb3V0LmpvaW4oIlxuIik7CiAgICB9LAoKICAgIGd1aWQ6IDAsCgogICAgY29tcGlsZTogZnVuY3Rpb24ocHJvZ3JhbSwgb3B0aW9ucykgewogICAgICB0aGlzLmNoaWxkcmVuID0gW107CiAgICAgIHRoaXMuZGVwdGhzID0ge2xpc3Q6IFtdfTsKICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKCiAgICAgIC8vIFRoZXNlIGNoYW5nZXMgd2lsbCBwcm9wYWdhdGUgdG8gdGhlIG90aGVyIGNvbXBpbGVyIGNvbXBvbmVudHMKICAgICAgdmFyIGtub3duSGVscGVycyA9IHRoaXMub3B0aW9ucy5rbm93bkhlbHBlcnM7CiAgICAgIHRoaXMub3B0aW9ucy5rbm93bkhlbHBlcnMgPSB7CiAgICAgICAgJ2hlbHBlck1pc3NpbmcnOiB0cnVlLAogICAgICAgICdibG9ja0hlbHBlck1pc3NpbmcnOiB0cnVlLAogICAgICAgICdlYWNoJzogdHJ1ZSwKICAgICAgICAnaWYnOiB0cnVlLAogICAgICAgICd1bmxlc3MnOiB0cnVlLAogICAgICAgICd3aXRoJzogdHJ1ZSwKICAgICAgICAnbG9nJzogdHJ1ZQogICAgICB9OwogICAgICBpZiAoa25vd25IZWxwZXJzKSB7CiAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBrbm93bkhlbHBlcnMpIHsKICAgICAgICAgIHRoaXMub3B0aW9ucy5rbm93bkhlbHBlcnNbbmFtZV0gPSBrbm93bkhlbHBlcnNbbmFtZV07CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5wcm9ncmFtKHByb2dyYW0pOwogICAgfSwKCiAgICBhY2NlcHQ6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgcmV0dXJuIHRoaXNbbm9kZS50eXBlXShub2RlKTsKICAgIH0sCgogICAgcHJvZ3JhbTogZnVuY3Rpb24ocHJvZ3JhbSkgewogICAgICB2YXIgc3RhdGVtZW50cyA9IHByb2dyYW0uc3RhdGVtZW50cywgc3RhdGVtZW50OwogICAgICB0aGlzLm9wY29kZXMgPSBbXTsKCiAgICAgIGZvcih2YXIgaT0wLCBsPXN0YXRlbWVudHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIHN0YXRlbWVudCA9IHN0YXRlbWVudHNbaV07CiAgICAgICAgdGhpc1tzdGF0ZW1lbnQudHlwZV0oc3RhdGVtZW50KTsKICAgICAgfQogICAgICB0aGlzLmlzU2ltcGxlID0gbCA9PT0gMTsKCiAgICAgIHRoaXMuZGVwdGhzLmxpc3QgPSB0aGlzLmRlcHRocy5saXN0LnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgICAgIHJldHVybiBhIC0gYjsKICAgICAgfSk7CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgY29tcGlsZVByb2dyYW06IGZ1bmN0aW9uKHByb2dyYW0pIHsKICAgICAgdmFyIHJlc3VsdCA9IG5ldyB0aGlzLmNvbXBpbGVyKCkuY29tcGlsZShwcm9ncmFtLCB0aGlzLm9wdGlvbnMpOwogICAgICB2YXIgZ3VpZCA9IHRoaXMuZ3VpZCsrLCBkZXB0aDsKCiAgICAgIHRoaXMudXNlUGFydGlhbCA9IHRoaXMudXNlUGFydGlhbCB8fCByZXN1bHQudXNlUGFydGlhbDsKCiAgICAgIHRoaXMuY2hpbGRyZW5bZ3VpZF0gPSByZXN1bHQ7CgogICAgICBmb3IodmFyIGk9MCwgbD1yZXN1bHQuZGVwdGhzLmxpc3QubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIGRlcHRoID0gcmVzdWx0LmRlcHRocy5saXN0W2ldOwoKICAgICAgICBpZihkZXB0aCA8IDIpIHsgY29udGludWU7IH0KICAgICAgICBlbHNlIHsgdGhpcy5hZGREZXB0aChkZXB0aCAtIDEpOyB9CiAgICAgIH0KCiAgICAgIHJldHVybiBndWlkOwogICAgfSwKCiAgICBibG9jazogZnVuY3Rpb24oYmxvY2spIHsKICAgICAgdmFyIG11c3RhY2hlID0gYmxvY2subXVzdGFjaGUsCiAgICAgICAgICBwcm9ncmFtID0gYmxvY2sucHJvZ3JhbSwKICAgICAgICAgIGludmVyc2UgPSBibG9jay5pbnZlcnNlOwoKICAgICAgaWYgKHByb2dyYW0pIHsKICAgICAgICBwcm9ncmFtID0gdGhpcy5jb21waWxlUHJvZ3JhbShwcm9ncmFtKTsKICAgICAgfQoKICAgICAgaWYgKGludmVyc2UpIHsKICAgICAgICBpbnZlcnNlID0gdGhpcy5jb21waWxlUHJvZ3JhbShpbnZlcnNlKTsKICAgICAgfQoKICAgICAgdmFyIHR5cGUgPSB0aGlzLmNsYXNzaWZ5TXVzdGFjaGUobXVzdGFjaGUpOwoKICAgICAgaWYgKHR5cGUgPT09ICJoZWxwZXIiKSB7CiAgICAgICAgdGhpcy5oZWxwZXJNdXN0YWNoZShtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gInNpbXBsZSIpIHsKICAgICAgICB0aGlzLnNpbXBsZU11c3RhY2hlKG11c3RhY2hlKTsKCiAgICAgICAgLy8gbm93IHRoYXQgdGhlIHNpbXBsZSBtdXN0YWNoZSBpcyByZXNvbHZlZCwgd2UgbmVlZCB0bwogICAgICAgIC8vIGV2YWx1YXRlIGl0IGJ5IGV4ZWN1dGluZyBgYmxvY2tIZWxwZXJNaXNzaW5nYAogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIHByb2dyYW0pOwogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIGludmVyc2UpOwogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoTGl0ZXJhbCcsICd7fScpOwogICAgICAgIHRoaXMub3Bjb2RlKCdibG9ja1ZhbHVlJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5hbWJpZ3VvdXNNdXN0YWNoZShtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSk7CgogICAgICAgIC8vIG5vdyB0aGF0IHRoZSBzaW1wbGUgbXVzdGFjaGUgaXMgcmVzb2x2ZWQsIHdlIG5lZWQgdG8KICAgICAgICAvLyBldmFsdWF0ZSBpdCBieSBleGVjdXRpbmcgYGJsb2NrSGVscGVyTWlzc2luZ2AKICAgICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBwcm9ncmFtKTsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBpbnZlcnNlKTsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCAne30nKTsKICAgICAgICB0aGlzLm9wY29kZSgnYW1iaWd1b3VzQmxvY2tWYWx1ZScpOwogICAgICB9CgogICAgICB0aGlzLm9wY29kZSgnYXBwZW5kJyk7CiAgICB9LAoKICAgIGhhc2g6IGZ1bmN0aW9uKGhhc2gpIHsKICAgICAgdmFyIHBhaXJzID0gaGFzaC5wYWlycywgcGFpciwgdmFsOwoKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2gnLCAne30nKTsKCiAgICAgIGZvcih2YXIgaT0wLCBsPXBhaXJzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICBwYWlyID0gcGFpcnNbaV07CiAgICAgICAgdmFsICA9IHBhaXJbMV07CgogICAgICAgIHRoaXMuYWNjZXB0KHZhbCk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2Fzc2lnblRvSGFzaCcsIHBhaXJbMF0pOwogICAgICB9CiAgICB9LAoKICAgIHBhcnRpYWw6IGZ1bmN0aW9uKHBhcnRpYWwpIHsKICAgICAgdmFyIGlkID0gcGFydGlhbC5pZDsKICAgICAgdGhpcy51c2VQYXJ0aWFsID0gdHJ1ZTsKCiAgICAgIGlmKHBhcnRpYWwuY29udGV4dCkgewogICAgICAgIHRoaXMuSUQocGFydGlhbC5jb250ZXh0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaCcsICdkZXB0aDAnKTsKICAgICAgfQoKICAgICAgdGhpcy5vcGNvZGUoJ2ludm9rZVBhcnRpYWwnLCBpZC5vcmlnaW5hbCk7CiAgICAgIHRoaXMub3Bjb2RlKCdhcHBlbmQnKTsKICAgIH0sCgogICAgY29udGVudDogZnVuY3Rpb24oY29udGVudCkgewogICAgICB0aGlzLm9wY29kZSgnYXBwZW5kQ29udGVudCcsIGNvbnRlbnQuc3RyaW5nKTsKICAgIH0sCgogICAgbXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlKSB7CiAgICAgIHZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwogICAgICB2YXIgdHlwZSA9IHRoaXMuY2xhc3NpZnlNdXN0YWNoZShtdXN0YWNoZSk7CgogICAgICBpZiAodHlwZSA9PT0gInNpbXBsZSIpIHsKICAgICAgICB0aGlzLnNpbXBsZU11c3RhY2hlKG11c3RhY2hlKTsKICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAiaGVscGVyIikgewogICAgICAgIHRoaXMuaGVscGVyTXVzdGFjaGUobXVzdGFjaGUpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYW1iaWd1b3VzTXVzdGFjaGUobXVzdGFjaGUpOwogICAgICB9CgogICAgICBpZihtdXN0YWNoZS5lc2NhcGVkICYmICFvcHRpb25zLm5vRXNjYXBlKSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2FwcGVuZEVzY2FwZWQnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgnYXBwZW5kJyk7CiAgICAgIH0KICAgIH0sCgogICAgYW1iaWd1b3VzTXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBpZCA9IG11c3RhY2hlLmlkLCBuYW1lID0gaWQucGFydHNbMF07CgogICAgICB0aGlzLm9wY29kZSgnZ2V0Q29udGV4dCcsIGlkLmRlcHRoKTsKCiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIHByb2dyYW0pOwogICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBpbnZlcnNlKTsKCiAgICAgIHRoaXMub3Bjb2RlKCdpbnZva2VBbWJpZ3VvdXMnLCBuYW1lKTsKICAgIH0sCgogICAgc2ltcGxlTXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBpZCA9IG11c3RhY2hlLmlkOwoKICAgICAgaWYgKGlkLnR5cGUgPT09ICdEQVRBJykgewogICAgICAgIHRoaXMuREFUQShpZCk7CiAgICAgIH0gZWxzZSBpZiAoaWQucGFydHMubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5JRChpZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU2ltcGxpZmllZCBJRCBmb3IgYHRoaXNgCiAgICAgICAgdGhpcy5hZGREZXB0aChpZC5kZXB0aCk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBpZC5kZXB0aCk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hDb250ZXh0Jyk7CiAgICAgIH0KCiAgICAgIHRoaXMub3Bjb2RlKCdyZXNvbHZlUG9zc2libGVMYW1iZGEnKTsKICAgIH0sCgogICAgaGVscGVyTXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBwYXJhbXMgPSB0aGlzLnNldHVwRnVsbE11c3RhY2hlUGFyYW1zKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSwKICAgICAgICAgIG5hbWUgPSBtdXN0YWNoZS5pZC5wYXJ0c1swXTsKCiAgICAgIGlmICh0aGlzLm9wdGlvbnMua25vd25IZWxwZXJzW25hbWVdKSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2ludm9rZUtub3duSGVscGVyJywgcGFyYW1zLmxlbmd0aCwgbmFtZSk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5rbm93bkhlbHBlcnNPbmx5KSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3Ugc3BlY2lmaWVkIGtub3duSGVscGVyc09ubHksIGJ1dCB1c2VkIHRoZSB1bmtub3duIGhlbHBlciAiICsgbmFtZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2ludm9rZUhlbHBlcicsIHBhcmFtcy5sZW5ndGgsIG5hbWUpOwogICAgICB9CiAgICB9LAoKICAgIElEOiBmdW5jdGlvbihpZCkgewogICAgICB0aGlzLmFkZERlcHRoKGlkLmRlcHRoKTsKICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBpZC5kZXB0aCk7CgogICAgICB2YXIgbmFtZSA9IGlkLnBhcnRzWzBdOwogICAgICBpZiAoIW5hbWUpIHsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaENvbnRleHQnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgnbG9va3VwT25Db250ZXh0JywgaWQucGFydHNbMF0pOwogICAgICB9CgogICAgICBmb3IodmFyIGk9MSwgbD1pZC5wYXJ0cy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2xvb2t1cCcsIGlkLnBhcnRzW2ldKTsKICAgICAgfQogICAgfSwKCiAgICBEQVRBOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHRoaXMub3B0aW9ucy5kYXRhID0gdHJ1ZTsKICAgICAgdGhpcy5vcGNvZGUoJ2xvb2t1cERhdGEnLCBkYXRhLmlkKTsKICAgIH0sCgogICAgU1RSSU5HOiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hTdHJpbmcnLCBzdHJpbmcuc3RyaW5nKTsKICAgIH0sCgogICAgSU5URUdFUjogZnVuY3Rpb24oaW50ZWdlcikgewogICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCBpbnRlZ2VyLmludGVnZXIpOwogICAgfSwKCiAgICBCT09MRUFOOiBmdW5jdGlvbihib29sKSB7CiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoTGl0ZXJhbCcsIGJvb2wuYm9vbCk7CiAgICB9LAoKICAgIGNvbW1lbnQ6IGZ1bmN0aW9uKCkge30sCgogICAgLy8gSEVMUEVSUwogICAgb3Bjb2RlOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHRoaXMub3Bjb2Rlcy5wdXNoKHsgb3Bjb2RlOiBuYW1lLCBhcmdzOiBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSkgfSk7CiAgICB9LAoKICAgIGRlY2xhcmU6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgIHRoaXMub3Bjb2Rlcy5wdXNoKHsgb3Bjb2RlOiAnREVDTEFSRScsIG5hbWU6IG5hbWUsIHZhbHVlOiB2YWx1ZSB9KTsKICAgIH0sCgogICAgYWRkRGVwdGg6IGZ1bmN0aW9uKGRlcHRoKSB7CiAgICAgIGlmKGlzTmFOKGRlcHRoKSkgeyB0aHJvdyBuZXcgRXJyb3IoIkVXT1QiKTsgfQogICAgICBpZihkZXB0aCA9PT0gMCkgeyByZXR1cm47IH0KCiAgICAgIGlmKCF0aGlzLmRlcHRoc1tkZXB0aF0pIHsKICAgICAgICB0aGlzLmRlcHRoc1tkZXB0aF0gPSB0cnVlOwogICAgICAgIHRoaXMuZGVwdGhzLmxpc3QucHVzaChkZXB0aCk7CiAgICAgIH0KICAgIH0sCgogICAgY2xhc3NpZnlNdXN0YWNoZTogZnVuY3Rpb24obXVzdGFjaGUpIHsKICAgICAgdmFyIGlzSGVscGVyICAgPSBtdXN0YWNoZS5pc0hlbHBlcjsKICAgICAgdmFyIGlzRWxpZ2libGUgPSBtdXN0YWNoZS5lbGlnaWJsZUhlbHBlcjsKICAgICAgdmFyIG9wdGlvbnMgICAgPSB0aGlzLm9wdGlvbnM7CgogICAgICAvLyBpZiBhbWJpZ3VvdXMsIHdlIGNhbiBwb3NzaWJseSByZXNvbHZlIHRoZSBhbWJpZ3VpdHkgbm93CiAgICAgIGlmIChpc0VsaWdpYmxlICYmICFpc0hlbHBlcikgewogICAgICAgIHZhciBuYW1lID0gbXVzdGFjaGUuaWQucGFydHNbMF07CgogICAgICAgIGlmIChvcHRpb25zLmtub3duSGVscGVyc1tuYW1lXSkgewogICAgICAgICAgaXNIZWxwZXIgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5rbm93bkhlbHBlcnNPbmx5KSB7CiAgICAgICAgICBpc0VsaWdpYmxlID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoaXNIZWxwZXIpIHsgcmV0dXJuICJoZWxwZXIiOyB9CiAgICAgIGVsc2UgaWYgKGlzRWxpZ2libGUpIHsgcmV0dXJuICJhbWJpZ3VvdXMiOyB9CiAgICAgIGVsc2UgeyByZXR1cm4gInNpbXBsZSI7IH0KICAgIH0sCgogICAgcHVzaFBhcmFtczogZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgIHZhciBpID0gcGFyYW1zLmxlbmd0aCwgcGFyYW07CgogICAgICB3aGlsZShpLS0pIHsKICAgICAgICBwYXJhbSA9IHBhcmFtc1tpXTsKCiAgICAgICAgaWYodGhpcy5vcHRpb25zLnN0cmluZ1BhcmFtcykgewogICAgICAgICAgaWYocGFyYW0uZGVwdGgpIHsKICAgICAgICAgICAgdGhpcy5hZGREZXB0aChwYXJhbS5kZXB0aCk7CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBwYXJhbS5kZXB0aCB8fCAwKTsKICAgICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoU3RyaW5nUGFyYW0nLCBwYXJhbS5zdHJpbmcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzW3BhcmFtLnR5cGVdKHBhcmFtKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgc2V0dXBNdXN0YWNoZVBhcmFtczogZnVuY3Rpb24obXVzdGFjaGUpIHsKICAgICAgdmFyIHBhcmFtcyA9IG11c3RhY2hlLnBhcmFtczsKICAgICAgdGhpcy5wdXNoUGFyYW1zKHBhcmFtcyk7CgogICAgICBpZihtdXN0YWNoZS5oYXNoKSB7CiAgICAgICAgdGhpcy5oYXNoKG11c3RhY2hlLmhhc2gpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoTGl0ZXJhbCcsICd7fScpOwogICAgICB9CgogICAgICByZXR1cm4gcGFyYW1zOwogICAgfSwKCiAgICAvLyB0aGlzIHdpbGwgcmVwbGFjZSBzZXR1cE11c3RhY2hlUGFyYW1zIHdoZW4gd2UncmUgZG9uZQogICAgc2V0dXBGdWxsTXVzdGFjaGVQYXJhbXM6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBwYXJhbXMgPSBtdXN0YWNoZS5wYXJhbXM7CiAgICAgIHRoaXMucHVzaFBhcmFtcyhwYXJhbXMpOwoKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hQcm9ncmFtJywgcHJvZ3JhbSk7CiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIGludmVyc2UpOwoKICAgICAgaWYobXVzdGFjaGUuaGFzaCkgewogICAgICAgIHRoaXMuaGFzaChtdXN0YWNoZS5oYXNoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCAne30nKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHBhcmFtczsKICAgIH0KICB9OwoKICB2YXIgTGl0ZXJhbCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgfTsKCiAgSmF2YVNjcmlwdENvbXBpbGVyLnByb3RvdHlwZSA9IHsKICAgIC8vIFBVQkxJQyBBUEk6IFlvdSBjYW4gb3ZlcnJpZGUgdGhlc2UgbWV0aG9kcyBpbiBhIHN1YmNsYXNzIHRvIHByb3ZpZGUKICAgIC8vIGFsdGVybmF0aXZlIGNvbXBpbGVkIGZvcm1zIGZvciBuYW1lIGxvb2t1cCBhbmQgYnVmZmVyaW5nIHNlbWFudGljcwogICAgbmFtZUxvb2t1cDogZnVuY3Rpb24ocGFyZW50LCBuYW1lLCB0eXBlKSB7CiAgICAgIGlmICgvXlswLTldKyQvLnRlc3QobmFtZSkpIHsKICAgICAgICByZXR1cm4gcGFyZW50ICsgIlsiICsgbmFtZSArICJdIjsKICAgICAgfSBlbHNlIGlmIChKYXZhU2NyaXB0Q29tcGlsZXIuaXNWYWxpZEphdmFTY3JpcHRWYXJpYWJsZU5hbWUobmFtZSkpIHsKICAgICAgICByZXR1cm4gcGFyZW50ICsgIi4iICsgbmFtZTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICByZXR1cm4gcGFyZW50ICsgIlsnIiArIG5hbWUgKyAiJ10iOwogICAgICB9CiAgICB9LAoKICAgIGFwcGVuZFRvQnVmZmVyOiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgaWYgKHRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICByZXR1cm4gInJldHVybiAiICsgc3RyaW5nICsgIjsiOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiAiYnVmZmVyICs9ICIgKyBzdHJpbmcgKyAiOyI7CiAgICAgIH0KICAgIH0sCgogICAgaW5pdGlhbGl6ZUJ1ZmZlcjogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnF1b3RlZFN0cmluZygiIik7CiAgICB9LAoKICAgIG5hbWVzcGFjZTogIkhhbmRsZWJhcnMiLAogICAgLy8gRU5EIFBVQkxJQyBBUEkKCiAgICBjb21waWxlOiBmdW5jdGlvbihlbnZpcm9ubWVudCwgb3B0aW9ucywgY29udGV4dCwgYXNPYmplY3QpIHsKICAgICAgdGhpcy5lbnZpcm9ubWVudCA9IGVudmlyb25tZW50OwogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgICAgSGFuZGxlYmFycy5sb2coSGFuZGxlYmFycy5sb2dnZXIuREVCVUcsIHRoaXMuZW52aXJvbm1lbnQuZGlzYXNzZW1ibGUoKSArICJcblxuIik7CgogICAgICB0aGlzLm5hbWUgPSB0aGlzLmVudmlyb25tZW50Lm5hbWU7CiAgICAgIHRoaXMuaXNDaGlsZCA9ICEhY29udGV4dDsKICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dCB8fCB7CiAgICAgICAgcHJvZ3JhbXM6IFtdLAogICAgICAgIGFsaWFzZXM6IHsgfQogICAgICB9OwoKICAgICAgdGhpcy5wcmVhbWJsZSgpOwoKICAgICAgdGhpcy5zdGFja1Nsb3QgPSAwOwogICAgICB0aGlzLnN0YWNrVmFycyA9IFtdOwogICAgICB0aGlzLnJlZ2lzdGVycyA9IHsgbGlzdDogW10gfTsKICAgICAgdGhpcy5jb21waWxlU3RhY2sgPSBbXTsKCiAgICAgIHRoaXMuY29tcGlsZUNoaWxkcmVuKGVudmlyb25tZW50LCBvcHRpb25zKTsKCiAgICAgIHZhciBvcGNvZGVzID0gZW52aXJvbm1lbnQub3Bjb2Rlcywgb3Bjb2RlOwoKICAgICAgdGhpcy5pID0gMDsKCiAgICAgIGZvcihsPW9wY29kZXMubGVuZ3RoOyB0aGlzLmk8bDsgdGhpcy5pKyspIHsKICAgICAgICBvcGNvZGUgPSBvcGNvZGVzW3RoaXMuaV07CgogICAgICAgIGlmKG9wY29kZS5vcGNvZGUgPT09ICdERUNMQVJFJykgewogICAgICAgICAgdGhpc1tvcGNvZGUubmFtZV0gPSBvcGNvZGUudmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXNbb3Bjb2RlLm9wY29kZV0uYXBwbHkodGhpcywgb3Bjb2RlLmFyZ3MpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlRnVuY3Rpb25Db250ZXh0KGFzT2JqZWN0KTsKICAgIH0sCgogICAgbmV4dE9wY29kZTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBvcGNvZGVzID0gdGhpcy5lbnZpcm9ubWVudC5vcGNvZGVzLCBvcGNvZGUgPSBvcGNvZGVzW3RoaXMuaSArIDFdOwogICAgICByZXR1cm4gb3Bjb2Rlc1t0aGlzLmkgKyAxXTsKICAgIH0sCgogICAgZWF0OiBmdW5jdGlvbihvcGNvZGUpIHsKICAgICAgdGhpcy5pID0gdGhpcy5pICsgMTsKICAgIH0sCgogICAgcHJlYW1ibGU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb3V0ID0gW107CgogICAgICBpZiAoIXRoaXMuaXNDaGlsZCkgewogICAgICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLm5hbWVzcGFjZTsKICAgICAgICB2YXIgY29waWVzID0gImhlbHBlcnMgPSBoZWxwZXJzIHx8ICIgKyBuYW1lc3BhY2UgKyAiLmhlbHBlcnM7IjsKICAgICAgICBpZiAodGhpcy5lbnZpcm9ubWVudC51c2VQYXJ0aWFsKSB7IGNvcGllcyA9IGNvcGllcyArICIgcGFydGlhbHMgPSBwYXJ0aWFscyB8fCAiICsgbmFtZXNwYWNlICsgIi5wYXJ0aWFsczsiOyB9CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5kYXRhKSB7IGNvcGllcyA9IGNvcGllcyArICIgZGF0YSA9IGRhdGEgfHwge307IjsgfQogICAgICAgIG91dC5wdXNoKGNvcGllcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3V0LnB1c2goJycpOwogICAgICB9CgogICAgICBpZiAoIXRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICBvdXQucHVzaCgiLCBidWZmZXIgPSAiICsgdGhpcy5pbml0aWFsaXplQnVmZmVyKCkpOwogICAgICB9IGVsc2UgewogICAgICAgIG91dC5wdXNoKCIiKTsKICAgICAgfQoKICAgICAgLy8gdHJhY2sgdGhlIGxhc3QgY29udGV4dCBwdXNoZWQgaW50byBwbGFjZSB0byBhbGxvdyBza2lwcGluZyB0aGUKICAgICAgLy8gZ2V0Q29udGV4dCBvcGNvZGUgd2hlbiBpdCB3b3VsZCBiZSBhIG5vb3AKICAgICAgdGhpcy5sYXN0Q29udGV4dCA9IDA7CiAgICAgIHRoaXMuc291cmNlID0gb3V0OwogICAgfSwKCiAgICBjcmVhdGVGdW5jdGlvbkNvbnRleHQ6IGZ1bmN0aW9uKGFzT2JqZWN0KSB7CiAgICAgIHZhciBsb2NhbHMgPSB0aGlzLnN0YWNrVmFycy5jb25jYXQodGhpcy5yZWdpc3RlcnMubGlzdCk7CgogICAgICBpZihsb2NhbHMubGVuZ3RoID4gMCkgewogICAgICAgIHRoaXMuc291cmNlWzFdID0gdGhpcy5zb3VyY2VbMV0gKyAiLCAiICsgbG9jYWxzLmpvaW4oIiwgIik7CiAgICAgIH0KCiAgICAgIC8vIEdlbmVyYXRlIG1pbmltaXplciBhbGlhcyBtYXBwaW5ncwogICAgICBpZiAoIXRoaXMuaXNDaGlsZCkgewogICAgICAgIHZhciBhbGlhc2VzID0gW107CiAgICAgICAgZm9yICh2YXIgYWxpYXMgaW4gdGhpcy5jb250ZXh0LmFsaWFzZXMpIHsKICAgICAgICAgIHRoaXMuc291cmNlWzFdID0gdGhpcy5zb3VyY2VbMV0gKyAnLCAnICsgYWxpYXMgKyAnPScgKyB0aGlzLmNvbnRleHQuYWxpYXNlc1thbGlhc107CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5zb3VyY2VbMV0pIHsKICAgICAgICB0aGlzLnNvdXJjZVsxXSA9ICJ2YXIgIiArIHRoaXMuc291cmNlWzFdLnN1YnN0cmluZygyKSArICI7IjsKICAgICAgfQoKICAgICAgLy8gTWVyZ2UgY2hpbGRyZW4KICAgICAgaWYgKCF0aGlzLmlzQ2hpbGQpIHsKICAgICAgICB0aGlzLnNvdXJjZVsxXSArPSAnXG4nICsgdGhpcy5jb250ZXh0LnByb2dyYW1zLmpvaW4oJ1xuJykgKyAnXG4nOwogICAgICB9CgogICAgICBpZiAoIXRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICB0aGlzLnNvdXJjZS5wdXNoKCJyZXR1cm4gYnVmZmVyOyIpOwogICAgICB9CgogICAgICB2YXIgcGFyYW1zID0gdGhpcy5pc0NoaWxkID8gWyJkZXB0aDAiLCAiZGF0YSJdIDogWyJIYW5kbGViYXJzIiwgImRlcHRoMCIsICJoZWxwZXJzIiwgInBhcnRpYWxzIiwgImRhdGEiXTsKCiAgICAgIGZvcih2YXIgaT0wLCBsPXRoaXMuZW52aXJvbm1lbnQuZGVwdGhzLmxpc3QubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIHBhcmFtcy5wdXNoKCJkZXB0aCIgKyB0aGlzLmVudmlyb25tZW50LmRlcHRocy5saXN0W2ldKTsKICAgICAgfQoKICAgICAgaWYgKGFzT2JqZWN0KSB7CiAgICAgICAgcGFyYW1zLnB1c2godGhpcy5zb3VyY2Uuam9pbigiXG4gICIpKTsKCiAgICAgICAgcmV0dXJuIEZ1bmN0aW9uLmFwcGx5KHRoaXMsIHBhcmFtcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGZ1bmN0aW9uU291cmNlID0gJ2Z1bmN0aW9uICcgKyAodGhpcy5uYW1lIHx8ICcnKSArICcoJyArIHBhcmFtcy5qb2luKCcsJykgKyAnKSB7XG4gICcgKyB0aGlzLnNvdXJjZS5qb2luKCJcbiAgIikgKyAnfSc7CiAgICAgICAgSGFuZGxlYmFycy5sb2coSGFuZGxlYmFycy5sb2dnZXIuREVCVUcsIGZ1bmN0aW9uU291cmNlICsgIlxuXG4iKTsKICAgICAgICByZXR1cm4gZnVuY3Rpb25Tb3VyY2U7CiAgICAgIH0KICAgIH0sCgogICAgLy8gW2Jsb2NrVmFsdWVdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogaGFzaCwgaW52ZXJzZSwgcHJvZ3JhbSwgdmFsdWUKICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogcmV0dXJuIHZhbHVlIG9mIGJsb2NrSGVscGVyTWlzc2luZwogICAgLy8KICAgIC8vIFRoZSBwdXJwb3NlIG9mIHRoaXMgb3Bjb2RlIGlzIHRvIHRha2UgYSBibG9jayBvZiB0aGUgZm9ybQogICAgLy8gYHt7I2Zvb319Li4ue3svZm9vfX1gLCByZXNvbHZlIHRoZSB2YWx1ZSBvZiBgZm9vYCwgYW5kCiAgICAvLyByZXBsYWNlIGl0IG9uIHRoZSBzdGFjayB3aXRoIHRoZSByZXN1bHQgb2YgcHJvcGVybHkKICAgIC8vIGludm9raW5nIGJsb2NrSGVscGVyTWlzc2luZy4KICAgIGJsb2NrVmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5ibG9ja0hlbHBlck1pc3NpbmcgPSAnaGVscGVycy5ibG9ja0hlbHBlck1pc3NpbmcnOwoKICAgICAgdmFyIHBhcmFtcyA9IFsiZGVwdGgwIl07CiAgICAgIHRoaXMuc2V0dXBQYXJhbXMoMCwgcGFyYW1zKTsKCiAgICAgIHRoaXMucmVwbGFjZVN0YWNrKGZ1bmN0aW9uKGN1cnJlbnQpIHsKICAgICAgICBwYXJhbXMuc3BsaWNlKDEsIDAsIGN1cnJlbnQpOwogICAgICAgIHJldHVybiBjdXJyZW50ICsgIiA9IGJsb2NrSGVscGVyTWlzc2luZy5jYWxsKCIgKyBwYXJhbXMuam9pbigiLCAiKSArICIpIjsKICAgICAgfSk7CiAgICB9LAoKICAgIC8vIFthbWJpZ3VvdXNCbG9ja1ZhbHVlXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IGhhc2gsIGludmVyc2UsIHByb2dyYW0sIHZhbHVlCiAgICAvLyBDb21waWxlciB2YWx1ZSwgYmVmb3JlOiBsYXN0SGVscGVyPXZhbHVlIG9mIGxhc3QgZm91bmQgaGVscGVyLCBpZiBhbnkKICAgIC8vIE9uIHN0YWNrLCBhZnRlciwgaWYgbm8gbGFzdEhlbHBlcjogc2FtZSBhcyBbYmxvY2tWYWx1ZV0KICAgIC8vIE9uIHN0YWNrLCBhZnRlciwgaWYgbGFzdEhlbHBlcjogdmFsdWUKICAgIGFtYmlndW91c0Jsb2NrVmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5ibG9ja0hlbHBlck1pc3NpbmcgPSAnaGVscGVycy5ibG9ja0hlbHBlck1pc3NpbmcnOwoKICAgICAgdmFyIHBhcmFtcyA9IFsiZGVwdGgwIl07CiAgICAgIHRoaXMuc2V0dXBQYXJhbXMoMCwgcGFyYW1zKTsKCiAgICAgIHZhciBjdXJyZW50ID0gdGhpcy50b3BTdGFjaygpOwogICAgICBwYXJhbXMuc3BsaWNlKDEsIDAsIGN1cnJlbnQpOwoKICAgICAgdGhpcy5zb3VyY2UucHVzaCgiaWYgKCEiICsgdGhpcy5sYXN0SGVscGVyICsgIikgeyAiICsgY3VycmVudCArICIgPSBibG9ja0hlbHBlck1pc3NpbmcuY2FsbCgiICsgcGFyYW1zLmpvaW4oIiwgIikgKyAiKTsgfSIpOwogICAgfSwKCiAgICAvLyBbYXBwZW5kQ29udGVudF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogLi4uCiAgICAvLwogICAgLy8gQXBwZW5kcyB0aGUgc3RyaW5nIHZhbHVlIG9mIGBjb250ZW50YCB0byB0aGUgY3VycmVudCBidWZmZXIKICAgIGFwcGVuZENvbnRlbnQ6IGZ1bmN0aW9uKGNvbnRlbnQpIHsKICAgICAgdGhpcy5zb3VyY2UucHVzaCh0aGlzLmFwcGVuZFRvQnVmZmVyKHRoaXMucXVvdGVkU3RyaW5nKGNvbnRlbnQpKSk7CiAgICB9LAoKICAgIC8vIFthcHBlbmRdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogdmFsdWUsIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiAuLi4KICAgIC8vCiAgICAvLyBDb2VyY2VzIGB2YWx1ZWAgdG8gYSBTdHJpbmcgYW5kIGFwcGVuZHMgaXQgdG8gdGhlIGN1cnJlbnQgYnVmZmVyLgogICAgLy8KICAgIC8vIElmIGB2YWx1ZWAgaXMgdHJ1dGh5LCBvciAwLCBpdCBpcyBjb2VyY2VkIGludG8gYSBzdHJpbmcgYW5kIGFwcGVuZGVkCiAgICAvLyBPdGhlcndpc2UsIHRoZSBlbXB0eSBzdHJpbmcgaXMgYXBwZW5kZWQKICAgIGFwcGVuZDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBsb2NhbCA9IHRoaXMucG9wU3RhY2soKTsKICAgICAgdGhpcy5zb3VyY2UucHVzaCgiaWYoIiArIGxvY2FsICsgIiB8fCAiICsgbG9jYWwgKyAiID09PSAwKSB7ICIgKyB0aGlzLmFwcGVuZFRvQnVmZmVyKGxvY2FsKSArICIgfSIpOwogICAgICBpZiAodGhpcy5lbnZpcm9ubWVudC5pc1NpbXBsZSkgewogICAgICAgIHRoaXMuc291cmNlLnB1c2goImVsc2UgeyAiICsgdGhpcy5hcHBlbmRUb0J1ZmZlcigiJyciKSArICIgfSIpOwogICAgICB9CiAgICB9LAoKICAgIC8vIFthcHBlbmRFc2NhcGVkXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogLi4uCiAgICAvLwogICAgLy8gRXNjYXBlIGB2YWx1ZWAgYW5kIGFwcGVuZCBpdCB0byB0aGUgYnVmZmVyCiAgICBhcHBlbmRFc2NhcGVkOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIG9wY29kZSA9IHRoaXMubmV4dE9wY29kZSgpLCBleHRyYSA9ICIiOwogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5lc2NhcGVFeHByZXNzaW9uID0gJ3RoaXMuZXNjYXBlRXhwcmVzc2lvbic7CgogICAgICBpZihvcGNvZGUgJiYgb3Bjb2RlLm9wY29kZSA9PT0gJ2FwcGVuZENvbnRlbnQnKSB7CiAgICAgICAgZXh0cmEgPSAiICsgIiArIHRoaXMucXVvdGVkU3RyaW5nKG9wY29kZS5hcmdzWzBdKTsKICAgICAgICB0aGlzLmVhdChvcGNvZGUpOwogICAgICB9CgogICAgICB0aGlzLnNvdXJjZS5wdXNoKHRoaXMuYXBwZW5kVG9CdWZmZXIoImVzY2FwZUV4cHJlc3Npb24oIiArIHRoaXMucG9wU3RhY2soKSArICIpIiArIGV4dHJhKSk7CiAgICB9LAoKICAgIC8vIFtnZXRDb250ZXh0XQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiAuLi4KICAgIC8vIENvbXBpbGVyIHZhbHVlLCBhZnRlcjogbGFzdENvbnRleHQ9ZGVwdGgKICAgIC8vCiAgICAvLyBTZXQgdGhlIHZhbHVlIG9mIHRoZSBgbGFzdENvbnRleHRgIGNvbXBpbGVyIHZhbHVlIHRvIHRoZSBkZXB0aAogICAgZ2V0Q29udGV4dDogZnVuY3Rpb24oZGVwdGgpIHsKICAgICAgaWYodGhpcy5sYXN0Q29udGV4dCAhPT0gZGVwdGgpIHsKICAgICAgICB0aGlzLmxhc3RDb250ZXh0ID0gZGVwdGg7CiAgICAgIH0KICAgIH0sCgogICAgLy8gW2xvb2t1cE9uQ29udGV4dF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogY3VycmVudENvbnRleHRbbmFtZV0sIC4uLgogICAgLy8KICAgIC8vIExvb2tzIHVwIHRoZSB2YWx1ZSBvZiBgbmFtZWAgb24gdGhlIGN1cnJlbnQgY29udGV4dCBhbmQgcHVzaGVzCiAgICAvLyBpdCBvbnRvIHRoZSBzdGFjay4KICAgIGxvb2t1cE9uQ29udGV4dDogZnVuY3Rpb24obmFtZSkgewogICAgICB0aGlzLnB1c2hTdGFjayh0aGlzLm5hbWVMb29rdXAoJ2RlcHRoJyArIHRoaXMubGFzdENvbnRleHQsIG5hbWUsICdjb250ZXh0JykpOwogICAgfSwKCiAgICAvLyBbcHVzaENvbnRleHRdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IGN1cnJlbnRDb250ZXh0LCAuLi4KICAgIC8vCiAgICAvLyBQdXNoZXMgdGhlIHZhbHVlIG9mIHRoZSBjdXJyZW50IGNvbnRleHQgb250byB0aGUgc3RhY2suCiAgICBwdXNoQ29udGV4dDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbCgnZGVwdGgnICsgdGhpcy5sYXN0Q29udGV4dCk7CiAgICB9LAoKICAgIC8vIFtyZXNvbHZlUG9zc2libGVMYW1iZGFdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogdmFsdWUsIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXNvbHZlZCB2YWx1ZSwgLi4uCiAgICAvLwogICAgLy8gSWYgdGhlIGB2YWx1ZWAgaXMgYSBsYW1iZGEsIHJlcGxhY2UgaXQgb24gdGhlIHN0YWNrIGJ5CiAgICAvLyB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBsYW1iZGEKICAgIHJlc29sdmVQb3NzaWJsZUxhbWJkYTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLmZ1bmN0aW9uVHlwZSA9ICciZnVuY3Rpb24iJzsKCiAgICAgIHRoaXMucmVwbGFjZVN0YWNrKGZ1bmN0aW9uKGN1cnJlbnQpIHsKICAgICAgICByZXR1cm4gInR5cGVvZiAiICsgY3VycmVudCArICIgPT09IGZ1bmN0aW9uVHlwZSA/ICIgKyBjdXJyZW50ICsgIigpIDogIiArIGN1cnJlbnQ7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBbbG9va3VwXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogdmFsdWVbbmFtZV0sIC4uLgogICAgLy8KICAgIC8vIFJlcGxhY2UgdGhlIHZhbHVlIG9uIHRoZSBzdGFjayB3aXRoIHRoZSByZXN1bHQgb2YgbG9va2luZwogICAgLy8gdXAgYG5hbWVgIG9uIGB2YWx1ZWAKICAgIGxvb2t1cDogZnVuY3Rpb24obmFtZSkgewogICAgICB0aGlzLnJlcGxhY2VTdGFjayhmdW5jdGlvbihjdXJyZW50KSB7CiAgICAgICAgcmV0dXJuIGN1cnJlbnQgKyAiID09IG51bGwgfHwgIiArIGN1cnJlbnQgKyAiID09PSBmYWxzZSA/ICIgKyBjdXJyZW50ICsgIiA6ICIgKyB0aGlzLm5hbWVMb29rdXAoY3VycmVudCwgbmFtZSwgJ2NvbnRleHQnKTsKICAgICAgfSk7CiAgICB9LAoKICAgIC8vIFtsb29rdXBEYXRhXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBkYXRhW2lkXSwgLi4uCiAgICAvLwogICAgLy8gUHVzaCB0aGUgcmVzdWx0IG9mIGxvb2tpbmcgdXAgYGlkYCBvbiB0aGUgY3VycmVudCBkYXRhCiAgICBsb29rdXBEYXRhOiBmdW5jdGlvbihpZCkgewogICAgICB0aGlzLnB1c2hTdGFjayh0aGlzLm5hbWVMb29rdXAoJ2RhdGEnLCBpZCwgJ2RhdGEnKSk7CiAgICB9LAoKICAgIC8vIFtwdXNoU3RyaW5nUGFyYW1dCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHN0cmluZywgY3VycmVudENvbnRleHQsIC4uLgogICAgLy8KICAgIC8vIFRoaXMgb3Bjb2RlIGlzIGRlc2lnbmVkIGZvciB1c2UgaW4gc3RyaW5nIG1vZGUsIHdoaWNoCiAgICAvLyBwcm92aWRlcyB0aGUgc3RyaW5nIHZhbHVlIG9mIGEgcGFyYW1ldGVyIGFsb25nIHdpdGggaXRzCiAgICAvLyBkZXB0aCByYXRoZXIgdGhhbiByZXNvbHZpbmcgaXQgaW1tZWRpYXRlbHkuCiAgICBwdXNoU3RyaW5nUGFyYW06IGZ1bmN0aW9uKHN0cmluZykgewogICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwoJ2RlcHRoJyArIHRoaXMubGFzdENvbnRleHQpOwogICAgICB0aGlzLnB1c2hTdHJpbmcoc3RyaW5nKTsKICAgIH0sCgogICAgLy8gW3B1c2hTdHJpbmddCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHF1b3RlZFN0cmluZyhzdHJpbmcpLCAuLi4KICAgIC8vCiAgICAvLyBQdXNoIGEgcXVvdGVkIHZlcnNpb24gb2YgYHN0cmluZ2Agb250byB0aGUgc3RhY2sKICAgIHB1c2hTdHJpbmc6IGZ1bmN0aW9uKHN0cmluZykgewogICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwodGhpcy5xdW90ZWRTdHJpbmcoc3RyaW5nKSk7CiAgICB9LAoKICAgIC8vIFtwdXNoXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBleHByLCAuLi4KICAgIC8vCiAgICAvLyBQdXNoIGFuIGV4cHJlc3Npb24gb250byB0aGUgc3RhY2sKICAgIHB1c2g6IGZ1bmN0aW9uKGV4cHIpIHsKICAgICAgdGhpcy5wdXNoU3RhY2soZXhwcik7CiAgICB9LAoKICAgIC8vIFtwdXNoTGl0ZXJhbF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogdmFsdWUsIC4uLgogICAgLy8KICAgIC8vIFB1c2hlcyBhIHZhbHVlIG9udG8gdGhlIHN0YWNrLiBUaGlzIG9wZXJhdGlvbiBwcmV2ZW50cwogICAgLy8gdGhlIGNvbXBpbGVyIGZyb20gY3JlYXRpbmcgYSB0ZW1wb3JhcnkgdmFyaWFibGUgdG8gaG9sZAogICAgLy8gaXQuCiAgICBwdXNoTGl0ZXJhbDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdGhpcy5wdXNoU3RhY2tMaXRlcmFsKHZhbHVlKTsKICAgIH0sCgogICAgLy8gW3B1c2hQcm9ncmFtXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBwcm9ncmFtKGd1aWQpLCAuLi4KICAgIC8vCiAgICAvLyBQdXNoIGEgcHJvZ3JhbSBleHByZXNzaW9uIG9udG8gdGhlIHN0YWNrLiBUaGlzIHRha2VzCiAgICAvLyBhIGNvbXBpbGUtdGltZSBndWlkIGFuZCBjb252ZXJ0cyBpdCBpbnRvIGEgcnVudGltZS1hY2Nlc3NpYmxlCiAgICAvLyBleHByZXNzaW9uLgogICAgcHVzaFByb2dyYW06IGZ1bmN0aW9uKGd1aWQpIHsKICAgICAgaWYgKGd1aWQgIT0gbnVsbCkgewogICAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbCh0aGlzLnByb2dyYW1FeHByZXNzaW9uKGd1aWQpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwobnVsbCk7CiAgICAgIH0KICAgIH0sCgogICAgLy8gW2ludm9rZUhlbHBlcl0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBoYXNoLCBpbnZlcnNlLCBwcm9ncmFtLCBwYXJhbXMuLi4sIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXN1bHQgb2YgaGVscGVyIGludm9jYXRpb24KICAgIC8vCiAgICAvLyBQb3BzIG9mZiB0aGUgaGVscGVyJ3MgcGFyYW1ldGVycywgaW52b2tlcyB0aGUgaGVscGVyLAogICAgLy8gYW5kIHB1c2hlcyB0aGUgaGVscGVyJ3MgcmV0dXJuIHZhbHVlIG9udG8gdGhlIHN0YWNrLgogICAgLy8KICAgIC8vIElmIHRoZSBoZWxwZXIgaXMgbm90IGZvdW5kLCBgaGVscGVyTWlzc2luZ2AgaXMgY2FsbGVkLgogICAgaW52b2tlSGVscGVyOiBmdW5jdGlvbihwYXJhbVNpemUsIG5hbWUpIHsKICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuaGVscGVyTWlzc2luZyA9ICdoZWxwZXJzLmhlbHBlck1pc3NpbmcnOwoKICAgICAgdmFyIGhlbHBlciA9IHRoaXMubGFzdEhlbHBlciA9IHRoaXMuc2V0dXBIZWxwZXIocGFyYW1TaXplLCBuYW1lKTsKICAgICAgdGhpcy5yZWdpc3RlcignZm91bmRIZWxwZXInLCBoZWxwZXIubmFtZSk7CgogICAgICB0aGlzLnB1c2hTdGFjaygiZm91bmRIZWxwZXIgPyBmb3VuZEhlbHBlci5jYWxsKCIgKwogICAgICAgIGhlbHBlci5jYWxsUGFyYW1zICsgIikgIiArICI6IGhlbHBlck1pc3NpbmcuY2FsbCgiICsKICAgICAgICBoZWxwZXIuaGVscGVyTWlzc2luZ1BhcmFtcyArICIpIik7CiAgICB9LAoKICAgIC8vIFtpbnZva2VLbm93bkhlbHBlcl0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBoYXNoLCBpbnZlcnNlLCBwcm9ncmFtLCBwYXJhbXMuLi4sIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXN1bHQgb2YgaGVscGVyIGludm9jYXRpb24KICAgIC8vCiAgICAvLyBUaGlzIG9wZXJhdGlvbiBpcyB1c2VkIHdoZW4gdGhlIGhlbHBlciBpcyBrbm93biB0byBleGlzdCwKICAgIC8vIHNvIGEgYGhlbHBlck1pc3NpbmdgIGZhbGxiYWNrIGlzIG5vdCByZXF1aXJlZC4KICAgIGludm9rZUtub3duSGVscGVyOiBmdW5jdGlvbihwYXJhbVNpemUsIG5hbWUpIHsKICAgICAgdmFyIGhlbHBlciA9IHRoaXMuc2V0dXBIZWxwZXIocGFyYW1TaXplLCBuYW1lKTsKICAgICAgdGhpcy5wdXNoU3RhY2soaGVscGVyLm5hbWUgKyAiLmNhbGwoIiArIGhlbHBlci5jYWxsUGFyYW1zICsgIikiKTsKICAgIH0sCgogICAgLy8gW2ludm9rZUFtYmlndW91c10KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBoYXNoLCBpbnZlcnNlLCBwcm9ncmFtLCBwYXJhbXMuLi4sIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXN1bHQgb2YgZGlzYW1iaWd1YXRpb24KICAgIC8vCiAgICAvLyBUaGlzIG9wZXJhdGlvbiBpcyB1c2VkIHdoZW4gYW4gZXhwcmVzc2lvbiBsaWtlIGB7e2Zvb319YAogICAgLy8gaXMgcHJvdmlkZWQsIGJ1dCB3ZSBkb24ndCBrbm93IGF0IGNvbXBpbGUtdGltZSB3aGV0aGVyIGl0CiAgICAvLyBpcyBhIGhlbHBlciBvciBhIHBhdGguCiAgICAvLwogICAgLy8gVGhpcyBvcGVyYXRpb24gZW1pdHMgbW9yZSBjb2RlIHRoYW4gdGhlIG90aGVyIG9wdGlvbnMsCiAgICAvLyBhbmQgY2FuIGJlIGF2b2lkZWQgYnkgcGFzc2luZyB0aGUgYGtub3duSGVscGVyc2AgYW5kCiAgICAvLyBga25vd25IZWxwZXJzT25seWAgZmxhZ3MgYXQgY29tcGlsZS10aW1lLgogICAgaW52b2tlQW1iaWd1b3VzOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLmZ1bmN0aW9uVHlwZSA9ICciZnVuY3Rpb24iJzsKCiAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbCgne30nKTsKICAgICAgdmFyIGhlbHBlciA9IHRoaXMuc2V0dXBIZWxwZXIoMCwgbmFtZSk7CgogICAgICB2YXIgaGVscGVyTmFtZSA9IHRoaXMubGFzdEhlbHBlciA9IHRoaXMubmFtZUxvb2t1cCgnaGVscGVycycsIG5hbWUsICdoZWxwZXInKTsKICAgICAgdGhpcy5yZWdpc3RlcignZm91bmRIZWxwZXInLCBoZWxwZXJOYW1lKTsKCiAgICAgIHZhciBub25IZWxwZXIgPSB0aGlzLm5hbWVMb29rdXAoJ2RlcHRoJyArIHRoaXMubGFzdENvbnRleHQsIG5hbWUsICdjb250ZXh0Jyk7CiAgICAgIHZhciBuZXh0U3RhY2sgPSB0aGlzLm5leHRTdGFjaygpOwoKICAgICAgdGhpcy5zb3VyY2UucHVzaCgnaWYgKGZvdW5kSGVscGVyKSB7ICcgKyBuZXh0U3RhY2sgKyAnID0gZm91bmRIZWxwZXIuY2FsbCgnICsgaGVscGVyLmNhbGxQYXJhbXMgKyAnKTsgfScpOwogICAgICB0aGlzLnNvdXJjZS5wdXNoKCdlbHNlIHsgJyArIG5leHRTdGFjayArICcgPSAnICsgbm9uSGVscGVyICsgJzsgJyArIG5leHRTdGFjayArICcgPSB0eXBlb2YgJyArIG5leHRTdGFjayArICcgPT09IGZ1bmN0aW9uVHlwZSA/ICcgKyBuZXh0U3RhY2sgKyAnKCkgOiAnICsgbmV4dFN0YWNrICsgJzsgfScpOwogICAgfSwKCiAgICAvLyBbaW52b2tlUGFydGlhbF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBjb250ZXh0LCAuLi4KICAgIC8vIE9uIHN0YWNrIGFmdGVyOiByZXN1bHQgb2YgcGFydGlhbCBpbnZvY2F0aW9uCiAgICAvLwogICAgLy8gVGhpcyBvcGVyYXRpb24gcG9wcyBvZmYgYSBjb250ZXh0LCBpbnZva2VzIGEgcGFydGlhbCB3aXRoIHRoYXQgY29udGV4dCwKICAgIC8vIGFuZCBwdXNoZXMgdGhlIHJlc3VsdCBvZiB0aGUgaW52b2NhdGlvbiBiYWNrLgogICAgaW52b2tlUGFydGlhbDogZnVuY3Rpb24obmFtZSkgewogICAgICB2YXIgcGFyYW1zID0gW3RoaXMubmFtZUxvb2t1cCgncGFydGlhbHMnLCBuYW1lLCAncGFydGlhbCcpLCAiJyIgKyBuYW1lICsgIiciLCB0aGlzLnBvcFN0YWNrKCksICJoZWxwZXJzIiwgInBhcnRpYWxzIl07CgogICAgICBpZiAodGhpcy5vcHRpb25zLmRhdGEpIHsKICAgICAgICBwYXJhbXMucHVzaCgiZGF0YSIpOwogICAgICB9CgogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5zZWxmID0gInRoaXMiOwogICAgICB0aGlzLnB1c2hTdGFjaygic2VsZi5pbnZva2VQYXJ0aWFsKCIgKyBwYXJhbXMuam9pbigiLCAiKSArICIpOyIpOwogICAgfSwKCiAgICAvLyBbYXNzaWduVG9IYXNoXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCBoYXNoLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogaGFzaCwgLi4uCiAgICAvLwogICAgLy8gUG9wcyBhIHZhbHVlIGFuZCBoYXNoIG9mZiB0aGUgc3RhY2ssIGFzc2lnbnMgYGhhc2hba2V5XSA9IHZhbHVlYAogICAgLy8gYW5kIHB1c2hlcyB0aGUgaGFzaCBiYWNrIG9udG8gdGhlIHN0YWNrLgogICAgYXNzaWduVG9IYXNoOiBmdW5jdGlvbihrZXkpIHsKICAgICAgdmFyIHZhbHVlID0gdGhpcy5wb3BTdGFjaygpOwogICAgICB2YXIgaGFzaCA9IHRoaXMudG9wU3RhY2soKTsKCiAgICAgIHRoaXMuc291cmNlLnB1c2goaGFzaCArICJbJyIgKyBrZXkgKyAiJ10gPSAiICsgdmFsdWUgKyAiOyIpOwogICAgfSwKCiAgICAvLyBIRUxQRVJTCgogICAgY29tcGlsZXI6IEphdmFTY3JpcHRDb21waWxlciwKCiAgICBjb21waWxlQ2hpbGRyZW46IGZ1bmN0aW9uKGVudmlyb25tZW50LCBvcHRpb25zKSB7CiAgICAgIHZhciBjaGlsZHJlbiA9IGVudmlyb25tZW50LmNoaWxkcmVuLCBjaGlsZCwgY29tcGlsZXI7CgogICAgICBmb3IodmFyIGk9MCwgbD1jaGlsZHJlbi5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgY2hpbGQgPSBjaGlsZHJlbltpXTsKICAgICAgICBjb21waWxlciA9IG5ldyB0aGlzLmNvbXBpbGVyKCk7CgogICAgICAgIHRoaXMuY29udGV4dC5wcm9ncmFtcy5wdXNoKCcnKTsgICAgIC8vIFBsYWNlaG9sZGVyIHRvIHByZXZlbnQgbmFtZSBjb25mbGljdHMgZm9yIG5lc3RlZCBjaGlsZHJlbgogICAgICAgIHZhciBpbmRleCA9IHRoaXMuY29udGV4dC5wcm9ncmFtcy5sZW5ndGg7CiAgICAgICAgY2hpbGQuaW5kZXggPSBpbmRleDsKICAgICAgICBjaGlsZC5uYW1lID0gJ3Byb2dyYW0nICsgaW5kZXg7CiAgICAgICAgdGhpcy5jb250ZXh0LnByb2dyYW1zW2luZGV4XSA9IGNvbXBpbGVyLmNvbXBpbGUoY2hpbGQsIG9wdGlvbnMsIHRoaXMuY29udGV4dCk7CiAgICAgIH0KICAgIH0sCgogICAgcHJvZ3JhbUV4cHJlc3Npb246IGZ1bmN0aW9uKGd1aWQpIHsKICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuc2VsZiA9ICJ0aGlzIjsKCiAgICAgIGlmKGd1aWQgPT0gbnVsbCkgewogICAgICAgIHJldHVybiAic2VsZi5ub29wIjsKICAgICAgfQoKICAgICAgdmFyIGNoaWxkID0gdGhpcy5lbnZpcm9ubWVudC5jaGlsZHJlbltndWlkXSwKICAgICAgICAgIGRlcHRocyA9IGNoaWxkLmRlcHRocy5saXN0LCBkZXB0aDsKCiAgICAgIHZhciBwcm9ncmFtUGFyYW1zID0gW2NoaWxkLmluZGV4LCBjaGlsZC5uYW1lLCAiZGF0YSJdOwoKICAgICAgZm9yKHZhciBpPTAsIGwgPSBkZXB0aHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIGRlcHRoID0gZGVwdGhzW2ldOwoKICAgICAgICBpZihkZXB0aCA9PT0gMSkgeyBwcm9ncmFtUGFyYW1zLnB1c2goImRlcHRoMCIpOyB9CiAgICAgICAgZWxzZSB7IHByb2dyYW1QYXJhbXMucHVzaCgiZGVwdGgiICsgKGRlcHRoIC0gMSkpOyB9CiAgICAgIH0KCiAgICAgIGlmKGRlcHRocy5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gInNlbGYucHJvZ3JhbSgiICsgcHJvZ3JhbVBhcmFtcy5qb2luKCIsICIpICsgIikiOwogICAgICB9IGVsc2UgewogICAgICAgIHByb2dyYW1QYXJhbXMuc2hpZnQoKTsKICAgICAgICByZXR1cm4gInNlbGYucHJvZ3JhbVdpdGhEZXB0aCgiICsgcHJvZ3JhbVBhcmFtcy5qb2luKCIsICIpICsgIikiOwogICAgICB9CiAgICB9LAoKICAgIHJlZ2lzdGVyOiBmdW5jdGlvbihuYW1lLCB2YWwpIHsKICAgICAgdGhpcy51c2VSZWdpc3RlcihuYW1lKTsKICAgICAgdGhpcy5zb3VyY2UucHVzaChuYW1lICsgIiA9ICIgKyB2YWwgKyAiOyIpOwogICAgfSwKCiAgICB1c2VSZWdpc3RlcjogZnVuY3Rpb24obmFtZSkgewogICAgICBpZighdGhpcy5yZWdpc3RlcnNbbmFtZV0pIHsKICAgICAgICB0aGlzLnJlZ2lzdGVyc1tuYW1lXSA9IHRydWU7CiAgICAgICAgdGhpcy5yZWdpc3RlcnMubGlzdC5wdXNoKG5hbWUpOwogICAgICB9CiAgICB9LAoKICAgIHB1c2hTdGFja0xpdGVyYWw6IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgdGhpcy5jb21waWxlU3RhY2sucHVzaChuZXcgTGl0ZXJhbChpdGVtKSk7CiAgICAgIHJldHVybiBpdGVtOwogICAgfSwKCiAgICBwdXNoU3RhY2s6IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgdGhpcy5zb3VyY2UucHVzaCh0aGlzLmluY3JTdGFjaygpICsgIiA9ICIgKyBpdGVtICsgIjsiKTsKICAgICAgdGhpcy5jb21waWxlU3RhY2sucHVzaCgic3RhY2siICsgdGhpcy5zdGFja1Nsb3QpOwogICAgICByZXR1cm4gInN0YWNrIiArIHRoaXMuc3RhY2tTbG90OwogICAgfSwKCiAgICByZXBsYWNlU3RhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgIHZhciBpdGVtID0gY2FsbGJhY2suY2FsbCh0aGlzLCB0aGlzLnRvcFN0YWNrKCkpOwoKICAgICAgdGhpcy5zb3VyY2UucHVzaCh0aGlzLnRvcFN0YWNrKCkgKyAiID0gIiArIGl0ZW0gKyAiOyIpOwogICAgICByZXR1cm4gInN0YWNrIiArIHRoaXMuc3RhY2tTbG90OwogICAgfSwKCiAgICBuZXh0U3RhY2s6IGZ1bmN0aW9uKHNraXBDb21waWxlU3RhY2spIHsKICAgICAgdmFyIG5hbWUgPSB0aGlzLmluY3JTdGFjaygpOwogICAgICB0aGlzLmNvbXBpbGVTdGFjay5wdXNoKCJzdGFjayIgKyB0aGlzLnN0YWNrU2xvdCk7CiAgICAgIHJldHVybiBuYW1lOwogICAgfSwKCiAgICBpbmNyU3RhY2s6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnN0YWNrU2xvdCsrOwogICAgICBpZih0aGlzLnN0YWNrU2xvdCA+IHRoaXMuc3RhY2tWYXJzLmxlbmd0aCkgeyB0aGlzLnN0YWNrVmFycy5wdXNoKCJzdGFjayIgKyB0aGlzLnN0YWNrU2xvdCk7IH0KICAgICAgcmV0dXJuICJzdGFjayIgKyB0aGlzLnN0YWNrU2xvdDsKICAgIH0sCgogICAgcG9wU3RhY2s6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgaXRlbSA9IHRoaXMuY29tcGlsZVN0YWNrLnBvcCgpOwoKICAgICAgaWYgKGl0ZW0gaW5zdGFuY2VvZiBMaXRlcmFsKSB7CiAgICAgICAgcmV0dXJuIGl0ZW0udmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zdGFja1Nsb3QtLTsKICAgICAgICByZXR1cm4gaXRlbTsKICAgICAgfQogICAgfSwKCiAgICB0b3BTdGFjazogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpdGVtID0gdGhpcy5jb21waWxlU3RhY2tbdGhpcy5jb21waWxlU3RhY2subGVuZ3RoIC0gMV07CgogICAgICBpZiAoaXRlbSBpbnN0YW5jZW9mIExpdGVyYWwpIHsKICAgICAgICByZXR1cm4gaXRlbS52YWx1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gaXRlbTsKICAgICAgfQogICAgfSwKCiAgICBxdW90ZWRTdHJpbmc6IGZ1bmN0aW9uKHN0cikgewogICAgICByZXR1cm4gJyInICsgc3RyCiAgICAgICAgLnJlcGxhY2UoL1xcL2csICdcXFxcJykKICAgICAgICAucmVwbGFjZSgvIi9nLCAnXFwiJykKICAgICAgICAucmVwbGFjZSgvXG4vZywgJ1xcbicpCiAgICAgICAgLnJlcGxhY2UoL1xyL2csICdcXHInKSArICciJzsKICAgIH0sCgogICAgc2V0dXBIZWxwZXI6IGZ1bmN0aW9uKHBhcmFtU2l6ZSwgbmFtZSkgewogICAgICB2YXIgcGFyYW1zID0gW107CiAgICAgIHRoaXMuc2V0dXBQYXJhbXMocGFyYW1TaXplLCBwYXJhbXMpOwogICAgICB2YXIgZm91bmRIZWxwZXIgPSB0aGlzLm5hbWVMb29rdXAoJ2hlbHBlcnMnLCBuYW1lLCAnaGVscGVyJyk7CgogICAgICByZXR1cm4gewogICAgICAgIHBhcmFtczogcGFyYW1zLAogICAgICAgIG5hbWU6IGZvdW5kSGVscGVyLAogICAgICAgIGNhbGxQYXJhbXM6IFsiZGVwdGgwIl0uY29uY2F0KHBhcmFtcykuam9pbigiLCAiKSwKICAgICAgICBoZWxwZXJNaXNzaW5nUGFyYW1zOiBbImRlcHRoMCIsIHRoaXMucXVvdGVkU3RyaW5nKG5hbWUpXS5jb25jYXQocGFyYW1zKS5qb2luKCIsICIpCiAgICAgIH07CiAgICB9LAoKICAgIC8vIHRoZSBwYXJhbXMgYW5kIGNvbnRleHRzIGFyZ3VtZW50cyBhcmUgcGFzc2VkIGluIGFycmF5cwogICAgLy8gdG8gZmlsbCBpbgogICAgc2V0dXBQYXJhbXM6IGZ1bmN0aW9uKHBhcmFtU2l6ZSwgcGFyYW1zKSB7CiAgICAgIHZhciBvcHRpb25zID0gW10sIGNvbnRleHRzID0gW10sIHBhcmFtLCBpbnZlcnNlLCBwcm9ncmFtOwoKICAgICAgb3B0aW9ucy5wdXNoKCJoYXNoOiIgKyB0aGlzLnBvcFN0YWNrKCkpOwoKICAgICAgaW52ZXJzZSA9IHRoaXMucG9wU3RhY2soKTsKICAgICAgcHJvZ3JhbSA9IHRoaXMucG9wU3RhY2soKTsKCiAgICAgIC8vIEF2b2lkIHNldHRpbmcgZm4gYW5kIGludmVyc2UgaWYgbmVpdGhlciBhcmUgc2V0LiBUaGlzIGFsbG93cwogICAgICAvLyBoZWxwZXJzIHRvIGRvIGEgY2hlY2sgZm9yIGBpZiAob3B0aW9ucy5mbilgCiAgICAgIGlmIChwcm9ncmFtIHx8IGludmVyc2UpIHsKICAgICAgICBpZiAoIXByb2dyYW0pIHsKICAgICAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLnNlbGYgPSAidGhpcyI7CiAgICAgICAgICBwcm9ncmFtID0gInNlbGYubm9vcCI7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWludmVyc2UpIHsKICAgICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuc2VsZiA9ICJ0aGlzIjsKICAgICAgICAgIGludmVyc2UgPSAic2VsZi5ub29wIjsKICAgICAgICB9CgogICAgICAgIG9wdGlvbnMucHVzaCgiaW52ZXJzZToiICsgaW52ZXJzZSk7CiAgICAgICAgb3B0aW9ucy5wdXNoKCJmbjoiICsgcHJvZ3JhbSk7CiAgICAgIH0KCiAgICAgIGZvcih2YXIgaT0wOyBpPHBhcmFtU2l6ZTsgaSsrKSB7CiAgICAgICAgcGFyYW0gPSB0aGlzLnBvcFN0YWNrKCk7CiAgICAgICAgcGFyYW1zLnB1c2gocGFyYW0pOwoKICAgICAgICBpZih0aGlzLm9wdGlvbnMuc3RyaW5nUGFyYW1zKSB7CiAgICAgICAgICBjb250ZXh0cy5wdXNoKHRoaXMucG9wU3RhY2soKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5vcHRpb25zLnN0cmluZ1BhcmFtcykgewogICAgICAgIG9wdGlvbnMucHVzaCgiY29udGV4dHM6WyIgKyBjb250ZXh0cy5qb2luKCIsIikgKyAiXSIpOwogICAgICB9CgogICAgICBpZih0aGlzLm9wdGlvbnMuZGF0YSkgewogICAgICAgIG9wdGlvbnMucHVzaCgiZGF0YTpkYXRhIik7CiAgICAgIH0KCiAgICAgIHBhcmFtcy5wdXNoKCJ7IiArIG9wdGlvbnMuam9pbigiLCIpICsgIn0iKTsKICAgICAgcmV0dXJuIHBhcmFtcy5qb2luKCIsICIpOwogICAgfQogIH07CgogIHZhciByZXNlcnZlZFdvcmRzID0gKAogICAgImJyZWFrIGVsc2UgbmV3IHZhciIgKwogICAgIiBjYXNlIGZpbmFsbHkgcmV0dXJuIHZvaWQiICsKICAgICIgY2F0Y2ggZm9yIHN3aXRjaCB3aGlsZSIgKwogICAgIiBjb250aW51ZSBmdW5jdGlvbiB0aGlzIHdpdGgiICsKICAgICIgZGVmYXVsdCBpZiB0aHJvdyIgKwogICAgIiBkZWxldGUgaW4gdHJ5IiArCiAgICAiIGRvIGluc3RhbmNlb2YgdHlwZW9mIiArCiAgICAiIGFic3RyYWN0IGVudW0gaW50IHNob3J0IiArCiAgICAiIGJvb2xlYW4gZXhwb3J0IGludGVyZmFjZSBzdGF0aWMiICsKICAgICIgYnl0ZSBleHRlbmRzIGxvbmcgc3VwZXIiICsKICAgICIgY2hhciBmaW5hbCBuYXRpdmUgc3luY2hyb25pemVkIiArCiAgICAiIGNsYXNzIGZsb2F0IHBhY2thZ2UgdGhyb3dzIiArCiAgICAiIGNvbnN0IGdvdG8gcHJpdmF0ZSB0cmFuc2llbnQiICsKICAgICIgZGVidWdnZXIgaW1wbGVtZW50cyBwcm90ZWN0ZWQgdm9sYXRpbGUiICsKICAgICIgZG91YmxlIGltcG9ydCBwdWJsaWMgbGV0IHlpZWxkIgogICkuc3BsaXQoIiAiKTsKCiAgdmFyIGNvbXBpbGVyV29yZHMgPSBKYXZhU2NyaXB0Q29tcGlsZXIuUkVTRVJWRURfV09SRFMgPSB7fTsKCiAgZm9yKHZhciBpPTAsIGw9cmVzZXJ2ZWRXb3Jkcy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICBjb21waWxlcldvcmRzW3Jlc2VydmVkV29yZHNbaV1dID0gdHJ1ZTsKICB9CgogIEphdmFTY3JpcHRDb21waWxlci5pc1ZhbGlkSmF2YVNjcmlwdFZhcmlhYmxlTmFtZSA9IGZ1bmN0aW9uKG5hbWUpIHsKICAgIGlmKCFKYXZhU2NyaXB0Q29tcGlsZXIuUkVTRVJWRURfV09SRFNbbmFtZV0gJiYgL15bYS16QS1aXyRdWzAtOWEtekEtWl8kXSskLy50ZXN0KG5hbWUpKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH07Cgp9KShIYW5kbGViYXJzLkNvbXBpbGVyLCBIYW5kbGViYXJzLkphdmFTY3JpcHRDb21waWxlcik7CgpIYW5kbGViYXJzLnByZWNvbXBpbGUgPSBmdW5jdGlvbihzdHJpbmcsIG9wdGlvbnMpIHsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgdmFyIGFzdCA9IEhhbmRsZWJhcnMucGFyc2Uoc3RyaW5nKTsKICB2YXIgZW52aXJvbm1lbnQgPSBuZXcgSGFuZGxlYmFycy5Db21waWxlcigpLmNvbXBpbGUoYXN0LCBvcHRpb25zKTsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuSmF2YVNjcmlwdENvbXBpbGVyKCkuY29tcGlsZShlbnZpcm9ubWVudCwgb3B0aW9ucyk7Cn07CgpIYW5kbGViYXJzLmNvbXBpbGUgPSBmdW5jdGlvbihzdHJpbmcsIG9wdGlvbnMpIHsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgdmFyIGNvbXBpbGVkOwogIGZ1bmN0aW9uIGNvbXBpbGUoKSB7CiAgICB2YXIgYXN0ID0gSGFuZGxlYmFycy5wYXJzZShzdHJpbmcpOwogICAgdmFyIGVudmlyb25tZW50ID0gbmV3IEhhbmRsZWJhcnMuQ29tcGlsZXIoKS5jb21waWxlKGFzdCwgb3B0aW9ucyk7CiAgICB2YXIgdGVtcGxhdGVTcGVjID0gbmV3IEhhbmRsZWJhcnMuSmF2YVNjcmlwdENvbXBpbGVyKCkuY29tcGlsZShlbnZpcm9ubWVudCwgb3B0aW9ucywgdW5kZWZpbmVkLCB0cnVlKTsKICAgIHJldHVybiBIYW5kbGViYXJzLnRlbXBsYXRlKHRlbXBsYXRlU3BlYyk7CiAgfQoKICAvLyBUZW1wbGF0ZSBpcyBvbmx5IGNvbXBpbGVkIG9uIGZpcnN0IHVzZSBhbmQgY2FjaGVkIGFmdGVyIHRoYXQgcG9pbnQuCiAgcmV0dXJuIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICAgIGlmICghY29tcGlsZWQpIHsKICAgICAgY29tcGlsZWQgPSBjb21waWxlKCk7CiAgICB9CiAgICByZXR1cm4gY29tcGlsZWQuY2FsbCh0aGlzLCBjb250ZXh0LCBvcHRpb25zKTsKICB9Owp9Owo7Ci8vIGxpYi9oYW5kbGViYXJzL3J1bnRpbWUuanMKSGFuZGxlYmFycy5WTSA9IHsKICB0ZW1wbGF0ZTogZnVuY3Rpb24odGVtcGxhdGVTcGVjKSB7CiAgICAvLyBKdXN0IGFkZCB3YXRlcgogICAgdmFyIGNvbnRhaW5lciA9IHsKICAgICAgZXNjYXBlRXhwcmVzc2lvbjogSGFuZGxlYmFycy5VdGlscy5lc2NhcGVFeHByZXNzaW9uLAogICAgICBpbnZva2VQYXJ0aWFsOiBIYW5kbGViYXJzLlZNLmludm9rZVBhcnRpYWwsCiAgICAgIHByb2dyYW1zOiBbXSwKICAgICAgcHJvZ3JhbTogZnVuY3Rpb24oaSwgZm4sIGRhdGEpIHsKICAgICAgICB2YXIgcHJvZ3JhbVdyYXBwZXIgPSB0aGlzLnByb2dyYW1zW2ldOwogICAgICAgIGlmKGRhdGEpIHsKICAgICAgICAgIHByb2dyYW1XcmFwcGVyID0gSGFuZGxlYmFycy5WTS5wcm9ncmFtKGZuLCBkYXRhKTsKICAgICAgICAgIHByb2dyYW1XcmFwcGVyLnByb2dyYW0gPSBpOwogICAgICAgIH0gZWxzZSBpZiAoIXByb2dyYW1XcmFwcGVyKSB7CiAgICAgICAgICBwcm9ncmFtV3JhcHBlciA9IHRoaXMucHJvZ3JhbXNbaV0gPSBIYW5kbGViYXJzLlZNLnByb2dyYW0oZm4pOwogICAgICAgICAgcHJvZ3JhbVdyYXBwZXIucHJvZ3JhbSA9IGk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwcm9ncmFtV3JhcHBlcjsKICAgICAgfSwKICAgICAgcHJvZ3JhbVdpdGhEZXB0aDogSGFuZGxlYmFycy5WTS5wcm9ncmFtV2l0aERlcHRoLAogICAgICBub29wOiBIYW5kbGViYXJzLlZNLm5vb3AKICAgIH07CgogICAgcmV0dXJuIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHJldHVybiB0ZW1wbGF0ZVNwZWMuY2FsbChjb250YWluZXIsIEhhbmRsZWJhcnMsIGNvbnRleHQsIG9wdGlvbnMuaGVscGVycywgb3B0aW9ucy5wYXJ0aWFscywgb3B0aW9ucy5kYXRhKTsKICAgIH07CiAgfSwKCiAgcHJvZ3JhbVdpdGhEZXB0aDogZnVuY3Rpb24oZm4sIGRhdGEsICRkZXB0aCkgewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwoKICAgIHJldHVybiBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIFtjb250ZXh0LCBvcHRpb25zLmRhdGEgfHwgZGF0YV0uY29uY2F0KGFyZ3MpKTsKICAgIH07CiAgfSwKICBwcm9ncmFtOiBmdW5jdGlvbihmbiwgZGF0YSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgICByZXR1cm4gZm4oY29udGV4dCwgb3B0aW9ucy5kYXRhIHx8IGRhdGEpOwogICAgfTsKICB9LAogIG5vb3A6IGZ1bmN0aW9uKCkgeyByZXR1cm4gIiI7IH0sCiAgaW52b2tlUGFydGlhbDogZnVuY3Rpb24ocGFydGlhbCwgbmFtZSwgY29udGV4dCwgaGVscGVycywgcGFydGlhbHMsIGRhdGEpIHsKICAgIHZhciBvcHRpb25zID0geyBoZWxwZXJzOiBoZWxwZXJzLCBwYXJ0aWFsczogcGFydGlhbHMsIGRhdGE6IGRhdGEgfTsKCiAgICBpZihwYXJ0aWFsID09PSB1bmRlZmluZWQpIHsKICAgICAgdGhyb3cgbmV3IEhhbmRsZWJhcnMuRXhjZXB0aW9uKCJUaGUgcGFydGlhbCAiICsgbmFtZSArICIgY291bGQgbm90IGJlIGZvdW5kIik7CiAgICB9IGVsc2UgaWYocGFydGlhbCBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7CiAgICAgIHJldHVybiBwYXJ0aWFsKGNvbnRleHQsIG9wdGlvbnMpOwogICAgfSBlbHNlIGlmICghSGFuZGxlYmFycy5jb21waWxlKSB7CiAgICAgIHRocm93IG5ldyBIYW5kbGViYXJzLkV4Y2VwdGlvbigiVGhlIHBhcnRpYWwgIiArIG5hbWUgKyAiIGNvdWxkIG5vdCBiZSBjb21waWxlZCB3aGVuIHJ1bm5pbmcgaW4gcnVudGltZS1vbmx5IG1vZGUiKTsKICAgIH0gZWxzZSB7CiAgICAgIHBhcnRpYWxzW25hbWVdID0gSGFuZGxlYmFycy5jb21waWxlKHBhcnRpYWwsIHtkYXRhOiBkYXRhICE9PSB1bmRlZmluZWR9KTsKICAgICAgcmV0dXJuIHBhcnRpYWxzW25hbWVdKGNvbnRleHQsIG9wdGlvbnMpOwogICAgfQogIH0KfTsKCkhhbmRsZWJhcnMudGVtcGxhdGUgPSBIYW5kbGViYXJzLlZNLnRlbXBsYXRlOwo7CgovLyAgICAgVW5kZXJzY29yZS5qcyAxLjQuMgovLyAgICAgaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcKLy8gICAgIChjKSAyMDA5LTIwMTIgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIEluYy4KLy8gICAgIFVuZGVyc2NvcmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCgooZnVuY3Rpb24oKSB7CgogIC8vIEJhc2VsaW5lIHNldHVwCiAgLy8gLS0tLS0tLS0tLS0tLS0KCiAgLy8gRXN0YWJsaXNoIHRoZSByb290IG9iamVjdCwgYHdpbmRvd2AgaW4gdGhlIGJyb3dzZXIsIG9yIGBnbG9iYWxgIG9uIHRoZSBzZXJ2ZXIuCiAgdmFyIHJvb3QgPSB0aGlzOwoKICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYF9gIHZhcmlhYmxlLgogIHZhciBwcmV2aW91c1VuZGVyc2NvcmUgPSByb290Ll87CgogIC8vIEVzdGFibGlzaCB0aGUgb2JqZWN0IHRoYXQgZ2V0cyByZXR1cm5lZCB0byBicmVhayBvdXQgb2YgYSBsb29wIGl0ZXJhdGlvbi4KICB2YXIgYnJlYWtlciA9IHt9OwoKICAvLyBTYXZlIGJ5dGVzIGluIHRoZSBtaW5pZmllZCAoYnV0IG5vdCBnemlwcGVkKSB2ZXJzaW9uOgogIHZhciBBcnJheVByb3RvID0gQXJyYXkucHJvdG90eXBlLCBPYmpQcm90byA9IE9iamVjdC5wcm90b3R5cGUsIEZ1bmNQcm90byA9IEZ1bmN0aW9uLnByb3RvdHlwZTsKCiAgLy8gQ3JlYXRlIHF1aWNrIHJlZmVyZW5jZSB2YXJpYWJsZXMgZm9yIHNwZWVkIGFjY2VzcyB0byBjb3JlIHByb3RvdHlwZXMuCiAgdmFyIHB1c2ggICAgICAgICAgICAgPSBBcnJheVByb3RvLnB1c2gsCiAgICAgIHNsaWNlICAgICAgICAgICAgPSBBcnJheVByb3RvLnNsaWNlLAogICAgICBjb25jYXQgICAgICAgICAgID0gQXJyYXlQcm90by5jb25jYXQsCiAgICAgIHVuc2hpZnQgICAgICAgICAgPSBBcnJheVByb3RvLnVuc2hpZnQsCiAgICAgIHRvU3RyaW5nICAgICAgICAgPSBPYmpQcm90by50b1N0cmluZywKICAgICAgaGFzT3duUHJvcGVydHkgICA9IE9ialByb3RvLmhhc093blByb3BlcnR5OwoKICAvLyBBbGwgKipFQ01BU2NyaXB0IDUqKiBuYXRpdmUgZnVuY3Rpb24gaW1wbGVtZW50YXRpb25zIHRoYXQgd2UgaG9wZSB0byB1c2UKICAvLyBhcmUgZGVjbGFyZWQgaGVyZS4KICB2YXIKICAgIG5hdGl2ZUZvckVhY2ggICAgICA9IEFycmF5UHJvdG8uZm9yRWFjaCwKICAgIG5hdGl2ZU1hcCAgICAgICAgICA9IEFycmF5UHJvdG8ubWFwLAogICAgbmF0aXZlUmVkdWNlICAgICAgID0gQXJyYXlQcm90by5yZWR1Y2UsCiAgICBuYXRpdmVSZWR1Y2VSaWdodCAgPSBBcnJheVByb3RvLnJlZHVjZVJpZ2h0LAogICAgbmF0aXZlRmlsdGVyICAgICAgID0gQXJyYXlQcm90by5maWx0ZXIsCiAgICBuYXRpdmVFdmVyeSAgICAgICAgPSBBcnJheVByb3RvLmV2ZXJ5LAogICAgbmF0aXZlU29tZSAgICAgICAgID0gQXJyYXlQcm90by5zb21lLAogICAgbmF0aXZlSW5kZXhPZiAgICAgID0gQXJyYXlQcm90by5pbmRleE9mLAogICAgbmF0aXZlTGFzdEluZGV4T2YgID0gQXJyYXlQcm90by5sYXN0SW5kZXhPZiwKICAgIG5hdGl2ZUlzQXJyYXkgICAgICA9IEFycmF5LmlzQXJyYXksCiAgICBuYXRpdmVLZXlzICAgICAgICAgPSBPYmplY3Qua2V5cywKICAgIG5hdGl2ZUJpbmQgICAgICAgICA9IEZ1bmNQcm90by5iaW5kOwoKICAvLyBDcmVhdGUgYSBzYWZlIHJlZmVyZW5jZSB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QgZm9yIHVzZSBiZWxvdy4KICB2YXIgXyA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKG9iaiBpbnN0YW5jZW9mIF8pIHJldHVybiBvYmo7CiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgXykpIHJldHVybiBuZXcgXyhvYmopOwogICAgdGhpcy5fd3JhcHBlZCA9IG9iajsKICB9OwoKICAvLyBFeHBvcnQgdGhlIFVuZGVyc2NvcmUgb2JqZWN0IGZvciAqKk5vZGUuanMqKiwgd2l0aAogIC8vIGJhY2t3YXJkcy1jb21wYXRpYmlsaXR5IGZvciB0aGUgb2xkIGByZXF1aXJlKClgIEFQSS4gSWYgd2UncmUgaW4KICAvLyB0aGUgYnJvd3NlciwgYWRkIGBfYCBhcyBhIGdsb2JhbCBvYmplY3QgdmlhIGEgc3RyaW5nIGlkZW50aWZpZXIsCiAgLy8gZm9yIENsb3N1cmUgQ29tcGlsZXIgImFkdmFuY2VkIiBtb2RlLgogIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIGlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyAmJiBtb2R1bGUuZXhwb3J0cykgewogICAgICBleHBvcnRzID0gbW9kdWxlLmV4cG9ydHMgPSBfOwogICAgfQogICAgZXhwb3J0cy5fID0gXzsKICB9IGVsc2UgewogICAgcm9vdFsnXyddID0gXzsKICB9CgogIC8vIEN1cnJlbnQgdmVyc2lvbi4KICBfLlZFUlNJT04gPSAnMS40LjInOwoKICAvLyBDb2xsZWN0aW9uIEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFRoZSBjb3JuZXJzdG9uZSwgYW4gYGVhY2hgIGltcGxlbWVudGF0aW9uLCBha2EgYGZvckVhY2hgLgogIC8vIEhhbmRsZXMgb2JqZWN0cyB3aXRoIHRoZSBidWlsdC1pbiBgZm9yRWFjaGAsIGFycmF5cywgYW5kIHJhdyBvYmplY3RzLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBmb3JFYWNoYCBpZiBhdmFpbGFibGUuCiAgdmFyIGVhY2ggPSBfLmVhY2ggPSBfLmZvckVhY2ggPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybjsKICAgIGlmIChuYXRpdmVGb3JFYWNoICYmIG9iai5mb3JFYWNoID09PSBuYXRpdmVGb3JFYWNoKSB7CiAgICAgIG9iai5mb3JFYWNoKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH0gZWxzZSBpZiAob2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGgpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBvYmoubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgaWYgKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2ldLCBpLCBvYmopID09PSBicmVha2VyKSByZXR1cm47CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICBpZiAoXy5oYXMob2JqLCBrZXkpKSB7CiAgICAgICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5LCBvYmopID09PSBicmVha2VyKSByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSByZXN1bHRzIG9mIGFwcGx5aW5nIHRoZSBpdGVyYXRvciB0byBlYWNoIGVsZW1lbnQuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYG1hcGAgaWYgYXZhaWxhYmxlLgogIF8ubWFwID0gXy5jb2xsZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHJlc3VsdHM7CiAgICBpZiAobmF0aXZlTWFwICYmIG9iai5tYXAgPT09IG5hdGl2ZU1hcCkgcmV0dXJuIG9iai5tYXAoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICByZXN1bHRzW3Jlc3VsdHMubGVuZ3RoXSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKCiAgLy8gKipSZWR1Y2UqKiBidWlsZHMgdXAgYSBzaW5nbGUgcmVzdWx0IGZyb20gYSBsaXN0IG9mIHZhbHVlcywgYWthIGBpbmplY3RgLAogIC8vIG9yIGBmb2xkbGAuIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGByZWR1Y2VgIGlmIGF2YWlsYWJsZS4KICBfLnJlZHVjZSA9IF8uZm9sZGwgPSBfLmluamVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIG1lbW8sIGNvbnRleHQpIHsKICAgIHZhciBpbml0aWFsID0gYXJndW1lbnRzLmxlbmd0aCA+IDI7CiAgICBpZiAob2JqID09IG51bGwpIG9iaiA9IFtdOwogICAgaWYgKG5hdGl2ZVJlZHVjZSAmJiBvYmoucmVkdWNlID09PSBuYXRpdmVSZWR1Y2UpIHsKICAgICAgaWYgKGNvbnRleHQpIGl0ZXJhdG9yID0gXy5iaW5kKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgICAgcmV0dXJuIGluaXRpYWwgPyBvYmoucmVkdWNlKGl0ZXJhdG9yLCBtZW1vKSA6IG9iai5yZWR1Y2UoaXRlcmF0b3IpOwogICAgfQogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoIWluaXRpYWwpIHsKICAgICAgICBtZW1vID0gdmFsdWU7CiAgICAgICAgaW5pdGlhbCA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWVtbyA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgbWVtbywgdmFsdWUsIGluZGV4LCBsaXN0KTsKICAgICAgfQogICAgfSk7CiAgICBpZiAoIWluaXRpYWwpIHRocm93IG5ldyBUeXBlRXJyb3IoJ1JlZHVjZSBvZiBlbXB0eSBhcnJheSB3aXRoIG5vIGluaXRpYWwgdmFsdWUnKTsKICAgIHJldHVybiBtZW1vOwogIH07CgogIC8vIFRoZSByaWdodC1hc3NvY2lhdGl2ZSB2ZXJzaW9uIG9mIHJlZHVjZSwgYWxzbyBrbm93biBhcyBgZm9sZHJgLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGByZWR1Y2VSaWdodGAgaWYgYXZhaWxhYmxlLgogIF8ucmVkdWNlUmlnaHQgPSBfLmZvbGRyID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgbWVtbywgY29udGV4dCkgewogICAgdmFyIGluaXRpYWwgPSBhcmd1bWVudHMubGVuZ3RoID4gMjsKICAgIGlmIChvYmogPT0gbnVsbCkgb2JqID0gW107CiAgICBpZiAobmF0aXZlUmVkdWNlUmlnaHQgJiYgb2JqLnJlZHVjZVJpZ2h0ID09PSBuYXRpdmVSZWR1Y2VSaWdodCkgewogICAgICBpZiAoY29udGV4dCkgaXRlcmF0b3IgPSBfLmJpbmQoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA+IDIgPyBvYmoucmVkdWNlUmlnaHQoaXRlcmF0b3IsIG1lbW8pIDogb2JqLnJlZHVjZVJpZ2h0KGl0ZXJhdG9yKTsKICAgIH0KICAgIHZhciBsZW5ndGggPSBvYmoubGVuZ3RoOwogICAgaWYgKGxlbmd0aCAhPT0gK2xlbmd0aCkgewogICAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwogICAgICBsZW5ndGggPSBrZXlzLmxlbmd0aDsKICAgIH0KICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaW5kZXggPSBrZXlzID8ga2V5c1stLWxlbmd0aF0gOiAtLWxlbmd0aDsKICAgICAgaWYgKCFpbml0aWFsKSB7CiAgICAgICAgbWVtbyA9IG9ialtpbmRleF07CiAgICAgICAgaW5pdGlhbCA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWVtbyA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgbWVtbywgb2JqW2luZGV4XSwgaW5kZXgsIGxpc3QpOwogICAgICB9CiAgICB9KTsKICAgIGlmICghaW5pdGlhbCkgdGhyb3cgbmV3IFR5cGVFcnJvcignUmVkdWNlIG9mIGVtcHR5IGFycmF5IHdpdGggbm8gaW5pdGlhbCB2YWx1ZScpOwogICAgcmV0dXJuIG1lbW87CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBmaXJzdCB2YWx1ZSB3aGljaCBwYXNzZXMgYSB0cnV0aCB0ZXN0LiBBbGlhc2VkIGFzIGBkZXRlY3RgLgogIF8uZmluZCA9IF8uZGV0ZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdDsKICAgIGFueShvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSB7CiAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBSZXR1cm4gYWxsIHRoZSBlbGVtZW50cyB0aGF0IHBhc3MgYSB0cnV0aCB0ZXN0LgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBmaWx0ZXJgIGlmIGF2YWlsYWJsZS4KICAvLyBBbGlhc2VkIGFzIGBzZWxlY3RgLgogIF8uZmlsdGVyID0gXy5zZWxlY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0czsKICAgIGlmIChuYXRpdmVGaWx0ZXIgJiYgb2JqLmZpbHRlciA9PT0gbmF0aXZlRmlsdGVyKSByZXR1cm4gb2JqLmZpbHRlcihpdGVyYXRvciwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmIChpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpIHJlc3VsdHNbcmVzdWx0cy5sZW5ndGhdID0gdmFsdWU7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIGZvciB3aGljaCBhIHRydXRoIHRlc3QgZmFpbHMuCiAgXy5yZWplY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0czsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKCFpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpIHJlc3VsdHNbcmVzdWx0cy5sZW5ndGhdID0gdmFsdWU7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIERldGVybWluZSB3aGV0aGVyIGFsbCBvZiB0aGUgZWxlbWVudHMgbWF0Y2ggYSB0cnV0aCB0ZXN0LgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBldmVyeWAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYGFsbGAuCiAgXy5ldmVyeSA9IF8uYWxsID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgfHwgKGl0ZXJhdG9yID0gXy5pZGVudGl0eSk7CiAgICB2YXIgcmVzdWx0ID0gdHJ1ZTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHJlc3VsdDsKICAgIGlmIChuYXRpdmVFdmVyeSAmJiBvYmouZXZlcnkgPT09IG5hdGl2ZUV2ZXJ5KSByZXR1cm4gb2JqLmV2ZXJ5KGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKCEocmVzdWx0ID0gcmVzdWx0ICYmIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkpIHJldHVybiBicmVha2VyOwogICAgfSk7CiAgICByZXR1cm4gISFyZXN1bHQ7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIGlmIGF0IGxlYXN0IG9uZSBlbGVtZW50IGluIHRoZSBvYmplY3QgbWF0Y2hlcyBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYHNvbWVgIGlmIGF2YWlsYWJsZS4KICAvLyBBbGlhc2VkIGFzIGBhbnlgLgogIHZhciBhbnkgPSBfLnNvbWUgPSBfLmFueSA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGl0ZXJhdG9yIHx8IChpdGVyYXRvciA9IF8uaWRlbnRpdHkpOwogICAgdmFyIHJlc3VsdCA9IGZhbHNlOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0OwogICAgaWYgKG5hdGl2ZVNvbWUgJiYgb2JqLnNvbWUgPT09IG5hdGl2ZVNvbWUpIHJldHVybiBvYmouc29tZShpdGVyYXRvciwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmIChyZXN1bHQgfHwgKHJlc3VsdCA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkpIHJldHVybiBicmVha2VyOwogICAgfSk7CiAgICByZXR1cm4gISFyZXN1bHQ7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBhcnJheSBvciBvYmplY3QgY29udGFpbnMgYSBnaXZlbiB2YWx1ZSAodXNpbmcgYD09PWApLgogIC8vIEFsaWFzZWQgYXMgYGluY2x1ZGVgLgogIF8uY29udGFpbnMgPSBfLmluY2x1ZGUgPSBmdW5jdGlvbihvYmosIHRhcmdldCkgewogICAgdmFyIGZvdW5kID0gZmFsc2U7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiBmb3VuZDsKICAgIGlmIChuYXRpdmVJbmRleE9mICYmIG9iai5pbmRleE9mID09PSBuYXRpdmVJbmRleE9mKSByZXR1cm4gb2JqLmluZGV4T2YodGFyZ2V0KSAhPSAtMTsKICAgIGZvdW5kID0gYW55KG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSB0YXJnZXQ7CiAgICB9KTsKICAgIHJldHVybiBmb3VuZDsKICB9OwoKICAvLyBJbnZva2UgYSBtZXRob2QgKHdpdGggYXJndW1lbnRzKSBvbiBldmVyeSBpdGVtIGluIGEgY29sbGVjdGlvbi4KICBfLmludm9rZSA9IGZ1bmN0aW9uKG9iaiwgbWV0aG9kKSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHJldHVybiBfLm1hcChvYmosIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiAoXy5pc0Z1bmN0aW9uKG1ldGhvZCkgPyBtZXRob2QgOiB2YWx1ZVttZXRob2RdKS5hcHBseSh2YWx1ZSwgYXJncyk7CiAgICB9KTsKICB9OwoKICAvLyBDb252ZW5pZW5jZSB2ZXJzaW9uIG9mIGEgY29tbW9uIHVzZSBjYXNlIG9mIGBtYXBgOiBmZXRjaGluZyBhIHByb3BlcnR5LgogIF8ucGx1Y2sgPSBmdW5jdGlvbihvYmosIGtleSkgewogICAgcmV0dXJuIF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUpeyByZXR1cm4gdmFsdWVba2V5XTsgfSk7CiAgfTsKCiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgZmlsdGVyYDogc2VsZWN0aW5nIG9ubHkgb2JqZWN0cwogIC8vIHdpdGggc3BlY2lmaWMgYGtleTp2YWx1ZWAgcGFpcnMuCiAgXy53aGVyZSA9IGZ1bmN0aW9uKG9iaiwgYXR0cnMpIHsKICAgIGlmIChfLmlzRW1wdHkoYXR0cnMpKSByZXR1cm4gW107CiAgICByZXR1cm4gXy5maWx0ZXIob2JqLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICBmb3IgKHZhciBrZXkgaW4gYXR0cnMpIHsKICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gdmFsdWVba2V5XSkgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfSk7CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBtYXhpbXVtIGVsZW1lbnQgb3IgKGVsZW1lbnQtYmFzZWQgY29tcHV0YXRpb24pLgogIC8vIENhbid0IG9wdGltaXplIGFycmF5cyBvZiBpbnRlZ2VycyBsb25nZXIgdGhhbiA2NSw1MzUgZWxlbWVudHMuCiAgLy8gU2VlOiBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9ODA3OTcKICBfLm1heCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0FycmF5KG9iaikgJiYgb2JqWzBdID09PSArb2JqWzBdICYmIG9iai5sZW5ndGggPCA2NTUzNSkgewogICAgICByZXR1cm4gTWF0aC5tYXguYXBwbHkoTWF0aCwgb2JqKTsKICAgIH0KICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0VtcHR5KG9iaikpIHJldHVybiAtSW5maW5pdHk7CiAgICB2YXIgcmVzdWx0ID0ge2NvbXB1dGVkIDogLUluZmluaXR5fTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgdmFyIGNvbXB1dGVkID0gaXRlcmF0b3IgPyBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkgOiB2YWx1ZTsKICAgICAgY29tcHV0ZWQgPj0gcmVzdWx0LmNvbXB1dGVkICYmIChyZXN1bHQgPSB7dmFsdWUgOiB2YWx1ZSwgY29tcHV0ZWQgOiBjb21wdXRlZH0pOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0LnZhbHVlOwogIH07CgogIC8vIFJldHVybiB0aGUgbWluaW11bSBlbGVtZW50IChvciBlbGVtZW50LWJhc2VkIGNvbXB1dGF0aW9uKS4KICBfLm1pbiA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0FycmF5KG9iaikgJiYgb2JqWzBdID09PSArb2JqWzBdICYmIG9iai5sZW5ndGggPCA2NTUzNSkgewogICAgICByZXR1cm4gTWF0aC5taW4uYXBwbHkoTWF0aCwgb2JqKTsKICAgIH0KICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0VtcHR5KG9iaikpIHJldHVybiBJbmZpbml0eTsKICAgIHZhciByZXN1bHQgPSB7Y29tcHV0ZWQgOiBJbmZpbml0eX07CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHZhciBjb21wdXRlZCA9IGl0ZXJhdG9yID8gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpIDogdmFsdWU7CiAgICAgIGNvbXB1dGVkIDwgcmVzdWx0LmNvbXB1dGVkICYmIChyZXN1bHQgPSB7dmFsdWUgOiB2YWx1ZSwgY29tcHV0ZWQgOiBjb21wdXRlZH0pOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0LnZhbHVlOwogIH07CgogIC8vIFNodWZmbGUgYW4gYXJyYXkuCiAgXy5zaHVmZmxlID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgcmFuZDsKICAgIHZhciBpbmRleCA9IDA7CiAgICB2YXIgc2h1ZmZsZWQgPSBbXTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICByYW5kID0gXy5yYW5kb20oaW5kZXgrKyk7CiAgICAgIHNodWZmbGVkW2luZGV4IC0gMV0gPSBzaHVmZmxlZFtyYW5kXTsKICAgICAgc2h1ZmZsZWRbcmFuZF0gPSB2YWx1ZTsKICAgIH0pOwogICAgcmV0dXJuIHNodWZmbGVkOwogIH07CgogIC8vIEFuIGludGVybmFsIGZ1bmN0aW9uIHRvIGdlbmVyYXRlIGxvb2t1cCBpdGVyYXRvcnMuCiAgdmFyIGxvb2t1cEl0ZXJhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiBfLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUgOiBmdW5jdGlvbihvYmopeyByZXR1cm4gb2JqW3ZhbHVlXTsgfTsKICB9OwoKICAvLyBTb3J0IHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24gcHJvZHVjZWQgYnkgYW4gaXRlcmF0b3IuCiAgXy5zb3J0QnkgPSBmdW5jdGlvbihvYmosIHZhbHVlLCBjb250ZXh0KSB7CiAgICB2YXIgaXRlcmF0b3IgPSBsb29rdXBJdGVyYXRvcih2YWx1ZSk7CiAgICByZXR1cm4gXy5wbHVjayhfLm1hcChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICByZXR1cm4gewogICAgICAgIHZhbHVlIDogdmFsdWUsCiAgICAgICAgaW5kZXggOiBpbmRleCwKICAgICAgICBjcml0ZXJpYSA6IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KQogICAgICB9OwogICAgfSkuc29ydChmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICB2YXIgYSA9IGxlZnQuY3JpdGVyaWE7CiAgICAgIHZhciBiID0gcmlnaHQuY3JpdGVyaWE7CiAgICAgIGlmIChhICE9PSBiKSB7CiAgICAgICAgaWYgKGEgPiBiIHx8IGEgPT09IHZvaWQgMCkgcmV0dXJuIDE7CiAgICAgICAgaWYgKGEgPCBiIHx8IGIgPT09IHZvaWQgMCkgcmV0dXJuIC0xOwogICAgICB9CiAgICAgIHJldHVybiBsZWZ0LmluZGV4IDwgcmlnaHQuaW5kZXggPyAtMSA6IDE7CiAgICB9KSwgJ3ZhbHVlJyk7CiAgfTsKCiAgLy8gQW4gaW50ZXJuYWwgZnVuY3Rpb24gdXNlZCBmb3IgYWdncmVnYXRlICJncm91cCBieSIgb3BlcmF0aW9ucy4KICB2YXIgZ3JvdXAgPSBmdW5jdGlvbihvYmosIHZhbHVlLCBjb250ZXh0LCBiZWhhdmlvcikgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgdmFyIGl0ZXJhdG9yID0gbG9va3VwSXRlcmF0b3IodmFsdWUpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkgewogICAgICB2YXIga2V5ID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIG9iaik7CiAgICAgIGJlaGF2aW9yKHJlc3VsdCwga2V5LCB2YWx1ZSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gR3JvdXBzIHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24uIFBhc3MgZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZQogIC8vIHRvIGdyb3VwIGJ5LCBvciBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgY3JpdGVyaW9uLgogIF8uZ3JvdXBCeSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQpIHsKICAgIHJldHVybiBncm91cChvYmosIHZhbHVlLCBjb250ZXh0LCBmdW5jdGlvbihyZXN1bHQsIGtleSwgdmFsdWUpIHsKICAgICAgKF8uaGFzKHJlc3VsdCwga2V5KSA/IHJlc3VsdFtrZXldIDogKHJlc3VsdFtrZXldID0gW10pKS5wdXNoKHZhbHVlKTsKICAgIH0pOwogIH07CgogIC8vIENvdW50cyBpbnN0YW5jZXMgb2YgYW4gb2JqZWN0IHRoYXQgZ3JvdXAgYnkgYSBjZXJ0YWluIGNyaXRlcmlvbi4gUGFzcwogIC8vIGVpdGhlciBhIHN0cmluZyBhdHRyaWJ1dGUgdG8gY291bnQgYnksIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZQogIC8vIGNyaXRlcmlvbi4KICBfLmNvdW50QnkgPSBmdW5jdGlvbihvYmosIHZhbHVlLCBjb250ZXh0KSB7CiAgICByZXR1cm4gZ3JvdXAob2JqLCB2YWx1ZSwgY29udGV4dCwgZnVuY3Rpb24ocmVzdWx0LCBrZXksIHZhbHVlKSB7CiAgICAgIGlmICghXy5oYXMocmVzdWx0LCBrZXkpKSByZXN1bHRba2V5XSA9IDA7CiAgICAgIHJlc3VsdFtrZXldKys7CiAgICB9KTsKICB9OwoKICAvLyBVc2UgYSBjb21wYXJhdG9yIGZ1bmN0aW9uIHRvIGZpZ3VyZSBvdXQgdGhlIHNtYWxsZXN0IGluZGV4IGF0IHdoaWNoCiAgLy8gYW4gb2JqZWN0IHNob3VsZCBiZSBpbnNlcnRlZCBzbyBhcyB0byBtYWludGFpbiBvcmRlci4gVXNlcyBiaW5hcnkgc2VhcmNoLgogIF8uc29ydGVkSW5kZXggPSBmdW5jdGlvbihhcnJheSwgb2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgPSBpdGVyYXRvciA9PSBudWxsID8gXy5pZGVudGl0eSA6IGxvb2t1cEl0ZXJhdG9yKGl0ZXJhdG9yKTsKICAgIHZhciB2YWx1ZSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqKTsKICAgIHZhciBsb3cgPSAwLCBoaWdoID0gYXJyYXkubGVuZ3RoOwogICAgd2hpbGUgKGxvdyA8IGhpZ2gpIHsKICAgICAgdmFyIG1pZCA9IChsb3cgKyBoaWdoKSA+Pj4gMTsKICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBhcnJheVttaWRdKSA8IHZhbHVlID8gbG93ID0gbWlkICsgMSA6IGhpZ2ggPSBtaWQ7CiAgICB9CiAgICByZXR1cm4gbG93OwogIH07CgogIC8vIFNhZmVseSBjb252ZXJ0IGFueXRoaW5nIGl0ZXJhYmxlIGludG8gYSByZWFsLCBsaXZlIGFycmF5LgogIF8udG9BcnJheSA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCFvYmopIHJldHVybiBbXTsKICAgIGlmIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgcmV0dXJuIHNsaWNlLmNhbGwob2JqKTsKICAgIHJldHVybiBfLnZhbHVlcyhvYmopOwogIH07CgogIC8vIFJldHVybiB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIGFuIG9iamVjdC4KICBfLnNpemUgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiAob2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGgpID8gb2JqLmxlbmd0aCA6IF8ua2V5cyhvYmopLmxlbmd0aDsKICB9OwoKICAvLyBBcnJheSBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0KCiAgLy8gR2V0IHRoZSBmaXJzdCBlbGVtZW50IG9mIGFuIGFycmF5LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIHRoZSBmaXJzdCBOCiAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gQWxpYXNlZCBhcyBgaGVhZGAgYW5kIGB0YWtlYC4gVGhlICoqZ3VhcmQqKiBjaGVjawogIC8vIGFsbG93cyBpdCB0byB3b3JrIHdpdGggYF8ubWFwYC4KICBfLmZpcnN0ID0gXy5oZWFkID0gXy50YWtlID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICByZXR1cm4gKG4gIT0gbnVsbCkgJiYgIWd1YXJkID8gc2xpY2UuY2FsbChhcnJheSwgMCwgbikgOiBhcnJheVswXTsKICB9OwoKICAvLyBSZXR1cm5zIGV2ZXJ5dGhpbmcgYnV0IHRoZSBsYXN0IGVudHJ5IG9mIHRoZSBhcnJheS4gRXNwZWNpYWxseSB1c2VmdWwgb24KICAvLyB0aGUgYXJndW1lbnRzIG9iamVjdC4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiBhbGwgdGhlIHZhbHVlcyBpbgogIC8vIHRoZSBhcnJheSwgZXhjbHVkaW5nIHRoZSBsYXN0IE4uIFRoZSAqKmd1YXJkKiogY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aAogIC8vIGBfLm1hcGAuCiAgXy5pbml0aWFsID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgMCwgYXJyYXkubGVuZ3RoIC0gKChuID09IG51bGwpIHx8IGd1YXJkID8gMSA6IG4pKTsKICB9OwoKICAvLyBHZXQgdGhlIGxhc3QgZWxlbWVudCBvZiBhbiBhcnJheS4gUGFzc2luZyAqKm4qKiB3aWxsIHJldHVybiB0aGUgbGFzdCBOCiAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gVGhlICoqZ3VhcmQqKiBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCiAgXy5sYXN0ID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICBpZiAoKG4gIT0gbnVsbCkgJiYgIWd1YXJkKSB7CiAgICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCBNYXRoLm1heChhcnJheS5sZW5ndGggLSBuLCAwKSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gYXJyYXlbYXJyYXkubGVuZ3RoIC0gMV07CiAgICB9CiAgfTsKCiAgLy8gUmV0dXJucyBldmVyeXRoaW5nIGJ1dCB0aGUgZmlyc3QgZW50cnkgb2YgdGhlIGFycmF5LiBBbGlhc2VkIGFzIGB0YWlsYCBhbmQgYGRyb3BgLgogIC8vIEVzcGVjaWFsbHkgdXNlZnVsIG9uIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nIGFuICoqbioqIHdpbGwgcmV0dXJuCiAgLy8gdGhlIHJlc3QgTiB2YWx1ZXMgaW4gdGhlIGFycmF5LiBUaGUgKipndWFyZCoqCiAgLy8gY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8ucmVzdCA9IF8udGFpbCA9IF8uZHJvcCA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewogICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIChuID09IG51bGwpIHx8IGd1YXJkID8gMSA6IG4pOwogIH07CgogIC8vIFRyaW0gb3V0IGFsbCBmYWxzeSB2YWx1ZXMgZnJvbSBhbiBhcnJheS4KICBfLmNvbXBhY3QgPSBmdW5jdGlvbihhcnJheSkgewogICAgcmV0dXJuIF8uZmlsdGVyKGFycmF5LCBmdW5jdGlvbih2YWx1ZSl7IHJldHVybiAhIXZhbHVlOyB9KTsKICB9OwoKICAvLyBJbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiBvZiBhIHJlY3Vyc2l2ZSBgZmxhdHRlbmAgZnVuY3Rpb24uCiAgdmFyIGZsYXR0ZW4gPSBmdW5jdGlvbihpbnB1dCwgc2hhbGxvdywgb3V0cHV0KSB7CiAgICBlYWNoKGlucHV0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAoXy5pc0FycmF5KHZhbHVlKSkgewogICAgICAgIHNoYWxsb3cgPyBwdXNoLmFwcGx5KG91dHB1dCwgdmFsdWUpIDogZmxhdHRlbih2YWx1ZSwgc2hhbGxvdywgb3V0cHV0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvdXRwdXQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG91dHB1dDsKICB9OwoKICAvLyBSZXR1cm4gYSBjb21wbGV0ZWx5IGZsYXR0ZW5lZCB2ZXJzaW9uIG9mIGFuIGFycmF5LgogIF8uZmxhdHRlbiA9IGZ1bmN0aW9uKGFycmF5LCBzaGFsbG93KSB7CiAgICByZXR1cm4gZmxhdHRlbihhcnJheSwgc2hhbGxvdywgW10pOwogIH07CgogIC8vIFJldHVybiBhIHZlcnNpb24gb2YgdGhlIGFycmF5IHRoYXQgZG9lcyBub3QgY29udGFpbiB0aGUgc3BlY2lmaWVkIHZhbHVlKHMpLgogIF8ud2l0aG91dCA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICByZXR1cm4gXy5kaWZmZXJlbmNlKGFycmF5LCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogIH07CgogIC8vIFByb2R1Y2UgYSBkdXBsaWNhdGUtZnJlZSB2ZXJzaW9uIG9mIHRoZSBhcnJheS4gSWYgdGhlIGFycmF5IGhhcyBhbHJlYWR5CiAgLy8gYmVlbiBzb3J0ZWQsIHlvdSBoYXZlIHRoZSBvcHRpb24gb2YgdXNpbmcgYSBmYXN0ZXIgYWxnb3JpdGhtLgogIC8vIEFsaWFzZWQgYXMgYHVuaXF1ZWAuCiAgXy51bmlxID0gXy51bmlxdWUgPSBmdW5jdGlvbihhcnJheSwgaXNTb3J0ZWQsIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgaW5pdGlhbCA9IGl0ZXJhdG9yID8gXy5tYXAoYXJyYXksIGl0ZXJhdG9yLCBjb250ZXh0KSA6IGFycmF5OwogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIHZhciBzZWVuID0gW107CiAgICBlYWNoKGluaXRpYWwsIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkgewogICAgICBpZiAoaXNTb3J0ZWQgPyAoIWluZGV4IHx8IHNlZW5bc2Vlbi5sZW5ndGggLSAxXSAhPT0gdmFsdWUpIDogIV8uY29udGFpbnMoc2VlbiwgdmFsdWUpKSB7CiAgICAgICAgc2Vlbi5wdXNoKHZhbHVlKTsKICAgICAgICByZXN1bHRzLnB1c2goYXJyYXlbaW5kZXhdKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgdGhlIHVuaW9uOiBlYWNoIGRpc3RpbmN0IGVsZW1lbnQgZnJvbSBhbGwgb2YKICAvLyB0aGUgcGFzc2VkLWluIGFycmF5cy4KICBfLnVuaW9uID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gXy51bmlxKGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBhcmd1bWVudHMpKTsKICB9OwoKICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgZXZlcnkgaXRlbSBzaGFyZWQgYmV0d2VlbiBhbGwgdGhlCiAgLy8gcGFzc2VkLWluIGFycmF5cy4KICBfLmludGVyc2VjdGlvbiA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICB2YXIgcmVzdCA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIHJldHVybiBfLmZpbHRlcihfLnVuaXEoYXJyYXkpLCBmdW5jdGlvbihpdGVtKSB7CiAgICAgIHJldHVybiBfLmV2ZXJ5KHJlc3QsIGZ1bmN0aW9uKG90aGVyKSB7CiAgICAgICAgcmV0dXJuIF8uaW5kZXhPZihvdGhlciwgaXRlbSkgPj0gMDsKICAgICAgfSk7CiAgICB9KTsKICB9OwoKICAvLyBUYWtlIHRoZSBkaWZmZXJlbmNlIGJldHdlZW4gb25lIGFycmF5IGFuZCBhIG51bWJlciBvZiBvdGhlciBhcnJheXMuCiAgLy8gT25seSB0aGUgZWxlbWVudHMgcHJlc2VudCBpbiBqdXN0IHRoZSBmaXJzdCBhcnJheSB3aWxsIHJlbWFpbi4KICBfLmRpZmZlcmVuY2UgPSBmdW5jdGlvbihhcnJheSkgewogICAgdmFyIHJlc3QgPSBjb25jYXQuYXBwbHkoQXJyYXlQcm90bywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIHJldHVybiBfLmZpbHRlcihhcnJheSwgZnVuY3Rpb24odmFsdWUpeyByZXR1cm4gIV8uY29udGFpbnMocmVzdCwgdmFsdWUpOyB9KTsKICB9OwoKICAvLyBaaXAgdG9nZXRoZXIgbXVsdGlwbGUgbGlzdHMgaW50byBhIHNpbmdsZSBhcnJheSAtLSBlbGVtZW50cyB0aGF0IHNoYXJlCiAgLy8gYW4gaW5kZXggZ28gdG9nZXRoZXIuCiAgXy56aXAgPSBmdW5jdGlvbigpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgdmFyIGxlbmd0aCA9IF8ubWF4KF8ucGx1Y2soYXJncywgJ2xlbmd0aCcpKTsKICAgIHZhciByZXN1bHRzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHJlc3VsdHNbaV0gPSBfLnBsdWNrKGFyZ3MsICIiICsgaSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyBDb252ZXJ0cyBsaXN0cyBpbnRvIG9iamVjdHMuIFBhc3MgZWl0aGVyIGEgc2luZ2xlIGFycmF5IG9mIGBba2V5LCB2YWx1ZV1gCiAgLy8gcGFpcnMsIG9yIHR3byBwYXJhbGxlbCBhcnJheXMgb2YgdGhlIHNhbWUgbGVuZ3RoIC0tIG9uZSBvZiBrZXlzLCBhbmQgb25lIG9mCiAgLy8gdGhlIGNvcnJlc3BvbmRpbmcgdmFsdWVzLgogIF8ub2JqZWN0ID0gZnVuY3Rpb24obGlzdCwgdmFsdWVzKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGxpc3QubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIGlmICh2YWx1ZXMpIHsKICAgICAgICByZXN1bHRbbGlzdFtpXV0gPSB2YWx1ZXNbaV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0W2xpc3RbaV1bMF1dID0gbGlzdFtpXVsxXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBJZiB0aGUgYnJvd3NlciBkb2Vzbid0IHN1cHBseSB1cyB3aXRoIGluZGV4T2YgKEknbSBsb29raW5nIGF0IHlvdSwgKipNU0lFKiopLAogIC8vIHdlIG5lZWQgdGhpcyBmdW5jdGlvbi4gUmV0dXJuIHRoZSBwb3NpdGlvbiBvZiB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBhbgogIC8vIGl0ZW0gaW4gYW4gYXJyYXksIG9yIC0xIGlmIHRoZSBpdGVtIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgYXJyYXkuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGluZGV4T2ZgIGlmIGF2YWlsYWJsZS4KICAvLyBJZiB0aGUgYXJyYXkgaXMgbGFyZ2UgYW5kIGFscmVhZHkgaW4gc29ydCBvcmRlciwgcGFzcyBgdHJ1ZWAKICAvLyBmb3IgKippc1NvcnRlZCoqIHRvIHVzZSBiaW5hcnkgc2VhcmNoLgogIF8uaW5kZXhPZiA9IGZ1bmN0aW9uKGFycmF5LCBpdGVtLCBpc1NvcnRlZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiAtMTsKICAgIHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsKICAgIGlmIChpc1NvcnRlZCkgewogICAgICBpZiAodHlwZW9mIGlzU29ydGVkID09ICdudW1iZXInKSB7CiAgICAgICAgaSA9IChpc1NvcnRlZCA8IDAgPyBNYXRoLm1heCgwLCBsICsgaXNTb3J0ZWQpIDogaXNTb3J0ZWQpOwogICAgICB9IGVsc2UgewogICAgICAgIGkgPSBfLnNvcnRlZEluZGV4KGFycmF5LCBpdGVtKTsKICAgICAgICByZXR1cm4gYXJyYXlbaV0gPT09IGl0ZW0gPyBpIDogLTE7CiAgICAgIH0KICAgIH0KICAgIGlmIChuYXRpdmVJbmRleE9mICYmIGFycmF5LmluZGV4T2YgPT09IG5hdGl2ZUluZGV4T2YpIHJldHVybiBhcnJheS5pbmRleE9mKGl0ZW0sIGlzU29ydGVkKTsKICAgIGZvciAoOyBpIDwgbDsgaSsrKSBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pIHJldHVybiBpOwogICAgcmV0dXJuIC0xOwogIH07CgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBsYXN0SW5kZXhPZmAgaWYgYXZhaWxhYmxlLgogIF8ubGFzdEluZGV4T2YgPSBmdW5jdGlvbihhcnJheSwgaXRlbSwgZnJvbSkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiAtMTsKICAgIHZhciBoYXNJbmRleCA9IGZyb20gIT0gbnVsbDsKICAgIGlmIChuYXRpdmVMYXN0SW5kZXhPZiAmJiBhcnJheS5sYXN0SW5kZXhPZiA9PT0gbmF0aXZlTGFzdEluZGV4T2YpIHsKICAgICAgcmV0dXJuIGhhc0luZGV4ID8gYXJyYXkubGFzdEluZGV4T2YoaXRlbSwgZnJvbSkgOiBhcnJheS5sYXN0SW5kZXhPZihpdGVtKTsKICAgIH0KICAgIHZhciBpID0gKGhhc0luZGV4ID8gZnJvbSA6IGFycmF5Lmxlbmd0aCk7CiAgICB3aGlsZSAoaS0tKSBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pIHJldHVybiBpOwogICAgcmV0dXJuIC0xOwogIH07CgogIC8vIEdlbmVyYXRlIGFuIGludGVnZXIgQXJyYXkgY29udGFpbmluZyBhbiBhcml0aG1ldGljIHByb2dyZXNzaW9uLiBBIHBvcnQgb2YKICAvLyB0aGUgbmF0aXZlIFB5dGhvbiBgcmFuZ2UoKWAgZnVuY3Rpb24uIFNlZQogIC8vIFt0aGUgUHl0aG9uIGRvY3VtZW50YXRpb25dKGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvbGlicmFyeS9mdW5jdGlvbnMuaHRtbCNyYW5nZSkuCiAgXy5yYW5nZSA9IGZ1bmN0aW9uKHN0YXJ0LCBzdG9wLCBzdGVwKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8PSAxKSB7CiAgICAgIHN0b3AgPSBzdGFydCB8fCAwOwogICAgICBzdGFydCA9IDA7CiAgICB9CiAgICBzdGVwID0gYXJndW1lbnRzWzJdIHx8IDE7CgogICAgdmFyIGxlbiA9IE1hdGgubWF4KE1hdGguY2VpbCgoc3RvcCAtIHN0YXJ0KSAvIHN0ZXApLCAwKTsKICAgIHZhciBpZHggPSAwOwogICAgdmFyIHJhbmdlID0gbmV3IEFycmF5KGxlbik7CgogICAgd2hpbGUoaWR4IDwgbGVuKSB7CiAgICAgIHJhbmdlW2lkeCsrXSA9IHN0YXJ0OwogICAgICBzdGFydCArPSBzdGVwOwogICAgfQoKICAgIHJldHVybiByYW5nZTsKICB9OwoKICAvLyBGdW5jdGlvbiAoYWhlbSkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJldXNhYmxlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciBwcm90b3R5cGUgc2V0dGluZy4KICB2YXIgY3RvciA9IGZ1bmN0aW9uKCl7fTsKCiAgLy8gQ3JlYXRlIGEgZnVuY3Rpb24gYm91bmQgdG8gYSBnaXZlbiBvYmplY3QgKGFzc2lnbmluZyBgdGhpc2AsIGFuZCBhcmd1bWVudHMsCiAgLy8gb3B0aW9uYWxseSkuIEJpbmRpbmcgd2l0aCBhcmd1bWVudHMgaXMgYWxzbyBrbm93biBhcyBgY3VycnlgLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBGdW5jdGlvbi5iaW5kYCBpZiBhdmFpbGFibGUuCiAgLy8gV2UgY2hlY2sgZm9yIGBmdW5jLmJpbmRgIGZpcnN0LCB0byBmYWlsIGZhc3Qgd2hlbiBgZnVuY2AgaXMgdW5kZWZpbmVkLgogIF8uYmluZCA9IGZ1bmN0aW9uIGJpbmQoZnVuYywgY29udGV4dCkgewogICAgdmFyIGJvdW5kLCBhcmdzOwogICAgaWYgKGZ1bmMuYmluZCA9PT0gbmF0aXZlQmluZCAmJiBuYXRpdmVCaW5kKSByZXR1cm4gbmF0aXZlQmluZC5hcHBseShmdW5jLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgaWYgKCFfLmlzRnVuY3Rpb24oZnVuYykpIHRocm93IG5ldyBUeXBlRXJyb3I7CiAgICBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIGJvdW5kID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBib3VuZCkpIHJldHVybiBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICBjdG9yLnByb3RvdHlwZSA9IGZ1bmMucHJvdG90eXBlOwogICAgICB2YXIgc2VsZiA9IG5ldyBjdG9yOwogICAgICB2YXIgcmVzdWx0ID0gZnVuYy5hcHBseShzZWxmLCBhcmdzLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgICAgaWYgKE9iamVjdChyZXN1bHQpID09PSByZXN1bHQpIHJldHVybiByZXN1bHQ7CiAgICAgIHJldHVybiBzZWxmOwogICAgfTsKICB9OwoKICAvLyBCaW5kIGFsbCBvZiBhbiBvYmplY3QncyBtZXRob2RzIHRvIHRoYXQgb2JqZWN0LiBVc2VmdWwgZm9yIGVuc3VyaW5nIHRoYXQKICAvLyBhbGwgY2FsbGJhY2tzIGRlZmluZWQgb24gYW4gb2JqZWN0IGJlbG9uZyB0byBpdC4KICBfLmJpbmRBbGwgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBmdW5jcyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIGlmIChmdW5jcy5sZW5ndGggPT0gMCkgZnVuY3MgPSBfLmZ1bmN0aW9ucyhvYmopOwogICAgZWFjaChmdW5jcywgZnVuY3Rpb24oZikgeyBvYmpbZl0gPSBfLmJpbmQob2JqW2ZdLCBvYmopOyB9KTsKICAgIHJldHVybiBvYmo7CiAgfTsKCiAgLy8gTWVtb2l6ZSBhbiBleHBlbnNpdmUgZnVuY3Rpb24gYnkgc3RvcmluZyBpdHMgcmVzdWx0cy4KICBfLm1lbW9pemUgPSBmdW5jdGlvbihmdW5jLCBoYXNoZXIpIHsKICAgIHZhciBtZW1vID0ge307CiAgICBoYXNoZXIgfHwgKGhhc2hlciA9IF8uaWRlbnRpdHkpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIga2V5ID0gaGFzaGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiBfLmhhcyhtZW1vLCBrZXkpID8gbWVtb1trZXldIDogKG1lbW9ba2V5XSA9IGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9OwogIH07CgogIC8vIERlbGF5cyBhIGZ1bmN0aW9uIGZvciB0aGUgZ2l2ZW4gbnVtYmVyIG9mIG1pbGxpc2Vjb25kcywgYW5kIHRoZW4gY2FsbHMKICAvLyBpdCB3aXRoIHRoZSBhcmd1bWVudHMgc3VwcGxpZWQuCiAgXy5kZWxheSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsgcmV0dXJuIGZ1bmMuYXBwbHkobnVsbCwgYXJncyk7IH0sIHdhaXQpOwogIH07CgogIC8vIERlZmVycyBhIGZ1bmN0aW9uLCBzY2hlZHVsaW5nIGl0IHRvIHJ1biBhZnRlciB0aGUgY3VycmVudCBjYWxsIHN0YWNrIGhhcwogIC8vIGNsZWFyZWQuCiAgXy5kZWZlciA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAgIHJldHVybiBfLmRlbGF5LmFwcGx5KF8sIFtmdW5jLCAxXS5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKSk7CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0LCB3aGVuIGludm9rZWQsIHdpbGwgb25seSBiZSB0cmlnZ2VyZWQgYXQgbW9zdCBvbmNlCiAgLy8gZHVyaW5nIGEgZ2l2ZW4gd2luZG93IG9mIHRpbWUuCiAgXy50aHJvdHRsZSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQpIHsKICAgIHZhciBjb250ZXh0LCBhcmdzLCB0aW1lb3V0LCB0aHJvdHRsaW5nLCBtb3JlLCByZXN1bHQ7CiAgICB2YXIgd2hlbkRvbmUgPSBfLmRlYm91bmNlKGZ1bmN0aW9uKCl7IG1vcmUgPSB0aHJvdHRsaW5nID0gZmFsc2U7IH0sIHdhaXQpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBjb250ZXh0ID0gdGhpczsgYXJncyA9IGFyZ3VtZW50czsKICAgICAgdmFyIGxhdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgaWYgKG1vcmUpIHsKICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgfQogICAgICAgIHdoZW5Eb25lKCk7CiAgICAgIH07CiAgICAgIGlmICghdGltZW91dCkgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQpOwogICAgICBpZiAodGhyb3R0bGluZykgewogICAgICAgIG1vcmUgPSB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm90dGxpbmcgPSB0cnVlOwogICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgIH0KICAgICAgd2hlbkRvbmUoKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0LCBhcyBsb25nIGFzIGl0IGNvbnRpbnVlcyB0byBiZSBpbnZva2VkLCB3aWxsIG5vdAogIC8vIGJlIHRyaWdnZXJlZC4gVGhlIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIGFmdGVyIGl0IHN0b3BzIGJlaW5nIGNhbGxlZCBmb3IKICAvLyBOIG1pbGxpc2Vjb25kcy4gSWYgYGltbWVkaWF0ZWAgaXMgcGFzc2VkLCB0cmlnZ2VyIHRoZSBmdW5jdGlvbiBvbiB0aGUKICAvLyBsZWFkaW5nIGVkZ2UsIGluc3RlYWQgb2YgdGhlIHRyYWlsaW5nLgogIF8uZGVib3VuY2UgPSBmdW5jdGlvbihmdW5jLCB3YWl0LCBpbW1lZGlhdGUpIHsKICAgIHZhciB0aW1lb3V0LCByZXN1bHQ7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBjb250ZXh0ID0gdGhpcywgYXJncyA9IGFyZ3VtZW50czsKICAgICAgdmFyIGxhdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgaWYgKCFpbW1lZGlhdGUpIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgIH07CiAgICAgIHZhciBjYWxsTm93ID0gaW1tZWRpYXRlICYmICF0aW1lb3V0OwogICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CiAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCB3YWl0KTsKICAgICAgaWYgKGNhbGxOb3cpIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgZXhlY3V0ZWQgYXQgbW9zdCBvbmUgdGltZSwgbm8gbWF0dGVyIGhvdwogIC8vIG9mdGVuIHlvdSBjYWxsIGl0LiBVc2VmdWwgZm9yIGxhenkgaW5pdGlhbGl6YXRpb24uCiAgXy5vbmNlID0gZnVuY3Rpb24oZnVuYykgewogICAgdmFyIHJhbiA9IGZhbHNlLCBtZW1vOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBpZiAocmFuKSByZXR1cm4gbWVtbzsKICAgICAgcmFuID0gdHJ1ZTsKICAgICAgbWVtbyA9IGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgZnVuYyA9IG51bGw7CiAgICAgIHJldHVybiBtZW1vOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIHRoZSBmaXJzdCBmdW5jdGlvbiBwYXNzZWQgYXMgYW4gYXJndW1lbnQgdG8gdGhlIHNlY29uZCwKICAvLyBhbGxvd2luZyB5b3UgdG8gYWRqdXN0IGFyZ3VtZW50cywgcnVuIGNvZGUgYmVmb3JlIGFuZCBhZnRlciwgYW5kCiAgLy8gY29uZGl0aW9uYWxseSBleGVjdXRlIHRoZSBvcmlnaW5hbCBmdW5jdGlvbi4KICBfLndyYXAgPSBmdW5jdGlvbihmdW5jLCB3cmFwcGVyKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gW2Z1bmNdOwogICAgICBwdXNoLmFwcGx5KGFyZ3MsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiB3cmFwcGVyLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCBpcyB0aGUgY29tcG9zaXRpb24gb2YgYSBsaXN0IG9mIGZ1bmN0aW9ucywgZWFjaAogIC8vIGNvbnN1bWluZyB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBmdW5jdGlvbiB0aGF0IGZvbGxvd3MuCiAgXy5jb21wb3NlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgZnVuY3MgPSBhcmd1bWVudHM7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwogICAgICBmb3IgKHZhciBpID0gZnVuY3MubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICBhcmdzID0gW2Z1bmNzW2ldLmFwcGx5KHRoaXMsIGFyZ3MpXTsKICAgICAgfQogICAgICByZXR1cm4gYXJnc1swXTsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBvbmx5IGJlIGV4ZWN1dGVkIGFmdGVyIGJlaW5nIGNhbGxlZCBOIHRpbWVzLgogIF8uYWZ0ZXIgPSBmdW5jdGlvbih0aW1lcywgZnVuYykgewogICAgaWYgKHRpbWVzIDw9IDApIHJldHVybiBmdW5jKCk7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGlmICgtLXRpbWVzIDwgMSkgewogICAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH07CiAgfTsKCiAgLy8gT2JqZWN0IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gUmV0cmlldmUgdGhlIG5hbWVzIG9mIGFuIG9iamVjdCdzIHByb3BlcnRpZXMuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYE9iamVjdC5rZXlzYAogIF8ua2V5cyA9IG5hdGl2ZUtleXMgfHwgZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqICE9PSBPYmplY3Qob2JqKSkgdGhyb3cgbmV3IFR5cGVFcnJvcignSW52YWxpZCBvYmplY3QnKTsKICAgIHZhciBrZXlzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSBrZXlzW2tleXMubGVuZ3RoXSA9IGtleTsKICAgIHJldHVybiBrZXlzOwogIH07CgogIC8vIFJldHJpZXZlIHRoZSB2YWx1ZXMgb2YgYW4gb2JqZWN0J3MgcHJvcGVydGllcy4KICBfLnZhbHVlcyA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIHZhbHVlcyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgdmFsdWVzLnB1c2gob2JqW2tleV0pOwogICAgcmV0dXJuIHZhbHVlczsKICB9OwoKICAvLyBDb252ZXJ0IGFuIG9iamVjdCBpbnRvIGEgbGlzdCBvZiBgW2tleSwgdmFsdWVdYCBwYWlycy4KICBfLnBhaXJzID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgcGFpcnMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIHBhaXJzLnB1c2goW2tleSwgb2JqW2tleV1dKTsKICAgIHJldHVybiBwYWlyczsKICB9OwoKICAvLyBJbnZlcnQgdGhlIGtleXMgYW5kIHZhbHVlcyBvZiBhbiBvYmplY3QuIFRoZSB2YWx1ZXMgbXVzdCBiZSBzZXJpYWxpemFibGUuCiAgXy5pbnZlcnQgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIHJlc3VsdFtvYmpba2V5XV0gPSBrZXk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIFJldHVybiBhIHNvcnRlZCBsaXN0IG9mIHRoZSBmdW5jdGlvbiBuYW1lcyBhdmFpbGFibGUgb24gdGhlIG9iamVjdC4KICAvLyBBbGlhc2VkIGFzIGBtZXRob2RzYAogIF8uZnVuY3Rpb25zID0gXy5tZXRob2RzID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgbmFtZXMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihvYmpba2V5XSkpIG5hbWVzLnB1c2goa2V5KTsKICAgIH0KICAgIHJldHVybiBuYW1lcy5zb3J0KCk7CiAgfTsKCiAgLy8gRXh0ZW5kIGEgZ2l2ZW4gb2JqZWN0IHdpdGggYWxsIHRoZSBwcm9wZXJ0aWVzIGluIHBhc3NlZC1pbiBvYmplY3QocykuCiAgXy5leHRlbmQgPSBmdW5jdGlvbihvYmopIHsKICAgIGVhY2goc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLCBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICBvYmpbcHJvcF0gPSBzb3VyY2VbcHJvcF07CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBvYmplY3Qgb25seSBjb250YWluaW5nIHRoZSB3aGl0ZWxpc3RlZCBwcm9wZXJ0aWVzLgogIF8ucGljayA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGNvcHkgPSB7fTsKICAgIHZhciBrZXlzID0gY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBlYWNoKGtleXMsIGZ1bmN0aW9uKGtleSkgewogICAgICBpZiAoa2V5IGluIG9iaikgY29weVtrZXldID0gb2JqW2tleV07CiAgICB9KTsKICAgIHJldHVybiBjb3B5OwogIH07CgogICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBvYmplY3Qgd2l0aG91dCB0aGUgYmxhY2tsaXN0ZWQgcHJvcGVydGllcy4KICBfLm9taXQgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBjb3B5ID0ge307CiAgICB2YXIga2V5cyA9IGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAoIV8uY29udGFpbnMoa2V5cywga2V5KSkgY29weVtrZXldID0gb2JqW2tleV07CiAgICB9CiAgICByZXR1cm4gY29weTsKICB9OwoKICAvLyBGaWxsIGluIGEgZ2l2ZW4gb2JqZWN0IHdpdGggZGVmYXVsdCBwcm9wZXJ0aWVzLgogIF8uZGVmYXVsdHMgPSBmdW5jdGlvbihvYmopIHsKICAgIGVhY2goc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLCBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICBpZiAob2JqW3Byb3BdID09IG51bGwpIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIENyZWF0ZSBhIChzaGFsbG93LWNsb25lZCkgZHVwbGljYXRlIG9mIGFuIG9iamVjdC4KICBfLmNsb25lID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIV8uaXNPYmplY3Qob2JqKSkgcmV0dXJuIG9iajsKICAgIHJldHVybiBfLmlzQXJyYXkob2JqKSA/IG9iai5zbGljZSgpIDogXy5leHRlbmQoe30sIG9iaik7CiAgfTsKCiAgLy8gSW52b2tlcyBpbnRlcmNlcHRvciB3aXRoIHRoZSBvYmosIGFuZCB0aGVuIHJldHVybnMgb2JqLgogIC8vIFRoZSBwcmltYXJ5IHB1cnBvc2Ugb2YgdGhpcyBtZXRob2QgaXMgdG8gInRhcCBpbnRvIiBhIG1ldGhvZCBjaGFpbiwgaW4KICAvLyBvcmRlciB0byBwZXJmb3JtIG9wZXJhdGlvbnMgb24gaW50ZXJtZWRpYXRlIHJlc3VsdHMgd2l0aGluIHRoZSBjaGFpbi4KICBfLnRhcCA9IGZ1bmN0aW9uKG9iaiwgaW50ZXJjZXB0b3IpIHsKICAgIGludGVyY2VwdG9yKG9iaik7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIEludGVybmFsIHJlY3Vyc2l2ZSBjb21wYXJpc29uIGZ1bmN0aW9uIGZvciBgaXNFcXVhbGAuCiAgdmFyIGVxID0gZnVuY3Rpb24oYSwgYiwgYVN0YWNrLCBiU3RhY2spIHsKICAgIC8vIElkZW50aWNhbCBvYmplY3RzIGFyZSBlcXVhbC4gYDAgPT09IC0wYCwgYnV0IHRoZXkgYXJlbid0IGlkZW50aWNhbC4KICAgIC8vIFNlZSB0aGUgSGFybW9ueSBgZWdhbGAgcHJvcG9zYWw6IGh0dHA6Ly93aWtpLmVjbWFzY3JpcHQub3JnL2Rva3UucGhwP2lkPWhhcm1vbnk6ZWdhbC4KICAgIGlmIChhID09PSBiKSByZXR1cm4gYSAhPT0gMCB8fCAxIC8gYSA9PSAxIC8gYjsKICAgIC8vIEEgc3RyaWN0IGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5IGJlY2F1c2UgYG51bGwgPT0gdW5kZWZpbmVkYC4KICAgIGlmIChhID09IG51bGwgfHwgYiA9PSBudWxsKSByZXR1cm4gYSA9PT0gYjsKICAgIC8vIFVud3JhcCBhbnkgd3JhcHBlZCBvYmplY3RzLgogICAgaWYgKGEgaW5zdGFuY2VvZiBfKSBhID0gYS5fd3JhcHBlZDsKICAgIGlmIChiIGluc3RhbmNlb2YgXykgYiA9IGIuX3dyYXBwZWQ7CiAgICAvLyBDb21wYXJlIGBbW0NsYXNzXV1gIG5hbWVzLgogICAgdmFyIGNsYXNzTmFtZSA9IHRvU3RyaW5nLmNhbGwoYSk7CiAgICBpZiAoY2xhc3NOYW1lICE9IHRvU3RyaW5nLmNhbGwoYikpIHJldHVybiBmYWxzZTsKICAgIHN3aXRjaCAoY2xhc3NOYW1lKSB7CiAgICAgIC8vIFN0cmluZ3MsIG51bWJlcnMsIGRhdGVzLCBhbmQgYm9vbGVhbnMgYXJlIGNvbXBhcmVkIGJ5IHZhbHVlLgogICAgICBjYXNlICdbb2JqZWN0IFN0cmluZ10nOgogICAgICAgIC8vIFByaW1pdGl2ZXMgYW5kIHRoZWlyIGNvcnJlc3BvbmRpbmcgb2JqZWN0IHdyYXBwZXJzIGFyZSBlcXVpdmFsZW50OyB0aHVzLCBgIjUiYCBpcwogICAgICAgIC8vIGVxdWl2YWxlbnQgdG8gYG5ldyBTdHJpbmcoIjUiKWAuCiAgICAgICAgcmV0dXJuIGEgPT0gU3RyaW5nKGIpOwogICAgICBjYXNlICdbb2JqZWN0IE51bWJlcl0nOgogICAgICAgIC8vIGBOYU5gcyBhcmUgZXF1aXZhbGVudCwgYnV0IG5vbi1yZWZsZXhpdmUuIEFuIGBlZ2FsYCBjb21wYXJpc29uIGlzIHBlcmZvcm1lZCBmb3IKICAgICAgICAvLyBvdGhlciBudW1lcmljIHZhbHVlcy4KICAgICAgICByZXR1cm4gYSAhPSArYSA/IGIgIT0gK2IgOiAoYSA9PSAwID8gMSAvIGEgPT0gMSAvIGIgOiBhID09ICtiKTsKICAgICAgY2FzZSAnW29iamVjdCBEYXRlXSc6CiAgICAgIGNhc2UgJ1tvYmplY3QgQm9vbGVhbl0nOgogICAgICAgIC8vIENvZXJjZSBkYXRlcyBhbmQgYm9vbGVhbnMgdG8gbnVtZXJpYyBwcmltaXRpdmUgdmFsdWVzLiBEYXRlcyBhcmUgY29tcGFyZWQgYnkgdGhlaXIKICAgICAgICAvLyBtaWxsaXNlY29uZCByZXByZXNlbnRhdGlvbnMuIE5vdGUgdGhhdCBpbnZhbGlkIGRhdGVzIHdpdGggbWlsbGlzZWNvbmQgcmVwcmVzZW50YXRpb25zCiAgICAgICAgLy8gb2YgYE5hTmAgYXJlIG5vdCBlcXVpdmFsZW50LgogICAgICAgIHJldHVybiArYSA9PSArYjsKICAgICAgLy8gUmVnRXhwcyBhcmUgY29tcGFyZWQgYnkgdGhlaXIgc291cmNlIHBhdHRlcm5zIGFuZCBmbGFncy4KICAgICAgY2FzZSAnW29iamVjdCBSZWdFeHBdJzoKICAgICAgICByZXR1cm4gYS5zb3VyY2UgPT0gYi5zb3VyY2UgJiYKICAgICAgICAgICAgICAgYS5nbG9iYWwgPT0gYi5nbG9iYWwgJiYKICAgICAgICAgICAgICAgYS5tdWx0aWxpbmUgPT0gYi5tdWx0aWxpbmUgJiYKICAgICAgICAgICAgICAgYS5pZ25vcmVDYXNlID09IGIuaWdub3JlQ2FzZTsKICAgIH0KICAgIGlmICh0eXBlb2YgYSAhPSAnb2JqZWN0JyB8fCB0eXBlb2YgYiAhPSAnb2JqZWN0JykgcmV0dXJuIGZhbHNlOwogICAgLy8gQXNzdW1lIGVxdWFsaXR5IGZvciBjeWNsaWMgc3RydWN0dXJlcy4gVGhlIGFsZ29yaXRobSBmb3IgZGV0ZWN0aW5nIGN5Y2xpYwogICAgLy8gc3RydWN0dXJlcyBpcyBhZGFwdGVkIGZyb20gRVMgNS4xIHNlY3Rpb24gMTUuMTIuMywgYWJzdHJhY3Qgb3BlcmF0aW9uIGBKT2AuCiAgICB2YXIgbGVuZ3RoID0gYVN0YWNrLmxlbmd0aDsKICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAvLyBMaW5lYXIgc2VhcmNoLiBQZXJmb3JtYW5jZSBpcyBpbnZlcnNlbHkgcHJvcG9ydGlvbmFsIHRvIHRoZSBudW1iZXIgb2YKICAgICAgLy8gdW5pcXVlIG5lc3RlZCBzdHJ1Y3R1cmVzLgogICAgICBpZiAoYVN0YWNrW2xlbmd0aF0gPT0gYSkgcmV0dXJuIGJTdGFja1tsZW5ndGhdID09IGI7CiAgICB9CiAgICAvLyBBZGQgdGhlIGZpcnN0IG9iamVjdCB0byB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMuCiAgICBhU3RhY2sucHVzaChhKTsKICAgIGJTdGFjay5wdXNoKGIpOwogICAgdmFyIHNpemUgPSAwLCByZXN1bHQgPSB0cnVlOwogICAgLy8gUmVjdXJzaXZlbHkgY29tcGFyZSBvYmplY3RzIGFuZCBhcnJheXMuCiAgICBpZiAoY2xhc3NOYW1lID09ICdbb2JqZWN0IEFycmF5XScpIHsKICAgICAgLy8gQ29tcGFyZSBhcnJheSBsZW5ndGhzIHRvIGRldGVybWluZSBpZiBhIGRlZXAgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkuCiAgICAgIHNpemUgPSBhLmxlbmd0aDsKICAgICAgcmVzdWx0ID0gc2l6ZSA9PSBiLmxlbmd0aDsKICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIC8vIERlZXAgY29tcGFyZSB0aGUgY29udGVudHMsIGlnbm9yaW5nIG5vbi1udW1lcmljIHByb3BlcnRpZXMuCiAgICAgICAgd2hpbGUgKHNpemUtLSkgewogICAgICAgICAgaWYgKCEocmVzdWx0ID0gZXEoYVtzaXplXSwgYltzaXplXSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBPYmplY3RzIHdpdGggZGlmZmVyZW50IGNvbnN0cnVjdG9ycyBhcmUgbm90IGVxdWl2YWxlbnQsIGJ1dCBgT2JqZWN0YHMKICAgICAgLy8gZnJvbSBkaWZmZXJlbnQgZnJhbWVzIGFyZS4KICAgICAgdmFyIGFDdG9yID0gYS5jb25zdHJ1Y3RvciwgYkN0b3IgPSBiLmNvbnN0cnVjdG9yOwogICAgICBpZiAoYUN0b3IgIT09IGJDdG9yICYmICEoXy5pc0Z1bmN0aW9uKGFDdG9yKSAmJiAoYUN0b3IgaW5zdGFuY2VvZiBhQ3RvcikgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uaXNGdW5jdGlvbihiQ3RvcikgJiYgKGJDdG9yIGluc3RhbmNlb2YgYkN0b3IpKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICAvLyBEZWVwIGNvbXBhcmUgb2JqZWN0cy4KICAgICAgZm9yICh2YXIga2V5IGluIGEpIHsKICAgICAgICBpZiAoXy5oYXMoYSwga2V5KSkgewogICAgICAgICAgLy8gQ291bnQgdGhlIGV4cGVjdGVkIG51bWJlciBvZiBwcm9wZXJ0aWVzLgogICAgICAgICAgc2l6ZSsrOwogICAgICAgICAgLy8gRGVlcCBjb21wYXJlIGVhY2ggbWVtYmVyLgogICAgICAgICAgaWYgKCEocmVzdWx0ID0gXy5oYXMoYiwga2V5KSAmJiBlcShhW2tleV0sIGJba2V5XSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIEVuc3VyZSB0aGF0IGJvdGggb2JqZWN0cyBjb250YWluIHRoZSBzYW1lIG51bWJlciBvZiBwcm9wZXJ0aWVzLgogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgZm9yIChrZXkgaW4gYikgewogICAgICAgICAgaWYgKF8uaGFzKGIsIGtleSkgJiYgIShzaXplLS0pKSBicmVhazsKICAgICAgICB9CiAgICAgICAgcmVzdWx0ID0gIXNpemU7CiAgICAgIH0KICAgIH0KICAgIC8vIFJlbW92ZSB0aGUgZmlyc3Qgb2JqZWN0IGZyb20gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgogICAgYVN0YWNrLnBvcCgpOwogICAgYlN0YWNrLnBvcCgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBQZXJmb3JtIGEgZGVlcCBjb21wYXJpc29uIHRvIGNoZWNrIGlmIHR3byBvYmplY3RzIGFyZSBlcXVhbC4KICBfLmlzRXF1YWwgPSBmdW5jdGlvbihhLCBiKSB7CiAgICByZXR1cm4gZXEoYSwgYiwgW10sIFtdKTsKICB9OwoKICAvLyBJcyBhIGdpdmVuIGFycmF5LCBzdHJpbmcsIG9yIG9iamVjdCBlbXB0eT8KICAvLyBBbiAiZW1wdHkiIG9iamVjdCBoYXMgbm8gZW51bWVyYWJsZSBvd24tcHJvcGVydGllcy4KICBfLmlzRW1wdHkgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHRydWU7CiAgICBpZiAoXy5pc0FycmF5KG9iaikgfHwgXy5pc1N0cmluZyhvYmopKSByZXR1cm4gb2JqLmxlbmd0aCA9PT0gMDsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIHJldHVybiBmYWxzZTsKICAgIHJldHVybiB0cnVlOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBET00gZWxlbWVudD8KICBfLmlzRWxlbWVudCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuICEhKG9iaiAmJiBvYmoubm9kZVR5cGUgPT09IDEpOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYW4gYXJyYXk/CiAgLy8gRGVsZWdhdGVzIHRvIEVDTUE1J3MgbmF0aXZlIEFycmF5LmlzQXJyYXkKICBfLmlzQXJyYXkgPSBuYXRpdmVJc0FycmF5IHx8IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PSAnW29iamVjdCBBcnJheV0nOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFyaWFibGUgYW4gb2JqZWN0PwogIF8uaXNPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IE9iamVjdChvYmopOwogIH07CgogIC8vIEFkZCBzb21lIGlzVHlwZSBtZXRob2RzOiBpc0FyZ3VtZW50cywgaXNGdW5jdGlvbiwgaXNTdHJpbmcsIGlzTnVtYmVyLCBpc0RhdGUsIGlzUmVnRXhwLgogIGVhY2goWydBcmd1bWVudHMnLCAnRnVuY3Rpb24nLCAnU3RyaW5nJywgJ051bWJlcicsICdEYXRlJywgJ1JlZ0V4cCddLCBmdW5jdGlvbihuYW1lKSB7CiAgICBfWydpcycgKyBuYW1lXSA9IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0ICcgKyBuYW1lICsgJ10nOwogICAgfTsKICB9KTsKCiAgLy8gRGVmaW5lIGEgZmFsbGJhY2sgdmVyc2lvbiBvZiB0aGUgbWV0aG9kIGluIGJyb3dzZXJzIChhaGVtLCBJRSksIHdoZXJlCiAgLy8gdGhlcmUgaXNuJ3QgYW55IGluc3BlY3RhYmxlICJBcmd1bWVudHMiIHR5cGUuCiAgaWYgKCFfLmlzQXJndW1lbnRzKGFyZ3VtZW50cykpIHsKICAgIF8uaXNBcmd1bWVudHMgPSBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuICEhKG9iaiAmJiBfLmhhcyhvYmosICdjYWxsZWUnKSk7CiAgICB9OwogIH0KCiAgLy8gT3B0aW1pemUgYGlzRnVuY3Rpb25gIGlmIGFwcHJvcHJpYXRlLgogIGlmICh0eXBlb2YgKC8uLykgIT09ICdmdW5jdGlvbicpIHsKICAgIF8uaXNGdW5jdGlvbiA9IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gJ2Z1bmN0aW9uJzsKICAgIH07CiAgfQoKICAvLyBJcyBhIGdpdmVuIG9iamVjdCBhIGZpbml0ZSBudW1iZXI/CiAgXy5pc0Zpbml0ZSA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIF8uaXNOdW1iZXIob2JqKSAmJiBpc0Zpbml0ZShvYmopOwogIH07CgogIC8vIElzIHRoZSBnaXZlbiB2YWx1ZSBgTmFOYD8gKE5hTiBpcyB0aGUgb25seSBudW1iZXIgd2hpY2ggZG9lcyBub3QgZXF1YWwgaXRzZWxmKS4KICBfLmlzTmFOID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXy5pc051bWJlcihvYmopICYmIG9iaiAhPSArb2JqOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBib29sZWFuPwogIF8uaXNCb29sZWFuID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSB0cnVlIHx8IG9iaiA9PT0gZmFsc2UgfHwgdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0IEJvb2xlYW5dJzsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhbHVlIGVxdWFsIHRvIG51bGw/CiAgXy5pc051bGwgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IG51bGw7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YXJpYWJsZSB1bmRlZmluZWQ/CiAgXy5pc1VuZGVmaW5lZCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gdm9pZCAwOwogIH07CgogIC8vIFNob3J0Y3V0IGZ1bmN0aW9uIGZvciBjaGVja2luZyBpZiBhbiBvYmplY3QgaGFzIGEgZ2l2ZW4gcHJvcGVydHkgZGlyZWN0bHkKICAvLyBvbiBpdHNlbGYgKGluIG90aGVyIHdvcmRzLCBub3Qgb24gYSBwcm90b3R5cGUpLgogIF8uaGFzID0gZnVuY3Rpb24ob2JqLCBrZXkpIHsKICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KTsKICB9OwoKICAvLyBVdGlsaXR5IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJ1biBVbmRlcnNjb3JlLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBfYCB2YXJpYWJsZSB0byBpdHMKICAvLyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QuCiAgXy5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CiAgICByb290Ll8gPSBwcmV2aW91c1VuZGVyc2NvcmU7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBLZWVwIHRoZSBpZGVudGl0eSBmdW5jdGlvbiBhcm91bmQgZm9yIGRlZmF1bHQgaXRlcmF0b3JzLgogIF8uaWRlbnRpdHkgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlOwogIH07CgogIC8vIFJ1biBhIGZ1bmN0aW9uICoqbioqIHRpbWVzLgogIF8udGltZXMgPSBmdW5jdGlvbihuLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuOyBpKyspIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgaSk7CiAgfTsKCiAgLy8gUmV0dXJuIGEgcmFuZG9tIGludGVnZXIgYmV0d2VlbiBtaW4gYW5kIG1heCAoaW5jbHVzaXZlKS4KICBfLnJhbmRvbSA9IGZ1bmN0aW9uKG1pbiwgbWF4KSB7CiAgICBpZiAobWF4ID09IG51bGwpIHsKICAgICAgbWF4ID0gbWluOwogICAgICBtaW4gPSAwOwogICAgfQogICAgcmV0dXJuIG1pbiArICgwIHwgTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4gKyAxKSk7CiAgfTsKCiAgLy8gTGlzdCBvZiBIVE1MIGVudGl0aWVzIGZvciBlc2NhcGluZy4KICB2YXIgZW50aXR5TWFwID0gewogICAgZXNjYXBlOiB7CiAgICAgICcmJzogJyZhbXA7JywKICAgICAgJzwnOiAnJmx0OycsCiAgICAgICc+JzogJyZndDsnLAogICAgICAnIic6ICcmcXVvdDsnLAogICAgICAiJyI6ICcmI3gyNzsnLAogICAgICAnLyc6ICcmI3gyRjsnCiAgICB9CiAgfTsKICBlbnRpdHlNYXAudW5lc2NhcGUgPSBfLmludmVydChlbnRpdHlNYXAuZXNjYXBlKTsKCiAgLy8gUmVnZXhlcyBjb250YWluaW5nIHRoZSBrZXlzIGFuZCB2YWx1ZXMgbGlzdGVkIGltbWVkaWF0ZWx5IGFib3ZlLgogIHZhciBlbnRpdHlSZWdleGVzID0gewogICAgZXNjYXBlOiAgIG5ldyBSZWdFeHAoJ1snICsgXy5rZXlzKGVudGl0eU1hcC5lc2NhcGUpLmpvaW4oJycpICsgJ10nLCAnZycpLAogICAgdW5lc2NhcGU6IG5ldyBSZWdFeHAoJygnICsgXy5rZXlzKGVudGl0eU1hcC51bmVzY2FwZSkuam9pbignfCcpICsgJyknLCAnZycpCiAgfTsKCiAgLy8gRnVuY3Rpb25zIGZvciBlc2NhcGluZyBhbmQgdW5lc2NhcGluZyBzdHJpbmdzIHRvL2Zyb20gSFRNTCBpbnRlcnBvbGF0aW9uLgogIF8uZWFjaChbJ2VzY2FwZScsICd1bmVzY2FwZSddLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIF9bbWV0aG9kXSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgICBpZiAoc3RyaW5nID09IG51bGwpIHJldHVybiAnJzsKICAgICAgcmV0dXJuICgnJyArIHN0cmluZykucmVwbGFjZShlbnRpdHlSZWdleGVzW21ldGhvZF0sIGZ1bmN0aW9uKG1hdGNoKSB7CiAgICAgICAgcmV0dXJuIGVudGl0eU1hcFttZXRob2RdW21hdGNoXTsKICAgICAgfSk7CiAgICB9OwogIH0pOwoKICAvLyBJZiB0aGUgdmFsdWUgb2YgdGhlIG5hbWVkIHByb3BlcnR5IGlzIGEgZnVuY3Rpb24gdGhlbiBpbnZva2UgaXQ7CiAgLy8gb3RoZXJ3aXNlLCByZXR1cm4gaXQuCiAgXy5yZXN1bHQgPSBmdW5jdGlvbihvYmplY3QsIHByb3BlcnR5KSB7CiAgICBpZiAob2JqZWN0ID09IG51bGwpIHJldHVybiBudWxsOwogICAgdmFyIHZhbHVlID0gb2JqZWN0W3Byb3BlcnR5XTsKICAgIHJldHVybiBfLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUuY2FsbChvYmplY3QpIDogdmFsdWU7CiAgfTsKCiAgLy8gQWRkIHlvdXIgb3duIGN1c3RvbSBmdW5jdGlvbnMgdG8gdGhlIFVuZGVyc2NvcmUgb2JqZWN0LgogIF8ubWl4aW4gPSBmdW5jdGlvbihvYmopIHsKICAgIGVhY2goXy5mdW5jdGlvbnMob2JqKSwgZnVuY3Rpb24obmFtZSl7CiAgICAgIHZhciBmdW5jID0gX1tuYW1lXSA9IG9ialtuYW1lXTsKICAgICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYXJncyA9IFt0aGlzLl93cmFwcGVkXTsKICAgICAgICBwdXNoLmFwcGx5KGFyZ3MsIGFyZ3VtZW50cyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIGZ1bmMuYXBwbHkoXywgYXJncykpOwogICAgICB9OwogICAgfSk7CiAgfTsKCiAgLy8gR2VuZXJhdGUgYSB1bmlxdWUgaW50ZWdlciBpZCAodW5pcXVlIHdpdGhpbiB0aGUgZW50aXJlIGNsaWVudCBzZXNzaW9uKS4KICAvLyBVc2VmdWwgZm9yIHRlbXBvcmFyeSBET00gaWRzLgogIHZhciBpZENvdW50ZXIgPSAwOwogIF8udW5pcXVlSWQgPSBmdW5jdGlvbihwcmVmaXgpIHsKICAgIHZhciBpZCA9IGlkQ291bnRlcisrOwogICAgcmV0dXJuIHByZWZpeCA/IHByZWZpeCArIGlkIDogaWQ7CiAgfTsKCiAgLy8gQnkgZGVmYXVsdCwgVW5kZXJzY29yZSB1c2VzIEVSQi1zdHlsZSB0ZW1wbGF0ZSBkZWxpbWl0ZXJzLCBjaGFuZ2UgdGhlCiAgLy8gZm9sbG93aW5nIHRlbXBsYXRlIHNldHRpbmdzIHRvIHVzZSBhbHRlcm5hdGl2ZSBkZWxpbWl0ZXJzLgogIF8udGVtcGxhdGVTZXR0aW5ncyA9IHsKICAgIGV2YWx1YXRlICAgIDogLzwlKFtcc1xTXSs/KSU+L2csCiAgICBpbnRlcnBvbGF0ZSA6IC88JT0oW1xzXFNdKz8pJT4vZywKICAgIGVzY2FwZSAgICAgIDogLzwlLShbXHNcU10rPyklPi9nCiAgfTsKCiAgLy8gV2hlbiBjdXN0b21pemluZyBgdGVtcGxhdGVTZXR0aW5nc2AsIGlmIHlvdSBkb24ndCB3YW50IHRvIGRlZmluZSBhbgogIC8vIGludGVycG9sYXRpb24sIGV2YWx1YXRpb24gb3IgZXNjYXBpbmcgcmVnZXgsIHdlIG5lZWQgb25lIHRoYXQgaXMKICAvLyBndWFyYW50ZWVkIG5vdCB0byBtYXRjaC4KICB2YXIgbm9NYXRjaCA9IC8oLileLzsKCiAgLy8gQ2VydGFpbiBjaGFyYWN0ZXJzIG5lZWQgdG8gYmUgZXNjYXBlZCBzbyB0aGF0IHRoZXkgY2FuIGJlIHB1dCBpbnRvIGEKICAvLyBzdHJpbmcgbGl0ZXJhbC4KICB2YXIgZXNjYXBlcyA9IHsKICAgICInIjogICAgICAiJyIsCiAgICAnXFwnOiAgICAgJ1xcJywKICAgICdccic6ICAgICAncicsCiAgICAnXG4nOiAgICAgJ24nLAogICAgJ1x0JzogICAgICd0JywKICAgICdcdTIwMjgnOiAndTIwMjgnLAogICAgJ1x1MjAyOSc6ICd1MjAyOScKICB9OwoKICB2YXIgZXNjYXBlciA9IC9cXHwnfFxyfFxufFx0fFx1MjAyOHxcdTIwMjkvZzsKCiAgLy8gSmF2YVNjcmlwdCBtaWNyby10ZW1wbGF0aW5nLCBzaW1pbGFyIHRvIEpvaG4gUmVzaWcncyBpbXBsZW1lbnRhdGlvbi4KICAvLyBVbmRlcnNjb3JlIHRlbXBsYXRpbmcgaGFuZGxlcyBhcmJpdHJhcnkgZGVsaW1pdGVycywgcHJlc2VydmVzIHdoaXRlc3BhY2UsCiAgLy8gYW5kIGNvcnJlY3RseSBlc2NhcGVzIHF1b3RlcyB3aXRoaW4gaW50ZXJwb2xhdGVkIGNvZGUuCiAgXy50ZW1wbGF0ZSA9IGZ1bmN0aW9uKHRleHQsIGRhdGEsIHNldHRpbmdzKSB7CiAgICBzZXR0aW5ncyA9IF8uZGVmYXVsdHMoe30sIHNldHRpbmdzLCBfLnRlbXBsYXRlU2V0dGluZ3MpOwoKICAgIC8vIENvbWJpbmUgZGVsaW1pdGVycyBpbnRvIG9uZSByZWd1bGFyIGV4cHJlc3Npb24gdmlhIGFsdGVybmF0aW9uLgogICAgdmFyIG1hdGNoZXIgPSBuZXcgUmVnRXhwKFsKICAgICAgKHNldHRpbmdzLmVzY2FwZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5pbnRlcnBvbGF0ZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5ldmFsdWF0ZSB8fCBub01hdGNoKS5zb3VyY2UKICAgIF0uam9pbignfCcpICsgJ3wkJywgJ2cnKTsKCiAgICAvLyBDb21waWxlIHRoZSB0ZW1wbGF0ZSBzb3VyY2UsIGVzY2FwaW5nIHN0cmluZyBsaXRlcmFscyBhcHByb3ByaWF0ZWx5LgogICAgdmFyIGluZGV4ID0gMDsKICAgIHZhciBzb3VyY2UgPSAiX19wKz0nIjsKICAgIHRleHQucmVwbGFjZShtYXRjaGVyLCBmdW5jdGlvbihtYXRjaCwgZXNjYXBlLCBpbnRlcnBvbGF0ZSwgZXZhbHVhdGUsIG9mZnNldCkgewogICAgICBzb3VyY2UgKz0gdGV4dC5zbGljZShpbmRleCwgb2Zmc2V0KQogICAgICAgIC5yZXBsYWNlKGVzY2FwZXIsIGZ1bmN0aW9uKG1hdGNoKSB7IHJldHVybiAnXFwnICsgZXNjYXBlc1ttYXRjaF07IH0pOwogICAgICBzb3VyY2UgKz0KICAgICAgICBlc2NhcGUgPyAiJytcbigoX190PSgiICsgZXNjYXBlICsgIikpPT1udWxsPycnOl8uZXNjYXBlKF9fdCkpK1xuJyIgOgogICAgICAgIGludGVycG9sYXRlID8gIicrXG4oKF9fdD0oIiArIGludGVycG9sYXRlICsgIikpPT1udWxsPycnOl9fdCkrXG4nIiA6CiAgICAgICAgZXZhbHVhdGUgPyAiJztcbiIgKyBldmFsdWF0ZSArICJcbl9fcCs9JyIgOiAnJzsKICAgICAgaW5kZXggPSBvZmZzZXQgKyBtYXRjaC5sZW5ndGg7CiAgICB9KTsKICAgIHNvdXJjZSArPSAiJztcbiI7CgogICAgLy8gSWYgYSB2YXJpYWJsZSBpcyBub3Qgc3BlY2lmaWVkLCBwbGFjZSBkYXRhIHZhbHVlcyBpbiBsb2NhbCBzY29wZS4KICAgIGlmICghc2V0dGluZ3MudmFyaWFibGUpIHNvdXJjZSA9ICd3aXRoKG9ianx8e30pe1xuJyArIHNvdXJjZSArICd9XG4nOwoKICAgIHNvdXJjZSA9ICJ2YXIgX190LF9fcD0nJyxfX2o9QXJyYXkucHJvdG90eXBlLmpvaW4sIiArCiAgICAgICJwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9O1xuIiArCiAgICAgIHNvdXJjZSArICJyZXR1cm4gX19wO1xuIjsKCiAgICB0cnkgewogICAgICB2YXIgcmVuZGVyID0gbmV3IEZ1bmN0aW9uKHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonLCAnXycsIHNvdXJjZSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGUuc291cmNlID0gc291cmNlOwogICAgICB0aHJvdyBlOwogICAgfQoKICAgIGlmIChkYXRhKSByZXR1cm4gcmVuZGVyKGRhdGEsIF8pOwogICAgdmFyIHRlbXBsYXRlID0gZnVuY3Rpb24oZGF0YSkgewogICAgICByZXR1cm4gcmVuZGVyLmNhbGwodGhpcywgZGF0YSwgXyk7CiAgICB9OwoKICAgIC8vIFByb3ZpZGUgdGhlIGNvbXBpbGVkIGZ1bmN0aW9uIHNvdXJjZSBhcyBhIGNvbnZlbmllbmNlIGZvciBwcmVjb21waWxhdGlvbi4KICAgIHRlbXBsYXRlLnNvdXJjZSA9ICdmdW5jdGlvbignICsgKHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonKSArICcpe1xuJyArIHNvdXJjZSArICd9JzsKCiAgICByZXR1cm4gdGVtcGxhdGU7CiAgfTsKCiAgLy8gQWRkIGEgImNoYWluIiBmdW5jdGlvbiwgd2hpY2ggd2lsbCBkZWxlZ2F0ZSB0byB0aGUgd3JhcHBlci4KICBfLmNoYWluID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXyhvYmopLmNoYWluKCk7CiAgfTsKCiAgLy8gT09QCiAgLy8gLS0tLS0tLS0tLS0tLS0tCiAgLy8gSWYgVW5kZXJzY29yZSBpcyBjYWxsZWQgYXMgYSBmdW5jdGlvbiwgaXQgcmV0dXJucyBhIHdyYXBwZWQgb2JqZWN0IHRoYXQKICAvLyBjYW4gYmUgdXNlZCBPTy1zdHlsZS4gVGhpcyB3cmFwcGVyIGhvbGRzIGFsdGVyZWQgdmVyc2lvbnMgb2YgYWxsIHRoZQogIC8vIHVuZGVyc2NvcmUgZnVuY3Rpb25zLiBXcmFwcGVkIG9iamVjdHMgbWF5IGJlIGNoYWluZWQuCgogIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb250aW51ZSBjaGFpbmluZyBpbnRlcm1lZGlhdGUgcmVzdWx0cy4KICB2YXIgcmVzdWx0ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gdGhpcy5fY2hhaW4gPyBfKG9iaikuY2hhaW4oKSA6IG9iajsKICB9OwoKICAvLyBBZGQgYWxsIG9mIHRoZSBVbmRlcnNjb3JlIGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlciBvYmplY3QuCiAgXy5taXhpbihfKTsKCiAgLy8gQWRkIGFsbCBtdXRhdG9yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KICBlYWNoKFsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0J10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIHZhciBtZXRob2QgPSBBcnJheVByb3RvW25hbWVdOwogICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIG9iaiA9IHRoaXMuX3dyYXBwZWQ7CiAgICAgIG1ldGhvZC5hcHBseShvYmosIGFyZ3VtZW50cyk7CiAgICAgIGlmICgobmFtZSA9PSAnc2hpZnQnIHx8IG5hbWUgPT0gJ3NwbGljZScpICYmIG9iai5sZW5ndGggPT09IDApIGRlbGV0ZSBvYmpbMF07CiAgICAgIHJldHVybiByZXN1bHQuY2FsbCh0aGlzLCBvYmopOwogICAgfTsKICB9KTsKCiAgLy8gQWRkIGFsbCBhY2Nlc3NvciBBcnJheSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIuCiAgZWFjaChbJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIHZhciBtZXRob2QgPSBBcnJheVByb3RvW25hbWVdOwogICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIG1ldGhvZC5hcHBseSh0aGlzLl93cmFwcGVkLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfSk7CgogIF8uZXh0ZW5kKF8ucHJvdG90eXBlLCB7CgogICAgLy8gU3RhcnQgY2hhaW5pbmcgYSB3cmFwcGVkIFVuZGVyc2NvcmUgb2JqZWN0LgogICAgY2hhaW46IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLl9jaGFpbiA9IHRydWU7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBFeHRyYWN0cyB0aGUgcmVzdWx0IGZyb20gYSB3cmFwcGVkIGFuZCBjaGFpbmVkIG9iamVjdC4KICAgIHZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuX3dyYXBwZWQ7CiAgICB9CgogIH0pOwoKfSkuY2FsbCh0aGlzKTsKCi8vICAgICBCYWNrYm9uZS5qcyAwLjkuOQoKLy8gICAgIChjKSAyMDEwLTIwMTIgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIEluYy4KLy8gICAgIEJhY2tib25lIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgovLyAgICAgRm9yIGFsbCBkZXRhaWxzIGFuZCBkb2N1bWVudGF0aW9uOgovLyAgICAgaHR0cDovL2JhY2tib25lanMub3JnCgooZnVuY3Rpb24oKXsKCiAgLy8gSW5pdGlhbCBTZXR1cAogIC8vIC0tLS0tLS0tLS0tLS0KCiAgLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgZ2xvYmFsIG9iamVjdCAoYHdpbmRvd2AgaW4gdGhlIGJyb3dzZXIsIGBleHBvcnRzYAogIC8vIG9uIHRoZSBzZXJ2ZXIpLgogIHZhciByb290ID0gdGhpczsKCiAgLy8gU2F2ZSB0aGUgcHJldmlvdXMgdmFsdWUgb2YgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUsIHNvIHRoYXQgaXQgY2FuIGJlCiAgLy8gcmVzdG9yZWQgbGF0ZXIgb24sIGlmIGBub0NvbmZsaWN0YCBpcyB1c2VkLgogIHZhciBwcmV2aW91c0JhY2tib25lID0gcm9vdC5CYWNrYm9uZTsKCiAgLy8gQ3JlYXRlIGEgbG9jYWwgcmVmZXJlbmNlIHRvIGFycmF5IG1ldGhvZHMuCiAgdmFyIGFycmF5ID0gW107CiAgdmFyIHB1c2ggPSBhcnJheS5wdXNoOwogIHZhciBzbGljZSA9IGFycmF5LnNsaWNlOwogIHZhciBzcGxpY2UgPSBhcnJheS5zcGxpY2U7CgogIC8vIFRoZSB0b3AtbGV2ZWwgbmFtZXNwYWNlLiBBbGwgcHVibGljIEJhY2tib25lIGNsYXNzZXMgYW5kIG1vZHVsZXMgd2lsbAogIC8vIGJlIGF0dGFjaGVkIHRvIHRoaXMuIEV4cG9ydGVkIGZvciBib3RoIENvbW1vbkpTIGFuZCB0aGUgYnJvd3Nlci4KICB2YXIgQmFja2JvbmU7CiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgQmFja2JvbmUgPSBleHBvcnRzOwogIH0gZWxzZSB7CiAgICBCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmUgPSB7fTsKICB9CgogIC8vIEN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgbGlicmFyeS4gS2VlcCBpbiBzeW5jIHdpdGggYHBhY2thZ2UuanNvbmAuCiAgQmFja2JvbmUuVkVSU0lPTiA9ICcwLjkuOSc7CgogIC8vIFJlcXVpcmUgVW5kZXJzY29yZSwgaWYgd2UncmUgb24gdGhlIHNlcnZlciwgYW5kIGl0J3Mgbm90IGFscmVhZHkgcHJlc2VudC4KICB2YXIgXyA9IHJvb3QuXzsKICBpZiAoIV8gJiYgKHR5cGVvZiByZXF1aXJlICE9PSAndW5kZWZpbmVkJykpIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyk7CgogIC8vIEZvciBCYWNrYm9uZSdzIHB1cnBvc2VzLCBqUXVlcnksIFplcHRvLCBvciBFbmRlciBvd25zIHRoZSBgJGAgdmFyaWFibGUuCiAgQmFja2JvbmUuJCA9IHJvb3QualF1ZXJ5IHx8IHJvb3QuWmVwdG8gfHwgcm9vdC5lbmRlcjsKCiAgLy8gUnVucyBCYWNrYm9uZS5qcyBpbiAqbm9Db25mbGljdCogbW9kZSwgcmV0dXJuaW5nIHRoZSBgQmFja2JvbmVgIHZhcmlhYmxlCiAgLy8gdG8gaXRzIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoaXMgQmFja2JvbmUgb2JqZWN0LgogIEJhY2tib25lLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICAgIHJvb3QuQmFja2JvbmUgPSBwcmV2aW91c0JhY2tib25lOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLy8gVHVybiBvbiBgZW11bGF0ZUhUVFBgIHRvIHN1cHBvcnQgbGVnYWN5IEhUVFAgc2VydmVycy4gU2V0dGluZyB0aGlzIG9wdGlvbgogIC8vIHdpbGwgZmFrZSBgIlBVVCJgIGFuZCBgIkRFTEVURSJgIHJlcXVlc3RzIHZpYSB0aGUgYF9tZXRob2RgIHBhcmFtZXRlciBhbmQKICAvLyBzZXQgYSBgWC1IdHRwLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgogIEJhY2tib25lLmVtdWxhdGVIVFRQID0gZmFsc2U7CgogIC8vIFR1cm4gb24gYGVtdWxhdGVKU09OYCB0byBzdXBwb3J0IGxlZ2FjeSBzZXJ2ZXJzIHRoYXQgY2FuJ3QgZGVhbCB3aXRoIGRpcmVjdAogIC8vIGBhcHBsaWNhdGlvbi9qc29uYCByZXF1ZXN0cyAuLi4gd2lsbCBlbmNvZGUgdGhlIGJvZHkgYXMKICAvLyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYCBpbnN0ZWFkIGFuZCB3aWxsIHNlbmQgdGhlIG1vZGVsIGluIGEKICAvLyBmb3JtIHBhcmFtIG5hbWVkIGBtb2RlbGAuCiAgQmFja2JvbmUuZW11bGF0ZUpTT04gPSBmYWxzZTsKCiAgLy8gQmFja2JvbmUuRXZlbnRzCiAgLy8gLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJlZ3VsYXIgZXhwcmVzc2lvbiB1c2VkIHRvIHNwbGl0IGV2ZW50IHN0cmluZ3MuCiAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLzsKCiAgLy8gSW1wbGVtZW50IGZhbmN5IGZlYXR1cmVzIG9mIHRoZSBFdmVudHMgQVBJIHN1Y2ggYXMgbXVsdGlwbGUgZXZlbnQKICAvLyBuYW1lcyBgImNoYW5nZSBibHVyImAgYW5kIGpRdWVyeS1zdHlsZSBldmVudCBtYXBzIGB7Y2hhbmdlOiBhY3Rpb259YAogIC8vIGluIHRlcm1zIG9mIHRoZSBleGlzdGluZyBBUEkuCiAgdmFyIGV2ZW50c0FwaSA9IGZ1bmN0aW9uKG9iaiwgYWN0aW9uLCBuYW1lLCByZXN0KSB7CiAgICBpZiAoIW5hbWUpIHJldHVybiB0cnVlOwogICAgaWYgKHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgewogICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZSkgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW2tleSwgbmFtZVtrZXldXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGV2ZW50U3BsaXR0ZXIudGVzdChuYW1lKSkgewogICAgICB2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW25hbWVzW2ldXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9OwoKICAvLyBPcHRpbWl6ZWQgaW50ZXJuYWwgZGlzcGF0Y2ggZnVuY3Rpb24gZm9yIHRyaWdnZXJpbmcgZXZlbnRzLiBUcmllcyB0bwogIC8vIGtlZXAgdGhlIHVzdWFsIGNhc2VzIHNwZWVkeSAobW9zdCBCYWNrYm9uZSBldmVudHMgaGF2ZSAzIGFyZ3VtZW50cykuCiAgdmFyIHRyaWdnZXJFdmVudHMgPSBmdW5jdGlvbihvYmosIGV2ZW50cywgYXJncykgewogICAgdmFyIGV2LCBpID0gLTEsIGwgPSBldmVudHMubGVuZ3RoOwogICAgc3dpdGNoIChhcmdzLmxlbmd0aCkgewogICAgY2FzZSAwOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCk7CiAgICByZXR1cm47CiAgICBjYXNlIDE6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhcmdzWzBdKTsKICAgIHJldHVybjsKICAgIGNhc2UgMjogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGFyZ3NbMF0sIGFyZ3NbMV0pOwogICAgcmV0dXJuOwogICAgY2FzZSAzOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSk7CiAgICByZXR1cm47CiAgICBkZWZhdWx0OiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5hcHBseShldi5jdHgsIGFyZ3MpOwogICAgfQogIH07CgogIC8vIEEgbW9kdWxlIHRoYXQgY2FuIGJlIG1peGVkIGluIHRvICphbnkgb2JqZWN0KiBpbiBvcmRlciB0byBwcm92aWRlIGl0IHdpdGgKICAvLyBjdXN0b20gZXZlbnRzLiBZb3UgbWF5IGJpbmQgd2l0aCBgb25gIG9yIHJlbW92ZSB3aXRoIGBvZmZgIGNhbGxiYWNrCiAgLy8gZnVuY3Rpb25zIHRvIGFuIGV2ZW50OyBgdHJpZ2dlcmAtaW5nIGFuIGV2ZW50IGZpcmVzIGFsbCBjYWxsYmFja3MgaW4KICAvLyBzdWNjZXNzaW9uLgogIC8vCiAgLy8gICAgIHZhciBvYmplY3QgPSB7fTsKICAvLyAgICAgXy5leHRlbmQob2JqZWN0LCBCYWNrYm9uZS5FdmVudHMpOwogIC8vICAgICBvYmplY3Qub24oJ2V4cGFuZCcsIGZ1bmN0aW9uKCl7IGFsZXJ0KCdleHBhbmRlZCcpOyB9KTsKICAvLyAgICAgb2JqZWN0LnRyaWdnZXIoJ2V4cGFuZCcpOwogIC8vCiAgdmFyIEV2ZW50cyA9IEJhY2tib25lLkV2ZW50cyA9IHsKCiAgICAvLyBCaW5kIG9uZSBvciBtb3JlIHNwYWNlIHNlcGFyYXRlZCBldmVudHMsIG9yIGFuIGV2ZW50cyBtYXAsCiAgICAvLyB0byBhIGBjYWxsYmFja2AgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQgdGhlIGNhbGxiYWNrIHRvCiAgICAvLyBhbGwgZXZlbnRzIGZpcmVkLgogICAgb246IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghKGV2ZW50c0FwaSh0aGlzLCAnb24nLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSAmJiBjYWxsYmFjaykpIHJldHVybiB0aGlzOwogICAgICB0aGlzLl9ldmVudHMgfHwgKHRoaXMuX2V2ZW50cyA9IHt9KTsKICAgICAgdmFyIGxpc3QgPSB0aGlzLl9ldmVudHNbbmFtZV0gfHwgKHRoaXMuX2V2ZW50c1tuYW1lXSA9IFtdKTsKICAgICAgbGlzdC5wdXNoKHtjYWxsYmFjazogY2FsbGJhY2ssIGNvbnRleHQ6IGNvbnRleHQsIGN0eDogY29udGV4dCB8fCB0aGlzfSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBCaW5kIGV2ZW50cyB0byBvbmx5IGJlIHRyaWdnZXJlZCBhIHNpbmdsZSB0aW1lLiBBZnRlciB0aGUgZmlyc3QgdGltZQogICAgLy8gdGhlIGNhbGxiYWNrIGlzIGludm9rZWQsIGl0IHdpbGwgYmUgcmVtb3ZlZC4KICAgIG9uY2U6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghKGV2ZW50c0FwaSh0aGlzLCAnb25jZScsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pICYmIGNhbGxiYWNrKSkgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIG9uY2UgPSBfLm9uY2UoZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5vZmYobmFtZSwgb25jZSk7CiAgICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSk7CiAgICAgIG9uY2UuX2NhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgIHRoaXMub24obmFtZSwgb25jZSwgY29udGV4dCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBSZW1vdmUgb25lIG9yIG1hbnkgY2FsbGJhY2tzLiBJZiBgY29udGV4dGAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKICAgIC8vIGNhbGxiYWNrcyB3aXRoIHRoYXQgZnVuY3Rpb24uIElmIGBjYWxsYmFja2AgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKICAgIC8vIGNhbGxiYWNrcyBmb3IgdGhlIGV2ZW50LiBJZiBgZXZlbnRzYCBpcyBudWxsLCByZW1vdmVzIGFsbCBib3VuZAogICAgLy8gY2FsbGJhY2tzIGZvciBhbGwgZXZlbnRzLgogICAgb2ZmOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICB2YXIgbGlzdCwgZXYsIGV2ZW50cywgbmFtZXMsIGksIGwsIGosIGs7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzIHx8ICFldmVudHNBcGkodGhpcywgJ29mZicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCFuYW1lICYmICFjYWxsYmFjayAmJiAhY29udGV4dCkgewogICAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CgogICAgICBuYW1lcyA9IG5hbWUgPyBbbmFtZV0gOiBfLmtleXModGhpcy5fZXZlbnRzKTsKICAgICAgZm9yIChpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG5hbWUgPSBuYW1lc1tpXTsKICAgICAgICBpZiAobGlzdCA9IHRoaXMuX2V2ZW50c1tuYW1lXSkgewogICAgICAgICAgZXZlbnRzID0gW107CiAgICAgICAgICBpZiAoY2FsbGJhY2sgfHwgY29udGV4dCkgewogICAgICAgICAgICBmb3IgKGogPSAwLCBrID0gbGlzdC5sZW5ndGg7IGogPCBrOyBqKyspIHsKICAgICAgICAgICAgICBldiA9IGxpc3Rbal07CiAgICAgICAgICAgICAgaWYgKChjYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gKGV2LmNhbGxiYWNrLl9jYWxsYmFjayB8fCBldi5jYWxsYmFjaykpIHx8CiAgICAgICAgICAgICAgICAgIChjb250ZXh0ICYmIGNvbnRleHQgIT09IGV2LmNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICBldmVudHMucHVzaChldik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9ldmVudHNbbmFtZV0gPSBldmVudHM7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAvLyBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQogICAgLy8gKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgLy8gcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgdHJpZ2dlcjogZnVuY3Rpb24obmFtZSkgewogICAgICBpZiAoIXRoaXMuX2V2ZW50cykgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAndHJpZ2dlcicsIG5hbWUsIGFyZ3MpKSByZXR1cm4gdGhpczsKICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgdmFyIGFsbEV2ZW50cyA9IHRoaXMuX2V2ZW50cy5hbGw7CiAgICAgIGlmIChldmVudHMpIHRyaWdnZXJFdmVudHModGhpcywgZXZlbnRzLCBhcmdzKTsKICAgICAgaWYgKGFsbEV2ZW50cykgdHJpZ2dlckV2ZW50cyh0aGlzLCBhbGxFdmVudHMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBBbiBpbnZlcnNpb24tb2YtY29udHJvbCB2ZXJzaW9uIG9mIGBvbmAuIFRlbGwgKnRoaXMqIG9iamVjdCB0byBsaXN0ZW4gdG8KICAgIC8vIGFuIGV2ZW50IGluIGFub3RoZXIgb2JqZWN0IC4uLiBrZWVwaW5nIHRyYWNrIG9mIHdoYXQgaXQncyBsaXN0ZW5pbmcgdG8uCiAgICBsaXN0ZW5UbzogZnVuY3Rpb24ob2JqZWN0LCBldmVudHMsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnMgfHwgKHRoaXMuX2xpc3RlbmVycyA9IHt9KTsKICAgICAgdmFyIGlkID0gb2JqZWN0Ll9saXN0ZW5lcklkIHx8IChvYmplY3QuX2xpc3RlbmVySWQgPSBfLnVuaXF1ZUlkKCdsJykpOwogICAgICBsaXN0ZW5lcnNbaWRdID0gb2JqZWN0OwogICAgICBvYmplY3Qub24oZXZlbnRzLCBjYWxsYmFjayB8fCB0aGlzLCB0aGlzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFRlbGwgdGhpcyBvYmplY3QgdG8gc3RvcCBsaXN0ZW5pbmcgdG8gZWl0aGVyIHNwZWNpZmljIGV2ZW50cyAuLi4gb3IKICAgIC8vIHRvIGV2ZXJ5IG9iamVjdCBpdCdzIGN1cnJlbnRseSBsaXN0ZW5pbmcgdG8uCiAgICBzdG9wTGlzdGVuaW5nOiBmdW5jdGlvbihvYmplY3QsIGV2ZW50cywgY2FsbGJhY2spIHsKICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVyczsKICAgICAgaWYgKCFsaXN0ZW5lcnMpIHJldHVybjsKICAgICAgaWYgKG9iamVjdCkgewogICAgICAgIG9iamVjdC5vZmYoZXZlbnRzLCBjYWxsYmFjaywgdGhpcyk7CiAgICAgICAgaWYgKCFldmVudHMgJiYgIWNhbGxiYWNrKSBkZWxldGUgbGlzdGVuZXJzW29iamVjdC5fbGlzdGVuZXJJZF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yICh2YXIgaWQgaW4gbGlzdGVuZXJzKSB7CiAgICAgICAgICBsaXN0ZW5lcnNbaWRdLm9mZihudWxsLCBudWxsLCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fbGlzdGVuZXJzID0ge307CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgfTsKCiAgLy8gQWxpYXNlcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCiAgRXZlbnRzLmJpbmQgICA9IEV2ZW50cy5vbjsKICBFdmVudHMudW5iaW5kID0gRXZlbnRzLm9mZjsKCiAgLy8gQWxsb3cgdGhlIGBCYWNrYm9uZWAgb2JqZWN0IHRvIHNlcnZlIGFzIGEgZ2xvYmFsIGV2ZW50IGJ1cywgZm9yIGZvbGtzIHdobwogIC8vIHdhbnQgZ2xvYmFsICJwdWJzdWIiIGluIGEgY29udmVuaWVudCBwbGFjZS4KICBfLmV4dGVuZChCYWNrYm9uZSwgRXZlbnRzKTsKCiAgLy8gQmFja2JvbmUuTW9kZWwKICAvLyAtLS0tLS0tLS0tLS0tLQoKICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwsIHdpdGggZGVmaW5lZCBhdHRyaWJ1dGVzLiBBIGNsaWVudCBpZCAoYGNpZGApCiAgLy8gaXMgYXV0b21hdGljYWxseSBnZW5lcmF0ZWQgYW5kIGFzc2lnbmVkIGZvciB5b3UuCiAgdmFyIE1vZGVsID0gQmFja2JvbmUuTW9kZWwgPSBmdW5jdGlvbihhdHRyaWJ1dGVzLCBvcHRpb25zKSB7CiAgICB2YXIgZGVmYXVsdHM7CiAgICB2YXIgYXR0cnMgPSBhdHRyaWJ1dGVzIHx8IHt9OwogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjJyk7CiAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwogICAgdGhpcy5fY2hhbmdlcyA9IFtdOwogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5jb2xsZWN0aW9uKSB0aGlzLmNvbGxlY3Rpb24gPSBvcHRpb25zLmNvbGxlY3Rpb247CiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnBhcnNlKSBhdHRycyA9IHRoaXMucGFyc2UoYXR0cnMpOwogICAgaWYgKGRlZmF1bHRzID0gXy5yZXN1bHQodGhpcywgJ2RlZmF1bHRzJykpIF8uZGVmYXVsdHMoYXR0cnMsIGRlZmF1bHRzKTsKICAgIHRoaXMuc2V0KGF0dHJzLCB7c2lsZW50OiB0cnVlfSk7CiAgICB0aGlzLl9jdXJyZW50QXR0cmlidXRlcyA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CgogIC8vIEF0dGFjaCBhbGwgaW5oZXJpdGFibGUgbWV0aG9kcyB0byB0aGUgTW9kZWwgcHJvdG90eXBlLgogIF8uZXh0ZW5kKE1vZGVsLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gQSBoYXNoIG9mIGF0dHJpYnV0ZXMgd2hvc2UgY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWUgZGlmZmVyLgogICAgY2hhbmdlZDogbnVsbCwKCiAgICAvLyBUaGUgZGVmYXVsdCBuYW1lIGZvciB0aGUgSlNPTiBgaWRgIGF0dHJpYnV0ZSBpcyBgImlkImAuIE1vbmdvREIgYW5kCiAgICAvLyBDb3VjaERCIHVzZXJzIG1heSB3YW50IHRvIHNldCB0aGlzIHRvIGAiX2lkImAuCiAgICBpZEF0dHJpYnV0ZTogJ2lkJywKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG1vZGVsJ3MgYGF0dHJpYnV0ZXNgIG9iamVjdC4KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGdldDogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIEhUTUwtZXNjYXBlZCB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCiAgICBlc2NhcGU6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uZXNjYXBlKHRoaXMuZ2V0KGF0dHIpKTsKICAgIH0sCgogICAgLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF0dHJpYnV0ZSBjb250YWlucyBhIHZhbHVlIHRoYXQgaXMgbm90IG51bGwKICAgIC8vIG9yIHVuZGVmaW5lZC4KICAgIGhhczogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5nZXQoYXR0cikgIT0gbnVsbDsKICAgIH0sCgogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzIG9uIHRoZSBvYmplY3QsIGZpcmluZyBgImNoYW5nZSJgIHVubGVzcwogICAgLy8geW91IGNob29zZSB0byBzaWxlbmNlIGl0LgogICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgb3B0aW9ucykgewogICAgICB2YXIgYXR0ciwgYXR0cnM7CiAgICAgIGlmIChrZXkgPT0gbnVsbCkgcmV0dXJuIHRoaXM7CgogICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KICAgICAgaWYgKF8uaXNPYmplY3Qoa2V5KSkgewogICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgIH0KCiAgICAgIC8vIEV4dHJhY3QgYXR0cmlidXRlcyBhbmQgb3B0aW9ucy4KICAgICAgdmFyIHNpbGVudCA9IG9wdGlvbnMgJiYgb3B0aW9ucy5zaWxlbnQ7CiAgICAgIHZhciB1bnNldCA9IG9wdGlvbnMgJiYgb3B0aW9ucy51bnNldDsKCiAgICAgIC8vIFJ1biB2YWxpZGF0aW9uLgogICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwoKICAgICAgLy8gQ2hlY2sgZm9yIGNoYW5nZXMgb2YgYGlkYC4KICAgICAgaWYgKHRoaXMuaWRBdHRyaWJ1dGUgaW4gYXR0cnMpIHRoaXMuaWQgPSBhdHRyc1t0aGlzLmlkQXR0cmlidXRlXTsKCiAgICAgIHZhciBub3cgPSB0aGlzLmF0dHJpYnV0ZXM7CgogICAgICAvLyBGb3IgZWFjaCBgc2V0YCBhdHRyaWJ1dGUuLi4KICAgICAgZm9yIChhdHRyIGluIGF0dHJzKSB7CiAgICAgICAgdmFsID0gYXR0cnNbYXR0cl07CgogICAgICAgIC8vIFVwZGF0ZSBvciBkZWxldGUgdGhlIGN1cnJlbnQgdmFsdWUsIGFuZCB0cmFjayB0aGUgY2hhbmdlLgogICAgICAgIHVuc2V0ID8gZGVsZXRlIG5vd1thdHRyXSA6IG5vd1thdHRyXSA9IHZhbDsKICAgICAgICB0aGlzLl9jaGFuZ2VzLnB1c2goYXR0ciwgdmFsKTsKICAgICAgfQoKICAgICAgLy8gU2lnbmFsIHRoYXQgdGhlIG1vZGVsJ3Mgc3RhdGUgaGFzIHBvdGVudGlhbGx5IGNoYW5nZWQsIGFuZCB3ZSBuZWVkCiAgICAgIC8vIHRvIHJlY29tcHV0ZSB0aGUgYWN0dWFsIGNoYW5nZXMuCiAgICAgIHRoaXMuX2hhc0NvbXB1dGVkID0gZmFsc2U7CgogICAgICAvLyBGaXJlIHRoZSBgImNoYW5nZSJgIGV2ZW50cy4KICAgICAgaWYgKCFzaWxlbnQpIHRoaXMuY2hhbmdlKG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUmVtb3ZlIGFuIGF0dHJpYnV0ZSBmcm9tIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAgdW5sZXNzIHlvdSBjaG9vc2UKICAgIC8vIHRvIHNpbGVuY2UgaXQuIGB1bnNldGAgaXMgYSBub29wIGlmIHRoZSBhdHRyaWJ1dGUgZG9lc24ndCBleGlzdC4KICAgIHVuc2V0OiBmdW5jdGlvbihhdHRyLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLnNldChhdHRyLCB2b2lkIDAsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7CiAgICB9LAoKICAgIC8vIENsZWFyIGFsbCBhdHRyaWJ1dGVzIG9uIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAgdW5sZXNzIHlvdSBjaG9vc2UKICAgIC8vIHRvIHNpbGVuY2UgaXQuCiAgICBjbGVhcjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgYXR0cnMgPSB7fTsKICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuYXR0cmlidXRlcykgYXR0cnNba2V5XSA9IHZvaWQgMDsKICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHJzLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3Vuc2V0OiB0cnVlfSkpOwogICAgfSwKCiAgICAvLyBGZXRjaCB0aGUgbW9kZWwgZnJvbSB0aGUgc2VydmVyLiBJZiB0aGUgc2VydmVyJ3MgcmVwcmVzZW50YXRpb24gb2YgdGhlCiAgICAvLyBtb2RlbCBkaWZmZXJzIGZyb20gaXRzIGN1cnJlbnQgYXR0cmlidXRlcywgdGhleSB3aWxsIGJlIG92ZXJyaWRlbiwKICAgIC8vIHRyaWdnZXJpbmcgYSBgImNoYW5nZSJgIGV2ZW50LgogICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCwgc3RhdHVzLCB4aHIpIHsKICAgICAgICBpZiAoIW1vZGVsLnNldChtb2RlbC5wYXJzZShyZXNwKSwgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKICAgIH0sCgogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzLCBhbmQgc3luYyB0aGUgbW9kZWwgdG8gdGhlIHNlcnZlci4KICAgIC8vIElmIHRoZSBzZXJ2ZXIgcmV0dXJucyBhbiBhdHRyaWJ1dGVzIGhhc2ggdGhhdCBkaWZmZXJzLCB0aGUgbW9kZWwncwogICAgLy8gc3RhdGUgd2lsbCBiZSBgc2V0YCBhZ2Fpbi4KICAgIHNhdmU6IGZ1bmN0aW9uKGtleSwgdmFsLCBvcHRpb25zKSB7CiAgICAgIHZhciBhdHRycywgY3VycmVudCwgZG9uZTsKCiAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgogICAgICBpZiAoa2V5ID09IG51bGwgfHwgXy5pc09iamVjdChrZXkpKSB7CiAgICAgICAgYXR0cnMgPSBrZXk7CiAgICAgICAgb3B0aW9ucyA9IHZhbDsKICAgICAgfSBlbHNlIGlmIChrZXkgIT0gbnVsbCkgewogICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwogICAgICB9CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwoKICAgICAgLy8gSWYgd2UncmUgIndhaXQiLWluZyB0byBzZXQgY2hhbmdlZCBhdHRyaWJ1dGVzLCB2YWxpZGF0ZSBlYXJseS4KICAgICAgaWYgKG9wdGlvbnMud2FpdCkgewogICAgICAgIGlmIChhdHRycyAmJiAhdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgY3VycmVudCA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgfQoKICAgICAgLy8gUmVndWxhciBzYXZlcyBgc2V0YCBhdHRyaWJ1dGVzIGJlZm9yZSBwZXJzaXN0aW5nIHRvIHRoZSBzZXJ2ZXIuCiAgICAgIHZhciBzaWxlbnRPcHRpb25zID0gXy5leHRlbmQoe30sIG9wdGlvbnMsIHtzaWxlbnQ6IHRydWV9KTsKICAgICAgaWYgKGF0dHJzICYmICF0aGlzLnNldChhdHRycywgb3B0aW9ucy53YWl0ID8gc2lsZW50T3B0aW9ucyA6IG9wdGlvbnMpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICAvLyBEbyBub3QgcGVyc2lzdCBpbnZhbGlkIG1vZGVscy4KICAgICAgaWYgKCFhdHRycyAmJiAhdGhpcy5fdmFsaWRhdGUobnVsbCwgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKCiAgICAgIC8vIEFmdGVyIGEgc3VjY2Vzc2Z1bCBzZXJ2ZXItc2lkZSBzYXZlLCB0aGUgY2xpZW50IGlzIChvcHRpb25hbGx5KQogICAgICAvLyB1cGRhdGVkIHdpdGggdGhlIHNlcnZlci1zaWRlIHN0YXRlLgogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCwgc3RhdHVzLCB4aHIpIHsKICAgICAgICBkb25lID0gdHJ1ZTsKICAgICAgICB2YXIgc2VydmVyQXR0cnMgPSBtb2RlbC5wYXJzZShyZXNwKTsKICAgICAgICBpZiAob3B0aW9ucy53YWl0KSBzZXJ2ZXJBdHRycyA9IF8uZXh0ZW5kKGF0dHJzIHx8IHt9LCBzZXJ2ZXJBdHRycyk7CiAgICAgICAgaWYgKCFtb2RlbC5zZXQoc2VydmVyQXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwoKICAgICAgLy8gRmluaXNoIGNvbmZpZ3VyaW5nIGFuZCBzZW5kaW5nIHRoZSBBamF4IHJlcXVlc3QuCiAgICAgIHZhciBtZXRob2QgPSB0aGlzLmlzTmV3KCkgPyAnY3JlYXRlJyA6IChvcHRpb25zLnBhdGNoID8gJ3BhdGNoJyA6ICd1cGRhdGUnKTsKICAgICAgaWYgKG1ldGhvZCA9PSAncGF0Y2gnKSBvcHRpb25zLmF0dHJzID0gYXR0cnM7CiAgICAgIHZhciB4aHIgPSB0aGlzLnN5bmMobWV0aG9kLCB0aGlzLCBvcHRpb25zKTsKCiAgICAgIC8vIFdoZW4gdXNpbmcgYHdhaXRgLCByZXNldCBhdHRyaWJ1dGVzIHRvIG9yaWdpbmFsIHZhbHVlcyB1bmxlc3MKICAgICAgLy8gYHN1Y2Nlc3NgIGhhcyBiZWVuIGNhbGxlZCBhbHJlYWR5LgogICAgICBpZiAoIWRvbmUgJiYgb3B0aW9ucy53YWl0KSB7CiAgICAgICAgdGhpcy5jbGVhcihzaWxlbnRPcHRpb25zKTsKICAgICAgICB0aGlzLnNldChjdXJyZW50LCBzaWxlbnRPcHRpb25zKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCgogICAgLy8gRGVzdHJveSB0aGlzIG1vZGVsIG9uIHRoZSBzZXJ2ZXIgaWYgaXQgd2FzIGFscmVhZHkgcGVyc2lzdGVkLgogICAgLy8gT3B0aW1pc3RpY2FsbHkgcmVtb3ZlcyB0aGUgbW9kZWwgZnJvbSBpdHMgY29sbGVjdGlvbiwgaWYgaXQgaGFzIG9uZS4KICAgIC8vIElmIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIHdhaXRzIGZvciB0aGUgc2VydmVyIHRvIHJlc3BvbmQgYmVmb3JlIHJlbW92YWwuCiAgICBkZXN0cm95OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKCiAgICAgIHZhciBkZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbW9kZWwudHJpZ2dlcignZGVzdHJveScsIG1vZGVsLCBtb2RlbC5jb2xsZWN0aW9uLCBvcHRpb25zKTsKICAgICAgfTsKCiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICBpZiAob3B0aW9ucy53YWl0IHx8IG1vZGVsLmlzTmV3KCkpIGRlc3Ryb3koKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CgogICAgICBpZiAodGhpcy5pc05ldygpKSB7CiAgICAgICAgb3B0aW9ucy5zdWNjZXNzKCk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICB2YXIgeGhyID0gdGhpcy5zeW5jKCdkZWxldGUnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgaWYgKCFvcHRpb25zLndhaXQpIGRlc3Ryb3koKTsKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCgogICAgLy8gRGVmYXVsdCBVUkwgZm9yIHRoZSBtb2RlbCdzIHJlcHJlc2VudGF0aW9uIG9uIHRoZSBzZXJ2ZXIgLS0gaWYgeW91J3JlCiAgICAvLyB1c2luZyBCYWNrYm9uZSdzIHJlc3RmdWwgbWV0aG9kcywgb3ZlcnJpZGUgdGhpcyB0byBjaGFuZ2UgdGhlIGVuZHBvaW50CiAgICAvLyB0aGF0IHdpbGwgYmUgY2FsbGVkLgogICAgdXJsOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGJhc2UgPSBfLnJlc3VsdCh0aGlzLCAndXJsUm9vdCcpIHx8IF8ucmVzdWx0KHRoaXMuY29sbGVjdGlvbiwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHJldHVybiBiYXNlOwogICAgICByZXR1cm4gYmFzZSArIChiYXNlLmNoYXJBdChiYXNlLmxlbmd0aCAtIDEpID09PSAnLycgPyAnJyA6ICcvJykgKyBlbmNvZGVVUklDb21wb25lbnQodGhpcy5pZCk7CiAgICB9LAoKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gdGhlIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBgc2V0YCBvbgogICAgLy8gdGhlIG1vZGVsLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgdGhlIHJlc3BvbnNlIGFsb25nLgogICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgcmV0dXJuIHJlc3A7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIGlkZW50aWNhbCBhdHRyaWJ1dGVzIHRvIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5hdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gQSBtb2RlbCBpcyBuZXcgaWYgaXQgaGFzIG5ldmVyIGJlZW4gc2F2ZWQgdG8gdGhlIHNlcnZlciwgYW5kIGxhY2tzIGFuIGlkLgogICAgaXNOZXc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5pZCA9PSBudWxsOwogICAgfSwKCiAgICAvLyBDYWxsIHRoaXMgbWV0aG9kIHRvIG1hbnVhbGx5IGZpcmUgYSBgImNoYW5nZSJgIGV2ZW50IGZvciB0aGlzIG1vZGVsIGFuZAogICAgLy8gYSBgImNoYW5nZTphdHRyaWJ1dGUiYCBldmVudCBmb3IgZWFjaCBjaGFuZ2VkIGF0dHJpYnV0ZS4KICAgIC8vIENhbGxpbmcgdGhpcyB3aWxsIGNhdXNlIGFsbCBvYmplY3RzIG9ic2VydmluZyB0aGUgbW9kZWwgdG8gdXBkYXRlLgogICAgY2hhbmdlOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBjaGFuZ2luZyA9IHRoaXMuX2NoYW5naW5nOwogICAgICB0aGlzLl9jaGFuZ2luZyA9IHRydWU7CgogICAgICAvLyBHZW5lcmF0ZSB0aGUgY2hhbmdlcyB0byBiZSB0cmlnZ2VyZWQgb24gdGhlIG1vZGVsLgogICAgICB2YXIgdHJpZ2dlcnMgPSB0aGlzLl9jb21wdXRlQ2hhbmdlcyh0cnVlKTsKCiAgICAgIHRoaXMuX3BlbmRpbmcgPSAhIXRyaWdnZXJzLmxlbmd0aDsKCiAgICAgIGZvciAodmFyIGkgPSB0cmlnZ2Vycy5sZW5ndGggLSAyOyBpID49IDA7IGkgLT0gMikgewogICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyB0cmlnZ2Vyc1tpXSwgdGhpcywgdHJpZ2dlcnNbaSArIDFdLCBvcHRpb25zKTsKICAgICAgfQoKICAgICAgaWYgKGNoYW5naW5nKSByZXR1cm4gdGhpczsKCiAgICAgIC8vIFRyaWdnZXIgYSBgY2hhbmdlYCB3aGlsZSB0aGVyZSBoYXZlIGJlZW4gY2hhbmdlcy4KICAgICAgd2hpbGUgKHRoaXMuX3BlbmRpbmcpIHsKICAgICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2UnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgIH0KCiAgICAgIHRoaXMuX2NoYW5naW5nID0gZmFsc2U7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBEZXRlcm1pbmUgaWYgdGhlIG1vZGVsIGhhcyBjaGFuZ2VkIHNpbmNlIHRoZSBsYXN0IGAiY2hhbmdlImAgZXZlbnQuCiAgICAvLyBJZiB5b3Ugc3BlY2lmeSBhbiBhdHRyaWJ1dGUgbmFtZSwgZGV0ZXJtaW5lIGlmIHRoYXQgYXR0cmlidXRlIGhhcyBjaGFuZ2VkLgogICAgaGFzQ2hhbmdlZDogZnVuY3Rpb24oYXR0cikgewogICAgICBpZiAoIXRoaXMuX2hhc0NvbXB1dGVkKSB0aGlzLl9jb21wdXRlQ2hhbmdlcygpOwogICAgICBpZiAoYXR0ciA9PSBudWxsKSByZXR1cm4gIV8uaXNFbXB0eSh0aGlzLmNoYW5nZWQpOwogICAgICByZXR1cm4gXy5oYXModGhpcy5jaGFuZ2VkLCBhdHRyKTsKICAgIH0sCgogICAgLy8gUmV0dXJuIGFuIG9iamVjdCBjb250YWluaW5nIGFsbCB0aGUgYXR0cmlidXRlcyB0aGF0IGhhdmUgY2hhbmdlZCwgb3IKICAgIC8vIGZhbHNlIGlmIHRoZXJlIGFyZSBubyBjaGFuZ2VkIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3IgZGV0ZXJtaW5pbmcgd2hhdAogICAgLy8gcGFydHMgb2YgYSB2aWV3IG5lZWQgdG8gYmUgdXBkYXRlZCBhbmQvb3Igd2hhdCBhdHRyaWJ1dGVzIG5lZWQgdG8gYmUKICAgIC8vIHBlcnNpc3RlZCB0byB0aGUgc2VydmVyLiBVbnNldCBhdHRyaWJ1dGVzIHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgIC8vIFlvdSBjYW4gYWxzbyBwYXNzIGFuIGF0dHJpYnV0ZXMgb2JqZWN0IHRvIGRpZmYgYWdhaW5zdCB0aGUgbW9kZWwsCiAgICAvLyBkZXRlcm1pbmluZyBpZiB0aGVyZSAqd291bGQgYmUqIGEgY2hhbmdlLgogICAgY2hhbmdlZEF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGRpZmYpIHsKICAgICAgaWYgKCFkaWZmKSByZXR1cm4gdGhpcy5oYXNDaGFuZ2VkKCkgPyBfLmNsb25lKHRoaXMuY2hhbmdlZCkgOiBmYWxzZTsKICAgICAgdmFyIHZhbCwgY2hhbmdlZCA9IGZhbHNlLCBvbGQgPSB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXM7CiAgICAgIGZvciAodmFyIGF0dHIgaW4gZGlmZikgewogICAgICAgIGlmIChfLmlzRXF1YWwob2xkW2F0dHJdLCAodmFsID0gZGlmZlthdHRyXSkpKSBjb250aW51ZTsKICAgICAgICAoY2hhbmdlZCB8fCAoY2hhbmdlZCA9IHt9KSlbYXR0cl0gPSB2YWw7CiAgICAgIH0KICAgICAgcmV0dXJuIGNoYW5nZWQ7CiAgICB9LAoKICAgIC8vIExvb2tpbmcgYXQgdGhlIGJ1aWx0IHVwIGxpc3Qgb2YgYHNldGAgYXR0cmlidXRlIGNoYW5nZXMsIGNvbXB1dGUgaG93CiAgICAvLyBtYW55IG9mIHRoZSBhdHRyaWJ1dGVzIGhhdmUgYWN0dWFsbHkgY2hhbmdlZC4gSWYgYGxvdWRgLCByZXR1cm4gYQogICAgLy8gYm9pbGVkLWRvd24gbGlzdCBvZiBvbmx5IHRoZSByZWFsIGNoYW5nZXMuCiAgICBfY29tcHV0ZUNoYW5nZXM6IGZ1bmN0aW9uKGxvdWQpIHsKICAgICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICAgIHZhciBhbHJlYWR5ID0ge307CiAgICAgIHZhciB0cmlnZ2VycyA9IFtdOwogICAgICB2YXIgY3VycmVudCA9IHRoaXMuX2N1cnJlbnRBdHRyaWJ1dGVzOwogICAgICB2YXIgY2hhbmdlcyA9IHRoaXMuX2NoYW5nZXM7CgogICAgICAvLyBMb29wIHRocm91Z2ggdGhlIGN1cnJlbnQgcXVldWUgb2YgcG90ZW50aWFsIG1vZGVsIGNoYW5nZXMuCiAgICAgIGZvciAodmFyIGkgPSBjaGFuZ2VzLmxlbmd0aCAtIDI7IGkgPj0gMDsgaSAtPSAyKSB7CiAgICAgICAgdmFyIGtleSA9IGNoYW5nZXNbaV0sIHZhbCA9IGNoYW5nZXNbaSArIDFdOwogICAgICAgIGlmIChhbHJlYWR5W2tleV0pIGNvbnRpbnVlOwogICAgICAgIGFscmVhZHlba2V5XSA9IHRydWU7CgogICAgICAgIC8vIENoZWNrIGlmIHRoZSBhdHRyaWJ1dGUgaGFzIGJlZW4gbW9kaWZpZWQgc2luY2UgdGhlIGxhc3QgY2hhbmdlLAogICAgICAgIC8vIGFuZCB1cGRhdGUgYHRoaXMuY2hhbmdlZGAgYWNjb3JkaW5nbHkuIElmIHdlJ3JlIGluc2lkZSBvZiBhIGBjaGFuZ2VgCiAgICAgICAgLy8gY2FsbCwgYWxzbyBhZGQgYSB0cmlnZ2VyIHRvIHRoZSBsaXN0LgogICAgICAgIGlmIChjdXJyZW50W2tleV0gIT09IHZhbCkgewogICAgICAgICAgdGhpcy5jaGFuZ2VkW2tleV0gPSB2YWw7CiAgICAgICAgICBpZiAoIWxvdWQpIGNvbnRpbnVlOwogICAgICAgICAgdHJpZ2dlcnMucHVzaChrZXksIHZhbCk7CiAgICAgICAgICBjdXJyZW50W2tleV0gPSB2YWw7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChsb3VkKSB0aGlzLl9jaGFuZ2VzID0gW107CgogICAgICAvLyBTaWduYWxzIGB0aGlzLmNoYW5nZWRgIGlzIGN1cnJlbnQgdG8gcHJldmVudCBkdXBsaWNhdGUgY2FsbHMgZnJvbSBgdGhpcy5oYXNDaGFuZ2VkYC4KICAgICAgdGhpcy5faGFzQ29tcHV0ZWQgPSB0cnVlOwogICAgICByZXR1cm4gdHJpZ2dlcnM7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgcHJldmlvdXMgdmFsdWUgb2YgYW4gYXR0cmlidXRlLCByZWNvcmRlZCBhdCB0aGUgdGltZSB0aGUgbGFzdAogICAgLy8gYCJjaGFuZ2UiYCBldmVudCB3YXMgZmlyZWQuCiAgICBwcmV2aW91czogZnVuY3Rpb24oYXR0cikgewogICAgICBpZiAoYXR0ciA9PSBudWxsIHx8ICF0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpIHJldHVybiBudWxsOwogICAgICByZXR1cm4gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgYWxsIG9mIHRoZSBhdHRyaWJ1dGVzIG9mIHRoZSBtb2RlbCBhdCB0aGUgdGltZSBvZiB0aGUgcHJldmlvdXMKICAgIC8vIGAiY2hhbmdlImAgZXZlbnQuCiAgICBwcmV2aW91c0F0dHJpYnV0ZXM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBSdW4gdmFsaWRhdGlvbiBhZ2FpbnN0IHRoZSBuZXh0IGNvbXBsZXRlIHNldCBvZiBtb2RlbCBhdHRyaWJ1dGVzLAogICAgLy8gcmV0dXJuaW5nIGB0cnVlYCBpZiBhbGwgaXMgd2VsbC4gSWYgYSBzcGVjaWZpYyBgZXJyb3JgIGNhbGxiYWNrIGhhcwogICAgLy8gYmVlbiBwYXNzZWQsIGNhbGwgdGhhdCBpbnN0ZWFkIG9mIGZpcmluZyB0aGUgZ2VuZXJhbCBgImVycm9yImAgZXZlbnQuCiAgICBfdmFsaWRhdGU6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgIGlmICghdGhpcy52YWxpZGF0ZSkgcmV0dXJuIHRydWU7CiAgICAgIGF0dHJzID0gXy5leHRlbmQoe30sIHRoaXMuYXR0cmlidXRlcywgYXR0cnMpOwogICAgICB2YXIgZXJyb3IgPSB0aGlzLnZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKTsKICAgICAgaWYgKCFlcnJvcikgcmV0dXJuIHRydWU7CiAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuZXJyb3IpIG9wdGlvbnMuZXJyb3IodGhpcywgZXJyb3IsIG9wdGlvbnMpOwogICAgICB0aGlzLnRyaWdnZXIoJ2Vycm9yJywgdGhpcywgZXJyb3IsIG9wdGlvbnMpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5Db2xsZWN0aW9uCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBQcm92aWRlcyBhIHN0YW5kYXJkIGNvbGxlY3Rpb24gY2xhc3MgZm9yIG91ciBzZXRzIG9mIG1vZGVscywgb3JkZXJlZAogIC8vIG9yIHVub3JkZXJlZC4gSWYgYSBgY29tcGFyYXRvcmAgaXMgc3BlY2lmaWVkLCB0aGUgQ29sbGVjdGlvbiB3aWxsIG1haW50YWluCiAgLy8gaXRzIG1vZGVscyBpbiBzb3J0IG9yZGVyLCBhcyB0aGV5J3JlIGFkZGVkIGFuZCByZW1vdmVkLgogIHZhciBDb2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIGlmIChvcHRpb25zLm1vZGVsKSB0aGlzLm1vZGVsID0gb3B0aW9ucy5tb2RlbDsKICAgIGlmIChvcHRpb25zLmNvbXBhcmF0b3IgIT09IHZvaWQgMCkgdGhpcy5jb21wYXJhdG9yID0gb3B0aW9ucy5jb21wYXJhdG9yOwogICAgdGhpcy5fcmVzZXQoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKG1vZGVscykgdGhpcy5yZXNldChtb2RlbHMsIF8uZXh0ZW5kKHtzaWxlbnQ6IHRydWV9LCBvcHRpb25zKSk7CiAgfTsKCiAgLy8gRGVmaW5lIHRoZSBDb2xsZWN0aW9uJ3MgaW5oZXJpdGFibGUgbWV0aG9kcy4KICBfLmV4dGVuZChDb2xsZWN0aW9uLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgbW9kZWwgZm9yIGEgY29sbGVjdGlvbiBpcyBqdXN0IGEgKipCYWNrYm9uZS5Nb2RlbCoqLgogICAgLy8gVGhpcyBzaG91bGQgYmUgb3ZlcnJpZGRlbiBpbiBtb3N0IGNhc2VzLgogICAgbW9kZWw6IE1vZGVsLAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gVGhlIEpTT04gcmVwcmVzZW50YXRpb24gb2YgYSBDb2xsZWN0aW9uIGlzIGFuIGFycmF5IG9mIHRoZQogICAgLy8gbW9kZWxzJyBhdHRyaWJ1dGVzLgogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbihtb2RlbCl7IHJldHVybiBtb2RlbC50b0pTT04ob3B0aW9ucyk7IH0pOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCwgb3IgbGlzdCBvZiBtb2RlbHMgdG8gdGhlIHNldC4gUGFzcyAqKnNpbGVudCoqIHRvIGF2b2lkCiAgICAvLyBmaXJpbmcgdGhlIGBhZGRgIGV2ZW50IGZvciBldmVyeSBuZXcgbW9kZWwuCiAgICBhZGQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICB2YXIgaSwgYXJncywgbGVuZ3RoLCBtb2RlbCwgZXhpc3RpbmcsIG5lZWRzU29ydDsKICAgICAgdmFyIGF0ID0gb3B0aW9ucyAmJiBvcHRpb25zLmF0OwogICAgICB2YXIgc29ydCA9ICgob3B0aW9ucyAmJiBvcHRpb25zLnNvcnQpID09IG51bGwgPyB0cnVlIDogb3B0aW9ucy5zb3J0KTsKICAgICAgbW9kZWxzID0gXy5pc0FycmF5KG1vZGVscykgPyBtb2RlbHMuc2xpY2UoKSA6IFttb2RlbHNdOwoKICAgICAgLy8gVHVybiBiYXJlIG9iamVjdHMgaW50byBtb2RlbCByZWZlcmVuY2VzLCBhbmQgcHJldmVudCBpbnZhbGlkIG1vZGVscwogICAgICAvLyBmcm9tIGJlaW5nIGFkZGVkLgogICAgICBmb3IgKGkgPSBtb2RlbHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICBpZighKG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsc1tpXSwgb3B0aW9ucykpKSB7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoImVycm9yIiwgdGhpcywgbW9kZWxzW2ldLCBvcHRpb25zKTsKICAgICAgICAgIG1vZGVscy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgbW9kZWxzW2ldID0gbW9kZWw7CgogICAgICAgIGV4aXN0aW5nID0gbW9kZWwuaWQgIT0gbnVsbCAmJiB0aGlzLl9ieUlkW21vZGVsLmlkXTsKICAgICAgICAvLyBJZiBhIGR1cGxpY2F0ZSBpcyBmb3VuZCwgcHJldmVudCBpdCBmcm9tIGJlaW5nIGFkZGVkIGFuZAogICAgICAgIC8vIG9wdGlvbmFsbHkgbWVyZ2UgaXQgaW50byB0aGUgZXhpc3RpbmcgbW9kZWwuCiAgICAgICAgaWYgKGV4aXN0aW5nIHx8IHRoaXMuX2J5Q2lkW21vZGVsLmNpZF0pIHsKICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMubWVyZ2UgJiYgZXhpc3RpbmcpIHsKICAgICAgICAgICAgZXhpc3Rpbmcuc2V0KG1vZGVsLmF0dHJpYnV0ZXMsIG9wdGlvbnMpOwogICAgICAgICAgICBuZWVkc1NvcnQgPSBzb3J0OwogICAgICAgICAgfQogICAgICAgICAgbW9kZWxzLnNwbGljZShpLCAxKTsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgLy8gTGlzdGVuIHRvIGFkZGVkIG1vZGVscycgZXZlbnRzLCBhbmQgaW5kZXggbW9kZWxzIGZvciBsb29rdXAgYnkKICAgICAgICAvLyBgaWRgIGFuZCBieSBgY2lkYC4KICAgICAgICBtb2RlbC5vbignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgICAgICB0aGlzLl9ieUNpZFttb2RlbC5jaWRdID0gbW9kZWw7CiAgICAgICAgaWYgKG1vZGVsLmlkICE9IG51bGwpIHRoaXMuX2J5SWRbbW9kZWwuaWRdID0gbW9kZWw7CiAgICAgIH0KCiAgICAgIC8vIFNlZSBpZiBzb3J0aW5nIGlzIG5lZWRlZCwgdXBkYXRlIGBsZW5ndGhgIGFuZCBzcGxpY2UgaW4gbmV3IG1vZGVscy4KICAgICAgaWYgKG1vZGVscy5sZW5ndGgpIG5lZWRzU29ydCA9IHNvcnQ7CiAgICAgIHRoaXMubGVuZ3RoICs9IG1vZGVscy5sZW5ndGg7CiAgICAgIGFyZ3MgPSBbYXQgIT0gbnVsbCA/IGF0IDogdGhpcy5tb2RlbHMubGVuZ3RoLCAwXTsKICAgICAgcHVzaC5hcHBseShhcmdzLCBtb2RlbHMpOwogICAgICBzcGxpY2UuYXBwbHkodGhpcy5tb2RlbHMsIGFyZ3MpOwoKICAgICAgLy8gU29ydCB0aGUgY29sbGVjdGlvbiBpZiBhcHByb3ByaWF0ZS4KICAgICAgaWYgKG5lZWRzU29ydCAmJiB0aGlzLmNvbXBhcmF0b3IgJiYgYXQgPT0gbnVsbCkgdGhpcy5zb3J0KHtzaWxlbnQ6IHRydWV9KTsKCiAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuc2lsZW50KSByZXR1cm4gdGhpczsKCiAgICAgIC8vIFRyaWdnZXIgYGFkZGAgZXZlbnRzLgogICAgICB3aGlsZSAobW9kZWwgPSBtb2RlbHMuc2hpZnQoKSkgewogICAgICAgIG1vZGVsLnRyaWdnZXIoJ2FkZCcsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsLCBvciBhIGxpc3Qgb2YgbW9kZWxzIGZyb20gdGhlIHNldC4gUGFzcyBzaWxlbnQgdG8gYXZvaWQKICAgIC8vIGZpcmluZyB0aGUgYHJlbW92ZWAgZXZlbnQgZm9yIGV2ZXJ5IG1vZGVsIHJlbW92ZWQuCiAgICByZW1vdmU6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICB2YXIgaSwgbCwgaW5kZXgsIG1vZGVsOwogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICBtb2RlbHMgPSBfLmlzQXJyYXkobW9kZWxzKSA/IG1vZGVscy5zbGljZSgpIDogW21vZGVsc107CiAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbW9kZWwgPSB0aGlzLmdldChtb2RlbHNbaV0pOwogICAgICAgIGlmICghbW9kZWwpIGNvbnRpbnVlOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmlkXTsKICAgICAgICBkZWxldGUgdGhpcy5fYnlDaWRbbW9kZWwuY2lkXTsKICAgICAgICBpbmRleCA9IHRoaXMuaW5kZXhPZihtb2RlbCk7CiAgICAgICAgdGhpcy5tb2RlbHMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB0aGlzLmxlbmd0aC0tOwogICAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHsKICAgICAgICAgIG9wdGlvbnMuaW5kZXggPSBpbmRleDsKICAgICAgICAgIG1vZGVsLnRyaWdnZXIoJ3JlbW92ZScsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKG1vZGVsKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHB1c2g6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKTsKICAgICAgdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogdGhpcy5sZW5ndGh9LCBvcHRpb25zKSk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gUmVtb3ZlIGEgbW9kZWwgZnJvbSB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgcG9wOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQodGhpcy5sZW5ndGggLSAxKTsKICAgICAgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vIEFkZCBhIG1vZGVsIHRvIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICB1bnNoaWZ0OiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICBtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHRoaXMuYWRkKG1vZGVsLCBfLmV4dGVuZCh7YXQ6IDB9LCBvcHRpb25zKSk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gUmVtb3ZlIGEgbW9kZWwgZnJvbSB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgc2hpZnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCgwKTsKICAgICAgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vIFNsaWNlIG91dCBhIHN1Yi1hcnJheSBvZiBtb2RlbHMgZnJvbSB0aGUgY29sbGVjdGlvbi4KICAgIHNsaWNlOiBmdW5jdGlvbihiZWdpbiwgZW5kKSB7CiAgICAgIHJldHVybiB0aGlzLm1vZGVscy5zbGljZShiZWdpbiwgZW5kKTsKICAgIH0sCgogICAgLy8gR2V0IGEgbW9kZWwgZnJvbSB0aGUgc2V0IGJ5IGlkLgogICAgZ2V0OiBmdW5jdGlvbihvYmopIHsKICAgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwogICAgICByZXR1cm4gdGhpcy5fYnlJZFtvYmouaWQgIT0gbnVsbCA/IG9iai5pZCA6IG9ial0gfHwgdGhpcy5fYnlDaWRbb2JqLmNpZCB8fCBvYmpdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIG1vZGVsIGF0IHRoZSBnaXZlbiBpbmRleC4KICAgIGF0OiBmdW5jdGlvbihpbmRleCkgewogICAgICByZXR1cm4gdGhpcy5tb2RlbHNbaW5kZXhdOwogICAgfSwKCiAgICAvLyBSZXR1cm4gbW9kZWxzIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMgb2YgYGZpbHRlcmAuCiAgICB3aGVyZTogZnVuY3Rpb24oYXR0cnMpIHsKICAgICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBbXTsKICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gbW9kZWwuZ2V0KGtleSkpIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBGb3JjZSB0aGUgY29sbGVjdGlvbiB0byByZS1zb3J0IGl0c2VsZi4gWW91IGRvbid0IG5lZWQgdG8gY2FsbCB0aGlzIHVuZGVyCiAgICAvLyBub3JtYWwgY2lyY3Vtc3RhbmNlcywgYXMgdGhlIHNldCB3aWxsIG1haW50YWluIHNvcnQgb3JkZXIgYXMgZWFjaCBpdGVtCiAgICAvLyBpcyBhZGRlZC4KICAgIHNvcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKCF0aGlzLmNvbXBhcmF0b3IpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBzb3J0IGEgc2V0IHdpdGhvdXQgYSBjb21wYXJhdG9yJyk7CiAgICAgIH0KCiAgICAgIGlmIChfLmlzU3RyaW5nKHRoaXMuY29tcGFyYXRvcikgfHwgdGhpcy5jb21wYXJhdG9yLmxlbmd0aCA9PT0gMSkgewogICAgICAgIHRoaXMubW9kZWxzID0gdGhpcy5zb3J0QnkodGhpcy5jb21wYXJhdG9yLCB0aGlzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm1vZGVscy5zb3J0KF8uYmluZCh0aGlzLmNvbXBhcmF0b3IsIHRoaXMpKTsKICAgICAgfQoKICAgICAgaWYgKCFvcHRpb25zIHx8ICFvcHRpb25zLnNpbGVudCkgdGhpcy50cmlnZ2VyKCdzb3J0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBQbHVjayBhbiBhdHRyaWJ1dGUgZnJvbSBlYWNoIG1vZGVsIGluIHRoZSBjb2xsZWN0aW9uLgogICAgcGx1Y2s6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uaW52b2tlKHRoaXMubW9kZWxzLCAnZ2V0JywgYXR0cik7CiAgICB9LAoKICAgIC8vIFNtYXJ0bHkgdXBkYXRlIGEgY29sbGVjdGlvbiB3aXRoIGEgY2hhbmdlIHNldCBvZiBtb2RlbHMsIGFkZGluZywKICAgIC8vIHJlbW92aW5nLCBhbmQgbWVyZ2luZyBhcyBuZWNlc3NhcnkuCiAgICB1cGRhdGU6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICB2YXIgbW9kZWwsIGksIGwsIGV4aXN0aW5nOwogICAgICB2YXIgYWRkID0gW10sIHJlbW92ZSA9IFtdLCBtb2RlbE1hcCA9IHt9OwogICAgICB2YXIgaWRBdHRyID0gdGhpcy5tb2RlbC5wcm90b3R5cGUuaWRBdHRyaWJ1dGU7CiAgICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7YWRkOiB0cnVlLCBtZXJnZTogdHJ1ZSwgcmVtb3ZlOiB0cnVlfSwgb3B0aW9ucyk7CiAgICAgIGlmIChvcHRpb25zLnBhcnNlKSBtb2RlbHMgPSB0aGlzLnBhcnNlKG1vZGVscyk7CgogICAgICAvLyBBbGxvdyBhIHNpbmdsZSBtb2RlbCAob3Igbm8gYXJndW1lbnQpIHRvIGJlIHBhc3NlZC4KICAgICAgaWYgKCFfLmlzQXJyYXkobW9kZWxzKSkgbW9kZWxzID0gbW9kZWxzID8gW21vZGVsc10gOiBbXTsKCiAgICAgIC8vIFByb3h5IHRvIGBhZGRgIGZvciB0aGlzIGNhc2UsIG5vIG5lZWQgdG8gaXRlcmF0ZS4uLgogICAgICBpZiAob3B0aW9ucy5hZGQgJiYgIW9wdGlvbnMucmVtb3ZlKSByZXR1cm4gdGhpcy5hZGQobW9kZWxzLCBvcHRpb25zKTsKCiAgICAgIC8vIERldGVybWluZSB3aGljaCBtb2RlbHMgdG8gYWRkIGFuZCBtZXJnZSwgYW5kIHdoaWNoIHRvIHJlbW92ZS4KICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBtb2RlbCA9IG1vZGVsc1tpXTsKICAgICAgICBleGlzdGluZyA9IHRoaXMuZ2V0KG1vZGVsLmlkIHx8IG1vZGVsLmNpZCB8fCBtb2RlbFtpZEF0dHJdKTsKICAgICAgICBpZiAob3B0aW9ucy5yZW1vdmUgJiYgZXhpc3RpbmcpIG1vZGVsTWFwW2V4aXN0aW5nLmNpZF0gPSB0cnVlOwogICAgICAgIGlmICgob3B0aW9ucy5hZGQgJiYgIWV4aXN0aW5nKSB8fCAob3B0aW9ucy5tZXJnZSAmJiBleGlzdGluZykpIHsKICAgICAgICAgIGFkZC5wdXNoKG1vZGVsKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKG9wdGlvbnMucmVtb3ZlKSB7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMubW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgbW9kZWwgPSB0aGlzLm1vZGVsc1tpXTsKICAgICAgICAgIGlmICghbW9kZWxNYXBbbW9kZWwuY2lkXSkgcmVtb3ZlLnB1c2gobW9kZWwpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gUmVtb3ZlIG1vZGVscyAoaWYgYXBwbGljYWJsZSkgYmVmb3JlIHdlIGFkZCBhbmQgbWVyZ2UgdGhlIHJlc3QuCiAgICAgIGlmIChyZW1vdmUubGVuZ3RoKSB0aGlzLnJlbW92ZShyZW1vdmUsIG9wdGlvbnMpOwogICAgICBpZiAoYWRkLmxlbmd0aCkgdGhpcy5hZGQoYWRkLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFdoZW4geW91IGhhdmUgbW9yZSBpdGVtcyB0aGFuIHlvdSB3YW50IHRvIGFkZCBvciByZW1vdmUgaW5kaXZpZHVhbGx5LAogICAgLy8geW91IGNhbiByZXNldCB0aGUgZW50aXJlIHNldCB3aXRoIGEgbmV3IGxpc3Qgb2YgbW9kZWxzLCB3aXRob3V0IGZpcmluZwogICAgLy8gYW55IGBhZGRgIG9yIGByZW1vdmVgIGV2ZW50cy4gRmlyZXMgYHJlc2V0YCB3aGVuIGZpbmlzaGVkLgogICAgcmVzZXQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICBpZiAob3B0aW9ucy5wYXJzZSkgbW9kZWxzID0gdGhpcy5wYXJzZShtb2RlbHMpOwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZSh0aGlzLm1vZGVsc1tpXSk7CiAgICAgIH0KICAgICAgb3B0aW9ucy5wcmV2aW91c01vZGVscyA9IHRoaXMubW9kZWxzOwogICAgICB0aGlzLl9yZXNldCgpOwogICAgICBpZiAobW9kZWxzKSB0aGlzLmFkZChtb2RlbHMsIF8uZXh0ZW5kKHtzaWxlbnQ6IHRydWV9LCBvcHRpb25zKSk7CiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcigncmVzZXQnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEZldGNoIHRoZSBkZWZhdWx0IHNldCBvZiBtb2RlbHMgZm9yIHRoaXMgY29sbGVjdGlvbiwgcmVzZXR0aW5nIHRoZQogICAgLy8gY29sbGVjdGlvbiB3aGVuIHRoZXkgYXJyaXZlLiBJZiBgYWRkOiB0cnVlYCBpcyBwYXNzZWQsIGFwcGVuZHMgdGhlCiAgICAvLyBtb2RlbHMgdG8gdGhlIGNvbGxlY3Rpb24gaW5zdGVhZCBvZiByZXNldHRpbmcuCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3AsIHN0YXR1cywgeGhyKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IG9wdGlvbnMudXBkYXRlID8gJ3VwZGF0ZScgOiAncmVzZXQnOwogICAgICAgIGNvbGxlY3Rpb25bbWV0aG9kXShyZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvLyBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgYSBtb2RlbCBpbiB0aGlzIGNvbGxlY3Rpb24uIEFkZCB0aGUgbW9kZWwgdG8gdGhlCiAgICAvLyBjb2xsZWN0aW9uIGltbWVkaWF0ZWx5LCB1bmxlc3MgYHdhaXQ6IHRydWVgIGlzIHBhc3NlZCwgaW4gd2hpY2ggY2FzZSB3ZQogICAgLy8gd2FpdCBmb3IgdGhlIHNlcnZlciB0byBhZ3JlZS4KICAgIGNyZWF0ZTogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgdmFyIGNvbGxlY3Rpb24gPSB0aGlzOwogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgbW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpOwogICAgICBpZiAoIW1vZGVsKSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICghb3B0aW9ucy53YWl0KSBjb2xsZWN0aW9uLmFkZChtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihtb2RlbCwgcmVzcCwgb3B0aW9ucykgewogICAgICAgIGlmIChvcHRpb25zLndhaXQpIGNvbGxlY3Rpb24uYWRkKG1vZGVsLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIG1vZGVsLnNhdmUobnVsbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byBhIGxpc3Qgb2YgbW9kZWxzIHRvIGJlIGFkZGVkIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbi4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIGl0IHRocm91Z2guCiAgICBwYXJzZTogZnVuY3Rpb24ocmVzcCkgewogICAgICByZXR1cm4gcmVzcDsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGNvbGxlY3Rpb24gd2l0aCBhbiBpZGVudGljYWwgbGlzdCBvZiBtb2RlbHMgYXMgdGhpcyBvbmUuCiAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLm1vZGVscyk7CiAgICB9LAoKICAgIC8vIFByb3h5IHRvIF8ncyBjaGFpbi4gQ2FuJ3QgYmUgcHJveGllZCB0aGUgc2FtZSB3YXkgdGhlIHJlc3Qgb2YgdGhlCiAgICAvLyB1bmRlcnNjb3JlIG1ldGhvZHMgYXJlIHByb3hpZWQgYmVjYXVzZSBpdCByZWxpZXMgb24gdGhlIHVuZGVyc2NvcmUKICAgIC8vIGNvbnN0cnVjdG9yLgogICAgY2hhaW46IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gXyh0aGlzLm1vZGVscykuY2hhaW4oKTsKICAgIH0sCgogICAgLy8gUmVzZXQgYWxsIGludGVybmFsIHN0YXRlLiBDYWxsZWQgd2hlbiB0aGUgY29sbGVjdGlvbiBpcyByZXNldC4KICAgIF9yZXNldDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubGVuZ3RoID0gMDsKICAgICAgdGhpcy5tb2RlbHMgPSBbXTsKICAgICAgdGhpcy5fYnlJZCAgPSB7fTsKICAgICAgdGhpcy5fYnlDaWQgPSB7fTsKICAgIH0sCgogICAgLy8gUHJlcGFyZSBhIG1vZGVsIG9yIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBhZGRlZCB0byB0aGlzIGNvbGxlY3Rpb24uCiAgICBfcHJlcGFyZU1vZGVsOiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgewogICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiBNb2RlbCkgewogICAgICAgIGlmICghYXR0cnMuY29sbGVjdGlvbikgYXR0cnMuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgICAgcmV0dXJuIGF0dHJzOwogICAgICB9CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIG9wdGlvbnMuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBtb2RlbCA9IG5ldyB0aGlzLm1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgaWYgKCFtb2RlbC5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHJlbW92ZSBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uCiAgICBfcmVtb3ZlUmVmZXJlbmNlOiBmdW5jdGlvbihtb2RlbCkgewogICAgICBpZiAodGhpcyA9PT0gbW9kZWwuY29sbGVjdGlvbikgZGVsZXRlIG1vZGVsLmNvbGxlY3Rpb247CiAgICAgIG1vZGVsLm9mZignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgIH0sCgogICAgLy8gSW50ZXJuYWwgbWV0aG9kIGNhbGxlZCBldmVyeSB0aW1lIGEgbW9kZWwgaW4gdGhlIHNldCBmaXJlcyBhbiBldmVudC4KICAgIC8vIFNldHMgbmVlZCB0byB1cGRhdGUgdGhlaXIgaW5kZXhlcyB3aGVuIG1vZGVscyBjaGFuZ2UgaWRzLiBBbGwgb3RoZXIKICAgIC8vIGV2ZW50cyBzaW1wbHkgcHJveHkgdGhyb3VnaC4gImFkZCIgYW5kICJyZW1vdmUiIGV2ZW50cyB0aGF0IG9yaWdpbmF0ZQogICAgLy8gaW4gb3RoZXIgY29sbGVjdGlvbnMgYXJlIGlnbm9yZWQuCiAgICBfb25Nb2RlbEV2ZW50OiBmdW5jdGlvbihldmVudCwgbW9kZWwsIGNvbGxlY3Rpb24sIG9wdGlvbnMpIHsKICAgICAgaWYgKChldmVudCA9PT0gJ2FkZCcgfHwgZXZlbnQgPT09ICdyZW1vdmUnKSAmJiBjb2xsZWN0aW9uICE9PSB0aGlzKSByZXR1cm47CiAgICAgIGlmIChldmVudCA9PT0gJ2Rlc3Ryb3knKSB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIGlmIChtb2RlbCAmJiBldmVudCA9PT0gJ2NoYW5nZTonICsgbW9kZWwuaWRBdHRyaWJ1dGUpIHsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5wcmV2aW91cyhtb2RlbC5pZEF0dHJpYnV0ZSldOwogICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQoKICB9KTsKCiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIENvbGxlY3Rpb24uCiAgdmFyIG1ldGhvZHMgPSBbJ2ZvckVhY2gnLCAnZWFjaCcsICdtYXAnLCAnY29sbGVjdCcsICdyZWR1Y2UnLCAnZm9sZGwnLAogICAgJ2luamVjdCcsICdyZWR1Y2VSaWdodCcsICdmb2xkcicsICdmaW5kJywgJ2RldGVjdCcsICdmaWx0ZXInLCAnc2VsZWN0JywKICAgICdyZWplY3QnLCAnZXZlcnknLCAnYWxsJywgJ3NvbWUnLCAnYW55JywgJ2luY2x1ZGUnLCAnY29udGFpbnMnLCAnaW52b2tlJywKICAgICdtYXgnLCAnbWluJywgJ3NvcnRlZEluZGV4JywgJ3RvQXJyYXknLCAnc2l6ZScsICdmaXJzdCcsICdoZWFkJywgJ3Rha2UnLAogICAgJ2luaXRpYWwnLCAncmVzdCcsICd0YWlsJywgJ2xhc3QnLCAnd2l0aG91dCcsICdpbmRleE9mJywgJ3NodWZmbGUnLAogICAgJ2xhc3RJbmRleE9mJywgJ2lzRW1wdHknXTsKCiAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgQ29sbGVjdGlvbiNtb2RlbHNgLgogIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIENvbGxlY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLm1vZGVscyk7CiAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CiAgICB9OwogIH0pOwoKICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB0YWtlIGEgcHJvcGVydHkgbmFtZSBhcyBhbiBhcmd1bWVudC4KICB2YXIgYXR0cmlidXRlTWV0aG9kcyA9IFsnZ3JvdXBCeScsICdjb3VudEJ5JywgJ3NvcnRCeSddOwoKICAvLyBVc2UgYXR0cmlidXRlcyBpbnN0ZWFkIG9mIHByb3BlcnRpZXMuCiAgXy5lYWNoKGF0dHJpYnV0ZU1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHZhciBpdGVyYXRvciA9IF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIG1vZGVsLmdldCh2YWx1ZSk7CiAgICAgIH07CiAgICAgIHJldHVybiBfW21ldGhvZF0odGhpcy5tb2RlbHMsIGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH07CiAgfSk7CgogIC8vIEJhY2tib25lLlJvdXRlcgogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBSb3V0ZXJzIG1hcCBmYXV4LVVSTHMgdG8gYWN0aW9ucywgYW5kIGZpcmUgZXZlbnRzIHdoZW4gcm91dGVzIGFyZQogIC8vIG1hdGNoZWQuIENyZWF0aW5nIGEgbmV3IG9uZSBzZXRzIGl0cyBgcm91dGVzYCBoYXNoLCBpZiBub3Qgc2V0IHN0YXRpY2FsbHkuCiAgdmFyIFJvdXRlciA9IEJhY2tib25lLlJvdXRlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBpZiAob3B0aW9ucy5yb3V0ZXMpIHRoaXMucm91dGVzID0gb3B0aW9ucy5yb3V0ZXM7CiAgICB0aGlzLl9iaW5kUm91dGVzKCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwoKICAvLyBDYWNoZWQgcmVndWxhciBleHByZXNzaW9ucyBmb3IgbWF0Y2hpbmcgbmFtZWQgcGFyYW0gcGFydHMgYW5kIHNwbGF0dGVkCiAgLy8gcGFydHMgb2Ygcm91dGUgc3RyaW5ncy4KICB2YXIgb3B0aW9uYWxQYXJhbSA9IC9cKCguKj8pXCkvZzsKICB2YXIgbmFtZWRQYXJhbSAgICA9IC86XHcrL2c7CiAgdmFyIHNwbGF0UGFyYW0gICAgPSAvXCpcdysvZzsKICB2YXIgZXNjYXBlUmVnRXhwICA9IC9bXC17fVxbXF0rPy4sXFxcXiR8I1xzXS9nOwoKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuUm91dGVyKiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChSb3V0ZXIucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIE1hbnVhbGx5IGJpbmQgYSBzaW5nbGUgbmFtZWQgcm91dGUgdG8gYSBjYWxsYmFjay4gRm9yIGV4YW1wbGU6CiAgICAvLwogICAgLy8gICAgIHRoaXMucm91dGUoJ3NlYXJjaC86cXVlcnkvcDpudW0nLCAnc2VhcmNoJywgZnVuY3Rpb24ocXVlcnksIG51bSkgewogICAgLy8gICAgICAgLi4uCiAgICAvLyAgICAgfSk7CiAgICAvLwogICAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBuYW1lLCBjYWxsYmFjaykgewogICAgICBpZiAoIV8uaXNSZWdFeHAocm91dGUpKSByb3V0ZSA9IHRoaXMuX3JvdXRlVG9SZWdFeHAocm91dGUpOwogICAgICBpZiAoIWNhbGxiYWNrKSBjYWxsYmFjayA9IHRoaXNbbmFtZV07CiAgICAgIEJhY2tib25lLmhpc3Rvcnkucm91dGUocm91dGUsIF8uYmluZChmdW5jdGlvbihmcmFnbWVudCkgewogICAgICAgIHZhciBhcmdzID0gdGhpcy5fZXh0cmFjdFBhcmFtZXRlcnMocm91dGUsIGZyYWdtZW50KTsKICAgICAgICBjYWxsYmFjayAmJiBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgWydyb3V0ZTonICsgbmFtZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgICBCYWNrYm9uZS5oaXN0b3J5LnRyaWdnZXIoJ3JvdXRlJywgdGhpcywgbmFtZSwgYXJncyk7CiAgICAgIH0sIHRoaXMpKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFNpbXBsZSBwcm94eSB0byBgQmFja2JvbmUuaGlzdG9yeWAgdG8gc2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhpc3RvcnkuCiAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5uYXZpZ2F0ZShmcmFnbWVudCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBCaW5kIGFsbCBkZWZpbmVkIHJvdXRlcyB0byBgQmFja2JvbmUuaGlzdG9yeWAuIFdlIGhhdmUgdG8gcmV2ZXJzZSB0aGUKICAgIC8vIG9yZGVyIG9mIHRoZSByb3V0ZXMgaGVyZSB0byBzdXBwb3J0IGJlaGF2aW9yIHdoZXJlIHRoZSBtb3N0IGdlbmVyYWwKICAgIC8vIHJvdXRlcyBjYW4gYmUgZGVmaW5lZCBhdCB0aGUgYm90dG9tIG9mIHRoZSByb3V0ZSBtYXAuCiAgICBfYmluZFJvdXRlczogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy5yb3V0ZXMpIHJldHVybjsKICAgICAgdmFyIHJvdXRlLCByb3V0ZXMgPSBfLmtleXModGhpcy5yb3V0ZXMpOwogICAgICB3aGlsZSAoKHJvdXRlID0gcm91dGVzLnBvcCgpKSAhPSBudWxsKSB7CiAgICAgICAgdGhpcy5yb3V0ZShyb3V0ZSwgdGhpcy5yb3V0ZXNbcm91dGVdKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBDb252ZXJ0IGEgcm91dGUgc3RyaW5nIGludG8gYSByZWd1bGFyIGV4cHJlc3Npb24sIHN1aXRhYmxlIGZvciBtYXRjaGluZwogICAgLy8gYWdhaW5zdCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoLgogICAgX3JvdXRlVG9SZWdFeHA6IGZ1bmN0aW9uKHJvdXRlKSB7CiAgICAgIHJvdXRlID0gcm91dGUucmVwbGFjZShlc2NhcGVSZWdFeHAsICdcXCQmJykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG9wdGlvbmFsUGFyYW0sICcoPzokMSk/JykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG5hbWVkUGFyYW0sICcoW15cL10rKScpCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZShzcGxhdFBhcmFtLCAnKC4qPyknKTsKICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcm91dGUgKyAnJCcpOwogICAgfSwKCiAgICAvLyBHaXZlbiBhIHJvdXRlLCBhbmQgYSBVUkwgZnJhZ21lbnQgdGhhdCBpdCBtYXRjaGVzLCByZXR1cm4gdGhlIGFycmF5IG9mCiAgICAvLyBleHRyYWN0ZWQgcGFyYW1ldGVycy4KICAgIF9leHRyYWN0UGFyYW1ldGVyczogZnVuY3Rpb24ocm91dGUsIGZyYWdtZW50KSB7CiAgICAgIHJldHVybiByb3V0ZS5leGVjKGZyYWdtZW50KS5zbGljZSgxKTsKICAgIH0KCiAgfSk7CgogIC8vIEJhY2tib25lLkhpc3RvcnkKICAvLyAtLS0tLS0tLS0tLS0tLS0tCgogIC8vIEhhbmRsZXMgY3Jvc3MtYnJvd3NlciBoaXN0b3J5IG1hbmFnZW1lbnQsIGJhc2VkIG9uIFVSTCBmcmFnbWVudHMuIElmIHRoZQogIC8vIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBgb25oYXNoY2hhbmdlYCwgZmFsbHMgYmFjayB0byBwb2xsaW5nLgogIHZhciBIaXN0b3J5ID0gQmFja2JvbmUuSGlzdG9yeSA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5oYW5kbGVycyA9IFtdOwogICAgXy5iaW5kQWxsKHRoaXMsICdjaGVja1VybCcpOwoKICAgIC8vIEVuc3VyZSB0aGF0IGBIaXN0b3J5YCBjYW4gYmUgdXNlZCBvdXRzaWRlIG9mIHRoZSBicm93c2VyLgogICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHRoaXMubG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CiAgICAgIHRoaXMuaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwogICAgfQogIH07CgogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KICB2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaGVzLgogIHZhciByb290U3RyaXBwZXIgPSAvXlwvK3xcLyskL2c7CgogIC8vIENhY2hlZCByZWdleCBmb3IgZGV0ZWN0aW5nIE1TSUUuCiAgdmFyIGlzRXhwbG9yZXIgPSAvbXNpZSBbXHcuXSsvOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guCiAgdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKCiAgLy8gSGFzIHRoZSBoaXN0b3J5IGhhbmRsaW5nIGFscmVhZHkgYmVlbiBzdGFydGVkPwogIEhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOwoKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuSGlzdG9yeSoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCiAgXy5leHRlbmQoSGlzdG9yeS5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIFRoZSBkZWZhdWx0IGludGVydmFsIHRvIHBvbGwgZm9yIGhhc2ggY2hhbmdlcywgaWYgbmVjZXNzYXJ5LCBpcwogICAgLy8gdHdlbnR5IHRpbWVzIGEgc2Vjb25kLgogICAgaW50ZXJ2YWw6IDUwLAoKICAgIC8vIEdldHMgdGhlIHRydWUgaGFzaCB2YWx1ZS4gQ2Fubm90IHVzZSBsb2NhdGlvbi5oYXNoIGRpcmVjdGx5IGR1ZSB0byBidWcKICAgIC8vIGluIEZpcmVmb3ggd2hlcmUgbG9jYXRpb24uaGFzaCB3aWxsIGFsd2F5cyBiZSBkZWNvZGVkLgogICAgZ2V0SGFzaDogZnVuY3Rpb24od2luZG93KSB7CiAgICAgIHZhciBtYXRjaCA9ICh3aW5kb3cgfHwgdGhpcykubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CiAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogJyc7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgY3Jvc3MtYnJvd3NlciBub3JtYWxpemVkIFVSTCBmcmFnbWVudCwgZWl0aGVyIGZyb20gdGhlIFVSTCwKICAgIC8vIHRoZSBoYXNoLCBvciB0aGUgb3ZlcnJpZGUuCiAgICBnZXRGcmFnbWVudDogZnVuY3Rpb24oZnJhZ21lbnQsIGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgIGlmIChmcmFnbWVudCA9PSBudWxsKSB7CiAgICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSB8fCAhdGhpcy5fd2FudHNIYXNoQ2hhbmdlIHx8IGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMubG9jYXRpb24ucGF0aG5hbWU7CiAgICAgICAgICB2YXIgcm9vdCA9IHRoaXMucm9vdC5yZXBsYWNlKHRyYWlsaW5nU2xhc2gsICcnKTsKICAgICAgICAgIGlmICghZnJhZ21lbnQuaW5kZXhPZihyb290KSkgZnJhZ21lbnQgPSBmcmFnbWVudC5zdWJzdHIocm9vdC5sZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZnJhZ21lbnQucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICB9LAoKICAgIC8vIFN0YXJ0IHRoZSBoYXNoIGNoYW5nZSBoYW5kbGluZywgcmV0dXJuaW5nIGB0cnVlYCBpZiB0aGUgY3VycmVudCBVUkwgbWF0Y2hlcwogICAgLy8gYW4gZXhpc3Rpbmcgcm91dGUsIGFuZCBgZmFsc2VgIG90aGVyd2lzZS4KICAgIHN0YXJ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmIChIaXN0b3J5LnN0YXJ0ZWQpIHRocm93IG5ldyBFcnJvcigiQmFja2JvbmUuaGlzdG9yeSBoYXMgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQiKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gdHJ1ZTsKCiAgICAgIC8vIEZpZ3VyZSBvdXQgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbi4gRG8gd2UgbmVlZCBhbiBpZnJhbWU/CiAgICAgIC8vIElzIHB1c2hTdGF0ZSBkZXNpcmVkIC4uLiBpcyBpdCBhdmFpbGFibGU/CiAgICAgIHRoaXMub3B0aW9ucyAgICAgICAgICA9IF8uZXh0ZW5kKHt9LCB7cm9vdDogJy8nfSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsKICAgICAgdGhpcy5yb290ICAgICAgICAgICAgID0gdGhpcy5vcHRpb25zLnJvb3Q7CiAgICAgIHRoaXMuX3dhbnRzSGFzaENoYW5nZSA9IHRoaXMub3B0aW9ucy5oYXNoQ2hhbmdlICE9PSBmYWxzZTsKICAgICAgdGhpcy5fd2FudHNQdXNoU3RhdGUgID0gISF0aGlzLm9wdGlvbnMucHVzaFN0YXRlOwogICAgICB0aGlzLl9oYXNQdXNoU3RhdGUgICAgPSAhISh0aGlzLm9wdGlvbnMucHVzaFN0YXRlICYmIHRoaXMuaGlzdG9yeSAmJiB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKTsKICAgICAgdmFyIGZyYWdtZW50ICAgICAgICAgID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICB2YXIgZG9jTW9kZSAgICAgICAgICAgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgIHZhciBvbGRJRSAgICAgICAgICAgICA9IChpc0V4cGxvcmVyLmV4ZWMobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKSAmJiAoIWRvY01vZGUgfHwgZG9jTW9kZSA8PSA3KSk7CgogICAgICAvLyBOb3JtYWxpemUgcm9vdCB0byBhbHdheXMgaW5jbHVkZSBhIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoLgogICAgICB0aGlzLnJvb3QgPSAoJy8nICsgdGhpcy5yb290ICsgJy8nKS5yZXBsYWNlKHJvb3RTdHJpcHBlciwgJy8nKTsKCiAgICAgIGlmIChvbGRJRSAmJiB0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLmlmcmFtZSA9IEJhY2tib25lLiQoJzxpZnJhbWUgc3JjPSJqYXZhc2NyaXB0OjAiIHRhYmluZGV4PSItMSIgLz4nKS5oaWRlKCkuYXBwZW5kVG8oJ2JvZHknKVswXS5jb250ZW50V2luZG93OwogICAgICAgIHRoaXMubmF2aWdhdGUoZnJhZ21lbnQpOwogICAgICB9CgogICAgICAvLyBEZXBlbmRpbmcgb24gd2hldGhlciB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgb3IgaGFzaGVzLCBhbmQgd2hldGhlcgogICAgICAvLyAnb25oYXNoY2hhbmdlJyBpcyBzdXBwb3J0ZWQsIGRldGVybWluZSBob3cgd2UgY2hlY2sgdGhlIFVSTCBzdGF0ZS4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIEJhY2tib25lLiQod2luZG93KS5iaW5kKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiAoJ29uaGFzaGNoYW5nZScgaW4gd2luZG93KSAmJiAhb2xkSUUpIHsKICAgICAgICBCYWNrYm9uZS4kKHdpbmRvdykuYmluZCgnaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLmNoZWNrVXJsLCB0aGlzLmludGVydmFsKTsKICAgICAgfQoKICAgICAgLy8gRGV0ZXJtaW5lIGlmIHdlIG5lZWQgdG8gY2hhbmdlIHRoZSBiYXNlIHVybCwgZm9yIGEgcHVzaFN0YXRlIGxpbmsKICAgICAgLy8gb3BlbmVkIGJ5IGEgbm9uLXB1c2hTdGF0ZSBicm93c2VyLgogICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CiAgICAgIHZhciBsb2MgPSB0aGlzLmxvY2F0aW9uOwogICAgICB2YXIgYXRSb290ID0gbG9jLnBhdGhuYW1lLnJlcGxhY2UoL1teXC9dJC8sICckJi8nKSA9PT0gdGhpcy5yb290OwoKICAgICAgLy8gSWYgd2UndmUgc3RhcnRlZCBvZmYgd2l0aCBhIHJvdXRlIGZyb20gYSBgcHVzaFN0YXRlYC1lbmFibGVkIGJyb3dzZXIsCiAgICAgIC8vIGJ1dCB3ZSdyZSBjdXJyZW50bHkgaW4gYSBicm93c2VyIHRoYXQgZG9lc24ndCBzdXBwb3J0IGl0Li4uCiAgICAgIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgdGhpcy5fd2FudHNQdXNoU3RhdGUgJiYgIXRoaXMuX2hhc1B1c2hTdGF0ZSAmJiAhYXRSb290KSB7CiAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQobnVsbCwgdHJ1ZSk7CiAgICAgICAgdGhpcy5sb2NhdGlvbi5yZXBsYWNlKHRoaXMucm9vdCArIHRoaXMubG9jYXRpb24uc2VhcmNoICsgJyMnICsgdGhpcy5mcmFnbWVudCk7CiAgICAgICAgLy8gUmV0dXJuIGltbWVkaWF0ZWx5IGFzIGJyb3dzZXIgd2lsbCBkbyByZWRpcmVjdCB0byBuZXcgdXJsCiAgICAgICAgcmV0dXJuIHRydWU7CgogICAgICAvLyBPciBpZiB3ZSd2ZSBzdGFydGVkIG91dCB3aXRoIGEgaGFzaC1iYXNlZCByb3V0ZSwgYnV0IHdlJ3JlIGN1cnJlbnRseQogICAgICAvLyBpbiBhIGJyb3dzZXIgd2hlcmUgaXQgY291bGQgYmUgYHB1c2hTdGF0ZWAtYmFzZWQgaW5zdGVhZC4uLgogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzUHVzaFN0YXRlICYmIHRoaXMuX2hhc1B1c2hTdGF0ZSAmJiBhdFJvb3QgJiYgbG9jLmhhc2gpIHsKICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCkucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICAgICAgdGhpcy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsIHRoaXMucm9vdCArIHRoaXMuZnJhZ21lbnQgKyBsb2Muc2VhcmNoKTsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuc2lsZW50KSByZXR1cm4gdGhpcy5sb2FkVXJsKCk7CiAgICB9LAoKICAgIC8vIERpc2FibGUgQmFja2JvbmUuaGlzdG9yeSwgcGVyaGFwcyB0ZW1wb3JhcmlseS4gTm90IHVzZWZ1bCBpbiBhIHJlYWwgYXBwLAogICAgLy8gYnV0IHBvc3NpYmx5IHVzZWZ1bCBmb3IgdW5pdCB0ZXN0aW5nIFJvdXRlcnMuCiAgICBzdG9wOiBmdW5jdGlvbigpIHsKICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLnVuYmluZCgncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKS51bmJpbmQoJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLl9jaGVja1VybEludGVydmFsKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CiAgICB9LAoKICAgIC8vIEFkZCBhIHJvdXRlIHRvIGJlIHRlc3RlZCB3aGVuIHRoZSBmcmFnbWVudCBjaGFuZ2VzLiBSb3V0ZXMgYWRkZWQgbGF0ZXIKICAgIC8vIG1heSBvdmVycmlkZSBwcmV2aW91cyByb3V0ZXMuCiAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuaGFuZGxlcnMudW5zaGlmdCh7cm91dGU6IHJvdXRlLCBjYWxsYmFjazogY2FsbGJhY2t9KTsKICAgIH0sCgogICAgLy8gQ2hlY2tzIHRoZSBjdXJyZW50IFVSTCB0byBzZWUgaWYgaXQgaGFzIGNoYW5nZWQsIGFuZCBpZiBpdCBoYXMsCiAgICAvLyBjYWxscyBgbG9hZFVybGAsIG5vcm1hbGl6aW5nIGFjcm9zcyB0aGUgaGlkZGVuIGlmcmFtZS4KICAgIGNoZWNrVXJsOiBmdW5jdGlvbihlKSB7CiAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICBpZiAoY3VycmVudCA9PT0gdGhpcy5mcmFnbWVudCAmJiB0aGlzLmlmcmFtZSkgewogICAgICAgIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpOwogICAgICB9CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50KSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICh0aGlzLmlmcmFtZSkgdGhpcy5uYXZpZ2F0ZShjdXJyZW50KTsKICAgICAgdGhpcy5sb2FkVXJsKCkgfHwgdGhpcy5sb2FkVXJsKHRoaXMuZ2V0SGFzaCgpKTsKICAgIH0sCgogICAgLy8gQXR0ZW1wdCB0byBsb2FkIHRoZSBjdXJyZW50IFVSTCBmcmFnbWVudC4gSWYgYSByb3V0ZSBzdWNjZWVkcyB3aXRoIGEKICAgIC8vIG1hdGNoLCByZXR1cm5zIGB0cnVlYC4gSWYgbm8gZGVmaW5lZCByb3V0ZXMgbWF0Y2hlcyB0aGUgZnJhZ21lbnQsCiAgICAvLyByZXR1cm5zIGBmYWxzZWAuCiAgICBsb2FkVXJsOiBmdW5jdGlvbihmcmFnbWVudE92ZXJyaWRlKSB7CiAgICAgIHZhciBmcmFnbWVudCA9IHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50T3ZlcnJpZGUpOwogICAgICB2YXIgbWF0Y2hlZCA9IF8uYW55KHRoaXMuaGFuZGxlcnMsIGZ1bmN0aW9uKGhhbmRsZXIpIHsKICAgICAgICBpZiAoaGFuZGxlci5yb3V0ZS50ZXN0KGZyYWdtZW50KSkgewogICAgICAgICAgaGFuZGxlci5jYWxsYmFjayhmcmFnbWVudCk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gbWF0Y2hlZDsKICAgIH0sCgogICAgLy8gU2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhhc2ggaGlzdG9yeSwgb3IgcmVwbGFjZSB0aGUgVVJMIHN0YXRlIGlmIHRoZQogICAgLy8gJ3JlcGxhY2UnIG9wdGlvbiBpcyBwYXNzZWQuIFlvdSBhcmUgcmVzcG9uc2libGUgZm9yIHByb3Blcmx5IFVSTC1lbmNvZGluZwogICAgLy8gdGhlIGZyYWdtZW50IGluIGFkdmFuY2UuCiAgICAvLwogICAgLy8gVGhlIG9wdGlvbnMgb2JqZWN0IGNhbiBjb250YWluIGB0cmlnZ2VyOiB0cnVlYCBpZiB5b3Ugd2lzaCB0byBoYXZlIHRoZQogICAgLy8gcm91dGUgY2FsbGJhY2sgYmUgZmlyZWQgKG5vdCB1c3VhbGx5IGRlc2lyYWJsZSksIG9yIGByZXBsYWNlOiB0cnVlYCwgaWYKICAgIC8vIHlvdSB3aXNoIHRvIG1vZGlmeSB0aGUgY3VycmVudCBVUkwgd2l0aG91dCBhZGRpbmcgYW4gZW50cnkgdG8gdGhlIGhpc3RvcnkuCiAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKICAgICAgaWYgKCFIaXN0b3J5LnN0YXJ0ZWQpIHJldHVybiBmYWxzZTsKICAgICAgaWYgKCFvcHRpb25zIHx8IG9wdGlvbnMgPT09IHRydWUpIG9wdGlvbnMgPSB7dHJpZ2dlcjogb3B0aW9uc307CiAgICAgIGZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudCB8fCAnJyk7CiAgICAgIGlmICh0aGlzLmZyYWdtZW50ID09PSBmcmFnbWVudCkgcmV0dXJuOwogICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CiAgICAgIHZhciB1cmwgPSB0aGlzLnJvb3QgKyBmcmFnbWVudDsKCiAgICAgIC8vIElmIHB1c2hTdGF0ZSBpcyBhdmFpbGFibGUsIHdlIHVzZSBpdCB0byBzZXQgdGhlIGZyYWdtZW50IGFzIGEgcmVhbCBVUkwuCiAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKICAgICAgICB0aGlzLmhpc3Rvcnlbb3B0aW9ucy5yZXBsYWNlID8gJ3JlcGxhY2VTdGF0ZScgOiAncHVzaFN0YXRlJ10oe30sIGRvY3VtZW50LnRpdGxlLCB1cmwpOwoKICAgICAgLy8gSWYgaGFzaCBjaGFuZ2VzIGhhdmVuJ3QgYmVlbiBleHBsaWNpdGx5IGRpc2FibGVkLCB1cGRhdGUgdGhlIGhhc2gKICAgICAgLy8gZnJhZ21lbnQgdG8gc3RvcmUgaGlzdG9yeS4KICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwogICAgICAgIGlmICh0aGlzLmlmcmFtZSAmJiAoZnJhZ21lbnQgIT09IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSkpKSB7CiAgICAgICAgICAvLyBPcGVuaW5nIGFuZCBjbG9zaW5nIHRoZSBpZnJhbWUgdHJpY2tzIElFNyBhbmQgZWFybGllciB0byBwdXNoIGEKICAgICAgICAgIC8vIGhpc3RvcnkgZW50cnkgb24gaGFzaC10YWcgY2hhbmdlLiAgV2hlbiByZXBsYWNlIGlzIHRydWUsIHdlIGRvbid0CiAgICAgICAgICAvLyB3YW50IHRoaXMuCiAgICAgICAgICBpZighb3B0aW9ucy5yZXBsYWNlKSB0aGlzLmlmcmFtZS5kb2N1bWVudC5vcGVuKCkuY2xvc2UoKTsKICAgICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5pZnJhbWUubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwogICAgICAgIH0KCiAgICAgIC8vIElmIHlvdSd2ZSB0b2xkIHVzIHRoYXQgeW91IGV4cGxpY2l0bHkgZG9uJ3Qgd2FudCBmYWxsYmFjayBoYXNoY2hhbmdlLQogICAgICAvLyBiYXNlZCBoaXN0b3J5LCB0aGVuIGBuYXZpZ2F0ZWAgYmVjb21lcyBhIHBhZ2UgcmVmcmVzaC4KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5sb2NhdGlvbi5hc3NpZ24odXJsKTsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy50cmlnZ2VyKSB0aGlzLmxvYWRVcmwoZnJhZ21lbnQpOwogICAgfSwKCiAgICAvLyBVcGRhdGUgdGhlIGhhc2ggbG9jYXRpb24sIGVpdGhlciByZXBsYWNpbmcgdGhlIGN1cnJlbnQgZW50cnksIG9yIGFkZGluZwogICAgLy8gYSBuZXcgb25lIHRvIHRoZSBicm93c2VyIGhpc3RvcnkuCiAgICBfdXBkYXRlSGFzaDogZnVuY3Rpb24obG9jYXRpb24sIGZyYWdtZW50LCByZXBsYWNlKSB7CiAgICAgIGlmIChyZXBsYWNlKSB7CiAgICAgICAgdmFyIGhyZWYgPSBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoLyhqYXZhc2NyaXB0OnwjKS4qJC8sICcnKTsKICAgICAgICBsb2NhdGlvbi5yZXBsYWNlKGhyZWYgKyAnIycgKyBmcmFnbWVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU29tZSBicm93c2VycyByZXF1aXJlIHRoYXQgYGhhc2hgIGNvbnRhaW5zIGEgbGVhZGluZyAjLgogICAgICAgIGxvY2F0aW9uLmhhc2ggPSAnIycgKyBmcmFnbWVudDsKICAgICAgfQogICAgfQoKICB9KTsKCiAgLy8gQ3JlYXRlIHRoZSBkZWZhdWx0IEJhY2tib25lLmhpc3RvcnkuCiAgQmFja2JvbmUuaGlzdG9yeSA9IG5ldyBIaXN0b3J5OwoKICAvLyBCYWNrYm9uZS5WaWV3CiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBDcmVhdGluZyBhIEJhY2tib25lLlZpZXcgY3JlYXRlcyBpdHMgaW5pdGlhbCBlbGVtZW50IG91dHNpZGUgb2YgdGhlIERPTSwKICAvLyBpZiBhbiBleGlzdGluZyBlbGVtZW50IGlzIG5vdCBwcm92aWRlZC4uLgogIHZhciBWaWV3ID0gQmFja2JvbmUuVmlldyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHRoaXMuY2lkID0gXy51bmlxdWVJZCgndmlldycpOwogICAgdGhpcy5fY29uZmlndXJlKG9wdGlvbnMgfHwge30pOwogICAgdGhpcy5fZW5zdXJlRWxlbWVudCgpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CiAgfTsKCiAgLy8gQ2FjaGVkIHJlZ2V4IHRvIHNwbGl0IGtleXMgZm9yIGBkZWxlZ2F0ZWAuCiAgdmFyIGRlbGVnYXRlRXZlbnRTcGxpdHRlciA9IC9eKFxTKylccyooLiopJC87CgogIC8vIExpc3Qgb2YgdmlldyBvcHRpb25zIHRvIGJlIG1lcmdlZCBhcyBwcm9wZXJ0aWVzLgogIHZhciB2aWV3T3B0aW9ucyA9IFsnbW9kZWwnLCAnY29sbGVjdGlvbicsICdlbCcsICdpZCcsICdhdHRyaWJ1dGVzJywgJ2NsYXNzTmFtZScsICd0YWdOYW1lJywgJ2V2ZW50cyddOwoKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuVmlldyoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCiAgXy5leHRlbmQoVmlldy5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIFRoZSBkZWZhdWx0IGB0YWdOYW1lYCBvZiBhIFZpZXcncyBlbGVtZW50IGlzIGAiZGl2ImAuCiAgICB0YWdOYW1lOiAnZGl2JywKCiAgICAvLyBqUXVlcnkgZGVsZWdhdGUgZm9yIGVsZW1lbnQgbG9va3VwLCBzY29wZWQgdG8gRE9NIGVsZW1lbnRzIHdpdGhpbiB0aGUKICAgIC8vIGN1cnJlbnQgdmlldy4gVGhpcyBzaG91bGQgYmUgcHJlZmVyZWQgdG8gZ2xvYmFsIGxvb2t1cHMgd2hlcmUgcG9zc2libGUuCiAgICAkOiBmdW5jdGlvbihzZWxlY3RvcikgewogICAgICByZXR1cm4gdGhpcy4kZWwuZmluZChzZWxlY3Rvcik7CiAgICB9LAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gKipyZW5kZXIqKiBpcyB0aGUgY29yZSBmdW5jdGlvbiB0aGF0IHlvdXIgdmlldyBzaG91bGQgb3ZlcnJpZGUsIGluIG9yZGVyCiAgICAvLyB0byBwb3B1bGF0ZSBpdHMgZWxlbWVudCAoYHRoaXMuZWxgKSwgd2l0aCB0aGUgYXBwcm9wcmlhdGUgSFRNTC4gVGhlCiAgICAvLyBjb252ZW50aW9uIGlzIGZvciAqKnJlbmRlcioqIHRvIGFsd2F5cyByZXR1cm4gYHRoaXNgLgogICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSB0aGlzIHZpZXcgYnkgdGFraW5nIHRoZSBlbGVtZW50IG91dCBvZiB0aGUgRE9NLCBhbmQgcmVtb3ZpbmcgYW55CiAgICAvLyBhcHBsaWNhYmxlIEJhY2tib25lLkV2ZW50cyBsaXN0ZW5lcnMuCiAgICByZW1vdmU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC5yZW1vdmUoKTsKICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBGb3Igc21hbGwgYW1vdW50cyBvZiBET00gRWxlbWVudHMsIHdoZXJlIGEgZnVsbC1ibG93biB0ZW1wbGF0ZSBpc24ndAogICAgLy8gbmVlZGVkLCB1c2UgKiptYWtlKiogdG8gbWFudWZhY3R1cmUgZWxlbWVudHMsIG9uZSBhdCBhIHRpbWUuCiAgICAvLwogICAgLy8gICAgIHZhciBlbCA9IHRoaXMubWFrZSgnbGknLCB7J2NsYXNzJzogJ3Jvdyd9LCB0aGlzLm1vZGVsLmVzY2FwZSgndGl0bGUnKSk7CiAgICAvLwogICAgbWFrZTogZnVuY3Rpb24odGFnTmFtZSwgYXR0cmlidXRlcywgY29udGVudCkgewogICAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZ05hbWUpOwogICAgICBpZiAoYXR0cmlidXRlcykgQmFja2JvbmUuJChlbCkuYXR0cihhdHRyaWJ1dGVzKTsKICAgICAgaWYgKGNvbnRlbnQgIT0gbnVsbCkgQmFja2JvbmUuJChlbCkuaHRtbChjb250ZW50KTsKICAgICAgcmV0dXJuIGVsOwogICAgfSwKCiAgICAvLyBDaGFuZ2UgdGhlIHZpZXcncyBlbGVtZW50IChgdGhpcy5lbGAgcHJvcGVydHkpLCBpbmNsdWRpbmcgZXZlbnQKICAgIC8vIHJlLWRlbGVnYXRpb24uCiAgICBzZXRFbGVtZW50OiBmdW5jdGlvbihlbGVtZW50LCBkZWxlZ2F0ZSkgewogICAgICBpZiAodGhpcy4kZWwpIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICB0aGlzLiRlbCA9IGVsZW1lbnQgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gZWxlbWVudCA6IEJhY2tib25lLiQoZWxlbWVudCk7CiAgICAgIHRoaXMuZWwgPSB0aGlzLiRlbFswXTsKICAgICAgaWYgKGRlbGVnYXRlICE9PSBmYWxzZSkgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gU2V0IGNhbGxiYWNrcywgd2hlcmUgYHRoaXMuZXZlbnRzYCBpcyBhIGhhc2ggb2YKICAgIC8vCiAgICAvLyAqeyJldmVudCBzZWxlY3RvciI6ICJjYWxsYmFjayJ9KgogICAgLy8KICAgIC8vICAgICB7CiAgICAvLyAgICAgICAnbW91c2Vkb3duIC50aXRsZSc6ICAnZWRpdCcsCiAgICAvLyAgICAgICAnY2xpY2sgLmJ1dHRvbic6ICAgICAnc2F2ZScKICAgIC8vICAgICAgICdjbGljayAub3Blbic6ICAgICAgIGZ1bmN0aW9uKGUpIHsgLi4uIH0KICAgIC8vICAgICB9CiAgICAvLwogICAgLy8gcGFpcnMuIENhbGxiYWNrcyB3aWxsIGJlIGJvdW5kIHRvIHRoZSB2aWV3LCB3aXRoIGB0aGlzYCBzZXQgcHJvcGVybHkuCiAgICAvLyBVc2VzIGV2ZW50IGRlbGVnYXRpb24gZm9yIGVmZmljaWVuY3kuCiAgICAvLyBPbWl0dGluZyB0aGUgc2VsZWN0b3IgYmluZHMgdGhlIGV2ZW50IHRvIGB0aGlzLmVsYC4KICAgIC8vIFRoaXMgb25seSB3b3JrcyBmb3IgZGVsZWdhdGUtYWJsZSBldmVudHM6IG5vdCBgZm9jdXNgLCBgYmx1cmAsIGFuZAogICAgLy8gbm90IGBjaGFuZ2VgLCBgc3VibWl0YCwgYW5kIGByZXNldGAgaW4gSW50ZXJuZXQgRXhwbG9yZXIuCiAgICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oZXZlbnRzKSB7CiAgICAgIGlmICghKGV2ZW50cyB8fCAoZXZlbnRzID0gXy5yZXN1bHQodGhpcywgJ2V2ZW50cycpKSkpIHJldHVybjsKICAgICAgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIGZvciAodmFyIGtleSBpbiBldmVudHMpIHsKICAgICAgICB2YXIgbWV0aG9kID0gZXZlbnRzW2tleV07CiAgICAgICAgaWYgKCFfLmlzRnVuY3Rpb24obWV0aG9kKSkgbWV0aG9kID0gdGhpc1tldmVudHNba2V5XV07CiAgICAgICAgaWYgKCFtZXRob2QpIHRocm93IG5ldyBFcnJvcignTWV0aG9kICInICsgZXZlbnRzW2tleV0gKyAnIiBkb2VzIG5vdCBleGlzdCcpOwogICAgICAgIHZhciBtYXRjaCA9IGtleS5tYXRjaChkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIpOwogICAgICAgIHZhciBldmVudE5hbWUgPSBtYXRjaFsxXSwgc2VsZWN0b3IgPSBtYXRjaFsyXTsKICAgICAgICBtZXRob2QgPSBfLmJpbmQobWV0aG9kLCB0aGlzKTsKICAgICAgICBldmVudE5hbWUgKz0gJy5kZWxlZ2F0ZUV2ZW50cycgKyB0aGlzLmNpZDsKICAgICAgICBpZiAoc2VsZWN0b3IgPT09ICcnKSB7CiAgICAgICAgICB0aGlzLiRlbC5iaW5kKGV2ZW50TmFtZSwgbWV0aG9kKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy4kZWwuZGVsZWdhdGUoc2VsZWN0b3IsIGV2ZW50TmFtZSwgbWV0aG9kKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgLy8gQ2xlYXJzIGFsbCBjYWxsYmFja3MgcHJldmlvdXNseSBib3VuZCB0byB0aGUgdmlldyB3aXRoIGBkZWxlZ2F0ZUV2ZW50c2AuCiAgICAvLyBZb3UgdXN1YWxseSBkb24ndCBuZWVkIHRvIHVzZSB0aGlzLCBidXQgbWF5IHdpc2ggdG8gaWYgeW91IGhhdmUgbXVsdGlwbGUKICAgIC8vIEJhY2tib25lIHZpZXdzIGF0dGFjaGVkIHRvIHRoZSBzYW1lIERPTSBlbGVtZW50LgogICAgdW5kZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLnVuYmluZCgnLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkKTsKICAgIH0sCgogICAgLy8gUGVyZm9ybXMgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbiBvZiBhIFZpZXcgd2l0aCBhIHNldCBvZiBvcHRpb25zLgogICAgLy8gS2V5cyB3aXRoIHNwZWNpYWwgbWVhbmluZyAqKG1vZGVsLCBjb2xsZWN0aW9uLCBpZCwgY2xhc3NOYW1lKSosIGFyZQogICAgLy8gYXR0YWNoZWQgZGlyZWN0bHkgdG8gdGhlIHZpZXcuCiAgICBfY29uZmlndXJlOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmICh0aGlzLm9wdGlvbnMpIG9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ29wdGlvbnMnKSwgb3B0aW9ucyk7CiAgICAgIF8uZXh0ZW5kKHRoaXMsIF8ucGljayhvcHRpb25zLCB2aWV3T3B0aW9ucykpOwogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgfSwKCiAgICAvLyBFbnN1cmUgdGhhdCB0aGUgVmlldyBoYXMgYSBET00gZWxlbWVudCB0byByZW5kZXIgaW50by4KICAgIC8vIElmIGB0aGlzLmVsYCBpcyBhIHN0cmluZywgcGFzcyBpdCB0aHJvdWdoIGAkKClgLCB0YWtlIHRoZSBmaXJzdAogICAgLy8gbWF0Y2hpbmcgZWxlbWVudCwgYW5kIHJlLWFzc2lnbiBpdCB0byBgZWxgLiBPdGhlcndpc2UsIGNyZWF0ZQogICAgLy8gYW4gZWxlbWVudCBmcm9tIHRoZSBgaWRgLCBgY2xhc3NOYW1lYCBhbmQgYHRhZ05hbWVgIHByb3BlcnRpZXMuCiAgICBfZW5zdXJlRWxlbWVudDogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy5lbCkgewogICAgICAgIHZhciBhdHRycyA9IF8uZXh0ZW5kKHt9LCBfLnJlc3VsdCh0aGlzLCAnYXR0cmlidXRlcycpKTsKICAgICAgICBpZiAodGhpcy5pZCkgYXR0cnMuaWQgPSBfLnJlc3VsdCh0aGlzLCAnaWQnKTsKICAgICAgICBpZiAodGhpcy5jbGFzc05hbWUpIGF0dHJzWydjbGFzcyddID0gXy5yZXN1bHQodGhpcywgJ2NsYXNzTmFtZScpOwogICAgICAgIHRoaXMuc2V0RWxlbWVudCh0aGlzLm1ha2UoXy5yZXN1bHQodGhpcywgJ3RhZ05hbWUnKSwgYXR0cnMpLCBmYWxzZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KF8ucmVzdWx0KHRoaXMsICdlbCcpLCBmYWxzZSk7CiAgICAgIH0KICAgIH0KCiAgfSk7CgogIC8vIEJhY2tib25lLnN5bmMKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIE1hcCBmcm9tIENSVUQgdG8gSFRUUCBmb3Igb3VyIGRlZmF1bHQgYEJhY2tib25lLnN5bmNgIGltcGxlbWVudGF0aW9uLgogIHZhciBtZXRob2RNYXAgPSB7CiAgICAnY3JlYXRlJzogJ1BPU1QnLAogICAgJ3VwZGF0ZSc6ICdQVVQnLAogICAgJ3BhdGNoJzogICdQQVRDSCcsCiAgICAnZGVsZXRlJzogJ0RFTEVURScsCiAgICAncmVhZCc6ICAgJ0dFVCcKICB9OwoKICAvLyBPdmVycmlkZSB0aGlzIGZ1bmN0aW9uIHRvIGNoYW5nZSB0aGUgbWFubmVyIGluIHdoaWNoIEJhY2tib25lIHBlcnNpc3RzCiAgLy8gbW9kZWxzIHRvIHRoZSBzZXJ2ZXIuIFlvdSB3aWxsIGJlIHBhc3NlZCB0aGUgdHlwZSBvZiByZXF1ZXN0LCBhbmQgdGhlCiAgLy8gbW9kZWwgaW4gcXVlc3Rpb24uIEJ5IGRlZmF1bHQsIG1ha2VzIGEgUkVTVGZ1bCBBamF4IHJlcXVlc3QKICAvLyB0byB0aGUgbW9kZWwncyBgdXJsKClgLiBTb21lIHBvc3NpYmxlIGN1c3RvbWl6YXRpb25zIGNvdWxkIGJlOgogIC8vCiAgLy8gKiBVc2UgYHNldFRpbWVvdXRgIHRvIGJhdGNoIHJhcGlkLWZpcmUgdXBkYXRlcyBpbnRvIGEgc2luZ2xlIHJlcXVlc3QuCiAgLy8gKiBTZW5kIHVwIHRoZSBtb2RlbHMgYXMgWE1MIGluc3RlYWQgb2YgSlNPTi4KICAvLyAqIFBlcnNpc3QgbW9kZWxzIHZpYSBXZWJTb2NrZXRzIGluc3RlYWQgb2YgQWpheC4KICAvLwogIC8vIFR1cm4gb24gYEJhY2tib25lLmVtdWxhdGVIVFRQYCBpbiBvcmRlciB0byBzZW5kIGBQVVRgIGFuZCBgREVMRVRFYCByZXF1ZXN0cwogIC8vIGFzIGBQT1NUYCwgd2l0aCBhIGBfbWV0aG9kYCBwYXJhbWV0ZXIgY29udGFpbmluZyB0aGUgdHJ1ZSBIVFRQIG1ldGhvZCwKICAvLyBhcyB3ZWxsIGFzIGFsbCByZXF1ZXN0cyB3aXRoIHRoZSBib2R5IGFzIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgCiAgLy8gaW5zdGVhZCBvZiBgYXBwbGljYXRpb24vanNvbmAgd2l0aCB0aGUgbW9kZWwgaW4gYSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIC8vIFVzZWZ1bCB3aGVuIGludGVyZmFjaW5nIHdpdGggc2VydmVyLXNpZGUgbGFuZ3VhZ2VzIGxpa2UgKipQSFAqKiB0aGF0IG1ha2UKICAvLyBpdCBkaWZmaWN1bHQgdG8gcmVhZCB0aGUgYm9keSBvZiBgUFVUYCByZXF1ZXN0cy4KICBCYWNrYm9uZS5zeW5jID0gZnVuY3Rpb24obWV0aG9kLCBtb2RlbCwgb3B0aW9ucykgewogICAgdmFyIHR5cGUgPSBtZXRob2RNYXBbbWV0aG9kXTsKCiAgICAvLyBEZWZhdWx0IG9wdGlvbnMsIHVubGVzcyBzcGVjaWZpZWQuCiAgICBfLmRlZmF1bHRzKG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSksIHsKICAgICAgZW11bGF0ZUhUVFA6IEJhY2tib25lLmVtdWxhdGVIVFRQLAogICAgICBlbXVsYXRlSlNPTjogQmFja2JvbmUuZW11bGF0ZUpTT04KICAgIH0pOwoKICAgIC8vIERlZmF1bHQgSlNPTi1yZXF1ZXN0IG9wdGlvbnMuCiAgICB2YXIgcGFyYW1zID0ge3R5cGU6IHR5cGUsIGRhdGFUeXBlOiAnanNvbid9OwoKICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgYSBVUkwuCiAgICBpZiAoIW9wdGlvbnMudXJsKSB7CiAgICAgIHBhcmFtcy51cmwgPSBfLnJlc3VsdChtb2RlbCwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICB9CgogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSB0aGUgYXBwcm9wcmlhdGUgcmVxdWVzdCBkYXRhLgogICAgaWYgKG9wdGlvbnMuZGF0YSA9PSBudWxsICYmIG1vZGVsICYmIChtZXRob2QgPT09ICdjcmVhdGUnIHx8IG1ldGhvZCA9PT0gJ3VwZGF0ZScgfHwgbWV0aG9kID09PSAncGF0Y2gnKSkgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24vanNvbic7CiAgICAgIHBhcmFtcy5kYXRhID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucy5hdHRycyB8fCBtb2RlbC50b0pTT04ob3B0aW9ucykpOwogICAgfQoKICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEpTT04gYnkgZW5jb2RpbmcgdGhlIHJlcXVlc3QgaW50byBhbiBIVE1MLWZvcm0uCiAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJzsKICAgICAgcGFyYW1zLmRhdGEgPSBwYXJhbXMuZGF0YSA/IHttb2RlbDogcGFyYW1zLmRhdGF9IDoge307CiAgICB9CgogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSFRUUCBieSBtaW1pY2tpbmcgdGhlIEhUVFAgbWV0aG9kIHdpdGggYF9tZXRob2RgCiAgICAvLyBBbmQgYW4gYFgtSFRUUC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICAgIGlmIChvcHRpb25zLmVtdWxhdGVIVFRQICYmICh0eXBlID09PSAnUFVUJyB8fCB0eXBlID09PSAnREVMRVRFJyB8fCB0eXBlID09PSAnUEFUQ0gnKSkgewogICAgICBwYXJhbXMudHlwZSA9ICdQT1NUJzsKICAgICAgaWYgKG9wdGlvbnMuZW11bGF0ZUpTT04pIHBhcmFtcy5kYXRhLl9tZXRob2QgPSB0eXBlOwogICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgb3B0aW9ucy5iZWZvcmVTZW5kID0gZnVuY3Rpb24oeGhyKSB7CiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ1gtSFRUUC1NZXRob2QtT3ZlcnJpZGUnLCB0eXBlKTsKICAgICAgICBpZiAoYmVmb3JlU2VuZCkgcmV0dXJuIGJlZm9yZVNlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KCiAgICAvLyBEb24ndCBwcm9jZXNzIGRhdGEgb24gYSBub24tR0VUIHJlcXVlc3QuCiAgICBpZiAocGFyYW1zLnR5cGUgIT09ICdHRVQnICYmICFvcHRpb25zLmVtdWxhdGVKU09OKSB7CiAgICAgIHBhcmFtcy5wcm9jZXNzRGF0YSA9IGZhbHNlOwogICAgfQoKICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCwgc3RhdHVzLCB4aHIpIHsKICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MocmVzcCwgc3RhdHVzLCB4aHIpOwogICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgfTsKCiAgICB2YXIgZXJyb3IgPSBvcHRpb25zLmVycm9yOwogICAgb3B0aW9ucy5lcnJvciA9IGZ1bmN0aW9uKHhociwgc3RhdHVzLCB0aHJvd24pIHsKICAgICAgaWYgKGVycm9yKSBlcnJvcihtb2RlbCwgeGhyLCBvcHRpb25zKTsKICAgICAgbW9kZWwudHJpZ2dlcignZXJyb3InLCBtb2RlbCwgeGhyLCBvcHRpb25zKTsKICAgIH07CgogICAgLy8gTWFrZSB0aGUgcmVxdWVzdCwgYWxsb3dpbmcgdGhlIHVzZXIgdG8gb3ZlcnJpZGUgYW55IEFqYXggb3B0aW9ucy4KICAgIHZhciB4aHIgPSBCYWNrYm9uZS5hamF4KF8uZXh0ZW5kKHBhcmFtcywgb3B0aW9ucykpOwogICAgbW9kZWwudHJpZ2dlcigncmVxdWVzdCcsIG1vZGVsLCB4aHIsIG9wdGlvbnMpOwogICAgcmV0dXJuIHhocjsKICB9OwoKICAvLyBTZXQgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgYEJhY2tib25lLmFqYXhgIHRvIHByb3h5IHRocm91Z2ggdG8gYCRgLgogIEJhY2tib25lLmFqYXggPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBCYWNrYm9uZS4kLmFqYXguYXBwbHkoQmFja2JvbmUuJCwgYXJndW1lbnRzKTsKICB9OwoKICAvLyBIZWxwZXJzCiAgLy8gLS0tLS0tLQoKICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29ycmVjdGx5IHNldCB1cCB0aGUgcHJvdG90eXBlIGNoYWluLCBmb3Igc3ViY2xhc3Nlcy4KICAvLyBTaW1pbGFyIHRvIGBnb29nLmluaGVyaXRzYCwgYnV0IHVzZXMgYSBoYXNoIG9mIHByb3RvdHlwZSBwcm9wZXJ0aWVzIGFuZAogIC8vIGNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuCiAgdmFyIGV4dGVuZCA9IGZ1bmN0aW9uKHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7CiAgICB2YXIgcGFyZW50ID0gdGhpczsKICAgIHZhciBjaGlsZDsKCiAgICAvLyBUaGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHRoZSBuZXcgc3ViY2xhc3MgaXMgZWl0aGVyIGRlZmluZWQgYnkgeW91CiAgICAvLyAodGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgaW4geW91ciBgZXh0ZW5kYCBkZWZpbml0aW9uKSwgb3IgZGVmYXVsdGVkCiAgICAvLyBieSB1cyB0byBzaW1wbHkgY2FsbCB0aGUgcGFyZW50J3MgY29uc3RydWN0b3IuCiAgICBpZiAocHJvdG9Qcm9wcyAmJiBfLmhhcyhwcm90b1Byb3BzLCAnY29uc3RydWN0b3InKSkgewogICAgICBjaGlsZCA9IHByb3RvUHJvcHMuY29uc3RydWN0b3I7CiAgICB9IGVsc2UgewogICAgICBjaGlsZCA9IGZ1bmN0aW9uKCl7IHBhcmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyB9OwogICAgfQoKICAgIC8vIEFkZCBzdGF0aWMgcHJvcGVydGllcyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24sIGlmIHN1cHBsaWVkLgogICAgXy5leHRlbmQoY2hpbGQsIHBhcmVudCwgc3RhdGljUHJvcHMpOwoKICAgIC8vIFNldCB0aGUgcHJvdG90eXBlIGNoYWluIHRvIGluaGVyaXQgZnJvbSBgcGFyZW50YCwgd2l0aG91dCBjYWxsaW5nCiAgICAvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uKCl7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfTsKICAgIFN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOwogICAgY2hpbGQucHJvdG90eXBlID0gbmV3IFN1cnJvZ2F0ZTsKCiAgICAvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKICAgIC8vIGlmIHN1cHBsaWVkLgogICAgaWYgKHByb3RvUHJvcHMpIF8uZXh0ZW5kKGNoaWxkLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7CgogICAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAogICAgLy8gbGF0ZXIuCiAgICBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOwoKICAgIHJldHVybiBjaGlsZDsKICB9OwoKICAvLyBTZXQgdXAgaW5oZXJpdGFuY2UgZm9yIHRoZSBtb2RlbCwgY29sbGVjdGlvbiwgcm91dGVyLCB2aWV3IGFuZCBoaXN0b3J5LgogIE1vZGVsLmV4dGVuZCA9IENvbGxlY3Rpb24uZXh0ZW5kID0gUm91dGVyLmV4dGVuZCA9IFZpZXcuZXh0ZW5kID0gSGlzdG9yeS5leHRlbmQgPSBleHRlbmQ7CgogIC8vIFRocm93IGFuIGVycm9yIHdoZW4gYSBVUkwgaXMgbmVlZGVkLCBhbmQgbm9uZSBpcyBzdXBwbGllZC4KICB2YXIgdXJsRXJyb3IgPSBmdW5jdGlvbigpIHsKICAgIHRocm93IG5ldyBFcnJvcignQSAidXJsIiBwcm9wZXJ0eSBvciBmdW5jdGlvbiBtdXN0IGJlIHNwZWNpZmllZCcpOwogIH07Cgp9KS5jYWxsKHRoaXMpOwovKgpDb3B5cmlnaHQgKGMpIDIwMTEtMjAxMyBAV2FsbWFydExhYnMKClBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvCmRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlCnJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vcgpzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwpmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgoKVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCgpUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgpJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCkFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcKRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUgpERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiovCgo7OwooZnVuY3Rpb24oKSB7CgovKmdsb2JhbCBjbG9uZUluaGVyaXRWYXJzLCBjcmVhdGVJbmhlcml0VmFycywgY3JlYXRlUmVnaXN0cnlXcmFwcGVyLCBnZXRWYWx1ZSwgaW5oZXJpdFZhcnMgKi8KCi8vc3VwcG9ydCB6ZXB0by5mb3JFYWNoIG9uIGpRdWVyeQppZiAoISQuZm4uZm9yRWFjaCkgewogICQuZm4uZm9yRWFjaCA9IGZ1bmN0aW9uKGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICAkLmZuLmVhY2guY2FsbCh0aGlzLCBmdW5jdGlvbihpbmRleCkgewogICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQgfHwgdGhpcywgdGhpcywgaW5kZXgpOwogICAgfSk7CiAgfTsKfQoKdmFyIHZpZXdOYW1lQXR0cmlidXRlTmFtZSA9ICdkYXRhLXZpZXctbmFtZScsCiAgICB2aWV3Q2lkQXR0cmlidXRlTmFtZSA9ICdkYXRhLXZpZXctY2lkJywKICAgIHZpZXdIZWxwZXJBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtdmlldy1oZWxwZXInOwoKLy92aWV3IGluc3RhbmNlcwp2YXIgdmlld3NJbmRleGVkQnlDaWQgPSB7fTsKCnZhciBUaG9yYXggPSB0aGlzLlRob3JheCA9IHsKICBWRVJTSU9OOiAnMi4wLjBiNicsCiAgdGVtcGxhdGVQYXRoUHJlZml4OiAnJywKICB0ZW1wbGF0ZXM6IHt9LAogIC8vdmlldyBjbGFzc2VzCiAgVmlld3M6IHt9LAogIC8vY2VydGFpbiBlcnJvciBwcm9uZSBwaWVjZXMgb2YgY29kZSAob24gQW5kcm9pZCBvbmx5IGl0IHNlZW1zKQogIC8vYXJlIHdyYXBwZWQgaW4gYSB0cnkgY2F0Y2ggYmxvY2ssIHRoZW4gdHJpZ2dlciB0aGlzIGhhbmRsZXIgaW4KICAvL3RoZSBjYXRjaCwgd2l0aCB0aGUgbmFtZSBvZiB0aGUgZnVuY3Rpb24gb3IgZXZlbnQgdGhhdCB3YXMKICAvL3RyeWluZyB0byBiZSBleGVjdXRlZC4gT3ZlcnJpZGUgdGhpcyB3aXRoIGEgY3VzdG9tIGhhbmRsZXIKICAvL3RvIGRlYnVnIC8gbG9nIC8gZXRjCiAgb25FeGNlcHRpb246IGZ1bmN0aW9uKG5hbWUsIGVycikgewogICAgdGhyb3cgZXJyOwogIH0KfTsKClRob3JheC5WaWV3ID0gQmFja2JvbmUuVmlldy5leHRlbmQoewogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbigpIHsKICAgIHZhciByZXNwb25zZSA9IEJhY2tib25lLlZpZXcuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIF8uZWFjaChpbmhlcml0VmFycywgZnVuY3Rpb24ob2JqKSB7CiAgICAgIGlmIChvYmouY3RvcikgewogICAgICAgIG9iai5jdG9yLmNhbGwodGhpcywgcmVzcG9uc2UpOwogICAgICB9CiAgICB9LCB0aGlzKTsKICAgIHJldHVybiByZXNwb25zZTsKICB9LAogIF9jb25maWd1cmU6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWQgPSB7fTsKICAgIHRoaXMuX2JvdW5kRGF0YU9iamVjdHNCeUNpZCA9IHt9OwoKICAgIC8vIFNldHVwIG9iamVjdCBldmVudCB0cmFja2luZwogICAgXy5lYWNoKGluaGVyaXRWYXJzLCBmdW5jdGlvbihvYmopIHsKICAgICAgc2VsZltvYmoubmFtZV0gPSBbXTsKICAgIH0pOwoKICAgIHZpZXdzSW5kZXhlZEJ5Q2lkW3RoaXMuY2lkXSA9IHRoaXM7CiAgICB0aGlzLmNoaWxkcmVuID0ge307CiAgICB0aGlzLl9yZW5kZXJDb3VudCA9IDA7CgogICAgLy90aGlzLm9wdGlvbnMgaXMgcmVtb3ZlZCBpbiBUaG9yYXguVmlldywgd2UgbWVyZ2UgcGFzc2VkCiAgICAvL3Byb3BlcnRpZXMgZGlyZWN0bHkgd2l0aCB0aGUgdmlldyBhbmQgdGVtcGxhdGUgY29udGV4dAogICAgXy5leHRlbmQodGhpcywgb3B0aW9ucyB8fCB7fSk7CgogICAgLy8gU2V0dXAgaGVscGVycwogICAgYmluZEhlbHBlcnMuY2FsbCh0aGlzKTsKCiAgICAvL2NvbXBpbGUgYSBzdHJpbmcgaWYgaXQgaXMgc2V0IGFzIHRoaXMudGVtcGxhdGUKICAgIGlmICh0eXBlb2YgdGhpcy50ZW1wbGF0ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgdGhpcy50ZW1wbGF0ZSA9IEhhbmRsZWJhcnMuY29tcGlsZSh0aGlzLnRlbXBsYXRlLCB7ZGF0YTogdHJ1ZX0pOwogICAgfSBlbHNlIGlmICh0aGlzLm5hbWUgJiYgIXRoaXMudGVtcGxhdGUpIHsKICAgICAgLy9mZXRjaCB0aGUgdGVtcGxhdGUKICAgICAgdGhpcy50ZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRoaXMubmFtZSwgdHJ1ZSk7CiAgICB9CgogICAgXy5lYWNoKGluaGVyaXRWYXJzLCBmdW5jdGlvbihvYmopIHsKICAgICAgaWYgKG9iai5jb25maWd1cmUpIHsKICAgICAgICBvYmouY29uZmlndXJlLmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0sIHRoaXMpOwogIH0sCgogIHNldEVsZW1lbnQgOiBmdW5jdGlvbigpIHsKICAgIHZhciByZXNwb25zZSA9IEJhY2tib25lLlZpZXcucHJvdG90eXBlLnNldEVsZW1lbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMubmFtZSAmJiB0aGlzLiRlbC5hdHRyKHZpZXdOYW1lQXR0cmlidXRlTmFtZSwgdGhpcy5uYW1lKTsKICAgIHRoaXMuJGVsLmF0dHIodmlld0NpZEF0dHJpYnV0ZU5hbWUsIHRoaXMuY2lkKTsKICAgIHJldHVybiByZXNwb25zZTsKICB9LAoKICBfYWRkQ2hpbGQ6IGZ1bmN0aW9uKHZpZXcpIHsKICAgIHRoaXMuY2hpbGRyZW5bdmlldy5jaWRdID0gdmlldzsKICAgIGlmICghdmlldy5wYXJlbnQpIHsKICAgICAgdmlldy5wYXJlbnQgPSB0aGlzOwogICAgfQogICAgdGhpcy50cmlnZ2VyKCdjaGlsZCcsIHZpZXcpOwogICAgcmV0dXJuIHZpZXc7CiAgfSwKCiAgX3JlbW92ZUNoaWxkOiBmdW5jdGlvbih2aWV3KSB7CiAgICBkZWxldGUgdGhpcy5jaGlsZHJlblt2aWV3LmNpZF07CiAgICB2aWV3LnBhcmVudCA9IG51bGw7CiAgICByZXR1cm4gdmlldzsKICB9LAoKICBkZXN0cm95OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zID0gXy5kZWZhdWx0cyhvcHRpb25zIHx8IHt9LCB7CiAgICAgIGNoaWxkcmVuOiB0cnVlCiAgICB9KTsKICAgIHRoaXMudHJpZ2dlcignZGVzdHJveWVkJyk7CiAgICBkZWxldGUgdmlld3NJbmRleGVkQnlDaWRbdGhpcy5jaWRdOwogICAgXy5lYWNoKHRoaXMuY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgIHRoaXMuX3JlbW92ZUNoaWxkKGNoaWxkKTsKICAgICAgaWYgKG9wdGlvbnMuY2hpbGRyZW4pIHsKICAgICAgICBjaGlsZC5kZXN0cm95KCk7CiAgICAgIH0KICAgIH0sIHRoaXMpOwogICAgdGhpcy5mcmVlemUgJiYgdGhpcy5mcmVlemUoKTsKICB9LAoKICByZW5kZXI6IGZ1bmN0aW9uKG91dHB1dCkgewogICAgdGhpcy5fcHJldmlvdXNIZWxwZXJzID0gXy5maWx0ZXIodGhpcy5jaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQpIHsgcmV0dXJuIGNoaWxkLl9oZWxwZXJPcHRpb25zOyB9KTsKCiAgICB2YXIgY2hpbGRyZW4gPSB7fTsKICAgIF8uZWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCwga2V5KSB7CiAgICAgIGlmICghY2hpbGQuX2hlbHBlck9wdGlvbnMpIHsKICAgICAgICBjaGlsZHJlbltrZXldID0gY2hpbGQ7CiAgICAgIH0KICAgIH0pOwogICAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwoKICAgIGlmICh0eXBlb2Ygb3V0cHV0ID09PSAndW5kZWZpbmVkJyB8fCAoIV8uaXNFbGVtZW50KG91dHB1dCkgJiYgIVRob3JheC5VdGlsLmlzJChvdXRwdXQpICYmICEob3V0cHV0ICYmIG91dHB1dC5lbCkgJiYgdHlwZW9mIG91dHB1dCAhPT0gJ3N0cmluZycgJiYgdHlwZW9mIG91dHB1dCAhPT0gJ2Z1bmN0aW9uJykpIHsKICAgICAgaWYgKCF0aGlzLnRlbXBsYXRlKSB7CiAgICAgICAgLy9pZiB0aGUgbmFtZSB3YXMgc2V0IGFmdGVyIHRoZSB2aWV3IHdhcyBjcmVhdGVkIHRyeSBvbmUgbW9yZSB0aW1lIHRvIGZldGNoIGEgdGVtcGxhdGUKICAgICAgICBpZiAodGhpcy5uYW1lKSB7CiAgICAgICAgICB0aGlzLnRlbXBsYXRlID0gVGhvcmF4LlV0aWwuZ2V0VGVtcGxhdGUodGhpcy5uYW1lLCB0cnVlKTsKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLnRlbXBsYXRlKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1ZpZXcgJyArICh0aGlzLm5hbWUgfHwgdGhpcy5jaWQpICsgJy5yZW5kZXIoKSB3YXMgY2FsbGVkIHdpdGggbm8gY29udGVudCBhbmQgbm8gdGVtcGxhdGUgc2V0IG9uIHRoZSB2aWV3LicpOwogICAgICAgIH0KICAgICAgfQogICAgICBvdXRwdXQgPSB0aGlzLnJlbmRlclRlbXBsYXRlKHRoaXMudGVtcGxhdGUpOwogICAgfSBlbHNlIGlmICh0eXBlb2Ygb3V0cHV0ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIG91dHB1dCA9IHRoaXMucmVuZGVyVGVtcGxhdGUob3V0cHV0KTsKICAgIH0KCiAgICAvLyBEZXN0cm95IGFueSBoZWxwZXJzIHRoYXQgbWF5IGJlIGxpbmdlcmluZwogICAgXy5lYWNoKHRoaXMuX3ByZXZpb3VzSGVscGVycywgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgY2hpbGQuZGVzdHJveSgpOwogICAgICBjaGlsZC5wYXJlbnQgPSB1bmRlZmluZWQ7CiAgICB9KTsKICAgIHRoaXMuX3ByZXZpb3VzSGVscGVycyA9IHVuZGVmaW5lZDsKCiAgICAvL2FjY2VwdCBhIHZpZXcsIHN0cmluZywgSGFuZGxlYmFycy5TYWZlU3RyaW5nIG9yIERPTSBlbGVtZW50CiAgICB0aGlzLmh0bWwoKG91dHB1dCAmJiBvdXRwdXQuZWwpIHx8IChvdXRwdXQgJiYgb3V0cHV0LnN0cmluZykgfHwgb3V0cHV0KTsKICAgICsrdGhpcy5fcmVuZGVyQ291bnQ7CiAgICB0aGlzLnRyaWdnZXIoJ3JlbmRlcmVkJyk7CiAgICByZXR1cm4gb3V0cHV0OwogIH0sCgogIGNvbnRleHQ6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuICh0aGlzLm1vZGVsICYmIHRoaXMubW9kZWwuYXR0cmlidXRlcykgfHwge307CiAgfSwKCiAgX2dldENvbnRleHQ6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIF8uZXh0ZW5kKHt9LCB0aGlzLCBnZXRWYWx1ZSh0aGlzLCAnY29udGV4dCcpIHx8IHt9KTsKICB9LAoKICAvLyBQcml2YXRlIHZhcmlhYmxlcyBpbiBoYW5kbGViYXJzIC8gb3B0aW9ucy5kYXRhIGluIHRlbXBsYXRlIGhlbHBlcnMKICBfZ2V0RGF0YTogZnVuY3Rpb24oZGF0YSkgewogICAgcmV0dXJuIHsKICAgICAgdmlldzogdGhpcywKICAgICAgY2lkOiBfLnVuaXF1ZUlkKCd0JyksCiAgICAgIHlpZWxkOiBmdW5jdGlvbigpIHsKICAgICAgICAvLyBmbiBpcyBzZWVkZWQgYnkgdGVtcGxhdGUgaGVscGVyIHBhc3NpbmcgY29udGV4dCB0byBkYXRhCiAgICAgICAgcmV0dXJuIGRhdGEuZm4gJiYgZGF0YS5mbihkYXRhKTsKICAgICAgfQogICAgfTsKICB9LAoKICBfZ2V0SGVscGVyczogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5oZWxwZXJzKSB7CiAgICAgIHJldHVybiBfLmV4dGVuZCh7fSwgSGFuZGxlYmFycy5oZWxwZXJzLCB0aGlzLmhlbHBlcnMpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIEhhbmRsZWJhcnMuaGVscGVyczsKICAgIH0KCiAgfSwKCiAgcmVuZGVyVGVtcGxhdGU6IGZ1bmN0aW9uKGZpbGUsIGNvbnRleHQsIGlnbm9yZUVycm9ycykgewogICAgdmFyIHRlbXBsYXRlOwogICAgY29udGV4dCA9IGNvbnRleHQgfHwgdGhpcy5fZ2V0Q29udGV4dCgpOwogICAgaWYgKHR5cGVvZiBmaWxlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHRlbXBsYXRlID0gZmlsZTsKICAgIH0gZWxzZSB7CiAgICAgIHRlbXBsYXRlID0gVGhvcmF4LlV0aWwuZ2V0VGVtcGxhdGUoZmlsZSk7CiAgICB9CiAgICBpZiAoIXRlbXBsYXRlKSB7CiAgICAgIGlmIChpZ25vcmVFcnJvcnMpIHsKICAgICAgICByZXR1cm4gJyc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmFibGUgdG8gZmluZCB0ZW1wbGF0ZSAnICsgZmlsZSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0ZW1wbGF0ZShjb250ZXh0LCB7CiAgICAgICAgaGVscGVyczogdGhpcy5fZ2V0SGVscGVycygpLAogICAgICAgIGRhdGE6IHRoaXMuX2dldERhdGEoY29udGV4dCkKICAgICAgfSk7CiAgICB9CiAgfSwKCiAgZW5zdXJlUmVuZGVyZWQ6IGZ1bmN0aW9uKCkgewogICAgIXRoaXMuX3JlbmRlckNvdW50ICYmIHRoaXMucmVuZGVyKCk7CiAgfSwKCiAgYXBwZW5kVG86IGZ1bmN0aW9uKGVsKSB7CiAgICB0aGlzLmVuc3VyZVJlbmRlcmVkKCk7CiAgICAkKGVsKS5hcHBlbmQodGhpcy5lbCk7CiAgICB0aGlzLnRyaWdnZXIoJ3JlYWR5Jyk7CiAgfSwKCiAgaHRtbDogZnVuY3Rpb24oaHRtbCkgewoKICAgIGZ1bmN0aW9uIHJlcGxhY2VIVE1MKHZpZXcpIHsKICAgICAgdmlldy5lbC5pbm5lckhUTUwgPSAiIjsKICAgICAgcmV0dXJuIHZpZXcuJGVsLmFwcGVuZChodG1sKTsKICAgIH0KCiAgICBpZiAodHlwZW9mIGh0bWwgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHJldHVybiB0aGlzLmVsLmlubmVySFRNTDsKICAgIH0gZWxzZSB7CiAgICAgIC8vIEV2ZW50IGZvciBJRSBlbGVtZW50IGZpeGVzCiAgICAgIHRoaXMudHJpZ2dlcignYmVmb3JlOmFwcGVuZCcpOwogICAgICB2YXIgZWxlbWVudDsKICAgICAgaWYgKHRoaXMuY29sbGVjdGlvbiAmJiB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbdGhpcy5jb2xsZWN0aW9uLmNpZF0gJiYgdGhpcy5fcmVuZGVyQ291bnQpIHsKICAgICAgICAvLyBwcmVzZXJ2ZSBjb2xsZWN0aW9uIGVsZW1lbnQgaWYgaXQgd2FzIG5vdCBjcmVhdGVkIHdpdGgge3tjb2xsZWN0aW9ufX0gaGVscGVyCiAgICAgICAgdmFyIG9sZENvbGxlY3Rpb25FbGVtZW50ID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogICAgICAgIGVsZW1lbnQgPSByZXBsYWNlSFRNTCh0aGlzKTsKICAgICAgICBpZiAoIW9sZENvbGxlY3Rpb25FbGVtZW50LmF0dHIoJ2RhdGEtdmlldy1jaWQnKSkgewogICAgICAgICAgdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpLnJlcGxhY2VXaXRoKG9sZENvbGxlY3Rpb25FbGVtZW50KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZWxlbWVudCA9IHJlcGxhY2VIVE1MKHRoaXMpOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlcignYXBwZW5kJyk7CiAgICAgIHJldHVybiBlbGVtZW50OwogICAgfQogIH0sCgogIF9hbmNob3JDbGljazogZnVuY3Rpb24oZXZlbnQpIHsKICAgIHZhciB0YXJnZXQgPSAkKGV2ZW50LmN1cnJlbnRUYXJnZXQpLAogICAgICAgIGhyZWYgPSB0YXJnZXQuYXR0cignaHJlZicpOwogICAgLy8gUm91dGUgYW55dGhpbmcgdGhhdCBzdGFydHMgd2l0aCAjIG9yIC8gKGV4Y2x1ZGluZyAvL2RvbWFpbiB1cmxzKQogICAgaWYgKGhyZWYgJiYgKGhyZWZbMF0gPT09ICcjJyB8fCAoaHJlZlswXSA9PT0gJy8nICYmIGhyZWZbMV0gIT09ICcvJykpKSB7CiAgICAgIEJhY2tib25lLmhpc3RvcnkubmF2aWdhdGUoaHJlZiwgewogICAgICAgIHRyaWdnZXI6IHRydWUKICAgICAgfSk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KfSk7CgpUaG9yYXguVmlldy5leHRlbmQgPSBmdW5jdGlvbigpIHsKICBjcmVhdGVJbmhlcml0VmFycyh0aGlzKTsKCiAgdmFyIGNoaWxkID0gQmFja2JvbmUuVmlldy5leHRlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICBjaGlsZC5fX3BhcmVudF9fID0gdGhpczsKCiAgcmVzZXRJbmhlcml0VmFycyhjaGlsZCk7CgogIHJldHVybiBjaGlsZDsKfTsKCmNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcihUaG9yYXguVmlldywgVGhvcmF4LlZpZXdzKTsKCmZ1bmN0aW9uIGJpbmRIZWxwZXJzKCkgewogIGlmICh0aGlzLmhlbHBlcnMpIHsKICAgIF8uZWFjaCh0aGlzLmhlbHBlcnMsIGZ1bmN0aW9uKGhlbHBlciwgbmFtZSkgewogICAgICB2YXIgdmlldyA9IHRoaXM7CiAgICAgIHRoaXMuaGVscGVyc1tuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gXy50b0FycmF5KGFyZ3VtZW50cyksCiAgICAgICAgICAgIG9wdGlvbnMgPSBfLmxhc3QoYXJncyk7CiAgICAgICAgb3B0aW9ucy5jb250ZXh0ID0gdGhpczsKICAgICAgICByZXR1cm4gaGVscGVyLmFwcGx5KHZpZXcsIGFyZ3MpOwogICAgICB9OwogICAgfSwgdGhpcyk7CiAgfQp9CgovLyQoc2VsZWN0b3IpLnZpZXcoKSBoZWxwZXIKJC5mbi52aWV3ID0gZnVuY3Rpb24ob3B0aW9ucykgewogIG9wdGlvbnMgPSBfLmRlZmF1bHRzKG9wdGlvbnMgfHwge30sIHsKICAgIGhlbHBlcjogdHJ1ZQogIH0pOwogIHZhciBzZWxlY3RvciA9ICdbJyArIHZpZXdDaWRBdHRyaWJ1dGVOYW1lICsgJ10nOwogIGlmICghb3B0aW9ucy5oZWxwZXIpIHsKICAgIHNlbGVjdG9yICs9ICc6bm90KFsnICsgdmlld0hlbHBlckF0dHJpYnV0ZU5hbWUgKyAnXSknOwogIH0KICB2YXIgZWwgPSAkKHRoaXMpLmNsb3Nlc3Qoc2VsZWN0b3IpOwogIHJldHVybiAoZWwgJiYgdmlld3NJbmRleGVkQnlDaWRbZWwuYXR0cih2aWV3Q2lkQXR0cmlidXRlTmFtZSldKSB8fCBmYWxzZTsKfTsKCjs7Ci8qZ2xvYmFsIGNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcjp0cnVlLCBjbG9uZUV2ZW50czogdHJ1ZSAqLwpmdW5jdGlvbiBjcmVhdGVSZWdpc3RyeVdyYXBwZXIoa2xhc3MsIGhhc2gpIHsKICB2YXIgJHN1cGVyID0ga2xhc3MuZXh0ZW5kOwogIGtsYXNzLmV4dGVuZCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGNoaWxkID0gJHN1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBpZiAoY2hpbGQucHJvdG90eXBlLm5hbWUpIHsKICAgICAgaGFzaFtjaGlsZC5wcm90b3R5cGUubmFtZV0gPSBjaGlsZDsKICAgIH0KICAgIHJldHVybiBjaGlsZDsKICB9Owp9CmZ1bmN0aW9uIHJlZ2lzdHJ5R2V0KG9iamVjdCwgdHlwZSwgbmFtZSwgaWdub3JlRXJyb3JzKSB7CiAgdmFyIHRhcmdldCA9IG9iamVjdFt0eXBlXSwKICAgICAgdmFsdWU7CiAgaWYgKG5hbWUuaW5kZXhPZignLicpID49IDApIHsKICAgIHZhciBiaXRzID0gbmFtZS5zcGxpdCgvXC4vKTsKICAgIG5hbWUgPSBiaXRzLnBvcCgpOwogICAgXy5lYWNoKGJpdHMsIGZ1bmN0aW9uKGtleSkgewogICAgICB0YXJnZXQgPSB0YXJnZXRba2V5XTsKICAgIH0pOwogIH0KICB0YXJnZXQgJiYgKHZhbHVlID0gdGFyZ2V0W25hbWVdKTsKICBpZiAoIXZhbHVlICYmICFpZ25vcmVFcnJvcnMpIHsKICAgIHRocm93IG5ldyBFcnJvcih0eXBlICsgJzogJyArIG5hbWUgKyAnIGRvZXMgbm90IGV4aXN0LicpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQp9CgovLyBnZXRWYWx1ZSBpcyB1c2VkIGluc3RlYWQgb2YgXy5yZXN1bHQgYmVjYXVzZSB3ZQovLyBuZWVkIGFuIGV4dHJhIHNjb3BlIHBhcmFtZXRlciwgYW5kIHdpbGwgbWluaWZ5Ci8vIGJldHRlciB0aGFuIF8ucmVzdWx0CmZ1bmN0aW9uIGdldFZhbHVlKG9iamVjdCwgcHJvcCwgc2NvcGUpIHsKICBpZiAoIShvYmplY3QgJiYgb2JqZWN0W3Byb3BdKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiBfLmlzRnVuY3Rpb24ob2JqZWN0W3Byb3BdKQogICAgPyBvYmplY3RbcHJvcF0uY2FsbChzY29wZSB8fCBvYmplY3QpCiAgICA6IG9iamVjdFtwcm9wXTsKfQoKdmFyIGluaGVyaXRWYXJzID0ge307CmZ1bmN0aW9uIGNyZWF0ZUluaGVyaXRWYXJzKHNlbGYpIHsKICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIG91ciBzdGF0aWMgZXZlbnQgb2JqZWN0cwogIF8uZWFjaChpbmhlcml0VmFycywgZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIXNlbGZbb2JqLm5hbWVdKSB7CiAgICAgIHNlbGZbb2JqLm5hbWVdID0gW107CiAgICB9CiAgfSk7Cn0KZnVuY3Rpb24gcmVzZXRJbmhlcml0VmFycyhzZWxmKSB7CiAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSBvdXIgc3RhdGljIGV2ZW50IG9iamVjdHMKICBfLmVhY2goaW5oZXJpdFZhcnMsIGZ1bmN0aW9uKG9iaikgewogICAgc2VsZltvYmoubmFtZV0gPSBbXTsKICB9KTsKfQpmdW5jdGlvbiB3YWxrSW5oZXJpdFRyZWUoc291cmNlLCBmaWVsZE5hbWUsIGlzU3RhdGljLCBjYWxsYmFjaykgewogIHZhciB0cmVlID0gW107CiAgaWYgKF8uaGFzKHNvdXJjZSwgZmllbGROYW1lKSkgewogICAgdHJlZS5wdXNoKHNvdXJjZSk7CiAgfQogIHZhciBpdGVyYXRlID0gc291cmNlOwogIGlmIChpc1N0YXRpYykgewogICAgd2hpbGUgKGl0ZXJhdGUgPSBpdGVyYXRlLl9fcGFyZW50X18pIHsKICAgICAgaWYgKF8uaGFzKGl0ZXJhdGUsIGZpZWxkTmFtZSkpIHsKICAgICAgICB0cmVlLnB1c2goaXRlcmF0ZSk7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgaXRlcmF0ZSA9IGl0ZXJhdGUuY29uc3RydWN0b3I7CiAgICB3aGlsZSAoaXRlcmF0ZSkgewogICAgICBpZiAoaXRlcmF0ZS5wcm90b3R5cGUgJiYgXy5oYXMoaXRlcmF0ZS5wcm90b3R5cGUsIGZpZWxkTmFtZSkpIHsKICAgICAgICB0cmVlLnB1c2goaXRlcmF0ZS5wcm90b3R5cGUpOwogICAgICB9CiAgICAgIGl0ZXJhdGUgPSBpdGVyYXRlLl9fc3VwZXJfXyAmJiBpdGVyYXRlLl9fc3VwZXJfXy5jb25zdHJ1Y3RvcjsKICAgIH0KICB9CgogIHZhciBpID0gdHJlZS5sZW5ndGg7CiAgd2hpbGUgKGktLSkgewogICAgXy5lYWNoKGdldFZhbHVlKHRyZWVbaV0sIGZpZWxkTmFtZSwgc291cmNlKSwgY2FsbGJhY2spOwogIH0KfQoKZnVuY3Rpb24gb2JqZWN0RXZlbnRzKHRhcmdldCwgZXZlbnROYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogIGlmIChfLmlzT2JqZWN0KGNhbGxiYWNrKSkgewogICAgdmFyIHNwZWMgPSBpbmhlcml0VmFyc1tldmVudE5hbWVdOwogICAgaWYgKHNwZWMgJiYgc3BlYy5ldmVudCkgewogICAgICBhZGRFdmVudHModGFyZ2V0WydfJyArIGV2ZW50TmFtZSArICdFdmVudHMnXSwgY2FsbGJhY2ssIGNvbnRleHQpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9Cn0KZnVuY3Rpb24gYWRkRXZlbnRzKHRhcmdldCwgc291cmNlLCBjb250ZXh0KSB7CiAgXy5lYWNoKHNvdXJjZSwgZnVuY3Rpb24oY2FsbGJhY2ssIGV2ZW50TmFtZSkgewogICAgaWYgKF8uaXNBcnJheShjYWxsYmFjaykpIHsKICAgICAgXy5lYWNoKGNhbGxiYWNrLCBmdW5jdGlvbihjYikgewogICAgICAgIHRhcmdldC5wdXNoKFtldmVudE5hbWUsIGNiLCBjb250ZXh0XSk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgdGFyZ2V0LnB1c2goW2V2ZW50TmFtZSwgY2FsbGJhY2ssIGNvbnRleHRdKTsKICAgIH0KICB9KTsKfQoKZnVuY3Rpb24gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykgewogIGlmICghb3B0aW9ucyB8fCAhb3B0aW9ucy5kYXRhKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0hhbmRsZWJhcnMgdGVtcGxhdGUgY29tcGlsZWQgd2l0aG91dCBkYXRhLCB1c2U6IEhhbmRsZWJhcnMuY29tcGlsZSh0ZW1wbGF0ZSwge2RhdGE6IHRydWV9KScpOwogIH0KICByZXR1cm4gb3B0aW9ucy5kYXRhOwp9CgpUaG9yYXguVXRpbCA9IHsKICBnZXRWaWV3SW5zdGFuY2U6IGZ1bmN0aW9uKG5hbWUsIGF0dHJpYnV0ZXMpIHsKICAgIGF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzIHx8IHt9OwogICAgYXR0cmlidXRlc1snY2xhc3MnXSAmJiAoYXR0cmlidXRlcy5jbGFzc05hbWUgPSBhdHRyaWJ1dGVzWydjbGFzcyddKTsKICAgIGF0dHJpYnV0ZXMudGFnICYmIChhdHRyaWJ1dGVzLnRhZ05hbWUgPSBhdHRyaWJ1dGVzLnRhZyk7CiAgICBpZiAodHlwZW9mIG5hbWUgPT09ICdzdHJpbmcnKSB7CiAgICAgIHZhciBLbGFzcyA9IHJlZ2lzdHJ5R2V0KFRob3JheCwgJ1ZpZXdzJywgbmFtZSwgZmFsc2UpOwogICAgICByZXR1cm4gS2xhc3MuY2lkID8gXy5leHRlbmQoS2xhc3MsIGF0dHJpYnV0ZXMgfHwge30pIDogbmV3IEtsYXNzKGF0dHJpYnV0ZXMpOwogICAgfSBlbHNlIGlmICh0eXBlb2YgbmFtZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICByZXR1cm4gbmV3IG5hbWUoYXR0cmlidXRlcyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbmFtZTsKICAgIH0KICB9LAoKICBnZXRUZW1wbGF0ZTogZnVuY3Rpb24oZmlsZSwgaWdub3JlRXJyb3JzKSB7CiAgICAvL2FwcGVuZCB0aGUgdGVtcGxhdGUgcGF0aCBwcmVmaXggaWYgaXQgaXMgbWlzc2luZwogICAgdmFyIHBhdGhQcmVmaXggPSBUaG9yYXgudGVtcGxhdGVQYXRoUHJlZml4LAogICAgICAgIHRlbXBsYXRlOwogICAgaWYgKHBhdGhQcmVmaXggJiYgZmlsZS5zdWJzdHIoMCwgcGF0aFByZWZpeC5sZW5ndGgpICE9PSBwYXRoUHJlZml4KSB7CiAgICAgIGZpbGUgPSBwYXRoUHJlZml4ICsgZmlsZTsKICAgIH0KCiAgICAvLyBXaXRob3V0IGV4dGVuc2lvbgogICAgZmlsZSA9IGZpbGUucmVwbGFjZSgvXC5oYW5kbGViYXJzJC8sICcnKTsKICAgIHRlbXBsYXRlID0gVGhvcmF4LnRlbXBsYXRlc1tmaWxlXTsKICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgLy8gV2l0aCBleHRlbnNpb24KICAgICAgZmlsZSA9IGZpbGUgKyAnLmhhbmRsZWJhcnMnOwogICAgICB0ZW1wbGF0ZSA9IFRob3JheC50ZW1wbGF0ZXNbZmlsZV07CiAgICB9CgogICAgaWYgKHRlbXBsYXRlICYmIHR5cGVvZiB0ZW1wbGF0ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgdGVtcGxhdGUgPSBUaG9yYXgudGVtcGxhdGVzW2ZpbGVdID0gSGFuZGxlYmFycy5jb21waWxlKHRlbXBsYXRlLCB7ZGF0YTogdHJ1ZX0pOwogICAgfSBlbHNlIGlmICghdGVtcGxhdGUgJiYgIWlnbm9yZUVycm9ycykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ3RlbXBsYXRlczogJyArIGZpbGUgKyAnIGRvZXMgbm90IGV4aXN0LicpOwogICAgfQogICAgcmV0dXJuIHRlbXBsYXRlOwogIH0sCgogIC8vJ3NlbGVjdG9yJyBpcyBub3QgcHJlc2VudCBpbiAkKCc8cD48L3A+JykKICAvL1RPRE86IGludmVzdGlnYWdlIGEgYmV0dGVyIGRldGVjdGlvbiBtZXRob2QKICBpcyQ6IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICdvYmplY3QnICYmICgnbGVuZ3RoJyBpbiBvYmopOwogIH0sCiAgZXhwYW5kVG9rZW46IGZ1bmN0aW9uKGlucHV0LCBzY29wZSkgewogICAgaWYgKGlucHV0ICYmIGlucHV0LmluZGV4T2YgJiYgaW5wdXQuaW5kZXhPZigne3snKSA+PSAwKSB7CiAgICAgIHZhciByZSA9IC8oPzpcez9bXntdKyl8KD86XHtceyhbXn1dKylcfVx9KS9nLAogICAgICAgICAgbWF0Y2gsCiAgICAgICAgICByZXQgPSBbXTsKICAgICAgZnVuY3Rpb24gZGVyZWYodG9rZW4sIHNjb3BlKSB7CiAgICAgICAgaWYgKHRva2VuLm1hdGNoKC9eKCJ8JykvKSAmJiB0b2tlbi5tYXRjaCgvKCJ8JykkLykpIHsKICAgICAgICAgIHJldHVybiB0b2tlbi5yZXBsYWNlKC8oXigifCcpfCgnfCIpJCkvZywgJycpOwogICAgICAgIH0KICAgICAgICB2YXIgc2VnbWVudHMgPSB0b2tlbi5zcGxpdCgnLicpLAogICAgICAgICAgICBsZW4gPSBzZWdtZW50cy5sZW5ndGg7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IHNjb3BlICYmIGkgPCBsZW47IGkrKykgewogICAgICAgICAgaWYgKHNlZ21lbnRzW2ldICE9PSAndGhpcycpIHsKICAgICAgICAgICAgc2NvcGUgPSBzY29wZVtzZWdtZW50c1tpXV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzY29wZTsKICAgICAgfQogICAgICB3aGlsZSAobWF0Y2ggPSByZS5leGVjKGlucHV0KSkgewogICAgICAgIGlmIChtYXRjaFsxXSkgewogICAgICAgICAgdmFyIHBhcmFtcyA9IG1hdGNoWzFdLnNwbGl0KC9ccysvKTsKICAgICAgICAgIGlmIChwYXJhbXMubGVuZ3RoID4gMSkgewogICAgICAgICAgICB2YXIgaGVscGVyID0gcGFyYW1zLnNoaWZ0KCk7CiAgICAgICAgICAgIHBhcmFtcyA9IF8ubWFwKHBhcmFtcywgZnVuY3Rpb24ocGFyYW0pIHsgcmV0dXJuIGRlcmVmKHBhcmFtLCBzY29wZSk7IH0pOwogICAgICAgICAgICBpZiAoSGFuZGxlYmFycy5oZWxwZXJzW2hlbHBlcl0pIHsKICAgICAgICAgICAgICByZXQucHVzaChIYW5kbGViYXJzLmhlbHBlcnNbaGVscGVyXS5hcHBseShzY29wZSwgcGFyYW1zKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gSWYgdGhlIGhlbHBlciBpcyBub3QgZGVmaW5lZCBkbyBub3RoaW5nCiAgICAgICAgICAgICAgcmV0LnB1c2gobWF0Y2hbMF0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXQucHVzaChkZXJlZihwYXJhbXNbMF0sIHNjb3BlKSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldC5wdXNoKG1hdGNoWzBdKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaW5wdXQgPSByZXQuam9pbignJyk7CiAgICB9CiAgICByZXR1cm4gaW5wdXQ7CiAgfSwKICB0YWc6IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIGNvbnRlbnQsIHNjb3BlKSB7CiAgICB2YXIgaHRtbEF0dHJpYnV0ZXMgPSBfLm9taXQoYXR0cmlidXRlcywgJ3RhZycsICd0YWdOYW1lJyksCiAgICAgICAgdGFnID0gYXR0cmlidXRlcy50YWcgfHwgYXR0cmlidXRlcy50YWdOYW1lIHx8ICdkaXYnOwogICAgcmV0dXJuICc8JyArIHRhZyArICcgJyArIF8ubWFwKGh0bWxBdHRyaWJ1dGVzLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICd1bmRlZmluZWQnIHx8IGtleSA9PT0gJ2V4cGFuZC10b2tlbnMnKSB7CiAgICAgICAgcmV0dXJuICcnOwogICAgICB9CiAgICAgIHZhciBmb3JtYXR0ZWRWYWx1ZSA9IHZhbHVlOwogICAgICBpZiAoc2NvcGUpIHsKICAgICAgICBmb3JtYXR0ZWRWYWx1ZSA9IFRob3JheC5VdGlsLmV4cGFuZFRva2VuKHZhbHVlLCBzY29wZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGtleSArICc9IicgKyBIYW5kbGViYXJzLlV0aWxzLmVzY2FwZUV4cHJlc3Npb24oZm9ybWF0dGVkVmFsdWUpICsgJyInOwogICAgfSkuam9pbignICcpICsgJz4nICsgKHR5cGVvZiBjb250ZW50ID09PSAndW5kZWZpbmVkJyA/ICcnIDogY29udGVudCkgKyAnPC8nICsgdGFnICsgJz4nOwogIH0sCiAgaHRtbEF0dHJpYnV0ZXNGcm9tT3B0aW9uczogZnVuY3Rpb24ob3B0aW9ucykgewogICAgdmFyIGh0bWxBdHRyaWJ1dGVzID0ge307CiAgICBpZiAob3B0aW9ucy50YWcpIHsKICAgICAgaHRtbEF0dHJpYnV0ZXMudGFnID0gb3B0aW9ucy50YWc7CiAgICB9CiAgICBpZiAob3B0aW9ucy50YWdOYW1lKSB7CiAgICAgIGh0bWxBdHRyaWJ1dGVzLnRhZ05hbWUgPSBvcHRpb25zLnRhZ05hbWU7CiAgICB9CiAgICBpZiAob3B0aW9uc1snY2xhc3MnXSkgewogICAgICBodG1sQXR0cmlidXRlc1snY2xhc3MnXSA9IG9wdGlvbnNbJ2NsYXNzJ107CiAgICB9CiAgICBpZiAob3B0aW9ucy5pZCkgewogICAgICBodG1sQXR0cmlidXRlcy5pZCA9IG9wdGlvbnMuaWQ7CiAgICB9CiAgICByZXR1cm4gaHRtbEF0dHJpYnV0ZXM7CiAgfQp9OwoKOzsKLypnbG9iYWwgY3JlYXRlSW5oZXJpdFZhcnMsIGluaGVyaXRWYXJzICovClRob3JheC5NaXhpbnMgPSB7fTsKCmluaGVyaXRWYXJzLm1peGlucyA9IHsKICBuYW1lOiAnbWl4aW5zJywKICBjb25maWd1cmU6IGZ1bmN0aW9uKCkgewogICAgXy5lYWNoKHRoaXMuY29uc3RydWN0b3IubWl4aW5zLCB0aGlzLm1peGluLCB0aGlzKTsKICAgIF8uZWFjaCh0aGlzLm1peGlucywgdGhpcy5taXhpbiwgdGhpcyk7CiAgfQp9OwoKXy5leHRlbmQoVGhvcmF4LlZpZXcsIHsKICBtaXhpbjogZnVuY3Rpb24obWl4aW4pIHsKICAgIGNyZWF0ZUluaGVyaXRWYXJzKHRoaXMpOwogICAgdGhpcy5taXhpbnMucHVzaChtaXhpbik7CiAgfSwKICByZWdpc3Rlck1peGluOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgbWV0aG9kcykgewogICAgVGhvcmF4Lk1peGluc1tuYW1lXSA9IFtjYWxsYmFjaywgbWV0aG9kc107CiAgfQp9KTsKClRob3JheC5WaWV3LnByb3RvdHlwZS5taXhpbiA9IGZ1bmN0aW9uKG5hbWUpIHsKICBpZiAoIXRoaXMuX2FwcGxpZWRNaXhpbnMpIHsKICAgIHRoaXMuX2FwcGxpZWRNaXhpbnMgPSBbXTsKICB9CiAgaWYgKHRoaXMuX2FwcGxpZWRNaXhpbnMuaW5kZXhPZihuYW1lKSA9PT0gLTEpIHsKICAgIHRoaXMuX2FwcGxpZWRNaXhpbnMucHVzaChuYW1lKTsKICAgIGlmICh0eXBlb2YgbmFtZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBuYW1lLmNhbGwodGhpcyk7CiAgICB9IGVsc2UgewogICAgICB2YXIgbWl4aW4gPSBUaG9yYXguTWl4aW5zW25hbWVdOwogICAgICBfLmV4dGVuZCh0aGlzLCBtaXhpblsxXSk7CiAgICAgIC8vbWl4aW4gY2FsbGJhY2sgbWF5IGJlIGFuIGFycmF5IG9mIFtjYWxsYmFjaywgYXJndW1lbnRzXQogICAgICBpZiAoXy5pc0FycmF5KG1peGluWzBdKSkgewogICAgICAgIG1peGluWzBdWzBdLmFwcGx5KHRoaXMsIG1peGluWzBdWzFdKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtaXhpblswXS5hcHBseSh0aGlzLCBfLnRvQXJyYXkoYXJndW1lbnRzKS5zbGljZSgxKSk7CiAgICAgIH0KICAgIH0KICB9Cn07Cgo7OwovKmdsb2JhbCBjcmVhdGVJbmhlcml0VmFycywgaW5oZXJpdFZhcnMsIG9iamVjdEV2ZW50cywgd2Fsa0luaGVyaXRUcmVlICovCi8vIFNhdmUgYSBjb3B5IG9mIHRoZSBfb24gbWV0aG9kIHRvIGNhbGwgYXMgYSAkc3VwZXIgbWV0aG9kCnZhciBfb24gPSBUaG9yYXguVmlldy5wcm90b3R5cGUub247Cgppbmhlcml0VmFycy5ldmVudCA9IHsKICBuYW1lOiAnX2V2ZW50cycsCgogIGNvbmZpZ3VyZTogZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB3YWxrSW5oZXJpdFRyZWUodGhpcy5jb25zdHJ1Y3RvciwgJ19ldmVudHMnLCB0cnVlLCBmdW5jdGlvbihldmVudCkgewogICAgICBzZWxmLm9uLmFwcGx5KHNlbGYsIGV2ZW50KTsKICAgIH0pOwogICAgd2Fsa0luaGVyaXRUcmVlKHRoaXMsICdldmVudHMnLCBmYWxzZSwgZnVuY3Rpb24oaGFuZGxlciwgZXZlbnROYW1lKSB7CiAgICAgIHNlbGYub24oZXZlbnROYW1lLCBoYW5kbGVyLCBzZWxmKTsKICAgIH0pOwogIH0KfTsKCl8uZXh0ZW5kKFRob3JheC5WaWV3LCB7CiAgb246IGZ1bmN0aW9uKGV2ZW50TmFtZSwgY2FsbGJhY2spIHsKICAgIGNyZWF0ZUluaGVyaXRWYXJzKHRoaXMpOwoKICAgIGlmIChvYmplY3RFdmVudHModGhpcywgZXZlbnROYW1lLCBjYWxsYmFjaykpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgLy9hY2NlcHQgb24oeyJyZW5kZXJlZCI6IGhhbmRsZXJ9KQogICAgaWYgKHR5cGVvZiBldmVudE5hbWUgPT09ICdvYmplY3QnKSB7CiAgICAgIF8uZWFjaChldmVudE5hbWUsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICB0aGlzLm9uKGtleSwgdmFsdWUpOwogICAgICB9LCB0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vYWNjZXB0IG9uKHsicmVuZGVyZWQiOiBbaGFuZGxlciwgaGFuZGxlcl19KQogICAgICBpZiAoXy5pc0FycmF5KGNhbGxiYWNrKSkgewogICAgICAgIF8uZWFjaChjYWxsYmFjaywgZnVuY3Rpb24oY2IpIHsKICAgICAgICAgIHRoaXMuX2V2ZW50cy5wdXNoKFtldmVudE5hbWUsIGNiXSk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgIC8vYWNjZXB0IG9uKCJyZW5kZXJlZCIsIGhhbmRsZXIpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fZXZlbnRzLnB1c2goW2V2ZW50TmFtZSwgY2FsbGJhY2tdKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQp9KTsKCl8uZXh0ZW5kKFRob3JheC5WaWV3LnByb3RvdHlwZSwgewogIGZyZWV6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgXy5lYWNoKHRoaXMuX2JvdW5kRGF0YU9iamVjdHNCeUNpZCwgdGhpcy51bmJpbmREYXRhT2JqZWN0LCB0aGlzKTsKICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKG9wdGlvbnMgfHwge30sIHsKICAgICAgZG9tOiB0cnVlLAogICAgICBjaGlsZHJlbjogdHJ1ZQogICAgfSk7CiAgICB0aGlzLm9mZigpOwogICAgaWYgKG9wdGlvbnMuZG9tKSB7CiAgICAgIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgfQogICAgdGhpcy50cmlnZ2VyKCdmcmVlemUnKTsKICAgIGlmIChvcHRpb25zLmNoaWxkcmVuKSB7CiAgICAgIF8uZWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgICAgIGNoaWxkLmZyZWV6ZShvcHRpb25zKTsKICAgICAgfSwgdGhpcyk7CiAgICB9CiAgfSwKICBvbjogZnVuY3Rpb24oZXZlbnROYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgaWYgKG9iamVjdEV2ZW50cyh0aGlzLCBldmVudE5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICBpZiAodHlwZW9mIGV2ZW50TmFtZSA9PT0gJ29iamVjdCcgJiYgYXJndW1lbnRzLmxlbmd0aCA8IDMpIHsKICAgICAgLy9hY2NlcHQgb24oeyJyZW5kZXJlZCI6IGNhbGxiYWNrfSkKICAgICAgXy5lYWNoKGV2ZW50TmFtZSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIHRoaXMub24oa2V5LCB2YWx1ZSwgY2FsbGJhY2sgfHwgdGhpcyk7ICAgIC8vIGNhbGxiYWNrIGlzIGNvbnRleHQgaW4gdGhpcyBmb3JtIG9mIHRoZSBjYWxsCiAgICAgIH0sIHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgLy9hY2NlcHQgb24oInJlbmRlcmVkIiwgY2FsbGJhY2ssIGNvbnRleHQpCiAgICAgIC8vYWNjZXB0IG9uKCJjbGljayBhIiwgY2FsbGJhY2ssIGNvbnRleHQpCiAgICAgIF8uZWFjaCgoXy5pc0FycmF5KGNhbGxiYWNrKSA/IGNhbGxiYWNrIDogW2NhbGxiYWNrXSksIGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIHBhcmFtcyA9IGV2ZW50UGFyYW1zRnJvbUV2ZW50SXRlbS5jYWxsKHRoaXMsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIGNvbnRleHQgfHwgdGhpcyk7CiAgICAgICAgaWYgKHBhcmFtcy50eXBlID09PSAnRE9NJykgewogICAgICAgICAgLy93aWxsIGNhbGwgX2FkZEV2ZW50IGR1cmluZyBkZWxlZ2F0ZUV2ZW50cygpCiAgICAgICAgICBpZiAoIXRoaXMuX2V2ZW50c1RvRGVsZWdhdGUpIHsKICAgICAgICAgICAgdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSA9IFtdOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZS5wdXNoKHBhcmFtcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuX2FkZEV2ZW50KHBhcmFtcyk7CiAgICAgICAgfQogICAgICB9LCB0aGlzKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0sCiAgZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cykgewogICAgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICBpZiAoZXZlbnRzKSB7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24oZXZlbnRzKSkgewogICAgICAgIGV2ZW50cyA9IGV2ZW50cy5jYWxsKHRoaXMpOwogICAgICB9CiAgICAgIHRoaXMuX2V2ZW50c1RvRGVsZWdhdGUgPSBbXTsKICAgICAgdGhpcy5vbihldmVudHMpOwogICAgfQogICAgdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSAmJiBfLmVhY2godGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSwgdGhpcy5fYWRkRXZlbnQsIHRoaXMpOwogIH0sCiAgLy9wYXJhbXMgbWF5IGNvbnRhaW46CiAgLy8tIG5hbWUKICAvLy0gb3JpZ2luYWxOYW1lCiAgLy8tIHNlbGVjdG9yCiAgLy8tIHR5cGUgInZpZXciIHx8ICJET00iCiAgLy8tIGhhbmRsZXIKICBfYWRkRXZlbnQ6IGZ1bmN0aW9uKHBhcmFtcykgewogICAgaWYgKHBhcmFtcy50eXBlID09PSAndmlldycpIHsKICAgICAgXy5lYWNoKHBhcmFtcy5uYW1lLnNwbGl0KC9ccysvKSwgZnVuY3Rpb24obmFtZSkgewogICAgICAgIF9vbi5jYWxsKHRoaXMsIG5hbWUsIGJpbmRFdmVudEhhbmRsZXIuY2FsbCh0aGlzLCAndmlldy1ldmVudDonLCBwYXJhbXMpKTsKICAgICAgfSwgdGhpcyk7CiAgICB9IGVsc2UgewogICAgICB2YXIgYm91bmRIYW5kbGVyID0gYmluZEV2ZW50SGFuZGxlci5jYWxsKHRoaXMsICdkb20tZXZlbnQ6JywgcGFyYW1zKTsKICAgICAgaWYgKCFwYXJhbXMubmVzdGVkKSB7CiAgICAgICAgYm91bmRIYW5kbGVyID0gY29udGFpbkhhbmRsZXJUb0N1cmVudFZpZXcoYm91bmRIYW5kbGVyLCB0aGlzLmNpZCk7CiAgICAgIH0KICAgICAgaWYgKHBhcmFtcy5zZWxlY3RvcikgewogICAgICAgIHZhciBuYW1lID0gcGFyYW1zLm5hbWUgKyAnLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkOwogICAgICAgIHRoaXMuJGVsLm9uKG5hbWUsIHBhcmFtcy5zZWxlY3RvciwgYm91bmRIYW5kbGVyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLiRlbC5vbihwYXJhbXMubmFtZSwgYm91bmRIYW5kbGVyKTsKICAgICAgfQogICAgfQogIH0KfSk7CgovLyBwcm9wYWdhdGUgcmVhZHkgZXZlbnQgdG8gY2hpbGRyZW4KZnVuY3Rpb24gdHJpZ2dlclJlYWR5KHZpZXcpIHsKICB2aWV3LnRyaWdnZXIoJ3JlYWR5Jyk7Cn0KCi8vIFdoZW4gdmlldyBpcyByZWFkeSB0cmlnZ2VyIHJlYWR5IGV2ZW50IG9uIGFsbAovLyBjaGlsZHJlbiB0aGF0IGFyZSBwcmVzZW50LCB0aGVuIHJlZ2lzdGVyIGFuCi8vIGV2ZW50IHRoYXQgd2lsbCB0cmlnZ2VyIHJlYWR5IG9uIG5ldyBjaGlsZHJlbgovLyB3aGVuIHRoZXkgYXJlIGFkZGVkClRob3JheC5WaWV3Lm9uKCdyZWFkeScsIGZ1bmN0aW9uKCkgewogIGlmICghdGhpcy5faXNSZWFkeSkgewogICAgdGhpcy5faXNSZWFkeSA9IHRydWU7CiAgICBfLmVhY2godGhpcy5jaGlsZHJlbiwgdHJpZ2dlclJlYWR5KTsKICAgIHRoaXMub24oJ2NoaWxkJywgdHJpZ2dlclJlYWR5KTsKICB9Cn0pOwoKdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXihuZXN0ZWRccyspPyhcUyspKD86XHMrKC4rKSk/LzsKCnZhciBkb21FdmVudHMgPSBbXSwKICAgIGRvbUV2ZW50UmVnZXhwOwpmdW5jdGlvbiBwdXNoRG9tRXZlbnRzKGV2ZW50cykgewogIGRvbUV2ZW50cy5wdXNoLmFwcGx5KGRvbUV2ZW50cywgZXZlbnRzKTsKICBkb21FdmVudFJlZ2V4cCA9IG5ldyBSZWdFeHAoJ14obmVzdGVkXFxzKyk/KCcgKyBkb21FdmVudHMuam9pbignfCcpICsgJykoPzpcXHN8JCknKTsKfQpwdXNoRG9tRXZlbnRzKFsKICAnbW91c2Vkb3duJywgJ21vdXNldXAnLCAnbW91c2Vtb3ZlJywgJ21vdXNlb3ZlcicsICdtb3VzZW91dCcsCiAgJ3RvdWNoc3RhcnQnLCAndG91Y2hlbmQnLCAndG91Y2htb3ZlJywKICAnY2xpY2snLCAnZGJsY2xpY2snLAogICdrZXl1cCcsICdrZXlkb3duJywgJ2tleXByZXNzJywKICAnc3VibWl0JywgJ2NoYW5nZScsCiAgJ2ZvY3VzJywgJ2JsdXInCl0pOwoKZnVuY3Rpb24gY29udGFpbkhhbmRsZXJUb0N1cmVudFZpZXcoaGFuZGxlciwgY2lkKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICB2YXIgdmlldyA9ICQoZXZlbnQudGFyZ2V0KS52aWV3KHtoZWxwZXI6IGZhbHNlfSk7CiAgICBpZiAodmlldyAmJiB2aWV3LmNpZCA9PT0gY2lkKSB7CiAgICAgIGV2ZW50Lm9yaWdpbmFsQ29udGV4dCA9IHRoaXM7CiAgICAgIGhhbmRsZXIoZXZlbnQpOwogICAgfQogIH07Cn0KCmZ1bmN0aW9uIGJpbmRFdmVudEhhbmRsZXIoZXZlbnROYW1lLCBwYXJhbXMpIHsKICBldmVudE5hbWUgKz0gcGFyYW1zLm9yaWdpbmFsTmFtZTsKCiAgdmFyIGNhbGxiYWNrID0gcGFyYW1zLmhhbmRsZXIsCiAgICAgIG1ldGhvZCA9IHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJyA/IGNhbGxiYWNrIDogdGhpc1tjYWxsYmFja107CiAgaWYgKCFtZXRob2QpIHsKICAgIHRocm93IG5ldyBFcnJvcignRXZlbnQgIicgKyBjYWxsYmFjayArICciIGRvZXMgbm90IGV4aXN0ICcgKyAodGhpcy5uYW1lIHx8IHRoaXMuY2lkKSArICc6JyArIGV2ZW50TmFtZSk7CiAgfQogIHJldHVybiBfLmJpbmQoZnVuY3Rpb24oKSB7CiAgICB0cnkgewogICAgICBtZXRob2QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgVGhvcmF4Lm9uRXhjZXB0aW9uKCd0aG9yYXgtZXhjZXB0aW9uOiAnICsgKHRoaXMubmFtZSB8fCB0aGlzLmNpZCkgKyAnOicgKyBldmVudE5hbWUsIGUpOwogICAgfQogIH0sIHBhcmFtcy5jb250ZXh0IHx8IHRoaXMpOwp9CgpmdW5jdGlvbiBldmVudFBhcmFtc0Zyb21FdmVudEl0ZW0obmFtZSwgaGFuZGxlciwgY29udGV4dCkgewogIHZhciBwYXJhbXMgPSB7CiAgICBvcmlnaW5hbE5hbWU6IG5hbWUsCiAgICBoYW5kbGVyOiB0eXBlb2YgaGFuZGxlciA9PT0gJ3N0cmluZycgPyB0aGlzW2hhbmRsZXJdIDogaGFuZGxlcgogIH07CiAgaWYgKG5hbWUubWF0Y2goZG9tRXZlbnRSZWdleHApKSB7CiAgICB2YXIgbWF0Y2ggPSBldmVudFNwbGl0dGVyLmV4ZWMobmFtZSk7CiAgICBwYXJhbXMubmVzdGVkID0gISFtYXRjaFsxXTsKICAgIHBhcmFtcy5uYW1lID0gbWF0Y2hbMl07CiAgICBwYXJhbXMudHlwZSA9ICdET00nOwogICAgcGFyYW1zLnNlbGVjdG9yID0gbWF0Y2hbM107CiAgfSBlbHNlIHsKICAgIHBhcmFtcy5uYW1lID0gbmFtZTsKICAgIHBhcmFtcy50eXBlID0gJ3ZpZXcnOwogIH0KICBwYXJhbXMuY29udGV4dCA9IGNvbnRleHQ7CiAgcmV0dXJuIHBhcmFtczsKfQoKOzsKLypnbG9iYWwgZ2V0T3B0aW9uc0RhdGEsIHZpZXdIZWxwZXJBdHRyaWJ1dGVOYW1lICovCnZhciB2aWV3UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtdmlldy10bXAnOwp2YXIgdmlld1RlbXBsYXRlT3ZlcnJpZGVzID0ge307CgpUaG9yYXguSGVscGVyVmlldyA9IFRob3JheC5WaWV3LmV4dGVuZCh7CiAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgVGhvcmF4LlZpZXcucHJvdG90eXBlLl9lbnN1cmVFbGVtZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB0aGlzLiRlbC5hdHRyKHZpZXdIZWxwZXJBdHRyaWJ1dGVOYW1lLCB0aGlzLl9oZWxwZXJOYW1lKTsKICB9LAogIF9nZXRDb250ZXh0OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLnBhcmVudC5fZ2V0Q29udGV4dC5hcHBseSh0aGlzLnBhcmVudCwgYXJndW1lbnRzKTsKICB9LAp9KTsKCi8vZW5zdXJlIG5lc3RlZCBpbmxpbmUgaGVscGVycyB3aWxsIGFsd2F5cyBoYXZlIHRoaXMucGFyZW50Ci8vc2V0IHRvIHRoZSB2aWV3IGNvbnRhaW5pbmcgdGhlIHRlbXBsYXRlCmZ1bmN0aW9uIGdldFBhcmVudChwYXJlbnQpIHsKICB3aGlsZSAocGFyZW50Ll9oZWxwZXJOYW1lKSB7CiAgICBwYXJlbnQgPSBwYXJlbnQucGFyZW50OwogIH0KICByZXR1cm4gcGFyZW50Owp9CgpIYW5kbGViYXJzLnJlZ2lzdGVyVmlld0hlbHBlciA9IGZ1bmN0aW9uKG5hbWUsIFZpZXdDbGFzcywgY2FsbGJhY2spIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikgewogICAgaWYgKFZpZXdDbGFzcy5mYWN0b3J5KSB7CiAgICAgIGNhbGxiYWNrID0gVmlld0NsYXNzLmNhbGxiYWNrOwogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2sgPSBWaWV3Q2xhc3M7CiAgICAgIFZpZXdDbGFzcyA9IFRob3JheC5IZWxwZXJWaWV3OwogICAgfQogIH0KICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKG5hbWUsIGZ1bmN0aW9uKCkgewogICAgdmFyIGFyZ3MgPSBfLnRvQXJyYXkoYXJndW1lbnRzKSwKICAgICAgICBvcHRpb25zID0gYXJncy5wb3AoKSwKICAgICAgICBkZWNsYXJpbmdWaWV3ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldzsKCiAgICB2YXIgdmlld09wdGlvbnMgPSB7CiAgICAgIHRlbXBsYXRlOiBvcHRpb25zLmZuIHx8IEhhbmRsZWJhcnMuVk0ubm9vcCwKICAgICAgaW52ZXJzZTogb3B0aW9ucy5pbnZlcnNlLAogICAgICBvcHRpb25zOiBvcHRpb25zLmhhc2gsCiAgICAgIGRlY2xhcmluZ1ZpZXc6IGRlY2xhcmluZ1ZpZXcsCiAgICAgIHBhcmVudDogZ2V0UGFyZW50KGRlY2xhcmluZ1ZpZXcpLAogICAgICBfaGVscGVyTmFtZTogbmFtZSwKICAgICAgX2hlbHBlck9wdGlvbnM6IHsKICAgICAgICBvcHRpb25zOiBjbG9uZUhlbHBlck9wdGlvbnMob3B0aW9ucyksCiAgICAgICAgYXJnczogXy5jbG9uZShhcmdzKQogICAgICB9CiAgICB9OwoKICAgIG9wdGlvbnMuaGFzaC5pZCAmJiAodmlld09wdGlvbnMuaWQgPSBvcHRpb25zLmhhc2guaWQpOwogICAgb3B0aW9ucy5oYXNoWydjbGFzcyddICYmICh2aWV3T3B0aW9ucy5jbGFzc05hbWUgPSBvcHRpb25zLmhhc2hbJ2NsYXNzJ10pOwogICAgb3B0aW9ucy5oYXNoLmNsYXNzTmFtZSAmJiAodmlld09wdGlvbnMuY2xhc3NOYW1lID0gb3B0aW9ucy5oYXNoLmNsYXNzTmFtZSk7CiAgICBvcHRpb25zLmhhc2gudGFnICYmICh2aWV3T3B0aW9ucy50YWdOYW1lID0gb3B0aW9ucy5oYXNoLnRhZyk7CiAgICBvcHRpb25zLmhhc2gudGFnTmFtZSAmJiAodmlld09wdGlvbnMudGFnTmFtZSA9IG9wdGlvbnMuaGFzaC50YWdOYW1lKTsKCiAgICAvLyBDaGVjayB0byBzZWUgaWYgd2UgaGF2ZSBhbiBleGlzdGluZyBpbnN0YW5jZSB0aGF0IHdlIGNhbiByZXVzZQogICAgdmFyIGluc3RhbmNlID0gXy5maW5kKGRlY2xhcmluZ1ZpZXcuX3ByZXZpb3VzSGVscGVycywgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgcmV0dXJuIGNvbXBhcmVIZWxwZXJPcHRpb25zKHZpZXdPcHRpb25zLCBjaGlsZCk7CiAgICB9KTsKCiAgICAvLyBDcmVhdGUgdGhlIGluc3RhbmNlIGlmIHdlIGRvbid0IGFscmVhZHkgaGF2ZSBvbmUKICAgIGlmICghaW5zdGFuY2UpIHsKICAgICAgaWYgKFZpZXdDbGFzcy5mYWN0b3J5KSB7CiAgICAgICAgaW5zdGFuY2UgPSBWaWV3Q2xhc3MuZmFjdG9yeShhcmdzLCB2aWV3T3B0aW9ucyk7CiAgICAgICAgaWYgKCFpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuICcnOwogICAgICAgIH0KCiAgICAgICAgaW5zdGFuY2UuX2hlbHBlck5hbWUgPSB2aWV3T3B0aW9ucy5faGVscGVyTmFtZTsKICAgICAgICBpbnN0YW5jZS5faGVscGVyT3B0aW9ucyA9IHZpZXdPcHRpb25zLl9oZWxwZXJPcHRpb25zOwogICAgICB9IGVsc2UgewogICAgICAgIGluc3RhbmNlID0gbmV3IFZpZXdDbGFzcyh2aWV3T3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIGFyZ3MucHVzaChpbnN0YW5jZSk7CiAgICAgIGRlY2xhcmluZ1ZpZXcuX2FkZENoaWxkKGluc3RhbmNlKTsKICAgICAgZGVjbGFyaW5nVmlldy50cmlnZ2VyLmFwcGx5KGRlY2xhcmluZ1ZpZXcsIFsnaGVscGVyJywgbmFtZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgZGVjbGFyaW5nVmlldy50cmlnZ2VyLmFwcGx5KGRlY2xhcmluZ1ZpZXcsIFsnaGVscGVyOicgKyBuYW1lXS5jb25jYXQoYXJncykpOwoKICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7CiAgICB9IGVsc2UgewogICAgICBkZWNsYXJpbmdWaWV3Ll9wcmV2aW91c0hlbHBlcnMgPSBfLndpdGhvdXQoZGVjbGFyaW5nVmlldy5fcHJldmlvdXNIZWxwZXJzLCBpbnN0YW5jZSk7CiAgICAgIGRlY2xhcmluZ1ZpZXcuY2hpbGRyZW5baW5zdGFuY2UuY2lkXSA9IGluc3RhbmNlOwogICAgfQoKICAgIHZhciBodG1sQXR0cmlidXRlcyA9IFRob3JheC5VdGlsLmh0bWxBdHRyaWJ1dGVzRnJvbU9wdGlvbnMob3B0aW9ucy5oYXNoKTsKICAgIGh0bWxBdHRyaWJ1dGVzW3ZpZXdQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWVdID0gaW5zdGFuY2UuY2lkOwoKICAgIHZhciBleHBhbmRUb2tlbnMgPSBvcHRpb25zLmhhc2hbJ2V4cGFuZC10b2tlbnMnXTsKICAgIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZyhodG1sQXR0cmlidXRlcywgJycsIGV4cGFuZFRva2VucyA/IHRoaXMgOiBudWxsKSk7CiAgfSk7CiAgdmFyIGhlbHBlciA9IEhhbmRsZWJhcnMuaGVscGVyc1tuYW1lXTsKICByZXR1cm4gaGVscGVyOwp9OwoKVGhvcmF4LlZpZXcub24oJ2FwcGVuZCcsIGZ1bmN0aW9uKHNjb3BlLCBjYWxsYmFjaykgewogIChzY29wZSB8fCB0aGlzLiRlbCkuZmluZCgnWycgKyB2aWV3UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lICsgJ10nKS5mb3JFYWNoKGZ1bmN0aW9uKGVsKSB7CiAgICB2YXIgcGxhY2Vob2xkZXJJZCA9IGVsLmdldEF0dHJpYnV0ZSh2aWV3UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lKSwKICAgICAgICB2aWV3ID0gdGhpcy5jaGlsZHJlbltwbGFjZWhvbGRlcklkXTsKICAgIGlmICh2aWV3KSB7CiAgICAgIC8vc2VlIGlmIHRoZSB2aWV3IGhlbHBlciBkZWNsYXJlZCBhbiBvdmVycmlkZSBmb3IgdGhlIHZpZXcKICAgICAgLy9pZiBub3QsIGVuc3VyZSB0aGUgdmlldyBoYXMgYmVlbiByZW5kZXJlZCBhdCBsZWFzdCBvbmNlCiAgICAgIGlmICh2aWV3VGVtcGxhdGVPdmVycmlkZXNbcGxhY2Vob2xkZXJJZF0pIHsKICAgICAgICB2aWV3LnJlbmRlcih2aWV3VGVtcGxhdGVPdmVycmlkZXNbcGxhY2Vob2xkZXJJZF0pOwogICAgICAgIGRlbGV0ZSB2aWV3VGVtcGxhdGVPdmVycmlkZXNbcGxhY2Vob2xkZXJJZF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmlldy5lbnN1cmVSZW5kZXJlZCgpOwogICAgICB9CiAgICAgICQoZWwpLnJlcGxhY2VXaXRoKHZpZXcuZWwpOwogICAgICBjYWxsYmFjayAmJiBjYWxsYmFjayh2aWV3LmVsKTsKICAgIH0KICB9LCB0aGlzKTsKfSk7CgoKLyoqCiAqIENsb25lcyB0aGUgaGVscGVyIG9wdGlvbnMsIGRyb3BwaW5nIGl0ZW1zIHRoYXQgYXJlIGtub3duIHRvIGNoYW5nZQogKiBiZXR3ZWVuIHJlbmRlcmluZyBjeWNsZXMgYXMgYXBwcm9wcmlhdGUuCiAqLwpmdW5jdGlvbiBjbG9uZUhlbHBlck9wdGlvbnMob3B0aW9ucykgewogIHZhciByZXQgPSBfLnBpY2sob3B0aW9ucywgJ2ZuJywgJ2ludmVyc2UnLCAnaGFzaCcsICdkYXRhJyk7CiAgcmV0LmRhdGEgPSBfLm9taXQob3B0aW9ucy5kYXRhLCAnY2lkJywgJ3ZpZXcnLCAneWllbGQnKTsKICByZXR1cm4gcmV0Owp9CgovKioKICogQ2hlY2tzIGZvciBiYXNpYyBlcXVhbGl0eSBiZXR3ZWVuIHR3byBzZXRzIG9mIHBhcmFtZXRlcnMgZm9yIGEgaGVscGVyIHZpZXcuCiAqCiAqIENoZWNrZWQgZmllbGRzIGluY2x1ZGU6CiAqICAtIF9oZWxwZXJOYW1lCiAqICAtIEFsbCBhcmdzCiAqICAtIEhhc2gKICogIC0gRGF0YQogKiAgLSBGdW5jdGlvbiBhbmQgSW52ZXJ0IChpZCBiYXNlZCBpZiBwb3NzaWJsZSkKICoKICogVGhpcyBtZXRob2QgYWxsb3dzIHVzIHRvIGRldGVybWluZSBpZiB0aGUgaW5wdXRzIHRvIGEgZ2l2ZW4gdmlldyBhcmUgdGhlIHNhbWUuIElmIHRoZXkKICogYXJlIHRoZW4gd2UgbWFrZSB0aGUgYXNzdW1wdGlvbiB0aGF0IHRoZSByZW5kZXJpbmcgd2lsbCBiZSB0aGUgc2FtZSAob3IgdGhlIGNoaWxkIHZpZXcgd2lsbAogKiBvdGhlcndpc2UgcmVyZW5kZXJpbmcgaXQgYnkgbW9uaXRvcmluZyBpdCdzIHBhcmFtZXRlcnMgYXMgbmVjZXNzYXJ5KSBhbmQgcmV1c2UgdGhlIHZpZXcgb24KICogcmVyZW5kZXIgb2YgdGhlIHBhcmVudCB2aWV3LgogKi8KZnVuY3Rpb24gY29tcGFyZUhlbHBlck9wdGlvbnMoYSwgYikgewogIGZ1bmN0aW9uIGNvbXBhcmVWYWx1ZXMoYSwgYikgewogICAgcmV0dXJuIF8uZXZlcnkoYSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICByZXR1cm4gYltrZXldID09PSB2YWx1ZTsKICAgIH0pOwogIH0KCiAgaWYgKGEuX2hlbHBlck5hbWUgIT09IGIuX2hlbHBlck5hbWUpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIGEgPSBhLl9oZWxwZXJPcHRpb25zOwogIGIgPSBiLl9oZWxwZXJPcHRpb25zOwoKICAvLyBJbXBsZW1lbnRzIGEgZmlyc3QgbGV2ZWwgZGVwdGggY29tcGFyaXNvbgogIHJldHVybiBhLmFyZ3MubGVuZ3RoID09PSBiLmFyZ3MubGVuZ3RoCiAgICAgICYmIGNvbXBhcmVWYWx1ZXMoYS5hcmdzLCBiLmFyZ3MpCiAgICAgICYmIF8uaXNFcXVhbChfLmtleXMoYS5vcHRpb25zKSwgXy5rZXlzKGIub3B0aW9ucykpCiAgICAgICYmIF8uZXZlcnkoYS5vcHRpb25zLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICBpZiAoa2V5ID09PSAnZGF0YScgfHwga2V5ID09PSAnaGFzaCcpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmVWYWx1ZXMoYS5vcHRpb25zW2tleV0sIGIub3B0aW9uc1trZXldKTsKICAgICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAnZm4nIHx8IGtleSA9PT0gJ2ludmVyc2UnKSB7CiAgICAgICAgICAgIHJldHVybiBiLm9wdGlvbnNba2V5XSA9PT0gdmFsdWUKICAgICAgICAgICAgICAgIHx8ICh2YWx1ZSAmJiBfLmhhcyh2YWx1ZSwgJ3Byb2dyYW0nKSAmJiAoKGIub3B0aW9uc1trZXldIHx8IHt9KS5wcm9ncmFtID09PSB2YWx1ZS5wcm9ncmFtKSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYi5vcHRpb25zW2tleV0gPT09IHZhbHVlOwogICAgICAgIH0pOwp9Cgo7OwovKmdsb2JhbCBnZXRWYWx1ZSwgaW5oZXJpdFZhcnMsIHdhbGtJbmhlcml0VHJlZSAqLwoKZnVuY3Rpb24gZGF0YU9iamVjdCh0eXBlLCBzcGVjKSB7CiAgc3BlYyA9IGluaGVyaXRWYXJzW3R5cGVdID0gXy5kZWZhdWx0cyh7CiAgICBuYW1lOiAnXycgKyB0eXBlICsgJ0V2ZW50cycsCiAgICBldmVudDogdHJ1ZQogIH0sIHNwZWMpOwoKICAvLyBBZGQgYSBjYWxsYmFjayBpbiB0aGUgdmlldyBjb25zdHJ1Y3RvcgogIHNwZWMuY3RvciA9IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXNbdHlwZV0pIHsKICAgICAgLy8gTmVlZCB0byBudWxsIHRoaXMubW9kZWwvY29sbGVjdGlvbiBzbyBzZXRNb2RlbC9Db2xsZWN0aW9uIHdpbGwKICAgICAgLy8gbm90IHRyZWF0IGl0IGFzIHRoZSBvbGQgbW9kZWwvY29sbGVjdGlvbiBhbmQgaW1tZWRpYXRlbHkgcmV0dXJuCiAgICAgIHZhciBvYmplY3QgPSB0aGlzW3R5cGVdOwogICAgICB0aGlzW3R5cGVdID0gbnVsbDsKICAgICAgdGhpc1tzcGVjLnNldF0ob2JqZWN0KTsKICAgIH0KICB9OwoKICBmdW5jdGlvbiBzZXRPYmplY3QoZGF0YU9iamVjdCwgb3B0aW9ucykgewogICAgdmFyIG9sZCA9IHRoaXNbdHlwZV0sCiAgICAgICAgJGVsID0gZ2V0VmFsdWUodGhpcywgc3BlYy4kZWwpOwoKICAgIGlmIChkYXRhT2JqZWN0ID09PSBvbGQpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBpZiAob2xkKSB7CiAgICAgIHRoaXMudW5iaW5kRGF0YU9iamVjdChvbGQpOwogICAgfQoKICAgIGlmIChkYXRhT2JqZWN0KSB7CiAgICAgIHRoaXNbdHlwZV0gPSBkYXRhT2JqZWN0OwoKICAgICAgaWYgKHNwZWMubG9hZGluZykgewogICAgICAgIHNwZWMubG9hZGluZy5jYWxsKHRoaXMpOwogICAgICB9CgogICAgICB0aGlzLmJpbmREYXRhT2JqZWN0KHR5cGUsIGRhdGFPYmplY3QsIF8uZXh0ZW5kKHt9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMpKTsKICAgICAgJGVsLmF0dHIoc3BlYy5jaWRBdHRyTmFtZSwgZGF0YU9iamVjdC5jaWQpOwogICAgICBkYXRhT2JqZWN0LnRyaWdnZXIoJ3NldCcsIGRhdGFPYmplY3QsIG9sZCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzW3R5cGVdID0gZmFsc2U7CiAgICAgIGlmIChzcGVjLmNoYW5nZSkgewogICAgICAgIHNwZWMuY2hhbmdlLmNhbGwodGhpcywgZmFsc2UpOwogICAgICB9CiAgICAgICRlbC5yZW1vdmVBdHRyKHNwZWMuY2lkQXR0ck5hbWUpOwogICAgfQogICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2U6ZGF0YS1vYmplY3QnLCB0eXBlLCBkYXRhT2JqZWN0LCBvbGQpOwogICAgc3BlYy5zZXRDYWxsYmFjayAmJiBzcGVjLnNldENhbGxiYWNrLmNhbGwodGhpcywgZGF0YU9iamVjdCwgb3B0aW9ucyk7CiAgICByZXR1cm4gdGhpczsKICB9CgogIFRob3JheC5WaWV3LnByb3RvdHlwZVtzcGVjLnNldF0gPSBzZXRPYmplY3Q7Cn0KCl8uZXh0ZW5kKFRob3JheC5WaWV3LnByb3RvdHlwZSwgewogIGJpbmREYXRhT2JqZWN0OiBmdW5jdGlvbih0eXBlLCBkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgICBpZiAodGhpcy5fYm91bmREYXRhT2JqZWN0c0J5Q2lkW2RhdGFPYmplY3QuY2lkXSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICAvLyBDb2xsZWN0aW9ucyBkbyBub3QgaGF2ZSBhIGNpZCBhdHRyaWJ1dGUgYnkgZGVmYXVsdAogICAgZW5zdXJlRGF0YU9iamVjdENpZCh0eXBlLCBkYXRhT2JqZWN0KTsKICAgIHRoaXMuX2JvdW5kRGF0YU9iamVjdHNCeUNpZFtkYXRhT2JqZWN0LmNpZF0gPSBkYXRhT2JqZWN0OwoKICAgIHZhciBvcHRpb25zID0gdGhpcy5fbW9kaWZ5RGF0YU9iamVjdE9wdGlvbnMoZGF0YU9iamVjdCwgXy5leHRlbmQoe30sIGluaGVyaXRWYXJzW3R5cGVdLmRlZmF1bHRPcHRpb25zLCBvcHRpb25zKSk7CiAgICB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbZGF0YU9iamVjdC5jaWRdID0gb3B0aW9uczsKCiAgICBiaW5kRXZlbnRzLmNhbGwodGhpcywgdHlwZSwgZGF0YU9iamVjdCwgdGhpcy5jb25zdHJ1Y3Rvcik7CiAgICBiaW5kRXZlbnRzLmNhbGwodGhpcywgdHlwZSwgZGF0YU9iamVjdCwgdGhpcyk7CgogICAgaWYgKGRhdGFPYmplY3Quc2hvdWxkRmV0Y2gpIHsKICAgICAgaWYgKGRhdGFPYmplY3Quc2hvdWxkRmV0Y2gob3B0aW9ucykpIHsKICAgICAgICBsb2FkT2JqZWN0KGRhdGFPYmplY3QsIG9wdGlvbnMpOwogICAgICB9IGVsc2UgaWYgKGluaGVyaXRWYXJzW3R5cGVdLmNoYW5nZSkgewogICAgICAgIC8vIHdhbnQgdG8gdHJpZ2dlciBidWlsdCBpbiByZW5kZXJpbmcgd2l0aG91dCB0cmlnZ2VyaW5nIGV2ZW50IG9uIG1vZGVsCiAgICAgICAgaW5oZXJpdFZhcnNbdHlwZV0uY2hhbmdlLmNhbGwodGhpcywgZGF0YU9iamVjdCwgb3B0aW9ucyk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9LAoKICB1bmJpbmREYXRhT2JqZWN0OiBmdW5jdGlvbiAoZGF0YU9iamVjdCkgewogICAgaWYgKCF0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWRbZGF0YU9iamVjdC5jaWRdKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGRlbGV0ZSB0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWRbZGF0YU9iamVjdC5jaWRdOwogICAgZGF0YU9iamVjdC50cmlnZ2VyKCdmcmVlemUnKTsKICAgIHRoaXMuc3RvcExpc3RlbmluZyhkYXRhT2JqZWN0KTsKICAgIGRlbGV0ZSB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbZGF0YU9iamVjdC5jaWRdOwogICAgcmV0dXJuIHRydWU7CiAgfSwKCiAgX21vZGlmeURhdGFPYmplY3RPcHRpb25zOiBmdW5jdGlvbihkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgICByZXR1cm4gb3B0aW9uczsKICB9Cn0pOwoKZnVuY3Rpb24gYmluZEV2ZW50cyh0eXBlLCB0YXJnZXQsIHNvdXJjZSkgewogIHZhciBjb250ZXh0ID0gdGhpczsKICB3YWxrSW5oZXJpdFRyZWUoc291cmNlLCAnXycgKyB0eXBlICsgJ0V2ZW50cycsIHRydWUsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAvLyBnZXRFdmVudENhbGxiYWNrIHdpbGwgcmVzb2x2ZSBpZiBpdCBpcyBhIHN0cmluZyBvciBhIG1ldGhvZAogICAgLy8gYW5kIHJldHVybiBhIG1ldGhvZAogICAgY29udGV4dC5saXN0ZW5Ubyh0YXJnZXQsIGV2ZW50WzBdLCBfLmJpbmQoZ2V0RXZlbnRDYWxsYmFjayhldmVudFsxXSwgY29udGV4dCksIGV2ZW50WzJdIHx8IGNvbnRleHQpKTsKICB9KTsKfQoKZnVuY3Rpb24gbG9hZE9iamVjdChkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgaWYgKGRhdGFPYmplY3QubG9hZCkgewogICAgZGF0YU9iamVjdC5sb2FkKGZ1bmN0aW9uKCkgewogICAgICBvcHRpb25zICYmIG9wdGlvbnMuc3VjY2VzcyAmJiBvcHRpb25zLnN1Y2Nlc3MoZGF0YU9iamVjdCk7CiAgICB9LCBvcHRpb25zKTsKICB9IGVsc2UgewogICAgZGF0YU9iamVjdC5mZXRjaChvcHRpb25zKTsKICB9Cn0KCmZ1bmN0aW9uIGdldEV2ZW50Q2FsbGJhY2soY2FsbGJhY2ssIGNvbnRleHQpIHsKICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7CiAgICByZXR1cm4gY2FsbGJhY2s7CiAgfSBlbHNlIHsKICAgIHJldHVybiBjb250ZXh0W2NhbGxiYWNrXTsKICB9Cn0KCmZ1bmN0aW9uIGVuc3VyZURhdGFPYmplY3RDaWQodHlwZSwgb2JqKSB7CiAgb2JqLmNpZCA9IG9iai5jaWQgfHwgXy51bmlxdWVJZCh0eXBlKTsKfQoKOzsKLypnbG9iYWwgY3JlYXRlUmVnaXN0cnlXcmFwcGVyLCBkYXRhT2JqZWN0LCBnZXRWYWx1ZSAqLwp2YXIgbW9kZWxDaWRBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtbW9kZWwtY2lkJzsKClRob3JheC5Nb2RlbCA9IEJhY2tib25lLk1vZGVsLmV4dGVuZCh7CiAgaXNFbXB0eTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gIXRoaXMuaXNQb3B1bGF0ZWQoKTsKICB9LAogIGlzUG9wdWxhdGVkOiBmdW5jdGlvbigpIHsKICAgIC8vIFdlIGFyZSBwb3B1bGF0ZWQgaWYgd2UgaGF2ZSBhdHRyaWJ1dGVzIHNldAogICAgdmFyIGF0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyksCiAgICAgICAgZGVmYXVsdHMgPSBnZXRWYWx1ZSh0aGlzLCAnZGVmYXVsdHMnKSB8fCB7fTsKICAgIGZvciAodmFyIGRlZmF1bHRfa2V5IGluIGRlZmF1bHRzKSB7CiAgICAgIGlmIChhdHRyaWJ1dGVzW2RlZmF1bHRfa2V5XSAhPSBkZWZhdWx0c1tkZWZhdWx0X2tleV0pIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBkZWxldGUgYXR0cmlidXRlc1tkZWZhdWx0X2tleV07CiAgICB9CiAgICB2YXIga2V5cyA9IF8ua2V5cyhhdHRyaWJ1dGVzKTsKICAgIHJldHVybiBrZXlzLmxlbmd0aCA+IDEgfHwgKGtleXMubGVuZ3RoID09PSAxICYmIGtleXNbMF0gIT09IHRoaXMuaWRBdHRyaWJ1dGUpOwogIH0sCiAgc2hvdWxkRmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIC8vIHVybCgpIHdpbGwgdGhyb3cgaWYgbW9kZWwgaGFzIG5vIGB1cmxSb290YCBhbmQgbm8gYGNvbGxlY3Rpb25gCiAgICAvLyBvciBoYXMgYGNvbGxlY3Rpb25gIGFuZCBgY29sbGVjdGlvbmAgaGFzIG5vIGB1cmxgCiAgICB2YXIgdXJsOwogICAgdHJ5IHsKICAgICAgdXJsID0gZ2V0VmFsdWUodGhpcywgJ3VybCcpOwogICAgfSBjYXRjaChlKSB7CiAgICAgIHVybCA9IGZhbHNlOwogICAgfQogICAgcmV0dXJuIG9wdGlvbnMuZmV0Y2ggJiYgISF1cmwgJiYgIXRoaXMuaXNQb3B1bGF0ZWQoKTsKICB9Cn0pOwoKVGhvcmF4Lk1vZGVscyA9IHt9OwpjcmVhdGVSZWdpc3RyeVdyYXBwZXIoVGhvcmF4Lk1vZGVsLCBUaG9yYXguTW9kZWxzKTsKCmRhdGFPYmplY3QoJ21vZGVsJywgewogIHNldDogJ3NldE1vZGVsJywKICBkZWZhdWx0T3B0aW9uczogewogICAgcmVuZGVyOiB0cnVlLAogICAgZmV0Y2g6IHRydWUsCiAgICBzdWNjZXNzOiBmYWxzZSwKICAgIGVycm9yczogdHJ1ZQogIH0sCiAgY2hhbmdlOiBvbk1vZGVsQ2hhbmdlLAogICRlbDogJyRlbCcsCiAgY2lkQXR0ck5hbWU6IG1vZGVsQ2lkQXR0cmlidXRlTmFtZQp9KTsKCmZ1bmN0aW9uIG9uTW9kZWxDaGFuZ2UobW9kZWwpIHsKICB2YXIgbW9kZWxPcHRpb25zID0gbW9kZWwgJiYgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW21vZGVsLmNpZF07CiAgLy8gIW1vZGVsT3B0aW9ucyB3aWxsIGJlIHRydWUgd2hlbiBzZXRNb2RlbChmYWxzZSkgaXMgY2FsbGVkCiAgaWYgKCFtb2RlbE9wdGlvbnMgfHwgKG1vZGVsT3B0aW9ucyAmJiBtb2RlbE9wdGlvbnMucmVuZGVyKSkgewogICAgdGhpcy5yZW5kZXIoKTsKICB9Cn0KClRob3JheC5WaWV3Lm9uKHsKICBtb2RlbDogewogICAgZXJyb3I6IGZ1bmN0aW9uKG1vZGVsLCBlcnJvcnMpIHsKICAgICAgaWYgKHRoaXMuX29iamVjdE9wdGlvbnNCeUNpZFttb2RlbC5jaWRdLmVycm9ycykgewogICAgICAgIHRoaXMudHJpZ2dlcignZXJyb3InLCBlcnJvcnMsIG1vZGVsKTsKICAgICAgfQogICAgfSwKICAgIGNoYW5nZTogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgb25Nb2RlbENoYW5nZS5jYWxsKHRoaXMsIG1vZGVsKTsKICAgIH0KICB9Cn0pOwoKJC5mbi5tb2RlbCA9IGZ1bmN0aW9uKHZpZXcpIHsKICB2YXIgJHRoaXMgPSAkKHRoaXMpLAogICAgICBtb2RlbEVsZW1lbnQgPSAkdGhpcy5jbG9zZXN0KCdbJyArIG1vZGVsQ2lkQXR0cmlidXRlTmFtZSArICddJyksCiAgICAgIG1vZGVsQ2lkID0gbW9kZWxFbGVtZW50ICYmIG1vZGVsRWxlbWVudC5hdHRyKG1vZGVsQ2lkQXR0cmlidXRlTmFtZSk7CiAgaWYgKG1vZGVsQ2lkKSB7CiAgICB2YXIgdmlldyA9IHZpZXcgfHwgJHRoaXMudmlldygpOwogICAgaWYgKHZpZXcgJiYgdmlldy5tb2RlbCAmJiB2aWV3Lm1vZGVsLmNpZCA9PT0gbW9kZWxDaWQpIHsKICAgICAgcmV0dXJuIHZpZXcubW9kZWwgfHwgZmFsc2U7CiAgICB9CiAgICB2YXIgY29sbGVjdGlvbiA9ICR0aGlzLmNvbGxlY3Rpb24odmlldyk7CiAgICBpZiAoY29sbGVjdGlvbikgewogICAgICByZXR1cm4gY29sbGVjdGlvbi5maW5kKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIG1vZGVsLmNpZCA9PT0gbW9kZWxDaWQ7CiAgICAgIH0pIHx8IGZhbHNlOwogICAgfQogIH0KICByZXR1cm4gZmFsc2U7Cn07Cgo7OwovKmdsb2JhbCBjcmVhdGVSZWdpc3RyeVdyYXBwZXIsIGRhdGFPYmplY3QsIGdldEV2ZW50Q2FsbGJhY2ssIGdldFZhbHVlLCBtb2RlbENpZEF0dHJpYnV0ZU5hbWUsIHZpZXdDaWRBdHRyaWJ1dGVOYW1lICovCnZhciBfZmV0Y2ggPSBCYWNrYm9uZS5Db2xsZWN0aW9uLnByb3RvdHlwZS5mZXRjaCwKICAgIF9yZXNldCA9IEJhY2tib25lLkNvbGxlY3Rpb24ucHJvdG90eXBlLnJlc2V0LAogICAgY29sbGVjdGlvbkNpZEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1jb2xsZWN0aW9uLWNpZCcsCiAgICBjb2xsZWN0aW9uRW1wdHlBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtY29sbGVjdGlvbi1lbXB0eScsCiAgICBjb2xsZWN0aW9uRWxlbWVudEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1jb2xsZWN0aW9uLWVsZW1lbnQnLAogICAgcHJpbWFyeUNvbGxlY3Rpb25BdHRyaWJ1dGVOYW1lID0gJ2RhdGEtY29sbGVjdGlvbi1wcmltYXJ5JywKICAgIEVMRU1FTlRfTk9ERV9UWVBFID0gMTsKClRob3JheC5Db2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbi5leHRlbmQoewogIG1vZGVsOiBUaG9yYXguTW9kZWwgfHwgQmFja2JvbmUuTW9kZWwsCiAgaXNFbXB0eTogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5sZW5ndGggPiAwKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLmxlbmd0aCA9PT0gMCAmJiB0aGlzLmlzUG9wdWxhdGVkKCk7CiAgICB9CiAgfSwKICBpc1BvcHVsYXRlZDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fZmV0Y2hlZCB8fCB0aGlzLmxlbmd0aCA+IDAgfHwgKCF0aGlzLmxlbmd0aCAmJiAhZ2V0VmFsdWUodGhpcywgJ3VybCcpKTsKICB9LAogIHNob3VsZEZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICByZXR1cm4gb3B0aW9ucy5mZXRjaCAmJiAhIWdldFZhbHVlKHRoaXMsICd1cmwnKSAmJiAhdGhpcy5pc1BvcHVsYXRlZCgpOwogIH0sCiAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihjb2xsZWN0aW9uLCByZXNwb25zZSkgewogICAgICBjb2xsZWN0aW9uLl9mZXRjaGVkID0gdHJ1ZTsKICAgICAgc3VjY2VzcyAmJiBzdWNjZXNzKGNvbGxlY3Rpb24sIHJlc3BvbnNlKTsKICAgIH07CiAgICByZXR1cm4gX2ZldGNoLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfSwKICByZXNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICB0aGlzLl9mZXRjaGVkID0gISFtb2RlbHM7CiAgICByZXR1cm4gX3Jlc2V0LmNhbGwodGhpcywgbW9kZWxzLCBvcHRpb25zKTsKICB9Cn0pOwoKVGhvcmF4LkNvbGxlY3Rpb25zID0ge307CmNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcihUaG9yYXguQ29sbGVjdGlvbiwgVGhvcmF4LkNvbGxlY3Rpb25zKTsKCmRhdGFPYmplY3QoJ2NvbGxlY3Rpb24nLCB7CiAgc2V0OiAnc2V0Q29sbGVjdGlvbicsCiAgc2V0Q2FsbGJhY2s6IGFmdGVyU2V0Q29sbGVjdGlvbiwKICBkZWZhdWx0T3B0aW9uczogewogICAgcmVuZGVyOiB0cnVlLAogICAgZmV0Y2g6IHRydWUsCiAgICBzdWNjZXNzOiBmYWxzZSwKICAgIGVycm9yczogdHJ1ZQogIH0sCiAgY2hhbmdlOiBvbkNvbGxlY3Rpb25SZXNldCwKICAkZWw6ICdnZXRDb2xsZWN0aW9uRWxlbWVudCcsCiAgY2lkQXR0ck5hbWU6IGNvbGxlY3Rpb25DaWRBdHRyaWJ1dGVOYW1lCn0pOwoKXy5leHRlbmQoVGhvcmF4LlZpZXcucHJvdG90eXBlLCB7CiAgX2NvbGxlY3Rpb25TZWxlY3RvcjogJ1snICsgY29sbGVjdGlvbkVsZW1lbnRBdHRyaWJ1dGVOYW1lICsgJ10nLAogIC8vYXBwZW5kSXRlbShtb2RlbCBbLGluZGV4XSkKICAvL2FwcGVuZEl0ZW0oaHRtbF9zdHJpbmcsIGluZGV4KQogIC8vYXBwZW5kSXRlbSh2aWV3LCBpbmRleCkKICBhcHBlbmRJdGVtOiBmdW5jdGlvbihtb2RlbCwgaW5kZXgsIG9wdGlvbnMpIHsKICAgIC8vZW1wdHkgaXRlbQogICAgaWYgKCFtb2RlbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgaXRlbVZpZXcsCiAgICAgICAgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAvL2lmIGluZGV4IGFyZ3VtZW50IGlzIGEgdmlldwogICAgaW5kZXggJiYgaW5kZXguZWwgJiYgKGluZGV4ID0gJGVsLmNoaWxkcmVuKCkuaW5kZXhPZihpbmRleC5lbCkgKyAxKTsKICAgIC8vaWYgYXJndW1lbnQgaXMgYSB2aWV3LCBvciBodG1sIHN0cmluZwogICAgaWYgKG1vZGVsLmVsIHx8IHR5cGVvZiBtb2RlbCA9PT0gJ3N0cmluZycpIHsKICAgICAgaXRlbVZpZXcgPSBtb2RlbDsKICAgICAgbW9kZWwgPSBmYWxzZTsKICAgIH0gZWxzZSB7CiAgICAgIGluZGV4ID0gaW5kZXggfHwgdGhpcy5jb2xsZWN0aW9uLmluZGV4T2YobW9kZWwpIHx8IDA7CiAgICAgIGl0ZW1WaWV3ID0gdGhpcy5yZW5kZXJJdGVtKG1vZGVsLCBpbmRleCk7CiAgICB9CiAgICBpZiAoaXRlbVZpZXcpIHsKICAgICAgaXRlbVZpZXcuY2lkICYmIHRoaXMuX2FkZENoaWxkKGl0ZW1WaWV3KTsKICAgICAgLy9pZiB0aGUgcmVuZGVyZXIncyBvdXRwdXQgd2Fzbid0IGNvbnRhaW5lZCBpbiBhIHRhZywgd3JhcCBpdCBpbiBhIGRpdgogICAgICAvL3BsYWluIHRleHQsIG9yIGEgbWl4dHVyZSBvZiB0b3AgbGV2ZWwgdGV4dCBub2RlcyBhbmQgZWxlbWVudCBub2RlcwogICAgICAvL3dpbGwgZ2V0IHdyYXBwZWQKICAgICAgaWYgKHR5cGVvZiBpdGVtVmlldyA9PT0gJ3N0cmluZycgJiYgIWl0ZW1WaWV3Lm1hdGNoKC9eXHMqPC9tKSkgewogICAgICAgIGl0ZW1WaWV3ID0gJzxkaXY+JyArIGl0ZW1WaWV3ICsgJzwvZGl2Pic7CiAgICAgIH0KICAgICAgdmFyIGl0ZW1FbGVtZW50ID0gaXRlbVZpZXcuZWwgPyBbaXRlbVZpZXcuZWxdIDogXy5maWx0ZXIoJChpdGVtVmlldyksIGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAvL2ZpbHRlciBvdXQgdG9wIGxldmVsIHdoaXRlc3BhY2Ugbm9kZXMKICAgICAgICByZXR1cm4gbm9kZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFX1RZUEU7CiAgICAgIH0pOwogICAgICBtb2RlbCAmJiAkKGl0ZW1FbGVtZW50KS5hdHRyKG1vZGVsQ2lkQXR0cmlidXRlTmFtZSwgbW9kZWwuY2lkKTsKICAgICAgdmFyIHByZXZpb3VzTW9kZWwgPSBpbmRleCA+IDAgPyB0aGlzLmNvbGxlY3Rpb24uYXQoaW5kZXggLSAxKSA6IGZhbHNlOwogICAgICBpZiAoIXByZXZpb3VzTW9kZWwpIHsKICAgICAgICAkZWwucHJlcGVuZChpdGVtRWxlbWVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy91c2UgbGFzdCgpIGFzIGFwcGVuZEl0ZW0gY2FuIGFjY2VwdCBtdWx0aXBsZSBub2RlcyBmcm9tIGEgdGVtcGxhdGUKICAgICAgICB2YXIgbGFzdCA9ICRlbC5maW5kKCdbJyArIG1vZGVsQ2lkQXR0cmlidXRlTmFtZSArICc9IicgKyBwcmV2aW91c01vZGVsLmNpZCArICciXScpLmxhc3QoKTsKICAgICAgICBsYXN0LmFmdGVyKGl0ZW1FbGVtZW50KTsKICAgICAgfQoKICAgICAgdGhpcy50cmlnZ2VyKCdhcHBlbmQnLCBudWxsLCBmdW5jdGlvbihlbCkgewogICAgICAgIGVsLnNldEF0dHJpYnV0ZShtb2RlbENpZEF0dHJpYnV0ZU5hbWUsIG1vZGVsLmNpZCk7CiAgICAgIH0pOwoKICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgewogICAgICAgIHRoaXMudHJpZ2dlcigncmVuZGVyZWQ6aXRlbScsIHRoaXMsIHRoaXMuY29sbGVjdGlvbiwgbW9kZWwsIGl0ZW1FbGVtZW50LCBpbmRleCk7CiAgICAgICAgYXBwbHlJdGVtVmlzaWJsaXR5RmlsdGVyLmNhbGwodGhpcywgbW9kZWwpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gaXRlbVZpZXc7CiAgfSwKICAvL8KgdXBkYXRlSXRlbSBvbmx5IHVzZWZ1bCBpZiB0aGVyZSBpcyBubyBpdGVtIHZpZXcsIG90aGVyd2lzZQogIC8vwqBpdGVtVmlldy5yZW5kZXIoKSBwcm92aWRlcyB0aGUgc2FtZSBmdW5jdGlvbmFsaXR5CiAgdXBkYXRlSXRlbTogZnVuY3Rpb24obW9kZWwpIHsKICAgIHRoaXMucmVtb3ZlSXRlbShtb2RlbCk7CiAgICB0aGlzLmFwcGVuZEl0ZW0obW9kZWwpOwogIH0sCiAgcmVtb3ZlSXRlbTogZnVuY3Rpb24obW9kZWwpIHsKICAgIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCksCiAgICAgICAgdmlld0VsID0gJGVsLmZpbmQoJ1snICsgbW9kZWxDaWRBdHRyaWJ1dGVOYW1lICsgJz0iJyArIG1vZGVsLmNpZCArICciXScpOwogICAgaWYgKCF2aWV3RWwubGVuZ3RoKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHZpZXdFbC5yZW1vdmUoKTsKICAgIHZhciB2aWV3Q2lkID0gdmlld0VsLmF0dHIodmlld0NpZEF0dHJpYnV0ZU5hbWUpLAogICAgICAgIGNoaWxkID0gdGhpcy5jaGlsZHJlblt2aWV3Q2lkXTsKICAgIGlmIChjaGlsZCkgewogICAgICB0aGlzLl9yZW1vdmVDaGlsZChjaGlsZCk7CiAgICAgIGNoaWxkLmRlc3Ryb3koKTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0sCiAgcmVuZGVyQ29sbGVjdGlvbjogZnVuY3Rpb24oKSB7CiAgICB0aGlzLmVuc3VyZVJlbmRlcmVkKCk7CiAgICBpZiAoY29sbGVjdGlvbkhlbHBlclByZXNlbnRGb3JQcmltYXJ5Q29sbGVjdGlvbi5jYWxsKHRoaXMpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0aGlzLmNvbGxlY3Rpb24pIHsKICAgICAgaWYgKHRoaXMuY29sbGVjdGlvbi5pc0VtcHR5KCkpIHsKICAgICAgICBoYW5kbGVDaGFuZ2VGcm9tTm90RW1wdHlUb0VtcHR5LmNhbGwodGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaGFuZGxlQ2hhbmdlRnJvbUVtcHR5VG9Ob3RFbXB0eS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuY29sbGVjdGlvbi5mb3JFYWNoKGZ1bmN0aW9uKGl0ZW0sIGkpIHsKICAgICAgICAgIHRoaXMuYXBwZW5kSXRlbShpdGVtLCBpKTsKICAgICAgICB9LCB0aGlzKTsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXIoJ3JlbmRlcmVkOmNvbGxlY3Rpb24nLCB0aGlzLCB0aGlzLmNvbGxlY3Rpb24pOwogICAgICBhcHBseVZpc2liaWxpdHlGaWx0ZXIuY2FsbCh0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIGhhbmRsZUNoYW5nZUZyb21Ob3RFbXB0eVRvRW1wdHkuY2FsbCh0aGlzKTsKICAgIH0KICB9LAogIGVtcHR5Q2xhc3M6ICdlbXB0eScsCiAgcmVuZGVyRW1wdHk6IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuZW1wdHlWaWV3KSB7CiAgICAgIHZhciB2aWV3T3B0aW9ucyA9IHt9OwogICAgICBpZiAodGhpcy5lbXB0eVRlbXBsYXRlKSB7CiAgICAgICAgdmlld09wdGlvbnMudGVtcGxhdGUgPSB0aGlzLmVtcHR5VGVtcGxhdGU7CiAgICAgIH0KICAgICAgdmFyIHZpZXcgPSBUaG9yYXguVXRpbC5nZXRWaWV3SW5zdGFuY2UodGhpcy5lbXB0eVZpZXcsIHZpZXdPcHRpb25zKTsKICAgICAgdmlldy5lbnN1cmVSZW5kZXJlZCgpOwogICAgICByZXR1cm4gdmlldzsKICAgIH0gZWxzZSB7CiAgICAgIGlmICghdGhpcy5lbXB0eVRlbXBsYXRlKSB7CiAgICAgICAgdGhpcy5lbXB0eVRlbXBsYXRlID0gVGhvcmF4LlV0aWwuZ2V0VGVtcGxhdGUodGhpcy5uYW1lICsgJy1lbXB0eScsIHRydWUpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmVtcHR5VGVtcGxhdGUgJiYgdGhpcy5yZW5kZXJUZW1wbGF0ZSh0aGlzLmVtcHR5VGVtcGxhdGUpOwogICAgfQogIH0sCiAgcmVuZGVySXRlbTogZnVuY3Rpb24obW9kZWwsIGkpIHsKICAgIGlmICh0aGlzLml0ZW1WaWV3KSB7CiAgICAgIHZhciB2aWV3T3B0aW9ucyA9IHsKICAgICAgICBtb2RlbDogbW9kZWwKICAgICAgfTsKICAgICAgaWYgKHRoaXMuaXRlbVRlbXBsYXRlKSB7CiAgICAgICAgdmlld09wdGlvbnMudGVtcGxhdGUgPSB0aGlzLml0ZW1UZW1wbGF0ZTsKICAgICAgfQogICAgICB2YXIgdmlldyA9IFRob3JheC5VdGlsLmdldFZpZXdJbnN0YW5jZSh0aGlzLml0ZW1WaWV3LCB2aWV3T3B0aW9ucyk7CiAgICAgIHZpZXcuZW5zdXJlUmVuZGVyZWQoKTsKICAgICAgcmV0dXJuIHZpZXc7CiAgICB9IGVsc2UgewogICAgICBpZiAoIXRoaXMuaXRlbVRlbXBsYXRlKSB7CiAgICAgICAgdGhpcy5pdGVtVGVtcGxhdGUgPSBUaG9yYXguVXRpbC5nZXRUZW1wbGF0ZSh0aGlzLm5hbWUgKyAnLWl0ZW0nKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5yZW5kZXJUZW1wbGF0ZSh0aGlzLml0ZW1UZW1wbGF0ZSwgdGhpcy5pdGVtQ29udGV4dChtb2RlbCwgaSkpOwogICAgfQogIH0sCiAgaXRlbUNvbnRleHQ6IGZ1bmN0aW9uKG1vZGVsIC8qLCBpICovKSB7CiAgICByZXR1cm4gbW9kZWwuYXR0cmlidXRlczsKICB9LAogIGFwcGVuZEVtcHR5OiBmdW5jdGlvbigpIHsKICAgIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgICAkZWwuZW1wdHkoKTsKICAgIHZhciBlbXB0eUNvbnRlbnQgPSB0aGlzLnJlbmRlckVtcHR5KCk7CiAgICBlbXB0eUNvbnRlbnQgJiYgdGhpcy5hcHBlbmRJdGVtKGVtcHR5Q29udGVudCwgMCwgewogICAgICBzaWxlbnQ6IHRydWUKICAgIH0pOwogICAgdGhpcy50cmlnZ2VyKCdyZW5kZXJlZDplbXB0eScsIHRoaXMsIHRoaXMuY29sbGVjdGlvbik7CiAgfSwKICBnZXRDb2xsZWN0aW9uRWxlbWVudDogZnVuY3Rpb24oKSB7CiAgICB2YXIgZWxlbWVudCA9IHRoaXMuJCh0aGlzLl9jb2xsZWN0aW9uU2VsZWN0b3IpOwogICAgcmV0dXJuIGVsZW1lbnQubGVuZ3RoID09PSAwID8gdGhpcy4kZWwgOiBlbGVtZW50OwogIH0sCiAgLy8gRXZlbnRzIHRoYXQgd2lsbCBvbmx5IGJlIGJvdW5kIHRvICJ0aGlzLmNvbGxlY3Rpb24iCiAgX2NvbGxlY3Rpb25SZW5kZXJpbmdFdmVudHM6IHsKICAgIHJlc2V0OiBvbkNvbGxlY3Rpb25SZXNldCwKICAgIHNvcnQ6IG9uQ29sbGVjdGlvblJlc2V0LAogICAgZmlsdGVyOiBmdW5jdGlvbigpIHsKICAgICAgYXBwbHlWaXNpYmlsaXR5RmlsdGVyLmNhbGwodGhpcyk7CiAgICB9LAogICAgY2hhbmdlOiBmdW5jdGlvbihtb2RlbCkgewogICAgICAvLyBJZiB3ZSByZW5kZXJlZCB3aXRoIGl0ZW0gdmlld3MsIG1vZGVsIGNoYW5nZXMgd2lsbCBiZSBvYnNlcnZlZAogICAgICAvLyBieSB0aGUgZ2VuZXJhdGVkIGl0ZW0gdmlldyBidXQgaWYgd2UgcmVuZGVyZWQgd2l0aCB0ZW1wbGF0ZXMKICAgICAgLy8gdGhlbiBtb2RlbCBjaGFuZ2VzIG5lZWQgdG8gYmUgYm91bmQgYXMgbm90aGluZyBpcyB3YXRjaGluZwogICAgICAhdGhpcy5pdGVtVmlldyAmJiB0aGlzLnVwZGF0ZUl0ZW0obW9kZWwpOwogICAgICBhcHBseUl0ZW1WaXNpYmxpdHlGaWx0ZXIuY2FsbCh0aGlzLCBtb2RlbCk7CiAgICB9LAogICAgYWRkOiBmdW5jdGlvbihtb2RlbCkgewogICAgICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogICAgICB0aGlzLmNvbGxlY3Rpb24ubGVuZ3RoID09PSAxICYmICRlbC5sZW5ndGggJiYgaGFuZGxlQ2hhbmdlRnJvbUVtcHR5VG9Ob3RFbXB0eS5jYWxsKHRoaXMpOwogICAgICBpZiAoJGVsLmxlbmd0aCkgewogICAgICAgIHZhciBpbmRleCA9IHRoaXMuY29sbGVjdGlvbi5pbmRleE9mKG1vZGVsKTsKICAgICAgICB0aGlzLmFwcGVuZEl0ZW0obW9kZWwsIGluZGV4KTsKICAgICAgfQogICAgfSwKICAgIHJlbW92ZTogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgdmFyICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICAgICAgdGhpcy5yZW1vdmVJdGVtKG1vZGVsKTsKICAgICAgdGhpcy5jb2xsZWN0aW9uLmxlbmd0aCA9PT0gMCAmJiAkZWwubGVuZ3RoICYmIGhhbmRsZUNoYW5nZUZyb21Ob3RFbXB0eVRvRW1wdHkuY2FsbCh0aGlzKTsKICAgIH0KICB9Cn0pOwoKVGhvcmF4LlZpZXcub24oewogIGNvbGxlY3Rpb246IHsKICAgIGVycm9yOiBmdW5jdGlvbihjb2xsZWN0aW9uLCBtZXNzYWdlKSB7CiAgICAgIGlmICh0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbY29sbGVjdGlvbi5jaWRdLmVycm9ycykgewogICAgICAgIHRoaXMudHJpZ2dlcignZXJyb3InLCBtZXNzYWdlLCBjb2xsZWN0aW9uKTsKICAgICAgfQogICAgfQogIH0KfSk7CgpmdW5jdGlvbiBvbkNvbGxlY3Rpb25SZXNldChjb2xsZWN0aW9uKSB7CiAgaWYgKGNvbGxlY3Rpb24gPT09IHRoaXMuY29sbGVjdGlvbiAmJiB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbdGhpcy5jb2xsZWN0aW9uLmNpZF0ucmVuZGVyKSB7CiAgICB0aGlzLnJlbmRlckNvbGxlY3Rpb24oKTsKICB9Cn0KCmZ1bmN0aW9uIGFmdGVyU2V0Q29sbGVjdGlvbihjb2xsZWN0aW9uKSB7CiAgaWYgKCFjb2xsZWN0aW9uSGVscGVyUHJlc2VudEZvclByaW1hcnlDb2xsZWN0aW9uLmNhbGwodGhpcykgJiYgY29sbGVjdGlvbikgewogICAgXy5lYWNoKHRoaXMuX2NvbGxlY3Rpb25SZW5kZXJpbmdFdmVudHMsIGZ1bmN0aW9uKGNhbGxiYWNrLCBldmVudE5hbWUpIHsKICAgICAgLy8gZ2V0RXZlbnRDYWxsYmFjayB3aWxsIHJlc29sdmUgaWYgaXQgaXMgYSBzdHJpbmcgb3IgYSBtZXRob2QKICAgICAgLy8gYW5kIHJldHVybiBhIG1ldGhvZAogICAgICB0aGlzLmxpc3RlblRvKGNvbGxlY3Rpb24sIGV2ZW50TmFtZSwgZ2V0RXZlbnRDYWxsYmFjayhjYWxsYmFjaywgdGhpcykpOwogICAgfSwgdGhpcyk7CiAgfQp9CgpmdW5jdGlvbiBjb2xsZWN0aW9uSGVscGVyUHJlc2VudEZvclByaW1hcnlDb2xsZWN0aW9uKCkgewogIHJldHVybiB0aGlzLmNvbGxlY3Rpb24gJiYgdGhpcy4kKCdbJyArIHByaW1hcnlDb2xsZWN0aW9uQXR0cmlidXRlTmFtZSArICc9IicgKyB0aGlzLmNvbGxlY3Rpb24uY2lkICsgJyJdJykubGVuZ3RoOwp9CgpmdW5jdGlvbiBhcHBseVZpc2liaWxpdHlGaWx0ZXIoKSB7CiAgaWYgKHRoaXMuaXRlbUZpbHRlcikgewogICAgdGhpcy5jb2xsZWN0aW9uLmZvckVhY2goZnVuY3Rpb24obW9kZWwpIHsKICAgICAgYXBwbHlJdGVtVmlzaWJsaXR5RmlsdGVyLmNhbGwodGhpcywgbW9kZWwpOwogICAgfSwgdGhpcyk7CiAgfQp9CgpmdW5jdGlvbiBhcHBseUl0ZW1WaXNpYmxpdHlGaWx0ZXIobW9kZWwpIHsKICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogIHRoaXMuaXRlbUZpbHRlciAmJiAkZWwuZmluZCgnWycgKyBtb2RlbENpZEF0dHJpYnV0ZU5hbWUgKyAnPSInICsgbW9kZWwuY2lkICsgJyJdJylbaXRlbVNob3VsZEJlVmlzaWJsZS5jYWxsKHRoaXMsIG1vZGVsKSA/ICdzaG93JyA6ICdoaWRlJ10oKTsKfQoKZnVuY3Rpb24gaXRlbVNob3VsZEJlVmlzaWJsZShtb2RlbCkgewogIHJldHVybiB0aGlzLml0ZW1GaWx0ZXIobW9kZWwsIHRoaXMuY29sbGVjdGlvbi5pbmRleE9mKG1vZGVsKSk7Cn0KCmZ1bmN0aW9uIGhhbmRsZUNoYW5nZUZyb21FbXB0eVRvTm90RW1wdHkoKSB7CiAgdmFyICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICB0aGlzLmVtcHR5Q2xhc3MgJiYgJGVsLnJlbW92ZUNsYXNzKHRoaXMuZW1wdHlDbGFzcyk7CiAgJGVsLnJlbW92ZUF0dHIoY29sbGVjdGlvbkVtcHR5QXR0cmlidXRlTmFtZSk7CiAgJGVsLmVtcHR5KCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZUNoYW5nZUZyb21Ob3RFbXB0eVRvRW1wdHkoKSB7CiAgdmFyICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICB0aGlzLmVtcHR5Q2xhc3MgJiYgJGVsLmFkZENsYXNzKHRoaXMuZW1wdHlDbGFzcyk7CiAgJGVsLmF0dHIoY29sbGVjdGlvbkVtcHR5QXR0cmlidXRlTmFtZSwgdHJ1ZSk7CiAgdGhpcy5hcHBlbmRFbXB0eSgpOwp9CgovLyQoc2VsZWN0b3IpLmNvbGxlY3Rpb24oKSBoZWxwZXIKJC5mbi5jb2xsZWN0aW9uID0gZnVuY3Rpb24odmlldykgewogIGlmICh2aWV3ICYmIHZpZXcuY29sbGVjdGlvbikgewogICAgcmV0dXJuIHZpZXcuY29sbGVjdGlvbjsKICB9CiAgdmFyICR0aGlzID0gJCh0aGlzKSwKICAgICAgY29sbGVjdGlvbkVsZW1lbnQgPSAkdGhpcy5jbG9zZXN0KCdbJyArIGNvbGxlY3Rpb25DaWRBdHRyaWJ1dGVOYW1lICsgJ10nKSwKICAgICAgY29sbGVjdGlvbkNpZCA9IGNvbGxlY3Rpb25FbGVtZW50ICYmIGNvbGxlY3Rpb25FbGVtZW50LmF0dHIoY29sbGVjdGlvbkNpZEF0dHJpYnV0ZU5hbWUpOwogIGlmIChjb2xsZWN0aW9uQ2lkKSB7CiAgICB2aWV3ID0gJHRoaXMudmlldygpOwogICAgaWYgKHZpZXcpIHsKICAgICAgcmV0dXJuIHZpZXcuY29sbGVjdGlvbjsKICAgIH0KICB9CiAgcmV0dXJuIGZhbHNlOwp9OwoKOzsKLypnbG9iYWwgaW5oZXJpdFZhcnMgKi8KCmluaGVyaXRWYXJzLm1vZGVsLmRlZmF1bHRPcHRpb25zLnBvcHVsYXRlID0gdHJ1ZTsKCnZhciBvbGRNb2RlbENoYW5nZSA9IGluaGVyaXRWYXJzLm1vZGVsLmNoYW5nZTsKaW5oZXJpdFZhcnMubW9kZWwuY2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgb2xkTW9kZWxDaGFuZ2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAvLyBUT0RPIDogV2hhdCBjYW4gd2UgZG8gdG8gcmVtb3ZlIHRoaXMgZHVwbGljYXRpb24/CiAgdmFyIG1vZGVsT3B0aW9ucyA9IHRoaXMubW9kZWwgJiYgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW3RoaXMubW9kZWwuY2lkXTsKICBpZiAobW9kZWxPcHRpb25zICYmIG1vZGVsT3B0aW9ucy5wb3B1bGF0ZSkgewogICAgdGhpcy5wb3B1bGF0ZSh0aGlzLm1vZGVsLmF0dHJpYnV0ZXMsIG1vZGVsT3B0aW9ucy5wb3B1bGF0ZSA9PT0gdHJ1ZSA/IHt9IDogbW9kZWxPcHRpb25zLnBvcHVsYXRlKTsKICB9Cn07CmluaGVyaXRWYXJzLm1vZGVsLmRlZmF1bHRPcHRpb25zLnBvcHVsYXRlID0gdHJ1ZTsKCl8uZXh0ZW5kKFRob3JheC5WaWV3LnByb3RvdHlwZSwgewogIC8vc2VyaWFsaXplcyBhIGZvcm0gcHJlc2VudCBpbiB0aGUgdmlldywgcmV0dXJuaW5nIHRoZSBzZXJpYWxpemVkIGRhdGEKICAvL2FzIGFuIG9iamVjdAogIC8vcGFzcyB7c2V0OmZhbHNlfSB0byBub3QgdXBkYXRlIHRoaXMubW9kZWwgaWYgcHJlc2VudAogIC8vY2FuIHBhc3Mgb3B0aW9ucywgY2FsbGJhY2sgb3IgZXZlbnQgaW4gYW55IG9yZGVyCiAgc2VyaWFsaXplOiBmdW5jdGlvbigpIHsKICAgIHZhciBjYWxsYmFjaywgb3B0aW9ucywgZXZlbnQ7CiAgICAvL2lnbm9yZSB1bmRlZmluZWQgYXJndW1lbnRzIGluIGNhc2UgZXZlbnQgd2FzIG51bGwKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgKytpKSB7CiAgICAgIGlmICh0eXBlb2YgYXJndW1lbnRzW2ldID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgY2FsbGJhY2sgPSBhcmd1bWVudHNbaV07CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZ3VtZW50c1tpXSA9PT0gJ29iamVjdCcpIHsKICAgICAgICBpZiAoJ3N0b3BQcm9wYWdhdGlvbicgaW4gYXJndW1lbnRzW2ldICYmICdwcmV2ZW50RGVmYXVsdCcgaW4gYXJndW1lbnRzW2ldKSB7CiAgICAgICAgICBldmVudCA9IGFyZ3VtZW50c1tpXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgb3B0aW9ucyA9IGFyZ3VtZW50c1tpXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAoZXZlbnQgJiYgIXRoaXMuX3ByZXZlbnREdXBsaWNhdGVTdWJtaXNzaW9uKGV2ZW50KSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHsKICAgICAgc2V0OiB0cnVlLAogICAgICB2YWxpZGF0ZTogdHJ1ZSwKICAgICAgY2hpbGRyZW46IHRydWUsCiAgICAgIHNpbGVudDogdHJ1ZQogICAgfSwgb3B0aW9ucyB8fCB7fSk7CgogICAgdmFyIGF0dHJpYnV0ZXMgPSBvcHRpb25zLmF0dHJpYnV0ZXMgfHwge307CgogICAgLy9jYWxsYmFjayBoYXMgY29udGV4dCBvZiBlbGVtZW50CiAgICB2YXIgdmlldyA9IHRoaXM7CiAgICB2YXIgZXJyb3JzID0gW107CiAgICBlYWNoTmFtZWRJbnB1dC5jYWxsKHRoaXMsIG9wdGlvbnMsIGZ1bmN0aW9uKCkgewogICAgICB2YXIgdmFsdWUgPSB2aWV3Ll9nZXRJbnB1dFZhbHVlKHRoaXMsIG9wdGlvbnMsIGVycm9ycyk7CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgb2JqZWN0QW5kS2V5RnJvbUF0dHJpYnV0ZXNBbmROYW1lLmNhbGwodGhpcywgYXR0cmlidXRlcywgdGhpcy5uYW1lLCB7bW9kZTogJ3NlcmlhbGl6ZSd9LCBmdW5jdGlvbihvYmplY3QsIGtleSkgewogICAgICAgICAgaWYgKCFvYmplY3Rba2V5XSkgewogICAgICAgICAgICBvYmplY3Rba2V5XSA9IHZhbHVlOwogICAgICAgICAgfSBlbHNlIGlmIChfLmlzQXJyYXkob2JqZWN0W2tleV0pKSB7CiAgICAgICAgICAgIG9iamVjdFtrZXldLnB1c2godmFsdWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgb2JqZWN0W2tleV0gPSBbb2JqZWN0W2tleV0sIHZhbHVlXTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CgogICAgdGhpcy50cmlnZ2VyKCdzZXJpYWxpemUnLCBhdHRyaWJ1dGVzLCBvcHRpb25zKTsKCiAgICBpZiAob3B0aW9ucy52YWxpZGF0ZSkgewogICAgICB2YXIgdmFsaWRhdGVJbnB1dEVycm9ycyA9IHRoaXMudmFsaWRhdGVJbnB1dChhdHRyaWJ1dGVzKTsKICAgICAgaWYgKHZhbGlkYXRlSW5wdXRFcnJvcnMgJiYgdmFsaWRhdGVJbnB1dEVycm9ycy5sZW5ndGgpIHsKICAgICAgICBlcnJvcnMgPSBlcnJvcnMuY29uY2F0KHZhbGlkYXRlSW5wdXRFcnJvcnMpOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlcigndmFsaWRhdGUnLCBhdHRyaWJ1dGVzLCBlcnJvcnMsIG9wdGlvbnMpOwogICAgICBpZiAoZXJyb3JzLmxlbmd0aCkgewogICAgICAgIHRoaXMudHJpZ2dlcignZXJyb3InLCBlcnJvcnMpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQoKICAgIGlmIChvcHRpb25zLnNldCAmJiB0aGlzLm1vZGVsKSB7CiAgICAgIGlmICghdGhpcy5tb2RlbC5zZXQoYXR0cmlidXRlcywge3NpbGVudDogb3B0aW9ucy5zaWxlbnR9KSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQoKICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrLmNhbGwodGhpcywgYXR0cmlidXRlcywgXy5iaW5kKHJlc2V0U3VibWl0U3RhdGUsIHRoaXMpKTsKICAgIHJldHVybiBhdHRyaWJ1dGVzOwogIH0sCgogIF9wcmV2ZW50RHVwbGljYXRlU3VibWlzc2lvbjogZnVuY3Rpb24oZXZlbnQsIGNhbGxiYWNrKSB7CiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKICAgIHZhciBmb3JtID0gJChldmVudC50YXJnZXQpOwogICAgaWYgKChldmVudC50YXJnZXQudGFnTmFtZSB8fCAnJykudG9Mb3dlckNhc2UoKSAhPT0gJ2Zvcm0nKSB7CiAgICAgIC8vIEhhbmRsZSBub24tc3VibWl0IGV2ZW50cyBieSBnYXRpbmcgb24gdGhlIGZvcm0KICAgICAgZm9ybSA9ICQoZXZlbnQudGFyZ2V0KS5jbG9zZXN0KCdmb3JtJyk7CiAgICB9CgogICAgaWYgKCFmb3JtLmF0dHIoJ2RhdGEtc3VibWl0LXdhaXQnKSkgewogICAgICBmb3JtLmF0dHIoJ2RhdGEtc3VibWl0LXdhaXQnLCAndHJ1ZScpOwogICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICBjYWxsYmFjay5jYWxsKHRoaXMsIGV2ZW50KTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9LAoKICAvL3BvcHVsYXRlIGEgZm9ybSBmcm9tIHRoZSBwYXNzZWQgYXR0cmlidXRlcyBvciB0aGlzLm1vZGVsIGlmIHByZXNlbnQKICBwb3B1bGF0ZTogZnVuY3Rpb24oYXR0cmlidXRlcywgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHsKICAgICAgY2hpbGRyZW46IHRydWUKICAgIH0sIG9wdGlvbnMgfHwge30pOwogICAgdmFyIHZhbHVlLCBhdHRyaWJ1dGVzID0gYXR0cmlidXRlcyB8fCB0aGlzLl9nZXRDb250ZXh0KCk7CiAgICAvL2NhbGxiYWNrIGhhcyBjb250ZXh0IG9mIGVsZW1lbnQKICAgIGVhY2hOYW1lZElucHV0LmNhbGwodGhpcywgb3B0aW9ucywgZnVuY3Rpb24oKSB7CiAgICAgIG9iamVjdEFuZEtleUZyb21BdHRyaWJ1dGVzQW5kTmFtZS5jYWxsKHRoaXMsIGF0dHJpYnV0ZXMsIHRoaXMubmFtZSwge21vZGU6ICdwb3B1bGF0ZSd9LCBmdW5jdGlvbihvYmplY3QsIGtleSkgewogICAgICAgIGlmIChvYmplY3QgJiYgdHlwZW9mICh2YWx1ZSA9IG9iamVjdFtrZXldKSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIC8vd2lsbCBvbmx5IGV4ZWN1dGUgaWYgd2UgaGF2ZSBhIG5hbWUgdGhhdCBtYXRjaGVzIHRoZSBzdHJ1Y3R1cmUgaW4gYXR0cmlidXRlcwogICAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gJ2NoZWNrYm94JyAmJiBfLmlzQm9vbGVhbih2YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy5jaGVja2VkID0gdmFsdWU7CiAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudHlwZSA9PT0gJ2NoZWNrYm94JyB8fCB0aGlzLnR5cGUgPT09ICdyYWRpbycpIHsKICAgICAgICAgICAgdGhpcy5jaGVja2VkID0gdmFsdWUgPT0gdGhpcy52YWx1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CgogICAgdGhpcy50cmlnZ2VyKCdwb3B1bGF0ZScsIGF0dHJpYnV0ZXMpOwogIH0sCgogIC8vcGVyZm9ybSBmb3JtIHZhbGlkYXRpb24sIGltcGxlbWVudGVkIGJ5IGNoaWxkIGNsYXNzCiAgdmFsaWRhdGVJbnB1dDogZnVuY3Rpb24oLyogYXR0cmlidXRlcywgb3B0aW9ucywgZXJyb3JzICovKSB7fSwKCiAgX2dldElucHV0VmFsdWU6IGZ1bmN0aW9uKGlucHV0IC8qICwgb3B0aW9ucywgZXJyb3JzICovKSB7CiAgICBpZiAoaW5wdXQudHlwZSA9PT0gJ2NoZWNrYm94JyB8fCBpbnB1dC50eXBlID09PSAncmFkaW8nKSB7CiAgICAgIGlmIChpbnB1dC5jaGVja2VkKSB7CiAgICAgICAgcmV0dXJuIGlucHV0LnZhbHVlOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlucHV0Lm11bHRpcGxlID09PSB0cnVlKSB7CiAgICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgICAgJCgnb3B0aW9uJywgaW5wdXQpLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWQpIHsKICAgICAgICAgIHZhbHVlcy5wdXNoKHRoaXMudmFsdWUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiB2YWx1ZXM7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gaW5wdXQudmFsdWU7CiAgICB9CiAgfQp9KTsKClRob3JheC5WaWV3Lm9uKHsKICBlcnJvcjogZnVuY3Rpb24oKSB7CiAgICByZXNldFN1Ym1pdFN0YXRlLmNhbGwodGhpcyk7CgogICAgLy8gSWYgd2UgZXJyb3JlZCB3aXRoIGEgbW9kZWwgd2Ugd2FudCB0byByZXNldCB0aGUgY29udGVudCBidXQgbGVhdmUgdGhlIFVJCiAgICAvLyBpbnRhY3QuIElmIHRoZSB1c2VyIHVwZGF0ZXMgdGhlIGRhdGEgYW5kIHNlcmlhbGl6ZXMgYW55IG92ZXJ3cml0dGVuIGRhdGEKICAgIC8vIHdpbGwgYmUgcmVzdG9yZWQuCiAgICBpZiAodGhpcy5tb2RlbCAmJiB0aGlzLm1vZGVsLnByZXZpb3VzQXR0cmlidXRlcykgewogICAgICB0aGlzLm1vZGVsLnNldCh0aGlzLm1vZGVsLnByZXZpb3VzQXR0cmlidXRlcygpLCB7CiAgICAgICAgc2lsZW50OiB0cnVlCiAgICAgIH0pOwogICAgfQogIH0sCiAgZGVhY3RpdmF0ZWQ6IGZ1bmN0aW9uKCkgewogICAgcmVzZXRTdWJtaXRTdGF0ZS5jYWxsKHRoaXMpOwogIH0KfSk7CgpmdW5jdGlvbiBlYWNoTmFtZWRJbnB1dChvcHRpb25zLCBpdGVyYXRvciwgY29udGV4dCkgewogIHZhciBpID0gMCwKICAgICAgc2VsZiA9IHRoaXM7CgogIHRoaXMuJCgnc2VsZWN0LGlucHV0LHRleHRhcmVhJywgb3B0aW9ucy5yb290IHx8IHRoaXMuZWwpLmVhY2goZnVuY3Rpb24oKSB7CiAgICBpZiAoIW9wdGlvbnMuY2hpbGRyZW4pIHsKICAgICAgaWYgKHNlbGYgIT09ICQodGhpcykudmlldyh7aGVscGVyOiBmYWxzZX0pKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgICBpZiAodGhpcy50eXBlICE9PSAnYnV0dG9uJyAmJiB0aGlzLnR5cGUgIT09ICdjYW5jZWwnICYmIHRoaXMudHlwZSAhPT0gJ3N1Ym1pdCcgJiYgdGhpcy5uYW1lICYmIHRoaXMubmFtZSAhPT0gJycpIHsKICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0IHx8IHRoaXMsIGksIHRoaXMpOwogICAgICArK2k7CiAgICB9CiAgfSk7Cn0KCi8vY2FsbHMgYSBjYWxsYmFjayB3aXRoIHRoZSBjb3JyZWN0IG9iamVjdCBmcmFnbWVudCBhbmQga2V5IGZyb20gYSBjb21wb3VuZCBuYW1lCmZ1bmN0aW9uIG9iamVjdEFuZEtleUZyb21BdHRyaWJ1dGVzQW5kTmFtZShhdHRyaWJ1dGVzLCBuYW1lLCBvcHRpb25zLCBjYWxsYmFjaykgewogIHZhciBrZXksCiAgICAgIG9iamVjdCA9IGF0dHJpYnV0ZXMsCiAgICAgIGtleXMgPSBuYW1lLnNwbGl0KCdbJyksCiAgICAgIG1vZGUgPSBvcHRpb25zLm1vZGU7CgogIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGggLSAxOyArK2kpIHsKICAgIGtleSA9IGtleXNbaV0ucmVwbGFjZSgnXScsICcnKTsKICAgIGlmICghb2JqZWN0W2tleV0pIHsKICAgICAgaWYgKG1vZGUgPT09ICdzZXJpYWxpemUnKSB7CiAgICAgICAgb2JqZWN0W2tleV0gPSB7fTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2suY2FsbCh0aGlzLCBmYWxzZSwga2V5KTsKICAgICAgfQogICAgfQogICAgb2JqZWN0ID0gb2JqZWN0W2tleV07CiAgfQogIGtleSA9IGtleXNba2V5cy5sZW5ndGggLSAxXS5yZXBsYWNlKCddJywgJycpOwogIGNhbGxiYWNrLmNhbGwodGhpcywgb2JqZWN0LCBrZXkpOwp9CgpmdW5jdGlvbiByZXNldFN1Ym1pdFN0YXRlKCkgewogIHRoaXMuJCgnZm9ybScpLnJlbW92ZUF0dHIoJ2RhdGEtc3VibWl0LXdhaXQnKTsKfQoKOzsKdmFyIGxheW91dENpZEF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1sYXlvdXQtY2lkJzsKClRob3JheC5MYXlvdXRWaWV3ID0gVGhvcmF4LlZpZXcuZXh0ZW5kKHsKICByZW5kZXI6IGZ1bmN0aW9uKG91dHB1dCkgewogICAgLy9UT0RPOiBmaXhtZSwgbHVtYmFyIGluc2VydHMgdGVtcGxhdGVzIGFmdGVyIEpTLCBtb3N0IG9mIHRoZSB0aW1lIHRoaXMgaXMgZmluZQogICAgLy9idXQgQXBwbGljYXRpb24gd2lsbCBiZSBjcmVhdGVkIGluIGluaXQuanMgKHVubGlrZSBtb3N0IHZpZXdzKQogICAgLy9zbyBuZWVkIHRvIHB1dCB0aGlzIGhlcmUgc28gdGhlIHRlbXBsYXRlIHdpbGwgYmUgcGlja2VkIHVwCiAgICB2YXIgbGF5b3V0VGVtcGxhdGU7CiAgICBpZiAodGhpcy5uYW1lKSB7CiAgICAgIGxheW91dFRlbXBsYXRlID0gVGhvcmF4LlV0aWwuZ2V0VGVtcGxhdGUodGhpcy5uYW1lLCB0cnVlKTsKICAgIH0KICAgIC8vYSB0ZW1wbGF0ZSBpcyBvcHRpb25hbCBpbiBhIGxheW91dAogICAgaWYgKG91dHB1dCB8fCB0aGlzLnRlbXBsYXRlIHx8IGxheW91dFRlbXBsYXRlKSB7CiAgICAgIC8vYnV0IGlmIHByZXNlbnQsIGl0IG11c3QgaGF2ZSBlbWJlZGRlZCBhbiBlbGVtZW50IGNvbnRhaW5pbmcgbGF5b3V0Q2lkQXR0cmlidXRlTmFtZSAKICAgICAgdmFyIHJlc3BvbnNlID0gVGhvcmF4LlZpZXcucHJvdG90eXBlLnJlbmRlci5jYWxsKHRoaXMsIG91dHB1dCB8fCB0aGlzLnRlbXBsYXRlIHx8IGxheW91dFRlbXBsYXRlKTsKICAgICAgZW5zdXJlTGF5b3V0Vmlld3NUYXJnZXRFbGVtZW50LmNhbGwodGhpcyk7CiAgICAgIHJldHVybiByZXNwb25zZTsKICAgIH0gZWxzZSB7CiAgICAgIGVuc3VyZUxheW91dENpZC5jYWxsKHRoaXMpOwogICAgfQogIH0sCiAgc2V0VmlldzogZnVuY3Rpb24odmlldywgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHsKICAgICAgc2Nyb2xsOiB0cnVlLAogICAgICBkZXN0cm95OiB0cnVlCiAgICB9LCBvcHRpb25zIHx8IHt9KTsKICAgIGlmICh0eXBlb2YgdmlldyA9PT0gJ3N0cmluZycpIHsKICAgICAgdmlldyA9IG5ldyAoVGhvcmF4LlV0aWwucmVnaXN0cnlHZXQoVGhvcmF4LCAnVmlld3MnLCB2aWV3LCBmYWxzZSkpKCk7CiAgICB9CiAgICB0aGlzLmVuc3VyZVJlbmRlcmVkKCk7CiAgICB2YXIgb2xkVmlldyA9IHRoaXMuX3ZpZXc7CiAgICBpZiAodmlldyA9PT0gb2xkVmlldykgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBpZiAob3B0aW9ucy5kZXN0cm95ICYmIHZpZXcpIHsKICAgICAgdmlldy5fc2hvdWxkRGVzdHJveU9uTmV4dFNldFZpZXcgPSB0cnVlOwogICAgfQoKICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOnZpZXc6c3RhcnQnLCB2aWV3LCBvbGRWaWV3LCBvcHRpb25zKTsKCiAgICBpZiAob2xkVmlldykgewogICAgICB0aGlzLl9yZW1vdmVDaGlsZChvbGRWaWV3KTsKICAgICAgb2xkVmlldy4kZWwucmVtb3ZlKCk7CiAgICAgIG9sZFZpZXcudHJpZ2dlcignZGVhY3RpdmF0ZWQnLCBvcHRpb25zKTsKICAgICAgaWYgKG9sZFZpZXcuX3Nob3VsZERlc3Ryb3lPbk5leHRTZXRWaWV3KSB7CiAgICAgICAgb2xkVmlldy5kZXN0cm95KCk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAodmlldykgewogICAgICB2aWV3LnRyaWdnZXIoJ2FjdGl2YXRlZCcsIG9wdGlvbnMpOwogICAgICB0aGlzLl9hZGRDaGlsZCh2aWV3KTsKICAgICAgdGhpcy5fdmlldyA9IHZpZXc7CiAgICAgIHRoaXMuX3ZpZXcuYXBwZW5kVG8oZ2V0TGF5b3V0Vmlld3NUYXJnZXRFbGVtZW50LmNhbGwodGhpcykpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fdmlldyA9IHVuZGVmaW5lZDsKICAgIH0KCiAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTp2aWV3OmVuZCcsIHZpZXcsIG9sZFZpZXcsIG9wdGlvbnMpOwogICAgcmV0dXJuIHZpZXc7CiAgfSwKCiAgZ2V0VmlldzogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fdmlldzsKICB9Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignbGF5b3V0JywgZnVuY3Rpb24ob3B0aW9ucykgewogIG9wdGlvbnMuaGFzaFtsYXlvdXRDaWRBdHRyaWJ1dGVOYW1lXSA9IGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXcuY2lkOwogIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZy5jYWxsKHRoaXMsIG9wdGlvbnMuaGFzaCwgJycsIHRoaXMpKTsKfSk7CgpmdW5jdGlvbiBlbnN1cmVMYXlvdXRDaWQoKSB7CiAgKyt0aGlzLl9yZW5kZXJDb3VudDsKICAvL3NldCB0aGUgbGF5b3V0Q2lkQXR0cmlidXRlTmFtZSBvbiB0aGlzLiRlbCBpZiB0aGVyZSB3YXMgbm8gdGVtcGxhdGUKICB0aGlzLiRlbC5hdHRyKGxheW91dENpZEF0dHJpYnV0ZU5hbWUsIHRoaXMuY2lkKTsKfQoKZnVuY3Rpb24gZW5zdXJlTGF5b3V0Vmlld3NUYXJnZXRFbGVtZW50KCkgewogIGlmICghdGhpcy4kKCdbJyArIGxheW91dENpZEF0dHJpYnV0ZU5hbWUgKyAnPSInICsgdGhpcy5jaWQgKyAnIl0nKVswXSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdObyBsYXlvdXQgZWxlbWVudCBmb3VuZCBpbiAnICsgKHRoaXMubmFtZSB8fCB0aGlzLmNpZCkpOwogIH0KfQoKZnVuY3Rpb24gZ2V0TGF5b3V0Vmlld3NUYXJnZXRFbGVtZW50KCkgewogIHJldHVybiB0aGlzLiQoJ1snICsgbGF5b3V0Q2lkQXR0cmlidXRlTmFtZSArICc9IicgKyB0aGlzLmNpZCArICciXScpWzBdIHx8IHRoaXMuZWxbMF0gfHwgdGhpcy5lbDsKfQoKOzsKLypnbG9iYWwgY3JlYXRlUmVnaXN0cnlXcmFwcGVyICovCgovL1JvdXRlcgpmdW5jdGlvbiBpbml0aWFsaXplUm91dGVyKCkgewogIEJhY2tib25lLmhpc3RvcnkgfHwgKEJhY2tib25lLmhpc3RvcnkgPSBuZXcgQmFja2JvbmUuSGlzdG9yeSgpKTsKICBCYWNrYm9uZS5oaXN0b3J5Lm9uKCdyb3V0ZScsIG9uUm91dGUsIHRoaXMpOwogIC8vcm91dGVyIGRvZXMgbm90IGhhdmUgYSBidWlsdCBpbiBkZXN0cm95IGV2ZW50CiAgLy9idXQgVmlld0NvbnRyb2xsZXIgZG9lcwogIHRoaXMub24oJ2Rlc3Ryb3llZCcsIGZ1bmN0aW9uKCkgewogICAgQmFja2JvbmUuaGlzdG9yeS5vZmYoJ3JvdXRlJywgb25Sb3V0ZSwgdGhpcyk7CiAgfSk7Cn0KClRob3JheC5Sb3V0ZXIgPSBCYWNrYm9uZS5Sb3V0ZXIuZXh0ZW5kKHsKICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oKSB7CiAgICB2YXIgcmVzcG9uc2UgPSBUaG9yYXguUm91dGVyLl9fc3VwZXJfXy5jb25zdHJ1Y3Rvci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaW5pdGlhbGl6ZVJvdXRlci5jYWxsKHRoaXMpOwogICAgcmV0dXJuIHJlc3BvbnNlOwogIH0sCiAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBuYW1lLCBjYWxsYmFjaykgewogICAgaWYgKCFjYWxsYmFjaykgewogICAgICBjYWxsYmFjayA9IHRoaXNbbmFtZV07CiAgICB9CiAgICAvL2FkZCBhIHJvdXRlOmJlZm9yZSBldmVudCB0aGF0IGlzIGZpcmVkIGJlZm9yZSB0aGUgY2FsbGJhY2sgaXMgY2FsbGVkCiAgICByZXR1cm4gQmFja2JvbmUuUm91dGVyLnByb3RvdHlwZS5yb3V0ZS5jYWxsKHRoaXMsIHJvdXRlLCBuYW1lLCBmdW5jdGlvbigpIHsKICAgICAgdGhpcy50cmlnZ2VyLmFwcGx5KHRoaXMsIFsncm91dGU6YmVmb3JlJywgcm91dGUsIG5hbWVdLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgIHJldHVybiBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSk7CiAgfQp9KTsKClRob3JheC5Sb3V0ZXJzID0ge307CmNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcihUaG9yYXguUm91dGVyLCBUaG9yYXguUm91dGVycyk7CgpmdW5jdGlvbiBvblJvdXRlKHJvdXRlciAvKiAsIG5hbWUgKi8pIHsKICBpZiAodGhpcyA9PT0gcm91dGVyKSB7CiAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgWydyb3V0ZSddLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKSk7CiAgfQp9Cgo7OwpUaG9yYXguQ29sbGVjdGlvbkhlbHBlclZpZXcgPSBUaG9yYXguSGVscGVyVmlldy5leHRlbmQoewogIC8vIEZvcndhcmQgcmVuZGVyIGV2ZW50cyB0byB0aGUgcGFyZW50CiAgZXZlbnRzOiB7CiAgICAncmVuZGVyZWQ6aXRlbSc6IGZvcndhcmRSZW5kZXJFdmVudCgncmVuZGVyZWQ6aXRlbScpLAogICAgJ3JlbmRlcmVkOmNvbGxlY3Rpb24nOiBmb3J3YXJkUmVuZGVyRXZlbnQoJ3JlbmRlcmVkOmNvbGxlY3Rpb24nKSwKICAgICdyZW5kZXJlZDplbXB0eSc6IGZvcndhcmRSZW5kZXJFdmVudCgncmVuZGVyZWQ6ZW1wdHknKQogIH0sCiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIF8uZWFjaChjb2xsZWN0aW9uT3B0aW9uTmFtZXMsIGZ1bmN0aW9uKHZpZXdBdHRyaWJ1dGVOYW1lLCBoZWxwZXJPcHRpb25OYW1lKSB7CiAgICAgIGlmIChvcHRpb25zLm9wdGlvbnNbaGVscGVyT3B0aW9uTmFtZV0pIHsKICAgICAgICB2YXIgdmFsdWUgPSBvcHRpb25zLm9wdGlvbnNbaGVscGVyT3B0aW9uTmFtZV07CiAgICAgICAgaWYgKHZpZXdBdHRyaWJ1dGVOYW1lID09PSAnaXRlbVRlbXBsYXRlJyB8fCB2aWV3QXR0cmlidXRlTmFtZSA9PT0gJ2VtcHR5VGVtcGxhdGUnKSB7CiAgICAgICAgICB2YWx1ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgb3B0aW9uc1t2aWV3QXR0cmlidXRlTmFtZV0gPSB2YWx1ZTsKICAgICAgfQogICAgfSk7CiAgICAvLyBIYW5kbGViYXJzLlZNLm5vb3AgaXMgcGFzc2VkIGluIHRoZSBoYW5kbGViYXJzIG9wdGlvbnMgb2JqZWN0IGFzCiAgICAvLyBhIGRlZmF1bHQgZm9yIGZuIGFuZCBpbnZlcnNlLCBpZiBhIGJsb2NrIHdhcyBwcmVzZW50LiBOZWVkIHRvCiAgICAvLyBjaGVjayB0byBlbnN1cmUgd2UgZG9uJ3QgcGljayB0aGUgZW1wdHkgLyBudWxsIGJsb2NrIHVwLgogICAgaWYgKCFvcHRpb25zLml0ZW1UZW1wbGF0ZSAmJiBvcHRpb25zLnRlbXBsYXRlICYmIG9wdGlvbnMudGVtcGxhdGUgIT09IEhhbmRsZWJhcnMuVk0ubm9vcCkgewogICAgICBvcHRpb25zLml0ZW1UZW1wbGF0ZSA9IG9wdGlvbnMudGVtcGxhdGU7CiAgICAgIG9wdGlvbnMudGVtcGxhdGUgPSBIYW5kbGViYXJzLlZNLm5vb3A7CiAgICB9CiAgICBpZiAoIW9wdGlvbnMuZW1wdHlUZW1wbGF0ZSAmJiBvcHRpb25zLmludmVyc2UgJiYgb3B0aW9ucy5pbnZlcnNlICE9PSBIYW5kbGViYXJzLlZNLm5vb3ApIHsKICAgICAgb3B0aW9ucy5lbXB0eVRlbXBsYXRlID0gb3B0aW9ucy5pbnZlcnNlOwogICAgICBvcHRpb25zLmludmVyc2UgPSBIYW5kbGViYXJzLlZNLm5vb3A7CiAgICB9CiAgICAhb3B0aW9ucy50ZW1wbGF0ZSAmJiAob3B0aW9ucy50ZW1wbGF0ZSA9IEhhbmRsZWJhcnMuVk0ubm9vcCk7CiAgICB2YXIgcmVzcG9uc2UgPSBUaG9yYXguSGVscGVyVmlldy5jYWxsKHRoaXMsIG9wdGlvbnMpOwogICAgaWYgKHRoaXMucGFyZW50Lm5hbWUpIHsKICAgICAgaWYgKCF0aGlzLmVtcHR5VGVtcGxhdGUpIHsKICAgICAgICB0aGlzLmVtcHR5VGVtcGxhdGUgPSBUaG9yYXguVXRpbC5nZXRUZW1wbGF0ZSh0aGlzLnBhcmVudC5uYW1lICsgJy1lbXB0eScsIHRydWUpOwogICAgICB9CiAgICAgIGlmICghdGhpcy5pdGVtVGVtcGxhdGUpIHsKICAgICAgICB0aGlzLml0ZW1UZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRoaXMucGFyZW50Lm5hbWUgKyAnLWl0ZW0nLCB0cnVlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3BvbnNlOwogIH0sCiAgaXRlbUNvbnRleHQ6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMucGFyZW50Lml0ZW1Db250ZXh0LmFwcGx5KHRoaXMucGFyZW50LCBhcmd1bWVudHMpOwogIH0sCiAgc2V0QXNQcmltYXJ5Q29sbGVjdGlvbkhlbHBlcjogZnVuY3Rpb24oY29sbGVjdGlvbikgewogICAgdGhpcy4kZWwuYXR0cihwcmltYXJ5Q29sbGVjdGlvbkF0dHJpYnV0ZU5hbWUsIGNvbGxlY3Rpb24uY2lkKTsKICAgIF8uZWFjaChmb3J3YXJkYWJsZVByb3BlcnRpZXMsIGZ1bmN0aW9uKHByb3BlcnR5TmFtZSkgewogICAgICBmb3J3YXJkTWlzc2luZ1Byb3BlcnR5LmNhbGwodGhpcywgcHJvcGVydHlOYW1lKTsKICAgIH0sIHRoaXMpOwogICAgaWYgKHRoaXMucGFyZW50Lml0ZW1GaWx0ZXIpIHsKICAgICAgdGhpcy5pdGVtRmlsdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucGFyZW50Lml0ZW1GaWx0ZXIuYXBwbHkodGhpcy5wYXJlbnQsIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICB9CiAgfQp9KTsKCnZhciBjb2xsZWN0aW9uT3B0aW9uTmFtZXMgPSB7CiAgJ2l0ZW0tdGVtcGxhdGUnOiAnaXRlbVRlbXBsYXRlJywKICAnZW1wdHktdGVtcGxhdGUnOiAnZW1wdHlUZW1wbGF0ZScsCiAgJ2l0ZW0tdmlldyc6ICdpdGVtVmlldycsCiAgJ2VtcHR5LXZpZXcnOiAnZW1wdHlWaWV3JywKICAnZW1wdHktY2xhc3MnOiAnZW1wdHlDbGFzcycKfTsKCmZ1bmN0aW9uIGZvcndhcmRSZW5kZXJFdmVudChldmVudE5hbWUpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB2YXIgYXJncyA9IF8udG9BcnJheShhcmd1bWVudHMpOwogICAgYXJncy51bnNoaWZ0KGV2ZW50TmFtZSk7CiAgICB0aGlzLnBhcmVudC50cmlnZ2VyLmFwcGx5KHRoaXMucGFyZW50LCBhcmdzKTsKICB9Cn0KCnZhciBmb3J3YXJkYWJsZVByb3BlcnRpZXMgPSBbCiAgJ2l0ZW1UZW1wbGF0ZScsCiAgJ2l0ZW1WaWV3JywKICAnZW1wdHlUZW1wbGF0ZScsCiAgJ2VtcHR5VmlldycKXTsKCmZ1bmN0aW9uIGZvcndhcmRNaXNzaW5nUHJvcGVydHkocHJvcGVydHlOYW1lKSB7CiAgdmFyIHBhcmVudCA9IGdldFBhcmVudCh0aGlzKTsKICBpZiAoIXRoaXNbcHJvcGVydHlOYW1lXSkgewogICAgdmFyIHByb3AgPSBwYXJlbnRbcHJvcGVydHlOYW1lXTsKICAgIGlmIChwcm9wKXsKICAgICAgdGhpc1twcm9wZXJ0eU5hbWVdID0gcHJvcDsKICAgIH0KICB9Cn0KCkhhbmRsZWJhcnMucmVnaXN0ZXJWaWV3SGVscGVyKCdjb2xsZWN0aW9uJywgVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3LCBmdW5jdGlvbihjb2xsZWN0aW9uLCB2aWV3KSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgIHZpZXcgPSBjb2xsZWN0aW9uOwogICAgY29sbGVjdGlvbiA9IHZpZXcuZGVjbGFyaW5nVmlldy5jb2xsZWN0aW9uOwogIH0KICAvLyBOZWVkIGFkZGl0aW9uYWwgY2hlY2sgaGVyZSB0byBzZWUgaWYgaXQgaXMgdGhlCiAgLy8gcHJpbWFyeSBjb2xsZWN0aW9uIGFzIHRlbXBsYXRlcyBjYW4gZG86CiAgLy8gI2NvbGxlY3Rpb24gdGhpcy5jb2xsZWN0aW9uCiAgaWYgKGNvbGxlY3Rpb24gJiYgY29sbGVjdGlvbiA9PT0gdmlldy5kZWNsYXJpbmdWaWV3LmNvbGxlY3Rpb24pIHsKICAgIGVuc3VyZURhdGFPYmplY3RDaWQoJ2NvbGxlY3Rpb24nLCBjb2xsZWN0aW9uKTsKICAgIHZpZXcuc2V0QXNQcmltYXJ5Q29sbGVjdGlvbkhlbHBlcihjb2xsZWN0aW9uKTsKICB9CiAgLy8gTWFyayBwcmltYXJ5IGNvbGxlY3Rpb24gZWxlbWVudCB3aXRoIGNvbGxlY3Rpb24gZWxlbWVudCBhdHRyaWJ1dGUgc28gdGhhdAogIC8vIGl0IGNhbiBiZSBmb3VuZCBieSBnZXRDb2xsZWN0aW9uRWxlbWVudCBtZXRob2QKICAvLyBUaGlzIHdpbGwgZXhlY3V0ZSBpZiBib3RoIGNvbGxlY3Rpb24gYW5kIHRoZSBkZWxjYXJpbmcgdmlldydzIGNvbGxlY3Rpb24KICAvLyBhcmUgbnVsbCBpbiBjYXNlcyB3aGVyZSB7e2NvbGxlY3Rpb259fSB3YXMgZGVjbGFyZWQgaW4gYSB2aWV3IGFuZAogIC8vIHNldENvbGxlY3Rpb24gaGFzIG5vdCB5ZXQgYmVlbiBjYWxsZWQKICBpZiAoY29sbGVjdGlvbiA9PT0gdmlldy5kZWNsYXJpbmdWaWV3LmNvbGxlY3Rpb24pIHsKICAgIHZpZXcuJGVsLmF0dHIoY29sbGVjdGlvbkVsZW1lbnRBdHRyaWJ1dGVOYW1lLCAndHJ1ZScpOwogIH0KICBjb2xsZWN0aW9uICYmIHZpZXcuc2V0Q29sbGVjdGlvbihjb2xsZWN0aW9uKTsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdjb2xsZWN0aW9uLWVsZW1lbnQnLCBmdW5jdGlvbihvcHRpb25zKSB7CiAgb3B0aW9ucy5oYXNoLnRhZyA9IG9wdGlvbnMuaGFzaC50YWcgfHwgb3B0aW9ucy5oYXNoLnRhZ05hbWUgfHwgJ2Rpdic7CiAgb3B0aW9ucy5oYXNoW2NvbGxlY3Rpb25FbGVtZW50QXR0cmlidXRlTmFtZV0gPSB0cnVlOwogIHJldHVybiBuZXcgSGFuZGxlYmFycy5TYWZlU3RyaW5nKFRob3JheC5VdGlsLnRhZy5jYWxsKHRoaXMsIG9wdGlvbnMuaGFzaCwgJycsIHRoaXMpKTsKfSk7Cgo7OwpIYW5kbGViYXJzLnJlZ2lzdGVyVmlld0hlbHBlcignZW1wdHknLCBmdW5jdGlvbihjb2xsZWN0aW9uLCB2aWV3KSB7CiAgdmFyIGVtcHR5LCBub0FyZ3VtZW50OwogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICB2aWV3ID0gY29sbGVjdGlvbjsKICAgIGNvbGxlY3Rpb24gPSBmYWxzZTsKICAgIG5vQXJndW1lbnQgPSB0cnVlOwogIH0KCiAgdmFyIF9yZW5kZXIgPSB2aWV3LnJlbmRlcjsKICB2aWV3LnJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgaWYgKG5vQXJndW1lbnQpIHsKICAgICAgZW1wdHkgPSAhdGhpcy5wYXJlbnQubW9kZWwgfHwgdGhpcy5wYXJlbnQubW9kZWwuaXNFbXB0eSgpOwogICAgfSBlbHNlIHsKICAgICAgZW1wdHkgPSAhY29sbGVjdGlvbiB8fCBjb2xsZWN0aW9uLmlzRW1wdHkoKTsKICAgIH0KICAgIGlmIChlbXB0eSkgewogICAgICB0aGlzLnBhcmVudC50cmlnZ2VyKCdyZW5kZXJlZDplbXB0eScsIHRoaXMsIGNvbGxlY3Rpb24pOwogICAgICByZXR1cm4gX3JlbmRlci5jYWxsKHRoaXMsIHRoaXMudGVtcGxhdGUpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIF9yZW5kZXIuY2FsbCh0aGlzLCB0aGlzLmludmVyc2UpOwogICAgfQogIH07CgogIHZhciByZW5kZXIgPSBfLmJpbmQodmlldy5yZW5kZXIsIHZpZXcpOwoKICBpZiAobm9Bcmd1bWVudCkgewogICAgdmlldy5saXN0ZW5Ubyh2aWV3LnBhcmVudCwgJ2NoYW5nZTpkYXRhLW9iamVjdCcsIGZ1bmN0aW9uKHR5cGUsIG9iamVjdCwgb2xkKSB7CiAgICAgIGlmICh0eXBlID09PSAnbW9kZWwnKSB7CiAgICAgICAgaWYgKG9sZCkgewogICAgICAgICAgdmlldy5zdG9wTGlzdGVuaW5nKG9sZCk7CiAgICAgICAgfQogICAgICAgIGlmIChvYmplY3QpIHsKICAgICAgICAgIHZpZXcubGlzdGVuVG8ob2JqZWN0LCAnY2hhbmdlJywgcmVuZGVyKTsKICAgICAgICB9CiAgICAgICAgcmVuZGVyKCk7CiAgICAgIH0KICAgIH0pOwogICAgaWYgKHZpZXcucGFyZW50Lm1vZGVsKSB7CiAgICAgIHZpZXcubGlzdGVuVG8odmlldy5wYXJlbnQubW9kZWwsICdjaGFuZ2UnLCByZW5kZXIpOwogICAgfQogIH0gZWxzZSBpZiAoY29sbGVjdGlvbikgewogICAgdmlldy5saXN0ZW5Ubyhjb2xsZWN0aW9uLCAncmVtb3ZlJywgZnVuY3Rpb24oKSB7CiAgICAgIGlmIChjb2xsZWN0aW9uLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJlbmRlcigpOwogICAgICB9CiAgICB9KTsKICAgIHZpZXcubGlzdGVuVG8oY29sbGVjdGlvbiwgJ2FkZCcsIGZ1bmN0aW9uKCkgewogICAgICBpZiAoY29sbGVjdGlvbi5sZW5ndGggPT09IDEpIHsKICAgICAgICByZW5kZXIoKTsKICAgICAgfQogICAgfSk7CiAgICB2aWV3Lmxpc3RlblRvKGNvbGxlY3Rpb24sICdyZXNldCcsIHJlbmRlcik7CiAgfQoKICByZW5kZXIoKTsKfSk7Cgo7OwpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd0ZW1wbGF0ZScsIGZ1bmN0aW9uKG5hbWUsIG9wdGlvbnMpIHsKICB2YXIgY29udGV4dCA9IF8uZXh0ZW5kKHtmbjogb3B0aW9ucyAmJiBvcHRpb25zLmZufSwgdGhpcywgb3B0aW9ucyA/IG9wdGlvbnMuaGFzaCA6IHt9KTsKICB2YXIgb3V0cHV0ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldy5yZW5kZXJUZW1wbGF0ZShuYW1lLCBjb250ZXh0KTsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhvdXRwdXQpOwp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3lpZWxkJywgZnVuY3Rpb24ob3B0aW9ucykgewogIHJldHVybiBnZXRPcHRpb25zRGF0YShvcHRpb25zKS55aWVsZCAmJiBvcHRpb25zLmRhdGEueWllbGQoKTsKfSk7Cgo7OwpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd1cmwnLCBmdW5jdGlvbih1cmwpIHsKICB2YXIgZnJhZ21lbnQ7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAyKSB7CiAgICBmcmFnbWVudCA9IF8ubWFwKF8uaGVhZChhcmd1bWVudHMsIGFyZ3VtZW50cy5sZW5ndGggLSAxKSwgZW5jb2RlVVJJQ29tcG9uZW50KS5qb2luKCcvJyk7CiAgfSBlbHNlIHsKICAgIHZhciBvcHRpb25zID0gYXJndW1lbnRzWzFdLAogICAgICAgIGhhc2ggPSAob3B0aW9ucyAmJiBvcHRpb25zLmhhc2gpIHx8IG9wdGlvbnM7CiAgICBpZiAoaGFzaCAmJiBoYXNoWydleHBhbmQtdG9rZW5zJ10pIHsKICAgICAgZnJhZ21lbnQgPSBUaG9yYXguVXRpbC5leHBhbmRUb2tlbih1cmwsIHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgZnJhZ21lbnQgPSB1cmw7CiAgICB9CiAgfQogIHJldHVybiAoQmFja2JvbmUuaGlzdG9yeS5faGFzUHVzaFN0YXRlID8gQmFja2JvbmUuaGlzdG9yeS5vcHRpb25zLnJvb3QgOiAnIycpICsgZnJhZ21lbnQ7Cn0pOwoKOzsKLypnbG9iYWwgdmlld1RlbXBsYXRlT3ZlcnJpZGVzICovCkhhbmRsZWJhcnMucmVnaXN0ZXJWaWV3SGVscGVyKCd2aWV3JywgewogIGZhY3Rvcnk6IGZ1bmN0aW9uKGFyZ3MsIG9wdGlvbnMpIHsKICAgIHZhciBWaWV3ID0gYXJncy5sZW5ndGggPj0gMSA/IGFyZ3NbMF0gOiBUaG9yYXguVmlldzsKICAgIHJldHVybiBUaG9yYXguVXRpbC5nZXRWaWV3SW5zdGFuY2UoVmlldywgb3B0aW9ucy5vcHRpb25zKTsKICB9LAogIGNhbGxiYWNrOiBmdW5jdGlvbigpIHsKICAgIHZhciBpbnN0YW5jZSA9IGFyZ3VtZW50c1thcmd1bWVudHMubGVuZ3RoLTFdLAogICAgICAgIG9wdGlvbnMgPSBpbnN0YW5jZS5faGVscGVyT3B0aW9ucy5vcHRpb25zLAogICAgICAgIHBsYWNlaG9sZGVySWQgPSBpbnN0YW5jZS5jaWQ7CgogICAgaWYgKG9wdGlvbnMuZm4pIHsKICAgICAgdmlld1RlbXBsYXRlT3ZlcnJpZGVzW3BsYWNlaG9sZGVySWRdID0gb3B0aW9ucy5mbjsKICAgIH0KICB9Cn0pOwoKOzsKdmFyIGNhbGxNZXRob2RBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtY2FsbC1tZXRob2QnLAogICAgdHJpZ2dlckV2ZW50QXR0cmlidXRlTmFtZSA9ICdkYXRhLXRyaWdnZXItZXZlbnQnOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignYnV0dG9uJywgZnVuY3Rpb24obWV0aG9kLCBvcHRpb25zKSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgIG9wdGlvbnMgPSBtZXRob2Q7CiAgICBtZXRob2QgPSBvcHRpb25zLmhhc2gubWV0aG9kOwogIH0KICB2YXIgaGFzaCA9IG9wdGlvbnMuaGFzaCwKICAgICAgZXhwYW5kVG9rZW5zID0gaGFzaFsnZXhwYW5kLXRva2VucyddOwogIGRlbGV0ZSBoYXNoWydleHBhbmQtdG9rZW5zJ107CiAgaWYgKCFtZXRob2QgJiYgIW9wdGlvbnMuaGFzaC50cmlnZ2VyKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoImJ1dHRvbiBoZWxwZXIgbXVzdCBoYXZlIGEgbWV0aG9kIG5hbWUgYXMgdGhlIGZpcnN0IGFyZ3VtZW50IG9yIGEgJ3RyaWdnZXInLCBvciBhICdtZXRob2QnIGF0dHJpYnV0ZSBzcGVjaWZpZWQuIik7CiAgfQogIGhhc2gudGFnID0gaGFzaC50YWcgfHwgaGFzaC50YWdOYW1lIHx8ICdidXR0b24nOwogIGhhc2gudHJpZ2dlciAmJiAoaGFzaFt0cmlnZ2VyRXZlbnRBdHRyaWJ1dGVOYW1lXSA9IGhhc2gudHJpZ2dlcik7CiAgZGVsZXRlIGhhc2gudHJpZ2dlcjsKICBtZXRob2QgJiYgKGhhc2hbY2FsbE1ldGhvZEF0dHJpYnV0ZU5hbWVdID0gbWV0aG9kKTsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhUaG9yYXguVXRpbC50YWcoaGFzaCwgb3B0aW9ucy5mbiA/IG9wdGlvbnMuZm4odGhpcykgOiAnJywgZXhwYW5kVG9rZW5zID8gdGhpcyA6IG51bGwpKTsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdsaW5rJywgZnVuY3Rpb24oKSB7CiAgdmFyIGFyZ3MgPSBfLnRvQXJyYXkoYXJndW1lbnRzKSwKICAgICAgb3B0aW9ucyA9IGFyZ3MucG9wKCksCiAgICAgIGhhc2ggPSBvcHRpb25zLmhhc2gsCiAgICAgIC8vIHVybCBpcyBhbiBhcnJheSB0aGF0IHdpbGwgYmUgcGFzc2VkIHRvIHRoZSB1cmwgaGVscGVyCiAgICAgIHVybCA9IGFyZ3MubGVuZ3RoID09PSAwID8gW2hhc2guaHJlZl0gOiBhcmdzLAogICAgICBleHBhbmRUb2tlbnMgPSBoYXNoWydleHBhbmQtdG9rZW5zJ107CiAgZGVsZXRlIGhhc2hbJ2V4cGFuZC10b2tlbnMnXTsKICBpZiAoIXVybFswXSkgewogICAgdGhyb3cgbmV3IEVycm9yKCJsaW5rIGhlbHBlciByZXF1aXJlcyBhbiBocmVmIGFzIHRoZSBmaXJzdCBhcmd1bWVudCBvciBhbiAnaHJlZicgYXR0cmlidXRlIik7CiAgfQogIHVybC5wdXNoKG9wdGlvbnMpOwogIGhhc2guaHJlZiA9IEhhbmRsZWJhcnMuaGVscGVycy51cmwuYXBwbHkodGhpcywgdXJsKTsKICBoYXNoLnRhZyA9IGhhc2gudGFnIHx8IGhhc2gudGFnTmFtZSB8fCAnYSc7CiAgaGFzaC50cmlnZ2VyICYmIChoYXNoW3RyaWdnZXJFdmVudEF0dHJpYnV0ZU5hbWVdID0gb3B0aW9ucy5oYXNoLnRyaWdnZXIpOwogIGRlbGV0ZSBoYXNoLnRyaWdnZXI7CiAgaGFzaFtjYWxsTWV0aG9kQXR0cmlidXRlTmFtZV0gPSAnX2FuY2hvckNsaWNrJzsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhUaG9yYXguVXRpbC50YWcoaGFzaCwgb3B0aW9ucy5mbiA/IG9wdGlvbnMuZm4odGhpcykgOiAnJywgZXhwYW5kVG9rZW5zID8gdGhpcyA6IG51bGwpKTsKfSk7Cgp2YXIgY2xpY2tTZWxlY3RvciA9ICdbJyArIGNhbGxNZXRob2RBdHRyaWJ1dGVOYW1lICsgJ10sIFsnICsgdHJpZ2dlckV2ZW50QXR0cmlidXRlTmFtZSArICddJzsKCmZ1bmN0aW9uIGhhbmRsZUNsaWNrKGV2ZW50KSB7CiAgdmFyIHRhcmdldCA9ICQoZXZlbnQudGFyZ2V0KSwKICAgICAgdmlldyA9IHRhcmdldC52aWV3KHtoZWxwZXI6IGZhbHNlfSksCiAgICAgIG1ldGhvZE5hbWUgPSB0YXJnZXQuYXR0cihjYWxsTWV0aG9kQXR0cmlidXRlTmFtZSksCiAgICAgIGV2ZW50TmFtZSA9IHRhcmdldC5hdHRyKHRyaWdnZXJFdmVudEF0dHJpYnV0ZU5hbWUpLAogICAgICBtZXRob2RSZXNwb25zZSA9IGZhbHNlOwogIG1ldGhvZE5hbWUgJiYgKG1ldGhvZFJlc3BvbnNlID0gdmlld1ttZXRob2ROYW1lXS5jYWxsKHZpZXcsIGV2ZW50KSk7CiAgZXZlbnROYW1lICYmIHZpZXcudHJpZ2dlcihldmVudE5hbWUsIGV2ZW50KTsKICB0YXJnZXQudGFnTmFtZSA9PT0gIkEiICYmIG1ldGhvZFJlc3BvbnNlID09PSBmYWxzZSAmJiBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwp9Cgp2YXIgbGFzdENsaWNrSGFuZGxlckV2ZW50TmFtZTsKCmZ1bmN0aW9uIHJlZ2lzdGVyQ2xpY2tIYW5kbGVyKCkgewogIHVucmVnaXN0ZXJDbGlja0hhbmRsZXIoKTsKICBsYXN0Q2xpY2tIYW5kbGVyRXZlbnROYW1lID0gVGhvcmF4Ll9mYXN0Q2xpY2tFdmVudE5hbWUgfHwgJ2NsaWNrJzsKICAkKGRvY3VtZW50KS5vbihsYXN0Q2xpY2tIYW5kbGVyRXZlbnROYW1lLCBjbGlja1NlbGVjdG9yLCBoYW5kbGVDbGljayk7Cn0KCmZ1bmN0aW9uIHVucmVnaXN0ZXJDbGlja0hhbmRsZXIoKSB7CiAgbGFzdENsaWNrSGFuZGxlckV2ZW50TmFtZSAmJiAkKGRvY3VtZW50KS5vZmYobGFzdENsaWNrSGFuZGxlckV2ZW50TmFtZSwgY2xpY2tTZWxlY3RvciwgaGFuZGxlQ2xpY2spOwp9CgokKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpIHsKICBpZiAoIVRob3JheC5fZmFzdENsaWNrRXZlbnROYW1lKSB7CiAgICByZWdpc3RlckNsaWNrSGFuZGxlcigpOwogIH0KfSk7Cgo7Owp2YXIgZWxlbWVudFBsYWNlaG9sZGVyQXR0cmlidXRlTmFtZSA9ICdkYXRhLWVsZW1lbnQtdG1wJzsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2VsZW1lbnQnLCBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKSB7CiAgdmFyIGNpZCA9IF8udW5pcXVlSWQoJ2VsZW1lbnQnKSwKICAgICAgZGVjbGFyaW5nVmlldyA9IGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXcsCiAgICAgIGh0bWxBdHRyaWJ1dGVzID0gVGhvcmF4LlV0aWwuaHRtbEF0dHJpYnV0ZXNGcm9tT3B0aW9ucyhvcHRpb25zLmhhc2gpOwogIGh0bWxBdHRyaWJ1dGVzW2VsZW1lbnRQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWVdID0gY2lkOwogIGRlY2xhcmluZ1ZpZXcuX2VsZW1lbnRzQnlDaWQgfHwgKGRlY2xhcmluZ1ZpZXcuX2VsZW1lbnRzQnlDaWQgPSB7fSk7CiAgZGVjbGFyaW5nVmlldy5fZWxlbWVudHNCeUNpZFtjaWRdID0gZWxlbWVudDsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhUaG9yYXguVXRpbC50YWcoaHRtbEF0dHJpYnV0ZXMpKTsKfSk7CgpUaG9yYXguVmlldy5vbignYXBwZW5kJywgZnVuY3Rpb24oc2NvcGUsIGNhbGxiYWNrKSB7CiAgKHNjb3BlIHx8IHRoaXMuJGVsKS5maW5kKCdbJyArIGVsZW1lbnRQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWUgKyAnXScpLmZvckVhY2goZnVuY3Rpb24oZWwpIHsKICAgIHZhciAkZWwgPSAkKGVsKSwKICAgICAgICBjaWQgPSAkZWwuYXR0cihlbGVtZW50UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lKSwKICAgICAgICBlbGVtZW50ID0gdGhpcy5fZWxlbWVudHNCeUNpZFtjaWRdOwogICAgLy8gQSBjYWxsYmFjayBmdW5jdGlvbiBtYXkgYmUgc3BlY2lmaWVkIGFzIHRoZSB2YWx1ZQogICAgaWYgKF8uaXNGdW5jdGlvbihlbGVtZW50KSkgewogICAgICBlbGVtZW50ID0gZWxlbWVudC5jYWxsKHRoaXMpOwogICAgfQogICAgJGVsLnJlcGxhY2VXaXRoKGVsZW1lbnQpOwogICAgY2FsbGJhY2sgJiYgY2FsbGJhY2soZWxlbWVudCk7CiAgfSwgdGhpcyk7Cn0pOwoKOzsKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignc3VwZXInLCBmdW5jdGlvbihvcHRpb25zKSB7CiAgdmFyIGRlY2xhcmluZ1ZpZXcgPSBnZXRPcHRpb25zRGF0YShvcHRpb25zKS52aWV3LAogICAgICBwYXJlbnQgPSBkZWNsYXJpbmdWaWV3LmNvbnN0cnVjdG9yICYmIGRlY2xhcmluZ1ZpZXcuY29uc3RydWN0b3IuX19zdXBlcl9fOwogIGlmIChwYXJlbnQpIHsKICAgIHZhciB0ZW1wbGF0ZSA9IHBhcmVudC50ZW1wbGF0ZTsKICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgaWYgKCFwYXJlbnQubmFtZSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHVzZSBzdXBlciBoZWxwZXIgd2hlbiBwYXJlbnQgaGFzIG5vIG5hbWUgb3IgdGVtcGxhdGUuJyk7CiAgICAgIH0KICAgICAgdGVtcGxhdGUgPSBUaG9yYXguVXRpbC5nZXRUZW1wbGF0ZShwYXJlbnQubmFtZSwgZmFsc2UpOwogICAgfQogICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgdGVtcGxhdGUgPSBIYW5kbGViYXJzLmNvbXBpbGUodGVtcGxhdGUsIHtkYXRhOiB0cnVlfSk7CiAgICB9CiAgICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyh0ZW1wbGF0ZSh0aGlzLCBvcHRpb25zKSk7CiAgfSBlbHNlIHsKICAgIHJldHVybiAnJzsKICB9Cn0pOwoKOzsKLypnbG9iYWwgY29sbGVjdGlvbk9wdGlvbk5hbWVzLCBpbmhlcml0VmFycyAqLwoKdmFyIGxvYWRTdGFydCA9ICdsb2FkOnN0YXJ0JywKICAgIGxvYWRFbmQgPSAnbG9hZDplbmQnLAogICAgcm9vdE9iamVjdDsKClRob3JheC5zZXRSb290T2JqZWN0ID0gZnVuY3Rpb24ob2JqKSB7CiAgcm9vdE9iamVjdCA9IG9iajsKfTsKClRob3JheC5sb2FkSGFuZGxlciA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQsIGNvbnRleHQpIHsKICB2YXIgbG9hZENvdW50ZXIgPSBfLnVuaXF1ZUlkKCk7CiAgcmV0dXJuIGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCkgewogICAgdmFyIHNlbGYgPSBjb250ZXh0IHx8IHRoaXM7CiAgICBzZWxmLl9sb2FkSW5mbyA9IHNlbGYuX2xvYWRJbmZvIHx8IFtdOwogICAgdmFyIGxvYWRJbmZvID0gc2VsZi5fbG9hZEluZm9bbG9hZENvdW50ZXJdOwoKICAgIGZ1bmN0aW9uIHN0YXJ0TG9hZFRpbWVvdXQoKSB7CgogICAgICAvLyBJZiB0aGUgdGltZW91dCBoYXMgYmVlbiBzZXQgYWxyZWFkeSBidXQgaGFzIG5vdCB0cmlnZ2VyZWQgeWV0IGRvIG5vdGhpbmcKICAgICAgLy8gT3RoZXJ3aXNlIHNldCBhIG5ldyB0aW1lb3V0IChlaXRoZXIgaW5pdGlhbCBvciBmb3IgZ29pbmcgZnJvbSBiYWNrZ3JvdW5kIHRvCiAgICAgIC8vIG5vbi1iYWNrZ3JvdW5kIGxvYWRpbmcpCiAgICAgIGlmIChsb2FkSW5mby50aW1lb3V0ICYmICFsb2FkSW5mby5ydW4pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBsb2FkaW5nVGltZW91dCA9IHNlbGYuX2xvYWRpbmdUaW1lb3V0RHVyYXRpb24gIT09IHVuZGVmaW5lZCA/CiAgICAgICAgc2VsZi5fbG9hZGluZ1RpbWVvdXREdXJhdGlvbiA6IFRob3JheC5WaWV3LnByb3RvdHlwZS5fbG9hZGluZ1RpbWVvdXREdXJhdGlvbjsKICAgICAgbG9hZEluZm8udGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBsb2FkSW5mby5ydW4gPSB0cnVlOwogICAgICAgICAgICBzdGFydC5jYWxsKHNlbGYsIGxvYWRJbmZvLm1lc3NhZ2UsIGxvYWRJbmZvLmJhY2tncm91bmQsIGxvYWRJbmZvKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgVGhvcmF4Lm9uRXhjZXB0aW9uKCdsb2FkU3RhcnQnLCBlKTsKICAgICAgICAgIH0KICAgICAgICB9LCBsb2FkaW5nVGltZW91dCAqIDEwMDApOwogICAgfQoKICAgIGlmICghbG9hZEluZm8pIHsKICAgICAgbG9hZEluZm8gPSBzZWxmLl9sb2FkSW5mb1tsb2FkQ291bnRlcl0gPSBfLmV4dGVuZCh7CiAgICAgICAgZXZlbnRzOiBbXSwKICAgICAgICB0aW1lb3V0OiAwLAogICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsCiAgICAgICAgYmFja2dyb3VuZDogISFiYWNrZ3JvdW5kCiAgICAgIH0sIEJhY2tib25lLkV2ZW50cyk7CiAgICAgIHN0YXJ0TG9hZFRpbWVvdXQoKTsKICAgIH0gZWxzZSB7CiAgICAgIGNsZWFyVGltZW91dChsb2FkSW5mby5lbmRUaW1lb3V0KTsKCiAgICAgIGxvYWRJbmZvLm1lc3NhZ2UgPSBtZXNzYWdlOwogICAgICBpZiAoIWJhY2tncm91bmQgJiYgbG9hZEluZm8uYmFja2dyb3VuZCkgewogICAgICAgIGxvYWRJbmZvLmJhY2tncm91bmQgPSBmYWxzZTsKICAgICAgICBzdGFydExvYWRUaW1lb3V0KCk7CiAgICAgIH0KICAgIH0KCiAgICBsb2FkSW5mby5ldmVudHMucHVzaChvYmplY3QpOwogICAgb2JqZWN0Lm9uKGxvYWRFbmQsIGZ1bmN0aW9uIGVuZENhbGxiYWNrKCkgewogICAgICBvYmplY3Qub2ZmKGxvYWRFbmQsIGVuZENhbGxiYWNrKTsKCiAgICAgIHZhciBsb2FkaW5nRW5kVGltZW91dCA9IHNlbGYuX2xvYWRpbmdUaW1lb3V0RW5kRHVyYXRpb247CiAgICAgIGlmIChsb2FkaW5nRW5kVGltZW91dCA9PT0gdm9pZCAwKSB7CiAgICAgICAgLy8gSWYgd2UgYXJlIHJ1bm5pbmcgb24gYSBub24tdmlldyBvYmplY3QgcHVsbCB0aGUgZGVmYXVsdCB0aW1lb3V0CiAgICAgICAgbG9hZGluZ0VuZFRpbWVvdXQgPSBUaG9yYXguVmlldy5wcm90b3R5cGUuX2xvYWRpbmdUaW1lb3V0RW5kRHVyYXRpb247CiAgICAgIH0KCiAgICAgIHZhciBldmVudHMgPSBsb2FkSW5mby5ldmVudHMsCiAgICAgICAgICBpbmRleCA9IGV2ZW50cy5pbmRleE9mKG9iamVjdCk7CiAgICAgIGlmIChpbmRleCA+PSAwKSB7CiAgICAgICAgZXZlbnRzLnNwbGljZShpbmRleCwgMSk7CiAgICAgIH0KICAgICAgaWYgKCFldmVudHMubGVuZ3RoKSB7CiAgICAgICAgbG9hZEluZm8uZW5kVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoIWV2ZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgICB2YXIgcnVuID0gbG9hZEluZm8ucnVuOwoKICAgICAgICAgICAgICBpZiAocnVuKSB7CiAgICAgICAgICAgICAgICAvLyBFbWl0IHRoZSBlbmQgYmVoYXZpb3IsIGJ1dCBvbmx5IGlmIHRoZXJlIGlzIGEgcGFpcmVkIHN0YXJ0CiAgICAgICAgICAgICAgICBlbmQuY2FsbChzZWxmLCBsb2FkSW5mby5iYWNrZ3JvdW5kLCBsb2FkSW5mbyk7CiAgICAgICAgICAgICAgICBsb2FkSW5mby50cmlnZ2VyKGxvYWRFbmQsIGxvYWRJbmZvKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vIElmIHN0b3BwaW5nIG1ha2Ugc3VyZSB3ZSBkb24ndCBydW4gYSBzdGFydAogICAgICAgICAgICAgIGNsZWFyVGltZW91dChsb2FkSW5mby50aW1lb3V0KTsKICAgICAgICAgICAgICBsb2FkSW5mbyA9IHNlbGYuX2xvYWRJbmZvW2xvYWRDb3VudGVyXSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBUaG9yYXgub25FeGNlcHRpb24oJ2xvYWRFbmQnLCBlKTsKICAgICAgICAgIH0KICAgICAgICB9LCBsb2FkaW5nRW5kVGltZW91dCAqIDEwMDApOwogICAgICB9CiAgICB9KTsKICB9Owp9OwoKLyoqCiAqIEhlbHBlciBtZXRob2QgZm9yIHByb3BhZ2F0aW5nIGxvYWQ6c3RhcnQgZXZlbnRzIHRvIG90aGVyIG9iamVjdHMuCiAqCiAqIEZvcndhcmRzIGxvYWQ6c3RhcnQgZXZlbnRzIHRoYXQgb2NjdXIgb24gYHNvdXJjZWAgdG8gYGRlc3RgLgogKi8KVGhvcmF4LmZvcndhcmRMb2FkRXZlbnRzID0gZnVuY3Rpb24oc291cmNlLCBkZXN0LCBvbmNlKSB7CiAgZnVuY3Rpb24gbG9hZChtZXNzYWdlLCBiYWNrZ291bmQsIG9iamVjdCkgewogICAgaWYgKG9uY2UpIHsKICAgICAgc291cmNlLm9mZihsb2FkU3RhcnQsIGxvYWQpOwogICAgfQogICAgZGVzdC50cmlnZ2VyKGxvYWRTdGFydCwgbWVzc2FnZSwgYmFja2dvdW5kLCBvYmplY3QpOwogIH0KICBzb3VyY2Uub24obG9hZFN0YXJ0LCBsb2FkKTsKICByZXR1cm4gewogICAgb2ZmOiBmdW5jdGlvbigpIHsKICAgICAgc291cmNlLm9mZihsb2FkU3RhcnQsIGxvYWQpOwogICAgfQogIH07Cn07CgovLwovLyBEYXRhIGxvYWQgZXZlbnQgZ2VuZXJhdGlvbgovLwoKLyoqCiAqIE1peGluZyBmb3IgZ2VuZXJhdGluZyBsb2FkOnN0YXJ0IGFuZCBsb2FkOmVuZCBldmVudHMuCiAqLwpUaG9yYXgubWl4aW5Mb2FkYWJsZSA9IGZ1bmN0aW9uKHRhcmdldCwgdXNlUGFyZW50KSB7CiAgXy5leHRlbmQodGFyZ2V0LCB7CiAgICAvL2xvYWRpbmcgY29uZmlnCiAgICBfbG9hZGluZ0NsYXNzTmFtZTogJ2xvYWRpbmcnLAogICAgX2xvYWRpbmdUaW1lb3V0RHVyYXRpb246IDAuMzMsCiAgICBfbG9hZGluZ1RpbWVvdXRFbmREdXJhdGlvbjogMC4xMCwKCiAgICAvLyBQcm9wYWdhdGVzIGxvYWRpbmcgdmlldyBwYXJhbWV0ZXJzIHRvIHRoZSBBSkFYIGxheWVyCiAgICBvbkxvYWRTdGFydDogZnVuY3Rpb24obWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KSB7CiAgICAgIHZhciB0aGF0ID0gdXNlUGFyZW50ID8gdGhpcy5wYXJlbnQgOiB0aGlzOwogICAgICBpZiAoIXRoYXQubm9uQmxvY2tpbmdMb2FkICYmICFiYWNrZ3JvdW5kICYmIHJvb3RPYmplY3QgJiYgcm9vdE9iamVjdCAhPT0gdGhpcykgewogICAgICAgIHJvb3RPYmplY3QudHJpZ2dlcihsb2FkU3RhcnQsIG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCk7CiAgICAgIH0KICAgICAgJCh0aGF0LmVsKS5hZGRDbGFzcyh0aGF0Ll9sb2FkaW5nQ2xhc3NOYW1lKTsKICAgICAgLy91c2VkIGJ5IGxvYWRpbmcgaGVscGVycwogICAgICBpZiAodGhhdC5fbG9hZGluZ0NhbGxiYWNrcykgewogICAgICAgIF8uZWFjaCh0aGF0Ll9sb2FkaW5nQ2FsbGJhY2tzLCBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgIG9uTG9hZEVuZDogZnVuY3Rpb24oLyogYmFja2dyb3VuZCwgb2JqZWN0ICovKSB7CiAgICAgIHZhciB0aGF0ID0gdXNlUGFyZW50ID8gdGhpcy5wYXJlbnQgOiB0aGlzOwogICAgICAkKHRoYXQuZWwpLnJlbW92ZUNsYXNzKHRoYXQuX2xvYWRpbmdDbGFzc05hbWUpOwogICAgICAvL3VzZWQgYnkgbG9hZGluZyBoZWxwZXJzCiAgICAgIGlmICh0aGF0Ll9sb2FkaW5nQ2FsbGJhY2tzKSB7CiAgICAgICAgXy5lYWNoKHRoYXQuX2xvYWRpbmdDYWxsYmFja3MsIGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfSk7Cn07CgpUaG9yYXgubWl4aW5Mb2FkYWJsZUV2ZW50cyA9IGZ1bmN0aW9uKHRhcmdldCwgdXNlUGFyZW50KSB7CiAgXy5leHRlbmQodGFyZ2V0LCB7CiAgICBsb2FkU3RhcnQ6IGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQpIHsKICAgICAgdmFyIHRoYXQgPSB1c2VQYXJlbnQgPyB0aGlzLnBhcmVudCA6IHRoaXM7CiAgICAgIHRoYXQudHJpZ2dlcihsb2FkU3RhcnQsIG1lc3NhZ2UsIGJhY2tncm91bmQsIHRoYXQpOwogICAgfSwKICAgIGxvYWRFbmQ6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdGhhdCA9IHVzZVBhcmVudCA/IHRoaXMucGFyZW50IDogdGhpczsKICAgICAgdGhhdC50cmlnZ2VyKGxvYWRFbmQsIHRoYXQpOwogICAgfQogIH0pOwp9OwoKVGhvcmF4Lm1peGluTG9hZGFibGUoVGhvcmF4LlZpZXcucHJvdG90eXBlKTsKVGhvcmF4Lm1peGluTG9hZGFibGVFdmVudHMoVGhvcmF4LlZpZXcucHJvdG90eXBlKTsKClRob3JheC5zeW5jID0gZnVuY3Rpb24obWV0aG9kLCBkYXRhT2JqLCBvcHRpb25zKSB7CiAgdmFyIHNlbGYgPSB0aGlzLAogICAgICBjb21wbGV0ZSA9IG9wdGlvbnMuY29tcGxldGU7CgogIG9wdGlvbnMuY29tcGxldGUgPSBmdW5jdGlvbigpIHsKICAgIHNlbGYuX3JlcXVlc3QgPSB1bmRlZmluZWQ7CiAgICBzZWxmLl9hYm9ydGVkID0gZmFsc2U7CgogICAgY29tcGxldGUgJiYgY29tcGxldGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwogIHRoaXMuX3JlcXVlc3QgPSBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogIHJldHVybiB0aGlzLl9yZXF1ZXN0Owp9OwoKZnVuY3Rpb24gYmluZFRvUm91dGUoY2FsbGJhY2ssIGZhaWxiYWNrKSB7CiAgdmFyIGZyYWdtZW50ID0gQmFja2JvbmUuaGlzdG9yeS5nZXRGcmFnbWVudCgpLAogICAgICByb3V0ZUNoYW5nZWQgPSBmYWxzZTsKCiAgZnVuY3Rpb24gcm91dGVIYW5kbGVyKCkgewogICAgaWYgKGZyYWdtZW50ID09PSBCYWNrYm9uZS5oaXN0b3J5LmdldEZyYWdtZW50KCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgcm91dGVDaGFuZ2VkID0gdHJ1ZTsKICAgIHJlcy5jYW5jZWwoKTsKICAgIGZhaWxiYWNrICYmIGZhaWxiYWNrKCk7CiAgfQoKICBCYWNrYm9uZS5oaXN0b3J5Lm9uKCdyb3V0ZScsIHJvdXRlSGFuZGxlcik7CgogIGZ1bmN0aW9uIGZpbmFsaXplcigpIHsKICAgIEJhY2tib25lLmhpc3Rvcnkub2ZmKCdyb3V0ZScsIHJvdXRlSGFuZGxlcik7CiAgICBpZiAoIXJvdXRlQ2hhbmdlZCkgewogICAgICBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0KCiAgdmFyIHJlcyA9IF8uYmluZChmaW5hbGl6ZXIsIHRoaXMpOwogIHJlcy5jYW5jZWwgPSBmdW5jdGlvbigpIHsKICAgIEJhY2tib25lLmhpc3Rvcnkub2ZmKCdyb3V0ZScsIHJvdXRlSGFuZGxlcik7CiAgfTsKCiAgcmV0dXJuIHJlczsKfQoKZnVuY3Rpb24gbG9hZERhdGEoY2FsbGJhY2ssIGZhaWxiYWNrLCBvcHRpb25zKSB7CiAgaWYgKHRoaXMuaXNQb3B1bGF0ZWQoKSkgewogICAgcmV0dXJuIGNhbGxiYWNrKHRoaXMpOwogIH0KCiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIgJiYgdHlwZW9mIGZhaWxiYWNrICE9PSAnZnVuY3Rpb24nICYmIF8uaXNPYmplY3QoZmFpbGJhY2spKSB7CiAgICBvcHRpb25zID0gZmFpbGJhY2s7CiAgICBmYWlsYmFjayA9IGZhbHNlOwogIH0KCiAgdmFyIHNlbGYgPSB0aGlzLAogICAgICByb3V0ZUNoYW5nZWQgPSBmYWxzZSwKICAgICAgc3VjY2Vzc0NhbGxiYWNrID0gYmluZFRvUm91dGUoXy5iaW5kKGNhbGxiYWNrLCBzZWxmKSwgZnVuY3Rpb24oKSB7CiAgICAgICAgcm91dGVDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICBpZiAoc2VsZi5fcmVxdWVzdCkgewogICAgICAgICAgc2VsZi5fYWJvcnRlZCA9IHRydWU7CiAgICAgICAgICBzZWxmLl9yZXF1ZXN0LmFib3J0KCk7CiAgICAgICAgfQogICAgICAgIGZhaWxiYWNrICYmIGZhaWxiYWNrLmNhbGwoc2VsZiwgZmFsc2UpOwogICAgICB9KTsKCiAgdGhpcy5mZXRjaChfLmRlZmF1bHRzKHsKICAgIHN1Y2Nlc3M6IHN1Y2Nlc3NDYWxsYmFjaywKICAgIGVycm9yOiBmYWlsYmFjayAmJiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCFyb3V0ZUNoYW5nZWQpIHsKICAgICAgICBmYWlsYmFjay5hcHBseShzZWxmLCBbdHJ1ZV0uY29uY2F0KF8udG9BcnJheShhcmd1bWVudHMpKSk7CiAgICAgIH0KICAgIH0sCiAgICBjb21wbGV0ZTogZnVuY3Rpb24oKSB7CiAgICAgIHN1Y2Nlc3NDYWxsYmFjay5jYW5jZWwoKTsKICAgIH0KICB9LCBvcHRpb25zKSk7Cn0KCmZ1bmN0aW9uIGZldGNoUXVldWUob3B0aW9ucywgJHN1cGVyKSB7CiAgaWYgKG9wdGlvbnMucmVzZXRRdWV1ZSkgewogICAgLy8gV0FSTjogU2hvdWxkIGVuc3VyZSB0aGF0IGxvYWRlcnMgYXJlIHByb3RlY3RlZCBmcm9tIG91dCBvZiBiYW5kIGRhdGEKICAgIC8vICAgIHdoZW4gdXNpbmcgdGhpcyBvcHRpb24KICAgIHRoaXMuZmV0Y2hRdWV1ZSA9IHVuZGVmaW5lZDsKICB9CgogIGlmICghdGhpcy5mZXRjaFF1ZXVlKSB7CiAgICAvLyBLaWNrIG9mZiB0aGUgcmVxdWVzdAogICAgdGhpcy5mZXRjaFF1ZXVlID0gW29wdGlvbnNdOwogICAgb3B0aW9ucyA9IF8uZGVmYXVsdHMoewogICAgICBzdWNjZXNzOiBmbHVzaFF1ZXVlKHRoaXMsIHRoaXMuZmV0Y2hRdWV1ZSwgJ3N1Y2Nlc3MnKSwKICAgICAgZXJyb3I6IGZsdXNoUXVldWUodGhpcywgdGhpcy5mZXRjaFF1ZXVlLCAnZXJyb3InKSwKICAgICAgY29tcGxldGU6IGZsdXNoUXVldWUodGhpcywgdGhpcy5mZXRjaFF1ZXVlLCAnY29tcGxldGUnKQogICAgfSwgb3B0aW9ucyk7CiAgICAkc3VwZXIuY2FsbCh0aGlzLCBvcHRpb25zKTsKICB9IGVsc2UgewogICAgLy8gQ3VycmVudGx5IGZldGNoaW5nLiBRdWV1ZSBhbmQgcHJvY2VzcyBvbmNlIGNvbXBsZXRlCiAgICB0aGlzLmZldGNoUXVldWUucHVzaChvcHRpb25zKTsKICB9Cn0KCmZ1bmN0aW9uIGZsdXNoUXVldWUoc2VsZiwgZmV0Y2hRdWV1ZSwgaGFuZGxlcikgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwoKICAgIC8vIEZsdXNoIHRoZSBxdWV1ZS4gRXhlY3V0ZXMgYW55IGNhbGxiYWNrIGhhbmRsZXJzIHRoYXQKICAgIC8vIG1heSBoYXZlIGJlZW4gcGFzc2VkIGluIHRoZSBmZXRjaCBvcHRpb25zLgogICAgXy5lYWNoKGZldGNoUXVldWUsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnNbaGFuZGxlcl0pIHsKICAgICAgICBvcHRpb25zW2hhbmRsZXJdLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB9CiAgICB9LCB0aGlzKTsKCiAgICAvLyBSZXNldCB0aGUgcXVldWUgaWYgd2UgYXJlIHN0aWxsIHRoZSBhY3RpdmUgcmVxdWVzdAogICAgaWYgKHNlbGYuZmV0Y2hRdWV1ZSA9PT0gZmV0Y2hRdWV1ZSkgewogICAgICBzZWxmLmZldGNoUXVldWUgPSB1bmRlZmluZWQ7CiAgICB9CiAgfTsKfQoKdmFyIGtsYXNzZXMgPSBbXTsKVGhvcmF4Lk1vZGVsICYmIGtsYXNzZXMucHVzaChUaG9yYXguTW9kZWwpOwpUaG9yYXguQ29sbGVjdGlvbiAmJiBrbGFzc2VzLnB1c2goVGhvcmF4LkNvbGxlY3Rpb24pOwoKXy5lYWNoKGtsYXNzZXMsIGZ1bmN0aW9uKERhdGFDbGFzcykgewogIHZhciAkZmV0Y2ggPSBEYXRhQ2xhc3MucHJvdG90eXBlLmZldGNoOwogIFRob3JheC5taXhpbkxvYWRhYmxlRXZlbnRzKERhdGFDbGFzcy5wcm90b3R5cGUsIGZhbHNlKTsKICBfLmV4dGVuZChEYXRhQ2xhc3MucHJvdG90eXBlLCB7CiAgICBzeW5jOiBUaG9yYXguc3luYywKCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICAgIHZhciBzZWxmID0gdGhpcywKICAgICAgICAgIGNvbXBsZXRlID0gb3B0aW9ucy5jb21wbGV0ZTsKCiAgICAgIG9wdGlvbnMuY29tcGxldGUgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb21wbGV0ZSAmJiBjb21wbGV0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIHNlbGYubG9hZEVuZCgpOwogICAgICB9OwogICAgICBzZWxmLmxvYWRTdGFydCh1bmRlZmluZWQsIG9wdGlvbnMuYmFja2dyb3VuZCk7CiAgICAgIHJldHVybiBmZXRjaFF1ZXVlLmNhbGwodGhpcywgb3B0aW9ucyB8fCB7fSwgJGZldGNoKTsKICAgIH0sCgogICAgbG9hZDogZnVuY3Rpb24oY2FsbGJhY2ssIGZhaWxiYWNrLCBvcHRpb25zKSB7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyICYmIHR5cGVvZiBmYWlsYmFjayAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgIG9wdGlvbnMgPSBmYWlsYmFjazsKICAgICAgICBmYWlsYmFjayA9IGZhbHNlOwogICAgICB9CgogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgaWYgKCFvcHRpb25zLmJhY2tncm91bmQgJiYgIXRoaXMuaXNQb3B1bGF0ZWQoKSAmJiByb290T2JqZWN0KSB7CiAgICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgdGhlIGdsb2JhbCBzY29wZSBzZWVzIHRoZSBwcm9wZXIgbG9hZCBldmVudHMgaGVyZQogICAgICAgIC8vIGlmIHdlIGFyZSBsb2FkaW5nIGluIHN0YW5kYWxvbmUgbW9kZQogICAgICAgIFRob3JheC5mb3J3YXJkTG9hZEV2ZW50cyh0aGlzLCByb290T2JqZWN0LCB0cnVlKTsKICAgICAgfQoKICAgICAgbG9hZERhdGEuY2FsbCh0aGlzLCBjYWxsYmFjaywgZmFpbGJhY2ssIG9wdGlvbnMpOwogICAgfQogIH0pOwp9KTsKClRob3JheC5VdGlsLmJpbmRUb1JvdXRlID0gYmluZFRvUm91dGU7CgppZiAoVGhvcmF4LlJvdXRlcikgewogIFRob3JheC5Sb3V0ZXIuYmluZFRvUm91dGUgPSBUaG9yYXguUm91dGVyLnByb3RvdHlwZS5iaW5kVG9Sb3V0ZSA9IGJpbmRUb1JvdXRlOwp9CgovLyBQcm9wYWdhdGVzIGxvYWRpbmcgdmlldyBwYXJhbWV0ZXJzIHRvIHRoZSBBSkFYIGxheWVyClRob3JheC5WaWV3LnByb3RvdHlwZS5fbW9kaWZ5RGF0YU9iamVjdE9wdGlvbnMgPSBmdW5jdGlvbihkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgb3B0aW9ucy5pZ25vcmVFcnJvcnMgPSB0aGlzLmlnbm9yZUZldGNoRXJyb3I7CiAgb3B0aW9ucy5iYWNrZ3JvdW5kID0gdGhpcy5ub25CbG9ja2luZ0xvYWQ7CiAgcmV0dXJuIG9wdGlvbnM7Cn07CgpUaG9yYXguSGVscGVyVmlldy5wcm90b3R5cGUuX21vZGlmeURhdGFPYmplY3RPcHRpb25zID0gZnVuY3Rpb24oZGF0YU9iamVjdCwgb3B0aW9ucykgewogIG9wdGlvbnMuaWdub3JlRXJyb3JzID0gdGhpcy5wYXJlbnQuaWdub3JlRmV0Y2hFcnJvcjsKICBvcHRpb25zLmJhY2tncm91bmQgPSB0aGlzLnBhcmVudC5ub25CbG9ja2luZ0xvYWQ7CiAgcmV0dXJuIG9wdGlvbnM7Cn07Cgppbmhlcml0VmFycy5jb2xsZWN0aW9uLmxvYWRpbmcgPSBmdW5jdGlvbigpIHsKICB2YXIgbG9hZGluZ1ZpZXcgPSB0aGlzLmxvYWRpbmdWaWV3LAogICAgICBsb2FkaW5nVGVtcGxhdGUgPSB0aGlzLmxvYWRpbmdUZW1wbGF0ZSwKICAgICAgbG9hZGluZ1BsYWNlbWVudCA9IHRoaXMubG9hZGluZ1BsYWNlbWVudDsKICAvL2FkZCAibG9hZGluZy12aWV3IiBhbmQgImxvYWRpbmctdGVtcGxhdGUiIG9wdGlvbnMgdG8gY29sbGVjdGlvbiBoZWxwZXIKICBpZiAobG9hZGluZ1ZpZXcgfHwgbG9hZGluZ1RlbXBsYXRlKSB7CiAgICB2YXIgY2FsbGJhY2sgPSBUaG9yYXgubG9hZEhhbmRsZXIoXy5iaW5kKGZ1bmN0aW9uKCkgewogICAgICB2YXIgaXRlbTsKICAgICAgaWYgKHRoaXMuY29sbGVjdGlvbi5sZW5ndGggPT09IDApIHsKICAgICAgICB0aGlzLiRlbC5lbXB0eSgpOwogICAgICB9CiAgICAgIGlmIChsb2FkaW5nVmlldykgewogICAgICAgIHZhciBpbnN0YW5jZSA9IFRob3JheC5VdGlsLmdldFZpZXdJbnN0YW5jZShsb2FkaW5nVmlldywgewogICAgICAgICAgY29sbGVjdGlvbjogdGhpcy5jb2xsZWN0aW9uCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5fYWRkQ2hpbGQoaW5zdGFuY2UpOwogICAgICAgIGlmIChsb2FkaW5nVGVtcGxhdGUpIHsKICAgICAgICAgIGluc3RhbmNlLnJlbmRlcihsb2FkaW5nVGVtcGxhdGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpbnN0YW5jZS5yZW5kZXIoKTsKICAgICAgICB9CiAgICAgICAgaXRlbSA9IGluc3RhbmNlOwogICAgICB9IGVsc2UgewogICAgICAgIGl0ZW0gPSB0aGlzLnJlbmRlclRlbXBsYXRlKGxvYWRpbmdUZW1wbGF0ZSk7CiAgICAgIH0KICAgICAgdmFyIGluZGV4ID0gbG9hZGluZ1BsYWNlbWVudAogICAgICAgID8gbG9hZGluZ1BsYWNlbWVudC5jYWxsKHRoaXMpCiAgICAgICAgOiB0aGlzLmNvbGxlY3Rpb24ubGVuZ3RoCiAgICAgIDsKICAgICAgdGhpcy5hcHBlbmRJdGVtKGl0ZW0sIGluZGV4KTsKICAgICAgdGhpcy4kZWwuY2hpbGRyZW4oKS5lcShpbmRleCkuYXR0cignZGF0YS1sb2FkaW5nLWVsZW1lbnQnLCB0aGlzLmNvbGxlY3Rpb24uY2lkKTsKICAgIH0sIHRoaXMpLCBfLmJpbmQoZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLmZpbmQoJ1tkYXRhLWxvYWRpbmctZWxlbWVudD0iJyArIHRoaXMuY29sbGVjdGlvbi5jaWQgKyAnIl0nKS5yZW1vdmUoKTsKICAgIH0sIHRoaXMpLAogICAgdGhpcy5jb2xsZWN0aW9uKTsKCiAgICB0aGlzLmxpc3RlblRvKHRoaXMuY29sbGVjdGlvbiwgJ2xvYWQ6c3RhcnQnLCBjYWxsYmFjayk7CiAgfQp9OwoKaWYgKHR5cGVvZiBjb2xsZWN0aW9uT3B0aW9uTmFtZXMgIT09ICd1bmRlZmluZWQnKSB7CiAgY29sbGVjdGlvbk9wdGlvbk5hbWVzWydsb2FkaW5nLXRlbXBsYXRlJ10gPSAnbG9hZGluZ1RlbXBsYXRlJzsKICBjb2xsZWN0aW9uT3B0aW9uTmFtZXNbJ2xvYWRpbmctdmlldyddID0gJ2xvYWRpbmdWaWV3JzsKICBjb2xsZWN0aW9uT3B0aW9uTmFtZXNbJ2xvYWRpbmctcGxhY2VtZW50J10gPSAnbG9hZGluZ1BsYWNlbWVudCc7Cn0KClRob3JheC5WaWV3Lm9uKHsKICAnbG9hZDpzdGFydCc6IFRob3JheC5sb2FkSGFuZGxlcigKICAgICAgZnVuY3Rpb24obWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KSB7CiAgICAgICAgdGhpcy5vbkxvYWRTdGFydChtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpOwogICAgICB9LAogICAgICBmdW5jdGlvbihiYWNrZ3JvdW5kLCBvYmplY3QpIHsKICAgICAgICB0aGlzLm9uTG9hZEVuZChvYmplY3QpOwogICAgICB9KSwKCiAgY29sbGVjdGlvbjogewogICAgJ2xvYWQ6c3RhcnQnOiBmdW5jdGlvbihtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpIHsKICAgICAgdGhpcy50cmlnZ2VyKGxvYWRTdGFydCwgbWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KTsKICAgIH0KICB9LAogIG1vZGVsOiB7CiAgICAnbG9hZDpzdGFydCc6IGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCkgewogICAgICB0aGlzLnRyaWdnZXIobG9hZFN0YXJ0LCBtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpOwogICAgfQogIH0KfSk7Cgo7OwpIYW5kbGViYXJzLnJlZ2lzdGVyVmlld0hlbHBlcignbG9hZGluZycsIGZ1bmN0aW9uKHZpZXcpIHsKICB2YXIgX3JlbmRlciA9IHZpZXcucmVuZGVyOwogIHZpZXcucmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICBpZiAodmlldy5wYXJlbnQuJGVsLmhhc0NsYXNzKHZpZXcucGFyZW50Ll9sb2FkaW5nQ2xhc3NOYW1lKSkgewogICAgICByZXR1cm4gX3JlbmRlci5jYWxsKHRoaXMsIHZpZXcuZm4pOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIF9yZW5kZXIuY2FsbCh0aGlzLCB2aWV3LmludmVyc2UpOwogICAgfQogIH07CiAgdmFyIGNhbGxiYWNrID0gXy5iaW5kKHZpZXcucmVuZGVyLCB2aWV3KTsKICB2aWV3LnBhcmVudC5fbG9hZGluZ0NhbGxiYWNrcyA9IHZpZXcucGFyZW50Ll9sb2FkaW5nQ2FsbGJhY2tzIHx8IFtdOwogIHZpZXcucGFyZW50Ll9sb2FkaW5nQ2FsbGJhY2tzLnB1c2goY2FsbGJhY2spOwogIHZpZXcub24oJ2ZyZWV6ZScsIGZ1bmN0aW9uKCkgewogICAgdmlldy5wYXJlbnQuX2xvYWRpbmdDYWxsYmFja3MgPSBfLndpdGhvdXQodmlldy5wYXJlbnQuX2xvYWRpbmdDYWxsYmFja3MsIGNhbGxiYWNrKTsKICB9KTsKICB2aWV3LnJlbmRlcigpOwp9KTsKCjs7Ci8qZ2xvYmFsIHB1c2hEb21FdmVudHMgKi8KdmFyIGlzTW9iaWxlID0gJ29udG91Y2hzdGFydCcgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LAogICAgaXNpT1MgPSBuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC8oaVBob25lfGlQb2R8aVBhZCkvaSksCiAgICBpc0FuZHJvaWQgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkuaW5kZXhPZigiYW5kcm9pZCIpID4gLTEgPyAxIDogMCwKICAgIG1pbmltdW1TY3JvbGxZT2Zmc2V0ID0gaXNBbmRyb2lkID8gMSA6IDA7CgpUaG9yYXguVXRpbC5zY3JvbGxUbyA9IGZ1bmN0aW9uKHgsIHkpIHsKICB5ID0geSB8fCBtaW5pbXVtU2Nyb2xsWU9mZnNldDsKICBmdW5jdGlvbiBfc2Nyb2xsVG8oKSB7CiAgICB3aW5kb3cuc2Nyb2xsVG8oeCwgeSk7CiAgfQogIGlmIChpc2lPUykgewogICAgLy8gYSBkZWZlciBpcyByZXF1aXJlZCBmb3IgaW9zCiAgICBfLmRlZmVyKF9zY3JvbGxUbyk7CiAgfSBlbHNlIHsKICAgIF9zY3JvbGxUbygpOwogIH0KICByZXR1cm4gW3gsIHldOwp9OwoKVGhvcmF4LkxheW91dFZpZXcub24oJ2NoYW5nZTp2aWV3OmVuZCcsIGZ1bmN0aW9uKG5ld1ZpZXcsIG9sZFZpZXcsIG9wdGlvbnMpIHsKICBvcHRpb25zLnNjcm9sbCAmJiBUaG9yYXguVXRpbC5zY3JvbGxUbygwLCAwKTsKfSk7CgpUaG9yYXguVXRpbC5zY3JvbGxUb1RvcCA9IGZ1bmN0aW9uKCkgewogIC8vIGFuZHJvaWQgd2lsbCB1c2UgaGVpZ2h0IG9mIDEgYmVjYXVzZSBvZiBtaW5pbXVtU2Nyb2xsWU9mZnNldCBpbiBzY3JvbGxUbygpCiAgcmV0dXJuIHRoaXMuc2Nyb2xsVG8oMCwgMCk7Cn07CgpwdXNoRG9tRXZlbnRzKFsKICAnc2luZ2xlVGFwJywgJ2RvdWJsZVRhcCcsICdsb25nVGFwJywKICAnc3dpcGUnLAogICdzd2lwZVVwJywgJ3N3aXBlRG93bicsCiAgJ3N3aXBlTGVmdCcsICdzd2lwZVJpZ2h0JwpdKTsKCi8vYnVpbHQgaW4gZG9tIGV2ZW50cwpUaG9yYXguVmlldy5vbih7CiAgJ3N1Ym1pdCBmb3JtJzogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKICAgIC8vIEhpZGUgYW55IHZpcnR1YWwga2V5Ym9hcmRzIHRoYXQgbWF5IGJlIGxpbmdlcmluZyBhcm91bmQKICAgIHZhciBmb2N1c2VkID0gJCgnOmZvY3VzJylbMF07CiAgICBmb2N1c2VkICYmIGZvY3VzZWQuYmx1cigpOwogIH0KfSk7Cgo7OwovKmdsb2JhbCBpc01vYmlsZSwgcmVnaXN0ZXJDbGlja0hhbmRsZXIgKi8KCi8vcmVtb3ZhbCBvZiBjbGljayBkZWxheSBvbiBtb2JpbGUgd2Via2l0CnZhciBUQVBfUkFOR0UgPSA1OyAgICAvLyArLTVweCBpcyBzdGlsbCBjb25zaWRlcmVkIGEgdGFwCgpUaG9yYXguX2Zhc3RDbGlja0V2ZW50TmFtZSA9ICdjbGljayc7ClRob3JheC5jb25maWd1cmVGYXN0Q2xpY2sgPSBmdW5jdGlvbih1c2VGYXN0Q2xpY2spIHsKICB2YXIgYm9keSA9IGRvY3VtZW50LmJvZHk7CiAgaWYgKHVzZUZhc3RDbGljayAmJiBpc01vYmlsZSkgewogICAgVGhvcmF4Ll9mYXN0Q2xpY2tFdmVudE5hbWUgPSAnZmFzdC1jbGljayc7CiAgICBib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBvblRvdWNoU3RhcnQsIHRydWUpOwogICAgYm9keS5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBvblRvdWNoTW92ZSwgdHJ1ZSk7CiAgICBib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgb25Ub3VjaEVuZCwgdHJ1ZSk7CiAgICBib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgY2xpY2tLaWxsZXIsIHRydWUpOwogIH0gZWxzZSB7CiAgICBUaG9yYXguX2Zhc3RDbGlja0V2ZW50TmFtZSA9ICdjbGljayc7CiAgICBib2R5LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBvblRvdWNoU3RhcnQsIHRydWUpOwogICAgYm9keS5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBvblRvdWNoTW92ZSwgdHJ1ZSk7CiAgICBib2R5LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgb25Ub3VjaEVuZCwgdHJ1ZSk7CiAgICBib2R5LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgY2xpY2tLaWxsZXIsIHRydWUpOwogIH0KICBpZiAodHlwZW9mIHJlZ2lzdGVyQ2xpY2tIYW5kbGVyICE9PSAndW5kZWZpbmVkJykgewogICAgcmVnaXN0ZXJDbGlja0hhbmRsZXIgJiYgcmVnaXN0ZXJDbGlja0hhbmRsZXIoKTsKICB9Cn07CgppZiAoaXNNb2JpbGUpIHsKICB2YXIgc3RhcnQsCiAgICAgIGNsaWNrUmVkUnVtOwoKICBmdW5jdGlvbiBvblRvdWNoU3RhcnQoZXZlbnQpIHsKICAgIHRyeSB7CiAgICAgIGlmIChldmVudC50b3VjaGVzLmxlbmd0aCA9PT0gMSkgewogICAgICAgIHZhciB0b3VjaCA9IGV2ZW50LnRvdWNoZXNbMF07CiAgICAgICAgc3RhcnQgPSB7eDogdG91Y2guY2xpZW50WCwgeTogdG91Y2guY2xpZW50WX07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RhcnQgPSBmYWxzZTsKICAgICAgfQogICAgICBjbGlja1JlZFJ1bSA9IGZhbHNlOwogICAgfSBjYXRjaCAoZSkgewogICAgICBUaG9yYXgub25FeGNlcHRpb24oJ2Zhc3QtY2xpY2sgc3RhcnQnLCBlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIG9uVG91Y2hNb3ZlKCkgewogICAgaWYgKCFldmVudC50b3VjaGVzIHx8IGV2ZW50LnRvdWNoZXMubGVuZ3RoID4gMSkgewogICAgICBzdGFydCA9IGZhbHNlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZGVmYXVsdFByZXZlbnRlZChldmVudCkgewogICAgcmV0dXJuIGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCA/IGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIDogZXZlbnQuZGVmYXVsdFByZXZlbnRlZDsKICB9CgogIGZ1bmN0aW9uIG9uVG91Y2hFbmQoZXZlbnQpIHsKICAgIHRyeSB7CiAgICAgIHZhciB0b3VjaCA9IGV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdOwogICAgICBpZiAoc3RhcnQKICAgICAgICAgICYmIE1hdGguYWJzKHRvdWNoLmNsaWVudFggLSBzdGFydC54KSA8PSBUQVBfUkFOR0UKICAgICAgICAgICYmIE1hdGguYWJzKHRvdWNoLmNsaWVudFkgLSBzdGFydC55KSA8PSBUQVBfUkFOR0UpIHsKICAgICAgICB2YXIgdGFyZ2V0ID0gdG91Y2gudGFyZ2V0OwoKICAgICAgICAvLyBzZWUgaWYgdGFyZ2V0IGVsZW1lbnQgb3IgYW5jZXN0b3IgaXMgZGlzYWJsZWQgYXMgY2xpY2sgd291bGQgbm90IGJlIHRyaWdnZXJlZCBpbiB0aGlzIGNhc2UKICAgICAgICB2YXIgZGlzYWJsZWQgPSAhISgkKHRhcmdldCkuY2xvc2VzdCgnW2Rpc2FibGVkXScpLmxlbmd0aCk7CiAgICAgICAgaWYgKCFkaXNhYmxlZCkgewogICAgICAgICAgZXZlbnQgPSAkLkV2ZW50KFRob3JheC5fZmFzdENsaWNrRXZlbnROYW1lLCB7b3JpZ2luYWw6IGV2ZW50fSk7CiAgICAgICAgICAkKHRhcmdldCkudHJpZ2dlcihldmVudCk7CiAgICAgICAgICBpZiAoIWRlZmF1bHRQcmV2ZW50ZWQoZXZlbnQpICYmICh0YXJnZXQuY29udHJvbCB8fCB0YXJnZXQuaHRtbEZvcikpIHsKICAgICAgICAgICAgaWYgKHRhcmdldC5jb250cm9sKSB7CiAgICAgICAgICAgICAgJCh0YXJnZXQuY29udHJvbCkudHJpZ2dlcihldmVudCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgJCgiIyIgKyB0YXJnZXQuaHRtbEZvcikudHJpZ2dlcihldmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChkZWZhdWx0UHJldmVudGVkKGV2ZW50KSkgewogICAgICAgICAgICAvLyBJZiB0aGUgZmFzdC1jbGljayB3YXMgaGFuZGxlZCwgcHJldmVudCBmdXRoZXIgb3BlcmF0aW9ucwogICAgICAgICAgICBjbGlja1JlZFJ1bSA9IHRydWU7CiAgICAgICAgICAgIGV2ZW50Lm9yaWdpbmFsLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICBUaG9yYXgub25FeGNlcHRpb24oJ2Zhc3QtY2xpY2sgZW5kJywgZSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjbGlja0tpbGxlcihldmVudCkgewogICAgaWYgKGNsaWNrUmVkUnVtKSB7CiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICBjbGlja1JlZFJ1bSA9IGZhbHNlOwogICAgfQogIH0KCiAgLy8gVXNlIHRoaXMgaW5zdGVhZCBvZiAkKGZ1bmN0aW9uKCkge30pIHNvIHRoYXQgalF1ZXJ5CiAgLy8gZG9lcyBub3QgcmVnaXN0ZXIgYSB0aW1lb3V0CiAgJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7CiAgICBUaG9yYXguY29uZmlndXJlRmFzdENsaWNrKGlzTW9iaWxlKTsKICB9KTsKfSBlbHNlIHsKICBpZiAodHlwZW9mIHJlZ2lzdGVyQ2xpY2tIYW5kbGVyICE9PSAndW5kZWZpbmVkJykgewogICAgcmVnaXN0ZXJDbGlja0hhbmRsZXIgJiYgcmVnaXN0ZXJDbGlja0hhbmRsZXIoKTsKICB9Cn0KCjs7Ci8qZ2xvYmFsIGlzQW5kcm9pZCwgaXNNb2JpbGUgKi8KCiQuZm4udGFwSG9sZEFuZEVuZCA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBjYWxsYmFja1N0YXJ0LCBjYWxsYmFja0VuZCkgewogIGZ1bmN0aW9uIHRyaWdnZXJFdmVudChvYmosIGV2ZW50VHlwZSwgY2FsbGJhY2ssIGV2ZW50KSB7CiAgICB2YXIgb3JpZ2luYWxUeXBlID0gZXZlbnQudHlwZSwKICAgICAgICByZXN1bHQ7CgogICAgZXZlbnQudHlwZSA9IGV2ZW50VHlwZTsKICAgIGlmIChjYWxsYmFjaykgewogICAgICByZXN1bHQgPSBjYWxsYmFjay5jYWxsKG9iaiwgZXZlbnQpOwogICAgfQogICAgZXZlbnQudHlwZSA9IG9yaWdpbmFsVHlwZTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICB2YXIgdGltZXJzID0gW107CiAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgIHZhciB0aGlzT2JqZWN0ID0gdGhpcywKICAgICAgICB0YXBIb2xkU3RhcnQgPSBmYWxzZSwKICAgICAgICAkdGhpcyA9ICQodGhpc09iamVjdCk7CgogICAgJHRoaXMub24oJ3RvdWNoc3RhcnQnLCBzZWxlY3RvciwgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgdGFwSG9sZFN0YXJ0ID0gZmFsc2U7CiAgICAgIHZhciBvcmlnRXZlbnQgPSBldmVudCwKICAgICAgICAgIHRpbWVyOwoKICAgICAgZnVuY3Rpb24gY2xlYXJUYXBUaW1lcihldmVudCkgewogICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7CgogICAgICAgIGlmICh0YXBIb2xkU3RhcnQpIHsKICAgICAgICAgIHZhciByZXR2YWwgPSBmYWxzZTsKICAgICAgICAgIGlmIChldmVudCkgewogICAgICAgICAgICAvLyBXZSBhcmVuJ3Qgc2VuZGluZyBhbnkgZW5kIGV2ZW50cyBmb3IgdG91Y2hjYW5jZWwgY2FzZXMsCiAgICAgICAgICAgIC8vIHByZXZlbnQgYW4gZXhjZXB0aW9uCiAgICAgICAgICAgIHJldHZhbCA9IHRyaWdnZXJFdmVudCh0aGlzT2JqZWN0LCAndGFwSG9sZEVuZCcsIGNhbGxiYWNrRW5kLCBldmVudCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmV0dmFsID09PSBmYWxzZSkgewogICAgICAgICAgICBfLmVhY2godGltZXJzLCBjbGVhclRpbWVvdXQpOwogICAgICAgICAgICB0aW1lcnMgPSBbXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgICQoZG9jdW1lbnQpLm9uZSgndG91Y2hjYW5jZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICBjbGVhclRhcFRpbWVyKCk7CgogICAgICAgICR0aGlzLm9mZigndG91Y2htb3ZlJywgc2VsZWN0b3IsIGNsZWFyVGFwVGltZXIpOwogICAgICAgICR0aGlzLm9mZigndG91Y2hlbmQnLCBzZWxlY3RvciwgY2xlYXJUYXBUaW1lcik7CiAgICAgIH0pOwoKICAgICAgJHRoaXMub24oJ3RvdWNoZW5kJywgc2VsZWN0b3IsIGNsZWFyVGFwVGltZXIpOwogICAgICAkdGhpcy5vbigndG91Y2htb3ZlJywgc2VsZWN0b3IsIGNsZWFyVGFwVGltZXIpOwoKICAgICAgdGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIHRhcEhvbGRTdGFydCA9IHRydWU7CiAgICAgICAgdmFyIHJldHZhbCA9IHRyaWdnZXJFdmVudCh0aGlzT2JqZWN0LCAndGFwSG9sZFN0YXJ0JywgY2FsbGJhY2tTdGFydCwgb3JpZ0V2ZW50KTsKICAgICAgICBpZiAocmV0dmFsID09PSBmYWxzZSkgewogICAgICAgICAgXy5lYWNoKHRpbWVycywgY2xlYXJUaW1lb3V0KTsKICAgICAgICAgIHRpbWVycyA9IFtdOwogICAgICAgIH0KICAgICAgfSwgMTUwKTsKICAgICAgdGltZXJzLnB1c2godGltZXIpOwogICAgfSk7CiAgfSk7Cn07CgovL29ubHkgZW5hYmxlIG9uIGFuZHJvaWQKdmFyIHVzZU5hdGl2ZUhpZ2hsaWdodCA9ICFpc0FuZHJvaWQ7ClRob3JheC5jb25maWd1cmVUYXBIaWdobGlnaHQgPSBmdW5jdGlvbih1c2VOYXRpdmUpIHsKICB1c2VOYXRpdmVIaWdobGlnaHQgPSB1c2VOYXRpdmU7Cn07Cgp2YXIgTkFUSVZFX1RBUFBBQkxFID0gewogICdBJzogdHJ1ZSwKICAnSU5QVVQnOiB0cnVlLAogICdCVVRUT04nOiB0cnVlLAogICdTRUxFQ1QnOiB0cnVlLAogICdURVhUQVJFQSc6IHRydWUKfTsKCmZ1bmN0aW9uIGZpeHVwVGFwSGlnaGxpZ2h0KHNjb3BlKSB7CiAgXy5lYWNoKHRoaXMuX2RvbUV2ZW50cyB8fCBbXSwgZnVuY3Rpb24oYmluZCkgewogICAgdmFyIGNvbXBvbmVudHMgPSBiaW5kLnNwbGl0KCcgJyksCiAgICAgICAgc2VsZWN0b3IgPSBjb21wb25lbnRzLnNsaWNlKDEpLmpvaW4oJyAnKSB8fCB1bmRlZmluZWQ7ICAvLyBOZWVkZWQgdG8gbWFrZSB6ZXB0byBoYXBweQoKICAgIGlmIChjb21wb25lbnRzWzBdID09PSAnY2xpY2snKSB7CiAgICAgIC8vICFzZWxlY3RvciBjYXNlIGlzIGZvciByb290IGNsaWNrIGhhbmRsZXJzIG9uIHRoZSB2aWV3LCBpLmUuICdjbGljaycKICAgICAgJChzZWxlY3RvciB8fCB0aGlzLmVsLCBzZWxlY3RvciAmJiAoc2NvcGUgfHwgdGhpcy5lbCkpLmZvckVhY2goZnVuY3Rpb24oZWwpIHsKICAgICAgICB2YXIgJGVsID0gJChlbCkuZGF0YSgndGFwcGFibGUnLCB0cnVlKTsKCiAgICAgICAgaWYgKHVzZU5hdGl2ZUhpZ2hsaWdodCAmJiAhTkFUSVZFX1RBUFBBQkxFW2VsLnRhZ05hbWVdKSB7CiAgICAgICAgICAvLyBBZGQgYW4gZXhwbGljaXQgTk9QIGJpbmQgdG8gYWxsb3cgdGFwLWhpZ2hsaWdodCBzdXBwb3J0CiAgICAgICAgICAkZWwub24oJ2NsaWNrJywgZmFsc2UpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSwgdGhpcyk7Cn0KCl8uZXh0ZW5kKFRob3JheC5WaWV3LnByb3RvdHlwZSwgewogIF90YXBIaWdobGlnaHRDbGFzc05hbWU6ICdhY3RpdmUnLAogIF90YXBIaWdobGlnaHRTdGFydDogZnVuY3Rpb24oZXZlbnQpIHsKICAgIHZhciB0YXJnZXQgPSBldmVudC5jdXJyZW50VGFyZ2V0LAogICAgICAgIHRhZ05hbWUgPSB0YXJnZXQgJiYgdGFyZ2V0LnRhZ05hbWUudG9Mb3dlckNhc2UoKTsKCiAgICAvLyBVc2VyIGlucHV0IGNvbnRyb2xzIG1heSBiZSB2aXN1YWxseSBwYXJ0IG9mIGEgbGFyZ2VyIGdyb3VwLiBGb3IgdGhlc2UgY2FzZXMKICAgIC8vIHdlIHdhbnQgdG8gZ2l2ZSBwcmlvcml0eSB0byBhbnkgcGFyZW50IHRoYXQgbWF5IHByb3ZpZGUgYSBmb2N1cyBvcGVyYXRpb24uCiAgICBpZiAodGFnTmFtZSA9PT0gJ2lucHV0JyB8fCB0YWdOYW1lID09PSAnc2VsZWN0JyB8fCB0YWdOYW1lID09PSAndGV4dGFyZWEnKSB7CiAgICAgIHRhcmdldCA9ICQodGFyZ2V0KS5jbG9zZXN0KCdbZGF0YS10YXBwYWJsZT10cnVlXScpWzBdIHx8IHRhcmdldDsKICAgIH0KCiAgICBpZiAodGFyZ2V0KSB7CiAgICAgICQodGFyZ2V0KS5hZGRDbGFzcyh0aGlzLl90YXBIaWdobGlnaHRDbGFzc05hbWUpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSwKICBfdGFwSGlnaGxpZ2h0RW5kOiBmdW5jdGlvbigvKiBldmVudCAqLykgewogICAgJCgnLicgKyB0aGlzLl90YXBIaWdobGlnaHRDbGFzc05hbWUpLnJlbW92ZUNsYXNzKHRoaXMuX3RhcEhpZ2hsaWdodENsYXNzTmFtZSk7CiAgfQp9KTsKCi8vVE9ETzogZXhhbWluZSBpZiB0aGVzZSBhcmUgc3RpbGwgbmVlZGVkCnZhciBmaXh1cFRhcEhpZ2hsaWdodENhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgZml4dXBUYXBIaWdobGlnaHQuY2FsbCh0aGlzKTsKfTsKClRob3JheC5WaWV3Lm9uKHsKICAncmVuZGVyZWQnOiBmaXh1cFRhcEhpZ2hsaWdodENhbGxiYWNrLAogICdyZW5kZXJlZDpjb2xsZWN0aW9uJzogZml4dXBUYXBIaWdobGlnaHRDYWxsYmFjaywKICAncmVuZGVyZWQ6aXRlbSc6IGZpeHVwVGFwSGlnaGxpZ2h0Q2FsbGJhY2ssCiAgJ3JlbmRlcmVkOmVtcHR5JzogZml4dXBUYXBIaWdobGlnaHRDYWxsYmFjawp9KTsKCnZhciBfc2V0RWxlbWVudCA9IFRob3JheC5WaWV3LnByb3RvdHlwZS5zZXRFbGVtZW50LAogICAgdGFwSGlnaGxpZ2h0U2VsZWN0b3IgPSAnW2RhdGEtdGFwcGFibGU9dHJ1ZV0sIGEsIGlucHV0LCBidXR0b24sIHNlbGVjdCwgdGV4dGFyZWEnOwoKVGhvcmF4LlZpZXcucHJvdG90eXBlLnNldEVsZW1lbnQgPSBmdW5jdGlvbigpIHsKICB2YXIgcmVzcG9uc2UgPSBfc2V0RWxlbWVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIGlmICghdGhpcy5ub1RhcEhpZ2hsaWdodCkgewogICAgaWYgKCF1c2VOYXRpdmVIaWdobGlnaHQpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBmdW5jdGlvbiBleGVjKG5hbWUpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzZWxmW25hbWVdLmFwcGx5KHNlbGYsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgVGhvcmF4Lm9uRXhjZXB0aW9uKG5hbWUsIGUpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KICAgICAgdGhpcy4kZWwudGFwSG9sZEFuZEVuZCh0YXBIaWdobGlnaHRTZWxlY3RvciwgZXhlYygnX3RhcEhpZ2hsaWdodFN0YXJ0JyksIGV4ZWMoJ190YXBIaWdobGlnaHRFbmQnKSk7CiAgICB9CiAgfQogIHJldHVybiByZXNwb25zZTsKfTsKCnZhciBfYWRkRXZlbnQgPSBUaG9yYXguVmlldy5wcm90b3R5cGUuX2FkZEV2ZW50OwpUaG9yYXguVmlldy5wcm90b3R5cGUuX2FkZEV2ZW50ID0gZnVuY3Rpb24ocGFyYW1zKSB7CiAgdGhpcy5fZG9tRXZlbnRzID0gdGhpcy5fZG9tRXZlbnRzIHx8IFtdOwogIChwYXJhbXMudHlwZSA9PT0gIkRPTSIpICYmIHRoaXMuX2RvbUV2ZW50cy5wdXNoKHBhcmFtcy5vcmlnaW5hbE5hbWUpOwogIGlzTW9iaWxlICYmIChwYXJhbXMubmFtZSA9IHBhcmFtcy5uYW1lLnJlcGxhY2UoL15jbGlja1xiLywgVGhvcmF4Ll9mYXN0Q2xpY2tFdmVudE5hbWUpKTsKICByZXR1cm4gX2FkZEV2ZW50LmNhbGwodGhpcywgcGFyYW1zKTsKfTsKCjs7CgoKfSkoKTsKCg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 03:54:59 GMT",
                    "Content-Length": "297175",
                    "Date": "Sat, 08 Nov 2014 03:55:35 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}